static int prism2sta_open(wlandevice_t *wlandev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int prism2sta_close(wlandevice_t *wlandev)\r\n{\r\nreturn 0;\r\n}\r\nstatic void prism2sta_reset(wlandevice_t *wlandev)\r\n{\r\n}\r\nstatic int prism2sta_txframe(wlandevice_t *wlandev, struct sk_buff *skb,\r\nunion p80211_hdr *p80211_hdr,\r\nstruct p80211_metawep *p80211_wep)\r\n{\r\nhfa384x_t *hw = wlandev->priv;\r\nif ((wlandev->hostwep & (HOSTWEP_PRIVACYINVOKED | HOSTWEP_ENCRYPT)) ==\r\nHOSTWEP_PRIVACYINVOKED) {\r\np80211_hdr->a3.fc |= cpu_to_le16(WLAN_SET_FC_ISWEP(1));\r\n}\r\nreturn hfa384x_drvr_txframe(hw, skb, p80211_hdr, p80211_wep);\r\n}\r\nstatic int prism2sta_mlmerequest(wlandevice_t *wlandev, struct p80211msg *msg)\r\n{\r\nhfa384x_t *hw = wlandev->priv;\r\nint result = 0;\r\nswitch (msg->msgcode) {\r\ncase DIDmsg_dot11req_mibget:\r\npr_debug("Received mibget request\n");\r\nresult = prism2mgmt_mibset_mibget(wlandev, msg);\r\nbreak;\r\ncase DIDmsg_dot11req_mibset:\r\npr_debug("Received mibset request\n");\r\nresult = prism2mgmt_mibset_mibget(wlandev, msg);\r\nbreak;\r\ncase DIDmsg_dot11req_scan:\r\npr_debug("Received scan request\n");\r\nresult = prism2mgmt_scan(wlandev, msg);\r\nbreak;\r\ncase DIDmsg_dot11req_scan_results:\r\npr_debug("Received scan_results request\n");\r\nresult = prism2mgmt_scan_results(wlandev, msg);\r\nbreak;\r\ncase DIDmsg_dot11req_start:\r\npr_debug("Received mlme start request\n");\r\nresult = prism2mgmt_start(wlandev, msg);\r\nbreak;\r\ncase DIDmsg_p2req_readpda:\r\npr_debug("Received mlme readpda request\n");\r\nresult = prism2mgmt_readpda(wlandev, msg);\r\nbreak;\r\ncase DIDmsg_p2req_ramdl_state:\r\npr_debug("Received mlme ramdl_state request\n");\r\nresult = prism2mgmt_ramdl_state(wlandev, msg);\r\nbreak;\r\ncase DIDmsg_p2req_ramdl_write:\r\npr_debug("Received mlme ramdl_write request\n");\r\nresult = prism2mgmt_ramdl_write(wlandev, msg);\r\nbreak;\r\ncase DIDmsg_p2req_flashdl_state:\r\npr_debug("Received mlme flashdl_state request\n");\r\nresult = prism2mgmt_flashdl_state(wlandev, msg);\r\nbreak;\r\ncase DIDmsg_p2req_flashdl_write:\r\npr_debug("Received mlme flashdl_write request\n");\r\nresult = prism2mgmt_flashdl_write(wlandev, msg);\r\nbreak;\r\ncase DIDmsg_lnxreq_hostwep:\r\nbreak;\r\ncase DIDmsg_lnxreq_ifstate:\r\n{\r\nstruct p80211msg_lnxreq_ifstate *ifstatemsg;\r\npr_debug("Received mlme ifstate request\n");\r\nifstatemsg = (struct p80211msg_lnxreq_ifstate *) msg;\r\nresult =\r\nprism2sta_ifstate(wlandev,\r\nifstatemsg->ifstate.data);\r\nifstatemsg->resultcode.status =\r\nP80211ENUM_msgitem_status_data_ok;\r\nifstatemsg->resultcode.data = result;\r\nresult = 0;\r\n}\r\nbreak;\r\ncase DIDmsg_lnxreq_wlansniff:\r\npr_debug("Received mlme wlansniff request\n");\r\nresult = prism2mgmt_wlansniff(wlandev, msg);\r\nbreak;\r\ncase DIDmsg_lnxreq_autojoin:\r\npr_debug("Received mlme autojoin request\n");\r\nresult = prism2mgmt_autojoin(wlandev, msg);\r\nbreak;\r\ncase DIDmsg_lnxreq_commsquality:{\r\nstruct p80211msg_lnxreq_commsquality *qualmsg;\r\npr_debug("Received commsquality request\n");\r\nqualmsg = (struct p80211msg_lnxreq_commsquality *) msg;\r\nqualmsg->link.status =\r\nP80211ENUM_msgitem_status_data_ok;\r\nqualmsg->level.status =\r\nP80211ENUM_msgitem_status_data_ok;\r\nqualmsg->noise.status =\r\nP80211ENUM_msgitem_status_data_ok;\r\nqualmsg->link.data = le16_to_cpu(hw->qual.CQ_currBSS);\r\nqualmsg->level.data = le16_to_cpu(hw->qual.ASL_currBSS);\r\nqualmsg->noise.data = le16_to_cpu(hw->qual.ANL_currFC);\r\nqualmsg->txrate.data = hw->txrate;\r\nbreak;\r\n}\r\ndefault:\r\nnetdev_warn(wlandev->netdev,\r\n"Unknown mgmt request message 0x%08x",\r\nmsg->msgcode);\r\nbreak;\r\n}\r\nreturn result;\r\n}\r\nu32 prism2sta_ifstate(wlandevice_t *wlandev, u32 ifstate)\r\n{\r\nhfa384x_t *hw = wlandev->priv;\r\nu32 result;\r\nresult = P80211ENUM_resultcode_implementation_failure;\r\npr_debug("Current MSD state(%d), requesting(%d)\n",\r\nwlandev->msdstate, ifstate);\r\nswitch (ifstate) {\r\ncase P80211ENUM_ifstate_fwload:\r\nswitch (wlandev->msdstate) {\r\ncase WLAN_MSD_HWPRESENT:\r\nwlandev->msdstate = WLAN_MSD_FWLOAD_PENDING;\r\nresult = hfa384x_drvr_start(hw);\r\nif (result) {\r\nnetdev_err(wlandev->netdev,\r\n"hfa384x_drvr_start() failed,result=%d\n",\r\n(int)result);\r\nresult =\r\nP80211ENUM_resultcode_implementation_failure;\r\nwlandev->msdstate = WLAN_MSD_HWPRESENT;\r\nbreak;\r\n}\r\nwlandev->msdstate = WLAN_MSD_FWLOAD;\r\nresult = P80211ENUM_resultcode_success;\r\nbreak;\r\ncase WLAN_MSD_FWLOAD:\r\nhfa384x_cmd_initialize(hw);\r\nresult = P80211ENUM_resultcode_success;\r\nbreak;\r\ncase WLAN_MSD_RUNNING:\r\nnetdev_warn(wlandev->netdev,\r\n"Cannot enter fwload state from enable state, you must disable first.\n");\r\nresult = P80211ENUM_resultcode_invalid_parameters;\r\nbreak;\r\ncase WLAN_MSD_HWFAIL:\r\ndefault:\r\nresult = P80211ENUM_resultcode_implementation_failure;\r\nbreak;\r\n}\r\nbreak;\r\ncase P80211ENUM_ifstate_enable:\r\nswitch (wlandev->msdstate) {\r\ncase WLAN_MSD_HWPRESENT:\r\ncase WLAN_MSD_FWLOAD:\r\nwlandev->msdstate = WLAN_MSD_RUNNING_PENDING;\r\nresult = hfa384x_drvr_start(hw);\r\nif (result) {\r\nnetdev_err(wlandev->netdev,\r\n"hfa384x_drvr_start() failed,result=%d\n",\r\n(int)result);\r\nresult =\r\nP80211ENUM_resultcode_implementation_failure;\r\nwlandev->msdstate = WLAN_MSD_HWPRESENT;\r\nbreak;\r\n}\r\nresult = prism2sta_getcardinfo(wlandev);\r\nif (result) {\r\nnetdev_err(wlandev->netdev,\r\n"prism2sta_getcardinfo() failed,result=%d\n",\r\n(int)result);\r\nresult =\r\nP80211ENUM_resultcode_implementation_failure;\r\nhfa384x_drvr_stop(hw);\r\nwlandev->msdstate = WLAN_MSD_HWPRESENT;\r\nbreak;\r\n}\r\nresult = prism2sta_globalsetup(wlandev);\r\nif (result) {\r\nnetdev_err(wlandev->netdev,\r\n"prism2sta_globalsetup() failed,result=%d\n",\r\n(int)result);\r\nresult =\r\nP80211ENUM_resultcode_implementation_failure;\r\nhfa384x_drvr_stop(hw);\r\nwlandev->msdstate = WLAN_MSD_HWPRESENT;\r\nbreak;\r\n}\r\nwlandev->msdstate = WLAN_MSD_RUNNING;\r\nhw->join_ap = 0;\r\nhw->join_retries = 60;\r\nresult = P80211ENUM_resultcode_success;\r\nbreak;\r\ncase WLAN_MSD_RUNNING:\r\nresult = P80211ENUM_resultcode_success;\r\nbreak;\r\ncase WLAN_MSD_HWFAIL:\r\ndefault:\r\nresult = P80211ENUM_resultcode_implementation_failure;\r\nbreak;\r\n}\r\nbreak;\r\ncase P80211ENUM_ifstate_disable:\r\nswitch (wlandev->msdstate) {\r\ncase WLAN_MSD_HWPRESENT:\r\nresult = P80211ENUM_resultcode_success;\r\nbreak;\r\ncase WLAN_MSD_FWLOAD:\r\ncase WLAN_MSD_RUNNING:\r\nwlandev->msdstate = WLAN_MSD_HWPRESENT_PENDING;\r\nif (!wlandev->hwremoved)\r\nnetif_carrier_off(wlandev->netdev);\r\nhfa384x_drvr_stop(hw);\r\nwlandev->macmode = WLAN_MACMODE_NONE;\r\nwlandev->msdstate = WLAN_MSD_HWPRESENT;\r\nresult = P80211ENUM_resultcode_success;\r\nbreak;\r\ncase WLAN_MSD_HWFAIL:\r\ndefault:\r\nresult = P80211ENUM_resultcode_implementation_failure;\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\nresult = P80211ENUM_resultcode_invalid_parameters;\r\nbreak;\r\n}\r\nreturn result;\r\n}\r\nstatic int prism2sta_getcardinfo(wlandevice_t *wlandev)\r\n{\r\nint result = 0;\r\nhfa384x_t *hw = wlandev->priv;\r\nu16 temp;\r\nu8 snum[HFA384x_RID_NICSERIALNUMBER_LEN];\r\nresult = hfa384x_drvr_getconfig(hw, HFA384x_RID_NICIDENTITY,\r\n&hw->ident_nic,\r\nsizeof(hfa384x_compident_t));\r\nif (result) {\r\nnetdev_err(wlandev->netdev, "Failed to retrieve NICIDENTITY\n");\r\ngoto failed;\r\n}\r\nhw->ident_nic.id = le16_to_cpu(hw->ident_nic.id);\r\nhw->ident_nic.variant = le16_to_cpu(hw->ident_nic.variant);\r\nhw->ident_nic.major = le16_to_cpu(hw->ident_nic.major);\r\nhw->ident_nic.minor = le16_to_cpu(hw->ident_nic.minor);\r\nnetdev_info(wlandev->netdev, "ident: nic h/w: id=0x%02x %d.%d.%d\n",\r\nhw->ident_nic.id, hw->ident_nic.major,\r\nhw->ident_nic.minor, hw->ident_nic.variant);\r\nresult = hfa384x_drvr_getconfig(hw, HFA384x_RID_PRIIDENTITY,\r\n&hw->ident_pri_fw,\r\nsizeof(hfa384x_compident_t));\r\nif (result) {\r\nnetdev_err(wlandev->netdev, "Failed to retrieve PRIIDENTITY\n");\r\ngoto failed;\r\n}\r\nhw->ident_pri_fw.id = le16_to_cpu(hw->ident_pri_fw.id);\r\nhw->ident_pri_fw.variant = le16_to_cpu(hw->ident_pri_fw.variant);\r\nhw->ident_pri_fw.major = le16_to_cpu(hw->ident_pri_fw.major);\r\nhw->ident_pri_fw.minor = le16_to_cpu(hw->ident_pri_fw.minor);\r\nnetdev_info(wlandev->netdev, "ident: pri f/w: id=0x%02x %d.%d.%d\n",\r\nhw->ident_pri_fw.id, hw->ident_pri_fw.major,\r\nhw->ident_pri_fw.minor, hw->ident_pri_fw.variant);\r\nresult = hfa384x_drvr_getconfig(hw, HFA384x_RID_STAIDENTITY,\r\n&hw->ident_sta_fw,\r\nsizeof(hfa384x_compident_t));\r\nif (result) {\r\nnetdev_err(wlandev->netdev, "Failed to retrieve STAIDENTITY\n");\r\ngoto failed;\r\n}\r\nif (hw->ident_nic.id < 0x8000) {\r\nnetdev_err(wlandev->netdev,\r\n"FATAL: Card is not an Intersil Prism2/2.5/3\n");\r\nresult = -1;\r\ngoto failed;\r\n}\r\nhw->ident_sta_fw.id = le16_to_cpu(hw->ident_sta_fw.id);\r\nhw->ident_sta_fw.variant = le16_to_cpu(hw->ident_sta_fw.variant);\r\nhw->ident_sta_fw.major = le16_to_cpu(hw->ident_sta_fw.major);\r\nhw->ident_sta_fw.minor = le16_to_cpu(hw->ident_sta_fw.minor);\r\nhw->mm_mods = hw->ident_sta_fw.variant & (BIT(14) | BIT(15));\r\nhw->ident_sta_fw.variant &= ~((u16) (BIT(14) | BIT(15)));\r\nif (hw->ident_sta_fw.id == 0x1f) {\r\nnetdev_info(wlandev->netdev,\r\n"ident: sta f/w: id=0x%02x %d.%d.%d\n",\r\nhw->ident_sta_fw.id, hw->ident_sta_fw.major,\r\nhw->ident_sta_fw.minor, hw->ident_sta_fw.variant);\r\n} else {\r\nnetdev_info(wlandev->netdev,\r\n"ident: ap f/w: id=0x%02x %d.%d.%d\n",\r\nhw->ident_sta_fw.id, hw->ident_sta_fw.major,\r\nhw->ident_sta_fw.minor, hw->ident_sta_fw.variant);\r\nnetdev_err(wlandev->netdev, "Unsupported Tertiary AP firmware loaded!\n");\r\ngoto failed;\r\n}\r\nresult = hfa384x_drvr_getconfig(hw, HFA384x_RID_MFISUPRANGE,\r\n&hw->cap_sup_mfi,\r\nsizeof(hfa384x_caplevel_t));\r\nif (result) {\r\nnetdev_err(wlandev->netdev, "Failed to retrieve MFISUPRANGE\n");\r\ngoto failed;\r\n}\r\nhw->cap_sup_mfi.role = le16_to_cpu(hw->cap_sup_mfi.role);\r\nhw->cap_sup_mfi.id = le16_to_cpu(hw->cap_sup_mfi.id);\r\nhw->cap_sup_mfi.variant = le16_to_cpu(hw->cap_sup_mfi.variant);\r\nhw->cap_sup_mfi.bottom = le16_to_cpu(hw->cap_sup_mfi.bottom);\r\nhw->cap_sup_mfi.top = le16_to_cpu(hw->cap_sup_mfi.top);\r\nnetdev_info(wlandev->netdev,\r\n"MFI:SUP:role=0x%02x:id=0x%02x:var=0x%02x:b/t=%d/%d\n",\r\nhw->cap_sup_mfi.role, hw->cap_sup_mfi.id,\r\nhw->cap_sup_mfi.variant, hw->cap_sup_mfi.bottom,\r\nhw->cap_sup_mfi.top);\r\nresult = hfa384x_drvr_getconfig(hw, HFA384x_RID_CFISUPRANGE,\r\n&hw->cap_sup_cfi,\r\nsizeof(hfa384x_caplevel_t));\r\nif (result) {\r\nnetdev_err(wlandev->netdev, "Failed to retrieve CFISUPRANGE\n");\r\ngoto failed;\r\n}\r\nhw->cap_sup_cfi.role = le16_to_cpu(hw->cap_sup_cfi.role);\r\nhw->cap_sup_cfi.id = le16_to_cpu(hw->cap_sup_cfi.id);\r\nhw->cap_sup_cfi.variant = le16_to_cpu(hw->cap_sup_cfi.variant);\r\nhw->cap_sup_cfi.bottom = le16_to_cpu(hw->cap_sup_cfi.bottom);\r\nhw->cap_sup_cfi.top = le16_to_cpu(hw->cap_sup_cfi.top);\r\nnetdev_info(wlandev->netdev,\r\n"CFI:SUP:role=0x%02x:id=0x%02x:var=0x%02x:b/t=%d/%d\n",\r\nhw->cap_sup_cfi.role, hw->cap_sup_cfi.id,\r\nhw->cap_sup_cfi.variant, hw->cap_sup_cfi.bottom,\r\nhw->cap_sup_cfi.top);\r\nresult = hfa384x_drvr_getconfig(hw, HFA384x_RID_PRISUPRANGE,\r\n&hw->cap_sup_pri,\r\nsizeof(hfa384x_caplevel_t));\r\nif (result) {\r\nnetdev_err(wlandev->netdev, "Failed to retrieve PRISUPRANGE\n");\r\ngoto failed;\r\n}\r\nhw->cap_sup_pri.role = le16_to_cpu(hw->cap_sup_pri.role);\r\nhw->cap_sup_pri.id = le16_to_cpu(hw->cap_sup_pri.id);\r\nhw->cap_sup_pri.variant = le16_to_cpu(hw->cap_sup_pri.variant);\r\nhw->cap_sup_pri.bottom = le16_to_cpu(hw->cap_sup_pri.bottom);\r\nhw->cap_sup_pri.top = le16_to_cpu(hw->cap_sup_pri.top);\r\nnetdev_info(wlandev->netdev,\r\n"PRI:SUP:role=0x%02x:id=0x%02x:var=0x%02x:b/t=%d/%d\n",\r\nhw->cap_sup_pri.role, hw->cap_sup_pri.id,\r\nhw->cap_sup_pri.variant, hw->cap_sup_pri.bottom,\r\nhw->cap_sup_pri.top);\r\nresult = hfa384x_drvr_getconfig(hw, HFA384x_RID_STASUPRANGE,\r\n&hw->cap_sup_sta,\r\nsizeof(hfa384x_caplevel_t));\r\nif (result) {\r\nnetdev_err(wlandev->netdev, "Failed to retrieve STASUPRANGE\n");\r\ngoto failed;\r\n}\r\nhw->cap_sup_sta.role = le16_to_cpu(hw->cap_sup_sta.role);\r\nhw->cap_sup_sta.id = le16_to_cpu(hw->cap_sup_sta.id);\r\nhw->cap_sup_sta.variant = le16_to_cpu(hw->cap_sup_sta.variant);\r\nhw->cap_sup_sta.bottom = le16_to_cpu(hw->cap_sup_sta.bottom);\r\nhw->cap_sup_sta.top = le16_to_cpu(hw->cap_sup_sta.top);\r\nif (hw->cap_sup_sta.id == 0x04) {\r\nnetdev_info(wlandev->netdev,\r\n"STA:SUP:role=0x%02x:id=0x%02x:var=0x%02x:b/t=%d/%d\n",\r\nhw->cap_sup_sta.role, hw->cap_sup_sta.id,\r\nhw->cap_sup_sta.variant, hw->cap_sup_sta.bottom,\r\nhw->cap_sup_sta.top);\r\n} else {\r\nnetdev_info(wlandev->netdev,\r\n"AP:SUP:role=0x%02x:id=0x%02x:var=0x%02x:b/t=%d/%d\n",\r\nhw->cap_sup_sta.role, hw->cap_sup_sta.id,\r\nhw->cap_sup_sta.variant, hw->cap_sup_sta.bottom,\r\nhw->cap_sup_sta.top);\r\n}\r\nresult = hfa384x_drvr_getconfig(hw, HFA384x_RID_PRI_CFIACTRANGES,\r\n&hw->cap_act_pri_cfi,\r\nsizeof(hfa384x_caplevel_t));\r\nif (result) {\r\nnetdev_err(wlandev->netdev, "Failed to retrieve PRI_CFIACTRANGES\n");\r\ngoto failed;\r\n}\r\nhw->cap_act_pri_cfi.role = le16_to_cpu(hw->cap_act_pri_cfi.role);\r\nhw->cap_act_pri_cfi.id = le16_to_cpu(hw->cap_act_pri_cfi.id);\r\nhw->cap_act_pri_cfi.variant = le16_to_cpu(hw->cap_act_pri_cfi.variant);\r\nhw->cap_act_pri_cfi.bottom = le16_to_cpu(hw->cap_act_pri_cfi.bottom);\r\nhw->cap_act_pri_cfi.top = le16_to_cpu(hw->cap_act_pri_cfi.top);\r\nnetdev_info(wlandev->netdev,\r\n"PRI-CFI:ACT:role=0x%02x:id=0x%02x:var=0x%02x:b/t=%d/%d\n",\r\nhw->cap_act_pri_cfi.role, hw->cap_act_pri_cfi.id,\r\nhw->cap_act_pri_cfi.variant, hw->cap_act_pri_cfi.bottom,\r\nhw->cap_act_pri_cfi.top);\r\nresult = hfa384x_drvr_getconfig(hw, HFA384x_RID_STA_CFIACTRANGES,\r\n&hw->cap_act_sta_cfi,\r\nsizeof(hfa384x_caplevel_t));\r\nif (result) {\r\nnetdev_err(wlandev->netdev, "Failed to retrieve STA_CFIACTRANGES\n");\r\ngoto failed;\r\n}\r\nhw->cap_act_sta_cfi.role = le16_to_cpu(hw->cap_act_sta_cfi.role);\r\nhw->cap_act_sta_cfi.id = le16_to_cpu(hw->cap_act_sta_cfi.id);\r\nhw->cap_act_sta_cfi.variant = le16_to_cpu(hw->cap_act_sta_cfi.variant);\r\nhw->cap_act_sta_cfi.bottom = le16_to_cpu(hw->cap_act_sta_cfi.bottom);\r\nhw->cap_act_sta_cfi.top = le16_to_cpu(hw->cap_act_sta_cfi.top);\r\nnetdev_info(wlandev->netdev,\r\n"STA-CFI:ACT:role=0x%02x:id=0x%02x:var=0x%02x:b/t=%d/%d\n",\r\nhw->cap_act_sta_cfi.role, hw->cap_act_sta_cfi.id,\r\nhw->cap_act_sta_cfi.variant, hw->cap_act_sta_cfi.bottom,\r\nhw->cap_act_sta_cfi.top);\r\nresult = hfa384x_drvr_getconfig(hw, HFA384x_RID_STA_MFIACTRANGES,\r\n&hw->cap_act_sta_mfi,\r\nsizeof(hfa384x_caplevel_t));\r\nif (result) {\r\nnetdev_err(wlandev->netdev, "Failed to retrieve STA_MFIACTRANGES\n");\r\ngoto failed;\r\n}\r\nhw->cap_act_sta_mfi.role = le16_to_cpu(hw->cap_act_sta_mfi.role);\r\nhw->cap_act_sta_mfi.id = le16_to_cpu(hw->cap_act_sta_mfi.id);\r\nhw->cap_act_sta_mfi.variant = le16_to_cpu(hw->cap_act_sta_mfi.variant);\r\nhw->cap_act_sta_mfi.bottom = le16_to_cpu(hw->cap_act_sta_mfi.bottom);\r\nhw->cap_act_sta_mfi.top = le16_to_cpu(hw->cap_act_sta_mfi.top);\r\nnetdev_info(wlandev->netdev,\r\n"STA-MFI:ACT:role=0x%02x:id=0x%02x:var=0x%02x:b/t=%d/%d\n",\r\nhw->cap_act_sta_mfi.role, hw->cap_act_sta_mfi.id,\r\nhw->cap_act_sta_mfi.variant, hw->cap_act_sta_mfi.bottom,\r\nhw->cap_act_sta_mfi.top);\r\nresult = hfa384x_drvr_getconfig(hw, HFA384x_RID_NICSERIALNUMBER,\r\nsnum, HFA384x_RID_NICSERIALNUMBER_LEN);\r\nif (!result) {\r\nnetdev_info(wlandev->netdev, "Prism2 card SN: %*pEhp\n",\r\nHFA384x_RID_NICSERIALNUMBER_LEN, snum);\r\n} else {\r\nnetdev_err(wlandev->netdev, "Failed to retrieve Prism2 Card SN\n");\r\ngoto failed;\r\n}\r\nresult = hfa384x_drvr_getconfig(hw, HFA384x_RID_CNFOWNMACADDR,\r\nwlandev->netdev->dev_addr, ETH_ALEN);\r\nif (result != 0) {\r\nnetdev_err(wlandev->netdev, "Failed to retrieve mac address\n");\r\ngoto failed;\r\n}\r\nwlandev->nsdcaps |= P80211_NSDCAP_SHORT_PREAMBLE;\r\nhfa384x_drvr_getconfig16(hw, HFA384x_RID_PRIVACYOPTIMP, &temp);\r\nif (temp)\r\nwlandev->nsdcaps |= P80211_NSDCAP_HARDWAREWEP;\r\nhfa384x_drvr_getconfig16(hw, HFA384x_RID_CNFDBMADJUST, &temp);\r\nhw->dbmadjust = temp;\r\nif (HFA384x_FIRMWARE_VERSION(hw->ident_sta_fw.major,\r\nhw->ident_sta_fw.minor,\r\nhw->ident_sta_fw.variant) <\r\nHFA384x_FIRMWARE_VERSION(1, 5, 5)) {\r\nwlandev->nsdcaps |= P80211_NSDCAP_NOSCAN;\r\n}\r\ngoto done;\r\nfailed:\r\nnetdev_err(wlandev->netdev, "Failed, result=%d\n", result);\r\ndone:\r\nreturn result;\r\n}\r\nstatic int prism2sta_globalsetup(wlandevice_t *wlandev)\r\n{\r\nhfa384x_t *hw = wlandev->priv;\r\nreturn hfa384x_drvr_setconfig16(hw, HFA384x_RID_CNFMAXDATALEN,\r\nWLAN_DATA_MAXLEN);\r\n}\r\nstatic int prism2sta_setmulticast(wlandevice_t *wlandev, netdevice_t *dev)\r\n{\r\nint result = 0;\r\nhfa384x_t *hw = wlandev->priv;\r\nu16 promisc;\r\nif (hw->state != HFA384x_STATE_RUNNING)\r\ngoto exit;\r\nif ((dev->flags & (IFF_PROMISC | IFF_ALLMULTI)) != 0)\r\npromisc = P80211ENUM_truth_true;\r\nelse\r\npromisc = P80211ENUM_truth_false;\r\nresult =\r\nhfa384x_drvr_setconfig16_async(hw, HFA384x_RID_PROMISCMODE,\r\npromisc);\r\nexit:\r\nreturn result;\r\n}\r\nstatic void prism2sta_inf_handover(wlandevice_t *wlandev,\r\nhfa384x_InfFrame_t *inf)\r\n{\r\npr_debug("received infoframe:HANDOVER (unhandled)\n");\r\n}\r\nstatic void prism2sta_inf_tallies(wlandevice_t *wlandev,\r\nhfa384x_InfFrame_t *inf)\r\n{\r\nhfa384x_t *hw = wlandev->priv;\r\nu16 *src16;\r\nu32 *dst;\r\nu32 *src32;\r\nint i;\r\nint cnt;\r\ncnt = sizeof(hfa384x_CommTallies32_t) / sizeof(u32);\r\nif (inf->framelen > 22) {\r\ndst = (u32 *) &hw->tallies;\r\nsrc32 = (u32 *) &inf->info.commtallies32;\r\nfor (i = 0; i < cnt; i++, dst++, src32++)\r\n*dst += le32_to_cpu(*src32);\r\n} else {\r\ndst = (u32 *) &hw->tallies;\r\nsrc16 = (u16 *) &inf->info.commtallies16;\r\nfor (i = 0; i < cnt; i++, dst++, src16++)\r\n*dst += le16_to_cpu(*src16);\r\n}\r\n}\r\nstatic void prism2sta_inf_scanresults(wlandevice_t *wlandev,\r\nhfa384x_InfFrame_t *inf)\r\n{\r\nhfa384x_t *hw = wlandev->priv;\r\nint nbss;\r\nhfa384x_ScanResult_t *sr = &(inf->info.scanresult);\r\nint i;\r\nhfa384x_JoinRequest_data_t joinreq;\r\nint result;\r\nnbss = (inf->framelen * sizeof(u16)) -\r\nsizeof(inf->infotype) - sizeof(inf->info.scanresult.scanreason);\r\nnbss /= sizeof(hfa384x_ScanResultSub_t);\r\npr_debug("rx scanresults, reason=%d, nbss=%d:\n",\r\ninf->info.scanresult.scanreason, nbss);\r\nfor (i = 0; i < nbss; i++) {\r\npr_debug("chid=%d anl=%d sl=%d bcnint=%d\n",\r\nsr->result[i].chid,\r\nsr->result[i].anl,\r\nsr->result[i].sl, sr->result[i].bcnint);\r\npr_debug(" capinfo=0x%04x proberesp_rate=%d\n",\r\nsr->result[i].capinfo, sr->result[i].proberesp_rate);\r\n}\r\njoinreq.channel = sr->result[0].chid;\r\nmemcpy(joinreq.bssid, sr->result[0].bssid, WLAN_BSSID_LEN);\r\nresult = hfa384x_drvr_setconfig(hw,\r\nHFA384x_RID_JOINREQUEST,\r\n&joinreq, HFA384x_RID_JOINREQUEST_LEN);\r\nif (result) {\r\nnetdev_err(wlandev->netdev, "setconfig(joinreq) failed, result=%d\n",\r\nresult);\r\n}\r\n}\r\nstatic void prism2sta_inf_hostscanresults(wlandevice_t *wlandev,\r\nhfa384x_InfFrame_t *inf)\r\n{\r\nhfa384x_t *hw = wlandev->priv;\r\nint nbss;\r\nnbss = (inf->framelen - 3) / 32;\r\npr_debug("Received %d hostscan results\n", nbss);\r\nif (nbss > 32)\r\nnbss = 32;\r\nkfree(hw->scanresults);\r\nhw->scanresults = kmemdup(inf, sizeof(hfa384x_InfFrame_t), GFP_ATOMIC);\r\nif (nbss == 0)\r\nnbss = -1;\r\nhw->scanflag = nbss;\r\nwake_up_interruptible(&hw->cmdq);\r\n}\r\nstatic void prism2sta_inf_chinforesults(wlandevice_t *wlandev,\r\nhfa384x_InfFrame_t *inf)\r\n{\r\nhfa384x_t *hw = wlandev->priv;\r\nunsigned int i, n;\r\nhw->channel_info.results.scanchannels =\r\nle16_to_cpu(inf->info.chinforesult.scanchannels);\r\nfor (i = 0, n = 0; i < HFA384x_CHINFORESULT_MAX; i++) {\r\nhfa384x_ChInfoResultSub_t *result;\r\nhfa384x_ChInfoResultSub_t *chinforesult;\r\nint chan;\r\nif (!(hw->channel_info.results.scanchannels & (1 << i)))\r\ncontinue;\r\nresult = &inf->info.chinforesult.result[n];\r\nchan = le16_to_cpu(result->chid) - 1;\r\nif (chan < 0 || chan >= HFA384x_CHINFORESULT_MAX)\r\ncontinue;\r\nchinforesult = &hw->channel_info.results.result[chan];\r\nchinforesult->chid = chan;\r\nchinforesult->anl = le16_to_cpu(result->anl);\r\nchinforesult->pnl = le16_to_cpu(result->pnl);\r\nchinforesult->active = le16_to_cpu(result->active);\r\npr_debug("chinfo: channel %d, %s level (avg/peak)=%d/%d dB, pcf %d\n",\r\nchan + 1,\r\n(chinforesult->active & HFA384x_CHINFORESULT_BSSACTIVE)\r\n? "signal" : "noise",\r\nchinforesult->anl, chinforesult->pnl,\r\n(chinforesult->active & HFA384x_CHINFORESULT_PCFACTIVE)\r\n? 1 : 0);\r\nn++;\r\n}\r\natomic_set(&hw->channel_info.done, 2);\r\nhw->channel_info.count = n;\r\n}\r\nvoid prism2sta_processing_defer(struct work_struct *data)\r\n{\r\nhfa384x_t *hw = container_of(data, struct hfa384x, link_bh);\r\nwlandevice_t *wlandev = hw->wlandev;\r\nhfa384x_bytestr32_t ssid;\r\nint result;\r\n{\r\nstruct sk_buff *skb;\r\nhfa384x_InfFrame_t *inf;\r\nwhile ((skb = skb_dequeue(&hw->authq))) {\r\ninf = (hfa384x_InfFrame_t *) skb->data;\r\nprism2sta_inf_authreq_defer(wlandev, inf);\r\n}\r\n}\r\nif (hw->link_status == hw->link_status_new)\r\nreturn;\r\nhw->link_status = hw->link_status_new;\r\nswitch (hw->link_status) {\r\ncase HFA384x_LINK_NOTCONNECTED:\r\nnetif_carrier_off(wlandev->netdev);\r\nnetdev_info(wlandev->netdev, "linkstatus=NOTCONNECTED (unhandled)\n");\r\nbreak;\r\ncase HFA384x_LINK_CONNECTED:\r\nnetif_carrier_on(wlandev->netdev);\r\nif (hw->join_ap == 1)\r\nhw->join_ap = 2;\r\nhw->join_retries = 60;\r\nif (wlandev->netdev->type == ARPHRD_ETHER) {\r\nu16 portstatus;\r\nnetdev_info(wlandev->netdev, "linkstatus=CONNECTED\n");\r\nresult = hfa384x_drvr_getconfig(hw,\r\nHFA384x_RID_CURRENTBSSID,\r\nwlandev->bssid,\r\nWLAN_BSSID_LEN);\r\nif (result) {\r\npr_debug\r\n("getconfig(0x%02x) failed, result = %d\n",\r\nHFA384x_RID_CURRENTBSSID, result);\r\nreturn;\r\n}\r\nresult = hfa384x_drvr_getconfig(hw,\r\nHFA384x_RID_CURRENTSSID,\r\n&ssid, sizeof(ssid));\r\nif (result) {\r\npr_debug\r\n("getconfig(0x%02x) failed, result = %d\n",\r\nHFA384x_RID_CURRENTSSID, result);\r\nreturn;\r\n}\r\nprism2mgmt_bytestr2pstr(\r\n(struct hfa384x_bytestr *) &ssid,\r\n(p80211pstrd_t *) &wlandev->ssid);\r\nresult = hfa384x_drvr_getconfig16(hw,\r\nHFA384x_RID_PORTSTATUS,\r\n&portstatus);\r\nif (result) {\r\npr_debug\r\n("getconfig(0x%02x) failed, result = %d\n",\r\nHFA384x_RID_PORTSTATUS, result);\r\nreturn;\r\n}\r\nwlandev->macmode =\r\n(portstatus == HFA384x_PSTATUS_CONN_IBSS) ?\r\nWLAN_MACMODE_IBSS_STA : WLAN_MACMODE_ESS_STA;\r\nprism2_connect_result(wlandev, P80211ENUM_truth_false);\r\nprism2sta_commsqual_defer(&hw->commsqual_bh);\r\n}\r\nbreak;\r\ncase HFA384x_LINK_DISCONNECTED:\r\nif (wlandev->netdev->type == ARPHRD_ETHER)\r\nnetdev_info(wlandev->netdev,\r\n"linkstatus=DISCONNECTED (unhandled)\n");\r\nwlandev->macmode = WLAN_MACMODE_NONE;\r\nnetif_carrier_off(wlandev->netdev);\r\nprism2_disconnected(wlandev);\r\nbreak;\r\ncase HFA384x_LINK_AP_CHANGE:\r\nnetdev_info(wlandev->netdev, "linkstatus=AP_CHANGE\n");\r\nresult = hfa384x_drvr_getconfig(hw,\r\nHFA384x_RID_CURRENTBSSID,\r\nwlandev->bssid, WLAN_BSSID_LEN);\r\nif (result) {\r\npr_debug("getconfig(0x%02x) failed, result = %d\n",\r\nHFA384x_RID_CURRENTBSSID, result);\r\nreturn;\r\n}\r\nresult = hfa384x_drvr_getconfig(hw,\r\nHFA384x_RID_CURRENTSSID,\r\n&ssid, sizeof(ssid));\r\nif (result) {\r\npr_debug("getconfig(0x%02x) failed, result = %d\n",\r\nHFA384x_RID_CURRENTSSID, result);\r\nreturn;\r\n}\r\nprism2mgmt_bytestr2pstr((struct hfa384x_bytestr *) &ssid,\r\n(p80211pstrd_t *) &wlandev->ssid);\r\nhw->link_status = HFA384x_LINK_CONNECTED;\r\nnetif_carrier_on(wlandev->netdev);\r\nprism2_roamed(wlandev);\r\nbreak;\r\ncase HFA384x_LINK_AP_OUTOFRANGE:\r\nnetdev_info(wlandev->netdev, "linkstatus=AP_OUTOFRANGE (unhandled)\n");\r\nnetif_carrier_off(wlandev->netdev);\r\nbreak;\r\ncase HFA384x_LINK_AP_INRANGE:\r\nnetdev_info(wlandev->netdev, "linkstatus=AP_INRANGE\n");\r\nhw->link_status = HFA384x_LINK_CONNECTED;\r\nnetif_carrier_on(wlandev->netdev);\r\nbreak;\r\ncase HFA384x_LINK_ASSOCFAIL:\r\nif (hw->join_ap && --hw->join_retries > 0) {\r\nhfa384x_JoinRequest_data_t joinreq;\r\njoinreq = hw->joinreq;\r\nhfa384x_drvr_setconfig(hw,\r\nHFA384x_RID_JOINREQUEST,\r\n&joinreq,\r\nHFA384x_RID_JOINREQUEST_LEN);\r\nnetdev_info(wlandev->netdev,\r\n"linkstatus=ASSOCFAIL (re-submitting join)\n");\r\n} else {\r\nnetdev_info(wlandev->netdev, "linkstatus=ASSOCFAIL (unhandled)\n");\r\n}\r\nnetif_carrier_off(wlandev->netdev);\r\nprism2_connect_result(wlandev, P80211ENUM_truth_true);\r\nbreak;\r\ndefault:\r\nnetdev_warn(wlandev->netdev,\r\n"unknown linkstatus=0x%02x\n", hw->link_status);\r\nreturn;\r\n}\r\nwlandev->linkstatus = (hw->link_status == HFA384x_LINK_CONNECTED);\r\n}\r\nstatic void prism2sta_inf_linkstatus(wlandevice_t *wlandev,\r\nhfa384x_InfFrame_t *inf)\r\n{\r\nhfa384x_t *hw = wlandev->priv;\r\nhw->link_status_new = le16_to_cpu(inf->info.linkstatus.linkstatus);\r\nschedule_work(&hw->link_bh);\r\n}\r\nstatic void prism2sta_inf_assocstatus(wlandevice_t *wlandev,\r\nhfa384x_InfFrame_t *inf)\r\n{\r\nhfa384x_t *hw = wlandev->priv;\r\nhfa384x_AssocStatus_t rec;\r\nint i;\r\nmemcpy(&rec, &inf->info.assocstatus, sizeof(rec));\r\nrec.assocstatus = le16_to_cpu(rec.assocstatus);\r\nrec.reason = le16_to_cpu(rec.reason);\r\nfor (i = 0; i < hw->authlist.cnt; i++)\r\nif (ether_addr_equal(rec.sta_addr, hw->authlist.addr[i]))\r\nbreak;\r\nif (i >= hw->authlist.cnt) {\r\nif (rec.assocstatus != HFA384x_ASSOCSTATUS_AUTHFAIL)\r\nnetdev_warn(wlandev->netdev,\r\n"assocstatus info frame received for non-authenticated station.\n");\r\n} else {\r\nhw->authlist.assoc[i] =\r\n(rec.assocstatus == HFA384x_ASSOCSTATUS_STAASSOC ||\r\nrec.assocstatus == HFA384x_ASSOCSTATUS_REASSOC);\r\nif (rec.assocstatus == HFA384x_ASSOCSTATUS_AUTHFAIL)\r\nnetdev_warn(wlandev->netdev,\r\n"authfail assocstatus info frame received for authenticated station.\n");\r\n}\r\n}\r\nstatic void prism2sta_inf_authreq(wlandevice_t *wlandev,\r\nhfa384x_InfFrame_t *inf)\r\n{\r\nhfa384x_t *hw = wlandev->priv;\r\nstruct sk_buff *skb;\r\nskb = dev_alloc_skb(sizeof(*inf));\r\nif (skb) {\r\nskb_put(skb, sizeof(*inf));\r\nmemcpy(skb->data, inf, sizeof(*inf));\r\nskb_queue_tail(&hw->authq, skb);\r\nschedule_work(&hw->link_bh);\r\n}\r\n}\r\nstatic void prism2sta_inf_authreq_defer(wlandevice_t *wlandev,\r\nhfa384x_InfFrame_t *inf)\r\n{\r\nhfa384x_t *hw = wlandev->priv;\r\nhfa384x_authenticateStation_data_t rec;\r\nint i, added, result, cnt;\r\nu8 *addr;\r\nether_addr_copy(rec.address, inf->info.authreq.sta_addr);\r\nrec.status = P80211ENUM_status_unspec_failure;\r\nswitch (hw->accessmode) {\r\ncase WLAN_ACCESS_NONE:\r\nfor (i = 0; i < hw->authlist.cnt; i++)\r\nif (ether_addr_equal(rec.address,\r\nhw->authlist.addr[i])) {\r\nrec.status = P80211ENUM_status_successful;\r\nbreak;\r\n}\r\nbreak;\r\ncase WLAN_ACCESS_ALL:\r\nrec.status = P80211ENUM_status_successful;\r\nbreak;\r\ncase WLAN_ACCESS_ALLOW:\r\nif (hw->allow.modify == 0) {\r\ncnt = hw->allow.cnt;\r\naddr = hw->allow.addr[0];\r\n} else {\r\ncnt = hw->allow.cnt1;\r\naddr = hw->allow.addr1[0];\r\n}\r\nfor (i = 0; i < cnt; i++, addr += ETH_ALEN)\r\nif (ether_addr_equal(rec.address, addr)) {\r\nrec.status = P80211ENUM_status_successful;\r\nbreak;\r\n}\r\nbreak;\r\ncase WLAN_ACCESS_DENY:\r\nif (hw->deny.modify == 0) {\r\ncnt = hw->deny.cnt;\r\naddr = hw->deny.addr[0];\r\n} else {\r\ncnt = hw->deny.cnt1;\r\naddr = hw->deny.addr1[0];\r\n}\r\nrec.status = P80211ENUM_status_successful;\r\nfor (i = 0; i < cnt; i++, addr += ETH_ALEN)\r\nif (ether_addr_equal(rec.address, addr)) {\r\nrec.status = P80211ENUM_status_unspec_failure;\r\nbreak;\r\n}\r\nbreak;\r\n}\r\nadded = 0;\r\nif (rec.status == P80211ENUM_status_successful) {\r\nfor (i = 0; i < hw->authlist.cnt; i++)\r\nif (ether_addr_equal(rec.address,\r\nhw->authlist.addr[i]))\r\nbreak;\r\nif (i >= hw->authlist.cnt) {\r\nif (hw->authlist.cnt >= WLAN_AUTH_MAX) {\r\nrec.status = P80211ENUM_status_ap_full;\r\n} else {\r\nether_addr_copy(\r\nhw->authlist.addr[hw->authlist.cnt],\r\nrec.address);\r\nhw->authlist.cnt++;\r\nadded = 1;\r\n}\r\n}\r\n}\r\nrec.status = cpu_to_le16(rec.status);\r\nrec.algorithm = inf->info.authreq.algorithm;\r\nresult = hfa384x_drvr_setconfig(hw, HFA384x_RID_AUTHENTICATESTA,\r\n&rec, sizeof(rec));\r\nif (result) {\r\nif (added)\r\nhw->authlist.cnt--;\r\nnetdev_err(wlandev->netdev,\r\n"setconfig(authenticatestation) failed, result=%d\n",\r\nresult);\r\n}\r\n}\r\nstatic void prism2sta_inf_psusercnt(wlandevice_t *wlandev,\r\nhfa384x_InfFrame_t *inf)\r\n{\r\nhfa384x_t *hw = wlandev->priv;\r\nhw->psusercount = le16_to_cpu(inf->info.psusercnt.usercnt);\r\n}\r\nvoid prism2sta_ev_info(wlandevice_t *wlandev, hfa384x_InfFrame_t *inf)\r\n{\r\ninf->infotype = le16_to_cpu(inf->infotype);\r\nswitch (inf->infotype) {\r\ncase HFA384x_IT_HANDOVERADDR:\r\nprism2sta_inf_handover(wlandev, inf);\r\nbreak;\r\ncase HFA384x_IT_COMMTALLIES:\r\nprism2sta_inf_tallies(wlandev, inf);\r\nbreak;\r\ncase HFA384x_IT_HOSTSCANRESULTS:\r\nprism2sta_inf_hostscanresults(wlandev, inf);\r\nbreak;\r\ncase HFA384x_IT_SCANRESULTS:\r\nprism2sta_inf_scanresults(wlandev, inf);\r\nbreak;\r\ncase HFA384x_IT_CHINFORESULTS:\r\nprism2sta_inf_chinforesults(wlandev, inf);\r\nbreak;\r\ncase HFA384x_IT_LINKSTATUS:\r\nprism2sta_inf_linkstatus(wlandev, inf);\r\nbreak;\r\ncase HFA384x_IT_ASSOCSTATUS:\r\nprism2sta_inf_assocstatus(wlandev, inf);\r\nbreak;\r\ncase HFA384x_IT_AUTHREQ:\r\nprism2sta_inf_authreq(wlandev, inf);\r\nbreak;\r\ncase HFA384x_IT_PSUSERCNT:\r\nprism2sta_inf_psusercnt(wlandev, inf);\r\nbreak;\r\ncase HFA384x_IT_KEYIDCHANGED:\r\nnetdev_warn(wlandev->netdev, "Unhandled IT_KEYIDCHANGED\n");\r\nbreak;\r\ncase HFA384x_IT_ASSOCREQ:\r\nnetdev_warn(wlandev->netdev, "Unhandled IT_ASSOCREQ\n");\r\nbreak;\r\ncase HFA384x_IT_MICFAILURE:\r\nnetdev_warn(wlandev->netdev, "Unhandled IT_MICFAILURE\n");\r\nbreak;\r\ndefault:\r\nnetdev_warn(wlandev->netdev,\r\n"Unknown info type=0x%02x\n", inf->infotype);\r\nbreak;\r\n}\r\n}\r\nvoid prism2sta_ev_txexc(wlandevice_t *wlandev, u16 status)\r\n{\r\npr_debug("TxExc status=0x%x.\n", status);\r\n}\r\nvoid prism2sta_ev_tx(wlandevice_t *wlandev, u16 status)\r\n{\r\npr_debug("Tx Complete, status=0x%04x\n", status);\r\nwlandev->netdev->stats.tx_packets++;\r\n}\r\nvoid prism2sta_ev_alloc(wlandevice_t *wlandev)\r\n{\r\nnetif_wake_queue(wlandev->netdev);\r\n}\r\nstatic wlandevice_t *create_wlan(void)\r\n{\r\nwlandevice_t *wlandev = NULL;\r\nhfa384x_t *hw = NULL;\r\nwlandev = kzalloc(sizeof(wlandevice_t), GFP_KERNEL);\r\nhw = kzalloc(sizeof(hfa384x_t), GFP_KERNEL);\r\nif (!wlandev || !hw) {\r\nkfree(wlandev);\r\nkfree(hw);\r\nreturn NULL;\r\n}\r\nwlandev->nsdname = dev_info;\r\nwlandev->msdstate = WLAN_MSD_HWPRESENT_PENDING;\r\nwlandev->priv = hw;\r\nwlandev->open = prism2sta_open;\r\nwlandev->close = prism2sta_close;\r\nwlandev->reset = prism2sta_reset;\r\nwlandev->txframe = prism2sta_txframe;\r\nwlandev->mlmerequest = prism2sta_mlmerequest;\r\nwlandev->set_multicast_list = prism2sta_setmulticast;\r\nwlandev->tx_timeout = hfa384x_tx_timeout;\r\nwlandev->nsdcaps = P80211_NSDCAP_HWFRAGMENT | P80211_NSDCAP_AUTOJOIN;\r\nhw->dot11_desired_bss_type = 1;\r\nreturn wlandev;\r\n}\r\nvoid prism2sta_commsqual_defer(struct work_struct *data)\r\n{\r\nhfa384x_t *hw = container_of(data, struct hfa384x, commsqual_bh);\r\nwlandevice_t *wlandev = hw->wlandev;\r\nhfa384x_bytestr32_t ssid;\r\nstruct p80211msg_dot11req_mibget msg;\r\np80211item_uint32_t *mibitem = (p80211item_uint32_t *)\r\n&msg.mibattribute.data;\r\nint result = 0;\r\nif (hw->wlandev->hwremoved)\r\nreturn;\r\nif ((wlandev->macmode == WLAN_MACMODE_NONE) ||\r\n(wlandev->macmode == WLAN_MACMODE_ESS_AP)) {\r\nreturn;\r\n}\r\nif (wlandev->macmode != WLAN_MACMODE_IBSS_STA) {\r\nresult = hfa384x_drvr_getconfig(\r\nhw, HFA384x_RID_DBMCOMMSQUALITY,\r\n&hw->qual, HFA384x_RID_DBMCOMMSQUALITY_LEN);\r\nif (result) {\r\nnetdev_err(wlandev->netdev, "error fetching commsqual\n");\r\nreturn;\r\n}\r\npr_debug("commsqual %d %d %d\n",\r\nle16_to_cpu(hw->qual.CQ_currBSS),\r\nle16_to_cpu(hw->qual.ASL_currBSS),\r\nle16_to_cpu(hw->qual.ANL_currFC));\r\n}\r\nmsg.msgcode = DIDmsg_dot11req_mibget;\r\nmibitem->did = DIDmib_p2_p2MAC_p2CurrentTxRate;\r\nresult = p80211req_dorequest(wlandev, (u8 *) &msg);\r\nif (result) {\r\npr_debug("get signal rate failed, result = %d\n",\r\nresult);\r\nreturn;\r\n}\r\nswitch (mibitem->data) {\r\ncase HFA384x_RATEBIT_1:\r\nhw->txrate = 10;\r\nbreak;\r\ncase HFA384x_RATEBIT_2:\r\nhw->txrate = 20;\r\nbreak;\r\ncase HFA384x_RATEBIT_5dot5:\r\nhw->txrate = 55;\r\nbreak;\r\ncase HFA384x_RATEBIT_11:\r\nhw->txrate = 110;\r\nbreak;\r\ndefault:\r\npr_debug("Bad ratebit (%d)\n", mibitem->data);\r\n}\r\nresult = hfa384x_drvr_getconfig(hw,\r\nHFA384x_RID_CURRENTBSSID,\r\nwlandev->bssid, WLAN_BSSID_LEN);\r\nif (result) {\r\npr_debug("getconfig(0x%02x) failed, result = %d\n",\r\nHFA384x_RID_CURRENTBSSID, result);\r\nreturn;\r\n}\r\nresult = hfa384x_drvr_getconfig(hw,\r\nHFA384x_RID_CURRENTSSID,\r\n&ssid, sizeof(ssid));\r\nif (result) {\r\npr_debug("getconfig(0x%02x) failed, result = %d\n",\r\nHFA384x_RID_CURRENTSSID, result);\r\nreturn;\r\n}\r\nprism2mgmt_bytestr2pstr((struct hfa384x_bytestr *) &ssid,\r\n(p80211pstrd_t *) &wlandev->ssid);\r\nmod_timer(&hw->commsqual_timer, jiffies + HZ);\r\n}\r\nvoid prism2sta_commsqual_timer(unsigned long data)\r\n{\r\nhfa384x_t *hw = (hfa384x_t *) data;\r\nschedule_work(&hw->commsqual_bh);\r\n}

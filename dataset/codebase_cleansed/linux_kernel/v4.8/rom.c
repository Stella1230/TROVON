int pci_enable_rom(struct pci_dev *pdev)\r\n{\r\nstruct resource *res = &pdev->resource[PCI_ROM_RESOURCE];\r\nstruct pci_bus_region region;\r\nu32 rom_addr;\r\nif (!res->flags)\r\nreturn -1;\r\nif (res->flags & IORESOURCE_ROM_SHADOW)\r\nreturn 0;\r\npcibios_resource_to_bus(pdev->bus, &region, res);\r\npci_read_config_dword(pdev, pdev->rom_base_reg, &rom_addr);\r\nrom_addr &= ~PCI_ROM_ADDRESS_MASK;\r\nrom_addr |= region.start | PCI_ROM_ADDRESS_ENABLE;\r\npci_write_config_dword(pdev, pdev->rom_base_reg, rom_addr);\r\nreturn 0;\r\n}\r\nvoid pci_disable_rom(struct pci_dev *pdev)\r\n{\r\nstruct resource *res = &pdev->resource[PCI_ROM_RESOURCE];\r\nu32 rom_addr;\r\nif (res->flags & IORESOURCE_ROM_SHADOW)\r\nreturn;\r\npci_read_config_dword(pdev, pdev->rom_base_reg, &rom_addr);\r\nrom_addr &= ~PCI_ROM_ADDRESS_ENABLE;\r\npci_write_config_dword(pdev, pdev->rom_base_reg, rom_addr);\r\n}\r\nsize_t pci_get_rom_size(struct pci_dev *pdev, void __iomem *rom, size_t size)\r\n{\r\nvoid __iomem *image;\r\nint last_image;\r\nunsigned length;\r\nimage = rom;\r\ndo {\r\nvoid __iomem *pds;\r\nif (readw(image) != 0xAA55) {\r\ndev_err(&pdev->dev, "Invalid PCI ROM header signature: expecting 0xaa55, got %#06x\n",\r\nreadw(image));\r\nbreak;\r\n}\r\npds = image + readw(image + 24);\r\nif (readl(pds) != 0x52494350) {\r\ndev_err(&pdev->dev, "Invalid PCI ROM data signature: expecting 0x52494350, got %#010x\n",\r\nreadl(pds));\r\nbreak;\r\n}\r\nlast_image = readb(pds + 21) & 0x80;\r\nlength = readw(pds + 16);\r\nimage += length * 512;\r\nif (image > rom + size)\r\nbreak;\r\n} while (length && !last_image);\r\nreturn min((size_t)(image - rom), size);\r\n}\r\nvoid __iomem *pci_map_rom(struct pci_dev *pdev, size_t *size)\r\n{\r\nstruct resource *res = &pdev->resource[PCI_ROM_RESOURCE];\r\nloff_t start;\r\nvoid __iomem *rom;\r\nif (res->parent == NULL && pci_assign_resource(pdev, PCI_ROM_RESOURCE))\r\nreturn NULL;\r\nstart = pci_resource_start(pdev, PCI_ROM_RESOURCE);\r\n*size = pci_resource_len(pdev, PCI_ROM_RESOURCE);\r\nif (*size == 0)\r\nreturn NULL;\r\nif (pci_enable_rom(pdev))\r\nreturn NULL;\r\nrom = ioremap(start, *size);\r\nif (!rom) {\r\nif (!(res->flags & IORESOURCE_ROM_ENABLE))\r\npci_disable_rom(pdev);\r\nreturn NULL;\r\n}\r\n*size = pci_get_rom_size(pdev, rom, *size);\r\nreturn rom;\r\n}\r\nvoid pci_unmap_rom(struct pci_dev *pdev, void __iomem *rom)\r\n{\r\nstruct resource *res = &pdev->resource[PCI_ROM_RESOURCE];\r\niounmap(rom);\r\nif (!(res->flags & IORESOURCE_ROM_ENABLE))\r\npci_disable_rom(pdev);\r\n}\r\nvoid __iomem *pci_platform_rom(struct pci_dev *pdev, size_t *size)\r\n{\r\nif (pdev->rom && pdev->romlen) {\r\n*size = pdev->romlen;\r\nreturn phys_to_virt((phys_addr_t)pdev->rom);\r\n}\r\nreturn NULL;\r\n}

static void suni_hz(unsigned long from_timer)\r\n{\r\nstruct suni_priv *walk;\r\nstruct atm_dev *dev;\r\nstruct k_sonet_stats *stats;\r\nfor (walk = sunis; walk; walk = walk->next) {\r\ndev = walk->dev;\r\nstats = &walk->sonet_stats;\r\nPUT(0,MRI);\r\nudelay(1);\r\nADD_LIMITED(section_bip,(GET(RSOP_SBL) & 0xff) |\r\n((GET(RSOP_SBM) & 0xff) << 8));\r\nADD_LIMITED(line_bip,(GET(RLOP_LBL) & 0xff) |\r\n((GET(RLOP_LB) & 0xff) << 8) |\r\n((GET(RLOP_LBM) & 0xf) << 16));\r\nADD_LIMITED(path_bip,(GET(RPOP_PBL) & 0xff) |\r\n((GET(RPOP_PBM) & 0xff) << 8));\r\nADD_LIMITED(line_febe,(GET(RLOP_LFL) & 0xff) |\r\n((GET(RLOP_LF) & 0xff) << 8) |\r\n((GET(RLOP_LFM) & 0xf) << 16));\r\nADD_LIMITED(path_febe,(GET(RPOP_PFL) & 0xff) |\r\n((GET(RPOP_PFM) & 0xff) << 8));\r\nADD_LIMITED(corr_hcs,GET(RACP_CHEC) & 0xff);\r\nADD_LIMITED(uncorr_hcs,GET(RACP_UHEC) & 0xff);\r\nADD_LIMITED(rx_cells,(GET(RACP_RCCL) & 0xff) |\r\n((GET(RACP_RCC) & 0xff) << 8) |\r\n((GET(RACP_RCCM) & 7) << 16));\r\nADD_LIMITED(tx_cells,(GET(TACP_TCCL) & 0xff) |\r\n((GET(TACP_TCC) & 0xff) << 8) |\r\n((GET(TACP_TCCM) & 7) << 16));\r\n}\r\nif (from_timer) mod_timer(&poll_timer,jiffies+HZ);\r\n}\r\nstatic int fetch_stats(struct atm_dev *dev,struct sonet_stats __user *arg,int zero)\r\n{\r\nstruct sonet_stats tmp;\r\nint error = 0;\r\nsonet_copy_stats(&PRIV(dev)->sonet_stats,&tmp);\r\nif (arg) error = copy_to_user(arg,&tmp,sizeof(tmp));\r\nif (zero && !error) sonet_subtract_stats(&PRIV(dev)->sonet_stats,&tmp);\r\nreturn error ? -EFAULT : 0;\r\n}\r\nstatic int change_diag(struct atm_dev *dev,void __user *arg,int set)\r\n{\r\nint todo;\r\nif (get_user(todo,(int __user *)arg)) return -EFAULT;\r\nHANDLE_FLAG(SONET_INS_SBIP,TSOP_DIAG,SUNI_TSOP_DIAG_DBIP8);\r\nHANDLE_FLAG(SONET_INS_LBIP,TLOP_DIAG,SUNI_TLOP_DIAG_DBIP);\r\nHANDLE_FLAG(SONET_INS_PBIP,TPOP_CD,SUNI_TPOP_DIAG_DB3);\r\nHANDLE_FLAG(SONET_INS_FRAME,RSOP_CIE,SUNI_RSOP_CIE_FOOF);\r\nHANDLE_FLAG(SONET_INS_LAIS,TSOP_CTRL,SUNI_TSOP_CTRL_LAIS);\r\nHANDLE_FLAG(SONET_INS_PAIS,TPOP_CD,SUNI_TPOP_DIAG_PAIS);\r\nHANDLE_FLAG(SONET_INS_LOS,TSOP_DIAG,SUNI_TSOP_DIAG_DLOS);\r\nHANDLE_FLAG(SONET_INS_HCS,TACP_CS,SUNI_TACP_CS_DHCS);\r\nreturn put_user(todo,(int __user *)arg) ? -EFAULT : 0;\r\n}\r\nstatic int get_diag(struct atm_dev *dev,void __user *arg)\r\n{\r\nint set;\r\nset = 0;\r\nif (GET(TSOP_DIAG) & SUNI_TSOP_DIAG_DBIP8) set |= SONET_INS_SBIP;\r\nif (GET(TLOP_DIAG) & SUNI_TLOP_DIAG_DBIP) set |= SONET_INS_LBIP;\r\nif (GET(TPOP_CD) & SUNI_TPOP_DIAG_DB3) set |= SONET_INS_PBIP;\r\nif (GET(TSOP_CTRL) & SUNI_TSOP_CTRL_LAIS) set |= SONET_INS_LAIS;\r\nif (GET(TPOP_CD) & SUNI_TPOP_DIAG_PAIS) set |= SONET_INS_PAIS;\r\nif (GET(TSOP_DIAG) & SUNI_TSOP_DIAG_DLOS) set |= SONET_INS_LOS;\r\nif (GET(TACP_CS) & SUNI_TACP_CS_DHCS) set |= SONET_INS_HCS;\r\nreturn put_user(set,(int __user *)arg) ? -EFAULT : 0;\r\n}\r\nstatic int set_loopback(struct atm_dev *dev,int mode)\r\n{\r\nunsigned char control;\r\nint reg, dle, lle;\r\nif (PRIV(dev)->type == SUNI_MRI_TYPE_PM5355) {\r\nreg = SUNI_MCM;\r\ndle = SUNI_MCM_DLE;\r\nlle = SUNI_MCM_LLE;\r\n} else {\r\nreg = SUNI_MCT;\r\ndle = SUNI_MCT_DLE;\r\nlle = SUNI_MCT_LLE;\r\n}\r\ncontrol = dev->ops->phy_get(dev, reg) & ~(dle | lle);\r\nswitch (mode) {\r\ncase ATM_LM_NONE:\r\nbreak;\r\ncase ATM_LM_LOC_PHY:\r\ncontrol |= dle;\r\nbreak;\r\ncase ATM_LM_RMT_PHY:\r\ncontrol |= lle;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ndev->ops->phy_put(dev, control, reg);\r\nPRIV(dev)->loop_mode = mode;\r\nreturn 0;\r\n}\r\nstatic int set_sonet(struct atm_dev *dev)\r\n{\r\nif (PRIV(dev)->type == SUNI_MRI_TYPE_PM5355) {\r\nPUT(GET(RPOP_RC) & ~SUNI_RPOP_RC_ENSS, RPOP_RC);\r\nPUT(GET(SSTB_CTRL) & ~SUNI_SSTB_CTRL_LEN16, SSTB_CTRL);\r\nPUT(GET(SPTB_CTRL) & ~SUNI_SPTB_CTRL_LEN16, SPTB_CTRL);\r\n}\r\nREG_CHANGE(SUNI_TPOP_APM_S, SUNI_TPOP_APM_S_SHIFT,\r\nSUNI_TPOP_S_SONET, TPOP_APM);\r\nreturn 0;\r\n}\r\nstatic int set_sdh(struct atm_dev *dev)\r\n{\r\nif (PRIV(dev)->type == SUNI_MRI_TYPE_PM5355) {\r\nPUT(GET(RPOP_RC) | SUNI_RPOP_RC_ENSS, RPOP_RC);\r\nPUT(GET(SSTB_CTRL) | SUNI_SSTB_CTRL_LEN16, SSTB_CTRL);\r\nPUT(GET(SPTB_CTRL) | SUNI_SPTB_CTRL_LEN16, SPTB_CTRL);\r\n}\r\nREG_CHANGE(SUNI_TPOP_APM_S, SUNI_TPOP_APM_S_SHIFT,\r\nSUNI_TPOP_S_SDH, TPOP_APM);\r\nreturn 0;\r\n}\r\nstatic int get_framing(struct atm_dev *dev, void __user *arg)\r\n{\r\nint framing;\r\nunsigned char s;\r\ns = (GET(TPOP_APM) & SUNI_TPOP_APM_S) >> SUNI_TPOP_APM_S_SHIFT;\r\nif (s == SUNI_TPOP_S_SONET)\r\nframing = SONET_FRAME_SONET;\r\nelse\r\nframing = SONET_FRAME_SDH;\r\nreturn put_user(framing, (int __user *) arg) ? -EFAULT : 0;\r\n}\r\nstatic int set_framing(struct atm_dev *dev, void __user *arg)\r\n{\r\nint mode;\r\nif (get_user(mode, (int __user *) arg))\r\nreturn -EFAULT;\r\nif (mode == SONET_FRAME_SONET)\r\nreturn set_sonet(dev);\r\nelse if (mode == SONET_FRAME_SDH)\r\nreturn set_sdh(dev);\r\nreturn -EINVAL;\r\n}\r\nstatic int suni_ioctl(struct atm_dev *dev,unsigned int cmd,void __user *arg)\r\n{\r\nswitch (cmd) {\r\ncase SONET_GETSTATZ:\r\ncase SONET_GETSTAT:\r\nreturn fetch_stats(dev, arg, cmd == SONET_GETSTATZ);\r\ncase SONET_SETDIAG:\r\nreturn change_diag(dev,arg,1);\r\ncase SONET_CLRDIAG:\r\nreturn change_diag(dev,arg,0);\r\ncase SONET_GETDIAG:\r\nreturn get_diag(dev,arg);\r\ncase SONET_SETFRAMING:\r\nif (!capable(CAP_NET_ADMIN))\r\nreturn -EPERM;\r\nreturn set_framing(dev, arg);\r\ncase SONET_GETFRAMING:\r\nreturn get_framing(dev, arg);\r\ncase SONET_GETFRSENSE:\r\nreturn -EINVAL;\r\ncase ATM_SETLOOP:\r\nif (!capable(CAP_NET_ADMIN))\r\nreturn -EPERM;\r\nreturn set_loopback(dev,(int)(unsigned long)arg);\r\ncase ATM_GETLOOP:\r\nreturn put_user(PRIV(dev)->loop_mode,(int __user *)arg) ?\r\n-EFAULT : 0;\r\ncase ATM_QUERYLOOP:\r\nreturn put_user(ATM_LM_LOC_PHY | ATM_LM_RMT_PHY,\r\n(int __user *) arg) ? -EFAULT : 0;\r\ndefault:\r\nreturn -ENOIOCTLCMD;\r\n}\r\n}\r\nstatic void poll_los(struct atm_dev *dev)\r\n{\r\natm_dev_signal_change(dev,\r\nGET(RSOP_SIS) & SUNI_RSOP_SIS_LOSV ?\r\nATM_PHY_SIG_LOST : ATM_PHY_SIG_FOUND);\r\n}\r\nstatic void suni_int(struct atm_dev *dev)\r\n{\r\npoll_los(dev);\r\nprintk(KERN_NOTICE "%s(itf %d): signal %s\n",dev->type,dev->number,\r\ndev->signal == ATM_PHY_SIG_LOST ? "lost" : "detected again");\r\n}\r\nstatic int suni_start(struct atm_dev *dev)\r\n{\r\nunsigned long flags;\r\nint first;\r\nspin_lock_irqsave(&sunis_lock,flags);\r\nfirst = !sunis;\r\nPRIV(dev)->next = sunis;\r\nsunis = PRIV(dev);\r\nspin_unlock_irqrestore(&sunis_lock,flags);\r\nmemset(&PRIV(dev)->sonet_stats,0,sizeof(struct k_sonet_stats));\r\nPUT(GET(RSOP_CIE) | SUNI_RSOP_CIE_LOSE,RSOP_CIE);\r\npoll_los(dev);\r\nif (dev->signal == ATM_PHY_SIG_LOST)\r\nprintk(KERN_WARNING "%s(itf %d): no signal\n",dev->type,\r\ndev->number);\r\nPRIV(dev)->loop_mode = ATM_LM_NONE;\r\nsuni_hz(0);\r\n(void) fetch_stats(dev,NULL,1);\r\nif (first) {\r\ninit_timer(&poll_timer);\r\npoll_timer.expires = jiffies+HZ;\r\npoll_timer.function = suni_hz;\r\npoll_timer.data = 1;\r\n#if 0\r\nprintk(KERN_DEBUG "[u] p=0x%lx,n=0x%lx\n",(unsigned long) poll_timer.list.prev,\r\n(unsigned long) poll_timer.list.next);\r\n#endif\r\nadd_timer(&poll_timer);\r\n}\r\nreturn 0;\r\n}\r\nstatic int suni_stop(struct atm_dev *dev)\r\n{\r\nstruct suni_priv **walk;\r\nunsigned long flags;\r\nspin_lock_irqsave(&sunis_lock,flags);\r\nfor (walk = &sunis; *walk != PRIV(dev);\r\nwalk = &PRIV((*walk)->dev)->next);\r\n*walk = PRIV((*walk)->dev)->next;\r\nif (!sunis) del_timer_sync(&poll_timer);\r\nspin_unlock_irqrestore(&sunis_lock,flags);\r\nkfree(PRIV(dev));\r\nreturn 0;\r\n}\r\nint suni_init(struct atm_dev *dev)\r\n{\r\nunsigned char mri;\r\nif (!(dev->phy_data = kmalloc(sizeof(struct suni_priv),GFP_KERNEL)))\r\nreturn -ENOMEM;\r\nPRIV(dev)->dev = dev;\r\nmri = GET(MRI);\r\nPRIV(dev)->type = (mri & SUNI_MRI_TYPE) >> SUNI_MRI_TYPE_SHIFT;\r\nPUT(mri | SUNI_MRI_RESET,MRI);\r\nPUT(mri,MRI);\r\nPUT((GET(MT) & SUNI_MT_DS27_53),MT);\r\nset_sonet(dev);\r\nREG_CHANGE(SUNI_TACP_IUCHP_CLP,0,SUNI_TACP_IUCHP_CLP,\r\nTACP_IUCHP);\r\nPUT(SUNI_IDLE_PATTERN,TACP_IUCPOP);\r\ndev->phy = &suni_ops;\r\nreturn 0;\r\n}

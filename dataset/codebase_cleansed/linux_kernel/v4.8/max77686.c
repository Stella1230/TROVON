static bool max77802_pmic_is_accessible_reg(struct device *dev,\r\nunsigned int reg)\r\n{\r\nreturn reg < MAX77802_REG_PMIC_END;\r\n}\r\nstatic bool max77802_rtc_is_accessible_reg(struct device *dev,\r\nunsigned int reg)\r\n{\r\nreturn (reg >= MAX77802_RTC_INT && reg < MAX77802_RTC_END);\r\n}\r\nstatic bool max77802_is_accessible_reg(struct device *dev, unsigned int reg)\r\n{\r\nreturn (max77802_pmic_is_accessible_reg(dev, reg) ||\r\nmax77802_rtc_is_accessible_reg(dev, reg));\r\n}\r\nstatic bool max77802_pmic_is_precious_reg(struct device *dev, unsigned int reg)\r\n{\r\nreturn (reg == MAX77802_REG_INTSRC || reg == MAX77802_REG_INT1 ||\r\nreg == MAX77802_REG_INT2);\r\n}\r\nstatic bool max77802_rtc_is_precious_reg(struct device *dev, unsigned int reg)\r\n{\r\nreturn (reg == MAX77802_RTC_INT ||\r\nreg == MAX77802_RTC_UPDATE0 ||\r\nreg == MAX77802_RTC_UPDATE1);\r\n}\r\nstatic bool max77802_is_precious_reg(struct device *dev, unsigned int reg)\r\n{\r\nreturn (max77802_pmic_is_precious_reg(dev, reg) ||\r\nmax77802_rtc_is_precious_reg(dev, reg));\r\n}\r\nstatic bool max77802_pmic_is_volatile_reg(struct device *dev, unsigned int reg)\r\n{\r\nreturn (max77802_is_precious_reg(dev, reg) ||\r\nreg == MAX77802_REG_STATUS1 || reg == MAX77802_REG_STATUS2 ||\r\nreg == MAX77802_REG_PWRON);\r\n}\r\nstatic bool max77802_rtc_is_volatile_reg(struct device *dev, unsigned int reg)\r\n{\r\nreturn (max77802_rtc_is_precious_reg(dev, reg) ||\r\nreg == MAX77802_RTC_SEC ||\r\nreg == MAX77802_RTC_MIN ||\r\nreg == MAX77802_RTC_HOUR ||\r\nreg == MAX77802_RTC_WEEKDAY ||\r\nreg == MAX77802_RTC_MONTH ||\r\nreg == MAX77802_RTC_YEAR ||\r\nreg == MAX77802_RTC_DATE);\r\n}\r\nstatic bool max77802_is_volatile_reg(struct device *dev, unsigned int reg)\r\n{\r\nreturn (max77802_pmic_is_volatile_reg(dev, reg) ||\r\nmax77802_rtc_is_volatile_reg(dev, reg));\r\n}\r\nstatic int max77686_i2c_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct max77686_dev *max77686 = NULL;\r\nconst struct of_device_id *match;\r\nunsigned int data;\r\nint ret = 0;\r\nconst struct regmap_config *config;\r\nconst struct regmap_irq_chip *irq_chip;\r\nconst struct mfd_cell *cells;\r\nint n_devs;\r\nmax77686 = devm_kzalloc(&i2c->dev,\r\nsizeof(struct max77686_dev), GFP_KERNEL);\r\nif (!max77686)\r\nreturn -ENOMEM;\r\nif (i2c->dev.of_node) {\r\nmatch = of_match_node(max77686_pmic_dt_match, i2c->dev.of_node);\r\nif (!match)\r\nreturn -EINVAL;\r\nmax77686->type = (unsigned long)match->data;\r\n} else\r\nmax77686->type = id->driver_data;\r\ni2c_set_clientdata(i2c, max77686);\r\nmax77686->dev = &i2c->dev;\r\nmax77686->i2c = i2c;\r\nmax77686->irq = i2c->irq;\r\nif (max77686->type == TYPE_MAX77686) {\r\nconfig = &max77686_regmap_config;\r\nirq_chip = &max77686_irq_chip;\r\ncells = max77686_devs;\r\nn_devs = ARRAY_SIZE(max77686_devs);\r\n} else {\r\nconfig = &max77802_regmap_config;\r\nirq_chip = &max77802_irq_chip;\r\ncells = max77802_devs;\r\nn_devs = ARRAY_SIZE(max77802_devs);\r\n}\r\nmax77686->regmap = devm_regmap_init_i2c(i2c, config);\r\nif (IS_ERR(max77686->regmap)) {\r\nret = PTR_ERR(max77686->regmap);\r\ndev_err(max77686->dev, "Failed to allocate register map: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nret = regmap_read(max77686->regmap, MAX77686_REG_DEVICE_ID, &data);\r\nif (ret < 0) {\r\ndev_err(max77686->dev,\r\n"device not found on this channel (this is not an error)\n");\r\nreturn -ENODEV;\r\n}\r\nret = devm_regmap_add_irq_chip(&i2c->dev, max77686->regmap,\r\nmax77686->irq,\r\nIRQF_TRIGGER_FALLING | IRQF_ONESHOT |\r\nIRQF_SHARED, 0, irq_chip,\r\n&max77686->irq_data);\r\nif (ret < 0) {\r\ndev_err(&i2c->dev, "failed to add PMIC irq chip: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = devm_mfd_add_devices(max77686->dev, -1, cells, n_devs, NULL,\r\n0, NULL);\r\nif (ret < 0) {\r\ndev_err(&i2c->dev, "failed to add MFD devices: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max77686_suspend(struct device *dev)\r\n{\r\nstruct i2c_client *i2c = to_i2c_client(dev);\r\nstruct max77686_dev *max77686 = i2c_get_clientdata(i2c);\r\nif (device_may_wakeup(dev))\r\nenable_irq_wake(max77686->irq);\r\ndisable_irq(max77686->irq);\r\nreturn 0;\r\n}\r\nstatic int max77686_resume(struct device *dev)\r\n{\r\nstruct i2c_client *i2c = to_i2c_client(dev);\r\nstruct max77686_dev *max77686 = i2c_get_clientdata(i2c);\r\nif (device_may_wakeup(dev))\r\ndisable_irq_wake(max77686->irq);\r\nenable_irq(max77686->irq);\r\nreturn 0;\r\n}

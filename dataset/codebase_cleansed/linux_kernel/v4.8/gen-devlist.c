static void\r\npq(FILE *f, const char *c)\r\n{\r\nwhile (*c) {\r\nif (*c == '"')\r\nfprintf(f, "\\\"");\r\nelse\r\nfputc(*c, f);\r\nc++;\r\n}\r\n}\r\nint\r\nmain(void)\r\n{\r\nchar line[1024], *c, *bra, manuf[8];\r\nint manufs = 0;\r\nint mode = 0;\r\nint lino = 0;\r\nint manuf_len = 0;\r\nFILE *devf;\r\ndevf = fopen("devlist.h", "w");\r\nif (!devf) {\r\nfprintf(stderr, "Cannot create output file!\n");\r\nreturn 1;\r\n}\r\nwhile (fgets(line, sizeof(line)-1, stdin)) {\r\nlino++;\r\nif ((c = strchr(line, '\n')))\r\n*c = 0;\r\nif (!line[0] || line[0] == '#')\r\ncontinue;\r\nif (line[0] == '\t') {\r\nswitch (mode) {\r\ncase 1:\r\nif (strlen(line) > 5 && line[5] == ' ') {\r\nc = line + 5;\r\nwhile (*c == ' ')\r\n*c++ = 0;\r\nif (manuf_len + strlen(c) + 1 > MAX_NAME_SIZE) {\r\nbra = strchr(c, '[');\r\nif (bra && bra > c && bra[-1] == ' ')\r\nbra[-1] = 0;\r\nif (manuf_len + strlen(c) + 1 > MAX_NAME_SIZE) {\r\nfprintf(stderr, "Line %d: Product name too long\n", lino);\r\nreturn 1;\r\n}\r\n}\r\nfprintf(devf, "\tPRODUCT(%s,%s,\"", manuf, line+1);\r\npq(devf, c);\r\nfputs("\")\n", devf);\r\n} else goto err;\r\nbreak;\r\ndefault:\r\ngoto err;\r\n}\r\n} else if (strlen(line) > 4 && line[4] == ' ') {\r\nc = line + 4;\r\nwhile (*c == ' ')\r\n*c++ = 0;\r\nif (manufs)\r\nfputs("ENDMANUF()\n\n", devf);\r\nmanufs++;\r\nstrcpy(manuf, line);\r\nmanuf_len = strlen(c);\r\nif (manuf_len + 24 > MAX_NAME_SIZE) {\r\nfprintf(stderr, "Line %d: manufacturer name too long\n", lino);\r\nreturn 1;\r\n}\r\nfprintf(devf, "MANUF(%s,\"", manuf);\r\npq(devf, c);\r\nfputs("\")\n", devf);\r\nmode = 1;\r\n} else {\r\nerr:\r\nfprintf(stderr, "Line %d: Syntax error in mode %d: %s\n", lino, mode, line);\r\nreturn 1;\r\n}\r\n}\r\nfputs("ENDMANUF()\n\\r\n\n\\r\n#undef MANUF\n\\r\n#undef PRODUCT\n\\r\n#undef ENDMANUF\n", devf);\r\nfclose(devf);\r\nreturn 0;\r\n}

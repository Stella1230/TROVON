void nmi_trigger_all_cpu_backtrace(bool include_self,\r\nvoid (*raise)(cpumask_t *mask))\r\n{\r\nint i, this_cpu = get_cpu();\r\nif (test_and_set_bit(0, &backtrace_flag)) {\r\nput_cpu();\r\nreturn;\r\n}\r\ncpumask_copy(to_cpumask(backtrace_mask), cpu_online_mask);\r\nif (!include_self)\r\ncpumask_clear_cpu(this_cpu, to_cpumask(backtrace_mask));\r\nif (!cpumask_empty(to_cpumask(backtrace_mask))) {\r\npr_info("Sending NMI to %s CPUs:\n",\r\n(include_self ? "all" : "other"));\r\nraise(to_cpumask(backtrace_mask));\r\n}\r\nfor (i = 0; i < 10 * 1000; i++) {\r\nif (cpumask_empty(to_cpumask(backtrace_mask)))\r\nbreak;\r\nmdelay(1);\r\ntouch_softlockup_watchdog();\r\n}\r\nprintk_nmi_flush();\r\nclear_bit_unlock(0, &backtrace_flag);\r\nput_cpu();\r\n}\r\nbool nmi_cpu_backtrace(struct pt_regs *regs)\r\n{\r\nint cpu = smp_processor_id();\r\nif (cpumask_test_cpu(cpu, to_cpumask(backtrace_mask))) {\r\npr_warn("NMI backtrace for cpu %d\n", cpu);\r\nif (regs)\r\nshow_regs(regs);\r\nelse\r\ndump_stack();\r\ncpumask_clear_cpu(cpu, to_cpumask(backtrace_mask));\r\nreturn true;\r\n}\r\nreturn false;\r\n}

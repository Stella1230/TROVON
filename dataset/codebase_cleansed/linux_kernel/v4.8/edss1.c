char *strisdnevent(ushort ev)\r\n{\r\nstruct isdn_event_desc *entry;\r\nfor (entry = isdn_event_table; entry->ev; entry++)\r\nif (entry->ev == ev)\r\nbreak;\r\nreturn entry->desc;\r\n}\r\nstatic void pcbit_fsm_timer(unsigned long data)\r\n{\r\nstruct pcbit_dev *dev;\r\nstruct pcbit_chan *chan;\r\nchan = (struct pcbit_chan *) data;\r\ndel_timer(&chan->fsm_timer);\r\nchan->fsm_timer.function = NULL;\r\ndev = chan2dev(chan);\r\nif (!dev) {\r\nprintk(KERN_WARNING "pcbit: timer for unknown device\n");\r\nreturn;\r\n}\r\npcbit_fsm_event(dev, chan, EV_TIMER, NULL);\r\n}\r\nvoid pcbit_fsm_event(struct pcbit_dev *dev, struct pcbit_chan *chan,\r\nunsigned short event, struct callb_data *data)\r\n{\r\nstruct fsm_entry *action;\r\nstruct fsm_timer_entry *tentry;\r\nunsigned long flags;\r\nspin_lock_irqsave(&dev->lock, flags);\r\nfor (action = fsm_table; action->init != 0xff; action++)\r\nif (action->init == chan->fsm_state && action->event == event)\r\nbreak;\r\nif (action->init == 0xff) {\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nprintk(KERN_DEBUG "fsm error: event %x on state %x\n",\r\nevent, chan->fsm_state);\r\nreturn;\r\n}\r\nif (chan->fsm_timer.function) {\r\ndel_timer(&chan->fsm_timer);\r\nchan->fsm_timer.function = NULL;\r\n}\r\nchan->fsm_state = action->final;\r\npcbit_state_change(dev, chan, action->init, event, action->final);\r\nfor (tentry = fsm_timers; tentry->init != 0xff; tentry++)\r\nif (tentry->init == chan->fsm_state)\r\nbreak;\r\nif (tentry->init != 0xff) {\r\ninit_timer(&chan->fsm_timer);\r\nchan->fsm_timer.function = &pcbit_fsm_timer;\r\nchan->fsm_timer.data = (ulong) chan;\r\nchan->fsm_timer.expires = jiffies + tentry->timeout * HZ;\r\nadd_timer(&chan->fsm_timer);\r\n}\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nif (action->callb)\r\naction->callb(dev, chan, data);\r\n}

ssize_t vivid_radio_rx_read(struct file *file, char __user *buf,\r\nsize_t size, loff_t *offset)\r\n{\r\nstruct vivid_dev *dev = video_drvdata(file);\r\nstruct timespec ts;\r\nstruct v4l2_rds_data *data = dev->rds_gen.data;\r\nbool use_alternates;\r\nunsigned blk;\r\nint perc;\r\nint i;\r\nif (dev->radio_rx_rds_controls)\r\nreturn -EINVAL;\r\nif (size < sizeof(*data))\r\nreturn 0;\r\nsize = sizeof(*data) * (size / sizeof(*data));\r\nif (mutex_lock_interruptible(&dev->mutex))\r\nreturn -ERESTARTSYS;\r\nif (dev->radio_rx_rds_owner &&\r\nfile->private_data != dev->radio_rx_rds_owner) {\r\nmutex_unlock(&dev->mutex);\r\nreturn -EBUSY;\r\n}\r\nif (dev->radio_rx_rds_owner == NULL) {\r\nvivid_radio_rds_init(dev);\r\ndev->radio_rx_rds_owner = file->private_data;\r\n}\r\nretry:\r\nktime_get_ts(&ts);\r\nuse_alternates = ts.tv_sec % 10 >= 5;\r\nif (dev->radio_rx_rds_last_block == 0 ||\r\ndev->radio_rx_rds_use_alternates != use_alternates) {\r\ndev->radio_rx_rds_use_alternates = use_alternates;\r\nvivid_radio_rds_init(dev);\r\n}\r\nts = timespec_sub(ts, dev->radio_rds_init_ts);\r\nblk = ts.tv_sec * 100 + ts.tv_nsec / 10000000;\r\nblk = (blk * VIVID_RDS_GEN_BLOCKS) / 500;\r\nif (blk >= dev->radio_rx_rds_last_block + VIVID_RDS_GEN_BLOCKS)\r\ndev->radio_rx_rds_last_block = blk - VIVID_RDS_GEN_BLOCKS + 1;\r\nif (blk == dev->radio_rx_rds_last_block || !dev->radio_rx_rds_enabled ||\r\n(dev->radio_rds_loop && !(dev->radio_tx_subchans & V4L2_TUNER_SUB_RDS)) ||\r\nabs(dev->radio_rx_sig_qual) > 200) {\r\nmutex_unlock(&dev->mutex);\r\nif (file->f_flags & O_NONBLOCK)\r\nreturn -EWOULDBLOCK;\r\nif (msleep_interruptible(20) && signal_pending(current))\r\nreturn -EINTR;\r\nif (mutex_lock_interruptible(&dev->mutex))\r\nreturn -ERESTARTSYS;\r\ngoto retry;\r\n}\r\nperc = abs(dev->radio_rx_sig_qual) / 4;\r\nfor (i = 0; i < size && blk > dev->radio_rx_rds_last_block;\r\ndev->radio_rx_rds_last_block++) {\r\nunsigned data_blk = dev->radio_rx_rds_last_block % VIVID_RDS_GEN_BLOCKS;\r\nstruct v4l2_rds_data rds = data[data_blk];\r\nif (data_blk == 0 && dev->radio_rds_loop)\r\nvivid_radio_rds_init(dev);\r\nif (perc && prandom_u32_max(100) < perc) {\r\nswitch (prandom_u32_max(4)) {\r\ncase 0:\r\nrds.block |= V4L2_RDS_BLOCK_CORRECTED;\r\nbreak;\r\ncase 1:\r\nrds.block |= V4L2_RDS_BLOCK_INVALID;\r\nbreak;\r\ncase 2:\r\nrds.block |= V4L2_RDS_BLOCK_ERROR;\r\nrds.lsb = prandom_u32_max(256);\r\nrds.msb = prandom_u32_max(256);\r\nbreak;\r\ncase 3:\r\nif (i)\r\ncontinue;\r\nbreak;\r\n}\r\n}\r\nif (copy_to_user(buf + i, &rds, sizeof(rds))) {\r\ni = -EFAULT;\r\nbreak;\r\n}\r\ni += sizeof(rds);\r\n}\r\nmutex_unlock(&dev->mutex);\r\nreturn i;\r\n}\r\nunsigned int vivid_radio_rx_poll(struct file *file, struct poll_table_struct *wait)\r\n{\r\nreturn POLLIN | POLLRDNORM | v4l2_ctrl_poll(file, wait);\r\n}\r\nint vivid_radio_rx_enum_freq_bands(struct file *file, void *fh, struct v4l2_frequency_band *band)\r\n{\r\nif (band->tuner != 0)\r\nreturn -EINVAL;\r\nif (band->index >= TOT_BANDS)\r\nreturn -EINVAL;\r\n*band = vivid_radio_bands[band->index];\r\nreturn 0;\r\n}\r\nint vivid_radio_rx_s_hw_freq_seek(struct file *file, void *fh, const struct v4l2_hw_freq_seek *a)\r\n{\r\nstruct vivid_dev *dev = video_drvdata(file);\r\nunsigned low, high;\r\nunsigned freq;\r\nunsigned spacing;\r\nunsigned band;\r\nif (a->tuner)\r\nreturn -EINVAL;\r\nif (a->wrap_around && dev->radio_rx_hw_seek_mode == VIVID_HW_SEEK_BOUNDED)\r\nreturn -EINVAL;\r\nif (!a->wrap_around && dev->radio_rx_hw_seek_mode == VIVID_HW_SEEK_WRAP)\r\nreturn -EINVAL;\r\nif (!a->rangelow ^ !a->rangehigh)\r\nreturn -EINVAL;\r\nif (file->f_flags & O_NONBLOCK)\r\nreturn -EWOULDBLOCK;\r\nif (a->rangelow) {\r\nfor (band = 0; band < TOT_BANDS; band++)\r\nif (a->rangelow >= vivid_radio_bands[band].rangelow &&\r\na->rangehigh <= vivid_radio_bands[band].rangehigh)\r\nbreak;\r\nif (band == TOT_BANDS)\r\nreturn -EINVAL;\r\nif (!dev->radio_rx_hw_seek_prog_lim &&\r\n(a->rangelow != vivid_radio_bands[band].rangelow ||\r\na->rangehigh != vivid_radio_bands[band].rangehigh))\r\nreturn -EINVAL;\r\nlow = a->rangelow;\r\nhigh = a->rangehigh;\r\n} else {\r\nfor (band = 0; band < TOT_BANDS; band++)\r\nif (dev->radio_rx_freq >= vivid_radio_bands[band].rangelow &&\r\ndev->radio_rx_freq <= vivid_radio_bands[band].rangehigh)\r\nbreak;\r\nif (band == TOT_BANDS)\r\nreturn -EINVAL;\r\nlow = vivid_radio_bands[band].rangelow;\r\nhigh = vivid_radio_bands[band].rangehigh;\r\n}\r\nspacing = band == BAND_AM ? 1600 : 16000;\r\nfreq = clamp(dev->radio_rx_freq, low, high);\r\nif (a->seek_upward) {\r\nfreq = spacing * (freq / spacing) + spacing;\r\nif (freq > high) {\r\nif (!a->wrap_around)\r\nreturn -ENODATA;\r\nfreq = spacing * (low / spacing) + spacing;\r\nif (freq >= dev->radio_rx_freq)\r\nreturn -ENODATA;\r\n}\r\n} else {\r\nfreq = spacing * ((freq + spacing - 1) / spacing) - spacing;\r\nif (freq < low) {\r\nif (!a->wrap_around)\r\nreturn -ENODATA;\r\nfreq = spacing * ((high + spacing - 1) / spacing) - spacing;\r\nif (freq <= dev->radio_rx_freq)\r\nreturn -ENODATA;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint vivid_radio_rx_g_tuner(struct file *file, void *fh, struct v4l2_tuner *vt)\r\n{\r\nstruct vivid_dev *dev = video_drvdata(file);\r\nint delta = 800;\r\nint sig_qual;\r\nif (vt->index > 0)\r\nreturn -EINVAL;\r\nstrlcpy(vt->name, "AM/FM/SW Receiver", sizeof(vt->name));\r\nvt->capability = V4L2_TUNER_CAP_LOW | V4L2_TUNER_CAP_STEREO |\r\nV4L2_TUNER_CAP_FREQ_BANDS | V4L2_TUNER_CAP_RDS |\r\n(dev->radio_rx_rds_controls ?\r\nV4L2_TUNER_CAP_RDS_CONTROLS :\r\nV4L2_TUNER_CAP_RDS_BLOCK_IO) |\r\n(dev->radio_rx_hw_seek_prog_lim ?\r\nV4L2_TUNER_CAP_HWSEEK_PROG_LIM : 0);\r\nswitch (dev->radio_rx_hw_seek_mode) {\r\ncase VIVID_HW_SEEK_BOUNDED:\r\nvt->capability |= V4L2_TUNER_CAP_HWSEEK_BOUNDED;\r\nbreak;\r\ncase VIVID_HW_SEEK_WRAP:\r\nvt->capability |= V4L2_TUNER_CAP_HWSEEK_WRAP;\r\nbreak;\r\ncase VIVID_HW_SEEK_BOTH:\r\nvt->capability |= V4L2_TUNER_CAP_HWSEEK_WRAP |\r\nV4L2_TUNER_CAP_HWSEEK_BOUNDED;\r\nbreak;\r\n}\r\nvt->rangelow = AM_FREQ_RANGE_LOW;\r\nvt->rangehigh = FM_FREQ_RANGE_HIGH;\r\nsig_qual = dev->radio_rx_sig_qual;\r\nvt->signal = abs(sig_qual) > delta ? 0 :\r\n0xffff - (abs(sig_qual) * 0xffff) / delta;\r\nvt->afc = sig_qual > delta ? 0 : sig_qual;\r\nif (abs(sig_qual) > delta)\r\nvt->rxsubchans = 0;\r\nelse if (dev->radio_rx_freq < FM_FREQ_RANGE_LOW || vt->signal < 0x8000)\r\nvt->rxsubchans = V4L2_TUNER_SUB_MONO;\r\nelse if (dev->radio_rds_loop && !(dev->radio_tx_subchans & V4L2_TUNER_SUB_STEREO))\r\nvt->rxsubchans = V4L2_TUNER_SUB_MONO;\r\nelse\r\nvt->rxsubchans = V4L2_TUNER_SUB_STEREO;\r\nif (dev->radio_rx_rds_enabled &&\r\n(!dev->radio_rds_loop || (dev->radio_tx_subchans & V4L2_TUNER_SUB_RDS)) &&\r\ndev->radio_rx_freq >= FM_FREQ_RANGE_LOW && vt->signal >= 0xc000)\r\nvt->rxsubchans |= V4L2_TUNER_SUB_RDS;\r\nif (dev->radio_rx_rds_controls)\r\nvivid_radio_rds_init(dev);\r\nvt->audmode = dev->radio_rx_audmode;\r\nreturn 0;\r\n}\r\nint vivid_radio_rx_s_tuner(struct file *file, void *fh, const struct v4l2_tuner *vt)\r\n{\r\nstruct vivid_dev *dev = video_drvdata(file);\r\nif (vt->index)\r\nreturn -EINVAL;\r\ndev->radio_rx_audmode = vt->audmode >= V4L2_TUNER_MODE_STEREO;\r\nreturn 0;\r\n}

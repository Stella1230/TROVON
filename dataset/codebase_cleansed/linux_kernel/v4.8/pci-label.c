static size_t find_smbios_instance_string(struct pci_dev *pdev, char *buf,\r\nenum smbios_attr_enum attribute)\r\n{\r\nconst struct dmi_device *dmi;\r\nstruct dmi_dev_onboard *donboard;\r\nint bus;\r\nint devfn;\r\nbus = pdev->bus->number;\r\ndevfn = pdev->devfn;\r\ndmi = NULL;\r\nwhile ((dmi = dmi_find_device(DMI_DEV_TYPE_DEV_ONBOARD,\r\nNULL, dmi)) != NULL) {\r\ndonboard = dmi->device_data;\r\nif (donboard && donboard->bus == bus &&\r\ndonboard->devfn == devfn) {\r\nif (buf) {\r\nif (attribute == SMBIOS_ATTR_INSTANCE_SHOW)\r\nreturn scnprintf(buf, PAGE_SIZE,\r\n"%d\n",\r\ndonboard->instance);\r\nelse if (attribute == SMBIOS_ATTR_LABEL_SHOW)\r\nreturn scnprintf(buf, PAGE_SIZE,\r\n"%s\n",\r\ndmi->name);\r\n}\r\nreturn strlen(dmi->name);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic umode_t smbios_instance_string_exist(struct kobject *kobj,\r\nstruct attribute *attr, int n)\r\n{\r\nstruct device *dev;\r\nstruct pci_dev *pdev;\r\ndev = kobj_to_dev(kobj);\r\npdev = to_pci_dev(dev);\r\nreturn find_smbios_instance_string(pdev, NULL, SMBIOS_ATTR_NONE) ?\r\nS_IRUGO : 0;\r\n}\r\nstatic ssize_t smbioslabel_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct pci_dev *pdev;\r\npdev = to_pci_dev(dev);\r\nreturn find_smbios_instance_string(pdev, buf,\r\nSMBIOS_ATTR_LABEL_SHOW);\r\n}\r\nstatic ssize_t smbiosinstance_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct pci_dev *pdev;\r\npdev = to_pci_dev(dev);\r\nreturn find_smbios_instance_string(pdev, buf,\r\nSMBIOS_ATTR_INSTANCE_SHOW);\r\n}\r\nstatic int pci_create_smbiosname_file(struct pci_dev *pdev)\r\n{\r\nreturn sysfs_create_group(&pdev->dev.kobj, &smbios_attr_group);\r\n}\r\nstatic void pci_remove_smbiosname_file(struct pci_dev *pdev)\r\n{\r\nsysfs_remove_group(&pdev->dev.kobj, &smbios_attr_group);\r\n}\r\nstatic inline int pci_create_smbiosname_file(struct pci_dev *pdev)\r\n{\r\nreturn -1;\r\n}\r\nstatic inline void pci_remove_smbiosname_file(struct pci_dev *pdev)\r\n{\r\n}\r\nstatic void dsm_label_utf16s_to_utf8s(union acpi_object *obj, char *buf)\r\n{\r\nint len;\r\nlen = utf16s_to_utf8s((const wchar_t *)obj->buffer.pointer,\r\nobj->buffer.length,\r\nUTF16_LITTLE_ENDIAN,\r\nbuf, PAGE_SIZE);\r\nbuf[len] = '\n';\r\n}\r\nstatic int dsm_get_label(struct device *dev, char *buf,\r\nenum acpi_attr_enum attr)\r\n{\r\nacpi_handle handle;\r\nunion acpi_object *obj, *tmp;\r\nint len = -1;\r\nhandle = ACPI_HANDLE(dev);\r\nif (!handle)\r\nreturn -1;\r\nobj = acpi_evaluate_dsm(handle, pci_acpi_dsm_uuid, 0x2,\r\nDEVICE_LABEL_DSM, NULL);\r\nif (!obj)\r\nreturn -1;\r\ntmp = obj->package.elements;\r\nif (obj->type == ACPI_TYPE_PACKAGE && obj->package.count == 2 &&\r\ntmp[0].type == ACPI_TYPE_INTEGER &&\r\n(tmp[1].type == ACPI_TYPE_STRING ||\r\ntmp[1].type == ACPI_TYPE_BUFFER)) {\r\nif (attr == ACPI_ATTR_INDEX_SHOW) {\r\nscnprintf(buf, PAGE_SIZE, "%llu\n", tmp->integer.value);\r\n} else if (attr == ACPI_ATTR_LABEL_SHOW) {\r\nif (tmp[1].type == ACPI_TYPE_STRING)\r\nscnprintf(buf, PAGE_SIZE, "%s\n",\r\ntmp[1].string.pointer);\r\nelse if (tmp[1].type == ACPI_TYPE_BUFFER)\r\ndsm_label_utf16s_to_utf8s(tmp + 1, buf);\r\n}\r\nlen = strlen(buf) > 0 ? strlen(buf) : -1;\r\n}\r\nACPI_FREE(obj);\r\nreturn len;\r\n}\r\nstatic bool device_has_dsm(struct device *dev)\r\n{\r\nacpi_handle handle;\r\nhandle = ACPI_HANDLE(dev);\r\nif (!handle)\r\nreturn false;\r\nreturn !!acpi_check_dsm(handle, pci_acpi_dsm_uuid, 0x2,\r\n1 << DEVICE_LABEL_DSM);\r\n}\r\nstatic umode_t acpi_index_string_exist(struct kobject *kobj,\r\nstruct attribute *attr, int n)\r\n{\r\nstruct device *dev;\r\ndev = kobj_to_dev(kobj);\r\nif (device_has_dsm(dev))\r\nreturn S_IRUGO;\r\nreturn 0;\r\n}\r\nstatic ssize_t acpilabel_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn dsm_get_label(dev, buf, ACPI_ATTR_LABEL_SHOW);\r\n}\r\nstatic ssize_t acpiindex_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn dsm_get_label(dev, buf, ACPI_ATTR_INDEX_SHOW);\r\n}\r\nstatic int pci_create_acpi_index_label_files(struct pci_dev *pdev)\r\n{\r\nreturn sysfs_create_group(&pdev->dev.kobj, &acpi_attr_group);\r\n}\r\nstatic int pci_remove_acpi_index_label_files(struct pci_dev *pdev)\r\n{\r\nsysfs_remove_group(&pdev->dev.kobj, &acpi_attr_group);\r\nreturn 0;\r\n}\r\nstatic inline int pci_create_acpi_index_label_files(struct pci_dev *pdev)\r\n{\r\nreturn -1;\r\n}\r\nstatic inline int pci_remove_acpi_index_label_files(struct pci_dev *pdev)\r\n{\r\nreturn -1;\r\n}\r\nstatic inline bool device_has_dsm(struct device *dev)\r\n{\r\nreturn false;\r\n}\r\nvoid pci_create_firmware_label_files(struct pci_dev *pdev)\r\n{\r\nif (device_has_dsm(&pdev->dev))\r\npci_create_acpi_index_label_files(pdev);\r\nelse\r\npci_create_smbiosname_file(pdev);\r\n}\r\nvoid pci_remove_firmware_label_files(struct pci_dev *pdev)\r\n{\r\nif (device_has_dsm(&pdev->dev))\r\npci_remove_acpi_index_label_files(pdev);\r\nelse\r\npci_remove_smbiosname_file(pdev);\r\n}

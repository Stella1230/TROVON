static void\r\nout_byte_rtc(unsigned int reg_addr, unsigned char x)\r\n{\r\noutw(0x0001,(unsigned long)PLD_RTCRSTODT);\r\noutw(((x<<8)|(reg_addr&0xff)),(unsigned long)PLD_RTCWRDATA);\r\noutw(0x0002,(unsigned long)PLD_RTCCR);\r\nwhile(inw((unsigned long)PLD_RTCCR));\r\noutw(0x0000,(unsigned long)PLD_RTCRSTODT);\r\n}\r\nstatic unsigned char\r\nin_byte_rtc(unsigned int reg_addr)\r\n{\r\nunsigned char retval;\r\noutw(0x0001,(unsigned long)PLD_RTCRSTODT);\r\noutw((reg_addr&0xff),(unsigned long)PLD_RTCRDDATA);\r\noutw(0x0001,(unsigned long)PLD_RTCCR);\r\nwhile(inw((unsigned long)PLD_RTCCR));\r\nretval=(inw((unsigned long)PLD_RTCRDDATA) & 0xff00)>>8;\r\noutw(0x0000,(unsigned long)PLD_RTCRSTODT);\r\nreturn retval;\r\n}\r\nstatic void\r\nds1302_wenable(void)\r\n{\r\nout_byte_rtc(0x8e,0x00);\r\n}\r\nstatic void\r\nds1302_wdisable(void)\r\n{\r\nout_byte_rtc(0x8e,0x80);\r\n}\r\nunsigned char\r\nds1302_readreg(int reg)\r\n{\r\nunsigned char x;\r\nx=in_byte_rtc((0x81 | (reg << 1)));\r\nreturn x;\r\n}\r\nvoid\r\nds1302_writereg(int reg, unsigned char val)\r\n{\r\nds1302_wenable();\r\nout_byte_rtc((0x80 | (reg << 1)),val);\r\nds1302_wdisable();\r\n}\r\nvoid\r\nget_rtc_time(struct rtc_time *rtc_tm)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nrtc_tm->tm_sec = CMOS_READ(RTC_SECONDS);\r\nrtc_tm->tm_min = CMOS_READ(RTC_MINUTES);\r\nrtc_tm->tm_hour = CMOS_READ(RTC_HOURS);\r\nrtc_tm->tm_mday = CMOS_READ(RTC_DAY_OF_MONTH);\r\nrtc_tm->tm_mon = CMOS_READ(RTC_MONTH);\r\nrtc_tm->tm_year = CMOS_READ(RTC_YEAR);\r\nlocal_irq_restore(flags);\r\nrtc_tm->tm_sec = bcd2bin(rtc_tm->tm_sec);\r\nrtc_tm->tm_min = bcd2bin(rtc_tm->tm_min);\r\nrtc_tm->tm_hour = bcd2bin(rtc_tm->tm_hour);\r\nrtc_tm->tm_mday = bcd2bin(rtc_tm->tm_mday);\r\nrtc_tm->tm_mon = bcd2bin(rtc_tm->tm_mon);\r\nrtc_tm->tm_year = bcd2bin(rtc_tm->tm_year);\r\nif (rtc_tm->tm_year <= 69)\r\nrtc_tm->tm_year += 100;\r\nrtc_tm->tm_mon--;\r\n}\r\nstatic long rtc_ioctl(struct file *file, unsigned int cmd, unsigned long arg)\r\n{\r\nunsigned long flags;\r\nswitch(cmd) {\r\ncase RTC_RD_TIME:\r\n{\r\nstruct rtc_time rtc_tm;\r\nmemset(&rtc_tm, 0, sizeof (struct rtc_time));\r\nmutex_lock(&rtc_mutex);\r\nget_rtc_time(&rtc_tm);\r\nmutex_unlock(&rtc_mutex);\r\nif (copy_to_user((struct rtc_time*)arg, &rtc_tm, sizeof(struct rtc_time)))\r\nreturn -EFAULT;\r\nreturn 0;\r\n}\r\ncase RTC_SET_TIME:\r\n{\r\nstruct rtc_time rtc_tm;\r\nunsigned char mon, day, hrs, min, sec, leap_yr;\r\nunsigned int yrs;\r\nif (!capable(CAP_SYS_TIME))\r\nreturn -EPERM;\r\nif (copy_from_user(&rtc_tm, (struct rtc_time*)arg, sizeof(struct rtc_time)))\r\nreturn -EFAULT;\r\nyrs = rtc_tm.tm_year + 1900;\r\nmon = rtc_tm.tm_mon + 1;\r\nday = rtc_tm.tm_mday;\r\nhrs = rtc_tm.tm_hour;\r\nmin = rtc_tm.tm_min;\r\nsec = rtc_tm.tm_sec;\r\nif ((yrs < 1970) || (yrs > 2069))\r\nreturn -EINVAL;\r\nleap_yr = ((!(yrs % 4) && (yrs % 100)) || !(yrs % 400));\r\nif ((mon > 12) || (day == 0))\r\nreturn -EINVAL;\r\nif (day > (days_in_mo[mon] + ((mon == 2) && leap_yr)))\r\nreturn -EINVAL;\r\nif ((hrs >= 24) || (min >= 60) || (sec >= 60))\r\nreturn -EINVAL;\r\nif (yrs >= 2000)\r\nyrs -= 2000;\r\nelse\r\nyrs -= 1900;\r\nsec = bin2bcd(sec);\r\nmin = bin2bcd(min);\r\nhrs = bin2bcd(hrs);\r\nday = bin2bcd(day);\r\nmon = bin2bcd(mon);\r\nyrs = bin2bcd(yrs);\r\nmutex_lock(&rtc_mutex);\r\nlocal_irq_save(flags);\r\nCMOS_WRITE(yrs, RTC_YEAR);\r\nCMOS_WRITE(mon, RTC_MONTH);\r\nCMOS_WRITE(day, RTC_DAY_OF_MONTH);\r\nCMOS_WRITE(hrs, RTC_HOURS);\r\nCMOS_WRITE(min, RTC_MINUTES);\r\nCMOS_WRITE(sec, RTC_SECONDS);\r\nlocal_irq_restore(flags);\r\nmutex_unlock(&rtc_mutex);\r\nreturn 0;\r\n}\r\ncase RTC_SET_CHARGE:\r\n{\r\nint tcs_val;\r\nif (!capable(CAP_SYS_TIME))\r\nreturn -EPERM;\r\nif(copy_from_user(&tcs_val, (int*)arg, sizeof(int)))\r\nreturn -EFAULT;\r\nmutex_lock(&rtc_mutex);\r\ntcs_val = RTC_TCR_PATTERN | (tcs_val & 0x0F);\r\nds1302_writereg(RTC_TRICKLECHARGER, tcs_val);\r\nmutex_unlock(&rtc_mutex);\r\nreturn 0;\r\n}\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nint\r\nget_rtc_status(char *buf)\r\n{\r\nchar *p;\r\nstruct rtc_time tm;\r\np = buf;\r\nget_rtc_time(&tm);\r\np += sprintf(p,\r\n"rtc_time\t: %02d:%02d:%02d\n"\r\n"rtc_date\t: %04d-%02d-%02d\n",\r\ntm.tm_hour, tm.tm_min, tm.tm_sec,\r\ntm.tm_year + 1900, tm.tm_mon + 1, tm.tm_mday);\r\nreturn p - buf;\r\n}\r\nstatic int __init\r\nds1302_probe(void)\r\n{\r\nint retval, res, baur;\r\nbaur=(boot_cpu_data.bus_clock/(2*1000*1000));\r\nprintk("%s: Set PLD_RTCBAUR = %d\n", ds1302_name,baur);\r\noutw(0x0000,(unsigned long)PLD_RTCCR);\r\noutw(0x0000,(unsigned long)PLD_RTCRSTODT);\r\noutw(baur,(unsigned long)PLD_RTCBAUR);\r\nds1302_wenable();\r\nout_byte_rtc(0xc0,MAGIC_PATTERN);\r\nif((res = in_byte_rtc(0xc1)) == MAGIC_PATTERN) {\r\nchar buf[100];\r\nds1302_wdisable();\r\nprintk("%s: RTC found.\n", ds1302_name);\r\nget_rtc_status(buf);\r\nprintk(buf);\r\nretval = 1;\r\n} else {\r\nprintk("%s: RTC not found.\n", ds1302_name);\r\nretval = 0;\r\n}\r\nreturn retval;\r\n}\r\nint __init\r\nds1302_init(void)\r\n{\r\nif (!ds1302_probe()) {\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init ds1302_register(void)\r\n{\r\nds1302_init();\r\nif (register_chrdev(RTC_MAJOR_NR, ds1302_name, &rtc_fops)) {\r\nprintk(KERN_INFO "%s: unable to get major %d for rtc\n",\r\nds1302_name, RTC_MAJOR_NR);\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}

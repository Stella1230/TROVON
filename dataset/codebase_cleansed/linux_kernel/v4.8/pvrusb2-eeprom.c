static u8 *pvr2_eeprom_fetch(struct pvr2_hdw *hdw)\r\n{\r\nstruct i2c_msg msg[2];\r\nu8 *eeprom;\r\nu8 iadd[2];\r\nu8 addr;\r\nu16 eepromSize;\r\nunsigned int offs;\r\nint ret;\r\nint mode16 = 0;\r\nunsigned pcnt,tcnt;\r\neeprom = kmalloc(EEPROM_SIZE,GFP_KERNEL);\r\nif (!eeprom) {\r\npvr2_trace(PVR2_TRACE_ERROR_LEGS,\r\n"Failed to allocate memory"\r\n" required to read eeprom");\r\nreturn NULL;\r\n}\r\ntrace_eeprom("Value for eeprom addr from controller was 0x%x",\r\nhdw->eeprom_addr);\r\naddr = hdw->eeprom_addr;\r\nif (addr & 0x80) addr >>= 1;\r\nmode16 = (addr & 1);\r\neepromSize = (mode16 ? 4096 : 256);\r\ntrace_eeprom("Examining %d byte eeprom at location 0x%x"\r\n" using %d bit addressing",eepromSize,addr,\r\nmode16 ? 16 : 8);\r\nmsg[0].addr = addr;\r\nmsg[0].flags = 0;\r\nmsg[0].len = mode16 ? 2 : 1;\r\nmsg[0].buf = iadd;\r\nmsg[1].addr = addr;\r\nmsg[1].flags = I2C_M_RD;\r\nmemset(eeprom,0,EEPROM_SIZE);\r\nfor (tcnt = 0; tcnt < EEPROM_SIZE; tcnt += pcnt) {\r\npcnt = 16;\r\nif (pcnt + tcnt > EEPROM_SIZE) pcnt = EEPROM_SIZE-tcnt;\r\noffs = tcnt + (eepromSize - EEPROM_SIZE);\r\nif (mode16) {\r\niadd[0] = offs >> 8;\r\niadd[1] = offs;\r\n} else {\r\niadd[0] = offs;\r\n}\r\nmsg[1].len = pcnt;\r\nmsg[1].buf = eeprom+tcnt;\r\nif ((ret = i2c_transfer(&hdw->i2c_adap,\r\nmsg,ARRAY_SIZE(msg))) != 2) {\r\npvr2_trace(PVR2_TRACE_ERROR_LEGS,\r\n"eeprom fetch set offs err=%d",ret);\r\nkfree(eeprom);\r\nreturn NULL;\r\n}\r\n}\r\nreturn eeprom;\r\n}\r\nint pvr2_eeprom_analyze(struct pvr2_hdw *hdw)\r\n{\r\nu8 *eeprom;\r\nstruct tveeprom tvdata;\r\nmemset(&tvdata,0,sizeof(tvdata));\r\neeprom = pvr2_eeprom_fetch(hdw);\r\nif (!eeprom) return -EINVAL;\r\n{\r\nstruct i2c_client fake_client;\r\nfake_client.addr = hdw->eeprom_addr;\r\nfake_client.adapter = &hdw->i2c_adap;\r\ntveeprom_hauppauge_analog(&fake_client,&tvdata,eeprom);\r\n}\r\ntrace_eeprom("eeprom assumed v4l tveeprom module");\r\ntrace_eeprom("eeprom direct call results:");\r\ntrace_eeprom("has_radio=%d",tvdata.has_radio);\r\ntrace_eeprom("tuner_type=%d",tvdata.tuner_type);\r\ntrace_eeprom("tuner_formats=0x%x",tvdata.tuner_formats);\r\ntrace_eeprom("audio_processor=%d",tvdata.audio_processor);\r\ntrace_eeprom("model=%d",tvdata.model);\r\ntrace_eeprom("revision=%d",tvdata.revision);\r\ntrace_eeprom("serial_number=%d",tvdata.serial_number);\r\ntrace_eeprom("rev_str=%s",tvdata.rev_str);\r\nhdw->tuner_type = tvdata.tuner_type;\r\nhdw->tuner_updated = !0;\r\nhdw->serial_number = tvdata.serial_number;\r\nhdw->std_mask_eeprom = tvdata.tuner_formats;\r\nkfree(eeprom);\r\nreturn 0;\r\n}

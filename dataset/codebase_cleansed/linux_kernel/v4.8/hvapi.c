static struct api_info *__get_info(unsigned long group)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(api_table); i++) {\r\nif (api_table[i].group == group)\r\nreturn &api_table[i];\r\n}\r\nreturn NULL;\r\n}\r\nstatic void __get_ref(struct api_info *p)\r\n{\r\np->refcnt++;\r\n}\r\nstatic void __put_ref(struct api_info *p)\r\n{\r\nif (--p->refcnt == 0) {\r\nunsigned long ignore;\r\nsun4v_set_version(p->group, 0, 0, &ignore);\r\np->major = p->minor = 0;\r\n}\r\n}\r\nint sun4v_hvapi_register(unsigned long group, unsigned long major,\r\nunsigned long *minor)\r\n{\r\nstruct api_info *p;\r\nunsigned long flags;\r\nint ret;\r\nspin_lock_irqsave(&hvapi_lock, flags);\r\np = __get_info(group);\r\nret = -EINVAL;\r\nif (p) {\r\nif (p->refcnt) {\r\nret = -EINVAL;\r\nif (p->major == major) {\r\n*minor = p->minor;\r\nret = 0;\r\n}\r\n} else {\r\nunsigned long actual_minor;\r\nunsigned long hv_ret;\r\nhv_ret = sun4v_set_version(group, major, *minor,\r\n&actual_minor);\r\nret = -EINVAL;\r\nif (hv_ret == HV_EOK) {\r\n*minor = actual_minor;\r\np->major = major;\r\np->minor = actual_minor;\r\nret = 0;\r\n} else if (hv_ret == HV_EBADTRAP ||\r\nhv_ret == HV_ENOTSUPPORTED) {\r\nif (p->flags & FLAG_PRE_API) {\r\nif (major == 1) {\r\np->major = 1;\r\np->minor = 0;\r\n*minor = 0;\r\nret = 0;\r\n}\r\n}\r\n}\r\n}\r\nif (ret == 0)\r\n__get_ref(p);\r\n}\r\nspin_unlock_irqrestore(&hvapi_lock, flags);\r\nreturn ret;\r\n}\r\nvoid sun4v_hvapi_unregister(unsigned long group)\r\n{\r\nstruct api_info *p;\r\nunsigned long flags;\r\nspin_lock_irqsave(&hvapi_lock, flags);\r\np = __get_info(group);\r\nif (p)\r\n__put_ref(p);\r\nspin_unlock_irqrestore(&hvapi_lock, flags);\r\n}\r\nint sun4v_hvapi_get(unsigned long group,\r\nunsigned long *major,\r\nunsigned long *minor)\r\n{\r\nstruct api_info *p;\r\nunsigned long flags;\r\nint ret;\r\nspin_lock_irqsave(&hvapi_lock, flags);\r\nret = -EINVAL;\r\np = __get_info(group);\r\nif (p && p->refcnt) {\r\n*major = p->major;\r\n*minor = p->minor;\r\nret = 0;\r\n}\r\nspin_unlock_irqrestore(&hvapi_lock, flags);\r\nreturn ret;\r\n}\r\nvoid __init sun4v_hvapi_init(void)\r\n{\r\nunsigned long group, major, minor;\r\ngroup = HV_GRP_SUN4V;\r\nmajor = 1;\r\nminor = 0;\r\nif (sun4v_hvapi_register(group, major, &minor))\r\ngoto bad;\r\ngroup = HV_GRP_CORE;\r\nmajor = 1;\r\nminor = 1;\r\nif (sun4v_hvapi_register(group, major, &minor))\r\ngoto bad;\r\nreturn;\r\nbad:\r\nprom_printf("HVAPI: Cannot register API group "\r\n"%lx with major(%lu) minor(%lu)\n",\r\ngroup, major, minor);\r\nprom_halt();\r\n}

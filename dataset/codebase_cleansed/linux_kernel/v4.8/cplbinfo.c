static void cplbinfo_print_header(struct seq_file *m)\r\n{\r\nseq_printf(m, "Index\tAddress\t\tData\tSize\tU/RD\tU/WR\tS/WR\tSwitch\n");\r\n}\r\nstatic int cplbinfo_nomore(struct cplbinfo_data *cdata)\r\n{\r\nreturn cdata->pos >= MAX_CPLBS;\r\n}\r\nstatic int cplbinfo_show(struct seq_file *m, void *p)\r\n{\r\nstruct cplbinfo_data *cdata;\r\nunsigned long data, addr;\r\nloff_t pos;\r\ncdata = p;\r\npos = cdata->pos;\r\naddr = cdata->tbl[pos].addr;\r\ndata = cdata->tbl[pos].data;\r\nseq_printf(m,\r\n"%d\t0x%08lx\t%05lx\t%s\t%c\t%c\t%c\t%c\n",\r\n(int)pos, addr, data, strpage(data),\r\n(data & CPLB_USER_RD) ? 'Y' : 'N',\r\n(data & CPLB_USER_WR) ? 'Y' : 'N',\r\n(data & CPLB_SUPV_WR) ? 'Y' : 'N',\r\npos < cdata->switched ? 'N' : 'Y');\r\nreturn 0;\r\n}\r\nstatic void cplbinfo_seq_init(struct cplbinfo_data *cdata, unsigned int cpu)\r\n{\r\nif (cdata->cplb_type == 'I') {\r\ncdata->mem_control = bfin_read_IMEM_CONTROL();\r\ncdata->tbl = icplb_tbl[cpu];\r\ncdata->switched = first_switched_icplb;\r\n} else {\r\ncdata->mem_control = bfin_read_DMEM_CONTROL();\r\ncdata->tbl = dcplb_tbl[cpu];\r\ncdata->switched = first_switched_dcplb;\r\n}\r\n}\r\nstatic void *cplbinfo_start(struct seq_file *m, loff_t *pos)\r\n{\r\nstruct cplbinfo_data *cdata = m->private;\r\nif (!*pos) {\r\nseq_printf(m, "%cCPLBs are %sabled: 0x%x\n", cdata->cplb_type,\r\n(cdata->mem_control & ENDCPLB ? "en" : "dis"),\r\ncdata->mem_control);\r\ncplbinfo_print_header(m);\r\n} else if (cplbinfo_nomore(cdata))\r\nreturn NULL;\r\nget_cpu();\r\nreturn cdata;\r\n}\r\nstatic void *cplbinfo_next(struct seq_file *m, void *p, loff_t *pos)\r\n{\r\nstruct cplbinfo_data *cdata = p;\r\ncdata->pos = ++(*pos);\r\nif (cplbinfo_nomore(cdata))\r\nreturn NULL;\r\nelse\r\nreturn cdata;\r\n}\r\nstatic void cplbinfo_stop(struct seq_file *m, void *p)\r\n{\r\nput_cpu();\r\n}\r\nstatic int cplbinfo_open(struct inode *inode, struct file *file)\r\n{\r\nchar cplb_type;\r\nunsigned int cpu = (unsigned long)PDE_DATA(file_inode(file));\r\nint ret;\r\nstruct seq_file *m;\r\nstruct cplbinfo_data *cdata;\r\ncplb_type = cpu & CPLBINFO_DCPLB_FLAG ? 'D' : 'I';\r\ncpu &= ~CPLBINFO_DCPLB_FLAG;\r\nif (!cpu_online(cpu))\r\nreturn -ENODEV;\r\nret = seq_open_private(file, &cplbinfo_sops, sizeof(*cdata));\r\nif (ret)\r\nreturn ret;\r\nm = file->private_data;\r\ncdata = m->private;\r\ncdata->pos = 0;\r\ncdata->cplb_type = cplb_type;\r\ncplbinfo_seq_init(cdata, cpu);\r\nreturn 0;\r\n}\r\nstatic int __init cplbinfo_init(void)\r\n{\r\nstruct proc_dir_entry *cplb_dir, *cpu_dir;\r\nchar buf[10];\r\nunsigned int cpu;\r\ncplb_dir = proc_mkdir("cplbinfo", NULL);\r\nif (!cplb_dir)\r\nreturn -ENOMEM;\r\nfor_each_possible_cpu(cpu) {\r\nsprintf(buf, "cpu%i", cpu);\r\ncpu_dir = proc_mkdir(buf, cplb_dir);\r\nif (!cpu_dir)\r\nreturn -ENOMEM;\r\nproc_create_data("icplb", S_IRUGO, cpu_dir, &cplbinfo_fops,\r\n(void *)cpu);\r\nproc_create_data("dcplb", S_IRUGO, cpu_dir, &cplbinfo_fops,\r\n(void *)(cpu | CPLBINFO_DCPLB_FLAG));\r\n}\r\nreturn 0;\r\n}

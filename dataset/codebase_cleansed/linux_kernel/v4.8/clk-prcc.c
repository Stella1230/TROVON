static int clk_prcc_pclk_enable(struct clk_hw *hw)\r\n{\r\nstruct clk_prcc *clk = to_clk_prcc(hw);\r\nwritel(clk->cg_sel, (clk->base + PRCC_PCKEN));\r\nwhile (!(readl(clk->base + PRCC_PCKSR) & clk->cg_sel))\r\ncpu_relax();\r\nclk->is_enabled = 1;\r\nreturn 0;\r\n}\r\nstatic void clk_prcc_pclk_disable(struct clk_hw *hw)\r\n{\r\nstruct clk_prcc *clk = to_clk_prcc(hw);\r\nwritel(clk->cg_sel, (clk->base + PRCC_PCKDIS));\r\nclk->is_enabled = 0;\r\n}\r\nstatic int clk_prcc_kclk_enable(struct clk_hw *hw)\r\n{\r\nstruct clk_prcc *clk = to_clk_prcc(hw);\r\nwritel(clk->cg_sel, (clk->base + PRCC_KCKEN));\r\nwhile (!(readl(clk->base + PRCC_KCKSR) & clk->cg_sel))\r\ncpu_relax();\r\nclk->is_enabled = 1;\r\nreturn 0;\r\n}\r\nstatic void clk_prcc_kclk_disable(struct clk_hw *hw)\r\n{\r\nstruct clk_prcc *clk = to_clk_prcc(hw);\r\nwritel(clk->cg_sel, (clk->base + PRCC_KCKDIS));\r\nclk->is_enabled = 0;\r\n}\r\nstatic int clk_prcc_is_enabled(struct clk_hw *hw)\r\n{\r\nstruct clk_prcc *clk = to_clk_prcc(hw);\r\nreturn clk->is_enabled;\r\n}\r\nstatic struct clk *clk_reg_prcc(const char *name,\r\nconst char *parent_name,\r\nresource_size_t phy_base,\r\nu32 cg_sel,\r\nunsigned long flags,\r\nstruct clk_ops *clk_prcc_ops)\r\n{\r\nstruct clk_prcc *clk;\r\nstruct clk_init_data clk_prcc_init;\r\nstruct clk *clk_reg;\r\nif (!name) {\r\npr_err("clk_prcc: %s invalid arguments passed\n", __func__);\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nclk = kzalloc(sizeof(struct clk_prcc), GFP_KERNEL);\r\nif (!clk) {\r\npr_err("clk_prcc: %s could not allocate clk\n", __func__);\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nclk->base = ioremap(phy_base, SZ_4K);\r\nif (!clk->base)\r\ngoto free_clk;\r\nclk->cg_sel = cg_sel;\r\nclk->is_enabled = 1;\r\nclk_prcc_init.name = name;\r\nclk_prcc_init.ops = clk_prcc_ops;\r\nclk_prcc_init.flags = flags;\r\nclk_prcc_init.parent_names = (parent_name ? &parent_name : NULL);\r\nclk_prcc_init.num_parents = (parent_name ? 1 : 0);\r\nclk->hw.init = &clk_prcc_init;\r\nclk_reg = clk_register(NULL, &clk->hw);\r\nif (IS_ERR_OR_NULL(clk_reg))\r\ngoto unmap_clk;\r\nreturn clk_reg;\r\nunmap_clk:\r\niounmap(clk->base);\r\nfree_clk:\r\nkfree(clk);\r\npr_err("clk_prcc: %s failed to register clk\n", __func__);\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nstruct clk *clk_reg_prcc_pclk(const char *name,\r\nconst char *parent_name,\r\nresource_size_t phy_base,\r\nu32 cg_sel,\r\nunsigned long flags)\r\n{\r\nreturn clk_reg_prcc(name, parent_name, phy_base, cg_sel, flags,\r\n&clk_prcc_pclk_ops);\r\n}\r\nstruct clk *clk_reg_prcc_kclk(const char *name,\r\nconst char *parent_name,\r\nresource_size_t phy_base,\r\nu32 cg_sel,\r\nunsigned long flags)\r\n{\r\nreturn clk_reg_prcc(name, parent_name, phy_base, cg_sel, flags,\r\n&clk_prcc_kclk_ops);\r\n}

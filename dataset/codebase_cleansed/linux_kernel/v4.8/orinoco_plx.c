static int orinoco_plx_cor_reset(struct orinoco_private *priv)\r\n{\r\nstruct hermes *hw = &priv->hw;\r\nstruct orinoco_pci_card *card = priv->card;\r\nunsigned long timeout;\r\nu16 reg;\r\niowrite8(COR_VALUE | COR_RESET, card->attr_io + COR_OFFSET);\r\nmdelay(1);\r\niowrite8(COR_VALUE, card->attr_io + COR_OFFSET);\r\nmdelay(1);\r\ntimeout = jiffies + msecs_to_jiffies(PLX_RESET_TIME);\r\nreg = hermes_read_regn(hw, CMD);\r\nwhile (time_before(jiffies, timeout) && (reg & HERMES_CMD_BUSY)) {\r\nmdelay(1);\r\nreg = hermes_read_regn(hw, CMD);\r\n}\r\nif (reg & HERMES_CMD_BUSY) {\r\nprintk(KERN_ERR PFX "Busy timeout\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nreturn 0;\r\n}\r\nstatic int orinoco_plx_hw_init(struct orinoco_pci_card *card)\r\n{\r\nint i;\r\nu32 csr_reg;\r\nstatic const u8 cis_magic[] = {\r\n0x01, 0x03, 0x00, 0x00, 0xff, 0x17, 0x04, 0x67\r\n};\r\nprintk(KERN_DEBUG PFX "CIS: ");\r\nfor (i = 0; i < 16; i++)\r\nprintk("%02X:", ioread8(card->attr_io + (i << 1)));\r\nprintk("\n");\r\nfor (i = 0; i < sizeof(cis_magic); i++) {\r\nif (cis_magic[i] != ioread8(card->attr_io + (i << 1))) {\r\nprintk(KERN_ERR PFX "The CIS value of Prism2 PC "\r\n"card is unexpected\n");\r\nreturn -ENODEV;\r\n}\r\n}\r\ncsr_reg = ioread32(card->bridge_io + PLX_INTCSR);\r\nif (!(csr_reg & PLX_INTCSR_INTEN)) {\r\ncsr_reg |= PLX_INTCSR_INTEN;\r\niowrite32(csr_reg, card->bridge_io + PLX_INTCSR);\r\ncsr_reg = ioread32(card->bridge_io + PLX_INTCSR);\r\nif (!(csr_reg & PLX_INTCSR_INTEN)) {\r\nprintk(KERN_ERR PFX "Cannot enable interrupts\n");\r\nreturn -EIO;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int orinoco_plx_init_one(struct pci_dev *pdev,\r\nconst struct pci_device_id *ent)\r\n{\r\nint err;\r\nstruct orinoco_private *priv;\r\nstruct orinoco_pci_card *card;\r\nvoid __iomem *hermes_io, *attr_io, *bridge_io;\r\nerr = pci_enable_device(pdev);\r\nif (err) {\r\nprintk(KERN_ERR PFX "Cannot enable PCI device\n");\r\nreturn err;\r\n}\r\nerr = pci_request_regions(pdev, DRIVER_NAME);\r\nif (err) {\r\nprintk(KERN_ERR PFX "Cannot obtain PCI resources\n");\r\ngoto fail_resources;\r\n}\r\nbridge_io = pci_iomap(pdev, 1, 0);\r\nif (!bridge_io) {\r\nprintk(KERN_ERR PFX "Cannot map bridge registers\n");\r\nerr = -EIO;\r\ngoto fail_map_bridge;\r\n}\r\nattr_io = pci_iomap(pdev, 2, 0);\r\nif (!attr_io) {\r\nprintk(KERN_ERR PFX "Cannot map PCMCIA attributes\n");\r\nerr = -EIO;\r\ngoto fail_map_attr;\r\n}\r\nhermes_io = pci_iomap(pdev, 3, 0);\r\nif (!hermes_io) {\r\nprintk(KERN_ERR PFX "Cannot map chipset registers\n");\r\nerr = -EIO;\r\ngoto fail_map_hermes;\r\n}\r\npriv = alloc_orinocodev(sizeof(*card), &pdev->dev,\r\norinoco_plx_cor_reset, NULL);\r\nif (!priv) {\r\nprintk(KERN_ERR PFX "Cannot allocate network device\n");\r\nerr = -ENOMEM;\r\ngoto fail_alloc;\r\n}\r\ncard = priv->card;\r\ncard->bridge_io = bridge_io;\r\ncard->attr_io = attr_io;\r\nhermes_struct_init(&priv->hw, hermes_io, HERMES_16BIT_REGSPACING);\r\nerr = request_irq(pdev->irq, orinoco_interrupt, IRQF_SHARED,\r\nDRIVER_NAME, priv);\r\nif (err) {\r\nprintk(KERN_ERR PFX "Cannot allocate IRQ %d\n", pdev->irq);\r\nerr = -EBUSY;\r\ngoto fail_irq;\r\n}\r\nerr = orinoco_plx_hw_init(card);\r\nif (err) {\r\nprintk(KERN_ERR PFX "Hardware initialization failed\n");\r\ngoto fail;\r\n}\r\nerr = orinoco_plx_cor_reset(priv);\r\nif (err) {\r\nprintk(KERN_ERR PFX "Initial reset failed\n");\r\ngoto fail;\r\n}\r\nerr = orinoco_init(priv);\r\nif (err) {\r\nprintk(KERN_ERR PFX "orinoco_init() failed\n");\r\ngoto fail;\r\n}\r\nerr = orinoco_if_add(priv, 0, 0, NULL);\r\nif (err) {\r\nprintk(KERN_ERR PFX "orinoco_if_add() failed\n");\r\ngoto fail_wiphy;\r\n}\r\npci_set_drvdata(pdev, priv);\r\nreturn 0;\r\nfail_wiphy:\r\nwiphy_unregister(priv_to_wiphy(priv));\r\nfail:\r\nfree_irq(pdev->irq, priv);\r\nfail_irq:\r\nfree_orinocodev(priv);\r\nfail_alloc:\r\npci_iounmap(pdev, hermes_io);\r\nfail_map_hermes:\r\npci_iounmap(pdev, attr_io);\r\nfail_map_attr:\r\npci_iounmap(pdev, bridge_io);\r\nfail_map_bridge:\r\npci_release_regions(pdev);\r\nfail_resources:\r\npci_disable_device(pdev);\r\nreturn err;\r\n}\r\nstatic void orinoco_plx_remove_one(struct pci_dev *pdev)\r\n{\r\nstruct orinoco_private *priv = pci_get_drvdata(pdev);\r\nstruct orinoco_pci_card *card = priv->card;\r\norinoco_if_del(priv);\r\nwiphy_unregister(priv_to_wiphy(priv));\r\nfree_irq(pdev->irq, priv);\r\nfree_orinocodev(priv);\r\npci_iounmap(pdev, priv->hw.iobase);\r\npci_iounmap(pdev, card->attr_io);\r\npci_iounmap(pdev, card->bridge_io);\r\npci_release_regions(pdev);\r\npci_disable_device(pdev);\r\n}\r\nstatic int __init orinoco_plx_init(void)\r\n{\r\nprintk(KERN_DEBUG "%s\n", version);\r\nreturn pci_register_driver(&orinoco_plx_driver);\r\n}\r\nstatic void __exit orinoco_plx_exit(void)\r\n{\r\npci_unregister_driver(&orinoco_plx_driver);\r\n}

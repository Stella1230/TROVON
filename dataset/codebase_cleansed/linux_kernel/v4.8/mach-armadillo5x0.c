static int usbotg_init(struct platform_device *pdev)\r\n{\r\nint err;\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_DATA0, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_DATA1, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_DATA2, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_DATA3, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_DATA4, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_DATA5, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_DATA6, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_DATA7, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_CLK, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_DIR, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_NXT, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_STP, USB_PAD_CFG);\r\nerr = gpio_request(OTG_RESET, "USB-OTG-RESET");\r\nif (err) {\r\npr_err("Failed to request the usb otg reset gpio\n");\r\nreturn err;\r\n}\r\nerr = gpio_direction_output(OTG_RESET, 1);\r\nif (err) {\r\npr_err("Failed to reset the usb otg phy\n");\r\ngoto otg_free_reset;\r\n}\r\ngpio_set_value(OTG_RESET, 0);\r\nmdelay(5);\r\ngpio_set_value(OTG_RESET, 1);\r\nmdelay(10);\r\nreturn mx31_initialize_usb_hw(pdev->id, MXC_EHCI_POWER_PINS_ENABLED |\r\nMXC_EHCI_INTERFACE_DIFF_UNI);\r\notg_free_reset:\r\ngpio_free(OTG_RESET);\r\nreturn err;\r\n}\r\nstatic int usbh2_init(struct platform_device *pdev)\r\n{\r\nint err;\r\nmxc_iomux_set_pad(MX31_PIN_USBH2_CLK, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBH2_DIR, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBH2_NXT, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBH2_STP, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBH2_DATA0, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBH2_DATA1, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_SRXD6, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_STXD6, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_SFS3, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_SCK3, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_SRXD3, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_STXD3, USB_PAD_CFG);\r\nmxc_iomux_set_gpr(MUX_PGP_UH2, true);\r\nerr = gpio_request(USBH2_CS, "USB-H2-CS");\r\nif (err) {\r\npr_err("Failed to request the usb host 2 CS gpio\n");\r\nreturn err;\r\n}\r\nerr = gpio_direction_output(USBH2_CS, 0);\r\nif (err) {\r\npr_err("Failed to drive the usb host 2 CS gpio\n");\r\ngoto h2_free_cs;\r\n}\r\nerr = gpio_request(USBH2_RESET, "USB-H2-RESET");\r\nif (err) {\r\npr_err("Failed to request the usb host 2 reset gpio\n");\r\ngoto h2_free_cs;\r\n}\r\nerr = gpio_direction_output(USBH2_RESET, 1);\r\nif (err) {\r\npr_err("Failed to reset the usb host 2 phy\n");\r\ngoto h2_free_reset;\r\n}\r\ngpio_set_value(USBH2_RESET, 0);\r\nmdelay(5);\r\ngpio_set_value(USBH2_RESET, 1);\r\nmdelay(10);\r\nreturn mx31_initialize_usb_hw(pdev->id, MXC_EHCI_POWER_PINS_ENABLED |\r\nMXC_EHCI_INTERFACE_DIFF_UNI);\r\nh2_free_reset:\r\ngpio_free(USBH2_RESET);\r\nh2_free_cs:\r\ngpio_free(USBH2_CS);\r\nreturn err;\r\n}\r\nstatic int armadillo5x0_sdhc1_get_ro(struct device *dev)\r\n{\r\nreturn gpio_get_value(IOMUX_TO_GPIO(MX31_PIN_ATA_RESET_B));\r\n}\r\nstatic int armadillo5x0_sdhc1_init(struct device *dev,\r\nirq_handler_t detect_irq, void *data)\r\n{\r\nint ret;\r\nint gpio_det, gpio_wp;\r\ngpio_det = IOMUX_TO_GPIO(MX31_PIN_ATA_DMACK);\r\ngpio_wp = IOMUX_TO_GPIO(MX31_PIN_ATA_RESET_B);\r\nret = gpio_request(gpio_det, "sdhc-card-detect");\r\nif (ret)\r\nreturn ret;\r\ngpio_direction_input(gpio_det);\r\nret = gpio_request(gpio_wp, "sdhc-write-protect");\r\nif (ret)\r\ngoto err_gpio_free;\r\ngpio_direction_input(gpio_wp);\r\nret = request_irq(gpio_to_irq(IOMUX_TO_GPIO(MX31_PIN_ATA_DMACK)),\r\ndetect_irq, IRQF_TRIGGER_FALLING,\r\n"sdhc-detect", data);\r\nif (ret)\r\ngoto err_gpio_free_2;\r\nreturn 0;\r\nerr_gpio_free_2:\r\ngpio_free(gpio_wp);\r\nerr_gpio_free:\r\ngpio_free(gpio_det);\r\nreturn ret;\r\n}\r\nstatic void armadillo5x0_sdhc1_exit(struct device *dev, void *data)\r\n{\r\nfree_irq(gpio_to_irq(IOMUX_TO_GPIO(MX31_PIN_ATA_DMACK)), data);\r\ngpio_free(IOMUX_TO_GPIO(MX31_PIN_ATA_DMACK));\r\ngpio_free(IOMUX_TO_GPIO(MX31_PIN_ATA_RESET_B));\r\n}\r\nstatic void __init armadillo5x0_init(void)\r\n{\r\nimx31_soc_init();\r\nmxc_iomux_setup_multiple_pins(armadillo5x0_pins,\r\nARRAY_SIZE(armadillo5x0_pins), "armadillo5x0");\r\nregulator_register_fixed(0, dummy_supplies, ARRAY_SIZE(dummy_supplies));\r\narmadillo5x0_smc911x_resources[1].start =\r\ngpio_to_irq(IOMUX_TO_GPIO(MX31_PIN_GPIO1_0));\r\narmadillo5x0_smc911x_resources[1].end =\r\ngpio_to_irq(IOMUX_TO_GPIO(MX31_PIN_GPIO1_0));\r\nplatform_add_devices(devices, ARRAY_SIZE(devices));\r\nimx_add_gpio_keys(&armadillo5x0_button_data);\r\nimx31_add_imx_i2c1(NULL);\r\nimx31_add_imx_uart0(&uart_pdata);\r\nimx31_add_imx_uart1(&uart_pdata);\r\ngpio_direction_input(MX31_PIN_GPIO1_0);\r\nimx31_add_mxc_mmc(0, &sdhc_pdata);\r\nimx31_add_ipu_core();\r\nimx31_add_mx3_sdc_fb(&mx3fb_pdata);\r\nplatform_device_register_resndata(NULL, "physmap-flash", -1,\r\n&armadillo5x0_nor_flash_resource, 1,\r\n&armadillo5x0_nor_flash_pdata,\r\nsizeof(armadillo5x0_nor_flash_pdata));\r\nimx31_add_mxc_nand(&armadillo5x0_nand_board_info);\r\nimx_writel(imx_readl(mx3_ccm_base + MXC_CCM_RCSR) | (1 << 30),\r\nmx3_ccm_base + MXC_CCM_RCSR);\r\nif (gpio_request(ARMADILLO5X0_RTC_GPIO, "rtc") == 0) {\r\nif (gpio_direction_input(ARMADILLO5X0_RTC_GPIO) == 0)\r\narmadillo5x0_i2c_rtc.irq = gpio_to_irq(ARMADILLO5X0_RTC_GPIO);\r\nelse\r\ngpio_free(ARMADILLO5X0_RTC_GPIO);\r\n}\r\nif (armadillo5x0_i2c_rtc.irq == 0)\r\npr_warn("armadillo5x0_init: failed to get RTC IRQ\n");\r\ni2c_register_board_info(1, &armadillo5x0_i2c_rtc, 1);\r\nusbotg_pdata.otg = imx_otg_ulpi_create(ULPI_OTG_DRVVBUS |\r\nULPI_OTG_DRVVBUS_EXT);\r\nif (usbotg_pdata.otg)\r\nimx31_add_mxc_ehci_otg(&usbotg_pdata);\r\nusbh2_pdata.otg = imx_otg_ulpi_create(ULPI_OTG_DRVVBUS |\r\nULPI_OTG_DRVVBUS_EXT);\r\nif (usbh2_pdata.otg)\r\nimx31_add_mxc_ehci_hs(2, &usbh2_pdata);\r\n}\r\nstatic void __init armadillo5x0_timer_init(void)\r\n{\r\nmx31_clocks_init(26000000);\r\n}

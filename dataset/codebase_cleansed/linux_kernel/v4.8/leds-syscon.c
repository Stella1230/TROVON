static void syscon_led_set(struct led_classdev *led_cdev,\r\nenum led_brightness value)\r\n{\r\nstruct syscon_led *sled =\r\ncontainer_of(led_cdev, struct syscon_led, cdev);\r\nu32 val;\r\nint ret;\r\nif (value == LED_OFF) {\r\nval = 0;\r\nsled->state = false;\r\n} else {\r\nval = sled->mask;\r\nsled->state = true;\r\n}\r\nret = regmap_update_bits(sled->map, sled->offset, sled->mask, val);\r\nif (ret < 0)\r\ndev_err(sled->cdev.dev, "error updating LED status\n");\r\n}\r\nstatic int syscon_led_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *np = dev->of_node;\r\nstruct device *parent;\r\nstruct regmap *map;\r\nstruct syscon_led *sled;\r\nconst char *state;\r\nint ret;\r\nparent = dev->parent;\r\nif (!parent) {\r\ndev_err(dev, "no parent for syscon LED\n");\r\nreturn -ENODEV;\r\n}\r\nmap = syscon_node_to_regmap(parent->of_node);\r\nif (IS_ERR(map)) {\r\ndev_err(dev, "no regmap for syscon LED parent\n");\r\nreturn PTR_ERR(map);\r\n}\r\nsled = devm_kzalloc(dev, sizeof(*sled), GFP_KERNEL);\r\nif (!sled)\r\nreturn -ENOMEM;\r\nsled->map = map;\r\nif (of_property_read_u32(np, "offset", &sled->offset))\r\nreturn -EINVAL;\r\nif (of_property_read_u32(np, "mask", &sled->mask))\r\nreturn -EINVAL;\r\nsled->cdev.name =\r\nof_get_property(np, "label", NULL) ? : np->name;\r\nsled->cdev.default_trigger =\r\nof_get_property(np, "linux,default-trigger", NULL);\r\nstate = of_get_property(np, "default-state", NULL);\r\nif (state) {\r\nif (!strcmp(state, "keep")) {\r\nu32 val;\r\nret = regmap_read(map, sled->offset, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nsled->state = !!(val & sled->mask);\r\n} else if (!strcmp(state, "on")) {\r\nsled->state = true;\r\nret = regmap_update_bits(map, sled->offset,\r\nsled->mask,\r\nsled->mask);\r\nif (ret < 0)\r\nreturn ret;\r\n} else {\r\nsled->state = false;\r\nret = regmap_update_bits(map, sled->offset,\r\nsled->mask, 0);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\n}\r\nsled->cdev.brightness_set = syscon_led_set;\r\nret = led_classdev_register(dev, &sled->cdev);\r\nif (ret < 0)\r\nreturn ret;\r\nplatform_set_drvdata(pdev, sled);\r\ndev_info(dev, "registered LED %s\n", sled->cdev.name);\r\nreturn 0;\r\n}

int\r\ndbl_fmpyfadd(\r\ndbl_floating_point *src1ptr,\r\ndbl_floating_point *src2ptr,\r\ndbl_floating_point *src3ptr,\r\nunsigned int *status,\r\ndbl_floating_point *dstptr)\r\n{\r\nunsigned int opnd1p1, opnd1p2, opnd2p1, opnd2p2, opnd3p1, opnd3p2;\r\nregister unsigned int tmpresp1, tmpresp2, tmpresp3, tmpresp4;\r\nunsigned int rightp1, rightp2, rightp3, rightp4;\r\nunsigned int resultp1, resultp2 = 0, resultp3 = 0, resultp4 = 0;\r\nregister int mpy_exponent, add_exponent, count;\r\nboolean inexact = FALSE, is_tiny = FALSE;\r\nunsigned int signlessleft1, signlessright1, save;\r\nregister int result_exponent, diff_exponent;\r\nint sign_save, jumpsize;\r\nDbl_copyfromptr(src1ptr,opnd1p1,opnd1p2);\r\nDbl_copyfromptr(src2ptr,opnd2p1,opnd2p2);\r\nDbl_copyfromptr(src3ptr,opnd3p1,opnd3p2);\r\nif (Dbl_sign(opnd1p1) ^ Dbl_sign(opnd2p1))\r\nDbl_setnegativezerop1(resultp1);\r\nelse Dbl_setzerop1(resultp1);\r\nmpy_exponent = Dbl_exponent(opnd1p1) + Dbl_exponent(opnd2p1) - DBL_BIAS;\r\nif (Dbl_isinfinity_exponent(opnd1p1)) {\r\nif (Dbl_iszero_mantissa(opnd1p1,opnd1p2)) {\r\nif (Dbl_isnotnan(opnd2p1,opnd2p2) &&\r\nDbl_isnotnan(opnd3p1,opnd3p2)) {\r\nif (Dbl_iszero_exponentmantissa(opnd2p1,opnd2p2)) {\r\nif (Is_invalidtrap_enabled())\r\nreturn(OPC_2E_INVALIDEXCEPTION);\r\nSet_invalidflag();\r\nDbl_makequietnan(resultp1,resultp2);\r\nDbl_copytoptr(resultp1,resultp2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\nif (Dbl_isinfinity(opnd3p1,opnd3p2) &&\r\n(Dbl_sign(resultp1) ^ Dbl_sign(opnd3p1))) {\r\nif (Is_invalidtrap_enabled())\r\nreturn(OPC_2E_INVALIDEXCEPTION);\r\nSet_invalidflag();\r\nDbl_makequietnan(resultp1,resultp2);\r\nDbl_copytoptr(resultp1,resultp2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\nDbl_setinfinity_exponentmantissa(resultp1,resultp2);\r\nDbl_copytoptr(resultp1,resultp2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\n}\r\nelse {\r\nif (Dbl_isone_signaling(opnd1p1)) {\r\nif (Is_invalidtrap_enabled())\r\nreturn(OPC_2E_INVALIDEXCEPTION);\r\nSet_invalidflag();\r\nDbl_set_quiet(opnd1p1);\r\n}\r\nelse if (Dbl_is_signalingnan(opnd2p1)) {\r\nif (Is_invalidtrap_enabled())\r\nreturn(OPC_2E_INVALIDEXCEPTION);\r\nSet_invalidflag();\r\nDbl_set_quiet(opnd2p1);\r\nDbl_copytoptr(opnd2p1,opnd2p2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\nelse if (Dbl_is_signalingnan(opnd3p1)) {\r\nif (Is_invalidtrap_enabled())\r\nreturn(OPC_2E_INVALIDEXCEPTION);\r\nSet_invalidflag();\r\nDbl_set_quiet(opnd3p1);\r\nDbl_copytoptr(opnd3p1,opnd3p2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\nDbl_copytoptr(opnd1p1,opnd1p2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\n}\r\nif (Dbl_isinfinity_exponent(opnd2p1)) {\r\nif (Dbl_iszero_mantissa(opnd2p1,opnd2p2)) {\r\nif (Dbl_isnotnan(opnd3p1,opnd3p2)) {\r\nif (Dbl_iszero_exponentmantissa(opnd1p1,opnd1p2)) {\r\nif (Is_invalidtrap_enabled())\r\nreturn(OPC_2E_INVALIDEXCEPTION);\r\nSet_invalidflag();\r\nDbl_makequietnan(opnd2p1,opnd2p2);\r\nDbl_copytoptr(opnd2p1,opnd2p2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\nif (Dbl_isinfinity(opnd3p1,opnd3p2) &&\r\n(Dbl_sign(resultp1) ^ Dbl_sign(opnd3p1))) {\r\nif (Is_invalidtrap_enabled())\r\nreturn(OPC_2E_INVALIDEXCEPTION);\r\nSet_invalidflag();\r\nDbl_makequietnan(resultp1,resultp2);\r\nDbl_copytoptr(resultp1,resultp2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\nDbl_setinfinity_exponentmantissa(resultp1,resultp2);\r\nDbl_copytoptr(resultp1,resultp2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\n}\r\nelse {\r\nif (Dbl_isone_signaling(opnd2p1)) {\r\nif (Is_invalidtrap_enabled())\r\nreturn(OPC_2E_INVALIDEXCEPTION);\r\nSet_invalidflag();\r\nDbl_set_quiet(opnd2p1);\r\n}\r\nelse if (Dbl_is_signalingnan(opnd3p1)) {\r\nif (Is_invalidtrap_enabled())\r\nreturn(OPC_2E_INVALIDEXCEPTION);\r\nSet_invalidflag();\r\nDbl_set_quiet(opnd3p1);\r\nDbl_copytoptr(opnd3p1,opnd3p2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\nDbl_copytoptr(opnd2p1,opnd2p2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\n}\r\nif (Dbl_isinfinity_exponent(opnd3p1)) {\r\nif (Dbl_iszero_mantissa(opnd3p1,opnd3p2)) {\r\nDbl_copytoptr(opnd3p1,opnd3p2,dstptr);\r\nreturn(NOEXCEPTION);\r\n} else {\r\nif (Dbl_isone_signaling(opnd3p1)) {\r\nif (Is_invalidtrap_enabled())\r\nreturn(OPC_2E_INVALIDEXCEPTION);\r\nSet_invalidflag();\r\nDbl_set_quiet(opnd3p1);\r\n}\r\nDbl_copytoptr(opnd3p1,opnd3p2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\n}\r\nif (Dbl_isnotzero_exponent(opnd1p1)) {\r\nDbl_clear_signexponent_set_hidden(opnd1p1);\r\n}\r\nelse {\r\nif (Dbl_iszero_mantissa(opnd1p1,opnd1p2)) {\r\nif (Dbl_iszero_exponentmantissa(opnd3p1,opnd3p2)) {\r\nif (Is_rounding_mode(ROUNDMINUS)) {\r\nDbl_or_signs(opnd3p1,resultp1);\r\n} else {\r\nDbl_and_signs(opnd3p1,resultp1);\r\n}\r\n}\r\nelse if (Dbl_iszero_exponent(opnd3p1) &&\r\nIs_underflowtrap_enabled()) {\r\nsign_save = Dbl_signextendedsign(opnd3p1);\r\nresult_exponent = 0;\r\nDbl_leftshiftby1(opnd3p1,opnd3p2);\r\nDbl_normalize(opnd3p1,opnd3p2,result_exponent);\r\nDbl_set_sign(opnd3p1,sign_save);\r\nDbl_setwrapped_exponent(opnd3p1,result_exponent,\r\nunfl);\r\nDbl_copytoptr(opnd3p1,opnd3p2,dstptr);\r\nreturn(OPC_2E_UNDERFLOWEXCEPTION);\r\n}\r\nDbl_copytoptr(opnd3p1,opnd3p2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\nDbl_clear_signexponent(opnd1p1);\r\nDbl_leftshiftby1(opnd1p1,opnd1p2);\r\nDbl_normalize(opnd1p1,opnd1p2,mpy_exponent);\r\n}\r\nif (Dbl_isnotzero_exponent(opnd2p1)) {\r\nDbl_clear_signexponent_set_hidden(opnd2p1);\r\n}\r\nelse {\r\nif (Dbl_iszero_mantissa(opnd2p1,opnd2p2)) {\r\nif (Dbl_iszero_exponentmantissa(opnd3p1,opnd3p2)) {\r\nif (Is_rounding_mode(ROUNDMINUS)) {\r\nDbl_or_signs(opnd3p1,resultp1);\r\n} else {\r\nDbl_and_signs(opnd3p1,resultp1);\r\n}\r\n}\r\nelse if (Dbl_iszero_exponent(opnd3p1) &&\r\nIs_underflowtrap_enabled()) {\r\nsign_save = Dbl_signextendedsign(opnd3p1);\r\nresult_exponent = 0;\r\nDbl_leftshiftby1(opnd3p1,opnd3p2);\r\nDbl_normalize(opnd3p1,opnd3p2,result_exponent);\r\nDbl_set_sign(opnd3p1,sign_save);\r\nDbl_setwrapped_exponent(opnd3p1,result_exponent,\r\nunfl);\r\nDbl_copytoptr(opnd3p1,opnd3p2,dstptr);\r\nreturn(OPC_2E_UNDERFLOWEXCEPTION);\r\n}\r\nDbl_copytoptr(opnd3p1,opnd3p2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\nDbl_clear_signexponent(opnd2p1);\r\nDbl_leftshiftby1(opnd2p1,opnd2p2);\r\nDbl_normalize(opnd2p1,opnd2p2,mpy_exponent);\r\n}\r\nDblext_setzero(tmpresp1,tmpresp2,tmpresp3,tmpresp4);\r\nfor (count = DBL_P-1; count >= 0; count -= 4) {\r\nDblext_rightshiftby4(tmpresp1,tmpresp2,tmpresp3,tmpresp4);\r\nif (Dbit28p2(opnd1p2)) {\r\nFourword_add(tmpresp1, tmpresp2, tmpresp3, tmpresp4,\r\nopnd2p1<<3 | opnd2p2>>29, opnd2p2<<3, 0, 0);\r\n}\r\nif (Dbit29p2(opnd1p2)) {\r\nFourword_add(tmpresp1, tmpresp2, tmpresp3, tmpresp4,\r\nopnd2p1<<2 | opnd2p2>>30, opnd2p2<<2, 0, 0);\r\n}\r\nif (Dbit30p2(opnd1p2)) {\r\nFourword_add(tmpresp1, tmpresp2, tmpresp3, tmpresp4,\r\nopnd2p1<<1 | opnd2p2>>31, opnd2p2<<1, 0, 0);\r\n}\r\nif (Dbit31p2(opnd1p2)) {\r\nFourword_add(tmpresp1, tmpresp2, tmpresp3, tmpresp4,\r\nopnd2p1, opnd2p2, 0, 0);\r\n}\r\nDbl_rightshiftby4(opnd1p1,opnd1p2);\r\n}\r\nif (Is_dexthiddenoverflow(tmpresp1)) {\r\nmpy_exponent++;\r\nDblext_rightshiftby1(tmpresp1,tmpresp2,tmpresp3,tmpresp4);\r\n}\r\nDblext_set_sign(tmpresp1,Dbl_sign(resultp1));\r\nadd_exponent = Dbl_exponent(opnd3p1);\r\nif (add_exponent == 0) {\r\nif (Dbl_iszero_mantissa(opnd3p1,opnd3p2)) {\r\nresult_exponent = mpy_exponent;\r\nDblext_copy(tmpresp1,tmpresp2,tmpresp3,tmpresp4,\r\nresultp1,resultp2,resultp3,resultp4);\r\nsign_save = Dbl_signextendedsign(resultp1);\r\ngoto round;\r\n}\r\nsign_save = Dbl_signextendedsign(opnd3p1);\r\nDbl_clear_signexponent(opnd3p1);\r\nDbl_leftshiftby1(opnd3p1,opnd3p2);\r\nDbl_normalize(opnd3p1,opnd3p2,add_exponent);\r\nDbl_set_sign(opnd3p1,sign_save);\r\n} else {\r\nDbl_clear_exponent_set_hidden(opnd3p1);\r\n}\r\nDbl_copyto_dblext(opnd3p1,opnd3p2,rightp1,rightp2,rightp3,rightp4);\r\nDblext_xortointp1(tmpresp1,rightp1,save);\r\nDblext_copytoint_exponentmantissap1(tmpresp1,signlessleft1);\r\nDblext_copytoint_exponentmantissap1(rightp1,signlessright1);\r\nif (mpy_exponent < add_exponent || mpy_exponent == add_exponent &&\r\nDblext_ismagnitudeless(tmpresp2,rightp2,signlessleft1,signlessright1)){\r\nDblext_xorfromintp1(save,rightp1,rightp1);\r\nDblext_xorfromintp1(save,tmpresp1,tmpresp1);\r\nDblext_swap_lower(tmpresp2,tmpresp3,tmpresp4,\r\nrightp2,rightp3,rightp4);\r\ndiff_exponent = add_exponent - mpy_exponent;\r\nresult_exponent = add_exponent;\r\n} else {\r\ndiff_exponent = mpy_exponent - add_exponent;\r\nresult_exponent = mpy_exponent;\r\n}\r\nif (diff_exponent > DBLEXT_THRESHOLD) {\r\ndiff_exponent = DBLEXT_THRESHOLD;\r\n}\r\nDblext_clear_sign(rightp1);\r\nDblext_right_align(rightp1,rightp2,rightp3,rightp4,\r\ndiff_exponent);\r\nif ((int)save < 0) {\r\nDblext_subtract(tmpresp1,tmpresp2,tmpresp3,tmpresp4,\r\nrightp1,rightp2,rightp3,rightp4,\r\nresultp1,resultp2,resultp3,resultp4);\r\nsign_save = Dbl_signextendedsign(resultp1);\r\nif (Dbl_iszero_hidden(resultp1)) {\r\nDblext_leftshiftby1(resultp1,resultp2,resultp3,\r\nresultp4);\r\nif(Dblext_iszero(resultp1,resultp2,resultp3,resultp4)){\r\nif (Is_rounding_mode(ROUNDMINUS))\r\nDbl_setone_sign(resultp1);\r\nDbl_copytoptr(resultp1,resultp2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\nresult_exponent--;\r\nif (Dbl_isone_hidden(resultp1)) {\r\ngoto round;\r\n}\r\nwhile (Dbl_iszero_hiddenhigh7mantissa(resultp1)) {\r\nDblext_leftshiftby8(resultp1,resultp2,resultp3,resultp4);\r\nresult_exponent -= 8;\r\n}\r\nif (Dbl_iszero_hiddenhigh3mantissa(resultp1)) {\r\nDblext_leftshiftby4(resultp1,resultp2,resultp3,resultp4);\r\nresult_exponent -= 4;\r\n}\r\njumpsize = Dbl_hiddenhigh3mantissa(resultp1);\r\nif (jumpsize <= 7) switch(jumpsize) {\r\ncase 1:\r\nDblext_leftshiftby3(resultp1,resultp2,resultp3,\r\nresultp4);\r\nresult_exponent -= 3;\r\nbreak;\r\ncase 2:\r\ncase 3:\r\nDblext_leftshiftby2(resultp1,resultp2,resultp3,\r\nresultp4);\r\nresult_exponent -= 2;\r\nbreak;\r\ncase 4:\r\ncase 5:\r\ncase 6:\r\ncase 7:\r\nDblext_leftshiftby1(resultp1,resultp2,resultp3,\r\nresultp4);\r\nresult_exponent -= 1;\r\nbreak;\r\n}\r\n}\r\n}\r\nelse {\r\nDblext_addition(tmpresp1,tmpresp2,tmpresp3,tmpresp4,\r\nrightp1,rightp2,rightp3,rightp4,\r\nresultp1,resultp2,resultp3,resultp4);\r\nsign_save = Dbl_signextendedsign(resultp1);\r\nif (Dbl_isone_hiddenoverflow(resultp1)) {\r\nDblext_arithrightshiftby1(resultp1,resultp2,resultp3,\r\nresultp4);\r\nresult_exponent++;\r\n}\r\n}\r\nround:\r\nif (result_exponent <= 0 && !Is_underflowtrap_enabled()) {\r\nDblext_denormalize(resultp1,resultp2,resultp3,resultp4,\r\nresult_exponent,is_tiny);\r\n}\r\nDbl_set_sign(resultp1,sign_save);\r\nif (Dblext_isnotzero_mantissap3(resultp3) ||\r\nDblext_isnotzero_mantissap4(resultp4)) {\r\ninexact = TRUE;\r\nswitch(Rounding_mode()) {\r\ncase ROUNDNEAREST:\r\nif (Dblext_isone_highp3(resultp3)) {\r\nif (Dblext_isnotzero_low31p3(resultp3) ||\r\nDblext_isnotzero_mantissap4(resultp4) ||\r\nDblext_isone_lowp2(resultp2)) {\r\nDbl_increment(resultp1,resultp2);\r\n}\r\n}\r\nbreak;\r\ncase ROUNDPLUS:\r\nif (Dbl_iszero_sign(resultp1)) {\r\nDbl_increment(resultp1,resultp2);\r\n}\r\nbreak;\r\ncase ROUNDMINUS:\r\nif (Dbl_isone_sign(resultp1)) {\r\nDbl_increment(resultp1,resultp2);\r\n}\r\ncase ROUNDZERO:;\r\n}\r\nif (Dbl_isone_hiddenoverflow(resultp1)) result_exponent++;\r\n}\r\nif (result_exponent >= DBL_INFINITY_EXPONENT) {\r\nif (Is_overflowtrap_enabled()) {\r\nDbl_setwrapped_exponent(resultp1,result_exponent,ovfl);\r\nDbl_copytoptr(resultp1,resultp2,dstptr);\r\nif (inexact)\r\nif (Is_inexacttrap_enabled())\r\nreturn (OPC_2E_OVERFLOWEXCEPTION |\r\nOPC_2E_INEXACTEXCEPTION);\r\nelse Set_inexactflag();\r\nreturn (OPC_2E_OVERFLOWEXCEPTION);\r\n}\r\ninexact = TRUE;\r\nSet_overflowflag();\r\nDbl_setoverflow(resultp1,resultp2);\r\n} else if (result_exponent <= 0) {\r\nif (Is_underflowtrap_enabled()) {\r\nDbl_setwrapped_exponent(resultp1,result_exponent,unfl);\r\nDbl_copytoptr(resultp1,resultp2,dstptr);\r\nif (inexact)\r\nif (Is_inexacttrap_enabled())\r\nreturn (OPC_2E_UNDERFLOWEXCEPTION |\r\nOPC_2E_INEXACTEXCEPTION);\r\nelse Set_inexactflag();\r\nreturn(OPC_2E_UNDERFLOWEXCEPTION);\r\n}\r\nelse if (inexact && is_tiny) Set_underflowflag();\r\n}\r\nelse Dbl_set_exponent(resultp1,result_exponent);\r\nDbl_copytoptr(resultp1,resultp2,dstptr);\r\nif (inexact)\r\nif (Is_inexacttrap_enabled()) return(OPC_2E_INEXACTEXCEPTION);\r\nelse Set_inexactflag();\r\nreturn(NOEXCEPTION);\r\n}

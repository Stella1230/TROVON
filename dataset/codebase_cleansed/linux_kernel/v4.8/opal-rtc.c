static void opal_to_tm(u32 y_m_d, u64 h_m_s_ms, struct rtc_time *tm)\r\n{\r\ntm->tm_year = ((bcd2bin(y_m_d >> 24) * 100) +\r\nbcd2bin((y_m_d >> 16) & 0xff)) - 1900;\r\ntm->tm_mon = bcd2bin((y_m_d >> 8) & 0xff) - 1;\r\ntm->tm_mday = bcd2bin(y_m_d & 0xff);\r\ntm->tm_hour = bcd2bin((h_m_s_ms >> 56) & 0xff);\r\ntm->tm_min = bcd2bin((h_m_s_ms >> 48) & 0xff);\r\ntm->tm_sec = bcd2bin((h_m_s_ms >> 40) & 0xff);\r\ntm->tm_wday = -1;\r\n}\r\nunsigned long __init opal_get_boot_time(void)\r\n{\r\nstruct rtc_time tm;\r\nu32 y_m_d;\r\nu64 h_m_s_ms;\r\n__be32 __y_m_d;\r\n__be64 __h_m_s_ms;\r\nlong rc = OPAL_BUSY;\r\nif (!opal_check_token(OPAL_RTC_READ))\r\nreturn 0;\r\nwhile (rc == OPAL_BUSY || rc == OPAL_BUSY_EVENT) {\r\nrc = opal_rtc_read(&__y_m_d, &__h_m_s_ms);\r\nif (rc == OPAL_BUSY_EVENT)\r\nopal_poll_events(NULL);\r\nelse if (rc == OPAL_BUSY)\r\nmdelay(10);\r\n}\r\nif (rc != OPAL_SUCCESS)\r\nreturn 0;\r\ny_m_d = be32_to_cpu(__y_m_d);\r\nh_m_s_ms = be64_to_cpu(__h_m_s_ms);\r\nopal_to_tm(y_m_d, h_m_s_ms, &tm);\r\nreturn mktime(tm.tm_year + 1900, tm.tm_mon + 1, tm.tm_mday,\r\ntm.tm_hour, tm.tm_min, tm.tm_sec);\r\n}\r\nstatic __init int opal_time_init(void)\r\n{\r\nstruct platform_device *pdev;\r\nstruct device_node *rtc;\r\nrtc = of_find_node_by_path("/ibm,opal/rtc");\r\nif (rtc) {\r\npdev = of_platform_device_create(rtc, "opal-rtc", NULL);\r\nof_node_put(rtc);\r\n} else {\r\nif (opal_check_token(OPAL_RTC_READ) ||\r\nopal_check_token(OPAL_READ_TPO))\r\npdev = platform_device_register_simple("opal-rtc", -1,\r\nNULL, 0);\r\nelse\r\nreturn -ENODEV;\r\n}\r\nreturn PTR_ERR_OR_ZERO(pdev);\r\n}

irqreturn_t snd_gus_interrupt(int irq, void *dev_id)\r\n{\r\nstruct snd_gus_card * gus = dev_id;\r\nunsigned char status;\r\nint loop = 100;\r\nint handled = 0;\r\n__again:\r\nstatus = inb(gus->gf1.reg_irqstat);\r\nif (status == 0)\r\nreturn IRQ_RETVAL(handled);\r\nhandled = 1;\r\nif (status & 0x02) {\r\nSTAT_ADD(gus->gf1.interrupt_stat_midi_in);\r\nif (gus->gf1.interrupt_handler_midi_in)\r\ngus->gf1.interrupt_handler_midi_in(gus);\r\n}\r\nif (status & 0x01) {\r\nSTAT_ADD(gus->gf1.interrupt_stat_midi_out);\r\nif (gus->gf1.interrupt_handler_midi_out)\r\ngus->gf1.interrupt_handler_midi_out(gus);\r\n}\r\nif (status & (0x20 | 0x40)) {\r\nunsigned int already, _current_;\r\nunsigned char voice_status, voice;\r\nstruct snd_gus_voice *pvoice;\r\nalready = 0;\r\nwhile (((voice_status = snd_gf1_i_read8(gus, SNDRV_GF1_GB_VOICES_IRQ)) & 0xc0) != 0xc0) {\r\nvoice = voice_status & 0x1f;\r\n_current_ = 1 << voice;\r\nif (already & _current_)\r\ncontinue;\r\nalready |= _current_;\r\n#if 0\r\nprintk(KERN_DEBUG "voice = %i, voice_status = 0x%x, "\r\n"voice_verify = %i\n",\r\nvoice, voice_status, inb(GUSP(gus, GF1PAGE)));\r\n#endif\r\npvoice = &gus->gf1.voices[voice];\r\nif (pvoice->use) {\r\nif (!(voice_status & 0x80)) {\r\nSTAT_ADD(pvoice->interrupt_stat_wave);\r\npvoice->handler_wave(gus, pvoice);\r\n}\r\nif (!(voice_status & 0x40)) {\r\nSTAT_ADD(pvoice->interrupt_stat_volume);\r\npvoice->handler_volume(gus, pvoice);\r\n}\r\n} else {\r\nSTAT_ADD(gus->gf1.interrupt_stat_voice_lost);\r\nsnd_gf1_i_ctrl_stop(gus, SNDRV_GF1_VB_ADDRESS_CONTROL);\r\nsnd_gf1_i_ctrl_stop(gus, SNDRV_GF1_VB_VOLUME_CONTROL);\r\n}\r\n}\r\n}\r\nif (status & 0x04) {\r\nSTAT_ADD(gus->gf1.interrupt_stat_timer1);\r\nif (gus->gf1.interrupt_handler_timer1)\r\ngus->gf1.interrupt_handler_timer1(gus);\r\n}\r\nif (status & 0x08) {\r\nSTAT_ADD(gus->gf1.interrupt_stat_timer2);\r\nif (gus->gf1.interrupt_handler_timer2)\r\ngus->gf1.interrupt_handler_timer2(gus);\r\n}\r\nif (status & 0x80) {\r\nif (snd_gf1_i_look8(gus, SNDRV_GF1_GB_DRAM_DMA_CONTROL) & 0x40) {\r\nSTAT_ADD(gus->gf1.interrupt_stat_dma_write);\r\nif (gus->gf1.interrupt_handler_dma_write)\r\ngus->gf1.interrupt_handler_dma_write(gus);\r\n}\r\nif (snd_gf1_i_look8(gus, SNDRV_GF1_GB_REC_DMA_CONTROL) & 0x40) {\r\nSTAT_ADD(gus->gf1.interrupt_stat_dma_read);\r\nif (gus->gf1.interrupt_handler_dma_read)\r\ngus->gf1.interrupt_handler_dma_read(gus);\r\n}\r\n}\r\nif (--loop > 0)\r\ngoto __again;\r\nreturn IRQ_NONE;\r\n}\r\nstatic void snd_gus_irq_info_read(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nstruct snd_gus_card *gus;\r\nstruct snd_gus_voice *pvoice;\r\nint idx;\r\ngus = entry->private_data;\r\nsnd_iprintf(buffer, "midi out = %u\n", gus->gf1.interrupt_stat_midi_out);\r\nsnd_iprintf(buffer, "midi in = %u\n", gus->gf1.interrupt_stat_midi_in);\r\nsnd_iprintf(buffer, "timer1 = %u\n", gus->gf1.interrupt_stat_timer1);\r\nsnd_iprintf(buffer, "timer2 = %u\n", gus->gf1.interrupt_stat_timer2);\r\nsnd_iprintf(buffer, "dma write = %u\n", gus->gf1.interrupt_stat_dma_write);\r\nsnd_iprintf(buffer, "dma read = %u\n", gus->gf1.interrupt_stat_dma_read);\r\nsnd_iprintf(buffer, "voice lost = %u\n", gus->gf1.interrupt_stat_voice_lost);\r\nfor (idx = 0; idx < 32; idx++) {\r\npvoice = &gus->gf1.voices[idx];\r\nsnd_iprintf(buffer, "voice %i: wave = %u, volume = %u\n",\r\nidx,\r\npvoice->interrupt_stat_wave,\r\npvoice->interrupt_stat_volume);\r\n}\r\n}\r\nvoid snd_gus_irq_profile_init(struct snd_gus_card *gus)\r\n{\r\nstruct snd_info_entry *entry;\r\nif (! snd_card_proc_new(gus->card, "gusirq", &entry))\r\nsnd_info_set_text_ops(entry, gus, snd_gus_irq_info_read);\r\n}

static int vco_get(struct clk_icst *icst, struct icst_vco *vco)\r\n{\r\nu32 val;\r\nint ret;\r\nret = regmap_read(icst->map, icst->vcoreg_off, &val);\r\nif (ret)\r\nreturn ret;\r\nvco->v = val & 0x1ff;\r\nvco->r = (val >> 9) & 0x7f;\r\nvco->s = (val >> 16) & 03;\r\nreturn 0;\r\n}\r\nstatic int vco_set(struct clk_icst *icst, struct icst_vco vco)\r\n{\r\nu32 val;\r\nint ret;\r\nret = regmap_read(icst->map, icst->vcoreg_off, &val);\r\nif (ret)\r\nreturn ret;\r\nval &= ~0x7ffff;\r\nval |= vco.v | (vco.r << 9) | (vco.s << 16);\r\nret = regmap_write(icst->map, icst->lockreg_off, VERSATILE_LOCK_VAL);\r\nif (ret)\r\nreturn ret;\r\nret = regmap_write(icst->map, icst->vcoreg_off, val);\r\nif (ret)\r\nreturn ret;\r\nret = regmap_write(icst->map, icst->lockreg_off, 0);\r\nif (ret)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic unsigned long icst_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct clk_icst *icst = to_icst(hw);\r\nstruct icst_vco vco;\r\nint ret;\r\nif (parent_rate)\r\nicst->params->ref = parent_rate;\r\nret = vco_get(icst, &vco);\r\nif (ret) {\r\npr_err("ICST: could not get VCO setting\n");\r\nreturn 0;\r\n}\r\nicst->rate = icst_hz(icst->params, vco);\r\nreturn icst->rate;\r\n}\r\nstatic long icst_round_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long *prate)\r\n{\r\nstruct clk_icst *icst = to_icst(hw);\r\nstruct icst_vco vco;\r\nvco = icst_hz_to_vco(icst->params, rate);\r\nreturn icst_hz(icst->params, vco);\r\n}\r\nstatic int icst_set_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nstruct clk_icst *icst = to_icst(hw);\r\nstruct icst_vco vco;\r\nif (parent_rate)\r\nicst->params->ref = parent_rate;\r\nvco = icst_hz_to_vco(icst->params, rate);\r\nicst->rate = icst_hz(icst->params, vco);\r\nreturn vco_set(icst, vco);\r\n}\r\nstatic struct clk *icst_clk_setup(struct device *dev,\r\nconst struct clk_icst_desc *desc,\r\nconst char *name,\r\nconst char *parent_name,\r\nstruct regmap *map)\r\n{\r\nstruct clk *clk;\r\nstruct clk_icst *icst;\r\nstruct clk_init_data init;\r\nstruct icst_params *pclone;\r\nicst = kzalloc(sizeof(struct clk_icst), GFP_KERNEL);\r\nif (!icst) {\r\npr_err("could not allocate ICST clock!\n");\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\npclone = kmemdup(desc->params, sizeof(*pclone), GFP_KERNEL);\r\nif (!pclone) {\r\nkfree(icst);\r\npr_err("could not clone ICST params\n");\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\ninit.name = name;\r\ninit.ops = &icst_ops;\r\ninit.flags = 0;\r\ninit.parent_names = (parent_name ? &parent_name : NULL);\r\ninit.num_parents = (parent_name ? 1 : 0);\r\nicst->map = map;\r\nicst->hw.init = &init;\r\nicst->params = pclone;\r\nicst->vcoreg_off = desc->vco_offset;\r\nicst->lockreg_off = desc->lock_offset;\r\nclk = clk_register(dev, &icst->hw);\r\nif (IS_ERR(clk)) {\r\nkfree(pclone);\r\nkfree(icst);\r\n}\r\nreturn clk;\r\n}\r\nstruct clk *icst_clk_register(struct device *dev,\r\nconst struct clk_icst_desc *desc,\r\nconst char *name,\r\nconst char *parent_name,\r\nvoid __iomem *base)\r\n{\r\nstruct regmap_config icst_regmap_conf = {\r\n.reg_bits = 32,\r\n.val_bits = 32,\r\n.reg_stride = 4,\r\n};\r\nstruct regmap *map;\r\nmap = regmap_init_mmio(dev, base, &icst_regmap_conf);\r\nif (IS_ERR(map)) {\r\npr_err("could not initialize ICST regmap\n");\r\nreturn ERR_CAST(map);\r\n}\r\nreturn icst_clk_setup(dev, desc, name, parent_name, map);\r\n}\r\nstatic void __init of_syscon_icst_setup(struct device_node *np)\r\n{\r\nstruct device_node *parent;\r\nstruct regmap *map;\r\nstruct clk_icst_desc icst_desc;\r\nconst char *name = np->name;\r\nconst char *parent_name;\r\nstruct clk *regclk;\r\nparent = of_get_parent(np);\r\nif (!parent) {\r\npr_err("no parent node for syscon ICST clock\n");\r\nreturn;\r\n}\r\nmap = syscon_node_to_regmap(parent);\r\nif (IS_ERR(map)) {\r\npr_err("no regmap for syscon ICST clock parent\n");\r\nreturn;\r\n}\r\nif (of_property_read_u32(np, "vco-offset", &icst_desc.vco_offset)) {\r\npr_err("no VCO register offset for ICST clock\n");\r\nreturn;\r\n}\r\nif (of_property_read_u32(np, "lock-offset", &icst_desc.lock_offset)) {\r\npr_err("no lock register offset for ICST clock\n");\r\nreturn;\r\n}\r\nif (of_device_is_compatible(np, "arm,syscon-icst525"))\r\nicst_desc.params = &icst525_params;\r\nelse if (of_device_is_compatible(np, "arm,syscon-icst307"))\r\nicst_desc.params = &icst307_params;\r\nelse {\r\npr_err("unknown ICST clock %s\n", name);\r\nreturn;\r\n}\r\nparent_name = of_clk_get_parent_name(np, 0);\r\nregclk = icst_clk_setup(NULL, &icst_desc, name, parent_name, map);\r\nif (IS_ERR(regclk)) {\r\npr_err("error setting up syscon ICST clock %s\n", name);\r\nreturn;\r\n}\r\nof_clk_add_provider(np, of_clk_src_simple_get, regclk);\r\npr_debug("registered syscon ICST clock %s\n", name);\r\n}

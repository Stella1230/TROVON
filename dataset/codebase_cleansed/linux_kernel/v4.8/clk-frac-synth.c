static unsigned long frac_calc_rate(struct clk_hw *hw, unsigned long prate,\r\nint index)\r\n{\r\nstruct clk_frac *frac = to_clk_frac(hw);\r\nstruct frac_rate_tbl *rtbl = frac->rtbl;\r\nprate /= 10000;\r\nprate <<= 14;\r\nprate /= (2 * rtbl[index].div);\r\nprate *= 10000;\r\nreturn prate;\r\n}\r\nstatic long clk_frac_round_rate(struct clk_hw *hw, unsigned long drate,\r\nunsigned long *prate)\r\n{\r\nstruct clk_frac *frac = to_clk_frac(hw);\r\nint unused;\r\nreturn clk_round_rate_index(hw, drate, *prate, frac_calc_rate,\r\nfrac->rtbl_cnt, &unused);\r\n}\r\nstatic unsigned long clk_frac_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct clk_frac *frac = to_clk_frac(hw);\r\nunsigned long flags = 0;\r\nunsigned int div = 1, val;\r\nif (frac->lock)\r\nspin_lock_irqsave(frac->lock, flags);\r\nval = readl_relaxed(frac->reg);\r\nif (frac->lock)\r\nspin_unlock_irqrestore(frac->lock, flags);\r\ndiv = val & DIV_FACTOR_MASK;\r\nif (!div)\r\nreturn 0;\r\nparent_rate = parent_rate / 10000;\r\nparent_rate = (parent_rate << 14) / (2 * div);\r\nreturn parent_rate * 10000;\r\n}\r\nstatic int clk_frac_set_rate(struct clk_hw *hw, unsigned long drate,\r\nunsigned long prate)\r\n{\r\nstruct clk_frac *frac = to_clk_frac(hw);\r\nstruct frac_rate_tbl *rtbl = frac->rtbl;\r\nunsigned long flags = 0, val;\r\nint i;\r\nclk_round_rate_index(hw, drate, prate, frac_calc_rate, frac->rtbl_cnt,\r\n&i);\r\nif (frac->lock)\r\nspin_lock_irqsave(frac->lock, flags);\r\nval = readl_relaxed(frac->reg) & ~DIV_FACTOR_MASK;\r\nval |= rtbl[i].div & DIV_FACTOR_MASK;\r\nwritel_relaxed(val, frac->reg);\r\nif (frac->lock)\r\nspin_unlock_irqrestore(frac->lock, flags);\r\nreturn 0;\r\n}\r\nstruct clk *clk_register_frac(const char *name, const char *parent_name,\r\nunsigned long flags, void __iomem *reg,\r\nstruct frac_rate_tbl *rtbl, u8 rtbl_cnt, spinlock_t *lock)\r\n{\r\nstruct clk_init_data init;\r\nstruct clk_frac *frac;\r\nstruct clk *clk;\r\nif (!name || !parent_name || !reg || !rtbl || !rtbl_cnt) {\r\npr_err("Invalid arguments passed");\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nfrac = kzalloc(sizeof(*frac), GFP_KERNEL);\r\nif (!frac) {\r\npr_err("could not allocate frac clk\n");\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nfrac->reg = reg;\r\nfrac->rtbl = rtbl;\r\nfrac->rtbl_cnt = rtbl_cnt;\r\nfrac->lock = lock;\r\nfrac->hw.init = &init;\r\ninit.name = name;\r\ninit.ops = &clk_frac_ops;\r\ninit.flags = flags;\r\ninit.parent_names = &parent_name;\r\ninit.num_parents = 1;\r\nclk = clk_register(NULL, &frac->hw);\r\nif (!IS_ERR_OR_NULL(clk))\r\nreturn clk;\r\npr_err("clk register failed\n");\r\nkfree(frac);\r\nreturn NULL;\r\n}

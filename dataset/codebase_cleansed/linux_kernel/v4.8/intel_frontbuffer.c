void intel_fb_obj_invalidate(struct drm_i915_gem_object *obj,\r\nenum fb_op_origin origin)\r\n{\r\nstruct drm_device *dev = obj->base.dev;\r\nstruct drm_i915_private *dev_priv = to_i915(dev);\r\nWARN_ON(!mutex_is_locked(&dev->struct_mutex));\r\nif (!obj->frontbuffer_bits)\r\nreturn;\r\nif (origin == ORIGIN_CS) {\r\nmutex_lock(&dev_priv->fb_tracking.lock);\r\ndev_priv->fb_tracking.busy_bits\r\n|= obj->frontbuffer_bits;\r\ndev_priv->fb_tracking.flip_bits\r\n&= ~obj->frontbuffer_bits;\r\nmutex_unlock(&dev_priv->fb_tracking.lock);\r\n}\r\nintel_psr_invalidate(dev, obj->frontbuffer_bits);\r\nintel_edp_drrs_invalidate(dev, obj->frontbuffer_bits);\r\nintel_fbc_invalidate(dev_priv, obj->frontbuffer_bits, origin);\r\n}\r\nstatic void intel_frontbuffer_flush(struct drm_device *dev,\r\nunsigned frontbuffer_bits,\r\nenum fb_op_origin origin)\r\n{\r\nstruct drm_i915_private *dev_priv = to_i915(dev);\r\nmutex_lock(&dev_priv->fb_tracking.lock);\r\nfrontbuffer_bits &= ~dev_priv->fb_tracking.busy_bits;\r\nmutex_unlock(&dev_priv->fb_tracking.lock);\r\nif (!frontbuffer_bits)\r\nreturn;\r\nintel_edp_drrs_flush(dev, frontbuffer_bits);\r\nintel_psr_flush(dev, frontbuffer_bits, origin);\r\nintel_fbc_flush(dev_priv, frontbuffer_bits, origin);\r\n}\r\nvoid intel_fb_obj_flush(struct drm_i915_gem_object *obj,\r\nbool retire, enum fb_op_origin origin)\r\n{\r\nstruct drm_device *dev = obj->base.dev;\r\nstruct drm_i915_private *dev_priv = to_i915(dev);\r\nunsigned frontbuffer_bits;\r\nWARN_ON(!mutex_is_locked(&dev->struct_mutex));\r\nif (!obj->frontbuffer_bits)\r\nreturn;\r\nfrontbuffer_bits = obj->frontbuffer_bits;\r\nif (retire) {\r\nmutex_lock(&dev_priv->fb_tracking.lock);\r\nfrontbuffer_bits &= dev_priv->fb_tracking.busy_bits;\r\ndev_priv->fb_tracking.busy_bits &= ~frontbuffer_bits;\r\nmutex_unlock(&dev_priv->fb_tracking.lock);\r\n}\r\nintel_frontbuffer_flush(dev, frontbuffer_bits, origin);\r\n}\r\nvoid intel_frontbuffer_flip_prepare(struct drm_device *dev,\r\nunsigned frontbuffer_bits)\r\n{\r\nstruct drm_i915_private *dev_priv = to_i915(dev);\r\nmutex_lock(&dev_priv->fb_tracking.lock);\r\ndev_priv->fb_tracking.flip_bits |= frontbuffer_bits;\r\ndev_priv->fb_tracking.busy_bits &= ~frontbuffer_bits;\r\nmutex_unlock(&dev_priv->fb_tracking.lock);\r\nintel_psr_single_frame_update(dev, frontbuffer_bits);\r\n}\r\nvoid intel_frontbuffer_flip_complete(struct drm_device *dev,\r\nunsigned frontbuffer_bits)\r\n{\r\nstruct drm_i915_private *dev_priv = to_i915(dev);\r\nmutex_lock(&dev_priv->fb_tracking.lock);\r\nfrontbuffer_bits &= dev_priv->fb_tracking.flip_bits;\r\ndev_priv->fb_tracking.flip_bits &= ~frontbuffer_bits;\r\nmutex_unlock(&dev_priv->fb_tracking.lock);\r\nintel_frontbuffer_flush(dev, frontbuffer_bits, ORIGIN_FLIP);\r\n}\r\nvoid intel_frontbuffer_flip(struct drm_device *dev,\r\nunsigned frontbuffer_bits)\r\n{\r\nstruct drm_i915_private *dev_priv = to_i915(dev);\r\nmutex_lock(&dev_priv->fb_tracking.lock);\r\ndev_priv->fb_tracking.busy_bits &= ~frontbuffer_bits;\r\nmutex_unlock(&dev_priv->fb_tracking.lock);\r\nintel_frontbuffer_flush(dev, frontbuffer_bits, ORIGIN_FLIP);\r\n}

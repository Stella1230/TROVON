u32 mic_read_spad(struct mic_device *mdev, unsigned int idx)\r\n{\r\nreturn mic_mmio_read(&mdev->mmio,\r\nMIC_X100_SBOX_BASE_ADDRESS +\r\nMIC_X100_SBOX_SPAD0 + idx * 4);\r\n}\r\nvoid mic_send_intr(struct mic_device *mdev, int doorbell)\r\n{\r\nstruct mic_mw *mw = &mdev->mmio;\r\nif (doorbell > MIC_X100_MAX_DOORBELL_IDX)\r\nreturn;\r\nwmb();\r\nmic_mmio_write(mw, MIC_X100_SBOX_SDBIC0_DBREQ_BIT,\r\nMIC_X100_SBOX_BASE_ADDRESS +\r\n(MIC_X100_SBOX_SDBIC0 + (4 * doorbell)));\r\n}\r\nstatic void mic_x100_send_sbox_intr(struct mic_mw *mw, int doorbell)\r\n{\r\nu64 apic_icr_offset = MIC_X100_SBOX_APICICR0 + doorbell * 8;\r\nu32 apicicr_low = mic_mmio_read(mw, MIC_X100_SBOX_BASE_ADDRESS +\r\napic_icr_offset);\r\napicicr_low = (apicicr_low | (1 << 13));\r\nwmb();\r\nmic_mmio_write(mw, apicicr_low,\r\nMIC_X100_SBOX_BASE_ADDRESS + apic_icr_offset);\r\n}\r\nstatic void mic_x100_send_rdmasr_intr(struct mic_mw *mw, int doorbell)\r\n{\r\nint rdmasr_offset = MIC_X100_SBOX_RDMASR0 + (doorbell << 2);\r\nwmb();\r\nmic_mmio_write(mw, 0, MIC_X100_SBOX_BASE_ADDRESS + rdmasr_offset);\r\n}\r\nu32 mic_ack_interrupt(struct mic_device *mdev)\r\n{\r\nreturn 0;\r\n}\r\nstatic inline int mic_get_sbox_irq(int db)\r\n{\r\nreturn MIC_X100_IRQ_BASE + db;\r\n}\r\nstatic inline int mic_get_rdmasr_irq(int index)\r\n{\r\nreturn MIC_X100_RDMASR_IRQ_BASE + index;\r\n}\r\nvoid mic_send_p2p_intr(int db, struct mic_mw *mw)\r\n{\r\nint rdmasr_index;\r\nif (db < MIC_X100_NUM_SBOX_IRQ) {\r\nmic_x100_send_sbox_intr(mw, db);\r\n} else {\r\nrdmasr_index = db - MIC_X100_NUM_SBOX_IRQ;\r\nmic_x100_send_rdmasr_intr(mw, rdmasr_index);\r\n}\r\n}\r\nvoid mic_hw_intr_init(struct mic_driver *mdrv)\r\n{\r\nmdrv->intr_info.num_intr = MIC_X100_NUM_SBOX_IRQ +\r\nMIC_X100_NUM_RDMASR_IRQ;\r\n}\r\nint mic_db_to_irq(struct mic_driver *mdrv, int db)\r\n{\r\nint rdmasr_index;\r\nif (db < MIC_X100_NUM_SBOX_IRQ) {\r\nreturn mic_get_sbox_irq(db);\r\n} else {\r\nrdmasr_index = db - MIC_X100_NUM_SBOX_IRQ;\r\nreturn mic_get_rdmasr_irq(rdmasr_index);\r\n}\r\n}\r\nvoid __iomem *\r\nmic_card_map(struct mic_device *mdev, dma_addr_t addr, size_t size)\r\n{\r\nreturn ioremap(addr, size);\r\n}\r\nvoid mic_card_unmap(struct mic_device *mdev, void __iomem *addr)\r\n{\r\niounmap(addr);\r\n}\r\nstatic inline struct mic_driver *mbdev_to_mdrv(struct mbus_device *mbdev)\r\n{\r\nreturn dev_get_drvdata(mbdev->dev.parent);\r\n}\r\nstatic struct mic_irq *\r\n_mic_request_threaded_irq(struct mbus_device *mbdev,\r\nirq_handler_t handler, irq_handler_t thread_fn,\r\nconst char *name, void *data, int intr_src)\r\n{\r\nint rc = 0;\r\nunsigned int irq = intr_src;\r\nunsigned long cookie = irq;\r\nrc = request_threaded_irq(irq, handler, thread_fn, 0, name, data);\r\nif (rc) {\r\ndev_err(mbdev_to_mdrv(mbdev)->dev,\r\n"request_threaded_irq failed rc = %d\n", rc);\r\nreturn ERR_PTR(rc);\r\n}\r\nreturn (struct mic_irq *)cookie;\r\n}\r\nstatic void _mic_free_irq(struct mbus_device *mbdev,\r\nstruct mic_irq *cookie, void *data)\r\n{\r\nunsigned long irq = (unsigned long)cookie;\r\nfree_irq(irq, data);\r\n}\r\nstatic void _mic_ack_interrupt(struct mbus_device *mbdev, int num)\r\n{\r\nmic_ack_interrupt(&mbdev_to_mdrv(mbdev)->mdev);\r\n}\r\nstatic int __init mic_probe(struct platform_device *pdev)\r\n{\r\nstruct mic_driver *mdrv = &g_drv;\r\nstruct mic_device *mdev = &mdrv->mdev;\r\nint rc = 0;\r\nmdrv->dev = &pdev->dev;\r\nsnprintf(mdrv->name, sizeof(mic_driver_name), mic_driver_name);\r\nmdev->mmio.pa = MIC_X100_MMIO_BASE;\r\nmdev->mmio.len = MIC_X100_MMIO_LEN;\r\nmdev->mmio.va = devm_ioremap(&pdev->dev, MIC_X100_MMIO_BASE,\r\nMIC_X100_MMIO_LEN);\r\nif (!mdev->mmio.va) {\r\ndev_err(&pdev->dev, "Cannot remap MMIO BAR\n");\r\nrc = -EIO;\r\ngoto done;\r\n}\r\nmic_hw_intr_init(mdrv);\r\nplatform_set_drvdata(pdev, mdrv);\r\nmdrv->dma_mbdev = mbus_register_device(mdrv->dev, MBUS_DEV_DMA_MIC,\r\nNULL, &mbus_hw_ops, 0,\r\nmdrv->mdev.mmio.va);\r\nif (IS_ERR(mdrv->dma_mbdev)) {\r\nrc = PTR_ERR(mdrv->dma_mbdev);\r\ndev_err(&pdev->dev, "mbus_add_device failed rc %d\n", rc);\r\ngoto done;\r\n}\r\nrc = mic_driver_init(mdrv);\r\nif (rc) {\r\ndev_err(&pdev->dev, "mic_driver_init failed rc %d\n", rc);\r\ngoto remove_dma;\r\n}\r\ndone:\r\nreturn rc;\r\nremove_dma:\r\nmbus_unregister_device(mdrv->dma_mbdev);\r\nreturn rc;\r\n}\r\nstatic int mic_remove(struct platform_device *pdev)\r\n{\r\nstruct mic_driver *mdrv = &g_drv;\r\nmic_driver_uninit(mdrv);\r\nmbus_unregister_device(mdrv->dma_mbdev);\r\nreturn 0;\r\n}\r\nstatic void mic_platform_shutdown(struct platform_device *pdev)\r\n{\r\nmic_remove(pdev);\r\n}\r\nstatic int __init mic_init(void)\r\n{\r\nint ret;\r\nstruct cpuinfo_x86 *c = &cpu_data(0);\r\nif (!(c->x86 == 11 && c->x86_model == 1)) {\r\nret = -ENODEV;\r\npr_err("%s not running on X100 ret %d\n", __func__, ret);\r\ngoto done;\r\n}\r\nrequest_module("mic_x100_dma");\r\nmic_init_card_debugfs();\r\nret = platform_device_register(&mic_platform_dev);\r\nif (ret) {\r\npr_err("platform_device_register ret %d\n", ret);\r\ngoto cleanup_debugfs;\r\n}\r\nret = platform_driver_register(&mic_platform_driver);\r\nif (ret) {\r\npr_err("platform_driver_register ret %d\n", ret);\r\ngoto device_unregister;\r\n}\r\nreturn ret;\r\ndevice_unregister:\r\nplatform_device_unregister(&mic_platform_dev);\r\ncleanup_debugfs:\r\nmic_exit_card_debugfs();\r\ndone:\r\nreturn ret;\r\n}\r\nstatic void __exit mic_exit(void)\r\n{\r\nplatform_driver_unregister(&mic_platform_driver);\r\nplatform_device_unregister(&mic_platform_dev);\r\nmic_exit_card_debugfs();\r\n}

static int asd_pause_cseq(struct asd_ha_struct *asd_ha)\r\n{\r\nint count = PAUSE_TRIES;\r\nu32 arp2ctl;\r\narp2ctl = asd_read_reg_dword(asd_ha, CARP2CTL);\r\nif (arp2ctl & PAUSED)\r\nreturn 0;\r\nasd_write_reg_dword(asd_ha, CARP2CTL, arp2ctl | EPAUSE);\r\ndo {\r\narp2ctl = asd_read_reg_dword(asd_ha, CARP2CTL);\r\nif (arp2ctl & PAUSED)\r\nreturn 0;\r\nudelay(PAUSE_DELAY);\r\n} while (--count > 0);\r\nASD_DPRINTK("couldn't pause CSEQ\n");\r\nreturn -1;\r\n}\r\nstatic int asd_unpause_cseq(struct asd_ha_struct *asd_ha)\r\n{\r\nu32 arp2ctl;\r\nint count = PAUSE_TRIES;\r\narp2ctl = asd_read_reg_dword(asd_ha, CARP2CTL);\r\nif (!(arp2ctl & PAUSED))\r\nreturn 0;\r\nasd_write_reg_dword(asd_ha, CARP2CTL, arp2ctl & ~EPAUSE);\r\ndo {\r\narp2ctl = asd_read_reg_dword(asd_ha, CARP2CTL);\r\nif (!(arp2ctl & PAUSED))\r\nreturn 0;\r\nudelay(PAUSE_DELAY);\r\n} while (--count > 0);\r\nASD_DPRINTK("couldn't unpause the CSEQ\n");\r\nreturn -1;\r\n}\r\nstatic int asd_seq_pause_lseq(struct asd_ha_struct *asd_ha, int lseq)\r\n{\r\nu32 arp2ctl;\r\nint count = PAUSE_TRIES;\r\narp2ctl = asd_read_reg_dword(asd_ha, LmARP2CTL(lseq));\r\nif (arp2ctl & PAUSED)\r\nreturn 0;\r\nasd_write_reg_dword(asd_ha, LmARP2CTL(lseq), arp2ctl | EPAUSE);\r\ndo {\r\narp2ctl = asd_read_reg_dword(asd_ha, LmARP2CTL(lseq));\r\nif (arp2ctl & PAUSED)\r\nreturn 0;\r\nudelay(PAUSE_DELAY);\r\n} while (--count > 0);\r\nASD_DPRINTK("couldn't pause LSEQ %d\n", lseq);\r\nreturn -1;\r\n}\r\nstatic int asd_pause_lseq(struct asd_ha_struct *asd_ha, u8 lseq_mask)\r\n{\r\nint lseq;\r\nint err = 0;\r\nfor_each_sequencer(lseq_mask, lseq_mask, lseq) {\r\nerr = asd_seq_pause_lseq(asd_ha, lseq);\r\nif (err)\r\nreturn err;\r\n}\r\nreturn err;\r\n}\r\nstatic int asd_seq_unpause_lseq(struct asd_ha_struct *asd_ha, int lseq)\r\n{\r\nu32 arp2ctl;\r\nint count = PAUSE_TRIES;\r\narp2ctl = asd_read_reg_dword(asd_ha, LmARP2CTL(lseq));\r\nif (!(arp2ctl & PAUSED))\r\nreturn 0;\r\nasd_write_reg_dword(asd_ha, LmARP2CTL(lseq), arp2ctl & ~EPAUSE);\r\ndo {\r\narp2ctl = asd_read_reg_dword(asd_ha, LmARP2CTL(lseq));\r\nif (!(arp2ctl & PAUSED))\r\nreturn 0;\r\nudelay(PAUSE_DELAY);\r\n} while (--count > 0);\r\nASD_DPRINTK("couldn't unpause LSEQ %d\n", lseq);\r\nreturn 0;\r\n}\r\nstatic int asd_verify_cseq(struct asd_ha_struct *asd_ha, const u8 *_prog,\r\nu32 size)\r\n{\r\nu32 addr = CSEQ_RAM_REG_BASE_ADR;\r\nconst u32 *prog = (u32 *) _prog;\r\nu32 i;\r\nfor (i = 0; i < size; i += 4, prog++, addr += 4) {\r\nu32 val = asd_read_reg_dword(asd_ha, addr);\r\nif (le32_to_cpu(*prog) != val) {\r\nasd_printk("%s: cseq verify failed at %u "\r\n"read:0x%x, wanted:0x%x\n",\r\npci_name(asd_ha->pcidev),\r\ni, val, le32_to_cpu(*prog));\r\nreturn -1;\r\n}\r\n}\r\nASD_DPRINTK("verified %d bytes, passed\n", size);\r\nreturn 0;\r\n}\r\nstatic int asd_verify_lseq(struct asd_ha_struct *asd_ha, const u8 *_prog,\r\nu32 size, int lseq)\r\n{\r\n#define LSEQ_CODEPAGE_SIZE 4096\r\nint pages = (size + LSEQ_CODEPAGE_SIZE - 1) / LSEQ_CODEPAGE_SIZE;\r\nu32 page;\r\nconst u32 *prog = (u32 *) _prog;\r\nfor (page = 0; page < pages; page++) {\r\nu32 i;\r\nasd_write_reg_dword(asd_ha, LmBISTCTL1(lseq),\r\npage << LmRAMPAGE_LSHIFT);\r\nfor (i = 0; size > 0 && i < LSEQ_CODEPAGE_SIZE;\r\ni += 4, prog++, size-=4) {\r\nu32 val = asd_read_reg_dword(asd_ha, LmSEQRAM(lseq)+i);\r\nif (le32_to_cpu(*prog) != val) {\r\nasd_printk("%s: LSEQ%d verify failed "\r\n"page:%d, offs:%d\n",\r\npci_name(asd_ha->pcidev),\r\nlseq, page, i);\r\nreturn -1;\r\n}\r\n}\r\n}\r\nASD_DPRINTK("LSEQ%d verified %d bytes, passed\n", lseq,\r\n(int)((u8 *)prog-_prog));\r\nreturn 0;\r\n}\r\nstatic int asd_verify_seq(struct asd_ha_struct *asd_ha, const u8 *prog,\r\nu32 size, u8 lseq_mask)\r\n{\r\nif (lseq_mask == 0)\r\nreturn asd_verify_cseq(asd_ha, prog, size);\r\nelse {\r\nint lseq, err;\r\nfor_each_sequencer(lseq_mask, lseq_mask, lseq) {\r\nerr = asd_verify_lseq(asd_ha, prog, size, lseq);\r\nif (err)\r\nreturn err;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int asd_download_seq(struct asd_ha_struct *asd_ha,\r\nconst u8 * const prog, u32 size, u8 lseq_mask)\r\n{\r\nu32 comstaten;\r\nu32 reg;\r\nint page;\r\nconst int pages = (size + MAX_DMA_OVLY_COUNT - 1) / MAX_DMA_OVLY_COUNT;\r\nstruct asd_dma_tok *token;\r\nint err = 0;\r\nif (size % 4) {\r\nasd_printk("sequencer program not multiple of 4\n");\r\nreturn -1;\r\n}\r\nasd_pause_cseq(asd_ha);\r\nasd_pause_lseq(asd_ha, 0xFF);\r\ncomstaten = asd_read_reg_dword(asd_ha, COMSTATEN);\r\nasd_write_reg_dword(asd_ha, COMSTATEN, 0);\r\nasd_write_reg_dword(asd_ha, COMSTAT, COMSTAT_MASK);\r\nasd_write_reg_dword(asd_ha, CHIMINTEN, RST_CHIMINTEN);\r\nasd_write_reg_dword(asd_ha, CHIMINT, CHIMINT_MASK);\r\ntoken = asd_alloc_coherent(asd_ha, MAX_DMA_OVLY_COUNT, GFP_KERNEL);\r\nif (!token) {\r\nasd_printk("out of memory for dma SEQ download\n");\r\nerr = -ENOMEM;\r\ngoto out;\r\n}\r\nASD_DPRINTK("dma-ing %d bytes\n", size);\r\nfor (page = 0; page < pages; page++) {\r\nint i;\r\nu32 left = min(size-page*MAX_DMA_OVLY_COUNT,\r\n(u32)MAX_DMA_OVLY_COUNT);\r\nmemcpy(token->vaddr, prog + page*MAX_DMA_OVLY_COUNT, left);\r\nasd_write_reg_addr(asd_ha, OVLYDMAADR, token->dma_handle);\r\nasd_write_reg_dword(asd_ha, OVLYDMACNT, left);\r\nreg = !page ? RESETOVLYDMA : 0;\r\nreg |= (STARTOVLYDMA | OVLYHALTERR);\r\nreg |= (lseq_mask ? (((u32)lseq_mask) << 8) : OVLYCSEQ);\r\nasd_write_reg_dword(asd_ha, OVLYDMACTL, reg);\r\nfor (i = PAUSE_TRIES*100; i > 0; i--) {\r\nu32 dmadone = asd_read_reg_dword(asd_ha, OVLYDMACTL);\r\nif (!(dmadone & OVLYDMAACT))\r\nbreak;\r\nudelay(PAUSE_DELAY);\r\n}\r\n}\r\nreg = asd_read_reg_dword(asd_ha, COMSTAT);\r\nif (!(reg & OVLYDMADONE) || (reg & OVLYERR)\r\n|| (asd_read_reg_dword(asd_ha, CHIMINT) & DEVEXCEPT_MASK)){\r\nasd_printk("%s: error DMA-ing sequencer code\n",\r\npci_name(asd_ha->pcidev));\r\nerr = -ENODEV;\r\n}\r\nasd_free_coherent(asd_ha, token);\r\nout:\r\nasd_write_reg_dword(asd_ha, COMSTATEN, comstaten);\r\nreturn err ? : asd_verify_seq(asd_ha, prog, size, lseq_mask);\r\n}\r\nstatic int asd_download_seq(struct asd_ha_struct *asd_ha, const u8 *_prog,\r\nu32 size, u8 lseq_mask)\r\n{\r\nint i;\r\nu32 reg = 0;\r\nconst u32 *prog = (u32 *) _prog;\r\nif (size % 4) {\r\nasd_printk("sequencer program not multiple of 4\n");\r\nreturn -1;\r\n}\r\nasd_pause_cseq(asd_ha);\r\nasd_pause_lseq(asd_ha, 0xFF);\r\nreg |= (lseq_mask ? (((u32)lseq_mask) << 8) : OVLYCSEQ);\r\nreg |= PIOCMODE;\r\nasd_write_reg_dword(asd_ha, OVLYDMACNT, size);\r\nasd_write_reg_dword(asd_ha, OVLYDMACTL, reg);\r\nASD_DPRINTK("downloading %s sequencer%s in PIO mode...\n",\r\nlseq_mask ? "LSEQ" : "CSEQ", lseq_mask ? "s" : "");\r\nfor (i = 0; i < size; i += 4, prog++)\r\nasd_write_reg_dword(asd_ha, SPIODATA, *prog);\r\nreg = (reg & ~PIOCMODE) | OVLYHALTERR;\r\nasd_write_reg_dword(asd_ha, OVLYDMACTL, reg);\r\nreturn asd_verify_seq(asd_ha, _prog, size, lseq_mask);\r\n}\r\nstatic int asd_seq_download_seqs(struct asd_ha_struct *asd_ha)\r\n{\r\nint err;\r\nif (!asd_ha->hw_prof.enabled_phys) {\r\nasd_printk("%s: no enabled phys!\n", pci_name(asd_ha->pcidev));\r\nreturn -ENODEV;\r\n}\r\nASD_DPRINTK("downloading CSEQ...\n");\r\nerr = asd_download_seq(asd_ha, cseq_code, cseq_code_size, 0);\r\nif (err) {\r\nasd_printk("CSEQ download failed:%d\n", err);\r\nreturn err;\r\n}\r\nASD_DPRINTK("downloading LSEQs...\n");\r\nerr = asd_download_seq(asd_ha, lseq_code, lseq_code_size,\r\nasd_ha->hw_prof.enabled_phys);\r\nif (err) {\r\nu8 lseq;\r\nu8 lseq_mask = asd_ha->hw_prof.enabled_phys;\r\nfor_each_sequencer(lseq_mask, lseq_mask, lseq) {\r\nerr = asd_download_seq(asd_ha, lseq_code,\r\nlseq_code_size, 1<<lseq);\r\nif (err)\r\nbreak;\r\n}\r\n}\r\nif (err)\r\nasd_printk("LSEQs download failed:%d\n", err);\r\nreturn err;\r\n}\r\nstatic void asd_init_cseq_mip(struct asd_ha_struct *asd_ha)\r\n{\r\nasd_write_reg_word(asd_ha, CSEQ_Q_EXE_HEAD, 0xFFFF);\r\nasd_write_reg_word(asd_ha, CSEQ_Q_EXE_TAIL, 0xFFFF);\r\nasd_write_reg_word(asd_ha, CSEQ_Q_DONE_HEAD, 0xFFFF);\r\nasd_write_reg_word(asd_ha, CSEQ_Q_DONE_TAIL, 0xFFFF);\r\nasd_write_reg_word(asd_ha, CSEQ_Q_SEND_HEAD, 0xFFFF);\r\nasd_write_reg_word(asd_ha, CSEQ_Q_SEND_TAIL, 0xFFFF);\r\nasd_write_reg_word(asd_ha, CSEQ_Q_DMA2CHIM_HEAD, 0xFFFF);\r\nasd_write_reg_word(asd_ha, CSEQ_Q_DMA2CHIM_TAIL, 0xFFFF);\r\nasd_write_reg_word(asd_ha, CSEQ_Q_COPY_HEAD, 0xFFFF);\r\nasd_write_reg_word(asd_ha, CSEQ_Q_COPY_TAIL, 0xFFFF);\r\nasd_write_reg_word(asd_ha, CSEQ_REG0, 0);\r\nasd_write_reg_word(asd_ha, CSEQ_REG1, 0);\r\nasd_write_reg_dword(asd_ha, CSEQ_REG2, 0);\r\nasd_write_reg_byte(asd_ha, CSEQ_LINK_CTL_Q_MAP, 0);\r\n{\r\nu8 con = asd_read_reg_byte(asd_ha, CCONEXIST);\r\nu8 val = hweight8(con);\r\nasd_write_reg_byte(asd_ha, CSEQ_MAX_CSEQ_MODE, (val<<4)|val);\r\n}\r\nasd_write_reg_word(asd_ha, CSEQ_FREE_LIST_HACK_COUNT, 0);\r\nasd_write_reg_dword(asd_ha, CSEQ_EST_NEXUS_REQ_QUEUE, 0);\r\nasd_write_reg_dword(asd_ha, CSEQ_EST_NEXUS_REQ_QUEUE+4, 0);\r\nasd_write_reg_dword(asd_ha, CSEQ_EST_NEXUS_REQ_COUNT, 0);\r\nasd_write_reg_dword(asd_ha, CSEQ_EST_NEXUS_REQ_COUNT+4, 0);\r\nasd_write_reg_word(asd_ha, CSEQ_Q_EST_NEXUS_HEAD, 0xFFFF);\r\nasd_write_reg_word(asd_ha, CSEQ_Q_EST_NEXUS_TAIL, 0xFFFF);\r\nasd_write_reg_word(asd_ha, CSEQ_NEED_EST_NEXUS_SCB, 0);\r\nasd_write_reg_byte(asd_ha, CSEQ_EST_NEXUS_REQ_HEAD, 0);\r\nasd_write_reg_byte(asd_ha, CSEQ_EST_NEXUS_REQ_TAIL, 0);\r\nasd_write_reg_byte(asd_ha, CSEQ_EST_NEXUS_SCB_OFFSET, 0);\r\nasd_write_reg_word(asd_ha, CSEQ_INT_ROUT_RET_ADDR0, 0);\r\nasd_write_reg_word(asd_ha, CSEQ_INT_ROUT_RET_ADDR1, 0);\r\nasd_write_reg_word(asd_ha, CSEQ_INT_ROUT_SCBPTR, 0);\r\nasd_write_reg_byte(asd_ha, CSEQ_INT_ROUT_MODE, 0);\r\nasd_write_reg_byte(asd_ha, CSEQ_ISR_SCRATCH_FLAGS, 0);\r\nasd_write_reg_word(asd_ha, CSEQ_ISR_SAVE_SINDEX, 0);\r\nasd_write_reg_word(asd_ha, CSEQ_ISR_SAVE_DINDEX, 0);\r\nasd_write_reg_word(asd_ha, CSEQ_Q_MONIRTT_HEAD, 0xFFFF);\r\nasd_write_reg_word(asd_ha, CSEQ_Q_MONIRTT_TAIL, 0xFFFF);\r\n{\r\nu16 cmdctx = asd_get_cmdctx_size(asd_ha);\r\ncmdctx = (~((cmdctx/128)-1)) >> 8;\r\nasd_write_reg_byte(asd_ha, CSEQ_FREE_SCB_MASK, (u8)cmdctx);\r\n}\r\nasd_write_reg_word(asd_ha, CSEQ_BUILTIN_FREE_SCB_HEAD,\r\nfirst_scb_site_no);\r\nasd_write_reg_word(asd_ha, CSEQ_BUILTIN_FREE_SCB_TAIL,\r\nlast_scb_site_no);\r\nasd_write_reg_word(asd_ha, CSEQ_EXTENDED_FREE_SCB_HEAD, 0xFFFF);\r\nasd_write_reg_word(asd_ha, CSEQ_EXTENDED_FREE_SCB_TAIL, 0xFFFF);\r\nasd_write_reg_dword(asd_ha, CSEQ_EMPTY_REQ_QUEUE, 0);\r\nasd_write_reg_dword(asd_ha, CSEQ_EMPTY_REQ_QUEUE+4, 0);\r\nasd_write_reg_dword(asd_ha, CSEQ_EMPTY_REQ_COUNT, 0);\r\nasd_write_reg_dword(asd_ha, CSEQ_EMPTY_REQ_COUNT+4, 0);\r\nasd_write_reg_word(asd_ha, CSEQ_Q_EMPTY_HEAD, 0xFFFF);\r\nasd_write_reg_word(asd_ha, CSEQ_Q_EMPTY_TAIL, 0xFFFF);\r\nasd_write_reg_word(asd_ha, CSEQ_NEED_EMPTY_SCB, 0);\r\nasd_write_reg_byte(asd_ha, CSEQ_EMPTY_REQ_HEAD, 0);\r\nasd_write_reg_byte(asd_ha, CSEQ_EMPTY_REQ_TAIL, 0);\r\nasd_write_reg_byte(asd_ha, CSEQ_EMPTY_SCB_OFFSET, 0);\r\nasd_write_reg_word(asd_ha, CSEQ_PRIMITIVE_DATA, 0);\r\nasd_write_reg_dword(asd_ha, CSEQ_TIMEOUT_CONST, 0);\r\n}\r\nstatic void asd_init_cseq_mdp(struct asd_ha_struct *asd_ha)\r\n{\r\nint i;\r\nint moffs;\r\nmoffs = CSEQ_PAGE_SIZE * 2;\r\nfor (i = 0; i < 8; i++) {\r\nasd_write_reg_word(asd_ha, i*moffs+CSEQ_LRM_SAVE_SINDEX, 0);\r\nasd_write_reg_word(asd_ha, i*moffs+CSEQ_LRM_SAVE_SCBPTR, 0);\r\nasd_write_reg_word(asd_ha, i*moffs+CSEQ_Q_LINK_HEAD, 0xFFFF);\r\nasd_write_reg_word(asd_ha, i*moffs+CSEQ_Q_LINK_TAIL, 0xFFFF);\r\nasd_write_reg_byte(asd_ha, i*moffs+CSEQ_LRM_SAVE_SCRPAGE, 0);\r\n}\r\nasd_write_reg_word(asd_ha, CSEQ_RET_ADDR, 0xFFFF);\r\nasd_write_reg_word(asd_ha, CSEQ_RET_SCBPTR, 0);\r\nasd_write_reg_word(asd_ha, CSEQ_SAVE_SCBPTR, 0);\r\nasd_write_reg_word(asd_ha, CSEQ_EMPTY_TRANS_CTX, 0);\r\nasd_write_reg_word(asd_ha, CSEQ_RESP_LEN, 0);\r\nasd_write_reg_word(asd_ha, CSEQ_TMF_SCBPTR, 0);\r\nasd_write_reg_word(asd_ha, CSEQ_GLOBAL_PREV_SCB, 0);\r\nasd_write_reg_word(asd_ha, CSEQ_GLOBAL_HEAD, 0);\r\nasd_write_reg_word(asd_ha, CSEQ_CLEAR_LU_HEAD, 0);\r\nasd_write_reg_byte(asd_ha, CSEQ_TMF_OPCODE, 0);\r\nasd_write_reg_byte(asd_ha, CSEQ_SCRATCH_FLAGS, 0);\r\nasd_write_reg_word(asd_ha, CSEQ_HSB_SITE, 0);\r\nasd_write_reg_word(asd_ha, CSEQ_FIRST_INV_SCB_SITE,\r\n(u16)last_scb_site_no+1);\r\nasd_write_reg_word(asd_ha, CSEQ_FIRST_INV_DDB_SITE,\r\n(u16)asd_ha->hw_prof.max_ddbs);\r\nasd_write_reg_dword(asd_ha, CSEQ_LUN_TO_CLEAR, 0);\r\nasd_write_reg_dword(asd_ha, CSEQ_LUN_TO_CLEAR + 4, 0);\r\nasd_write_reg_dword(asd_ha, CSEQ_LUN_TO_CHECK, 0);\r\nasd_write_reg_dword(asd_ha, CSEQ_LUN_TO_CHECK + 4, 0);\r\nasd_write_reg_addr(asd_ha, CSEQ_HQ_NEW_POINTER,\r\nasd_ha->seq.next_scb.dma_handle);\r\nASD_DPRINTK("First SCB dma_handle: 0x%llx\n",\r\n(unsigned long long)asd_ha->seq.next_scb.dma_handle);\r\nasd_write_reg_addr(asd_ha, CSEQ_HQ_DONE_BASE,\r\nasd_ha->seq.actual_dl->dma_handle);\r\nasd_write_reg_dword(asd_ha, CSEQ_HQ_DONE_POINTER,\r\nASD_BUSADDR_LO(asd_ha->seq.actual_dl->dma_handle));\r\nasd_write_reg_byte(asd_ha, CSEQ_HQ_DONE_PASS, ASD_DEF_DL_TOGGLE);\r\n}\r\nstatic void asd_init_cseq_scratch(struct asd_ha_struct *asd_ha)\r\n{\r\nasd_init_cseq_mip(asd_ha);\r\nasd_init_cseq_mdp(asd_ha);\r\n}\r\nstatic void asd_init_lseq_mip(struct asd_ha_struct *asd_ha, u8 lseq)\r\n{\r\nint i;\r\nasd_write_reg_word(asd_ha, LmSEQ_Q_TGTXFR_HEAD(lseq), 0xFFFF);\r\nasd_write_reg_word(asd_ha, LmSEQ_Q_TGTXFR_TAIL(lseq), 0xFFFF);\r\nasd_write_reg_byte(asd_ha, LmSEQ_LINK_NUMBER(lseq), lseq);\r\nasd_write_reg_byte(asd_ha, LmSEQ_SCRATCH_FLAGS(lseq),\r\nASD_NOTIFY_ENABLE_SPINUP);\r\nasd_write_reg_dword(asd_ha, LmSEQ_CONNECTION_STATE(lseq),0x08000000);\r\nasd_write_reg_word(asd_ha, LmSEQ_CONCTL(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_CONSTAT(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_CONNECTION_MODES(lseq), 0);\r\nasd_write_reg_word(asd_ha, LmSEQ_REG1_ISR(lseq), 0);\r\nasd_write_reg_word(asd_ha, LmSEQ_REG2_ISR(lseq), 0);\r\nasd_write_reg_word(asd_ha, LmSEQ_REG3_ISR(lseq), 0);\r\nasd_write_reg_dword(asd_ha, LmSEQ_REG0_ISR(lseq), 0);\r\nasd_write_reg_dword(asd_ha, LmSEQ_REG0_ISR(lseq)+4, 0);\r\nasd_write_reg_word(asd_ha, LmSEQ_EST_NEXUS_SCBPTR0(lseq), 0xFFFF);\r\nasd_write_reg_word(asd_ha, LmSEQ_EST_NEXUS_SCBPTR1(lseq), 0xFFFF);\r\nasd_write_reg_word(asd_ha, LmSEQ_EST_NEXUS_SCBPTR2(lseq), 0xFFFF);\r\nasd_write_reg_word(asd_ha, LmSEQ_EST_NEXUS_SCBPTR3(lseq), 0xFFFF);\r\nasd_write_reg_byte(asd_ha, LmSEQ_EST_NEXUS_SCB_OPCODE0(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_EST_NEXUS_SCB_OPCODE1(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_EST_NEXUS_SCB_OPCODE2(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_EST_NEXUS_SCB_OPCODE3(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_EST_NEXUS_SCB_HEAD(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_EST_NEXUS_SCB_TAIL(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_EST_NEXUS_BUF_AVAIL(lseq), 0);\r\nasd_write_reg_dword(asd_ha, LmSEQ_TIMEOUT_CONST(lseq), 0);\r\nasd_write_reg_word(asd_ha, LmSEQ_ISR_SAVE_SINDEX(lseq), 0);\r\nasd_write_reg_word(asd_ha, LmSEQ_ISR_SAVE_DINDEX(lseq), 0);\r\nasd_write_reg_word(asd_ha, LmSEQ_EMPTY_SCB_PTR0(lseq), 0xFFFF);\r\nasd_write_reg_word(asd_ha, LmSEQ_EMPTY_SCB_PTR1(lseq), 0xFFFF);\r\nasd_write_reg_word(asd_ha, LmSEQ_EMPTY_SCB_PTR2(lseq), 0xFFFF);\r\nasd_write_reg_word(asd_ha, LmSEQ_EMPTY_SCB_PTR3(lseq), 0xFFFF);\r\nasd_write_reg_byte(asd_ha, LmSEQ_EMPTY_SCB_OPCD0(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_EMPTY_SCB_OPCD1(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_EMPTY_SCB_OPCD2(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_EMPTY_SCB_OPCD3(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_EMPTY_SCB_HEAD(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_EMPTY_SCB_TAIL(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_EMPTY_BUFS_AVAIL(lseq), 0);\r\nfor (i = 0; i < 12; i += 4)\r\nasd_write_reg_dword(asd_ha, LmSEQ_ATA_SCR_REGS(lseq) + i, 0);\r\nasd_write_reg_dword(asd_ha, LmSEQ_DEV_PRES_TMR_TOUT_CONST(lseq),\r\nASD_DEV_PRESENT_TIMEOUT);\r\nasd_write_reg_dword(asd_ha, LmSEQ_SATA_INTERLOCK_TIMEOUT(lseq),\r\nASD_SATA_INTERLOCK_TIMEOUT);\r\nasd_write_reg_dword(asd_ha, LmSEQ_STP_SHUTDOWN_TIMEOUT(lseq),\r\nASD_STP_SHUTDOWN_TIMEOUT);\r\nasd_write_reg_dword(asd_ha, LmSEQ_SRST_ASSERT_TIMEOUT(lseq),\r\nASD_SRST_ASSERT_TIMEOUT);\r\nasd_write_reg_dword(asd_ha, LmSEQ_RCV_FIS_TIMEOUT(lseq),\r\nASD_RCV_FIS_TIMEOUT);\r\nasd_write_reg_dword(asd_ha, LmSEQ_ONE_MILLISEC_TIMEOUT(lseq),\r\nASD_ONE_MILLISEC_TIMEOUT);\r\nasd_write_reg_dword(asd_ha, LmSEQ_TEN_MS_COMINIT_TIMEOUT(lseq),\r\nASD_TEN_MILLISEC_TIMEOUT);\r\nasd_write_reg_dword(asd_ha, LmSEQ_SMP_RCV_TIMEOUT(lseq),\r\nASD_SMP_RCV_TIMEOUT);\r\n}\r\nstatic void asd_init_lseq_mdp(struct asd_ha_struct *asd_ha, int lseq)\r\n{\r\nint i;\r\nu32 moffs;\r\nu16 ret_addr[] = {\r\n0xFFFF,\r\n0xFFFF,\r\nmode2_task,\r\n0,\r\n0xFFFF,\r\n0xFFFF,\r\n};\r\nfor (i = 0; i < 3; i++) {\r\nmoffs = i * LSEQ_MODE_SCRATCH_SIZE;\r\nasd_write_reg_word(asd_ha, LmSEQ_RET_ADDR(lseq)+moffs,\r\nret_addr[i]);\r\nasd_write_reg_word(asd_ha, LmSEQ_REG0_MODE(lseq)+moffs, 0);\r\nasd_write_reg_word(asd_ha, LmSEQ_MODE_FLAGS(lseq)+moffs, 0);\r\nasd_write_reg_word(asd_ha, LmSEQ_RET_ADDR2(lseq)+moffs,0xFFFF);\r\nasd_write_reg_word(asd_ha, LmSEQ_RET_ADDR1(lseq)+moffs,0xFFFF);\r\nasd_write_reg_byte(asd_ha, LmSEQ_OPCODE_TO_CSEQ(lseq)+moffs,0);\r\nasd_write_reg_word(asd_ha, LmSEQ_DATA_TO_CSEQ(lseq)+moffs,0);\r\n}\r\nasd_write_reg_word(asd_ha,\r\nLmSEQ_RET_ADDR(lseq)+LSEQ_MODE5_PAGE0_OFFSET,\r\nret_addr[5]);\r\nasd_write_reg_word(asd_ha,\r\nLmSEQ_REG0_MODE(lseq)+LSEQ_MODE5_PAGE0_OFFSET,0);\r\nasd_write_reg_word(asd_ha,\r\nLmSEQ_MODE_FLAGS(lseq)+LSEQ_MODE5_PAGE0_OFFSET, 0);\r\nasd_write_reg_word(asd_ha,\r\nLmSEQ_RET_ADDR2(lseq)+LSEQ_MODE5_PAGE0_OFFSET,0xFFFF);\r\nasd_write_reg_word(asd_ha,\r\nLmSEQ_RET_ADDR1(lseq)+LSEQ_MODE5_PAGE0_OFFSET,0xFFFF);\r\nasd_write_reg_byte(asd_ha,\r\nLmSEQ_OPCODE_TO_CSEQ(lseq)+LSEQ_MODE5_PAGE0_OFFSET,0);\r\nasd_write_reg_word(asd_ha,\r\nLmSEQ_DATA_TO_CSEQ(lseq)+LSEQ_MODE5_PAGE0_OFFSET, 0);\r\nasd_write_reg_word(asd_ha, LmSEQ_FIRST_INV_DDB_SITE(lseq),\r\n(u16)asd_ha->hw_prof.max_ddbs);\r\nasd_write_reg_word(asd_ha, LmSEQ_EMPTY_TRANS_CTX(lseq), 0);\r\nasd_write_reg_word(asd_ha, LmSEQ_RESP_LEN(lseq), 0);\r\nasd_write_reg_word(asd_ha, LmSEQ_FIRST_INV_SCB_SITE(lseq),\r\n(u16)last_scb_site_no+1);\r\nasd_write_reg_word(asd_ha, LmSEQ_INTEN_SAVE(lseq),\r\n(u16) ((LmM0INTEN_MASK & 0xFFFF0000) >> 16));\r\nasd_write_reg_word(asd_ha, LmSEQ_INTEN_SAVE(lseq) + 2,\r\n(u16) LmM0INTEN_MASK & 0xFFFF);\r\nasd_write_reg_byte(asd_ha, LmSEQ_LINK_RST_FRM_LEN(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_LINK_RST_PROTOCOL(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_RESP_STATUS(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_LAST_LOADED_SGE(lseq), 0);\r\nasd_write_reg_word(asd_ha, LmSEQ_SAVE_SCBPTR(lseq), 0);\r\nasd_write_reg_word(asd_ha, LmSEQ_Q_XMIT_HEAD(lseq), 0xFFFF);\r\nasd_write_reg_word(asd_ha, LmSEQ_M1_EMPTY_TRANS_CTX(lseq), 0);\r\nasd_write_reg_word(asd_ha, LmSEQ_INI_CONN_TAG(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_FAILED_OPEN_STATUS(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_XMIT_REQUEST_TYPE(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_M1_RESP_STATUS(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_M1_LAST_LOADED_SGE(lseq), 0);\r\nasd_write_reg_word(asd_ha, LmSEQ_M1_SAVE_SCBPTR(lseq), 0);\r\nasd_write_reg_word(asd_ha, LmSEQ_PORT_COUNTER(lseq), 0);\r\nasd_write_reg_word(asd_ha, LmSEQ_PM_TABLE_PTR(lseq), 0);\r\nasd_write_reg_word(asd_ha, LmSEQ_SATA_INTERLOCK_TMR_SAVE(lseq), 0);\r\nasd_write_reg_word(asd_ha, LmSEQ_IP_BITL(lseq), 0);\r\nasd_write_reg_word(asd_ha, LmSEQ_COPY_SMP_CONN_TAG(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_P0M2_OFFS1AH(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_SAVED_OOB_STATUS(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_SAVED_OOB_MODE(lseq), 0);\r\nasd_write_reg_word(asd_ha, LmSEQ_Q_LINK_HEAD(lseq), 0xFFFF);\r\nasd_write_reg_byte(asd_ha, LmSEQ_LINK_RST_ERR(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_SAVED_OOB_SIGNALS(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_SAS_RESET_MODE(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_LINK_RESET_RETRY_COUNT(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_NUM_LINK_RESET_RETRIES(lseq), 0);\r\nasd_write_reg_word(asd_ha, LmSEQ_OOB_INT_ENABLES(lseq), 0);\r\nasd_write_reg_word(asd_ha, LmSEQ_NOTIFY_TIMER_TIMEOUT(lseq),\r\nASD_NOTIFY_TIMEOUT - 1);\r\nasd_write_reg_word(asd_ha, LmSEQ_NOTIFY_TIMER_DOWN_COUNT(lseq),\r\nASD_NOTIFY_DOWN_COUNT);\r\nasd_write_reg_word(asd_ha, LmSEQ_NOTIFY_TIMER_INITIAL_COUNT(lseq),\r\nASD_NOTIFY_DOWN_COUNT);\r\nfor (i = 0; i < 2; i++) {\r\nint j;\r\nmoffs = LSEQ_PAGE_SIZE + i*LSEQ_MODE_SCRATCH_SIZE;\r\nfor (j = 0; j < LSEQ_PAGE_SIZE; j += 4)\r\nasd_write_reg_dword(asd_ha, LmSCRATCH(lseq)+moffs+j,0);\r\n}\r\nasd_write_reg_dword(asd_ha, LmSEQ_INVALID_DWORD_COUNT(lseq), 0);\r\nasd_write_reg_dword(asd_ha, LmSEQ_DISPARITY_ERROR_COUNT(lseq), 0);\r\nasd_write_reg_dword(asd_ha, LmSEQ_LOSS_OF_SYNC_COUNT(lseq), 0);\r\nfor (i = 0; i < LSEQ_PAGE_SIZE; i+=4)\r\nasd_write_reg_dword(asd_ha, LmSEQ_FRAME_TYPE_MASK(lseq)+i, 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_FRAME_TYPE_MASK(lseq), 0xFF);\r\nasd_write_reg_byte(asd_ha, LmSEQ_HASHED_DEST_ADDR_MASK(lseq), 0xFF);\r\nasd_write_reg_byte(asd_ha, LmSEQ_HASHED_DEST_ADDR_MASK(lseq)+1,0xFF);\r\nasd_write_reg_byte(asd_ha, LmSEQ_HASHED_DEST_ADDR_MASK(lseq)+2,0xFF);\r\nasd_write_reg_byte(asd_ha, LmSEQ_HASHED_SRC_ADDR_MASK(lseq), 0xFF);\r\nasd_write_reg_byte(asd_ha, LmSEQ_HASHED_SRC_ADDR_MASK(lseq)+1, 0xFF);\r\nasd_write_reg_byte(asd_ha, LmSEQ_HASHED_SRC_ADDR_MASK(lseq)+2, 0xFF);\r\nasd_write_reg_dword(asd_ha, LmSEQ_DATA_OFFSET(lseq), 0xFFFFFFFF);\r\nasd_write_reg_dword(asd_ha, LmSEQ_SMP_RCV_TIMER_TERM_TS(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_DEVICE_BITS(lseq), 0);\r\nasd_write_reg_word(asd_ha, LmSEQ_SDB_DDB(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_SDB_NUM_TAGS(lseq), 0);\r\nasd_write_reg_byte(asd_ha, LmSEQ_SDB_CURR_TAG(lseq), 0);\r\nasd_write_reg_dword(asd_ha, LmSEQ_TX_ID_ADDR_FRAME(lseq), 0);\r\nasd_write_reg_dword(asd_ha, LmSEQ_TX_ID_ADDR_FRAME(lseq)+4, 0);\r\nasd_write_reg_dword(asd_ha, LmSEQ_OPEN_TIMER_TERM_TS(lseq), 0);\r\nasd_write_reg_dword(asd_ha, LmSEQ_SRST_AS_TIMER_TERM_TS(lseq), 0);\r\nasd_write_reg_dword(asd_ha, LmSEQ_LAST_LOADED_SG_EL(lseq), 0);\r\nasd_write_reg_dword(asd_ha, LmSEQ_STP_SHUTDOWN_TIMER_TERM_TS(lseq),0);\r\nasd_write_reg_dword(asd_ha, LmSEQ_CLOSE_TIMER_TERM_TS(lseq), 0);\r\nasd_write_reg_dword(asd_ha, LmSEQ_BREAK_TIMER_TERM_TS(lseq), 0);\r\nasd_write_reg_dword(asd_ha, LmSEQ_DWS_RESET_TIMER_TERM_TS(lseq), 0);\r\nasd_write_reg_dword(asd_ha,LmSEQ_SATA_INTERLOCK_TIMER_TERM_TS(lseq),0);\r\nasd_write_reg_dword(asd_ha, LmSEQ_MCTL_TIMER_TERM_TS(lseq), 0);\r\nasd_write_reg_dword(asd_ha, LmSEQ_COMINIT_TIMER_TERM_TS(lseq), 0);\r\nasd_write_reg_dword(asd_ha, LmSEQ_RCV_ID_TIMER_TERM_TS(lseq), 0);\r\nasd_write_reg_dword(asd_ha, LmSEQ_RCV_FIS_TIMER_TERM_TS(lseq), 0);\r\nasd_write_reg_dword(asd_ha, LmSEQ_DEV_PRES_TIMER_TERM_TS(lseq), 0);\r\n}\r\nstatic void asd_init_lseq_scratch(struct asd_ha_struct *asd_ha)\r\n{\r\nu8 lseq;\r\nu8 lseq_mask;\r\nlseq_mask = asd_ha->hw_prof.enabled_phys;\r\nfor_each_sequencer(lseq_mask, lseq_mask, lseq) {\r\nasd_init_lseq_mip(asd_ha, lseq);\r\nasd_init_lseq_mdp(asd_ha, lseq);\r\n}\r\n}\r\nstatic void asd_init_scb_sites(struct asd_ha_struct *asd_ha)\r\n{\r\nu16 site_no;\r\nu16 max_scbs = 0;\r\nfor (site_no = asd_ha->hw_prof.max_scbs-1;\r\nsite_no != (u16) -1;\r\nsite_no--) {\r\nu16 i;\r\nfor (i = 0; i < ASD_SCB_SIZE; i += 4)\r\nasd_scbsite_write_dword(asd_ha, site_no, i, 0);\r\nasd_scbsite_write_byte(asd_ha, site_no,\r\noffsetof(struct scb_header, opcode),\r\n0xFF);\r\nasd_scbsite_write_byte(asd_ha, site_no, 0x49, 0x01);\r\nif (!SCB_SITE_VALID(site_no))\r\ncontinue;\r\nif (last_scb_site_no == 0)\r\nlast_scb_site_no = site_no;\r\nasd_scbsite_write_word(asd_ha, site_no, 0, first_scb_site_no);\r\nfirst_scb_site_no = site_no;\r\nmax_scbs++;\r\n}\r\nasd_ha->hw_prof.max_scbs = max_scbs;\r\nASD_DPRINTK("max_scbs:%d\n", asd_ha->hw_prof.max_scbs);\r\nASD_DPRINTK("first_scb_site_no:0x%x\n", first_scb_site_no);\r\nASD_DPRINTK("last_scb_site_no:0x%x\n", last_scb_site_no);\r\n}\r\nstatic void asd_init_cseq_cio(struct asd_ha_struct *asd_ha)\r\n{\r\nint i;\r\nasd_write_reg_byte(asd_ha, CSEQCOMINTEN, 0);\r\nasd_write_reg_byte(asd_ha, CSEQDLCTL, ASD_DL_SIZE_BITS);\r\nasd_write_reg_byte(asd_ha, CSEQDLOFFS, 0);\r\nasd_write_reg_byte(asd_ha, CSEQDLOFFS+1, 0);\r\nasd_ha->seq.scbpro = 0;\r\nasd_write_reg_dword(asd_ha, SCBPRO, 0);\r\nasd_write_reg_dword(asd_ha, CSEQCON, 0);\r\nasd_write_reg_word(asd_ha, CM11INTVEC0, cseq_vecs[0]);\r\nasd_write_reg_word(asd_ha, CM11INTVEC1, cseq_vecs[1]);\r\nasd_write_reg_word(asd_ha, CM11INTVEC2, cseq_vecs[2]);\r\nasd_write_reg_byte(asd_ha, CARP2INTEN, EN_ARP2HALTC);\r\nasd_write_reg_byte(asd_ha, CSCRATCHPAGE, 0x04);\r\nfor (i = 0; i < 9; i++)\r\nasd_write_reg_byte(asd_ha, CMnSCRATCHPAGE(i), 0);\r\nasd_write_reg_word(asd_ha, CPRGMCNT, cseq_idle_loop);\r\nfor (i = 0; i < 8; i++) {\r\nasd_write_reg_dword(asd_ha, CMnINTEN(i), EN_CMnRSPMBXF);\r\nasd_write_reg_dword(asd_ha, CMnREQMBX(i), 0);\r\n}\r\n}\r\nstatic void asd_init_lseq_cio(struct asd_ha_struct *asd_ha, int lseq)\r\n{\r\nu8 *sas_addr;\r\nint i;\r\nasd_write_reg_dword(asd_ha, LmARP2INTEN(lseq), EN_ARP2HALTC);\r\nasd_write_reg_byte(asd_ha, LmSCRATCHPAGE(lseq), 0);\r\nfor (i = 0; i < 3; i++)\r\nasd_write_reg_byte(asd_ha, LmMnSCRATCHPAGE(lseq, i), 0);\r\nasd_write_reg_byte(asd_ha, LmMnSCRATCHPAGE(lseq, 5), 0);\r\nasd_write_reg_dword(asd_ha, LmRSPMBX(lseq), 0);\r\nasd_write_reg_dword(asd_ha, LmMnINTEN(lseq, 0), LmM0INTEN_MASK);\r\nasd_write_reg_dword(asd_ha, LmMnINT(lseq, 0), 0xFFFFFFFF);\r\nasd_write_reg_dword(asd_ha, LmMnINTEN(lseq, 1), LmM1INTEN_MASK);\r\nasd_write_reg_dword(asd_ha, LmMnINT(lseq, 1), 0xFFFFFFFF);\r\nasd_write_reg_dword(asd_ha, LmMnINTEN(lseq, 2), LmM2INTEN_MASK);\r\nasd_write_reg_dword(asd_ha, LmMnINT(lseq, 2), 0xFFFFFFFF);\r\nasd_write_reg_dword(asd_ha, LmMnINTEN(lseq, 5), LmM5INTEN_MASK);\r\nasd_write_reg_dword(asd_ha, LmMnINT(lseq, 5), 0xFFFFFFFF);\r\nasd_write_reg_byte(asd_ha, LmHWTSTATEN(lseq), LmHWTSTATEN_MASK);\r\nasd_write_reg_dword(asd_ha, LmPRIMSTAT0EN(lseq), LmPRIMSTAT0EN_MASK);\r\nasd_write_reg_dword(asd_ha, LmPRIMSTAT1EN(lseq), LmPRIMSTAT1EN_MASK);\r\nasd_write_reg_dword(asd_ha, LmFRMERREN(lseq), LmFRMERREN_MASK);\r\nasd_write_reg_byte(asd_ha, LmMnHOLDLVL(lseq, 0), 0x50);\r\nasd_write_reg_byte(asd_ha, LmMnXFRLVL(lseq, 0), LmMnXFRLVL_512);\r\nasd_write_reg_byte(asd_ha, LmMnXFRLVL(lseq, 1), LmMnXFRLVL_256);\r\nasd_write_reg_word(asd_ha, LmPRGMCNT(lseq), lseq_idle_loop);\r\nasd_write_reg_dword(asd_ha, LmMODECTL(lseq), LmBLIND48);\r\nasd_write_reg_word(asd_ha, LmM3SATATIMER(lseq),\r\nASD_SATA_INTERLOCK_TIMEOUT);\r\n(void) asd_read_reg_dword(asd_ha, LmREQMBX(lseq));\r\nasd_write_reg_dword(asd_ha, LmPRMSTAT0(lseq), 0xFFFFFFFF);\r\nasd_write_reg_dword(asd_ha, LmPRMSTAT1(lseq), 0xFFFFFFFF);\r\nasd_write_reg_byte(asd_ha, LmHWTSTAT(lseq), 0xFF);\r\nasd_write_reg_byte(asd_ha, LmMnDMAERRS(lseq, 0), 0xFF);\r\nasd_write_reg_byte(asd_ha, LmMnDMAERRS(lseq, 1), 0xFF);\r\nasd_write_reg_byte(asd_ha, LmMnSGDMAERRS(lseq, 0), 0xFF);\r\nasd_write_reg_byte(asd_ha, LmMnSGDMAERRS(lseq, 1), 0xFF);\r\nasd_write_reg_byte(asd_ha, LmMnBUFSTAT(lseq, 0), LmMnBUFPERR);\r\nasd_write_reg_dword(asd_ha, LmMnFRMERR(lseq, 0), 0xFFFFFFFF);\r\nasd_write_reg_byte(asd_ha, LmARP2INTCTL(lseq), RSTINTCTL);\r\nsas_addr = asd_ha->phys[lseq].phy_desc->sas_addr;\r\nfor (i = 0; i < SAS_ADDR_SIZE; i++)\r\nasd_write_reg_byte(asd_ha, LmWWN(lseq) + i, sas_addr[i]);\r\nasd_write_reg_byte(asd_ha, LmMnXMTSIZE(lseq, 1), 0);\r\nasd_write_reg_word(asd_ha, LmBITL_TIMER(lseq), 9);\r\nasd_write_reg_byte(asd_ha, LmMnSATAFS(lseq, 1), 0x80);\r\nasd_write_reg_word(asd_ha, LmM3INTVEC0(lseq), lseq_vecs[0]);\r\nasd_write_reg_word(asd_ha, LmM3INTVEC1(lseq), lseq_vecs[1]);\r\nasd_write_reg_word(asd_ha, LmM3INTVEC2(lseq), lseq_vecs[2]);\r\nasd_write_reg_word(asd_ha, LmM3INTVEC3(lseq), lseq_vecs[3]);\r\nasd_write_reg_word(asd_ha, LmM3INTVEC4(lseq), lseq_vecs[4]);\r\nasd_write_reg_word(asd_ha, LmM3INTVEC5(lseq), lseq_vecs[5]);\r\nasd_write_reg_word(asd_ha, LmM3INTVEC6(lseq), lseq_vecs[6]);\r\nasd_write_reg_word(asd_ha, LmM3INTVEC7(lseq), lseq_vecs[7]);\r\nasd_write_reg_word(asd_ha, LmM3INTVEC8(lseq), lseq_vecs[8]);\r\nasd_write_reg_word(asd_ha, LmM3INTVEC9(lseq), lseq_vecs[9]);\r\nasd_write_reg_word(asd_ha, LmM3INTVEC10(lseq), lseq_vecs[10]);\r\nasd_write_reg_dword(asd_ha, LmCONTROL(lseq),\r\n(LEDTIMER | LEDMODE_TXRX | LEDTIMERS_100ms));\r\nasd_write_reg_byte(asd_ha, LmM1SASALIGN(lseq), SAS_ALIGN_DEFAULT);\r\nasd_write_reg_byte(asd_ha, LmM1STPALIGN(lseq), STP_ALIGN_DEFAULT);\r\n}\r\nstatic void asd_post_init_cseq(struct asd_ha_struct *asd_ha)\r\n{\r\nint i;\r\nfor (i = 0; i < 8; i++)\r\nasd_write_reg_dword(asd_ha, CMnINT(i), 0xFFFFFFFF);\r\nfor (i = 0; i < 8; i++)\r\nasd_read_reg_dword(asd_ha, CMnRSPMBX(i));\r\nasd_write_reg_byte(asd_ha, CARP2INTCTL, RSTINTCTL);\r\n}\r\nstatic void asd_init_ddb_0(struct asd_ha_struct *asd_ha)\r\n{\r\nint i;\r\nfor (i = 0; i < sizeof(struct asd_ddb_seq_shared); i+=4)\r\nasd_ddbsite_write_dword(asd_ha, 0, i, 0);\r\nasd_ddbsite_write_word(asd_ha, 0,\r\noffsetof(struct asd_ddb_seq_shared, q_free_ddb_head), 0);\r\nasd_ddbsite_write_word(asd_ha, 0,\r\noffsetof(struct asd_ddb_seq_shared, q_free_ddb_tail),\r\nasd_ha->hw_prof.max_ddbs-1);\r\nasd_ddbsite_write_word(asd_ha, 0,\r\noffsetof(struct asd_ddb_seq_shared, q_free_ddb_cnt), 0);\r\nasd_ddbsite_write_word(asd_ha, 0,\r\noffsetof(struct asd_ddb_seq_shared, q_used_ddb_head), 0xFFFF);\r\nasd_ddbsite_write_word(asd_ha, 0,\r\noffsetof(struct asd_ddb_seq_shared, q_used_ddb_tail), 0xFFFF);\r\nasd_ddbsite_write_word(asd_ha, 0,\r\noffsetof(struct asd_ddb_seq_shared, shared_mem_lock), 0);\r\nasd_ddbsite_write_word(asd_ha, 0,\r\noffsetof(struct asd_ddb_seq_shared, smp_conn_tag), 0);\r\nasd_ddbsite_write_word(asd_ha, 0,\r\noffsetof(struct asd_ddb_seq_shared, est_nexus_buf_cnt), 0);\r\nasd_ddbsite_write_word(asd_ha, 0,\r\noffsetof(struct asd_ddb_seq_shared, est_nexus_buf_thresh),\r\nasd_ha->hw_prof.num_phys * 2);\r\nasd_ddbsite_write_byte(asd_ha, 0,\r\noffsetof(struct asd_ddb_seq_shared, settable_max_contexts),0);\r\nasd_ddbsite_write_byte(asd_ha, 0,\r\noffsetof(struct asd_ddb_seq_shared, conn_not_active), 0xFF);\r\nasd_ddbsite_write_byte(asd_ha, 0,\r\noffsetof(struct asd_ddb_seq_shared, phy_is_up), 0x00);\r\nset_bit(0, asd_ha->hw_prof.ddb_bitmap);\r\n}\r\nstatic void asd_seq_init_ddb_sites(struct asd_ha_struct *asd_ha)\r\n{\r\nunsigned int i;\r\nunsigned int ddb_site;\r\nfor (ddb_site = 0 ; ddb_site < ASD_MAX_DDBS; ddb_site++)\r\nfor (i = 0; i < sizeof(struct asd_ddb_ssp_smp_target_port); i+= 4)\r\nasd_ddbsite_write_dword(asd_ha, ddb_site, i, 0);\r\n}\r\nstatic void asd_seq_setup_seqs(struct asd_ha_struct *asd_ha)\r\n{\r\nint lseq;\r\nu8 lseq_mask;\r\nasd_seq_init_ddb_sites(asd_ha);\r\nasd_init_scb_sites(asd_ha);\r\nasd_init_cseq_scratch(asd_ha);\r\nasd_init_lseq_scratch(asd_ha);\r\nasd_init_cseq_cio(asd_ha);\r\nasd_init_ddb_0(asd_ha);\r\nlseq_mask = asd_ha->hw_prof.enabled_phys;\r\nfor_each_sequencer(lseq_mask, lseq_mask, lseq)\r\nasd_init_lseq_cio(asd_ha, lseq);\r\nasd_post_init_cseq(asd_ha);\r\n}\r\nstatic int asd_seq_start_cseq(struct asd_ha_struct *asd_ha)\r\n{\r\nasd_write_reg_word(asd_ha, CPRGMCNT, cseq_idle_loop);\r\nreturn asd_unpause_cseq(asd_ha);\r\n}\r\nstatic int asd_seq_start_lseq(struct asd_ha_struct *asd_ha, int lseq)\r\n{\r\nasd_write_reg_word(asd_ha, LmPRGMCNT(lseq), lseq_idle_loop);\r\nreturn asd_seq_unpause_lseq(asd_ha, lseq);\r\n}\r\nint asd_release_firmware(void)\r\n{\r\nrelease_firmware(sequencer_fw);\r\nreturn 0;\r\n}\r\nstatic int asd_request_firmware(struct asd_ha_struct *asd_ha)\r\n{\r\nint err, i;\r\nstruct sequencer_file_header header;\r\nconst struct sequencer_file_header *hdr_ptr;\r\nu32 csum = 0;\r\nu16 *ptr_cseq_vecs, *ptr_lseq_vecs;\r\nif (sequencer_fw)\r\nreturn 0;\r\nerr = request_firmware(&sequencer_fw,\r\nSAS_RAZOR_SEQUENCER_FW_FILE,\r\n&asd_ha->pcidev->dev);\r\nif (err)\r\nreturn err;\r\nhdr_ptr = (const struct sequencer_file_header *)sequencer_fw->data;\r\nheader.csum = le32_to_cpu(hdr_ptr->csum);\r\nheader.major = le32_to_cpu(hdr_ptr->major);\r\nheader.minor = le32_to_cpu(hdr_ptr->minor);\r\nheader.cseq_table_offset = le32_to_cpu(hdr_ptr->cseq_table_offset);\r\nheader.cseq_table_size = le32_to_cpu(hdr_ptr->cseq_table_size);\r\nheader.lseq_table_offset = le32_to_cpu(hdr_ptr->lseq_table_offset);\r\nheader.lseq_table_size = le32_to_cpu(hdr_ptr->lseq_table_size);\r\nheader.cseq_code_offset = le32_to_cpu(hdr_ptr->cseq_code_offset);\r\nheader.cseq_code_size = le32_to_cpu(hdr_ptr->cseq_code_size);\r\nheader.lseq_code_offset = le32_to_cpu(hdr_ptr->lseq_code_offset);\r\nheader.lseq_code_size = le32_to_cpu(hdr_ptr->lseq_code_size);\r\nheader.mode2_task = le16_to_cpu(hdr_ptr->mode2_task);\r\nheader.cseq_idle_loop = le16_to_cpu(hdr_ptr->cseq_idle_loop);\r\nheader.lseq_idle_loop = le16_to_cpu(hdr_ptr->lseq_idle_loop);\r\nfor (i = sizeof(header.csum); i < sequencer_fw->size; i++)\r\ncsum += sequencer_fw->data[i];\r\nif (csum != header.csum) {\r\nasd_printk("Firmware file checksum mismatch\n");\r\nreturn -EINVAL;\r\n}\r\nif (header.cseq_table_size != CSEQ_NUM_VECS ||\r\nheader.lseq_table_size != LSEQ_NUM_VECS) {\r\nasd_printk("Firmware file table size mismatch\n");\r\nreturn -EINVAL;\r\n}\r\nasd_printk("Found sequencer Firmware version %d.%d (%s)\n",\r\nheader.major, header.minor, hdr_ptr->version);\r\nif (header.major != SAS_RAZOR_SEQUENCER_FW_MAJOR) {\r\nasd_printk("Firmware Major Version Mismatch;"\r\n"driver requires version %d.X",\r\nSAS_RAZOR_SEQUENCER_FW_MAJOR);\r\nreturn -EINVAL;\r\n}\r\nptr_cseq_vecs = (u16 *)&sequencer_fw->data[header.cseq_table_offset];\r\nptr_lseq_vecs = (u16 *)&sequencer_fw->data[header.lseq_table_offset];\r\nmode2_task = header.mode2_task;\r\ncseq_idle_loop = header.cseq_idle_loop;\r\nlseq_idle_loop = header.lseq_idle_loop;\r\nfor (i = 0; i < CSEQ_NUM_VECS; i++)\r\ncseq_vecs[i] = le16_to_cpu(ptr_cseq_vecs[i]);\r\nfor (i = 0; i < LSEQ_NUM_VECS; i++)\r\nlseq_vecs[i] = le16_to_cpu(ptr_lseq_vecs[i]);\r\ncseq_code = &sequencer_fw->data[header.cseq_code_offset];\r\ncseq_code_size = header.cseq_code_size;\r\nlseq_code = &sequencer_fw->data[header.lseq_code_offset];\r\nlseq_code_size = header.lseq_code_size;\r\nreturn 0;\r\n}\r\nint asd_init_seqs(struct asd_ha_struct *asd_ha)\r\n{\r\nint err;\r\nerr = asd_request_firmware(asd_ha);\r\nif (err) {\r\nasd_printk("Failed to load sequencer firmware file %s, error %d\n",\r\nSAS_RAZOR_SEQUENCER_FW_FILE, err);\r\nreturn err;\r\n}\r\nerr = asd_seq_download_seqs(asd_ha);\r\nif (err) {\r\nasd_printk("couldn't download sequencers for %s\n",\r\npci_name(asd_ha->pcidev));\r\nreturn err;\r\n}\r\nasd_seq_setup_seqs(asd_ha);\r\nreturn 0;\r\n}\r\nint asd_start_seqs(struct asd_ha_struct *asd_ha)\r\n{\r\nint err;\r\nu8 lseq_mask;\r\nint lseq;\r\nerr = asd_seq_start_cseq(asd_ha);\r\nif (err) {\r\nasd_printk("couldn't start CSEQ for %s\n",\r\npci_name(asd_ha->pcidev));\r\nreturn err;\r\n}\r\nlseq_mask = asd_ha->hw_prof.enabled_phys;\r\nfor_each_sequencer(lseq_mask, lseq_mask, lseq) {\r\nerr = asd_seq_start_lseq(asd_ha, lseq);\r\nif (err) {\r\nasd_printk("couldn't start LSEQ %d for %s\n", lseq,\r\npci_name(asd_ha->pcidev));\r\nreturn err;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nvoid asd_update_port_links(struct asd_ha_struct *asd_ha, struct asd_phy *phy)\r\n{\r\nconst u8 phy_mask = (u8) phy->asd_port->phy_mask;\r\nu8 phy_is_up;\r\nu8 mask;\r\nint i, err;\r\nunsigned long flags;\r\nspin_lock_irqsave(&asd_ha->hw_prof.ddb_lock, flags);\r\nfor_each_phy(phy_mask, mask, i)\r\nasd_ddbsite_write_byte(asd_ha, 0,\r\noffsetof(struct asd_ddb_seq_shared,\r\nport_map_by_links)+i,phy_mask);\r\nfor (i = 0; i < 12; i++) {\r\nphy_is_up = asd_ddbsite_read_byte(asd_ha, 0,\r\noffsetof(struct asd_ddb_seq_shared, phy_is_up));\r\nerr = asd_ddbsite_update_byte(asd_ha, 0,\r\noffsetof(struct asd_ddb_seq_shared, phy_is_up),\r\nphy_is_up,\r\nphy_is_up | phy_mask);\r\nif (!err)\r\nbreak;\r\nelse if (err == -EFAULT) {\r\nasd_printk("phy_is_up: parity error in DDB 0\n");\r\nbreak;\r\n}\r\n}\r\nspin_unlock_irqrestore(&asd_ha->hw_prof.ddb_lock, flags);\r\nif (err)\r\nasd_printk("couldn't update DDB 0:error:%d\n", err);\r\n}

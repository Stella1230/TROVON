static int kirkwood_get_temp(struct thermal_zone_device *thermal,\r\nint *temp)\r\n{\r\nunsigned long reg;\r\nstruct kirkwood_thermal_priv *priv = thermal->devdata;\r\nreg = readl_relaxed(priv->sensor);\r\nif (!((reg >> KIRKWOOD_THERMAL_VALID_OFFSET) &\r\nKIRKWOOD_THERMAL_VALID_MASK)) {\r\ndev_err(&thermal->device,\r\n"Temperature sensor reading not valid\n");\r\nreturn -EIO;\r\n}\r\nreg = (reg >> KIRKWOOD_THERMAL_TEMP_OFFSET) &\r\nKIRKWOOD_THERMAL_TEMP_MASK;\r\n*temp = ((3220000000UL - (10000000UL * reg)) / 13625);\r\nreturn 0;\r\n}\r\nstatic int kirkwood_thermal_probe(struct platform_device *pdev)\r\n{\r\nstruct thermal_zone_device *thermal = NULL;\r\nstruct kirkwood_thermal_priv *priv;\r\nstruct resource *res;\r\npriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\npriv->sensor = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(priv->sensor))\r\nreturn PTR_ERR(priv->sensor);\r\nthermal = thermal_zone_device_register("kirkwood_thermal", 0, 0,\r\npriv, &ops, NULL, 0, 0);\r\nif (IS_ERR(thermal)) {\r\ndev_err(&pdev->dev,\r\n"Failed to register thermal zone device\n");\r\nreturn PTR_ERR(thermal);\r\n}\r\nplatform_set_drvdata(pdev, thermal);\r\nreturn 0;\r\n}\r\nstatic int kirkwood_thermal_exit(struct platform_device *pdev)\r\n{\r\nstruct thermal_zone_device *kirkwood_thermal =\r\nplatform_get_drvdata(pdev);\r\nthermal_zone_device_unregister(kirkwood_thermal);\r\nreturn 0;\r\n}

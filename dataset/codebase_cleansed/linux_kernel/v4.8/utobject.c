union acpi_operand_object *acpi_ut_create_internal_object_dbg(const char\r\n*module_name,\r\nu32 line_number,\r\nu32 component_id,\r\nacpi_object_type\r\ntype)\r\n{\r\nunion acpi_operand_object *object;\r\nunion acpi_operand_object *second_object;\r\nACPI_FUNCTION_TRACE_STR(ut_create_internal_object_dbg,\r\nacpi_ut_get_type_name(type));\r\nobject =\r\nacpi_ut_allocate_object_desc_dbg(module_name, line_number,\r\ncomponent_id);\r\nif (!object) {\r\nreturn_PTR(NULL);\r\n}\r\nswitch (type) {\r\ncase ACPI_TYPE_REGION:\r\ncase ACPI_TYPE_BUFFER_FIELD:\r\ncase ACPI_TYPE_LOCAL_BANK_FIELD:\r\nsecond_object =\r\nacpi_ut_allocate_object_desc_dbg(module_name, line_number,\r\ncomponent_id);\r\nif (!second_object) {\r\nacpi_ut_delete_object_desc(object);\r\nreturn_PTR(NULL);\r\n}\r\nsecond_object->common.type = ACPI_TYPE_LOCAL_EXTRA;\r\nsecond_object->common.reference_count = 1;\r\nobject->common.next_object = second_object;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nobject->common.type = (u8) type;\r\nobject->common.reference_count = 1;\r\nreturn_PTR(object);\r\n}\r\nunion acpi_operand_object *acpi_ut_create_package_object(u32 count)\r\n{\r\nunion acpi_operand_object *package_desc;\r\nunion acpi_operand_object **package_elements;\r\nACPI_FUNCTION_TRACE_U32(ut_create_package_object, count);\r\npackage_desc = acpi_ut_create_internal_object(ACPI_TYPE_PACKAGE);\r\nif (!package_desc) {\r\nreturn_PTR(NULL);\r\n}\r\npackage_elements = ACPI_ALLOCATE_ZEROED(((acpi_size)count +\r\n1) * sizeof(void *));\r\nif (!package_elements) {\r\nACPI_FREE(package_desc);\r\nreturn_PTR(NULL);\r\n}\r\npackage_desc->package.count = count;\r\npackage_desc->package.elements = package_elements;\r\nreturn_PTR(package_desc);\r\n}\r\nunion acpi_operand_object *acpi_ut_create_integer_object(u64 initial_value)\r\n{\r\nunion acpi_operand_object *integer_desc;\r\nACPI_FUNCTION_TRACE(ut_create_integer_object);\r\ninteger_desc = acpi_ut_create_internal_object(ACPI_TYPE_INTEGER);\r\nif (!integer_desc) {\r\nreturn_PTR(NULL);\r\n}\r\ninteger_desc->integer.value = initial_value;\r\nreturn_PTR(integer_desc);\r\n}\r\nunion acpi_operand_object *acpi_ut_create_buffer_object(acpi_size buffer_size)\r\n{\r\nunion acpi_operand_object *buffer_desc;\r\nu8 *buffer = NULL;\r\nACPI_FUNCTION_TRACE_U32(ut_create_buffer_object, buffer_size);\r\nbuffer_desc = acpi_ut_create_internal_object(ACPI_TYPE_BUFFER);\r\nif (!buffer_desc) {\r\nreturn_PTR(NULL);\r\n}\r\nif (buffer_size > 0) {\r\nbuffer = ACPI_ALLOCATE_ZEROED(buffer_size);\r\nif (!buffer) {\r\nACPI_ERROR((AE_INFO, "Could not allocate size %u",\r\n(u32)buffer_size));\r\nacpi_ut_remove_reference(buffer_desc);\r\nreturn_PTR(NULL);\r\n}\r\n}\r\nbuffer_desc->buffer.flags |= AOPOBJ_DATA_VALID;\r\nbuffer_desc->buffer.pointer = buffer;\r\nbuffer_desc->buffer.length = (u32) buffer_size;\r\nreturn_PTR(buffer_desc);\r\n}\r\nunion acpi_operand_object *acpi_ut_create_string_object(acpi_size string_size)\r\n{\r\nunion acpi_operand_object *string_desc;\r\nchar *string;\r\nACPI_FUNCTION_TRACE_U32(ut_create_string_object, string_size);\r\nstring_desc = acpi_ut_create_internal_object(ACPI_TYPE_STRING);\r\nif (!string_desc) {\r\nreturn_PTR(NULL);\r\n}\r\nstring = ACPI_ALLOCATE_ZEROED(string_size + 1);\r\nif (!string) {\r\nACPI_ERROR((AE_INFO, "Could not allocate size %u",\r\n(u32)string_size));\r\nacpi_ut_remove_reference(string_desc);\r\nreturn_PTR(NULL);\r\n}\r\nstring_desc->string.pointer = string;\r\nstring_desc->string.length = (u32) string_size;\r\nreturn_PTR(string_desc);\r\n}\r\nu8 acpi_ut_valid_internal_object(void *object)\r\n{\r\nACPI_FUNCTION_NAME(ut_valid_internal_object);\r\nif (!object) {\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC, "**** Null Object Ptr\n"));\r\nreturn (FALSE);\r\n}\r\nswitch (ACPI_GET_DESCRIPTOR_TYPE(object)) {\r\ncase ACPI_DESC_TYPE_OPERAND:\r\nreturn (TRUE);\r\ndefault:\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC,\r\n"%p is not an ACPI operand obj [%s]\n",\r\nobject, acpi_ut_get_descriptor_name(object)));\r\nbreak;\r\n}\r\nreturn (FALSE);\r\n}\r\nvoid *acpi_ut_allocate_object_desc_dbg(const char *module_name,\r\nu32 line_number, u32 component_id)\r\n{\r\nunion acpi_operand_object *object;\r\nACPI_FUNCTION_TRACE(ut_allocate_object_desc_dbg);\r\nobject = acpi_os_acquire_object(acpi_gbl_operand_cache);\r\nif (!object) {\r\nACPI_ERROR((module_name, line_number,\r\n"Could not allocate an object descriptor"));\r\nreturn_PTR(NULL);\r\n}\r\nACPI_SET_DESCRIPTOR_TYPE(object, ACPI_DESC_TYPE_OPERAND);\r\nACPI_DEBUG_PRINT((ACPI_DB_ALLOCATIONS, "%p Size %X\n",\r\nobject, (u32) sizeof(union acpi_operand_object)));\r\nreturn_PTR(object);\r\n}\r\nvoid acpi_ut_delete_object_desc(union acpi_operand_object *object)\r\n{\r\nACPI_FUNCTION_TRACE_PTR(ut_delete_object_desc, object);\r\nif (ACPI_GET_DESCRIPTOR_TYPE(object) != ACPI_DESC_TYPE_OPERAND) {\r\nACPI_ERROR((AE_INFO,\r\n"%p is not an ACPI Operand object [%s]", object,\r\nacpi_ut_get_descriptor_name(object)));\r\nreturn_VOID;\r\n}\r\n(void)acpi_os_release_object(acpi_gbl_operand_cache, object);\r\nreturn_VOID;\r\n}\r\nstatic acpi_status\r\nacpi_ut_get_simple_object_size(union acpi_operand_object *internal_object,\r\nacpi_size *obj_length)\r\n{\r\nacpi_size length;\r\nacpi_size size;\r\nacpi_status status = AE_OK;\r\nACPI_FUNCTION_TRACE_PTR(ut_get_simple_object_size, internal_object);\r\nlength = sizeof(union acpi_object);\r\nif (!internal_object) {\r\n*obj_length = ACPI_ROUND_UP_TO_NATIVE_WORD(length);\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nif (ACPI_GET_DESCRIPTOR_TYPE(internal_object) == ACPI_DESC_TYPE_NAMED) {\r\nreturn_ACPI_STATUS(AE_AML_INTERNAL);\r\n}\r\nswitch (internal_object->common.type) {\r\ncase ACPI_TYPE_STRING:\r\nlength += (acpi_size)internal_object->string.length + 1;\r\nbreak;\r\ncase ACPI_TYPE_BUFFER:\r\nlength += (acpi_size)internal_object->buffer.length;\r\nbreak;\r\ncase ACPI_TYPE_INTEGER:\r\ncase ACPI_TYPE_PROCESSOR:\r\ncase ACPI_TYPE_POWER:\r\nbreak;\r\ncase ACPI_TYPE_LOCAL_REFERENCE:\r\nswitch (internal_object->reference.class) {\r\ncase ACPI_REFCLASS_NAME:\r\nsize =\r\nacpi_ns_get_pathname_length(internal_object->\r\nreference.node);\r\nif (!size) {\r\nreturn_ACPI_STATUS(AE_BAD_PARAMETER);\r\n}\r\nlength += ACPI_ROUND_UP_TO_NATIVE_WORD(size);\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"Cannot convert to external object - "\r\n"unsupported Reference Class [%s] 0x%X in object %p",\r\nacpi_ut_get_reference_name(internal_object),\r\ninternal_object->reference.class,\r\ninternal_object));\r\nstatus = AE_TYPE;\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO, "Cannot convert to external object - "\r\n"unsupported type [%s] 0x%X in object %p",\r\nacpi_ut_get_object_type_name(internal_object),\r\ninternal_object->common.type, internal_object));\r\nstatus = AE_TYPE;\r\nbreak;\r\n}\r\n*obj_length = ACPI_ROUND_UP_TO_NATIVE_WORD(length);\r\nreturn_ACPI_STATUS(status);\r\n}\r\nstatic acpi_status\r\nacpi_ut_get_element_length(u8 object_type,\r\nunion acpi_operand_object *source_object,\r\nunion acpi_generic_state *state, void *context)\r\n{\r\nacpi_status status = AE_OK;\r\nstruct acpi_pkg_info *info = (struct acpi_pkg_info *)context;\r\nacpi_size object_space;\r\nswitch (object_type) {\r\ncase ACPI_COPY_TYPE_SIMPLE:\r\nstatus =\r\nacpi_ut_get_simple_object_size(source_object,\r\n&object_space);\r\nif (ACPI_FAILURE(status)) {\r\nreturn (status);\r\n}\r\ninfo->length += object_space;\r\nbreak;\r\ncase ACPI_COPY_TYPE_PACKAGE:\r\ninfo->num_packages++;\r\nstate->pkg.this_target_obj = NULL;\r\nbreak;\r\ndefault:\r\nreturn (AE_BAD_PARAMETER);\r\n}\r\nreturn (status);\r\n}\r\nstatic acpi_status\r\nacpi_ut_get_package_object_size(union acpi_operand_object *internal_object,\r\nacpi_size *obj_length)\r\n{\r\nacpi_status status;\r\nstruct acpi_pkg_info info;\r\nACPI_FUNCTION_TRACE_PTR(ut_get_package_object_size, internal_object);\r\ninfo.length = 0;\r\ninfo.object_space = 0;\r\ninfo.num_packages = 1;\r\nstatus =\r\nacpi_ut_walk_package_tree(internal_object, NULL,\r\nacpi_ut_get_element_length, &info);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\ninfo.length +=\r\nACPI_ROUND_UP_TO_NATIVE_WORD(sizeof(union acpi_object)) *\r\n(acpi_size)info.num_packages;\r\n*obj_length = info.length;\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status\r\nacpi_ut_get_object_size(union acpi_operand_object *internal_object,\r\nacpi_size *obj_length)\r\n{\r\nacpi_status status;\r\nACPI_FUNCTION_ENTRY();\r\nif ((ACPI_GET_DESCRIPTOR_TYPE(internal_object) ==\r\nACPI_DESC_TYPE_OPERAND) &&\r\n(internal_object->common.type == ACPI_TYPE_PACKAGE)) {\r\nstatus =\r\nacpi_ut_get_package_object_size(internal_object,\r\nobj_length);\r\n} else {\r\nstatus =\r\nacpi_ut_get_simple_object_size(internal_object, obj_length);\r\n}\r\nreturn (status);\r\n}

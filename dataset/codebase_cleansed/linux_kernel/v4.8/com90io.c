static u_char get_buffer_byte(struct net_device *dev, unsigned offset)\r\n{\r\nint ioaddr = dev->base_addr;\r\narcnet_outb(offset >> 8, ioaddr, COM9026_REG_W_ADDR_HI);\r\narcnet_outb(offset & 0xff, ioaddr, COM9026_REG_W_ADDR_LO);\r\nreturn arcnet_inb(ioaddr, COM9026_REG_RW_MEMDATA);\r\n}\r\nstatic void put_buffer_byte(struct net_device *dev, unsigned offset,\r\nu_char datum)\r\n{\r\nint ioaddr = dev->base_addr;\r\narcnet_outb(offset >> 8, ioaddr, COM9026_REG_W_ADDR_HI);\r\narcnet_outb(offset & 0xff, ioaddr, COM9026_REG_W_ADDR_LO);\r\narcnet_outb(datum, ioaddr, COM9026_REG_RW_MEMDATA);\r\n}\r\nstatic void get_whole_buffer(struct net_device *dev, unsigned offset,\r\nunsigned length, char *dest)\r\n{\r\nint ioaddr = dev->base_addr;\r\narcnet_outb((offset >> 8) | AUTOINCflag, ioaddr, COM9026_REG_W_ADDR_HI);\r\narcnet_outb(offset & 0xff, ioaddr, COM9026_REG_W_ADDR_LO);\r\nwhile (length--)\r\n#ifdef ONE_AT_A_TIME_RX\r\n*(dest++) = get_buffer_byte(dev, offset++);\r\n#else\r\n*(dest++) = arcnet_inb(ioaddr, COM9026_REG_RW_MEMDATA);\r\n#endif\r\n}\r\nstatic void put_whole_buffer(struct net_device *dev, unsigned offset,\r\nunsigned length, char *dest)\r\n{\r\nint ioaddr = dev->base_addr;\r\narcnet_outb((offset >> 8) | AUTOINCflag, ioaddr, COM9026_REG_W_ADDR_HI);\r\narcnet_outb(offset & 0xff, ioaddr,COM9026_REG_W_ADDR_LO);\r\nwhile (length--)\r\n#ifdef ONE_AT_A_TIME_TX\r\nput_buffer_byte(dev, offset++, *(dest++));\r\n#else\r\narcnet_outb(*(dest++), ioaddr, COM9026_REG_RW_MEMDATA);\r\n#endif\r\n}\r\nstatic int __init com90io_probe(struct net_device *dev)\r\n{\r\nint ioaddr = dev->base_addr, status;\r\nunsigned long airqmask;\r\nif (BUGLVL(D_NORMAL)) {\r\npr_info("%s\n", "COM90xx IO-mapped mode support (by David Woodhouse et el.)");\r\npr_info("E-mail me if you actually test this driver, please!\n");\r\n}\r\nif (!ioaddr) {\r\narc_printk(D_NORMAL, dev, "No autoprobe for IO mapped cards; you must specify the base address!\n");\r\nreturn -ENODEV;\r\n}\r\nif (!request_region(ioaddr, ARCNET_TOTAL_SIZE, "com90io probe")) {\r\narc_printk(D_INIT_REASONS, dev, "IO request_region %x-%x failed\n",\r\nioaddr, ioaddr + ARCNET_TOTAL_SIZE - 1);\r\nreturn -ENXIO;\r\n}\r\nif (arcnet_inb(ioaddr, COM9026_REG_R_STATUS) == 0xFF) {\r\narc_printk(D_INIT_REASONS, dev, "IO address %x empty\n",\r\nioaddr);\r\ngoto err_out;\r\n}\r\narcnet_inb(ioaddr, COM9026_REG_R_RESET);\r\nmdelay(RESETtime);\r\nstatus = arcnet_inb(ioaddr, COM9026_REG_R_STATUS);\r\nif ((status & 0x9D) != (NORXflag | RECONflag | TXFREEflag | RESETflag)) {\r\narc_printk(D_INIT_REASONS, dev, "Status invalid (%Xh)\n",\r\nstatus);\r\ngoto err_out;\r\n}\r\narc_printk(D_INIT_REASONS, dev, "Status after reset: %X\n", status);\r\narcnet_outb(CFLAGScmd | RESETclear | CONFIGclear,\r\nioaddr, COM9026_REG_W_COMMAND);\r\narc_printk(D_INIT_REASONS, dev, "Status after reset acknowledged: %X\n",\r\nstatus);\r\nstatus = arcnet_inb(ioaddr, COM9026_REG_R_STATUS);\r\nif (status & RESETflag) {\r\narc_printk(D_INIT_REASONS, dev, "Eternal reset (status=%Xh)\n",\r\nstatus);\r\ngoto err_out;\r\n}\r\narcnet_outb((0x16 | IOMAPflag) & ~ENABLE16flag,\r\nioaddr, COM9026_REG_RW_CONFIG);\r\narcnet_outb(AUTOINCflag, ioaddr, COM9026_REG_W_ADDR_HI);\r\narcnet_outb(0, ioaddr, COM9026_REG_W_ADDR_LO);\r\nstatus = arcnet_inb(ioaddr, COM9026_REG_RW_MEMDATA);\r\nif (status != 0xd1) {\r\narc_printk(D_INIT_REASONS, dev, "Signature byte not found (%Xh instead).\n",\r\nstatus);\r\ngoto err_out;\r\n}\r\nif (!dev->irq) {\r\nairqmask = probe_irq_on();\r\narcnet_outb(NORXflag, ioaddr, COM9026_REG_W_INTMASK);\r\nudelay(1);\r\narcnet_outb(0, ioaddr, COM9026_REG_W_INTMASK);\r\ndev->irq = probe_irq_off(airqmask);\r\nif ((int)dev->irq <= 0) {\r\narc_printk(D_INIT_REASONS, dev, "Autoprobe IRQ failed\n");\r\ngoto err_out;\r\n}\r\n}\r\nrelease_region(ioaddr, ARCNET_TOTAL_SIZE);\r\nreturn com90io_found(dev);\r\nerr_out:\r\nrelease_region(ioaddr, ARCNET_TOTAL_SIZE);\r\nreturn -ENODEV;\r\n}\r\nstatic int __init com90io_found(struct net_device *dev)\r\n{\r\nstruct arcnet_local *lp;\r\nint ioaddr = dev->base_addr;\r\nint err;\r\nif (request_irq(dev->irq, arcnet_interrupt, 0,\r\n"arcnet (COM90xx-IO)", dev)) {\r\narc_printk(D_NORMAL, dev, "Can't get IRQ %d!\n", dev->irq);\r\nreturn -ENODEV;\r\n}\r\nif (!request_region(dev->base_addr, ARCNET_TOTAL_SIZE,\r\n"arcnet (COM90xx-IO)")) {\r\nfree_irq(dev->irq, dev);\r\nreturn -EBUSY;\r\n}\r\nlp = netdev_priv(dev);\r\nlp->card_name = "COM90xx I/O";\r\nlp->hw.command = com90io_command;\r\nlp->hw.status = com90io_status;\r\nlp->hw.intmask = com90io_setmask;\r\nlp->hw.reset = com90io_reset;\r\nlp->hw.owner = THIS_MODULE;\r\nlp->hw.copy_to_card = com90io_copy_to_card;\r\nlp->hw.copy_from_card = com90io_copy_from_card;\r\nlp->config = (0x16 | IOMAPflag) & ~ENABLE16flag;\r\narcnet_outb(lp->config, ioaddr, COM9026_REG_RW_CONFIG);\r\ndev->dev_addr[0] = get_buffer_byte(dev, 1);\r\nerr = register_netdev(dev);\r\nif (err) {\r\narcnet_outb(arcnet_inb(ioaddr, COM9026_REG_RW_CONFIG) & ~IOMAPflag,\r\nioaddr, COM9026_REG_RW_CONFIG);\r\nfree_irq(dev->irq, dev);\r\nrelease_region(dev->base_addr, ARCNET_TOTAL_SIZE);\r\nreturn err;\r\n}\r\narc_printk(D_NORMAL, dev, "COM90IO: station %02Xh found at %03lXh, IRQ %d.\n",\r\ndev->dev_addr[0], dev->base_addr, dev->irq);\r\nreturn 0;\r\n}\r\nstatic int com90io_reset(struct net_device *dev, int really_reset)\r\n{\r\nstruct arcnet_local *lp = netdev_priv(dev);\r\nshort ioaddr = dev->base_addr;\r\narc_printk(D_INIT, dev, "Resetting %s (status=%02Xh)\n",\r\ndev->name, arcnet_inb(ioaddr, COM9026_REG_R_STATUS));\r\nif (really_reset) {\r\narcnet_inb(ioaddr, COM9026_REG_R_RESET);\r\nmdelay(RESETtime);\r\n}\r\nlp->config = (0x1C | IOMAPflag) & ~ENABLE16flag;\r\narcnet_outb(lp->config, ioaddr, COM9026_REG_RW_CONFIG);\r\narcnet_outb(CFLAGScmd | RESETclear, ioaddr, COM9026_REG_W_COMMAND);\r\narcnet_outb(CFLAGScmd | CONFIGclear, ioaddr, COM9026_REG_W_COMMAND);\r\nif (get_buffer_byte(dev, 0) != TESTvalue) {\r\narc_printk(D_NORMAL, dev, "reset failed: TESTvalue not present.\n");\r\nreturn 1;\r\n}\r\narcnet_outb(CONFIGcmd | EXTconf, ioaddr, COM9026_REG_W_COMMAND);\r\nreturn 0;\r\n}\r\nstatic void com90io_command(struct net_device *dev, int cmd)\r\n{\r\nshort ioaddr = dev->base_addr;\r\narcnet_outb(cmd, ioaddr, COM9026_REG_W_COMMAND);\r\n}\r\nstatic int com90io_status(struct net_device *dev)\r\n{\r\nshort ioaddr = dev->base_addr;\r\nreturn arcnet_inb(ioaddr, COM9026_REG_R_STATUS);\r\n}\r\nstatic void com90io_setmask(struct net_device *dev, int mask)\r\n{\r\nshort ioaddr = dev->base_addr;\r\narcnet_outb(mask, ioaddr, COM9026_REG_W_INTMASK);\r\n}\r\nstatic void com90io_copy_to_card(struct net_device *dev, int bufnum,\r\nint offset, void *buf, int count)\r\n{\r\nTIME(dev, "put_whole_buffer", count,\r\nput_whole_buffer(dev, bufnum * 512 + offset, count, buf));\r\n}\r\nstatic void com90io_copy_from_card(struct net_device *dev, int bufnum,\r\nint offset, void *buf, int count)\r\n{\r\nTIME(dev, "get_whole_buffer", count,\r\nget_whole_buffer(dev, bufnum * 512 + offset, count, buf));\r\n}\r\nstatic int __init com90io_setup(char *s)\r\n{\r\nint ints[4];\r\ns = get_options(s, 4, ints);\r\nif (!ints[0])\r\nreturn 0;\r\nswitch (ints[0]) {\r\ndefault:\r\npr_err("Too many arguments\n");\r\ncase 2:\r\nirq = ints[2];\r\ncase 1:\r\nio = ints[1];\r\n}\r\nif (*s)\r\nsnprintf(device, sizeof(device), "%s", s);\r\nreturn 1;\r\n}\r\nstatic int __init com90io_init(void)\r\n{\r\nstruct net_device *dev;\r\nint err;\r\ndev = alloc_arcdev(device);\r\nif (!dev)\r\nreturn -ENOMEM;\r\ndev->base_addr = io;\r\ndev->irq = irq;\r\nif (dev->irq == 2)\r\ndev->irq = 9;\r\nerr = com90io_probe(dev);\r\nif (err) {\r\nfree_netdev(dev);\r\nreturn err;\r\n}\r\nmy_dev = dev;\r\nreturn 0;\r\n}\r\nstatic void __exit com90io_exit(void)\r\n{\r\nstruct net_device *dev = my_dev;\r\nint ioaddr = dev->base_addr;\r\nunregister_netdev(dev);\r\narcnet_outb(arcnet_inb(ioaddr, COM9026_REG_RW_CONFIG) & ~IOMAPflag,\r\nioaddr, COM9026_REG_RW_CONFIG);\r\nfree_irq(dev->irq, dev);\r\nrelease_region(dev->base_addr, ARCNET_TOTAL_SIZE);\r\nfree_netdev(dev);\r\n}

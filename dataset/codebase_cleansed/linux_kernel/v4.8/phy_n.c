static inline bool b43_nphy_ipa(struct b43_wldev *dev)\r\n{\r\nenum nl80211_band band = b43_current_band(dev->wl);\r\nreturn ((dev->phy.n->ipa2g_on && band == NL80211_BAND_2GHZ) ||\r\n(dev->phy.n->ipa5g_on && band == NL80211_BAND_5GHZ));\r\n}\r\nstatic u8 b43_nphy_get_rx_core_state(struct b43_wldev *dev)\r\n{\r\nreturn (b43_phy_read(dev, B43_NPHY_RFSEQCA) & B43_NPHY_RFSEQCA_RXEN) >>\r\nB43_NPHY_RFSEQCA_RXEN_SHIFT;\r\n}\r\nstatic void b43_nphy_force_rf_sequence(struct b43_wldev *dev,\r\nenum b43_nphy_rf_sequence seq)\r\n{\r\nstatic const u16 trigger[] = {\r\n[B43_RFSEQ_RX2TX] = B43_NPHY_RFSEQTR_RX2TX,\r\n[B43_RFSEQ_TX2RX] = B43_NPHY_RFSEQTR_TX2RX,\r\n[B43_RFSEQ_RESET2RX] = B43_NPHY_RFSEQTR_RST2RX,\r\n[B43_RFSEQ_UPDATE_GAINH] = B43_NPHY_RFSEQTR_UPGH,\r\n[B43_RFSEQ_UPDATE_GAINL] = B43_NPHY_RFSEQTR_UPGL,\r\n[B43_RFSEQ_UPDATE_GAINU] = B43_NPHY_RFSEQTR_UPGU,\r\n};\r\nint i;\r\nu16 seq_mode = b43_phy_read(dev, B43_NPHY_RFSEQMODE);\r\nB43_WARN_ON(seq >= ARRAY_SIZE(trigger));\r\nb43_phy_set(dev, B43_NPHY_RFSEQMODE,\r\nB43_NPHY_RFSEQMODE_CAOVER | B43_NPHY_RFSEQMODE_TROVER);\r\nb43_phy_set(dev, B43_NPHY_RFSEQTR, trigger[seq]);\r\nfor (i = 0; i < 200; i++) {\r\nif (!(b43_phy_read(dev, B43_NPHY_RFSEQST) & trigger[seq]))\r\ngoto ok;\r\nmsleep(1);\r\n}\r\nb43err(dev->wl, "RF sequence status timeout\n");\r\nok:\r\nb43_phy_write(dev, B43_NPHY_RFSEQMODE, seq_mode);\r\n}\r\nstatic void b43_nphy_rf_ctl_override_rev19(struct b43_wldev *dev, u16 field,\r\nu16 value, u8 core, bool off,\r\nu8 override_id)\r\n{\r\n}\r\nstatic void b43_nphy_rf_ctl_override_rev7(struct b43_wldev *dev, u16 field,\r\nu16 value, u8 core, bool off,\r\nu8 override)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nconst struct nphy_rf_control_override_rev7 *e;\r\nu16 en_addrs[3][2] = {\r\n{ 0x0E7, 0x0EC }, { 0x342, 0x343 }, { 0x346, 0x347 }\r\n};\r\nu16 en_addr;\r\nu16 en_mask = field;\r\nu16 val_addr;\r\nu8 i;\r\nif (phy->rev >= 19 || phy->rev < 3) {\r\nB43_WARN_ON(1);\r\nreturn;\r\n}\r\ne = b43_nphy_get_rf_ctl_over_rev7(dev, field, override);\r\nfor (i = 0; i < 2; i++) {\r\nif (override >= ARRAY_SIZE(en_addrs)) {\r\nb43err(dev->wl, "Invalid override value %d\n", override);\r\nreturn;\r\n}\r\nen_addr = en_addrs[override][i];\r\nif (e)\r\nval_addr = (i == 0) ? e->val_addr_core0 : e->val_addr_core1;\r\nif (off) {\r\nb43_phy_mask(dev, en_addr, ~en_mask);\r\nif (e)\r\nb43_phy_mask(dev, val_addr, ~e->val_mask);\r\n} else {\r\nif (!core || (core & (1 << i))) {\r\nb43_phy_set(dev, en_addr, en_mask);\r\nif (e)\r\nb43_phy_maskset(dev, val_addr, ~e->val_mask, (value << e->val_shift));\r\n}\r\n}\r\n}\r\n}\r\nstatic void b43_nphy_rf_ctl_override_one_to_many(struct b43_wldev *dev,\r\nenum n_rf_ctl_over_cmd cmd,\r\nu16 value, u8 core, bool off)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nu16 tmp;\r\nB43_WARN_ON(phy->rev < 7);\r\nswitch (cmd) {\r\ncase N_RF_CTL_OVER_CMD_RXRF_PU:\r\nb43_nphy_rf_ctl_override_rev7(dev, 0x20, value, core, off, 1);\r\nb43_nphy_rf_ctl_override_rev7(dev, 0x10, value, core, off, 1);\r\nb43_nphy_rf_ctl_override_rev7(dev, 0x08, value, core, off, 1);\r\nbreak;\r\ncase N_RF_CTL_OVER_CMD_RX_PU:\r\nb43_nphy_rf_ctl_override_rev7(dev, 0x4, value, core, off, 1);\r\nb43_nphy_rf_ctl_override_rev7(dev, 0x2, value, core, off, 1);\r\nb43_nphy_rf_ctl_override_rev7(dev, 0x1, value, core, off, 1);\r\nb43_nphy_rf_ctl_override_rev7(dev, 0x2, value, core, off, 2);\r\nb43_nphy_rf_ctl_override_rev7(dev, 0x0800, 0, core, off, 1);\r\nbreak;\r\ncase N_RF_CTL_OVER_CMD_TX_PU:\r\nb43_nphy_rf_ctl_override_rev7(dev, 0x4, value, core, off, 0);\r\nb43_nphy_rf_ctl_override_rev7(dev, 0x2, value, core, off, 1);\r\nb43_nphy_rf_ctl_override_rev7(dev, 0x1, value, core, off, 2);\r\nb43_nphy_rf_ctl_override_rev7(dev, 0x0800, 1, core, off, 1);\r\nbreak;\r\ncase N_RF_CTL_OVER_CMD_RX_GAIN:\r\ntmp = value & 0xFF;\r\nb43_nphy_rf_ctl_override_rev7(dev, 0x0800, tmp, core, off, 0);\r\ntmp = value >> 8;\r\nb43_nphy_rf_ctl_override_rev7(dev, 0x6000, tmp, core, off, 0);\r\nbreak;\r\ncase N_RF_CTL_OVER_CMD_TX_GAIN:\r\ntmp = value & 0x7FFF;\r\nb43_nphy_rf_ctl_override_rev7(dev, 0x1000, tmp, core, off, 0);\r\ntmp = value >> 14;\r\nb43_nphy_rf_ctl_override_rev7(dev, 0x4000, tmp, core, off, 0);\r\nbreak;\r\n}\r\n}\r\nstatic void b43_nphy_rf_ctl_override(struct b43_wldev *dev, u16 field,\r\nu16 value, u8 core, bool off)\r\n{\r\nint i;\r\nu8 index = fls(field);\r\nu8 addr, en_addr, val_addr;\r\nB43_WARN_ON(field & (~(1 << (index - 1))));\r\nif (dev->phy.rev >= 3) {\r\nconst struct nphy_rf_control_override_rev3 *rf_ctrl;\r\nfor (i = 0; i < 2; i++) {\r\nif (index == 0 || index == 16) {\r\nb43err(dev->wl,\r\n"Unsupported RF Ctrl Override call\n");\r\nreturn;\r\n}\r\nrf_ctrl = &tbl_rf_control_override_rev3[index - 1];\r\nen_addr = B43_PHY_N((i == 0) ?\r\nrf_ctrl->en_addr0 : rf_ctrl->en_addr1);\r\nval_addr = B43_PHY_N((i == 0) ?\r\nrf_ctrl->val_addr0 : rf_ctrl->val_addr1);\r\nif (off) {\r\nb43_phy_mask(dev, en_addr, ~(field));\r\nb43_phy_mask(dev, val_addr,\r\n~(rf_ctrl->val_mask));\r\n} else {\r\nif (core == 0 || ((1 << i) & core)) {\r\nb43_phy_set(dev, en_addr, field);\r\nb43_phy_maskset(dev, val_addr,\r\n~(rf_ctrl->val_mask),\r\n(value << rf_ctrl->val_shift));\r\n}\r\n}\r\n}\r\n} else {\r\nconst struct nphy_rf_control_override_rev2 *rf_ctrl;\r\nif (off) {\r\nb43_phy_mask(dev, B43_NPHY_RFCTL_OVER, ~(field));\r\nvalue = 0;\r\n} else {\r\nb43_phy_set(dev, B43_NPHY_RFCTL_OVER, field);\r\n}\r\nfor (i = 0; i < 2; i++) {\r\nif (index <= 1 || index == 16) {\r\nb43err(dev->wl,\r\n"Unsupported RF Ctrl Override call\n");\r\nreturn;\r\n}\r\nif (index == 2 || index == 10 ||\r\n(index >= 13 && index <= 15)) {\r\ncore = 1;\r\n}\r\nrf_ctrl = &tbl_rf_control_override_rev2[index - 2];\r\naddr = B43_PHY_N((i == 0) ?\r\nrf_ctrl->addr0 : rf_ctrl->addr1);\r\nif ((1 << i) & core)\r\nb43_phy_maskset(dev, addr, ~(rf_ctrl->bmask),\r\n(value << rf_ctrl->shift));\r\nb43_phy_set(dev, B43_NPHY_RFCTL_OVER, 0x1);\r\nb43_phy_set(dev, B43_NPHY_RFCTL_CMD,\r\nB43_NPHY_RFCTL_CMD_START);\r\nudelay(1);\r\nb43_phy_mask(dev, B43_NPHY_RFCTL_OVER, 0xFFFE);\r\n}\r\n}\r\n}\r\nstatic void b43_nphy_rf_ctl_intc_override_rev7(struct b43_wldev *dev,\r\nenum n_intc_override intc_override,\r\nu16 value, u8 core_sel)\r\n{\r\nu16 reg, tmp, tmp2, val;\r\nint core;\r\nfor (core = 0; core < 2; core++) {\r\nif ((core_sel == 1 && core != 0) ||\r\n(core_sel == 2 && core != 1))\r\ncontinue;\r\nreg = (core == 0) ? B43_NPHY_RFCTL_INTC1 : B43_NPHY_RFCTL_INTC2;\r\nswitch (intc_override) {\r\ncase N_INTC_OVERRIDE_OFF:\r\nb43_phy_write(dev, reg, 0);\r\nb43_phy_mask(dev, 0x2ff, ~0x2000);\r\nb43_nphy_force_rf_sequence(dev, B43_RFSEQ_RESET2RX);\r\nbreak;\r\ncase N_INTC_OVERRIDE_TRSW:\r\nb43_phy_maskset(dev, reg, ~0xC0, value << 6);\r\nb43_phy_set(dev, reg, 0x400);\r\nb43_phy_mask(dev, 0x2ff, ~0xC000 & 0xFFFF);\r\nb43_phy_set(dev, 0x2ff, 0x2000);\r\nb43_phy_set(dev, 0x2ff, 0x0001);\r\nbreak;\r\ncase N_INTC_OVERRIDE_PA:\r\ntmp = 0x0030;\r\nif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ)\r\nval = value << 5;\r\nelse\r\nval = value << 4;\r\nb43_phy_maskset(dev, reg, ~tmp, val);\r\nb43_phy_set(dev, reg, 0x1000);\r\nbreak;\r\ncase N_INTC_OVERRIDE_EXT_LNA_PU:\r\nif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ) {\r\ntmp = 0x0001;\r\ntmp2 = 0x0004;\r\nval = value;\r\n} else {\r\ntmp = 0x0004;\r\ntmp2 = 0x0001;\r\nval = value << 2;\r\n}\r\nb43_phy_maskset(dev, reg, ~tmp, val);\r\nb43_phy_mask(dev, reg, ~tmp2);\r\nbreak;\r\ncase N_INTC_OVERRIDE_EXT_LNA_GAIN:\r\nif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ) {\r\ntmp = 0x0002;\r\ntmp2 = 0x0008;\r\nval = value << 1;\r\n} else {\r\ntmp = 0x0008;\r\ntmp2 = 0x0002;\r\nval = value << 3;\r\n}\r\nb43_phy_maskset(dev, reg, ~tmp, val);\r\nb43_phy_mask(dev, reg, ~tmp2);\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void b43_nphy_rf_ctl_intc_override(struct b43_wldev *dev,\r\nenum n_intc_override intc_override,\r\nu16 value, u8 core)\r\n{\r\nu8 i, j;\r\nu16 reg, tmp, val;\r\nif (dev->phy.rev >= 7) {\r\nb43_nphy_rf_ctl_intc_override_rev7(dev, intc_override, value,\r\ncore);\r\nreturn;\r\n}\r\nB43_WARN_ON(dev->phy.rev < 3);\r\nfor (i = 0; i < 2; i++) {\r\nif ((core == 1 && i == 1) || (core == 2 && !i))\r\ncontinue;\r\nreg = (i == 0) ?\r\nB43_NPHY_RFCTL_INTC1 : B43_NPHY_RFCTL_INTC2;\r\nb43_phy_set(dev, reg, 0x400);\r\nswitch (intc_override) {\r\ncase N_INTC_OVERRIDE_OFF:\r\nb43_phy_write(dev, reg, 0);\r\nb43_nphy_force_rf_sequence(dev, B43_RFSEQ_RESET2RX);\r\nbreak;\r\ncase N_INTC_OVERRIDE_TRSW:\r\nif (!i) {\r\nb43_phy_maskset(dev, B43_NPHY_RFCTL_INTC1,\r\n0xFC3F, (value << 6));\r\nb43_phy_maskset(dev, B43_NPHY_TXF_40CO_B1S1,\r\n0xFFFE, 1);\r\nb43_phy_set(dev, B43_NPHY_RFCTL_CMD,\r\nB43_NPHY_RFCTL_CMD_START);\r\nfor (j = 0; j < 100; j++) {\r\nif (!(b43_phy_read(dev, B43_NPHY_RFCTL_CMD) & B43_NPHY_RFCTL_CMD_START)) {\r\nj = 0;\r\nbreak;\r\n}\r\nudelay(10);\r\n}\r\nif (j)\r\nb43err(dev->wl,\r\n"intc override timeout\n");\r\nb43_phy_mask(dev, B43_NPHY_TXF_40CO_B1S1,\r\n0xFFFE);\r\n} else {\r\nb43_phy_maskset(dev, B43_NPHY_RFCTL_INTC2,\r\n0xFC3F, (value << 6));\r\nb43_phy_maskset(dev, B43_NPHY_RFCTL_OVER,\r\n0xFFFE, 1);\r\nb43_phy_set(dev, B43_NPHY_RFCTL_CMD,\r\nB43_NPHY_RFCTL_CMD_RXTX);\r\nfor (j = 0; j < 100; j++) {\r\nif (!(b43_phy_read(dev, B43_NPHY_RFCTL_CMD) & B43_NPHY_RFCTL_CMD_RXTX)) {\r\nj = 0;\r\nbreak;\r\n}\r\nudelay(10);\r\n}\r\nif (j)\r\nb43err(dev->wl,\r\n"intc override timeout\n");\r\nb43_phy_mask(dev, B43_NPHY_RFCTL_OVER,\r\n0xFFFE);\r\n}\r\nbreak;\r\ncase N_INTC_OVERRIDE_PA:\r\nif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ) {\r\ntmp = 0x0020;\r\nval = value << 5;\r\n} else {\r\ntmp = 0x0010;\r\nval = value << 4;\r\n}\r\nb43_phy_maskset(dev, reg, ~tmp, val);\r\nbreak;\r\ncase N_INTC_OVERRIDE_EXT_LNA_PU:\r\nif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ) {\r\ntmp = 0x0001;\r\nval = value;\r\n} else {\r\ntmp = 0x0004;\r\nval = value << 2;\r\n}\r\nb43_phy_maskset(dev, reg, ~tmp, val);\r\nbreak;\r\ncase N_INTC_OVERRIDE_EXT_LNA_GAIN:\r\nif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ) {\r\ntmp = 0x0002;\r\nval = value << 1;\r\n} else {\r\ntmp = 0x0008;\r\nval = value << 3;\r\n}\r\nb43_phy_maskset(dev, reg, ~tmp, val);\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void b43_nphy_write_clip_detection(struct b43_wldev *dev,\r\nconst u16 *clip_st)\r\n{\r\nb43_phy_write(dev, B43_NPHY_C1_CLIP1THRES, clip_st[0]);\r\nb43_phy_write(dev, B43_NPHY_C2_CLIP1THRES, clip_st[1]);\r\n}\r\nstatic void b43_nphy_read_clip_detection(struct b43_wldev *dev, u16 *clip_st)\r\n{\r\nclip_st[0] = b43_phy_read(dev, B43_NPHY_C1_CLIP1THRES);\r\nclip_st[1] = b43_phy_read(dev, B43_NPHY_C2_CLIP1THRES);\r\n}\r\nstatic u16 b43_nphy_classifier(struct b43_wldev *dev, u16 mask, u16 val)\r\n{\r\nu16 tmp;\r\nif (dev->dev->core_rev == 16)\r\nb43_mac_suspend(dev);\r\ntmp = b43_phy_read(dev, B43_NPHY_CLASSCTL);\r\ntmp &= (B43_NPHY_CLASSCTL_CCKEN | B43_NPHY_CLASSCTL_OFDMEN |\r\nB43_NPHY_CLASSCTL_WAITEDEN);\r\ntmp &= ~mask;\r\ntmp |= (val & mask);\r\nb43_phy_maskset(dev, B43_NPHY_CLASSCTL, 0xFFF8, tmp);\r\nif (dev->dev->core_rev == 16)\r\nb43_mac_enable(dev);\r\nreturn tmp;\r\n}\r\nstatic void b43_nphy_reset_cca(struct b43_wldev *dev)\r\n{\r\nu16 bbcfg;\r\nb43_phy_force_clock(dev, 1);\r\nbbcfg = b43_phy_read(dev, B43_NPHY_BBCFG);\r\nb43_phy_write(dev, B43_NPHY_BBCFG, bbcfg | B43_NPHY_BBCFG_RSTCCA);\r\nudelay(1);\r\nb43_phy_write(dev, B43_NPHY_BBCFG, bbcfg & ~B43_NPHY_BBCFG_RSTCCA);\r\nb43_phy_force_clock(dev, 0);\r\nb43_nphy_force_rf_sequence(dev, B43_RFSEQ_RESET2RX);\r\n}\r\nstatic void b43_nphy_stay_in_carrier_search(struct b43_wldev *dev, bool enable)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_n *nphy = phy->n;\r\nif (enable) {\r\nstatic const u16 clip[] = { 0xFFFF, 0xFFFF };\r\nif (nphy->deaf_count++ == 0) {\r\nnphy->classifier_state = b43_nphy_classifier(dev, 0, 0);\r\nb43_nphy_classifier(dev, 0x7,\r\nB43_NPHY_CLASSCTL_WAITEDEN);\r\nb43_nphy_read_clip_detection(dev, nphy->clip_state);\r\nb43_nphy_write_clip_detection(dev, clip);\r\n}\r\nb43_nphy_reset_cca(dev);\r\n} else {\r\nif (--nphy->deaf_count == 0) {\r\nb43_nphy_classifier(dev, 0x7, nphy->classifier_state);\r\nb43_nphy_write_clip_detection(dev, nphy->clip_state);\r\n}\r\n}\r\n}\r\nstatic u16 b43_nphy_read_lpf_ctl(struct b43_wldev *dev, u16 offset)\r\n{\r\nif (!offset)\r\noffset = b43_is_40mhz(dev) ? 0x159 : 0x154;\r\nreturn b43_ntab_read(dev, B43_NTAB16(7, offset)) & 0x7;\r\n}\r\nstatic void b43_nphy_adjust_lna_gain_table(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nu8 i;\r\ns16 tmp;\r\nu16 data[4];\r\ns16 gain[2];\r\nu16 minmax[2];\r\nstatic const u16 lna_gain[4] = { -2, 10, 19, 25 };\r\nif (nphy->hang_avoid)\r\nb43_nphy_stay_in_carrier_search(dev, 1);\r\nif (nphy->gain_boost) {\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\r\ngain[0] = 6;\r\ngain[1] = 6;\r\n} else {\r\ntmp = 40370 - 315 * dev->phy.channel;\r\ngain[0] = ((tmp >> 13) + ((tmp >> 12) & 1));\r\ntmp = 23242 - 224 * dev->phy.channel;\r\ngain[1] = ((tmp >> 13) + ((tmp >> 12) & 1));\r\n}\r\n} else {\r\ngain[0] = 0;\r\ngain[1] = 0;\r\n}\r\nfor (i = 0; i < 2; i++) {\r\nif (nphy->elna_gain_config) {\r\ndata[0] = 19 + gain[i];\r\ndata[1] = 25 + gain[i];\r\ndata[2] = 25 + gain[i];\r\ndata[3] = 25 + gain[i];\r\n} else {\r\ndata[0] = lna_gain[0] + gain[i];\r\ndata[1] = lna_gain[1] + gain[i];\r\ndata[2] = lna_gain[2] + gain[i];\r\ndata[3] = lna_gain[3] + gain[i];\r\n}\r\nb43_ntab_write_bulk(dev, B43_NTAB16(i, 8), 4, data);\r\nminmax[i] = 23 + gain[i];\r\n}\r\nb43_phy_maskset(dev, B43_NPHY_C1_MINMAX_GAIN, ~B43_NPHY_C1_MINGAIN,\r\nminmax[0] << B43_NPHY_C1_MINGAIN_SHIFT);\r\nb43_phy_maskset(dev, B43_NPHY_C2_MINMAX_GAIN, ~B43_NPHY_C2_MINGAIN,\r\nminmax[1] << B43_NPHY_C2_MINGAIN_SHIFT);\r\nif (nphy->hang_avoid)\r\nb43_nphy_stay_in_carrier_search(dev, 0);\r\n}\r\nstatic void b43_nphy_set_rf_sequence(struct b43_wldev *dev, u8 cmd,\r\nu8 *events, u8 *delays, u8 length)\r\n{\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nu8 i;\r\nu8 end = (dev->phy.rev >= 3) ? 0x1F : 0x0F;\r\nu16 offset1 = cmd << 4;\r\nu16 offset2 = offset1 + 0x80;\r\nif (nphy->hang_avoid)\r\nb43_nphy_stay_in_carrier_search(dev, true);\r\nb43_ntab_write_bulk(dev, B43_NTAB8(7, offset1), length, events);\r\nb43_ntab_write_bulk(dev, B43_NTAB8(7, offset2), length, delays);\r\nfor (i = length; i < 16; i++) {\r\nb43_ntab_write(dev, B43_NTAB8(7, offset1 + i), end);\r\nb43_ntab_write(dev, B43_NTAB8(7, offset2 + i), 1);\r\n}\r\nif (nphy->hang_avoid)\r\nb43_nphy_stay_in_carrier_search(dev, false);\r\n}\r\nstatic void b43_radio_2057_chantab_upload(struct b43_wldev *dev,\r\nconst struct b43_nphy_chantabent_rev7 *e_r7,\r\nconst struct b43_nphy_chantabent_rev7_2g *e_r7_2g)\r\n{\r\nif (e_r7_2g) {\r\nb43_radio_write(dev, R2057_VCOCAL_COUNTVAL0, e_r7_2g->radio_vcocal_countval0);\r\nb43_radio_write(dev, R2057_VCOCAL_COUNTVAL1, e_r7_2g->radio_vcocal_countval1);\r\nb43_radio_write(dev, R2057_RFPLL_REFMASTER_SPAREXTALSIZE, e_r7_2g->radio_rfpll_refmaster_sparextalsize);\r\nb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_R1, e_r7_2g->radio_rfpll_loopfilter_r1);\r\nb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_C2, e_r7_2g->radio_rfpll_loopfilter_c2);\r\nb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_C1, e_r7_2g->radio_rfpll_loopfilter_c1);\r\nb43_radio_write(dev, R2057_CP_KPD_IDAC, e_r7_2g->radio_cp_kpd_idac);\r\nb43_radio_write(dev, R2057_RFPLL_MMD0, e_r7_2g->radio_rfpll_mmd0);\r\nb43_radio_write(dev, R2057_RFPLL_MMD1, e_r7_2g->radio_rfpll_mmd1);\r\nb43_radio_write(dev, R2057_VCOBUF_TUNE, e_r7_2g->radio_vcobuf_tune);\r\nb43_radio_write(dev, R2057_LOGEN_MX2G_TUNE, e_r7_2g->radio_logen_mx2g_tune);\r\nb43_radio_write(dev, R2057_LOGEN_INDBUF2G_TUNE, e_r7_2g->radio_logen_indbuf2g_tune);\r\nb43_radio_write(dev, R2057_TXMIX2G_TUNE_BOOST_PU_CORE0, e_r7_2g->radio_txmix2g_tune_boost_pu_core0);\r\nb43_radio_write(dev, R2057_PAD2G_TUNE_PUS_CORE0, e_r7_2g->radio_pad2g_tune_pus_core0);\r\nb43_radio_write(dev, R2057_LNA2G_TUNE_CORE0, e_r7_2g->radio_lna2g_tune_core0);\r\nb43_radio_write(dev, R2057_TXMIX2G_TUNE_BOOST_PU_CORE1, e_r7_2g->radio_txmix2g_tune_boost_pu_core1);\r\nb43_radio_write(dev, R2057_PAD2G_TUNE_PUS_CORE1, e_r7_2g->radio_pad2g_tune_pus_core1);\r\nb43_radio_write(dev, R2057_LNA2G_TUNE_CORE1, e_r7_2g->radio_lna2g_tune_core1);\r\n} else {\r\nb43_radio_write(dev, R2057_VCOCAL_COUNTVAL0, e_r7->radio_vcocal_countval0);\r\nb43_radio_write(dev, R2057_VCOCAL_COUNTVAL1, e_r7->radio_vcocal_countval1);\r\nb43_radio_write(dev, R2057_RFPLL_REFMASTER_SPAREXTALSIZE, e_r7->radio_rfpll_refmaster_sparextalsize);\r\nb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_R1, e_r7->radio_rfpll_loopfilter_r1);\r\nb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_C2, e_r7->radio_rfpll_loopfilter_c2);\r\nb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_C1, e_r7->radio_rfpll_loopfilter_c1);\r\nb43_radio_write(dev, R2057_CP_KPD_IDAC, e_r7->radio_cp_kpd_idac);\r\nb43_radio_write(dev, R2057_RFPLL_MMD0, e_r7->radio_rfpll_mmd0);\r\nb43_radio_write(dev, R2057_RFPLL_MMD1, e_r7->radio_rfpll_mmd1);\r\nb43_radio_write(dev, R2057_VCOBUF_TUNE, e_r7->radio_vcobuf_tune);\r\nb43_radio_write(dev, R2057_LOGEN_MX2G_TUNE, e_r7->radio_logen_mx2g_tune);\r\nb43_radio_write(dev, R2057_LOGEN_MX5G_TUNE, e_r7->radio_logen_mx5g_tune);\r\nb43_radio_write(dev, R2057_LOGEN_INDBUF2G_TUNE, e_r7->radio_logen_indbuf2g_tune);\r\nb43_radio_write(dev, R2057_LOGEN_INDBUF5G_TUNE, e_r7->radio_logen_indbuf5g_tune);\r\nb43_radio_write(dev, R2057_TXMIX2G_TUNE_BOOST_PU_CORE0, e_r7->radio_txmix2g_tune_boost_pu_core0);\r\nb43_radio_write(dev, R2057_PAD2G_TUNE_PUS_CORE0, e_r7->radio_pad2g_tune_pus_core0);\r\nb43_radio_write(dev, R2057_PGA_BOOST_TUNE_CORE0, e_r7->radio_pga_boost_tune_core0);\r\nb43_radio_write(dev, R2057_TXMIX5G_BOOST_TUNE_CORE0, e_r7->radio_txmix5g_boost_tune_core0);\r\nb43_radio_write(dev, R2057_PAD5G_TUNE_MISC_PUS_CORE0, e_r7->radio_pad5g_tune_misc_pus_core0);\r\nb43_radio_write(dev, R2057_LNA2G_TUNE_CORE0, e_r7->radio_lna2g_tune_core0);\r\nb43_radio_write(dev, R2057_LNA5G_TUNE_CORE0, e_r7->radio_lna5g_tune_core0);\r\nb43_radio_write(dev, R2057_TXMIX2G_TUNE_BOOST_PU_CORE1, e_r7->radio_txmix2g_tune_boost_pu_core1);\r\nb43_radio_write(dev, R2057_PAD2G_TUNE_PUS_CORE1, e_r7->radio_pad2g_tune_pus_core1);\r\nb43_radio_write(dev, R2057_PGA_BOOST_TUNE_CORE1, e_r7->radio_pga_boost_tune_core1);\r\nb43_radio_write(dev, R2057_TXMIX5G_BOOST_TUNE_CORE1, e_r7->radio_txmix5g_boost_tune_core1);\r\nb43_radio_write(dev, R2057_PAD5G_TUNE_MISC_PUS_CORE1, e_r7->radio_pad5g_tune_misc_pus_core1);\r\nb43_radio_write(dev, R2057_LNA2G_TUNE_CORE1, e_r7->radio_lna2g_tune_core1);\r\nb43_radio_write(dev, R2057_LNA5G_TUNE_CORE1, e_r7->radio_lna5g_tune_core1);\r\n}\r\n}\r\nstatic void b43_radio_2057_setup(struct b43_wldev *dev,\r\nconst struct b43_nphy_chantabent_rev7 *tabent_r7,\r\nconst struct b43_nphy_chantabent_rev7_2g *tabent_r7_2g)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nb43_radio_2057_chantab_upload(dev, tabent_r7, tabent_r7_2g);\r\nswitch (phy->radio_rev) {\r\ncase 0 ... 4:\r\ncase 6:\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\r\nb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_R1, 0x3f);\r\nb43_radio_write(dev, R2057_CP_KPD_IDAC, 0x3f);\r\nb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_C1, 0x8);\r\nb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_C2, 0x8);\r\n} else {\r\nb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_R1, 0x1f);\r\nb43_radio_write(dev, R2057_CP_KPD_IDAC, 0x3f);\r\nb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_C1, 0x8);\r\nb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_C2, 0x8);\r\n}\r\nbreak;\r\ncase 9:\r\nb43_radio_write(dev, R2057_LOGEN_PTAT_RESETS, 0x20);\r\nb43_radio_write(dev, R2057_VCOBUF_IDACS, 0x18);\r\nif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ) {\r\nb43_radio_write(dev, R2057_LOGEN_PTAT_RESETS, 0x38);\r\nb43_radio_write(dev, R2057_VCOBUF_IDACS, 0x0f);\r\nif (b43_is_40mhz(dev)) {\r\n} else {\r\nb43_radio_write(dev,\r\nR2057_PAD_BIAS_FILTER_BWS_CORE0,\r\n0x3c);\r\nb43_radio_write(dev,\r\nR2057_PAD_BIAS_FILTER_BWS_CORE1,\r\n0x3c);\r\n}\r\n}\r\nbreak;\r\ncase 14:\r\nb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_R1, 0x1b);\r\nb43_radio_write(dev, R2057_CP_KPD_IDAC, 0x3f);\r\nb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_C1, 0x1f);\r\nb43_radio_write(dev, R2057_RFPLL_LOOPFILTER_C2, 0x1f);\r\nbreak;\r\n}\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\r\nu16 txmix2g_tune_boost_pu = 0;\r\nu16 pad2g_tune_pus = 0;\r\nif (b43_nphy_ipa(dev)) {\r\nswitch (phy->radio_rev) {\r\ncase 9:\r\ntxmix2g_tune_boost_pu = 0x0041;\r\nbreak;\r\ncase 14:\r\ntxmix2g_tune_boost_pu = 0x21;\r\npad2g_tune_pus = 0x23;\r\nbreak;\r\n}\r\n}\r\nif (txmix2g_tune_boost_pu)\r\nb43_radio_write(dev, R2057_TXMIX2G_TUNE_BOOST_PU_CORE0,\r\ntxmix2g_tune_boost_pu);\r\nif (pad2g_tune_pus)\r\nb43_radio_write(dev, R2057_PAD2G_TUNE_PUS_CORE0,\r\npad2g_tune_pus);\r\nif (txmix2g_tune_boost_pu)\r\nb43_radio_write(dev, R2057_TXMIX2G_TUNE_BOOST_PU_CORE1,\r\ntxmix2g_tune_boost_pu);\r\nif (pad2g_tune_pus)\r\nb43_radio_write(dev, R2057_PAD2G_TUNE_PUS_CORE1,\r\npad2g_tune_pus);\r\n}\r\nusleep_range(50, 100);\r\nb43_radio_mask(dev, R2057_RFPLL_MISC_EN, ~0x01);\r\nb43_radio_mask(dev, R2057_RFPLL_MISC_CAL_RESETN, ~0x04);\r\nb43_radio_set(dev, R2057_RFPLL_MISC_CAL_RESETN, 0x4);\r\nb43_radio_set(dev, R2057_RFPLL_MISC_EN, 0x01);\r\nusleep_range(300, 600);\r\n}\r\nstatic u8 b43_radio_2057_rcal(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nu16 saved_regs_phy[12];\r\nu16 saved_regs_phy_rf[6];\r\nu16 saved_regs_radio[2] = { };\r\nstatic const u16 phy_to_store[] = {\r\nB43_NPHY_RFCTL_RSSIO1, B43_NPHY_RFCTL_RSSIO2,\r\nB43_NPHY_RFCTL_LUT_TRSW_LO1, B43_NPHY_RFCTL_LUT_TRSW_LO2,\r\nB43_NPHY_RFCTL_RXG1, B43_NPHY_RFCTL_RXG2,\r\nB43_NPHY_RFCTL_TXG1, B43_NPHY_RFCTL_TXG2,\r\nB43_NPHY_REV7_RF_CTL_MISC_REG3, B43_NPHY_REV7_RF_CTL_MISC_REG4,\r\nB43_NPHY_REV7_RF_CTL_MISC_REG5, B43_NPHY_REV7_RF_CTL_MISC_REG6,\r\n};\r\nstatic const u16 phy_to_store_rf[] = {\r\nB43_NPHY_REV3_RFCTL_OVER0, B43_NPHY_REV3_RFCTL_OVER1,\r\nB43_NPHY_REV7_RF_CTL_OVER3, B43_NPHY_REV7_RF_CTL_OVER4,\r\nB43_NPHY_REV7_RF_CTL_OVER5, B43_NPHY_REV7_RF_CTL_OVER6,\r\n};\r\nu16 tmp;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(phy_to_store); i++)\r\nsaved_regs_phy[i] = b43_phy_read(dev, phy_to_store[i]);\r\nfor (i = 0; i < ARRAY_SIZE(phy_to_store_rf); i++)\r\nsaved_regs_phy_rf[i] = b43_phy_read(dev, phy_to_store_rf[i]);\r\nfor (i = 0; i < ARRAY_SIZE(phy_to_store); i++)\r\nb43_phy_write(dev, phy_to_store[i], 0);\r\nb43_phy_write(dev, B43_NPHY_REV3_RFCTL_OVER0, 0x07ff);\r\nb43_phy_write(dev, B43_NPHY_REV3_RFCTL_OVER1, 0x07ff);\r\nb43_phy_write(dev, B43_NPHY_REV7_RF_CTL_OVER3, 0x07ff);\r\nb43_phy_write(dev, B43_NPHY_REV7_RF_CTL_OVER4, 0x07ff);\r\nb43_phy_write(dev, B43_NPHY_REV7_RF_CTL_OVER5, 0x007f);\r\nb43_phy_write(dev, B43_NPHY_REV7_RF_CTL_OVER6, 0x007f);\r\nswitch (phy->radio_rev) {\r\ncase 5:\r\nb43_phy_mask(dev, B43_NPHY_REV7_RF_CTL_OVER3, ~0x2);\r\nudelay(10);\r\nb43_radio_set(dev, R2057_IQTEST_SEL_PU, 0x1);\r\nb43_radio_maskset(dev, R2057v7_IQTEST_SEL_PU2, ~0x2, 0x1);\r\nbreak;\r\ncase 9:\r\nb43_phy_set(dev, B43_NPHY_REV7_RF_CTL_OVER3, 0x2);\r\nb43_phy_set(dev, B43_NPHY_REV7_RF_CTL_MISC_REG3, 0x2);\r\nsaved_regs_radio[0] = b43_radio_read(dev, R2057_IQTEST_SEL_PU);\r\nb43_radio_write(dev, R2057_IQTEST_SEL_PU, 0x11);\r\nbreak;\r\ncase 14:\r\nsaved_regs_radio[0] = b43_radio_read(dev, R2057_IQTEST_SEL_PU);\r\nsaved_regs_radio[1] = b43_radio_read(dev, R2057v7_IQTEST_SEL_PU2);\r\nb43_phy_set(dev, B43_NPHY_REV7_RF_CTL_MISC_REG3, 0x2);\r\nb43_phy_set(dev, B43_NPHY_REV7_RF_CTL_OVER3, 0x2);\r\nb43_radio_write(dev, R2057v7_IQTEST_SEL_PU2, 0x2);\r\nb43_radio_write(dev, R2057_IQTEST_SEL_PU, 0x1);\r\nbreak;\r\n}\r\nb43_radio_set(dev, R2057_RCAL_CONFIG, 0x1);\r\nudelay(10);\r\nb43_radio_set(dev, R2057_RCAL_CONFIG, 0x2);\r\nusleep_range(100, 200);\r\nb43_radio_mask(dev, R2057_RCAL_CONFIG, ~0x2);\r\nif (!b43_radio_wait_value(dev, R2057_RCAL_STATUS, 1, 1, 100, 1000000)) {\r\nb43err(dev->wl, "Radio 0x2057 rcal timeout\n");\r\nreturn 0;\r\n}\r\ntmp = b43_radio_read(dev, R2057_RCAL_STATUS) & 0x3E;\r\nb43_radio_mask(dev, R2057_RCAL_CONFIG, ~0x1);\r\nfor (i = 0; i < ARRAY_SIZE(phy_to_store_rf); i++)\r\nb43_phy_write(dev, phy_to_store_rf[i], saved_regs_phy_rf[i]);\r\nfor (i = 0; i < ARRAY_SIZE(phy_to_store); i++)\r\nb43_phy_write(dev, phy_to_store[i], saved_regs_phy[i]);\r\nswitch (phy->radio_rev) {\r\ncase 0 ... 4:\r\ncase 6:\r\nb43_radio_maskset(dev, R2057_TEMPSENSE_CONFIG, ~0x3C, tmp);\r\nb43_radio_maskset(dev, R2057_BANDGAP_RCAL_TRIM, ~0xF0,\r\ntmp << 2);\r\nbreak;\r\ncase 5:\r\nb43_radio_mask(dev, R2057_IPA2G_CASCONV_CORE0, ~0x1);\r\nb43_radio_mask(dev, R2057v7_IQTEST_SEL_PU2, ~0x2);\r\nbreak;\r\ncase 9:\r\nb43_radio_write(dev, R2057_IQTEST_SEL_PU, saved_regs_radio[0]);\r\nbreak;\r\ncase 14:\r\nb43_radio_write(dev, R2057_IQTEST_SEL_PU, saved_regs_radio[0]);\r\nb43_radio_write(dev, R2057v7_IQTEST_SEL_PU2, saved_regs_radio[1]);\r\nbreak;\r\n}\r\nreturn tmp & 0x3e;\r\n}\r\nstatic u16 b43_radio_2057_rccal(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nbool special = (phy->radio_rev == 3 || phy->radio_rev == 4 ||\r\nphy->radio_rev == 6);\r\nu16 tmp;\r\nif (special) {\r\nb43_radio_write(dev, R2057_RCCAL_MASTER, 0x61);\r\nb43_radio_write(dev, R2057_RCCAL_TRC0, 0xC0);\r\n} else {\r\nb43_radio_write(dev, R2057v7_RCCAL_MASTER, 0x61);\r\nb43_radio_write(dev, R2057_RCCAL_TRC0, 0xE9);\r\n}\r\nb43_radio_write(dev, R2057_RCCAL_X1, 0x6E);\r\nb43_radio_write(dev, R2057_RCCAL_START_R1_Q1_P1, 0x55);\r\nif (!b43_radio_wait_value(dev, R2057_RCCAL_DONE_OSCCAP, 2, 2, 500,\r\n5000000))\r\nb43dbg(dev->wl, "Radio 0x2057 rccal timeout\n");\r\nusleep_range(35, 70);\r\nb43_radio_write(dev, R2057_RCCAL_START_R1_Q1_P1, 0x15);\r\nusleep_range(70, 140);\r\nif (special) {\r\nb43_radio_write(dev, R2057_RCCAL_MASTER, 0x69);\r\nb43_radio_write(dev, R2057_RCCAL_TRC0, 0xB0);\r\n} else {\r\nb43_radio_write(dev, R2057v7_RCCAL_MASTER, 0x69);\r\nb43_radio_write(dev, R2057_RCCAL_TRC0, 0xD5);\r\n}\r\nb43_radio_write(dev, R2057_RCCAL_X1, 0x6E);\r\nusleep_range(35, 70);\r\nb43_radio_write(dev, R2057_RCCAL_START_R1_Q1_P1, 0x55);\r\nusleep_range(70, 140);\r\nif (!b43_radio_wait_value(dev, R2057_RCCAL_DONE_OSCCAP, 2, 2, 500,\r\n5000000))\r\nb43dbg(dev->wl, "Radio 0x2057 rccal timeout\n");\r\nusleep_range(35, 70);\r\nb43_radio_write(dev, R2057_RCCAL_START_R1_Q1_P1, 0x15);\r\nusleep_range(70, 140);\r\nif (special) {\r\nb43_radio_write(dev, R2057_RCCAL_MASTER, 0x73);\r\nb43_radio_write(dev, R2057_RCCAL_X1, 0x28);\r\nb43_radio_write(dev, R2057_RCCAL_TRC0, 0xB0);\r\n} else {\r\nb43_radio_write(dev, R2057v7_RCCAL_MASTER, 0x73);\r\nb43_radio_write(dev, R2057_RCCAL_X1, 0x6E);\r\nb43_radio_write(dev, R2057_RCCAL_TRC0, 0x99);\r\n}\r\nusleep_range(35, 70);\r\nb43_radio_write(dev, R2057_RCCAL_START_R1_Q1_P1, 0x55);\r\nusleep_range(70, 140);\r\nif (!b43_radio_wait_value(dev, R2057_RCCAL_DONE_OSCCAP, 2, 2, 500,\r\n5000000)) {\r\nb43err(dev->wl, "Radio 0x2057 rcal timeout\n");\r\nreturn 0;\r\n}\r\ntmp = b43_radio_read(dev, R2057_RCCAL_DONE_OSCCAP);\r\nusleep_range(35, 70);\r\nb43_radio_write(dev, R2057_RCCAL_START_R1_Q1_P1, 0x15);\r\nusleep_range(70, 140);\r\nif (special)\r\nb43_radio_mask(dev, R2057_RCCAL_MASTER, ~0x1);\r\nelse\r\nb43_radio_mask(dev, R2057v7_RCCAL_MASTER, ~0x1);\r\nreturn tmp;\r\n}\r\nstatic void b43_radio_2057_init_pre(struct b43_wldev *dev)\r\n{\r\nb43_phy_mask(dev, B43_NPHY_RFCTL_CMD, ~B43_NPHY_RFCTL_CMD_CHIP0PU);\r\nb43_phy_mask(dev, B43_NPHY_RFCTL_CMD, B43_NPHY_RFCTL_CMD_OEPORFORCE);\r\nb43_phy_set(dev, B43_NPHY_RFCTL_CMD, ~B43_NPHY_RFCTL_CMD_OEPORFORCE);\r\nb43_phy_set(dev, B43_NPHY_RFCTL_CMD, B43_NPHY_RFCTL_CMD_CHIP0PU);\r\n}\r\nstatic void b43_radio_2057_init_post(struct b43_wldev *dev)\r\n{\r\nb43_radio_set(dev, R2057_XTALPUOVR_PINCTRL, 0x1);\r\nif (0)\r\nb43_radio_set(dev, R2057_XTALPUOVR_PINCTRL, 0x2);\r\nb43_radio_set(dev, R2057_RFPLL_MISC_CAL_RESETN, 0x78);\r\nb43_radio_set(dev, R2057_XTAL_CONFIG2, 0x80);\r\nmdelay(2);\r\nb43_radio_mask(dev, R2057_RFPLL_MISC_CAL_RESETN, ~0x78);\r\nb43_radio_mask(dev, R2057_XTAL_CONFIG2, ~0x80);\r\nif (dev->phy.do_full_init) {\r\nb43_radio_2057_rcal(dev);\r\nb43_radio_2057_rccal(dev);\r\n}\r\nb43_radio_mask(dev, R2057_RFPLL_MASTER, ~0x8);\r\n}\r\nstatic void b43_radio_2057_init(struct b43_wldev *dev)\r\n{\r\nb43_radio_2057_init_pre(dev);\r\nr2057_upload_inittabs(dev);\r\nb43_radio_2057_init_post(dev);\r\n}\r\nstatic void b43_chantab_radio_2056_upload(struct b43_wldev *dev,\r\nconst struct b43_nphy_channeltab_entry_rev3 *e)\r\n{\r\nb43_radio_write(dev, B2056_SYN_PLL_VCOCAL1, e->radio_syn_pll_vcocal1);\r\nb43_radio_write(dev, B2056_SYN_PLL_VCOCAL2, e->radio_syn_pll_vcocal2);\r\nb43_radio_write(dev, B2056_SYN_PLL_REFDIV, e->radio_syn_pll_refdiv);\r\nb43_radio_write(dev, B2056_SYN_PLL_MMD2, e->radio_syn_pll_mmd2);\r\nb43_radio_write(dev, B2056_SYN_PLL_MMD1, e->radio_syn_pll_mmd1);\r\nb43_radio_write(dev, B2056_SYN_PLL_LOOPFILTER1,\r\ne->radio_syn_pll_loopfilter1);\r\nb43_radio_write(dev, B2056_SYN_PLL_LOOPFILTER2,\r\ne->radio_syn_pll_loopfilter2);\r\nb43_radio_write(dev, B2056_SYN_PLL_LOOPFILTER3,\r\ne->radio_syn_pll_loopfilter3);\r\nb43_radio_write(dev, B2056_SYN_PLL_LOOPFILTER4,\r\ne->radio_syn_pll_loopfilter4);\r\nb43_radio_write(dev, B2056_SYN_PLL_LOOPFILTER5,\r\ne->radio_syn_pll_loopfilter5);\r\nb43_radio_write(dev, B2056_SYN_RESERVED_ADDR27,\r\ne->radio_syn_reserved_addr27);\r\nb43_radio_write(dev, B2056_SYN_RESERVED_ADDR28,\r\ne->radio_syn_reserved_addr28);\r\nb43_radio_write(dev, B2056_SYN_RESERVED_ADDR29,\r\ne->radio_syn_reserved_addr29);\r\nb43_radio_write(dev, B2056_SYN_LOGEN_VCOBUF1,\r\ne->radio_syn_logen_vcobuf1);\r\nb43_radio_write(dev, B2056_SYN_LOGEN_MIXER2, e->radio_syn_logen_mixer2);\r\nb43_radio_write(dev, B2056_SYN_LOGEN_BUF3, e->radio_syn_logen_buf3);\r\nb43_radio_write(dev, B2056_SYN_LOGEN_BUF4, e->radio_syn_logen_buf4);\r\nb43_radio_write(dev, B2056_RX0 | B2056_RX_LNAA_TUNE,\r\ne->radio_rx0_lnaa_tune);\r\nb43_radio_write(dev, B2056_RX0 | B2056_RX_LNAG_TUNE,\r\ne->radio_rx0_lnag_tune);\r\nb43_radio_write(dev, B2056_TX0 | B2056_TX_INTPAA_BOOST_TUNE,\r\ne->radio_tx0_intpaa_boost_tune);\r\nb43_radio_write(dev, B2056_TX0 | B2056_TX_INTPAG_BOOST_TUNE,\r\ne->radio_tx0_intpag_boost_tune);\r\nb43_radio_write(dev, B2056_TX0 | B2056_TX_PADA_BOOST_TUNE,\r\ne->radio_tx0_pada_boost_tune);\r\nb43_radio_write(dev, B2056_TX0 | B2056_TX_PADG_BOOST_TUNE,\r\ne->radio_tx0_padg_boost_tune);\r\nb43_radio_write(dev, B2056_TX0 | B2056_TX_PGAA_BOOST_TUNE,\r\ne->radio_tx0_pgaa_boost_tune);\r\nb43_radio_write(dev, B2056_TX0 | B2056_TX_PGAG_BOOST_TUNE,\r\ne->radio_tx0_pgag_boost_tune);\r\nb43_radio_write(dev, B2056_TX0 | B2056_TX_MIXA_BOOST_TUNE,\r\ne->radio_tx0_mixa_boost_tune);\r\nb43_radio_write(dev, B2056_TX0 | B2056_TX_MIXG_BOOST_TUNE,\r\ne->radio_tx0_mixg_boost_tune);\r\nb43_radio_write(dev, B2056_RX1 | B2056_RX_LNAA_TUNE,\r\ne->radio_rx1_lnaa_tune);\r\nb43_radio_write(dev, B2056_RX1 | B2056_RX_LNAG_TUNE,\r\ne->radio_rx1_lnag_tune);\r\nb43_radio_write(dev, B2056_TX1 | B2056_TX_INTPAA_BOOST_TUNE,\r\ne->radio_tx1_intpaa_boost_tune);\r\nb43_radio_write(dev, B2056_TX1 | B2056_TX_INTPAG_BOOST_TUNE,\r\ne->radio_tx1_intpag_boost_tune);\r\nb43_radio_write(dev, B2056_TX1 | B2056_TX_PADA_BOOST_TUNE,\r\ne->radio_tx1_pada_boost_tune);\r\nb43_radio_write(dev, B2056_TX1 | B2056_TX_PADG_BOOST_TUNE,\r\ne->radio_tx1_padg_boost_tune);\r\nb43_radio_write(dev, B2056_TX1 | B2056_TX_PGAA_BOOST_TUNE,\r\ne->radio_tx1_pgaa_boost_tune);\r\nb43_radio_write(dev, B2056_TX1 | B2056_TX_PGAG_BOOST_TUNE,\r\ne->radio_tx1_pgag_boost_tune);\r\nb43_radio_write(dev, B2056_TX1 | B2056_TX_MIXA_BOOST_TUNE,\r\ne->radio_tx1_mixa_boost_tune);\r\nb43_radio_write(dev, B2056_TX1 | B2056_TX_MIXG_BOOST_TUNE,\r\ne->radio_tx1_mixg_boost_tune);\r\n}\r\nstatic void b43_radio_2056_setup(struct b43_wldev *dev,\r\nconst struct b43_nphy_channeltab_entry_rev3 *e)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct ssb_sprom *sprom = dev->dev->bus_sprom;\r\nenum nl80211_band band = b43_current_band(dev->wl);\r\nu16 offset;\r\nu8 i;\r\nu16 bias, cbias;\r\nu16 pag_boost, padg_boost, pgag_boost, mixg_boost;\r\nu16 paa_boost, pada_boost, pgaa_boost, mixa_boost;\r\nbool is_pkg_fab_smic;\r\nB43_WARN_ON(dev->phy.rev < 3);\r\nis_pkg_fab_smic =\r\n((dev->dev->chip_id == BCMA_CHIP_ID_BCM43224 ||\r\ndev->dev->chip_id == BCMA_CHIP_ID_BCM43225 ||\r\ndev->dev->chip_id == BCMA_CHIP_ID_BCM43421) &&\r\ndev->dev->chip_pkg == BCMA_PKG_ID_BCM43224_FAB_SMIC);\r\nb43_chantab_radio_2056_upload(dev, e);\r\nb2056_upload_syn_pll_cp2(dev, band == NL80211_BAND_5GHZ);\r\nif (sprom->boardflags2_lo & B43_BFL2_GPLL_WAR &&\r\nb43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\r\nb43_radio_write(dev, B2056_SYN_PLL_LOOPFILTER1, 0x1F);\r\nb43_radio_write(dev, B2056_SYN_PLL_LOOPFILTER2, 0x1F);\r\nif (dev->dev->chip_id == BCMA_CHIP_ID_BCM4716 ||\r\ndev->dev->chip_id == BCMA_CHIP_ID_BCM47162) {\r\nb43_radio_write(dev, B2056_SYN_PLL_LOOPFILTER4, 0x14);\r\nb43_radio_write(dev, B2056_SYN_PLL_CP2, 0);\r\n} else {\r\nb43_radio_write(dev, B2056_SYN_PLL_LOOPFILTER4, 0x0B);\r\nb43_radio_write(dev, B2056_SYN_PLL_CP2, 0x14);\r\n}\r\n}\r\nif (sprom->boardflags2_hi & B43_BFH2_GPLL_WAR2 &&\r\nb43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\r\nb43_radio_write(dev, B2056_SYN_PLL_LOOPFILTER1, 0x1f);\r\nb43_radio_write(dev, B2056_SYN_PLL_LOOPFILTER2, 0x1f);\r\nb43_radio_write(dev, B2056_SYN_PLL_LOOPFILTER4, 0x0b);\r\nb43_radio_write(dev, B2056_SYN_PLL_CP2, 0x20);\r\n}\r\nif (sprom->boardflags2_lo & B43_BFL2_APLL_WAR &&\r\nb43_current_band(dev->wl) == NL80211_BAND_5GHZ) {\r\nb43_radio_write(dev, B2056_SYN_PLL_LOOPFILTER1, 0x1F);\r\nb43_radio_write(dev, B2056_SYN_PLL_LOOPFILTER2, 0x1F);\r\nb43_radio_write(dev, B2056_SYN_PLL_LOOPFILTER4, 0x05);\r\nb43_radio_write(dev, B2056_SYN_PLL_CP2, 0x0C);\r\n}\r\nif (dev->phy.n->ipa2g_on && band == NL80211_BAND_2GHZ) {\r\nfor (i = 0; i < 2; i++) {\r\noffset = i ? B2056_TX1 : B2056_TX0;\r\nif (dev->phy.rev >= 5) {\r\nb43_radio_write(dev,\r\noffset | B2056_TX_PADG_IDAC, 0xcc);\r\nif (dev->dev->chip_id == BCMA_CHIP_ID_BCM4716 ||\r\ndev->dev->chip_id == BCMA_CHIP_ID_BCM47162) {\r\nbias = 0x40;\r\ncbias = 0x45;\r\npag_boost = 0x5;\r\npgag_boost = 0x33;\r\nmixg_boost = 0x55;\r\n} else {\r\nbias = 0x25;\r\ncbias = 0x20;\r\nif (is_pkg_fab_smic) {\r\nbias = 0x2a;\r\ncbias = 0x38;\r\n}\r\npag_boost = 0x4;\r\npgag_boost = 0x03;\r\nmixg_boost = 0x65;\r\n}\r\npadg_boost = 0x77;\r\nb43_radio_write(dev,\r\noffset | B2056_TX_INTPAG_IMAIN_STAT,\r\nbias);\r\nb43_radio_write(dev,\r\noffset | B2056_TX_INTPAG_IAUX_STAT,\r\nbias);\r\nb43_radio_write(dev,\r\noffset | B2056_TX_INTPAG_CASCBIAS,\r\ncbias);\r\nb43_radio_write(dev,\r\noffset | B2056_TX_INTPAG_BOOST_TUNE,\r\npag_boost);\r\nb43_radio_write(dev,\r\noffset | B2056_TX_PGAG_BOOST_TUNE,\r\npgag_boost);\r\nb43_radio_write(dev,\r\noffset | B2056_TX_PADG_BOOST_TUNE,\r\npadg_boost);\r\nb43_radio_write(dev,\r\noffset | B2056_TX_MIXG_BOOST_TUNE,\r\nmixg_boost);\r\n} else {\r\nbias = b43_is_40mhz(dev) ? 0x40 : 0x20;\r\nb43_radio_write(dev,\r\noffset | B2056_TX_INTPAG_IMAIN_STAT,\r\nbias);\r\nb43_radio_write(dev,\r\noffset | B2056_TX_INTPAG_IAUX_STAT,\r\nbias);\r\nb43_radio_write(dev,\r\noffset | B2056_TX_INTPAG_CASCBIAS,\r\n0x30);\r\n}\r\nb43_radio_write(dev, offset | B2056_TX_PA_SPARE1, 0xee);\r\n}\r\n} else if (dev->phy.n->ipa5g_on && band == NL80211_BAND_5GHZ) {\r\nu16 freq = phy->chandef->chan->center_freq;\r\nif (freq < 5100) {\r\npaa_boost = 0xA;\r\npada_boost = 0x77;\r\npgaa_boost = 0xF;\r\nmixa_boost = 0xF;\r\n} else if (freq < 5340) {\r\npaa_boost = 0x8;\r\npada_boost = 0x77;\r\npgaa_boost = 0xFB;\r\nmixa_boost = 0xF;\r\n} else if (freq < 5650) {\r\npaa_boost = 0x0;\r\npada_boost = 0x77;\r\npgaa_boost = 0xB;\r\nmixa_boost = 0xF;\r\n} else {\r\npaa_boost = 0x0;\r\npada_boost = 0x77;\r\nif (freq != 5825)\r\npgaa_boost = -(freq - 18) / 36 + 168;\r\nelse\r\npgaa_boost = 6;\r\nmixa_boost = 0xF;\r\n}\r\ncbias = is_pkg_fab_smic ? 0x35 : 0x30;\r\nfor (i = 0; i < 2; i++) {\r\noffset = i ? B2056_TX1 : B2056_TX0;\r\nb43_radio_write(dev,\r\noffset | B2056_TX_INTPAA_BOOST_TUNE, paa_boost);\r\nb43_radio_write(dev,\r\noffset | B2056_TX_PADA_BOOST_TUNE, pada_boost);\r\nb43_radio_write(dev,\r\noffset | B2056_TX_PGAA_BOOST_TUNE, pgaa_boost);\r\nb43_radio_write(dev,\r\noffset | B2056_TX_MIXA_BOOST_TUNE, mixa_boost);\r\nb43_radio_write(dev,\r\noffset | B2056_TX_TXSPARE1, 0x30);\r\nb43_radio_write(dev,\r\noffset | B2056_TX_PA_SPARE2, 0xee);\r\nb43_radio_write(dev,\r\noffset | B2056_TX_PADA_CASCBIAS, 0x03);\r\nb43_radio_write(dev,\r\noffset | B2056_TX_INTPAA_IAUX_STAT, 0x30);\r\nb43_radio_write(dev,\r\noffset | B2056_TX_INTPAA_IMAIN_STAT, 0x30);\r\nb43_radio_write(dev,\r\noffset | B2056_TX_INTPAA_CASCBIAS, cbias);\r\n}\r\n}\r\nudelay(50);\r\nb43_radio_write(dev, B2056_SYN_PLL_VCOCAL12, 0x00);\r\nb43_radio_write(dev, B2056_TX_INTPAA_PA_MISC, 0x38);\r\nb43_radio_write(dev, B2056_TX_INTPAA_PA_MISC, 0x18);\r\nb43_radio_write(dev, B2056_TX_INTPAA_PA_MISC, 0x38);\r\nb43_radio_write(dev, B2056_TX_INTPAA_PA_MISC, 0x39);\r\nudelay(300);\r\n}\r\nstatic u8 b43_radio_2056_rcal(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nu16 mast2, tmp;\r\nif (phy->rev != 3)\r\nreturn 0;\r\nmast2 = b43_radio_read(dev, B2056_SYN_PLL_MAST2);\r\nb43_radio_write(dev, B2056_SYN_PLL_MAST2, mast2 | 0x7);\r\nudelay(10);\r\nb43_radio_write(dev, B2056_SYN_RCAL_MASTER, 0x01);\r\nudelay(10);\r\nb43_radio_write(dev, B2056_SYN_RCAL_MASTER, 0x09);\r\nif (!b43_radio_wait_value(dev, B2056_SYN_RCAL_CODE_OUT, 0x80, 0x80, 100,\r\n1000000)) {\r\nb43err(dev->wl, "Radio recalibration timeout\n");\r\nreturn 0;\r\n}\r\nb43_radio_write(dev, B2056_SYN_RCAL_MASTER, 0x01);\r\ntmp = b43_radio_read(dev, B2056_SYN_RCAL_CODE_OUT);\r\nb43_radio_write(dev, B2056_SYN_RCAL_MASTER, 0x00);\r\nb43_radio_write(dev, B2056_SYN_PLL_MAST2, mast2);\r\nreturn tmp & 0x1f;\r\n}\r\nstatic void b43_radio_init2056_pre(struct b43_wldev *dev)\r\n{\r\nb43_phy_mask(dev, B43_NPHY_RFCTL_CMD,\r\n~B43_NPHY_RFCTL_CMD_CHIP0PU);\r\nb43_phy_mask(dev, B43_NPHY_RFCTL_CMD,\r\nB43_NPHY_RFCTL_CMD_OEPORFORCE);\r\nb43_phy_set(dev, B43_NPHY_RFCTL_CMD,\r\n~B43_NPHY_RFCTL_CMD_OEPORFORCE);\r\nb43_phy_set(dev, B43_NPHY_RFCTL_CMD,\r\nB43_NPHY_RFCTL_CMD_CHIP0PU);\r\n}\r\nstatic void b43_radio_init2056_post(struct b43_wldev *dev)\r\n{\r\nb43_radio_set(dev, B2056_SYN_COM_CTRL, 0xB);\r\nb43_radio_set(dev, B2056_SYN_COM_PU, 0x2);\r\nb43_radio_set(dev, B2056_SYN_COM_RESET, 0x2);\r\nmsleep(1);\r\nb43_radio_mask(dev, B2056_SYN_COM_RESET, ~0x2);\r\nb43_radio_mask(dev, B2056_SYN_PLL_MAST2, ~0xFC);\r\nb43_radio_mask(dev, B2056_SYN_RCCAL_CTRL0, ~0x1);\r\nif (dev->phy.do_full_init)\r\nb43_radio_2056_rcal(dev);\r\n}\r\nstatic void b43_radio_init2056(struct b43_wldev *dev)\r\n{\r\nb43_radio_init2056_pre(dev);\r\nb2056_upload_inittabs(dev, 0, 0);\r\nb43_radio_init2056_post(dev);\r\n}\r\nstatic void b43_chantab_radio_upload(struct b43_wldev *dev,\r\nconst struct b43_nphy_channeltab_entry_rev2 *e)\r\n{\r\nb43_radio_write(dev, B2055_PLL_REF, e->radio_pll_ref);\r\nb43_radio_write(dev, B2055_RF_PLLMOD0, e->radio_rf_pllmod0);\r\nb43_radio_write(dev, B2055_RF_PLLMOD1, e->radio_rf_pllmod1);\r\nb43_radio_write(dev, B2055_VCO_CAPTAIL, e->radio_vco_captail);\r\nb43_read32(dev, B43_MMIO_MACCTL);\r\nb43_radio_write(dev, B2055_VCO_CAL1, e->radio_vco_cal1);\r\nb43_radio_write(dev, B2055_VCO_CAL2, e->radio_vco_cal2);\r\nb43_radio_write(dev, B2055_PLL_LFC1, e->radio_pll_lfc1);\r\nb43_radio_write(dev, B2055_PLL_LFR1, e->radio_pll_lfr1);\r\nb43_read32(dev, B43_MMIO_MACCTL);\r\nb43_radio_write(dev, B2055_PLL_LFC2, e->radio_pll_lfc2);\r\nb43_radio_write(dev, B2055_LGBUF_CENBUF, e->radio_lgbuf_cenbuf);\r\nb43_radio_write(dev, B2055_LGEN_TUNE1, e->radio_lgen_tune1);\r\nb43_radio_write(dev, B2055_LGEN_TUNE2, e->radio_lgen_tune2);\r\nb43_read32(dev, B43_MMIO_MACCTL);\r\nb43_radio_write(dev, B2055_C1_LGBUF_ATUNE, e->radio_c1_lgbuf_atune);\r\nb43_radio_write(dev, B2055_C1_LGBUF_GTUNE, e->radio_c1_lgbuf_gtune);\r\nb43_radio_write(dev, B2055_C1_RX_RFR1, e->radio_c1_rx_rfr1);\r\nb43_radio_write(dev, B2055_C1_TX_PGAPADTN, e->radio_c1_tx_pgapadtn);\r\nb43_read32(dev, B43_MMIO_MACCTL);\r\nb43_radio_write(dev, B2055_C1_TX_MXBGTRIM, e->radio_c1_tx_mxbgtrim);\r\nb43_radio_write(dev, B2055_C2_LGBUF_ATUNE, e->radio_c2_lgbuf_atune);\r\nb43_radio_write(dev, B2055_C2_LGBUF_GTUNE, e->radio_c2_lgbuf_gtune);\r\nb43_radio_write(dev, B2055_C2_RX_RFR1, e->radio_c2_rx_rfr1);\r\nb43_read32(dev, B43_MMIO_MACCTL);\r\nb43_radio_write(dev, B2055_C2_TX_PGAPADTN, e->radio_c2_tx_pgapadtn);\r\nb43_radio_write(dev, B2055_C2_TX_MXBGTRIM, e->radio_c2_tx_mxbgtrim);\r\n}\r\nstatic void b43_radio_2055_setup(struct b43_wldev *dev,\r\nconst struct b43_nphy_channeltab_entry_rev2 *e)\r\n{\r\nB43_WARN_ON(dev->phy.rev >= 3);\r\nb43_chantab_radio_upload(dev, e);\r\nudelay(50);\r\nb43_radio_write(dev, B2055_VCO_CAL10, 0x05);\r\nb43_radio_write(dev, B2055_VCO_CAL10, 0x45);\r\nb43_read32(dev, B43_MMIO_MACCTL);\r\nb43_radio_write(dev, B2055_VCO_CAL10, 0x65);\r\nudelay(300);\r\n}\r\nstatic void b43_radio_init2055_pre(struct b43_wldev *dev)\r\n{\r\nb43_phy_mask(dev, B43_NPHY_RFCTL_CMD,\r\n~B43_NPHY_RFCTL_CMD_PORFORCE);\r\nb43_phy_set(dev, B43_NPHY_RFCTL_CMD,\r\nB43_NPHY_RFCTL_CMD_CHIP0PU |\r\nB43_NPHY_RFCTL_CMD_OEPORFORCE);\r\nb43_phy_set(dev, B43_NPHY_RFCTL_CMD,\r\nB43_NPHY_RFCTL_CMD_PORFORCE);\r\n}\r\nstatic void b43_radio_init2055_post(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nstruct ssb_sprom *sprom = dev->dev->bus_sprom;\r\nbool workaround = false;\r\nif (sprom->revision < 4)\r\nworkaround = (dev->dev->board_vendor != PCI_VENDOR_ID_BROADCOM\r\n&& dev->dev->board_type == SSB_BOARD_CB2_4321\r\n&& dev->dev->board_rev >= 0x41);\r\nelse\r\nworkaround =\r\n!(sprom->boardflags2_lo & B43_BFL2_RXBB_INT_REG_DIS);\r\nb43_radio_mask(dev, B2055_MASTER1, 0xFFF3);\r\nif (workaround) {\r\nb43_radio_mask(dev, B2055_C1_RX_BB_REG, 0x7F);\r\nb43_radio_mask(dev, B2055_C2_RX_BB_REG, 0x7F);\r\n}\r\nb43_radio_maskset(dev, B2055_RRCCAL_NOPTSEL, 0xFFC0, 0x2C);\r\nb43_radio_write(dev, B2055_CAL_MISC, 0x3C);\r\nb43_radio_mask(dev, B2055_CAL_MISC, 0xFFBE);\r\nb43_radio_set(dev, B2055_CAL_LPOCTL, 0x80);\r\nb43_radio_set(dev, B2055_CAL_MISC, 0x1);\r\nmsleep(1);\r\nb43_radio_set(dev, B2055_CAL_MISC, 0x40);\r\nif (!b43_radio_wait_value(dev, B2055_CAL_COUT2, 0x80, 0x80, 10, 2000))\r\nb43err(dev->wl, "radio post init timeout\n");\r\nb43_radio_mask(dev, B2055_CAL_LPOCTL, 0xFF7F);\r\nb43_switch_channel(dev, dev->phy.channel);\r\nb43_radio_write(dev, B2055_C1_RX_BB_LPF, 0x9);\r\nb43_radio_write(dev, B2055_C2_RX_BB_LPF, 0x9);\r\nb43_radio_write(dev, B2055_C1_RX_BB_MIDACHP, 0x83);\r\nb43_radio_write(dev, B2055_C2_RX_BB_MIDACHP, 0x83);\r\nb43_radio_maskset(dev, B2055_C1_LNA_GAINBST, 0xFFF8, 0x6);\r\nb43_radio_maskset(dev, B2055_C2_LNA_GAINBST, 0xFFF8, 0x6);\r\nif (!nphy->gain_boost) {\r\nb43_radio_set(dev, B2055_C1_RX_RFSPC1, 0x2);\r\nb43_radio_set(dev, B2055_C2_RX_RFSPC1, 0x2);\r\n} else {\r\nb43_radio_mask(dev, B2055_C1_RX_RFSPC1, 0xFFFD);\r\nb43_radio_mask(dev, B2055_C2_RX_RFSPC1, 0xFFFD);\r\n}\r\nudelay(2);\r\n}\r\nstatic void b43_radio_init2055(struct b43_wldev *dev)\r\n{\r\nb43_radio_init2055_pre(dev);\r\nif (b43_status(dev) < B43_STAT_INITIALIZED) {\r\nb2055_upload_inittab(dev, 0, 0);\r\n} else {\r\nbool ghz5 = b43_current_band(dev->wl) == NL80211_BAND_5GHZ;\r\nb2055_upload_inittab(dev, ghz5, 0);\r\n}\r\nb43_radio_init2055_post(dev);\r\n}\r\nstatic int b43_nphy_load_samples(struct b43_wldev *dev,\r\nstruct b43_c32 *samples, u16 len) {\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nu16 i;\r\nu32 *data;\r\ndata = kzalloc(len * sizeof(u32), GFP_KERNEL);\r\nif (!data) {\r\nb43err(dev->wl, "allocation for samples loading failed\n");\r\nreturn -ENOMEM;\r\n}\r\nif (nphy->hang_avoid)\r\nb43_nphy_stay_in_carrier_search(dev, 1);\r\nfor (i = 0; i < len; i++) {\r\ndata[i] = (samples[i].i & 0x3FF << 10);\r\ndata[i] |= samples[i].q & 0x3FF;\r\n}\r\nb43_ntab_write_bulk(dev, B43_NTAB32(17, 0), len, data);\r\nkfree(data);\r\nif (nphy->hang_avoid)\r\nb43_nphy_stay_in_carrier_search(dev, 0);\r\nreturn 0;\r\n}\r\nstatic u16 b43_nphy_gen_load_samples(struct b43_wldev *dev, u32 freq, u16 max,\r\nbool test)\r\n{\r\nint i;\r\nu16 bw, len, rot, angle;\r\nstruct b43_c32 *samples;\r\nbw = b43_is_40mhz(dev) ? 40 : 20;\r\nlen = bw << 3;\r\nif (test) {\r\nif (b43_phy_read(dev, B43_NPHY_BBCFG) & B43_NPHY_BBCFG_RSTRX)\r\nbw = 82;\r\nelse\r\nbw = 80;\r\nif (b43_is_40mhz(dev))\r\nbw <<= 1;\r\nlen = bw << 1;\r\n}\r\nsamples = kcalloc(len, sizeof(struct b43_c32), GFP_KERNEL);\r\nif (!samples) {\r\nb43err(dev->wl, "allocation for samples generation failed\n");\r\nreturn 0;\r\n}\r\nrot = (((freq * 36) / bw) << 16) / 100;\r\nangle = 0;\r\nfor (i = 0; i < len; i++) {\r\nsamples[i] = b43_cordic(angle);\r\nangle += rot;\r\nsamples[i].q = CORDIC_CONVERT(samples[i].q * max);\r\nsamples[i].i = CORDIC_CONVERT(samples[i].i * max);\r\n}\r\ni = b43_nphy_load_samples(dev, samples, len);\r\nkfree(samples);\r\nreturn (i < 0) ? 0 : len;\r\n}\r\nstatic void b43_nphy_run_samples(struct b43_wldev *dev, u16 samps, u16 loops,\r\nu16 wait, bool iqmode, bool dac_test,\r\nbool modify_bbmult)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nint i;\r\nu16 seq_mode;\r\nu32 tmp;\r\nb43_nphy_stay_in_carrier_search(dev, true);\r\nif (phy->rev >= 7) {\r\nbool lpf_bw3, lpf_bw4;\r\nlpf_bw3 = b43_phy_read(dev, B43_NPHY_REV7_RF_CTL_OVER3) & 0x80;\r\nlpf_bw4 = b43_phy_read(dev, B43_NPHY_REV7_RF_CTL_OVER4) & 0x80;\r\nif (lpf_bw3 || lpf_bw4) {\r\n} else {\r\nu16 value = b43_nphy_read_lpf_ctl(dev, 0);\r\nif (phy->rev >= 19)\r\nb43_nphy_rf_ctl_override_rev19(dev, 0x80, value,\r\n0, false, 1);\r\nelse\r\nb43_nphy_rf_ctl_override_rev7(dev, 0x80, value,\r\n0, false, 1);\r\nnphy->lpf_bw_overrode_for_sample_play = true;\r\n}\r\n}\r\nif ((nphy->bb_mult_save & 0x80000000) == 0) {\r\ntmp = b43_ntab_read(dev, B43_NTAB16(15, 87));\r\nnphy->bb_mult_save = (tmp & 0xFFFF) | 0x80000000;\r\n}\r\nif (modify_bbmult) {\r\ntmp = !b43_is_40mhz(dev) ? 0x6464 : 0x4747;\r\nb43_ntab_write(dev, B43_NTAB16(15, 87), tmp);\r\n}\r\nb43_phy_write(dev, B43_NPHY_SAMP_DEPCNT, (samps - 1));\r\nif (loops != 0xFFFF)\r\nb43_phy_write(dev, B43_NPHY_SAMP_LOOPCNT, (loops - 1));\r\nelse\r\nb43_phy_write(dev, B43_NPHY_SAMP_LOOPCNT, loops);\r\nb43_phy_write(dev, B43_NPHY_SAMP_WAITCNT, wait);\r\nseq_mode = b43_phy_read(dev, B43_NPHY_RFSEQMODE);\r\nb43_phy_set(dev, B43_NPHY_RFSEQMODE, B43_NPHY_RFSEQMODE_CAOVER);\r\nif (iqmode) {\r\nb43_phy_mask(dev, B43_NPHY_IQLOCAL_CMDGCTL, 0x7FFF);\r\nb43_phy_set(dev, B43_NPHY_IQLOCAL_CMDGCTL, 0x8000);\r\n} else {\r\ntmp = dac_test ? 5 : 1;\r\nb43_phy_write(dev, B43_NPHY_SAMP_CMD, tmp);\r\n}\r\nfor (i = 0; i < 100; i++) {\r\nif (!(b43_phy_read(dev, B43_NPHY_RFSEQST) & 1)) {\r\ni = 0;\r\nbreak;\r\n}\r\nudelay(10);\r\n}\r\nif (i)\r\nb43err(dev->wl, "run samples timeout\n");\r\nb43_phy_write(dev, B43_NPHY_RFSEQMODE, seq_mode);\r\nb43_nphy_stay_in_carrier_search(dev, false);\r\n}\r\nstatic void b43_nphy_scale_offset_rssi(struct b43_wldev *dev, u16 scale,\r\ns8 offset, u8 core,\r\nenum n_rail_type rail,\r\nenum n_rssi_type rssi_type)\r\n{\r\nu16 tmp;\r\nbool core1or5 = (core == 1) || (core == 5);\r\nbool core2or5 = (core == 2) || (core == 5);\r\noffset = clamp_val(offset, -32, 31);\r\ntmp = ((scale & 0x3F) << 8) | (offset & 0x3F);\r\nswitch (rssi_type) {\r\ncase N_RSSI_NB:\r\nif (core1or5 && rail == N_RAIL_I)\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_0I_RSSI_Z, tmp);\r\nif (core1or5 && rail == N_RAIL_Q)\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_0Q_RSSI_Z, tmp);\r\nif (core2or5 && rail == N_RAIL_I)\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_1I_RSSI_Z, tmp);\r\nif (core2or5 && rail == N_RAIL_Q)\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_1Q_RSSI_Z, tmp);\r\nbreak;\r\ncase N_RSSI_W1:\r\nif (core1or5 && rail == N_RAIL_I)\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_0I_RSSI_X, tmp);\r\nif (core1or5 && rail == N_RAIL_Q)\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_0Q_RSSI_X, tmp);\r\nif (core2or5 && rail == N_RAIL_I)\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_1I_RSSI_X, tmp);\r\nif (core2or5 && rail == N_RAIL_Q)\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_1Q_RSSI_X, tmp);\r\nbreak;\r\ncase N_RSSI_W2:\r\nif (core1or5 && rail == N_RAIL_I)\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_0I_RSSI_Y, tmp);\r\nif (core1or5 && rail == N_RAIL_Q)\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_0Q_RSSI_Y, tmp);\r\nif (core2or5 && rail == N_RAIL_I)\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_1I_RSSI_Y, tmp);\r\nif (core2or5 && rail == N_RAIL_Q)\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_1Q_RSSI_Y, tmp);\r\nbreak;\r\ncase N_RSSI_TBD:\r\nif (core1or5 && rail == N_RAIL_I)\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_0I_TBD, tmp);\r\nif (core1or5 && rail == N_RAIL_Q)\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_0Q_TBD, tmp);\r\nif (core2or5 && rail == N_RAIL_I)\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_1I_TBD, tmp);\r\nif (core2or5 && rail == N_RAIL_Q)\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_1Q_TBD, tmp);\r\nbreak;\r\ncase N_RSSI_IQ:\r\nif (core1or5 && rail == N_RAIL_I)\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_0I_PWRDET, tmp);\r\nif (core1or5 && rail == N_RAIL_Q)\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_0Q_PWRDET, tmp);\r\nif (core2or5 && rail == N_RAIL_I)\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_1I_PWRDET, tmp);\r\nif (core2or5 && rail == N_RAIL_Q)\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_1Q_PWRDET, tmp);\r\nbreak;\r\ncase N_RSSI_TSSI_2G:\r\nif (core1or5)\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_0I_TSSI, tmp);\r\nif (core2or5)\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_1I_TSSI, tmp);\r\nbreak;\r\ncase N_RSSI_TSSI_5G:\r\nif (core1or5)\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_0Q_TSSI, tmp);\r\nif (core2or5)\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_1Q_TSSI, tmp);\r\nbreak;\r\n}\r\n}\r\nstatic void b43_nphy_rssi_select_rev19(struct b43_wldev *dev, u8 code,\r\nenum n_rssi_type rssi_type)\r\n{\r\n}\r\nstatic void b43_nphy_rev3_rssi_select(struct b43_wldev *dev, u8 code,\r\nenum n_rssi_type rssi_type)\r\n{\r\nu8 i;\r\nu16 reg, val;\r\nif (code == 0) {\r\nb43_phy_mask(dev, B43_NPHY_AFECTL_OVER1, 0xFDFF);\r\nb43_phy_mask(dev, B43_NPHY_AFECTL_OVER, 0xFDFF);\r\nb43_phy_mask(dev, B43_NPHY_AFECTL_C1, 0xFCFF);\r\nb43_phy_mask(dev, B43_NPHY_AFECTL_C2, 0xFCFF);\r\nb43_phy_mask(dev, B43_NPHY_TXF_40CO_B1S0, 0xFFDF);\r\nb43_phy_mask(dev, B43_NPHY_TXF_40CO_B32S1, 0xFFDF);\r\nb43_phy_mask(dev, B43_NPHY_RFCTL_LUT_TRSW_UP1, 0xFFC3);\r\nb43_phy_mask(dev, B43_NPHY_RFCTL_LUT_TRSW_UP2, 0xFFC3);\r\n} else {\r\nfor (i = 0; i < 2; i++) {\r\nif ((code == 1 && i == 1) || (code == 2 && !i))\r\ncontinue;\r\nreg = (i == 0) ?\r\nB43_NPHY_AFECTL_OVER1 : B43_NPHY_AFECTL_OVER;\r\nb43_phy_maskset(dev, reg, 0xFDFF, 0x0200);\r\nif (rssi_type == N_RSSI_W1 ||\r\nrssi_type == N_RSSI_W2 ||\r\nrssi_type == N_RSSI_NB) {\r\nreg = (i == 0) ?\r\nB43_NPHY_AFECTL_C1 :\r\nB43_NPHY_AFECTL_C2;\r\nb43_phy_maskset(dev, reg, 0xFCFF, 0);\r\nreg = (i == 0) ?\r\nB43_NPHY_RFCTL_LUT_TRSW_UP1 :\r\nB43_NPHY_RFCTL_LUT_TRSW_UP2;\r\nb43_phy_maskset(dev, reg, 0xFFC3, 0);\r\nif (rssi_type == N_RSSI_W1)\r\nval = (b43_current_band(dev->wl) == NL80211_BAND_5GHZ) ? 4 : 8;\r\nelse if (rssi_type == N_RSSI_W2)\r\nval = 16;\r\nelse\r\nval = 32;\r\nb43_phy_set(dev, reg, val);\r\nreg = (i == 0) ?\r\nB43_NPHY_TXF_40CO_B1S0 :\r\nB43_NPHY_TXF_40CO_B32S1;\r\nb43_phy_set(dev, reg, 0x0020);\r\n} else {\r\nif (rssi_type == N_RSSI_TBD)\r\nval = 0x0100;\r\nelse if (rssi_type == N_RSSI_IQ)\r\nval = 0x0200;\r\nelse\r\nval = 0x0300;\r\nreg = (i == 0) ?\r\nB43_NPHY_AFECTL_C1 :\r\nB43_NPHY_AFECTL_C2;\r\nb43_phy_maskset(dev, reg, 0xFCFF, val);\r\nb43_phy_maskset(dev, reg, 0xF3FF, val << 2);\r\nif (rssi_type != N_RSSI_IQ &&\r\nrssi_type != N_RSSI_TBD) {\r\nenum nl80211_band band =\r\nb43_current_band(dev->wl);\r\nif (dev->phy.rev < 7) {\r\nif (b43_nphy_ipa(dev))\r\nval = (band == NL80211_BAND_5GHZ) ? 0xC : 0xE;\r\nelse\r\nval = 0x11;\r\nreg = (i == 0) ? B2056_TX0 : B2056_TX1;\r\nreg |= B2056_TX_TX_SSI_MUX;\r\nb43_radio_write(dev, reg, val);\r\n}\r\nreg = (i == 0) ?\r\nB43_NPHY_AFECTL_OVER1 :\r\nB43_NPHY_AFECTL_OVER;\r\nb43_phy_set(dev, reg, 0x0200);\r\n}\r\n}\r\n}\r\n}\r\n}\r\nstatic void b43_nphy_rev2_rssi_select(struct b43_wldev *dev, u8 code,\r\nenum n_rssi_type rssi_type)\r\n{\r\nu16 val;\r\nbool rssi_w1_w2_nb = false;\r\nswitch (rssi_type) {\r\ncase N_RSSI_W1:\r\ncase N_RSSI_W2:\r\ncase N_RSSI_NB:\r\nval = 0;\r\nrssi_w1_w2_nb = true;\r\nbreak;\r\ncase N_RSSI_TBD:\r\nval = 1;\r\nbreak;\r\ncase N_RSSI_IQ:\r\nval = 2;\r\nbreak;\r\ndefault:\r\nval = 3;\r\n}\r\nval = (val << 12) | (val << 14);\r\nb43_phy_maskset(dev, B43_NPHY_AFECTL_C1, 0x0FFF, val);\r\nb43_phy_maskset(dev, B43_NPHY_AFECTL_C2, 0x0FFF, val);\r\nif (rssi_w1_w2_nb) {\r\nb43_phy_maskset(dev, B43_NPHY_RFCTL_RSSIO1, 0xFFCF,\r\n(rssi_type + 1) << 4);\r\nb43_phy_maskset(dev, B43_NPHY_RFCTL_RSSIO2, 0xFFCF,\r\n(rssi_type + 1) << 4);\r\n}\r\nif (code == 0) {\r\nb43_phy_mask(dev, B43_NPHY_AFECTL_OVER, ~0x3000);\r\nif (rssi_w1_w2_nb) {\r\nb43_phy_mask(dev, B43_NPHY_RFCTL_CMD,\r\n~(B43_NPHY_RFCTL_CMD_RXEN |\r\nB43_NPHY_RFCTL_CMD_CORESEL));\r\nb43_phy_mask(dev, B43_NPHY_RFCTL_OVER,\r\n~(0x1 << 12 |\r\n0x1 << 5 |\r\n0x1 << 1 |\r\n0x1));\r\nb43_phy_mask(dev, B43_NPHY_RFCTL_CMD,\r\n~B43_NPHY_RFCTL_CMD_START);\r\nudelay(20);\r\nb43_phy_mask(dev, B43_NPHY_RFCTL_OVER, ~0x1);\r\n}\r\n} else {\r\nb43_phy_set(dev, B43_NPHY_AFECTL_OVER, 0x3000);\r\nif (rssi_w1_w2_nb) {\r\nb43_phy_maskset(dev, B43_NPHY_RFCTL_CMD,\r\n~(B43_NPHY_RFCTL_CMD_RXEN |\r\nB43_NPHY_RFCTL_CMD_CORESEL),\r\n(B43_NPHY_RFCTL_CMD_RXEN |\r\ncode << B43_NPHY_RFCTL_CMD_CORESEL_SHIFT));\r\nb43_phy_set(dev, B43_NPHY_RFCTL_OVER,\r\n(0x1 << 12 |\r\n0x1 << 5 |\r\n0x1 << 1 |\r\n0x1));\r\nb43_phy_set(dev, B43_NPHY_RFCTL_CMD,\r\nB43_NPHY_RFCTL_CMD_START);\r\nudelay(20);\r\nb43_phy_mask(dev, B43_NPHY_RFCTL_OVER, ~0x1);\r\n}\r\n}\r\n}\r\nstatic void b43_nphy_rssi_select(struct b43_wldev *dev, u8 code,\r\nenum n_rssi_type type)\r\n{\r\nif (dev->phy.rev >= 19)\r\nb43_nphy_rssi_select_rev19(dev, code, type);\r\nelse if (dev->phy.rev >= 3)\r\nb43_nphy_rev3_rssi_select(dev, code, type);\r\nelse\r\nb43_nphy_rev2_rssi_select(dev, code, type);\r\n}\r\nstatic void b43_nphy_set_rssi_2055_vcm(struct b43_wldev *dev,\r\nenum n_rssi_type rssi_type, u8 *buf)\r\n{\r\nint i;\r\nfor (i = 0; i < 2; i++) {\r\nif (rssi_type == N_RSSI_NB) {\r\nif (i == 0) {\r\nb43_radio_maskset(dev, B2055_C1_B0NB_RSSIVCM,\r\n0xFC, buf[0]);\r\nb43_radio_maskset(dev, B2055_C1_RX_BB_RSSICTL5,\r\n0xFC, buf[1]);\r\n} else {\r\nb43_radio_maskset(dev, B2055_C2_B0NB_RSSIVCM,\r\n0xFC, buf[2 * i]);\r\nb43_radio_maskset(dev, B2055_C2_RX_BB_RSSICTL5,\r\n0xFC, buf[2 * i + 1]);\r\n}\r\n} else {\r\nif (i == 0)\r\nb43_radio_maskset(dev, B2055_C1_RX_BB_RSSICTL5,\r\n0xF3, buf[0] << 2);\r\nelse\r\nb43_radio_maskset(dev, B2055_C2_RX_BB_RSSICTL5,\r\n0xF3, buf[2 * i + 1] << 2);\r\n}\r\n}\r\n}\r\nstatic int b43_nphy_poll_rssi(struct b43_wldev *dev, enum n_rssi_type rssi_type,\r\ns32 *buf, u8 nsamp)\r\n{\r\nint i;\r\nint out;\r\nu16 save_regs_phy[9];\r\nu16 s[2];\r\nif (dev->phy.rev >= 3) {\r\nsave_regs_phy[0] = b43_phy_read(dev, B43_NPHY_AFECTL_C1);\r\nsave_regs_phy[1] = b43_phy_read(dev, B43_NPHY_AFECTL_C2);\r\nsave_regs_phy[2] = b43_phy_read(dev,\r\nB43_NPHY_RFCTL_LUT_TRSW_UP1);\r\nsave_regs_phy[3] = b43_phy_read(dev,\r\nB43_NPHY_RFCTL_LUT_TRSW_UP2);\r\nsave_regs_phy[4] = b43_phy_read(dev, B43_NPHY_AFECTL_OVER1);\r\nsave_regs_phy[5] = b43_phy_read(dev, B43_NPHY_AFECTL_OVER);\r\nsave_regs_phy[6] = b43_phy_read(dev, B43_NPHY_TXF_40CO_B1S0);\r\nsave_regs_phy[7] = b43_phy_read(dev, B43_NPHY_TXF_40CO_B32S1);\r\nsave_regs_phy[8] = 0;\r\n} else {\r\nsave_regs_phy[0] = b43_phy_read(dev, B43_NPHY_AFECTL_C1);\r\nsave_regs_phy[1] = b43_phy_read(dev, B43_NPHY_AFECTL_C2);\r\nsave_regs_phy[2] = b43_phy_read(dev, B43_NPHY_AFECTL_OVER);\r\nsave_regs_phy[3] = b43_phy_read(dev, B43_NPHY_RFCTL_CMD);\r\nsave_regs_phy[4] = b43_phy_read(dev, B43_NPHY_RFCTL_OVER);\r\nsave_regs_phy[5] = b43_phy_read(dev, B43_NPHY_RFCTL_RSSIO1);\r\nsave_regs_phy[6] = b43_phy_read(dev, B43_NPHY_RFCTL_RSSIO2);\r\nsave_regs_phy[7] = 0;\r\nsave_regs_phy[8] = 0;\r\n}\r\nb43_nphy_rssi_select(dev, 5, rssi_type);\r\nif (dev->phy.rev < 2) {\r\nsave_regs_phy[8] = b43_phy_read(dev, B43_NPHY_GPIO_SEL);\r\nb43_phy_write(dev, B43_NPHY_GPIO_SEL, 5);\r\n}\r\nfor (i = 0; i < 4; i++)\r\nbuf[i] = 0;\r\nfor (i = 0; i < nsamp; i++) {\r\nif (dev->phy.rev < 2) {\r\ns[0] = b43_phy_read(dev, B43_NPHY_GPIO_LOOUT);\r\ns[1] = b43_phy_read(dev, B43_NPHY_GPIO_HIOUT);\r\n} else {\r\ns[0] = b43_phy_read(dev, B43_NPHY_RSSI1);\r\ns[1] = b43_phy_read(dev, B43_NPHY_RSSI2);\r\n}\r\nbuf[0] += ((s8)((s[0] & 0x3F) << 2)) >> 2;\r\nbuf[1] += ((s8)(((s[0] >> 8) & 0x3F) << 2)) >> 2;\r\nbuf[2] += ((s8)((s[1] & 0x3F) << 2)) >> 2;\r\nbuf[3] += ((s8)(((s[1] >> 8) & 0x3F) << 2)) >> 2;\r\n}\r\nout = (buf[0] & 0xFF) << 24 | (buf[1] & 0xFF) << 16 |\r\n(buf[2] & 0xFF) << 8 | (buf[3] & 0xFF);\r\nif (dev->phy.rev < 2)\r\nb43_phy_write(dev, B43_NPHY_GPIO_SEL, save_regs_phy[8]);\r\nif (dev->phy.rev >= 3) {\r\nb43_phy_write(dev, B43_NPHY_AFECTL_C1, save_regs_phy[0]);\r\nb43_phy_write(dev, B43_NPHY_AFECTL_C2, save_regs_phy[1]);\r\nb43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_UP1,\r\nsave_regs_phy[2]);\r\nb43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_UP2,\r\nsave_regs_phy[3]);\r\nb43_phy_write(dev, B43_NPHY_AFECTL_OVER1, save_regs_phy[4]);\r\nb43_phy_write(dev, B43_NPHY_AFECTL_OVER, save_regs_phy[5]);\r\nb43_phy_write(dev, B43_NPHY_TXF_40CO_B1S0, save_regs_phy[6]);\r\nb43_phy_write(dev, B43_NPHY_TXF_40CO_B32S1, save_regs_phy[7]);\r\n} else {\r\nb43_phy_write(dev, B43_NPHY_AFECTL_C1, save_regs_phy[0]);\r\nb43_phy_write(dev, B43_NPHY_AFECTL_C2, save_regs_phy[1]);\r\nb43_phy_write(dev, B43_NPHY_AFECTL_OVER, save_regs_phy[2]);\r\nb43_phy_write(dev, B43_NPHY_RFCTL_CMD, save_regs_phy[3]);\r\nb43_phy_write(dev, B43_NPHY_RFCTL_OVER, save_regs_phy[4]);\r\nb43_phy_write(dev, B43_NPHY_RFCTL_RSSIO1, save_regs_phy[5]);\r\nb43_phy_write(dev, B43_NPHY_RFCTL_RSSIO2, save_regs_phy[6]);\r\n}\r\nreturn out;\r\n}\r\nstatic void b43_nphy_rev3_rssi_cal(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nu16 saved_regs_phy_rfctl[2];\r\nu16 saved_regs_phy[22];\r\nu16 regs_to_store_rev3[] = {\r\nB43_NPHY_AFECTL_OVER1, B43_NPHY_AFECTL_OVER,\r\nB43_NPHY_AFECTL_C1, B43_NPHY_AFECTL_C2,\r\nB43_NPHY_TXF_40CO_B1S1, B43_NPHY_RFCTL_OVER,\r\nB43_NPHY_TXF_40CO_B1S0, B43_NPHY_TXF_40CO_B32S1,\r\nB43_NPHY_RFCTL_CMD,\r\nB43_NPHY_RFCTL_LUT_TRSW_UP1, B43_NPHY_RFCTL_LUT_TRSW_UP2,\r\nB43_NPHY_RFCTL_RSSIO1, B43_NPHY_RFCTL_RSSIO2\r\n};\r\nu16 regs_to_store_rev7[] = {\r\nB43_NPHY_AFECTL_OVER1, B43_NPHY_AFECTL_OVER,\r\nB43_NPHY_AFECTL_C1, B43_NPHY_AFECTL_C2,\r\nB43_NPHY_TXF_40CO_B1S1, B43_NPHY_RFCTL_OVER,\r\nB43_NPHY_REV7_RF_CTL_OVER3, B43_NPHY_REV7_RF_CTL_OVER4,\r\nB43_NPHY_REV7_RF_CTL_OVER5, B43_NPHY_REV7_RF_CTL_OVER6,\r\n0x2ff,\r\nB43_NPHY_TXF_40CO_B1S0, B43_NPHY_TXF_40CO_B32S1,\r\nB43_NPHY_RFCTL_CMD,\r\nB43_NPHY_RFCTL_LUT_TRSW_UP1, B43_NPHY_RFCTL_LUT_TRSW_UP2,\r\nB43_NPHY_REV7_RF_CTL_MISC_REG3, B43_NPHY_REV7_RF_CTL_MISC_REG4,\r\nB43_NPHY_REV7_RF_CTL_MISC_REG5, B43_NPHY_REV7_RF_CTL_MISC_REG6,\r\nB43_NPHY_RFCTL_RSSIO1, B43_NPHY_RFCTL_RSSIO2\r\n};\r\nu16 *regs_to_store;\r\nint regs_amount;\r\nu16 class;\r\nu16 clip_state[2];\r\nu16 clip_off[2] = { 0xFFFF, 0xFFFF };\r\nu8 vcm_final = 0;\r\ns32 offset[4];\r\ns32 results[8][4] = { };\r\ns32 results_min[4] = { };\r\ns32 poll_results[4] = { };\r\nu16 *rssical_radio_regs = NULL;\r\nu16 *rssical_phy_regs = NULL;\r\nu16 r;\r\nu8 rx_core_state;\r\nint core, i, j, vcm;\r\nif (dev->phy.rev >= 7) {\r\nregs_to_store = regs_to_store_rev7;\r\nregs_amount = ARRAY_SIZE(regs_to_store_rev7);\r\n} else {\r\nregs_to_store = regs_to_store_rev3;\r\nregs_amount = ARRAY_SIZE(regs_to_store_rev3);\r\n}\r\nBUG_ON(regs_amount > ARRAY_SIZE(saved_regs_phy));\r\nclass = b43_nphy_classifier(dev, 0, 0);\r\nb43_nphy_classifier(dev, 7, 4);\r\nb43_nphy_read_clip_detection(dev, clip_state);\r\nb43_nphy_write_clip_detection(dev, clip_off);\r\nsaved_regs_phy_rfctl[0] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC1);\r\nsaved_regs_phy_rfctl[1] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC2);\r\nfor (i = 0; i < regs_amount; i++)\r\nsaved_regs_phy[i] = b43_phy_read(dev, regs_to_store[i]);\r\nb43_nphy_rf_ctl_intc_override(dev, N_INTC_OVERRIDE_OFF, 0, 7);\r\nb43_nphy_rf_ctl_intc_override(dev, N_INTC_OVERRIDE_TRSW, 1, 7);\r\nif (dev->phy.rev >= 7) {\r\nb43_nphy_rf_ctl_override_one_to_many(dev,\r\nN_RF_CTL_OVER_CMD_RXRF_PU,\r\n0, 0, false);\r\nb43_nphy_rf_ctl_override_one_to_many(dev,\r\nN_RF_CTL_OVER_CMD_RX_PU,\r\n1, 0, false);\r\nb43_nphy_rf_ctl_override_rev7(dev, 0x80, 1, 0, false, 0);\r\nb43_nphy_rf_ctl_override_rev7(dev, 0x40, 1, 0, false, 0);\r\nif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ) {\r\nb43_nphy_rf_ctl_override_rev7(dev, 0x20, 0, 0, false,\r\n0);\r\nb43_nphy_rf_ctl_override_rev7(dev, 0x10, 1, 0, false,\r\n0);\r\n} else {\r\nb43_nphy_rf_ctl_override_rev7(dev, 0x10, 0, 0, false,\r\n0);\r\nb43_nphy_rf_ctl_override_rev7(dev, 0x20, 1, 0, false,\r\n0);\r\n}\r\n} else {\r\nb43_nphy_rf_ctl_override(dev, 0x1, 0, 0, false);\r\nb43_nphy_rf_ctl_override(dev, 0x2, 1, 0, false);\r\nb43_nphy_rf_ctl_override(dev, 0x80, 1, 0, false);\r\nb43_nphy_rf_ctl_override(dev, 0x40, 1, 0, false);\r\nif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ) {\r\nb43_nphy_rf_ctl_override(dev, 0x20, 0, 0, false);\r\nb43_nphy_rf_ctl_override(dev, 0x10, 1, 0, false);\r\n} else {\r\nb43_nphy_rf_ctl_override(dev, 0x10, 0, 0, false);\r\nb43_nphy_rf_ctl_override(dev, 0x20, 1, 0, false);\r\n}\r\n}\r\nrx_core_state = b43_nphy_get_rx_core_state(dev);\r\nfor (core = 0; core < 2; core++) {\r\nif (!(rx_core_state & (1 << core)))\r\ncontinue;\r\nr = core ? B2056_RX1 : B2056_RX0;\r\nb43_nphy_scale_offset_rssi(dev, 0, 0, core + 1, N_RAIL_I,\r\nN_RSSI_NB);\r\nb43_nphy_scale_offset_rssi(dev, 0, 0, core + 1, N_RAIL_Q,\r\nN_RSSI_NB);\r\nfor (vcm = 0; vcm < 8; vcm++) {\r\nif (dev->phy.rev >= 7)\r\nb43_radio_maskset(dev,\r\ncore ? R2057_NB_MASTER_CORE1 :\r\nR2057_NB_MASTER_CORE0,\r\n~R2057_VCM_MASK, vcm);\r\nelse\r\nb43_radio_maskset(dev, r | B2056_RX_RSSI_MISC,\r\n0xE3, vcm << 2);\r\nb43_nphy_poll_rssi(dev, N_RSSI_NB, results[vcm], 8);\r\n}\r\nfor (i = 0; i < 4; i += 2) {\r\ns32 currd;\r\ns32 mind = 0x100000;\r\ns32 minpoll = 249;\r\nu8 minvcm = 0;\r\nif (2 * core != i)\r\ncontinue;\r\nfor (vcm = 0; vcm < 8; vcm++) {\r\ncurrd = results[vcm][i] * results[vcm][i] +\r\nresults[vcm][i + 1] * results[vcm][i];\r\nif (currd < mind) {\r\nmind = currd;\r\nminvcm = vcm;\r\n}\r\nif (results[vcm][i] < minpoll)\r\nminpoll = results[vcm][i];\r\n}\r\nvcm_final = minvcm;\r\nresults_min[i] = minpoll;\r\n}\r\nif (dev->phy.rev >= 7)\r\nb43_radio_maskset(dev,\r\ncore ? R2057_NB_MASTER_CORE1 :\r\nR2057_NB_MASTER_CORE0,\r\n~R2057_VCM_MASK, vcm);\r\nelse\r\nb43_radio_maskset(dev, r | B2056_RX_RSSI_MISC,\r\n0xE3, vcm_final << 2);\r\nfor (i = 0; i < 4; i++) {\r\nif (core != i / 2)\r\ncontinue;\r\noffset[i] = -results[vcm_final][i];\r\nif (offset[i] < 0)\r\noffset[i] = -((abs(offset[i]) + 4) / 8);\r\nelse\r\noffset[i] = (offset[i] + 4) / 8;\r\nif (results_min[i] == 248)\r\noffset[i] = -32;\r\nb43_nphy_scale_offset_rssi(dev, 0, offset[i],\r\n(i / 2 == 0) ? 1 : 2,\r\n(i % 2 == 0) ? N_RAIL_I : N_RAIL_Q,\r\nN_RSSI_NB);\r\n}\r\n}\r\nfor (core = 0; core < 2; core++) {\r\nif (!(rx_core_state & (1 << core)))\r\ncontinue;\r\nfor (i = 0; i < 2; i++) {\r\nb43_nphy_scale_offset_rssi(dev, 0, 0, core + 1,\r\nN_RAIL_I, i);\r\nb43_nphy_scale_offset_rssi(dev, 0, 0, core + 1,\r\nN_RAIL_Q, i);\r\nb43_nphy_poll_rssi(dev, i, poll_results, 8);\r\nfor (j = 0; j < 4; j++) {\r\nif (j / 2 == core) {\r\noffset[j] = 232 - poll_results[j];\r\nif (offset[j] < 0)\r\noffset[j] = -(abs(offset[j] + 4) / 8);\r\nelse\r\noffset[j] = (offset[j] + 4) / 8;\r\nb43_nphy_scale_offset_rssi(dev, 0,\r\noffset[2 * core], core + 1, j % 2, i);\r\n}\r\n}\r\n}\r\n}\r\nb43_phy_write(dev, B43_NPHY_RFCTL_INTC1, saved_regs_phy_rfctl[0]);\r\nb43_phy_write(dev, B43_NPHY_RFCTL_INTC2, saved_regs_phy_rfctl[1]);\r\nb43_nphy_force_rf_sequence(dev, B43_RFSEQ_RESET2RX);\r\nb43_phy_set(dev, B43_NPHY_TXF_40CO_B1S1, 0x1);\r\nb43_phy_set(dev, B43_NPHY_RFCTL_CMD, B43_NPHY_RFCTL_CMD_START);\r\nb43_phy_mask(dev, B43_NPHY_TXF_40CO_B1S1, ~0x1);\r\nb43_phy_set(dev, B43_NPHY_RFCTL_OVER, 0x1);\r\nb43_phy_set(dev, B43_NPHY_RFCTL_CMD, B43_NPHY_RFCTL_CMD_RXTX);\r\nb43_phy_mask(dev, B43_NPHY_RFCTL_OVER, ~0x1);\r\nfor (i = 0; i < regs_amount; i++)\r\nb43_phy_write(dev, regs_to_store[i], saved_regs_phy[i]);\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\r\nrssical_radio_regs = nphy->rssical_cache.rssical_radio_regs_2G;\r\nrssical_phy_regs = nphy->rssical_cache.rssical_phy_regs_2G;\r\n} else {\r\nrssical_radio_regs = nphy->rssical_cache.rssical_radio_regs_5G;\r\nrssical_phy_regs = nphy->rssical_cache.rssical_phy_regs_5G;\r\n}\r\nif (dev->phy.rev >= 7) {\r\nrssical_radio_regs[0] = b43_radio_read(dev,\r\nR2057_NB_MASTER_CORE0);\r\nrssical_radio_regs[1] = b43_radio_read(dev,\r\nR2057_NB_MASTER_CORE1);\r\n} else {\r\nrssical_radio_regs[0] = b43_radio_read(dev, B2056_RX0 |\r\nB2056_RX_RSSI_MISC);\r\nrssical_radio_regs[1] = b43_radio_read(dev, B2056_RX1 |\r\nB2056_RX_RSSI_MISC);\r\n}\r\nrssical_phy_regs[0] = b43_phy_read(dev, B43_NPHY_RSSIMC_0I_RSSI_Z);\r\nrssical_phy_regs[1] = b43_phy_read(dev, B43_NPHY_RSSIMC_0Q_RSSI_Z);\r\nrssical_phy_regs[2] = b43_phy_read(dev, B43_NPHY_RSSIMC_1I_RSSI_Z);\r\nrssical_phy_regs[3] = b43_phy_read(dev, B43_NPHY_RSSIMC_1Q_RSSI_Z);\r\nrssical_phy_regs[4] = b43_phy_read(dev, B43_NPHY_RSSIMC_0I_RSSI_X);\r\nrssical_phy_regs[5] = b43_phy_read(dev, B43_NPHY_RSSIMC_0Q_RSSI_X);\r\nrssical_phy_regs[6] = b43_phy_read(dev, B43_NPHY_RSSIMC_1I_RSSI_X);\r\nrssical_phy_regs[7] = b43_phy_read(dev, B43_NPHY_RSSIMC_1Q_RSSI_X);\r\nrssical_phy_regs[8] = b43_phy_read(dev, B43_NPHY_RSSIMC_0I_RSSI_Y);\r\nrssical_phy_regs[9] = b43_phy_read(dev, B43_NPHY_RSSIMC_0Q_RSSI_Y);\r\nrssical_phy_regs[10] = b43_phy_read(dev, B43_NPHY_RSSIMC_1I_RSSI_Y);\r\nrssical_phy_regs[11] = b43_phy_read(dev, B43_NPHY_RSSIMC_1Q_RSSI_Y);\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\r\nnphy->rssical_chanspec_2G.center_freq = phy->chandef->chan->center_freq;\r\nelse\r\nnphy->rssical_chanspec_5G.center_freq = phy->chandef->chan->center_freq;\r\nb43_nphy_classifier(dev, 7, class);\r\nb43_nphy_write_clip_detection(dev, clip_state);\r\n}\r\nstatic void b43_nphy_rev2_rssi_cal(struct b43_wldev *dev, enum n_rssi_type type)\r\n{\r\nint i, j, vcm;\r\nu8 state[4];\r\nu8 code, val;\r\nu16 class, override;\r\nu8 regs_save_radio[2];\r\nu16 regs_save_phy[2];\r\ns32 offset[4];\r\nu8 core;\r\nu8 rail;\r\nu16 clip_state[2];\r\nu16 clip_off[2] = { 0xFFFF, 0xFFFF };\r\ns32 results_min[4] = { };\r\nu8 vcm_final[4] = { };\r\ns32 results[4][4] = { };\r\ns32 miniq[4][2] = { };\r\nif (type == N_RSSI_NB) {\r\ncode = 0;\r\nval = 6;\r\n} else if (type == N_RSSI_W1 || type == N_RSSI_W2) {\r\ncode = 25;\r\nval = 4;\r\n} else {\r\nB43_WARN_ON(1);\r\nreturn;\r\n}\r\nclass = b43_nphy_classifier(dev, 0, 0);\r\nb43_nphy_classifier(dev, 7, 4);\r\nb43_nphy_read_clip_detection(dev, clip_state);\r\nb43_nphy_write_clip_detection(dev, clip_off);\r\nif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ)\r\noverride = 0x140;\r\nelse\r\noverride = 0x110;\r\nregs_save_phy[0] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC1);\r\nregs_save_radio[0] = b43_radio_read(dev, B2055_C1_PD_RXTX);\r\nb43_phy_write(dev, B43_NPHY_RFCTL_INTC1, override);\r\nb43_radio_write(dev, B2055_C1_PD_RXTX, val);\r\nregs_save_phy[1] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC2);\r\nregs_save_radio[1] = b43_radio_read(dev, B2055_C2_PD_RXTX);\r\nb43_phy_write(dev, B43_NPHY_RFCTL_INTC2, override);\r\nb43_radio_write(dev, B2055_C2_PD_RXTX, val);\r\nstate[0] = b43_radio_read(dev, B2055_C1_PD_RSSIMISC) & 0x07;\r\nstate[1] = b43_radio_read(dev, B2055_C2_PD_RSSIMISC) & 0x07;\r\nb43_radio_mask(dev, B2055_C1_PD_RSSIMISC, 0xF8);\r\nb43_radio_mask(dev, B2055_C2_PD_RSSIMISC, 0xF8);\r\nstate[2] = b43_radio_read(dev, B2055_C1_SP_RSSI) & 0x07;\r\nstate[3] = b43_radio_read(dev, B2055_C2_SP_RSSI) & 0x07;\r\nb43_nphy_rssi_select(dev, 5, type);\r\nb43_nphy_scale_offset_rssi(dev, 0, 0, 5, N_RAIL_I, type);\r\nb43_nphy_scale_offset_rssi(dev, 0, 0, 5, N_RAIL_Q, type);\r\nfor (vcm = 0; vcm < 4; vcm++) {\r\nu8 tmp[4];\r\nfor (j = 0; j < 4; j++)\r\ntmp[j] = vcm;\r\nif (type != N_RSSI_W2)\r\nb43_nphy_set_rssi_2055_vcm(dev, type, tmp);\r\nb43_nphy_poll_rssi(dev, type, results[vcm], 8);\r\nif (type == N_RSSI_W1 || type == N_RSSI_W2)\r\nfor (j = 0; j < 2; j++)\r\nminiq[vcm][j] = min(results[vcm][2 * j],\r\nresults[vcm][2 * j + 1]);\r\n}\r\nfor (i = 0; i < 4; i++) {\r\ns32 mind = 0x100000;\r\nu8 minvcm = 0;\r\ns32 minpoll = 249;\r\ns32 currd;\r\nfor (vcm = 0; vcm < 4; vcm++) {\r\nif (type == N_RSSI_NB)\r\ncurrd = abs(results[vcm][i] - code * 8);\r\nelse\r\ncurrd = abs(miniq[vcm][i / 2] - code * 8);\r\nif (currd < mind) {\r\nmind = currd;\r\nminvcm = vcm;\r\n}\r\nif (results[vcm][i] < minpoll)\r\nminpoll = results[vcm][i];\r\n}\r\nresults_min[i] = minpoll;\r\nvcm_final[i] = minvcm;\r\n}\r\nif (type != N_RSSI_W2)\r\nb43_nphy_set_rssi_2055_vcm(dev, type, vcm_final);\r\nfor (i = 0; i < 4; i++) {\r\noffset[i] = (code * 8) - results[vcm_final[i]][i];\r\nif (offset[i] < 0)\r\noffset[i] = -((abs(offset[i]) + 4) / 8);\r\nelse\r\noffset[i] = (offset[i] + 4) / 8;\r\nif (results_min[i] == 248)\r\noffset[i] = code - 32;\r\ncore = (i / 2) ? 2 : 1;\r\nrail = (i % 2) ? N_RAIL_Q : N_RAIL_I;\r\nb43_nphy_scale_offset_rssi(dev, 0, offset[i], core, rail,\r\ntype);\r\n}\r\nb43_radio_maskset(dev, B2055_C1_PD_RSSIMISC, 0xF8, state[0]);\r\nb43_radio_maskset(dev, B2055_C2_PD_RSSIMISC, 0xF8, state[1]);\r\nswitch (state[2]) {\r\ncase 1:\r\nb43_nphy_rssi_select(dev, 1, N_RSSI_NB);\r\nbreak;\r\ncase 4:\r\nb43_nphy_rssi_select(dev, 1, N_RSSI_W1);\r\nbreak;\r\ncase 2:\r\nb43_nphy_rssi_select(dev, 1, N_RSSI_W2);\r\nbreak;\r\ndefault:\r\nb43_nphy_rssi_select(dev, 1, N_RSSI_W2);\r\nbreak;\r\n}\r\nswitch (state[3]) {\r\ncase 1:\r\nb43_nphy_rssi_select(dev, 2, N_RSSI_NB);\r\nbreak;\r\ncase 4:\r\nb43_nphy_rssi_select(dev, 2, N_RSSI_W1);\r\nbreak;\r\ndefault:\r\nb43_nphy_rssi_select(dev, 2, N_RSSI_W2);\r\nbreak;\r\n}\r\nb43_nphy_rssi_select(dev, 0, type);\r\nb43_phy_write(dev, B43_NPHY_RFCTL_INTC1, regs_save_phy[0]);\r\nb43_radio_write(dev, B2055_C1_PD_RXTX, regs_save_radio[0]);\r\nb43_phy_write(dev, B43_NPHY_RFCTL_INTC2, regs_save_phy[1]);\r\nb43_radio_write(dev, B2055_C2_PD_RXTX, regs_save_radio[1]);\r\nb43_nphy_classifier(dev, 7, class);\r\nb43_nphy_write_clip_detection(dev, clip_state);\r\nb43_nphy_reset_cca(dev);\r\n}\r\nstatic void b43_nphy_rssi_cal(struct b43_wldev *dev)\r\n{\r\nif (dev->phy.rev >= 19) {\r\n} else if (dev->phy.rev >= 3) {\r\nb43_nphy_rev3_rssi_cal(dev);\r\n} else {\r\nb43_nphy_rev2_rssi_cal(dev, N_RSSI_NB);\r\nb43_nphy_rev2_rssi_cal(dev, N_RSSI_W1);\r\nb43_nphy_rev2_rssi_cal(dev, N_RSSI_W2);\r\n}\r\n}\r\nstatic void b43_nphy_gain_ctl_workarounds_rev19(struct b43_wldev *dev)\r\n{\r\n}\r\nstatic void b43_nphy_gain_ctl_workarounds_rev7(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nswitch (phy->rev) {\r\n}\r\n}\r\nstatic void b43_nphy_gain_ctl_workarounds_rev3(struct b43_wldev *dev)\r\n{\r\nstruct ssb_sprom *sprom = dev->dev->bus_sprom;\r\nbool ghz5;\r\nbool ext_lna;\r\nu16 rssi_gain;\r\nstruct nphy_gain_ctl_workaround_entry *e;\r\nu8 lpf_gain[6] = { 0x00, 0x06, 0x0C, 0x12, 0x12, 0x12 };\r\nu8 lpf_bits[6] = { 0, 1, 2, 3, 3, 3 };\r\nghz5 = b43_phy_read(dev, B43_NPHY_BANDCTL)\r\n& B43_NPHY_BANDCTL_5GHZ;\r\next_lna = ghz5 ? sprom->boardflags_hi & B43_BFH_EXTLNA_5GHZ :\r\nsprom->boardflags_lo & B43_BFL_EXTLNA;\r\ne = b43_nphy_get_gain_ctl_workaround_ent(dev, ghz5, ext_lna);\r\nif (ghz5 && dev->phy.rev >= 5)\r\nrssi_gain = 0x90;\r\nelse\r\nrssi_gain = 0x50;\r\nb43_phy_set(dev, B43_NPHY_RXCTL, 0x0040);\r\nb43_phy_set(dev, B43_NPHY_C1_CGAINI, B43_NPHY_C1_CGAINI_CL2DETECT);\r\nb43_phy_set(dev, B43_NPHY_C2_CGAINI, B43_NPHY_C2_CGAINI_CL2DETECT);\r\nb43_radio_write(dev, B2056_RX0 | B2056_RX_BIASPOLE_LNAG1_IDAC,\r\n0x17);\r\nb43_radio_write(dev, B2056_RX1 | B2056_RX_BIASPOLE_LNAG1_IDAC,\r\n0x17);\r\nb43_radio_write(dev, B2056_RX0 | B2056_RX_LNAG2_IDAC, 0xF0);\r\nb43_radio_write(dev, B2056_RX1 | B2056_RX_LNAG2_IDAC, 0xF0);\r\nb43_radio_write(dev, B2056_RX0 | B2056_RX_RSSI_POLE, 0x00);\r\nb43_radio_write(dev, B2056_RX1 | B2056_RX_RSSI_POLE, 0x00);\r\nb43_radio_write(dev, B2056_RX0 | B2056_RX_RSSI_GAIN,\r\nrssi_gain);\r\nb43_radio_write(dev, B2056_RX1 | B2056_RX_RSSI_GAIN,\r\nrssi_gain);\r\nb43_radio_write(dev, B2056_RX0 | B2056_RX_BIASPOLE_LNAA1_IDAC,\r\n0x17);\r\nb43_radio_write(dev, B2056_RX1 | B2056_RX_BIASPOLE_LNAA1_IDAC,\r\n0x17);\r\nb43_radio_write(dev, B2056_RX0 | B2056_RX_LNAA2_IDAC, 0xFF);\r\nb43_radio_write(dev, B2056_RX1 | B2056_RX_LNAA2_IDAC, 0xFF);\r\nb43_ntab_write_bulk(dev, B43_NTAB8(0, 8), 4, e->lna1_gain);\r\nb43_ntab_write_bulk(dev, B43_NTAB8(1, 8), 4, e->lna1_gain);\r\nb43_ntab_write_bulk(dev, B43_NTAB8(0, 16), 4, e->lna2_gain);\r\nb43_ntab_write_bulk(dev, B43_NTAB8(1, 16), 4, e->lna2_gain);\r\nb43_ntab_write_bulk(dev, B43_NTAB8(0, 32), 10, e->gain_db);\r\nb43_ntab_write_bulk(dev, B43_NTAB8(1, 32), 10, e->gain_db);\r\nb43_ntab_write_bulk(dev, B43_NTAB8(2, 32), 10, e->gain_bits);\r\nb43_ntab_write_bulk(dev, B43_NTAB8(3, 32), 10, e->gain_bits);\r\nb43_ntab_write_bulk(dev, B43_NTAB8(0, 0x40), 6, lpf_gain);\r\nb43_ntab_write_bulk(dev, B43_NTAB8(1, 0x40), 6, lpf_gain);\r\nb43_ntab_write_bulk(dev, B43_NTAB8(2, 0x40), 6, lpf_bits);\r\nb43_ntab_write_bulk(dev, B43_NTAB8(3, 0x40), 6, lpf_bits);\r\nb43_phy_write(dev, B43_NPHY_REV3_C1_INITGAIN_A, e->init_gain);\r\nb43_phy_write(dev, B43_NPHY_REV3_C2_INITGAIN_A, e->init_gain);\r\nb43_ntab_write_bulk(dev, B43_NTAB16(7, 0x106), 2,\r\ne->rfseq_init);\r\nb43_phy_write(dev, B43_NPHY_REV3_C1_CLIP_HIGAIN_A, e->cliphi_gain);\r\nb43_phy_write(dev, B43_NPHY_REV3_C2_CLIP_HIGAIN_A, e->cliphi_gain);\r\nb43_phy_write(dev, B43_NPHY_REV3_C1_CLIP_MEDGAIN_A, e->clipmd_gain);\r\nb43_phy_write(dev, B43_NPHY_REV3_C2_CLIP_MEDGAIN_A, e->clipmd_gain);\r\nb43_phy_write(dev, B43_NPHY_REV3_C1_CLIP_LOGAIN_A, e->cliplo_gain);\r\nb43_phy_write(dev, B43_NPHY_REV3_C2_CLIP_LOGAIN_A, e->cliplo_gain);\r\nb43_phy_maskset(dev, B43_NPHY_CRSMINPOWER0, 0xFF00, e->crsmin);\r\nb43_phy_maskset(dev, B43_NPHY_CRSMINPOWERL0, 0xFF00, e->crsminl);\r\nb43_phy_maskset(dev, B43_NPHY_CRSMINPOWERU0, 0xFF00, e->crsminu);\r\nb43_phy_write(dev, B43_NPHY_C1_NBCLIPTHRES, e->nbclip);\r\nb43_phy_write(dev, B43_NPHY_C2_NBCLIPTHRES, e->nbclip);\r\nb43_phy_maskset(dev, B43_NPHY_C1_CLIPWBTHRES,\r\n~B43_NPHY_C1_CLIPWBTHRES_CLIP2, e->wlclip);\r\nb43_phy_maskset(dev, B43_NPHY_C2_CLIPWBTHRES,\r\n~B43_NPHY_C2_CLIPWBTHRES_CLIP2, e->wlclip);\r\nb43_phy_write(dev, B43_NPHY_CCK_SHIFTB_REF, 0x809C);\r\n}\r\nstatic void b43_nphy_gain_ctl_workarounds_rev1_2(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nu8 i, j;\r\nu8 code;\r\nu16 tmp;\r\nu8 rfseq_events[3] = { 6, 8, 7 };\r\nu8 rfseq_delays[3] = { 10, 30, 1 };\r\nb43_phy_set(dev, B43_NPHY_C1_CGAINI, B43_NPHY_C1_CGAINI_CL2DETECT);\r\nb43_phy_set(dev, B43_NPHY_C2_CGAINI, B43_NPHY_C2_CGAINI_CL2DETECT);\r\nb43_phy_write(dev, B43_NPHY_C1_NBCLIPTHRES, 0x84);\r\nb43_phy_write(dev, B43_NPHY_C2_NBCLIPTHRES, 0x84);\r\nif (!b43_is_40mhz(dev)) {\r\nb43_phy_write(dev, B43_NPHY_CLIP1_NBDWELL_LEN, 0x002B);\r\nb43_phy_write(dev, B43_NPHY_CLIP2_NBDWELL_LEN, 0x002B);\r\nb43_phy_write(dev, B43_NPHY_W1CLIP1_DWELL_LEN, 0x0009);\r\nb43_phy_write(dev, B43_NPHY_W1CLIP2_DWELL_LEN, 0x0009);\r\n}\r\nb43_phy_maskset(dev, B43_NPHY_C1_CLIPWBTHRES,\r\n~B43_NPHY_C1_CLIPWBTHRES_CLIP2, 21);\r\nb43_phy_maskset(dev, B43_NPHY_C2_CLIPWBTHRES,\r\n~B43_NPHY_C2_CLIPWBTHRES_CLIP2, 21);\r\nif (!b43_is_40mhz(dev)) {\r\nb43_phy_maskset(dev, B43_NPHY_C1_CGAINI,\r\n~B43_NPHY_C1_CGAINI_GAINBKOFF, 0x1);\r\nb43_phy_maskset(dev, B43_NPHY_C2_CGAINI,\r\n~B43_NPHY_C2_CGAINI_GAINBKOFF, 0x1);\r\nb43_phy_maskset(dev, B43_NPHY_C1_CCK_CGAINI,\r\n~B43_NPHY_C1_CCK_CGAINI_GAINBKOFF, 0x1);\r\nb43_phy_maskset(dev, B43_NPHY_C2_CCK_CGAINI,\r\n~B43_NPHY_C2_CCK_CGAINI_GAINBKOFF, 0x1);\r\n}\r\nb43_phy_write(dev, B43_NPHY_CCK_SHIFTB_REF, 0x809C);\r\nif (nphy->gain_boost) {\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ &&\r\nb43_is_40mhz(dev))\r\ncode = 4;\r\nelse\r\ncode = 5;\r\n} else {\r\ncode = b43_is_40mhz(dev) ? 6 : 7;\r\n}\r\nb43_phy_maskset(dev, B43_NPHY_C1_INITGAIN, ~B43_NPHY_C1_INITGAIN_HPVGA2,\r\ncode << B43_NPHY_C1_INITGAIN_HPVGA2_SHIFT);\r\nb43_phy_maskset(dev, B43_NPHY_C2_INITGAIN, ~B43_NPHY_C2_INITGAIN_HPVGA2,\r\ncode << B43_NPHY_C2_INITGAIN_HPVGA2_SHIFT);\r\nb43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x1D06);\r\nfor (i = 0; i < 4; i++)\r\nb43_phy_write(dev, B43_NPHY_TABLE_DATALO, (code << 8 | 0x7C));\r\nb43_nphy_adjust_lna_gain_table(dev);\r\nif (nphy->elna_gain_config) {\r\nb43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x0808);\r\nb43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x0);\r\nb43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x1);\r\nb43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x1);\r\nb43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x1);\r\nb43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x0C08);\r\nb43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x0);\r\nb43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x1);\r\nb43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x1);\r\nb43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0x1);\r\nb43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x1D06);\r\nfor (i = 0; i < 4; i++)\r\nb43_phy_write(dev, B43_NPHY_TABLE_DATALO,\r\n(code << 8 | 0x74));\r\n}\r\nif (dev->phy.rev == 2) {\r\nfor (i = 0; i < 4; i++) {\r\nb43_phy_write(dev, B43_NPHY_TABLE_ADDR,\r\n(0x0400 * i) + 0x0020);\r\nfor (j = 0; j < 21; j++) {\r\ntmp = j * (i < 2 ? 3 : 1);\r\nb43_phy_write(dev,\r\nB43_NPHY_TABLE_DATALO, tmp);\r\n}\r\n}\r\n}\r\nb43_nphy_set_rf_sequence(dev, 5, rfseq_events, rfseq_delays, 3);\r\nb43_phy_maskset(dev, B43_NPHY_OVER_DGAIN1,\r\n~B43_NPHY_OVER_DGAIN_CCKDGECV & 0xFFFF,\r\n0x5A << B43_NPHY_OVER_DGAIN_CCKDGECV_SHIFT);\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\r\nb43_phy_maskset(dev, B43_PHY_N(0xC5D), 0xFF80, 4);\r\n}\r\nstatic void b43_nphy_gain_ctl_workarounds(struct b43_wldev *dev)\r\n{\r\nif (dev->phy.rev >= 19)\r\nb43_nphy_gain_ctl_workarounds_rev19(dev);\r\nelse if (dev->phy.rev >= 7)\r\nb43_nphy_gain_ctl_workarounds_rev7(dev);\r\nelse if (dev->phy.rev >= 3)\r\nb43_nphy_gain_ctl_workarounds_rev3(dev);\r\nelse\r\nb43_nphy_gain_ctl_workarounds_rev1_2(dev);\r\n}\r\nstatic void b43_nphy_workarounds_rev7plus(struct b43_wldev *dev)\r\n{\r\nstruct ssb_sprom *sprom = dev->dev->bus_sprom;\r\nstruct b43_phy *phy = &dev->phy;\r\nu8 tx2rx_events[7] = { 4, 3, 5, 2, 1, 8, 31, };\r\nu8 tx2rx_delays[7] = { 8, 4, 4, 4, 4, 6, 1, };\r\nu8 rx2tx_events_ipa[9] = { 0x0, 0x1, 0x2, 0x8, 0x5, 0x6, 0xF, 0x3,\r\n0x1F };\r\nu8 rx2tx_delays_ipa[9] = { 8, 6, 6, 4, 4, 16, 43, 1, 1 };\r\nstatic const u16 ntab7_15e_16e[] = { 0, 0x10f, 0x10f };\r\nu8 ntab7_138_146[] = { 0x11, 0x11 };\r\nu8 ntab7_133[] = { 0x77, 0x11, 0x11 };\r\nu16 lpf_ofdm_20mhz[2], lpf_ofdm_40mhz[2], lpf_11b[2];\r\nu16 bcap_val;\r\ns16 bcap_val_11b[2], bcap_val_11n_20[2], bcap_val_11n_40[2];\r\nu16 scap_val;\r\ns16 scap_val_11b[2], scap_val_11n_20[2], scap_val_11n_40[2];\r\nbool rccal_ovrd = false;\r\nu16 bias, conv, filt;\r\nu32 noise_tbl[2];\r\nu32 tmp32;\r\nu8 core;\r\nb43_phy_write(dev, B43_NPHY_PHASETR_A0, 0x0125);\r\nb43_phy_write(dev, B43_NPHY_PHASETR_A1, 0x01b3);\r\nb43_phy_write(dev, B43_NPHY_PHASETR_A2, 0x0105);\r\nb43_phy_write(dev, B43_NPHY_PHASETR_B0, 0x016e);\r\nb43_phy_write(dev, B43_NPHY_PHASETR_B1, 0x00cd);\r\nb43_phy_write(dev, B43_NPHY_PHASETR_B2, 0x0020);\r\nif (phy->rev == 7) {\r\nb43_phy_set(dev, B43_NPHY_FINERX2_CGC, 0x10);\r\nb43_phy_maskset(dev, B43_NPHY_FREQGAIN0, 0xFF80, 0x0020);\r\nb43_phy_maskset(dev, B43_NPHY_FREQGAIN0, 0x80FF, 0x2700);\r\nb43_phy_maskset(dev, B43_NPHY_FREQGAIN1, 0xFF80, 0x002E);\r\nb43_phy_maskset(dev, B43_NPHY_FREQGAIN1, 0x80FF, 0x3300);\r\nb43_phy_maskset(dev, B43_NPHY_FREQGAIN2, 0xFF80, 0x0037);\r\nb43_phy_maskset(dev, B43_NPHY_FREQGAIN2, 0x80FF, 0x3A00);\r\nb43_phy_maskset(dev, B43_NPHY_FREQGAIN3, 0xFF80, 0x003C);\r\nb43_phy_maskset(dev, B43_NPHY_FREQGAIN3, 0x80FF, 0x3E00);\r\nb43_phy_maskset(dev, B43_NPHY_FREQGAIN4, 0xFF80, 0x003E);\r\nb43_phy_maskset(dev, B43_NPHY_FREQGAIN4, 0x80FF, 0x3F00);\r\nb43_phy_maskset(dev, B43_NPHY_FREQGAIN5, 0xFF80, 0x0040);\r\nb43_phy_maskset(dev, B43_NPHY_FREQGAIN5, 0x80FF, 0x4000);\r\nb43_phy_maskset(dev, B43_NPHY_FREQGAIN6, 0xFF80, 0x0040);\r\nb43_phy_maskset(dev, B43_NPHY_FREQGAIN6, 0x80FF, 0x4000);\r\nb43_phy_maskset(dev, B43_NPHY_FREQGAIN7, 0xFF80, 0x0040);\r\nb43_phy_maskset(dev, B43_NPHY_FREQGAIN7, 0x80FF, 0x4000);\r\n}\r\nif (phy->rev >= 16) {\r\nb43_phy_write(dev, B43_NPHY_FORCEFRONT0, 0x7ff);\r\nb43_phy_write(dev, B43_NPHY_FORCEFRONT1, 0x7ff);\r\n} else if (phy->rev <= 8) {\r\nb43_phy_write(dev, B43_NPHY_FORCEFRONT0, 0x1B0);\r\nb43_phy_write(dev, B43_NPHY_FORCEFRONT1, 0x1B0);\r\n}\r\nif (phy->rev >= 16)\r\nb43_phy_maskset(dev, B43_NPHY_TXTAILCNT, ~0xFF, 0xa0);\r\nelse if (phy->rev >= 8)\r\nb43_phy_maskset(dev, B43_NPHY_TXTAILCNT, ~0xFF, 0x72);\r\nb43_ntab_write(dev, B43_NTAB16(8, 0x00), 2);\r\nb43_ntab_write(dev, B43_NTAB16(8, 0x10), 2);\r\ntmp32 = b43_ntab_read(dev, B43_NTAB32(30, 0));\r\ntmp32 &= 0xffffff;\r\nb43_ntab_write(dev, B43_NTAB32(30, 0), tmp32);\r\nb43_ntab_write_bulk(dev, B43_NTAB16(7, 0x15d), 3, ntab7_15e_16e);\r\nb43_ntab_write_bulk(dev, B43_NTAB16(7, 0x16d), 3, ntab7_15e_16e);\r\nb43_nphy_set_rf_sequence(dev, 1, tx2rx_events, tx2rx_delays,\r\nARRAY_SIZE(tx2rx_events));\r\nif (b43_nphy_ipa(dev))\r\nb43_nphy_set_rf_sequence(dev, 0, rx2tx_events_ipa,\r\nrx2tx_delays_ipa, ARRAY_SIZE(rx2tx_events_ipa));\r\nb43_phy_maskset(dev, B43_NPHY_EPS_OVERRIDEI_0, 0x3FFF, 0x4000);\r\nb43_phy_maskset(dev, B43_NPHY_EPS_OVERRIDEI_1, 0x3FFF, 0x4000);\r\nfor (core = 0; core < 2; core++) {\r\nlpf_ofdm_20mhz[core] = b43_nphy_read_lpf_ctl(dev, 0x154 + core * 0x10);\r\nlpf_ofdm_40mhz[core] = b43_nphy_read_lpf_ctl(dev, 0x159 + core * 0x10);\r\nlpf_11b[core] = b43_nphy_read_lpf_ctl(dev, 0x152 + core * 0x10);\r\n}\r\nbcap_val = b43_radio_read(dev, R2057_RCCAL_BCAP_VAL);\r\nscap_val = b43_radio_read(dev, R2057_RCCAL_SCAP_VAL);\r\nif (b43_nphy_ipa(dev)) {\r\nbool ghz2 = b43_current_band(dev->wl) == NL80211_BAND_2GHZ;\r\nswitch (phy->radio_rev) {\r\ncase 5:\r\nif (phy->rev == 8 && b43_is_40mhz(dev)) {\r\nfor (core = 0; core < 2; core++) {\r\nscap_val_11b[core] = scap_val;\r\nbcap_val_11b[core] = bcap_val;\r\nscap_val_11n_20[core] = scap_val;\r\nbcap_val_11n_20[core] = bcap_val;\r\nscap_val_11n_40[core] = 0xc;\r\nbcap_val_11n_40[core] = 0xc;\r\n}\r\nrccal_ovrd = true;\r\n}\r\nif (phy->rev == 9) {\r\n}\r\nbreak;\r\ncase 7:\r\ncase 8:\r\nfor (core = 0; core < 2; core++) {\r\nscap_val_11b[core] = scap_val;\r\nbcap_val_11b[core] = bcap_val;\r\nlpf_ofdm_20mhz[core] = 4;\r\nlpf_11b[core] = 1;\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\r\nscap_val_11n_20[core] = 0xc;\r\nbcap_val_11n_20[core] = 0xc;\r\nscap_val_11n_40[core] = 0xa;\r\nbcap_val_11n_40[core] = 0xa;\r\n} else {\r\nscap_val_11n_20[core] = 0x14;\r\nbcap_val_11n_20[core] = 0x14;\r\nscap_val_11n_40[core] = 0xf;\r\nbcap_val_11n_40[core] = 0xf;\r\n}\r\n}\r\nrccal_ovrd = true;\r\nbreak;\r\ncase 9:\r\nfor (core = 0; core < 2; core++) {\r\nbcap_val_11b[core] = bcap_val;\r\nscap_val_11b[core] = scap_val;\r\nlpf_11b[core] = 1;\r\nif (ghz2) {\r\nbcap_val_11n_20[core] = bcap_val + 13;\r\nscap_val_11n_20[core] = scap_val + 15;\r\n} else {\r\nbcap_val_11n_20[core] = bcap_val + 14;\r\nscap_val_11n_20[core] = scap_val + 15;\r\n}\r\nlpf_ofdm_20mhz[core] = 4;\r\nif (ghz2) {\r\nbcap_val_11n_40[core] = bcap_val - 7;\r\nscap_val_11n_40[core] = scap_val - 5;\r\n} else {\r\nbcap_val_11n_40[core] = bcap_val + 2;\r\nscap_val_11n_40[core] = scap_val + 4;\r\n}\r\nlpf_ofdm_40mhz[core] = 4;\r\n}\r\nrccal_ovrd = true;\r\nbreak;\r\ncase 14:\r\nfor (core = 0; core < 2; core++) {\r\nbcap_val_11b[core] = bcap_val;\r\nscap_val_11b[core] = scap_val;\r\nlpf_11b[core] = 1;\r\n}\r\nbcap_val_11n_20[0] = bcap_val + 20;\r\nscap_val_11n_20[0] = scap_val + 20;\r\nlpf_ofdm_20mhz[0] = 3;\r\nbcap_val_11n_20[1] = bcap_val + 16;\r\nscap_val_11n_20[1] = scap_val + 16;\r\nlpf_ofdm_20mhz[1] = 3;\r\nbcap_val_11n_40[0] = bcap_val + 20;\r\nscap_val_11n_40[0] = scap_val + 20;\r\nlpf_ofdm_40mhz[0] = 4;\r\nbcap_val_11n_40[1] = bcap_val + 10;\r\nscap_val_11n_40[1] = scap_val + 10;\r\nlpf_ofdm_40mhz[1] = 4;\r\nrccal_ovrd = true;\r\nbreak;\r\n}\r\n} else {\r\nif (phy->radio_rev == 5) {\r\nfor (core = 0; core < 2; core++) {\r\nlpf_ofdm_20mhz[core] = 1;\r\nlpf_ofdm_40mhz[core] = 3;\r\nscap_val_11b[core] = scap_val;\r\nbcap_val_11b[core] = bcap_val;\r\nscap_val_11n_20[core] = 0x11;\r\nscap_val_11n_40[core] = 0x11;\r\nbcap_val_11n_20[core] = 0x13;\r\nbcap_val_11n_40[core] = 0x13;\r\n}\r\nrccal_ovrd = true;\r\n}\r\n}\r\nif (rccal_ovrd) {\r\nu16 rx2tx_lut_20_11b[2], rx2tx_lut_20_11n[2], rx2tx_lut_40_11n[2];\r\nu8 rx2tx_lut_extra = 1;\r\nfor (core = 0; core < 2; core++) {\r\nbcap_val_11b[core] = clamp_val(bcap_val_11b[core], 0, 0x1f);\r\nscap_val_11b[core] = clamp_val(scap_val_11b[core], 0, 0x1f);\r\nbcap_val_11n_20[core] = clamp_val(bcap_val_11n_20[core], 0, 0x1f);\r\nscap_val_11n_20[core] = clamp_val(scap_val_11n_20[core], 0, 0x1f);\r\nbcap_val_11n_40[core] = clamp_val(bcap_val_11n_40[core], 0, 0x1f);\r\nscap_val_11n_40[core] = clamp_val(scap_val_11n_40[core], 0, 0x1f);\r\nrx2tx_lut_20_11b[core] = (rx2tx_lut_extra << 13) |\r\n(bcap_val_11b[core] << 8) |\r\n(scap_val_11b[core] << 3) |\r\nlpf_11b[core];\r\nrx2tx_lut_20_11n[core] = (rx2tx_lut_extra << 13) |\r\n(bcap_val_11n_20[core] << 8) |\r\n(scap_val_11n_20[core] << 3) |\r\nlpf_ofdm_20mhz[core];\r\nrx2tx_lut_40_11n[core] = (rx2tx_lut_extra << 13) |\r\n(bcap_val_11n_40[core] << 8) |\r\n(scap_val_11n_40[core] << 3) |\r\nlpf_ofdm_40mhz[core];\r\n}\r\nfor (core = 0; core < 2; core++) {\r\nb43_ntab_write(dev, B43_NTAB16(7, 0x152 + core * 16),\r\nrx2tx_lut_20_11b[core]);\r\nb43_ntab_write(dev, B43_NTAB16(7, 0x153 + core * 16),\r\nrx2tx_lut_20_11n[core]);\r\nb43_ntab_write(dev, B43_NTAB16(7, 0x154 + core * 16),\r\nrx2tx_lut_20_11n[core]);\r\nb43_ntab_write(dev, B43_NTAB16(7, 0x155 + core * 16),\r\nrx2tx_lut_40_11n[core]);\r\nb43_ntab_write(dev, B43_NTAB16(7, 0x156 + core * 16),\r\nrx2tx_lut_40_11n[core]);\r\nb43_ntab_write(dev, B43_NTAB16(7, 0x157 + core * 16),\r\nrx2tx_lut_40_11n[core]);\r\nb43_ntab_write(dev, B43_NTAB16(7, 0x158 + core * 16),\r\nrx2tx_lut_40_11n[core]);\r\nb43_ntab_write(dev, B43_NTAB16(7, 0x159 + core * 16),\r\nrx2tx_lut_40_11n[core]);\r\n}\r\n}\r\nb43_phy_write(dev, 0x32F, 0x3);\r\nif (phy->radio_rev == 4 || phy->radio_rev == 6)\r\nb43_nphy_rf_ctl_override_rev7(dev, 4, 1, 3, false, 0);\r\nif (phy->radio_rev == 3 || phy->radio_rev == 4 || phy->radio_rev == 6) {\r\nif (sprom->revision &&\r\nsprom->boardflags2_hi & B43_BFH2_IPALVLSHIFT_3P3) {\r\nb43_radio_write(dev, 0x5, 0x05);\r\nb43_radio_write(dev, 0x6, 0x30);\r\nb43_radio_write(dev, 0x7, 0x00);\r\nb43_radio_set(dev, 0x4f, 0x1);\r\nb43_radio_set(dev, 0xd4, 0x1);\r\nbias = 0x1f;\r\nconv = 0x6f;\r\nfilt = 0xaa;\r\n} else {\r\nbias = 0x2b;\r\nconv = 0x7f;\r\nfilt = 0xee;\r\n}\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\r\nfor (core = 0; core < 2; core++) {\r\nif (core == 0) {\r\nb43_radio_write(dev, 0x5F, bias);\r\nb43_radio_write(dev, 0x64, conv);\r\nb43_radio_write(dev, 0x66, filt);\r\n} else {\r\nb43_radio_write(dev, 0xE8, bias);\r\nb43_radio_write(dev, 0xE9, conv);\r\nb43_radio_write(dev, 0xEB, filt);\r\n}\r\n}\r\n}\r\n}\r\nif (b43_nphy_ipa(dev)) {\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\r\nif (phy->radio_rev == 3 || phy->radio_rev == 4 ||\r\nphy->radio_rev == 6) {\r\nfor (core = 0; core < 2; core++) {\r\nif (core == 0)\r\nb43_radio_write(dev, 0x51,\r\n0x7f);\r\nelse\r\nb43_radio_write(dev, 0xd6,\r\n0x7f);\r\n}\r\n}\r\nswitch (phy->radio_rev) {\r\ncase 3:\r\nfor (core = 0; core < 2; core++) {\r\nif (core == 0) {\r\nb43_radio_write(dev, 0x64,\r\n0x13);\r\nb43_radio_write(dev, 0x5F,\r\n0x1F);\r\nb43_radio_write(dev, 0x66,\r\n0xEE);\r\nb43_radio_write(dev, 0x59,\r\n0x8A);\r\nb43_radio_write(dev, 0x80,\r\n0x3E);\r\n} else {\r\nb43_radio_write(dev, 0x69,\r\n0x13);\r\nb43_radio_write(dev, 0xE8,\r\n0x1F);\r\nb43_radio_write(dev, 0xEB,\r\n0xEE);\r\nb43_radio_write(dev, 0xDE,\r\n0x8A);\r\nb43_radio_write(dev, 0x105,\r\n0x3E);\r\n}\r\n}\r\nbreak;\r\ncase 7:\r\ncase 8:\r\nif (!b43_is_40mhz(dev)) {\r\nb43_radio_write(dev, 0x5F, 0x14);\r\nb43_radio_write(dev, 0xE8, 0x12);\r\n} else {\r\nb43_radio_write(dev, 0x5F, 0x16);\r\nb43_radio_write(dev, 0xE8, 0x16);\r\n}\r\nbreak;\r\ncase 14:\r\nfor (core = 0; core < 2; core++) {\r\nint o = core ? 0x85 : 0;\r\nb43_radio_write(dev, o + R2057_IPA2G_CASCONV_CORE0, 0x13);\r\nb43_radio_write(dev, o + R2057_TXMIX2G_TUNE_BOOST_PU_CORE0, 0x21);\r\nb43_radio_write(dev, o + R2057_IPA2G_BIAS_FILTER_CORE0, 0xff);\r\nb43_radio_write(dev, o + R2057_PAD2G_IDACS_CORE0, 0x88);\r\nb43_radio_write(dev, o + R2057_PAD2G_TUNE_PUS_CORE0, 0x23);\r\nb43_radio_write(dev, o + R2057_IPA2G_IMAIN_CORE0, 0x16);\r\nb43_radio_write(dev, o + R2057_PAD_BIAS_FILTER_BWS_CORE0, 0x3e);\r\nb43_radio_write(dev, o + R2057_BACKUP1_CORE0, 0x10);\r\n}\r\nbreak;\r\n}\r\n} else {\r\nu16 freq = phy->chandef->chan->center_freq;\r\nif ((freq >= 5180 && freq <= 5230) ||\r\n(freq >= 5745 && freq <= 5805)) {\r\nb43_radio_write(dev, 0x7D, 0xFF);\r\nb43_radio_write(dev, 0xFE, 0xFF);\r\n}\r\n}\r\n} else {\r\nif (phy->radio_rev != 5) {\r\nfor (core = 0; core < 2; core++) {\r\nif (core == 0) {\r\nb43_radio_write(dev, 0x5c, 0x61);\r\nb43_radio_write(dev, 0x51, 0x70);\r\n} else {\r\nb43_radio_write(dev, 0xe1, 0x61);\r\nb43_radio_write(dev, 0xd6, 0x70);\r\n}\r\n}\r\n}\r\n}\r\nif (phy->radio_rev == 4) {\r\nb43_ntab_write(dev, B43_NTAB16(8, 0x05), 0x20);\r\nb43_ntab_write(dev, B43_NTAB16(8, 0x15), 0x20);\r\nfor (core = 0; core < 2; core++) {\r\nif (core == 0) {\r\nb43_radio_write(dev, 0x1a1, 0x00);\r\nb43_radio_write(dev, 0x1a2, 0x3f);\r\nb43_radio_write(dev, 0x1a6, 0x3f);\r\n} else {\r\nb43_radio_write(dev, 0x1a7, 0x00);\r\nb43_radio_write(dev, 0x1ab, 0x3f);\r\nb43_radio_write(dev, 0x1ac, 0x3f);\r\n}\r\n}\r\n} else {\r\nb43_phy_set(dev, B43_NPHY_AFECTL_C1, 0x4);\r\nb43_phy_set(dev, B43_NPHY_AFECTL_OVER1, 0x4);\r\nb43_phy_set(dev, B43_NPHY_AFECTL_C2, 0x4);\r\nb43_phy_set(dev, B43_NPHY_AFECTL_OVER, 0x4);\r\nb43_phy_mask(dev, B43_NPHY_AFECTL_C1, ~0x1);\r\nb43_phy_set(dev, B43_NPHY_AFECTL_OVER1, 0x1);\r\nb43_phy_mask(dev, B43_NPHY_AFECTL_C2, ~0x1);\r\nb43_phy_set(dev, B43_NPHY_AFECTL_OVER, 0x1);\r\nb43_ntab_write(dev, B43_NTAB16(8, 0x05), 0);\r\nb43_ntab_write(dev, B43_NTAB16(8, 0x15), 0);\r\nb43_phy_mask(dev, B43_NPHY_AFECTL_C1, ~0x4);\r\nb43_phy_mask(dev, B43_NPHY_AFECTL_OVER1, ~0x4);\r\nb43_phy_mask(dev, B43_NPHY_AFECTL_C2, ~0x4);\r\nb43_phy_mask(dev, B43_NPHY_AFECTL_OVER, ~0x4);\r\n}\r\nb43_phy_write(dev, B43_NPHY_ENDROP_TLEN, 0x2);\r\nb43_ntab_write(dev, B43_NTAB32(16, 0x100), 20);\r\nb43_ntab_write_bulk(dev, B43_NTAB8(7, 0x138), 2, ntab7_138_146);\r\nb43_ntab_write(dev, B43_NTAB16(7, 0x141), 0x77);\r\nb43_ntab_write_bulk(dev, B43_NTAB8(7, 0x133), 3, ntab7_133);\r\nb43_ntab_write_bulk(dev, B43_NTAB8(7, 0x146), 2, ntab7_138_146);\r\nb43_ntab_write(dev, B43_NTAB16(7, 0x123), 0x77);\r\nb43_ntab_write(dev, B43_NTAB16(7, 0x12A), 0x77);\r\nb43_ntab_read_bulk(dev, B43_NTAB32(16, 0x02), 1, noise_tbl);\r\nnoise_tbl[1] = b43_is_40mhz(dev) ? 0x14D : 0x18D;\r\nb43_ntab_write_bulk(dev, B43_NTAB32(16, 0x02), 2, noise_tbl);\r\nb43_ntab_read_bulk(dev, B43_NTAB32(16, 0x7E), 1, noise_tbl);\r\nnoise_tbl[1] = b43_is_40mhz(dev) ? 0x14D : 0x18D;\r\nb43_ntab_write_bulk(dev, B43_NTAB32(16, 0x7E), 2, noise_tbl);\r\nb43_nphy_gain_ctl_workarounds(dev);\r\n}\r\nstatic void b43_nphy_workarounds_rev3plus(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nstruct ssb_sprom *sprom = dev->dev->bus_sprom;\r\nu8 tx2rx_events[7] = { 0x4, 0x3, 0x5, 0x2, 0x1, 0x8, 0x1F };\r\nu8 tx2rx_delays[7] = { 8, 4, 4, 4, 4, 6, 1 };\r\nu8 rx2tx_events_ipa[9] = { 0x0, 0x1, 0x2, 0x8, 0x5, 0x6, 0xF, 0x3,\r\n0x1F };\r\nu8 rx2tx_delays_ipa[9] = { 8, 6, 6, 4, 4, 16, 43, 1, 1 };\r\nu8 rx2tx_events[9] = { 0x0, 0x1, 0x2, 0x8, 0x5, 0x6, 0x3, 0x4, 0x1F };\r\nu8 rx2tx_delays[9] = { 8, 6, 6, 4, 4, 18, 42, 1, 1 };\r\nu16 vmids[5][4] = {\r\n{ 0xa2, 0xb4, 0xb4, 0x89, },\r\n{ 0xb4, 0xb4, 0xb4, 0x24, },\r\n{ 0xa2, 0xb4, 0xb4, 0x74, },\r\n{ 0xa2, 0xb4, 0xb4, 0x270, },\r\n{ 0xa2, 0xb4, 0xb4, 0x00, },\r\n};\r\nu16 gains[5][4] = {\r\n{ 0x02, 0x02, 0x02, 0x00, },\r\n{ 0x02, 0x02, 0x02, 0x02, },\r\n{ 0x02, 0x02, 0x02, 0x04, },\r\n{ 0x02, 0x02, 0x02, 0x00, },\r\n{ 0x02, 0x02, 0x02, 0x00, },\r\n};\r\nu16 *vmid, *gain;\r\nu8 pdet_range;\r\nu16 tmp16;\r\nu32 tmp32;\r\nb43_phy_write(dev, B43_NPHY_FORCEFRONT0, 0x1f8);\r\nb43_phy_write(dev, B43_NPHY_FORCEFRONT1, 0x1f8);\r\ntmp32 = b43_ntab_read(dev, B43_NTAB32(30, 0));\r\ntmp32 &= 0xffffff;\r\nb43_ntab_write(dev, B43_NTAB32(30, 0), tmp32);\r\nb43_phy_write(dev, B43_NPHY_PHASETR_A0, 0x0125);\r\nb43_phy_write(dev, B43_NPHY_PHASETR_A1, 0x01B3);\r\nb43_phy_write(dev, B43_NPHY_PHASETR_A2, 0x0105);\r\nb43_phy_write(dev, B43_NPHY_PHASETR_B0, 0x016E);\r\nb43_phy_write(dev, B43_NPHY_PHASETR_B1, 0x00CD);\r\nb43_phy_write(dev, B43_NPHY_PHASETR_B2, 0x0020);\r\nb43_phy_write(dev, B43_NPHY_REV3_C1_CLIP_LOGAIN_B, 0x000C);\r\nb43_phy_write(dev, B43_NPHY_REV3_C2_CLIP_LOGAIN_B, 0x000C);\r\nb43_nphy_set_rf_sequence(dev, 1, tx2rx_events, tx2rx_delays,\r\nARRAY_SIZE(tx2rx_events));\r\nif (b43_nphy_ipa(dev))\r\nb43_nphy_set_rf_sequence(dev, 0, rx2tx_events_ipa,\r\nrx2tx_delays_ipa, ARRAY_SIZE(rx2tx_events_ipa));\r\nif (nphy->hw_phyrxchain != 3 &&\r\nnphy->hw_phyrxchain != nphy->hw_phytxchain) {\r\nif (b43_nphy_ipa(dev)) {\r\nrx2tx_delays[5] = 59;\r\nrx2tx_delays[6] = 1;\r\nrx2tx_events[7] = 0x1F;\r\n}\r\nb43_nphy_set_rf_sequence(dev, 0, rx2tx_events, rx2tx_delays,\r\nARRAY_SIZE(rx2tx_events));\r\n}\r\ntmp16 = (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) ?\r\n0x2 : 0x9C40;\r\nb43_phy_write(dev, B43_NPHY_ENDROP_TLEN, tmp16);\r\nb43_phy_maskset(dev, B43_NPHY_SGILTRNOFFSET, 0xF0FF, 0x0700);\r\nif (!b43_is_40mhz(dev)) {\r\nb43_ntab_write(dev, B43_NTAB32(16, 3), 0x18D);\r\nb43_ntab_write(dev, B43_NTAB32(16, 127), 0x18D);\r\n} else {\r\nb43_ntab_write(dev, B43_NTAB32(16, 3), 0x14D);\r\nb43_ntab_write(dev, B43_NTAB32(16, 127), 0x14D);\r\n}\r\nb43_nphy_gain_ctl_workarounds(dev);\r\nb43_ntab_write(dev, B43_NTAB16(8, 0), 2);\r\nb43_ntab_write(dev, B43_NTAB16(8, 16), 2);\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\r\npdet_range = sprom->fem.ghz2.pdet_range;\r\nelse\r\npdet_range = sprom->fem.ghz5.pdet_range;\r\nvmid = vmids[min_t(u16, pdet_range, 4)];\r\ngain = gains[min_t(u16, pdet_range, 4)];\r\nswitch (pdet_range) {\r\ncase 3:\r\nif (!(dev->phy.rev >= 4 &&\r\nb43_current_band(dev->wl) == NL80211_BAND_2GHZ))\r\nbreak;\r\ncase 0:\r\ncase 1:\r\nb43_ntab_write_bulk(dev, B43_NTAB16(8, 0x08), 4, vmid);\r\nb43_ntab_write_bulk(dev, B43_NTAB16(8, 0x18), 4, vmid);\r\nb43_ntab_write_bulk(dev, B43_NTAB16(8, 0x0c), 4, gain);\r\nb43_ntab_write_bulk(dev, B43_NTAB16(8, 0x1c), 4, gain);\r\nbreak;\r\ncase 2:\r\nif (dev->phy.rev >= 6) {\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\r\nvmid[3] = 0x94;\r\nelse\r\nvmid[3] = 0x8e;\r\ngain[3] = 3;\r\n} else if (dev->phy.rev == 5) {\r\nvmid[3] = 0x84;\r\ngain[3] = 2;\r\n}\r\nb43_ntab_write_bulk(dev, B43_NTAB16(8, 0x08), 4, vmid);\r\nb43_ntab_write_bulk(dev, B43_NTAB16(8, 0x18), 4, vmid);\r\nb43_ntab_write_bulk(dev, B43_NTAB16(8, 0x0c), 4, gain);\r\nb43_ntab_write_bulk(dev, B43_NTAB16(8, 0x1c), 4, gain);\r\nbreak;\r\ncase 4:\r\ncase 5:\r\nif (b43_current_band(dev->wl) != NL80211_BAND_2GHZ) {\r\nif (pdet_range == 4) {\r\nvmid[3] = 0x8e;\r\ntmp16 = 0x96;\r\ngain[3] = 0x2;\r\n} else {\r\nvmid[3] = 0x89;\r\ntmp16 = 0x89;\r\ngain[3] = 0;\r\n}\r\n} else {\r\nif (pdet_range == 4) {\r\nvmid[3] = 0x89;\r\ntmp16 = 0x8b;\r\ngain[3] = 0x2;\r\n} else {\r\nvmid[3] = 0x74;\r\ntmp16 = 0x70;\r\ngain[3] = 0;\r\n}\r\n}\r\nb43_ntab_write_bulk(dev, B43_NTAB16(8, 0x08), 4, vmid);\r\nb43_ntab_write_bulk(dev, B43_NTAB16(8, 0x0c), 4, gain);\r\nvmid[3] = tmp16;\r\nb43_ntab_write_bulk(dev, B43_NTAB16(8, 0x18), 4, vmid);\r\nb43_ntab_write_bulk(dev, B43_NTAB16(8, 0x1c), 4, gain);\r\nbreak;\r\n}\r\nb43_radio_write(dev, B2056_RX0 | B2056_RX_MIXA_MAST_BIAS, 0x00);\r\nb43_radio_write(dev, B2056_RX1 | B2056_RX_MIXA_MAST_BIAS, 0x00);\r\nb43_radio_write(dev, B2056_RX0 | B2056_RX_MIXA_BIAS_MAIN, 0x06);\r\nb43_radio_write(dev, B2056_RX1 | B2056_RX_MIXA_BIAS_MAIN, 0x06);\r\nb43_radio_write(dev, B2056_RX0 | B2056_RX_MIXA_BIAS_AUX, 0x07);\r\nb43_radio_write(dev, B2056_RX1 | B2056_RX_MIXA_BIAS_AUX, 0x07);\r\nb43_radio_write(dev, B2056_RX0 | B2056_RX_MIXA_LOB_BIAS, 0x88);\r\nb43_radio_write(dev, B2056_RX1 | B2056_RX_MIXA_LOB_BIAS, 0x88);\r\nb43_radio_write(dev, B2056_RX0 | B2056_RX_MIXA_CMFB_IDAC, 0x00);\r\nb43_radio_write(dev, B2056_RX1 | B2056_RX_MIXA_CMFB_IDAC, 0x00);\r\nb43_radio_write(dev, B2056_RX0 | B2056_RX_MIXG_CMFB_IDAC, 0x00);\r\nb43_radio_write(dev, B2056_RX1 | B2056_RX_MIXG_CMFB_IDAC, 0x00);\r\nif ((sprom->boardflags2_lo & B43_BFL2_APLL_WAR &&\r\nb43_current_band(dev->wl) == NL80211_BAND_5GHZ) ||\r\n(sprom->boardflags2_lo & B43_BFL2_GPLL_WAR &&\r\nb43_current_band(dev->wl) == NL80211_BAND_2GHZ))\r\ntmp32 = 0x00088888;\r\nelse\r\ntmp32 = 0x88888888;\r\nb43_ntab_write(dev, B43_NTAB32(30, 1), tmp32);\r\nb43_ntab_write(dev, B43_NTAB32(30, 2), tmp32);\r\nb43_ntab_write(dev, B43_NTAB32(30, 3), tmp32);\r\nif (dev->phy.rev == 4 &&\r\nb43_current_band(dev->wl) == NL80211_BAND_5GHZ) {\r\nb43_radio_write(dev, B2056_TX0 | B2056_TX_GMBB_IDAC,\r\n0x70);\r\nb43_radio_write(dev, B2056_TX1 | B2056_TX_GMBB_IDAC,\r\n0x70);\r\n}\r\nb43_phy_write(dev, B43_NPHY_ED_CRS40ASSERTTHRESH0, 0x03eb);\r\nb43_phy_write(dev, B43_NPHY_ED_CRS40ASSERTTHRESH1, 0x03eb);\r\nb43_phy_write(dev, B43_NPHY_ED_CRS40DEASSERTTHRESH0, 0x0341);\r\nb43_phy_write(dev, B43_NPHY_ED_CRS40DEASSERTTHRESH1, 0x0341);\r\nb43_phy_write(dev, B43_NPHY_ED_CRS20LASSERTTHRESH0, 0x042b);\r\nb43_phy_write(dev, B43_NPHY_ED_CRS20LASSERTTHRESH1, 0x042b);\r\nb43_phy_write(dev, B43_NPHY_ED_CRS20LDEASSERTTHRESH0, 0x0381);\r\nb43_phy_write(dev, B43_NPHY_ED_CRS20LDEASSERTTHRESH1, 0x0381);\r\nb43_phy_write(dev, B43_NPHY_ED_CRS20UASSERTTHRESH0, 0x042b);\r\nb43_phy_write(dev, B43_NPHY_ED_CRS20UASSERTTHRESH1, 0x042b);\r\nb43_phy_write(dev, B43_NPHY_ED_CRS20UDEASSERTTHRESH0, 0x0381);\r\nb43_phy_write(dev, B43_NPHY_ED_CRS20UDEASSERTTHRESH1, 0x0381);\r\nif (dev->phy.rev >= 6 && sprom->boardflags2_lo & B43_BFL2_SINGLEANT_CCK)\r\n;\r\n}\r\nstatic void b43_nphy_workarounds_rev1_2(struct b43_wldev *dev)\r\n{\r\nstruct ssb_sprom *sprom = dev->dev->bus_sprom;\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_n *nphy = phy->n;\r\nu8 events1[7] = { 0x0, 0x1, 0x2, 0x8, 0x4, 0x5, 0x3 };\r\nu8 delays1[7] = { 0x8, 0x6, 0x6, 0x2, 0x4, 0x3C, 0x1 };\r\nu8 events2[7] = { 0x0, 0x3, 0x5, 0x4, 0x2, 0x1, 0x8 };\r\nu8 delays2[7] = { 0x8, 0x6, 0x2, 0x4, 0x4, 0x6, 0x1 };\r\nif (sprom->boardflags2_lo & B43_BFL2_SKWRKFEM_BRD ||\r\ndev->dev->board_type == BCMA_BOARD_TYPE_BCM943224M93) {\r\ndelays1[0] = 0x1;\r\ndelays1[5] = 0x14;\r\n}\r\nif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ &&\r\nnphy->band5g_pwrgain) {\r\nb43_radio_mask(dev, B2055_C1_TX_RF_SPARE, ~0x8);\r\nb43_radio_mask(dev, B2055_C2_TX_RF_SPARE, ~0x8);\r\n} else {\r\nb43_radio_set(dev, B2055_C1_TX_RF_SPARE, 0x8);\r\nb43_radio_set(dev, B2055_C2_TX_RF_SPARE, 0x8);\r\n}\r\nb43_ntab_write(dev, B43_NTAB16(8, 0x00), 0x000A);\r\nb43_ntab_write(dev, B43_NTAB16(8, 0x10), 0x000A);\r\nif (dev->phy.rev < 3) {\r\nb43_ntab_write(dev, B43_NTAB16(8, 0x02), 0xCDAA);\r\nb43_ntab_write(dev, B43_NTAB16(8, 0x12), 0xCDAA);\r\n}\r\nif (dev->phy.rev < 2) {\r\nb43_ntab_write(dev, B43_NTAB16(8, 0x08), 0x0000);\r\nb43_ntab_write(dev, B43_NTAB16(8, 0x18), 0x0000);\r\nb43_ntab_write(dev, B43_NTAB16(8, 0x07), 0x7AAB);\r\nb43_ntab_write(dev, B43_NTAB16(8, 0x17), 0x7AAB);\r\nb43_ntab_write(dev, B43_NTAB16(8, 0x06), 0x0800);\r\nb43_ntab_write(dev, B43_NTAB16(8, 0x16), 0x0800);\r\n}\r\nb43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_LO1, 0x2D8);\r\nb43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_UP1, 0x301);\r\nb43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_LO2, 0x2D8);\r\nb43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_UP2, 0x301);\r\nb43_nphy_set_rf_sequence(dev, 0, events1, delays1, 7);\r\nb43_nphy_set_rf_sequence(dev, 1, events2, delays2, 7);\r\nb43_nphy_gain_ctl_workarounds(dev);\r\nif (dev->phy.rev < 2) {\r\nif (b43_phy_read(dev, B43_NPHY_RXCTL) & 0x2)\r\nb43_hf_write(dev, b43_hf_read(dev) |\r\nB43_HF_MLADVW);\r\n} else if (dev->phy.rev == 2) {\r\nb43_phy_write(dev, B43_NPHY_CRSCHECK2, 0);\r\nb43_phy_write(dev, B43_NPHY_CRSCHECK3, 0);\r\n}\r\nif (dev->phy.rev < 2)\r\nb43_phy_mask(dev, B43_NPHY_SCRAM_SIGCTL,\r\n~B43_NPHY_SCRAM_SIGCTL_SCM);\r\nb43_phy_write(dev, B43_NPHY_PHASETR_A0, 0x125);\r\nb43_phy_write(dev, B43_NPHY_PHASETR_A1, 0x1B3);\r\nb43_phy_write(dev, B43_NPHY_PHASETR_A2, 0x105);\r\nb43_phy_write(dev, B43_NPHY_PHASETR_B0, 0x16E);\r\nb43_phy_write(dev, B43_NPHY_PHASETR_B1, 0xCD);\r\nb43_phy_write(dev, B43_NPHY_PHASETR_B2, 0x20);\r\nif (dev->phy.rev < 3) {\r\nb43_phy_mask(dev, B43_NPHY_PIL_DW1,\r\n~B43_NPHY_PIL_DW_64QAM & 0xFFFF);\r\nb43_phy_write(dev, B43_NPHY_TXF_20CO_S2B1, 0xB5);\r\nb43_phy_write(dev, B43_NPHY_TXF_20CO_S2B2, 0xA4);\r\nb43_phy_write(dev, B43_NPHY_TXF_20CO_S2B3, 0x00);\r\n}\r\nif (dev->phy.rev == 2)\r\nb43_phy_set(dev, B43_NPHY_FINERX2_CGC,\r\nB43_NPHY_FINERX2_CGC_DECGC);\r\n}\r\nstatic void b43_nphy_workarounds(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_n *nphy = phy->n;\r\nif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ)\r\nb43_nphy_classifier(dev, 1, 0);\r\nelse\r\nb43_nphy_classifier(dev, 1, 1);\r\nif (nphy->hang_avoid)\r\nb43_nphy_stay_in_carrier_search(dev, 1);\r\nb43_phy_set(dev, B43_NPHY_IQFLIP,\r\nB43_NPHY_IQFLIP_ADC1 | B43_NPHY_IQFLIP_ADC2);\r\nif (dev->phy.rev >= 7)\r\nb43_nphy_workarounds_rev7plus(dev);\r\nelse if (dev->phy.rev >= 3)\r\nb43_nphy_workarounds_rev3plus(dev);\r\nelse\r\nb43_nphy_workarounds_rev1_2(dev);\r\nif (nphy->hang_avoid)\r\nb43_nphy_stay_in_carrier_search(dev, 0);\r\n}\r\nstatic int b43_nphy_tx_tone(struct b43_wldev *dev, u32 freq, u16 max_val,\r\nbool iqmode, bool dac_test, bool modify_bbmult)\r\n{\r\nu16 samp = b43_nphy_gen_load_samples(dev, freq, max_val, dac_test);\r\nif (samp == 0)\r\nreturn -1;\r\nb43_nphy_run_samples(dev, samp, 0xFFFF, 0, iqmode, dac_test,\r\nmodify_bbmult);\r\nreturn 0;\r\n}\r\nstatic void b43_nphy_update_txrx_chain(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nbool override = false;\r\nu16 chain = 0x33;\r\nif (nphy->txrx_chain == 0) {\r\nchain = 0x11;\r\noverride = true;\r\n} else if (nphy->txrx_chain == 1) {\r\nchain = 0x22;\r\noverride = true;\r\n}\r\nb43_phy_maskset(dev, B43_NPHY_RFSEQCA,\r\n~(B43_NPHY_RFSEQCA_TXEN | B43_NPHY_RFSEQCA_RXEN),\r\nchain);\r\nif (override)\r\nb43_phy_set(dev, B43_NPHY_RFSEQMODE,\r\nB43_NPHY_RFSEQMODE_CAOVER);\r\nelse\r\nb43_phy_mask(dev, B43_NPHY_RFSEQMODE,\r\n~B43_NPHY_RFSEQMODE_CAOVER);\r\n}\r\nstatic void b43_nphy_stop_playback(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nu16 tmp;\r\nif (nphy->hang_avoid)\r\nb43_nphy_stay_in_carrier_search(dev, 1);\r\ntmp = b43_phy_read(dev, B43_NPHY_SAMP_STAT);\r\nif (tmp & 0x1)\r\nb43_phy_set(dev, B43_NPHY_SAMP_CMD, B43_NPHY_SAMP_CMD_STOP);\r\nelse if (tmp & 0x2)\r\nb43_phy_mask(dev, B43_NPHY_IQLOCAL_CMDGCTL, 0x7FFF);\r\nb43_phy_mask(dev, B43_NPHY_SAMP_CMD, ~0x0004);\r\nif (nphy->bb_mult_save & 0x80000000) {\r\ntmp = nphy->bb_mult_save & 0xFFFF;\r\nb43_ntab_write(dev, B43_NTAB16(15, 87), tmp);\r\nnphy->bb_mult_save = 0;\r\n}\r\nif (phy->rev >= 7 && nphy->lpf_bw_overrode_for_sample_play) {\r\nif (phy->rev >= 19)\r\nb43_nphy_rf_ctl_override_rev19(dev, 0x80, 0, 0, true,\r\n1);\r\nelse\r\nb43_nphy_rf_ctl_override_rev7(dev, 0x80, 0, 0, true, 1);\r\nnphy->lpf_bw_overrode_for_sample_play = false;\r\n}\r\nif (nphy->hang_avoid)\r\nb43_nphy_stay_in_carrier_search(dev, 0);\r\n}\r\nstatic void b43_nphy_iq_cal_gain_params(struct b43_wldev *dev, u16 core,\r\nstruct nphy_txgains target,\r\nstruct nphy_iqcal_params *params)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nint i, j, indx;\r\nu16 gain;\r\nif (dev->phy.rev >= 3) {\r\nparams->tx_lpf = target.tx_lpf[core];\r\nparams->txgm = target.txgm[core];\r\nparams->pga = target.pga[core];\r\nparams->pad = target.pad[core];\r\nparams->ipa = target.ipa[core];\r\nif (phy->rev >= 19) {\r\n} else if (phy->rev >= 7) {\r\nparams->cal_gain = (params->txgm << 12) | (params->pga << 8) | (params->pad << 3) | (params->ipa) | (params->tx_lpf << 15);\r\n} else {\r\nparams->cal_gain = (params->txgm << 12) | (params->pga << 8) | (params->pad << 4) | (params->ipa);\r\n}\r\nfor (j = 0; j < 5; j++)\r\nparams->ncorr[j] = 0x79;\r\n} else {\r\ngain = (target.pad[core]) | (target.pga[core] << 4) |\r\n(target.txgm[core] << 8);\r\nindx = (b43_current_band(dev->wl) == NL80211_BAND_5GHZ) ?\r\n1 : 0;\r\nfor (i = 0; i < 9; i++)\r\nif (tbl_iqcal_gainparams[indx][i][0] == gain)\r\nbreak;\r\ni = min(i, 8);\r\nparams->txgm = tbl_iqcal_gainparams[indx][i][1];\r\nparams->pga = tbl_iqcal_gainparams[indx][i][2];\r\nparams->pad = tbl_iqcal_gainparams[indx][i][3];\r\nparams->cal_gain = (params->txgm << 7) | (params->pga << 4) |\r\n(params->pad << 2);\r\nfor (j = 0; j < 4; j++)\r\nparams->ncorr[j] = tbl_iqcal_gainparams[indx][i][4 + j];\r\n}\r\n}\r\nstatic void b43_nphy_tx_power_ctrl(struct b43_wldev *dev, bool enable)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nu8 i;\r\nu16 bmask, val, tmp;\r\nenum nl80211_band band = b43_current_band(dev->wl);\r\nif (nphy->hang_avoid)\r\nb43_nphy_stay_in_carrier_search(dev, 1);\r\nnphy->txpwrctrl = enable;\r\nif (!enable) {\r\nif (dev->phy.rev >= 3 &&\r\n(b43_phy_read(dev, B43_NPHY_TXPCTL_CMD) &\r\n(B43_NPHY_TXPCTL_CMD_COEFF |\r\nB43_NPHY_TXPCTL_CMD_HWPCTLEN |\r\nB43_NPHY_TXPCTL_CMD_PCTLEN))) {\r\nnphy->tx_pwr_idx[0] = b43_phy_read(dev,\r\nB43_NPHY_C1_TXPCTL_STAT) & 0x7f;\r\nnphy->tx_pwr_idx[1] = b43_phy_read(dev,\r\nB43_NPHY_C2_TXPCTL_STAT) & 0x7f;\r\n}\r\nb43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x6840);\r\nfor (i = 0; i < 84; i++)\r\nb43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0);\r\nb43_phy_write(dev, B43_NPHY_TABLE_ADDR, 0x6C40);\r\nfor (i = 0; i < 84; i++)\r\nb43_phy_write(dev, B43_NPHY_TABLE_DATALO, 0);\r\ntmp = B43_NPHY_TXPCTL_CMD_COEFF | B43_NPHY_TXPCTL_CMD_HWPCTLEN;\r\nif (dev->phy.rev >= 3)\r\ntmp |= B43_NPHY_TXPCTL_CMD_PCTLEN;\r\nb43_phy_mask(dev, B43_NPHY_TXPCTL_CMD, ~tmp);\r\nif (dev->phy.rev >= 3) {\r\nb43_phy_set(dev, B43_NPHY_AFECTL_OVER1, 0x0100);\r\nb43_phy_set(dev, B43_NPHY_AFECTL_OVER, 0x0100);\r\n} else {\r\nb43_phy_set(dev, B43_NPHY_AFECTL_OVER, 0x4000);\r\n}\r\nif (dev->phy.rev == 2)\r\nb43_phy_maskset(dev, B43_NPHY_BPHY_CTL3,\r\n~B43_NPHY_BPHY_CTL3_SCALE, 0x53);\r\nelse if (dev->phy.rev < 2)\r\nb43_phy_maskset(dev, B43_NPHY_BPHY_CTL3,\r\n~B43_NPHY_BPHY_CTL3_SCALE, 0x5A);\r\nif (dev->phy.rev < 2 && b43_is_40mhz(dev))\r\nb43_hf_write(dev, b43_hf_read(dev) | B43_HF_TSSIRPSMW);\r\n} else {\r\nb43_ntab_write_bulk(dev, B43_NTAB16(26, 64), 84,\r\nnphy->adj_pwr_tbl);\r\nb43_ntab_write_bulk(dev, B43_NTAB16(27, 64), 84,\r\nnphy->adj_pwr_tbl);\r\nbmask = B43_NPHY_TXPCTL_CMD_COEFF |\r\nB43_NPHY_TXPCTL_CMD_HWPCTLEN;\r\nval = B43_NPHY_TXPCTL_CMD_COEFF | B43_NPHY_TXPCTL_CMD_HWPCTLEN;\r\nif (dev->phy.rev >= 3) {\r\nbmask |= B43_NPHY_TXPCTL_CMD_PCTLEN;\r\nif (val)\r\nval |= B43_NPHY_TXPCTL_CMD_PCTLEN;\r\n}\r\nb43_phy_maskset(dev, B43_NPHY_TXPCTL_CMD, ~(bmask), val);\r\nif (band == NL80211_BAND_5GHZ) {\r\nif (phy->rev >= 19) {\r\n} else if (phy->rev >= 7) {\r\nb43_phy_maskset(dev, B43_NPHY_TXPCTL_CMD,\r\n~B43_NPHY_TXPCTL_CMD_INIT,\r\n0x32);\r\nb43_phy_maskset(dev, B43_NPHY_TXPCTL_INIT,\r\n~B43_NPHY_TXPCTL_INIT_PIDXI1,\r\n0x32);\r\n} else {\r\nb43_phy_maskset(dev, B43_NPHY_TXPCTL_CMD,\r\n~B43_NPHY_TXPCTL_CMD_INIT,\r\n0x64);\r\nif (phy->rev > 1)\r\nb43_phy_maskset(dev,\r\nB43_NPHY_TXPCTL_INIT,\r\n~B43_NPHY_TXPCTL_INIT_PIDXI1,\r\n0x64);\r\n}\r\n}\r\nif (dev->phy.rev >= 3) {\r\nif (nphy->tx_pwr_idx[0] != 128 &&\r\nnphy->tx_pwr_idx[1] != 128) {\r\nb43_phy_maskset(dev, B43_NPHY_TXPCTL_CMD,\r\n~B43_NPHY_TXPCTL_CMD_INIT,\r\nnphy->tx_pwr_idx[0]);\r\nif (dev->phy.rev > 1)\r\nb43_phy_maskset(dev,\r\nB43_NPHY_TXPCTL_INIT,\r\n~0xff, nphy->tx_pwr_idx[1]);\r\n}\r\n}\r\nif (phy->rev >= 7) {\r\n}\r\nif (dev->phy.rev >= 3) {\r\nb43_phy_mask(dev, B43_NPHY_AFECTL_OVER1, ~0x100);\r\nb43_phy_mask(dev, B43_NPHY_AFECTL_OVER, ~0x100);\r\n} else {\r\nb43_phy_mask(dev, B43_NPHY_AFECTL_OVER, ~0x4000);\r\n}\r\nif (dev->phy.rev == 2)\r\nb43_phy_maskset(dev, B43_NPHY_BPHY_CTL3, ~0xFF, 0x3b);\r\nelse if (dev->phy.rev < 2)\r\nb43_phy_maskset(dev, B43_NPHY_BPHY_CTL3, ~0xFF, 0x40);\r\nif (dev->phy.rev < 2 && b43_is_40mhz(dev))\r\nb43_hf_write(dev, b43_hf_read(dev) & ~B43_HF_TSSIRPSMW);\r\nif (b43_nphy_ipa(dev)) {\r\nb43_phy_mask(dev, B43_NPHY_PAPD_EN0, ~0x4);\r\nb43_phy_mask(dev, B43_NPHY_PAPD_EN1, ~0x4);\r\n}\r\n}\r\nif (nphy->hang_avoid)\r\nb43_nphy_stay_in_carrier_search(dev, 0);\r\n}\r\nstatic void b43_nphy_tx_power_fix(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nstruct ssb_sprom *sprom = dev->dev->bus_sprom;\r\nu8 txpi[2], bbmult, i;\r\nu16 tmp, radio_gain, dac_gain;\r\nu16 freq = phy->chandef->chan->center_freq;\r\nu32 txgain;\r\nif (nphy->hang_avoid)\r\nb43_nphy_stay_in_carrier_search(dev, 1);\r\nif (dev->phy.rev >= 7) {\r\ntxpi[0] = txpi[1] = 30;\r\n} else if (dev->phy.rev >= 3) {\r\ntxpi[0] = 40;\r\ntxpi[1] = 40;\r\n} else if (sprom->revision < 4) {\r\ntxpi[0] = 72;\r\ntxpi[1] = 72;\r\n} else {\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\r\ntxpi[0] = sprom->txpid2g[0];\r\ntxpi[1] = sprom->txpid2g[1];\r\n} else if (freq >= 4900 && freq < 5100) {\r\ntxpi[0] = sprom->txpid5gl[0];\r\ntxpi[1] = sprom->txpid5gl[1];\r\n} else if (freq >= 5100 && freq < 5500) {\r\ntxpi[0] = sprom->txpid5g[0];\r\ntxpi[1] = sprom->txpid5g[1];\r\n} else if (freq >= 5500) {\r\ntxpi[0] = sprom->txpid5gh[0];\r\ntxpi[1] = sprom->txpid5gh[1];\r\n} else {\r\ntxpi[0] = 91;\r\ntxpi[1] = 91;\r\n}\r\n}\r\nif (dev->phy.rev < 7 &&\r\n(txpi[0] < 40 || txpi[0] > 100 || txpi[1] < 40 || txpi[1] > 100))\r\ntxpi[0] = txpi[1] = 91;\r\nfor (i = 0; i < 2; i++) {\r\nconst u32 *table = b43_nphy_get_tx_gain_table(dev);\r\nif (!table)\r\nbreak;\r\ntxgain = *(table + txpi[i]);\r\nif (dev->phy.rev >= 3)\r\nradio_gain = (txgain >> 16) & 0x1FFFF;\r\nelse\r\nradio_gain = (txgain >> 16) & 0x1FFF;\r\nif (dev->phy.rev >= 7)\r\ndac_gain = (txgain >> 8) & 0x7;\r\nelse\r\ndac_gain = (txgain >> 8) & 0x3F;\r\nbbmult = txgain & 0xFF;\r\nif (dev->phy.rev >= 3) {\r\nif (i == 0)\r\nb43_phy_set(dev, B43_NPHY_AFECTL_OVER1, 0x0100);\r\nelse\r\nb43_phy_set(dev, B43_NPHY_AFECTL_OVER, 0x0100);\r\n} else {\r\nb43_phy_set(dev, B43_NPHY_AFECTL_OVER, 0x4000);\r\n}\r\nif (i == 0)\r\nb43_phy_write(dev, B43_NPHY_AFECTL_DACGAIN1, dac_gain);\r\nelse\r\nb43_phy_write(dev, B43_NPHY_AFECTL_DACGAIN2, dac_gain);\r\nb43_ntab_write(dev, B43_NTAB16(0x7, 0x110 + i), radio_gain);\r\ntmp = b43_ntab_read(dev, B43_NTAB16(0xF, 0x57));\r\nif (i == 0)\r\ntmp = (tmp & 0x00FF) | (bbmult << 8);\r\nelse\r\ntmp = (tmp & 0xFF00) | bbmult;\r\nb43_ntab_write(dev, B43_NTAB16(0xF, 0x57), tmp);\r\nif (b43_nphy_ipa(dev)) {\r\nu32 tmp32;\r\nu16 reg = (i == 0) ?\r\nB43_NPHY_PAPD_EN0 : B43_NPHY_PAPD_EN1;\r\ntmp32 = b43_ntab_read(dev, B43_NTAB32(26 + i,\r\n576 + txpi[i]));\r\nb43_phy_maskset(dev, reg, 0xE00F, (u32) tmp32 << 4);\r\nb43_phy_set(dev, reg, 0x4);\r\n}\r\n}\r\nb43_phy_mask(dev, B43_NPHY_BPHY_CTL2, ~B43_NPHY_BPHY_CTL2_LUT);\r\nif (nphy->hang_avoid)\r\nb43_nphy_stay_in_carrier_search(dev, 0);\r\n}\r\nstatic void b43_nphy_ipa_internal_tssi_setup(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nu8 core;\r\nu16 r;\r\nif (phy->rev >= 19) {\r\n} else if (phy->rev >= 7) {\r\nfor (core = 0; core < 2; core++) {\r\nr = core ? 0x190 : 0x170;\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\r\nb43_radio_write(dev, r + 0x5, 0x5);\r\nb43_radio_write(dev, r + 0x9, 0xE);\r\nif (phy->rev != 5)\r\nb43_radio_write(dev, r + 0xA, 0);\r\nif (phy->rev != 7)\r\nb43_radio_write(dev, r + 0xB, 1);\r\nelse\r\nb43_radio_write(dev, r + 0xB, 0x31);\r\n} else {\r\nb43_radio_write(dev, r + 0x5, 0x9);\r\nb43_radio_write(dev, r + 0x9, 0xC);\r\nb43_radio_write(dev, r + 0xB, 0x0);\r\nif (phy->rev != 5)\r\nb43_radio_write(dev, r + 0xA, 1);\r\nelse\r\nb43_radio_write(dev, r + 0xA, 0x31);\r\n}\r\nb43_radio_write(dev, r + 0x6, 0);\r\nb43_radio_write(dev, r + 0x7, 0);\r\nb43_radio_write(dev, r + 0x8, 3);\r\nb43_radio_write(dev, r + 0xC, 0);\r\n}\r\n} else {\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\r\nb43_radio_write(dev, B2056_SYN_RESERVED_ADDR31, 0x128);\r\nelse\r\nb43_radio_write(dev, B2056_SYN_RESERVED_ADDR31, 0x80);\r\nb43_radio_write(dev, B2056_SYN_RESERVED_ADDR30, 0);\r\nb43_radio_write(dev, B2056_SYN_GPIO_MASTER1, 0x29);\r\nfor (core = 0; core < 2; core++) {\r\nr = core ? B2056_TX1 : B2056_TX0;\r\nb43_radio_write(dev, r | B2056_TX_IQCAL_VCM_HG, 0);\r\nb43_radio_write(dev, r | B2056_TX_IQCAL_IDAC, 0);\r\nb43_radio_write(dev, r | B2056_TX_TSSI_VCM, 3);\r\nb43_radio_write(dev, r | B2056_TX_TX_AMP_DET, 0);\r\nb43_radio_write(dev, r | B2056_TX_TSSI_MISC1, 8);\r\nb43_radio_write(dev, r | B2056_TX_TSSI_MISC2, 0);\r\nb43_radio_write(dev, r | B2056_TX_TSSI_MISC3, 0);\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\r\nb43_radio_write(dev, r | B2056_TX_TX_SSI_MASTER,\r\n0x5);\r\nif (phy->rev != 5)\r\nb43_radio_write(dev, r | B2056_TX_TSSIA,\r\n0x00);\r\nif (phy->rev >= 5)\r\nb43_radio_write(dev, r | B2056_TX_TSSIG,\r\n0x31);\r\nelse\r\nb43_radio_write(dev, r | B2056_TX_TSSIG,\r\n0x11);\r\nb43_radio_write(dev, r | B2056_TX_TX_SSI_MUX,\r\n0xE);\r\n} else {\r\nb43_radio_write(dev, r | B2056_TX_TX_SSI_MASTER,\r\n0x9);\r\nb43_radio_write(dev, r | B2056_TX_TSSIA, 0x31);\r\nb43_radio_write(dev, r | B2056_TX_TSSIG, 0x0);\r\nb43_radio_write(dev, r | B2056_TX_TX_SSI_MUX,\r\n0xC);\r\n}\r\n}\r\n}\r\n}\r\nstatic void b43_nphy_tx_power_ctl_idle_tssi(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nu32 tmp;\r\ns32 rssi[4] = { };\r\nif (phy->chandef->chan->flags & IEEE80211_CHAN_NO_IR)\r\nreturn;\r\nif (b43_nphy_ipa(dev))\r\nb43_nphy_ipa_internal_tssi_setup(dev);\r\nif (phy->rev >= 19)\r\nb43_nphy_rf_ctl_override_rev19(dev, 0x1000, 0, 3, false, 0);\r\nelse if (phy->rev >= 7)\r\nb43_nphy_rf_ctl_override_rev7(dev, 0x1000, 0, 3, false, 0);\r\nelse if (phy->rev >= 3)\r\nb43_nphy_rf_ctl_override(dev, 0x2000, 0, 3, false);\r\nb43_nphy_stop_playback(dev);\r\nb43_nphy_tx_tone(dev, 4000, 0, false, false, false);\r\nudelay(20);\r\ntmp = b43_nphy_poll_rssi(dev, N_RSSI_TSSI_2G, rssi, 1);\r\nb43_nphy_stop_playback(dev);\r\nb43_nphy_rssi_select(dev, 0, N_RSSI_W1);\r\nif (phy->rev >= 19)\r\nb43_nphy_rf_ctl_override_rev19(dev, 0x1000, 0, 3, true, 0);\r\nelse if (phy->rev >= 7)\r\nb43_nphy_rf_ctl_override_rev7(dev, 0x1000, 0, 3, true, 0);\r\nelse if (phy->rev >= 3)\r\nb43_nphy_rf_ctl_override(dev, 0x2000, 0, 3, true);\r\nif (phy->rev >= 19) {\r\nreturn;\r\n} else if (phy->rev >= 3) {\r\nnphy->pwr_ctl_info[0].idle_tssi_5g = (tmp >> 24) & 0xFF;\r\nnphy->pwr_ctl_info[1].idle_tssi_5g = (tmp >> 8) & 0xFF;\r\n} else {\r\nnphy->pwr_ctl_info[0].idle_tssi_5g = (tmp >> 16) & 0xFF;\r\nnphy->pwr_ctl_info[1].idle_tssi_5g = tmp & 0xFF;\r\n}\r\nnphy->pwr_ctl_info[0].idle_tssi_2g = (tmp >> 24) & 0xFF;\r\nnphy->pwr_ctl_info[1].idle_tssi_2g = (tmp >> 8) & 0xFF;\r\n}\r\nstatic void b43_nphy_tx_prepare_adjusted_power_table(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nu8 idx, delta;\r\nu8 i, stf_mode;\r\nfor (i = 0; i < 4; i++)\r\nnphy->adj_pwr_tbl[i] = nphy->tx_power_offset[i];\r\nfor (stf_mode = 0; stf_mode < 4; stf_mode++) {\r\ndelta = 0;\r\nswitch (stf_mode) {\r\ncase 0:\r\nif (b43_is_40mhz(dev) && dev->phy.rev >= 5) {\r\nidx = 68;\r\n} else {\r\ndelta = 1;\r\nidx = b43_is_40mhz(dev) ? 52 : 4;\r\n}\r\nbreak;\r\ncase 1:\r\nidx = b43_is_40mhz(dev) ? 76 : 28;\r\nbreak;\r\ncase 2:\r\nidx = b43_is_40mhz(dev) ? 84 : 36;\r\nbreak;\r\ncase 3:\r\nidx = b43_is_40mhz(dev) ? 92 : 44;\r\nbreak;\r\n}\r\nfor (i = 0; i < 20; i++) {\r\nnphy->adj_pwr_tbl[4 + 4 * i + stf_mode] =\r\nnphy->tx_power_offset[idx];\r\nif (i == 0)\r\nidx += delta;\r\nif (i == 14)\r\nidx += 1 - delta;\r\nif (i == 3 || i == 4 || i == 7 || i == 8 || i == 11 ||\r\ni == 13)\r\nidx += 1;\r\n}\r\n}\r\n}\r\nstatic void b43_nphy_tx_power_ctl_setup(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nstruct ssb_sprom *sprom = dev->dev->bus_sprom;\r\ns16 a1[2], b0[2], b1[2];\r\nu8 idle[2];\r\nu8 ppr_max;\r\ns8 target[2];\r\ns32 num, den, pwr;\r\nu32 regval[64];\r\nu16 freq = phy->chandef->chan->center_freq;\r\nu16 tmp;\r\nu16 r;\r\nu8 i, c;\r\nif (dev->dev->core_rev == 11 || dev->dev->core_rev == 12) {\r\nb43_maskset32(dev, B43_MMIO_MACCTL, ~0, 0x200000);\r\nb43_read32(dev, B43_MMIO_MACCTL);\r\nudelay(1);\r\n}\r\nif (nphy->hang_avoid)\r\nb43_nphy_stay_in_carrier_search(dev, true);\r\nb43_phy_set(dev, B43_NPHY_TSSIMODE, B43_NPHY_TSSIMODE_EN);\r\nif (dev->phy.rev >= 3)\r\nb43_phy_mask(dev, B43_NPHY_TXPCTL_CMD,\r\n~B43_NPHY_TXPCTL_CMD_PCTLEN & 0xFFFF);\r\nelse\r\nb43_phy_set(dev, B43_NPHY_TXPCTL_CMD,\r\nB43_NPHY_TXPCTL_CMD_PCTLEN);\r\nif (dev->dev->core_rev == 11 || dev->dev->core_rev == 12)\r\nb43_maskset32(dev, B43_MMIO_MACCTL, ~0x200000, 0);\r\nif (sprom->revision < 4) {\r\nidle[0] = nphy->pwr_ctl_info[0].idle_tssi_2g;\r\nidle[1] = nphy->pwr_ctl_info[1].idle_tssi_2g;\r\ntarget[0] = target[1] = 52;\r\na1[0] = a1[1] = -424;\r\nb0[0] = b0[1] = 5612;\r\nb1[0] = b1[1] = -1393;\r\n} else {\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\r\nfor (c = 0; c < 2; c++) {\r\nidle[c] = nphy->pwr_ctl_info[c].idle_tssi_2g;\r\ntarget[c] = sprom->core_pwr_info[c].maxpwr_2g;\r\na1[c] = sprom->core_pwr_info[c].pa_2g[0];\r\nb0[c] = sprom->core_pwr_info[c].pa_2g[1];\r\nb1[c] = sprom->core_pwr_info[c].pa_2g[2];\r\n}\r\n} else if (freq >= 4900 && freq < 5100) {\r\nfor (c = 0; c < 2; c++) {\r\nidle[c] = nphy->pwr_ctl_info[c].idle_tssi_5g;\r\ntarget[c] = sprom->core_pwr_info[c].maxpwr_5gl;\r\na1[c] = sprom->core_pwr_info[c].pa_5gl[0];\r\nb0[c] = sprom->core_pwr_info[c].pa_5gl[1];\r\nb1[c] = sprom->core_pwr_info[c].pa_5gl[2];\r\n}\r\n} else if (freq >= 5100 && freq < 5500) {\r\nfor (c = 0; c < 2; c++) {\r\nidle[c] = nphy->pwr_ctl_info[c].idle_tssi_5g;\r\ntarget[c] = sprom->core_pwr_info[c].maxpwr_5g;\r\na1[c] = sprom->core_pwr_info[c].pa_5g[0];\r\nb0[c] = sprom->core_pwr_info[c].pa_5g[1];\r\nb1[c] = sprom->core_pwr_info[c].pa_5g[2];\r\n}\r\n} else if (freq >= 5500) {\r\nfor (c = 0; c < 2; c++) {\r\nidle[c] = nphy->pwr_ctl_info[c].idle_tssi_5g;\r\ntarget[c] = sprom->core_pwr_info[c].maxpwr_5gh;\r\na1[c] = sprom->core_pwr_info[c].pa_5gh[0];\r\nb0[c] = sprom->core_pwr_info[c].pa_5gh[1];\r\nb1[c] = sprom->core_pwr_info[c].pa_5gh[2];\r\n}\r\n} else {\r\nidle[0] = nphy->pwr_ctl_info[0].idle_tssi_5g;\r\nidle[1] = nphy->pwr_ctl_info[1].idle_tssi_5g;\r\ntarget[0] = target[1] = 52;\r\na1[0] = a1[1] = -424;\r\nb0[0] = b0[1] = 5612;\r\nb1[0] = b1[1] = -1393;\r\n}\r\n}\r\nppr_max = b43_ppr_get_max(dev, &nphy->tx_pwr_max_ppr);\r\nif (ppr_max) {\r\ntarget[0] = ppr_max;\r\ntarget[1] = ppr_max;\r\n}\r\nif (dev->phy.rev >= 3) {\r\nif (sprom->fem.ghz2.tssipos)\r\nb43_phy_set(dev, B43_NPHY_TXPCTL_ITSSI, 0x4000);\r\nif (dev->phy.rev >= 7) {\r\nfor (c = 0; c < 2; c++) {\r\nr = c ? 0x190 : 0x170;\r\nif (b43_nphy_ipa(dev))\r\nb43_radio_write(dev, r + 0x9, (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) ? 0xE : 0xC);\r\n}\r\n} else {\r\nif (b43_nphy_ipa(dev)) {\r\ntmp = (b43_current_band(dev->wl) == NL80211_BAND_5GHZ) ? 0xC : 0xE;\r\nb43_radio_write(dev,\r\nB2056_TX0 | B2056_TX_TX_SSI_MUX, tmp);\r\nb43_radio_write(dev,\r\nB2056_TX1 | B2056_TX_TX_SSI_MUX, tmp);\r\n} else {\r\nb43_radio_write(dev,\r\nB2056_TX0 | B2056_TX_TX_SSI_MUX, 0x11);\r\nb43_radio_write(dev,\r\nB2056_TX1 | B2056_TX_TX_SSI_MUX, 0x11);\r\n}\r\n}\r\n}\r\nif (dev->dev->core_rev == 11 || dev->dev->core_rev == 12) {\r\nb43_maskset32(dev, B43_MMIO_MACCTL, ~0, 0x200000);\r\nb43_read32(dev, B43_MMIO_MACCTL);\r\nudelay(1);\r\n}\r\nif (phy->rev >= 19) {\r\n} else if (phy->rev >= 7) {\r\nb43_phy_maskset(dev, B43_NPHY_TXPCTL_CMD,\r\n~B43_NPHY_TXPCTL_CMD_INIT, 0x19);\r\nb43_phy_maskset(dev, B43_NPHY_TXPCTL_INIT,\r\n~B43_NPHY_TXPCTL_INIT_PIDXI1, 0x19);\r\n} else {\r\nb43_phy_maskset(dev, B43_NPHY_TXPCTL_CMD,\r\n~B43_NPHY_TXPCTL_CMD_INIT, 0x40);\r\nif (dev->phy.rev > 1)\r\nb43_phy_maskset(dev, B43_NPHY_TXPCTL_INIT,\r\n~B43_NPHY_TXPCTL_INIT_PIDXI1, 0x40);\r\n}\r\nif (dev->dev->core_rev == 11 || dev->dev->core_rev == 12)\r\nb43_maskset32(dev, B43_MMIO_MACCTL, ~0x200000, 0);\r\nb43_phy_write(dev, B43_NPHY_TXPCTL_N,\r\n0xF0 << B43_NPHY_TXPCTL_N_TSSID_SHIFT |\r\n3 << B43_NPHY_TXPCTL_N_NPTIL2_SHIFT);\r\nb43_phy_write(dev, B43_NPHY_TXPCTL_ITSSI,\r\nidle[0] << B43_NPHY_TXPCTL_ITSSI_0_SHIFT |\r\nidle[1] << B43_NPHY_TXPCTL_ITSSI_1_SHIFT |\r\nB43_NPHY_TXPCTL_ITSSI_BINF);\r\nb43_phy_write(dev, B43_NPHY_TXPCTL_TPWR,\r\ntarget[0] << B43_NPHY_TXPCTL_TPWR_0_SHIFT |\r\ntarget[1] << B43_NPHY_TXPCTL_TPWR_1_SHIFT);\r\nfor (c = 0; c < 2; c++) {\r\nfor (i = 0; i < 64; i++) {\r\nnum = 8 * (16 * b0[c] + b1[c] * i);\r\nden = 32768 + a1[c] * i;\r\npwr = max((4 * num + den / 2) / den, -8);\r\nif (dev->phy.rev < 3 && (i <= (31 - idle[c] + 1)))\r\npwr = max(pwr, target[c] + 1);\r\nregval[i] = pwr;\r\n}\r\nb43_ntab_write_bulk(dev, B43_NTAB32(26 + c, 0), 64, regval);\r\n}\r\nb43_nphy_tx_prepare_adjusted_power_table(dev);\r\nb43_ntab_write_bulk(dev, B43_NTAB16(26, 64), 84, nphy->adj_pwr_tbl);\r\nb43_ntab_write_bulk(dev, B43_NTAB16(27, 64), 84, nphy->adj_pwr_tbl);\r\nif (nphy->hang_avoid)\r\nb43_nphy_stay_in_carrier_search(dev, false);\r\n}\r\nstatic void b43_nphy_tx_gain_table_upload(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nconst u32 *table = NULL;\r\nu32 rfpwr_offset;\r\nu8 pga_gain, pad_gain;\r\nint i;\r\nconst s16 *uninitialized_var(rf_pwr_offset_table);\r\ntable = b43_nphy_get_tx_gain_table(dev);\r\nif (!table)\r\nreturn;\r\nb43_ntab_write_bulk(dev, B43_NTAB32(26, 192), 128, table);\r\nb43_ntab_write_bulk(dev, B43_NTAB32(27, 192), 128, table);\r\nif (phy->rev < 3)\r\nreturn;\r\n#if 0\r\nnphy->gmval = (table[0] >> 16) & 0x7000;\r\n#endif\r\nif (phy->rev >= 19) {\r\nreturn;\r\n} else if (phy->rev >= 7) {\r\nrf_pwr_offset_table = b43_ntab_get_rf_pwr_offset_table(dev);\r\nif (!rf_pwr_offset_table)\r\nreturn;\r\nreturn;\r\n}\r\nfor (i = 0; i < 128; i++) {\r\nif (phy->rev >= 19) {\r\nreturn;\r\n} else if (phy->rev >= 7) {\r\npga_gain = (table[i] >> 24) & 0xf;\r\npad_gain = (table[i] >> 19) & 0x1f;\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\r\nrfpwr_offset = rf_pwr_offset_table[pad_gain];\r\nelse\r\nrfpwr_offset = rf_pwr_offset_table[pga_gain];\r\n} else {\r\npga_gain = (table[i] >> 24) & 0xF;\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\r\nrfpwr_offset = b43_ntab_papd_pga_gain_delta_ipa_2g[pga_gain];\r\nelse\r\nrfpwr_offset = 0;\r\n}\r\nb43_ntab_write(dev, B43_NTAB32(26, 576 + i), rfpwr_offset);\r\nb43_ntab_write(dev, B43_NTAB32(27, 576 + i), rfpwr_offset);\r\n}\r\n}\r\nstatic void b43_nphy_pa_override(struct b43_wldev *dev, bool enable)\r\n{\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nenum nl80211_band band;\r\nu16 tmp;\r\nif (!enable) {\r\nnphy->rfctrl_intc1_save = b43_phy_read(dev,\r\nB43_NPHY_RFCTL_INTC1);\r\nnphy->rfctrl_intc2_save = b43_phy_read(dev,\r\nB43_NPHY_RFCTL_INTC2);\r\nband = b43_current_band(dev->wl);\r\nif (dev->phy.rev >= 7) {\r\ntmp = 0x1480;\r\n} else if (dev->phy.rev >= 3) {\r\nif (band == NL80211_BAND_5GHZ)\r\ntmp = 0x600;\r\nelse\r\ntmp = 0x480;\r\n} else {\r\nif (band == NL80211_BAND_5GHZ)\r\ntmp = 0x180;\r\nelse\r\ntmp = 0x120;\r\n}\r\nb43_phy_write(dev, B43_NPHY_RFCTL_INTC1, tmp);\r\nb43_phy_write(dev, B43_NPHY_RFCTL_INTC2, tmp);\r\n} else {\r\nb43_phy_write(dev, B43_NPHY_RFCTL_INTC1,\r\nnphy->rfctrl_intc1_save);\r\nb43_phy_write(dev, B43_NPHY_RFCTL_INTC2,\r\nnphy->rfctrl_intc2_save);\r\n}\r\n}\r\nstatic void b43_nphy_tx_lpf_bw(struct b43_wldev *dev)\r\n{\r\nu16 tmp;\r\nif (dev->phy.rev < 3 || dev->phy.rev >= 7)\r\nreturn;\r\nif (b43_nphy_ipa(dev))\r\ntmp = b43_is_40mhz(dev) ? 5 : 4;\r\nelse\r\ntmp = b43_is_40mhz(dev) ? 3 : 1;\r\nb43_phy_write(dev, B43_NPHY_TXF_40CO_B32S2,\r\n(tmp << 9) | (tmp << 6) | (tmp << 3) | tmp);\r\nif (b43_nphy_ipa(dev)) {\r\ntmp = b43_is_40mhz(dev) ? 4 : 1;\r\nb43_phy_write(dev, B43_NPHY_TXF_40CO_B1S2,\r\n(tmp << 9) | (tmp << 6) | (tmp << 3) | tmp);\r\n}\r\n}\r\nstatic void b43_nphy_rx_iq_est(struct b43_wldev *dev, struct nphy_iq_est *est,\r\nu16 samps, u8 time, bool wait)\r\n{\r\nint i;\r\nu16 tmp;\r\nb43_phy_write(dev, B43_NPHY_IQEST_SAMCNT, samps);\r\nb43_phy_maskset(dev, B43_NPHY_IQEST_WT, ~B43_NPHY_IQEST_WT_VAL, time);\r\nif (wait)\r\nb43_phy_set(dev, B43_NPHY_IQEST_CMD, B43_NPHY_IQEST_CMD_MODE);\r\nelse\r\nb43_phy_mask(dev, B43_NPHY_IQEST_CMD, ~B43_NPHY_IQEST_CMD_MODE);\r\nb43_phy_set(dev, B43_NPHY_IQEST_CMD, B43_NPHY_IQEST_CMD_START);\r\nfor (i = 1000; i; i--) {\r\ntmp = b43_phy_read(dev, B43_NPHY_IQEST_CMD);\r\nif (!(tmp & B43_NPHY_IQEST_CMD_START)) {\r\nest->i0_pwr = (b43_phy_read(dev, B43_NPHY_IQEST_IPACC_HI0) << 16) |\r\nb43_phy_read(dev, B43_NPHY_IQEST_IPACC_LO0);\r\nest->q0_pwr = (b43_phy_read(dev, B43_NPHY_IQEST_QPACC_HI0) << 16) |\r\nb43_phy_read(dev, B43_NPHY_IQEST_QPACC_LO0);\r\nest->iq0_prod = (b43_phy_read(dev, B43_NPHY_IQEST_IQACC_HI0) << 16) |\r\nb43_phy_read(dev, B43_NPHY_IQEST_IQACC_LO0);\r\nest->i1_pwr = (b43_phy_read(dev, B43_NPHY_IQEST_IPACC_HI1) << 16) |\r\nb43_phy_read(dev, B43_NPHY_IQEST_IPACC_LO1);\r\nest->q1_pwr = (b43_phy_read(dev, B43_NPHY_IQEST_QPACC_HI1) << 16) |\r\nb43_phy_read(dev, B43_NPHY_IQEST_QPACC_LO1);\r\nest->iq1_prod = (b43_phy_read(dev, B43_NPHY_IQEST_IQACC_HI1) << 16) |\r\nb43_phy_read(dev, B43_NPHY_IQEST_IQACC_LO1);\r\nreturn;\r\n}\r\nudelay(10);\r\n}\r\nmemset(est, 0, sizeof(*est));\r\n}\r\nstatic void b43_nphy_rx_iq_coeffs(struct b43_wldev *dev, bool write,\r\nstruct b43_phy_n_iq_comp *pcomp)\r\n{\r\nif (write) {\r\nb43_phy_write(dev, B43_NPHY_C1_RXIQ_COMPA0, pcomp->a0);\r\nb43_phy_write(dev, B43_NPHY_C1_RXIQ_COMPB0, pcomp->b0);\r\nb43_phy_write(dev, B43_NPHY_C2_RXIQ_COMPA1, pcomp->a1);\r\nb43_phy_write(dev, B43_NPHY_C2_RXIQ_COMPB1, pcomp->b1);\r\n} else {\r\npcomp->a0 = b43_phy_read(dev, B43_NPHY_C1_RXIQ_COMPA0);\r\npcomp->b0 = b43_phy_read(dev, B43_NPHY_C1_RXIQ_COMPB0);\r\npcomp->a1 = b43_phy_read(dev, B43_NPHY_C2_RXIQ_COMPA1);\r\npcomp->b1 = b43_phy_read(dev, B43_NPHY_C2_RXIQ_COMPB1);\r\n}\r\n}\r\nstatic void b43_nphy_calc_rx_iq_comp(struct b43_wldev *dev, u8 mask)\r\n{\r\nint i;\r\ns32 iq;\r\nu32 ii;\r\nu32 qq;\r\nint iq_nbits, qq_nbits;\r\nint arsh, brsh;\r\nu16 tmp, a, b;\r\nstruct nphy_iq_est est;\r\nstruct b43_phy_n_iq_comp old;\r\nstruct b43_phy_n_iq_comp new = { };\r\nbool error = false;\r\nif (mask == 0)\r\nreturn;\r\nb43_nphy_rx_iq_coeffs(dev, false, &old);\r\nb43_nphy_rx_iq_coeffs(dev, true, &new);\r\nb43_nphy_rx_iq_est(dev, &est, 0x4000, 32, false);\r\nnew = old;\r\nfor (i = 0; i < 2; i++) {\r\nif (i == 0 && (mask & 1)) {\r\niq = est.iq0_prod;\r\nii = est.i0_pwr;\r\nqq = est.q0_pwr;\r\n} else if (i == 1 && (mask & 2)) {\r\niq = est.iq1_prod;\r\nii = est.i1_pwr;\r\nqq = est.q1_pwr;\r\n} else {\r\ncontinue;\r\n}\r\nif (ii + qq < 2) {\r\nerror = true;\r\nbreak;\r\n}\r\niq_nbits = fls(abs(iq));\r\nqq_nbits = fls(qq);\r\narsh = iq_nbits - 20;\r\nif (arsh >= 0) {\r\na = -((iq << (30 - iq_nbits)) + (ii >> (1 + arsh)));\r\ntmp = ii >> arsh;\r\n} else {\r\na = -((iq << (30 - iq_nbits)) + (ii << (-1 - arsh)));\r\ntmp = ii << -arsh;\r\n}\r\nif (tmp == 0) {\r\nerror = true;\r\nbreak;\r\n}\r\na /= tmp;\r\nbrsh = qq_nbits - 11;\r\nif (brsh >= 0) {\r\nb = (qq << (31 - qq_nbits));\r\ntmp = ii >> brsh;\r\n} else {\r\nb = (qq << (31 - qq_nbits));\r\ntmp = ii << -brsh;\r\n}\r\nif (tmp == 0) {\r\nerror = true;\r\nbreak;\r\n}\r\nb = int_sqrt(b / tmp - a * a) - (1 << 10);\r\nif (i == 0 && (mask & 0x1)) {\r\nif (dev->phy.rev >= 3) {\r\nnew.a0 = a & 0x3FF;\r\nnew.b0 = b & 0x3FF;\r\n} else {\r\nnew.a0 = b & 0x3FF;\r\nnew.b0 = a & 0x3FF;\r\n}\r\n} else if (i == 1 && (mask & 0x2)) {\r\nif (dev->phy.rev >= 3) {\r\nnew.a1 = a & 0x3FF;\r\nnew.b1 = b & 0x3FF;\r\n} else {\r\nnew.a1 = b & 0x3FF;\r\nnew.b1 = a & 0x3FF;\r\n}\r\n}\r\n}\r\nif (error)\r\nnew = old;\r\nb43_nphy_rx_iq_coeffs(dev, true, &new);\r\n}\r\nstatic void b43_nphy_tx_iq_workaround(struct b43_wldev *dev)\r\n{\r\nu16 array[4];\r\nb43_ntab_read_bulk(dev, B43_NTAB16(0xF, 0x50), 4, array);\r\nb43_shm_write16(dev, B43_SHM_SHARED, B43_SHM_SH_NPHY_TXIQW0, array[0]);\r\nb43_shm_write16(dev, B43_SHM_SHARED, B43_SHM_SH_NPHY_TXIQW1, array[1]);\r\nb43_shm_write16(dev, B43_SHM_SHARED, B43_SHM_SH_NPHY_TXIQW2, array[2]);\r\nb43_shm_write16(dev, B43_SHM_SHARED, B43_SHM_SH_NPHY_TXIQW3, array[3]);\r\n}\r\nstatic void b43_nphy_spur_workaround(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nu8 channel = dev->phy.channel;\r\nint tone[2] = { 57, 58 };\r\nu32 noise[2] = { 0x3FF, 0x3FF };\r\nB43_WARN_ON(dev->phy.rev < 3);\r\nif (nphy->hang_avoid)\r\nb43_nphy_stay_in_carrier_search(dev, 1);\r\nif (nphy->gband_spurwar_en) {\r\nif (channel == 11 && b43_is_40mhz(dev))\r\n;\r\nelse\r\n;\r\n}\r\nif (nphy->aband_spurwar_en) {\r\nif (channel == 54) {\r\ntone[0] = 0x20;\r\nnoise[0] = 0x25F;\r\n} else if (channel == 38 || channel == 102 || channel == 118) {\r\nif (0 ) {\r\ntone[0] = 0x20;\r\nnoise[0] = 0x21F;\r\n} else {\r\ntone[0] = 0;\r\nnoise[0] = 0;\r\n}\r\n} else if (channel == 134) {\r\ntone[0] = 0x20;\r\nnoise[0] = 0x21F;\r\n} else if (channel == 151) {\r\ntone[0] = 0x10;\r\nnoise[0] = 0x23F;\r\n} else if (channel == 153 || channel == 161) {\r\ntone[0] = 0x30;\r\nnoise[0] = 0x23F;\r\n} else {\r\ntone[0] = 0;\r\nnoise[0] = 0;\r\n}\r\nif (!tone[0] && !noise[0])\r\n;\r\nelse\r\n;\r\n}\r\nif (nphy->hang_avoid)\r\nb43_nphy_stay_in_carrier_search(dev, 0);\r\n}\r\nstatic void b43_nphy_tx_pwr_ctrl_coef_setup(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nint i, j;\r\nu32 tmp;\r\nu32 cur_real, cur_imag, real_part, imag_part;\r\nu16 buffer[7];\r\nif (nphy->hang_avoid)\r\nb43_nphy_stay_in_carrier_search(dev, true);\r\nb43_ntab_read_bulk(dev, B43_NTAB16(15, 80), 7, buffer);\r\nfor (i = 0; i < 2; i++) {\r\ntmp = ((buffer[i * 2] & 0x3FF) << 10) |\r\n(buffer[i * 2 + 1] & 0x3FF);\r\nb43_phy_write(dev, B43_NPHY_TABLE_ADDR,\r\n(((i + 26) << 10) | 320));\r\nfor (j = 0; j < 128; j++) {\r\nb43_phy_write(dev, B43_NPHY_TABLE_DATAHI,\r\n((tmp >> 16) & 0xFFFF));\r\nb43_phy_write(dev, B43_NPHY_TABLE_DATALO,\r\n(tmp & 0xFFFF));\r\n}\r\n}\r\nfor (i = 0; i < 2; i++) {\r\ntmp = buffer[5 + i];\r\nreal_part = (tmp >> 8) & 0xFF;\r\nimag_part = (tmp & 0xFF);\r\nb43_phy_write(dev, B43_NPHY_TABLE_ADDR,\r\n(((i + 26) << 10) | 448));\r\nif (dev->phy.rev >= 3) {\r\ncur_real = real_part;\r\ncur_imag = imag_part;\r\ntmp = ((cur_real & 0xFF) << 8) | (cur_imag & 0xFF);\r\n}\r\nfor (j = 0; j < 128; j++) {\r\nif (dev->phy.rev < 3) {\r\ncur_real = (real_part * loscale[j] + 128) >> 8;\r\ncur_imag = (imag_part * loscale[j] + 128) >> 8;\r\ntmp = ((cur_real & 0xFF) << 8) |\r\n(cur_imag & 0xFF);\r\n}\r\nb43_phy_write(dev, B43_NPHY_TABLE_DATAHI,\r\n((tmp >> 16) & 0xFFFF));\r\nb43_phy_write(dev, B43_NPHY_TABLE_DATALO,\r\n(tmp & 0xFFFF));\r\n}\r\n}\r\nif (dev->phy.rev >= 3) {\r\nb43_shm_write16(dev, B43_SHM_SHARED,\r\nB43_SHM_SH_NPHY_TXPWR_INDX0, 0xFFFF);\r\nb43_shm_write16(dev, B43_SHM_SHARED,\r\nB43_SHM_SH_NPHY_TXPWR_INDX1, 0xFFFF);\r\n}\r\nif (nphy->hang_avoid)\r\nb43_nphy_stay_in_carrier_search(dev, false);\r\n}\r\nstatic void b43_nphy_restore_rssi_cal(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nu16 *rssical_radio_regs = NULL;\r\nu16 *rssical_phy_regs = NULL;\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\r\nif (!nphy->rssical_chanspec_2G.center_freq)\r\nreturn;\r\nrssical_radio_regs = nphy->rssical_cache.rssical_radio_regs_2G;\r\nrssical_phy_regs = nphy->rssical_cache.rssical_phy_regs_2G;\r\n} else {\r\nif (!nphy->rssical_chanspec_5G.center_freq)\r\nreturn;\r\nrssical_radio_regs = nphy->rssical_cache.rssical_radio_regs_5G;\r\nrssical_phy_regs = nphy->rssical_cache.rssical_phy_regs_5G;\r\n}\r\nif (dev->phy.rev >= 19) {\r\n} else if (dev->phy.rev >= 7) {\r\nb43_radio_maskset(dev, R2057_NB_MASTER_CORE0, ~R2057_VCM_MASK,\r\nrssical_radio_regs[0]);\r\nb43_radio_maskset(dev, R2057_NB_MASTER_CORE1, ~R2057_VCM_MASK,\r\nrssical_radio_regs[1]);\r\n} else {\r\nb43_radio_maskset(dev, B2056_RX0 | B2056_RX_RSSI_MISC, 0xE3,\r\nrssical_radio_regs[0]);\r\nb43_radio_maskset(dev, B2056_RX1 | B2056_RX_RSSI_MISC, 0xE3,\r\nrssical_radio_regs[1]);\r\n}\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_0I_RSSI_Z, rssical_phy_regs[0]);\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_0Q_RSSI_Z, rssical_phy_regs[1]);\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_1I_RSSI_Z, rssical_phy_regs[2]);\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_1Q_RSSI_Z, rssical_phy_regs[3]);\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_0I_RSSI_X, rssical_phy_regs[4]);\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_0Q_RSSI_X, rssical_phy_regs[5]);\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_1I_RSSI_X, rssical_phy_regs[6]);\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_1Q_RSSI_X, rssical_phy_regs[7]);\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_0I_RSSI_Y, rssical_phy_regs[8]);\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_0Q_RSSI_Y, rssical_phy_regs[9]);\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_1I_RSSI_Y, rssical_phy_regs[10]);\r\nb43_phy_write(dev, B43_NPHY_RSSIMC_1Q_RSSI_Y, rssical_phy_regs[11]);\r\n}\r\nstatic void b43_nphy_tx_cal_radio_setup_rev19(struct b43_wldev *dev)\r\n{\r\n}\r\nstatic void b43_nphy_tx_cal_radio_setup_rev7(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nu16 *save = nphy->tx_rx_cal_radio_saveregs;\r\nint core, off;\r\nu16 r, tmp;\r\nfor (core = 0; core < 2; core++) {\r\nr = core ? 0x20 : 0;\r\noff = core * 11;\r\nsave[off + 0] = b43_radio_read(dev, r + R2057_TX0_TX_SSI_MASTER);\r\nsave[off + 1] = b43_radio_read(dev, r + R2057_TX0_IQCAL_VCM_HG);\r\nsave[off + 2] = b43_radio_read(dev, r + R2057_TX0_IQCAL_IDAC);\r\nsave[off + 3] = b43_radio_read(dev, r + R2057_TX0_TSSI_VCM);\r\nsave[off + 4] = 0;\r\nsave[off + 5] = b43_radio_read(dev, r + R2057_TX0_TX_SSI_MUX);\r\nif (phy->radio_rev != 5)\r\nsave[off + 6] = b43_radio_read(dev, r + R2057_TX0_TSSIA);\r\nsave[off + 7] = b43_radio_read(dev, r + R2057_TX0_TSSIG);\r\nsave[off + 8] = b43_radio_read(dev, r + R2057_TX0_TSSI_MISC1);\r\nif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ) {\r\nb43_radio_write(dev, r + R2057_TX0_TX_SSI_MASTER, 0xA);\r\nb43_radio_write(dev, r + R2057_TX0_IQCAL_VCM_HG, 0x43);\r\nb43_radio_write(dev, r + R2057_TX0_IQCAL_IDAC, 0x55);\r\nb43_radio_write(dev, r + R2057_TX0_TSSI_VCM, 0);\r\nb43_radio_write(dev, r + R2057_TX0_TSSIG, 0);\r\nif (nphy->use_int_tx_iq_lo_cal) {\r\nb43_radio_write(dev, r + R2057_TX0_TX_SSI_MUX, 0x4);\r\ntmp = true ? 0x31 : 0x21;\r\nb43_radio_write(dev, r + R2057_TX0_TSSIA, tmp);\r\n}\r\nb43_radio_write(dev, r + R2057_TX0_TSSI_MISC1, 0x00);\r\n} else {\r\nb43_radio_write(dev, r + R2057_TX0_TX_SSI_MASTER, 0x6);\r\nb43_radio_write(dev, r + R2057_TX0_IQCAL_VCM_HG, 0x43);\r\nb43_radio_write(dev, r + R2057_TX0_IQCAL_IDAC, 0x55);\r\nb43_radio_write(dev, r + R2057_TX0_TSSI_VCM, 0);\r\nif (phy->radio_rev != 5)\r\nb43_radio_write(dev, r + R2057_TX0_TSSIA, 0);\r\nif (nphy->use_int_tx_iq_lo_cal) {\r\nb43_radio_write(dev, r + R2057_TX0_TX_SSI_MUX, 0x6);\r\ntmp = true ? 0x31 : 0x21;\r\nb43_radio_write(dev, r + R2057_TX0_TSSIG, tmp);\r\n}\r\nb43_radio_write(dev, r + R2057_TX0_TSSI_MISC1, 0);\r\n}\r\n}\r\n}\r\nstatic void b43_nphy_tx_cal_radio_setup(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nu16 *save = nphy->tx_rx_cal_radio_saveregs;\r\nu16 tmp;\r\nu8 offset, i;\r\nif (phy->rev >= 19) {\r\nb43_nphy_tx_cal_radio_setup_rev19(dev);\r\n} else if (phy->rev >= 7) {\r\nb43_nphy_tx_cal_radio_setup_rev7(dev);\r\n} else if (phy->rev >= 3) {\r\nfor (i = 0; i < 2; i++) {\r\ntmp = (i == 0) ? 0x2000 : 0x3000;\r\noffset = i * 11;\r\nsave[offset + 0] = b43_radio_read(dev, B2055_CAL_RVARCTL);\r\nsave[offset + 1] = b43_radio_read(dev, B2055_CAL_LPOCTL);\r\nsave[offset + 2] = b43_radio_read(dev, B2055_CAL_TS);\r\nsave[offset + 3] = b43_radio_read(dev, B2055_CAL_RCCALRTS);\r\nsave[offset + 4] = b43_radio_read(dev, B2055_CAL_RCALRTS);\r\nsave[offset + 5] = b43_radio_read(dev, B2055_PADDRV);\r\nsave[offset + 6] = b43_radio_read(dev, B2055_XOCTL1);\r\nsave[offset + 7] = b43_radio_read(dev, B2055_XOCTL2);\r\nsave[offset + 8] = b43_radio_read(dev, B2055_XOREGUL);\r\nsave[offset + 9] = b43_radio_read(dev, B2055_XOMISC);\r\nsave[offset + 10] = b43_radio_read(dev, B2055_PLL_LFC1);\r\nif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ) {\r\nb43_radio_write(dev, tmp | B2055_CAL_RVARCTL, 0x0A);\r\nb43_radio_write(dev, tmp | B2055_CAL_LPOCTL, 0x40);\r\nb43_radio_write(dev, tmp | B2055_CAL_TS, 0x55);\r\nb43_radio_write(dev, tmp | B2055_CAL_RCCALRTS, 0);\r\nb43_radio_write(dev, tmp | B2055_CAL_RCALRTS, 0);\r\nif (nphy->ipa5g_on) {\r\nb43_radio_write(dev, tmp | B2055_PADDRV, 4);\r\nb43_radio_write(dev, tmp | B2055_XOCTL1, 1);\r\n} else {\r\nb43_radio_write(dev, tmp | B2055_PADDRV, 0);\r\nb43_radio_write(dev, tmp | B2055_XOCTL1, 0x2F);\r\n}\r\nb43_radio_write(dev, tmp | B2055_XOCTL2, 0);\r\n} else {\r\nb43_radio_write(dev, tmp | B2055_CAL_RVARCTL, 0x06);\r\nb43_radio_write(dev, tmp | B2055_CAL_LPOCTL, 0x40);\r\nb43_radio_write(dev, tmp | B2055_CAL_TS, 0x55);\r\nb43_radio_write(dev, tmp | B2055_CAL_RCCALRTS, 0);\r\nb43_radio_write(dev, tmp | B2055_CAL_RCALRTS, 0);\r\nb43_radio_write(dev, tmp | B2055_XOCTL1, 0);\r\nif (nphy->ipa2g_on) {\r\nb43_radio_write(dev, tmp | B2055_PADDRV, 6);\r\nb43_radio_write(dev, tmp | B2055_XOCTL2,\r\n(dev->phy.rev < 5) ? 0x11 : 0x01);\r\n} else {\r\nb43_radio_write(dev, tmp | B2055_PADDRV, 0);\r\nb43_radio_write(dev, tmp | B2055_XOCTL2, 0);\r\n}\r\n}\r\nb43_radio_write(dev, tmp | B2055_XOREGUL, 0);\r\nb43_radio_write(dev, tmp | B2055_XOMISC, 0);\r\nb43_radio_write(dev, tmp | B2055_PLL_LFC1, 0);\r\n}\r\n} else {\r\nsave[0] = b43_radio_read(dev, B2055_C1_TX_RF_IQCAL1);\r\nb43_radio_write(dev, B2055_C1_TX_RF_IQCAL1, 0x29);\r\nsave[1] = b43_radio_read(dev, B2055_C1_TX_RF_IQCAL2);\r\nb43_radio_write(dev, B2055_C1_TX_RF_IQCAL2, 0x54);\r\nsave[2] = b43_radio_read(dev, B2055_C2_TX_RF_IQCAL1);\r\nb43_radio_write(dev, B2055_C2_TX_RF_IQCAL1, 0x29);\r\nsave[3] = b43_radio_read(dev, B2055_C2_TX_RF_IQCAL2);\r\nb43_radio_write(dev, B2055_C2_TX_RF_IQCAL2, 0x54);\r\nsave[3] = b43_radio_read(dev, B2055_C1_PWRDET_RXTX);\r\nsave[4] = b43_radio_read(dev, B2055_C2_PWRDET_RXTX);\r\nif (!(b43_phy_read(dev, B43_NPHY_BANDCTL) &\r\nB43_NPHY_BANDCTL_5GHZ)) {\r\nb43_radio_write(dev, B2055_C1_PWRDET_RXTX, 0x04);\r\nb43_radio_write(dev, B2055_C2_PWRDET_RXTX, 0x04);\r\n} else {\r\nb43_radio_write(dev, B2055_C1_PWRDET_RXTX, 0x20);\r\nb43_radio_write(dev, B2055_C2_PWRDET_RXTX, 0x20);\r\n}\r\nif (dev->phy.rev < 2) {\r\nb43_radio_set(dev, B2055_C1_TX_BB_MXGM, 0x20);\r\nb43_radio_set(dev, B2055_C2_TX_BB_MXGM, 0x20);\r\n} else {\r\nb43_radio_mask(dev, B2055_C1_TX_BB_MXGM, ~0x20);\r\nb43_radio_mask(dev, B2055_C2_TX_BB_MXGM, ~0x20);\r\n}\r\n}\r\n}\r\nstatic void b43_nphy_update_tx_cal_ladder(struct b43_wldev *dev, u16 core)\r\n{\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nint i;\r\nu16 scale, entry;\r\nu16 tmp = nphy->txcal_bbmult;\r\nif (core == 0)\r\ntmp >>= 8;\r\ntmp &= 0xff;\r\nfor (i = 0; i < 18; i++) {\r\nscale = (ladder_lo[i].percent * tmp) / 100;\r\nentry = ((scale & 0xFF) << 8) | ladder_lo[i].g_env;\r\nb43_ntab_write(dev, B43_NTAB16(15, i), entry);\r\nscale = (ladder_iq[i].percent * tmp) / 100;\r\nentry = ((scale & 0xFF) << 8) | ladder_iq[i].g_env;\r\nb43_ntab_write(dev, B43_NTAB16(15, i + 32), entry);\r\n}\r\n}\r\nstatic void b43_nphy_pa_set_tx_dig_filter(struct b43_wldev *dev, u16 offset,\r\nconst s16 *filter)\r\n{\r\nint i;\r\noffset = B43_PHY_N(offset);\r\nfor (i = 0; i < 15; i++, offset++)\r\nb43_phy_write(dev, offset, filter[i]);\r\n}\r\nstatic void b43_nphy_ext_pa_set_tx_dig_filters(struct b43_wldev *dev)\r\n{\r\nb43_nphy_pa_set_tx_dig_filter(dev, 0x2C5,\r\ntbl_tx_filter_coef_rev4[2]);\r\n}\r\nstatic void b43_nphy_int_pa_set_tx_dig_filters(struct b43_wldev *dev)\r\n{\r\nstatic const u16 offset[] = { 0x186, 0x195, 0x2C5 };\r\nstatic const s16 dig_filter_phy_rev16[] = {\r\n-375, 136, -407, 208, -1527,\r\n956, 93, 186, 93, 230,\r\n-44, 230, 201, -191, 201,\r\n};\r\nint i;\r\nfor (i = 0; i < 3; i++)\r\nb43_nphy_pa_set_tx_dig_filter(dev, offset[i],\r\ntbl_tx_filter_coef_rev4[i]);\r\nif (dev->phy.rev == 16)\r\nb43_nphy_pa_set_tx_dig_filter(dev, 0x186, dig_filter_phy_rev16);\r\nif (dev->phy.rev == 17) {\r\nb43_nphy_pa_set_tx_dig_filter(dev, 0x186, dig_filter_phy_rev16);\r\nb43_nphy_pa_set_tx_dig_filter(dev, 0x195,\r\ntbl_tx_filter_coef_rev4[1]);\r\n}\r\nif (b43_is_40mhz(dev)) {\r\nb43_nphy_pa_set_tx_dig_filter(dev, 0x186,\r\ntbl_tx_filter_coef_rev4[3]);\r\n} else {\r\nif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ)\r\nb43_nphy_pa_set_tx_dig_filter(dev, 0x186,\r\ntbl_tx_filter_coef_rev4[5]);\r\nif (dev->phy.channel == 14)\r\nb43_nphy_pa_set_tx_dig_filter(dev, 0x186,\r\ntbl_tx_filter_coef_rev4[6]);\r\n}\r\n}\r\nstatic struct nphy_txgains b43_nphy_get_tx_gains(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nu16 curr_gain[2];\r\nstruct nphy_txgains target;\r\nconst u32 *table = NULL;\r\nif (!nphy->txpwrctrl) {\r\nint i;\r\nif (nphy->hang_avoid)\r\nb43_nphy_stay_in_carrier_search(dev, true);\r\nb43_ntab_read_bulk(dev, B43_NTAB16(7, 0x110), 2, curr_gain);\r\nif (nphy->hang_avoid)\r\nb43_nphy_stay_in_carrier_search(dev, false);\r\nfor (i = 0; i < 2; ++i) {\r\nif (dev->phy.rev >= 7) {\r\ntarget.ipa[i] = curr_gain[i] & 0x0007;\r\ntarget.pad[i] = (curr_gain[i] & 0x00F8) >> 3;\r\ntarget.pga[i] = (curr_gain[i] & 0x0F00) >> 8;\r\ntarget.txgm[i] = (curr_gain[i] & 0x7000) >> 12;\r\ntarget.tx_lpf[i] = (curr_gain[i] & 0x8000) >> 15;\r\n} else if (dev->phy.rev >= 3) {\r\ntarget.ipa[i] = curr_gain[i] & 0x000F;\r\ntarget.pad[i] = (curr_gain[i] & 0x00F0) >> 4;\r\ntarget.pga[i] = (curr_gain[i] & 0x0F00) >> 8;\r\ntarget.txgm[i] = (curr_gain[i] & 0x7000) >> 12;\r\n} else {\r\ntarget.ipa[i] = curr_gain[i] & 0x0003;\r\ntarget.pad[i] = (curr_gain[i] & 0x000C) >> 2;\r\ntarget.pga[i] = (curr_gain[i] & 0x0070) >> 4;\r\ntarget.txgm[i] = (curr_gain[i] & 0x0380) >> 7;\r\n}\r\n}\r\n} else {\r\nint i;\r\nu16 index[2];\r\nindex[0] = (b43_phy_read(dev, B43_NPHY_C1_TXPCTL_STAT) &\r\nB43_NPHY_TXPCTL_STAT_BIDX) >>\r\nB43_NPHY_TXPCTL_STAT_BIDX_SHIFT;\r\nindex[1] = (b43_phy_read(dev, B43_NPHY_C2_TXPCTL_STAT) &\r\nB43_NPHY_TXPCTL_STAT_BIDX) >>\r\nB43_NPHY_TXPCTL_STAT_BIDX_SHIFT;\r\nfor (i = 0; i < 2; ++i) {\r\ntable = b43_nphy_get_tx_gain_table(dev);\r\nif (!table)\r\nbreak;\r\nif (dev->phy.rev >= 7) {\r\ntarget.ipa[i] = (table[index[i]] >> 16) & 0x7;\r\ntarget.pad[i] = (table[index[i]] >> 19) & 0x1F;\r\ntarget.pga[i] = (table[index[i]] >> 24) & 0xF;\r\ntarget.txgm[i] = (table[index[i]] >> 28) & 0x7;\r\ntarget.tx_lpf[i] = (table[index[i]] >> 31) & 0x1;\r\n} else if (dev->phy.rev >= 3) {\r\ntarget.ipa[i] = (table[index[i]] >> 16) & 0xF;\r\ntarget.pad[i] = (table[index[i]] >> 20) & 0xF;\r\ntarget.pga[i] = (table[index[i]] >> 24) & 0xF;\r\ntarget.txgm[i] = (table[index[i]] >> 28) & 0xF;\r\n} else {\r\ntarget.ipa[i] = (table[index[i]] >> 16) & 0x3;\r\ntarget.pad[i] = (table[index[i]] >> 18) & 0x3;\r\ntarget.pga[i] = (table[index[i]] >> 20) & 0x7;\r\ntarget.txgm[i] = (table[index[i]] >> 23) & 0x7;\r\n}\r\n}\r\n}\r\nreturn target;\r\n}\r\nstatic void b43_nphy_tx_cal_phy_cleanup(struct b43_wldev *dev)\r\n{\r\nu16 *regs = dev->phy.n->tx_rx_cal_phy_saveregs;\r\nif (dev->phy.rev >= 3) {\r\nb43_phy_write(dev, B43_NPHY_AFECTL_C1, regs[0]);\r\nb43_phy_write(dev, B43_NPHY_AFECTL_C2, regs[1]);\r\nb43_phy_write(dev, B43_NPHY_AFECTL_OVER1, regs[2]);\r\nb43_phy_write(dev, B43_NPHY_AFECTL_OVER, regs[3]);\r\nb43_phy_write(dev, B43_NPHY_BBCFG, regs[4]);\r\nb43_ntab_write(dev, B43_NTAB16(8, 3), regs[5]);\r\nb43_ntab_write(dev, B43_NTAB16(8, 19), regs[6]);\r\nb43_phy_write(dev, B43_NPHY_RFCTL_INTC1, regs[7]);\r\nb43_phy_write(dev, B43_NPHY_RFCTL_INTC2, regs[8]);\r\nb43_phy_write(dev, B43_NPHY_PAPD_EN0, regs[9]);\r\nb43_phy_write(dev, B43_NPHY_PAPD_EN1, regs[10]);\r\nb43_nphy_reset_cca(dev);\r\n} else {\r\nb43_phy_maskset(dev, B43_NPHY_AFECTL_C1, 0x0FFF, regs[0]);\r\nb43_phy_maskset(dev, B43_NPHY_AFECTL_C2, 0x0FFF, regs[1]);\r\nb43_phy_write(dev, B43_NPHY_AFECTL_OVER, regs[2]);\r\nb43_ntab_write(dev, B43_NTAB16(8, 2), regs[3]);\r\nb43_ntab_write(dev, B43_NTAB16(8, 18), regs[4]);\r\nb43_phy_write(dev, B43_NPHY_RFCTL_INTC1, regs[5]);\r\nb43_phy_write(dev, B43_NPHY_RFCTL_INTC2, regs[6]);\r\n}\r\n}\r\nstatic void b43_nphy_tx_cal_phy_setup(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nu16 *regs = dev->phy.n->tx_rx_cal_phy_saveregs;\r\nu16 tmp;\r\nregs[0] = b43_phy_read(dev, B43_NPHY_AFECTL_C1);\r\nregs[1] = b43_phy_read(dev, B43_NPHY_AFECTL_C2);\r\nif (dev->phy.rev >= 3) {\r\nb43_phy_maskset(dev, B43_NPHY_AFECTL_C1, 0xF0FF, 0x0A00);\r\nb43_phy_maskset(dev, B43_NPHY_AFECTL_C2, 0xF0FF, 0x0A00);\r\ntmp = b43_phy_read(dev, B43_NPHY_AFECTL_OVER1);\r\nregs[2] = tmp;\r\nb43_phy_write(dev, B43_NPHY_AFECTL_OVER1, tmp | 0x0600);\r\ntmp = b43_phy_read(dev, B43_NPHY_AFECTL_OVER);\r\nregs[3] = tmp;\r\nb43_phy_write(dev, B43_NPHY_AFECTL_OVER, tmp | 0x0600);\r\nregs[4] = b43_phy_read(dev, B43_NPHY_BBCFG);\r\nb43_phy_mask(dev, B43_NPHY_BBCFG,\r\n~B43_NPHY_BBCFG_RSTRX & 0xFFFF);\r\ntmp = b43_ntab_read(dev, B43_NTAB16(8, 3));\r\nregs[5] = tmp;\r\nb43_ntab_write(dev, B43_NTAB16(8, 3), 0);\r\ntmp = b43_ntab_read(dev, B43_NTAB16(8, 19));\r\nregs[6] = tmp;\r\nb43_ntab_write(dev, B43_NTAB16(8, 19), 0);\r\nregs[7] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC1);\r\nregs[8] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC2);\r\nif (!nphy->use_int_tx_iq_lo_cal)\r\nb43_nphy_rf_ctl_intc_override(dev, N_INTC_OVERRIDE_PA,\r\n1, 3);\r\nelse\r\nb43_nphy_rf_ctl_intc_override(dev, N_INTC_OVERRIDE_PA,\r\n0, 3);\r\nb43_nphy_rf_ctl_intc_override(dev, N_INTC_OVERRIDE_TRSW, 2, 1);\r\nb43_nphy_rf_ctl_intc_override(dev, N_INTC_OVERRIDE_TRSW, 8, 2);\r\nregs[9] = b43_phy_read(dev, B43_NPHY_PAPD_EN0);\r\nregs[10] = b43_phy_read(dev, B43_NPHY_PAPD_EN1);\r\nb43_phy_mask(dev, B43_NPHY_PAPD_EN0, ~0x0001);\r\nb43_phy_mask(dev, B43_NPHY_PAPD_EN1, ~0x0001);\r\ntmp = b43_nphy_read_lpf_ctl(dev, 0);\r\nif (phy->rev >= 19)\r\nb43_nphy_rf_ctl_override_rev19(dev, 0x80, tmp, 0, false,\r\n1);\r\nelse if (phy->rev >= 7)\r\nb43_nphy_rf_ctl_override_rev7(dev, 0x80, tmp, 0, false,\r\n1);\r\nif (nphy->use_int_tx_iq_lo_cal && true ) {\r\nif (phy->rev >= 19) {\r\nb43_nphy_rf_ctl_override_rev19(dev, 0x8, 0, 0x3,\r\nfalse, 0);\r\n} else if (phy->rev >= 8) {\r\nb43_nphy_rf_ctl_override_rev7(dev, 0x8, 0, 0x3,\r\nfalse, 0);\r\n} else if (phy->rev == 7) {\r\nb43_radio_maskset(dev, R2057_OVR_REG0, 1 << 4, 1 << 4);\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\r\nb43_radio_maskset(dev, R2057_PAD2G_TUNE_PUS_CORE0, ~1, 0);\r\nb43_radio_maskset(dev, R2057_PAD2G_TUNE_PUS_CORE1, ~1, 0);\r\n} else {\r\nb43_radio_maskset(dev, R2057_IPA5G_CASCOFFV_PU_CORE0, ~1, 0);\r\nb43_radio_maskset(dev, R2057_IPA5G_CASCOFFV_PU_CORE1, ~1, 0);\r\n}\r\n}\r\n}\r\n} else {\r\nb43_phy_maskset(dev, B43_NPHY_AFECTL_C1, 0x0FFF, 0xA000);\r\nb43_phy_maskset(dev, B43_NPHY_AFECTL_C2, 0x0FFF, 0xA000);\r\ntmp = b43_phy_read(dev, B43_NPHY_AFECTL_OVER);\r\nregs[2] = tmp;\r\nb43_phy_write(dev, B43_NPHY_AFECTL_OVER, tmp | 0x3000);\r\ntmp = b43_ntab_read(dev, B43_NTAB16(8, 2));\r\nregs[3] = tmp;\r\ntmp |= 0x2000;\r\nb43_ntab_write(dev, B43_NTAB16(8, 2), tmp);\r\ntmp = b43_ntab_read(dev, B43_NTAB16(8, 18));\r\nregs[4] = tmp;\r\ntmp |= 0x2000;\r\nb43_ntab_write(dev, B43_NTAB16(8, 18), tmp);\r\nregs[5] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC1);\r\nregs[6] = b43_phy_read(dev, B43_NPHY_RFCTL_INTC2);\r\nif (b43_current_band(dev->wl) == NL80211_BAND_5GHZ)\r\ntmp = 0x0180;\r\nelse\r\ntmp = 0x0120;\r\nb43_phy_write(dev, B43_NPHY_RFCTL_INTC1, tmp);\r\nb43_phy_write(dev, B43_NPHY_RFCTL_INTC2, tmp);\r\n}\r\n}\r\nstatic void b43_nphy_save_cal(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nstruct b43_phy_n_iq_comp *rxcal_coeffs = NULL;\r\nu16 *txcal_radio_regs = NULL;\r\nstruct b43_chanspec *iqcal_chanspec;\r\nu16 *table = NULL;\r\nif (nphy->hang_avoid)\r\nb43_nphy_stay_in_carrier_search(dev, 1);\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\r\nrxcal_coeffs = &nphy->cal_cache.rxcal_coeffs_2G;\r\ntxcal_radio_regs = nphy->cal_cache.txcal_radio_regs_2G;\r\niqcal_chanspec = &nphy->iqcal_chanspec_2G;\r\ntable = nphy->cal_cache.txcal_coeffs_2G;\r\n} else {\r\nrxcal_coeffs = &nphy->cal_cache.rxcal_coeffs_5G;\r\ntxcal_radio_regs = nphy->cal_cache.txcal_radio_regs_5G;\r\niqcal_chanspec = &nphy->iqcal_chanspec_5G;\r\ntable = nphy->cal_cache.txcal_coeffs_5G;\r\n}\r\nb43_nphy_rx_iq_coeffs(dev, false, rxcal_coeffs);\r\nif (phy->rev >= 19) {\r\n} else if (phy->rev >= 7) {\r\ntxcal_radio_regs[0] = b43_radio_read(dev,\r\nR2057_TX0_LOFT_FINE_I);\r\ntxcal_radio_regs[1] = b43_radio_read(dev,\r\nR2057_TX0_LOFT_FINE_Q);\r\ntxcal_radio_regs[4] = b43_radio_read(dev,\r\nR2057_TX0_LOFT_COARSE_I);\r\ntxcal_radio_regs[5] = b43_radio_read(dev,\r\nR2057_TX0_LOFT_COARSE_Q);\r\ntxcal_radio_regs[2] = b43_radio_read(dev,\r\nR2057_TX1_LOFT_FINE_I);\r\ntxcal_radio_regs[3] = b43_radio_read(dev,\r\nR2057_TX1_LOFT_FINE_Q);\r\ntxcal_radio_regs[6] = b43_radio_read(dev,\r\nR2057_TX1_LOFT_COARSE_I);\r\ntxcal_radio_regs[7] = b43_radio_read(dev,\r\nR2057_TX1_LOFT_COARSE_Q);\r\n} else if (phy->rev >= 3) {\r\ntxcal_radio_regs[0] = b43_radio_read(dev, 0x2021);\r\ntxcal_radio_regs[1] = b43_radio_read(dev, 0x2022);\r\ntxcal_radio_regs[2] = b43_radio_read(dev, 0x3021);\r\ntxcal_radio_regs[3] = b43_radio_read(dev, 0x3022);\r\ntxcal_radio_regs[4] = b43_radio_read(dev, 0x2023);\r\ntxcal_radio_regs[5] = b43_radio_read(dev, 0x2024);\r\ntxcal_radio_regs[6] = b43_radio_read(dev, 0x3023);\r\ntxcal_radio_regs[7] = b43_radio_read(dev, 0x3024);\r\n} else {\r\ntxcal_radio_regs[0] = b43_radio_read(dev, 0x8B);\r\ntxcal_radio_regs[1] = b43_radio_read(dev, 0xBA);\r\ntxcal_radio_regs[2] = b43_radio_read(dev, 0x8D);\r\ntxcal_radio_regs[3] = b43_radio_read(dev, 0xBC);\r\n}\r\niqcal_chanspec->center_freq = dev->phy.chandef->chan->center_freq;\r\niqcal_chanspec->channel_type =\r\ncfg80211_get_chandef_type(dev->phy.chandef);\r\nb43_ntab_read_bulk(dev, B43_NTAB16(15, 80), 8, table);\r\nif (nphy->hang_avoid)\r\nb43_nphy_stay_in_carrier_search(dev, 0);\r\n}\r\nstatic void b43_nphy_restore_cal(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nu16 coef[4];\r\nu16 *loft = NULL;\r\nu16 *table = NULL;\r\nint i;\r\nu16 *txcal_radio_regs = NULL;\r\nstruct b43_phy_n_iq_comp *rxcal_coeffs = NULL;\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\r\nif (!nphy->iqcal_chanspec_2G.center_freq)\r\nreturn;\r\ntable = nphy->cal_cache.txcal_coeffs_2G;\r\nloft = &nphy->cal_cache.txcal_coeffs_2G[5];\r\n} else {\r\nif (!nphy->iqcal_chanspec_5G.center_freq)\r\nreturn;\r\ntable = nphy->cal_cache.txcal_coeffs_5G;\r\nloft = &nphy->cal_cache.txcal_coeffs_5G[5];\r\n}\r\nb43_ntab_write_bulk(dev, B43_NTAB16(15, 80), 4, table);\r\nfor (i = 0; i < 4; i++) {\r\nif (dev->phy.rev >= 3)\r\ntable[i] = coef[i];\r\nelse\r\ncoef[i] = 0;\r\n}\r\nb43_ntab_write_bulk(dev, B43_NTAB16(15, 88), 4, coef);\r\nb43_ntab_write_bulk(dev, B43_NTAB16(15, 85), 2, loft);\r\nb43_ntab_write_bulk(dev, B43_NTAB16(15, 93), 2, loft);\r\nif (dev->phy.rev < 2)\r\nb43_nphy_tx_iq_workaround(dev);\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\r\ntxcal_radio_regs = nphy->cal_cache.txcal_radio_regs_2G;\r\nrxcal_coeffs = &nphy->cal_cache.rxcal_coeffs_2G;\r\n} else {\r\ntxcal_radio_regs = nphy->cal_cache.txcal_radio_regs_5G;\r\nrxcal_coeffs = &nphy->cal_cache.rxcal_coeffs_5G;\r\n}\r\nif (phy->rev >= 19) {\r\n} else if (phy->rev >= 7) {\r\nb43_radio_write(dev, R2057_TX0_LOFT_FINE_I,\r\ntxcal_radio_regs[0]);\r\nb43_radio_write(dev, R2057_TX0_LOFT_FINE_Q,\r\ntxcal_radio_regs[1]);\r\nb43_radio_write(dev, R2057_TX0_LOFT_COARSE_I,\r\ntxcal_radio_regs[4]);\r\nb43_radio_write(dev, R2057_TX0_LOFT_COARSE_Q,\r\ntxcal_radio_regs[5]);\r\nb43_radio_write(dev, R2057_TX1_LOFT_FINE_I,\r\ntxcal_radio_regs[2]);\r\nb43_radio_write(dev, R2057_TX1_LOFT_FINE_Q,\r\ntxcal_radio_regs[3]);\r\nb43_radio_write(dev, R2057_TX1_LOFT_COARSE_I,\r\ntxcal_radio_regs[6]);\r\nb43_radio_write(dev, R2057_TX1_LOFT_COARSE_Q,\r\ntxcal_radio_regs[7]);\r\n} else if (phy->rev >= 3) {\r\nb43_radio_write(dev, 0x2021, txcal_radio_regs[0]);\r\nb43_radio_write(dev, 0x2022, txcal_radio_regs[1]);\r\nb43_radio_write(dev, 0x3021, txcal_radio_regs[2]);\r\nb43_radio_write(dev, 0x3022, txcal_radio_regs[3]);\r\nb43_radio_write(dev, 0x2023, txcal_radio_regs[4]);\r\nb43_radio_write(dev, 0x2024, txcal_radio_regs[5]);\r\nb43_radio_write(dev, 0x3023, txcal_radio_regs[6]);\r\nb43_radio_write(dev, 0x3024, txcal_radio_regs[7]);\r\n} else {\r\nb43_radio_write(dev, 0x8B, txcal_radio_regs[0]);\r\nb43_radio_write(dev, 0xBA, txcal_radio_regs[1]);\r\nb43_radio_write(dev, 0x8D, txcal_radio_regs[2]);\r\nb43_radio_write(dev, 0xBC, txcal_radio_regs[3]);\r\n}\r\nb43_nphy_rx_iq_coeffs(dev, true, rxcal_coeffs);\r\n}\r\nstatic int b43_nphy_cal_tx_iq_lo(struct b43_wldev *dev,\r\nstruct nphy_txgains target,\r\nbool full, bool mphase)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nint i;\r\nint error = 0;\r\nint freq;\r\nbool avoid = false;\r\nu8 length;\r\nu16 tmp, core, type, count, max, numb, last = 0, cmd;\r\nconst u16 *table;\r\nbool phy6or5x;\r\nu16 buffer[11];\r\nu16 diq_start = 0;\r\nu16 save[2];\r\nu16 gain[2];\r\nstruct nphy_iqcal_params params[2];\r\nbool updated[2] = { };\r\nb43_nphy_stay_in_carrier_search(dev, true);\r\nif (dev->phy.rev >= 4) {\r\navoid = nphy->hang_avoid;\r\nnphy->hang_avoid = false;\r\n}\r\nb43_ntab_read_bulk(dev, B43_NTAB16(7, 0x110), 2, save);\r\nfor (i = 0; i < 2; i++) {\r\nb43_nphy_iq_cal_gain_params(dev, i, target, &params[i]);\r\ngain[i] = params[i].cal_gain;\r\n}\r\nb43_ntab_write_bulk(dev, B43_NTAB16(7, 0x110), 2, gain);\r\nb43_nphy_tx_cal_radio_setup(dev);\r\nb43_nphy_tx_cal_phy_setup(dev);\r\nphy6or5x = dev->phy.rev >= 6 ||\r\n(dev->phy.rev == 5 && nphy->ipa2g_on &&\r\nb43_current_band(dev->wl) == NL80211_BAND_2GHZ);\r\nif (phy6or5x) {\r\nif (b43_is_40mhz(dev)) {\r\nb43_ntab_write_bulk(dev, B43_NTAB16(15, 0), 18,\r\ntbl_tx_iqlo_cal_loft_ladder_40);\r\nb43_ntab_write_bulk(dev, B43_NTAB16(15, 32), 18,\r\ntbl_tx_iqlo_cal_iqimb_ladder_40);\r\n} else {\r\nb43_ntab_write_bulk(dev, B43_NTAB16(15, 0), 18,\r\ntbl_tx_iqlo_cal_loft_ladder_20);\r\nb43_ntab_write_bulk(dev, B43_NTAB16(15, 32), 18,\r\ntbl_tx_iqlo_cal_iqimb_ladder_20);\r\n}\r\n}\r\nif (phy->rev >= 19) {\r\n} else if (phy->rev >= 7) {\r\nb43_phy_write(dev, B43_NPHY_IQLOCAL_CMDGCTL, 0x8AD9);\r\n} else {\r\nb43_phy_write(dev, B43_NPHY_IQLOCAL_CMDGCTL, 0x8AA9);\r\n}\r\nif (!b43_is_40mhz(dev))\r\nfreq = 2500;\r\nelse\r\nfreq = 5000;\r\nif (nphy->mphase_cal_phase_id > 2)\r\nb43_nphy_run_samples(dev, (b43_is_40mhz(dev) ? 40 : 20) * 8,\r\n0xFFFF, 0, true, false, false);\r\nelse\r\nerror = b43_nphy_tx_tone(dev, freq, 250, true, false, false);\r\nif (error == 0) {\r\nif (nphy->mphase_cal_phase_id > 2) {\r\ntable = nphy->mphase_txcal_bestcoeffs;\r\nlength = 11;\r\nif (dev->phy.rev < 3)\r\nlength -= 2;\r\n} else {\r\nif (!full && nphy->txiqlocal_coeffsvalid) {\r\ntable = nphy->txiqlocal_bestc;\r\nlength = 11;\r\nif (dev->phy.rev < 3)\r\nlength -= 2;\r\n} else {\r\nfull = true;\r\nif (dev->phy.rev >= 3) {\r\ntable = tbl_tx_iqlo_cal_startcoefs_nphyrev3;\r\nlength = B43_NTAB_TX_IQLO_CAL_STARTCOEFS_REV3;\r\n} else {\r\ntable = tbl_tx_iqlo_cal_startcoefs;\r\nlength = B43_NTAB_TX_IQLO_CAL_STARTCOEFS;\r\n}\r\n}\r\n}\r\nb43_ntab_write_bulk(dev, B43_NTAB16(15, 64), length, table);\r\nif (full) {\r\nif (dev->phy.rev >= 3)\r\nmax = B43_NTAB_TX_IQLO_CAL_CMDS_FULLCAL_REV3;\r\nelse\r\nmax = B43_NTAB_TX_IQLO_CAL_CMDS_FULLCAL;\r\n} else {\r\nif (dev->phy.rev >= 3)\r\nmax = B43_NTAB_TX_IQLO_CAL_CMDS_RECAL_REV3;\r\nelse\r\nmax = B43_NTAB_TX_IQLO_CAL_CMDS_RECAL;\r\n}\r\nif (mphase) {\r\ncount = nphy->mphase_txcal_cmdidx;\r\nnumb = min(max,\r\n(u16)(count + nphy->mphase_txcal_numcmds));\r\n} else {\r\ncount = 0;\r\nnumb = max;\r\n}\r\nfor (; count < numb; count++) {\r\nif (full) {\r\nif (dev->phy.rev >= 3)\r\ncmd = tbl_tx_iqlo_cal_cmds_fullcal_nphyrev3[count];\r\nelse\r\ncmd = tbl_tx_iqlo_cal_cmds_fullcal[count];\r\n} else {\r\nif (dev->phy.rev >= 3)\r\ncmd = tbl_tx_iqlo_cal_cmds_recal_nphyrev3[count];\r\nelse\r\ncmd = tbl_tx_iqlo_cal_cmds_recal[count];\r\n}\r\ncore = (cmd & 0x3000) >> 12;\r\ntype = (cmd & 0x0F00) >> 8;\r\nif (phy6or5x && updated[core] == 0) {\r\nb43_nphy_update_tx_cal_ladder(dev, core);\r\nupdated[core] = true;\r\n}\r\ntmp = (params[core].ncorr[type] << 8) | 0x66;\r\nb43_phy_write(dev, B43_NPHY_IQLOCAL_CMDNNUM, tmp);\r\nif (type == 1 || type == 3 || type == 4) {\r\nbuffer[0] = b43_ntab_read(dev,\r\nB43_NTAB16(15, 69 + core));\r\ndiq_start = buffer[0];\r\nbuffer[0] = 0;\r\nb43_ntab_write(dev, B43_NTAB16(15, 69 + core),\r\n0);\r\n}\r\nb43_phy_write(dev, B43_NPHY_IQLOCAL_CMD, cmd);\r\nfor (i = 0; i < 2000; i++) {\r\ntmp = b43_phy_read(dev, B43_NPHY_IQLOCAL_CMD);\r\nif (tmp & 0xC000)\r\nbreak;\r\nudelay(10);\r\n}\r\nb43_ntab_read_bulk(dev, B43_NTAB16(15, 96), length,\r\nbuffer);\r\nb43_ntab_write_bulk(dev, B43_NTAB16(15, 64), length,\r\nbuffer);\r\nif (type == 1 || type == 3 || type == 4)\r\nbuffer[0] = diq_start;\r\n}\r\nif (mphase)\r\nnphy->mphase_txcal_cmdidx = (numb >= max) ? 0 : numb;\r\nlast = (dev->phy.rev < 3) ? 6 : 7;\r\nif (!mphase || nphy->mphase_cal_phase_id == last) {\r\nb43_ntab_write_bulk(dev, B43_NTAB16(15, 96), 4, buffer);\r\nb43_ntab_read_bulk(dev, B43_NTAB16(15, 80), 4, buffer);\r\nif (dev->phy.rev < 3) {\r\nbuffer[0] = 0;\r\nbuffer[1] = 0;\r\nbuffer[2] = 0;\r\nbuffer[3] = 0;\r\n}\r\nb43_ntab_write_bulk(dev, B43_NTAB16(15, 88), 4,\r\nbuffer);\r\nb43_ntab_read_bulk(dev, B43_NTAB16(15, 101), 2,\r\nbuffer);\r\nb43_ntab_write_bulk(dev, B43_NTAB16(15, 85), 2,\r\nbuffer);\r\nb43_ntab_write_bulk(dev, B43_NTAB16(15, 93), 2,\r\nbuffer);\r\nlength = 11;\r\nif (dev->phy.rev < 3)\r\nlength -= 2;\r\nb43_ntab_read_bulk(dev, B43_NTAB16(15, 96), length,\r\nnphy->txiqlocal_bestc);\r\nnphy->txiqlocal_coeffsvalid = true;\r\nnphy->txiqlocal_chanspec.center_freq =\r\nphy->chandef->chan->center_freq;\r\nnphy->txiqlocal_chanspec.channel_type =\r\ncfg80211_get_chandef_type(phy->chandef);\r\n} else {\r\nlength = 11;\r\nif (dev->phy.rev < 3)\r\nlength -= 2;\r\nb43_ntab_read_bulk(dev, B43_NTAB16(15, 96), length,\r\nnphy->mphase_txcal_bestcoeffs);\r\n}\r\nb43_nphy_stop_playback(dev);\r\nb43_phy_write(dev, B43_NPHY_IQLOCAL_CMDGCTL, 0);\r\n}\r\nb43_nphy_tx_cal_phy_cleanup(dev);\r\nb43_ntab_write_bulk(dev, B43_NTAB16(7, 0x110), 2, save);\r\nif (dev->phy.rev < 2 && (!mphase || nphy->mphase_cal_phase_id == last))\r\nb43_nphy_tx_iq_workaround(dev);\r\nif (dev->phy.rev >= 4)\r\nnphy->hang_avoid = avoid;\r\nb43_nphy_stay_in_carrier_search(dev, false);\r\nreturn error;\r\n}\r\nstatic void b43_nphy_reapply_tx_cal_coeffs(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nu8 i;\r\nu16 buffer[7];\r\nbool equal = true;\r\nif (!nphy->txiqlocal_coeffsvalid ||\r\nnphy->txiqlocal_chanspec.center_freq != dev->phy.chandef->chan->center_freq ||\r\nnphy->txiqlocal_chanspec.channel_type != cfg80211_get_chandef_type(dev->phy.chandef))\r\nreturn;\r\nb43_ntab_read_bulk(dev, B43_NTAB16(15, 80), 7, buffer);\r\nfor (i = 0; i < 4; i++) {\r\nif (buffer[i] != nphy->txiqlocal_bestc[i]) {\r\nequal = false;\r\nbreak;\r\n}\r\n}\r\nif (!equal) {\r\nb43_ntab_write_bulk(dev, B43_NTAB16(15, 80), 4,\r\nnphy->txiqlocal_bestc);\r\nfor (i = 0; i < 4; i++)\r\nbuffer[i] = 0;\r\nb43_ntab_write_bulk(dev, B43_NTAB16(15, 88), 4,\r\nbuffer);\r\nb43_ntab_write_bulk(dev, B43_NTAB16(15, 85), 2,\r\n&nphy->txiqlocal_bestc[5]);\r\nb43_ntab_write_bulk(dev, B43_NTAB16(15, 93), 2,\r\n&nphy->txiqlocal_bestc[5]);\r\n}\r\n}\r\nstatic int b43_nphy_rev2_cal_rx_iq(struct b43_wldev *dev,\r\nstruct nphy_txgains target, u8 type, bool debug)\r\n{\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nint i, j, index;\r\nu8 rfctl[2];\r\nu8 afectl_core;\r\nu16 tmp[6];\r\nu16 uninitialized_var(cur_hpf1), uninitialized_var(cur_hpf2), cur_lna;\r\nu32 real, imag;\r\nenum nl80211_band band;\r\nu8 use;\r\nu16 cur_hpf;\r\nu16 lna[3] = { 3, 3, 1 };\r\nu16 hpf1[3] = { 7, 2, 0 };\r\nu16 hpf2[3] = { 2, 0, 0 };\r\nu32 power[3] = { };\r\nu16 gain_save[2];\r\nu16 cal_gain[2];\r\nstruct nphy_iqcal_params cal_params[2];\r\nstruct nphy_iq_est est;\r\nint ret = 0;\r\nbool playtone = true;\r\nint desired = 13;\r\nb43_nphy_stay_in_carrier_search(dev, 1);\r\nif (dev->phy.rev < 2)\r\nb43_nphy_reapply_tx_cal_coeffs(dev);\r\nb43_ntab_read_bulk(dev, B43_NTAB16(7, 0x110), 2, gain_save);\r\nfor (i = 0; i < 2; i++) {\r\nb43_nphy_iq_cal_gain_params(dev, i, target, &cal_params[i]);\r\ncal_gain[i] = cal_params[i].cal_gain;\r\n}\r\nb43_ntab_write_bulk(dev, B43_NTAB16(7, 0x110), 2, cal_gain);\r\nfor (i = 0; i < 2; i++) {\r\nif (i == 0) {\r\nrfctl[0] = B43_NPHY_RFCTL_INTC1;\r\nrfctl[1] = B43_NPHY_RFCTL_INTC2;\r\nafectl_core = B43_NPHY_AFECTL_C1;\r\n} else {\r\nrfctl[0] = B43_NPHY_RFCTL_INTC2;\r\nrfctl[1] = B43_NPHY_RFCTL_INTC1;\r\nafectl_core = B43_NPHY_AFECTL_C2;\r\n}\r\ntmp[1] = b43_phy_read(dev, B43_NPHY_RFSEQCA);\r\ntmp[2] = b43_phy_read(dev, afectl_core);\r\ntmp[3] = b43_phy_read(dev, B43_NPHY_AFECTL_OVER);\r\ntmp[4] = b43_phy_read(dev, rfctl[0]);\r\ntmp[5] = b43_phy_read(dev, rfctl[1]);\r\nb43_phy_maskset(dev, B43_NPHY_RFSEQCA,\r\n~B43_NPHY_RFSEQCA_RXDIS & 0xFFFF,\r\n((1 - i) << B43_NPHY_RFSEQCA_RXDIS_SHIFT));\r\nb43_phy_maskset(dev, B43_NPHY_RFSEQCA, ~B43_NPHY_RFSEQCA_TXEN,\r\n(1 - i));\r\nb43_phy_set(dev, afectl_core, 0x0006);\r\nb43_phy_set(dev, B43_NPHY_AFECTL_OVER, 0x0006);\r\nband = b43_current_band(dev->wl);\r\nif (nphy->rxcalparams & 0xFF000000) {\r\nif (band == NL80211_BAND_5GHZ)\r\nb43_phy_write(dev, rfctl[0], 0x140);\r\nelse\r\nb43_phy_write(dev, rfctl[0], 0x110);\r\n} else {\r\nif (band == NL80211_BAND_5GHZ)\r\nb43_phy_write(dev, rfctl[0], 0x180);\r\nelse\r\nb43_phy_write(dev, rfctl[0], 0x120);\r\n}\r\nif (band == NL80211_BAND_5GHZ)\r\nb43_phy_write(dev, rfctl[1], 0x148);\r\nelse\r\nb43_phy_write(dev, rfctl[1], 0x114);\r\nif (nphy->rxcalparams & 0x10000) {\r\nb43_radio_maskset(dev, B2055_C1_GENSPARE2, 0xFC,\r\n(i + 1));\r\nb43_radio_maskset(dev, B2055_C2_GENSPARE2, 0xFC,\r\n(2 - i));\r\n}\r\nfor (j = 0; j < 4; j++) {\r\nif (j < 3) {\r\ncur_lna = lna[j];\r\ncur_hpf1 = hpf1[j];\r\ncur_hpf2 = hpf2[j];\r\n} else {\r\nif (power[1] > 10000) {\r\nuse = 1;\r\ncur_hpf = cur_hpf1;\r\nindex = 2;\r\n} else {\r\nif (power[0] > 10000) {\r\nuse = 1;\r\ncur_hpf = cur_hpf1;\r\nindex = 1;\r\n} else {\r\nindex = 0;\r\nuse = 2;\r\ncur_hpf = cur_hpf2;\r\n}\r\n}\r\ncur_lna = lna[index];\r\ncur_hpf1 = hpf1[index];\r\ncur_hpf2 = hpf2[index];\r\ncur_hpf += desired - hweight32(power[index]);\r\ncur_hpf = clamp_val(cur_hpf, 0, 10);\r\nif (use == 1)\r\ncur_hpf1 = cur_hpf;\r\nelse\r\ncur_hpf2 = cur_hpf;\r\n}\r\ntmp[0] = ((cur_hpf2 << 8) | (cur_hpf1 << 4) |\r\n(cur_lna << 2));\r\nb43_nphy_rf_ctl_override(dev, 0x400, tmp[0], 3,\r\nfalse);\r\nb43_nphy_force_rf_sequence(dev, B43_RFSEQ_RESET2RX);\r\nb43_nphy_stop_playback(dev);\r\nif (playtone) {\r\nret = b43_nphy_tx_tone(dev, 4000,\r\n(nphy->rxcalparams & 0xFFFF),\r\nfalse, false, true);\r\nplaytone = false;\r\n} else {\r\nb43_nphy_run_samples(dev, 160, 0xFFFF, 0, false,\r\nfalse, true);\r\n}\r\nif (ret == 0) {\r\nif (j < 3) {\r\nb43_nphy_rx_iq_est(dev, &est, 1024, 32,\r\nfalse);\r\nif (i == 0) {\r\nreal = est.i0_pwr;\r\nimag = est.q0_pwr;\r\n} else {\r\nreal = est.i1_pwr;\r\nimag = est.q1_pwr;\r\n}\r\npower[i] = ((real + imag) / 1024) + 1;\r\n} else {\r\nb43_nphy_calc_rx_iq_comp(dev, 1 << i);\r\n}\r\nb43_nphy_stop_playback(dev);\r\n}\r\nif (ret != 0)\r\nbreak;\r\n}\r\nb43_radio_mask(dev, B2055_C1_GENSPARE2, 0xFC);\r\nb43_radio_mask(dev, B2055_C2_GENSPARE2, 0xFC);\r\nb43_phy_write(dev, rfctl[1], tmp[5]);\r\nb43_phy_write(dev, rfctl[0], tmp[4]);\r\nb43_phy_write(dev, B43_NPHY_AFECTL_OVER, tmp[3]);\r\nb43_phy_write(dev, afectl_core, tmp[2]);\r\nb43_phy_write(dev, B43_NPHY_RFSEQCA, tmp[1]);\r\nif (ret != 0)\r\nbreak;\r\n}\r\nb43_nphy_rf_ctl_override(dev, 0x400, 0, 3, true);\r\nb43_nphy_force_rf_sequence(dev, B43_RFSEQ_RESET2RX);\r\nb43_ntab_write_bulk(dev, B43_NTAB16(7, 0x110), 2, gain_save);\r\nb43_nphy_stay_in_carrier_search(dev, 0);\r\nreturn ret;\r\n}\r\nstatic int b43_nphy_rev3_cal_rx_iq(struct b43_wldev *dev,\r\nstruct nphy_txgains target, u8 type, bool debug)\r\n{\r\nreturn -1;\r\n}\r\nstatic int b43_nphy_cal_rx_iq(struct b43_wldev *dev,\r\nstruct nphy_txgains target, u8 type, bool debug)\r\n{\r\nif (dev->phy.rev >= 7)\r\ntype = 0;\r\nif (dev->phy.rev >= 3)\r\nreturn b43_nphy_rev3_cal_rx_iq(dev, target, type, debug);\r\nelse\r\nreturn b43_nphy_rev2_cal_rx_iq(dev, target, type, debug);\r\n}\r\nstatic void b43_nphy_set_rx_core_state(struct b43_wldev *dev, u8 mask)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_n *nphy = phy->n;\r\nnphy->phyrxchain = mask;\r\nif (0 )\r\nreturn;\r\nb43_mac_suspend(dev);\r\nif (nphy->hang_avoid)\r\nb43_nphy_stay_in_carrier_search(dev, true);\r\nb43_phy_maskset(dev, B43_NPHY_RFSEQCA, ~B43_NPHY_RFSEQCA_RXEN,\r\n(mask & 0x3) << B43_NPHY_RFSEQCA_RXEN_SHIFT);\r\nif ((mask & 0x3) != 0x3) {\r\nb43_phy_write(dev, B43_NPHY_HPANT_SWTHRES, 1);\r\nif (dev->phy.rev >= 3) {\r\n}\r\n} else {\r\nb43_phy_write(dev, B43_NPHY_HPANT_SWTHRES, 0x1E);\r\nif (dev->phy.rev >= 3) {\r\n}\r\n}\r\nb43_nphy_force_rf_sequence(dev, B43_RFSEQ_RESET2RX);\r\nif (nphy->hang_avoid)\r\nb43_nphy_stay_in_carrier_search(dev, false);\r\nb43_mac_enable(dev);\r\n}\r\nstatic enum b43_txpwr_result b43_nphy_op_recalc_txpower(struct b43_wldev *dev,\r\nbool ignore_tssi)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nstruct ieee80211_channel *channel = dev->wl->hw->conf.chandef.chan;\r\nstruct b43_ppr *ppr = &nphy->tx_pwr_max_ppr;\r\nu8 max;\r\nbool tx_pwr_state;\r\nif (nphy->tx_pwr_last_recalc_freq == channel->center_freq &&\r\nnphy->tx_pwr_last_recalc_limit == phy->desired_txpower)\r\nreturn B43_TXPWR_RES_DONE;\r\nb43_ppr_clear(dev, ppr);\r\nb43_ppr_load_max_from_sprom(dev, ppr, B43_BAND_2G);\r\nmax = INT_TO_Q52(phy->chandef->chan->max_power);\r\nif (phy->desired_txpower)\r\nmax = min_t(u8, max, INT_TO_Q52(phy->desired_txpower));\r\nb43_ppr_apply_max(dev, ppr, max);\r\nif (b43_debug(dev, B43_DBG_XMITPOWER))\r\nb43dbg(dev->wl, "Calculated TX power: " Q52_FMT "\n",\r\nQ52_ARG(b43_ppr_get_max(dev, ppr)));\r\n#if 0\r\nhw_gain = 6;\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\r\nhw_gain += sprom->antenna_gain.a0;\r\nelse\r\nhw_gain += sprom->antenna_gain.a1;\r\nb43_ppr_add(dev, ppr, -hw_gain);\r\n#endif\r\nb43_ppr_apply_min(dev, ppr, INT_TO_Q52(8));\r\ntx_pwr_state = nphy->txpwrctrl;\r\nb43_mac_suspend(dev);\r\nb43_nphy_tx_power_ctl_setup(dev);\r\nif (dev->dev->core_rev == 11 || dev->dev->core_rev == 12) {\r\nb43_maskset32(dev, B43_MMIO_MACCTL, ~0, B43_MACCTL_PHY_LOCK);\r\nb43_read32(dev, B43_MMIO_MACCTL);\r\nudelay(1);\r\n}\r\nb43_nphy_tx_power_ctrl(dev, nphy->txpwrctrl);\r\nif (dev->dev->core_rev == 11 || dev->dev->core_rev == 12)\r\nb43_maskset32(dev, B43_MMIO_MACCTL, ~B43_MACCTL_PHY_LOCK, 0);\r\nb43_mac_enable(dev);\r\nnphy->tx_pwr_last_recalc_freq = channel->center_freq;\r\nnphy->tx_pwr_last_recalc_limit = phy->desired_txpower;\r\nreturn B43_TXPWR_RES_DONE;\r\n}\r\nstatic void b43_nphy_update_mimo_config(struct b43_wldev *dev, s32 preamble)\r\n{\r\nu16 mimocfg = b43_phy_read(dev, B43_NPHY_MIMOCFG);\r\nmimocfg |= B43_NPHY_MIMOCFG_AUTO;\r\nif (preamble == 1)\r\nmimocfg |= B43_NPHY_MIMOCFG_GFMIX;\r\nelse\r\nmimocfg &= ~B43_NPHY_MIMOCFG_GFMIX;\r\nb43_phy_write(dev, B43_NPHY_MIMOCFG, mimocfg);\r\n}\r\nstatic void b43_nphy_bphy_init(struct b43_wldev *dev)\r\n{\r\nunsigned int i;\r\nu16 val;\r\nval = 0x1E1F;\r\nfor (i = 0; i < 16; i++) {\r\nb43_phy_write(dev, B43_PHY_N_BMODE(0x88 + i), val);\r\nval -= 0x202;\r\n}\r\nval = 0x3E3F;\r\nfor (i = 0; i < 16; i++) {\r\nb43_phy_write(dev, B43_PHY_N_BMODE(0x98 + i), val);\r\nval -= 0x202;\r\n}\r\nb43_phy_write(dev, B43_PHY_N_BMODE(0x38), 0x668);\r\n}\r\nstatic void b43_nphy_superswitch_init(struct b43_wldev *dev, bool init)\r\n{\r\nif (dev->phy.rev >= 7)\r\nreturn;\r\nif (dev->phy.rev >= 3) {\r\nif (!init)\r\nreturn;\r\nif (0 ) {\r\nb43_ntab_write(dev, B43_NTAB16(9, 2), 0x211);\r\nb43_ntab_write(dev, B43_NTAB16(9, 3), 0x222);\r\nb43_ntab_write(dev, B43_NTAB16(9, 8), 0x144);\r\nb43_ntab_write(dev, B43_NTAB16(9, 12), 0x188);\r\n}\r\n} else {\r\nb43_phy_write(dev, B43_NPHY_GPIO_LOOEN, 0);\r\nb43_phy_write(dev, B43_NPHY_GPIO_HIOEN, 0);\r\nswitch (dev->dev->bus_type) {\r\n#ifdef CONFIG_B43_BCMA\r\ncase B43_BUS_BCMA:\r\nbcma_chipco_gpio_control(&dev->dev->bdev->bus->drv_cc,\r\n0xFC00, 0xFC00);\r\nbreak;\r\n#endif\r\n#ifdef CONFIG_B43_SSB\r\ncase B43_BUS_SSB:\r\nssb_chipco_gpio_control(&dev->dev->sdev->bus->chipco,\r\n0xFC00, 0xFC00);\r\nbreak;\r\n#endif\r\n}\r\nb43_maskset32(dev, B43_MMIO_MACCTL, ~B43_MACCTL_GPOUTSMSK, 0);\r\nb43_maskset16(dev, B43_MMIO_GPIO_MASK, ~0, 0xFC00);\r\nb43_maskset16(dev, B43_MMIO_GPIO_CONTROL, (~0xFC00 & 0xFFFF),\r\n0);\r\nif (init) {\r\nb43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_LO1, 0x2D8);\r\nb43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_UP1, 0x301);\r\nb43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_LO2, 0x2D8);\r\nb43_phy_write(dev, B43_NPHY_RFCTL_LUT_TRSW_UP2, 0x301);\r\n}\r\n}\r\n}\r\nstatic int b43_phy_initn(struct b43_wldev *dev)\r\n{\r\nstruct ssb_sprom *sprom = dev->dev->bus_sprom;\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_n *nphy = phy->n;\r\nu8 tx_pwr_state;\r\nstruct nphy_txgains target;\r\nu16 tmp;\r\nenum nl80211_band tmp2;\r\nbool do_rssi_cal;\r\nu16 clip[2];\r\nbool do_cal = false;\r\nif ((dev->phy.rev >= 3) &&\r\n(sprom->boardflags_lo & B43_BFL_EXTLNA) &&\r\n(b43_current_band(dev->wl) == NL80211_BAND_2GHZ)) {\r\nswitch (dev->dev->bus_type) {\r\n#ifdef CONFIG_B43_BCMA\r\ncase B43_BUS_BCMA:\r\nbcma_cc_set32(&dev->dev->bdev->bus->drv_cc,\r\nBCMA_CC_CHIPCTL, 0x40);\r\nbreak;\r\n#endif\r\n#ifdef CONFIG_B43_SSB\r\ncase B43_BUS_SSB:\r\nchipco_set32(&dev->dev->sdev->bus->chipco,\r\nSSB_CHIPCO_CHIPCTL, 0x40);\r\nbreak;\r\n#endif\r\n}\r\n}\r\nnphy->use_int_tx_iq_lo_cal = b43_nphy_ipa(dev) ||\r\nphy->rev >= 7 ||\r\n(phy->rev >= 5 &&\r\nsprom->boardflags2_hi & B43_BFH2_INTERNDET_TXIQCAL);\r\nnphy->deaf_count = 0;\r\nb43_nphy_tables_init(dev);\r\nnphy->crsminpwr_adjusted = false;\r\nnphy->noisevars_adjusted = false;\r\nif (dev->phy.rev >= 3) {\r\nb43_phy_write(dev, B43_NPHY_TXF_40CO_B1S1, 0);\r\nb43_phy_write(dev, B43_NPHY_RFCTL_OVER, 0);\r\nif (phy->rev >= 7) {\r\nb43_phy_write(dev, B43_NPHY_REV7_RF_CTL_OVER3, 0);\r\nb43_phy_write(dev, B43_NPHY_REV7_RF_CTL_OVER4, 0);\r\nb43_phy_write(dev, B43_NPHY_REV7_RF_CTL_OVER5, 0);\r\nb43_phy_write(dev, B43_NPHY_REV7_RF_CTL_OVER6, 0);\r\n}\r\nif (phy->rev >= 19) {\r\n}\r\nb43_phy_write(dev, B43_NPHY_TXF_40CO_B1S0, 0);\r\nb43_phy_write(dev, B43_NPHY_TXF_40CO_B32S1, 0);\r\n} else {\r\nb43_phy_write(dev, B43_NPHY_RFCTL_OVER, 0);\r\n}\r\nb43_phy_write(dev, B43_NPHY_RFCTL_INTC1, 0);\r\nb43_phy_write(dev, B43_NPHY_RFCTL_INTC2, 0);\r\nif (dev->phy.rev < 6) {\r\nb43_phy_write(dev, B43_NPHY_RFCTL_INTC3, 0);\r\nb43_phy_write(dev, B43_NPHY_RFCTL_INTC4, 0);\r\n}\r\nb43_phy_mask(dev, B43_NPHY_RFSEQMODE,\r\n~(B43_NPHY_RFSEQMODE_CAOVER |\r\nB43_NPHY_RFSEQMODE_TROVER));\r\nif (dev->phy.rev >= 3)\r\nb43_phy_write(dev, B43_NPHY_AFECTL_OVER1, 0);\r\nb43_phy_write(dev, B43_NPHY_AFECTL_OVER, 0);\r\nif (dev->phy.rev <= 2) {\r\ntmp = (dev->phy.rev == 2) ? 0x3B : 0x40;\r\nb43_phy_maskset(dev, B43_NPHY_BPHY_CTL3,\r\n~B43_NPHY_BPHY_CTL3_SCALE,\r\ntmp << B43_NPHY_BPHY_CTL3_SCALE_SHIFT);\r\n}\r\nb43_phy_write(dev, B43_NPHY_AFESEQ_TX2RX_PUD_20M, 0x20);\r\nb43_phy_write(dev, B43_NPHY_AFESEQ_TX2RX_PUD_40M, 0x20);\r\nif (sprom->boardflags2_lo & B43_BFL2_SKWRKFEM_BRD ||\r\n(dev->dev->board_vendor == PCI_VENDOR_ID_APPLE &&\r\ndev->dev->board_type == BCMA_BOARD_TYPE_BCM943224M93))\r\nb43_phy_write(dev, B43_NPHY_TXREALFD, 0xA0);\r\nelse\r\nb43_phy_write(dev, B43_NPHY_TXREALFD, 0xB8);\r\nb43_phy_write(dev, B43_NPHY_MIMO_CRSTXEXT, 0xC8);\r\nb43_phy_write(dev, B43_NPHY_PLOAD_CSENSE_EXTLEN, 0x50);\r\nb43_phy_write(dev, B43_NPHY_TXRIFS_FRDEL, 0x30);\r\nif (phy->rev < 8)\r\nb43_nphy_update_mimo_config(dev, nphy->preamble_override);\r\nb43_nphy_update_txrx_chain(dev);\r\nif (phy->rev < 2) {\r\nb43_phy_write(dev, B43_NPHY_DUP40_GFBL, 0xAA8);\r\nb43_phy_write(dev, B43_NPHY_DUP40_BL, 0x9A4);\r\n}\r\ntmp2 = b43_current_band(dev->wl);\r\nif (b43_nphy_ipa(dev)) {\r\nb43_phy_set(dev, B43_NPHY_PAPD_EN0, 0x1);\r\nb43_phy_maskset(dev, B43_NPHY_EPS_TABLE_ADJ0, 0x007F,\r\nnphy->papd_epsilon_offset[0] << 7);\r\nb43_phy_set(dev, B43_NPHY_PAPD_EN1, 0x1);\r\nb43_phy_maskset(dev, B43_NPHY_EPS_TABLE_ADJ1, 0x007F,\r\nnphy->papd_epsilon_offset[1] << 7);\r\nb43_nphy_int_pa_set_tx_dig_filters(dev);\r\n} else if (phy->rev >= 5) {\r\nb43_nphy_ext_pa_set_tx_dig_filters(dev);\r\n}\r\nb43_nphy_workarounds(dev);\r\nb43_phy_force_clock(dev, 1);\r\ntmp = b43_phy_read(dev, B43_NPHY_BBCFG);\r\nb43_phy_write(dev, B43_NPHY_BBCFG, tmp | B43_NPHY_BBCFG_RSTCCA);\r\nb43_phy_write(dev, B43_NPHY_BBCFG, tmp & ~B43_NPHY_BBCFG_RSTCCA);\r\nb43_phy_force_clock(dev, 0);\r\nb43_mac_phy_clock_set(dev, true);\r\nif (phy->rev < 7) {\r\nb43_nphy_pa_override(dev, false);\r\nb43_nphy_force_rf_sequence(dev, B43_RFSEQ_RX2TX);\r\nb43_nphy_force_rf_sequence(dev, B43_RFSEQ_RESET2RX);\r\nb43_nphy_pa_override(dev, true);\r\n}\r\nb43_nphy_classifier(dev, 0, 0);\r\nb43_nphy_read_clip_detection(dev, clip);\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\r\nb43_nphy_bphy_init(dev);\r\ntx_pwr_state = nphy->txpwrctrl;\r\nb43_nphy_tx_power_ctrl(dev, false);\r\nb43_nphy_tx_power_fix(dev);\r\nb43_nphy_tx_power_ctl_idle_tssi(dev);\r\nb43_nphy_tx_power_ctl_setup(dev);\r\nb43_nphy_tx_gain_table_upload(dev);\r\nif (nphy->phyrxchain != 3)\r\nb43_nphy_set_rx_core_state(dev, nphy->phyrxchain);\r\nif (nphy->mphase_cal_phase_id > 0)\r\n;\r\ndo_rssi_cal = false;\r\nif (phy->rev >= 3) {\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\r\ndo_rssi_cal = !nphy->rssical_chanspec_2G.center_freq;\r\nelse\r\ndo_rssi_cal = !nphy->rssical_chanspec_5G.center_freq;\r\nif (do_rssi_cal)\r\nb43_nphy_rssi_cal(dev);\r\nelse\r\nb43_nphy_restore_rssi_cal(dev);\r\n} else {\r\nb43_nphy_rssi_cal(dev);\r\n}\r\nif (!((nphy->measure_hold & 0x6) != 0)) {\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\r\ndo_cal = !nphy->iqcal_chanspec_2G.center_freq;\r\nelse\r\ndo_cal = !nphy->iqcal_chanspec_5G.center_freq;\r\nif (nphy->mute)\r\ndo_cal = false;\r\nif (do_cal) {\r\ntarget = b43_nphy_get_tx_gains(dev);\r\nif (nphy->antsel_type == 2)\r\nb43_nphy_superswitch_init(dev, true);\r\nif (nphy->perical != 2) {\r\nb43_nphy_rssi_cal(dev);\r\nif (phy->rev >= 3) {\r\nnphy->cal_orig_pwr_idx[0] =\r\nnphy->txpwrindex[0].index_internal;\r\nnphy->cal_orig_pwr_idx[1] =\r\nnphy->txpwrindex[1].index_internal;\r\ntarget = b43_nphy_get_tx_gains(dev);\r\n}\r\nif (!b43_nphy_cal_tx_iq_lo(dev, target, true, false))\r\nif (b43_nphy_cal_rx_iq(dev, target, 2, 0) == 0)\r\nb43_nphy_save_cal(dev);\r\n} else if (nphy->mphase_cal_phase_id == 0)\r\n;\r\n} else {\r\nb43_nphy_restore_cal(dev);\r\n}\r\n}\r\nb43_nphy_tx_pwr_ctrl_coef_setup(dev);\r\nb43_nphy_tx_power_ctrl(dev, tx_pwr_state);\r\nb43_phy_write(dev, B43_NPHY_TXMACIF_HOLDOFF, 0x0015);\r\nb43_phy_write(dev, B43_NPHY_TXMACDELAY, 0x0320);\r\nif (phy->rev >= 3 && phy->rev <= 6)\r\nb43_phy_write(dev, B43_NPHY_PLOAD_CSENSE_EXTLEN, 0x0032);\r\nb43_nphy_tx_lpf_bw(dev);\r\nif (phy->rev >= 3)\r\nb43_nphy_spur_workaround(dev);\r\nreturn 0;\r\n}\r\nstatic void b43_chantab_phy_upload(struct b43_wldev *dev,\r\nconst struct b43_phy_n_sfo_cfg *e)\r\n{\r\nb43_phy_write(dev, B43_NPHY_BW1A, e->phy_bw1a);\r\nb43_phy_write(dev, B43_NPHY_BW2, e->phy_bw2);\r\nb43_phy_write(dev, B43_NPHY_BW3, e->phy_bw3);\r\nb43_phy_write(dev, B43_NPHY_BW4, e->phy_bw4);\r\nb43_phy_write(dev, B43_NPHY_BW5, e->phy_bw5);\r\nb43_phy_write(dev, B43_NPHY_BW6, e->phy_bw6);\r\n}\r\nstatic void b43_nphy_pmu_spur_avoid(struct b43_wldev *dev, bool avoid)\r\n{\r\nswitch (dev->dev->bus_type) {\r\n#ifdef CONFIG_B43_BCMA\r\ncase B43_BUS_BCMA:\r\nbcma_pmu_spuravoid_pllupdate(&dev->dev->bdev->bus->drv_cc,\r\navoid);\r\nbreak;\r\n#endif\r\n#ifdef CONFIG_B43_SSB\r\ncase B43_BUS_SSB:\r\nssb_pmu_spuravoid_pllupdate(&dev->dev->sdev->bus->chipco,\r\navoid);\r\nbreak;\r\n#endif\r\n}\r\n}\r\nstatic void b43_nphy_channel_setup(struct b43_wldev *dev,\r\nconst struct b43_phy_n_sfo_cfg *e,\r\nstruct ieee80211_channel *new_channel)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_n *nphy = dev->phy.n;\r\nint ch = new_channel->hw_value;\r\nu16 tmp16;\r\nif (new_channel->band == NL80211_BAND_5GHZ) {\r\nb43_phy_mask(dev, B43_NPHY_BANDCTL, ~B43_NPHY_BANDCTL_5GHZ);\r\ntmp16 = b43_read16(dev, B43_MMIO_PSM_PHY_HDR);\r\nb43_write16(dev, B43_MMIO_PSM_PHY_HDR, tmp16 | 4);\r\nb43_phy_set(dev, B43_PHY_B_BBCFG,\r\nB43_PHY_B_BBCFG_RSTCCA | B43_PHY_B_BBCFG_RSTRX);\r\nb43_write16(dev, B43_MMIO_PSM_PHY_HDR, tmp16);\r\nb43_phy_set(dev, B43_NPHY_BANDCTL, B43_NPHY_BANDCTL_5GHZ);\r\n} else if (new_channel->band == NL80211_BAND_2GHZ) {\r\nb43_phy_mask(dev, B43_NPHY_BANDCTL, ~B43_NPHY_BANDCTL_5GHZ);\r\ntmp16 = b43_read16(dev, B43_MMIO_PSM_PHY_HDR);\r\nb43_write16(dev, B43_MMIO_PSM_PHY_HDR, tmp16 | 4);\r\nb43_phy_mask(dev, B43_PHY_B_BBCFG,\r\n(u16)~(B43_PHY_B_BBCFG_RSTCCA | B43_PHY_B_BBCFG_RSTRX));\r\nb43_write16(dev, B43_MMIO_PSM_PHY_HDR, tmp16);\r\n}\r\nb43_chantab_phy_upload(dev, e);\r\nif (new_channel->hw_value == 14) {\r\nb43_nphy_classifier(dev, 2, 0);\r\nb43_phy_set(dev, B43_PHY_B_TEST, 0x0800);\r\n} else {\r\nb43_nphy_classifier(dev, 2, 2);\r\nif (new_channel->band == NL80211_BAND_2GHZ)\r\nb43_phy_mask(dev, B43_PHY_B_TEST, ~0x840);\r\n}\r\nif (!nphy->txpwrctrl)\r\nb43_nphy_tx_power_fix(dev);\r\nif (dev->phy.rev < 3)\r\nb43_nphy_adjust_lna_gain_table(dev);\r\nb43_nphy_tx_lpf_bw(dev);\r\nif (dev->phy.rev >= 3 &&\r\ndev->phy.n->spur_avoid != B43_SPUR_AVOID_DISABLE) {\r\nu8 spuravoid = 0;\r\nif (dev->phy.n->spur_avoid == B43_SPUR_AVOID_FORCE) {\r\nspuravoid = 1;\r\n} else if (phy->rev >= 19) {\r\n} else if (phy->rev >= 18) {\r\n} else if (phy->rev >= 17) {\r\n} else if (phy->rev >= 16) {\r\n} else if (phy->rev >= 7) {\r\nif (!b43_is_40mhz(dev)) {\r\nif (ch == 13 || ch == 14 || ch == 153)\r\nspuravoid = 1;\r\n} else {\r\nif (ch == 54)\r\nspuravoid = 1;\r\n}\r\n} else {\r\nif (!b43_is_40mhz(dev)) {\r\nif ((ch >= 5 && ch <= 8) || ch == 13 || ch == 14)\r\nspuravoid = 1;\r\n} else {\r\nif (nphy->aband_spurwar_en &&\r\n(ch == 38 || ch == 102 || ch == 118))\r\nspuravoid = dev->dev->chip_id == 0x4716;\r\n}\r\n}\r\nb43_nphy_pmu_spur_avoid(dev, spuravoid);\r\nb43_mac_switch_freq(dev, spuravoid);\r\nif (dev->phy.rev == 3 || dev->phy.rev == 4)\r\nb43_wireless_core_phy_pll_reset(dev);\r\nif (spuravoid)\r\nb43_phy_set(dev, B43_NPHY_BBCFG, B43_NPHY_BBCFG_RSTRX);\r\nelse\r\nb43_phy_mask(dev, B43_NPHY_BBCFG,\r\n~B43_NPHY_BBCFG_RSTRX & 0xFFFF);\r\nb43_nphy_reset_cca(dev);\r\n}\r\nb43_phy_write(dev, B43_NPHY_NDATAT_DUP40, 0x3830);\r\nif (phy->rev >= 3)\r\nb43_nphy_spur_workaround(dev);\r\n}\r\nstatic int b43_nphy_set_channel(struct b43_wldev *dev,\r\nstruct ieee80211_channel *channel,\r\nenum nl80211_channel_type channel_type)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nconst struct b43_nphy_channeltab_entry_rev2 *tabent_r2 = NULL;\r\nconst struct b43_nphy_channeltab_entry_rev3 *tabent_r3 = NULL;\r\nconst struct b43_nphy_chantabent_rev7 *tabent_r7 = NULL;\r\nconst struct b43_nphy_chantabent_rev7_2g *tabent_r7_2g = NULL;\r\nu8 tmp;\r\nif (phy->rev >= 19) {\r\nreturn -ESRCH;\r\n} else if (phy->rev >= 7) {\r\nr2057_get_chantabent_rev7(dev, channel->center_freq,\r\n&tabent_r7, &tabent_r7_2g);\r\nif (!tabent_r7 && !tabent_r7_2g)\r\nreturn -ESRCH;\r\n} else if (phy->rev >= 3) {\r\ntabent_r3 = b43_nphy_get_chantabent_rev3(dev,\r\nchannel->center_freq);\r\nif (!tabent_r3)\r\nreturn -ESRCH;\r\n} else {\r\ntabent_r2 = b43_nphy_get_chantabent_rev2(dev,\r\nchannel->hw_value);\r\nif (!tabent_r2)\r\nreturn -ESRCH;\r\n}\r\nphy->channel = channel->hw_value;\r\n#if 0\r\nif (b43_channel_type_is_40mhz(phy->channel_type) !=\r\nb43_channel_type_is_40mhz(channel_type))\r\n;\r\n#endif\r\nif (channel_type == NL80211_CHAN_HT40PLUS) {\r\nb43_phy_set(dev, B43_NPHY_RXCTL, B43_NPHY_RXCTL_BSELU20);\r\nif (phy->rev >= 7)\r\nb43_phy_set(dev, 0x310, 0x8000);\r\n} else if (channel_type == NL80211_CHAN_HT40MINUS) {\r\nb43_phy_mask(dev, B43_NPHY_RXCTL, ~B43_NPHY_RXCTL_BSELU20);\r\nif (phy->rev >= 7)\r\nb43_phy_mask(dev, 0x310, (u16)~0x8000);\r\n}\r\nif (phy->rev >= 19) {\r\n} else if (phy->rev >= 7) {\r\nconst struct b43_phy_n_sfo_cfg *phy_regs = tabent_r7 ?\r\n&(tabent_r7->phy_regs) : &(tabent_r7_2g->phy_regs);\r\nif (phy->radio_rev <= 4 || phy->radio_rev == 6) {\r\ntmp = (channel->band == NL80211_BAND_5GHZ) ? 2 : 0;\r\nb43_radio_maskset(dev, R2057_TIA_CONFIG_CORE0, ~2, tmp);\r\nb43_radio_maskset(dev, R2057_TIA_CONFIG_CORE1, ~2, tmp);\r\n}\r\nb43_radio_2057_setup(dev, tabent_r7, tabent_r7_2g);\r\nb43_nphy_channel_setup(dev, phy_regs, channel);\r\n} else if (phy->rev >= 3) {\r\ntmp = (channel->band == NL80211_BAND_5GHZ) ? 4 : 0;\r\nb43_radio_maskset(dev, 0x08, 0xFFFB, tmp);\r\nb43_radio_2056_setup(dev, tabent_r3);\r\nb43_nphy_channel_setup(dev, &(tabent_r3->phy_regs), channel);\r\n} else {\r\ntmp = (channel->band == NL80211_BAND_5GHZ) ? 0x0020 : 0x0050;\r\nb43_radio_maskset(dev, B2055_MASTER1, 0xFF8F, tmp);\r\nb43_radio_2055_setup(dev, tabent_r2);\r\nb43_nphy_channel_setup(dev, &(tabent_r2->phy_regs), channel);\r\n}\r\nreturn 0;\r\n}\r\nstatic int b43_nphy_op_allocate(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_n *nphy;\r\nnphy = kzalloc(sizeof(*nphy), GFP_KERNEL);\r\nif (!nphy)\r\nreturn -ENOMEM;\r\ndev->phy.n = nphy;\r\nreturn 0;\r\n}\r\nstatic void b43_nphy_op_prepare_structs(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_n *nphy = phy->n;\r\nstruct ssb_sprom *sprom = dev->dev->bus_sprom;\r\nmemset(nphy, 0, sizeof(*nphy));\r\nnphy->hang_avoid = (phy->rev == 3 || phy->rev == 4);\r\nnphy->spur_avoid = (phy->rev >= 3) ?\r\nB43_SPUR_AVOID_AUTO : B43_SPUR_AVOID_DISABLE;\r\nnphy->gain_boost = true;\r\nnphy->txrx_chain = 2;\r\nnphy->phyrxchain = 3;\r\nnphy->perical = 2;\r\nnphy->tx_pwr_idx[0] = 128;\r\nnphy->tx_pwr_idx[1] = 128;\r\nnphy->txpwrctrl = false;\r\nnphy->pwg_gain_5ghz = false;\r\nif (dev->phy.rev >= 3 ||\r\n(dev->dev->board_vendor == PCI_VENDOR_ID_APPLE &&\r\n(dev->dev->core_rev == 11 || dev->dev->core_rev == 12))) {\r\nnphy->txpwrctrl = true;\r\nnphy->pwg_gain_5ghz = true;\r\n} else if (sprom->revision >= 4) {\r\nif (dev->phy.rev >= 2 &&\r\n(sprom->boardflags2_lo & B43_BFL2_TXPWRCTRL_EN)) {\r\nnphy->txpwrctrl = true;\r\n#ifdef CONFIG_B43_SSB\r\nif (dev->dev->bus_type == B43_BUS_SSB &&\r\ndev->dev->sdev->bus->bustype == SSB_BUSTYPE_PCI) {\r\nstruct pci_dev *pdev =\r\ndev->dev->sdev->bus->host_pci;\r\nif (pdev->device == 0x4328 ||\r\npdev->device == 0x432a)\r\nnphy->pwg_gain_5ghz = true;\r\n}\r\n#endif\r\n} else if (sprom->boardflags2_lo & B43_BFL2_5G_PWRGAIN) {\r\nnphy->pwg_gain_5ghz = true;\r\n}\r\n}\r\nif (dev->phy.rev >= 3) {\r\nnphy->ipa2g_on = sprom->fem.ghz2.extpa_gain == 2;\r\nnphy->ipa5g_on = sprom->fem.ghz5.extpa_gain == 2;\r\n}\r\n}\r\nstatic void b43_nphy_op_free(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_n *nphy = phy->n;\r\nkfree(nphy);\r\nphy->n = NULL;\r\n}\r\nstatic int b43_nphy_op_init(struct b43_wldev *dev)\r\n{\r\nreturn b43_phy_initn(dev);\r\n}\r\nstatic inline void check_phyreg(struct b43_wldev *dev, u16 offset)\r\n{\r\n#if B43_DEBUG\r\nif ((offset & B43_PHYROUTE) == B43_PHYROUTE_OFDM_GPHY) {\r\nb43err(dev->wl, "Invalid OFDM PHY access at "\r\n"0x%04X on N-PHY\n", offset);\r\ndump_stack();\r\n}\r\nif ((offset & B43_PHYROUTE) == B43_PHYROUTE_EXT_GPHY) {\r\nb43err(dev->wl, "Invalid EXT-G PHY access at "\r\n"0x%04X on N-PHY\n", offset);\r\ndump_stack();\r\n}\r\n#endif\r\n}\r\nstatic void b43_nphy_op_maskset(struct b43_wldev *dev, u16 reg, u16 mask,\r\nu16 set)\r\n{\r\ncheck_phyreg(dev, reg);\r\nb43_write16f(dev, B43_MMIO_PHY_CONTROL, reg);\r\nb43_maskset16(dev, B43_MMIO_PHY_DATA, mask, set);\r\ndev->phy.writes_counter = 1;\r\n}\r\nstatic u16 b43_nphy_op_radio_read(struct b43_wldev *dev, u16 reg)\r\n{\r\nB43_WARN_ON(dev->phy.rev < 7 && reg == 1);\r\nif (dev->phy.rev >= 7)\r\nreg |= 0x200;\r\nelse\r\nreg |= 0x100;\r\nb43_write16f(dev, B43_MMIO_RADIO_CONTROL, reg);\r\nreturn b43_read16(dev, B43_MMIO_RADIO_DATA_LOW);\r\n}\r\nstatic void b43_nphy_op_radio_write(struct b43_wldev *dev, u16 reg, u16 value)\r\n{\r\nB43_WARN_ON(dev->phy.rev < 7 && reg == 1);\r\nb43_write16f(dev, B43_MMIO_RADIO_CONTROL, reg);\r\nb43_write16(dev, B43_MMIO_RADIO_DATA_LOW, value);\r\n}\r\nstatic void b43_nphy_op_software_rfkill(struct b43_wldev *dev,\r\nbool blocked)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nif (b43_read32(dev, B43_MMIO_MACCTL) & B43_MACCTL_ENABLED)\r\nb43err(dev->wl, "MAC not suspended\n");\r\nif (blocked) {\r\nif (phy->rev >= 19) {\r\n} else if (phy->rev >= 8) {\r\nb43_phy_mask(dev, B43_NPHY_RFCTL_CMD,\r\n~B43_NPHY_RFCTL_CMD_CHIP0PU);\r\n} else if (phy->rev >= 7) {\r\n} else if (phy->rev >= 3) {\r\nb43_phy_mask(dev, B43_NPHY_RFCTL_CMD,\r\n~B43_NPHY_RFCTL_CMD_CHIP0PU);\r\nb43_radio_mask(dev, 0x09, ~0x2);\r\nb43_radio_write(dev, 0x204D, 0);\r\nb43_radio_write(dev, 0x2053, 0);\r\nb43_radio_write(dev, 0x2058, 0);\r\nb43_radio_write(dev, 0x205E, 0);\r\nb43_radio_mask(dev, 0x2062, ~0xF0);\r\nb43_radio_write(dev, 0x2064, 0);\r\nb43_radio_write(dev, 0x304D, 0);\r\nb43_radio_write(dev, 0x3053, 0);\r\nb43_radio_write(dev, 0x3058, 0);\r\nb43_radio_write(dev, 0x305E, 0);\r\nb43_radio_mask(dev, 0x3062, ~0xF0);\r\nb43_radio_write(dev, 0x3064, 0);\r\n}\r\n} else {\r\nif (phy->rev >= 19) {\r\n} else if (phy->rev >= 7) {\r\nif (!dev->phy.radio_on)\r\nb43_radio_2057_init(dev);\r\nb43_switch_channel(dev, dev->phy.channel);\r\n} else if (phy->rev >= 3) {\r\nif (!dev->phy.radio_on)\r\nb43_radio_init2056(dev);\r\nb43_switch_channel(dev, dev->phy.channel);\r\n} else {\r\nb43_radio_init2055(dev);\r\n}\r\n}\r\n}\r\nstatic void b43_nphy_op_switch_analog(struct b43_wldev *dev, bool on)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nu16 override = on ? 0x0 : 0x7FFF;\r\nu16 core = on ? 0xD : 0x00FD;\r\nif (phy->rev >= 19) {\r\n} else if (phy->rev >= 3) {\r\nif (on) {\r\nb43_phy_write(dev, B43_NPHY_AFECTL_C1, core);\r\nb43_phy_write(dev, B43_NPHY_AFECTL_OVER1, override);\r\nb43_phy_write(dev, B43_NPHY_AFECTL_C2, core);\r\nb43_phy_write(dev, B43_NPHY_AFECTL_OVER, override);\r\n} else {\r\nb43_phy_write(dev, B43_NPHY_AFECTL_OVER1, override);\r\nb43_phy_write(dev, B43_NPHY_AFECTL_C1, core);\r\nb43_phy_write(dev, B43_NPHY_AFECTL_OVER, override);\r\nb43_phy_write(dev, B43_NPHY_AFECTL_C2, core);\r\n}\r\n} else {\r\nb43_phy_write(dev, B43_NPHY_AFECTL_OVER, override);\r\n}\r\n}\r\nstatic int b43_nphy_op_switch_channel(struct b43_wldev *dev,\r\nunsigned int new_channel)\r\n{\r\nstruct ieee80211_channel *channel = dev->wl->hw->conf.chandef.chan;\r\nenum nl80211_channel_type channel_type =\r\ncfg80211_get_chandef_type(&dev->wl->hw->conf.chandef);\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ) {\r\nif ((new_channel < 1) || (new_channel > 14))\r\nreturn -EINVAL;\r\n} else {\r\nif (new_channel > 200)\r\nreturn -EINVAL;\r\n}\r\nreturn b43_nphy_set_channel(dev, channel, channel_type);\r\n}\r\nstatic unsigned int b43_nphy_op_get_default_chan(struct b43_wldev *dev)\r\n{\r\nif (b43_current_band(dev->wl) == NL80211_BAND_2GHZ)\r\nreturn 1;\r\nreturn 36;\r\n}

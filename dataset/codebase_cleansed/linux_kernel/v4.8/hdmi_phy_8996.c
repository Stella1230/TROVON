static inline struct hdmi_phy *pll_get_phy(struct hdmi_pll_8996 *pll)\r\n{\r\nreturn platform_get_drvdata(pll->pdev);\r\n}\r\nstatic inline void hdmi_pll_write(struct hdmi_pll_8996 *pll, int offset,\r\nu32 data)\r\n{\r\nmsm_writel(data, pll->mmio_qserdes_com + offset);\r\n}\r\nstatic inline u32 hdmi_pll_read(struct hdmi_pll_8996 *pll, int offset)\r\n{\r\nreturn msm_readl(pll->mmio_qserdes_com + offset);\r\n}\r\nstatic inline void hdmi_tx_chan_write(struct hdmi_pll_8996 *pll, int channel,\r\nint offset, int data)\r\n{\r\nmsm_writel(data, pll->mmio_qserdes_tx[channel] + offset);\r\n}\r\nstatic inline u32 pll_get_cpctrl(u64 frac_start, unsigned long ref_clk,\r\nbool gen_ssc)\r\n{\r\nif ((frac_start != 0) || gen_ssc)\r\nreturn (11000000 / (ref_clk / 20));\r\nreturn 0x23;\r\n}\r\nstatic inline u32 pll_get_rctrl(u64 frac_start, bool gen_ssc)\r\n{\r\nif ((frac_start != 0) || gen_ssc)\r\nreturn 0x16;\r\nreturn 0x10;\r\n}\r\nstatic inline u32 pll_get_cctrl(u64 frac_start, bool gen_ssc)\r\n{\r\nif ((frac_start != 0) || gen_ssc)\r\nreturn 0x28;\r\nreturn 0x1;\r\n}\r\nstatic inline u32 pll_get_integloop_gain(u64 frac_start, u64 bclk, u32 ref_clk,\r\nbool gen_ssc)\r\n{\r\nint digclk_divsel = bclk >= HDMI_DIG_FREQ_BIT_CLK_THRESHOLD ? 1 : 2;\r\nu64 base;\r\nif ((frac_start != 0) || gen_ssc)\r\nbase = (64 * ref_clk) / HDMI_DEFAULT_REF_CLOCK;\r\nelse\r\nbase = (1022 * ref_clk) / 100;\r\nbase <<= digclk_divsel;\r\nreturn (base <= 2046 ? base : 2046);\r\n}\r\nstatic inline u32 pll_get_pll_cmp(u64 fdata, unsigned long ref_clk)\r\n{\r\nu64 dividend = HDMI_PLL_CMP_CNT * fdata;\r\nu32 divisor = ref_clk * 10;\r\nu32 rem;\r\nrem = do_div(dividend, divisor);\r\nif (rem > (divisor >> 1))\r\ndividend++;\r\nreturn dividend - 1;\r\n}\r\nstatic inline u64 pll_cmp_to_fdata(u32 pll_cmp, unsigned long ref_clk)\r\n{\r\nu64 fdata = ((u64)pll_cmp) * ref_clk * 10;\r\ndo_div(fdata, HDMI_PLL_CMP_CNT);\r\nreturn fdata;\r\n}\r\nstatic int pll_get_post_div(struct hdmi_8996_post_divider *pd, u64 bclk)\r\n{\r\nint ratio[] = { 2, 3, 4, 5, 6, 9, 10, 12, 14, 15, 20, 21, 25, 28, 35 };\r\nint hs_divsel[] = { 0, 4, 8, 12, 1, 5, 2, 9, 3, 13, 10, 7, 14, 11, 15 };\r\nint tx_band_sel[] = { 0, 1, 2, 3 };\r\nu64 vco_freq[60];\r\nu64 vco, vco_optimal;\r\nint half_rate_mode = 0;\r\nint vco_optimal_index, vco_freq_index;\r\nint i, j;\r\nretry:\r\nvco_optimal = HDMI_VCO_MAX_FREQ;\r\nvco_optimal_index = -1;\r\nvco_freq_index = 0;\r\nfor (i = 0; i < 15; i++) {\r\nfor (j = 0; j < 4; j++) {\r\nu32 ratio_mult = ratio[i] << tx_band_sel[j];\r\nvco = bclk >> half_rate_mode;\r\nvco *= ratio_mult;\r\nvco_freq[vco_freq_index++] = vco;\r\n}\r\n}\r\nfor (i = 0; i < 60; i++) {\r\nu64 vco_tmp = vco_freq[i];\r\nif ((vco_tmp >= HDMI_VCO_MIN_FREQ) &&\r\n(vco_tmp <= vco_optimal)) {\r\nvco_optimal = vco_tmp;\r\nvco_optimal_index = i;\r\n}\r\n}\r\nif (vco_optimal_index == -1) {\r\nif (!half_rate_mode) {\r\nhalf_rate_mode = 1;\r\ngoto retry;\r\n}\r\n} else {\r\npd->vco_freq = vco_optimal;\r\npd->tx_band_sel = tx_band_sel[vco_optimal_index % 4];\r\npd->vco_ratio = ratio[vco_optimal_index / 4];\r\npd->hsclk_divsel = hs_divsel[vco_optimal_index / 4];\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int pll_calculate(unsigned long pix_clk, unsigned long ref_clk,\r\nstruct hdmi_8996_phy_pll_reg_cfg *cfg)\r\n{\r\nstruct hdmi_8996_post_divider pd;\r\nu64 bclk;\r\nu64 tmds_clk;\r\nu64 dec_start;\r\nu64 frac_start;\r\nu64 fdata;\r\nu32 pll_divisor;\r\nu32 rem;\r\nu32 cpctrl;\r\nu32 rctrl;\r\nu32 cctrl;\r\nu32 integloop_gain;\r\nu32 pll_cmp;\r\nint i, ret;\r\nbclk = ((u64)pix_clk) * 10;\r\nif (bclk > HDMI_HIGH_FREQ_BIT_CLK_THRESHOLD)\r\ntmds_clk = pix_clk >> 2;\r\nelse\r\ntmds_clk = pix_clk;\r\nret = pll_get_post_div(&pd, bclk);\r\nif (ret)\r\nreturn ret;\r\ndec_start = pd.vco_freq;\r\npll_divisor = 4 * ref_clk;\r\ndo_div(dec_start, pll_divisor);\r\nfrac_start = pd.vco_freq * (1 << 20);\r\nrem = do_div(frac_start, pll_divisor);\r\nfrac_start -= dec_start * (1 << 20);\r\nif (rem > (pll_divisor >> 1))\r\nfrac_start++;\r\ncpctrl = pll_get_cpctrl(frac_start, ref_clk, false);\r\nrctrl = pll_get_rctrl(frac_start, false);\r\ncctrl = pll_get_cctrl(frac_start, false);\r\nintegloop_gain = pll_get_integloop_gain(frac_start, bclk,\r\nref_clk, false);\r\nfdata = pd.vco_freq;\r\ndo_div(fdata, pd.vco_ratio);\r\npll_cmp = pll_get_pll_cmp(fdata, ref_clk);\r\nDBG("VCO freq: %llu", pd.vco_freq);\r\nDBG("fdata: %llu", fdata);\r\nDBG("pix_clk: %lu", pix_clk);\r\nDBG("tmds clk: %llu", tmds_clk);\r\nDBG("HSCLK_SEL: %d", pd.hsclk_divsel);\r\nDBG("DEC_START: %llu", dec_start);\r\nDBG("DIV_FRAC_START: %llu", frac_start);\r\nDBG("PLL_CPCTRL: %u", cpctrl);\r\nDBG("PLL_RCTRL: %u", rctrl);\r\nDBG("PLL_CCTRL: %u", cctrl);\r\nDBG("INTEGLOOP_GAIN: %u", integloop_gain);\r\nDBG("TX_BAND: %d", pd.tx_band_sel);\r\nDBG("PLL_CMP: %u", pll_cmp);\r\nif (bclk > HDMI_DIG_FREQ_BIT_CLK_THRESHOLD)\r\ncfg->com_svs_mode_clk_sel = 1;\r\nelse\r\ncfg->com_svs_mode_clk_sel = 2;\r\ncfg->com_hsclk_sel = (0x20 | pd.hsclk_divsel);\r\ncfg->com_pll_cctrl_mode0 = cctrl;\r\ncfg->com_pll_rctrl_mode0 = rctrl;\r\ncfg->com_cp_ctrl_mode0 = cpctrl;\r\ncfg->com_dec_start_mode0 = dec_start;\r\ncfg->com_div_frac_start1_mode0 = (frac_start & 0xff);\r\ncfg->com_div_frac_start2_mode0 = ((frac_start & 0xff00) >> 8);\r\ncfg->com_div_frac_start3_mode0 = ((frac_start & 0xf0000) >> 16);\r\ncfg->com_integloop_gain0_mode0 = (integloop_gain & 0xff);\r\ncfg->com_integloop_gain1_mode0 = ((integloop_gain & 0xf00) >> 8);\r\ncfg->com_lock_cmp1_mode0 = (pll_cmp & 0xff);\r\ncfg->com_lock_cmp2_mode0 = ((pll_cmp & 0xff00) >> 8);\r\ncfg->com_lock_cmp3_mode0 = ((pll_cmp & 0x30000) >> 16);\r\ncfg->com_lock_cmp_en = 0x0;\r\ncfg->com_core_clk_en = 0x2c;\r\ncfg->com_coreclk_div = HDMI_CORECLK_DIV;\r\ncfg->phy_mode = (bclk > HDMI_HIGH_FREQ_BIT_CLK_THRESHOLD) ? 0x10 : 0x0;\r\ncfg->com_vco_tune_ctrl = 0x0;\r\ncfg->tx_lx_lane_mode[0] =\r\ncfg->tx_lx_lane_mode[2] = 0x43;\r\ncfg->tx_lx_hp_pd_enables[0] =\r\ncfg->tx_lx_hp_pd_enables[1] =\r\ncfg->tx_lx_hp_pd_enables[2] = 0x0c;\r\ncfg->tx_lx_hp_pd_enables[3] = 0x3;\r\nfor (i = 0; i < HDMI_NUM_TX_CHANNEL; i++)\r\ncfg->tx_lx_tx_band[i] = pd.tx_band_sel + 4;\r\nif (bclk > HDMI_HIGH_FREQ_BIT_CLK_THRESHOLD) {\r\ncfg->tx_lx_tx_drv_lvl[0] =\r\ncfg->tx_lx_tx_drv_lvl[1] =\r\ncfg->tx_lx_tx_drv_lvl[2] = 0x25;\r\ncfg->tx_lx_tx_drv_lvl[3] = 0x22;\r\ncfg->tx_lx_tx_emp_post1_lvl[0] =\r\ncfg->tx_lx_tx_emp_post1_lvl[1] =\r\ncfg->tx_lx_tx_emp_post1_lvl[2] = 0x23;\r\ncfg->tx_lx_tx_emp_post1_lvl[3] = 0x27;\r\ncfg->tx_lx_vmode_ctrl1[0] =\r\ncfg->tx_lx_vmode_ctrl1[1] =\r\ncfg->tx_lx_vmode_ctrl1[2] =\r\ncfg->tx_lx_vmode_ctrl1[3] = 0x00;\r\ncfg->tx_lx_vmode_ctrl2[0] =\r\ncfg->tx_lx_vmode_ctrl2[1] =\r\ncfg->tx_lx_vmode_ctrl2[2] = 0x0D;\r\ncfg->tx_lx_vmode_ctrl2[3] = 0x00;\r\n} else if (bclk > HDMI_MID_FREQ_BIT_CLK_THRESHOLD) {\r\nfor (i = 0; i < HDMI_NUM_TX_CHANNEL; i++) {\r\ncfg->tx_lx_tx_drv_lvl[i] = 0x25;\r\ncfg->tx_lx_tx_emp_post1_lvl[i] = 0x23;\r\ncfg->tx_lx_vmode_ctrl1[i] = 0x00;\r\n}\r\ncfg->tx_lx_vmode_ctrl2[0] =\r\ncfg->tx_lx_vmode_ctrl2[1] =\r\ncfg->tx_lx_vmode_ctrl2[2] = 0x0D;\r\ncfg->tx_lx_vmode_ctrl2[3] = 0x00;\r\n} else {\r\nfor (i = 0; i < HDMI_NUM_TX_CHANNEL; i++) {\r\ncfg->tx_lx_tx_drv_lvl[i] = 0x20;\r\ncfg->tx_lx_tx_emp_post1_lvl[i] = 0x20;\r\ncfg->tx_lx_vmode_ctrl1[i] = 0x00;\r\ncfg->tx_lx_vmode_ctrl2[i] = 0x0E;\r\n}\r\n}\r\nDBG("com_svs_mode_clk_sel = 0x%x", cfg->com_svs_mode_clk_sel);\r\nDBG("com_hsclk_sel = 0x%x", cfg->com_hsclk_sel);\r\nDBG("com_lock_cmp_en = 0x%x", cfg->com_lock_cmp_en);\r\nDBG("com_pll_cctrl_mode0 = 0x%x", cfg->com_pll_cctrl_mode0);\r\nDBG("com_pll_rctrl_mode0 = 0x%x", cfg->com_pll_rctrl_mode0);\r\nDBG("com_cp_ctrl_mode0 = 0x%x", cfg->com_cp_ctrl_mode0);\r\nDBG("com_dec_start_mode0 = 0x%x", cfg->com_dec_start_mode0);\r\nDBG("com_div_frac_start1_mode0 = 0x%x", cfg->com_div_frac_start1_mode0);\r\nDBG("com_div_frac_start2_mode0 = 0x%x", cfg->com_div_frac_start2_mode0);\r\nDBG("com_div_frac_start3_mode0 = 0x%x", cfg->com_div_frac_start3_mode0);\r\nDBG("com_integloop_gain0_mode0 = 0x%x", cfg->com_integloop_gain0_mode0);\r\nDBG("com_integloop_gain1_mode0 = 0x%x", cfg->com_integloop_gain1_mode0);\r\nDBG("com_lock_cmp1_mode0 = 0x%x", cfg->com_lock_cmp1_mode0);\r\nDBG("com_lock_cmp2_mode0 = 0x%x", cfg->com_lock_cmp2_mode0);\r\nDBG("com_lock_cmp3_mode0 = 0x%x", cfg->com_lock_cmp3_mode0);\r\nDBG("com_core_clk_en = 0x%x", cfg->com_core_clk_en);\r\nDBG("com_coreclk_div = 0x%x", cfg->com_coreclk_div);\r\nDBG("phy_mode = 0x%x", cfg->phy_mode);\r\nDBG("tx_l0_lane_mode = 0x%x", cfg->tx_lx_lane_mode[0]);\r\nDBG("tx_l2_lane_mode = 0x%x", cfg->tx_lx_lane_mode[2]);\r\nfor (i = 0; i < HDMI_NUM_TX_CHANNEL; i++) {\r\nDBG("tx_l%d_tx_band = 0x%x", i, cfg->tx_lx_tx_band[i]);\r\nDBG("tx_l%d_tx_drv_lvl = 0x%x", i, cfg->tx_lx_tx_drv_lvl[i]);\r\nDBG("tx_l%d_tx_emp_post1_lvl = 0x%x", i,\r\ncfg->tx_lx_tx_emp_post1_lvl[i]);\r\nDBG("tx_l%d_vmode_ctrl1 = 0x%x", i, cfg->tx_lx_vmode_ctrl1[i]);\r\nDBG("tx_l%d_vmode_ctrl2 = 0x%x", i, cfg->tx_lx_vmode_ctrl2[i]);\r\n}\r\nreturn 0;\r\n}\r\nstatic int hdmi_8996_pll_set_clk_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nstruct hdmi_pll_8996 *pll = hw_clk_to_pll(hw);\r\nstruct hdmi_phy *phy = pll_get_phy(pll);\r\nstruct hdmi_8996_phy_pll_reg_cfg cfg;\r\nint i, ret;\r\nmemset(&cfg, 0x00, sizeof(cfg));\r\nret = pll_calculate(rate, parent_rate, &cfg);\r\nif (ret) {\r\nDRM_ERROR("PLL calculation failed\n");\r\nreturn ret;\r\n}\r\nDBG("Disabling PHY");\r\nhdmi_phy_write(phy, REG_HDMI_8996_PHY_PD_CTL, 0x0);\r\nudelay(500);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_BG_CTRL, 0x04);\r\nhdmi_phy_write(phy, REG_HDMI_8996_PHY_PD_CTL, 0x1);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_RESETSM_CNTRL, 0x20);\r\nhdmi_phy_write(phy, REG_HDMI_8996_PHY_TX0_TX1_LANE_CTL, 0x0F);\r\nhdmi_phy_write(phy, REG_HDMI_8996_PHY_TX2_TX3_LANE_CTL, 0x0F);\r\nfor (i = 0; i < HDMI_NUM_TX_CHANNEL; i++) {\r\nhdmi_tx_chan_write(pll, i,\r\nREG_HDMI_PHY_QSERDES_TX_LX_CLKBUF_ENABLE,\r\n0x03);\r\nhdmi_tx_chan_write(pll, i,\r\nREG_HDMI_PHY_QSERDES_TX_LX_TX_BAND,\r\ncfg.tx_lx_tx_band[i]);\r\nhdmi_tx_chan_write(pll, i,\r\nREG_HDMI_PHY_QSERDES_TX_LX_RESET_TSYNC_EN,\r\n0x03);\r\n}\r\nhdmi_tx_chan_write(pll, 0, REG_HDMI_PHY_QSERDES_TX_LX_LANE_MODE,\r\ncfg.tx_lx_lane_mode[0]);\r\nhdmi_tx_chan_write(pll, 2, REG_HDMI_PHY_QSERDES_TX_LX_LANE_MODE,\r\ncfg.tx_lx_lane_mode[2]);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_SYSCLK_BUF_ENABLE, 0x1E);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_BIAS_EN_CLKBUFLR_EN, 0x07);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_SYSCLK_EN_SEL, 0x37);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_SYS_CLK_CTRL, 0x02);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_CLK_ENABLE1, 0x0E);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_SVS_MODE_CLK_SEL,\r\ncfg.com_svs_mode_clk_sel);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_BG_TRIM, 0x0F);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_PLL_IVCO, 0x0F);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_VCO_TUNE_CTRL,\r\ncfg.com_vco_tune_ctrl);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_BG_CTRL, 0x06);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_CLK_SELECT, 0x30);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_HSCLK_SEL,\r\ncfg.com_hsclk_sel);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_LOCK_CMP_EN,\r\ncfg.com_lock_cmp_en);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_PLL_CCTRL_MODE0,\r\ncfg.com_pll_cctrl_mode0);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_PLL_RCTRL_MODE0,\r\ncfg.com_pll_rctrl_mode0);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_CP_CTRL_MODE0,\r\ncfg.com_cp_ctrl_mode0);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_DEC_START_MODE0,\r\ncfg.com_dec_start_mode0);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_DIV_FRAC_START1_MODE0,\r\ncfg.com_div_frac_start1_mode0);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_DIV_FRAC_START2_MODE0,\r\ncfg.com_div_frac_start2_mode0);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_DIV_FRAC_START3_MODE0,\r\ncfg.com_div_frac_start3_mode0);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_INTEGLOOP_GAIN0_MODE0,\r\ncfg.com_integloop_gain0_mode0);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_INTEGLOOP_GAIN1_MODE0,\r\ncfg.com_integloop_gain1_mode0);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_LOCK_CMP1_MODE0,\r\ncfg.com_lock_cmp1_mode0);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_LOCK_CMP2_MODE0,\r\ncfg.com_lock_cmp2_mode0);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_LOCK_CMP3_MODE0,\r\ncfg.com_lock_cmp3_mode0);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_VCO_TUNE_MAP, 0x00);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_CORE_CLK_EN,\r\ncfg.com_core_clk_en);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_CORECLK_DIV,\r\ncfg.com_coreclk_div);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_CMN_CONFIG, 0x02);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_RESCODE_DIV_NUM, 0x15);\r\nfor (i = 0; i < HDMI_NUM_TX_CHANNEL; i++) {\r\nhdmi_tx_chan_write(pll, i,\r\nREG_HDMI_PHY_QSERDES_TX_LX_TX_DRV_LVL,\r\ncfg.tx_lx_tx_drv_lvl[i]);\r\nhdmi_tx_chan_write(pll, i,\r\nREG_HDMI_PHY_QSERDES_TX_LX_TX_EMP_POST1_LVL,\r\ncfg.tx_lx_tx_emp_post1_lvl[i]);\r\nhdmi_tx_chan_write(pll, i,\r\nREG_HDMI_PHY_QSERDES_TX_LX_VMODE_CTRL1,\r\ncfg.tx_lx_vmode_ctrl1[i]);\r\nhdmi_tx_chan_write(pll, i,\r\nREG_HDMI_PHY_QSERDES_TX_LX_VMODE_CTRL2,\r\ncfg.tx_lx_vmode_ctrl2[i]);\r\nhdmi_tx_chan_write(pll, i,\r\nREG_HDMI_PHY_QSERDES_TX_LX_TX_DRV_LVL_OFFSET,\r\n0x00);\r\nhdmi_tx_chan_write(pll, i,\r\nREG_HDMI_PHY_QSERDES_TX_LX_RES_CODE_LANE_OFFSET,\r\n0x00);\r\nhdmi_tx_chan_write(pll, i,\r\nREG_HDMI_PHY_QSERDES_TX_LX_TRAN_DRVR_EMP_EN,\r\n0x03);\r\nhdmi_tx_chan_write(pll, i,\r\nREG_HDMI_PHY_QSERDES_TX_LX_PARRATE_REC_DETECT_IDLE_EN,\r\n0x40);\r\nhdmi_tx_chan_write(pll, i,\r\nREG_HDMI_PHY_QSERDES_TX_LX_HP_PD_ENABLES,\r\ncfg.tx_lx_hp_pd_enables[i]);\r\n}\r\nhdmi_phy_write(phy, REG_HDMI_8996_PHY_MODE, cfg.phy_mode);\r\nhdmi_phy_write(phy, REG_HDMI_8996_PHY_PD_CTL, 0x1F);\r\nwmb();\r\nreturn 0;\r\n}\r\nstatic int hdmi_8996_phy_ready_status(struct hdmi_phy *phy)\r\n{\r\nu32 nb_tries = HDMI_PLL_POLL_MAX_READS;\r\nunsigned long timeout = HDMI_PLL_POLL_TIMEOUT_US;\r\nu32 status;\r\nint phy_ready = 0;\r\nDBG("Waiting for PHY ready");\r\nwhile (nb_tries--) {\r\nstatus = hdmi_phy_read(phy, REG_HDMI_8996_PHY_STATUS);\r\nphy_ready = status & BIT(0);\r\nif (phy_ready)\r\nbreak;\r\nudelay(timeout);\r\n}\r\nDBG("PHY is %sready", phy_ready ? "" : "*not* ");\r\nreturn phy_ready;\r\n}\r\nstatic int hdmi_8996_pll_lock_status(struct hdmi_pll_8996 *pll)\r\n{\r\nu32 status;\r\nint nb_tries = HDMI_PLL_POLL_MAX_READS;\r\nunsigned long timeout = HDMI_PLL_POLL_TIMEOUT_US;\r\nint pll_locked = 0;\r\nDBG("Waiting for PLL lock");\r\nwhile (nb_tries--) {\r\nstatus = hdmi_pll_read(pll,\r\nREG_HDMI_PHY_QSERDES_COM_C_READY_STATUS);\r\npll_locked = status & BIT(0);\r\nif (pll_locked)\r\nbreak;\r\nudelay(timeout);\r\n}\r\nDBG("HDMI PLL is %slocked", pll_locked ? "" : "*not* ");\r\nreturn pll_locked;\r\n}\r\nstatic int hdmi_8996_pll_prepare(struct clk_hw *hw)\r\n{\r\nstruct hdmi_pll_8996 *pll = hw_clk_to_pll(hw);\r\nstruct hdmi_phy *phy = pll_get_phy(pll);\r\nint i, ret = 0;\r\nhdmi_phy_write(phy, REG_HDMI_8996_PHY_CFG, 0x1);\r\nudelay(100);\r\nhdmi_phy_write(phy, REG_HDMI_8996_PHY_CFG, 0x19);\r\nudelay(100);\r\nret = hdmi_8996_pll_lock_status(pll);\r\nif (!ret)\r\nreturn ret;\r\nfor (i = 0; i < HDMI_NUM_TX_CHANNEL; i++)\r\nhdmi_tx_chan_write(pll, i,\r\nREG_HDMI_PHY_QSERDES_TX_LX_HIGHZ_TRANSCEIVEREN_BIAS_DRVR_EN,\r\n0x6F);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_SSC_PER1, 0x0);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_SSC_PER2, 0x0);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_SSC_STEP_SIZE1, 0x0);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_SSC_STEP_SIZE2, 0x0);\r\nhdmi_pll_write(pll, REG_HDMI_PHY_QSERDES_COM_SSC_EN_CENTER, 0x2);\r\nret = hdmi_8996_phy_ready_status(phy);\r\nif (!ret)\r\nreturn ret;\r\nhdmi_phy_write(phy, REG_HDMI_8996_PHY_CFG, 0x18);\r\nudelay(1);\r\nhdmi_phy_write(phy, REG_HDMI_8996_PHY_CFG, 0x19);\r\nreturn 0;\r\n}\r\nstatic long hdmi_8996_pll_round_rate(struct clk_hw *hw,\r\nunsigned long rate,\r\nunsigned long *parent_rate)\r\n{\r\nif (rate < HDMI_PCLK_MIN_FREQ)\r\nreturn HDMI_PCLK_MIN_FREQ;\r\nelse if (rate > HDMI_PCLK_MAX_FREQ)\r\nreturn HDMI_PCLK_MAX_FREQ;\r\nelse\r\nreturn rate;\r\n}\r\nstatic unsigned long hdmi_8996_pll_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct hdmi_pll_8996 *pll = hw_clk_to_pll(hw);\r\nu64 fdata;\r\nu32 cmp1, cmp2, cmp3, pll_cmp;\r\ncmp1 = hdmi_pll_read(pll, REG_HDMI_PHY_QSERDES_COM_LOCK_CMP1_MODE0);\r\ncmp2 = hdmi_pll_read(pll, REG_HDMI_PHY_QSERDES_COM_LOCK_CMP2_MODE0);\r\ncmp3 = hdmi_pll_read(pll, REG_HDMI_PHY_QSERDES_COM_LOCK_CMP3_MODE0);\r\npll_cmp = cmp1 | (cmp2 << 8) | (cmp3 << 16);\r\nfdata = pll_cmp_to_fdata(pll_cmp + 1, parent_rate);\r\ndo_div(fdata, 10);\r\nreturn fdata;\r\n}\r\nstatic void hdmi_8996_pll_unprepare(struct clk_hw *hw)\r\n{\r\n}\r\nstatic int hdmi_8996_pll_is_enabled(struct clk_hw *hw)\r\n{\r\nstruct hdmi_pll_8996 *pll = hw_clk_to_pll(hw);\r\nu32 status;\r\nint pll_locked;\r\nstatus = hdmi_pll_read(pll, REG_HDMI_PHY_QSERDES_COM_C_READY_STATUS);\r\npll_locked = status & BIT(0);\r\nreturn pll_locked;\r\n}\r\nint msm_hdmi_pll_8996_init(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct hdmi_pll_8996 *pll;\r\nstruct clk *clk;\r\nint i;\r\npll = devm_kzalloc(dev, sizeof(*pll), GFP_KERNEL);\r\nif (!pll)\r\nreturn -ENOMEM;\r\npll->pdev = pdev;\r\npll->mmio_qserdes_com = msm_ioremap(pdev, "hdmi_pll", "HDMI_PLL");\r\nif (IS_ERR(pll->mmio_qserdes_com)) {\r\ndev_err(dev, "failed to map pll base\n");\r\nreturn -ENOMEM;\r\n}\r\nfor (i = 0; i < HDMI_NUM_TX_CHANNEL; i++) {\r\nchar name[32], label[32];\r\nsnprintf(name, sizeof(name), "hdmi_tx_l%d", i);\r\nsnprintf(label, sizeof(label), "HDMI_TX_L%d", i);\r\npll->mmio_qserdes_tx[i] = msm_ioremap(pdev, name, label);\r\nif (IS_ERR(pll->mmio_qserdes_tx[i])) {\r\ndev_err(dev, "failed to map pll base\n");\r\nreturn -ENOMEM;\r\n}\r\n}\r\npll->clk_hw.init = &pll_init;\r\nclk = devm_clk_register(dev, &pll->clk_hw);\r\nif (IS_ERR(clk)) {\r\ndev_err(dev, "failed to register pll clock\n");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}

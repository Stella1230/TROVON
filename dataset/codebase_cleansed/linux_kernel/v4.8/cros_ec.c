int cros_ec_register(struct cros_ec_device *ec_dev)\r\n{\r\nstruct device *dev = ec_dev->dev;\r\nint err = 0;\r\nec_dev->max_request = sizeof(struct ec_params_hello);\r\nec_dev->max_response = sizeof(struct ec_response_get_protocol_info);\r\nec_dev->max_passthru = 0;\r\nec_dev->din = devm_kzalloc(dev, ec_dev->din_size, GFP_KERNEL);\r\nif (!ec_dev->din)\r\nreturn -ENOMEM;\r\nec_dev->dout = devm_kzalloc(dev, ec_dev->dout_size, GFP_KERNEL);\r\nif (!ec_dev->dout)\r\nreturn -ENOMEM;\r\nmutex_init(&ec_dev->lock);\r\ncros_ec_query_all(ec_dev);\r\nerr = mfd_add_devices(ec_dev->dev, PLATFORM_DEVID_AUTO, &ec_cell, 1,\r\nNULL, ec_dev->irq, NULL);\r\nif (err) {\r\ndev_err(dev,\r\n"Failed to register Embedded Controller subdevice %d\n",\r\nerr);\r\nreturn err;\r\n}\r\nif (ec_dev->max_passthru) {\r\nerr = mfd_add_devices(ec_dev->dev, PLATFORM_DEVID_AUTO,\r\n&ec_pd_cell, 1, NULL, ec_dev->irq, NULL);\r\nif (err) {\r\ndev_err(dev,\r\n"Failed to register Power Delivery subdevice %d\n",\r\nerr);\r\nreturn err;\r\n}\r\n}\r\nif (IS_ENABLED(CONFIG_OF) && dev->of_node) {\r\nerr = of_platform_populate(dev->of_node, NULL, NULL, dev);\r\nif (err) {\r\nmfd_remove_devices(dev);\r\ndev_err(dev, "Failed to register sub-devices\n");\r\nreturn err;\r\n}\r\n}\r\ndev_info(dev, "Chrome EC device registered\n");\r\nreturn 0;\r\n}\r\nint cros_ec_remove(struct cros_ec_device *ec_dev)\r\n{\r\nmfd_remove_devices(ec_dev->dev);\r\nreturn 0;\r\n}\r\nint cros_ec_suspend(struct cros_ec_device *ec_dev)\r\n{\r\nstruct device *dev = ec_dev->dev;\r\nif (device_may_wakeup(dev))\r\nec_dev->wake_enabled = !enable_irq_wake(ec_dev->irq);\r\ndisable_irq(ec_dev->irq);\r\nec_dev->was_wake_device = ec_dev->wake_enabled;\r\nreturn 0;\r\n}\r\nint cros_ec_resume(struct cros_ec_device *ec_dev)\r\n{\r\nenable_irq(ec_dev->irq);\r\nif (ec_dev->wake_enabled) {\r\ndisable_irq_wake(ec_dev->irq);\r\nec_dev->wake_enabled = 0;\r\n}\r\nreturn 0;\r\n}

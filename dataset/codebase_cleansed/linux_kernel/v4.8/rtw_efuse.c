static void Efuse_PowerSwitch(struct rtw_adapter *padapter,\r\nu8 bWrite, u8 PwrState)\r\n{\r\nu8 tempval;\r\nu16 tmpV16;\r\nif (PwrState == true) {\r\nrtl8723au_write8(padapter, REG_EFUSE_ACCESS, EFUSE_ACCESS_ON);\r\ntmpV16 = rtl8723au_read16(padapter, REG_SYS_ISO_CTRL);\r\nif (!(tmpV16 & PWC_EV12V)) {\r\ntmpV16 |= PWC_EV12V;\r\nrtl8723au_write16(padapter, REG_SYS_ISO_CTRL, tmpV16);\r\n}\r\ntmpV16 = rtl8723au_read16(padapter, REG_SYS_FUNC_EN);\r\nif (!(tmpV16 & FEN_ELDR)) {\r\ntmpV16 |= FEN_ELDR;\r\nrtl8723au_write16(padapter, REG_SYS_FUNC_EN, tmpV16);\r\n}\r\ntmpV16 = rtl8723au_read16(padapter, REG_SYS_CLKR);\r\nif ((!(tmpV16 & LOADER_CLK_EN)) || (!(tmpV16 & ANA8M))) {\r\ntmpV16 |= (LOADER_CLK_EN | ANA8M);\r\nrtl8723au_write16(padapter, REG_SYS_CLKR, tmpV16);\r\n}\r\nif (bWrite == true) {\r\ntempval = rtl8723au_read8(padapter, EFUSE_TEST + 3);\r\ntempval &= 0x0F;\r\ntempval |= (VOLTAGE_V25 << 4);\r\nrtl8723au_write8(padapter, EFUSE_TEST + 3,\r\ntempval | 0x80);\r\n}\r\n} else {\r\nrtl8723au_write8(padapter, REG_EFUSE_ACCESS, EFUSE_ACCESS_OFF);\r\nif (bWrite == true) {\r\ntempval = rtl8723au_read8(padapter, EFUSE_TEST + 3);\r\nrtl8723au_write8(padapter, EFUSE_TEST + 3,\r\ntempval & 0x7F);\r\n}\r\n}\r\n}\r\nu16 Efuse_GetCurrentSize23a(struct rtw_adapter *pAdapter, u8 efuseType)\r\n{\r\nu16 ret = 0;\r\nif (efuseType == EFUSE_WIFI)\r\nret = rtl8723a_EfuseGetCurrentSize_WiFi(pAdapter);\r\nelse\r\nret = rtl8723a_EfuseGetCurrentSize_BT(pAdapter);\r\nreturn ret;\r\n}\r\nu8 Efuse_CalculateWordCnts23a(u8 word_en)\r\n{\r\nreturn hweight8((~word_en) & 0xf);\r\n}\r\nvoid ReadEFuseByte23a(struct rtw_adapter *Adapter, u16 _offset, u8 *pbuf)\r\n{\r\nu32 value32;\r\nu8 readbyte;\r\nu16 retry;\r\nrtl8723au_write8(Adapter, EFUSE_CTRL+1, (_offset & 0xff));\r\nreadbyte = rtl8723au_read8(Adapter, EFUSE_CTRL+2);\r\nrtl8723au_write8(Adapter, EFUSE_CTRL+2,\r\n((_offset >> 8) & 0x03) | (readbyte & 0xfc));\r\nreadbyte = rtl8723au_read8(Adapter, EFUSE_CTRL+3);\r\nrtl8723au_write8(Adapter, EFUSE_CTRL+3, readbyte & 0x7f);\r\nretry = 0;\r\nvalue32 = rtl8723au_read32(Adapter, EFUSE_CTRL);\r\nwhile (!((value32 >> 24) & 0x80) && retry < 10000) {\r\nvalue32 = rtl8723au_read32(Adapter, EFUSE_CTRL);\r\nretry++;\r\n}\r\nudelay(50);\r\nvalue32 = rtl8723au_read32(Adapter, EFUSE_CTRL);\r\n*pbuf = (u8)(value32 & 0xff);\r\n}\r\nvoid EFUSE_GetEfuseDefinition23a(struct rtw_adapter *pAdapter, u8 efuseType,\r\nu8 type, void *pOut)\r\n{\r\nu8 *pu1Tmp;\r\nu16 *pu2Tmp;\r\nu8 *pMax_section;\r\nswitch (type) {\r\ncase TYPE_EFUSE_MAX_SECTION:\r\npMax_section = pOut;\r\nif (efuseType == EFUSE_WIFI)\r\n*pMax_section = EFUSE_MAX_SECTION_8723A;\r\nelse\r\n*pMax_section = EFUSE_BT_MAX_SECTION;\r\nbreak;\r\ncase TYPE_EFUSE_REAL_CONTENT_LEN:\r\npu2Tmp = pOut;\r\nif (efuseType == EFUSE_WIFI)\r\n*pu2Tmp = EFUSE_REAL_CONTENT_LEN_8723A;\r\nelse\r\n*pu2Tmp = EFUSE_BT_REAL_CONTENT_LEN;\r\nbreak;\r\ncase TYPE_AVAILABLE_EFUSE_BYTES_BANK:\r\npu2Tmp = pOut;\r\nif (efuseType == EFUSE_WIFI)\r\n*pu2Tmp = (EFUSE_REAL_CONTENT_LEN_8723A -\r\nEFUSE_OOB_PROTECT_BYTES);\r\nelse\r\n*pu2Tmp = (EFUSE_BT_REAL_BANK_CONTENT_LEN -\r\nEFUSE_PROTECT_BYTES_BANK);\r\nbreak;\r\ncase TYPE_AVAILABLE_EFUSE_BYTES_TOTAL:\r\npu2Tmp = pOut;\r\nif (efuseType == EFUSE_WIFI)\r\n*pu2Tmp = (EFUSE_REAL_CONTENT_LEN_8723A -\r\nEFUSE_OOB_PROTECT_BYTES);\r\nelse\r\n*pu2Tmp = (EFUSE_BT_REAL_CONTENT_LEN -\r\n(EFUSE_PROTECT_BYTES_BANK * 3));\r\nbreak;\r\ncase TYPE_EFUSE_MAP_LEN:\r\npu2Tmp = pOut;\r\nif (efuseType == EFUSE_WIFI)\r\n*pu2Tmp = EFUSE_MAP_LEN_8723A;\r\nelse\r\n*pu2Tmp = EFUSE_BT_MAP_LEN;\r\nbreak;\r\ncase TYPE_EFUSE_PROTECT_BYTES_BANK:\r\npu1Tmp = pOut;\r\nif (efuseType == EFUSE_WIFI)\r\n*pu1Tmp = EFUSE_OOB_PROTECT_BYTES;\r\nelse\r\n*pu1Tmp = EFUSE_PROTECT_BYTES_BANK;\r\nbreak;\r\ncase TYPE_EFUSE_CONTENT_LEN_BANK:\r\npu2Tmp = pOut;\r\nif (efuseType == EFUSE_WIFI)\r\n*pu2Tmp = EFUSE_REAL_CONTENT_LEN_8723A;\r\nelse\r\n*pu2Tmp = EFUSE_BT_REAL_BANK_CONTENT_LEN;\r\nbreak;\r\ndefault:\r\npu1Tmp = pOut;\r\n*pu1Tmp = 0;\r\nbreak;\r\n}\r\n}\r\nu8 EFUSE_Read1Byte23a(struct rtw_adapter *Adapter, u16 Address)\r\n{\r\nu8 data;\r\nu8 Bytetemp = {0x00};\r\nu8 temp = {0x00};\r\nu32 k = 0;\r\nu16 contentLen = 0;\r\nEFUSE_GetEfuseDefinition23a(Adapter, EFUSE_WIFI,\r\nTYPE_EFUSE_REAL_CONTENT_LEN,\r\n(void *)&contentLen);\r\nif (Address < contentLen) {\r\ntemp = Address & 0xFF;\r\nrtl8723au_write8(Adapter, EFUSE_CTRL+1, temp);\r\nBytetemp = rtl8723au_read8(Adapter, EFUSE_CTRL+2);\r\ntemp = ((Address >> 8) & 0x03) | (Bytetemp & 0xFC);\r\nrtl8723au_write8(Adapter, EFUSE_CTRL+2, temp);\r\nBytetemp = rtl8723au_read8(Adapter, EFUSE_CTRL+3);\r\ntemp = Bytetemp & 0x7F;\r\nrtl8723au_write8(Adapter, EFUSE_CTRL+3, temp);\r\nBytetemp = rtl8723au_read8(Adapter, EFUSE_CTRL+3);\r\nwhile (!(Bytetemp & 0x80)) {\r\nBytetemp = rtl8723au_read8(Adapter, EFUSE_CTRL+3);\r\nk++;\r\nif (k == 1000) {\r\nk = 0;\r\nbreak;\r\n}\r\n}\r\ndata = rtl8723au_read8(Adapter, EFUSE_CTRL);\r\nreturn data;\r\n}\r\nreturn 0xFF;\r\n}\r\nint efuse_OneByteRead23a(struct rtw_adapter *pAdapter, u16 addr, u8 *data)\r\n{\r\nu8 tmpidx = 0;\r\nint bResult;\r\nrtl8723au_write8(pAdapter, EFUSE_CTRL + 1, (u8)(addr & 0xff));\r\nrtl8723au_write8(pAdapter, EFUSE_CTRL + 2,\r\n((u8)((addr >> 8) & 0x03)) |\r\n(rtl8723au_read8(pAdapter, EFUSE_CTRL + 2) & 0xFC));\r\nrtl8723au_write8(pAdapter, EFUSE_CTRL + 3, 0x72);\r\nwhile (!(0x80 & rtl8723au_read8(pAdapter, EFUSE_CTRL + 3)) &&\r\n(tmpidx < 100))\r\ntmpidx++;\r\nif (tmpidx < 100) {\r\n*data = rtl8723au_read8(pAdapter, EFUSE_CTRL);\r\nbResult = _SUCCESS;\r\n} else {\r\n*data = 0xff;\r\nbResult = _FAIL;\r\n}\r\nreturn bResult;\r\n}\r\nint efuse_OneByteWrite23a(struct rtw_adapter *pAdapter, u16 addr, u8 data)\r\n{\r\nu8 tmpidx = 0;\r\nint bResult;\r\nrtl8723au_write8(pAdapter, EFUSE_CTRL + 1, (u8)(addr & 0xff));\r\nrtl8723au_write8(pAdapter, EFUSE_CTRL + 2,\r\n(rtl8723au_read8(pAdapter, EFUSE_CTRL + 2) & 0xFC) |\r\n(u8)((addr >> 8) & 0x03));\r\nrtl8723au_write8(pAdapter, EFUSE_CTRL, data);\r\nrtl8723au_write8(pAdapter, EFUSE_CTRL + 3, 0xF2);\r\nwhile ((0x80 & rtl8723au_read8(pAdapter, EFUSE_CTRL + 3)) &&\r\n(tmpidx < 100)) {\r\ntmpidx++;\r\n}\r\nif (tmpidx < 100)\r\nbResult = _SUCCESS;\r\nelse\r\nbResult = _FAIL;\r\nreturn bResult;\r\n}\r\nvoid efuse_WordEnableDataRead23a(u8 word_en, u8 *sourdata, u8 *targetdata)\r\n{\r\nif (!(word_en&BIT(0))) {\r\ntargetdata[0] = sourdata[0];\r\ntargetdata[1] = sourdata[1];\r\n}\r\nif (!(word_en&BIT(1))) {\r\ntargetdata[2] = sourdata[2];\r\ntargetdata[3] = sourdata[3];\r\n}\r\nif (!(word_en&BIT(2))) {\r\ntargetdata[4] = sourdata[4];\r\ntargetdata[5] = sourdata[5];\r\n}\r\nif (!(word_en&BIT(3))) {\r\ntargetdata[6] = sourdata[6];\r\ntargetdata[7] = sourdata[7];\r\n}\r\n}\r\nstatic int efuse_read8(struct rtw_adapter *padapter, u16 address, u8 *value)\r\n{\r\nreturn efuse_OneByteRead23a(padapter, address, value);\r\n}\r\nstatic int efuse_write8(struct rtw_adapter *padapter, u16 address, u8 *value)\r\n{\r\nreturn efuse_OneByteWrite23a(padapter, address, *value);\r\n}\r\nint rtw_efuse_access23a(struct rtw_adapter *padapter, u8 bWrite, u16 start_addr,\r\nu16 cnts, u8 *data)\r\n{\r\nint i = 0;\r\nu16 real_content_len = 0, max_available_size = 0;\r\nint res = _FAIL;\r\nint (*rw8)(struct rtw_adapter *, u16, u8*);\r\nEFUSE_GetEfuseDefinition23a(padapter, EFUSE_WIFI,\r\nTYPE_EFUSE_REAL_CONTENT_LEN,\r\n(void *)&real_content_len);\r\nEFUSE_GetEfuseDefinition23a(padapter, EFUSE_WIFI,\r\nTYPE_AVAILABLE_EFUSE_BYTES_TOTAL,\r\n(void *)&max_available_size);\r\nif (start_addr > real_content_len)\r\nreturn _FAIL;\r\nif (true == bWrite) {\r\nif ((start_addr + cnts) > max_available_size)\r\nreturn _FAIL;\r\nrw8 = &efuse_write8;\r\n} else\r\nrw8 = &efuse_read8;\r\nEfuse_PowerSwitch(padapter, bWrite, true);\r\nfor (i = 0; i < cnts; i++) {\r\nif (start_addr >= real_content_len) {\r\nres = _FAIL;\r\nbreak;\r\n}\r\nres = rw8(padapter, start_addr++, data++);\r\nif (res == _FAIL)\r\nbreak;\r\n}\r\nEfuse_PowerSwitch(padapter, bWrite, false);\r\nreturn res;\r\n}\r\nu16 efuse_GetMaxSize23a(struct rtw_adapter *padapter)\r\n{\r\nu16 max_size;\r\nEFUSE_GetEfuseDefinition23a(padapter, EFUSE_WIFI,\r\nTYPE_AVAILABLE_EFUSE_BYTES_TOTAL,\r\n(void *)&max_size);\r\nreturn max_size;\r\n}\r\nint rtw_efuse_map_read23a(struct rtw_adapter *padapter,\r\nu16 addr, u16 cnts, u8 *data)\r\n{\r\nu16 mapLen = 0;\r\nEFUSE_GetEfuseDefinition23a(padapter, EFUSE_WIFI,\r\nTYPE_EFUSE_MAP_LEN, (void *)&mapLen);\r\nif ((addr + cnts) > mapLen)\r\nreturn _FAIL;\r\nEfuse_PowerSwitch(padapter, false, true);\r\nrtl8723a_readefuse(padapter, EFUSE_WIFI, addr, cnts, data);\r\nEfuse_PowerSwitch(padapter, false, false);\r\nreturn _SUCCESS;\r\n}\r\nint rtw_BT_efuse_map_read23a(struct rtw_adapter *padapter,\r\nu16 addr, u16 cnts, u8 *data)\r\n{\r\nu16 mapLen = 0;\r\nEFUSE_GetEfuseDefinition23a(padapter, EFUSE_BT,\r\nTYPE_EFUSE_MAP_LEN, (void *)&mapLen);\r\nif ((addr + cnts) > mapLen)\r\nreturn _FAIL;\r\nEfuse_PowerSwitch(padapter, false, true);\r\nrtl8723a_readefuse(padapter, EFUSE_BT, addr, cnts, data);\r\nEfuse_PowerSwitch(padapter, false, false);\r\nreturn _SUCCESS;\r\n}\r\nstatic void Efuse_ReadAllMap(struct rtw_adapter *pAdapter, u8 efuseType,\r\nu8 *Efuse)\r\n{\r\nu16 mapLen = 0;\r\nEfuse_PowerSwitch(pAdapter, false, true);\r\nEFUSE_GetEfuseDefinition23a(pAdapter, efuseType, TYPE_EFUSE_MAP_LEN,\r\n(void *)&mapLen);\r\nrtl8723a_readefuse(pAdapter, efuseType, 0, mapLen, Efuse);\r\nEfuse_PowerSwitch(pAdapter, false, false);\r\n}\r\nstatic void efuse_ShadowRead1Byte(struct rtw_adapter *pAdapter, u16 Offset,\r\nu8 *Value)\r\n{\r\nstruct eeprom_priv *pEEPROM = GET_EEPROM_EFUSE_PRIV(pAdapter);\r\n*Value = pEEPROM->efuse_eeprom_data[Offset];\r\n}\r\nstatic void efuse_ShadowRead2Byte(struct rtw_adapter *pAdapter, u16 Offset,\r\nu16 *Value)\r\n{\r\nstruct eeprom_priv *pEEPROM = GET_EEPROM_EFUSE_PRIV(pAdapter);\r\n*Value = pEEPROM->efuse_eeprom_data[Offset];\r\n*Value |= pEEPROM->efuse_eeprom_data[Offset+1]<<8;\r\n}\r\nstatic void efuse_ShadowRead4Byte(struct rtw_adapter *pAdapter, u16 Offset,\r\nu32 *Value)\r\n{\r\nstruct eeprom_priv *pEEPROM = GET_EEPROM_EFUSE_PRIV(pAdapter);\r\n*Value = pEEPROM->efuse_eeprom_data[Offset];\r\n*Value |= pEEPROM->efuse_eeprom_data[Offset+1]<<8;\r\n*Value |= pEEPROM->efuse_eeprom_data[Offset+2]<<16;\r\n*Value |= pEEPROM->efuse_eeprom_data[Offset+3]<<24;\r\n}\r\nvoid EFUSE_ShadowMapUpdate23a(struct rtw_adapter *pAdapter, u8 efuseType)\r\n{\r\nstruct eeprom_priv *pEEPROM = GET_EEPROM_EFUSE_PRIV(pAdapter);\r\nu16 mapLen = 0;\r\nEFUSE_GetEfuseDefinition23a(pAdapter, efuseType,\r\nTYPE_EFUSE_MAP_LEN, (void *)&mapLen);\r\nif (pEEPROM->bautoload_fail_flag == true)\r\nmemset(pEEPROM->efuse_eeprom_data, 0xFF, mapLen);\r\nelse\r\nEfuse_ReadAllMap(pAdapter, efuseType,\r\npEEPROM->efuse_eeprom_data);\r\n}\r\nvoid EFUSE_ShadowRead23a(struct rtw_adapter *pAdapter, u8 Type,\r\nu16 Offset, u32 *Value)\r\n{\r\nif (Type == 1)\r\nefuse_ShadowRead1Byte(pAdapter, Offset, (u8 *)Value);\r\nelse if (Type == 2)\r\nefuse_ShadowRead2Byte(pAdapter, Offset, (u16 *)Value);\r\nelse if (Type == 4)\r\nefuse_ShadowRead4Byte(pAdapter, Offset, (u32 *)Value);\r\n}

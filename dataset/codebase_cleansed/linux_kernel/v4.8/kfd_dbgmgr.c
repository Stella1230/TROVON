struct mutex *kfd_get_dbgmgr_mutex(void)\r\n{\r\nreturn &kfd_dbgmgr_mutex;\r\n}\r\nstatic void kfd_dbgmgr_uninitialize(struct kfd_dbgmgr *pmgr)\r\n{\r\nBUG_ON(!pmgr);\r\nkfree(pmgr->dbgdev);\r\npmgr->dbgdev = NULL;\r\npmgr->pasid = 0;\r\npmgr->dev = NULL;\r\n}\r\nvoid kfd_dbgmgr_destroy(struct kfd_dbgmgr *pmgr)\r\n{\r\nif (pmgr != NULL) {\r\nkfd_dbgmgr_uninitialize(pmgr);\r\nkfree(pmgr);\r\n}\r\n}\r\nbool kfd_dbgmgr_create(struct kfd_dbgmgr **ppmgr, struct kfd_dev *pdev)\r\n{\r\nenum DBGDEV_TYPE type = DBGDEV_TYPE_DIQ;\r\nstruct kfd_dbgmgr *new_buff;\r\nBUG_ON(pdev == NULL);\r\nBUG_ON(!pdev->init_complete);\r\nnew_buff = kfd_alloc_struct(new_buff);\r\nif (!new_buff) {\r\npr_err("amdkfd: Failed to allocate dbgmgr instance\n");\r\nreturn false;\r\n}\r\nnew_buff->pasid = 0;\r\nnew_buff->dev = pdev;\r\nnew_buff->dbgdev = kfd_alloc_struct(new_buff->dbgdev);\r\nif (!new_buff->dbgdev) {\r\npr_err("amdkfd: Failed to allocate dbgdev instance\n");\r\nkfree(new_buff);\r\nreturn false;\r\n}\r\nif (sched_policy == KFD_SCHED_POLICY_NO_HWS)\r\ntype = DBGDEV_TYPE_NODIQ;\r\nkfd_dbgdev_init(new_buff->dbgdev, pdev, type);\r\n*ppmgr = new_buff;\r\nreturn true;\r\n}\r\nlong kfd_dbgmgr_register(struct kfd_dbgmgr *pmgr, struct kfd_process *p)\r\n{\r\nBUG_ON(!p || !pmgr || !pmgr->dbgdev);\r\nif (pmgr->pasid != 0) {\r\npr_debug("H/W debugger is already active using pasid %d\n",\r\npmgr->pasid);\r\nreturn -EBUSY;\r\n}\r\npmgr->pasid = p->pasid;\r\npmgr->dbgdev->pqm = &p->pqm;\r\npmgr->dbgdev->dbgdev_register(pmgr->dbgdev);\r\nreturn 0;\r\n}\r\nlong kfd_dbgmgr_unregister(struct kfd_dbgmgr *pmgr, struct kfd_process *p)\r\n{\r\nBUG_ON(!p || !pmgr || !pmgr->dbgdev);\r\nif (pmgr->pasid != p->pasid) {\r\npr_debug("H/W debugger is not registered by calling pasid %d\n",\r\np->pasid);\r\nreturn -EINVAL;\r\n}\r\npmgr->dbgdev->dbgdev_unregister(pmgr->dbgdev);\r\npmgr->pasid = 0;\r\nreturn 0;\r\n}\r\nlong kfd_dbgmgr_wave_control(struct kfd_dbgmgr *pmgr,\r\nstruct dbg_wave_control_info *wac_info)\r\n{\r\nBUG_ON(!pmgr || !pmgr->dbgdev || !wac_info);\r\nif (pmgr->pasid != wac_info->process->pasid) {\r\npr_debug("H/W debugger support was not registered for requester pasid %d\n",\r\nwac_info->process->pasid);\r\nreturn -EINVAL;\r\n}\r\nreturn (long) pmgr->dbgdev->dbgdev_wave_control(pmgr->dbgdev, wac_info);\r\n}\r\nlong kfd_dbgmgr_address_watch(struct kfd_dbgmgr *pmgr,\r\nstruct dbg_address_watch_info *adw_info)\r\n{\r\nBUG_ON(!pmgr || !pmgr->dbgdev || !adw_info);\r\nif (pmgr->pasid != adw_info->process->pasid) {\r\npr_debug("H/W debugger support was not registered for requester pasid %d\n",\r\nadw_info->process->pasid);\r\nreturn -EINVAL;\r\n}\r\nreturn (long) pmgr->dbgdev->dbgdev_address_watch(pmgr->dbgdev,\r\nadw_info);\r\n}

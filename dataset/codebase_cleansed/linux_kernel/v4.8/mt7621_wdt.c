static inline void rt_wdt_w32(unsigned reg, u32 val)\r\n{\r\niowrite32(val, mt7621_wdt_base + reg);\r\n}\r\nstatic inline u32 rt_wdt_r32(unsigned reg)\r\n{\r\nreturn ioread32(mt7621_wdt_base + reg);\r\n}\r\nstatic int mt7621_wdt_ping(struct watchdog_device *w)\r\n{\r\nrt_wdt_w32(TIMER_REG_TMRSTAT, TMR1CTL_RESTART);\r\nreturn 0;\r\n}\r\nstatic int mt7621_wdt_set_timeout(struct watchdog_device *w, unsigned int t)\r\n{\r\nw->timeout = t;\r\nrt_wdt_w32(TIMER_REG_TMR1LOAD, t * 1000);\r\nmt7621_wdt_ping(w);\r\nreturn 0;\r\n}\r\nstatic int mt7621_wdt_start(struct watchdog_device *w)\r\n{\r\nu32 t;\r\nrt_wdt_w32(TIMER_REG_TMR1CTL, 1000 << TMR1CTL_PRESCALE_SHIFT);\r\nmt7621_wdt_set_timeout(w, w->timeout);\r\nt = rt_wdt_r32(TIMER_REG_TMR1CTL);\r\nt |= TMR1CTL_ENABLE;\r\nrt_wdt_w32(TIMER_REG_TMR1CTL, t);\r\nreturn 0;\r\n}\r\nstatic int mt7621_wdt_stop(struct watchdog_device *w)\r\n{\r\nu32 t;\r\nmt7621_wdt_ping(w);\r\nt = rt_wdt_r32(TIMER_REG_TMR1CTL);\r\nt &= ~TMR1CTL_ENABLE;\r\nrt_wdt_w32(TIMER_REG_TMR1CTL, t);\r\nreturn 0;\r\n}\r\nstatic int mt7621_wdt_bootcause(void)\r\n{\r\nif (rt_sysc_r32(SYSC_RSTSTAT) & WDT_RST_CAUSE)\r\nreturn WDIOF_CARDRESET;\r\nreturn 0;\r\n}\r\nstatic int mt7621_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nint ret;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nmt7621_wdt_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(mt7621_wdt_base))\r\nreturn PTR_ERR(mt7621_wdt_base);\r\nmt7621_wdt_reset = devm_reset_control_get(&pdev->dev, NULL);\r\nif (!IS_ERR(mt7621_wdt_reset))\r\nreset_control_deassert(mt7621_wdt_reset);\r\nmt7621_wdt_dev.dev = &pdev->dev;\r\nmt7621_wdt_dev.bootstatus = mt7621_wdt_bootcause();\r\nwatchdog_init_timeout(&mt7621_wdt_dev, mt7621_wdt_dev.max_timeout,\r\n&pdev->dev);\r\nwatchdog_set_nowayout(&mt7621_wdt_dev, nowayout);\r\nret = watchdog_register_device(&mt7621_wdt_dev);\r\nreturn 0;\r\n}\r\nstatic int mt7621_wdt_remove(struct platform_device *pdev)\r\n{\r\nwatchdog_unregister_device(&mt7621_wdt_dev);\r\nreturn 0;\r\n}\r\nstatic void mt7621_wdt_shutdown(struct platform_device *pdev)\r\n{\r\nmt7621_wdt_stop(&mt7621_wdt_dev);\r\n}

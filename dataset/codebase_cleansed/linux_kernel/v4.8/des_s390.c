static int des_setkey(struct crypto_tfm *tfm, const u8 *key,\r\nunsigned int key_len)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_tfm_ctx(tfm);\r\nu32 *flags = &tfm->crt_flags;\r\nu32 tmp[DES_EXPKEY_WORDS];\r\nif (!des_ekey(tmp, key) && (*flags & CRYPTO_TFM_REQ_WEAK_KEY)) {\r\n*flags |= CRYPTO_TFM_RES_WEAK_KEY;\r\nreturn -EINVAL;\r\n}\r\nmemcpy(ctx->key, key, key_len);\r\nreturn 0;\r\n}\r\nstatic void des_encrypt(struct crypto_tfm *tfm, u8 *out, const u8 *in)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_tfm_ctx(tfm);\r\ncpacf_km(CPACF_KM_DEA_ENC, ctx->key, out, in, DES_BLOCK_SIZE);\r\n}\r\nstatic void des_decrypt(struct crypto_tfm *tfm, u8 *out, const u8 *in)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_tfm_ctx(tfm);\r\ncpacf_km(CPACF_KM_DEA_DEC, ctx->key, out, in, DES_BLOCK_SIZE);\r\n}\r\nstatic int ecb_desall_crypt(struct blkcipher_desc *desc, long func,\r\nu8 *key, struct blkcipher_walk *walk)\r\n{\r\nint ret = blkcipher_walk_virt(desc, walk);\r\nunsigned int nbytes;\r\nwhile ((nbytes = walk->nbytes)) {\r\nunsigned int n = nbytes & ~(DES_BLOCK_SIZE - 1);\r\nu8 *out = walk->dst.virt.addr;\r\nu8 *in = walk->src.virt.addr;\r\nret = cpacf_km(func, key, out, in, n);\r\nif (ret < 0 || ret != n)\r\nreturn -EIO;\r\nnbytes &= DES_BLOCK_SIZE - 1;\r\nret = blkcipher_walk_done(desc, walk, nbytes);\r\n}\r\nreturn ret;\r\n}\r\nstatic int cbc_desall_crypt(struct blkcipher_desc *desc, long func,\r\nstruct blkcipher_walk *walk)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nint ret = blkcipher_walk_virt(desc, walk);\r\nunsigned int nbytes = walk->nbytes;\r\nstruct {\r\nu8 iv[DES_BLOCK_SIZE];\r\nu8 key[DES3_KEY_SIZE];\r\n} param;\r\nif (!nbytes)\r\ngoto out;\r\nmemcpy(param.iv, walk->iv, DES_BLOCK_SIZE);\r\nmemcpy(param.key, ctx->key, DES3_KEY_SIZE);\r\ndo {\r\nunsigned int n = nbytes & ~(DES_BLOCK_SIZE - 1);\r\nu8 *out = walk->dst.virt.addr;\r\nu8 *in = walk->src.virt.addr;\r\nret = cpacf_kmc(func, &param, out, in, n);\r\nif (ret < 0 || ret != n)\r\nreturn -EIO;\r\nnbytes &= DES_BLOCK_SIZE - 1;\r\nret = blkcipher_walk_done(desc, walk, nbytes);\r\n} while ((nbytes = walk->nbytes));\r\nmemcpy(walk->iv, param.iv, DES_BLOCK_SIZE);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int ecb_des_encrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn ecb_desall_crypt(desc, CPACF_KM_DEA_ENC, ctx->key, &walk);\r\n}\r\nstatic int ecb_des_decrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn ecb_desall_crypt(desc, CPACF_KM_DEA_DEC, ctx->key, &walk);\r\n}\r\nstatic int cbc_des_encrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn cbc_desall_crypt(desc, CPACF_KMC_DEA_ENC, &walk);\r\n}\r\nstatic int cbc_des_decrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn cbc_desall_crypt(desc, CPACF_KMC_DEA_DEC, &walk);\r\n}\r\nstatic int des3_setkey(struct crypto_tfm *tfm, const u8 *key,\r\nunsigned int key_len)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_tfm_ctx(tfm);\r\nu32 *flags = &tfm->crt_flags;\r\nif (!(crypto_memneq(key, &key[DES_KEY_SIZE], DES_KEY_SIZE) &&\r\ncrypto_memneq(&key[DES_KEY_SIZE], &key[DES_KEY_SIZE * 2],\r\nDES_KEY_SIZE)) &&\r\n(*flags & CRYPTO_TFM_REQ_WEAK_KEY)) {\r\n*flags |= CRYPTO_TFM_RES_WEAK_KEY;\r\nreturn -EINVAL;\r\n}\r\nmemcpy(ctx->key, key, key_len);\r\nreturn 0;\r\n}\r\nstatic void des3_encrypt(struct crypto_tfm *tfm, u8 *dst, const u8 *src)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_tfm_ctx(tfm);\r\ncpacf_km(CPACF_KM_TDEA_192_ENC, ctx->key, dst, src, DES_BLOCK_SIZE);\r\n}\r\nstatic void des3_decrypt(struct crypto_tfm *tfm, u8 *dst, const u8 *src)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_tfm_ctx(tfm);\r\ncpacf_km(CPACF_KM_TDEA_192_DEC, ctx->key, dst, src, DES_BLOCK_SIZE);\r\n}\r\nstatic int ecb_des3_encrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn ecb_desall_crypt(desc, CPACF_KM_TDEA_192_ENC, ctx->key, &walk);\r\n}\r\nstatic int ecb_des3_decrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn ecb_desall_crypt(desc, CPACF_KM_TDEA_192_DEC, ctx->key, &walk);\r\n}\r\nstatic int cbc_des3_encrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn cbc_desall_crypt(desc, CPACF_KMC_TDEA_192_ENC, &walk);\r\n}\r\nstatic int cbc_des3_decrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn cbc_desall_crypt(desc, CPACF_KMC_TDEA_192_DEC, &walk);\r\n}\r\nstatic unsigned int __ctrblk_init(u8 *ctrptr, unsigned int nbytes)\r\n{\r\nunsigned int i, n;\r\nn = (nbytes > PAGE_SIZE) ? PAGE_SIZE : nbytes & ~(DES_BLOCK_SIZE - 1);\r\nfor (i = DES_BLOCK_SIZE; i < n; i += DES_BLOCK_SIZE) {\r\nmemcpy(ctrptr + i, ctrptr + i - DES_BLOCK_SIZE, DES_BLOCK_SIZE);\r\ncrypto_inc(ctrptr + i, DES_BLOCK_SIZE);\r\n}\r\nreturn n;\r\n}\r\nstatic int ctr_desall_crypt(struct blkcipher_desc *desc, long func,\r\nstruct s390_des_ctx *ctx,\r\nstruct blkcipher_walk *walk)\r\n{\r\nint ret = blkcipher_walk_virt_block(desc, walk, DES_BLOCK_SIZE);\r\nunsigned int n, nbytes;\r\nu8 buf[DES_BLOCK_SIZE], ctrbuf[DES_BLOCK_SIZE];\r\nu8 *out, *in, *ctrptr = ctrbuf;\r\nif (!walk->nbytes)\r\nreturn ret;\r\nif (spin_trylock(&ctrblk_lock))\r\nctrptr = ctrblk;\r\nmemcpy(ctrptr, walk->iv, DES_BLOCK_SIZE);\r\nwhile ((nbytes = walk->nbytes) >= DES_BLOCK_SIZE) {\r\nout = walk->dst.virt.addr;\r\nin = walk->src.virt.addr;\r\nwhile (nbytes >= DES_BLOCK_SIZE) {\r\nif (ctrptr == ctrblk)\r\nn = __ctrblk_init(ctrptr, nbytes);\r\nelse\r\nn = DES_BLOCK_SIZE;\r\nret = cpacf_kmctr(func, ctx->key, out, in, n, ctrptr);\r\nif (ret < 0 || ret != n) {\r\nif (ctrptr == ctrblk)\r\nspin_unlock(&ctrblk_lock);\r\nreturn -EIO;\r\n}\r\nif (n > DES_BLOCK_SIZE)\r\nmemcpy(ctrptr, ctrptr + n - DES_BLOCK_SIZE,\r\nDES_BLOCK_SIZE);\r\ncrypto_inc(ctrptr, DES_BLOCK_SIZE);\r\nout += n;\r\nin += n;\r\nnbytes -= n;\r\n}\r\nret = blkcipher_walk_done(desc, walk, nbytes);\r\n}\r\nif (ctrptr == ctrblk) {\r\nif (nbytes)\r\nmemcpy(ctrbuf, ctrptr, DES_BLOCK_SIZE);\r\nelse\r\nmemcpy(walk->iv, ctrptr, DES_BLOCK_SIZE);\r\nspin_unlock(&ctrblk_lock);\r\n} else {\r\nif (!nbytes)\r\nmemcpy(walk->iv, ctrptr, DES_BLOCK_SIZE);\r\n}\r\nif (nbytes) {\r\nout = walk->dst.virt.addr;\r\nin = walk->src.virt.addr;\r\nret = cpacf_kmctr(func, ctx->key, buf, in,\r\nDES_BLOCK_SIZE, ctrbuf);\r\nif (ret < 0 || ret != DES_BLOCK_SIZE)\r\nreturn -EIO;\r\nmemcpy(out, buf, nbytes);\r\ncrypto_inc(ctrbuf, DES_BLOCK_SIZE);\r\nret = blkcipher_walk_done(desc, walk, 0);\r\nmemcpy(walk->iv, ctrbuf, DES_BLOCK_SIZE);\r\n}\r\nreturn ret;\r\n}\r\nstatic int ctr_des_encrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn ctr_desall_crypt(desc, CPACF_KMCTR_DEA_ENC, ctx, &walk);\r\n}\r\nstatic int ctr_des_decrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn ctr_desall_crypt(desc, CPACF_KMCTR_DEA_DEC, ctx, &walk);\r\n}\r\nstatic int ctr_des3_encrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn ctr_desall_crypt(desc, CPACF_KMCTR_TDEA_192_ENC, ctx, &walk);\r\n}\r\nstatic int ctr_des3_decrypt(struct blkcipher_desc *desc,\r\nstruct scatterlist *dst, struct scatterlist *src,\r\nunsigned int nbytes)\r\n{\r\nstruct s390_des_ctx *ctx = crypto_blkcipher_ctx(desc->tfm);\r\nstruct blkcipher_walk walk;\r\nblkcipher_walk_init(&walk, dst, src, nbytes);\r\nreturn ctr_desall_crypt(desc, CPACF_KMCTR_TDEA_192_DEC, ctx, &walk);\r\n}\r\nstatic int __init des_s390_init(void)\r\n{\r\nint ret;\r\nif (!cpacf_query(CPACF_KM, CPACF_KM_DEA_ENC) ||\r\n!cpacf_query(CPACF_KM, CPACF_KM_TDEA_192_ENC))\r\nreturn -EOPNOTSUPP;\r\nret = crypto_register_alg(&des_alg);\r\nif (ret)\r\ngoto des_err;\r\nret = crypto_register_alg(&ecb_des_alg);\r\nif (ret)\r\ngoto ecb_des_err;\r\nret = crypto_register_alg(&cbc_des_alg);\r\nif (ret)\r\ngoto cbc_des_err;\r\nret = crypto_register_alg(&des3_alg);\r\nif (ret)\r\ngoto des3_err;\r\nret = crypto_register_alg(&ecb_des3_alg);\r\nif (ret)\r\ngoto ecb_des3_err;\r\nret = crypto_register_alg(&cbc_des3_alg);\r\nif (ret)\r\ngoto cbc_des3_err;\r\nif (cpacf_query(CPACF_KMCTR, CPACF_KMCTR_DEA_ENC) &&\r\ncpacf_query(CPACF_KMCTR, CPACF_KMCTR_TDEA_192_ENC)) {\r\nret = crypto_register_alg(&ctr_des_alg);\r\nif (ret)\r\ngoto ctr_des_err;\r\nret = crypto_register_alg(&ctr_des3_alg);\r\nif (ret)\r\ngoto ctr_des3_err;\r\nctrblk = (u8 *) __get_free_page(GFP_KERNEL);\r\nif (!ctrblk) {\r\nret = -ENOMEM;\r\ngoto ctr_mem_err;\r\n}\r\n}\r\nout:\r\nreturn ret;\r\nctr_mem_err:\r\ncrypto_unregister_alg(&ctr_des3_alg);\r\nctr_des3_err:\r\ncrypto_unregister_alg(&ctr_des_alg);\r\nctr_des_err:\r\ncrypto_unregister_alg(&cbc_des3_alg);\r\ncbc_des3_err:\r\ncrypto_unregister_alg(&ecb_des3_alg);\r\necb_des3_err:\r\ncrypto_unregister_alg(&des3_alg);\r\ndes3_err:\r\ncrypto_unregister_alg(&cbc_des_alg);\r\ncbc_des_err:\r\ncrypto_unregister_alg(&ecb_des_alg);\r\necb_des_err:\r\ncrypto_unregister_alg(&des_alg);\r\ndes_err:\r\ngoto out;\r\n}\r\nstatic void __exit des_s390_exit(void)\r\n{\r\nif (ctrblk) {\r\ncrypto_unregister_alg(&ctr_des_alg);\r\ncrypto_unregister_alg(&ctr_des3_alg);\r\nfree_page((unsigned long) ctrblk);\r\n}\r\ncrypto_unregister_alg(&cbc_des3_alg);\r\ncrypto_unregister_alg(&ecb_des3_alg);\r\ncrypto_unregister_alg(&des3_alg);\r\ncrypto_unregister_alg(&cbc_des_alg);\r\ncrypto_unregister_alg(&ecb_des_alg);\r\ncrypto_unregister_alg(&des_alg);\r\n}

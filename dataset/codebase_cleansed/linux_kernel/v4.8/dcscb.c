static int dcscb_cpu_powerup(unsigned int cpu, unsigned int cluster)\r\n{\r\nunsigned int rst_hold, cpumask = (1 << cpu);\r\npr_debug("%s: cpu %u cluster %u\n", __func__, cpu, cluster);\r\nif (cluster >= 2 || !(cpumask & dcscb_allcpus_mask[cluster]))\r\nreturn -EINVAL;\r\nrst_hold = readl_relaxed(dcscb_base + RST_HOLD0 + cluster * 4);\r\nrst_hold &= ~(cpumask | (cpumask << 4));\r\nwritel_relaxed(rst_hold, dcscb_base + RST_HOLD0 + cluster * 4);\r\nreturn 0;\r\n}\r\nstatic int dcscb_cluster_powerup(unsigned int cluster)\r\n{\r\nunsigned int rst_hold;\r\npr_debug("%s: cluster %u\n", __func__, cluster);\r\nif (cluster >= 2)\r\nreturn -EINVAL;\r\nrst_hold = readl_relaxed(dcscb_base + RST_HOLD0 + cluster * 4);\r\nrst_hold &= ~(1 << 8);\r\nrst_hold |= dcscb_allcpus_mask[cluster];\r\nwritel_relaxed(rst_hold, dcscb_base + RST_HOLD0 + cluster * 4);\r\nreturn 0;\r\n}\r\nstatic void dcscb_cpu_powerdown_prepare(unsigned int cpu, unsigned int cluster)\r\n{\r\nunsigned int rst_hold;\r\npr_debug("%s: cpu %u cluster %u\n", __func__, cpu, cluster);\r\nBUG_ON(cluster >= 2 || !((1 << cpu) & dcscb_allcpus_mask[cluster]));\r\nrst_hold = readl_relaxed(dcscb_base + RST_HOLD0 + cluster * 4);\r\nrst_hold |= (1 << cpu);\r\nwritel_relaxed(rst_hold, dcscb_base + RST_HOLD0 + cluster * 4);\r\n}\r\nstatic void dcscb_cluster_powerdown_prepare(unsigned int cluster)\r\n{\r\nunsigned int rst_hold;\r\npr_debug("%s: cluster %u\n", __func__, cluster);\r\nBUG_ON(cluster >= 2);\r\nrst_hold = readl_relaxed(dcscb_base + RST_HOLD0 + cluster * 4);\r\nrst_hold |= (1 << 8);\r\nwritel_relaxed(rst_hold, dcscb_base + RST_HOLD0 + cluster * 4);\r\n}\r\nstatic void dcscb_cpu_cache_disable(void)\r\n{\r\nv7_exit_coherency_flush(louis);\r\n}\r\nstatic void dcscb_cluster_cache_disable(void)\r\n{\r\nv7_exit_coherency_flush(all);\r\ncci_disable_port_by_cpu(read_cpuid_mpidr());\r\n}\r\nstatic int __init dcscb_init(void)\r\n{\r\nstruct device_node *node;\r\nunsigned int cfg;\r\nint ret;\r\nif (!cci_probed())\r\nreturn -ENODEV;\r\nnode = of_find_compatible_node(NULL, NULL, "arm,rtsm,dcscb");\r\nif (!node)\r\nreturn -ENODEV;\r\ndcscb_base = of_iomap(node, 0);\r\nif (!dcscb_base)\r\nreturn -EADDRNOTAVAIL;\r\ncfg = readl_relaxed(dcscb_base + DCS_CFG_R);\r\ndcscb_allcpus_mask[0] = (1 << (((cfg >> 16) >> (0 << 2)) & 0xf)) - 1;\r\ndcscb_allcpus_mask[1] = (1 << (((cfg >> 16) >> (1 << 2)) & 0xf)) - 1;\r\nret = mcpm_platform_register(&dcscb_power_ops);\r\nif (!ret)\r\nret = mcpm_sync_init(dcscb_power_up_setup);\r\nif (ret) {\r\niounmap(dcscb_base);\r\nreturn ret;\r\n}\r\npr_info("VExpress DCSCB support installed\n");\r\nvexpress_flags_set(virt_to_phys(mcpm_entry_point));\r\nreturn 0;\r\n}

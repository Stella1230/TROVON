static int armada375_usb_phy_init(struct phy *phy)\r\n{\r\nstruct armada375_cluster_phy *cluster_phy;\r\nu32 reg;\r\ncluster_phy = phy_get_drvdata(phy);\r\nif (!cluster_phy)\r\nreturn -ENODEV;\r\nreg = readl(cluster_phy->reg);\r\nif (cluster_phy->use_usb3)\r\nreg |= USB2_PHY_CONFIG_DISABLE;\r\nelse\r\nreg &= ~USB2_PHY_CONFIG_DISABLE;\r\nwritel(reg, cluster_phy->reg);\r\nreturn 0;\r\n}\r\nstatic struct phy *armada375_usb_phy_xlate(struct device *dev,\r\nstruct of_phandle_args *args)\r\n{\r\nstruct armada375_cluster_phy *cluster_phy = dev_get_drvdata(dev);\r\nif (!cluster_phy)\r\nreturn ERR_PTR(-ENODEV);\r\nif (WARN_ON((cluster_phy->phy_provided != PHY_NONE) &&\r\n(cluster_phy->phy_provided != args->args[0]))) {\r\ndev_err(dev, "This PHY has already been provided!\n");\r\ndev_err(dev, "Check your device tree, only one controller can use it\n.");\r\nif (args->args[0] == PHY_TYPE_USB2)\r\nreturn ERR_PTR(-EBUSY);\r\nelse\r\nreturn ERR_PTR(-ENODEV);\r\n}\r\nif (args->args[0] == PHY_TYPE_USB2)\r\ncluster_phy->use_usb3 = false;\r\nelse if (args->args[0] == PHY_TYPE_USB3)\r\ncluster_phy->use_usb3 = true;\r\nelse {\r\ndev_err(dev, "Invalid PHY mode\n");\r\nreturn ERR_PTR(-ENODEV);\r\n}\r\ncluster_phy->phy_provided = args->args[0];\r\nreturn cluster_phy->phy;\r\n}\r\nstatic int armada375_usb_phy_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct phy *phy;\r\nstruct phy_provider *phy_provider;\r\nvoid __iomem *usb_cluster_base;\r\nstruct resource *res;\r\nstruct armada375_cluster_phy *cluster_phy;\r\ncluster_phy = devm_kzalloc(dev, sizeof(*cluster_phy), GFP_KERNEL);\r\nif (!cluster_phy)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nusb_cluster_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(usb_cluster_base))\r\nreturn PTR_ERR(usb_cluster_base);\r\nphy = devm_phy_create(dev, NULL, &armada375_usb_phy_ops);\r\nif (IS_ERR(phy)) {\r\ndev_err(dev, "failed to create PHY\n");\r\nreturn PTR_ERR(phy);\r\n}\r\ncluster_phy->phy = phy;\r\ncluster_phy->reg = usb_cluster_base;\r\ndev_set_drvdata(dev, cluster_phy);\r\nphy_set_drvdata(phy, cluster_phy);\r\nphy_provider = devm_of_phy_provider_register(&pdev->dev,\r\narmada375_usb_phy_xlate);\r\nreturn PTR_ERR_OR_ZERO(phy_provider);\r\n}

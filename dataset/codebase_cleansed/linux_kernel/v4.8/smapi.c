static int smapi_request(unsigned short inBX, unsigned short inCX,\r\nunsigned short inDI, unsigned short inSI,\r\nunsigned short *outAX, unsigned short *outBX,\r\nunsigned short *outCX, unsigned short *outDX,\r\nunsigned short *outDI, unsigned short *outSI)\r\n{\r\nunsigned short myoutAX = 2, *pmyoutAX = &myoutAX;\r\nunsigned short myoutBX = 3, *pmyoutBX = &myoutBX;\r\nunsigned short myoutCX = 4, *pmyoutCX = &myoutCX;\r\nunsigned short myoutDX = 5, *pmyoutDX = &myoutDX;\r\nunsigned short myoutDI = 6, *pmyoutDI = &myoutDI;\r\nunsigned short myoutSI = 7, *pmyoutSI = &myoutSI;\r\nunsigned short usSmapiOK = -EIO, *pusSmapiOK = &usSmapiOK;\r\nunsigned int inBXCX = (inBX << 16) | inCX;\r\nunsigned int inDISI = (inDI << 16) | inSI;\r\nint retval = 0;\r\nPRINTK_5(TRACE_SMAPI, "inBX %x inCX %x inDI %x inSI %x\n",\r\ninBX, inCX, inDI, inSI);\r\n__asm__ __volatile__("movw $0x5380,%%ax\n\t"\r\n"movl %7,%%ebx\n\t"\r\n"shrl $16, %%ebx\n\t"\r\n"movw %7,%%cx\n\t"\r\n"movl %8,%%edi\n\t"\r\n"shrl $16,%%edi\n\t"\r\n"movw %8,%%si\n\t"\r\n"movw %9,%%dx\n\t"\r\n"out %%al,%%dx\n\t"\r\n"out %%al,$0x4F\n\t"\r\n"cmpb $0x53,%%ah\n\t"\r\n"je 2f\n\t"\r\n"1:\n\t"\r\n"orb %%ah,%%ah\n\t"\r\n"jnz 2f\n\t"\r\n"movw %%ax,%0\n\t"\r\n"movw %%bx,%1\n\t"\r\n"movw %%cx,%2\n\t"\r\n"movw %%dx,%3\n\t"\r\n"movw %%di,%4\n\t"\r\n"movw %%si,%5\n\t"\r\n"movw $1,%6\n\t"\r\n"2:\n\t":"=m"(*(unsigned short *) pmyoutAX),\r\n"=m"(*(unsigned short *) pmyoutBX),\r\n"=m"(*(unsigned short *) pmyoutCX),\r\n"=m"(*(unsigned short *) pmyoutDX),\r\n"=m"(*(unsigned short *) pmyoutDI),\r\n"=m"(*(unsigned short *) pmyoutSI),\r\n"=m"(*(unsigned short *) pusSmapiOK)\r\n:"m"(inBXCX), "m"(inDISI), "m"(g_usSmapiPort)\r\n:"%eax", "%ebx", "%ecx", "%edx", "%edi",\r\n"%esi");\r\nPRINTK_8(TRACE_SMAPI,\r\n"myoutAX %x myoutBX %x myoutCX %x myoutDX %x myoutDI %x myoutSI %x usSmapiOK %x\n",\r\nmyoutAX, myoutBX, myoutCX, myoutDX, myoutDI, myoutSI,\r\nusSmapiOK);\r\n*outAX = myoutAX;\r\n*outBX = myoutBX;\r\n*outCX = myoutCX;\r\n*outDX = myoutDX;\r\n*outDI = myoutDI;\r\n*outSI = myoutSI;\r\nretval = (usSmapiOK == 1) ? 0 : -EIO;\r\nPRINTK_2(TRACE_SMAPI, "smapi::smapi_request exit retval %x\n", retval);\r\nreturn retval;\r\n}\r\nint smapi_query_DSP_cfg(SMAPI_DSP_SETTINGS * pSettings)\r\n{\r\nint bRC = -EIO;\r\nunsigned short usAX, usBX, usCX, usDX, usDI, usSI;\r\nunsigned short ausDspBases[] = { 0x0030, 0x4E30, 0x8E30, 0xCE30, 0x0130, 0x0350, 0x0070, 0x0DB0 };\r\nunsigned short ausUartBases[] = { 0x03F8, 0x02F8, 0x03E8, 0x02E8 };\r\nunsigned short numDspBases = 8;\r\nunsigned short numUartBases = 4;\r\nPRINTK_1(TRACE_SMAPI, "smapi::smapi_query_DSP_cfg entry\n");\r\nbRC = smapi_request(0x1802, 0x0000, 0, 0,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nif (bRC) {\r\nPRINTK_ERROR(KERN_ERR_MWAVE "smapi::smapi_query_DSP_cfg: Error: Could not get DSP Settings. Aborting.\n");\r\nreturn bRC;\r\n}\r\nPRINTK_1(TRACE_SMAPI, "smapi::smapi_query_DSP_cfg, smapi_request OK\n");\r\npSettings->bDSPPresent = ((usBX & 0x0100) != 0);\r\npSettings->bDSPEnabled = ((usCX & 0x0001) != 0);\r\npSettings->usDspIRQ = usSI & 0x00FF;\r\npSettings->usDspDMA = (usSI & 0xFF00) >> 8;\r\nif ((usDI & 0x00FF) < numDspBases) {\r\npSettings->usDspBaseIO = ausDspBases[usDI & 0x00FF];\r\n} else {\r\npSettings->usDspBaseIO = 0;\r\n}\r\nPRINTK_6(TRACE_SMAPI,\r\n"smapi::smapi_query_DSP_cfg get DSP Settings bDSPPresent %x bDSPEnabled %x usDspIRQ %x usDspDMA %x usDspBaseIO %x\n",\r\npSettings->bDSPPresent, pSettings->bDSPEnabled,\r\npSettings->usDspIRQ, pSettings->usDspDMA,\r\npSettings->usDspBaseIO);\r\nif ( pSettings->usDspBaseIO == 0 )\r\nPRINTK_ERROR(KERN_ERR_MWAVE "smapi::smapi_query_DSP_cfg: Worry: DSP base I/O address is 0\n");\r\nif ( pSettings->usDspIRQ == 0 )\r\nPRINTK_ERROR(KERN_ERR_MWAVE "smapi::smapi_query_DSP_cfg: Worry: DSP IRQ line is 0\n");\r\nbRC = smapi_request(0x1804, 0x0000, 0, 0,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nif (bRC) {\r\nPRINTK_ERROR("smapi::smapi_query_DSP_cfg: Error: Could not get DSP modem settings. Aborting.\n");\r\nreturn bRC;\r\n}\r\nPRINTK_1(TRACE_SMAPI, "smapi::smapi_query_DSP_cfg, smapi_request OK\n");\r\npSettings->bModemEnabled = ((usCX & 0x0001) != 0);\r\npSettings->usUartIRQ = usSI & 0x000F;\r\nif (((usSI & 0xFF00) >> 8) < numUartBases) {\r\npSettings->usUartBaseIO = ausUartBases[(usSI & 0xFF00) >> 8];\r\n} else {\r\npSettings->usUartBaseIO = 0;\r\n}\r\nPRINTK_4(TRACE_SMAPI,\r\n"smapi::smapi_query_DSP_cfg get DSP modem settings bModemEnabled %x usUartIRQ %x usUartBaseIO %x\n",\r\npSettings->bModemEnabled,\r\npSettings->usUartIRQ,\r\npSettings->usUartBaseIO);\r\nif ( pSettings->usUartBaseIO == 0 )\r\nPRINTK_ERROR(KERN_ERR_MWAVE "smapi::smapi_query_DSP_cfg: Worry: UART base I/O address is 0\n");\r\nif ( pSettings->usUartIRQ == 0 )\r\nPRINTK_ERROR(KERN_ERR_MWAVE "smapi::smapi_query_DSP_cfg: Worry: UART IRQ line is 0\n");\r\nPRINTK_2(TRACE_SMAPI, "smapi::smapi_query_DSP_cfg exit bRC %x\n", bRC);\r\nreturn bRC;\r\n}\r\nint smapi_set_DSP_cfg(void)\r\n{\r\nint bRC = -EIO;\r\nint i;\r\nunsigned short usAX, usBX, usCX, usDX, usDI, usSI;\r\nunsigned short ausDspBases[] = { 0x0030, 0x4E30, 0x8E30, 0xCE30, 0x0130, 0x0350, 0x0070, 0x0DB0 };\r\nunsigned short ausUartBases[] = { 0x03F8, 0x02F8, 0x03E8, 0x02E8 };\r\nunsigned short ausDspIrqs[] = { 5, 7, 10, 11, 15 };\r\nunsigned short ausUartIrqs[] = { 3, 4 };\r\nunsigned short numDspBases = 8;\r\nunsigned short numUartBases = 4;\r\nunsigned short numDspIrqs = 5;\r\nunsigned short numUartIrqs = 2;\r\nunsigned short dspio_index = 0, uartio_index = 0;\r\nPRINTK_5(TRACE_SMAPI,\r\n"smapi::smapi_set_DSP_cfg entry mwave_3780i_irq %x mwave_3780i_io %x mwave_uart_irq %x mwave_uart_io %x\n",\r\nmwave_3780i_irq, mwave_3780i_io, mwave_uart_irq, mwave_uart_io);\r\nif (mwave_3780i_io) {\r\nfor (i = 0; i < numDspBases; i++) {\r\nif (mwave_3780i_io == ausDspBases[i])\r\nbreak;\r\n}\r\nif (i == numDspBases) {\r\nPRINTK_ERROR(KERN_ERR_MWAVE "smapi::smapi_set_DSP_cfg: Error: Invalid mwave_3780i_io address %x. Aborting.\n", mwave_3780i_io);\r\nreturn bRC;\r\n}\r\ndspio_index = i;\r\n}\r\nif (mwave_3780i_irq) {\r\nfor (i = 0; i < numDspIrqs; i++) {\r\nif (mwave_3780i_irq == ausDspIrqs[i])\r\nbreak;\r\n}\r\nif (i == numDspIrqs) {\r\nPRINTK_ERROR(KERN_ERR_MWAVE "smapi::smapi_set_DSP_cfg: Error: Invalid mwave_3780i_irq %x. Aborting.\n", mwave_3780i_irq);\r\nreturn bRC;\r\n}\r\n}\r\nif (mwave_uart_io) {\r\nfor (i = 0; i < numUartBases; i++) {\r\nif (mwave_uart_io == ausUartBases[i])\r\nbreak;\r\n}\r\nif (i == numUartBases) {\r\nPRINTK_ERROR(KERN_ERR_MWAVE "smapi::smapi_set_DSP_cfg: Error: Invalid mwave_uart_io address %x. Aborting.\n", mwave_uart_io);\r\nreturn bRC;\r\n}\r\nuartio_index = i;\r\n}\r\nif (mwave_uart_irq) {\r\nfor (i = 0; i < numUartIrqs; i++) {\r\nif (mwave_uart_irq == ausUartIrqs[i])\r\nbreak;\r\n}\r\nif (i == numUartIrqs) {\r\nPRINTK_ERROR(KERN_ERR_MWAVE "smapi::smapi_set_DSP_cfg: Error: Invalid mwave_uart_irq %x. Aborting.\n", mwave_uart_irq);\r\nreturn bRC;\r\n}\r\n}\r\nif (mwave_uart_irq || mwave_uart_io) {\r\nbRC = smapi_request(0x1402, 0x0000, 0, 0,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nif (bRC) goto exit_smapi_request_error;\r\nif (usBX & 0x0100) {\r\nif (usCX & 1) {\r\nif ((usSI & 0xFF) == mwave_uart_irq) {\r\n#ifndef MWAVE_FUTZ_WITH_OTHER_DEVICES\r\nPRINTK_ERROR(KERN_ERR_MWAVE\r\n"smapi::smapi_set_DSP_cfg: Serial port A irq %x conflicts with mwave_uart_irq %x\n", usSI & 0xFF, mwave_uart_irq);\r\n#else\r\nPRINTK_3(TRACE_SMAPI,\r\n"smapi::smapi_set_DSP_cfg: Serial port A irq %x conflicts with mwave_uart_irq %x\n", usSI & 0xFF, mwave_uart_irq);\r\n#endif\r\n#ifdef MWAVE_FUTZ_WITH_OTHER_DEVICES\r\nPRINTK_1(TRACE_SMAPI,\r\n"smapi::smapi_set_DSP_cfg Disabling conflicting serial port\n");\r\nbRC = smapi_request(0x1403, 0x0100, 0, usSI,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nif (bRC) goto exit_smapi_request_error;\r\nbRC = smapi_request(0x1402, 0x0000, 0, 0,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nif (bRC) goto exit_smapi_request_error;\r\n#else\r\ngoto exit_conflict;\r\n#endif\r\n} else {\r\nif ((usSI >> 8) == uartio_index) {\r\n#ifndef MWAVE_FUTZ_WITH_OTHER_DEVICES\r\nPRINTK_ERROR(KERN_ERR_MWAVE\r\n"smapi::smapi_set_DSP_cfg: Serial port A base I/O address %x conflicts with mwave uart I/O %x\n", ausUartBases[usSI >> 8], ausUartBases[uartio_index]);\r\n#else\r\nPRINTK_3(TRACE_SMAPI,\r\n"smapi::smapi_set_DSP_cfg: Serial port A base I/O address %x conflicts with mwave uart I/O %x\n", ausUartBases[usSI >> 8], ausUartBases[uartio_index]);\r\n#endif\r\n#ifdef MWAVE_FUTZ_WITH_OTHER_DEVICES\r\nPRINTK_1(TRACE_SMAPI,\r\n"smapi::smapi_set_DSP_cfg Disabling conflicting serial port A\n");\r\nbRC = smapi_request (0x1403, 0x0100, 0, usSI,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nif (bRC) goto exit_smapi_request_error;\r\nbRC = smapi_request (0x1402, 0x0000, 0, 0,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nif (bRC) goto exit_smapi_request_error;\r\n#else\r\ngoto exit_conflict;\r\n#endif\r\n}\r\n}\r\n}\r\n}\r\nbRC = smapi_request(0x1404, 0x0000, 0, 0,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nif (bRC) goto exit_smapi_request_error;\r\nif (usBX & 0x0100) {\r\nif (usCX & 1) {\r\nif ((usSI & 0xFF) == mwave_uart_irq) {\r\n#ifndef MWAVE_FUTZ_WITH_OTHER_DEVICES\r\nPRINTK_ERROR(KERN_ERR_MWAVE\r\n"smapi::smapi_set_DSP_cfg: Serial port B irq %x conflicts with mwave_uart_irq %x\n", usSI & 0xFF, mwave_uart_irq);\r\n#else\r\nPRINTK_3(TRACE_SMAPI,\r\n"smapi::smapi_set_DSP_cfg: Serial port B irq %x conflicts with mwave_uart_irq %x\n", usSI & 0xFF, mwave_uart_irq);\r\n#endif\r\n#ifdef MWAVE_FUTZ_WITH_OTHER_DEVICES\r\nPRINTK_1(TRACE_SMAPI,\r\n"smapi::smapi_set_DSP_cfg Disabling conflicting serial port B\n");\r\nbRC = smapi_request(0x1405, 0x0100, 0, usSI,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nif (bRC) goto exit_smapi_request_error;\r\nbRC = smapi_request(0x1404, 0x0000, 0, 0,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nif (bRC) goto exit_smapi_request_error;\r\n#else\r\ngoto exit_conflict;\r\n#endif\r\n} else {\r\nif ((usSI >> 8) == uartio_index) {\r\n#ifndef MWAVE_FUTZ_WITH_OTHER_DEVICES\r\nPRINTK_ERROR(KERN_ERR_MWAVE\r\n"smapi::smapi_set_DSP_cfg: Serial port B base I/O address %x conflicts with mwave uart I/O %x\n", ausUartBases[usSI >> 8], ausUartBases[uartio_index]);\r\n#else\r\nPRINTK_3(TRACE_SMAPI,\r\n"smapi::smapi_set_DSP_cfg: Serial port B base I/O address %x conflicts with mwave uart I/O %x\n", ausUartBases[usSI >> 8], ausUartBases[uartio_index]);\r\n#endif\r\n#ifdef MWAVE_FUTZ_WITH_OTHER_DEVICES\r\nPRINTK_1 (TRACE_SMAPI,\r\n"smapi::smapi_set_DSP_cfg Disabling conflicting serial port B\n");\r\nbRC = smapi_request (0x1405, 0x0100, 0, usSI,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nif (bRC) goto exit_smapi_request_error;\r\nbRC = smapi_request (0x1404, 0x0000, 0, 0,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nif (bRC) goto exit_smapi_request_error;\r\n#else\r\ngoto exit_conflict;\r\n#endif\r\n}\r\n}\r\n}\r\n}\r\nbRC = smapi_request(0x1700, 0x0000, 0, 0,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nif (bRC) goto exit_smapi_request_error;\r\nbRC = smapi_request(0x1704, 0x0000, 0, 0,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nif (bRC) goto exit_smapi_request_error;\r\nif ((usCX & 0xff) != 0xff) {\r\nif ((usCX & 0xff) == mwave_uart_irq) {\r\n#ifndef MWAVE_FUTZ_WITH_OTHER_DEVICES\r\nPRINTK_ERROR(KERN_ERR_MWAVE\r\n"smapi::smapi_set_DSP_cfg: IR port irq %x conflicts with mwave_uart_irq %x\n", usCX & 0xff, mwave_uart_irq);\r\n#else\r\nPRINTK_3(TRACE_SMAPI,\r\n"smapi::smapi_set_DSP_cfg: IR port irq %x conflicts with mwave_uart_irq %x\n", usCX & 0xff, mwave_uart_irq);\r\n#endif\r\n#ifdef MWAVE_FUTZ_WITH_OTHER_DEVICES\r\nPRINTK_1(TRACE_SMAPI,\r\n"smapi::smapi_set_DSP_cfg Disabling conflicting IR port\n");\r\nbRC = smapi_request(0x1701, 0x0100, 0, 0,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nif (bRC) goto exit_smapi_request_error;\r\nbRC = smapi_request(0x1700, 0, 0, 0,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nif (bRC) goto exit_smapi_request_error;\r\nbRC = smapi_request(0x1705, 0x01ff, 0, usSI,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nif (bRC) goto exit_smapi_request_error;\r\nbRC = smapi_request(0x1704, 0x0000, 0, 0,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nif (bRC) goto exit_smapi_request_error;\r\n#else\r\ngoto exit_conflict;\r\n#endif\r\n} else {\r\nif ((usSI & 0xff) == uartio_index) {\r\n#ifndef MWAVE_FUTZ_WITH_OTHER_DEVICES\r\nPRINTK_ERROR(KERN_ERR_MWAVE\r\n"smapi::smapi_set_DSP_cfg: IR port base I/O address %x conflicts with mwave uart I/O %x\n", ausUartBases[usSI & 0xff], ausUartBases[uartio_index]);\r\n#else\r\nPRINTK_3(TRACE_SMAPI,\r\n"smapi::smapi_set_DSP_cfg: IR port base I/O address %x conflicts with mwave uart I/O %x\n", ausUartBases[usSI & 0xff], ausUartBases[uartio_index]);\r\n#endif\r\n#ifdef MWAVE_FUTZ_WITH_OTHER_DEVICES\r\nPRINTK_1(TRACE_SMAPI,\r\n"smapi::smapi_set_DSP_cfg Disabling conflicting IR port\n");\r\nbRC = smapi_request(0x1701, 0x0100, 0, 0,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nif (bRC) goto exit_smapi_request_error;\r\nbRC = smapi_request(0x1700, 0, 0, 0,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nif (bRC) goto exit_smapi_request_error;\r\nbRC = smapi_request(0x1705, 0x01ff, 0, usSI,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nif (bRC) goto exit_smapi_request_error;\r\nbRC = smapi_request(0x1704, 0x0000, 0, 0,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nif (bRC) goto exit_smapi_request_error;\r\n#else\r\ngoto exit_conflict;\r\n#endif\r\n}\r\n}\r\n}\r\n}\r\nbRC = smapi_request(0x1802, 0x0000, 0, 0,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nif (bRC) goto exit_smapi_request_error;\r\nif (mwave_3780i_io) {\r\nusDI = dspio_index;\r\n}\r\nif (mwave_3780i_irq) {\r\nusSI = (usSI & 0xff00) | mwave_3780i_irq;\r\n}\r\nbRC = smapi_request(0x1803, 0x0101, usDI, usSI,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nif (bRC) goto exit_smapi_request_error;\r\nbRC = smapi_request(0x1804, 0x0000, 0, 0,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nif (bRC) goto exit_smapi_request_error;\r\nif (mwave_uart_io) {\r\nusSI = (usSI & 0x00ff) | (uartio_index << 8);\r\n}\r\nif (mwave_uart_irq) {\r\nusSI = (usSI & 0xff00) | mwave_uart_irq;\r\n}\r\nbRC = smapi_request(0x1805, 0x0101, 0, usSI,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nif (bRC) goto exit_smapi_request_error;\r\nbRC = smapi_request(0x1802, 0x0000, 0, 0,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nif (bRC) goto exit_smapi_request_error;\r\nbRC = smapi_request(0x1804, 0x0000, 0, 0,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nif (bRC) goto exit_smapi_request_error;\r\nPRINTK_1(TRACE_SMAPI, "smapi::smapi_set_DSP_cfg exit\n");\r\nreturn 0;\r\nexit_conflict:\r\nreturn -EIO;\r\nexit_smapi_request_error:\r\nPRINTK_ERROR(KERN_ERR_MWAVE "smapi::smapi_set_DSP_cfg exit on smapi_request error bRC %x\n", bRC);\r\nreturn bRC;\r\n}\r\nint smapi_set_DSP_power_state(BOOLEAN bOn)\r\n{\r\nint bRC = -EIO;\r\nunsigned short usAX, usBX, usCX, usDX, usDI, usSI;\r\nunsigned short usPowerFunction;\r\nPRINTK_2(TRACE_SMAPI, "smapi::smapi_set_DSP_power_state entry bOn %x\n", bOn);\r\nusPowerFunction = (bOn) ? 1 : 0;\r\nbRC = smapi_request(0x4901, 0x0000, 0, usPowerFunction,\r\n&usAX, &usBX, &usCX, &usDX, &usDI, &usSI);\r\nPRINTK_2(TRACE_SMAPI, "smapi::smapi_set_DSP_power_state exit bRC %x\n", bRC);\r\nreturn bRC;\r\n}\r\nint smapi_init(void)\r\n{\r\nint retval = -EIO;\r\nunsigned short usSmapiID = 0;\r\nunsigned long flags;\r\nPRINTK_1(TRACE_SMAPI, "smapi::smapi_init entry\n");\r\nspin_lock_irqsave(&rtc_lock, flags);\r\nusSmapiID = CMOS_READ(0x7C);\r\nusSmapiID |= (CMOS_READ(0x7D) << 8);\r\nspin_unlock_irqrestore(&rtc_lock, flags);\r\nPRINTK_2(TRACE_SMAPI, "smapi::smapi_init usSmapiID %x\n", usSmapiID);\r\nif (usSmapiID == 0x5349) {\r\nspin_lock_irqsave(&rtc_lock, flags);\r\ng_usSmapiPort = CMOS_READ(0x7E);\r\ng_usSmapiPort |= (CMOS_READ(0x7F) << 8);\r\nspin_unlock_irqrestore(&rtc_lock, flags);\r\nif (g_usSmapiPort == 0) {\r\nPRINTK_ERROR("smapi::smapi_init, ERROR unable to read from SMAPI port\n");\r\n} else {\r\nPRINTK_2(TRACE_SMAPI,\r\n"smapi::smapi_init, exit TRUE g_usSmapiPort %x\n",\r\ng_usSmapiPort);\r\nretval = 0;\r\n}\r\n} else {\r\nPRINTK_ERROR("smapi::smapi_init, ERROR invalid usSmapiID\n");\r\nretval = -ENXIO;\r\n}\r\nreturn retval;\r\n}

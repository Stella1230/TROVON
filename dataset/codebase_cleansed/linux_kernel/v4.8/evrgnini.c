acpi_status\r\nacpi_ev_system_memory_region_setup(acpi_handle handle,\r\nu32 function,\r\nvoid *handler_context, void **region_context)\r\n{\r\nunion acpi_operand_object *region_desc =\r\n(union acpi_operand_object *)handle;\r\nstruct acpi_mem_space_context *local_region_context;\r\nACPI_FUNCTION_TRACE(ev_system_memory_region_setup);\r\nif (function == ACPI_REGION_DEACTIVATE) {\r\nif (*region_context) {\r\nlocal_region_context =\r\n(struct acpi_mem_space_context *)*region_context;\r\nif (local_region_context->mapped_length) {\r\nacpi_os_unmap_memory(local_region_context->\r\nmapped_logical_address,\r\nlocal_region_context->\r\nmapped_length);\r\n}\r\nACPI_FREE(local_region_context);\r\n*region_context = NULL;\r\n}\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nlocal_region_context =\r\nACPI_ALLOCATE_ZEROED(sizeof(struct acpi_mem_space_context));\r\nif (!(local_region_context)) {\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\nlocal_region_context->length = region_desc->region.length;\r\nlocal_region_context->address = region_desc->region.address;\r\n*region_context = local_region_context;\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nacpi_status\r\nacpi_ev_io_space_region_setup(acpi_handle handle,\r\nu32 function,\r\nvoid *handler_context, void **region_context)\r\n{\r\nACPI_FUNCTION_TRACE(ev_io_space_region_setup);\r\nif (function == ACPI_REGION_DEACTIVATE) {\r\n*region_context = NULL;\r\n} else {\r\n*region_context = handler_context;\r\n}\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nacpi_status\r\nacpi_ev_pci_config_region_setup(acpi_handle handle,\r\nu32 function,\r\nvoid *handler_context, void **region_context)\r\n{\r\nacpi_status status = AE_OK;\r\nu64 pci_value;\r\nstruct acpi_pci_id *pci_id = *region_context;\r\nunion acpi_operand_object *handler_obj;\r\nstruct acpi_namespace_node *parent_node;\r\nstruct acpi_namespace_node *pci_root_node;\r\nstruct acpi_namespace_node *pci_device_node;\r\nunion acpi_operand_object *region_obj =\r\n(union acpi_operand_object *)handle;\r\nACPI_FUNCTION_TRACE(ev_pci_config_region_setup);\r\nhandler_obj = region_obj->region.handler;\r\nif (!handler_obj) {\r\nACPI_DEBUG_PRINT((ACPI_DB_OPREGION,\r\n"Attempting to init a region %p, with no handler\n",\r\nregion_obj));\r\nreturn_ACPI_STATUS(AE_NOT_EXIST);\r\n}\r\n*region_context = NULL;\r\nif (function == ACPI_REGION_DEACTIVATE) {\r\nif (pci_id) {\r\nACPI_FREE(pci_id);\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}\r\nparent_node = region_obj->region.node->parent;\r\nif (handler_obj->address_space.node == acpi_gbl_root_node) {\r\npci_root_node = parent_node;\r\nwhile (pci_root_node != acpi_gbl_root_node) {\r\nif (acpi_ev_is_pci_root_bridge(pci_root_node)) {\r\nstatus = acpi_install_address_space_handler((acpi_handle)pci_root_node, ACPI_ADR_SPACE_PCI_CONFIG, ACPI_DEFAULT_HANDLER, NULL, NULL);\r\nif (ACPI_FAILURE(status)) {\r\nif (status == AE_SAME_HANDLER) {\r\nstatus = AE_OK;\r\n} else {\r\nACPI_EXCEPTION((AE_INFO, status,\r\n"Could not install PciConfig handler "\r\n"for Root Bridge %4.4s",\r\nacpi_ut_get_node_name\r\n(pci_root_node)));\r\n}\r\n}\r\nbreak;\r\n}\r\npci_root_node = pci_root_node->parent;\r\n}\r\n} else {\r\npci_root_node = handler_obj->address_space.node;\r\n}\r\nif (region_obj->region.flags & AOPOBJ_SETUP_COMPLETE) {\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\npci_id = ACPI_ALLOCATE_ZEROED(sizeof(struct acpi_pci_id));\r\nif (!pci_id) {\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\npci_device_node = region_obj->region.node;\r\nwhile (pci_device_node && (pci_device_node->type != ACPI_TYPE_DEVICE)) {\r\npci_device_node = pci_device_node->parent;\r\n}\r\nif (!pci_device_node) {\r\nACPI_FREE(pci_id);\r\nreturn_ACPI_STATUS(AE_AML_OPERAND_TYPE);\r\n}\r\nstatus = acpi_ut_evaluate_numeric_object(METHOD_NAME__ADR,\r\npci_device_node, &pci_value);\r\nif (ACPI_SUCCESS(status)) {\r\npci_id->device = ACPI_HIWORD(ACPI_LODWORD(pci_value));\r\npci_id->function = ACPI_LOWORD(ACPI_LODWORD(pci_value));\r\n}\r\nstatus = acpi_ut_evaluate_numeric_object(METHOD_NAME__SEG,\r\npci_root_node, &pci_value);\r\nif (ACPI_SUCCESS(status)) {\r\npci_id->segment = ACPI_LOWORD(pci_value);\r\n}\r\nstatus = acpi_ut_evaluate_numeric_object(METHOD_NAME__BBN,\r\npci_root_node, &pci_value);\r\nif (ACPI_SUCCESS(status)) {\r\npci_id->bus = ACPI_LOWORD(pci_value);\r\n}\r\nstatus =\r\nacpi_hw_derive_pci_id(pci_id, pci_root_node,\r\nregion_obj->region.node);\r\nif (ACPI_FAILURE(status)) {\r\nACPI_FREE(pci_id);\r\nreturn_ACPI_STATUS(status);\r\n}\r\n*region_context = pci_id;\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nstatic u8 acpi_ev_is_pci_root_bridge(struct acpi_namespace_node *node)\r\n{\r\nacpi_status status;\r\nstruct acpi_pnp_device_id *hid;\r\nstruct acpi_pnp_device_id_list *cid;\r\nu32 i;\r\nu8 match;\r\nstatus = acpi_ut_execute_HID(node, &hid);\r\nif (ACPI_FAILURE(status)) {\r\nreturn (FALSE);\r\n}\r\nmatch = acpi_ut_is_pci_root_bridge(hid->string);\r\nACPI_FREE(hid);\r\nif (match) {\r\nreturn (TRUE);\r\n}\r\nstatus = acpi_ut_execute_CID(node, &cid);\r\nif (ACPI_FAILURE(status)) {\r\nreturn (FALSE);\r\n}\r\nfor (i = 0; i < cid->count; i++) {\r\nif (acpi_ut_is_pci_root_bridge(cid->ids[i].string)) {\r\nACPI_FREE(cid);\r\nreturn (TRUE);\r\n}\r\n}\r\nACPI_FREE(cid);\r\nreturn (FALSE);\r\n}\r\nacpi_status\r\nacpi_ev_pci_bar_region_setup(acpi_handle handle,\r\nu32 function,\r\nvoid *handler_context, void **region_context)\r\n{\r\nACPI_FUNCTION_TRACE(ev_pci_bar_region_setup);\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nacpi_status\r\nacpi_ev_cmos_region_setup(acpi_handle handle,\r\nu32 function,\r\nvoid *handler_context, void **region_context)\r\n{\r\nACPI_FUNCTION_TRACE(ev_cmos_region_setup);\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nacpi_status\r\nacpi_ev_default_region_setup(acpi_handle handle,\r\nu32 function,\r\nvoid *handler_context, void **region_context)\r\n{\r\nACPI_FUNCTION_TRACE(ev_default_region_setup);\r\nif (function == ACPI_REGION_DEACTIVATE) {\r\n*region_context = NULL;\r\n} else {\r\n*region_context = handler_context;\r\n}\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nacpi_status\r\nacpi_ev_initialize_region(union acpi_operand_object *region_obj,\r\nu8 acpi_ns_locked)\r\n{\r\nunion acpi_operand_object *handler_obj;\r\nunion acpi_operand_object *obj_desc;\r\nacpi_adr_space_type space_id;\r\nstruct acpi_namespace_node *node;\r\nacpi_status status;\r\nACPI_FUNCTION_TRACE_U32(ev_initialize_region, acpi_ns_locked);\r\nif (!region_obj) {\r\nreturn_ACPI_STATUS(AE_BAD_PARAMETER);\r\n}\r\nif (region_obj->common.flags & AOPOBJ_OBJECT_INITIALIZED) {\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nregion_obj->common.flags |= AOPOBJ_OBJECT_INITIALIZED;\r\nnode = region_obj->region.node->parent;\r\nspace_id = region_obj->region.space_id;\r\nwhile (node) {\r\nhandler_obj = NULL;\r\nobj_desc = acpi_ns_get_attached_object(node);\r\nif (obj_desc) {\r\nswitch (node->type) {\r\ncase ACPI_TYPE_DEVICE:\r\ncase ACPI_TYPE_PROCESSOR:\r\ncase ACPI_TYPE_THERMAL:\r\nhandler_obj = obj_desc->common_notify.handler;\r\nbreak;\r\ncase ACPI_TYPE_METHOD:\r\nif (obj_desc->method.\r\ninfo_flags & ACPI_METHOD_MODULE_LEVEL) {\r\nhandler_obj =\r\nobj_desc->method.dispatch.handler;\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nhandler_obj =\r\nacpi_ev_find_region_handler(space_id, handler_obj);\r\nif (handler_obj) {\r\nACPI_DEBUG_PRINT((ACPI_DB_OPREGION,\r\n"Found handler %p for region %p in obj %p\n",\r\nhandler_obj, region_obj,\r\nobj_desc));\r\nstatus =\r\nacpi_ev_attach_region(handler_obj,\r\nregion_obj,\r\nacpi_ns_locked);\r\nif (acpi_ns_locked) {\r\nstatus =\r\nacpi_ut_release_mutex\r\n(ACPI_MTX_NAMESPACE);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\n}\r\nstatus =\r\nacpi_ev_execute_reg_method(region_obj,\r\nACPI_REG_CONNECT);\r\nif (acpi_ns_locked) {\r\nstatus =\r\nacpi_ut_acquire_mutex\r\n(ACPI_MTX_NAMESPACE);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\n}\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\n}\r\nnode = node->parent;\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_OPREGION,\r\n"No handler for RegionType %s(%X) (RegionObj %p)\n",\r\nacpi_ut_get_region_name(space_id), space_id,\r\nregion_obj));\r\nreturn_ACPI_STATUS(AE_NOT_EXIST);\r\n}

static void\r\nintel_get_adjust_train(struct intel_dp *intel_dp,\r\nconst uint8_t link_status[DP_LINK_STATUS_SIZE])\r\n{\r\nuint8_t v = 0;\r\nuint8_t p = 0;\r\nint lane;\r\nuint8_t voltage_max;\r\nuint8_t preemph_max;\r\nfor (lane = 0; lane < intel_dp->lane_count; lane++) {\r\nuint8_t this_v = drm_dp_get_adjust_request_voltage(link_status, lane);\r\nuint8_t this_p = drm_dp_get_adjust_request_pre_emphasis(link_status, lane);\r\nif (this_v > v)\r\nv = this_v;\r\nif (this_p > p)\r\np = this_p;\r\n}\r\nvoltage_max = intel_dp_voltage_max(intel_dp);\r\nif (v >= voltage_max)\r\nv = voltage_max | DP_TRAIN_MAX_SWING_REACHED;\r\npreemph_max = intel_dp_pre_emphasis_max(intel_dp, v);\r\nif (p >= preemph_max)\r\np = preemph_max | DP_TRAIN_MAX_PRE_EMPHASIS_REACHED;\r\nfor (lane = 0; lane < 4; lane++)\r\nintel_dp->train_set[lane] = v | p;\r\n}\r\nstatic bool\r\nintel_dp_set_link_train(struct intel_dp *intel_dp,\r\nuint8_t dp_train_pat)\r\n{\r\nuint8_t buf[sizeof(intel_dp->train_set) + 1];\r\nint ret, len;\r\nintel_dp_program_link_training_pattern(intel_dp, dp_train_pat);\r\nbuf[0] = dp_train_pat;\r\nif ((dp_train_pat & DP_TRAINING_PATTERN_MASK) ==\r\nDP_TRAINING_PATTERN_DISABLE) {\r\nlen = 1;\r\n} else {\r\nmemcpy(buf + 1, intel_dp->train_set, intel_dp->lane_count);\r\nlen = intel_dp->lane_count + 1;\r\n}\r\nret = drm_dp_dpcd_write(&intel_dp->aux, DP_TRAINING_PATTERN_SET,\r\nbuf, len);\r\nreturn ret == len;\r\n}\r\nstatic bool\r\nintel_dp_reset_link_train(struct intel_dp *intel_dp,\r\nuint8_t dp_train_pat)\r\n{\r\nmemset(intel_dp->train_set, 0, sizeof(intel_dp->train_set));\r\nintel_dp_set_signal_levels(intel_dp);\r\nreturn intel_dp_set_link_train(intel_dp, dp_train_pat);\r\n}\r\nstatic bool\r\nintel_dp_update_link_train(struct intel_dp *intel_dp)\r\n{\r\nint ret;\r\nintel_dp_set_signal_levels(intel_dp);\r\nret = drm_dp_dpcd_write(&intel_dp->aux, DP_TRAINING_LANE0_SET,\r\nintel_dp->train_set, intel_dp->lane_count);\r\nreturn ret == intel_dp->lane_count;\r\n}\r\nstatic void\r\nintel_dp_link_training_clock_recovery(struct intel_dp *intel_dp)\r\n{\r\nint i;\r\nuint8_t voltage;\r\nint voltage_tries, loop_tries;\r\nuint8_t link_config[2];\r\nuint8_t link_bw, rate_select;\r\nif (intel_dp->prepare_link_retrain)\r\nintel_dp->prepare_link_retrain(intel_dp);\r\nintel_dp_compute_rate(intel_dp, intel_dp->link_rate,\r\n&link_bw, &rate_select);\r\nlink_config[0] = link_bw;\r\nlink_config[1] = intel_dp->lane_count;\r\nif (drm_dp_enhanced_frame_cap(intel_dp->dpcd))\r\nlink_config[1] |= DP_LANE_COUNT_ENHANCED_FRAME_EN;\r\ndrm_dp_dpcd_write(&intel_dp->aux, DP_LINK_BW_SET, link_config, 2);\r\nif (intel_dp->num_sink_rates)\r\ndrm_dp_dpcd_write(&intel_dp->aux, DP_LINK_RATE_SET,\r\n&rate_select, 1);\r\nlink_config[0] = 0;\r\nlink_config[1] = DP_SET_ANSI_8B10B;\r\ndrm_dp_dpcd_write(&intel_dp->aux, DP_DOWNSPREAD_CTRL, link_config, 2);\r\nintel_dp->DP |= DP_PORT_EN;\r\nif (!intel_dp_reset_link_train(intel_dp,\r\nDP_TRAINING_PATTERN_1 |\r\nDP_LINK_SCRAMBLING_DISABLE)) {\r\nDRM_ERROR("failed to enable link training\n");\r\nreturn;\r\n}\r\nvoltage = 0xff;\r\nvoltage_tries = 0;\r\nloop_tries = 0;\r\nfor (;;) {\r\nuint8_t link_status[DP_LINK_STATUS_SIZE];\r\ndrm_dp_link_train_clock_recovery_delay(intel_dp->dpcd);\r\nif (!intel_dp_get_link_status(intel_dp, link_status)) {\r\nDRM_ERROR("failed to get link status\n");\r\nbreak;\r\n}\r\nif (drm_dp_clock_recovery_ok(link_status, intel_dp->lane_count)) {\r\nDRM_DEBUG_KMS("clock recovery OK\n");\r\nbreak;\r\n}\r\nfor (i = 0; i < intel_dp->lane_count; i++)\r\nif ((intel_dp->train_set[i] & DP_TRAIN_MAX_SWING_REACHED) == 0)\r\nbreak;\r\nif (i == intel_dp->lane_count) {\r\n++loop_tries;\r\nif (loop_tries == 5) {\r\nDRM_ERROR("too many full retries, give up\n");\r\nbreak;\r\n}\r\nintel_dp_reset_link_train(intel_dp,\r\nDP_TRAINING_PATTERN_1 |\r\nDP_LINK_SCRAMBLING_DISABLE);\r\nvoltage_tries = 0;\r\ncontinue;\r\n}\r\nif ((intel_dp->train_set[0] & DP_TRAIN_VOLTAGE_SWING_MASK) == voltage) {\r\n++voltage_tries;\r\nif (voltage_tries == 5) {\r\nDRM_ERROR("too many voltage retries, give up\n");\r\nbreak;\r\n}\r\n} else\r\nvoltage_tries = 0;\r\nvoltage = intel_dp->train_set[0] & DP_TRAIN_VOLTAGE_SWING_MASK;\r\nintel_get_adjust_train(intel_dp, link_status);\r\nif (!intel_dp_update_link_train(intel_dp)) {\r\nDRM_ERROR("failed to update link training\n");\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic u32 intel_dp_training_pattern(struct intel_dp *intel_dp)\r\n{\r\nu32 training_pattern = DP_TRAINING_PATTERN_2;\r\nbool source_tps3, sink_tps3;\r\nsource_tps3 = intel_dp_source_supports_hbr2(intel_dp);\r\nsink_tps3 = drm_dp_tps3_supported(intel_dp->dpcd);\r\nif (source_tps3 && sink_tps3) {\r\ntraining_pattern = DP_TRAINING_PATTERN_3;\r\n} else if (intel_dp->link_rate == 540000) {\r\nif (!source_tps3)\r\nDRM_DEBUG_KMS("5.4 Gbps link rate without source HBR2/TPS3 support\n");\r\nif (!sink_tps3)\r\nDRM_DEBUG_KMS("5.4 Gbps link rate without sink TPS3 support\n");\r\n}\r\nreturn training_pattern;\r\n}\r\nstatic void\r\nintel_dp_link_training_channel_equalization(struct intel_dp *intel_dp)\r\n{\r\nbool channel_eq = false;\r\nint tries, cr_tries;\r\nu32 training_pattern;\r\ntraining_pattern = intel_dp_training_pattern(intel_dp);\r\nif (!intel_dp_set_link_train(intel_dp,\r\ntraining_pattern |\r\nDP_LINK_SCRAMBLING_DISABLE)) {\r\nDRM_ERROR("failed to start channel equalization\n");\r\nreturn;\r\n}\r\ntries = 0;\r\ncr_tries = 0;\r\nchannel_eq = false;\r\nfor (;;) {\r\nuint8_t link_status[DP_LINK_STATUS_SIZE];\r\nif (cr_tries > 5) {\r\nDRM_ERROR("failed to train DP, aborting\n");\r\nbreak;\r\n}\r\ndrm_dp_link_train_channel_eq_delay(intel_dp->dpcd);\r\nif (!intel_dp_get_link_status(intel_dp, link_status)) {\r\nDRM_ERROR("failed to get link status\n");\r\nbreak;\r\n}\r\nif (!drm_dp_clock_recovery_ok(link_status,\r\nintel_dp->lane_count)) {\r\nintel_dp_link_training_clock_recovery(intel_dp);\r\nintel_dp_set_link_train(intel_dp,\r\ntraining_pattern |\r\nDP_LINK_SCRAMBLING_DISABLE);\r\ncr_tries++;\r\ncontinue;\r\n}\r\nif (drm_dp_channel_eq_ok(link_status,\r\nintel_dp->lane_count)) {\r\nchannel_eq = true;\r\nbreak;\r\n}\r\nif (tries > 5) {\r\nintel_dp_link_training_clock_recovery(intel_dp);\r\nintel_dp_set_link_train(intel_dp,\r\ntraining_pattern |\r\nDP_LINK_SCRAMBLING_DISABLE);\r\ntries = 0;\r\ncr_tries++;\r\ncontinue;\r\n}\r\nintel_get_adjust_train(intel_dp, link_status);\r\nif (!intel_dp_update_link_train(intel_dp)) {\r\nDRM_ERROR("failed to update link training\n");\r\nbreak;\r\n}\r\n++tries;\r\n}\r\nintel_dp_set_idle_link_train(intel_dp);\r\nif (channel_eq)\r\nDRM_DEBUG_KMS("Channel EQ done. DP Training successful\n");\r\n}\r\nvoid intel_dp_stop_link_train(struct intel_dp *intel_dp)\r\n{\r\nintel_dp_set_link_train(intel_dp,\r\nDP_TRAINING_PATTERN_DISABLE);\r\n}\r\nvoid\r\nintel_dp_start_link_train(struct intel_dp *intel_dp)\r\n{\r\nintel_dp_link_training_clock_recovery(intel_dp);\r\nintel_dp_link_training_channel_equalization(intel_dp);\r\n}

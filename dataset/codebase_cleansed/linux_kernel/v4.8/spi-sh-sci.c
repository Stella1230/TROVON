static inline void setbits(struct sh_sci_spi *sp, int bits, int on)\r\n{\r\nif (on)\r\nsp->val |= bits;\r\nelse\r\nsp->val &= ~bits;\r\niowrite8(sp->val, SCSPTR(sp));\r\n}\r\nstatic inline void setsck(struct spi_device *dev, int on)\r\n{\r\nsetbits(spi_master_get_devdata(dev->master), PIN_SCK, on);\r\n}\r\nstatic inline void setmosi(struct spi_device *dev, int on)\r\n{\r\nsetbits(spi_master_get_devdata(dev->master), PIN_TXD, on);\r\n}\r\nstatic inline u32 getmiso(struct spi_device *dev)\r\n{\r\nstruct sh_sci_spi *sp = spi_master_get_devdata(dev->master);\r\nreturn (ioread8(SCSPTR(sp)) & PIN_RXD) ? 1 : 0;\r\n}\r\nstatic u32 sh_sci_spi_txrx_mode0(struct spi_device *spi,\r\nunsigned nsecs, u32 word, u8 bits)\r\n{\r\nreturn bitbang_txrx_be_cpha0(spi, nsecs, 0, 0, word, bits);\r\n}\r\nstatic u32 sh_sci_spi_txrx_mode1(struct spi_device *spi,\r\nunsigned nsecs, u32 word, u8 bits)\r\n{\r\nreturn bitbang_txrx_be_cpha1(spi, nsecs, 0, 0, word, bits);\r\n}\r\nstatic u32 sh_sci_spi_txrx_mode2(struct spi_device *spi,\r\nunsigned nsecs, u32 word, u8 bits)\r\n{\r\nreturn bitbang_txrx_be_cpha0(spi, nsecs, 1, 0, word, bits);\r\n}\r\nstatic u32 sh_sci_spi_txrx_mode3(struct spi_device *spi,\r\nunsigned nsecs, u32 word, u8 bits)\r\n{\r\nreturn bitbang_txrx_be_cpha1(spi, nsecs, 1, 0, word, bits);\r\n}\r\nstatic void sh_sci_spi_chipselect(struct spi_device *dev, int value)\r\n{\r\nstruct sh_sci_spi *sp = spi_master_get_devdata(dev->master);\r\nif (sp->info->chip_select)\r\n(sp->info->chip_select)(sp->info, dev->chip_select, value);\r\n}\r\nstatic int sh_sci_spi_probe(struct platform_device *dev)\r\n{\r\nstruct resource *r;\r\nstruct spi_master *master;\r\nstruct sh_sci_spi *sp;\r\nint ret;\r\nmaster = spi_alloc_master(&dev->dev, sizeof(struct sh_sci_spi));\r\nif (master == NULL) {\r\ndev_err(&dev->dev, "failed to allocate spi master\n");\r\nret = -ENOMEM;\r\ngoto err0;\r\n}\r\nsp = spi_master_get_devdata(master);\r\nplatform_set_drvdata(dev, sp);\r\nsp->info = dev_get_platdata(&dev->dev);\r\nif (!sp->info) {\r\ndev_err(&dev->dev, "platform data is missing\n");\r\nret = -ENOENT;\r\ngoto err1;\r\n}\r\nsp->bitbang.master = master;\r\nsp->bitbang.master->bus_num = sp->info->bus_num;\r\nsp->bitbang.master->num_chipselect = sp->info->num_chipselect;\r\nsp->bitbang.chipselect = sh_sci_spi_chipselect;\r\nsp->bitbang.txrx_word[SPI_MODE_0] = sh_sci_spi_txrx_mode0;\r\nsp->bitbang.txrx_word[SPI_MODE_1] = sh_sci_spi_txrx_mode1;\r\nsp->bitbang.txrx_word[SPI_MODE_2] = sh_sci_spi_txrx_mode2;\r\nsp->bitbang.txrx_word[SPI_MODE_3] = sh_sci_spi_txrx_mode3;\r\nr = platform_get_resource(dev, IORESOURCE_MEM, 0);\r\nif (r == NULL) {\r\nret = -ENOENT;\r\ngoto err1;\r\n}\r\nsp->membase = ioremap(r->start, resource_size(r));\r\nif (!sp->membase) {\r\nret = -ENXIO;\r\ngoto err1;\r\n}\r\nsp->val = ioread8(SCSPTR(sp));\r\nsetbits(sp, PIN_INIT, 1);\r\nret = spi_bitbang_start(&sp->bitbang);\r\nif (!ret)\r\nreturn 0;\r\nsetbits(sp, PIN_INIT, 0);\r\niounmap(sp->membase);\r\nerr1:\r\nspi_master_put(sp->bitbang.master);\r\nerr0:\r\nreturn ret;\r\n}\r\nstatic int sh_sci_spi_remove(struct platform_device *dev)\r\n{\r\nstruct sh_sci_spi *sp = platform_get_drvdata(dev);\r\nspi_bitbang_stop(&sp->bitbang);\r\nsetbits(sp, PIN_INIT, 0);\r\niounmap(sp->membase);\r\nspi_master_put(sp->bitbang.master);\r\nreturn 0;\r\n}

void reqsk_queue_alloc(struct request_sock_queue *queue)\r\n{\r\nspin_lock_init(&queue->rskq_lock);\r\nspin_lock_init(&queue->fastopenq.lock);\r\nqueue->fastopenq.rskq_rst_head = NULL;\r\nqueue->fastopenq.rskq_rst_tail = NULL;\r\nqueue->fastopenq.qlen = 0;\r\nqueue->rskq_accept_head = NULL;\r\n}\r\nvoid reqsk_fastopen_remove(struct sock *sk, struct request_sock *req,\r\nbool reset)\r\n{\r\nstruct sock *lsk = req->rsk_listener;\r\nstruct fastopen_queue *fastopenq;\r\nfastopenq = &inet_csk(lsk)->icsk_accept_queue.fastopenq;\r\ntcp_sk(sk)->fastopen_rsk = NULL;\r\nspin_lock_bh(&fastopenq->lock);\r\nfastopenq->qlen--;\r\ntcp_rsk(req)->tfo_listener = false;\r\nif (req->sk)\r\ngoto out;\r\nif (!reset || lsk->sk_state != TCP_LISTEN) {\r\nspin_unlock_bh(&fastopenq->lock);\r\nreqsk_put(req);\r\nreturn;\r\n}\r\nreq->rsk_timer.expires = jiffies + 60*HZ;\r\nif (fastopenq->rskq_rst_head == NULL)\r\nfastopenq->rskq_rst_head = req;\r\nelse\r\nfastopenq->rskq_rst_tail->dl_next = req;\r\nreq->dl_next = NULL;\r\nfastopenq->rskq_rst_tail = req;\r\nfastopenq->qlen++;\r\nout:\r\nspin_unlock_bh(&fastopenq->lock);\r\n}

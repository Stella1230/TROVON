static void vf610_dac_init(struct vf610_dac *info)\r\n{\r\nint val;\r\ninfo->conv_mode = VF610_DAC_CONV_LOW_POWER;\r\nval = VF610_DAC_DACEN | VF610_DAC_DACRFS |\r\nVF610_DAC_LPEN;\r\nwritel(val, info->regs + VF610_DACx_STATCTRL);\r\n}\r\nstatic void vf610_dac_exit(struct vf610_dac *info)\r\n{\r\nint val;\r\nval = readl(info->regs + VF610_DACx_STATCTRL);\r\nval &= ~VF610_DAC_DACEN;\r\nwritel(val, info->regs + VF610_DACx_STATCTRL);\r\n}\r\nstatic int vf610_set_conversion_mode(struct iio_dev *indio_dev,\r\nconst struct iio_chan_spec *chan,\r\nunsigned int mode)\r\n{\r\nstruct vf610_dac *info = iio_priv(indio_dev);\r\nint val;\r\nmutex_lock(&indio_dev->mlock);\r\ninfo->conv_mode = mode;\r\nval = readl(info->regs + VF610_DACx_STATCTRL);\r\nif (mode)\r\nval |= VF610_DAC_LPEN;\r\nelse\r\nval &= ~VF610_DAC_LPEN;\r\nwritel(val, info->regs + VF610_DACx_STATCTRL);\r\nmutex_unlock(&indio_dev->mlock);\r\nreturn 0;\r\n}\r\nstatic int vf610_get_conversion_mode(struct iio_dev *indio_dev,\r\nconst struct iio_chan_spec *chan)\r\n{\r\nstruct vf610_dac *info = iio_priv(indio_dev);\r\nreturn info->conv_mode;\r\n}\r\nstatic int vf610_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint *val, int *val2,\r\nlong mask)\r\n{\r\nstruct vf610_dac *info = iio_priv(indio_dev);\r\nswitch (mask) {\r\ncase IIO_CHAN_INFO_RAW:\r\n*val = VF610_DAC_DAT0(readl(info->regs));\r\nreturn IIO_VAL_INT;\r\ncase IIO_CHAN_INFO_SCALE:\r\n*val = 3300 ;\r\n*val2 = 12;\r\nreturn IIO_VAL_FRACTIONAL_LOG2;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic int vf610_write_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint val, int val2,\r\nlong mask)\r\n{\r\nstruct vf610_dac *info = iio_priv(indio_dev);\r\nswitch (mask) {\r\ncase IIO_CHAN_INFO_RAW:\r\nmutex_lock(&indio_dev->mlock);\r\nwritel(VF610_DAC_DAT0(val), info->regs);\r\nmutex_unlock(&indio_dev->mlock);\r\nreturn 0;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic int vf610_dac_probe(struct platform_device *pdev)\r\n{\r\nstruct iio_dev *indio_dev;\r\nstruct vf610_dac *info;\r\nstruct resource *mem;\r\nint ret;\r\nindio_dev = devm_iio_device_alloc(&pdev->dev,\r\nsizeof(struct vf610_dac));\r\nif (!indio_dev) {\r\ndev_err(&pdev->dev, "Failed allocating iio device\n");\r\nreturn -ENOMEM;\r\n}\r\ninfo = iio_priv(indio_dev);\r\ninfo->dev = &pdev->dev;\r\nmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ninfo->regs = devm_ioremap_resource(&pdev->dev, mem);\r\nif (IS_ERR(info->regs))\r\nreturn PTR_ERR(info->regs);\r\ninfo->clk = devm_clk_get(&pdev->dev, "dac");\r\nif (IS_ERR(info->clk)) {\r\ndev_err(&pdev->dev, "Failed getting clock, err = %ld\n",\r\nPTR_ERR(info->clk));\r\nreturn PTR_ERR(info->clk);\r\n}\r\nplatform_set_drvdata(pdev, indio_dev);\r\nindio_dev->name = dev_name(&pdev->dev);\r\nindio_dev->dev.parent = &pdev->dev;\r\nindio_dev->dev.of_node = pdev->dev.of_node;\r\nindio_dev->info = &vf610_dac_iio_info;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nindio_dev->channels = vf610_dac_iio_channels;\r\nindio_dev->num_channels = ARRAY_SIZE(vf610_dac_iio_channels);\r\nret = clk_prepare_enable(info->clk);\r\nif (ret) {\r\ndev_err(&pdev->dev,\r\n"Could not prepare or enable the clock\n");\r\nreturn ret;\r\n}\r\nvf610_dac_init(info);\r\nret = iio_device_register(indio_dev);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Couldn't register the device\n");\r\ngoto error_iio_device_register;\r\n}\r\nreturn 0;\r\nerror_iio_device_register:\r\nclk_disable_unprepare(info->clk);\r\nreturn ret;\r\n}\r\nstatic int vf610_dac_remove(struct platform_device *pdev)\r\n{\r\nstruct iio_dev *indio_dev = platform_get_drvdata(pdev);\r\nstruct vf610_dac *info = iio_priv(indio_dev);\r\niio_device_unregister(indio_dev);\r\nvf610_dac_exit(info);\r\nclk_disable_unprepare(info->clk);\r\nreturn 0;\r\n}\r\nstatic int vf610_dac_suspend(struct device *dev)\r\n{\r\nstruct iio_dev *indio_dev = dev_get_drvdata(dev);\r\nstruct vf610_dac *info = iio_priv(indio_dev);\r\nvf610_dac_exit(info);\r\nclk_disable_unprepare(info->clk);\r\nreturn 0;\r\n}\r\nstatic int vf610_dac_resume(struct device *dev)\r\n{\r\nstruct iio_dev *indio_dev = dev_get_drvdata(dev);\r\nstruct vf610_dac *info = iio_priv(indio_dev);\r\nint ret;\r\nret = clk_prepare_enable(info->clk);\r\nif (ret)\r\nreturn ret;\r\nvf610_dac_init(info);\r\nreturn 0;\r\n}

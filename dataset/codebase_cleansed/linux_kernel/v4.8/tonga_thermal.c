int tonga_fan_ctrl_get_fan_speed_info(struct pp_hwmgr *hwmgr, struct phm_fan_speed_info *fan_speed_info)\r\n{\r\nif (hwmgr->thermal_controller.fanInfo.bNoFan)\r\nreturn 0;\r\nfan_speed_info->supports_percent_read = true;\r\nfan_speed_info->supports_percent_write = true;\r\nfan_speed_info->min_percent = 0;\r\nfan_speed_info->max_percent = 100;\r\nif (0 != hwmgr->thermal_controller.fanInfo.ucTachometerPulsesPerRevolution) {\r\nfan_speed_info->supports_rpm_read = true;\r\nfan_speed_info->supports_rpm_write = true;\r\nfan_speed_info->min_rpm = hwmgr->thermal_controller.fanInfo.ulMinRPM;\r\nfan_speed_info->max_rpm = hwmgr->thermal_controller.fanInfo.ulMaxRPM;\r\n} else {\r\nfan_speed_info->min_rpm = 0;\r\nfan_speed_info->max_rpm = 0;\r\n}\r\nreturn 0;\r\n}\r\nint tonga_fan_ctrl_get_fan_speed_percent(struct pp_hwmgr *hwmgr, uint32_t *speed)\r\n{\r\nuint32_t duty100;\r\nuint32_t duty;\r\nuint64_t tmp64;\r\nif (hwmgr->thermal_controller.fanInfo.bNoFan)\r\nreturn 0;\r\nduty100 = PHM_READ_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC, CG_FDO_CTRL1, FMAX_DUTY100);\r\nduty = PHM_READ_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC, CG_THERMAL_STATUS, FDO_PWM_DUTY);\r\nif (0 == duty100)\r\nreturn -EINVAL;\r\ntmp64 = (uint64_t)duty * 100;\r\ndo_div(tmp64, duty100);\r\n*speed = (uint32_t)tmp64;\r\nif (*speed > 100)\r\n*speed = 100;\r\nreturn 0;\r\n}\r\nint tonga_fan_ctrl_get_fan_speed_rpm(struct pp_hwmgr *hwmgr, uint32_t *speed)\r\n{\r\nreturn 0;\r\n}\r\nint tonga_fan_ctrl_set_static_mode(struct pp_hwmgr *hwmgr, uint32_t mode)\r\n{\r\nif (hwmgr->fan_ctrl_is_in_default_mode) {\r\nhwmgr->fan_ctrl_default_mode = PHM_READ_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC, CG_FDO_CTRL2, FDO_PWM_MODE);\r\nhwmgr->tmin = PHM_READ_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC, CG_FDO_CTRL2, TMIN);\r\nhwmgr->fan_ctrl_is_in_default_mode = false;\r\n}\r\nPHM_WRITE_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC, CG_FDO_CTRL2, TMIN, 0);\r\nPHM_WRITE_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC, CG_FDO_CTRL2, FDO_PWM_MODE, mode);\r\nreturn 0;\r\n}\r\nint tonga_fan_ctrl_set_default_mode(struct pp_hwmgr *hwmgr)\r\n{\r\nif (!hwmgr->fan_ctrl_is_in_default_mode) {\r\nPHM_WRITE_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC, CG_FDO_CTRL2, FDO_PWM_MODE, hwmgr->fan_ctrl_default_mode);\r\nPHM_WRITE_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC, CG_FDO_CTRL2, TMIN, hwmgr->tmin);\r\nhwmgr->fan_ctrl_is_in_default_mode = true;\r\n}\r\nreturn 0;\r\n}\r\nint tonga_fan_ctrl_start_smc_fan_control(struct pp_hwmgr *hwmgr)\r\n{\r\nint result;\r\nif (phm_cap_enabled(hwmgr->platform_descriptor.platformCaps, PHM_PlatformCaps_ODFuzzyFanControlSupport)) {\r\ncgs_write_register(hwmgr->device, mmSMC_MSG_ARG_0, FAN_CONTROL_FUZZY);\r\nresult = (smum_send_msg_to_smc(hwmgr->smumgr, PPSMC_StartFanControl) == 0) ? 0 : -EINVAL;\r\n} else {\r\ncgs_write_register(hwmgr->device, mmSMC_MSG_ARG_0, FAN_CONTROL_TABLE);\r\nresult = (smum_send_msg_to_smc(hwmgr->smumgr, PPSMC_StartFanControl) == 0) ? 0 : -EINVAL;\r\n}\r\nreturn result;\r\n}\r\nint tonga_fan_ctrl_stop_smc_fan_control(struct pp_hwmgr *hwmgr)\r\n{\r\nreturn (smum_send_msg_to_smc(hwmgr->smumgr, PPSMC_StopFanControl) == 0) ? 0 : -EINVAL;\r\n}\r\nint tonga_fan_ctrl_set_fan_speed_percent(struct pp_hwmgr *hwmgr, uint32_t speed)\r\n{\r\nuint32_t duty100;\r\nuint32_t duty;\r\nuint64_t tmp64;\r\nif (hwmgr->thermal_controller.fanInfo.bNoFan)\r\nreturn -EINVAL;\r\nif (speed > 100)\r\nspeed = 100;\r\nif (phm_cap_enabled(hwmgr->platform_descriptor.platformCaps, PHM_PlatformCaps_MicrocodeFanControl))\r\ntonga_fan_ctrl_stop_smc_fan_control(hwmgr);\r\nduty100 = PHM_READ_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC, CG_FDO_CTRL1, FMAX_DUTY100);\r\nif (0 == duty100)\r\nreturn -EINVAL;\r\ntmp64 = (uint64_t)speed * duty100;\r\ndo_div(tmp64, 100);\r\nduty = (uint32_t)tmp64;\r\nPHM_WRITE_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC, CG_FDO_CTRL0, FDO_STATIC_DUTY, duty);\r\nreturn tonga_fan_ctrl_set_static_mode(hwmgr, FDO_PWM_MODE_STATIC);\r\n}\r\nint tonga_fan_ctrl_reset_fan_speed_to_default(struct pp_hwmgr *hwmgr)\r\n{\r\nint result;\r\nif (hwmgr->thermal_controller.fanInfo.bNoFan)\r\nreturn 0;\r\nif (phm_cap_enabled(hwmgr->platform_descriptor.platformCaps, PHM_PlatformCaps_MicrocodeFanControl)) {\r\nresult = tonga_fan_ctrl_set_static_mode(hwmgr, FDO_PWM_MODE_STATIC);\r\nif (0 == result)\r\nresult = tonga_fan_ctrl_start_smc_fan_control(hwmgr);\r\n} else\r\nresult = tonga_fan_ctrl_set_default_mode(hwmgr);\r\nreturn result;\r\n}\r\nint tonga_fan_ctrl_set_fan_speed_rpm(struct pp_hwmgr *hwmgr, uint32_t speed)\r\n{\r\nreturn 0;\r\n}\r\nint tonga_thermal_get_temperature(struct pp_hwmgr *hwmgr)\r\n{\r\nint temp;\r\ntemp = PHM_READ_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC, CG_MULT_THERMAL_STATUS, CTF_TEMP);\r\nif (0 != (0x200 & temp))\r\ntemp = TONGA_THERMAL_MAXIMUM_TEMP_READING;\r\nelse\r\ntemp = (temp & 0x1ff);\r\ntemp = temp * PP_TEMPERATURE_UNITS_PER_CENTIGRADES;\r\nreturn temp;\r\n}\r\nstatic int tonga_thermal_set_temperature_range(struct pp_hwmgr *hwmgr, uint32_t low_temp, uint32_t high_temp)\r\n{\r\nuint32_t low = TONGA_THERMAL_MINIMUM_ALERT_TEMP * PP_TEMPERATURE_UNITS_PER_CENTIGRADES;\r\nuint32_t high = TONGA_THERMAL_MAXIMUM_ALERT_TEMP * PP_TEMPERATURE_UNITS_PER_CENTIGRADES;\r\nif (low < low_temp)\r\nlow = low_temp;\r\nif (high > high_temp)\r\nhigh = high_temp;\r\nif (low > high)\r\nreturn -EINVAL;\r\nPHM_WRITE_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC, CG_THERMAL_INT, DIG_THERM_INTH, (high / PP_TEMPERATURE_UNITS_PER_CENTIGRADES));\r\nPHM_WRITE_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC, CG_THERMAL_INT, DIG_THERM_INTL, (low / PP_TEMPERATURE_UNITS_PER_CENTIGRADES));\r\nPHM_WRITE_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC, CG_THERMAL_CTRL, DIG_THERM_DPM, (high / PP_TEMPERATURE_UNITS_PER_CENTIGRADES));\r\nreturn 0;\r\n}\r\nstatic int tonga_thermal_initialize(struct pp_hwmgr *hwmgr)\r\n{\r\nif (0 != hwmgr->thermal_controller.fanInfo.ucTachometerPulsesPerRevolution)\r\nPHM_WRITE_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC,\r\nCG_TACH_CTRL, EDGE_PER_REV,\r\nhwmgr->thermal_controller.fanInfo.ucTachometerPulsesPerRevolution - 1);\r\nPHM_WRITE_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC, CG_FDO_CTRL2, TACH_PWM_RESP_RATE, 0x28);\r\nreturn 0;\r\n}\r\nstatic int tonga_thermal_enable_alert(struct pp_hwmgr *hwmgr)\r\n{\r\nuint32_t alert;\r\nalert = PHM_READ_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC, CG_THERMAL_INT, THERM_INT_MASK);\r\nalert &= ~(TONGA_THERMAL_HIGH_ALERT_MASK | TONGA_THERMAL_LOW_ALERT_MASK);\r\nPHM_WRITE_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC, CG_THERMAL_INT, THERM_INT_MASK, alert);\r\nreturn (smum_send_msg_to_smc(hwmgr->smumgr, PPSMC_MSG_Thermal_Cntl_Enable) == 0) ? 0 : -1;\r\n}\r\nstatic int tonga_thermal_disable_alert(struct pp_hwmgr *hwmgr)\r\n{\r\nuint32_t alert;\r\nalert = PHM_READ_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC, CG_THERMAL_INT, THERM_INT_MASK);\r\nalert |= (TONGA_THERMAL_HIGH_ALERT_MASK | TONGA_THERMAL_LOW_ALERT_MASK);\r\nPHM_WRITE_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC, CG_THERMAL_INT, THERM_INT_MASK, alert);\r\nreturn (smum_send_msg_to_smc(hwmgr->smumgr, PPSMC_MSG_Thermal_Cntl_Disable) == 0) ? 0 : -1;\r\n}\r\nint tonga_thermal_stop_thermal_controller(struct pp_hwmgr *hwmgr)\r\n{\r\nint result = tonga_thermal_disable_alert(hwmgr);\r\nif (hwmgr->thermal_controller.fanInfo.bNoFan)\r\ntonga_fan_ctrl_set_default_mode(hwmgr);\r\nreturn result;\r\n}\r\nint tf_tonga_thermal_setup_fan_table(struct pp_hwmgr *hwmgr, void *input, void *output, void *storage, int result)\r\n{\r\nstruct tonga_hwmgr *data = (struct tonga_hwmgr *)(hwmgr->backend);\r\nSMU72_Discrete_FanTable fan_table = { FDO_MODE_HARDWARE };\r\nuint32_t duty100;\r\nuint32_t t_diff1, t_diff2, pwm_diff1, pwm_diff2;\r\nuint16_t fdo_min, slope1, slope2;\r\nuint32_t reference_clock;\r\nint res;\r\nuint64_t tmp64;\r\nif (!phm_cap_enabled(hwmgr->platform_descriptor.platformCaps, PHM_PlatformCaps_MicrocodeFanControl))\r\nreturn 0;\r\nif (0 == data->fan_table_start) {\r\nphm_cap_unset(hwmgr->platform_descriptor.platformCaps, PHM_PlatformCaps_MicrocodeFanControl);\r\nreturn 0;\r\n}\r\nduty100 = PHM_READ_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC, CG_FDO_CTRL1, FMAX_DUTY100);\r\nif (0 == duty100) {\r\nphm_cap_unset(hwmgr->platform_descriptor.platformCaps, PHM_PlatformCaps_MicrocodeFanControl);\r\nreturn 0;\r\n}\r\ntmp64 = hwmgr->thermal_controller.advanceFanControlParameters.usPWMMin * duty100;\r\ndo_div(tmp64, 10000);\r\nfdo_min = (uint16_t)tmp64;\r\nt_diff1 = hwmgr->thermal_controller.advanceFanControlParameters.usTMed - hwmgr->thermal_controller.advanceFanControlParameters.usTMin;\r\nt_diff2 = hwmgr->thermal_controller.advanceFanControlParameters.usTHigh - hwmgr->thermal_controller.advanceFanControlParameters.usTMed;\r\npwm_diff1 = hwmgr->thermal_controller.advanceFanControlParameters.usPWMMed - hwmgr->thermal_controller.advanceFanControlParameters.usPWMMin;\r\npwm_diff2 = hwmgr->thermal_controller.advanceFanControlParameters.usPWMHigh - hwmgr->thermal_controller.advanceFanControlParameters.usPWMMed;\r\nslope1 = (uint16_t)((50 + ((16 * duty100 * pwm_diff1) / t_diff1)) / 100);\r\nslope2 = (uint16_t)((50 + ((16 * duty100 * pwm_diff2) / t_diff2)) / 100);\r\nfan_table.TempMin = cpu_to_be16((50 + hwmgr->thermal_controller.advanceFanControlParameters.usTMin) / 100);\r\nfan_table.TempMed = cpu_to_be16((50 + hwmgr->thermal_controller.advanceFanControlParameters.usTMed) / 100);\r\nfan_table.TempMax = cpu_to_be16((50 + hwmgr->thermal_controller.advanceFanControlParameters.usTMax) / 100);\r\nfan_table.Slope1 = cpu_to_be16(slope1);\r\nfan_table.Slope2 = cpu_to_be16(slope2);\r\nfan_table.FdoMin = cpu_to_be16(fdo_min);\r\nfan_table.HystDown = cpu_to_be16(hwmgr->thermal_controller.advanceFanControlParameters.ucTHyst);\r\nfan_table.HystUp = cpu_to_be16(1);\r\nfan_table.HystSlope = cpu_to_be16(1);\r\nfan_table.TempRespLim = cpu_to_be16(5);\r\nreference_clock = tonga_get_xclk(hwmgr);\r\nfan_table.RefreshPeriod = cpu_to_be32((hwmgr->thermal_controller.advanceFanControlParameters.ulCycleDelay * reference_clock) / 1600);\r\nfan_table.FdoMax = cpu_to_be16((uint16_t)duty100);\r\nfan_table.TempSrc = (uint8_t)PHM_READ_VFPF_INDIRECT_FIELD(hwmgr->device, CGS_IND_REG__SMC, CG_MULT_THERMAL_CTRL, TEMP_SEL);\r\nfan_table.FanControl_GL_Flag = 1;\r\nres = tonga_copy_bytes_to_smc(hwmgr->smumgr, data->fan_table_start, (uint8_t *)&fan_table, (uint32_t)sizeof(fan_table), data->sram_end);\r\nreturn 0;\r\n}\r\nint tf_tonga_thermal_start_smc_fan_control(struct pp_hwmgr *hwmgr, void *input, void *output, void *storage, int result)\r\n{\r\nif (phm_cap_enabled(hwmgr->platform_descriptor.platformCaps, PHM_PlatformCaps_MicrocodeFanControl)) {\r\ntonga_fan_ctrl_start_smc_fan_control(hwmgr);\r\ntonga_fan_ctrl_set_static_mode(hwmgr, FDO_PWM_MODE_STATIC);\r\n}\r\nreturn 0;\r\n}\r\nint tf_tonga_thermal_set_temperature_range(struct pp_hwmgr *hwmgr, void *input, void *output, void *storage, int result)\r\n{\r\nstruct PP_TemperatureRange *range = (struct PP_TemperatureRange *)input;\r\nif (range == NULL)\r\nreturn -EINVAL;\r\nreturn tonga_thermal_set_temperature_range(hwmgr, range->min, range->max);\r\n}\r\nint tf_tonga_thermal_initialize(struct pp_hwmgr *hwmgr, void *input, void *output, void *storage, int result)\r\n{\r\nreturn tonga_thermal_initialize(hwmgr);\r\n}\r\nint tf_tonga_thermal_enable_alert(struct pp_hwmgr *hwmgr, void *input, void *output, void *storage, int result)\r\n{\r\nreturn tonga_thermal_enable_alert(hwmgr);\r\n}\r\nstatic int tf_tonga_thermal_disable_alert(struct pp_hwmgr *hwmgr, void *input, void *output, void *storage, int result)\r\n{\r\nreturn tonga_thermal_disable_alert(hwmgr);\r\n}\r\nint tonga_thermal_ctrl_uninitialize_thermal_controller(struct pp_hwmgr *hwmgr)\r\n{\r\nif (!hwmgr->thermal_controller.fanInfo.bNoFan)\r\ntonga_fan_ctrl_set_default_mode(hwmgr);\r\nreturn 0;\r\n}\r\nint pp_tonga_thermal_initialize(struct pp_hwmgr *hwmgr)\r\n{\r\nint result;\r\nresult = phm_construct_table(hwmgr, &tonga_thermal_set_temperature_range_master, &(hwmgr->set_temperature_range));\r\nif (0 == result) {\r\nresult = phm_construct_table(hwmgr,\r\n&tonga_thermal_start_thermal_controller_master,\r\n&(hwmgr->start_thermal_controller));\r\nif (0 != result)\r\nphm_destroy_table(hwmgr, &(hwmgr->set_temperature_range));\r\n}\r\nif (0 == result)\r\nhwmgr->fan_ctrl_is_in_default_mode = true;\r\nreturn result;\r\n}

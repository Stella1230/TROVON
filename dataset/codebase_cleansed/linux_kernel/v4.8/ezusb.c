static int ezusb_writememory(struct usb_device *dev, int address,\r\nunsigned char *data, int length, __u8 request)\r\n{\r\nint result;\r\nunsigned char *transfer_buffer;\r\nif (!dev)\r\nreturn -ENODEV;\r\ntransfer_buffer = kmemdup(data, length, GFP_KERNEL);\r\nif (!transfer_buffer) {\r\ndev_err(&dev->dev, "%s - kmalloc(%d) failed.\n",\r\n__func__, length);\r\nreturn -ENOMEM;\r\n}\r\nresult = usb_control_msg(dev, usb_sndctrlpipe(dev, 0), request,\r\nUSB_DIR_OUT | USB_TYPE_VENDOR | USB_RECIP_DEVICE,\r\naddress, 0, transfer_buffer, length, 3000);\r\nkfree(transfer_buffer);\r\nreturn result;\r\n}\r\nstatic int ezusb_set_reset(struct usb_device *dev, unsigned short cpucs_reg,\r\nunsigned char reset_bit)\r\n{\r\nint response = ezusb_writememory(dev, cpucs_reg, &reset_bit, 1, WRITE_INT_RAM);\r\nif (response < 0)\r\ndev_err(&dev->dev, "%s-%d failed: %d\n",\r\n__func__, reset_bit, response);\r\nreturn response;\r\n}\r\nint ezusb_fx1_set_reset(struct usb_device *dev, unsigned char reset_bit)\r\n{\r\nreturn ezusb_set_reset(dev, ezusb_fx1.cpucs_reg, reset_bit);\r\n}\r\nstatic int ezusb_ihex_firmware_download(struct usb_device *dev,\r\nstruct ezusb_fx_type fx,\r\nconst char *firmware_path)\r\n{\r\nint ret = -ENOENT;\r\nconst struct firmware *firmware = NULL;\r\nconst struct ihex_binrec *record;\r\nif (request_ihex_firmware(&firmware, firmware_path,\r\n&dev->dev)) {\r\ndev_err(&dev->dev,\r\n"%s - request \"%s\" failed\n",\r\n__func__, firmware_path);\r\ngoto out;\r\n}\r\nret = ezusb_set_reset(dev, fx.cpucs_reg, 0);\r\nif (ret < 0)\r\ngoto out;\r\nrecord = (const struct ihex_binrec *)firmware->data;\r\nfor (; record; record = ihex_next_binrec(record)) {\r\nif (be32_to_cpu(record->addr) > fx.max_internal_adress) {\r\nret = ezusb_writememory(dev, be32_to_cpu(record->addr),\r\n(unsigned char *)record->data,\r\nbe16_to_cpu(record->len), WRITE_EXT_RAM);\r\nif (ret < 0) {\r\ndev_err(&dev->dev, "%s - ezusb_writememory "\r\n"failed writing internal memory "\r\n"(%d %04X %p %d)\n", __func__, ret,\r\nbe32_to_cpu(record->addr), record->data,\r\nbe16_to_cpu(record->len));\r\ngoto out;\r\n}\r\n}\r\n}\r\nret = ezusb_set_reset(dev, fx.cpucs_reg, 1);\r\nif (ret < 0)\r\ngoto out;\r\nrecord = (const struct ihex_binrec *)firmware->data;\r\nfor (; record; record = ihex_next_binrec(record)) {\r\nif (be32_to_cpu(record->addr) <= fx.max_internal_adress) {\r\nret = ezusb_writememory(dev, be32_to_cpu(record->addr),\r\n(unsigned char *)record->data,\r\nbe16_to_cpu(record->len), WRITE_INT_RAM);\r\nif (ret < 0) {\r\ndev_err(&dev->dev, "%s - ezusb_writememory "\r\n"failed writing external memory "\r\n"(%d %04X %p %d)\n", __func__, ret,\r\nbe32_to_cpu(record->addr), record->data,\r\nbe16_to_cpu(record->len));\r\ngoto out;\r\n}\r\n}\r\n}\r\nret = ezusb_set_reset(dev, fx.cpucs_reg, 0);\r\nout:\r\nrelease_firmware(firmware);\r\nreturn ret;\r\n}\r\nint ezusb_fx1_ihex_firmware_download(struct usb_device *dev,\r\nconst char *firmware_path)\r\n{\r\nreturn ezusb_ihex_firmware_download(dev, ezusb_fx1, firmware_path);\r\n}

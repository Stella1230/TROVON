static void diag_ftp_handler(struct ext_code extirq,\r\nunsigned int param32,\r\nunsigned long param64)\r\n{\r\nif ((extirq.subcode >> 8) != 8)\r\nreturn;\r\ninc_irq_stat(IRQEXT_FTP);\r\ndiag_ftp_subcode = extirq.subcode & 0xffU;\r\ncomplete(&diag_ftp_rx_complete);\r\n}\r\nstatic int diag_ftp_2c4(struct diag_ftp_ldfpl *fpl,\r\nenum hmcdrv_ftp_cmdid cmd)\r\n{\r\nint rc;\r\ndiag_stat_inc(DIAG_STAT_X2C4);\r\nasm volatile(\r\n" diag %[addr],%[cmd],0x2c4\n"\r\n"0: j 2f\n"\r\n"1: la %[rc],%[err]\n"\r\n"2:\n"\r\nEX_TABLE(0b, 1b)\r\n: [rc] "=d" (rc), "+m" (*fpl)\r\n: [cmd] "0" (cmd), [addr] "d" (virt_to_phys(fpl)),\r\n[err] "i" (DIAG_FTP_RET_EPERM)\r\n: "cc");\r\nswitch (rc) {\r\ncase DIAG_FTP_RET_OK:\r\nreturn 0;\r\ncase DIAG_FTP_RET_EBUSY:\r\nreturn -EBUSY;\r\ncase DIAG_FTP_RET_EPERM:\r\nreturn -EPERM;\r\ncase DIAG_FTP_RET_EIO:\r\ndefault:\r\nreturn -EIO;\r\n}\r\n}\r\nssize_t diag_ftp_cmd(const struct hmcdrv_ftp_cmdspec *ftp, size_t *fsize)\r\n{\r\nstruct diag_ftp_ldfpl *ldfpl;\r\nssize_t len;\r\n#ifdef DEBUG\r\nunsigned long start_jiffies;\r\npr_debug("starting DIAG X'2C4' on '%s', requesting %zd bytes\n",\r\nftp->fname, ftp->len);\r\nstart_jiffies = jiffies;\r\n#endif\r\ninit_completion(&diag_ftp_rx_complete);\r\nldfpl = (void *) get_zeroed_page(GFP_KERNEL | GFP_DMA);\r\nif (!ldfpl) {\r\nlen = -ENOMEM;\r\ngoto out;\r\n}\r\nlen = strlcpy(ldfpl->fident, ftp->fname, sizeof(ldfpl->fident));\r\nif (len >= HMCDRV_FTP_FIDENT_MAX) {\r\nlen = -EINVAL;\r\ngoto out_free;\r\n}\r\nldfpl->transferred = 0;\r\nldfpl->fsize = 0;\r\nldfpl->offset = ftp->ofs;\r\nldfpl->buflen = ftp->len;\r\nldfpl->bufaddr = virt_to_phys(ftp->buf);\r\nlen = diag_ftp_2c4(ldfpl, ftp->id);\r\nif (len)\r\ngoto out_free;\r\nwait_for_completion(&diag_ftp_rx_complete);\r\n#ifdef DEBUG\r\npr_debug("completed DIAG X'2C4' after %lu ms\n",\r\n(jiffies - start_jiffies) * 1000 / HZ);\r\npr_debug("status of DIAG X'2C4' is %u, with %lld/%lld bytes\n",\r\ndiag_ftp_subcode, ldfpl->transferred, ldfpl->fsize);\r\n#endif\r\nswitch (diag_ftp_subcode) {\r\ncase DIAG_FTP_STAT_OK:\r\nlen = ldfpl->transferred;\r\nif (fsize)\r\n*fsize = ldfpl->fsize;\r\nbreak;\r\ncase DIAG_FTP_STAT_LDNPERM:\r\nlen = -EPERM;\r\nbreak;\r\ncase DIAG_FTP_STAT_LDRUNS:\r\nlen = -EBUSY;\r\nbreak;\r\ncase DIAG_FTP_STAT_LDFAIL:\r\nlen = -ENOENT;\r\nbreak;\r\ndefault:\r\nlen = -EIO;\r\nbreak;\r\n}\r\nout_free:\r\nfree_page((unsigned long) ldfpl);\r\nout:\r\nreturn len;\r\n}\r\nint diag_ftp_startup(void)\r\n{\r\nint rc;\r\nrc = register_external_irq(EXT_IRQ_CP_SERVICE, diag_ftp_handler);\r\nif (rc)\r\nreturn rc;\r\nirq_subclass_register(IRQ_SUBCLASS_SERVICE_SIGNAL);\r\nreturn 0;\r\n}\r\nvoid diag_ftp_shutdown(void)\r\n{\r\nirq_subclass_unregister(IRQ_SUBCLASS_SERVICE_SIGNAL);\r\nunregister_external_irq(EXT_IRQ_CP_SERVICE, diag_ftp_handler);\r\n}

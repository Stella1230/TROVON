int\r\ngk104_hdmi_ctrl(NV50_DISP_MTHD_V1)\r\n{\r\nstruct nvkm_device *device = disp->base.engine.subdev.device;\r\nconst u32 hoff = (head * 0x800);\r\nconst u32 hdmi = (head * 0x400);\r\nunion {\r\nstruct nv50_disp_sor_hdmi_pwr_v0 v0;\r\n} *args = data;\r\nu32 ctrl;\r\nint ret = -ENOSYS;\r\nnvif_ioctl(object, "disp sor hdmi ctrl size %d\n", size);\r\nif (!(ret = nvif_unpack(ret, &data, &size, args->v0, 0, 0, false))) {\r\nnvif_ioctl(object, "disp sor hdmi ctrl vers %d state %d "\r\n"max_ac_packet %d rekey %d\n",\r\nargs->v0.version, args->v0.state,\r\nargs->v0.max_ac_packet, args->v0.rekey);\r\nif (args->v0.max_ac_packet > 0x1f || args->v0.rekey > 0x7f)\r\nreturn -EINVAL;\r\nctrl = 0x40000000 * !!args->v0.state;\r\nctrl |= args->v0.max_ac_packet << 16;\r\nctrl |= args->v0.rekey;\r\n} else\r\nreturn ret;\r\nif (!(ctrl & 0x40000000)) {\r\nnvkm_mask(device, 0x616798 + hoff, 0x40000000, 0x00000000);\r\nnvkm_mask(device, 0x6900c0 + hdmi, 0x00000001, 0x00000000);\r\nnvkm_mask(device, 0x690000 + hdmi, 0x00000001, 0x00000000);\r\nreturn 0;\r\n}\r\nnvkm_mask(device, 0x690000 + hdmi, 0x00000001, 0x00000000);\r\nnvkm_wr32(device, 0x690008 + hdmi, 0x000d0282);\r\nnvkm_wr32(device, 0x69000c + hdmi, 0x0000006f);\r\nnvkm_wr32(device, 0x690010 + hdmi, 0x00000000);\r\nnvkm_wr32(device, 0x690014 + hdmi, 0x00000000);\r\nnvkm_wr32(device, 0x690018 + hdmi, 0x00000000);\r\nnvkm_mask(device, 0x690000 + hdmi, 0x00000001, 0x00000001);\r\nnvkm_mask(device, 0x6900c0 + hdmi, 0x00000001, 0x00000000);\r\nnvkm_wr32(device, 0x6900cc + hdmi, 0x00000010);\r\nnvkm_mask(device, 0x6900c0 + hdmi, 0x00000001, 0x00000001);\r\nnvkm_wr32(device, 0x690080 + hdmi, 0x82000000);\r\nnvkm_mask(device, 0x616798 + hoff, 0x401f007f, ctrl);\r\nreturn 0;\r\n}

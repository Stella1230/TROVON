static void palmas_usb_wakeup(struct palmas *palmas, int enable)\r\n{\r\nif (enable)\r\npalmas_write(palmas, PALMAS_USB_OTG_BASE, PALMAS_USB_WAKEUP,\r\nPALMAS_USB_WAKEUP_ID_WK_UP_COMP);\r\nelse\r\npalmas_write(palmas, PALMAS_USB_OTG_BASE, PALMAS_USB_WAKEUP, 0);\r\n}\r\nstatic irqreturn_t palmas_vbus_irq_handler(int irq, void *_palmas_usb)\r\n{\r\nstruct palmas_usb *palmas_usb = _palmas_usb;\r\nstruct extcon_dev *edev = palmas_usb->edev;\r\nunsigned int vbus_line_state;\r\npalmas_read(palmas_usb->palmas, PALMAS_INTERRUPT_BASE,\r\nPALMAS_INT3_LINE_STATE, &vbus_line_state);\r\nif (vbus_line_state & PALMAS_INT3_LINE_STATE_VBUS) {\r\nif (palmas_usb->linkstat != PALMAS_USB_STATE_VBUS) {\r\npalmas_usb->linkstat = PALMAS_USB_STATE_VBUS;\r\nextcon_set_cable_state_(edev, EXTCON_USB, true);\r\ndev_info(palmas_usb->dev, "USB cable is attached\n");\r\n} else {\r\ndev_dbg(palmas_usb->dev,\r\n"Spurious connect event detected\n");\r\n}\r\n} else if (!(vbus_line_state & PALMAS_INT3_LINE_STATE_VBUS)) {\r\nif (palmas_usb->linkstat == PALMAS_USB_STATE_VBUS) {\r\npalmas_usb->linkstat = PALMAS_USB_STATE_DISCONNECT;\r\nextcon_set_cable_state_(edev, EXTCON_USB, false);\r\ndev_info(palmas_usb->dev, "USB cable is detached\n");\r\n} else {\r\ndev_dbg(palmas_usb->dev,\r\n"Spurious disconnect event detected\n");\r\n}\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t palmas_id_irq_handler(int irq, void *_palmas_usb)\r\n{\r\nunsigned int set, id_src;\r\nstruct palmas_usb *palmas_usb = _palmas_usb;\r\nstruct extcon_dev *edev = palmas_usb->edev;\r\npalmas_read(palmas_usb->palmas, PALMAS_USB_OTG_BASE,\r\nPALMAS_USB_ID_INT_LATCH_SET, &set);\r\npalmas_read(palmas_usb->palmas, PALMAS_USB_OTG_BASE,\r\nPALMAS_USB_ID_INT_SRC, &id_src);\r\nif ((set & PALMAS_USB_ID_INT_SRC_ID_GND) &&\r\n(id_src & PALMAS_USB_ID_INT_SRC_ID_GND)) {\r\npalmas_write(palmas_usb->palmas, PALMAS_USB_OTG_BASE,\r\nPALMAS_USB_ID_INT_LATCH_CLR,\r\nPALMAS_USB_ID_INT_EN_HI_CLR_ID_GND);\r\npalmas_usb->linkstat = PALMAS_USB_STATE_ID;\r\nextcon_set_cable_state_(edev, EXTCON_USB_HOST, true);\r\ndev_info(palmas_usb->dev, "USB-HOST cable is attached\n");\r\n} else if ((set & PALMAS_USB_ID_INT_SRC_ID_FLOAT) &&\r\n(id_src & PALMAS_USB_ID_INT_SRC_ID_FLOAT)) {\r\npalmas_write(palmas_usb->palmas, PALMAS_USB_OTG_BASE,\r\nPALMAS_USB_ID_INT_LATCH_CLR,\r\nPALMAS_USB_ID_INT_EN_HI_CLR_ID_FLOAT);\r\npalmas_usb->linkstat = PALMAS_USB_STATE_DISCONNECT;\r\nextcon_set_cable_state_(edev, EXTCON_USB_HOST, false);\r\ndev_info(palmas_usb->dev, "USB-HOST cable is detached\n");\r\n} else if ((palmas_usb->linkstat == PALMAS_USB_STATE_ID) &&\r\n(!(set & PALMAS_USB_ID_INT_SRC_ID_GND))) {\r\npalmas_usb->linkstat = PALMAS_USB_STATE_DISCONNECT;\r\nextcon_set_cable_state_(edev, EXTCON_USB_HOST, false);\r\ndev_info(palmas_usb->dev, "USB-HOST cable is detached\n");\r\n} else if ((palmas_usb->linkstat == PALMAS_USB_STATE_DISCONNECT) &&\r\n(id_src & PALMAS_USB_ID_INT_SRC_ID_GND)) {\r\npalmas_usb->linkstat = PALMAS_USB_STATE_ID;\r\nextcon_set_cable_state_(edev, EXTCON_USB_HOST, true);\r\ndev_info(palmas_usb->dev, " USB-HOST cable is attached\n");\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void palmas_gpio_id_detect(struct work_struct *work)\r\n{\r\nint id;\r\nstruct palmas_usb *palmas_usb = container_of(to_delayed_work(work),\r\nstruct palmas_usb,\r\nwq_detectid);\r\nstruct extcon_dev *edev = palmas_usb->edev;\r\nif (!palmas_usb->id_gpiod)\r\nreturn;\r\nid = gpiod_get_value_cansleep(palmas_usb->id_gpiod);\r\nif (id) {\r\nextcon_set_cable_state_(edev, EXTCON_USB_HOST, false);\r\ndev_info(palmas_usb->dev, "USB-HOST cable is detached\n");\r\n} else {\r\nextcon_set_cable_state_(edev, EXTCON_USB_HOST, true);\r\ndev_info(palmas_usb->dev, "USB-HOST cable is attached\n");\r\n}\r\n}\r\nstatic irqreturn_t palmas_gpio_id_irq_handler(int irq, void *_palmas_usb)\r\n{\r\nstruct palmas_usb *palmas_usb = _palmas_usb;\r\nqueue_delayed_work(system_power_efficient_wq, &palmas_usb->wq_detectid,\r\npalmas_usb->sw_debounce_jiffies);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void palmas_enable_irq(struct palmas_usb *palmas_usb)\r\n{\r\npalmas_write(palmas_usb->palmas, PALMAS_USB_OTG_BASE,\r\nPALMAS_USB_VBUS_CTRL_SET,\r\nPALMAS_USB_VBUS_CTRL_SET_VBUS_ACT_COMP);\r\nif (palmas_usb->enable_id_detection) {\r\npalmas_write(palmas_usb->palmas, PALMAS_USB_OTG_BASE,\r\nPALMAS_USB_ID_CTRL_SET,\r\nPALMAS_USB_ID_CTRL_SET_ID_ACT_COMP);\r\npalmas_write(palmas_usb->palmas, PALMAS_USB_OTG_BASE,\r\nPALMAS_USB_ID_INT_EN_HI_SET,\r\nPALMAS_USB_ID_INT_EN_HI_SET_ID_GND |\r\nPALMAS_USB_ID_INT_EN_HI_SET_ID_FLOAT);\r\n}\r\nif (palmas_usb->enable_vbus_detection)\r\npalmas_vbus_irq_handler(palmas_usb->vbus_irq, palmas_usb);\r\nif (palmas_usb->enable_id_detection) {\r\nmsleep(30);\r\npalmas_id_irq_handler(palmas_usb->id_irq, palmas_usb);\r\n}\r\n}\r\nstatic int palmas_usb_probe(struct platform_device *pdev)\r\n{\r\nstruct palmas *palmas = dev_get_drvdata(pdev->dev.parent);\r\nstruct palmas_usb_platform_data *pdata = dev_get_platdata(&pdev->dev);\r\nstruct device_node *node = pdev->dev.of_node;\r\nstruct palmas_usb *palmas_usb;\r\nint status;\r\npalmas_usb = devm_kzalloc(&pdev->dev, sizeof(*palmas_usb), GFP_KERNEL);\r\nif (!palmas_usb)\r\nreturn -ENOMEM;\r\nif (node && !pdata) {\r\npalmas_usb->wakeup = of_property_read_bool(node, "ti,wakeup");\r\npalmas_usb->enable_id_detection = of_property_read_bool(node,\r\n"ti,enable-id-detection");\r\npalmas_usb->enable_vbus_detection = of_property_read_bool(node,\r\n"ti,enable-vbus-detection");\r\n} else {\r\npalmas_usb->wakeup = true;\r\npalmas_usb->enable_id_detection = true;\r\npalmas_usb->enable_vbus_detection = true;\r\nif (pdata)\r\npalmas_usb->wakeup = pdata->wakeup;\r\n}\r\npalmas_usb->id_gpiod = devm_gpiod_get_optional(&pdev->dev, "id",\r\nGPIOD_IN);\r\nif (IS_ERR(palmas_usb->id_gpiod)) {\r\ndev_err(&pdev->dev, "failed to get id gpio\n");\r\nreturn PTR_ERR(palmas_usb->id_gpiod);\r\n}\r\npalmas_usb->vbus_gpiod = devm_gpiod_get_optional(&pdev->dev, "vbus",\r\nGPIOD_IN);\r\nif (IS_ERR(palmas_usb->vbus_gpiod)) {\r\ndev_err(&pdev->dev, "failed to get vbus gpio\n");\r\nreturn PTR_ERR(palmas_usb->vbus_gpiod);\r\n}\r\nif (palmas_usb->enable_id_detection && palmas_usb->id_gpiod) {\r\npalmas_usb->enable_id_detection = false;\r\npalmas_usb->enable_gpio_id_detection = true;\r\n}\r\nif (palmas_usb->enable_vbus_detection && palmas_usb->vbus_gpiod) {\r\npalmas_usb->enable_vbus_detection = false;\r\npalmas_usb->enable_gpio_vbus_detection = true;\r\n}\r\nif (palmas_usb->enable_gpio_id_detection) {\r\nu32 debounce;\r\nif (of_property_read_u32(node, "debounce-delay-ms", &debounce))\r\ndebounce = USB_GPIO_DEBOUNCE_MS;\r\nstatus = gpiod_set_debounce(palmas_usb->id_gpiod,\r\ndebounce * 1000);\r\nif (status < 0)\r\npalmas_usb->sw_debounce_jiffies = msecs_to_jiffies(debounce);\r\n}\r\nINIT_DELAYED_WORK(&palmas_usb->wq_detectid, palmas_gpio_id_detect);\r\npalmas->usb = palmas_usb;\r\npalmas_usb->palmas = palmas;\r\npalmas_usb->dev = &pdev->dev;\r\npalmas_usb_wakeup(palmas, palmas_usb->wakeup);\r\nplatform_set_drvdata(pdev, palmas_usb);\r\npalmas_usb->edev = devm_extcon_dev_allocate(&pdev->dev,\r\npalmas_extcon_cable);\r\nif (IS_ERR(palmas_usb->edev)) {\r\ndev_err(&pdev->dev, "failed to allocate extcon device\n");\r\nreturn -ENOMEM;\r\n}\r\nstatus = devm_extcon_dev_register(&pdev->dev, palmas_usb->edev);\r\nif (status) {\r\ndev_err(&pdev->dev, "failed to register extcon device\n");\r\nreturn status;\r\n}\r\nif (palmas_usb->enable_id_detection) {\r\npalmas_usb->id_otg_irq = regmap_irq_get_virq(palmas->irq_data,\r\nPALMAS_ID_OTG_IRQ);\r\npalmas_usb->id_irq = regmap_irq_get_virq(palmas->irq_data,\r\nPALMAS_ID_IRQ);\r\nstatus = devm_request_threaded_irq(palmas_usb->dev,\r\npalmas_usb->id_irq,\r\nNULL, palmas_id_irq_handler,\r\nIRQF_TRIGGER_FALLING | IRQF_TRIGGER_RISING |\r\nIRQF_ONESHOT,\r\n"palmas_usb_id", palmas_usb);\r\nif (status < 0) {\r\ndev_err(&pdev->dev, "can't get IRQ %d, err %d\n",\r\npalmas_usb->id_irq, status);\r\nreturn status;\r\n}\r\n} else if (palmas_usb->enable_gpio_id_detection) {\r\npalmas_usb->gpio_id_irq = gpiod_to_irq(palmas_usb->id_gpiod);\r\nif (palmas_usb->gpio_id_irq < 0) {\r\ndev_err(&pdev->dev, "failed to get id irq\n");\r\nreturn palmas_usb->gpio_id_irq;\r\n}\r\nstatus = devm_request_threaded_irq(&pdev->dev,\r\npalmas_usb->gpio_id_irq,\r\nNULL,\r\npalmas_gpio_id_irq_handler,\r\nIRQF_TRIGGER_RISING |\r\nIRQF_TRIGGER_FALLING |\r\nIRQF_ONESHOT,\r\n"palmas_usb_id",\r\npalmas_usb);\r\nif (status < 0) {\r\ndev_err(&pdev->dev,\r\n"failed to request handler for id irq\n");\r\nreturn status;\r\n}\r\n}\r\nif (palmas_usb->enable_vbus_detection) {\r\npalmas_usb->vbus_otg_irq = regmap_irq_get_virq(palmas->irq_data,\r\nPALMAS_VBUS_OTG_IRQ);\r\npalmas_usb->vbus_irq = regmap_irq_get_virq(palmas->irq_data,\r\nPALMAS_VBUS_IRQ);\r\nstatus = devm_request_threaded_irq(palmas_usb->dev,\r\npalmas_usb->vbus_irq, NULL,\r\npalmas_vbus_irq_handler,\r\nIRQF_TRIGGER_FALLING | IRQF_TRIGGER_RISING |\r\nIRQF_ONESHOT,\r\n"palmas_usb_vbus", palmas_usb);\r\nif (status < 0) {\r\ndev_err(&pdev->dev, "can't get IRQ %d, err %d\n",\r\npalmas_usb->vbus_irq, status);\r\nreturn status;\r\n}\r\n} else if (palmas_usb->enable_gpio_vbus_detection) {\r\nstatus = palmas_update_bits(palmas,\r\nPALMAS_PU_PD_OD_BASE,\r\nPALMAS_PRIMARY_SECONDARY_PAD1,\r\nPALMAS_PRIMARY_SECONDARY_PAD1_GPIO_1_MASK,\r\n(1 << PALMAS_PRIMARY_SECONDARY_PAD1_GPIO_1_SHIFT));\r\nif (status < 0) {\r\ndev_err(&pdev->dev, "can't remux GPIO1\n");\r\nreturn status;\r\n}\r\npalmas_usb->vbus_otg_irq = regmap_irq_get_virq(palmas->irq_data,\r\nPALMAS_VBUS_OTG_IRQ);\r\npalmas_usb->gpio_vbus_irq = gpiod_to_irq(palmas_usb->vbus_gpiod);\r\nif (palmas_usb->gpio_vbus_irq < 0) {\r\ndev_err(&pdev->dev, "failed to get vbus irq\n");\r\nreturn palmas_usb->gpio_vbus_irq;\r\n}\r\nstatus = devm_request_threaded_irq(&pdev->dev,\r\npalmas_usb->gpio_vbus_irq,\r\nNULL,\r\npalmas_vbus_irq_handler,\r\nIRQF_TRIGGER_FALLING |\r\nIRQF_TRIGGER_RISING |\r\nIRQF_ONESHOT,\r\n"palmas_usb_vbus",\r\npalmas_usb);\r\nif (status < 0) {\r\ndev_err(&pdev->dev,\r\n"failed to request handler for vbus irq\n");\r\nreturn status;\r\n}\r\n}\r\npalmas_enable_irq(palmas_usb);\r\nif (palmas_usb->enable_gpio_vbus_detection)\r\npalmas_vbus_irq_handler(palmas_usb->gpio_vbus_irq, palmas_usb);\r\npalmas_gpio_id_detect(&palmas_usb->wq_detectid.work);\r\ndevice_set_wakeup_capable(&pdev->dev, true);\r\nreturn 0;\r\n}\r\nstatic int palmas_usb_remove(struct platform_device *pdev)\r\n{\r\nstruct palmas_usb *palmas_usb = platform_get_drvdata(pdev);\r\ncancel_delayed_work_sync(&palmas_usb->wq_detectid);\r\nreturn 0;\r\n}\r\nstatic int palmas_usb_suspend(struct device *dev)\r\n{\r\nstruct palmas_usb *palmas_usb = dev_get_drvdata(dev);\r\nif (device_may_wakeup(dev)) {\r\nif (palmas_usb->enable_vbus_detection)\r\nenable_irq_wake(palmas_usb->vbus_irq);\r\nif (palmas_usb->enable_gpio_vbus_detection)\r\nenable_irq_wake(palmas_usb->gpio_vbus_irq);\r\nif (palmas_usb->enable_id_detection)\r\nenable_irq_wake(palmas_usb->id_irq);\r\nif (palmas_usb->enable_gpio_id_detection)\r\nenable_irq_wake(palmas_usb->gpio_id_irq);\r\n}\r\nreturn 0;\r\n}\r\nstatic int palmas_usb_resume(struct device *dev)\r\n{\r\nstruct palmas_usb *palmas_usb = dev_get_drvdata(dev);\r\nif (device_may_wakeup(dev)) {\r\nif (palmas_usb->enable_vbus_detection)\r\ndisable_irq_wake(palmas_usb->vbus_irq);\r\nif (palmas_usb->enable_gpio_vbus_detection)\r\ndisable_irq_wake(palmas_usb->gpio_vbus_irq);\r\nif (palmas_usb->enable_id_detection)\r\ndisable_irq_wake(palmas_usb->id_irq);\r\nif (palmas_usb->enable_gpio_id_detection)\r\ndisable_irq_wake(palmas_usb->gpio_id_irq);\r\n}\r\nreturn 0;\r\n}

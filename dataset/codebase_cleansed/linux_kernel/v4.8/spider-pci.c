static void spiderpci_io_flush(struct iowa_bus *bus)\r\n{\r\nstruct spiderpci_iowa_private *priv;\r\nu32 val;\r\npriv = bus->private;\r\nval = in_be32(priv->regs + SPIDER_PCI_DUMMY_READ);\r\niosync();\r\n}\r\nstatic void spiderpci_memcpy_fromio(void *dest, const PCI_IO_ADDR src,\r\nunsigned long n)\r\n{\r\n__do_memcpy_fromio(dest, src, n);\r\nspiderpci_io_flush(iowa_mem_find_bus(src));\r\n}\r\nstatic int __init spiderpci_pci_setup_chip(struct pci_controller *phb,\r\nvoid __iomem *regs)\r\n{\r\nvoid *dummy_page_va;\r\ndma_addr_t dummy_page_da;\r\n#ifdef SPIDER_PCI_DISABLE_PREFETCH\r\nu32 val = in_be32(regs + SPIDER_PCI_VCI_CNTL_STAT);\r\npr_debug("SPIDER_IOWA:PVCI_Control_Status was 0x%08x\n", val);\r\nout_be32(regs + SPIDER_PCI_VCI_CNTL_STAT, val | 0x8);\r\n#endif\r\ndummy_page_va = kmalloc(PAGE_SIZE, GFP_KERNEL);\r\nif (!dummy_page_va) {\r\npr_err("SPIDERPCI-IOWA:Alloc dummy_page_va failed.\n");\r\nreturn -1;\r\n}\r\ndummy_page_da = dma_map_single(phb->parent, dummy_page_va,\r\nPAGE_SIZE, DMA_FROM_DEVICE);\r\nif (dma_mapping_error(phb->parent, dummy_page_da)) {\r\npr_err("SPIDER-IOWA:Map dummy page filed.\n");\r\nkfree(dummy_page_va);\r\nreturn -1;\r\n}\r\nout_be32(regs + SPIDER_PCI_DUMMY_READ_BASE, dummy_page_da);\r\nreturn 0;\r\n}\r\nint __init spiderpci_iowa_init(struct iowa_bus *bus, void *data)\r\n{\r\nvoid __iomem *regs = NULL;\r\nstruct spiderpci_iowa_private *priv;\r\nstruct device_node *np = bus->phb->dn;\r\nstruct resource r;\r\nunsigned long offset = (unsigned long)data;\r\npr_debug("SPIDERPCI-IOWA:Bus initialize for spider(%s)\n",\r\nnp->full_name);\r\npriv = kzalloc(sizeof(struct spiderpci_iowa_private), GFP_KERNEL);\r\nif (!priv) {\r\npr_err("SPIDERPCI-IOWA:"\r\n"Can't allocate struct spiderpci_iowa_private");\r\nreturn -1;\r\n}\r\nif (of_address_to_resource(np, 0, &r)) {\r\npr_err("SPIDERPCI-IOWA:Can't get resource.\n");\r\ngoto error;\r\n}\r\nregs = ioremap(r.start + offset, SPIDER_PCI_REG_SIZE);\r\nif (!regs) {\r\npr_err("SPIDERPCI-IOWA:ioremap failed.\n");\r\ngoto error;\r\n}\r\npriv->regs = regs;\r\nbus->private = priv;\r\nif (spiderpci_pci_setup_chip(bus->phb, regs))\r\ngoto error;\r\nreturn 0;\r\nerror:\r\nkfree(priv);\r\nbus->private = NULL;\r\nif (regs)\r\niounmap(regs);\r\nreturn -1;\r\n}

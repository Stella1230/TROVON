asmlinkage int old_mmap(unsigned long addr, unsigned long len,\r\nunsigned long prot, unsigned long flags,\r\nint fd, unsigned long off)\r\n{\r\nif (off & ~PAGE_MASK)\r\nreturn -EINVAL;\r\nreturn sys_mmap_pgoff(addr, len, prot, flags, fd, off>>PAGE_SHIFT);\r\n}\r\nasmlinkage long sys_mmap2(unsigned long addr, unsigned long len,\r\nunsigned long prot, unsigned long flags,\r\nunsigned long fd, unsigned long pgoff)\r\n{\r\nif (pgoff & ((1 << (PAGE_SHIFT - 12)) - 1))\r\nreturn -EINVAL;\r\npgoff >>= PAGE_SHIFT - 12;\r\nreturn sys_mmap_pgoff(addr, len, prot, flags, fd, pgoff);\r\n}\r\nasmlinkage int sys_cacheflush(unsigned long addr, unsigned long len, int op)\r\n{\r\nstruct vm_area_struct *vma;\r\nif ((op <= 0) || (op > (CACHEFLUSH_D_PURGE|CACHEFLUSH_I)))\r\nreturn -EINVAL;\r\nif (addr + len < addr)\r\nreturn -EFAULT;\r\ndown_read(&current->mm->mmap_sem);\r\nvma = find_vma (current->mm, addr);\r\nif (vma == NULL || addr < vma->vm_start || addr + len > vma->vm_end) {\r\nup_read(&current->mm->mmap_sem);\r\nreturn -EFAULT;\r\n}\r\nswitch (op & CACHEFLUSH_D_PURGE) {\r\ncase CACHEFLUSH_D_INVAL:\r\n__flush_invalidate_region((void *)addr, len);\r\nbreak;\r\ncase CACHEFLUSH_D_WB:\r\n__flush_wback_region((void *)addr, len);\r\nbreak;\r\ncase CACHEFLUSH_D_PURGE:\r\n__flush_purge_region((void *)addr, len);\r\nbreak;\r\n}\r\nif (op & CACHEFLUSH_I)\r\nflush_icache_range(addr, addr+len);\r\nup_read(&current->mm->mmap_sem);\r\nreturn 0;\r\n}

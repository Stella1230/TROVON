static inline int mkaddr(struct pci_bus *bus, unsigned int devfn,\r\nunsigned int reg)\r\n{\r\nreturn ((bus->number & 0xff) << 16) |\r\n((devfn & 0xff) << 8) |\r\n(reg & 0xfc);\r\n}\r\nstatic int\r\nmace_pci_read_config(struct pci_bus *bus, unsigned int devfn,\r\nint reg, int size, u32 *val)\r\n{\r\nu32 control = mace->pci.control;\r\nmace->pci.control = control & ~MACEPCI_CONTROL_MAR_INT;\r\nmace->pci.config_addr = mkaddr(bus, devfn, reg);\r\nswitch (size) {\r\ncase 1:\r\n*val = mace->pci.config_data.b[(reg & 3) ^ 3];\r\nbreak;\r\ncase 2:\r\n*val = mace->pci.config_data.w[((reg >> 1) & 1) ^ 1];\r\nbreak;\r\ncase 4:\r\n*val = mace->pci.config_data.l;\r\nbreak;\r\n}\r\nmace->pci.error &= ~MACEPCI_ERROR_MASTER_ABORT;\r\nmace->pci.control = control;\r\nif (bus->number == 0 && reg == 0x40 && size == 4 &&\r\n(devfn == (1 << 3) || devfn == (2 << 3)))\r\n*val |= 0x1000;\r\nDPRINTK("read%d: reg=%08x,val=%02x\n", size * 8, reg, *val);\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int\r\nmace_pci_write_config(struct pci_bus *bus, unsigned int devfn,\r\nint reg, int size, u32 val)\r\n{\r\nmace->pci.config_addr = mkaddr(bus, devfn, reg);\r\nswitch (size) {\r\ncase 1:\r\nmace->pci.config_data.b[(reg & 3) ^ 3] = val;\r\nbreak;\r\ncase 2:\r\nmace->pci.config_data.w[((reg >> 1) & 1) ^ 1] = val;\r\nbreak;\r\ncase 4:\r\nmace->pci.config_data.l = val;\r\nbreak;\r\n}\r\nDPRINTK("write%d: reg=%08x,val=%02x\n", size * 8, reg, val);\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}

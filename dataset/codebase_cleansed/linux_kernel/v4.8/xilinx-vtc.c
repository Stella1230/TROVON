static inline void xvtc_gen_write(struct xvtc_device *xvtc, u32 addr, u32 value)\r\n{\r\nxvip_write(&xvtc->xvip, XVTC_GENERATOR_OFFSET + addr, value);\r\n}\r\nint xvtc_generator_start(struct xvtc_device *xvtc,\r\nconst struct xvtc_config *config)\r\n{\r\nint ret;\r\nif (!xvtc->has_generator)\r\nreturn -ENXIO;\r\nret = clk_prepare_enable(xvtc->xvip.clk);\r\nif (ret < 0)\r\nreturn ret;\r\nxvtc_gen_write(xvtc, XVTC_POLARITY,\r\nXVTC_POLARITY_ACTIVE_CHROMA_POL |\r\nXVTC_POLARITY_ACTIVE_VIDEO_POL |\r\nXVTC_POLARITY_HSYNC_POL | XVTC_POLARITY_VSYNC_POL |\r\nXVTC_POLARITY_HBLANK_POL | XVTC_POLARITY_VBLANK_POL);\r\nxvtc_gen_write(xvtc, XVTC_ENCODING, 0);\r\nxvtc_gen_write(xvtc, XVTC_ACTIVE_SIZE,\r\n(config->vblank_start << XVTC_ACTIVE_VSIZE_SHIFT) |\r\n(config->hblank_start << XVTC_ACTIVE_HSIZE_SHIFT));\r\nxvtc_gen_write(xvtc, XVTC_HSIZE, config->hsize);\r\nxvtc_gen_write(xvtc, XVTC_VSIZE, config->vsize);\r\nxvtc_gen_write(xvtc, XVTC_HSYNC,\r\n(config->hsync_end << XVTC_HSYNC_END_SHIFT) |\r\n(config->hsync_start << XVTC_HSYNC_START_SHIFT));\r\nxvtc_gen_write(xvtc, XVTC_F0_VBLANK_H, 0);\r\nxvtc_gen_write(xvtc, XVTC_F0_VSYNC_V,\r\n(config->vsync_end << XVTC_F0_VSYNC_VEND_SHIFT) |\r\n(config->vsync_start << XVTC_F0_VSYNC_VSTART_SHIFT));\r\nxvtc_gen_write(xvtc, XVTC_F0_VSYNC_H, 0);\r\nxvip_write(&xvtc->xvip, XVIP_CTRL_CONTROL,\r\nXVTC_CONTROL_ACTIVE_CHROMA_POL_SRC |\r\nXVTC_CONTROL_ACTIVE_VIDEO_POL_SRC |\r\nXVTC_CONTROL_HSYNC_POL_SRC | XVTC_CONTROL_VSYNC_POL_SRC |\r\nXVTC_CONTROL_HBLANK_POL_SRC | XVTC_CONTROL_VBLANK_POL_SRC |\r\nXVTC_CONTROL_CHROMA_SRC | XVTC_CONTROL_VBLANK_HOFF_SRC |\r\nXVTC_CONTROL_VSYNC_END_SRC | XVTC_CONTROL_VSYNC_START_SRC |\r\nXVTC_CONTROL_ACTIVE_VSIZE_SRC |\r\nXVTC_CONTROL_FRAME_VSIZE_SRC | XVTC_CONTROL_HSYNC_END_SRC |\r\nXVTC_CONTROL_HSYNC_START_SRC |\r\nXVTC_CONTROL_ACTIVE_HSIZE_SRC |\r\nXVTC_CONTROL_FRAME_HSIZE_SRC | XVTC_CONTROL_GEN_ENABLE |\r\nXVIP_CTRL_CONTROL_REG_UPDATE);\r\nreturn 0;\r\n}\r\nint xvtc_generator_stop(struct xvtc_device *xvtc)\r\n{\r\nif (!xvtc->has_generator)\r\nreturn -ENXIO;\r\nxvip_write(&xvtc->xvip, XVIP_CTRL_CONTROL, 0);\r\nclk_disable_unprepare(xvtc->xvip.clk);\r\nreturn 0;\r\n}\r\nstruct xvtc_device *xvtc_of_get(struct device_node *np)\r\n{\r\nstruct device_node *xvtc_node;\r\nstruct xvtc_device *found = NULL;\r\nstruct xvtc_device *xvtc;\r\nif (!of_find_property(np, "xlnx,vtc", NULL))\r\nreturn NULL;\r\nxvtc_node = of_parse_phandle(np, "xlnx,vtc", 0);\r\nif (xvtc_node == NULL)\r\nreturn ERR_PTR(-EINVAL);\r\nmutex_lock(&xvtc_lock);\r\nlist_for_each_entry(xvtc, &xvtc_list, list) {\r\nif (xvtc->xvip.dev->of_node == xvtc_node) {\r\nfound = xvtc;\r\nbreak;\r\n}\r\n}\r\nmutex_unlock(&xvtc_lock);\r\nof_node_put(xvtc_node);\r\nif (!found)\r\nreturn ERR_PTR(-EPROBE_DEFER);\r\nreturn found;\r\n}\r\nvoid xvtc_put(struct xvtc_device *xvtc)\r\n{\r\n}\r\nstatic void xvtc_register_device(struct xvtc_device *xvtc)\r\n{\r\nmutex_lock(&xvtc_lock);\r\nlist_add_tail(&xvtc->list, &xvtc_list);\r\nmutex_unlock(&xvtc_lock);\r\n}\r\nstatic void xvtc_unregister_device(struct xvtc_device *xvtc)\r\n{\r\nmutex_lock(&xvtc_lock);\r\nlist_del(&xvtc->list);\r\nmutex_unlock(&xvtc_lock);\r\n}\r\nstatic int xvtc_parse_of(struct xvtc_device *xvtc)\r\n{\r\nstruct device_node *node = xvtc->xvip.dev->of_node;\r\nxvtc->has_detector = of_property_read_bool(node, "xlnx,detector");\r\nxvtc->has_generator = of_property_read_bool(node, "xlnx,generator");\r\nreturn 0;\r\n}\r\nstatic int xvtc_probe(struct platform_device *pdev)\r\n{\r\nstruct xvtc_device *xvtc;\r\nint ret;\r\nxvtc = devm_kzalloc(&pdev->dev, sizeof(*xvtc), GFP_KERNEL);\r\nif (!xvtc)\r\nreturn -ENOMEM;\r\nxvtc->xvip.dev = &pdev->dev;\r\nret = xvtc_parse_of(xvtc);\r\nif (ret < 0)\r\nreturn ret;\r\nret = xvip_init_resources(&xvtc->xvip);\r\nif (ret < 0)\r\nreturn ret;\r\nplatform_set_drvdata(pdev, xvtc);\r\nxvip_print_version(&xvtc->xvip);\r\nxvtc_register_device(xvtc);\r\nreturn 0;\r\n}\r\nstatic int xvtc_remove(struct platform_device *pdev)\r\n{\r\nstruct xvtc_device *xvtc = platform_get_drvdata(pdev);\r\nxvtc_unregister_device(xvtc);\r\nxvip_cleanup_resources(&xvtc->xvip);\r\nreturn 0;\r\n}

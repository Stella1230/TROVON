void mlx5e_vxlan_init(struct mlx5e_priv *priv)\r\n{\r\nstruct mlx5e_vxlan_db *vxlan_db = &priv->vxlan;\r\nspin_lock_init(&vxlan_db->lock);\r\nINIT_RADIX_TREE(&vxlan_db->tree, GFP_ATOMIC);\r\n}\r\nstatic int mlx5e_vxlan_core_add_port_cmd(struct mlx5_core_dev *mdev, u16 port)\r\n{\r\nstruct mlx5_outbox_hdr *hdr;\r\nint err;\r\nu32 in[MLX5_ST_SZ_DW(add_vxlan_udp_dport_in)];\r\nu32 out[MLX5_ST_SZ_DW(add_vxlan_udp_dport_out)];\r\nmemset(in, 0, sizeof(in));\r\nmemset(out, 0, sizeof(out));\r\nMLX5_SET(add_vxlan_udp_dport_in, in, opcode,\r\nMLX5_CMD_OP_ADD_VXLAN_UDP_DPORT);\r\nMLX5_SET(add_vxlan_udp_dport_in, in, vxlan_udp_port, port);\r\nerr = mlx5_cmd_exec(mdev, in, sizeof(in), out, sizeof(out));\r\nif (err)\r\nreturn err;\r\nhdr = (struct mlx5_outbox_hdr *)out;\r\nreturn hdr->status ? -ENOMEM : 0;\r\n}\r\nstatic int mlx5e_vxlan_core_del_port_cmd(struct mlx5_core_dev *mdev, u16 port)\r\n{\r\nu32 in[MLX5_ST_SZ_DW(delete_vxlan_udp_dport_in)];\r\nu32 out[MLX5_ST_SZ_DW(delete_vxlan_udp_dport_out)];\r\nmemset(in, 0, sizeof(in));\r\nmemset(out, 0, sizeof(out));\r\nMLX5_SET(delete_vxlan_udp_dport_in, in, opcode,\r\nMLX5_CMD_OP_DELETE_VXLAN_UDP_DPORT);\r\nMLX5_SET(delete_vxlan_udp_dport_in, in, vxlan_udp_port, port);\r\nreturn mlx5_cmd_exec_check_status(mdev, in, sizeof(in), out,\r\nsizeof(out));\r\n}\r\nstruct mlx5e_vxlan *mlx5e_vxlan_lookup_port(struct mlx5e_priv *priv, u16 port)\r\n{\r\nstruct mlx5e_vxlan_db *vxlan_db = &priv->vxlan;\r\nstruct mlx5e_vxlan *vxlan;\r\nspin_lock(&vxlan_db->lock);\r\nvxlan = radix_tree_lookup(&vxlan_db->tree, port);\r\nspin_unlock(&vxlan_db->lock);\r\nreturn vxlan;\r\n}\r\nstatic void mlx5e_vxlan_add_port(struct work_struct *work)\r\n{\r\nstruct mlx5e_vxlan_work *vxlan_work =\r\ncontainer_of(work, struct mlx5e_vxlan_work, work);\r\nstruct mlx5e_priv *priv = vxlan_work->priv;\r\nstruct mlx5e_vxlan_db *vxlan_db = &priv->vxlan;\r\nu16 port = vxlan_work->port;\r\nstruct mlx5e_vxlan *vxlan;\r\nint err;\r\nif (mlx5e_vxlan_lookup_port(priv, port))\r\ngoto free_work;\r\nif (mlx5e_vxlan_core_add_port_cmd(priv->mdev, port))\r\ngoto free_work;\r\nvxlan = kzalloc(sizeof(*vxlan), GFP_KERNEL);\r\nif (!vxlan)\r\ngoto err_delete_port;\r\nvxlan->udp_port = port;\r\nspin_lock_irq(&vxlan_db->lock);\r\nerr = radix_tree_insert(&vxlan_db->tree, vxlan->udp_port, vxlan);\r\nspin_unlock_irq(&vxlan_db->lock);\r\nif (err)\r\ngoto err_free;\r\ngoto free_work;\r\nerr_free:\r\nkfree(vxlan);\r\nerr_delete_port:\r\nmlx5e_vxlan_core_del_port_cmd(priv->mdev, port);\r\nfree_work:\r\nkfree(vxlan_work);\r\n}\r\nstatic void __mlx5e_vxlan_core_del_port(struct mlx5e_priv *priv, u16 port)\r\n{\r\nstruct mlx5e_vxlan_db *vxlan_db = &priv->vxlan;\r\nstruct mlx5e_vxlan *vxlan;\r\nspin_lock_irq(&vxlan_db->lock);\r\nvxlan = radix_tree_delete(&vxlan_db->tree, port);\r\nspin_unlock_irq(&vxlan_db->lock);\r\nif (!vxlan)\r\nreturn;\r\nmlx5e_vxlan_core_del_port_cmd(priv->mdev, vxlan->udp_port);\r\nkfree(vxlan);\r\n}\r\nstatic void mlx5e_vxlan_del_port(struct work_struct *work)\r\n{\r\nstruct mlx5e_vxlan_work *vxlan_work =\r\ncontainer_of(work, struct mlx5e_vxlan_work, work);\r\nstruct mlx5e_priv *priv = vxlan_work->priv;\r\nu16 port = vxlan_work->port;\r\n__mlx5e_vxlan_core_del_port(priv, port);\r\nkfree(vxlan_work);\r\n}\r\nvoid mlx5e_vxlan_queue_work(struct mlx5e_priv *priv, sa_family_t sa_family,\r\nu16 port, int add)\r\n{\r\nstruct mlx5e_vxlan_work *vxlan_work;\r\nvxlan_work = kmalloc(sizeof(*vxlan_work), GFP_ATOMIC);\r\nif (!vxlan_work)\r\nreturn;\r\nif (add)\r\nINIT_WORK(&vxlan_work->work, mlx5e_vxlan_add_port);\r\nelse\r\nINIT_WORK(&vxlan_work->work, mlx5e_vxlan_del_port);\r\nvxlan_work->priv = priv;\r\nvxlan_work->port = port;\r\nvxlan_work->sa_family = sa_family;\r\nqueue_work(priv->wq, &vxlan_work->work);\r\n}\r\nvoid mlx5e_vxlan_cleanup(struct mlx5e_priv *priv)\r\n{\r\nstruct mlx5e_vxlan_db *vxlan_db = &priv->vxlan;\r\nstruct mlx5e_vxlan *vxlan;\r\nunsigned int port = 0;\r\nspin_lock_irq(&vxlan_db->lock);\r\nwhile (radix_tree_gang_lookup(&vxlan_db->tree, (void **)&vxlan, port, 1)) {\r\nport = vxlan->udp_port;\r\nspin_unlock_irq(&vxlan_db->lock);\r\n__mlx5e_vxlan_core_del_port(priv, (u16)port);\r\nspin_lock_irq(&vxlan_db->lock);\r\n}\r\nspin_unlock_irq(&vxlan_db->lock);\r\n}

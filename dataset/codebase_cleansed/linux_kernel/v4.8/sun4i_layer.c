static int sun4i_backend_layer_atomic_check(struct drm_plane *plane,\r\nstruct drm_plane_state *state)\r\n{\r\nreturn 0;\r\n}\r\nstatic void sun4i_backend_layer_atomic_disable(struct drm_plane *plane,\r\nstruct drm_plane_state *old_state)\r\n{\r\nstruct sun4i_layer *layer = plane_to_sun4i_layer(plane);\r\nstruct sun4i_drv *drv = layer->drv;\r\nstruct sun4i_backend *backend = drv->backend;\r\nsun4i_backend_layer_enable(backend, layer->id, false);\r\n}\r\nstatic void sun4i_backend_layer_atomic_update(struct drm_plane *plane,\r\nstruct drm_plane_state *old_state)\r\n{\r\nstruct sun4i_layer *layer = plane_to_sun4i_layer(plane);\r\nstruct sun4i_drv *drv = layer->drv;\r\nstruct sun4i_backend *backend = drv->backend;\r\nsun4i_backend_update_layer_coord(backend, layer->id, plane);\r\nsun4i_backend_update_layer_formats(backend, layer->id, plane);\r\nsun4i_backend_update_layer_buffer(backend, layer->id, plane);\r\nsun4i_backend_layer_enable(backend, layer->id, true);\r\n}\r\nstatic struct sun4i_layer *sun4i_layer_init_one(struct drm_device *drm,\r\nenum drm_plane_type type)\r\n{\r\nstruct sun4i_drv *drv = drm->dev_private;\r\nstruct sun4i_layer *layer;\r\nint ret;\r\nlayer = devm_kzalloc(drm->dev, sizeof(*layer), GFP_KERNEL);\r\nif (!layer)\r\nreturn ERR_PTR(-ENOMEM);\r\nret = drm_universal_plane_init(drm, &layer->plane, BIT(0),\r\n&sun4i_backend_layer_funcs,\r\nsun4i_backend_layer_formats,\r\nARRAY_SIZE(sun4i_backend_layer_formats),\r\ntype,\r\nNULL);\r\nif (ret) {\r\ndev_err(drm->dev, "Couldn't initialize layer\n");\r\nreturn ERR_PTR(ret);\r\n}\r\ndrm_plane_helper_add(&layer->plane,\r\n&sun4i_backend_layer_helper_funcs);\r\nlayer->drv = drv;\r\nif (type == DRM_PLANE_TYPE_PRIMARY)\r\ndrv->primary = &layer->plane;\r\nreturn layer;\r\n}\r\nstruct sun4i_layer **sun4i_layers_init(struct drm_device *drm)\r\n{\r\nstruct sun4i_drv *drv = drm->dev_private;\r\nstruct sun4i_layer **layers;\r\nint i;\r\nlayers = devm_kcalloc(drm->dev, SUN4I_NUM_LAYERS, sizeof(**layers),\r\nGFP_KERNEL);\r\nif (!layers)\r\nreturn ERR_PTR(-ENOMEM);\r\nfor (i = 0; i < SUN4I_NUM_LAYERS; i++) {\r\nenum drm_plane_type type = (i == 0)\r\n? DRM_PLANE_TYPE_PRIMARY\r\n: DRM_PLANE_TYPE_OVERLAY;\r\nstruct sun4i_layer *layer = layers[i];\r\nlayer = sun4i_layer_init_one(drm, type);\r\nif (IS_ERR(layer)) {\r\ndev_err(drm->dev, "Couldn't initialize %s plane\n",\r\ni ? "overlay" : "primary");\r\nreturn ERR_CAST(layer);\r\n};\r\nDRM_DEBUG_DRIVER("Assigning %s plane to pipe %d\n",\r\ni ? "overlay" : "primary", i);\r\nregmap_update_bits(drv->backend->regs, SUN4I_BACKEND_ATTCTL_REG0(i),\r\nSUN4I_BACKEND_ATTCTL_REG0_LAY_PIPESEL_MASK,\r\nSUN4I_BACKEND_ATTCTL_REG0_LAY_PIPESEL(i));\r\nlayer->id = i;\r\n};\r\nreturn layers;\r\n}

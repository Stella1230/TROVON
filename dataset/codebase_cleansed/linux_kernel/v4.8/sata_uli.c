static unsigned int get_scr_cfg_addr(struct ata_port *ap, unsigned int sc_reg)\r\n{\r\nstruct uli_priv *hpriv = ap->host->private_data;\r\nreturn hpriv->scr_cfg_addr[ap->port_no] + (4 * sc_reg);\r\n}\r\nstatic u32 uli_scr_cfg_read(struct ata_link *link, unsigned int sc_reg)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(link->ap->host->dev);\r\nunsigned int cfg_addr = get_scr_cfg_addr(link->ap, sc_reg);\r\nu32 val;\r\npci_read_config_dword(pdev, cfg_addr, &val);\r\nreturn val;\r\n}\r\nstatic void uli_scr_cfg_write(struct ata_link *link, unsigned int scr, u32 val)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(link->ap->host->dev);\r\nunsigned int cfg_addr = get_scr_cfg_addr(link->ap, scr);\r\npci_write_config_dword(pdev, cfg_addr, val);\r\n}\r\nstatic int uli_scr_read(struct ata_link *link, unsigned int sc_reg, u32 *val)\r\n{\r\nif (sc_reg > SCR_CONTROL)\r\nreturn -EINVAL;\r\n*val = uli_scr_cfg_read(link, sc_reg);\r\nreturn 0;\r\n}\r\nstatic int uli_scr_write(struct ata_link *link, unsigned int sc_reg, u32 val)\r\n{\r\nif (sc_reg > SCR_CONTROL)\r\nreturn -EINVAL;\r\nuli_scr_cfg_write(link, sc_reg, val);\r\nreturn 0;\r\n}\r\nstatic int uli_init_one(struct pci_dev *pdev, const struct pci_device_id *ent)\r\n{\r\nconst struct ata_port_info *ppi[] = { &uli_port_info, NULL };\r\nunsigned int board_idx = (unsigned int) ent->driver_data;\r\nstruct ata_host *host;\r\nstruct uli_priv *hpriv;\r\nvoid __iomem * const *iomap;\r\nstruct ata_ioports *ioaddr;\r\nint n_ports, rc;\r\nata_print_version_once(&pdev->dev, DRV_VERSION);\r\nrc = pcim_enable_device(pdev);\r\nif (rc)\r\nreturn rc;\r\nn_ports = 2;\r\nif (board_idx == uli_5287)\r\nn_ports = 4;\r\nhost = ata_host_alloc_pinfo(&pdev->dev, ppi, n_ports);\r\nif (!host)\r\nreturn -ENOMEM;\r\nhpriv = devm_kzalloc(&pdev->dev, sizeof(*hpriv), GFP_KERNEL);\r\nif (!hpriv)\r\nreturn -ENOMEM;\r\nhost->private_data = hpriv;\r\nrc = ata_pci_sff_init_host(host);\r\nif (rc)\r\nreturn rc;\r\nata_pci_bmdma_init(host);\r\niomap = host->iomap;\r\nswitch (board_idx) {\r\ncase uli_5287:\r\nhpriv->scr_cfg_addr[0] = ULI5287_BASE;\r\nhpriv->scr_cfg_addr[1] = ULI5287_BASE + ULI5287_OFFS;\r\nioaddr = &host->ports[2]->ioaddr;\r\nioaddr->cmd_addr = iomap[0] + 8;\r\nioaddr->altstatus_addr =\r\nioaddr->ctl_addr = (void __iomem *)\r\n((unsigned long)iomap[1] | ATA_PCI_CTL_OFS) + 4;\r\nioaddr->bmdma_addr = iomap[4] + 16;\r\nhpriv->scr_cfg_addr[2] = ULI5287_BASE + ULI5287_OFFS*4;\r\nata_sff_std_ports(ioaddr);\r\nata_port_desc(host->ports[2],\r\n"cmd 0x%llx ctl 0x%llx bmdma 0x%llx",\r\n(unsigned long long)pci_resource_start(pdev, 0) + 8,\r\n((unsigned long long)pci_resource_start(pdev, 1) | ATA_PCI_CTL_OFS) + 4,\r\n(unsigned long long)pci_resource_start(pdev, 4) + 16);\r\nioaddr = &host->ports[3]->ioaddr;\r\nioaddr->cmd_addr = iomap[2] + 8;\r\nioaddr->altstatus_addr =\r\nioaddr->ctl_addr = (void __iomem *)\r\n((unsigned long)iomap[3] | ATA_PCI_CTL_OFS) + 4;\r\nioaddr->bmdma_addr = iomap[4] + 24;\r\nhpriv->scr_cfg_addr[3] = ULI5287_BASE + ULI5287_OFFS*5;\r\nata_sff_std_ports(ioaddr);\r\nata_port_desc(host->ports[2],\r\n"cmd 0x%llx ctl 0x%llx bmdma 0x%llx",\r\n(unsigned long long)pci_resource_start(pdev, 2) + 9,\r\n((unsigned long long)pci_resource_start(pdev, 3) | ATA_PCI_CTL_OFS) + 4,\r\n(unsigned long long)pci_resource_start(pdev, 4) + 24);\r\nbreak;\r\ncase uli_5289:\r\nhpriv->scr_cfg_addr[0] = ULI5287_BASE;\r\nhpriv->scr_cfg_addr[1] = ULI5287_BASE + ULI5287_OFFS;\r\nbreak;\r\ncase uli_5281:\r\nhpriv->scr_cfg_addr[0] = ULI5281_BASE;\r\nhpriv->scr_cfg_addr[1] = ULI5281_BASE + ULI5281_OFFS;\r\nbreak;\r\ndefault:\r\nBUG();\r\nbreak;\r\n}\r\npci_set_master(pdev);\r\npci_intx(pdev, 1);\r\nreturn ata_host_activate(host, pdev->irq, ata_bmdma_interrupt,\r\nIRQF_SHARED, &uli_sht);\r\n}

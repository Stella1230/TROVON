static int imx2_wdt_restart(struct watchdog_device *wdog, unsigned long action,\r\nvoid *data)\r\n{\r\nstruct imx2_wdt_device *wdev = watchdog_get_drvdata(wdog);\r\nunsigned int wcr_enable = IMX2_WDT_WCR_WDE;\r\nif (wdev->ext_reset)\r\nwcr_enable |= IMX2_WDT_WCR_SRS;\r\nelse\r\nwcr_enable |= IMX2_WDT_WCR_WDA;\r\nregmap_write(wdev->regmap, IMX2_WDT_WCR, wcr_enable);\r\nregmap_write(wdev->regmap, IMX2_WDT_WCR, wcr_enable);\r\nregmap_write(wdev->regmap, IMX2_WDT_WCR, wcr_enable);\r\nmdelay(500);\r\nreturn 0;\r\n}\r\nstatic inline void imx2_wdt_setup(struct watchdog_device *wdog)\r\n{\r\nstruct imx2_wdt_device *wdev = watchdog_get_drvdata(wdog);\r\nu32 val;\r\nregmap_read(wdev->regmap, IMX2_WDT_WCR, &val);\r\nval |= IMX2_WDT_WCR_WDZST;\r\nval &= ~IMX2_WDT_WCR_WT;\r\nif (!wdev->ext_reset)\r\nval &= ~IMX2_WDT_WCR_WRE;\r\nelse\r\nval |= IMX2_WDT_WCR_WRE;\r\nval &= ~IMX2_WDT_WCR_WDE;\r\nval |= WDOG_SEC_TO_COUNT(wdog->timeout);\r\nregmap_write(wdev->regmap, IMX2_WDT_WCR, val);\r\nval |= IMX2_WDT_WCR_WDE;\r\nregmap_write(wdev->regmap, IMX2_WDT_WCR, val);\r\n}\r\nstatic inline bool imx2_wdt_is_running(struct imx2_wdt_device *wdev)\r\n{\r\nu32 val;\r\nregmap_read(wdev->regmap, IMX2_WDT_WCR, &val);\r\nreturn val & IMX2_WDT_WCR_WDE;\r\n}\r\nstatic int imx2_wdt_ping(struct watchdog_device *wdog)\r\n{\r\nstruct imx2_wdt_device *wdev = watchdog_get_drvdata(wdog);\r\nregmap_write(wdev->regmap, IMX2_WDT_WSR, IMX2_WDT_SEQ1);\r\nregmap_write(wdev->regmap, IMX2_WDT_WSR, IMX2_WDT_SEQ2);\r\nreturn 0;\r\n}\r\nstatic int imx2_wdt_set_timeout(struct watchdog_device *wdog,\r\nunsigned int new_timeout)\r\n{\r\nstruct imx2_wdt_device *wdev = watchdog_get_drvdata(wdog);\r\nwdog->timeout = new_timeout;\r\nregmap_update_bits(wdev->regmap, IMX2_WDT_WCR, IMX2_WDT_WCR_WT,\r\nWDOG_SEC_TO_COUNT(new_timeout));\r\nreturn 0;\r\n}\r\nstatic int imx2_wdt_start(struct watchdog_device *wdog)\r\n{\r\nstruct imx2_wdt_device *wdev = watchdog_get_drvdata(wdog);\r\nif (imx2_wdt_is_running(wdev))\r\nimx2_wdt_set_timeout(wdog, wdog->timeout);\r\nelse\r\nimx2_wdt_setup(wdog);\r\nset_bit(WDOG_HW_RUNNING, &wdog->status);\r\nreturn imx2_wdt_ping(wdog);\r\n}\r\nstatic int __init imx2_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct imx2_wdt_device *wdev;\r\nstruct watchdog_device *wdog;\r\nstruct resource *res;\r\nvoid __iomem *base;\r\nint ret;\r\nu32 val;\r\nwdev = devm_kzalloc(&pdev->dev, sizeof(*wdev), GFP_KERNEL);\r\nif (!wdev)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nbase = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(base))\r\nreturn PTR_ERR(base);\r\nwdev->regmap = devm_regmap_init_mmio_clk(&pdev->dev, NULL, base,\r\n&imx2_wdt_regmap_config);\r\nif (IS_ERR(wdev->regmap)) {\r\ndev_err(&pdev->dev, "regmap init failed\n");\r\nreturn PTR_ERR(wdev->regmap);\r\n}\r\nwdev->clk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(wdev->clk)) {\r\ndev_err(&pdev->dev, "can't get Watchdog clock\n");\r\nreturn PTR_ERR(wdev->clk);\r\n}\r\nwdog = &wdev->wdog;\r\nwdog->info = &imx2_wdt_info;\r\nwdog->ops = &imx2_wdt_ops;\r\nwdog->min_timeout = 1;\r\nwdog->max_hw_heartbeat_ms = IMX2_WDT_MAX_TIME * 1000;\r\nwdog->parent = &pdev->dev;\r\nret = clk_prepare_enable(wdev->clk);\r\nif (ret)\r\nreturn ret;\r\nregmap_read(wdev->regmap, IMX2_WDT_WRSR, &val);\r\nwdog->bootstatus = val & IMX2_WDT_WRSR_TOUT ? WDIOF_CARDRESET : 0;\r\nwdev->ext_reset = of_property_read_bool(pdev->dev.of_node,\r\n"fsl,ext-reset-output");\r\nwdog->timeout = clamp_t(unsigned, timeout, 1, IMX2_WDT_MAX_TIME);\r\nif (wdog->timeout != timeout)\r\ndev_warn(&pdev->dev, "Initial timeout out of range! Clamped from %u to %u\n",\r\ntimeout, wdog->timeout);\r\nplatform_set_drvdata(pdev, wdog);\r\nwatchdog_set_drvdata(wdog, wdev);\r\nwatchdog_set_nowayout(wdog, nowayout);\r\nwatchdog_set_restart_priority(wdog, 128);\r\nwatchdog_init_timeout(wdog, timeout, &pdev->dev);\r\nif (imx2_wdt_is_running(wdev)) {\r\nimx2_wdt_set_timeout(wdog, wdog->timeout);\r\nset_bit(WDOG_HW_RUNNING, &wdog->status);\r\n}\r\nregmap_write(wdev->regmap, IMX2_WDT_WMCR, 0);\r\nret = watchdog_register_device(wdog);\r\nif (ret) {\r\ndev_err(&pdev->dev, "cannot register watchdog device\n");\r\ngoto disable_clk;\r\n}\r\ndev_info(&pdev->dev, "timeout %d sec (nowayout=%d)\n",\r\nwdog->timeout, nowayout);\r\nreturn 0;\r\ndisable_clk:\r\nclk_disable_unprepare(wdev->clk);\r\nreturn ret;\r\n}\r\nstatic int __exit imx2_wdt_remove(struct platform_device *pdev)\r\n{\r\nstruct watchdog_device *wdog = platform_get_drvdata(pdev);\r\nstruct imx2_wdt_device *wdev = watchdog_get_drvdata(wdog);\r\nwatchdog_unregister_device(wdog);\r\nif (imx2_wdt_is_running(wdev)) {\r\nimx2_wdt_ping(wdog);\r\ndev_crit(&pdev->dev, "Device removed: Expect reboot!\n");\r\n}\r\nreturn 0;\r\n}\r\nstatic void imx2_wdt_shutdown(struct platform_device *pdev)\r\n{\r\nstruct watchdog_device *wdog = platform_get_drvdata(pdev);\r\nstruct imx2_wdt_device *wdev = watchdog_get_drvdata(wdog);\r\nif (imx2_wdt_is_running(wdev)) {\r\nimx2_wdt_set_timeout(wdog, IMX2_WDT_MAX_TIME);\r\nimx2_wdt_ping(wdog);\r\ndev_crit(&pdev->dev, "Device shutdown: Expect reboot!\n");\r\n}\r\n}\r\nstatic int imx2_wdt_suspend(struct device *dev)\r\n{\r\nstruct watchdog_device *wdog = dev_get_drvdata(dev);\r\nstruct imx2_wdt_device *wdev = watchdog_get_drvdata(wdog);\r\nif (imx2_wdt_is_running(wdev)) {\r\nimx2_wdt_set_timeout(wdog, IMX2_WDT_MAX_TIME);\r\nimx2_wdt_ping(wdog);\r\n}\r\nclk_disable_unprepare(wdev->clk);\r\nreturn 0;\r\n}\r\nstatic int imx2_wdt_resume(struct device *dev)\r\n{\r\nstruct watchdog_device *wdog = dev_get_drvdata(dev);\r\nstruct imx2_wdt_device *wdev = watchdog_get_drvdata(wdog);\r\nint ret;\r\nret = clk_prepare_enable(wdev->clk);\r\nif (ret)\r\nreturn ret;\r\nif (watchdog_active(wdog) && !imx2_wdt_is_running(wdev)) {\r\nimx2_wdt_setup(wdog);\r\n}\r\nif (imx2_wdt_is_running(wdev)) {\r\nimx2_wdt_set_timeout(wdog, wdog->timeout);\r\nimx2_wdt_ping(wdog);\r\n}\r\nreturn 0;\r\n}

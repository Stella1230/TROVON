acpi_status\r\nacpi_ns_simple_repair(struct acpi_evaluate_info *info,\r\nu32 expected_btypes,\r\nu32 package_index,\r\nunion acpi_operand_object **return_object_ptr)\r\n{\r\nunion acpi_operand_object *return_object = *return_object_ptr;\r\nunion acpi_operand_object *new_object = NULL;\r\nacpi_status status;\r\nconst struct acpi_simple_repair_info *predefined;\r\nACPI_FUNCTION_NAME(ns_simple_repair);\r\npredefined = acpi_ns_match_simple_repair(info->node,\r\ninfo->return_btype,\r\npackage_index);\r\nif (predefined) {\r\nif (!return_object) {\r\nACPI_WARN_PREDEFINED((AE_INFO, info->full_pathname,\r\nACPI_WARN_ALWAYS,\r\n"Missing expected return value"));\r\n}\r\nstatus = predefined->object_converter(info->node, return_object,\r\n&new_object);\r\nif (ACPI_FAILURE(status)) {\r\nACPI_EXCEPTION((AE_INFO, status,\r\n"During return object analysis"));\r\nreturn (status);\r\n}\r\nif (new_object) {\r\ngoto object_repaired;\r\n}\r\n}\r\nif (info->return_btype & expected_btypes) {\r\nreturn (AE_OK);\r\n}\r\nif (!return_object) {\r\nif (expected_btypes && (!(expected_btypes & ACPI_RTYPE_NONE))) {\r\nif (package_index != ACPI_NOT_PACKAGE_ELEMENT) {\r\nACPI_WARN_PREDEFINED((AE_INFO,\r\ninfo->full_pathname,\r\nACPI_WARN_ALWAYS,\r\n"Found unexpected NULL package element"));\r\nstatus =\r\nacpi_ns_repair_null_element(info,\r\nexpected_btypes,\r\npackage_index,\r\nreturn_object_ptr);\r\nif (ACPI_SUCCESS(status)) {\r\nreturn (AE_OK);\r\n}\r\n} else {\r\nACPI_WARN_PREDEFINED((AE_INFO,\r\ninfo->full_pathname,\r\nACPI_WARN_ALWAYS,\r\n"Missing expected return value"));\r\n}\r\nreturn (AE_AML_NO_RETURN_VALUE);\r\n}\r\n}\r\nif (expected_btypes & ACPI_RTYPE_INTEGER) {\r\nstatus = acpi_ns_convert_to_integer(return_object, &new_object);\r\nif (ACPI_SUCCESS(status)) {\r\ngoto object_repaired;\r\n}\r\n}\r\nif (expected_btypes & ACPI_RTYPE_STRING) {\r\nstatus = acpi_ns_convert_to_string(return_object, &new_object);\r\nif (ACPI_SUCCESS(status)) {\r\ngoto object_repaired;\r\n}\r\n}\r\nif (expected_btypes & ACPI_RTYPE_BUFFER) {\r\nstatus = acpi_ns_convert_to_buffer(return_object, &new_object);\r\nif (ACPI_SUCCESS(status)) {\r\ngoto object_repaired;\r\n}\r\n}\r\nif (expected_btypes & ACPI_RTYPE_PACKAGE) {\r\nstatus =\r\nacpi_ns_wrap_with_package(info, return_object, &new_object);\r\nif (ACPI_SUCCESS(status)) {\r\n*return_object_ptr = new_object;\r\ninfo->return_flags |= ACPI_OBJECT_REPAIRED;\r\nreturn (AE_OK);\r\n}\r\n}\r\nreturn (AE_AML_OPERAND_TYPE);\r\nobject_repaired:\r\nif (package_index != ACPI_NOT_PACKAGE_ELEMENT) {\r\nif (!(info->return_flags & ACPI_OBJECT_WRAPPED)) {\r\nnew_object->common.reference_count =\r\nreturn_object->common.reference_count;\r\nif (return_object->common.reference_count > 1) {\r\nreturn_object->common.reference_count--;\r\n}\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_REPAIR,\r\n"%s: Converted %s to expected %s at Package index %u\n",\r\ninfo->full_pathname,\r\nacpi_ut_get_object_type_name(return_object),\r\nacpi_ut_get_object_type_name(new_object),\r\npackage_index));\r\n} else {\r\nACPI_DEBUG_PRINT((ACPI_DB_REPAIR,\r\n"%s: Converted %s to expected %s\n",\r\ninfo->full_pathname,\r\nacpi_ut_get_object_type_name(return_object),\r\nacpi_ut_get_object_type_name(new_object)));\r\n}\r\nacpi_ut_remove_reference(return_object);\r\n*return_object_ptr = new_object;\r\ninfo->return_flags |= ACPI_OBJECT_REPAIRED;\r\nreturn (AE_OK);\r\n}\r\nstatic const struct acpi_simple_repair_info *acpi_ns_match_simple_repair(struct\r\nacpi_namespace_node\r\n*node,\r\nu32\r\nreturn_btype,\r\nu32\r\npackage_index)\r\n{\r\nconst struct acpi_simple_repair_info *this_name;\r\nthis_name = acpi_object_repair_info;\r\nwhile (this_name->object_converter) {\r\nif (ACPI_COMPARE_NAME(node->name.ascii, this_name->name)) {\r\nif ((return_btype & this_name->unexpected_btypes) &&\r\n(this_name->package_index ==\r\nACPI_ALL_PACKAGE_ELEMENTS\r\n|| package_index == this_name->package_index)) {\r\nreturn (this_name);\r\n}\r\nreturn (NULL);\r\n}\r\nthis_name++;\r\n}\r\nreturn (NULL);\r\n}\r\nacpi_status\r\nacpi_ns_repair_null_element(struct acpi_evaluate_info *info,\r\nu32 expected_btypes,\r\nu32 package_index,\r\nunion acpi_operand_object **return_object_ptr)\r\n{\r\nunion acpi_operand_object *return_object = *return_object_ptr;\r\nunion acpi_operand_object *new_object;\r\nACPI_FUNCTION_NAME(ns_repair_null_element);\r\nif (return_object) {\r\nreturn (AE_OK);\r\n}\r\nif (expected_btypes & ACPI_RTYPE_INTEGER) {\r\nnew_object = acpi_ut_create_integer_object((u64)0);\r\n} else if (expected_btypes & ACPI_RTYPE_STRING) {\r\nnew_object = acpi_ut_create_string_object(0);\r\n} else if (expected_btypes & ACPI_RTYPE_BUFFER) {\r\nnew_object = acpi_ut_create_buffer_object(0);\r\n} else {\r\nreturn (AE_AML_OPERAND_TYPE);\r\n}\r\nif (!new_object) {\r\nreturn (AE_NO_MEMORY);\r\n}\r\nnew_object->common.reference_count =\r\ninfo->parent_package->common.reference_count;\r\nACPI_DEBUG_PRINT((ACPI_DB_REPAIR,\r\n"%s: Converted NULL package element to expected %s at index %u\n",\r\ninfo->full_pathname,\r\nacpi_ut_get_object_type_name(new_object),\r\npackage_index));\r\n*return_object_ptr = new_object;\r\ninfo->return_flags |= ACPI_OBJECT_REPAIRED;\r\nreturn (AE_OK);\r\n}\r\nvoid\r\nacpi_ns_remove_null_elements(struct acpi_evaluate_info *info,\r\nu8 package_type,\r\nunion acpi_operand_object *obj_desc)\r\n{\r\nunion acpi_operand_object **source;\r\nunion acpi_operand_object **dest;\r\nu32 count;\r\nu32 new_count;\r\nu32 i;\r\nACPI_FUNCTION_NAME(ns_remove_null_elements);\r\nswitch (package_type) {\r\ncase ACPI_PTYPE1_VAR:\r\ncase ACPI_PTYPE2:\r\ncase ACPI_PTYPE2_COUNT:\r\ncase ACPI_PTYPE2_PKG_COUNT:\r\ncase ACPI_PTYPE2_FIXED:\r\ncase ACPI_PTYPE2_MIN:\r\ncase ACPI_PTYPE2_REV_FIXED:\r\ncase ACPI_PTYPE2_FIX_VAR:\r\nbreak;\r\ndefault:\r\ncase ACPI_PTYPE2_VAR_VAR:\r\ncase ACPI_PTYPE1_FIXED:\r\ncase ACPI_PTYPE1_OPTION:\r\nreturn;\r\n}\r\ncount = obj_desc->package.count;\r\nnew_count = count;\r\nsource = obj_desc->package.elements;\r\ndest = source;\r\nfor (i = 0; i < count; i++) {\r\nif (!*source) {\r\nnew_count--;\r\n} else {\r\n*dest = *source;\r\ndest++;\r\n}\r\nsource++;\r\n}\r\nif (new_count < count) {\r\nACPI_DEBUG_PRINT((ACPI_DB_REPAIR,\r\n"%s: Found and removed %u NULL elements\n",\r\ninfo->full_pathname, (count - new_count)));\r\n*dest = NULL;\r\nobj_desc->package.count = new_count;\r\n}\r\n}\r\nacpi_status\r\nacpi_ns_wrap_with_package(struct acpi_evaluate_info *info,\r\nunion acpi_operand_object *original_object,\r\nunion acpi_operand_object **obj_desc_ptr)\r\n{\r\nunion acpi_operand_object *pkg_obj_desc;\r\nACPI_FUNCTION_NAME(ns_wrap_with_package);\r\npkg_obj_desc = acpi_ut_create_package_object(1);\r\nif (!pkg_obj_desc) {\r\nreturn (AE_NO_MEMORY);\r\n}\r\npkg_obj_desc->package.elements[0] = original_object;\r\nACPI_DEBUG_PRINT((ACPI_DB_REPAIR,\r\n"%s: Wrapped %s with expected Package object\n",\r\ninfo->full_pathname,\r\nacpi_ut_get_object_type_name(original_object)));\r\n*obj_desc_ptr = pkg_obj_desc;\r\ninfo->return_flags |= ACPI_OBJECT_REPAIRED | ACPI_OBJECT_WRAPPED;\r\nreturn (AE_OK);\r\n}

static void lpc18xx_gpio_set(struct gpio_chip *chip, unsigned offset, int value)\r\n{\r\nstruct lpc18xx_gpio_chip *gc = gpiochip_get_data(chip);\r\nwriteb(value ? 1 : 0, gc->base + offset);\r\n}\r\nstatic int lpc18xx_gpio_get(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct lpc18xx_gpio_chip *gc = gpiochip_get_data(chip);\r\nreturn !!readb(gc->base + offset);\r\n}\r\nstatic int lpc18xx_gpio_direction(struct gpio_chip *chip, unsigned offset,\r\nbool out)\r\n{\r\nstruct lpc18xx_gpio_chip *gc = gpiochip_get_data(chip);\r\nunsigned long flags;\r\nu32 port, pin, dir;\r\nport = offset / LPC18XX_PINS_PER_PORT;\r\npin = offset % LPC18XX_PINS_PER_PORT;\r\nspin_lock_irqsave(&gc->lock, flags);\r\ndir = readl(gc->base + LPC18XX_REG_DIR(port));\r\nif (out)\r\ndir |= BIT(pin);\r\nelse\r\ndir &= ~BIT(pin);\r\nwritel(dir, gc->base + LPC18XX_REG_DIR(port));\r\nspin_unlock_irqrestore(&gc->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int lpc18xx_gpio_direction_input(struct gpio_chip *chip,\r\nunsigned offset)\r\n{\r\nreturn lpc18xx_gpio_direction(chip, offset, false);\r\n}\r\nstatic int lpc18xx_gpio_direction_output(struct gpio_chip *chip,\r\nunsigned offset, int value)\r\n{\r\nlpc18xx_gpio_set(chip, offset, value);\r\nreturn lpc18xx_gpio_direction(chip, offset, true);\r\n}\r\nstatic int lpc18xx_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct lpc18xx_gpio_chip *gc;\r\nstruct resource *res;\r\nint ret;\r\ngc = devm_kzalloc(&pdev->dev, sizeof(*gc), GFP_KERNEL);\r\nif (!gc)\r\nreturn -ENOMEM;\r\ngc->gpio = lpc18xx_chip;\r\nplatform_set_drvdata(pdev, gc);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ngc->base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(gc->base))\r\nreturn PTR_ERR(gc->base);\r\ngc->clk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(gc->clk)) {\r\ndev_err(&pdev->dev, "input clock not found\n");\r\nreturn PTR_ERR(gc->clk);\r\n}\r\nret = clk_prepare_enable(gc->clk);\r\nif (ret) {\r\ndev_err(&pdev->dev, "unable to enable clock\n");\r\nreturn ret;\r\n}\r\nspin_lock_init(&gc->lock);\r\ngc->gpio.parent = &pdev->dev;\r\nret = gpiochip_add_data(&gc->gpio, gc);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to add gpio chip\n");\r\nclk_disable_unprepare(gc->clk);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int lpc18xx_gpio_remove(struct platform_device *pdev)\r\n{\r\nstruct lpc18xx_gpio_chip *gc = platform_get_drvdata(pdev);\r\ngpiochip_remove(&gc->gpio);\r\nclk_disable_unprepare(gc->clk);\r\nreturn 0;\r\n}

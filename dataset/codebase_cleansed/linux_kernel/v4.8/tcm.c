static struct tcm_pool *find_pool(unsigned int tag)\r\n{\r\nstruct list_head *lh;\r\nstruct tcm_pool *pool;\r\nlist_for_each(lh, &pool_list) {\r\npool = list_entry(lh, struct tcm_pool, list);\r\nif (pool->tag == tag)\r\nreturn pool;\r\n}\r\nreturn NULL;\r\n}\r\nunsigned long tcm_alloc(unsigned int tag, size_t len)\r\n{\r\nunsigned long vaddr;\r\nstruct tcm_pool *pool;\r\npool = find_pool(tag);\r\nif (!pool)\r\nreturn 0;\r\nvaddr = gen_pool_alloc(pool->pool, len);\r\nif (!vaddr)\r\nreturn 0;\r\nreturn vaddr;\r\n}\r\nvoid tcm_free(unsigned int tag, unsigned long addr, size_t len)\r\n{\r\nstruct tcm_pool *pool;\r\npool = find_pool(tag);\r\nif (!pool)\r\nreturn;\r\ngen_pool_free(pool->pool, addr, len);\r\n}\r\nunsigned int tcm_lookup_tag(unsigned long p)\r\n{\r\nstruct list_head *lh;\r\nstruct tcm_pool *pool;\r\nunsigned long addr = (unsigned long) p;\r\nlist_for_each(lh, &pool_list) {\r\npool = list_entry(lh, struct tcm_pool, list);\r\nif (addr >= pool->start && addr < pool->end)\r\nreturn pool->tag;\r\n}\r\nreturn TCM_INVALID_TAG;\r\n}\r\nint __init tcm_add_region(struct tcm_region *reg)\r\n{\r\nstruct tcm_pool *pool;\r\npool = kmalloc(sizeof(*pool), GFP_KERNEL);\r\nif (!pool) {\r\npr_err("Failed to alloc memory for TCM pool!\n");\r\nreturn -ENOMEM;\r\n}\r\npool->tag = reg->tag;\r\npool->start = reg->res.start;\r\npool->end = reg->res.end;\r\npool->pool = gen_pool_create(3, -1);\r\nif (!pool->pool) {\r\npr_err("Failed to create TCM pool!\n");\r\nkfree(pool);\r\nreturn -ENOMEM;\r\n}\r\nif (gen_pool_add(pool->pool, reg->res.start,\r\nreg->res.end - reg->res.start + 1, -1)) {\r\npr_err("Failed to add memory to TCM pool!\n");\r\nreturn -ENOMEM;\r\n}\r\npr_info("Added %s TCM pool (%08x bytes @ %08x)\n",\r\nreg->res.name, reg->res.end - reg->res.start + 1,\r\nreg->res.start);\r\nlist_add_tail(&pool->list, &pool_list);\r\nreturn 0;\r\n}

int prism2mgmt_scan(wlandevice_t *wlandev, void *msgp)\r\n{\r\nint result = 0;\r\nhfa384x_t *hw = wlandev->priv;\r\nstruct p80211msg_dot11req_scan *msg = msgp;\r\nu16 roamingmode, word;\r\nint i, timeout;\r\nint istmpenable = 0;\r\nhfa384x_HostScanRequest_data_t scanreq;\r\nif (HFA384x_FIRMWARE_VERSION(hw->ident_sta_fw.major,\r\nhw->ident_sta_fw.minor,\r\nhw->ident_sta_fw.variant) <\r\nHFA384x_FIRMWARE_VERSION(1, 3, 2)) {\r\nnetdev_err(wlandev->netdev,\r\n"HostScan not supported with current firmware (<1.3.2).\n");\r\nresult = 1;\r\nmsg->resultcode.data = P80211ENUM_resultcode_not_supported;\r\ngoto exit;\r\n}\r\nmemset(&scanreq, 0, sizeof(scanreq));\r\nresult = hfa384x_drvr_getconfig16(hw,\r\nHFA384x_RID_CNFROAMINGMODE,\r\n&roamingmode);\r\nif (result) {\r\nnetdev_err(wlandev->netdev,\r\n"getconfig(ROAMMODE) failed. result=%d\n", result);\r\nmsg->resultcode.data =\r\nP80211ENUM_resultcode_implementation_failure;\r\ngoto exit;\r\n}\r\nresult = hfa384x_drvr_setconfig16(hw,\r\nHFA384x_RID_CNFROAMINGMODE,\r\nHFA384x_ROAMMODE_HOSTSCAN_HOSTROAM);\r\nif (result) {\r\nnetdev_err(wlandev->netdev,\r\n"setconfig(ROAMINGMODE) failed. result=%d\n",\r\nresult);\r\nmsg->resultcode.data =\r\nP80211ENUM_resultcode_implementation_failure;\r\ngoto exit;\r\n}\r\nif (HFA384x_FIRMWARE_VERSION(hw->ident_sta_fw.major,\r\nhw->ident_sta_fw.minor,\r\nhw->ident_sta_fw.variant) >\r\nHFA384x_FIRMWARE_VERSION(1, 5, 0)) {\r\nif (msg->scantype.data != P80211ENUM_scantype_active)\r\nword = cpu_to_le16(msg->maxchanneltime.data);\r\nelse\r\nword = 0;\r\nresult =\r\nhfa384x_drvr_setconfig16(hw, HFA384x_RID_CNFPASSIVESCANCTRL,\r\nword);\r\nif (result) {\r\nnetdev_warn(wlandev->netdev,\r\n"Passive scan not supported with current firmware. (<1.5.1)\n");\r\n}\r\n}\r\nword = HFA384x_RATEBIT_2;\r\nscanreq.txRate = cpu_to_le16(word);\r\nword = 0;\r\nfor (i = 0; i < msg->channellist.data.len; i++) {\r\nu8 channel = msg->channellist.data.data[i];\r\nif (channel > 14)\r\ncontinue;\r\nword |= (1 << (channel - 1));\r\n}\r\nscanreq.channelList = cpu_to_le16(word);\r\nscanreq.ssid.len = cpu_to_le16(msg->ssid.data.len);\r\nmemcpy(scanreq.ssid.data, msg->ssid.data.data, msg->ssid.data.len);\r\nresult = hfa384x_drvr_getconfig16(hw, HFA384x_RID_PORTSTATUS, &word);\r\nif (result) {\r\nnetdev_err(wlandev->netdev,\r\n"getconfig(PORTSTATUS) failed. result=%d\n", result);\r\nmsg->resultcode.data =\r\nP80211ENUM_resultcode_implementation_failure;\r\ngoto exit;\r\n}\r\nif (word == HFA384x_PORTSTATUS_DISABLED) {\r\nu16 wordbuf[17];\r\nresult = hfa384x_drvr_setconfig16(hw,\r\nHFA384x_RID_CNFROAMINGMODE,\r\nHFA384x_ROAMMODE_HOSTSCAN_HOSTROAM);\r\nif (result) {\r\nnetdev_err(wlandev->netdev,\r\n"setconfig(ROAMINGMODE) failed. result=%d\n",\r\nresult);\r\nmsg->resultcode.data =\r\nP80211ENUM_resultcode_implementation_failure;\r\ngoto exit;\r\n}\r\nwordbuf[0] = cpu_to_le16(WLAN_SSID_MAXLEN);\r\nget_random_bytes(&wordbuf[1], WLAN_SSID_MAXLEN);\r\nresult = hfa384x_drvr_setconfig(hw, HFA384x_RID_CNFOWNSSID,\r\nwordbuf,\r\nHFA384x_RID_CNFOWNSSID_LEN);\r\nif (result) {\r\nnetdev_err(wlandev->netdev, "Failed to set OwnSSID.\n");\r\nmsg->resultcode.data =\r\nP80211ENUM_resultcode_implementation_failure;\r\ngoto exit;\r\n}\r\nresult = hfa384x_drvr_setconfig(hw, HFA384x_RID_CNFDESIREDSSID,\r\nwordbuf,\r\nHFA384x_RID_CNFDESIREDSSID_LEN);\r\nif (result) {\r\nnetdev_err(wlandev->netdev,\r\n"Failed to set DesiredSSID.\n");\r\nmsg->resultcode.data =\r\nP80211ENUM_resultcode_implementation_failure;\r\ngoto exit;\r\n}\r\nresult = hfa384x_drvr_setconfig16(hw,\r\nHFA384x_RID_CNFPORTTYPE,\r\nHFA384x_PORTTYPE_IBSS);\r\nif (result) {\r\nnetdev_err(wlandev->netdev,\r\n"Failed to set CNFPORTTYPE.\n");\r\nmsg->resultcode.data =\r\nP80211ENUM_resultcode_implementation_failure;\r\ngoto exit;\r\n}\r\nresult = hfa384x_drvr_setconfig16(hw,\r\nHFA384x_RID_CREATEIBSS,\r\nHFA384x_CREATEIBSS_JOINCREATEIBSS);\r\nif (result) {\r\nnetdev_err(wlandev->netdev,\r\n"Failed to set CREATEIBSS.\n");\r\nmsg->resultcode.data =\r\nP80211ENUM_resultcode_implementation_failure;\r\ngoto exit;\r\n}\r\nresult = hfa384x_drvr_enable(hw, 0);\r\nif (result) {\r\nnetdev_err(wlandev->netdev,\r\n"drvr_enable(0) failed. result=%d\n",\r\nresult);\r\nmsg->resultcode.data =\r\nP80211ENUM_resultcode_implementation_failure;\r\ngoto exit;\r\n}\r\nistmpenable = 1;\r\n}\r\ntimeout = msg->channellist.data.len * msg->maxchanneltime.data;\r\ntimeout = (timeout * HZ) / 1000;\r\nhw->scanflag = 0;\r\nresult = hfa384x_drvr_setconfig(hw,\r\nHFA384x_RID_HOSTSCAN, &scanreq,\r\nsizeof(hfa384x_HostScanRequest_data_t));\r\nif (result) {\r\nnetdev_err(wlandev->netdev,\r\n"setconfig(SCANREQUEST) failed. result=%d\n",\r\nresult);\r\nmsg->resultcode.data =\r\nP80211ENUM_resultcode_implementation_failure;\r\ngoto exit;\r\n}\r\nwait_event_interruptible_timeout(hw->cmdq, hw->scanflag, timeout);\r\nmsg->numbss.status = P80211ENUM_msgitem_status_data_ok;\r\nif (hw->scanflag == -1)\r\nhw->scanflag = 0;\r\nmsg->numbss.data = hw->scanflag;\r\nhw->scanflag = 0;\r\nif (istmpenable) {\r\nresult = hfa384x_drvr_disable(hw, 0);\r\nif (result) {\r\nnetdev_err(wlandev->netdev,\r\n"drvr_disable(0) failed. result=%d\n",\r\nresult);\r\nmsg->resultcode.data =\r\nP80211ENUM_resultcode_implementation_failure;\r\ngoto exit;\r\n}\r\n}\r\nresult = hfa384x_drvr_setconfig16(hw, HFA384x_RID_CNFROAMINGMODE,\r\nroamingmode);\r\nif (result) {\r\nnetdev_err(wlandev->netdev,\r\n"setconfig(ROAMMODE) failed. result=%d\n", result);\r\nmsg->resultcode.data =\r\nP80211ENUM_resultcode_implementation_failure;\r\ngoto exit;\r\n}\r\nresult = 0;\r\nmsg->resultcode.data = P80211ENUM_resultcode_success;\r\nexit:\r\nmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\r\nreturn result;\r\n}\r\nint prism2mgmt_scan_results(wlandevice_t *wlandev, void *msgp)\r\n{\r\nint result = 0;\r\nstruct p80211msg_dot11req_scan_results *req;\r\nhfa384x_t *hw = wlandev->priv;\r\nhfa384x_HScanResultSub_t *item = NULL;\r\nint count;\r\nreq = msgp;\r\nreq->resultcode.status = P80211ENUM_msgitem_status_data_ok;\r\nif (!hw->scanresults) {\r\nnetdev_err(wlandev->netdev,\r\n"dot11req_scan_results can only be used after a successful dot11req_scan.\n");\r\nresult = 2;\r\nreq->resultcode.data = P80211ENUM_resultcode_invalid_parameters;\r\ngoto exit;\r\n}\r\ncount = (hw->scanresults->framelen - 3) / 32;\r\nif (count > HFA384x_SCANRESULT_MAX)\r\ncount = HFA384x_SCANRESULT_MAX;\r\nif (req->bssindex.data >= count) {\r\npr_debug("requested index (%d) out of range (%d)\n",\r\nreq->bssindex.data, count);\r\nresult = 2;\r\nreq->resultcode.data = P80211ENUM_resultcode_invalid_parameters;\r\ngoto exit;\r\n}\r\nitem = &(hw->scanresults->info.hscanresult.result[req->bssindex.data]);\r\nreq->signal.status = P80211ENUM_msgitem_status_data_ok;\r\nreq->noise.status = P80211ENUM_msgitem_status_data_ok;\r\nreq->signal.data = le16_to_cpu(item->sl);\r\nreq->noise.data = le16_to_cpu(item->anl);\r\nreq->bssid.status = P80211ENUM_msgitem_status_data_ok;\r\nreq->bssid.data.len = WLAN_BSSID_LEN;\r\nmemcpy(req->bssid.data.data, item->bssid, WLAN_BSSID_LEN);\r\nreq->ssid.status = P80211ENUM_msgitem_status_data_ok;\r\nreq->ssid.data.len = le16_to_cpu(item->ssid.len);\r\nreq->ssid.data.len = min_t(u16, req->ssid.data.len, WLAN_SSID_MAXLEN);\r\nmemcpy(req->ssid.data.data, item->ssid.data, req->ssid.data.len);\r\nfor (count = 0; count < 10; count++)\r\nif (item->supprates[count] == 0)\r\nbreak;\r\n#define REQBASICRATE(N) \\r\ndo { \\r\nif ((count >= N) && DOT11_RATE5_ISBASIC_GET( \\r\nitem->supprates[(N)-1])) { \\r\nreq->basicrate ## N .data = item->supprates[(N)-1]; \\r\nreq->basicrate ## N .status = \\r\nP80211ENUM_msgitem_status_data_ok; \\r\n} \\r\n} while (0)\r\nREQBASICRATE(1);\r\nREQBASICRATE(2);\r\nREQBASICRATE(3);\r\nREQBASICRATE(4);\r\nREQBASICRATE(5);\r\nREQBASICRATE(6);\r\nREQBASICRATE(7);\r\nREQBASICRATE(8);\r\n#define REQSUPPRATE(N) \\r\ndo { \\r\nif (count >= N) { \\r\nreq->supprate ## N .data = item->supprates[(N)-1]; \\r\nreq->supprate ## N .status = \\r\nP80211ENUM_msgitem_status_data_ok; \\r\n} \\r\n} while (0)\r\nREQSUPPRATE(1);\r\nREQSUPPRATE(2);\r\nREQSUPPRATE(3);\r\nREQSUPPRATE(4);\r\nREQSUPPRATE(5);\r\nREQSUPPRATE(6);\r\nREQSUPPRATE(7);\r\nREQSUPPRATE(8);\r\nreq->beaconperiod.status = P80211ENUM_msgitem_status_data_ok;\r\nreq->beaconperiod.data = le16_to_cpu(item->bcnint);\r\nreq->timestamp.status = P80211ENUM_msgitem_status_data_ok;\r\nreq->timestamp.data = jiffies;\r\nreq->localtime.status = P80211ENUM_msgitem_status_data_ok;\r\nreq->localtime.data = jiffies;\r\nreq->ibssatimwindow.status = P80211ENUM_msgitem_status_data_ok;\r\nreq->ibssatimwindow.data = le16_to_cpu(item->atim);\r\nreq->dschannel.status = P80211ENUM_msgitem_status_data_ok;\r\nreq->dschannel.data = le16_to_cpu(item->chid);\r\ncount = le16_to_cpu(item->capinfo);\r\nreq->capinfo.status = P80211ENUM_msgitem_status_data_ok;\r\nreq->capinfo.data = count;\r\nreq->privacy.status = P80211ENUM_msgitem_status_data_ok;\r\nreq->privacy.data = WLAN_GET_MGMT_CAP_INFO_PRIVACY(count);\r\nreq->cfpollable.status = P80211ENUM_msgitem_status_data_ok;\r\nreq->cfpollable.data = WLAN_GET_MGMT_CAP_INFO_CFPOLLABLE(count);\r\nreq->cfpollreq.status = P80211ENUM_msgitem_status_data_ok;\r\nreq->cfpollreq.data = WLAN_GET_MGMT_CAP_INFO_CFPOLLREQ(count);\r\nreq->bsstype.status = P80211ENUM_msgitem_status_data_ok;\r\nreq->bsstype.data = (WLAN_GET_MGMT_CAP_INFO_ESS(count)) ?\r\nP80211ENUM_bsstype_infrastructure : P80211ENUM_bsstype_independent;\r\nresult = 0;\r\nreq->resultcode.data = P80211ENUM_resultcode_success;\r\nexit:\r\nreturn result;\r\n}\r\nint prism2mgmt_start(wlandevice_t *wlandev, void *msgp)\r\n{\r\nint result = 0;\r\nhfa384x_t *hw = wlandev->priv;\r\nstruct p80211msg_dot11req_start *msg = msgp;\r\np80211pstrd_t *pstr;\r\nu8 bytebuf[80];\r\nstruct hfa384x_bytestr *p2bytestr = (struct hfa384x_bytestr *) bytebuf;\r\nu16 word;\r\nwlandev->macmode = WLAN_MACMODE_NONE;\r\nmemcpy(&wlandev->ssid, &msg->ssid.data, sizeof(msg->ssid.data));\r\nif (HFA384x_FIRMWARE_VERSION(hw->ident_sta_fw.major,\r\nhw->ident_sta_fw.minor,\r\nhw->ident_sta_fw.variant) <\r\nHFA384x_FIRMWARE_VERSION(0, 8, 3)) {\r\nmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\r\nmsg->resultcode.data = P80211ENUM_resultcode_not_supported;\r\ngoto done;\r\n}\r\nmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\r\npstr = (p80211pstrd_t *) &(msg->ssid.data);\r\nprism2mgmt_pstr2bytestr(p2bytestr, pstr);\r\nresult = hfa384x_drvr_setconfig(hw, HFA384x_RID_CNFOWNSSID,\r\nbytebuf, HFA384x_RID_CNFOWNSSID_LEN);\r\nif (result) {\r\nnetdev_err(wlandev->netdev, "Failed to set CnfOwnSSID\n");\r\ngoto failed;\r\n}\r\nresult = hfa384x_drvr_setconfig(hw, HFA384x_RID_CNFDESIREDSSID,\r\nbytebuf,\r\nHFA384x_RID_CNFDESIREDSSID_LEN);\r\nif (result) {\r\nnetdev_err(wlandev->netdev, "Failed to set CnfDesiredSSID\n");\r\ngoto failed;\r\n}\r\nhfa384x_drvr_setconfig16(hw, HFA384x_RID_CNFPORTTYPE, 0);\r\nword = msg->beaconperiod.data;\r\nresult = hfa384x_drvr_setconfig16(hw, HFA384x_RID_CNFAPBCNint, word);\r\nif (result) {\r\nnetdev_err(wlandev->netdev,\r\n"Failed to set beacon period=%d.\n", word);\r\ngoto failed;\r\n}\r\nword = msg->dschannel.data;\r\nresult = hfa384x_drvr_setconfig16(hw, HFA384x_RID_CNFOWNCHANNEL, word);\r\nif (result) {\r\nnetdev_err(wlandev->netdev,\r\n"Failed to set channel=%d.\n", word);\r\ngoto failed;\r\n}\r\nword = p80211rate_to_p2bit(msg->basicrate1.data);\r\nif (msg->basicrate2.status == P80211ENUM_msgitem_status_data_ok)\r\nword |= p80211rate_to_p2bit(msg->basicrate2.data);\r\nif (msg->basicrate3.status == P80211ENUM_msgitem_status_data_ok)\r\nword |= p80211rate_to_p2bit(msg->basicrate3.data);\r\nif (msg->basicrate4.status == P80211ENUM_msgitem_status_data_ok)\r\nword |= p80211rate_to_p2bit(msg->basicrate4.data);\r\nif (msg->basicrate5.status == P80211ENUM_msgitem_status_data_ok)\r\nword |= p80211rate_to_p2bit(msg->basicrate5.data);\r\nif (msg->basicrate6.status == P80211ENUM_msgitem_status_data_ok)\r\nword |= p80211rate_to_p2bit(msg->basicrate6.data);\r\nif (msg->basicrate7.status == P80211ENUM_msgitem_status_data_ok)\r\nword |= p80211rate_to_p2bit(msg->basicrate7.data);\r\nif (msg->basicrate8.status == P80211ENUM_msgitem_status_data_ok)\r\nword |= p80211rate_to_p2bit(msg->basicrate8.data);\r\nresult = hfa384x_drvr_setconfig16(hw, HFA384x_RID_CNFBASICRATES, word);\r\nif (result) {\r\nnetdev_err(wlandev->netdev,\r\n"Failed to set basicrates=%d.\n", word);\r\ngoto failed;\r\n}\r\nword = p80211rate_to_p2bit(msg->operationalrate1.data);\r\nif (msg->operationalrate2.status == P80211ENUM_msgitem_status_data_ok)\r\nword |= p80211rate_to_p2bit(msg->operationalrate2.data);\r\nif (msg->operationalrate3.status == P80211ENUM_msgitem_status_data_ok)\r\nword |= p80211rate_to_p2bit(msg->operationalrate3.data);\r\nif (msg->operationalrate4.status == P80211ENUM_msgitem_status_data_ok)\r\nword |= p80211rate_to_p2bit(msg->operationalrate4.data);\r\nif (msg->operationalrate5.status == P80211ENUM_msgitem_status_data_ok)\r\nword |= p80211rate_to_p2bit(msg->operationalrate5.data);\r\nif (msg->operationalrate6.status == P80211ENUM_msgitem_status_data_ok)\r\nword |= p80211rate_to_p2bit(msg->operationalrate6.data);\r\nif (msg->operationalrate7.status == P80211ENUM_msgitem_status_data_ok)\r\nword |= p80211rate_to_p2bit(msg->operationalrate7.data);\r\nif (msg->operationalrate8.status == P80211ENUM_msgitem_status_data_ok)\r\nword |= p80211rate_to_p2bit(msg->operationalrate8.data);\r\nresult = hfa384x_drvr_setconfig16(hw, HFA384x_RID_CNFSUPPRATES, word);\r\nif (result) {\r\nnetdev_err(wlandev->netdev,\r\n"Failed to set supprates=%d.\n", word);\r\ngoto failed;\r\n}\r\nresult = hfa384x_drvr_setconfig16(hw, HFA384x_RID_TXRATECNTL, word);\r\nif (result) {\r\nnetdev_err(wlandev->netdev, "Failed to set txrates=%d.\n",\r\nword);\r\ngoto failed;\r\n}\r\nif (msg->bsstype.data == P80211ENUM_bsstype_independent) {\r\nwlandev->macmode = WLAN_MACMODE_IBSS_STA;\r\nhfa384x_drvr_setconfig16(hw, HFA384x_RID_CNFMAXDATALEN, 2304);\r\n}\r\nresult = hfa384x_drvr_enable(hw, 0);\r\nif (result) {\r\nnetdev_err(wlandev->netdev,\r\n"Enable macport failed, result=%d.\n", result);\r\ngoto failed;\r\n}\r\nmsg->resultcode.data = P80211ENUM_resultcode_success;\r\ngoto done;\r\nfailed:\r\npr_debug("Failed to set a config option, result=%d\n", result);\r\nmsg->resultcode.data = P80211ENUM_resultcode_invalid_parameters;\r\ndone:\r\nresult = 0;\r\nreturn result;\r\n}\r\nint prism2mgmt_readpda(wlandevice_t *wlandev, void *msgp)\r\n{\r\nhfa384x_t *hw = wlandev->priv;\r\nstruct p80211msg_p2req_readpda *msg = msgp;\r\nint result;\r\nif (wlandev->msdstate != WLAN_MSD_FWLOAD) {\r\nnetdev_err(wlandev->netdev,\r\n"PDA may only be read in the fwload state.\n");\r\nmsg->resultcode.data =\r\nP80211ENUM_resultcode_implementation_failure;\r\nmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\r\n} else {\r\nresult = hfa384x_drvr_readpda(hw,\r\nmsg->pda.data,\r\nHFA384x_PDA_LEN_MAX);\r\nif (result) {\r\nnetdev_err(wlandev->netdev,\r\n"hfa384x_drvr_readpda() failed, result=%d\n",\r\nresult);\r\nmsg->resultcode.data =\r\nP80211ENUM_resultcode_implementation_failure;\r\nmsg->resultcode.status =\r\nP80211ENUM_msgitem_status_data_ok;\r\nreturn 0;\r\n}\r\nmsg->pda.status = P80211ENUM_msgitem_status_data_ok;\r\nmsg->resultcode.data = P80211ENUM_resultcode_success;\r\nmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\r\n}\r\nreturn 0;\r\n}\r\nint prism2mgmt_ramdl_state(wlandevice_t *wlandev, void *msgp)\r\n{\r\nhfa384x_t *hw = wlandev->priv;\r\nstruct p80211msg_p2req_ramdl_state *msg = msgp;\r\nif (wlandev->msdstate != WLAN_MSD_FWLOAD) {\r\nnetdev_err(wlandev->netdev,\r\n"ramdl_state(): may only be called in the fwload state.\n");\r\nmsg->resultcode.data =\r\nP80211ENUM_resultcode_implementation_failure;\r\nmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\r\nreturn 0;\r\n}\r\nmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\r\nif (msg->enable.data == P80211ENUM_truth_true) {\r\nif (hfa384x_drvr_ramdl_enable(hw, msg->exeaddr.data)) {\r\nmsg->resultcode.data =\r\nP80211ENUM_resultcode_implementation_failure;\r\n} else {\r\nmsg->resultcode.data = P80211ENUM_resultcode_success;\r\n}\r\n} else {\r\nhfa384x_drvr_ramdl_disable(hw);\r\nmsg->resultcode.data = P80211ENUM_resultcode_success;\r\n}\r\nreturn 0;\r\n}\r\nint prism2mgmt_ramdl_write(wlandevice_t *wlandev, void *msgp)\r\n{\r\nhfa384x_t *hw = wlandev->priv;\r\nstruct p80211msg_p2req_ramdl_write *msg = msgp;\r\nu32 addr;\r\nu32 len;\r\nu8 *buf;\r\nif (wlandev->msdstate != WLAN_MSD_FWLOAD) {\r\nnetdev_err(wlandev->netdev,\r\n"ramdl_write(): may only be called in the fwload state.\n");\r\nmsg->resultcode.data =\r\nP80211ENUM_resultcode_implementation_failure;\r\nmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\r\nreturn 0;\r\n}\r\nmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\r\nif (msg->len.data > sizeof(msg->data.data)) {\r\nmsg->resultcode.status =\r\nP80211ENUM_resultcode_invalid_parameters;\r\nreturn 0;\r\n}\r\naddr = msg->addr.data;\r\nlen = msg->len.data;\r\nbuf = msg->data.data;\r\nif (hfa384x_drvr_ramdl_write(hw, addr, buf, len))\r\nmsg->resultcode.data = P80211ENUM_resultcode_refused;\r\nmsg->resultcode.data = P80211ENUM_resultcode_success;\r\nreturn 0;\r\n}\r\nint prism2mgmt_flashdl_state(wlandevice_t *wlandev, void *msgp)\r\n{\r\nint result = 0;\r\nhfa384x_t *hw = wlandev->priv;\r\nstruct p80211msg_p2req_flashdl_state *msg = msgp;\r\nif (wlandev->msdstate != WLAN_MSD_FWLOAD) {\r\nnetdev_err(wlandev->netdev,\r\n"flashdl_state(): may only be called in the fwload state.\n");\r\nmsg->resultcode.data =\r\nP80211ENUM_resultcode_implementation_failure;\r\nmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\r\nreturn 0;\r\n}\r\nmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\r\nif (msg->enable.data == P80211ENUM_truth_true) {\r\nif (hfa384x_drvr_flashdl_enable(hw)) {\r\nmsg->resultcode.data =\r\nP80211ENUM_resultcode_implementation_failure;\r\n} else {\r\nmsg->resultcode.data = P80211ENUM_resultcode_success;\r\n}\r\n} else {\r\nhfa384x_drvr_flashdl_disable(hw);\r\nmsg->resultcode.data = P80211ENUM_resultcode_success;\r\nwlandev->msdstate = WLAN_MSD_HWPRESENT;\r\nresult = prism2sta_ifstate(wlandev, P80211ENUM_ifstate_fwload);\r\nif (result != P80211ENUM_resultcode_success) {\r\nnetdev_err(wlandev->netdev,\r\n"prism2sta_ifstate(fwload) failed, P80211ENUM_resultcode=%d\n",\r\nresult);\r\nmsg->resultcode.data =\r\nP80211ENUM_resultcode_implementation_failure;\r\nresult = -1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint prism2mgmt_flashdl_write(wlandevice_t *wlandev, void *msgp)\r\n{\r\nhfa384x_t *hw = wlandev->priv;\r\nstruct p80211msg_p2req_flashdl_write *msg = msgp;\r\nu32 addr;\r\nu32 len;\r\nu8 *buf;\r\nif (wlandev->msdstate != WLAN_MSD_FWLOAD) {\r\nnetdev_err(wlandev->netdev,\r\n"flashdl_write(): may only be called in the fwload state.\n");\r\nmsg->resultcode.data =\r\nP80211ENUM_resultcode_implementation_failure;\r\nmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\r\nreturn 0;\r\n}\r\nmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\r\nif (msg->len.data > sizeof(msg->data.data)) {\r\nmsg->resultcode.status =\r\nP80211ENUM_resultcode_invalid_parameters;\r\nreturn 0;\r\n}\r\naddr = msg->addr.data;\r\nlen = msg->len.data;\r\nbuf = msg->data.data;\r\nif (hfa384x_drvr_flashdl_write(hw, addr, buf, len))\r\nmsg->resultcode.data = P80211ENUM_resultcode_refused;\r\nmsg->resultcode.data = P80211ENUM_resultcode_success;\r\nreturn 0;\r\n}\r\nint prism2mgmt_autojoin(wlandevice_t *wlandev, void *msgp)\r\n{\r\nhfa384x_t *hw = wlandev->priv;\r\nint result = 0;\r\nu16 reg;\r\nu16 port_type;\r\nstruct p80211msg_lnxreq_autojoin *msg = msgp;\r\np80211pstrd_t *pstr;\r\nu8 bytebuf[256];\r\nstruct hfa384x_bytestr *p2bytestr = (struct hfa384x_bytestr *) bytebuf;\r\nwlandev->macmode = WLAN_MACMODE_NONE;\r\nmemcpy(&wlandev->ssid, &msg->ssid.data, sizeof(msg->ssid.data));\r\nhfa384x_drvr_disable(hw, 0);\r\nhfa384x_drvr_setconfig16(hw, HFA384x_RID_TXRATECNTL, 0x000f);\r\nif (msg->authtype.data == P80211ENUM_authalg_sharedkey)\r\nreg = HFA384x_CNFAUTHENTICATION_SHAREDKEY;\r\nelse\r\nreg = HFA384x_CNFAUTHENTICATION_OPENSYSTEM;\r\nhfa384x_drvr_setconfig16(hw, HFA384x_RID_CNFAUTHENTICATION, reg);\r\nmemset(bytebuf, 0, 256);\r\npstr = (p80211pstrd_t *) &(msg->ssid.data);\r\nprism2mgmt_pstr2bytestr(p2bytestr, pstr);\r\nresult = hfa384x_drvr_setconfig(hw, HFA384x_RID_CNFDESIREDSSID,\r\nbytebuf,\r\nHFA384x_RID_CNFDESIREDSSID_LEN);\r\nport_type = HFA384x_PORTTYPE_BSS;\r\nhfa384x_drvr_setconfig16(hw, HFA384x_RID_CNFPORTTYPE, port_type);\r\nhfa384x_drvr_enable(hw, 0);\r\nmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\r\nmsg->resultcode.data = P80211ENUM_resultcode_success;\r\nreturn result;\r\n}\r\nint prism2mgmt_wlansniff(wlandevice_t *wlandev, void *msgp)\r\n{\r\nint result = 0;\r\nstruct p80211msg_lnxreq_wlansniff *msg = msgp;\r\nhfa384x_t *hw = wlandev->priv;\r\nu16 word;\r\nmsg->resultcode.status = P80211ENUM_msgitem_status_data_ok;\r\nswitch (msg->enable.data) {\r\ncase P80211ENUM_truth_false:\r\nif (wlandev->netdev->type == ARPHRD_ETHER) {\r\nmsg->resultcode.data =\r\nP80211ENUM_resultcode_invalid_parameters;\r\nreturn 0;\r\n}\r\nresult = hfa384x_cmd_monitor(hw, HFA384x_MONITOR_DISABLE);\r\nif (result) {\r\npr_debug("failed to disable monitor mode, result=%d\n",\r\nresult);\r\ngoto failed;\r\n}\r\nresult = hfa384x_drvr_disable(hw, 0);\r\nif (result) {\r\npr_debug\r\n("failed to disable port 0 after sniffing, result=%d\n",\r\nresult);\r\ngoto failed;\r\n}\r\nwlandev->netdev->type = ARPHRD_ETHER;\r\nresult = hfa384x_drvr_setconfig16(hw,\r\nHFA384x_RID_CNFWEPFLAGS,\r\nhw->presniff_wepflags);\r\nif (result) {\r\npr_debug\r\n("failed to restore wepflags=0x%04x, result=%d\n",\r\nhw->presniff_wepflags, result);\r\ngoto failed;\r\n}\r\nif (hw->presniff_port_type != 0) {\r\nword = hw->presniff_port_type;\r\nresult = hfa384x_drvr_setconfig16(hw,\r\nHFA384x_RID_CNFPORTTYPE,\r\nword);\r\nif (result) {\r\npr_debug\r\n("failed to restore porttype, result=%d\n",\r\nresult);\r\ngoto failed;\r\n}\r\nresult = hfa384x_drvr_enable(hw, 0);\r\nif (result) {\r\npr_debug("failed to enable port to presniff setting, result=%d\n",\r\nresult);\r\ngoto failed;\r\n}\r\n} else {\r\nresult = hfa384x_drvr_disable(hw, 0);\r\n}\r\nnetdev_info(wlandev->netdev, "monitor mode disabled\n");\r\nmsg->resultcode.data = P80211ENUM_resultcode_success;\r\nreturn 0;\r\ncase P80211ENUM_truth_true:\r\nif (hw->port_enabled[0]) {\r\nif (wlandev->netdev->type == ARPHRD_ETHER) {\r\nresult = hfa384x_drvr_getconfig16(hw,\r\nHFA384x_RID_CNFPORTTYPE,\r\n&(hw->presniff_port_type));\r\nif (result) {\r\npr_debug\r\n("failed to read porttype, result=%d\n",\r\nresult);\r\ngoto failed;\r\n}\r\nresult = hfa384x_drvr_getconfig16(hw,\r\nHFA384x_RID_CNFWEPFLAGS,\r\n&(hw->presniff_wepflags));\r\nif (result) {\r\npr_debug\r\n("failed to read wepflags, result=%d\n",\r\nresult);\r\ngoto failed;\r\n}\r\nhfa384x_drvr_stop(hw);\r\nresult = hfa384x_drvr_start(hw);\r\nif (result) {\r\npr_debug("failed to restart the card for sniffing, result=%d\n",\r\nresult);\r\ngoto failed;\r\n}\r\n} else {\r\nresult = hfa384x_drvr_disable(hw, 0);\r\nif (result) {\r\npr_debug("failed to enable port for sniffing, result=%d\n",\r\nresult);\r\ngoto failed;\r\n}\r\n}\r\n} else {\r\nhw->presniff_port_type = 0;\r\n}\r\nword = msg->channel.data;\r\nresult = hfa384x_drvr_setconfig16(hw,\r\nHFA384x_RID_CNFOWNCHANNEL,\r\nword);\r\nhw->sniff_channel = word;\r\nif (result) {\r\npr_debug("failed to set channel %d, result=%d\n",\r\nword, result);\r\ngoto failed;\r\n}\r\nif (wlandev->netdev->type != ARPHRD_ETHER) {\r\nword = HFA384x_PORTTYPE_PSUEDOIBSS;\r\nresult = hfa384x_drvr_setconfig16(hw,\r\nHFA384x_RID_CNFPORTTYPE,\r\nword);\r\nif (result) {\r\npr_debug\r\n("failed to set porttype %d, result=%d\n",\r\nword, result);\r\ngoto failed;\r\n}\r\nif ((msg->keepwepflags.status ==\r\nP80211ENUM_msgitem_status_data_ok)\r\n&& (msg->keepwepflags.data !=\r\nP80211ENUM_truth_true)) {\r\nword = HFA384x_WEPFLAGS_DISABLE_TXCRYPT |\r\nHFA384x_WEPFLAGS_DISABLE_RXCRYPT;\r\nresult =\r\nhfa384x_drvr_setconfig16(hw,\r\nHFA384x_RID_CNFWEPFLAGS,\r\nword);\r\n}\r\nif (result) {\r\npr_debug\r\n("failed to set wepflags=0x%04x, result=%d\n",\r\nword, result);\r\ngoto failed;\r\n}\r\n}\r\nif ((msg->stripfcs.status == P80211ENUM_msgitem_status_data_ok)\r\n&& (msg->stripfcs.data == P80211ENUM_truth_true)) {\r\nhw->sniff_fcs = 0;\r\n} else {\r\nhw->sniff_fcs = 1;\r\n}\r\nif (msg->packet_trunc.status ==\r\nP80211ENUM_msgitem_status_data_ok) {\r\nhw->sniff_truncate = msg->packet_trunc.data;\r\n} else {\r\nhw->sniff_truncate = 0;\r\n}\r\nresult = hfa384x_drvr_enable(hw, 0);\r\nif (result) {\r\npr_debug\r\n("failed to enable port for sniffing, result=%d\n",\r\nresult);\r\ngoto failed;\r\n}\r\nresult = hfa384x_cmd_monitor(hw, HFA384x_MONITOR_ENABLE);\r\nif (result) {\r\npr_debug("failed to enable monitor mode, result=%d\n",\r\nresult);\r\ngoto failed;\r\n}\r\nif (wlandev->netdev->type == ARPHRD_ETHER)\r\nnetdev_info(wlandev->netdev, "monitor mode enabled\n");\r\nif ((msg->prismheader.status ==\r\nP80211ENUM_msgitem_status_data_ok)\r\n&& (msg->prismheader.data == P80211ENUM_truth_true)) {\r\nhw->sniffhdr = 0;\r\nwlandev->netdev->type = ARPHRD_IEEE80211_PRISM;\r\n} else\r\nif ((msg->wlanheader.status ==\r\nP80211ENUM_msgitem_status_data_ok)\r\n&& (msg->wlanheader.data == P80211ENUM_truth_true)) {\r\nhw->sniffhdr = 1;\r\nwlandev->netdev->type = ARPHRD_IEEE80211_PRISM;\r\n} else {\r\nwlandev->netdev->type = ARPHRD_IEEE80211;\r\n}\r\nmsg->resultcode.data = P80211ENUM_resultcode_success;\r\nreturn 0;\r\ndefault:\r\nmsg->resultcode.data = P80211ENUM_resultcode_invalid_parameters;\r\nreturn 0;\r\n}\r\nfailed:\r\nmsg->resultcode.data = P80211ENUM_resultcode_refused;\r\nreturn 0;\r\n}

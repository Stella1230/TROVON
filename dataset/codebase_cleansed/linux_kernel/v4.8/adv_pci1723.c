static int pci1723_ao_insn_write(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nint i;\r\nfor (i = 0; i < insn->n; i++) {\r\nunsigned int val = data[i];\r\noutw(val, dev->iobase + PCI1723_AO_REG(chan));\r\ns->readback[chan] = val;\r\n}\r\nreturn insn->n;\r\n}\r\nstatic int pci1723_dio_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nunsigned int mask = (chan < 8) ? 0x00ff : 0xff00;\r\nunsigned short mode = 0x0000;\r\nint ret;\r\nret = comedi_dio_insn_config(dev, s, insn, data, mask);\r\nif (ret)\r\nreturn ret;\r\nif (!(s->io_bits & 0x00ff))\r\nmode |= PCI1723_DIO_CTRL_LDIO;\r\nif (!(s->io_bits & 0xff00))\r\nmode |= PCI1723_DIO_CTRL_HDIO;\r\noutw(mode, dev->iobase + PCI1723_DIO_CTRL_REG);\r\nreturn insn->n;\r\n}\r\nstatic int pci1723_dio_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nif (comedi_dio_update_state(s, data))\r\noutw(s->state, dev->iobase + PCI1723_DIO_DATA_REG);\r\ndata[1] = inw(dev->iobase + PCI1723_DIO_DATA_REG);\r\nreturn insn->n;\r\n}\r\nstatic int pci1723_auto_attach(struct comedi_device *dev,\r\nunsigned long context_unused)\r\n{\r\nstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\r\nstruct comedi_subdevice *s;\r\nunsigned int val;\r\nint ret;\r\nint i;\r\nret = comedi_pci_enable(dev);\r\nif (ret)\r\nreturn ret;\r\ndev->iobase = pci_resource_start(pcidev, 2);\r\nret = comedi_alloc_subdevices(dev, 2);\r\nif (ret)\r\nreturn ret;\r\ns = &dev->subdevices[0];\r\ns->type = COMEDI_SUBD_AO;\r\ns->subdev_flags = SDF_WRITABLE | SDF_GROUND | SDF_COMMON;\r\ns->n_chan = 8;\r\ns->maxdata = 0xffff;\r\ns->range_table = &range_bipolar10;\r\ns->insn_write = pci1723_ao_insn_write;\r\nret = comedi_alloc_subdev_readback(s);\r\nif (ret)\r\nreturn ret;\r\noutw(PCI1723_SYNC_CTRL_SYNC, dev->iobase + PCI1723_SYNC_CTRL_REG);\r\nfor (i = 0; i < s->n_chan; i++) {\r\noutw(PCI1723_CTRL_RANGE(0) | PCI1723_CTRL_CHAN(i),\r\nPCI1723_CTRL_REG);\r\noutw(0, dev->iobase + PCI1723_RANGE_STROBE_REG);\r\noutw(0x8000, dev->iobase + PCI1723_AO_REG(i));\r\ns->readback[i] = 0x8000;\r\n}\r\noutw(0, dev->iobase + PCI1723_SYNC_STROBE_REG);\r\noutw(PCI1723_SYNC_CTRL_ASYNC, dev->iobase + PCI1723_SYNC_CTRL_REG);\r\ns = &dev->subdevices[1];\r\ns->type = COMEDI_SUBD_DIO;\r\ns->subdev_flags = SDF_READABLE | SDF_WRITABLE;\r\ns->n_chan = 16;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_config = pci1723_dio_insn_config;\r\ns->insn_bits = pci1723_dio_insn_bits;\r\nval = inw(dev->iobase + PCI1723_DIO_CTRL_REG);\r\nif (!(val & PCI1723_DIO_CTRL_LDIO))\r\ns->io_bits |= 0x00ff;\r\nif (!(val & PCI1723_DIO_CTRL_HDIO))\r\ns->io_bits |= 0xff00;\r\ns->state = inw(dev->iobase + PCI1723_DIO_DATA_REG);\r\nreturn 0;\r\n}\r\nstatic int adv_pci1723_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *id)\r\n{\r\nreturn comedi_pci_auto_config(dev, &adv_pci1723_driver,\r\nid->driver_data);\r\n}

u32 r128_get_vblank_counter(struct drm_device *dev, unsigned int pipe)\r\n{\r\nconst drm_r128_private_t *dev_priv = dev->dev_private;\r\nif (pipe != 0)\r\nreturn 0;\r\nreturn atomic_read(&dev_priv->vbl_received);\r\n}\r\nirqreturn_t r128_driver_irq_handler(int irq, void *arg)\r\n{\r\nstruct drm_device *dev = (struct drm_device *) arg;\r\ndrm_r128_private_t *dev_priv = (drm_r128_private_t *) dev->dev_private;\r\nint status;\r\nstatus = R128_READ(R128_GEN_INT_STATUS);\r\nif (status & R128_CRTC_VBLANK_INT) {\r\nR128_WRITE(R128_GEN_INT_STATUS, R128_CRTC_VBLANK_INT_AK);\r\natomic_inc(&dev_priv->vbl_received);\r\ndrm_handle_vblank(dev, 0);\r\nreturn IRQ_HANDLED;\r\n}\r\nreturn IRQ_NONE;\r\n}\r\nint r128_enable_vblank(struct drm_device *dev, unsigned int pipe)\r\n{\r\ndrm_r128_private_t *dev_priv = dev->dev_private;\r\nif (pipe != 0) {\r\nDRM_ERROR("%s: bad crtc %u\n", __func__, pipe);\r\nreturn -EINVAL;\r\n}\r\nR128_WRITE(R128_GEN_INT_CNTL, R128_CRTC_VBLANK_INT_EN);\r\nreturn 0;\r\n}\r\nvoid r128_disable_vblank(struct drm_device *dev, unsigned int pipe)\r\n{\r\nif (pipe != 0)\r\nDRM_ERROR("%s: bad crtc %u\n", __func__, pipe);\r\n}\r\nvoid r128_driver_irq_preinstall(struct drm_device *dev)\r\n{\r\ndrm_r128_private_t *dev_priv = (drm_r128_private_t *) dev->dev_private;\r\nR128_WRITE(R128_GEN_INT_CNTL, 0);\r\nR128_WRITE(R128_GEN_INT_STATUS, R128_CRTC_VBLANK_INT_AK);\r\n}\r\nint r128_driver_irq_postinstall(struct drm_device *dev)\r\n{\r\nreturn 0;\r\n}\r\nvoid r128_driver_irq_uninstall(struct drm_device *dev)\r\n{\r\ndrm_r128_private_t *dev_priv = (drm_r128_private_t *) dev->dev_private;\r\nif (!dev_priv)\r\nreturn;\r\nR128_WRITE(R128_GEN_INT_CNTL, 0);\r\n}

u32 acpi_tb_get_rsdp_length(struct acpi_table_rsdp *rsdp)\r\n{\r\nif (!ACPI_VALIDATE_RSDP_SIG(rsdp->signature)) {\r\nreturn (0);\r\n}\r\nif (rsdp->revision >= 2) {\r\nreturn (rsdp->length);\r\n} else {\r\nreturn (ACPI_RSDP_CHECKSUM_LENGTH);\r\n}\r\n}\r\nacpi_status acpi_tb_validate_rsdp(struct acpi_table_rsdp *rsdp)\r\n{\r\nif (!ACPI_VALIDATE_RSDP_SIG(rsdp->signature)) {\r\nreturn (AE_BAD_SIGNATURE);\r\n}\r\nif (acpi_tb_checksum((u8 *) rsdp, ACPI_RSDP_CHECKSUM_LENGTH) != 0) {\r\nreturn (AE_BAD_CHECKSUM);\r\n}\r\nif ((rsdp->revision >= 2) &&\r\n(acpi_tb_checksum((u8 *) rsdp, ACPI_RSDP_XCHECKSUM_LENGTH) != 0)) {\r\nreturn (AE_BAD_CHECKSUM);\r\n}\r\nreturn (AE_OK);\r\n}\r\nacpi_status __init acpi_find_root_pointer(acpi_physical_address *table_address)\r\n{\r\nu8 *table_ptr;\r\nu8 *mem_rover;\r\nu32 physical_address;\r\nACPI_FUNCTION_TRACE(acpi_find_root_pointer);\r\ntable_ptr = acpi_os_map_memory((acpi_physical_address)\r\nACPI_EBDA_PTR_LOCATION,\r\nACPI_EBDA_PTR_LENGTH);\r\nif (!table_ptr) {\r\nACPI_ERROR((AE_INFO,\r\n"Could not map memory at 0x%8.8X for length %u",\r\nACPI_EBDA_PTR_LOCATION, ACPI_EBDA_PTR_LENGTH));\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\nACPI_MOVE_16_TO_32(&physical_address, table_ptr);\r\nphysical_address <<= 4;\r\nacpi_os_unmap_memory(table_ptr, ACPI_EBDA_PTR_LENGTH);\r\nif (physical_address > 0x400) {\r\ntable_ptr = acpi_os_map_memory((acpi_physical_address)\r\nphysical_address,\r\nACPI_EBDA_WINDOW_SIZE);\r\nif (!table_ptr) {\r\nACPI_ERROR((AE_INFO,\r\n"Could not map memory at 0x%8.8X for length %u",\r\nphysical_address, ACPI_EBDA_WINDOW_SIZE));\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\nmem_rover =\r\nacpi_tb_scan_memory_for_rsdp(table_ptr,\r\nACPI_EBDA_WINDOW_SIZE);\r\nacpi_os_unmap_memory(table_ptr, ACPI_EBDA_WINDOW_SIZE);\r\nif (mem_rover) {\r\nphysical_address +=\r\n(u32) ACPI_PTR_DIFF(mem_rover, table_ptr);\r\n*table_address =\r\n(acpi_physical_address)physical_address;\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\n}\r\ntable_ptr = acpi_os_map_memory((acpi_physical_address)\r\nACPI_HI_RSDP_WINDOW_BASE,\r\nACPI_HI_RSDP_WINDOW_SIZE);\r\nif (!table_ptr) {\r\nACPI_ERROR((AE_INFO,\r\n"Could not map memory at 0x%8.8X for length %u",\r\nACPI_HI_RSDP_WINDOW_BASE,\r\nACPI_HI_RSDP_WINDOW_SIZE));\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\nmem_rover =\r\nacpi_tb_scan_memory_for_rsdp(table_ptr, ACPI_HI_RSDP_WINDOW_SIZE);\r\nacpi_os_unmap_memory(table_ptr, ACPI_HI_RSDP_WINDOW_SIZE);\r\nif (mem_rover) {\r\nphysical_address = (u32)\r\n(ACPI_HI_RSDP_WINDOW_BASE +\r\nACPI_PTR_DIFF(mem_rover, table_ptr));\r\n*table_address = (acpi_physical_address)physical_address;\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nACPI_BIOS_ERROR((AE_INFO, "A valid RSDP was not found"));\r\nreturn_ACPI_STATUS(AE_NOT_FOUND);\r\n}\r\nu8 *acpi_tb_scan_memory_for_rsdp(u8 *start_address, u32 length)\r\n{\r\nacpi_status status;\r\nu8 *mem_rover;\r\nu8 *end_address;\r\nACPI_FUNCTION_TRACE(tb_scan_memory_for_rsdp);\r\nend_address = start_address + length;\r\nfor (mem_rover = start_address; mem_rover < end_address;\r\nmem_rover += ACPI_RSDP_SCAN_STEP) {\r\nstatus =\r\nacpi_tb_validate_rsdp(ACPI_CAST_PTR\r\n(struct acpi_table_rsdp, mem_rover));\r\nif (ACPI_SUCCESS(status)) {\r\nACPI_DEBUG_PRINT((ACPI_DB_INFO,\r\n"RSDP located at physical address %p\n",\r\nmem_rover));\r\nreturn_PTR(mem_rover);\r\n}\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_INFO,\r\n"Searched entire block from %p, valid RSDP was not found\n",\r\nstart_address));\r\nreturn_PTR(NULL);\r\n}

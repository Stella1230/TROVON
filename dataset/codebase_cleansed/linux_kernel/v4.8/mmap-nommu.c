static unsigned long romfs_get_unmapped_area(struct file *file,\r\nunsigned long addr,\r\nunsigned long len,\r\nunsigned long pgoff,\r\nunsigned long flags)\r\n{\r\nstruct inode *inode = file->f_mapping->host;\r\nstruct mtd_info *mtd = inode->i_sb->s_mtd;\r\nunsigned long isize, offset, maxpages, lpages;\r\nint ret;\r\nif (!mtd)\r\nreturn (unsigned long) -ENOSYS;\r\nlpages = (len + PAGE_SIZE - 1) >> PAGE_SHIFT;\r\nisize = i_size_read(inode);\r\noffset = pgoff << PAGE_SHIFT;\r\nmaxpages = (isize + PAGE_SIZE - 1) >> PAGE_SHIFT;\r\nif ((pgoff >= maxpages) || (maxpages - pgoff < lpages))\r\nreturn (unsigned long) -EINVAL;\r\nif (addr != 0)\r\nreturn (unsigned long) -EINVAL;\r\nif (len > mtd->size || pgoff >= (mtd->size >> PAGE_SHIFT))\r\nreturn (unsigned long) -EINVAL;\r\noffset += ROMFS_I(inode)->i_dataoffset;\r\nif (offset >= mtd->size)\r\nreturn (unsigned long) -EINVAL;\r\nif ((offset + len) > mtd->size)\r\nlen = mtd->size - offset;\r\nret = mtd_get_unmapped_area(mtd, len, offset, flags);\r\nif (ret == -EOPNOTSUPP)\r\nret = -ENOSYS;\r\nreturn (unsigned long) ret;\r\n}\r\nstatic int romfs_mmap(struct file *file, struct vm_area_struct *vma)\r\n{\r\nreturn vma->vm_flags & (VM_SHARED | VM_MAYSHARE) ? 0 : -ENOSYS;\r\n}\r\nstatic unsigned romfs_mmap_capabilities(struct file *file)\r\n{\r\nstruct mtd_info *mtd = file_inode(file)->i_sb->s_mtd;\r\nif (!mtd)\r\nreturn NOMMU_MAP_COPY;\r\nreturn mtd_mmap_capabilities(mtd);\r\n}

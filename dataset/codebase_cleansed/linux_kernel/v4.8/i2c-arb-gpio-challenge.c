static int i2c_arbitrator_select(struct i2c_mux_core *muxc, u32 chan)\r\n{\r\nconst struct i2c_arbitrator_data *arb = i2c_mux_priv(muxc);\r\nunsigned long stop_retry, stop_time;\r\nstop_time = jiffies + usecs_to_jiffies(arb->wait_free_us) + 1;\r\ndo {\r\ngpio_set_value(arb->our_gpio, !arb->our_gpio_release);\r\nudelay(arb->slew_delay_us);\r\nstop_retry = jiffies + usecs_to_jiffies(arb->wait_retry_us) + 1;\r\nwhile (time_before(jiffies, stop_retry)) {\r\nint gpio_val = !!gpio_get_value(arb->their_gpio);\r\nif (gpio_val == arb->their_gpio_release) {\r\nreturn 0;\r\n}\r\nusleep_range(50, 200);\r\n}\r\ngpio_set_value(arb->our_gpio, arb->our_gpio_release);\r\nusleep_range(arb->wait_retry_us, arb->wait_retry_us * 2);\r\n} while (time_before(jiffies, stop_time));\r\ngpio_set_value(arb->our_gpio, arb->our_gpio_release);\r\nudelay(arb->slew_delay_us);\r\ndev_err(muxc->dev, "Could not claim bus, timeout\n");\r\nreturn -EBUSY;\r\n}\r\nstatic int i2c_arbitrator_deselect(struct i2c_mux_core *muxc, u32 chan)\r\n{\r\nconst struct i2c_arbitrator_data *arb = i2c_mux_priv(muxc);\r\ngpio_set_value(arb->our_gpio, arb->our_gpio_release);\r\nudelay(arb->slew_delay_us);\r\nreturn 0;\r\n}\r\nstatic int i2c_arbitrator_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *np = dev->of_node;\r\nstruct device_node *parent_np;\r\nstruct i2c_mux_core *muxc;\r\nstruct i2c_arbitrator_data *arb;\r\nenum of_gpio_flags gpio_flags;\r\nunsigned long out_init;\r\nint ret;\r\nif (!np) {\r\ndev_err(dev, "Cannot find device tree node\n");\r\nreturn -ENODEV;\r\n}\r\nif (dev_get_platdata(dev)) {\r\ndev_err(dev, "Platform data is not supported\n");\r\nreturn -EINVAL;\r\n}\r\nmuxc = i2c_mux_alloc(NULL, dev, 1, sizeof(*arb), 0,\r\ni2c_arbitrator_select, i2c_arbitrator_deselect);\r\nif (!muxc)\r\nreturn -ENOMEM;\r\narb = i2c_mux_priv(muxc);\r\nplatform_set_drvdata(pdev, muxc);\r\nret = of_get_named_gpio_flags(np, "our-claim-gpio", 0, &gpio_flags);\r\nif (!gpio_is_valid(ret)) {\r\nif (ret != -EPROBE_DEFER)\r\ndev_err(dev, "Error getting our-claim-gpio\n");\r\nreturn ret;\r\n}\r\narb->our_gpio = ret;\r\narb->our_gpio_release = !!(gpio_flags & OF_GPIO_ACTIVE_LOW);\r\nout_init = (gpio_flags & OF_GPIO_ACTIVE_LOW) ?\r\nGPIOF_OUT_INIT_HIGH : GPIOF_OUT_INIT_LOW;\r\nret = devm_gpio_request_one(dev, arb->our_gpio, out_init,\r\n"our-claim-gpio");\r\nif (ret) {\r\nif (ret != -EPROBE_DEFER)\r\ndev_err(dev, "Error requesting our-claim-gpio\n");\r\nreturn ret;\r\n}\r\nret = of_get_named_gpio_flags(np, "their-claim-gpios", 0, &gpio_flags);\r\nif (!gpio_is_valid(ret)) {\r\nif (ret != -EPROBE_DEFER)\r\ndev_err(dev, "Error getting their-claim-gpio\n");\r\nreturn ret;\r\n}\r\narb->their_gpio = ret;\r\narb->their_gpio_release = !!(gpio_flags & OF_GPIO_ACTIVE_LOW);\r\nret = devm_gpio_request_one(dev, arb->their_gpio, GPIOF_IN,\r\n"their-claim-gpio");\r\nif (ret) {\r\nif (ret != -EPROBE_DEFER)\r\ndev_err(dev, "Error requesting their-claim-gpio\n");\r\nreturn ret;\r\n}\r\nif (gpio_is_valid(of_get_named_gpio(np, "their-claim-gpios", 1))) {\r\ndev_err(dev, "Only one other master is supported\n");\r\nreturn -EINVAL;\r\n}\r\nif (of_property_read_u32(np, "slew-delay-us", &arb->slew_delay_us))\r\narb->slew_delay_us = 10;\r\nif (of_property_read_u32(np, "wait-retry-us", &arb->wait_retry_us))\r\narb->wait_retry_us = 3000;\r\nif (of_property_read_u32(np, "wait-free-us", &arb->wait_free_us))\r\narb->wait_free_us = 50000;\r\nparent_np = of_parse_phandle(np, "i2c-parent", 0);\r\nif (!parent_np) {\r\ndev_err(dev, "Cannot parse i2c-parent\n");\r\nreturn -EINVAL;\r\n}\r\nmuxc->parent = of_get_i2c_adapter_by_node(parent_np);\r\nof_node_put(parent_np);\r\nif (!muxc->parent) {\r\ndev_err(dev, "Cannot find parent bus\n");\r\nreturn -EPROBE_DEFER;\r\n}\r\nret = i2c_mux_add_adapter(muxc, 0, 0, 0);\r\nif (ret) {\r\ndev_err(dev, "Failed to add adapter\n");\r\ni2c_put_adapter(muxc->parent);\r\n}\r\nreturn ret;\r\n}\r\nstatic int i2c_arbitrator_remove(struct platform_device *pdev)\r\n{\r\nstruct i2c_mux_core *muxc = platform_get_drvdata(pdev);\r\ni2c_mux_del_adapters(muxc);\r\ni2c_put_adapter(muxc->parent);\r\nreturn 0;\r\n}

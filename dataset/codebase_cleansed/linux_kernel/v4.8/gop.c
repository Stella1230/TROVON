static void find_bits(unsigned long mask, u8 *pos, u8 *size)\r\n{\r\nu8 first, len;\r\nfirst = 0;\r\nlen = 0;\r\nif (mask) {\r\nwhile (!(mask & 0x1)) {\r\nmask = mask >> 1;\r\nfirst++;\r\n}\r\nwhile (mask & 0x1) {\r\nmask = mask >> 1;\r\nlen++;\r\n}\r\n}\r\n*pos = first;\r\n*size = len;\r\n}\r\nstatic void\r\nsetup_pixel_info(struct screen_info *si, u32 pixels_per_scan_line,\r\nstruct efi_pixel_bitmask pixel_info, int pixel_format)\r\n{\r\nif (pixel_format == PIXEL_RGB_RESERVED_8BIT_PER_COLOR) {\r\nsi->lfb_depth = 32;\r\nsi->lfb_linelength = pixels_per_scan_line * 4;\r\nsi->red_size = 8;\r\nsi->red_pos = 0;\r\nsi->green_size = 8;\r\nsi->green_pos = 8;\r\nsi->blue_size = 8;\r\nsi->blue_pos = 16;\r\nsi->rsvd_size = 8;\r\nsi->rsvd_pos = 24;\r\n} else if (pixel_format == PIXEL_BGR_RESERVED_8BIT_PER_COLOR) {\r\nsi->lfb_depth = 32;\r\nsi->lfb_linelength = pixels_per_scan_line * 4;\r\nsi->red_size = 8;\r\nsi->red_pos = 16;\r\nsi->green_size = 8;\r\nsi->green_pos = 8;\r\nsi->blue_size = 8;\r\nsi->blue_pos = 0;\r\nsi->rsvd_size = 8;\r\nsi->rsvd_pos = 24;\r\n} else if (pixel_format == PIXEL_BIT_MASK) {\r\nfind_bits(pixel_info.red_mask, &si->red_pos, &si->red_size);\r\nfind_bits(pixel_info.green_mask, &si->green_pos,\r\n&si->green_size);\r\nfind_bits(pixel_info.blue_mask, &si->blue_pos, &si->blue_size);\r\nfind_bits(pixel_info.reserved_mask, &si->rsvd_pos,\r\n&si->rsvd_size);\r\nsi->lfb_depth = si->red_size + si->green_size +\r\nsi->blue_size + si->rsvd_size;\r\nsi->lfb_linelength = (pixels_per_scan_line * si->lfb_depth) / 8;\r\n} else {\r\nsi->lfb_depth = 4;\r\nsi->lfb_linelength = si->lfb_width / 2;\r\nsi->red_size = 0;\r\nsi->red_pos = 0;\r\nsi->green_size = 0;\r\nsi->green_pos = 0;\r\nsi->blue_size = 0;\r\nsi->blue_pos = 0;\r\nsi->rsvd_size = 0;\r\nsi->rsvd_pos = 0;\r\n}\r\n}\r\nstatic efi_status_t\r\n__gop_query32(efi_system_table_t *sys_table_arg,\r\nstruct efi_graphics_output_protocol_32 *gop32,\r\nstruct efi_graphics_output_mode_info **info,\r\nunsigned long *size, u64 *fb_base)\r\n{\r\nstruct efi_graphics_output_protocol_mode_32 *mode;\r\nefi_graphics_output_protocol_query_mode query_mode;\r\nefi_status_t status;\r\nunsigned long m;\r\nm = gop32->mode;\r\nmode = (struct efi_graphics_output_protocol_mode_32 *)m;\r\nquery_mode = (void *)(unsigned long)gop32->query_mode;\r\nstatus = __efi_call_early(query_mode, (void *)gop32, mode->mode, size,\r\ninfo);\r\nif (status != EFI_SUCCESS)\r\nreturn status;\r\n*fb_base = mode->frame_buffer_base;\r\nreturn status;\r\n}\r\nstatic efi_status_t\r\nsetup_gop32(efi_system_table_t *sys_table_arg, struct screen_info *si,\r\nefi_guid_t *proto, unsigned long size, void **gop_handle)\r\n{\r\nstruct efi_graphics_output_protocol_32 *gop32, *first_gop;\r\nunsigned long nr_gops;\r\nu16 width, height;\r\nu32 pixels_per_scan_line;\r\nu32 ext_lfb_base;\r\nu64 fb_base;\r\nstruct efi_pixel_bitmask pixel_info;\r\nint pixel_format;\r\nefi_status_t status = EFI_NOT_FOUND;\r\nu32 *handles = (u32 *)(unsigned long)gop_handle;\r\nint i;\r\nfirst_gop = NULL;\r\ngop32 = NULL;\r\nnr_gops = size / sizeof(u32);\r\nfor (i = 0; i < nr_gops; i++) {\r\nstruct efi_graphics_output_mode_info *info = NULL;\r\nefi_guid_t conout_proto = EFI_CONSOLE_OUT_DEVICE_GUID;\r\nbool conout_found = false;\r\nvoid *dummy = NULL;\r\nefi_handle_t h = (efi_handle_t)(unsigned long)handles[i];\r\nu64 current_fb_base;\r\nstatus = efi_call_early(handle_protocol, h,\r\nproto, (void **)&gop32);\r\nif (status != EFI_SUCCESS)\r\ncontinue;\r\nstatus = efi_call_early(handle_protocol, h,\r\n&conout_proto, &dummy);\r\nif (status == EFI_SUCCESS)\r\nconout_found = true;\r\nstatus = __gop_query32(sys_table_arg, gop32, &info, &size,\r\n&current_fb_base);\r\nif (status == EFI_SUCCESS && (!first_gop || conout_found)) {\r\nwidth = info->horizontal_resolution;\r\nheight = info->vertical_resolution;\r\npixel_format = info->pixel_format;\r\npixel_info = info->pixel_information;\r\npixels_per_scan_line = info->pixels_per_scan_line;\r\nfb_base = current_fb_base;\r\nfirst_gop = gop32;\r\nif (conout_found)\r\nbreak;\r\n}\r\n}\r\nif (!first_gop)\r\ngoto out;\r\nsi->orig_video_isVGA = VIDEO_TYPE_EFI;\r\nsi->lfb_width = width;\r\nsi->lfb_height = height;\r\nsi->lfb_base = fb_base;\r\next_lfb_base = (u64)(unsigned long)fb_base >> 32;\r\nif (ext_lfb_base) {\r\nsi->capabilities |= VIDEO_CAPABILITY_64BIT_BASE;\r\nsi->ext_lfb_base = ext_lfb_base;\r\n}\r\nsi->pages = 1;\r\nsetup_pixel_info(si, pixels_per_scan_line, pixel_info, pixel_format);\r\nsi->lfb_size = si->lfb_linelength * si->lfb_height;\r\nsi->capabilities |= VIDEO_CAPABILITY_SKIP_QUIRKS;\r\nout:\r\nreturn status;\r\n}\r\nstatic efi_status_t\r\n__gop_query64(efi_system_table_t *sys_table_arg,\r\nstruct efi_graphics_output_protocol_64 *gop64,\r\nstruct efi_graphics_output_mode_info **info,\r\nunsigned long *size, u64 *fb_base)\r\n{\r\nstruct efi_graphics_output_protocol_mode_64 *mode;\r\nefi_graphics_output_protocol_query_mode query_mode;\r\nefi_status_t status;\r\nunsigned long m;\r\nm = gop64->mode;\r\nmode = (struct efi_graphics_output_protocol_mode_64 *)m;\r\nquery_mode = (void *)(unsigned long)gop64->query_mode;\r\nstatus = __efi_call_early(query_mode, (void *)gop64, mode->mode, size,\r\ninfo);\r\nif (status != EFI_SUCCESS)\r\nreturn status;\r\n*fb_base = mode->frame_buffer_base;\r\nreturn status;\r\n}\r\nstatic efi_status_t\r\nsetup_gop64(efi_system_table_t *sys_table_arg, struct screen_info *si,\r\nefi_guid_t *proto, unsigned long size, void **gop_handle)\r\n{\r\nstruct efi_graphics_output_protocol_64 *gop64, *first_gop;\r\nunsigned long nr_gops;\r\nu16 width, height;\r\nu32 pixels_per_scan_line;\r\nu32 ext_lfb_base;\r\nu64 fb_base;\r\nstruct efi_pixel_bitmask pixel_info;\r\nint pixel_format;\r\nefi_status_t status = EFI_NOT_FOUND;\r\nu64 *handles = (u64 *)(unsigned long)gop_handle;\r\nint i;\r\nfirst_gop = NULL;\r\ngop64 = NULL;\r\nnr_gops = size / sizeof(u64);\r\nfor (i = 0; i < nr_gops; i++) {\r\nstruct efi_graphics_output_mode_info *info = NULL;\r\nefi_guid_t conout_proto = EFI_CONSOLE_OUT_DEVICE_GUID;\r\nbool conout_found = false;\r\nvoid *dummy = NULL;\r\nefi_handle_t h = (efi_handle_t)(unsigned long)handles[i];\r\nu64 current_fb_base;\r\nstatus = efi_call_early(handle_protocol, h,\r\nproto, (void **)&gop64);\r\nif (status != EFI_SUCCESS)\r\ncontinue;\r\nstatus = efi_call_early(handle_protocol, h,\r\n&conout_proto, &dummy);\r\nif (status == EFI_SUCCESS)\r\nconout_found = true;\r\nstatus = __gop_query64(sys_table_arg, gop64, &info, &size,\r\n&current_fb_base);\r\nif (status == EFI_SUCCESS && (!first_gop || conout_found)) {\r\nwidth = info->horizontal_resolution;\r\nheight = info->vertical_resolution;\r\npixel_format = info->pixel_format;\r\npixel_info = info->pixel_information;\r\npixels_per_scan_line = info->pixels_per_scan_line;\r\nfb_base = current_fb_base;\r\nfirst_gop = gop64;\r\nif (conout_found)\r\nbreak;\r\n}\r\n}\r\nif (!first_gop)\r\ngoto out;\r\nsi->orig_video_isVGA = VIDEO_TYPE_EFI;\r\nsi->lfb_width = width;\r\nsi->lfb_height = height;\r\nsi->lfb_base = fb_base;\r\next_lfb_base = (u64)(unsigned long)fb_base >> 32;\r\nif (ext_lfb_base) {\r\nsi->capabilities |= VIDEO_CAPABILITY_64BIT_BASE;\r\nsi->ext_lfb_base = ext_lfb_base;\r\n}\r\nsi->pages = 1;\r\nsetup_pixel_info(si, pixels_per_scan_line, pixel_info, pixel_format);\r\nsi->lfb_size = si->lfb_linelength * si->lfb_height;\r\nsi->capabilities |= VIDEO_CAPABILITY_SKIP_QUIRKS;\r\nout:\r\nreturn status;\r\n}\r\nefi_status_t efi_setup_gop(efi_system_table_t *sys_table_arg,\r\nstruct screen_info *si, efi_guid_t *proto,\r\nunsigned long size)\r\n{\r\nefi_status_t status;\r\nvoid **gop_handle = NULL;\r\nstatus = efi_call_early(allocate_pool, EFI_LOADER_DATA,\r\nsize, (void **)&gop_handle);\r\nif (status != EFI_SUCCESS)\r\nreturn status;\r\nstatus = efi_call_early(locate_handle,\r\nEFI_LOCATE_BY_PROTOCOL,\r\nproto, NULL, &size, gop_handle);\r\nif (status != EFI_SUCCESS)\r\ngoto free_handle;\r\nif (efi_is_64bit()) {\r\nstatus = setup_gop64(sys_table_arg, si, proto, size,\r\ngop_handle);\r\n} else {\r\nstatus = setup_gop32(sys_table_arg, si, proto, size,\r\ngop_handle);\r\n}\r\nfree_handle:\r\nefi_call_early(free_pool, gop_handle);\r\nreturn status;\r\n}

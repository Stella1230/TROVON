static inline void rt_wdt_w32(unsigned reg, u32 val)\r\n{\r\niowrite32(val, rt288x_wdt_base + reg);\r\n}\r\nstatic inline u32 rt_wdt_r32(unsigned reg)\r\n{\r\nreturn ioread32(rt288x_wdt_base + reg);\r\n}\r\nstatic int rt288x_wdt_ping(struct watchdog_device *w)\r\n{\r\nrt_wdt_w32(TIMER_REG_TMR1LOAD, w->timeout * rt288x_wdt_freq);\r\nreturn 0;\r\n}\r\nstatic int rt288x_wdt_start(struct watchdog_device *w)\r\n{\r\nu32 t;\r\nt = rt_wdt_r32(TIMER_REG_TMR1CTL);\r\nt &= ~(TMR1CTL_MODE_MASK << TMR1CTL_MODE_SHIFT |\r\nTMR1CTL_PRESCALE_MASK);\r\nt |= (TMR1CTL_MODE_WDT << TMR1CTL_MODE_SHIFT |\r\nTMR1CTL_PRESCALE_65536);\r\nrt_wdt_w32(TIMER_REG_TMR1CTL, t);\r\nrt288x_wdt_ping(w);\r\nt = rt_wdt_r32(TIMER_REG_TMR1CTL);\r\nt |= TMR1CTL_ENABLE;\r\nrt_wdt_w32(TIMER_REG_TMR1CTL, t);\r\nreturn 0;\r\n}\r\nstatic int rt288x_wdt_stop(struct watchdog_device *w)\r\n{\r\nu32 t;\r\nrt288x_wdt_ping(w);\r\nt = rt_wdt_r32(TIMER_REG_TMR1CTL);\r\nt &= ~TMR1CTL_ENABLE;\r\nrt_wdt_w32(TIMER_REG_TMR1CTL, t);\r\nreturn 0;\r\n}\r\nstatic int rt288x_wdt_set_timeout(struct watchdog_device *w, unsigned int t)\r\n{\r\nw->timeout = t;\r\nrt288x_wdt_ping(w);\r\nreturn 0;\r\n}\r\nstatic int rt288x_wdt_bootcause(void)\r\n{\r\nif (rt_sysc_r32(SYSC_RSTSTAT) & WDT_RST_CAUSE)\r\nreturn WDIOF_CARDRESET;\r\nreturn 0;\r\n}\r\nstatic int rt288x_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nint ret;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nrt288x_wdt_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(rt288x_wdt_base))\r\nreturn PTR_ERR(rt288x_wdt_base);\r\nrt288x_wdt_clk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(rt288x_wdt_clk))\r\nreturn PTR_ERR(rt288x_wdt_clk);\r\nrt288x_wdt_reset = devm_reset_control_get(&pdev->dev, NULL);\r\nif (!IS_ERR(rt288x_wdt_reset))\r\nreset_control_deassert(rt288x_wdt_reset);\r\nrt288x_wdt_freq = clk_get_rate(rt288x_wdt_clk) / RALINK_WDT_PRESCALE;\r\nrt288x_wdt_dev.dev = &pdev->dev;\r\nrt288x_wdt_dev.bootstatus = rt288x_wdt_bootcause();\r\nrt288x_wdt_dev.max_timeout = (0xfffful / rt288x_wdt_freq);\r\nrt288x_wdt_dev.parent = &pdev->dev;\r\nwatchdog_init_timeout(&rt288x_wdt_dev, rt288x_wdt_dev.max_timeout,\r\n&pdev->dev);\r\nwatchdog_set_nowayout(&rt288x_wdt_dev, nowayout);\r\nret = watchdog_register_device(&rt288x_wdt_dev);\r\nif (!ret)\r\ndev_info(&pdev->dev, "Initialized\n");\r\nreturn 0;\r\n}\r\nstatic int rt288x_wdt_remove(struct platform_device *pdev)\r\n{\r\nwatchdog_unregister_device(&rt288x_wdt_dev);\r\nreturn 0;\r\n}\r\nstatic void rt288x_wdt_shutdown(struct platform_device *pdev)\r\n{\r\nrt288x_wdt_stop(&rt288x_wdt_dev);\r\n}

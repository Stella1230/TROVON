static s32 ixgbevf_poll_for_msg(struct ixgbe_hw *hw)\r\n{\r\nstruct ixgbe_mbx_info *mbx = &hw->mbx;\r\nint countdown = mbx->timeout;\r\nwhile (countdown && mbx->ops.check_for_msg(hw)) {\r\ncountdown--;\r\nudelay(mbx->udelay);\r\n}\r\nif (!countdown)\r\nmbx->timeout = 0;\r\nreturn countdown ? 0 : IXGBE_ERR_MBX;\r\n}\r\nstatic s32 ixgbevf_poll_for_ack(struct ixgbe_hw *hw)\r\n{\r\nstruct ixgbe_mbx_info *mbx = &hw->mbx;\r\nint countdown = mbx->timeout;\r\nwhile (countdown && mbx->ops.check_for_ack(hw)) {\r\ncountdown--;\r\nudelay(mbx->udelay);\r\n}\r\nif (!countdown)\r\nmbx->timeout = 0;\r\nreturn countdown ? 0 : IXGBE_ERR_MBX;\r\n}\r\nstatic s32 ixgbevf_read_posted_mbx(struct ixgbe_hw *hw, u32 *msg, u16 size)\r\n{\r\nstruct ixgbe_mbx_info *mbx = &hw->mbx;\r\ns32 ret_val = IXGBE_ERR_MBX;\r\nif (!mbx->ops.read)\r\ngoto out;\r\nret_val = ixgbevf_poll_for_msg(hw);\r\nif (!ret_val)\r\nret_val = mbx->ops.read(hw, msg, size);\r\nout:\r\nreturn ret_val;\r\n}\r\nstatic s32 ixgbevf_write_posted_mbx(struct ixgbe_hw *hw, u32 *msg, u16 size)\r\n{\r\nstruct ixgbe_mbx_info *mbx = &hw->mbx;\r\ns32 ret_val = IXGBE_ERR_MBX;\r\nif (!mbx->ops.write || !mbx->timeout)\r\ngoto out;\r\nret_val = mbx->ops.write(hw, msg, size);\r\nif (!ret_val)\r\nret_val = ixgbevf_poll_for_ack(hw);\r\nout:\r\nreturn ret_val;\r\n}\r\nstatic u32 ixgbevf_read_v2p_mailbox(struct ixgbe_hw *hw)\r\n{\r\nu32 v2p_mailbox = IXGBE_READ_REG(hw, IXGBE_VFMAILBOX);\r\nv2p_mailbox |= hw->mbx.v2p_mailbox;\r\nhw->mbx.v2p_mailbox |= v2p_mailbox & IXGBE_VFMAILBOX_R2C_BITS;\r\nreturn v2p_mailbox;\r\n}\r\nstatic s32 ixgbevf_check_for_bit_vf(struct ixgbe_hw *hw, u32 mask)\r\n{\r\nu32 v2p_mailbox = ixgbevf_read_v2p_mailbox(hw);\r\ns32 ret_val = IXGBE_ERR_MBX;\r\nif (v2p_mailbox & mask)\r\nret_val = 0;\r\nhw->mbx.v2p_mailbox &= ~mask;\r\nreturn ret_val;\r\n}\r\nstatic s32 ixgbevf_check_for_msg_vf(struct ixgbe_hw *hw)\r\n{\r\ns32 ret_val = IXGBE_ERR_MBX;\r\nif (!ixgbevf_check_for_bit_vf(hw, IXGBE_VFMAILBOX_PFSTS)) {\r\nret_val = 0;\r\nhw->mbx.stats.reqs++;\r\n}\r\nreturn ret_val;\r\n}\r\nstatic s32 ixgbevf_check_for_ack_vf(struct ixgbe_hw *hw)\r\n{\r\ns32 ret_val = IXGBE_ERR_MBX;\r\nif (!ixgbevf_check_for_bit_vf(hw, IXGBE_VFMAILBOX_PFACK)) {\r\nret_val = 0;\r\nhw->mbx.stats.acks++;\r\n}\r\nreturn ret_val;\r\n}\r\nstatic s32 ixgbevf_check_for_rst_vf(struct ixgbe_hw *hw)\r\n{\r\ns32 ret_val = IXGBE_ERR_MBX;\r\nif (!ixgbevf_check_for_bit_vf(hw, (IXGBE_VFMAILBOX_RSTD |\r\nIXGBE_VFMAILBOX_RSTI))) {\r\nret_val = 0;\r\nhw->mbx.stats.rsts++;\r\n}\r\nreturn ret_val;\r\n}\r\nstatic s32 ixgbevf_obtain_mbx_lock_vf(struct ixgbe_hw *hw)\r\n{\r\ns32 ret_val = IXGBE_ERR_MBX;\r\nIXGBE_WRITE_REG(hw, IXGBE_VFMAILBOX, IXGBE_VFMAILBOX_VFU);\r\nif (ixgbevf_read_v2p_mailbox(hw) & IXGBE_VFMAILBOX_VFU)\r\nret_val = 0;\r\nreturn ret_val;\r\n}\r\nstatic s32 ixgbevf_write_mbx_vf(struct ixgbe_hw *hw, u32 *msg, u16 size)\r\n{\r\ns32 ret_val;\r\nu16 i;\r\nret_val = ixgbevf_obtain_mbx_lock_vf(hw);\r\nif (ret_val)\r\ngoto out_no_write;\r\nixgbevf_check_for_msg_vf(hw);\r\nixgbevf_check_for_ack_vf(hw);\r\nfor (i = 0; i < size; i++)\r\nIXGBE_WRITE_REG_ARRAY(hw, IXGBE_VFMBMEM, i, msg[i]);\r\nhw->mbx.stats.msgs_tx++;\r\nIXGBE_WRITE_REG(hw, IXGBE_VFMAILBOX, IXGBE_VFMAILBOX_REQ);\r\nout_no_write:\r\nreturn ret_val;\r\n}\r\nstatic s32 ixgbevf_read_mbx_vf(struct ixgbe_hw *hw, u32 *msg, u16 size)\r\n{\r\ns32 ret_val = 0;\r\nu16 i;\r\nret_val = ixgbevf_obtain_mbx_lock_vf(hw);\r\nif (ret_val)\r\ngoto out_no_read;\r\nfor (i = 0; i < size; i++)\r\nmsg[i] = IXGBE_READ_REG_ARRAY(hw, IXGBE_VFMBMEM, i);\r\nIXGBE_WRITE_REG(hw, IXGBE_VFMAILBOX, IXGBE_VFMAILBOX_ACK);\r\nhw->mbx.stats.msgs_rx++;\r\nout_no_read:\r\nreturn ret_val;\r\n}\r\nstatic s32 ixgbevf_init_mbx_params_vf(struct ixgbe_hw *hw)\r\n{\r\nstruct ixgbe_mbx_info *mbx = &hw->mbx;\r\nmbx->timeout = 0;\r\nmbx->udelay = IXGBE_VF_MBX_INIT_DELAY;\r\nmbx->size = IXGBE_VFMAILBOX_SIZE;\r\nmbx->stats.msgs_tx = 0;\r\nmbx->stats.msgs_rx = 0;\r\nmbx->stats.reqs = 0;\r\nmbx->stats.acks = 0;\r\nmbx->stats.rsts = 0;\r\nreturn 0;\r\n}

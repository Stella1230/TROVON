static void ca0106_spdif_enable(struct snd_ca0106 *emu)\r\n{\r\nunsigned int val;\r\nif (emu->spdif_enable) {\r\nsnd_ca0106_ptr_write(emu, SPDIF_SELECT1, 0, 0xf);\r\nsnd_ca0106_ptr_write(emu, SPDIF_SELECT2, 0, 0x0b000000);\r\nval = snd_ca0106_ptr_read(emu, CAPTURE_CONTROL, 0) & ~0x1000;\r\nsnd_ca0106_ptr_write(emu, CAPTURE_CONTROL, 0, val);\r\nval = inl(emu->port + GPIO) & ~0x101;\r\noutl(val, emu->port + GPIO);\r\n} else {\r\nsnd_ca0106_ptr_write(emu, SPDIF_SELECT1, 0, 0xf);\r\nsnd_ca0106_ptr_write(emu, SPDIF_SELECT2, 0, 0x000f0000);\r\nval = snd_ca0106_ptr_read(emu, CAPTURE_CONTROL, 0) | 0x1000;\r\nsnd_ca0106_ptr_write(emu, CAPTURE_CONTROL, 0, val);\r\nval = inl(emu->port + GPIO) | 0x101;\r\noutl(val, emu->port + GPIO);\r\n}\r\n}\r\nstatic void ca0106_set_capture_source(struct snd_ca0106 *emu)\r\n{\r\nunsigned int val = emu->capture_source;\r\nunsigned int source, mask;\r\nsource = (val << 28) | (val << 24) | (val << 20) | (val << 16);\r\nmask = snd_ca0106_ptr_read(emu, CAPTURE_SOURCE, 0) & 0xffff;\r\nsnd_ca0106_ptr_write(emu, CAPTURE_SOURCE, 0, source | mask);\r\n}\r\nstatic void ca0106_set_i2c_capture_source(struct snd_ca0106 *emu,\r\nunsigned int val, int force)\r\n{\r\nunsigned int ngain, ogain;\r\nu32 source;\r\nsnd_ca0106_i2c_write(emu, ADC_MUX, 0);\r\nngain = emu->i2c_capture_volume[val][0];\r\nogain = emu->i2c_capture_volume[emu->i2c_capture_source][0];\r\nif (force || ngain != ogain)\r\nsnd_ca0106_i2c_write(emu, ADC_ATTEN_ADCL, ngain & 0xff);\r\nngain = emu->i2c_capture_volume[val][1];\r\nogain = emu->i2c_capture_volume[emu->i2c_capture_source][1];\r\nif (force || ngain != ogain)\r\nsnd_ca0106_i2c_write(emu, ADC_ATTEN_ADCR, ngain & 0xff);\r\nsource = 1 << val;\r\nsnd_ca0106_i2c_write(emu, ADC_MUX, source);\r\nemu->i2c_capture_source = val;\r\n}\r\nstatic void ca0106_set_capture_mic_line_in(struct snd_ca0106 *emu)\r\n{\r\nu32 tmp;\r\nif (emu->capture_mic_line_in) {\r\ntmp = inl(emu->port+GPIO) & ~0x400;\r\ntmp = tmp | 0x400;\r\noutl(tmp, emu->port+GPIO);\r\n} else {\r\ntmp = inl(emu->port+GPIO) & ~0x400;\r\noutl(tmp, emu->port+GPIO);\r\n}\r\n}\r\nstatic void ca0106_set_spdif_bits(struct snd_ca0106 *emu, int idx)\r\n{\r\nsnd_ca0106_ptr_write(emu, SPCS0 + idx, 0, emu->spdif_str_bits[idx]);\r\n}\r\nstatic int snd_ca0106_shared_spdif_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ca0106 *emu = snd_kcontrol_chip(kcontrol);\r\nucontrol->value.integer.value[0] = emu->spdif_enable;\r\nreturn 0;\r\n}\r\nstatic int snd_ca0106_shared_spdif_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ca0106 *emu = snd_kcontrol_chip(kcontrol);\r\nunsigned int val;\r\nint change = 0;\r\nval = !!ucontrol->value.integer.value[0];\r\nchange = (emu->spdif_enable != val);\r\nif (change) {\r\nemu->spdif_enable = val;\r\nca0106_spdif_enable(emu);\r\n}\r\nreturn change;\r\n}\r\nstatic int snd_ca0106_capture_source_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nstatic const char * const texts[6] = {\r\n"IEC958 out", "i2s mixer out", "IEC958 in", "i2s in", "AC97 in", "SRC out"\r\n};\r\nreturn snd_ctl_enum_info(uinfo, 1, 6, texts);\r\n}\r\nstatic int snd_ca0106_capture_source_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ca0106 *emu = snd_kcontrol_chip(kcontrol);\r\nucontrol->value.enumerated.item[0] = emu->capture_source;\r\nreturn 0;\r\n}\r\nstatic int snd_ca0106_capture_source_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ca0106 *emu = snd_kcontrol_chip(kcontrol);\r\nunsigned int val;\r\nint change = 0;\r\nval = ucontrol->value.enumerated.item[0] ;\r\nif (val >= 6)\r\nreturn -EINVAL;\r\nchange = (emu->capture_source != val);\r\nif (change) {\r\nemu->capture_source = val;\r\nca0106_set_capture_source(emu);\r\n}\r\nreturn change;\r\n}\r\nstatic int snd_ca0106_i2c_capture_source_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nstatic const char * const texts[4] = {\r\n"Phone", "Mic", "Line in", "Aux"\r\n};\r\nreturn snd_ctl_enum_info(uinfo, 1, 4, texts);\r\n}\r\nstatic int snd_ca0106_i2c_capture_source_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ca0106 *emu = snd_kcontrol_chip(kcontrol);\r\nucontrol->value.enumerated.item[0] = emu->i2c_capture_source;\r\nreturn 0;\r\n}\r\nstatic int snd_ca0106_i2c_capture_source_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ca0106 *emu = snd_kcontrol_chip(kcontrol);\r\nunsigned int source_id;\r\nint change = 0;\r\nsource_id = ucontrol->value.enumerated.item[0] ;\r\nif (source_id >= 4)\r\nreturn -EINVAL;\r\nchange = (emu->i2c_capture_source != source_id);\r\nif (change) {\r\nca0106_set_i2c_capture_source(emu, source_id, 0);\r\n}\r\nreturn change;\r\n}\r\nstatic int snd_ca0106_capture_line_in_side_out_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nstatic const char * const texts[2] = { "Side out", "Line in" };\r\nreturn snd_ctl_enum_info(uinfo, 1, 2, texts);\r\n}\r\nstatic int snd_ca0106_capture_mic_line_in_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nstatic const char * const texts[2] = { "Line in", "Mic in" };\r\nreturn snd_ctl_enum_info(uinfo, 1, 2, texts);\r\n}\r\nstatic int snd_ca0106_capture_mic_line_in_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ca0106 *emu = snd_kcontrol_chip(kcontrol);\r\nucontrol->value.enumerated.item[0] = emu->capture_mic_line_in;\r\nreturn 0;\r\n}\r\nstatic int snd_ca0106_capture_mic_line_in_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ca0106 *emu = snd_kcontrol_chip(kcontrol);\r\nunsigned int val;\r\nint change = 0;\r\nval = ucontrol->value.enumerated.item[0] ;\r\nif (val > 1)\r\nreturn -EINVAL;\r\nchange = (emu->capture_mic_line_in != val);\r\nif (change) {\r\nemu->capture_mic_line_in = val;\r\nca0106_set_capture_mic_line_in(emu);\r\n}\r\nreturn change;\r\n}\r\nstatic int snd_ca0106_spdif_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_IEC958;\r\nuinfo->count = 1;\r\nreturn 0;\r\n}\r\nstatic void decode_spdif_bits(unsigned char *status, unsigned int bits)\r\n{\r\nstatus[0] = (bits >> 0) & 0xff;\r\nstatus[1] = (bits >> 8) & 0xff;\r\nstatus[2] = (bits >> 16) & 0xff;\r\nstatus[3] = (bits >> 24) & 0xff;\r\n}\r\nstatic int snd_ca0106_spdif_get_default(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ca0106 *emu = snd_kcontrol_chip(kcontrol);\r\nunsigned int idx = snd_ctl_get_ioffidx(kcontrol, &ucontrol->id);\r\ndecode_spdif_bits(ucontrol->value.iec958.status,\r\nemu->spdif_bits[idx]);\r\nreturn 0;\r\n}\r\nstatic int snd_ca0106_spdif_get_stream(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ca0106 *emu = snd_kcontrol_chip(kcontrol);\r\nunsigned int idx = snd_ctl_get_ioffidx(kcontrol, &ucontrol->id);\r\ndecode_spdif_bits(ucontrol->value.iec958.status,\r\nemu->spdif_str_bits[idx]);\r\nreturn 0;\r\n}\r\nstatic int snd_ca0106_spdif_get_mask(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nucontrol->value.iec958.status[0] = 0xff;\r\nucontrol->value.iec958.status[1] = 0xff;\r\nucontrol->value.iec958.status[2] = 0xff;\r\nucontrol->value.iec958.status[3] = 0xff;\r\nreturn 0;\r\n}\r\nstatic unsigned int encode_spdif_bits(unsigned char *status)\r\n{\r\nreturn ((unsigned int)status[0] << 0) |\r\n((unsigned int)status[1] << 8) |\r\n((unsigned int)status[2] << 16) |\r\n((unsigned int)status[3] << 24);\r\n}\r\nstatic int snd_ca0106_spdif_put_default(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ca0106 *emu = snd_kcontrol_chip(kcontrol);\r\nunsigned int idx = snd_ctl_get_ioffidx(kcontrol, &ucontrol->id);\r\nunsigned int val;\r\nval = encode_spdif_bits(ucontrol->value.iec958.status);\r\nif (val != emu->spdif_bits[idx]) {\r\nemu->spdif_bits[idx] = val;\r\nemu->spdif_str_bits[idx] = val;\r\nca0106_set_spdif_bits(emu, idx);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int snd_ca0106_spdif_put_stream(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ca0106 *emu = snd_kcontrol_chip(kcontrol);\r\nunsigned int idx = snd_ctl_get_ioffidx(kcontrol, &ucontrol->id);\r\nunsigned int val;\r\nval = encode_spdif_bits(ucontrol->value.iec958.status);\r\nif (val != emu->spdif_str_bits[idx]) {\r\nemu->spdif_str_bits[idx] = val;\r\nca0106_set_spdif_bits(emu, idx);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int snd_ca0106_volume_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\r\nuinfo->count = 2;\r\nuinfo->value.integer.min = 0;\r\nuinfo->value.integer.max = 255;\r\nreturn 0;\r\n}\r\nstatic int snd_ca0106_volume_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ca0106 *emu = snd_kcontrol_chip(kcontrol);\r\nunsigned int value;\r\nint channel_id, reg;\r\nchannel_id = (kcontrol->private_value >> 8) & 0xff;\r\nreg = kcontrol->private_value & 0xff;\r\nvalue = snd_ca0106_ptr_read(emu, reg, channel_id);\r\nucontrol->value.integer.value[0] = 0xff - ((value >> 24) & 0xff);\r\nucontrol->value.integer.value[1] = 0xff - ((value >> 16) & 0xff);\r\nreturn 0;\r\n}\r\nstatic int snd_ca0106_volume_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ca0106 *emu = snd_kcontrol_chip(kcontrol);\r\nunsigned int oval, nval;\r\nint channel_id, reg;\r\nchannel_id = (kcontrol->private_value >> 8) & 0xff;\r\nreg = kcontrol->private_value & 0xff;\r\noval = snd_ca0106_ptr_read(emu, reg, channel_id);\r\nnval = ((0xff - ucontrol->value.integer.value[0]) << 24) |\r\n((0xff - ucontrol->value.integer.value[1]) << 16);\r\nnval |= ((0xff - ucontrol->value.integer.value[0]) << 8) |\r\n((0xff - ucontrol->value.integer.value[1]) );\r\nif (oval == nval)\r\nreturn 0;\r\nsnd_ca0106_ptr_write(emu, reg, channel_id, nval);\r\nreturn 1;\r\n}\r\nstatic int snd_ca0106_i2c_volume_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\r\nuinfo->count = 2;\r\nuinfo->value.integer.min = 0;\r\nuinfo->value.integer.max = 255;\r\nreturn 0;\r\n}\r\nstatic int snd_ca0106_i2c_volume_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ca0106 *emu = snd_kcontrol_chip(kcontrol);\r\nint source_id;\r\nsource_id = kcontrol->private_value;\r\nucontrol->value.integer.value[0] = emu->i2c_capture_volume[source_id][0];\r\nucontrol->value.integer.value[1] = emu->i2c_capture_volume[source_id][1];\r\nreturn 0;\r\n}\r\nstatic int snd_ca0106_i2c_volume_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ca0106 *emu = snd_kcontrol_chip(kcontrol);\r\nunsigned int ogain;\r\nunsigned int ngain;\r\nint source_id;\r\nint change = 0;\r\nsource_id = kcontrol->private_value;\r\nogain = emu->i2c_capture_volume[source_id][0];\r\nngain = ucontrol->value.integer.value[0];\r\nif (ngain > 0xff)\r\nreturn -EINVAL;\r\nif (ogain != ngain) {\r\nif (emu->i2c_capture_source == source_id)\r\nsnd_ca0106_i2c_write(emu, ADC_ATTEN_ADCL, ((ngain) & 0xff) );\r\nemu->i2c_capture_volume[source_id][0] = ucontrol->value.integer.value[0];\r\nchange = 1;\r\n}\r\nogain = emu->i2c_capture_volume[source_id][1];\r\nngain = ucontrol->value.integer.value[1];\r\nif (ngain > 0xff)\r\nreturn -EINVAL;\r\nif (ogain != ngain) {\r\nif (emu->i2c_capture_source == source_id)\r\nsnd_ca0106_i2c_write(emu, ADC_ATTEN_ADCR, ((ngain) & 0xff));\r\nemu->i2c_capture_volume[source_id][1] = ucontrol->value.integer.value[1];\r\nchange = 1;\r\n}\r\nreturn change;\r\n}\r\nstatic int spi_mute_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ca0106 *emu = snd_kcontrol_chip(kcontrol);\r\nunsigned int reg = kcontrol->private_value >> SPI_REG_SHIFT;\r\nunsigned int bit = kcontrol->private_value & SPI_REG_MASK;\r\nucontrol->value.integer.value[0] = !(emu->spi_dac_reg[reg] & bit);\r\nreturn 0;\r\n}\r\nstatic int spi_mute_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ca0106 *emu = snd_kcontrol_chip(kcontrol);\r\nunsigned int reg = kcontrol->private_value >> SPI_REG_SHIFT;\r\nunsigned int bit = kcontrol->private_value & SPI_REG_MASK;\r\nint ret;\r\nret = emu->spi_dac_reg[reg] & bit;\r\nif (ucontrol->value.integer.value[0]) {\r\nif (!ret)\r\nreturn 0;\r\nemu->spi_dac_reg[reg] &= ~bit;\r\n} else {\r\nif (ret)\r\nreturn 0;\r\nemu->spi_dac_reg[reg] |= bit;\r\n}\r\nret = snd_ca0106_spi_write(emu, emu->spi_dac_reg[reg]);\r\nreturn ret ? -EINVAL : 1;\r\n}\r\nstatic struct snd_kcontrol_new\r\nsnd_ca0106_volume_spi_dac_ctl(struct snd_ca0106_details *details,\r\nint channel_id)\r\n{\r\nstruct snd_kcontrol_new spi_switch = {0};\r\nint reg, bit;\r\nint dac_id;\r\nspi_switch.iface = SNDRV_CTL_ELEM_IFACE_MIXER;\r\nspi_switch.access = SNDRV_CTL_ELEM_ACCESS_READWRITE;\r\nspi_switch.info = spi_mute_info;\r\nspi_switch.get = spi_mute_get;\r\nspi_switch.put = spi_mute_put;\r\nswitch (channel_id) {\r\ncase PCM_FRONT_CHANNEL:\r\nspi_switch.name = "Analog Front Playback Switch";\r\ndac_id = (details->spi_dac & 0xf000) >> (4 * 3);\r\nbreak;\r\ncase PCM_REAR_CHANNEL:\r\nspi_switch.name = "Analog Rear Playback Switch";\r\ndac_id = (details->spi_dac & 0x0f00) >> (4 * 2);\r\nbreak;\r\ncase PCM_CENTER_LFE_CHANNEL:\r\nspi_switch.name = "Analog Center/LFE Playback Switch";\r\ndac_id = (details->spi_dac & 0x00f0) >> (4 * 1);\r\nbreak;\r\ncase PCM_UNKNOWN_CHANNEL:\r\nspi_switch.name = "Analog Side Playback Switch";\r\ndac_id = (details->spi_dac & 0x000f) >> (4 * 0);\r\nbreak;\r\ndefault:\r\nspi_switch.name = NULL;\r\ndac_id = 0;\r\n}\r\nreg = spi_dmute_reg[dac_id];\r\nbit = spi_dmute_bit[dac_id];\r\nspi_switch.private_value = (reg << SPI_REG_SHIFT) | bit;\r\nreturn spi_switch;\r\n}\r\nstatic int remove_ctl(struct snd_card *card, const char *name)\r\n{\r\nstruct snd_ctl_elem_id id;\r\nmemset(&id, 0, sizeof(id));\r\nstrcpy(id.name, name);\r\nid.iface = SNDRV_CTL_ELEM_IFACE_MIXER;\r\nreturn snd_ctl_remove_id(card, &id);\r\n}\r\nstatic struct snd_kcontrol *ctl_find(struct snd_card *card, const char *name)\r\n{\r\nstruct snd_ctl_elem_id sid;\r\nmemset(&sid, 0, sizeof(sid));\r\nstrcpy(sid.name, name);\r\nsid.iface = SNDRV_CTL_ELEM_IFACE_MIXER;\r\nreturn snd_ctl_find_id(card, &sid);\r\n}\r\nstatic int rename_ctl(struct snd_card *card, const char *src, const char *dst)\r\n{\r\nstruct snd_kcontrol *kctl = ctl_find(card, src);\r\nif (kctl) {\r\nstrcpy(kctl->id.name, dst);\r\nreturn 0;\r\n}\r\nreturn -ENOENT;\r\n}\r\nstatic void add_slaves(struct snd_card *card,\r\nstruct snd_kcontrol *master, char **list)\r\n{\r\nfor (; *list; list++) {\r\nstruct snd_kcontrol *slave = ctl_find(card, *list);\r\nif (slave)\r\nsnd_ctl_add_slave(master, slave);\r\n}\r\n}\r\nint snd_ca0106_mixer(struct snd_ca0106 *emu)\r\n{\r\nint err;\r\nstruct snd_card *card = emu->card;\r\nchar **c;\r\nstruct snd_kcontrol *vmaster;\r\nstatic char *ca0106_remove_ctls[] = {\r\n"Master Mono Playback Switch",\r\n"Master Mono Playback Volume",\r\n"3D Control - Switch",\r\n"3D Control Sigmatel - Depth",\r\n"PCM Playback Switch",\r\n"PCM Playback Volume",\r\n"CD Playback Switch",\r\n"CD Playback Volume",\r\n"Phone Playback Switch",\r\n"Phone Playback Volume",\r\n"Video Playback Switch",\r\n"Video Playback Volume",\r\n"Beep Playback Switch",\r\n"Beep Playback Volume",\r\n"Mono Output Select",\r\n"Capture Source",\r\n"Capture Switch",\r\n"Capture Volume",\r\n"External Amplifier",\r\n"Sigmatel 4-Speaker Stereo Playback Switch",\r\n"Surround Phase Inversion Playback Switch",\r\nNULL\r\n};\r\nstatic char *ca0106_rename_ctls[] = {\r\n"Master Playback Switch", "Capture Switch",\r\n"Master Playback Volume", "Capture Volume",\r\n"Line Playback Switch", "AC97 Line Capture Switch",\r\n"Line Playback Volume", "AC97 Line Capture Volume",\r\n"Aux Playback Switch", "AC97 Aux Capture Switch",\r\n"Aux Playback Volume", "AC97 Aux Capture Volume",\r\n"Mic Playback Switch", "AC97 Mic Capture Switch",\r\n"Mic Playback Volume", "AC97 Mic Capture Volume",\r\n"Mic Select", "AC97 Mic Select",\r\n"Mic Boost (+20dB)", "AC97 Mic Boost (+20dB)",\r\nNULL\r\n};\r\n#if 1\r\nfor (c = ca0106_remove_ctls; *c; c++)\r\nremove_ctl(card, *c);\r\nfor (c = ca0106_rename_ctls; *c; c += 2)\r\nrename_ctl(card, c[0], c[1]);\r\n#endif\r\nADD_CTLS(emu, snd_ca0106_volume_ctls);\r\nif (emu->details->i2c_adc == 1) {\r\nADD_CTLS(emu, snd_ca0106_volume_i2c_adc_ctls);\r\nif (emu->details->gpio_type == 1)\r\nerr = snd_ctl_add(card, snd_ctl_new1(&snd_ca0106_capture_mic_line_in, emu));\r\nelse\r\nerr = snd_ctl_add(card, snd_ctl_new1(&snd_ca0106_capture_line_in_side_out, emu));\r\nif (err < 0)\r\nreturn err;\r\n}\r\nif (emu->details->spi_dac) {\r\nint i;\r\nfor (i = 0;; i++) {\r\nstruct snd_kcontrol_new ctl;\r\nctl = snd_ca0106_volume_spi_dac_ctl(emu->details, i);\r\nif (!ctl.name)\r\nbreak;\r\nerr = snd_ctl_add(card, snd_ctl_new1(&ctl, emu));\r\nif (err < 0)\r\nreturn err;\r\n}\r\n}\r\nvmaster = snd_ctl_make_virtual_master("Master Playback Volume",\r\nsnd_ca0106_master_db_scale);\r\nif (!vmaster)\r\nreturn -ENOMEM;\r\nerr = snd_ctl_add(card, vmaster);\r\nif (err < 0)\r\nreturn err;\r\nadd_slaves(card, vmaster, slave_vols);\r\nif (emu->details->spi_dac) {\r\nvmaster = snd_ctl_make_virtual_master("Master Playback Switch",\r\nNULL);\r\nif (!vmaster)\r\nreturn -ENOMEM;\r\nerr = snd_ctl_add(card, vmaster);\r\nif (err < 0)\r\nreturn err;\r\nadd_slaves(card, vmaster, slave_sws);\r\n}\r\nstrcpy(card->mixername, "CA0106");\r\nreturn 0;\r\n}\r\nvoid snd_ca0106_mixer_suspend(struct snd_ca0106 *chip)\r\n{\r\nint i;\r\nfor (i = 0; i < NUM_SAVED_VOLUMES; i++)\r\nchip->saved_vol[i] =\r\nsnd_ca0106_ptr_read(chip, saved_volumes[i].reg,\r\nsaved_volumes[i].channel_id);\r\n}\r\nvoid snd_ca0106_mixer_resume(struct snd_ca0106 *chip)\r\n{\r\nint i;\r\nfor (i = 0; i < NUM_SAVED_VOLUMES; i++)\r\nsnd_ca0106_ptr_write(chip, saved_volumes[i].reg,\r\nsaved_volumes[i].channel_id,\r\nchip->saved_vol[i]);\r\nca0106_spdif_enable(chip);\r\nca0106_set_capture_source(chip);\r\nca0106_set_i2c_capture_source(chip, chip->i2c_capture_source, 1);\r\nfor (i = 0; i < 4; i++)\r\nca0106_set_spdif_bits(chip, i);\r\nif (chip->details->i2c_adc)\r\nca0106_set_capture_mic_line_in(chip);\r\n}

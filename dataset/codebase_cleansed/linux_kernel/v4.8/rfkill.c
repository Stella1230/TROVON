bool b43_is_hw_radio_enabled(struct b43_wldev *dev)\r\n{\r\nreturn !(b43_read32(dev, B43_MMIO_RADIO_HWENABLED_HI)\r\n& B43_MMIO_RADIO_HWENABLED_HI_MASK);\r\n}\r\nvoid b43_rfkill_poll(struct ieee80211_hw *hw)\r\n{\r\nstruct b43_wl *wl = hw_to_b43_wl(hw);\r\nstruct b43_wldev *dev = wl->current_dev;\r\nbool enabled;\r\nbool brought_up = false;\r\nmutex_lock(&wl->mutex);\r\nif (unlikely(b43_status(dev) < B43_STAT_INITIALIZED)) {\r\nif (b43_bus_powerup(dev, 0)) {\r\nmutex_unlock(&wl->mutex);\r\nreturn;\r\n}\r\nb43_device_enable(dev, 0);\r\nbrought_up = true;\r\n}\r\nenabled = b43_is_hw_radio_enabled(dev);\r\nif (unlikely(enabled != dev->radio_hw_enable)) {\r\ndev->radio_hw_enable = enabled;\r\nb43info(wl, "Radio hardware status changed to %s\n",\r\nenabled ? "ENABLED" : "DISABLED");\r\nwiphy_rfkill_set_hw_state(hw->wiphy, !enabled);\r\nif (enabled != dev->phy.radio_on)\r\nb43_software_rfkill(dev, !enabled);\r\n}\r\nif (brought_up) {\r\nb43_device_disable(dev, 0);\r\nb43_bus_may_powerdown(dev);\r\n}\r\nmutex_unlock(&wl->mutex);\r\n}

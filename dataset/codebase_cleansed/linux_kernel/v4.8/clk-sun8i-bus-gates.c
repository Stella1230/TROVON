static void __init sun8i_h3_bus_gates_init(struct device_node *node)\r\n{\r\nstatic const char * const names[] = { "ahb1", "ahb2", "apb1", "apb2" };\r\nenum { AHB1, AHB2, APB1, APB2, PARENT_MAX } clk_parent;\r\nconst char *parents[PARENT_MAX];\r\nstruct clk_onecell_data *clk_data;\r\nconst char *clk_name;\r\nstruct property *prop;\r\nstruct resource res;\r\nvoid __iomem *clk_reg;\r\nvoid __iomem *reg;\r\nconst __be32 *p;\r\nint number, i;\r\nu8 clk_bit;\r\nint index;\r\nreg = of_io_request_and_map(node, 0, of_node_full_name(node));\r\nif (IS_ERR(reg))\r\nreturn;\r\nfor (i = 0; i < ARRAY_SIZE(names); i++) {\r\nint idx = of_property_match_string(node, "clock-names",\r\nnames[i]);\r\nif (idx < 0)\r\nreturn;\r\nparents[i] = of_clk_get_parent_name(node, idx);\r\n}\r\nclk_data = kmalloc(sizeof(struct clk_onecell_data), GFP_KERNEL);\r\nif (!clk_data)\r\ngoto err_unmap;\r\nnumber = of_property_count_u32_elems(node, "clock-indices");\r\nof_property_read_u32_index(node, "clock-indices", number - 1, &number);\r\nclk_data->clks = kcalloc(number + 1, sizeof(struct clk *), GFP_KERNEL);\r\nif (!clk_data->clks)\r\ngoto err_free_data;\r\ni = 0;\r\nof_property_for_each_u32(node, "clock-indices", prop, p, index) {\r\nof_property_read_string_index(node, "clock-output-names",\r\ni, &clk_name);\r\nif (index == 17 || (index >= 29 && index <= 31))\r\nclk_parent = AHB2;\r\nelse if (index <= 63 || index >= 128)\r\nclk_parent = AHB1;\r\nelse if (index >= 64 && index <= 95)\r\nclk_parent = APB1;\r\nelse if (index >= 96 && index <= 127)\r\nclk_parent = APB2;\r\nclk_reg = reg + 4 * (index / 32);\r\nclk_bit = index % 32;\r\nclk_data->clks[index] = clk_register_gate(NULL, clk_name,\r\nparents[clk_parent],\r\n0, clk_reg, clk_bit,\r\n0, &gates_lock);\r\ni++;\r\nif (IS_ERR(clk_data->clks[index])) {\r\nWARN_ON(true);\r\ncontinue;\r\n}\r\n}\r\nclk_data->clk_num = number + 1;\r\nof_clk_add_provider(node, of_clk_src_onecell_get, clk_data);\r\nreturn;\r\nerr_free_data:\r\nkfree(clk_data);\r\nerr_unmap:\r\niounmap(reg);\r\nof_address_to_resource(node, 0, &res);\r\nrelease_mem_region(res.start, resource_size(&res));\r\n}

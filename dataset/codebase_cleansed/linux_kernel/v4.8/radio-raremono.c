static inline struct raremono_device *to_raremono_dev(struct v4l2_device *v4l2_dev)\r\n{\r\nreturn container_of(v4l2_dev, struct raremono_device, v4l2_dev);\r\n}\r\nstatic int raremono_cmd_main(struct raremono_device *radio, unsigned band, unsigned freq)\r\n{\r\nunsigned band_offset;\r\nint ret;\r\nswitch (band) {\r\ncase BAND_FM:\r\nband_offset = 1;\r\nfreq /= 10;\r\nbreak;\r\ncase BAND_AM:\r\nband_offset = 0;\r\nbreak;\r\ndefault:\r\nband_offset = 2;\r\nbreak;\r\n}\r\nradio->buffer[0] = 0x04 + band_offset;\r\nradio->buffer[1] = freq >> 8;\r\nradio->buffer[2] = freq & 0xff;\r\nret = usb_control_msg(radio->usbdev, usb_sndctrlpipe(radio->usbdev, 0),\r\nHID_REQ_SET_REPORT,\r\nUSB_TYPE_CLASS | USB_RECIP_INTERFACE | USB_DIR_OUT,\r\n0x0300 + radio->buffer[0], 2,\r\nradio->buffer, 3, USB_TIMEOUT);\r\nif (ret < 0) {\r\ndev_warn(radio->v4l2_dev.dev, "%s failed (%d)\n", __func__, ret);\r\nreturn ret;\r\n}\r\nradio->curfreq = (band == BAND_FM) ? freq * 10 : freq;\r\nreturn 0;\r\n}\r\nstatic void usb_raremono_disconnect(struct usb_interface *intf)\r\n{\r\nstruct raremono_device *radio = to_raremono_dev(usb_get_intfdata(intf));\r\ndev_info(&intf->dev, "Thanko's Raremono disconnected\n");\r\nmutex_lock(&radio->lock);\r\nusb_set_intfdata(intf, NULL);\r\nvideo_unregister_device(&radio->vdev);\r\nv4l2_device_disconnect(&radio->v4l2_dev);\r\nmutex_unlock(&radio->lock);\r\nv4l2_device_put(&radio->v4l2_dev);\r\n}\r\nstatic int vidioc_querycap(struct file *file, void *priv,\r\nstruct v4l2_capability *v)\r\n{\r\nstruct raremono_device *radio = video_drvdata(file);\r\nstrlcpy(v->driver, "radio-raremono", sizeof(v->driver));\r\nstrlcpy(v->card, "Thanko's Raremono", sizeof(v->card));\r\nusb_make_path(radio->usbdev, v->bus_info, sizeof(v->bus_info));\r\nv->device_caps = V4L2_CAP_TUNER | V4L2_CAP_RADIO;\r\nv->capabilities = v->device_caps | V4L2_CAP_DEVICE_CAPS;\r\nreturn 0;\r\n}\r\nstatic int vidioc_enum_freq_bands(struct file *file, void *priv,\r\nstruct v4l2_frequency_band *band)\r\n{\r\nif (band->tuner != 0)\r\nreturn -EINVAL;\r\nif (band->index >= ARRAY_SIZE(bands))\r\nreturn -EINVAL;\r\n*band = bands[band->index];\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_tuner(struct file *file, void *priv,\r\nstruct v4l2_tuner *v)\r\n{\r\nstruct raremono_device *radio = video_drvdata(file);\r\nint ret;\r\nif (v->index > 0)\r\nreturn -EINVAL;\r\nstrlcpy(v->name, "AM/FM/SW", sizeof(v->name));\r\nv->capability = V4L2_TUNER_CAP_LOW | V4L2_TUNER_CAP_STEREO |\r\nV4L2_TUNER_CAP_FREQ_BANDS;\r\nv->rangelow = AM_FREQ_RANGE_LOW * 16;\r\nv->rangehigh = FM_FREQ_RANGE_HIGH * 16;\r\nv->rxsubchans = V4L2_TUNER_SUB_STEREO | V4L2_TUNER_SUB_MONO;\r\nv->audmode = (radio->curfreq < FM_FREQ_RANGE_LOW) ?\r\nV4L2_TUNER_MODE_MONO : V4L2_TUNER_MODE_STEREO;\r\nmemset(radio->buffer, 1, BUFFER_LENGTH);\r\nret = usb_control_msg(radio->usbdev, usb_rcvctrlpipe(radio->usbdev, 0),\r\n1, 0xa1, 0x030d, 2, radio->buffer, BUFFER_LENGTH, USB_TIMEOUT);\r\nif (ret < 0) {\r\ndev_warn(radio->v4l2_dev.dev, "%s failed (%d)\n", __func__, ret);\r\nreturn ret;\r\n}\r\nv->signal = ((radio->buffer[1] & 0xf) << 8 | radio->buffer[2]) << 4;\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_tuner(struct file *file, void *priv,\r\nconst struct v4l2_tuner *v)\r\n{\r\nreturn v->index ? -EINVAL : 0;\r\n}\r\nstatic int vidioc_s_frequency(struct file *file, void *priv,\r\nconst struct v4l2_frequency *f)\r\n{\r\nstruct raremono_device *radio = video_drvdata(file);\r\nu32 freq = f->frequency;\r\nunsigned band;\r\nif (f->tuner != 0 || f->type != V4L2_TUNER_RADIO)\r\nreturn -EINVAL;\r\nif (f->frequency >= (FM_FREQ_RANGE_LOW + SW_FREQ_RANGE_HIGH) * 8)\r\nband = BAND_FM;\r\nelse if (f->frequency <= (AM_FREQ_RANGE_HIGH + SW_FREQ_RANGE_LOW) * 8)\r\nband = BAND_AM;\r\nelse\r\nband = BAND_SW;\r\nfreq = clamp_t(u32, f->frequency, bands[band].rangelow, bands[band].rangehigh);\r\nreturn raremono_cmd_main(radio, band, freq / 16);\r\n}\r\nstatic int vidioc_g_frequency(struct file *file, void *priv,\r\nstruct v4l2_frequency *f)\r\n{\r\nstruct raremono_device *radio = video_drvdata(file);\r\nif (f->tuner != 0)\r\nreturn -EINVAL;\r\nf->type = V4L2_TUNER_RADIO;\r\nf->frequency = radio->curfreq * 16;\r\nreturn 0;\r\n}\r\nstatic int usb_raremono_probe(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct raremono_device *radio;\r\nint retval = 0;\r\nradio = devm_kzalloc(&intf->dev, sizeof(struct raremono_device), GFP_KERNEL);\r\nif (radio)\r\nradio->buffer = devm_kmalloc(&intf->dev, BUFFER_LENGTH, GFP_KERNEL);\r\nif (!radio || !radio->buffer)\r\nreturn -ENOMEM;\r\nradio->usbdev = interface_to_usbdev(intf);\r\nradio->intf = intf;\r\nmsleep(20);\r\nretval = usb_control_msg(radio->usbdev,\r\nusb_rcvctrlpipe(radio->usbdev, 0),\r\nHID_REQ_GET_REPORT,\r\nUSB_TYPE_CLASS | USB_RECIP_INTERFACE | USB_DIR_IN,\r\n1, 2,\r\nradio->buffer, 3, 500);\r\nif (retval != 3 ||\r\n(get_unaligned_be16(&radio->buffer[1]) & 0xfff) == 0x0242) {\r\ndev_info(&intf->dev, "this is not Thanko's Raremono.\n");\r\nreturn -ENODEV;\r\n}\r\ndev_info(&intf->dev, "Thanko's Raremono connected: (%04X:%04X)\n",\r\nid->idVendor, id->idProduct);\r\nretval = v4l2_device_register(&intf->dev, &radio->v4l2_dev);\r\nif (retval < 0) {\r\ndev_err(&intf->dev, "couldn't register v4l2_device\n");\r\nreturn retval;\r\n}\r\nmutex_init(&radio->lock);\r\nstrlcpy(radio->vdev.name, radio->v4l2_dev.name,\r\nsizeof(radio->vdev.name));\r\nradio->vdev.v4l2_dev = &radio->v4l2_dev;\r\nradio->vdev.fops = &usb_raremono_fops;\r\nradio->vdev.ioctl_ops = &usb_raremono_ioctl_ops;\r\nradio->vdev.lock = &radio->lock;\r\nradio->vdev.release = video_device_release_empty;\r\nusb_set_intfdata(intf, &radio->v4l2_dev);\r\nvideo_set_drvdata(&radio->vdev, radio);\r\nraremono_cmd_main(radio, BAND_FM, 95160);\r\nretval = video_register_device(&radio->vdev, VFL_TYPE_RADIO, -1);\r\nif (retval == 0) {\r\ndev_info(&intf->dev, "V4L2 device registered as %s\n",\r\nvideo_device_node_name(&radio->vdev));\r\nreturn 0;\r\n}\r\ndev_err(&intf->dev, "could not register video device\n");\r\nv4l2_device_unregister(&radio->v4l2_dev);\r\nreturn retval;\r\n}

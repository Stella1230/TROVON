u8 iscsit_tmr_abort_task(\r\nstruct iscsi_cmd *cmd,\r\nunsigned char *buf)\r\n{\r\nstruct iscsi_cmd *ref_cmd;\r\nstruct iscsi_conn *conn = cmd->conn;\r\nstruct iscsi_tmr_req *tmr_req = cmd->tmr_req;\r\nstruct se_tmr_req *se_tmr = cmd->se_cmd.se_tmr_req;\r\nstruct iscsi_tm *hdr = (struct iscsi_tm *) buf;\r\nref_cmd = iscsit_find_cmd_from_itt(conn, hdr->rtt);\r\nif (!ref_cmd) {\r\npr_err("Unable to locate RefTaskTag: 0x%08x on CID:"\r\n" %hu.\n", hdr->rtt, conn->cid);\r\nreturn (iscsi_sna_gte(be32_to_cpu(hdr->refcmdsn), conn->sess->exp_cmd_sn) &&\r\niscsi_sna_lte(be32_to_cpu(hdr->refcmdsn), (u32) atomic_read(&conn->sess->max_cmd_sn))) ?\r\nISCSI_TMF_RSP_COMPLETE : ISCSI_TMF_RSP_NO_TASK;\r\n}\r\nif (ref_cmd->cmd_sn != be32_to_cpu(hdr->refcmdsn)) {\r\npr_err("RefCmdSN 0x%08x does not equal"\r\n" task's CmdSN 0x%08x. Rejecting ABORT_TASK.\n",\r\nhdr->refcmdsn, ref_cmd->cmd_sn);\r\nreturn ISCSI_TMF_RSP_REJECTED;\r\n}\r\nse_tmr->ref_task_tag = (__force u32)hdr->rtt;\r\ntmr_req->ref_cmd = ref_cmd;\r\ntmr_req->exp_data_sn = be32_to_cpu(hdr->exp_datasn);\r\nreturn ISCSI_TMF_RSP_COMPLETE;\r\n}\r\nint iscsit_tmr_task_warm_reset(\r\nstruct iscsi_conn *conn,\r\nstruct iscsi_tmr_req *tmr_req,\r\nunsigned char *buf)\r\n{\r\nstruct iscsi_session *sess = conn->sess;\r\nstruct iscsi_node_attrib *na = iscsit_tpg_get_node_attrib(sess);\r\nif (!na->tmr_warm_reset) {\r\npr_err("TMR Opcode TARGET_WARM_RESET authorization"\r\n" failed for Initiator Node: %s\n",\r\nsess->se_sess->se_node_acl->initiatorname);\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nint iscsit_tmr_task_cold_reset(\r\nstruct iscsi_conn *conn,\r\nstruct iscsi_tmr_req *tmr_req,\r\nunsigned char *buf)\r\n{\r\nstruct iscsi_session *sess = conn->sess;\r\nstruct iscsi_node_attrib *na = iscsit_tpg_get_node_attrib(sess);\r\nif (!na->tmr_cold_reset) {\r\npr_err("TMR Opcode TARGET_COLD_RESET authorization"\r\n" failed for Initiator Node: %s\n",\r\nsess->se_sess->se_node_acl->initiatorname);\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nu8 iscsit_tmr_task_reassign(\r\nstruct iscsi_cmd *cmd,\r\nunsigned char *buf)\r\n{\r\nstruct iscsi_cmd *ref_cmd = NULL;\r\nstruct iscsi_conn *conn = cmd->conn;\r\nstruct iscsi_conn_recovery *cr = NULL;\r\nstruct iscsi_tmr_req *tmr_req = cmd->tmr_req;\r\nstruct se_tmr_req *se_tmr = cmd->se_cmd.se_tmr_req;\r\nstruct iscsi_tm *hdr = (struct iscsi_tm *) buf;\r\nu64 ret, ref_lun;\r\npr_debug("Got TASK_REASSIGN TMR ITT: 0x%08x,"\r\n" RefTaskTag: 0x%08x, ExpDataSN: 0x%08x, CID: %hu\n",\r\nhdr->itt, hdr->rtt, hdr->exp_datasn, conn->cid);\r\nif (conn->sess->sess_ops->ErrorRecoveryLevel != 2) {\r\npr_err("TMR TASK_REASSIGN not supported in ERL<2,"\r\n" ignoring request.\n");\r\nreturn ISCSI_TMF_RSP_NOT_SUPPORTED;\r\n}\r\nret = iscsit_find_cmd_for_recovery(conn->sess, &ref_cmd, &cr, hdr->rtt);\r\nif (ret == -2) {\r\npr_err("Command ITT: 0x%08x is still alligent to CID:"\r\n" %hu\n", ref_cmd->init_task_tag, cr->cid);\r\nreturn ISCSI_TMF_RSP_TASK_ALLEGIANT;\r\n} else if (ret == -1) {\r\npr_err("Unable to locate RefTaskTag: 0x%08x in"\r\n" connection recovery command list.\n", hdr->rtt);\r\nreturn ISCSI_TMF_RSP_NO_TASK;\r\n}\r\nif (cr->maxrecvdatasegmentlength !=\r\nconn->conn_ops->MaxRecvDataSegmentLength) {\r\npr_err("Unable to perform connection recovery for"\r\n" differing MaxRecvDataSegmentLength, rejecting"\r\n" TMR TASK_REASSIGN.\n");\r\nreturn ISCSI_TMF_RSP_REJECTED;\r\n}\r\nif (cr->maxxmitdatasegmentlength !=\r\nconn->conn_ops->MaxXmitDataSegmentLength) {\r\npr_err("Unable to perform connection recovery for"\r\n" differing MaxXmitDataSegmentLength, rejecting"\r\n" TMR TASK_REASSIGN.\n");\r\nreturn ISCSI_TMF_RSP_REJECTED;\r\n}\r\nref_lun = scsilun_to_int(&hdr->lun);\r\nif (ref_lun != ref_cmd->se_cmd.orig_fe_lun) {\r\npr_err("Unable to perform connection recovery for"\r\n" differing ref_lun: %llu ref_cmd orig_fe_lun: %llu\n",\r\nref_lun, ref_cmd->se_cmd.orig_fe_lun);\r\nreturn ISCSI_TMF_RSP_REJECTED;\r\n}\r\nse_tmr->ref_task_tag = (__force u32)hdr->rtt;\r\ntmr_req->ref_cmd = ref_cmd;\r\ntmr_req->exp_data_sn = be32_to_cpu(hdr->exp_datasn);\r\ntmr_req->conn_recovery = cr;\r\ntmr_req->task_reassign = 1;\r\nreturn ISCSI_TMF_RSP_COMPLETE;\r\n}\r\nstatic void iscsit_task_reassign_remove_cmd(\r\nstruct iscsi_cmd *cmd,\r\nstruct iscsi_conn_recovery *cr,\r\nstruct iscsi_session *sess)\r\n{\r\nint ret;\r\nspin_lock(&cr->conn_recovery_cmd_lock);\r\nret = iscsit_remove_cmd_from_connection_recovery(cmd, sess);\r\nspin_unlock(&cr->conn_recovery_cmd_lock);\r\nif (!ret) {\r\npr_debug("iSCSI connection recovery successful for CID:"\r\n" %hu on SID: %u\n", cr->cid, sess->sid);\r\niscsit_remove_active_connection_recovery_entry(cr, sess);\r\n}\r\n}\r\nstatic int iscsit_task_reassign_complete_nop_out(\r\nstruct iscsi_tmr_req *tmr_req,\r\nstruct iscsi_conn *conn)\r\n{\r\nstruct iscsi_cmd *cmd = tmr_req->ref_cmd;\r\nstruct iscsi_conn_recovery *cr;\r\nif (!cmd->cr) {\r\npr_err("struct iscsi_conn_recovery pointer for ITT: 0x%08x"\r\n" is NULL!\n", cmd->init_task_tag);\r\nreturn -1;\r\n}\r\ncr = cmd->cr;\r\ncmd->stat_sn = cmd->exp_stat_sn = 0;\r\niscsit_task_reassign_remove_cmd(cmd, cr, conn->sess);\r\nspin_lock_bh(&conn->cmd_lock);\r\nlist_add_tail(&cmd->i_conn_node, &conn->conn_cmd_list);\r\nspin_unlock_bh(&conn->cmd_lock);\r\ncmd->i_state = ISTATE_SEND_NOPIN;\r\niscsit_add_cmd_to_response_queue(cmd, conn, cmd->i_state);\r\nreturn 0;\r\n}\r\nstatic int iscsit_task_reassign_complete_write(\r\nstruct iscsi_cmd *cmd,\r\nstruct iscsi_tmr_req *tmr_req)\r\n{\r\nint no_build_r2ts = 0;\r\nu32 length = 0, offset = 0;\r\nstruct iscsi_conn *conn = cmd->conn;\r\nstruct se_cmd *se_cmd = &cmd->se_cmd;\r\nif (!tmr_req->exp_data_sn) {\r\ncmd->cmd_flags &= ~ICF_GOT_DATACK_SNACK;\r\ncmd->acked_data_sn = 0;\r\n} else {\r\ncmd->cmd_flags |= ICF_GOT_DATACK_SNACK;\r\ncmd->acked_data_sn = (tmr_req->exp_data_sn - 1);\r\n}\r\nif (cmd->cmd_flags & ICF_GOT_LAST_DATAOUT) {\r\nif (!(cmd->se_cmd.transport_state & CMD_T_SENT)) {\r\npr_debug("WRITE ITT: 0x%08x: t_state: %d"\r\n" never sent to transport\n",\r\ncmd->init_task_tag, cmd->se_cmd.t_state);\r\ntarget_execute_cmd(se_cmd);\r\nreturn 0;\r\n}\r\ncmd->i_state = ISTATE_SEND_STATUS;\r\niscsit_add_cmd_to_response_queue(cmd, conn, cmd->i_state);\r\nreturn 0;\r\n}\r\nif (cmd->unsolicited_data) {\r\ncmd->unsolicited_data = 0;\r\noffset = cmd->next_burst_len = cmd->write_data_done;\r\nif ((conn->sess->sess_ops->FirstBurstLength - offset) >=\r\ncmd->se_cmd.data_length) {\r\nno_build_r2ts = 1;\r\nlength = (cmd->se_cmd.data_length - offset);\r\n} else\r\nlength = (conn->sess->sess_ops->FirstBurstLength - offset);\r\nspin_lock_bh(&cmd->r2t_lock);\r\nif (iscsit_add_r2t_to_list(cmd, offset, length, 0, 0) < 0) {\r\nspin_unlock_bh(&cmd->r2t_lock);\r\nreturn -1;\r\n}\r\ncmd->outstanding_r2ts++;\r\nspin_unlock_bh(&cmd->r2t_lock);\r\nif (no_build_r2ts)\r\nreturn 0;\r\n}\r\nreturn conn->conn_transport->iscsit_get_dataout(conn, cmd, true);\r\n}\r\nstatic int iscsit_task_reassign_complete_read(\r\nstruct iscsi_cmd *cmd,\r\nstruct iscsi_tmr_req *tmr_req)\r\n{\r\nstruct iscsi_conn *conn = cmd->conn;\r\nstruct iscsi_datain_req *dr;\r\nstruct se_cmd *se_cmd = &cmd->se_cmd;\r\nif (!tmr_req->exp_data_sn) {\r\ncmd->cmd_flags &= ~ICF_GOT_DATACK_SNACK;\r\ncmd->acked_data_sn = 0;\r\n} else {\r\ncmd->cmd_flags |= ICF_GOT_DATACK_SNACK;\r\ncmd->acked_data_sn = (tmr_req->exp_data_sn - 1);\r\n}\r\nif (!(cmd->se_cmd.transport_state & CMD_T_SENT)) {\r\npr_debug("READ ITT: 0x%08x: t_state: %d never sent to"\r\n" transport\n", cmd->init_task_tag,\r\ncmd->se_cmd.t_state);\r\ntransport_handle_cdb_direct(se_cmd);\r\nreturn 0;\r\n}\r\nif (!(se_cmd->transport_state & CMD_T_COMPLETE)) {\r\npr_err("READ ITT: 0x%08x: t_state: %d, never returned"\r\n" from transport\n", cmd->init_task_tag,\r\ncmd->se_cmd.t_state);\r\nreturn -1;\r\n}\r\ndr = iscsit_allocate_datain_req();\r\nif (!dr)\r\nreturn -1;\r\ndr->data_sn = dr->begrun = tmr_req->exp_data_sn;\r\ndr->runlength = 0;\r\ndr->generate_recovery_values = 1;\r\ndr->recovery = DATAIN_CONNECTION_RECOVERY;\r\niscsit_attach_datain_req(cmd, dr);\r\ncmd->i_state = ISTATE_SEND_DATAIN;\r\niscsit_add_cmd_to_response_queue(cmd, conn, cmd->i_state);\r\nreturn 0;\r\n}\r\nstatic int iscsit_task_reassign_complete_none(\r\nstruct iscsi_cmd *cmd,\r\nstruct iscsi_tmr_req *tmr_req)\r\n{\r\nstruct iscsi_conn *conn = cmd->conn;\r\ncmd->i_state = ISTATE_SEND_STATUS;\r\niscsit_add_cmd_to_response_queue(cmd, conn, cmd->i_state);\r\nreturn 0;\r\n}\r\nstatic int iscsit_task_reassign_complete_scsi_cmnd(\r\nstruct iscsi_tmr_req *tmr_req,\r\nstruct iscsi_conn *conn)\r\n{\r\nstruct iscsi_cmd *cmd = tmr_req->ref_cmd;\r\nstruct iscsi_conn_recovery *cr;\r\nif (!cmd->cr) {\r\npr_err("struct iscsi_conn_recovery pointer for ITT: 0x%08x"\r\n" is NULL!\n", cmd->init_task_tag);\r\nreturn -1;\r\n}\r\ncr = cmd->cr;\r\ncmd->stat_sn = cmd->exp_stat_sn = 0;\r\niscsit_task_reassign_remove_cmd(cmd, cr, conn->sess);\r\nspin_lock_bh(&conn->cmd_lock);\r\nlist_add_tail(&cmd->i_conn_node, &conn->conn_cmd_list);\r\nspin_unlock_bh(&conn->cmd_lock);\r\nif (cmd->se_cmd.se_cmd_flags & SCF_SENT_CHECK_CONDITION) {\r\ncmd->i_state = ISTATE_SEND_STATUS;\r\niscsit_add_cmd_to_response_queue(cmd, conn, cmd->i_state);\r\nreturn 0;\r\n}\r\nswitch (cmd->data_direction) {\r\ncase DMA_TO_DEVICE:\r\nreturn iscsit_task_reassign_complete_write(cmd, tmr_req);\r\ncase DMA_FROM_DEVICE:\r\nreturn iscsit_task_reassign_complete_read(cmd, tmr_req);\r\ncase DMA_NONE:\r\nreturn iscsit_task_reassign_complete_none(cmd, tmr_req);\r\ndefault:\r\npr_err("Unknown cmd->data_direction: 0x%02x\n",\r\ncmd->data_direction);\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int iscsit_task_reassign_complete(\r\nstruct iscsi_tmr_req *tmr_req,\r\nstruct iscsi_conn *conn)\r\n{\r\nstruct iscsi_cmd *cmd;\r\nint ret = 0;\r\nif (!tmr_req->ref_cmd) {\r\npr_err("TMR Request is missing a RefCmd struct iscsi_cmd.\n");\r\nreturn -1;\r\n}\r\ncmd = tmr_req->ref_cmd;\r\ncmd->conn = conn;\r\nswitch (cmd->iscsi_opcode) {\r\ncase ISCSI_OP_NOOP_OUT:\r\nret = iscsit_task_reassign_complete_nop_out(tmr_req, conn);\r\nbreak;\r\ncase ISCSI_OP_SCSI_CMD:\r\nret = iscsit_task_reassign_complete_scsi_cmnd(tmr_req, conn);\r\nbreak;\r\ndefault:\r\npr_err("Illegal iSCSI Opcode 0x%02x during"\r\n" command realligence\n", cmd->iscsi_opcode);\r\nreturn -1;\r\n}\r\nif (ret != 0)\r\nreturn ret;\r\npr_debug("Completed connection realligence for Opcode: 0x%02x,"\r\n" ITT: 0x%08x to CID: %hu.\n", cmd->iscsi_opcode,\r\ncmd->init_task_tag, conn->cid);\r\nreturn 0;\r\n}\r\nint iscsit_tmr_post_handler(struct iscsi_cmd *cmd, struct iscsi_conn *conn)\r\n{\r\nstruct iscsi_tmr_req *tmr_req = cmd->tmr_req;\r\nstruct se_tmr_req *se_tmr = cmd->se_cmd.se_tmr_req;\r\nif (tmr_req->task_reassign &&\r\n(se_tmr->response == ISCSI_TMF_RSP_COMPLETE))\r\nreturn iscsit_task_reassign_complete(tmr_req, conn);\r\nreturn 0;\r\n}\r\nstatic int iscsit_task_reassign_prepare_read(\r\nstruct iscsi_tmr_req *tmr_req,\r\nstruct iscsi_conn *conn)\r\n{\r\nreturn 0;\r\n}\r\nstatic void iscsit_task_reassign_prepare_unsolicited_dataout(\r\nstruct iscsi_cmd *cmd,\r\nstruct iscsi_conn *conn)\r\n{\r\nint i, j;\r\nstruct iscsi_pdu *pdu = NULL;\r\nstruct iscsi_seq *seq = NULL;\r\nif (conn->sess->sess_ops->DataSequenceInOrder) {\r\ncmd->data_sn = 0;\r\nif (cmd->immediate_data)\r\ncmd->r2t_offset += (cmd->first_burst_len -\r\ncmd->seq_start_offset);\r\nif (conn->sess->sess_ops->DataPDUInOrder) {\r\ncmd->write_data_done -= (cmd->immediate_data) ?\r\n(cmd->first_burst_len -\r\ncmd->seq_start_offset) :\r\ncmd->first_burst_len;\r\ncmd->first_burst_len = 0;\r\nreturn;\r\n}\r\nfor (i = 0; i < cmd->pdu_count; i++) {\r\npdu = &cmd->pdu_list[i];\r\nif (pdu->status != ISCSI_PDU_RECEIVED_OK)\r\ncontinue;\r\nif ((pdu->offset >= cmd->seq_start_offset) &&\r\n((pdu->offset + pdu->length) <=\r\ncmd->seq_end_offset)) {\r\ncmd->first_burst_len -= pdu->length;\r\ncmd->write_data_done -= pdu->length;\r\npdu->status = ISCSI_PDU_NOT_RECEIVED;\r\n}\r\n}\r\n} else {\r\nfor (i = 0; i < cmd->seq_count; i++) {\r\nseq = &cmd->seq_list[i];\r\nif (seq->type != SEQTYPE_UNSOLICITED)\r\ncontinue;\r\ncmd->write_data_done -=\r\n(seq->offset - seq->orig_offset);\r\ncmd->first_burst_len = 0;\r\nseq->data_sn = 0;\r\nseq->offset = seq->orig_offset;\r\nseq->next_burst_len = 0;\r\nseq->status = DATAOUT_SEQUENCE_WITHIN_COMMAND_RECOVERY;\r\nif (conn->sess->sess_ops->DataPDUInOrder)\r\ncontinue;\r\nfor (j = 0; j < seq->pdu_count; j++) {\r\npdu = &cmd->pdu_list[j+seq->pdu_start];\r\nif (pdu->status != ISCSI_PDU_RECEIVED_OK)\r\ncontinue;\r\npdu->status = ISCSI_PDU_NOT_RECEIVED;\r\n}\r\n}\r\n}\r\n}\r\nstatic int iscsit_task_reassign_prepare_write(\r\nstruct iscsi_tmr_req *tmr_req,\r\nstruct iscsi_conn *conn)\r\n{\r\nstruct iscsi_cmd *cmd = tmr_req->ref_cmd;\r\nstruct iscsi_pdu *pdu = NULL;\r\nstruct iscsi_r2t *r2t = NULL, *r2t_tmp;\r\nint first_incomplete_r2t = 1, i = 0;\r\nif (cmd->unsolicited_data)\r\niscsit_task_reassign_prepare_unsolicited_dataout(cmd, conn);\r\nif (!tmr_req->exp_data_sn)\r\ngoto drop_unacknowledged_r2ts;\r\nspin_lock_bh(&cmd->r2t_lock);\r\nif (list_empty(&cmd->cmd_r2t_list)) {\r\nspin_unlock_bh(&cmd->r2t_lock);\r\nreturn -1;\r\n}\r\nlist_for_each_entry(r2t, &cmd->cmd_r2t_list, r2t_list) {\r\nif (r2t->r2t_sn >= tmr_req->exp_data_sn)\r\ncontinue;\r\nif (r2t->seq_complete)\r\ncontinue;\r\nif (r2t->recovery_r2t)\r\ncontinue;\r\nif (conn->sess->sess_ops->DataSequenceInOrder) {\r\nif (!first_incomplete_r2t) {\r\ncmd->r2t_offset -= r2t->xfer_len;\r\ngoto next;\r\n}\r\nif (conn->sess->sess_ops->DataPDUInOrder) {\r\ncmd->data_sn = 0;\r\ncmd->r2t_offset -= (r2t->xfer_len -\r\ncmd->next_burst_len);\r\nfirst_incomplete_r2t = 0;\r\ngoto next;\r\n}\r\ncmd->data_sn = 0;\r\ncmd->r2t_offset -= r2t->xfer_len;\r\nfor (i = 0; i < cmd->pdu_count; i++) {\r\npdu = &cmd->pdu_list[i];\r\nif (pdu->status != ISCSI_PDU_RECEIVED_OK)\r\ncontinue;\r\nif ((pdu->offset >= r2t->offset) &&\r\n(pdu->offset < (r2t->offset +\r\nr2t->xfer_len))) {\r\ncmd->next_burst_len -= pdu->length;\r\ncmd->write_data_done -= pdu->length;\r\npdu->status = ISCSI_PDU_NOT_RECEIVED;\r\n}\r\n}\r\nfirst_incomplete_r2t = 0;\r\n} else {\r\nstruct iscsi_seq *seq;\r\nseq = iscsit_get_seq_holder(cmd, r2t->offset,\r\nr2t->xfer_len);\r\nif (!seq) {\r\nspin_unlock_bh(&cmd->r2t_lock);\r\nreturn -1;\r\n}\r\ncmd->write_data_done -=\r\n(seq->offset - seq->orig_offset);\r\nseq->data_sn = 0;\r\nseq->offset = seq->orig_offset;\r\nseq->next_burst_len = 0;\r\nseq->status = DATAOUT_SEQUENCE_WITHIN_COMMAND_RECOVERY;\r\ncmd->seq_send_order--;\r\nif (conn->sess->sess_ops->DataPDUInOrder)\r\ngoto next;\r\nfor (i = 0; i < seq->pdu_count; i++) {\r\npdu = &cmd->pdu_list[i+seq->pdu_start];\r\nif (pdu->status != ISCSI_PDU_RECEIVED_OK)\r\ncontinue;\r\npdu->status = ISCSI_PDU_NOT_RECEIVED;\r\n}\r\n}\r\nnext:\r\ncmd->outstanding_r2ts--;\r\n}\r\nspin_unlock_bh(&cmd->r2t_lock);\r\ndrop_unacknowledged_r2ts:\r\ncmd->cmd_flags &= ~ICF_SENT_LAST_R2T;\r\ncmd->r2t_sn = tmr_req->exp_data_sn;\r\nspin_lock_bh(&cmd->r2t_lock);\r\nlist_for_each_entry_safe(r2t, r2t_tmp, &cmd->cmd_r2t_list, r2t_list) {\r\nif (r2t->r2t_sn < tmr_req->exp_data_sn)\r\ncontinue;\r\nif (r2t->seq_complete) {\r\npr_err("Initiator is requesting R2Ts from"\r\n" R2TSN: 0x%08x, but R2TSN: 0x%08x, Offset: %u,"\r\n" Length: %u is already complete."\r\n" BAD INITIATOR ERL=2 IMPLEMENTATION!\n",\r\ntmr_req->exp_data_sn, r2t->r2t_sn,\r\nr2t->offset, r2t->xfer_len);\r\nspin_unlock_bh(&cmd->r2t_lock);\r\nreturn -1;\r\n}\r\nif (r2t->recovery_r2t) {\r\niscsit_free_r2t(r2t, cmd);\r\ncontinue;\r\n}\r\nif (conn->sess->sess_ops->DataSequenceInOrder)\r\ncmd->r2t_offset -= r2t->xfer_len;\r\nelse\r\ncmd->seq_send_order--;\r\ncmd->outstanding_r2ts--;\r\niscsit_free_r2t(r2t, cmd);\r\n}\r\nspin_unlock_bh(&cmd->r2t_lock);\r\nreturn 0;\r\n}\r\nint iscsit_check_task_reassign_expdatasn(\r\nstruct iscsi_tmr_req *tmr_req,\r\nstruct iscsi_conn *conn)\r\n{\r\nstruct iscsi_cmd *ref_cmd = tmr_req->ref_cmd;\r\nif (ref_cmd->iscsi_opcode != ISCSI_OP_SCSI_CMD)\r\nreturn 0;\r\nif (ref_cmd->se_cmd.se_cmd_flags & SCF_SENT_CHECK_CONDITION)\r\nreturn 0;\r\nif (ref_cmd->data_direction == DMA_NONE)\r\nreturn 0;\r\nif (ref_cmd->data_direction == DMA_FROM_DEVICE) {\r\nif (tmr_req->exp_data_sn > ref_cmd->data_sn) {\r\npr_err("Received ExpDataSN: 0x%08x for READ"\r\n" in TMR TASK_REASSIGN greater than command's"\r\n" DataSN: 0x%08x.\n", tmr_req->exp_data_sn,\r\nref_cmd->data_sn);\r\nreturn -1;\r\n}\r\nif ((ref_cmd->cmd_flags & ICF_GOT_DATACK_SNACK) &&\r\n(tmr_req->exp_data_sn <= ref_cmd->acked_data_sn)) {\r\npr_err("Received ExpDataSN: 0x%08x for READ"\r\n" in TMR TASK_REASSIGN for previously"\r\n" acknowledged DataIN: 0x%08x,"\r\n" protocol error\n", tmr_req->exp_data_sn,\r\nref_cmd->acked_data_sn);\r\nreturn -1;\r\n}\r\nreturn iscsit_task_reassign_prepare_read(tmr_req, conn);\r\n}\r\nif (ref_cmd->data_direction == DMA_TO_DEVICE) {\r\nif (tmr_req->exp_data_sn > ref_cmd->r2t_sn) {\r\npr_err("Received ExpDataSN: 0x%08x for WRITE"\r\n" in TMR TASK_REASSIGN greater than command's"\r\n" R2TSN: 0x%08x.\n", tmr_req->exp_data_sn,\r\nref_cmd->r2t_sn);\r\nreturn -1;\r\n}\r\nreturn iscsit_task_reassign_prepare_write(tmr_req, conn);\r\n}\r\npr_err("Unknown iSCSI data_direction: 0x%02x\n",\r\nref_cmd->data_direction);\r\nreturn -1;\r\n}

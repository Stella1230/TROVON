static int ap806_syscon_clk_probe(struct platform_device *pdev)\r\n{\r\nunsigned int freq_mode, cpuclk_freq;\r\nconst char *name, *fixedclk_name;\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct regmap *regmap;\r\nu32 reg;\r\nint ret;\r\nregmap = syscon_node_to_regmap(np);\r\nif (IS_ERR(regmap)) {\r\ndev_err(&pdev->dev, "cannot get regmap\n");\r\nreturn PTR_ERR(regmap);\r\n}\r\nret = regmap_read(regmap, AP806_SAR_REG, &reg);\r\nif (ret) {\r\ndev_err(&pdev->dev, "cannot read from regmap\n");\r\nreturn ret;\r\n}\r\nfreq_mode = reg & AP806_SAR_CLKFREQ_MODE_MASK;\r\nswitch (freq_mode) {\r\ncase 0x0 ... 0x5:\r\ncpuclk_freq = 2000;\r\nbreak;\r\ncase 0x6 ... 0xB:\r\ncpuclk_freq = 1800;\r\nbreak;\r\ncase 0xC ... 0x11:\r\ncpuclk_freq = 1600;\r\nbreak;\r\ncase 0x12 ... 0x16:\r\ncpuclk_freq = 1400;\r\nbreak;\r\ncase 0x17 ... 0x19:\r\ncpuclk_freq = 1300;\r\nbreak;\r\ndefault:\r\ndev_err(&pdev->dev, "invalid SAR value\n");\r\nreturn -EINVAL;\r\n}\r\ncpuclk_freq *= 1000 * 1000;\r\nof_property_read_string_index(np, "clock-output-names",\r\n0, &name);\r\nap806_clks[0] = clk_register_fixed_rate(&pdev->dev, name, NULL,\r\n0, cpuclk_freq);\r\nif (IS_ERR(ap806_clks[0])) {\r\nret = PTR_ERR(ap806_clks[0]);\r\ngoto fail0;\r\n}\r\nof_property_read_string_index(np, "clock-output-names",\r\n1, &name);\r\nap806_clks[1] = clk_register_fixed_rate(&pdev->dev, name, NULL, 0,\r\ncpuclk_freq);\r\nif (IS_ERR(ap806_clks[1])) {\r\nret = PTR_ERR(ap806_clks[1]);\r\ngoto fail1;\r\n}\r\nof_property_read_string_index(np, "clock-output-names",\r\n2, &fixedclk_name);\r\nap806_clks[2] = clk_register_fixed_rate(&pdev->dev, fixedclk_name, NULL,\r\n0, 1200 * 1000 * 1000);\r\nif (IS_ERR(ap806_clks[2])) {\r\nret = PTR_ERR(ap806_clks[2]);\r\ngoto fail2;\r\n}\r\nof_property_read_string_index(np, "clock-output-names",\r\n3, &name);\r\nap806_clks[3] = clk_register_fixed_factor(NULL, name, fixedclk_name,\r\n0, 1, 6);\r\nif (IS_ERR(ap806_clks[3])) {\r\nret = PTR_ERR(ap806_clks[3]);\r\ngoto fail3;\r\n}\r\nret = of_clk_add_provider(np, of_clk_src_onecell_get, &ap806_clk_data);\r\nif (ret)\r\ngoto fail_clk_add;\r\nreturn 0;\r\nfail_clk_add:\r\nclk_unregister_fixed_factor(ap806_clks[3]);\r\nfail3:\r\nclk_unregister_fixed_rate(ap806_clks[2]);\r\nfail2:\r\nclk_unregister_fixed_rate(ap806_clks[1]);\r\nfail1:\r\nclk_unregister_fixed_rate(ap806_clks[0]);\r\nfail0:\r\nreturn ret;\r\n}\r\nstatic int ap806_syscon_clk_remove(struct platform_device *pdev)\r\n{\r\nof_clk_del_provider(pdev->dev.of_node);\r\nclk_unregister_fixed_factor(ap806_clks[3]);\r\nclk_unregister_fixed_rate(ap806_clks[2]);\r\nclk_unregister_fixed_rate(ap806_clks[1]);\r\nclk_unregister_fixed_rate(ap806_clks[0]);\r\nreturn 0;\r\n}

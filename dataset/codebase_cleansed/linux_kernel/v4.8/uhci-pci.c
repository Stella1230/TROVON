static void uhci_pci_reset_hc(struct uhci_hcd *uhci)\r\n{\r\nuhci_reset_hc(to_pci_dev(uhci_dev(uhci)), uhci->io_addr);\r\n}\r\nstatic int uhci_pci_check_and_reset_hc(struct uhci_hcd *uhci)\r\n{\r\nreturn uhci_check_and_reset_hc(to_pci_dev(uhci_dev(uhci)),\r\nuhci->io_addr);\r\n}\r\nstatic void uhci_pci_configure_hc(struct uhci_hcd *uhci)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(uhci_dev(uhci));\r\npci_write_config_word(pdev, USBLEGSUP, USBLEGSUP_DEFAULT);\r\nif (pdev->vendor == PCI_VENDOR_ID_INTEL)\r\npci_write_config_byte(pdev, USBRES_INTEL, 0);\r\n}\r\nstatic int uhci_pci_resume_detect_interrupts_are_broken(struct uhci_hcd *uhci)\r\n{\r\nint port;\r\nswitch (to_pci_dev(uhci_dev(uhci))->vendor) {\r\ndefault:\r\nbreak;\r\ncase PCI_VENDOR_ID_GENESYS:\r\nreturn 1;\r\ncase PCI_VENDOR_ID_INTEL:\r\nfor (port = 0; port < uhci->rh_numports; ++port) {\r\nif (inw(uhci->io_addr + USBPORTSC1 + port * 2) &\r\nUSBPORTSC_OC)\r\nreturn 1;\r\n}\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int uhci_pci_global_suspend_mode_is_broken(struct uhci_hcd *uhci)\r\n{\r\nint port;\r\nconst char *sys_info;\r\nstatic const char bad_Asus_board[] = "A7V8X";\r\nsys_info = dmi_get_system_info(DMI_BOARD_NAME);\r\nif (sys_info && !strcmp(sys_info, bad_Asus_board)) {\r\nfor (port = 0; port < uhci->rh_numports; ++port) {\r\nif (inw(uhci->io_addr + USBPORTSC1 + port * 2) &\r\nUSBPORTSC_CCS)\r\nreturn 1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int uhci_pci_init(struct usb_hcd *hcd)\r\n{\r\nstruct uhci_hcd *uhci = hcd_to_uhci(hcd);\r\nuhci->io_addr = (unsigned long) hcd->rsrc_start;\r\nuhci->rh_numports = uhci_count_ports(hcd);\r\nif (to_pci_dev(uhci_dev(uhci))->vendor == PCI_VENDOR_ID_VIA)\r\nuhci->oc_low = 1;\r\nif (to_pci_dev(uhci_dev(uhci))->vendor == PCI_VENDOR_ID_HP)\r\nuhci->wait_for_hp = 1;\r\nuhci->reset_hc = uhci_pci_reset_hc;\r\nuhci->check_and_reset_hc = uhci_pci_check_and_reset_hc;\r\nuhci->configure_hc = uhci_pci_configure_hc;\r\nuhci->resume_detect_interrupts_are_broken =\r\nuhci_pci_resume_detect_interrupts_are_broken;\r\nuhci->global_suspend_mode_is_broken =\r\nuhci_pci_global_suspend_mode_is_broken;\r\ncheck_and_reset_hc(uhci);\r\nreturn 0;\r\n}\r\nstatic void uhci_shutdown(struct pci_dev *pdev)\r\n{\r\nstruct usb_hcd *hcd = pci_get_drvdata(pdev);\r\nuhci_hc_died(hcd_to_uhci(hcd));\r\n}\r\nstatic int uhci_pci_suspend(struct usb_hcd *hcd, bool do_wakeup)\r\n{\r\nstruct uhci_hcd *uhci = hcd_to_uhci(hcd);\r\nstruct pci_dev *pdev = to_pci_dev(uhci_dev(uhci));\r\nint rc = 0;\r\ndev_dbg(uhci_dev(uhci), "%s\n", __func__);\r\nspin_lock_irq(&uhci->lock);\r\nif (!HCD_HW_ACCESSIBLE(hcd) || uhci->dead)\r\ngoto done_okay;\r\npci_write_config_word(pdev, USBLEGSUP, 0);\r\nclear_bit(HCD_FLAG_POLL_RH, &hcd->flags);\r\nif (do_wakeup) {\r\nif (pdev->vendor == PCI_VENDOR_ID_INTEL)\r\npci_write_config_byte(pdev, USBRES_INTEL,\r\nUSBPORT1EN | USBPORT2EN);\r\n}\r\ndone_okay:\r\nclear_bit(HCD_FLAG_HW_ACCESSIBLE, &hcd->flags);\r\nspin_unlock_irq(&uhci->lock);\r\nsynchronize_irq(hcd->irq);\r\nif (do_wakeup && HCD_WAKEUP_PENDING(hcd)) {\r\nuhci_pci_resume(hcd, false);\r\nrc = -EBUSY;\r\n}\r\nreturn rc;\r\n}\r\nstatic int uhci_pci_resume(struct usb_hcd *hcd, bool hibernated)\r\n{\r\nstruct uhci_hcd *uhci = hcd_to_uhci(hcd);\r\ndev_dbg(uhci_dev(uhci), "%s\n", __func__);\r\nset_bit(HCD_FLAG_HW_ACCESSIBLE, &hcd->flags);\r\nspin_lock_irq(&uhci->lock);\r\nif (hibernated) {\r\nuhci->reset_hc(uhci);\r\nfinish_reset(uhci);\r\n}\r\nelse {\r\ncheck_and_reset_hc(uhci);\r\n}\r\nconfigure_hc(uhci);\r\nif (uhci->rh_state == UHCI_RH_RESET)\r\nusb_root_hub_lost_power(hcd->self.root_hub);\r\nspin_unlock_irq(&uhci->lock);\r\nif (!uhci->RD_enable && hcd->self.root_hub->do_remote_wakeup)\r\nset_bit(HCD_FLAG_POLL_RH, &hcd->flags);\r\nusb_hcd_poll_rh_status(hcd);\r\nreturn 0;\r\n}

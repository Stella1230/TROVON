static ssize_t nr_addr_cmp_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nval = drvdata->nr_addr_cmp;\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t nr_cntr_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{ unsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nval = drvdata->nr_cntr;\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t nr_ctxid_cmp_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nval = drvdata->nr_ctxid_cmp;\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t etmsr_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned long flags, val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\npm_runtime_get_sync(drvdata->dev);\r\nspin_lock_irqsave(&drvdata->spinlock, flags);\r\nCS_UNLOCK(drvdata->base);\r\nval = etm_readl(drvdata, ETMSR);\r\nCS_LOCK(drvdata->base);\r\nspin_unlock_irqrestore(&drvdata->spinlock, flags);\r\npm_runtime_put(drvdata->dev);\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t reset_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nint i, ret;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nret = kstrtoul(buf, 16, &val);\r\nif (ret)\r\nreturn ret;\r\nif (val) {\r\nspin_lock(&drvdata->spinlock);\r\nmemset(config, 0, sizeof(struct etm_config));\r\nconfig->mode = ETM_MODE_EXCLUDE;\r\nconfig->trigger_event = ETM_DEFAULT_EVENT_VAL;\r\nfor (i = 0; i < drvdata->nr_addr_cmp; i++) {\r\nconfig->addr_type[i] = ETM_ADDR_TYPE_NONE;\r\n}\r\netm_set_default(config);\r\nspin_unlock(&drvdata->spinlock);\r\n}\r\nreturn size;\r\n}\r\nstatic ssize_t mode_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nval = config->mode;\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t mode_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nint ret;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nret = kstrtoul(buf, 16, &val);\r\nif (ret)\r\nreturn ret;\r\nspin_lock(&drvdata->spinlock);\r\nconfig->mode = val & ETM_MODE_ALL;\r\nif (config->mode & ETM_MODE_EXCLUDE)\r\nconfig->enable_ctrl1 |= ETMTECR1_INC_EXC;\r\nelse\r\nconfig->enable_ctrl1 &= ~ETMTECR1_INC_EXC;\r\nif (config->mode & ETM_MODE_CYCACC)\r\nconfig->ctrl |= ETMCR_CYC_ACC;\r\nelse\r\nconfig->ctrl &= ~ETMCR_CYC_ACC;\r\nif (config->mode & ETM_MODE_STALL) {\r\nif (!(drvdata->etmccr & ETMCCR_FIFOFULL)) {\r\ndev_warn(drvdata->dev, "stall mode not supported\n");\r\nret = -EINVAL;\r\ngoto err_unlock;\r\n}\r\nconfig->ctrl |= ETMCR_STALL_MODE;\r\n} else\r\nconfig->ctrl &= ~ETMCR_STALL_MODE;\r\nif (config->mode & ETM_MODE_TIMESTAMP) {\r\nif (!(drvdata->etmccer & ETMCCER_TIMESTAMP)) {\r\ndev_warn(drvdata->dev, "timestamp not supported\n");\r\nret = -EINVAL;\r\ngoto err_unlock;\r\n}\r\nconfig->ctrl |= ETMCR_TIMESTAMP_EN;\r\n} else\r\nconfig->ctrl &= ~ETMCR_TIMESTAMP_EN;\r\nif (config->mode & ETM_MODE_CTXID)\r\nconfig->ctrl |= ETMCR_CTXID_SIZE;\r\nelse\r\nconfig->ctrl &= ~ETMCR_CTXID_SIZE;\r\nif (config->mode & (ETM_MODE_EXCL_KERN | ETM_MODE_EXCL_USER))\r\netm_config_trace_mode(config);\r\nspin_unlock(&drvdata->spinlock);\r\nreturn size;\r\nerr_unlock:\r\nspin_unlock(&drvdata->spinlock);\r\nreturn ret;\r\n}\r\nstatic ssize_t trigger_event_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nval = config->trigger_event;\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t trigger_event_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nint ret;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nret = kstrtoul(buf, 16, &val);\r\nif (ret)\r\nreturn ret;\r\nconfig->trigger_event = val & ETM_EVENT_MASK;\r\nreturn size;\r\n}\r\nstatic ssize_t enable_event_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nval = config->enable_event;\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t enable_event_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nint ret;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nret = kstrtoul(buf, 16, &val);\r\nif (ret)\r\nreturn ret;\r\nconfig->enable_event = val & ETM_EVENT_MASK;\r\nreturn size;\r\n}\r\nstatic ssize_t fifofull_level_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nval = config->fifofull_level;\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t fifofull_level_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nint ret;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nret = kstrtoul(buf, 16, &val);\r\nif (ret)\r\nreturn ret;\r\nconfig->fifofull_level = val;\r\nreturn size;\r\n}\r\nstatic ssize_t addr_idx_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nval = config->addr_idx;\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t addr_idx_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nint ret;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nret = kstrtoul(buf, 16, &val);\r\nif (ret)\r\nreturn ret;\r\nif (val >= drvdata->nr_addr_cmp)\r\nreturn -EINVAL;\r\nspin_lock(&drvdata->spinlock);\r\nconfig->addr_idx = val;\r\nspin_unlock(&drvdata->spinlock);\r\nreturn size;\r\n}\r\nstatic ssize_t addr_single_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nu8 idx;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nspin_lock(&drvdata->spinlock);\r\nidx = config->addr_idx;\r\nif (!(config->addr_type[idx] == ETM_ADDR_TYPE_NONE ||\r\nconfig->addr_type[idx] == ETM_ADDR_TYPE_SINGLE)) {\r\nspin_unlock(&drvdata->spinlock);\r\nreturn -EINVAL;\r\n}\r\nval = config->addr_val[idx];\r\nspin_unlock(&drvdata->spinlock);\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t addr_single_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nu8 idx;\r\nint ret;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nret = kstrtoul(buf, 16, &val);\r\nif (ret)\r\nreturn ret;\r\nspin_lock(&drvdata->spinlock);\r\nidx = config->addr_idx;\r\nif (!(config->addr_type[idx] == ETM_ADDR_TYPE_NONE ||\r\nconfig->addr_type[idx] == ETM_ADDR_TYPE_SINGLE)) {\r\nspin_unlock(&drvdata->spinlock);\r\nreturn -EINVAL;\r\n}\r\nconfig->addr_val[idx] = val;\r\nconfig->addr_type[idx] = ETM_ADDR_TYPE_SINGLE;\r\nspin_unlock(&drvdata->spinlock);\r\nreturn size;\r\n}\r\nstatic ssize_t addr_range_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nu8 idx;\r\nunsigned long val1, val2;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nspin_lock(&drvdata->spinlock);\r\nidx = config->addr_idx;\r\nif (idx % 2 != 0) {\r\nspin_unlock(&drvdata->spinlock);\r\nreturn -EPERM;\r\n}\r\nif (!((config->addr_type[idx] == ETM_ADDR_TYPE_NONE &&\r\nconfig->addr_type[idx + 1] == ETM_ADDR_TYPE_NONE) ||\r\n(config->addr_type[idx] == ETM_ADDR_TYPE_RANGE &&\r\nconfig->addr_type[idx + 1] == ETM_ADDR_TYPE_RANGE))) {\r\nspin_unlock(&drvdata->spinlock);\r\nreturn -EPERM;\r\n}\r\nval1 = config->addr_val[idx];\r\nval2 = config->addr_val[idx + 1];\r\nspin_unlock(&drvdata->spinlock);\r\nreturn sprintf(buf, "%#lx %#lx\n", val1, val2);\r\n}\r\nstatic ssize_t addr_range_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nu8 idx;\r\nunsigned long val1, val2;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nif (sscanf(buf, "%lx %lx", &val1, &val2) != 2)\r\nreturn -EINVAL;\r\nif (val1 > val2)\r\nreturn -EINVAL;\r\nspin_lock(&drvdata->spinlock);\r\nidx = config->addr_idx;\r\nif (idx % 2 != 0) {\r\nspin_unlock(&drvdata->spinlock);\r\nreturn -EPERM;\r\n}\r\nif (!((config->addr_type[idx] == ETM_ADDR_TYPE_NONE &&\r\nconfig->addr_type[idx + 1] == ETM_ADDR_TYPE_NONE) ||\r\n(config->addr_type[idx] == ETM_ADDR_TYPE_RANGE &&\r\nconfig->addr_type[idx + 1] == ETM_ADDR_TYPE_RANGE))) {\r\nspin_unlock(&drvdata->spinlock);\r\nreturn -EPERM;\r\n}\r\nconfig->addr_val[idx] = val1;\r\nconfig->addr_type[idx] = ETM_ADDR_TYPE_RANGE;\r\nconfig->addr_val[idx + 1] = val2;\r\nconfig->addr_type[idx + 1] = ETM_ADDR_TYPE_RANGE;\r\nconfig->enable_ctrl1 |= (1 << (idx/2));\r\nspin_unlock(&drvdata->spinlock);\r\nreturn size;\r\n}\r\nstatic ssize_t addr_start_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nu8 idx;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nspin_lock(&drvdata->spinlock);\r\nidx = config->addr_idx;\r\nif (!(config->addr_type[idx] == ETM_ADDR_TYPE_NONE ||\r\nconfig->addr_type[idx] == ETM_ADDR_TYPE_START)) {\r\nspin_unlock(&drvdata->spinlock);\r\nreturn -EPERM;\r\n}\r\nval = config->addr_val[idx];\r\nspin_unlock(&drvdata->spinlock);\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t addr_start_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nu8 idx;\r\nint ret;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nret = kstrtoul(buf, 16, &val);\r\nif (ret)\r\nreturn ret;\r\nspin_lock(&drvdata->spinlock);\r\nidx = config->addr_idx;\r\nif (!(config->addr_type[idx] == ETM_ADDR_TYPE_NONE ||\r\nconfig->addr_type[idx] == ETM_ADDR_TYPE_START)) {\r\nspin_unlock(&drvdata->spinlock);\r\nreturn -EPERM;\r\n}\r\nconfig->addr_val[idx] = val;\r\nconfig->addr_type[idx] = ETM_ADDR_TYPE_START;\r\nconfig->startstop_ctrl |= (1 << idx);\r\nconfig->enable_ctrl1 |= BIT(25);\r\nspin_unlock(&drvdata->spinlock);\r\nreturn size;\r\n}\r\nstatic ssize_t addr_stop_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nu8 idx;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nspin_lock(&drvdata->spinlock);\r\nidx = config->addr_idx;\r\nif (!(config->addr_type[idx] == ETM_ADDR_TYPE_NONE ||\r\nconfig->addr_type[idx] == ETM_ADDR_TYPE_STOP)) {\r\nspin_unlock(&drvdata->spinlock);\r\nreturn -EPERM;\r\n}\r\nval = config->addr_val[idx];\r\nspin_unlock(&drvdata->spinlock);\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t addr_stop_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nu8 idx;\r\nint ret;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nret = kstrtoul(buf, 16, &val);\r\nif (ret)\r\nreturn ret;\r\nspin_lock(&drvdata->spinlock);\r\nidx = config->addr_idx;\r\nif (!(config->addr_type[idx] == ETM_ADDR_TYPE_NONE ||\r\nconfig->addr_type[idx] == ETM_ADDR_TYPE_STOP)) {\r\nspin_unlock(&drvdata->spinlock);\r\nreturn -EPERM;\r\n}\r\nconfig->addr_val[idx] = val;\r\nconfig->addr_type[idx] = ETM_ADDR_TYPE_STOP;\r\nconfig->startstop_ctrl |= (1 << (idx + 16));\r\nconfig->enable_ctrl1 |= ETMTECR1_START_STOP;\r\nspin_unlock(&drvdata->spinlock);\r\nreturn size;\r\n}\r\nstatic ssize_t addr_acctype_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nspin_lock(&drvdata->spinlock);\r\nval = config->addr_acctype[config->addr_idx];\r\nspin_unlock(&drvdata->spinlock);\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t addr_acctype_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nint ret;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nret = kstrtoul(buf, 16, &val);\r\nif (ret)\r\nreturn ret;\r\nspin_lock(&drvdata->spinlock);\r\nconfig->addr_acctype[config->addr_idx] = val;\r\nspin_unlock(&drvdata->spinlock);\r\nreturn size;\r\n}\r\nstatic ssize_t cntr_idx_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nval = config->cntr_idx;\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t cntr_idx_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nint ret;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nret = kstrtoul(buf, 16, &val);\r\nif (ret)\r\nreturn ret;\r\nif (val >= drvdata->nr_cntr)\r\nreturn -EINVAL;\r\nspin_lock(&drvdata->spinlock);\r\nconfig->cntr_idx = val;\r\nspin_unlock(&drvdata->spinlock);\r\nreturn size;\r\n}\r\nstatic ssize_t cntr_rld_val_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nspin_lock(&drvdata->spinlock);\r\nval = config->cntr_rld_val[config->cntr_idx];\r\nspin_unlock(&drvdata->spinlock);\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t cntr_rld_val_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nint ret;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nret = kstrtoul(buf, 16, &val);\r\nif (ret)\r\nreturn ret;\r\nspin_lock(&drvdata->spinlock);\r\nconfig->cntr_rld_val[config->cntr_idx] = val;\r\nspin_unlock(&drvdata->spinlock);\r\nreturn size;\r\n}\r\nstatic ssize_t cntr_event_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nspin_lock(&drvdata->spinlock);\r\nval = config->cntr_event[config->cntr_idx];\r\nspin_unlock(&drvdata->spinlock);\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t cntr_event_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nint ret;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nret = kstrtoul(buf, 16, &val);\r\nif (ret)\r\nreturn ret;\r\nspin_lock(&drvdata->spinlock);\r\nconfig->cntr_event[config->cntr_idx] = val & ETM_EVENT_MASK;\r\nspin_unlock(&drvdata->spinlock);\r\nreturn size;\r\n}\r\nstatic ssize_t cntr_rld_event_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nspin_lock(&drvdata->spinlock);\r\nval = config->cntr_rld_event[config->cntr_idx];\r\nspin_unlock(&drvdata->spinlock);\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t cntr_rld_event_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nint ret;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nret = kstrtoul(buf, 16, &val);\r\nif (ret)\r\nreturn ret;\r\nspin_lock(&drvdata->spinlock);\r\nconfig->cntr_rld_event[config->cntr_idx] = val & ETM_EVENT_MASK;\r\nspin_unlock(&drvdata->spinlock);\r\nreturn size;\r\n}\r\nstatic ssize_t cntr_val_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nint i, ret = 0;\r\nu32 val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nif (!local_read(&drvdata->mode)) {\r\nspin_lock(&drvdata->spinlock);\r\nfor (i = 0; i < drvdata->nr_cntr; i++)\r\nret += sprintf(buf, "counter %d: %x\n",\r\ni, config->cntr_val[i]);\r\nspin_unlock(&drvdata->spinlock);\r\nreturn ret;\r\n}\r\nfor (i = 0; i < drvdata->nr_cntr; i++) {\r\nval = etm_readl(drvdata, ETMCNTVRn(i));\r\nret += sprintf(buf, "counter %d: %x\n", i, val);\r\n}\r\nreturn ret;\r\n}\r\nstatic ssize_t cntr_val_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nint ret;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nret = kstrtoul(buf, 16, &val);\r\nif (ret)\r\nreturn ret;\r\nspin_lock(&drvdata->spinlock);\r\nconfig->cntr_val[config->cntr_idx] = val;\r\nspin_unlock(&drvdata->spinlock);\r\nreturn size;\r\n}\r\nstatic ssize_t seq_12_event_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nval = config->seq_12_event;\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t seq_12_event_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nint ret;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nret = kstrtoul(buf, 16, &val);\r\nif (ret)\r\nreturn ret;\r\nconfig->seq_12_event = val & ETM_EVENT_MASK;\r\nreturn size;\r\n}\r\nstatic ssize_t seq_21_event_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nval = config->seq_21_event;\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t seq_21_event_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nint ret;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nret = kstrtoul(buf, 16, &val);\r\nif (ret)\r\nreturn ret;\r\nconfig->seq_21_event = val & ETM_EVENT_MASK;\r\nreturn size;\r\n}\r\nstatic ssize_t seq_23_event_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nval = config->seq_23_event;\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t seq_23_event_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nint ret;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nret = kstrtoul(buf, 16, &val);\r\nif (ret)\r\nreturn ret;\r\nconfig->seq_23_event = val & ETM_EVENT_MASK;\r\nreturn size;\r\n}\r\nstatic ssize_t seq_31_event_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nval = config->seq_31_event;\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t seq_31_event_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nint ret;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nret = kstrtoul(buf, 16, &val);\r\nif (ret)\r\nreturn ret;\r\nconfig->seq_31_event = val & ETM_EVENT_MASK;\r\nreturn size;\r\n}\r\nstatic ssize_t seq_32_event_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nval = config->seq_32_event;\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t seq_32_event_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nint ret;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nret = kstrtoul(buf, 16, &val);\r\nif (ret)\r\nreturn ret;\r\nconfig->seq_32_event = val & ETM_EVENT_MASK;\r\nreturn size;\r\n}\r\nstatic ssize_t seq_13_event_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nval = config->seq_13_event;\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t seq_13_event_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nint ret;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nret = kstrtoul(buf, 16, &val);\r\nif (ret)\r\nreturn ret;\r\nconfig->seq_13_event = val & ETM_EVENT_MASK;\r\nreturn size;\r\n}\r\nstatic ssize_t seq_curr_state_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned long val, flags;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nif (!local_read(&drvdata->mode)) {\r\nval = config->seq_curr_state;\r\ngoto out;\r\n}\r\npm_runtime_get_sync(drvdata->dev);\r\nspin_lock_irqsave(&drvdata->spinlock, flags);\r\nCS_UNLOCK(drvdata->base);\r\nval = (etm_readl(drvdata, ETMSQR) & ETM_SQR_MASK);\r\nCS_LOCK(drvdata->base);\r\nspin_unlock_irqrestore(&drvdata->spinlock, flags);\r\npm_runtime_put(drvdata->dev);\r\nout:\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t seq_curr_state_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nint ret;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nret = kstrtoul(buf, 16, &val);\r\nif (ret)\r\nreturn ret;\r\nif (val > ETM_SEQ_STATE_MAX_VAL)\r\nreturn -EINVAL;\r\nconfig->seq_curr_state = val;\r\nreturn size;\r\n}\r\nstatic ssize_t ctxid_idx_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nval = config->ctxid_idx;\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t ctxid_idx_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nint ret;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nret = kstrtoul(buf, 16, &val);\r\nif (ret)\r\nreturn ret;\r\nif (val >= drvdata->nr_ctxid_cmp)\r\nreturn -EINVAL;\r\nspin_lock(&drvdata->spinlock);\r\nconfig->ctxid_idx = val;\r\nspin_unlock(&drvdata->spinlock);\r\nreturn size;\r\n}\r\nstatic ssize_t ctxid_pid_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nspin_lock(&drvdata->spinlock);\r\nval = config->ctxid_vpid[config->ctxid_idx];\r\nspin_unlock(&drvdata->spinlock);\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t ctxid_pid_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nint ret;\r\nunsigned long vpid, pid;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nret = kstrtoul(buf, 16, &vpid);\r\nif (ret)\r\nreturn ret;\r\npid = coresight_vpid_to_pid(vpid);\r\nspin_lock(&drvdata->spinlock);\r\nconfig->ctxid_pid[config->ctxid_idx] = pid;\r\nconfig->ctxid_vpid[config->ctxid_idx] = vpid;\r\nspin_unlock(&drvdata->spinlock);\r\nreturn size;\r\n}\r\nstatic ssize_t ctxid_mask_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nval = config->ctxid_mask;\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t ctxid_mask_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nint ret;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nret = kstrtoul(buf, 16, &val);\r\nif (ret)\r\nreturn ret;\r\nconfig->ctxid_mask = val;\r\nreturn size;\r\n}\r\nstatic ssize_t sync_freq_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nval = config->sync_freq;\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t sync_freq_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nint ret;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nret = kstrtoul(buf, 16, &val);\r\nif (ret)\r\nreturn ret;\r\nconfig->sync_freq = val & ETM_SYNC_MASK;\r\nreturn size;\r\n}\r\nstatic ssize_t timestamp_event_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nval = config->timestamp_event;\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t timestamp_event_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nint ret;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nstruct etm_config *config = &drvdata->config;\r\nret = kstrtoul(buf, 16, &val);\r\nif (ret)\r\nreturn ret;\r\nconfig->timestamp_event = val & ETM_EVENT_MASK;\r\nreturn size;\r\n}\r\nstatic ssize_t cpu_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nint val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nval = drvdata->cpu;\r\nreturn scnprintf(buf, PAGE_SIZE, "%d\n", val);\r\n}\r\nstatic ssize_t traceid_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nval = etm_get_trace_id(drvdata);\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t traceid_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nint ret;\r\nunsigned long val;\r\nstruct etm_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nret = kstrtoul(buf, 16, &val);\r\nif (ret)\r\nreturn ret;\r\ndrvdata->traceid = val & ETM_TRACEID_MASK;\r\nreturn size;\r\n}

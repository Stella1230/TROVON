static int\r\nserial_card_probe(struct expansion_card *ec, const struct ecard_id *id)\r\n{\r\nstruct serial_card_info *info;\r\nstruct serial_card_type *type = id->data;\r\nstruct uart_8250_port uart;\r\nunsigned long bus_addr;\r\nunsigned int i;\r\ninfo = kzalloc(sizeof(struct serial_card_info), GFP_KERNEL);\r\nif (!info)\r\nreturn -ENOMEM;\r\ninfo->num_ports = type->num_ports;\r\nbus_addr = ecard_resource_start(ec, type->type);\r\ninfo->vaddr = ecardm_iomap(ec, type->type, 0, 0);\r\nif (!info->vaddr) {\r\nkfree(info);\r\nreturn -ENOMEM;\r\n}\r\necard_set_drvdata(ec, info);\r\nmemset(&uart, 0, sizeof(struct uart_8250_port));\r\nuart.port.irq = ec->irq;\r\nuart.port.flags = UPF_BOOT_AUTOCONF | UPF_SHARE_IRQ;\r\nuart.port.uartclk = type->uartclk;\r\nuart.port.iotype = UPIO_MEM;\r\nuart.port.regshift = 2;\r\nuart.port.dev = &ec->dev;\r\nfor (i = 0; i < info->num_ports; i++) {\r\nuart.port.membase = info->vaddr + type->offset[i];\r\nuart.port.mapbase = bus_addr + type->offset[i];\r\ninfo->ports[i] = serial8250_register_8250_port(&uart);\r\n}\r\nreturn 0;\r\n}\r\nstatic void serial_card_remove(struct expansion_card *ec)\r\n{\r\nstruct serial_card_info *info = ecard_get_drvdata(ec);\r\nint i;\r\necard_set_drvdata(ec, NULL);\r\nfor (i = 0; i < info->num_ports; i++)\r\nif (info->ports[i] > 0)\r\nserial8250_unregister_port(info->ports[i]);\r\nkfree(info);\r\n}\r\nstatic int __init serial_card_init(void)\r\n{\r\nreturn ecard_register_driver(&serial_card_driver);\r\n}\r\nstatic void __exit serial_card_exit(void)\r\n{\r\necard_remove_driver(&serial_card_driver);\r\n}

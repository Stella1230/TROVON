static inline bool\r\nset_ect_ip(struct sk_buff *skb, const struct ipt_ECN_info *einfo)\r\n{\r\nstruct iphdr *iph = ip_hdr(skb);\r\nif ((iph->tos & IPT_ECN_IP_MASK) != (einfo->ip_ect & IPT_ECN_IP_MASK)) {\r\n__u8 oldtos;\r\nif (!skb_make_writable(skb, sizeof(struct iphdr)))\r\nreturn false;\r\niph = ip_hdr(skb);\r\noldtos = iph->tos;\r\niph->tos &= ~IPT_ECN_IP_MASK;\r\niph->tos |= (einfo->ip_ect & IPT_ECN_IP_MASK);\r\ncsum_replace2(&iph->check, htons(oldtos), htons(iph->tos));\r\n}\r\nreturn true;\r\n}\r\nstatic inline bool\r\nset_ect_tcp(struct sk_buff *skb, const struct ipt_ECN_info *einfo)\r\n{\r\nstruct tcphdr _tcph, *tcph;\r\n__be16 oldval;\r\ntcph = skb_header_pointer(skb, ip_hdrlen(skb), sizeof(_tcph), &_tcph);\r\nif (!tcph)\r\nreturn false;\r\nif ((!(einfo->operation & IPT_ECN_OP_SET_ECE) ||\r\ntcph->ece == einfo->proto.tcp.ece) &&\r\n(!(einfo->operation & IPT_ECN_OP_SET_CWR) ||\r\ntcph->cwr == einfo->proto.tcp.cwr))\r\nreturn true;\r\nif (!skb_make_writable(skb, ip_hdrlen(skb) + sizeof(*tcph)))\r\nreturn false;\r\ntcph = (void *)ip_hdr(skb) + ip_hdrlen(skb);\r\noldval = ((__be16 *)tcph)[6];\r\nif (einfo->operation & IPT_ECN_OP_SET_ECE)\r\ntcph->ece = einfo->proto.tcp.ece;\r\nif (einfo->operation & IPT_ECN_OP_SET_CWR)\r\ntcph->cwr = einfo->proto.tcp.cwr;\r\ninet_proto_csum_replace2(&tcph->check, skb,\r\noldval, ((__be16 *)tcph)[6], false);\r\nreturn true;\r\n}\r\nstatic unsigned int\r\necn_tg(struct sk_buff *skb, const struct xt_action_param *par)\r\n{\r\nconst struct ipt_ECN_info *einfo = par->targinfo;\r\nif (einfo->operation & IPT_ECN_OP_SET_IP)\r\nif (!set_ect_ip(skb, einfo))\r\nreturn NF_DROP;\r\nif (einfo->operation & (IPT_ECN_OP_SET_ECE | IPT_ECN_OP_SET_CWR) &&\r\nip_hdr(skb)->protocol == IPPROTO_TCP)\r\nif (!set_ect_tcp(skb, einfo))\r\nreturn NF_DROP;\r\nreturn XT_CONTINUE;\r\n}\r\nstatic int ecn_tg_check(const struct xt_tgchk_param *par)\r\n{\r\nconst struct ipt_ECN_info *einfo = par->targinfo;\r\nconst struct ipt_entry *e = par->entryinfo;\r\nif (einfo->operation & IPT_ECN_OP_MASK) {\r\npr_info("unsupported ECN operation %x\n", einfo->operation);\r\nreturn -EINVAL;\r\n}\r\nif (einfo->ip_ect & ~IPT_ECN_IP_MASK) {\r\npr_info("new ECT codepoint %x out of mask\n", einfo->ip_ect);\r\nreturn -EINVAL;\r\n}\r\nif ((einfo->operation & (IPT_ECN_OP_SET_ECE|IPT_ECN_OP_SET_CWR)) &&\r\n(e->ip.proto != IPPROTO_TCP || (e->ip.invflags & XT_INV_PROTO))) {\r\npr_info("cannot use TCP operations on a non-tcp rule\n");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init ecn_tg_init(void)\r\n{\r\nreturn xt_register_target(&ecn_tg_reg);\r\n}\r\nstatic void __exit ecn_tg_exit(void)\r\n{\r\nxt_unregister_target(&ecn_tg_reg);\r\n}

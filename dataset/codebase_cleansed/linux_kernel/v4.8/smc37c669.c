SMC37c669_CONFIG_REGS * __init SMC37c669_detect( int index )\r\n{\r\nint i;\r\nSMC37c669_DEVICE_ID_REGISTER id;\r\nfor ( i = 0; SMC37c669_Addresses[i] != 0; i++ ) {\r\nSMC37c669 = ( SMC37c669_CONFIG_REGS * )SMC37c669_Addresses[i];\r\nSMC37c669_config_mode( TRUE );\r\nid.as_uchar = SMC37c669_read_config( SMC37c669_DEVICE_ID_INDEX );\r\nSMC37c669_config_mode( FALSE );\r\nif ( id.by_field.device_id == SMC37c669_DEVICE_ID ) {\r\nSMC37c669_irq_table = SMC37c669_irq_tables[ index ];\r\nSMC37c669_drq_table = SMC37c669_default_drq_table;\r\nSMC37c669_config_mode( TRUE );\r\nSMC37c669_init_local_config( );\r\nSMC37c669_config_mode( FALSE );\r\nbreak;\r\n}\r\nelse {\r\nSMC37c669 = NULL;\r\n}\r\n}\r\nreturn SMC37c669;\r\n}\r\nunsigned int __init SMC37c669_enable_device ( unsigned int func )\r\n{\r\nunsigned int ret_val = FALSE;\r\nSMC37c669_config_mode( TRUE );\r\nswitch ( func ) {\r\ncase SERIAL_0:\r\n{\r\nSMC37c669_SERIAL_BASE_ADDRESS_REGISTER base_addr;\r\nSMC37c669_SERIAL_IRQ_REGISTER irq;\r\nirq.as_uchar =\r\nSMC37c669_read_config( SMC37c669_SERIAL_IRQ_INDEX );\r\nirq.by_field.uart1_irq =\r\nSMC37c669_RAW_DEVICE_IRQ(\r\nSMC37c669_xlate_irq( local_config[ func ].irq )\r\n);\r\nSMC37c669_write_config( SMC37c669_SERIAL_IRQ_INDEX, irq.as_uchar );\r\nbase_addr.as_uchar = 0;\r\nbase_addr.by_field.addr9_3 = local_config[ func ].port1 >> 3;\r\nSMC37c669_write_config(\r\nSMC37c669_SERIAL0_BASE_ADDRESS_INDEX,\r\nbase_addr.as_uchar\r\n);\r\nret_val = TRUE;\r\nbreak;\r\n}\r\ncase SERIAL_1:\r\n{\r\nSMC37c669_SERIAL_BASE_ADDRESS_REGISTER base_addr;\r\nSMC37c669_SERIAL_IRQ_REGISTER irq;\r\nirq.as_uchar =\r\nSMC37c669_read_config( SMC37c669_SERIAL_IRQ_INDEX );\r\nirq.by_field.uart2_irq =\r\nSMC37c669_RAW_DEVICE_IRQ(\r\nSMC37c669_xlate_irq( local_config[ func ].irq )\r\n);\r\nSMC37c669_write_config( SMC37c669_SERIAL_IRQ_INDEX, irq.as_uchar );\r\nbase_addr.as_uchar = 0;\r\nbase_addr.by_field.addr9_3 = local_config[ func ].port1 >> 3;\r\nSMC37c669_write_config(\r\nSMC37c669_SERIAL1_BASE_ADDRESS_INDEX,\r\nbase_addr.as_uchar\r\n);\r\nret_val = TRUE;\r\nbreak;\r\n}\r\ncase PARALLEL_0:\r\n{\r\nSMC37c669_PARALLEL_BASE_ADDRESS_REGISTER base_addr;\r\nSMC37c669_PARALLEL_FDC_IRQ_REGISTER irq;\r\nSMC37c669_PARALLEL_FDC_DRQ_REGISTER drq;\r\ndrq.as_uchar =\r\nSMC37c669_read_config( SMC37c669_PARALLEL_FDC_DRQ_INDEX );\r\ndrq.by_field.ppt_drq =\r\nSMC37c669_RAW_DEVICE_DRQ(\r\nSMC37c669_xlate_drq( local_config[ func ].drq )\r\n);\r\nSMC37c669_write_config(\r\nSMC37c669_PARALLEL_FDC_DRQ_INDEX,\r\ndrq.as_uchar\r\n);\r\nirq.as_uchar =\r\nSMC37c669_read_config( SMC37c669_PARALLEL_FDC_IRQ_INDEX );\r\nirq.by_field.ppt_irq =\r\nSMC37c669_RAW_DEVICE_IRQ(\r\nSMC37c669_xlate_irq( local_config[ func ].irq )\r\n);\r\nSMC37c669_write_config(\r\nSMC37c669_PARALLEL_FDC_IRQ_INDEX,\r\nirq.as_uchar\r\n);\r\nbase_addr.as_uchar = 0;\r\nbase_addr.by_field.addr9_2 = local_config[ func ].port1 >> 2;\r\nSMC37c669_write_config(\r\nSMC37c669_PARALLEL0_BASE_ADDRESS_INDEX,\r\nbase_addr.as_uchar\r\n);\r\nret_val = TRUE;\r\nbreak;\r\n}\r\ncase FLOPPY_0:\r\n{\r\nSMC37c669_FDC_BASE_ADDRESS_REGISTER base_addr;\r\nSMC37c669_PARALLEL_FDC_IRQ_REGISTER irq;\r\nSMC37c669_PARALLEL_FDC_DRQ_REGISTER drq;\r\ndrq.as_uchar =\r\nSMC37c669_read_config( SMC37c669_PARALLEL_FDC_DRQ_INDEX );\r\ndrq.by_field.fdc_drq =\r\nSMC37c669_RAW_DEVICE_DRQ(\r\nSMC37c669_xlate_drq( local_config[ func ].drq )\r\n);\r\nSMC37c669_write_config(\r\nSMC37c669_PARALLEL_FDC_DRQ_INDEX,\r\ndrq.as_uchar\r\n);\r\nirq.as_uchar =\r\nSMC37c669_read_config( SMC37c669_PARALLEL_FDC_IRQ_INDEX );\r\nirq.by_field.fdc_irq =\r\nSMC37c669_RAW_DEVICE_IRQ(\r\nSMC37c669_xlate_irq( local_config[ func ].irq )\r\n);\r\nSMC37c669_write_config(\r\nSMC37c669_PARALLEL_FDC_IRQ_INDEX,\r\nirq.as_uchar\r\n);\r\nbase_addr.as_uchar = 0;\r\nbase_addr.by_field.addr9_4 = local_config[ func ].port1 >> 4;\r\nSMC37c669_write_config(\r\nSMC37c669_FDC_BASE_ADDRESS_INDEX,\r\nbase_addr.as_uchar\r\n);\r\nret_val = TRUE;\r\nbreak;\r\n}\r\ncase IDE_0:\r\n{\r\nSMC37c669_IDE_ADDRESS_REGISTER ide_addr;\r\nide_addr.as_uchar = 0;\r\nide_addr.by_field.addr9_4 = local_config[ func ].port2 >> 4;\r\nSMC37c669_write_config(\r\nSMC37c669_IDE_ALTERNATE_ADDRESS_INDEX,\r\nide_addr.as_uchar\r\n);\r\nide_addr.as_uchar = 0;\r\nide_addr.by_field.addr9_4 = local_config[ func ].port1 >> 4;\r\nSMC37c669_write_config(\r\nSMC37c669_IDE_BASE_ADDRESS_INDEX,\r\nide_addr.as_uchar\r\n);\r\nret_val = TRUE;\r\nbreak;\r\n}\r\n}\r\nSMC37c669_config_mode( FALSE );\r\nreturn ret_val;\r\n}\r\nunsigned int __init SMC37c669_disable_device ( unsigned int func )\r\n{\r\nunsigned int ret_val = FALSE;\r\nSMC37c669_config_mode( TRUE );\r\nswitch ( func ) {\r\ncase SERIAL_0:\r\n{\r\nSMC37c669_SERIAL_BASE_ADDRESS_REGISTER base_addr;\r\nSMC37c669_SERIAL_IRQ_REGISTER irq;\r\nirq.as_uchar =\r\nSMC37c669_read_config( SMC37c669_SERIAL_IRQ_INDEX );\r\nirq.by_field.uart1_irq = 0;\r\nSMC37c669_write_config( SMC37c669_SERIAL_IRQ_INDEX, irq.as_uchar );\r\nbase_addr.as_uchar = 0;\r\nSMC37c669_write_config(\r\nSMC37c669_SERIAL0_BASE_ADDRESS_INDEX,\r\nbase_addr.as_uchar\r\n);\r\nret_val = TRUE;\r\nbreak;\r\n}\r\ncase SERIAL_1:\r\n{\r\nSMC37c669_SERIAL_BASE_ADDRESS_REGISTER base_addr;\r\nSMC37c669_SERIAL_IRQ_REGISTER irq;\r\nirq.as_uchar =\r\nSMC37c669_read_config( SMC37c669_SERIAL_IRQ_INDEX );\r\nirq.by_field.uart2_irq = 0;\r\nSMC37c669_write_config( SMC37c669_SERIAL_IRQ_INDEX, irq.as_uchar );\r\nbase_addr.as_uchar = 0;\r\nSMC37c669_write_config(\r\nSMC37c669_SERIAL1_BASE_ADDRESS_INDEX,\r\nbase_addr.as_uchar\r\n);\r\nret_val = TRUE;\r\nbreak;\r\n}\r\ncase PARALLEL_0:\r\n{\r\nSMC37c669_PARALLEL_BASE_ADDRESS_REGISTER base_addr;\r\nSMC37c669_PARALLEL_FDC_IRQ_REGISTER irq;\r\nSMC37c669_PARALLEL_FDC_DRQ_REGISTER drq;\r\ndrq.as_uchar =\r\nSMC37c669_read_config( SMC37c669_PARALLEL_FDC_DRQ_INDEX );\r\ndrq.by_field.ppt_drq = 0;\r\nSMC37c669_write_config(\r\nSMC37c669_PARALLEL_FDC_DRQ_INDEX,\r\ndrq.as_uchar\r\n);\r\nirq.as_uchar =\r\nSMC37c669_read_config( SMC37c669_PARALLEL_FDC_IRQ_INDEX );\r\nirq.by_field.ppt_irq = 0;\r\nSMC37c669_write_config(\r\nSMC37c669_PARALLEL_FDC_IRQ_INDEX,\r\nirq.as_uchar\r\n);\r\nbase_addr.as_uchar = 0;\r\nSMC37c669_write_config(\r\nSMC37c669_PARALLEL0_BASE_ADDRESS_INDEX,\r\nbase_addr.as_uchar\r\n);\r\nret_val = TRUE;\r\nbreak;\r\n}\r\ncase FLOPPY_0:\r\n{\r\nSMC37c669_FDC_BASE_ADDRESS_REGISTER base_addr;\r\nSMC37c669_PARALLEL_FDC_IRQ_REGISTER irq;\r\nSMC37c669_PARALLEL_FDC_DRQ_REGISTER drq;\r\ndrq.as_uchar =\r\nSMC37c669_read_config( SMC37c669_PARALLEL_FDC_DRQ_INDEX );\r\ndrq.by_field.fdc_drq = 0;\r\nSMC37c669_write_config(\r\nSMC37c669_PARALLEL_FDC_DRQ_INDEX,\r\ndrq.as_uchar\r\n);\r\nirq.as_uchar =\r\nSMC37c669_read_config( SMC37c669_PARALLEL_FDC_IRQ_INDEX );\r\nirq.by_field.fdc_irq = 0;\r\nSMC37c669_write_config(\r\nSMC37c669_PARALLEL_FDC_IRQ_INDEX,\r\nirq.as_uchar\r\n);\r\nbase_addr.as_uchar = 0;\r\nSMC37c669_write_config(\r\nSMC37c669_FDC_BASE_ADDRESS_INDEX,\r\nbase_addr.as_uchar\r\n);\r\nret_val = TRUE;\r\nbreak;\r\n}\r\ncase IDE_0:\r\n{\r\nSMC37c669_IDE_ADDRESS_REGISTER ide_addr;\r\nide_addr.as_uchar = 0;\r\nSMC37c669_write_config(\r\nSMC37c669_IDE_ALTERNATE_ADDRESS_INDEX,\r\nide_addr.as_uchar\r\n);\r\nide_addr.as_uchar = 0;\r\nSMC37c669_write_config(\r\nSMC37c669_IDE_BASE_ADDRESS_INDEX,\r\nide_addr.as_uchar\r\n);\r\nret_val = TRUE;\r\nbreak;\r\n}\r\n}\r\nSMC37c669_config_mode( FALSE );\r\nreturn ret_val;\r\n}\r\nunsigned int __init SMC37c669_configure_device (\r\nunsigned int func,\r\nint port,\r\nint irq,\r\nint drq )\r\n{\r\nstruct DEVICE_CONFIG *cp;\r\nif ( ( cp = SMC37c669_get_config ( func ) ) != NULL ) {\r\nif ( ( drq & ~0xFF ) == 0 ) {\r\ncp->drq = drq;\r\n}\r\nif ( ( irq & ~0xFF ) == 0 ) {\r\ncp->irq = irq;\r\n}\r\nif ( ( port & ~0xFFFF ) == 0 ) {\r\ncp->port1 = port;\r\n}\r\nif ( SMC37c669_is_device_enabled( func ) ) {\r\nSMC37c669_enable_device( func );\r\n}\r\nreturn TRUE;\r\n}\r\nreturn FALSE;\r\n}\r\nstatic unsigned int __init SMC37c669_is_device_enabled ( unsigned int func )\r\n{\r\nunsigned char base_addr = 0;\r\nunsigned int dev_ok = FALSE;\r\nunsigned int ret_val = FALSE;\r\nSMC37c669_config_mode( TRUE );\r\nswitch ( func ) {\r\ncase SERIAL_0:\r\nbase_addr =\r\nSMC37c669_read_config( SMC37c669_SERIAL0_BASE_ADDRESS_INDEX );\r\ndev_ok = TRUE;\r\nbreak;\r\ncase SERIAL_1:\r\nbase_addr =\r\nSMC37c669_read_config( SMC37c669_SERIAL1_BASE_ADDRESS_INDEX );\r\ndev_ok = TRUE;\r\nbreak;\r\ncase PARALLEL_0:\r\nbase_addr =\r\nSMC37c669_read_config( SMC37c669_PARALLEL0_BASE_ADDRESS_INDEX );\r\ndev_ok = TRUE;\r\nbreak;\r\ncase FLOPPY_0:\r\nbase_addr =\r\nSMC37c669_read_config( SMC37c669_FDC_BASE_ADDRESS_INDEX );\r\ndev_ok = TRUE;\r\nbreak;\r\ncase IDE_0:\r\nbase_addr =\r\nSMC37c669_read_config( SMC37c669_IDE_BASE_ADDRESS_INDEX );\r\ndev_ok = TRUE;\r\nbreak;\r\n}\r\nif ( ( dev_ok ) && ( ( base_addr & 0xC0 ) != 0 ) ) {\r\nret_val = TRUE;\r\n}\r\nSMC37c669_config_mode( FALSE );\r\nreturn ret_val;\r\n}\r\nvoid __init SMC37c669_display_device_info ( void )\r\n{\r\nif ( SMC37c669_is_device_enabled( SERIAL_0 ) ) {\r\nprintk( " Serial 0: Enabled [ Port 0x%x, IRQ %d ]\n",\r\nlocal_config[ SERIAL_0 ].port1,\r\nlocal_config[ SERIAL_0 ].irq\r\n);\r\n}\r\nelse {\r\nprintk( " Serial 0: Disabled\n" );\r\n}\r\nif ( SMC37c669_is_device_enabled( SERIAL_1 ) ) {\r\nprintk( " Serial 1: Enabled [ Port 0x%x, IRQ %d ]\n",\r\nlocal_config[ SERIAL_1 ].port1,\r\nlocal_config[ SERIAL_1 ].irq\r\n);\r\n}\r\nelse {\r\nprintk( " Serial 1: Disabled\n" );\r\n}\r\nif ( SMC37c669_is_device_enabled( PARALLEL_0 ) ) {\r\nprintk( " Parallel: Enabled [ Port 0x%x, IRQ %d/%d ]\n",\r\nlocal_config[ PARALLEL_0 ].port1,\r\nlocal_config[ PARALLEL_0 ].irq,\r\nlocal_config[ PARALLEL_0 ].drq\r\n);\r\n}\r\nelse {\r\nprintk( " Parallel: Disabled\n" );\r\n}\r\nif ( SMC37c669_is_device_enabled( FLOPPY_0 ) ) {\r\nprintk( " Floppy Ctrl: Enabled [ Port 0x%x, IRQ %d/%d ]\n",\r\nlocal_config[ FLOPPY_0 ].port1,\r\nlocal_config[ FLOPPY_0 ].irq,\r\nlocal_config[ FLOPPY_0 ].drq\r\n);\r\n}\r\nelse {\r\nprintk( " Floppy Ctrl: Disabled\n" );\r\n}\r\nif ( SMC37c669_is_device_enabled( IDE_0 ) ) {\r\nprintk( " IDE 0: Enabled [ Port 0x%x, IRQ %d ]\n",\r\nlocal_config[ IDE_0 ].port1,\r\nlocal_config[ IDE_0 ].irq\r\n);\r\n}\r\nelse {\r\nprintk( " IDE 0: Disabled\n" );\r\n}\r\n}\r\nstatic void __init SMC37c669_config_mode(\r\nunsigned int enable )\r\n{\r\nif ( enable ) {\r\nspin_lock(&smc_lock);\r\nwb( &SMC37c669->index_port, SMC37c669_CONFIG_ON_KEY );\r\nwb( &SMC37c669->index_port, SMC37c669_CONFIG_ON_KEY );\r\nspin_unlock(&smc_lock);\r\n}\r\nelse {\r\nwb( &SMC37c669->index_port, SMC37c669_CONFIG_OFF_KEY );\r\n}\r\n}\r\nstatic unsigned char __init SMC37c669_read_config(\r\nunsigned char index )\r\n{\r\nunsigned char data;\r\nwb( &SMC37c669->index_port, index );\r\ndata = rb( &SMC37c669->data_port );\r\nreturn data;\r\n}\r\nstatic void __init SMC37c669_write_config(\r\nunsigned char index,\r\nunsigned char data )\r\n{\r\nwb( &SMC37c669->index_port, index );\r\nwb( &SMC37c669->data_port, data );\r\n}\r\nstatic void __init SMC37c669_init_local_config ( void )\r\n{\r\nSMC37c669_SERIAL_BASE_ADDRESS_REGISTER uart_base;\r\nSMC37c669_SERIAL_IRQ_REGISTER uart_irqs;\r\nSMC37c669_PARALLEL_BASE_ADDRESS_REGISTER ppt_base;\r\nSMC37c669_PARALLEL_FDC_IRQ_REGISTER ppt_fdc_irqs;\r\nSMC37c669_PARALLEL_FDC_DRQ_REGISTER ppt_fdc_drqs;\r\nSMC37c669_FDC_BASE_ADDRESS_REGISTER fdc_base;\r\nSMC37c669_IDE_ADDRESS_REGISTER ide_base;\r\nSMC37c669_IDE_ADDRESS_REGISTER ide_alt;\r\nuart_base.as_uchar =\r\nSMC37c669_read_config( SMC37c669_SERIAL0_BASE_ADDRESS_INDEX );\r\nuart_irqs.as_uchar =\r\nSMC37c669_read_config( SMC37c669_SERIAL_IRQ_INDEX );\r\nlocal_config[SERIAL_0].port1 = uart_base.by_field.addr9_3 << 3;\r\nlocal_config[SERIAL_0].irq =\r\nSMC37c669_xlate_irq(\r\nSMC37c669_DEVICE_IRQ( uart_irqs.by_field.uart1_irq )\r\n);\r\nuart_base.as_uchar =\r\nSMC37c669_read_config( SMC37c669_SERIAL1_BASE_ADDRESS_INDEX );\r\nlocal_config[SERIAL_1].port1 = uart_base.by_field.addr9_3 << 3;\r\nlocal_config[SERIAL_1].irq =\r\nSMC37c669_xlate_irq(\r\nSMC37c669_DEVICE_IRQ( uart_irqs.by_field.uart2_irq )\r\n);\r\nppt_base.as_uchar =\r\nSMC37c669_read_config( SMC37c669_PARALLEL0_BASE_ADDRESS_INDEX );\r\nppt_fdc_irqs.as_uchar =\r\nSMC37c669_read_config( SMC37c669_PARALLEL_FDC_IRQ_INDEX );\r\nppt_fdc_drqs.as_uchar =\r\nSMC37c669_read_config( SMC37c669_PARALLEL_FDC_DRQ_INDEX );\r\nlocal_config[PARALLEL_0].port1 = ppt_base.by_field.addr9_2 << 2;\r\nlocal_config[PARALLEL_0].irq =\r\nSMC37c669_xlate_irq(\r\nSMC37c669_DEVICE_IRQ( ppt_fdc_irqs.by_field.ppt_irq )\r\n);\r\nlocal_config[PARALLEL_0].drq =\r\nSMC37c669_xlate_drq(\r\nSMC37c669_DEVICE_DRQ( ppt_fdc_drqs.by_field.ppt_drq )\r\n);\r\nfdc_base.as_uchar =\r\nSMC37c669_read_config( SMC37c669_FDC_BASE_ADDRESS_INDEX );\r\nlocal_config[FLOPPY_0].port1 = fdc_base.by_field.addr9_4 << 4;\r\nlocal_config[FLOPPY_0].irq =\r\nSMC37c669_xlate_irq(\r\nSMC37c669_DEVICE_IRQ( ppt_fdc_irqs.by_field.fdc_irq )\r\n);\r\nlocal_config[FLOPPY_0].drq =\r\nSMC37c669_xlate_drq(\r\nSMC37c669_DEVICE_DRQ( ppt_fdc_drqs.by_field.fdc_drq )\r\n);\r\nide_base.as_uchar =\r\nSMC37c669_read_config( SMC37c669_IDE_BASE_ADDRESS_INDEX );\r\nide_alt.as_uchar =\r\nSMC37c669_read_config( SMC37c669_IDE_ALTERNATE_ADDRESS_INDEX );\r\nlocal_config[IDE_0].port1 = ide_base.by_field.addr9_4 << 4;\r\nlocal_config[IDE_0].port2 = ide_alt.by_field.addr9_4 << 4;\r\nlocal_config[IDE_0].irq = 14;\r\n}\r\nstatic struct DEVICE_CONFIG * __init SMC37c669_get_config( unsigned int func )\r\n{\r\nstruct DEVICE_CONFIG *cp = NULL;\r\nswitch ( func ) {\r\ncase SERIAL_0:\r\ncp = &local_config[ SERIAL_0 ];\r\nbreak;\r\ncase SERIAL_1:\r\ncp = &local_config[ SERIAL_1 ];\r\nbreak;\r\ncase PARALLEL_0:\r\ncp = &local_config[ PARALLEL_0 ];\r\nbreak;\r\ncase FLOPPY_0:\r\ncp = &local_config[ FLOPPY_0 ];\r\nbreak;\r\ncase IDE_0:\r\ncp = &local_config[ IDE_0 ];\r\nbreak;\r\n}\r\nreturn cp;\r\n}\r\nstatic int __init SMC37c669_xlate_irq ( int irq )\r\n{\r\nint i, translated_irq = -1;\r\nif ( SMC37c669_IS_DEVICE_IRQ( irq ) ) {\r\nfor ( i = 0; ( SMC37c669_irq_table[i].device_irq != -1 ) || ( SMC37c669_irq_table[i].isa_irq != -1 ); i++ ) {\r\nif ( irq == SMC37c669_irq_table[i].device_irq ) {\r\ntranslated_irq = SMC37c669_irq_table[i].isa_irq;\r\nbreak;\r\n}\r\n}\r\n}\r\nelse {\r\nfor ( i = 0; ( SMC37c669_irq_table[i].isa_irq != -1 ) || ( SMC37c669_irq_table[i].device_irq != -1 ); i++ ) {\r\nif ( irq == SMC37c669_irq_table[i].isa_irq ) {\r\ntranslated_irq = SMC37c669_irq_table[i].device_irq;\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn translated_irq;\r\n}\r\nstatic int __init SMC37c669_xlate_drq ( int drq )\r\n{\r\nint i, translated_drq = -1;\r\nif ( SMC37c669_IS_DEVICE_DRQ( drq ) ) {\r\nfor ( i = 0; ( SMC37c669_drq_table[i].device_drq != -1 ) || ( SMC37c669_drq_table[i].isa_drq != -1 ); i++ ) {\r\nif ( drq == SMC37c669_drq_table[i].device_drq ) {\r\ntranslated_drq = SMC37c669_drq_table[i].isa_drq;\r\nbreak;\r\n}\r\n}\r\n}\r\nelse {\r\nfor ( i = 0; ( SMC37c669_drq_table[i].isa_drq != -1 ) || ( SMC37c669_drq_table[i].device_drq != -1 ); i++ ) {\r\nif ( drq == SMC37c669_drq_table[i].isa_drq ) {\r\ntranslated_drq = SMC37c669_drq_table[i].device_drq;\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn translated_drq;\r\n}\r\nvoid __init\r\nSMC37c669_dump_registers(void)\r\n{\r\nint i;\r\nfor (i = 0; i <= 0x29; i++)\r\nprintk("-- CR%02x : %02x\n", i, SMC37c669_read_config(i));\r\n}\r\nvoid __init SMC669_Init ( int index )\r\n{\r\nSMC37c669_CONFIG_REGS *SMC_base;\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nif ( ( SMC_base = SMC37c669_detect( index ) ) != NULL ) {\r\n#if SMC_DEBUG\r\nSMC37c669_config_mode( TRUE );\r\nSMC37c669_dump_registers( );\r\nSMC37c669_config_mode( FALSE );\r\nSMC37c669_display_device_info( );\r\n#endif\r\nSMC37c669_disable_device( SERIAL_0 );\r\nSMC37c669_configure_device(\r\nSERIAL_0,\r\nCOM1_BASE,\r\nCOM1_IRQ,\r\n-1\r\n);\r\nSMC37c669_enable_device( SERIAL_0 );\r\nSMC37c669_disable_device( SERIAL_1 );\r\nSMC37c669_configure_device(\r\nSERIAL_1,\r\nCOM2_BASE,\r\nCOM2_IRQ,\r\n-1\r\n);\r\nSMC37c669_enable_device( SERIAL_1 );\r\nSMC37c669_disable_device( PARALLEL_0 );\r\nSMC37c669_configure_device(\r\nPARALLEL_0,\r\nPARP_BASE,\r\nPARP_IRQ,\r\nPARP_DRQ\r\n);\r\nSMC37c669_enable_device( PARALLEL_0 );\r\nSMC37c669_disable_device( FLOPPY_0 );\r\nSMC37c669_configure_device(\r\nFLOPPY_0,\r\nFDC_BASE,\r\nFDC_IRQ,\r\nFDC_DRQ\r\n);\r\nSMC37c669_enable_device( FLOPPY_0 );\r\noutb(0xc, 0x3f2);\r\nSMC37c669_disable_device( IDE_0 );\r\n#if SMC_DEBUG\r\nSMC37c669_config_mode( TRUE );\r\nSMC37c669_dump_registers( );\r\nSMC37c669_config_mode( FALSE );\r\nSMC37c669_display_device_info( );\r\n#endif\r\nlocal_irq_restore(flags);\r\nprintk( "SMC37c669 Super I/O Controller found @ 0x%p\n",\r\nSMC_base );\r\n}\r\nelse {\r\nlocal_irq_restore(flags);\r\n#if SMC_DEBUG\r\nprintk( "No SMC37c669 Super I/O Controller found\n" );\r\n#endif\r\n}\r\n}

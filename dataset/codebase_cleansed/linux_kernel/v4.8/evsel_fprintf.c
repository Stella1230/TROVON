static int comma_fprintf(FILE *fp, bool *first, const char *fmt, ...)\r\n{\r\nva_list args;\r\nint ret = 0;\r\nif (!*first) {\r\nret += fprintf(fp, ",");\r\n} else {\r\nret += fprintf(fp, ":");\r\n*first = false;\r\n}\r\nva_start(args, fmt);\r\nret += vfprintf(fp, fmt, args);\r\nva_end(args);\r\nreturn ret;\r\n}\r\nstatic int __print_attr__fprintf(FILE *fp, const char *name, const char *val, void *priv)\r\n{\r\nreturn comma_fprintf(fp, (bool *)priv, " %s: %s", name, val);\r\n}\r\nint perf_evsel__fprintf(struct perf_evsel *evsel,\r\nstruct perf_attr_details *details, FILE *fp)\r\n{\r\nbool first = true;\r\nint printed = 0;\r\nif (details->event_group) {\r\nstruct perf_evsel *pos;\r\nif (!perf_evsel__is_group_leader(evsel))\r\nreturn 0;\r\nif (evsel->nr_members > 1)\r\nprinted += fprintf(fp, "%s{", evsel->group_name ?: "");\r\nprinted += fprintf(fp, "%s", perf_evsel__name(evsel));\r\nfor_each_group_member(pos, evsel)\r\nprinted += fprintf(fp, ",%s", perf_evsel__name(pos));\r\nif (evsel->nr_members > 1)\r\nprinted += fprintf(fp, "}");\r\ngoto out;\r\n}\r\nprinted += fprintf(fp, "%s", perf_evsel__name(evsel));\r\nif (details->verbose) {\r\nprinted += perf_event_attr__fprintf(fp, &evsel->attr,\r\n__print_attr__fprintf, &first);\r\n} else if (details->freq) {\r\nconst char *term = "sample_freq";\r\nif (!evsel->attr.freq)\r\nterm = "sample_period";\r\nprinted += comma_fprintf(fp, &first, " %s=%" PRIu64,\r\nterm, (u64)evsel->attr.sample_freq);\r\n}\r\nif (details->trace_fields) {\r\nstruct format_field *field;\r\nif (evsel->attr.type != PERF_TYPE_TRACEPOINT) {\r\nprinted += comma_fprintf(fp, &first, " (not a tracepoint)");\r\ngoto out;\r\n}\r\nfield = evsel->tp_format->format.fields;\r\nif (field == NULL) {\r\nprinted += comma_fprintf(fp, &first, " (no trace field)");\r\ngoto out;\r\n}\r\nprinted += comma_fprintf(fp, &first, " trace_fields: %s", field->name);\r\nfield = field->next;\r\nwhile (field) {\r\nprinted += comma_fprintf(fp, &first, "%s", field->name);\r\nfield = field->next;\r\n}\r\n}\r\nout:\r\nfputc('\n', fp);\r\nreturn ++printed;\r\n}\r\nint sample__fprintf_callchain(struct perf_sample *sample, int left_alignment,\r\nunsigned int print_opts, struct callchain_cursor *cursor,\r\nFILE *fp)\r\n{\r\nint printed = 0;\r\nstruct callchain_cursor_node *node;\r\nint print_ip = print_opts & EVSEL__PRINT_IP;\r\nint print_sym = print_opts & EVSEL__PRINT_SYM;\r\nint print_dso = print_opts & EVSEL__PRINT_DSO;\r\nint print_symoffset = print_opts & EVSEL__PRINT_SYMOFFSET;\r\nint print_oneline = print_opts & EVSEL__PRINT_ONELINE;\r\nint print_srcline = print_opts & EVSEL__PRINT_SRCLINE;\r\nint print_unknown_as_addr = print_opts & EVSEL__PRINT_UNKNOWN_AS_ADDR;\r\nchar s = print_oneline ? ' ' : '\t';\r\nif (sample->callchain) {\r\nstruct addr_location node_al;\r\ncallchain_cursor_commit(cursor);\r\nwhile (1) {\r\nu64 addr = 0;\r\nnode = callchain_cursor_current(cursor);\r\nif (!node)\r\nbreak;\r\nif (node->sym && node->sym->ignore)\r\ngoto next;\r\nprinted += fprintf(fp, "%-*.*s", left_alignment, left_alignment, " ");\r\nif (print_ip)\r\nprinted += fprintf(fp, "%c%16" PRIx64, s, node->ip);\r\nif (node->map)\r\naddr = node->map->map_ip(node->map, node->ip);\r\nif (print_sym) {\r\nprinted += fprintf(fp, " ");\r\nnode_al.addr = addr;\r\nnode_al.map = node->map;\r\nif (print_symoffset) {\r\nprinted += __symbol__fprintf_symname_offs(node->sym, &node_al,\r\nprint_unknown_as_addr, fp);\r\n} else {\r\nprinted += __symbol__fprintf_symname(node->sym, &node_al,\r\nprint_unknown_as_addr, fp);\r\n}\r\n}\r\nif (print_dso) {\r\nprinted += fprintf(fp, " (");\r\nprinted += map__fprintf_dsoname(node->map, fp);\r\nprinted += fprintf(fp, ")");\r\n}\r\nif (print_srcline)\r\nprinted += map__fprintf_srcline(node->map, addr, "\n ", fp);\r\nif (!print_oneline)\r\nprinted += fprintf(fp, "\n");\r\nnext:\r\ncallchain_cursor_advance(cursor);\r\n}\r\n}\r\nreturn printed;\r\n}\r\nint sample__fprintf_sym(struct perf_sample *sample, struct addr_location *al,\r\nint left_alignment, unsigned int print_opts,\r\nstruct callchain_cursor *cursor, FILE *fp)\r\n{\r\nint printed = 0;\r\nint print_ip = print_opts & EVSEL__PRINT_IP;\r\nint print_sym = print_opts & EVSEL__PRINT_SYM;\r\nint print_dso = print_opts & EVSEL__PRINT_DSO;\r\nint print_symoffset = print_opts & EVSEL__PRINT_SYMOFFSET;\r\nint print_srcline = print_opts & EVSEL__PRINT_SRCLINE;\r\nint print_unknown_as_addr = print_opts & EVSEL__PRINT_UNKNOWN_AS_ADDR;\r\nif (cursor != NULL) {\r\nprinted += sample__fprintf_callchain(sample, left_alignment,\r\nprint_opts, cursor, fp);\r\n} else if (!(al->sym && al->sym->ignore)) {\r\nprinted += fprintf(fp, "%-*.*s", left_alignment, left_alignment, " ");\r\nif (print_ip)\r\nprinted += fprintf(fp, "%16" PRIx64, sample->ip);\r\nif (print_sym) {\r\nprinted += fprintf(fp, " ");\r\nif (print_symoffset) {\r\nprinted += __symbol__fprintf_symname_offs(al->sym, al,\r\nprint_unknown_as_addr, fp);\r\n} else {\r\nprinted += __symbol__fprintf_symname(al->sym, al,\r\nprint_unknown_as_addr, fp);\r\n}\r\n}\r\nif (print_dso) {\r\nprinted += fprintf(fp, " (");\r\nprinted += map__fprintf_dsoname(al->map, fp);\r\nprinted += fprintf(fp, ")");\r\n}\r\nif (print_srcline)\r\nprinted += map__fprintf_srcline(al->map, al->addr, "\n ", fp);\r\n}\r\nreturn printed;\r\n}

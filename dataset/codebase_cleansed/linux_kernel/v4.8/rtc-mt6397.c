static int mtk_rtc_write_trigger(struct mt6397_rtc *rtc)\r\n{\r\nunsigned long timeout = jiffies + HZ;\r\nint ret;\r\nu32 data;\r\nret = regmap_write(rtc->regmap, rtc->addr_base + RTC_WRTGR, 1);\r\nif (ret < 0)\r\nreturn ret;\r\nwhile (1) {\r\nret = regmap_read(rtc->regmap, rtc->addr_base + RTC_BBPU,\r\n&data);\r\nif (ret < 0)\r\nbreak;\r\nif (!(data & RTC_BBPU_CBUSY))\r\nbreak;\r\nif (time_after(jiffies, timeout)) {\r\nret = -ETIMEDOUT;\r\nbreak;\r\n}\r\ncpu_relax();\r\n}\r\nreturn ret;\r\n}\r\nstatic irqreturn_t mtk_rtc_irq_handler_thread(int irq, void *data)\r\n{\r\nstruct mt6397_rtc *rtc = data;\r\nu32 irqsta, irqen;\r\nint ret;\r\nret = regmap_read(rtc->regmap, rtc->addr_base + RTC_IRQ_STA, &irqsta);\r\nif ((ret >= 0) && (irqsta & RTC_IRQ_STA_AL)) {\r\nrtc_update_irq(rtc->rtc_dev, 1, RTC_IRQF | RTC_AF);\r\nirqen = irqsta & ~RTC_IRQ_EN_AL;\r\nmutex_lock(&rtc->lock);\r\nif (regmap_write(rtc->regmap, rtc->addr_base + RTC_IRQ_EN,\r\nirqen) < 0)\r\nmtk_rtc_write_trigger(rtc);\r\nmutex_unlock(&rtc->lock);\r\nreturn IRQ_HANDLED;\r\n}\r\nreturn IRQ_NONE;\r\n}\r\nstatic int __mtk_rtc_read_time(struct mt6397_rtc *rtc,\r\nstruct rtc_time *tm, int *sec)\r\n{\r\nint ret;\r\nu16 data[RTC_OFFSET_COUNT];\r\nmutex_lock(&rtc->lock);\r\nret = regmap_bulk_read(rtc->regmap, rtc->addr_base + RTC_TC_SEC,\r\ndata, RTC_OFFSET_COUNT);\r\nif (ret < 0)\r\ngoto exit;\r\ntm->tm_sec = data[RTC_OFFSET_SEC];\r\ntm->tm_min = data[RTC_OFFSET_MIN];\r\ntm->tm_hour = data[RTC_OFFSET_HOUR];\r\ntm->tm_mday = data[RTC_OFFSET_DOM];\r\ntm->tm_mon = data[RTC_OFFSET_MTH];\r\ntm->tm_year = data[RTC_OFFSET_YEAR];\r\nret = regmap_read(rtc->regmap, rtc->addr_base + RTC_TC_SEC, sec);\r\nexit:\r\nmutex_unlock(&rtc->lock);\r\nreturn ret;\r\n}\r\nstatic int mtk_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\ntime64_t time;\r\nstruct mt6397_rtc *rtc = dev_get_drvdata(dev);\r\nint days, sec, ret;\r\ndo {\r\nret = __mtk_rtc_read_time(rtc, tm, &sec);\r\nif (ret < 0)\r\ngoto exit;\r\n} while (sec < tm->tm_sec);\r\ntm->tm_year += RTC_MIN_YEAR_OFFSET;\r\ntm->tm_mon--;\r\ntime = rtc_tm_to_time64(tm);\r\ndays = div_s64(time, 86400);\r\ntm->tm_wday = (days + 4) % 7;\r\nexit:\r\nreturn ret;\r\n}\r\nstatic int mtk_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct mt6397_rtc *rtc = dev_get_drvdata(dev);\r\nint ret;\r\nu16 data[RTC_OFFSET_COUNT];\r\ntm->tm_year -= RTC_MIN_YEAR_OFFSET;\r\ntm->tm_mon++;\r\ndata[RTC_OFFSET_SEC] = tm->tm_sec;\r\ndata[RTC_OFFSET_MIN] = tm->tm_min;\r\ndata[RTC_OFFSET_HOUR] = tm->tm_hour;\r\ndata[RTC_OFFSET_DOM] = tm->tm_mday;\r\ndata[RTC_OFFSET_MTH] = tm->tm_mon;\r\ndata[RTC_OFFSET_YEAR] = tm->tm_year;\r\nmutex_lock(&rtc->lock);\r\nret = regmap_bulk_write(rtc->regmap, rtc->addr_base + RTC_TC_SEC,\r\ndata, RTC_OFFSET_COUNT);\r\nif (ret < 0)\r\ngoto exit;\r\nret = mtk_rtc_write_trigger(rtc);\r\nexit:\r\nmutex_unlock(&rtc->lock);\r\nreturn ret;\r\n}\r\nstatic int mtk_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alm)\r\n{\r\nstruct rtc_time *tm = &alm->time;\r\nstruct mt6397_rtc *rtc = dev_get_drvdata(dev);\r\nu32 irqen, pdn2;\r\nint ret;\r\nu16 data[RTC_OFFSET_COUNT];\r\nmutex_lock(&rtc->lock);\r\nret = regmap_read(rtc->regmap, rtc->addr_base + RTC_IRQ_EN, &irqen);\r\nif (ret < 0)\r\ngoto err_exit;\r\nret = regmap_read(rtc->regmap, rtc->addr_base + RTC_PDN2, &pdn2);\r\nif (ret < 0)\r\ngoto err_exit;\r\nret = regmap_bulk_read(rtc->regmap, rtc->addr_base + RTC_AL_SEC,\r\ndata, RTC_OFFSET_COUNT);\r\nif (ret < 0)\r\ngoto err_exit;\r\nalm->enabled = !!(irqen & RTC_IRQ_EN_AL);\r\nalm->pending = !!(pdn2 & RTC_PDN2_PWRON_ALARM);\r\nmutex_unlock(&rtc->lock);\r\ntm->tm_sec = data[RTC_OFFSET_SEC];\r\ntm->tm_min = data[RTC_OFFSET_MIN];\r\ntm->tm_hour = data[RTC_OFFSET_HOUR];\r\ntm->tm_mday = data[RTC_OFFSET_DOM];\r\ntm->tm_mon = data[RTC_OFFSET_MTH];\r\ntm->tm_year = data[RTC_OFFSET_YEAR];\r\ntm->tm_year += RTC_MIN_YEAR_OFFSET;\r\ntm->tm_mon--;\r\nreturn 0;\r\nerr_exit:\r\nmutex_unlock(&rtc->lock);\r\nreturn ret;\r\n}\r\nstatic int mtk_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alm)\r\n{\r\nstruct rtc_time *tm = &alm->time;\r\nstruct mt6397_rtc *rtc = dev_get_drvdata(dev);\r\nint ret;\r\nu16 data[RTC_OFFSET_COUNT];\r\ntm->tm_year -= RTC_MIN_YEAR_OFFSET;\r\ntm->tm_mon++;\r\ndata[RTC_OFFSET_SEC] = tm->tm_sec;\r\ndata[RTC_OFFSET_MIN] = tm->tm_min;\r\ndata[RTC_OFFSET_HOUR] = tm->tm_hour;\r\ndata[RTC_OFFSET_DOM] = tm->tm_mday;\r\ndata[RTC_OFFSET_MTH] = tm->tm_mon;\r\ndata[RTC_OFFSET_YEAR] = tm->tm_year;\r\nmutex_lock(&rtc->lock);\r\nif (alm->enabled) {\r\nret = regmap_bulk_write(rtc->regmap,\r\nrtc->addr_base + RTC_AL_SEC,\r\ndata, RTC_OFFSET_COUNT);\r\nif (ret < 0)\r\ngoto exit;\r\nret = regmap_write(rtc->regmap, rtc->addr_base + RTC_AL_MASK,\r\nRTC_AL_MASK_DOW);\r\nif (ret < 0)\r\ngoto exit;\r\nret = regmap_update_bits(rtc->regmap,\r\nrtc->addr_base + RTC_IRQ_EN,\r\nRTC_IRQ_EN_ONESHOT_AL,\r\nRTC_IRQ_EN_ONESHOT_AL);\r\nif (ret < 0)\r\ngoto exit;\r\n} else {\r\nret = regmap_update_bits(rtc->regmap,\r\nrtc->addr_base + RTC_IRQ_EN,\r\nRTC_IRQ_EN_ONESHOT_AL, 0);\r\nif (ret < 0)\r\ngoto exit;\r\n}\r\nret = mtk_rtc_write_trigger(rtc);\r\nexit:\r\nmutex_unlock(&rtc->lock);\r\nreturn ret;\r\n}\r\nstatic int mtk_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nstruct mt6397_chip *mt6397_chip = dev_get_drvdata(pdev->dev.parent);\r\nstruct mt6397_rtc *rtc;\r\nint ret;\r\nrtc = devm_kzalloc(&pdev->dev, sizeof(struct mt6397_rtc), GFP_KERNEL);\r\nif (!rtc)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nrtc->addr_base = res->start;\r\nres = platform_get_resource(pdev, IORESOURCE_IRQ, 0);\r\nrtc->irq = irq_create_mapping(mt6397_chip->irq_domain, res->start);\r\nif (rtc->irq <= 0)\r\nreturn -EINVAL;\r\nrtc->regmap = mt6397_chip->regmap;\r\nrtc->dev = &pdev->dev;\r\nmutex_init(&rtc->lock);\r\nplatform_set_drvdata(pdev, rtc);\r\nret = request_threaded_irq(rtc->irq, NULL,\r\nmtk_rtc_irq_handler_thread,\r\nIRQF_ONESHOT | IRQF_TRIGGER_HIGH,\r\n"mt6397-rtc", rtc);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to request alarm IRQ: %d: %d\n",\r\nrtc->irq, ret);\r\ngoto out_dispose_irq;\r\n}\r\ndevice_init_wakeup(&pdev->dev, 1);\r\nrtc->rtc_dev = rtc_device_register("mt6397-rtc", &pdev->dev,\r\n&mtk_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc->rtc_dev)) {\r\ndev_err(&pdev->dev, "register rtc device failed\n");\r\nret = PTR_ERR(rtc->rtc_dev);\r\ngoto out_free_irq;\r\n}\r\nreturn 0;\r\nout_free_irq:\r\nfree_irq(rtc->irq, rtc->rtc_dev);\r\nout_dispose_irq:\r\nirq_dispose_mapping(rtc->irq);\r\nreturn ret;\r\n}\r\nstatic int mtk_rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct mt6397_rtc *rtc = platform_get_drvdata(pdev);\r\nrtc_device_unregister(rtc->rtc_dev);\r\nfree_irq(rtc->irq, rtc->rtc_dev);\r\nirq_dispose_mapping(rtc->irq);\r\nreturn 0;\r\n}\r\nstatic int mt6397_rtc_suspend(struct device *dev)\r\n{\r\nstruct mt6397_rtc *rtc = dev_get_drvdata(dev);\r\nif (device_may_wakeup(dev))\r\nenable_irq_wake(rtc->irq);\r\nreturn 0;\r\n}\r\nstatic int mt6397_rtc_resume(struct device *dev)\r\n{\r\nstruct mt6397_rtc *rtc = dev_get_drvdata(dev);\r\nif (device_may_wakeup(dev))\r\ndisable_irq_wake(rtc->irq);\r\nreturn 0;\r\n}

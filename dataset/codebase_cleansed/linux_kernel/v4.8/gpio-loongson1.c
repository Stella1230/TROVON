static int ls1x_gpio_request(struct gpio_chip *gc, unsigned int offset)\r\n{\r\nunsigned long pinmask = gc->pin2mask(gc, offset);\r\nunsigned long flags;\r\nspin_lock_irqsave(&gc->bgpio_lock, flags);\r\n__raw_writel(__raw_readl(gpio_reg_base + GPIO_CFG) | pinmask,\r\ngpio_reg_base + GPIO_CFG);\r\nspin_unlock_irqrestore(&gc->bgpio_lock, flags);\r\nreturn 0;\r\n}\r\nstatic void ls1x_gpio_free(struct gpio_chip *gc, unsigned int offset)\r\n{\r\nunsigned long pinmask = gc->pin2mask(gc, offset);\r\nunsigned long flags;\r\nspin_lock_irqsave(&gc->bgpio_lock, flags);\r\n__raw_writel(__raw_readl(gpio_reg_base + GPIO_CFG) & ~pinmask,\r\ngpio_reg_base + GPIO_CFG);\r\nspin_unlock_irqrestore(&gc->bgpio_lock, flags);\r\n}\r\nstatic int ls1x_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct gpio_chip *gc;\r\nstruct resource *res;\r\nint ret;\r\ngc = devm_kzalloc(dev, sizeof(*gc), GFP_KERNEL);\r\nif (!gc)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\ndev_err(dev, "failed to get I/O memory\n");\r\nreturn -EINVAL;\r\n}\r\ngpio_reg_base = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(gpio_reg_base))\r\nreturn PTR_ERR(gpio_reg_base);\r\nret = bgpio_init(gc, dev, 4, gpio_reg_base + GPIO_DATA,\r\ngpio_reg_base + GPIO_OUTPUT, NULL,\r\nNULL, gpio_reg_base + GPIO_DIR, 0);\r\nif (ret)\r\ngoto err;\r\ngc->owner = THIS_MODULE;\r\ngc->request = ls1x_gpio_request;\r\ngc->free = ls1x_gpio_free;\r\ngc->base = pdev->id * 32;\r\nret = devm_gpiochip_add_data(dev, gc, NULL);\r\nif (ret)\r\ngoto err;\r\nplatform_set_drvdata(pdev, gc);\r\ndev_info(dev, "Loongson1 GPIO driver registered\n");\r\nreturn 0;\r\nerr:\r\ndev_err(dev, "failed to register GPIO device\n");\r\nreturn ret;\r\n}

static void beep(unsigned int freq)\r\n{\r\nif (sound)\r\nkd_mksound(freq, HZ/10);\r\n}\r\nstatic void braille_write(u16 *buf)\r\n{\r\nstatic u16 lastwrite[WIDTH];\r\nunsigned char data[1 + 1 + 2*WIDTH + 2 + 1], csum = 0, *c;\r\nu16 out;\r\nint i;\r\nif (!braille_co)\r\nreturn;\r\nif (!memcmp(lastwrite, buf, WIDTH * sizeof(*buf)))\r\nreturn;\r\nmemcpy(lastwrite, buf, WIDTH * sizeof(*buf));\r\n#define SOH 1\r\n#define STX 2\r\n#define ETX 2\r\n#define EOT 4\r\n#define ENQ 5\r\ndata[0] = STX;\r\ndata[1] = '>';\r\ncsum ^= '>';\r\nc = &data[2];\r\nfor (i = 0; i < WIDTH; i++) {\r\nout = buf[i];\r\nif (out >= 0x100)\r\nout = '?';\r\nelse if (out == 0x00)\r\nout = ' ';\r\ncsum ^= out;\r\nif (out <= 0x05) {\r\n*c++ = SOH;\r\nout |= 0x40;\r\n}\r\n*c++ = out;\r\n}\r\nif (csum <= 0x05) {\r\n*c++ = SOH;\r\ncsum |= 0x40;\r\n}\r\n*c++ = csum;\r\n*c++ = ETX;\r\nbraille_co->write(braille_co, data, c - data);\r\n}\r\nstatic void vc_follow_cursor(struct vc_data *vc)\r\n{\r\nvc_x = vc->vc_x - (vc->vc_x % WIDTH);\r\nvc_y = vc->vc_y;\r\nlastvc_x = vc->vc_x;\r\nlastvc_y = vc->vc_y;\r\n}\r\nstatic void vc_maybe_cursor_moved(struct vc_data *vc)\r\n{\r\nif (vc->vc_x != lastvc_x || vc->vc_y != lastvc_y)\r\nvc_follow_cursor(vc);\r\n}\r\nstatic void vc_refresh(struct vc_data *vc)\r\n{\r\nu16 buf[WIDTH];\r\nint i;\r\nfor (i = 0; i < WIDTH; i++) {\r\nu16 glyph = screen_glyph(vc,\r\n2 * (vc_x + i) + vc_y * vc->vc_size_row);\r\nbuf[i] = inverse_translate(vc, glyph, 1);\r\n}\r\nbraille_write(buf);\r\n}\r\nstatic int keyboard_notifier_call(struct notifier_block *blk,\r\nunsigned long code, void *_param)\r\n{\r\nstruct keyboard_notifier_param *param = _param;\r\nstruct vc_data *vc = param->vc;\r\nint ret = NOTIFY_OK;\r\nif (!param->down)\r\nreturn ret;\r\nswitch (code) {\r\ncase KBD_KEYCODE:\r\nif (console_show) {\r\nif (param->value == BRAILLE_KEY) {\r\nconsole_show = 0;\r\nbeep(880);\r\nvc_maybe_cursor_moved(vc);\r\nvc_refresh(vc);\r\nret = NOTIFY_STOP;\r\n}\r\n} else {\r\nret = NOTIFY_STOP;\r\nswitch (param->value) {\r\ncase KEY_INSERT:\r\nbeep(440);\r\nconsole_show = 1;\r\nlastVC = -1;\r\nbraille_write(console_buf);\r\nbreak;\r\ncase KEY_LEFT:\r\nif (vc_x > 0) {\r\nvc_x -= WIDTH;\r\nif (vc_x < 0)\r\nvc_x = 0;\r\n} else if (vc_y >= 1) {\r\nbeep(880);\r\nvc_y--;\r\nvc_x = vc->vc_cols-WIDTH;\r\n} else\r\nbeep(220);\r\nbreak;\r\ncase KEY_RIGHT:\r\nif (vc_x + WIDTH < vc->vc_cols) {\r\nvc_x += WIDTH;\r\n} else if (vc_y + 1 < vc->vc_rows) {\r\nbeep(880);\r\nvc_y++;\r\nvc_x = 0;\r\n} else\r\nbeep(220);\r\nbreak;\r\ncase KEY_DOWN:\r\nif (vc_y + 1 < vc->vc_rows)\r\nvc_y++;\r\nelse\r\nbeep(220);\r\nbreak;\r\ncase KEY_UP:\r\nif (vc_y >= 1)\r\nvc_y--;\r\nelse\r\nbeep(220);\r\nbreak;\r\ncase KEY_HOME:\r\nvc_follow_cursor(vc);\r\nbreak;\r\ncase KEY_PAGEUP:\r\nvc_x = 0;\r\nvc_y = 0;\r\nbreak;\r\ncase KEY_PAGEDOWN:\r\nvc_x = 0;\r\nvc_y = vc->vc_rows-1;\r\nbreak;\r\ndefault:\r\nret = NOTIFY_OK;\r\nbreak;\r\n}\r\nif (ret == NOTIFY_STOP)\r\nvc_refresh(vc);\r\n}\r\nbreak;\r\ncase KBD_POST_KEYSYM:\r\n{\r\nunsigned char type = KTYP(param->value) - 0xf0;\r\nif (type == KT_SPEC) {\r\nunsigned char val = KVAL(param->value);\r\nint on_off = -1;\r\nswitch (val) {\r\ncase KVAL(K_CAPS):\r\non_off = vt_get_leds(fg_console, VC_CAPSLOCK);\r\nbreak;\r\ncase KVAL(K_NUM):\r\non_off = vt_get_leds(fg_console, VC_NUMLOCK);\r\nbreak;\r\ncase KVAL(K_HOLD):\r\non_off = vt_get_leds(fg_console, VC_SCROLLOCK);\r\nbreak;\r\n}\r\nif (on_off == 1)\r\nbeep(880);\r\nelse if (on_off == 0)\r\nbeep(440);\r\n}\r\n}\r\ncase KBD_UNBOUND_KEYCODE:\r\ncase KBD_UNICODE:\r\ncase KBD_KEYSYM:\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int vt_notifier_call(struct notifier_block *blk,\r\nunsigned long code, void *_param)\r\n{\r\nstruct vt_notifier_param *param = _param;\r\nstruct vc_data *vc = param->vc;\r\nswitch (code) {\r\ncase VT_ALLOCATE:\r\nbreak;\r\ncase VT_DEALLOCATE:\r\nbreak;\r\ncase VT_WRITE:\r\n{\r\nunsigned char c = param->c;\r\nif (vc->vc_num != fg_console)\r\nbreak;\r\nswitch (c) {\r\ncase '\b':\r\ncase 127:\r\nif (console_cursor > 0) {\r\nconsole_cursor--;\r\nconsole_buf[console_cursor] = ' ';\r\n}\r\nbreak;\r\ncase '\n':\r\ncase '\v':\r\ncase '\f':\r\ncase '\r':\r\nconsole_newline = 1;\r\nbreak;\r\ncase '\t':\r\nc = ' ';\r\ndefault:\r\nif (c < 32)\r\nbreak;\r\nif (console_newline) {\r\nmemset(console_buf, 0, sizeof(console_buf));\r\nconsole_cursor = 0;\r\nconsole_newline = 0;\r\n}\r\nif (console_cursor == WIDTH)\r\nmemmove(console_buf, &console_buf[1],\r\n(WIDTH-1) * sizeof(*console_buf));\r\nelse\r\nconsole_cursor++;\r\nconsole_buf[console_cursor-1] = c;\r\nbreak;\r\n}\r\nif (console_show)\r\nbraille_write(console_buf);\r\nelse {\r\nvc_maybe_cursor_moved(vc);\r\nvc_refresh(vc);\r\n}\r\nbreak;\r\n}\r\ncase VT_UPDATE:\r\nif (console_show) {\r\nif (vc->vc_num != lastVC) {\r\nlastVC = vc->vc_num;\r\nmemset(console_buf, 0, sizeof(console_buf));\r\nconsole_cursor = 0;\r\nbraille_write(console_buf);\r\n}\r\n} else {\r\nvc_maybe_cursor_moved(vc);\r\nvc_refresh(vc);\r\n}\r\nbreak;\r\n}\r\nreturn NOTIFY_OK;\r\n}\r\nint braille_register_console(struct console *console, int index,\r\nchar *console_options, char *braille_options)\r\n{\r\nint ret;\r\nif (!(console->flags & CON_BRL))\r\nreturn 0;\r\nif (!console_options)\r\nconsole_options = "57600o8";\r\nif (braille_co)\r\nreturn -ENODEV;\r\nif (console->setup) {\r\nret = console->setup(console, console_options);\r\nif (ret != 0)\r\nreturn ret;\r\n}\r\nconsole->flags |= CON_ENABLED;\r\nconsole->index = index;\r\nbraille_co = console;\r\nregister_keyboard_notifier(&keyboard_notifier_block);\r\nregister_vt_notifier(&vt_notifier_block);\r\nreturn 1;\r\n}\r\nint braille_unregister_console(struct console *console)\r\n{\r\nif (braille_co != console)\r\nreturn -EINVAL;\r\nif (!(console->flags & CON_BRL))\r\nreturn 0;\r\nunregister_keyboard_notifier(&keyboard_notifier_block);\r\nunregister_vt_notifier(&vt_notifier_block);\r\nbraille_co = NULL;\r\nreturn 1;\r\n}

void iforce_serial_xmit(struct iforce *iforce)\r\n{\r\nunsigned char cs;\r\nint i;\r\nunsigned long flags;\r\nif (test_and_set_bit(IFORCE_XMIT_RUNNING, iforce->xmit_flags)) {\r\nset_bit(IFORCE_XMIT_AGAIN, iforce->xmit_flags);\r\nreturn;\r\n}\r\nspin_lock_irqsave(&iforce->xmit_lock, flags);\r\nagain:\r\nif (iforce->xmit.head == iforce->xmit.tail) {\r\nclear_bit(IFORCE_XMIT_RUNNING, iforce->xmit_flags);\r\nspin_unlock_irqrestore(&iforce->xmit_lock, flags);\r\nreturn;\r\n}\r\ncs = 0x2b;\r\nserio_write(iforce->serio, 0x2b);\r\nserio_write(iforce->serio, iforce->xmit.buf[iforce->xmit.tail]);\r\ncs ^= iforce->xmit.buf[iforce->xmit.tail];\r\nXMIT_INC(iforce->xmit.tail, 1);\r\nfor (i=iforce->xmit.buf[iforce->xmit.tail]; i >= 0; --i) {\r\nserio_write(iforce->serio, iforce->xmit.buf[iforce->xmit.tail]);\r\ncs ^= iforce->xmit.buf[iforce->xmit.tail];\r\nXMIT_INC(iforce->xmit.tail, 1);\r\n}\r\nserio_write(iforce->serio, cs);\r\nif (test_and_clear_bit(IFORCE_XMIT_AGAIN, iforce->xmit_flags))\r\ngoto again;\r\nclear_bit(IFORCE_XMIT_RUNNING, iforce->xmit_flags);\r\nspin_unlock_irqrestore(&iforce->xmit_lock, flags);\r\n}\r\nstatic void iforce_serio_write_wakeup(struct serio *serio)\r\n{\r\nstruct iforce *iforce = serio_get_drvdata(serio);\r\niforce_serial_xmit(iforce);\r\n}\r\nstatic irqreturn_t iforce_serio_irq(struct serio *serio,\r\nunsigned char data, unsigned int flags)\r\n{\r\nstruct iforce *iforce = serio_get_drvdata(serio);\r\nif (!iforce->pkt) {\r\nif (data == 0x2b)\r\niforce->pkt = 1;\r\ngoto out;\r\n}\r\nif (!iforce->id) {\r\nif (data > 3 && data != 0xff)\r\niforce->pkt = 0;\r\nelse\r\niforce->id = data;\r\ngoto out;\r\n}\r\nif (!iforce->len) {\r\nif (data > IFORCE_MAX_LENGTH) {\r\niforce->pkt = 0;\r\niforce->id = 0;\r\n} else {\r\niforce->len = data;\r\n}\r\ngoto out;\r\n}\r\nif (iforce->idx < iforce->len) {\r\niforce->csum += iforce->data[iforce->idx++] = data;\r\ngoto out;\r\n}\r\nif (iforce->idx == iforce->len) {\r\niforce_process_packet(iforce, (iforce->id << 8) | iforce->idx, iforce->data);\r\niforce->pkt = 0;\r\niforce->id = 0;\r\niforce->len = 0;\r\niforce->idx = 0;\r\niforce->csum = 0;\r\n}\r\nout:\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int iforce_serio_connect(struct serio *serio, struct serio_driver *drv)\r\n{\r\nstruct iforce *iforce;\r\nint err;\r\niforce = kzalloc(sizeof(struct iforce), GFP_KERNEL);\r\nif (!iforce)\r\nreturn -ENOMEM;\r\niforce->bus = IFORCE_232;\r\niforce->serio = serio;\r\nserio_set_drvdata(serio, iforce);\r\nerr = serio_open(serio, drv);\r\nif (err)\r\ngoto fail1;\r\nerr = iforce_init_device(iforce);\r\nif (err)\r\ngoto fail2;\r\nreturn 0;\r\nfail2: serio_close(serio);\r\nfail1: serio_set_drvdata(serio, NULL);\r\nkfree(iforce);\r\nreturn err;\r\n}\r\nstatic void iforce_serio_disconnect(struct serio *serio)\r\n{\r\nstruct iforce *iforce = serio_get_drvdata(serio);\r\ninput_unregister_device(iforce->dev);\r\nserio_close(serio);\r\nserio_set_drvdata(serio, NULL);\r\nkfree(iforce);\r\n}

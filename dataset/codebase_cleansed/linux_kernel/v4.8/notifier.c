static int notifier_chain_register(struct notifier_block **nl,\r\nstruct notifier_block *n)\r\n{\r\nwhile ((*nl) != NULL) {\r\nif (n->priority > (*nl)->priority)\r\nbreak;\r\nnl = &((*nl)->next);\r\n}\r\nn->next = *nl;\r\nrcu_assign_pointer(*nl, n);\r\nreturn 0;\r\n}\r\nstatic int notifier_chain_cond_register(struct notifier_block **nl,\r\nstruct notifier_block *n)\r\n{\r\nwhile ((*nl) != NULL) {\r\nif ((*nl) == n)\r\nreturn 0;\r\nif (n->priority > (*nl)->priority)\r\nbreak;\r\nnl = &((*nl)->next);\r\n}\r\nn->next = *nl;\r\nrcu_assign_pointer(*nl, n);\r\nreturn 0;\r\n}\r\nstatic int notifier_chain_unregister(struct notifier_block **nl,\r\nstruct notifier_block *n)\r\n{\r\nwhile ((*nl) != NULL) {\r\nif ((*nl) == n) {\r\nrcu_assign_pointer(*nl, n->next);\r\nreturn 0;\r\n}\r\nnl = &((*nl)->next);\r\n}\r\nreturn -ENOENT;\r\n}\r\nstatic int notifier_call_chain(struct notifier_block **nl,\r\nunsigned long val, void *v,\r\nint nr_to_call, int *nr_calls)\r\n{\r\nint ret = NOTIFY_DONE;\r\nstruct notifier_block *nb, *next_nb;\r\nnb = rcu_dereference_raw(*nl);\r\nwhile (nb && nr_to_call) {\r\nnext_nb = rcu_dereference_raw(nb->next);\r\n#ifdef CONFIG_DEBUG_NOTIFIERS\r\nif (unlikely(!func_ptr_is_kernel_text(nb->notifier_call))) {\r\nWARN(1, "Invalid notifier called!");\r\nnb = next_nb;\r\ncontinue;\r\n}\r\n#endif\r\nret = nb->notifier_call(nb, val, v);\r\nif (nr_calls)\r\n(*nr_calls)++;\r\nif ((ret & NOTIFY_STOP_MASK) == NOTIFY_STOP_MASK)\r\nbreak;\r\nnb = next_nb;\r\nnr_to_call--;\r\n}\r\nreturn ret;\r\n}\r\nint atomic_notifier_chain_register(struct atomic_notifier_head *nh,\r\nstruct notifier_block *n)\r\n{\r\nunsigned long flags;\r\nint ret;\r\nspin_lock_irqsave(&nh->lock, flags);\r\nret = notifier_chain_register(&nh->head, n);\r\nspin_unlock_irqrestore(&nh->lock, flags);\r\nreturn ret;\r\n}\r\nint atomic_notifier_chain_unregister(struct atomic_notifier_head *nh,\r\nstruct notifier_block *n)\r\n{\r\nunsigned long flags;\r\nint ret;\r\nspin_lock_irqsave(&nh->lock, flags);\r\nret = notifier_chain_unregister(&nh->head, n);\r\nspin_unlock_irqrestore(&nh->lock, flags);\r\nsynchronize_rcu();\r\nreturn ret;\r\n}\r\nint __atomic_notifier_call_chain(struct atomic_notifier_head *nh,\r\nunsigned long val, void *v,\r\nint nr_to_call, int *nr_calls)\r\n{\r\nint ret;\r\nrcu_read_lock();\r\nret = notifier_call_chain(&nh->head, val, v, nr_to_call, nr_calls);\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nint atomic_notifier_call_chain(struct atomic_notifier_head *nh,\r\nunsigned long val, void *v)\r\n{\r\nreturn __atomic_notifier_call_chain(nh, val, v, -1, NULL);\r\n}\r\nint blocking_notifier_chain_register(struct blocking_notifier_head *nh,\r\nstruct notifier_block *n)\r\n{\r\nint ret;\r\nif (unlikely(system_state == SYSTEM_BOOTING))\r\nreturn notifier_chain_register(&nh->head, n);\r\ndown_write(&nh->rwsem);\r\nret = notifier_chain_register(&nh->head, n);\r\nup_write(&nh->rwsem);\r\nreturn ret;\r\n}\r\nint blocking_notifier_chain_cond_register(struct blocking_notifier_head *nh,\r\nstruct notifier_block *n)\r\n{\r\nint ret;\r\ndown_write(&nh->rwsem);\r\nret = notifier_chain_cond_register(&nh->head, n);\r\nup_write(&nh->rwsem);\r\nreturn ret;\r\n}\r\nint blocking_notifier_chain_unregister(struct blocking_notifier_head *nh,\r\nstruct notifier_block *n)\r\n{\r\nint ret;\r\nif (unlikely(system_state == SYSTEM_BOOTING))\r\nreturn notifier_chain_unregister(&nh->head, n);\r\ndown_write(&nh->rwsem);\r\nret = notifier_chain_unregister(&nh->head, n);\r\nup_write(&nh->rwsem);\r\nreturn ret;\r\n}\r\nint __blocking_notifier_call_chain(struct blocking_notifier_head *nh,\r\nunsigned long val, void *v,\r\nint nr_to_call, int *nr_calls)\r\n{\r\nint ret = NOTIFY_DONE;\r\nif (rcu_access_pointer(nh->head)) {\r\ndown_read(&nh->rwsem);\r\nret = notifier_call_chain(&nh->head, val, v, nr_to_call,\r\nnr_calls);\r\nup_read(&nh->rwsem);\r\n}\r\nreturn ret;\r\n}\r\nint blocking_notifier_call_chain(struct blocking_notifier_head *nh,\r\nunsigned long val, void *v)\r\n{\r\nreturn __blocking_notifier_call_chain(nh, val, v, -1, NULL);\r\n}\r\nint raw_notifier_chain_register(struct raw_notifier_head *nh,\r\nstruct notifier_block *n)\r\n{\r\nreturn notifier_chain_register(&nh->head, n);\r\n}\r\nint raw_notifier_chain_unregister(struct raw_notifier_head *nh,\r\nstruct notifier_block *n)\r\n{\r\nreturn notifier_chain_unregister(&nh->head, n);\r\n}\r\nint __raw_notifier_call_chain(struct raw_notifier_head *nh,\r\nunsigned long val, void *v,\r\nint nr_to_call, int *nr_calls)\r\n{\r\nreturn notifier_call_chain(&nh->head, val, v, nr_to_call, nr_calls);\r\n}\r\nint raw_notifier_call_chain(struct raw_notifier_head *nh,\r\nunsigned long val, void *v)\r\n{\r\nreturn __raw_notifier_call_chain(nh, val, v, -1, NULL);\r\n}\r\nint srcu_notifier_chain_register(struct srcu_notifier_head *nh,\r\nstruct notifier_block *n)\r\n{\r\nint ret;\r\nif (unlikely(system_state == SYSTEM_BOOTING))\r\nreturn notifier_chain_register(&nh->head, n);\r\nmutex_lock(&nh->mutex);\r\nret = notifier_chain_register(&nh->head, n);\r\nmutex_unlock(&nh->mutex);\r\nreturn ret;\r\n}\r\nint srcu_notifier_chain_unregister(struct srcu_notifier_head *nh,\r\nstruct notifier_block *n)\r\n{\r\nint ret;\r\nif (unlikely(system_state == SYSTEM_BOOTING))\r\nreturn notifier_chain_unregister(&nh->head, n);\r\nmutex_lock(&nh->mutex);\r\nret = notifier_chain_unregister(&nh->head, n);\r\nmutex_unlock(&nh->mutex);\r\nsynchronize_srcu(&nh->srcu);\r\nreturn ret;\r\n}\r\nint __srcu_notifier_call_chain(struct srcu_notifier_head *nh,\r\nunsigned long val, void *v,\r\nint nr_to_call, int *nr_calls)\r\n{\r\nint ret;\r\nint idx;\r\nidx = srcu_read_lock(&nh->srcu);\r\nret = notifier_call_chain(&nh->head, val, v, nr_to_call, nr_calls);\r\nsrcu_read_unlock(&nh->srcu, idx);\r\nreturn ret;\r\n}\r\nint srcu_notifier_call_chain(struct srcu_notifier_head *nh,\r\nunsigned long val, void *v)\r\n{\r\nreturn __srcu_notifier_call_chain(nh, val, v, -1, NULL);\r\n}\r\nvoid srcu_init_notifier_head(struct srcu_notifier_head *nh)\r\n{\r\nmutex_init(&nh->mutex);\r\nif (init_srcu_struct(&nh->srcu) < 0)\r\nBUG();\r\nnh->head = NULL;\r\n}\r\nint notrace notify_die(enum die_val val, const char *str,\r\nstruct pt_regs *regs, long err, int trap, int sig)\r\n{\r\nstruct die_args args = {\r\n.regs = regs,\r\n.str = str,\r\n.err = err,\r\n.trapnr = trap,\r\n.signr = sig,\r\n};\r\nRCU_LOCKDEP_WARN(!rcu_is_watching(),\r\n"notify_die called but RCU thinks we're quiescent");\r\nreturn atomic_notifier_call_chain(&die_chain, val, &args);\r\n}\r\nint register_die_notifier(struct notifier_block *nb)\r\n{\r\nvmalloc_sync_all();\r\nreturn atomic_notifier_chain_register(&die_chain, nb);\r\n}\r\nint unregister_die_notifier(struct notifier_block *nb)\r\n{\r\nreturn atomic_notifier_chain_unregister(&die_chain, nb);\r\n}

static u32 zynqmp_gqspi_read(struct zynqmp_qspi *xqspi, u32 offset)\r\n{\r\nreturn readl_relaxed(xqspi->regs + offset);\r\n}\r\nstatic inline void zynqmp_gqspi_write(struct zynqmp_qspi *xqspi, u32 offset,\r\nu32 val)\r\n{\r\nwritel_relaxed(val, (xqspi->regs + offset));\r\n}\r\nstatic void zynqmp_gqspi_selectslave(struct zynqmp_qspi *instanceptr,\r\nu8 slavecs, u8 slavebus)\r\n{\r\nswitch (slavecs) {\r\ncase GQSPI_SELECT_FLASH_CS_BOTH:\r\ninstanceptr->genfifocs = GQSPI_GENFIFO_CS_LOWER |\r\nGQSPI_GENFIFO_CS_UPPER;\r\nbreak;\r\ncase GQSPI_SELECT_FLASH_CS_UPPER:\r\ninstanceptr->genfifocs = GQSPI_GENFIFO_CS_UPPER;\r\nbreak;\r\ncase GQSPI_SELECT_FLASH_CS_LOWER:\r\ninstanceptr->genfifocs = GQSPI_GENFIFO_CS_LOWER;\r\nbreak;\r\ndefault:\r\ndev_warn(instanceptr->dev, "Invalid slave select\n");\r\n}\r\nswitch (slavebus) {\r\ncase GQSPI_SELECT_FLASH_BUS_BOTH:\r\ninstanceptr->genfifobus = GQSPI_GENFIFO_BUS_LOWER |\r\nGQSPI_GENFIFO_BUS_UPPER;\r\nbreak;\r\ncase GQSPI_SELECT_FLASH_BUS_UPPER:\r\ninstanceptr->genfifobus = GQSPI_GENFIFO_BUS_UPPER;\r\nbreak;\r\ncase GQSPI_SELECT_FLASH_BUS_LOWER:\r\ninstanceptr->genfifobus = GQSPI_GENFIFO_BUS_LOWER;\r\nbreak;\r\ndefault:\r\ndev_warn(instanceptr->dev, "Invalid slave bus\n");\r\n}\r\n}\r\nstatic void zynqmp_qspi_init_hw(struct zynqmp_qspi *xqspi)\r\n{\r\nu32 config_reg;\r\nzynqmp_gqspi_write(xqspi, GQSPI_SEL_OFST, GQSPI_SEL_MASK);\r\nzynqmp_gqspi_write(xqspi, GQSPI_ISR_OFST,\r\nzynqmp_gqspi_read(xqspi, GQSPI_ISR_OFST) |\r\nGQSPI_ISR_WR_TO_CLR_MASK);\r\nzynqmp_gqspi_write(xqspi, GQSPI_QSPIDMA_DST_I_STS_OFST,\r\nzynqmp_gqspi_read(xqspi,\r\nGQSPI_QSPIDMA_DST_I_STS_OFST));\r\nzynqmp_gqspi_write(xqspi, GQSPI_QSPIDMA_DST_STS_OFST,\r\nzynqmp_gqspi_read(xqspi,\r\nGQSPI_QSPIDMA_DST_STS_OFST) |\r\nGQSPI_QSPIDMA_DST_STS_WTC);\r\nzynqmp_gqspi_write(xqspi, GQSPI_IDR_OFST, GQSPI_IDR_ALL_MASK);\r\nzynqmp_gqspi_write(xqspi,\r\nGQSPI_QSPIDMA_DST_I_DIS_OFST,\r\nGQSPI_QSPIDMA_DST_INTR_ALL_MASK);\r\nzynqmp_gqspi_write(xqspi, GQSPI_EN_OFST, 0x0);\r\nconfig_reg = zynqmp_gqspi_read(xqspi, GQSPI_CONFIG_OFST);\r\nconfig_reg &= ~GQSPI_CFG_MODE_EN_MASK;\r\nconfig_reg |= GQSPI_CFG_GEN_FIFO_START_MODE_MASK;\r\nconfig_reg &= ~GQSPI_CFG_ENDIAN_MASK;\r\nconfig_reg &= ~GQSPI_CFG_EN_POLL_TO_MASK;\r\nconfig_reg |= GQSPI_CFG_WP_HOLD_MASK;\r\nconfig_reg &= ~GQSPI_CFG_BAUD_RATE_DIV_MASK;\r\nconfig_reg &= ~GQSPI_CFG_CLK_PHA_MASK;\r\nconfig_reg &= ~GQSPI_CFG_CLK_POL_MASK;\r\nzynqmp_gqspi_write(xqspi, GQSPI_CONFIG_OFST, config_reg);\r\nzynqmp_gqspi_write(xqspi, GQSPI_FIFO_CTRL_OFST,\r\nGQSPI_FIFO_CTRL_RST_RX_FIFO_MASK |\r\nGQSPI_FIFO_CTRL_RST_TX_FIFO_MASK |\r\nGQSPI_FIFO_CTRL_RST_GEN_FIFO_MASK);\r\nzynqmp_gqspi_write(xqspi, GQSPI_LPBK_DLY_ADJ_OFST,\r\nzynqmp_gqspi_read(xqspi, GQSPI_LPBK_DLY_ADJ_OFST) |\r\nGQSPI_LPBK_DLY_ADJ_USE_LPBK_MASK);\r\nzynqmp_gqspi_write(xqspi, GQSPI_TX_THRESHOLD_OFST,\r\nGQSPI_TX_FIFO_THRESHOLD_RESET_VAL);\r\nzynqmp_gqspi_write(xqspi, GQSPI_RX_THRESHOLD_OFST,\r\nGQSPI_RX_FIFO_THRESHOLD);\r\nzynqmp_gqspi_write(xqspi, GQSPI_GF_THRESHOLD_OFST,\r\nGQSPI_GEN_FIFO_THRESHOLD_RESET_VAL);\r\nzynqmp_gqspi_selectslave(xqspi,\r\nGQSPI_SELECT_FLASH_CS_LOWER,\r\nGQSPI_SELECT_FLASH_BUS_LOWER);\r\nzynqmp_gqspi_write(xqspi,\r\nGQSPI_QSPIDMA_DST_CTRL_OFST,\r\nGQSPI_QSPIDMA_DST_CTRL_RESET_VAL);\r\nzynqmp_gqspi_write(xqspi, GQSPI_EN_OFST, GQSPI_EN_MASK);\r\n}\r\nstatic void zynqmp_qspi_copy_read_data(struct zynqmp_qspi *xqspi,\r\nulong data, u8 size)\r\n{\r\nmemcpy(xqspi->rxbuf, &data, size);\r\nxqspi->rxbuf += size;\r\nxqspi->bytes_to_receive -= size;\r\n}\r\nstatic int zynqmp_prepare_transfer_hardware(struct spi_master *master)\r\n{\r\nstruct zynqmp_qspi *xqspi = spi_master_get_devdata(master);\r\nint ret;\r\nret = clk_enable(xqspi->refclk);\r\nif (ret)\r\nreturn ret;\r\nret = clk_enable(xqspi->pclk);\r\nif (ret)\r\ngoto clk_err;\r\nzynqmp_gqspi_write(xqspi, GQSPI_EN_OFST, GQSPI_EN_MASK);\r\nreturn 0;\r\nclk_err:\r\nclk_disable(xqspi->refclk);\r\nreturn ret;\r\n}\r\nstatic int zynqmp_unprepare_transfer_hardware(struct spi_master *master)\r\n{\r\nstruct zynqmp_qspi *xqspi = spi_master_get_devdata(master);\r\nzynqmp_gqspi_write(xqspi, GQSPI_EN_OFST, 0x0);\r\nclk_disable(xqspi->refclk);\r\nclk_disable(xqspi->pclk);\r\nreturn 0;\r\n}\r\nstatic void zynqmp_qspi_chipselect(struct spi_device *qspi, bool is_high)\r\n{\r\nstruct zynqmp_qspi *xqspi = spi_master_get_devdata(qspi->master);\r\nulong timeout;\r\nu32 genfifoentry = 0x0, statusreg;\r\ngenfifoentry |= GQSPI_GENFIFO_MODE_SPI;\r\ngenfifoentry |= xqspi->genfifobus;\r\nif (!is_high) {\r\ngenfifoentry |= xqspi->genfifocs;\r\ngenfifoentry |= GQSPI_GENFIFO_CS_SETUP;\r\n} else {\r\ngenfifoentry |= GQSPI_GENFIFO_CS_HOLD;\r\n}\r\nzynqmp_gqspi_write(xqspi, GQSPI_GEN_FIFO_OFST, genfifoentry);\r\nzynqmp_gqspi_write(xqspi, GQSPI_GEN_FIFO_OFST, 0x0);\r\nzynqmp_gqspi_write(xqspi, GQSPI_CONFIG_OFST,\r\nzynqmp_gqspi_read(xqspi, GQSPI_CONFIG_OFST) |\r\nGQSPI_CFG_START_GEN_FIFO_MASK);\r\ntimeout = jiffies + msecs_to_jiffies(1000);\r\ndo {\r\nstatusreg = zynqmp_gqspi_read(xqspi, GQSPI_ISR_OFST);\r\nif ((statusreg & GQSPI_ISR_GENFIFOEMPTY_MASK) &&\r\n(statusreg & GQSPI_ISR_TXEMPTY_MASK))\r\nbreak;\r\nelse\r\ncpu_relax();\r\n} while (!time_after_eq(jiffies, timeout));\r\nif (time_after_eq(jiffies, timeout))\r\ndev_err(xqspi->dev, "Chip select timed out\n");\r\n}\r\nstatic int zynqmp_qspi_setup_transfer(struct spi_device *qspi,\r\nstruct spi_transfer *transfer)\r\n{\r\nstruct zynqmp_qspi *xqspi = spi_master_get_devdata(qspi->master);\r\nulong clk_rate;\r\nu32 config_reg, req_hz, baud_rate_val = 0;\r\nif (transfer)\r\nreq_hz = transfer->speed_hz;\r\nelse\r\nreq_hz = qspi->max_speed_hz;\r\nclk_rate = clk_get_rate(xqspi->refclk);\r\nwhile ((baud_rate_val < GQSPI_BAUD_DIV_MAX) &&\r\n(clk_rate /\r\n(GQSPI_BAUD_DIV_SHIFT << baud_rate_val)) > req_hz)\r\nbaud_rate_val++;\r\nconfig_reg = zynqmp_gqspi_read(xqspi, GQSPI_CONFIG_OFST);\r\nconfig_reg &= (~GQSPI_CFG_CLK_PHA_MASK) & (~GQSPI_CFG_CLK_POL_MASK);\r\nif (qspi->mode & SPI_CPHA)\r\nconfig_reg |= GQSPI_CFG_CLK_PHA_MASK;\r\nif (qspi->mode & SPI_CPOL)\r\nconfig_reg |= GQSPI_CFG_CLK_POL_MASK;\r\nconfig_reg &= ~GQSPI_CFG_BAUD_RATE_DIV_MASK;\r\nconfig_reg |= (baud_rate_val << GQSPI_CFG_BAUD_RATE_DIV_SHIFT);\r\nzynqmp_gqspi_write(xqspi, GQSPI_CONFIG_OFST, config_reg);\r\nreturn 0;\r\n}\r\nstatic int zynqmp_qspi_setup(struct spi_device *qspi)\r\n{\r\nif (qspi->master->busy)\r\nreturn -EBUSY;\r\nreturn 0;\r\n}\r\nstatic void zynqmp_qspi_filltxfifo(struct zynqmp_qspi *xqspi, int size)\r\n{\r\nu32 count = 0, intermediate;\r\nwhile ((xqspi->bytes_to_transfer > 0) && (count < size)) {\r\nmemcpy(&intermediate, xqspi->txbuf, 4);\r\nzynqmp_gqspi_write(xqspi, GQSPI_TXD_OFST, intermediate);\r\nif (xqspi->bytes_to_transfer >= 4) {\r\nxqspi->txbuf += 4;\r\nxqspi->bytes_to_transfer -= 4;\r\n} else {\r\nxqspi->txbuf += xqspi->bytes_to_transfer;\r\nxqspi->bytes_to_transfer = 0;\r\n}\r\ncount++;\r\n}\r\n}\r\nstatic void zynqmp_qspi_readrxfifo(struct zynqmp_qspi *xqspi, u32 size)\r\n{\r\nulong data;\r\nint count = 0;\r\nwhile ((count < size) && (xqspi->bytes_to_receive > 0)) {\r\nif (xqspi->bytes_to_receive >= 4) {\r\n(*(u32 *) xqspi->rxbuf) =\r\nzynqmp_gqspi_read(xqspi, GQSPI_RXD_OFST);\r\nxqspi->rxbuf += 4;\r\nxqspi->bytes_to_receive -= 4;\r\ncount += 4;\r\n} else {\r\ndata = zynqmp_gqspi_read(xqspi, GQSPI_RXD_OFST);\r\ncount += xqspi->bytes_to_receive;\r\nzynqmp_qspi_copy_read_data(xqspi, data,\r\nxqspi->bytes_to_receive);\r\nxqspi->bytes_to_receive = 0;\r\n}\r\n}\r\n}\r\nstatic void zynqmp_process_dma_irq(struct zynqmp_qspi *xqspi)\r\n{\r\nu32 config_reg, genfifoentry;\r\ndma_unmap_single(xqspi->dev, xqspi->dma_addr,\r\nxqspi->dma_rx_bytes, DMA_FROM_DEVICE);\r\nxqspi->rxbuf += xqspi->dma_rx_bytes;\r\nxqspi->bytes_to_receive -= xqspi->dma_rx_bytes;\r\nxqspi->dma_rx_bytes = 0;\r\nzynqmp_gqspi_write(xqspi, GQSPI_QSPIDMA_DST_I_DIS_OFST,\r\nGQSPI_QSPIDMA_DST_I_EN_DONE_MASK);\r\nif (xqspi->bytes_to_receive > 0) {\r\nconfig_reg = zynqmp_gqspi_read(xqspi, GQSPI_CONFIG_OFST);\r\nconfig_reg &= ~GQSPI_CFG_MODE_EN_MASK;\r\nzynqmp_gqspi_write(xqspi, GQSPI_CONFIG_OFST, config_reg);\r\ngenfifoentry = xqspi->genfifoentry;\r\ngenfifoentry |= xqspi->bytes_to_receive;\r\nzynqmp_gqspi_write(xqspi, GQSPI_GEN_FIFO_OFST, genfifoentry);\r\nzynqmp_gqspi_write(xqspi, GQSPI_GEN_FIFO_OFST, 0x0);\r\nzynqmp_gqspi_write(xqspi, GQSPI_CONFIG_OFST,\r\n(zynqmp_gqspi_read(xqspi, GQSPI_CONFIG_OFST) |\r\nGQSPI_CFG_START_GEN_FIFO_MASK));\r\nzynqmp_gqspi_write(xqspi, GQSPI_IER_OFST,\r\nGQSPI_IER_GENFIFOEMPTY_MASK |\r\nGQSPI_IER_RXNEMPTY_MASK |\r\nGQSPI_IER_RXEMPTY_MASK);\r\n}\r\n}\r\nstatic irqreturn_t zynqmp_qspi_irq(int irq, void *dev_id)\r\n{\r\nstruct spi_master *master = dev_id;\r\nstruct zynqmp_qspi *xqspi = spi_master_get_devdata(master);\r\nint ret = IRQ_NONE;\r\nu32 status, mask, dma_status = 0;\r\nstatus = zynqmp_gqspi_read(xqspi, GQSPI_ISR_OFST);\r\nzynqmp_gqspi_write(xqspi, GQSPI_ISR_OFST, status);\r\nmask = (status & ~(zynqmp_gqspi_read(xqspi, GQSPI_IMASK_OFST)));\r\nif (xqspi->mode == GQSPI_MODE_DMA) {\r\ndma_status =\r\nzynqmp_gqspi_read(xqspi, GQSPI_QSPIDMA_DST_I_STS_OFST);\r\nzynqmp_gqspi_write(xqspi, GQSPI_QSPIDMA_DST_I_STS_OFST,\r\ndma_status);\r\n}\r\nif (mask & GQSPI_ISR_TXNOT_FULL_MASK) {\r\nzynqmp_qspi_filltxfifo(xqspi, GQSPI_TX_FIFO_FILL);\r\nret = IRQ_HANDLED;\r\n}\r\nif (dma_status & GQSPI_QSPIDMA_DST_I_STS_DONE_MASK) {\r\nzynqmp_process_dma_irq(xqspi);\r\nret = IRQ_HANDLED;\r\n} else if (!(mask & GQSPI_IER_RXEMPTY_MASK) &&\r\n(mask & GQSPI_IER_GENFIFOEMPTY_MASK)) {\r\nzynqmp_qspi_readrxfifo(xqspi, GQSPI_RX_FIFO_FILL);\r\nret = IRQ_HANDLED;\r\n}\r\nif ((xqspi->bytes_to_receive == 0) && (xqspi->bytes_to_transfer == 0)\r\n&& ((status & GQSPI_IRQ_MASK) == GQSPI_IRQ_MASK)) {\r\nzynqmp_gqspi_write(xqspi, GQSPI_IDR_OFST, GQSPI_ISR_IDR_MASK);\r\nspi_finalize_current_transfer(master);\r\nret = IRQ_HANDLED;\r\n}\r\nreturn ret;\r\n}\r\nstatic inline u32 zynqmp_qspi_selectspimode(struct zynqmp_qspi *xqspi,\r\nu8 spimode)\r\n{\r\nu32 mask = 0;\r\nswitch (spimode) {\r\ncase GQSPI_SELECT_MODE_DUALSPI:\r\nmask = GQSPI_GENFIFO_MODE_DUALSPI;\r\nbreak;\r\ncase GQSPI_SELECT_MODE_QUADSPI:\r\nmask = GQSPI_GENFIFO_MODE_QUADSPI;\r\nbreak;\r\ncase GQSPI_SELECT_MODE_SPI:\r\nmask = GQSPI_GENFIFO_MODE_SPI;\r\nbreak;\r\ndefault:\r\ndev_warn(xqspi->dev, "Invalid SPI mode\n");\r\n}\r\nreturn mask;\r\n}\r\nstatic void zynq_qspi_setuprxdma(struct zynqmp_qspi *xqspi)\r\n{\r\nu32 rx_bytes, rx_rem, config_reg;\r\ndma_addr_t addr;\r\nu64 dma_align = (u64)(uintptr_t)xqspi->rxbuf;\r\nif ((xqspi->bytes_to_receive < 8) ||\r\n((dma_align & GQSPI_DMA_UNALIGN) != 0x0)) {\r\nconfig_reg = zynqmp_gqspi_read(xqspi, GQSPI_CONFIG_OFST);\r\nconfig_reg &= ~GQSPI_CFG_MODE_EN_MASK;\r\nzynqmp_gqspi_write(xqspi, GQSPI_CONFIG_OFST, config_reg);\r\nxqspi->mode = GQSPI_MODE_IO;\r\nxqspi->dma_rx_bytes = 0;\r\nreturn;\r\n}\r\nrx_rem = xqspi->bytes_to_receive % 4;\r\nrx_bytes = (xqspi->bytes_to_receive - rx_rem);\r\naddr = dma_map_single(xqspi->dev, (void *)xqspi->rxbuf,\r\nrx_bytes, DMA_FROM_DEVICE);\r\nif (dma_mapping_error(xqspi->dev, addr))\r\ndev_err(xqspi->dev, "ERR:rxdma:memory not mapped\n");\r\nxqspi->dma_rx_bytes = rx_bytes;\r\nxqspi->dma_addr = addr;\r\nzynqmp_gqspi_write(xqspi, GQSPI_QSPIDMA_DST_ADDR_OFST,\r\n(u32)(addr & 0xffffffff));\r\naddr = ((addr >> 16) >> 16);\r\nzynqmp_gqspi_write(xqspi, GQSPI_QSPIDMA_DST_ADDR_MSB_OFST,\r\n((u32)addr) & 0xfff);\r\nconfig_reg = zynqmp_gqspi_read(xqspi, GQSPI_CONFIG_OFST);\r\nconfig_reg &= ~GQSPI_CFG_MODE_EN_MASK;\r\nconfig_reg |= GQSPI_CFG_MODE_EN_DMA_MASK;\r\nzynqmp_gqspi_write(xqspi, GQSPI_CONFIG_OFST, config_reg);\r\nxqspi->mode = GQSPI_MODE_DMA;\r\nzynqmp_gqspi_write(xqspi, GQSPI_QSPIDMA_DST_SIZE_OFST, rx_bytes);\r\n}\r\nstatic void zynqmp_qspi_txrxsetup(struct zynqmp_qspi *xqspi,\r\nstruct spi_transfer *transfer,\r\nu32 *genfifoentry)\r\n{\r\nu32 config_reg;\r\nif ((xqspi->txbuf != NULL) && (xqspi->rxbuf == NULL)) {\r\n*genfifoentry &= ~GQSPI_GENFIFO_RX;\r\n*genfifoentry |= GQSPI_GENFIFO_DATA_XFER;\r\n*genfifoentry |= GQSPI_GENFIFO_TX;\r\n*genfifoentry |=\r\nzynqmp_qspi_selectspimode(xqspi, transfer->tx_nbits);\r\nxqspi->bytes_to_transfer = transfer->len;\r\nif (xqspi->mode == GQSPI_MODE_DMA) {\r\nconfig_reg = zynqmp_gqspi_read(xqspi,\r\nGQSPI_CONFIG_OFST);\r\nconfig_reg &= ~GQSPI_CFG_MODE_EN_MASK;\r\nzynqmp_gqspi_write(xqspi, GQSPI_CONFIG_OFST,\r\nconfig_reg);\r\nxqspi->mode = GQSPI_MODE_IO;\r\n}\r\nzynqmp_qspi_filltxfifo(xqspi, GQSPI_TXD_DEPTH);\r\nxqspi->bytes_to_receive = 0;\r\n} else if ((xqspi->txbuf == NULL) && (xqspi->rxbuf != NULL)) {\r\n*genfifoentry &= ~GQSPI_GENFIFO_TX;\r\n*genfifoentry |= GQSPI_GENFIFO_DATA_XFER;\r\n*genfifoentry |= GQSPI_GENFIFO_RX;\r\n*genfifoentry |=\r\nzynqmp_qspi_selectspimode(xqspi, transfer->rx_nbits);\r\nxqspi->bytes_to_transfer = 0;\r\nxqspi->bytes_to_receive = transfer->len;\r\nzynq_qspi_setuprxdma(xqspi);\r\n}\r\n}\r\nstatic int zynqmp_qspi_start_transfer(struct spi_master *master,\r\nstruct spi_device *qspi,\r\nstruct spi_transfer *transfer)\r\n{\r\nstruct zynqmp_qspi *xqspi = spi_master_get_devdata(master);\r\nu32 genfifoentry = 0x0, transfer_len;\r\nxqspi->txbuf = transfer->tx_buf;\r\nxqspi->rxbuf = transfer->rx_buf;\r\nzynqmp_qspi_setup_transfer(qspi, transfer);\r\ngenfifoentry |= xqspi->genfifocs;\r\ngenfifoentry |= xqspi->genfifobus;\r\nzynqmp_qspi_txrxsetup(xqspi, transfer, &genfifoentry);\r\nif (xqspi->mode == GQSPI_MODE_DMA)\r\ntransfer_len = xqspi->dma_rx_bytes;\r\nelse\r\ntransfer_len = transfer->len;\r\nxqspi->genfifoentry = genfifoentry;\r\nif ((transfer_len) < GQSPI_GENFIFO_IMM_DATA_MASK) {\r\ngenfifoentry &= ~GQSPI_GENFIFO_IMM_DATA_MASK;\r\ngenfifoentry |= transfer_len;\r\nzynqmp_gqspi_write(xqspi, GQSPI_GEN_FIFO_OFST, genfifoentry);\r\n} else {\r\nint tempcount = transfer_len;\r\nu32 exponent = 8;\r\nu8 imm_data = tempcount & 0xFF;\r\ntempcount &= ~(tempcount & 0xFF);\r\nif (tempcount != 0) {\r\ngenfifoentry |= GQSPI_GENFIFO_EXP;\r\nwhile (tempcount != 0) {\r\nif (tempcount & GQSPI_GENFIFO_EXP_START) {\r\ngenfifoentry &=\r\n~GQSPI_GENFIFO_IMM_DATA_MASK;\r\ngenfifoentry |= exponent;\r\nzynqmp_gqspi_write(xqspi,\r\nGQSPI_GEN_FIFO_OFST,\r\ngenfifoentry);\r\n}\r\ntempcount = tempcount >> 1;\r\nexponent++;\r\n}\r\n}\r\nif (imm_data != 0) {\r\ngenfifoentry &= ~GQSPI_GENFIFO_EXP;\r\ngenfifoentry &= ~GQSPI_GENFIFO_IMM_DATA_MASK;\r\ngenfifoentry |= (u8) (imm_data & 0xFF);\r\nzynqmp_gqspi_write(xqspi,\r\nGQSPI_GEN_FIFO_OFST, genfifoentry);\r\n}\r\n}\r\nif ((xqspi->mode == GQSPI_MODE_IO) &&\r\n(xqspi->rxbuf != NULL)) {\r\nzynqmp_gqspi_write(xqspi, GQSPI_GEN_FIFO_OFST, 0x0);\r\n}\r\nzynqmp_gqspi_write(xqspi, GQSPI_CONFIG_OFST,\r\nzynqmp_gqspi_read(xqspi, GQSPI_CONFIG_OFST) |\r\nGQSPI_CFG_START_GEN_FIFO_MASK);\r\nif (xqspi->txbuf != NULL)\r\nzynqmp_gqspi_write(xqspi, GQSPI_IER_OFST,\r\nGQSPI_IER_TXEMPTY_MASK |\r\nGQSPI_IER_GENFIFOEMPTY_MASK |\r\nGQSPI_IER_TXNOT_FULL_MASK);\r\nif (xqspi->rxbuf != NULL) {\r\nif (xqspi->mode == GQSPI_MODE_DMA) {\r\nzynqmp_gqspi_write(xqspi,\r\nGQSPI_QSPIDMA_DST_I_EN_OFST,\r\nGQSPI_QSPIDMA_DST_I_EN_DONE_MASK);\r\n} else {\r\nzynqmp_gqspi_write(xqspi, GQSPI_IER_OFST,\r\nGQSPI_IER_GENFIFOEMPTY_MASK |\r\nGQSPI_IER_RXNEMPTY_MASK |\r\nGQSPI_IER_RXEMPTY_MASK);\r\n}\r\n}\r\nreturn transfer->len;\r\n}\r\nstatic int __maybe_unused zynqmp_qspi_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct spi_master *master = platform_get_drvdata(pdev);\r\nspi_master_suspend(master);\r\nzynqmp_unprepare_transfer_hardware(master);\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused zynqmp_qspi_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct spi_master *master = platform_get_drvdata(pdev);\r\nstruct zynqmp_qspi *xqspi = spi_master_get_devdata(master);\r\nint ret = 0;\r\nret = clk_enable(xqspi->pclk);\r\nif (ret) {\r\ndev_err(dev, "Cannot enable APB clock.\n");\r\nreturn ret;\r\n}\r\nret = clk_enable(xqspi->refclk);\r\nif (ret) {\r\ndev_err(dev, "Cannot enable device clock.\n");\r\nclk_disable(xqspi->pclk);\r\nreturn ret;\r\n}\r\nspi_master_resume(master);\r\nreturn 0;\r\n}\r\nstatic int zynqmp_qspi_probe(struct platform_device *pdev)\r\n{\r\nint ret = 0;\r\nstruct spi_master *master;\r\nstruct zynqmp_qspi *xqspi;\r\nstruct resource *res;\r\nstruct device *dev = &pdev->dev;\r\nmaster = spi_alloc_master(&pdev->dev, sizeof(*xqspi));\r\nif (!master)\r\nreturn -ENOMEM;\r\nxqspi = spi_master_get_devdata(master);\r\nmaster->dev.of_node = pdev->dev.of_node;\r\nplatform_set_drvdata(pdev, master);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nxqspi->regs = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(xqspi->regs)) {\r\nret = PTR_ERR(xqspi->regs);\r\ngoto remove_master;\r\n}\r\nxqspi->dev = dev;\r\nxqspi->pclk = devm_clk_get(&pdev->dev, "pclk");\r\nif (IS_ERR(xqspi->pclk)) {\r\ndev_err(dev, "pclk clock not found.\n");\r\nret = PTR_ERR(xqspi->pclk);\r\ngoto remove_master;\r\n}\r\nret = clk_prepare_enable(xqspi->pclk);\r\nif (ret) {\r\ndev_err(dev, "Unable to enable APB clock.\n");\r\ngoto remove_master;\r\n}\r\nxqspi->refclk = devm_clk_get(&pdev->dev, "ref_clk");\r\nif (IS_ERR(xqspi->refclk)) {\r\ndev_err(dev, "ref_clk clock not found.\n");\r\nret = PTR_ERR(xqspi->refclk);\r\ngoto clk_dis_pclk;\r\n}\r\nret = clk_prepare_enable(xqspi->refclk);\r\nif (ret) {\r\ndev_err(dev, "Unable to enable device clock.\n");\r\ngoto clk_dis_pclk;\r\n}\r\nzynqmp_qspi_init_hw(xqspi);\r\nxqspi->irq = platform_get_irq(pdev, 0);\r\nif (xqspi->irq <= 0) {\r\nret = -ENXIO;\r\ndev_err(dev, "irq resource not found\n");\r\ngoto clk_dis_all;\r\n}\r\nret = devm_request_irq(&pdev->dev, xqspi->irq, zynqmp_qspi_irq,\r\n0, pdev->name, master);\r\nif (ret != 0) {\r\nret = -ENXIO;\r\ndev_err(dev, "request_irq failed\n");\r\ngoto clk_dis_all;\r\n}\r\nmaster->num_chipselect = GQSPI_DEFAULT_NUM_CS;\r\nmaster->setup = zynqmp_qspi_setup;\r\nmaster->set_cs = zynqmp_qspi_chipselect;\r\nmaster->transfer_one = zynqmp_qspi_start_transfer;\r\nmaster->prepare_transfer_hardware = zynqmp_prepare_transfer_hardware;\r\nmaster->unprepare_transfer_hardware =\r\nzynqmp_unprepare_transfer_hardware;\r\nmaster->max_speed_hz = clk_get_rate(xqspi->refclk) / 2;\r\nmaster->bits_per_word_mask = SPI_BPW_MASK(8);\r\nmaster->mode_bits = SPI_CPOL | SPI_CPHA | SPI_RX_DUAL | SPI_RX_QUAD |\r\nSPI_TX_DUAL | SPI_TX_QUAD;\r\nif (master->dev.parent == NULL)\r\nmaster->dev.parent = &master->dev;\r\nret = spi_register_master(master);\r\nif (ret)\r\ngoto clk_dis_all;\r\nreturn 0;\r\nclk_dis_all:\r\nclk_disable_unprepare(xqspi->refclk);\r\nclk_dis_pclk:\r\nclk_disable_unprepare(xqspi->pclk);\r\nremove_master:\r\nspi_master_put(master);\r\nreturn ret;\r\n}\r\nstatic int zynqmp_qspi_remove(struct platform_device *pdev)\r\n{\r\nstruct spi_master *master = platform_get_drvdata(pdev);\r\nstruct zynqmp_qspi *xqspi = spi_master_get_devdata(master);\r\nzynqmp_gqspi_write(xqspi, GQSPI_EN_OFST, 0x0);\r\nclk_disable_unprepare(xqspi->refclk);\r\nclk_disable_unprepare(xqspi->pclk);\r\nspi_unregister_master(master);\r\nreturn 0;\r\n}

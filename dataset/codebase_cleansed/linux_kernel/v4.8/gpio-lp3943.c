static int lp3943_gpio_request(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct lp3943_gpio *lp3943_gpio = gpiochip_get_data(chip);\r\nstruct lp3943 *lp3943 = lp3943_gpio->lp3943;\r\nif (test_and_set_bit(offset, &lp3943->pin_used))\r\nreturn -EBUSY;\r\nreturn 0;\r\n}\r\nstatic void lp3943_gpio_free(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct lp3943_gpio *lp3943_gpio = gpiochip_get_data(chip);\r\nstruct lp3943 *lp3943 = lp3943_gpio->lp3943;\r\nclear_bit(offset, &lp3943->pin_used);\r\n}\r\nstatic int lp3943_gpio_set_mode(struct lp3943_gpio *lp3943_gpio, u8 offset,\r\nu8 val)\r\n{\r\nstruct lp3943 *lp3943 = lp3943_gpio->lp3943;\r\nconst struct lp3943_reg_cfg *mux = lp3943->mux_cfg;\r\nreturn lp3943_update_bits(lp3943, mux[offset].reg, mux[offset].mask,\r\nval << mux[offset].shift);\r\n}\r\nstatic int lp3943_gpio_direction_input(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct lp3943_gpio *lp3943_gpio = gpiochip_get_data(chip);\r\nlp3943_gpio->input_mask |= BIT(offset);\r\nreturn lp3943_gpio_set_mode(lp3943_gpio, offset, LP3943_GPIO_IN);\r\n}\r\nstatic int lp3943_get_gpio_in_status(struct lp3943_gpio *lp3943_gpio,\r\nstruct gpio_chip *chip, unsigned offset)\r\n{\r\nu8 addr, read;\r\nint err;\r\nswitch (offset) {\r\ncase LP3943_GPIO1 ... LP3943_GPIO8:\r\naddr = LP3943_REG_GPIO_A;\r\nbreak;\r\ncase LP3943_GPIO9 ... LP3943_GPIO16:\r\naddr = LP3943_REG_GPIO_B;\r\noffset = offset - 8;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nerr = lp3943_read_byte(lp3943_gpio->lp3943, addr, &read);\r\nif (err)\r\nreturn err;\r\nreturn !!(read & BIT(offset));\r\n}\r\nstatic int lp3943_get_gpio_out_status(struct lp3943_gpio *lp3943_gpio,\r\nstruct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct lp3943 *lp3943 = lp3943_gpio->lp3943;\r\nconst struct lp3943_reg_cfg *mux = lp3943->mux_cfg;\r\nu8 read;\r\nint err;\r\nerr = lp3943_read_byte(lp3943, mux[offset].reg, &read);\r\nif (err)\r\nreturn err;\r\nread = (read & mux[offset].mask) >> mux[offset].shift;\r\nif (read == LP3943_GPIO_OUT_HIGH)\r\nreturn 1;\r\nelse if (read == LP3943_GPIO_OUT_LOW)\r\nreturn 0;\r\nelse\r\nreturn -EINVAL;\r\n}\r\nstatic int lp3943_gpio_get(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct lp3943_gpio *lp3943_gpio = gpiochip_get_data(chip);\r\nif (lp3943_gpio->input_mask & BIT(offset))\r\nreturn lp3943_get_gpio_in_status(lp3943_gpio, chip, offset);\r\nelse\r\nreturn lp3943_get_gpio_out_status(lp3943_gpio, chip, offset);\r\n}\r\nstatic void lp3943_gpio_set(struct gpio_chip *chip, unsigned offset, int value)\r\n{\r\nstruct lp3943_gpio *lp3943_gpio = gpiochip_get_data(chip);\r\nu8 data;\r\nif (value)\r\ndata = LP3943_GPIO_OUT_HIGH;\r\nelse\r\ndata = LP3943_GPIO_OUT_LOW;\r\nlp3943_gpio_set_mode(lp3943_gpio, offset, data);\r\n}\r\nstatic int lp3943_gpio_direction_output(struct gpio_chip *chip, unsigned offset,\r\nint value)\r\n{\r\nstruct lp3943_gpio *lp3943_gpio = gpiochip_get_data(chip);\r\nlp3943_gpio_set(chip, offset, value);\r\nlp3943_gpio->input_mask &= ~BIT(offset);\r\nreturn 0;\r\n}\r\nstatic int lp3943_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct lp3943 *lp3943 = dev_get_drvdata(pdev->dev.parent);\r\nstruct lp3943_gpio *lp3943_gpio;\r\nlp3943_gpio = devm_kzalloc(&pdev->dev, sizeof(*lp3943_gpio),\r\nGFP_KERNEL);\r\nif (!lp3943_gpio)\r\nreturn -ENOMEM;\r\nlp3943_gpio->lp3943 = lp3943;\r\nlp3943_gpio->chip = lp3943_gpio_chip;\r\nlp3943_gpio->chip.parent = &pdev->dev;\r\nplatform_set_drvdata(pdev, lp3943_gpio);\r\nreturn devm_gpiochip_add_data(&pdev->dev, &lp3943_gpio->chip,\r\nlp3943_gpio);\r\n}

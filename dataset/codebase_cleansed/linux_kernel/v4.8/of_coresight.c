static int of_dev_node_match(struct device *dev, void *data)\r\n{\r\nreturn dev->of_node == data;\r\n}\r\nstatic struct device *\r\nof_coresight_get_endpoint_device(struct device_node *endpoint)\r\n{\r\nstruct device *dev = NULL;\r\ndev = bus_find_device(&platform_bus_type, NULL,\r\nendpoint, of_dev_node_match);\r\nif (dev)\r\nreturn dev;\r\nreturn bus_find_device(&amba_bustype, NULL,\r\nendpoint, of_dev_node_match);\r\n}\r\nstatic void of_coresight_get_ports(struct device_node *node,\r\nint *nr_inport, int *nr_outport)\r\n{\r\nstruct device_node *ep = NULL;\r\nint in = 0, out = 0;\r\ndo {\r\nep = of_graph_get_next_endpoint(node, ep);\r\nif (!ep)\r\nbreak;\r\nif (of_property_read_bool(ep, "slave-mode"))\r\nin++;\r\nelse\r\nout++;\r\n} while (ep);\r\n*nr_inport = in;\r\n*nr_outport = out;\r\n}\r\nstatic int of_coresight_alloc_memory(struct device *dev,\r\nstruct coresight_platform_data *pdata)\r\n{\r\npdata->outports = devm_kzalloc(dev, pdata->nr_outport *\r\nsizeof(*pdata->outports),\r\nGFP_KERNEL);\r\nif (!pdata->outports)\r\nreturn -ENOMEM;\r\npdata->child_names = devm_kzalloc(dev, pdata->nr_outport *\r\nsizeof(*pdata->child_names),\r\nGFP_KERNEL);\r\nif (!pdata->child_names)\r\nreturn -ENOMEM;\r\npdata->child_ports = devm_kzalloc(dev, pdata->nr_outport *\r\nsizeof(*pdata->child_ports),\r\nGFP_KERNEL);\r\nif (!pdata->child_ports)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nstruct coresight_platform_data *of_get_coresight_platform_data(\r\nstruct device *dev, struct device_node *node)\r\n{\r\nint i = 0, ret = 0, cpu;\r\nstruct coresight_platform_data *pdata;\r\nstruct of_endpoint endpoint, rendpoint;\r\nstruct device *rdev;\r\nstruct device_node *dn;\r\nstruct device_node *ep = NULL;\r\nstruct device_node *rparent = NULL;\r\nstruct device_node *rport = NULL;\r\npdata = devm_kzalloc(dev, sizeof(*pdata), GFP_KERNEL);\r\nif (!pdata)\r\nreturn ERR_PTR(-ENOMEM);\r\npdata->name = dev_name(dev);\r\nof_coresight_get_ports(node, &pdata->nr_inport, &pdata->nr_outport);\r\nif (pdata->nr_outport) {\r\nret = of_coresight_alloc_memory(dev, pdata);\r\nif (ret)\r\nreturn ERR_PTR(ret);\r\ndo {\r\nep = of_graph_get_next_endpoint(node, ep);\r\nif (!ep)\r\nbreak;\r\nif (of_find_property(ep, "slave-mode", NULL))\r\ncontinue;\r\nret = of_graph_parse_endpoint(ep, &endpoint);\r\nif (ret)\r\ncontinue;\r\npdata->outports[i] = endpoint.id;\r\nrparent = of_graph_get_remote_port_parent(ep);\r\nrport = of_graph_get_remote_port(ep);\r\nif (!rparent || !rport)\r\ncontinue;\r\nif (of_graph_parse_endpoint(rport, &rendpoint))\r\ncontinue;\r\nrdev = of_coresight_get_endpoint_device(rparent);\r\nif (!rdev)\r\ncontinue;\r\npdata->child_names[i] = dev_name(rdev);\r\npdata->child_ports[i] = rendpoint.id;\r\ni++;\r\n} while (ep);\r\n}\r\npdata->cpu = 0;\r\ndn = of_parse_phandle(node, "cpu", 0);\r\nfor (cpu = 0; dn && cpu < nr_cpu_ids; cpu++) {\r\nif (dn == of_get_cpu_node(cpu, NULL)) {\r\npdata->cpu = cpu;\r\nbreak;\r\n}\r\n}\r\nreturn pdata;\r\n}

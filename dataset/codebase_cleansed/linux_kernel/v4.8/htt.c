int ath10k_htt_connect(struct ath10k_htt *htt)\r\n{\r\nstruct ath10k_htc_svc_conn_req conn_req;\r\nstruct ath10k_htc_svc_conn_resp conn_resp;\r\nint status;\r\nmemset(&conn_req, 0, sizeof(conn_req));\r\nmemset(&conn_resp, 0, sizeof(conn_resp));\r\nconn_req.ep_ops.ep_tx_complete = ath10k_htt_htc_tx_complete;\r\nconn_req.ep_ops.ep_rx_complete = ath10k_htt_htc_t2h_msg_handler;\r\nconn_req.service_id = ATH10K_HTC_SVC_ID_HTT_DATA_MSG;\r\nstatus = ath10k_htc_connect_service(&htt->ar->htc, &conn_req,\r\n&conn_resp);\r\nif (status)\r\nreturn status;\r\nhtt->eid = conn_resp.eid;\r\nreturn 0;\r\n}\r\nint ath10k_htt_init(struct ath10k *ar)\r\n{\r\nstruct ath10k_htt *htt = &ar->htt;\r\nhtt->ar = ar;\r\nhtt->prefetch_len =\r\n36 +\r\n4 +\r\n8 +\r\n2;\r\nswitch (ar->running_fw->fw_file.htt_op_version) {\r\ncase ATH10K_FW_HTT_OP_VERSION_10_4:\r\nar->htt.t2h_msg_types = htt_10_4_t2h_msg_types;\r\nar->htt.t2h_msg_types_max = HTT_10_4_T2H_NUM_MSGS;\r\nbreak;\r\ncase ATH10K_FW_HTT_OP_VERSION_10_1:\r\nar->htt.t2h_msg_types = htt_10x_t2h_msg_types;\r\nar->htt.t2h_msg_types_max = HTT_10X_T2H_NUM_MSGS;\r\nbreak;\r\ncase ATH10K_FW_HTT_OP_VERSION_TLV:\r\nar->htt.t2h_msg_types = htt_tlv_t2h_msg_types;\r\nar->htt.t2h_msg_types_max = HTT_TLV_T2H_NUM_MSGS;\r\nbreak;\r\ncase ATH10K_FW_HTT_OP_VERSION_MAIN:\r\nar->htt.t2h_msg_types = htt_main_t2h_msg_types;\r\nar->htt.t2h_msg_types_max = HTT_MAIN_T2H_NUM_MSGS;\r\nbreak;\r\ncase ATH10K_FW_HTT_OP_VERSION_MAX:\r\ncase ATH10K_FW_HTT_OP_VERSION_UNSET:\r\nWARN_ON(1);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ath10k_htt_verify_version(struct ath10k_htt *htt)\r\n{\r\nstruct ath10k *ar = htt->ar;\r\nath10k_dbg(ar, ATH10K_DBG_BOOT, "htt target version %d.%d\n",\r\nhtt->target_version_major, htt->target_version_minor);\r\nif (htt->target_version_major != 2 &&\r\nhtt->target_version_major != 3) {\r\nath10k_err(ar, "unsupported htt major version %d. supported versions are 2 and 3\n",\r\nhtt->target_version_major);\r\nreturn -ENOTSUPP;\r\n}\r\nreturn 0;\r\n}\r\nint ath10k_htt_setup(struct ath10k_htt *htt)\r\n{\r\nstruct ath10k *ar = htt->ar;\r\nint status;\r\ninit_completion(&htt->target_version_received);\r\nstatus = ath10k_htt_h2t_ver_req_msg(htt);\r\nif (status)\r\nreturn status;\r\nstatus = wait_for_completion_timeout(&htt->target_version_received,\r\nHTT_TARGET_VERSION_TIMEOUT_HZ);\r\nif (status == 0) {\r\nath10k_warn(ar, "htt version request timed out\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nstatus = ath10k_htt_verify_version(htt);\r\nif (status) {\r\nath10k_warn(ar, "failed to verify htt version: %d\n",\r\nstatus);\r\nreturn status;\r\n}\r\nstatus = ath10k_htt_send_frag_desc_bank_cfg(htt);\r\nif (status)\r\nreturn status;\r\nstatus = ath10k_htt_send_rx_ring_cfg_ll(htt);\r\nif (status) {\r\nath10k_warn(ar, "failed to setup rx ring: %d\n",\r\nstatus);\r\nreturn status;\r\n}\r\nstatus = ath10k_htt_h2t_aggr_cfg_msg(htt,\r\nhtt->max_num_ampdu,\r\nhtt->max_num_amsdu);\r\nif (status) {\r\nath10k_warn(ar, "failed to setup amsdu/ampdu limit: %d\n",\r\nstatus);\r\nreturn status;\r\n}\r\nreturn 0;\r\n}

static inline u16 get_beacon_period(u8 *data)\r\n{\r\nu16 bcn_per;\r\nbcn_per = data[0];\r\nbcn_per |= (data[1] << 8);\r\nreturn bcn_per;\r\n}\r\nstatic inline u32 get_beacon_timestamp_lo(u8 *data)\r\n{\r\nu32 time_stamp = 0;\r\nu32 index = MAC_HDR_LEN;\r\ntime_stamp |= data[index++];\r\ntime_stamp |= (data[index++] << 8);\r\ntime_stamp |= (data[index++] << 16);\r\ntime_stamp |= (data[index] << 24);\r\nreturn time_stamp;\r\n}\r\nstatic inline u32 get_beacon_timestamp_hi(u8 *data)\r\n{\r\nu32 time_stamp = 0;\r\nu32 index = (MAC_HDR_LEN + 4);\r\ntime_stamp |= data[index++];\r\ntime_stamp |= (data[index++] << 8);\r\ntime_stamp |= (data[index++] << 16);\r\ntime_stamp |= (data[index] << 24);\r\nreturn time_stamp;\r\n}\r\nstatic inline enum sub_frame_type get_sub_type(u8 *header)\r\n{\r\nreturn ((enum sub_frame_type)(header[0] & 0xFC));\r\n}\r\nstatic inline u8 get_to_ds(u8 *header)\r\n{\r\nreturn (header[1] & 0x01);\r\n}\r\nstatic inline u8 get_from_ds(u8 *header)\r\n{\r\nreturn ((header[1] & 0x02) >> 1);\r\n}\r\nstatic inline void get_address1(u8 *pu8msa, u8 *addr)\r\n{\r\nmemcpy(addr, pu8msa + 4, 6);\r\n}\r\nstatic inline void get_address2(u8 *pu8msa, u8 *addr)\r\n{\r\nmemcpy(addr, pu8msa + 10, 6);\r\n}\r\nstatic inline void get_address3(u8 *pu8msa, u8 *addr)\r\n{\r\nmemcpy(addr, pu8msa + 16, 6);\r\n}\r\nstatic inline void get_BSSID(u8 *data, u8 *bssid)\r\n{\r\nif (get_from_ds(data) == 1)\r\nget_address2(data, bssid);\r\nelse if (get_to_ds(data) == 1)\r\nget_address1(data, bssid);\r\nelse\r\nget_address3(data, bssid);\r\n}\r\nstatic inline void get_ssid(u8 *data, u8 *ssid, u8 *p_ssid_len)\r\n{\r\nu8 len = 0;\r\nu8 i = 0;\r\nu8 j = 0;\r\nlen = data[TAG_PARAM_OFFSET + 1];\r\nj = TAG_PARAM_OFFSET + 2;\r\nif (len >= MAX_SSID_LEN)\r\nlen = 0;\r\nfor (i = 0; i < len; i++, j++)\r\nssid[i] = data[j];\r\nssid[len] = '\0';\r\n*p_ssid_len = len;\r\n}\r\nstatic inline u16 get_cap_info(u8 *data)\r\n{\r\nu16 cap_info = 0;\r\nu16 index = MAC_HDR_LEN;\r\nenum sub_frame_type st;\r\nst = get_sub_type(data);\r\nif ((st == BEACON) || (st == PROBE_RSP))\r\nindex += TIME_STAMP_LEN + BEACON_INTERVAL_LEN;\r\ncap_info = data[index];\r\ncap_info |= (data[index + 1] << 8);\r\nreturn cap_info;\r\n}\r\nstatic inline u16 get_assoc_resp_cap_info(u8 *data)\r\n{\r\nu16 cap_info;\r\ncap_info = data[0];\r\ncap_info |= (data[1] << 8);\r\nreturn cap_info;\r\n}\r\nstatic inline u16 get_asoc_status(u8 *data)\r\n{\r\nu16 asoc_status;\r\nasoc_status = data[3];\r\nasoc_status = (asoc_status << 8) | data[2];\r\nreturn asoc_status;\r\n}\r\nstatic inline u16 get_asoc_id(u8 *data)\r\n{\r\nu16 asoc_id;\r\nasoc_id = data[4];\r\nasoc_id |= (data[5] << 8);\r\nreturn asoc_id;\r\n}\r\nstatic u8 *get_tim_elm(u8 *pu8msa, u16 rx_len, u16 tag_param_offset)\r\n{\r\nu16 index;\r\nindex = tag_param_offset;\r\nwhile (index < (rx_len - FCS_LEN)) {\r\nif (pu8msa[index] == ITIM)\r\nreturn &pu8msa[index];\r\nindex += (IE_HDR_LEN + pu8msa[index + 1]);\r\n}\r\nreturn NULL;\r\n}\r\nstatic u8 get_current_channel_802_11n(u8 *pu8msa, u16 rx_len)\r\n{\r\nu16 index;\r\nindex = TAG_PARAM_OFFSET;\r\nwhile (index < (rx_len - FCS_LEN)) {\r\nif (pu8msa[index] == IDSPARMS)\r\nreturn pu8msa[index + 2];\r\nindex += pu8msa[index + 1] + IE_HDR_LEN;\r\n}\r\nreturn 0;\r\n}\r\ns32 wilc_parse_network_info(u8 *msg_buffer,\r\nstruct network_info **ret_network_info)\r\n{\r\nstruct network_info *network_info = NULL;\r\nu8 msg_type = 0;\r\nu8 msg_id = 0;\r\nu16 msg_len = 0;\r\nu16 wid_id = (u16)WID_NIL;\r\nu16 wid_len = 0;\r\nu8 *wid_val = NULL;\r\nmsg_type = msg_buffer[0];\r\nif ('N' != msg_type)\r\nreturn -EFAULT;\r\nmsg_id = msg_buffer[1];\r\nmsg_len = MAKE_WORD16(msg_buffer[2], msg_buffer[3]);\r\nwid_id = MAKE_WORD16(msg_buffer[4], msg_buffer[5]);\r\nwid_len = MAKE_WORD16(msg_buffer[6], msg_buffer[7]);\r\nwid_val = &msg_buffer[8];\r\n{\r\nu8 *msa = NULL;\r\nu16 rx_len = 0;\r\nu8 *tim_elm = NULL;\r\nu8 *ies = NULL;\r\nu16 ies_len = 0;\r\nu8 index = 0;\r\nu32 tsf_lo;\r\nu32 tsf_hi;\r\nnetwork_info = kzalloc(sizeof(*network_info), GFP_KERNEL);\r\nif (!network_info)\r\nreturn -ENOMEM;\r\nnetwork_info->rssi = wid_val[0];\r\nmsa = &wid_val[1];\r\nrx_len = wid_len - 1;\r\nnetwork_info->cap_info = get_cap_info(msa);\r\nnetwork_info->tsf_lo = get_beacon_timestamp_lo(msa);\r\ntsf_lo = get_beacon_timestamp_lo(msa);\r\ntsf_hi = get_beacon_timestamp_hi(msa);\r\nnetwork_info->tsf_hi = tsf_lo | ((u64)tsf_hi << 32);\r\nget_ssid(msa, network_info->ssid, &network_info->ssid_len);\r\nget_BSSID(msa, network_info->bssid);\r\nnetwork_info->ch = get_current_channel_802_11n(msa,\r\nrx_len + FCS_LEN);\r\nindex = MAC_HDR_LEN + TIME_STAMP_LEN;\r\nnetwork_info->beacon_period = get_beacon_period(msa + index);\r\nindex += BEACON_INTERVAL_LEN + CAP_INFO_LEN;\r\ntim_elm = get_tim_elm(msa, rx_len + FCS_LEN, index);\r\nif (tim_elm)\r\nnetwork_info->dtim_period = tim_elm[3];\r\nies = &msa[TAG_PARAM_OFFSET];\r\nies_len = rx_len - TAG_PARAM_OFFSET;\r\nif (ies_len > 0) {\r\nnetwork_info->ies = kmemdup(ies, ies_len, GFP_KERNEL);\r\nif (!network_info->ies) {\r\nkfree(network_info);\r\nreturn -ENOMEM;\r\n}\r\n}\r\nnetwork_info->ies_len = ies_len;\r\n}\r\n*ret_network_info = network_info;\r\nreturn 0;\r\n}\r\ns32 wilc_parse_assoc_resp_info(u8 *buffer, u32 buffer_len,\r\nstruct connect_resp_info **ret_connect_resp_info)\r\n{\r\nstruct connect_resp_info *connect_resp_info = NULL;\r\nu16 assoc_resp_len = 0;\r\nu8 *ies = NULL;\r\nu16 ies_len = 0;\r\nconnect_resp_info = kzalloc(sizeof(*connect_resp_info), GFP_KERNEL);\r\nif (!connect_resp_info)\r\nreturn -ENOMEM;\r\nassoc_resp_len = (u16)buffer_len;\r\nconnect_resp_info->status = get_asoc_status(buffer);\r\nif (connect_resp_info->status == SUCCESSFUL_STATUSCODE) {\r\nconnect_resp_info->capability = get_assoc_resp_cap_info(buffer);\r\nconnect_resp_info->assoc_id = get_asoc_id(buffer);\r\nies = &buffer[CAP_INFO_LEN + STATUS_CODE_LEN + AID_LEN];\r\nies_len = assoc_resp_len - (CAP_INFO_LEN + STATUS_CODE_LEN +\r\nAID_LEN);\r\nconnect_resp_info->ies = kmemdup(ies, ies_len, GFP_KERNEL);\r\nif (!connect_resp_info->ies) {\r\nkfree(connect_resp_info);\r\nreturn -ENOMEM;\r\n}\r\nconnect_resp_info->ies_len = ies_len;\r\n}\r\n*ret_connect_resp_info = connect_resp_info;\r\nreturn 0;\r\n}

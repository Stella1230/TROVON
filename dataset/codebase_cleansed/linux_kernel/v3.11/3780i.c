static void PaceMsaAccess(unsigned short usDspBaseIO)\r\n{\r\ncond_resched();\r\nudelay(100);\r\ncond_resched();\r\n}\r\nunsigned short dsp3780I_ReadMsaCfg(unsigned short usDspBaseIO,\r\nunsigned long ulMsaAddr)\r\n{\r\nunsigned long flags;\r\nunsigned short val;\r\nPRINTK_3(TRACE_3780I,\r\n"3780i::dsp3780I_ReadMsaCfg entry usDspBaseIO %x ulMsaAddr %lx\n",\r\nusDspBaseIO, ulMsaAddr);\r\nspin_lock_irqsave(&dsp_lock, flags);\r\nOutWordDsp(DSP_MsaAddrLow, (unsigned short) ulMsaAddr);\r\nOutWordDsp(DSP_MsaAddrHigh, (unsigned short) (ulMsaAddr >> 16));\r\nval = InWordDsp(DSP_MsaDataDSISHigh);\r\nspin_unlock_irqrestore(&dsp_lock, flags);\r\nPRINTK_2(TRACE_3780I, "3780i::dsp3780I_ReadMsaCfg exit val %x\n", val);\r\nreturn val;\r\n}\r\nvoid dsp3780I_WriteMsaCfg(unsigned short usDspBaseIO,\r\nunsigned long ulMsaAddr, unsigned short usValue)\r\n{\r\nunsigned long flags;\r\nPRINTK_4(TRACE_3780I,\r\n"3780i::dsp3780i_WriteMsaCfg entry usDspBaseIO %x ulMsaAddr %lx usValue %x\n",\r\nusDspBaseIO, ulMsaAddr, usValue);\r\nspin_lock_irqsave(&dsp_lock, flags);\r\nOutWordDsp(DSP_MsaAddrLow, (unsigned short) ulMsaAddr);\r\nOutWordDsp(DSP_MsaAddrHigh, (unsigned short) (ulMsaAddr >> 16));\r\nOutWordDsp(DSP_MsaDataDSISHigh, usValue);\r\nspin_unlock_irqrestore(&dsp_lock, flags);\r\n}\r\nstatic void dsp3780I_WriteGenCfg(unsigned short usDspBaseIO, unsigned uIndex,\r\nunsigned char ucValue)\r\n{\r\nDSP_ISA_SLAVE_CONTROL rSlaveControl;\r\nDSP_ISA_SLAVE_CONTROL rSlaveControl_Save;\r\nPRINTK_4(TRACE_3780I,\r\n"3780i::dsp3780i_WriteGenCfg entry usDspBaseIO %x uIndex %x ucValue %x\n",\r\nusDspBaseIO, uIndex, ucValue);\r\nMKBYTE(rSlaveControl) = InByteDsp(DSP_IsaSlaveControl);\r\nPRINTK_2(TRACE_3780I,\r\n"3780i::dsp3780i_WriteGenCfg rSlaveControl %x\n",\r\nMKBYTE(rSlaveControl));\r\nrSlaveControl_Save = rSlaveControl;\r\nrSlaveControl.ConfigMode = TRUE;\r\nPRINTK_2(TRACE_3780I,\r\n"3780i::dsp3780i_WriteGenCfg entry rSlaveControl+ConfigMode %x\n",\r\nMKBYTE(rSlaveControl));\r\nOutByteDsp(DSP_IsaSlaveControl, MKBYTE(rSlaveControl));\r\nOutByteDsp(DSP_ConfigAddress, (unsigned char) uIndex);\r\nOutByteDsp(DSP_ConfigData, ucValue);\r\nOutByteDsp(DSP_IsaSlaveControl, MKBYTE(rSlaveControl_Save));\r\nPRINTK_1(TRACE_3780I, "3780i::dsp3780i_WriteGenCfg exit\n");\r\n}\r\nint dsp3780I_EnableDSP(DSP_3780I_CONFIG_SETTINGS * pSettings,\r\nunsigned short *pIrqMap,\r\nunsigned short *pDmaMap)\r\n{\r\nunsigned long flags;\r\nunsigned short usDspBaseIO = pSettings->usDspBaseIO;\r\nint i;\r\nDSP_UART_CFG_1 rUartCfg1;\r\nDSP_UART_CFG_2 rUartCfg2;\r\nDSP_HBRIDGE_CFG_1 rHBridgeCfg1;\r\nDSP_HBRIDGE_CFG_2 rHBridgeCfg2;\r\nDSP_BUSMASTER_CFG_1 rBusmasterCfg1;\r\nDSP_BUSMASTER_CFG_2 rBusmasterCfg2;\r\nDSP_ISA_PROT_CFG rIsaProtCfg;\r\nDSP_POWER_MGMT_CFG rPowerMgmtCfg;\r\nDSP_HBUS_TIMER_CFG rHBusTimerCfg;\r\nDSP_LBUS_TIMEOUT_DISABLE rLBusTimeoutDisable;\r\nDSP_CHIP_RESET rChipReset;\r\nDSP_CLOCK_CONTROL_1 rClockControl1;\r\nDSP_CLOCK_CONTROL_2 rClockControl2;\r\nDSP_ISA_SLAVE_CONTROL rSlaveControl;\r\nDSP_HBRIDGE_CONTROL rHBridgeControl;\r\nunsigned short ChipID = 0;\r\nunsigned short tval;\r\nPRINTK_2(TRACE_3780I,\r\n"3780i::dsp3780I_EnableDSP entry pSettings->bDSPEnabled %x\n",\r\npSettings->bDSPEnabled);\r\nif (!pSettings->bDSPEnabled) {\r\nPRINTK_ERROR( KERN_ERR "3780i::dsp3780I_EnableDSP: Error: DSP not enabled. Aborting.\n" );\r\nreturn -EIO;\r\n}\r\nPRINTK_2(TRACE_3780I,\r\n"3780i::dsp3780i_EnableDSP entry pSettings->bModemEnabled %x\n",\r\npSettings->bModemEnabled);\r\nif (pSettings->bModemEnabled) {\r\nrUartCfg1.Reserved = rUartCfg2.Reserved = 0;\r\nrUartCfg1.IrqActiveLow = pSettings->bUartIrqActiveLow;\r\nrUartCfg1.IrqPulse = pSettings->bUartIrqPulse;\r\nrUartCfg1.Irq =\r\n(unsigned char) pIrqMap[pSettings->usUartIrq];\r\nswitch (pSettings->usUartBaseIO) {\r\ncase 0x03F8:\r\nrUartCfg1.BaseIO = 0;\r\nbreak;\r\ncase 0x02F8:\r\nrUartCfg1.BaseIO = 1;\r\nbreak;\r\ncase 0x03E8:\r\nrUartCfg1.BaseIO = 2;\r\nbreak;\r\ncase 0x02E8:\r\nrUartCfg1.BaseIO = 3;\r\nbreak;\r\n}\r\nrUartCfg2.Enable = TRUE;\r\n}\r\nrHBridgeCfg1.Reserved = rHBridgeCfg2.Reserved = 0;\r\nrHBridgeCfg1.IrqActiveLow = pSettings->bDspIrqActiveLow;\r\nrHBridgeCfg1.IrqPulse = pSettings->bDspIrqPulse;\r\nrHBridgeCfg1.Irq = (unsigned char) pIrqMap[pSettings->usDspIrq];\r\nrHBridgeCfg1.AccessMode = 1;\r\nrHBridgeCfg2.Enable = TRUE;\r\nrBusmasterCfg2.Reserved = 0;\r\nrBusmasterCfg1.Dma = (unsigned char) pDmaMap[pSettings->usDspDma];\r\nrBusmasterCfg1.NumTransfers =\r\n(unsigned char) pSettings->usNumTransfers;\r\nrBusmasterCfg1.ReRequest = (unsigned char) pSettings->usReRequest;\r\nrBusmasterCfg1.MEMCS16 = pSettings->bEnableMEMCS16;\r\nrBusmasterCfg2.IsaMemCmdWidth =\r\n(unsigned char) pSettings->usIsaMemCmdWidth;\r\nrIsaProtCfg.Reserved = 0;\r\nrIsaProtCfg.GateIOCHRDY = pSettings->bGateIOCHRDY;\r\nrPowerMgmtCfg.Reserved = 0;\r\nrPowerMgmtCfg.Enable = pSettings->bEnablePwrMgmt;\r\nrHBusTimerCfg.LoadValue =\r\n(unsigned char) pSettings->usHBusTimerLoadValue;\r\nrLBusTimeoutDisable.Reserved = 0;\r\nrLBusTimeoutDisable.DisableTimeout =\r\npSettings->bDisableLBusTimeout;\r\nMKWORD(rChipReset) = ~pSettings->usChipletEnable;\r\nrClockControl1.Reserved1 = rClockControl1.Reserved2 = 0;\r\nrClockControl1.N_Divisor = pSettings->usN_Divisor;\r\nrClockControl1.M_Multiplier = pSettings->usM_Multiplier;\r\nrClockControl2.Reserved = 0;\r\nrClockControl2.PllBypass = pSettings->bPllBypass;\r\nrSlaveControl.ClockControl = 0;\r\nrSlaveControl.SoftReset = TRUE;\r\nrSlaveControl.ConfigMode = FALSE;\r\nrSlaveControl.Reserved = 0;\r\nPRINTK_4(TRACE_3780I,\r\n"3780i::dsp3780i_EnableDSP usDspBaseIO %x index %x taddr %x\n",\r\nusDspBaseIO, DSP_IsaSlaveControl,\r\nusDspBaseIO + DSP_IsaSlaveControl);\r\nPRINTK_2(TRACE_3780I,\r\n"3780i::dsp3780i_EnableDSP rSlaveContrl %x\n",\r\nMKWORD(rSlaveControl));\r\nspin_lock_irqsave(&dsp_lock, flags);\r\nOutWordDsp(DSP_IsaSlaveControl, MKWORD(rSlaveControl));\r\nMKWORD(tval) = InWordDsp(DSP_IsaSlaveControl);\r\nPRINTK_2(TRACE_3780I,\r\n"3780i::dsp3780i_EnableDSP rSlaveControl 2 %x\n", tval);\r\nfor (i = 0; i < 11; i++)\r\nudelay(2000);\r\nrSlaveControl.SoftReset = FALSE;\r\nOutWordDsp(DSP_IsaSlaveControl, MKWORD(rSlaveControl));\r\nMKWORD(tval) = InWordDsp(DSP_IsaSlaveControl);\r\nPRINTK_2(TRACE_3780I,\r\n"3780i::dsp3780i_EnableDSP rSlaveControl 3 %x\n", tval);\r\nWriteGenCfg(DSP_HBridgeCfg1Index, MKBYTE(rHBridgeCfg1));\r\nWriteGenCfg(DSP_HBridgeCfg2Index, MKBYTE(rHBridgeCfg2));\r\nWriteGenCfg(DSP_BusMasterCfg1Index, MKBYTE(rBusmasterCfg1));\r\nWriteGenCfg(DSP_BusMasterCfg2Index, MKBYTE(rBusmasterCfg2));\r\nWriteGenCfg(DSP_IsaProtCfgIndex, MKBYTE(rIsaProtCfg));\r\nWriteGenCfg(DSP_PowerMgCfgIndex, MKBYTE(rPowerMgmtCfg));\r\nWriteGenCfg(DSP_HBusTimerCfgIndex, MKBYTE(rHBusTimerCfg));\r\nif (pSettings->bModemEnabled) {\r\nWriteGenCfg(DSP_UartCfg1Index, MKBYTE(rUartCfg1));\r\nWriteGenCfg(DSP_UartCfg2Index, MKBYTE(rUartCfg2));\r\n}\r\nrHBridgeControl.EnableDspInt = FALSE;\r\nrHBridgeControl.MemAutoInc = TRUE;\r\nrHBridgeControl.IoAutoInc = FALSE;\r\nrHBridgeControl.DiagnosticMode = FALSE;\r\nPRINTK_3(TRACE_3780I,\r\n"3780i::dsp3780i_EnableDSP DSP_HBridgeControl %x rHBridgeControl %x\n",\r\nDSP_HBridgeControl, MKWORD(rHBridgeControl));\r\nOutWordDsp(DSP_HBridgeControl, MKWORD(rHBridgeControl));\r\nspin_unlock_irqrestore(&dsp_lock, flags);\r\nWriteMsaCfg(DSP_LBusTimeoutDisable, MKWORD(rLBusTimeoutDisable));\r\nWriteMsaCfg(DSP_ClockControl_1, MKWORD(rClockControl1));\r\nWriteMsaCfg(DSP_ClockControl_2, MKWORD(rClockControl2));\r\nWriteMsaCfg(DSP_ChipReset, MKWORD(rChipReset));\r\nChipID = ReadMsaCfg(DSP_ChipID);\r\nPRINTK_2(TRACE_3780I,\r\n"3780i::dsp3780I_EnableDSP exiting bRC=TRUE, ChipID %x\n",\r\nChipID);\r\nreturn 0;\r\n}\r\nint dsp3780I_DisableDSP(DSP_3780I_CONFIG_SETTINGS * pSettings)\r\n{\r\nunsigned long flags;\r\nunsigned short usDspBaseIO = pSettings->usDspBaseIO;\r\nDSP_ISA_SLAVE_CONTROL rSlaveControl;\r\nPRINTK_1(TRACE_3780I, "3780i::dsp3780i_DisableDSP entry\n");\r\nrSlaveControl.ClockControl = 0;\r\nrSlaveControl.SoftReset = TRUE;\r\nrSlaveControl.ConfigMode = FALSE;\r\nrSlaveControl.Reserved = 0;\r\nspin_lock_irqsave(&dsp_lock, flags);\r\nOutWordDsp(DSP_IsaSlaveControl, MKWORD(rSlaveControl));\r\nudelay(5);\r\nrSlaveControl.ClockControl = 1;\r\nOutWordDsp(DSP_IsaSlaveControl, MKWORD(rSlaveControl));\r\nspin_unlock_irqrestore(&dsp_lock, flags);\r\nudelay(5);\r\nPRINTK_1(TRACE_3780I, "3780i::dsp3780i_DisableDSP exit\n");\r\nreturn 0;\r\n}\r\nint dsp3780I_Reset(DSP_3780I_CONFIG_SETTINGS * pSettings)\r\n{\r\nunsigned long flags;\r\nunsigned short usDspBaseIO = pSettings->usDspBaseIO;\r\nDSP_BOOT_DOMAIN rBootDomain;\r\nDSP_HBRIDGE_CONTROL rHBridgeControl;\r\nPRINTK_1(TRACE_3780I, "3780i::dsp3780i_Reset entry\n");\r\nspin_lock_irqsave(&dsp_lock, flags);\r\nMKWORD(rHBridgeControl) = InWordDsp(DSP_HBridgeControl);\r\nPRINTK_2(TRACE_3780I, "3780i::dsp3780i_Reset rHBridgeControl %x\n",\r\nMKWORD(rHBridgeControl));\r\nrHBridgeControl.EnableDspInt = FALSE;\r\nOutWordDsp(DSP_HBridgeControl, MKWORD(rHBridgeControl));\r\nspin_unlock_irqrestore(&dsp_lock, flags);\r\nrBootDomain.ResetCore = TRUE;\r\nrBootDomain.Halt = TRUE;\r\nrBootDomain.NMI = TRUE;\r\nrBootDomain.Reserved = 0;\r\nPRINTK_2(TRACE_3780I, "3780i::dsp3780i_Reset rBootDomain %x\n",\r\nMKWORD(rBootDomain));\r\nWriteMsaCfg(DSP_MspBootDomain, MKWORD(rBootDomain));\r\nWriteMsaCfg(DSP_ChipReset, 0xFFFF);\r\nudelay(5);\r\nWriteMsaCfg(DSP_ChipReset,\r\n(unsigned short) (~pSettings->usChipletEnable));\r\nPRINTK_1(TRACE_3780I, "3780i::dsp3780i_Reset exit bRC=0\n");\r\nreturn 0;\r\n}\r\nint dsp3780I_Run(DSP_3780I_CONFIG_SETTINGS * pSettings)\r\n{\r\nunsigned long flags;\r\nunsigned short usDspBaseIO = pSettings->usDspBaseIO;\r\nDSP_BOOT_DOMAIN rBootDomain;\r\nDSP_HBRIDGE_CONTROL rHBridgeControl;\r\nPRINTK_1(TRACE_3780I, "3780i::dsp3780i_Run entry\n");\r\nrBootDomain.ResetCore = TRUE;\r\nrBootDomain.Halt = FALSE;\r\nrBootDomain.NMI = TRUE;\r\nrBootDomain.Reserved = 0;\r\nWriteMsaCfg(DSP_MspBootDomain, MKWORD(rBootDomain));\r\nudelay(5);\r\nrBootDomain.ResetCore = FALSE;\r\nWriteMsaCfg(DSP_MspBootDomain, MKWORD(rBootDomain));\r\nudelay(5);\r\nrBootDomain.NMI = FALSE;\r\nWriteMsaCfg(DSP_MspBootDomain, MKWORD(rBootDomain));\r\nudelay(5);\r\nspin_lock_irqsave(&dsp_lock, flags);\r\nMKWORD(rHBridgeControl) = InWordDsp(DSP_HBridgeControl);\r\nrHBridgeControl.EnableDspInt = TRUE;\r\nPRINTK_2(TRACE_3780I, "3780i::dsp3780i_Run rHBridgeControl %x\n",\r\nMKWORD(rHBridgeControl));\r\nOutWordDsp(DSP_HBridgeControl, MKWORD(rHBridgeControl));\r\nspin_unlock_irqrestore(&dsp_lock, flags);\r\nPRINTK_1(TRACE_3780I, "3780i::dsp3780i_Run exit bRC=TRUE\n");\r\nreturn 0;\r\n}\r\nint dsp3780I_ReadDStore(unsigned short usDspBaseIO, void __user *pvBuffer,\r\nunsigned uCount, unsigned long ulDSPAddr)\r\n{\r\nunsigned long flags;\r\nunsigned short __user *pusBuffer = pvBuffer;\r\nunsigned short val;\r\nPRINTK_5(TRACE_3780I,\r\n"3780i::dsp3780I_ReadDStore entry usDspBaseIO %x, pusBuffer %p, uCount %x, ulDSPAddr %lx\n",\r\nusDspBaseIO, pusBuffer, uCount, ulDSPAddr);\r\nspin_lock_irqsave(&dsp_lock, flags);\r\nOutWordDsp(DSP_MsaAddrLow, (unsigned short) ulDSPAddr);\r\nOutWordDsp(DSP_MsaAddrHigh, (unsigned short) (ulDSPAddr >> 16));\r\nspin_unlock_irqrestore(&dsp_lock, flags);\r\nwhile (uCount-- != 0) {\r\nspin_lock_irqsave(&dsp_lock, flags);\r\nval = InWordDsp(DSP_MsaDataDSISHigh);\r\nspin_unlock_irqrestore(&dsp_lock, flags);\r\nif(put_user(val, pusBuffer++))\r\nreturn -EFAULT;\r\nPRINTK_3(TRACE_3780I,\r\n"3780I::dsp3780I_ReadDStore uCount %x val %x\n",\r\nuCount, val);\r\nPaceMsaAccess(usDspBaseIO);\r\n}\r\nPRINTK_1(TRACE_3780I,\r\n"3780I::dsp3780I_ReadDStore exit bRC=TRUE\n");\r\nreturn 0;\r\n}\r\nint dsp3780I_ReadAndClearDStore(unsigned short usDspBaseIO,\r\nvoid __user *pvBuffer, unsigned uCount,\r\nunsigned long ulDSPAddr)\r\n{\r\nunsigned long flags;\r\nunsigned short __user *pusBuffer = pvBuffer;\r\nunsigned short val;\r\nPRINTK_5(TRACE_3780I,\r\n"3780i::dsp3780I_ReadAndDStore entry usDspBaseIO %x, pusBuffer %p, uCount %x, ulDSPAddr %lx\n",\r\nusDspBaseIO, pusBuffer, uCount, ulDSPAddr);\r\nspin_lock_irqsave(&dsp_lock, flags);\r\nOutWordDsp(DSP_MsaAddrLow, (unsigned short) ulDSPAddr);\r\nOutWordDsp(DSP_MsaAddrHigh, (unsigned short) (ulDSPAddr >> 16));\r\nspin_unlock_irqrestore(&dsp_lock, flags);\r\nwhile (uCount-- != 0) {\r\nspin_lock_irqsave(&dsp_lock, flags);\r\nval = InWordDsp(DSP_ReadAndClear);\r\nspin_unlock_irqrestore(&dsp_lock, flags);\r\nif(put_user(val, pusBuffer++))\r\nreturn -EFAULT;\r\nPRINTK_3(TRACE_3780I,\r\n"3780I::dsp3780I_ReadAndCleanDStore uCount %x val %x\n",\r\nuCount, val);\r\nPaceMsaAccess(usDspBaseIO);\r\n}\r\nPRINTK_1(TRACE_3780I,\r\n"3780I::dsp3780I_ReadAndClearDStore exit bRC=TRUE\n");\r\nreturn 0;\r\n}\r\nint dsp3780I_WriteDStore(unsigned short usDspBaseIO, void __user *pvBuffer,\r\nunsigned uCount, unsigned long ulDSPAddr)\r\n{\r\nunsigned long flags;\r\nunsigned short __user *pusBuffer = pvBuffer;\r\nPRINTK_5(TRACE_3780I,\r\n"3780i::dsp3780D_WriteDStore entry usDspBaseIO %x, pusBuffer %p, uCount %x, ulDSPAddr %lx\n",\r\nusDspBaseIO, pusBuffer, uCount, ulDSPAddr);\r\nspin_lock_irqsave(&dsp_lock, flags);\r\nOutWordDsp(DSP_MsaAddrLow, (unsigned short) ulDSPAddr);\r\nOutWordDsp(DSP_MsaAddrHigh, (unsigned short) (ulDSPAddr >> 16));\r\nspin_unlock_irqrestore(&dsp_lock, flags);\r\nwhile (uCount-- != 0) {\r\nunsigned short val;\r\nif(get_user(val, pusBuffer++))\r\nreturn -EFAULT;\r\nspin_lock_irqsave(&dsp_lock, flags);\r\nOutWordDsp(DSP_MsaDataDSISHigh, val);\r\nspin_unlock_irqrestore(&dsp_lock, flags);\r\nPRINTK_3(TRACE_3780I,\r\n"3780I::dsp3780I_WriteDStore uCount %x val %x\n",\r\nuCount, val);\r\nPaceMsaAccess(usDspBaseIO);\r\n}\r\nPRINTK_1(TRACE_3780I,\r\n"3780I::dsp3780D_WriteDStore exit bRC=TRUE\n");\r\nreturn 0;\r\n}\r\nint dsp3780I_ReadIStore(unsigned short usDspBaseIO, void __user *pvBuffer,\r\nunsigned uCount, unsigned long ulDSPAddr)\r\n{\r\nunsigned long flags;\r\nunsigned short __user *pusBuffer = pvBuffer;\r\nPRINTK_5(TRACE_3780I,\r\n"3780i::dsp3780I_ReadIStore entry usDspBaseIO %x, pusBuffer %p, uCount %x, ulDSPAddr %lx\n",\r\nusDspBaseIO, pusBuffer, uCount, ulDSPAddr);\r\nulDSPAddr = (ulDSPAddr << 2) | (1 << 22);\r\nspin_lock_irqsave(&dsp_lock, flags);\r\nOutWordDsp(DSP_MsaAddrLow, (unsigned short) ulDSPAddr);\r\nOutWordDsp(DSP_MsaAddrHigh, (unsigned short) (ulDSPAddr >> 16));\r\nspin_unlock_irqrestore(&dsp_lock, flags);\r\nwhile (uCount-- != 0) {\r\nunsigned short val_lo, val_hi;\r\nspin_lock_irqsave(&dsp_lock, flags);\r\nval_lo = InWordDsp(DSP_MsaDataISLow);\r\nval_hi = InWordDsp(DSP_MsaDataDSISHigh);\r\nspin_unlock_irqrestore(&dsp_lock, flags);\r\nif(put_user(val_lo, pusBuffer++))\r\nreturn -EFAULT;\r\nif(put_user(val_hi, pusBuffer++))\r\nreturn -EFAULT;\r\nPRINTK_4(TRACE_3780I,\r\n"3780I::dsp3780I_ReadIStore uCount %x val_lo %x val_hi %x\n",\r\nuCount, val_lo, val_hi);\r\nPaceMsaAccess(usDspBaseIO);\r\n}\r\nPRINTK_1(TRACE_3780I,\r\n"3780I::dsp3780I_ReadIStore exit bRC=TRUE\n");\r\nreturn 0;\r\n}\r\nint dsp3780I_WriteIStore(unsigned short usDspBaseIO, void __user *pvBuffer,\r\nunsigned uCount, unsigned long ulDSPAddr)\r\n{\r\nunsigned long flags;\r\nunsigned short __user *pusBuffer = pvBuffer;\r\nPRINTK_5(TRACE_3780I,\r\n"3780i::dsp3780I_WriteIStore entry usDspBaseIO %x, pusBuffer %p, uCount %x, ulDSPAddr %lx\n",\r\nusDspBaseIO, pusBuffer, uCount, ulDSPAddr);\r\nulDSPAddr = (ulDSPAddr << 2) | (1 << 22);\r\nspin_lock_irqsave(&dsp_lock, flags);\r\nOutWordDsp(DSP_MsaAddrLow, (unsigned short) ulDSPAddr);\r\nOutWordDsp(DSP_MsaAddrHigh, (unsigned short) (ulDSPAddr >> 16));\r\nspin_unlock_irqrestore(&dsp_lock, flags);\r\nwhile (uCount-- != 0) {\r\nunsigned short val_lo, val_hi;\r\nif(get_user(val_lo, pusBuffer++))\r\nreturn -EFAULT;\r\nif(get_user(val_hi, pusBuffer++))\r\nreturn -EFAULT;\r\nspin_lock_irqsave(&dsp_lock, flags);\r\nOutWordDsp(DSP_MsaDataISLow, val_lo);\r\nOutWordDsp(DSP_MsaDataDSISHigh, val_hi);\r\nspin_unlock_irqrestore(&dsp_lock, flags);\r\nPRINTK_4(TRACE_3780I,\r\n"3780I::dsp3780I_WriteIStore uCount %x val_lo %x val_hi %x\n",\r\nuCount, val_lo, val_hi);\r\nPaceMsaAccess(usDspBaseIO);\r\n}\r\nPRINTK_1(TRACE_3780I,\r\n"3780I::dsp3780I_WriteIStore exit bRC=TRUE\n");\r\nreturn 0;\r\n}\r\nint dsp3780I_GetIPCSource(unsigned short usDspBaseIO,\r\nunsigned short *pusIPCSource)\r\n{\r\nunsigned long flags;\r\nDSP_HBRIDGE_CONTROL rHBridgeControl;\r\nunsigned short temp;\r\nPRINTK_3(TRACE_3780I,\r\n"3780i::dsp3780I_GetIPCSource entry usDspBaseIO %x pusIPCSource %p\n",\r\nusDspBaseIO, pusIPCSource);\r\nspin_lock_irqsave(&dsp_lock, flags);\r\nMKWORD(rHBridgeControl) = InWordDsp(DSP_HBridgeControl);\r\nrHBridgeControl.EnableDspInt = FALSE;\r\nOutWordDsp(DSP_HBridgeControl, MKWORD(rHBridgeControl));\r\n*pusIPCSource = InWordDsp(DSP_Interrupt);\r\ntemp = (unsigned short) ~(*pusIPCSource);\r\nPRINTK_3(TRACE_3780I,\r\n"3780i::dsp3780I_GetIPCSource, usIPCSource %x ~ %x\n",\r\n*pusIPCSource, temp);\r\nOutWordDsp(DSP_Interrupt, (unsigned short) ~(*pusIPCSource));\r\nrHBridgeControl.EnableDspInt = TRUE;\r\nOutWordDsp(DSP_HBridgeControl, MKWORD(rHBridgeControl));\r\nspin_unlock_irqrestore(&dsp_lock, flags);\r\nPRINTK_2(TRACE_3780I,\r\n"3780i::dsp3780I_GetIPCSource exit usIPCSource %x\n",\r\n*pusIPCSource);\r\nreturn 0;\r\n}

static int c2_convert_cm_status(u32 c2_status)\r\n{\r\nswitch (c2_status) {\r\ncase C2_CONN_STATUS_SUCCESS:\r\nreturn 0;\r\ncase C2_CONN_STATUS_REJECTED:\r\nreturn -ENETRESET;\r\ncase C2_CONN_STATUS_REFUSED:\r\nreturn -ECONNREFUSED;\r\ncase C2_CONN_STATUS_TIMEDOUT:\r\nreturn -ETIMEDOUT;\r\ncase C2_CONN_STATUS_NETUNREACH:\r\nreturn -ENETUNREACH;\r\ncase C2_CONN_STATUS_HOSTUNREACH:\r\nreturn -EHOSTUNREACH;\r\ncase C2_CONN_STATUS_INVALID_RNIC:\r\nreturn -EINVAL;\r\ncase C2_CONN_STATUS_INVALID_QP:\r\nreturn -EINVAL;\r\ncase C2_CONN_STATUS_INVALID_QP_STATE:\r\nreturn -EINVAL;\r\ncase C2_CONN_STATUS_ADDR_NOT_AVAIL:\r\nreturn -EADDRNOTAVAIL;\r\ndefault:\r\nprintk(KERN_ERR PFX\r\n"%s - Unable to convert CM status: %d\n",\r\n__func__, c2_status);\r\nreturn -EIO;\r\n}\r\n}\r\nstatic const char* to_event_str(int event)\r\n{\r\nstatic const char* event_str[] = {\r\n"CCAE_REMOTE_SHUTDOWN",\r\n"CCAE_ACTIVE_CONNECT_RESULTS",\r\n"CCAE_CONNECTION_REQUEST",\r\n"CCAE_LLP_CLOSE_COMPLETE",\r\n"CCAE_TERMINATE_MESSAGE_RECEIVED",\r\n"CCAE_LLP_CONNECTION_RESET",\r\n"CCAE_LLP_CONNECTION_LOST",\r\n"CCAE_LLP_SEGMENT_SIZE_INVALID",\r\n"CCAE_LLP_INVALID_CRC",\r\n"CCAE_LLP_BAD_FPDU",\r\n"CCAE_INVALID_DDP_VERSION",\r\n"CCAE_INVALID_RDMA_VERSION",\r\n"CCAE_UNEXPECTED_OPCODE",\r\n"CCAE_INVALID_DDP_QUEUE_NUMBER",\r\n"CCAE_RDMA_READ_NOT_ENABLED",\r\n"CCAE_RDMA_WRITE_NOT_ENABLED",\r\n"CCAE_RDMA_READ_TOO_SMALL",\r\n"CCAE_NO_L_BIT",\r\n"CCAE_TAGGED_INVALID_STAG",\r\n"CCAE_TAGGED_BASE_BOUNDS_VIOLATION",\r\n"CCAE_TAGGED_ACCESS_RIGHTS_VIOLATION",\r\n"CCAE_TAGGED_INVALID_PD",\r\n"CCAE_WRAP_ERROR",\r\n"CCAE_BAD_CLOSE",\r\n"CCAE_BAD_LLP_CLOSE",\r\n"CCAE_INVALID_MSN_RANGE",\r\n"CCAE_INVALID_MSN_GAP",\r\n"CCAE_IRRQ_OVERFLOW",\r\n"CCAE_IRRQ_MSN_GAP",\r\n"CCAE_IRRQ_MSN_RANGE",\r\n"CCAE_IRRQ_INVALID_STAG",\r\n"CCAE_IRRQ_BASE_BOUNDS_VIOLATION",\r\n"CCAE_IRRQ_ACCESS_RIGHTS_VIOLATION",\r\n"CCAE_IRRQ_INVALID_PD",\r\n"CCAE_IRRQ_WRAP_ERROR",\r\n"CCAE_CQ_SQ_COMPLETION_OVERFLOW",\r\n"CCAE_CQ_RQ_COMPLETION_ERROR",\r\n"CCAE_QP_SRQ_WQE_ERROR",\r\n"CCAE_QP_LOCAL_CATASTROPHIC_ERROR",\r\n"CCAE_CQ_OVERFLOW",\r\n"CCAE_CQ_OPERATION_ERROR",\r\n"CCAE_SRQ_LIMIT_REACHED",\r\n"CCAE_QP_RQ_LIMIT_REACHED",\r\n"CCAE_SRQ_CATASTROPHIC_ERROR",\r\n"CCAE_RNIC_CATASTROPHIC_ERROR"\r\n};\r\nif (event < CCAE_REMOTE_SHUTDOWN ||\r\nevent > CCAE_RNIC_CATASTROPHIC_ERROR)\r\nreturn "<invalid event>";\r\nevent -= CCAE_REMOTE_SHUTDOWN;\r\nreturn event_str[event];\r\n}\r\nstatic const char *to_qp_state_str(int state)\r\n{\r\nswitch (state) {\r\ncase C2_QP_STATE_IDLE:\r\nreturn "C2_QP_STATE_IDLE";\r\ncase C2_QP_STATE_CONNECTING:\r\nreturn "C2_QP_STATE_CONNECTING";\r\ncase C2_QP_STATE_RTS:\r\nreturn "C2_QP_STATE_RTS";\r\ncase C2_QP_STATE_CLOSING:\r\nreturn "C2_QP_STATE_CLOSING";\r\ncase C2_QP_STATE_TERMINATE:\r\nreturn "C2_QP_STATE_TERMINATE";\r\ncase C2_QP_STATE_ERROR:\r\nreturn "C2_QP_STATE_ERROR";\r\ndefault:\r\nreturn "<invalid QP state>";\r\n};\r\n}\r\nvoid c2_ae_event(struct c2_dev *c2dev, u32 mq_index)\r\n{\r\nstruct c2_mq *mq = c2dev->qptr_array[mq_index];\r\nunion c2wr *wr;\r\nvoid *resource_user_context;\r\nstruct iw_cm_event cm_event;\r\nstruct ib_event ib_event;\r\nenum c2_resource_indicator resource_indicator;\r\nenum c2_event_id event_id;\r\nunsigned long flags;\r\nint status;\r\nwr = c2_mq_consume(mq);\r\nif (!wr)\r\nreturn;\r\nmemset(&ib_event, 0, sizeof(ib_event));\r\nmemset(&cm_event, 0, sizeof(cm_event));\r\nevent_id = c2_wr_get_id(wr);\r\nresource_indicator = be32_to_cpu(wr->ae.ae_generic.resource_type);\r\nresource_user_context =\r\n(void *) (unsigned long) wr->ae.ae_generic.user_context;\r\nstatus = cm_event.status = c2_convert_cm_status(c2_wr_get_result(wr));\r\npr_debug("event received c2_dev=%p, event_id=%d, "\r\n"resource_indicator=%d, user_context=%p, status = %d\n",\r\nc2dev, event_id, resource_indicator, resource_user_context,\r\nstatus);\r\nswitch (resource_indicator) {\r\ncase C2_RES_IND_QP:{\r\nstruct c2_qp *qp = (struct c2_qp *)resource_user_context;\r\nstruct iw_cm_id *cm_id = qp->cm_id;\r\nstruct c2wr_ae_active_connect_results *res;\r\nif (!cm_id) {\r\npr_debug("event received, but cm_id is <nul>, qp=%p!\n",\r\nqp);\r\ngoto ignore_it;\r\n}\r\npr_debug("%s: event = %s, user_context=%llx, "\r\n"resource_type=%x, "\r\n"resource=%x, qp_state=%s\n",\r\n__func__,\r\nto_event_str(event_id),\r\n(unsigned long long) wr->ae.ae_generic.user_context,\r\nbe32_to_cpu(wr->ae.ae_generic.resource_type),\r\nbe32_to_cpu(wr->ae.ae_generic.resource),\r\nto_qp_state_str(be32_to_cpu(wr->ae.ae_generic.qp_state)));\r\nc2_set_qp_state(qp, be32_to_cpu(wr->ae.ae_generic.qp_state));\r\nswitch (event_id) {\r\ncase CCAE_ACTIVE_CONNECT_RESULTS:\r\nres = &wr->ae.ae_active_connect_results;\r\ncm_event.event = IW_CM_EVENT_CONNECT_REPLY;\r\ncm_event.local_addr.sin_addr.s_addr = res->laddr;\r\ncm_event.remote_addr.sin_addr.s_addr = res->raddr;\r\ncm_event.local_addr.sin_port = res->lport;\r\ncm_event.remote_addr.sin_port = res->rport;\r\nif (status == 0) {\r\ncm_event.private_data_len =\r\nbe32_to_cpu(res->private_data_length);\r\ncm_event.private_data = res->private_data;\r\n} else {\r\nspin_lock_irqsave(&qp->lock, flags);\r\nif (qp->cm_id) {\r\nqp->cm_id->rem_ref(qp->cm_id);\r\nqp->cm_id = NULL;\r\n}\r\nspin_unlock_irqrestore(&qp->lock, flags);\r\ncm_event.private_data_len = 0;\r\ncm_event.private_data = NULL;\r\n}\r\nif (cm_id->event_handler)\r\ncm_id->event_handler(cm_id, &cm_event);\r\nbreak;\r\ncase CCAE_TERMINATE_MESSAGE_RECEIVED:\r\ncase CCAE_CQ_SQ_COMPLETION_OVERFLOW:\r\nib_event.device = &c2dev->ibdev;\r\nib_event.element.qp = &qp->ibqp;\r\nib_event.event = IB_EVENT_QP_REQ_ERR;\r\nif (qp->ibqp.event_handler)\r\nqp->ibqp.event_handler(&ib_event,\r\nqp->ibqp.\r\nqp_context);\r\nbreak;\r\ncase CCAE_BAD_CLOSE:\r\ncase CCAE_LLP_CLOSE_COMPLETE:\r\ncase CCAE_LLP_CONNECTION_RESET:\r\ncase CCAE_LLP_CONNECTION_LOST:\r\nBUG_ON(cm_id->event_handler==(void*)0x6b6b6b6b);\r\nspin_lock_irqsave(&qp->lock, flags);\r\nif (qp->cm_id) {\r\nqp->cm_id->rem_ref(qp->cm_id);\r\nqp->cm_id = NULL;\r\n}\r\nspin_unlock_irqrestore(&qp->lock, flags);\r\ncm_event.event = IW_CM_EVENT_CLOSE;\r\ncm_event.status = 0;\r\nif (cm_id->event_handler)\r\ncm_id->event_handler(cm_id, &cm_event);\r\nbreak;\r\ndefault:\r\nBUG_ON(1);\r\npr_debug("%s:%d Unexpected event_id=%d on QP=%p, "\r\n"CM_ID=%p\n",\r\n__func__, __LINE__,\r\nevent_id, qp, cm_id);\r\nbreak;\r\n}\r\nbreak;\r\n}\r\ncase C2_RES_IND_EP:{\r\nstruct c2wr_ae_connection_request *req =\r\n&wr->ae.ae_connection_request;\r\nstruct iw_cm_id *cm_id =\r\n(struct iw_cm_id *)resource_user_context;\r\npr_debug("C2_RES_IND_EP event_id=%d\n", event_id);\r\nif (event_id != CCAE_CONNECTION_REQUEST) {\r\npr_debug("%s: Invalid event_id: %d\n",\r\n__func__, event_id);\r\nbreak;\r\n}\r\ncm_event.event = IW_CM_EVENT_CONNECT_REQUEST;\r\ncm_event.provider_data = (void*)(unsigned long)req->cr_handle;\r\ncm_event.local_addr.sin_addr.s_addr = req->laddr;\r\ncm_event.remote_addr.sin_addr.s_addr = req->raddr;\r\ncm_event.local_addr.sin_port = req->lport;\r\ncm_event.remote_addr.sin_port = req->rport;\r\ncm_event.private_data_len =\r\nbe32_to_cpu(req->private_data_length);\r\ncm_event.private_data = req->private_data;\r\ncm_event.ird = cm_event.ord = 128;\r\nif (cm_id->event_handler)\r\ncm_id->event_handler(cm_id, &cm_event);\r\nbreak;\r\n}\r\ncase C2_RES_IND_CQ:{\r\nstruct c2_cq *cq =\r\n(struct c2_cq *) resource_user_context;\r\npr_debug("IB_EVENT_CQ_ERR\n");\r\nib_event.device = &c2dev->ibdev;\r\nib_event.element.cq = &cq->ibcq;\r\nib_event.event = IB_EVENT_CQ_ERR;\r\nif (cq->ibcq.event_handler)\r\ncq->ibcq.event_handler(&ib_event,\r\ncq->ibcq.cq_context);\r\nbreak;\r\n}\r\ndefault:\r\nprintk("Bad resource indicator = %d\n",\r\nresource_indicator);\r\nbreak;\r\n}\r\nignore_it:\r\nc2_mq_free(mq);\r\n}

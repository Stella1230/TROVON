static int au6610_usb_msg(struct dvb_usb_device *d, u8 operation, u8 addr,\r\nu8 *wbuf, u16 wlen, u8 *rbuf, u16 rlen)\r\n{\r\nint ret;\r\nu16 index;\r\nu8 *usb_buf;\r\nusb_buf = kmalloc(6, GFP_KERNEL);\r\nif (!usb_buf)\r\nreturn -ENOMEM;\r\nswitch (wlen) {\r\ncase 1:\r\nindex = wbuf[0] << 8;\r\nbreak;\r\ncase 2:\r\nindex = wbuf[0] << 8;\r\nindex += wbuf[1];\r\nbreak;\r\ndefault:\r\ndev_err(&d->udev->dev, "%s: wlen=%d, aborting\n",\r\nKBUILD_MODNAME, wlen);\r\nret = -EINVAL;\r\ngoto error;\r\n}\r\nret = usb_control_msg(d->udev, usb_rcvctrlpipe(d->udev, 0), operation,\r\nUSB_TYPE_VENDOR|USB_DIR_IN, addr << 1, index,\r\nusb_buf, 6, AU6610_USB_TIMEOUT);\r\ndvb_usb_dbg_usb_control_msg(d->udev, operation,\r\n(USB_TYPE_VENDOR|USB_DIR_IN), addr << 1, index,\r\nusb_buf, 6);\r\nif (ret < 0)\r\ngoto error;\r\nswitch (operation) {\r\ncase AU6610_REQ_I2C_READ:\r\ncase AU6610_REQ_USB_READ:\r\nrbuf[0] = usb_buf[4];\r\n}\r\nerror:\r\nkfree(usb_buf);\r\nreturn ret;\r\n}\r\nstatic int au6610_i2c_msg(struct dvb_usb_device *d, u8 addr,\r\nu8 *wbuf, u16 wlen, u8 *rbuf, u16 rlen)\r\n{\r\nu8 request;\r\nu8 wo = (rbuf == NULL || rlen == 0);\r\nif (wo) {\r\nrequest = AU6610_REQ_I2C_WRITE;\r\n} else {\r\nrequest = AU6610_REQ_I2C_READ;\r\n}\r\nreturn au6610_usb_msg(d, request, addr, wbuf, wlen, rbuf, rlen);\r\n}\r\nstatic int au6610_i2c_xfer(struct i2c_adapter *adap, struct i2c_msg msg[],\r\nint num)\r\n{\r\nstruct dvb_usb_device *d = i2c_get_adapdata(adap);\r\nint i;\r\nif (num > 2)\r\nreturn -EINVAL;\r\nif (mutex_lock_interruptible(&d->i2c_mutex) < 0)\r\nreturn -EAGAIN;\r\nfor (i = 0; i < num; i++) {\r\nif (i+1 < num && (msg[i+1].flags & I2C_M_RD)) {\r\nif (au6610_i2c_msg(d, msg[i].addr, msg[i].buf,\r\nmsg[i].len, msg[i+1].buf,\r\nmsg[i+1].len) < 0)\r\nbreak;\r\ni++;\r\n} else if (au6610_i2c_msg(d, msg[i].addr, msg[i].buf,\r\nmsg[i].len, NULL, 0) < 0)\r\nbreak;\r\n}\r\nmutex_unlock(&d->i2c_mutex);\r\nreturn i;\r\n}\r\nstatic u32 au6610_i2c_func(struct i2c_adapter *adapter)\r\n{\r\nreturn I2C_FUNC_I2C;\r\n}\r\nstatic int au6610_zl10353_frontend_attach(struct dvb_usb_adapter *adap)\r\n{\r\nadap->fe[0] = dvb_attach(zl10353_attach, &au6610_zl10353_config,\r\n&adap_to_d(adap)->i2c_adap);\r\nif (adap->fe[0] == NULL)\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nstatic int au6610_qt1010_tuner_attach(struct dvb_usb_adapter *adap)\r\n{\r\nreturn dvb_attach(qt1010_attach, adap->fe[0],\r\n&adap_to_d(adap)->i2c_adap,\r\n&au6610_qt1010_config) == NULL ? -ENODEV : 0;\r\n}\r\nstatic int au6610_init(struct dvb_usb_device *d)\r\n{\r\nreturn usb_set_interface(d->udev, 0, 5);\r\n}

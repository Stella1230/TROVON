int jfs_umount(struct super_block *sb)\r\n{\r\nstruct jfs_sb_info *sbi = JFS_SBI(sb);\r\nstruct inode *ipbmap = sbi->ipbmap;\r\nstruct inode *ipimap = sbi->ipimap;\r\nstruct inode *ipaimap = sbi->ipaimap;\r\nstruct inode *ipaimap2 = sbi->ipaimap2;\r\nstruct jfs_log *log;\r\nint rc = 0;\r\njfs_info("UnMount JFS: sb:0x%p", sb);\r\nif ((log = sbi->log))\r\njfs_flush_journal(log, 2);\r\ndiUnmount(ipimap, 0);\r\ndiFreeSpecial(ipimap);\r\nsbi->ipimap = NULL;\r\nipaimap2 = sbi->ipaimap2;\r\nif (ipaimap2) {\r\ndiUnmount(ipaimap2, 0);\r\ndiFreeSpecial(ipaimap2);\r\nsbi->ipaimap2 = NULL;\r\n}\r\nipaimap = sbi->ipaimap;\r\ndiUnmount(ipaimap, 0);\r\ndiFreeSpecial(ipaimap);\r\nsbi->ipaimap = NULL;\r\ndbUnmount(ipbmap, 0);\r\ndiFreeSpecial(ipbmap);\r\nsbi->ipimap = NULL;\r\nfilemap_write_and_wait(sbi->direct_inode->i_mapping);\r\nif (log) {\r\nupdateSuper(sb, FM_CLEAN);\r\nrc = lmLogClose(sb);\r\n}\r\njfs_info("UnMount JFS Complete: rc = %d", rc);\r\nreturn rc;\r\n}\r\nint jfs_umount_rw(struct super_block *sb)\r\n{\r\nstruct jfs_sb_info *sbi = JFS_SBI(sb);\r\nstruct jfs_log *log = sbi->log;\r\nif (!log)\r\nreturn 0;\r\njfs_flush_journal(log, 2);\r\ndbSync(sbi->ipbmap);\r\ndiSync(sbi->ipimap);\r\nfilemap_write_and_wait(sbi->direct_inode->i_mapping);\r\nupdateSuper(sb, FM_CLEAN);\r\nreturn lmLogClose(sb);\r\n}

u32\r\nath5k_hw_num_tx_pending(struct ath5k_hw *ah, unsigned int queue)\r\n{\r\nu32 pending;\r\nAR5K_ASSERT_ENTRY(queue, ah->ah_capabilities.cap_queues.q_tx_num);\r\nif (ah->ah_txq[queue].tqi_type == AR5K_TX_QUEUE_INACTIVE)\r\nreturn false;\r\nif (ah->ah_version == AR5K_AR5210)\r\nreturn false;\r\npending = ath5k_hw_reg_read(ah, AR5K_QUEUE_STATUS(queue));\r\npending &= AR5K_QCU_STS_FRMPENDCNT;\r\nif (!pending && AR5K_REG_READ_Q(ah, AR5K_QCU_TXE, queue))\r\nreturn true;\r\nreturn pending;\r\n}\r\nvoid\r\nath5k_hw_release_tx_queue(struct ath5k_hw *ah, unsigned int queue)\r\n{\r\nif (WARN_ON(queue >= ah->ah_capabilities.cap_queues.q_tx_num))\r\nreturn;\r\nah->ah_txq[queue].tqi_type = AR5K_TX_QUEUE_INACTIVE;\r\nAR5K_Q_DISABLE_BITS(ah->ah_txq_status, queue);\r\n}\r\nstatic u16\r\nath5k_cw_validate(u16 cw_req)\r\n{\r\ncw_req = min(cw_req, (u16)1023);\r\nif (is_power_of_2(cw_req + 1))\r\nreturn cw_req;\r\nif (is_power_of_2(cw_req))\r\nreturn cw_req - 1;\r\ncw_req = (u16) roundup_pow_of_two(cw_req) - 1;\r\nreturn cw_req;\r\n}\r\nint\r\nath5k_hw_get_tx_queueprops(struct ath5k_hw *ah, int queue,\r\nstruct ath5k_txq_info *queue_info)\r\n{\r\nmemcpy(queue_info, &ah->ah_txq[queue], sizeof(struct ath5k_txq_info));\r\nreturn 0;\r\n}\r\nint\r\nath5k_hw_set_tx_queueprops(struct ath5k_hw *ah, int queue,\r\nconst struct ath5k_txq_info *qinfo)\r\n{\r\nstruct ath5k_txq_info *qi;\r\nAR5K_ASSERT_ENTRY(queue, ah->ah_capabilities.cap_queues.q_tx_num);\r\nqi = &ah->ah_txq[queue];\r\nif (qi->tqi_type == AR5K_TX_QUEUE_INACTIVE)\r\nreturn -EIO;\r\nqi->tqi_type = qinfo->tqi_type;\r\nqi->tqi_subtype = qinfo->tqi_subtype;\r\nqi->tqi_flags = qinfo->tqi_flags;\r\nqi->tqi_aifs = min(qinfo->tqi_aifs, (u8)0xFC);\r\nqi->tqi_cw_min = ath5k_cw_validate(qinfo->tqi_cw_min);\r\nqi->tqi_cw_max = ath5k_cw_validate(qinfo->tqi_cw_max);\r\nqi->tqi_cbr_period = qinfo->tqi_cbr_period;\r\nqi->tqi_cbr_overflow_limit = qinfo->tqi_cbr_overflow_limit;\r\nqi->tqi_burst_time = qinfo->tqi_burst_time;\r\nqi->tqi_ready_time = qinfo->tqi_ready_time;\r\nif ((qinfo->tqi_type == AR5K_TX_QUEUE_DATA &&\r\n((qinfo->tqi_subtype == AR5K_WME_AC_VI) ||\r\n(qinfo->tqi_subtype == AR5K_WME_AC_VO))) ||\r\nqinfo->tqi_type == AR5K_TX_QUEUE_UAPSD)\r\nqi->tqi_flags |= AR5K_TXQ_FLAG_POST_FR_BKOFF_DIS;\r\nreturn 0;\r\n}\r\nint\r\nath5k_hw_setup_tx_queue(struct ath5k_hw *ah, enum ath5k_tx_queue queue_type,\r\nstruct ath5k_txq_info *queue_info)\r\n{\r\nunsigned int queue;\r\nint ret;\r\nif (ah->ah_capabilities.cap_queues.q_tx_num == 2) {\r\nswitch (queue_type) {\r\ncase AR5K_TX_QUEUE_DATA:\r\nqueue = AR5K_TX_QUEUE_ID_NOQCU_DATA;\r\nbreak;\r\ncase AR5K_TX_QUEUE_BEACON:\r\ncase AR5K_TX_QUEUE_CAB:\r\nqueue = AR5K_TX_QUEUE_ID_NOQCU_BEACON;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n} else {\r\nswitch (queue_type) {\r\ncase AR5K_TX_QUEUE_DATA:\r\nfor (queue = AR5K_TX_QUEUE_ID_DATA_MIN;\r\nah->ah_txq[queue].tqi_type !=\r\nAR5K_TX_QUEUE_INACTIVE; queue++) {\r\nif (queue > AR5K_TX_QUEUE_ID_DATA_MAX)\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ncase AR5K_TX_QUEUE_UAPSD:\r\nqueue = AR5K_TX_QUEUE_ID_UAPSD;\r\nbreak;\r\ncase AR5K_TX_QUEUE_BEACON:\r\nqueue = AR5K_TX_QUEUE_ID_BEACON;\r\nbreak;\r\ncase AR5K_TX_QUEUE_CAB:\r\nqueue = AR5K_TX_QUEUE_ID_CAB;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nmemset(&ah->ah_txq[queue], 0, sizeof(struct ath5k_txq_info));\r\nah->ah_txq[queue].tqi_type = queue_type;\r\nif (queue_info != NULL) {\r\nqueue_info->tqi_type = queue_type;\r\nret = ath5k_hw_set_tx_queueprops(ah, queue, queue_info);\r\nif (ret)\r\nreturn ret;\r\n}\r\nAR5K_Q_ENABLE_BITS(ah->ah_txq_status, queue);\r\nreturn queue;\r\n}\r\nvoid\r\nath5k_hw_set_tx_retry_limits(struct ath5k_hw *ah,\r\nunsigned int queue)\r\n{\r\nif (ah->ah_version == AR5K_AR5210) {\r\nstruct ath5k_txq_info *tq = &ah->ah_txq[queue];\r\nif (queue > 0)\r\nreturn;\r\nath5k_hw_reg_write(ah,\r\n(tq->tqi_cw_min << AR5K_NODCU_RETRY_LMT_CW_MIN_S)\r\n| AR5K_REG_SM(ah->ah_retry_long,\r\nAR5K_NODCU_RETRY_LMT_SLG_RETRY)\r\n| AR5K_REG_SM(ah->ah_retry_short,\r\nAR5K_NODCU_RETRY_LMT_SSH_RETRY)\r\n| AR5K_REG_SM(ah->ah_retry_long,\r\nAR5K_NODCU_RETRY_LMT_LG_RETRY)\r\n| AR5K_REG_SM(ah->ah_retry_short,\r\nAR5K_NODCU_RETRY_LMT_SH_RETRY),\r\nAR5K_NODCU_RETRY_LMT);\r\n} else {\r\nath5k_hw_reg_write(ah,\r\nAR5K_REG_SM(ah->ah_retry_long,\r\nAR5K_DCU_RETRY_LMT_RTS)\r\n| AR5K_REG_SM(ah->ah_retry_long,\r\nAR5K_DCU_RETRY_LMT_STA_RTS)\r\n| AR5K_REG_SM(max(ah->ah_retry_long, ah->ah_retry_short),\r\nAR5K_DCU_RETRY_LMT_STA_DATA),\r\nAR5K_QUEUE_DFS_RETRY_LIMIT(queue));\r\n}\r\n}\r\nint\r\nath5k_hw_reset_tx_queue(struct ath5k_hw *ah, unsigned int queue)\r\n{\r\nstruct ath5k_txq_info *tq = &ah->ah_txq[queue];\r\nAR5K_ASSERT_ENTRY(queue, ah->ah_capabilities.cap_queues.q_tx_num);\r\ntq = &ah->ah_txq[queue];\r\nif ((ah->ah_version == AR5K_AR5210) ||\r\n(tq->tqi_type == AR5K_TX_QUEUE_INACTIVE))\r\nreturn 0;\r\nath5k_hw_reg_write(ah,\r\nAR5K_REG_SM(tq->tqi_cw_min, AR5K_DCU_LCL_IFS_CW_MIN) |\r\nAR5K_REG_SM(tq->tqi_cw_max, AR5K_DCU_LCL_IFS_CW_MAX) |\r\nAR5K_REG_SM(tq->tqi_aifs, AR5K_DCU_LCL_IFS_AIFS),\r\nAR5K_QUEUE_DFS_LOCAL_IFS(queue));\r\nath5k_hw_set_tx_retry_limits(ah, queue);\r\nAR5K_REG_ENABLE_BITS(ah, AR5K_QUEUE_DFS_MISC(queue),\r\nAR5K_DCU_MISC_FRAG_WAIT);\r\nif (ah->ah_mac_version < AR5K_SREV_AR5211)\r\nAR5K_REG_ENABLE_BITS(ah, AR5K_QUEUE_DFS_MISC(queue),\r\nAR5K_DCU_MISC_SEQNUM_CTL);\r\nif (tq->tqi_cbr_period) {\r\nath5k_hw_reg_write(ah, AR5K_REG_SM(tq->tqi_cbr_period,\r\nAR5K_QCU_CBRCFG_INTVAL) |\r\nAR5K_REG_SM(tq->tqi_cbr_overflow_limit,\r\nAR5K_QCU_CBRCFG_ORN_THRES),\r\nAR5K_QUEUE_CBRCFG(queue));\r\nAR5K_REG_ENABLE_BITS(ah, AR5K_QUEUE_MISC(queue),\r\nAR5K_QCU_MISC_FRSHED_CBR);\r\nif (tq->tqi_cbr_overflow_limit)\r\nAR5K_REG_ENABLE_BITS(ah, AR5K_QUEUE_MISC(queue),\r\nAR5K_QCU_MISC_CBR_THRES_ENABLE);\r\n}\r\nif (tq->tqi_ready_time && (tq->tqi_type != AR5K_TX_QUEUE_CAB))\r\nath5k_hw_reg_write(ah, AR5K_REG_SM(tq->tqi_ready_time,\r\nAR5K_QCU_RDYTIMECFG_INTVAL) |\r\nAR5K_QCU_RDYTIMECFG_ENABLE,\r\nAR5K_QUEUE_RDYTIMECFG(queue));\r\nif (tq->tqi_burst_time) {\r\nath5k_hw_reg_write(ah, AR5K_REG_SM(tq->tqi_burst_time,\r\nAR5K_DCU_CHAN_TIME_DUR) |\r\nAR5K_DCU_CHAN_TIME_ENABLE,\r\nAR5K_QUEUE_DFS_CHANNEL_TIME(queue));\r\nif (tq->tqi_flags & AR5K_TXQ_FLAG_RDYTIME_EXP_POLICY_ENABLE)\r\nAR5K_REG_ENABLE_BITS(ah, AR5K_QUEUE_MISC(queue),\r\nAR5K_QCU_MISC_RDY_VEOL_POLICY);\r\n}\r\nif (tq->tqi_flags & AR5K_TXQ_FLAG_BACKOFF_DISABLE)\r\nath5k_hw_reg_write(ah, AR5K_DCU_MISC_POST_FR_BKOFF_DIS,\r\nAR5K_QUEUE_DFS_MISC(queue));\r\nif (tq->tqi_flags & AR5K_TXQ_FLAG_FRAG_BURST_BACKOFF_ENABLE)\r\nath5k_hw_reg_write(ah, AR5K_DCU_MISC_BACKOFF_FRAG,\r\nAR5K_QUEUE_DFS_MISC(queue));\r\nswitch (tq->tqi_type) {\r\ncase AR5K_TX_QUEUE_BEACON:\r\nAR5K_REG_ENABLE_BITS(ah, AR5K_QUEUE_MISC(queue),\r\nAR5K_QCU_MISC_FRSHED_DBA_GT |\r\nAR5K_QCU_MISC_CBREXP_BCN_DIS |\r\nAR5K_QCU_MISC_BCN_ENABLE);\r\nAR5K_REG_ENABLE_BITS(ah, AR5K_QUEUE_DFS_MISC(queue),\r\n(AR5K_DCU_MISC_ARBLOCK_CTL_GLOBAL <<\r\nAR5K_DCU_MISC_ARBLOCK_CTL_S) |\r\nAR5K_DCU_MISC_ARBLOCK_IGNORE |\r\nAR5K_DCU_MISC_POST_FR_BKOFF_DIS |\r\nAR5K_DCU_MISC_BCN_ENABLE);\r\nbreak;\r\ncase AR5K_TX_QUEUE_CAB:\r\nAR5K_REG_ENABLE_BITS(ah, AR5K_QUEUE_MISC(queue),\r\nAR5K_QCU_MISC_FRSHED_DBA_GT |\r\nAR5K_QCU_MISC_CBREXP_DIS |\r\nAR5K_QCU_MISC_CBREXP_BCN_DIS);\r\nath5k_hw_reg_write(ah, ((tq->tqi_ready_time -\r\n(AR5K_TUNE_SW_BEACON_RESP -\r\nAR5K_TUNE_DMA_BEACON_RESP) -\r\nAR5K_TUNE_ADDITIONAL_SWBA_BACKOFF) * 1024) |\r\nAR5K_QCU_RDYTIMECFG_ENABLE,\r\nAR5K_QUEUE_RDYTIMECFG(queue));\r\nAR5K_REG_ENABLE_BITS(ah, AR5K_QUEUE_DFS_MISC(queue),\r\n(AR5K_DCU_MISC_ARBLOCK_CTL_GLOBAL <<\r\nAR5K_DCU_MISC_ARBLOCK_CTL_S));\r\nbreak;\r\ncase AR5K_TX_QUEUE_UAPSD:\r\nAR5K_REG_ENABLE_BITS(ah, AR5K_QUEUE_MISC(queue),\r\nAR5K_QCU_MISC_CBREXP_DIS);\r\nbreak;\r\ncase AR5K_TX_QUEUE_DATA:\r\ndefault:\r\nbreak;\r\n}\r\nif (tq->tqi_flags & AR5K_TXQ_FLAG_TXOKINT_ENABLE)\r\nAR5K_Q_ENABLE_BITS(ah->ah_txq_imr_txok, queue);\r\nif (tq->tqi_flags & AR5K_TXQ_FLAG_TXERRINT_ENABLE)\r\nAR5K_Q_ENABLE_BITS(ah->ah_txq_imr_txerr, queue);\r\nif (tq->tqi_flags & AR5K_TXQ_FLAG_TXURNINT_ENABLE)\r\nAR5K_Q_ENABLE_BITS(ah->ah_txq_imr_txurn, queue);\r\nif (tq->tqi_flags & AR5K_TXQ_FLAG_TXDESCINT_ENABLE)\r\nAR5K_Q_ENABLE_BITS(ah->ah_txq_imr_txdesc, queue);\r\nif (tq->tqi_flags & AR5K_TXQ_FLAG_TXEOLINT_ENABLE)\r\nAR5K_Q_ENABLE_BITS(ah->ah_txq_imr_txeol, queue);\r\nif (tq->tqi_flags & AR5K_TXQ_FLAG_CBRORNINT_ENABLE)\r\nAR5K_Q_ENABLE_BITS(ah->ah_txq_imr_cbrorn, queue);\r\nif (tq->tqi_flags & AR5K_TXQ_FLAG_CBRURNINT_ENABLE)\r\nAR5K_Q_ENABLE_BITS(ah->ah_txq_imr_cbrurn, queue);\r\nif (tq->tqi_flags & AR5K_TXQ_FLAG_QTRIGINT_ENABLE)\r\nAR5K_Q_ENABLE_BITS(ah->ah_txq_imr_qtrig, queue);\r\nif (tq->tqi_flags & AR5K_TXQ_FLAG_TXNOFRMINT_ENABLE)\r\nAR5K_Q_ENABLE_BITS(ah->ah_txq_imr_nofrm, queue);\r\nah->ah_txq_imr_txok &= ah->ah_txq_status;\r\nah->ah_txq_imr_txerr &= ah->ah_txq_status;\r\nah->ah_txq_imr_txurn &= ah->ah_txq_status;\r\nah->ah_txq_imr_txdesc &= ah->ah_txq_status;\r\nah->ah_txq_imr_txeol &= ah->ah_txq_status;\r\nah->ah_txq_imr_cbrorn &= ah->ah_txq_status;\r\nah->ah_txq_imr_cbrurn &= ah->ah_txq_status;\r\nah->ah_txq_imr_qtrig &= ah->ah_txq_status;\r\nah->ah_txq_imr_nofrm &= ah->ah_txq_status;\r\nath5k_hw_reg_write(ah, AR5K_REG_SM(ah->ah_txq_imr_txok,\r\nAR5K_SIMR0_QCU_TXOK) |\r\nAR5K_REG_SM(ah->ah_txq_imr_txdesc,\r\nAR5K_SIMR0_QCU_TXDESC),\r\nAR5K_SIMR0);\r\nath5k_hw_reg_write(ah, AR5K_REG_SM(ah->ah_txq_imr_txerr,\r\nAR5K_SIMR1_QCU_TXERR) |\r\nAR5K_REG_SM(ah->ah_txq_imr_txeol,\r\nAR5K_SIMR1_QCU_TXEOL),\r\nAR5K_SIMR1);\r\nAR5K_REG_DISABLE_BITS(ah, AR5K_SIMR2, AR5K_SIMR2_QCU_TXURN);\r\nAR5K_REG_ENABLE_BITS(ah, AR5K_SIMR2,\r\nAR5K_REG_SM(ah->ah_txq_imr_txurn,\r\nAR5K_SIMR2_QCU_TXURN));\r\nath5k_hw_reg_write(ah, AR5K_REG_SM(ah->ah_txq_imr_cbrorn,\r\nAR5K_SIMR3_QCBRORN) |\r\nAR5K_REG_SM(ah->ah_txq_imr_cbrurn,\r\nAR5K_SIMR3_QCBRURN),\r\nAR5K_SIMR3);\r\nath5k_hw_reg_write(ah, AR5K_REG_SM(ah->ah_txq_imr_qtrig,\r\nAR5K_SIMR4_QTRIG), AR5K_SIMR4);\r\nath5k_hw_reg_write(ah, AR5K_REG_SM(ah->ah_txq_imr_nofrm,\r\nAR5K_TXNOFRM_QCU), AR5K_TXNOFRM);\r\nif (ah->ah_txq_imr_nofrm == 0)\r\nath5k_hw_reg_write(ah, 0, AR5K_TXNOFRM);\r\nAR5K_REG_WRITE_Q(ah, AR5K_QUEUE_QCUMASK(queue), queue);\r\nreturn 0;\r\n}\r\nint ath5k_hw_set_ifs_intervals(struct ath5k_hw *ah, unsigned int slot_time)\r\n{\r\nstruct ieee80211_channel *channel = ah->ah_current_channel;\r\nenum ieee80211_band band;\r\nstruct ieee80211_rate *rate;\r\nu32 ack_tx_time, eifs, eifs_clock, sifs, sifs_clock;\r\nu32 slot_time_clock = ath5k_hw_htoclock(ah, slot_time);\r\nif (slot_time < 6 || slot_time_clock > AR5K_SLOT_TIME_MAX)\r\nreturn -EINVAL;\r\nsifs = ath5k_hw_get_default_sifs(ah);\r\nsifs_clock = ath5k_hw_htoclock(ah, sifs - 2);\r\nif (channel->band == IEEE80211_BAND_5GHZ)\r\nband = IEEE80211_BAND_5GHZ;\r\nelse\r\nband = IEEE80211_BAND_2GHZ;\r\nrate = &ah->sbands[band].bitrates[0];\r\nack_tx_time = ath5k_hw_get_frame_duration(ah, band, 10, rate, false);\r\neifs = ack_tx_time + sifs + 2 * slot_time;\r\neifs_clock = ath5k_hw_htoclock(ah, eifs);\r\nif (ah->ah_version == AR5K_AR5210) {\r\nu32 pifs, pifs_clock, difs, difs_clock;\r\nath5k_hw_reg_write(ah, slot_time_clock, AR5K_SLOT_TIME);\r\neifs_clock = AR5K_REG_SM(eifs_clock, AR5K_IFS1_EIFS);\r\npifs = slot_time + sifs;\r\npifs_clock = ath5k_hw_htoclock(ah, pifs);\r\npifs_clock = AR5K_REG_SM(pifs_clock, AR5K_IFS1_PIFS);\r\ndifs = sifs + 2 * slot_time;\r\ndifs_clock = ath5k_hw_htoclock(ah, difs);\r\nath5k_hw_reg_write(ah, (difs_clock <<\r\nAR5K_IFS0_DIFS_S) | sifs_clock,\r\nAR5K_IFS0);\r\nath5k_hw_reg_write(ah, pifs_clock | eifs_clock |\r\n(AR5K_INIT_CARR_SENSE_EN << AR5K_IFS1_CS_EN_S),\r\nAR5K_IFS1);\r\nreturn 0;\r\n}\r\nath5k_hw_reg_write(ah, slot_time_clock, AR5K_DCU_GBL_IFS_SLOT);\r\nath5k_hw_reg_write(ah, eifs_clock, AR5K_DCU_GBL_IFS_EIFS);\r\nAR5K_REG_WRITE_BITS(ah, AR5K_DCU_GBL_IFS_MISC,\r\nAR5K_DCU_GBL_IFS_MISC_SIFS_DUR_USEC,\r\nsifs);\r\nath5k_hw_reg_write(ah, sifs_clock, AR5K_DCU_GBL_IFS_SIFS);\r\nreturn 0;\r\n}\r\nint\r\nath5k_hw_init_queues(struct ath5k_hw *ah)\r\n{\r\nint i, ret;\r\nif (ah->ah_version != AR5K_AR5210)\r\nfor (i = 0; i < ah->ah_capabilities.cap_queues.q_tx_num; i++) {\r\nret = ath5k_hw_reset_tx_queue(ah, i);\r\nif (ret) {\r\nATH5K_ERR(ah,\r\n"failed to reset TX queue #%d\n", i);\r\nreturn ret;\r\n}\r\n}\r\nelse\r\nath5k_hw_set_tx_retry_limits(ah, 0);\r\nif (ah->ah_bwmode == AR5K_BWMODE_40MHZ)\r\nAR5K_REG_ENABLE_BITS(ah, AR5K_DCU_GBL_IFS_MISC,\r\nAR5K_DCU_GBL_IFS_MISC_TURBO_MODE);\r\nif (!ah->ah_coverage_class) {\r\nunsigned int slot_time = ath5k_hw_get_default_slottime(ah);\r\nath5k_hw_set_ifs_intervals(ah, slot_time);\r\n}\r\nreturn 0;\r\n}

u32 prandom_u32_state(struct rnd_state *state)\r\n{\r\n#define TAUSWORTHE(s,a,b,c,d) ((s&c)<<d) ^ (((s <<a) ^ s)>>b)\r\nstate->s1 = TAUSWORTHE(state->s1, 13, 19, 4294967294UL, 12);\r\nstate->s2 = TAUSWORTHE(state->s2, 2, 25, 4294967288UL, 4);\r\nstate->s3 = TAUSWORTHE(state->s3, 3, 11, 4294967280UL, 17);\r\nreturn (state->s1 ^ state->s2 ^ state->s3);\r\n}\r\nu32 prandom_u32(void)\r\n{\r\nunsigned long r;\r\nstruct rnd_state *state = &get_cpu_var(net_rand_state);\r\nr = prandom_u32_state(state);\r\nput_cpu_var(state);\r\nreturn r;\r\n}\r\nvoid prandom_bytes_state(struct rnd_state *state, void *buf, int bytes)\r\n{\r\nunsigned char *p = buf;\r\nint i;\r\nfor (i = 0; i < round_down(bytes, sizeof(u32)); i += sizeof(u32)) {\r\nu32 random = prandom_u32_state(state);\r\nint j;\r\nfor (j = 0; j < sizeof(u32); j++) {\r\np[i + j] = random;\r\nrandom >>= BITS_PER_BYTE;\r\n}\r\n}\r\nif (i < bytes) {\r\nu32 random = prandom_u32_state(state);\r\nfor (; i < bytes; i++) {\r\np[i] = random;\r\nrandom >>= BITS_PER_BYTE;\r\n}\r\n}\r\n}\r\nvoid prandom_bytes(void *buf, int bytes)\r\n{\r\nstruct rnd_state *state = &get_cpu_var(net_rand_state);\r\nprandom_bytes_state(state, buf, bytes);\r\nput_cpu_var(state);\r\n}\r\nvoid prandom_seed(u32 entropy)\r\n{\r\nint i;\r\nfor_each_possible_cpu (i) {\r\nstruct rnd_state *state = &per_cpu(net_rand_state, i);\r\nstate->s1 = __seed(state->s1 ^ entropy, 1);\r\n}\r\n}\r\nstatic int __init prandom_init(void)\r\n{\r\nint i;\r\nfor_each_possible_cpu(i) {\r\nstruct rnd_state *state = &per_cpu(net_rand_state,i);\r\n#define LCG(x) ((x) * 69069)\r\nstate->s1 = __seed(LCG(i + jiffies), 1);\r\nstate->s2 = __seed(LCG(state->s1), 7);\r\nstate->s3 = __seed(LCG(state->s2), 15);\r\nprandom_u32_state(state);\r\nprandom_u32_state(state);\r\nprandom_u32_state(state);\r\nprandom_u32_state(state);\r\nprandom_u32_state(state);\r\nprandom_u32_state(state);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init prandom_reseed(void)\r\n{\r\nint i;\r\nfor_each_possible_cpu(i) {\r\nstruct rnd_state *state = &per_cpu(net_rand_state,i);\r\nu32 seeds[3];\r\nget_random_bytes(&seeds, sizeof(seeds));\r\nstate->s1 = __seed(seeds[0], 1);\r\nstate->s2 = __seed(seeds[1], 7);\r\nstate->s3 = __seed(seeds[2], 15);\r\nprandom_u32_state(state);\r\n}\r\nreturn 0;\r\n}

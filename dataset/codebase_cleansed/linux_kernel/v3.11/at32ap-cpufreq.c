static int at32_verify_speed(struct cpufreq_policy *policy)\r\n{\r\nif (policy->cpu != 0)\r\nreturn -EINVAL;\r\ncpufreq_verify_within_limits(policy, policy->cpuinfo.min_freq,\r\npolicy->cpuinfo.max_freq);\r\nreturn 0;\r\n}\r\nstatic unsigned int at32_get_speed(unsigned int cpu)\r\n{\r\nif (cpu)\r\nreturn 0;\r\nreturn (unsigned int)((clk_get_rate(cpuclk) + 500) / 1000);\r\n}\r\nstatic int at32_set_target(struct cpufreq_policy *policy,\r\nunsigned int target_freq,\r\nunsigned int relation)\r\n{\r\nstruct cpufreq_freqs freqs;\r\nlong freq;\r\nfreq = clk_round_rate(cpuclk, target_freq * 1000);\r\nif(freq < (policy->min * 1000) || freq > (policy->max * 1000))\r\nreturn -EINVAL;\r\npr_debug("cpufreq: requested frequency %u Hz\n", target_freq * 1000);\r\nfreqs.old = at32_get_speed(0);\r\nfreqs.new = (freq + 500) / 1000;\r\nfreqs.flags = 0;\r\nif (!ref_freq) {\r\nref_freq = freqs.old;\r\nloops_per_jiffy_ref = boot_cpu_data.loops_per_jiffy;\r\n}\r\ncpufreq_notify_transition(policy, &freqs, CPUFREQ_PRECHANGE);\r\nif (freqs.old < freqs.new)\r\nboot_cpu_data.loops_per_jiffy = cpufreq_scale(\r\nloops_per_jiffy_ref, ref_freq, freqs.new);\r\nclk_set_rate(cpuclk, freq);\r\nif (freqs.new < freqs.old)\r\nboot_cpu_data.loops_per_jiffy = cpufreq_scale(\r\nloops_per_jiffy_ref, ref_freq, freqs.new);\r\ncpufreq_notify_transition(policy, &freqs, CPUFREQ_POSTCHANGE);\r\npr_debug("cpufreq: set frequency %lu Hz\n", freq);\r\nreturn 0;\r\n}\r\nstatic int __init at32_cpufreq_driver_init(struct cpufreq_policy *policy)\r\n{\r\nif (policy->cpu != 0)\r\nreturn -EINVAL;\r\ncpuclk = clk_get(NULL, "cpu");\r\nif (IS_ERR(cpuclk)) {\r\npr_debug("cpufreq: could not get CPU clk\n");\r\nreturn PTR_ERR(cpuclk);\r\n}\r\npolicy->cpuinfo.min_freq = (clk_round_rate(cpuclk, 1) + 500) / 1000;\r\npolicy->cpuinfo.max_freq = (clk_round_rate(cpuclk, ~0UL) + 500) / 1000;\r\npolicy->cpuinfo.transition_latency = 0;\r\npolicy->cur = at32_get_speed(0);\r\npolicy->min = policy->cpuinfo.min_freq;\r\npolicy->max = policy->cpuinfo.max_freq;\r\nprintk("cpufreq: AT32AP CPU frequency driver\n");\r\nreturn 0;\r\n}\r\nstatic int __init at32_cpufreq_init(void)\r\n{\r\nreturn cpufreq_register_driver(&at32_driver);\r\n}

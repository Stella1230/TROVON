static int pcm030_fabric_probe(struct platform_device *op)\r\n{\r\nstruct device_node *np = op->dev.of_node;\r\nstruct device_node *platform_np;\r\nstruct snd_soc_card *card = &pcm030_card;\r\nstruct pcm030_audio_data *pdata;\r\nint ret;\r\nint i;\r\nif (!of_machine_is_compatible("phytec,pcm030"))\r\nreturn -ENODEV;\r\npdata = devm_kzalloc(&op->dev, sizeof(struct pcm030_audio_data),\r\nGFP_KERNEL);\r\nif (!pdata)\r\nreturn -ENOMEM;\r\ncard->dev = &op->dev;\r\nplatform_set_drvdata(op, pdata);\r\npdata->card = card;\r\nplatform_np = of_parse_phandle(np, "asoc-platform", 0);\r\nif (!platform_np) {\r\ndev_err(&op->dev, "ac97 not registered\n");\r\nreturn -ENODEV;\r\n}\r\nfor (i = 0; i < card->num_links; i++)\r\ncard->dai_link[i].platform_of_node = platform_np;\r\nret = request_module("snd-soc-wm9712");\r\nif (ret)\r\ndev_err(&op->dev, "request_module returned: %d\n", ret);\r\npdata->codec_device = platform_device_alloc("wm9712-codec", -1);\r\nif (!pdata->codec_device)\r\ndev_err(&op->dev, "platform_device_alloc() failed\n");\r\nret = platform_device_add(pdata->codec_device);\r\nif (ret)\r\ndev_err(&op->dev, "platform_device_add() failed: %d\n", ret);\r\nret = snd_soc_register_card(card);\r\nif (ret)\r\ndev_err(&op->dev, "snd_soc_register_card() failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int pcm030_fabric_remove(struct platform_device *op)\r\n{\r\nstruct pcm030_audio_data *pdata = platform_get_drvdata(op);\r\nint ret;\r\nret = snd_soc_unregister_card(pdata->card);\r\nplatform_device_unregister(pdata->codec_device);\r\nreturn ret;\r\n}

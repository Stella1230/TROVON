int vmw_mmap(struct file *filp, struct vm_area_struct *vma)\r\n{\r\nstruct drm_file *file_priv;\r\nstruct vmw_private *dev_priv;\r\nif (unlikely(vma->vm_pgoff < VMWGFX_FILE_PAGE_OFFSET)) {\r\nDRM_ERROR("Illegal attempt to mmap old fifo space.\n");\r\nreturn -EINVAL;\r\n}\r\nfile_priv = filp->private_data;\r\ndev_priv = vmw_priv(file_priv->minor->dev);\r\nreturn ttm_bo_mmap(filp, vma, &dev_priv->bdev);\r\n}\r\nstatic int vmw_ttm_mem_global_init(struct drm_global_reference *ref)\r\n{\r\nDRM_INFO("global init.\n");\r\nreturn ttm_mem_global_init(ref->object);\r\n}\r\nstatic void vmw_ttm_mem_global_release(struct drm_global_reference *ref)\r\n{\r\nttm_mem_global_release(ref->object);\r\n}\r\nint vmw_ttm_global_init(struct vmw_private *dev_priv)\r\n{\r\nstruct drm_global_reference *global_ref;\r\nint ret;\r\nglobal_ref = &dev_priv->mem_global_ref;\r\nglobal_ref->global_type = DRM_GLOBAL_TTM_MEM;\r\nglobal_ref->size = sizeof(struct ttm_mem_global);\r\nglobal_ref->init = &vmw_ttm_mem_global_init;\r\nglobal_ref->release = &vmw_ttm_mem_global_release;\r\nret = drm_global_item_ref(global_ref);\r\nif (unlikely(ret != 0)) {\r\nDRM_ERROR("Failed setting up TTM memory accounting.\n");\r\nreturn ret;\r\n}\r\ndev_priv->bo_global_ref.mem_glob =\r\ndev_priv->mem_global_ref.object;\r\nglobal_ref = &dev_priv->bo_global_ref.ref;\r\nglobal_ref->global_type = DRM_GLOBAL_TTM_BO;\r\nglobal_ref->size = sizeof(struct ttm_bo_global);\r\nglobal_ref->init = &ttm_bo_global_init;\r\nglobal_ref->release = &ttm_bo_global_release;\r\nret = drm_global_item_ref(global_ref);\r\nif (unlikely(ret != 0)) {\r\nDRM_ERROR("Failed setting up TTM buffer objects.\n");\r\ngoto out_no_bo;\r\n}\r\nreturn 0;\r\nout_no_bo:\r\ndrm_global_item_unref(&dev_priv->mem_global_ref);\r\nreturn ret;\r\n}\r\nvoid vmw_ttm_global_release(struct vmw_private *dev_priv)\r\n{\r\ndrm_global_item_unref(&dev_priv->bo_global_ref.ref);\r\ndrm_global_item_unref(&dev_priv->mem_global_ref);\r\n}

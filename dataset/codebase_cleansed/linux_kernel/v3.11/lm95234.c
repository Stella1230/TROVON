static int lm95234_read_temp(struct i2c_client *client, int index, int *t)\r\n{\r\nint val;\r\nu16 temp = 0;\r\nif (index) {\r\nval = i2c_smbus_read_byte_data(client,\r\nLM95234_REG_UTEMPH(index - 1));\r\nif (val < 0)\r\nreturn val;\r\ntemp = val << 8;\r\nval = i2c_smbus_read_byte_data(client,\r\nLM95234_REG_UTEMPL(index - 1));\r\nif (val < 0)\r\nreturn val;\r\ntemp |= val;\r\n*t = temp;\r\n}\r\nif (!temp) {\r\nval = i2c_smbus_read_byte_data(client,\r\nLM95234_REG_TEMPH(index));\r\nif (val < 0)\r\nreturn val;\r\ntemp = val << 8;\r\nval = i2c_smbus_read_byte_data(client,\r\nLM95234_REG_TEMPL(index));\r\nif (val < 0)\r\nreturn val;\r\ntemp |= val;\r\n*t = (s16)temp;\r\n}\r\nreturn 0;\r\n}\r\nstatic int lm95234_fill_cache(struct i2c_client *client)\r\n{\r\nstruct lm95234_data *data = i2c_get_clientdata(client);\r\nint i, ret;\r\nret = i2c_smbus_read_byte_data(client, LM95234_REG_CONVRATE);\r\nif (ret < 0)\r\nreturn ret;\r\ndata->interval = msecs_to_jiffies(update_intervals[ret & 0x03]);\r\nfor (i = 0; i < ARRAY_SIZE(data->tcrit1); i++) {\r\nret = i2c_smbus_read_byte_data(client, LM95234_REG_TCRIT1(i));\r\nif (ret < 0)\r\nreturn ret;\r\ndata->tcrit1[i] = ret;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(data->tcrit2); i++) {\r\nret = i2c_smbus_read_byte_data(client, LM95234_REG_TCRIT2(i));\r\nif (ret < 0)\r\nreturn ret;\r\ndata->tcrit2[i] = ret;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(data->toffset); i++) {\r\nret = i2c_smbus_read_byte_data(client, LM95234_REG_OFFSET(i));\r\nif (ret < 0)\r\nreturn ret;\r\ndata->toffset[i] = ret;\r\n}\r\nret = i2c_smbus_read_byte_data(client, LM95234_REG_TCRIT_HYST);\r\nif (ret < 0)\r\nreturn ret;\r\ndata->thyst = ret;\r\nret = i2c_smbus_read_byte_data(client, LM95234_REG_REM_MODEL);\r\nif (ret < 0)\r\nreturn ret;\r\ndata->sensor_type = ret;\r\nreturn 0;\r\n}\r\nstatic int lm95234_update_device(struct i2c_client *client,\r\nstruct lm95234_data *data)\r\n{\r\nint ret;\r\nmutex_lock(&data->update_lock);\r\nif (time_after(jiffies, data->last_updated + data->interval) ||\r\n!data->valid) {\r\nint i;\r\nif (!data->valid) {\r\nret = lm95234_fill_cache(client);\r\nif (ret < 0)\r\ngoto abort;\r\n}\r\ndata->valid = false;\r\nfor (i = 0; i < ARRAY_SIZE(data->temp); i++) {\r\nret = lm95234_read_temp(client, i, &data->temp[i]);\r\nif (ret < 0)\r\ngoto abort;\r\n}\r\nret = i2c_smbus_read_byte_data(client, LM95234_REG_STS_FAULT);\r\nif (ret < 0)\r\ngoto abort;\r\ndata->status = ret;\r\nret = i2c_smbus_read_byte_data(client, LM95234_REG_STS_TCRIT1);\r\nif (ret < 0)\r\ngoto abort;\r\ndata->status |= ret << 8;\r\nret = i2c_smbus_read_byte_data(client, LM95234_REG_STS_TCRIT2);\r\nif (ret < 0)\r\ngoto abort;\r\ndata->status |= ret << 16;\r\ndata->last_updated = jiffies;\r\ndata->valid = true;\r\n}\r\nret = 0;\r\nabort:\r\nmutex_unlock(&data->update_lock);\r\nreturn ret;\r\n}\r\nstatic ssize_t show_temp(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct lm95234_data *data = i2c_get_clientdata(client);\r\nint index = to_sensor_dev_attr(attr)->index;\r\nint ret = lm95234_update_device(client, data);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, "%d\n",\r\nDIV_ROUND_CLOSEST(data->temp[index] * 125, 32));\r\n}\r\nstatic ssize_t show_alarm(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct lm95234_data *data = i2c_get_clientdata(client);\r\nu32 mask = to_sensor_dev_attr(attr)->index;\r\nint ret = lm95234_update_device(client, data);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, "%u", !!(data->status & mask));\r\n}\r\nstatic ssize_t show_type(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct lm95234_data *data = i2c_get_clientdata(client);\r\nu8 mask = to_sensor_dev_attr(attr)->index;\r\nint ret = lm95234_update_device(client, data);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, data->sensor_type & mask ? "1\n" : "2\n");\r\n}\r\nstatic ssize_t set_type(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct lm95234_data *data = i2c_get_clientdata(client);\r\nunsigned long val;\r\nu8 mask = to_sensor_dev_attr(attr)->index;\r\nint ret = lm95234_update_device(client, data);\r\nif (ret)\r\nreturn ret;\r\nret = kstrtoul(buf, 10, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nif (val != 1 && val != 2)\r\nreturn -EINVAL;\r\nmutex_lock(&data->update_lock);\r\nif (val == 1)\r\ndata->sensor_type |= mask;\r\nelse\r\ndata->sensor_type &= ~mask;\r\ndata->valid = false;\r\ni2c_smbus_write_byte_data(client, LM95234_REG_REM_MODEL,\r\ndata->sensor_type);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_tcrit2(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct lm95234_data *data = i2c_get_clientdata(client);\r\nint index = to_sensor_dev_attr(attr)->index;\r\nint ret = lm95234_update_device(client, data);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, "%u", data->tcrit2[index] * 1000);\r\n}\r\nstatic ssize_t set_tcrit2(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct lm95234_data *data = i2c_get_clientdata(client);\r\nint index = to_sensor_dev_attr(attr)->index;\r\nlong val;\r\nint ret = lm95234_update_device(client, data);\r\nif (ret)\r\nreturn ret;\r\nret = kstrtol(buf, 10, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nval = clamp_val(DIV_ROUND_CLOSEST(val, 1000), 0, index ? 255 : 127);\r\nmutex_lock(&data->update_lock);\r\ndata->tcrit2[index] = val;\r\ni2c_smbus_write_byte_data(client, LM95234_REG_TCRIT2(index), val);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_tcrit2_hyst(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct lm95234_data *data = i2c_get_clientdata(client);\r\nint index = to_sensor_dev_attr(attr)->index;\r\nint ret = lm95234_update_device(client, data);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, "%d",\r\n((int)data->tcrit2[index] - (int)data->thyst) * 1000);\r\n}\r\nstatic ssize_t show_tcrit1(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct lm95234_data *data = i2c_get_clientdata(client);\r\nint index = to_sensor_dev_attr(attr)->index;\r\nreturn sprintf(buf, "%u", data->tcrit1[index] * 1000);\r\n}\r\nstatic ssize_t set_tcrit1(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct lm95234_data *data = i2c_get_clientdata(client);\r\nint index = to_sensor_dev_attr(attr)->index;\r\nlong val;\r\nint ret = lm95234_update_device(client, data);\r\nif (ret)\r\nreturn ret;\r\nret = kstrtol(buf, 10, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nval = clamp_val(DIV_ROUND_CLOSEST(val, 1000), 0, 255);\r\nmutex_lock(&data->update_lock);\r\ndata->tcrit1[index] = val;\r\ni2c_smbus_write_byte_data(client, LM95234_REG_TCRIT1(index), val);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_tcrit1_hyst(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct lm95234_data *data = i2c_get_clientdata(client);\r\nint index = to_sensor_dev_attr(attr)->index;\r\nint ret = lm95234_update_device(client, data);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, "%d",\r\n((int)data->tcrit1[index] - (int)data->thyst) * 1000);\r\n}\r\nstatic ssize_t set_tcrit1_hyst(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct lm95234_data *data = i2c_get_clientdata(client);\r\nint index = to_sensor_dev_attr(attr)->index;\r\nlong val;\r\nint ret = lm95234_update_device(client, data);\r\nif (ret)\r\nreturn ret;\r\nret = kstrtol(buf, 10, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nval = DIV_ROUND_CLOSEST(val, 1000);\r\nval = clamp_val((int)data->tcrit1[index] - val, 0, 31);\r\nmutex_lock(&data->update_lock);\r\ndata->thyst = val;\r\ni2c_smbus_write_byte_data(client, LM95234_REG_TCRIT_HYST, val);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_offset(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct lm95234_data *data = i2c_get_clientdata(client);\r\nint index = to_sensor_dev_attr(attr)->index;\r\nint ret = lm95234_update_device(client, data);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, "%d", data->toffset[index] * 500);\r\n}\r\nstatic ssize_t set_offset(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct lm95234_data *data = i2c_get_clientdata(client);\r\nint index = to_sensor_dev_attr(attr)->index;\r\nlong val;\r\nint ret = lm95234_update_device(client, data);\r\nif (ret)\r\nreturn ret;\r\nret = kstrtol(buf, 10, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nval = clamp_val(DIV_ROUND_CLOSEST(val, 500), -128, 127);\r\nmutex_lock(&data->update_lock);\r\ndata->toffset[index] = val;\r\ni2c_smbus_write_byte_data(client, LM95234_REG_OFFSET(index), val);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_interval(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct lm95234_data *data = i2c_get_clientdata(client);\r\nint ret = lm95234_update_device(client, data);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, "%lu\n",\r\nDIV_ROUND_CLOSEST(data->interval * 1000, HZ));\r\n}\r\nstatic ssize_t set_interval(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct lm95234_data *data = i2c_get_clientdata(client);\r\nunsigned long val;\r\nu8 regval;\r\nint ret = lm95234_update_device(client, data);\r\nif (ret)\r\nreturn ret;\r\nret = kstrtoul(buf, 10, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nfor (regval = 0; regval < 3; regval++) {\r\nif (val <= update_intervals[regval])\r\nbreak;\r\n}\r\nmutex_lock(&data->update_lock);\r\ndata->interval = msecs_to_jiffies(update_intervals[regval]);\r\ni2c_smbus_write_byte_data(client, LM95234_REG_CONVRATE, regval);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic int lm95234_detect(struct i2c_client *client,\r\nstruct i2c_board_info *info)\r\n{\r\nstruct i2c_adapter *adapter = client->adapter;\r\nint mfg_id, chip_id, val;\r\nif (!i2c_check_functionality(adapter, I2C_FUNC_SMBUS_BYTE_DATA))\r\nreturn -ENODEV;\r\nmfg_id = i2c_smbus_read_byte_data(client, LM95234_REG_MAN_ID);\r\nif (mfg_id != NATSEMI_MAN_ID)\r\nreturn -ENODEV;\r\nchip_id = i2c_smbus_read_byte_data(client, LM95234_REG_CHIP_ID);\r\nif (chip_id != LM95234_CHIP_ID)\r\nreturn -ENODEV;\r\nval = i2c_smbus_read_byte_data(client, LM95234_REG_STATUS);\r\nif (val & 0x30)\r\nreturn -ENODEV;\r\nval = i2c_smbus_read_byte_data(client, LM95234_REG_CONFIG);\r\nif (val & 0xbc)\r\nreturn -ENODEV;\r\nval = i2c_smbus_read_byte_data(client, LM95234_REG_CONVRATE);\r\nif (val & 0xfc)\r\nreturn -ENODEV;\r\nval = i2c_smbus_read_byte_data(client, LM95234_REG_REM_MODEL);\r\nif (val & 0xe1)\r\nreturn -ENODEV;\r\nval = i2c_smbus_read_byte_data(client, LM95234_REG_REM_MODEL_STS);\r\nif (val & 0xe1)\r\nreturn -ENODEV;\r\nstrlcpy(info->type, "lm95234", I2C_NAME_SIZE);\r\nreturn 0;\r\n}\r\nstatic int lm95234_init_client(struct i2c_client *client)\r\n{\r\nint val, model;\r\nval = i2c_smbus_read_byte_data(client, LM95234_REG_CONFIG);\r\nif (val < 0)\r\nreturn val;\r\nif (val & 0x40)\r\ni2c_smbus_write_byte_data(client, LM95234_REG_CONFIG,\r\nval & ~0x40);\r\nval = i2c_smbus_read_byte_data(client, LM95234_REG_REM_MODEL_STS);\r\nif (val < 0)\r\nreturn val;\r\nmodel = i2c_smbus_read_byte_data(client, LM95234_REG_REM_MODEL);\r\nif (model < 0)\r\nreturn model;\r\nif (model & val) {\r\ndev_notice(&client->dev,\r\n"Fixing remote diode type misconfiguration (0x%x)\n",\r\nval);\r\ni2c_smbus_write_byte_data(client, LM95234_REG_REM_MODEL,\r\nmodel & ~val);\r\n}\r\nreturn 0;\r\n}\r\nstatic int lm95234_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct device *dev = &client->dev;\r\nstruct lm95234_data *data;\r\nint err;\r\ndata = devm_kzalloc(dev, sizeof(struct lm95234_data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(client, data);\r\nmutex_init(&data->update_lock);\r\nerr = lm95234_init_client(client);\r\nif (err < 0)\r\nreturn err;\r\nerr = sysfs_create_group(&dev->kobj, &lm95234_group);\r\nif (err)\r\nreturn err;\r\ndata->hwmon_dev = hwmon_device_register(dev);\r\nif (IS_ERR(data->hwmon_dev)) {\r\nerr = PTR_ERR(data->hwmon_dev);\r\ngoto exit_remove_files;\r\n}\r\nreturn 0;\r\nexit_remove_files:\r\nsysfs_remove_group(&dev->kobj, &lm95234_group);\r\nreturn err;\r\n}\r\nstatic int lm95234_remove(struct i2c_client *client)\r\n{\r\nstruct lm95234_data *data = i2c_get_clientdata(client);\r\nhwmon_device_unregister(data->hwmon_dev);\r\nsysfs_remove_group(&client->dev.kobj, &lm95234_group);\r\nreturn 0;\r\n}

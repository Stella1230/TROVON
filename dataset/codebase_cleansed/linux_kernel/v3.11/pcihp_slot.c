static void program_hpp_type0(struct pci_dev *dev, struct hpp_type0 *hpp)\r\n{\r\nu16 pci_cmd, pci_bctl;\r\nif (!hpp) {\r\nif (pci_is_pcie(dev))\r\nreturn;\r\ndev_info(&dev->dev, "using default PCI settings\n");\r\nhpp = &pci_default_type0;\r\n}\r\nif (hpp->revision > 1) {\r\ndev_warn(&dev->dev,\r\n"PCI settings rev %d not supported; using defaults\n",\r\nhpp->revision);\r\nhpp = &pci_default_type0;\r\n}\r\npci_write_config_byte(dev, PCI_CACHE_LINE_SIZE, hpp->cache_line_size);\r\npci_write_config_byte(dev, PCI_LATENCY_TIMER, hpp->latency_timer);\r\npci_read_config_word(dev, PCI_COMMAND, &pci_cmd);\r\nif (hpp->enable_serr)\r\npci_cmd |= PCI_COMMAND_SERR;\r\nelse\r\npci_cmd &= ~PCI_COMMAND_SERR;\r\nif (hpp->enable_perr)\r\npci_cmd |= PCI_COMMAND_PARITY;\r\nelse\r\npci_cmd &= ~PCI_COMMAND_PARITY;\r\npci_write_config_word(dev, PCI_COMMAND, pci_cmd);\r\nif ((dev->class >> 8) == PCI_CLASS_BRIDGE_PCI) {\r\npci_write_config_byte(dev, PCI_SEC_LATENCY_TIMER,\r\nhpp->latency_timer);\r\npci_read_config_word(dev, PCI_BRIDGE_CONTROL, &pci_bctl);\r\nif (hpp->enable_serr)\r\npci_bctl |= PCI_BRIDGE_CTL_SERR;\r\nelse\r\npci_bctl &= ~PCI_BRIDGE_CTL_SERR;\r\nif (hpp->enable_perr)\r\npci_bctl |= PCI_BRIDGE_CTL_PARITY;\r\nelse\r\npci_bctl &= ~PCI_BRIDGE_CTL_PARITY;\r\npci_write_config_word(dev, PCI_BRIDGE_CONTROL, pci_bctl);\r\n}\r\n}\r\nstatic void program_hpp_type1(struct pci_dev *dev, struct hpp_type1 *hpp)\r\n{\r\nif (hpp)\r\ndev_warn(&dev->dev, "PCI-X settings not supported\n");\r\n}\r\nstatic void program_hpp_type2(struct pci_dev *dev, struct hpp_type2 *hpp)\r\n{\r\nint pos;\r\nu32 reg32;\r\nif (!hpp)\r\nreturn;\r\nif (hpp->revision > 1) {\r\ndev_warn(&dev->dev, "PCIe settings rev %d not supported\n",\r\nhpp->revision);\r\nreturn;\r\n}\r\npcie_capability_clear_and_set_word(dev, PCI_EXP_DEVCTL,\r\n~hpp->pci_exp_devctl_and, hpp->pci_exp_devctl_or);\r\nif (dev->subordinate)\r\npcie_capability_clear_and_set_word(dev, PCI_EXP_LNKCTL,\r\n~hpp->pci_exp_lnkctl_and, hpp->pci_exp_lnkctl_or);\r\npos = pci_find_ext_capability(dev, PCI_EXT_CAP_ID_ERR);\r\nif (!pos)\r\nreturn;\r\npci_read_config_dword(dev, pos + PCI_ERR_UNCOR_MASK, &reg32);\r\nreg32 = (reg32 & hpp->unc_err_mask_and) | hpp->unc_err_mask_or;\r\npci_write_config_dword(dev, pos + PCI_ERR_UNCOR_MASK, reg32);\r\npci_read_config_dword(dev, pos + PCI_ERR_UNCOR_SEVER, &reg32);\r\nreg32 = (reg32 & hpp->unc_err_sever_and) | hpp->unc_err_sever_or;\r\npci_write_config_dword(dev, pos + PCI_ERR_UNCOR_SEVER, reg32);\r\npci_read_config_dword(dev, pos + PCI_ERR_COR_MASK, &reg32);\r\nreg32 = (reg32 & hpp->cor_err_mask_and) | hpp->cor_err_mask_or;\r\npci_write_config_dword(dev, pos + PCI_ERR_COR_MASK, reg32);\r\npci_read_config_dword(dev, pos + PCI_ERR_CAP, &reg32);\r\nreg32 = (reg32 & hpp->adv_err_cap_and) | hpp->adv_err_cap_or;\r\npci_write_config_dword(dev, pos + PCI_ERR_CAP, reg32);\r\n}\r\nvoid pci_configure_slot(struct pci_dev *dev)\r\n{\r\nstruct pci_dev *cdev;\r\nstruct hotplug_params hpp;\r\nint ret;\r\nif (!(dev->hdr_type == PCI_HEADER_TYPE_NORMAL ||\r\n(dev->hdr_type == PCI_HEADER_TYPE_BRIDGE &&\r\n(dev->class >> 8) == PCI_CLASS_BRIDGE_PCI)))\r\nreturn;\r\nif (dev->bus && dev->bus->self)\r\npcie_bus_configure_settings(dev->bus,\r\ndev->bus->self->pcie_mpss);\r\nmemset(&hpp, 0, sizeof(hpp));\r\nret = pci_get_hp_params(dev, &hpp);\r\nif (ret)\r\ndev_warn(&dev->dev, "no hotplug settings from platform\n");\r\nprogram_hpp_type2(dev, hpp.t2);\r\nprogram_hpp_type1(dev, hpp.t1);\r\nprogram_hpp_type0(dev, hpp.t0);\r\nif (dev->subordinate) {\r\nlist_for_each_entry(cdev, &dev->subordinate->devices,\r\nbus_list)\r\npci_configure_slot(cdev);\r\n}\r\n}

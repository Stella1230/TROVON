static bool containsFullLinuxPackage(struct swoc_info *swocInfo)\r\n{\r\nif ((swocInfo->LinuxSKU >= 0x2100 && swocInfo->LinuxSKU <= 0x2FFF) ||\r\n(swocInfo->LinuxSKU >= 0x7100 && swocInfo->LinuxSKU <= 0x7FFF))\r\nreturn true;\r\nelse\r\nreturn false;\r\n}\r\nstatic int sierra_set_ms_mode(struct usb_device *udev, __u16 eSWocMode)\r\n{\r\nint result;\r\ndev_dbg(&udev->dev, "SWIMS: %s", "DEVICE MODE SWITCH\n");\r\nresult = usb_control_msg(udev, usb_sndctrlpipe(udev, 0),\r\nSWIMS_USB_REQUEST_SetSwocMode,\r\nUSB_TYPE_VENDOR | USB_DIR_OUT,\r\neSWocMode,\r\n0x0000,\r\nNULL,\r\n0,\r\nUSB_CTRL_SET_TIMEOUT);\r\nreturn result;\r\n}\r\nstatic int sierra_get_swoc_info(struct usb_device *udev,\r\nstruct swoc_info *swocInfo)\r\n{\r\nint result;\r\ndev_dbg(&udev->dev, "SWIMS: Attempting to get TRU-Install info\n");\r\nresult = usb_control_msg(udev, usb_rcvctrlpipe(udev, 0),\r\nSWIMS_USB_REQUEST_GetSwocInfo,\r\nUSB_TYPE_VENDOR | USB_DIR_IN,\r\n0,\r\n0,\r\n(void *) swocInfo,\r\nsizeof(struct swoc_info),\r\nUSB_CTRL_SET_TIMEOUT);\r\nswocInfo->LinuxSKU = le16_to_cpu(swocInfo->LinuxSKU);\r\nswocInfo->LinuxVer = le16_to_cpu(swocInfo->LinuxVer);\r\nreturn result;\r\n}\r\nstatic void debug_swoc(const struct device *dev, struct swoc_info *swocInfo)\r\n{\r\ndev_dbg(dev, "SWIMS: SWoC Rev: %02d\n", swocInfo->rev);\r\ndev_dbg(dev, "SWIMS: Linux SKU: %04X\n", swocInfo->LinuxSKU);\r\ndev_dbg(dev, "SWIMS: Linux Version: %04X\n", swocInfo->LinuxVer);\r\n}\r\nstatic ssize_t show_truinst(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct swoc_info *swocInfo;\r\nstruct usb_interface *intf = to_usb_interface(dev);\r\nstruct usb_device *udev = interface_to_usbdev(intf);\r\nint result;\r\nif (swi_tru_install == TRU_FORCE_MS) {\r\nresult = snprintf(buf, PAGE_SIZE, "Forced Mass Storage\n");\r\n} else {\r\nswocInfo = kmalloc(sizeof(struct swoc_info), GFP_KERNEL);\r\nif (!swocInfo) {\r\nsnprintf(buf, PAGE_SIZE, "Error\n");\r\nreturn -ENOMEM;\r\n}\r\nresult = sierra_get_swoc_info(udev, swocInfo);\r\nif (result < 0) {\r\ndev_dbg(dev, "SWIMS: failed SWoC query\n");\r\nkfree(swocInfo);\r\nsnprintf(buf, PAGE_SIZE, "Error\n");\r\nreturn -EIO;\r\n}\r\ndebug_swoc(dev, swocInfo);\r\nresult = snprintf(buf, PAGE_SIZE,\r\n"REV=%02d SKU=%04X VER=%04X\n",\r\nswocInfo->rev,\r\nswocInfo->LinuxSKU,\r\nswocInfo->LinuxVer);\r\nkfree(swocInfo);\r\n}\r\nreturn result;\r\n}\r\nint sierra_ms_init(struct us_data *us)\r\n{\r\nint result, retries;\r\nstruct swoc_info *swocInfo;\r\nstruct usb_device *udev;\r\nstruct Scsi_Host *sh;\r\nretries = 3;\r\nresult = 0;\r\nudev = us->pusb_dev;\r\nsh = us_to_host(us);\r\nscsi_get_host_dev(sh);\r\nif (swi_tru_install == TRU_FORCE_MODEM) {\r\nusb_stor_dbg(us, "SWIMS: Forcing Modem Mode\n");\r\nresult = sierra_set_ms_mode(udev, SWIMS_SET_MODE_Modem);\r\nif (result < 0)\r\nusb_stor_dbg(us, "SWIMS: Failed to switch to modem mode\n");\r\nreturn -EIO;\r\n}\r\nelse if (swi_tru_install == TRU_FORCE_MS) {\r\nusb_stor_dbg(us, "SWIMS: Forcing Mass Storage Mode\n");\r\ngoto complete;\r\n}\r\nelse {\r\nusb_stor_dbg(us, "SWIMS: Normal SWoC Logic\n");\r\nswocInfo = kmalloc(sizeof(struct swoc_info),\r\nGFP_KERNEL);\r\nif (!swocInfo)\r\nreturn -ENOMEM;\r\nretries = 3;\r\ndo {\r\nretries--;\r\nresult = sierra_get_swoc_info(udev, swocInfo);\r\nif (result < 0) {\r\nusb_stor_dbg(us, "SWIMS: Failed SWoC query\n");\r\nschedule_timeout_uninterruptible(2*HZ);\r\n}\r\n} while (retries && result < 0);\r\nif (result < 0) {\r\nusb_stor_dbg(us, "SWIMS: Completely failed SWoC query\n");\r\nkfree(swocInfo);\r\nreturn -EIO;\r\n}\r\ndebug_swoc(&us->pusb_dev->dev, swocInfo);\r\nif (!containsFullLinuxPackage(swocInfo)) {\r\nusb_stor_dbg(us, "SWIMS: Switching to Modem Mode\n");\r\nresult = sierra_set_ms_mode(udev,\r\nSWIMS_SET_MODE_Modem);\r\nif (result < 0)\r\nusb_stor_dbg(us, "SWIMS: Failed to switch modem\n");\r\nkfree(swocInfo);\r\nreturn -EIO;\r\n}\r\nkfree(swocInfo);\r\n}\r\ncomplete:\r\nresult = device_create_file(&us->pusb_intf->dev, &dev_attr_truinst);\r\nreturn 0;\r\n}

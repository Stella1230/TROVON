static struct radio_isa_card *typhoon_alloc(void)\r\n{\r\nstruct typhoon *ty = kzalloc(sizeof(*ty), GFP_KERNEL);\r\nreturn ty ? &ty->isa : NULL;\r\n}\r\nstatic int typhoon_s_frequency(struct radio_isa_card *isa, u32 freq)\r\n{\r\nunsigned long outval;\r\nunsigned long x;\r\nx = freq / 160;\r\noutval = (x * x + 2500) / 5000;\r\noutval = (outval * x + 5000) / 10000;\r\noutval -= (10 * x * x + 10433) / 20866;\r\noutval += 4 * x - 11505;\r\noutb_p((outval >> 8) & 0x01, isa->io + 4);\r\noutb_p(outval >> 9, isa->io + 6);\r\noutb_p(outval & 0xff, isa->io + 8);\r\nreturn 0;\r\n}\r\nstatic int typhoon_s_mute_volume(struct radio_isa_card *isa, bool mute, int vol)\r\n{\r\nstruct typhoon *ty = container_of(isa, struct typhoon, isa);\r\nif (mute)\r\nvol = 0;\r\nvol >>= 14;\r\nvol &= 3;\r\noutb_p(vol / 2, isa->io);\r\noutb_p(vol % 2, isa->io + 2);\r\nif (vol == 0 && !ty->muted) {\r\nty->muted = true;\r\nreturn typhoon_s_frequency(isa, mutefreq << 4);\r\n}\r\nif (vol && ty->muted) {\r\nty->muted = false;\r\nreturn typhoon_s_frequency(isa, isa->freq);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init typhoon_init(void)\r\n{\r\nif (mutefreq < 87000 || mutefreq > 108000) {\r\nprintk(KERN_ERR "%s: You must set a frequency (in kHz) used when muting the card,\n",\r\ntyphoon_driver.driver.driver.name);\r\nprintk(KERN_ERR "%s: e.g. with \"mutefreq=87500\" (87000 <= mutefreq <= 108000)\n",\r\ntyphoon_driver.driver.driver.name);\r\nreturn -ENODEV;\r\n}\r\nreturn isa_register_driver(&typhoon_driver.driver, TYPHOON_MAX);\r\n}\r\nstatic void __exit typhoon_exit(void)\r\n{\r\nisa_unregister_driver(&typhoon_driver.driver);\r\n}

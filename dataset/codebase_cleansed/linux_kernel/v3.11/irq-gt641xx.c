static void ack_gt641xx_irq(struct irq_data *d)\r\n{\r\nunsigned long flags;\r\nu32 cause;\r\nraw_spin_lock_irqsave(&gt641xx_irq_lock, flags);\r\ncause = GT_READ(GT_INTRCAUSE_OFS);\r\ncause &= ~GT641XX_IRQ_TO_BIT(d->irq);\r\nGT_WRITE(GT_INTRCAUSE_OFS, cause);\r\nraw_spin_unlock_irqrestore(&gt641xx_irq_lock, flags);\r\n}\r\nstatic void mask_gt641xx_irq(struct irq_data *d)\r\n{\r\nunsigned long flags;\r\nu32 mask;\r\nraw_spin_lock_irqsave(&gt641xx_irq_lock, flags);\r\nmask = GT_READ(GT_INTRMASK_OFS);\r\nmask &= ~GT641XX_IRQ_TO_BIT(d->irq);\r\nGT_WRITE(GT_INTRMASK_OFS, mask);\r\nraw_spin_unlock_irqrestore(&gt641xx_irq_lock, flags);\r\n}\r\nstatic void mask_ack_gt641xx_irq(struct irq_data *d)\r\n{\r\nunsigned long flags;\r\nu32 cause, mask;\r\nraw_spin_lock_irqsave(&gt641xx_irq_lock, flags);\r\nmask = GT_READ(GT_INTRMASK_OFS);\r\nmask &= ~GT641XX_IRQ_TO_BIT(d->irq);\r\nGT_WRITE(GT_INTRMASK_OFS, mask);\r\ncause = GT_READ(GT_INTRCAUSE_OFS);\r\ncause &= ~GT641XX_IRQ_TO_BIT(d->irq);\r\nGT_WRITE(GT_INTRCAUSE_OFS, cause);\r\nraw_spin_unlock_irqrestore(&gt641xx_irq_lock, flags);\r\n}\r\nstatic void unmask_gt641xx_irq(struct irq_data *d)\r\n{\r\nunsigned long flags;\r\nu32 mask;\r\nraw_spin_lock_irqsave(&gt641xx_irq_lock, flags);\r\nmask = GT_READ(GT_INTRMASK_OFS);\r\nmask |= GT641XX_IRQ_TO_BIT(d->irq);\r\nGT_WRITE(GT_INTRMASK_OFS, mask);\r\nraw_spin_unlock_irqrestore(&gt641xx_irq_lock, flags);\r\n}\r\nvoid gt641xx_irq_dispatch(void)\r\n{\r\nu32 cause, mask;\r\nint i;\r\ncause = GT_READ(GT_INTRCAUSE_OFS);\r\nmask = GT_READ(GT_INTRMASK_OFS);\r\ncause &= mask;\r\nfor (i = 1; i < 30; i++) {\r\nif (cause & (1U << i)) {\r\ndo_IRQ(GT641XX_IRQ_BASE + i);\r\nreturn;\r\n}\r\n}\r\natomic_inc(&irq_err_count);\r\n}\r\nvoid __init gt641xx_irq_init(void)\r\n{\r\nint i;\r\nGT_WRITE(GT_INTRMASK_OFS, 0);\r\nGT_WRITE(GT_INTRCAUSE_OFS, 0);\r\nfor (i = 1; i < 30; i++)\r\nirq_set_chip_and_handler(GT641XX_IRQ_BASE + i,\r\n&gt641xx_irq_chip, handle_level_irq);\r\n}

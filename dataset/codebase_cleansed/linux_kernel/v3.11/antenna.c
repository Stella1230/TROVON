static inline bool ath_is_alt_ant_ratio_better(int alt_ratio, int maxdelta,\r\nint mindelta, int main_rssi_avg,\r\nint alt_rssi_avg, int pkt_count)\r\n{\r\nreturn (((alt_ratio >= ATH_ANT_DIV_COMB_ALT_ANT_RATIO2) &&\r\n(alt_rssi_avg > main_rssi_avg + maxdelta)) ||\r\n(alt_rssi_avg > main_rssi_avg + mindelta)) && (pkt_count > 50);\r\n}\r\nstatic inline bool ath_ant_div_comb_alt_check(u8 div_group, int alt_ratio,\r\nint curr_main_set, int curr_alt_set,\r\nint alt_rssi_avg, int main_rssi_avg)\r\n{\r\nbool result = false;\r\nswitch (div_group) {\r\ncase 0:\r\nif (alt_ratio > ATH_ANT_DIV_COMB_ALT_ANT_RATIO)\r\nresult = true;\r\nbreak;\r\ncase 1:\r\ncase 2:\r\nif ((((curr_main_set == ATH_ANT_DIV_COMB_LNA2) &&\r\n(curr_alt_set == ATH_ANT_DIV_COMB_LNA1) &&\r\n(alt_rssi_avg >= (main_rssi_avg - 5))) ||\r\n((curr_main_set == ATH_ANT_DIV_COMB_LNA1) &&\r\n(curr_alt_set == ATH_ANT_DIV_COMB_LNA2) &&\r\n(alt_rssi_avg >= (main_rssi_avg - 2)))) &&\r\n(alt_rssi_avg >= 4))\r\nresult = true;\r\nelse\r\nresult = false;\r\nbreak;\r\n}\r\nreturn result;\r\n}\r\nstatic void ath_lnaconf_alt_good_scan(struct ath_ant_comb *antcomb,\r\nstruct ath_hw_antcomb_conf ant_conf,\r\nint main_rssi_avg)\r\n{\r\nantcomb->quick_scan_cnt = 0;\r\nif (ant_conf.main_lna_conf == ATH_ANT_DIV_COMB_LNA2)\r\nantcomb->rssi_lna2 = main_rssi_avg;\r\nelse if (ant_conf.main_lna_conf == ATH_ANT_DIV_COMB_LNA1)\r\nantcomb->rssi_lna1 = main_rssi_avg;\r\nswitch ((ant_conf.main_lna_conf << 4) | ant_conf.alt_lna_conf) {\r\ncase 0x10:\r\nantcomb->main_conf = ATH_ANT_DIV_COMB_LNA1_MINUS_LNA2;\r\nantcomb->first_quick_scan_conf =\r\nATH_ANT_DIV_COMB_LNA1_PLUS_LNA2;\r\nantcomb->second_quick_scan_conf = ATH_ANT_DIV_COMB_LNA1;\r\nbreak;\r\ncase 0x20:\r\nantcomb->main_conf = ATH_ANT_DIV_COMB_LNA1_MINUS_LNA2;\r\nantcomb->first_quick_scan_conf =\r\nATH_ANT_DIV_COMB_LNA1_PLUS_LNA2;\r\nantcomb->second_quick_scan_conf = ATH_ANT_DIV_COMB_LNA2;\r\nbreak;\r\ncase 0x21:\r\nantcomb->main_conf = ATH_ANT_DIV_COMB_LNA2;\r\nantcomb->first_quick_scan_conf =\r\nATH_ANT_DIV_COMB_LNA1_MINUS_LNA2;\r\nantcomb->second_quick_scan_conf =\r\nATH_ANT_DIV_COMB_LNA1_PLUS_LNA2;\r\nbreak;\r\ncase 0x12:\r\nantcomb->main_conf = ATH_ANT_DIV_COMB_LNA1;\r\nantcomb->first_quick_scan_conf =\r\nATH_ANT_DIV_COMB_LNA1_MINUS_LNA2;\r\nantcomb->second_quick_scan_conf =\r\nATH_ANT_DIV_COMB_LNA1_PLUS_LNA2;\r\nbreak;\r\ncase 0x13:\r\nantcomb->main_conf = ATH_ANT_DIV_COMB_LNA1_PLUS_LNA2;\r\nantcomb->first_quick_scan_conf =\r\nATH_ANT_DIV_COMB_LNA1_MINUS_LNA2;\r\nantcomb->second_quick_scan_conf = ATH_ANT_DIV_COMB_LNA1;\r\nbreak;\r\ncase 0x23:\r\nantcomb->main_conf = ATH_ANT_DIV_COMB_LNA1_PLUS_LNA2;\r\nantcomb->first_quick_scan_conf =\r\nATH_ANT_DIV_COMB_LNA1_MINUS_LNA2;\r\nantcomb->second_quick_scan_conf = ATH_ANT_DIV_COMB_LNA2;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic void ath_select_ant_div_from_quick_scan(struct ath_ant_comb *antcomb,\r\nstruct ath_hw_antcomb_conf *div_ant_conf,\r\nint main_rssi_avg, int alt_rssi_avg,\r\nint alt_ratio)\r\n{\r\nswitch (antcomb->quick_scan_cnt) {\r\ncase 0:\r\ndiv_ant_conf->main_lna_conf = antcomb->main_conf;\r\ndiv_ant_conf->alt_lna_conf = antcomb->first_quick_scan_conf;\r\nbreak;\r\ncase 1:\r\ndiv_ant_conf->main_lna_conf = antcomb->main_conf;\r\ndiv_ant_conf->alt_lna_conf = antcomb->second_quick_scan_conf;\r\nantcomb->rssi_first = main_rssi_avg;\r\nantcomb->rssi_second = alt_rssi_avg;\r\nif (antcomb->main_conf == ATH_ANT_DIV_COMB_LNA1) {\r\nif (ath_is_alt_ant_ratio_better(alt_ratio,\r\nATH_ANT_DIV_COMB_LNA1_DELTA_HI,\r\nATH_ANT_DIV_COMB_LNA1_DELTA_LOW,\r\nmain_rssi_avg, alt_rssi_avg,\r\nantcomb->total_pkt_count))\r\nantcomb->first_ratio = true;\r\nelse\r\nantcomb->first_ratio = false;\r\n} else if (antcomb->main_conf == ATH_ANT_DIV_COMB_LNA2) {\r\nif (ath_is_alt_ant_ratio_better(alt_ratio,\r\nATH_ANT_DIV_COMB_LNA1_DELTA_MID,\r\nATH_ANT_DIV_COMB_LNA1_DELTA_LOW,\r\nmain_rssi_avg, alt_rssi_avg,\r\nantcomb->total_pkt_count))\r\nantcomb->first_ratio = true;\r\nelse\r\nantcomb->first_ratio = false;\r\n} else {\r\nif ((((alt_ratio >= ATH_ANT_DIV_COMB_ALT_ANT_RATIO2) &&\r\n(alt_rssi_avg > main_rssi_avg +\r\nATH_ANT_DIV_COMB_LNA1_DELTA_HI)) ||\r\n(alt_rssi_avg > main_rssi_avg)) &&\r\n(antcomb->total_pkt_count > 50))\r\nantcomb->first_ratio = true;\r\nelse\r\nantcomb->first_ratio = false;\r\n}\r\nbreak;\r\ncase 2:\r\nantcomb->alt_good = false;\r\nantcomb->scan_not_start = false;\r\nantcomb->scan = false;\r\nantcomb->rssi_first = main_rssi_avg;\r\nantcomb->rssi_third = alt_rssi_avg;\r\nif (antcomb->second_quick_scan_conf == ATH_ANT_DIV_COMB_LNA1)\r\nantcomb->rssi_lna1 = alt_rssi_avg;\r\nelse if (antcomb->second_quick_scan_conf ==\r\nATH_ANT_DIV_COMB_LNA2)\r\nantcomb->rssi_lna2 = alt_rssi_avg;\r\nelse if (antcomb->second_quick_scan_conf ==\r\nATH_ANT_DIV_COMB_LNA1_PLUS_LNA2) {\r\nif (antcomb->main_conf == ATH_ANT_DIV_COMB_LNA2)\r\nantcomb->rssi_lna2 = main_rssi_avg;\r\nelse if (antcomb->main_conf == ATH_ANT_DIV_COMB_LNA1)\r\nantcomb->rssi_lna1 = main_rssi_avg;\r\n}\r\nif (antcomb->rssi_lna2 > antcomb->rssi_lna1 +\r\nATH_ANT_DIV_COMB_LNA1_LNA2_SWITCH_DELTA)\r\ndiv_ant_conf->main_lna_conf = ATH_ANT_DIV_COMB_LNA2;\r\nelse\r\ndiv_ant_conf->main_lna_conf = ATH_ANT_DIV_COMB_LNA1;\r\nif (antcomb->main_conf == ATH_ANT_DIV_COMB_LNA1) {\r\nif (ath_is_alt_ant_ratio_better(alt_ratio,\r\nATH_ANT_DIV_COMB_LNA1_DELTA_HI,\r\nATH_ANT_DIV_COMB_LNA1_DELTA_LOW,\r\nmain_rssi_avg, alt_rssi_avg,\r\nantcomb->total_pkt_count))\r\nantcomb->second_ratio = true;\r\nelse\r\nantcomb->second_ratio = false;\r\n} else if (antcomb->main_conf == ATH_ANT_DIV_COMB_LNA2) {\r\nif (ath_is_alt_ant_ratio_better(alt_ratio,\r\nATH_ANT_DIV_COMB_LNA1_DELTA_MID,\r\nATH_ANT_DIV_COMB_LNA1_DELTA_LOW,\r\nmain_rssi_avg, alt_rssi_avg,\r\nantcomb->total_pkt_count))\r\nantcomb->second_ratio = true;\r\nelse\r\nantcomb->second_ratio = false;\r\n} else {\r\nif ((((alt_ratio >= ATH_ANT_DIV_COMB_ALT_ANT_RATIO2) &&\r\n(alt_rssi_avg > main_rssi_avg +\r\nATH_ANT_DIV_COMB_LNA1_DELTA_HI)) ||\r\n(alt_rssi_avg > main_rssi_avg)) &&\r\n(antcomb->total_pkt_count > 50))\r\nantcomb->second_ratio = true;\r\nelse\r\nantcomb->second_ratio = false;\r\n}\r\nif (antcomb->first_ratio && antcomb->second_ratio) {\r\nif (antcomb->rssi_second > antcomb->rssi_third) {\r\nif ((antcomb->first_quick_scan_conf ==\r\nATH_ANT_DIV_COMB_LNA1) ||\r\n(antcomb->first_quick_scan_conf ==\r\nATH_ANT_DIV_COMB_LNA2))\r\nif (div_ant_conf->main_lna_conf ==\r\nATH_ANT_DIV_COMB_LNA2)\r\ndiv_ant_conf->alt_lna_conf =\r\nATH_ANT_DIV_COMB_LNA1;\r\nelse\r\ndiv_ant_conf->alt_lna_conf =\r\nATH_ANT_DIV_COMB_LNA2;\r\nelse\r\ndiv_ant_conf->alt_lna_conf =\r\nantcomb->first_quick_scan_conf;\r\n} else if ((antcomb->second_quick_scan_conf ==\r\nATH_ANT_DIV_COMB_LNA1) ||\r\n(antcomb->second_quick_scan_conf ==\r\nATH_ANT_DIV_COMB_LNA2)) {\r\nif (div_ant_conf->main_lna_conf ==\r\nATH_ANT_DIV_COMB_LNA2)\r\ndiv_ant_conf->alt_lna_conf =\r\nATH_ANT_DIV_COMB_LNA1;\r\nelse\r\ndiv_ant_conf->alt_lna_conf =\r\nATH_ANT_DIV_COMB_LNA2;\r\n} else {\r\ndiv_ant_conf->alt_lna_conf =\r\nantcomb->second_quick_scan_conf;\r\n}\r\n} else if (antcomb->first_ratio) {\r\nif ((antcomb->first_quick_scan_conf ==\r\nATH_ANT_DIV_COMB_LNA1) ||\r\n(antcomb->first_quick_scan_conf ==\r\nATH_ANT_DIV_COMB_LNA2))\r\nif (div_ant_conf->main_lna_conf ==\r\nATH_ANT_DIV_COMB_LNA2)\r\ndiv_ant_conf->alt_lna_conf =\r\nATH_ANT_DIV_COMB_LNA1;\r\nelse\r\ndiv_ant_conf->alt_lna_conf =\r\nATH_ANT_DIV_COMB_LNA2;\r\nelse\r\ndiv_ant_conf->alt_lna_conf =\r\nantcomb->first_quick_scan_conf;\r\n} else if (antcomb->second_ratio) {\r\nif ((antcomb->second_quick_scan_conf ==\r\nATH_ANT_DIV_COMB_LNA1) ||\r\n(antcomb->second_quick_scan_conf ==\r\nATH_ANT_DIV_COMB_LNA2))\r\nif (div_ant_conf->main_lna_conf ==\r\nATH_ANT_DIV_COMB_LNA2)\r\ndiv_ant_conf->alt_lna_conf =\r\nATH_ANT_DIV_COMB_LNA1;\r\nelse\r\ndiv_ant_conf->alt_lna_conf =\r\nATH_ANT_DIV_COMB_LNA2;\r\nelse\r\ndiv_ant_conf->alt_lna_conf =\r\nantcomb->second_quick_scan_conf;\r\n} else {\r\nif ((antcomb->main_conf == ATH_ANT_DIV_COMB_LNA1) ||\r\n(antcomb->main_conf == ATH_ANT_DIV_COMB_LNA2))\r\nif (div_ant_conf->main_lna_conf ==\r\nATH_ANT_DIV_COMB_LNA2)\r\ndiv_ant_conf->alt_lna_conf =\r\nATH_ANT_DIV_COMB_LNA1;\r\nelse\r\ndiv_ant_conf->alt_lna_conf =\r\nATH_ANT_DIV_COMB_LNA2;\r\nelse\r\ndiv_ant_conf->alt_lna_conf = antcomb->main_conf;\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic void ath_ant_div_conf_fast_divbias(struct ath_hw_antcomb_conf *ant_conf,\r\nstruct ath_ant_comb *antcomb,\r\nint alt_ratio)\r\n{\r\nant_conf->main_gaintb = 0;\r\nant_conf->alt_gaintb = 0;\r\nif (ant_conf->div_group == 0) {\r\nswitch ((ant_conf->main_lna_conf << 4) |\r\nant_conf->alt_lna_conf) {\r\ncase 0x01:\r\nant_conf->fast_div_bias = 0x3b;\r\nbreak;\r\ncase 0x02:\r\nant_conf->fast_div_bias = 0x3d;\r\nbreak;\r\ncase 0x03:\r\nant_conf->fast_div_bias = 0x1;\r\nbreak;\r\ncase 0x10:\r\nant_conf->fast_div_bias = 0x7;\r\nbreak;\r\ncase 0x12:\r\nant_conf->fast_div_bias = 0x2;\r\nbreak;\r\ncase 0x13:\r\nant_conf->fast_div_bias = 0x7;\r\nbreak;\r\ncase 0x20:\r\nant_conf->fast_div_bias = 0x6;\r\nbreak;\r\ncase 0x21:\r\nant_conf->fast_div_bias = 0x0;\r\nbreak;\r\ncase 0x23:\r\nant_conf->fast_div_bias = 0x6;\r\nbreak;\r\ncase 0x30:\r\nant_conf->fast_div_bias = 0x1;\r\nbreak;\r\ncase 0x31:\r\nant_conf->fast_div_bias = 0x3b;\r\nbreak;\r\ncase 0x32:\r\nant_conf->fast_div_bias = 0x3d;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n} else if (ant_conf->div_group == 1) {\r\nswitch ((ant_conf->main_lna_conf << 4) |\r\nant_conf->alt_lna_conf) {\r\ncase 0x01:\r\nant_conf->fast_div_bias = 0x1;\r\nbreak;\r\ncase 0x02:\r\nant_conf->fast_div_bias = 0x1;\r\nbreak;\r\ncase 0x03:\r\nant_conf->fast_div_bias = 0x1;\r\nbreak;\r\ncase 0x10:\r\nif (!(antcomb->scan) &&\r\n(alt_ratio > ATH_ANT_DIV_COMB_ALT_ANT_RATIO))\r\nant_conf->fast_div_bias = 0x3f;\r\nelse\r\nant_conf->fast_div_bias = 0x1;\r\nbreak;\r\ncase 0x12:\r\nant_conf->fast_div_bias = 0x1;\r\nbreak;\r\ncase 0x13:\r\nif (!(antcomb->scan) &&\r\n(alt_ratio > ATH_ANT_DIV_COMB_ALT_ANT_RATIO))\r\nant_conf->fast_div_bias = 0x3f;\r\nelse\r\nant_conf->fast_div_bias = 0x1;\r\nbreak;\r\ncase 0x20:\r\nif (!(antcomb->scan) &&\r\n(alt_ratio > ATH_ANT_DIV_COMB_ALT_ANT_RATIO))\r\nant_conf->fast_div_bias = 0x3f;\r\nelse\r\nant_conf->fast_div_bias = 0x1;\r\nbreak;\r\ncase 0x21:\r\nant_conf->fast_div_bias = 0x1;\r\nbreak;\r\ncase 0x23:\r\nif (!(antcomb->scan) &&\r\n(alt_ratio > ATH_ANT_DIV_COMB_ALT_ANT_RATIO))\r\nant_conf->fast_div_bias = 0x3f;\r\nelse\r\nant_conf->fast_div_bias = 0x1;\r\nbreak;\r\ncase 0x30:\r\nant_conf->fast_div_bias = 0x1;\r\nbreak;\r\ncase 0x31:\r\nant_conf->fast_div_bias = 0x1;\r\nbreak;\r\ncase 0x32:\r\nant_conf->fast_div_bias = 0x1;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n} else if (ant_conf->div_group == 2) {\r\nswitch ((ant_conf->main_lna_conf << 4) |\r\nant_conf->alt_lna_conf) {\r\ncase 0x01:\r\nant_conf->fast_div_bias = 0x1;\r\nbreak;\r\ncase 0x02:\r\nant_conf->fast_div_bias = 0x1;\r\nbreak;\r\ncase 0x03:\r\nant_conf->fast_div_bias = 0x1;\r\nbreak;\r\ncase 0x10:\r\nif (!(antcomb->scan) &&\r\n(alt_ratio > ATH_ANT_DIV_COMB_ALT_ANT_RATIO))\r\nant_conf->fast_div_bias = 0x1;\r\nelse\r\nant_conf->fast_div_bias = 0x2;\r\nbreak;\r\ncase 0x12:\r\nant_conf->fast_div_bias = 0x1;\r\nbreak;\r\ncase 0x13:\r\nif (!(antcomb->scan) &&\r\n(alt_ratio > ATH_ANT_DIV_COMB_ALT_ANT_RATIO))\r\nant_conf->fast_div_bias = 0x1;\r\nelse\r\nant_conf->fast_div_bias = 0x2;\r\nbreak;\r\ncase 0x20:\r\nif (!(antcomb->scan) &&\r\n(alt_ratio > ATH_ANT_DIV_COMB_ALT_ANT_RATIO))\r\nant_conf->fast_div_bias = 0x1;\r\nelse\r\nant_conf->fast_div_bias = 0x2;\r\nbreak;\r\ncase 0x21:\r\nant_conf->fast_div_bias = 0x1;\r\nbreak;\r\ncase 0x23:\r\nif (!(antcomb->scan) &&\r\n(alt_ratio > ATH_ANT_DIV_COMB_ALT_ANT_RATIO))\r\nant_conf->fast_div_bias = 0x1;\r\nelse\r\nant_conf->fast_div_bias = 0x2;\r\nbreak;\r\ncase 0x30:\r\nant_conf->fast_div_bias = 0x1;\r\nbreak;\r\ncase 0x31:\r\nant_conf->fast_div_bias = 0x1;\r\nbreak;\r\ncase 0x32:\r\nant_conf->fast_div_bias = 0x1;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n} else if (ant_conf->div_group == 3) {\r\nswitch ((ant_conf->main_lna_conf << 4) |\r\nant_conf->alt_lna_conf) {\r\ncase 0x01:\r\nant_conf->fast_div_bias = 0x1;\r\nbreak;\r\ncase 0x02:\r\nant_conf->fast_div_bias = 0x39;\r\nbreak;\r\ncase 0x03:\r\nant_conf->fast_div_bias = 0x1;\r\nbreak;\r\ncase 0x10:\r\nif ((antcomb->scan == 0) &&\r\n(alt_ratio > ATH_ANT_DIV_COMB_ALT_ANT_RATIO)) {\r\nant_conf->fast_div_bias = 0x3f;\r\n} else {\r\nant_conf->fast_div_bias = 0x1;\r\n}\r\nbreak;\r\ncase 0x12:\r\nant_conf->fast_div_bias = 0x39;\r\nbreak;\r\ncase 0x13:\r\nif ((antcomb->scan == 0) &&\r\n(alt_ratio > ATH_ANT_DIV_COMB_ALT_ANT_RATIO)) {\r\nant_conf->fast_div_bias = 0x3f;\r\n} else {\r\nant_conf->fast_div_bias = 0x1;\r\n}\r\nbreak;\r\ncase 0x20:\r\nif ((antcomb->scan == 0) &&\r\n(alt_ratio > ATH_ANT_DIV_COMB_ALT_ANT_RATIO)) {\r\nant_conf->fast_div_bias = 0x3f;\r\n} else {\r\nant_conf->fast_div_bias = 0x4;\r\n}\r\nbreak;\r\ncase 0x21:\r\nant_conf->fast_div_bias = 0x6;\r\nbreak;\r\ncase 0x23:\r\nif ((antcomb->scan == 0) &&\r\n(alt_ratio > ATH_ANT_DIV_COMB_ALT_ANT_RATIO)) {\r\nant_conf->fast_div_bias = 0x3f;\r\n} else {\r\nant_conf->fast_div_bias = 0x6;\r\n}\r\nbreak;\r\ncase 0x30:\r\nant_conf->fast_div_bias = 0x1;\r\nbreak;\r\ncase 0x31:\r\nant_conf->fast_div_bias = 0x6;\r\nbreak;\r\ncase 0x32:\r\nant_conf->fast_div_bias = 0x1;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\nvoid ath_ant_comb_scan(struct ath_softc *sc, struct ath_rx_status *rs)\r\n{\r\nstruct ath_hw_antcomb_conf div_ant_conf;\r\nstruct ath_ant_comb *antcomb = &sc->ant_comb;\r\nint alt_ratio = 0, alt_rssi_avg = 0, main_rssi_avg = 0, curr_alt_set;\r\nint curr_main_set;\r\nint main_rssi = rs->rs_rssi_ctl0;\r\nint alt_rssi = rs->rs_rssi_ctl1;\r\nint rx_ant_conf, main_ant_conf;\r\nbool short_scan = false;\r\nrx_ant_conf = (rs->rs_rssi_ctl2 >> ATH_ANT_RX_CURRENT_SHIFT) &\r\nATH_ANT_RX_MASK;\r\nmain_ant_conf = (rs->rs_rssi_ctl2 >> ATH_ANT_RX_MAIN_SHIFT) &\r\nATH_ANT_RX_MASK;\r\nif (main_rssi > 0 && alt_rssi > 0) {\r\nantcomb->total_pkt_count++;\r\nantcomb->main_total_rssi += main_rssi;\r\nantcomb->alt_total_rssi += alt_rssi;\r\nif (main_ant_conf == rx_ant_conf)\r\nantcomb->main_recv_cnt++;\r\nelse\r\nantcomb->alt_recv_cnt++;\r\n}\r\nif (antcomb->scan && antcomb->alt_good) {\r\nif (time_after(jiffies, antcomb->scan_start_time +\r\nmsecs_to_jiffies(ATH_ANT_DIV_COMB_SHORT_SCAN_INTR)))\r\nshort_scan = true;\r\nelse\r\nif (antcomb->total_pkt_count ==\r\nATH_ANT_DIV_COMB_SHORT_SCAN_PKTCOUNT) {\r\nalt_ratio = ((antcomb->alt_recv_cnt * 100) /\r\nantcomb->total_pkt_count);\r\nif (alt_ratio < ATH_ANT_DIV_COMB_ALT_ANT_RATIO)\r\nshort_scan = true;\r\n}\r\n}\r\nif (((antcomb->total_pkt_count < ATH_ANT_DIV_COMB_MAX_PKTCOUNT) ||\r\nrs->rs_moreaggr) && !short_scan)\r\nreturn;\r\nif (antcomb->total_pkt_count) {\r\nalt_ratio = ((antcomb->alt_recv_cnt * 100) /\r\nantcomb->total_pkt_count);\r\nmain_rssi_avg = (antcomb->main_total_rssi /\r\nantcomb->total_pkt_count);\r\nalt_rssi_avg = (antcomb->alt_total_rssi /\r\nantcomb->total_pkt_count);\r\n}\r\nath9k_hw_antdiv_comb_conf_get(sc->sc_ah, &div_ant_conf);\r\ncurr_alt_set = div_ant_conf.alt_lna_conf;\r\ncurr_main_set = div_ant_conf.main_lna_conf;\r\nantcomb->count++;\r\nif (antcomb->count == ATH_ANT_DIV_COMB_MAX_COUNT) {\r\nif (alt_ratio > ATH_ANT_DIV_COMB_ALT_ANT_RATIO) {\r\nath_lnaconf_alt_good_scan(antcomb, div_ant_conf,\r\nmain_rssi_avg);\r\nantcomb->alt_good = true;\r\n} else {\r\nantcomb->alt_good = false;\r\n}\r\nantcomb->count = 0;\r\nantcomb->scan = true;\r\nantcomb->scan_not_start = true;\r\n}\r\nif (!antcomb->scan) {\r\nif (ath_ant_div_comb_alt_check(div_ant_conf.div_group,\r\nalt_ratio, curr_main_set, curr_alt_set,\r\nalt_rssi_avg, main_rssi_avg)) {\r\nif (curr_alt_set == ATH_ANT_DIV_COMB_LNA2) {\r\ndiv_ant_conf.main_lna_conf =\r\nATH_ANT_DIV_COMB_LNA2;\r\ndiv_ant_conf.alt_lna_conf =\r\nATH_ANT_DIV_COMB_LNA1;\r\n} else if (curr_alt_set == ATH_ANT_DIV_COMB_LNA1) {\r\ndiv_ant_conf.main_lna_conf =\r\nATH_ANT_DIV_COMB_LNA1;\r\ndiv_ant_conf.alt_lna_conf =\r\nATH_ANT_DIV_COMB_LNA2;\r\n}\r\ngoto div_comb_done;\r\n} else if ((curr_alt_set != ATH_ANT_DIV_COMB_LNA1) &&\r\n(curr_alt_set != ATH_ANT_DIV_COMB_LNA2)) {\r\nif (curr_main_set == ATH_ANT_DIV_COMB_LNA2)\r\ndiv_ant_conf.alt_lna_conf =\r\nATH_ANT_DIV_COMB_LNA1;\r\nelse if (curr_main_set == ATH_ANT_DIV_COMB_LNA1)\r\ndiv_ant_conf.alt_lna_conf =\r\nATH_ANT_DIV_COMB_LNA2;\r\ngoto div_comb_done;\r\n}\r\nif ((alt_rssi_avg < (main_rssi_avg +\r\ndiv_ant_conf.lna1_lna2_delta)))\r\ngoto div_comb_done;\r\n}\r\nif (!antcomb->scan_not_start) {\r\nswitch (curr_alt_set) {\r\ncase ATH_ANT_DIV_COMB_LNA2:\r\nantcomb->rssi_lna2 = alt_rssi_avg;\r\nantcomb->rssi_lna1 = main_rssi_avg;\r\nantcomb->scan = true;\r\ndiv_ant_conf.main_lna_conf =\r\nATH_ANT_DIV_COMB_LNA1;\r\ndiv_ant_conf.alt_lna_conf =\r\nATH_ANT_DIV_COMB_LNA1_PLUS_LNA2;\r\nbreak;\r\ncase ATH_ANT_DIV_COMB_LNA1:\r\nantcomb->rssi_lna1 = alt_rssi_avg;\r\nantcomb->rssi_lna2 = main_rssi_avg;\r\nantcomb->scan = true;\r\ndiv_ant_conf.main_lna_conf = ATH_ANT_DIV_COMB_LNA2;\r\ndiv_ant_conf.alt_lna_conf =\r\nATH_ANT_DIV_COMB_LNA1_PLUS_LNA2;\r\nbreak;\r\ncase ATH_ANT_DIV_COMB_LNA1_PLUS_LNA2:\r\nantcomb->rssi_add = alt_rssi_avg;\r\nantcomb->scan = true;\r\ndiv_ant_conf.alt_lna_conf =\r\nATH_ANT_DIV_COMB_LNA1_MINUS_LNA2;\r\nbreak;\r\ncase ATH_ANT_DIV_COMB_LNA1_MINUS_LNA2:\r\nantcomb->rssi_sub = alt_rssi_avg;\r\nantcomb->scan = false;\r\nif (antcomb->rssi_lna2 >\r\n(antcomb->rssi_lna1 +\r\nATH_ANT_DIV_COMB_LNA1_LNA2_SWITCH_DELTA)) {\r\nif ((antcomb->rssi_add > antcomb->rssi_lna1) &&\r\n(antcomb->rssi_add > antcomb->rssi_sub)) {\r\ndiv_ant_conf.main_lna_conf =\r\nATH_ANT_DIV_COMB_LNA2;\r\ndiv_ant_conf.alt_lna_conf =\r\nATH_ANT_DIV_COMB_LNA1_PLUS_LNA2;\r\n} else if (antcomb->rssi_sub >\r\nantcomb->rssi_lna1) {\r\ndiv_ant_conf.main_lna_conf =\r\nATH_ANT_DIV_COMB_LNA2;\r\ndiv_ant_conf.alt_lna_conf =\r\nATH_ANT_DIV_COMB_LNA1_MINUS_LNA2;\r\n} else {\r\ndiv_ant_conf.main_lna_conf =\r\nATH_ANT_DIV_COMB_LNA2;\r\ndiv_ant_conf.alt_lna_conf =\r\nATH_ANT_DIV_COMB_LNA1;\r\n}\r\n} else {\r\nif ((antcomb->rssi_add > antcomb->rssi_lna2) &&\r\n(antcomb->rssi_add > antcomb->rssi_sub)) {\r\ndiv_ant_conf.main_lna_conf =\r\nATH_ANT_DIV_COMB_LNA1;\r\ndiv_ant_conf.alt_lna_conf =\r\nATH_ANT_DIV_COMB_LNA1_PLUS_LNA2;\r\n} else if (antcomb->rssi_sub >\r\nantcomb->rssi_lna1) {\r\ndiv_ant_conf.main_lna_conf =\r\nATH_ANT_DIV_COMB_LNA1;\r\ndiv_ant_conf.alt_lna_conf =\r\nATH_ANT_DIV_COMB_LNA1_MINUS_LNA2;\r\n} else {\r\ndiv_ant_conf.main_lna_conf =\r\nATH_ANT_DIV_COMB_LNA1;\r\ndiv_ant_conf.alt_lna_conf =\r\nATH_ANT_DIV_COMB_LNA2;\r\n}\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n} else {\r\nif (!antcomb->alt_good) {\r\nantcomb->scan_not_start = false;\r\nif (curr_main_set == ATH_ANT_DIV_COMB_LNA2) {\r\ndiv_ant_conf.main_lna_conf =\r\nATH_ANT_DIV_COMB_LNA2;\r\ndiv_ant_conf.alt_lna_conf =\r\nATH_ANT_DIV_COMB_LNA1;\r\n} else if (curr_main_set == ATH_ANT_DIV_COMB_LNA1) {\r\ndiv_ant_conf.main_lna_conf =\r\nATH_ANT_DIV_COMB_LNA1;\r\ndiv_ant_conf.alt_lna_conf =\r\nATH_ANT_DIV_COMB_LNA2;\r\n}\r\ngoto div_comb_done;\r\n}\r\n}\r\nath_select_ant_div_from_quick_scan(antcomb, &div_ant_conf,\r\nmain_rssi_avg, alt_rssi_avg,\r\nalt_ratio);\r\nantcomb->quick_scan_cnt++;\r\ndiv_comb_done:\r\nath_ant_div_conf_fast_divbias(&div_ant_conf, antcomb, alt_ratio);\r\nath9k_hw_antdiv_comb_conf_set(sc->sc_ah, &div_ant_conf);\r\nantcomb->scan_start_time = jiffies;\r\nantcomb->total_pkt_count = 0;\r\nantcomb->main_total_rssi = 0;\r\nantcomb->alt_total_rssi = 0;\r\nantcomb->main_recv_cnt = 0;\r\nantcomb->alt_recv_cnt = 0;\r\n}\r\nvoid ath_ant_comb_update(struct ath_softc *sc)\r\n{\r\nstruct ath_hw *ah = sc->sc_ah;\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nstruct ath_hw_antcomb_conf div_ant_conf;\r\nu8 lna_conf;\r\nath9k_hw_antdiv_comb_conf_get(ah, &div_ant_conf);\r\nif (sc->ant_rx == 1)\r\nlna_conf = ATH_ANT_DIV_COMB_LNA1;\r\nelse\r\nlna_conf = ATH_ANT_DIV_COMB_LNA2;\r\ndiv_ant_conf.main_lna_conf = lna_conf;\r\ndiv_ant_conf.alt_lna_conf = lna_conf;\r\nath9k_hw_antdiv_comb_conf_set(ah, &div_ant_conf);\r\nif (common->antenna_diversity)\r\nath9k_hw_antctrl_shared_chain_lnadiv(ah, true);\r\n}

static int m41t81_read(uint8_t addr)\r\n{\r\nwhile (__raw_readq(SMB_CSR(R_SMB_STATUS)) & M_SMB_BUSY)\r\n;\r\n__raw_writeq(addr & 0xff, SMB_CSR(R_SMB_CMD));\r\n__raw_writeq(V_SMB_ADDR(M41T81_CCR_ADDRESS) | V_SMB_TT_WR1BYTE,\r\nSMB_CSR(R_SMB_START));\r\nwhile (__raw_readq(SMB_CSR(R_SMB_STATUS)) & M_SMB_BUSY)\r\n;\r\n__raw_writeq(V_SMB_ADDR(M41T81_CCR_ADDRESS) | V_SMB_TT_RD1BYTE,\r\nSMB_CSR(R_SMB_START));\r\nwhile (__raw_readq(SMB_CSR(R_SMB_STATUS)) & M_SMB_BUSY)\r\n;\r\nif (__raw_readq(SMB_CSR(R_SMB_STATUS)) & M_SMB_ERROR) {\r\n__raw_writeq(M_SMB_ERROR, SMB_CSR(R_SMB_STATUS));\r\nreturn -1;\r\n}\r\nreturn (__raw_readq(SMB_CSR(R_SMB_DATA)) & 0xff);\r\n}\r\nstatic int m41t81_write(uint8_t addr, int b)\r\n{\r\nwhile (__raw_readq(SMB_CSR(R_SMB_STATUS)) & M_SMB_BUSY)\r\n;\r\n__raw_writeq(addr & 0xff, SMB_CSR(R_SMB_CMD));\r\n__raw_writeq(b & 0xff, SMB_CSR(R_SMB_DATA));\r\n__raw_writeq(V_SMB_ADDR(M41T81_CCR_ADDRESS) | V_SMB_TT_WR2BYTE,\r\nSMB_CSR(R_SMB_START));\r\nwhile (__raw_readq(SMB_CSR(R_SMB_STATUS)) & M_SMB_BUSY)\r\n;\r\nif (__raw_readq(SMB_CSR(R_SMB_STATUS)) & M_SMB_ERROR) {\r\n__raw_writeq(M_SMB_ERROR, SMB_CSR(R_SMB_STATUS));\r\nreturn -1;\r\n}\r\n__raw_writeq(V_SMB_ADDR(M41T81_CCR_ADDRESS) | V_SMB_TT_RD1BYTE,\r\nSMB_CSR(R_SMB_START));\r\nwhile (__raw_readq(SMB_CSR(R_SMB_STATUS)) & M_SMB_BUSY)\r\n;\r\nreturn 0;\r\n}\r\nint m41t81_set_time(unsigned long t)\r\n{\r\nstruct rtc_time tm;\r\nunsigned long flags;\r\nrtc_time_to_tm(t, &tm);\r\nspin_lock_irqsave(&rtc_lock, flags);\r\ntm.tm_sec = bin2bcd(tm.tm_sec);\r\nm41t81_write(M41T81REG_SC, tm.tm_sec);\r\ntm.tm_min = bin2bcd(tm.tm_min);\r\nm41t81_write(M41T81REG_MN, tm.tm_min);\r\ntm.tm_hour = bin2bcd(tm.tm_hour);\r\ntm.tm_hour = (tm.tm_hour & 0x3f) | (m41t81_read(M41T81REG_HR) & 0xc0);\r\nm41t81_write(M41T81REG_HR, tm.tm_hour);\r\nif (tm.tm_wday == 0) tm.tm_wday = 7;\r\ntm.tm_wday = bin2bcd(tm.tm_wday);\r\nm41t81_write(M41T81REG_DY, tm.tm_wday);\r\ntm.tm_mday = bin2bcd(tm.tm_mday);\r\nm41t81_write(M41T81REG_DT, tm.tm_mday);\r\ntm.tm_mon ++;\r\ntm.tm_mon = bin2bcd(tm.tm_mon);\r\nm41t81_write(M41T81REG_MO, tm.tm_mon);\r\ntm.tm_year %= 100;\r\ntm.tm_year = bin2bcd(tm.tm_year);\r\nm41t81_write(M41T81REG_YR, tm.tm_year);\r\nspin_unlock_irqrestore(&rtc_lock, flags);\r\nreturn 0;\r\n}\r\nunsigned long m41t81_get_time(void)\r\n{\r\nunsigned int year, mon, day, hour, min, sec;\r\nunsigned long flags;\r\nfor (;;) {\r\nspin_lock_irqsave(&rtc_lock, flags);\r\nsec = m41t81_read(M41T81REG_SC);\r\nmin = m41t81_read(M41T81REG_MN);\r\nif (sec == m41t81_read(M41T81REG_SC)) break;\r\nspin_unlock_irqrestore(&rtc_lock, flags);\r\n}\r\nhour = m41t81_read(M41T81REG_HR) & 0x3f;\r\nday = m41t81_read(M41T81REG_DT);\r\nmon = m41t81_read(M41T81REG_MO);\r\nyear = m41t81_read(M41T81REG_YR);\r\nspin_unlock_irqrestore(&rtc_lock, flags);\r\nsec = bcd2bin(sec);\r\nmin = bcd2bin(min);\r\nhour = bcd2bin(hour);\r\nday = bcd2bin(day);\r\nmon = bcd2bin(mon);\r\nyear = bcd2bin(year);\r\nyear += 2000;\r\nreturn mktime(year, mon, day, hour, min, sec);\r\n}\r\nint m41t81_probe(void)\r\n{\r\nunsigned int tmp;\r\ntmp = m41t81_read(M41T81REG_SC);\r\nm41t81_write(M41T81REG_SC, tmp & 0x7f);\r\nreturn (m41t81_read(M41T81REG_SC) != -1);\r\n}

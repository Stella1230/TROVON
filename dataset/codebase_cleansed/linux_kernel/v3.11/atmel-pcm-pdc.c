static void atmel_pcm_dma_irq(u32 ssc_sr,\r\nstruct snd_pcm_substream *substream)\r\n{\r\nstruct atmel_runtime_data *prtd = substream->runtime->private_data;\r\nstruct atmel_pcm_dma_params *params = prtd->params;\r\nstatic int count;\r\ncount++;\r\nif (ssc_sr & params->mask->ssc_endbuf) {\r\npr_warn("atmel-pcm: buffer %s on %s (SSC_SR=%#x, count=%d)\n",\r\nsubstream->stream == SNDRV_PCM_STREAM_PLAYBACK\r\n? "underrun" : "overrun",\r\nparams->name, ssc_sr, count);\r\nssc_writex(params->ssc->regs, ATMEL_PDC_PTCR,\r\nparams->mask->pdc_disable);\r\nprtd->period_ptr += prtd->period_size;\r\nif (prtd->period_ptr >= prtd->dma_buffer_end)\r\nprtd->period_ptr = prtd->dma_buffer;\r\nssc_writex(params->ssc->regs, params->pdc->xpr,\r\nprtd->period_ptr);\r\nssc_writex(params->ssc->regs, params->pdc->xcr,\r\nprtd->period_size / params->pdc_xfer_size);\r\nssc_writex(params->ssc->regs, ATMEL_PDC_PTCR,\r\nparams->mask->pdc_enable);\r\n}\r\nif (ssc_sr & params->mask->ssc_endx) {\r\nprtd->period_ptr += prtd->period_size;\r\nif (prtd->period_ptr >= prtd->dma_buffer_end)\r\nprtd->period_ptr = prtd->dma_buffer;\r\nssc_writex(params->ssc->regs, params->pdc->xnpr,\r\nprtd->period_ptr);\r\nssc_writex(params->ssc->regs, params->pdc->xncr,\r\nprtd->period_size / params->pdc_xfer_size);\r\n}\r\nsnd_pcm_period_elapsed(substream);\r\n}\r\nstatic int atmel_pcm_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct atmel_runtime_data *prtd = runtime->private_data;\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nsnd_pcm_set_runtime_buffer(substream, &substream->dma_buffer);\r\nruntime->dma_bytes = params_buffer_bytes(params);\r\nprtd->params = snd_soc_dai_get_dma_data(rtd->cpu_dai, substream);\r\nprtd->params->dma_intr_handler = atmel_pcm_dma_irq;\r\nprtd->dma_buffer = runtime->dma_addr;\r\nprtd->dma_buffer_end = runtime->dma_addr + runtime->dma_bytes;\r\nprtd->period_size = params_period_bytes(params);\r\npr_debug("atmel-pcm: "\r\n"hw_params: DMA for %s initialized "\r\n"(dma_bytes=%zu, period_size=%zu)\n",\r\nprtd->params->name,\r\nruntime->dma_bytes,\r\nprtd->period_size);\r\nreturn 0;\r\n}\r\nstatic int atmel_pcm_hw_free(struct snd_pcm_substream *substream)\r\n{\r\nstruct atmel_runtime_data *prtd = substream->runtime->private_data;\r\nstruct atmel_pcm_dma_params *params = prtd->params;\r\nif (params != NULL) {\r\nssc_writex(params->ssc->regs, SSC_PDC_PTCR,\r\nparams->mask->pdc_disable);\r\nprtd->params->dma_intr_handler = NULL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int atmel_pcm_prepare(struct snd_pcm_substream *substream)\r\n{\r\nstruct atmel_runtime_data *prtd = substream->runtime->private_data;\r\nstruct atmel_pcm_dma_params *params = prtd->params;\r\nssc_writex(params->ssc->regs, SSC_IDR,\r\nparams->mask->ssc_endx | params->mask->ssc_endbuf);\r\nssc_writex(params->ssc->regs, ATMEL_PDC_PTCR,\r\nparams->mask->pdc_disable);\r\nreturn 0;\r\n}\r\nstatic int atmel_pcm_trigger(struct snd_pcm_substream *substream,\r\nint cmd)\r\n{\r\nstruct snd_pcm_runtime *rtd = substream->runtime;\r\nstruct atmel_runtime_data *prtd = rtd->private_data;\r\nstruct atmel_pcm_dma_params *params = prtd->params;\r\nint ret = 0;\r\npr_debug("atmel-pcm:buffer_size = %ld,"\r\n"dma_area = %p, dma_bytes = %zu\n",\r\nrtd->buffer_size, rtd->dma_area, rtd->dma_bytes);\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\nprtd->period_ptr = prtd->dma_buffer;\r\nssc_writex(params->ssc->regs, params->pdc->xpr,\r\nprtd->period_ptr);\r\nssc_writex(params->ssc->regs, params->pdc->xcr,\r\nprtd->period_size / params->pdc_xfer_size);\r\nprtd->period_ptr += prtd->period_size;\r\nssc_writex(params->ssc->regs, params->pdc->xnpr,\r\nprtd->period_ptr);\r\nssc_writex(params->ssc->regs, params->pdc->xncr,\r\nprtd->period_size / params->pdc_xfer_size);\r\npr_debug("atmel-pcm: trigger: "\r\n"period_ptr=%lx, xpr=%u, "\r\n"xcr=%u, xnpr=%u, xncr=%u\n",\r\n(unsigned long)prtd->period_ptr,\r\nssc_readx(params->ssc->regs, params->pdc->xpr),\r\nssc_readx(params->ssc->regs, params->pdc->xcr),\r\nssc_readx(params->ssc->regs, params->pdc->xnpr),\r\nssc_readx(params->ssc->regs, params->pdc->xncr));\r\nssc_writex(params->ssc->regs, SSC_IER,\r\nparams->mask->ssc_endx | params->mask->ssc_endbuf);\r\nssc_writex(params->ssc->regs, SSC_PDC_PTCR,\r\nparams->mask->pdc_enable);\r\npr_debug("sr=%u imr=%u\n",\r\nssc_readx(params->ssc->regs, SSC_SR),\r\nssc_readx(params->ssc->regs, SSC_IER));\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\r\nssc_writex(params->ssc->regs, ATMEL_PDC_PTCR,\r\nparams->mask->pdc_disable);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\r\nssc_writex(params->ssc->regs, ATMEL_PDC_PTCR,\r\nparams->mask->pdc_enable);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\n}\r\nreturn ret;\r\n}\r\nstatic snd_pcm_uframes_t atmel_pcm_pointer(\r\nstruct snd_pcm_substream *substream)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct atmel_runtime_data *prtd = runtime->private_data;\r\nstruct atmel_pcm_dma_params *params = prtd->params;\r\ndma_addr_t ptr;\r\nsnd_pcm_uframes_t x;\r\nptr = (dma_addr_t) ssc_readx(params->ssc->regs, params->pdc->xpr);\r\nx = bytes_to_frames(runtime, ptr - prtd->dma_buffer);\r\nif (x == runtime->buffer_size)\r\nx = 0;\r\nreturn x;\r\n}\r\nstatic int atmel_pcm_open(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct atmel_runtime_data *prtd;\r\nint ret = 0;\r\nsnd_soc_set_runtime_hwparams(substream, &atmel_pcm_hardware);\r\nret = snd_pcm_hw_constraint_integer(runtime,\r\nSNDRV_PCM_HW_PARAM_PERIODS);\r\nif (ret < 0)\r\ngoto out;\r\nprtd = kzalloc(sizeof(struct atmel_runtime_data), GFP_KERNEL);\r\nif (prtd == NULL) {\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nruntime->private_data = prtd;\r\nout:\r\nreturn ret;\r\n}\r\nstatic int atmel_pcm_close(struct snd_pcm_substream *substream)\r\n{\r\nstruct atmel_runtime_data *prtd = substream->runtime->private_data;\r\nkfree(prtd);\r\nreturn 0;\r\n}\r\nstatic int atmel_pcm_suspend(struct snd_soc_dai *dai)\r\n{\r\nstruct snd_pcm_runtime *runtime = dai->runtime;\r\nstruct atmel_runtime_data *prtd;\r\nstruct atmel_pcm_dma_params *params;\r\nif (!runtime)\r\nreturn 0;\r\nprtd = runtime->private_data;\r\nparams = prtd->params;\r\nssc_writel(params->ssc->regs, PDC_PTCR, params->mask->pdc_disable);\r\nprtd->pdc_xpr_save = ssc_readx(params->ssc->regs, params->pdc->xpr);\r\nprtd->pdc_xcr_save = ssc_readx(params->ssc->regs, params->pdc->xcr);\r\nprtd->pdc_xnpr_save = ssc_readx(params->ssc->regs, params->pdc->xnpr);\r\nprtd->pdc_xncr_save = ssc_readx(params->ssc->regs, params->pdc->xncr);\r\nreturn 0;\r\n}\r\nstatic int atmel_pcm_resume(struct snd_soc_dai *dai)\r\n{\r\nstruct snd_pcm_runtime *runtime = dai->runtime;\r\nstruct atmel_runtime_data *prtd;\r\nstruct atmel_pcm_dma_params *params;\r\nif (!runtime)\r\nreturn 0;\r\nprtd = runtime->private_data;\r\nparams = prtd->params;\r\nssc_writex(params->ssc->regs, params->pdc->xpr, prtd->pdc_xpr_save);\r\nssc_writex(params->ssc->regs, params->pdc->xcr, prtd->pdc_xcr_save);\r\nssc_writex(params->ssc->regs, params->pdc->xnpr, prtd->pdc_xnpr_save);\r\nssc_writex(params->ssc->regs, params->pdc->xncr, prtd->pdc_xncr_save);\r\nssc_writel(params->ssc->regs, PDC_PTCR, params->mask->pdc_enable);\r\nreturn 0;\r\n}\r\nint atmel_pcm_pdc_platform_register(struct device *dev)\r\n{\r\nreturn snd_soc_register_platform(dev, &atmel_soc_platform);\r\n}\r\nvoid atmel_pcm_pdc_platform_unregister(struct device *dev)\r\n{\r\nsnd_soc_unregister_platform(dev);\r\n}

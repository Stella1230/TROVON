static struct ssb_bus *ssb_gpio_get_bus(struct gpio_chip *chip)\r\n{\r\nreturn container_of(chip, struct ssb_bus, gpio);\r\n}\r\nstatic int ssb_gpio_chipco_get_value(struct gpio_chip *chip, unsigned gpio)\r\n{\r\nstruct ssb_bus *bus = ssb_gpio_get_bus(chip);\r\nreturn !!ssb_chipco_gpio_in(&bus->chipco, 1 << gpio);\r\n}\r\nstatic void ssb_gpio_chipco_set_value(struct gpio_chip *chip, unsigned gpio,\r\nint value)\r\n{\r\nstruct ssb_bus *bus = ssb_gpio_get_bus(chip);\r\nssb_chipco_gpio_out(&bus->chipco, 1 << gpio, value ? 1 << gpio : 0);\r\n}\r\nstatic int ssb_gpio_chipco_direction_input(struct gpio_chip *chip,\r\nunsigned gpio)\r\n{\r\nstruct ssb_bus *bus = ssb_gpio_get_bus(chip);\r\nssb_chipco_gpio_outen(&bus->chipco, 1 << gpio, 0);\r\nreturn 0;\r\n}\r\nstatic int ssb_gpio_chipco_direction_output(struct gpio_chip *chip,\r\nunsigned gpio, int value)\r\n{\r\nstruct ssb_bus *bus = ssb_gpio_get_bus(chip);\r\nssb_chipco_gpio_outen(&bus->chipco, 1 << gpio, 1 << gpio);\r\nssb_chipco_gpio_out(&bus->chipco, 1 << gpio, value ? 1 << gpio : 0);\r\nreturn 0;\r\n}\r\nstatic int ssb_gpio_chipco_request(struct gpio_chip *chip, unsigned gpio)\r\n{\r\nstruct ssb_bus *bus = ssb_gpio_get_bus(chip);\r\nssb_chipco_gpio_control(&bus->chipco, 1 << gpio, 0);\r\nssb_chipco_gpio_pulldown(&bus->chipco, 1 << gpio, 0);\r\nssb_chipco_gpio_pullup(&bus->chipco, 1 << gpio, 1 << gpio);\r\nreturn 0;\r\n}\r\nstatic void ssb_gpio_chipco_free(struct gpio_chip *chip, unsigned gpio)\r\n{\r\nstruct ssb_bus *bus = ssb_gpio_get_bus(chip);\r\nssb_chipco_gpio_pullup(&bus->chipco, 1 << gpio, 0);\r\n}\r\nstatic int ssb_gpio_chipco_to_irq(struct gpio_chip *chip, unsigned gpio)\r\n{\r\nstruct ssb_bus *bus = ssb_gpio_get_bus(chip);\r\nif (bus->bustype == SSB_BUSTYPE_SSB)\r\nreturn ssb_mips_irq(bus->chipco.dev) + 2;\r\nelse\r\nreturn -EINVAL;\r\n}\r\nstatic int ssb_gpio_chipco_init(struct ssb_bus *bus)\r\n{\r\nstruct gpio_chip *chip = &bus->gpio;\r\nchip->label = "ssb_chipco_gpio";\r\nchip->owner = THIS_MODULE;\r\nchip->request = ssb_gpio_chipco_request;\r\nchip->free = ssb_gpio_chipco_free;\r\nchip->get = ssb_gpio_chipco_get_value;\r\nchip->set = ssb_gpio_chipco_set_value;\r\nchip->direction_input = ssb_gpio_chipco_direction_input;\r\nchip->direction_output = ssb_gpio_chipco_direction_output;\r\nchip->to_irq = ssb_gpio_chipco_to_irq;\r\nchip->ngpio = 16;\r\nif (bus->bustype == SSB_BUSTYPE_SSB)\r\nchip->base = 0;\r\nelse\r\nchip->base = -1;\r\nreturn gpiochip_add(chip);\r\n}\r\nstatic int ssb_gpio_extif_get_value(struct gpio_chip *chip, unsigned gpio)\r\n{\r\nstruct ssb_bus *bus = ssb_gpio_get_bus(chip);\r\nreturn !!ssb_extif_gpio_in(&bus->extif, 1 << gpio);\r\n}\r\nstatic void ssb_gpio_extif_set_value(struct gpio_chip *chip, unsigned gpio,\r\nint value)\r\n{\r\nstruct ssb_bus *bus = ssb_gpio_get_bus(chip);\r\nssb_extif_gpio_out(&bus->extif, 1 << gpio, value ? 1 << gpio : 0);\r\n}\r\nstatic int ssb_gpio_extif_direction_input(struct gpio_chip *chip,\r\nunsigned gpio)\r\n{\r\nstruct ssb_bus *bus = ssb_gpio_get_bus(chip);\r\nssb_extif_gpio_outen(&bus->extif, 1 << gpio, 0);\r\nreturn 0;\r\n}\r\nstatic int ssb_gpio_extif_direction_output(struct gpio_chip *chip,\r\nunsigned gpio, int value)\r\n{\r\nstruct ssb_bus *bus = ssb_gpio_get_bus(chip);\r\nssb_extif_gpio_outen(&bus->extif, 1 << gpio, 1 << gpio);\r\nssb_extif_gpio_out(&bus->extif, 1 << gpio, value ? 1 << gpio : 0);\r\nreturn 0;\r\n}\r\nstatic int ssb_gpio_extif_to_irq(struct gpio_chip *chip, unsigned gpio)\r\n{\r\nstruct ssb_bus *bus = ssb_gpio_get_bus(chip);\r\nif (bus->bustype == SSB_BUSTYPE_SSB)\r\nreturn ssb_mips_irq(bus->extif.dev) + 2;\r\nelse\r\nreturn -EINVAL;\r\n}\r\nstatic int ssb_gpio_extif_init(struct ssb_bus *bus)\r\n{\r\nstruct gpio_chip *chip = &bus->gpio;\r\nchip->label = "ssb_extif_gpio";\r\nchip->owner = THIS_MODULE;\r\nchip->get = ssb_gpio_extif_get_value;\r\nchip->set = ssb_gpio_extif_set_value;\r\nchip->direction_input = ssb_gpio_extif_direction_input;\r\nchip->direction_output = ssb_gpio_extif_direction_output;\r\nchip->to_irq = ssb_gpio_extif_to_irq;\r\nchip->ngpio = 5;\r\nif (bus->bustype == SSB_BUSTYPE_SSB)\r\nchip->base = 0;\r\nelse\r\nchip->base = -1;\r\nreturn gpiochip_add(chip);\r\n}\r\nstatic int ssb_gpio_extif_init(struct ssb_bus *bus)\r\n{\r\nreturn -ENOTSUPP;\r\n}\r\nint ssb_gpio_init(struct ssb_bus *bus)\r\n{\r\nif (ssb_chipco_available(&bus->chipco))\r\nreturn ssb_gpio_chipco_init(bus);\r\nelse if (ssb_extif_available(&bus->extif))\r\nreturn ssb_gpio_extif_init(bus);\r\nelse\r\nSSB_WARN_ON(1);\r\nreturn -1;\r\n}\r\nint ssb_gpio_unregister(struct ssb_bus *bus)\r\n{\r\nif (ssb_chipco_available(&bus->chipco) ||\r\nssb_extif_available(&bus->extif)) {\r\nreturn gpiochip_remove(&bus->gpio);\r\n} else {\r\nSSB_WARN_ON(1);\r\n}\r\nreturn -1;\r\n}

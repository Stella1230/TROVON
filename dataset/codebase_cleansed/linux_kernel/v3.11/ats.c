static int ats_alloc_one(struct pci_dev *dev, int ps)\r\n{\r\nint pos;\r\nu16 cap;\r\nstruct pci_ats *ats;\r\npos = pci_find_ext_capability(dev, PCI_EXT_CAP_ID_ATS);\r\nif (!pos)\r\nreturn -ENODEV;\r\nats = kzalloc(sizeof(*ats), GFP_KERNEL);\r\nif (!ats)\r\nreturn -ENOMEM;\r\nats->pos = pos;\r\nats->stu = ps;\r\npci_read_config_word(dev, pos + PCI_ATS_CAP, &cap);\r\nats->qdep = PCI_ATS_CAP_QDEP(cap) ? PCI_ATS_CAP_QDEP(cap) :\r\nPCI_ATS_MAX_QDEP;\r\ndev->ats = ats;\r\nreturn 0;\r\n}\r\nstatic void ats_free_one(struct pci_dev *dev)\r\n{\r\nkfree(dev->ats);\r\ndev->ats = NULL;\r\n}\r\nint pci_enable_ats(struct pci_dev *dev, int ps)\r\n{\r\nint rc;\r\nu16 ctrl;\r\nBUG_ON(dev->ats && dev->ats->is_enabled);\r\nif (ps < PCI_ATS_MIN_STU)\r\nreturn -EINVAL;\r\nif (dev->is_physfn || dev->is_virtfn) {\r\nstruct pci_dev *pdev = dev->is_physfn ? dev : dev->physfn;\r\nmutex_lock(&pdev->sriov->lock);\r\nif (pdev->ats)\r\nrc = pdev->ats->stu == ps ? 0 : -EINVAL;\r\nelse\r\nrc = ats_alloc_one(pdev, ps);\r\nif (!rc)\r\npdev->ats->ref_cnt++;\r\nmutex_unlock(&pdev->sriov->lock);\r\nif (rc)\r\nreturn rc;\r\n}\r\nif (!dev->is_physfn) {\r\nrc = ats_alloc_one(dev, ps);\r\nif (rc)\r\nreturn rc;\r\n}\r\nctrl = PCI_ATS_CTRL_ENABLE;\r\nif (!dev->is_virtfn)\r\nctrl |= PCI_ATS_CTRL_STU(ps - PCI_ATS_MIN_STU);\r\npci_write_config_word(dev, dev->ats->pos + PCI_ATS_CTRL, ctrl);\r\ndev->ats->is_enabled = 1;\r\nreturn 0;\r\n}\r\nvoid pci_disable_ats(struct pci_dev *dev)\r\n{\r\nu16 ctrl;\r\nBUG_ON(!dev->ats || !dev->ats->is_enabled);\r\npci_read_config_word(dev, dev->ats->pos + PCI_ATS_CTRL, &ctrl);\r\nctrl &= ~PCI_ATS_CTRL_ENABLE;\r\npci_write_config_word(dev, dev->ats->pos + PCI_ATS_CTRL, ctrl);\r\ndev->ats->is_enabled = 0;\r\nif (dev->is_physfn || dev->is_virtfn) {\r\nstruct pci_dev *pdev = dev->is_physfn ? dev : dev->physfn;\r\nmutex_lock(&pdev->sriov->lock);\r\npdev->ats->ref_cnt--;\r\nif (!pdev->ats->ref_cnt)\r\nats_free_one(pdev);\r\nmutex_unlock(&pdev->sriov->lock);\r\n}\r\nif (!dev->is_physfn)\r\nats_free_one(dev);\r\n}\r\nvoid pci_restore_ats_state(struct pci_dev *dev)\r\n{\r\nu16 ctrl;\r\nif (!pci_ats_enabled(dev))\r\nreturn;\r\nif (!pci_find_ext_capability(dev, PCI_EXT_CAP_ID_ATS))\r\nBUG();\r\nctrl = PCI_ATS_CTRL_ENABLE;\r\nif (!dev->is_virtfn)\r\nctrl |= PCI_ATS_CTRL_STU(dev->ats->stu - PCI_ATS_MIN_STU);\r\npci_write_config_word(dev, dev->ats->pos + PCI_ATS_CTRL, ctrl);\r\n}\r\nint pci_ats_queue_depth(struct pci_dev *dev)\r\n{\r\nint pos;\r\nu16 cap;\r\nif (dev->is_virtfn)\r\nreturn 0;\r\nif (dev->ats)\r\nreturn dev->ats->qdep;\r\npos = pci_find_ext_capability(dev, PCI_EXT_CAP_ID_ATS);\r\nif (!pos)\r\nreturn -ENODEV;\r\npci_read_config_word(dev, pos + PCI_ATS_CAP, &cap);\r\nreturn PCI_ATS_CAP_QDEP(cap) ? PCI_ATS_CAP_QDEP(cap) :\r\nPCI_ATS_MAX_QDEP;\r\n}\r\nint pci_enable_pri(struct pci_dev *pdev, u32 reqs)\r\n{\r\nu16 control, status;\r\nu32 max_requests;\r\nint pos;\r\npos = pci_find_ext_capability(pdev, PCI_EXT_CAP_ID_PRI);\r\nif (!pos)\r\nreturn -EINVAL;\r\npci_read_config_word(pdev, pos + PCI_PRI_CTRL, &control);\r\npci_read_config_word(pdev, pos + PCI_PRI_STATUS, &status);\r\nif ((control & PCI_PRI_CTRL_ENABLE) ||\r\n!(status & PCI_PRI_STATUS_STOPPED))\r\nreturn -EBUSY;\r\npci_read_config_dword(pdev, pos + PCI_PRI_MAX_REQ, &max_requests);\r\nreqs = min(max_requests, reqs);\r\npci_write_config_dword(pdev, pos + PCI_PRI_ALLOC_REQ, reqs);\r\ncontrol |= PCI_PRI_CTRL_ENABLE;\r\npci_write_config_word(pdev, pos + PCI_PRI_CTRL, control);\r\nreturn 0;\r\n}\r\nvoid pci_disable_pri(struct pci_dev *pdev)\r\n{\r\nu16 control;\r\nint pos;\r\npos = pci_find_ext_capability(pdev, PCI_EXT_CAP_ID_PRI);\r\nif (!pos)\r\nreturn;\r\npci_read_config_word(pdev, pos + PCI_PRI_CTRL, &control);\r\ncontrol &= ~PCI_PRI_CTRL_ENABLE;\r\npci_write_config_word(pdev, pos + PCI_PRI_CTRL, control);\r\n}\r\nbool pci_pri_enabled(struct pci_dev *pdev)\r\n{\r\nu16 control;\r\nint pos;\r\npos = pci_find_ext_capability(pdev, PCI_EXT_CAP_ID_PRI);\r\nif (!pos)\r\nreturn false;\r\npci_read_config_word(pdev, pos + PCI_PRI_CTRL, &control);\r\nreturn (control & PCI_PRI_CTRL_ENABLE) ? true : false;\r\n}\r\nint pci_reset_pri(struct pci_dev *pdev)\r\n{\r\nu16 control;\r\nint pos;\r\npos = pci_find_ext_capability(pdev, PCI_EXT_CAP_ID_PRI);\r\nif (!pos)\r\nreturn -EINVAL;\r\npci_read_config_word(pdev, pos + PCI_PRI_CTRL, &control);\r\nif (control & PCI_PRI_CTRL_ENABLE)\r\nreturn -EBUSY;\r\ncontrol |= PCI_PRI_CTRL_RESET;\r\npci_write_config_word(pdev, pos + PCI_PRI_CTRL, control);\r\nreturn 0;\r\n}\r\nbool pci_pri_stopped(struct pci_dev *pdev)\r\n{\r\nu16 control, status;\r\nint pos;\r\npos = pci_find_ext_capability(pdev, PCI_EXT_CAP_ID_PRI);\r\nif (!pos)\r\nreturn true;\r\npci_read_config_word(pdev, pos + PCI_PRI_CTRL, &control);\r\npci_read_config_word(pdev, pos + PCI_PRI_STATUS, &status);\r\nif (control & PCI_PRI_CTRL_ENABLE)\r\nreturn false;\r\nreturn (status & PCI_PRI_STATUS_STOPPED) ? true : false;\r\n}\r\nint pci_pri_status(struct pci_dev *pdev)\r\n{\r\nu16 status, control;\r\nint pos;\r\npos = pci_find_ext_capability(pdev, PCI_EXT_CAP_ID_PRI);\r\nif (!pos)\r\nreturn -EINVAL;\r\npci_read_config_word(pdev, pos + PCI_PRI_CTRL, &control);\r\npci_read_config_word(pdev, pos + PCI_PRI_STATUS, &status);\r\nif (control & PCI_PRI_CTRL_ENABLE)\r\nstatus &= ~PCI_PRI_STATUS_STOPPED;\r\nreturn status;\r\n}\r\nint pci_enable_pasid(struct pci_dev *pdev, int features)\r\n{\r\nu16 control, supported;\r\nint pos;\r\npos = pci_find_ext_capability(pdev, PCI_EXT_CAP_ID_PASID);\r\nif (!pos)\r\nreturn -EINVAL;\r\npci_read_config_word(pdev, pos + PCI_PASID_CTRL, &control);\r\npci_read_config_word(pdev, pos + PCI_PASID_CAP, &supported);\r\nif (control & PCI_PASID_CTRL_ENABLE)\r\nreturn -EINVAL;\r\nsupported &= PCI_PASID_CAP_EXEC | PCI_PASID_CAP_PRIV;\r\nif ((supported & features) != features)\r\nreturn -EINVAL;\r\ncontrol = PCI_PASID_CTRL_ENABLE | features;\r\npci_write_config_word(pdev, pos + PCI_PASID_CTRL, control);\r\nreturn 0;\r\n}\r\nvoid pci_disable_pasid(struct pci_dev *pdev)\r\n{\r\nu16 control = 0;\r\nint pos;\r\npos = pci_find_ext_capability(pdev, PCI_EXT_CAP_ID_PASID);\r\nif (!pos)\r\nreturn;\r\npci_write_config_word(pdev, pos + PCI_PASID_CTRL, control);\r\n}\r\nint pci_pasid_features(struct pci_dev *pdev)\r\n{\r\nu16 supported;\r\nint pos;\r\npos = pci_find_ext_capability(pdev, PCI_EXT_CAP_ID_PASID);\r\nif (!pos)\r\nreturn -EINVAL;\r\npci_read_config_word(pdev, pos + PCI_PASID_CAP, &supported);\r\nsupported &= PCI_PASID_CAP_EXEC | PCI_PASID_CAP_PRIV;\r\nreturn supported;\r\n}\r\nint pci_max_pasids(struct pci_dev *pdev)\r\n{\r\nu16 supported;\r\nint pos;\r\npos = pci_find_ext_capability(pdev, PCI_EXT_CAP_ID_PASID);\r\nif (!pos)\r\nreturn -EINVAL;\r\npci_read_config_word(pdev, pos + PCI_PASID_CAP, &supported);\r\nsupported = (supported & PASID_NUMBER_MASK) >> PASID_NUMBER_SHIFT;\r\nreturn (1 << supported);\r\n}

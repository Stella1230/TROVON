static int s5p6450_epll_set_rate(struct clk *clk, unsigned long rate)\r\n{\r\nunsigned int epll_con, epll_con_k;\r\nunsigned int i;\r\nif (clk->rate == rate)\r\nreturn 0;\r\nepll_con = __raw_readl(S5P64X0_EPLL_CON);\r\nepll_con_k = __raw_readl(S5P64X0_EPLL_CON_K);\r\nepll_con_k &= ~(PLL90XX_KDIV_MASK);\r\nepll_con &= ~(PLL90XX_MDIV_MASK | PLL90XX_PDIV_MASK | PLL90XX_SDIV_MASK);\r\nfor (i = 0; i < ARRAY_SIZE(epll_div); i++) {\r\nif (epll_div[i][0] == rate) {\r\nepll_con_k |= (epll_div[i][1] << PLL90XX_KDIV_SHIFT);\r\nepll_con |= (epll_div[i][2] << PLL90XX_MDIV_SHIFT) |\r\n(epll_div[i][3] << PLL90XX_PDIV_SHIFT) |\r\n(epll_div[i][4] << PLL90XX_SDIV_SHIFT);\r\nbreak;\r\n}\r\n}\r\nif (i == ARRAY_SIZE(epll_div)) {\r\nprintk(KERN_ERR "%s: Invalid Clock EPLL Frequency\n", __func__);\r\nreturn -EINVAL;\r\n}\r\n__raw_writel(epll_con, S5P64X0_EPLL_CON);\r\n__raw_writel(epll_con_k, S5P64X0_EPLL_CON_K);\r\nprintk(KERN_WARNING "EPLL Rate changes from %lu to %lu\n",\r\nclk->rate, rate);\r\nclk->rate = rate;\r\nreturn 0;\r\n}\r\nvoid __init_or_cpufreq s5p6450_setup_clocks(void)\r\n{\r\nstruct clk *xtal_clk;\r\nunsigned long xtal;\r\nunsigned long fclk;\r\nunsigned long hclk;\r\nunsigned long hclk_low;\r\nunsigned long pclk;\r\nunsigned long pclk_low;\r\nunsigned long apll;\r\nunsigned long mpll;\r\nunsigned long epll;\r\nunsigned long dpll;\r\nunsigned int ptr;\r\nclk_fout_epll.enable = s5p_epll_enable;\r\nclk_fout_epll.ops = &s5p6450_epll_ops;\r\nclk_48m.enable = s5p64x0_clk48m_ctrl;\r\nxtal_clk = clk_get(NULL, "ext_xtal");\r\nBUG_ON(IS_ERR(xtal_clk));\r\nxtal = clk_get_rate(xtal_clk);\r\nclk_put(xtal_clk);\r\napll = s5p_get_pll45xx(xtal, __raw_readl(S5P64X0_APLL_CON), pll_4502);\r\nmpll = s5p_get_pll45xx(xtal, __raw_readl(S5P64X0_MPLL_CON), pll_4502);\r\nepll = s5p_get_pll90xx(xtal, __raw_readl(S5P64X0_EPLL_CON),\r\n__raw_readl(S5P64X0_EPLL_CON_K));\r\ndpll = s5p_get_pll46xx(xtal, __raw_readl(S5P6450_DPLL_CON),\r\n__raw_readl(S5P6450_DPLL_CON_K), pll_4650c);\r\nclk_fout_apll.rate = apll;\r\nclk_fout_mpll.rate = mpll;\r\nclk_fout_epll.rate = epll;\r\nclk_fout_dpll.rate = dpll;\r\nprintk(KERN_INFO "S5P6450: PLL settings, A=%ld.%ldMHz, M=%ld.%ldMHz," \\r\n" E=%ld.%ldMHz, D=%ld.%ldMHz\n",\r\nprint_mhz(apll), print_mhz(mpll), print_mhz(epll),\r\nprint_mhz(dpll));\r\nfclk = clk_get_rate(&clk_armclk.clk);\r\nhclk = clk_get_rate(&clk_hclk.clk);\r\npclk = clk_get_rate(&clk_pclk.clk);\r\nhclk_low = clk_get_rate(&clk_hclk_low.clk);\r\npclk_low = clk_get_rate(&clk_pclk_low.clk);\r\nprintk(KERN_INFO "S5P6450: HCLK=%ld.%ldMHz, HCLK_LOW=%ld.%ldMHz," \\r\n" PCLK=%ld.%ldMHz, PCLK_LOW=%ld.%ldMHz\n",\r\nprint_mhz(hclk), print_mhz(hclk_low),\r\nprint_mhz(pclk), print_mhz(pclk_low));\r\nclk_f.rate = fclk;\r\nclk_h.rate = hclk;\r\nclk_p.rate = pclk;\r\nfor (ptr = 0; ptr < ARRAY_SIZE(clksrcs); ptr++)\r\ns3c_set_clksrc(&clksrcs[ptr], true);\r\n}\r\nvoid __init s5p6450_register_clocks(void)\r\n{\r\nint ptr;\r\nunsigned int cnt;\r\nfor (ptr = 0; ptr < ARRAY_SIZE(sysclks); ptr++)\r\ns3c_register_clksrc(sysclks[ptr], 1);\r\ns3c24xx_register_clocks(clk_cdev, ARRAY_SIZE(clk_cdev));\r\nfor (cnt = 0; cnt < ARRAY_SIZE(clk_cdev); cnt++)\r\ns3c_disable_clocks(clk_cdev[cnt], 1);\r\ns3c_register_clksrc(clksrcs, ARRAY_SIZE(clksrcs));\r\ns3c_register_clocks(init_clocks, ARRAY_SIZE(init_clocks));\r\nfor (ptr = 0; ptr < ARRAY_SIZE(clksrc_cdev); ptr++)\r\ns3c_register_clksrc(clksrc_cdev[ptr], 1);\r\ns3c_register_clocks(init_clocks_off, ARRAY_SIZE(init_clocks_off));\r\ns3c_disable_clocks(init_clocks_off, ARRAY_SIZE(init_clocks_off));\r\nclkdev_add_table(s5p6450_clk_lookup, ARRAY_SIZE(s5p6450_clk_lookup));\r\ns3c24xx_register_clock(&dummy_apb_pclk);\r\ns3c_pwmclk_init();\r\n}

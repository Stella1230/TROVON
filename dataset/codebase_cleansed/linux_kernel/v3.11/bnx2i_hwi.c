static u32 bnx2i_get_cid_num(struct bnx2i_endpoint *ep)\r\n{\r\nu32 cid;\r\nif (test_bit(BNX2I_NX2_DEV_57710, &ep->hba->cnic_dev_type))\r\ncid = ep->ep_cid;\r\nelse\r\ncid = GET_CID_NUM(ep->ep_cid);\r\nreturn cid;\r\n}\r\nstatic void bnx2i_adjust_qp_size(struct bnx2i_hba *hba)\r\n{\r\nu32 num_elements_per_pg;\r\nif (test_bit(BNX2I_NX2_DEV_5706, &hba->cnic_dev_type) ||\r\ntest_bit(BNX2I_NX2_DEV_5708, &hba->cnic_dev_type) ||\r\ntest_bit(BNX2I_NX2_DEV_5709, &hba->cnic_dev_type)) {\r\nif (!is_power_of_2(hba->max_sqes))\r\nhba->max_sqes = rounddown_pow_of_two(hba->max_sqes);\r\nif (!is_power_of_2(hba->max_rqes))\r\nhba->max_rqes = rounddown_pow_of_two(hba->max_rqes);\r\n}\r\nnum_elements_per_pg = PAGE_SIZE / BNX2I_SQ_WQE_SIZE;\r\nif (hba->max_sqes < num_elements_per_pg)\r\nhba->max_sqes = num_elements_per_pg;\r\nelse if (hba->max_sqes % num_elements_per_pg)\r\nhba->max_sqes = (hba->max_sqes + num_elements_per_pg - 1) &\r\n~(num_elements_per_pg - 1);\r\nnum_elements_per_pg = PAGE_SIZE / BNX2I_CQE_SIZE;\r\nif (hba->max_cqes < num_elements_per_pg)\r\nhba->max_cqes = num_elements_per_pg;\r\nelse if (hba->max_cqes % num_elements_per_pg)\r\nhba->max_cqes = (hba->max_cqes + num_elements_per_pg - 1) &\r\n~(num_elements_per_pg - 1);\r\nnum_elements_per_pg = PAGE_SIZE / BNX2I_RQ_WQE_SIZE;\r\nif (hba->max_rqes < num_elements_per_pg)\r\nhba->max_rqes = num_elements_per_pg;\r\nelse if (hba->max_rqes % num_elements_per_pg)\r\nhba->max_rqes = (hba->max_rqes + num_elements_per_pg - 1) &\r\n~(num_elements_per_pg - 1);\r\n}\r\nstatic void bnx2i_get_link_state(struct bnx2i_hba *hba)\r\n{\r\nif (test_bit(__LINK_STATE_NOCARRIER, &hba->netdev->state))\r\nset_bit(ADAPTER_STATE_LINK_DOWN, &hba->adapter_state);\r\nelse\r\nclear_bit(ADAPTER_STATE_LINK_DOWN, &hba->adapter_state);\r\n}\r\nstatic void bnx2i_iscsi_license_error(struct bnx2i_hba *hba, u32 error_code)\r\n{\r\nif (error_code == ISCSI_KCQE_COMPLETION_STATUS_ISCSI_NOT_SUPPORTED)\r\nprintk(KERN_ERR "bnx2i: iSCSI not supported, dev=%s\n",\r\nhba->netdev->name);\r\nif (error_code == ISCSI_KCQE_COMPLETION_STATUS_LOM_ISCSI_NOT_ENABLED)\r\nprintk(KERN_ERR "bnx2i: LOM is not enable to "\r\n"offload iSCSI connections, dev=%s\n",\r\nhba->netdev->name);\r\nset_bit(ADAPTER_STATE_INIT_FAILED, &hba->adapter_state);\r\n}\r\nint bnx2i_arm_cq_event_coalescing(struct bnx2i_endpoint *ep, u8 action)\r\n{\r\nstruct bnx2i_5771x_cq_db *cq_db;\r\nu16 cq_index;\r\nu16 next_index = 0;\r\nu32 num_active_cmds;\r\nif (!test_bit(BNX2I_NX2_DEV_57710, &ep->hba->cnic_dev_type))\r\nreturn 0;\r\ncq_db = (struct bnx2i_5771x_cq_db *) ep->qp.cq_pgtbl_virt;\r\nif (action != CNIC_ARM_CQE_FP)\r\nif (cq_db->sqn[0] && cq_db->sqn[0] != 0xFFFF)\r\nreturn 0;\r\nif (action == CNIC_ARM_CQE || action == CNIC_ARM_CQE_FP) {\r\nnum_active_cmds = atomic_read(&ep->num_active_cmds);\r\nif (num_active_cmds <= event_coal_min)\r\nnext_index = 1;\r\nelse {\r\nnext_index = num_active_cmds >> ep->ec_shift;\r\nif (next_index > num_active_cmds - event_coal_min)\r\nnext_index = num_active_cmds - event_coal_min;\r\n}\r\nif (!next_index)\r\nnext_index = 1;\r\ncq_index = ep->qp.cqe_exp_seq_sn + next_index - 1;\r\nif (cq_index > ep->qp.cqe_size * 2)\r\ncq_index -= ep->qp.cqe_size * 2;\r\nif (!cq_index)\r\ncq_index = 1;\r\ncq_db->sqn[0] = cq_index;\r\n}\r\nreturn next_index;\r\n}\r\nvoid bnx2i_get_rq_buf(struct bnx2i_conn *bnx2i_conn, char *ptr, int len)\r\n{\r\nif (!bnx2i_conn->ep->qp.rqe_left)\r\nreturn;\r\nbnx2i_conn->ep->qp.rqe_left--;\r\nmemcpy(ptr, (u8 *) bnx2i_conn->ep->qp.rq_cons_qe, len);\r\nif (bnx2i_conn->ep->qp.rq_cons_qe == bnx2i_conn->ep->qp.rq_last_qe) {\r\nbnx2i_conn->ep->qp.rq_cons_qe = bnx2i_conn->ep->qp.rq_first_qe;\r\nbnx2i_conn->ep->qp.rq_cons_idx = 0;\r\n} else {\r\nbnx2i_conn->ep->qp.rq_cons_qe++;\r\nbnx2i_conn->ep->qp.rq_cons_idx++;\r\n}\r\n}\r\nstatic void bnx2i_ring_577xx_doorbell(struct bnx2i_conn *conn)\r\n{\r\nstruct bnx2i_5771x_dbell dbell;\r\nu32 msg;\r\nmemset(&dbell, 0, sizeof(dbell));\r\ndbell.dbell.header = (B577XX_ISCSI_CONNECTION_TYPE <<\r\nB577XX_DOORBELL_HDR_CONN_TYPE_SHIFT);\r\nmsg = *((u32 *)&dbell);\r\nwritel(cpu_to_le32(msg), conn->ep->qp.ctx_base);\r\n}\r\nvoid bnx2i_put_rq_buf(struct bnx2i_conn *bnx2i_conn, int count)\r\n{\r\nstruct bnx2i_5771x_sq_rq_db *rq_db;\r\nu16 hi_bit = (bnx2i_conn->ep->qp.rq_prod_idx & 0x8000);\r\nstruct bnx2i_endpoint *ep = bnx2i_conn->ep;\r\nep->qp.rqe_left += count;\r\nep->qp.rq_prod_idx &= 0x7FFF;\r\nep->qp.rq_prod_idx += count;\r\nif (ep->qp.rq_prod_idx > bnx2i_conn->hba->max_rqes) {\r\nep->qp.rq_prod_idx %= bnx2i_conn->hba->max_rqes;\r\nif (!hi_bit)\r\nep->qp.rq_prod_idx |= 0x8000;\r\n} else\r\nep->qp.rq_prod_idx |= hi_bit;\r\nif (test_bit(BNX2I_NX2_DEV_57710, &ep->hba->cnic_dev_type)) {\r\nrq_db = (struct bnx2i_5771x_sq_rq_db *) ep->qp.rq_pgtbl_virt;\r\nrq_db->prod_idx = ep->qp.rq_prod_idx;\r\n} else {\r\nwritew(ep->qp.rq_prod_idx,\r\nep->qp.ctx_base + CNIC_RECV_DOORBELL);\r\n}\r\nmmiowb();\r\n}\r\nstatic void bnx2i_ring_sq_dbell(struct bnx2i_conn *bnx2i_conn, int count)\r\n{\r\nstruct bnx2i_5771x_sq_rq_db *sq_db;\r\nstruct bnx2i_endpoint *ep = bnx2i_conn->ep;\r\natomic_inc(&ep->num_active_cmds);\r\nwmb();\r\nif (test_bit(BNX2I_NX2_DEV_57710, &ep->hba->cnic_dev_type)) {\r\nsq_db = (struct bnx2i_5771x_sq_rq_db *) ep->qp.sq_pgtbl_virt;\r\nsq_db->prod_idx = ep->qp.sq_prod_idx;\r\nbnx2i_ring_577xx_doorbell(bnx2i_conn);\r\n} else\r\nwritew(count, ep->qp.ctx_base + CNIC_SEND_DOORBELL);\r\nmmiowb();\r\n}\r\nstatic void bnx2i_ring_dbell_update_sq_params(struct bnx2i_conn *bnx2i_conn,\r\nint count)\r\n{\r\nint tmp_cnt;\r\nif (count == 1) {\r\nif (bnx2i_conn->ep->qp.sq_prod_qe ==\r\nbnx2i_conn->ep->qp.sq_last_qe)\r\nbnx2i_conn->ep->qp.sq_prod_qe =\r\nbnx2i_conn->ep->qp.sq_first_qe;\r\nelse\r\nbnx2i_conn->ep->qp.sq_prod_qe++;\r\n} else {\r\nif ((bnx2i_conn->ep->qp.sq_prod_qe + count) <=\r\nbnx2i_conn->ep->qp.sq_last_qe)\r\nbnx2i_conn->ep->qp.sq_prod_qe += count;\r\nelse {\r\ntmp_cnt = bnx2i_conn->ep->qp.sq_last_qe -\r\nbnx2i_conn->ep->qp.sq_prod_qe;\r\nbnx2i_conn->ep->qp.sq_prod_qe =\r\n&bnx2i_conn->ep->qp.sq_first_qe[count -\r\n(tmp_cnt + 1)];\r\n}\r\n}\r\nbnx2i_conn->ep->qp.sq_prod_idx += count;\r\nbnx2i_ring_sq_dbell(bnx2i_conn, bnx2i_conn->ep->qp.sq_prod_idx);\r\n}\r\nint bnx2i_send_iscsi_login(struct bnx2i_conn *bnx2i_conn,\r\nstruct iscsi_task *task)\r\n{\r\nstruct bnx2i_cmd *bnx2i_cmd;\r\nstruct bnx2i_login_request *login_wqe;\r\nstruct iscsi_login_req *login_hdr;\r\nu32 dword;\r\nbnx2i_cmd = (struct bnx2i_cmd *)task->dd_data;\r\nlogin_hdr = (struct iscsi_login_req *)task->hdr;\r\nlogin_wqe = (struct bnx2i_login_request *)\r\nbnx2i_conn->ep->qp.sq_prod_qe;\r\nlogin_wqe->op_code = login_hdr->opcode;\r\nlogin_wqe->op_attr = login_hdr->flags;\r\nlogin_wqe->version_max = login_hdr->max_version;\r\nlogin_wqe->version_min = login_hdr->min_version;\r\nlogin_wqe->data_length = ntoh24(login_hdr->dlength);\r\nlogin_wqe->isid_lo = *((u32 *) login_hdr->isid);\r\nlogin_wqe->isid_hi = *((u16 *) login_hdr->isid + 2);\r\nlogin_wqe->tsih = login_hdr->tsih;\r\nlogin_wqe->itt = task->itt |\r\n(ISCSI_TASK_TYPE_MPATH << ISCSI_LOGIN_REQUEST_TYPE_SHIFT);\r\nlogin_wqe->cid = login_hdr->cid;\r\nlogin_wqe->cmd_sn = be32_to_cpu(login_hdr->cmdsn);\r\nlogin_wqe->exp_stat_sn = be32_to_cpu(login_hdr->exp_statsn);\r\nlogin_wqe->flags = ISCSI_LOGIN_REQUEST_UPDATE_EXP_STAT_SN;\r\nlogin_wqe->resp_bd_list_addr_lo = (u32) bnx2i_conn->gen_pdu.resp_bd_dma;\r\nlogin_wqe->resp_bd_list_addr_hi =\r\n(u32) ((u64) bnx2i_conn->gen_pdu.resp_bd_dma >> 32);\r\ndword = ((1 << ISCSI_LOGIN_REQUEST_NUM_RESP_BDS_SHIFT) |\r\n(bnx2i_conn->gen_pdu.resp_buf_size <<\r\nISCSI_LOGIN_REQUEST_RESP_BUFFER_LENGTH_SHIFT));\r\nlogin_wqe->resp_buffer = dword;\r\nlogin_wqe->bd_list_addr_lo = (u32) bnx2i_conn->gen_pdu.req_bd_dma;\r\nlogin_wqe->bd_list_addr_hi =\r\n(u32) ((u64) bnx2i_conn->gen_pdu.req_bd_dma >> 32);\r\nlogin_wqe->num_bds = 1;\r\nlogin_wqe->cq_index = 0;\r\nbnx2i_ring_dbell_update_sq_params(bnx2i_conn, 1);\r\nreturn 0;\r\n}\r\nint bnx2i_send_iscsi_tmf(struct bnx2i_conn *bnx2i_conn,\r\nstruct iscsi_task *mtask)\r\n{\r\nstruct iscsi_conn *conn = bnx2i_conn->cls_conn->dd_data;\r\nstruct iscsi_tm *tmfabort_hdr;\r\nstruct scsi_cmnd *ref_sc;\r\nstruct iscsi_task *ctask;\r\nstruct bnx2i_cmd *bnx2i_cmd;\r\nstruct bnx2i_tmf_request *tmfabort_wqe;\r\nu32 dword;\r\nu32 scsi_lun[2];\r\nbnx2i_cmd = (struct bnx2i_cmd *)mtask->dd_data;\r\ntmfabort_hdr = (struct iscsi_tm *)mtask->hdr;\r\ntmfabort_wqe = (struct bnx2i_tmf_request *)\r\nbnx2i_conn->ep->qp.sq_prod_qe;\r\ntmfabort_wqe->op_code = tmfabort_hdr->opcode;\r\ntmfabort_wqe->op_attr = tmfabort_hdr->flags;\r\ntmfabort_wqe->itt = (mtask->itt | (ISCSI_TASK_TYPE_MPATH << 14));\r\ntmfabort_wqe->reserved2 = 0;\r\ntmfabort_wqe->cmd_sn = be32_to_cpu(tmfabort_hdr->cmdsn);\r\nswitch (tmfabort_hdr->flags & ISCSI_FLAG_TM_FUNC_MASK) {\r\ncase ISCSI_TM_FUNC_ABORT_TASK:\r\ncase ISCSI_TM_FUNC_TASK_REASSIGN:\r\nctask = iscsi_itt_to_task(conn, tmfabort_hdr->rtt);\r\nif (!ctask || !ctask->sc)\r\nreturn 0;\r\nref_sc = ctask->sc;\r\nif (ref_sc->sc_data_direction == DMA_TO_DEVICE)\r\ndword = (ISCSI_TASK_TYPE_WRITE <<\r\nISCSI_CMD_REQUEST_TYPE_SHIFT);\r\nelse\r\ndword = (ISCSI_TASK_TYPE_READ <<\r\nISCSI_CMD_REQUEST_TYPE_SHIFT);\r\ntmfabort_wqe->ref_itt = (dword |\r\n(tmfabort_hdr->rtt & ISCSI_ITT_MASK));\r\nbreak;\r\ndefault:\r\ntmfabort_wqe->ref_itt = RESERVED_ITT;\r\n}\r\nmemcpy(scsi_lun, &tmfabort_hdr->lun, sizeof(struct scsi_lun));\r\ntmfabort_wqe->lun[0] = be32_to_cpu(scsi_lun[0]);\r\ntmfabort_wqe->lun[1] = be32_to_cpu(scsi_lun[1]);\r\ntmfabort_wqe->ref_cmd_sn = be32_to_cpu(tmfabort_hdr->refcmdsn);\r\ntmfabort_wqe->bd_list_addr_lo = (u32) bnx2i_conn->hba->mp_bd_dma;\r\ntmfabort_wqe->bd_list_addr_hi = (u32)\r\n((u64) bnx2i_conn->hba->mp_bd_dma >> 32);\r\ntmfabort_wqe->num_bds = 1;\r\ntmfabort_wqe->cq_index = 0;\r\nbnx2i_ring_dbell_update_sq_params(bnx2i_conn, 1);\r\nreturn 0;\r\n}\r\nint bnx2i_send_iscsi_text(struct bnx2i_conn *bnx2i_conn,\r\nstruct iscsi_task *mtask)\r\n{\r\nstruct bnx2i_cmd *bnx2i_cmd;\r\nstruct bnx2i_text_request *text_wqe;\r\nstruct iscsi_text *text_hdr;\r\nu32 dword;\r\nbnx2i_cmd = (struct bnx2i_cmd *)mtask->dd_data;\r\ntext_hdr = (struct iscsi_text *)mtask->hdr;\r\ntext_wqe = (struct bnx2i_text_request *) bnx2i_conn->ep->qp.sq_prod_qe;\r\nmemset(text_wqe, 0, sizeof(struct bnx2i_text_request));\r\ntext_wqe->op_code = text_hdr->opcode;\r\ntext_wqe->op_attr = text_hdr->flags;\r\ntext_wqe->data_length = ntoh24(text_hdr->dlength);\r\ntext_wqe->itt = mtask->itt |\r\n(ISCSI_TASK_TYPE_MPATH << ISCSI_TEXT_REQUEST_TYPE_SHIFT);\r\ntext_wqe->ttt = be32_to_cpu(text_hdr->ttt);\r\ntext_wqe->cmd_sn = be32_to_cpu(text_hdr->cmdsn);\r\ntext_wqe->resp_bd_list_addr_lo = (u32) bnx2i_conn->gen_pdu.resp_bd_dma;\r\ntext_wqe->resp_bd_list_addr_hi =\r\n(u32) ((u64) bnx2i_conn->gen_pdu.resp_bd_dma >> 32);\r\ndword = ((1 << ISCSI_TEXT_REQUEST_NUM_RESP_BDS_SHIFT) |\r\n(bnx2i_conn->gen_pdu.resp_buf_size <<\r\nISCSI_TEXT_REQUEST_RESP_BUFFER_LENGTH_SHIFT));\r\ntext_wqe->resp_buffer = dword;\r\ntext_wqe->bd_list_addr_lo = (u32) bnx2i_conn->gen_pdu.req_bd_dma;\r\ntext_wqe->bd_list_addr_hi =\r\n(u32) ((u64) bnx2i_conn->gen_pdu.req_bd_dma >> 32);\r\ntext_wqe->num_bds = 1;\r\ntext_wqe->cq_index = 0;\r\nbnx2i_ring_dbell_update_sq_params(bnx2i_conn, 1);\r\nreturn 0;\r\n}\r\nint bnx2i_send_iscsi_scsicmd(struct bnx2i_conn *bnx2i_conn,\r\nstruct bnx2i_cmd *cmd)\r\n{\r\nstruct bnx2i_cmd_request *scsi_cmd_wqe;\r\nscsi_cmd_wqe = (struct bnx2i_cmd_request *)\r\nbnx2i_conn->ep->qp.sq_prod_qe;\r\nmemcpy(scsi_cmd_wqe, &cmd->req, sizeof(struct bnx2i_cmd_request));\r\nscsi_cmd_wqe->cq_index = 0;\r\nbnx2i_ring_dbell_update_sq_params(bnx2i_conn, 1);\r\nreturn 0;\r\n}\r\nint bnx2i_send_iscsi_nopout(struct bnx2i_conn *bnx2i_conn,\r\nstruct iscsi_task *task,\r\nchar *datap, int data_len, int unsol)\r\n{\r\nstruct bnx2i_endpoint *ep = bnx2i_conn->ep;\r\nstruct bnx2i_cmd *bnx2i_cmd;\r\nstruct bnx2i_nop_out_request *nopout_wqe;\r\nstruct iscsi_nopout *nopout_hdr;\r\nbnx2i_cmd = (struct bnx2i_cmd *)task->dd_data;\r\nnopout_hdr = (struct iscsi_nopout *)task->hdr;\r\nnopout_wqe = (struct bnx2i_nop_out_request *)ep->qp.sq_prod_qe;\r\nmemset(nopout_wqe, 0x00, sizeof(struct bnx2i_nop_out_request));\r\nnopout_wqe->op_code = nopout_hdr->opcode;\r\nnopout_wqe->op_attr = ISCSI_FLAG_CMD_FINAL;\r\nmemcpy(nopout_wqe->lun, &nopout_hdr->lun, 8);\r\nif (test_bit(BNX2I_NX2_DEV_57710, &ep->hba->cnic_dev_type)) {\r\nu32 tmp = nopout_wqe->lun[0];\r\nnopout_wqe->lun[0] = nopout_wqe->lun[1];\r\nnopout_wqe->lun[1] = tmp;\r\n}\r\nnopout_wqe->itt = ((u16)task->itt |\r\n(ISCSI_TASK_TYPE_MPATH <<\r\nISCSI_TMF_REQUEST_TYPE_SHIFT));\r\nnopout_wqe->ttt = be32_to_cpu(nopout_hdr->ttt);\r\nnopout_wqe->flags = 0;\r\nif (!unsol)\r\nnopout_wqe->flags = ISCSI_NOP_OUT_REQUEST_LOCAL_COMPLETION;\r\nelse if (nopout_hdr->itt == RESERVED_ITT)\r\nnopout_wqe->flags = ISCSI_NOP_OUT_REQUEST_LOCAL_COMPLETION;\r\nnopout_wqe->cmd_sn = be32_to_cpu(nopout_hdr->cmdsn);\r\nnopout_wqe->data_length = data_len;\r\nif (data_len) {\r\nprintk(KERN_ALERT "NOPOUT: WARNING!! payload len != 0\n");\r\n} else {\r\nnopout_wqe->bd_list_addr_lo = (u32)\r\nbnx2i_conn->hba->mp_bd_dma;\r\nnopout_wqe->bd_list_addr_hi =\r\n(u32) ((u64) bnx2i_conn->hba->mp_bd_dma >> 32);\r\nnopout_wqe->num_bds = 1;\r\n}\r\nnopout_wqe->cq_index = 0;\r\nbnx2i_ring_dbell_update_sq_params(bnx2i_conn, 1);\r\nreturn 0;\r\n}\r\nint bnx2i_send_iscsi_logout(struct bnx2i_conn *bnx2i_conn,\r\nstruct iscsi_task *task)\r\n{\r\nstruct bnx2i_cmd *bnx2i_cmd;\r\nstruct bnx2i_logout_request *logout_wqe;\r\nstruct iscsi_logout *logout_hdr;\r\nbnx2i_cmd = (struct bnx2i_cmd *)task->dd_data;\r\nlogout_hdr = (struct iscsi_logout *)task->hdr;\r\nlogout_wqe = (struct bnx2i_logout_request *)\r\nbnx2i_conn->ep->qp.sq_prod_qe;\r\nmemset(logout_wqe, 0x00, sizeof(struct bnx2i_logout_request));\r\nlogout_wqe->op_code = logout_hdr->opcode;\r\nlogout_wqe->cmd_sn = be32_to_cpu(logout_hdr->cmdsn);\r\nlogout_wqe->op_attr =\r\nlogout_hdr->flags | ISCSI_LOGOUT_REQUEST_ALWAYS_ONE;\r\nlogout_wqe->itt = ((u16)task->itt |\r\n(ISCSI_TASK_TYPE_MPATH <<\r\nISCSI_LOGOUT_REQUEST_TYPE_SHIFT));\r\nlogout_wqe->data_length = 0;\r\nlogout_wqe->cid = 0;\r\nlogout_wqe->bd_list_addr_lo = (u32) bnx2i_conn->hba->mp_bd_dma;\r\nlogout_wqe->bd_list_addr_hi = (u32)\r\n((u64) bnx2i_conn->hba->mp_bd_dma >> 32);\r\nlogout_wqe->num_bds = 1;\r\nlogout_wqe->cq_index = 0;\r\nbnx2i_conn->ep->state = EP_STATE_LOGOUT_SENT;\r\nbnx2i_ring_dbell_update_sq_params(bnx2i_conn, 1);\r\nreturn 0;\r\n}\r\nvoid bnx2i_update_iscsi_conn(struct iscsi_conn *conn)\r\n{\r\nstruct bnx2i_conn *bnx2i_conn = conn->dd_data;\r\nstruct bnx2i_hba *hba = bnx2i_conn->hba;\r\nstruct kwqe *kwqe_arr[2];\r\nstruct iscsi_kwqe_conn_update *update_wqe;\r\nstruct iscsi_kwqe_conn_update conn_update_kwqe;\r\nupdate_wqe = &conn_update_kwqe;\r\nupdate_wqe->hdr.op_code = ISCSI_KWQE_OPCODE_UPDATE_CONN;\r\nupdate_wqe->hdr.flags =\r\n(ISCSI_KWQE_LAYER_CODE << ISCSI_KWQE_HEADER_LAYER_CODE_SHIFT);\r\nif (test_bit(BNX2I_NX2_DEV_57710, &bnx2i_conn->ep->hba->cnic_dev_type))\r\nupdate_wqe->context_id = bnx2i_conn->ep->ep_cid;\r\nelse\r\nupdate_wqe->context_id = (bnx2i_conn->ep->ep_cid >> 7);\r\nupdate_wqe->conn_flags = 0;\r\nif (conn->hdrdgst_en)\r\nupdate_wqe->conn_flags |= ISCSI_KWQE_CONN_UPDATE_HEADER_DIGEST;\r\nif (conn->datadgst_en)\r\nupdate_wqe->conn_flags |= ISCSI_KWQE_CONN_UPDATE_DATA_DIGEST;\r\nif (conn->session->initial_r2t_en)\r\nupdate_wqe->conn_flags |= ISCSI_KWQE_CONN_UPDATE_INITIAL_R2T;\r\nif (conn->session->imm_data_en)\r\nupdate_wqe->conn_flags |= ISCSI_KWQE_CONN_UPDATE_IMMEDIATE_DATA;\r\nupdate_wqe->max_send_pdu_length = conn->max_xmit_dlength;\r\nupdate_wqe->max_recv_pdu_length = conn->max_recv_dlength;\r\nupdate_wqe->first_burst_length = conn->session->first_burst;\r\nupdate_wqe->max_burst_length = conn->session->max_burst;\r\nupdate_wqe->exp_stat_sn = conn->exp_statsn;\r\nupdate_wqe->max_outstanding_r2ts = conn->session->max_r2t;\r\nupdate_wqe->session_error_recovery_level = conn->session->erl;\r\niscsi_conn_printk(KERN_ALERT, conn,\r\n"bnx2i: conn update - MBL 0x%x FBL 0x%x"\r\n"MRDSL_I 0x%x MRDSL_T 0x%x \n",\r\nupdate_wqe->max_burst_length,\r\nupdate_wqe->first_burst_length,\r\nupdate_wqe->max_recv_pdu_length,\r\nupdate_wqe->max_send_pdu_length);\r\nkwqe_arr[0] = (struct kwqe *) update_wqe;\r\nif (hba->cnic && hba->cnic->submit_kwqes)\r\nhba->cnic->submit_kwqes(hba->cnic, kwqe_arr, 1);\r\n}\r\nvoid bnx2i_ep_ofld_timer(unsigned long data)\r\n{\r\nstruct bnx2i_endpoint *ep = (struct bnx2i_endpoint *) data;\r\nif (ep->state == EP_STATE_OFLD_START) {\r\nprintk(KERN_ALERT "ofld_timer: CONN_OFLD timeout\n");\r\nep->state = EP_STATE_OFLD_FAILED;\r\n} else if (ep->state == EP_STATE_DISCONN_START) {\r\nprintk(KERN_ALERT "ofld_timer: CONN_DISCON timeout\n");\r\nep->state = EP_STATE_DISCONN_TIMEDOUT;\r\n} else if (ep->state == EP_STATE_CLEANUP_START) {\r\nprintk(KERN_ALERT "ofld_timer: CONN_CLEANUP timeout\n");\r\nep->state = EP_STATE_CLEANUP_FAILED;\r\n}\r\nwake_up_interruptible(&ep->ofld_wait);\r\n}\r\nstatic int bnx2i_power_of2(u32 val)\r\n{\r\nu32 power = 0;\r\nif (val & (val - 1))\r\nreturn power;\r\nval--;\r\nwhile (val) {\r\nval = val >> 1;\r\npower++;\r\n}\r\nreturn power;\r\n}\r\nvoid bnx2i_send_cmd_cleanup_req(struct bnx2i_hba *hba, struct bnx2i_cmd *cmd)\r\n{\r\nstruct bnx2i_cleanup_request *cmd_cleanup;\r\ncmd_cleanup =\r\n(struct bnx2i_cleanup_request *)cmd->conn->ep->qp.sq_prod_qe;\r\nmemset(cmd_cleanup, 0x00, sizeof(struct bnx2i_cleanup_request));\r\ncmd_cleanup->op_code = ISCSI_OPCODE_CLEANUP_REQUEST;\r\ncmd_cleanup->itt = cmd->req.itt;\r\ncmd_cleanup->cq_index = 0;\r\nbnx2i_ring_dbell_update_sq_params(cmd->conn, 1);\r\n}\r\nint bnx2i_send_conn_destroy(struct bnx2i_hba *hba, struct bnx2i_endpoint *ep)\r\n{\r\nstruct kwqe *kwqe_arr[2];\r\nstruct iscsi_kwqe_conn_destroy conn_cleanup;\r\nint rc = -EINVAL;\r\nmemset(&conn_cleanup, 0x00, sizeof(struct iscsi_kwqe_conn_destroy));\r\nconn_cleanup.hdr.op_code = ISCSI_KWQE_OPCODE_DESTROY_CONN;\r\nconn_cleanup.hdr.flags =\r\n(ISCSI_KWQE_LAYER_CODE << ISCSI_KWQE_HEADER_LAYER_CODE_SHIFT);\r\nif (test_bit(BNX2I_NX2_DEV_57710, &ep->hba->cnic_dev_type))\r\nconn_cleanup.context_id = ep->ep_cid;\r\nelse\r\nconn_cleanup.context_id = (ep->ep_cid >> 7);\r\nconn_cleanup.reserved0 = (u16)ep->ep_iscsi_cid;\r\nkwqe_arr[0] = (struct kwqe *) &conn_cleanup;\r\nif (hba->cnic && hba->cnic->submit_kwqes)\r\nrc = hba->cnic->submit_kwqes(hba->cnic, kwqe_arr, 1);\r\nreturn rc;\r\n}\r\nstatic int bnx2i_570x_send_conn_ofld_req(struct bnx2i_hba *hba,\r\nstruct bnx2i_endpoint *ep)\r\n{\r\nstruct kwqe *kwqe_arr[2];\r\nstruct iscsi_kwqe_conn_offload1 ofld_req1;\r\nstruct iscsi_kwqe_conn_offload2 ofld_req2;\r\ndma_addr_t dma_addr;\r\nint num_kwqes = 2;\r\nu32 *ptbl;\r\nint rc = -EINVAL;\r\nofld_req1.hdr.op_code = ISCSI_KWQE_OPCODE_OFFLOAD_CONN1;\r\nofld_req1.hdr.flags =\r\n(ISCSI_KWQE_LAYER_CODE << ISCSI_KWQE_HEADER_LAYER_CODE_SHIFT);\r\nofld_req1.iscsi_conn_id = (u16) ep->ep_iscsi_cid;\r\ndma_addr = ep->qp.sq_pgtbl_phys;\r\nofld_req1.sq_page_table_addr_lo = (u32) dma_addr;\r\nofld_req1.sq_page_table_addr_hi = (u32) ((u64) dma_addr >> 32);\r\ndma_addr = ep->qp.cq_pgtbl_phys;\r\nofld_req1.cq_page_table_addr_lo = (u32) dma_addr;\r\nofld_req1.cq_page_table_addr_hi = (u32) ((u64) dma_addr >> 32);\r\nofld_req2.hdr.op_code = ISCSI_KWQE_OPCODE_OFFLOAD_CONN2;\r\nofld_req2.hdr.flags =\r\n(ISCSI_KWQE_LAYER_CODE << ISCSI_KWQE_HEADER_LAYER_CODE_SHIFT);\r\ndma_addr = ep->qp.rq_pgtbl_phys;\r\nofld_req2.rq_page_table_addr_lo = (u32) dma_addr;\r\nofld_req2.rq_page_table_addr_hi = (u32) ((u64) dma_addr >> 32);\r\nptbl = (u32 *) ep->qp.sq_pgtbl_virt;\r\nofld_req2.sq_first_pte.hi = *ptbl++;\r\nofld_req2.sq_first_pte.lo = *ptbl;\r\nptbl = (u32 *) ep->qp.cq_pgtbl_virt;\r\nofld_req2.cq_first_pte.hi = *ptbl++;\r\nofld_req2.cq_first_pte.lo = *ptbl;\r\nkwqe_arr[0] = (struct kwqe *) &ofld_req1;\r\nkwqe_arr[1] = (struct kwqe *) &ofld_req2;\r\nofld_req2.num_additional_wqes = 0;\r\nif (hba->cnic && hba->cnic->submit_kwqes)\r\nrc = hba->cnic->submit_kwqes(hba->cnic, kwqe_arr, num_kwqes);\r\nreturn rc;\r\n}\r\nstatic int bnx2i_5771x_send_conn_ofld_req(struct bnx2i_hba *hba,\r\nstruct bnx2i_endpoint *ep)\r\n{\r\nstruct kwqe *kwqe_arr[5];\r\nstruct iscsi_kwqe_conn_offload1 ofld_req1;\r\nstruct iscsi_kwqe_conn_offload2 ofld_req2;\r\nstruct iscsi_kwqe_conn_offload3 ofld_req3[1];\r\ndma_addr_t dma_addr;\r\nint num_kwqes = 2;\r\nu32 *ptbl;\r\nint rc = -EINVAL;\r\nofld_req1.hdr.op_code = ISCSI_KWQE_OPCODE_OFFLOAD_CONN1;\r\nofld_req1.hdr.flags =\r\n(ISCSI_KWQE_LAYER_CODE << ISCSI_KWQE_HEADER_LAYER_CODE_SHIFT);\r\nofld_req1.iscsi_conn_id = (u16) ep->ep_iscsi_cid;\r\ndma_addr = ep->qp.sq_pgtbl_phys + ISCSI_SQ_DB_SIZE;\r\nofld_req1.sq_page_table_addr_lo = (u32) dma_addr;\r\nofld_req1.sq_page_table_addr_hi = (u32) ((u64) dma_addr >> 32);\r\ndma_addr = ep->qp.cq_pgtbl_phys + ISCSI_CQ_DB_SIZE;\r\nofld_req1.cq_page_table_addr_lo = (u32) dma_addr;\r\nofld_req1.cq_page_table_addr_hi = (u32) ((u64) dma_addr >> 32);\r\nofld_req2.hdr.op_code = ISCSI_KWQE_OPCODE_OFFLOAD_CONN2;\r\nofld_req2.hdr.flags =\r\n(ISCSI_KWQE_LAYER_CODE << ISCSI_KWQE_HEADER_LAYER_CODE_SHIFT);\r\ndma_addr = ep->qp.rq_pgtbl_phys + ISCSI_RQ_DB_SIZE;\r\nofld_req2.rq_page_table_addr_lo = (u32) dma_addr;\r\nofld_req2.rq_page_table_addr_hi = (u32) ((u64) dma_addr >> 32);\r\nptbl = (u32 *)((u8 *)ep->qp.sq_pgtbl_virt + ISCSI_SQ_DB_SIZE);\r\nofld_req2.sq_first_pte.hi = *ptbl++;\r\nofld_req2.sq_first_pte.lo = *ptbl;\r\nptbl = (u32 *)((u8 *)ep->qp.cq_pgtbl_virt + ISCSI_CQ_DB_SIZE);\r\nofld_req2.cq_first_pte.hi = *ptbl++;\r\nofld_req2.cq_first_pte.lo = *ptbl;\r\nkwqe_arr[0] = (struct kwqe *) &ofld_req1;\r\nkwqe_arr[1] = (struct kwqe *) &ofld_req2;\r\nofld_req2.num_additional_wqes = 1;\r\nmemset(ofld_req3, 0x00, sizeof(ofld_req3[0]));\r\nptbl = (u32 *)((u8 *)ep->qp.rq_pgtbl_virt + ISCSI_RQ_DB_SIZE);\r\nofld_req3[0].qp_first_pte[0].hi = *ptbl++;\r\nofld_req3[0].qp_first_pte[0].lo = *ptbl;\r\nkwqe_arr[2] = (struct kwqe *) ofld_req3;\r\nnum_kwqes += 1;\r\nif (hba->cnic && hba->cnic->submit_kwqes)\r\nrc = hba->cnic->submit_kwqes(hba->cnic, kwqe_arr, num_kwqes);\r\nreturn rc;\r\n}\r\nint bnx2i_send_conn_ofld_req(struct bnx2i_hba *hba, struct bnx2i_endpoint *ep)\r\n{\r\nint rc;\r\nif (test_bit(BNX2I_NX2_DEV_57710, &hba->cnic_dev_type))\r\nrc = bnx2i_5771x_send_conn_ofld_req(hba, ep);\r\nelse\r\nrc = bnx2i_570x_send_conn_ofld_req(hba, ep);\r\nreturn rc;\r\n}\r\nstatic void setup_qp_page_tables(struct bnx2i_endpoint *ep)\r\n{\r\nint num_pages;\r\nu32 *ptbl;\r\ndma_addr_t page;\r\nint cnic_dev_10g;\r\nif (test_bit(BNX2I_NX2_DEV_57710, &ep->hba->cnic_dev_type))\r\ncnic_dev_10g = 1;\r\nelse\r\ncnic_dev_10g = 0;\r\nmemset(ep->qp.sq_pgtbl_virt, 0, ep->qp.sq_pgtbl_size);\r\nnum_pages = ep->qp.sq_mem_size / PAGE_SIZE;\r\npage = ep->qp.sq_phys;\r\nif (cnic_dev_10g)\r\nptbl = (u32 *)((u8 *)ep->qp.sq_pgtbl_virt + ISCSI_SQ_DB_SIZE);\r\nelse\r\nptbl = (u32 *) ep->qp.sq_pgtbl_virt;\r\nwhile (num_pages--) {\r\nif (cnic_dev_10g) {\r\n*ptbl = (u32) page;\r\nptbl++;\r\n*ptbl = (u32) ((u64) page >> 32);\r\nptbl++;\r\npage += PAGE_SIZE;\r\n} else {\r\n*ptbl = (u32) ((u64) page >> 32);\r\nptbl++;\r\n*ptbl = (u32) page;\r\nptbl++;\r\npage += PAGE_SIZE;\r\n}\r\n}\r\nmemset(ep->qp.rq_pgtbl_virt, 0, ep->qp.rq_pgtbl_size);\r\nnum_pages = ep->qp.rq_mem_size / PAGE_SIZE;\r\npage = ep->qp.rq_phys;\r\nif (cnic_dev_10g)\r\nptbl = (u32 *)((u8 *)ep->qp.rq_pgtbl_virt + ISCSI_RQ_DB_SIZE);\r\nelse\r\nptbl = (u32 *) ep->qp.rq_pgtbl_virt;\r\nwhile (num_pages--) {\r\nif (cnic_dev_10g) {\r\n*ptbl = (u32) page;\r\nptbl++;\r\n*ptbl = (u32) ((u64) page >> 32);\r\nptbl++;\r\npage += PAGE_SIZE;\r\n} else {\r\n*ptbl = (u32) ((u64) page >> 32);\r\nptbl++;\r\n*ptbl = (u32) page;\r\nptbl++;\r\npage += PAGE_SIZE;\r\n}\r\n}\r\nmemset(ep->qp.cq_pgtbl_virt, 0, ep->qp.cq_pgtbl_size);\r\nnum_pages = ep->qp.cq_mem_size / PAGE_SIZE;\r\npage = ep->qp.cq_phys;\r\nif (cnic_dev_10g)\r\nptbl = (u32 *)((u8 *)ep->qp.cq_pgtbl_virt + ISCSI_CQ_DB_SIZE);\r\nelse\r\nptbl = (u32 *) ep->qp.cq_pgtbl_virt;\r\nwhile (num_pages--) {\r\nif (cnic_dev_10g) {\r\n*ptbl = (u32) page;\r\nptbl++;\r\n*ptbl = (u32) ((u64) page >> 32);\r\nptbl++;\r\npage += PAGE_SIZE;\r\n} else {\r\n*ptbl = (u32) ((u64) page >> 32);\r\nptbl++;\r\n*ptbl = (u32) page;\r\nptbl++;\r\npage += PAGE_SIZE;\r\n}\r\n}\r\n}\r\nint bnx2i_alloc_qp_resc(struct bnx2i_hba *hba, struct bnx2i_endpoint *ep)\r\n{\r\nstruct bnx2i_5771x_cq_db *cq_db;\r\nep->hba = hba;\r\nep->conn = NULL;\r\nep->ep_cid = ep->ep_iscsi_cid = ep->ep_pg_cid = 0;\r\nep->qp.sq_mem_size = hba->max_sqes * BNX2I_SQ_WQE_SIZE;\r\nep->qp.sq_mem_size =\r\n(ep->qp.sq_mem_size + (PAGE_SIZE - 1)) & PAGE_MASK;\r\nep->qp.sq_pgtbl_size =\r\n(ep->qp.sq_mem_size / PAGE_SIZE) * sizeof(void *);\r\nep->qp.sq_pgtbl_size =\r\n(ep->qp.sq_pgtbl_size + (PAGE_SIZE - 1)) & PAGE_MASK;\r\nep->qp.sq_pgtbl_virt =\r\ndma_alloc_coherent(&hba->pcidev->dev, ep->qp.sq_pgtbl_size,\r\n&ep->qp.sq_pgtbl_phys, GFP_KERNEL);\r\nif (!ep->qp.sq_pgtbl_virt) {\r\nprintk(KERN_ALERT "bnx2i: unable to alloc SQ PT mem (%d)\n",\r\nep->qp.sq_pgtbl_size);\r\ngoto mem_alloc_err;\r\n}\r\nep->qp.sq_virt =\r\ndma_alloc_coherent(&hba->pcidev->dev, ep->qp.sq_mem_size,\r\n&ep->qp.sq_phys, GFP_KERNEL);\r\nif (!ep->qp.sq_virt) {\r\nprintk(KERN_ALERT "bnx2i: unable to alloc SQ BD memory %d\n",\r\nep->qp.sq_mem_size);\r\ngoto mem_alloc_err;\r\n}\r\nmemset(ep->qp.sq_virt, 0x00, ep->qp.sq_mem_size);\r\nep->qp.sq_first_qe = ep->qp.sq_virt;\r\nep->qp.sq_prod_qe = ep->qp.sq_first_qe;\r\nep->qp.sq_cons_qe = ep->qp.sq_first_qe;\r\nep->qp.sq_last_qe = &ep->qp.sq_first_qe[hba->max_sqes - 1];\r\nep->qp.sq_prod_idx = 0;\r\nep->qp.sq_cons_idx = 0;\r\nep->qp.sqe_left = hba->max_sqes;\r\nep->qp.cq_mem_size = hba->max_cqes * BNX2I_CQE_SIZE;\r\nep->qp.cq_mem_size =\r\n(ep->qp.cq_mem_size + (PAGE_SIZE - 1)) & PAGE_MASK;\r\nep->qp.cq_pgtbl_size =\r\n(ep->qp.cq_mem_size / PAGE_SIZE) * sizeof(void *);\r\nep->qp.cq_pgtbl_size =\r\n(ep->qp.cq_pgtbl_size + (PAGE_SIZE - 1)) & PAGE_MASK;\r\nep->qp.cq_pgtbl_virt =\r\ndma_alloc_coherent(&hba->pcidev->dev, ep->qp.cq_pgtbl_size,\r\n&ep->qp.cq_pgtbl_phys, GFP_KERNEL);\r\nif (!ep->qp.cq_pgtbl_virt) {\r\nprintk(KERN_ALERT "bnx2i: unable to alloc CQ PT memory %d\n",\r\nep->qp.cq_pgtbl_size);\r\ngoto mem_alloc_err;\r\n}\r\nep->qp.cq_virt =\r\ndma_alloc_coherent(&hba->pcidev->dev, ep->qp.cq_mem_size,\r\n&ep->qp.cq_phys, GFP_KERNEL);\r\nif (!ep->qp.cq_virt) {\r\nprintk(KERN_ALERT "bnx2i: unable to alloc CQ BD memory %d\n",\r\nep->qp.cq_mem_size);\r\ngoto mem_alloc_err;\r\n}\r\nmemset(ep->qp.cq_virt, 0x00, ep->qp.cq_mem_size);\r\nep->qp.cq_first_qe = ep->qp.cq_virt;\r\nep->qp.cq_prod_qe = ep->qp.cq_first_qe;\r\nep->qp.cq_cons_qe = ep->qp.cq_first_qe;\r\nep->qp.cq_last_qe = &ep->qp.cq_first_qe[hba->max_cqes - 1];\r\nep->qp.cq_prod_idx = 0;\r\nep->qp.cq_cons_idx = 0;\r\nep->qp.cqe_left = hba->max_cqes;\r\nep->qp.cqe_exp_seq_sn = ISCSI_INITIAL_SN;\r\nep->qp.cqe_size = hba->max_cqes;\r\ncq_db = (struct bnx2i_5771x_cq_db *) ep->qp.cq_pgtbl_virt;\r\nmemset(cq_db->sqn, 0xFF, sizeof(cq_db->sqn[0]) * BNX2X_MAX_CQS);\r\nep->qp.rq_mem_size = hba->max_rqes * BNX2I_RQ_WQE_SIZE;\r\nep->qp.rq_mem_size =\r\n(ep->qp.rq_mem_size + (PAGE_SIZE - 1)) & PAGE_MASK;\r\nep->qp.rq_pgtbl_size =\r\n(ep->qp.rq_mem_size / PAGE_SIZE) * sizeof(void *);\r\nep->qp.rq_pgtbl_size =\r\n(ep->qp.rq_pgtbl_size + (PAGE_SIZE - 1)) & PAGE_MASK;\r\nep->qp.rq_pgtbl_virt =\r\ndma_alloc_coherent(&hba->pcidev->dev, ep->qp.rq_pgtbl_size,\r\n&ep->qp.rq_pgtbl_phys, GFP_KERNEL);\r\nif (!ep->qp.rq_pgtbl_virt) {\r\nprintk(KERN_ALERT "bnx2i: unable to alloc RQ PT mem %d\n",\r\nep->qp.rq_pgtbl_size);\r\ngoto mem_alloc_err;\r\n}\r\nep->qp.rq_virt =\r\ndma_alloc_coherent(&hba->pcidev->dev, ep->qp.rq_mem_size,\r\n&ep->qp.rq_phys, GFP_KERNEL);\r\nif (!ep->qp.rq_virt) {\r\nprintk(KERN_ALERT "bnx2i: unable to alloc RQ BD memory %d\n",\r\nep->qp.rq_mem_size);\r\ngoto mem_alloc_err;\r\n}\r\nep->qp.rq_first_qe = ep->qp.rq_virt;\r\nep->qp.rq_prod_qe = ep->qp.rq_first_qe;\r\nep->qp.rq_cons_qe = ep->qp.rq_first_qe;\r\nep->qp.rq_last_qe = &ep->qp.rq_first_qe[hba->max_rqes - 1];\r\nep->qp.rq_prod_idx = 0x8000;\r\nep->qp.rq_cons_idx = 0;\r\nep->qp.rqe_left = hba->max_rqes;\r\nsetup_qp_page_tables(ep);\r\nreturn 0;\r\nmem_alloc_err:\r\nbnx2i_free_qp_resc(hba, ep);\r\nreturn -ENOMEM;\r\n}\r\nvoid bnx2i_free_qp_resc(struct bnx2i_hba *hba, struct bnx2i_endpoint *ep)\r\n{\r\nif (ep->qp.ctx_base) {\r\niounmap(ep->qp.ctx_base);\r\nep->qp.ctx_base = NULL;\r\n}\r\nif (ep->qp.sq_pgtbl_virt) {\r\ndma_free_coherent(&hba->pcidev->dev, ep->qp.sq_pgtbl_size,\r\nep->qp.sq_pgtbl_virt, ep->qp.sq_pgtbl_phys);\r\nep->qp.sq_pgtbl_virt = NULL;\r\nep->qp.sq_pgtbl_phys = 0;\r\n}\r\nif (ep->qp.sq_virt) {\r\ndma_free_coherent(&hba->pcidev->dev, ep->qp.sq_mem_size,\r\nep->qp.sq_virt, ep->qp.sq_phys);\r\nep->qp.sq_virt = NULL;\r\nep->qp.sq_phys = 0;\r\n}\r\nif (ep->qp.rq_pgtbl_virt) {\r\ndma_free_coherent(&hba->pcidev->dev, ep->qp.rq_pgtbl_size,\r\nep->qp.rq_pgtbl_virt, ep->qp.rq_pgtbl_phys);\r\nep->qp.rq_pgtbl_virt = NULL;\r\nep->qp.rq_pgtbl_phys = 0;\r\n}\r\nif (ep->qp.rq_virt) {\r\ndma_free_coherent(&hba->pcidev->dev, ep->qp.rq_mem_size,\r\nep->qp.rq_virt, ep->qp.rq_phys);\r\nep->qp.rq_virt = NULL;\r\nep->qp.rq_phys = 0;\r\n}\r\nif (ep->qp.cq_pgtbl_virt) {\r\ndma_free_coherent(&hba->pcidev->dev, ep->qp.cq_pgtbl_size,\r\nep->qp.cq_pgtbl_virt, ep->qp.cq_pgtbl_phys);\r\nep->qp.cq_pgtbl_virt = NULL;\r\nep->qp.cq_pgtbl_phys = 0;\r\n}\r\nif (ep->qp.cq_virt) {\r\ndma_free_coherent(&hba->pcidev->dev, ep->qp.cq_mem_size,\r\nep->qp.cq_virt, ep->qp.cq_phys);\r\nep->qp.cq_virt = NULL;\r\nep->qp.cq_phys = 0;\r\n}\r\n}\r\nint bnx2i_send_fw_iscsi_init_msg(struct bnx2i_hba *hba)\r\n{\r\nstruct kwqe *kwqe_arr[3];\r\nstruct iscsi_kwqe_init1 iscsi_init;\r\nstruct iscsi_kwqe_init2 iscsi_init2;\r\nint rc = 0;\r\nu64 mask64;\r\nmemset(&iscsi_init, 0x00, sizeof(struct iscsi_kwqe_init1));\r\nmemset(&iscsi_init2, 0x00, sizeof(struct iscsi_kwqe_init2));\r\nbnx2i_adjust_qp_size(hba);\r\niscsi_init.flags =\r\nISCSI_PAGE_SIZE_4K << ISCSI_KWQE_INIT1_PAGE_SIZE_SHIFT;\r\nif (en_tcp_dack)\r\niscsi_init.flags |= ISCSI_KWQE_INIT1_DELAYED_ACK_ENABLE;\r\niscsi_init.reserved0 = 0;\r\niscsi_init.num_cqs = 1;\r\niscsi_init.hdr.op_code = ISCSI_KWQE_OPCODE_INIT1;\r\niscsi_init.hdr.flags =\r\n(ISCSI_KWQE_LAYER_CODE << ISCSI_KWQE_HEADER_LAYER_CODE_SHIFT);\r\niscsi_init.dummy_buffer_addr_lo = (u32) hba->dummy_buf_dma;\r\niscsi_init.dummy_buffer_addr_hi =\r\n(u32) ((u64) hba->dummy_buf_dma >> 32);\r\nhba->num_ccell = hba->max_sqes >> 1;\r\nhba->ctx_ccell_tasks =\r\n((hba->num_ccell & 0xFFFF) | (hba->max_sqes << 16));\r\niscsi_init.num_ccells_per_conn = hba->num_ccell;\r\niscsi_init.num_tasks_per_conn = hba->max_sqes;\r\niscsi_init.sq_wqes_per_page = PAGE_SIZE / BNX2I_SQ_WQE_SIZE;\r\niscsi_init.sq_num_wqes = hba->max_sqes;\r\niscsi_init.cq_log_wqes_per_page =\r\n(u8) bnx2i_power_of2(PAGE_SIZE / BNX2I_CQE_SIZE);\r\niscsi_init.cq_num_wqes = hba->max_cqes;\r\niscsi_init.cq_num_pages = (hba->max_cqes * BNX2I_CQE_SIZE +\r\n(PAGE_SIZE - 1)) / PAGE_SIZE;\r\niscsi_init.sq_num_pages = (hba->max_sqes * BNX2I_SQ_WQE_SIZE +\r\n(PAGE_SIZE - 1)) / PAGE_SIZE;\r\niscsi_init.rq_buffer_size = BNX2I_RQ_WQE_SIZE;\r\niscsi_init.rq_num_wqes = hba->max_rqes;\r\niscsi_init2.hdr.op_code = ISCSI_KWQE_OPCODE_INIT2;\r\niscsi_init2.hdr.flags =\r\n(ISCSI_KWQE_LAYER_CODE << ISCSI_KWQE_HEADER_LAYER_CODE_SHIFT);\r\niscsi_init2.max_cq_sqn = hba->max_cqes * 2 + 1;\r\nmask64 = 0x0ULL;\r\nmask64 |= (\r\n(1UL <<\r\nISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_TTT_NOT_RSRV) |\r\n(1UL <<\r\nISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_EXP_DATASN) |\r\n(1ULL << ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_LUN));\r\nif (error_mask1) {\r\niscsi_init2.error_bit_map[0] = error_mask1;\r\nmask64 ^= (u32)(mask64);\r\nmask64 |= error_mask1;\r\n} else\r\niscsi_init2.error_bit_map[0] = (u32) mask64;\r\nif (error_mask2) {\r\niscsi_init2.error_bit_map[1] = error_mask2;\r\nmask64 &= 0xffffffff;\r\nmask64 |= ((u64)error_mask2 << 32);\r\n} else\r\niscsi_init2.error_bit_map[1] = (u32) (mask64 >> 32);\r\niscsi_error_mask = mask64;\r\nkwqe_arr[0] = (struct kwqe *) &iscsi_init;\r\nkwqe_arr[1] = (struct kwqe *) &iscsi_init2;\r\nif (hba->cnic && hba->cnic->submit_kwqes)\r\nrc = hba->cnic->submit_kwqes(hba->cnic, kwqe_arr, 2);\r\nreturn rc;\r\n}\r\nint bnx2i_process_scsi_cmd_resp(struct iscsi_session *session,\r\nstruct bnx2i_conn *bnx2i_conn,\r\nstruct cqe *cqe)\r\n{\r\nstruct iscsi_conn *conn = bnx2i_conn->cls_conn->dd_data;\r\nstruct bnx2i_hba *hba = bnx2i_conn->hba;\r\nstruct bnx2i_cmd_response *resp_cqe;\r\nstruct bnx2i_cmd *bnx2i_cmd;\r\nstruct iscsi_task *task;\r\nstruct iscsi_scsi_rsp *hdr;\r\nu32 datalen = 0;\r\nresp_cqe = (struct bnx2i_cmd_response *)cqe;\r\nspin_lock_bh(&session->lock);\r\ntask = iscsi_itt_to_task(conn,\r\nresp_cqe->itt & ISCSI_CMD_RESPONSE_INDEX);\r\nif (!task)\r\ngoto fail;\r\nbnx2i_cmd = task->dd_data;\r\nif (bnx2i_cmd->req.op_attr & ISCSI_CMD_REQUEST_READ) {\r\nconn->datain_pdus_cnt +=\r\nresp_cqe->task_stat.read_stat.num_data_ins;\r\nconn->rxdata_octets +=\r\nbnx2i_cmd->req.total_data_transfer_length;\r\nADD_STATS_64(hba, rx_pdus,\r\nresp_cqe->task_stat.read_stat.num_data_ins);\r\nADD_STATS_64(hba, rx_bytes,\r\nbnx2i_cmd->req.total_data_transfer_length);\r\n} else {\r\nconn->dataout_pdus_cnt +=\r\nresp_cqe->task_stat.write_stat.num_data_outs;\r\nconn->r2t_pdus_cnt +=\r\nresp_cqe->task_stat.write_stat.num_r2ts;\r\nconn->txdata_octets +=\r\nbnx2i_cmd->req.total_data_transfer_length;\r\nADD_STATS_64(hba, tx_pdus,\r\nresp_cqe->task_stat.write_stat.num_data_outs);\r\nADD_STATS_64(hba, tx_bytes,\r\nbnx2i_cmd->req.total_data_transfer_length);\r\nADD_STATS_64(hba, rx_pdus,\r\nresp_cqe->task_stat.write_stat.num_r2ts);\r\n}\r\nbnx2i_iscsi_unmap_sg_list(bnx2i_cmd);\r\nhdr = (struct iscsi_scsi_rsp *)task->hdr;\r\nresp_cqe = (struct bnx2i_cmd_response *)cqe;\r\nhdr->opcode = resp_cqe->op_code;\r\nhdr->max_cmdsn = cpu_to_be32(resp_cqe->max_cmd_sn);\r\nhdr->exp_cmdsn = cpu_to_be32(resp_cqe->exp_cmd_sn);\r\nhdr->response = resp_cqe->response;\r\nhdr->cmd_status = resp_cqe->status;\r\nhdr->flags = resp_cqe->response_flags;\r\nhdr->residual_count = cpu_to_be32(resp_cqe->residual_count);\r\nif (resp_cqe->op_code == ISCSI_OP_SCSI_DATA_IN)\r\ngoto done;\r\nif (resp_cqe->status == SAM_STAT_CHECK_CONDITION) {\r\ndatalen = resp_cqe->data_length;\r\nif (datalen < 2)\r\ngoto done;\r\nif (datalen > BNX2I_RQ_WQE_SIZE) {\r\niscsi_conn_printk(KERN_ERR, conn,\r\n"sense data len %d > RQ sz\n",\r\ndatalen);\r\ndatalen = BNX2I_RQ_WQE_SIZE;\r\n} else if (datalen > ISCSI_DEF_MAX_RECV_SEG_LEN) {\r\niscsi_conn_printk(KERN_ERR, conn,\r\n"sense data len %d > conn data\n",\r\ndatalen);\r\ndatalen = ISCSI_DEF_MAX_RECV_SEG_LEN;\r\n}\r\nbnx2i_get_rq_buf(bnx2i_cmd->conn, conn->data, datalen);\r\nbnx2i_put_rq_buf(bnx2i_cmd->conn, 1);\r\n}\r\ndone:\r\n__iscsi_complete_pdu(conn, (struct iscsi_hdr *)hdr,\r\nconn->data, datalen);\r\nfail:\r\nspin_unlock_bh(&session->lock);\r\nreturn 0;\r\n}\r\nstatic int bnx2i_process_login_resp(struct iscsi_session *session,\r\nstruct bnx2i_conn *bnx2i_conn,\r\nstruct cqe *cqe)\r\n{\r\nstruct iscsi_conn *conn = bnx2i_conn->cls_conn->dd_data;\r\nstruct iscsi_task *task;\r\nstruct bnx2i_login_response *login;\r\nstruct iscsi_login_rsp *resp_hdr;\r\nint pld_len;\r\nint pad_len;\r\nlogin = (struct bnx2i_login_response *) cqe;\r\nspin_lock(&session->lock);\r\ntask = iscsi_itt_to_task(conn,\r\nlogin->itt & ISCSI_LOGIN_RESPONSE_INDEX);\r\nif (!task)\r\ngoto done;\r\nresp_hdr = (struct iscsi_login_rsp *) &bnx2i_conn->gen_pdu.resp_hdr;\r\nmemset(resp_hdr, 0, sizeof(struct iscsi_hdr));\r\nresp_hdr->opcode = login->op_code;\r\nresp_hdr->flags = login->response_flags;\r\nresp_hdr->max_version = login->version_max;\r\nresp_hdr->active_version = login->version_active;\r\nresp_hdr->hlength = 0;\r\nhton24(resp_hdr->dlength, login->data_length);\r\nmemcpy(resp_hdr->isid, &login->isid_lo, 6);\r\nresp_hdr->tsih = cpu_to_be16(login->tsih);\r\nresp_hdr->itt = task->hdr->itt;\r\nresp_hdr->statsn = cpu_to_be32(login->stat_sn);\r\nresp_hdr->exp_cmdsn = cpu_to_be32(login->exp_cmd_sn);\r\nresp_hdr->max_cmdsn = cpu_to_be32(login->max_cmd_sn);\r\nresp_hdr->status_class = login->status_class;\r\nresp_hdr->status_detail = login->status_detail;\r\npld_len = login->data_length;\r\nbnx2i_conn->gen_pdu.resp_wr_ptr =\r\nbnx2i_conn->gen_pdu.resp_buf + pld_len;\r\npad_len = 0;\r\nif (pld_len & 0x3)\r\npad_len = 4 - (pld_len % 4);\r\nif (pad_len) {\r\nint i = 0;\r\nfor (i = 0; i < pad_len; i++) {\r\nbnx2i_conn->gen_pdu.resp_wr_ptr[0] = 0;\r\nbnx2i_conn->gen_pdu.resp_wr_ptr++;\r\n}\r\n}\r\n__iscsi_complete_pdu(conn, (struct iscsi_hdr *)resp_hdr,\r\nbnx2i_conn->gen_pdu.resp_buf,\r\nbnx2i_conn->gen_pdu.resp_wr_ptr - bnx2i_conn->gen_pdu.resp_buf);\r\ndone:\r\nspin_unlock(&session->lock);\r\nreturn 0;\r\n}\r\nstatic int bnx2i_process_text_resp(struct iscsi_session *session,\r\nstruct bnx2i_conn *bnx2i_conn,\r\nstruct cqe *cqe)\r\n{\r\nstruct iscsi_conn *conn = bnx2i_conn->cls_conn->dd_data;\r\nstruct iscsi_task *task;\r\nstruct bnx2i_text_response *text;\r\nstruct iscsi_text_rsp *resp_hdr;\r\nint pld_len;\r\nint pad_len;\r\ntext = (struct bnx2i_text_response *) cqe;\r\nspin_lock(&session->lock);\r\ntask = iscsi_itt_to_task(conn, text->itt & ISCSI_LOGIN_RESPONSE_INDEX);\r\nif (!task)\r\ngoto done;\r\nresp_hdr = (struct iscsi_text_rsp *)&bnx2i_conn->gen_pdu.resp_hdr;\r\nmemset(resp_hdr, 0, sizeof(struct iscsi_hdr));\r\nresp_hdr->opcode = text->op_code;\r\nresp_hdr->flags = text->response_flags;\r\nresp_hdr->hlength = 0;\r\nhton24(resp_hdr->dlength, text->data_length);\r\nresp_hdr->itt = task->hdr->itt;\r\nresp_hdr->ttt = cpu_to_be32(text->ttt);\r\nresp_hdr->statsn = task->hdr->exp_statsn;\r\nresp_hdr->exp_cmdsn = cpu_to_be32(text->exp_cmd_sn);\r\nresp_hdr->max_cmdsn = cpu_to_be32(text->max_cmd_sn);\r\npld_len = text->data_length;\r\nbnx2i_conn->gen_pdu.resp_wr_ptr = bnx2i_conn->gen_pdu.resp_buf +\r\npld_len;\r\npad_len = 0;\r\nif (pld_len & 0x3)\r\npad_len = 4 - (pld_len % 4);\r\nif (pad_len) {\r\nint i = 0;\r\nfor (i = 0; i < pad_len; i++) {\r\nbnx2i_conn->gen_pdu.resp_wr_ptr[0] = 0;\r\nbnx2i_conn->gen_pdu.resp_wr_ptr++;\r\n}\r\n}\r\n__iscsi_complete_pdu(conn, (struct iscsi_hdr *)resp_hdr,\r\nbnx2i_conn->gen_pdu.resp_buf,\r\nbnx2i_conn->gen_pdu.resp_wr_ptr -\r\nbnx2i_conn->gen_pdu.resp_buf);\r\ndone:\r\nspin_unlock(&session->lock);\r\nreturn 0;\r\n}\r\nstatic int bnx2i_process_tmf_resp(struct iscsi_session *session,\r\nstruct bnx2i_conn *bnx2i_conn,\r\nstruct cqe *cqe)\r\n{\r\nstruct iscsi_conn *conn = bnx2i_conn->cls_conn->dd_data;\r\nstruct iscsi_task *task;\r\nstruct bnx2i_tmf_response *tmf_cqe;\r\nstruct iscsi_tm_rsp *resp_hdr;\r\ntmf_cqe = (struct bnx2i_tmf_response *)cqe;\r\nspin_lock(&session->lock);\r\ntask = iscsi_itt_to_task(conn,\r\ntmf_cqe->itt & ISCSI_TMF_RESPONSE_INDEX);\r\nif (!task)\r\ngoto done;\r\nresp_hdr = (struct iscsi_tm_rsp *) &bnx2i_conn->gen_pdu.resp_hdr;\r\nmemset(resp_hdr, 0, sizeof(struct iscsi_hdr));\r\nresp_hdr->opcode = tmf_cqe->op_code;\r\nresp_hdr->max_cmdsn = cpu_to_be32(tmf_cqe->max_cmd_sn);\r\nresp_hdr->exp_cmdsn = cpu_to_be32(tmf_cqe->exp_cmd_sn);\r\nresp_hdr->itt = task->hdr->itt;\r\nresp_hdr->response = tmf_cqe->response;\r\n__iscsi_complete_pdu(conn, (struct iscsi_hdr *)resp_hdr, NULL, 0);\r\ndone:\r\nspin_unlock(&session->lock);\r\nreturn 0;\r\n}\r\nstatic int bnx2i_process_logout_resp(struct iscsi_session *session,\r\nstruct bnx2i_conn *bnx2i_conn,\r\nstruct cqe *cqe)\r\n{\r\nstruct iscsi_conn *conn = bnx2i_conn->cls_conn->dd_data;\r\nstruct iscsi_task *task;\r\nstruct bnx2i_logout_response *logout;\r\nstruct iscsi_logout_rsp *resp_hdr;\r\nlogout = (struct bnx2i_logout_response *) cqe;\r\nspin_lock(&session->lock);\r\ntask = iscsi_itt_to_task(conn,\r\nlogout->itt & ISCSI_LOGOUT_RESPONSE_INDEX);\r\nif (!task)\r\ngoto done;\r\nresp_hdr = (struct iscsi_logout_rsp *) &bnx2i_conn->gen_pdu.resp_hdr;\r\nmemset(resp_hdr, 0, sizeof(struct iscsi_hdr));\r\nresp_hdr->opcode = logout->op_code;\r\nresp_hdr->flags = logout->response;\r\nresp_hdr->hlength = 0;\r\nresp_hdr->itt = task->hdr->itt;\r\nresp_hdr->statsn = task->hdr->exp_statsn;\r\nresp_hdr->exp_cmdsn = cpu_to_be32(logout->exp_cmd_sn);\r\nresp_hdr->max_cmdsn = cpu_to_be32(logout->max_cmd_sn);\r\nresp_hdr->t2wait = cpu_to_be32(logout->time_to_wait);\r\nresp_hdr->t2retain = cpu_to_be32(logout->time_to_retain);\r\n__iscsi_complete_pdu(conn, (struct iscsi_hdr *)resp_hdr, NULL, 0);\r\nbnx2i_conn->ep->state = EP_STATE_LOGOUT_RESP_RCVD;\r\ndone:\r\nspin_unlock(&session->lock);\r\nreturn 0;\r\n}\r\nstatic void bnx2i_process_nopin_local_cmpl(struct iscsi_session *session,\r\nstruct bnx2i_conn *bnx2i_conn,\r\nstruct cqe *cqe)\r\n{\r\nstruct iscsi_conn *conn = bnx2i_conn->cls_conn->dd_data;\r\nstruct bnx2i_nop_in_msg *nop_in;\r\nstruct iscsi_task *task;\r\nnop_in = (struct bnx2i_nop_in_msg *)cqe;\r\nspin_lock(&session->lock);\r\ntask = iscsi_itt_to_task(conn,\r\nnop_in->itt & ISCSI_NOP_IN_MSG_INDEX);\r\nif (task)\r\n__iscsi_put_task(task);\r\nspin_unlock(&session->lock);\r\n}\r\nstatic void bnx2i_unsol_pdu_adjust_rq(struct bnx2i_conn *bnx2i_conn)\r\n{\r\nchar dummy_rq_data[2];\r\nbnx2i_get_rq_buf(bnx2i_conn, dummy_rq_data, 1);\r\nbnx2i_put_rq_buf(bnx2i_conn, 1);\r\n}\r\nstatic int bnx2i_process_nopin_mesg(struct iscsi_session *session,\r\nstruct bnx2i_conn *bnx2i_conn,\r\nstruct cqe *cqe)\r\n{\r\nstruct iscsi_conn *conn = bnx2i_conn->cls_conn->dd_data;\r\nstruct iscsi_task *task;\r\nstruct bnx2i_nop_in_msg *nop_in;\r\nstruct iscsi_nopin *hdr;\r\nint tgt_async_nop = 0;\r\nnop_in = (struct bnx2i_nop_in_msg *)cqe;\r\nspin_lock(&session->lock);\r\nhdr = (struct iscsi_nopin *)&bnx2i_conn->gen_pdu.resp_hdr;\r\nmemset(hdr, 0, sizeof(struct iscsi_hdr));\r\nhdr->opcode = nop_in->op_code;\r\nhdr->max_cmdsn = cpu_to_be32(nop_in->max_cmd_sn);\r\nhdr->exp_cmdsn = cpu_to_be32(nop_in->exp_cmd_sn);\r\nhdr->ttt = cpu_to_be32(nop_in->ttt);\r\nif (nop_in->itt == (u16) RESERVED_ITT) {\r\nbnx2i_unsol_pdu_adjust_rq(bnx2i_conn);\r\nhdr->itt = RESERVED_ITT;\r\ntgt_async_nop = 1;\r\ngoto done;\r\n}\r\ntask = iscsi_itt_to_task(conn,\r\n(itt_t) (nop_in->itt & ISCSI_NOP_IN_MSG_INDEX));\r\nif (task) {\r\nhdr->flags = ISCSI_FLAG_CMD_FINAL;\r\nhdr->itt = task->hdr->itt;\r\nhdr->ttt = cpu_to_be32(nop_in->ttt);\r\nmemcpy(&hdr->lun, nop_in->lun, 8);\r\n}\r\ndone:\r\n__iscsi_complete_pdu(conn, (struct iscsi_hdr *)hdr, NULL, 0);\r\nspin_unlock(&session->lock);\r\nreturn tgt_async_nop;\r\n}\r\nstatic void bnx2i_process_async_mesg(struct iscsi_session *session,\r\nstruct bnx2i_conn *bnx2i_conn,\r\nstruct cqe *cqe)\r\n{\r\nstruct bnx2i_async_msg *async_cqe;\r\nstruct iscsi_async *resp_hdr;\r\nu8 async_event;\r\nbnx2i_unsol_pdu_adjust_rq(bnx2i_conn);\r\nasync_cqe = (struct bnx2i_async_msg *)cqe;\r\nasync_event = async_cqe->async_event;\r\nif (async_event == ISCSI_ASYNC_MSG_SCSI_EVENT) {\r\niscsi_conn_printk(KERN_ALERT, bnx2i_conn->cls_conn->dd_data,\r\n"async: scsi events not supported\n");\r\nreturn;\r\n}\r\nspin_lock(&session->lock);\r\nresp_hdr = (struct iscsi_async *) &bnx2i_conn->gen_pdu.resp_hdr;\r\nmemset(resp_hdr, 0, sizeof(struct iscsi_hdr));\r\nresp_hdr->opcode = async_cqe->op_code;\r\nresp_hdr->flags = 0x80;\r\nmemcpy(&resp_hdr->lun, async_cqe->lun, 8);\r\nresp_hdr->exp_cmdsn = cpu_to_be32(async_cqe->exp_cmd_sn);\r\nresp_hdr->max_cmdsn = cpu_to_be32(async_cqe->max_cmd_sn);\r\nresp_hdr->async_event = async_cqe->async_event;\r\nresp_hdr->async_vcode = async_cqe->async_vcode;\r\nresp_hdr->param1 = cpu_to_be16(async_cqe->param1);\r\nresp_hdr->param2 = cpu_to_be16(async_cqe->param2);\r\nresp_hdr->param3 = cpu_to_be16(async_cqe->param3);\r\n__iscsi_complete_pdu(bnx2i_conn->cls_conn->dd_data,\r\n(struct iscsi_hdr *)resp_hdr, NULL, 0);\r\nspin_unlock(&session->lock);\r\n}\r\nstatic void bnx2i_process_reject_mesg(struct iscsi_session *session,\r\nstruct bnx2i_conn *bnx2i_conn,\r\nstruct cqe *cqe)\r\n{\r\nstruct iscsi_conn *conn = bnx2i_conn->cls_conn->dd_data;\r\nstruct bnx2i_reject_msg *reject;\r\nstruct iscsi_reject *hdr;\r\nreject = (struct bnx2i_reject_msg *) cqe;\r\nif (reject->data_length) {\r\nbnx2i_get_rq_buf(bnx2i_conn, conn->data, reject->data_length);\r\nbnx2i_put_rq_buf(bnx2i_conn, 1);\r\n} else\r\nbnx2i_unsol_pdu_adjust_rq(bnx2i_conn);\r\nspin_lock(&session->lock);\r\nhdr = (struct iscsi_reject *) &bnx2i_conn->gen_pdu.resp_hdr;\r\nmemset(hdr, 0, sizeof(struct iscsi_hdr));\r\nhdr->opcode = reject->op_code;\r\nhdr->reason = reject->reason;\r\nhton24(hdr->dlength, reject->data_length);\r\nhdr->max_cmdsn = cpu_to_be32(reject->max_cmd_sn);\r\nhdr->exp_cmdsn = cpu_to_be32(reject->exp_cmd_sn);\r\nhdr->ffffffff = cpu_to_be32(RESERVED_ITT);\r\n__iscsi_complete_pdu(conn, (struct iscsi_hdr *)hdr, conn->data,\r\nreject->data_length);\r\nspin_unlock(&session->lock);\r\n}\r\nstatic void bnx2i_process_cmd_cleanup_resp(struct iscsi_session *session,\r\nstruct bnx2i_conn *bnx2i_conn,\r\nstruct cqe *cqe)\r\n{\r\nstruct bnx2i_cleanup_response *cmd_clean_rsp;\r\nstruct iscsi_conn *conn = bnx2i_conn->cls_conn->dd_data;\r\nstruct iscsi_task *task;\r\ncmd_clean_rsp = (struct bnx2i_cleanup_response *)cqe;\r\nspin_lock(&session->lock);\r\ntask = iscsi_itt_to_task(conn,\r\ncmd_clean_rsp->itt & ISCSI_CLEANUP_RESPONSE_INDEX);\r\nif (!task)\r\nprintk(KERN_ALERT "bnx2i: cmd clean ITT %x not active\n",\r\ncmd_clean_rsp->itt & ISCSI_CLEANUP_RESPONSE_INDEX);\r\nspin_unlock(&session->lock);\r\ncomplete(&bnx2i_conn->cmd_cleanup_cmpl);\r\n}\r\nint bnx2i_percpu_io_thread(void *arg)\r\n{\r\nstruct bnx2i_percpu_s *p = arg;\r\nstruct bnx2i_work *work, *tmp;\r\nLIST_HEAD(work_list);\r\nset_user_nice(current, -20);\r\nwhile (!kthread_should_stop()) {\r\nspin_lock_bh(&p->p_work_lock);\r\nwhile (!list_empty(&p->work_list)) {\r\nlist_splice_init(&p->work_list, &work_list);\r\nspin_unlock_bh(&p->p_work_lock);\r\nlist_for_each_entry_safe(work, tmp, &work_list, list) {\r\nlist_del_init(&work->list);\r\nbnx2i_process_scsi_cmd_resp(work->session,\r\nwork->bnx2i_conn,\r\n&work->cqe);\r\natomic_dec(&work->bnx2i_conn->work_cnt);\r\nkfree(work);\r\n}\r\nspin_lock_bh(&p->p_work_lock);\r\n}\r\nset_current_state(TASK_INTERRUPTIBLE);\r\nspin_unlock_bh(&p->p_work_lock);\r\nschedule();\r\n}\r\n__set_current_state(TASK_RUNNING);\r\nreturn 0;\r\n}\r\nstatic int bnx2i_queue_scsi_cmd_resp(struct iscsi_session *session,\r\nstruct bnx2i_conn *bnx2i_conn,\r\nstruct bnx2i_nop_in_msg *cqe)\r\n{\r\nstruct bnx2i_work *bnx2i_work = NULL;\r\nstruct bnx2i_percpu_s *p = NULL;\r\nstruct iscsi_task *task;\r\nstruct scsi_cmnd *sc;\r\nint rc = 0;\r\nint cpu;\r\nspin_lock(&session->lock);\r\ntask = iscsi_itt_to_task(bnx2i_conn->cls_conn->dd_data,\r\ncqe->itt & ISCSI_CMD_RESPONSE_INDEX);\r\nif (!task || !task->sc) {\r\nspin_unlock(&session->lock);\r\nreturn -EINVAL;\r\n}\r\nsc = task->sc;\r\nif (!blk_rq_cpu_valid(sc->request))\r\ncpu = smp_processor_id();\r\nelse\r\ncpu = sc->request->cpu;\r\nspin_unlock(&session->lock);\r\np = &per_cpu(bnx2i_percpu, cpu);\r\nspin_lock(&p->p_work_lock);\r\nif (unlikely(!p->iothread)) {\r\nrc = -EINVAL;\r\ngoto err;\r\n}\r\nbnx2i_work = kzalloc(sizeof(struct bnx2i_work), GFP_ATOMIC);\r\nif (bnx2i_work) {\r\nINIT_LIST_HEAD(&bnx2i_work->list);\r\nbnx2i_work->session = session;\r\nbnx2i_work->bnx2i_conn = bnx2i_conn;\r\nmemcpy(&bnx2i_work->cqe, cqe, sizeof(struct cqe));\r\nlist_add_tail(&bnx2i_work->list, &p->work_list);\r\natomic_inc(&bnx2i_conn->work_cnt);\r\nwake_up_process(p->iothread);\r\nspin_unlock(&p->p_work_lock);\r\ngoto done;\r\n} else\r\nrc = -ENOMEM;\r\nerr:\r\nspin_unlock(&p->p_work_lock);\r\nbnx2i_process_scsi_cmd_resp(session, bnx2i_conn, (struct cqe *)cqe);\r\ndone:\r\nreturn rc;\r\n}\r\nstatic int bnx2i_process_new_cqes(struct bnx2i_conn *bnx2i_conn)\r\n{\r\nstruct iscsi_conn *conn = bnx2i_conn->cls_conn->dd_data;\r\nstruct iscsi_session *session = conn->session;\r\nstruct bnx2i_hba *hba = bnx2i_conn->hba;\r\nstruct qp_info *qp;\r\nstruct bnx2i_nop_in_msg *nopin;\r\nint tgt_async_msg;\r\nint cqe_cnt = 0;\r\nif (bnx2i_conn->ep == NULL)\r\nreturn 0;\r\nqp = &bnx2i_conn->ep->qp;\r\nif (!qp->cq_virt) {\r\nprintk(KERN_ALERT "bnx2i (%s): cq resr freed in bh execution!",\r\nhba->netdev->name);\r\ngoto out;\r\n}\r\nwhile (1) {\r\nnopin = (struct bnx2i_nop_in_msg *) qp->cq_cons_qe;\r\nif (nopin->cq_req_sn != qp->cqe_exp_seq_sn)\r\nbreak;\r\nif (unlikely(test_bit(ISCSI_SUSPEND_BIT, &conn->suspend_rx))) {\r\nif (nopin->op_code == ISCSI_OP_NOOP_IN &&\r\nnopin->itt == (u16) RESERVED_ITT) {\r\nprintk(KERN_ALERT "bnx2i: Unsolicited "\r\n"NOP-In detected for suspended "\r\n"connection dev=%s!\n",\r\nhba->netdev->name);\r\nbnx2i_unsol_pdu_adjust_rq(bnx2i_conn);\r\ngoto cqe_out;\r\n}\r\nbreak;\r\n}\r\ntgt_async_msg = 0;\r\nswitch (nopin->op_code) {\r\ncase ISCSI_OP_SCSI_CMD_RSP:\r\ncase ISCSI_OP_SCSI_DATA_IN:\r\nbnx2i_queue_scsi_cmd_resp(session, bnx2i_conn, nopin);\r\ngoto done;\r\ncase ISCSI_OP_LOGIN_RSP:\r\nbnx2i_process_login_resp(session, bnx2i_conn,\r\nqp->cq_cons_qe);\r\nbreak;\r\ncase ISCSI_OP_SCSI_TMFUNC_RSP:\r\nbnx2i_process_tmf_resp(session, bnx2i_conn,\r\nqp->cq_cons_qe);\r\nbreak;\r\ncase ISCSI_OP_TEXT_RSP:\r\nbnx2i_process_text_resp(session, bnx2i_conn,\r\nqp->cq_cons_qe);\r\nbreak;\r\ncase ISCSI_OP_LOGOUT_RSP:\r\nbnx2i_process_logout_resp(session, bnx2i_conn,\r\nqp->cq_cons_qe);\r\nbreak;\r\ncase ISCSI_OP_NOOP_IN:\r\nif (bnx2i_process_nopin_mesg(session, bnx2i_conn,\r\nqp->cq_cons_qe))\r\ntgt_async_msg = 1;\r\nbreak;\r\ncase ISCSI_OPCODE_NOPOUT_LOCAL_COMPLETION:\r\nbnx2i_process_nopin_local_cmpl(session, bnx2i_conn,\r\nqp->cq_cons_qe);\r\nbreak;\r\ncase ISCSI_OP_ASYNC_EVENT:\r\nbnx2i_process_async_mesg(session, bnx2i_conn,\r\nqp->cq_cons_qe);\r\ntgt_async_msg = 1;\r\nbreak;\r\ncase ISCSI_OP_REJECT:\r\nbnx2i_process_reject_mesg(session, bnx2i_conn,\r\nqp->cq_cons_qe);\r\nbreak;\r\ncase ISCSI_OPCODE_CLEANUP_RESPONSE:\r\nbnx2i_process_cmd_cleanup_resp(session, bnx2i_conn,\r\nqp->cq_cons_qe);\r\nbreak;\r\ndefault:\r\nprintk(KERN_ALERT "bnx2i: unknown opcode 0x%x\n",\r\nnopin->op_code);\r\n}\r\nADD_STATS_64(hba, rx_pdus, 1);\r\nADD_STATS_64(hba, rx_bytes, nopin->data_length);\r\ndone:\r\nif (!tgt_async_msg) {\r\nif (!atomic_read(&bnx2i_conn->ep->num_active_cmds))\r\nprintk(KERN_ALERT "bnx2i (%s): no active cmd! "\r\n"op 0x%x\n",\r\nhba->netdev->name,\r\nnopin->op_code);\r\nelse\r\natomic_dec(&bnx2i_conn->ep->num_active_cmds);\r\n}\r\ncqe_out:\r\ncqe_cnt++;\r\nqp->cqe_exp_seq_sn++;\r\nif (qp->cqe_exp_seq_sn == (qp->cqe_size * 2 + 1))\r\nqp->cqe_exp_seq_sn = ISCSI_INITIAL_SN;\r\nif (qp->cq_cons_qe == qp->cq_last_qe) {\r\nqp->cq_cons_qe = qp->cq_first_qe;\r\nqp->cq_cons_idx = 0;\r\n} else {\r\nqp->cq_cons_qe++;\r\nqp->cq_cons_idx++;\r\n}\r\n}\r\nout:\r\nreturn cqe_cnt;\r\n}\r\nstatic void bnx2i_fastpath_notification(struct bnx2i_hba *hba,\r\nstruct iscsi_kcqe *new_cqe_kcqe)\r\n{\r\nstruct bnx2i_conn *bnx2i_conn;\r\nu32 iscsi_cid;\r\nint nxt_idx;\r\niscsi_cid = new_cqe_kcqe->iscsi_conn_id;\r\nbnx2i_conn = bnx2i_get_conn_from_id(hba, iscsi_cid);\r\nif (!bnx2i_conn) {\r\nprintk(KERN_ALERT "cid #%x not valid\n", iscsi_cid);\r\nreturn;\r\n}\r\nif (!bnx2i_conn->ep) {\r\nprintk(KERN_ALERT "cid #%x - ep not bound\n", iscsi_cid);\r\nreturn;\r\n}\r\nbnx2i_process_new_cqes(bnx2i_conn);\r\nnxt_idx = bnx2i_arm_cq_event_coalescing(bnx2i_conn->ep,\r\nCNIC_ARM_CQE_FP);\r\nif (nxt_idx && nxt_idx == bnx2i_process_new_cqes(bnx2i_conn))\r\nbnx2i_arm_cq_event_coalescing(bnx2i_conn->ep, CNIC_ARM_CQE_FP);\r\n}\r\nstatic void bnx2i_process_update_conn_cmpl(struct bnx2i_hba *hba,\r\nstruct iscsi_kcqe *update_kcqe)\r\n{\r\nstruct bnx2i_conn *conn;\r\nu32 iscsi_cid;\r\niscsi_cid = update_kcqe->iscsi_conn_id;\r\nconn = bnx2i_get_conn_from_id(hba, iscsi_cid);\r\nif (!conn) {\r\nprintk(KERN_ALERT "conn_update: cid %x not valid\n", iscsi_cid);\r\nreturn;\r\n}\r\nif (!conn->ep) {\r\nprintk(KERN_ALERT "cid %x does not have ep bound\n", iscsi_cid);\r\nreturn;\r\n}\r\nif (update_kcqe->completion_status) {\r\nprintk(KERN_ALERT "request failed cid %x\n", iscsi_cid);\r\nconn->ep->state = EP_STATE_ULP_UPDATE_FAILED;\r\n} else\r\nconn->ep->state = EP_STATE_ULP_UPDATE_COMPL;\r\nwake_up_interruptible(&conn->ep->ofld_wait);\r\n}\r\nstatic void bnx2i_recovery_que_add_conn(struct bnx2i_hba *hba,\r\nstruct bnx2i_conn *bnx2i_conn)\r\n{\r\niscsi_conn_failure(bnx2i_conn->cls_conn->dd_data,\r\nISCSI_ERR_CONN_FAILED);\r\n}\r\nstatic void bnx2i_process_tcp_error(struct bnx2i_hba *hba,\r\nstruct iscsi_kcqe *tcp_err)\r\n{\r\nstruct bnx2i_conn *bnx2i_conn;\r\nu32 iscsi_cid;\r\niscsi_cid = tcp_err->iscsi_conn_id;\r\nbnx2i_conn = bnx2i_get_conn_from_id(hba, iscsi_cid);\r\nif (!bnx2i_conn) {\r\nprintk(KERN_ALERT "bnx2i - cid 0x%x not valid\n", iscsi_cid);\r\nreturn;\r\n}\r\nprintk(KERN_ALERT "bnx2i - cid 0x%x had TCP errors, error code 0x%x\n",\r\niscsi_cid, tcp_err->completion_status);\r\nbnx2i_recovery_que_add_conn(bnx2i_conn->hba, bnx2i_conn);\r\n}\r\nstatic void bnx2i_process_iscsi_error(struct bnx2i_hba *hba,\r\nstruct iscsi_kcqe *iscsi_err)\r\n{\r\nstruct bnx2i_conn *bnx2i_conn;\r\nu32 iscsi_cid;\r\nchar warn_notice[] = "iscsi_warning";\r\nchar error_notice[] = "iscsi_error";\r\nchar additional_notice[64];\r\nchar *message;\r\nint need_recovery;\r\nu64 err_mask64;\r\niscsi_cid = iscsi_err->iscsi_conn_id;\r\nbnx2i_conn = bnx2i_get_conn_from_id(hba, iscsi_cid);\r\nif (!bnx2i_conn) {\r\nprintk(KERN_ALERT "bnx2i - cid 0x%x not valid\n", iscsi_cid);\r\nreturn;\r\n}\r\nerr_mask64 = (0x1ULL << iscsi_err->completion_status);\r\nif (err_mask64 & iscsi_error_mask) {\r\nneed_recovery = 0;\r\nmessage = warn_notice;\r\n} else {\r\nneed_recovery = 1;\r\nmessage = error_notice;\r\n}\r\nswitch (iscsi_err->completion_status) {\r\ncase ISCSI_KCQE_COMPLETION_STATUS_HDR_DIG_ERR:\r\nstrcpy(additional_notice, "hdr digest err");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_DATA_DIG_ERR:\r\nstrcpy(additional_notice, "data digest err");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_OPCODE:\r\nstrcpy(additional_notice, "wrong opcode rcvd");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_AHS_LEN:\r\nstrcpy(additional_notice, "AHS len > 0 rcvd");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_ITT:\r\nstrcpy(additional_notice, "invalid ITT rcvd");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_STATSN:\r\nstrcpy(additional_notice, "wrong StatSN rcvd");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_EXP_DATASN:\r\nstrcpy(additional_notice, "wrong DataSN rcvd");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_PEND_R2T:\r\nstrcpy(additional_notice, "pend R2T violation");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_O_U_0:\r\nstrcpy(additional_notice, "ERL0, UO");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_O_U_1:\r\nstrcpy(additional_notice, "ERL0, U1");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_O_U_2:\r\nstrcpy(additional_notice, "ERL0, U2");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_O_U_3:\r\nstrcpy(additional_notice, "ERL0, U3");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_O_U_4:\r\nstrcpy(additional_notice, "ERL0, U4");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_O_U_5:\r\nstrcpy(additional_notice, "ERL0, U5");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_O_U_6:\r\nstrcpy(additional_notice, "ERL0, U6");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_REMAIN_RCV_LEN:\r\nstrcpy(additional_notice, "invalid resi len");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_MAX_RCV_PDU_LEN:\r\nstrcpy(additional_notice, "MRDSL violation");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_F_BIT_ZERO:\r\nstrcpy(additional_notice, "F-bit not set");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_TTT_NOT_RSRV:\r\nstrcpy(additional_notice, "invalid TTT");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_DATASN:\r\nstrcpy(additional_notice, "invalid DataSN");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_REMAIN_BURST_LEN:\r\nstrcpy(additional_notice, "burst len violation");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_BUFFER_OFF:\r\nstrcpy(additional_notice, "buf offset violation");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_LUN:\r\nstrcpy(additional_notice, "invalid LUN field");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_R2TSN:\r\nstrcpy(additional_notice, "invalid R2TSN field");\r\nbreak;\r\n#define BNX2I_ERR_DESIRED_DATA_TRNS_LEN_0 \\r\nISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_DESIRED_DATA_TRNS_LEN_0\r\ncase BNX2I_ERR_DESIRED_DATA_TRNS_LEN_0:\r\nstrcpy(additional_notice, "invalid cmd len1");\r\nbreak;\r\n#define BNX2I_ERR_DESIRED_DATA_TRNS_LEN_1 \\r\nISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_DESIRED_DATA_TRNS_LEN_1\r\ncase BNX2I_ERR_DESIRED_DATA_TRNS_LEN_1:\r\nstrcpy(additional_notice, "invalid cmd len2");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_PEND_R2T_EXCEED:\r\nstrcpy(additional_notice,\r\n"pend r2t exceeds MaxOutstandingR2T value");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_TTT_IS_RSRV:\r\nstrcpy(additional_notice, "TTT is rsvd");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_MAX_BURST_LEN:\r\nstrcpy(additional_notice, "MBL violation");\r\nbreak;\r\n#define BNX2I_ERR_DATA_SEG_LEN_NOT_ZERO \\r\nISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_DATA_SEG_LEN_NOT_ZERO\r\ncase BNX2I_ERR_DATA_SEG_LEN_NOT_ZERO:\r\nstrcpy(additional_notice, "data seg len != 0");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_REJECT_PDU_LEN:\r\nstrcpy(additional_notice, "reject pdu len error");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_ASYNC_PDU_LEN:\r\nstrcpy(additional_notice, "async pdu len error");\r\nbreak;\r\ncase ISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_NOPIN_PDU_LEN:\r\nstrcpy(additional_notice, "nopin pdu len error");\r\nbreak;\r\n#define BNX2_ERR_PEND_R2T_IN_CLEANUP \\r\nISCSI_KCQE_COMPLETION_STATUS_PROTOCOL_ERR_PEND_R2T_IN_CLEANUP\r\ncase BNX2_ERR_PEND_R2T_IN_CLEANUP:\r\nstrcpy(additional_notice, "pend r2t in cleanup");\r\nbreak;\r\ncase ISCI_KCQE_COMPLETION_STATUS_TCP_ERROR_IP_FRAGMENT:\r\nstrcpy(additional_notice, "IP fragments rcvd");\r\nbreak;\r\ncase ISCI_KCQE_COMPLETION_STATUS_TCP_ERROR_IP_OPTIONS:\r\nstrcpy(additional_notice, "IP options error");\r\nbreak;\r\ncase ISCI_KCQE_COMPLETION_STATUS_TCP_ERROR_URGENT_FLAG:\r\nstrcpy(additional_notice, "urgent flag error");\r\nbreak;\r\ndefault:\r\nprintk(KERN_ALERT "iscsi_err - unknown err %x\n",\r\niscsi_err->completion_status);\r\n}\r\nif (need_recovery) {\r\niscsi_conn_printk(KERN_ALERT,\r\nbnx2i_conn->cls_conn->dd_data,\r\n"bnx2i: %s - %s\n",\r\nmessage, additional_notice);\r\niscsi_conn_printk(KERN_ALERT,\r\nbnx2i_conn->cls_conn->dd_data,\r\n"conn_err - hostno %d conn %p, "\r\n"iscsi_cid %x cid %x\n",\r\nbnx2i_conn->hba->shost->host_no,\r\nbnx2i_conn, bnx2i_conn->ep->ep_iscsi_cid,\r\nbnx2i_conn->ep->ep_cid);\r\nbnx2i_recovery_que_add_conn(bnx2i_conn->hba, bnx2i_conn);\r\n} else\r\nif (!test_and_set_bit(iscsi_err->completion_status,\r\n(void *) &bnx2i_conn->violation_notified))\r\niscsi_conn_printk(KERN_ALERT,\r\nbnx2i_conn->cls_conn->dd_data,\r\n"bnx2i: %s - %s\n",\r\nmessage, additional_notice);\r\n}\r\nstatic void bnx2i_process_conn_destroy_cmpl(struct bnx2i_hba *hba,\r\nstruct iscsi_kcqe *conn_destroy)\r\n{\r\nstruct bnx2i_endpoint *ep;\r\nep = bnx2i_find_ep_in_destroy_list(hba, conn_destroy->iscsi_conn_id);\r\nif (!ep) {\r\nprintk(KERN_ALERT "bnx2i_conn_destroy_cmpl: no pending "\r\n"offload request, unexpected complection\n");\r\nreturn;\r\n}\r\nif (hba != ep->hba) {\r\nprintk(KERN_ALERT "conn destroy- error hba mis-match\n");\r\nreturn;\r\n}\r\nif (conn_destroy->completion_status) {\r\nprintk(KERN_ALERT "conn_destroy_cmpl: op failed\n");\r\nep->state = EP_STATE_CLEANUP_FAILED;\r\n} else\r\nep->state = EP_STATE_CLEANUP_CMPL;\r\nwake_up_interruptible(&ep->ofld_wait);\r\n}\r\nstatic void bnx2i_process_ofld_cmpl(struct bnx2i_hba *hba,\r\nstruct iscsi_kcqe *ofld_kcqe)\r\n{\r\nu32 cid_addr;\r\nstruct bnx2i_endpoint *ep;\r\nu32 cid_num;\r\nep = bnx2i_find_ep_in_ofld_list(hba, ofld_kcqe->iscsi_conn_id);\r\nif (!ep) {\r\nprintk(KERN_ALERT "ofld_cmpl: no pend offload request\n");\r\nreturn;\r\n}\r\nif (hba != ep->hba) {\r\nprintk(KERN_ALERT "ofld_cmpl: error hba mis-match\n");\r\nreturn;\r\n}\r\nif (ofld_kcqe->completion_status) {\r\nep->state = EP_STATE_OFLD_FAILED;\r\nif (ofld_kcqe->completion_status ==\r\nISCSI_KCQE_COMPLETION_STATUS_CTX_ALLOC_FAILURE)\r\nprintk(KERN_ALERT "bnx2i (%s): ofld1 cmpl - unable "\r\n"to allocate iSCSI context resources\n",\r\nhba->netdev->name);\r\nelse if (ofld_kcqe->completion_status ==\r\nISCSI_KCQE_COMPLETION_STATUS_INVALID_OPCODE)\r\nprintk(KERN_ALERT "bnx2i (%s): ofld1 cmpl - invalid "\r\n"opcode\n", hba->netdev->name);\r\nelse if (ofld_kcqe->completion_status ==\r\nISCSI_KCQE_COMPLETION_STATUS_CID_BUSY)\r\nep->state = EP_STATE_OFLD_FAILED_CID_BUSY;\r\nelse\r\nprintk(KERN_ALERT "bnx2i (%s): ofld1 cmpl - invalid "\r\n"error code %d\n", hba->netdev->name,\r\nofld_kcqe->completion_status);\r\n} else {\r\nep->state = EP_STATE_OFLD_COMPL;\r\ncid_addr = ofld_kcqe->iscsi_conn_context_id;\r\ncid_num = bnx2i_get_cid_num(ep);\r\nep->ep_cid = cid_addr;\r\nep->qp.ctx_base = NULL;\r\n}\r\nwake_up_interruptible(&ep->ofld_wait);\r\n}\r\nstatic void bnx2i_indicate_kcqe(void *context, struct kcqe *kcqe[],\r\nu32 num_cqe)\r\n{\r\nstruct bnx2i_hba *hba = context;\r\nint i = 0;\r\nstruct iscsi_kcqe *ikcqe = NULL;\r\nwhile (i < num_cqe) {\r\nikcqe = (struct iscsi_kcqe *) kcqe[i++];\r\nif (ikcqe->op_code ==\r\nISCSI_KCQE_OPCODE_CQ_EVENT_NOTIFICATION)\r\nbnx2i_fastpath_notification(hba, ikcqe);\r\nelse if (ikcqe->op_code == ISCSI_KCQE_OPCODE_OFFLOAD_CONN)\r\nbnx2i_process_ofld_cmpl(hba, ikcqe);\r\nelse if (ikcqe->op_code == ISCSI_KCQE_OPCODE_UPDATE_CONN)\r\nbnx2i_process_update_conn_cmpl(hba, ikcqe);\r\nelse if (ikcqe->op_code == ISCSI_KCQE_OPCODE_INIT) {\r\nif (ikcqe->completion_status !=\r\nISCSI_KCQE_COMPLETION_STATUS_SUCCESS)\r\nbnx2i_iscsi_license_error(hba, ikcqe->\\r\ncompletion_status);\r\nelse {\r\nset_bit(ADAPTER_STATE_UP, &hba->adapter_state);\r\nbnx2i_get_link_state(hba);\r\nprintk(KERN_INFO "bnx2i [%.2x:%.2x.%.2x]: "\r\n"ISCSI_INIT passed\n",\r\n(u8)hba->pcidev->bus->number,\r\nhba->pci_devno,\r\n(u8)hba->pci_func);\r\n}\r\n} else if (ikcqe->op_code == ISCSI_KCQE_OPCODE_DESTROY_CONN)\r\nbnx2i_process_conn_destroy_cmpl(hba, ikcqe);\r\nelse if (ikcqe->op_code == ISCSI_KCQE_OPCODE_ISCSI_ERROR)\r\nbnx2i_process_iscsi_error(hba, ikcqe);\r\nelse if (ikcqe->op_code == ISCSI_KCQE_OPCODE_TCP_ERROR)\r\nbnx2i_process_tcp_error(hba, ikcqe);\r\nelse\r\nprintk(KERN_ALERT "bnx2i: unknown opcode 0x%x\n",\r\nikcqe->op_code);\r\n}\r\n}\r\nstatic void bnx2i_indicate_netevent(void *context, unsigned long event,\r\nu16 vlan_id)\r\n{\r\nstruct bnx2i_hba *hba = context;\r\nif (vlan_id != 0)\r\nreturn;\r\nswitch (event) {\r\ncase NETDEV_UP:\r\nif (!test_bit(ADAPTER_STATE_UP, &hba->adapter_state))\r\nbnx2i_send_fw_iscsi_init_msg(hba);\r\nbreak;\r\ncase NETDEV_DOWN:\r\nclear_bit(ADAPTER_STATE_GOING_DOWN, &hba->adapter_state);\r\nclear_bit(ADAPTER_STATE_UP, &hba->adapter_state);\r\nbreak;\r\ncase NETDEV_GOING_DOWN:\r\nset_bit(ADAPTER_STATE_GOING_DOWN, &hba->adapter_state);\r\niscsi_host_for_each_session(hba->shost,\r\nbnx2i_drop_session);\r\nbreak;\r\ncase NETDEV_CHANGE:\r\nbnx2i_get_link_state(hba);\r\nbreak;\r\ndefault:\r\n;\r\n}\r\n}\r\nstatic void bnx2i_cm_connect_cmpl(struct cnic_sock *cm_sk)\r\n{\r\nstruct bnx2i_endpoint *ep = (struct bnx2i_endpoint *) cm_sk->context;\r\nif (test_bit(ADAPTER_STATE_GOING_DOWN, &ep->hba->adapter_state))\r\nep->state = EP_STATE_CONNECT_FAILED;\r\nelse if (test_bit(SK_F_OFFLD_COMPLETE, &cm_sk->flags))\r\nep->state = EP_STATE_CONNECT_COMPL;\r\nelse\r\nep->state = EP_STATE_CONNECT_FAILED;\r\nwake_up_interruptible(&ep->ofld_wait);\r\n}\r\nstatic void bnx2i_cm_close_cmpl(struct cnic_sock *cm_sk)\r\n{\r\nstruct bnx2i_endpoint *ep = (struct bnx2i_endpoint *) cm_sk->context;\r\nep->state = EP_STATE_DISCONN_COMPL;\r\nwake_up_interruptible(&ep->ofld_wait);\r\n}\r\nstatic void bnx2i_cm_abort_cmpl(struct cnic_sock *cm_sk)\r\n{\r\nstruct bnx2i_endpoint *ep = (struct bnx2i_endpoint *) cm_sk->context;\r\nep->state = EP_STATE_DISCONN_COMPL;\r\nwake_up_interruptible(&ep->ofld_wait);\r\n}\r\nstatic void bnx2i_cm_remote_close(struct cnic_sock *cm_sk)\r\n{\r\nstruct bnx2i_endpoint *ep = (struct bnx2i_endpoint *) cm_sk->context;\r\nep->state = EP_STATE_TCP_FIN_RCVD;\r\nif (ep->conn)\r\nbnx2i_recovery_que_add_conn(ep->hba, ep->conn);\r\n}\r\nstatic void bnx2i_cm_remote_abort(struct cnic_sock *cm_sk)\r\n{\r\nstruct bnx2i_endpoint *ep = (struct bnx2i_endpoint *) cm_sk->context;\r\nu32 old_state = ep->state;\r\nep->state = EP_STATE_TCP_RST_RCVD;\r\nif (old_state == EP_STATE_DISCONN_START)\r\nwake_up_interruptible(&ep->ofld_wait);\r\nelse\r\nif (ep->conn)\r\nbnx2i_recovery_que_add_conn(ep->hba, ep->conn);\r\n}\r\nstatic int bnx2i_send_nl_mesg(void *context, u32 msg_type,\r\nchar *buf, u16 buflen)\r\n{\r\nstruct bnx2i_hba *hba = context;\r\nint rc;\r\nif (!hba)\r\nreturn -ENODEV;\r\nrc = iscsi_offload_mesg(hba->shost, &bnx2i_iscsi_transport,\r\nmsg_type, buf, buflen);\r\nif (rc)\r\nprintk(KERN_ALERT "bnx2i: private nl message send error\n");\r\nreturn rc;\r\n}\r\nint bnx2i_map_ep_dbell_regs(struct bnx2i_endpoint *ep)\r\n{\r\nu32 cid_num;\r\nu32 reg_off;\r\nu32 first_l4l5;\r\nu32 ctx_sz;\r\nu32 config2;\r\nresource_size_t reg_base;\r\ncid_num = bnx2i_get_cid_num(ep);\r\nif (test_bit(BNX2I_NX2_DEV_57710, &ep->hba->cnic_dev_type)) {\r\nreg_base = pci_resource_start(ep->hba->pcidev,\r\nBNX2X_DOORBELL_PCI_BAR);\r\nreg_off = BNX2I_5771X_DBELL_PAGE_SIZE * (cid_num & 0x1FFFF) +\r\nDPM_TRIGER_TYPE;\r\nep->qp.ctx_base = ioremap_nocache(reg_base + reg_off, 4);\r\ngoto arm_cq;\r\n}\r\nif ((test_bit(BNX2I_NX2_DEV_5709, &ep->hba->cnic_dev_type)) &&\r\n(ep->hba->mail_queue_access == BNX2I_MQ_BIN_MODE)) {\r\nconfig2 = REG_RD(ep->hba, BNX2_MQ_CONFIG2);\r\nfirst_l4l5 = config2 & BNX2_MQ_CONFIG2_FIRST_L4L5;\r\nctx_sz = (config2 & BNX2_MQ_CONFIG2_CONT_SZ) >> 3;\r\nif (ctx_sz)\r\nreg_off = CTX_OFFSET + MAX_CID_CNT * MB_KERNEL_CTX_SIZE\r\n+ BNX2I_570X_PAGE_SIZE_DEFAULT *\r\n(((cid_num - first_l4l5) / ctx_sz) + 256);\r\nelse\r\nreg_off = CTX_OFFSET + (MB_KERNEL_CTX_SIZE * cid_num);\r\n} else\r\nreg_off = CTX_OFFSET + (MB_KERNEL_CTX_SIZE * cid_num);\r\nep->qp.ctx_base = ioremap_nocache(ep->hba->reg_base + reg_off,\r\nMB_KERNEL_CTX_SIZE);\r\nif (!ep->qp.ctx_base)\r\nreturn -ENOMEM;\r\narm_cq:\r\nbnx2i_arm_cq_event_coalescing(ep, CNIC_ARM_CQE);\r\nreturn 0;\r\n}

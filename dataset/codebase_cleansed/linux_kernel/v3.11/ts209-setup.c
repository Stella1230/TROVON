void __init qnap_ts209_pci_preinit(void)\r\n{\r\nint pin;\r\npin = QNAP_TS209_PCI_SLOT0_IRQ_PIN;\r\nif (gpio_request(pin, "PCI Int1") == 0) {\r\nif (gpio_direction_input(pin) == 0) {\r\nirq_set_irq_type(gpio_to_irq(pin), IRQ_TYPE_LEVEL_LOW);\r\n} else {\r\nprintk(KERN_ERR "qnap_ts209_pci_preinit failed to "\r\n"set_irq_type pin %d\n", pin);\r\ngpio_free(pin);\r\n}\r\n} else {\r\nprintk(KERN_ERR "qnap_ts209_pci_preinit failed to gpio_request "\r\n"%d\n", pin);\r\n}\r\npin = QNAP_TS209_PCI_SLOT1_IRQ_PIN;\r\nif (gpio_request(pin, "PCI Int2") == 0) {\r\nif (gpio_direction_input(pin) == 0) {\r\nirq_set_irq_type(gpio_to_irq(pin), IRQ_TYPE_LEVEL_LOW);\r\n} else {\r\nprintk(KERN_ERR "qnap_ts209_pci_preinit failed "\r\n"to set_irq_type pin %d\n", pin);\r\ngpio_free(pin);\r\n}\r\n} else {\r\nprintk(KERN_ERR "qnap_ts209_pci_preinit failed to gpio_request "\r\n"%d\n", pin);\r\n}\r\n}\r\nstatic int __init qnap_ts209_pci_map_irq(const struct pci_dev *dev, u8 slot,\r\nu8 pin)\r\n{\r\nint irq;\r\nirq = orion5x_pci_map_irq(dev, slot, pin);\r\nif (irq != -1)\r\nreturn irq;\r\nswitch (slot - QNAP_TS209_PCI_SLOT0_OFFS) {\r\ncase 0:\r\nreturn gpio_to_irq(QNAP_TS209_PCI_SLOT0_IRQ_PIN);\r\ncase 1:\r\nreturn gpio_to_irq(QNAP_TS209_PCI_SLOT1_IRQ_PIN);\r\ndefault:\r\nreturn -1;\r\n}\r\n}\r\nstatic int __init qnap_ts209_pci_init(void)\r\n{\r\nif (machine_is_ts209())\r\npci_common_init(&qnap_ts209_pci);\r\nreturn 0;\r\n}\r\nstatic void __init qnap_ts209_init(void)\r\n{\r\norion5x_init();\r\norion5x_mpp_conf(ts209_mpp_modes);\r\nmvebu_mbus_add_window("devbus-boot", QNAP_TS209_NOR_BOOT_BASE,\r\nQNAP_TS209_NOR_BOOT_SIZE);\r\nplatform_device_register(&qnap_ts209_nor_flash);\r\norion5x_ehci0_init();\r\norion5x_ehci1_init();\r\nqnap_tsx09_find_mac_addr(QNAP_TS209_NOR_BOOT_BASE +\r\nqnap_ts209_partitions[5].offset,\r\nqnap_ts209_partitions[5].size);\r\norion5x_eth_init(&qnap_tsx09_eth_data);\r\norion5x_i2c_init();\r\norion5x_sata_init(&qnap_ts209_sata_data);\r\norion5x_uart0_init();\r\norion5x_uart1_init();\r\norion5x_xor_init();\r\nplatform_device_register(&qnap_ts209_button_device);\r\nif (gpio_request(TS209_RTC_GPIO, "rtc") == 0) {\r\nif (gpio_direction_input(TS209_RTC_GPIO) == 0)\r\nqnap_ts209_i2c_rtc.irq = gpio_to_irq(TS209_RTC_GPIO);\r\nelse\r\ngpio_free(TS209_RTC_GPIO);\r\n}\r\nif (qnap_ts209_i2c_rtc.irq == 0)\r\npr_warning("qnap_ts209_init: failed to get RTC IRQ\n");\r\ni2c_register_board_info(0, &qnap_ts209_i2c_rtc, 1);\r\npm_power_off = qnap_tsx09_power_off;\r\n}

static int imx_src_reset_module(struct reset_controller_dev *rcdev,\r\nunsigned long sw_reset_idx)\r\n{\r\nunsigned long timeout;\r\nunsigned long flags;\r\nint bit;\r\nu32 val;\r\nif (!src_base)\r\nreturn -ENODEV;\r\nif (sw_reset_idx >= ARRAY_SIZE(sw_reset_bits))\r\nreturn -EINVAL;\r\nbit = 1 << sw_reset_bits[sw_reset_idx];\r\nspin_lock_irqsave(&scr_lock, flags);\r\nval = readl_relaxed(src_base + SRC_SCR);\r\nval |= bit;\r\nwritel_relaxed(val, src_base + SRC_SCR);\r\nspin_unlock_irqrestore(&scr_lock, flags);\r\ntimeout = jiffies + msecs_to_jiffies(1000);\r\nwhile (readl(src_base + SRC_SCR) & bit) {\r\nif (time_after(jiffies, timeout))\r\nreturn -ETIME;\r\ncpu_relax();\r\n}\r\nreturn 0;\r\n}\r\nvoid imx_enable_cpu(int cpu, bool enable)\r\n{\r\nu32 mask, val;\r\ncpu = cpu_logical_map(cpu);\r\nmask = 1 << (BP_SRC_SCR_CORE1_ENABLE + cpu - 1);\r\nspin_lock(&scr_lock);\r\nval = readl_relaxed(src_base + SRC_SCR);\r\nval = enable ? val | mask : val & ~mask;\r\nwritel_relaxed(val, src_base + SRC_SCR);\r\nspin_unlock(&scr_lock);\r\n}\r\nvoid imx_set_cpu_jump(int cpu, void *jump_addr)\r\n{\r\ncpu = cpu_logical_map(cpu);\r\nwritel_relaxed(virt_to_phys(jump_addr),\r\nsrc_base + SRC_GPR1 + cpu * 8);\r\n}\r\nu32 imx_get_cpu_arg(int cpu)\r\n{\r\ncpu = cpu_logical_map(cpu);\r\nreturn readl_relaxed(src_base + SRC_GPR1 + cpu * 8 + 4);\r\n}\r\nvoid imx_set_cpu_arg(int cpu, u32 arg)\r\n{\r\ncpu = cpu_logical_map(cpu);\r\nwritel_relaxed(arg, src_base + SRC_GPR1 + cpu * 8 + 4);\r\n}\r\nvoid imx_src_prepare_restart(void)\r\n{\r\nu32 val;\r\nspin_lock(&scr_lock);\r\nval = readl_relaxed(src_base + SRC_SCR);\r\nval &= ~(0x7 << BP_SRC_SCR_CORE1_ENABLE);\r\nwritel_relaxed(val, src_base + SRC_SCR);\r\nspin_unlock(&scr_lock);\r\nwritel_relaxed(0, src_base + SRC_GPR1);\r\n}\r\nvoid __init imx_src_init(void)\r\n{\r\nstruct device_node *np;\r\nu32 val;\r\nnp = of_find_compatible_node(NULL, NULL, "fsl,imx51-src");\r\nif (!np)\r\nreturn;\r\nsrc_base = of_iomap(np, 0);\r\nWARN_ON(!src_base);\r\nimx_reset_controller.of_node = np;\r\nif (IS_ENABLED(CONFIG_RESET_CONTROLLER))\r\nreset_controller_register(&imx_reset_controller);\r\nspin_lock(&scr_lock);\r\nval = readl_relaxed(src_base + SRC_SCR);\r\nval &= ~(1 << BP_SRC_SCR_WARM_RESET_ENABLE);\r\nwritel_relaxed(val, src_base + SRC_SCR);\r\nspin_unlock(&scr_lock);\r\n}

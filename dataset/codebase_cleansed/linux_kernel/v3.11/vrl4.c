ssize_t do_read(int fd, void *buf, size_t count)\r\n{\r\nsize_t offset = 0;\r\nssize_t l;\r\nwhile (offset < count) {\r\nl = read(fd, buf + offset, count - offset);\r\nif (!l)\r\nbreak;\r\nif (l < 0) {\r\nif (errno == EAGAIN || errno == EWOULDBLOCK)\r\ncontinue;\r\nperror("read");\r\nreturn -1;\r\n}\r\noffset += l;\r\n}\r\nreturn offset;\r\n}\r\nssize_t do_write(int fd, const void *buf, size_t count)\r\n{\r\nsize_t offset = 0;\r\nssize_t l;\r\nwhile (offset < count) {\r\nl = write(fd, buf + offset, count - offset);\r\nif (l < 0) {\r\nif (errno == EAGAIN || errno == EWOULDBLOCK)\r\ncontinue;\r\nperror("write");\r\nreturn -1;\r\n}\r\noffset += l;\r\n}\r\nreturn offset;\r\n}\r\nssize_t write_zero(int fd, size_t len)\r\n{\r\nsize_t i = len;\r\nwhile (i--) {\r\nconst char x = 0;\r\nif (do_write(fd, &x, 1) < 0)\r\nreturn -1;\r\n}\r\nreturn len;\r\n}\r\nint main(void)\r\n{\r\nDECLARE_HDR(hdr);\r\nchar boot_program[MAX_BOOT_PROG_LEN];\r\nsize_t aligned_hdr_len, alligned_prog_len;\r\nssize_t prog_len;\r\nprog_len = do_read(0, boot_program, sizeof(boot_program));\r\nif (prog_len <= 0)\r\nreturn -1;\r\naligned_hdr_len = ROUND_UP(sizeof(hdr));\r\nhdr.start_address = htole32(START_BASE + aligned_hdr_len);\r\nalligned_prog_len = ROUND_UP(prog_len);\r\nhdr.copy_size = htole16(aligned_hdr_len + alligned_prog_len);\r\nif (do_write(1, &hdr, sizeof(hdr)) < 0)\r\nreturn -1;\r\nif (write_zero(1, aligned_hdr_len - sizeof(hdr)) < 0)\r\nreturn -1;\r\nif (do_write(1, boot_program, prog_len) < 0)\r\nreturn 1;\r\nwhile (1) {\r\nprog_len = do_read(0, boot_program, sizeof(boot_program));\r\nif (prog_len < 0)\r\nreturn 1;\r\nif (prog_len == 0)\r\nbreak;\r\nif (do_write(1, boot_program, prog_len) < 0)\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}

static char *pod_alloc_sysex_buffer(struct usb_line6_pod *pod, int code,\r\nint size)\r\n{\r\nreturn line6_alloc_sysex_buffer(&pod->line6, POD_SYSEX_CODE, code,\r\nsize);\r\n}\r\nvoid line6_pod_process_message(struct usb_line6_pod *pod)\r\n{\r\nconst unsigned char *buf = pod->line6.buffer_message;\r\nif (memcmp(buf, pod_version_header, sizeof(pod_version_header)) == 0) {\r\npod->firmware_version = buf[13] * 100 + buf[14] * 10 + buf[15];\r\npod->device_id = ((int)buf[8] << 16) | ((int)buf[9] << 8) |\r\n(int) buf[10];\r\npod_startup3(pod);\r\nreturn;\r\n}\r\nif (buf[0] != (LINE6_SYSEX_BEGIN | LINE6_CHANNEL_DEVICE) &&\r\nbuf[0] != (LINE6_SYSEX_BEGIN | LINE6_CHANNEL_UNKNOWN)) {\r\nreturn;\r\n}\r\nif (memcmp(buf + 1, line6_midi_id, sizeof(line6_midi_id)) != 0)\r\nreturn;\r\nif (buf[5] == POD_SYSEX_SYSTEM && buf[6] == POD_MONITOR_LEVEL) {\r\nshort value = ((int)buf[7] << 12) | ((int)buf[8] << 8) |\r\n((int)buf[9] << 4) | (int)buf[10];\r\npod->monitor_level = value;\r\n}\r\n}\r\nvoid line6_pod_transmit_parameter(struct usb_line6_pod *pod, int param,\r\nu8 value)\r\n{\r\nline6_transmit_parameter(&pod->line6, param, value);\r\n}\r\nstatic int pod_set_system_param_int(struct usb_line6_pod *pod, int value,\r\nint code)\r\n{\r\nchar *sysex;\r\nstatic const int size = 5;\r\nsysex = pod_alloc_sysex_buffer(pod, POD_SYSEX_SYSTEM, size);\r\nif (!sysex)\r\nreturn -ENOMEM;\r\nsysex[SYSEX_DATA_OFS] = code;\r\nsysex[SYSEX_DATA_OFS + 1] = (value >> 12) & 0x0f;\r\nsysex[SYSEX_DATA_OFS + 2] = (value >> 8) & 0x0f;\r\nsysex[SYSEX_DATA_OFS + 3] = (value >> 4) & 0x0f;\r\nsysex[SYSEX_DATA_OFS + 4] = (value) & 0x0f;\r\nline6_send_sysex_message(&pod->line6, sysex, size);\r\nkfree(sysex);\r\nreturn 0;\r\n}\r\nstatic ssize_t pod_get_serial_number(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct usb_interface *interface = to_usb_interface(dev);\r\nstruct usb_line6_pod *pod = usb_get_intfdata(interface);\r\nreturn sprintf(buf, "%d\n", pod->serial_number);\r\n}\r\nstatic ssize_t pod_get_firmware_version(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct usb_interface *interface = to_usb_interface(dev);\r\nstruct usb_line6_pod *pod = usb_get_intfdata(interface);\r\nreturn sprintf(buf, "%d.%02d\n", pod->firmware_version / 100,\r\npod->firmware_version % 100);\r\n}\r\nstatic ssize_t pod_get_device_id(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct usb_interface *interface = to_usb_interface(dev);\r\nstruct usb_line6_pod *pod = usb_get_intfdata(interface);\r\nreturn sprintf(buf, "%d\n", pod->device_id);\r\n}\r\nstatic void pod_startup1(struct usb_line6_pod *pod)\r\n{\r\nCHECK_STARTUP_PROGRESS(pod->startup_progress, POD_STARTUP_INIT);\r\nline6_start_timer(&pod->startup_timer, POD_STARTUP_DELAY, pod_startup2,\r\n(unsigned long)pod);\r\n}\r\nstatic void pod_startup2(unsigned long data)\r\n{\r\nstruct usb_line6_pod *pod = (struct usb_line6_pod *)data;\r\nstruct usb_line6 *line6 = &pod->line6;\r\nCHECK_STARTUP_PROGRESS(pod->startup_progress, POD_STARTUP_VERSIONREQ);\r\nline6_version_request_async(line6);\r\n}\r\nstatic void pod_startup3(struct usb_line6_pod *pod)\r\n{\r\nCHECK_STARTUP_PROGRESS(pod->startup_progress, POD_STARTUP_WORKQUEUE);\r\nschedule_work(&pod->startup_work);\r\n}\r\nstatic void pod_startup4(struct work_struct *work)\r\n{\r\nstruct usb_line6_pod *pod =\r\ncontainer_of(work, struct usb_line6_pod, startup_work);\r\nstruct usb_line6 *line6 = &pod->line6;\r\nCHECK_STARTUP_PROGRESS(pod->startup_progress, POD_STARTUP_SETUP);\r\nline6_read_serial_number(&pod->line6, &pod->serial_number);\r\nline6_register_audio(line6);\r\n}\r\nstatic int snd_pod_control_monitor_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\r\nuinfo->count = 1;\r\nuinfo->value.integer.min = 0;\r\nuinfo->value.integer.max = 65535;\r\nreturn 0;\r\n}\r\nstatic int snd_pod_control_monitor_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_line6_pcm *line6pcm = snd_kcontrol_chip(kcontrol);\r\nstruct usb_line6_pod *pod = (struct usb_line6_pod *)line6pcm->line6;\r\nucontrol->value.integer.value[0] = pod->monitor_level;\r\nreturn 0;\r\n}\r\nstatic int snd_pod_control_monitor_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_line6_pcm *line6pcm = snd_kcontrol_chip(kcontrol);\r\nstruct usb_line6_pod *pod = (struct usb_line6_pod *)line6pcm->line6;\r\nif (ucontrol->value.integer.value[0] == pod->monitor_level)\r\nreturn 0;\r\npod->monitor_level = ucontrol->value.integer.value[0];\r\npod_set_system_param_int(pod, ucontrol->value.integer.value[0],\r\nPOD_MONITOR_LEVEL);\r\nreturn 1;\r\n}\r\nstatic void pod_destruct(struct usb_interface *interface)\r\n{\r\nstruct usb_line6_pod *pod = usb_get_intfdata(interface);\r\nif (pod == NULL)\r\nreturn;\r\nline6_cleanup_audio(&pod->line6);\r\ndel_timer(&pod->startup_timer);\r\ncancel_work_sync(&pod->startup_work);\r\n}\r\nstatic int pod_create_files2(struct device *dev)\r\n{\r\nint err;\r\nCHECK_RETURN(device_create_file(dev, &dev_attr_device_id));\r\nCHECK_RETURN(device_create_file(dev, &dev_attr_firmware_version));\r\nCHECK_RETURN(device_create_file(dev, &dev_attr_serial_number));\r\nreturn 0;\r\n}\r\nstatic int pod_try_init(struct usb_interface *interface,\r\nstruct usb_line6_pod *pod)\r\n{\r\nint err;\r\nstruct usb_line6 *line6 = &pod->line6;\r\ninit_timer(&pod->startup_timer);\r\nINIT_WORK(&pod->startup_work, pod_startup4);\r\nif ((interface == NULL) || (pod == NULL))\r\nreturn -ENODEV;\r\nerr = pod_create_files2(&interface->dev);\r\nif (err < 0)\r\nreturn err;\r\nerr = line6_init_audio(line6);\r\nif (err < 0)\r\nreturn err;\r\nerr = line6_init_midi(line6);\r\nif (err < 0)\r\nreturn err;\r\nerr = line6_init_pcm(line6, &pod_pcm_properties);\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_ctl_add(line6->card,\r\nsnd_ctl_new1(&pod_control_monitor, line6->line6pcm));\r\nif (err < 0)\r\nreturn err;\r\nif (pod->line6.properties->capabilities & LINE6_BIT_CONTROL) {\r\npod->monitor_level = POD_SYSTEM_INVALID;\r\npod_startup1(pod);\r\n}\r\nreturn 0;\r\n}\r\nint line6_pod_init(struct usb_interface *interface, struct usb_line6_pod *pod)\r\n{\r\nint err = pod_try_init(interface, pod);\r\nif (err < 0)\r\npod_destruct(interface);\r\nreturn err;\r\n}\r\nvoid line6_pod_disconnect(struct usb_interface *interface)\r\n{\r\nstruct usb_line6_pod *pod;\r\nif (interface == NULL)\r\nreturn;\r\npod = usb_get_intfdata(interface);\r\nif (pod != NULL) {\r\nstruct snd_line6_pcm *line6pcm = pod->line6.line6pcm;\r\nstruct device *dev = &interface->dev;\r\nif (line6pcm != NULL)\r\nline6_pcm_disconnect(line6pcm);\r\nif (dev != NULL) {\r\ndevice_remove_file(dev, &dev_attr_device_id);\r\ndevice_remove_file(dev, &dev_attr_firmware_version);\r\ndevice_remove_file(dev, &dev_attr_serial_number);\r\n}\r\n}\r\npod_destruct(interface);\r\n}

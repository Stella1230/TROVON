static struct dm_cache_policy_type *__find_policy(const char *name)\r\n{\r\nstruct dm_cache_policy_type *t;\r\nlist_for_each_entry(t, &register_list, list)\r\nif (!strcmp(t->name, name))\r\nreturn t;\r\nreturn NULL;\r\n}\r\nstatic struct dm_cache_policy_type *__get_policy_once(const char *name)\r\n{\r\nstruct dm_cache_policy_type *t = __find_policy(name);\r\nif (t && !try_module_get(t->owner)) {\r\nDMWARN("couldn't get module %s", name);\r\nt = ERR_PTR(-EINVAL);\r\n}\r\nreturn t;\r\n}\r\nstatic struct dm_cache_policy_type *get_policy_once(const char *name)\r\n{\r\nstruct dm_cache_policy_type *t;\r\nspin_lock(&register_lock);\r\nt = __get_policy_once(name);\r\nspin_unlock(&register_lock);\r\nreturn t;\r\n}\r\nstatic struct dm_cache_policy_type *get_policy(const char *name)\r\n{\r\nstruct dm_cache_policy_type *t;\r\nt = get_policy_once(name);\r\nif (IS_ERR(t))\r\nreturn NULL;\r\nif (t)\r\nreturn t;\r\nrequest_module("dm-cache-%s", name);\r\nt = get_policy_once(name);\r\nif (IS_ERR(t))\r\nreturn NULL;\r\nreturn t;\r\n}\r\nstatic void put_policy(struct dm_cache_policy_type *t)\r\n{\r\nmodule_put(t->owner);\r\n}\r\nint dm_cache_policy_register(struct dm_cache_policy_type *type)\r\n{\r\nint r;\r\nif (type->hint_size != 0 && type->hint_size != 4) {\r\nDMWARN("hint size must be 0 or 4 but %llu supplied.", (unsigned long long) type->hint_size);\r\nreturn -EINVAL;\r\n}\r\nspin_lock(&register_lock);\r\nif (__find_policy(type->name)) {\r\nDMWARN("attempt to register policy under duplicate name %s", type->name);\r\nr = -EINVAL;\r\n} else {\r\nlist_add(&type->list, &register_list);\r\nr = 0;\r\n}\r\nspin_unlock(&register_lock);\r\nreturn r;\r\n}\r\nvoid dm_cache_policy_unregister(struct dm_cache_policy_type *type)\r\n{\r\nspin_lock(&register_lock);\r\nlist_del_init(&type->list);\r\nspin_unlock(&register_lock);\r\n}\r\nstruct dm_cache_policy *dm_cache_policy_create(const char *name,\r\ndm_cblock_t cache_size,\r\nsector_t origin_size,\r\nsector_t cache_block_size)\r\n{\r\nstruct dm_cache_policy *p = NULL;\r\nstruct dm_cache_policy_type *type;\r\ntype = get_policy(name);\r\nif (!type) {\r\nDMWARN("unknown policy type");\r\nreturn NULL;\r\n}\r\np = type->create(cache_size, origin_size, cache_block_size);\r\nif (!p) {\r\nput_policy(type);\r\nreturn NULL;\r\n}\r\np->private = type;\r\nreturn p;\r\n}\r\nvoid dm_cache_policy_destroy(struct dm_cache_policy *p)\r\n{\r\nstruct dm_cache_policy_type *t = p->private;\r\np->destroy(p);\r\nput_policy(t);\r\n}\r\nconst char *dm_cache_policy_get_name(struct dm_cache_policy *p)\r\n{\r\nstruct dm_cache_policy_type *t = p->private;\r\nreturn t->name;\r\n}\r\nconst unsigned *dm_cache_policy_get_version(struct dm_cache_policy *p)\r\n{\r\nstruct dm_cache_policy_type *t = p->private;\r\nreturn t->version;\r\n}\r\nsize_t dm_cache_policy_get_hint_size(struct dm_cache_policy *p)\r\n{\r\nstruct dm_cache_policy_type *t = p->private;\r\nreturn t->hint_size;\r\n}

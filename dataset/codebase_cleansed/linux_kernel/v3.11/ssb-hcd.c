static void ssb_hcd_5354wa(struct ssb_device *dev)\r\n{\r\n#ifdef CONFIG_SSB_DRIVER_MIPS\r\nif (dev->id.revision == 2 && dev->bus->chip_id == 0x5354) {\r\nssb_write32(dev, 0x894, 0x00fe00fe);\r\nssb_write32(dev, 0x89c, ssb_read32(dev, 0x89c) | 0x1);\r\n}\r\n#endif\r\n}\r\nstatic void ssb_hcd_usb20wa(struct ssb_device *dev)\r\n{\r\nif (dev->id.coreid == SSB_DEV_USB20_HOST) {\r\nssb_write32(dev, 0x200, 0x7ff);\r\nssb_write32(dev, 0x400, ssb_read32(dev, 0x400) & ~8);\r\nssb_read32(dev, 0x400);\r\nssb_write32(dev, 0x304, ssb_read32(dev, 0x304) & ~0x100);\r\nssb_read32(dev, 0x304);\r\nudelay(1);\r\nssb_hcd_5354wa(dev);\r\n}\r\n}\r\nstatic u32 ssb_hcd_init_chip(struct ssb_device *dev)\r\n{\r\nu32 flags = 0;\r\nif (dev->id.coreid == SSB_DEV_USB11_HOSTDEV)\r\nflags |= SSB_HCD_TMSLOW_HOSTMODE;\r\nssb_device_enable(dev, flags);\r\nssb_hcd_usb20wa(dev);\r\nreturn flags;\r\n}\r\nstatic struct platform_device *ssb_hcd_create_pdev(struct ssb_device *dev, bool ohci, u32 addr, u32 len)\r\n{\r\nstruct platform_device *hci_dev;\r\nstruct resource hci_res[2];\r\nint ret = -ENOMEM;\r\nmemset(hci_res, 0, sizeof(hci_res));\r\nhci_res[0].start = addr;\r\nhci_res[0].end = hci_res[0].start + len - 1;\r\nhci_res[0].flags = IORESOURCE_MEM;\r\nhci_res[1].start = dev->irq;\r\nhci_res[1].flags = IORESOURCE_IRQ;\r\nhci_dev = platform_device_alloc(ohci ? "ohci-platform" :\r\n"ehci-platform" , 0);\r\nif (!hci_dev)\r\nreturn NULL;\r\nhci_dev->dev.parent = dev->dev;\r\nhci_dev->dev.dma_mask = &hci_dev->dev.coherent_dma_mask;\r\nret = platform_device_add_resources(hci_dev, hci_res,\r\nARRAY_SIZE(hci_res));\r\nif (ret)\r\ngoto err_alloc;\r\nif (ohci)\r\nret = platform_device_add_data(hci_dev, &ohci_pdata,\r\nsizeof(ohci_pdata));\r\nelse\r\nret = platform_device_add_data(hci_dev, &ehci_pdata,\r\nsizeof(ehci_pdata));\r\nif (ret)\r\ngoto err_alloc;\r\nret = platform_device_add(hci_dev);\r\nif (ret)\r\ngoto err_alloc;\r\nreturn hci_dev;\r\nerr_alloc:\r\nplatform_device_put(hci_dev);\r\nreturn ERR_PTR(ret);\r\n}\r\nstatic int ssb_hcd_probe(struct ssb_device *dev,\r\nconst struct ssb_device_id *id)\r\n{\r\nint err, tmp;\r\nint start, len;\r\nu16 chipid_top;\r\nu16 coreid = dev->id.coreid;\r\nstruct ssb_hcd_device *usb_dev;\r\nchipid_top = (dev->bus->chip_id & 0xFF00);\r\nif (chipid_top != 0x4700 && chipid_top != 0x5300)\r\nreturn -ENODEV;\r\nif (dma_set_mask(dev->dma_dev, DMA_BIT_MASK(32)) ||\r\ndma_set_coherent_mask(dev->dma_dev, DMA_BIT_MASK(32)))\r\nreturn -EOPNOTSUPP;\r\nusb_dev = kzalloc(sizeof(struct ssb_hcd_device), GFP_KERNEL);\r\nif (!usb_dev)\r\nreturn -ENOMEM;\r\nusb_dev->enable_flags = ssb_hcd_init_chip(dev);\r\ntmp = ssb_read32(dev, SSB_ADMATCH0);\r\nstart = ssb_admatch_base(tmp);\r\nlen = (coreid == SSB_DEV_USB20_HOST) ? 0x800 : ssb_admatch_size(tmp);\r\nusb_dev->ohci_dev = ssb_hcd_create_pdev(dev, true, start, len);\r\nif (IS_ERR(usb_dev->ohci_dev)) {\r\nerr = PTR_ERR(usb_dev->ohci_dev);\r\ngoto err_free_usb_dev;\r\n}\r\nif (coreid == SSB_DEV_USB20_HOST) {\r\nstart = ssb_admatch_base(tmp) + 0x800;\r\nusb_dev->ehci_dev = ssb_hcd_create_pdev(dev, false, start, len);\r\nif (IS_ERR(usb_dev->ehci_dev)) {\r\nerr = PTR_ERR(usb_dev->ehci_dev);\r\ngoto err_unregister_ohci_dev;\r\n}\r\n}\r\nssb_set_drvdata(dev, usb_dev);\r\nreturn 0;\r\nerr_unregister_ohci_dev:\r\nplatform_device_unregister(usb_dev->ohci_dev);\r\nerr_free_usb_dev:\r\nkfree(usb_dev);\r\nreturn err;\r\n}\r\nstatic void ssb_hcd_remove(struct ssb_device *dev)\r\n{\r\nstruct ssb_hcd_device *usb_dev = ssb_get_drvdata(dev);\r\nstruct platform_device *ohci_dev = usb_dev->ohci_dev;\r\nstruct platform_device *ehci_dev = usb_dev->ehci_dev;\r\nif (ohci_dev)\r\nplatform_device_unregister(ohci_dev);\r\nif (ehci_dev)\r\nplatform_device_unregister(ehci_dev);\r\nssb_device_disable(dev, 0);\r\n}\r\nstatic void ssb_hcd_shutdown(struct ssb_device *dev)\r\n{\r\nssb_device_disable(dev, 0);\r\n}\r\nstatic int ssb_hcd_suspend(struct ssb_device *dev, pm_message_t state)\r\n{\r\nssb_device_disable(dev, 0);\r\nreturn 0;\r\n}\r\nstatic int ssb_hcd_resume(struct ssb_device *dev)\r\n{\r\nstruct ssb_hcd_device *usb_dev = ssb_get_drvdata(dev);\r\nssb_device_enable(dev, usb_dev->enable_flags);\r\nreturn 0;\r\n}\r\nstatic int __init ssb_hcd_init(void)\r\n{\r\nreturn ssb_driver_register(&ssb_hcd_driver);\r\n}\r\nstatic void __exit ssb_hcd_exit(void)\r\n{\r\nssb_driver_unregister(&ssb_hcd_driver);\r\n}

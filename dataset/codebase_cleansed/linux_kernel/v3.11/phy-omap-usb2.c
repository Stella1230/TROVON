int omap_usb2_set_comparator(struct phy_companion *comparator)\r\n{\r\nstruct omap_usb *phy;\r\nstruct usb_phy *x = usb_get_phy(USB_PHY_TYPE_USB2);\r\nif (IS_ERR(x))\r\nreturn -ENODEV;\r\nphy = phy_to_omapusb(x);\r\nphy->comparator = comparator;\r\nreturn 0;\r\n}\r\nstatic int omap_usb_set_vbus(struct usb_otg *otg, bool enabled)\r\n{\r\nstruct omap_usb *phy = phy_to_omapusb(otg->phy);\r\nif (!phy->comparator)\r\nreturn -ENODEV;\r\nreturn phy->comparator->set_vbus(phy->comparator, enabled);\r\n}\r\nstatic int omap_usb_start_srp(struct usb_otg *otg)\r\n{\r\nstruct omap_usb *phy = phy_to_omapusb(otg->phy);\r\nif (!phy->comparator)\r\nreturn -ENODEV;\r\nreturn phy->comparator->start_srp(phy->comparator);\r\n}\r\nstatic int omap_usb_set_host(struct usb_otg *otg, struct usb_bus *host)\r\n{\r\nstruct usb_phy *phy = otg->phy;\r\notg->host = host;\r\nif (!host)\r\nphy->state = OTG_STATE_UNDEFINED;\r\nreturn 0;\r\n}\r\nstatic int omap_usb_set_peripheral(struct usb_otg *otg,\r\nstruct usb_gadget *gadget)\r\n{\r\nstruct usb_phy *phy = otg->phy;\r\notg->gadget = gadget;\r\nif (!gadget)\r\nphy->state = OTG_STATE_UNDEFINED;\r\nreturn 0;\r\n}\r\nstatic int omap_usb2_suspend(struct usb_phy *x, int suspend)\r\n{\r\nu32 ret;\r\nstruct omap_usb *phy = phy_to_omapusb(x);\r\nif (suspend && !phy->is_suspended) {\r\nomap_control_usb_phy_power(phy->control_dev, 0);\r\npm_runtime_put_sync(phy->dev);\r\nphy->is_suspended = 1;\r\n} else if (!suspend && phy->is_suspended) {\r\nret = pm_runtime_get_sync(phy->dev);\r\nif (ret < 0) {\r\ndev_err(phy->dev, "get_sync failed with err %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nomap_control_usb_phy_power(phy->control_dev, 1);\r\nphy->is_suspended = 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int omap_usb2_probe(struct platform_device *pdev)\r\n{\r\nstruct omap_usb *phy;\r\nstruct usb_otg *otg;\r\nphy = devm_kzalloc(&pdev->dev, sizeof(*phy), GFP_KERNEL);\r\nif (!phy) {\r\ndev_err(&pdev->dev, "unable to allocate memory for USB2 PHY\n");\r\nreturn -ENOMEM;\r\n}\r\notg = devm_kzalloc(&pdev->dev, sizeof(*otg), GFP_KERNEL);\r\nif (!otg) {\r\ndev_err(&pdev->dev, "unable to allocate memory for USB OTG\n");\r\nreturn -ENOMEM;\r\n}\r\nphy->dev = &pdev->dev;\r\nphy->phy.dev = phy->dev;\r\nphy->phy.label = "omap-usb2";\r\nphy->phy.set_suspend = omap_usb2_suspend;\r\nphy->phy.otg = otg;\r\nphy->phy.type = USB_PHY_TYPE_USB2;\r\nphy->control_dev = omap_get_control_dev();\r\nif (IS_ERR(phy->control_dev)) {\r\ndev_dbg(&pdev->dev, "Failed to get control device\n");\r\nreturn -ENODEV;\r\n}\r\nphy->is_suspended = 1;\r\nomap_control_usb_phy_power(phy->control_dev, 0);\r\notg->set_host = omap_usb_set_host;\r\notg->set_peripheral = omap_usb_set_peripheral;\r\notg->set_vbus = omap_usb_set_vbus;\r\notg->start_srp = omap_usb_start_srp;\r\notg->phy = &phy->phy;\r\nphy->wkupclk = devm_clk_get(phy->dev, "usb_phy_cm_clk32k");\r\nif (IS_ERR(phy->wkupclk)) {\r\ndev_err(&pdev->dev, "unable to get usb_phy_cm_clk32k\n");\r\nreturn PTR_ERR(phy->wkupclk);\r\n}\r\nclk_prepare(phy->wkupclk);\r\nphy->optclk = devm_clk_get(phy->dev, "usb_otg_ss_refclk960m");\r\nif (IS_ERR(phy->optclk))\r\ndev_vdbg(&pdev->dev, "unable to get refclk960m\n");\r\nelse\r\nclk_prepare(phy->optclk);\r\nusb_add_phy_dev(&phy->phy);\r\nplatform_set_drvdata(pdev, phy);\r\npm_runtime_enable(phy->dev);\r\nreturn 0;\r\n}\r\nstatic int omap_usb2_remove(struct platform_device *pdev)\r\n{\r\nstruct omap_usb *phy = platform_get_drvdata(pdev);\r\nclk_unprepare(phy->wkupclk);\r\nif (!IS_ERR(phy->optclk))\r\nclk_unprepare(phy->optclk);\r\nusb_remove_phy(&phy->phy);\r\nreturn 0;\r\n}\r\nstatic int omap_usb2_runtime_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct omap_usb *phy = platform_get_drvdata(pdev);\r\nclk_disable(phy->wkupclk);\r\nif (!IS_ERR(phy->optclk))\r\nclk_disable(phy->optclk);\r\nreturn 0;\r\n}\r\nstatic int omap_usb2_runtime_resume(struct device *dev)\r\n{\r\nu32 ret = 0;\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct omap_usb *phy = platform_get_drvdata(pdev);\r\nret = clk_enable(phy->wkupclk);\r\nif (ret < 0) {\r\ndev_err(phy->dev, "Failed to enable wkupclk %d\n", ret);\r\ngoto err0;\r\n}\r\nif (!IS_ERR(phy->optclk)) {\r\nret = clk_enable(phy->optclk);\r\nif (ret < 0) {\r\ndev_err(phy->dev, "Failed to enable optclk %d\n", ret);\r\ngoto err1;\r\n}\r\n}\r\nreturn 0;\r\nerr1:\r\nclk_disable(phy->wkupclk);\r\nerr0:\r\nreturn ret;\r\n}

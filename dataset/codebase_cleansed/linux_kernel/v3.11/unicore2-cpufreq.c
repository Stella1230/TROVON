int ucv2_verify_speed(struct cpufreq_policy *policy)\r\n{\r\nif (policy->cpu)\r\nreturn -EINVAL;\r\ncpufreq_verify_within_limits(policy,\r\npolicy->cpuinfo.min_freq, policy->cpuinfo.max_freq);\r\nreturn 0;\r\n}\r\nstatic unsigned int ucv2_getspeed(unsigned int cpu)\r\n{\r\nstruct clk *mclk = clk_get(NULL, "MAIN_CLK");\r\nif (cpu)\r\nreturn 0;\r\nreturn clk_get_rate(mclk)/1000;\r\n}\r\nstatic int ucv2_target(struct cpufreq_policy *policy,\r\nunsigned int target_freq,\r\nunsigned int relation)\r\n{\r\nunsigned int cur = ucv2_getspeed(0);\r\nstruct cpufreq_freqs freqs;\r\nstruct clk *mclk = clk_get(NULL, "MAIN_CLK");\r\ncpufreq_notify_transition(policy, &freqs, CPUFREQ_PRECHANGE);\r\nif (!clk_set_rate(mclk, target_freq * 1000)) {\r\nfreqs.old = cur;\r\nfreqs.new = target_freq;\r\n}\r\ncpufreq_notify_transition(policy, &freqs, CPUFREQ_POSTCHANGE);\r\nreturn 0;\r\n}\r\nstatic int __init ucv2_cpu_init(struct cpufreq_policy *policy)\r\n{\r\nif (policy->cpu != 0)\r\nreturn -EINVAL;\r\npolicy->cur = ucv2_getspeed(0);\r\npolicy->min = policy->cpuinfo.min_freq = 250000;\r\npolicy->max = policy->cpuinfo.max_freq = 1000000;\r\npolicy->cpuinfo.transition_latency = CPUFREQ_ETERNAL;\r\nreturn 0;\r\n}\r\nstatic int __init ucv2_cpufreq_init(void)\r\n{\r\nreturn cpufreq_register_driver(&ucv2_driver);\r\n}

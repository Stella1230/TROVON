static ssize_t ade7854_read_8bit(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nint ret;\r\nu8 val = 0;\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7854_state *st = iio_priv(indio_dev);\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nret = st->read_reg_8(dev, this_attr->address, &val);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, "%u\n", val);\r\n}\r\nstatic ssize_t ade7854_read_16bit(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nint ret;\r\nu16 val = 0;\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7854_state *st = iio_priv(indio_dev);\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nret = st->read_reg_16(dev, this_attr->address, &val);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, "%u\n", val);\r\n}\r\nstatic ssize_t ade7854_read_24bit(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nint ret;\r\nu32 val;\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7854_state *st = iio_priv(indio_dev);\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nret = st->read_reg_24(dev, this_attr->address, &val);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, "%u\n", val);\r\n}\r\nstatic ssize_t ade7854_read_32bit(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nint ret;\r\nu32 val = 0;\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7854_state *st = iio_priv(indio_dev);\r\nret = st->read_reg_32(dev, this_attr->address, &val);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, "%u\n", val);\r\n}\r\nstatic ssize_t ade7854_write_8bit(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7854_state *st = iio_priv(indio_dev);\r\nint ret;\r\nlong val;\r\nret = strict_strtol(buf, 10, &val);\r\nif (ret)\r\ngoto error_ret;\r\nret = st->write_reg_8(dev, this_attr->address, val);\r\nerror_ret:\r\nreturn ret ? ret : len;\r\n}\r\nstatic ssize_t ade7854_write_16bit(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7854_state *st = iio_priv(indio_dev);\r\nint ret;\r\nlong val;\r\nret = strict_strtol(buf, 10, &val);\r\nif (ret)\r\ngoto error_ret;\r\nret = st->write_reg_16(dev, this_attr->address, val);\r\nerror_ret:\r\nreturn ret ? ret : len;\r\n}\r\nstatic ssize_t ade7854_write_24bit(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7854_state *st = iio_priv(indio_dev);\r\nint ret;\r\nlong val;\r\nret = strict_strtol(buf, 10, &val);\r\nif (ret)\r\ngoto error_ret;\r\nret = st->write_reg_24(dev, this_attr->address, val);\r\nerror_ret:\r\nreturn ret ? ret : len;\r\n}\r\nstatic ssize_t ade7854_write_32bit(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7854_state *st = iio_priv(indio_dev);\r\nint ret;\r\nlong val;\r\nret = strict_strtol(buf, 10, &val);\r\nif (ret)\r\ngoto error_ret;\r\nret = st->write_reg_32(dev, this_attr->address, val);\r\nerror_ret:\r\nreturn ret ? ret : len;\r\n}\r\nstatic int ade7854_reset(struct device *dev)\r\n{\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7854_state *st = iio_priv(indio_dev);\r\nu16 val;\r\nst->read_reg_16(dev, ADE7854_CONFIG, &val);\r\nval |= 1 << 7;\r\nreturn st->write_reg_16(dev, ADE7854_CONFIG, val);\r\n}\r\nstatic ssize_t ade7854_write_reset(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nif (len < 1)\r\nreturn -1;\r\nswitch (buf[0]) {\r\ncase '1':\r\ncase 'y':\r\ncase 'Y':\r\nreturn ade7854_reset(dev);\r\n}\r\nreturn -1;\r\n}\r\nstatic int ade7854_set_irq(struct device *dev, bool enable)\r\n{\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7854_state *st = iio_priv(indio_dev);\r\nint ret;\r\nu32 irqen;\r\nret = st->read_reg_32(dev, ADE7854_MASK0, &irqen);\r\nif (ret)\r\ngoto error_ret;\r\nif (enable)\r\nirqen |= 1 << 17;\r\nelse\r\nirqen &= ~(1 << 17);\r\nret = st->write_reg_32(dev, ADE7854_MASK0, irqen);\r\nif (ret)\r\ngoto error_ret;\r\nerror_ret:\r\nreturn ret;\r\n}\r\nstatic int ade7854_initial_setup(struct iio_dev *indio_dev)\r\n{\r\nint ret;\r\nstruct device *dev = &indio_dev->dev;\r\nret = ade7854_set_irq(dev, false);\r\nif (ret) {\r\ndev_err(dev, "disable irq failed");\r\ngoto err_ret;\r\n}\r\nade7854_reset(dev);\r\nmsleep(ADE7854_STARTUP_DELAY);\r\nerr_ret:\r\nreturn ret;\r\n}\r\nint ade7854_probe(struct iio_dev *indio_dev, struct device *dev)\r\n{\r\nint ret;\r\nstruct ade7854_state *st = iio_priv(indio_dev);\r\nmutex_init(&st->buf_lock);\r\nindio_dev->dev.parent = dev;\r\nindio_dev->info = &ade7854_info;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nret = iio_device_register(indio_dev);\r\nif (ret)\r\ngoto error_free_dev;\r\nret = ade7854_initial_setup(indio_dev);\r\nif (ret)\r\ngoto error_unreg_dev;\r\nreturn 0;\r\nerror_unreg_dev:\r\niio_device_unregister(indio_dev);\r\nerror_free_dev:\r\niio_device_free(indio_dev);\r\nreturn ret;\r\n}\r\nint ade7854_remove(struct iio_dev *indio_dev)\r\n{\r\niio_device_unregister(indio_dev);\r\niio_device_free(indio_dev);\r\nreturn 0;\r\n}

static int cx23885_start_audio_dma(struct cx23885_audio_dev *chip)\r\n{\r\nstruct cx23885_audio_buffer *buf = chip->buf;\r\nstruct cx23885_dev *dev = chip->dev;\r\nstruct sram_channel *audio_ch =\r\n&dev->sram_channels[AUDIO_SRAM_CHANNEL];\r\ndprintk(1, "%s()\n", __func__);\r\ncx_clear(AUD_INT_DMA_CTL, 0x11);\r\ncx23885_sram_channel_setup(chip->dev, audio_ch, buf->bpl,\r\nbuf->risc.dma);\r\ncx_write(AUD_INT_A_LNGTH, buf->bpl);\r\ncx_write(AUD_INT_A_MODE, 1);\r\ncx_write(AUD_INT_A_GPCNT_CTL, GP_COUNT_CONTROL_RESET);\r\natomic_set(&chip->count, 0);\r\ndprintk(1, "Start audio DMA, %d B/line, %d lines/FIFO, %d periods, %d "\r\n"byte buffer\n", buf->bpl, cx_read(audio_ch->cmds_start+12)>>1,\r\nchip->num_periods, buf->bpl * chip->num_periods);\r\ncx_write(AUDIO_INT_INT_MSK, AUD_INT_OPC_ERR | AUD_INT_DN_SYNC |\r\nAUD_INT_DN_RISCI1);\r\ncx_write(AUDIO_INT_INT_STAT, ~0);\r\ncx_set(PCI_INT_MSK, chip->dev->pci_irqmask | PCI_MSK_AUD_INT);\r\ncx_set(DEV_CNTRL2, (1<<5));\r\ncx_set(AUD_INT_DMA_CTL, 0x11);\r\nif (audio_debug)\r\ncx23885_sram_channel_dump(chip->dev, audio_ch);\r\nreturn 0;\r\n}\r\nstatic int cx23885_stop_audio_dma(struct cx23885_audio_dev *chip)\r\n{\r\nstruct cx23885_dev *dev = chip->dev;\r\ndprintk(1, "Stopping audio DMA\n");\r\ncx_clear(AUD_INT_DMA_CTL, 0x11);\r\ncx_clear(PCI_INT_MSK, PCI_MSK_AUD_INT);\r\ncx_clear(AUDIO_INT_INT_MSK, AUD_INT_OPC_ERR | AUD_INT_DN_SYNC |\r\nAUD_INT_DN_RISCI1);\r\nif (audio_debug)\r\ncx23885_sram_channel_dump(chip->dev,\r\n&dev->sram_channels[AUDIO_SRAM_CHANNEL]);\r\nreturn 0;\r\n}\r\nint cx23885_audio_irq(struct cx23885_dev *dev, u32 status, u32 mask)\r\n{\r\nstruct cx23885_audio_dev *chip = dev->audio_dev;\r\nif (0 == (status & mask))\r\nreturn 0;\r\ncx_write(AUDIO_INT_INT_STAT, status);\r\nif (status & AUD_INT_OPC_ERR) {\r\nprintk(KERN_WARNING "%s/1: Audio risc op code error\n",\r\ndev->name);\r\ncx_clear(AUD_INT_DMA_CTL, 0x11);\r\ncx23885_sram_channel_dump(dev,\r\n&dev->sram_channels[AUDIO_SRAM_CHANNEL]);\r\n}\r\nif (status & AUD_INT_DN_SYNC) {\r\ndprintk(1, "Downstream sync error\n");\r\ncx_write(AUD_INT_A_GPCNT_CTL, GP_COUNT_CONTROL_RESET);\r\nreturn 1;\r\n}\r\nif (status & AUD_INT_DN_RISCI1) {\r\natomic_set(&chip->count, cx_read(AUD_INT_A_GPCNT));\r\nsnd_pcm_period_elapsed(chip->substream);\r\n}\r\nreturn 1;\r\n}\r\nstatic int dsp_buffer_free(struct cx23885_audio_dev *chip)\r\n{\r\nBUG_ON(!chip->dma_size);\r\ndprintk(2, "Freeing buffer\n");\r\nvideobuf_dma_unmap(&chip->pci->dev, chip->dma_risc);\r\nvideobuf_dma_free(chip->dma_risc);\r\nbtcx_riscmem_free(chip->pci, &chip->buf->risc);\r\nkfree(chip->buf);\r\nchip->dma_risc = NULL;\r\nchip->dma_size = 0;\r\nreturn 0;\r\n}\r\nstatic int snd_cx23885_pcm_open(struct snd_pcm_substream *substream)\r\n{\r\nstruct cx23885_audio_dev *chip = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nint err;\r\nif (!chip) {\r\nprintk(KERN_ERR "BUG: cx23885 can't find device struct."\r\n" Can't proceed with open\n");\r\nreturn -ENODEV;\r\n}\r\nerr = snd_pcm_hw_constraint_pow2(runtime, 0,\r\nSNDRV_PCM_HW_PARAM_PERIODS);\r\nif (err < 0)\r\ngoto _error;\r\nchip->substream = substream;\r\nruntime->hw = snd_cx23885_digital_hw;\r\nif (chip->dev->sram_channels[AUDIO_SRAM_CHANNEL].fifo_size !=\r\nDEFAULT_FIFO_SIZE) {\r\nunsigned int bpl = chip->dev->\r\nsram_channels[AUDIO_SRAM_CHANNEL].fifo_size / 4;\r\nbpl &= ~7;\r\nruntime->hw.period_bytes_min = bpl;\r\nruntime->hw.period_bytes_max = bpl;\r\n}\r\nreturn 0;\r\n_error:\r\ndprintk(1, "Error opening PCM!\n");\r\nreturn err;\r\n}\r\nstatic int snd_cx23885_close(struct snd_pcm_substream *substream)\r\n{\r\nreturn 0;\r\n}\r\nstatic int snd_cx23885_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *hw_params)\r\n{\r\nstruct cx23885_audio_dev *chip = snd_pcm_substream_chip(substream);\r\nstruct videobuf_dmabuf *dma;\r\nstruct cx23885_audio_buffer *buf;\r\nint ret;\r\nif (substream->runtime->dma_area) {\r\ndsp_buffer_free(chip);\r\nsubstream->runtime->dma_area = NULL;\r\n}\r\nchip->period_size = params_period_bytes(hw_params);\r\nchip->num_periods = params_periods(hw_params);\r\nchip->dma_size = chip->period_size * params_periods(hw_params);\r\nBUG_ON(!chip->dma_size);\r\nBUG_ON(chip->num_periods & (chip->num_periods-1));\r\nbuf = kzalloc(sizeof(*buf), GFP_KERNEL);\r\nif (NULL == buf)\r\nreturn -ENOMEM;\r\nbuf->bpl = chip->period_size;\r\ndma = &buf->dma;\r\nvideobuf_dma_init(dma);\r\nret = videobuf_dma_init_kernel(dma, PCI_DMA_FROMDEVICE,\r\n(PAGE_ALIGN(chip->dma_size) >> PAGE_SHIFT));\r\nif (ret < 0)\r\ngoto error;\r\nret = videobuf_dma_map(&chip->pci->dev, dma);\r\nif (ret < 0)\r\ngoto error;\r\nret = cx23885_risc_databuffer(chip->pci, &buf->risc, dma->sglist,\r\nchip->period_size, chip->num_periods, 1);\r\nif (ret < 0)\r\ngoto error;\r\nbuf->risc.jmp[0] = cpu_to_le32(RISC_JUMP|RISC_IRQ1|RISC_CNT_INC);\r\nbuf->risc.jmp[1] = cpu_to_le32(buf->risc.dma);\r\nbuf->risc.jmp[2] = cpu_to_le32(0);\r\nchip->buf = buf;\r\nchip->dma_risc = dma;\r\nsubstream->runtime->dma_area = chip->dma_risc->vaddr;\r\nsubstream->runtime->dma_bytes = chip->dma_size;\r\nsubstream->runtime->dma_addr = 0;\r\nreturn 0;\r\nerror:\r\nkfree(buf);\r\nreturn ret;\r\n}\r\nstatic int snd_cx23885_hw_free(struct snd_pcm_substream *substream)\r\n{\r\nstruct cx23885_audio_dev *chip = snd_pcm_substream_chip(substream);\r\nif (substream->runtime->dma_area) {\r\ndsp_buffer_free(chip);\r\nsubstream->runtime->dma_area = NULL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int snd_cx23885_prepare(struct snd_pcm_substream *substream)\r\n{\r\nreturn 0;\r\n}\r\nstatic int snd_cx23885_card_trigger(struct snd_pcm_substream *substream,\r\nint cmd)\r\n{\r\nstruct cx23885_audio_dev *chip = snd_pcm_substream_chip(substream);\r\nint err;\r\nspin_lock(&chip->lock);\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\nerr = cx23885_start_audio_dma(chip);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\nerr = cx23885_stop_audio_dma(chip);\r\nbreak;\r\ndefault:\r\nerr = -EINVAL;\r\nbreak;\r\n}\r\nspin_unlock(&chip->lock);\r\nreturn err;\r\n}\r\nstatic snd_pcm_uframes_t snd_cx23885_pointer(\r\nstruct snd_pcm_substream *substream)\r\n{\r\nstruct cx23885_audio_dev *chip = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nu16 count;\r\ncount = atomic_read(&chip->count);\r\nreturn runtime->period_size * (count & (runtime->periods-1));\r\n}\r\nstatic struct page *snd_cx23885_page(struct snd_pcm_substream *substream,\r\nunsigned long offset)\r\n{\r\nvoid *pageptr = substream->runtime->dma_area + offset;\r\nreturn vmalloc_to_page(pageptr);\r\n}\r\nstatic int snd_cx23885_pcm(struct cx23885_audio_dev *chip, int device,\r\nchar *name)\r\n{\r\nint err;\r\nstruct snd_pcm *pcm;\r\nerr = snd_pcm_new(chip->card, name, device, 0, 1, &pcm);\r\nif (err < 0)\r\nreturn err;\r\npcm->private_data = chip;\r\nstrcpy(pcm->name, name);\r\nsnd_pcm_set_ops(pcm, SNDRV_PCM_STREAM_CAPTURE, &snd_cx23885_pcm_ops);\r\nreturn 0;\r\n}\r\nstruct cx23885_audio_dev *cx23885_audio_register(struct cx23885_dev *dev)\r\n{\r\nstruct snd_card *card;\r\nstruct cx23885_audio_dev *chip;\r\nint err;\r\nif (disable_analog_audio)\r\nreturn NULL;\r\nif (dev->sram_channels[AUDIO_SRAM_CHANNEL].cmds_start == 0) {\r\nprintk(KERN_WARNING "%s(): Missing SRAM channel configuration "\r\n"for analog TV Audio\n", __func__);\r\nreturn NULL;\r\n}\r\nerr = snd_card_create(SNDRV_DEFAULT_IDX1, SNDRV_DEFAULT_STR1,\r\nTHIS_MODULE, sizeof(struct cx23885_audio_dev), &card);\r\nif (err < 0)\r\ngoto error;\r\nchip = (struct cx23885_audio_dev *) card->private_data;\r\nchip->dev = dev;\r\nchip->pci = dev->pci;\r\nchip->card = card;\r\nspin_lock_init(&chip->lock);\r\nsnd_card_set_dev(card, &dev->pci->dev);\r\nerr = snd_cx23885_pcm(chip, 0, "CX23885 Digital");\r\nif (err < 0)\r\ngoto error;\r\nstrcpy(card->driver, "CX23885");\r\nsprintf(card->shortname, "Conexant CX23885");\r\nsprintf(card->longname, "%s at %s", card->shortname, dev->name);\r\nerr = snd_card_register(card);\r\nif (err < 0)\r\ngoto error;\r\ndprintk(0, "registered ALSA audio device\n");\r\nreturn chip;\r\nerror:\r\nsnd_card_free(card);\r\nprintk(KERN_ERR "%s(): Failed to register analog "\r\n"audio adapter\n", __func__);\r\nreturn NULL;\r\n}\r\nvoid cx23885_audio_unregister(struct cx23885_dev *dev)\r\n{\r\nstruct cx23885_audio_dev *chip = dev->audio_dev;\r\nsnd_card_free(chip->card);\r\n}

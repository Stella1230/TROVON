static int tps65910_rtc_alarm_irq_enable(struct device *dev, unsigned enabled)\r\n{\r\nstruct tps65910 *tps = dev_get_drvdata(dev->parent);\r\nu8 val = 0;\r\nif (enabled)\r\nval = TPS65910_RTC_INTERRUPTS_IT_ALARM;\r\nreturn regmap_write(tps->regmap, TPS65910_RTC_INTERRUPTS, val);\r\n}\r\nstatic int tps65910_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nunsigned char rtc_data[NUM_TIME_REGS];\r\nstruct tps65910 *tps = dev_get_drvdata(dev->parent);\r\nint ret;\r\nret = regmap_update_bits(tps->regmap, TPS65910_RTC_CTRL,\r\nTPS65910_RTC_CTRL_GET_TIME, TPS65910_RTC_CTRL_GET_TIME);\r\nif (ret < 0) {\r\ndev_err(dev, "RTC CTRL reg update failed with err:%d\n", ret);\r\nreturn ret;\r\n}\r\nret = regmap_bulk_read(tps->regmap, TPS65910_SECONDS, rtc_data,\r\nNUM_TIME_REGS);\r\nif (ret < 0) {\r\ndev_err(dev, "reading from RTC failed with err:%d\n", ret);\r\nreturn ret;\r\n}\r\ntm->tm_sec = bcd2bin(rtc_data[0]);\r\ntm->tm_min = bcd2bin(rtc_data[1]);\r\ntm->tm_hour = bcd2bin(rtc_data[2]);\r\ntm->tm_mday = bcd2bin(rtc_data[3]);\r\ntm->tm_mon = bcd2bin(rtc_data[4]) - 1;\r\ntm->tm_year = bcd2bin(rtc_data[5]) + 100;\r\nreturn ret;\r\n}\r\nstatic int tps65910_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nunsigned char rtc_data[NUM_TIME_REGS];\r\nstruct tps65910 *tps = dev_get_drvdata(dev->parent);\r\nint ret;\r\nrtc_data[0] = bin2bcd(tm->tm_sec);\r\nrtc_data[1] = bin2bcd(tm->tm_min);\r\nrtc_data[2] = bin2bcd(tm->tm_hour);\r\nrtc_data[3] = bin2bcd(tm->tm_mday);\r\nrtc_data[4] = bin2bcd(tm->tm_mon + 1);\r\nrtc_data[5] = bin2bcd(tm->tm_year - 100);\r\nret = regmap_update_bits(tps->regmap, TPS65910_RTC_CTRL,\r\nTPS65910_RTC_CTRL_STOP_RTC, 0);\r\nif (ret < 0) {\r\ndev_err(dev, "RTC stop failed with err:%d\n", ret);\r\nreturn ret;\r\n}\r\nret = regmap_bulk_write(tps->regmap, TPS65910_SECONDS, rtc_data,\r\nNUM_TIME_REGS);\r\nif (ret < 0) {\r\ndev_err(dev, "rtc_set_time error %d\n", ret);\r\nreturn ret;\r\n}\r\nret = regmap_update_bits(tps->regmap, TPS65910_RTC_CTRL,\r\nTPS65910_RTC_CTRL_STOP_RTC, 1);\r\nif (ret < 0)\r\ndev_err(dev, "RTC start failed with err:%d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int tps65910_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alm)\r\n{\r\nunsigned char alarm_data[NUM_TIME_REGS];\r\nu32 int_val;\r\nstruct tps65910 *tps = dev_get_drvdata(dev->parent);\r\nint ret;\r\nret = regmap_bulk_read(tps->regmap, TPS65910_SECONDS, alarm_data,\r\nNUM_TIME_REGS);\r\nif (ret < 0) {\r\ndev_err(dev, "rtc_read_alarm error %d\n", ret);\r\nreturn ret;\r\n}\r\nalm->time.tm_sec = bcd2bin(alarm_data[0]);\r\nalm->time.tm_min = bcd2bin(alarm_data[1]);\r\nalm->time.tm_hour = bcd2bin(alarm_data[2]);\r\nalm->time.tm_mday = bcd2bin(alarm_data[3]);\r\nalm->time.tm_mon = bcd2bin(alarm_data[4]) - 1;\r\nalm->time.tm_year = bcd2bin(alarm_data[5]) + 100;\r\nret = regmap_read(tps->regmap, TPS65910_RTC_INTERRUPTS, &int_val);\r\nif (ret < 0)\r\nreturn ret;\r\nif (int_val & TPS65910_RTC_INTERRUPTS_IT_ALARM)\r\nalm->enabled = 1;\r\nreturn ret;\r\n}\r\nstatic int tps65910_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alm)\r\n{\r\nunsigned char alarm_data[NUM_TIME_REGS];\r\nstruct tps65910 *tps = dev_get_drvdata(dev->parent);\r\nint ret;\r\nret = tps65910_rtc_alarm_irq_enable(dev, 0);\r\nif (ret)\r\nreturn ret;\r\nalarm_data[0] = bin2bcd(alm->time.tm_sec);\r\nalarm_data[1] = bin2bcd(alm->time.tm_min);\r\nalarm_data[2] = bin2bcd(alm->time.tm_hour);\r\nalarm_data[3] = bin2bcd(alm->time.tm_mday);\r\nalarm_data[4] = bin2bcd(alm->time.tm_mon + 1);\r\nalarm_data[5] = bin2bcd(alm->time.tm_year - 100);\r\nret = regmap_bulk_write(tps->regmap, TPS65910_ALARM_SECONDS,\r\nalarm_data, NUM_TIME_REGS);\r\nif (ret) {\r\ndev_err(dev, "rtc_set_alarm error %d\n", ret);\r\nreturn ret;\r\n}\r\nif (alm->enabled)\r\nret = tps65910_rtc_alarm_irq_enable(dev, 1);\r\nreturn ret;\r\n}\r\nstatic irqreturn_t tps65910_rtc_interrupt(int irq, void *rtc)\r\n{\r\nstruct device *dev = rtc;\r\nunsigned long events = 0;\r\nstruct tps65910 *tps = dev_get_drvdata(dev->parent);\r\nstruct tps65910_rtc *tps_rtc = dev_get_drvdata(dev);\r\nint ret;\r\nu32 rtc_reg;\r\nret = regmap_read(tps->regmap, TPS65910_RTC_STATUS, &rtc_reg);\r\nif (ret)\r\nreturn IRQ_NONE;\r\nif (rtc_reg & TPS65910_RTC_STATUS_ALARM)\r\nevents = RTC_IRQF | RTC_AF;\r\nret = regmap_write(tps->regmap, TPS65910_RTC_STATUS, rtc_reg);\r\nif (ret)\r\nreturn IRQ_NONE;\r\nrtc_update_irq(tps_rtc->rtc, 1, events);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int tps65910_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct tps65910 *tps65910 = NULL;\r\nstruct tps65910_rtc *tps_rtc = NULL;\r\nint ret;\r\nint irq;\r\nu32 rtc_reg;\r\ntps65910 = dev_get_drvdata(pdev->dev.parent);\r\ntps_rtc = devm_kzalloc(&pdev->dev, sizeof(struct tps65910_rtc),\r\nGFP_KERNEL);\r\nif (!tps_rtc)\r\nreturn -ENOMEM;\r\nret = regmap_read(tps65910->regmap, TPS65910_RTC_STATUS, &rtc_reg);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_write(tps65910->regmap, TPS65910_RTC_STATUS, rtc_reg);\r\nif (ret < 0)\r\nreturn ret;\r\ndev_dbg(&pdev->dev, "Enabling rtc-tps65910.\n");\r\nret = regmap_update_bits(tps65910->regmap, TPS65910_DEVCTRL,\r\nDEVCTRL_RTC_PWDN_MASK, 0 << DEVCTRL_RTC_PWDN_SHIFT);\r\nif (ret < 0)\r\nreturn ret;\r\nrtc_reg = TPS65910_RTC_CTRL_STOP_RTC;\r\nret = regmap_write(tps65910->regmap, TPS65910_RTC_CTRL, rtc_reg);\r\nif (ret < 0)\r\nreturn ret;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq <= 0) {\r\ndev_warn(&pdev->dev, "Wake up is not possible as irq = %d\n",\r\nirq);\r\nreturn -ENXIO;\r\n}\r\nret = devm_request_threaded_irq(&pdev->dev, irq, NULL,\r\ntps65910_rtc_interrupt, IRQF_TRIGGER_LOW | IRQF_EARLY_RESUME,\r\ndev_name(&pdev->dev), &pdev->dev);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "IRQ is not free.\n");\r\nreturn ret;\r\n}\r\ntps_rtc->irq = irq;\r\ndevice_set_wakeup_capable(&pdev->dev, 1);\r\ntps_rtc->rtc = devm_rtc_device_register(&pdev->dev, pdev->name,\r\n&tps65910_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(tps_rtc->rtc)) {\r\nret = PTR_ERR(tps_rtc->rtc);\r\ndev_err(&pdev->dev, "RTC device register: err %d\n", ret);\r\nreturn ret;\r\n}\r\nplatform_set_drvdata(pdev, tps_rtc);\r\nreturn 0;\r\n}\r\nstatic int tps65910_rtc_remove(struct platform_device *pdev)\r\n{\r\ntps65910_rtc_alarm_irq_enable(&pdev->dev, 0);\r\nreturn 0;\r\n}\r\nstatic int tps65910_rtc_suspend(struct device *dev)\r\n{\r\nstruct tps65910_rtc *tps_rtc = dev_get_drvdata(dev);\r\nif (device_may_wakeup(dev))\r\nenable_irq_wake(tps_rtc->irq);\r\nreturn 0;\r\n}\r\nstatic int tps65910_rtc_resume(struct device *dev)\r\n{\r\nstruct tps65910_rtc *tps_rtc = dev_get_drvdata(dev);\r\nif (device_may_wakeup(dev))\r\ndisable_irq_wake(tps_rtc->irq);\r\nreturn 0;\r\n}

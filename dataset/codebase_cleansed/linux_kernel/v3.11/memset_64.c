void *memset(void *s, int c, size_t n)\r\n{\r\nuint64_t *out64;\r\nint n64, to_align64;\r\nuint64_t v64;\r\nuint8_t *out8 = s;\r\n#define BYTE_CUTOFF 20\r\n#if BYTE_CUTOFF < 7\r\n#error "BYTE_CUTOFF is too small"\r\n#endif\r\nif (n < BYTE_CUTOFF) {\r\nif (n != 0) {\r\ndo {\r\n*out8 = c;\r\nout8++;\r\n} while (--n != 0);\r\n}\r\nreturn s;\r\n}\r\nwhile (((uintptr_t) out8 & 7) != 0) {\r\n*out8++ = c;\r\n--n;\r\n}\r\nwhile (n & 7)\r\nout8[--n] = c;\r\nout64 = (uint64_t *) out8;\r\nn64 = n >> 3;\r\nv64 = 0x0101010101010101ULL * (uint8_t)c;\r\n#define CACHE_LINE_SIZE_IN_DOUBLEWORDS (CHIP_L2_LINE_SIZE() / 8)\r\nto_align64 = (-((uintptr_t)out64 >> 3)) &\r\n(CACHE_LINE_SIZE_IN_DOUBLEWORDS - 1);\r\nif (to_align64 <= n64 - CACHE_LINE_SIZE_IN_DOUBLEWORDS) {\r\nint lines_left;\r\nn64 -= to_align64;\r\nfor (; to_align64 != 0; to_align64--) {\r\n*out64 = v64;\r\nout64++;\r\n}\r\nlines_left = (unsigned)n64 / CACHE_LINE_SIZE_IN_DOUBLEWORDS;\r\ndo {\r\nint x = ((lines_left < CHIP_MAX_OUTSTANDING_VICTIMS())\r\n? lines_left\r\n: CHIP_MAX_OUTSTANDING_VICTIMS());\r\nuint64_t *wh = out64;\r\nint i = x;\r\nint j;\r\nlines_left -= x;\r\ndo {\r\n__insn_wh64(wh);\r\nwh += CACHE_LINE_SIZE_IN_DOUBLEWORDS;\r\n} while (--i);\r\nfor (j = x * (CACHE_LINE_SIZE_IN_DOUBLEWORDS / 4);\r\nj != 0; j--) {\r\n*out64++ = v64;\r\n*out64++ = v64;\r\n*out64++ = v64;\r\n*out64++ = v64;\r\n}\r\n} while (lines_left != 0);\r\nn64 &= CACHE_LINE_SIZE_IN_DOUBLEWORDS - 1;\r\n}\r\nif (n64 != 0) {\r\ndo {\r\n*out64 = v64;\r\nout64++;\r\n} while (--n64 != 0);\r\n}\r\nreturn s;\r\n}

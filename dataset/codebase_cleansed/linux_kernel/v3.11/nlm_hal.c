void nlm_node_init(int node)\r\n{\r\nstruct nlm_soc_info *nodep;\r\nnodep = nlm_get_node(node);\r\nnodep->sysbase = nlm_get_sys_regbase(node);\r\nnodep->picbase = nlm_get_pic_regbase(node);\r\nnodep->ebase = read_c0_ebase() & (~((1 << 12) - 1));\r\nspin_lock_init(&nodep->piclock);\r\n}\r\nint nlm_irq_to_irt(int irq)\r\n{\r\nuint64_t pcibase;\r\nint devoff, irt;\r\nswitch (irq) {\r\ncase PIC_UART_0_IRQ:\r\ndevoff = XLP_IO_UART0_OFFSET(0);\r\nbreak;\r\ncase PIC_UART_1_IRQ:\r\ndevoff = XLP_IO_UART1_OFFSET(0);\r\nbreak;\r\ncase PIC_EHCI_0_IRQ:\r\ndevoff = XLP_IO_USB_EHCI0_OFFSET(0);\r\nbreak;\r\ncase PIC_EHCI_1_IRQ:\r\ndevoff = XLP_IO_USB_EHCI1_OFFSET(0);\r\nbreak;\r\ncase PIC_OHCI_0_IRQ:\r\ndevoff = XLP_IO_USB_OHCI0_OFFSET(0);\r\nbreak;\r\ncase PIC_OHCI_1_IRQ:\r\ndevoff = XLP_IO_USB_OHCI1_OFFSET(0);\r\nbreak;\r\ncase PIC_OHCI_2_IRQ:\r\ndevoff = XLP_IO_USB_OHCI2_OFFSET(0);\r\nbreak;\r\ncase PIC_OHCI_3_IRQ:\r\ndevoff = XLP_IO_USB_OHCI3_OFFSET(0);\r\nbreak;\r\ncase PIC_MMC_IRQ:\r\ndevoff = XLP_IO_SD_OFFSET(0);\r\nbreak;\r\ncase PIC_I2C_0_IRQ:\r\ndevoff = XLP_IO_I2C0_OFFSET(0);\r\nbreak;\r\ncase PIC_I2C_1_IRQ:\r\ndevoff = XLP_IO_I2C1_OFFSET(0);\r\nbreak;\r\ndefault:\r\ndevoff = 0;\r\nbreak;\r\n}\r\nif (devoff != 0) {\r\npcibase = nlm_pcicfg_base(devoff);\r\nirt = nlm_read_reg(pcibase, XLP_PCI_IRTINFO_REG) & 0xffff;\r\nif (irq == PIC_I2C_1_IRQ)\r\nirt = irt + 1;\r\n} else if (irq >= PIC_PCIE_LINK_0_IRQ && irq <= PIC_PCIE_LINK_3_IRQ) {\r\nirt = PIC_IRT_PCIE_LINK_INDEX(irq - PIC_PCIE_LINK_0_IRQ);\r\n} else {\r\nirt = -1;\r\n}\r\nreturn irt;\r\n}\r\nunsigned int nlm_get_core_frequency(int node, int core)\r\n{\r\nunsigned int pll_divf, pll_divr, dfs_div, ext_div;\r\nunsigned int rstval, dfsval, denom;\r\nuint64_t num, sysbase;\r\nsysbase = nlm_get_node(node)->sysbase;\r\nrstval = nlm_read_sys_reg(sysbase, SYS_POWER_ON_RESET_CFG);\r\ndfsval = nlm_read_sys_reg(sysbase, SYS_CORE_DFS_DIV_VALUE);\r\npll_divf = ((rstval >> 10) & 0x7f) + 1;\r\npll_divr = ((rstval >> 8) & 0x3) + 1;\r\next_div = ((rstval >> 30) & 0x3) + 1;\r\ndfs_div = ((dfsval >> (core * 4)) & 0xf) + 1;\r\nnum = 800000000ULL * pll_divf;\r\ndenom = 3 * pll_divr * ext_div * dfs_div;\r\ndo_div(num, denom);\r\nreturn (unsigned int)num;\r\n}\r\nunsigned int nlm_get_cpu_frequency(void)\r\n{\r\nreturn nlm_get_core_frequency(0, 0);\r\n}

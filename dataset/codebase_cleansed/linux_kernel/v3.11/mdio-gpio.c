static void *mdio_gpio_of_get_data(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct mdio_gpio_platform_data *pdata;\r\nint ret;\r\npdata = devm_kzalloc(&pdev->dev, sizeof(*pdata), GFP_KERNEL);\r\nif (!pdata)\r\nreturn NULL;\r\nret = of_get_gpio(np, 0);\r\nif (ret < 0)\r\nreturn NULL;\r\npdata->mdc = ret;\r\nret = of_get_gpio(np, 1);\r\nif (ret < 0)\r\nreturn NULL;\r\npdata->mdio = ret;\r\nreturn pdata;\r\n}\r\nstatic void mdio_dir(struct mdiobb_ctrl *ctrl, int dir)\r\n{\r\nstruct mdio_gpio_info *bitbang =\r\ncontainer_of(ctrl, struct mdio_gpio_info, ctrl);\r\nif (dir)\r\ngpio_direction_output(bitbang->mdio, 1);\r\nelse\r\ngpio_direction_input(bitbang->mdio);\r\n}\r\nstatic int mdio_get(struct mdiobb_ctrl *ctrl)\r\n{\r\nstruct mdio_gpio_info *bitbang =\r\ncontainer_of(ctrl, struct mdio_gpio_info, ctrl);\r\nreturn gpio_get_value(bitbang->mdio);\r\n}\r\nstatic void mdio_set(struct mdiobb_ctrl *ctrl, int what)\r\n{\r\nstruct mdio_gpio_info *bitbang =\r\ncontainer_of(ctrl, struct mdio_gpio_info, ctrl);\r\ngpio_set_value(bitbang->mdio, what);\r\n}\r\nstatic void mdc_set(struct mdiobb_ctrl *ctrl, int what)\r\n{\r\nstruct mdio_gpio_info *bitbang =\r\ncontainer_of(ctrl, struct mdio_gpio_info, ctrl);\r\ngpio_set_value(bitbang->mdc, what);\r\n}\r\nstatic struct mii_bus *mdio_gpio_bus_init(struct device *dev,\r\nstruct mdio_gpio_platform_data *pdata,\r\nint bus_id)\r\n{\r\nstruct mii_bus *new_bus;\r\nstruct mdio_gpio_info *bitbang;\r\nint i;\r\nbitbang = kzalloc(sizeof(*bitbang), GFP_KERNEL);\r\nif (!bitbang)\r\ngoto out;\r\nbitbang->ctrl.ops = &mdio_gpio_ops;\r\nbitbang->ctrl.reset = pdata->reset;\r\nbitbang->mdc = pdata->mdc;\r\nbitbang->mdio = pdata->mdio;\r\nnew_bus = alloc_mdio_bitbang(&bitbang->ctrl);\r\nif (!new_bus)\r\ngoto out_free_bitbang;\r\nnew_bus->name = "GPIO Bitbanged MDIO",\r\nnew_bus->phy_mask = pdata->phy_mask;\r\nnew_bus->irq = pdata->irqs;\r\nnew_bus->parent = dev;\r\nif (new_bus->phy_mask == ~0)\r\ngoto out_free_bus;\r\nfor (i = 0; i < PHY_MAX_ADDR; i++)\r\nif (!new_bus->irq[i])\r\nnew_bus->irq[i] = PHY_POLL;\r\nsnprintf(new_bus->id, MII_BUS_ID_SIZE, "gpio-%x", bus_id);\r\nif (gpio_request(bitbang->mdc, "mdc"))\r\ngoto out_free_bus;\r\nif (gpio_request(bitbang->mdio, "mdio"))\r\ngoto out_free_mdc;\r\ngpio_direction_output(bitbang->mdc, 0);\r\ndev_set_drvdata(dev, new_bus);\r\nreturn new_bus;\r\nout_free_mdc:\r\ngpio_free(bitbang->mdc);\r\nout_free_bus:\r\nfree_mdio_bitbang(new_bus);\r\nout_free_bitbang:\r\nkfree(bitbang);\r\nout:\r\nreturn NULL;\r\n}\r\nstatic void mdio_gpio_bus_deinit(struct device *dev)\r\n{\r\nstruct mii_bus *bus = dev_get_drvdata(dev);\r\nstruct mdio_gpio_info *bitbang = bus->priv;\r\ndev_set_drvdata(dev, NULL);\r\ngpio_free(bitbang->mdio);\r\ngpio_free(bitbang->mdc);\r\nfree_mdio_bitbang(bus);\r\nkfree(bitbang);\r\n}\r\nstatic void mdio_gpio_bus_destroy(struct device *dev)\r\n{\r\nstruct mii_bus *bus = dev_get_drvdata(dev);\r\nmdiobus_unregister(bus);\r\nmdio_gpio_bus_deinit(dev);\r\n}\r\nstatic int mdio_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct mdio_gpio_platform_data *pdata;\r\nstruct mii_bus *new_bus;\r\nint ret, bus_id;\r\nif (pdev->dev.of_node) {\r\npdata = mdio_gpio_of_get_data(pdev);\r\nbus_id = of_alias_get_id(pdev->dev.of_node, "mdio-gpio");\r\n} else {\r\npdata = pdev->dev.platform_data;\r\nbus_id = pdev->id;\r\n}\r\nif (!pdata)\r\nreturn -ENODEV;\r\nnew_bus = mdio_gpio_bus_init(&pdev->dev, pdata, bus_id);\r\nif (!new_bus)\r\nreturn -ENODEV;\r\nif (pdev->dev.of_node)\r\nret = of_mdiobus_register(new_bus, pdev->dev.of_node);\r\nelse\r\nret = mdiobus_register(new_bus);\r\nif (ret)\r\nmdio_gpio_bus_deinit(&pdev->dev);\r\nreturn ret;\r\n}\r\nstatic int mdio_gpio_remove(struct platform_device *pdev)\r\n{\r\nmdio_gpio_bus_destroy(&pdev->dev);\r\nreturn 0;\r\n}

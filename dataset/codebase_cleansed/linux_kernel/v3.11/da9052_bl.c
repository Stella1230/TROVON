static int da9052_adjust_wled_brightness(struct da9052_bl *wleds)\r\n{\r\nunsigned char boost_en;\r\nunsigned char i_sink;\r\nint ret;\r\nboost_en = 0x3F;\r\ni_sink = 0xFF;\r\nif (wleds->state == DA9052_WLEDS_OFF) {\r\nboost_en = 0x00;\r\ni_sink = 0x00;\r\n}\r\nret = da9052_reg_write(wleds->da9052, DA9052_BOOST_REG, boost_en);\r\nif (ret < 0)\r\nreturn ret;\r\nret = da9052_reg_write(wleds->da9052, DA9052_LED_CONT_REG, i_sink);\r\nif (ret < 0)\r\nreturn ret;\r\nret = da9052_reg_write(wleds->da9052, wled_bank[wleds->led_reg], 0x0);\r\nif (ret < 0)\r\nreturn ret;\r\nusleep_range(10000, 11000);\r\nif (wleds->brightness) {\r\nret = da9052_reg_write(wleds->da9052, wled_bank[wleds->led_reg],\r\nwleds->brightness);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int da9052_backlight_update_status(struct backlight_device *bl)\r\n{\r\nint brightness = bl->props.brightness;\r\nstruct da9052_bl *wleds = bl_get_data(bl);\r\nwleds->brightness = brightness;\r\nwleds->state = DA9052_WLEDS_ON;\r\nreturn da9052_adjust_wled_brightness(wleds);\r\n}\r\nstatic int da9052_backlight_get_brightness(struct backlight_device *bl)\r\n{\r\nstruct da9052_bl *wleds = bl_get_data(bl);\r\nreturn wleds->brightness;\r\n}\r\nstatic int da9052_backlight_probe(struct platform_device *pdev)\r\n{\r\nstruct backlight_device *bl;\r\nstruct backlight_properties props;\r\nstruct da9052_bl *wleds;\r\nwleds = devm_kzalloc(&pdev->dev, sizeof(struct da9052_bl), GFP_KERNEL);\r\nif (!wleds)\r\nreturn -ENOMEM;\r\nwleds->da9052 = dev_get_drvdata(pdev->dev.parent);\r\nwleds->brightness = 0;\r\nwleds->led_reg = platform_get_device_id(pdev)->driver_data;\r\nwleds->state = DA9052_WLEDS_OFF;\r\nprops.type = BACKLIGHT_RAW;\r\nprops.max_brightness = DA9052_MAX_BRIGHTNESS;\r\nbl = backlight_device_register(pdev->name, wleds->da9052->dev, wleds,\r\n&da9052_backlight_ops, &props);\r\nif (IS_ERR(bl)) {\r\ndev_err(&pdev->dev, "Failed to register backlight\n");\r\nreturn PTR_ERR(bl);\r\n}\r\nbl->props.max_brightness = DA9052_MAX_BRIGHTNESS;\r\nbl->props.brightness = 0;\r\nplatform_set_drvdata(pdev, bl);\r\nreturn da9052_adjust_wled_brightness(wleds);\r\n}\r\nstatic int da9052_backlight_remove(struct platform_device *pdev)\r\n{\r\nstruct backlight_device *bl = platform_get_drvdata(pdev);\r\nstruct da9052_bl *wleds = bl_get_data(bl);\r\nwleds->brightness = 0;\r\nwleds->state = DA9052_WLEDS_OFF;\r\nda9052_adjust_wled_brightness(wleds);\r\nbacklight_device_unregister(bl);\r\nreturn 0;\r\n}

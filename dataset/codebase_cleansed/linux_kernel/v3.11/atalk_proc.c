void *atalk_seq_interface_start(struct seq_file *seq, loff_t *pos)\r\n__acquires(atalk_interfaces_lock)\r\n{\r\nloff_t l = *pos;\r\nread_lock_bh(&atalk_interfaces_lock);\r\nreturn l ? atalk_get_interface_idx(--l) : SEQ_START_TOKEN;\r\n}\r\nstatic void *atalk_seq_interface_next(struct seq_file *seq, void *v, loff_t *pos)\r\n{\r\nstruct atalk_iface *i;\r\n++*pos;\r\nif (v == SEQ_START_TOKEN) {\r\ni = NULL;\r\nif (atalk_interfaces)\r\ni = atalk_interfaces;\r\ngoto out;\r\n}\r\ni = v;\r\ni = i->next;\r\nout:\r\nreturn i;\r\n}\r\nstatic void atalk_seq_interface_stop(struct seq_file *seq, void *v)\r\n__releases(atalk_interfaces_lock)\r\n{\r\nread_unlock_bh(&atalk_interfaces_lock);\r\n}\r\nstatic int atalk_seq_interface_show(struct seq_file *seq, void *v)\r\n{\r\nstruct atalk_iface *iface;\r\nif (v == SEQ_START_TOKEN) {\r\nseq_puts(seq, "Interface Address Networks "\r\n"Status\n");\r\ngoto out;\r\n}\r\niface = v;\r\nseq_printf(seq, "%-16s %04X:%02X %04X-%04X %d\n",\r\niface->dev->name, ntohs(iface->address.s_net),\r\niface->address.s_node, ntohs(iface->nets.nr_firstnet),\r\nntohs(iface->nets.nr_lastnet), iface->status);\r\nout:\r\nreturn 0;\r\n}\r\nvoid *atalk_seq_route_start(struct seq_file *seq, loff_t *pos)\r\n__acquires(atalk_routes_lock)\r\n{\r\nloff_t l = *pos;\r\nread_lock_bh(&atalk_routes_lock);\r\nreturn l ? atalk_get_route_idx(--l) : SEQ_START_TOKEN;\r\n}\r\nstatic void *atalk_seq_route_next(struct seq_file *seq, void *v, loff_t *pos)\r\n{\r\nstruct atalk_route *r;\r\n++*pos;\r\nif (v == SEQ_START_TOKEN) {\r\nr = NULL;\r\nif (atalk_routes)\r\nr = atalk_routes;\r\ngoto out;\r\n}\r\nr = v;\r\nr = r->next;\r\nout:\r\nreturn r;\r\n}\r\nstatic void atalk_seq_route_stop(struct seq_file *seq, void *v)\r\n__releases(atalk_routes_lock)\r\n{\r\nread_unlock_bh(&atalk_routes_lock);\r\n}\r\nstatic int atalk_seq_route_show(struct seq_file *seq, void *v)\r\n{\r\nstruct atalk_route *rt;\r\nif (v == SEQ_START_TOKEN) {\r\nseq_puts(seq, "Target Router Flags Dev\n");\r\ngoto out;\r\n}\r\nif (atrtr_default.dev) {\r\nrt = &atrtr_default;\r\nseq_printf(seq, "Default %04X:%02X %-4d %s\n",\r\nntohs(rt->gateway.s_net), rt->gateway.s_node,\r\nrt->flags, rt->dev->name);\r\n}\r\nrt = v;\r\nseq_printf(seq, "%04X:%02X %04X:%02X %-4d %s\n",\r\nntohs(rt->target.s_net), rt->target.s_node,\r\nntohs(rt->gateway.s_net), rt->gateway.s_node,\r\nrt->flags, rt->dev->name);\r\nout:\r\nreturn 0;\r\n}\r\nstatic void *atalk_seq_socket_start(struct seq_file *seq, loff_t *pos)\r\n__acquires(atalk_sockets_lock)\r\n{\r\nread_lock_bh(&atalk_sockets_lock);\r\nreturn seq_hlist_start_head(&atalk_sockets, *pos);\r\n}\r\nstatic void *atalk_seq_socket_next(struct seq_file *seq, void *v, loff_t *pos)\r\n{\r\nreturn seq_hlist_next(v, &atalk_sockets, pos);\r\n}\r\nstatic void atalk_seq_socket_stop(struct seq_file *seq, void *v)\r\n__releases(atalk_sockets_lock)\r\n{\r\nread_unlock_bh(&atalk_sockets_lock);\r\n}\r\nstatic int atalk_seq_socket_show(struct seq_file *seq, void *v)\r\n{\r\nstruct sock *s;\r\nstruct atalk_sock *at;\r\nif (v == SEQ_START_TOKEN) {\r\nseq_printf(seq, "Type Local_addr Remote_addr Tx_queue "\r\n"Rx_queue St UID\n");\r\ngoto out;\r\n}\r\ns = sk_entry(v);\r\nat = at_sk(s);\r\nseq_printf(seq, "%02X %04X:%02X:%02X %04X:%02X:%02X %08X:%08X "\r\n"%02X %d\n",\r\ns->sk_type, ntohs(at->src_net), at->src_node, at->src_port,\r\nntohs(at->dest_net), at->dest_node, at->dest_port,\r\nsk_wmem_alloc_get(s),\r\nsk_rmem_alloc_get(s),\r\ns->sk_state,\r\nfrom_kuid_munged(seq_user_ns(seq), sock_i_uid(s)));\r\nout:\r\nreturn 0;\r\n}\r\nstatic int atalk_seq_interface_open(struct inode *inode, struct file *file)\r\n{\r\nreturn seq_open(file, &atalk_seq_interface_ops);\r\n}\r\nstatic int atalk_seq_route_open(struct inode *inode, struct file *file)\r\n{\r\nreturn seq_open(file, &atalk_seq_route_ops);\r\n}\r\nstatic int atalk_seq_socket_open(struct inode *inode, struct file *file)\r\n{\r\nreturn seq_open(file, &atalk_seq_socket_ops);\r\n}\r\nint __init atalk_proc_init(void)\r\n{\r\nstruct proc_dir_entry *p;\r\nint rc = -ENOMEM;\r\natalk_proc_dir = proc_mkdir("atalk", init_net.proc_net);\r\nif (!atalk_proc_dir)\r\ngoto out;\r\np = proc_create("interface", S_IRUGO, atalk_proc_dir,\r\n&atalk_seq_interface_fops);\r\nif (!p)\r\ngoto out_interface;\r\np = proc_create("route", S_IRUGO, atalk_proc_dir,\r\n&atalk_seq_route_fops);\r\nif (!p)\r\ngoto out_route;\r\np = proc_create("socket", S_IRUGO, atalk_proc_dir,\r\n&atalk_seq_socket_fops);\r\nif (!p)\r\ngoto out_socket;\r\np = proc_create("arp", S_IRUGO, atalk_proc_dir, &atalk_seq_arp_fops);\r\nif (!p)\r\ngoto out_arp;\r\nrc = 0;\r\nout:\r\nreturn rc;\r\nout_arp:\r\nremove_proc_entry("socket", atalk_proc_dir);\r\nout_socket:\r\nremove_proc_entry("route", atalk_proc_dir);\r\nout_route:\r\nremove_proc_entry("interface", atalk_proc_dir);\r\nout_interface:\r\nremove_proc_entry("atalk", init_net.proc_net);\r\ngoto out;\r\n}\r\nvoid __exit atalk_proc_exit(void)\r\n{\r\nremove_proc_entry("interface", atalk_proc_dir);\r\nremove_proc_entry("route", atalk_proc_dir);\r\nremove_proc_entry("socket", atalk_proc_dir);\r\nremove_proc_entry("arp", atalk_proc_dir);\r\nremove_proc_entry("atalk", init_net.proc_net);\r\n}

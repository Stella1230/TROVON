void kvmppc_set_pending_interrupt(struct kvm_vcpu *vcpu, enum int_class type)\r\n{\r\nenum ppc_dbell dbell_type;\r\nunsigned long tag;\r\nswitch (type) {\r\ncase INT_CLASS_NONCRIT:\r\ndbell_type = PPC_G_DBELL;\r\nbreak;\r\ncase INT_CLASS_CRIT:\r\ndbell_type = PPC_G_DBELL_CRIT;\r\nbreak;\r\ncase INT_CLASS_MC:\r\ndbell_type = PPC_G_DBELL_MC;\r\nbreak;\r\ndefault:\r\nWARN_ONCE(1, "%s: unknown int type %d\n", __func__, type);\r\nreturn;\r\n}\r\ntag = PPC_DBELL_LPID(vcpu->kvm->arch.lpid) | vcpu->vcpu_id;\r\nmb();\r\nppc_msgsnd(dbell_type, 0, tag);\r\n}\r\nvoid kvmppc_e500_tlbil_one(struct kvmppc_vcpu_e500 *vcpu_e500,\r\nstruct kvm_book3e_206_tlb_entry *gtlbe)\r\n{\r\nunsigned int tid, ts;\r\ngva_t eaddr;\r\nu32 val, lpid;\r\nunsigned long flags;\r\nts = get_tlb_ts(gtlbe);\r\ntid = get_tlb_tid(gtlbe);\r\nlpid = vcpu_e500->vcpu.kvm->arch.lpid;\r\nval = (tid << 16) | ts;\r\neaddr = get_tlb_eaddr(gtlbe);\r\nlocal_irq_save(flags);\r\nmtspr(SPRN_MAS6, val);\r\nmtspr(SPRN_MAS5, MAS5_SGS | lpid);\r\nasm volatile("tlbsx 0, %[eaddr]\n" : : [eaddr] "r" (eaddr));\r\nval = mfspr(SPRN_MAS1);\r\nif (val & MAS1_VALID) {\r\nmtspr(SPRN_MAS1, val & ~MAS1_VALID);\r\nasm volatile("tlbwe");\r\n}\r\nmtspr(SPRN_MAS5, 0);\r\nmtspr(SPRN_MAS8, 0);\r\nisync();\r\nlocal_irq_restore(flags);\r\n}\r\nvoid kvmppc_e500_tlbil_all(struct kvmppc_vcpu_e500 *vcpu_e500)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nmtspr(SPRN_MAS5, MAS5_SGS | vcpu_e500->vcpu.kvm->arch.lpid);\r\nasm volatile("tlbilxlpid");\r\nmtspr(SPRN_MAS5, 0);\r\nlocal_irq_restore(flags);\r\n}\r\nvoid kvmppc_set_pid(struct kvm_vcpu *vcpu, u32 pid)\r\n{\r\nvcpu->arch.pid = pid;\r\n}\r\nvoid kvmppc_mmu_msr_notify(struct kvm_vcpu *vcpu, u32 old_msr)\r\n{\r\n}\r\nvoid kvmppc_core_vcpu_load(struct kvm_vcpu *vcpu, int cpu)\r\n{\r\nstruct kvmppc_vcpu_e500 *vcpu_e500 = to_e500(vcpu);\r\nkvmppc_booke_vcpu_load(vcpu, cpu);\r\nmtspr(SPRN_LPID, vcpu->kvm->arch.lpid);\r\nmtspr(SPRN_EPCR, vcpu->arch.shadow_epcr);\r\nmtspr(SPRN_GPIR, vcpu->vcpu_id);\r\nmtspr(SPRN_MSRP, vcpu->arch.shadow_msrp);\r\nmtspr(SPRN_EPLC, vcpu->arch.eplc);\r\nmtspr(SPRN_EPSC, vcpu->arch.epsc);\r\nmtspr(SPRN_GIVPR, vcpu->arch.ivpr);\r\nmtspr(SPRN_GIVOR2, vcpu->arch.ivor[BOOKE_IRQPRIO_DATA_STORAGE]);\r\nmtspr(SPRN_GIVOR8, vcpu->arch.ivor[BOOKE_IRQPRIO_SYSCALL]);\r\nmtspr(SPRN_GSPRG0, (unsigned long)vcpu->arch.shared->sprg0);\r\nmtspr(SPRN_GSPRG1, (unsigned long)vcpu->arch.shared->sprg1);\r\nmtspr(SPRN_GSPRG2, (unsigned long)vcpu->arch.shared->sprg2);\r\nmtspr(SPRN_GSPRG3, (unsigned long)vcpu->arch.shared->sprg3);\r\nmtspr(SPRN_GSRR0, vcpu->arch.shared->srr0);\r\nmtspr(SPRN_GSRR1, vcpu->arch.shared->srr1);\r\nmtspr(SPRN_GEPR, vcpu->arch.epr);\r\nmtspr(SPRN_GDEAR, vcpu->arch.shared->dar);\r\nmtspr(SPRN_GESR, vcpu->arch.shared->esr);\r\nif (vcpu->arch.oldpir != mfspr(SPRN_PIR) ||\r\n__get_cpu_var(last_vcpu_on_cpu) != vcpu) {\r\nkvmppc_e500_tlbil_all(vcpu_e500);\r\n__get_cpu_var(last_vcpu_on_cpu) = vcpu;\r\n}\r\nkvmppc_load_guest_fp(vcpu);\r\n}\r\nvoid kvmppc_core_vcpu_put(struct kvm_vcpu *vcpu)\r\n{\r\nvcpu->arch.eplc = mfspr(SPRN_EPLC);\r\nvcpu->arch.epsc = mfspr(SPRN_EPSC);\r\nvcpu->arch.shared->sprg0 = mfspr(SPRN_GSPRG0);\r\nvcpu->arch.shared->sprg1 = mfspr(SPRN_GSPRG1);\r\nvcpu->arch.shared->sprg2 = mfspr(SPRN_GSPRG2);\r\nvcpu->arch.shared->sprg3 = mfspr(SPRN_GSPRG3);\r\nvcpu->arch.shared->srr0 = mfspr(SPRN_GSRR0);\r\nvcpu->arch.shared->srr1 = mfspr(SPRN_GSRR1);\r\nvcpu->arch.epr = mfspr(SPRN_GEPR);\r\nvcpu->arch.shared->dar = mfspr(SPRN_GDEAR);\r\nvcpu->arch.shared->esr = mfspr(SPRN_GESR);\r\nvcpu->arch.oldpir = mfspr(SPRN_PIR);\r\nkvmppc_booke_vcpu_put(vcpu);\r\n}\r\nint kvmppc_core_check_processor_compat(void)\r\n{\r\nint r;\r\nif (strcmp(cur_cpu_spec->cpu_name, "e500mc") == 0)\r\nr = 0;\r\nelse if (strcmp(cur_cpu_spec->cpu_name, "e5500") == 0)\r\nr = 0;\r\nelse\r\nr = -ENOTSUPP;\r\nreturn r;\r\n}\r\nint kvmppc_core_vcpu_setup(struct kvm_vcpu *vcpu)\r\n{\r\nstruct kvmppc_vcpu_e500 *vcpu_e500 = to_e500(vcpu);\r\nvcpu->arch.shadow_epcr = SPRN_EPCR_DSIGS | SPRN_EPCR_DGTMI | \\r\nSPRN_EPCR_DUVD;\r\n#ifdef CONFIG_64BIT\r\nvcpu->arch.shadow_epcr |= SPRN_EPCR_ICM;\r\n#endif\r\nvcpu->arch.shadow_msrp = MSRP_UCLEP | MSRP_DEP | MSRP_PMMP;\r\nvcpu->arch.eplc = EPC_EGS | (vcpu->kvm->arch.lpid << EPC_ELPID_SHIFT);\r\nvcpu->arch.epsc = vcpu->arch.eplc;\r\nvcpu->arch.pvr = mfspr(SPRN_PVR);\r\nvcpu_e500->svr = mfspr(SPRN_SVR);\r\nvcpu->arch.cpu_type = KVM_CPU_E500MC;\r\nreturn 0;\r\n}\r\nvoid kvmppc_core_get_sregs(struct kvm_vcpu *vcpu, struct kvm_sregs *sregs)\r\n{\r\nstruct kvmppc_vcpu_e500 *vcpu_e500 = to_e500(vcpu);\r\nsregs->u.e.features |= KVM_SREGS_E_ARCH206_MMU | KVM_SREGS_E_PM |\r\nKVM_SREGS_E_PC;\r\nsregs->u.e.impl_id = KVM_SREGS_E_IMPL_FSL;\r\nsregs->u.e.impl.fsl.features = 0;\r\nsregs->u.e.impl.fsl.svr = vcpu_e500->svr;\r\nsregs->u.e.impl.fsl.hid0 = vcpu_e500->hid0;\r\nsregs->u.e.impl.fsl.mcar = vcpu_e500->mcar;\r\nkvmppc_get_sregs_e500_tlb(vcpu, sregs);\r\nsregs->u.e.ivor_high[3] =\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_PERFORMANCE_MONITOR];\r\nsregs->u.e.ivor_high[4] = vcpu->arch.ivor[BOOKE_IRQPRIO_DBELL];\r\nsregs->u.e.ivor_high[5] = vcpu->arch.ivor[BOOKE_IRQPRIO_DBELL_CRIT];\r\nkvmppc_get_sregs_ivor(vcpu, sregs);\r\n}\r\nint kvmppc_core_set_sregs(struct kvm_vcpu *vcpu, struct kvm_sregs *sregs)\r\n{\r\nstruct kvmppc_vcpu_e500 *vcpu_e500 = to_e500(vcpu);\r\nint ret;\r\nif (sregs->u.e.impl_id == KVM_SREGS_E_IMPL_FSL) {\r\nvcpu_e500->svr = sregs->u.e.impl.fsl.svr;\r\nvcpu_e500->hid0 = sregs->u.e.impl.fsl.hid0;\r\nvcpu_e500->mcar = sregs->u.e.impl.fsl.mcar;\r\n}\r\nret = kvmppc_set_sregs_e500_tlb(vcpu, sregs);\r\nif (ret < 0)\r\nreturn ret;\r\nif (!(sregs->u.e.features & KVM_SREGS_E_IVOR))\r\nreturn 0;\r\nif (sregs->u.e.features & KVM_SREGS_E_PM) {\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_PERFORMANCE_MONITOR] =\r\nsregs->u.e.ivor_high[3];\r\n}\r\nif (sregs->u.e.features & KVM_SREGS_E_PC) {\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_DBELL] =\r\nsregs->u.e.ivor_high[4];\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_DBELL_CRIT] =\r\nsregs->u.e.ivor_high[5];\r\n}\r\nreturn kvmppc_set_sregs_ivor(vcpu, sregs);\r\n}\r\nint kvmppc_get_one_reg(struct kvm_vcpu *vcpu, u64 id,\r\nunion kvmppc_one_reg *val)\r\n{\r\nint r = kvmppc_get_one_reg_e500_tlb(vcpu, id, val);\r\nreturn r;\r\n}\r\nint kvmppc_set_one_reg(struct kvm_vcpu *vcpu, u64 id,\r\nunion kvmppc_one_reg *val)\r\n{\r\nint r = kvmppc_set_one_reg_e500_tlb(vcpu, id, val);\r\nreturn r;\r\n}\r\nstruct kvm_vcpu *kvmppc_core_vcpu_create(struct kvm *kvm, unsigned int id)\r\n{\r\nstruct kvmppc_vcpu_e500 *vcpu_e500;\r\nstruct kvm_vcpu *vcpu;\r\nint err;\r\nvcpu_e500 = kmem_cache_zalloc(kvm_vcpu_cache, GFP_KERNEL);\r\nif (!vcpu_e500) {\r\nerr = -ENOMEM;\r\ngoto out;\r\n}\r\nvcpu = &vcpu_e500->vcpu;\r\nvcpu->arch.oldpir = 0xffffffff;\r\nerr = kvm_vcpu_init(vcpu, kvm, id);\r\nif (err)\r\ngoto free_vcpu;\r\nerr = kvmppc_e500_tlb_init(vcpu_e500);\r\nif (err)\r\ngoto uninit_vcpu;\r\nvcpu->arch.shared = (void *)__get_free_page(GFP_KERNEL | __GFP_ZERO);\r\nif (!vcpu->arch.shared)\r\ngoto uninit_tlb;\r\nreturn vcpu;\r\nuninit_tlb:\r\nkvmppc_e500_tlb_uninit(vcpu_e500);\r\nuninit_vcpu:\r\nkvm_vcpu_uninit(vcpu);\r\nfree_vcpu:\r\nkmem_cache_free(kvm_vcpu_cache, vcpu_e500);\r\nout:\r\nreturn ERR_PTR(err);\r\n}\r\nvoid kvmppc_core_vcpu_free(struct kvm_vcpu *vcpu)\r\n{\r\nstruct kvmppc_vcpu_e500 *vcpu_e500 = to_e500(vcpu);\r\nfree_page((unsigned long)vcpu->arch.shared);\r\nkvmppc_e500_tlb_uninit(vcpu_e500);\r\nkvm_vcpu_uninit(vcpu);\r\nkmem_cache_free(kvm_vcpu_cache, vcpu_e500);\r\n}\r\nint kvmppc_core_init_vm(struct kvm *kvm)\r\n{\r\nint lpid;\r\nlpid = kvmppc_alloc_lpid();\r\nif (lpid < 0)\r\nreturn lpid;\r\nkvm->arch.lpid = lpid;\r\nreturn 0;\r\n}\r\nvoid kvmppc_core_destroy_vm(struct kvm *kvm)\r\n{\r\nkvmppc_free_lpid(kvm->arch.lpid);\r\n}\r\nstatic int __init kvmppc_e500mc_init(void)\r\n{\r\nint r;\r\nr = kvmppc_booke_init();\r\nif (r)\r\nreturn r;\r\nkvmppc_init_lpid(64);\r\nkvmppc_claim_lpid(0);\r\nreturn kvm_init(NULL, sizeof(struct kvmppc_vcpu_e500), 0, THIS_MODULE);\r\n}\r\nstatic void __exit kvmppc_e500mc_exit(void)\r\n{\r\nkvmppc_booke_exit();\r\n}

static inline struct z8530_dev* dev_to_sv(struct net_device *dev)\r\n{\r\nreturn (struct z8530_dev *)dev_to_hdlc(dev)->priv;\r\n}\r\nstatic void hostess_input(struct z8530_channel *c, struct sk_buff *skb)\r\n{\r\nskb_trim(skb, skb->len - 2);\r\nskb->protocol = hdlc_type_trans(skb, c->netdevice);\r\nskb_reset_mac_header(skb);\r\nskb->dev = c->netdevice;\r\nnetif_rx(skb);\r\n}\r\nstatic int hostess_open(struct net_device *d)\r\n{\r\nstruct z8530_dev *sv11 = dev_to_sv(d);\r\nint err = -1;\r\nswitch (dma) {\r\ncase 0:\r\nerr = z8530_sync_open(d, &sv11->chanA);\r\nbreak;\r\ncase 1:\r\nerr = z8530_sync_dma_open(d, &sv11->chanA);\r\nbreak;\r\ncase 2:\r\nerr = z8530_sync_txdma_open(d, &sv11->chanA);\r\nbreak;\r\n}\r\nif (err)\r\nreturn err;\r\nerr = hdlc_open(d);\r\nif (err) {\r\nswitch (dma) {\r\ncase 0:\r\nz8530_sync_close(d, &sv11->chanA);\r\nbreak;\r\ncase 1:\r\nz8530_sync_dma_close(d, &sv11->chanA);\r\nbreak;\r\ncase 2:\r\nz8530_sync_txdma_close(d, &sv11->chanA);\r\nbreak;\r\n}\r\nreturn err;\r\n}\r\nsv11->chanA.rx_function = hostess_input;\r\nnetif_start_queue(d);\r\nreturn 0;\r\n}\r\nstatic int hostess_close(struct net_device *d)\r\n{\r\nstruct z8530_dev *sv11 = dev_to_sv(d);\r\nsv11->chanA.rx_function = z8530_null_rx;\r\nhdlc_close(d);\r\nnetif_stop_queue(d);\r\nswitch (dma) {\r\ncase 0:\r\nz8530_sync_close(d, &sv11->chanA);\r\nbreak;\r\ncase 1:\r\nz8530_sync_dma_close(d, &sv11->chanA);\r\nbreak;\r\ncase 2:\r\nz8530_sync_txdma_close(d, &sv11->chanA);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int hostess_ioctl(struct net_device *d, struct ifreq *ifr, int cmd)\r\n{\r\nreturn hdlc_ioctl(d, ifr, cmd);\r\n}\r\nstatic netdev_tx_t hostess_queue_xmit(struct sk_buff *skb,\r\nstruct net_device *d)\r\n{\r\nreturn z8530_queue_xmit(&dev_to_sv(d)->chanA, skb);\r\n}\r\nstatic int hostess_attach(struct net_device *dev, unsigned short encoding,\r\nunsigned short parity)\r\n{\r\nif (encoding == ENCODING_NRZ && parity == PARITY_CRC16_PR1_CCITT)\r\nreturn 0;\r\nreturn -EINVAL;\r\n}\r\nstatic struct z8530_dev *sv11_init(int iobase, int irq)\r\n{\r\nstruct z8530_dev *sv;\r\nstruct net_device *netdev;\r\nif (!request_region(iobase, 8, "Comtrol SV11")) {\r\npr_warn("I/O 0x%X already in use\n", iobase);\r\nreturn NULL;\r\n}\r\nsv = kzalloc(sizeof(struct z8530_dev), GFP_KERNEL);\r\nif (!sv)\r\ngoto err_kzalloc;\r\nsv->active = 0;\r\nsv->chanA.ctrlio = iobase + 1;\r\nsv->chanA.dataio = iobase + 3;\r\nsv->chanB.ctrlio = -1;\r\nsv->chanB.dataio = -1;\r\nsv->chanA.irqs = &z8530_nop;\r\nsv->chanB.irqs = &z8530_nop;\r\noutb(0, iobase + 4);\r\nif (request_irq(irq, z8530_interrupt, IRQF_DISABLED,\r\n"Hostess SV11", sv) < 0) {\r\npr_warn("IRQ %d already in use\n", irq);\r\ngoto err_irq;\r\n}\r\nsv->irq = irq;\r\nsv->chanA.private = sv;\r\nsv->chanA.dev = sv;\r\nsv->chanB.dev = sv;\r\nif (dma) {\r\nsv->chanA.txdma = 3;\r\nsv->chanA.rxdma = 1;\r\noutb(0x03 | 0x08, iobase + 4);\r\nif (request_dma(sv->chanA.txdma, "Hostess SV/11 (TX)"))\r\ngoto err_txdma;\r\nif (dma == 1)\r\nif (request_dma(sv->chanA.rxdma, "Hostess SV/11 (RX)"))\r\ngoto err_rxdma;\r\n}\r\ndisable_irq(irq);\r\nif (z8530_init(sv)) {\r\npr_err("Z8530 series device not found\n");\r\nenable_irq(irq);\r\ngoto free_dma;\r\n}\r\nz8530_channel_load(&sv->chanB, z8530_dead_port);\r\nif (sv->type == Z85C30)\r\nz8530_channel_load(&sv->chanA, z8530_hdlc_kilostream);\r\nelse\r\nz8530_channel_load(&sv->chanA, z8530_hdlc_kilostream_85230);\r\nenable_irq(irq);\r\nsv->chanA.netdevice = netdev = alloc_hdlcdev(sv);\r\nif (!netdev)\r\ngoto free_dma;\r\ndev_to_hdlc(netdev)->attach = hostess_attach;\r\ndev_to_hdlc(netdev)->xmit = hostess_queue_xmit;\r\nnetdev->netdev_ops = &hostess_ops;\r\nnetdev->base_addr = iobase;\r\nnetdev->irq = irq;\r\nif (register_hdlc_device(netdev)) {\r\npr_err("unable to register HDLC device\n");\r\nfree_netdev(netdev);\r\ngoto free_dma;\r\n}\r\nz8530_describe(sv, "I/O", iobase);\r\nsv->active = 1;\r\nreturn sv;\r\nfree_dma:\r\nif (dma == 1)\r\nfree_dma(sv->chanA.rxdma);\r\nerr_rxdma:\r\nif (dma)\r\nfree_dma(sv->chanA.txdma);\r\nerr_txdma:\r\nfree_irq(irq, sv);\r\nerr_irq:\r\nkfree(sv);\r\nerr_kzalloc:\r\nrelease_region(iobase, 8);\r\nreturn NULL;\r\n}\r\nstatic void sv11_shutdown(struct z8530_dev *dev)\r\n{\r\nunregister_hdlc_device(dev->chanA.netdevice);\r\nz8530_shutdown(dev);\r\nfree_irq(dev->irq, dev);\r\nif (dma) {\r\nif (dma == 1)\r\nfree_dma(dev->chanA.rxdma);\r\nfree_dma(dev->chanA.txdma);\r\n}\r\nrelease_region(dev->chanA.ctrlio - 1, 8);\r\nfree_netdev(dev->chanA.netdevice);\r\nkfree(dev);\r\n}\r\nint init_module(void)\r\n{\r\nif ((sv11_unit = sv11_init(io, irq)) == NULL)\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nvoid cleanup_module(void)\r\n{\r\nif (sv11_unit)\r\nsv11_shutdown(sv11_unit);\r\n}

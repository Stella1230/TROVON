static void rds_iw_add_one(struct ib_device *device)\r\n{\r\nstruct rds_iw_device *rds_iwdev;\r\nstruct ib_device_attr *dev_attr;\r\nif (device->node_type != RDMA_NODE_RNIC)\r\nreturn;\r\ndev_attr = kmalloc(sizeof *dev_attr, GFP_KERNEL);\r\nif (!dev_attr)\r\nreturn;\r\nif (ib_query_device(device, dev_attr)) {\r\nrdsdebug("Query device failed for %s\n", device->name);\r\ngoto free_attr;\r\n}\r\nrds_iwdev = kmalloc(sizeof *rds_iwdev, GFP_KERNEL);\r\nif (!rds_iwdev)\r\ngoto free_attr;\r\nspin_lock_init(&rds_iwdev->spinlock);\r\nrds_iwdev->dma_local_lkey = !!(dev_attr->device_cap_flags & IB_DEVICE_LOCAL_DMA_LKEY);\r\nrds_iwdev->max_wrs = dev_attr->max_qp_wr;\r\nrds_iwdev->max_sge = min(dev_attr->max_sge, RDS_IW_MAX_SGE);\r\nrds_iwdev->dev = device;\r\nrds_iwdev->pd = ib_alloc_pd(device);\r\nif (IS_ERR(rds_iwdev->pd))\r\ngoto free_dev;\r\nif (!rds_iwdev->dma_local_lkey) {\r\nrds_iwdev->mr = ib_get_dma_mr(rds_iwdev->pd,\r\nIB_ACCESS_REMOTE_READ |\r\nIB_ACCESS_REMOTE_WRITE |\r\nIB_ACCESS_LOCAL_WRITE);\r\nif (IS_ERR(rds_iwdev->mr))\r\ngoto err_pd;\r\n} else\r\nrds_iwdev->mr = NULL;\r\nrds_iwdev->mr_pool = rds_iw_create_mr_pool(rds_iwdev);\r\nif (IS_ERR(rds_iwdev->mr_pool)) {\r\nrds_iwdev->mr_pool = NULL;\r\ngoto err_mr;\r\n}\r\nINIT_LIST_HEAD(&rds_iwdev->cm_id_list);\r\nINIT_LIST_HEAD(&rds_iwdev->conn_list);\r\nlist_add_tail(&rds_iwdev->list, &rds_iw_devices);\r\nib_set_client_data(device, &rds_iw_client, rds_iwdev);\r\ngoto free_attr;\r\nerr_mr:\r\nif (rds_iwdev->mr)\r\nib_dereg_mr(rds_iwdev->mr);\r\nerr_pd:\r\nib_dealloc_pd(rds_iwdev->pd);\r\nfree_dev:\r\nkfree(rds_iwdev);\r\nfree_attr:\r\nkfree(dev_attr);\r\n}\r\nstatic void rds_iw_remove_one(struct ib_device *device)\r\n{\r\nstruct rds_iw_device *rds_iwdev;\r\nstruct rds_iw_cm_id *i_cm_id, *next;\r\nrds_iwdev = ib_get_client_data(device, &rds_iw_client);\r\nif (!rds_iwdev)\r\nreturn;\r\nspin_lock_irq(&rds_iwdev->spinlock);\r\nlist_for_each_entry_safe(i_cm_id, next, &rds_iwdev->cm_id_list, list) {\r\nlist_del(&i_cm_id->list);\r\nkfree(i_cm_id);\r\n}\r\nspin_unlock_irq(&rds_iwdev->spinlock);\r\nrds_iw_destroy_conns(rds_iwdev);\r\nif (rds_iwdev->mr_pool)\r\nrds_iw_destroy_mr_pool(rds_iwdev->mr_pool);\r\nif (rds_iwdev->mr)\r\nib_dereg_mr(rds_iwdev->mr);\r\nwhile (ib_dealloc_pd(rds_iwdev->pd)) {\r\nrdsdebug("Failed to dealloc pd %p\n", rds_iwdev->pd);\r\nmsleep(1);\r\n}\r\nlist_del(&rds_iwdev->list);\r\nkfree(rds_iwdev);\r\n}\r\nstatic int rds_iw_conn_info_visitor(struct rds_connection *conn,\r\nvoid *buffer)\r\n{\r\nstruct rds_info_rdma_connection *iinfo = buffer;\r\nstruct rds_iw_connection *ic;\r\nif (conn->c_trans != &rds_iw_transport)\r\nreturn 0;\r\niinfo->src_addr = conn->c_laddr;\r\niinfo->dst_addr = conn->c_faddr;\r\nmemset(&iinfo->src_gid, 0, sizeof(iinfo->src_gid));\r\nmemset(&iinfo->dst_gid, 0, sizeof(iinfo->dst_gid));\r\nif (rds_conn_state(conn) == RDS_CONN_UP) {\r\nstruct rds_iw_device *rds_iwdev;\r\nstruct rdma_dev_addr *dev_addr;\r\nic = conn->c_transport_data;\r\ndev_addr = &ic->i_cm_id->route.addr.dev_addr;\r\nrdma_addr_get_sgid(dev_addr, (union ib_gid *) &iinfo->src_gid);\r\nrdma_addr_get_dgid(dev_addr, (union ib_gid *) &iinfo->dst_gid);\r\nrds_iwdev = ib_get_client_data(ic->i_cm_id->device, &rds_iw_client);\r\niinfo->max_send_wr = ic->i_send_ring.w_nr;\r\niinfo->max_recv_wr = ic->i_recv_ring.w_nr;\r\niinfo->max_send_sge = rds_iwdev->max_sge;\r\nrds_iw_get_mr_info(rds_iwdev, iinfo);\r\n}\r\nreturn 1;\r\n}\r\nstatic void rds_iw_ic_info(struct socket *sock, unsigned int len,\r\nstruct rds_info_iterator *iter,\r\nstruct rds_info_lengths *lens)\r\n{\r\nrds_for_each_conn_info(sock, len, iter, lens,\r\nrds_iw_conn_info_visitor,\r\nsizeof(struct rds_info_rdma_connection));\r\n}\r\nstatic int rds_iw_laddr_check(__be32 addr)\r\n{\r\nint ret;\r\nstruct rdma_cm_id *cm_id;\r\nstruct sockaddr_in sin;\r\ncm_id = rdma_create_id(NULL, NULL, RDMA_PS_TCP, IB_QPT_RC);\r\nif (IS_ERR(cm_id))\r\nreturn PTR_ERR(cm_id);\r\nmemset(&sin, 0, sizeof(sin));\r\nsin.sin_family = AF_INET;\r\nsin.sin_addr.s_addr = addr;\r\nret = rdma_bind_addr(cm_id, (struct sockaddr *)&sin);\r\nif (ret || cm_id->device->node_type != RDMA_NODE_RNIC)\r\nret = -EADDRNOTAVAIL;\r\nrdsdebug("addr %pI4 ret %d node type %d\n",\r\n&addr, ret,\r\ncm_id->device ? cm_id->device->node_type : -1);\r\nrdma_destroy_id(cm_id);\r\nreturn ret;\r\n}\r\nvoid rds_iw_exit(void)\r\n{\r\nrds_info_deregister_func(RDS_INFO_IWARP_CONNECTIONS, rds_iw_ic_info);\r\nrds_iw_destroy_nodev_conns();\r\nib_unregister_client(&rds_iw_client);\r\nrds_iw_sysctl_exit();\r\nrds_iw_recv_exit();\r\nrds_trans_unregister(&rds_iw_transport);\r\n}\r\nint rds_iw_init(void)\r\n{\r\nint ret;\r\nINIT_LIST_HEAD(&rds_iw_devices);\r\nret = ib_register_client(&rds_iw_client);\r\nif (ret)\r\ngoto out;\r\nret = rds_iw_sysctl_init();\r\nif (ret)\r\ngoto out_ibreg;\r\nret = rds_iw_recv_init();\r\nif (ret)\r\ngoto out_sysctl;\r\nret = rds_trans_register(&rds_iw_transport);\r\nif (ret)\r\ngoto out_recv;\r\nrds_info_register_func(RDS_INFO_IWARP_CONNECTIONS, rds_iw_ic_info);\r\ngoto out;\r\nout_recv:\r\nrds_iw_recv_exit();\r\nout_sysctl:\r\nrds_iw_sysctl_exit();\r\nout_ibreg:\r\nib_unregister_client(&rds_iw_client);\r\nout:\r\nreturn ret;\r\n}

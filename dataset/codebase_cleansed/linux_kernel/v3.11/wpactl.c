int wpa_set_keys(struct vnt_private *pDevice, void *ctx)\r\n{\r\nstruct viawget_wpa_param *param = ctx;\r\nstruct vnt_manager *pMgmt = &pDevice->vnt_mgmt;\r\nu32 dwKeyIndex = 0;\r\nu8 abyKey[MAX_KEY_LEN];\r\nu8 abySeq[MAX_KEY_LEN];\r\nu64 KeyRSC;\r\nu8 byKeyDecMode = KEY_CTL_WEP;\r\nint ret = 0;\r\nint uu;\r\nint ii;\r\nif (param->u.wpa_key.alg_name > WPA_ALG_CCMP)\r\nreturn -EINVAL;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "param->u.wpa_key.alg_name = %d \n",\r\nparam->u.wpa_key.alg_name);\r\nif (param->u.wpa_key.alg_name == WPA_ALG_NONE) {\r\npDevice->eEncryptionStatus = Ndis802_11EncryptionDisabled;\r\npDevice->bEncryptionEnable = false;\r\npDevice->byKeyIndex = 0;\r\npDevice->bTransmitKey = false;\r\nfor (uu=0; uu<MAX_KEY_TABLE; uu++) {\r\nMACvDisableKeyEntry(pDevice, uu);\r\n}\r\nreturn ret;\r\n}\r\nif (param->u.wpa_key.key && param->u.wpa_key.key_len > sizeof(abyKey))\r\nreturn -EINVAL;\r\nmemcpy(&abyKey[0], param->u.wpa_key.key, param->u.wpa_key.key_len);\r\ndwKeyIndex = (u32)(param->u.wpa_key.key_index);\r\nif (param->u.wpa_key.alg_name == WPA_ALG_WEP) {\r\nif (dwKeyIndex > 3) {\r\nreturn -EINVAL;\r\n} else {\r\nif (param->u.wpa_key.set_tx) {\r\npDevice->byKeyIndex = (u8)dwKeyIndex;\r\npDevice->bTransmitKey = true;\r\ndwKeyIndex |= (1 << 31);\r\n}\r\nKeybSetDefaultKey( pDevice,\r\n&(pDevice->sKey),\r\ndwKeyIndex & ~(BIT30 | USE_KEYRSC),\r\nparam->u.wpa_key.key_len,\r\nNULL,\r\nabyKey,\r\nKEY_CTL_WEP\r\n);\r\n}\r\npDevice->eEncryptionStatus = Ndis802_11Encryption1Enabled;\r\npDevice->bEncryptionEnable = true;\r\nreturn ret;\r\n}\r\nif (param->u.wpa_key.seq && param->u.wpa_key.seq_len > sizeof(abySeq))\r\nreturn -EINVAL;\r\nmemcpy(&abySeq[0], param->u.wpa_key.seq, param->u.wpa_key.seq_len);\r\nif (param->u.wpa_key.seq_len > 0) {\r\nfor (ii = 0 ; ii < param->u.wpa_key.seq_len ; ii++) {\r\nif (ii < 4)\r\nKeyRSC |= (abySeq[ii] << (ii * 8));\r\nelse\r\nKeyRSC |= (abySeq[ii] << ((ii-4) * 8));\r\n}\r\ndwKeyIndex |= 1 << 29;\r\n}\r\nif (param->u.wpa_key.key_index >= MAX_GROUP_KEY) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "return dwKeyIndex > 3\n");\r\nreturn -EINVAL;\r\n}\r\nif (param->u.wpa_key.alg_name == WPA_ALG_TKIP) {\r\npDevice->eEncryptionStatus = Ndis802_11Encryption2Enabled;\r\n}\r\nif (param->u.wpa_key.alg_name == WPA_ALG_CCMP) {\r\npDevice->eEncryptionStatus = Ndis802_11Encryption3Enabled;\r\n}\r\nif (param->u.wpa_key.set_tx)\r\ndwKeyIndex |= (1 << 31);\r\nif (pDevice->eEncryptionStatus == Ndis802_11Encryption3Enabled)\r\nbyKeyDecMode = KEY_CTL_CCMP;\r\nelse if (pDevice->eEncryptionStatus == Ndis802_11Encryption2Enabled)\r\nbyKeyDecMode = KEY_CTL_TKIP;\r\nelse\r\nbyKeyDecMode = KEY_CTL_WEP;\r\nif (pDevice->eEncryptionStatus == Ndis802_11Encryption3Enabled) {\r\nif (param->u.wpa_key.key_len == MAX_KEY_LEN)\r\nbyKeyDecMode = KEY_CTL_TKIP;\r\nelse if (param->u.wpa_key.key_len == WLAN_WEP40_KEYLEN)\r\nbyKeyDecMode = KEY_CTL_WEP;\r\nelse if (param->u.wpa_key.key_len == WLAN_WEP104_KEYLEN)\r\nbyKeyDecMode = KEY_CTL_WEP;\r\n} else if (pDevice->eEncryptionStatus == Ndis802_11Encryption2Enabled) {\r\nif (param->u.wpa_key.key_len == WLAN_WEP40_KEYLEN)\r\nbyKeyDecMode = KEY_CTL_WEP;\r\nelse if (param->u.wpa_key.key_len == WLAN_WEP104_KEYLEN)\r\nbyKeyDecMode = KEY_CTL_WEP;\r\n}\r\nif ((byKeyDecMode == KEY_CTL_TKIP) &&\r\n(param->u.wpa_key.key_len != MAX_KEY_LEN)) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "return - TKIP Key must be 256 bits!\n");\r\nreturn -EINVAL;\r\n}\r\nif ((byKeyDecMode == KEY_CTL_CCMP) &&\r\n(param->u.wpa_key.key_len != AES_KEY_LEN)) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "return - AES Key must be 128 bits\n");\r\nreturn -EINVAL;\r\n}\r\nif (is_broadcast_ether_addr(&param->addr[0]) || (param->addr == NULL)) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Groupe Key Assign.\n");\r\nif ((KeybSetAllGroupKey(pDevice, &(pDevice->sKey), dwKeyIndex,\r\nparam->u.wpa_key.key_len,\r\n&KeyRSC,\r\n(u8 *)abyKey,\r\nbyKeyDecMode\r\n) == true) &&\r\n(KeybSetDefaultKey(pDevice,\r\n&(pDevice->sKey),\r\ndwKeyIndex,\r\nparam->u.wpa_key.key_len,\r\n&KeyRSC,\r\n(u8 *)abyKey,\r\nbyKeyDecMode\r\n) == true) ) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "GROUP Key Assign.\n");\r\n} else {\r\nreturn -EINVAL;\r\n}\r\n} else {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Pairwise Key Assign.\n");\r\nif (byKeyDecMode == KEY_CTL_WEP) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Pairwise Key can't be WEP\n");\r\nreturn -EINVAL;\r\n}\r\ndwKeyIndex |= (1 << 30);\r\nif (pMgmt->eConfigMode == WMAC_CONFIG_IBSS_STA) {\r\nreturn -EINVAL;\r\n}\r\nif (KeybSetKey(pDevice, &(pDevice->sKey), &param->addr[0],\r\ndwKeyIndex, param->u.wpa_key.key_len,\r\n&KeyRSC, (u8 *)abyKey, byKeyDecMode\r\n) == true) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Pairwise Key Set\n");\r\n} else {\r\nif (!compare_ether_addr(&param->addr[0], pDevice->abyBSSID)) {\r\nreturn -EINVAL;\r\n} else {\r\nreturn -EINVAL;\r\n}\r\n}\r\n}\r\nif ((ret == 0) && ((param->u.wpa_key.set_tx) != 0)) {\r\npDevice->byKeyIndex = (u8)param->u.wpa_key.key_index;\r\npDevice->bTransmitKey = true;\r\n}\r\npDevice->bEncryptionEnable = true;\r\nreturn ret;\r\n}

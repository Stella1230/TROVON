static int ade7759_spi_write_reg_8(struct device *dev,\r\nu8 reg_address,\r\nu8 val)\r\n{\r\nint ret;\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7759_state *st = iio_priv(indio_dev);\r\nmutex_lock(&st->buf_lock);\r\nst->tx[0] = ADE7759_WRITE_REG(reg_address);\r\nst->tx[1] = val;\r\nret = spi_write(st->us, st->tx, 2);\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic int ade7759_spi_write_reg_16(struct device *dev,\r\nu8 reg_address,\r\nu16 value)\r\n{\r\nint ret;\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7759_state *st = iio_priv(indio_dev);\r\nmutex_lock(&st->buf_lock);\r\nst->tx[0] = ADE7759_WRITE_REG(reg_address);\r\nst->tx[1] = (value >> 8) & 0xFF;\r\nst->tx[2] = value & 0xFF;\r\nret = spi_write(st->us, st->tx, 3);\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic int ade7759_spi_read_reg_8(struct device *dev,\r\nu8 reg_address,\r\nu8 *val)\r\n{\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7759_state *st = iio_priv(indio_dev);\r\nint ret;\r\nret = spi_w8r8(st->us, ADE7759_READ_REG(reg_address));\r\nif (ret < 0) {\r\ndev_err(&st->us->dev, "problem when reading 8 bit register 0x%02X",\r\nreg_address);\r\nreturn ret;\r\n}\r\n*val = ret;\r\nreturn 0;\r\n}\r\nstatic int ade7759_spi_read_reg_16(struct device *dev,\r\nu8 reg_address,\r\nu16 *val)\r\n{\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7759_state *st = iio_priv(indio_dev);\r\nint ret;\r\nret = spi_w8r16(st->us, ADE7759_READ_REG(reg_address));\r\nif (ret < 0) {\r\ndev_err(&st->us->dev, "problem when reading 16 bit register 0x%02X",\r\nreg_address);\r\nreturn ret;\r\n}\r\n*val = ret;\r\n*val = be16_to_cpup(val);\r\nreturn 0;\r\n}\r\nstatic int ade7759_spi_read_reg_40(struct device *dev,\r\nu8 reg_address,\r\nu64 *val)\r\n{\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7759_state *st = iio_priv(indio_dev);\r\nint ret;\r\nstruct spi_transfer xfers[] = {\r\n{\r\n.tx_buf = st->tx,\r\n.rx_buf = st->rx,\r\n.bits_per_word = 8,\r\n.len = 6,\r\n},\r\n};\r\nmutex_lock(&st->buf_lock);\r\nst->tx[0] = ADE7759_READ_REG(reg_address);\r\nmemset(&st->tx[1], 0 , 5);\r\nret = spi_sync_transfer(st->us, xfers, ARRAY_SIZE(xfers));\r\nif (ret) {\r\ndev_err(&st->us->dev, "problem when reading 40 bit register 0x%02X",\r\nreg_address);\r\ngoto error_ret;\r\n}\r\n*val = ((u64)st->rx[1] << 32) | (st->rx[2] << 24) |\r\n(st->rx[3] << 16) | (st->rx[4] << 8) | st->rx[5];\r\nerror_ret:\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic ssize_t ade7759_read_8bit(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nint ret;\r\nu8 val = 0;\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nret = ade7759_spi_read_reg_8(dev, this_attr->address, &val);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, "%u\n", val);\r\n}\r\nstatic ssize_t ade7759_read_16bit(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nint ret;\r\nu16 val = 0;\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nret = ade7759_spi_read_reg_16(dev, this_attr->address, &val);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, "%u\n", val);\r\n}\r\nstatic ssize_t ade7759_read_40bit(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nint ret;\r\nu64 val = 0;\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nret = ade7759_spi_read_reg_40(dev, this_attr->address, &val);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, "%llu\n", val);\r\n}\r\nstatic ssize_t ade7759_write_8bit(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nint ret;\r\nlong val;\r\nret = strict_strtol(buf, 10, &val);\r\nif (ret)\r\ngoto error_ret;\r\nret = ade7759_spi_write_reg_8(dev, this_attr->address, val);\r\nerror_ret:\r\nreturn ret ? ret : len;\r\n}\r\nstatic ssize_t ade7759_write_16bit(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nint ret;\r\nlong val;\r\nret = strict_strtol(buf, 10, &val);\r\nif (ret)\r\ngoto error_ret;\r\nret = ade7759_spi_write_reg_16(dev, this_attr->address, val);\r\nerror_ret:\r\nreturn ret ? ret : len;\r\n}\r\nstatic int ade7759_reset(struct device *dev)\r\n{\r\nint ret;\r\nu16 val;\r\nade7759_spi_read_reg_16(dev,\r\nADE7759_MODE,\r\n&val);\r\nval |= 1 << 6;\r\nret = ade7759_spi_write_reg_16(dev,\r\nADE7759_MODE,\r\nval);\r\nreturn ret;\r\n}\r\nstatic ssize_t ade7759_write_reset(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nif (len < 1)\r\nreturn -1;\r\nswitch (buf[0]) {\r\ncase '1':\r\ncase 'y':\r\ncase 'Y':\r\nreturn ade7759_reset(dev);\r\n}\r\nreturn -1;\r\n}\r\nstatic int ade7759_set_irq(struct device *dev, bool enable)\r\n{\r\nint ret;\r\nu8 irqen;\r\nret = ade7759_spi_read_reg_8(dev, ADE7759_IRQEN, &irqen);\r\nif (ret)\r\ngoto error_ret;\r\nif (enable)\r\nirqen |= 1 << 3;\r\nelse\r\nirqen &= ~(1 << 3);\r\nret = ade7759_spi_write_reg_8(dev, ADE7759_IRQEN, irqen);\r\nerror_ret:\r\nreturn ret;\r\n}\r\nstatic int ade7759_stop_device(struct device *dev)\r\n{\r\nu16 val;\r\nade7759_spi_read_reg_16(dev,\r\nADE7759_MODE,\r\n&val);\r\nval |= 1 << 4;\r\nreturn ade7759_spi_write_reg_16(dev, ADE7759_MODE, val);\r\n}\r\nstatic int ade7759_initial_setup(struct iio_dev *indio_dev)\r\n{\r\nint ret;\r\nstruct ade7759_state *st = iio_priv(indio_dev);\r\nstruct device *dev = &indio_dev->dev;\r\nst->us->mode = SPI_MODE_3;\r\nspi_setup(st->us);\r\nret = ade7759_set_irq(dev, false);\r\nif (ret) {\r\ndev_err(dev, "disable irq failed");\r\ngoto err_ret;\r\n}\r\nade7759_reset(dev);\r\nmsleep(ADE7759_STARTUP_DELAY);\r\nerr_ret:\r\nreturn ret;\r\n}\r\nstatic ssize_t ade7759_read_frequency(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nint ret;\r\nu16 t;\r\nint sps;\r\nret = ade7759_spi_read_reg_16(dev,\r\nADE7759_MODE,\r\n&t);\r\nif (ret)\r\nreturn ret;\r\nt = (t >> 3) & 0x3;\r\nsps = 27900 / (1 + t);\r\nreturn sprintf(buf, "%d\n", sps);\r\n}\r\nstatic ssize_t ade7759_write_frequency(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7759_state *st = iio_priv(indio_dev);\r\nunsigned long val;\r\nint ret;\r\nu16 reg, t;\r\nret = strict_strtol(buf, 10, &val);\r\nif (ret)\r\nreturn ret;\r\nif (val == 0)\r\nreturn -EINVAL;\r\nmutex_lock(&indio_dev->mlock);\r\nt = (27900 / val);\r\nif (t > 0)\r\nt--;\r\nif (t > 1)\r\nst->us->max_speed_hz = ADE7759_SPI_SLOW;\r\nelse\r\nst->us->max_speed_hz = ADE7759_SPI_FAST;\r\nret = ade7759_spi_read_reg_16(dev, ADE7759_MODE, &reg);\r\nif (ret)\r\ngoto out;\r\nreg &= ~(3 << 13);\r\nreg |= t << 13;\r\nret = ade7759_spi_write_reg_16(dev, ADE7759_MODE, reg);\r\nout:\r\nmutex_unlock(&indio_dev->mlock);\r\nreturn ret ? ret : len;\r\n}\r\nstatic int ade7759_probe(struct spi_device *spi)\r\n{\r\nint ret;\r\nstruct ade7759_state *st;\r\nstruct iio_dev *indio_dev;\r\nindio_dev = iio_device_alloc(sizeof(*st));\r\nif (indio_dev == NULL) {\r\nret = -ENOMEM;\r\ngoto error_ret;\r\n}\r\nspi_set_drvdata(spi, indio_dev);\r\nst = iio_priv(indio_dev);\r\nst->us = spi;\r\nmutex_init(&st->buf_lock);\r\nindio_dev->name = spi->dev.driver->name;\r\nindio_dev->dev.parent = &spi->dev;\r\nindio_dev->info = &ade7759_info;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nret = ade7759_initial_setup(indio_dev);\r\nif (ret)\r\ngoto error_free_dev;\r\nret = iio_device_register(indio_dev);\r\nif (ret)\r\ngoto error_free_dev;\r\nreturn 0;\r\nerror_free_dev:\r\niio_device_free(indio_dev);\r\nerror_ret:\r\nreturn ret;\r\n}\r\nstatic int ade7759_remove(struct spi_device *spi)\r\n{\r\nstruct iio_dev *indio_dev = spi_get_drvdata(spi);\r\niio_device_unregister(indio_dev);\r\nade7759_stop_device(&indio_dev->dev);\r\niio_device_free(indio_dev);\r\nreturn 0;\r\n}

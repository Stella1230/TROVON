static int ast_pci_probe(struct pci_dev *pdev, const struct pci_device_id *ent)\r\n{\r\nreturn drm_get_pci_dev(pdev, ent, &driver);\r\n}\r\nstatic void\r\nast_pci_remove(struct pci_dev *pdev)\r\n{\r\nstruct drm_device *dev = pci_get_drvdata(pdev);\r\ndrm_put_dev(dev);\r\n}\r\nstatic int ast_drm_freeze(struct drm_device *dev)\r\n{\r\ndrm_kms_helper_poll_disable(dev);\r\npci_save_state(dev->pdev);\r\nconsole_lock();\r\nast_fbdev_set_suspend(dev, 1);\r\nconsole_unlock();\r\nreturn 0;\r\n}\r\nstatic int ast_drm_thaw(struct drm_device *dev)\r\n{\r\nint error = 0;\r\nast_post_gpu(dev);\r\ndrm_mode_config_reset(dev);\r\ndrm_modeset_lock_all(dev);\r\ndrm_helper_resume_force_mode(dev);\r\ndrm_modeset_unlock_all(dev);\r\nconsole_lock();\r\nast_fbdev_set_suspend(dev, 0);\r\nconsole_unlock();\r\nreturn error;\r\n}\r\nstatic int ast_drm_resume(struct drm_device *dev)\r\n{\r\nint ret;\r\nif (pci_enable_device(dev->pdev))\r\nreturn -EIO;\r\nret = ast_drm_thaw(dev);\r\nif (ret)\r\nreturn ret;\r\ndrm_kms_helper_poll_enable(dev);\r\nreturn 0;\r\n}\r\nstatic int ast_pm_suspend(struct device *dev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(dev);\r\nstruct drm_device *ddev = pci_get_drvdata(pdev);\r\nint error;\r\nerror = ast_drm_freeze(ddev);\r\nif (error)\r\nreturn error;\r\npci_disable_device(pdev);\r\npci_set_power_state(pdev, PCI_D3hot);\r\nreturn 0;\r\n}\r\nstatic int ast_pm_resume(struct device *dev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(dev);\r\nstruct drm_device *ddev = pci_get_drvdata(pdev);\r\nreturn ast_drm_resume(ddev);\r\n}\r\nstatic int ast_pm_freeze(struct device *dev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(dev);\r\nstruct drm_device *ddev = pci_get_drvdata(pdev);\r\nif (!ddev || !ddev->dev_private)\r\nreturn -ENODEV;\r\nreturn ast_drm_freeze(ddev);\r\n}\r\nstatic int ast_pm_thaw(struct device *dev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(dev);\r\nstruct drm_device *ddev = pci_get_drvdata(pdev);\r\nreturn ast_drm_thaw(ddev);\r\n}\r\nstatic int ast_pm_poweroff(struct device *dev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(dev);\r\nstruct drm_device *ddev = pci_get_drvdata(pdev);\r\nreturn ast_drm_freeze(ddev);\r\n}\r\nstatic int __init ast_init(void)\r\n{\r\n#ifdef CONFIG_VGA_CONSOLE\r\nif (vgacon_text_force() && ast_modeset == -1)\r\nreturn -EINVAL;\r\n#endif\r\nif (ast_modeset == 0)\r\nreturn -EINVAL;\r\nreturn drm_pci_init(&driver, &ast_pci_driver);\r\n}\r\nstatic void __exit ast_exit(void)\r\n{\r\ndrm_pci_exit(&driver, &ast_pci_driver);\r\n}

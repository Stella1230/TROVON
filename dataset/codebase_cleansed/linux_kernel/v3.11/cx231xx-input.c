static int get_key_isdbt(struct IR_i2c *ir, u32 *ir_key,\r\nu32 *ir_raw)\r\n{\r\nint rc;\r\nu8 cmd, scancode;\r\ndev_dbg(&ir->rc->input_dev->dev, "%s\n", __func__);\r\nrc = i2c_master_recv(ir->c, &cmd, 1);\r\nif (rc < 0)\r\nreturn rc;\r\nif (rc != 1)\r\nreturn -EIO;\r\nif (cmd == 0xff)\r\nreturn 0;\r\nscancode =\r\n((cmd & 0x01) ? 0x80 : 0) |\r\n((cmd & 0x02) ? 0x40 : 0) |\r\n((cmd & 0x04) ? 0x20 : 0) |\r\n((cmd & 0x08) ? 0x10 : 0) |\r\n((cmd & 0x10) ? 0x08 : 0) |\r\n((cmd & 0x20) ? 0x04 : 0) |\r\n((cmd & 0x40) ? 0x02 : 0) |\r\n((cmd & 0x80) ? 0x01 : 0);\r\ndev_dbg(&ir->rc->input_dev->dev, "cmd %02x, scan = %02x\n",\r\ncmd, scancode);\r\n*ir_key = scancode;\r\n*ir_raw = scancode;\r\nreturn 1;\r\n}\r\nint cx231xx_ir_init(struct cx231xx *dev)\r\n{\r\nstruct i2c_board_info info;\r\nu8 ir_i2c_bus;\r\ndev_dbg(&dev->udev->dev, "%s\n", __func__);\r\nif (!cx231xx_boards[dev->model].rc_map_name)\r\nreturn -ENODEV;\r\nrequest_module("ir-kbd-i2c");\r\nmemset(&info, 0, sizeof(struct i2c_board_info));\r\nmemset(&dev->init_data, 0, sizeof(dev->init_data));\r\ndev->init_data.rc_dev = rc_allocate_device();\r\nif (!dev->init_data.rc_dev)\r\nreturn -ENOMEM;\r\ndev->init_data.name = cx231xx_boards[dev->model].name;\r\nstrlcpy(info.type, "ir_video", I2C_NAME_SIZE);\r\ninfo.platform_data = &dev->init_data;\r\ndev->init_data.get_key = get_key_isdbt;\r\ndev->init_data.ir_codes = cx231xx_boards[dev->model].rc_map_name;\r\ndev->init_data.rc_dev->scanmask = 0xff;\r\ndev->init_data.rc_dev->driver_name = "cx231xx";\r\ndev->init_data.type = RC_BIT_NEC;\r\ninfo.addr = 0x30;\r\nir_i2c_bus = cx231xx_boards[dev->model].ir_i2c_master;\r\ndev_dbg(&dev->udev->dev, "Trying to bind ir at bus %d, addr 0x%02x\n",\r\nir_i2c_bus, info.addr);\r\ndev->ir_i2c_client = i2c_new_device(&dev->i2c_bus[ir_i2c_bus].i2c_adap, &info);\r\nreturn 0;\r\n}\r\nvoid cx231xx_ir_exit(struct cx231xx *dev)\r\n{\r\nif (dev->ir_i2c_client)\r\ni2c_unregister_device(dev->ir_i2c_client);\r\ndev->ir_i2c_client = NULL;\r\n}

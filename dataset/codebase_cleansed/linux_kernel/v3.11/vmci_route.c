int vmci_route(struct vmci_handle *src,\r\nconst struct vmci_handle *dst,\r\nbool from_guest,\r\nenum vmci_route *route)\r\n{\r\nbool has_host_device = vmci_host_code_active();\r\nbool has_guest_device = vmci_guest_code_active();\r\n*route = VMCI_ROUTE_NONE;\r\nif (VMCI_INVALID_ID == dst->context)\r\nreturn VMCI_ERROR_INVALID_ARGS;\r\nif (VMCI_HYPERVISOR_CONTEXT_ID == dst->context) {\r\nif (from_guest)\r\nreturn VMCI_ERROR_DST_UNREACHABLE;\r\nif (!has_guest_device)\r\nreturn VMCI_ERROR_DEVICE_NOT_FOUND;\r\nif (VMCI_HOST_CONTEXT_ID == src->context)\r\nreturn VMCI_ERROR_INVALID_ARGS;\r\nif (VMCI_INVALID_ID == src->context &&\r\nVMCI_INVALID_ID != src->resource)\r\nsrc->context = vmci_get_context_id();\r\n*route = VMCI_ROUTE_AS_GUEST;\r\nreturn VMCI_SUCCESS;\r\n}\r\nif (VMCI_HOST_CONTEXT_ID == dst->context) {\r\nif (src->context == VMCI_HYPERVISOR_CONTEXT_ID) {\r\nif (has_host_device) {\r\n*route = VMCI_ROUTE_AS_HOST;\r\nreturn VMCI_SUCCESS;\r\n} else {\r\nreturn VMCI_ERROR_DEVICE_NOT_FOUND;\r\n}\r\n}\r\nif (!from_guest && has_guest_device) {\r\nif (VMCI_INVALID_ID == src->context)\r\nsrc->context = vmci_get_context_id();\r\n*route = VMCI_ROUTE_AS_GUEST;\r\nreturn VMCI_SUCCESS;\r\n}\r\nif (!has_host_device)\r\nreturn VMCI_ERROR_DEVICE_NOT_FOUND;\r\nif (VMCI_INVALID_ID == src->context) {\r\nif (from_guest)\r\nreturn VMCI_ERROR_INVALID_ARGS;\r\nsrc->context = VMCI_HOST_CONTEXT_ID;\r\n}\r\n*route = VMCI_ROUTE_AS_HOST;\r\nreturn VMCI_SUCCESS;\r\n}\r\nif (has_host_device) {\r\nif (vmci_ctx_exists(dst->context)) {\r\nif (VMCI_INVALID_ID == src->context) {\r\nif (from_guest)\r\nreturn VMCI_ERROR_INVALID_ARGS;\r\nsrc->context = VMCI_HOST_CONTEXT_ID;\r\n} else if (VMCI_CONTEXT_IS_VM(src->context) &&\r\nsrc->context != dst->context) {\r\nreturn VMCI_ERROR_DST_UNREACHABLE;\r\n}\r\n*route = VMCI_ROUTE_AS_HOST;\r\nreturn VMCI_SUCCESS;\r\n} else if (!has_guest_device) {\r\nreturn VMCI_ERROR_DST_UNREACHABLE;\r\n}\r\n}\r\nif (!has_guest_device) {\r\nreturn VMCI_ERROR_DEVICE_NOT_FOUND;\r\n}\r\nif (VMCI_INVALID_ID == src->context)\r\nsrc->context = vmci_get_context_id();\r\n*route = VMCI_ROUTE_AS_GUEST;\r\nreturn VMCI_SUCCESS;\r\n}

int pciehp_acpi_slot_detection_check(struct pci_dev *dev)\r\n{\r\nif (slot_detection_mode != PCIEHP_DETECT_ACPI)\r\nreturn 0;\r\nif (acpi_pci_detect_ejectable(DEVICE_ACPI_HANDLE(&dev->dev)))\r\nreturn 0;\r\nreturn -ENODEV;\r\n}\r\nstatic int __init parse_detect_mode(void)\r\n{\r\nif (!pciehp_detect_mode)\r\nreturn PCIEHP_DETECT_DEFAULT;\r\nif (!strcmp(pciehp_detect_mode, "pcie"))\r\nreturn PCIEHP_DETECT_PCIE;\r\nif (!strcmp(pciehp_detect_mode, "acpi"))\r\nreturn PCIEHP_DETECT_ACPI;\r\nif (!strcmp(pciehp_detect_mode, "auto"))\r\nreturn PCIEHP_DETECT_AUTO;\r\nwarn("bad specifier '%s' for pciehp_detect_mode. Use default\n",\r\npciehp_detect_mode);\r\nreturn PCIEHP_DETECT_DEFAULT;\r\n}\r\nstatic int __init dummy_probe(struct pcie_device *dev)\r\n{\r\nu32 slot_cap;\r\nacpi_handle handle;\r\nstruct dummy_slot *slot, *tmp;\r\nstruct pci_dev *pdev = dev->port;\r\npcie_capability_read_dword(pdev, PCI_EXP_SLTCAP, &slot_cap);\r\nslot = kzalloc(sizeof(*slot), GFP_KERNEL);\r\nif (!slot)\r\nreturn -ENOMEM;\r\nslot->number = (slot_cap & PCI_EXP_SLTCAP_PSN) >> 19;\r\nlist_for_each_entry(tmp, &dummy_slots, list) {\r\nif (tmp->number == slot->number)\r\ndup_slot_id++;\r\n}\r\nlist_add_tail(&slot->list, &dummy_slots);\r\nhandle = DEVICE_ACPI_HANDLE(&pdev->dev);\r\nif (!acpi_slot_detected && acpi_pci_detect_ejectable(handle))\r\nacpi_slot_detected = 1;\r\nreturn -ENODEV;\r\n}\r\nstatic int __init select_detection_mode(void)\r\n{\r\nstruct dummy_slot *slot, *tmp;\r\nif (pcie_port_service_register(&dummy_driver))\r\nreturn PCIEHP_DETECT_ACPI;\r\npcie_port_service_unregister(&dummy_driver);\r\nlist_for_each_entry_safe(slot, tmp, &dummy_slots, list) {\r\nlist_del(&slot->list);\r\nkfree(slot);\r\n}\r\nif (acpi_slot_detected && dup_slot_id)\r\nreturn PCIEHP_DETECT_ACPI;\r\nreturn PCIEHP_DETECT_PCIE;\r\n}\r\nvoid __init pciehp_acpi_slot_detection_init(void)\r\n{\r\nslot_detection_mode = parse_detect_mode();\r\nif (slot_detection_mode != PCIEHP_DETECT_AUTO)\r\ngoto out;\r\nslot_detection_mode = select_detection_mode();\r\nout:\r\nif (slot_detection_mode == PCIEHP_DETECT_ACPI)\r\ninfo("Using ACPI for slot detection.\n");\r\n}

static struct sch5627_data *sch5627_update_device(struct device *dev)\r\n{\r\nstruct sch5627_data *data = dev_get_drvdata(dev);\r\nstruct sch5627_data *ret = data;\r\nint i, val;\r\nmutex_lock(&data->update_lock);\r\nif (time_after(jiffies, data->last_battery + 300 * HZ)) {\r\nsch56xx_write_virtual_reg(data->addr, SCH5627_REG_CTRL,\r\ndata->control | 0x10);\r\ndata->last_battery = jiffies;\r\n}\r\nif (time_after(jiffies, data->last_updated + HZ) || !data->valid) {\r\nfor (i = 0; i < SCH5627_NO_TEMPS; i++) {\r\nval = sch56xx_read_virtual_reg12(data->addr,\r\nSCH5627_REG_TEMP_MSB[i],\r\nSCH5627_REG_TEMP_LSN[i],\r\nSCH5627_REG_TEMP_HIGH_NIBBLE[i]);\r\nif (unlikely(val < 0)) {\r\nret = ERR_PTR(val);\r\ngoto abort;\r\n}\r\ndata->temp[i] = val;\r\n}\r\nfor (i = 0; i < SCH5627_NO_FANS; i++) {\r\nval = sch56xx_read_virtual_reg16(data->addr,\r\nSCH5627_REG_FAN[i]);\r\nif (unlikely(val < 0)) {\r\nret = ERR_PTR(val);\r\ngoto abort;\r\n}\r\ndata->fan[i] = val;\r\n}\r\nfor (i = 0; i < SCH5627_NO_IN; i++) {\r\nval = sch56xx_read_virtual_reg12(data->addr,\r\nSCH5627_REG_IN_MSB[i],\r\nSCH5627_REG_IN_LSN[i],\r\nSCH5627_REG_IN_HIGH_NIBBLE[i]);\r\nif (unlikely(val < 0)) {\r\nret = ERR_PTR(val);\r\ngoto abort;\r\n}\r\ndata->in[i] = val;\r\n}\r\ndata->last_updated = jiffies;\r\ndata->valid = 1;\r\n}\r\nabort:\r\nmutex_unlock(&data->update_lock);\r\nreturn ret;\r\n}\r\nstatic int sch5627_read_limits(struct sch5627_data *data)\r\n{\r\nint i, val;\r\nfor (i = 0; i < SCH5627_NO_TEMPS; i++) {\r\nval = sch56xx_read_virtual_reg(data->addr,\r\nSCH5627_REG_TEMP_ABS[i]);\r\nif (val < 0)\r\nreturn val;\r\ndata->temp_max[i] = val;\r\nval = sch56xx_read_virtual_reg(data->addr,\r\nSCH5627_REG_TEMP_HIGH[i]);\r\nif (val < 0)\r\nreturn val;\r\ndata->temp_crit[i] = val;\r\n}\r\nfor (i = 0; i < SCH5627_NO_FANS; i++) {\r\nval = sch56xx_read_virtual_reg16(data->addr,\r\nSCH5627_REG_FAN_MIN[i]);\r\nif (val < 0)\r\nreturn val;\r\ndata->fan_min[i] = val;\r\n}\r\nreturn 0;\r\n}\r\nstatic int reg_to_temp(u16 reg)\r\n{\r\nreturn (reg * 625) / 10 - 64000;\r\n}\r\nstatic int reg_to_temp_limit(u8 reg)\r\n{\r\nreturn (reg - 64) * 1000;\r\n}\r\nstatic int reg_to_rpm(u16 reg)\r\n{\r\nif (reg == 0)\r\nreturn -EIO;\r\nif (reg == 0xffff)\r\nreturn 0;\r\nreturn 5400540 / reg;\r\n}\r\nstatic ssize_t show_name(struct device *dev, struct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nreturn snprintf(buf, PAGE_SIZE, "%s\n", DEVNAME);\r\n}\r\nstatic ssize_t show_temp(struct device *dev, struct device_attribute\r\n*devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct sch5627_data *data = sch5627_update_device(dev);\r\nint val;\r\nif (IS_ERR(data))\r\nreturn PTR_ERR(data);\r\nval = reg_to_temp(data->temp[attr->index]);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", val);\r\n}\r\nstatic ssize_t show_temp_fault(struct device *dev, struct device_attribute\r\n*devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct sch5627_data *data = sch5627_update_device(dev);\r\nif (IS_ERR(data))\r\nreturn PTR_ERR(data);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", data->temp[attr->index] == 0);\r\n}\r\nstatic ssize_t show_temp_max(struct device *dev, struct device_attribute\r\n*devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct sch5627_data *data = dev_get_drvdata(dev);\r\nint val;\r\nval = reg_to_temp_limit(data->temp_max[attr->index]);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", val);\r\n}\r\nstatic ssize_t show_temp_crit(struct device *dev, struct device_attribute\r\n*devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct sch5627_data *data = dev_get_drvdata(dev);\r\nint val;\r\nval = reg_to_temp_limit(data->temp_crit[attr->index]);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", val);\r\n}\r\nstatic ssize_t show_fan(struct device *dev, struct device_attribute\r\n*devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct sch5627_data *data = sch5627_update_device(dev);\r\nint val;\r\nif (IS_ERR(data))\r\nreturn PTR_ERR(data);\r\nval = reg_to_rpm(data->fan[attr->index]);\r\nif (val < 0)\r\nreturn val;\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", val);\r\n}\r\nstatic ssize_t show_fan_fault(struct device *dev, struct device_attribute\r\n*devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct sch5627_data *data = sch5627_update_device(dev);\r\nif (IS_ERR(data))\r\nreturn PTR_ERR(data);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n",\r\ndata->fan[attr->index] == 0xffff);\r\n}\r\nstatic ssize_t show_fan_min(struct device *dev, struct device_attribute\r\n*devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct sch5627_data *data = dev_get_drvdata(dev);\r\nint val = reg_to_rpm(data->fan_min[attr->index]);\r\nif (val < 0)\r\nreturn val;\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", val);\r\n}\r\nstatic ssize_t show_in(struct device *dev, struct device_attribute\r\n*devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct sch5627_data *data = sch5627_update_device(dev);\r\nint val;\r\nif (IS_ERR(data))\r\nreturn PTR_ERR(data);\r\nval = DIV_ROUND_CLOSEST(\r\ndata->in[attr->index] * SCH5627_REG_IN_FACTOR[attr->index],\r\n10000);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", val);\r\n}\r\nstatic ssize_t show_in_label(struct device *dev, struct device_attribute\r\n*devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nreturn snprintf(buf, PAGE_SIZE, "%s\n",\r\nSCH5627_IN_LABELS[attr->index]);\r\n}\r\nstatic int sch5627_remove(struct platform_device *pdev)\r\n{\r\nstruct sch5627_data *data = platform_get_drvdata(pdev);\r\nif (data->watchdog)\r\nsch56xx_watchdog_unregister(data->watchdog);\r\nif (data->hwmon_dev)\r\nhwmon_device_unregister(data->hwmon_dev);\r\nsysfs_remove_group(&pdev->dev.kobj, &sch5627_group);\r\nreturn 0;\r\n}\r\nstatic int sch5627_probe(struct platform_device *pdev)\r\n{\r\nstruct sch5627_data *data;\r\nint err, build_code, build_id, hwmon_rev, val;\r\ndata = devm_kzalloc(&pdev->dev, sizeof(struct sch5627_data),\r\nGFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\ndata->addr = platform_get_resource(pdev, IORESOURCE_IO, 0)->start;\r\nmutex_init(&data->update_lock);\r\nplatform_set_drvdata(pdev, data);\r\nval = sch56xx_read_virtual_reg(data->addr, SCH5627_REG_HWMON_ID);\r\nif (val < 0) {\r\nerr = val;\r\ngoto error;\r\n}\r\nif (val != SCH5627_HWMON_ID) {\r\npr_err("invalid %s id: 0x%02X (expected 0x%02X)\n", "hwmon",\r\nval, SCH5627_HWMON_ID);\r\nerr = -ENODEV;\r\ngoto error;\r\n}\r\nval = sch56xx_read_virtual_reg(data->addr, SCH5627_REG_COMPANY_ID);\r\nif (val < 0) {\r\nerr = val;\r\ngoto error;\r\n}\r\nif (val != SCH5627_COMPANY_ID) {\r\npr_err("invalid %s id: 0x%02X (expected 0x%02X)\n", "company",\r\nval, SCH5627_COMPANY_ID);\r\nerr = -ENODEV;\r\ngoto error;\r\n}\r\nval = sch56xx_read_virtual_reg(data->addr, SCH5627_REG_PRIMARY_ID);\r\nif (val < 0) {\r\nerr = val;\r\ngoto error;\r\n}\r\nif (val != SCH5627_PRIMARY_ID) {\r\npr_err("invalid %s id: 0x%02X (expected 0x%02X)\n", "primary",\r\nval, SCH5627_PRIMARY_ID);\r\nerr = -ENODEV;\r\ngoto error;\r\n}\r\nbuild_code = sch56xx_read_virtual_reg(data->addr,\r\nSCH5627_REG_BUILD_CODE);\r\nif (build_code < 0) {\r\nerr = build_code;\r\ngoto error;\r\n}\r\nbuild_id = sch56xx_read_virtual_reg16(data->addr,\r\nSCH5627_REG_BUILD_ID);\r\nif (build_id < 0) {\r\nerr = build_id;\r\ngoto error;\r\n}\r\nhwmon_rev = sch56xx_read_virtual_reg(data->addr,\r\nSCH5627_REG_HWMON_REV);\r\nif (hwmon_rev < 0) {\r\nerr = hwmon_rev;\r\ngoto error;\r\n}\r\nval = sch56xx_read_virtual_reg(data->addr, SCH5627_REG_CTRL);\r\nif (val < 0) {\r\nerr = val;\r\ngoto error;\r\n}\r\ndata->control = val;\r\nif (!(data->control & 0x01)) {\r\npr_err("hardware monitoring not enabled\n");\r\nerr = -ENODEV;\r\ngoto error;\r\n}\r\nsch56xx_write_virtual_reg(data->addr, SCH5627_REG_CTRL,\r\ndata->control | 0x10);\r\ndata->last_battery = jiffies;\r\nerr = sch5627_read_limits(data);\r\nif (err)\r\ngoto error;\r\npr_info("found %s chip at %#hx\n", DEVNAME, data->addr);\r\npr_info("firmware build: code 0x%02X, id 0x%04X, hwmon: rev 0x%02X\n",\r\nbuild_code, build_id, hwmon_rev);\r\nerr = sysfs_create_group(&pdev->dev.kobj, &sch5627_group);\r\nif (err)\r\ngoto error;\r\ndata->hwmon_dev = hwmon_device_register(&pdev->dev);\r\nif (IS_ERR(data->hwmon_dev)) {\r\nerr = PTR_ERR(data->hwmon_dev);\r\ndata->hwmon_dev = NULL;\r\ngoto error;\r\n}\r\ndata->watchdog = sch56xx_watchdog_register(&pdev->dev, data->addr,\r\n(build_code << 24) | (build_id << 8) | hwmon_rev,\r\n&data->update_lock, 1);\r\nreturn 0;\r\nerror:\r\nsch5627_remove(pdev);\r\nreturn err;\r\n}

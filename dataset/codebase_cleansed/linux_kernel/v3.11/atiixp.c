static void atiixp_set_pio_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nunsigned long flags;\r\nint timing_shift = (drive->dn ^ 1) * 8;\r\nu32 pio_timing_data;\r\nu16 pio_mode_data;\r\nconst u8 pio = drive->pio_mode - XFER_PIO_0;\r\nspin_lock_irqsave(&atiixp_lock, flags);\r\npci_read_config_word(dev, ATIIXP_IDE_PIO_MODE, &pio_mode_data);\r\npio_mode_data &= ~(0x07 << (drive->dn * 4));\r\npio_mode_data |= (pio << (drive->dn * 4));\r\npci_write_config_word(dev, ATIIXP_IDE_PIO_MODE, pio_mode_data);\r\npci_read_config_dword(dev, ATIIXP_IDE_PIO_TIMING, &pio_timing_data);\r\npio_timing_data &= ~(0xff << timing_shift);\r\npio_timing_data |= (pio_timing[pio].recover_width << timing_shift) |\r\n(pio_timing[pio].command_width << (timing_shift + 4));\r\npci_write_config_dword(dev, ATIIXP_IDE_PIO_TIMING, pio_timing_data);\r\nspin_unlock_irqrestore(&atiixp_lock, flags);\r\n}\r\nstatic void atiixp_set_dma_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nunsigned long flags;\r\nint timing_shift = (drive->dn ^ 1) * 8;\r\nu32 tmp32;\r\nu16 tmp16;\r\nu16 udma_ctl = 0;\r\nconst u8 speed = drive->dma_mode;\r\nspin_lock_irqsave(&atiixp_lock, flags);\r\npci_read_config_word(dev, ATIIXP_IDE_UDMA_CONTROL, &udma_ctl);\r\nif (speed >= XFER_UDMA_0) {\r\npci_read_config_word(dev, ATIIXP_IDE_UDMA_MODE, &tmp16);\r\ntmp16 &= ~(0x07 << (drive->dn * 4));\r\ntmp16 |= ((speed & 0x07) << (drive->dn * 4));\r\npci_write_config_word(dev, ATIIXP_IDE_UDMA_MODE, tmp16);\r\nudma_ctl |= (1 << drive->dn);\r\n} else if (speed >= XFER_MW_DMA_0) {\r\nu8 i = speed & 0x03;\r\npci_read_config_dword(dev, ATIIXP_IDE_MDMA_TIMING, &tmp32);\r\ntmp32 &= ~(0xff << timing_shift);\r\ntmp32 |= (mdma_timing[i].recover_width << timing_shift) |\r\n(mdma_timing[i].command_width << (timing_shift + 4));\r\npci_write_config_dword(dev, ATIIXP_IDE_MDMA_TIMING, tmp32);\r\nudma_ctl &= ~(1 << drive->dn);\r\n}\r\npci_write_config_word(dev, ATIIXP_IDE_UDMA_CONTROL, udma_ctl);\r\nspin_unlock_irqrestore(&atiixp_lock, flags);\r\n}\r\nstatic u8 atiixp_cable_detect(ide_hwif_t *hwif)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(hwif->dev);\r\nu8 udma_mode = 0, ch = hwif->channel;\r\npci_read_config_byte(pdev, ATIIXP_IDE_UDMA_MODE + ch, &udma_mode);\r\nif ((udma_mode & 0x07) >= 0x04 || (udma_mode & 0x70) >= 0x40)\r\nreturn ATA_CBL_PATA80;\r\nelse\r\nreturn ATA_CBL_PATA40;\r\n}\r\nstatic int atiixp_init_one(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nreturn ide_pci_init_one(dev, &atiixp_pci_info[id->driver_data], NULL);\r\n}\r\nstatic int __init atiixp_ide_init(void)\r\n{\r\nreturn ide_pci_register_driver(&atiixp_pci_driver);\r\n}\r\nstatic void __exit atiixp_ide_exit(void)\r\n{\r\npci_unregister_driver(&atiixp_pci_driver);\r\n}

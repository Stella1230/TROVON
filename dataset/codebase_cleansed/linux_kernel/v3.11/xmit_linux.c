static uint remainder_len(struct pkt_file *pfile)\r\n{\r\nreturn (uint)(pfile->buf_len - ((addr_t)(pfile->cur_addr) -\r\n(addr_t)(pfile->buf_start)));\r\n}\r\nvoid _r8712_open_pktfile(_pkt *pktptr, struct pkt_file *pfile)\r\n{\r\npfile->pkt = pktptr;\r\npfile->cur_addr = pfile->buf_start = pktptr->data;\r\npfile->pkt_len = pfile->buf_len = pktptr->len;\r\npfile->cur_buffer = pfile->buf_start ;\r\n}\r\nuint _r8712_pktfile_read(struct pkt_file *pfile, u8 *rmem, uint rlen)\r\n{\r\nuint len;\r\nlen = remainder_len(pfile);\r\nlen = (rlen > len) ? len : rlen;\r\nif (rmem)\r\nskb_copy_bits(pfile->pkt, pfile->buf_len - pfile->pkt_len,\r\nrmem, len);\r\npfile->cur_addr += len;\r\npfile->pkt_len -= len;\r\nreturn len;\r\n}\r\nsint r8712_endofpktfile(struct pkt_file *pfile)\r\n{\r\nif (pfile->pkt_len == 0)\r\nreturn true;\r\nelse\r\nreturn false;\r\n}\r\nvoid r8712_set_qos(struct pkt_file *ppktfile, struct pkt_attrib *pattrib)\r\n{\r\nint i;\r\nstruct ethhdr etherhdr;\r\nstruct iphdr ip_hdr;\r\nu16 UserPriority = 0;\r\n_r8712_open_pktfile(ppktfile->pkt, ppktfile);\r\n_r8712_pktfile_read(ppktfile, (unsigned char *)&etherhdr, ETH_HLEN);\r\nif (pattrib->ether_type == 0x0800) {\r\ni = _r8712_pktfile_read(ppktfile, (u8 *)&ip_hdr,\r\nsizeof(ip_hdr));\r\nUserPriority = ip_hdr.tos >> 5;\r\n} else {\r\nif (pattrib->ether_type == 0x888e)\r\nUserPriority = 7;\r\n}\r\npattrib->priority = UserPriority;\r\npattrib->hdrlen = WLAN_HDR_A3_QOS_LEN;\r\npattrib->subtype = WIFI_QOS_DATA_TYPE;\r\n}\r\nvoid r8712_SetFilter(struct work_struct *work)\r\n{\r\nstruct _adapter *padapter = container_of(work, struct _adapter,\r\nwkFilterRxFF0);\r\nu8 oldvalue = 0x00, newvalue = 0x00;\r\nunsigned long irqL;\r\noldvalue = r8712_read8(padapter, 0x117);\r\nnewvalue = oldvalue & 0xfe;\r\nr8712_write8(padapter, 0x117, newvalue);\r\nspin_lock_irqsave(&padapter->lockRxFF0Filter, irqL);\r\npadapter->blnEnableRxFF0Filter = 1;\r\nspin_unlock_irqrestore(&padapter->lockRxFF0Filter, irqL);\r\ndo {\r\nmsleep(100);\r\n} while (padapter->blnEnableRxFF0Filter == 1);\r\nr8712_write8(padapter, 0x117, oldvalue);\r\n}\r\nint r8712_xmit_resource_alloc(struct _adapter *padapter,\r\nstruct xmit_buf *pxmitbuf)\r\n{\r\nint i;\r\nfor (i = 0; i < 8; i++) {\r\npxmitbuf->pxmit_urb[i] = usb_alloc_urb(0, GFP_KERNEL);\r\nif (pxmitbuf->pxmit_urb[i] == NULL) {\r\nnetdev_err(padapter->pnetdev, "pxmitbuf->pxmit_urb[i] == NULL\n");\r\nreturn _FAIL;\r\n}\r\n}\r\nreturn _SUCCESS;\r\n}\r\nvoid r8712_xmit_resource_free(struct _adapter *padapter,\r\nstruct xmit_buf *pxmitbuf)\r\n{\r\nint i;\r\nfor (i = 0; i < 8; i++) {\r\nif (pxmitbuf->pxmit_urb[i]) {\r\nusb_kill_urb(pxmitbuf->pxmit_urb[i]);\r\nusb_free_urb(pxmitbuf->pxmit_urb[i]);\r\n}\r\n}\r\n}\r\nvoid r8712_xmit_complete(struct _adapter *padapter, struct xmit_frame *pxframe)\r\n{\r\nif (pxframe->pkt)\r\ndev_kfree_skb_any(pxframe->pkt);\r\npxframe->pkt = NULL;\r\n}\r\nint r8712_xmit_entry(_pkt *pkt, struct net_device *pnetdev)\r\n{\r\nstruct xmit_frame *pxmitframe = NULL;\r\nstruct _adapter *padapter = (struct _adapter *)netdev_priv(pnetdev);\r\nstruct xmit_priv *pxmitpriv = &(padapter->xmitpriv);\r\nint ret = 0;\r\nif (r8712_if_up(padapter) == false) {\r\nret = 0;\r\ngoto _xmit_entry_drop;\r\n}\r\npxmitframe = r8712_alloc_xmitframe(pxmitpriv);\r\nif (pxmitframe == NULL) {\r\nret = 0;\r\ngoto _xmit_entry_drop;\r\n}\r\nif ((!r8712_update_attrib(padapter, pkt, &pxmitframe->attrib))) {\r\nret = 0;\r\ngoto _xmit_entry_drop;\r\n}\r\npadapter->ledpriv.LedControlHandler(padapter, LED_CTL_TX);\r\npxmitframe->pkt = pkt;\r\nif (r8712_pre_xmit(padapter, pxmitframe) == true) {\r\ndev_kfree_skb_any(pkt);\r\npxmitframe->pkt = NULL;\r\n}\r\npxmitpriv->tx_pkts++;\r\npxmitpriv->tx_bytes += pxmitframe->attrib.last_txcmdsz;\r\nreturn ret;\r\n_xmit_entry_drop:\r\nif (pxmitframe)\r\nr8712_free_xmitframe(pxmitpriv, pxmitframe);\r\npxmitpriv->tx_drop++;\r\ndev_kfree_skb_any(pkt);\r\nreturn ret;\r\n}

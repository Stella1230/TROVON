static void\r\ngenCrcTable(u_int32_t *CRCTable)\r\n{\r\nint ii, jj;\r\nu_int32_t crc;\r\nfor (ii = 0; ii < CRC_TABLE_ENTRIES; ii++) {\r\ncrc = ii;\r\nfor (jj = 8; jj > 0; jj--) {\r\nif (crc & 1)\r\ncrc = (crc >> 1) ^ CRC32_POLYNOMIAL;\r\nelse\r\ncrc >>= 1;\r\n}\r\nCRCTable[ii] = crc;\r\n}\r\ncrcTableInit++;\r\n}\r\nvoid\r\nsbeCrc(u_int8_t *buffer,\r\nu_int32_t count,\r\nu_int32_t initialCrc,\r\nu_int32_t *result)\r\n{\r\nu_int32_t *tbl = 0;\r\nu_int32_t temp1, temp2, crc;\r\nif (!crcTableInit) {\r\n#ifdef STATIC_CRC_TABLE\r\ntbl = &CRCTable;\r\ngenCrcTable(tbl);\r\n#else\r\ntbl = (u_int32_t *) OS_kmalloc(CRC_TABLE_ENTRIES * sizeof(u_int32_t));\r\nif (tbl == 0) {\r\n*result = 0;\r\nreturn;\r\n}\r\ngenCrcTable(tbl);\r\n#endif\r\n}\r\ncrc = initialCrc ^ 0xFFFFFFFFL;\r\nwhile (count-- != 0) {\r\ntemp1 = (crc >> 8) & 0x00FFFFFFL;\r\ntemp2 = tbl[((int) crc ^ *buffer++) & 0xff];\r\ncrc = temp1 ^ temp2;\r\n}\r\ncrc ^= 0xFFFFFFFFL;\r\n*result = crc;\r\n#ifndef STATIC_CRC_TABLE\r\ncrcTableInit = 0;\r\nOS_kfree(tbl);\r\n#endif\r\n}

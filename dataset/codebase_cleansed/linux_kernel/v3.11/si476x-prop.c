static bool si476x_core_element_is_in_array(u16 element,\r\nconst u16 array[],\r\nsize_t size)\r\n{\r\nint i;\r\nfor (i = 0; i < size; i++)\r\nif (element == array[i])\r\nreturn true;\r\nreturn false;\r\n}\r\nstatic bool si476x_core_element_is_in_range(u16 element,\r\nconst struct si476x_property_range range[],\r\nsize_t size)\r\n{\r\nint i;\r\nfor (i = 0; i < size; i++)\r\nif (element <= range[i].high && element >= range[i].low)\r\nreturn true;\r\nreturn false;\r\n}\r\nstatic bool si476x_core_is_valid_property_a10(struct si476x_core *core,\r\nu16 property)\r\n{\r\nstatic const u16 valid_properties[] = {\r\n0x0000,\r\n0x0500, 0x0501,\r\n0x0600,\r\n0x0709, 0x070C, 0x070D, 0x70E, 0x710,\r\n0x0718,\r\n0x1207, 0x1208,\r\n0x2007,\r\n0x2300,\r\n};\r\nstatic const struct si476x_property_range valid_ranges[] = {\r\n{ 0x0200, 0x0203 },\r\n{ 0x0300, 0x0303 },\r\n{ 0x0400, 0x0404 },\r\n{ 0x0700, 0x0707 },\r\n{ 0x1100, 0x1102 },\r\n{ 0x1200, 0x1204 },\r\n{ 0x1300, 0x1306 },\r\n{ 0x2000, 0x2005 },\r\n{ 0x2100, 0x2104 },\r\n{ 0x2106, 0x2106 },\r\n{ 0x2200, 0x220E },\r\n{ 0x3100, 0x3104 },\r\n{ 0x3207, 0x320F },\r\n{ 0x3300, 0x3304 },\r\n{ 0x3500, 0x3517 },\r\n{ 0x3600, 0x3617 },\r\n{ 0x3700, 0x3717 },\r\n{ 0x4000, 0x4003 },\r\n};\r\nreturn si476x_core_element_is_in_range(property, valid_ranges,\r\nARRAY_SIZE(valid_ranges)) ||\r\nsi476x_core_element_is_in_array(property, valid_properties,\r\nARRAY_SIZE(valid_properties));\r\n}\r\nstatic bool si476x_core_is_valid_property_a20(struct si476x_core *core,\r\nu16 property)\r\n{\r\nstatic const u16 valid_properties[] = {\r\n0x071B,\r\n0x1006,\r\n0x2210,\r\n0x3401,\r\n};\r\nstatic const struct si476x_property_range valid_ranges[] = {\r\n{ 0x2215, 0x2219 },\r\n};\r\nreturn si476x_core_is_valid_property_a10(core, property) ||\r\nsi476x_core_element_is_in_range(property, valid_ranges,\r\nARRAY_SIZE(valid_ranges)) ||\r\nsi476x_core_element_is_in_array(property, valid_properties,\r\nARRAY_SIZE(valid_properties));\r\n}\r\nstatic bool si476x_core_is_valid_property_a30(struct si476x_core *core,\r\nu16 property)\r\n{\r\nstatic const u16 valid_properties[] = {\r\n0x071C, 0x071D,\r\n0x1007, 0x1008,\r\n0x220F, 0x2214,\r\n0x2301,\r\n0x3105, 0x3106,\r\n0x3402,\r\n};\r\nstatic const struct si476x_property_range valid_ranges[] = {\r\n{ 0x0405, 0x0411 },\r\n{ 0x2008, 0x200B },\r\n{ 0x2220, 0x2223 },\r\n{ 0x3100, 0x3106 },\r\n};\r\nreturn si476x_core_is_valid_property_a20(core, property) ||\r\nsi476x_core_element_is_in_range(property, valid_ranges,\r\nARRAY_SIZE(valid_ranges)) ||\r\nsi476x_core_element_is_in_array(property, valid_properties,\r\nARRAY_SIZE(valid_properties));\r\n}\r\nstatic bool si476x_core_is_valid_property(struct si476x_core *core,\r\nu16 property)\r\n{\r\nstatic const valid_property_pred_t is_valid_property[] = {\r\n[SI476X_REVISION_A10] = si476x_core_is_valid_property_a10,\r\n[SI476X_REVISION_A20] = si476x_core_is_valid_property_a20,\r\n[SI476X_REVISION_A30] = si476x_core_is_valid_property_a30,\r\n};\r\nBUG_ON(core->revision > SI476X_REVISION_A30 ||\r\ncore->revision == -1);\r\nreturn is_valid_property[core->revision](core, property);\r\n}\r\nstatic bool si476x_core_is_readonly_property(struct si476x_core *core,\r\nu16 property)\r\n{\r\nBUG_ON(core->revision > SI476X_REVISION_A30 ||\r\ncore->revision == -1);\r\nswitch (core->revision) {\r\ncase SI476X_REVISION_A10:\r\nreturn (property == 0x3200);\r\ncase SI476X_REVISION_A20:\r\nreturn (property == 0x1006 ||\r\nproperty == 0x2210 ||\r\nproperty == 0x3200);\r\ncase SI476X_REVISION_A30:\r\nreturn false;\r\n}\r\nreturn false;\r\n}\r\nstatic bool si476x_core_regmap_readable_register(struct device *dev,\r\nunsigned int reg)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct si476x_core *core = i2c_get_clientdata(client);\r\nreturn si476x_core_is_valid_property(core, (u16) reg);\r\n}\r\nstatic bool si476x_core_regmap_writable_register(struct device *dev,\r\nunsigned int reg)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct si476x_core *core = i2c_get_clientdata(client);\r\nreturn si476x_core_is_valid_property(core, (u16) reg) &&\r\n!si476x_core_is_readonly_property(core, (u16) reg);\r\n}\r\nstatic int si476x_core_regmap_write(void *context, unsigned int reg,\r\nunsigned int val)\r\n{\r\nreturn si476x_core_cmd_set_property(context, reg, val);\r\n}\r\nstatic int si476x_core_regmap_read(void *context, unsigned int reg,\r\nunsigned *val)\r\n{\r\nstruct si476x_core *core = context;\r\nint err;\r\nerr = si476x_core_cmd_get_property(core, reg);\r\nif (err < 0)\r\nreturn err;\r\n*val = err;\r\nreturn 0;\r\n}\r\nstruct regmap *devm_regmap_init_si476x(struct si476x_core *core)\r\n{\r\nreturn devm_regmap_init(&core->client->dev, NULL,\r\ncore, &si476x_regmap_config);\r\n}

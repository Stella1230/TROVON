static void ohci_hcd_init (struct ohci_hcd *ohci)\r\n{\r\nohci->next_statechange = jiffies;\r\nspin_lock_init (&ohci->lock);\r\nINIT_LIST_HEAD (&ohci->pending);\r\n}\r\nstatic int ohci_mem_init (struct ohci_hcd *ohci)\r\n{\r\nohci->td_cache = dma_pool_create ("ohci_td",\r\nohci_to_hcd(ohci)->self.controller,\r\nsizeof (struct td),\r\n32 ,\r\n0 );\r\nif (!ohci->td_cache)\r\nreturn -ENOMEM;\r\nohci->ed_cache = dma_pool_create ("ohci_ed",\r\nohci_to_hcd(ohci)->self.controller,\r\nsizeof (struct ed),\r\n16 ,\r\n0 );\r\nif (!ohci->ed_cache) {\r\ndma_pool_destroy (ohci->td_cache);\r\nreturn -ENOMEM;\r\n}\r\nreturn 0;\r\n}\r\nstatic void ohci_mem_cleanup (struct ohci_hcd *ohci)\r\n{\r\nif (ohci->td_cache) {\r\ndma_pool_destroy (ohci->td_cache);\r\nohci->td_cache = NULL;\r\n}\r\nif (ohci->ed_cache) {\r\ndma_pool_destroy (ohci->ed_cache);\r\nohci->ed_cache = NULL;\r\n}\r\n}\r\nstatic inline struct td *\r\ndma_to_td (struct ohci_hcd *hc, dma_addr_t td_dma)\r\n{\r\nstruct td *td;\r\ntd_dma &= TD_MASK;\r\ntd = hc->td_hash [TD_HASH_FUNC(td_dma)];\r\nwhile (td && td->td_dma != td_dma)\r\ntd = td->td_hash;\r\nreturn td;\r\n}\r\nstatic struct td *\r\ntd_alloc (struct ohci_hcd *hc, gfp_t mem_flags)\r\n{\r\ndma_addr_t dma;\r\nstruct td *td;\r\ntd = dma_pool_alloc (hc->td_cache, mem_flags, &dma);\r\nif (td) {\r\nmemset (td, 0, sizeof *td);\r\ntd->hwNextTD = cpu_to_hc32 (hc, dma);\r\ntd->td_dma = dma;\r\n}\r\nreturn td;\r\n}\r\nstatic void\r\ntd_free (struct ohci_hcd *hc, struct td *td)\r\n{\r\nstruct td **prev = &hc->td_hash [TD_HASH_FUNC (td->td_dma)];\r\nwhile (*prev && *prev != td)\r\nprev = &(*prev)->td_hash;\r\nif (*prev)\r\n*prev = td->td_hash;\r\nelse if ((td->hwINFO & cpu_to_hc32(hc, TD_DONE)) != 0)\r\nohci_dbg (hc, "no hash for td %p\n", td);\r\ndma_pool_free (hc->td_cache, td, td->td_dma);\r\n}\r\nstatic struct ed *\r\ned_alloc (struct ohci_hcd *hc, gfp_t mem_flags)\r\n{\r\ndma_addr_t dma;\r\nstruct ed *ed;\r\ned = dma_pool_alloc (hc->ed_cache, mem_flags, &dma);\r\nif (ed) {\r\nmemset (ed, 0, sizeof (*ed));\r\nINIT_LIST_HEAD (&ed->td_list);\r\ned->dma = dma;\r\n}\r\nreturn ed;\r\n}\r\nstatic void\r\ned_free (struct ohci_hcd *hc, struct ed *ed)\r\n{\r\ndma_pool_free (hc->ed_cache, ed, ed->dma);\r\n}

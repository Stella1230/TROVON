static void snd_opl3_drum_voice_set(struct snd_opl3 *opl3,\r\nstruct snd_opl3_drum_voice *data)\r\n{\r\nunsigned char op_offset = snd_opl3_regmap[data->voice][data->op];\r\nunsigned char voice_offset = data->voice;\r\nunsigned short opl3_reg;\r\nopl3_reg = OPL3_LEFT | (OPL3_REG_AM_VIB + op_offset);\r\nopl3->command(opl3, opl3_reg, data->am_vib);\r\nopl3_reg = OPL3_LEFT | (OPL3_REG_KSL_LEVEL + op_offset);\r\nopl3->command(opl3, opl3_reg, data->ksl_level);\r\nopl3_reg = OPL3_LEFT | (OPL3_REG_ATTACK_DECAY + op_offset);\r\nopl3->command(opl3, opl3_reg, data->attack_decay);\r\nopl3_reg = OPL3_LEFT | (OPL3_REG_SUSTAIN_RELEASE + op_offset);\r\nopl3->command(opl3, opl3_reg, data->sustain_release);\r\nopl3_reg = OPL3_LEFT | (OPL3_REG_FEEDBACK_CONNECTION + voice_offset);\r\nopl3->command(opl3, opl3_reg, data->feedback_connection);\r\nopl3_reg = OPL3_LEFT | (OPL3_REG_WAVE_SELECT + op_offset);\r\nopl3->command(opl3, opl3_reg, data->wave_select);\r\n}\r\nstatic void snd_opl3_drum_note_set(struct snd_opl3 *opl3,\r\nstruct snd_opl3_drum_note *data)\r\n{\r\nunsigned char voice_offset = data->voice;\r\nunsigned short opl3_reg;\r\nopl3_reg = OPL3_LEFT | (OPL3_REG_FNUM_LOW + voice_offset);\r\nopl3->command(opl3, opl3_reg, data->fnum);\r\nopl3_reg = OPL3_LEFT | (OPL3_REG_KEYON_BLOCK + voice_offset);\r\nopl3->command(opl3, opl3_reg, data->octave_f);\r\n}\r\nstatic void snd_opl3_drum_vol_set(struct snd_opl3 *opl3,\r\nstruct snd_opl3_drum_voice *data,\r\nint vel, struct snd_midi_channel *chan)\r\n{\r\nunsigned char op_offset = snd_opl3_regmap[data->voice][data->op];\r\nunsigned char voice_offset = data->voice;\r\nunsigned char reg_val;\r\nunsigned short opl3_reg;\r\nreg_val = data->ksl_level;\r\nsnd_opl3_calc_volume(&reg_val, vel, chan);\r\nopl3_reg = OPL3_LEFT | (OPL3_REG_KSL_LEVEL + op_offset);\r\nopl3->command(opl3, opl3_reg, reg_val);\r\nreg_val = data->feedback_connection | OPL3_STEREO_BITS;\r\nif (chan->gm_pan < 43)\r\nreg_val &= ~OPL3_VOICE_TO_RIGHT;\r\nif (chan->gm_pan > 85)\r\nreg_val &= ~OPL3_VOICE_TO_LEFT;\r\nopl3_reg = OPL3_LEFT | (OPL3_REG_FEEDBACK_CONNECTION + voice_offset);\r\nopl3->command(opl3, opl3_reg, reg_val);\r\n}\r\nvoid snd_opl3_load_drums(struct snd_opl3 *opl3)\r\n{\r\nsnd_opl3_drum_voice_set(opl3, &bass_op0);\r\nsnd_opl3_drum_voice_set(opl3, &bass_op1);\r\nsnd_opl3_drum_note_set(opl3, &bass_note);\r\nsnd_opl3_drum_voice_set(opl3, &hihat);\r\nsnd_opl3_drum_voice_set(opl3, &snare);\r\nsnd_opl3_drum_note_set(opl3, &snare_note);\r\nsnd_opl3_drum_voice_set(opl3, &tomtom);\r\nsnd_opl3_drum_note_set(opl3, &tomtom_note);\r\nsnd_opl3_drum_voice_set(opl3, &cymbal);\r\n}\r\nvoid snd_opl3_drum_switch(struct snd_opl3 *opl3, int note, int vel, int on_off,\r\nstruct snd_midi_channel *chan)\r\n{\r\nunsigned char drum_mask;\r\nstruct snd_opl3_drum_voice *drum_voice;\r\nif (!(opl3->drum_reg & OPL3_PERCUSSION_ENABLE))\r\nreturn;\r\nif ((note < 35) || (note > 81))\r\nreturn;\r\ndrum_mask = snd_opl3_drum_table[note - 35];\r\nif (on_off) {\r\nswitch (drum_mask) {\r\ncase OPL3_BASSDRUM_ON:\r\ndrum_voice = &bass_op1;\r\nbreak;\r\ncase OPL3_HIHAT_ON:\r\ndrum_voice = &hihat;\r\nbreak;\r\ncase OPL3_SNAREDRUM_ON:\r\ndrum_voice = &snare;\r\nbreak;\r\ncase OPL3_TOMTOM_ON:\r\ndrum_voice = &tomtom;\r\nbreak;\r\ncase OPL3_CYMBAL_ON:\r\ndrum_voice = &cymbal;\r\nbreak;\r\ndefault:\r\ndrum_voice = &tomtom;\r\n}\r\nsnd_opl3_drum_vol_set(opl3, drum_voice, vel, chan);\r\nopl3->drum_reg |= drum_mask;\r\n} else {\r\nopl3->drum_reg &= ~drum_mask;\r\n}\r\nopl3->command(opl3, OPL3_LEFT | OPL3_REG_PERCUSSION,\r\nopl3->drum_reg);\r\n}

static int sh7786_pcie_config_access(unsigned char access_type,\r\nstruct pci_bus *bus, unsigned int devfn, int where, u32 *data)\r\n{\r\nstruct pci_channel *chan = bus->sysdata;\r\nint dev, func, type, reg;\r\ndev = PCI_SLOT(devfn);\r\nfunc = PCI_FUNC(devfn);\r\ntype = !!bus->parent;\r\nreg = where & ~3;\r\nif (bus->number > 255 || dev > 31 || func > 7)\r\nreturn PCIBIOS_FUNC_NOT_SUPPORTED;\r\nif (pci_is_root_bus(bus)) {\r\nif (dev == 0) {\r\nif (access_type == PCI_ACCESS_READ)\r\n*data = pci_read_reg(chan, PCI_REG(reg));\r\nelse\r\npci_write_reg(chan, *data, PCI_REG(reg));\r\nreturn PCIBIOS_SUCCESSFUL;\r\n} else if (dev > 1)\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\n}\r\npci_write_reg(chan, pci_read_reg(chan, SH4A_PCIEERRFR), SH4A_PCIEERRFR);\r\npci_write_reg(chan, (bus->number << 24) | (dev << 19) |\r\n(func << 16) | reg, SH4A_PCIEPAR);\r\npci_write_reg(chan, (1 << 31) | (type << 8), SH4A_PCIEPCTLR);\r\nif (pci_read_reg(chan, SH4A_PCIEERRFR) & 0x10)\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nif (pci_read_reg(chan, SH4A_PCIEPCICONF1) & ((1 << 29) | (1 << 28)))\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nif (access_type == PCI_ACCESS_READ)\r\n*data = pci_read_reg(chan, SH4A_PCIEPDR);\r\nelse\r\npci_write_reg(chan, *data, SH4A_PCIEPDR);\r\npci_write_reg(chan, 0, SH4A_PCIEPCTLR);\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int sh7786_pcie_read(struct pci_bus *bus, unsigned int devfn,\r\nint where, int size, u32 *val)\r\n{\r\nunsigned long flags;\r\nint ret;\r\nu32 data;\r\nif ((size == 2) && (where & 1))\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\nelse if ((size == 4) && (where & 3))\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\nraw_spin_lock_irqsave(&pci_config_lock, flags);\r\nret = sh7786_pcie_config_access(PCI_ACCESS_READ, bus,\r\ndevfn, where, &data);\r\nif (ret != PCIBIOS_SUCCESSFUL) {\r\n*val = 0xffffffff;\r\ngoto out;\r\n}\r\nif (size == 1)\r\n*val = (data >> ((where & 3) << 3)) & 0xff;\r\nelse if (size == 2)\r\n*val = (data >> ((where & 2) << 3)) & 0xffff;\r\nelse\r\n*val = data;\r\ndev_dbg(&bus->dev, "pcie-config-read: bus=%3d devfn=0x%04x "\r\n"where=0x%04x size=%d val=0x%08lx\n", bus->number,\r\ndevfn, where, size, (unsigned long)*val);\r\nout:\r\nraw_spin_unlock_irqrestore(&pci_config_lock, flags);\r\nreturn ret;\r\n}\r\nstatic int sh7786_pcie_write(struct pci_bus *bus, unsigned int devfn,\r\nint where, int size, u32 val)\r\n{\r\nunsigned long flags;\r\nint shift, ret;\r\nu32 data;\r\nif ((size == 2) && (where & 1))\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\nelse if ((size == 4) && (where & 3))\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\nraw_spin_lock_irqsave(&pci_config_lock, flags);\r\nret = sh7786_pcie_config_access(PCI_ACCESS_READ, bus,\r\ndevfn, where, &data);\r\nif (ret != PCIBIOS_SUCCESSFUL)\r\ngoto out;\r\ndev_dbg(&bus->dev, "pcie-config-write: bus=%3d devfn=0x%04x "\r\n"where=0x%04x size=%d val=%08lx\n", bus->number,\r\ndevfn, where, size, (unsigned long)val);\r\nif (size == 1) {\r\nshift = (where & 3) << 3;\r\ndata &= ~(0xff << shift);\r\ndata |= ((val & 0xff) << shift);\r\n} else if (size == 2) {\r\nshift = (where & 2) << 3;\r\ndata &= ~(0xffff << shift);\r\ndata |= ((val & 0xffff) << shift);\r\n} else\r\ndata = val;\r\nret = sh7786_pcie_config_access(PCI_ACCESS_WRITE, bus,\r\ndevfn, where, &data);\r\nout:\r\nraw_spin_unlock_irqrestore(&pci_config_lock, flags);\r\nreturn ret;\r\n}

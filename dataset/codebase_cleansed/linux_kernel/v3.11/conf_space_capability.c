static inline void register_capability(struct xen_pcibk_config_capability *cap)\r\n{\r\nlist_add_tail(&cap->cap_list, &capabilities);\r\n}\r\nint xen_pcibk_config_capability_add_fields(struct pci_dev *dev)\r\n{\r\nint err = 0;\r\nstruct xen_pcibk_config_capability *cap;\r\nint cap_offset;\r\nlist_for_each_entry(cap, &capabilities, cap_list) {\r\ncap_offset = pci_find_capability(dev, cap->capability);\r\nif (cap_offset) {\r\ndev_dbg(&dev->dev, "Found capability 0x%x at 0x%x\n",\r\ncap->capability, cap_offset);\r\nerr = xen_pcibk_config_add_fields_offset(dev,\r\ncaplist_header,\r\ncap_offset);\r\nif (err)\r\ngoto out;\r\nerr = xen_pcibk_config_add_fields_offset(dev,\r\ncap->fields,\r\ncap_offset);\r\nif (err)\r\ngoto out;\r\n}\r\n}\r\nout:\r\nreturn err;\r\n}\r\nstatic int vpd_address_write(struct pci_dev *dev, int offset, u16 value,\r\nvoid *data)\r\n{\r\nif (value & PCI_VPD_ADDR_F)\r\nreturn PCIBIOS_SET_FAILED;\r\nelse\r\nreturn pci_write_config_word(dev, offset, value);\r\n}\r\nstatic int pm_caps_read(struct pci_dev *dev, int offset, u16 *value,\r\nvoid *data)\r\n{\r\nint err;\r\nu16 real_value;\r\nerr = pci_read_config_word(dev, offset, &real_value);\r\nif (err)\r\ngoto out;\r\n*value = real_value & ~PCI_PM_CAP_PME_MASK;\r\nout:\r\nreturn err;\r\n}\r\nstatic int pm_ctrl_write(struct pci_dev *dev, int offset, u16 new_value,\r\nvoid *data)\r\n{\r\nint err;\r\nu16 old_value;\r\npci_power_t new_state, old_state;\r\nerr = pci_read_config_word(dev, offset, &old_value);\r\nif (err)\r\ngoto out;\r\nold_state = (pci_power_t)(old_value & PCI_PM_CTRL_STATE_MASK);\r\nnew_state = (pci_power_t)(new_value & PCI_PM_CTRL_STATE_MASK);\r\nnew_value &= PM_OK_BITS;\r\nif ((old_value & PM_OK_BITS) != new_value) {\r\nnew_value = (old_value & ~PM_OK_BITS) | new_value;\r\nerr = pci_write_config_word(dev, offset, new_value);\r\nif (err)\r\ngoto out;\r\n}\r\ndev_dbg(&dev->dev, "set power state to %x\n", new_state);\r\nerr = pci_set_power_state(dev, new_state);\r\nif (err) {\r\nerr = PCIBIOS_SET_FAILED;\r\ngoto out;\r\n}\r\nout:\r\nreturn err;\r\n}\r\nstatic void *pm_ctrl_init(struct pci_dev *dev, int offset)\r\n{\r\nint err;\r\nu16 value;\r\nerr = pci_read_config_word(dev, offset, &value);\r\nif (err)\r\ngoto out;\r\nif (value & PCI_PM_CTRL_PME_ENABLE) {\r\nvalue &= ~PCI_PM_CTRL_PME_ENABLE;\r\nerr = pci_write_config_word(dev, offset, value);\r\n}\r\nout:\r\nreturn ERR_PTR(err);\r\n}\r\nint xen_pcibk_config_capability_init(void)\r\n{\r\nregister_capability(&xen_pcibk_config_capability_vpd);\r\nregister_capability(&xen_pcibk_config_capability_pm);\r\nreturn 0;\r\n}

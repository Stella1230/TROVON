static void n810_ext_control(struct snd_soc_dapm_context *dapm)\r\n{\r\nint hp = 0, line1l = 0;\r\nswitch (n810_jack_func) {\r\ncase N810_JACK_HS:\r\nline1l = 1;\r\ncase N810_JACK_HP:\r\nhp = 1;\r\nbreak;\r\ncase N810_JACK_MIC:\r\nline1l = 1;\r\nbreak;\r\n}\r\nif (n810_spk_func)\r\nsnd_soc_dapm_enable_pin(dapm, "Ext Spk");\r\nelse\r\nsnd_soc_dapm_disable_pin(dapm, "Ext Spk");\r\nif (hp)\r\nsnd_soc_dapm_enable_pin(dapm, "Headphone Jack");\r\nelse\r\nsnd_soc_dapm_disable_pin(dapm, "Headphone Jack");\r\nif (line1l)\r\nsnd_soc_dapm_enable_pin(dapm, "LINE1L");\r\nelse\r\nsnd_soc_dapm_disable_pin(dapm, "LINE1L");\r\nif (n810_dmic_func)\r\nsnd_soc_dapm_enable_pin(dapm, "DMic");\r\nelse\r\nsnd_soc_dapm_disable_pin(dapm, "DMic");\r\nsnd_soc_dapm_sync(dapm);\r\n}\r\nstatic int n810_startup(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_codec *codec = rtd->codec;\r\nsnd_pcm_hw_constraint_minmax(runtime,\r\nSNDRV_PCM_HW_PARAM_CHANNELS, 2, 2);\r\nn810_ext_control(&codec->dapm);\r\nreturn clk_enable(sys_clkout2);\r\n}\r\nstatic void n810_shutdown(struct snd_pcm_substream *substream)\r\n{\r\nclk_disable(sys_clkout2);\r\n}\r\nstatic int n810_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nint err;\r\nerr = snd_soc_dai_set_sysclk(codec_dai, 0, 12000000,\r\nSND_SOC_CLOCK_IN);\r\nreturn err;\r\n}\r\nstatic int n810_get_spk(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nucontrol->value.integer.value[0] = n810_spk_func;\r\nreturn 0;\r\n}\r\nstatic int n810_set_spk(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_card *card = snd_kcontrol_chip(kcontrol);\r\nif (n810_spk_func == ucontrol->value.integer.value[0])\r\nreturn 0;\r\nn810_spk_func = ucontrol->value.integer.value[0];\r\nn810_ext_control(&card->dapm);\r\nreturn 1;\r\n}\r\nstatic int n810_get_jack(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nucontrol->value.integer.value[0] = n810_jack_func;\r\nreturn 0;\r\n}\r\nstatic int n810_set_jack(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_card *card = snd_kcontrol_chip(kcontrol);\r\nif (n810_jack_func == ucontrol->value.integer.value[0])\r\nreturn 0;\r\nn810_jack_func = ucontrol->value.integer.value[0];\r\nn810_ext_control(&card->dapm);\r\nreturn 1;\r\n}\r\nstatic int n810_get_input(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nucontrol->value.integer.value[0] = n810_dmic_func;\r\nreturn 0;\r\n}\r\nstatic int n810_set_input(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_card *card = snd_kcontrol_chip(kcontrol);\r\nif (n810_dmic_func == ucontrol->value.integer.value[0])\r\nreturn 0;\r\nn810_dmic_func = ucontrol->value.integer.value[0];\r\nn810_ext_control(&card->dapm);\r\nreturn 1;\r\n}\r\nstatic int n810_spk_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *k, int event)\r\n{\r\nif (SND_SOC_DAPM_EVENT_ON(event))\r\ngpio_set_value(N810_SPEAKER_AMP_GPIO, 1);\r\nelse\r\ngpio_set_value(N810_SPEAKER_AMP_GPIO, 0);\r\nreturn 0;\r\n}\r\nstatic int n810_jack_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *k, int event)\r\n{\r\nif (SND_SOC_DAPM_EVENT_ON(event))\r\ngpio_set_value(N810_HEADSET_AMP_GPIO, 1);\r\nelse\r\ngpio_set_value(N810_HEADSET_AMP_GPIO, 0);\r\nreturn 0;\r\n}\r\nstatic int n810_aic33_init(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct snd_soc_codec *codec = rtd->codec;\r\nstruct snd_soc_dapm_context *dapm = &codec->dapm;\r\nsnd_soc_dapm_nc_pin(dapm, "MONO_LOUT");\r\nsnd_soc_dapm_nc_pin(dapm, "HPLCOM");\r\nsnd_soc_dapm_nc_pin(dapm, "HPRCOM");\r\nsnd_soc_dapm_nc_pin(dapm, "MIC3L");\r\nsnd_soc_dapm_nc_pin(dapm, "MIC3R");\r\nsnd_soc_dapm_nc_pin(dapm, "LINE1R");\r\nsnd_soc_dapm_nc_pin(dapm, "LINE2L");\r\nsnd_soc_dapm_nc_pin(dapm, "LINE2R");\r\nreturn 0;\r\n}\r\nstatic int __init n810_soc_init(void)\r\n{\r\nint err;\r\nstruct device *dev;\r\nif (!(machine_is_nokia_n810() || machine_is_nokia_n810_wimax()))\r\nreturn -ENODEV;\r\nn810_snd_device = platform_device_alloc("soc-audio", -1);\r\nif (!n810_snd_device)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(n810_snd_device, &snd_soc_n810);\r\nerr = platform_device_add(n810_snd_device);\r\nif (err)\r\ngoto err1;\r\ndev = &n810_snd_device->dev;\r\nsys_clkout2_src = clk_get(dev, "sys_clkout2_src");\r\nif (IS_ERR(sys_clkout2_src)) {\r\ndev_err(dev, "Could not get sys_clkout2_src clock\n");\r\nerr = PTR_ERR(sys_clkout2_src);\r\ngoto err2;\r\n}\r\nsys_clkout2 = clk_get(dev, "sys_clkout2");\r\nif (IS_ERR(sys_clkout2)) {\r\ndev_err(dev, "Could not get sys_clkout2\n");\r\nerr = PTR_ERR(sys_clkout2);\r\ngoto err3;\r\n}\r\nfunc96m_clk = clk_get(dev, "func_96m_ck");\r\nif (IS_ERR(func96m_clk)) {\r\ndev_err(dev, "Could not get func 96M clock\n");\r\nerr = PTR_ERR(func96m_clk);\r\ngoto err4;\r\n}\r\nclk_set_parent(sys_clkout2_src, func96m_clk);\r\nclk_set_rate(sys_clkout2, 12000000);\r\nBUG_ON((gpio_request(N810_HEADSET_AMP_GPIO, "hs_amp") < 0) ||\r\n(gpio_request(N810_SPEAKER_AMP_GPIO, "spk_amp") < 0));\r\ngpio_direction_output(N810_HEADSET_AMP_GPIO, 0);\r\ngpio_direction_output(N810_SPEAKER_AMP_GPIO, 0);\r\nreturn 0;\r\nerr4:\r\nclk_put(sys_clkout2);\r\nerr3:\r\nclk_put(sys_clkout2_src);\r\nerr2:\r\nplatform_device_del(n810_snd_device);\r\nerr1:\r\nplatform_device_put(n810_snd_device);\r\nreturn err;\r\n}\r\nstatic void __exit n810_soc_exit(void)\r\n{\r\ngpio_free(N810_SPEAKER_AMP_GPIO);\r\ngpio_free(N810_HEADSET_AMP_GPIO);\r\nclk_put(sys_clkout2_src);\r\nclk_put(sys_clkout2);\r\nclk_put(func96m_clk);\r\nplatform_device_unregister(n810_snd_device);\r\n}

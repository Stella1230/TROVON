static void quirk_mpc8360e_qe_enet10(void)\r\n{\r\nuint svid = mfspr(SPRN_SVR);\r\nstruct device_node *np_par;\r\nstruct resource res;\r\nvoid __iomem *base;\r\nint ret;\r\nnp_par = of_find_node_by_name(NULL, "par_io");\r\nif (np_par == NULL) {\r\npr_warn("%s couldn;t find par_io node\n", __func__);\r\nreturn;\r\n}\r\nret = of_address_to_resource(np_par, 0, &res);\r\nif (ret) {\r\npr_warn("%s couldn;t map par_io registers\n", __func__);\r\nreturn;\r\n}\r\nbase = ioremap(res.start, res.end - res.start + 1);\r\nclrsetbits_be32((base + 0xa8), 0x0c00f000, 0x04005000);\r\nclrsetbits_be32((base + 0xac), 0x0000cff0, 0x00004550);\r\nif (SVR_REV(svid) == 0x0021) {\r\nclrsetbits_be32((base + 0xac), 0x000000f0, 0x000000a0);\r\n} else if (SVR_REV(svid) == 0x0020) {\r\nsetbits32((base + 0xa8), 0x00003000);\r\nsetbits32((base + 0xa8), 0x0c000000);\r\nsetbits32((base + 0xac), 0x0000c000);\r\n}\r\niounmap(base);\r\nof_node_put(np_par);\r\n}\r\nstatic void __init mpc83xx_km_setup_arch(void)\r\n{\r\n#ifdef CONFIG_QUICC_ENGINE\r\nstruct device_node *np;\r\n#endif\r\nif (ppc_md.progress)\r\nppc_md.progress("kmpbec83xx_setup_arch()", 0);\r\nmpc83xx_setup_pci();\r\n#ifdef CONFIG_QUICC_ENGINE\r\nqe_reset();\r\nnp = of_find_node_by_name(NULL, "par_io");\r\nif (np != NULL) {\r\npar_io_init(np);\r\nof_node_put(np);\r\nfor_each_node_by_name(np, "spi")\r\npar_io_of_config(np);\r\nfor_each_node_by_name(np, "ucc")\r\npar_io_of_config(np);\r\nnp = of_find_compatible_node(NULL, "network", "ucc_geth");\r\nif (np != NULL) {\r\nquirk_mpc8360e_qe_enet10();\r\nof_node_put(np);\r\n}\r\n}\r\n#endif\r\n}\r\nstatic int __init mpc83xx_km_probe(void)\r\n{\r\nunsigned long node = of_get_flat_dt_root();\r\nint i = 0;\r\nwhile (board[i]) {\r\nif (of_flat_dt_is_compatible(node, board[i]))\r\nbreak;\r\ni++;\r\n}\r\nreturn (board[i] != NULL);\r\n}

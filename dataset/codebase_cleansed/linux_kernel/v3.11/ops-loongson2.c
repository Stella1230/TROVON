static int loongson_pcibios_config_access(unsigned char access_type,\r\nstruct pci_bus *bus,\r\nunsigned int devfn, int where,\r\nu32 *data)\r\n{\r\nu32 busnum = bus->number;\r\nu32 addr, type;\r\nu32 dummy;\r\nvoid *addrp;\r\nint device = PCI_SLOT(devfn);\r\nint function = PCI_FUNC(devfn);\r\nint reg = where & ~3;\r\nif (busnum == 0) {\r\n#ifdef CONFIG_CS5536\r\nif ((PCI_IDSEL_CS5536 == device) && (reg < PCI_MSR_CTRL)) {\r\nswitch (access_type) {\r\ncase PCI_ACCESS_READ:\r\n*data = cs5536_pci_conf_read4(function, reg);\r\nbreak;\r\ncase PCI_ACCESS_WRITE:\r\ncs5536_pci_conf_write4(function, reg, *data);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\n#endif\r\nif (device > MAX_DEV_NUM)\r\nreturn -1;\r\naddr = (1 << (device + ID_SEL_BEGIN)) | (function << 8) | reg;\r\ntype = 0;\r\n} else {\r\naddr = (busnum << 16) | (device << 11) | (function << 8) | reg;\r\ntype = 0x10000;\r\n}\r\nLOONGSON_PCICMD |= LOONGSON_PCICMD_MABORT_CLR | \\r\nLOONGSON_PCICMD_MTABORT_CLR;\r\nLOONGSON_PCIMAP_CFG = (addr >> 16) | type;\r\ndummy = LOONGSON_PCIMAP_CFG;\r\nmmiowb();\r\naddrp = CFG_SPACE_REG(addr & 0xffff);\r\nif (access_type == PCI_ACCESS_WRITE)\r\nwritel(cpu_to_le32(*data), addrp);\r\nelse\r\n*data = le32_to_cpu(readl(addrp));\r\nif (LOONGSON_PCICMD & (LOONGSON_PCICMD_MABORT_CLR |\r\nLOONGSON_PCICMD_MTABORT_CLR)) {\r\nLOONGSON_PCICMD |= (LOONGSON_PCICMD_MABORT_CLR |\r\nLOONGSON_PCICMD_MTABORT_CLR);\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int loongson_pcibios_read(struct pci_bus *bus, unsigned int devfn,\r\nint where, int size, u32 *val)\r\n{\r\nu32 data = 0;\r\nif ((size == 2) && (where & 1))\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\nelse if ((size == 4) && (where & 3))\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\nif (loongson_pcibios_config_access(PCI_ACCESS_READ, bus, devfn, where,\r\n&data))\r\nreturn -1;\r\nif (size == 1)\r\n*val = (data >> ((where & 3) << 3)) & 0xff;\r\nelse if (size == 2)\r\n*val = (data >> ((where & 3) << 3)) & 0xffff;\r\nelse\r\n*val = data;\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int loongson_pcibios_write(struct pci_bus *bus, unsigned int devfn,\r\nint where, int size, u32 val)\r\n{\r\nu32 data = 0;\r\nif ((size == 2) && (where & 1))\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\nelse if ((size == 4) && (where & 3))\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\nif (size == 4)\r\ndata = val;\r\nelse {\r\nif (loongson_pcibios_config_access(PCI_ACCESS_READ, bus, devfn,\r\nwhere, &data))\r\nreturn -1;\r\nif (size == 1)\r\ndata = (data & ~(0xff << ((where & 3) << 3))) |\r\n(val << ((where & 3) << 3));\r\nelse if (size == 2)\r\ndata = (data & ~(0xffff << ((where & 3) << 3))) |\r\n(val << ((where & 3) << 3));\r\n}\r\nif (loongson_pcibios_config_access(PCI_ACCESS_WRITE, bus, devfn, where,\r\n&data))\r\nreturn -1;\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nvoid _rdmsr(u32 msr, u32 *hi, u32 *lo)\r\n{\r\nstruct pci_bus bus = {\r\n.number = PCI_BUS_CS5536\r\n};\r\nu32 devfn = PCI_DEVFN(PCI_IDSEL_CS5536, 0);\r\nunsigned long flags;\r\nraw_spin_lock_irqsave(&msr_lock, flags);\r\nloongson_pcibios_write(&bus, devfn, PCI_MSR_ADDR, 4, msr);\r\nloongson_pcibios_read(&bus, devfn, PCI_MSR_DATA_LO, 4, lo);\r\nloongson_pcibios_read(&bus, devfn, PCI_MSR_DATA_HI, 4, hi);\r\nraw_spin_unlock_irqrestore(&msr_lock, flags);\r\n}\r\nvoid _wrmsr(u32 msr, u32 hi, u32 lo)\r\n{\r\nstruct pci_bus bus = {\r\n.number = PCI_BUS_CS5536\r\n};\r\nu32 devfn = PCI_DEVFN(PCI_IDSEL_CS5536, 0);\r\nunsigned long flags;\r\nraw_spin_lock_irqsave(&msr_lock, flags);\r\nloongson_pcibios_write(&bus, devfn, PCI_MSR_ADDR, 4, msr);\r\nloongson_pcibios_write(&bus, devfn, PCI_MSR_DATA_LO, 4, lo);\r\nloongson_pcibios_write(&bus, devfn, PCI_MSR_DATA_HI, 4, hi);\r\nraw_spin_unlock_irqrestore(&msr_lock, flags);\r\n}

static unsigned long clk_factor_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct clk_fixed_factor *fix = to_clk_fixed_factor(hw);\r\nunsigned long long int rate;\r\nrate = (unsigned long long int)parent_rate * fix->mult;\r\ndo_div(rate, fix->div);\r\nreturn (unsigned long)rate;\r\n}\r\nstatic long clk_factor_round_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long *prate)\r\n{\r\nstruct clk_fixed_factor *fix = to_clk_fixed_factor(hw);\r\nif (__clk_get_flags(hw->clk) & CLK_SET_RATE_PARENT) {\r\nunsigned long best_parent;\r\nbest_parent = (rate / fix->mult) * fix->div;\r\n*prate = __clk_round_rate(__clk_get_parent(hw->clk),\r\nbest_parent);\r\n}\r\nreturn (*prate / fix->div) * fix->mult;\r\n}\r\nstatic int clk_factor_set_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nreturn 0;\r\n}\r\nstruct clk *clk_register_fixed_factor(struct device *dev, const char *name,\r\nconst char *parent_name, unsigned long flags,\r\nunsigned int mult, unsigned int div)\r\n{\r\nstruct clk_fixed_factor *fix;\r\nstruct clk_init_data init;\r\nstruct clk *clk;\r\nfix = kmalloc(sizeof(*fix), GFP_KERNEL);\r\nif (!fix) {\r\npr_err("%s: could not allocate fixed factor clk\n", __func__);\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nfix->mult = mult;\r\nfix->div = div;\r\nfix->hw.init = &init;\r\ninit.name = name;\r\ninit.ops = &clk_fixed_factor_ops;\r\ninit.flags = flags | CLK_IS_BASIC;\r\ninit.parent_names = &parent_name;\r\ninit.num_parents = 1;\r\nclk = clk_register(dev, &fix->hw);\r\nif (IS_ERR(clk))\r\nkfree(fix);\r\nreturn clk;\r\n}\r\nvoid __init of_fixed_factor_clk_setup(struct device_node *node)\r\n{\r\nstruct clk *clk;\r\nconst char *clk_name = node->name;\r\nconst char *parent_name;\r\nu32 div, mult;\r\nif (of_property_read_u32(node, "clock-div", &div)) {\r\npr_err("%s Fixed factor clock <%s> must have a clock-div property\n",\r\n__func__, node->name);\r\nreturn;\r\n}\r\nif (of_property_read_u32(node, "clock-mult", &mult)) {\r\npr_err("%s Fixed factor clock <%s> must have a clokc-mult property\n",\r\n__func__, node->name);\r\nreturn;\r\n}\r\nof_property_read_string(node, "clock-output-names", &clk_name);\r\nparent_name = of_clk_get_parent_name(node, 0);\r\nclk = clk_register_fixed_factor(NULL, clk_name, parent_name, 0,\r\nmult, div);\r\nif (!IS_ERR(clk))\r\nof_clk_add_provider(node, of_clk_src_simple_get, clk);\r\n}

static u32 tea5777_freq_to_v4l2_freq(struct radio_tea5777 *tea, u32 freq)\r\n{\r\nswitch (tea->band) {\r\ncase BAND_FM:\r\nreturn (freq * TEA5777_FM_FREQ_STEP + TEA5777_FM_IF) * 16;\r\ncase BAND_AM:\r\nreturn (freq * TEA5777_AM_FREQ_STEP + TEA5777_AM_IF) * 16;\r\n}\r\nreturn 0;\r\n}\r\nint radio_tea5777_set_freq(struct radio_tea5777 *tea)\r\n{\r\nu32 freq;\r\nint res;\r\nfreq = clamp(tea->freq, bands[tea->band].rangelow,\r\nbands[tea->band].rangehigh);\r\nfreq = (freq + 8) / 16;\r\nswitch (tea->band) {\r\ncase BAND_FM:\r\ntea->write_reg &= ~TEA5777_W_AM_FM_MASK;\r\nfreq = (freq - TEA5777_FM_IF) / TEA5777_FM_FREQ_STEP;\r\ntea->write_reg &= ~TEA5777_W_FM_PLL_MASK;\r\ntea->write_reg |= (u64)freq << TEA5777_W_FM_PLL_SHIFT;\r\ntea->write_reg &= ~TEA5777_W_FM_FREF_MASK;\r\ntea->write_reg |= TEA5777_W_FM_FREF_VALUE <<\r\nTEA5777_W_FM_FREF_SHIFT;\r\ntea->write_reg &= ~TEA5777_W_FM_FORCEMONO_MASK;\r\nif (tea->audmode == V4L2_TUNER_MODE_MONO)\r\ntea->write_reg |= 1LL << TEA5777_W_FM_FORCEMONO_SHIFT;\r\nbreak;\r\ncase BAND_AM:\r\ntea->write_reg &= ~TEA5777_W_AM_FM_MASK;\r\ntea->write_reg |= (1LL << TEA5777_W_AM_FM_SHIFT);\r\nfreq = (freq - TEA5777_AM_IF) / TEA5777_AM_FREQ_STEP;\r\ntea->write_reg &= ~TEA5777_W_AM_PLL_MASK;\r\ntea->write_reg |= (u64)freq << TEA5777_W_AM_PLL_SHIFT;\r\ntea->write_reg &= ~TEA5777_W_AM_AGCRF_MASK;\r\ntea->write_reg &= ~TEA5777_W_AM_AGCRF_MASK;\r\ntea->write_reg &= ~TEA5777_W_AM_MWLW_MASK;\r\ntea->write_reg |= TEA5777_W_AM_MW << TEA5777_W_AM_MWLW_SHIFT;\r\ntea->write_reg &= ~TEA5777_W_AM_LNA_MASK;\r\ntea->write_reg |= 1LL << TEA5777_W_AM_LNA_SHIFT;\r\ntea->write_reg &= ~TEA5777_W_AM_PEAK_MASK;\r\ntea->write_reg |= 1LL << TEA5777_W_AM_PEAK_SHIFT;\r\ntea->write_reg &= ~TEA5777_W_AM_CALLIGN_MASK;\r\nbreak;\r\n}\r\nres = tea->ops->write_reg(tea, tea->write_reg);\r\nif (res)\r\nreturn res;\r\ntea->needs_write = false;\r\ntea->read_reg = -1;\r\ntea->freq = tea5777_freq_to_v4l2_freq(tea, freq);\r\nreturn 0;\r\n}\r\nstatic int radio_tea5777_update_read_reg(struct radio_tea5777 *tea, int wait)\r\n{\r\nint res;\r\nif (tea->read_reg != -1)\r\nreturn 0;\r\nif (tea->write_before_read && tea->needs_write) {\r\nres = radio_tea5777_set_freq(tea);\r\nif (res)\r\nreturn res;\r\n}\r\nif (wait) {\r\nif (schedule_timeout_interruptible(msecs_to_jiffies(wait)))\r\nreturn -ERESTARTSYS;\r\n}\r\nres = tea->ops->read_reg(tea, &tea->read_reg);\r\nif (res)\r\nreturn res;\r\ntea->needs_write = true;\r\nreturn 0;\r\n}\r\nstatic int vidioc_querycap(struct file *file, void *priv,\r\nstruct v4l2_capability *v)\r\n{\r\nstruct radio_tea5777 *tea = video_drvdata(file);\r\nstrlcpy(v->driver, tea->v4l2_dev->name, sizeof(v->driver));\r\nstrlcpy(v->card, tea->card, sizeof(v->card));\r\nstrlcat(v->card, " TEA5777", sizeof(v->card));\r\nstrlcpy(v->bus_info, tea->bus_info, sizeof(v->bus_info));\r\nv->device_caps = V4L2_CAP_TUNER | V4L2_CAP_RADIO;\r\nv->device_caps |= V4L2_CAP_HW_FREQ_SEEK;\r\nv->capabilities = v->device_caps | V4L2_CAP_DEVICE_CAPS;\r\nreturn 0;\r\n}\r\nstatic int vidioc_enum_freq_bands(struct file *file, void *priv,\r\nstruct v4l2_frequency_band *band)\r\n{\r\nstruct radio_tea5777 *tea = video_drvdata(file);\r\nif (band->tuner != 0 || band->index >= ARRAY_SIZE(bands) ||\r\n(!tea->has_am && band->index == BAND_AM))\r\nreturn -EINVAL;\r\n*band = bands[band->index];\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_tuner(struct file *file, void *priv,\r\nstruct v4l2_tuner *v)\r\n{\r\nstruct radio_tea5777 *tea = video_drvdata(file);\r\nint res;\r\nif (v->index > 0)\r\nreturn -EINVAL;\r\nres = radio_tea5777_update_read_reg(tea, 0);\r\nif (res)\r\nreturn res;\r\nmemset(v, 0, sizeof(*v));\r\nif (tea->has_am)\r\nstrlcpy(v->name, "AM/FM", sizeof(v->name));\r\nelse\r\nstrlcpy(v->name, "FM", sizeof(v->name));\r\nv->type = V4L2_TUNER_RADIO;\r\nv->capability = V4L2_TUNER_CAP_LOW | V4L2_TUNER_CAP_STEREO |\r\nV4L2_TUNER_CAP_FREQ_BANDS |\r\nV4L2_TUNER_CAP_HWSEEK_BOUNDED |\r\nV4L2_TUNER_CAP_HWSEEK_PROG_LIM;\r\nv->rangelow = tea->has_am ? bands[BAND_AM].rangelow :\r\nbands[BAND_FM].rangelow;\r\nv->rangehigh = bands[BAND_FM].rangehigh;\r\nif (tea->band == BAND_FM &&\r\n(tea->read_reg & TEA5777_R_FM_STEREO_MASK))\r\nv->rxsubchans = V4L2_TUNER_SUB_STEREO;\r\nelse\r\nv->rxsubchans = V4L2_TUNER_SUB_MONO;\r\nv->audmode = tea->audmode;\r\nv->signal = (tea->read_reg & TEA5777_R_LEVEL_MASK) >>\r\n(TEA5777_R_LEVEL_SHIFT - 12);\r\ntea->read_reg = -1;\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_tuner(struct file *file, void *priv,\r\nconst struct v4l2_tuner *v)\r\n{\r\nstruct radio_tea5777 *tea = video_drvdata(file);\r\nu32 orig_audmode = tea->audmode;\r\nif (v->index)\r\nreturn -EINVAL;\r\ntea->audmode = v->audmode;\r\nif (tea->audmode > V4L2_TUNER_MODE_STEREO)\r\ntea->audmode = V4L2_TUNER_MODE_STEREO;\r\nif (tea->audmode != orig_audmode && tea->band == BAND_FM)\r\nreturn radio_tea5777_set_freq(tea);\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_frequency(struct file *file, void *priv,\r\nstruct v4l2_frequency *f)\r\n{\r\nstruct radio_tea5777 *tea = video_drvdata(file);\r\nif (f->tuner != 0)\r\nreturn -EINVAL;\r\nf->type = V4L2_TUNER_RADIO;\r\nf->frequency = tea->freq;\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_frequency(struct file *file, void *priv,\r\nconst struct v4l2_frequency *f)\r\n{\r\nstruct radio_tea5777 *tea = video_drvdata(file);\r\nif (f->tuner != 0 || f->type != V4L2_TUNER_RADIO)\r\nreturn -EINVAL;\r\nif (tea->has_am && f->frequency < (20000 * 16))\r\ntea->band = BAND_AM;\r\nelse\r\ntea->band = BAND_FM;\r\ntea->freq = f->frequency;\r\nreturn radio_tea5777_set_freq(tea);\r\n}\r\nstatic int vidioc_s_hw_freq_seek(struct file *file, void *fh,\r\nconst struct v4l2_hw_freq_seek *a)\r\n{\r\nstruct radio_tea5777 *tea = video_drvdata(file);\r\nunsigned long timeout;\r\nu32 rangelow = a->rangelow;\r\nu32 rangehigh = a->rangehigh;\r\nint i, res, spacing;\r\nu32 orig_freq;\r\nif (a->tuner || a->wrap_around)\r\nreturn -EINVAL;\r\nif (file->f_flags & O_NONBLOCK)\r\nreturn -EWOULDBLOCK;\r\nif (rangelow || rangehigh) {\r\nfor (i = 0; i < ARRAY_SIZE(bands); i++) {\r\nif (i == BAND_AM && !tea->has_am)\r\ncontinue;\r\nif (bands[i].rangelow >= rangelow &&\r\nbands[i].rangehigh <= rangehigh)\r\nbreak;\r\n}\r\nif (i == ARRAY_SIZE(bands))\r\nreturn -EINVAL;\r\ntea->band = i;\r\nif (tea->freq < rangelow || tea->freq > rangehigh) {\r\ntea->freq = clamp(tea->freq, rangelow,\r\nrangehigh);\r\nres = radio_tea5777_set_freq(tea);\r\nif (res)\r\nreturn res;\r\n}\r\n} else {\r\nrangelow = bands[tea->band].rangelow;\r\nrangehigh = bands[tea->band].rangehigh;\r\n}\r\nspacing = (tea->band == BAND_AM) ? (5 * 16) : (200 * 16);\r\norig_freq = tea->freq;\r\ntea->write_reg |= TEA5777_W_PROGBLIM_MASK;\r\nif (tea->seek_rangelow != rangelow) {\r\ntea->write_reg &= ~TEA5777_W_UPDWN_MASK;\r\ntea->freq = rangelow;\r\nres = radio_tea5777_set_freq(tea);\r\nif (res)\r\ngoto leave;\r\ntea->seek_rangelow = rangelow;\r\n}\r\nif (tea->seek_rangehigh != rangehigh) {\r\ntea->write_reg |= TEA5777_W_UPDWN_MASK;\r\ntea->freq = rangehigh;\r\nres = radio_tea5777_set_freq(tea);\r\nif (res)\r\ngoto leave;\r\ntea->seek_rangehigh = rangehigh;\r\n}\r\ntea->write_reg &= ~TEA5777_W_PROGBLIM_MASK;\r\ntea->write_reg |= TEA5777_W_SEARCH_MASK;\r\nif (a->seek_upward) {\r\ntea->write_reg |= TEA5777_W_UPDWN_MASK;\r\ntea->freq = orig_freq + spacing;\r\n} else {\r\ntea->write_reg &= ~TEA5777_W_UPDWN_MASK;\r\ntea->freq = orig_freq - spacing;\r\n}\r\nres = radio_tea5777_set_freq(tea);\r\nif (res)\r\ngoto leave;\r\ntimeout = jiffies + msecs_to_jiffies(5000);\r\nfor (;;) {\r\nif (time_after(jiffies, timeout)) {\r\nres = -ENODATA;\r\nbreak;\r\n}\r\nres = radio_tea5777_update_read_reg(tea, 100);\r\nif (res)\r\nbreak;\r\ntea->freq = (tea->read_reg & TEA5777_R_FM_PLL_MASK);\r\ntea->freq = tea5777_freq_to_v4l2_freq(tea, tea->freq);\r\nif ((tea->read_reg & TEA5777_R_SFOUND_MASK)) {\r\ntea->write_reg &= ~TEA5777_W_SEARCH_MASK;\r\nreturn 0;\r\n}\r\nif (tea->read_reg & TEA5777_R_BLIM_MASK) {\r\nres = -ENODATA;\r\nbreak;\r\n}\r\ntea->read_reg = -1;\r\n}\r\nleave:\r\ntea->write_reg &= ~TEA5777_W_PROGBLIM_MASK;\r\ntea->write_reg &= ~TEA5777_W_SEARCH_MASK;\r\ntea->freq = orig_freq;\r\nradio_tea5777_set_freq(tea);\r\nreturn res;\r\n}\r\nstatic int tea575x_s_ctrl(struct v4l2_ctrl *c)\r\n{\r\nstruct radio_tea5777 *tea =\r\ncontainer_of(c->handler, struct radio_tea5777, ctrl_handler);\r\nswitch (c->id) {\r\ncase V4L2_CID_AUDIO_MUTE:\r\nif (c->val)\r\ntea->write_reg |= TEA5777_W_MUTE_MASK;\r\nelse\r\ntea->write_reg &= ~TEA5777_W_MUTE_MASK;\r\nreturn radio_tea5777_set_freq(tea);\r\n}\r\nreturn -EINVAL;\r\n}\r\nint radio_tea5777_init(struct radio_tea5777 *tea, struct module *owner)\r\n{\r\nint res;\r\ntea->write_reg = (1LL << TEA5777_W_IFCE_SHIFT) |\r\n(1LL << TEA5777_W_IFW_SHIFT) |\r\n(1LL << TEA5777_W_INTEXT_SHIFT) |\r\n(1LL << TEA5777_W_CHP0_SHIFT) |\r\n(1LL << TEA5777_W_SLEV_SHIFT);\r\ntea->freq = 90500 * 16;\r\ntea->audmode = V4L2_TUNER_MODE_STEREO;\r\nres = radio_tea5777_set_freq(tea);\r\nif (res) {\r\nv4l2_err(tea->v4l2_dev, "can't set initial freq (%d)\n", res);\r\nreturn res;\r\n}\r\ntea->vd = tea575x_radio;\r\nvideo_set_drvdata(&tea->vd, tea);\r\nmutex_init(&tea->mutex);\r\nstrlcpy(tea->vd.name, tea->v4l2_dev->name, sizeof(tea->vd.name));\r\ntea->vd.lock = &tea->mutex;\r\ntea->vd.v4l2_dev = tea->v4l2_dev;\r\ntea->fops = tea575x_fops;\r\ntea->fops.owner = owner;\r\ntea->vd.fops = &tea->fops;\r\nset_bit(V4L2_FL_USE_FH_PRIO, &tea->vd.flags);\r\ntea->vd.ctrl_handler = &tea->ctrl_handler;\r\nv4l2_ctrl_handler_init(&tea->ctrl_handler, 1);\r\nv4l2_ctrl_new_std(&tea->ctrl_handler, &tea575x_ctrl_ops,\r\nV4L2_CID_AUDIO_MUTE, 0, 1, 1, 1);\r\nres = tea->ctrl_handler.error;\r\nif (res) {\r\nv4l2_err(tea->v4l2_dev, "can't initialize controls\n");\r\nv4l2_ctrl_handler_free(&tea->ctrl_handler);\r\nreturn res;\r\n}\r\nv4l2_ctrl_handler_setup(&tea->ctrl_handler);\r\nres = video_register_device(&tea->vd, VFL_TYPE_RADIO, -1);\r\nif (res) {\r\nv4l2_err(tea->v4l2_dev, "can't register video device!\n");\r\nv4l2_ctrl_handler_free(tea->vd.ctrl_handler);\r\nreturn res;\r\n}\r\nreturn 0;\r\n}\r\nvoid radio_tea5777_exit(struct radio_tea5777 *tea)\r\n{\r\nvideo_unregister_device(&tea->vd);\r\nv4l2_ctrl_handler_free(tea->vd.ctrl_handler);\r\n}

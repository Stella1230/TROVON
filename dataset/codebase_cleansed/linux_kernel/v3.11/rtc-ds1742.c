static int ds1742_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct rtc_plat_data *pdata = platform_get_drvdata(pdev);\r\nvoid __iomem *ioaddr = pdata->ioaddr_rtc;\r\nu8 century;\r\ncentury = bin2bcd((tm->tm_year + 1900) / 100);\r\nwriteb(RTC_WRITE, ioaddr + RTC_CONTROL);\r\nwriteb(bin2bcd(tm->tm_year % 100), ioaddr + RTC_YEAR);\r\nwriteb(bin2bcd(tm->tm_mon + 1), ioaddr + RTC_MONTH);\r\nwriteb(bin2bcd(tm->tm_wday) & RTC_DAY_MASK, ioaddr + RTC_DAY);\r\nwriteb(bin2bcd(tm->tm_mday), ioaddr + RTC_DATE);\r\nwriteb(bin2bcd(tm->tm_hour), ioaddr + RTC_HOURS);\r\nwriteb(bin2bcd(tm->tm_min), ioaddr + RTC_MINUTES);\r\nwriteb(bin2bcd(tm->tm_sec) & RTC_SECONDS_MASK, ioaddr + RTC_SECONDS);\r\nwriteb(RTC_WRITE | (century & RTC_CENTURY_MASK), ioaddr + RTC_CENTURY);\r\nwriteb(century & RTC_CENTURY_MASK, ioaddr + RTC_CONTROL);\r\nreturn 0;\r\n}\r\nstatic int ds1742_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct rtc_plat_data *pdata = platform_get_drvdata(pdev);\r\nvoid __iomem *ioaddr = pdata->ioaddr_rtc;\r\nunsigned int year, month, day, hour, minute, second, week;\r\nunsigned int century;\r\nif (pdata->last_jiffies == jiffies)\r\nmsleep(1);\r\npdata->last_jiffies = jiffies;\r\nwriteb(RTC_READ, ioaddr + RTC_CONTROL);\r\nsecond = readb(ioaddr + RTC_SECONDS) & RTC_SECONDS_MASK;\r\nminute = readb(ioaddr + RTC_MINUTES);\r\nhour = readb(ioaddr + RTC_HOURS);\r\nday = readb(ioaddr + RTC_DATE);\r\nweek = readb(ioaddr + RTC_DAY) & RTC_DAY_MASK;\r\nmonth = readb(ioaddr + RTC_MONTH);\r\nyear = readb(ioaddr + RTC_YEAR);\r\ncentury = readb(ioaddr + RTC_CENTURY) & RTC_CENTURY_MASK;\r\nwriteb(0, ioaddr + RTC_CONTROL);\r\ntm->tm_sec = bcd2bin(second);\r\ntm->tm_min = bcd2bin(minute);\r\ntm->tm_hour = bcd2bin(hour);\r\ntm->tm_mday = bcd2bin(day);\r\ntm->tm_wday = bcd2bin(week);\r\ntm->tm_mon = bcd2bin(month) - 1;\r\ntm->tm_year = bcd2bin(year) + bcd2bin(century) * 100 - 1900;\r\nif (rtc_valid_tm(tm) < 0) {\r\ndev_err(dev, "retrieved date/time is not valid.\n");\r\nrtc_time_to_tm(0, tm);\r\n}\r\nreturn 0;\r\n}\r\nstatic ssize_t ds1742_nvram_read(struct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *bin_attr,\r\nchar *buf, loff_t pos, size_t size)\r\n{\r\nstruct device *dev = container_of(kobj, struct device, kobj);\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct rtc_plat_data *pdata = platform_get_drvdata(pdev);\r\nvoid __iomem *ioaddr = pdata->ioaddr_nvram;\r\nssize_t count;\r\nfor (count = 0; size > 0 && pos < pdata->size_nvram; count++, size--)\r\n*buf++ = readb(ioaddr + pos++);\r\nreturn count;\r\n}\r\nstatic ssize_t ds1742_nvram_write(struct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *bin_attr,\r\nchar *buf, loff_t pos, size_t size)\r\n{\r\nstruct device *dev = container_of(kobj, struct device, kobj);\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct rtc_plat_data *pdata = platform_get_drvdata(pdev);\r\nvoid __iomem *ioaddr = pdata->ioaddr_nvram;\r\nssize_t count;\r\nfor (count = 0; size > 0 && pos < pdata->size_nvram; count++, size--)\r\nwriteb(*buf++, ioaddr + pos++);\r\nreturn count;\r\n}\r\nstatic int ds1742_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct rtc_device *rtc;\r\nstruct resource *res;\r\nunsigned int cen, sec;\r\nstruct rtc_plat_data *pdata;\r\nvoid __iomem *ioaddr;\r\nint ret = 0;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENODEV;\r\npdata = devm_kzalloc(&pdev->dev, sizeof(*pdata), GFP_KERNEL);\r\nif (!pdata)\r\nreturn -ENOMEM;\r\npdata->size = resource_size(res);\r\nif (!devm_request_mem_region(&pdev->dev, res->start, pdata->size,\r\npdev->name))\r\nreturn -EBUSY;\r\nioaddr = devm_ioremap(&pdev->dev, res->start, pdata->size);\r\nif (!ioaddr)\r\nreturn -ENOMEM;\r\npdata->ioaddr_nvram = ioaddr;\r\npdata->size_nvram = pdata->size - RTC_SIZE;\r\npdata->ioaddr_rtc = ioaddr + pdata->size_nvram;\r\nsysfs_bin_attr_init(&pdata->nvram_attr);\r\npdata->nvram_attr.attr.name = "nvram";\r\npdata->nvram_attr.attr.mode = S_IRUGO | S_IWUSR;\r\npdata->nvram_attr.read = ds1742_nvram_read;\r\npdata->nvram_attr.write = ds1742_nvram_write;\r\npdata->nvram_attr.size = pdata->size_nvram;\r\nioaddr = pdata->ioaddr_rtc;\r\nsec = readb(ioaddr + RTC_SECONDS);\r\nif (sec & RTC_STOP) {\r\nsec &= RTC_SECONDS_MASK;\r\ncen = readb(ioaddr + RTC_CENTURY) & RTC_CENTURY_MASK;\r\nwriteb(RTC_WRITE, ioaddr + RTC_CONTROL);\r\nwriteb(sec, ioaddr + RTC_SECONDS);\r\nwriteb(cen & RTC_CENTURY_MASK, ioaddr + RTC_CONTROL);\r\n}\r\nif (!(readb(ioaddr + RTC_DAY) & RTC_BATT_FLAG))\r\ndev_warn(&pdev->dev, "voltage-low detected.\n");\r\npdata->last_jiffies = jiffies;\r\nplatform_set_drvdata(pdev, pdata);\r\nrtc = devm_rtc_device_register(&pdev->dev, pdev->name,\r\n&ds1742_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc))\r\nreturn PTR_ERR(rtc);\r\npdata->rtc = rtc;\r\nret = sysfs_create_bin_file(&pdev->dev.kobj, &pdata->nvram_attr);\r\nreturn ret;\r\n}\r\nstatic int ds1742_rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct rtc_plat_data *pdata = platform_get_drvdata(pdev);\r\nsysfs_remove_bin_file(&pdev->dev.kobj, &pdata->nvram_attr);\r\nreturn 0;\r\n}

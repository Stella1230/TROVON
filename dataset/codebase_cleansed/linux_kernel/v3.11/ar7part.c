static int create_mtd_partitions(struct mtd_info *master,\r\nstruct mtd_partition **pparts,\r\nstruct mtd_part_parser_data *data)\r\n{\r\nstruct ar7_bin_rec header;\r\nunsigned int offset;\r\nsize_t len;\r\nunsigned int pre_size = master->erasesize, post_size = 0;\r\nunsigned int root_offset = ROOT_OFFSET;\r\nint retries = 10;\r\nstruct mtd_partition *ar7_parts;\r\nar7_parts = kzalloc(sizeof(*ar7_parts) * AR7_PARTS, GFP_KERNEL);\r\nif (!ar7_parts)\r\nreturn -ENOMEM;\r\nar7_parts[0].name = "loader";\r\nar7_parts[0].offset = 0;\r\nar7_parts[0].size = master->erasesize;\r\nar7_parts[0].mask_flags = MTD_WRITEABLE;\r\nar7_parts[1].name = "config";\r\nar7_parts[1].offset = 0;\r\nar7_parts[1].size = master->erasesize;\r\nar7_parts[1].mask_flags = 0;\r\ndo {\r\noffset = pre_size;\r\nmtd_read(master, offset, sizeof(header), &len,\r\n(uint8_t *)&header);\r\nif (!strncmp((char *)&header, "TIENV0.8", 8))\r\nar7_parts[1].offset = pre_size;\r\nif (header.checksum == LOADER_MAGIC1)\r\nbreak;\r\nif (header.checksum == LOADER_MAGIC2)\r\nbreak;\r\npre_size += master->erasesize;\r\n} while (retries--);\r\npre_size = offset;\r\nif (!ar7_parts[1].offset) {\r\nar7_parts[1].offset = master->size - master->erasesize;\r\npost_size = master->erasesize;\r\n}\r\nswitch (header.checksum) {\r\ncase LOADER_MAGIC1:\r\nwhile (header.length) {\r\noffset += sizeof(header) + header.length;\r\nmtd_read(master, offset, sizeof(header), &len,\r\n(uint8_t *)&header);\r\n}\r\nroot_offset = offset + sizeof(header) + 4;\r\nbreak;\r\ncase LOADER_MAGIC2:\r\nwhile (header.length) {\r\noffset += sizeof(header) + header.length;\r\nmtd_read(master, offset, sizeof(header), &len,\r\n(uint8_t *)&header);\r\n}\r\nroot_offset = offset + sizeof(header) + 4 + 0xff;\r\nroot_offset &= ~(uint32_t)0xff;\r\nbreak;\r\ndefault:\r\nprintk(KERN_WARNING "Unknown magic: %08x\n", header.checksum);\r\nbreak;\r\n}\r\nmtd_read(master, root_offset, sizeof(header), &len, (u8 *)&header);\r\nif (header.checksum != SQUASHFS_MAGIC) {\r\nroot_offset += master->erasesize - 1;\r\nroot_offset &= ~(master->erasesize - 1);\r\n}\r\nar7_parts[2].name = "linux";\r\nar7_parts[2].offset = pre_size;\r\nar7_parts[2].size = master->size - pre_size - post_size;\r\nar7_parts[2].mask_flags = 0;\r\nar7_parts[3].name = "rootfs";\r\nar7_parts[3].offset = root_offset;\r\nar7_parts[3].size = master->size - root_offset - post_size;\r\nar7_parts[3].mask_flags = 0;\r\n*pparts = ar7_parts;\r\nreturn AR7_PARTS;\r\n}\r\nstatic int __init ar7_parser_init(void)\r\n{\r\nreturn register_mtd_parser(&ar7_parser);\r\n}\r\nstatic void __exit ar7_parser_exit(void)\r\n{\r\nderegister_mtd_parser(&ar7_parser);\r\n}

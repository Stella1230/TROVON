static int mantis_ca_read_attr_mem(struct dvb_ca_en50221 *en50221, int slot, int addr)\r\n{\r\nstruct mantis_ca *ca = en50221->data;\r\nstruct mantis_pci *mantis = ca->ca_priv;\r\ndprintk(MANTIS_DEBUG, 1, "Slot(%d): Request Attribute Mem Read", slot);\r\nif (slot != 0)\r\nreturn -EINVAL;\r\nreturn mantis_hif_read_mem(ca, addr);\r\n}\r\nstatic int mantis_ca_write_attr_mem(struct dvb_ca_en50221 *en50221, int slot, int addr, u8 data)\r\n{\r\nstruct mantis_ca *ca = en50221->data;\r\nstruct mantis_pci *mantis = ca->ca_priv;\r\ndprintk(MANTIS_DEBUG, 1, "Slot(%d): Request Attribute Mem Write", slot);\r\nif (slot != 0)\r\nreturn -EINVAL;\r\nreturn mantis_hif_write_mem(ca, addr, data);\r\n}\r\nstatic int mantis_ca_read_cam_ctl(struct dvb_ca_en50221 *en50221, int slot, u8 addr)\r\n{\r\nstruct mantis_ca *ca = en50221->data;\r\nstruct mantis_pci *mantis = ca->ca_priv;\r\ndprintk(MANTIS_DEBUG, 1, "Slot(%d): Request CAM control Read", slot);\r\nif (slot != 0)\r\nreturn -EINVAL;\r\nreturn mantis_hif_read_iom(ca, addr);\r\n}\r\nstatic int mantis_ca_write_cam_ctl(struct dvb_ca_en50221 *en50221, int slot, u8 addr, u8 data)\r\n{\r\nstruct mantis_ca *ca = en50221->data;\r\nstruct mantis_pci *mantis = ca->ca_priv;\r\ndprintk(MANTIS_DEBUG, 1, "Slot(%d): Request CAM control Write", slot);\r\nif (slot != 0)\r\nreturn -EINVAL;\r\nreturn mantis_hif_write_iom(ca, addr, data);\r\n}\r\nstatic int mantis_ca_slot_reset(struct dvb_ca_en50221 *en50221, int slot)\r\n{\r\nstruct mantis_ca *ca = en50221->data;\r\nstruct mantis_pci *mantis = ca->ca_priv;\r\ndprintk(MANTIS_DEBUG, 1, "Slot(%d): Slot RESET", slot);\r\nudelay(500);\r\nmmwrite(0xda, MANTIS_PCMCIA_RESET);\r\nudelay(500);\r\nmmwrite(0x00, MANTIS_PCMCIA_RESET);\r\nmsleep(1000);\r\ndvb_ca_en50221_camready_irq(&ca->en50221, 0);\r\nreturn 0;\r\n}\r\nstatic int mantis_ca_slot_shutdown(struct dvb_ca_en50221 *en50221, int slot)\r\n{\r\nstruct mantis_ca *ca = en50221->data;\r\nstruct mantis_pci *mantis = ca->ca_priv;\r\ndprintk(MANTIS_DEBUG, 1, "Slot(%d): Slot shutdown", slot);\r\nreturn 0;\r\n}\r\nstatic int mantis_ts_control(struct dvb_ca_en50221 *en50221, int slot)\r\n{\r\nstruct mantis_ca *ca = en50221->data;\r\nstruct mantis_pci *mantis = ca->ca_priv;\r\ndprintk(MANTIS_DEBUG, 1, "Slot(%d): TS control", slot);\r\nreturn 0;\r\n}\r\nstatic int mantis_slot_status(struct dvb_ca_en50221 *en50221, int slot, int open)\r\n{\r\nstruct mantis_ca *ca = en50221->data;\r\nstruct mantis_pci *mantis = ca->ca_priv;\r\ndprintk(MANTIS_DEBUG, 1, "Slot(%d): Poll Slot status", slot);\r\nif (ca->slot_state == MODULE_INSERTED) {\r\ndprintk(MANTIS_DEBUG, 1, "CA Module present and ready");\r\nreturn DVB_CA_EN50221_POLL_CAM_PRESENT | DVB_CA_EN50221_POLL_CAM_READY;\r\n} else {\r\ndprintk(MANTIS_DEBUG, 1, "CA Module not present or not ready");\r\n}\r\nreturn 0;\r\n}\r\nint mantis_ca_init(struct mantis_pci *mantis)\r\n{\r\nstruct dvb_adapter *dvb_adapter = &mantis->dvb_adapter;\r\nstruct mantis_ca *ca;\r\nint ca_flags = 0, result;\r\ndprintk(MANTIS_DEBUG, 1, "Initializing Mantis CA");\r\nca = kzalloc(sizeof(struct mantis_ca), GFP_KERNEL);\r\nif (!ca) {\r\ndprintk(MANTIS_ERROR, 1, "Out of memory!, exiting ..");\r\nresult = -ENOMEM;\r\ngoto err;\r\n}\r\nca->ca_priv = mantis;\r\nmantis->mantis_ca = ca;\r\nca_flags = DVB_CA_EN50221_FLAG_IRQ_CAMCHANGE;\r\nca->en50221.owner = THIS_MODULE;\r\nca->en50221.read_attribute_mem = mantis_ca_read_attr_mem;\r\nca->en50221.write_attribute_mem = mantis_ca_write_attr_mem;\r\nca->en50221.read_cam_control = mantis_ca_read_cam_ctl;\r\nca->en50221.write_cam_control = mantis_ca_write_cam_ctl;\r\nca->en50221.slot_reset = mantis_ca_slot_reset;\r\nca->en50221.slot_shutdown = mantis_ca_slot_shutdown;\r\nca->en50221.slot_ts_enable = mantis_ts_control;\r\nca->en50221.poll_slot_status = mantis_slot_status;\r\nca->en50221.data = ca;\r\nmutex_init(&ca->ca_lock);\r\ninit_waitqueue_head(&ca->hif_data_wq);\r\ninit_waitqueue_head(&ca->hif_opdone_wq);\r\ninit_waitqueue_head(&ca->hif_write_wq);\r\ndprintk(MANTIS_ERROR, 1, "Registering EN50221 device");\r\nresult = dvb_ca_en50221_init(dvb_adapter, &ca->en50221, ca_flags, 1);\r\nif (result != 0) {\r\ndprintk(MANTIS_ERROR, 1, "EN50221: Initialization failed <%d>", result);\r\ngoto err;\r\n}\r\ndprintk(MANTIS_ERROR, 1, "Registered EN50221 device");\r\nmantis_evmgr_init(ca);\r\nreturn 0;\r\nerr:\r\nkfree(ca);\r\nreturn result;\r\n}\r\nvoid mantis_ca_exit(struct mantis_pci *mantis)\r\n{\r\nstruct mantis_ca *ca = mantis->mantis_ca;\r\ndprintk(MANTIS_DEBUG, 1, "Mantis CA exit");\r\nif (!ca)\r\nreturn;\r\nmantis_evmgr_exit(ca);\r\ndprintk(MANTIS_ERROR, 1, "Unregistering EN50221 device");\r\ndvb_ca_en50221_release(&ca->en50221);\r\nkfree(ca);\r\n}

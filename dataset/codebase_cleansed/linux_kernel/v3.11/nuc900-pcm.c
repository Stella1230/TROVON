static int nuc900_dma_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct nuc900_audio *nuc900_audio = runtime->private_data;\r\nunsigned long flags;\r\nint ret = 0;\r\nret = snd_pcm_lib_malloc_pages(substream, params_buffer_bytes(params));\r\nif (ret < 0)\r\nreturn ret;\r\nspin_lock_irqsave(&nuc900_audio->lock, flags);\r\nnuc900_audio->substream = substream;\r\nnuc900_audio->dma_addr[substream->stream] = runtime->dma_addr;\r\nnuc900_audio->buffersize[substream->stream] =\r\nparams_buffer_bytes(params);\r\nspin_unlock_irqrestore(&nuc900_audio->lock, flags);\r\nreturn ret;\r\n}\r\nstatic void nuc900_update_dma_register(struct snd_pcm_substream *substream,\r\ndma_addr_t dma_addr, size_t count)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct nuc900_audio *nuc900_audio = runtime->private_data;\r\nvoid __iomem *mmio_addr, *mmio_len;\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK) {\r\nmmio_addr = nuc900_audio->mmio + ACTL_PDSTB;\r\nmmio_len = nuc900_audio->mmio + ACTL_PDST_LENGTH;\r\n} else {\r\nmmio_addr = nuc900_audio->mmio + ACTL_RDSTB;\r\nmmio_len = nuc900_audio->mmio + ACTL_RDST_LENGTH;\r\n}\r\nAUDIO_WRITE(mmio_addr, dma_addr);\r\nAUDIO_WRITE(mmio_len, count);\r\n}\r\nstatic void nuc900_dma_start(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct nuc900_audio *nuc900_audio = runtime->private_data;\r\nunsigned long val;\r\nval = AUDIO_READ(nuc900_audio->mmio + ACTL_CON);\r\nval |= (T_DMA_IRQ | R_DMA_IRQ);\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_CON, val);\r\n}\r\nstatic void nuc900_dma_stop(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct nuc900_audio *nuc900_audio = runtime->private_data;\r\nunsigned long val;\r\nval = AUDIO_READ(nuc900_audio->mmio + ACTL_CON);\r\nval &= ~(T_DMA_IRQ | R_DMA_IRQ);\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_CON, val);\r\n}\r\nstatic irqreturn_t nuc900_dma_interrupt(int irq, void *dev_id)\r\n{\r\nstruct snd_pcm_substream *substream = dev_id;\r\nstruct nuc900_audio *nuc900_audio = substream->runtime->private_data;\r\nunsigned long val;\r\nspin_lock(&nuc900_audio->lock);\r\nval = AUDIO_READ(nuc900_audio->mmio + ACTL_CON);\r\nif (val & R_DMA_IRQ) {\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_CON, val | R_DMA_IRQ);\r\nval = AUDIO_READ(nuc900_audio->mmio + ACTL_RSR);\r\nif (val & R_DMA_MIDDLE_IRQ) {\r\nval |= R_DMA_MIDDLE_IRQ;\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_RSR, val);\r\n}\r\nif (val & R_DMA_END_IRQ) {\r\nval |= R_DMA_END_IRQ;\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_RSR, val);\r\n}\r\n} else if (val & T_DMA_IRQ) {\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_CON, val | T_DMA_IRQ);\r\nval = AUDIO_READ(nuc900_audio->mmio + ACTL_PSR);\r\nif (val & P_DMA_MIDDLE_IRQ) {\r\nval |= P_DMA_MIDDLE_IRQ;\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_PSR, val);\r\n}\r\nif (val & P_DMA_END_IRQ) {\r\nval |= P_DMA_END_IRQ;\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_PSR, val);\r\n}\r\n} else {\r\ndev_err(nuc900_audio->dev, "Wrong DMA interrupt status!\n");\r\nspin_unlock(&nuc900_audio->lock);\r\nreturn IRQ_HANDLED;\r\n}\r\nspin_unlock(&nuc900_audio->lock);\r\nsnd_pcm_period_elapsed(substream);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int nuc900_dma_hw_free(struct snd_pcm_substream *substream)\r\n{\r\nsnd_pcm_lib_free_pages(substream);\r\nreturn 0;\r\n}\r\nstatic int nuc900_dma_prepare(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct nuc900_audio *nuc900_audio = runtime->private_data;\r\nunsigned long flags, val;\r\nint ret = 0;\r\nspin_lock_irqsave(&nuc900_audio->lock, flags);\r\nnuc900_update_dma_register(substream,\r\nnuc900_audio->dma_addr[substream->stream],\r\nnuc900_audio->buffersize[substream->stream]);\r\nval = AUDIO_READ(nuc900_audio->mmio + ACTL_RESET);\r\nswitch (runtime->channels) {\r\ncase 1:\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK) {\r\nval &= ~(PLAY_LEFT_CHNNEL | PLAY_RIGHT_CHNNEL);\r\nval |= PLAY_RIGHT_CHNNEL;\r\n} else {\r\nval &= ~(RECORD_LEFT_CHNNEL | RECORD_RIGHT_CHNNEL);\r\nval |= RECORD_RIGHT_CHNNEL;\r\n}\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_RESET, val);\r\nbreak;\r\ncase 2:\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nval |= (PLAY_LEFT_CHNNEL | PLAY_RIGHT_CHNNEL);\r\nelse\r\nval |= (RECORD_LEFT_CHNNEL | RECORD_RIGHT_CHNNEL);\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_RESET, val);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\n}\r\nspin_unlock_irqrestore(&nuc900_audio->lock, flags);\r\nreturn ret;\r\n}\r\nstatic int nuc900_dma_trigger(struct snd_pcm_substream *substream, int cmd)\r\n{\r\nint ret = 0;\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\nnuc900_dma_start(substream);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\nnuc900_dma_stop(substream);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int nuc900_dma_getposition(struct snd_pcm_substream *substream,\r\ndma_addr_t *src, dma_addr_t *dst)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct nuc900_audio *nuc900_audio = runtime->private_data;\r\nif (src != NULL)\r\n*src = AUDIO_READ(nuc900_audio->mmio + ACTL_PDSTC);\r\nif (dst != NULL)\r\n*dst = AUDIO_READ(nuc900_audio->mmio + ACTL_RDSTC);\r\nreturn 0;\r\n}\r\nstatic snd_pcm_uframes_t nuc900_dma_pointer(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\ndma_addr_t src, dst;\r\nunsigned long res;\r\nnuc900_dma_getposition(substream, &src, &dst);\r\nif (substream->stream == SNDRV_PCM_STREAM_CAPTURE)\r\nres = dst - runtime->dma_addr;\r\nelse\r\nres = src - runtime->dma_addr;\r\nreturn bytes_to_frames(substream->runtime, res);\r\n}\r\nstatic int nuc900_dma_open(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct nuc900_audio *nuc900_audio;\r\nsnd_soc_set_runtime_hwparams(substream, &nuc900_pcm_hardware);\r\nnuc900_audio = nuc900_ac97_data;\r\nif (request_irq(nuc900_audio->irq_num, nuc900_dma_interrupt,\r\n0, "nuc900-dma", substream))\r\nreturn -EBUSY;\r\nruntime->private_data = nuc900_audio;\r\nreturn 0;\r\n}\r\nstatic int nuc900_dma_close(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct nuc900_audio *nuc900_audio = runtime->private_data;\r\nfree_irq(nuc900_audio->irq_num, substream);\r\nreturn 0;\r\n}\r\nstatic int nuc900_dma_mmap(struct snd_pcm_substream *substream,\r\nstruct vm_area_struct *vma)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nreturn dma_mmap_writecombine(substream->pcm->card->dev, vma,\r\nruntime->dma_area,\r\nruntime->dma_addr,\r\nruntime->dma_bytes);\r\n}\r\nstatic void nuc900_dma_free_dma_buffers(struct snd_pcm *pcm)\r\n{\r\nsnd_pcm_lib_preallocate_free_for_all(pcm);\r\n}\r\nstatic int nuc900_dma_new(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct snd_card *card = rtd->card->snd_card;\r\nstruct snd_pcm *pcm = rtd->pcm;\r\nif (!card->dev->dma_mask)\r\ncard->dev->dma_mask = &nuc900_pcm_dmamask;\r\nif (!card->dev->coherent_dma_mask)\r\ncard->dev->coherent_dma_mask = DMA_BIT_MASK(32);\r\nsnd_pcm_lib_preallocate_pages_for_all(pcm, SNDRV_DMA_TYPE_DEV,\r\ncard->dev, 4 * 1024, (4 * 1024) - 1);\r\nreturn 0;\r\n}\r\nstatic int nuc900_soc_platform_probe(struct platform_device *pdev)\r\n{\r\nreturn snd_soc_register_platform(&pdev->dev, &nuc900_soc_platform);\r\n}\r\nstatic int nuc900_soc_platform_remove(struct platform_device *pdev)\r\n{\r\nsnd_soc_unregister_platform(&pdev->dev);\r\nreturn 0;\r\n}

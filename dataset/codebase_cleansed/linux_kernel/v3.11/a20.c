static int empty_8042(void)\r\n{\r\nu8 status;\r\nint loops = MAX_8042_LOOPS;\r\nint ffs = MAX_8042_FF;\r\nwhile (loops--) {\r\nio_delay();\r\nstatus = inb(0x64);\r\nif (status == 0xff) {\r\nif (!--ffs)\r\nreturn -1;\r\n}\r\nif (status & 1) {\r\nio_delay();\r\n(void)inb(0x60);\r\n} else if (!(status & 2)) {\r\nreturn 0;\r\n}\r\n}\r\nreturn -1;\r\n}\r\nstatic int a20_test(int loops)\r\n{\r\nint ok = 0;\r\nint saved, ctr;\r\nset_fs(0x0000);\r\nset_gs(0xffff);\r\nsaved = ctr = rdfs32(A20_TEST_ADDR);\r\nwhile (loops--) {\r\nwrfs32(++ctr, A20_TEST_ADDR);\r\nio_delay();\r\nok = rdgs32(A20_TEST_ADDR+0x10) ^ ctr;\r\nif (ok)\r\nbreak;\r\n}\r\nwrfs32(saved, A20_TEST_ADDR);\r\nreturn ok;\r\n}\r\nstatic int a20_test_short(void)\r\n{\r\nreturn a20_test(A20_TEST_SHORT);\r\n}\r\nstatic int a20_test_long(void)\r\n{\r\nreturn a20_test(A20_TEST_LONG);\r\n}\r\nstatic void enable_a20_bios(void)\r\n{\r\nstruct biosregs ireg;\r\ninitregs(&ireg);\r\nireg.ax = 0x2401;\r\nintcall(0x15, &ireg, NULL);\r\n}\r\nstatic void enable_a20_kbc(void)\r\n{\r\nempty_8042();\r\noutb(0xd1, 0x64);\r\nempty_8042();\r\noutb(0xdf, 0x60);\r\nempty_8042();\r\noutb(0xff, 0x64);\r\nempty_8042();\r\n}\r\nstatic void enable_a20_fast(void)\r\n{\r\nu8 port_a;\r\nport_a = inb(0x92);\r\nport_a |= 0x02;\r\nport_a &= ~0x01;\r\noutb(port_a, 0x92);\r\n}\r\nint enable_a20(void)\r\n{\r\nint loops = A20_ENABLE_LOOPS;\r\nint kbc_err;\r\nwhile (loops--) {\r\nif (a20_test_short())\r\nreturn 0;\r\nenable_a20_bios();\r\nif (a20_test_short())\r\nreturn 0;\r\nkbc_err = empty_8042();\r\nif (a20_test_short())\r\nreturn 0;\r\nif (!kbc_err) {\r\nenable_a20_kbc();\r\nif (a20_test_long())\r\nreturn 0;\r\n}\r\nenable_a20_fast();\r\nif (a20_test_long())\r\nreturn 0;\r\n}\r\nreturn -1;\r\n}

static void am35xx_enable_emac_int(void)\r\n{\r\nu32 v;\r\nv = omap_ctrl_readl(AM35XX_CONTROL_LVL_INTR_CLEAR);\r\nv |= (AM35XX_CPGMAC_C0_RX_PULSE_CLR | AM35XX_CPGMAC_C0_TX_PULSE_CLR |\r\nAM35XX_CPGMAC_C0_MISC_PULSE_CLR | AM35XX_CPGMAC_C0_RX_THRESH_CLR);\r\nomap_ctrl_writel(v, AM35XX_CONTROL_LVL_INTR_CLEAR);\r\nomap_ctrl_readl(AM35XX_CONTROL_LVL_INTR_CLEAR);\r\n}\r\nstatic void am35xx_disable_emac_int(void)\r\n{\r\nu32 v;\r\nv = omap_ctrl_readl(AM35XX_CONTROL_LVL_INTR_CLEAR);\r\nv |= (AM35XX_CPGMAC_C0_RX_PULSE_CLR | AM35XX_CPGMAC_C0_TX_PULSE_CLR);\r\nomap_ctrl_writel(v, AM35XX_CONTROL_LVL_INTR_CLEAR);\r\nomap_ctrl_readl(AM35XX_CONTROL_LVL_INTR_CLEAR);\r\n}\r\nstatic int __init omap_davinci_emac_dev_init(struct omap_hwmod *oh,\r\nvoid *pdata, int pdata_len)\r\n{\r\nstruct platform_device *pdev;\r\npdev = omap_device_build(oh->class->name, 0, oh, pdata, pdata_len);\r\nif (IS_ERR(pdev)) {\r\nWARN(1, "Can't build omap_device for %s:%s.\n",\r\noh->class->name, oh->name);\r\nreturn PTR_ERR(pdev);\r\n}\r\nreturn 0;\r\n}\r\nvoid __init am35xx_emac_init(unsigned long mdio_bus_freq, u8 rmii_en)\r\n{\r\nstruct omap_hwmod *oh;\r\nu32 v;\r\nint ret;\r\noh = omap_hwmod_lookup("davinci_mdio");\r\nif (!oh) {\r\npr_err("Could not find davinci_mdio hwmod\n");\r\nreturn;\r\n}\r\nam35xx_mdio_pdata.bus_freq = mdio_bus_freq;\r\nret = omap_davinci_emac_dev_init(oh, &am35xx_mdio_pdata,\r\nsizeof(am35xx_mdio_pdata));\r\nif (ret) {\r\npr_err("Could not build davinci_mdio hwmod device\n");\r\nreturn;\r\n}\r\noh = omap_hwmod_lookup("davinci_emac");\r\nif (!oh) {\r\npr_err("Could not find davinci_emac hwmod\n");\r\nreturn;\r\n}\r\nam35xx_emac_pdata.rmii_en = rmii_en;\r\nret = omap_davinci_emac_dev_init(oh, &am35xx_emac_pdata,\r\nsizeof(am35xx_emac_pdata));\r\nif (ret) {\r\npr_err("Could not build davinci_emac hwmod device\n");\r\nreturn;\r\n}\r\nv = omap_ctrl_readl(AM35XX_CONTROL_IP_SW_RESET);\r\nv &= ~AM35XX_CPGMACSS_SW_RST;\r\nomap_ctrl_writel(v, AM35XX_CONTROL_IP_SW_RESET);\r\nomap_ctrl_readl(AM35XX_CONTROL_IP_SW_RESET);\r\n}

static int geode_rng_data_read(struct hwrng *rng, u32 *data)\r\n{\r\nvoid __iomem *mem = (void __iomem *)rng->priv;\r\n*data = readl(mem + GEODE_RNG_DATA_REG);\r\nreturn 4;\r\n}\r\nstatic int geode_rng_data_present(struct hwrng *rng, int wait)\r\n{\r\nvoid __iomem *mem = (void __iomem *)rng->priv;\r\nint data, i;\r\nfor (i = 0; i < 20; i++) {\r\ndata = !!(readl(mem + GEODE_RNG_STATUS_REG));\r\nif (data || !wait)\r\nbreak;\r\nudelay(10);\r\n}\r\nreturn data;\r\n}\r\nstatic int __init mod_init(void)\r\n{\r\nint err = -ENODEV;\r\nstruct pci_dev *pdev = NULL;\r\nconst struct pci_device_id *ent;\r\nvoid __iomem *mem;\r\nunsigned long rng_base;\r\nfor_each_pci_dev(pdev) {\r\nent = pci_match_id(pci_tbl, pdev);\r\nif (ent)\r\ngoto found;\r\n}\r\ngoto out;\r\nfound:\r\nrng_base = pci_resource_start(pdev, 0);\r\nif (rng_base == 0)\r\ngoto out;\r\nerr = -ENOMEM;\r\nmem = ioremap(rng_base, 0x58);\r\nif (!mem)\r\ngoto out;\r\ngeode_rng.priv = (unsigned long)mem;\r\nprintk(KERN_INFO "AMD Geode RNG detected\n");\r\nerr = hwrng_register(&geode_rng);\r\nif (err) {\r\nprintk(KERN_ERR PFX "RNG registering failed (%d)\n",\r\nerr);\r\ngoto err_unmap;\r\n}\r\nout:\r\nreturn err;\r\nerr_unmap:\r\niounmap(mem);\r\ngoto out;\r\n}\r\nstatic void __exit mod_exit(void)\r\n{\r\nvoid __iomem *mem = (void __iomem *)geode_rng.priv;\r\nhwrng_unregister(&geode_rng);\r\niounmap(mem);\r\n}

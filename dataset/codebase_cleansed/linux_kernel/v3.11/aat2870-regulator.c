static int aat2870_ldo_set_voltage_sel(struct regulator_dev *rdev,\r\nunsigned selector)\r\n{\r\nstruct aat2870_regulator *ri = rdev_get_drvdata(rdev);\r\nstruct aat2870_data *aat2870 = ri->aat2870;\r\nreturn aat2870->update(aat2870, ri->voltage_addr, ri->voltage_mask,\r\nselector << ri->voltage_shift);\r\n}\r\nstatic int aat2870_ldo_get_voltage_sel(struct regulator_dev *rdev)\r\n{\r\nstruct aat2870_regulator *ri = rdev_get_drvdata(rdev);\r\nstruct aat2870_data *aat2870 = ri->aat2870;\r\nu8 val;\r\nint ret;\r\nret = aat2870->read(aat2870, ri->voltage_addr, &val);\r\nif (ret)\r\nreturn ret;\r\nreturn (val & ri->voltage_mask) >> ri->voltage_shift;\r\n}\r\nstatic int aat2870_ldo_enable(struct regulator_dev *rdev)\r\n{\r\nstruct aat2870_regulator *ri = rdev_get_drvdata(rdev);\r\nstruct aat2870_data *aat2870 = ri->aat2870;\r\nreturn aat2870->update(aat2870, ri->enable_addr, ri->enable_mask,\r\nri->enable_mask);\r\n}\r\nstatic int aat2870_ldo_disable(struct regulator_dev *rdev)\r\n{\r\nstruct aat2870_regulator *ri = rdev_get_drvdata(rdev);\r\nstruct aat2870_data *aat2870 = ri->aat2870;\r\nreturn aat2870->update(aat2870, ri->enable_addr, ri->enable_mask, 0);\r\n}\r\nstatic int aat2870_ldo_is_enabled(struct regulator_dev *rdev)\r\n{\r\nstruct aat2870_regulator *ri = rdev_get_drvdata(rdev);\r\nstruct aat2870_data *aat2870 = ri->aat2870;\r\nu8 val;\r\nint ret;\r\nret = aat2870->read(aat2870, ri->enable_addr, &val);\r\nif (ret)\r\nreturn ret;\r\nreturn val & ri->enable_mask ? 1 : 0;\r\n}\r\nstatic struct aat2870_regulator *aat2870_get_regulator(int id)\r\n{\r\nstruct aat2870_regulator *ri = NULL;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(aat2870_regulators); i++) {\r\nri = &aat2870_regulators[i];\r\nif (ri->desc.id == id)\r\nbreak;\r\n}\r\nif (i == ARRAY_SIZE(aat2870_regulators))\r\nreturn NULL;\r\nri->enable_addr = AAT2870_LDO_EN;\r\nri->enable_shift = id - AAT2870_ID_LDOA;\r\nri->enable_mask = 0x1 << ri->enable_shift;\r\nri->voltage_addr = (id - AAT2870_ID_LDOA) / 2 ?\r\nAAT2870_LDO_CD : AAT2870_LDO_AB;\r\nri->voltage_shift = (id - AAT2870_ID_LDOA) % 2 ? 0 : 4;\r\nri->voltage_mask = 0xF << ri->voltage_shift;\r\nreturn ri;\r\n}\r\nstatic int aat2870_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct aat2870_regulator *ri;\r\nstruct regulator_config config = { };\r\nstruct regulator_dev *rdev;\r\nri = aat2870_get_regulator(pdev->id);\r\nif (!ri) {\r\ndev_err(&pdev->dev, "Invalid device ID, %d\n", pdev->id);\r\nreturn -EINVAL;\r\n}\r\nri->aat2870 = dev_get_drvdata(pdev->dev.parent);\r\nconfig.dev = &pdev->dev;\r\nconfig.driver_data = ri;\r\nconfig.init_data = pdev->dev.platform_data;\r\nrdev = regulator_register(&ri->desc, &config);\r\nif (IS_ERR(rdev)) {\r\ndev_err(&pdev->dev, "Failed to register regulator %s\n",\r\nri->desc.name);\r\nreturn PTR_ERR(rdev);\r\n}\r\nplatform_set_drvdata(pdev, rdev);\r\nreturn 0;\r\n}\r\nstatic int aat2870_regulator_remove(struct platform_device *pdev)\r\n{\r\nstruct regulator_dev *rdev = platform_get_drvdata(pdev);\r\nregulator_unregister(rdev);\r\nreturn 0;\r\n}\r\nstatic int __init aat2870_regulator_init(void)\r\n{\r\nreturn platform_driver_register(&aat2870_regulator_driver);\r\n}\r\nstatic void __exit aat2870_regulator_exit(void)\r\n{\r\nplatform_driver_unregister(&aat2870_regulator_driver);\r\n}

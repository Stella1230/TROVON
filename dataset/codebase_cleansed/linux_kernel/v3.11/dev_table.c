int sound_install_audiodrv(int vers, char *name, struct audio_driver *driver,\r\nint driver_size, int flags, unsigned int format_mask,\r\nvoid *devc, int dma1, int dma2)\r\n{\r\nstruct audio_driver *d;\r\nstruct audio_operations *op;\r\nint num;\r\nif (vers != AUDIO_DRIVER_VERSION || driver_size > sizeof(struct audio_driver)) {\r\nprintk(KERN_ERR "Sound: Incompatible audio driver for %s\n", name);\r\nreturn -(EINVAL);\r\n}\r\nnum = sound_alloc_audiodev();\r\nif (num == -1) {\r\nprintk(KERN_ERR "sound: Too many audio drivers\n");\r\nreturn -(EBUSY);\r\n}\r\nd = (struct audio_driver *) (sound_mem_blocks[sound_nblocks] = vmalloc(sizeof(struct audio_driver)));\r\nsound_nblocks++;\r\nif (sound_nblocks >= MAX_MEM_BLOCKS)\r\nsound_nblocks = MAX_MEM_BLOCKS - 1;\r\nop = (struct audio_operations *) (sound_mem_blocks[sound_nblocks] = vzalloc(sizeof(struct audio_operations)));\r\nsound_nblocks++;\r\nif (sound_nblocks >= MAX_MEM_BLOCKS)\r\nsound_nblocks = MAX_MEM_BLOCKS - 1;\r\nif (d == NULL || op == NULL) {\r\nprintk(KERN_ERR "Sound: Can't allocate driver for (%s)\n", name);\r\nsound_unload_audiodev(num);\r\nreturn -(ENOMEM);\r\n}\r\ninit_waitqueue_head(&op->in_sleeper);\r\ninit_waitqueue_head(&op->out_sleeper);\r\ninit_waitqueue_head(&op->poll_sleeper);\r\nif (driver_size < sizeof(struct audio_driver))\r\nmemset((char *) d, 0, sizeof(struct audio_driver));\r\nmemcpy((char *) d, (char *) driver, driver_size);\r\nop->d = d;\r\nstrlcpy(op->name, name, sizeof(op->name));\r\nop->flags = flags;\r\nop->format_mask = format_mask;\r\nop->devc = devc;\r\naudio_devs[num] = op;\r\nDMAbuf_init(num, dma1, dma2);\r\naudio_init_devices();\r\nreturn num;\r\n}\r\nint sound_install_mixer(int vers, char *name, struct mixer_operations *driver,\r\nint driver_size, void *devc)\r\n{\r\nstruct mixer_operations *op;\r\nint n = sound_alloc_mixerdev();\r\nif (n == -1) {\r\nprintk(KERN_ERR "Sound: Too many mixer drivers\n");\r\nreturn -EBUSY;\r\n}\r\nif (vers != MIXER_DRIVER_VERSION ||\r\ndriver_size > sizeof(struct mixer_operations)) {\r\nprintk(KERN_ERR "Sound: Incompatible mixer driver for %s\n", name);\r\nreturn -EINVAL;\r\n}\r\nop = (struct mixer_operations *) (sound_mem_blocks[sound_nblocks] = vzalloc(sizeof(struct mixer_operations)));\r\nsound_nblocks++;\r\nif (sound_nblocks >= MAX_MEM_BLOCKS)\r\nsound_nblocks = MAX_MEM_BLOCKS - 1;\r\nif (op == NULL) {\r\nprintk(KERN_ERR "Sound: Can't allocate mixer driver for (%s)\n", name);\r\nreturn -ENOMEM;\r\n}\r\nmemcpy((char *) op, (char *) driver, driver_size);\r\nstrlcpy(op->name, name, sizeof(op->name));\r\nop->devc = devc;\r\nmixer_devs[n] = op;\r\nreturn n;\r\n}\r\nvoid sound_unload_audiodev(int dev)\r\n{\r\nif (dev != -1) {\r\nDMAbuf_deinit(dev);\r\naudio_devs[dev] = NULL;\r\nunregister_sound_dsp((dev<<4)+3);\r\n}\r\n}\r\nstatic int sound_alloc_audiodev(void)\r\n{\r\nint i = register_sound_dsp(&oss_sound_fops, -1);\r\nif(i==-1)\r\nreturn i;\r\ni>>=4;\r\nif(i>=num_audiodevs)\r\nnum_audiodevs = i + 1;\r\nreturn i;\r\n}\r\nint sound_alloc_mididev(void)\r\n{\r\nint i = register_sound_midi(&oss_sound_fops, -1);\r\nif(i==-1)\r\nreturn i;\r\ni>>=4;\r\nif(i>=num_midis)\r\nnum_midis = i + 1;\r\nreturn i;\r\n}\r\nint sound_alloc_synthdev(void)\r\n{\r\nint i;\r\nfor (i = 0; i < MAX_SYNTH_DEV; i++) {\r\nif (synth_devs[i] == NULL) {\r\nif (i >= num_synths)\r\nnum_synths++;\r\nreturn i;\r\n}\r\n}\r\nreturn -1;\r\n}\r\nint sound_alloc_mixerdev(void)\r\n{\r\nint i = register_sound_mixer(&oss_sound_fops, -1);\r\nif(i==-1)\r\nreturn -1;\r\ni>>=4;\r\nif(i>=num_mixers)\r\nnum_mixers = i + 1;\r\nreturn i;\r\n}\r\nint sound_alloc_timerdev(void)\r\n{\r\nint i;\r\nfor (i = 0; i < MAX_TIMER_DEV; i++) {\r\nif (sound_timer_devs[i] == NULL) {\r\nif (i >= num_sound_timers)\r\nnum_sound_timers++;\r\nreturn i;\r\n}\r\n}\r\nreturn -1;\r\n}\r\nvoid sound_unload_mixerdev(int dev)\r\n{\r\nif (dev != -1) {\r\nmixer_devs[dev] = NULL;\r\nunregister_sound_mixer(dev<<4);\r\nnum_mixers--;\r\n}\r\n}\r\nvoid sound_unload_mididev(int dev)\r\n{\r\nif (dev != -1) {\r\nmidi_devs[dev] = NULL;\r\nunregister_sound_midi((dev<<4)+2);\r\n}\r\n}\r\nvoid sound_unload_synthdev(int dev)\r\n{\r\nif (dev != -1)\r\nsynth_devs[dev] = NULL;\r\n}\r\nvoid sound_unload_timerdev(int dev)\r\n{\r\nif (dev != -1)\r\nsound_timer_devs[dev] = NULL;\r\n}

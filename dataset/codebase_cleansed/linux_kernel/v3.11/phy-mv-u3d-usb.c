static u32 mv_u3d_phy_read(void __iomem *base, u32 reg)\r\n{\r\nvoid __iomem *addr, *data;\r\naddr = base;\r\ndata = base + 0x4;\r\nwritel_relaxed(reg, addr);\r\nreturn readl_relaxed(data);\r\n}\r\nstatic void mv_u3d_phy_set(void __iomem *base, u32 reg, u32 value)\r\n{\r\nvoid __iomem *addr, *data;\r\nu32 tmp;\r\naddr = base;\r\ndata = base + 0x4;\r\nwritel_relaxed(reg, addr);\r\ntmp = readl_relaxed(data);\r\ntmp |= value;\r\nwritel_relaxed(tmp, data);\r\n}\r\nstatic void mv_u3d_phy_clear(void __iomem *base, u32 reg, u32 value)\r\n{\r\nvoid __iomem *addr, *data;\r\nu32 tmp;\r\naddr = base;\r\ndata = base + 0x4;\r\nwritel_relaxed(reg, addr);\r\ntmp = readl_relaxed(data);\r\ntmp &= ~value;\r\nwritel_relaxed(tmp, data);\r\n}\r\nstatic void mv_u3d_phy_write(void __iomem *base, u32 reg, u32 value)\r\n{\r\nvoid __iomem *addr, *data;\r\naddr = base;\r\ndata = base + 0x4;\r\nwritel_relaxed(reg, addr);\r\nwritel_relaxed(value, data);\r\n}\r\nvoid mv_u3d_phy_shutdown(struct usb_phy *phy)\r\n{\r\nstruct mv_u3d_phy *mv_u3d_phy;\r\nvoid __iomem *base;\r\nu32 val;\r\nmv_u3d_phy = container_of(phy, struct mv_u3d_phy, phy);\r\nbase = mv_u3d_phy->base;\r\nval = mv_u3d_phy_read(base, USB3_POWER_PLL_CONTROL);\r\nval &= ~(USB3_POWER_PLL_CONTROL_PU);\r\nmv_u3d_phy_write(base, USB3_POWER_PLL_CONTROL, val);\r\nif (mv_u3d_phy->clk)\r\nclk_disable(mv_u3d_phy->clk);\r\n}\r\nstatic int mv_u3d_phy_init(struct usb_phy *phy)\r\n{\r\nstruct mv_u3d_phy *mv_u3d_phy;\r\nvoid __iomem *base;\r\nu32 val, count;\r\nmv_u3d_phy = container_of(phy, struct mv_u3d_phy, phy);\r\nif (mv_u3d_phy->clk)\r\nclk_enable(mv_u3d_phy->clk);\r\nbase = mv_u3d_phy->base;\r\nval = mv_u3d_phy_read(base, USB3_POWER_PLL_CONTROL);\r\nval &= ~(USB3_POWER_PLL_CONTROL_PU_MASK);\r\nval |= 0xF << USB3_POWER_PLL_CONTROL_PU_SHIFT;\r\nmv_u3d_phy_write(base, USB3_POWER_PLL_CONTROL, val);\r\nudelay(100);\r\nmv_u3d_phy_write(base, USB3_RESET_CONTROL,\r\nUSB3_RESET_CONTROL_RESET_PIPE);\r\nudelay(100);\r\nmv_u3d_phy_write(base, USB3_RESET_CONTROL,\r\nUSB3_RESET_CONTROL_RESET_PIPE\r\n| USB3_RESET_CONTROL_RESET_PHY);\r\nudelay(100);\r\nval = mv_u3d_phy_read(base, USB3_POWER_PLL_CONTROL);\r\nval &= ~(USB3_POWER_PLL_CONTROL_REF_FREF_SEL_MASK\r\n| USB3_POWER_PLL_CONTROL_PHY_MODE_MASK);\r\nval |= (USB3_PLL_25MHZ << USB3_POWER_PLL_CONTROL_REF_FREF_SEL_SHIFT)\r\n| (0x5 << USB3_POWER_PLL_CONTROL_PHY_MODE_SHIFT);\r\nmv_u3d_phy_write(base, USB3_POWER_PLL_CONTROL, val);\r\nudelay(100);\r\nmv_u3d_phy_clear(base, USB3_KVCO_CALI_CONTROL,\r\nUSB3_KVCO_CALI_CONTROL_USE_MAX_PLL_RATE_MASK);\r\nudelay(100);\r\nval = mv_u3d_phy_read(base, USB3_SQUELCH_FFE);\r\nval &= ~(USB3_SQUELCH_FFE_FFE_CAP_SEL_MASK\r\n| USB3_SQUELCH_FFE_FFE_RES_SEL_MASK\r\n| USB3_SQUELCH_FFE_SQ_THRESH_IN_MASK);\r\nval |= ((0xD << USB3_SQUELCH_FFE_FFE_CAP_SEL_SHIFT)\r\n| (0x7 << USB3_SQUELCH_FFE_FFE_RES_SEL_SHIFT)\r\n| (0x8 << USB3_SQUELCH_FFE_SQ_THRESH_IN_SHIFT));\r\nmv_u3d_phy_write(base, USB3_SQUELCH_FFE, val);\r\nudelay(100);\r\nval = mv_u3d_phy_read(base, USB3_GEN1_SET0);\r\nval &= ~USB3_GEN1_SET0_G1_TX_SLEW_CTRL_EN_MASK;\r\nval |= 1 << USB3_GEN1_SET0_G1_TX_EMPH_EN_SHIFT;\r\nmv_u3d_phy_write(base, USB3_GEN1_SET0, val);\r\nudelay(100);\r\nval = mv_u3d_phy_read(base, USB3_GEN2_SET0);\r\nval &= ~(USB3_GEN2_SET0_G2_TX_AMP_MASK\r\n| USB3_GEN2_SET0_G2_TX_EMPH_AMP_MASK\r\n| USB3_GEN2_SET0_G2_TX_SLEW_CTRL_EN_MASK);\r\nval |= ((0x14 << USB3_GEN2_SET0_G2_TX_AMP_SHIFT)\r\n| (1 << USB3_GEN2_SET0_G2_TX_AMP_ADJ_SHIFT)\r\n| (0xA << USB3_GEN2_SET0_G2_TX_EMPH_AMP_SHIFT)\r\n| (1 << USB3_GEN2_SET0_G2_TX_EMPH_EN_SHIFT));\r\nmv_u3d_phy_write(base, USB3_GEN2_SET0, val);\r\nudelay(100);\r\nmv_u3d_phy_read(base, USB3_TX_EMPPH);\r\nval &= ~(USB3_TX_EMPPH_AMP_MASK\r\n| USB3_TX_EMPPH_EN_MASK\r\n| USB3_TX_EMPPH_AMP_FORCE_MASK\r\n| USB3_TX_EMPPH_PAR1_MASK\r\n| USB3_TX_EMPPH_PAR2_MASK);\r\nval |= ((0xB << USB3_TX_EMPPH_AMP_SHIFT)\r\n| (1 << USB3_TX_EMPPH_EN_SHIFT)\r\n| (1 << USB3_TX_EMPPH_AMP_FORCE_SHIFT)\r\n| (0x1C << USB3_TX_EMPPH_PAR1_SHIFT)\r\n| (1 << USB3_TX_EMPPH_PAR2_SHIFT));\r\nmv_u3d_phy_write(base, USB3_TX_EMPPH, val);\r\nudelay(100);\r\nval = mv_u3d_phy_read(base, USB3_GEN2_SET1);\r\nval &= ~(USB3_GEN2_SET1_G2_RX_SELMUPI_MASK\r\n| USB3_GEN2_SET1_G2_RX_SELMUPF_MASK\r\n| USB3_GEN2_SET1_G2_RX_SELMUFI_MASK\r\n| USB3_GEN2_SET1_G2_RX_SELMUFF_MASK);\r\nval |= ((1 << USB3_GEN2_SET1_G2_RX_SELMUPI_SHIFT)\r\n| (1 << USB3_GEN2_SET1_G2_RX_SELMUPF_SHIFT)\r\n| (1 << USB3_GEN2_SET1_G2_RX_SELMUFI_SHIFT)\r\n| (1 << USB3_GEN2_SET1_G2_RX_SELMUFF_SHIFT));\r\nmv_u3d_phy_write(base, USB3_GEN2_SET1, val);\r\nudelay(100);\r\nval = mv_u3d_phy_read(base, USB3_DIGITAL_LOOPBACK_EN);\r\nval &= ~USB3_DIGITAL_LOOPBACK_EN_SEL_BITS_MASK;\r\nval |= 1 << USB3_DIGITAL_LOOPBACK_EN_SEL_BITS_SHIFT;\r\nmv_u3d_phy_write(base, USB3_DIGITAL_LOOPBACK_EN, val);\r\nudelay(100);\r\nval = mv_u3d_phy_read(base, USB3_IMPEDANCE_TX_SSC);\r\nval &= ~USB3_IMPEDANCE_TX_SSC_SSC_AMP_MASK;\r\nval |= 0xC << USB3_IMPEDANCE_TX_SSC_SSC_AMP_SHIFT;\r\nmv_u3d_phy_write(base, USB3_IMPEDANCE_TX_SSC, val);\r\nudelay(100);\r\nval = mv_u3d_phy_read(base, USB3_IMPEDANCE_CALI_CTRL);\r\nval &= ~USB3_IMPEDANCE_CALI_CTRL_IMP_CAL_THR_MASK;\r\nval |= 0x4 << USB3_IMPEDANCE_CALI_CTRL_IMP_CAL_THR_SHIFT;\r\nmv_u3d_phy_write(base, USB3_IMPEDANCE_CALI_CTRL, val);\r\nudelay(100);\r\nval = mv_u3d_phy_read(base, USB3_PHY_ISOLATION_MODE);\r\nval &= ~(USB3_PHY_ISOLATION_MODE_PHY_GEN_RX_MASK\r\n| USB3_PHY_ISOLATION_MODE_PHY_GEN_TX_MASK\r\n| USB3_PHY_ISOLATION_MODE_TX_DRV_IDLE_MASK);\r\nval |= ((1 << USB3_PHY_ISOLATION_MODE_PHY_GEN_RX_SHIFT)\r\n| (1 << USB3_PHY_ISOLATION_MODE_PHY_GEN_TX_SHIFT));\r\nmv_u3d_phy_write(base, USB3_PHY_ISOLATION_MODE, val);\r\nudelay(100);\r\nval = mv_u3d_phy_read(base, USB3_TXDETRX);\r\nval &= ~(USB3_TXDETRX_VTHSEL_MASK);\r\nval |= 0x1 << USB3_TXDETRX_VTHSEL_SHIFT;\r\nmv_u3d_phy_write(base, USB3_TXDETRX, val);\r\nudelay(100);\r\ndev_dbg(mv_u3d_phy->dev, "start calibration\n");\r\ncalstart:\r\nmv_u3d_phy_set(base, USB3_KVCO_CALI_CONTROL,\r\n1 << USB3_KVCO_CALI_CONTROL_CAL_START_SHIFT);\r\nmdelay(1);\r\ncount = 0;\r\nwhile (1) {\r\nval = mv_u3d_phy_read(base, USB3_KVCO_CALI_CONTROL);\r\nif (val & (1 << USB3_KVCO_CALI_CONTROL_CAL_DONE_SHIFT))\r\nbreak;\r\nelse if (count > 50) {\r\ndev_dbg(mv_u3d_phy->dev, "calibration failure, retry...\n");\r\ngoto calstart;\r\n}\r\ncount++;\r\nmdelay(1);\r\n}\r\nmv_u3d_phy_write(base, USB3_PIPE_SM_CTRL,\r\n1 << USB3_PIPE_SM_CTRL_PHY_INIT_DONE);\r\nreturn 0;\r\n}\r\nstatic int mv_u3d_phy_probe(struct platform_device *pdev)\r\n{\r\nstruct mv_u3d_phy *mv_u3d_phy;\r\nstruct mv_usb_platform_data *pdata;\r\nstruct device *dev = &pdev->dev;\r\nstruct resource *res;\r\nvoid __iomem *phy_base;\r\nint ret;\r\npdata = pdev->dev.platform_data;\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "%s: no platform data defined\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nphy_base = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(phy_base))\r\nreturn PTR_ERR(phy_base);\r\nmv_u3d_phy = devm_kzalloc(dev, sizeof(*mv_u3d_phy), GFP_KERNEL);\r\nif (!mv_u3d_phy)\r\nreturn -ENOMEM;\r\nmv_u3d_phy->dev = &pdev->dev;\r\nmv_u3d_phy->plat = pdata;\r\nmv_u3d_phy->base = phy_base;\r\nmv_u3d_phy->phy.dev = mv_u3d_phy->dev;\r\nmv_u3d_phy->phy.label = "mv-u3d-phy";\r\nmv_u3d_phy->phy.init = mv_u3d_phy_init;\r\nmv_u3d_phy->phy.shutdown = mv_u3d_phy_shutdown;\r\nret = usb_add_phy(&mv_u3d_phy->phy, USB_PHY_TYPE_USB3);\r\nif (ret)\r\ngoto err;\r\nif (!mv_u3d_phy->clk)\r\nmv_u3d_phy->clk = clk_get(mv_u3d_phy->dev, "u3dphy");\r\nplatform_set_drvdata(pdev, mv_u3d_phy);\r\ndev_info(&pdev->dev, "Initialized Marvell USB 3.0 PHY\n");\r\nerr:\r\nreturn ret;\r\n}\r\nstatic int mv_u3d_phy_remove(struct platform_device *pdev)\r\n{\r\nstruct mv_u3d_phy *mv_u3d_phy = platform_get_drvdata(pdev);\r\nusb_remove_phy(&mv_u3d_phy->phy);\r\nif (mv_u3d_phy->clk) {\r\nclk_put(mv_u3d_phy->clk);\r\nmv_u3d_phy->clk = NULL;\r\n}\r\nreturn 0;\r\n}

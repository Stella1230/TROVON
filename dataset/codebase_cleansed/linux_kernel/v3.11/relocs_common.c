void die(char *fmt, ...)\r\n{\r\nva_list ap;\r\nva_start(ap, fmt);\r\nvfprintf(stderr, fmt, ap);\r\nva_end(ap);\r\nexit(1);\r\n}\r\nstatic void usage(void)\r\n{\r\ndie("relocs [--abs-syms|--abs-relocs|--text|--realmode] vmlinux\n");\r\n}\r\nint main(int argc, char **argv)\r\n{\r\nint show_absolute_syms, show_absolute_relocs;\r\nint as_text, use_real_mode;\r\nconst char *fname;\r\nFILE *fp;\r\nint i;\r\nunsigned char e_ident[EI_NIDENT];\r\nshow_absolute_syms = 0;\r\nshow_absolute_relocs = 0;\r\nas_text = 0;\r\nuse_real_mode = 0;\r\nfname = NULL;\r\nfor (i = 1; i < argc; i++) {\r\nchar *arg = argv[i];\r\nif (*arg == '-') {\r\nif (strcmp(arg, "--abs-syms") == 0) {\r\nshow_absolute_syms = 1;\r\ncontinue;\r\n}\r\nif (strcmp(arg, "--abs-relocs") == 0) {\r\nshow_absolute_relocs = 1;\r\ncontinue;\r\n}\r\nif (strcmp(arg, "--text") == 0) {\r\nas_text = 1;\r\ncontinue;\r\n}\r\nif (strcmp(arg, "--realmode") == 0) {\r\nuse_real_mode = 1;\r\ncontinue;\r\n}\r\n}\r\nelse if (!fname) {\r\nfname = arg;\r\ncontinue;\r\n}\r\nusage();\r\n}\r\nif (!fname) {\r\nusage();\r\n}\r\nfp = fopen(fname, "r");\r\nif (!fp) {\r\ndie("Cannot open %s: %s\n", fname, strerror(errno));\r\n}\r\nif (fread(&e_ident, 1, EI_NIDENT, fp) != EI_NIDENT) {\r\ndie("Cannot read %s: %s", fname, strerror(errno));\r\n}\r\nrewind(fp);\r\nif (e_ident[EI_CLASS] == ELFCLASS64)\r\nprocess_64(fp, use_real_mode, as_text,\r\nshow_absolute_syms, show_absolute_relocs);\r\nelse\r\nprocess_32(fp, use_real_mode, as_text,\r\nshow_absolute_syms, show_absolute_relocs);\r\nfclose(fp);\r\nreturn 0;\r\n}

static void h1940_latch_control(unsigned int clear, unsigned int set)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nlatch_state &= ~clear;\r\nlatch_state |= set;\r\n__raw_writel(latch_state, H1940_LATCH);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic inline int h1940_gpiolib_to_latch(int offset)\r\n{\r\nreturn 1 << (offset + 16);\r\n}\r\nstatic void h1940_gpiolib_latch_set(struct gpio_chip *chip,\r\nunsigned offset, int value)\r\n{\r\nint latch_bit = h1940_gpiolib_to_latch(offset);\r\nh1940_latch_control(value ? 0 : latch_bit,\r\nvalue ? latch_bit : 0);\r\n}\r\nstatic int h1940_gpiolib_latch_output(struct gpio_chip *chip,\r\nunsigned offset, int value)\r\n{\r\nh1940_gpiolib_latch_set(chip, offset, value);\r\nreturn 0;\r\n}\r\nstatic int h1940_gpiolib_latch_get(struct gpio_chip *chip,\r\nunsigned offset)\r\n{\r\nreturn (latch_state >> (offset + 16)) & 1;\r\n}\r\nstatic int power_supply_init(struct device *dev)\r\n{\r\nreturn gpio_request(S3C2410_GPF(2), "cable plugged");\r\n}\r\nstatic int h1940_is_ac_online(void)\r\n{\r\nreturn !gpio_get_value(S3C2410_GPF(2));\r\n}\r\nstatic void power_supply_exit(struct device *dev)\r\n{\r\ngpio_free(S3C2410_GPF(2));\r\n}\r\nstatic int h1940_bat_init(void)\r\n{\r\nint ret;\r\nret = gpio_request(H1940_LATCH_SM803_ENABLE, "h1940-charger-enable");\r\nif (ret)\r\nreturn ret;\r\ngpio_direction_output(H1940_LATCH_SM803_ENABLE, 0);\r\nreturn 0;\r\n}\r\nstatic void h1940_bat_exit(void)\r\n{\r\ngpio_free(H1940_LATCH_SM803_ENABLE);\r\n}\r\nstatic void h1940_enable_charger(void)\r\n{\r\ngpio_set_value(H1940_LATCH_SM803_ENABLE, 1);\r\n}\r\nstatic void h1940_disable_charger(void)\r\n{\r\ngpio_set_value(H1940_LATCH_SM803_ENABLE, 0);\r\n}\r\nint h1940_led_blink_set(unsigned gpio, int state,\r\nunsigned long *delay_on, unsigned long *delay_off)\r\n{\r\nint blink_gpio, check_gpio1, check_gpio2;\r\nswitch (gpio) {\r\ncase H1940_LATCH_LED_GREEN:\r\nblink_gpio = S3C2410_GPA(7);\r\ncheck_gpio1 = S3C2410_GPA(1);\r\ncheck_gpio2 = S3C2410_GPA(3);\r\nbreak;\r\ncase H1940_LATCH_LED_RED:\r\nblink_gpio = S3C2410_GPA(1);\r\ncheck_gpio1 = S3C2410_GPA(7);\r\ncheck_gpio2 = S3C2410_GPA(3);\r\nbreak;\r\ndefault:\r\nblink_gpio = S3C2410_GPA(3);\r\ncheck_gpio1 = S3C2410_GPA(1);\r\ncheck_gpio2 = S3C2410_GPA(7);\r\nbreak;\r\n}\r\nif (delay_on && delay_off && !*delay_on && !*delay_off)\r\n*delay_on = *delay_off = 500;\r\nspin_lock(&h1940_blink_spin);\r\nswitch (state) {\r\ncase GPIO_LED_NO_BLINK_LOW:\r\ncase GPIO_LED_NO_BLINK_HIGH:\r\nif (!gpio_get_value(check_gpio1) &&\r\n!gpio_get_value(check_gpio2))\r\ngpio_set_value(H1940_LATCH_LED_FLASH, 0);\r\ngpio_set_value(blink_gpio, 0);\r\nif (gpio_is_valid(gpio))\r\ngpio_set_value(gpio, state);\r\nbreak;\r\ncase GPIO_LED_BLINK:\r\nif (gpio_is_valid(gpio))\r\ngpio_set_value(gpio, 0);\r\ngpio_set_value(H1940_LATCH_LED_FLASH, 1);\r\ngpio_set_value(blink_gpio, 1);\r\nbreak;\r\n}\r\nspin_unlock(&h1940_blink_spin);\r\nreturn 0;\r\n}\r\nstatic void h1940_set_mmc_power(unsigned char power_mode, unsigned short vdd)\r\n{\r\nswitch (power_mode) {\r\ncase MMC_POWER_OFF:\r\ngpio_set_value(H1940_LATCH_SD_POWER, 0);\r\nbreak;\r\ncase MMC_POWER_UP:\r\ncase MMC_POWER_ON:\r\ngpio_set_value(H1940_LATCH_SD_POWER, 1);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic int h1940_backlight_init(struct device *dev)\r\n{\r\ngpio_request(S3C2410_GPB(0), "Backlight");\r\ngpio_direction_output(S3C2410_GPB(0), 0);\r\ns3c_gpio_setpull(S3C2410_GPB(0), S3C_GPIO_PULL_NONE);\r\ns3c_gpio_cfgpin(S3C2410_GPB(0), S3C2410_GPB0_TOUT0);\r\ngpio_set_value(H1940_LATCH_MAX1698_nSHUTDOWN, 1);\r\nreturn 0;\r\n}\r\nstatic int h1940_backlight_notify(struct device *dev, int brightness)\r\n{\r\nif (!brightness) {\r\ngpio_direction_output(S3C2410_GPB(0), 1);\r\ngpio_set_value(H1940_LATCH_MAX1698_nSHUTDOWN, 0);\r\n} else {\r\ngpio_direction_output(S3C2410_GPB(0), 0);\r\ns3c_gpio_setpull(S3C2410_GPB(0), S3C_GPIO_PULL_NONE);\r\ns3c_gpio_cfgpin(S3C2410_GPB(0), S3C2410_GPB0_TOUT0);\r\ngpio_set_value(H1940_LATCH_MAX1698_nSHUTDOWN, 1);\r\n}\r\nreturn brightness;\r\n}\r\nstatic void h1940_backlight_exit(struct device *dev)\r\n{\r\ngpio_direction_output(S3C2410_GPB(0), 1);\r\ngpio_set_value(H1940_LATCH_MAX1698_nSHUTDOWN, 0);\r\n}\r\nstatic void h1940_lcd_power_set(struct plat_lcd_data *pd,\r\nunsigned int power)\r\n{\r\nint value, retries = 100;\r\nif (!power) {\r\ngpio_set_value(S3C2410_GPC(0), 0);\r\ndo {\r\nvalue = gpio_get_value(S3C2410_GPC(6));\r\n} while (value && retries--);\r\ngpio_set_value(H1940_LATCH_LCD_P2, 0);\r\ngpio_set_value(H1940_LATCH_LCD_P3, 0);\r\ngpio_set_value(H1940_LATCH_LCD_P4, 0);\r\ngpio_direction_output(S3C2410_GPC(1), 0);\r\ngpio_direction_output(S3C2410_GPC(4), 0);\r\ngpio_set_value(H1940_LATCH_LCD_P1, 0);\r\ngpio_set_value(H1940_LATCH_LCD_P0, 0);\r\ngpio_set_value(S3C2410_GPC(5), 0);\r\n} else {\r\ngpio_set_value(H1940_LATCH_LCD_P0, 1);\r\ngpio_set_value(H1940_LATCH_LCD_P1, 1);\r\ngpio_direction_input(S3C2410_GPC(1));\r\ngpio_direction_input(S3C2410_GPC(4));\r\nmdelay(10);\r\ns3c_gpio_cfgpin(S3C2410_GPC(1), S3C_GPIO_SFN(2));\r\ns3c_gpio_cfgpin(S3C2410_GPC(4), S3C_GPIO_SFN(2));\r\ngpio_set_value(S3C2410_GPC(5), 1);\r\ngpio_set_value(S3C2410_GPC(0), 1);\r\ngpio_set_value(H1940_LATCH_LCD_P3, 1);\r\ngpio_set_value(H1940_LATCH_LCD_P2, 1);\r\ngpio_set_value(H1940_LATCH_LCD_P4, 1);\r\n}\r\n}\r\nstatic void __init h1940_map_io(void)\r\n{\r\ns3c24xx_init_io(h1940_iodesc, ARRAY_SIZE(h1940_iodesc));\r\ns3c24xx_init_clocks(0);\r\ns3c24xx_init_uarts(h1940_uartcfgs, ARRAY_SIZE(h1940_uartcfgs));\r\nsamsung_set_timer_source(SAMSUNG_PWM3, SAMSUNG_PWM4);\r\n#ifdef CONFIG_PM_H1940\r\nmemcpy(phys_to_virt(H1940_SUSPEND_RESUMEAT), h1940_pm_return, 1024);\r\n#endif\r\ns3c_pm_init();\r\nh1940_latch_control(0, 0);\r\nWARN_ON(gpiochip_add(&h1940_latch_gpiochip));\r\n}\r\nstatic void __init h1940_reserve(void)\r\n{\r\nmemblock_reserve(0x30003000, 0x1000);\r\nmemblock_reserve(0x30081000, 0x1000);\r\n}\r\nstatic void __init h1940_init(void)\r\n{\r\nu32 tmp;\r\ns3c24xx_fb_set_platdata(&h1940_fb_info);\r\ns3c24xx_mci_set_platdata(&h1940_mmc_cfg);\r\ns3c24xx_udc_set_platdata(&h1940_udc_cfg);\r\ns3c24xx_ts_set_platdata(&h1940_ts_cfg);\r\ns3c_i2c0_set_platdata(NULL);\r\ns3c2410_modify_misccr(S3C2410_MISCCR_USBHOST |\r\nS3C2410_MISCCR_USBSUSPND0 |\r\nS3C2410_MISCCR_USBSUSPND1, 0x0);\r\ntmp = (0x78 << S3C24XX_PLL_MDIV_SHIFT)\r\n| (0x02 << S3C24XX_PLL_PDIV_SHIFT)\r\n| (0x03 << S3C24XX_PLL_SDIV_SHIFT);\r\nwritel(tmp, S3C2410_UPLLCON);\r\ngpio_request(S3C2410_GPC(0), "LCD power");\r\ngpio_request(S3C2410_GPC(1), "LCD power");\r\ngpio_request(S3C2410_GPC(4), "LCD power");\r\ngpio_request(S3C2410_GPC(5), "LCD power");\r\ngpio_request(S3C2410_GPC(6), "LCD power");\r\ngpio_request(H1940_LATCH_LCD_P0, "LCD power");\r\ngpio_request(H1940_LATCH_LCD_P1, "LCD power");\r\ngpio_request(H1940_LATCH_LCD_P2, "LCD power");\r\ngpio_request(H1940_LATCH_LCD_P3, "LCD power");\r\ngpio_request(H1940_LATCH_LCD_P4, "LCD power");\r\ngpio_request(H1940_LATCH_MAX1698_nSHUTDOWN, "LCD power");\r\ngpio_direction_output(S3C2410_GPC(0), 0);\r\ngpio_direction_output(S3C2410_GPC(1), 0);\r\ngpio_direction_output(S3C2410_GPC(4), 0);\r\ngpio_direction_output(S3C2410_GPC(5), 0);\r\ngpio_direction_input(S3C2410_GPC(6));\r\ngpio_direction_output(H1940_LATCH_LCD_P0, 0);\r\ngpio_direction_output(H1940_LATCH_LCD_P1, 0);\r\ngpio_direction_output(H1940_LATCH_LCD_P2, 0);\r\ngpio_direction_output(H1940_LATCH_LCD_P3, 0);\r\ngpio_direction_output(H1940_LATCH_LCD_P4, 0);\r\ngpio_direction_output(H1940_LATCH_MAX1698_nSHUTDOWN, 0);\r\ngpio_request(H1940_LATCH_SD_POWER, "SD power");\r\ngpio_direction_output(H1940_LATCH_SD_POWER, 0);\r\nplatform_add_devices(h1940_devices, ARRAY_SIZE(h1940_devices));\r\ngpio_request(S3C2410_GPA(1), "Red LED blink");\r\ngpio_request(S3C2410_GPA(3), "Blue LED blink");\r\ngpio_request(S3C2410_GPA(7), "Green LED blink");\r\ngpio_request(H1940_LATCH_LED_FLASH, "LED blink");\r\ngpio_direction_output(S3C2410_GPA(1), 0);\r\ngpio_direction_output(S3C2410_GPA(3), 0);\r\ngpio_direction_output(S3C2410_GPA(7), 0);\r\ngpio_direction_output(H1940_LATCH_LED_FLASH, 0);\r\ni2c_register_board_info(0, h1940_i2c_devices,\r\nARRAY_SIZE(h1940_i2c_devices));\r\n}

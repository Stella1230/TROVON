static int bcm47xxsflash_read(struct mtd_info *mtd, loff_t from, size_t len,\r\nsize_t *retlen, u_char *buf)\r\n{\r\nstruct bcm47xxsflash *b47s = mtd->priv;\r\nif ((from + len) > mtd->size)\r\nreturn -EINVAL;\r\nmemcpy_fromio(buf, (void __iomem *)KSEG0ADDR(b47s->window + from),\r\nlen);\r\n*retlen = len;\r\nreturn len;\r\n}\r\nstatic void bcm47xxsflash_fill_mtd(struct bcm47xxsflash *b47s)\r\n{\r\nstruct mtd_info *mtd = &b47s->mtd;\r\nmtd->priv = b47s;\r\nmtd->name = "bcm47xxsflash";\r\nmtd->owner = THIS_MODULE;\r\nmtd->type = MTD_ROM;\r\nmtd->size = b47s->size;\r\nmtd->_read = bcm47xxsflash_read;\r\nmtd->flags = MTD_CAP_ROM;\r\nmtd->writebufsize = mtd->writesize = 1;\r\n}\r\nstatic int bcm47xxsflash_bcma_probe(struct platform_device *pdev)\r\n{\r\nstruct bcma_sflash *sflash = dev_get_platdata(&pdev->dev);\r\nstruct bcm47xxsflash *b47s;\r\nint err;\r\nb47s = kzalloc(sizeof(*b47s), GFP_KERNEL);\r\nif (!b47s) {\r\nerr = -ENOMEM;\r\ngoto out;\r\n}\r\nsflash->priv = b47s;\r\nb47s->bcma_cc = container_of(sflash, struct bcma_drv_cc, sflash);\r\nswitch (b47s->bcma_cc->capabilities & BCMA_CC_CAP_FLASHT) {\r\ncase BCMA_CC_FLASHT_STSER:\r\nb47s->type = BCM47XXSFLASH_TYPE_ST;\r\nbreak;\r\ncase BCMA_CC_FLASHT_ATSER:\r\nb47s->type = BCM47XXSFLASH_TYPE_ATMEL;\r\nbreak;\r\n}\r\nb47s->window = sflash->window;\r\nb47s->blocksize = sflash->blocksize;\r\nb47s->numblocks = sflash->numblocks;\r\nb47s->size = sflash->size;\r\nbcm47xxsflash_fill_mtd(b47s);\r\nerr = mtd_device_parse_register(&b47s->mtd, probes, NULL, NULL, 0);\r\nif (err) {\r\npr_err("Failed to register MTD device: %d\n", err);\r\ngoto err_dev_reg;\r\n}\r\nreturn 0;\r\nerr_dev_reg:\r\nkfree(&b47s->mtd);\r\nout:\r\nreturn err;\r\n}\r\nstatic int bcm47xxsflash_bcma_remove(struct platform_device *pdev)\r\n{\r\nstruct bcma_sflash *sflash = dev_get_platdata(&pdev->dev);\r\nstruct bcm47xxsflash *b47s = sflash->priv;\r\nmtd_device_unregister(&b47s->mtd);\r\nkfree(b47s);\r\nreturn 0;\r\n}\r\nstatic int __init bcm47xxsflash_init(void)\r\n{\r\nint err;\r\nerr = platform_driver_register(&bcma_sflash_driver);\r\nif (err)\r\npr_err("Failed to register BCMA serial flash driver: %d\n",\r\nerr);\r\nreturn err;\r\n}\r\nstatic void __exit bcm47xxsflash_exit(void)\r\n{\r\nplatform_driver_unregister(&bcma_sflash_driver);\r\n}

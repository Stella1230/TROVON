u32 radeon_read_ring_rptr(drm_radeon_private_t *dev_priv, u32 off)\r\n{\r\nu32 val;\r\nif (dev_priv->flags & RADEON_IS_AGP) {\r\nval = DRM_READ32(dev_priv->ring_rptr, off);\r\n} else {\r\nval = *(((volatile u32 *)\r\ndev_priv->ring_rptr->handle) +\r\n(off / sizeof(u32)));\r\nval = le32_to_cpu(val);\r\n}\r\nreturn val;\r\n}\r\nu32 radeon_get_ring_head(drm_radeon_private_t *dev_priv)\r\n{\r\nif (dev_priv->writeback_works)\r\nreturn radeon_read_ring_rptr(dev_priv, 0);\r\nelse {\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R600)\r\nreturn RADEON_READ(R600_CP_RB_RPTR);\r\nelse\r\nreturn RADEON_READ(RADEON_CP_RB_RPTR);\r\n}\r\n}\r\nvoid radeon_write_ring_rptr(drm_radeon_private_t *dev_priv, u32 off, u32 val)\r\n{\r\nif (dev_priv->flags & RADEON_IS_AGP)\r\nDRM_WRITE32(dev_priv->ring_rptr, off, val);\r\nelse\r\n*(((volatile u32 *) dev_priv->ring_rptr->handle) +\r\n(off / sizeof(u32))) = cpu_to_le32(val);\r\n}\r\nvoid radeon_set_ring_head(drm_radeon_private_t *dev_priv, u32 val)\r\n{\r\nradeon_write_ring_rptr(dev_priv, 0, val);\r\n}\r\nu32 radeon_get_scratch(drm_radeon_private_t *dev_priv, int index)\r\n{\r\nif (dev_priv->writeback_works) {\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R600)\r\nreturn radeon_read_ring_rptr(dev_priv,\r\nR600_SCRATCHOFF(index));\r\nelse\r\nreturn radeon_read_ring_rptr(dev_priv,\r\nRADEON_SCRATCHOFF(index));\r\n} else {\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R600)\r\nreturn RADEON_READ(R600_SCRATCH_REG0 + 4*index);\r\nelse\r\nreturn RADEON_READ(RADEON_SCRATCH_REG0 + 4*index);\r\n}\r\n}\r\nstatic u32 R500_READ_MCIND(drm_radeon_private_t *dev_priv, int addr)\r\n{\r\nu32 ret;\r\nRADEON_WRITE(R520_MC_IND_INDEX, 0x7f0000 | (addr & 0xff));\r\nret = RADEON_READ(R520_MC_IND_DATA);\r\nRADEON_WRITE(R520_MC_IND_INDEX, 0);\r\nreturn ret;\r\n}\r\nstatic u32 RS480_READ_MCIND(drm_radeon_private_t *dev_priv, int addr)\r\n{\r\nu32 ret;\r\nRADEON_WRITE(RS480_NB_MC_INDEX, addr & 0xff);\r\nret = RADEON_READ(RS480_NB_MC_DATA);\r\nRADEON_WRITE(RS480_NB_MC_INDEX, 0xff);\r\nreturn ret;\r\n}\r\nstatic u32 RS690_READ_MCIND(drm_radeon_private_t *dev_priv, int addr)\r\n{\r\nu32 ret;\r\nRADEON_WRITE(RS690_MC_INDEX, (addr & RS690_MC_INDEX_MASK));\r\nret = RADEON_READ(RS690_MC_DATA);\r\nRADEON_WRITE(RS690_MC_INDEX, RS690_MC_INDEX_MASK);\r\nreturn ret;\r\n}\r\nstatic u32 RS600_READ_MCIND(drm_radeon_private_t *dev_priv, int addr)\r\n{\r\nu32 ret;\r\nRADEON_WRITE(RS600_MC_INDEX, ((addr & RS600_MC_ADDR_MASK) |\r\nRS600_MC_IND_CITF_ARB0));\r\nret = RADEON_READ(RS600_MC_DATA);\r\nreturn ret;\r\n}\r\nstatic u32 IGP_READ_MCIND(drm_radeon_private_t *dev_priv, int addr)\r\n{\r\nif (((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS690) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS740))\r\nreturn RS690_READ_MCIND(dev_priv, addr);\r\nelse if ((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS600)\r\nreturn RS600_READ_MCIND(dev_priv, addr);\r\nelse\r\nreturn RS480_READ_MCIND(dev_priv, addr);\r\n}\r\nu32 radeon_read_fb_location(drm_radeon_private_t *dev_priv)\r\n{\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_RV770)\r\nreturn RADEON_READ(R700_MC_VM_FB_LOCATION);\r\nelse if ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R600)\r\nreturn RADEON_READ(R600_MC_VM_FB_LOCATION);\r\nelse if ((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV515)\r\nreturn R500_READ_MCIND(dev_priv, RV515_MC_FB_LOCATION);\r\nelse if (((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS690) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS740))\r\nreturn RS690_READ_MCIND(dev_priv, RS690_MC_FB_LOCATION);\r\nelse if ((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS600)\r\nreturn RS600_READ_MCIND(dev_priv, RS600_MC_FB_LOCATION);\r\nelse if ((dev_priv->flags & RADEON_FAMILY_MASK) > CHIP_RV515)\r\nreturn R500_READ_MCIND(dev_priv, R520_MC_FB_LOCATION);\r\nelse\r\nreturn RADEON_READ(RADEON_MC_FB_LOCATION);\r\n}\r\nstatic void radeon_write_fb_location(drm_radeon_private_t *dev_priv, u32 fb_loc)\r\n{\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_RV770)\r\nRADEON_WRITE(R700_MC_VM_FB_LOCATION, fb_loc);\r\nelse if ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R600)\r\nRADEON_WRITE(R600_MC_VM_FB_LOCATION, fb_loc);\r\nelse if ((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV515)\r\nR500_WRITE_MCIND(RV515_MC_FB_LOCATION, fb_loc);\r\nelse if (((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS690) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS740))\r\nRS690_WRITE_MCIND(RS690_MC_FB_LOCATION, fb_loc);\r\nelse if ((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS600)\r\nRS600_WRITE_MCIND(RS600_MC_FB_LOCATION, fb_loc);\r\nelse if ((dev_priv->flags & RADEON_FAMILY_MASK) > CHIP_RV515)\r\nR500_WRITE_MCIND(R520_MC_FB_LOCATION, fb_loc);\r\nelse\r\nRADEON_WRITE(RADEON_MC_FB_LOCATION, fb_loc);\r\n}\r\nvoid radeon_write_agp_location(drm_radeon_private_t *dev_priv, u32 agp_loc)\r\n{\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_RV770) {\r\nRADEON_WRITE(R700_MC_VM_AGP_BOT, agp_loc & 0xffff);\r\nRADEON_WRITE(R700_MC_VM_AGP_TOP, (agp_loc >> 16) & 0xffff);\r\n} else if ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R600) {\r\nRADEON_WRITE(R600_MC_VM_AGP_BOT, agp_loc & 0xffff);\r\nRADEON_WRITE(R600_MC_VM_AGP_TOP, (agp_loc >> 16) & 0xffff);\r\n} else if ((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV515)\r\nR500_WRITE_MCIND(RV515_MC_AGP_LOCATION, agp_loc);\r\nelse if (((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS690) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS740))\r\nRS690_WRITE_MCIND(RS690_MC_AGP_LOCATION, agp_loc);\r\nelse if ((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS600)\r\nRS600_WRITE_MCIND(RS600_MC_AGP_LOCATION, agp_loc);\r\nelse if ((dev_priv->flags & RADEON_FAMILY_MASK) > CHIP_RV515)\r\nR500_WRITE_MCIND(R520_MC_AGP_LOCATION, agp_loc);\r\nelse\r\nRADEON_WRITE(RADEON_MC_AGP_LOCATION, agp_loc);\r\n}\r\nvoid radeon_write_agp_base(drm_radeon_private_t *dev_priv, u64 agp_base)\r\n{\r\nu32 agp_base_hi = upper_32_bits(agp_base);\r\nu32 agp_base_lo = agp_base & 0xffffffff;\r\nu32 r6xx_agp_base = (agp_base >> 22) & 0x3ffff;\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_RV770)\r\nRADEON_WRITE(R700_MC_VM_AGP_BASE, r6xx_agp_base);\r\nelse if ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R600)\r\nRADEON_WRITE(R600_MC_VM_AGP_BASE, r6xx_agp_base);\r\nelse if ((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV515) {\r\nR500_WRITE_MCIND(RV515_MC_AGP_BASE, agp_base_lo);\r\nR500_WRITE_MCIND(RV515_MC_AGP_BASE_2, agp_base_hi);\r\n} else if (((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS690) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS740)) {\r\nRS690_WRITE_MCIND(RS690_MC_AGP_BASE, agp_base_lo);\r\nRS690_WRITE_MCIND(RS690_MC_AGP_BASE_2, agp_base_hi);\r\n} else if ((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS600) {\r\nRS600_WRITE_MCIND(RS600_AGP_BASE, agp_base_lo);\r\nRS600_WRITE_MCIND(RS600_AGP_BASE_2, agp_base_hi);\r\n} else if ((dev_priv->flags & RADEON_FAMILY_MASK) > CHIP_RV515) {\r\nR500_WRITE_MCIND(R520_MC_AGP_BASE, agp_base_lo);\r\nR500_WRITE_MCIND(R520_MC_AGP_BASE_2, agp_base_hi);\r\n} else if (((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS400) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS480)) {\r\nRADEON_WRITE(RADEON_AGP_BASE, agp_base_lo);\r\nRADEON_WRITE(RS480_AGP_BASE_2, agp_base_hi);\r\n} else {\r\nRADEON_WRITE(RADEON_AGP_BASE, agp_base_lo);\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R200)\r\nRADEON_WRITE(RADEON_AGP_BASE_2, agp_base_hi);\r\n}\r\n}\r\nvoid radeon_enable_bm(struct drm_radeon_private *dev_priv)\r\n{\r\nu32 tmp;\r\nif (((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS690) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS740)) {\r\ntmp = RADEON_READ(RADEON_BUS_CNTL) & ~RS600_BUS_MASTER_DIS;\r\nRADEON_WRITE(RADEON_BUS_CNTL, tmp);\r\n} else if (((dev_priv->flags & RADEON_FAMILY_MASK) <= CHIP_RV350) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_R420) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS400) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS480)) {\r\ntmp = RADEON_READ(RADEON_BUS_CNTL) & ~RADEON_BUS_MASTER_DIS;\r\nRADEON_WRITE(RADEON_BUS_CNTL, tmp);\r\n}\r\n}\r\nstatic int RADEON_READ_PLL(struct drm_device * dev, int addr)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nRADEON_WRITE8(RADEON_CLOCK_CNTL_INDEX, addr & 0x1f);\r\nreturn RADEON_READ(RADEON_CLOCK_CNTL_DATA);\r\n}\r\nstatic u32 RADEON_READ_PCIE(drm_radeon_private_t *dev_priv, int addr)\r\n{\r\nRADEON_WRITE8(RADEON_PCIE_INDEX, addr & 0xff);\r\nreturn RADEON_READ(RADEON_PCIE_DATA);\r\n}\r\nstatic void radeon_status(drm_radeon_private_t * dev_priv)\r\n{\r\nprintk("%s:\n", __func__);\r\nprintk("RBBM_STATUS = 0x%08x\n",\r\n(unsigned int)RADEON_READ(RADEON_RBBM_STATUS));\r\nprintk("CP_RB_RTPR = 0x%08x\n",\r\n(unsigned int)RADEON_READ(RADEON_CP_RB_RPTR));\r\nprintk("CP_RB_WTPR = 0x%08x\n",\r\n(unsigned int)RADEON_READ(RADEON_CP_RB_WPTR));\r\nprintk("AIC_CNTL = 0x%08x\n",\r\n(unsigned int)RADEON_READ(RADEON_AIC_CNTL));\r\nprintk("AIC_STAT = 0x%08x\n",\r\n(unsigned int)RADEON_READ(RADEON_AIC_STAT));\r\nprintk("AIC_PT_BASE = 0x%08x\n",\r\n(unsigned int)RADEON_READ(RADEON_AIC_PT_BASE));\r\nprintk("TLB_ADDR = 0x%08x\n",\r\n(unsigned int)RADEON_READ(RADEON_AIC_TLB_ADDR));\r\nprintk("TLB_DATA = 0x%08x\n",\r\n(unsigned int)RADEON_READ(RADEON_AIC_TLB_DATA));\r\n}\r\nstatic int radeon_do_pixcache_flush(drm_radeon_private_t * dev_priv)\r\n{\r\nu32 tmp;\r\nint i;\r\ndev_priv->stats.boxes |= RADEON_BOX_WAIT_IDLE;\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) <= CHIP_RV280) {\r\ntmp = RADEON_READ(RADEON_RB3D_DSTCACHE_CTLSTAT);\r\ntmp |= RADEON_RB3D_DC_FLUSH_ALL;\r\nRADEON_WRITE(RADEON_RB3D_DSTCACHE_CTLSTAT, tmp);\r\nfor (i = 0; i < dev_priv->usec_timeout; i++) {\r\nif (!(RADEON_READ(RADEON_RB3D_DSTCACHE_CTLSTAT)\r\n& RADEON_RB3D_DC_BUSY)) {\r\nreturn 0;\r\n}\r\nDRM_UDELAY(1);\r\n}\r\n} else {\r\nreturn 0;\r\n}\r\n#if RADEON_FIFO_DEBUG\r\nDRM_ERROR("failed!\n");\r\nradeon_status(dev_priv);\r\n#endif\r\nreturn -EBUSY;\r\n}\r\nstatic int radeon_do_wait_for_fifo(drm_radeon_private_t * dev_priv, int entries)\r\n{\r\nint i;\r\ndev_priv->stats.boxes |= RADEON_BOX_WAIT_IDLE;\r\nfor (i = 0; i < dev_priv->usec_timeout; i++) {\r\nint slots = (RADEON_READ(RADEON_RBBM_STATUS)\r\n& RADEON_RBBM_FIFOCNT_MASK);\r\nif (slots >= entries)\r\nreturn 0;\r\nDRM_UDELAY(1);\r\n}\r\nDRM_DEBUG("wait for fifo failed status : 0x%08X 0x%08X\n",\r\nRADEON_READ(RADEON_RBBM_STATUS),\r\nRADEON_READ(R300_VAP_CNTL_STATUS));\r\n#if RADEON_FIFO_DEBUG\r\nDRM_ERROR("failed!\n");\r\nradeon_status(dev_priv);\r\n#endif\r\nreturn -EBUSY;\r\n}\r\nstatic int radeon_do_wait_for_idle(drm_radeon_private_t * dev_priv)\r\n{\r\nint i, ret;\r\ndev_priv->stats.boxes |= RADEON_BOX_WAIT_IDLE;\r\nret = radeon_do_wait_for_fifo(dev_priv, 64);\r\nif (ret)\r\nreturn ret;\r\nfor (i = 0; i < dev_priv->usec_timeout; i++) {\r\nif (!(RADEON_READ(RADEON_RBBM_STATUS)\r\n& RADEON_RBBM_ACTIVE)) {\r\nradeon_do_pixcache_flush(dev_priv);\r\nreturn 0;\r\n}\r\nDRM_UDELAY(1);\r\n}\r\nDRM_DEBUG("wait idle failed status : 0x%08X 0x%08X\n",\r\nRADEON_READ(RADEON_RBBM_STATUS),\r\nRADEON_READ(R300_VAP_CNTL_STATUS));\r\n#if RADEON_FIFO_DEBUG\r\nDRM_ERROR("failed!\n");\r\nradeon_status(dev_priv);\r\n#endif\r\nreturn -EBUSY;\r\n}\r\nstatic void radeon_init_pipes(struct drm_device *dev)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nuint32_t gb_tile_config, gb_pipe_sel = 0;\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV530) {\r\nuint32_t z_pipe_sel = RADEON_READ(RV530_GB_PIPE_SELECT2);\r\nif ((z_pipe_sel & 3) == 3)\r\ndev_priv->num_z_pipes = 2;\r\nelse\r\ndev_priv->num_z_pipes = 1;\r\n} else\r\ndev_priv->num_z_pipes = 1;\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R420) {\r\ngb_pipe_sel = RADEON_READ(R400_GB_PIPE_SELECT);\r\ndev_priv->num_gb_pipes = ((gb_pipe_sel >> 12) & 0x3) + 1;\r\nif ((dev->pdev->device == 0x5e4c) ||\r\n(dev->pdev->device == 0x5e4f))\r\ndev_priv->num_gb_pipes = 1;\r\n} else {\r\nif (((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_R300 &&\r\ndev->pdev->device != 0x4144) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_R350 &&\r\ndev->pdev->device != 0x4148)) {\r\ndev_priv->num_gb_pipes = 2;\r\n} else {\r\ndev_priv->num_gb_pipes = 1;\r\n}\r\n}\r\nDRM_INFO("Num pipes: %d\n", dev_priv->num_gb_pipes);\r\ngb_tile_config = (R300_ENABLE_TILING | R300_TILE_SIZE_16 );\r\nswitch (dev_priv->num_gb_pipes) {\r\ncase 2: gb_tile_config |= R300_PIPE_COUNT_R300; break;\r\ncase 3: gb_tile_config |= R300_PIPE_COUNT_R420_3P; break;\r\ncase 4: gb_tile_config |= R300_PIPE_COUNT_R420; break;\r\ndefault:\r\ncase 1: gb_tile_config |= R300_PIPE_COUNT_RV350; break;\r\n}\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_RV515) {\r\nRADEON_WRITE_PLL(R500_DYN_SCLK_PWMEM_PIPE, (1 | ((gb_pipe_sel >> 8) & 0xf) << 4));\r\nRADEON_WRITE(R300_SU_REG_DEST, ((1 << dev_priv->num_gb_pipes) - 1));\r\n}\r\nRADEON_WRITE(R300_GB_TILE_CONFIG, gb_tile_config);\r\nradeon_do_wait_for_idle(dev_priv);\r\nRADEON_WRITE(R300_DST_PIPE_CONFIG, RADEON_READ(R300_DST_PIPE_CONFIG) | R300_PIPE_AUTO_CONFIG);\r\nRADEON_WRITE(R300_RB2D_DSTCACHE_MODE, (RADEON_READ(R300_RB2D_DSTCACHE_MODE) |\r\nR300_DC_AUTOFLUSH_ENABLE |\r\nR300_DC_DC_DISABLE_IGNORE_PE));\r\n}\r\nstatic int radeon_cp_init_microcode(drm_radeon_private_t *dev_priv)\r\n{\r\nstruct platform_device *pdev;\r\nconst char *fw_name = NULL;\r\nint err;\r\nDRM_DEBUG("\n");\r\npdev = platform_device_register_simple("radeon_cp", 0, NULL, 0);\r\nerr = IS_ERR(pdev);\r\nif (err) {\r\nprintk(KERN_ERR "radeon_cp: Failed to register firmware\n");\r\nreturn -EINVAL;\r\n}\r\nif (((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_R100) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV100) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV200) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS100) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS200)) {\r\nDRM_INFO("Loading R100 Microcode\n");\r\nfw_name = FIRMWARE_R100;\r\n} else if (((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_R200) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV250) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV280) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS300)) {\r\nDRM_INFO("Loading R200 Microcode\n");\r\nfw_name = FIRMWARE_R200;\r\n} else if (((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_R300) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_R350) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV350) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV380) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS400) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS480)) {\r\nDRM_INFO("Loading R300 Microcode\n");\r\nfw_name = FIRMWARE_R300;\r\n} else if (((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_R420) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_R423) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV410)) {\r\nDRM_INFO("Loading R400 Microcode\n");\r\nfw_name = FIRMWARE_R420;\r\n} else if (((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS690) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS740)) {\r\nDRM_INFO("Loading RS690/RS740 Microcode\n");\r\nfw_name = FIRMWARE_RS690;\r\n} else if ((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS600) {\r\nDRM_INFO("Loading RS600 Microcode\n");\r\nfw_name = FIRMWARE_RS600;\r\n} else if (((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV515) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_R520) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV530) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_R580) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV560) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV570)) {\r\nDRM_INFO("Loading R500 Microcode\n");\r\nfw_name = FIRMWARE_R520;\r\n}\r\nerr = request_firmware(&dev_priv->me_fw, fw_name, &pdev->dev);\r\nplatform_device_unregister(pdev);\r\nif (err) {\r\nprintk(KERN_ERR "radeon_cp: Failed to load firmware \"%s\"\n",\r\nfw_name);\r\n} else if (dev_priv->me_fw->size % 8) {\r\nprintk(KERN_ERR\r\n"radeon_cp: Bogus length %zu in firmware \"%s\"\n",\r\ndev_priv->me_fw->size, fw_name);\r\nerr = -EINVAL;\r\nrelease_firmware(dev_priv->me_fw);\r\ndev_priv->me_fw = NULL;\r\n}\r\nreturn err;\r\n}\r\nstatic void radeon_cp_load_microcode(drm_radeon_private_t *dev_priv)\r\n{\r\nconst __be32 *fw_data;\r\nint i, size;\r\nradeon_do_wait_for_idle(dev_priv);\r\nif (dev_priv->me_fw) {\r\nsize = dev_priv->me_fw->size / 4;\r\nfw_data = (const __be32 *)&dev_priv->me_fw->data[0];\r\nRADEON_WRITE(RADEON_CP_ME_RAM_ADDR, 0);\r\nfor (i = 0; i < size; i += 2) {\r\nRADEON_WRITE(RADEON_CP_ME_RAM_DATAH,\r\nbe32_to_cpup(&fw_data[i]));\r\nRADEON_WRITE(RADEON_CP_ME_RAM_DATAL,\r\nbe32_to_cpup(&fw_data[i + 1]));\r\n}\r\n}\r\n}\r\nstatic void radeon_do_cp_flush(drm_radeon_private_t * dev_priv)\r\n{\r\nDRM_DEBUG("\n");\r\n#if 0\r\nu32 tmp;\r\ntmp = RADEON_READ(RADEON_CP_RB_WPTR) | (1 << 31);\r\nRADEON_WRITE(RADEON_CP_RB_WPTR, tmp);\r\n#endif\r\n}\r\nint radeon_do_cp_idle(drm_radeon_private_t * dev_priv)\r\n{\r\nRING_LOCALS;\r\nDRM_DEBUG("\n");\r\nBEGIN_RING(6);\r\nRADEON_PURGE_CACHE();\r\nRADEON_PURGE_ZCACHE();\r\nRADEON_WAIT_UNTIL_IDLE();\r\nADVANCE_RING();\r\nCOMMIT_RING();\r\nreturn radeon_do_wait_for_idle(dev_priv);\r\n}\r\nstatic void radeon_do_cp_start(drm_radeon_private_t * dev_priv)\r\n{\r\nRING_LOCALS;\r\nDRM_DEBUG("\n");\r\nradeon_do_wait_for_idle(dev_priv);\r\nRADEON_WRITE(RADEON_CP_CSQ_CNTL, dev_priv->cp_mode);\r\ndev_priv->cp_running = 1;\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_R420) {\r\nBEGIN_RING(3);\r\nOUT_RING(CP_PACKET0(R300_CP_RESYNC_ADDR, 1));\r\nOUT_RING(5);\r\nOUT_RING(0xdeadbeef);\r\nADVANCE_RING();\r\nCOMMIT_RING();\r\n}\r\nBEGIN_RING(8);\r\nOUT_RING(CP_PACKET0(RADEON_ISYNC_CNTL, 0));\r\nOUT_RING(RADEON_ISYNC_ANY2D_IDLE3D |\r\nRADEON_ISYNC_ANY3D_IDLE2D |\r\nRADEON_ISYNC_WAIT_IDLEGUI |\r\nRADEON_ISYNC_CPSCRATCH_IDLEGUI);\r\nRADEON_PURGE_CACHE();\r\nRADEON_PURGE_ZCACHE();\r\nRADEON_WAIT_UNTIL_IDLE();\r\nADVANCE_RING();\r\nCOMMIT_RING();\r\ndev_priv->track_flush |= RADEON_FLUSH_EMITED | RADEON_PURGE_EMITED;\r\n}\r\nstatic void radeon_do_cp_reset(drm_radeon_private_t * dev_priv)\r\n{\r\nu32 cur_read_ptr;\r\nDRM_DEBUG("\n");\r\ncur_read_ptr = RADEON_READ(RADEON_CP_RB_RPTR);\r\nRADEON_WRITE(RADEON_CP_RB_WPTR, cur_read_ptr);\r\nSET_RING_HEAD(dev_priv, cur_read_ptr);\r\ndev_priv->ring.tail = cur_read_ptr;\r\n}\r\nstatic void radeon_do_cp_stop(drm_radeon_private_t * dev_priv)\r\n{\r\nRING_LOCALS;\r\nDRM_DEBUG("\n");\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_R420) {\r\nBEGIN_RING(2);\r\nOUT_RING(CP_PACKET0(R300_RB3D_DSTCACHE_CTLSTAT, 0));\r\nOUT_RING(R300_RB3D_DC_FINISH);\r\nADVANCE_RING();\r\nCOMMIT_RING();\r\nradeon_do_wait_for_idle(dev_priv);\r\n}\r\nRADEON_WRITE(RADEON_CP_CSQ_CNTL, RADEON_CSQ_PRIDIS_INDDIS);\r\ndev_priv->cp_running = 0;\r\n}\r\nstatic int radeon_do_engine_reset(struct drm_device * dev)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nu32 clock_cntl_index = 0, mclk_cntl = 0, rbbm_soft_reset;\r\nDRM_DEBUG("\n");\r\nradeon_do_pixcache_flush(dev_priv);\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) <= CHIP_RV410) {\r\nclock_cntl_index = RADEON_READ(RADEON_CLOCK_CNTL_INDEX);\r\nmclk_cntl = RADEON_READ_PLL(dev, RADEON_MCLK_CNTL);\r\nRADEON_WRITE_PLL(RADEON_MCLK_CNTL, (mclk_cntl |\r\nRADEON_FORCEON_MCLKA |\r\nRADEON_FORCEON_MCLKB |\r\nRADEON_FORCEON_YCLKA |\r\nRADEON_FORCEON_YCLKB |\r\nRADEON_FORCEON_MC |\r\nRADEON_FORCEON_AIC));\r\n}\r\nrbbm_soft_reset = RADEON_READ(RADEON_RBBM_SOFT_RESET);\r\nRADEON_WRITE(RADEON_RBBM_SOFT_RESET, (rbbm_soft_reset |\r\nRADEON_SOFT_RESET_CP |\r\nRADEON_SOFT_RESET_HI |\r\nRADEON_SOFT_RESET_SE |\r\nRADEON_SOFT_RESET_RE |\r\nRADEON_SOFT_RESET_PP |\r\nRADEON_SOFT_RESET_E2 |\r\nRADEON_SOFT_RESET_RB));\r\nRADEON_READ(RADEON_RBBM_SOFT_RESET);\r\nRADEON_WRITE(RADEON_RBBM_SOFT_RESET, (rbbm_soft_reset &\r\n~(RADEON_SOFT_RESET_CP |\r\nRADEON_SOFT_RESET_HI |\r\nRADEON_SOFT_RESET_SE |\r\nRADEON_SOFT_RESET_RE |\r\nRADEON_SOFT_RESET_PP |\r\nRADEON_SOFT_RESET_E2 |\r\nRADEON_SOFT_RESET_RB)));\r\nRADEON_READ(RADEON_RBBM_SOFT_RESET);\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) <= CHIP_RV410) {\r\nRADEON_WRITE_PLL(RADEON_MCLK_CNTL, mclk_cntl);\r\nRADEON_WRITE(RADEON_CLOCK_CNTL_INDEX, clock_cntl_index);\r\nRADEON_WRITE(RADEON_RBBM_SOFT_RESET, rbbm_soft_reset);\r\n}\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R300)\r\nradeon_init_pipes(dev);\r\nradeon_do_cp_reset(dev_priv);\r\ndev_priv->cp_running = 0;\r\nradeon_freelist_reset(dev);\r\nreturn 0;\r\n}\r\nstatic void radeon_cp_init_ring_buffer(struct drm_device * dev,\r\ndrm_radeon_private_t *dev_priv,\r\nstruct drm_file *file_priv)\r\n{\r\nstruct drm_radeon_master_private *master_priv;\r\nu32 ring_start, cur_read_ptr;\r\nif (!dev_priv->new_memmap)\r\nradeon_write_fb_location(dev_priv,\r\n((dev_priv->gart_vm_start - 1) & 0xffff0000)\r\n| (dev_priv->fb_location >> 16));\r\n#if __OS_HAS_AGP\r\nif (dev_priv->flags & RADEON_IS_AGP) {\r\nradeon_write_agp_base(dev_priv, dev->agp->base);\r\nradeon_write_agp_location(dev_priv,\r\n(((dev_priv->gart_vm_start - 1 +\r\ndev_priv->gart_size) & 0xffff0000) |\r\n(dev_priv->gart_vm_start >> 16)));\r\nring_start = (dev_priv->cp_ring->offset\r\n- dev->agp->base\r\n+ dev_priv->gart_vm_start);\r\n} else\r\n#endif\r\nring_start = (dev_priv->cp_ring->offset\r\n- (unsigned long)dev->sg->virtual\r\n+ dev_priv->gart_vm_start);\r\nRADEON_WRITE(RADEON_CP_RB_BASE, ring_start);\r\nRADEON_WRITE(RADEON_CP_RB_WPTR_DELAY, 0);\r\ncur_read_ptr = RADEON_READ(RADEON_CP_RB_RPTR);\r\nRADEON_WRITE(RADEON_CP_RB_WPTR, cur_read_ptr);\r\nSET_RING_HEAD(dev_priv, cur_read_ptr);\r\ndev_priv->ring.tail = cur_read_ptr;\r\n#if __OS_HAS_AGP\r\nif (dev_priv->flags & RADEON_IS_AGP) {\r\nRADEON_WRITE(RADEON_CP_RB_RPTR_ADDR,\r\ndev_priv->ring_rptr->offset\r\n- dev->agp->base + dev_priv->gart_vm_start);\r\n} else\r\n#endif\r\n{\r\nRADEON_WRITE(RADEON_CP_RB_RPTR_ADDR,\r\ndev_priv->ring_rptr->offset\r\n- ((unsigned long) dev->sg->virtual)\r\n+ dev_priv->gart_vm_start);\r\n}\r\n#ifdef __BIG_ENDIAN\r\nRADEON_WRITE(RADEON_CP_RB_CNTL,\r\nRADEON_BUF_SWAP_32BIT |\r\n(dev_priv->ring.fetch_size_l2ow << 18) |\r\n(dev_priv->ring.rptr_update_l2qw << 8) |\r\ndev_priv->ring.size_l2qw);\r\n#else\r\nRADEON_WRITE(RADEON_CP_RB_CNTL,\r\n(dev_priv->ring.fetch_size_l2ow << 18) |\r\n(dev_priv->ring.rptr_update_l2qw << 8) |\r\ndev_priv->ring.size_l2qw);\r\n#endif\r\nRADEON_WRITE(RADEON_SCRATCH_ADDR, RADEON_READ(RADEON_CP_RB_RPTR_ADDR)\r\n+ RADEON_SCRATCH_REG_OFFSET);\r\nRADEON_WRITE(RADEON_SCRATCH_UMSK, 0x7);\r\nradeon_enable_bm(dev_priv);\r\nradeon_write_ring_rptr(dev_priv, RADEON_SCRATCHOFF(0), 0);\r\nRADEON_WRITE(RADEON_LAST_FRAME_REG, 0);\r\nradeon_write_ring_rptr(dev_priv, RADEON_SCRATCHOFF(1), 0);\r\nRADEON_WRITE(RADEON_LAST_DISPATCH_REG, 0);\r\nradeon_write_ring_rptr(dev_priv, RADEON_SCRATCHOFF(2), 0);\r\nRADEON_WRITE(RADEON_LAST_CLEAR_REG, 0);\r\nmaster_priv = file_priv->master->driver_priv;\r\nif (master_priv->sarea_priv) {\r\nmaster_priv->sarea_priv->last_frame = 0;\r\nmaster_priv->sarea_priv->last_dispatch = 0;\r\nmaster_priv->sarea_priv->last_clear = 0;\r\n}\r\nradeon_do_wait_for_idle(dev_priv);\r\nRADEON_WRITE(RADEON_ISYNC_CNTL,\r\n(RADEON_ISYNC_ANY2D_IDLE3D |\r\nRADEON_ISYNC_ANY3D_IDLE2D |\r\nRADEON_ISYNC_WAIT_IDLEGUI |\r\nRADEON_ISYNC_CPSCRATCH_IDLEGUI));\r\n}\r\nstatic void radeon_test_writeback(drm_radeon_private_t * dev_priv)\r\n{\r\nu32 tmp;\r\ndev_priv->writeback_works = 0;\r\nradeon_write_ring_rptr(dev_priv, RADEON_SCRATCHOFF(1), 0);\r\nRADEON_WRITE(RADEON_SCRATCH_REG1, 0xdeadbeef);\r\nfor (tmp = 0; tmp < dev_priv->usec_timeout; tmp++) {\r\nu32 val;\r\nval = radeon_read_ring_rptr(dev_priv, RADEON_SCRATCHOFF(1));\r\nif (val == 0xdeadbeef)\r\nbreak;\r\nDRM_UDELAY(1);\r\n}\r\nif (tmp < dev_priv->usec_timeout) {\r\ndev_priv->writeback_works = 1;\r\nDRM_INFO("writeback test succeeded in %d usecs\n", tmp);\r\n} else {\r\ndev_priv->writeback_works = 0;\r\nDRM_INFO("writeback test failed\n");\r\n}\r\nif (radeon_no_wb == 1) {\r\ndev_priv->writeback_works = 0;\r\nDRM_INFO("writeback forced off\n");\r\n}\r\nif (!dev_priv->writeback_works) {\r\nRADEON_WRITE(RADEON_CP_RB_CNTL, RADEON_READ(RADEON_CP_RB_CNTL) |\r\nRADEON_RB_NO_UPDATE);\r\nRADEON_WRITE(RADEON_SCRATCH_UMSK, 0);\r\n}\r\n}\r\nstatic void radeon_set_igpgart(drm_radeon_private_t * dev_priv, int on)\r\n{\r\nu32 temp;\r\nif (on) {\r\nDRM_DEBUG("programming igp gart %08X %08lX %08X\n",\r\ndev_priv->gart_vm_start,\r\n(long)dev_priv->gart_info.bus_addr,\r\ndev_priv->gart_size);\r\ntemp = IGP_READ_MCIND(dev_priv, RS480_MC_MISC_CNTL);\r\nif (((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS690) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS740))\r\nIGP_WRITE_MCIND(RS480_MC_MISC_CNTL, (RS480_GART_INDEX_REG_EN |\r\nRS690_BLOCK_GFX_D3_EN));\r\nelse\r\nIGP_WRITE_MCIND(RS480_MC_MISC_CNTL, RS480_GART_INDEX_REG_EN);\r\nIGP_WRITE_MCIND(RS480_AGP_ADDRESS_SPACE_SIZE, (RS480_GART_EN |\r\nRS480_VA_SIZE_32MB));\r\ntemp = IGP_READ_MCIND(dev_priv, RS480_GART_FEATURE_ID);\r\nIGP_WRITE_MCIND(RS480_GART_FEATURE_ID, (RS480_HANG_EN |\r\nRS480_TLB_ENABLE |\r\nRS480_GTW_LAC_EN |\r\nRS480_1LEVEL_GART));\r\ntemp = dev_priv->gart_info.bus_addr & 0xfffff000;\r\ntemp |= (upper_32_bits(dev_priv->gart_info.bus_addr) & 0xff) << 4;\r\nIGP_WRITE_MCIND(RS480_GART_BASE, temp);\r\ntemp = IGP_READ_MCIND(dev_priv, RS480_AGP_MODE_CNTL);\r\nIGP_WRITE_MCIND(RS480_AGP_MODE_CNTL, ((1 << RS480_REQ_TYPE_SNOOP_SHIFT) |\r\nRS480_REQ_TYPE_SNOOP_DIS));\r\nradeon_write_agp_base(dev_priv, dev_priv->gart_vm_start);\r\ndev_priv->gart_size = 32*1024*1024;\r\ntemp = (((dev_priv->gart_vm_start - 1 + dev_priv->gart_size) &\r\n0xffff0000) | (dev_priv->gart_vm_start >> 16));\r\nradeon_write_agp_location(dev_priv, temp);\r\ntemp = IGP_READ_MCIND(dev_priv, RS480_AGP_ADDRESS_SPACE_SIZE);\r\nIGP_WRITE_MCIND(RS480_AGP_ADDRESS_SPACE_SIZE, (RS480_GART_EN |\r\nRS480_VA_SIZE_32MB));\r\ndo {\r\ntemp = IGP_READ_MCIND(dev_priv, RS480_GART_CACHE_CNTRL);\r\nif ((temp & RS480_GART_CACHE_INVALIDATE) == 0)\r\nbreak;\r\nDRM_UDELAY(1);\r\n} while (1);\r\nIGP_WRITE_MCIND(RS480_GART_CACHE_CNTRL,\r\nRS480_GART_CACHE_INVALIDATE);\r\ndo {\r\ntemp = IGP_READ_MCIND(dev_priv, RS480_GART_CACHE_CNTRL);\r\nif ((temp & RS480_GART_CACHE_INVALIDATE) == 0)\r\nbreak;\r\nDRM_UDELAY(1);\r\n} while (1);\r\nIGP_WRITE_MCIND(RS480_GART_CACHE_CNTRL, 0);\r\n} else {\r\nIGP_WRITE_MCIND(RS480_AGP_ADDRESS_SPACE_SIZE, 0);\r\n}\r\n}\r\nstatic void rs600_set_igpgart(drm_radeon_private_t *dev_priv, int on)\r\n{\r\nu32 temp;\r\nint i;\r\nif (on) {\r\nDRM_DEBUG("programming igp gart %08X %08lX %08X\n",\r\ndev_priv->gart_vm_start,\r\n(long)dev_priv->gart_info.bus_addr,\r\ndev_priv->gart_size);\r\nIGP_WRITE_MCIND(RS600_MC_PT0_CNTL, (RS600_EFFECTIVE_L2_CACHE_SIZE(6) |\r\nRS600_EFFECTIVE_L2_QUEUE_SIZE(6)));\r\nfor (i = 0; i < 19; i++)\r\nIGP_WRITE_MCIND(RS600_MC_PT0_CLIENT0_CNTL + i,\r\n(RS600_ENABLE_TRANSLATION_MODE_OVERRIDE |\r\nRS600_SYSTEM_ACCESS_MODE_IN_SYS |\r\nRS600_SYSTEM_APERTURE_UNMAPPED_ACCESS_PASSTHROUGH |\r\nRS600_EFFECTIVE_L1_CACHE_SIZE(3) |\r\nRS600_ENABLE_FRAGMENT_PROCESSING |\r\nRS600_EFFECTIVE_L1_QUEUE_SIZE(3)));\r\nIGP_WRITE_MCIND(RS600_MC_PT0_CONTEXT0_CNTL, (RS600_ENABLE_PAGE_TABLE |\r\nRS600_PAGE_TABLE_TYPE_FLAT));\r\nfor (i = 1; i < 8; i++)\r\nIGP_WRITE_MCIND(RS600_MC_PT0_CONTEXT0_CNTL + i, 0);\r\nIGP_WRITE_MCIND(RS600_MC_PT0_CONTEXT0_FLAT_BASE_ADDR,\r\ndev_priv->gart_info.bus_addr);\r\nIGP_WRITE_MCIND(RS600_MC_PT0_CONTEXT0_FLAT_START_ADDR,\r\ndev_priv->gart_vm_start);\r\nIGP_WRITE_MCIND(RS600_MC_PT0_CONTEXT0_FLAT_END_ADDR,\r\n(dev_priv->gart_vm_start + dev_priv->gart_size - 1));\r\nIGP_WRITE_MCIND(RS600_MC_PT0_CONTEXT0_DEFAULT_READ_ADDR, 0);\r\nIGP_WRITE_MCIND(RS600_MC_PT0_SYSTEM_APERTURE_LOW_ADDR,\r\ndev_priv->gart_vm_start);\r\nIGP_WRITE_MCIND(RS600_MC_PT0_SYSTEM_APERTURE_HIGH_ADDR,\r\n(dev_priv->gart_vm_start + dev_priv->gart_size - 1));\r\ntemp = IGP_READ_MCIND(dev_priv, RS600_MC_PT0_CNTL);\r\nIGP_WRITE_MCIND(RS600_MC_PT0_CNTL, (temp | RS600_ENABLE_PT));\r\ntemp = IGP_READ_MCIND(dev_priv, RS600_MC_CNTL1);\r\nIGP_WRITE_MCIND(RS600_MC_CNTL1, (temp | RS600_ENABLE_PAGE_TABLES));\r\ntemp = IGP_READ_MCIND(dev_priv, RS600_MC_PT0_CNTL);\r\ntemp &= ~(RS600_INVALIDATE_ALL_L1_TLBS | RS600_INVALIDATE_L2_CACHE);\r\nIGP_WRITE_MCIND(RS600_MC_PT0_CNTL, temp);\r\ntemp = IGP_READ_MCIND(dev_priv, RS600_MC_PT0_CNTL);\r\ntemp |= RS600_INVALIDATE_ALL_L1_TLBS | RS600_INVALIDATE_L2_CACHE;\r\nIGP_WRITE_MCIND(RS600_MC_PT0_CNTL, temp);\r\ntemp = IGP_READ_MCIND(dev_priv, RS600_MC_PT0_CNTL);\r\ntemp &= ~(RS600_INVALIDATE_ALL_L1_TLBS | RS600_INVALIDATE_L2_CACHE);\r\nIGP_WRITE_MCIND(RS600_MC_PT0_CNTL, temp);\r\ntemp = IGP_READ_MCIND(dev_priv, RS600_MC_PT0_CNTL);\r\n} else {\r\nIGP_WRITE_MCIND(RS600_MC_PT0_CNTL, 0);\r\ntemp = IGP_READ_MCIND(dev_priv, RS600_MC_CNTL1);\r\ntemp &= ~RS600_ENABLE_PAGE_TABLES;\r\nIGP_WRITE_MCIND(RS600_MC_CNTL1, temp);\r\n}\r\n}\r\nstatic void radeon_set_pciegart(drm_radeon_private_t * dev_priv, int on)\r\n{\r\nu32 tmp = RADEON_READ_PCIE(dev_priv, RADEON_PCIE_TX_GART_CNTL);\r\nif (on) {\r\nDRM_DEBUG("programming pcie %08X %08lX %08X\n",\r\ndev_priv->gart_vm_start,\r\n(long)dev_priv->gart_info.bus_addr,\r\ndev_priv->gart_size);\r\nRADEON_WRITE_PCIE(RADEON_PCIE_TX_DISCARD_RD_ADDR_LO,\r\ndev_priv->gart_vm_start);\r\nRADEON_WRITE_PCIE(RADEON_PCIE_TX_GART_BASE,\r\ndev_priv->gart_info.bus_addr);\r\nRADEON_WRITE_PCIE(RADEON_PCIE_TX_GART_START_LO,\r\ndev_priv->gart_vm_start);\r\nRADEON_WRITE_PCIE(RADEON_PCIE_TX_GART_END_LO,\r\ndev_priv->gart_vm_start +\r\ndev_priv->gart_size - 1);\r\nradeon_write_agp_location(dev_priv, 0xffffffc0);\r\nRADEON_WRITE_PCIE(RADEON_PCIE_TX_GART_CNTL,\r\nRADEON_PCIE_TX_GART_EN);\r\n} else {\r\nRADEON_WRITE_PCIE(RADEON_PCIE_TX_GART_CNTL,\r\ntmp & ~RADEON_PCIE_TX_GART_EN);\r\n}\r\n}\r\nstatic void radeon_set_pcigart(drm_radeon_private_t * dev_priv, int on)\r\n{\r\nu32 tmp;\r\nif (((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS690) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS740) ||\r\n(dev_priv->flags & RADEON_IS_IGPGART)) {\r\nradeon_set_igpgart(dev_priv, on);\r\nreturn;\r\n}\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS600) {\r\nrs600_set_igpgart(dev_priv, on);\r\nreturn;\r\n}\r\nif (dev_priv->flags & RADEON_IS_PCIE) {\r\nradeon_set_pciegart(dev_priv, on);\r\nreturn;\r\n}\r\ntmp = RADEON_READ(RADEON_AIC_CNTL);\r\nif (on) {\r\nRADEON_WRITE(RADEON_AIC_CNTL,\r\ntmp | RADEON_PCIGART_TRANSLATE_EN);\r\nRADEON_WRITE(RADEON_AIC_PT_BASE, dev_priv->gart_info.bus_addr);\r\nRADEON_WRITE(RADEON_AIC_LO_ADDR, dev_priv->gart_vm_start);\r\nRADEON_WRITE(RADEON_AIC_HI_ADDR, dev_priv->gart_vm_start\r\n+ dev_priv->gart_size - 1);\r\nradeon_write_agp_location(dev_priv, 0xffffffc0);\r\nRADEON_WRITE(RADEON_AGP_COMMAND, 0);\r\n} else {\r\nRADEON_WRITE(RADEON_AIC_CNTL,\r\ntmp & ~RADEON_PCIGART_TRANSLATE_EN);\r\n}\r\n}\r\nstatic int radeon_setup_pcigart_surface(drm_radeon_private_t *dev_priv)\r\n{\r\nstruct drm_ati_pcigart_info *gart_info = &dev_priv->gart_info;\r\nstruct radeon_virt_surface *vp;\r\nint i;\r\nfor (i = 0; i < RADEON_MAX_SURFACES * 2; i++) {\r\nif (!dev_priv->virt_surfaces[i].file_priv ||\r\ndev_priv->virt_surfaces[i].file_priv == PCIGART_FILE_PRIV)\r\nbreak;\r\n}\r\nif (i >= 2 * RADEON_MAX_SURFACES)\r\nreturn -ENOMEM;\r\nvp = &dev_priv->virt_surfaces[i];\r\nfor (i = 0; i < RADEON_MAX_SURFACES; i++) {\r\nstruct radeon_surface *sp = &dev_priv->surfaces[i];\r\nif (sp->refcount)\r\ncontinue;\r\nvp->surface_index = i;\r\nvp->lower = gart_info->bus_addr;\r\nvp->upper = vp->lower + gart_info->table_size;\r\nvp->flags = 0;\r\nvp->file_priv = PCIGART_FILE_PRIV;\r\nsp->refcount = 1;\r\nsp->lower = vp->lower;\r\nsp->upper = vp->upper;\r\nsp->flags = 0;\r\nRADEON_WRITE(RADEON_SURFACE0_INFO + 16 * i, sp->flags);\r\nRADEON_WRITE(RADEON_SURFACE0_LOWER_BOUND + 16 * i, sp->lower);\r\nRADEON_WRITE(RADEON_SURFACE0_UPPER_BOUND + 16 * i, sp->upper);\r\nreturn 0;\r\n}\r\nreturn -ENOMEM;\r\n}\r\nstatic int radeon_do_init_cp(struct drm_device *dev, drm_radeon_init_t *init,\r\nstruct drm_file *file_priv)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nstruct drm_radeon_master_private *master_priv = file_priv->master->driver_priv;\r\nDRM_DEBUG("\n");\r\nif ((dev_priv->flags & RADEON_NEW_MEMMAP) && !dev_priv->new_memmap) {\r\nDRM_ERROR("Cannot initialise DRM on this card\nThis card requires a new X.org DDX for 3D\n");\r\nradeon_do_cleanup_cp(dev);\r\nreturn -EINVAL;\r\n}\r\nif (init->is_pci && (dev_priv->flags & RADEON_IS_AGP)) {\r\nDRM_DEBUG("Forcing AGP card to PCI mode\n");\r\ndev_priv->flags &= ~RADEON_IS_AGP;\r\n} else if (!(dev_priv->flags & (RADEON_IS_AGP | RADEON_IS_PCI | RADEON_IS_PCIE))\r\n&& !init->is_pci) {\r\nDRM_DEBUG("Restoring AGP flag\n");\r\ndev_priv->flags |= RADEON_IS_AGP;\r\n}\r\nif ((!(dev_priv->flags & RADEON_IS_AGP)) && !dev->sg) {\r\nDRM_ERROR("PCI GART memory not allocated!\n");\r\nradeon_do_cleanup_cp(dev);\r\nreturn -EINVAL;\r\n}\r\ndev_priv->usec_timeout = init->usec_timeout;\r\nif (dev_priv->usec_timeout < 1 ||\r\ndev_priv->usec_timeout > RADEON_MAX_USEC_TIMEOUT) {\r\nDRM_DEBUG("TIMEOUT problem!\n");\r\nradeon_do_cleanup_cp(dev);\r\nreturn -EINVAL;\r\n}\r\ndev_priv->vblank_crtc = DRM_RADEON_VBLANK_CRTC1;\r\nswitch(init->func) {\r\ncase RADEON_INIT_R200_CP:\r\ndev_priv->microcode_version = UCODE_R200;\r\nbreak;\r\ncase RADEON_INIT_R300_CP:\r\ndev_priv->microcode_version = UCODE_R300;\r\nbreak;\r\ndefault:\r\ndev_priv->microcode_version = UCODE_R100;\r\n}\r\ndev_priv->do_boxes = 0;\r\ndev_priv->cp_mode = init->cp_mode;\r\nif ((init->cp_mode != RADEON_CSQ_PRIBM_INDDIS) &&\r\n(init->cp_mode != RADEON_CSQ_PRIBM_INDBM)) {\r\nDRM_DEBUG("BAD cp_mode (%x)!\n", init->cp_mode);\r\nradeon_do_cleanup_cp(dev);\r\nreturn -EINVAL;\r\n}\r\nswitch (init->fb_bpp) {\r\ncase 16:\r\ndev_priv->color_fmt = RADEON_COLOR_FORMAT_RGB565;\r\nbreak;\r\ncase 32:\r\ndefault:\r\ndev_priv->color_fmt = RADEON_COLOR_FORMAT_ARGB8888;\r\nbreak;\r\n}\r\ndev_priv->front_offset = init->front_offset;\r\ndev_priv->front_pitch = init->front_pitch;\r\ndev_priv->back_offset = init->back_offset;\r\ndev_priv->back_pitch = init->back_pitch;\r\nswitch (init->depth_bpp) {\r\ncase 16:\r\ndev_priv->depth_fmt = RADEON_DEPTH_FORMAT_16BIT_INT_Z;\r\nbreak;\r\ncase 32:\r\ndefault:\r\ndev_priv->depth_fmt = RADEON_DEPTH_FORMAT_24BIT_INT_Z;\r\nbreak;\r\n}\r\ndev_priv->depth_offset = init->depth_offset;\r\ndev_priv->depth_pitch = init->depth_pitch;\r\ndev_priv->depth_clear.rb3d_cntl = (RADEON_PLANE_MASK_ENABLE |\r\n(dev_priv->color_fmt << 10) |\r\n(dev_priv->microcode_version ==\r\nUCODE_R100 ? RADEON_ZBLOCK16 : 0));\r\ndev_priv->depth_clear.rb3d_zstencilcntl =\r\n(dev_priv->depth_fmt |\r\nRADEON_Z_TEST_ALWAYS |\r\nRADEON_STENCIL_TEST_ALWAYS |\r\nRADEON_STENCIL_S_FAIL_REPLACE |\r\nRADEON_STENCIL_ZPASS_REPLACE |\r\nRADEON_STENCIL_ZFAIL_REPLACE | RADEON_Z_WRITE_ENABLE);\r\ndev_priv->depth_clear.se_cntl = (RADEON_FFACE_CULL_CW |\r\nRADEON_BFACE_SOLID |\r\nRADEON_FFACE_SOLID |\r\nRADEON_FLAT_SHADE_VTX_LAST |\r\nRADEON_DIFFUSE_SHADE_FLAT |\r\nRADEON_ALPHA_SHADE_FLAT |\r\nRADEON_SPECULAR_SHADE_FLAT |\r\nRADEON_FOG_SHADE_FLAT |\r\nRADEON_VTX_PIX_CENTER_OGL |\r\nRADEON_ROUND_MODE_TRUNC |\r\nRADEON_ROUND_PREC_8TH_PIX);\r\ndev_priv->ring_offset = init->ring_offset;\r\ndev_priv->ring_rptr_offset = init->ring_rptr_offset;\r\ndev_priv->buffers_offset = init->buffers_offset;\r\ndev_priv->gart_textures_offset = init->gart_textures_offset;\r\nmaster_priv->sarea = drm_getsarea(dev);\r\nif (!master_priv->sarea) {\r\nDRM_ERROR("could not find sarea!\n");\r\nradeon_do_cleanup_cp(dev);\r\nreturn -EINVAL;\r\n}\r\ndev_priv->cp_ring = drm_core_findmap(dev, init->ring_offset);\r\nif (!dev_priv->cp_ring) {\r\nDRM_ERROR("could not find cp ring region!\n");\r\nradeon_do_cleanup_cp(dev);\r\nreturn -EINVAL;\r\n}\r\ndev_priv->ring_rptr = drm_core_findmap(dev, init->ring_rptr_offset);\r\nif (!dev_priv->ring_rptr) {\r\nDRM_ERROR("could not find ring read pointer!\n");\r\nradeon_do_cleanup_cp(dev);\r\nreturn -EINVAL;\r\n}\r\ndev->agp_buffer_token = init->buffers_offset;\r\ndev->agp_buffer_map = drm_core_findmap(dev, init->buffers_offset);\r\nif (!dev->agp_buffer_map) {\r\nDRM_ERROR("could not find dma buffer region!\n");\r\nradeon_do_cleanup_cp(dev);\r\nreturn -EINVAL;\r\n}\r\nif (init->gart_textures_offset) {\r\ndev_priv->gart_textures =\r\ndrm_core_findmap(dev, init->gart_textures_offset);\r\nif (!dev_priv->gart_textures) {\r\nDRM_ERROR("could not find GART texture region!\n");\r\nradeon_do_cleanup_cp(dev);\r\nreturn -EINVAL;\r\n}\r\n}\r\n#if __OS_HAS_AGP\r\nif (dev_priv->flags & RADEON_IS_AGP) {\r\ndrm_core_ioremap_wc(dev_priv->cp_ring, dev);\r\ndrm_core_ioremap_wc(dev_priv->ring_rptr, dev);\r\ndrm_core_ioremap_wc(dev->agp_buffer_map, dev);\r\nif (!dev_priv->cp_ring->handle ||\r\n!dev_priv->ring_rptr->handle ||\r\n!dev->agp_buffer_map->handle) {\r\nDRM_ERROR("could not find ioremap agp regions!\n");\r\nradeon_do_cleanup_cp(dev);\r\nreturn -EINVAL;\r\n}\r\n} else\r\n#endif\r\n{\r\ndev_priv->cp_ring->handle =\r\n(void *)(unsigned long)dev_priv->cp_ring->offset;\r\ndev_priv->ring_rptr->handle =\r\n(void *)(unsigned long)dev_priv->ring_rptr->offset;\r\ndev->agp_buffer_map->handle =\r\n(void *)(unsigned long)dev->agp_buffer_map->offset;\r\nDRM_DEBUG("dev_priv->cp_ring->handle %p\n",\r\ndev_priv->cp_ring->handle);\r\nDRM_DEBUG("dev_priv->ring_rptr->handle %p\n",\r\ndev_priv->ring_rptr->handle);\r\nDRM_DEBUG("dev->agp_buffer_map->handle %p\n",\r\ndev->agp_buffer_map->handle);\r\n}\r\ndev_priv->fb_location = (radeon_read_fb_location(dev_priv) & 0xffff) << 16;\r\ndev_priv->fb_size =\r\n((radeon_read_fb_location(dev_priv) & 0xffff0000u) + 0x10000)\r\n- dev_priv->fb_location;\r\ndev_priv->front_pitch_offset = (((dev_priv->front_pitch / 64) << 22) |\r\n((dev_priv->front_offset\r\n+ dev_priv->fb_location) >> 10));\r\ndev_priv->back_pitch_offset = (((dev_priv->back_pitch / 64) << 22) |\r\n((dev_priv->back_offset\r\n+ dev_priv->fb_location) >> 10));\r\ndev_priv->depth_pitch_offset = (((dev_priv->depth_pitch / 64) << 22) |\r\n((dev_priv->depth_offset\r\n+ dev_priv->fb_location) >> 10));\r\ndev_priv->gart_size = init->gart_size;\r\nif (dev_priv->new_memmap) {\r\nu32 base = 0;\r\nDRM_INFO("Setting GART location based on new memory map\n");\r\n#if __OS_HAS_AGP\r\nif (dev_priv->flags & RADEON_IS_AGP) {\r\nbase = dev->agp->base;\r\nif ((base + dev_priv->gart_size - 1) >= dev_priv->fb_location &&\r\nbase < (dev_priv->fb_location + dev_priv->fb_size - 1)) {\r\nDRM_INFO("Can't use AGP base @0x%08lx, won't fit\n",\r\ndev->agp->base);\r\nbase = 0;\r\n}\r\n}\r\n#endif\r\nif (base == 0) {\r\nbase = dev_priv->fb_location + dev_priv->fb_size;\r\nif (base < dev_priv->fb_location ||\r\n((base + dev_priv->gart_size) & 0xfffffffful) < base)\r\nbase = dev_priv->fb_location\r\n- dev_priv->gart_size;\r\n}\r\ndev_priv->gart_vm_start = base & 0xffc00000u;\r\nif (dev_priv->gart_vm_start != base)\r\nDRM_INFO("GART aligned down from 0x%08x to 0x%08x\n",\r\nbase, dev_priv->gart_vm_start);\r\n} else {\r\nDRM_INFO("Setting GART location based on old memory map\n");\r\ndev_priv->gart_vm_start = dev_priv->fb_location +\r\nRADEON_READ(RADEON_CONFIG_APER_SIZE);\r\n}\r\n#if __OS_HAS_AGP\r\nif (dev_priv->flags & RADEON_IS_AGP)\r\ndev_priv->gart_buffers_offset = (dev->agp_buffer_map->offset\r\n- dev->agp->base\r\n+ dev_priv->gart_vm_start);\r\nelse\r\n#endif\r\ndev_priv->gart_buffers_offset = (dev->agp_buffer_map->offset\r\n- (unsigned long)dev->sg->virtual\r\n+ dev_priv->gart_vm_start);\r\nDRM_DEBUG("dev_priv->gart_size %d\n", dev_priv->gart_size);\r\nDRM_DEBUG("dev_priv->gart_vm_start 0x%x\n", dev_priv->gart_vm_start);\r\nDRM_DEBUG("dev_priv->gart_buffers_offset 0x%lx\n",\r\ndev_priv->gart_buffers_offset);\r\ndev_priv->ring.start = (u32 *) dev_priv->cp_ring->handle;\r\ndev_priv->ring.end = ((u32 *) dev_priv->cp_ring->handle\r\n+ init->ring_size / sizeof(u32));\r\ndev_priv->ring.size = init->ring_size;\r\ndev_priv->ring.size_l2qw = drm_order(init->ring_size / 8);\r\ndev_priv->ring.rptr_update = 4096;\r\ndev_priv->ring.rptr_update_l2qw = drm_order( 4096 / 8);\r\ndev_priv->ring.fetch_size = 32;\r\ndev_priv->ring.fetch_size_l2ow = drm_order( 32 / 16);\r\ndev_priv->ring.tail_mask = (dev_priv->ring.size / sizeof(u32)) - 1;\r\ndev_priv->ring.high_mark = RADEON_RING_HIGH_MARK;\r\n#if __OS_HAS_AGP\r\nif (dev_priv->flags & RADEON_IS_AGP) {\r\nradeon_set_pcigart(dev_priv, 0);\r\n} else\r\n#endif\r\n{\r\nu32 sctrl;\r\nint ret;\r\ndev_priv->gart_info.table_mask = DMA_BIT_MASK(32);\r\nif (dev_priv->pcigart_offset_set) {\r\ndev_priv->gart_info.bus_addr =\r\n(resource_size_t)dev_priv->pcigart_offset + dev_priv->fb_location;\r\ndev_priv->gart_info.mapping.offset =\r\ndev_priv->pcigart_offset + dev_priv->fb_aper_offset;\r\ndev_priv->gart_info.mapping.size =\r\ndev_priv->gart_info.table_size;\r\ndrm_core_ioremap_wc(&dev_priv->gart_info.mapping, dev);\r\ndev_priv->gart_info.addr =\r\ndev_priv->gart_info.mapping.handle;\r\nif (dev_priv->flags & RADEON_IS_PCIE)\r\ndev_priv->gart_info.gart_reg_if = DRM_ATI_GART_PCIE;\r\nelse\r\ndev_priv->gart_info.gart_reg_if = DRM_ATI_GART_PCI;\r\ndev_priv->gart_info.gart_table_location =\r\nDRM_ATI_GART_FB;\r\nDRM_DEBUG("Setting phys_pci_gart to %p %08lX\n",\r\ndev_priv->gart_info.addr,\r\ndev_priv->pcigart_offset);\r\n} else {\r\nif (dev_priv->flags & RADEON_IS_IGPGART)\r\ndev_priv->gart_info.gart_reg_if = DRM_ATI_GART_IGP;\r\nelse\r\ndev_priv->gart_info.gart_reg_if = DRM_ATI_GART_PCI;\r\ndev_priv->gart_info.gart_table_location =\r\nDRM_ATI_GART_MAIN;\r\ndev_priv->gart_info.addr = NULL;\r\ndev_priv->gart_info.bus_addr = 0;\r\nif (dev_priv->flags & RADEON_IS_PCIE) {\r\nDRM_ERROR\r\n("Cannot use PCI Express without GART in FB memory\n");\r\nradeon_do_cleanup_cp(dev);\r\nreturn -EINVAL;\r\n}\r\n}\r\nsctrl = RADEON_READ(RADEON_SURFACE_CNTL);\r\nRADEON_WRITE(RADEON_SURFACE_CNTL, 0);\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS600)\r\nret = r600_page_table_init(dev);\r\nelse\r\nret = drm_ati_pcigart_init(dev, &dev_priv->gart_info);\r\nRADEON_WRITE(RADEON_SURFACE_CNTL, sctrl);\r\nif (!ret) {\r\nDRM_ERROR("failed to init PCI GART!\n");\r\nradeon_do_cleanup_cp(dev);\r\nreturn -ENOMEM;\r\n}\r\nret = radeon_setup_pcigart_surface(dev_priv);\r\nif (ret) {\r\nDRM_ERROR("failed to setup GART surface!\n");\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS600)\r\nr600_page_table_cleanup(dev, &dev_priv->gart_info);\r\nelse\r\ndrm_ati_pcigart_cleanup(dev, &dev_priv->gart_info);\r\nradeon_do_cleanup_cp(dev);\r\nreturn ret;\r\n}\r\nradeon_set_pcigart(dev_priv, 1);\r\n}\r\nif (!dev_priv->me_fw) {\r\nint err = radeon_cp_init_microcode(dev_priv);\r\nif (err) {\r\nDRM_ERROR("Failed to load firmware!\n");\r\nradeon_do_cleanup_cp(dev);\r\nreturn err;\r\n}\r\n}\r\nradeon_cp_load_microcode(dev_priv);\r\nradeon_cp_init_ring_buffer(dev, dev_priv, file_priv);\r\ndev_priv->last_buf = 0;\r\nradeon_do_engine_reset(dev);\r\nradeon_test_writeback(dev_priv);\r\nreturn 0;\r\n}\r\nstatic int radeon_do_cleanup_cp(struct drm_device * dev)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nDRM_DEBUG("\n");\r\nif (dev->irq_enabled)\r\ndrm_irq_uninstall(dev);\r\n#if __OS_HAS_AGP\r\nif (dev_priv->flags & RADEON_IS_AGP) {\r\nif (dev_priv->cp_ring != NULL) {\r\ndrm_core_ioremapfree(dev_priv->cp_ring, dev);\r\ndev_priv->cp_ring = NULL;\r\n}\r\nif (dev_priv->ring_rptr != NULL) {\r\ndrm_core_ioremapfree(dev_priv->ring_rptr, dev);\r\ndev_priv->ring_rptr = NULL;\r\n}\r\nif (dev->agp_buffer_map != NULL) {\r\ndrm_core_ioremapfree(dev->agp_buffer_map, dev);\r\ndev->agp_buffer_map = NULL;\r\n}\r\n} else\r\n#endif\r\n{\r\nif (dev_priv->gart_info.bus_addr) {\r\nradeon_set_pcigart(dev_priv, 0);\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS600)\r\nr600_page_table_cleanup(dev, &dev_priv->gart_info);\r\nelse {\r\nif (!drm_ati_pcigart_cleanup(dev, &dev_priv->gart_info))\r\nDRM_ERROR("failed to cleanup PCI GART!\n");\r\n}\r\n}\r\nif (dev_priv->gart_info.gart_table_location == DRM_ATI_GART_FB)\r\n{\r\ndrm_core_ioremapfree(&dev_priv->gart_info.mapping, dev);\r\ndev_priv->gart_info.addr = NULL;\r\n}\r\n}\r\nmemset(dev_priv, 0, offsetof(drm_radeon_private_t, flags));\r\nreturn 0;\r\n}\r\nstatic int radeon_do_resume_cp(struct drm_device *dev, struct drm_file *file_priv)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nif (!dev_priv) {\r\nDRM_ERROR("Called with no initialization\n");\r\nreturn -EINVAL;\r\n}\r\nDRM_DEBUG("Starting radeon_do_resume_cp()\n");\r\n#if __OS_HAS_AGP\r\nif (dev_priv->flags & RADEON_IS_AGP) {\r\nradeon_set_pcigart(dev_priv, 0);\r\n} else\r\n#endif\r\n{\r\nradeon_set_pcigart(dev_priv, 1);\r\n}\r\nradeon_cp_load_microcode(dev_priv);\r\nradeon_cp_init_ring_buffer(dev, dev_priv, file_priv);\r\ndev_priv->have_z_offset = 0;\r\nradeon_do_engine_reset(dev);\r\nradeon_irq_set_state(dev, RADEON_SW_INT_ENABLE, 1);\r\nDRM_DEBUG("radeon_do_resume_cp() complete\n");\r\nreturn 0;\r\n}\r\nint radeon_cp_init(struct drm_device *dev, void *data, struct drm_file *file_priv)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\ndrm_radeon_init_t *init = data;\r\nLOCK_TEST_WITH_RETURN(dev, file_priv);\r\nif (init->func == RADEON_INIT_R300_CP)\r\nr300_init_reg_flags(dev);\r\nswitch (init->func) {\r\ncase RADEON_INIT_CP:\r\ncase RADEON_INIT_R200_CP:\r\ncase RADEON_INIT_R300_CP:\r\nreturn radeon_do_init_cp(dev, init, file_priv);\r\ncase RADEON_INIT_R600_CP:\r\nreturn r600_do_init_cp(dev, init, file_priv);\r\ncase RADEON_CLEANUP_CP:\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R600)\r\nreturn r600_do_cleanup_cp(dev);\r\nelse\r\nreturn radeon_do_cleanup_cp(dev);\r\n}\r\nreturn -EINVAL;\r\n}\r\nint radeon_cp_start(struct drm_device *dev, void *data, struct drm_file *file_priv)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nDRM_DEBUG("\n");\r\nLOCK_TEST_WITH_RETURN(dev, file_priv);\r\nif (dev_priv->cp_running) {\r\nDRM_DEBUG("while CP running\n");\r\nreturn 0;\r\n}\r\nif (dev_priv->cp_mode == RADEON_CSQ_PRIDIS_INDDIS) {\r\nDRM_DEBUG("called with bogus CP mode (%d)\n",\r\ndev_priv->cp_mode);\r\nreturn 0;\r\n}\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R600)\r\nr600_do_cp_start(dev_priv);\r\nelse\r\nradeon_do_cp_start(dev_priv);\r\nreturn 0;\r\n}\r\nint radeon_cp_stop(struct drm_device *dev, void *data, struct drm_file *file_priv)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\ndrm_radeon_cp_stop_t *stop = data;\r\nint ret;\r\nDRM_DEBUG("\n");\r\nLOCK_TEST_WITH_RETURN(dev, file_priv);\r\nif (!dev_priv->cp_running)\r\nreturn 0;\r\nif (stop->flush) {\r\nradeon_do_cp_flush(dev_priv);\r\n}\r\nif (stop->idle) {\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R600)\r\nret = r600_do_cp_idle(dev_priv);\r\nelse\r\nret = radeon_do_cp_idle(dev_priv);\r\nif (ret)\r\nreturn ret;\r\n}\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R600)\r\nr600_do_cp_stop(dev_priv);\r\nelse\r\nradeon_do_cp_stop(dev_priv);\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R600)\r\nr600_do_engine_reset(dev);\r\nelse\r\nradeon_do_engine_reset(dev);\r\nreturn 0;\r\n}\r\nvoid radeon_do_release(struct drm_device * dev)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nint i, ret;\r\nif (dev_priv) {\r\nif (dev_priv->cp_running) {\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R600) {\r\nwhile ((ret = r600_do_cp_idle(dev_priv)) != 0) {\r\nDRM_DEBUG("radeon_do_cp_idle %d\n", ret);\r\n#ifdef __linux__\r\nschedule();\r\n#else\r\ntsleep(&ret, PZERO, "rdnrel", 1);\r\n#endif\r\n}\r\n} else {\r\nwhile ((ret = radeon_do_cp_idle(dev_priv)) != 0) {\r\nDRM_DEBUG("radeon_do_cp_idle %d\n", ret);\r\n#ifdef __linux__\r\nschedule();\r\n#else\r\ntsleep(&ret, PZERO, "rdnrel", 1);\r\n#endif\r\n}\r\n}\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R600) {\r\nr600_do_cp_stop(dev_priv);\r\nr600_do_engine_reset(dev);\r\n} else {\r\nradeon_do_cp_stop(dev_priv);\r\nradeon_do_engine_reset(dev);\r\n}\r\n}\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) < CHIP_R600) {\r\nif (dev_priv->mmio)\r\nRADEON_WRITE(RADEON_GEN_INT_CNTL, 0);\r\nif (dev_priv->mmio) {\r\nfor (i = 0; i < RADEON_MAX_SURFACES; i++) {\r\nRADEON_WRITE(RADEON_SURFACE0_INFO + 16 * i, 0);\r\nRADEON_WRITE(RADEON_SURFACE0_LOWER_BOUND +\r\n16 * i, 0);\r\nRADEON_WRITE(RADEON_SURFACE0_UPPER_BOUND +\r\n16 * i, 0);\r\n}\r\n}\r\n}\r\nradeon_mem_takedown(&(dev_priv->gart_heap));\r\nradeon_mem_takedown(&(dev_priv->fb_heap));\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R600)\r\nr600_do_cleanup_cp(dev);\r\nelse\r\nradeon_do_cleanup_cp(dev);\r\nrelease_firmware(dev_priv->me_fw);\r\ndev_priv->me_fw = NULL;\r\nrelease_firmware(dev_priv->pfp_fw);\r\ndev_priv->pfp_fw = NULL;\r\n}\r\n}\r\nint radeon_cp_reset(struct drm_device *dev, void *data, struct drm_file *file_priv)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nDRM_DEBUG("\n");\r\nLOCK_TEST_WITH_RETURN(dev, file_priv);\r\nif (!dev_priv) {\r\nDRM_DEBUG("called before init done\n");\r\nreturn -EINVAL;\r\n}\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R600)\r\nr600_do_cp_reset(dev_priv);\r\nelse\r\nradeon_do_cp_reset(dev_priv);\r\ndev_priv->cp_running = 0;\r\nreturn 0;\r\n}\r\nint radeon_cp_idle(struct drm_device *dev, void *data, struct drm_file *file_priv)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nDRM_DEBUG("\n");\r\nLOCK_TEST_WITH_RETURN(dev, file_priv);\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R600)\r\nreturn r600_do_cp_idle(dev_priv);\r\nelse\r\nreturn radeon_do_cp_idle(dev_priv);\r\n}\r\nint radeon_cp_resume(struct drm_device *dev, void *data, struct drm_file *file_priv)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nDRM_DEBUG("\n");\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R600)\r\nreturn r600_do_resume_cp(dev, file_priv);\r\nelse\r\nreturn radeon_do_resume_cp(dev, file_priv);\r\n}\r\nint radeon_engine_reset(struct drm_device *dev, void *data, struct drm_file *file_priv)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nDRM_DEBUG("\n");\r\nLOCK_TEST_WITH_RETURN(dev, file_priv);\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R600)\r\nreturn r600_do_engine_reset(dev);\r\nelse\r\nreturn radeon_do_engine_reset(dev);\r\n}\r\nint radeon_fullscreen(struct drm_device *dev, void *data, struct drm_file *file_priv)\r\n{\r\nreturn 0;\r\n}\r\nstruct drm_buf *radeon_freelist_get(struct drm_device * dev)\r\n{\r\nstruct drm_device_dma *dma = dev->dma;\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\ndrm_radeon_buf_priv_t *buf_priv;\r\nstruct drm_buf *buf;\r\nint i, t;\r\nint start;\r\nif (++dev_priv->last_buf >= dma->buf_count)\r\ndev_priv->last_buf = 0;\r\nstart = dev_priv->last_buf;\r\nfor (t = 0; t < dev_priv->usec_timeout; t++) {\r\nu32 done_age = GET_SCRATCH(dev_priv, 1);\r\nDRM_DEBUG("done_age = %d\n", done_age);\r\nfor (i = 0; i < dma->buf_count; i++) {\r\nbuf = dma->buflist[start];\r\nbuf_priv = buf->dev_private;\r\nif (buf->file_priv == NULL || (buf->pending &&\r\nbuf_priv->age <=\r\ndone_age)) {\r\ndev_priv->stats.requested_bufs++;\r\nbuf->pending = 0;\r\nreturn buf;\r\n}\r\nif (++start >= dma->buf_count)\r\nstart = 0;\r\n}\r\nif (t) {\r\nDRM_UDELAY(1);\r\ndev_priv->stats.freelist_loops++;\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nvoid radeon_freelist_reset(struct drm_device * dev)\r\n{\r\nstruct drm_device_dma *dma = dev->dma;\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nint i;\r\ndev_priv->last_buf = 0;\r\nfor (i = 0; i < dma->buf_count; i++) {\r\nstruct drm_buf *buf = dma->buflist[i];\r\ndrm_radeon_buf_priv_t *buf_priv = buf->dev_private;\r\nbuf_priv->age = 0;\r\n}\r\n}\r\nint radeon_wait_ring(drm_radeon_private_t * dev_priv, int n)\r\n{\r\ndrm_radeon_ring_buffer_t *ring = &dev_priv->ring;\r\nint i;\r\nu32 last_head = GET_RING_HEAD(dev_priv);\r\nfor (i = 0; i < dev_priv->usec_timeout; i++) {\r\nu32 head = GET_RING_HEAD(dev_priv);\r\nring->space = (head - ring->tail) * sizeof(u32);\r\nif (ring->space <= 0)\r\nring->space += ring->size;\r\nif (ring->space > n)\r\nreturn 0;\r\ndev_priv->stats.boxes |= RADEON_BOX_WAIT_IDLE;\r\nif (head != last_head)\r\ni = 0;\r\nlast_head = head;\r\nDRM_UDELAY(1);\r\n}\r\n#if RADEON_FIFO_DEBUG\r\nradeon_status(dev_priv);\r\nDRM_ERROR("failed!\n");\r\n#endif\r\nreturn -EBUSY;\r\n}\r\nstatic int radeon_cp_get_buffers(struct drm_device *dev,\r\nstruct drm_file *file_priv,\r\nstruct drm_dma * d)\r\n{\r\nint i;\r\nstruct drm_buf *buf;\r\nfor (i = d->granted_count; i < d->request_count; i++) {\r\nbuf = radeon_freelist_get(dev);\r\nif (!buf)\r\nreturn -EBUSY;\r\nbuf->file_priv = file_priv;\r\nif (DRM_COPY_TO_USER(&d->request_indices[i], &buf->idx,\r\nsizeof(buf->idx)))\r\nreturn -EFAULT;\r\nif (DRM_COPY_TO_USER(&d->request_sizes[i], &buf->total,\r\nsizeof(buf->total)))\r\nreturn -EFAULT;\r\nd->granted_count++;\r\n}\r\nreturn 0;\r\n}\r\nint radeon_cp_buffers(struct drm_device *dev, void *data, struct drm_file *file_priv)\r\n{\r\nstruct drm_device_dma *dma = dev->dma;\r\nint ret = 0;\r\nstruct drm_dma *d = data;\r\nLOCK_TEST_WITH_RETURN(dev, file_priv);\r\nif (d->send_count != 0) {\r\nDRM_ERROR("Process %d trying to send %d buffers via drmDMA\n",\r\nDRM_CURRENTPID, d->send_count);\r\nreturn -EINVAL;\r\n}\r\nif (d->request_count < 0 || d->request_count > dma->buf_count) {\r\nDRM_ERROR("Process %d trying to get %d buffers (of %d max)\n",\r\nDRM_CURRENTPID, d->request_count, dma->buf_count);\r\nreturn -EINVAL;\r\n}\r\nd->granted_count = 0;\r\nif (d->request_count) {\r\nret = radeon_cp_get_buffers(dev, file_priv, d);\r\n}\r\nreturn ret;\r\n}\r\nint radeon_driver_load(struct drm_device *dev, unsigned long flags)\r\n{\r\ndrm_radeon_private_t *dev_priv;\r\nint ret = 0;\r\ndev_priv = kzalloc(sizeof(drm_radeon_private_t), GFP_KERNEL);\r\nif (dev_priv == NULL)\r\nreturn -ENOMEM;\r\ndev->dev_private = (void *)dev_priv;\r\ndev_priv->flags = flags;\r\nswitch (flags & RADEON_FAMILY_MASK) {\r\ncase CHIP_R100:\r\ncase CHIP_RV200:\r\ncase CHIP_R200:\r\ncase CHIP_R300:\r\ncase CHIP_R350:\r\ncase CHIP_R420:\r\ncase CHIP_R423:\r\ncase CHIP_RV410:\r\ncase CHIP_RV515:\r\ncase CHIP_R520:\r\ncase CHIP_RV570:\r\ncase CHIP_R580:\r\ndev_priv->flags |= RADEON_HAS_HIERZ;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\npci_set_master(dev->pdev);\r\nif (drm_pci_device_is_agp(dev))\r\ndev_priv->flags |= RADEON_IS_AGP;\r\nelse if (pci_is_pcie(dev->pdev))\r\ndev_priv->flags |= RADEON_IS_PCIE;\r\nelse\r\ndev_priv->flags |= RADEON_IS_PCI;\r\nret = drm_addmap(dev, pci_resource_start(dev->pdev, 2),\r\npci_resource_len(dev->pdev, 2), _DRM_REGISTERS,\r\n_DRM_READ_ONLY | _DRM_DRIVER, &dev_priv->mmio);\r\nif (ret != 0)\r\nreturn ret;\r\nret = drm_vblank_init(dev, 2);\r\nif (ret) {\r\nradeon_driver_unload(dev);\r\nreturn ret;\r\n}\r\nDRM_DEBUG("%s card detected\n",\r\n((dev_priv->flags & RADEON_IS_AGP) ? "AGP" : (((dev_priv->flags & RADEON_IS_PCIE) ? "PCIE" : "PCI"))));\r\nreturn ret;\r\n}\r\nint radeon_master_create(struct drm_device *dev, struct drm_master *master)\r\n{\r\nstruct drm_radeon_master_private *master_priv;\r\nunsigned long sareapage;\r\nint ret;\r\nmaster_priv = kzalloc(sizeof(*master_priv), GFP_KERNEL);\r\nif (!master_priv)\r\nreturn -ENOMEM;\r\nsareapage = max_t(unsigned long, SAREA_MAX, PAGE_SIZE);\r\nret = drm_addmap(dev, 0, sareapage, _DRM_SHM, _DRM_CONTAINS_LOCK,\r\n&master_priv->sarea);\r\nif (ret) {\r\nDRM_ERROR("SAREA setup failed\n");\r\nkfree(master_priv);\r\nreturn ret;\r\n}\r\nmaster_priv->sarea_priv = master_priv->sarea->handle + sizeof(struct drm_sarea);\r\nmaster_priv->sarea_priv->pfCurrentPage = 0;\r\nmaster->driver_priv = master_priv;\r\nreturn 0;\r\n}\r\nvoid radeon_master_destroy(struct drm_device *dev, struct drm_master *master)\r\n{\r\nstruct drm_radeon_master_private *master_priv = master->driver_priv;\r\nif (!master_priv)\r\nreturn;\r\nif (master_priv->sarea_priv &&\r\nmaster_priv->sarea_priv->pfCurrentPage != 0)\r\nradeon_cp_dispatch_flip(dev, master);\r\nmaster_priv->sarea_priv = NULL;\r\nif (master_priv->sarea)\r\ndrm_rmmap_locked(dev, master_priv->sarea);\r\nkfree(master_priv);\r\nmaster->driver_priv = NULL;\r\n}\r\nint radeon_driver_firstopen(struct drm_device *dev)\r\n{\r\nint ret;\r\ndrm_local_map_t *map;\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\ndev_priv->gart_info.table_size = RADEON_PCIGART_TABLE_SIZE;\r\ndev_priv->fb_aper_offset = pci_resource_start(dev->pdev, 0);\r\nret = drm_addmap(dev, dev_priv->fb_aper_offset,\r\npci_resource_len(dev->pdev, 0), _DRM_FRAME_BUFFER,\r\n_DRM_WRITE_COMBINING, &map);\r\nif (ret != 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nint radeon_driver_unload(struct drm_device *dev)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nDRM_DEBUG("\n");\r\ndrm_rmmap(dev, dev_priv->mmio);\r\nkfree(dev_priv);\r\ndev->dev_private = NULL;\r\nreturn 0;\r\n}\r\nvoid radeon_commit_ring(drm_radeon_private_t *dev_priv)\r\n{\r\nint i;\r\nu32 *ring;\r\nint tail_aligned;\r\ntail_aligned = dev_priv->ring.tail & (RADEON_RING_ALIGN-1);\r\nif (tail_aligned) {\r\nint num_p2 = RADEON_RING_ALIGN - tail_aligned;\r\nring = dev_priv->ring.start;\r\nfor (i = 0; i < num_p2; i++)\r\nring[dev_priv->ring.tail + i] = CP_PACKET2();\r\ndev_priv->ring.tail += i;\r\ndev_priv->ring.space -= num_p2 * sizeof(u32);\r\n}\r\ndev_priv->ring.tail &= dev_priv->ring.tail_mask;\r\nDRM_MEMORYBARRIER();\r\nGET_RING_HEAD( dev_priv );\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_R600) {\r\nRADEON_WRITE(R600_CP_RB_WPTR, dev_priv->ring.tail);\r\nRADEON_READ(R600_CP_RB_RPTR);\r\n} else {\r\nRADEON_WRITE(RADEON_CP_RB_WPTR, dev_priv->ring.tail);\r\nRADEON_READ(RADEON_CP_RB_RPTR);\r\n}\r\n}

static void solo_capture_config(struct solo_dev *solo_dev)\r\n{\r\nunsigned long height;\r\nunsigned long width;\r\nvoid *buf;\r\nint i;\r\nsolo_reg_write(solo_dev, SOLO_CAP_BASE,\r\nSOLO_CAP_MAX_PAGE((SOLO_CAP_EXT_SIZE(solo_dev)\r\n- SOLO_CAP_PAGE_SIZE) >> 16)\r\n| SOLO_CAP_BASE_ADDR(SOLO_CAP_EXT_ADDR(solo_dev) >> 16));\r\nif (solo_dev->type == SOLO_DEV_6110) {\r\nsolo_reg_write(solo_dev, SOLO_CAP_BTW,\r\n(1 << 17) | SOLO_CAP_PROG_BANDWIDTH(2) |\r\nSOLO_CAP_MAX_BANDWIDTH(36));\r\n} else {\r\nsolo_reg_write(solo_dev, SOLO_CAP_BTW,\r\n(1 << 17) | SOLO_CAP_PROG_BANDWIDTH(2) |\r\nSOLO_CAP_MAX_BANDWIDTH(32));\r\n}\r\nwidth = solo_dev->video_hsize;\r\nheight = solo_dev->video_vsize;\r\nsolo_reg_write(solo_dev, SOLO_DIM_SCALE1,\r\nSOLO_DIM_H_MB_NUM(width / 16) |\r\nSOLO_DIM_V_MB_NUM_FRAME(height / 8) |\r\nSOLO_DIM_V_MB_NUM_FIELD(height / 16));\r\nwidth = solo_dev->video_hsize / 2;\r\nheight = solo_dev->video_vsize;\r\nsolo_reg_write(solo_dev, SOLO_DIM_SCALE2,\r\nSOLO_DIM_H_MB_NUM(width / 16) |\r\nSOLO_DIM_V_MB_NUM_FRAME(height / 8) |\r\nSOLO_DIM_V_MB_NUM_FIELD(height / 16));\r\nwidth = solo_dev->video_hsize / 2;\r\nheight = solo_dev->video_vsize / 2;\r\nsolo_reg_write(solo_dev, SOLO_DIM_SCALE3,\r\nSOLO_DIM_H_MB_NUM(width / 16) |\r\nSOLO_DIM_V_MB_NUM_FRAME(height / 8) |\r\nSOLO_DIM_V_MB_NUM_FIELD(height / 16));\r\nwidth = solo_dev->video_hsize / 3;\r\nheight = solo_dev->video_vsize / 3;\r\nsolo_reg_write(solo_dev, SOLO_DIM_SCALE4,\r\nSOLO_DIM_H_MB_NUM(width / 16) |\r\nSOLO_DIM_V_MB_NUM_FRAME(height / 8) |\r\nSOLO_DIM_V_MB_NUM_FIELD(height / 16));\r\nwidth = solo_dev->video_hsize / 4;\r\nheight = solo_dev->video_vsize / 2;\r\nsolo_reg_write(solo_dev, SOLO_DIM_SCALE5,\r\nSOLO_DIM_H_MB_NUM(width / 16) |\r\nSOLO_DIM_V_MB_NUM_FRAME(height / 8) |\r\nSOLO_DIM_V_MB_NUM_FIELD(height / 16));\r\nwidth = VI_PROG_HSIZE;\r\nheight = VI_PROG_VSIZE;\r\nsolo_reg_write(solo_dev, SOLO_DIM_PROG,\r\nSOLO_DIM_H_MB_NUM(width / 16) |\r\nSOLO_DIM_V_MB_NUM_FRAME(height / 16) |\r\nSOLO_DIM_V_MB_NUM_FIELD(height / 16));\r\nsolo_reg_write(solo_dev, SOLO_VE_OSD_CH, 0);\r\nsolo_reg_write(solo_dev, SOLO_VE_OSD_BASE, SOLO_EOSD_EXT_ADDR >> 16);\r\nsolo_reg_write(solo_dev, SOLO_VE_OSD_CLR,\r\n0xF0 << 16 | 0x80 << 8 | 0x80);\r\nif (solo_dev->type == SOLO_DEV_6010)\r\nsolo_reg_write(solo_dev, SOLO_VE_OSD_OPT,\r\nSOLO_VE_OSD_H_SHADOW | SOLO_VE_OSD_V_SHADOW);\r\nelse\r\nsolo_reg_write(solo_dev, SOLO_VE_OSD_OPT, SOLO_VE_OSD_V_DOUBLE\r\n| SOLO_VE_OSD_H_SHADOW | SOLO_VE_OSD_V_SHADOW);\r\nbuf = kzalloc(SOLO_EOSD_EXT_SIZE(solo_dev), GFP_KERNEL);\r\nif (!buf)\r\nreturn;\r\nfor (i = 0; i < solo_dev->nr_chans; i++) {\r\nsolo_p2m_dma(solo_dev, 1, buf,\r\nSOLO_EOSD_EXT_ADDR +\r\n(SOLO_EOSD_EXT_SIZE(solo_dev) * i),\r\nSOLO_EOSD_EXT_SIZE(solo_dev), 0, 0);\r\n}\r\nkfree(buf);\r\n}\r\nint solo_osd_print(struct solo_enc_dev *solo_enc)\r\n{\r\nstruct solo_dev *solo_dev = solo_enc->solo_dev;\r\nunsigned char *str = solo_enc->osd_text;\r\nu8 *buf = solo_enc->osd_buf;\r\nu32 reg = solo_reg_read(solo_dev, SOLO_VE_OSD_CH);\r\nconst struct font_desc *vga = find_font("VGA8x16");\r\nconst unsigned char *vga_data;\r\nint len;\r\nint i, j;\r\nif (WARN_ON_ONCE(!vga))\r\nreturn -ENODEV;\r\nlen = strlen(str);\r\nif (len == 0) {\r\nreg &= ~(1 << solo_enc->ch);\r\nsolo_reg_write(solo_dev, SOLO_VE_OSD_CH, reg);\r\nreturn 0;\r\n}\r\nmemset(buf, 0, SOLO_EOSD_EXT_SIZE_MAX);\r\nvga_data = (const unsigned char *)vga->data;\r\nfor (i = 0; i < len; i++) {\r\nunsigned char c = str[i];\r\nfor (j = 0; j < 16; j++) {\r\nbuf[(j * 2) + (i % 2) + (i / 2 * 32)] =\r\nbitrev8(vga_data[(c * 16) + j]);\r\n}\r\n}\r\nsolo_p2m_dma(solo_dev, 1, buf,\r\nSOLO_EOSD_EXT_ADDR +\r\n(solo_enc->ch * SOLO_EOSD_EXT_SIZE(solo_dev)),\r\nSOLO_EOSD_EXT_SIZE(solo_dev), 0, 0);\r\nreg |= (1 << solo_enc->ch);\r\nsolo_reg_write(solo_dev, SOLO_VE_OSD_CH, reg);\r\nreturn 0;\r\n}\r\nvoid solo_s_jpeg_qp(struct solo_dev *solo_dev, unsigned int ch,\r\nunsigned int qp)\r\n{\r\nunsigned long flags;\r\nunsigned int idx, reg;\r\nif ((ch > 31) || (qp > 3))\r\nreturn;\r\nif (solo_dev->type == SOLO_DEV_6010)\r\nreturn;\r\nif (ch < 16) {\r\nidx = 0;\r\nreg = SOLO_VE_JPEG_QP_CH_L;\r\n} else {\r\nch -= 16;\r\nidx = 1;\r\nreg = SOLO_VE_JPEG_QP_CH_H;\r\n}\r\nch *= 2;\r\nspin_lock_irqsave(&solo_dev->jpeg_qp_lock, flags);\r\nsolo_dev->jpeg_qp[idx] &= ~(3 << ch);\r\nsolo_dev->jpeg_qp[idx] |= (qp & 3) << ch;\r\nsolo_reg_write(solo_dev, reg, solo_dev->jpeg_qp[idx]);\r\nspin_unlock_irqrestore(&solo_dev->jpeg_qp_lock, flags);\r\n}\r\nint solo_g_jpeg_qp(struct solo_dev *solo_dev, unsigned int ch)\r\n{\r\nint idx;\r\nif (solo_dev->type == SOLO_DEV_6010)\r\nreturn 2;\r\nif (WARN_ON_ONCE(ch > 31))\r\nreturn 2;\r\nif (ch < 16) {\r\nidx = 0;\r\n} else {\r\nch -= 16;\r\nidx = 1;\r\n}\r\nch *= 2;\r\nreturn (solo_dev->jpeg_qp[idx] >> ch) & 3;\r\n}\r\nstatic void solo_jpeg_config(struct solo_dev *solo_dev)\r\n{\r\nif (solo_dev->type == SOLO_DEV_6010) {\r\nsolo_reg_write(solo_dev, SOLO_VE_JPEG_QP_TBL,\r\n(2 << 24) | (2 << 16) | (2 << 8) | 2);\r\n} else {\r\nsolo_reg_write(solo_dev, SOLO_VE_JPEG_QP_TBL,\r\n(4 << 24) | (3 << 16) | (2 << 8) | 1);\r\n}\r\nspin_lock_init(&solo_dev->jpeg_qp_lock);\r\nsolo_dev->jpeg_qp[0] = solo_dev->jpeg_qp[1] = SOLO_QP_INIT;\r\nsolo_reg_write(solo_dev, SOLO_VE_JPEG_QP_CH_L, SOLO_QP_INIT);\r\nsolo_reg_write(solo_dev, SOLO_VE_JPEG_QP_CH_H, SOLO_QP_INIT);\r\nsolo_reg_write(solo_dev, SOLO_VE_JPEG_CFG,\r\n(SOLO_JPEG_EXT_SIZE(solo_dev) & 0xffff0000) |\r\n((SOLO_JPEG_EXT_ADDR(solo_dev) >> 16) & 0x0000ffff));\r\nsolo_reg_write(solo_dev, SOLO_VE_JPEG_CTRL, 0xffffffff);\r\nif (solo_dev->type == SOLO_DEV_6110) {\r\nsolo_reg_write(solo_dev, SOLO_VE_JPEG_CFG1,\r\n(0 << 16) | (30 << 8) | 60);\r\n}\r\n}\r\nstatic void solo_mp4e_config(struct solo_dev *solo_dev)\r\n{\r\nint i;\r\nu32 cfg;\r\nsolo_reg_write(solo_dev, SOLO_VE_CFG0,\r\nSOLO_VE_INTR_CTRL(IRQ_LEVEL) |\r\nSOLO_VE_BLOCK_SIZE(SOLO_MP4E_EXT_SIZE(solo_dev) >> 16) |\r\nSOLO_VE_BLOCK_BASE(SOLO_MP4E_EXT_ADDR(solo_dev) >> 16));\r\ncfg = SOLO_VE_BYTE_ALIGN(2) | SOLO_VE_INSERT_INDEX\r\n| SOLO_VE_MOTION_MODE(0);\r\nif (solo_dev->type != SOLO_DEV_6010) {\r\ncfg |= SOLO_VE_MPEG_SIZE_H(\r\n(SOLO_MP4E_EXT_SIZE(solo_dev) >> 24) & 0x0f);\r\ncfg |= SOLO_VE_JPEG_SIZE_H(\r\n(SOLO_JPEG_EXT_SIZE(solo_dev) >> 24) & 0x0f);\r\n}\r\nsolo_reg_write(solo_dev, SOLO_VE_CFG1, cfg);\r\nsolo_reg_write(solo_dev, SOLO_VE_WMRK_POLY, 0);\r\nsolo_reg_write(solo_dev, SOLO_VE_VMRK_INIT_KEY, 0);\r\nsolo_reg_write(solo_dev, SOLO_VE_WMRK_STRL, 0);\r\nif (solo_dev->type == SOLO_DEV_6110)\r\nsolo_reg_write(solo_dev, SOLO_VE_WMRK_ENABLE, 0);\r\nsolo_reg_write(solo_dev, SOLO_VE_ENCRYP_POLY, 0);\r\nsolo_reg_write(solo_dev, SOLO_VE_ENCRYP_INIT, 0);\r\nsolo_reg_write(solo_dev, SOLO_VE_ATTR,\r\nSOLO_VE_LITTLE_ENDIAN |\r\nSOLO_COMP_ATTR_FCODE(1) |\r\nSOLO_COMP_TIME_INC(0) |\r\nSOLO_COMP_TIME_WIDTH(15) |\r\nSOLO_DCT_INTERVAL(solo_dev->type == SOLO_DEV_6010 ? 9 : 10));\r\nfor (i = 0; i < solo_dev->nr_chans; i++) {\r\nsolo_reg_write(solo_dev, SOLO_VE_CH_REF_BASE(i),\r\n(SOLO_EREF_EXT_ADDR(solo_dev) +\r\n(i * SOLO_EREF_EXT_SIZE)) >> 16);\r\nsolo_reg_write(solo_dev, SOLO_VE_CH_REF_BASE_E(i),\r\n(SOLO_EREF_EXT_ADDR(solo_dev) +\r\n((i + 16) * SOLO_EREF_EXT_SIZE)) >> 16);\r\n}\r\nif (solo_dev->type == SOLO_DEV_6110) {\r\nsolo_reg_write(solo_dev, SOLO_VE_COMPT_MOT, 0x00040008);\r\n} else {\r\nfor (i = 0; i < solo_dev->nr_chans; i++)\r\nsolo_reg_write(solo_dev, SOLO_VE_CH_MOT(i), 0x100);\r\n}\r\n}\r\nint solo_enc_init(struct solo_dev *solo_dev)\r\n{\r\nint i;\r\nsolo_capture_config(solo_dev);\r\nsolo_mp4e_config(solo_dev);\r\nsolo_jpeg_config(solo_dev);\r\nfor (i = 0; i < solo_dev->nr_chans; i++) {\r\nsolo_reg_write(solo_dev, SOLO_CAP_CH_SCALE(i), 0);\r\nsolo_reg_write(solo_dev, SOLO_CAP_CH_COMP_ENA_E(i), 0);\r\n}\r\nreturn 0;\r\n}\r\nvoid solo_enc_exit(struct solo_dev *solo_dev)\r\n{\r\nint i;\r\nfor (i = 0; i < solo_dev->nr_chans; i++) {\r\nsolo_reg_write(solo_dev, SOLO_CAP_CH_SCALE(i), 0);\r\nsolo_reg_write(solo_dev, SOLO_CAP_CH_COMP_ENA_E(i), 0);\r\n}\r\n}

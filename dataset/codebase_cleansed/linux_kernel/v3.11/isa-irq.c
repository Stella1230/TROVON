static void isa_mask_pic_lo_irq(struct irq_data *d)\r\n{\r\nunsigned int mask = 1 << (d->irq & 7);\r\noutb(inb(PIC_MASK_LO) | mask, PIC_MASK_LO);\r\n}\r\nstatic void isa_ack_pic_lo_irq(struct irq_data *d)\r\n{\r\nunsigned int mask = 1 << (d->irq & 7);\r\noutb(inb(PIC_MASK_LO) | mask, PIC_MASK_LO);\r\noutb(0x20, PIC_LO);\r\n}\r\nstatic void isa_unmask_pic_lo_irq(struct irq_data *d)\r\n{\r\nunsigned int mask = 1 << (d->irq & 7);\r\noutb(inb(PIC_MASK_LO) & ~mask, PIC_MASK_LO);\r\n}\r\nstatic void isa_mask_pic_hi_irq(struct irq_data *d)\r\n{\r\nunsigned int mask = 1 << (d->irq & 7);\r\noutb(inb(PIC_MASK_HI) | mask, PIC_MASK_HI);\r\n}\r\nstatic void isa_ack_pic_hi_irq(struct irq_data *d)\r\n{\r\nunsigned int mask = 1 << (d->irq & 7);\r\noutb(inb(PIC_MASK_HI) | mask, PIC_MASK_HI);\r\noutb(0x62, PIC_LO);\r\noutb(0x20, PIC_HI);\r\n}\r\nstatic void isa_unmask_pic_hi_irq(struct irq_data *d)\r\n{\r\nunsigned int mask = 1 << (d->irq & 7);\r\noutb(inb(PIC_MASK_HI) & ~mask, PIC_MASK_HI);\r\n}\r\nstatic void\r\nisa_irq_handler(unsigned int irq, struct irq_desc *desc)\r\n{\r\nunsigned int isa_irq = *(unsigned char *)PCIIACK_BASE;\r\nif (isa_irq < _ISA_IRQ(0) || isa_irq >= _ISA_IRQ(16)) {\r\ndo_bad_IRQ(isa_irq, desc);\r\nreturn;\r\n}\r\ngeneric_handle_irq(isa_irq);\r\n}\r\nvoid __init isa_init_irq(unsigned int host_irq)\r\n{\r\nunsigned int irq;\r\noutb(0x11, PIC_LO);\r\noutb(_ISA_IRQ(0), PIC_MASK_LO);\r\noutb(0x04, PIC_MASK_LO);\r\noutb(0x01, PIC_MASK_LO);\r\noutb(0xf5, PIC_MASK_LO);\r\noutb(0x11, PIC_HI);\r\noutb(_ISA_IRQ(8), PIC_MASK_HI);\r\noutb(0x02, PIC_MASK_HI);\r\noutb(0x01, PIC_MASK_HI);\r\noutb(0xfa, PIC_MASK_HI);\r\noutb(0x0b, PIC_LO);\r\noutb(0x0b, PIC_HI);\r\nif (inb(PIC_MASK_LO) == 0xf5 && inb(PIC_MASK_HI) == 0xfa) {\r\noutb(0xff, PIC_MASK_LO);\r\noutb(0xff, PIC_MASK_HI);\r\n} else {\r\nprintk(KERN_INFO "IRQ: ISA PIC not found\n");\r\nhost_irq = (unsigned int)-1;\r\n}\r\nif (host_irq != (unsigned int)-1) {\r\nfor (irq = _ISA_IRQ(0); irq < _ISA_IRQ(8); irq++) {\r\nirq_set_chip_and_handler(irq, &isa_lo_chip,\r\nhandle_level_irq);\r\nset_irq_flags(irq, IRQF_VALID | IRQF_PROBE);\r\n}\r\nfor (irq = _ISA_IRQ(8); irq < _ISA_IRQ(16); irq++) {\r\nirq_set_chip_and_handler(irq, &isa_hi_chip,\r\nhandle_level_irq);\r\nset_irq_flags(irq, IRQF_VALID | IRQF_PROBE);\r\n}\r\nrequest_resource(&ioport_resource, &pic1_resource);\r\nrequest_resource(&ioport_resource, &pic2_resource);\r\nsetup_irq(IRQ_ISA_CASCADE, &irq_cascade);\r\nirq_set_chained_handler(host_irq, isa_irq_handler);\r\nif (machine_is_netwinder())\r\nset_irq_flags(_ISA_IRQ(11), IRQF_VALID |\r\nIRQF_PROBE | IRQF_NOAUTOEN);\r\n}\r\n}

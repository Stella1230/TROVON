static inline u8 FAN_TO_REG(long rpm, int div)\r\n{\r\nif (rpm == 0)\r\nreturn 0;\r\nreturn clamp_val(1310720 / (rpm * div), 1, 255);\r\n}\r\nstatic inline int vt8231_read_value(struct vt8231_data *data, u8 reg)\r\n{\r\nreturn inb_p(data->addr + reg);\r\n}\r\nstatic inline void vt8231_write_value(struct vt8231_data *data, u8 reg,\r\nu8 value)\r\n{\r\noutb_p(value, data->addr + reg);\r\n}\r\nstatic ssize_t show_in(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *sensor_attr = to_sensor_dev_attr(attr);\r\nint nr = sensor_attr->index;\r\nstruct vt8231_data *data = vt8231_update_device(dev);\r\nreturn sprintf(buf, "%d\n", ((data->in[nr] - 3) * 10000) / 958);\r\n}\r\nstatic ssize_t show_in_min(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *sensor_attr = to_sensor_dev_attr(attr);\r\nint nr = sensor_attr->index;\r\nstruct vt8231_data *data = vt8231_update_device(dev);\r\nreturn sprintf(buf, "%d\n", ((data->in_min[nr] - 3) * 10000) / 958);\r\n}\r\nstatic ssize_t show_in_max(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *sensor_attr = to_sensor_dev_attr(attr);\r\nint nr = sensor_attr->index;\r\nstruct vt8231_data *data = vt8231_update_device(dev);\r\nreturn sprintf(buf, "%d\n", (((data->in_max[nr] - 3) * 10000) / 958));\r\n}\r\nstatic ssize_t set_in_min(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct sensor_device_attribute *sensor_attr = to_sensor_dev_attr(attr);\r\nint nr = sensor_attr->index;\r\nstruct vt8231_data *data = dev_get_drvdata(dev);\r\nunsigned long val;\r\nint err;\r\nerr = kstrtoul(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->in_min[nr] = clamp_val(((val * 958) / 10000) + 3, 0, 255);\r\nvt8231_write_value(data, regvoltmin[nr], data->in_min[nr]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t set_in_max(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct sensor_device_attribute *sensor_attr = to_sensor_dev_attr(attr);\r\nint nr = sensor_attr->index;\r\nstruct vt8231_data *data = dev_get_drvdata(dev);\r\nunsigned long val;\r\nint err;\r\nerr = kstrtoul(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->in_max[nr] = clamp_val(((val * 958) / 10000) + 3, 0, 255);\r\nvt8231_write_value(data, regvoltmax[nr], data->in_max[nr]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_in5(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct vt8231_data *data = vt8231_update_device(dev);\r\nreturn sprintf(buf, "%d\n",\r\n(((data->in[5] - 3) * 10000 * 54) / (958 * 34)));\r\n}\r\nstatic ssize_t show_in5_min(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct vt8231_data *data = vt8231_update_device(dev);\r\nreturn sprintf(buf, "%d\n",\r\n(((data->in_min[5] - 3) * 10000 * 54) / (958 * 34)));\r\n}\r\nstatic ssize_t show_in5_max(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct vt8231_data *data = vt8231_update_device(dev);\r\nreturn sprintf(buf, "%d\n",\r\n(((data->in_max[5] - 3) * 10000 * 54) / (958 * 34)));\r\n}\r\nstatic ssize_t set_in5_min(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct vt8231_data *data = dev_get_drvdata(dev);\r\nunsigned long val;\r\nint err;\r\nerr = kstrtoul(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->in_min[5] = clamp_val(((val * 958 * 34) / (10000 * 54)) + 3,\r\n0, 255);\r\nvt8231_write_value(data, regvoltmin[5], data->in_min[5]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t set_in5_max(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct vt8231_data *data = dev_get_drvdata(dev);\r\nunsigned long val;\r\nint err;\r\nerr = kstrtoul(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->in_max[5] = clamp_val(((val * 958 * 34) / (10000 * 54)) + 3,\r\n0, 255);\r\nvt8231_write_value(data, regvoltmax[5], data->in_max[5]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_temp0(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct vt8231_data *data = vt8231_update_device(dev);\r\nreturn sprintf(buf, "%d\n", data->temp[0] * 250);\r\n}\r\nstatic ssize_t show_temp0_max(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct vt8231_data *data = vt8231_update_device(dev);\r\nreturn sprintf(buf, "%d\n", data->temp_max[0] * 1000);\r\n}\r\nstatic ssize_t show_temp0_min(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct vt8231_data *data = vt8231_update_device(dev);\r\nreturn sprintf(buf, "%d\n", data->temp_min[0] * 1000);\r\n}\r\nstatic ssize_t set_temp0_max(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct vt8231_data *data = dev_get_drvdata(dev);\r\nlong val;\r\nint err;\r\nerr = kstrtol(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->temp_max[0] = clamp_val((val + 500) / 1000, 0, 255);\r\nvt8231_write_value(data, regtempmax[0], data->temp_max[0]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t set_temp0_min(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct vt8231_data *data = dev_get_drvdata(dev);\r\nlong val;\r\nint err;\r\nerr = kstrtol(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->temp_min[0] = clamp_val((val + 500) / 1000, 0, 255);\r\nvt8231_write_value(data, regtempmin[0], data->temp_min[0]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_temp(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *sensor_attr = to_sensor_dev_attr(attr);\r\nint nr = sensor_attr->index;\r\nstruct vt8231_data *data = vt8231_update_device(dev);\r\nreturn sprintf(buf, "%d\n", TEMP_FROM_REG(data->temp[nr]));\r\n}\r\nstatic ssize_t show_temp_max(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *sensor_attr = to_sensor_dev_attr(attr);\r\nint nr = sensor_attr->index;\r\nstruct vt8231_data *data = vt8231_update_device(dev);\r\nreturn sprintf(buf, "%d\n", TEMP_MAXMIN_FROM_REG(data->temp_max[nr]));\r\n}\r\nstatic ssize_t show_temp_min(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *sensor_attr = to_sensor_dev_attr(attr);\r\nint nr = sensor_attr->index;\r\nstruct vt8231_data *data = vt8231_update_device(dev);\r\nreturn sprintf(buf, "%d\n", TEMP_MAXMIN_FROM_REG(data->temp_min[nr]));\r\n}\r\nstatic ssize_t set_temp_max(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct sensor_device_attribute *sensor_attr = to_sensor_dev_attr(attr);\r\nint nr = sensor_attr->index;\r\nstruct vt8231_data *data = dev_get_drvdata(dev);\r\nlong val;\r\nint err;\r\nerr = kstrtol(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->temp_max[nr] = clamp_val(TEMP_MAXMIN_TO_REG(val), 0, 255);\r\nvt8231_write_value(data, regtempmax[nr], data->temp_max[nr]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t set_temp_min(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct sensor_device_attribute *sensor_attr = to_sensor_dev_attr(attr);\r\nint nr = sensor_attr->index;\r\nstruct vt8231_data *data = dev_get_drvdata(dev);\r\nlong val;\r\nint err;\r\nerr = kstrtol(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->temp_min[nr] = clamp_val(TEMP_MAXMIN_TO_REG(val), 0, 255);\r\nvt8231_write_value(data, regtempmin[nr], data->temp_min[nr]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_fan(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *sensor_attr = to_sensor_dev_attr(attr);\r\nint nr = sensor_attr->index;\r\nstruct vt8231_data *data = vt8231_update_device(dev);\r\nreturn sprintf(buf, "%d\n", FAN_FROM_REG(data->fan[nr],\r\nDIV_FROM_REG(data->fan_div[nr])));\r\n}\r\nstatic ssize_t show_fan_min(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *sensor_attr = to_sensor_dev_attr(attr);\r\nint nr = sensor_attr->index;\r\nstruct vt8231_data *data = vt8231_update_device(dev);\r\nreturn sprintf(buf, "%d\n", FAN_FROM_REG(data->fan_min[nr],\r\nDIV_FROM_REG(data->fan_div[nr])));\r\n}\r\nstatic ssize_t show_fan_div(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *sensor_attr = to_sensor_dev_attr(attr);\r\nint nr = sensor_attr->index;\r\nstruct vt8231_data *data = vt8231_update_device(dev);\r\nreturn sprintf(buf, "%d\n", DIV_FROM_REG(data->fan_div[nr]));\r\n}\r\nstatic ssize_t set_fan_min(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct sensor_device_attribute *sensor_attr = to_sensor_dev_attr(attr);\r\nint nr = sensor_attr->index;\r\nstruct vt8231_data *data = dev_get_drvdata(dev);\r\nunsigned long val;\r\nint err;\r\nerr = kstrtoul(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->fan_min[nr] = FAN_TO_REG(val, DIV_FROM_REG(data->fan_div[nr]));\r\nvt8231_write_value(data, VT8231_REG_FAN_MIN(nr), data->fan_min[nr]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t set_fan_div(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct vt8231_data *data = dev_get_drvdata(dev);\r\nstruct sensor_device_attribute *sensor_attr = to_sensor_dev_attr(attr);\r\nunsigned long val;\r\nint nr = sensor_attr->index;\r\nint old = vt8231_read_value(data, VT8231_REG_FANDIV);\r\nlong min = FAN_FROM_REG(data->fan_min[nr],\r\nDIV_FROM_REG(data->fan_div[nr]));\r\nint err;\r\nerr = kstrtoul(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\nswitch (val) {\r\ncase 1:\r\ndata->fan_div[nr] = 0;\r\nbreak;\r\ncase 2:\r\ndata->fan_div[nr] = 1;\r\nbreak;\r\ncase 4:\r\ndata->fan_div[nr] = 2;\r\nbreak;\r\ncase 8:\r\ndata->fan_div[nr] = 3;\r\nbreak;\r\ndefault:\r\ndev_err(dev,\r\n"fan_div value %ld not supported. Choose one of 1, 2, 4 or 8!\n",\r\nval);\r\nmutex_unlock(&data->update_lock);\r\nreturn -EINVAL;\r\n}\r\ndata->fan_min[nr] = FAN_TO_REG(min, DIV_FROM_REG(data->fan_div[nr]));\r\nvt8231_write_value(data, VT8231_REG_FAN_MIN(nr), data->fan_min[nr]);\r\nold = (old & 0x0f) | (data->fan_div[1] << 6) | (data->fan_div[0] << 4);\r\nvt8231_write_value(data, VT8231_REG_FANDIV, old);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_alarms(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct vt8231_data *data = vt8231_update_device(dev);\r\nreturn sprintf(buf, "%d\n", data->alarms);\r\n}\r\nstatic ssize_t show_alarm(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nint bitnr = to_sensor_dev_attr(attr)->index;\r\nstruct vt8231_data *data = vt8231_update_device(dev);\r\nreturn sprintf(buf, "%u\n", (data->alarms >> bitnr) & 1);\r\n}\r\nstatic ssize_t show_name(struct device *dev, struct device_attribute\r\n*devattr, char *buf)\r\n{\r\nstruct vt8231_data *data = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%s\n", data->name);\r\n}\r\nstatic int vt8231_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nstruct vt8231_data *data;\r\nint err = 0, i;\r\nres = platform_get_resource(pdev, IORESOURCE_IO, 0);\r\nif (!devm_request_region(&pdev->dev, res->start, VT8231_EXTENT,\r\nvt8231_driver.driver.name)) {\r\ndev_err(&pdev->dev, "Region 0x%lx-0x%lx already in use!\n",\r\n(unsigned long)res->start, (unsigned long)res->end);\r\nreturn -ENODEV;\r\n}\r\ndata = devm_kzalloc(&pdev->dev, sizeof(struct vt8231_data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, data);\r\ndata->addr = res->start;\r\ndata->name = "vt8231";\r\nmutex_init(&data->update_lock);\r\nvt8231_init_device(data);\r\nerr = sysfs_create_group(&pdev->dev.kobj, &vt8231_group);\r\nif (err)\r\nreturn err;\r\ndata->uch_config = vt8231_read_value(data, VT8231_REG_UCH_CONFIG);\r\nfor (i = 0; i < ARRAY_SIZE(vt8231_group_temps); i++) {\r\nif (ISTEMP(i, data->uch_config)) {\r\nerr = sysfs_create_group(&pdev->dev.kobj,\r\n&vt8231_group_temps[i]);\r\nif (err)\r\ngoto exit_remove_files;\r\n}\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(vt8231_group_volts); i++) {\r\nif (ISVOLT(i, data->uch_config)) {\r\nerr = sysfs_create_group(&pdev->dev.kobj,\r\n&vt8231_group_volts[i]);\r\nif (err)\r\ngoto exit_remove_files;\r\n}\r\n}\r\ndata->hwmon_dev = hwmon_device_register(&pdev->dev);\r\nif (IS_ERR(data->hwmon_dev)) {\r\nerr = PTR_ERR(data->hwmon_dev);\r\ngoto exit_remove_files;\r\n}\r\nreturn 0;\r\nexit_remove_files:\r\nfor (i = 0; i < ARRAY_SIZE(vt8231_group_volts); i++)\r\nsysfs_remove_group(&pdev->dev.kobj, &vt8231_group_volts[i]);\r\nfor (i = 0; i < ARRAY_SIZE(vt8231_group_temps); i++)\r\nsysfs_remove_group(&pdev->dev.kobj, &vt8231_group_temps[i]);\r\nsysfs_remove_group(&pdev->dev.kobj, &vt8231_group);\r\nreturn err;\r\n}\r\nstatic int vt8231_remove(struct platform_device *pdev)\r\n{\r\nstruct vt8231_data *data = platform_get_drvdata(pdev);\r\nint i;\r\nhwmon_device_unregister(data->hwmon_dev);\r\nfor (i = 0; i < ARRAY_SIZE(vt8231_group_volts); i++)\r\nsysfs_remove_group(&pdev->dev.kobj, &vt8231_group_volts[i]);\r\nfor (i = 0; i < ARRAY_SIZE(vt8231_group_temps); i++)\r\nsysfs_remove_group(&pdev->dev.kobj, &vt8231_group_temps[i]);\r\nsysfs_remove_group(&pdev->dev.kobj, &vt8231_group);\r\nreturn 0;\r\n}\r\nstatic void vt8231_init_device(struct vt8231_data *data)\r\n{\r\nvt8231_write_value(data, VT8231_REG_TEMP1_CONFIG, 0);\r\nvt8231_write_value(data, VT8231_REG_TEMP2_CONFIG, 0);\r\n}\r\nstatic struct vt8231_data *vt8231_update_device(struct device *dev)\r\n{\r\nstruct vt8231_data *data = dev_get_drvdata(dev);\r\nint i;\r\nu16 low;\r\nmutex_lock(&data->update_lock);\r\nif (time_after(jiffies, data->last_updated + HZ + HZ / 2)\r\n|| !data->valid) {\r\nfor (i = 0; i < 6; i++) {\r\nif (ISVOLT(i, data->uch_config)) {\r\ndata->in[i] = vt8231_read_value(data,\r\nregvolt[i]);\r\ndata->in_min[i] = vt8231_read_value(data,\r\nregvoltmin[i]);\r\ndata->in_max[i] = vt8231_read_value(data,\r\nregvoltmax[i]);\r\n}\r\n}\r\nfor (i = 0; i < 2; i++) {\r\ndata->fan[i] = vt8231_read_value(data,\r\nVT8231_REG_FAN(i));\r\ndata->fan_min[i] = vt8231_read_value(data,\r\nVT8231_REG_FAN_MIN(i));\r\n}\r\nlow = vt8231_read_value(data, VT8231_REG_TEMP_LOW01);\r\nlow = (low >> 6) | ((low & 0x30) >> 2)\r\n| (vt8231_read_value(data, VT8231_REG_TEMP_LOW25) << 4);\r\nfor (i = 0; i < 6; i++) {\r\nif (ISTEMP(i, data->uch_config)) {\r\ndata->temp[i] = (vt8231_read_value(data,\r\nregtemp[i]) << 2)\r\n| ((low >> (2 * i)) & 0x03);\r\ndata->temp_max[i] = vt8231_read_value(data,\r\nregtempmax[i]);\r\ndata->temp_min[i] = vt8231_read_value(data,\r\nregtempmin[i]);\r\n}\r\n}\r\ni = vt8231_read_value(data, VT8231_REG_FANDIV);\r\ndata->fan_div[0] = (i >> 4) & 0x03;\r\ndata->fan_div[1] = i >> 6;\r\ndata->alarms = vt8231_read_value(data, VT8231_REG_ALARM1) |\r\n(vt8231_read_value(data, VT8231_REG_ALARM2) << 8);\r\nif (!data->fan[0] && data->fan_min[0])\r\ndata->alarms |= 0x40;\r\nelse if (data->fan[0] && !data->fan_min[0])\r\ndata->alarms &= ~0x40;\r\nif (!data->fan[1] && data->fan_min[1])\r\ndata->alarms |= 0x80;\r\nelse if (data->fan[1] && !data->fan_min[1])\r\ndata->alarms &= ~0x80;\r\ndata->last_updated = jiffies;\r\ndata->valid = 1;\r\n}\r\nmutex_unlock(&data->update_lock);\r\nreturn data;\r\n}\r\nstatic int vt8231_device_add(unsigned short address)\r\n{\r\nstruct resource res = {\r\n.start = address,\r\n.end = address + VT8231_EXTENT - 1,\r\n.name = "vt8231",\r\n.flags = IORESOURCE_IO,\r\n};\r\nint err;\r\nerr = acpi_check_resource_conflict(&res);\r\nif (err)\r\ngoto exit;\r\npdev = platform_device_alloc("vt8231", address);\r\nif (!pdev) {\r\nerr = -ENOMEM;\r\npr_err("Device allocation failed\n");\r\ngoto exit;\r\n}\r\nerr = platform_device_add_resources(pdev, &res, 1);\r\nif (err) {\r\npr_err("Device resource addition failed (%d)\n", err);\r\ngoto exit_device_put;\r\n}\r\nerr = platform_device_add(pdev);\r\nif (err) {\r\npr_err("Device addition failed (%d)\n", err);\r\ngoto exit_device_put;\r\n}\r\nreturn 0;\r\nexit_device_put:\r\nplatform_device_put(pdev);\r\nexit:\r\nreturn err;\r\n}\r\nstatic int vt8231_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *id)\r\n{\r\nu16 address, val;\r\nif (force_addr) {\r\naddress = force_addr & 0xff00;\r\ndev_warn(&dev->dev, "Forcing ISA address 0x%x\n",\r\naddress);\r\nif (PCIBIOS_SUCCESSFUL !=\r\npci_write_config_word(dev, VT8231_BASE_REG, address | 1))\r\nreturn -ENODEV;\r\n}\r\nif (PCIBIOS_SUCCESSFUL != pci_read_config_word(dev, VT8231_BASE_REG,\r\n&val))\r\nreturn -ENODEV;\r\naddress = val & ~(VT8231_EXTENT - 1);\r\nif (address == 0) {\r\ndev_err(&dev->dev, "base address not set - upgrade BIOS or use force_addr=0xaddr\n");\r\nreturn -ENODEV;\r\n}\r\nif (PCIBIOS_SUCCESSFUL != pci_read_config_word(dev, VT8231_ENABLE_REG,\r\n&val))\r\nreturn -ENODEV;\r\nif (!(val & 0x0001)) {\r\ndev_warn(&dev->dev, "enabling sensors\n");\r\nif (PCIBIOS_SUCCESSFUL !=\r\npci_write_config_word(dev, VT8231_ENABLE_REG,\r\nval | 0x0001))\r\nreturn -ENODEV;\r\n}\r\nif (platform_driver_register(&vt8231_driver))\r\ngoto exit;\r\nif (vt8231_device_add(address))\r\ngoto exit_unregister;\r\ns_bridge = pci_dev_get(dev);\r\nreturn -ENODEV;\r\nexit_unregister:\r\nplatform_driver_unregister(&vt8231_driver);\r\nexit:\r\nreturn -ENODEV;\r\n}\r\nstatic int __init sm_vt8231_init(void)\r\n{\r\nreturn pci_register_driver(&vt8231_pci_driver);\r\n}\r\nstatic void __exit sm_vt8231_exit(void)\r\n{\r\npci_unregister_driver(&vt8231_pci_driver);\r\nif (s_bridge != NULL) {\r\nplatform_device_unregister(pdev);\r\nplatform_driver_unregister(&vt8231_driver);\r\npci_dev_put(s_bridge);\r\ns_bridge = NULL;\r\n}\r\n}

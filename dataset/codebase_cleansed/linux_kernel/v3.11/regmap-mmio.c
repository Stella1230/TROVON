static int regmap_mmio_gather_write(void *context,\r\nconst void *reg, size_t reg_size,\r\nconst void *val, size_t val_size)\r\n{\r\nstruct regmap_mmio_context *ctx = context;\r\nu32 offset;\r\nint ret;\r\nBUG_ON(reg_size != 4);\r\nif (ctx->clk) {\r\nret = clk_enable(ctx->clk);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\noffset = *(u32 *)reg;\r\nwhile (val_size) {\r\nswitch (ctx->val_bytes) {\r\ncase 1:\r\nwriteb(*(u8 *)val, ctx->regs + offset);\r\nbreak;\r\ncase 2:\r\nwritew(*(u16 *)val, ctx->regs + offset);\r\nbreak;\r\ncase 4:\r\nwritel(*(u32 *)val, ctx->regs + offset);\r\nbreak;\r\n#ifdef CONFIG_64BIT\r\ncase 8:\r\nwriteq(*(u64 *)val, ctx->regs + offset);\r\nbreak;\r\n#endif\r\ndefault:\r\nBUG();\r\n}\r\nval_size -= ctx->val_bytes;\r\nval += ctx->val_bytes;\r\noffset += ctx->val_bytes;\r\n}\r\nif (ctx->clk)\r\nclk_disable(ctx->clk);\r\nreturn 0;\r\n}\r\nstatic int regmap_mmio_write(void *context, const void *data, size_t count)\r\n{\r\nBUG_ON(count < 4);\r\nreturn regmap_mmio_gather_write(context, data, 4, data + 4, count - 4);\r\n}\r\nstatic int regmap_mmio_read(void *context,\r\nconst void *reg, size_t reg_size,\r\nvoid *val, size_t val_size)\r\n{\r\nstruct regmap_mmio_context *ctx = context;\r\nu32 offset;\r\nint ret;\r\nBUG_ON(reg_size != 4);\r\nif (ctx->clk) {\r\nret = clk_enable(ctx->clk);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\noffset = *(u32 *)reg;\r\nwhile (val_size) {\r\nswitch (ctx->val_bytes) {\r\ncase 1:\r\n*(u8 *)val = readb(ctx->regs + offset);\r\nbreak;\r\ncase 2:\r\n*(u16 *)val = readw(ctx->regs + offset);\r\nbreak;\r\ncase 4:\r\n*(u32 *)val = readl(ctx->regs + offset);\r\nbreak;\r\n#ifdef CONFIG_64BIT\r\ncase 8:\r\n*(u64 *)val = readq(ctx->regs + offset);\r\nbreak;\r\n#endif\r\ndefault:\r\nBUG();\r\n}\r\nval_size -= ctx->val_bytes;\r\nval += ctx->val_bytes;\r\noffset += ctx->val_bytes;\r\n}\r\nif (ctx->clk)\r\nclk_disable(ctx->clk);\r\nreturn 0;\r\n}\r\nstatic void regmap_mmio_free_context(void *context)\r\n{\r\nstruct regmap_mmio_context *ctx = context;\r\nif (ctx->clk) {\r\nclk_unprepare(ctx->clk);\r\nclk_put(ctx->clk);\r\n}\r\nkfree(context);\r\n}\r\nstatic struct regmap_mmio_context *regmap_mmio_gen_context(struct device *dev,\r\nconst char *clk_id,\r\nvoid __iomem *regs,\r\nconst struct regmap_config *config)\r\n{\r\nstruct regmap_mmio_context *ctx;\r\nint min_stride;\r\nint ret;\r\nif (config->reg_bits != 32)\r\nreturn ERR_PTR(-EINVAL);\r\nif (config->pad_bits)\r\nreturn ERR_PTR(-EINVAL);\r\nswitch (config->val_bits) {\r\ncase 8:\r\nmin_stride = 0;\r\nbreak;\r\ncase 16:\r\nmin_stride = 2;\r\nbreak;\r\ncase 32:\r\nmin_stride = 4;\r\nbreak;\r\n#ifdef CONFIG_64BIT\r\ncase 64:\r\nmin_stride = 8;\r\nbreak;\r\n#endif\r\nbreak;\r\ndefault:\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nif (config->reg_stride < min_stride)\r\nreturn ERR_PTR(-EINVAL);\r\nswitch (config->reg_format_endian) {\r\ncase REGMAP_ENDIAN_DEFAULT:\r\ncase REGMAP_ENDIAN_NATIVE:\r\nbreak;\r\ndefault:\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nctx = kzalloc(sizeof(*ctx), GFP_KERNEL);\r\nif (!ctx)\r\nreturn ERR_PTR(-ENOMEM);\r\nctx->regs = regs;\r\nctx->val_bytes = config->val_bits / 8;\r\nif (clk_id == NULL)\r\nreturn ctx;\r\nctx->clk = clk_get(dev, clk_id);\r\nif (IS_ERR(ctx->clk)) {\r\nret = PTR_ERR(ctx->clk);\r\ngoto err_free;\r\n}\r\nret = clk_prepare(ctx->clk);\r\nif (ret < 0) {\r\nclk_put(ctx->clk);\r\ngoto err_free;\r\n}\r\nreturn ctx;\r\nerr_free:\r\nkfree(ctx);\r\nreturn ERR_PTR(ret);\r\n}\r\nstruct regmap *regmap_init_mmio_clk(struct device *dev, const char *clk_id,\r\nvoid __iomem *regs,\r\nconst struct regmap_config *config)\r\n{\r\nstruct regmap_mmio_context *ctx;\r\nctx = regmap_mmio_gen_context(dev, clk_id, regs, config);\r\nif (IS_ERR(ctx))\r\nreturn ERR_CAST(ctx);\r\nreturn regmap_init(dev, &regmap_mmio, ctx, config);\r\n}\r\nstruct regmap *devm_regmap_init_mmio_clk(struct device *dev, const char *clk_id,\r\nvoid __iomem *regs,\r\nconst struct regmap_config *config)\r\n{\r\nstruct regmap_mmio_context *ctx;\r\nctx = regmap_mmio_gen_context(dev, clk_id, regs, config);\r\nif (IS_ERR(ctx))\r\nreturn ERR_CAST(ctx);\r\nreturn devm_regmap_init(dev, &regmap_mmio, ctx, config);\r\n}

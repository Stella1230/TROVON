u16 qm_mulu16(u16 op1, u16 op2)\r\n{\r\nreturn (u16) (((u32) op1 * (u32) op2) >> 16);\r\n}\r\ns16 qm_muls16(s16 op1, s16 op2)\r\n{\r\ns32 result;\r\nif (op1 == (s16) 0x8000 && op2 == (s16) 0x8000)\r\nresult = 0x7fffffff;\r\nelse\r\nresult = ((s32) (op1) * (s32) (op2));\r\nreturn (s16) (result >> 15);\r\n}\r\ns32 qm_add32(s32 op1, s32 op2)\r\n{\r\ns32 result;\r\nresult = op1 + op2;\r\nif (op1 < 0 && op2 < 0 && result > 0)\r\nresult = 0x80000000;\r\nelse if (op1 > 0 && op2 > 0 && result < 0)\r\nresult = 0x7fffffff;\r\nreturn result;\r\n}\r\ns16 qm_add16(s16 op1, s16 op2)\r\n{\r\ns16 result;\r\ns32 temp = (s32) op1 + (s32) op2;\r\nif (temp > (s32) 0x7fff)\r\nresult = (s16) 0x7fff;\r\nelse if (temp < (s32) 0xffff8000)\r\nresult = (s16) 0xffff8000;\r\nelse\r\nresult = (s16) temp;\r\nreturn result;\r\n}\r\ns16 qm_sub16(s16 op1, s16 op2)\r\n{\r\ns16 result;\r\ns32 temp = (s32) op1 - (s32) op2;\r\nif (temp > (s32) 0x7fff)\r\nresult = (s16) 0x7fff;\r\nelse if (temp < (s32) 0xffff8000)\r\nresult = (s16) 0xffff8000;\r\nelse\r\nresult = (s16) temp;\r\nreturn result;\r\n}\r\ns32 qm_shl32(s32 op, int shift)\r\n{\r\nint i;\r\ns32 result;\r\nresult = op;\r\nif (shift > 31)\r\nshift = 31;\r\nelse if (shift < -31)\r\nshift = -31;\r\nif (shift >= 0) {\r\nfor (i = 0; i < shift; i++)\r\nresult = qm_add32(result, result);\r\n} else {\r\nresult = result >> (-shift);\r\n}\r\nreturn result;\r\n}\r\ns16 qm_shl16(s16 op, int shift)\r\n{\r\nint i;\r\ns16 result;\r\nresult = op;\r\nif (shift > 15)\r\nshift = 15;\r\nelse if (shift < -15)\r\nshift = -15;\r\nif (shift > 0) {\r\nfor (i = 0; i < shift; i++)\r\nresult = qm_add16(result, result);\r\n} else {\r\nresult = result >> (-shift);\r\n}\r\nreturn result;\r\n}\r\ns16 qm_shr16(s16 op, int shift)\r\n{\r\nreturn qm_shl16(op, -shift);\r\n}\r\ns16 qm_norm32(s32 op)\r\n{\r\nu16 u16extraSignBits;\r\nif (op == 0) {\r\nreturn 31;\r\n} else {\r\nu16extraSignBits = 0;\r\nwhile ((op >> 31) == (op >> 30)) {\r\nu16extraSignBits++;\r\nop = op << 1;\r\n}\r\n}\r\nreturn u16extraSignBits;\r\n}\r\nvoid qm_log10(s32 N, s16 qN, s16 *log10N, s16 *qLog10N)\r\n{\r\ns16 s16norm, s16tableIndex, s16errorApproximation;\r\nu16 u16offset;\r\ns32 s32log;\r\ns16norm = qm_norm32(N);\r\nN = N << s16norm;\r\nqN = qN + s16norm - 30;\r\ns16tableIndex = (s16) (N >> (32 - (2 + LOG2_LOG_TABLE_SIZE)));\r\ns16tableIndex =\r\ns16tableIndex & (s16) ((1 << LOG2_LOG_TABLE_SIZE) - 1);\r\nN = N & ((1 << (32 - (2 + LOG2_LOG_TABLE_SIZE))) - 1);\r\nu16offset = (u16) (N >> (32 - (2 + LOG2_LOG_TABLE_SIZE + 16)));\r\ns32log = log_table[s16tableIndex];\r\ns16errorApproximation = (s16) qm_mulu16(u16offset,\r\n(u16) (log_table[s16tableIndex + 1] -\r\nlog_table[s16tableIndex]));\r\ns32log = qm_add16((s16) s32log, s16errorApproximation);\r\ns32log = qm_add32(s32log, ((s32) -qN) << 15);\r\ns16norm = qm_norm32(s32log);\r\ns32log = qm_shl32(s32log, s16norm - 16);\r\n*log10N = qm_muls16((s16) s32log, (s16) LOG10_2);\r\n*qLog10N = 15 + s16norm - 16 + 1;\r\nreturn;\r\n}

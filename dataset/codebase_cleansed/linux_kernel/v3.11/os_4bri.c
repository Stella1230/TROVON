static int _4bri_is_rev_2_card(int card_ordinal)\r\n{\r\nswitch (card_ordinal) {\r\ncase CARDTYPE_DIVASRV_Q_8M_V2_PCI:\r\ncase CARDTYPE_DIVASRV_VOICE_Q_8M_V2_PCI:\r\ncase CARDTYPE_DIVASRV_B_2M_V2_PCI:\r\ncase CARDTYPE_DIVASRV_B_2F_PCI:\r\ncase CARDTYPE_DIVASRV_VOICE_B_2M_V2_PCI:\r\nreturn (1);\r\n}\r\nreturn (0);\r\n}\r\nstatic int _4bri_is_rev_2_bri_card(int card_ordinal)\r\n{\r\nswitch (card_ordinal) {\r\ncase CARDTYPE_DIVASRV_B_2M_V2_PCI:\r\ncase CARDTYPE_DIVASRV_B_2F_PCI:\r\ncase CARDTYPE_DIVASRV_VOICE_B_2M_V2_PCI:\r\nreturn (1);\r\n}\r\nreturn (0);\r\n}\r\nstatic void diva_4bri_set_addresses(diva_os_xdi_adapter_t *a)\r\n{\r\ndword offset = a->resources.pci.qoffset;\r\ndword c_offset = offset * a->xdi_adapter.ControllerNumber;\r\na->resources.pci.mem_type_id[MEM_TYPE_RAM] = 2;\r\na->resources.pci.mem_type_id[MEM_TYPE_ADDRESS] = 2;\r\na->resources.pci.mem_type_id[MEM_TYPE_CONTROL] = 2;\r\na->resources.pci.mem_type_id[MEM_TYPE_RESET] = 0;\r\na->resources.pci.mem_type_id[MEM_TYPE_CTLREG] = 3;\r\na->resources.pci.mem_type_id[MEM_TYPE_PROM] = 0;\r\na->xdi_adapter.Address = a->resources.pci.addr[2];\r\na->xdi_adapter.Address += c_offset;\r\na->xdi_adapter.Control = a->resources.pci.addr[2];\r\na->xdi_adapter.ram = a->resources.pci.addr[2];\r\na->xdi_adapter.ram += c_offset + (offset - MQ_SHARED_RAM_SIZE);\r\na->xdi_adapter.reset = a->resources.pci.addr[0];\r\na->xdi_adapter.ctlReg = a->resources.pci.addr[3];\r\na->xdi_adapter.prom = &a->xdi_adapter.reset[0x6E];\r\n}\r\nint diva_4bri_init_card(diva_os_xdi_adapter_t *a)\r\n{\r\nint bar, i;\r\nbyte __iomem *p;\r\nPADAPTER_LIST_ENTRY quadro_list;\r\ndiva_os_xdi_adapter_t *diva_current;\r\ndiva_os_xdi_adapter_t *adapter_list[4];\r\nPISDN_ADAPTER Slave;\r\nunsigned long bar_length[ARRAY_SIZE(_4bri_bar_length)];\r\nint v2 = _4bri_is_rev_2_card(a->CardOrdinal);\r\nint tasks = _4bri_is_rev_2_bri_card(a->CardOrdinal) ? 1 : MQ_INSTANCE_COUNT;\r\nint factor = (tasks == 1) ? 1 : 2;\r\nif (v2) {\r\nif (_4bri_is_rev_2_bri_card(a->CardOrdinal)) {\r\nmemcpy(bar_length, _4bri_v2_bri_bar_length,\r\nsizeof(bar_length));\r\n} else {\r\nmemcpy(bar_length, _4bri_v2_bar_length,\r\nsizeof(bar_length));\r\n}\r\n} else {\r\nmemcpy(bar_length, _4bri_bar_length, sizeof(bar_length));\r\n}\r\nDBG_TRC(("SDRAM_LENGTH=%08x, tasks=%d, factor=%d",\r\nbar_length[2], tasks, factor))\r\nif (!_4bri_get_serial_number(a)) {\r\nDBG_ERR(("A: 4BRI can't get Serial Number"))\r\ndiva_4bri_cleanup_adapter(a);\r\nreturn (-1);\r\n}\r\na->xdi_adapter.Properties = CardProperties[a->CardOrdinal];\r\nDBG_LOG(("Load %s, SN:%ld, bus:%02x, func:%02x",\r\na->xdi_adapter.Properties.Name,\r\na->xdi_adapter.serialNo,\r\na->resources.pci.bus, a->resources.pci.func))\r\nfor (bar = 0; bar < 4; bar++) {\r\na->resources.pci.bar[bar] =\r\ndivasa_get_pci_bar(a->resources.pci.bus,\r\na->resources.pci.func, bar,\r\na->resources.pci.hdev);\r\nif (!a->resources.pci.bar[bar]\r\n|| (a->resources.pci.bar[bar] == 0xFFFFFFF0)) {\r\nDBG_ERR(\r\n("A: invalid bar[%d]=%08x", bar,\r\na->resources.pci.bar[bar]))\r\nreturn (-1);\r\n}\r\n}\r\na->resources.pci.irq =\r\n(byte) divasa_get_pci_irq(a->resources.pci.bus,\r\na->resources.pci.func,\r\na->resources.pci.hdev);\r\nif (!a->resources.pci.irq) {\r\nDBG_ERR(("A: invalid irq"));\r\nreturn (-1);\r\n}\r\na->xdi_adapter.sdram_bar = a->resources.pci.bar[2];\r\nfor (bar = 0; bar < 4; bar++) {\r\nif (bar != 1) {\r\na->resources.pci.addr[bar] =\r\ndivasa_remap_pci_bar(a, bar, a->resources.pci.bar[bar],\r\nbar_length[bar]);\r\nif (!a->resources.pci.addr[bar]) {\r\nDBG_ERR(("A: 4BRI: can't map bar[%d]", bar))\r\ndiva_4bri_cleanup_adapter(a);\r\nreturn (-1);\r\n}\r\n}\r\n}\r\nsprintf(&a->port_name[0], "DIVA 4BRI %ld", (long) a->xdi_adapter.serialNo);\r\nif (diva_os_register_io_port(a, 1, a->resources.pci.bar[1],\r\nbar_length[1], &a->port_name[0], 1)) {\r\nDBG_ERR(("A: 4BRI: can't register bar[1]"))\r\ndiva_4bri_cleanup_adapter(a);\r\nreturn (-1);\r\n}\r\na->resources.pci.addr[1] =\r\n(void *) (unsigned long) a->resources.pci.bar[1];\r\na->interface.cleanup_adapter_proc = diva_4bri_cleanup_adapter;\r\nif (tasks > 1) {\r\nif (!(a->slave_adapters[0] =\r\n(diva_os_xdi_adapter_t *) diva_os_malloc(0, sizeof(*a))))\r\n{\r\ndiva_4bri_cleanup_adapter(a);\r\nreturn (-1);\r\n}\r\nif (!(a->slave_adapters[1] =\r\n(diva_os_xdi_adapter_t *) diva_os_malloc(0, sizeof(*a))))\r\n{\r\ndiva_os_free(0, a->slave_adapters[0]);\r\na->slave_adapters[0] = NULL;\r\ndiva_4bri_cleanup_adapter(a);\r\nreturn (-1);\r\n}\r\nif (!(a->slave_adapters[2] =\r\n(diva_os_xdi_adapter_t *) diva_os_malloc(0, sizeof(*a))))\r\n{\r\ndiva_os_free(0, a->slave_adapters[0]);\r\ndiva_os_free(0, a->slave_adapters[1]);\r\na->slave_adapters[0] = NULL;\r\na->slave_adapters[1] = NULL;\r\ndiva_4bri_cleanup_adapter(a);\r\nreturn (-1);\r\n}\r\nmemset(a->slave_adapters[0], 0x00, sizeof(*a));\r\nmemset(a->slave_adapters[1], 0x00, sizeof(*a));\r\nmemset(a->slave_adapters[2], 0x00, sizeof(*a));\r\n}\r\nadapter_list[0] = a;\r\nadapter_list[1] = a->slave_adapters[0];\r\nadapter_list[2] = a->slave_adapters[1];\r\nadapter_list[3] = a->slave_adapters[2];\r\nquadro_list =\r\n(PADAPTER_LIST_ENTRY) diva_os_malloc(0, sizeof(*quadro_list));\r\nif (!(a->slave_list = quadro_list)) {\r\nfor (i = 0; i < (tasks - 1); i++) {\r\ndiva_os_free(0, a->slave_adapters[i]);\r\na->slave_adapters[i] = NULL;\r\n}\r\ndiva_4bri_cleanup_adapter(a);\r\nreturn (-1);\r\n}\r\nmemset(quadro_list, 0x00, sizeof(*quadro_list));\r\na->xdi_adapter.QuadroList = quadro_list;\r\nfor (i = 0; i < tasks; i++) {\r\nadapter_list[i]->xdi_adapter.ControllerNumber = i;\r\nadapter_list[i]->xdi_adapter.tasks = tasks;\r\nquadro_list->QuadroAdapter[i] =\r\n&adapter_list[i]->xdi_adapter;\r\n}\r\nfor (i = 0; i < tasks; i++) {\r\ndiva_current = adapter_list[i];\r\ndiva_current->dsp_mask = 0x00000003;\r\ndiva_current->xdi_adapter.a.io =\r\n&diva_current->xdi_adapter;\r\ndiva_current->xdi_adapter.DIRequest = request;\r\ndiva_current->interface.cmd_proc = diva_4bri_cmd_card_proc;\r\ndiva_current->xdi_adapter.Properties =\r\nCardProperties[a->CardOrdinal];\r\ndiva_current->CardOrdinal = a->CardOrdinal;\r\ndiva_current->xdi_adapter.Channels =\r\nCardProperties[a->CardOrdinal].Channels;\r\ndiva_current->xdi_adapter.e_max =\r\nCardProperties[a->CardOrdinal].E_info;\r\ndiva_current->xdi_adapter.e_tbl =\r\ndiva_os_malloc(0,\r\ndiva_current->xdi_adapter.e_max *\r\nsizeof(E_INFO));\r\nif (!diva_current->xdi_adapter.e_tbl) {\r\ndiva_4bri_cleanup_slave_adapters(a);\r\ndiva_4bri_cleanup_adapter(a);\r\nfor (i = 1; i < (tasks - 1); i++) {\r\ndiva_os_free(0, adapter_list[i]);\r\n}\r\nreturn (-1);\r\n}\r\nmemset(diva_current->xdi_adapter.e_tbl, 0x00,\r\ndiva_current->xdi_adapter.e_max * sizeof(E_INFO));\r\nif (diva_os_initialize_spin_lock(&diva_current->xdi_adapter.isr_spin_lock, "isr")) {\r\ndiva_4bri_cleanup_slave_adapters(a);\r\ndiva_4bri_cleanup_adapter(a);\r\nfor (i = 1; i < (tasks - 1); i++) {\r\ndiva_os_free(0, adapter_list[i]);\r\n}\r\nreturn (-1);\r\n}\r\nif (diva_os_initialize_spin_lock(&diva_current->xdi_adapter.data_spin_lock, "data")) {\r\ndiva_4bri_cleanup_slave_adapters(a);\r\ndiva_4bri_cleanup_adapter(a);\r\nfor (i = 1; i < (tasks - 1); i++) {\r\ndiva_os_free(0, adapter_list[i]);\r\n}\r\nreturn (-1);\r\n}\r\nstrcpy(diva_current->xdi_adapter.req_soft_isr. dpc_thread_name, "kdivas4brid");\r\nif (diva_os_initialize_soft_isr(&diva_current->xdi_adapter.req_soft_isr, DIDpcRoutine,\r\n&diva_current->xdi_adapter)) {\r\ndiva_4bri_cleanup_slave_adapters(a);\r\ndiva_4bri_cleanup_adapter(a);\r\nfor (i = 1; i < (tasks - 1); i++) {\r\ndiva_os_free(0, adapter_list[i]);\r\n}\r\nreturn (-1);\r\n}\r\ndiva_current->xdi_adapter.isr_soft_isr.object =\r\ndiva_current->xdi_adapter.req_soft_isr.object;\r\n}\r\nif (v2) {\r\nprepare_qBri2_functions(&a->xdi_adapter);\r\n} else {\r\nprepare_qBri_functions(&a->xdi_adapter);\r\n}\r\nfor (i = 0; i < tasks; i++) {\r\ndiva_current = adapter_list[i];\r\nif (i)\r\nmemcpy(&diva_current->resources, &a->resources, sizeof(divas_card_resources_t));\r\ndiva_current->resources.pci.qoffset = (a->xdi_adapter.MemorySize >> factor);\r\n}\r\na->xdi_adapter.cfg = (void *) (unsigned long) a->resources.pci.bar[0];\r\na->xdi_adapter.port = (void *) (unsigned long) a->resources.pci.bar[1];\r\na->xdi_adapter.ctlReg = (void *) (unsigned long) a->resources.pci.bar[3];\r\nfor (i = 0; i < tasks; i++) {\r\ndiva_current = adapter_list[i];\r\ndiva_4bri_set_addresses(diva_current);\r\nSlave = a->xdi_adapter.QuadroList->QuadroAdapter[i];\r\nSlave->MultiMaster = &a->xdi_adapter;\r\nSlave->sdram_bar = a->xdi_adapter.sdram_bar;\r\nif (i) {\r\nSlave->serialNo = ((dword) (Slave->ControllerNumber << 24)) |\r\na->xdi_adapter.serialNo;\r\nSlave->cardType = a->xdi_adapter.cardType;\r\n}\r\n}\r\np = DIVA_OS_MEM_ATTACH_RESET(&a->xdi_adapter);\r\nWRITE_BYTE(&p[PLX9054_INTCSR], 0x00);\r\nDIVA_OS_MEM_DETACH_RESET(&a->xdi_adapter, p);\r\na->xdi_adapter.irq_info.irq_nr = a->resources.pci.irq;\r\nsprintf(a->xdi_adapter.irq_info.irq_name, "DIVA 4BRI %ld",\r\n(long) a->xdi_adapter.serialNo);\r\nif (diva_os_register_irq(a, a->xdi_adapter.irq_info.irq_nr,\r\na->xdi_adapter.irq_info.irq_name)) {\r\ndiva_4bri_cleanup_slave_adapters(a);\r\ndiva_4bri_cleanup_adapter(a);\r\nfor (i = 1; i < (tasks - 1); i++) {\r\ndiva_os_free(0, adapter_list[i]);\r\n}\r\nreturn (-1);\r\n}\r\na->xdi_adapter.irq_info.registered = 1;\r\nif (tasks > 1) {\r\ndiva_add_slave_adapter(adapter_list[1]);\r\ndiva_add_slave_adapter(adapter_list[2]);\r\ndiva_add_slave_adapter(adapter_list[3]);\r\n}\r\ndiva_log_info("%s IRQ:%d SerNo:%d", a->xdi_adapter.Properties.Name,\r\na->resources.pci.irq, a->xdi_adapter.serialNo);\r\nreturn (0);\r\n}\r\nstatic int diva_4bri_cleanup_adapter(diva_os_xdi_adapter_t *a)\r\n{\r\nint bar;\r\nif (a->xdi_adapter.Initialized) {\r\ndiva_4bri_stop_adapter(a);\r\n}\r\nif (a->xdi_adapter.irq_info.registered) {\r\ndiva_os_remove_irq(a, a->xdi_adapter.irq_info.irq_nr);\r\n}\r\na->xdi_adapter.irq_info.registered = 0;\r\ndiva_4bri_cleanup_slave_adapters(a);\r\nfor (bar = 0; bar < 4; bar++) {\r\nif (bar != 1) {\r\nif (a->resources.pci.bar[bar]\r\n&& a->resources.pci.addr[bar]) {\r\ndivasa_unmap_pci_bar(a->resources.pci.addr[bar]);\r\na->resources.pci.bar[bar] = 0;\r\na->resources.pci.addr[bar] = NULL;\r\n}\r\n}\r\n}\r\nif (a->resources.pci.bar[1] && a->resources.pci.addr[1]) {\r\ndiva_os_register_io_port(a, 0, a->resources.pci.bar[1],\r\n_4bri_is_rev_2_card(a->\r\nCardOrdinal) ?\r\n_4bri_v2_bar_length[1] :\r\n_4bri_bar_length[1],\r\n&a->port_name[0], 1);\r\na->resources.pci.bar[1] = 0;\r\na->resources.pci.addr[1] = NULL;\r\n}\r\nif (a->slave_list) {\r\ndiva_os_free(0, a->slave_list);\r\na->slave_list = NULL;\r\n}\r\nreturn (0);\r\n}\r\nstatic int _4bri_get_serial_number(diva_os_xdi_adapter_t *a)\r\n{\r\ndword data[64];\r\ndword serNo;\r\nword addr, status, i, j;\r\nbyte Bus, Slot;\r\nvoid *hdev;\r\nBus = a->resources.pci.bus;\r\nSlot = a->resources.pci.func;\r\nhdev = a->resources.pci.hdev;\r\nfor (i = 0; i < 64; ++i) {\r\naddr = i * 4;\r\nfor (j = 0; j < 5; ++j) {\r\nPCIwrite(Bus, Slot, 0x4E, &addr, sizeof(addr),\r\nhdev);\r\ndiva_os_wait(1);\r\nPCIread(Bus, Slot, 0x4E, &status, sizeof(status),\r\nhdev);\r\nif (status & 0x8000)\r\nbreak;\r\n}\r\nif (j >= 5) {\r\nDBG_ERR(("EEPROM[%d] read failed (0x%x)", i * 4, addr))\r\nreturn (0);\r\n}\r\nPCIread(Bus, Slot, 0x50, &data[i], sizeof(data[i]), hdev);\r\n}\r\nDBG_BLK(((char *) &data[0], sizeof(data)))\r\nserNo = data[32];\r\nif (serNo == 0 || serNo == 0xffffffff)\r\nserNo = data[63];\r\nif (!serNo) {\r\nDBG_LOG(("W: Serial Number == 0, create one serial number"));\r\nserNo = a->resources.pci.bar[1] & 0xffff0000;\r\nserNo |= a->resources.pci.bus << 8;\r\nserNo |= a->resources.pci.func;\r\n}\r\na->xdi_adapter.serialNo = serNo;\r\nDBG_REG(("Serial No. : %ld", a->xdi_adapter.serialNo))\r\nreturn (serNo);\r\n}\r\nstatic int diva_4bri_cleanup_slave_adapters(diva_os_xdi_adapter_t *a)\r\n{\r\ndiva_os_xdi_adapter_t *adapter_list[4];\r\ndiva_os_xdi_adapter_t *diva_current;\r\nint i;\r\nadapter_list[0] = a;\r\nadapter_list[1] = a->slave_adapters[0];\r\nadapter_list[2] = a->slave_adapters[1];\r\nadapter_list[3] = a->slave_adapters[2];\r\nfor (i = 0; i < a->xdi_adapter.tasks; i++) {\r\ndiva_current = adapter_list[i];\r\nif (diva_current) {\r\ndiva_os_destroy_spin_lock(&diva_current->\r\nxdi_adapter.\r\nisr_spin_lock, "unload");\r\ndiva_os_destroy_spin_lock(&diva_current->\r\nxdi_adapter.\r\ndata_spin_lock,\r\n"unload");\r\ndiva_os_cancel_soft_isr(&diva_current->xdi_adapter.\r\nreq_soft_isr);\r\ndiva_os_cancel_soft_isr(&diva_current->xdi_adapter.\r\nisr_soft_isr);\r\ndiva_os_remove_soft_isr(&diva_current->xdi_adapter.\r\nreq_soft_isr);\r\ndiva_current->xdi_adapter.isr_soft_isr.object = NULL;\r\nif (diva_current->xdi_adapter.e_tbl) {\r\ndiva_os_free(0,\r\ndiva_current->xdi_adapter.\r\ne_tbl);\r\n}\r\ndiva_current->xdi_adapter.e_tbl = NULL;\r\ndiva_current->xdi_adapter.e_max = 0;\r\ndiva_current->xdi_adapter.e_count = 0;\r\n}\r\n}\r\nreturn (0);\r\n}\r\nstatic int\r\ndiva_4bri_cmd_card_proc(struct _diva_os_xdi_adapter *a,\r\ndiva_xdi_um_cfg_cmd_t *cmd, int length)\r\n{\r\nint ret = -1;\r\nif (cmd->adapter != a->controller) {\r\nDBG_ERR(("A: 4bri_cmd, invalid controller=%d != %d",\r\ncmd->adapter, a->controller))\r\nreturn (-1);\r\n}\r\nswitch (cmd->command) {\r\ncase DIVA_XDI_UM_CMD_GET_CARD_ORDINAL:\r\na->xdi_mbox.data_length = sizeof(dword);\r\na->xdi_mbox.data =\r\ndiva_os_malloc(0, a->xdi_mbox.data_length);\r\nif (a->xdi_mbox.data) {\r\n*(dword *) a->xdi_mbox.data =\r\n(dword) a->CardOrdinal;\r\na->xdi_mbox.status = DIVA_XDI_MBOX_BUSY;\r\nret = 0;\r\n}\r\nbreak;\r\ncase DIVA_XDI_UM_CMD_GET_SERIAL_NR:\r\na->xdi_mbox.data_length = sizeof(dword);\r\na->xdi_mbox.data =\r\ndiva_os_malloc(0, a->xdi_mbox.data_length);\r\nif (a->xdi_mbox.data) {\r\n*(dword *) a->xdi_mbox.data =\r\n(dword) a->xdi_adapter.serialNo;\r\na->xdi_mbox.status = DIVA_XDI_MBOX_BUSY;\r\nret = 0;\r\n}\r\nbreak;\r\ncase DIVA_XDI_UM_CMD_GET_PCI_HW_CONFIG:\r\nif (!a->xdi_adapter.ControllerNumber) {\r\na->xdi_mbox.data_length = sizeof(dword) * 9;\r\na->xdi_mbox.data =\r\ndiva_os_malloc(0, a->xdi_mbox.data_length);\r\nif (a->xdi_mbox.data) {\r\nint i;\r\ndword *data = (dword *) a->xdi_mbox.data;\r\nfor (i = 0; i < 8; i++) {\r\n*data++ = a->resources.pci.bar[i];\r\n}\r\n*data++ = (dword) a->resources.pci.irq;\r\na->xdi_mbox.status = DIVA_XDI_MBOX_BUSY;\r\nret = 0;\r\n}\r\n}\r\nbreak;\r\ncase DIVA_XDI_UM_CMD_GET_CARD_STATE:\r\nif (!a->xdi_adapter.ControllerNumber) {\r\na->xdi_mbox.data_length = sizeof(dword);\r\na->xdi_mbox.data =\r\ndiva_os_malloc(0, a->xdi_mbox.data_length);\r\nif (a->xdi_mbox.data) {\r\ndword *data = (dword *) a->xdi_mbox.data;\r\nif (!a->xdi_adapter.ram\r\n|| !a->xdi_adapter.reset\r\n|| !a->xdi_adapter.cfg) {\r\n*data = 3;\r\n} else if (a->xdi_adapter.trapped) {\r\n*data = 2;\r\n} else if (a->xdi_adapter.Initialized) {\r\n*data = 1;\r\n} else {\r\n*data = 0;\r\n}\r\na->xdi_mbox.status = DIVA_XDI_MBOX_BUSY;\r\nret = 0;\r\n}\r\n}\r\nbreak;\r\ncase DIVA_XDI_UM_CMD_WRITE_FPGA:\r\nif (!a->xdi_adapter.ControllerNumber) {\r\nret =\r\ndiva_4bri_write_fpga_image(a,\r\n(byte *)&cmd[1],\r\ncmd->command_data.\r\nwrite_fpga.\r\nimage_length);\r\n}\r\nbreak;\r\ncase DIVA_XDI_UM_CMD_RESET_ADAPTER:\r\nif (!a->xdi_adapter.ControllerNumber) {\r\nret = diva_4bri_reset_adapter(&a->xdi_adapter);\r\n}\r\nbreak;\r\ncase DIVA_XDI_UM_CMD_WRITE_SDRAM_BLOCK:\r\nif (!a->xdi_adapter.ControllerNumber) {\r\nret = diva_4bri_write_sdram_block(&a->xdi_adapter,\r\ncmd->\r\ncommand_data.\r\nwrite_sdram.\r\noffset,\r\n(byte *) &\r\ncmd[1],\r\ncmd->\r\ncommand_data.\r\nwrite_sdram.\r\nlength,\r\na->xdi_adapter.\r\nMemorySize);\r\n}\r\nbreak;\r\ncase DIVA_XDI_UM_CMD_START_ADAPTER:\r\nif (!a->xdi_adapter.ControllerNumber) {\r\nret = diva_4bri_start_adapter(&a->xdi_adapter,\r\ncmd->command_data.\r\nstart.offset,\r\ncmd->command_data.\r\nstart.features);\r\n}\r\nbreak;\r\ncase DIVA_XDI_UM_CMD_SET_PROTOCOL_FEATURES:\r\nif (!a->xdi_adapter.ControllerNumber) {\r\na->xdi_adapter.features =\r\ncmd->command_data.features.features;\r\na->xdi_adapter.a.protocol_capabilities =\r\na->xdi_adapter.features;\r\nDBG_TRC(("Set raw protocol features (%08x)",\r\na->xdi_adapter.features))\r\nret = 0;\r\n}\r\nbreak;\r\ncase DIVA_XDI_UM_CMD_STOP_ADAPTER:\r\nif (!a->xdi_adapter.ControllerNumber) {\r\nret = diva_4bri_stop_adapter(a);\r\n}\r\nbreak;\r\ncase DIVA_XDI_UM_CMD_READ_XLOG_ENTRY:\r\nret = diva_card_read_xlog(a);\r\nbreak;\r\ncase DIVA_XDI_UM_CMD_READ_SDRAM:\r\nif (!a->xdi_adapter.ControllerNumber\r\n&& a->xdi_adapter.Address) {\r\nif (\r\n(a->xdi_mbox.data_length =\r\ncmd->command_data.read_sdram.length)) {\r\nif (\r\n(a->xdi_mbox.data_length +\r\ncmd->command_data.read_sdram.offset) <\r\na->xdi_adapter.MemorySize) {\r\na->xdi_mbox.data =\r\ndiva_os_malloc(0,\r\na->xdi_mbox.\r\ndata_length);\r\nif (a->xdi_mbox.data) {\r\nbyte __iomem *p = DIVA_OS_MEM_ATTACH_ADDRESS(&a->xdi_adapter);\r\nbyte __iomem *src = p;\r\nbyte *dst = a->xdi_mbox.data;\r\ndword len = a->xdi_mbox.data_length;\r\nsrc += cmd->command_data.read_sdram.offset;\r\nwhile (len--) {\r\n*dst++ = READ_BYTE(src++);\r\n}\r\nDIVA_OS_MEM_DETACH_ADDRESS(&a->xdi_adapter, p);\r\na->xdi_mbox.status = DIVA_XDI_MBOX_BUSY;\r\nret = 0;\r\n}\r\n}\r\n}\r\n}\r\nbreak;\r\ndefault:\r\nDBG_ERR(("A: A(%d) invalid cmd=%d", a->controller,\r\ncmd->command))\r\n}\r\nreturn (ret);\r\n}\r\nvoid *xdiLoadFile(char *FileName, dword *FileLength,\r\nunsigned long lim)\r\n{\r\nvoid *ret = diva_xdiLoadFileFile;\r\nif (FileLength) {\r\n*FileLength = diva_xdiLoadFileLength;\r\n}\r\ndiva_xdiLoadFileFile = NULL;\r\ndiva_xdiLoadFileLength = 0;\r\nreturn (ret);\r\n}\r\nvoid diva_os_set_qBri_functions(PISDN_ADAPTER IoAdapter)\r\n{\r\n}\r\nvoid diva_os_set_qBri2_functions(PISDN_ADAPTER IoAdapter)\r\n{\r\n}\r\nstatic int\r\ndiva_4bri_write_fpga_image(diva_os_xdi_adapter_t *a, byte *data,\r\ndword length)\r\n{\r\nint ret;\r\ndiva_xdiLoadFileFile = data;\r\ndiva_xdiLoadFileLength = length;\r\nret = qBri_FPGA_download(&a->xdi_adapter);\r\ndiva_xdiLoadFileFile = NULL;\r\ndiva_xdiLoadFileLength = 0;\r\nreturn (ret ? 0 : -1);\r\n}\r\nstatic int diva_4bri_reset_adapter(PISDN_ADAPTER IoAdapter)\r\n{\r\nPISDN_ADAPTER Slave;\r\nint i;\r\nif (!IoAdapter->Address || !IoAdapter->reset) {\r\nreturn (-1);\r\n}\r\nif (IoAdapter->Initialized) {\r\nDBG_ERR(("A: A(%d) can't reset 4BRI adapter - please stop first",\r\nIoAdapter->ANum))\r\nreturn (-1);\r\n}\r\nfor (i = 0; ((i < IoAdapter->tasks) && IoAdapter->QuadroList); i++) {\r\nSlave = IoAdapter->QuadroList->QuadroAdapter[i];\r\nSlave->e_count = 0;\r\nif (Slave->e_tbl) {\r\nmemset(Slave->e_tbl, 0x00,\r\nSlave->e_max * sizeof(E_INFO));\r\n}\r\nSlave->head = 0;\r\nSlave->tail = 0;\r\nSlave->assign = 0;\r\nSlave->trapped = 0;\r\nmemset(&Slave->a.IdTable[0], 0x00,\r\nsizeof(Slave->a.IdTable));\r\nmemset(&Slave->a.IdTypeTable[0], 0x00,\r\nsizeof(Slave->a.IdTypeTable));\r\nmemset(&Slave->a.FlowControlIdTable[0], 0x00,\r\nsizeof(Slave->a.FlowControlIdTable));\r\nmemset(&Slave->a.FlowControlSkipTable[0], 0x00,\r\nsizeof(Slave->a.FlowControlSkipTable));\r\nmemset(&Slave->a.misc_flags_table[0], 0x00,\r\nsizeof(Slave->a.misc_flags_table));\r\nmemset(&Slave->a.rx_stream[0], 0x00,\r\nsizeof(Slave->a.rx_stream));\r\nmemset(&Slave->a.tx_stream[0], 0x00,\r\nsizeof(Slave->a.tx_stream));\r\nmemset(&Slave->a.tx_pos[0], 0x00, sizeof(Slave->a.tx_pos));\r\nmemset(&Slave->a.rx_pos[0], 0x00, sizeof(Slave->a.rx_pos));\r\n}\r\nreturn (0);\r\n}\r\nstatic int\r\ndiva_4bri_write_sdram_block(PISDN_ADAPTER IoAdapter,\r\ndword address,\r\nconst byte *data, dword length, dword limit)\r\n{\r\nbyte __iomem *p = DIVA_OS_MEM_ATTACH_ADDRESS(IoAdapter);\r\nbyte __iomem *mem = p;\r\nif (((address + length) >= limit) || !mem) {\r\nDIVA_OS_MEM_DETACH_ADDRESS(IoAdapter, p);\r\nDBG_ERR(("A: A(%d) write 4BRI address=0x%08lx",\r\nIoAdapter->ANum, address + length))\r\nreturn (-1);\r\n}\r\nmem += address;\r\nwhile (length--) {\r\nWRITE_BYTE(mem++, *data++);\r\n}\r\nDIVA_OS_MEM_DETACH_ADDRESS(IoAdapter, p);\r\nreturn (0);\r\n}\r\nstatic int\r\ndiva_4bri_start_adapter(PISDN_ADAPTER IoAdapter,\r\ndword start_address, dword features)\r\n{\r\nvolatile word __iomem *signature;\r\nint started = 0;\r\nint i;\r\nbyte __iomem *p;\r\nstart_qBri_hardware(IoAdapter);\r\np = DIVA_OS_MEM_ATTACH_RAM(IoAdapter);\r\nsignature = (volatile word __iomem *) (&p[0x1E]);\r\nfor (i = 0; i < 300; ++i) {\r\ndiva_os_wait(10);\r\nif (READ_WORD(&signature[0]) == 0x4447) {\r\nDBG_TRC(("Protocol startup time %d.%02d seconds",\r\n(i / 100), (i % 100)))\r\nstarted = 1;\r\nbreak;\r\n}\r\n}\r\nfor (i = 1; i < IoAdapter->tasks; i++) {\r\nIoAdapter->QuadroList->QuadroAdapter[i]->features =\r\nIoAdapter->features;\r\nIoAdapter->QuadroList->QuadroAdapter[i]->a.\r\nprotocol_capabilities = IoAdapter->features;\r\n}\r\nif (!started) {\r\nDBG_FTL(("%s: Adapter selftest failed, signature=%04x",\r\nIoAdapter->Properties.Name,\r\nREAD_WORD(&signature[0])))\r\nDIVA_OS_MEM_DETACH_RAM(IoAdapter, p);\r\n(*(IoAdapter->trapFnc)) (IoAdapter);\r\nIoAdapter->stop(IoAdapter);\r\nreturn (-1);\r\n}\r\nDIVA_OS_MEM_DETACH_RAM(IoAdapter, p);\r\nfor (i = 0; i < IoAdapter->tasks; i++) {\r\nIoAdapter->QuadroList->QuadroAdapter[i]->Initialized = 1;\r\nIoAdapter->QuadroList->QuadroAdapter[i]->IrqCount = 0;\r\n}\r\nif (check_qBri_interrupt(IoAdapter)) {\r\nDBG_ERR(("A: A(%d) interrupt test failed",\r\nIoAdapter->ANum))\r\nfor (i = 0; i < IoAdapter->tasks; i++) {\r\nIoAdapter->QuadroList->QuadroAdapter[i]->Initialized = 0;\r\n}\r\nIoAdapter->stop(IoAdapter);\r\nreturn (-1);\r\n}\r\nIoAdapter->Properties.Features = (word) features;\r\ndiva_xdi_display_adapter_features(IoAdapter->ANum);\r\nfor (i = 0; i < IoAdapter->tasks; i++) {\r\nDBG_LOG(("A(%d) %s adapter successfully started",\r\nIoAdapter->QuadroList->QuadroAdapter[i]->ANum,\r\n(IoAdapter->tasks == 1) ? "BRI 2.0" : "4BRI"))\r\ndiva_xdi_didd_register_adapter(IoAdapter->QuadroList->QuadroAdapter[i]->ANum);\r\nIoAdapter->QuadroList->QuadroAdapter[i]->Properties.Features = (word) features;\r\n}\r\nreturn (0);\r\n}\r\nstatic int check_qBri_interrupt(PISDN_ADAPTER IoAdapter)\r\n{\r\n#ifdef SUPPORT_INTERRUPT_TEST_ON_4BRI\r\nint i;\r\nADAPTER *a = &IoAdapter->a;\r\nbyte __iomem *p;\r\nIoAdapter->IrqCount = 0;\r\nif (IoAdapter->ControllerNumber > 0)\r\nreturn (-1);\r\np = DIVA_OS_MEM_ATTACH_RESET(IoAdapter);\r\nWRITE_BYTE(&p[PLX9054_INTCSR], PLX9054_INT_ENABLE);\r\nDIVA_OS_MEM_DETACH_RESET(IoAdapter, p);\r\na->ReadyInt = 1;\r\na->ram_out(a, &PR_RAM->ReadyInt, 1);\r\nfor (i = 100; !IoAdapter->IrqCount && (i-- > 0); diva_os_wait(10));\r\nreturn ((IoAdapter->IrqCount > 0) ? 0 : -1);\r\n#else\r\ndword volatile __iomem *qBriIrq;\r\nbyte __iomem *p;\r\nIoAdapter->IrqCount = 0;\r\np = DIVA_OS_MEM_ATTACH_CTLREG(IoAdapter);\r\nqBriIrq = (dword volatile __iomem *) (&p[_4bri_is_rev_2_card\r\n(IoAdapter->\r\ncardType) ? (MQ2_BREG_IRQ_TEST)\r\n: (MQ_BREG_IRQ_TEST)]);\r\nWRITE_DWORD(qBriIrq, MQ_IRQ_REQ_OFF);\r\nDIVA_OS_MEM_DETACH_CTLREG(IoAdapter, p);\r\np = DIVA_OS_MEM_ATTACH_RESET(IoAdapter);\r\nWRITE_BYTE(&p[PLX9054_INTCSR], PLX9054_INT_ENABLE);\r\nDIVA_OS_MEM_DETACH_RESET(IoAdapter, p);\r\ndiva_os_wait(100);\r\nreturn (0);\r\n#endif\r\n}\r\nstatic void diva_4bri_clear_interrupts(diva_os_xdi_adapter_t *a)\r\n{\r\nPISDN_ADAPTER IoAdapter = &a->xdi_adapter;\r\nIoAdapter->disIrq(IoAdapter);\r\nIoAdapter->tst_irq(&IoAdapter->a);\r\nIoAdapter->clr_irq(&IoAdapter->a);\r\nIoAdapter->tst_irq(&IoAdapter->a);\r\ndiva_os_cancel_soft_isr(&IoAdapter->req_soft_isr);\r\ndiva_os_cancel_soft_isr(&IoAdapter->isr_soft_isr);\r\n}\r\nstatic int diva_4bri_stop_adapter(diva_os_xdi_adapter_t *a)\r\n{\r\nPISDN_ADAPTER IoAdapter = &a->xdi_adapter;\r\nint i;\r\nif (!IoAdapter->ram) {\r\nreturn (-1);\r\n}\r\nif (!IoAdapter->Initialized) {\r\nDBG_ERR(("A: A(%d) can't stop PRI adapter - not running",\r\nIoAdapter->ANum))\r\nreturn (-1);\r\n}\r\nfor (i = 0; i < IoAdapter->tasks; i++) {\r\nIoAdapter->QuadroList->QuadroAdapter[i]->Initialized = 0;\r\n}\r\nfor (i = 0; i < IoAdapter->tasks; i++) {\r\ndiva_xdi_didd_remove_adapter(IoAdapter->QuadroList->QuadroAdapter[i]->ANum);\r\n}\r\ni = 100;\r\na->clear_interrupts_proc = diva_4bri_clear_interrupts;\r\nIoAdapter->a.ReadyInt = 1;\r\nIoAdapter->a.ram_inc(&IoAdapter->a, &PR_RAM->ReadyInt);\r\ndo {\r\ndiva_os_sleep(10);\r\n} while (i-- && a->clear_interrupts_proc);\r\nif (a->clear_interrupts_proc) {\r\ndiva_4bri_clear_interrupts(a);\r\na->clear_interrupts_proc = NULL;\r\nDBG_ERR(("A: A(%d) no final interrupt from 4BRI adapter",\r\nIoAdapter->ANum))\r\n}\r\nIoAdapter->a.ReadyInt = 0;\r\nIoAdapter->stop(IoAdapter);\r\nreturn (0);\r\n}

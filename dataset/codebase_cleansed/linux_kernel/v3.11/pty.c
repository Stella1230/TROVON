static void *pty_chan_init(char *str, int device, const struct chan_opts *opts)\r\n{\r\nstruct pty_chan *data;\r\ndata = uml_kmalloc(sizeof(*data), UM_GFP_KERNEL);\r\nif (data == NULL)\r\nreturn NULL;\r\n*data = ((struct pty_chan) { .announce = opts->announce,\r\n.dev = device,\r\n.raw = opts->raw });\r\nreturn data;\r\n}\r\nstatic int pts_open(int input, int output, int primary, void *d,\r\nchar **dev_out)\r\n{\r\nstruct pty_chan *data = d;\r\nchar *dev;\r\nint fd, err;\r\nfd = get_pty();\r\nif (fd < 0) {\r\nerr = -errno;\r\nprintk(UM_KERN_ERR "open_pts : Failed to open pts\n");\r\nreturn err;\r\n}\r\nif (data->raw) {\r\nCATCH_EINTR(err = tcgetattr(fd, &data->tt));\r\nif (err)\r\ngoto out_close;\r\nerr = raw(fd);\r\nif (err)\r\ngoto out_close;\r\n}\r\ndev = ptsname(fd);\r\nsprintf(data->dev_name, "%s", dev);\r\n*dev_out = data->dev_name;\r\nif (data->announce)\r\n(*data->announce)(dev, data->dev);\r\nreturn fd;\r\nout_close:\r\nclose(fd);\r\nreturn err;\r\n}\r\nstatic int getmaster(char *line)\r\n{\r\nstruct stat buf;\r\nchar *pty, *bank, *cp;\r\nint master, err;\r\npty = &line[strlen("/dev/ptyp")];\r\nfor (bank = "pqrs"; *bank; bank++) {\r\nline[strlen("/dev/pty")] = *bank;\r\n*pty = '0';\r\nif ((stat(line, &buf) < 0) && (errno == ENOENT))\r\nbreak;\r\nfor (cp = "0123456789abcdef"; *cp; cp++) {\r\n*pty = *cp;\r\nmaster = open(line, O_RDWR);\r\nif (master >= 0) {\r\nchar *tp = &line[strlen("/dev/")];\r\n*tp = 't';\r\nerr = access(line, R_OK | W_OK);\r\n*tp = 'p';\r\nif (!err)\r\nreturn master;\r\nclose(master);\r\n}\r\n}\r\n}\r\nprintk(UM_KERN_ERR "getmaster - no usable host pty devices\n");\r\nreturn -ENOENT;\r\n}\r\nstatic int pty_open(int input, int output, int primary, void *d,\r\nchar **dev_out)\r\n{\r\nstruct pty_chan *data = d;\r\nint fd, err;\r\nchar dev[sizeof("/dev/ptyxx\0")] = "/dev/ptyxx";\r\nfd = getmaster(dev);\r\nif (fd < 0)\r\nreturn fd;\r\nif (data->raw) {\r\nerr = raw(fd);\r\nif (err) {\r\nclose(fd);\r\nreturn err;\r\n}\r\n}\r\nif (data->announce)\r\n(*data->announce)(dev, data->dev);\r\nsprintf(data->dev_name, "%s", dev);\r\n*dev_out = data->dev_name;\r\nreturn fd;\r\n}

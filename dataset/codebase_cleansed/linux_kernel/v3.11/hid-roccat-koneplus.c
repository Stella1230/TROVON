static void koneplus_profile_activated(struct koneplus_device *koneplus,\r\nuint new_profile)\r\n{\r\nkoneplus->actual_profile = new_profile;\r\n}\r\nstatic int koneplus_send_control(struct usb_device *usb_dev, uint value,\r\nenum koneplus_control_requests request)\r\n{\r\nstruct roccat_common2_control control;\r\nif ((request == KONEPLUS_CONTROL_REQUEST_PROFILE_SETTINGS ||\r\nrequest == KONEPLUS_CONTROL_REQUEST_PROFILE_BUTTONS) &&\r\nvalue > 4)\r\nreturn -EINVAL;\r\ncontrol.command = ROCCAT_COMMON_COMMAND_CONTROL;\r\ncontrol.value = value;\r\ncontrol.request = request;\r\nreturn roccat_common2_send_with_status(usb_dev,\r\nROCCAT_COMMON_COMMAND_CONTROL,\r\n&control, sizeof(struct roccat_common2_control));\r\n}\r\nstatic int koneplus_get_actual_profile(struct usb_device *usb_dev)\r\n{\r\nstruct koneplus_actual_profile buf;\r\nint retval;\r\nretval = roccat_common2_receive(usb_dev, KONEPLUS_COMMAND_ACTUAL_PROFILE,\r\n&buf, KONEPLUS_SIZE_ACTUAL_PROFILE);\r\nreturn retval ? retval : buf.actual_profile;\r\n}\r\nstatic int koneplus_set_actual_profile(struct usb_device *usb_dev,\r\nint new_profile)\r\n{\r\nstruct koneplus_actual_profile buf;\r\nbuf.command = KONEPLUS_COMMAND_ACTUAL_PROFILE;\r\nbuf.size = KONEPLUS_SIZE_ACTUAL_PROFILE;\r\nbuf.actual_profile = new_profile;\r\nreturn roccat_common2_send_with_status(usb_dev,\r\nKONEPLUS_COMMAND_ACTUAL_PROFILE,\r\n&buf, KONEPLUS_SIZE_ACTUAL_PROFILE);\r\n}\r\nstatic ssize_t koneplus_sysfs_read(struct file *fp, struct kobject *kobj,\r\nchar *buf, loff_t off, size_t count,\r\nsize_t real_size, uint command)\r\n{\r\nstruct device *dev =\r\ncontainer_of(kobj, struct device, kobj)->parent->parent;\r\nstruct koneplus_device *koneplus = hid_get_drvdata(dev_get_drvdata(dev));\r\nstruct usb_device *usb_dev = interface_to_usbdev(to_usb_interface(dev));\r\nint retval;\r\nif (off >= real_size)\r\nreturn 0;\r\nif (off != 0 || count != real_size)\r\nreturn -EINVAL;\r\nmutex_lock(&koneplus->koneplus_lock);\r\nretval = roccat_common2_receive(usb_dev, command, buf, real_size);\r\nmutex_unlock(&koneplus->koneplus_lock);\r\nif (retval)\r\nreturn retval;\r\nreturn real_size;\r\n}\r\nstatic ssize_t koneplus_sysfs_write(struct file *fp, struct kobject *kobj,\r\nvoid const *buf, loff_t off, size_t count,\r\nsize_t real_size, uint command)\r\n{\r\nstruct device *dev =\r\ncontainer_of(kobj, struct device, kobj)->parent->parent;\r\nstruct koneplus_device *koneplus = hid_get_drvdata(dev_get_drvdata(dev));\r\nstruct usb_device *usb_dev = interface_to_usbdev(to_usb_interface(dev));\r\nint retval;\r\nif (off != 0 || count != real_size)\r\nreturn -EINVAL;\r\nmutex_lock(&koneplus->koneplus_lock);\r\nretval = roccat_common2_send_with_status(usb_dev, command,\r\nbuf, real_size);\r\nmutex_unlock(&koneplus->koneplus_lock);\r\nif (retval)\r\nreturn retval;\r\nreturn real_size;\r\n}\r\nstatic ssize_t koneplus_sysfs_read_profilex_settings(struct file *fp,\r\nstruct kobject *kobj, struct bin_attribute *attr, char *buf,\r\nloff_t off, size_t count)\r\n{\r\nstruct device *dev =\r\ncontainer_of(kobj, struct device, kobj)->parent->parent;\r\nstruct usb_device *usb_dev = interface_to_usbdev(to_usb_interface(dev));\r\nssize_t retval;\r\nretval = koneplus_send_control(usb_dev, *(uint *)(attr->private),\r\nKONEPLUS_CONTROL_REQUEST_PROFILE_SETTINGS);\r\nif (retval)\r\nreturn retval;\r\nreturn koneplus_sysfs_read(fp, kobj, buf, off, count,\r\nKONEPLUS_SIZE_PROFILE_SETTINGS,\r\nKONEPLUS_COMMAND_PROFILE_SETTINGS);\r\n}\r\nstatic ssize_t koneplus_sysfs_read_profilex_buttons(struct file *fp,\r\nstruct kobject *kobj, struct bin_attribute *attr, char *buf,\r\nloff_t off, size_t count)\r\n{\r\nstruct device *dev =\r\ncontainer_of(kobj, struct device, kobj)->parent->parent;\r\nstruct usb_device *usb_dev = interface_to_usbdev(to_usb_interface(dev));\r\nssize_t retval;\r\nretval = koneplus_send_control(usb_dev, *(uint *)(attr->private),\r\nKONEPLUS_CONTROL_REQUEST_PROFILE_BUTTONS);\r\nif (retval)\r\nreturn retval;\r\nreturn koneplus_sysfs_read(fp, kobj, buf, off, count,\r\nKONEPLUS_SIZE_PROFILE_BUTTONS,\r\nKONEPLUS_COMMAND_PROFILE_BUTTONS);\r\n}\r\nstatic ssize_t koneplus_sysfs_show_actual_profile(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct koneplus_device *koneplus =\r\nhid_get_drvdata(dev_get_drvdata(dev->parent->parent));\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", koneplus->actual_profile);\r\n}\r\nstatic ssize_t koneplus_sysfs_set_actual_profile(struct device *dev,\r\nstruct device_attribute *attr, char const *buf, size_t size)\r\n{\r\nstruct koneplus_device *koneplus;\r\nstruct usb_device *usb_dev;\r\nunsigned long profile;\r\nint retval;\r\nstruct koneplus_roccat_report roccat_report;\r\ndev = dev->parent->parent;\r\nkoneplus = hid_get_drvdata(dev_get_drvdata(dev));\r\nusb_dev = interface_to_usbdev(to_usb_interface(dev));\r\nretval = strict_strtoul(buf, 10, &profile);\r\nif (retval)\r\nreturn retval;\r\nif (profile > 4)\r\nreturn -EINVAL;\r\nmutex_lock(&koneplus->koneplus_lock);\r\nretval = koneplus_set_actual_profile(usb_dev, profile);\r\nif (retval) {\r\nmutex_unlock(&koneplus->koneplus_lock);\r\nreturn retval;\r\n}\r\nkoneplus_profile_activated(koneplus, profile);\r\nroccat_report.type = KONEPLUS_MOUSE_REPORT_BUTTON_TYPE_PROFILE;\r\nroccat_report.data1 = profile + 1;\r\nroccat_report.data2 = 0;\r\nroccat_report.profile = profile + 1;\r\nroccat_report_event(koneplus->chrdev_minor,\r\n(uint8_t const *)&roccat_report);\r\nmutex_unlock(&koneplus->koneplus_lock);\r\nreturn size;\r\n}\r\nstatic ssize_t koneplus_sysfs_show_firmware_version(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct koneplus_device *koneplus;\r\nstruct usb_device *usb_dev;\r\nstruct koneplus_info info;\r\ndev = dev->parent->parent;\r\nkoneplus = hid_get_drvdata(dev_get_drvdata(dev));\r\nusb_dev = interface_to_usbdev(to_usb_interface(dev));\r\nmutex_lock(&koneplus->koneplus_lock);\r\nroccat_common2_receive(usb_dev, KONEPLUS_COMMAND_INFO,\r\n&info, KONEPLUS_SIZE_INFO);\r\nmutex_unlock(&koneplus->koneplus_lock);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", info.firmware_version);\r\n}\r\nstatic int koneplus_init_koneplus_device_struct(struct usb_device *usb_dev,\r\nstruct koneplus_device *koneplus)\r\n{\r\nint retval;\r\nmutex_init(&koneplus->koneplus_lock);\r\nretval = koneplus_get_actual_profile(usb_dev);\r\nif (retval < 0)\r\nreturn retval;\r\nkoneplus_profile_activated(koneplus, retval);\r\nreturn 0;\r\n}\r\nstatic int koneplus_init_specials(struct hid_device *hdev)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\r\nstruct usb_device *usb_dev = interface_to_usbdev(intf);\r\nstruct koneplus_device *koneplus;\r\nint retval;\r\nif (intf->cur_altsetting->desc.bInterfaceProtocol\r\n== USB_INTERFACE_PROTOCOL_MOUSE) {\r\nkoneplus = kzalloc(sizeof(*koneplus), GFP_KERNEL);\r\nif (!koneplus) {\r\nhid_err(hdev, "can't alloc device descriptor\n");\r\nreturn -ENOMEM;\r\n}\r\nhid_set_drvdata(hdev, koneplus);\r\nretval = koneplus_init_koneplus_device_struct(usb_dev, koneplus);\r\nif (retval) {\r\nhid_err(hdev, "couldn't init struct koneplus_device\n");\r\ngoto exit_free;\r\n}\r\nretval = roccat_connect(koneplus_class, hdev,\r\nsizeof(struct koneplus_roccat_report));\r\nif (retval < 0) {\r\nhid_err(hdev, "couldn't init char dev\n");\r\n} else {\r\nkoneplus->chrdev_minor = retval;\r\nkoneplus->roccat_claimed = 1;\r\n}\r\n} else {\r\nhid_set_drvdata(hdev, NULL);\r\n}\r\nreturn 0;\r\nexit_free:\r\nkfree(koneplus);\r\nreturn retval;\r\n}\r\nstatic void koneplus_remove_specials(struct hid_device *hdev)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\r\nstruct koneplus_device *koneplus;\r\nif (intf->cur_altsetting->desc.bInterfaceProtocol\r\n== USB_INTERFACE_PROTOCOL_MOUSE) {\r\nkoneplus = hid_get_drvdata(hdev);\r\nif (koneplus->roccat_claimed)\r\nroccat_disconnect(koneplus->chrdev_minor);\r\nkfree(koneplus);\r\n}\r\n}\r\nstatic int koneplus_probe(struct hid_device *hdev,\r\nconst struct hid_device_id *id)\r\n{\r\nint retval;\r\nretval = hid_parse(hdev);\r\nif (retval) {\r\nhid_err(hdev, "parse failed\n");\r\ngoto exit;\r\n}\r\nretval = hid_hw_start(hdev, HID_CONNECT_DEFAULT);\r\nif (retval) {\r\nhid_err(hdev, "hw start failed\n");\r\ngoto exit;\r\n}\r\nretval = koneplus_init_specials(hdev);\r\nif (retval) {\r\nhid_err(hdev, "couldn't install mouse\n");\r\ngoto exit_stop;\r\n}\r\nreturn 0;\r\nexit_stop:\r\nhid_hw_stop(hdev);\r\nexit:\r\nreturn retval;\r\n}\r\nstatic void koneplus_remove(struct hid_device *hdev)\r\n{\r\nkoneplus_remove_specials(hdev);\r\nhid_hw_stop(hdev);\r\n}\r\nstatic void koneplus_keep_values_up_to_date(struct koneplus_device *koneplus,\r\nu8 const *data)\r\n{\r\nstruct koneplus_mouse_report_button const *button_report;\r\nswitch (data[0]) {\r\ncase KONEPLUS_MOUSE_REPORT_NUMBER_BUTTON:\r\nbutton_report = (struct koneplus_mouse_report_button const *)data;\r\nswitch (button_report->type) {\r\ncase KONEPLUS_MOUSE_REPORT_BUTTON_TYPE_PROFILE:\r\nkoneplus_profile_activated(koneplus, button_report->data1 - 1);\r\nbreak;\r\n}\r\nbreak;\r\n}\r\n}\r\nstatic void koneplus_report_to_chrdev(struct koneplus_device const *koneplus,\r\nu8 const *data)\r\n{\r\nstruct koneplus_roccat_report roccat_report;\r\nstruct koneplus_mouse_report_button const *button_report;\r\nif (data[0] != KONEPLUS_MOUSE_REPORT_NUMBER_BUTTON)\r\nreturn;\r\nbutton_report = (struct koneplus_mouse_report_button const *)data;\r\nif ((button_report->type == KONEPLUS_MOUSE_REPORT_BUTTON_TYPE_QUICKLAUNCH ||\r\nbutton_report->type == KONEPLUS_MOUSE_REPORT_BUTTON_TYPE_TIMER) &&\r\nbutton_report->data2 != KONEPLUS_MOUSE_REPORT_BUTTON_ACTION_PRESS)\r\nreturn;\r\nroccat_report.type = button_report->type;\r\nroccat_report.data1 = button_report->data1;\r\nroccat_report.data2 = button_report->data2;\r\nroccat_report.profile = koneplus->actual_profile + 1;\r\nroccat_report_event(koneplus->chrdev_minor,\r\n(uint8_t const *)&roccat_report);\r\n}\r\nstatic int koneplus_raw_event(struct hid_device *hdev,\r\nstruct hid_report *report, u8 *data, int size)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\r\nstruct koneplus_device *koneplus = hid_get_drvdata(hdev);\r\nif (intf->cur_altsetting->desc.bInterfaceProtocol\r\n!= USB_INTERFACE_PROTOCOL_MOUSE)\r\nreturn 0;\r\nif (koneplus == NULL)\r\nreturn 0;\r\nkoneplus_keep_values_up_to_date(koneplus, data);\r\nif (koneplus->roccat_claimed)\r\nkoneplus_report_to_chrdev(koneplus, data);\r\nreturn 0;\r\n}\r\nstatic int __init koneplus_init(void)\r\n{\r\nint retval;\r\nkoneplus_class = class_create(THIS_MODULE, "koneplus");\r\nif (IS_ERR(koneplus_class))\r\nreturn PTR_ERR(koneplus_class);\r\nkoneplus_class->dev_attrs = koneplus_attributes;\r\nkoneplus_class->dev_bin_attrs = koneplus_bin_attributes;\r\nretval = hid_register_driver(&koneplus_driver);\r\nif (retval)\r\nclass_destroy(koneplus_class);\r\nreturn retval;\r\n}\r\nstatic void __exit koneplus_exit(void)\r\n{\r\nhid_unregister_driver(&koneplus_driver);\r\nclass_destroy(koneplus_class);\r\n}

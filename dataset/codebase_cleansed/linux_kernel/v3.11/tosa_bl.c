static void tosa_bl_set_backlight(struct tosa_bl_data *data, int brightness)\r\n{\r\nstruct spi_device *spi = data->i2c->dev.platform_data;\r\ni2c_smbus_write_byte_data(data->i2c, DAC_CH1, data->comadj);\r\ni2c_smbus_write_byte_data(data->i2c, DAC_CH2, (u8)(brightness & 0xff));\r\ngpio_set_value(TOSA_GPIO_BL_C20MA, brightness & 0x100);\r\ntosa_bl_enable(spi, brightness);\r\n}\r\nstatic int tosa_bl_update_status(struct backlight_device *dev)\r\n{\r\nstruct backlight_properties *props = &dev->props;\r\nstruct tosa_bl_data *data = bl_get_data(dev);\r\nint power = max(props->power, props->fb_blank);\r\nint brightness = props->brightness;\r\nif (power)\r\nbrightness = 0;\r\ntosa_bl_set_backlight(data, brightness);\r\nreturn 0;\r\n}\r\nstatic int tosa_bl_get_brightness(struct backlight_device *dev)\r\n{\r\nstruct backlight_properties *props = &dev->props;\r\nreturn props->brightness;\r\n}\r\nstatic int tosa_bl_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct backlight_properties props;\r\nstruct tosa_bl_data *data;\r\nint ret = 0;\r\ndata = devm_kzalloc(&client->dev, sizeof(struct tosa_bl_data),\r\nGFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\ndata->comadj = sharpsl_param.comadj == -1 ? COMADJ_DEFAULT : sharpsl_param.comadj;\r\nret = devm_gpio_request_one(&client->dev, TOSA_GPIO_BL_C20MA,\r\nGPIOF_OUT_INIT_LOW, "backlight");\r\nif (ret) {\r\ndev_dbg(&data->bl->dev, "Unable to request gpio!\n");\r\nreturn ret;\r\n}\r\ni2c_set_clientdata(client, data);\r\ndata->i2c = client;\r\nmemset(&props, 0, sizeof(struct backlight_properties));\r\nprops.type = BACKLIGHT_RAW;\r\nprops.max_brightness = 512 - 1;\r\ndata->bl = backlight_device_register("tosa-bl", &client->dev, data,\r\n&bl_ops, &props);\r\nif (IS_ERR(data->bl)) {\r\nret = PTR_ERR(data->bl);\r\ngoto err_reg;\r\n}\r\ndata->bl->props.brightness = 69;\r\ndata->bl->props.power = FB_BLANK_UNBLANK;\r\nbacklight_update_status(data->bl);\r\nreturn 0;\r\nerr_reg:\r\ndata->bl = NULL;\r\nreturn ret;\r\n}\r\nstatic int tosa_bl_remove(struct i2c_client *client)\r\n{\r\nstruct tosa_bl_data *data = i2c_get_clientdata(client);\r\nbacklight_device_unregister(data->bl);\r\ndata->bl = NULL;\r\nreturn 0;\r\n}\r\nstatic int tosa_bl_suspend(struct device *dev)\r\n{\r\nstruct tosa_bl_data *data = dev_get_drvdata(dev);\r\ntosa_bl_set_backlight(data, 0);\r\nreturn 0;\r\n}\r\nstatic int tosa_bl_resume(struct device *dev)\r\n{\r\nstruct tosa_bl_data *data = dev_get_drvdata(dev);\r\nbacklight_update_status(data->bl);\r\nreturn 0;\r\n}

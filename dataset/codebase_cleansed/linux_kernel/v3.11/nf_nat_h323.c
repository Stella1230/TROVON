static int set_addr(struct sk_buff *skb, unsigned int protoff,\r\nunsigned char **data, int dataoff,\r\nunsigned int addroff, __be32 ip, __be16 port)\r\n{\r\nenum ip_conntrack_info ctinfo;\r\nstruct nf_conn *ct = nf_ct_get(skb, &ctinfo);\r\nstruct {\r\n__be32 ip;\r\n__be16 port;\r\n} __attribute__ ((__packed__)) buf;\r\nconst struct tcphdr *th;\r\nstruct tcphdr _tcph;\r\nbuf.ip = ip;\r\nbuf.port = port;\r\naddroff += dataoff;\r\nif (ip_hdr(skb)->protocol == IPPROTO_TCP) {\r\nif (!nf_nat_mangle_tcp_packet(skb, ct, ctinfo,\r\nprotoff, addroff, sizeof(buf),\r\n(char *) &buf, sizeof(buf))) {\r\nnet_notice_ratelimited("nf_nat_h323: nf_nat_mangle_tcp_packet error\n");\r\nreturn -1;\r\n}\r\nth = skb_header_pointer(skb, ip_hdrlen(skb),\r\nsizeof(_tcph), &_tcph);\r\nif (th == NULL)\r\nreturn -1;\r\n*data = skb->data + ip_hdrlen(skb) + th->doff * 4 + dataoff;\r\n} else {\r\nif (!nf_nat_mangle_udp_packet(skb, ct, ctinfo,\r\nprotoff, addroff, sizeof(buf),\r\n(char *) &buf, sizeof(buf))) {\r\nnet_notice_ratelimited("nf_nat_h323: nf_nat_mangle_udp_packet error\n");\r\nreturn -1;\r\n}\r\n*data = skb->data + ip_hdrlen(skb) + sizeof(struct udphdr);\r\n}\r\nreturn 0;\r\n}\r\nstatic int set_h225_addr(struct sk_buff *skb, unsigned int protoff,\r\nunsigned char **data, int dataoff,\r\nTransportAddress *taddr,\r\nunion nf_inet_addr *addr, __be16 port)\r\n{\r\nreturn set_addr(skb, protoff, data, dataoff, taddr->ipAddress.ip,\r\naddr->ip, port);\r\n}\r\nstatic int set_h245_addr(struct sk_buff *skb, unsigned protoff,\r\nunsigned char **data, int dataoff,\r\nH245_TransportAddress *taddr,\r\nunion nf_inet_addr *addr, __be16 port)\r\n{\r\nreturn set_addr(skb, protoff, data, dataoff,\r\ntaddr->unicastAddress.iPAddress.network,\r\naddr->ip, port);\r\n}\r\nstatic int set_sig_addr(struct sk_buff *skb, struct nf_conn *ct,\r\nenum ip_conntrack_info ctinfo,\r\nunsigned int protoff, unsigned char **data,\r\nTransportAddress *taddr, int count)\r\n{\r\nconst struct nf_ct_h323_master *info = nfct_help_data(ct);\r\nint dir = CTINFO2DIR(ctinfo);\r\nint i;\r\n__be16 port;\r\nunion nf_inet_addr addr;\r\nfor (i = 0; i < count; i++) {\r\nif (get_h225_addr(ct, *data, &taddr[i], &addr, &port)) {\r\nif (addr.ip == ct->tuplehash[dir].tuple.src.u3.ip &&\r\nport == info->sig_port[dir]) {\r\nif (i > 0 &&\r\nget_h225_addr(ct, *data, &taddr[0],\r\n&addr, &port) &&\r\n(ntohl(addr.ip) & 0xff000000) == 0x7f000000)\r\ni = 0;\r\npr_debug("nf_nat_ras: set signal address %pI4:%hu->%pI4:%hu\n",\r\n&addr.ip, port,\r\n&ct->tuplehash[!dir].tuple.dst.u3.ip,\r\ninfo->sig_port[!dir]);\r\nreturn set_h225_addr(skb, protoff, data, 0,\r\n&taddr[i],\r\n&ct->tuplehash[!dir].\r\ntuple.dst.u3,\r\ninfo->sig_port[!dir]);\r\n} else if (addr.ip == ct->tuplehash[dir].tuple.dst.u3.ip &&\r\nport == info->sig_port[dir]) {\r\npr_debug("nf_nat_ras: set signal address %pI4:%hu->%pI4:%hu\n",\r\n&addr.ip, port,\r\n&ct->tuplehash[!dir].tuple.src.u3.ip,\r\ninfo->sig_port[!dir]);\r\nreturn set_h225_addr(skb, protoff, data, 0,\r\n&taddr[i],\r\n&ct->tuplehash[!dir].\r\ntuple.src.u3,\r\ninfo->sig_port[!dir]);\r\n}\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int set_ras_addr(struct sk_buff *skb, struct nf_conn *ct,\r\nenum ip_conntrack_info ctinfo,\r\nunsigned int protoff, unsigned char **data,\r\nTransportAddress *taddr, int count)\r\n{\r\nint dir = CTINFO2DIR(ctinfo);\r\nint i;\r\n__be16 port;\r\nunion nf_inet_addr addr;\r\nfor (i = 0; i < count; i++) {\r\nif (get_h225_addr(ct, *data, &taddr[i], &addr, &port) &&\r\naddr.ip == ct->tuplehash[dir].tuple.src.u3.ip &&\r\nport == ct->tuplehash[dir].tuple.src.u.udp.port) {\r\npr_debug("nf_nat_ras: set rasAddress %pI4:%hu->%pI4:%hu\n",\r\n&addr.ip, ntohs(port),\r\n&ct->tuplehash[!dir].tuple.dst.u3.ip,\r\nntohs(ct->tuplehash[!dir].tuple.dst.u.udp.port));\r\nreturn set_h225_addr(skb, protoff, data, 0, &taddr[i],\r\n&ct->tuplehash[!dir].tuple.dst.u3,\r\nct->tuplehash[!dir].tuple.\r\ndst.u.udp.port);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int nat_rtp_rtcp(struct sk_buff *skb, struct nf_conn *ct,\r\nenum ip_conntrack_info ctinfo,\r\nunsigned int protoff, unsigned char **data, int dataoff,\r\nH245_TransportAddress *taddr,\r\n__be16 port, __be16 rtp_port,\r\nstruct nf_conntrack_expect *rtp_exp,\r\nstruct nf_conntrack_expect *rtcp_exp)\r\n{\r\nstruct nf_ct_h323_master *info = nfct_help_data(ct);\r\nint dir = CTINFO2DIR(ctinfo);\r\nint i;\r\nu_int16_t nated_port;\r\nrtp_exp->saved_proto.udp.port = rtp_exp->tuple.dst.u.udp.port;\r\nrtp_exp->expectfn = nf_nat_follow_master;\r\nrtp_exp->dir = !dir;\r\nrtcp_exp->saved_proto.udp.port = rtcp_exp->tuple.dst.u.udp.port;\r\nrtcp_exp->expectfn = nf_nat_follow_master;\r\nrtcp_exp->dir = !dir;\r\nfor (i = 0; i < H323_RTP_CHANNEL_MAX; i++) {\r\nif (info->rtp_port[i][dir] == rtp_port) {\r\nrtp_exp->tuple.dst.u.udp.port = info->rtp_port[i][dir];\r\nrtcp_exp->tuple.dst.u.udp.port =\r\nhtons(ntohs(info->rtp_port[i][dir]) + 1);\r\nbreak;\r\n} else if (info->rtp_port[i][dir] == 0) {\r\nbreak;\r\n}\r\n}\r\nif (i >= H323_RTP_CHANNEL_MAX) {\r\nnet_notice_ratelimited("nf_nat_h323: out of expectations\n");\r\nreturn 0;\r\n}\r\nfor (nated_port = ntohs(rtp_exp->tuple.dst.u.udp.port);\r\nnated_port != 0; nated_port += 2) {\r\nint ret;\r\nrtp_exp->tuple.dst.u.udp.port = htons(nated_port);\r\nret = nf_ct_expect_related(rtp_exp);\r\nif (ret == 0) {\r\nrtcp_exp->tuple.dst.u.udp.port =\r\nhtons(nated_port + 1);\r\nret = nf_ct_expect_related(rtcp_exp);\r\nif (ret == 0)\r\nbreak;\r\nelse if (ret != -EBUSY) {\r\nnf_ct_unexpect_related(rtp_exp);\r\nnated_port = 0;\r\nbreak;\r\n}\r\n} else if (ret != -EBUSY) {\r\nnated_port = 0;\r\nbreak;\r\n}\r\n}\r\nif (nated_port == 0) {\r\nnet_notice_ratelimited("nf_nat_h323: out of RTP ports\n");\r\nreturn 0;\r\n}\r\nif (set_h245_addr(skb, protoff, data, dataoff, taddr,\r\n&ct->tuplehash[!dir].tuple.dst.u3,\r\nhtons((port & htons(1)) ? nated_port + 1 :\r\nnated_port)) == 0) {\r\ninfo->rtp_port[i][dir] = rtp_port;\r\ninfo->rtp_port[i][!dir] = htons(nated_port);\r\n} else {\r\nnf_ct_unexpect_related(rtp_exp);\r\nnf_ct_unexpect_related(rtcp_exp);\r\nreturn -1;\r\n}\r\npr_debug("nf_nat_h323: expect RTP %pI4:%hu->%pI4:%hu\n",\r\n&rtp_exp->tuple.src.u3.ip,\r\nntohs(rtp_exp->tuple.src.u.udp.port),\r\n&rtp_exp->tuple.dst.u3.ip,\r\nntohs(rtp_exp->tuple.dst.u.udp.port));\r\npr_debug("nf_nat_h323: expect RTCP %pI4:%hu->%pI4:%hu\n",\r\n&rtcp_exp->tuple.src.u3.ip,\r\nntohs(rtcp_exp->tuple.src.u.udp.port),\r\n&rtcp_exp->tuple.dst.u3.ip,\r\nntohs(rtcp_exp->tuple.dst.u.udp.port));\r\nreturn 0;\r\n}\r\nstatic int nat_t120(struct sk_buff *skb, struct nf_conn *ct,\r\nenum ip_conntrack_info ctinfo,\r\nunsigned int protoff, unsigned char **data, int dataoff,\r\nH245_TransportAddress *taddr, __be16 port,\r\nstruct nf_conntrack_expect *exp)\r\n{\r\nint dir = CTINFO2DIR(ctinfo);\r\nu_int16_t nated_port = ntohs(port);\r\nexp->saved_proto.tcp.port = exp->tuple.dst.u.tcp.port;\r\nexp->expectfn = nf_nat_follow_master;\r\nexp->dir = !dir;\r\nfor (; nated_port != 0; nated_port++) {\r\nint ret;\r\nexp->tuple.dst.u.tcp.port = htons(nated_port);\r\nret = nf_ct_expect_related(exp);\r\nif (ret == 0)\r\nbreak;\r\nelse if (ret != -EBUSY) {\r\nnated_port = 0;\r\nbreak;\r\n}\r\n}\r\nif (nated_port == 0) {\r\nnet_notice_ratelimited("nf_nat_h323: out of TCP ports\n");\r\nreturn 0;\r\n}\r\nif (set_h245_addr(skb, protoff, data, dataoff, taddr,\r\n&ct->tuplehash[!dir].tuple.dst.u3,\r\nhtons(nated_port)) < 0) {\r\nnf_ct_unexpect_related(exp);\r\nreturn -1;\r\n}\r\npr_debug("nf_nat_h323: expect T.120 %pI4:%hu->%pI4:%hu\n",\r\n&exp->tuple.src.u3.ip,\r\nntohs(exp->tuple.src.u.tcp.port),\r\n&exp->tuple.dst.u3.ip,\r\nntohs(exp->tuple.dst.u.tcp.port));\r\nreturn 0;\r\n}\r\nstatic int nat_h245(struct sk_buff *skb, struct nf_conn *ct,\r\nenum ip_conntrack_info ctinfo,\r\nunsigned int protoff, unsigned char **data, int dataoff,\r\nTransportAddress *taddr, __be16 port,\r\nstruct nf_conntrack_expect *exp)\r\n{\r\nstruct nf_ct_h323_master *info = nfct_help_data(ct);\r\nint dir = CTINFO2DIR(ctinfo);\r\nu_int16_t nated_port = ntohs(port);\r\nexp->saved_proto.tcp.port = exp->tuple.dst.u.tcp.port;\r\nexp->expectfn = nf_nat_follow_master;\r\nexp->dir = !dir;\r\nif (info->sig_port[dir] == port)\r\nnated_port = ntohs(info->sig_port[!dir]);\r\nfor (; nated_port != 0; nated_port++) {\r\nint ret;\r\nexp->tuple.dst.u.tcp.port = htons(nated_port);\r\nret = nf_ct_expect_related(exp);\r\nif (ret == 0)\r\nbreak;\r\nelse if (ret != -EBUSY) {\r\nnated_port = 0;\r\nbreak;\r\n}\r\n}\r\nif (nated_port == 0) {\r\nnet_notice_ratelimited("nf_nat_q931: out of TCP ports\n");\r\nreturn 0;\r\n}\r\nif (set_h225_addr(skb, protoff, data, dataoff, taddr,\r\n&ct->tuplehash[!dir].tuple.dst.u3,\r\nhtons(nated_port)) == 0) {\r\ninfo->sig_port[dir] = port;\r\ninfo->sig_port[!dir] = htons(nated_port);\r\n} else {\r\nnf_ct_unexpect_related(exp);\r\nreturn -1;\r\n}\r\npr_debug("nf_nat_q931: expect H.245 %pI4:%hu->%pI4:%hu\n",\r\n&exp->tuple.src.u3.ip,\r\nntohs(exp->tuple.src.u.tcp.port),\r\n&exp->tuple.dst.u3.ip,\r\nntohs(exp->tuple.dst.u.tcp.port));\r\nreturn 0;\r\n}\r\nstatic void ip_nat_q931_expect(struct nf_conn *new,\r\nstruct nf_conntrack_expect *this)\r\n{\r\nstruct nf_nat_range range;\r\nif (this->tuple.src.u3.ip != 0) {\r\nnf_nat_follow_master(new, this);\r\nreturn;\r\n}\r\nBUG_ON(new->status & IPS_NAT_DONE_MASK);\r\nrange.flags = NF_NAT_RANGE_MAP_IPS;\r\nrange.min_addr = range.max_addr =\r\nnew->tuplehash[!this->dir].tuple.src.u3;\r\nnf_nat_setup_info(new, &range, NF_NAT_MANIP_SRC);\r\nrange.flags = (NF_NAT_RANGE_MAP_IPS | NF_NAT_RANGE_PROTO_SPECIFIED);\r\nrange.min_proto = range.max_proto = this->saved_proto;\r\nrange.min_addr = range.max_addr =\r\nnew->master->tuplehash[!this->dir].tuple.src.u3;\r\nnf_nat_setup_info(new, &range, NF_NAT_MANIP_DST);\r\n}\r\nstatic int nat_q931(struct sk_buff *skb, struct nf_conn *ct,\r\nenum ip_conntrack_info ctinfo,\r\nunsigned int protoff, unsigned char **data,\r\nTransportAddress *taddr, int idx,\r\n__be16 port, struct nf_conntrack_expect *exp)\r\n{\r\nstruct nf_ct_h323_master *info = nfct_help_data(ct);\r\nint dir = CTINFO2DIR(ctinfo);\r\nu_int16_t nated_port = ntohs(port);\r\nunion nf_inet_addr addr;\r\nexp->saved_proto.tcp.port = exp->tuple.dst.u.tcp.port;\r\nexp->expectfn = ip_nat_q931_expect;\r\nexp->dir = !dir;\r\nif (info->sig_port[dir] == port)\r\nnated_port = ntohs(info->sig_port[!dir]);\r\nfor (; nated_port != 0; nated_port++) {\r\nint ret;\r\nexp->tuple.dst.u.tcp.port = htons(nated_port);\r\nret = nf_ct_expect_related(exp);\r\nif (ret == 0)\r\nbreak;\r\nelse if (ret != -EBUSY) {\r\nnated_port = 0;\r\nbreak;\r\n}\r\n}\r\nif (nated_port == 0) {\r\nnet_notice_ratelimited("nf_nat_ras: out of TCP ports\n");\r\nreturn 0;\r\n}\r\nif (set_h225_addr(skb, protoff, data, 0, &taddr[idx],\r\n&ct->tuplehash[!dir].tuple.dst.u3,\r\nhtons(nated_port)) == 0) {\r\ninfo->sig_port[dir] = port;\r\ninfo->sig_port[!dir] = htons(nated_port);\r\nif (idx > 0 &&\r\nget_h225_addr(ct, *data, &taddr[0], &addr, &port) &&\r\n(ntohl(addr.ip) & 0xff000000) == 0x7f000000) {\r\nset_h225_addr(skb, protoff, data, 0, &taddr[0],\r\n&ct->tuplehash[!dir].tuple.dst.u3,\r\ninfo->sig_port[!dir]);\r\n}\r\n} else {\r\nnf_ct_unexpect_related(exp);\r\nreturn -1;\r\n}\r\npr_debug("nf_nat_ras: expect Q.931 %pI4:%hu->%pI4:%hu\n",\r\n&exp->tuple.src.u3.ip,\r\nntohs(exp->tuple.src.u.tcp.port),\r\n&exp->tuple.dst.u3.ip,\r\nntohs(exp->tuple.dst.u.tcp.port));\r\nreturn 0;\r\n}\r\nstatic void ip_nat_callforwarding_expect(struct nf_conn *new,\r\nstruct nf_conntrack_expect *this)\r\n{\r\nstruct nf_nat_range range;\r\nBUG_ON(new->status & IPS_NAT_DONE_MASK);\r\nrange.flags = NF_NAT_RANGE_MAP_IPS;\r\nrange.min_addr = range.max_addr =\r\nnew->tuplehash[!this->dir].tuple.src.u3;\r\nnf_nat_setup_info(new, &range, NF_NAT_MANIP_SRC);\r\nrange.flags = (NF_NAT_RANGE_MAP_IPS | NF_NAT_RANGE_PROTO_SPECIFIED);\r\nrange.min_proto = range.max_proto = this->saved_proto;\r\nrange.min_addr = range.max_addr = this->saved_addr;\r\nnf_nat_setup_info(new, &range, NF_NAT_MANIP_DST);\r\n}\r\nstatic int nat_callforwarding(struct sk_buff *skb, struct nf_conn *ct,\r\nenum ip_conntrack_info ctinfo,\r\nunsigned int protoff,\r\nunsigned char **data, int dataoff,\r\nTransportAddress *taddr, __be16 port,\r\nstruct nf_conntrack_expect *exp)\r\n{\r\nint dir = CTINFO2DIR(ctinfo);\r\nu_int16_t nated_port;\r\nexp->saved_addr = exp->tuple.dst.u3;\r\nexp->tuple.dst.u3.ip = ct->tuplehash[!dir].tuple.dst.u3.ip;\r\nexp->saved_proto.tcp.port = exp->tuple.dst.u.tcp.port;\r\nexp->expectfn = ip_nat_callforwarding_expect;\r\nexp->dir = !dir;\r\nfor (nated_port = ntohs(port); nated_port != 0; nated_port++) {\r\nint ret;\r\nexp->tuple.dst.u.tcp.port = htons(nated_port);\r\nret = nf_ct_expect_related(exp);\r\nif (ret == 0)\r\nbreak;\r\nelse if (ret != -EBUSY) {\r\nnated_port = 0;\r\nbreak;\r\n}\r\n}\r\nif (nated_port == 0) {\r\nnet_notice_ratelimited("nf_nat_q931: out of TCP ports\n");\r\nreturn 0;\r\n}\r\nif (!set_h225_addr(skb, protoff, data, dataoff, taddr,\r\n&ct->tuplehash[!dir].tuple.dst.u3,\r\nhtons(nated_port)) == 0) {\r\nnf_ct_unexpect_related(exp);\r\nreturn -1;\r\n}\r\npr_debug("nf_nat_q931: expect Call Forwarding %pI4:%hu->%pI4:%hu\n",\r\n&exp->tuple.src.u3.ip,\r\nntohs(exp->tuple.src.u.tcp.port),\r\n&exp->tuple.dst.u3.ip,\r\nntohs(exp->tuple.dst.u.tcp.port));\r\nreturn 0;\r\n}\r\nstatic int __init init(void)\r\n{\r\nBUG_ON(set_h245_addr_hook != NULL);\r\nBUG_ON(set_h225_addr_hook != NULL);\r\nBUG_ON(set_sig_addr_hook != NULL);\r\nBUG_ON(set_ras_addr_hook != NULL);\r\nBUG_ON(nat_rtp_rtcp_hook != NULL);\r\nBUG_ON(nat_t120_hook != NULL);\r\nBUG_ON(nat_h245_hook != NULL);\r\nBUG_ON(nat_callforwarding_hook != NULL);\r\nBUG_ON(nat_q931_hook != NULL);\r\nRCU_INIT_POINTER(set_h245_addr_hook, set_h245_addr);\r\nRCU_INIT_POINTER(set_h225_addr_hook, set_h225_addr);\r\nRCU_INIT_POINTER(set_sig_addr_hook, set_sig_addr);\r\nRCU_INIT_POINTER(set_ras_addr_hook, set_ras_addr);\r\nRCU_INIT_POINTER(nat_rtp_rtcp_hook, nat_rtp_rtcp);\r\nRCU_INIT_POINTER(nat_t120_hook, nat_t120);\r\nRCU_INIT_POINTER(nat_h245_hook, nat_h245);\r\nRCU_INIT_POINTER(nat_callforwarding_hook, nat_callforwarding);\r\nRCU_INIT_POINTER(nat_q931_hook, nat_q931);\r\nnf_ct_helper_expectfn_register(&q931_nat);\r\nnf_ct_helper_expectfn_register(&callforwarding_nat);\r\nreturn 0;\r\n}\r\nstatic void __exit fini(void)\r\n{\r\nRCU_INIT_POINTER(set_h245_addr_hook, NULL);\r\nRCU_INIT_POINTER(set_h225_addr_hook, NULL);\r\nRCU_INIT_POINTER(set_sig_addr_hook, NULL);\r\nRCU_INIT_POINTER(set_ras_addr_hook, NULL);\r\nRCU_INIT_POINTER(nat_rtp_rtcp_hook, NULL);\r\nRCU_INIT_POINTER(nat_t120_hook, NULL);\r\nRCU_INIT_POINTER(nat_h245_hook, NULL);\r\nRCU_INIT_POINTER(nat_callforwarding_hook, NULL);\r\nRCU_INIT_POINTER(nat_q931_hook, NULL);\r\nnf_ct_helper_expectfn_unregister(&q931_nat);\r\nnf_ct_helper_expectfn_unregister(&callforwarding_nat);\r\nsynchronize_rcu();\r\n}

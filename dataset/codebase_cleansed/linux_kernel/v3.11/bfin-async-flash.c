static void switch_to_flash(struct async_state *state)\r\n{\r\nlocal_irq_save(state->irq_flags);\r\ngpio_set_value(state->enet_flash_pin, 0);\r\nstate->save_ambctl0 = bfin_read_EBIU_AMBCTL0();\r\nstate->save_ambctl1 = bfin_read_EBIU_AMBCTL1();\r\nbfin_write_EBIU_AMBCTL0(state->flash_ambctl0);\r\nbfin_write_EBIU_AMBCTL1(state->flash_ambctl1);\r\nSSYNC();\r\n}\r\nstatic void switch_back(struct async_state *state)\r\n{\r\nbfin_write_EBIU_AMBCTL0(state->save_ambctl0);\r\nbfin_write_EBIU_AMBCTL1(state->save_ambctl1);\r\nSSYNC();\r\ngpio_set_value(state->enet_flash_pin, 1);\r\nlocal_irq_restore(state->irq_flags);\r\n}\r\nstatic map_word bfin_flash_read(struct map_info *map, unsigned long ofs)\r\n{\r\nstruct async_state *state = (struct async_state *)map->map_priv_1;\r\nuint16_t word;\r\nmap_word test;\r\nswitch_to_flash(state);\r\nword = readw(map->virt + ofs);\r\nswitch_back(state);\r\ntest.x[0] = word;\r\nreturn test;\r\n}\r\nstatic void bfin_flash_copy_from(struct map_info *map, void *to, unsigned long from, ssize_t len)\r\n{\r\nstruct async_state *state = (struct async_state *)map->map_priv_1;\r\nswitch_to_flash(state);\r\nmemcpy(to, map->virt + from, len);\r\nswitch_back(state);\r\n}\r\nstatic void bfin_flash_write(struct map_info *map, map_word d1, unsigned long ofs)\r\n{\r\nstruct async_state *state = (struct async_state *)map->map_priv_1;\r\nuint16_t d;\r\nd = d1.x[0];\r\nswitch_to_flash(state);\r\nwritew(d, map->virt + ofs);\r\nSSYNC();\r\nswitch_back(state);\r\n}\r\nstatic void bfin_flash_copy_to(struct map_info *map, unsigned long to, const void *from, ssize_t len)\r\n{\r\nstruct async_state *state = (struct async_state *)map->map_priv_1;\r\nswitch_to_flash(state);\r\nmemcpy(map->virt + to, from, len);\r\nSSYNC();\r\nswitch_back(state);\r\n}\r\nstatic int bfin_flash_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct physmap_flash_data *pdata = pdev->dev.platform_data;\r\nstruct resource *memory = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nstruct resource *flash_ambctl = platform_get_resource(pdev, IORESOURCE_MEM, 1);\r\nstruct async_state *state;\r\nstate = kzalloc(sizeof(*state), GFP_KERNEL);\r\nif (!state)\r\nreturn -ENOMEM;\r\nstate->map.name = DRIVER_NAME;\r\nstate->map.read = bfin_flash_read;\r\nstate->map.copy_from = bfin_flash_copy_from;\r\nstate->map.write = bfin_flash_write;\r\nstate->map.copy_to = bfin_flash_copy_to;\r\nstate->map.bankwidth = pdata->width;\r\nstate->map.size = resource_size(memory);\r\nstate->map.virt = (void __iomem *)memory->start;\r\nstate->map.phys = memory->start;\r\nstate->map.map_priv_1 = (unsigned long)state;\r\nstate->enet_flash_pin = platform_get_irq(pdev, 0);\r\nstate->flash_ambctl0 = flash_ambctl->start;\r\nstate->flash_ambctl1 = flash_ambctl->end;\r\nif (gpio_request(state->enet_flash_pin, DRIVER_NAME)) {\r\npr_devinit(KERN_ERR DRIVER_NAME ": Failed to request gpio %d\n", state->enet_flash_pin);\r\nkfree(state);\r\nreturn -EBUSY;\r\n}\r\ngpio_direction_output(state->enet_flash_pin, 1);\r\npr_devinit(KERN_NOTICE DRIVER_NAME ": probing %d-bit flash bus\n", state->map.bankwidth * 8);\r\nstate->mtd = do_map_probe(memory->name, &state->map);\r\nif (!state->mtd) {\r\ngpio_free(state->enet_flash_pin);\r\nkfree(state);\r\nreturn -ENXIO;\r\n}\r\nmtd_device_parse_register(state->mtd, part_probe_types, NULL,\r\npdata->parts, pdata->nr_parts);\r\nplatform_set_drvdata(pdev, state);\r\nreturn 0;\r\n}\r\nstatic int bfin_flash_remove(struct platform_device *pdev)\r\n{\r\nstruct async_state *state = platform_get_drvdata(pdev);\r\ngpio_free(state->enet_flash_pin);\r\nmtd_device_unregister(state->mtd);\r\nmap_destroy(state->mtd);\r\nkfree(state);\r\nreturn 0;\r\n}

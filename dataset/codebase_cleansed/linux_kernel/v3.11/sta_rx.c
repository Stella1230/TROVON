int mwifiex_process_rx_packet(struct mwifiex_private *priv,\r\nstruct sk_buff *skb)\r\n{\r\nint ret;\r\nstruct rx_packet_hdr *rx_pkt_hdr;\r\nstruct rxpd *local_rx_pd;\r\nint hdr_chop;\r\nstruct ethhdr *eth_hdr;\r\nu8 rfc1042_eth_hdr[ETH_ALEN] = { 0xaa, 0xaa, 0x03, 0x00, 0x00, 0x00 };\r\nlocal_rx_pd = (struct rxpd *) (skb->data);\r\nrx_pkt_hdr = (void *)local_rx_pd +\r\nle16_to_cpu(local_rx_pd->rx_pkt_offset);\r\nif (!memcmp(&rx_pkt_hdr->rfc1042_hdr,\r\nrfc1042_eth_hdr, sizeof(rfc1042_eth_hdr))) {\r\neth_hdr = (struct ethhdr *)\r\n((u8 *) &rx_pkt_hdr->eth803_hdr\r\n+ sizeof(rx_pkt_hdr->eth803_hdr) +\r\nsizeof(rx_pkt_hdr->rfc1042_hdr)\r\n- sizeof(rx_pkt_hdr->eth803_hdr.h_dest)\r\n- sizeof(rx_pkt_hdr->eth803_hdr.h_source)\r\n- sizeof(rx_pkt_hdr->rfc1042_hdr.snap_type));\r\nmemcpy(eth_hdr->h_source, rx_pkt_hdr->eth803_hdr.h_source,\r\nsizeof(eth_hdr->h_source));\r\nmemcpy(eth_hdr->h_dest, rx_pkt_hdr->eth803_hdr.h_dest,\r\nsizeof(eth_hdr->h_dest));\r\nhdr_chop = (u8 *) eth_hdr - (u8 *) local_rx_pd;\r\n} else {\r\nhdr_chop = (u8 *) &rx_pkt_hdr->eth803_hdr -\r\n(u8 *) local_rx_pd;\r\n}\r\nskb_pull(skb, hdr_chop);\r\npriv->rxpd_rate = local_rx_pd->rx_rate;\r\npriv->rxpd_htinfo = local_rx_pd->ht_info;\r\nret = mwifiex_recv_packet(priv, skb);\r\nif (ret == -1)\r\ndev_err(priv->adapter->dev, "recv packet failed\n");\r\nreturn ret;\r\n}\r\nint mwifiex_process_sta_rx_packet(struct mwifiex_private *priv,\r\nstruct sk_buff *skb)\r\n{\r\nstruct mwifiex_adapter *adapter = priv->adapter;\r\nint ret = 0;\r\nstruct rxpd *local_rx_pd;\r\nstruct rx_packet_hdr *rx_pkt_hdr;\r\nu8 ta[ETH_ALEN];\r\nu16 rx_pkt_type, rx_pkt_offset, rx_pkt_length, seq_num;\r\nlocal_rx_pd = (struct rxpd *) (skb->data);\r\nrx_pkt_type = le16_to_cpu(local_rx_pd->rx_pkt_type);\r\nrx_pkt_offset = le16_to_cpu(local_rx_pd->rx_pkt_offset);\r\nrx_pkt_length = le16_to_cpu(local_rx_pd->rx_pkt_length);\r\nseq_num = le16_to_cpu(local_rx_pd->seq_num);\r\nrx_pkt_hdr = (void *)local_rx_pd + rx_pkt_offset;\r\nif ((rx_pkt_offset + rx_pkt_length) > (u16) skb->len) {\r\ndev_err(adapter->dev,\r\n"wrong rx packet: len=%d, rx_pkt_offset=%d, rx_pkt_length=%d\n",\r\nskb->len, rx_pkt_offset, rx_pkt_length);\r\npriv->stats.rx_dropped++;\r\nif (adapter->if_ops.data_complete)\r\nadapter->if_ops.data_complete(adapter, skb);\r\nelse\r\ndev_kfree_skb_any(skb);\r\nreturn ret;\r\n}\r\nif (rx_pkt_type == PKT_TYPE_AMSDU) {\r\nstruct sk_buff_head list;\r\nstruct sk_buff *rx_skb;\r\n__skb_queue_head_init(&list);\r\nskb_pull(skb, rx_pkt_offset);\r\nskb_trim(skb, rx_pkt_length);\r\nieee80211_amsdu_to_8023s(skb, &list, priv->curr_addr,\r\npriv->wdev->iftype, 0, false);\r\nwhile (!skb_queue_empty(&list)) {\r\nrx_skb = __skb_dequeue(&list);\r\nret = mwifiex_recv_packet(priv, rx_skb);\r\nif (ret == -1)\r\ndev_err(adapter->dev, "Rx of A-MSDU failed");\r\n}\r\nreturn 0;\r\n} else if (rx_pkt_type == PKT_TYPE_MGMT) {\r\nret = mwifiex_process_mgmt_packet(priv, skb);\r\nif (ret)\r\ndev_err(adapter->dev, "Rx of mgmt packet failed");\r\ndev_kfree_skb_any(skb);\r\nreturn ret;\r\n}\r\nif (!IS_11N_ENABLED(priv) ||\r\nmemcmp(priv->curr_addr, rx_pkt_hdr->eth803_hdr.h_dest, ETH_ALEN)) {\r\nmwifiex_process_rx_packet(priv, skb);\r\nreturn ret;\r\n}\r\nif (mwifiex_queuing_ra_based(priv)) {\r\nmemcpy(ta, rx_pkt_hdr->eth803_hdr.h_source, ETH_ALEN);\r\n} else {\r\nif (rx_pkt_type != PKT_TYPE_BAR)\r\npriv->rx_seq[local_rx_pd->priority] = seq_num;\r\nmemcpy(ta, priv->curr_bss_params.bss_descriptor.mac_address,\r\nETH_ALEN);\r\n}\r\nret = mwifiex_11n_rx_reorder_pkt(priv, seq_num, local_rx_pd->priority,\r\nta, (u8) rx_pkt_type, skb);\r\nif (ret || (rx_pkt_type == PKT_TYPE_BAR)) {\r\nif (adapter->if_ops.data_complete)\r\nadapter->if_ops.data_complete(adapter, skb);\r\nelse\r\ndev_kfree_skb_any(skb);\r\n}\r\nif (ret)\r\npriv->stats.rx_dropped++;\r\nreturn ret;\r\n}

static int nx_sha512_init(struct shash_desc *desc)\r\n{\r\nstruct sha512_state *sctx = shash_desc_ctx(desc);\r\nstruct nx_crypto_ctx *nx_ctx = crypto_tfm_ctx(&desc->tfm->base);\r\nstruct nx_sg *out_sg;\r\nnx_ctx_init(nx_ctx, HCOP_FC_SHA);\r\nmemset(sctx, 0, sizeof *sctx);\r\nnx_ctx->ap = &nx_ctx->props[NX_PROPS_SHA512];\r\nNX_CPB_SET_DIGEST_SIZE(nx_ctx->csbcpb, NX_DS_SHA512);\r\nout_sg = nx_build_sg_list(nx_ctx->out_sg, (u8 *)sctx->state,\r\nSHA512_DIGEST_SIZE, nx_ctx->ap->sglen);\r\nnx_ctx->op.outlen = (nx_ctx->out_sg - out_sg) * sizeof(struct nx_sg);\r\nreturn 0;\r\n}\r\nstatic int nx_sha512_update(struct shash_desc *desc, const u8 *data,\r\nunsigned int len)\r\n{\r\nstruct sha512_state *sctx = shash_desc_ctx(desc);\r\nstruct nx_crypto_ctx *nx_ctx = crypto_tfm_ctx(&desc->tfm->base);\r\nstruct nx_csbcpb *csbcpb = (struct nx_csbcpb *)nx_ctx->csbcpb;\r\nstruct nx_sg *in_sg;\r\nu64 to_process, leftover, spbc_bits;\r\nint rc = 0;\r\nif (NX_CPB_FDM(csbcpb) & NX_FDM_CONTINUATION) {\r\nmemcpy(csbcpb->cpb.sha512.input_partial_digest,\r\ncsbcpb->cpb.sha512.message_digest, SHA512_DIGEST_SIZE);\r\n}\r\nif ((u64)len + sctx->count[0] < SHA512_BLOCK_SIZE) {\r\nmemcpy(sctx->buf + sctx->count[0], data, len);\r\nsctx->count[0] += len;\r\ngoto out;\r\n}\r\nto_process = (sctx->count[0] + len) & ~(SHA512_BLOCK_SIZE - 1);\r\nleftover = (sctx->count[0] + len) & (SHA512_BLOCK_SIZE - 1);\r\nif (sctx->count[0]) {\r\nin_sg = nx_build_sg_list(nx_ctx->in_sg, (u8 *)sctx->buf,\r\nsctx->count[0], nx_ctx->ap->sglen);\r\nin_sg = nx_build_sg_list(in_sg, (u8 *)data,\r\nto_process - sctx->count[0],\r\nnx_ctx->ap->sglen);\r\nnx_ctx->op.inlen = (nx_ctx->in_sg - in_sg) *\r\nsizeof(struct nx_sg);\r\n} else {\r\nin_sg = nx_build_sg_list(nx_ctx->in_sg, (u8 *)data,\r\nto_process, nx_ctx->ap->sglen);\r\nnx_ctx->op.inlen = (nx_ctx->in_sg - in_sg) *\r\nsizeof(struct nx_sg);\r\n}\r\nNX_CPB_FDM(csbcpb) |= NX_FDM_INTERMEDIATE;\r\nif (!nx_ctx->op.inlen || !nx_ctx->op.outlen) {\r\nrc = -EINVAL;\r\ngoto out;\r\n}\r\nrc = nx_hcall_sync(nx_ctx, &nx_ctx->op,\r\ndesc->flags & CRYPTO_TFM_REQ_MAY_SLEEP);\r\nif (rc)\r\ngoto out;\r\natomic_inc(&(nx_ctx->stats->sha512_ops));\r\nif (leftover)\r\nmemcpy(sctx->buf, data + len - leftover, leftover);\r\nsctx->count[0] = leftover;\r\nspbc_bits = csbcpb->cpb.sha512.spbc * 8;\r\ncsbcpb->cpb.sha512.message_bit_length_lo += spbc_bits;\r\nif (csbcpb->cpb.sha512.message_bit_length_lo < spbc_bits)\r\ncsbcpb->cpb.sha512.message_bit_length_hi++;\r\nNX_CPB_FDM(csbcpb) |= NX_FDM_CONTINUATION;\r\nout:\r\nreturn rc;\r\n}\r\nstatic int nx_sha512_final(struct shash_desc *desc, u8 *out)\r\n{\r\nstruct sha512_state *sctx = shash_desc_ctx(desc);\r\nstruct nx_crypto_ctx *nx_ctx = crypto_tfm_ctx(&desc->tfm->base);\r\nstruct nx_csbcpb *csbcpb = (struct nx_csbcpb *)nx_ctx->csbcpb;\r\nstruct nx_sg *in_sg, *out_sg;\r\nu64 count0;\r\nint rc;\r\nif (NX_CPB_FDM(csbcpb) & NX_FDM_CONTINUATION) {\r\nmemcpy(csbcpb->cpb.sha512.input_partial_digest,\r\ncsbcpb->cpb.sha512.message_digest, SHA512_DIGEST_SIZE);\r\n}\r\nNX_CPB_FDM(csbcpb) &= ~NX_FDM_INTERMEDIATE;\r\ncount0 = sctx->count[0] * 8;\r\ncsbcpb->cpb.sha512.message_bit_length_lo += count0;\r\nif (csbcpb->cpb.sha512.message_bit_length_lo < count0)\r\ncsbcpb->cpb.sha512.message_bit_length_hi++;\r\nin_sg = nx_build_sg_list(nx_ctx->in_sg, sctx->buf, sctx->count[0],\r\nnx_ctx->ap->sglen);\r\nout_sg = nx_build_sg_list(nx_ctx->out_sg, out, SHA512_DIGEST_SIZE,\r\nnx_ctx->ap->sglen);\r\nnx_ctx->op.inlen = (nx_ctx->in_sg - in_sg) * sizeof(struct nx_sg);\r\nnx_ctx->op.outlen = (nx_ctx->out_sg - out_sg) * sizeof(struct nx_sg);\r\nif (!nx_ctx->op.outlen) {\r\nrc = -EINVAL;\r\ngoto out;\r\n}\r\nrc = nx_hcall_sync(nx_ctx, &nx_ctx->op,\r\ndesc->flags & CRYPTO_TFM_REQ_MAY_SLEEP);\r\nif (rc)\r\ngoto out;\r\natomic_inc(&(nx_ctx->stats->sha512_ops));\r\natomic64_add(csbcpb->cpb.sha512.message_bit_length_lo / 8,\r\n&(nx_ctx->stats->sha512_bytes));\r\nmemcpy(out, csbcpb->cpb.sha512.message_digest, SHA512_DIGEST_SIZE);\r\nout:\r\nreturn rc;\r\n}\r\nstatic int nx_sha512_export(struct shash_desc *desc, void *out)\r\n{\r\nstruct sha512_state *sctx = shash_desc_ctx(desc);\r\nstruct nx_crypto_ctx *nx_ctx = crypto_tfm_ctx(&desc->tfm->base);\r\nstruct nx_csbcpb *csbcpb = (struct nx_csbcpb *)nx_ctx->csbcpb;\r\nstruct sha512_state *octx = out;\r\noctx->count[0] = csbcpb->cpb.sha512.message_bit_length_lo >> 3 |\r\n((csbcpb->cpb.sha512.message_bit_length_hi & 7) << 61);\r\noctx->count[1] = csbcpb->cpb.sha512.message_bit_length_hi >> 3;\r\noctx->count[0] += sctx->count[0];\r\nif (octx->count[0] < sctx->count[0])\r\noctx->count[1]++;\r\nmemcpy(octx->buf, sctx->buf, sizeof(octx->buf));\r\nif (csbcpb->cpb.sha512.message_bit_length_hi ||\r\ncsbcpb->cpb.sha512.message_bit_length_lo)\r\nmemcpy(octx->state, csbcpb->cpb.sha512.message_digest,\r\nSHA512_DIGEST_SIZE);\r\nelse {\r\noctx->state[0] = SHA512_H0;\r\noctx->state[1] = SHA512_H1;\r\noctx->state[2] = SHA512_H2;\r\noctx->state[3] = SHA512_H3;\r\noctx->state[4] = SHA512_H4;\r\noctx->state[5] = SHA512_H5;\r\noctx->state[6] = SHA512_H6;\r\noctx->state[7] = SHA512_H7;\r\n}\r\nreturn 0;\r\n}\r\nstatic int nx_sha512_import(struct shash_desc *desc, const void *in)\r\n{\r\nstruct sha512_state *sctx = shash_desc_ctx(desc);\r\nstruct nx_crypto_ctx *nx_ctx = crypto_tfm_ctx(&desc->tfm->base);\r\nstruct nx_csbcpb *csbcpb = (struct nx_csbcpb *)nx_ctx->csbcpb;\r\nconst struct sha512_state *ictx = in;\r\nmemcpy(sctx->buf, ictx->buf, sizeof(ictx->buf));\r\nsctx->count[0] = ictx->count[0] & 0x3f;\r\ncsbcpb->cpb.sha512.message_bit_length_lo = (ictx->count[0] & ~0x3f)\r\n<< 3;\r\ncsbcpb->cpb.sha512.message_bit_length_hi = ictx->count[1] << 3 |\r\nictx->count[0] >> 61;\r\nif (csbcpb->cpb.sha512.message_bit_length_hi ||\r\ncsbcpb->cpb.sha512.message_bit_length_lo) {\r\nmemcpy(csbcpb->cpb.sha512.message_digest, ictx->state,\r\nSHA512_DIGEST_SIZE);\r\nNX_CPB_FDM(csbcpb) |= NX_FDM_CONTINUATION;\r\nNX_CPB_FDM(csbcpb) |= NX_FDM_INTERMEDIATE;\r\n}\r\nreturn 0;\r\n}

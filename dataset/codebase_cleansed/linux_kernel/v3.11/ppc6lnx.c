static int ppc6_select(Interface *ppc)\r\n{\r\nu8 i, j, k;\r\ni = inb(ppc->lpt_addr + 1);\r\nif (i & 1)\r\noutb(i, ppc->lpt_addr + 1);\r\nppc->org_data = inb(ppc->lpt_addr);\r\nppc->org_ctrl = inb(ppc->lpt_addr + 2) & 0x5F;\r\nppc->cur_ctrl = ppc->org_ctrl;\r\nppc->cur_ctrl |= port_sel;\r\noutb(ppc->cur_ctrl, ppc->lpt_addr + 2);\r\nif (ppc->org_data == 'b')\r\noutb('x', ppc->lpt_addr);\r\noutb('b', ppc->lpt_addr);\r\noutb('p', ppc->lpt_addr);\r\noutb(ppc->ppc_id, ppc->lpt_addr);\r\noutb(~ppc->ppc_id,ppc->lpt_addr);\r\nppc->cur_ctrl &= ~port_sel;\r\noutb(ppc->cur_ctrl, ppc->lpt_addr + 2);\r\nppc->cur_ctrl = (ppc->cur_ctrl & port_int) | port_init;\r\noutb(ppc->cur_ctrl, ppc->lpt_addr + 2);\r\ni = ppc->mode & 0x0C;\r\nif (i == 0)\r\ni = (ppc->mode & 2) | 1;\r\noutb(i, ppc->lpt_addr);\r\nppc->cur_ctrl |= port_sel;\r\noutb(ppc->cur_ctrl, ppc->lpt_addr + 2);\r\nppc->cur_ctrl |= port_afd;\r\noutb(ppc->cur_ctrl, ppc->lpt_addr + 2);\r\nj = ((i & 0x08) << 4) | ((i & 0x07) << 3);\r\nk = inb(ppc->lpt_addr + 1) & 0xB8;\r\nif (j == k)\r\n{\r\nppc->cur_ctrl &= ~port_afd;\r\noutb(ppc->cur_ctrl, ppc->lpt_addr + 2);\r\nk = (inb(ppc->lpt_addr + 1) & 0xB8) ^ 0xB8;\r\nif (j == k)\r\n{\r\nif (i & 4)\r\nppc->cur_ctrl &= ~(port_sel | port_init);\r\nelse\r\nppc->cur_ctrl &= ~port_sel;\r\noutb(ppc->cur_ctrl, ppc->lpt_addr + 2);\r\nreturn(1);\r\n}\r\n}\r\noutb(ppc->org_ctrl, ppc->lpt_addr + 2);\r\noutb(ppc->org_data, ppc->lpt_addr);\r\nreturn(0);\r\n}\r\nstatic void ppc6_deselect(Interface *ppc)\r\n{\r\nif (ppc->mode & 4)\r\nppc->cur_ctrl |= port_init;\r\nelse\r\nppc->cur_ctrl |= port_sel;\r\noutb(ppc->cur_ctrl, ppc->lpt_addr + 2);\r\noutb(ppc->org_data, ppc->lpt_addr);\r\noutb((ppc->org_ctrl | port_sel), ppc->lpt_addr + 2);\r\noutb(ppc->org_ctrl, ppc->lpt_addr + 2);\r\n}\r\nstatic void ppc6_send_cmd(Interface *ppc, u8 cmd)\r\n{\r\nswitch(ppc->mode)\r\n{\r\ncase PPCMODE_UNI_SW :\r\ncase PPCMODE_UNI_FW :\r\ncase PPCMODE_BI_SW :\r\ncase PPCMODE_BI_FW :\r\n{\r\noutb(cmd, ppc->lpt_addr);\r\nppc->cur_ctrl ^= cmd_stb;\r\noutb(ppc->cur_ctrl, ppc->lpt_addr + 2);\r\nbreak;\r\n}\r\ncase PPCMODE_EPP_BYTE :\r\ncase PPCMODE_EPP_WORD :\r\ncase PPCMODE_EPP_DWORD :\r\n{\r\noutb(cmd, ppc->lpt_addr + 3);\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void ppc6_wr_data_byte(Interface *ppc, u8 data)\r\n{\r\nswitch(ppc->mode)\r\n{\r\ncase PPCMODE_UNI_SW :\r\ncase PPCMODE_UNI_FW :\r\ncase PPCMODE_BI_SW :\r\ncase PPCMODE_BI_FW :\r\n{\r\noutb(data, ppc->lpt_addr);\r\nppc->cur_ctrl ^= data_stb;\r\noutb(ppc->cur_ctrl, ppc->lpt_addr + 2);\r\nbreak;\r\n}\r\ncase PPCMODE_EPP_BYTE :\r\ncase PPCMODE_EPP_WORD :\r\ncase PPCMODE_EPP_DWORD :\r\n{\r\noutb(data, ppc->lpt_addr + 4);\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic u8 ppc6_rd_data_byte(Interface *ppc)\r\n{\r\nu8 data = 0;\r\nswitch(ppc->mode)\r\n{\r\ncase PPCMODE_UNI_SW :\r\ncase PPCMODE_UNI_FW :\r\n{\r\nppc->cur_ctrl = (ppc->cur_ctrl & ~port_stb) ^ data_stb;\r\noutb(ppc->cur_ctrl, ppc->lpt_addr + 2);\r\ndata = inb(ppc->lpt_addr + 1);\r\ndata = ((data & 0x80) >> 1) | ((data & 0x38) >> 3);\r\nppc->cur_ctrl |= port_stb;\r\noutb(ppc->cur_ctrl, ppc->lpt_addr + 2);\r\ndata |= inb(ppc->lpt_addr + 1) & 0xB8;\r\nbreak;\r\n}\r\ncase PPCMODE_BI_SW :\r\ncase PPCMODE_BI_FW :\r\n{\r\nppc->cur_ctrl |= port_dir;\r\noutb(ppc->cur_ctrl, ppc->lpt_addr + 2);\r\nppc->cur_ctrl = (ppc->cur_ctrl | port_stb) ^ data_stb;\r\noutb(ppc->cur_ctrl, ppc->lpt_addr + 2);\r\ndata = inb(ppc->lpt_addr);\r\nppc->cur_ctrl &= ~port_stb;\r\noutb(ppc->cur_ctrl,ppc->lpt_addr + 2);\r\nppc->cur_ctrl &= ~port_dir;\r\noutb(ppc->cur_ctrl, ppc->lpt_addr + 2);\r\nbreak;\r\n}\r\ncase PPCMODE_EPP_BYTE :\r\ncase PPCMODE_EPP_WORD :\r\ncase PPCMODE_EPP_DWORD :\r\n{\r\noutb((ppc->cur_ctrl | port_dir),ppc->lpt_addr + 2);\r\ndata = inb(ppc->lpt_addr + 4);\r\noutb(ppc->cur_ctrl,ppc->lpt_addr + 2);\r\nbreak;\r\n}\r\n}\r\nreturn(data);\r\n}\r\nstatic u8 ppc6_rd_port(Interface *ppc, u8 port)\r\n{\r\nppc6_send_cmd(ppc,(u8)(port | ACCESS_PORT | ACCESS_READ));\r\nreturn(ppc6_rd_data_byte(ppc));\r\n}\r\nstatic void ppc6_wr_port(Interface *ppc, u8 port, u8 data)\r\n{\r\nppc6_send_cmd(ppc,(u8)(port | ACCESS_PORT | ACCESS_WRITE));\r\nppc6_wr_data_byte(ppc, data);\r\n}\r\nstatic void ppc6_rd_data_blk(Interface *ppc, u8 *data, long count)\r\n{\r\nswitch(ppc->mode)\r\n{\r\ncase PPCMODE_UNI_SW :\r\ncase PPCMODE_UNI_FW :\r\n{\r\nwhile(count)\r\n{\r\nu8 d;\r\nppc->cur_ctrl = (ppc->cur_ctrl & ~port_stb) ^ data_stb;\r\noutb(ppc->cur_ctrl, ppc->lpt_addr + 2);\r\nd = inb(ppc->lpt_addr + 1);\r\nd = ((d & 0x80) >> 1) | ((d & 0x38) >> 3);\r\nppc->cur_ctrl |= port_stb;\r\noutb(ppc->cur_ctrl, ppc->lpt_addr + 2);\r\nd |= inb(ppc->lpt_addr + 1) & 0xB8;\r\n*data++ = d;\r\ncount--;\r\n}\r\nbreak;\r\n}\r\ncase PPCMODE_BI_SW :\r\ncase PPCMODE_BI_FW :\r\n{\r\nppc->cur_ctrl |= port_dir;\r\noutb(ppc->cur_ctrl, ppc->lpt_addr + 2);\r\nppc->cur_ctrl |= port_stb;\r\nwhile(count)\r\n{\r\nppc->cur_ctrl ^= data_stb;\r\noutb(ppc->cur_ctrl, ppc->lpt_addr + 2);\r\n*data++ = inb(ppc->lpt_addr);\r\ncount--;\r\n}\r\nppc->cur_ctrl &= ~port_stb;\r\noutb(ppc->cur_ctrl, ppc->lpt_addr + 2);\r\nppc->cur_ctrl &= ~port_dir;\r\noutb(ppc->cur_ctrl, ppc->lpt_addr + 2);\r\nbreak;\r\n}\r\ncase PPCMODE_EPP_BYTE :\r\n{\r\noutb((ppc->cur_ctrl | port_dir), ppc->lpt_addr + 2);\r\nwhile(count)\r\n{\r\n*data++ = inb(ppc->lpt_addr + 4);\r\ncount--;\r\n}\r\noutb(ppc->cur_ctrl, ppc->lpt_addr + 2);\r\nbreak;\r\n}\r\ncase PPCMODE_EPP_WORD :\r\n{\r\noutb((ppc->cur_ctrl | port_dir), ppc->lpt_addr + 2);\r\nwhile(count > 1)\r\n{\r\n*((u16 *)data) = inw(ppc->lpt_addr + 4);\r\ndata += 2;\r\ncount -= 2;\r\n}\r\nwhile(count)\r\n{\r\n*data++ = inb(ppc->lpt_addr + 4);\r\ncount--;\r\n}\r\noutb(ppc->cur_ctrl, ppc->lpt_addr + 2);\r\nbreak;\r\n}\r\ncase PPCMODE_EPP_DWORD :\r\n{\r\noutb((ppc->cur_ctrl | port_dir),ppc->lpt_addr + 2);\r\nwhile(count > 3)\r\n{\r\n*((u32 *)data) = inl(ppc->lpt_addr + 4);\r\ndata += 4;\r\ncount -= 4;\r\n}\r\nwhile(count)\r\n{\r\n*data++ = inb(ppc->lpt_addr + 4);\r\ncount--;\r\n}\r\noutb(ppc->cur_ctrl, ppc->lpt_addr + 2);\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void ppc6_wait_for_fifo(Interface *ppc)\r\n{\r\nint i;\r\nif (ppc->ppc_flags & fifo_wait)\r\n{\r\nfor(i=0; i<20; i++)\r\ninb(ppc->lpt_addr + 1);\r\n}\r\n}\r\nstatic void ppc6_wr_data_blk(Interface *ppc, u8 *data, long count)\r\n{\r\nswitch(ppc->mode)\r\n{\r\ncase PPCMODE_UNI_SW :\r\ncase PPCMODE_BI_SW :\r\n{\r\nwhile(count--)\r\n{\r\noutb(*data++, ppc->lpt_addr);\r\nppc->cur_ctrl ^= data_stb;\r\noutb(ppc->cur_ctrl, ppc->lpt_addr + 2);\r\n}\r\nbreak;\r\n}\r\ncase PPCMODE_UNI_FW :\r\ncase PPCMODE_BI_FW :\r\n{\r\nu8 this, last;\r\nppc6_send_cmd(ppc,(CMD_PREFIX_SET | PREFIX_FASTWR));\r\nppc->cur_ctrl |= port_stb;\r\noutb(ppc->cur_ctrl, ppc->lpt_addr + 2);\r\nlast = *data;\r\noutb(last, ppc->lpt_addr);\r\nwhile(count)\r\n{\r\nthis = *data++;\r\ncount--;\r\nif (this == last)\r\n{\r\nppc->cur_ctrl ^= data_stb;\r\noutb(ppc->cur_ctrl, ppc->lpt_addr + 2);\r\n}\r\nelse\r\n{\r\noutb(this, ppc->lpt_addr);\r\nlast = this;\r\n}\r\n}\r\nppc->cur_ctrl &= ~port_stb;\r\noutb(ppc->cur_ctrl, ppc->lpt_addr + 2);\r\nppc6_send_cmd(ppc,(CMD_PREFIX_RESET | PREFIX_FASTWR));\r\nbreak;\r\n}\r\ncase PPCMODE_EPP_BYTE :\r\n{\r\nwhile(count)\r\n{\r\noutb(*data++,ppc->lpt_addr + 4);\r\ncount--;\r\n}\r\nppc6_wait_for_fifo(ppc);\r\nbreak;\r\n}\r\ncase PPCMODE_EPP_WORD :\r\n{\r\nwhile(count > 1)\r\n{\r\noutw(*((u16 *)data),ppc->lpt_addr + 4);\r\ndata += 2;\r\ncount -= 2;\r\n}\r\nwhile(count)\r\n{\r\noutb(*data++,ppc->lpt_addr + 4);\r\ncount--;\r\n}\r\nppc6_wait_for_fifo(ppc);\r\nbreak;\r\n}\r\ncase PPCMODE_EPP_DWORD :\r\n{\r\nwhile(count > 3)\r\n{\r\noutl(*((u32 *)data),ppc->lpt_addr + 4);\r\ndata += 4;\r\ncount -= 4;\r\n}\r\nwhile(count)\r\n{\r\noutb(*data++,ppc->lpt_addr + 4);\r\ncount--;\r\n}\r\nppc6_wait_for_fifo(ppc);\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void ppc6_rd_port16_blk(Interface *ppc, u8 port, u8 *data, long length)\r\n{\r\nlength = length << 1;\r\nppc6_send_cmd(ppc, (REG_BLKSIZE | ACCESS_REG | ACCESS_WRITE));\r\nppc6_wr_data_byte(ppc,(u8)length);\r\nppc6_wr_data_byte(ppc,(u8)(length >> 8));\r\nppc6_wr_data_byte(ppc,0);\r\nppc6_send_cmd(ppc, (CMD_PREFIX_SET | PREFIX_IO16 | PREFIX_BLK));\r\nppc6_send_cmd(ppc, (u8)(port | ACCESS_PORT | ACCESS_READ));\r\nppc6_rd_data_blk(ppc, data, length);\r\nppc6_send_cmd(ppc, (CMD_PREFIX_RESET | PREFIX_IO16 | PREFIX_BLK));\r\n}\r\nstatic void ppc6_wr_port16_blk(Interface *ppc, u8 port, u8 *data, long length)\r\n{\r\nlength = length << 1;\r\nppc6_send_cmd(ppc, (REG_BLKSIZE | ACCESS_REG | ACCESS_WRITE));\r\nppc6_wr_data_byte(ppc,(u8)length);\r\nppc6_wr_data_byte(ppc,(u8)(length >> 8));\r\nppc6_wr_data_byte(ppc,0);\r\nppc6_send_cmd(ppc, (CMD_PREFIX_SET | PREFIX_IO16 | PREFIX_BLK));\r\nppc6_send_cmd(ppc, (u8)(port | ACCESS_PORT | ACCESS_WRITE));\r\nppc6_wr_data_blk(ppc, data, length);\r\nppc6_send_cmd(ppc, (CMD_PREFIX_RESET | PREFIX_IO16 | PREFIX_BLK));\r\n}\r\nstatic void ppc6_wr_extout(Interface *ppc, u8 regdata)\r\n{\r\nppc6_send_cmd(ppc,(REG_VERSION | ACCESS_REG | ACCESS_WRITE));\r\nppc6_wr_data_byte(ppc, (u8)((regdata & 0x03) << 6));\r\n}\r\nstatic int ppc6_open(Interface *ppc)\r\n{\r\nint ret;\r\nret = ppc6_select(ppc);\r\nif (ret == 0)\r\nreturn(ret);\r\nppc->ppc_flags &= ~fifo_wait;\r\nppc6_send_cmd(ppc, (ACCESS_REG | ACCESS_WRITE | REG_RAMSIZE));\r\nppc6_wr_data_byte(ppc, RAMSIZE_128K);\r\nppc6_send_cmd(ppc, (ACCESS_REG | ACCESS_READ | REG_VERSION));\r\nif ((ppc6_rd_data_byte(ppc) & 0x3F) == 0x0C)\r\nppc->ppc_flags |= fifo_wait;\r\nreturn(ret);\r\n}\r\nstatic void ppc6_close(Interface *ppc)\r\n{\r\nppc6_deselect(ppc);\r\n}

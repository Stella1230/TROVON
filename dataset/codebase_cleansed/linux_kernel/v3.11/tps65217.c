int tps65217_reg_read(struct tps65217 *tps, unsigned int reg,\r\nunsigned int *val)\r\n{\r\nreturn regmap_read(tps->regmap, reg, val);\r\n}\r\nint tps65217_reg_write(struct tps65217 *tps, unsigned int reg,\r\nunsigned int val, unsigned int level)\r\n{\r\nint ret;\r\nunsigned int xor_reg_val;\r\nswitch (level) {\r\ncase TPS65217_PROTECT_NONE:\r\nreturn regmap_write(tps->regmap, reg, val);\r\ncase TPS65217_PROTECT_L1:\r\nxor_reg_val = reg ^ TPS65217_PASSWORD_REGS_UNLOCK;\r\nret = regmap_write(tps->regmap, TPS65217_REG_PASSWORD,\r\nxor_reg_val);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn regmap_write(tps->regmap, reg, val);\r\ncase TPS65217_PROTECT_L2:\r\nxor_reg_val = reg ^ TPS65217_PASSWORD_REGS_UNLOCK;\r\nret = regmap_write(tps->regmap, TPS65217_REG_PASSWORD,\r\nxor_reg_val);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_write(tps->regmap, reg, val);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_write(tps->regmap, TPS65217_REG_PASSWORD,\r\nxor_reg_val);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn regmap_write(tps->regmap, reg, val);\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic int tps65217_update_bits(struct tps65217 *tps, unsigned int reg,\r\nunsigned int mask, unsigned int val, unsigned int level)\r\n{\r\nint ret;\r\nunsigned int data;\r\nret = tps65217_reg_read(tps, reg, &data);\r\nif (ret) {\r\ndev_err(tps->dev, "Read from reg 0x%x failed\n", reg);\r\nreturn ret;\r\n}\r\ndata &= ~mask;\r\ndata |= val & mask;\r\nret = tps65217_reg_write(tps, reg, data, level);\r\nif (ret)\r\ndev_err(tps->dev, "Write for reg 0x%x failed\n", reg);\r\nreturn ret;\r\n}\r\nint tps65217_set_bits(struct tps65217 *tps, unsigned int reg,\r\nunsigned int mask, unsigned int val, unsigned int level)\r\n{\r\nreturn tps65217_update_bits(tps, reg, mask, val, level);\r\n}\r\nint tps65217_clear_bits(struct tps65217 *tps, unsigned int reg,\r\nunsigned int mask, unsigned int level)\r\n{\r\nreturn tps65217_update_bits(tps, reg, mask, 0, level);\r\n}\r\nstatic int tps65217_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *ids)\r\n{\r\nstruct tps65217 *tps;\r\nunsigned int version;\r\nunsigned int chip_id = ids->driver_data;\r\nconst struct of_device_id *match;\r\nbool status_off = false;\r\nint ret;\r\nif (client->dev.of_node) {\r\nmatch = of_match_device(tps65217_of_match, &client->dev);\r\nif (!match) {\r\ndev_err(&client->dev,\r\n"Failed to find matching dt id\n");\r\nreturn -EINVAL;\r\n}\r\nchip_id = (unsigned int)match->data;\r\nstatus_off = of_property_read_bool(client->dev.of_node,\r\n"ti,pmic-shutdown-controller");\r\n}\r\nif (!chip_id) {\r\ndev_err(&client->dev, "id is null.\n");\r\nreturn -ENODEV;\r\n}\r\ntps = devm_kzalloc(&client->dev, sizeof(*tps), GFP_KERNEL);\r\nif (!tps)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(client, tps);\r\ntps->dev = &client->dev;\r\ntps->id = chip_id;\r\ntps->regmap = devm_regmap_init_i2c(client, &tps65217_regmap_config);\r\nif (IS_ERR(tps->regmap)) {\r\nret = PTR_ERR(tps->regmap);\r\ndev_err(tps->dev, "Failed to allocate register map: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nret = mfd_add_devices(tps->dev, -1, tps65217s,\r\nARRAY_SIZE(tps65217s), NULL, 0, NULL);\r\nif (ret < 0) {\r\ndev_err(tps->dev, "mfd_add_devices failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = tps65217_reg_read(tps, TPS65217_REG_CHIPID, &version);\r\nif (ret < 0) {\r\ndev_err(tps->dev, "Failed to read revision register: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nif (status_off) {\r\nret = tps65217_set_bits(tps, TPS65217_REG_STATUS,\r\nTPS65217_STATUS_OFF, TPS65217_STATUS_OFF,\r\nTPS65217_PROTECT_NONE);\r\nif (ret)\r\ndev_warn(tps->dev, "unable to set the status OFF\n");\r\n}\r\ndev_info(tps->dev, "TPS65217 ID %#x version 1.%d\n",\r\n(version & TPS65217_CHIPID_CHIP_MASK) >> 4,\r\nversion & TPS65217_CHIPID_REV_MASK);\r\nreturn 0;\r\n}\r\nstatic int tps65217_remove(struct i2c_client *client)\r\n{\r\nstruct tps65217 *tps = i2c_get_clientdata(client);\r\nmfd_remove_devices(tps->dev);\r\nreturn 0;\r\n}\r\nstatic int __init tps65217_init(void)\r\n{\r\nreturn i2c_add_driver(&tps65217_driver);\r\n}\r\nstatic void __exit tps65217_exit(void)\r\n{\r\ni2c_del_driver(&tps65217_driver);\r\n}

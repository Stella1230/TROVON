static int tcp_v6_gso_send_check(struct sk_buff *skb)\r\n{\r\nconst struct ipv6hdr *ipv6h;\r\nstruct tcphdr *th;\r\nif (!pskb_may_pull(skb, sizeof(*th)))\r\nreturn -EINVAL;\r\nipv6h = ipv6_hdr(skb);\r\nth = tcp_hdr(skb);\r\nth->check = 0;\r\nskb->ip_summed = CHECKSUM_PARTIAL;\r\n__tcp_v6_send_check(skb, &ipv6h->saddr, &ipv6h->daddr);\r\nreturn 0;\r\n}\r\nstatic struct sk_buff **tcp6_gro_receive(struct sk_buff **head,\r\nstruct sk_buff *skb)\r\n{\r\nconst struct ipv6hdr *iph = skb_gro_network_header(skb);\r\n__wsum wsum;\r\n__sum16 sum;\r\nswitch (skb->ip_summed) {\r\ncase CHECKSUM_COMPLETE:\r\nif (!tcp_v6_check(skb_gro_len(skb), &iph->saddr, &iph->daddr,\r\nskb->csum)) {\r\nskb->ip_summed = CHECKSUM_UNNECESSARY;\r\nbreak;\r\n}\r\nflush:\r\nNAPI_GRO_CB(skb)->flush = 1;\r\nreturn NULL;\r\ncase CHECKSUM_NONE:\r\nwsum = ~csum_unfold(csum_ipv6_magic(&iph->saddr, &iph->daddr,\r\nskb_gro_len(skb),\r\nIPPROTO_TCP, 0));\r\nsum = csum_fold(skb_checksum(skb,\r\nskb_gro_offset(skb),\r\nskb_gro_len(skb),\r\nwsum));\r\nif (sum)\r\ngoto flush;\r\nskb->ip_summed = CHECKSUM_UNNECESSARY;\r\nbreak;\r\n}\r\nreturn tcp_gro_receive(head, skb);\r\n}\r\nstatic int tcp6_gro_complete(struct sk_buff *skb)\r\n{\r\nconst struct ipv6hdr *iph = ipv6_hdr(skb);\r\nstruct tcphdr *th = tcp_hdr(skb);\r\nth->check = ~tcp_v6_check(skb->len - skb_transport_offset(skb),\r\n&iph->saddr, &iph->daddr, 0);\r\nskb_shinfo(skb)->gso_type = SKB_GSO_TCPV6;\r\nreturn tcp_gro_complete(skb);\r\n}\r\nint __init tcpv6_offload_init(void)\r\n{\r\nreturn inet6_add_offload(&tcpv6_offload, IPPROTO_TCP);\r\n}

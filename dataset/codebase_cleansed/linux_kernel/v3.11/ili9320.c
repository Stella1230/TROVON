static inline int ili9320_write_spi(struct ili9320 *ili,\r\nunsigned int reg,\r\nunsigned int value)\r\n{\r\nstruct ili9320_spi *spi = &ili->access.spi;\r\nunsigned char *addr = spi->buffer_addr;\r\nunsigned char *data = spi->buffer_data;\r\naddr[0] = spi->id | ILI9320_SPI_INDEX | ILI9320_SPI_WRITE;\r\naddr[1] = reg >> 8;\r\naddr[2] = reg;\r\ndata[0] = spi->id | ILI9320_SPI_DATA | ILI9320_SPI_WRITE;\r\ndata[1] = value >> 8;\r\ndata[2] = value;\r\nreturn spi_sync(spi->dev, &spi->message);\r\n}\r\nint ili9320_write(struct ili9320 *ili, unsigned int reg, unsigned int value)\r\n{\r\ndev_dbg(ili->dev, "write: reg=%02x, val=%04x\n", reg, value);\r\nreturn ili->write(ili, reg, value);\r\n}\r\nint ili9320_write_regs(struct ili9320 *ili,\r\nconst struct ili9320_reg *values,\r\nint nr_values)\r\n{\r\nint index;\r\nint ret;\r\nfor (index = 0; index < nr_values; index++, values++) {\r\nret = ili9320_write(ili, values->address, values->value);\r\nif (ret != 0)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic void ili9320_reset(struct ili9320 *lcd)\r\n{\r\nstruct ili9320_platdata *cfg = lcd->platdata;\r\ncfg->reset(1);\r\nmdelay(50);\r\ncfg->reset(0);\r\nmdelay(50);\r\ncfg->reset(1);\r\nmdelay(100);\r\n}\r\nstatic inline int ili9320_init_chip(struct ili9320 *lcd)\r\n{\r\nint ret;\r\nili9320_reset(lcd);\r\nret = lcd->client->init(lcd, lcd->platdata);\r\nif (ret != 0) {\r\ndev_err(lcd->dev, "failed to initialise display\n");\r\nreturn ret;\r\n}\r\nlcd->initialised = 1;\r\nreturn 0;\r\n}\r\nstatic inline int ili9320_power_on(struct ili9320 *lcd)\r\n{\r\nif (!lcd->initialised)\r\nili9320_init_chip(lcd);\r\nlcd->display1 |= (ILI9320_DISPLAY1_D(3) | ILI9320_DISPLAY1_BASEE);\r\nili9320_write(lcd, ILI9320_DISPLAY1, lcd->display1);\r\nreturn 0;\r\n}\r\nstatic inline int ili9320_power_off(struct ili9320 *lcd)\r\n{\r\nlcd->display1 &= ~(ILI9320_DISPLAY1_D(3) | ILI9320_DISPLAY1_BASEE);\r\nili9320_write(lcd, ILI9320_DISPLAY1, lcd->display1);\r\nreturn 0;\r\n}\r\nstatic int ili9320_power(struct ili9320 *lcd, int power)\r\n{\r\nint ret = 0;\r\ndev_dbg(lcd->dev, "power %d => %d\n", lcd->power, power);\r\nif (POWER_IS_ON(power) && !POWER_IS_ON(lcd->power))\r\nret = ili9320_power_on(lcd);\r\nelse if (!POWER_IS_ON(power) && POWER_IS_ON(lcd->power))\r\nret = ili9320_power_off(lcd);\r\nif (ret == 0)\r\nlcd->power = power;\r\nelse\r\ndev_warn(lcd->dev, "failed to set power mode %d\n", power);\r\nreturn ret;\r\n}\r\nstatic inline struct ili9320 *to_our_lcd(struct lcd_device *lcd)\r\n{\r\nreturn lcd_get_data(lcd);\r\n}\r\nstatic int ili9320_set_power(struct lcd_device *ld, int power)\r\n{\r\nstruct ili9320 *lcd = to_our_lcd(ld);\r\nreturn ili9320_power(lcd, power);\r\n}\r\nstatic int ili9320_get_power(struct lcd_device *ld)\r\n{\r\nstruct ili9320 *lcd = to_our_lcd(ld);\r\nreturn lcd->power;\r\n}\r\nstatic void ili9320_setup_spi(struct ili9320 *ili,\r\nstruct spi_device *dev)\r\n{\r\nstruct ili9320_spi *spi = &ili->access.spi;\r\nili->write = ili9320_write_spi;\r\nspi->dev = dev;\r\nspi->xfer[0].tx_buf = spi->buffer_addr;\r\nspi->xfer[1].tx_buf = spi->buffer_data;\r\nspi->xfer[0].len = 3;\r\nspi->xfer[1].len = 3;\r\nspi->xfer[0].bits_per_word = 8;\r\nspi->xfer[1].bits_per_word = 8;\r\nspi->xfer[0].cs_change = 1;\r\nspi_message_init(&spi->message);\r\nspi_message_add_tail(&spi->xfer[0], &spi->message);\r\nspi_message_add_tail(&spi->xfer[1], &spi->message);\r\n}\r\nint ili9320_probe_spi(struct spi_device *spi,\r\nstruct ili9320_client *client)\r\n{\r\nstruct ili9320_platdata *cfg = spi->dev.platform_data;\r\nstruct device *dev = &spi->dev;\r\nstruct ili9320 *ili;\r\nstruct lcd_device *lcd;\r\nint ret = 0;\r\nif (cfg == NULL) {\r\ndev_err(dev, "no platform data supplied\n");\r\nreturn -EINVAL;\r\n}\r\nif (cfg->hsize <= 0 || cfg->vsize <= 0 || cfg->reset == NULL) {\r\ndev_err(dev, "invalid platform data supplied\n");\r\nreturn -EINVAL;\r\n}\r\nili = devm_kzalloc(&spi->dev, sizeof(struct ili9320), GFP_KERNEL);\r\nif (ili == NULL) {\r\ndev_err(dev, "no memory for device\n");\r\nreturn -ENOMEM;\r\n}\r\nili->access.spi.id = ILI9320_SPI_IDCODE | ILI9320_SPI_ID(1);\r\nili->dev = dev;\r\nili->client = client;\r\nili->power = FB_BLANK_POWERDOWN;\r\nili->platdata = cfg;\r\nspi_set_drvdata(spi, ili);\r\nili9320_setup_spi(ili, spi);\r\nlcd = lcd_device_register("ili9320", dev, ili, &ili9320_ops);\r\nif (IS_ERR(lcd)) {\r\ndev_err(dev, "failed to register lcd device\n");\r\nreturn PTR_ERR(lcd);\r\n}\r\nili->lcd = lcd;\r\ndev_info(dev, "initialising %s\n", client->name);\r\nret = ili9320_power(ili, FB_BLANK_UNBLANK);\r\nif (ret != 0) {\r\ndev_err(dev, "failed to set lcd power state\n");\r\ngoto err_unregister;\r\n}\r\nreturn 0;\r\nerr_unregister:\r\nlcd_device_unregister(lcd);\r\nreturn ret;\r\n}\r\nint ili9320_remove(struct ili9320 *ili)\r\n{\r\nili9320_power(ili, FB_BLANK_POWERDOWN);\r\nlcd_device_unregister(ili->lcd);\r\nreturn 0;\r\n}\r\nint ili9320_suspend(struct ili9320 *lcd)\r\n{\r\nint ret;\r\nret = ili9320_power(lcd, FB_BLANK_POWERDOWN);\r\nif (lcd->platdata->suspend == ILI9320_SUSPEND_DEEP) {\r\nili9320_write(lcd, ILI9320_POWER1, lcd->power1 |\r\nILI9320_POWER1_SLP |\r\nILI9320_POWER1_DSTB);\r\nlcd->initialised = 0;\r\n}\r\nreturn ret;\r\n}\r\nint ili9320_resume(struct ili9320 *lcd)\r\n{\r\ndev_info(lcd->dev, "resuming from power state %d\n", lcd->power);\r\nif (lcd->platdata->suspend == ILI9320_SUSPEND_DEEP)\r\nili9320_write(lcd, ILI9320_POWER1, 0x00);\r\nreturn ili9320_power(lcd, FB_BLANK_UNBLANK);\r\n}\r\nvoid ili9320_shutdown(struct ili9320 *lcd)\r\n{\r\nili9320_power(lcd, FB_BLANK_POWERDOWN);\r\n}

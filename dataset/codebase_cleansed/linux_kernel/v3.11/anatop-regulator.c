static int anatop_regmap_set_voltage_sel(struct regulator_dev *reg,\r\nunsigned selector)\r\n{\r\nstruct anatop_regulator *anatop_reg = rdev_get_drvdata(reg);\r\nif (!anatop_reg->control_reg)\r\nreturn -ENOTSUPP;\r\nreturn regulator_set_voltage_sel_regmap(reg, selector);\r\n}\r\nstatic int anatop_regmap_set_voltage_time_sel(struct regulator_dev *reg,\r\nunsigned int old_sel,\r\nunsigned int new_sel)\r\n{\r\nstruct anatop_regulator *anatop_reg = rdev_get_drvdata(reg);\r\nu32 val;\r\nint ret = 0;\r\nif (anatop_reg->delay_bit_width && new_sel > old_sel) {\r\nregmap_read(anatop_reg->anatop, anatop_reg->delay_reg, &val);\r\nval = (val >> anatop_reg->delay_bit_shift) &\r\n((1 << anatop_reg->delay_bit_width) - 1);\r\nret = (new_sel - old_sel) * (LDO_RAMP_UP_UNIT_IN_CYCLES <<\r\nval) / LDO_RAMP_UP_FREQ_IN_MHZ + 1;\r\n}\r\nreturn ret;\r\n}\r\nstatic int anatop_regmap_get_voltage_sel(struct regulator_dev *reg)\r\n{\r\nstruct anatop_regulator *anatop_reg = rdev_get_drvdata(reg);\r\nif (!anatop_reg->control_reg)\r\nreturn -ENOTSUPP;\r\nreturn regulator_get_voltage_sel_regmap(reg);\r\n}\r\nstatic int anatop_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *np = dev->of_node;\r\nstruct device_node *anatop_np;\r\nstruct regulator_desc *rdesc;\r\nstruct regulator_dev *rdev;\r\nstruct anatop_regulator *sreg;\r\nstruct regulator_init_data *initdata;\r\nstruct regulator_config config = { };\r\nint ret = 0;\r\ninitdata = of_get_regulator_init_data(dev, np);\r\nsreg = devm_kzalloc(dev, sizeof(*sreg), GFP_KERNEL);\r\nif (!sreg)\r\nreturn -ENOMEM;\r\nsreg->initdata = initdata;\r\nsreg->name = kstrdup(of_get_property(np, "regulator-name", NULL),\r\nGFP_KERNEL);\r\nrdesc = &sreg->rdesc;\r\nmemset(rdesc, 0, sizeof(*rdesc));\r\nrdesc->name = sreg->name;\r\nrdesc->ops = &anatop_rops;\r\nrdesc->type = REGULATOR_VOLTAGE;\r\nrdesc->owner = THIS_MODULE;\r\nanatop_np = of_get_parent(np);\r\nif (!anatop_np)\r\nreturn -ENODEV;\r\nsreg->anatop = syscon_node_to_regmap(anatop_np);\r\nof_node_put(anatop_np);\r\nif (IS_ERR(sreg->anatop))\r\nreturn PTR_ERR(sreg->anatop);\r\nret = of_property_read_u32(np, "anatop-reg-offset",\r\n&sreg->control_reg);\r\nif (ret) {\r\ndev_err(dev, "no anatop-reg-offset property set\n");\r\ngoto anatop_probe_end;\r\n}\r\nret = of_property_read_u32(np, "anatop-vol-bit-width",\r\n&sreg->vol_bit_width);\r\nif (ret) {\r\ndev_err(dev, "no anatop-vol-bit-width property set\n");\r\ngoto anatop_probe_end;\r\n}\r\nret = of_property_read_u32(np, "anatop-vol-bit-shift",\r\n&sreg->vol_bit_shift);\r\nif (ret) {\r\ndev_err(dev, "no anatop-vol-bit-shift property set\n");\r\ngoto anatop_probe_end;\r\n}\r\nret = of_property_read_u32(np, "anatop-min-bit-val",\r\n&sreg->min_bit_val);\r\nif (ret) {\r\ndev_err(dev, "no anatop-min-bit-val property set\n");\r\ngoto anatop_probe_end;\r\n}\r\nret = of_property_read_u32(np, "anatop-min-voltage",\r\n&sreg->min_voltage);\r\nif (ret) {\r\ndev_err(dev, "no anatop-min-voltage property set\n");\r\ngoto anatop_probe_end;\r\n}\r\nret = of_property_read_u32(np, "anatop-max-voltage",\r\n&sreg->max_voltage);\r\nif (ret) {\r\ndev_err(dev, "no anatop-max-voltage property set\n");\r\ngoto anatop_probe_end;\r\n}\r\nof_property_read_u32(np, "anatop-delay-reg-offset",\r\n&sreg->delay_reg);\r\nof_property_read_u32(np, "anatop-delay-bit-width",\r\n&sreg->delay_bit_width);\r\nof_property_read_u32(np, "anatop-delay-bit-shift",\r\n&sreg->delay_bit_shift);\r\nrdesc->n_voltages = (sreg->max_voltage - sreg->min_voltage) / 25000 + 1\r\n+ sreg->min_bit_val;\r\nrdesc->min_uV = sreg->min_voltage;\r\nrdesc->uV_step = 25000;\r\nrdesc->linear_min_sel = sreg->min_bit_val;\r\nrdesc->vsel_reg = sreg->control_reg;\r\nrdesc->vsel_mask = ((1 << sreg->vol_bit_width) - 1) <<\r\nsreg->vol_bit_shift;\r\nconfig.dev = &pdev->dev;\r\nconfig.init_data = initdata;\r\nconfig.driver_data = sreg;\r\nconfig.of_node = pdev->dev.of_node;\r\nconfig.regmap = sreg->anatop;\r\nrdev = regulator_register(rdesc, &config);\r\nif (IS_ERR(rdev)) {\r\ndev_err(dev, "failed to register %s\n",\r\nrdesc->name);\r\nret = PTR_ERR(rdev);\r\ngoto anatop_probe_end;\r\n}\r\nplatform_set_drvdata(pdev, rdev);\r\nanatop_probe_end:\r\nif (ret)\r\nkfree(sreg->name);\r\nreturn ret;\r\n}\r\nstatic int anatop_regulator_remove(struct platform_device *pdev)\r\n{\r\nstruct regulator_dev *rdev = platform_get_drvdata(pdev);\r\nstruct anatop_regulator *sreg = rdev_get_drvdata(rdev);\r\nconst char *name = sreg->name;\r\nregulator_unregister(rdev);\r\nkfree(name);\r\nreturn 0;\r\n}\r\nstatic int __init anatop_regulator_init(void)\r\n{\r\nreturn platform_driver_register(&anatop_regulator_driver);\r\n}\r\nstatic void __exit anatop_regulator_exit(void)\r\n{\r\nplatform_driver_unregister(&anatop_regulator_driver);\r\n}

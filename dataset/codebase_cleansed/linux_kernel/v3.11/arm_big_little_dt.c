static struct device_node *get_cpu_node_with_valid_op(int cpu)\r\n{\r\nstruct device_node *np = NULL, *parent;\r\nint count = 0;\r\nparent = of_find_node_by_path("/cpus");\r\nif (!parent) {\r\npr_err("failed to find OF /cpus\n");\r\nreturn NULL;\r\n}\r\nfor_each_child_of_node(parent, np) {\r\nif (count++ != cpu)\r\ncontinue;\r\nif (!of_get_property(np, "operating-points", NULL)) {\r\nof_node_put(np);\r\nnp = NULL;\r\n}\r\nbreak;\r\n}\r\nof_node_put(parent);\r\nreturn np;\r\n}\r\nstatic int dt_init_opp_table(struct device *cpu_dev)\r\n{\r\nstruct device_node *np;\r\nint ret;\r\nnp = get_cpu_node_with_valid_op(cpu_dev->id);\r\nif (!np)\r\nreturn -ENODATA;\r\ncpu_dev->of_node = np;\r\nret = of_init_opp_table(cpu_dev);\r\nof_node_put(np);\r\nreturn ret;\r\n}\r\nstatic int dt_get_transition_latency(struct device *cpu_dev)\r\n{\r\nstruct device_node *np;\r\nu32 transition_latency = CPUFREQ_ETERNAL;\r\nnp = get_cpu_node_with_valid_op(cpu_dev->id);\r\nif (!np)\r\nreturn CPUFREQ_ETERNAL;\r\nof_property_read_u32(np, "clock-latency", &transition_latency);\r\nof_node_put(np);\r\npr_debug("%s: clock-latency: %d\n", __func__, transition_latency);\r\nreturn transition_latency;\r\n}\r\nstatic int generic_bL_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np;\r\nnp = get_cpu_node_with_valid_op(0);\r\nif (!np)\r\nreturn -ENODEV;\r\nof_node_put(np);\r\nreturn bL_cpufreq_register(&dt_bL_ops);\r\n}\r\nstatic int generic_bL_remove(struct platform_device *pdev)\r\n{\r\nbL_cpufreq_unregister(&dt_bL_ops);\r\nreturn 0;\r\n}

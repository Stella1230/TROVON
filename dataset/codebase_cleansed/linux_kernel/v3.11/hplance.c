static int hplance_init_one(struct dio_dev *d, const struct dio_device_id *ent)\r\n{\r\nstruct net_device *dev;\r\nint err = -ENOMEM;\r\ndev = alloc_etherdev(sizeof(struct hplance_private));\r\nif (!dev)\r\ngoto out;\r\nerr = -EBUSY;\r\nif (!request_mem_region(dio_resource_start(d),\r\ndio_resource_len(d), d->name))\r\ngoto out_free_netdev;\r\nhplance_init(dev, d);\r\nerr = register_netdev(dev);\r\nif (err)\r\ngoto out_release_mem_region;\r\ndio_set_drvdata(d, dev);\r\nprintk(KERN_INFO "%s: %s; select code %d, addr %pM, irq %d\n",\r\ndev->name, d->name, d->scode, dev->dev_addr, d->ipl);\r\nreturn 0;\r\nout_release_mem_region:\r\nrelease_mem_region(dio_resource_start(d), dio_resource_len(d));\r\nout_free_netdev:\r\nfree_netdev(dev);\r\nout:\r\nreturn err;\r\n}\r\nstatic void hplance_remove_one(struct dio_dev *d)\r\n{\r\nstruct net_device *dev = dio_get_drvdata(d);\r\nunregister_netdev(dev);\r\nrelease_mem_region(dio_resource_start(d), dio_resource_len(d));\r\nfree_netdev(dev);\r\n}\r\nstatic void hplance_init(struct net_device *dev, struct dio_dev *d)\r\n{\r\nunsigned long va = (d->resource.start + DIO_VIRADDRBASE);\r\nstruct hplance_private *lp;\r\nint i;\r\nout_8(va+DIO_IDOFF, 0xff);\r\nudelay(100);\r\ndev->base_addr = va;\r\ndev->netdev_ops = &hplance_netdev_ops;\r\ndev->dma = 0;\r\nfor (i=0; i<6; i++) {\r\ndev->dev_addr[i] = ((in_8(va + HPLANCE_NVRAMOFF + i*4 + 1) & 0xF) << 4)\r\n| (in_8(va + HPLANCE_NVRAMOFF + i*4 + 3) & 0xF);\r\n}\r\nlp = netdev_priv(dev);\r\nlp->lance.name = (char*)d->name;\r\nlp->lance.base = va;\r\nlp->lance.init_block = (struct lance_init_block *)(va + HPLANCE_MEMOFF);\r\nlp->lance.lance_init_block = NULL;\r\nlp->lance.busmaster_regval = LE_C3_BSWP;\r\nlp->lance.irq = d->ipl;\r\nlp->lance.writerap = hplance_writerap;\r\nlp->lance.writerdp = hplance_writerdp;\r\nlp->lance.readrdp = hplance_readrdp;\r\nlp->lance.lance_log_rx_bufs = LANCE_LOG_RX_BUFFERS;\r\nlp->lance.lance_log_tx_bufs = LANCE_LOG_TX_BUFFERS;\r\nlp->lance.rx_ring_mod_mask = RX_RING_MOD_MASK;\r\nlp->lance.tx_ring_mod_mask = TX_RING_MOD_MASK;\r\n}\r\nstatic void hplance_writerap(void *priv, unsigned short value)\r\n{\r\nstruct lance_private *lp = (struct lance_private *)priv;\r\ndo {\r\nout_be16(lp->base + HPLANCE_REGOFF + LANCE_RAP, value);\r\n} while ((in_8(lp->base + HPLANCE_STATUS) & LE_ACK) == 0);\r\n}\r\nstatic void hplance_writerdp(void *priv, unsigned short value)\r\n{\r\nstruct lance_private *lp = (struct lance_private *)priv;\r\ndo {\r\nout_be16(lp->base + HPLANCE_REGOFF + LANCE_RDP, value);\r\n} while ((in_8(lp->base + HPLANCE_STATUS) & LE_ACK) == 0);\r\n}\r\nstatic unsigned short hplance_readrdp(void *priv)\r\n{\r\nstruct lance_private *lp = (struct lance_private *)priv;\r\n__u16 value;\r\ndo {\r\nvalue = in_be16(lp->base + HPLANCE_REGOFF + LANCE_RDP);\r\n} while ((in_8(lp->base + HPLANCE_STATUS) & LE_ACK) == 0);\r\nreturn value;\r\n}\r\nstatic int hplance_open(struct net_device *dev)\r\n{\r\nint status;\r\nstruct lance_private *lp = netdev_priv(dev);\r\nstatus = lance_open(dev);\r\nif (status)\r\nreturn status;\r\nout_8(lp->base + HPLANCE_STATUS, LE_IE);\r\nreturn 0;\r\n}\r\nstatic int hplance_close(struct net_device *dev)\r\n{\r\nstruct lance_private *lp = netdev_priv(dev);\r\nout_8(lp->base + HPLANCE_STATUS, 0);\r\nlance_close(dev);\r\nreturn 0;\r\n}\r\nstatic int __init hplance_init_module(void)\r\n{\r\nreturn dio_register_driver(&hplance_driver);\r\n}\r\nstatic void __exit hplance_cleanup_module(void)\r\n{\r\ndio_unregister_driver(&hplance_driver);\r\n}

static inline u8 amd_offset(struct pci_dev *dev)\r\n{\r\nreturn (dev->vendor == PCI_VENDOR_ID_NVIDIA) ? 0x10 : 0;\r\n}\r\nstatic void amd_set_speed(struct pci_dev *dev, u8 dn, u8 udma_mask,\r\nstruct ide_timing *timing)\r\n{\r\nu8 t = 0, offset = amd_offset(dev);\r\npci_read_config_byte(dev, AMD_ADDRESS_SETUP + offset, &t);\r\nt = (t & ~(3 << ((3 - dn) << 1))) | ((clamp_val(timing->setup, 1, 4) - 1) << ((3 - dn) << 1));\r\npci_write_config_byte(dev, AMD_ADDRESS_SETUP + offset, t);\r\npci_write_config_byte(dev, AMD_8BIT_TIMING + offset + (1 - (dn >> 1)),\r\n((clamp_val(timing->act8b, 1, 16) - 1) << 4) | (clamp_val(timing->rec8b, 1, 16) - 1));\r\npci_write_config_byte(dev, AMD_DRIVE_TIMING + offset + (3 - dn),\r\n((clamp_val(timing->active, 1, 16) - 1) << 4) | (clamp_val(timing->recover, 1, 16) - 1));\r\nswitch (udma_mask) {\r\ncase ATA_UDMA2: t = timing->udma ? (0xc0 | (clamp_val(timing->udma, 2, 5) - 2)) : 0x03; break;\r\ncase ATA_UDMA4: t = timing->udma ? (0xc0 | amd_cyc2udma[clamp_val(timing->udma, 2, 10)]) : 0x03; break;\r\ncase ATA_UDMA5: t = timing->udma ? (0xc0 | amd_cyc2udma[clamp_val(timing->udma, 1, 10)]) : 0x03; break;\r\ncase ATA_UDMA6: t = timing->udma ? (0xc0 | amd_cyc2udma[clamp_val(timing->udma, 1, 15)]) : 0x03; break;\r\ndefault: return;\r\n}\r\nif (timing->udma)\r\npci_write_config_byte(dev, AMD_UDMA_TIMING + offset + 3 - dn, t);\r\n}\r\nstatic void amd_set_drive(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nide_drive_t *peer = ide_get_pair_dev(drive);\r\nstruct ide_timing t, p;\r\nint T, UT;\r\nu8 udma_mask = hwif->ultra_mask;\r\nconst u8 speed = drive->dma_mode;\r\nT = 1000000000 / amd_clock;\r\nUT = (udma_mask == ATA_UDMA2) ? T : (T / 2);\r\nide_timing_compute(drive, speed, &t, T, UT);\r\nif (peer) {\r\nide_timing_compute(peer, peer->pio_mode, &p, T, UT);\r\nide_timing_merge(&p, &t, &t, IDE_TIMING_8BIT);\r\n}\r\nif (speed == XFER_UDMA_5 && amd_clock <= 33333) t.udma = 1;\r\nif (speed == XFER_UDMA_6 && amd_clock <= 33333) t.udma = 15;\r\namd_set_speed(dev, drive->dn, udma_mask, &t);\r\n}\r\nstatic void amd_set_pio_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\ndrive->dma_mode = drive->pio_mode;\r\namd_set_drive(hwif, drive);\r\n}\r\nstatic void amd7409_cable_detect(struct pci_dev *dev)\r\n{\r\namd_80w = 0x03;\r\n}\r\nstatic void amd7411_cable_detect(struct pci_dev *dev)\r\n{\r\nint i;\r\nu32 u = 0;\r\nu8 t = 0, offset = amd_offset(dev);\r\npci_read_config_byte(dev, AMD_CABLE_DETECT + offset, &t);\r\npci_read_config_dword(dev, AMD_UDMA_TIMING + offset, &u);\r\namd_80w = ((t & 0x3) ? 1 : 0) | ((t & 0xc) ? 2 : 0);\r\nfor (i = 24; i >= 0; i -= 8)\r\nif (((u >> i) & 4) && !(amd_80w & (1 << (1 - (i >> 4))))) {\r\nprintk(KERN_WARNING DRV_NAME " %s: BIOS didn't set "\r\n"cable bits correctly. Enabling workaround.\n",\r\npci_name(dev));\r\namd_80w |= (1 << (1 - (i >> 4)));\r\n}\r\n}\r\nstatic int init_chipset_amd74xx(struct pci_dev *dev)\r\n{\r\nu8 t = 0, offset = amd_offset(dev);\r\nif (dev->vendor == PCI_VENDOR_ID_AMD &&\r\ndev->device == PCI_DEVICE_ID_AMD_COBRA_7401)\r\n;\r\nelse if (dev->vendor == PCI_VENDOR_ID_AMD &&\r\ndev->device == PCI_DEVICE_ID_AMD_VIPER_7409)\r\namd7409_cable_detect(dev);\r\nelse\r\namd7411_cable_detect(dev);\r\npci_read_config_byte(dev, AMD_IDE_CONFIG + offset, &t);\r\nif (dev->vendor == PCI_VENDOR_ID_AMD &&\r\ndev->device == PCI_DEVICE_ID_AMD_VIPER_7411)\r\nt &= 0x0f;\r\nelse\r\nt |= 0xf0;\r\npci_write_config_byte(dev, AMD_IDE_CONFIG + offset, t);\r\nreturn 0;\r\n}\r\nstatic u8 amd_cable_detect(ide_hwif_t *hwif)\r\n{\r\nif ((amd_80w >> hwif->channel) & 1)\r\nreturn ATA_CBL_PATA80;\r\nelse\r\nreturn ATA_CBL_PATA40;\r\n}\r\nstatic int amd74xx_probe(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nstruct ide_port_info d;\r\nu8 idx = id->driver_data;\r\nd = amd74xx_chipsets[idx];\r\nif (idx == 1) {\r\nif (dev->revision <= 7)\r\nd.swdma_mask = 0;\r\nd.host_flags |= IDE_HFLAG_CLEAR_SIMPLEX;\r\n} else if (idx == 3) {\r\nif (dev->subsystem_vendor == PCI_VENDOR_ID_AMD &&\r\ndev->subsystem_device == PCI_DEVICE_ID_AMD_SERENADE)\r\nd.udma_mask = ATA_UDMA5;\r\n}\r\nif (dev->vendor == PCI_VENDOR_ID_NVIDIA &&\r\nide_pci_is_in_compatibility_mode(dev))\r\nd.host_flags |= IDE_HFLAG_BROKEN_ALTSTATUS;\r\nprintk(KERN_INFO "%s %s: UDMA%s controller\n",\r\nd.name, pci_name(dev), amd_dma[fls(d.udma_mask) - 1]);\r\namd_clock = (ide_pci_clk ? ide_pci_clk : 33) * 1000;\r\nswitch (amd_clock) {\r\ncase 33000: amd_clock = 33333; break;\r\ncase 37000: amd_clock = 37500; break;\r\ncase 41000: amd_clock = 41666; break;\r\n}\r\nif (amd_clock < 20000 || amd_clock > 50000) {\r\nprintk(KERN_WARNING "%s: User given PCI clock speed impossible"\r\n" (%d), using 33 MHz instead.\n",\r\nd.name, amd_clock);\r\namd_clock = 33333;\r\n}\r\nreturn ide_pci_init_one(dev, &d, NULL);\r\n}\r\nstatic int __init amd74xx_ide_init(void)\r\n{\r\nreturn ide_pci_register_driver(&amd74xx_pci_driver);\r\n}\r\nstatic void __exit amd74xx_ide_exit(void)\r\n{\r\npci_unregister_driver(&amd74xx_pci_driver);\r\n}

static int max8907_regulator_parse_dt(struct platform_device *pdev)\r\n{\r\nstruct device_node *np, *regulators;\r\nint ret;\r\nnp = of_node_get(pdev->dev.parent->of_node);\r\nif (!np)\r\nreturn 0;\r\nregulators = of_find_node_by_name(np, "regulators");\r\nif (!regulators) {\r\ndev_err(&pdev->dev, "regulators node not found\n");\r\nreturn -EINVAL;\r\n}\r\nret = of_regulator_match(&pdev->dev, regulators, max8907_matches,\r\nARRAY_SIZE(max8907_matches));\r\nof_node_put(regulators);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Error parsing regulator init data: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic inline struct regulator_init_data *match_init_data(int index)\r\n{\r\nreturn max8907_matches[index].init_data;\r\n}\r\nstatic inline struct device_node *match_of_node(int index)\r\n{\r\nreturn max8907_matches[index].of_node;\r\n}\r\nstatic int max8907_regulator_parse_dt(struct platform_device *pdev)\r\n{\r\nreturn 0;\r\n}\r\nstatic inline struct regulator_init_data *match_init_data(int index)\r\n{\r\nreturn NULL;\r\n}\r\nstatic inline struct device_node *match_of_node(int index)\r\n{\r\nreturn NULL;\r\n}\r\nstatic int max8907_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct max8907 *max8907 = dev_get_drvdata(pdev->dev.parent);\r\nstruct max8907_platform_data *pdata = dev_get_platdata(max8907->dev);\r\nint ret;\r\nstruct max8907_regulator *pmic;\r\nunsigned int val;\r\nint i;\r\nstruct regulator_config config = {};\r\nstruct regulator_init_data *idata;\r\nconst char *mbatt_rail_name = NULL;\r\nret = max8907_regulator_parse_dt(pdev);\r\nif (ret)\r\nreturn ret;\r\npmic = devm_kzalloc(&pdev->dev, sizeof(*pmic), GFP_KERNEL);\r\nif (!pmic) {\r\ndev_err(&pdev->dev, "Failed to alloc pmic\n");\r\nreturn -ENOMEM;\r\n}\r\nplatform_set_drvdata(pdev, pmic);\r\nmemcpy(pmic->desc, max8907_regulators, sizeof(pmic->desc));\r\nregmap_read(max8907->regmap_gen, MAX8907_REG_II2RR, &val);\r\nif ((val & MAX8907_II2RR_VERSION_MASK) ==\r\nMAX8907_II2RR_VERSION_REV_B) {\r\npmic->desc[MAX8907_SD1].min_uV = 637500;\r\npmic->desc[MAX8907_SD1].uV_step = 12500;\r\npmic->desc[MAX8907_SD1].n_voltages =\r\n(1425000 - 637500) / 12500 + 1;\r\n}\r\nfor (i = 0; i < MAX8907_NUM_REGULATORS; i++) {\r\nconfig.dev = pdev->dev.parent;\r\nif (pdata)\r\nidata = pdata->init_data[i];\r\nelse\r\nidata = match_init_data(i);\r\nconfig.init_data = idata;\r\nconfig.driver_data = pmic;\r\nconfig.regmap = max8907->regmap_gen;\r\nconfig.of_node = match_of_node(i);\r\nswitch (pmic->desc[i].id) {\r\ncase MAX8907_MBATT:\r\nif (idata && idata->constraints.name)\r\nmbatt_rail_name = idata->constraints.name;\r\nelse\r\nmbatt_rail_name = pmic->desc[i].name;\r\nbreak;\r\ncase MAX8907_BBAT:\r\ncase MAX8907_SDBY:\r\ncase MAX8907_VRTC:\r\nidata->supply_regulator = mbatt_rail_name;\r\nbreak;\r\n}\r\nif (pmic->desc[i].ops == &max8907_ldo_ops) {\r\nregmap_read(config.regmap, pmic->desc[i].enable_reg,\r\n&val);\r\nif ((val & MAX8907_MASK_LDO_SEQ) !=\r\nMAX8907_MASK_LDO_SEQ)\r\npmic->desc[i].ops = &max8907_ldo_hwctl_ops;\r\n} else if (pmic->desc[i].ops == &max8907_out5v_ops) {\r\nregmap_read(config.regmap, pmic->desc[i].enable_reg,\r\n&val);\r\nif ((val & (MAX8907_MASK_OUT5V_VINEN |\r\nMAX8907_MASK_OUT5V_ENSRC)) !=\r\nMAX8907_MASK_OUT5V_ENSRC)\r\npmic->desc[i].ops = &max8907_out5v_hwctl_ops;\r\n}\r\npmic->rdev[i] = regulator_register(&pmic->desc[i], &config);\r\nif (IS_ERR(pmic->rdev[i])) {\r\ndev_err(&pdev->dev,\r\n"failed to register %s regulator\n",\r\npmic->desc[i].name);\r\nret = PTR_ERR(pmic->rdev[i]);\r\ngoto err_unregister_regulator;\r\n}\r\n}\r\nreturn 0;\r\nerr_unregister_regulator:\r\nwhile (--i >= 0)\r\nregulator_unregister(pmic->rdev[i]);\r\nreturn ret;\r\n}\r\nstatic int max8907_regulator_remove(struct platform_device *pdev)\r\n{\r\nstruct max8907_regulator *pmic = platform_get_drvdata(pdev);\r\nint i;\r\nfor (i = 0; i < MAX8907_NUM_REGULATORS; i++)\r\nregulator_unregister(pmic->rdev[i]);\r\nreturn 0;\r\n}\r\nstatic int __init max8907_regulator_init(void)\r\n{\r\nreturn platform_driver_register(&max8907_regulator_driver);\r\n}\r\nstatic void __exit max8907_reg_exit(void)\r\n{\r\nplatform_driver_unregister(&max8907_regulator_driver);\r\n}

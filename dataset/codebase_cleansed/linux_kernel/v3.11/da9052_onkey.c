static void da9052_onkey_query(struct da9052_onkey *onkey)\r\n{\r\nint key_stat;\r\nkey_stat = da9052_reg_read(onkey->da9052, DA9052_EVENT_B_REG);\r\nif (key_stat < 0) {\r\ndev_err(onkey->da9052->dev,\r\n"Failed to read onkey event %d\n", key_stat);\r\n} else {\r\nkey_stat &= DA9052_EVENTB_ENONKEY;\r\ninput_report_key(onkey->input, KEY_POWER, key_stat);\r\ninput_sync(onkey->input);\r\n}\r\nif (key_stat)\r\nschedule_delayed_work(&onkey->work, msecs_to_jiffies(50));\r\n}\r\nstatic void da9052_onkey_work(struct work_struct *work)\r\n{\r\nstruct da9052_onkey *onkey = container_of(work, struct da9052_onkey,\r\nwork.work);\r\nda9052_onkey_query(onkey);\r\n}\r\nstatic irqreturn_t da9052_onkey_irq(int irq, void *data)\r\n{\r\nstruct da9052_onkey *onkey = data;\r\nda9052_onkey_query(onkey);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int da9052_onkey_probe(struct platform_device *pdev)\r\n{\r\nstruct da9052 *da9052 = dev_get_drvdata(pdev->dev.parent);\r\nstruct da9052_onkey *onkey;\r\nstruct input_dev *input_dev;\r\nint error;\r\nif (!da9052) {\r\ndev_err(&pdev->dev, "Failed to get the driver's data\n");\r\nreturn -EINVAL;\r\n}\r\nonkey = kzalloc(sizeof(*onkey), GFP_KERNEL);\r\ninput_dev = input_allocate_device();\r\nif (!onkey || !input_dev) {\r\ndev_err(&pdev->dev, "Failed to allocate memory\n");\r\nerror = -ENOMEM;\r\ngoto err_free_mem;\r\n}\r\nonkey->input = input_dev;\r\nonkey->da9052 = da9052;\r\nINIT_DELAYED_WORK(&onkey->work, da9052_onkey_work);\r\ninput_dev->name = "da9052-onkey";\r\ninput_dev->phys = "da9052-onkey/input0";\r\ninput_dev->dev.parent = &pdev->dev;\r\ninput_dev->evbit[0] = BIT_MASK(EV_KEY);\r\n__set_bit(KEY_POWER, input_dev->keybit);\r\nerror = da9052_request_irq(onkey->da9052, DA9052_IRQ_NONKEY, "ONKEY",\r\nda9052_onkey_irq, onkey);\r\nif (error < 0) {\r\ndev_err(onkey->da9052->dev,\r\n"Failed to register ONKEY IRQ: %d\n", error);\r\ngoto err_free_mem;\r\n}\r\nerror = input_register_device(onkey->input);\r\nif (error) {\r\ndev_err(&pdev->dev, "Unable to register input device, %d\n",\r\nerror);\r\ngoto err_free_irq;\r\n}\r\nplatform_set_drvdata(pdev, onkey);\r\nreturn 0;\r\nerr_free_irq:\r\nda9052_free_irq(onkey->da9052, DA9052_IRQ_NONKEY, onkey);\r\ncancel_delayed_work_sync(&onkey->work);\r\nerr_free_mem:\r\ninput_free_device(input_dev);\r\nkfree(onkey);\r\nreturn error;\r\n}\r\nstatic int da9052_onkey_remove(struct platform_device *pdev)\r\n{\r\nstruct da9052_onkey *onkey = platform_get_drvdata(pdev);\r\nda9052_free_irq(onkey->da9052, DA9052_IRQ_NONKEY, onkey);\r\ncancel_delayed_work_sync(&onkey->work);\r\ninput_unregister_device(onkey->input);\r\nkfree(onkey);\r\nreturn 0;\r\n}

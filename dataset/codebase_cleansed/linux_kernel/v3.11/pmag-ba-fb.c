static inline void dac_write(struct pmagbafb_par *par, unsigned int reg, u8 v)\r\n{\r\nwriteb(v, par->dac + reg / 4);\r\n}\r\nstatic inline u8 dac_read(struct pmagbafb_par *par, unsigned int reg)\r\n{\r\nreturn readb(par->dac + reg / 4);\r\n}\r\nstatic int pmagbafb_setcolreg(unsigned int regno, unsigned int red,\r\nunsigned int green, unsigned int blue,\r\nunsigned int transp, struct fb_info *info)\r\n{\r\nstruct pmagbafb_par *par = info->par;\r\nif (regno >= info->cmap.len)\r\nreturn 1;\r\nred >>= 8;\r\ngreen >>= 8;\r\nblue >>= 8;\r\nmb();\r\ndac_write(par, BT459_ADDR_LO, regno);\r\ndac_write(par, BT459_ADDR_HI, 0x00);\r\nwmb();\r\ndac_write(par, BT459_CMAP, red);\r\nwmb();\r\ndac_write(par, BT459_CMAP, green);\r\nwmb();\r\ndac_write(par, BT459_CMAP, blue);\r\nreturn 0;\r\n}\r\nstatic void __init pmagbafb_erase_cursor(struct fb_info *info)\r\n{\r\nstruct pmagbafb_par *par = info->par;\r\nmb();\r\ndac_write(par, BT459_ADDR_LO, 0x00);\r\ndac_write(par, BT459_ADDR_HI, 0x03);\r\nwmb();\r\ndac_write(par, BT459_DATA, 0x00);\r\n}\r\nstatic int pmagbafb_probe(struct device *dev)\r\n{\r\nstruct tc_dev *tdev = to_tc_dev(dev);\r\nresource_size_t start, len;\r\nstruct fb_info *info;\r\nstruct pmagbafb_par *par;\r\nint err;\r\ninfo = framebuffer_alloc(sizeof(struct pmagbafb_par), dev);\r\nif (!info) {\r\nprintk(KERN_ERR "%s: Cannot allocate memory\n", dev_name(dev));\r\nreturn -ENOMEM;\r\n}\r\npar = info->par;\r\ndev_set_drvdata(dev, info);\r\nif (fb_alloc_cmap(&info->cmap, 256, 0) < 0) {\r\nprintk(KERN_ERR "%s: Cannot allocate color map\n",\r\ndev_name(dev));\r\nerr = -ENOMEM;\r\ngoto err_alloc;\r\n}\r\ninfo->fbops = &pmagbafb_ops;\r\ninfo->fix = pmagbafb_fix;\r\ninfo->var = pmagbafb_defined;\r\ninfo->flags = FBINFO_DEFAULT;\r\nstart = tdev->resource.start;\r\nlen = tdev->resource.end - start + 1;\r\nif (!request_mem_region(start, len, dev_name(dev))) {\r\nprintk(KERN_ERR "%s: Cannot reserve FB region\n",\r\ndev_name(dev));\r\nerr = -EBUSY;\r\ngoto err_cmap;\r\n}\r\ninfo->fix.mmio_start = start;\r\npar->mmio = ioremap_nocache(info->fix.mmio_start, info->fix.mmio_len);\r\nif (!par->mmio) {\r\nprintk(KERN_ERR "%s: Cannot map MMIO\n", dev_name(dev));\r\nerr = -ENOMEM;\r\ngoto err_resource;\r\n}\r\npar->dac = par->mmio + PMAG_BA_BT459;\r\ninfo->fix.smem_start = start + PMAG_BA_FBMEM;\r\ninfo->screen_base = ioremap_nocache(info->fix.smem_start,\r\ninfo->fix.smem_len);\r\nif (!info->screen_base) {\r\nprintk(KERN_ERR "%s: Cannot map FB\n", dev_name(dev));\r\nerr = -ENOMEM;\r\ngoto err_mmio_map;\r\n}\r\ninfo->screen_size = info->fix.smem_len;\r\npmagbafb_erase_cursor(info);\r\nerr = register_framebuffer(info);\r\nif (err < 0) {\r\nprintk(KERN_ERR "%s: Cannot register framebuffer\n",\r\ndev_name(dev));\r\ngoto err_smem_map;\r\n}\r\nget_device(dev);\r\npr_info("fb%d: %s frame buffer device at %s\n",\r\ninfo->node, info->fix.id, dev_name(dev));\r\nreturn 0;\r\nerr_smem_map:\r\niounmap(info->screen_base);\r\nerr_mmio_map:\r\niounmap(par->mmio);\r\nerr_resource:\r\nrelease_mem_region(start, len);\r\nerr_cmap:\r\nfb_dealloc_cmap(&info->cmap);\r\nerr_alloc:\r\nframebuffer_release(info);\r\nreturn err;\r\n}\r\nstatic int __exit pmagbafb_remove(struct device *dev)\r\n{\r\nstruct tc_dev *tdev = to_tc_dev(dev);\r\nstruct fb_info *info = dev_get_drvdata(dev);\r\nstruct pmagbafb_par *par = info->par;\r\nresource_size_t start, len;\r\nput_device(dev);\r\nunregister_framebuffer(info);\r\niounmap(info->screen_base);\r\niounmap(par->mmio);\r\nstart = tdev->resource.start;\r\nlen = tdev->resource.end - start + 1;\r\nrelease_mem_region(start, len);\r\nfb_dealloc_cmap(&info->cmap);\r\nframebuffer_release(info);\r\nreturn 0;\r\n}\r\nstatic int __init pmagbafb_init(void)\r\n{\r\n#ifndef MODULE\r\nif (fb_get_options("pmagbafb", NULL))\r\nreturn -ENXIO;\r\n#endif\r\nreturn tc_register_driver(&pmagbafb_driver);\r\n}\r\nstatic void __exit pmagbafb_exit(void)\r\n{\r\ntc_unregister_driver(&pmagbafb_driver);\r\n}

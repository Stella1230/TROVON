static cycle_t txx9_cs_read(struct clocksource *cs)\r\n{\r\nstruct txx9_clocksource *txx9_cs =\r\ncontainer_of(cs, struct txx9_clocksource, cs);\r\nreturn __raw_readl(&txx9_cs->tmrptr->trr);\r\n}\r\nvoid __init txx9_clocksource_init(unsigned long baseaddr,\r\nunsigned int imbusclk)\r\n{\r\nstruct txx9_tmr_reg __iomem *tmrptr;\r\nclocksource_register_hz(&txx9_clocksource.cs, TIMER_CLK(imbusclk));\r\ntmrptr = ioremap(baseaddr, sizeof(struct txx9_tmr_reg));\r\n__raw_writel(TCR_BASE, &tmrptr->tcr);\r\n__raw_writel(0, &tmrptr->tisr);\r\n__raw_writel(TIMER_CCD, &tmrptr->ccdr);\r\n__raw_writel(TXx9_TMITMR_TZCE, &tmrptr->itmr);\r\n__raw_writel(1 << TXX9_CLOCKSOURCE_BITS, &tmrptr->cpra);\r\n__raw_writel(TCR_BASE | TXx9_TMTCR_TCE, &tmrptr->tcr);\r\ntxx9_clocksource.tmrptr = tmrptr;\r\n}\r\nstatic void txx9tmr_stop_and_clear(struct txx9_tmr_reg __iomem *tmrptr)\r\n{\r\n__raw_writel(TCR_BASE, &tmrptr->tcr);\r\n__raw_writel(0, &tmrptr->tisr);\r\n}\r\nstatic void txx9tmr_set_mode(enum clock_event_mode mode,\r\nstruct clock_event_device *evt)\r\n{\r\nstruct txx9_clock_event_device *txx9_cd =\r\ncontainer_of(evt, struct txx9_clock_event_device, cd);\r\nstruct txx9_tmr_reg __iomem *tmrptr = txx9_cd->tmrptr;\r\ntxx9tmr_stop_and_clear(tmrptr);\r\nswitch (mode) {\r\ncase CLOCK_EVT_MODE_PERIODIC:\r\n__raw_writel(TXx9_TMITMR_TIIE | TXx9_TMITMR_TZCE,\r\n&tmrptr->itmr);\r\n__raw_writel(((u64)(NSEC_PER_SEC / HZ) * evt->mult) >>\r\nevt->shift,\r\n&tmrptr->cpra);\r\n__raw_writel(TCR_BASE | TXx9_TMTCR_TCE, &tmrptr->tcr);\r\nbreak;\r\ncase CLOCK_EVT_MODE_SHUTDOWN:\r\ncase CLOCK_EVT_MODE_UNUSED:\r\n__raw_writel(0, &tmrptr->itmr);\r\nbreak;\r\ncase CLOCK_EVT_MODE_ONESHOT:\r\n__raw_writel(TXx9_TMITMR_TIIE, &tmrptr->itmr);\r\nbreak;\r\ncase CLOCK_EVT_MODE_RESUME:\r\n__raw_writel(TIMER_CCD, &tmrptr->ccdr);\r\n__raw_writel(0, &tmrptr->itmr);\r\nbreak;\r\n}\r\n}\r\nstatic int txx9tmr_set_next_event(unsigned long delta,\r\nstruct clock_event_device *evt)\r\n{\r\nstruct txx9_clock_event_device *txx9_cd =\r\ncontainer_of(evt, struct txx9_clock_event_device, cd);\r\nstruct txx9_tmr_reg __iomem *tmrptr = txx9_cd->tmrptr;\r\ntxx9tmr_stop_and_clear(tmrptr);\r\n__raw_writel(delta, &tmrptr->cpra);\r\n__raw_writel(TCR_BASE | TXx9_TMTCR_TCE, &tmrptr->tcr);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t txx9tmr_interrupt(int irq, void *dev_id)\r\n{\r\nstruct txx9_clock_event_device *txx9_cd = dev_id;\r\nstruct clock_event_device *cd = &txx9_cd->cd;\r\nstruct txx9_tmr_reg __iomem *tmrptr = txx9_cd->tmrptr;\r\n__raw_writel(0, &tmrptr->tisr);\r\ncd->event_handler(cd);\r\nreturn IRQ_HANDLED;\r\n}\r\nvoid __init txx9_clockevent_init(unsigned long baseaddr, int irq,\r\nunsigned int imbusclk)\r\n{\r\nstruct clock_event_device *cd = &txx9_clock_event_device.cd;\r\nstruct txx9_tmr_reg __iomem *tmrptr;\r\ntmrptr = ioremap(baseaddr, sizeof(struct txx9_tmr_reg));\r\ntxx9tmr_stop_and_clear(tmrptr);\r\n__raw_writel(TIMER_CCD, &tmrptr->ccdr);\r\n__raw_writel(0, &tmrptr->itmr);\r\ntxx9_clock_event_device.tmrptr = tmrptr;\r\nclockevent_set_clock(cd, TIMER_CLK(imbusclk));\r\ncd->max_delta_ns =\r\nclockevent_delta2ns(0xffffffff >> (32 - TXX9_TIMER_BITS), cd);\r\ncd->min_delta_ns = clockevent_delta2ns(0xf, cd);\r\ncd->irq = irq;\r\ncd->cpumask = cpumask_of(0),\r\nclockevents_register_device(cd);\r\nsetup_irq(irq, &txx9tmr_irq);\r\nprintk(KERN_INFO "TXx9: clockevent device at 0x%lx, irq %d\n",\r\nbaseaddr, irq);\r\n}\r\nvoid __init txx9_tmr_init(unsigned long baseaddr)\r\n{\r\nstruct txx9_tmr_reg __iomem *tmrptr;\r\ntmrptr = ioremap(baseaddr, sizeof(struct txx9_tmr_reg));\r\n__raw_writel(TXx9_TMTCR_CRE | TXx9_TMTCR_TCE, &tmrptr->tcr);\r\n__raw_writel(TXx9_TMTCR_CRE, &tmrptr->tcr);\r\n__raw_writel(0, &tmrptr->tisr);\r\n__raw_writel(0xffffffff, &tmrptr->cpra);\r\n__raw_writel(0, &tmrptr->itmr);\r\n__raw_writel(0, &tmrptr->ccdr);\r\n__raw_writel(0, &tmrptr->pgmr);\r\niounmap(tmrptr);\r\n}

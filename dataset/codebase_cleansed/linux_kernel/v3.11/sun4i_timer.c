static void sun4i_clkevt_mode(enum clock_event_mode mode,\r\nstruct clock_event_device *clk)\r\n{\r\nu32 u = readl(timer_base + TIMER_CTL_REG(0));\r\nswitch (mode) {\r\ncase CLOCK_EVT_MODE_PERIODIC:\r\nu &= ~(TIMER_CTL_ONESHOT);\r\nwritel(u | TIMER_CTL_ENABLE, timer_base + TIMER_CTL_REG(0));\r\nbreak;\r\ncase CLOCK_EVT_MODE_ONESHOT:\r\nwritel(u | TIMER_CTL_ONESHOT, timer_base + TIMER_CTL_REG(0));\r\nbreak;\r\ncase CLOCK_EVT_MODE_UNUSED:\r\ncase CLOCK_EVT_MODE_SHUTDOWN:\r\ndefault:\r\nwritel(u & ~(TIMER_CTL_ENABLE), timer_base + TIMER_CTL_REG(0));\r\nbreak;\r\n}\r\n}\r\nstatic int sun4i_clkevt_next_event(unsigned long evt,\r\nstruct clock_event_device *unused)\r\n{\r\nu32 u = readl(timer_base + TIMER_CTL_REG(0));\r\nwritel(evt, timer_base + TIMER_CNTVAL_REG(0));\r\nwritel(u | TIMER_CTL_ENABLE | TIMER_CTL_AUTORELOAD,\r\ntimer_base + TIMER_CTL_REG(0));\r\nreturn 0;\r\n}\r\nstatic irqreturn_t sun4i_timer_interrupt(int irq, void *dev_id)\r\n{\r\nstruct clock_event_device *evt = (struct clock_event_device *)dev_id;\r\nwritel(0x1, timer_base + TIMER_IRQ_ST_REG);\r\nevt->event_handler(evt);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void __init sun4i_timer_init(struct device_node *node)\r\n{\r\nunsigned long rate = 0;\r\nstruct clk *clk;\r\nint ret, irq;\r\nu32 val;\r\ntimer_base = of_iomap(node, 0);\r\nif (!timer_base)\r\npanic("Can't map registers");\r\nirq = irq_of_parse_and_map(node, 0);\r\nif (irq <= 0)\r\npanic("Can't parse IRQ");\r\nclk = of_clk_get(node, 0);\r\nif (IS_ERR(clk))\r\npanic("Can't get timer clock");\r\nrate = clk_get_rate(clk);\r\nwritel(rate / (TIMER_SCAL * HZ),\r\ntimer_base + TIMER_INTVAL_REG(0));\r\nval = readl(timer_base + TIMER_CTL_REG(0));\r\nval &= ~(0x07 << 4);\r\nval &= ~(0x03 << 2);\r\nval |= (4 << 4) | (1 << 2);\r\nwritel(val, timer_base + TIMER_CTL_REG(0));\r\nval = readl(timer_base + TIMER_CTL_REG(0));\r\nwritel(val | TIMER_CTL_AUTORELOAD, timer_base + TIMER_CTL_REG(0));\r\nret = setup_irq(irq, &sun4i_timer_irq);\r\nif (ret)\r\npr_warn("failed to setup irq %d\n", irq);\r\nval = readl(timer_base + TIMER_IRQ_EN_REG);\r\nwritel(val | TIMER_IRQ_EN(0), timer_base + TIMER_IRQ_EN_REG);\r\nsun4i_clockevent.cpumask = cpumask_of(0);\r\nclockevents_config_and_register(&sun4i_clockevent, rate / TIMER_SCAL,\r\n0x1, 0xff);\r\n}

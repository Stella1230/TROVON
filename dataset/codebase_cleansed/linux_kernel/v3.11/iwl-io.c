int iwl_poll_bit(struct iwl_trans *trans, u32 addr,\r\nu32 bits, u32 mask, int timeout)\r\n{\r\nint t = 0;\r\ndo {\r\nif ((iwl_read32(trans, addr) & mask) == (bits & mask))\r\nreturn t;\r\nudelay(IWL_POLL_INTERVAL);\r\nt += IWL_POLL_INTERVAL;\r\n} while (t < timeout);\r\nreturn -ETIMEDOUT;\r\n}\r\nu32 iwl_read_direct32(struct iwl_trans *trans, u32 reg)\r\n{\r\nu32 value = 0x5a5a5a5a;\r\nunsigned long flags;\r\nif (iwl_trans_grab_nic_access(trans, false, &flags)) {\r\nvalue = iwl_read32(trans, reg);\r\niwl_trans_release_nic_access(trans, &flags);\r\n}\r\nreturn value;\r\n}\r\nvoid iwl_write_direct32(struct iwl_trans *trans, u32 reg, u32 value)\r\n{\r\nunsigned long flags;\r\nif (iwl_trans_grab_nic_access(trans, false, &flags)) {\r\niwl_write32(trans, reg, value);\r\niwl_trans_release_nic_access(trans, &flags);\r\n}\r\n}\r\nint iwl_poll_direct_bit(struct iwl_trans *trans, u32 addr, u32 mask,\r\nint timeout)\r\n{\r\nint t = 0;\r\ndo {\r\nif ((iwl_read_direct32(trans, addr) & mask) == mask)\r\nreturn t;\r\nudelay(IWL_POLL_INTERVAL);\r\nt += IWL_POLL_INTERVAL;\r\n} while (t < timeout);\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic inline u32 __iwl_read_prph(struct iwl_trans *trans, u32 ofs)\r\n{\r\nu32 val = iwl_trans_read_prph(trans, ofs);\r\ntrace_iwlwifi_dev_ioread_prph32(trans->dev, ofs, val);\r\nreturn val;\r\n}\r\nstatic inline void __iwl_write_prph(struct iwl_trans *trans, u32 ofs, u32 val)\r\n{\r\ntrace_iwlwifi_dev_iowrite_prph32(trans->dev, ofs, val);\r\niwl_trans_write_prph(trans, ofs, val);\r\n}\r\nu32 iwl_read_prph(struct iwl_trans *trans, u32 ofs)\r\n{\r\nunsigned long flags;\r\nu32 val = 0x5a5a5a5a;\r\nif (iwl_trans_grab_nic_access(trans, false, &flags)) {\r\nval = __iwl_read_prph(trans, ofs);\r\niwl_trans_release_nic_access(trans, &flags);\r\n}\r\nreturn val;\r\n}\r\nvoid iwl_write_prph(struct iwl_trans *trans, u32 ofs, u32 val)\r\n{\r\nunsigned long flags;\r\nif (iwl_trans_grab_nic_access(trans, false, &flags)) {\r\n__iwl_write_prph(trans, ofs, val);\r\niwl_trans_release_nic_access(trans, &flags);\r\n}\r\n}\r\nvoid iwl_set_bits_prph(struct iwl_trans *trans, u32 ofs, u32 mask)\r\n{\r\nunsigned long flags;\r\nif (iwl_trans_grab_nic_access(trans, false, &flags)) {\r\n__iwl_write_prph(trans, ofs,\r\n__iwl_read_prph(trans, ofs) | mask);\r\niwl_trans_release_nic_access(trans, &flags);\r\n}\r\n}\r\nvoid iwl_set_bits_mask_prph(struct iwl_trans *trans, u32 ofs,\r\nu32 bits, u32 mask)\r\n{\r\nunsigned long flags;\r\nif (iwl_trans_grab_nic_access(trans, false, &flags)) {\r\n__iwl_write_prph(trans, ofs,\r\n(__iwl_read_prph(trans, ofs) & mask) | bits);\r\niwl_trans_release_nic_access(trans, &flags);\r\n}\r\n}\r\nvoid iwl_clear_bits_prph(struct iwl_trans *trans, u32 ofs, u32 mask)\r\n{\r\nunsigned long flags;\r\nu32 val;\r\nif (iwl_trans_grab_nic_access(trans, false, &flags)) {\r\nval = __iwl_read_prph(trans, ofs);\r\n__iwl_write_prph(trans, ofs, (val & ~mask));\r\niwl_trans_release_nic_access(trans, &flags);\r\n}\r\n}

static int rz1000_disable_readahead(struct pci_dev *dev)\r\n{\r\nu16 reg;\r\nif (!pci_read_config_word (dev, 0x40, &reg) &&\r\n!pci_write_config_word(dev, 0x40, reg & 0xdfff)) {\r\nprintk(KERN_INFO "%s: disabled chipset read-ahead "\r\n"(buggy RZ1000/RZ1001)\n", pci_name(dev));\r\nreturn 0;\r\n} else {\r\nprintk(KERN_INFO "%s: serialized, disabled unmasking "\r\n"(buggy RZ1000/RZ1001)\n", pci_name(dev));\r\nreturn 1;\r\n}\r\n}\r\nstatic int rz1000_init_one(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nstruct ide_port_info d = rz1000_chipset;\r\nint rc;\r\nrc = pci_enable_device(dev);\r\nif (rc)\r\nreturn rc;\r\nif (rz1000_disable_readahead(dev)) {\r\nd.host_flags |= IDE_HFLAG_SERIALIZE;\r\nd.host_flags |= IDE_HFLAG_NO_UNMASK_IRQS;\r\n}\r\nreturn ide_pci_init_one(dev, &d, NULL);\r\n}\r\nstatic void rz1000_remove(struct pci_dev *dev)\r\n{\r\nide_pci_remove(dev);\r\npci_disable_device(dev);\r\n}\r\nstatic int __init rz1000_ide_init(void)\r\n{\r\nreturn ide_pci_register_driver(&rz1000_pci_driver);\r\n}\r\nstatic void __exit rz1000_ide_exit(void)\r\n{\r\npci_unregister_driver(&rz1000_pci_driver);\r\n}

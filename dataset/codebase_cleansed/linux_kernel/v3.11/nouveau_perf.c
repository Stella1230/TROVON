static u8 *\r\nnouveau_perf_table(struct drm_device *dev, u8 *ver)\r\n{\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nvbios *bios = &drm->vbios;\r\nstruct bit_entry P;\r\nif (!bit_table(dev, 'P', &P) && P.version && P.version <= 2) {\r\nu8 *perf = ROMPTR(dev, P.data[0]);\r\nif (perf) {\r\n*ver = perf[0];\r\nreturn perf;\r\n}\r\n}\r\nif (bios->type == NVBIOS_BMP) {\r\nif (bios->data[bios->offset + 6] >= 0x25) {\r\nu8 *perf = ROMPTR(dev, bios->data[bios->offset + 0x94]);\r\nif (perf) {\r\n*ver = perf[1];\r\nreturn perf;\r\n}\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nstatic u8 *\r\nnouveau_perf_entry(struct drm_device *dev, int idx,\r\nu8 *ver, u8 *hdr, u8 *cnt, u8 *len)\r\n{\r\nu8 *perf = nouveau_perf_table(dev, ver);\r\nif (perf) {\r\nif (*ver >= 0x12 && *ver < 0x20 && idx < perf[2]) {\r\n*hdr = perf[3];\r\n*cnt = 0;\r\n*len = 0;\r\nreturn perf + perf[0] + idx * perf[3];\r\n} else\r\nif (*ver >= 0x20 && *ver < 0x40 && idx < perf[2]) {\r\n*hdr = perf[3];\r\n*cnt = perf[4];\r\n*len = perf[5];\r\nreturn perf + perf[1] + idx * (*hdr + (*cnt * *len));\r\n} else\r\nif (*ver >= 0x40 && *ver < 0x41 && idx < perf[5]) {\r\n*hdr = perf[2];\r\n*cnt = perf[4];\r\n*len = perf[3];\r\nreturn perf + perf[1] + idx * (*hdr + (*cnt * *len));\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nu8 *\r\nnouveau_perf_rammap(struct drm_device *dev, u32 freq,\r\nu8 *ver, u8 *hdr, u8 *cnt, u8 *len)\r\n{\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct bit_entry P;\r\nu8 *perf, i = 0;\r\nif (!bit_table(dev, 'P', &P) && P.version == 2) {\r\nu8 *rammap = ROMPTR(dev, P.data[4]);\r\nif (rammap) {\r\nu8 *ramcfg = rammap + rammap[1];\r\n*ver = rammap[0];\r\n*hdr = rammap[2];\r\n*cnt = rammap[4];\r\n*len = rammap[3];\r\nfreq /= 1000;\r\nfor (i = 0; i < rammap[5]; i++) {\r\nif (freq >= ROM16(ramcfg[0]) &&\r\nfreq <= ROM16(ramcfg[2]))\r\nreturn ramcfg;\r\nramcfg += *hdr + (*cnt * *len);\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nif (nv_device(drm->device)->chipset == 0x49 ||\r\nnv_device(drm->device)->chipset == 0x4b)\r\nfreq /= 2;\r\nwhile ((perf = nouveau_perf_entry(dev, i++, ver, hdr, cnt, len))) {\r\nif (*ver >= 0x20 && *ver < 0x25) {\r\nif (perf[0] != 0xff && freq <= ROM16(perf[11]) * 1000)\r\nbreak;\r\n} else\r\nif (*ver >= 0x25 && *ver < 0x40) {\r\nif (perf[0] != 0xff && freq <= ROM16(perf[12]) * 1000)\r\nbreak;\r\n}\r\n}\r\nif (perf) {\r\nu8 *ramcfg = perf + *hdr;\r\n*ver = 0x00;\r\n*hdr = 0;\r\nreturn ramcfg;\r\n}\r\nreturn NULL;\r\n}\r\nu8 *\r\nnouveau_perf_ramcfg(struct drm_device *dev, u32 freq, u8 *ver, u8 *len)\r\n{\r\nstruct nouveau_device *device = nouveau_dev(dev);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nvbios *bios = &drm->vbios;\r\nu8 strap, hdr, cnt;\r\nu8 *rammap;\r\nstrap = (nv_rd32(device, 0x101000) & 0x0000003c) >> 2;\r\nif (bios->ram_restrict_tbl_ptr)\r\nstrap = bios->data[bios->ram_restrict_tbl_ptr + strap];\r\nrammap = nouveau_perf_rammap(dev, freq, ver, &hdr, &cnt, len);\r\nif (rammap && strap < cnt)\r\nreturn rammap + hdr + (strap * *len);\r\nreturn NULL;\r\n}\r\nu8 *\r\nnouveau_perf_timing(struct drm_device *dev, u32 freq, u8 *ver, u8 *len)\r\n{\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nvbios *bios = &drm->vbios;\r\nstruct bit_entry P;\r\nu8 *perf, *timing = NULL;\r\nu8 i = 0, hdr, cnt;\r\nif (bios->type == NVBIOS_BMP) {\r\nwhile ((perf = nouveau_perf_entry(dev, i++, ver, &hdr, &cnt,\r\nlen)) && *ver == 0x15) {\r\nif (freq <= ROM32(perf[5]) * 20) {\r\n*ver = 0x00;\r\n*len = 14;\r\nreturn perf + 41;\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nif (!bit_table(dev, 'P', &P)) {\r\nif (P.version == 1)\r\ntiming = ROMPTR(dev, P.data[4]);\r\nelse\r\nif (P.version == 2)\r\ntiming = ROMPTR(dev, P.data[8]);\r\n}\r\nif (timing && timing[0] == 0x10) {\r\nu8 *ramcfg = nouveau_perf_ramcfg(dev, freq, ver, len);\r\nif (ramcfg && ramcfg[1] < timing[2]) {\r\n*ver = timing[0];\r\n*len = timing[3];\r\nreturn timing + timing[1] + (ramcfg[1] * timing[3]);\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nstatic void\r\nlegacy_perf_init(struct drm_device *dev)\r\n{\r\nstruct nouveau_device *device = nouveau_dev(dev);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nvbios *bios = &drm->vbios;\r\nstruct nouveau_pm *pm = nouveau_pm(dev);\r\nchar *perf, *entry, *bmp = &bios->data[bios->offset];\r\nint headerlen, use_straps;\r\nif (bmp[5] < 0x5 || bmp[6] < 0x14) {\r\nNV_DEBUG(drm, "BMP version too old for perf\n");\r\nreturn;\r\n}\r\nperf = ROMPTR(dev, bmp[0x73]);\r\nif (!perf) {\r\nNV_DEBUG(drm, "No memclock table pointer found.\n");\r\nreturn;\r\n}\r\nswitch (perf[0]) {\r\ncase 0x12:\r\ncase 0x14:\r\ncase 0x18:\r\nuse_straps = 0;\r\nheaderlen = 1;\r\nbreak;\r\ncase 0x01:\r\nuse_straps = perf[1] & 1;\r\nheaderlen = (use_straps ? 8 : 2);\r\nbreak;\r\ndefault:\r\nNV_WARN(drm, "Unknown memclock table version %x.\n", perf[0]);\r\nreturn;\r\n}\r\nentry = perf + headerlen;\r\nif (use_straps)\r\nentry += (nv_rd32(device, NV_PEXTDEV_BOOT_0) & 0x3c) >> 1;\r\nsprintf(pm->perflvl[0].name, "performance_level_0");\r\npm->perflvl[0].memory = ROM16(entry[0]) * 20;\r\npm->nr_perflvl = 1;\r\n}\r\nstatic void\r\nnouveau_perf_voltage(struct drm_device *dev, struct nouveau_pm_level *perflvl)\r\n{\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct bit_entry P;\r\nu8 *vmap;\r\nint id;\r\nid = perflvl->volt_min;\r\nperflvl->volt_min = 0;\r\nif (drm->pm->voltage.version < 0x40) {\r\nperflvl->volt_min = id * 10000;\r\nperflvl->volt_max = perflvl->volt_min;\r\nreturn;\r\n}\r\nif (bit_table(dev, 'P', &P) || P.version != 2 || P.length < 34) {\r\nNV_DEBUG(drm, "where's our volt map table ptr? %d %d\n",\r\nP.version, P.length);\r\nreturn;\r\n}\r\nvmap = ROMPTR(dev, P.data[32]);\r\nif (!vmap) {\r\nNV_DEBUG(drm, "volt map table pointer invalid\n");\r\nreturn;\r\n}\r\nif (id < vmap[3]) {\r\nvmap += vmap[1] + (vmap[2] * id);\r\nperflvl->volt_min = ROM32(vmap[0]);\r\nperflvl->volt_max = ROM32(vmap[4]);\r\n}\r\n}\r\nvoid\r\nnouveau_perf_init(struct drm_device *dev)\r\n{\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_pm *pm = nouveau_pm(dev);\r\nstruct nvbios *bios = &drm->vbios;\r\nu8 *perf, ver, hdr, cnt, len;\r\nint ret, vid, i = -1;\r\nif (bios->type == NVBIOS_BMP && bios->data[bios->offset + 6] < 0x25) {\r\nlegacy_perf_init(dev);\r\nreturn;\r\n}\r\nperf = nouveau_perf_table(dev, &ver);\r\nwhile ((perf = nouveau_perf_entry(dev, ++i, &ver, &hdr, &cnt, &len))) {\r\nstruct nouveau_pm_level *perflvl = &pm->perflvl[pm->nr_perflvl];\r\nif (perf[0] == 0xff)\r\ncontinue;\r\nswitch (ver) {\r\ncase 0x12:\r\ncase 0x13:\r\ncase 0x15:\r\nperflvl->fanspeed = perf[55];\r\nif (hdr > 56)\r\nperflvl->volt_min = perf[56];\r\nperflvl->core = ROM32(perf[1]) * 10;\r\nperflvl->memory = ROM32(perf[5]) * 20;\r\nbreak;\r\ncase 0x21:\r\ncase 0x23:\r\ncase 0x24:\r\nperflvl->fanspeed = perf[4];\r\nperflvl->volt_min = perf[5];\r\nperflvl->shader = ROM16(perf[6]) * 1000;\r\nperflvl->core = perflvl->shader;\r\nperflvl->core += (signed char)perf[8] * 1000;\r\nif (nv_device(drm->device)->chipset == 0x49 ||\r\nnv_device(drm->device)->chipset == 0x4b)\r\nperflvl->memory = ROM16(perf[11]) * 1000;\r\nelse\r\nperflvl->memory = ROM16(perf[11]) * 2000;\r\nbreak;\r\ncase 0x25:\r\nperflvl->fanspeed = perf[4];\r\nperflvl->volt_min = perf[5];\r\nperflvl->core = ROM16(perf[6]) * 1000;\r\nperflvl->shader = ROM16(perf[10]) * 1000;\r\nperflvl->memory = ROM16(perf[12]) * 1000;\r\nbreak;\r\ncase 0x30:\r\nperflvl->memscript = ROM16(perf[2]);\r\ncase 0x35:\r\nperflvl->fanspeed = perf[6];\r\nperflvl->volt_min = perf[7];\r\nperflvl->core = ROM16(perf[8]) * 1000;\r\nperflvl->shader = ROM16(perf[10]) * 1000;\r\nperflvl->memory = ROM16(perf[12]) * 1000;\r\nperflvl->vdec = ROM16(perf[16]) * 1000;\r\nperflvl->dom6 = ROM16(perf[20]) * 1000;\r\nbreak;\r\ncase 0x40:\r\n#define subent(n) ((ROM16(perf[hdr + (n) * len]) & 0xfff) * 1000)\r\nperflvl->fanspeed = 0;\r\nperflvl->volt_min = perf[2];\r\nif (nv_device(drm->device)->card_type == NV_50) {\r\nperflvl->core = subent(0);\r\nperflvl->shader = subent(1);\r\nperflvl->memory = subent(2);\r\nperflvl->vdec = subent(3);\r\nperflvl->unka0 = subent(4);\r\n} else {\r\nperflvl->hub06 = subent(0);\r\nperflvl->hub01 = subent(1);\r\nperflvl->copy = subent(2);\r\nperflvl->shader = subent(3);\r\nperflvl->rop = subent(4);\r\nperflvl->memory = subent(5);\r\nperflvl->vdec = subent(6);\r\nperflvl->daemon = subent(10);\r\nperflvl->hub07 = subent(11);\r\nperflvl->core = perflvl->shader / 2;\r\n}\r\nbreak;\r\n}\r\nnouveau_perf_voltage(dev, perflvl);\r\nif (pm->voltage.supported && perflvl->volt_min) {\r\nvid = nouveau_volt_vid_lookup(dev, perflvl->volt_min);\r\nif (vid < 0) {\r\nNV_DEBUG(drm, "perflvl %d, bad vid\n", i);\r\ncontinue;\r\n}\r\n}\r\nret = nouveau_mem_timing_calc(dev, perflvl->memory,\r\n&perflvl->timing);\r\nif (ret) {\r\nNV_DEBUG(drm, "perflvl %d, bad timing: %d\n", i, ret);\r\ncontinue;\r\n}\r\nsnprintf(perflvl->name, sizeof(perflvl->name),\r\n"performance_level_%d", i);\r\nperflvl->id = i;\r\nsnprintf(perflvl->profile.name, sizeof(perflvl->profile.name),\r\n"%d", perflvl->id);\r\nperflvl->profile.func = &nouveau_pm_static_profile_func;\r\nlist_add_tail(&perflvl->profile.head, &pm->profiles);\r\npm->nr_perflvl++;\r\n}\r\n}\r\nvoid\r\nnouveau_perf_fini(struct drm_device *dev)\r\n{\r\n}

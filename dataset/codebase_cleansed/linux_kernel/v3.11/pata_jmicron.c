static int jmicron_pre_reset(struct ata_link *link, unsigned long deadline)\r\n{\r\nstruct ata_port *ap = link->ap;\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nu32 control;\r\nu32 control5;\r\nint port_mask = 1<< (4 * ap->port_no);\r\nint port = ap->port_no;\r\nport_type port_map[2];\r\npci_read_config_dword(pdev, 0x40, &control);\r\nif ((control & port_mask) == 0)\r\nreturn -ENOENT;\r\nif (control & (1 << 23)) {\r\nport_map[0] = PORT_SATA;\r\nport_map[1] = PORT_PATA0;\r\n} else {\r\nport_map[0] = PORT_SATA;\r\nport_map[1] = PORT_SATA;\r\n}\r\npci_read_config_dword(pdev, 0x80, &control5);\r\nif (control5 & (1<<24))\r\nport_map[0] = PORT_PATA1;\r\nif (control & (1 << 22))\r\nport = port ^ 1;\r\nswitch (port_map[port]) {\r\ncase PORT_PATA0:\r\nif ((control & (1 << 5)) == 0)\r\nreturn -ENOENT;\r\nif (control & (1 << 3))\r\nap->cbl = ATA_CBL_PATA40;\r\nelse\r\nap->cbl = ATA_CBL_PATA80;\r\nbreak;\r\ncase PORT_PATA1:\r\nif ((control5 & (1 << 21)) == 0)\r\nreturn -ENOENT;\r\nif (control5 & (1 << 19))\r\nap->cbl = ATA_CBL_PATA40;\r\nelse\r\nap->cbl = ATA_CBL_PATA80;\r\nbreak;\r\ncase PORT_SATA:\r\nap->cbl = ATA_CBL_SATA;\r\nbreak;\r\n}\r\nreturn ata_sff_prereset(link, deadline);\r\n}\r\nstatic int jmicron_init_one (struct pci_dev *pdev, const struct pci_device_id *id)\r\n{\r\nstatic const struct ata_port_info info = {\r\n.flags = ATA_FLAG_SLAVE_POSS,\r\n.pio_mask = ATA_PIO4,\r\n.mwdma_mask = ATA_MWDMA2,\r\n.udma_mask = ATA_UDMA5,\r\n.port_ops = &jmicron_ops,\r\n};\r\nconst struct ata_port_info *ppi[] = { &info, NULL };\r\nreturn ata_pci_bmdma_init_one(pdev, ppi, &jmicron_sht, NULL, 0);\r\n}

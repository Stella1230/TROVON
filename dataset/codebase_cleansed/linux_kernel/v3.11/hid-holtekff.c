static void holtekff_send(struct holtekff_device *holtekff,\r\nstruct hid_device *hid,\r\nconst u8 data[HOLTEKFF_MSG_LENGTH])\r\n{\r\nint i;\r\nfor (i = 0; i < HOLTEKFF_MSG_LENGTH; i++) {\r\nholtekff->field->value[i] = data[i];\r\n}\r\ndbg_hid("sending %*ph\n", 7, data);\r\nhid_hw_request(hid, holtekff->field->report, HID_REQ_SET_REPORT);\r\n}\r\nstatic int holtekff_play(struct input_dev *dev, void *data,\r\nstruct ff_effect *effect)\r\n{\r\nstruct hid_device *hid = input_get_drvdata(dev);\r\nstruct holtekff_device *holtekff = data;\r\nint left, right;\r\nu8 buf[HOLTEKFF_MSG_LENGTH] =\r\n{ 0x01, 0x01, 0xff, 0xff, 0x10, 0xe0, 0x00 };\r\nleft = effect->u.rumble.strong_magnitude;\r\nright = effect->u.rumble.weak_magnitude;\r\ndbg_hid("called with 0x%04x 0x%04x\n", left, right);\r\nif (!left && !right) {\r\nholtekff_send(holtekff, hid, stop_all6);\r\nreturn 0;\r\n}\r\nif (left)\r\nbuf[1] |= 0x80;\r\nif (right)\r\nbuf[1] |= 0x40;\r\nbuf[6] = min(0xf, (left >> 12) + (right >> 12));\r\nholtekff_send(holtekff, hid, buf);\r\nholtekff_send(holtekff, hid, start_effect_1);\r\nreturn 0;\r\n}\r\nstatic int holtekff_init(struct hid_device *hid)\r\n{\r\nstruct holtekff_device *holtekff;\r\nstruct hid_report *report;\r\nstruct hid_input *hidinput = list_entry(hid->inputs.next,\r\nstruct hid_input, list);\r\nstruct list_head *report_list =\r\n&hid->report_enum[HID_OUTPUT_REPORT].report_list;\r\nstruct input_dev *dev = hidinput->input;\r\nint error;\r\nif (list_empty(report_list)) {\r\nhid_err(hid, "no output report found\n");\r\nreturn -ENODEV;\r\n}\r\nreport = list_entry(report_list->next, struct hid_report, list);\r\nif (report->maxfield < 1 || report->field[0]->report_count != 7) {\r\nhid_err(hid, "unexpected output report layout\n");\r\nreturn -ENODEV;\r\n}\r\nholtekff = kzalloc(sizeof(*holtekff), GFP_KERNEL);\r\nif (!holtekff)\r\nreturn -ENOMEM;\r\nset_bit(FF_RUMBLE, dev->ffbit);\r\nholtekff->field = report->field[0];\r\nholtekff_send(holtekff, hid, stop_all4);\r\nholtekff_send(holtekff, hid, stop_all6);\r\nerror = input_ff_create_memless(dev, holtekff, holtekff_play);\r\nif (error) {\r\nkfree(holtekff);\r\nreturn error;\r\n}\r\nhid_info(hid, "Force feedback for Holtek On Line Grip based devices by Anssi Hannula <anssi.hannula@iki.fi>\n");\r\nreturn 0;\r\n}\r\nstatic inline int holtekff_init(struct hid_device *hid)\r\n{\r\nreturn 0;\r\n}\r\nstatic int holtek_probe(struct hid_device *hdev, const struct hid_device_id *id)\r\n{\r\nint ret;\r\nret = hid_parse(hdev);\r\nif (ret) {\r\nhid_err(hdev, "parse failed\n");\r\ngoto err;\r\n}\r\nret = hid_hw_start(hdev, HID_CONNECT_DEFAULT & ~HID_CONNECT_FF);\r\nif (ret) {\r\nhid_err(hdev, "hw start failed\n");\r\ngoto err;\r\n}\r\nholtekff_init(hdev);\r\nreturn 0;\r\nerr:\r\nreturn ret;\r\n}

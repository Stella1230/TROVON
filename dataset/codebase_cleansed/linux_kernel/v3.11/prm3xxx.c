u32 omap3_prm_vp_check_txdone(u8 vp_id)\r\n{\r\nstruct omap3_vp *vp = &omap3_vp[vp_id];\r\nu32 irqstatus;\r\nirqstatus = omap2_prm_read_mod_reg(OCP_MOD,\r\nOMAP3_PRM_IRQSTATUS_MPU_OFFSET);\r\nreturn irqstatus & vp->tranxdone_status;\r\n}\r\nvoid omap3_prm_vp_clear_txdone(u8 vp_id)\r\n{\r\nstruct omap3_vp *vp = &omap3_vp[vp_id];\r\nomap2_prm_write_mod_reg(vp->tranxdone_status,\r\nOCP_MOD, OMAP3_PRM_IRQSTATUS_MPU_OFFSET);\r\n}\r\nu32 omap3_prm_vcvp_read(u8 offset)\r\n{\r\nreturn omap2_prm_read_mod_reg(OMAP3430_GR_MOD, offset);\r\n}\r\nvoid omap3_prm_vcvp_write(u32 val, u8 offset)\r\n{\r\nomap2_prm_write_mod_reg(val, OMAP3430_GR_MOD, offset);\r\n}\r\nu32 omap3_prm_vcvp_rmw(u32 mask, u32 bits, u8 offset)\r\n{\r\nreturn omap2_prm_rmw_mod_reg_bits(mask, bits, OMAP3430_GR_MOD, offset);\r\n}\r\nvoid omap3xxx_prm_dpll3_reset(void)\r\n{\r\nomap2_prm_set_mod_reg_bits(OMAP_RST_DPLL3_MASK, OMAP3430_GR_MOD,\r\nOMAP2_RM_RSTCTRL);\r\nomap2_prm_read_mod_reg(OMAP3430_GR_MOD, OMAP2_RM_RSTCTRL);\r\n}\r\nvoid omap3xxx_prm_read_pending_irqs(unsigned long *events)\r\n{\r\nu32 mask, st;\r\nmask = omap2_prm_read_mod_reg(OCP_MOD, OMAP3_PRM_IRQENABLE_MPU_OFFSET);\r\nst = omap2_prm_read_mod_reg(OCP_MOD, OMAP3_PRM_IRQSTATUS_MPU_OFFSET);\r\nevents[0] = mask & st;\r\n}\r\nvoid omap3xxx_prm_ocp_barrier(void)\r\n{\r\nomap2_prm_read_mod_reg(OCP_MOD, OMAP3_PRM_REVISION_OFFSET);\r\n}\r\nvoid omap3xxx_prm_save_and_clear_irqen(u32 *saved_mask)\r\n{\r\nsaved_mask[0] = omap2_prm_read_mod_reg(OCP_MOD,\r\nOMAP3_PRM_IRQENABLE_MPU_OFFSET);\r\nomap2_prm_write_mod_reg(0, OCP_MOD, OMAP3_PRM_IRQENABLE_MPU_OFFSET);\r\nomap2_prm_read_mod_reg(OCP_MOD, OMAP3_PRM_REVISION_OFFSET);\r\n}\r\nvoid omap3xxx_prm_restore_irqen(u32 *saved_mask)\r\n{\r\nomap2_prm_write_mod_reg(saved_mask[0], OCP_MOD,\r\nOMAP3_PRM_IRQENABLE_MPU_OFFSET);\r\n}\r\nvoid omap3xxx_prm_reconfigure_io_chain(void)\r\n{\r\nint i = 0;\r\nomap2_prm_set_mod_reg_bits(OMAP3430_EN_IO_CHAIN_MASK, WKUP_MOD,\r\nPM_WKEN);\r\nomap_test_timeout(omap2_prm_read_mod_reg(WKUP_MOD, PM_WKST) &\r\nOMAP3430_ST_IO_CHAIN_MASK,\r\nMAX_IOPAD_LATCH_TIME, i);\r\nif (i == MAX_IOPAD_LATCH_TIME)\r\npr_warn("PRM: I/O chain clock line assertion timed out\n");\r\nomap2_prm_clear_mod_reg_bits(OMAP3430_EN_IO_CHAIN_MASK, WKUP_MOD,\r\nPM_WKEN);\r\nomap2_prm_set_mod_reg_bits(OMAP3430_ST_IO_CHAIN_MASK, WKUP_MOD,\r\nPM_WKST);\r\nomap2_prm_read_mod_reg(WKUP_MOD, PM_WKST);\r\n}\r\nstatic void __init omap3xxx_prm_enable_io_wakeup(void)\r\n{\r\nif (omap3_has_io_wakeup())\r\nomap2_prm_set_mod_reg_bits(OMAP3430_EN_IO_MASK, WKUP_MOD,\r\nPM_WKEN);\r\n}\r\nstatic u32 omap3xxx_prm_read_reset_sources(void)\r\n{\r\nstruct prm_reset_src_map *p;\r\nu32 r = 0;\r\nu32 v;\r\nv = omap2_prm_read_mod_reg(WKUP_MOD, OMAP2_RM_RSTST);\r\np = omap3xxx_prm_reset_src_map;\r\nwhile (p->reg_shift >= 0 && p->std_shift >= 0) {\r\nif (v & (1 << p->reg_shift))\r\nr |= 1 << p->std_shift;\r\np++;\r\n}\r\nreturn r;\r\n}\r\nstatic int omap3_pwrdm_set_next_pwrst(struct powerdomain *pwrdm, u8 pwrst)\r\n{\r\nomap2_prm_rmw_mod_reg_bits(OMAP_POWERSTATE_MASK,\r\n(pwrst << OMAP_POWERSTATE_SHIFT),\r\npwrdm->prcm_offs, OMAP2_PM_PWSTCTRL);\r\nreturn 0;\r\n}\r\nstatic int omap3_pwrdm_read_next_pwrst(struct powerdomain *pwrdm)\r\n{\r\nreturn omap2_prm_read_mod_bits_shift(pwrdm->prcm_offs,\r\nOMAP2_PM_PWSTCTRL,\r\nOMAP_POWERSTATE_MASK);\r\n}\r\nstatic int omap3_pwrdm_read_pwrst(struct powerdomain *pwrdm)\r\n{\r\nreturn omap2_prm_read_mod_bits_shift(pwrdm->prcm_offs,\r\nOMAP2_PM_PWSTST,\r\nOMAP_POWERSTATEST_MASK);\r\n}\r\nstatic int omap3_pwrdm_read_prev_pwrst(struct powerdomain *pwrdm)\r\n{\r\nreturn omap2_prm_read_mod_bits_shift(pwrdm->prcm_offs,\r\nOMAP3430_PM_PREPWSTST,\r\nOMAP3430_LASTPOWERSTATEENTERED_MASK);\r\n}\r\nstatic int omap3_pwrdm_read_logic_pwrst(struct powerdomain *pwrdm)\r\n{\r\nreturn omap2_prm_read_mod_bits_shift(pwrdm->prcm_offs,\r\nOMAP2_PM_PWSTST,\r\nOMAP3430_LOGICSTATEST_MASK);\r\n}\r\nstatic int omap3_pwrdm_read_logic_retst(struct powerdomain *pwrdm)\r\n{\r\nreturn omap2_prm_read_mod_bits_shift(pwrdm->prcm_offs,\r\nOMAP2_PM_PWSTCTRL,\r\nOMAP3430_LOGICSTATEST_MASK);\r\n}\r\nstatic int omap3_pwrdm_read_prev_logic_pwrst(struct powerdomain *pwrdm)\r\n{\r\nreturn omap2_prm_read_mod_bits_shift(pwrdm->prcm_offs,\r\nOMAP3430_PM_PREPWSTST,\r\nOMAP3430_LASTLOGICSTATEENTERED_MASK);\r\n}\r\nstatic int omap3_get_mem_bank_lastmemst_mask(u8 bank)\r\n{\r\nswitch (bank) {\r\ncase 0:\r\nreturn OMAP3430_LASTMEM1STATEENTERED_MASK;\r\ncase 1:\r\nreturn OMAP3430_LASTMEM2STATEENTERED_MASK;\r\ncase 2:\r\nreturn OMAP3430_LASTSHAREDL2CACHEFLATSTATEENTERED_MASK;\r\ncase 3:\r\nreturn OMAP3430_LASTL2FLATMEMSTATEENTERED_MASK;\r\ndefault:\r\nWARN_ON(1);\r\nreturn -EEXIST;\r\n}\r\nreturn 0;\r\n}\r\nstatic int omap3_pwrdm_read_prev_mem_pwrst(struct powerdomain *pwrdm, u8 bank)\r\n{\r\nu32 m;\r\nm = omap3_get_mem_bank_lastmemst_mask(bank);\r\nreturn omap2_prm_read_mod_bits_shift(pwrdm->prcm_offs,\r\nOMAP3430_PM_PREPWSTST, m);\r\n}\r\nstatic int omap3_pwrdm_clear_all_prev_pwrst(struct powerdomain *pwrdm)\r\n{\r\nomap2_prm_write_mod_reg(0, pwrdm->prcm_offs, OMAP3430_PM_PREPWSTST);\r\nreturn 0;\r\n}\r\nstatic int omap3_pwrdm_enable_hdwr_sar(struct powerdomain *pwrdm)\r\n{\r\nreturn omap2_prm_rmw_mod_reg_bits(0,\r\n1 << OMAP3430ES2_SAVEANDRESTORE_SHIFT,\r\npwrdm->prcm_offs, OMAP2_PM_PWSTCTRL);\r\n}\r\nstatic int omap3_pwrdm_disable_hdwr_sar(struct powerdomain *pwrdm)\r\n{\r\nreturn omap2_prm_rmw_mod_reg_bits(1 << OMAP3430ES2_SAVEANDRESTORE_SHIFT,\r\n0, pwrdm->prcm_offs,\r\nOMAP2_PM_PWSTCTRL);\r\n}\r\nint __init omap3xxx_prm_init(void)\r\n{\r\nif (!cpu_is_omap34xx())\r\nreturn 0;\r\nreturn prm_register(&omap3xxx_prm_ll_data);\r\n}\r\nstatic int __init omap3xxx_prm_late_init(void)\r\n{\r\nint ret;\r\nif (!cpu_is_omap34xx())\r\nreturn 0;\r\nomap3xxx_prm_enable_io_wakeup();\r\nret = omap_prcm_register_chain_handler(&omap3_prcm_irq_setup);\r\nif (!ret)\r\nirq_set_status_flags(omap_prcm_event_to_irq("io"),\r\nIRQ_NOAUTOEN);\r\nreturn ret;\r\n}\r\nstatic void __exit omap3xxx_prm_exit(void)\r\n{\r\nif (!cpu_is_omap34xx())\r\nreturn;\r\nWARN(prm_unregister(&omap3xxx_prm_ll_data),\r\n"%s: prm_ll_data function pointer mismatch\n", __func__);\r\n}

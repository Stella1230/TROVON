static inline int zeus_irq_to_bitmask(unsigned int irq)\r\n{\r\nreturn zeus_isa_irq_map[irq - PXA_ISA_IRQ(0)];\r\n}\r\nstatic inline int zeus_bit_to_irq(int bit)\r\n{\r\nreturn zeus_isa_irqs[bit] + PXA_ISA_IRQ(0);\r\n}\r\nstatic void zeus_ack_irq(struct irq_data *d)\r\n{\r\n__raw_writew(zeus_irq_to_bitmask(d->irq), ZEUS_CPLD_ISA_IRQ);\r\n}\r\nstatic void zeus_mask_irq(struct irq_data *d)\r\n{\r\nzeus_irq_enabled_mask &= ~(zeus_irq_to_bitmask(d->irq));\r\n}\r\nstatic void zeus_unmask_irq(struct irq_data *d)\r\n{\r\nzeus_irq_enabled_mask |= zeus_irq_to_bitmask(d->irq);\r\n}\r\nstatic inline unsigned long zeus_irq_pending(void)\r\n{\r\nreturn __raw_readw(ZEUS_CPLD_ISA_IRQ) & zeus_irq_enabled_mask;\r\n}\r\nstatic void zeus_irq_handler(unsigned int irq, struct irq_desc *desc)\r\n{\r\nunsigned long pending;\r\npending = zeus_irq_pending();\r\ndo {\r\ndesc->irq_data.chip->irq_ack(&desc->irq_data);\r\nif (likely(pending)) {\r\nirq = zeus_bit_to_irq(__ffs(pending));\r\ngeneric_handle_irq(irq);\r\n}\r\npending = zeus_irq_pending();\r\n} while (pending);\r\n}\r\nstatic void __init zeus_init_irq(void)\r\n{\r\nint level;\r\nint isa_irq;\r\npxa27x_init_irq();\r\nirq_set_irq_type(gpio_to_irq(ZEUS_AC97_GPIO), IRQ_TYPE_EDGE_RISING);\r\nirq_set_irq_type(gpio_to_irq(ZEUS_WAKEUP_GPIO), IRQ_TYPE_EDGE_RISING);\r\nirq_set_irq_type(gpio_to_irq(ZEUS_PTT_GPIO), IRQ_TYPE_EDGE_RISING);\r\nirq_set_irq_type(gpio_to_irq(ZEUS_EXTGPIO_GPIO),\r\nIRQ_TYPE_EDGE_FALLING);\r\nirq_set_irq_type(gpio_to_irq(ZEUS_CAN_GPIO), IRQ_TYPE_EDGE_FALLING);\r\nfor (level = 0; level < ARRAY_SIZE(zeus_isa_irqs); level++) {\r\nisa_irq = zeus_bit_to_irq(level);\r\nirq_set_chip_and_handler(isa_irq, &zeus_irq_chip,\r\nhandle_edge_irq);\r\nset_irq_flags(isa_irq, IRQF_VALID | IRQF_PROBE);\r\n}\r\nirq_set_irq_type(gpio_to_irq(ZEUS_ISA_GPIO), IRQ_TYPE_EDGE_RISING);\r\nirq_set_chained_handler(gpio_to_irq(ZEUS_ISA_GPIO), zeus_irq_handler);\r\n}\r\nstatic int zeus_mcp2515_setup(struct spi_device *sdev)\r\n{\r\nint err;\r\nerr = gpio_request(ZEUS_CAN_SHDN_GPIO, "CAN shutdown");\r\nif (err)\r\nreturn err;\r\nerr = gpio_direction_output(ZEUS_CAN_SHDN_GPIO, 1);\r\nif (err) {\r\ngpio_free(ZEUS_CAN_SHDN_GPIO);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int zeus_mcp2515_transceiver_enable(int enable)\r\n{\r\ngpio_set_value(ZEUS_CAN_SHDN_GPIO, !enable);\r\nreturn 0;\r\n}\r\nstatic void zeus_cf_reset(int state)\r\n{\r\nu16 cpld_state = __raw_readw(ZEUS_CPLD_CONTROL);\r\nif (state)\r\ncpld_state |= ZEUS_CPLD_CONTROL_CF_RST;\r\nelse\r\ncpld_state &= ~ZEUS_CPLD_CONTROL_CF_RST;\r\n__raw_writew(cpld_state, ZEUS_CPLD_CONTROL);\r\n}\r\nstatic int zeus_ohci_init(struct device *dev)\r\n{\r\nint err;\r\nif ((err = gpio_request(ZEUS_USB2_PWREN_GPIO, "USB2_PWREN"))) {\r\ndev_err(dev, "Can't request USB2_PWREN\n");\r\nreturn err;\r\n}\r\nif ((err = gpio_direction_output(ZEUS_USB2_PWREN_GPIO, 1))) {\r\ngpio_free(ZEUS_USB2_PWREN_GPIO);\r\ndev_err(dev, "Can't enable USB2_PWREN\n");\r\nreturn err;\r\n}\r\nUP2OCR = UP2OCR_HXOE | UP2OCR_HXS | UP2OCR_DMPDE | UP2OCR_DPPDE;\r\nreturn 0;\r\n}\r\nstatic void zeus_ohci_exit(struct device *dev)\r\n{\r\ngpio_direction_output(ZEUS_USB2_PWREN_GPIO, 0);\r\ngpio_free(ZEUS_USB2_PWREN_GPIO);\r\n}\r\nstatic void zeus_lcd_power(int on, struct fb_var_screeninfo *si)\r\n{\r\ngpio_set_value(ZEUS_LCD_EN_GPIO, on);\r\n}\r\nstatic void zeus_backlight_power(int on)\r\n{\r\ngpio_set_value(ZEUS_BKLEN_GPIO, on);\r\n}\r\nstatic int zeus_setup_fb_gpios(void)\r\n{\r\nint err;\r\nif ((err = gpio_request(ZEUS_LCD_EN_GPIO, "LCD_EN")))\r\ngoto out_err;\r\nif ((err = gpio_direction_output(ZEUS_LCD_EN_GPIO, 0)))\r\ngoto out_err_lcd;\r\nif ((err = gpio_request(ZEUS_BKLEN_GPIO, "BKLEN")))\r\ngoto out_err_lcd;\r\nif ((err = gpio_direction_output(ZEUS_BKLEN_GPIO, 0)))\r\ngoto out_err_bkl;\r\nreturn 0;\r\nout_err_bkl:\r\ngpio_free(ZEUS_BKLEN_GPIO);\r\nout_err_lcd:\r\ngpio_free(ZEUS_LCD_EN_GPIO);\r\nout_err:\r\nreturn err;\r\n}\r\nstatic void zeus_udc_command(int cmd)\r\n{\r\nswitch (cmd) {\r\ncase PXA2XX_UDC_CMD_DISCONNECT:\r\npr_info("zeus: disconnecting USB client\n");\r\nUP2OCR = UP2OCR_HXOE | UP2OCR_HXS | UP2OCR_DMPDE | UP2OCR_DPPDE;\r\nbreak;\r\ncase PXA2XX_UDC_CMD_CONNECT:\r\npr_info("zeus: connecting USB client\n");\r\nUP2OCR = UP2OCR_HXOE | UP2OCR_DPPUE;\r\nbreak;\r\n}\r\n}\r\nstatic void zeus_power_off(void)\r\n{\r\nlocal_irq_disable();\r\ncpu_suspend(PWRMODE_DEEPSLEEP, pxa27x_finish_suspend);\r\n}\r\nstatic void zeus_get_power_status(struct apm_power_info *info)\r\n{\r\ninfo->ac_line_status = APM_AC_ONLINE;\r\ninfo->battery_status = APM_BATTERY_STATUS_NOT_PRESENT;\r\ninfo->battery_flag = APM_BATTERY_FLAG_NOT_PRESENT;\r\n}\r\nstatic inline void zeus_setup_apm(void)\r\n{\r\napm_get_power_status = zeus_get_power_status;\r\n}\r\nstatic inline void zeus_setup_apm(void)\r\n{\r\n}\r\nstatic int zeus_get_pcb_info(struct i2c_client *client, unsigned gpio,\r\nunsigned ngpio, void *context)\r\n{\r\nint i;\r\nu8 pcb_info = 0;\r\nfor (i = 0; i < 8; i++) {\r\nint pcb_bit = gpio + i + 8;\r\nif (gpio_request(pcb_bit, "pcb info")) {\r\ndev_err(&client->dev, "Can't request pcb info %d\n", i);\r\ncontinue;\r\n}\r\nif (gpio_direction_input(pcb_bit)) {\r\ndev_err(&client->dev, "Can't read pcb info %d\n", i);\r\ngpio_free(pcb_bit);\r\ncontinue;\r\n}\r\npcb_info |= !!gpio_get_value(pcb_bit) << i;\r\ngpio_free(pcb_bit);\r\n}\r\ndev_info(&client->dev, "Zeus PCB version %d issue %d\n",\r\npcb_info >> 4, pcb_info & 0xf);\r\nreturn 0;\r\n}\r\nstatic void __init zeus_init(void)\r\n{\r\nu16 dm9000_msc = DM9K_MSC_VALUE;\r\nu32 msc0, msc1;\r\nsystem_rev = __raw_readw(ZEUS_CPLD_VERSION);\r\npr_info("Zeus CPLD V%dI%d\n", (system_rev & 0xf0) >> 4, (system_rev & 0x0f));\r\nmsc0 = (__raw_readl(MSC0) & 0x0000ffff) | (dm9000_msc << 16);\r\nmsc1 = (__raw_readl(MSC1) & 0xffff0000) | dm9000_msc;\r\n__raw_writel(msc0, MSC0);\r\n__raw_writel(msc1, MSC1);\r\npm_power_off = zeus_power_off;\r\nzeus_setup_apm();\r\npxa2xx_mfp_config(ARRAY_AND_SIZE(zeus_pin_config));\r\nplatform_add_devices(zeus_devices, ARRAY_SIZE(zeus_devices));\r\npxa_set_ohci_info(&zeus_ohci_platform_data);\r\nif (zeus_setup_fb_gpios())\r\npr_err("Failed to setup fb gpios\n");\r\nelse\r\npxa_set_fb_info(NULL, &zeus_fb_info);\r\npxa_set_mci_info(&zeus_mci_platform_data);\r\npxa_set_udc_info(&zeus_udc_info);\r\npxa_set_ac97_info(&zeus_ac97_info);\r\npxa_set_i2c_info(NULL);\r\ni2c_register_board_info(0, ARRAY_AND_SIZE(zeus_i2c_devices));\r\npxa2xx_set_spi_info(3, &pxa2xx_spi_ssp3_master_info);\r\nspi_register_board_info(zeus_spi_board_info, ARRAY_SIZE(zeus_spi_board_info));\r\n}\r\nstatic void __init zeus_map_io(void)\r\n{\r\npxa27x_map_io();\r\niotable_init(zeus_io_desc, ARRAY_SIZE(zeus_io_desc));\r\nPMCR = PSPR = 0;\r\nOSCC |= OSCC_OON;\r\nPCFR = PCFR_OPDE | PCFR_DC_EN | PCFR_FS | PCFR_FP;\r\n}

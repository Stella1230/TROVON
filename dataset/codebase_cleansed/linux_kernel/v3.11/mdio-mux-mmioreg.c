static int mdio_mux_mmioreg_switch_fn(int current_child, int desired_child,\r\nvoid *data)\r\n{\r\nstruct mdio_mux_mmioreg_state *s = data;\r\nif (current_child ^ desired_child) {\r\nvoid *p = ioremap(s->phys, 1);\r\nuint8_t x, y;\r\nif (!p)\r\nreturn -ENOMEM;\r\nx = ioread8(p);\r\ny = (x & ~s->mask) | desired_child;\r\nif (x != y) {\r\niowrite8((x & ~s->mask) | desired_child, p);\r\npr_debug("%s: %02x -> %02x\n", __func__, x, y);\r\n}\r\niounmap(p);\r\n}\r\nreturn 0;\r\n}\r\nstatic int mdio_mux_mmioreg_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np2, *np = pdev->dev.of_node;\r\nstruct mdio_mux_mmioreg_state *s;\r\nstruct resource res;\r\nconst __be32 *iprop;\r\nint len, ret;\r\ndev_dbg(&pdev->dev, "probing node %s\n", np->full_name);\r\ns = devm_kzalloc(&pdev->dev, sizeof(*s), GFP_KERNEL);\r\nif (!s)\r\nreturn -ENOMEM;\r\nret = of_address_to_resource(np, 0, &res);\r\nif (ret) {\r\ndev_err(&pdev->dev, "could not obtain memory map for node %s\n",\r\nnp->full_name);\r\nreturn ret;\r\n}\r\ns->phys = res.start;\r\nif (resource_size(&res) != sizeof(uint8_t)) {\r\ndev_err(&pdev->dev, "only 8-bit registers are supported\n");\r\nreturn -EINVAL;\r\n}\r\niprop = of_get_property(np, "mux-mask", &len);\r\nif (!iprop || len != sizeof(uint32_t)) {\r\ndev_err(&pdev->dev, "missing or invalid mux-mask property\n");\r\nreturn -ENODEV;\r\n}\r\nif (be32_to_cpup(iprop) > 255) {\r\ndev_err(&pdev->dev, "only 8-bit registers are supported\n");\r\nreturn -EINVAL;\r\n}\r\ns->mask = be32_to_cpup(iprop);\r\nfor_each_available_child_of_node(np, np2) {\r\niprop = of_get_property(np2, "reg", &len);\r\nif (!iprop || len != sizeof(uint32_t)) {\r\ndev_err(&pdev->dev, "mdio-mux child node %s is "\r\n"missing a 'reg' property\n", np2->full_name);\r\nreturn -ENODEV;\r\n}\r\nif (be32_to_cpup(iprop) & ~s->mask) {\r\ndev_err(&pdev->dev, "mdio-mux child node %s has "\r\n"a 'reg' value with unmasked bits\n",\r\nnp2->full_name);\r\nreturn -ENODEV;\r\n}\r\n}\r\nret = mdio_mux_init(&pdev->dev, mdio_mux_mmioreg_switch_fn,\r\n&s->mux_handle, s);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to register mdio-mux bus %s\n",\r\nnp->full_name);\r\nreturn ret;\r\n}\r\npdev->dev.platform_data = s;\r\nreturn 0;\r\n}\r\nstatic int mdio_mux_mmioreg_remove(struct platform_device *pdev)\r\n{\r\nstruct mdio_mux_mmioreg_state *s = dev_get_platdata(&pdev->dev);\r\nmdio_mux_uninit(s->mux_handle);\r\nreturn 0;\r\n}

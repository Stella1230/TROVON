static int __asoc_simple_card_dai_init(struct snd_soc_dai *dai,\r\nstruct asoc_simple_dai *set,\r\nunsigned int daifmt)\r\n{\r\nint ret = 0;\r\ndaifmt |= set->fmt;\r\nif (!ret && daifmt)\r\nret = snd_soc_dai_set_fmt(dai, daifmt);\r\nif (!ret && set->sysclk)\r\nret = snd_soc_dai_set_sysclk(dai, 0, set->sysclk, 0);\r\nreturn ret;\r\n}\r\nstatic int asoc_simple_card_dai_init(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct asoc_simple_card_info *info = asoc_simple_get_card_info(rtd);\r\nstruct snd_soc_dai *codec = rtd->codec_dai;\r\nstruct snd_soc_dai *cpu = rtd->cpu_dai;\r\nunsigned int daifmt = info->daifmt;\r\nint ret;\r\nret = __asoc_simple_card_dai_init(codec, &info->codec_dai, daifmt);\r\nif (ret < 0)\r\nreturn ret;\r\nret = __asoc_simple_card_dai_init(cpu, &info->cpu_dai, daifmt);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int asoc_simple_card_probe(struct platform_device *pdev)\r\n{\r\nstruct asoc_simple_card_info *cinfo = pdev->dev.platform_data;\r\nstruct device *dev = &pdev->dev;\r\nif (!cinfo) {\r\ndev_err(dev, "no info for asoc-simple-card\n");\r\nreturn -EINVAL;\r\n}\r\nif (!cinfo->name ||\r\n!cinfo->card ||\r\n!cinfo->codec ||\r\n!cinfo->platform ||\r\n!cinfo->cpu_dai.name ||\r\n!cinfo->codec_dai.name) {\r\ndev_err(dev, "insufficient asoc_simple_card_info settings\n");\r\nreturn -EINVAL;\r\n}\r\ncinfo->snd_link.name = cinfo->name;\r\ncinfo->snd_link.stream_name = cinfo->name;\r\ncinfo->snd_link.cpu_dai_name = cinfo->cpu_dai.name;\r\ncinfo->snd_link.platform_name = cinfo->platform;\r\ncinfo->snd_link.codec_name = cinfo->codec;\r\ncinfo->snd_link.codec_dai_name = cinfo->codec_dai.name;\r\ncinfo->snd_link.init = asoc_simple_card_dai_init;\r\ncinfo->snd_card.name = cinfo->card;\r\ncinfo->snd_card.owner = THIS_MODULE;\r\ncinfo->snd_card.dai_link = &cinfo->snd_link;\r\ncinfo->snd_card.num_links = 1;\r\ncinfo->snd_card.dev = &pdev->dev;\r\nreturn snd_soc_register_card(&cinfo->snd_card);\r\n}\r\nstatic int asoc_simple_card_remove(struct platform_device *pdev)\r\n{\r\nstruct asoc_simple_card_info *cinfo = pdev->dev.platform_data;\r\nreturn snd_soc_unregister_card(&cinfo->snd_card);\r\n}

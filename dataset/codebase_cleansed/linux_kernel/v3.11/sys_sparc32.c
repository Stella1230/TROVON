asmlinkage long sys32_truncate64(const char __user * path, unsigned long high, unsigned long low)\r\n{\r\nif ((int)high < 0)\r\nreturn -EINVAL;\r\nelse\r\nreturn sys_truncate(path, (high << 32) | low);\r\n}\r\nasmlinkage long sys32_ftruncate64(unsigned int fd, unsigned long high, unsigned long low)\r\n{\r\nif ((int)high < 0)\r\nreturn -EINVAL;\r\nelse\r\nreturn sys_ftruncate(fd, (high << 32) | low);\r\n}\r\nstatic int cp_compat_stat64(struct kstat *stat,\r\nstruct compat_stat64 __user *statbuf)\r\n{\r\nint err;\r\nerr = put_user(huge_encode_dev(stat->dev), &statbuf->st_dev);\r\nerr |= put_user(stat->ino, &statbuf->st_ino);\r\nerr |= put_user(stat->mode, &statbuf->st_mode);\r\nerr |= put_user(stat->nlink, &statbuf->st_nlink);\r\nerr |= put_user(from_kuid_munged(current_user_ns(), stat->uid), &statbuf->st_uid);\r\nerr |= put_user(from_kgid_munged(current_user_ns(), stat->gid), &statbuf->st_gid);\r\nerr |= put_user(huge_encode_dev(stat->rdev), &statbuf->st_rdev);\r\nerr |= put_user(0, (unsigned long __user *) &statbuf->__pad3[0]);\r\nerr |= put_user(stat->size, &statbuf->st_size);\r\nerr |= put_user(stat->blksize, &statbuf->st_blksize);\r\nerr |= put_user(0, (unsigned int __user *) &statbuf->__pad4[0]);\r\nerr |= put_user(0, (unsigned int __user *) &statbuf->__pad4[4]);\r\nerr |= put_user(stat->blocks, &statbuf->st_blocks);\r\nerr |= put_user(stat->atime.tv_sec, &statbuf->st_atime);\r\nerr |= put_user(stat->atime.tv_nsec, &statbuf->st_atime_nsec);\r\nerr |= put_user(stat->mtime.tv_sec, &statbuf->st_mtime);\r\nerr |= put_user(stat->mtime.tv_nsec, &statbuf->st_mtime_nsec);\r\nerr |= put_user(stat->ctime.tv_sec, &statbuf->st_ctime);\r\nerr |= put_user(stat->ctime.tv_nsec, &statbuf->st_ctime_nsec);\r\nerr |= put_user(0, &statbuf->__unused4);\r\nerr |= put_user(0, &statbuf->__unused5);\r\nreturn err;\r\n}\r\nasmlinkage long compat_sys_stat64(const char __user * filename,\r\nstruct compat_stat64 __user *statbuf)\r\n{\r\nstruct kstat stat;\r\nint error = vfs_stat(filename, &stat);\r\nif (!error)\r\nerror = cp_compat_stat64(&stat, statbuf);\r\nreturn error;\r\n}\r\nasmlinkage long compat_sys_lstat64(const char __user * filename,\r\nstruct compat_stat64 __user *statbuf)\r\n{\r\nstruct kstat stat;\r\nint error = vfs_lstat(filename, &stat);\r\nif (!error)\r\nerror = cp_compat_stat64(&stat, statbuf);\r\nreturn error;\r\n}\r\nasmlinkage long compat_sys_fstat64(unsigned int fd,\r\nstruct compat_stat64 __user * statbuf)\r\n{\r\nstruct kstat stat;\r\nint error = vfs_fstat(fd, &stat);\r\nif (!error)\r\nerror = cp_compat_stat64(&stat, statbuf);\r\nreturn error;\r\n}\r\nasmlinkage long compat_sys_fstatat64(unsigned int dfd,\r\nconst char __user *filename,\r\nstruct compat_stat64 __user * statbuf, int flag)\r\n{\r\nstruct kstat stat;\r\nint error;\r\nerror = vfs_fstatat(dfd, filename, &stat, flag);\r\nif (error)\r\nreturn error;\r\nreturn cp_compat_stat64(&stat, statbuf);\r\n}\r\nasmlinkage compat_ssize_t sys32_pread64(unsigned int fd,\r\nchar __user *ubuf,\r\ncompat_size_t count,\r\nunsigned long poshi,\r\nunsigned long poslo)\r\n{\r\nreturn sys_pread64(fd, ubuf, count, (poshi << 32) | poslo);\r\n}\r\nasmlinkage compat_ssize_t sys32_pwrite64(unsigned int fd,\r\nchar __user *ubuf,\r\ncompat_size_t count,\r\nunsigned long poshi,\r\nunsigned long poslo)\r\n{\r\nreturn sys_pwrite64(fd, ubuf, count, (poshi << 32) | poslo);\r\n}\r\nasmlinkage long compat_sys_readahead(int fd,\r\nunsigned long offhi,\r\nunsigned long offlo,\r\ncompat_size_t count)\r\n{\r\nreturn sys_readahead(fd, (offhi << 32) | offlo, count);\r\n}\r\nlong compat_sys_fadvise64(int fd,\r\nunsigned long offhi,\r\nunsigned long offlo,\r\ncompat_size_t len, int advice)\r\n{\r\nreturn sys_fadvise64_64(fd, (offhi << 32) | offlo, len, advice);\r\n}\r\nlong compat_sys_fadvise64_64(int fd,\r\nunsigned long offhi, unsigned long offlo,\r\nunsigned long lenhi, unsigned long lenlo,\r\nint advice)\r\n{\r\nreturn sys_fadvise64_64(fd,\r\n(offhi << 32) | offlo,\r\n(lenhi << 32) | lenlo,\r\nadvice);\r\n}\r\nlong sys32_sync_file_range(unsigned int fd, unsigned long off_high, unsigned long off_low, unsigned long nb_high, unsigned long nb_low, unsigned int flags)\r\n{\r\nreturn sys_sync_file_range(fd,\r\n(off_high << 32) | off_low,\r\n(nb_high << 32) | nb_low,\r\nflags);\r\n}\r\nasmlinkage long compat_sys_fallocate(int fd, int mode, u32 offhi, u32 offlo,\r\nu32 lenhi, u32 lenlo)\r\n{\r\nreturn sys_fallocate(fd, mode, ((loff_t)offhi << 32) | offlo,\r\n((loff_t)lenhi << 32) | lenlo);\r\n}

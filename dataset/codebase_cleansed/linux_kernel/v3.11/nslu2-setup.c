static void nslu2_power_off(void)\r\n{\r\ngpio_line_config(NSLU2_PO_GPIO, IXP4XX_GPIO_OUT);\r\ngpio_line_set(NSLU2_PO_GPIO, IXP4XX_GPIO_HIGH);\r\n}\r\nstatic irqreturn_t nslu2_power_handler(int irq, void *dev_id)\r\n{\r\nctrl_alt_del();\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t nslu2_reset_handler(int irq, void *dev_id)\r\n{\r\nmachine_power_off();\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void __init nslu2_timer_init(void)\r\n{\r\nixp4xx_timer_freq = NSLU2_FREQ;\r\nixp4xx_timer_init();\r\n}\r\nstatic void __init nslu2_init(void)\r\n{\r\nuint8_t __iomem *f;\r\nint i;\r\nixp4xx_sys_init();\r\nnslu2_flash_resource.start = IXP4XX_EXP_BUS_BASE(0);\r\nnslu2_flash_resource.end =\r\nIXP4XX_EXP_BUS_BASE(0) + ixp4xx_exp_bus_size - 1;\r\ni2c_register_board_info(0, nslu2_i2c_board_info,\r\nARRAY_SIZE(nslu2_i2c_board_info));\r\n(void)platform_device_register(&nslu2_uart);\r\nplatform_add_devices(nslu2_devices, ARRAY_SIZE(nslu2_devices));\r\npm_power_off = nslu2_power_off;\r\nif (request_irq(gpio_to_irq(NSLU2_RB_GPIO), &nslu2_reset_handler,\r\nIRQF_DISABLED | IRQF_TRIGGER_LOW,\r\n"NSLU2 reset button", NULL) < 0) {\r\nprintk(KERN_DEBUG "Reset Button IRQ %d not available\n",\r\ngpio_to_irq(NSLU2_RB_GPIO));\r\n}\r\nif (request_irq(gpio_to_irq(NSLU2_PB_GPIO), &nslu2_power_handler,\r\nIRQF_DISABLED | IRQF_TRIGGER_HIGH,\r\n"NSLU2 power button", NULL) < 0) {\r\nprintk(KERN_DEBUG "Power Button IRQ %d not available\n",\r\ngpio_to_irq(NSLU2_PB_GPIO));\r\n}\r\nf = ioremap(IXP4XX_EXP_BUS_BASE(0), 0x40000);\r\nif (f) {\r\nfor (i = 0; i < 6; i++)\r\n#ifdef __ARMEB__\r\nnslu2_plat_eth[0].hwaddr[i] = readb(f + 0x3FFB0 + i);\r\n#else\r\nnslu2_plat_eth[0].hwaddr[i] = readb(f + 0x3FFB0 + (i^3));\r\n#endif\r\niounmap(f);\r\n}\r\nprintk(KERN_INFO "NSLU2: Using MAC address %pM for port 0\n",\r\nnslu2_plat_eth[0].hwaddr);\r\n}

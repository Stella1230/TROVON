static int __init toim3232_sir_init(void)\r\n{\r\nif (toim3232delay < 1 || toim3232delay > 500)\r\ntoim3232delay = 200;\r\nIRDA_DEBUG(1, "%s - using %d ms delay\n",\r\ntoim3232.driver_name, toim3232delay);\r\nreturn irda_register_dongle(&toim3232);\r\n}\r\nstatic void __exit toim3232_sir_cleanup(void)\r\n{\r\nirda_unregister_dongle(&toim3232);\r\n}\r\nstatic int toim3232_open(struct sir_dev *dev)\r\n{\r\nstruct qos_info *qos = &dev->qos;\r\nIRDA_DEBUG(2, "%s()\n", __func__);\r\nsirdev_set_dtr_rts(dev, TRUE, TRUE);\r\nqos->baud_rate.bits &= IR_2400|IR_9600|IR_19200|IR_38400|IR_57600|IR_115200;\r\nqos->min_turn_time.bits = 0x01;\r\nirda_qos_bits_to_value(qos);\r\nreturn 0;\r\n}\r\nstatic int toim3232_close(struct sir_dev *dev)\r\n{\r\nIRDA_DEBUG(2, "%s()\n", __func__);\r\nsirdev_set_dtr_rts(dev, FALSE, FALSE);\r\nreturn 0;\r\n}\r\nstatic int toim3232_change_speed(struct sir_dev *dev, unsigned speed)\r\n{\r\nunsigned state = dev->fsm.substate;\r\nunsigned delay = 0;\r\nu8 byte;\r\nstatic int ret = 0;\r\nIRDA_DEBUG(2, "%s()\n", __func__);\r\nswitch(state) {\r\ncase SIRDEV_STATE_DONGLE_SPEED:\r\nswitch (speed) {\r\ncase 2400:\r\nbyte = TOIM3232_PW|TOIM3232_2400;\r\nbreak;\r\ndefault:\r\nspeed = 9600;\r\nret = -EINVAL;\r\ncase 9600:\r\nbyte = TOIM3232_PW|TOIM3232_9600;\r\nbreak;\r\ncase 19200:\r\nbyte = TOIM3232_PW|TOIM3232_19200;\r\nbreak;\r\ncase 38400:\r\nbyte = TOIM3232_PW|TOIM3232_38400;\r\nbreak;\r\ncase 57600:\r\nbyte = TOIM3232_PW|TOIM3232_57600;\r\nbreak;\r\ncase 115200:\r\nbyte = TOIM3232_115200;\r\nbreak;\r\n}\r\nsirdev_set_dtr_rts(dev, TRUE, FALSE);\r\nudelay(14);\r\nsirdev_raw_write(dev, &byte, 1);\r\ndev->speed = speed;\r\nstate = TOIM3232_STATE_WAIT_SPEED;\r\ndelay = toim3232delay;\r\nbreak;\r\ncase TOIM3232_STATE_WAIT_SPEED:\r\nudelay(14);\r\nsirdev_set_dtr_rts(dev, TRUE, TRUE);\r\nudelay(50);\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "%s - undefined state %d\n", __func__, state);\r\nret = -EINVAL;\r\nbreak;\r\n}\r\ndev->fsm.substate = state;\r\nreturn (delay > 0) ? delay : ret;\r\n}\r\nstatic int toim3232_reset(struct sir_dev *dev)\r\n{\r\nIRDA_DEBUG(2, "%s()\n", __func__);\r\nsirdev_set_dtr_rts(dev, FALSE, FALSE);\r\nset_current_state(TASK_UNINTERRUPTIBLE);\r\nschedule_timeout(msecs_to_jiffies(50));\r\nsirdev_set_dtr_rts(dev, TRUE, TRUE);\r\nset_current_state(TASK_UNINTERRUPTIBLE);\r\nschedule_timeout(msecs_to_jiffies(10));\r\ndev->speed = 9600;\r\nreturn 0;\r\n}

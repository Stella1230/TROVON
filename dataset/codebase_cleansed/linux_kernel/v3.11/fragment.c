int squashfs_frag_lookup(struct super_block *sb, unsigned int fragment,\r\nu64 *fragment_block)\r\n{\r\nstruct squashfs_sb_info *msblk = sb->s_fs_info;\r\nint block = SQUASHFS_FRAGMENT_INDEX(fragment);\r\nint offset = SQUASHFS_FRAGMENT_INDEX_OFFSET(fragment);\r\nu64 start_block = le64_to_cpu(msblk->fragment_index[block]);\r\nstruct squashfs_fragment_entry fragment_entry;\r\nint size;\r\nsize = squashfs_read_metadata(sb, &fragment_entry, &start_block,\r\n&offset, sizeof(fragment_entry));\r\nif (size < 0)\r\nreturn size;\r\n*fragment_block = le64_to_cpu(fragment_entry.start_block);\r\nsize = le32_to_cpu(fragment_entry.size);\r\nreturn size;\r\n}\r\n__le64 *squashfs_read_fragment_index_table(struct super_block *sb,\r\nu64 fragment_table_start, u64 next_table, unsigned int fragments)\r\n{\r\nunsigned int length = SQUASHFS_FRAGMENT_INDEX_BYTES(fragments);\r\n__le64 *table;\r\nif (fragment_table_start + length > next_table)\r\nreturn ERR_PTR(-EINVAL);\r\ntable = squashfs_read_table(sb, fragment_table_start, length);\r\nif (!IS_ERR(table) && le64_to_cpu(table[0]) >= fragment_table_start) {\r\nkfree(table);\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nreturn table;\r\n}

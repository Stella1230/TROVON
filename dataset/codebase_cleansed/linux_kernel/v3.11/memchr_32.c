void *memchr(const void *s, int c, size_t n)\r\n{\r\nconst uint32_t *last_word_ptr;\r\nconst uint32_t *p;\r\nconst char *last_byte_ptr;\r\nuintptr_t s_int;\r\nuint32_t goal, before_mask, v, bits;\r\nchar *ret;\r\nif (__builtin_expect(n == 0, 0)) {\r\nreturn NULL;\r\n}\r\ns_int = (uintptr_t) s;\r\np = (const uint32_t *)(s_int & -4);\r\ngoal = 0x01010101 * (uint8_t) c;\r\nbefore_mask = (1 << (s_int << 3)) - 1;\r\nv = (*p | before_mask) ^ (goal & before_mask);\r\nlast_byte_ptr = (const char *)s + n - 1;\r\nlast_word_ptr = (const uint32_t *)((uintptr_t) last_byte_ptr & -4);\r\nwhile ((bits = __insn_seqb(v, goal)) == 0) {\r\nif (__builtin_expect(p == last_word_ptr, 0)) {\r\nreturn NULL;\r\n}\r\nv = *++p;\r\n}\r\nret = ((char *)p) + (__insn_ctz(bits) >> 3);\r\nreturn (ret <= last_byte_ptr) ? ret : NULL;\r\n}

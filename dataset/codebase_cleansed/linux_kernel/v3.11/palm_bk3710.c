static void palm_bk3710_setudmamode(void __iomem *base, unsigned int dev,\r\nunsigned int mode)\r\n{\r\nu8 tenv, trp, t0;\r\nu32 val32;\r\nu16 val16;\r\nt0 = DIV_ROUND_UP(palm_bk3710_udmatimings[mode].cycletime,\r\nideclk_period) - 1;\r\ntenv = DIV_ROUND_UP(20, ideclk_period) - 1;\r\ntrp = DIV_ROUND_UP(palm_bk3710_udmatimings[mode].rptime,\r\nideclk_period) - 1;\r\nval32 = readl(base + BK3710_UDMASTB) & (0xFF << (dev ? 0 : 8));\r\nval32 |= (t0 << (dev ? 8 : 0));\r\nwritel(val32, base + BK3710_UDMASTB);\r\nval32 = readl(base + BK3710_UDMATRP) & (0xFF << (dev ? 0 : 8));\r\nval32 |= (trp << (dev ? 8 : 0));\r\nwritel(val32, base + BK3710_UDMATRP);\r\nval32 = readl(base + BK3710_UDMAENV) & (0xFF << (dev ? 0 : 8));\r\nval32 |= (tenv << (dev ? 8 : 0));\r\nwritel(val32, base + BK3710_UDMAENV);\r\nval16 = readw(base + BK3710_UDMACTL) | (1 << dev);\r\nwritew(val16, base + BK3710_UDMACTL);\r\n}\r\nstatic void palm_bk3710_setdmamode(void __iomem *base, unsigned int dev,\r\nunsigned short min_cycle,\r\nunsigned int mode)\r\n{\r\nu8 td, tkw, t0;\r\nu32 val32;\r\nu16 val16;\r\nstruct ide_timing *t;\r\nint cycletime;\r\nt = ide_timing_find_mode(mode);\r\ncycletime = max_t(int, t->cycle, min_cycle);\r\nt0 = DIV_ROUND_UP(cycletime, ideclk_period);\r\ntd = DIV_ROUND_UP(t->active, ideclk_period);\r\ntkw = t0 - td - 1;\r\ntd -= 1;\r\nval32 = readl(base + BK3710_DMASTB) & (0xFF << (dev ? 0 : 8));\r\nval32 |= (td << (dev ? 8 : 0));\r\nwritel(val32, base + BK3710_DMASTB);\r\nval32 = readl(base + BK3710_DMARCVR) & (0xFF << (dev ? 0 : 8));\r\nval32 |= (tkw << (dev ? 8 : 0));\r\nwritel(val32, base + BK3710_DMARCVR);\r\nval16 = readw(base + BK3710_UDMACTL) & ~(1 << dev);\r\nwritew(val16, base + BK3710_UDMACTL);\r\n}\r\nstatic void palm_bk3710_setpiomode(void __iomem *base, ide_drive_t *mate,\r\nunsigned int dev, unsigned int cycletime,\r\nunsigned int mode)\r\n{\r\nu8 t2, t2i, t0;\r\nu32 val32;\r\nstruct ide_timing *t;\r\nt = ide_timing_find_mode(XFER_PIO_0 + mode);\r\nt0 = DIV_ROUND_UP(cycletime, ideclk_period);\r\nt2 = DIV_ROUND_UP(t->active, ideclk_period);\r\nt2i = t0 - t2 - 1;\r\nt2 -= 1;\r\nval32 = readl(base + BK3710_DATSTB) & (0xFF << (dev ? 0 : 8));\r\nval32 |= (t2 << (dev ? 8 : 0));\r\nwritel(val32, base + BK3710_DATSTB);\r\nval32 = readl(base + BK3710_DATRCVR) & (0xFF << (dev ? 0 : 8));\r\nval32 |= (t2i << (dev ? 8 : 0));\r\nwritel(val32, base + BK3710_DATRCVR);\r\nif (mate) {\r\nu8 mode2 = mate->pio_mode - XFER_PIO_0;\r\nif (mode2 < mode)\r\nmode = mode2;\r\n}\r\nt0 = DIV_ROUND_UP(t->cyc8b, ideclk_period);\r\nt2 = DIV_ROUND_UP(t->act8b, ideclk_period);\r\nt2i = t0 - t2 - 1;\r\nt2 -= 1;\r\nval32 = readl(base + BK3710_REGSTB) & (0xFF << (dev ? 0 : 8));\r\nval32 |= (t2 << (dev ? 8 : 0));\r\nwritel(val32, base + BK3710_REGSTB);\r\nval32 = readl(base + BK3710_REGRCVR) & (0xFF << (dev ? 0 : 8));\r\nval32 |= (t2i << (dev ? 8 : 0));\r\nwritel(val32, base + BK3710_REGRCVR);\r\n}\r\nstatic void palm_bk3710_set_dma_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nint is_slave = drive->dn & 1;\r\nvoid __iomem *base = (void *)hwif->dma_base;\r\nconst u8 xferspeed = drive->dma_mode;\r\nif (xferspeed >= XFER_UDMA_0) {\r\npalm_bk3710_setudmamode(base, is_slave,\r\nxferspeed - XFER_UDMA_0);\r\n} else {\r\npalm_bk3710_setdmamode(base, is_slave,\r\ndrive->id[ATA_ID_EIDE_DMA_MIN],\r\nxferspeed);\r\n}\r\n}\r\nstatic void palm_bk3710_set_pio_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nunsigned int cycle_time;\r\nint is_slave = drive->dn & 1;\r\nide_drive_t *mate;\r\nvoid __iomem *base = (void *)hwif->dma_base;\r\nconst u8 pio = drive->pio_mode - XFER_PIO_0;\r\ncycle_time = ide_pio_cycle_time(drive, pio);\r\nmate = ide_get_pair_dev(drive);\r\npalm_bk3710_setpiomode(base, mate, is_slave, cycle_time, pio);\r\n}\r\nstatic void palm_bk3710_chipinit(void __iomem *base)\r\n{\r\nwritew(BIT(15), base + BK3710_IDETIMP);\r\nwritew(0, base + BK3710_UDMACTL);\r\nwritel(0x001, base + BK3710_MISCCTL);\r\nwritel(0xFFFF, base + BK3710_IORDYTMP);\r\nwritew(0, base + BK3710_BMISP);\r\npalm_bk3710_setpiomode(base, NULL, 0, 600, 0);\r\npalm_bk3710_setpiomode(base, NULL, 1, 600, 0);\r\n}\r\nstatic u8 palm_bk3710_cable_detect(ide_hwif_t *hwif)\r\n{\r\nreturn ATA_CBL_PATA80;\r\n}\r\nstatic int palm_bk3710_init_dma(ide_hwif_t *hwif, const struct ide_port_info *d)\r\n{\r\nprintk(KERN_INFO " %s: MMIO-DMA\n", hwif->name);\r\nif (ide_allocate_dma_engine(hwif))\r\nreturn -1;\r\nhwif->dma_base = hwif->io_ports.data_addr - IDE_PALM_ATA_PRI_REG_OFFSET;\r\nreturn 0;\r\n}\r\nstatic int __init palm_bk3710_probe(struct platform_device *pdev)\r\n{\r\nstruct clk *clk;\r\nstruct resource *mem, *irq;\r\nvoid __iomem *base;\r\nunsigned long rate, mem_size;\r\nint i, rc;\r\nstruct ide_hw hw, *hws[] = { &hw };\r\nclk = clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(clk))\r\nreturn -ENODEV;\r\nclk_enable(clk);\r\nrate = clk_get_rate(clk);\r\nideclk_period = 1000000000UL / rate;\r\nmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (mem == NULL) {\r\nprintk(KERN_ERR "failed to get memory region resource\n");\r\nreturn -ENODEV;\r\n}\r\nirq = platform_get_resource(pdev, IORESOURCE_IRQ, 0);\r\nif (irq == NULL) {\r\nprintk(KERN_ERR "failed to get IRQ resource\n");\r\nreturn -ENODEV;\r\n}\r\nmem_size = resource_size(mem);\r\nif (request_mem_region(mem->start, mem_size, "palm_bk3710") == NULL) {\r\nprintk(KERN_ERR "failed to request memory region\n");\r\nreturn -EBUSY;\r\n}\r\nbase = ioremap(mem->start, mem_size);\r\nif (!base) {\r\nprintk(KERN_ERR "failed to map IO memory\n");\r\nrelease_mem_region(mem->start, mem_size);\r\nreturn -ENOMEM;\r\n}\r\npalm_bk3710_chipinit(base);\r\nmemset(&hw, 0, sizeof(hw));\r\nfor (i = 0; i < IDE_NR_PORTS - 2; i++)\r\nhw.io_ports_array[i] = (unsigned long)\r\n(base + IDE_PALM_ATA_PRI_REG_OFFSET + i);\r\nhw.io_ports.ctl_addr = (unsigned long)\r\n(base + IDE_PALM_ATA_PRI_CTL_OFFSET);\r\nhw.irq = irq->start;\r\nhw.dev = &pdev->dev;\r\npalm_bk3710_port_info.udma_mask = rate < 100000000 ? ATA_UDMA4 :\r\nATA_UDMA5;\r\nrc = ide_host_add(&palm_bk3710_port_info, hws, 1, NULL);\r\nif (rc)\r\ngoto out;\r\nreturn 0;\r\nout:\r\nprintk(KERN_WARNING "Palm Chip BK3710 IDE Register Fail\n");\r\nreturn rc;\r\n}\r\nstatic int __init palm_bk3710_init(void)\r\n{\r\nreturn platform_driver_probe(&platform_bk_driver, palm_bk3710_probe);\r\n}

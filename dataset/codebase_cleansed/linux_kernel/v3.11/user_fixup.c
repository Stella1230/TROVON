static unsigned long compute_size(unsigned long start, unsigned long size, unsigned long *offset)\r\n{\r\nunsigned long fault_addr = current_thread_info()->fault_address;\r\nunsigned long end = start + size;\r\nif (fault_addr < start || fault_addr >= end) {\r\n*offset = 0;\r\n} else {\r\n*offset = fault_addr - start;\r\nsize = end - fault_addr;\r\n}\r\nreturn size;\r\n}\r\nunsigned long copy_from_user_fixup(void *to, const void __user *from, unsigned long size)\r\n{\r\nunsigned long offset;\r\nsize = compute_size((unsigned long) from, size, &offset);\r\nif (likely(size))\r\nmemset(to + offset, 0, size);\r\nreturn size;\r\n}\r\nunsigned long copy_to_user_fixup(void __user *to, const void *from, unsigned long size)\r\n{\r\nunsigned long offset;\r\nreturn compute_size((unsigned long) to, size, &offset);\r\n}\r\nunsigned long copy_in_user_fixup(void __user *to, void __user *from, unsigned long size)\r\n{\r\nunsigned long fault_addr = current_thread_info()->fault_address;\r\nunsigned long start = (unsigned long) to;\r\nunsigned long end = start + size;\r\nif (fault_addr >= start && fault_addr < end)\r\nreturn end - fault_addr;\r\nstart = (unsigned long) from;\r\nend = start + size;\r\nif (fault_addr >= start && fault_addr < end)\r\nreturn end - fault_addr;\r\nreturn size;\r\n}

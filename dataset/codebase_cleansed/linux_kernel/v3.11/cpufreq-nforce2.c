static int nforce2_calc_fsb(int pll)\r\n{\r\nunsigned char mul, div;\r\nmul = (pll >> 8) & 0xff;\r\ndiv = pll & 0xff;\r\nif (div > 0)\r\nreturn NFORCE2_XTAL * mul / div;\r\nreturn 0;\r\n}\r\nstatic int nforce2_calc_pll(unsigned int fsb)\r\n{\r\nunsigned char xmul, xdiv;\r\nunsigned char mul = 0, div = 0;\r\nint tried = 0;\r\nwhile (((mul == 0) || (div == 0)) && (tried <= 3)) {\r\nfor (xdiv = 2; xdiv <= 0x80; xdiv++)\r\nfor (xmul = 1; xmul <= 0xfe; xmul++)\r\nif (nforce2_calc_fsb(NFORCE2_PLL(xmul, xdiv)) ==\r\nfsb + tried) {\r\nmul = xmul;\r\ndiv = xdiv;\r\n}\r\ntried++;\r\n}\r\nif ((mul == 0) || (div == 0))\r\nreturn -1;\r\nreturn NFORCE2_PLL(mul, div);\r\n}\r\nstatic void nforce2_write_pll(int pll)\r\n{\r\nint temp;\r\npci_write_config_dword(nforce2_dev, NFORCE2_PLLADR, 0);\r\nfor (temp = 0; temp <= 0x3f; temp++)\r\npci_write_config_dword(nforce2_dev, NFORCE2_PLLREG, pll);\r\nreturn;\r\n}\r\nstatic unsigned int nforce2_fsb_read(int bootfsb)\r\n{\r\nstruct pci_dev *nforce2_sub5;\r\nu32 fsb, temp = 0;\r\nnforce2_sub5 = pci_get_subsys(PCI_VENDOR_ID_NVIDIA, 0x01EF,\r\nPCI_ANY_ID, PCI_ANY_ID, NULL);\r\nif (!nforce2_sub5)\r\nreturn 0;\r\npci_read_config_dword(nforce2_sub5, NFORCE2_BOOTFSB, &fsb);\r\nfsb /= 1000000;\r\npci_read_config_byte(nforce2_dev, NFORCE2_PLLENABLE, (u8 *)&temp);\r\nif (bootfsb || !temp)\r\nreturn fsb;\r\npci_read_config_dword(nforce2_dev, NFORCE2_PLLREG, &temp);\r\nfsb = nforce2_calc_fsb(temp);\r\nreturn fsb;\r\n}\r\nstatic int nforce2_set_fsb(unsigned int fsb)\r\n{\r\nu32 temp = 0;\r\nunsigned int tfsb;\r\nint diff;\r\nint pll = 0;\r\nif ((fsb > max_fsb) || (fsb < NFORCE2_MIN_FSB)) {\r\nprintk(KERN_ERR PFX "FSB %d is out of range!\n", fsb);\r\nreturn -EINVAL;\r\n}\r\ntfsb = nforce2_fsb_read(0);\r\nif (!tfsb) {\r\nprintk(KERN_ERR PFX "Error while reading the FSB\n");\r\nreturn -EINVAL;\r\n}\r\npci_read_config_byte(nforce2_dev, NFORCE2_PLLENABLE, (u8 *)&temp);\r\nif (!temp) {\r\npll = nforce2_calc_pll(tfsb);\r\nif (pll < 0)\r\nreturn -EINVAL;\r\nnforce2_write_pll(pll);\r\n}\r\ntemp = 0x01;\r\npci_write_config_byte(nforce2_dev, NFORCE2_PLLENABLE, (u8)temp);\r\ndiff = tfsb - fsb;\r\nif (!diff)\r\nreturn 0;\r\nwhile ((tfsb != fsb) && (tfsb <= max_fsb) && (tfsb >= min_fsb)) {\r\nif (diff < 0)\r\ntfsb++;\r\nelse\r\ntfsb--;\r\npll = nforce2_calc_pll(tfsb);\r\nif (pll == -1)\r\nreturn -EINVAL;\r\nnforce2_write_pll(pll);\r\n#ifdef NFORCE2_DELAY\r\nmdelay(NFORCE2_DELAY);\r\n#endif\r\n}\r\ntemp = 0x40;\r\npci_write_config_byte(nforce2_dev, NFORCE2_PLLADR, (u8)temp);\r\nreturn 0;\r\n}\r\nstatic unsigned int nforce2_get(unsigned int cpu)\r\n{\r\nif (cpu)\r\nreturn 0;\r\nreturn nforce2_fsb_read(0) * fid * 100;\r\n}\r\nstatic int nforce2_target(struct cpufreq_policy *policy,\r\nunsigned int target_freq, unsigned int relation)\r\n{\r\nstruct cpufreq_freqs freqs;\r\nunsigned int target_fsb;\r\nif ((target_freq > policy->max) || (target_freq < policy->min))\r\nreturn -EINVAL;\r\ntarget_fsb = target_freq / (fid * 100);\r\nfreqs.old = nforce2_get(policy->cpu);\r\nfreqs.new = target_fsb * fid * 100;\r\nif (freqs.old == freqs.new)\r\nreturn 0;\r\npr_debug("Old CPU frequency %d kHz, new %d kHz\n",\r\nfreqs.old, freqs.new);\r\ncpufreq_notify_transition(policy, &freqs, CPUFREQ_PRECHANGE);\r\nif (nforce2_set_fsb(target_fsb) < 0)\r\nprintk(KERN_ERR PFX "Changing FSB to %d failed\n",\r\ntarget_fsb);\r\nelse\r\npr_debug("Changed FSB successfully to %d\n",\r\ntarget_fsb);\r\ncpufreq_notify_transition(policy, &freqs, CPUFREQ_POSTCHANGE);\r\nreturn 0;\r\n}\r\nstatic int nforce2_verify(struct cpufreq_policy *policy)\r\n{\r\nunsigned int fsb_pol_max;\r\nfsb_pol_max = policy->max / (fid * 100);\r\nif (policy->min < (fsb_pol_max * fid * 100))\r\npolicy->max = (fsb_pol_max + 1) * fid * 100;\r\ncpufreq_verify_within_limits(policy,\r\npolicy->cpuinfo.min_freq,\r\npolicy->cpuinfo.max_freq);\r\nreturn 0;\r\n}\r\nstatic int nforce2_cpu_init(struct cpufreq_policy *policy)\r\n{\r\nunsigned int fsb;\r\nunsigned int rfid;\r\nif (policy->cpu != 0)\r\nreturn -ENODEV;\r\nfsb = nforce2_fsb_read(0);\r\nif (!fsb)\r\nreturn -EIO;\r\nif (!fid) {\r\nif (!cpu_khz) {\r\nprintk(KERN_WARNING PFX\r\n"cpu_khz not set, can't calculate multiplier!\n");\r\nreturn -ENODEV;\r\n}\r\nfid = cpu_khz / (fsb * 100);\r\nrfid = fid % 5;\r\nif (rfid) {\r\nif (rfid > 2)\r\nfid += 5 - rfid;\r\nelse\r\nfid -= rfid;\r\n}\r\n}\r\nprintk(KERN_INFO PFX "FSB currently at %i MHz, FID %d.%d\n", fsb,\r\nfid / 10, fid % 10);\r\nmax_fsb = nforce2_fsb_read(1);\r\nif (!max_fsb)\r\nreturn -EIO;\r\nif (!min_fsb)\r\nmin_fsb = max_fsb - NFORCE2_SAFE_DISTANCE;\r\nif (min_fsb < NFORCE2_MIN_FSB)\r\nmin_fsb = NFORCE2_MIN_FSB;\r\npolicy->min = policy->cpuinfo.min_freq = min_fsb * fid * 100;\r\npolicy->max = policy->cpuinfo.max_freq = max_fsb * fid * 100;\r\npolicy->cpuinfo.transition_latency = CPUFREQ_ETERNAL;\r\npolicy->cur = nforce2_get(policy->cpu);\r\nreturn 0;\r\n}\r\nstatic int nforce2_cpu_exit(struct cpufreq_policy *policy)\r\n{\r\nreturn 0;\r\n}\r\nstatic int nforce2_detect_chipset(void)\r\n{\r\nnforce2_dev = pci_get_subsys(PCI_VENDOR_ID_NVIDIA,\r\nPCI_DEVICE_ID_NVIDIA_NFORCE2,\r\nPCI_ANY_ID, PCI_ANY_ID, NULL);\r\nif (nforce2_dev == NULL)\r\nreturn -ENODEV;\r\nprintk(KERN_INFO PFX "Detected nForce2 chipset revision %X\n",\r\nnforce2_dev->revision);\r\nprintk(KERN_INFO PFX\r\n"FSB changing is maybe unstable and can lead to "\r\n"crashes and data loss.\n");\r\nreturn 0;\r\n}\r\nstatic int __init nforce2_init(void)\r\n{\r\nif (nforce2_detect_chipset()) {\r\nprintk(KERN_INFO PFX "No nForce2 chipset.\n");\r\nreturn -ENODEV;\r\n}\r\nreturn cpufreq_register_driver(&nforce2_driver);\r\n}\r\nstatic void __exit nforce2_exit(void)\r\n{\r\ncpufreq_unregister_driver(&nforce2_driver);\r\n}

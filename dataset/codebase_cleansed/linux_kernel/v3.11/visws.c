static int pci_visws_enable_irq(struct pci_dev *dev) { return 0; }\r\nstatic void pci_visws_disable_irq(struct pci_dev *dev) { }\r\nstatic int __init visws_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nint irq, bus = dev->bus->number;\r\npin--;\r\nif (bus == pci_bus0 && slot == 4 && pin == 0)\r\nreturn -1;\r\nif (bus == pci_bus0 && slot == 4 && pin == 3) {\r\nirq = CO_IRQ(CO_APIC_PIIX4_USB);\r\ngoto out;\r\n}\r\nif (pin == 0) {\r\nirq = CO_IRQ((bus == pci_bus0 ? CO_APIC_PCIB_BASE0 :\r\nCO_APIC_PCIA_BASE0) + slot);\r\ngoto out;\r\n}\r\nif (bus == pci_bus1) {\r\nirq = CO_IRQ(CO_APIC_PCIA_BASE123 + ((slot + (pin - 1)) % 2));\r\n} else {\r\nif (slot == 0)\r\nslot = 3;\r\nirq = CO_IRQ(CO_APIC_PCIA_BASE123 + ((3 - slot) + (pin - 1) % 3));\r\n}\r\nout:\r\nprintk(KERN_DEBUG "PCI: Bus %d Slot %d Line %d -> IRQ %d\n", bus, slot, pin, irq);\r\nreturn irq;\r\n}\r\nint __init pci_visws_init(void)\r\n{\r\npcibios_enable_irq = &pci_visws_enable_irq;\r\npcibios_disable_irq = &pci_visws_disable_irq;\r\npci_probe = (pci_probe | PCI_PROBE_CONF1) &\r\n~(PCI_PROBE_BIOS | PCI_PROBE_CONF2);\r\npci_bus0 = li_pcib_read16(LI_PCI_BUSNUM) & 0xff;\r\npci_bus1 = li_pcia_read16(LI_PCI_BUSNUM) & 0xff;\r\nprintk(KERN_INFO "PCI: Lithium bridge A bus: %u, "\r\n"bridge B (PIIX4) bus: %u\n", pci_bus1, pci_bus0);\r\nraw_pci_ops = &pci_direct_conf1;\r\npci_scan_bus_with_sysdata(pci_bus0);\r\npci_scan_bus_with_sysdata(pci_bus1);\r\npci_fixup_irqs(pci_common_swizzle, visws_map_irq);\r\npcibios_resource_survey();\r\nreturn 1;\r\n}

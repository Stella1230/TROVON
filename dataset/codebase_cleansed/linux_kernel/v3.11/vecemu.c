static unsigned int eexp2(unsigned int s)\r\n{\r\nint exp, pwr;\r\nunsigned int mant, frac;\r\nexp = ((s >> 23) & 0xff) - 127;\r\nif (exp > 7) {\r\nif (exp == 128 && (s & 0x7fffff) != 0)\r\nreturn s | 0x400000;\r\nreturn (s & 0x80000000)? 0: 0x7f800000;\r\n}\r\nif (exp < -23)\r\nreturn 0x3f800000;\r\npwr = (s & 0x7fffff) | 0x800000;\r\nif (exp > 0)\r\npwr <<= exp;\r\nelse\r\npwr >>= -exp;\r\nif (s & 0x80000000)\r\npwr = -pwr;\r\nexp = (pwr >> 23) + 126;\r\nif (exp >= 254)\r\nreturn 0x7f800000;\r\nif (exp < -23)\r\nreturn 0;\r\nmant = exp2s[(pwr >> 20) & 7];\r\nasm("mulhwu %0,%1,%2" : "=r" (frac)\r\n: "r" (pwr << 12), "r" (0x172b83ff));\r\nasm("mulhwu %0,%1,%2" : "=r" (frac) : "r" (frac), "r" (mant));\r\nmant += frac;\r\nif (exp >= 0)\r\nreturn mant + (exp << 23);\r\nexp = -exp;\r\nmant += 1 << (exp - 1);\r\nreturn mant >> exp;\r\n}\r\nstatic unsigned int elog2(unsigned int s)\r\n{\r\nint exp, mant, lz, frac;\r\nexp = s & 0x7f800000;\r\nmant = s & 0x7fffff;\r\nif (exp == 0x7f800000) {\r\nif (mant != 0)\r\ns |= 0x400000;\r\nreturn s;\r\n}\r\nif ((exp | mant) == 0)\r\nreturn 0xff800000;\r\nif (exp == 0) {\r\nasm("cntlzw %0,%1" : "=r" (lz) : "r" (mant));\r\nmant <<= lz - 8;\r\nexp = (-118 - lz) << 23;\r\n} else {\r\nmant |= 0x800000;\r\nexp -= 127 << 23;\r\n}\r\nif (mant >= 0xb504f3) {\r\nexp |= 0x400000;\r\nasm("mulhwu %0,%1,%2" : "=r" (mant)\r\n: "r" (mant), "r" (0xb504f334));\r\n}\r\nif (mant >= 0x9837f0) {\r\nexp |= 0x200000;\r\nasm("mulhwu %0,%1,%2" : "=r" (mant)\r\n: "r" (mant), "r" (0xd744fccb));\r\n}\r\nif (mant >= 0x8b95c2) {\r\nexp |= 0x100000;\r\nasm("mulhwu %0,%1,%2" : "=r" (mant)\r\n: "r" (mant), "r" (0xeac0c6e8));\r\n}\r\nif (mant > 0x800000) {\r\nasm("mulhwu %0,%1,%2" : "=r" (frac)\r\n: "r" ((mant - 0x800000) << 1), "r" (0xb0c7cd3a));\r\nexp += frac;\r\n}\r\ns = exp & 0x80000000;\r\nif (exp != 0) {\r\nif (s)\r\nexp = -exp;\r\nasm("cntlzw %0,%1" : "=r" (lz) : "r" (exp));\r\nlz = 8 - lz;\r\nif (lz > 0)\r\nexp >>= lz;\r\nelse if (lz < 0)\r\nexp <<= -lz;\r\ns += ((lz + 126) << 23) + exp;\r\n}\r\nreturn s;\r\n}\r\nstatic int ctsxs(unsigned int x, int scale, unsigned int *vscrp)\r\n{\r\nint exp, mant;\r\nexp = (x >> 23) & 0xff;\r\nmant = x & 0x7fffff;\r\nif (exp == 255 && mant != 0)\r\nreturn 0;\r\nexp = exp - 127 + scale;\r\nif (exp < 0)\r\nreturn 0;\r\nif (exp >= 31) {\r\nif (x + (scale << 23) != 0xcf000000)\r\n*vscrp |= VSCR_SAT;\r\nreturn (x & 0x80000000)? 0x80000000: 0x7fffffff;\r\n}\r\nmant |= 0x800000;\r\nmant = (mant << 7) >> (30 - exp);\r\nreturn (x & 0x80000000)? -mant: mant;\r\n}\r\nstatic unsigned int ctuxs(unsigned int x, int scale, unsigned int *vscrp)\r\n{\r\nint exp;\r\nunsigned int mant;\r\nexp = (x >> 23) & 0xff;\r\nmant = x & 0x7fffff;\r\nif (exp == 255 && mant != 0)\r\nreturn 0;\r\nexp = exp - 127 + scale;\r\nif (exp < 0)\r\nreturn 0;\r\nif (x & 0x80000000) {\r\n*vscrp |= VSCR_SAT;\r\nreturn 0;\r\n}\r\nif (exp >= 32) {\r\n*vscrp |= VSCR_SAT;\r\nreturn 0xffffffff;\r\n}\r\nmant |= 0x800000;\r\nmant = (mant << 8) >> (31 - exp);\r\nreturn mant;\r\n}\r\nstatic unsigned int rfiz(unsigned int x)\r\n{\r\nint exp;\r\nexp = ((x >> 23) & 0xff) - 127;\r\nif (exp == 128 && (x & 0x7fffff) != 0)\r\nreturn x | 0x400000;\r\nif (exp >= 23)\r\nreturn x;\r\nif (exp < 0)\r\nreturn x & 0x80000000;\r\nreturn x & ~(0x7fffff >> exp);\r\n}\r\nstatic unsigned int rfii(unsigned int x)\r\n{\r\nint exp, mask;\r\nexp = ((x >> 23) & 0xff) - 127;\r\nif (exp == 128 && (x & 0x7fffff) != 0)\r\nreturn x | 0x400000;\r\nif (exp >= 23)\r\nreturn x;\r\nif ((x & 0x7fffffff) == 0)\r\nreturn x;\r\nif (exp < 0)\r\nreturn (x & 0x80000000) | 0x3f800000;\r\nmask = 0x7fffff >> exp;\r\nreturn (x + mask) & ~mask;\r\n}\r\nstatic unsigned int rfin(unsigned int x)\r\n{\r\nint exp, half;\r\nexp = ((x >> 23) & 0xff) - 127;\r\nif (exp == 128 && (x & 0x7fffff) != 0)\r\nreturn x | 0x400000;\r\nif (exp >= 23)\r\nreturn x;\r\nif (exp < -1)\r\nreturn x & 0x80000000;\r\nif (exp == -1)\r\nreturn (x & 0x80000000) | 0x3f800000;\r\nhalf = 0x400000 >> exp;\r\nreturn (x + half) & ~(0x7fffff >> exp);\r\n}\r\nint emulate_altivec(struct pt_regs *regs)\r\n{\r\nunsigned int instr, i;\r\nunsigned int va, vb, vc, vd;\r\nvector128 *vrs;\r\nif (get_user(instr, (unsigned int __user *) regs->nip))\r\nreturn -EFAULT;\r\nif ((instr >> 26) != 4)\r\nreturn -EINVAL;\r\nvd = (instr >> 21) & 0x1f;\r\nva = (instr >> 16) & 0x1f;\r\nvb = (instr >> 11) & 0x1f;\r\nvc = (instr >> 6) & 0x1f;\r\nvrs = current->thread.vr;\r\nswitch (instr & 0x3f) {\r\ncase 10:\r\nswitch (vc) {\r\ncase 0:\r\nvaddfp(&vrs[vd], &vrs[va], &vrs[vb]);\r\nbreak;\r\ncase 1:\r\nvsubfp(&vrs[vd], &vrs[va], &vrs[vb]);\r\nbreak;\r\ncase 4:\r\nvrefp(&vrs[vd], &vrs[vb]);\r\nbreak;\r\ncase 5:\r\nvrsqrtefp(&vrs[vd], &vrs[vb]);\r\nbreak;\r\ncase 6:\r\nfor (i = 0; i < 4; ++i)\r\nvrs[vd].u[i] = eexp2(vrs[vb].u[i]);\r\nbreak;\r\ncase 7:\r\nfor (i = 0; i < 4; ++i)\r\nvrs[vd].u[i] = elog2(vrs[vb].u[i]);\r\nbreak;\r\ncase 8:\r\nfor (i = 0; i < 4; ++i)\r\nvrs[vd].u[i] = rfin(vrs[vb].u[i]);\r\nbreak;\r\ncase 9:\r\nfor (i = 0; i < 4; ++i)\r\nvrs[vd].u[i] = rfiz(vrs[vb].u[i]);\r\nbreak;\r\ncase 10:\r\nfor (i = 0; i < 4; ++i) {\r\nu32 x = vrs[vb].u[i];\r\nx = (x & 0x80000000)? rfiz(x): rfii(x);\r\nvrs[vd].u[i] = x;\r\n}\r\nbreak;\r\ncase 11:\r\nfor (i = 0; i < 4; ++i) {\r\nu32 x = vrs[vb].u[i];\r\nx = (x & 0x80000000)? rfii(x): rfiz(x);\r\nvrs[vd].u[i] = x;\r\n}\r\nbreak;\r\ncase 14:\r\nfor (i = 0; i < 4; ++i)\r\nvrs[vd].u[i] = ctuxs(vrs[vb].u[i], va,\r\n&current->thread.vscr.u[3]);\r\nbreak;\r\ncase 15:\r\nfor (i = 0; i < 4; ++i)\r\nvrs[vd].u[i] = ctsxs(vrs[vb].u[i], va,\r\n&current->thread.vscr.u[3]);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ncase 46:\r\nvmaddfp(&vrs[vd], &vrs[va], &vrs[vb], &vrs[vc]);\r\nbreak;\r\ncase 47:\r\nvnmsubfp(&vrs[vd], &vrs[va], &vrs[vb], &vrs[vc]);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}

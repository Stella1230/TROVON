static __init int module_verify_init(void)\r\n{\r\npr_notice("Initialise module verification\n");\r\nmodsign_keyring = keyring_alloc(".module_sign",\r\nKUIDT_INIT(0), KGIDT_INIT(0),\r\ncurrent_cred(),\r\n((KEY_POS_ALL & ~KEY_POS_SETATTR) |\r\nKEY_USR_VIEW | KEY_USR_READ),\r\nKEY_ALLOC_NOT_IN_QUOTA, NULL);\r\nif (IS_ERR(modsign_keyring))\r\npanic("Can't allocate module signing keyring\n");\r\nreturn 0;\r\n}\r\nstatic __init int load_module_signing_keys(void)\r\n{\r\nkey_ref_t key;\r\nconst u8 *p, *end;\r\nsize_t plen;\r\npr_notice("Loading module verification certificates\n");\r\nend = modsign_certificate_list_end;\r\np = modsign_certificate_list;\r\nwhile (p < end) {\r\nif (end - p < 4)\r\ngoto dodgy_cert;\r\nif (p[0] != 0x30 &&\r\np[1] != 0x82)\r\ngoto dodgy_cert;\r\nplen = (p[2] << 8) | p[3];\r\nplen += 4;\r\nif (plen > end - p)\r\ngoto dodgy_cert;\r\nkey = key_create_or_update(make_key_ref(modsign_keyring, 1),\r\n"asymmetric",\r\nNULL,\r\np,\r\nplen,\r\n(KEY_POS_ALL & ~KEY_POS_SETATTR) |\r\nKEY_USR_VIEW,\r\nKEY_ALLOC_NOT_IN_QUOTA);\r\nif (IS_ERR(key))\r\npr_err("MODSIGN: Problem loading in-kernel X.509 certificate (%ld)\n",\r\nPTR_ERR(key));\r\nelse\r\npr_notice("MODSIGN: Loaded cert '%s'\n",\r\nkey_ref_to_ptr(key)->description);\r\np += plen;\r\n}\r\nreturn 0;\r\ndodgy_cert:\r\npr_err("MODSIGN: Problem parsing in-kernel X.509 certificate list\n");\r\nreturn 0;\r\n}

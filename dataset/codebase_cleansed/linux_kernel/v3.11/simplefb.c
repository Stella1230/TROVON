static int simplefb_setcolreg(u_int regno, u_int red, u_int green, u_int blue,\r\nu_int transp, struct fb_info *info)\r\n{\r\nu32 *pal = info->pseudo_palette;\r\nu32 cr = red >> (16 - info->var.red.length);\r\nu32 cg = green >> (16 - info->var.green.length);\r\nu32 cb = blue >> (16 - info->var.blue.length);\r\nu32 value;\r\nif (regno >= 16)\r\nreturn -EINVAL;\r\nvalue = (cr << info->var.red.offset) |\r\n(cg << info->var.green.offset) |\r\n(cb << info->var.blue.offset);\r\nif (info->var.transp.length > 0) {\r\nu32 mask = (1 << info->var.transp.length) - 1;\r\nmask <<= info->var.transp.offset;\r\nvalue |= mask;\r\n}\r\npal[regno] = value;\r\nreturn 0;\r\n}\r\nstatic int simplefb_parse_dt(struct platform_device *pdev,\r\nstruct simplefb_params *params)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nint ret;\r\nconst char *format;\r\nint i;\r\nret = of_property_read_u32(np, "width", &params->width);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Can't parse width property\n");\r\nreturn ret;\r\n}\r\nret = of_property_read_u32(np, "height", &params->height);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Can't parse height property\n");\r\nreturn ret;\r\n}\r\nret = of_property_read_u32(np, "stride", &params->stride);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Can't parse stride property\n");\r\nreturn ret;\r\n}\r\nret = of_property_read_string(np, "format", &format);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Can't parse format property\n");\r\nreturn ret;\r\n}\r\nparams->format = NULL;\r\nfor (i = 0; i < ARRAY_SIZE(simplefb_formats); i++) {\r\nif (strcmp(format, simplefb_formats[i].name))\r\ncontinue;\r\nparams->format = &simplefb_formats[i];\r\nbreak;\r\n}\r\nif (!params->format) {\r\ndev_err(&pdev->dev, "Invalid format value\n");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int simplefb_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct simplefb_params params;\r\nstruct fb_info *info;\r\nstruct resource *mem;\r\nif (fb_get_options("simplefb", NULL))\r\nreturn -ENODEV;\r\nret = simplefb_parse_dt(pdev, &params);\r\nif (ret)\r\nreturn ret;\r\nmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!mem) {\r\ndev_err(&pdev->dev, "No memory resource\n");\r\nreturn -EINVAL;\r\n}\r\ninfo = framebuffer_alloc(sizeof(u32) * 16, &pdev->dev);\r\nif (!info)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, info);\r\ninfo->fix = simplefb_fix;\r\ninfo->fix.smem_start = mem->start;\r\ninfo->fix.smem_len = resource_size(mem);\r\ninfo->fix.line_length = params.stride;\r\ninfo->var = simplefb_var;\r\ninfo->var.xres = params.width;\r\ninfo->var.yres = params.height;\r\ninfo->var.xres_virtual = params.width;\r\ninfo->var.yres_virtual = params.height;\r\ninfo->var.bits_per_pixel = params.format->bits_per_pixel;\r\ninfo->var.red = params.format->red;\r\ninfo->var.green = params.format->green;\r\ninfo->var.blue = params.format->blue;\r\ninfo->var.transp = params.format->transp;\r\ninfo->fbops = &simplefb_ops;\r\ninfo->flags = FBINFO_DEFAULT;\r\ninfo->screen_base = devm_ioremap(&pdev->dev, info->fix.smem_start,\r\ninfo->fix.smem_len);\r\nif (!info->screen_base) {\r\nframebuffer_release(info);\r\nreturn -ENODEV;\r\n}\r\ninfo->pseudo_palette = (void *)(info + 1);\r\nret = register_framebuffer(info);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Unable to register simplefb: %d\n", ret);\r\nframebuffer_release(info);\r\nreturn ret;\r\n}\r\ndev_info(&pdev->dev, "fb%d: simplefb registered!\n", info->node);\r\nreturn 0;\r\n}\r\nstatic int simplefb_remove(struct platform_device *pdev)\r\n{\r\nstruct fb_info *info = platform_get_drvdata(pdev);\r\nunregister_framebuffer(info);\r\nframebuffer_release(info);\r\nreturn 0;\r\n}

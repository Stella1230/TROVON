static int ack_ready(struct sdio_func *func)\r\n{\r\nunsigned long start = jiffies;\r\nu8 val;\r\nint ret;\r\nwhile ((jiffies - start) < HZ) {\r\nval = sdio_readb(func, 0x13, &ret);\r\nif (val & 0x01)\r\nreturn 1;\r\nschedule();\r\n}\r\nreturn 0;\r\n}\r\nstatic int download_image(struct sdio_func *func, const char *img_name)\r\n{\r\nint ret = 0, len, pno;\r\nu8 *buf = tx_buf;\r\nloff_t pos = 0;\r\nint img_len;\r\nconst struct firmware *firm;\r\nret = request_firmware(&firm, img_name, &func->dev);\r\nif (ret < 0) {\r\ndev_err(&func->dev,\r\n"requesting firmware %s failed with error %d\n",\r\nimg_name, ret);\r\nreturn ret;\r\n}\r\nbuf = kmalloc(DOWNLOAD_SIZE + TYPE_A_HEADER_SIZE, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn -ENOMEM;\r\nimg_len = firm->size;\r\nif (img_len <= 0) {\r\nret = -1;\r\ngoto out;\r\n}\r\npno = 0;\r\nwhile (img_len > 0) {\r\nif (img_len > DOWNLOAD_SIZE) {\r\nlen = DOWNLOAD_SIZE;\r\nbuf[3] = 0;\r\n} else {\r\nlen = img_len;\r\nbuf[3] = 2;\r\n}\r\nbuf[0] = len & 0xff;\r\nbuf[1] = (len >> 8) & 0xff;\r\nbuf[2] = (len >> 16) & 0xff;\r\nmemcpy(buf+TYPE_A_HEADER_SIZE, firm->data + pos, len);\r\nret = sdio_memcpy_toio(func, 0, buf, len + TYPE_A_HEADER_SIZE);\r\nif (ret < 0) {\r\ndev_err(&func->dev,\r\n"send image error: packet number = %d ret = %d\n",\r\npno, ret);\r\ngoto out;\r\n}\r\nif (buf[3] == 2)\r\nbreak;\r\nif (!ack_ready(func)) {\r\nret = -EIO;\r\ndev_err(&func->dev, "Ack is not ready.\n");\r\ngoto out;\r\n}\r\nret = sdio_memcpy_fromio(func, buf, 0, TYPE_A_LOOKAHEAD_SIZE);\r\nif (ret < 0) {\r\ndev_err(&func->dev,\r\n"receive ack error: packet number = %d ret = %d\n",\r\npno, ret);\r\ngoto out;\r\n}\r\nsdio_writeb(func, 0x01, 0x13, &ret);\r\nsdio_writeb(func, 0x00, 0x10, &ret);\r\nimg_len -= DOWNLOAD_SIZE;\r\npos += DOWNLOAD_SIZE;\r\npno++;\r\n}\r\nout:\r\nkfree(buf);\r\nreturn ret;\r\n}\r\nint sdio_boot(struct sdio_func *func)\r\n{\r\nint ret;\r\nconst char *krn_name = FW_DIR FW_KRN;\r\nconst char *rfs_name = FW_DIR FW_RFS;\r\ntx_buf = kmalloc(YMEM0_SIZE, GFP_KERNEL);\r\nif (tx_buf == NULL)\r\nreturn -ENOMEM;\r\nret = download_image(func, krn_name);\r\nif (ret)\r\ngoto restore_fs;\r\ndev_info(&func->dev, "GCT: Kernel download success.\n");\r\nret = download_image(func, rfs_name);\r\nif (ret)\r\ngoto restore_fs;\r\ndev_info(&func->dev, "GCT: Filesystem download success.\n");\r\nrestore_fs:\r\nkfree(tx_buf);\r\nreturn ret;\r\n}

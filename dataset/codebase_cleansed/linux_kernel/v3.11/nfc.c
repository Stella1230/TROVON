static void mei_nfc_free(struct mei_nfc_dev *ndev)\r\n{\r\nif (ndev->cl) {\r\nlist_del(&ndev->cl->device_link);\r\nmei_cl_unlink(ndev->cl);\r\nkfree(ndev->cl);\r\n}\r\nif (ndev->cl_info) {\r\nlist_del(&ndev->cl_info->device_link);\r\nmei_cl_unlink(ndev->cl_info);\r\nkfree(ndev->cl_info);\r\n}\r\nmemset(ndev, 0, sizeof(struct mei_nfc_dev));\r\n}\r\nstatic int mei_nfc_build_bus_name(struct mei_nfc_dev *ndev)\r\n{\r\nstruct mei_device *dev;\r\nif (!ndev->cl)\r\nreturn -ENODEV;\r\ndev = ndev->cl->dev;\r\nswitch (ndev->vendor_id) {\r\ncase MEI_NFC_VENDOR_INSIDE:\r\nswitch (ndev->radio_type) {\r\ncase MEI_NFC_VENDOR_INSIDE_UREAD:\r\nndev->bus_name = "microread";\r\nreturn 0;\r\ndefault:\r\ndev_err(&dev->pdev->dev, "Unknow radio type 0x%x\n",\r\nndev->radio_type);\r\nreturn -EINVAL;\r\n}\r\ncase MEI_NFC_VENDOR_NXP:\r\nswitch (ndev->radio_type) {\r\ncase MEI_NFC_VENDOR_NXP_PN544:\r\nndev->bus_name = "pn544";\r\nreturn 0;\r\ndefault:\r\ndev_err(&dev->pdev->dev, "Unknow radio type 0x%x\n",\r\nndev->radio_type);\r\nreturn -EINVAL;\r\n}\r\ndefault:\r\ndev_err(&dev->pdev->dev, "Unknow vendor ID 0x%x\n",\r\nndev->vendor_id);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mei_nfc_connect(struct mei_nfc_dev *ndev)\r\n{\r\nstruct mei_device *dev;\r\nstruct mei_cl *cl;\r\nstruct mei_nfc_cmd *cmd, *reply;\r\nstruct mei_nfc_connect *connect;\r\nstruct mei_nfc_connect_resp *connect_resp;\r\nsize_t connect_length, connect_resp_length;\r\nint bytes_recv, ret;\r\ncl = ndev->cl;\r\ndev = cl->dev;\r\nconnect_length = sizeof(struct mei_nfc_cmd) +\r\nsizeof(struct mei_nfc_connect);\r\nconnect_resp_length = sizeof(struct mei_nfc_cmd) +\r\nsizeof(struct mei_nfc_connect_resp);\r\ncmd = kzalloc(connect_length, GFP_KERNEL);\r\nif (!cmd)\r\nreturn -ENOMEM;\r\nconnect = (struct mei_nfc_connect *)cmd->data;\r\nreply = kzalloc(connect_resp_length, GFP_KERNEL);\r\nif (!reply) {\r\nkfree(cmd);\r\nreturn -ENOMEM;\r\n}\r\nconnect_resp = (struct mei_nfc_connect_resp *)reply->data;\r\ncmd->command = MEI_NFC_CMD_MAINTENANCE;\r\ncmd->data_size = 3;\r\ncmd->sub_command = MEI_NFC_SUBCMD_CONNECT;\r\nconnect->fw_ivn = ndev->fw_ivn;\r\nconnect->vendor_id = ndev->vendor_id;\r\nret = __mei_cl_send(cl, (u8 *)cmd, connect_length);\r\nif (ret < 0) {\r\ndev_err(&dev->pdev->dev, "Could not send connect cmd\n");\r\ngoto err;\r\n}\r\nbytes_recv = __mei_cl_recv(cl, (u8 *)reply, connect_resp_length);\r\nif (bytes_recv < 0) {\r\ndev_err(&dev->pdev->dev, "Could not read connect response\n");\r\nret = bytes_recv;\r\ngoto err;\r\n}\r\ndev_info(&dev->pdev->dev, "IVN 0x%x Vendor ID 0x%x\n",\r\nconnect_resp->fw_ivn, connect_resp->vendor_id);\r\ndev_info(&dev->pdev->dev, "ME FW %d.%d.%d.%d\n",\r\nconnect_resp->me_major, connect_resp->me_minor,\r\nconnect_resp->me_hotfix, connect_resp->me_build);\r\nret = 0;\r\nerr:\r\nkfree(reply);\r\nkfree(cmd);\r\nreturn ret;\r\n}\r\nstatic int mei_nfc_if_version(struct mei_nfc_dev *ndev)\r\n{\r\nstruct mei_device *dev;\r\nstruct mei_cl *cl;\r\nstruct mei_nfc_cmd cmd;\r\nstruct mei_nfc_reply *reply = NULL;\r\nstruct mei_nfc_if_version *version;\r\nsize_t if_version_length;\r\nint bytes_recv, ret;\r\ncl = ndev->cl_info;\r\ndev = cl->dev;\r\nmemset(&cmd, 0, sizeof(struct mei_nfc_cmd));\r\ncmd.command = MEI_NFC_CMD_MAINTENANCE;\r\ncmd.data_size = 1;\r\ncmd.sub_command = MEI_NFC_SUBCMD_IF_VERSION;\r\nret = __mei_cl_send(cl, (u8 *)&cmd, sizeof(struct mei_nfc_cmd));\r\nif (ret < 0) {\r\ndev_err(&dev->pdev->dev, "Could not send IF version cmd\n");\r\nreturn ret;\r\n}\r\nif_version_length = sizeof(struct mei_nfc_reply) +\r\nsizeof(struct mei_nfc_if_version);\r\nreply = kzalloc(if_version_length, GFP_KERNEL);\r\nif (!reply)\r\nreturn -ENOMEM;\r\nbytes_recv = __mei_cl_recv(cl, (u8 *)reply, if_version_length);\r\nif (bytes_recv < 0 || bytes_recv < sizeof(struct mei_nfc_reply)) {\r\ndev_err(&dev->pdev->dev, "Could not read IF version\n");\r\nret = -EIO;\r\ngoto err;\r\n}\r\nversion = (struct mei_nfc_if_version *)reply->data;\r\nndev->fw_ivn = version->fw_ivn;\r\nndev->vendor_id = version->vendor_id;\r\nndev->radio_type = version->radio_type;\r\nerr:\r\nkfree(reply);\r\nreturn ret;\r\n}\r\nstatic int mei_nfc_enable(struct mei_cl_device *cldev)\r\n{\r\nstruct mei_device *dev;\r\nstruct mei_nfc_dev *ndev = &nfc_dev;\r\nint ret;\r\ndev = ndev->cl->dev;\r\nret = mei_nfc_connect(ndev);\r\nif (ret < 0) {\r\ndev_err(&dev->pdev->dev, "Could not connect to NFC");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mei_nfc_disable(struct mei_cl_device *cldev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int mei_nfc_send(struct mei_cl_device *cldev, u8 *buf, size_t length)\r\n{\r\nstruct mei_device *dev;\r\nstruct mei_nfc_dev *ndev;\r\nstruct mei_nfc_hci_hdr *hdr;\r\nu8 *mei_buf;\r\nint err;\r\nndev = (struct mei_nfc_dev *) cldev->priv_data;\r\ndev = ndev->cl->dev;\r\nmei_buf = kzalloc(length + MEI_NFC_HEADER_SIZE, GFP_KERNEL);\r\nif (!mei_buf)\r\nreturn -ENOMEM;\r\nhdr = (struct mei_nfc_hci_hdr *) mei_buf;\r\nhdr->cmd = MEI_NFC_CMD_HCI_SEND;\r\nhdr->status = 0;\r\nhdr->req_id = ndev->req_id;\r\nhdr->reserved = 0;\r\nhdr->data_size = length;\r\nmemcpy(mei_buf + MEI_NFC_HEADER_SIZE, buf, length);\r\nerr = __mei_cl_send(ndev->cl, mei_buf, length + MEI_NFC_HEADER_SIZE);\r\nif (err < 0)\r\nreturn err;\r\nkfree(mei_buf);\r\nif (!wait_event_interruptible_timeout(ndev->send_wq,\r\nndev->recv_req_id == ndev->req_id, HZ)) {\r\ndev_err(&dev->pdev->dev, "NFC MEI command timeout\n");\r\nerr = -ETIMEDOUT;\r\n} else {\r\nndev->req_id++;\r\n}\r\nreturn err;\r\n}\r\nstatic int mei_nfc_recv(struct mei_cl_device *cldev, u8 *buf, size_t length)\r\n{\r\nstruct mei_nfc_dev *ndev;\r\nstruct mei_nfc_hci_hdr *hci_hdr;\r\nint received_length;\r\nndev = (struct mei_nfc_dev *)cldev->priv_data;\r\nreceived_length = __mei_cl_recv(ndev->cl, buf, length);\r\nif (received_length < 0)\r\nreturn received_length;\r\nhci_hdr = (struct mei_nfc_hci_hdr *) buf;\r\nif (hci_hdr->cmd == MEI_NFC_CMD_HCI_SEND) {\r\nndev->recv_req_id = hci_hdr->req_id;\r\nwake_up(&ndev->send_wq);\r\nreturn 0;\r\n}\r\nreturn received_length;\r\n}\r\nstatic void mei_nfc_init(struct work_struct *work)\r\n{\r\nstruct mei_device *dev;\r\nstruct mei_cl_device *cldev;\r\nstruct mei_nfc_dev *ndev;\r\nstruct mei_cl *cl_info;\r\nndev = container_of(work, struct mei_nfc_dev, init_work);\r\ncl_info = ndev->cl_info;\r\ndev = cl_info->dev;\r\nmutex_lock(&dev->device_lock);\r\nif (mei_cl_connect(cl_info, NULL) < 0) {\r\nmutex_unlock(&dev->device_lock);\r\ndev_err(&dev->pdev->dev,\r\n"Could not connect to the NFC INFO ME client");\r\ngoto err;\r\n}\r\nmutex_unlock(&dev->device_lock);\r\nif (mei_nfc_if_version(ndev) < 0) {\r\ndev_err(&dev->pdev->dev, "Could not get the NFC interfave version");\r\ngoto err;\r\n}\r\ndev_info(&dev->pdev->dev,\r\n"NFC MEI VERSION: IVN 0x%x Vendor ID 0x%x Type 0x%x\n",\r\nndev->fw_ivn, ndev->vendor_id, ndev->radio_type);\r\nmutex_lock(&dev->device_lock);\r\nif (mei_cl_disconnect(cl_info) < 0) {\r\nmutex_unlock(&dev->device_lock);\r\ndev_err(&dev->pdev->dev,\r\n"Could not disconnect the NFC INFO ME client");\r\ngoto err;\r\n}\r\nmutex_unlock(&dev->device_lock);\r\nif (mei_nfc_build_bus_name(ndev) < 0) {\r\ndev_err(&dev->pdev->dev,\r\n"Could not build the bus ID name\n");\r\nreturn;\r\n}\r\ncldev = mei_cl_add_device(dev, mei_nfc_guid, ndev->bus_name, &nfc_ops);\r\nif (!cldev) {\r\ndev_err(&dev->pdev->dev,\r\n"Could not add the NFC device to the MEI bus\n");\r\ngoto err;\r\n}\r\ncldev->priv_data = ndev;\r\nreturn;\r\nerr:\r\nmei_nfc_free(ndev);\r\nreturn;\r\n}\r\nint mei_nfc_host_init(struct mei_device *dev)\r\n{\r\nstruct mei_nfc_dev *ndev = &nfc_dev;\r\nstruct mei_cl *cl_info, *cl = NULL;\r\nint i, ret;\r\nif (ndev->cl_info)\r\nreturn 0;\r\ncl_info = mei_cl_allocate(dev);\r\ncl = mei_cl_allocate(dev);\r\nif (!cl || !cl_info) {\r\nret = -ENOMEM;\r\ngoto err;\r\n}\r\ni = mei_me_cl_by_uuid(dev, &mei_nfc_info_guid);\r\nif (i < 0) {\r\ndev_info(&dev->pdev->dev, "nfc: failed to find the client\n");\r\nret = -ENOENT;\r\ngoto err;\r\n}\r\ncl_info->me_client_id = dev->me_clients[i].client_id;\r\nret = mei_cl_link(cl_info, MEI_HOST_CLIENT_ID_ANY);\r\nif (ret)\r\ngoto err;\r\ncl_info->device_uuid = mei_nfc_info_guid;\r\nlist_add_tail(&cl_info->device_link, &dev->device_list);\r\ni = mei_me_cl_by_uuid(dev, &mei_nfc_guid);\r\nif (i < 0) {\r\ndev_info(&dev->pdev->dev, "nfc: failed to find the client\n");\r\nret = -ENOENT;\r\ngoto err;\r\n}\r\ncl->me_client_id = dev->me_clients[i].client_id;\r\nret = mei_cl_link(cl, MEI_HOST_CLIENT_ID_ANY);\r\nif (ret)\r\ngoto err;\r\ncl->device_uuid = mei_nfc_guid;\r\nlist_add_tail(&cl->device_link, &dev->device_list);\r\nndev->cl_info = cl_info;\r\nndev->cl = cl;\r\nndev->req_id = 1;\r\nINIT_WORK(&ndev->init_work, mei_nfc_init);\r\ninit_waitqueue_head(&ndev->send_wq);\r\nschedule_work(&ndev->init_work);\r\nreturn 0;\r\nerr:\r\nmei_nfc_free(ndev);\r\nreturn ret;\r\n}\r\nvoid mei_nfc_host_exit(void)\r\n{\r\nstruct mei_nfc_dev *ndev = &nfc_dev;\r\nif (ndev->cl && ndev->cl->device)\r\nmei_cl_remove_device(ndev->cl->device);\r\nmei_nfc_free(ndev);\r\n}

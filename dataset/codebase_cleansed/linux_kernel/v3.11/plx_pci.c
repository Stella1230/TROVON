static u8 plx_pci_read_reg(const struct sja1000_priv *priv, int port)\r\n{\r\nreturn ioread8(priv->reg_base + port);\r\n}\r\nstatic void plx_pci_write_reg(const struct sja1000_priv *priv, int port, u8 val)\r\n{\r\niowrite8(val, priv->reg_base + port);\r\n}\r\nstatic inline int plx_pci_check_sja1000(const struct sja1000_priv *priv)\r\n{\r\nint flag = 0;\r\nif ((priv->read_reg(priv, REG_CR) & REG_CR_BASICCAN_INITIAL_MASK) ==\r\nREG_CR_BASICCAN_INITIAL &&\r\n(priv->read_reg(priv, SJA1000_SR) == REG_SR_BASICCAN_INITIAL) &&\r\n(priv->read_reg(priv, SJA1000_IR) == REG_IR_BASICCAN_INITIAL))\r\nflag = 1;\r\npriv->write_reg(priv, SJA1000_CDR, CDR_PELICAN);\r\nif (priv->read_reg(priv, SJA1000_MOD) == REG_MOD_PELICAN_INITIAL &&\r\npriv->read_reg(priv, SJA1000_SR) == REG_SR_PELICAN_INITIAL &&\r\npriv->read_reg(priv, SJA1000_IR) == REG_IR_PELICAN_INITIAL)\r\nreturn flag;\r\nreturn 0;\r\n}\r\nstatic void plx_pci_reset_common(struct pci_dev *pdev)\r\n{\r\nstruct plx_pci_card *card = pci_get_drvdata(pdev);\r\nu32 cntrl;\r\ncntrl = ioread32(card->conf_addr + PLX_CNTRL);\r\ncntrl |= PLX_PCI_RESET;\r\niowrite32(cntrl, card->conf_addr + PLX_CNTRL);\r\nudelay(100);\r\ncntrl ^= PLX_PCI_RESET;\r\niowrite32(cntrl, card->conf_addr + PLX_CNTRL);\r\n}\r\nstatic void plx9056_pci_reset_common(struct pci_dev *pdev)\r\n{\r\nstruct plx_pci_card *card = pci_get_drvdata(pdev);\r\nu32 cntrl;\r\ncntrl = ioread32(card->conf_addr + PLX9056_CNTRL);\r\ncntrl |= PLX_PCI_RESET;\r\niowrite32(cntrl, card->conf_addr + PLX9056_CNTRL);\r\nudelay(100);\r\ncntrl ^= PLX_PCI_RESET;\r\niowrite32(cntrl, card->conf_addr + PLX9056_CNTRL);\r\ncntrl |= PLX9056_PCI_RCR;\r\niowrite32(cntrl, card->conf_addr + PLX9056_CNTRL);\r\nmdelay(10);\r\ncntrl ^= PLX9056_PCI_RCR;\r\niowrite32(cntrl, card->conf_addr + PLX9056_CNTRL);\r\n}\r\nstatic void plx_pci_reset_marathon(struct pci_dev *pdev)\r\n{\r\nvoid __iomem *reset_addr;\r\nint i;\r\nstatic const int reset_bar[2] = {3, 5};\r\nplx_pci_reset_common(pdev);\r\nfor (i = 0; i < 2; i++) {\r\nreset_addr = pci_iomap(pdev, reset_bar[i], 0);\r\nif (!reset_addr) {\r\ndev_err(&pdev->dev, "Failed to remap reset "\r\n"space %d (BAR%d)\n", i, reset_bar[i]);\r\n} else {\r\niowrite8(0x1, reset_addr);\r\nudelay(100);\r\npci_iounmap(pdev, reset_addr);\r\n}\r\n}\r\n}\r\nstatic void plx_pci_del_card(struct pci_dev *pdev)\r\n{\r\nstruct plx_pci_card *card = pci_get_drvdata(pdev);\r\nstruct net_device *dev;\r\nstruct sja1000_priv *priv;\r\nint i = 0;\r\nfor (i = 0; i < PLX_PCI_MAX_CHAN; i++) {\r\ndev = card->net_dev[i];\r\nif (!dev)\r\ncontinue;\r\ndev_info(&pdev->dev, "Removing %s\n", dev->name);\r\nunregister_sja1000dev(dev);\r\npriv = netdev_priv(dev);\r\nif (priv->reg_base)\r\npci_iounmap(pdev, priv->reg_base);\r\nfree_sja1000dev(dev);\r\n}\r\ncard->reset_func(pdev);\r\nif (pdev->device != PCI_DEVICE_ID_PLX_9056)\r\niowrite32(0x0, card->conf_addr + PLX_INTCSR);\r\nelse\r\niowrite32(0x0, card->conf_addr + PLX9056_INTCSR);\r\nif (card->conf_addr)\r\npci_iounmap(pdev, card->conf_addr);\r\nkfree(card);\r\npci_disable_device(pdev);\r\npci_set_drvdata(pdev, NULL);\r\n}\r\nstatic int plx_pci_add_card(struct pci_dev *pdev,\r\nconst struct pci_device_id *ent)\r\n{\r\nstruct sja1000_priv *priv;\r\nstruct net_device *dev;\r\nstruct plx_pci_card *card;\r\nstruct plx_pci_card_info *ci;\r\nint err, i;\r\nu32 val;\r\nvoid __iomem *addr;\r\nci = (struct plx_pci_card_info *)ent->driver_data;\r\nif (pci_enable_device(pdev) < 0) {\r\ndev_err(&pdev->dev, "Failed to enable PCI device\n");\r\nreturn -ENODEV;\r\n}\r\ndev_info(&pdev->dev, "Detected \"%s\" card at slot #%i\n",\r\nci->name, PCI_SLOT(pdev->devfn));\r\ncard = kzalloc(sizeof(*card), GFP_KERNEL);\r\nif (!card) {\r\npci_disable_device(pdev);\r\nreturn -ENOMEM;\r\n}\r\npci_set_drvdata(pdev, card);\r\ncard->channels = 0;\r\naddr = pci_iomap(pdev, ci->conf_map.bar, ci->conf_map.size);\r\nif (!addr) {\r\nerr = -ENOMEM;\r\ndev_err(&pdev->dev, "Failed to remap configuration space "\r\n"(BAR%d)\n", ci->conf_map.bar);\r\ngoto failure_cleanup;\r\n}\r\ncard->conf_addr = addr + ci->conf_map.offset;\r\nci->reset_func(pdev);\r\ncard->reset_func = ci->reset_func;\r\nfor (i = 0; i < ci->channel_count; i++) {\r\nstruct plx_pci_channel_map *cm = &ci->chan_map_tbl[i];\r\ndev = alloc_sja1000dev(0);\r\nif (!dev) {\r\nerr = -ENOMEM;\r\ngoto failure_cleanup;\r\n}\r\ncard->net_dev[i] = dev;\r\npriv = netdev_priv(dev);\r\npriv->priv = card;\r\npriv->irq_flags = IRQF_SHARED;\r\ndev->irq = pdev->irq;\r\naddr = pci_iomap(pdev, cm->bar, cm->size);\r\nif (!addr) {\r\nerr = -ENOMEM;\r\ndev_err(&pdev->dev, "Failed to remap BAR%d\n", cm->bar);\r\ngoto failure_cleanup;\r\n}\r\npriv->reg_base = addr + cm->offset;\r\npriv->read_reg = plx_pci_read_reg;\r\npriv->write_reg = plx_pci_write_reg;\r\nif (plx_pci_check_sja1000(priv)) {\r\npriv->can.clock.freq = ci->can_clock;\r\npriv->ocr = ci->ocr;\r\npriv->cdr = ci->cdr;\r\nSET_NETDEV_DEV(dev, &pdev->dev);\r\nerr = register_sja1000dev(dev);\r\nif (err) {\r\ndev_err(&pdev->dev, "Registering device failed "\r\n"(err=%d)\n", err);\r\ngoto failure_cleanup;\r\n}\r\ncard->channels++;\r\ndev_info(&pdev->dev, "Channel #%d at 0x%p, irq %d "\r\n"registered as %s\n", i + 1, priv->reg_base,\r\ndev->irq, dev->name);\r\n} else {\r\ndev_err(&pdev->dev, "Channel #%d not detected\n",\r\ni + 1);\r\nfree_sja1000dev(dev);\r\ncard->net_dev[i] = NULL;\r\n}\r\n}\r\nif (!card->channels) {\r\nerr = -ENODEV;\r\ngoto failure_cleanup;\r\n}\r\nif (pdev->device != PCI_DEVICE_ID_PLX_9056) {\r\nval = ioread32(card->conf_addr + PLX_INTCSR);\r\nif (pdev->subsystem_vendor == PCI_VENDOR_ID_ESDGMBH)\r\nval |= PLX_LINT1_EN | PLX_PCI_INT_EN;\r\nelse\r\nval |= PLX_LINT1_EN | PLX_LINT2_EN | PLX_PCI_INT_EN;\r\niowrite32(val, card->conf_addr + PLX_INTCSR);\r\n} else {\r\niowrite32(PLX9056_LINTI | PLX9056_PCI_INT_EN,\r\ncard->conf_addr + PLX9056_INTCSR);\r\n}\r\nreturn 0;\r\nfailure_cleanup:\r\ndev_err(&pdev->dev, "Error: %d. Cleaning Up.\n", err);\r\nplx_pci_del_card(pdev);\r\nreturn err;\r\n}

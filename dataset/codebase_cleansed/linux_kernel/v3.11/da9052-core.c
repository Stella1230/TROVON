static bool da9052_reg_readable(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase DA9052_PAGE0_CON_REG:\r\ncase DA9052_STATUS_A_REG:\r\ncase DA9052_STATUS_B_REG:\r\ncase DA9052_STATUS_C_REG:\r\ncase DA9052_STATUS_D_REG:\r\ncase DA9052_EVENT_A_REG:\r\ncase DA9052_EVENT_B_REG:\r\ncase DA9052_EVENT_C_REG:\r\ncase DA9052_EVENT_D_REG:\r\ncase DA9052_FAULTLOG_REG:\r\ncase DA9052_IRQ_MASK_A_REG:\r\ncase DA9052_IRQ_MASK_B_REG:\r\ncase DA9052_IRQ_MASK_C_REG:\r\ncase DA9052_IRQ_MASK_D_REG:\r\ncase DA9052_CONTROL_A_REG:\r\ncase DA9052_CONTROL_B_REG:\r\ncase DA9052_CONTROL_C_REG:\r\ncase DA9052_CONTROL_D_REG:\r\ncase DA9052_PDDIS_REG:\r\ncase DA9052_INTERFACE_REG:\r\ncase DA9052_RESET_REG:\r\ncase DA9052_GPIO_0_1_REG:\r\ncase DA9052_GPIO_2_3_REG:\r\ncase DA9052_GPIO_4_5_REG:\r\ncase DA9052_GPIO_6_7_REG:\r\ncase DA9052_GPIO_14_15_REG:\r\ncase DA9052_ID_0_1_REG:\r\ncase DA9052_ID_2_3_REG:\r\ncase DA9052_ID_4_5_REG:\r\ncase DA9052_ID_6_7_REG:\r\ncase DA9052_ID_8_9_REG:\r\ncase DA9052_ID_10_11_REG:\r\ncase DA9052_ID_12_13_REG:\r\ncase DA9052_ID_14_15_REG:\r\ncase DA9052_ID_16_17_REG:\r\ncase DA9052_ID_18_19_REG:\r\ncase DA9052_ID_20_21_REG:\r\ncase DA9052_SEQ_STATUS_REG:\r\ncase DA9052_SEQ_A_REG:\r\ncase DA9052_SEQ_B_REG:\r\ncase DA9052_SEQ_TIMER_REG:\r\ncase DA9052_BUCKA_REG:\r\ncase DA9052_BUCKB_REG:\r\ncase DA9052_BUCKCORE_REG:\r\ncase DA9052_BUCKPRO_REG:\r\ncase DA9052_BUCKMEM_REG:\r\ncase DA9052_BUCKPERI_REG:\r\ncase DA9052_LDO1_REG:\r\ncase DA9052_LDO2_REG:\r\ncase DA9052_LDO3_REG:\r\ncase DA9052_LDO4_REG:\r\ncase DA9052_LDO5_REG:\r\ncase DA9052_LDO6_REG:\r\ncase DA9052_LDO7_REG:\r\ncase DA9052_LDO8_REG:\r\ncase DA9052_LDO9_REG:\r\ncase DA9052_LDO10_REG:\r\ncase DA9052_SUPPLY_REG:\r\ncase DA9052_PULLDOWN_REG:\r\ncase DA9052_CHGBUCK_REG:\r\ncase DA9052_WAITCONT_REG:\r\ncase DA9052_ISET_REG:\r\ncase DA9052_BATCHG_REG:\r\ncase DA9052_CHG_CONT_REG:\r\ncase DA9052_INPUT_CONT_REG:\r\ncase DA9052_CHG_TIME_REG:\r\ncase DA9052_BBAT_CONT_REG:\r\ncase DA9052_BOOST_REG:\r\ncase DA9052_LED_CONT_REG:\r\ncase DA9052_LEDMIN123_REG:\r\ncase DA9052_LED1_CONF_REG:\r\ncase DA9052_LED2_CONF_REG:\r\ncase DA9052_LED3_CONF_REG:\r\ncase DA9052_LED1CONT_REG:\r\ncase DA9052_LED2CONT_REG:\r\ncase DA9052_LED3CONT_REG:\r\ncase DA9052_LED_CONT_4_REG:\r\ncase DA9052_LED_CONT_5_REG:\r\ncase DA9052_ADC_MAN_REG:\r\ncase DA9052_ADC_CONT_REG:\r\ncase DA9052_ADC_RES_L_REG:\r\ncase DA9052_ADC_RES_H_REG:\r\ncase DA9052_VDD_RES_REG:\r\ncase DA9052_VDD_MON_REG:\r\ncase DA9052_ICHG_AV_REG:\r\ncase DA9052_ICHG_THD_REG:\r\ncase DA9052_ICHG_END_REG:\r\ncase DA9052_TBAT_RES_REG:\r\ncase DA9052_TBAT_HIGHP_REG:\r\ncase DA9052_TBAT_HIGHN_REG:\r\ncase DA9052_TBAT_LOW_REG:\r\ncase DA9052_T_OFFSET_REG:\r\ncase DA9052_ADCIN4_RES_REG:\r\ncase DA9052_AUTO4_HIGH_REG:\r\ncase DA9052_AUTO4_LOW_REG:\r\ncase DA9052_ADCIN5_RES_REG:\r\ncase DA9052_AUTO5_HIGH_REG:\r\ncase DA9052_AUTO5_LOW_REG:\r\ncase DA9052_ADCIN6_RES_REG:\r\ncase DA9052_AUTO6_HIGH_REG:\r\ncase DA9052_AUTO6_LOW_REG:\r\ncase DA9052_TJUNC_RES_REG:\r\ncase DA9052_TSI_CONT_A_REG:\r\ncase DA9052_TSI_CONT_B_REG:\r\ncase DA9052_TSI_X_MSB_REG:\r\ncase DA9052_TSI_Y_MSB_REG:\r\ncase DA9052_TSI_LSB_REG:\r\ncase DA9052_TSI_Z_MSB_REG:\r\ncase DA9052_COUNT_S_REG:\r\ncase DA9052_COUNT_MI_REG:\r\ncase DA9052_COUNT_H_REG:\r\ncase DA9052_COUNT_D_REG:\r\ncase DA9052_COUNT_MO_REG:\r\ncase DA9052_COUNT_Y_REG:\r\ncase DA9052_ALARM_MI_REG:\r\ncase DA9052_ALARM_H_REG:\r\ncase DA9052_ALARM_D_REG:\r\ncase DA9052_ALARM_MO_REG:\r\ncase DA9052_ALARM_Y_REG:\r\ncase DA9052_SECOND_A_REG:\r\ncase DA9052_SECOND_B_REG:\r\ncase DA9052_SECOND_C_REG:\r\ncase DA9052_SECOND_D_REG:\r\ncase DA9052_PAGE1_CON_REG:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic bool da9052_reg_writeable(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase DA9052_PAGE0_CON_REG:\r\ncase DA9052_EVENT_A_REG:\r\ncase DA9052_EVENT_B_REG:\r\ncase DA9052_EVENT_C_REG:\r\ncase DA9052_EVENT_D_REG:\r\ncase DA9052_IRQ_MASK_A_REG:\r\ncase DA9052_IRQ_MASK_B_REG:\r\ncase DA9052_IRQ_MASK_C_REG:\r\ncase DA9052_IRQ_MASK_D_REG:\r\ncase DA9052_CONTROL_A_REG:\r\ncase DA9052_CONTROL_B_REG:\r\ncase DA9052_CONTROL_C_REG:\r\ncase DA9052_CONTROL_D_REG:\r\ncase DA9052_PDDIS_REG:\r\ncase DA9052_RESET_REG:\r\ncase DA9052_GPIO_0_1_REG:\r\ncase DA9052_GPIO_2_3_REG:\r\ncase DA9052_GPIO_4_5_REG:\r\ncase DA9052_GPIO_6_7_REG:\r\ncase DA9052_GPIO_14_15_REG:\r\ncase DA9052_ID_0_1_REG:\r\ncase DA9052_ID_2_3_REG:\r\ncase DA9052_ID_4_5_REG:\r\ncase DA9052_ID_6_7_REG:\r\ncase DA9052_ID_8_9_REG:\r\ncase DA9052_ID_10_11_REG:\r\ncase DA9052_ID_12_13_REG:\r\ncase DA9052_ID_14_15_REG:\r\ncase DA9052_ID_16_17_REG:\r\ncase DA9052_ID_18_19_REG:\r\ncase DA9052_ID_20_21_REG:\r\ncase DA9052_SEQ_STATUS_REG:\r\ncase DA9052_SEQ_A_REG:\r\ncase DA9052_SEQ_B_REG:\r\ncase DA9052_SEQ_TIMER_REG:\r\ncase DA9052_BUCKA_REG:\r\ncase DA9052_BUCKB_REG:\r\ncase DA9052_BUCKCORE_REG:\r\ncase DA9052_BUCKPRO_REG:\r\ncase DA9052_BUCKMEM_REG:\r\ncase DA9052_BUCKPERI_REG:\r\ncase DA9052_LDO1_REG:\r\ncase DA9052_LDO2_REG:\r\ncase DA9052_LDO3_REG:\r\ncase DA9052_LDO4_REG:\r\ncase DA9052_LDO5_REG:\r\ncase DA9052_LDO6_REG:\r\ncase DA9052_LDO7_REG:\r\ncase DA9052_LDO8_REG:\r\ncase DA9052_LDO9_REG:\r\ncase DA9052_LDO10_REG:\r\ncase DA9052_SUPPLY_REG:\r\ncase DA9052_PULLDOWN_REG:\r\ncase DA9052_CHGBUCK_REG:\r\ncase DA9052_WAITCONT_REG:\r\ncase DA9052_ISET_REG:\r\ncase DA9052_BATCHG_REG:\r\ncase DA9052_CHG_CONT_REG:\r\ncase DA9052_INPUT_CONT_REG:\r\ncase DA9052_BBAT_CONT_REG:\r\ncase DA9052_BOOST_REG:\r\ncase DA9052_LED_CONT_REG:\r\ncase DA9052_LEDMIN123_REG:\r\ncase DA9052_LED1_CONF_REG:\r\ncase DA9052_LED2_CONF_REG:\r\ncase DA9052_LED3_CONF_REG:\r\ncase DA9052_LED1CONT_REG:\r\ncase DA9052_LED2CONT_REG:\r\ncase DA9052_LED3CONT_REG:\r\ncase DA9052_LED_CONT_4_REG:\r\ncase DA9052_LED_CONT_5_REG:\r\ncase DA9052_ADC_MAN_REG:\r\ncase DA9052_ADC_CONT_REG:\r\ncase DA9052_ADC_RES_L_REG:\r\ncase DA9052_ADC_RES_H_REG:\r\ncase DA9052_VDD_RES_REG:\r\ncase DA9052_VDD_MON_REG:\r\ncase DA9052_ICHG_THD_REG:\r\ncase DA9052_ICHG_END_REG:\r\ncase DA9052_TBAT_HIGHP_REG:\r\ncase DA9052_TBAT_HIGHN_REG:\r\ncase DA9052_TBAT_LOW_REG:\r\ncase DA9052_T_OFFSET_REG:\r\ncase DA9052_AUTO4_HIGH_REG:\r\ncase DA9052_AUTO4_LOW_REG:\r\ncase DA9052_AUTO5_HIGH_REG:\r\ncase DA9052_AUTO5_LOW_REG:\r\ncase DA9052_AUTO6_HIGH_REG:\r\ncase DA9052_AUTO6_LOW_REG:\r\ncase DA9052_TSI_CONT_A_REG:\r\ncase DA9052_TSI_CONT_B_REG:\r\ncase DA9052_COUNT_S_REG:\r\ncase DA9052_COUNT_MI_REG:\r\ncase DA9052_COUNT_H_REG:\r\ncase DA9052_COUNT_D_REG:\r\ncase DA9052_COUNT_MO_REG:\r\ncase DA9052_COUNT_Y_REG:\r\ncase DA9052_ALARM_MI_REG:\r\ncase DA9052_ALARM_H_REG:\r\ncase DA9052_ALARM_D_REG:\r\ncase DA9052_ALARM_MO_REG:\r\ncase DA9052_ALARM_Y_REG:\r\ncase DA9052_PAGE1_CON_REG:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic bool da9052_reg_volatile(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase DA9052_STATUS_A_REG:\r\ncase DA9052_STATUS_B_REG:\r\ncase DA9052_STATUS_C_REG:\r\ncase DA9052_STATUS_D_REG:\r\ncase DA9052_EVENT_A_REG:\r\ncase DA9052_EVENT_B_REG:\r\ncase DA9052_EVENT_C_REG:\r\ncase DA9052_EVENT_D_REG:\r\ncase DA9052_FAULTLOG_REG:\r\ncase DA9052_CHG_TIME_REG:\r\ncase DA9052_ADC_RES_L_REG:\r\ncase DA9052_ADC_RES_H_REG:\r\ncase DA9052_VDD_RES_REG:\r\ncase DA9052_ICHG_AV_REG:\r\ncase DA9052_TBAT_RES_REG:\r\ncase DA9052_ADCIN4_RES_REG:\r\ncase DA9052_ADCIN5_RES_REG:\r\ncase DA9052_ADCIN6_RES_REG:\r\ncase DA9052_TJUNC_RES_REG:\r\ncase DA9052_TSI_X_MSB_REG:\r\ncase DA9052_TSI_Y_MSB_REG:\r\ncase DA9052_TSI_LSB_REG:\r\ncase DA9052_TSI_Z_MSB_REG:\r\ncase DA9052_COUNT_S_REG:\r\ncase DA9052_COUNT_MI_REG:\r\ncase DA9052_COUNT_H_REG:\r\ncase DA9052_COUNT_D_REG:\r\ncase DA9052_COUNT_MO_REG:\r\ncase DA9052_COUNT_Y_REG:\r\ncase DA9052_ALARM_MI_REG:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nint da9052_adc_manual_read(struct da9052 *da9052, unsigned char channel)\r\n{\r\nint ret;\r\nunsigned short calc_data;\r\nunsigned short data;\r\nunsigned char mux_sel;\r\nif (channel > DA9052_ADC_VBBAT)\r\nreturn -EINVAL;\r\nmutex_lock(&da9052->auxadc_lock);\r\nmux_sel = chan_mux[channel] | DA9052_ADC_MAN_MAN_CONV;\r\nret = da9052_reg_write(da9052, DA9052_ADC_MAN_REG, mux_sel);\r\nif (ret < 0)\r\ngoto err;\r\nif (!wait_for_completion_timeout(&da9052->done,\r\nmsecs_to_jiffies(500))) {\r\ndev_err(da9052->dev,\r\n"timeout waiting for ADC conversion interrupt\n");\r\nret = -ETIMEDOUT;\r\ngoto err;\r\n}\r\nret = da9052_reg_read(da9052, DA9052_ADC_RES_H_REG);\r\nif (ret < 0)\r\ngoto err;\r\ncalc_data = (unsigned short)ret;\r\ndata = calc_data << 2;\r\nret = da9052_reg_read(da9052, DA9052_ADC_RES_L_REG);\r\nif (ret < 0)\r\ngoto err;\r\ncalc_data = (unsigned short)(ret & DA9052_ADC_RES_LSB);\r\ndata |= calc_data;\r\nret = data;\r\nerr:\r\nmutex_unlock(&da9052->auxadc_lock);\r\nreturn ret;\r\n}\r\nint da9052_adc_read_temp(struct da9052 *da9052)\r\n{\r\nint tbat;\r\ntbat = da9052_reg_read(da9052, DA9052_TBAT_RES_REG);\r\nif (tbat <= 0)\r\nreturn tbat;\r\nreturn tbat_lookup[tbat - 1];\r\n}\r\nint da9052_device_init(struct da9052 *da9052, u8 chip_id)\r\n{\r\nstruct da9052_pdata *pdata = da9052->dev->platform_data;\r\nint ret;\r\nmutex_init(&da9052->auxadc_lock);\r\ninit_completion(&da9052->done);\r\nif (pdata && pdata->init != NULL)\r\npdata->init(da9052);\r\nda9052->chip_id = chip_id;\r\nret = da9052_irq_init(da9052);\r\nif (ret != 0) {\r\ndev_err(da9052->dev, "da9052_irq_init failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = mfd_add_devices(da9052->dev, -1, da9052_subdev_info,\r\nARRAY_SIZE(da9052_subdev_info), NULL, 0, NULL);\r\nif (ret) {\r\ndev_err(da9052->dev, "mfd_add_devices failed: %d\n", ret);\r\ngoto err;\r\n}\r\nreturn 0;\r\nerr:\r\nda9052_irq_exit(da9052);\r\nreturn ret;\r\n}\r\nvoid da9052_device_exit(struct da9052 *da9052)\r\n{\r\nmfd_remove_devices(da9052->dev);\r\nda9052_irq_exit(da9052);\r\n}

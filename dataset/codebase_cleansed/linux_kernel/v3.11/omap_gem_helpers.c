struct page **_drm_gem_get_pages(struct drm_gem_object *obj, gfp_t gfpmask)\r\n{\r\nstruct inode *inode;\r\nstruct address_space *mapping;\r\nstruct page *p, **pages;\r\nint i, npages;\r\ninode = file_inode(obj->filp);\r\nmapping = inode->i_mapping;\r\nnpages = obj->size >> PAGE_SHIFT;\r\npages = drm_malloc_ab(npages, sizeof(struct page *));\r\nif (pages == NULL)\r\nreturn ERR_PTR(-ENOMEM);\r\ngfpmask |= mapping_gfp_mask(mapping);\r\nfor (i = 0; i < npages; i++) {\r\np = shmem_read_mapping_page_gfp(mapping, i, gfpmask);\r\nif (IS_ERR(p))\r\ngoto fail;\r\npages[i] = p;\r\nBUG_ON((gfpmask & __GFP_DMA32) &&\r\n(page_to_pfn(p) >= 0x00100000UL));\r\n}\r\nreturn pages;\r\nfail:\r\nwhile (i--)\r\npage_cache_release(pages[i]);\r\ndrm_free_large(pages);\r\nreturn ERR_CAST(p);\r\n}\r\nvoid _drm_gem_put_pages(struct drm_gem_object *obj, struct page **pages,\r\nbool dirty, bool accessed)\r\n{\r\nint i, npages;\r\nnpages = obj->size >> PAGE_SHIFT;\r\nfor (i = 0; i < npages; i++) {\r\nif (dirty)\r\nset_page_dirty(pages[i]);\r\nif (accessed)\r\nmark_page_accessed(pages[i]);\r\npage_cache_release(pages[i]);\r\n}\r\ndrm_free_large(pages);\r\n}\r\nint\r\n_drm_gem_create_mmap_offset_size(struct drm_gem_object *obj, size_t size)\r\n{\r\nstruct drm_device *dev = obj->dev;\r\nstruct drm_gem_mm *mm = dev->mm_private;\r\nstruct drm_map_list *list;\r\nstruct drm_local_map *map;\r\nint ret = 0;\r\nlist = &obj->map_list;\r\nlist->map = kzalloc(sizeof(struct drm_map_list), GFP_KERNEL);\r\nif (!list->map)\r\nreturn -ENOMEM;\r\nmap = list->map;\r\nmap->type = _DRM_GEM;\r\nmap->size = size;\r\nmap->handle = obj;\r\nlist->file_offset_node = drm_mm_search_free(&mm->offset_manager,\r\nsize / PAGE_SIZE, 0, 0);\r\nif (!list->file_offset_node) {\r\nDRM_ERROR("failed to allocate offset for bo %d\n", obj->name);\r\nret = -ENOSPC;\r\ngoto out_free_list;\r\n}\r\nlist->file_offset_node = drm_mm_get_block(list->file_offset_node,\r\nsize / PAGE_SIZE, 0);\r\nif (!list->file_offset_node) {\r\nret = -ENOMEM;\r\ngoto out_free_list;\r\n}\r\nlist->hash.key = list->file_offset_node->start;\r\nret = drm_ht_insert_item(&mm->offset_hash, &list->hash);\r\nif (ret) {\r\nDRM_ERROR("failed to add to map hash\n");\r\ngoto out_free_mm;\r\n}\r\nreturn 0;\r\nout_free_mm:\r\ndrm_mm_put_block(list->file_offset_node);\r\nout_free_list:\r\nkfree(list->map);\r\nlist->map = NULL;\r\nreturn ret;\r\n}

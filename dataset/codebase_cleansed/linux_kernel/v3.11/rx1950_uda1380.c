static int rx1950_startup(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nruntime->hw.rate_min = hw_rates.list[0];\r\nruntime->hw.rate_max = hw_rates.list[hw_rates.count - 1];\r\nruntime->hw.rates = SNDRV_PCM_RATE_KNOT;\r\nreturn snd_pcm_hw_constraint_list(runtime, 0,\r\nSNDRV_PCM_HW_PARAM_RATE,\r\n&hw_rates);\r\n}\r\nstatic int rx1950_spk_power(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nif (SND_SOC_DAPM_EVENT_ON(event))\r\ngpio_set_value(S3C2410_GPA(1), 1);\r\nelse\r\ngpio_set_value(S3C2410_GPA(1), 0);\r\nreturn 0;\r\n}\r\nstatic int rx1950_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nint div;\r\nint ret;\r\nunsigned int rate = params_rate(params);\r\nint clk_source, fs_mode;\r\nswitch (rate) {\r\ncase 16000:\r\ncase 48000:\r\nclk_source = S3C24XX_CLKSRC_PCLK;\r\nfs_mode = S3C2410_IISMOD_256FS;\r\ndiv = s3c24xx_i2s_get_clockrate() / (256 * rate);\r\nif (s3c24xx_i2s_get_clockrate() % (256 * rate) > (128 * rate))\r\ndiv++;\r\nbreak;\r\ncase 44100:\r\ncase 88200:\r\nclk_source = S3C24XX_CLKSRC_MPLL;\r\nfs_mode = S3C2410_IISMOD_384FS;\r\ndiv = 1;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "%s: rate %d is not supported\n",\r\n__func__, rate);\r\nreturn -EINVAL;\r\n}\r\nret = snd_soc_dai_set_fmt(codec_dai, SND_SOC_DAIFMT_I2S |\r\nSND_SOC_DAIFMT_NB_NF | SND_SOC_DAIFMT_CBS_CFS);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_fmt(cpu_dai, SND_SOC_DAIFMT_I2S |\r\nSND_SOC_DAIFMT_NB_NF | SND_SOC_DAIFMT_CBS_CFS);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_sysclk(cpu_dai, clk_source, rate,\r\nSND_SOC_CLOCK_OUT);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_clkdiv(cpu_dai, S3C24XX_DIV_MCLK,\r\nfs_mode);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_clkdiv(cpu_dai, S3C24XX_DIV_BCLK,\r\nS3C2410_IISMOD_32FS);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_clkdiv(cpu_dai, S3C24XX_DIV_PRESCALER,\r\nS3C24XX_PRESCALE(div, div));\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int rx1950_uda1380_init(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct snd_soc_codec *codec = rtd->codec;\r\nstruct snd_soc_dapm_context *dapm = &codec->dapm;\r\nint err;\r\nsnd_soc_dapm_enable_pin(dapm, "Headphone Jack");\r\nsnd_soc_dapm_enable_pin(dapm, "Speaker");\r\nsnd_soc_dapm_enable_pin(dapm, "Mic Jack");\r\nsnd_soc_jack_new(codec, "Headphone Jack", SND_JACK_HEADPHONE,\r\n&hp_jack);\r\nsnd_soc_jack_add_pins(&hp_jack, ARRAY_SIZE(hp_jack_pins),\r\nhp_jack_pins);\r\nsnd_soc_jack_add_gpios(&hp_jack, ARRAY_SIZE(hp_jack_gpios),\r\nhp_jack_gpios);\r\nreturn 0;\r\n}\r\nstatic int __init rx1950_init(void)\r\n{\r\nint ret;\r\nif (!machine_is_rx1950())\r\nreturn -ENODEV;\r\nret = gpio_request(S3C2410_GPA(1), "speaker-power");\r\nif (ret)\r\ngoto err_gpio;\r\nret = gpio_direction_output(S3C2410_GPA(1), 0);\r\nif (ret)\r\ngoto err_gpio_conf;\r\ns3c24xx_snd_device = platform_device_alloc("soc-audio", -1);\r\nif (!s3c24xx_snd_device) {\r\nret = -ENOMEM;\r\ngoto err_plat_alloc;\r\n}\r\nplatform_set_drvdata(s3c24xx_snd_device, &rx1950_asoc);\r\nret = platform_device_add(s3c24xx_snd_device);\r\nif (ret) {\r\nplatform_device_put(s3c24xx_snd_device);\r\ngoto err_plat_add;\r\n}\r\nreturn 0;\r\nerr_plat_add:\r\nerr_plat_alloc:\r\nerr_gpio_conf:\r\ngpio_free(S3C2410_GPA(1));\r\nerr_gpio:\r\nreturn ret;\r\n}\r\nstatic void __exit rx1950_exit(void)\r\n{\r\nplatform_device_unregister(s3c24xx_snd_device);\r\nsnd_soc_jack_free_gpios(&hp_jack, ARRAY_SIZE(hp_jack_gpios),\r\nhp_jack_gpios);\r\ngpio_free(S3C2410_GPA(1));\r\n}

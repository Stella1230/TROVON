static inline uint16_t roccat_common2_feature_report(uint8_t report_id)\r\n{\r\nreturn 0x300 | report_id;\r\n}\r\nint roccat_common2_receive(struct usb_device *usb_dev, uint report_id,\r\nvoid *data, uint size)\r\n{\r\nchar *buf;\r\nint len;\r\nbuf = kmalloc(size, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn -ENOMEM;\r\nlen = usb_control_msg(usb_dev, usb_rcvctrlpipe(usb_dev, 0),\r\nHID_REQ_GET_REPORT,\r\nUSB_TYPE_CLASS | USB_RECIP_INTERFACE | USB_DIR_IN,\r\nroccat_common2_feature_report(report_id),\r\n0, buf, size, USB_CTRL_SET_TIMEOUT);\r\nmemcpy(data, buf, size);\r\nkfree(buf);\r\nreturn ((len < 0) ? len : ((len != size) ? -EIO : 0));\r\n}\r\nint roccat_common2_send(struct usb_device *usb_dev, uint report_id,\r\nvoid const *data, uint size)\r\n{\r\nchar *buf;\r\nint len;\r\nbuf = kmemdup(data, size, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn -ENOMEM;\r\nlen = usb_control_msg(usb_dev, usb_sndctrlpipe(usb_dev, 0),\r\nHID_REQ_SET_REPORT,\r\nUSB_TYPE_CLASS | USB_RECIP_INTERFACE | USB_DIR_OUT,\r\nroccat_common2_feature_report(report_id),\r\n0, buf, size, USB_CTRL_SET_TIMEOUT);\r\nkfree(buf);\r\nreturn ((len < 0) ? len : ((len != size) ? -EIO : 0));\r\n}\r\nstatic int roccat_common2_receive_control_status(struct usb_device *usb_dev)\r\n{\r\nint retval;\r\nstruct roccat_common2_control control;\r\ndo {\r\nmsleep(50);\r\nretval = roccat_common2_receive(usb_dev,\r\nROCCAT_COMMON_COMMAND_CONTROL,\r\n&control, sizeof(struct roccat_common2_control));\r\nif (retval)\r\nreturn retval;\r\nswitch (control.value) {\r\ncase ROCCAT_COMMON_CONTROL_STATUS_OK:\r\nreturn 0;\r\ncase ROCCAT_COMMON_CONTROL_STATUS_WAIT:\r\nmsleep(500);\r\ncontinue;\r\ncase ROCCAT_COMMON_CONTROL_STATUS_INVALID:\r\ncase ROCCAT_COMMON_CONTROL_STATUS_OVERLOAD:\r\nreturn -EINVAL;\r\ndefault:\r\ndev_err(&usb_dev->dev,\r\n"roccat_common2_receive_control_status: "\r\n"unknown response value 0x%x\n",\r\ncontrol.value);\r\nreturn -EINVAL;\r\n}\r\n} while (1);\r\n}\r\nint roccat_common2_send_with_status(struct usb_device *usb_dev,\r\nuint command, void const *buf, uint size)\r\n{\r\nint retval;\r\nretval = roccat_common2_send(usb_dev, command, buf, size);\r\nif (retval)\r\nreturn retval;\r\nmsleep(100);\r\nreturn roccat_common2_receive_control_status(usb_dev);\r\n}

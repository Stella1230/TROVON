static unsigned long get_unshared_area(unsigned long addr, unsigned long len)\r\n{\r\nstruct vm_unmapped_area_info info;\r\ninfo.flags = 0;\r\ninfo.length = len;\r\ninfo.low_limit = PAGE_ALIGN(addr);\r\ninfo.high_limit = TASK_SIZE;\r\ninfo.align_mask = 0;\r\ninfo.align_offset = 0;\r\nreturn vm_unmapped_area(&info);\r\n}\r\nstatic int get_offset(struct address_space *mapping)\r\n{\r\nreturn (unsigned long) mapping >> 8;\r\n}\r\nstatic unsigned long get_shared_area(struct address_space *mapping,\r\nunsigned long addr, unsigned long len, unsigned long pgoff)\r\n{\r\nstruct vm_unmapped_area_info info;\r\ninfo.flags = 0;\r\ninfo.length = len;\r\ninfo.low_limit = PAGE_ALIGN(addr);\r\ninfo.high_limit = TASK_SIZE;\r\ninfo.align_mask = PAGE_MASK & (SHMLBA - 1);\r\ninfo.align_offset = (get_offset(mapping) + pgoff) << PAGE_SHIFT;\r\nreturn vm_unmapped_area(&info);\r\n}\r\nunsigned long arch_get_unmapped_area(struct file *filp, unsigned long addr,\r\nunsigned long len, unsigned long pgoff, unsigned long flags)\r\n{\r\nif (len > TASK_SIZE)\r\nreturn -ENOMEM;\r\nif (flags & MAP_FIXED) {\r\nif ((flags & MAP_SHARED) &&\r\n(addr - (pgoff << PAGE_SHIFT)) & (SHMLBA - 1))\r\nreturn -EINVAL;\r\nreturn addr;\r\n}\r\nif (!addr)\r\naddr = TASK_UNMAPPED_BASE;\r\nif (filp) {\r\naddr = get_shared_area(filp->f_mapping, addr, len, pgoff);\r\n} else if(flags & MAP_SHARED) {\r\naddr = get_shared_area(NULL, addr, len, pgoff);\r\n} else {\r\naddr = get_unshared_area(addr, len);\r\n}\r\nreturn addr;\r\n}\r\nasmlinkage unsigned long sys_mmap2(unsigned long addr, unsigned long len,\r\nunsigned long prot, unsigned long flags, unsigned long fd,\r\nunsigned long pgoff)\r\n{\r\nreturn sys_mmap_pgoff(addr, len, prot, flags, fd,\r\npgoff >> (PAGE_SHIFT - 12));\r\n}\r\nasmlinkage unsigned long sys_mmap(unsigned long addr, unsigned long len,\r\nunsigned long prot, unsigned long flags, unsigned long fd,\r\nunsigned long offset)\r\n{\r\nif (!(offset & ~PAGE_MASK)) {\r\nreturn sys_mmap_pgoff(addr, len, prot, flags, fd,\r\noffset >> PAGE_SHIFT);\r\n} else {\r\nreturn -EINVAL;\r\n}\r\n}\r\nasmlinkage long parisc_truncate64(const char __user * path,\r\nunsigned int high, unsigned int low)\r\n{\r\nreturn sys_truncate(path, (long)high << 32 | low);\r\n}\r\nasmlinkage long parisc_ftruncate64(unsigned int fd,\r\nunsigned int high, unsigned int low)\r\n{\r\nreturn sys_ftruncate(fd, (long)high << 32 | low);\r\n}\r\nasmlinkage long sys_truncate64(const char __user * path, unsigned long length)\r\n{\r\nreturn sys_truncate(path, length);\r\n}\r\nasmlinkage long sys_ftruncate64(unsigned int fd, unsigned long length)\r\n{\r\nreturn sys_ftruncate(fd, length);\r\n}\r\nasmlinkage long sys_fcntl64(unsigned int fd, unsigned int cmd, unsigned long arg)\r\n{\r\nreturn sys_fcntl(fd, cmd, arg);\r\n}\r\nasmlinkage long parisc_truncate64(const char __user * path,\r\nunsigned int high, unsigned int low)\r\n{\r\nreturn sys_truncate64(path, (loff_t)high << 32 | low);\r\n}\r\nasmlinkage long parisc_ftruncate64(unsigned int fd,\r\nunsigned int high, unsigned int low)\r\n{\r\nreturn sys_ftruncate64(fd, (loff_t)high << 32 | low);\r\n}\r\nasmlinkage ssize_t parisc_pread64(unsigned int fd, char __user *buf, size_t count,\r\nunsigned int high, unsigned int low)\r\n{\r\nreturn sys_pread64(fd, buf, count, (loff_t)high << 32 | low);\r\n}\r\nasmlinkage ssize_t parisc_pwrite64(unsigned int fd, const char __user *buf,\r\nsize_t count, unsigned int high, unsigned int low)\r\n{\r\nreturn sys_pwrite64(fd, buf, count, (loff_t)high << 32 | low);\r\n}\r\nasmlinkage ssize_t parisc_readahead(int fd, unsigned int high, unsigned int low,\r\nsize_t count)\r\n{\r\nreturn sys_readahead(fd, (loff_t)high << 32 | low, count);\r\n}\r\nasmlinkage long parisc_fadvise64_64(int fd,\r\nunsigned int high_off, unsigned int low_off,\r\nunsigned int high_len, unsigned int low_len, int advice)\r\n{\r\nreturn sys_fadvise64_64(fd, (loff_t)high_off << 32 | low_off,\r\n(loff_t)high_len << 32 | low_len, advice);\r\n}\r\nasmlinkage long parisc_sync_file_range(int fd,\r\nu32 hi_off, u32 lo_off, u32 hi_nbytes, u32 lo_nbytes,\r\nunsigned int flags)\r\n{\r\nreturn sys_sync_file_range(fd, (loff_t)hi_off << 32 | lo_off,\r\n(loff_t)hi_nbytes << 32 | lo_nbytes, flags);\r\n}\r\nasmlinkage long parisc_fallocate(int fd, int mode, u32 offhi, u32 offlo,\r\nu32 lenhi, u32 lenlo)\r\n{\r\nreturn sys_fallocate(fd, mode, ((u64)offhi << 32) | offlo,\r\n((u64)lenhi << 32) | lenlo);\r\n}\r\nasmlinkage unsigned long sys_alloc_hugepages(int key, unsigned long addr, unsigned long len, int prot, int flag)\r\n{\r\nreturn -ENOMEM;\r\n}\r\nasmlinkage int sys_free_hugepages(unsigned long addr)\r\n{\r\nreturn -EINVAL;\r\n}\r\nlong parisc_personality(unsigned long personality)\r\n{\r\nlong err;\r\nif (personality(current->personality) == PER_LINUX32\r\n&& personality(personality) == PER_LINUX)\r\npersonality = (personality & ~PER_MASK) | PER_LINUX32;\r\nerr = sys_personality(personality);\r\nif (personality(err) == PER_LINUX32)\r\nerr = (err & ~PER_MASK) | PER_LINUX;\r\nreturn err;\r\n}

static void netlink_rcv_cb(struct sk_buff *skb)\r\n{\r\nstruct nlmsghdr *nlh;\r\nstruct net_device *dev;\r\nu32 mlen;\r\nvoid *msg;\r\nint ifindex;\r\nif (skb->len >= NLMSG_HDRLEN) {\r\nnlh = (struct nlmsghdr *)skb->data;\r\nif (skb->len < nlh->nlmsg_len ||\r\nnlh->nlmsg_len > ND_MAX_MSG_LEN) {\r\nnetdev_err(skb->dev, "Invalid length (%d,%d)\n",\r\nskb->len, nlh->nlmsg_len);\r\nreturn;\r\n}\r\nmemcpy(&ifindex, ND_NLMSG_IFIDX(nlh), ND_IFINDEX_LEN);\r\nmsg = ND_NLMSG_DATA(nlh);\r\nmlen = ND_NLMSG_R_LEN(nlh);\r\nif (rcv_cb) {\r\ndev = dev_get_by_index(&init_net, ifindex);\r\nif (dev) {\r\nrcv_cb(dev, nlh->nlmsg_type, msg, mlen);\r\ndev_put(dev);\r\n} else\r\nnetdev_err(skb->dev,\r\n"dev_get_by_index(%d) is not found.\n",\r\nifindex);\r\n} else\r\nnetdev_err(skb->dev, "Unregistered Callback\n");\r\n}\r\n}\r\nstatic void netlink_rcv(struct sk_buff *skb)\r\n{\r\nmutex_lock(&netlink_mutex);\r\nnetlink_rcv_cb(skb);\r\nmutex_unlock(&netlink_mutex);\r\n}\r\nstruct sock *netlink_init(int unit, void (*cb)(struct net_device *dev, u16 type,\r\nvoid *msg, int len))\r\n{\r\nstruct sock *sock;\r\nstruct netlink_kernel_cfg cfg = {\r\n.input = netlink_rcv,\r\n};\r\n#if !defined(DEFINE_MUTEX)\r\ninit_MUTEX(&netlink_mutex);\r\n#endif\r\nsock = netlink_kernel_create(&init_net, unit, &cfg);\r\nif (sock)\r\nrcv_cb = cb;\r\nreturn sock;\r\n}\r\nvoid netlink_exit(struct sock *sock)\r\n{\r\nnetlink_kernel_release(sock);\r\n}\r\nint netlink_send(struct sock *sock, int group, u16 type, void *msg, int len)\r\n{\r\nstatic u32 seq;\r\nstruct sk_buff *skb = NULL;\r\nstruct nlmsghdr *nlh;\r\nint ret = 0;\r\nif (group > ND_MAX_GROUP) {\r\npr_err("Group %d is invalied.\n", group);\r\npr_err("Valid group is 0 ~ %d.\n", ND_MAX_GROUP);\r\nreturn -EINVAL;\r\n}\r\nskb = nlmsg_new(len, GFP_ATOMIC);\r\nif (!skb) {\r\npr_err("netlink_broadcast ret=%d\n", ret);\r\nreturn -ENOMEM;\r\n}\r\nseq++;\r\nnlh = nlmsg_put(skb, 0, seq, type, len, 0);\r\nif (!nlh) {\r\nkfree_skb(skb);\r\nreturn -EMSGSIZE;\r\n}\r\nmemcpy(nlmsg_data(nlh), msg, len);\r\nNETLINK_CB(skb).portid = 0;\r\nNETLINK_CB(skb).dst_group = 0;\r\nret = netlink_broadcast(sock, skb, 0, group+1, GFP_ATOMIC);\r\nif (!ret)\r\nreturn len;\r\nelse {\r\nif (ret != -ESRCH) {\r\npr_err("netlink_broadcast g=%d, t=%d, l=%d, r=%d\n",\r\ngroup, type, len, ret);\r\n}\r\nret = 0;\r\n}\r\nreturn ret;\r\n}

static void max9877_write_regs(void)\r\n{\r\nunsigned int i;\r\nu8 data[6];\r\ndata[0] = MAX9877_INPUT_MODE;\r\nfor (i = 0; i < ARRAY_SIZE(max9877_regs); i++)\r\ndata[i + 1] = max9877_regs[i];\r\nif (i2c_master_send(i2c, data, 6) != 6)\r\ndev_err(&i2c->dev, "i2c write failed\n");\r\n}\r\nstatic int max9877_get_reg(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct soc_mixer_control *mc =\r\n(struct soc_mixer_control *)kcontrol->private_value;\r\nunsigned int reg = mc->reg;\r\nunsigned int shift = mc->shift;\r\nunsigned int mask = mc->max;\r\nunsigned int invert = mc->invert;\r\nucontrol->value.integer.value[0] = (max9877_regs[reg] >> shift) & mask;\r\nif (invert)\r\nucontrol->value.integer.value[0] =\r\nmask - ucontrol->value.integer.value[0];\r\nreturn 0;\r\n}\r\nstatic int max9877_set_reg(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct soc_mixer_control *mc =\r\n(struct soc_mixer_control *)kcontrol->private_value;\r\nunsigned int reg = mc->reg;\r\nunsigned int shift = mc->shift;\r\nunsigned int mask = mc->max;\r\nunsigned int invert = mc->invert;\r\nunsigned int val = (ucontrol->value.integer.value[0] & mask);\r\nif (invert)\r\nval = mask - val;\r\nif (((max9877_regs[reg] >> shift) & mask) == val)\r\nreturn 0;\r\nmax9877_regs[reg] &= ~(mask << shift);\r\nmax9877_regs[reg] |= val << shift;\r\nmax9877_write_regs();\r\nreturn 1;\r\n}\r\nstatic int max9877_get_2reg(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct soc_mixer_control *mc =\r\n(struct soc_mixer_control *)kcontrol->private_value;\r\nunsigned int reg = mc->reg;\r\nunsigned int reg2 = mc->rreg;\r\nunsigned int shift = mc->shift;\r\nunsigned int mask = mc->max;\r\nucontrol->value.integer.value[0] = (max9877_regs[reg] >> shift) & mask;\r\nucontrol->value.integer.value[1] = (max9877_regs[reg2] >> shift) & mask;\r\nreturn 0;\r\n}\r\nstatic int max9877_set_2reg(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct soc_mixer_control *mc =\r\n(struct soc_mixer_control *)kcontrol->private_value;\r\nunsigned int reg = mc->reg;\r\nunsigned int reg2 = mc->rreg;\r\nunsigned int shift = mc->shift;\r\nunsigned int mask = mc->max;\r\nunsigned int val = (ucontrol->value.integer.value[0] & mask);\r\nunsigned int val2 = (ucontrol->value.integer.value[1] & mask);\r\nunsigned int change = 0;\r\nif (((max9877_regs[reg] >> shift) & mask) != val)\r\nchange = 1;\r\nif (((max9877_regs[reg2] >> shift) & mask) != val2)\r\nchange = 1;\r\nif (change) {\r\nmax9877_regs[reg] &= ~(mask << shift);\r\nmax9877_regs[reg] |= val << shift;\r\nmax9877_regs[reg2] &= ~(mask << shift);\r\nmax9877_regs[reg2] |= val2 << shift;\r\nmax9877_write_regs();\r\n}\r\nreturn change;\r\n}\r\nstatic int max9877_get_out_mode(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nu8 value = max9877_regs[MAX9877_OUTPUT_MODE] & MAX9877_OUTMODE_MASK;\r\nif (value)\r\nvalue -= 1;\r\nucontrol->value.integer.value[0] = value;\r\nreturn 0;\r\n}\r\nstatic int max9877_set_out_mode(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nu8 value = ucontrol->value.integer.value[0];\r\nvalue += 1;\r\nif ((max9877_regs[MAX9877_OUTPUT_MODE] & MAX9877_OUTMODE_MASK) == value)\r\nreturn 0;\r\nmax9877_regs[MAX9877_OUTPUT_MODE] &= ~MAX9877_OUTMODE_MASK;\r\nmax9877_regs[MAX9877_OUTPUT_MODE] |= value;\r\nmax9877_write_regs();\r\nreturn 1;\r\n}\r\nstatic int max9877_get_osc_mode(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nu8 value = (max9877_regs[MAX9877_OUTPUT_MODE] & MAX9877_OSC_MASK);\r\nvalue = value >> MAX9877_OSC_OFFSET;\r\nucontrol->value.integer.value[0] = value;\r\nreturn 0;\r\n}\r\nstatic int max9877_set_osc_mode(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nu8 value = ucontrol->value.integer.value[0];\r\nvalue = value << MAX9877_OSC_OFFSET;\r\nif ((max9877_regs[MAX9877_OUTPUT_MODE] & MAX9877_OSC_MASK) == value)\r\nreturn 0;\r\nmax9877_regs[MAX9877_OUTPUT_MODE] &= ~MAX9877_OSC_MASK;\r\nmax9877_regs[MAX9877_OUTPUT_MODE] |= value;\r\nmax9877_write_regs();\r\nreturn 1;\r\n}\r\nint max9877_add_controls(struct snd_soc_codec *codec)\r\n{\r\nreturn snd_soc_add_codec_controls(codec, max9877_controls,\r\nARRAY_SIZE(max9877_controls));\r\n}\r\nstatic int max9877_i2c_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\ni2c = client;\r\nmax9877_write_regs();\r\nreturn 0;\r\n}\r\nstatic int max9877_i2c_remove(struct i2c_client *client)\r\n{\r\ni2c = NULL;\r\nreturn 0;\r\n}

static void retu_wdt_ping_enable(struct retu_wdt_dev *wdev)\r\n{\r\nretu_write(wdev->rdev, RETU_REG_WATCHDOG, RETU_WDT_MAX_TIMER);\r\nschedule_delayed_work(&wdev->ping_work,\r\nround_jiffies_relative(RETU_WDT_MAX_TIMER * HZ / 2));\r\n}\r\nstatic void retu_wdt_ping_disable(struct retu_wdt_dev *wdev)\r\n{\r\nretu_write(wdev->rdev, RETU_REG_WATCHDOG, RETU_WDT_MAX_TIMER);\r\ncancel_delayed_work_sync(&wdev->ping_work);\r\n}\r\nstatic void retu_wdt_ping_work(struct work_struct *work)\r\n{\r\nstruct retu_wdt_dev *wdev = container_of(to_delayed_work(work),\r\nstruct retu_wdt_dev, ping_work);\r\nretu_wdt_ping_enable(wdev);\r\n}\r\nstatic int retu_wdt_start(struct watchdog_device *wdog)\r\n{\r\nstruct retu_wdt_dev *wdev = watchdog_get_drvdata(wdog);\r\nretu_wdt_ping_disable(wdev);\r\nreturn retu_write(wdev->rdev, RETU_REG_WATCHDOG, wdog->timeout);\r\n}\r\nstatic int retu_wdt_stop(struct watchdog_device *wdog)\r\n{\r\nstruct retu_wdt_dev *wdev = watchdog_get_drvdata(wdog);\r\nretu_wdt_ping_enable(wdev);\r\nreturn 0;\r\n}\r\nstatic int retu_wdt_ping(struct watchdog_device *wdog)\r\n{\r\nstruct retu_wdt_dev *wdev = watchdog_get_drvdata(wdog);\r\nreturn retu_write(wdev->rdev, RETU_REG_WATCHDOG, wdog->timeout);\r\n}\r\nstatic int retu_wdt_set_timeout(struct watchdog_device *wdog,\r\nunsigned int timeout)\r\n{\r\nstruct retu_wdt_dev *wdev = watchdog_get_drvdata(wdog);\r\nwdog->timeout = timeout;\r\nreturn retu_write(wdev->rdev, RETU_REG_WATCHDOG, wdog->timeout);\r\n}\r\nstatic int retu_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct retu_dev *rdev = dev_get_drvdata(pdev->dev.parent);\r\nbool nowayout = WATCHDOG_NOWAYOUT;\r\nstruct watchdog_device *retu_wdt;\r\nstruct retu_wdt_dev *wdev;\r\nint ret;\r\nretu_wdt = devm_kzalloc(&pdev->dev, sizeof(*retu_wdt), GFP_KERNEL);\r\nif (!retu_wdt)\r\nreturn -ENOMEM;\r\nwdev = devm_kzalloc(&pdev->dev, sizeof(*wdev), GFP_KERNEL);\r\nif (!wdev)\r\nreturn -ENOMEM;\r\nretu_wdt->info = &retu_wdt_info;\r\nretu_wdt->ops = &retu_wdt_ops;\r\nretu_wdt->timeout = RETU_WDT_MAX_TIMER;\r\nretu_wdt->min_timeout = 0;\r\nretu_wdt->max_timeout = RETU_WDT_MAX_TIMER;\r\nwatchdog_set_drvdata(retu_wdt, wdev);\r\nwatchdog_set_nowayout(retu_wdt, nowayout);\r\nwdev->rdev = rdev;\r\nwdev->dev = &pdev->dev;\r\nINIT_DELAYED_WORK(&wdev->ping_work, retu_wdt_ping_work);\r\nret = watchdog_register_device(retu_wdt);\r\nif (ret < 0)\r\nreturn ret;\r\nif (nowayout)\r\nretu_wdt_ping(retu_wdt);\r\nelse\r\nretu_wdt_ping_enable(wdev);\r\nplatform_set_drvdata(pdev, retu_wdt);\r\nreturn 0;\r\n}\r\nstatic int retu_wdt_remove(struct platform_device *pdev)\r\n{\r\nstruct watchdog_device *wdog = platform_get_drvdata(pdev);\r\nstruct retu_wdt_dev *wdev = watchdog_get_drvdata(wdog);\r\nwatchdog_unregister_device(wdog);\r\ncancel_delayed_work_sync(&wdev->ping_work);\r\nreturn 0;\r\n}

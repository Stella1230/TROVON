static int phys_package_first_cpu(int cpu)\r\n{\r\nint i;\r\nint id = topology_physical_package_id(cpu);\r\nfor_each_online_cpu(i)\r\nif (topology_physical_package_id(i) == id)\r\nreturn i;\r\nreturn 0;\r\n}\r\nstatic int cpu_has_cpufreq(unsigned int cpu)\r\n{\r\nstruct cpufreq_policy policy;\r\nif (!acpi_thermal_cpufreq_is_init || cpufreq_get_policy(&policy, cpu))\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic int acpi_thermal_cpufreq_notifier(struct notifier_block *nb,\r\nunsigned long event, void *data)\r\n{\r\nstruct cpufreq_policy *policy = data;\r\nunsigned long max_freq = 0;\r\nif (event != CPUFREQ_ADJUST)\r\ngoto out;\r\nmax_freq = (\r\npolicy->cpuinfo.max_freq *\r\n(100 - reduction_pctg(policy->cpu) * 20)\r\n) / 100;\r\ncpufreq_verify_within_limits(policy, 0, max_freq);\r\nout:\r\nreturn 0;\r\n}\r\nstatic int cpufreq_get_max_state(unsigned int cpu)\r\n{\r\nif (!cpu_has_cpufreq(cpu))\r\nreturn 0;\r\nreturn CPUFREQ_THERMAL_MAX_STEP;\r\n}\r\nstatic int cpufreq_get_cur_state(unsigned int cpu)\r\n{\r\nif (!cpu_has_cpufreq(cpu))\r\nreturn 0;\r\nreturn reduction_pctg(cpu);\r\n}\r\nstatic int cpufreq_set_cur_state(unsigned int cpu, int state)\r\n{\r\nint i;\r\nif (!cpu_has_cpufreq(cpu))\r\nreturn 0;\r\nreduction_pctg(cpu) = state;\r\nfor_each_online_cpu(i) {\r\nif (topology_physical_package_id(i) ==\r\ntopology_physical_package_id(cpu))\r\ncpufreq_update_policy(i);\r\n}\r\nreturn 0;\r\n}\r\nvoid acpi_thermal_cpufreq_init(void)\r\n{\r\nint i;\r\ni = cpufreq_register_notifier(&acpi_thermal_cpufreq_notifier_block,\r\nCPUFREQ_POLICY_NOTIFIER);\r\nif (!i)\r\nacpi_thermal_cpufreq_is_init = 1;\r\n}\r\nvoid acpi_thermal_cpufreq_exit(void)\r\n{\r\nif (acpi_thermal_cpufreq_is_init)\r\ncpufreq_unregister_notifier\r\n(&acpi_thermal_cpufreq_notifier_block,\r\nCPUFREQ_POLICY_NOTIFIER);\r\nacpi_thermal_cpufreq_is_init = 0;\r\n}\r\nstatic int cpufreq_get_max_state(unsigned int cpu)\r\n{\r\nreturn 0;\r\n}\r\nstatic int cpufreq_get_cur_state(unsigned int cpu)\r\n{\r\nreturn 0;\r\n}\r\nstatic int cpufreq_set_cur_state(unsigned int cpu, int state)\r\n{\r\nreturn 0;\r\n}\r\nint acpi_processor_get_limit_info(struct acpi_processor *pr)\r\n{\r\nif (!pr)\r\nreturn -EINVAL;\r\nif (pr->flags.throttling)\r\npr->flags.limit = 1;\r\nreturn 0;\r\n}\r\nstatic int acpi_processor_max_state(struct acpi_processor *pr)\r\n{\r\nint max_state = 0;\r\nmax_state += cpufreq_get_max_state(pr->id);\r\nif (pr->flags.throttling)\r\nmax_state += (pr->throttling.state_count -1);\r\nreturn max_state;\r\n}\r\nstatic int\r\nprocessor_get_max_state(struct thermal_cooling_device *cdev,\r\nunsigned long *state)\r\n{\r\nstruct acpi_device *device = cdev->devdata;\r\nstruct acpi_processor *pr;\r\nif (!device)\r\nreturn -EINVAL;\r\npr = acpi_driver_data(device);\r\nif (!pr)\r\nreturn -EINVAL;\r\n*state = acpi_processor_max_state(pr);\r\nreturn 0;\r\n}\r\nstatic int\r\nprocessor_get_cur_state(struct thermal_cooling_device *cdev,\r\nunsigned long *cur_state)\r\n{\r\nstruct acpi_device *device = cdev->devdata;\r\nstruct acpi_processor *pr;\r\nif (!device)\r\nreturn -EINVAL;\r\npr = acpi_driver_data(device);\r\nif (!pr)\r\nreturn -EINVAL;\r\n*cur_state = cpufreq_get_cur_state(pr->id);\r\nif (pr->flags.throttling)\r\n*cur_state += pr->throttling.state;\r\nreturn 0;\r\n}\r\nstatic int\r\nprocessor_set_cur_state(struct thermal_cooling_device *cdev,\r\nunsigned long state)\r\n{\r\nstruct acpi_device *device = cdev->devdata;\r\nstruct acpi_processor *pr;\r\nint result = 0;\r\nint max_pstate;\r\nif (!device)\r\nreturn -EINVAL;\r\npr = acpi_driver_data(device);\r\nif (!pr)\r\nreturn -EINVAL;\r\nmax_pstate = cpufreq_get_max_state(pr->id);\r\nif (state > acpi_processor_max_state(pr))\r\nreturn -EINVAL;\r\nif (state <= max_pstate) {\r\nif (pr->flags.throttling && pr->throttling.state)\r\nresult = acpi_processor_set_throttling(pr, 0, false);\r\ncpufreq_set_cur_state(pr->id, state);\r\n} else {\r\ncpufreq_set_cur_state(pr->id, max_pstate);\r\nresult = acpi_processor_set_throttling(pr,\r\nstate - max_pstate, false);\r\n}\r\nreturn result;\r\n}

void\r\nWPA2_ClearRSN(\r\nPKnownBSS pBSSNode\r\n)\r\n{\r\nint ii;\r\npBSSNode->bWPA2Valid = false;\r\npBSSNode->byCSSGK = WLAN_11i_CSS_CCMP;\r\nfor (ii = 0; ii < 4; ii++)\r\npBSSNode->abyCSSPK[ii] = WLAN_11i_CSS_CCMP;\r\npBSSNode->wCSSPKCount = 1;\r\nfor (ii = 0; ii < 4; ii++)\r\npBSSNode->abyAKMSSAuthType[ii] = WLAN_11i_AKMSS_802_1X;\r\npBSSNode->wAKMSSAuthCount = 1;\r\npBSSNode->sRSNCapObj.bRSNCapExist = false;\r\npBSSNode->sRSNCapObj.wRSNCap = 0;\r\n}\r\nvoid\r\nWPA2vParseRSN(\r\nPKnownBSS pBSSNode,\r\nPWLAN_IE_RSN pRSN\r\n)\r\n{\r\nint i, j;\r\nunsigned short m = 0, n = 0;\r\nunsigned char *pbyOUI;\r\nbool bUseGK = false;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "WPA2_ParseRSN: [%d]\n", pRSN->len);\r\nWPA2_ClearRSN(pBSSNode);\r\nif (pRSN->len == 2) {\r\nif ((pRSN->byElementID == WLAN_EID_RSN) && (pRSN->wVersion == 1)) {\r\npBSSNode->bWPA2Valid = true;\r\n}\r\nreturn;\r\n}\r\nif (pRSN->len < 6) {\r\nreturn;\r\n}\r\nif ((pRSN->byElementID == WLAN_EID_RSN) &&\r\n(pRSN->wVersion == 1)) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Legal 802.11i RSN\n");\r\npbyOUI = &(pRSN->abyRSN[0]);\r\nif (!memcmp(pbyOUI, abyOUIWEP40, 4))\r\npBSSNode->byCSSGK = WLAN_11i_CSS_WEP40;\r\nelse if (!memcmp(pbyOUI, abyOUITKIP, 4))\r\npBSSNode->byCSSGK = WLAN_11i_CSS_TKIP;\r\nelse if (!memcmp(pbyOUI, abyOUICCMP, 4))\r\npBSSNode->byCSSGK = WLAN_11i_CSS_CCMP;\r\nelse if (!memcmp(pbyOUI, abyOUIWEP104, 4))\r\npBSSNode->byCSSGK = WLAN_11i_CSS_WEP104;\r\nelse if (!memcmp(pbyOUI, abyOUIGK, 4)) {\r\nreturn;\r\n} else\r\npBSSNode->byCSSGK = WLAN_11i_CSS_UNKNOWN;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "802.11i CSS: %X\n", pBSSNode->byCSSGK);\r\nif (pRSN->len == 6) {\r\npBSSNode->bWPA2Valid = true;\r\nreturn;\r\n}\r\nif (pRSN->len >= 8) {\r\npBSSNode->wCSSPKCount = *((unsigned short *)&(pRSN->abyRSN[4]));\r\nj = 0;\r\npbyOUI = &(pRSN->abyRSN[6]);\r\nfor (i = 0; (i < pBSSNode->wCSSPKCount) && (j < sizeof(pBSSNode->abyCSSPK)/sizeof(unsigned char)); i++) {\r\nif (pRSN->len >= 8+i*4+4) {\r\nif (!memcmp(pbyOUI, abyOUIGK, 4)) {\r\npBSSNode->abyCSSPK[j++] = WLAN_11i_CSS_USE_GROUP;\r\nbUseGK = true;\r\n} else if (!memcmp(pbyOUI, abyOUIWEP40, 4)) {\r\n} else if (!memcmp(pbyOUI, abyOUITKIP, 4)) {\r\nif (pBSSNode->byCSSGK != WLAN_11i_CSS_CCMP)\r\npBSSNode->abyCSSPK[j++] = WLAN_11i_CSS_TKIP;\r\nelse\r\n;\r\n} else if (!memcmp(pbyOUI, abyOUICCMP, 4)) {\r\npBSSNode->abyCSSPK[j++] = WLAN_11i_CSS_CCMP;\r\n} else if (!memcmp(pbyOUI, abyOUIWEP104, 4)) {\r\n} else {\r\npBSSNode->abyCSSPK[j++] = WLAN_11i_CSS_UNKNOWN;\r\n}\r\npbyOUI += 4;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "abyCSSPK[%d]: %X\n", j-1, pBSSNode->abyCSSPK[j-1]);\r\n} else\r\nbreak;\r\n}\r\nif (bUseGK == true) {\r\nif (j != 1) {\r\nreturn;\r\n}\r\nif (pBSSNode->byCSSGK == WLAN_11i_CSS_CCMP) {\r\nreturn;\r\n}\r\n}\r\nif ((pBSSNode->wCSSPKCount != 0) && (j == 0)) {\r\nreturn;\r\n}\r\npBSSNode->wCSSPKCount = (unsigned short)j;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "wCSSPKCount: %d\n", pBSSNode->wCSSPKCount);\r\n}\r\nm = *((unsigned short *)&(pRSN->abyRSN[4]));\r\nif (pRSN->len >= 10+m*4) {\r\npBSSNode->wAKMSSAuthCount = *((unsigned short *)&(pRSN->abyRSN[6+4*m]));\r\nj = 0;\r\npbyOUI = &(pRSN->abyRSN[8+4*m]);\r\nfor (i = 0; (i < pBSSNode->wAKMSSAuthCount) && (j < sizeof(pBSSNode->abyAKMSSAuthType)/sizeof(unsigned char)); i++) {\r\nif (pRSN->len >= 10+(m+i)*4+4) {\r\nif (!memcmp(pbyOUI, abyOUI8021X, 4))\r\npBSSNode->abyAKMSSAuthType[j++] = WLAN_11i_AKMSS_802_1X;\r\nelse if (!memcmp(pbyOUI, abyOUIPSK, 4))\r\npBSSNode->abyAKMSSAuthType[j++] = WLAN_11i_AKMSS_PSK;\r\nelse\r\npBSSNode->abyAKMSSAuthType[j++] = WLAN_11i_AKMSS_UNKNOWN;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "abyAKMSSAuthType[%d]: %X\n", j-1, pBSSNode->abyAKMSSAuthType[j-1]);\r\n} else\r\nbreak;\r\n}\r\npBSSNode->wAKMSSAuthCount = (unsigned short)j;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "wAKMSSAuthCount: %d\n", pBSSNode->wAKMSSAuthCount);\r\nn = *((unsigned short *)&(pRSN->abyRSN[6+4*m]));\r\nif (pRSN->len >= 12 + 4 * m + 4 * n) {\r\npBSSNode->sRSNCapObj.bRSNCapExist = true;\r\npBSSNode->sRSNCapObj.wRSNCap = *((unsigned short *)&(pRSN->abyRSN[8+4*m+4*n]));\r\n}\r\n}\r\npBSSNode->bWPA2Valid = true;\r\n}\r\n}\r\nunsigned int\r\nWPA2uSetIEs(\r\nvoid *pMgmtHandle,\r\nPWLAN_IE_RSN pRSNIEs\r\n)\r\n{\r\nPSMgmtObject pMgmt = (PSMgmtObject) pMgmtHandle;\r\nunsigned char *pbyBuffer = NULL;\r\nunsigned int ii = 0;\r\nunsigned short *pwPMKID = NULL;\r\nif (pRSNIEs == NULL) {\r\nreturn 0;\r\n}\r\nif (((pMgmt->eAuthenMode == WMAC_AUTH_WPA2) ||\r\n(pMgmt->eAuthenMode == WMAC_AUTH_WPA2PSK)) &&\r\n(pMgmt->pCurrBSS != NULL)) {\r\npbyBuffer = (unsigned char *)pRSNIEs;\r\npRSNIEs->byElementID = WLAN_EID_RSN;\r\npRSNIEs->len = 6;\r\npRSNIEs->wVersion = 1;\r\npRSNIEs->abyRSN[0] = 0x00;\r\npRSNIEs->abyRSN[1] = 0x0F;\r\npRSNIEs->abyRSN[2] = 0xAC;\r\nif (pMgmt->byCSSGK == KEY_CTL_WEP) {\r\npRSNIEs->abyRSN[3] = pMgmt->pCurrBSS->byCSSGK;\r\n} else if (pMgmt->byCSSGK == KEY_CTL_TKIP) {\r\npRSNIEs->abyRSN[3] = WLAN_11i_CSS_TKIP;\r\n} else if (pMgmt->byCSSGK == KEY_CTL_CCMP) {\r\npRSNIEs->abyRSN[3] = WLAN_11i_CSS_CCMP;\r\n} else {\r\npRSNIEs->abyRSN[3] = WLAN_11i_CSS_UNKNOWN;\r\n}\r\npRSNIEs->abyRSN[4] = 1;\r\npRSNIEs->abyRSN[5] = 0;\r\npRSNIEs->abyRSN[6] = 0x00;\r\npRSNIEs->abyRSN[7] = 0x0F;\r\npRSNIEs->abyRSN[8] = 0xAC;\r\nif (pMgmt->byCSSPK == KEY_CTL_TKIP) {\r\npRSNIEs->abyRSN[9] = WLAN_11i_CSS_TKIP;\r\n} else if (pMgmt->byCSSPK == KEY_CTL_CCMP) {\r\npRSNIEs->abyRSN[9] = WLAN_11i_CSS_CCMP;\r\n} else if (pMgmt->byCSSPK == KEY_CTL_NONE) {\r\npRSNIEs->abyRSN[9] = WLAN_11i_CSS_USE_GROUP;\r\n} else {\r\npRSNIEs->abyRSN[9] = WLAN_11i_CSS_UNKNOWN;\r\n}\r\npRSNIEs->len += 6;\r\npRSNIEs->abyRSN[10] = 1;\r\npRSNIEs->abyRSN[11] = 0;\r\npRSNIEs->abyRSN[12] = 0x00;\r\npRSNIEs->abyRSN[13] = 0x0F;\r\npRSNIEs->abyRSN[14] = 0xAC;\r\nif (pMgmt->eAuthenMode == WMAC_AUTH_WPA2PSK) {\r\npRSNIEs->abyRSN[15] = WLAN_11i_AKMSS_PSK;\r\n} else if (pMgmt->eAuthenMode == WMAC_AUTH_WPA2) {\r\npRSNIEs->abyRSN[15] = WLAN_11i_AKMSS_802_1X;\r\n} else {\r\npRSNIEs->abyRSN[15] = WLAN_11i_AKMSS_UNKNOWN;\r\n}\r\npRSNIEs->len += 6;\r\nif (pMgmt->pCurrBSS->sRSNCapObj.bRSNCapExist == true) {\r\nmemcpy(&pRSNIEs->abyRSN[16], &pMgmt->pCurrBSS->sRSNCapObj.wRSNCap, 2);\r\n} else {\r\npRSNIEs->abyRSN[16] = 0;\r\npRSNIEs->abyRSN[17] = 0;\r\n}\r\npRSNIEs->len += 2;\r\nif ((pMgmt->gsPMKIDCache.BSSIDInfoCount > 0) &&\r\n(pMgmt->bRoaming == true) &&\r\n(pMgmt->eAuthenMode == WMAC_AUTH_WPA2)) {\r\npwPMKID = (unsigned short *)(&pRSNIEs->abyRSN[18]);\r\n*pwPMKID = 0;\r\npbyBuffer = &pRSNIEs->abyRSN[20];\r\nfor (ii = 0; ii < pMgmt->gsPMKIDCache.BSSIDInfoCount; ii++) {\r\nif (!memcmp(&pMgmt->gsPMKIDCache.BSSIDInfo[ii].abyBSSID[0], pMgmt->abyCurrBSSID, ETH_ALEN)) {\r\n(*pwPMKID)++;\r\nmemcpy(pbyBuffer, pMgmt->gsPMKIDCache.BSSIDInfo[ii].abyPMKID, 16);\r\npbyBuffer += 16;\r\n}\r\n}\r\nif (*pwPMKID != 0) {\r\npRSNIEs->len += (2 + (*pwPMKID)*16);\r\n} else {\r\npbyBuffer = &pRSNIEs->abyRSN[18];\r\n}\r\n}\r\nreturn pRSNIEs->len + WLAN_IEHDR_LEN;\r\n}\r\nreturn 0;\r\n}

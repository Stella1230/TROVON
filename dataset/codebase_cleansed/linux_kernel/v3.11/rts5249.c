static u8 rts5249_get_ic_version(struct rtsx_pcr *pcr)\r\n{\r\nu8 val;\r\nrtsx_pci_read_register(pcr, DUMMY_REG_RESET_0, &val);\r\nreturn val & 0x0F;\r\n}\r\nstatic int rts5249_extra_init_hw(struct rtsx_pcr *pcr)\r\n{\r\nrtsx_pci_init_cmd(pcr);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, GPIO_CTL, 0x02, 0x02);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, LDO_PWR_SEL, 0x03, 0x00);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, LDO_PWR_SEL, 0x03, 0x01);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, OLT_LED_CTL, 0x0F, 0x02);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD,\r\nSD30_CLK_DRIVE_SEL, 0xFF, 0x99);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD,\r\nSD30_CMD_DRIVE_SEL, 0xFF, 0x99);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD,\r\nSD30_DAT_DRIVE_SEL, 0xFF, 0x92);\r\nreturn rtsx_pci_send_cmd(pcr, 100);\r\n}\r\nstatic int rts5249_optimize_phy(struct rtsx_pcr *pcr)\r\n{\r\nint err;\r\nerr = rtsx_pci_write_phy_register(pcr, PHY_REG_REV, 0xFE46);\r\nif (err < 0)\r\nreturn err;\r\nmsleep(1);\r\nreturn rtsx_pci_write_phy_register(pcr, PHY_BPCR, 0x05C0);\r\n}\r\nstatic int rts5249_turn_on_led(struct rtsx_pcr *pcr)\r\n{\r\nreturn rtsx_pci_write_register(pcr, GPIO_CTL, 0x02, 0x02);\r\n}\r\nstatic int rts5249_turn_off_led(struct rtsx_pcr *pcr)\r\n{\r\nreturn rtsx_pci_write_register(pcr, GPIO_CTL, 0x02, 0x00);\r\n}\r\nstatic int rts5249_enable_auto_blink(struct rtsx_pcr *pcr)\r\n{\r\nreturn rtsx_pci_write_register(pcr, OLT_LED_CTL, 0x08, 0x08);\r\n}\r\nstatic int rts5249_disable_auto_blink(struct rtsx_pcr *pcr)\r\n{\r\nreturn rtsx_pci_write_register(pcr, OLT_LED_CTL, 0x08, 0x00);\r\n}\r\nstatic int rts5249_card_power_on(struct rtsx_pcr *pcr, int card)\r\n{\r\nint err;\r\nrtsx_pci_init_cmd(pcr);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_PWR_CTL,\r\nSD_POWER_MASK, SD_VCC_PARTIAL_POWER_ON);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PWR_GATE_CTRL,\r\nLDO3318_PWR_MASK, 0x02);\r\nerr = rtsx_pci_send_cmd(pcr, 100);\r\nif (err < 0)\r\nreturn err;\r\nmsleep(5);\r\nrtsx_pci_init_cmd(pcr);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_PWR_CTL,\r\nSD_POWER_MASK, SD_VCC_POWER_ON);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PWR_GATE_CTRL,\r\nLDO3318_PWR_MASK, 0x06);\r\nerr = rtsx_pci_send_cmd(pcr, 100);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int rts5249_card_power_off(struct rtsx_pcr *pcr, int card)\r\n{\r\nrtsx_pci_init_cmd(pcr);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, CARD_PWR_CTL,\r\nSD_POWER_MASK, SD_POWER_OFF);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, PWR_GATE_CTRL,\r\nLDO3318_PWR_MASK, 0x00);\r\nreturn rtsx_pci_send_cmd(pcr, 100);\r\n}\r\nstatic int rts5249_switch_output_voltage(struct rtsx_pcr *pcr, u8 voltage)\r\n{\r\nint err;\r\nu8 clk_drive, cmd_drive, dat_drive;\r\nif (voltage == OUTPUT_3V3) {\r\nerr = rtsx_pci_write_phy_register(pcr, PHY_TUNE, 0x4FC0 | 0x24);\r\nif (err < 0)\r\nreturn err;\r\nclk_drive = 0x99;\r\ncmd_drive = 0x99;\r\ndat_drive = 0x92;\r\n} else if (voltage == OUTPUT_1V8) {\r\nerr = rtsx_pci_write_phy_register(pcr, PHY_BACR, 0x3C02);\r\nif (err < 0)\r\nreturn err;\r\nerr = rtsx_pci_write_phy_register(pcr, PHY_TUNE, 0x4C40 | 0x24);\r\nif (err < 0)\r\nreturn err;\r\nclk_drive = 0xb3;\r\ncmd_drive = 0xb3;\r\ndat_drive = 0xb3;\r\n} else {\r\nreturn -EINVAL;\r\n}\r\nrtsx_pci_init_cmd(pcr);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, SD30_CLK_DRIVE_SEL,\r\n0xFF, clk_drive);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, SD30_CMD_DRIVE_SEL,\r\n0xFF, cmd_drive);\r\nrtsx_pci_add_cmd(pcr, WRITE_REG_CMD, SD30_DAT_DRIVE_SEL,\r\n0xFF, dat_drive);\r\nreturn rtsx_pci_send_cmd(pcr, 100);\r\n}\r\nvoid rts5249_init_params(struct rtsx_pcr *pcr)\r\n{\r\npcr->extra_caps = EXTRA_CAPS_SD_SDR50 | EXTRA_CAPS_SD_SDR104;\r\npcr->num_slots = 2;\r\npcr->ops = &rts5249_pcr_ops;\r\npcr->ic_version = rts5249_get_ic_version(pcr);\r\npcr->sd_pull_ctl_enable_tbl = rts5249_sd_pull_ctl_enable_tbl;\r\npcr->sd_pull_ctl_disable_tbl = rts5249_sd_pull_ctl_disable_tbl;\r\npcr->ms_pull_ctl_enable_tbl = rts5249_ms_pull_ctl_enable_tbl;\r\npcr->ms_pull_ctl_disable_tbl = rts5249_ms_pull_ctl_disable_tbl;\r\n}

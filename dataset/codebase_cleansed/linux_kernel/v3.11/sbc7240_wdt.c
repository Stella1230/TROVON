static void wdt_disable(void)\r\n{\r\nif (test_and_clear_bit(SBC7240_ENABLED_STATUS_BIT, &wdt_status)) {\r\ninb_p(SBC7240_DISABLE_PORT);\r\npr_info("Watchdog timer is now disabled\n");\r\n}\r\n}\r\nstatic void wdt_enable(void)\r\n{\r\nif (!test_and_set_bit(SBC7240_ENABLED_STATUS_BIT, &wdt_status)) {\r\ninb_p(SBC7240_ENABLE_PORT);\r\npr_info("Watchdog timer is now enabled\n");\r\n}\r\n}\r\nstatic int wdt_set_timeout(int t)\r\n{\r\nif (t < 1 || t > SBC7240_MAX_TIMEOUT) {\r\npr_err("timeout value must be 1<=x<=%d\n", SBC7240_MAX_TIMEOUT);\r\nreturn -1;\r\n}\r\noutb_p((unsigned)t, SBC7240_SET_TIMEOUT_PORT);\r\ntimeout = t;\r\npr_info("timeout set to %d seconds\n", t);\r\nreturn 0;\r\n}\r\nstatic inline void wdt_keepalive(void)\r\n{\r\nif (test_bit(SBC7240_ENABLED_STATUS_BIT, &wdt_status))\r\ninb_p(SBC7240_ENABLE_PORT);\r\n}\r\nstatic ssize_t fop_write(struct file *file, const char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nsize_t i;\r\nchar c;\r\nif (count) {\r\nif (!nowayout) {\r\nclear_bit(SBC7240_EXPECT_CLOSE_STATUS_BIT,\r\n&wdt_status);\r\nfor (i = 0; i != count; i++) {\r\nif (get_user(c, buf + i))\r\nreturn -EFAULT;\r\nif (c == SBC7240_MAGIC_CHAR) {\r\nset_bit(SBC7240_EXPECT_CLOSE_STATUS_BIT,\r\n&wdt_status);\r\nbreak;\r\n}\r\n}\r\n}\r\nwdt_keepalive();\r\n}\r\nreturn count;\r\n}\r\nstatic int fop_open(struct inode *inode, struct file *file)\r\n{\r\nif (test_and_set_bit(SBC7240_OPEN_STATUS_BIT, &wdt_status))\r\nreturn -EBUSY;\r\nwdt_enable();\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic int fop_close(struct inode *inode, struct file *file)\r\n{\r\nif (test_and_clear_bit(SBC7240_EXPECT_CLOSE_STATUS_BIT, &wdt_status)\r\n|| !nowayout) {\r\nwdt_disable();\r\n} else {\r\npr_crit("Unexpected close, not stopping watchdog!\n");\r\nwdt_keepalive();\r\n}\r\nclear_bit(SBC7240_OPEN_STATUS_BIT, &wdt_status);\r\nreturn 0;\r\n}\r\nstatic long fop_ioctl(struct file *file, unsigned int cmd, unsigned long arg)\r\n{\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nreturn copy_to_user((void __user *)arg, &ident, sizeof(ident))\r\n? -EFAULT : 0;\r\ncase WDIOC_GETSTATUS:\r\ncase WDIOC_GETBOOTSTATUS:\r\nreturn put_user(0, (int __user *)arg);\r\ncase WDIOC_SETOPTIONS:\r\n{\r\nint options;\r\nint retval = -EINVAL;\r\nif (get_user(options, (int __user *)arg))\r\nreturn -EFAULT;\r\nif (options & WDIOS_DISABLECARD) {\r\nwdt_disable();\r\nretval = 0;\r\n}\r\nif (options & WDIOS_ENABLECARD) {\r\nwdt_enable();\r\nretval = 0;\r\n}\r\nreturn retval;\r\n}\r\ncase WDIOC_KEEPALIVE:\r\nwdt_keepalive();\r\nreturn 0;\r\ncase WDIOC_SETTIMEOUT:\r\n{\r\nint new_timeout;\r\nif (get_user(new_timeout, (int __user *)arg))\r\nreturn -EFAULT;\r\nif (wdt_set_timeout(new_timeout))\r\nreturn -EINVAL;\r\n}\r\ncase WDIOC_GETTIMEOUT:\r\nreturn put_user(timeout, (int __user *)arg);\r\ndefault:\r\nreturn -ENOTTY;\r\n}\r\n}\r\nstatic int wdt_notify_sys(struct notifier_block *this, unsigned long code,\r\nvoid *unused)\r\n{\r\nif (code == SYS_DOWN || code == SYS_HALT)\r\nwdt_disable();\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic void __exit sbc7240_wdt_unload(void)\r\n{\r\npr_info("Removing watchdog\n");\r\nmisc_deregister(&wdt_miscdev);\r\nunregister_reboot_notifier(&wdt_notifier);\r\nrelease_region(SBC7240_ENABLE_PORT, 1);\r\n}\r\nstatic int __init sbc7240_wdt_init(void)\r\n{\r\nint rc = -EBUSY;\r\nif (!request_region(SBC7240_ENABLE_PORT, 1, "SBC7240 WDT")) {\r\npr_err("I/O address 0x%04x already in use\n",\r\nSBC7240_ENABLE_PORT);\r\nrc = -EIO;\r\ngoto err_out;\r\n}\r\nif (timeout < 1 || timeout > SBC7240_MAX_TIMEOUT) {\r\ntimeout = SBC7240_TIMEOUT;\r\npr_info("timeout value must be 1<=x<=%d, using %d\n",\r\nSBC7240_MAX_TIMEOUT, timeout);\r\n}\r\nwdt_set_timeout(timeout);\r\nwdt_disable();\r\nrc = register_reboot_notifier(&wdt_notifier);\r\nif (rc) {\r\npr_err("cannot register reboot notifier (err=%d)\n", rc);\r\ngoto err_out_region;\r\n}\r\nrc = misc_register(&wdt_miscdev);\r\nif (rc) {\r\npr_err("cannot register miscdev on minor=%d (err=%d)\n",\r\nwdt_miscdev.minor, rc);\r\ngoto err_out_reboot_notifier;\r\n}\r\npr_info("Watchdog driver for SBC7240 initialised (nowayout=%d)\n",\r\nnowayout);\r\nreturn 0;\r\nerr_out_reboot_notifier:\r\nunregister_reboot_notifier(&wdt_notifier);\r\nerr_out_region:\r\nrelease_region(SBC7240_ENABLE_PORT, 1);\r\nerr_out:\r\nreturn rc;\r\n}

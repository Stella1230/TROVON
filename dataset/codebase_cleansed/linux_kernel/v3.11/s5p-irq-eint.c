static inline void s5p_irq_eint_mask(struct irq_data *data)\r\n{\r\nu32 mask;\r\nmask = __raw_readl(S5P_EINT_MASK(EINT_REG_NR(data->irq)));\r\nmask |= eint_irq_to_bit(data->irq);\r\n__raw_writel(mask, S5P_EINT_MASK(EINT_REG_NR(data->irq)));\r\n}\r\nstatic void s5p_irq_eint_unmask(struct irq_data *data)\r\n{\r\nu32 mask;\r\nmask = __raw_readl(S5P_EINT_MASK(EINT_REG_NR(data->irq)));\r\nmask &= ~(eint_irq_to_bit(data->irq));\r\n__raw_writel(mask, S5P_EINT_MASK(EINT_REG_NR(data->irq)));\r\n}\r\nstatic inline void s5p_irq_eint_ack(struct irq_data *data)\r\n{\r\n__raw_writel(eint_irq_to_bit(data->irq),\r\nS5P_EINT_PEND(EINT_REG_NR(data->irq)));\r\n}\r\nstatic void s5p_irq_eint_maskack(struct irq_data *data)\r\n{\r\ns5p_irq_eint_mask(data);\r\ns5p_irq_eint_ack(data);\r\n}\r\nstatic int s5p_irq_eint_set_type(struct irq_data *data, unsigned int type)\r\n{\r\nint offs = EINT_OFFSET(data->irq);\r\nint shift;\r\nu32 ctrl, mask;\r\nu32 newvalue = 0;\r\nswitch (type) {\r\ncase IRQ_TYPE_EDGE_RISING:\r\nnewvalue = S5P_IRQ_TYPE_EDGE_RISING;\r\nbreak;\r\ncase IRQ_TYPE_EDGE_FALLING:\r\nnewvalue = S5P_IRQ_TYPE_EDGE_FALLING;\r\nbreak;\r\ncase IRQ_TYPE_EDGE_BOTH:\r\nnewvalue = S5P_IRQ_TYPE_EDGE_BOTH;\r\nbreak;\r\ncase IRQ_TYPE_LEVEL_LOW:\r\nnewvalue = S5P_IRQ_TYPE_LEVEL_LOW;\r\nbreak;\r\ncase IRQ_TYPE_LEVEL_HIGH:\r\nnewvalue = S5P_IRQ_TYPE_LEVEL_HIGH;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "No such irq type %d", type);\r\nreturn -EINVAL;\r\n}\r\nshift = (offs & 0x7) * 4;\r\nmask = 0x7 << shift;\r\nctrl = __raw_readl(S5P_EINT_CON(EINT_REG_NR(data->irq)));\r\nctrl &= ~mask;\r\nctrl |= newvalue << shift;\r\n__raw_writel(ctrl, S5P_EINT_CON(EINT_REG_NR(data->irq)));\r\nif ((0 <= offs) && (offs < 8))\r\ns3c_gpio_cfgpin(EINT_GPIO_0(offs & 0x7), EINT_MODE);\r\nelse if ((8 <= offs) && (offs < 16))\r\ns3c_gpio_cfgpin(EINT_GPIO_1(offs & 0x7), EINT_MODE);\r\nelse if ((16 <= offs) && (offs < 24))\r\ns3c_gpio_cfgpin(EINT_GPIO_2(offs & 0x7), EINT_MODE);\r\nelse if ((24 <= offs) && (offs < 32))\r\ns3c_gpio_cfgpin(EINT_GPIO_3(offs & 0x7), EINT_MODE);\r\nelse\r\nprintk(KERN_ERR "No such irq number %d", offs);\r\nreturn 0;\r\n}\r\nstatic inline void s5p_irq_demux_eint(unsigned int start)\r\n{\r\nu32 status = __raw_readl(S5P_EINT_PEND(EINT_REG_NR(start)));\r\nu32 mask = __raw_readl(S5P_EINT_MASK(EINT_REG_NR(start)));\r\nunsigned int irq;\r\nstatus &= ~mask;\r\nstatus &= 0xff;\r\nwhile (status) {\r\nirq = fls(status) - 1;\r\ngeneric_handle_irq(irq + start);\r\nstatus &= ~(1 << irq);\r\n}\r\n}\r\nstatic void s5p_irq_demux_eint16_31(unsigned int irq, struct irq_desc *desc)\r\n{\r\ns5p_irq_demux_eint(IRQ_EINT(16));\r\ns5p_irq_demux_eint(IRQ_EINT(24));\r\n}\r\nstatic inline void s5p_irq_vic_eint_mask(struct irq_data *data)\r\n{\r\nvoid __iomem *base = irq_data_get_irq_chip_data(data);\r\ns5p_irq_eint_mask(data);\r\nwritel(1 << EINT_OFFSET(data->irq), base + VIC_INT_ENABLE_CLEAR);\r\n}\r\nstatic void s5p_irq_vic_eint_unmask(struct irq_data *data)\r\n{\r\nvoid __iomem *base = irq_data_get_irq_chip_data(data);\r\ns5p_irq_eint_unmask(data);\r\nwritel(1 << EINT_OFFSET(data->irq), base + VIC_INT_ENABLE);\r\n}\r\nstatic inline void s5p_irq_vic_eint_ack(struct irq_data *data)\r\n{\r\n__raw_writel(eint_irq_to_bit(data->irq),\r\nS5P_EINT_PEND(EINT_REG_NR(data->irq)));\r\n}\r\nstatic void s5p_irq_vic_eint_maskack(struct irq_data *data)\r\n{\r\ns5p_irq_vic_eint_mask(data);\r\ns5p_irq_vic_eint_ack(data);\r\n}\r\nstatic int __init s5p_init_irq_eint(void)\r\n{\r\nint irq;\r\nfor (irq = IRQ_EINT(0); irq <= IRQ_EINT(15); irq++)\r\nirq_set_chip(irq, &s5p_irq_vic_eint);\r\nfor (irq = IRQ_EINT(16); irq <= IRQ_EINT(31); irq++) {\r\nirq_set_chip_and_handler(irq, &s5p_irq_eint, handle_level_irq);\r\nset_irq_flags(irq, IRQF_VALID);\r\n}\r\nirq_set_chained_handler(IRQ_EINT16_31, s5p_irq_demux_eint16_31);\r\nreturn 0;\r\n}

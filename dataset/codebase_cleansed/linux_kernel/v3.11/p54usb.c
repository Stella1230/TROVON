static void p54u_rx_cb(struct urb *urb)\r\n{\r\nstruct sk_buff *skb = (struct sk_buff *) urb->context;\r\nstruct p54u_rx_info *info = (struct p54u_rx_info *)skb->cb;\r\nstruct ieee80211_hw *dev = info->dev;\r\nstruct p54u_priv *priv = dev->priv;\r\nskb_unlink(skb, &priv->rx_queue);\r\nif (unlikely(urb->status)) {\r\ndev_kfree_skb_irq(skb);\r\nreturn;\r\n}\r\nskb_put(skb, urb->actual_length);\r\nif (priv->hw_type == P54U_NET2280)\r\nskb_pull(skb, priv->common.tx_hdr_len);\r\nif (priv->common.fw_interface == FW_LM87) {\r\nskb_pull(skb, 4);\r\nskb_put(skb, 4);\r\n}\r\nif (p54_rx(dev, skb)) {\r\nskb = dev_alloc_skb(priv->common.rx_mtu + 32);\r\nif (unlikely(!skb)) {\r\nreturn;\r\n}\r\ninfo = (struct p54u_rx_info *) skb->cb;\r\ninfo->urb = urb;\r\ninfo->dev = dev;\r\nurb->transfer_buffer = skb_tail_pointer(skb);\r\nurb->context = skb;\r\n} else {\r\nif (priv->hw_type == P54U_NET2280)\r\nskb_push(skb, priv->common.tx_hdr_len);\r\nif (priv->common.fw_interface == FW_LM87) {\r\nskb_push(skb, 4);\r\nskb_put(skb, 4);\r\n}\r\nskb_reset_tail_pointer(skb);\r\nskb_trim(skb, 0);\r\nurb->transfer_buffer = skb_tail_pointer(skb);\r\n}\r\nskb_queue_tail(&priv->rx_queue, skb);\r\nusb_anchor_urb(urb, &priv->submitted);\r\nif (usb_submit_urb(urb, GFP_ATOMIC)) {\r\nskb_unlink(skb, &priv->rx_queue);\r\nusb_unanchor_urb(urb);\r\ndev_kfree_skb_irq(skb);\r\n}\r\n}\r\nstatic void p54u_tx_cb(struct urb *urb)\r\n{\r\nstruct sk_buff *skb = urb->context;\r\nstruct ieee80211_hw *dev =\r\nusb_get_intfdata(usb_ifnum_to_if(urb->dev, 0));\r\np54_free_skb(dev, skb);\r\n}\r\nstatic void p54u_tx_dummy_cb(struct urb *urb) { }\r\nstatic void p54u_free_urbs(struct ieee80211_hw *dev)\r\n{\r\nstruct p54u_priv *priv = dev->priv;\r\nusb_kill_anchored_urbs(&priv->submitted);\r\n}\r\nstatic void p54u_stop(struct ieee80211_hw *dev)\r\n{\r\np54u_free_urbs(dev);\r\n}\r\nstatic int p54u_init_urbs(struct ieee80211_hw *dev)\r\n{\r\nstruct p54u_priv *priv = dev->priv;\r\nstruct urb *entry = NULL;\r\nstruct sk_buff *skb;\r\nstruct p54u_rx_info *info;\r\nint ret = 0;\r\nwhile (skb_queue_len(&priv->rx_queue) < 32) {\r\nskb = __dev_alloc_skb(priv->common.rx_mtu + 32, GFP_KERNEL);\r\nif (!skb) {\r\nret = -ENOMEM;\r\ngoto err;\r\n}\r\nentry = usb_alloc_urb(0, GFP_KERNEL);\r\nif (!entry) {\r\nret = -ENOMEM;\r\ngoto err;\r\n}\r\nusb_fill_bulk_urb(entry, priv->udev,\r\nusb_rcvbulkpipe(priv->udev, P54U_PIPE_DATA),\r\nskb_tail_pointer(skb),\r\npriv->common.rx_mtu + 32, p54u_rx_cb, skb);\r\ninfo = (struct p54u_rx_info *) skb->cb;\r\ninfo->urb = entry;\r\ninfo->dev = dev;\r\nskb_queue_tail(&priv->rx_queue, skb);\r\nusb_anchor_urb(entry, &priv->submitted);\r\nret = usb_submit_urb(entry, GFP_KERNEL);\r\nif (ret) {\r\nskb_unlink(skb, &priv->rx_queue);\r\nusb_unanchor_urb(entry);\r\ngoto err;\r\n}\r\nusb_free_urb(entry);\r\nentry = NULL;\r\n}\r\nreturn 0;\r\nerr:\r\nusb_free_urb(entry);\r\nkfree_skb(skb);\r\np54u_free_urbs(dev);\r\nreturn ret;\r\n}\r\nstatic int p54u_open(struct ieee80211_hw *dev)\r\n{\r\nreturn p54u_init_urbs(dev);\r\n}\r\nstatic __le32 p54u_lm87_chksum(const __le32 *data, size_t length)\r\n{\r\nu32 chk = 0;\r\nlength >>= 2;\r\nwhile (length--) {\r\nchk ^= le32_to_cpu(*data++);\r\nchk = (chk >> 5) ^ (chk << 3);\r\n}\r\nreturn cpu_to_le32(chk);\r\n}\r\nstatic void p54u_tx_lm87(struct ieee80211_hw *dev, struct sk_buff *skb)\r\n{\r\nstruct p54u_priv *priv = dev->priv;\r\nstruct urb *data_urb;\r\nstruct lm87_tx_hdr *hdr = (void *)skb->data - sizeof(*hdr);\r\ndata_urb = usb_alloc_urb(0, GFP_ATOMIC);\r\nif (!data_urb) {\r\np54_free_skb(dev, skb);\r\nreturn;\r\n}\r\nhdr->chksum = p54u_lm87_chksum((__le32 *)skb->data, skb->len);\r\nhdr->device_addr = ((struct p54_hdr *)skb->data)->req_id;\r\nusb_fill_bulk_urb(data_urb, priv->udev,\r\nusb_sndbulkpipe(priv->udev, P54U_PIPE_DATA),\r\nhdr, skb->len + sizeof(*hdr), FREE_AFTER_TX(skb) ?\r\np54u_tx_cb : p54u_tx_dummy_cb, skb);\r\ndata_urb->transfer_flags |= URB_ZERO_PACKET;\r\nusb_anchor_urb(data_urb, &priv->submitted);\r\nif (usb_submit_urb(data_urb, GFP_ATOMIC)) {\r\nusb_unanchor_urb(data_urb);\r\np54_free_skb(dev, skb);\r\n}\r\nusb_free_urb(data_urb);\r\n}\r\nstatic void p54u_tx_net2280(struct ieee80211_hw *dev, struct sk_buff *skb)\r\n{\r\nstruct p54u_priv *priv = dev->priv;\r\nstruct urb *int_urb = NULL, *data_urb = NULL;\r\nstruct net2280_tx_hdr *hdr = (void *)skb->data - sizeof(*hdr);\r\nstruct net2280_reg_write *reg = NULL;\r\nint err = -ENOMEM;\r\nreg = kmalloc(sizeof(*reg), GFP_ATOMIC);\r\nif (!reg)\r\ngoto out;\r\nint_urb = usb_alloc_urb(0, GFP_ATOMIC);\r\nif (!int_urb)\r\ngoto out;\r\ndata_urb = usb_alloc_urb(0, GFP_ATOMIC);\r\nif (!data_urb)\r\ngoto out;\r\nreg->port = cpu_to_le16(NET2280_DEV_U32);\r\nreg->addr = cpu_to_le32(P54U_DEV_BASE);\r\nreg->val = cpu_to_le32(ISL38XX_DEV_INT_DATA);\r\nmemset(hdr, 0, sizeof(*hdr));\r\nhdr->len = cpu_to_le16(skb->len);\r\nhdr->device_addr = ((struct p54_hdr *) skb->data)->req_id;\r\nusb_fill_bulk_urb(int_urb, priv->udev,\r\nusb_sndbulkpipe(priv->udev, P54U_PIPE_DEV), reg, sizeof(*reg),\r\np54u_tx_dummy_cb, dev);\r\nint_urb->transfer_flags |= URB_FREE_BUFFER | URB_ZERO_PACKET;\r\nreg = NULL;\r\nusb_fill_bulk_urb(data_urb, priv->udev,\r\nusb_sndbulkpipe(priv->udev, P54U_PIPE_DATA),\r\nhdr, skb->len + sizeof(*hdr), FREE_AFTER_TX(skb) ?\r\np54u_tx_cb : p54u_tx_dummy_cb, skb);\r\ndata_urb->transfer_flags |= URB_ZERO_PACKET;\r\nusb_anchor_urb(int_urb, &priv->submitted);\r\nerr = usb_submit_urb(int_urb, GFP_ATOMIC);\r\nif (err) {\r\nusb_unanchor_urb(int_urb);\r\ngoto out;\r\n}\r\nusb_anchor_urb(data_urb, &priv->submitted);\r\nerr = usb_submit_urb(data_urb, GFP_ATOMIC);\r\nif (err) {\r\nusb_unanchor_urb(data_urb);\r\ngoto out;\r\n}\r\nout:\r\nusb_free_urb(int_urb);\r\nusb_free_urb(data_urb);\r\nif (err) {\r\nkfree(reg);\r\np54_free_skb(dev, skb);\r\n}\r\n}\r\nstatic int p54u_write(struct p54u_priv *priv,\r\nstruct net2280_reg_write *buf,\r\nenum net2280_op_type type,\r\n__le32 addr, __le32 val)\r\n{\r\nunsigned int ep;\r\nint alen;\r\nif (type & 0x0800)\r\nep = usb_sndbulkpipe(priv->udev, P54U_PIPE_DEV);\r\nelse\r\nep = usb_sndbulkpipe(priv->udev, P54U_PIPE_BRG);\r\nbuf->port = cpu_to_le16(type);\r\nbuf->addr = addr;\r\nbuf->val = val;\r\nreturn usb_bulk_msg(priv->udev, ep, buf, sizeof(*buf), &alen, 1000);\r\n}\r\nstatic int p54u_read(struct p54u_priv *priv, void *buf,\r\nenum net2280_op_type type,\r\n__le32 addr, __le32 *val)\r\n{\r\nstruct net2280_reg_read *read = buf;\r\n__le32 *reg = buf;\r\nunsigned int ep;\r\nint alen, err;\r\nif (type & 0x0800)\r\nep = P54U_PIPE_DEV;\r\nelse\r\nep = P54U_PIPE_BRG;\r\nread->port = cpu_to_le16(type);\r\nread->addr = addr;\r\nerr = usb_bulk_msg(priv->udev, usb_sndbulkpipe(priv->udev, ep),\r\nread, sizeof(*read), &alen, 1000);\r\nif (err)\r\nreturn err;\r\nerr = usb_bulk_msg(priv->udev, usb_rcvbulkpipe(priv->udev, ep),\r\nreg, sizeof(*reg), &alen, 1000);\r\nif (err)\r\nreturn err;\r\n*val = *reg;\r\nreturn 0;\r\n}\r\nstatic int p54u_bulk_msg(struct p54u_priv *priv, unsigned int ep,\r\nvoid *data, size_t len)\r\n{\r\nint alen;\r\nreturn usb_bulk_msg(priv->udev, usb_sndbulkpipe(priv->udev, ep),\r\ndata, len, &alen, 2000);\r\n}\r\nstatic int p54u_device_reset(struct ieee80211_hw *dev)\r\n{\r\nstruct p54u_priv *priv = dev->priv;\r\nint ret, lock = (priv->intf->condition != USB_INTERFACE_BINDING);\r\nif (lock) {\r\nret = usb_lock_device_for_reset(priv->udev, priv->intf);\r\nif (ret < 0) {\r\ndev_err(&priv->udev->dev, "(p54usb) unable to lock "\r\n"device for reset (%d)!\n", ret);\r\nreturn ret;\r\n}\r\n}\r\nret = usb_reset_device(priv->udev);\r\nif (lock)\r\nusb_unlock_device(priv->udev);\r\nif (ret)\r\ndev_err(&priv->udev->dev, "(p54usb) unable to reset "\r\n"device (%d)!\n", ret);\r\nreturn ret;\r\n}\r\nstatic int p54u_firmware_reset_3887(struct ieee80211_hw *dev)\r\n{\r\nstruct p54u_priv *priv = dev->priv;\r\nu8 *buf;\r\nint ret;\r\nbuf = kmemdup(p54u_romboot_3887, 4, GFP_KERNEL);\r\nif (!buf)\r\nreturn -ENOMEM;\r\nret = p54u_bulk_msg(priv, P54U_PIPE_DATA,\r\nbuf, 4);\r\nkfree(buf);\r\nif (ret)\r\ndev_err(&priv->udev->dev, "(p54usb) unable to jump to "\r\n"boot ROM (%d)!\n", ret);\r\nreturn ret;\r\n}\r\nstatic int p54u_upload_firmware_3887(struct ieee80211_hw *dev)\r\n{\r\nstruct p54u_priv *priv = dev->priv;\r\nint err, alen;\r\nu8 carry = 0;\r\nu8 *buf, *tmp;\r\nconst u8 *data;\r\nunsigned int left, remains, block_size;\r\nstruct x2_header *hdr;\r\nunsigned long timeout;\r\nerr = p54u_firmware_reset_3887(dev);\r\nif (err)\r\nreturn err;\r\ntmp = buf = kmalloc(P54U_FW_BLOCK, GFP_KERNEL);\r\nif (!buf)\r\nreturn -ENOMEM;\r\nleft = block_size = min((size_t)P54U_FW_BLOCK, priv->fw->size);\r\nstrcpy(buf, p54u_firmware_upload_3887);\r\nleft -= strlen(p54u_firmware_upload_3887);\r\ntmp += strlen(p54u_firmware_upload_3887);\r\ndata = priv->fw->data;\r\nremains = priv->fw->size;\r\nhdr = (struct x2_header *)(buf + strlen(p54u_firmware_upload_3887));\r\nmemcpy(hdr->signature, X2_SIGNATURE, X2_SIGNATURE_SIZE);\r\nhdr->fw_load_addr = cpu_to_le32(ISL38XX_DEV_FIRMWARE_ADDR);\r\nhdr->fw_length = cpu_to_le32(priv->fw->size);\r\nhdr->crc = cpu_to_le32(~crc32_le(~0, (void *)&hdr->fw_load_addr,\r\nsizeof(u32)*2));\r\nleft -= sizeof(*hdr);\r\ntmp += sizeof(*hdr);\r\nwhile (remains) {\r\nwhile (left--) {\r\nif (carry) {\r\n*tmp++ = carry;\r\ncarry = 0;\r\nremains--;\r\ncontinue;\r\n}\r\nswitch (*data) {\r\ncase '~':\r\n*tmp++ = '}';\r\ncarry = '^';\r\nbreak;\r\ncase '}':\r\n*tmp++ = '}';\r\ncarry = ']';\r\nbreak;\r\ndefault:\r\n*tmp++ = *data;\r\nremains--;\r\nbreak;\r\n}\r\ndata++;\r\n}\r\nerr = p54u_bulk_msg(priv, P54U_PIPE_DATA, buf, block_size);\r\nif (err) {\r\ndev_err(&priv->udev->dev, "(p54usb) firmware "\r\n"upload failed!\n");\r\ngoto err_upload_failed;\r\n}\r\ntmp = buf;\r\nleft = block_size = min((unsigned int)P54U_FW_BLOCK, remains);\r\n}\r\n*((__le32 *)buf) = cpu_to_le32(~crc32_le(~0, priv->fw->data,\r\npriv->fw->size));\r\nerr = p54u_bulk_msg(priv, P54U_PIPE_DATA, buf, sizeof(u32));\r\nif (err) {\r\ndev_err(&priv->udev->dev, "(p54usb) firmware upload failed!\n");\r\ngoto err_upload_failed;\r\n}\r\ntimeout = jiffies + msecs_to_jiffies(1000);\r\nwhile (!(err = usb_bulk_msg(priv->udev,\r\nusb_rcvbulkpipe(priv->udev, P54U_PIPE_DATA), buf, 128, &alen, 1000))) {\r\nif (alen > 2 && !memcmp(buf, "OK", 2))\r\nbreak;\r\nif (alen > 5 && !memcmp(buf, "ERROR", 5)) {\r\nerr = -EINVAL;\r\nbreak;\r\n}\r\nif (time_after(jiffies, timeout)) {\r\ndev_err(&priv->udev->dev, "(p54usb) firmware boot "\r\n"timed out!\n");\r\nerr = -ETIMEDOUT;\r\nbreak;\r\n}\r\n}\r\nif (err) {\r\ndev_err(&priv->udev->dev, "(p54usb) firmware upload failed!\n");\r\ngoto err_upload_failed;\r\n}\r\nbuf[0] = 'g';\r\nbuf[1] = '\r';\r\nerr = p54u_bulk_msg(priv, P54U_PIPE_DATA, buf, 2);\r\nif (err) {\r\ndev_err(&priv->udev->dev, "(p54usb) firmware boot failed!\n");\r\ngoto err_upload_failed;\r\n}\r\ntimeout = jiffies + msecs_to_jiffies(1000);\r\nwhile (!(err = usb_bulk_msg(priv->udev,\r\nusb_rcvbulkpipe(priv->udev, P54U_PIPE_DATA), buf, 128, &alen, 1000))) {\r\nif (alen > 0 && buf[0] == 'g')\r\nbreak;\r\nif (time_after(jiffies, timeout)) {\r\nerr = -ETIMEDOUT;\r\nbreak;\r\n}\r\n}\r\nif (err)\r\ngoto err_upload_failed;\r\nerr_upload_failed:\r\nkfree(buf);\r\nreturn err;\r\n}\r\nstatic int p54u_upload_firmware_net2280(struct ieee80211_hw *dev)\r\n{\r\nstruct p54u_priv *priv = dev->priv;\r\nconst struct p54p_csr *devreg = (const struct p54p_csr *) P54U_DEV_BASE;\r\nint err, alen;\r\nvoid *buf;\r\n__le32 reg;\r\nunsigned int remains, offset;\r\nconst u8 *data;\r\nbuf = kmalloc(512, GFP_KERNEL);\r\nif (!buf)\r\nreturn -ENOMEM;\r\n#define P54U_WRITE(type, addr, data) \\r\ndo {\\r\nerr = p54u_write(priv, buf, type,\\r\ncpu_to_le32((u32)(unsigned long)addr), data);\\r\nif (err) \\r\ngoto fail;\\r\n} while (0)\r\n#define P54U_READ(type, addr) \\r\ndo {\\r\nerr = p54u_read(priv, buf, type,\\r\ncpu_to_le32((u32)(unsigned long)addr), &reg);\\r\nif (err)\\r\ngoto fail;\\r\n} while (0)\r\nP54U_READ(NET2280_BRG_U32, NET2280_GPIOCTL);\r\nreg |= cpu_to_le32(P54U_BRG_POWER_DOWN);\r\nreg &= cpu_to_le32(~P54U_BRG_POWER_UP);\r\nP54U_WRITE(NET2280_BRG_U32, NET2280_GPIOCTL, reg);\r\nmdelay(100);\r\nreg |= cpu_to_le32(P54U_BRG_POWER_UP);\r\nreg &= cpu_to_le32(~P54U_BRG_POWER_DOWN);\r\nP54U_WRITE(NET2280_BRG_U32, NET2280_GPIOCTL, reg);\r\nmdelay(100);\r\nP54U_WRITE(NET2280_BRG_U32, NET2280_DEVINIT,\r\ncpu_to_le32(NET2280_CLK_30Mhz |\r\nNET2280_PCI_ENABLE |\r\nNET2280_PCI_SOFT_RESET));\r\nmdelay(20);\r\nP54U_WRITE(NET2280_BRG_CFG_U16, PCI_COMMAND,\r\ncpu_to_le32(PCI_COMMAND_MEMORY |\r\nPCI_COMMAND_MASTER));\r\nP54U_WRITE(NET2280_BRG_CFG_U32, PCI_BASE_ADDRESS_0,\r\ncpu_to_le32(NET2280_BASE));\r\nP54U_READ(NET2280_BRG_CFG_U16, PCI_STATUS);\r\nreg |= cpu_to_le32(PCI_STATUS_REC_MASTER_ABORT);\r\nP54U_WRITE(NET2280_BRG_CFG_U16, PCI_STATUS, reg);\r\nP54U_READ(NET2280_BRG_U32, NET2280_RELNUM);\r\nP54U_WRITE(NET2280_BRG_U32, NET2280_EPA_RSP,\r\ncpu_to_le32(NET2280_CLEAR_NAK_OUT_PACKETS_MODE));\r\nP54U_WRITE(NET2280_BRG_U32, NET2280_EPC_RSP,\r\ncpu_to_le32(NET2280_CLEAR_NAK_OUT_PACKETS_MODE));\r\nP54U_WRITE(NET2280_BRG_CFG_U32, PCI_BASE_ADDRESS_2,\r\ncpu_to_le32(NET2280_BASE2));\r\nP54U_WRITE(NET2280_DEV_CFG_U16, 0x10000 | PCI_COMMAND,\r\ncpu_to_le32(PCI_COMMAND_MEMORY |\r\nPCI_COMMAND_MASTER));\r\nP54U_WRITE(NET2280_DEV_CFG_U16, 0x10000 | 0x40 , 0);\r\nP54U_WRITE(NET2280_DEV_CFG_U32, 0x10000 | PCI_BASE_ADDRESS_0,\r\ncpu_to_le32(P54U_DEV_BASE));\r\nP54U_WRITE(NET2280_BRG_U32, NET2280_USBIRQENB1, 0);\r\nP54U_WRITE(NET2280_BRG_U32, NET2280_IRQSTAT1,\r\ncpu_to_le32(NET2280_PCI_INTA_INTERRUPT));\r\nP54U_WRITE(NET2280_DEV_U32, &devreg->int_enable, 0);\r\nP54U_READ(NET2280_DEV_U32, &devreg->ctrl_stat);\r\nreg &= cpu_to_le32(~ISL38XX_CTRL_STAT_RESET);\r\nreg &= cpu_to_le32(~ISL38XX_CTRL_STAT_RAMBOOT);\r\nreg &= cpu_to_le32(~ISL38XX_CTRL_STAT_CLKRUN);\r\nP54U_WRITE(NET2280_DEV_U32, &devreg->ctrl_stat, reg);\r\nmdelay(20);\r\nreg |= cpu_to_le32(ISL38XX_CTRL_STAT_RESET);\r\nP54U_WRITE(NET2280_DEV_U32, &devreg->ctrl_stat, reg);\r\nmdelay(20);\r\nreg &= cpu_to_le32(~ISL38XX_CTRL_STAT_RESET);\r\nP54U_WRITE(NET2280_DEV_U32, &devreg->ctrl_stat, reg);\r\nmdelay(100);\r\nP54U_READ(NET2280_DEV_U32, &devreg->int_ident);\r\nP54U_WRITE(NET2280_DEV_U32, &devreg->int_ack, reg);\r\nremains = priv->fw->size;\r\ndata = priv->fw->data;\r\noffset = ISL38XX_DEV_FIRMWARE_ADDR;\r\nwhile (remains) {\r\nunsigned int block_len = min(remains, (unsigned int)512);\r\nmemcpy(buf, data, block_len);\r\nerr = p54u_bulk_msg(priv, P54U_PIPE_DATA, buf, block_len);\r\nif (err) {\r\ndev_err(&priv->udev->dev, "(p54usb) firmware block "\r\n"upload failed\n");\r\ngoto fail;\r\n}\r\nP54U_WRITE(NET2280_DEV_U32, &devreg->direct_mem_base,\r\ncpu_to_le32(0xc0000f00));\r\nP54U_WRITE(NET2280_DEV_U32,\r\n0x0020 | (unsigned long)&devreg->direct_mem_win, 0);\r\nP54U_WRITE(NET2280_DEV_U32,\r\n0x0020 | (unsigned long)&devreg->direct_mem_win,\r\ncpu_to_le32(1));\r\nP54U_WRITE(NET2280_DEV_U32,\r\n0x0024 | (unsigned long)&devreg->direct_mem_win,\r\ncpu_to_le32(block_len));\r\nP54U_WRITE(NET2280_DEV_U32,\r\n0x0028 | (unsigned long)&devreg->direct_mem_win,\r\ncpu_to_le32(offset));\r\nP54U_WRITE(NET2280_DEV_U32, &devreg->dma_addr,\r\ncpu_to_le32(NET2280_EPA_FIFO_PCI_ADDR));\r\nP54U_WRITE(NET2280_DEV_U32, &devreg->dma_len,\r\ncpu_to_le32(block_len >> 2));\r\nP54U_WRITE(NET2280_DEV_U32, &devreg->dma_ctrl,\r\ncpu_to_le32(ISL38XX_DMA_MASTER_CONTROL_TRIGGER));\r\nmdelay(10);\r\nP54U_READ(NET2280_DEV_U32,\r\n0x002C | (unsigned long)&devreg->direct_mem_win);\r\nif (!(reg & cpu_to_le32(ISL38XX_DMA_STATUS_DONE)) ||\r\n!(reg & cpu_to_le32(ISL38XX_DMA_STATUS_READY))) {\r\ndev_err(&priv->udev->dev, "(p54usb) firmware DMA "\r\n"transfer failed\n");\r\ngoto fail;\r\n}\r\nP54U_WRITE(NET2280_BRG_U32, NET2280_EPA_STAT,\r\ncpu_to_le32(NET2280_FIFO_FLUSH));\r\nremains -= block_len;\r\ndata += block_len;\r\noffset += block_len;\r\n}\r\nP54U_READ(NET2280_DEV_U32, &devreg->ctrl_stat);\r\nreg &= cpu_to_le32(~ISL38XX_CTRL_STAT_RESET);\r\nreg &= cpu_to_le32(~ISL38XX_CTRL_STAT_CLKRUN);\r\nreg |= cpu_to_le32(ISL38XX_CTRL_STAT_RAMBOOT);\r\nP54U_WRITE(NET2280_DEV_U32, &devreg->ctrl_stat, reg);\r\nmdelay(20);\r\nreg |= cpu_to_le32(ISL38XX_CTRL_STAT_RESET);\r\nP54U_WRITE(NET2280_DEV_U32, &devreg->ctrl_stat, reg);\r\nreg &= cpu_to_le32(~ISL38XX_CTRL_STAT_RESET);\r\nP54U_WRITE(NET2280_DEV_U32, &devreg->ctrl_stat, reg);\r\nmdelay(100);\r\nP54U_READ(NET2280_DEV_U32, &devreg->int_ident);\r\nP54U_WRITE(NET2280_DEV_U32, &devreg->int_ack, reg);\r\nP54U_WRITE(NET2280_DEV_U32, &devreg->int_enable,\r\ncpu_to_le32(ISL38XX_INT_IDENT_INIT));\r\nP54U_WRITE(NET2280_BRG_U32, NET2280_IRQSTAT1,\r\ncpu_to_le32(NET2280_PCI_INTA_INTERRUPT));\r\nP54U_WRITE(NET2280_BRG_U32, NET2280_USBIRQENB1,\r\ncpu_to_le32(NET2280_PCI_INTA_INTERRUPT_ENABLE |\r\nNET2280_USB_INTERRUPT_ENABLE));\r\nP54U_WRITE(NET2280_DEV_U32, &devreg->dev_int,\r\ncpu_to_le32(ISL38XX_DEV_INT_RESET));\r\nerr = usb_interrupt_msg(priv->udev,\r\nusb_rcvbulkpipe(priv->udev, P54U_PIPE_INT),\r\nbuf, sizeof(__le32), &alen, 1000);\r\nif (err || alen != sizeof(__le32))\r\ngoto fail;\r\nP54U_READ(NET2280_DEV_U32, &devreg->int_ident);\r\nP54U_WRITE(NET2280_DEV_U32, &devreg->int_ack, reg);\r\nif (!(reg & cpu_to_le32(ISL38XX_INT_IDENT_INIT)))\r\nerr = -EINVAL;\r\nP54U_WRITE(NET2280_BRG_U32, NET2280_USBIRQENB1, 0);\r\nP54U_WRITE(NET2280_BRG_U32, NET2280_IRQSTAT1,\r\ncpu_to_le32(NET2280_PCI_INTA_INTERRUPT));\r\n#undef P54U_WRITE\r\n#undef P54U_READ\r\nfail:\r\nkfree(buf);\r\nreturn err;\r\n}\r\nstatic int p54_find_type(struct p54u_priv *priv)\r\n{\r\nint i;\r\nfor (i = 0; i < __NUM_P54U_HWTYPES; i++)\r\nif (p54u_fwlist[i].type == priv->hw_type)\r\nbreak;\r\nif (i == __NUM_P54U_HWTYPES)\r\nreturn -EOPNOTSUPP;\r\nreturn i;\r\n}\r\nstatic int p54u_start_ops(struct p54u_priv *priv)\r\n{\r\nstruct ieee80211_hw *dev = priv->common.hw;\r\nint ret;\r\nret = p54_parse_firmware(dev, priv->fw);\r\nif (ret)\r\ngoto err_out;\r\nret = p54_find_type(priv);\r\nif (ret < 0)\r\ngoto err_out;\r\nif (priv->common.fw_interface != p54u_fwlist[ret].intf) {\r\ndev_err(&priv->udev->dev, "wrong firmware, please get "\r\n"a firmware for \"%s\" and try again.\n",\r\np54u_fwlist[ret].hw);\r\nret = -ENODEV;\r\ngoto err_out;\r\n}\r\nret = priv->upload_fw(dev);\r\nif (ret)\r\ngoto err_out;\r\nret = p54u_open(dev);\r\nif (ret)\r\ngoto err_out;\r\nret = p54_read_eeprom(dev);\r\nif (ret)\r\ngoto err_stop;\r\np54u_stop(dev);\r\nret = p54_register_common(dev, &priv->udev->dev);\r\nif (ret)\r\ngoto err_stop;\r\nreturn 0;\r\nerr_stop:\r\np54u_stop(dev);\r\nerr_out:\r\nreturn ret;\r\n}\r\nstatic void p54u_load_firmware_cb(const struct firmware *firmware,\r\nvoid *context)\r\n{\r\nstruct p54u_priv *priv = context;\r\nstruct usb_device *udev = priv->udev;\r\nint err;\r\ncomplete(&priv->fw_wait_load);\r\nif (firmware) {\r\npriv->fw = firmware;\r\nerr = p54u_start_ops(priv);\r\n} else {\r\nerr = -ENOENT;\r\ndev_err(&udev->dev, "Firmware not found.\n");\r\n}\r\nif (err) {\r\nstruct device *parent = priv->udev->dev.parent;\r\ndev_err(&udev->dev, "failed to initialize device (%d)\n", err);\r\nif (parent)\r\ndevice_lock(parent);\r\ndevice_release_driver(&udev->dev);\r\npriv = NULL;\r\nif (parent)\r\ndevice_unlock(parent);\r\n}\r\nusb_put_dev(udev);\r\n}\r\nstatic int p54u_load_firmware(struct ieee80211_hw *dev,\r\nstruct usb_interface *intf)\r\n{\r\nstruct usb_device *udev = interface_to_usbdev(intf);\r\nstruct p54u_priv *priv = dev->priv;\r\nstruct device *device = &udev->dev;\r\nint err, i;\r\nBUILD_BUG_ON(ARRAY_SIZE(p54u_fwlist) != __NUM_P54U_HWTYPES);\r\ninit_completion(&priv->fw_wait_load);\r\ni = p54_find_type(priv);\r\nif (i < 0)\r\nreturn i;\r\ndev_info(&priv->udev->dev, "Loading firmware file %s\n",\r\np54u_fwlist[i].fw);\r\nusb_get_dev(udev);\r\nerr = request_firmware_nowait(THIS_MODULE, 1, p54u_fwlist[i].fw,\r\ndevice, GFP_KERNEL, priv,\r\np54u_load_firmware_cb);\r\nif (err) {\r\ndev_err(&priv->udev->dev, "(p54usb) cannot load firmware %s "\r\n"(%d)!\n", p54u_fwlist[i].fw, err);\r\n}\r\nreturn err;\r\n}\r\nstatic int p54u_probe(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct usb_device *udev = interface_to_usbdev(intf);\r\nstruct ieee80211_hw *dev;\r\nstruct p54u_priv *priv;\r\nint err;\r\nunsigned int i, recognized_pipes;\r\ndev = p54_init_common(sizeof(*priv));\r\nif (!dev) {\r\ndev_err(&udev->dev, "(p54usb) ieee80211 alloc failed\n");\r\nreturn -ENOMEM;\r\n}\r\npriv = dev->priv;\r\npriv->hw_type = P54U_INVALID_HW;\r\nSET_IEEE80211_DEV(dev, &intf->dev);\r\nusb_set_intfdata(intf, dev);\r\npriv->udev = udev;\r\npriv->intf = intf;\r\nskb_queue_head_init(&priv->rx_queue);\r\ninit_usb_anchor(&priv->submitted);\r\nusb_get_dev(udev);\r\ni = intf->altsetting->desc.bNumEndpoints;\r\nrecognized_pipes = 0;\r\nwhile (i--) {\r\nswitch (intf->altsetting->endpoint[i].desc.bEndpointAddress) {\r\ncase P54U_PIPE_DATA:\r\ncase P54U_PIPE_MGMT:\r\ncase P54U_PIPE_BRG:\r\ncase P54U_PIPE_DEV:\r\ncase P54U_PIPE_DATA | USB_DIR_IN:\r\ncase P54U_PIPE_MGMT | USB_DIR_IN:\r\ncase P54U_PIPE_BRG | USB_DIR_IN:\r\ncase P54U_PIPE_DEV | USB_DIR_IN:\r\ncase P54U_PIPE_INT | USB_DIR_IN:\r\nrecognized_pipes++;\r\n}\r\n}\r\npriv->common.open = p54u_open;\r\npriv->common.stop = p54u_stop;\r\nif (recognized_pipes < P54U_PIPE_NUMBER) {\r\n#ifdef CONFIG_PM\r\nudev->reset_resume = 1;\r\n#endif\r\nerr = p54u_device_reset(dev);\r\npriv->hw_type = P54U_3887;\r\ndev->extra_tx_headroom += sizeof(struct lm87_tx_hdr);\r\npriv->common.tx_hdr_len = sizeof(struct lm87_tx_hdr);\r\npriv->common.tx = p54u_tx_lm87;\r\npriv->upload_fw = p54u_upload_firmware_3887;\r\n} else {\r\npriv->hw_type = P54U_NET2280;\r\ndev->extra_tx_headroom += sizeof(struct net2280_tx_hdr);\r\npriv->common.tx_hdr_len = sizeof(struct net2280_tx_hdr);\r\npriv->common.tx = p54u_tx_net2280;\r\npriv->upload_fw = p54u_upload_firmware_net2280;\r\n}\r\nerr = p54u_load_firmware(dev, intf);\r\nreturn err;\r\n}\r\nstatic void p54u_disconnect(struct usb_interface *intf)\r\n{\r\nstruct ieee80211_hw *dev = usb_get_intfdata(intf);\r\nstruct p54u_priv *priv;\r\nif (!dev)\r\nreturn;\r\npriv = dev->priv;\r\nwait_for_completion(&priv->fw_wait_load);\r\np54_unregister_common(dev);\r\nusb_put_dev(interface_to_usbdev(intf));\r\nrelease_firmware(priv->fw);\r\np54_free_common(dev);\r\n}\r\nstatic int p54u_pre_reset(struct usb_interface *intf)\r\n{\r\nstruct ieee80211_hw *dev = usb_get_intfdata(intf);\r\nif (!dev)\r\nreturn -ENODEV;\r\np54u_stop(dev);\r\nreturn 0;\r\n}\r\nstatic int p54u_resume(struct usb_interface *intf)\r\n{\r\nstruct ieee80211_hw *dev = usb_get_intfdata(intf);\r\nstruct p54u_priv *priv;\r\nif (!dev)\r\nreturn -ENODEV;\r\npriv = dev->priv;\r\nif (unlikely(!(priv->upload_fw && priv->fw)))\r\nreturn 0;\r\nreturn priv->upload_fw(dev);\r\n}\r\nstatic int p54u_post_reset(struct usb_interface *intf)\r\n{\r\nstruct ieee80211_hw *dev = usb_get_intfdata(intf);\r\nstruct p54u_priv *priv;\r\nint err;\r\nerr = p54u_resume(intf);\r\nif (err)\r\nreturn err;\r\npriv = dev->priv;\r\nif (priv->common.mode != NL80211_IFTYPE_UNSPECIFIED)\r\nieee80211_restart_hw(dev);\r\nreturn 0;\r\n}\r\nstatic int p54u_suspend(struct usb_interface *intf, pm_message_t message)\r\n{\r\nreturn p54u_pre_reset(intf);\r\n}

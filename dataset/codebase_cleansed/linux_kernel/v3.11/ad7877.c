static int ad7877_read(struct spi_device *spi, u16 reg)\r\n{\r\nstruct ser_req *req;\r\nint status, ret;\r\nreq = kzalloc(sizeof *req, GFP_KERNEL);\r\nif (!req)\r\nreturn -ENOMEM;\r\nspi_message_init(&req->msg);\r\nreq->command = (u16) (AD7877_WRITEADD(AD7877_REG_CTRL1) |\r\nAD7877_READADD(reg));\r\nreq->xfer[0].tx_buf = &req->command;\r\nreq->xfer[0].len = 2;\r\nreq->xfer[0].cs_change = 1;\r\nreq->xfer[1].rx_buf = &req->sample;\r\nreq->xfer[1].len = 2;\r\nspi_message_add_tail(&req->xfer[0], &req->msg);\r\nspi_message_add_tail(&req->xfer[1], &req->msg);\r\nstatus = spi_sync(spi, &req->msg);\r\nret = status ? : req->sample;\r\nkfree(req);\r\nreturn ret;\r\n}\r\nstatic int ad7877_write(struct spi_device *spi, u16 reg, u16 val)\r\n{\r\nstruct ser_req *req;\r\nint status;\r\nreq = kzalloc(sizeof *req, GFP_KERNEL);\r\nif (!req)\r\nreturn -ENOMEM;\r\nspi_message_init(&req->msg);\r\nreq->command = (u16) (AD7877_WRITEADD(reg) | (val & MAX_12BIT));\r\nreq->xfer[0].tx_buf = &req->command;\r\nreq->xfer[0].len = 2;\r\nspi_message_add_tail(&req->xfer[0], &req->msg);\r\nstatus = spi_sync(spi, &req->msg);\r\nkfree(req);\r\nreturn status;\r\n}\r\nstatic int ad7877_read_adc(struct spi_device *spi, unsigned command)\r\n{\r\nstruct ad7877 *ts = spi_get_drvdata(spi);\r\nstruct ser_req *req;\r\nint status;\r\nint sample;\r\nint i;\r\nreq = kzalloc(sizeof *req, GFP_KERNEL);\r\nif (!req)\r\nreturn -ENOMEM;\r\nspi_message_init(&req->msg);\r\nreq->ref_on = AD7877_WRITEADD(AD7877_REG_CTRL2) |\r\nAD7877_POL(ts->stopacq_polarity) |\r\nAD7877_AVG(0) | AD7877_PM(2) | AD7877_TMR(0) |\r\nAD7877_ACQ(ts->acquisition_time) | AD7877_FCD(0);\r\nreq->reset = AD7877_WRITEADD(AD7877_REG_CTRL1) | AD7877_MODE_NOC;\r\nreq->command = (u16) command;\r\nreq->xfer[0].tx_buf = &req->reset;\r\nreq->xfer[0].len = 2;\r\nreq->xfer[0].cs_change = 1;\r\nreq->xfer[1].tx_buf = &req->ref_on;\r\nreq->xfer[1].len = 2;\r\nreq->xfer[1].delay_usecs = ts->vref_delay_usecs;\r\nreq->xfer[1].cs_change = 1;\r\nreq->xfer[2].tx_buf = &req->command;\r\nreq->xfer[2].len = 2;\r\nreq->xfer[2].delay_usecs = ts->vref_delay_usecs;\r\nreq->xfer[2].cs_change = 1;\r\nreq->xfer[3].rx_buf = &req->sample;\r\nreq->xfer[3].len = 2;\r\nreq->xfer[3].cs_change = 1;\r\nreq->xfer[4].tx_buf = &ts->cmd_crtl2;\r\nreq->xfer[4].len = 2;\r\nreq->xfer[4].cs_change = 1;\r\nreq->xfer[5].tx_buf = &ts->cmd_crtl1;\r\nreq->xfer[5].len = 2;\r\nfor (i = 0; i < 6; i++)\r\nspi_message_add_tail(&req->xfer[i], &req->msg);\r\nstatus = spi_sync(spi, &req->msg);\r\nsample = req->sample;\r\nkfree(req);\r\nreturn status ? : sample;\r\n}\r\nstatic int ad7877_process_data(struct ad7877 *ts)\r\n{\r\nstruct input_dev *input_dev = ts->input;\r\nunsigned Rt;\r\nu16 x, y, z1, z2;\r\nx = ts->conversion_data[AD7877_SEQ_XPOS] & MAX_12BIT;\r\ny = ts->conversion_data[AD7877_SEQ_YPOS] & MAX_12BIT;\r\nz1 = ts->conversion_data[AD7877_SEQ_Z1] & MAX_12BIT;\r\nz2 = ts->conversion_data[AD7877_SEQ_Z2] & MAX_12BIT;\r\nif (likely(x && z1)) {\r\nRt = (z2 - z1) * x * ts->x_plate_ohms;\r\nRt /= z1;\r\nRt = (Rt + 2047) >> 12;\r\nif (Rt > ts->pressure_max)\r\nreturn -EINVAL;\r\nif (!timer_pending(&ts->timer))\r\ninput_report_key(input_dev, BTN_TOUCH, 1);\r\ninput_report_abs(input_dev, ABS_X, x);\r\ninput_report_abs(input_dev, ABS_Y, y);\r\ninput_report_abs(input_dev, ABS_PRESSURE, Rt);\r\ninput_sync(input_dev);\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic inline void ad7877_ts_event_release(struct ad7877 *ts)\r\n{\r\nstruct input_dev *input_dev = ts->input;\r\ninput_report_abs(input_dev, ABS_PRESSURE, 0);\r\ninput_report_key(input_dev, BTN_TOUCH, 0);\r\ninput_sync(input_dev);\r\n}\r\nstatic void ad7877_timer(unsigned long handle)\r\n{\r\nstruct ad7877 *ts = (void *)handle;\r\nunsigned long flags;\r\nspin_lock_irqsave(&ts->lock, flags);\r\nad7877_ts_event_release(ts);\r\nspin_unlock_irqrestore(&ts->lock, flags);\r\n}\r\nstatic irqreturn_t ad7877_irq(int irq, void *handle)\r\n{\r\nstruct ad7877 *ts = handle;\r\nunsigned long flags;\r\nint error;\r\nerror = spi_sync(ts->spi, &ts->msg);\r\nif (error) {\r\ndev_err(&ts->spi->dev, "spi_sync --> %d\n", error);\r\ngoto out;\r\n}\r\nspin_lock_irqsave(&ts->lock, flags);\r\nerror = ad7877_process_data(ts);\r\nif (!error)\r\nmod_timer(&ts->timer, jiffies + TS_PEN_UP_TIMEOUT);\r\nspin_unlock_irqrestore(&ts->lock, flags);\r\nout:\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void ad7877_disable(struct ad7877 *ts)\r\n{\r\nmutex_lock(&ts->mutex);\r\nif (!ts->disabled) {\r\nts->disabled = true;\r\ndisable_irq(ts->spi->irq);\r\nif (del_timer_sync(&ts->timer))\r\nad7877_ts_event_release(ts);\r\n}\r\nmutex_unlock(&ts->mutex);\r\n}\r\nstatic void ad7877_enable(struct ad7877 *ts)\r\n{\r\nmutex_lock(&ts->mutex);\r\nif (ts->disabled) {\r\nts->disabled = false;\r\nenable_irq(ts->spi->irq);\r\n}\r\nmutex_unlock(&ts->mutex);\r\n}\r\nstatic ssize_t ad7877_disable_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct ad7877 *ts = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%u\n", ts->disabled);\r\n}\r\nstatic ssize_t ad7877_disable_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct ad7877 *ts = dev_get_drvdata(dev);\r\nunsigned int val;\r\nint error;\r\nerror = kstrtouint(buf, 10, &val);\r\nif (error)\r\nreturn error;\r\nif (val)\r\nad7877_disable(ts);\r\nelse\r\nad7877_enable(ts);\r\nreturn count;\r\n}\r\nstatic ssize_t ad7877_dac_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct ad7877 *ts = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%u\n", ts->dac);\r\n}\r\nstatic ssize_t ad7877_dac_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct ad7877 *ts = dev_get_drvdata(dev);\r\nunsigned int val;\r\nint error;\r\nerror = kstrtouint(buf, 10, &val);\r\nif (error)\r\nreturn error;\r\nmutex_lock(&ts->mutex);\r\nts->dac = val & 0xFF;\r\nad7877_write(ts->spi, AD7877_REG_DAC, (ts->dac << 4) | AD7877_DAC_CONF);\r\nmutex_unlock(&ts->mutex);\r\nreturn count;\r\n}\r\nstatic ssize_t ad7877_gpio3_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct ad7877 *ts = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%u\n", ts->gpio3);\r\n}\r\nstatic ssize_t ad7877_gpio3_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct ad7877 *ts = dev_get_drvdata(dev);\r\nunsigned int val;\r\nint error;\r\nerror = kstrtouint(buf, 10, &val);\r\nif (error)\r\nreturn error;\r\nmutex_lock(&ts->mutex);\r\nts->gpio3 = !!val;\r\nad7877_write(ts->spi, AD7877_REG_EXTWRITE, AD7877_EXTW_GPIO_DATA |\r\n(ts->gpio4 << 4) | (ts->gpio3 << 5));\r\nmutex_unlock(&ts->mutex);\r\nreturn count;\r\n}\r\nstatic ssize_t ad7877_gpio4_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct ad7877 *ts = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%u\n", ts->gpio4);\r\n}\r\nstatic ssize_t ad7877_gpio4_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct ad7877 *ts = dev_get_drvdata(dev);\r\nunsigned int val;\r\nint error;\r\nerror = kstrtouint(buf, 10, &val);\r\nif (error)\r\nreturn error;\r\nmutex_lock(&ts->mutex);\r\nts->gpio4 = !!val;\r\nad7877_write(ts->spi, AD7877_REG_EXTWRITE, AD7877_EXTW_GPIO_DATA |\r\n(ts->gpio4 << 4) | (ts->gpio3 << 5));\r\nmutex_unlock(&ts->mutex);\r\nreturn count;\r\n}\r\nstatic umode_t ad7877_attr_is_visible(struct kobject *kobj,\r\nstruct attribute *attr, int n)\r\n{\r\numode_t mode = attr->mode;\r\nif (attr == &dev_attr_aux3.attr) {\r\nif (gpio3)\r\nmode = 0;\r\n} else if (attr == &dev_attr_gpio3.attr) {\r\nif (!gpio3)\r\nmode = 0;\r\n}\r\nreturn mode;\r\n}\r\nstatic void ad7877_setup_ts_def_msg(struct spi_device *spi, struct ad7877 *ts)\r\n{\r\nstruct spi_message *m;\r\nint i;\r\nts->cmd_crtl2 = AD7877_WRITEADD(AD7877_REG_CTRL2) |\r\nAD7877_POL(ts->stopacq_polarity) |\r\nAD7877_AVG(ts->averaging) | AD7877_PM(1) |\r\nAD7877_TMR(ts->pen_down_acc_interval) |\r\nAD7877_ACQ(ts->acquisition_time) |\r\nAD7877_FCD(ts->first_conversion_delay);\r\nad7877_write(spi, AD7877_REG_CTRL2, ts->cmd_crtl2);\r\nts->cmd_crtl1 = AD7877_WRITEADD(AD7877_REG_CTRL1) |\r\nAD7877_READADD(AD7877_REG_XPLUS-1) |\r\nAD7877_MODE_SEQ1 | AD7877_DFR;\r\nad7877_write(spi, AD7877_REG_CTRL1, ts->cmd_crtl1);\r\nts->cmd_dummy = 0;\r\nm = &ts->msg;\r\nspi_message_init(m);\r\nm->context = ts;\r\nts->xfer[0].tx_buf = &ts->cmd_crtl1;\r\nts->xfer[0].len = 2;\r\nts->xfer[0].cs_change = 1;\r\nspi_message_add_tail(&ts->xfer[0], m);\r\nts->xfer[1].tx_buf = &ts->cmd_dummy;\r\nts->xfer[1].len = 2;\r\nts->xfer[1].cs_change = 1;\r\nspi_message_add_tail(&ts->xfer[1], m);\r\nfor (i = 0; i < AD7877_NR_SENSE; i++) {\r\nts->xfer[i + 2].rx_buf = &ts->conversion_data[AD7877_SEQ_YPOS + i];\r\nts->xfer[i + 2].len = 2;\r\nif (i < (AD7877_NR_SENSE - 1))\r\nts->xfer[i + 2].cs_change = 1;\r\nspi_message_add_tail(&ts->xfer[i + 2], m);\r\n}\r\n}\r\nstatic int ad7877_probe(struct spi_device *spi)\r\n{\r\nstruct ad7877 *ts;\r\nstruct input_dev *input_dev;\r\nstruct ad7877_platform_data *pdata = spi->dev.platform_data;\r\nint err;\r\nu16 verify;\r\nif (!spi->irq) {\r\ndev_dbg(&spi->dev, "no IRQ?\n");\r\nreturn -ENODEV;\r\n}\r\nif (!pdata) {\r\ndev_dbg(&spi->dev, "no platform data?\n");\r\nreturn -ENODEV;\r\n}\r\nif (spi->max_speed_hz > MAX_SPI_FREQ_HZ) {\r\ndev_dbg(&spi->dev, "SPI CLK %d Hz?\n",spi->max_speed_hz);\r\nreturn -EINVAL;\r\n}\r\nspi->bits_per_word = 16;\r\nerr = spi_setup(spi);\r\nif (err) {\r\ndev_dbg(&spi->dev, "spi master doesn't support 16 bits/word\n");\r\nreturn err;\r\n}\r\nts = kzalloc(sizeof(struct ad7877), GFP_KERNEL);\r\ninput_dev = input_allocate_device();\r\nif (!ts || !input_dev) {\r\nerr = -ENOMEM;\r\ngoto err_free_mem;\r\n}\r\nspi_set_drvdata(spi, ts);\r\nts->spi = spi;\r\nts->input = input_dev;\r\nsetup_timer(&ts->timer, ad7877_timer, (unsigned long) ts);\r\nmutex_init(&ts->mutex);\r\nspin_lock_init(&ts->lock);\r\nts->model = pdata->model ? : 7877;\r\nts->vref_delay_usecs = pdata->vref_delay_usecs ? : 100;\r\nts->x_plate_ohms = pdata->x_plate_ohms ? : 400;\r\nts->pressure_max = pdata->pressure_max ? : ~0;\r\nts->stopacq_polarity = pdata->stopacq_polarity;\r\nts->first_conversion_delay = pdata->first_conversion_delay;\r\nts->acquisition_time = pdata->acquisition_time;\r\nts->averaging = pdata->averaging;\r\nts->pen_down_acc_interval = pdata->pen_down_acc_interval;\r\nsnprintf(ts->phys, sizeof(ts->phys), "%s/input0", dev_name(&spi->dev));\r\ninput_dev->name = "AD7877 Touchscreen";\r\ninput_dev->phys = ts->phys;\r\ninput_dev->dev.parent = &spi->dev;\r\n__set_bit(EV_KEY, input_dev->evbit);\r\n__set_bit(BTN_TOUCH, input_dev->keybit);\r\n__set_bit(EV_ABS, input_dev->evbit);\r\n__set_bit(ABS_X, input_dev->absbit);\r\n__set_bit(ABS_Y, input_dev->absbit);\r\n__set_bit(ABS_PRESSURE, input_dev->absbit);\r\ninput_set_abs_params(input_dev, ABS_X,\r\npdata->x_min ? : 0,\r\npdata->x_max ? : MAX_12BIT,\r\n0, 0);\r\ninput_set_abs_params(input_dev, ABS_Y,\r\npdata->y_min ? : 0,\r\npdata->y_max ? : MAX_12BIT,\r\n0, 0);\r\ninput_set_abs_params(input_dev, ABS_PRESSURE,\r\npdata->pressure_min, pdata->pressure_max, 0, 0);\r\nad7877_write(spi, AD7877_REG_SEQ1, AD7877_MM_SEQUENCE);\r\nverify = ad7877_read(spi, AD7877_REG_SEQ1);\r\nif (verify != AD7877_MM_SEQUENCE){\r\ndev_err(&spi->dev, "%s: Failed to probe %s\n",\r\ndev_name(&spi->dev), input_dev->name);\r\nerr = -ENODEV;\r\ngoto err_free_mem;\r\n}\r\nif (gpio3)\r\nad7877_write(spi, AD7877_REG_EXTWRITE, AD7877_EXTW_GPIO_3_CONF);\r\nad7877_setup_ts_def_msg(spi, ts);\r\nerr = request_threaded_irq(spi->irq, NULL, ad7877_irq,\r\nIRQF_TRIGGER_FALLING | IRQF_ONESHOT,\r\nspi->dev.driver->name, ts);\r\nif (err) {\r\ndev_dbg(&spi->dev, "irq %d busy?\n", spi->irq);\r\ngoto err_free_mem;\r\n}\r\nerr = sysfs_create_group(&spi->dev.kobj, &ad7877_attr_group);\r\nif (err)\r\ngoto err_free_irq;\r\nerr = input_register_device(input_dev);\r\nif (err)\r\ngoto err_remove_attr_group;\r\nreturn 0;\r\nerr_remove_attr_group:\r\nsysfs_remove_group(&spi->dev.kobj, &ad7877_attr_group);\r\nerr_free_irq:\r\nfree_irq(spi->irq, ts);\r\nerr_free_mem:\r\ninput_free_device(input_dev);\r\nkfree(ts);\r\nspi_set_drvdata(spi, NULL);\r\nreturn err;\r\n}\r\nstatic int ad7877_remove(struct spi_device *spi)\r\n{\r\nstruct ad7877 *ts = spi_get_drvdata(spi);\r\nsysfs_remove_group(&spi->dev.kobj, &ad7877_attr_group);\r\nad7877_disable(ts);\r\nfree_irq(ts->spi->irq, ts);\r\ninput_unregister_device(ts->input);\r\nkfree(ts);\r\ndev_dbg(&spi->dev, "unregistered touchscreen\n");\r\nspi_set_drvdata(spi, NULL);\r\nreturn 0;\r\n}\r\nstatic int ad7877_suspend(struct device *dev)\r\n{\r\nstruct ad7877 *ts = dev_get_drvdata(dev);\r\nad7877_disable(ts);\r\nreturn 0;\r\n}\r\nstatic int ad7877_resume(struct device *dev)\r\n{\r\nstruct ad7877 *ts = dev_get_drvdata(dev);\r\nad7877_enable(ts);\r\nreturn 0;\r\n}

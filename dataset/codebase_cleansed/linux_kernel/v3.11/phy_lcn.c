void wlc_lcnphy_write_table(struct brcms_phy *pi, const struct phytbl_info *pti)\r\n{\r\nwlc_phy_write_table(pi, pti, 0x455, 0x457, 0x456);\r\n}\r\nvoid wlc_lcnphy_read_table(struct brcms_phy *pi, struct phytbl_info *pti)\r\n{\r\nwlc_phy_read_table(pi, pti, 0x455, 0x457, 0x456);\r\n}\r\nstatic void\r\nwlc_lcnphy_common_read_table(struct brcms_phy *pi, u32 tbl_id,\r\nconst u16 *tbl_ptr, u32 tbl_len,\r\nu32 tbl_width, u32 tbl_offset)\r\n{\r\nstruct phytbl_info tab;\r\ntab.tbl_id = tbl_id;\r\ntab.tbl_ptr = tbl_ptr;\r\ntab.tbl_len = tbl_len;\r\ntab.tbl_width = tbl_width;\r\ntab.tbl_offset = tbl_offset;\r\nwlc_lcnphy_read_table(pi, &tab);\r\n}\r\nstatic void\r\nwlc_lcnphy_common_write_table(struct brcms_phy *pi, u32 tbl_id,\r\nconst u16 *tbl_ptr, u32 tbl_len,\r\nu32 tbl_width, u32 tbl_offset)\r\n{\r\nstruct phytbl_info tab;\r\ntab.tbl_id = tbl_id;\r\ntab.tbl_ptr = tbl_ptr;\r\ntab.tbl_len = tbl_len;\r\ntab.tbl_width = tbl_width;\r\ntab.tbl_offset = tbl_offset;\r\nwlc_lcnphy_write_table(pi, &tab);\r\n}\r\nstatic u32\r\nwlc_lcnphy_qdiv_roundup(u32 dividend, u32 divisor, u8 precision)\r\n{\r\nu32 quotient, remainder, roundup, rbit;\r\nquotient = dividend / divisor;\r\nremainder = dividend % divisor;\r\nrbit = divisor & 1;\r\nroundup = (divisor >> 1) + rbit;\r\nwhile (precision--) {\r\nquotient <<= 1;\r\nif (remainder >= roundup) {\r\nquotient++;\r\nremainder = ((remainder - roundup) << 1) + rbit;\r\n} else {\r\nremainder <<= 1;\r\n}\r\n}\r\nif (remainder >= roundup)\r\nquotient++;\r\nreturn quotient;\r\n}\r\nstatic int wlc_lcnphy_calc_floor(s16 coeff_x, int type)\r\n{\r\nint k;\r\nk = 0;\r\nif (type == 0) {\r\nif (coeff_x < 0)\r\nk = (coeff_x - 1) / 2;\r\nelse\r\nk = coeff_x / 2;\r\n}\r\nif (type == 1) {\r\nif ((coeff_x + 1) < 0)\r\nk = (coeff_x) / 2;\r\nelse\r\nk = (coeff_x + 1) / 2;\r\n}\r\nreturn k;\r\n}\r\nstatic void\r\nwlc_lcnphy_get_tx_gain(struct brcms_phy *pi, struct lcnphy_txgains *gains)\r\n{\r\nu16 dac_gain, rfgain0, rfgain1;\r\ndac_gain = read_phy_reg(pi, 0x439) >> 0;\r\ngains->dac_gain = (dac_gain & 0x380) >> 7;\r\nrfgain0 = (read_phy_reg(pi, 0x4b5) & (0xffff << 0)) >> 0;\r\nrfgain1 = (read_phy_reg(pi, 0x4fb) & (0x7fff << 0)) >> 0;\r\ngains->gm_gain = rfgain0 & 0xff;\r\ngains->pga_gain = (rfgain0 >> 8) & 0xff;\r\ngains->pad_gain = rfgain1 & 0xff;\r\n}\r\nstatic void wlc_lcnphy_set_dac_gain(struct brcms_phy *pi, u16 dac_gain)\r\n{\r\nu16 dac_ctrl;\r\ndac_ctrl = (read_phy_reg(pi, 0x439) >> 0);\r\ndac_ctrl = dac_ctrl & 0xc7f;\r\ndac_ctrl = dac_ctrl | (dac_gain << 7);\r\nmod_phy_reg(pi, 0x439, (0xfff << 0), (dac_ctrl) << 0);\r\n}\r\nstatic void wlc_lcnphy_set_tx_gain_override(struct brcms_phy *pi, bool bEnable)\r\n{\r\nu16 bit = bEnable ? 1 : 0;\r\nmod_phy_reg(pi, 0x4b0, (0x1 << 7), bit << 7);\r\nmod_phy_reg(pi, 0x4b0, (0x1 << 14), bit << 14);\r\nmod_phy_reg(pi, 0x43b, (0x1 << 6), bit << 6);\r\n}\r\nstatic void\r\nwlc_lcnphy_rx_gain_override_enable(struct brcms_phy *pi, bool enable)\r\n{\r\nu16 ebit = enable ? 1 : 0;\r\nmod_phy_reg(pi, 0x4b0, (0x1 << 8), ebit << 8);\r\nmod_phy_reg(pi, 0x44c, (0x1 << 0), ebit << 0);\r\nif (LCNREV_LT(pi->pubpi.phy_rev, 2)) {\r\nmod_phy_reg(pi, 0x44c, (0x1 << 4), ebit << 4);\r\nmod_phy_reg(pi, 0x44c, (0x1 << 6), ebit << 6);\r\nmod_phy_reg(pi, 0x4b0, (0x1 << 5), ebit << 5);\r\nmod_phy_reg(pi, 0x4b0, (0x1 << 6), ebit << 6);\r\n} else {\r\nmod_phy_reg(pi, 0x4b0, (0x1 << 12), ebit << 12);\r\nmod_phy_reg(pi, 0x4b0, (0x1 << 13), ebit << 13);\r\nmod_phy_reg(pi, 0x4b0, (0x1 << 5), ebit << 5);\r\n}\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nmod_phy_reg(pi, 0x4b0, (0x1 << 10), ebit << 10);\r\nmod_phy_reg(pi, 0x4e5, (0x1 << 3), ebit << 3);\r\n}\r\n}\r\nstatic void\r\nwlc_lcnphy_set_rx_gain_by_distribution(struct brcms_phy *pi,\r\nu16 trsw,\r\nu16 ext_lna,\r\nu16 biq2,\r\nu16 biq1,\r\nu16 tia, u16 lna2, u16 lna1)\r\n{\r\nu16 gain0_15, gain16_19;\r\ngain16_19 = biq2 & 0xf;\r\ngain0_15 = ((biq1 & 0xf) << 12) |\r\n((tia & 0xf) << 8) |\r\n((lna2 & 0x3) << 6) |\r\n((lna2 &\r\n0x3) << 4) | ((lna1 & 0x3) << 2) | ((lna1 & 0x3) << 0);\r\nmod_phy_reg(pi, 0x4b6, (0xffff << 0), gain0_15 << 0);\r\nmod_phy_reg(pi, 0x4b7, (0xf << 0), gain16_19 << 0);\r\nmod_phy_reg(pi, 0x4b1, (0x3 << 11), lna1 << 11);\r\nif (LCNREV_LT(pi->pubpi.phy_rev, 2)) {\r\nmod_phy_reg(pi, 0x4b1, (0x1 << 9), ext_lna << 9);\r\nmod_phy_reg(pi, 0x4b1, (0x1 << 10), ext_lna << 10);\r\n} else {\r\nmod_phy_reg(pi, 0x4b1, (0x1 << 10), 0 << 10);\r\nmod_phy_reg(pi, 0x4b1, (0x1 << 15), 0 << 15);\r\nmod_phy_reg(pi, 0x4b1, (0x1 << 9), ext_lna << 9);\r\n}\r\nmod_phy_reg(pi, 0x44d, (0x1 << 0), (!trsw) << 0);\r\n}\r\nstatic void wlc_lcnphy_set_trsw_override(struct brcms_phy *pi, bool tx, bool rx)\r\n{\r\nmod_phy_reg(pi, 0x44d,\r\n(0x1 << 1) |\r\n(0x1 << 0), (tx ? (0x1 << 1) : 0) | (rx ? (0x1 << 0) : 0));\r\nor_phy_reg(pi, 0x44c, (0x1 << 1) | (0x1 << 0));\r\n}\r\nstatic void wlc_lcnphy_clear_trsw_override(struct brcms_phy *pi)\r\n{\r\nand_phy_reg(pi, 0x44c, (u16) ~((0x1 << 1) | (0x1 << 0)));\r\n}\r\nstatic void wlc_lcnphy_set_rx_iq_comp(struct brcms_phy *pi, u16 a, u16 b)\r\n{\r\nmod_phy_reg(pi, 0x645, (0x3ff << 0), (a) << 0);\r\nmod_phy_reg(pi, 0x646, (0x3ff << 0), (b) << 0);\r\nmod_phy_reg(pi, 0x647, (0x3ff << 0), (a) << 0);\r\nmod_phy_reg(pi, 0x648, (0x3ff << 0), (b) << 0);\r\nmod_phy_reg(pi, 0x649, (0x3ff << 0), (a) << 0);\r\nmod_phy_reg(pi, 0x64a, (0x3ff << 0), (b) << 0);\r\n}\r\nstatic bool\r\nwlc_lcnphy_rx_iq_est(struct brcms_phy *pi,\r\nu16 num_samps,\r\nu8 wait_time, struct lcnphy_iq_est *iq_est)\r\n{\r\nint wait_count = 0;\r\nbool result = true;\r\nu8 phybw40;\r\nphybw40 = CHSPEC_IS40(pi->radio_chanspec);\r\nmod_phy_reg(pi, 0x6da, (0x1 << 5), (1) << 5);\r\nmod_phy_reg(pi, 0x410, (0x1 << 3), (0) << 3);\r\nmod_phy_reg(pi, 0x482, (0xffff << 0), (num_samps) << 0);\r\nmod_phy_reg(pi, 0x481, (0xff << 0), ((u16) wait_time) << 0);\r\nmod_phy_reg(pi, 0x481, (0x1 << 8), (0) << 8);\r\nmod_phy_reg(pi, 0x481, (0x1 << 9), (1) << 9);\r\nwhile (read_phy_reg(pi, 0x481) & (0x1 << 9)) {\r\nif (wait_count > (10 * 500)) {\r\nresult = false;\r\ngoto cleanup;\r\n}\r\nudelay(100);\r\nwait_count++;\r\n}\r\niq_est->iq_prod = ((u32) read_phy_reg(pi, 0x483) << 16) |\r\n(u32) read_phy_reg(pi, 0x484);\r\niq_est->i_pwr = ((u32) read_phy_reg(pi, 0x485) << 16) |\r\n(u32) read_phy_reg(pi, 0x486);\r\niq_est->q_pwr = ((u32) read_phy_reg(pi, 0x487) << 16) |\r\n(u32) read_phy_reg(pi, 0x488);\r\ncleanup:\r\nmod_phy_reg(pi, 0x410, (0x1 << 3), (1) << 3);\r\nmod_phy_reg(pi, 0x6da, (0x1 << 5), (0) << 5);\r\nreturn result;\r\n}\r\nstatic bool wlc_lcnphy_calc_rx_iq_comp(struct brcms_phy *pi, u16 num_samps)\r\n{\r\n#define LCNPHY_MIN_RXIQ_PWR 2\r\nbool result;\r\nu16 a0_new, b0_new;\r\nstruct lcnphy_iq_est iq_est = { 0, 0, 0 };\r\ns32 a, b, temp;\r\ns16 iq_nbits, qq_nbits, arsh, brsh;\r\ns32 iq;\r\nu32 ii, qq;\r\nstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\r\na0_new = ((read_phy_reg(pi, 0x645) & (0x3ff << 0)) >> 0);\r\nb0_new = ((read_phy_reg(pi, 0x646) & (0x3ff << 0)) >> 0);\r\nmod_phy_reg(pi, 0x6d1, (0x1 << 2), (0) << 2);\r\nmod_phy_reg(pi, 0x64b, (0x1 << 6), (1) << 6);\r\nwlc_lcnphy_set_rx_iq_comp(pi, 0, 0);\r\nresult = wlc_lcnphy_rx_iq_est(pi, num_samps, 32, &iq_est);\r\nif (!result)\r\ngoto cleanup;\r\niq = (s32) iq_est.iq_prod;\r\nii = iq_est.i_pwr;\r\nqq = iq_est.q_pwr;\r\nif ((ii + qq) < LCNPHY_MIN_RXIQ_PWR) {\r\nresult = false;\r\ngoto cleanup;\r\n}\r\niq_nbits = wlc_phy_nbits(iq);\r\nqq_nbits = wlc_phy_nbits(qq);\r\narsh = 10 - (30 - iq_nbits);\r\nif (arsh >= 0) {\r\na = (-(iq << (30 - iq_nbits)) + (ii >> (1 + arsh)));\r\ntemp = (s32) (ii >> arsh);\r\nif (temp == 0)\r\nreturn false;\r\n} else {\r\na = (-(iq << (30 - iq_nbits)) + (ii << (-1 - arsh)));\r\ntemp = (s32) (ii << -arsh);\r\nif (temp == 0)\r\nreturn false;\r\n}\r\na /= temp;\r\nbrsh = qq_nbits - 31 + 20;\r\nif (brsh >= 0) {\r\nb = (qq << (31 - qq_nbits));\r\ntemp = (s32) (ii >> brsh);\r\nif (temp == 0)\r\nreturn false;\r\n} else {\r\nb = (qq << (31 - qq_nbits));\r\ntemp = (s32) (ii << -brsh);\r\nif (temp == 0)\r\nreturn false;\r\n}\r\nb /= temp;\r\nb -= a * a;\r\nb = (s32) int_sqrt((unsigned long) b);\r\nb -= (1 << 10);\r\na0_new = (u16) (a & 0x3ff);\r\nb0_new = (u16) (b & 0x3ff);\r\ncleanup:\r\nwlc_lcnphy_set_rx_iq_comp(pi, a0_new, b0_new);\r\nmod_phy_reg(pi, 0x64b, (0x1 << 0), (1) << 0);\r\nmod_phy_reg(pi, 0x64b, (0x1 << 3), (1) << 3);\r\npi_lcn->lcnphy_cal_results.rxiqcal_coeff_a0 = a0_new;\r\npi_lcn->lcnphy_cal_results.rxiqcal_coeff_b0 = b0_new;\r\nreturn result;\r\n}\r\nstatic u32 wlc_lcnphy_measure_digital_power(struct brcms_phy *pi, u16 nsamples)\r\n{\r\nstruct lcnphy_iq_est iq_est = { 0, 0, 0 };\r\nif (!wlc_lcnphy_rx_iq_est(pi, nsamples, 32, &iq_est))\r\nreturn 0;\r\nreturn (iq_est.i_pwr + iq_est.q_pwr) / nsamples;\r\n}\r\nstatic bool\r\nwlc_lcnphy_rx_iq_cal(struct brcms_phy *pi,\r\nconst struct lcnphy_rx_iqcomp *iqcomp,\r\nint iqcomp_sz, bool tx_switch, bool rx_switch, int module,\r\nint tx_gain_idx)\r\n{\r\nstruct lcnphy_txgains old_gains;\r\nu16 tx_pwr_ctrl;\r\nu8 tx_gain_index_old = 0;\r\nbool result = false, tx_gain_override_old = false;\r\nu16 i, Core1TxControl_old, RFOverride0_old,\r\nRFOverrideVal0_old, rfoverride2_old, rfoverride2val_old,\r\nrfoverride3_old, rfoverride3val_old, rfoverride4_old,\r\nrfoverride4val_old, afectrlovr_old, afectrlovrval_old;\r\nint tia_gain;\r\nu32 received_power, rx_pwr_threshold;\r\nu16 old_sslpnCalibClkEnCtrl, old_sslpnRxFeClkEnCtrl;\r\nu16 values_to_save[11];\r\ns16 *ptr;\r\nstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\r\nptr = kmalloc(sizeof(s16) * 131, GFP_ATOMIC);\r\nif (NULL == ptr)\r\nreturn false;\r\nif (module == 2) {\r\nwhile (iqcomp_sz--) {\r\nif (iqcomp[iqcomp_sz].chan ==\r\nCHSPEC_CHANNEL(pi->radio_chanspec)) {\r\nwlc_lcnphy_set_rx_iq_comp(pi,\r\n(u16)\r\niqcomp[iqcomp_sz].a,\r\n(u16)\r\niqcomp[iqcomp_sz].b);\r\nresult = true;\r\nbreak;\r\n}\r\n}\r\ngoto cal_done;\r\n}\r\nif (module == 1) {\r\ntx_pwr_ctrl = wlc_lcnphy_get_tx_pwr_ctrl(pi);\r\nwlc_lcnphy_set_tx_pwr_ctrl(pi, LCNPHY_TX_PWR_CTRL_OFF);\r\nfor (i = 0; i < 11; i++)\r\nvalues_to_save[i] =\r\nread_radio_reg(pi, rxiq_cal_rf_reg[i]);\r\nCore1TxControl_old = read_phy_reg(pi, 0x631);\r\nor_phy_reg(pi, 0x631, 0x0015);\r\nRFOverride0_old = read_phy_reg(pi, 0x44c);\r\nRFOverrideVal0_old = read_phy_reg(pi, 0x44d);\r\nrfoverride2_old = read_phy_reg(pi, 0x4b0);\r\nrfoverride2val_old = read_phy_reg(pi, 0x4b1);\r\nrfoverride3_old = read_phy_reg(pi, 0x4f9);\r\nrfoverride3val_old = read_phy_reg(pi, 0x4fa);\r\nrfoverride4_old = read_phy_reg(pi, 0x938);\r\nrfoverride4val_old = read_phy_reg(pi, 0x939);\r\nafectrlovr_old = read_phy_reg(pi, 0x43b);\r\nafectrlovrval_old = read_phy_reg(pi, 0x43c);\r\nold_sslpnCalibClkEnCtrl = read_phy_reg(pi, 0x6da);\r\nold_sslpnRxFeClkEnCtrl = read_phy_reg(pi, 0x6db);\r\ntx_gain_override_old = wlc_lcnphy_tx_gain_override_enabled(pi);\r\nif (tx_gain_override_old) {\r\nwlc_lcnphy_get_tx_gain(pi, &old_gains);\r\ntx_gain_index_old = pi_lcn->lcnphy_current_index;\r\n}\r\nwlc_lcnphy_set_tx_pwr_by_index(pi, tx_gain_idx);\r\nmod_phy_reg(pi, 0x4f9, (0x1 << 0), 1 << 0);\r\nmod_phy_reg(pi, 0x4fa, (0x1 << 0), 0 << 0);\r\nmod_phy_reg(pi, 0x43b, (0x1 << 1), 1 << 1);\r\nmod_phy_reg(pi, 0x43c, (0x1 << 1), 0 << 1);\r\nwrite_radio_reg(pi, RADIO_2064_REG116, 0x06);\r\nwrite_radio_reg(pi, RADIO_2064_REG12C, 0x07);\r\nwrite_radio_reg(pi, RADIO_2064_REG06A, 0xd3);\r\nwrite_radio_reg(pi, RADIO_2064_REG098, 0x03);\r\nwrite_radio_reg(pi, RADIO_2064_REG00B, 0x7);\r\nmod_radio_reg(pi, RADIO_2064_REG113, 1 << 4, 1 << 4);\r\nwrite_radio_reg(pi, RADIO_2064_REG01D, 0x01);\r\nwrite_radio_reg(pi, RADIO_2064_REG114, 0x01);\r\nwrite_radio_reg(pi, RADIO_2064_REG02E, 0x10);\r\nwrite_radio_reg(pi, RADIO_2064_REG12A, 0x08);\r\nmod_phy_reg(pi, 0x938, (0x1 << 0), 1 << 0);\r\nmod_phy_reg(pi, 0x939, (0x1 << 0), 0 << 0);\r\nmod_phy_reg(pi, 0x938, (0x1 << 1), 1 << 1);\r\nmod_phy_reg(pi, 0x939, (0x1 << 1), 1 << 1);\r\nmod_phy_reg(pi, 0x938, (0x1 << 2), 1 << 2);\r\nmod_phy_reg(pi, 0x939, (0x1 << 2), 1 << 2);\r\nmod_phy_reg(pi, 0x938, (0x1 << 3), 1 << 3);\r\nmod_phy_reg(pi, 0x939, (0x1 << 3), 1 << 3);\r\nmod_phy_reg(pi, 0x938, (0x1 << 5), 1 << 5);\r\nmod_phy_reg(pi, 0x939, (0x1 << 5), 0 << 5);\r\nmod_phy_reg(pi, 0x43b, (0x1 << 0), 1 << 0);\r\nmod_phy_reg(pi, 0x43c, (0x1 << 0), 0 << 0);\r\nwlc_lcnphy_start_tx_tone(pi, 2000, 120, 0);\r\nwrite_phy_reg(pi, 0x6da, 0xffff);\r\nor_phy_reg(pi, 0x6db, 0x3);\r\nwlc_lcnphy_set_trsw_override(pi, tx_switch, rx_switch);\r\nwlc_lcnphy_rx_gain_override_enable(pi, true);\r\ntia_gain = 8;\r\nrx_pwr_threshold = 950;\r\nwhile (tia_gain > 0) {\r\ntia_gain -= 1;\r\nwlc_lcnphy_set_rx_gain_by_distribution(pi,\r\n0, 0, 2, 2,\r\n(u16)\r\ntia_gain, 1, 0);\r\nudelay(500);\r\nreceived_power =\r\nwlc_lcnphy_measure_digital_power(pi, 2000);\r\nif (received_power < rx_pwr_threshold)\r\nbreak;\r\n}\r\nresult = wlc_lcnphy_calc_rx_iq_comp(pi, 0xffff);\r\nwlc_lcnphy_stop_tx_tone(pi);\r\nwrite_phy_reg(pi, 0x631, Core1TxControl_old);\r\nwrite_phy_reg(pi, 0x44c, RFOverrideVal0_old);\r\nwrite_phy_reg(pi, 0x44d, RFOverrideVal0_old);\r\nwrite_phy_reg(pi, 0x4b0, rfoverride2_old);\r\nwrite_phy_reg(pi, 0x4b1, rfoverride2val_old);\r\nwrite_phy_reg(pi, 0x4f9, rfoverride3_old);\r\nwrite_phy_reg(pi, 0x4fa, rfoverride3val_old);\r\nwrite_phy_reg(pi, 0x938, rfoverride4_old);\r\nwrite_phy_reg(pi, 0x939, rfoverride4val_old);\r\nwrite_phy_reg(pi, 0x43b, afectrlovr_old);\r\nwrite_phy_reg(pi, 0x43c, afectrlovrval_old);\r\nwrite_phy_reg(pi, 0x6da, old_sslpnCalibClkEnCtrl);\r\nwrite_phy_reg(pi, 0x6db, old_sslpnRxFeClkEnCtrl);\r\nwlc_lcnphy_clear_trsw_override(pi);\r\nmod_phy_reg(pi, 0x44c, (0x1 << 2), 0 << 2);\r\nfor (i = 0; i < 11; i++)\r\nwrite_radio_reg(pi, rxiq_cal_rf_reg[i],\r\nvalues_to_save[i]);\r\nif (tx_gain_override_old)\r\nwlc_lcnphy_set_tx_pwr_by_index(pi, tx_gain_index_old);\r\nelse\r\nwlc_lcnphy_disable_tx_gain_override(pi);\r\nwlc_lcnphy_set_tx_pwr_ctrl(pi, tx_pwr_ctrl);\r\nwlc_lcnphy_rx_gain_override_enable(pi, false);\r\n}\r\ncal_done:\r\nkfree(ptr);\r\nreturn result;\r\n}\r\ns8 wlc_lcnphy_get_current_tx_pwr_idx(struct brcms_phy *pi)\r\n{\r\ns8 index;\r\nstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\r\nif (txpwrctrl_off(pi))\r\nindex = pi_lcn->lcnphy_current_index;\r\nelse if (wlc_lcnphy_tssi_based_pwr_ctrl_enabled(pi))\r\nindex = (s8) (wlc_lcnphy_get_current_tx_pwr_idx_if_pwrctrl_on(\r\npi) / 2);\r\nelse\r\nindex = pi_lcn->lcnphy_current_index;\r\nreturn index;\r\n}\r\nvoid wlc_lcnphy_crsuprs(struct brcms_phy *pi, int channel)\r\n{\r\nu16 afectrlovr, afectrlovrval;\r\nafectrlovr = read_phy_reg(pi, 0x43b);\r\nafectrlovrval = read_phy_reg(pi, 0x43c);\r\nif (channel != 0) {\r\nmod_phy_reg(pi, 0x43b, (0x1 << 1), (1) << 1);\r\nmod_phy_reg(pi, 0x43c, (0x1 << 1), (0) << 1);\r\nmod_phy_reg(pi, 0x43b, (0x1 << 4), (1) << 4);\r\nmod_phy_reg(pi, 0x43c, (0x1 << 6), (0) << 6);\r\nwrite_phy_reg(pi, 0x44b, 0xffff);\r\nwlc_lcnphy_tx_pu(pi, 1);\r\nmod_phy_reg(pi, 0x634, (0xff << 8), (0) << 8);\r\nor_phy_reg(pi, 0x6da, 0x0080);\r\nor_phy_reg(pi, 0x00a, 0x228);\r\n} else {\r\nand_phy_reg(pi, 0x00a, ~(0x228));\r\nand_phy_reg(pi, 0x6da, 0xFF7F);\r\nwrite_phy_reg(pi, 0x43b, afectrlovr);\r\nwrite_phy_reg(pi, 0x43c, afectrlovrval);\r\n}\r\n}\r\nstatic void wlc_lcnphy_toggle_afe_pwdn(struct brcms_phy *pi)\r\n{\r\nu16 save_AfeCtrlOvrVal, save_AfeCtrlOvr;\r\nsave_AfeCtrlOvrVal = read_phy_reg(pi, 0x43c);\r\nsave_AfeCtrlOvr = read_phy_reg(pi, 0x43b);\r\nwrite_phy_reg(pi, 0x43c, save_AfeCtrlOvrVal | 0x1);\r\nwrite_phy_reg(pi, 0x43b, save_AfeCtrlOvr | 0x1);\r\nwrite_phy_reg(pi, 0x43c, save_AfeCtrlOvrVal & 0xfffe);\r\nwrite_phy_reg(pi, 0x43b, save_AfeCtrlOvr & 0xfffe);\r\nwrite_phy_reg(pi, 0x43c, save_AfeCtrlOvrVal);\r\nwrite_phy_reg(pi, 0x43b, save_AfeCtrlOvr);\r\n}\r\nstatic void\r\nwlc_lcnphy_txrx_spur_avoidance_mode(struct brcms_phy *pi, bool enable)\r\n{\r\nif (enable) {\r\nwrite_phy_reg(pi, 0x942, 0x7);\r\nwrite_phy_reg(pi, 0x93b, ((1 << 13) + 23));\r\nwrite_phy_reg(pi, 0x93c, ((1 << 13) + 1989));\r\nwrite_phy_reg(pi, 0x44a, 0x084);\r\nwrite_phy_reg(pi, 0x44a, 0x080);\r\nwrite_phy_reg(pi, 0x6d3, 0x2222);\r\nwrite_phy_reg(pi, 0x6d3, 0x2220);\r\n} else {\r\nwrite_phy_reg(pi, 0x942, 0x0);\r\nwrite_phy_reg(pi, 0x93b, ((0 << 13) + 23));\r\nwrite_phy_reg(pi, 0x93c, ((0 << 13) + 1989));\r\n}\r\nwlapi_switch_macfreq(pi->sh->physhim, enable);\r\n}\r\nstatic void\r\nwlc_lcnphy_set_chanspec_tweaks(struct brcms_phy *pi, u16 chanspec)\r\n{\r\nu8 channel = CHSPEC_CHANNEL(chanspec);\r\nstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\r\nif (channel == 14)\r\nmod_phy_reg(pi, 0x448, (0x3 << 8), (2) << 8);\r\nelse\r\nmod_phy_reg(pi, 0x448, (0x3 << 8), (1) << 8);\r\npi_lcn->lcnphy_bandedge_corr = 2;\r\nif (channel == 1)\r\npi_lcn->lcnphy_bandedge_corr = 4;\r\nif (channel == 1 || channel == 2 || channel == 3 ||\r\nchannel == 4 || channel == 9 ||\r\nchannel == 10 || channel == 11 || channel == 12) {\r\nbcma_chipco_pll_write(&pi->d11core->bus->drv_cc, 0x2,\r\n0x03000c04);\r\nbcma_chipco_pll_maskset(&pi->d11core->bus->drv_cc, 0x3,\r\n~0x00ffffff, 0x0);\r\nbcma_chipco_pll_write(&pi->d11core->bus->drv_cc, 0x4,\r\n0x200005c0);\r\nbcma_cc_set32(&pi->d11core->bus->drv_cc, BCMA_CC_PMU_CTL,\r\nBCMA_CC_PMU_CTL_PLL_UPD);\r\nwrite_phy_reg(pi, 0x942, 0);\r\nwlc_lcnphy_txrx_spur_avoidance_mode(pi, false);\r\npi_lcn->lcnphy_spurmod = false;\r\nmod_phy_reg(pi, 0x424, (0xff << 8), (0x1b) << 8);\r\nwrite_phy_reg(pi, 0x425, 0x5907);\r\n} else {\r\nbcma_chipco_pll_write(&pi->d11core->bus->drv_cc, 0x2,\r\n0x03140c04);\r\nbcma_chipco_pll_maskset(&pi->d11core->bus->drv_cc, 0x3,\r\n~0x00ffffff, 0x333333);\r\nbcma_chipco_pll_write(&pi->d11core->bus->drv_cc, 0x4,\r\n0x202c2820);\r\nbcma_cc_set32(&pi->d11core->bus->drv_cc, BCMA_CC_PMU_CTL,\r\nBCMA_CC_PMU_CTL_PLL_UPD);\r\nwrite_phy_reg(pi, 0x942, 0);\r\nwlc_lcnphy_txrx_spur_avoidance_mode(pi, true);\r\npi_lcn->lcnphy_spurmod = false;\r\nmod_phy_reg(pi, 0x424, (0xff << 8), (0x1f) << 8);\r\nwrite_phy_reg(pi, 0x425, 0x590a);\r\n}\r\nor_phy_reg(pi, 0x44a, 0x44);\r\nwrite_phy_reg(pi, 0x44a, 0x80);\r\n}\r\nstatic void\r\nwlc_lcnphy_radio_2064_channel_tune_4313(struct brcms_phy *pi, u8 channel)\r\n{\r\nuint i;\r\nconst struct chan_info_2064_lcnphy *ci;\r\nu8 rfpll_doubler = 0;\r\nu8 pll_pwrup, pll_pwrup_ovr;\r\ns32 qFxtal, qFref, qFvco, qFcal;\r\nu8 d15, d16, f16, e44, e45;\r\nu32 div_int, div_frac, fvco3, fpfd, fref3, fcal_div;\r\nu16 loop_bw, d30, setCount;\r\nu8 h29, h28_ten, e30, h30_ten, cp_current;\r\nu16 g30, d28;\r\nci = &chan_info_2064_lcnphy[0];\r\nrfpll_doubler = 1;\r\nmod_radio_reg(pi, RADIO_2064_REG09D, 0x4, 0x1 << 2);\r\nwrite_radio_reg(pi, RADIO_2064_REG09E, 0xf);\r\nif (!rfpll_doubler) {\r\nloop_bw = PLL_2064_LOOP_BW;\r\nd30 = PLL_2064_D30;\r\n} else {\r\nloop_bw = PLL_2064_LOOP_BW_DOUBLER;\r\nd30 = PLL_2064_D30_DOUBLER;\r\n}\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nfor (i = 0; i < ARRAY_SIZE(chan_info_2064_lcnphy); i++)\r\nif (chan_info_2064_lcnphy[i].chan == channel)\r\nbreak;\r\nif (i >= ARRAY_SIZE(chan_info_2064_lcnphy))\r\nreturn;\r\nci = &chan_info_2064_lcnphy[i];\r\n}\r\nwrite_radio_reg(pi, RADIO_2064_REG02A, ci->logen_buftune);\r\nmod_radio_reg(pi, RADIO_2064_REG030, 0x3, ci->logen_rccr_tx);\r\nmod_radio_reg(pi, RADIO_2064_REG091, 0x3, ci->txrf_mix_tune_ctrl);\r\nmod_radio_reg(pi, RADIO_2064_REG038, 0xf, ci->pa_input_tune_g);\r\nmod_radio_reg(pi, RADIO_2064_REG030, 0x3 << 2,\r\n(ci->logen_rccr_rx) << 2);\r\nmod_radio_reg(pi, RADIO_2064_REG05E, 0xf, ci->pa_rxrf_lna1_freq_tune);\r\nmod_radio_reg(pi, RADIO_2064_REG05E, (0xf) << 4,\r\n(ci->pa_rxrf_lna2_freq_tune) << 4);\r\nwrite_radio_reg(pi, RADIO_2064_REG06C, ci->rxrf_rxrf_spare1);\r\npll_pwrup = (u8) read_radio_reg(pi, RADIO_2064_REG044);\r\npll_pwrup_ovr = (u8) read_radio_reg(pi, RADIO_2064_REG12B);\r\nor_radio_reg(pi, RADIO_2064_REG044, 0x07);\r\nor_radio_reg(pi, RADIO_2064_REG12B, (0x07) << 1);\r\ne44 = 0;\r\ne45 = 0;\r\nfpfd = rfpll_doubler ? (pi->xtalfreq << 1) : (pi->xtalfreq);\r\nif (pi->xtalfreq > 26000000)\r\ne44 = 1;\r\nif (pi->xtalfreq > 52000000)\r\ne45 = 1;\r\nif (e44 == 0)\r\nfcal_div = 1;\r\nelse if (e45 == 0)\r\nfcal_div = 2;\r\nelse\r\nfcal_div = 4;\r\nfvco3 = (ci->freq * 3);\r\nfref3 = 2 * fpfd;\r\nqFxtal = wlc_lcnphy_qdiv_roundup(pi->xtalfreq, PLL_2064_MHZ, 16);\r\nqFref = wlc_lcnphy_qdiv_roundup(fpfd, PLL_2064_MHZ, 16);\r\nqFcal = pi->xtalfreq * fcal_div / PLL_2064_MHZ;\r\nqFvco = wlc_lcnphy_qdiv_roundup(fvco3, 2, 16);\r\nwrite_radio_reg(pi, RADIO_2064_REG04F, 0x02);\r\nd15 = (pi->xtalfreq * fcal_div * 4 / 5) / PLL_2064_MHZ - 1;\r\nwrite_radio_reg(pi, RADIO_2064_REG052, (0x07 & (d15 >> 2)));\r\nwrite_radio_reg(pi, RADIO_2064_REG053, (d15 & 0x3) << 5);\r\nd16 = (qFcal * 8 / (d15 + 1)) - 1;\r\nwrite_radio_reg(pi, RADIO_2064_REG051, d16);\r\nf16 = ((d16 + 1) * (d15 + 1)) / qFcal;\r\nsetCount = f16 * 3 * (ci->freq) / 32 - 1;\r\nmod_radio_reg(pi, RADIO_2064_REG053, (0x0f << 0),\r\n(u8) (setCount >> 8));\r\nor_radio_reg(pi, RADIO_2064_REG053, 0x10);\r\nwrite_radio_reg(pi, RADIO_2064_REG054, (u8) (setCount & 0xff));\r\ndiv_int = ((fvco3 * (PLL_2064_MHZ >> 4)) / fref3) << 4;\r\ndiv_frac = ((fvco3 * (PLL_2064_MHZ >> 4)) % fref3) << 4;\r\nwhile (div_frac >= fref3) {\r\ndiv_int++;\r\ndiv_frac -= fref3;\r\n}\r\ndiv_frac = wlc_lcnphy_qdiv_roundup(div_frac, fref3, 20);\r\nmod_radio_reg(pi, RADIO_2064_REG045, (0x1f << 0),\r\n(u8) (div_int >> 4));\r\nmod_radio_reg(pi, RADIO_2064_REG046, (0x1f << 4),\r\n(u8) (div_int << 4));\r\nmod_radio_reg(pi, RADIO_2064_REG046, (0x0f << 0),\r\n(u8) (div_frac >> 16));\r\nwrite_radio_reg(pi, RADIO_2064_REG047, (u8) (div_frac >> 8) & 0xff);\r\nwrite_radio_reg(pi, RADIO_2064_REG048, (u8) div_frac & 0xff);\r\nwrite_radio_reg(pi, RADIO_2064_REG040, 0xfb);\r\nwrite_radio_reg(pi, RADIO_2064_REG041, 0x9A);\r\nwrite_radio_reg(pi, RADIO_2064_REG042, 0xA3);\r\nwrite_radio_reg(pi, RADIO_2064_REG043, 0x0C);\r\nh29 = LCN_BW_LMT / loop_bw;\r\nd28 = (((PLL_2064_HIGH_END_KVCO - PLL_2064_LOW_END_KVCO) *\r\n(fvco3 / 2 - PLL_2064_LOW_END_VCO)) /\r\n(PLL_2064_HIGH_END_VCO - PLL_2064_LOW_END_VCO))\r\n+ PLL_2064_LOW_END_KVCO;\r\nh28_ten = (d28 * 10) / LCN_VCO_DIV;\r\ne30 = (d30 - LCN_OFFSET) / LCN_FACT;\r\ng30 = LCN_OFFSET + (e30 * LCN_FACT);\r\nh30_ten = (g30 * 10) / LCN_CUR_DIV;\r\ncp_current = ((LCN_CUR_LMT * h29 * LCN_MULT * 100) / h28_ten) / h30_ten;\r\nmod_radio_reg(pi, RADIO_2064_REG03C, 0x3f, cp_current);\r\nif (channel >= 1 && channel <= 5)\r\nwrite_radio_reg(pi, RADIO_2064_REG03C, 0x8);\r\nelse\r\nwrite_radio_reg(pi, RADIO_2064_REG03C, 0x7);\r\nwrite_radio_reg(pi, RADIO_2064_REG03D, 0x3);\r\nmod_radio_reg(pi, RADIO_2064_REG044, 0x0c, 0x0c);\r\nudelay(1);\r\nwlc_2064_vco_cal(pi);\r\nwrite_radio_reg(pi, RADIO_2064_REG044, pll_pwrup);\r\nwrite_radio_reg(pi, RADIO_2064_REG12B, pll_pwrup_ovr);\r\nif (LCNREV_IS(pi->pubpi.phy_rev, 1)) {\r\nwrite_radio_reg(pi, RADIO_2064_REG038, 3);\r\nwrite_radio_reg(pi, RADIO_2064_REG091, 7);\r\n}\r\n}\r\nstatic int\r\nwlc_lcnphy_load_tx_iir_filter(struct brcms_phy *pi, bool is_ofdm, s16 filt_type)\r\n{\r\ns16 filt_index = -1;\r\nint j;\r\nu16 addr[] = {\r\n0x910,\r\n0x91e,\r\n0x91f,\r\n0x924,\r\n0x925,\r\n0x926,\r\n0x920,\r\n0x921,\r\n0x927,\r\n0x928,\r\n0x929,\r\n0x922,\r\n0x923,\r\n0x930,\r\n0x931,\r\n0x932\r\n};\r\nu16 addr_ofdm[] = {\r\n0x90f,\r\n0x900,\r\n0x901,\r\n0x906,\r\n0x907,\r\n0x908,\r\n0x902,\r\n0x903,\r\n0x909,\r\n0x90a,\r\n0x90b,\r\n0x904,\r\n0x905,\r\n0x90c,\r\n0x90d,\r\n0x90e\r\n};\r\nif (!is_ofdm) {\r\nfor (j = 0; j < LCNPHY_NUM_TX_DIG_FILTERS_CCK; j++) {\r\nif (filt_type == LCNPHY_txdigfiltcoeffs_cck[j][0]) {\r\nfilt_index = (s16) j;\r\nbreak;\r\n}\r\n}\r\nif (filt_index != -1) {\r\nfor (j = 0; j < LCNPHY_NUM_DIG_FILT_COEFFS; j++)\r\nwrite_phy_reg(pi, addr[j],\r\nLCNPHY_txdigfiltcoeffs_cck\r\n[filt_index][j + 1]);\r\n}\r\n} else {\r\nfor (j = 0; j < LCNPHY_NUM_TX_DIG_FILTERS_OFDM; j++) {\r\nif (filt_type == LCNPHY_txdigfiltcoeffs_ofdm[j][0]) {\r\nfilt_index = (s16) j;\r\nbreak;\r\n}\r\n}\r\nif (filt_index != -1) {\r\nfor (j = 0; j < LCNPHY_NUM_DIG_FILT_COEFFS; j++)\r\nwrite_phy_reg(pi, addr_ofdm[j],\r\nLCNPHY_txdigfiltcoeffs_ofdm\r\n[filt_index][j + 1]);\r\n}\r\n}\r\nreturn (filt_index != -1) ? 0 : -1;\r\n}\r\nstatic u16 wlc_lcnphy_get_pa_gain(struct brcms_phy *pi)\r\n{\r\nu16 pa_gain;\r\npa_gain = (read_phy_reg(pi, 0x4fb) &\r\nLCNPHY_txgainctrlovrval1_pagain_ovr_val1_MASK) >>\r\nLCNPHY_txgainctrlovrval1_pagain_ovr_val1_SHIFT;\r\nreturn pa_gain;\r\n}\r\nstatic void wlc_lcnphy_set_tx_gain(struct brcms_phy *pi,\r\nstruct lcnphy_txgains *target_gains)\r\n{\r\nu16 pa_gain = wlc_lcnphy_get_pa_gain(pi);\r\nmod_phy_reg(\r\npi, 0x4b5,\r\n(0xffff << 0),\r\n((target_gains->gm_gain) |\r\n(target_gains->pga_gain << 8)) <<\r\n0);\r\nmod_phy_reg(pi, 0x4fb,\r\n(0x7fff << 0),\r\n((target_gains->pad_gain) | (pa_gain << 8)) << 0);\r\nmod_phy_reg(\r\npi, 0x4fc,\r\n(0xffff << 0),\r\n((target_gains->gm_gain) |\r\n(target_gains->pga_gain << 8)) <<\r\n0);\r\nmod_phy_reg(pi, 0x4fd,\r\n(0x7fff << 0),\r\n((target_gains->pad_gain) | (pa_gain << 8)) << 0);\r\nwlc_lcnphy_set_dac_gain(pi, target_gains->dac_gain);\r\nwlc_lcnphy_enable_tx_gain_override(pi);\r\n}\r\nstatic u8 wlc_lcnphy_get_bbmult(struct brcms_phy *pi)\r\n{\r\nu16 m0m1;\r\nstruct phytbl_info tab;\r\ntab.tbl_ptr = &m0m1;\r\ntab.tbl_len = 1;\r\ntab.tbl_id = LCNPHY_TBL_ID_IQLOCAL;\r\ntab.tbl_offset = 87;\r\ntab.tbl_width = 16;\r\nwlc_lcnphy_read_table(pi, &tab);\r\nreturn (u8) ((m0m1 & 0xff00) >> 8);\r\n}\r\nstatic void wlc_lcnphy_set_bbmult(struct brcms_phy *pi, u8 m0)\r\n{\r\nu16 m0m1 = (u16) m0 << 8;\r\nstruct phytbl_info tab;\r\ntab.tbl_ptr = &m0m1;\r\ntab.tbl_len = 1;\r\ntab.tbl_id = LCNPHY_TBL_ID_IQLOCAL;\r\ntab.tbl_offset = 87;\r\ntab.tbl_width = 16;\r\nwlc_lcnphy_write_table(pi, &tab);\r\n}\r\nstatic void wlc_lcnphy_clear_tx_power_offsets(struct brcms_phy *pi)\r\n{\r\nu32 data_buf[64];\r\nstruct phytbl_info tab;\r\nmemset(data_buf, 0, sizeof(data_buf));\r\ntab.tbl_id = LCNPHY_TBL_ID_TXPWRCTL;\r\ntab.tbl_width = 32;\r\ntab.tbl_ptr = data_buf;\r\nif (!wlc_lcnphy_tempsense_based_pwr_ctrl_enabled(pi)) {\r\ntab.tbl_len = 30;\r\ntab.tbl_offset = LCNPHY_TX_PWR_CTRL_RATE_OFFSET;\r\nwlc_lcnphy_write_table(pi, &tab);\r\n}\r\ntab.tbl_len = 64;\r\ntab.tbl_offset = LCNPHY_TX_PWR_CTRL_MAC_OFFSET;\r\nwlc_lcnphy_write_table(pi, &tab);\r\n}\r\nstatic void\r\nwlc_lcnphy_set_tssi_mux(struct brcms_phy *pi, enum lcnphy_tssi_mode pos)\r\n{\r\nmod_phy_reg(pi, 0x4d7, (0x1 << 0), (0x1) << 0);\r\nmod_phy_reg(pi, 0x4d7, (0x1 << 6), (1) << 6);\r\nif (LCNPHY_TSSI_POST_PA == pos) {\r\nmod_phy_reg(pi, 0x4d9, (0x1 << 2), (0) << 2);\r\nmod_phy_reg(pi, 0x4d9, (0x1 << 3), (1) << 3);\r\nif (LCNREV_IS(pi->pubpi.phy_rev, 2)) {\r\nmod_radio_reg(pi, RADIO_2064_REG086, 0x4, 0x4);\r\n} else {\r\nmod_radio_reg(pi, RADIO_2064_REG03A, 1, 0x1);\r\nmod_radio_reg(pi, RADIO_2064_REG11A, 0x8, 0x8);\r\n}\r\n} else {\r\nmod_phy_reg(pi, 0x4d9, (0x1 << 2), (0x1) << 2);\r\nmod_phy_reg(pi, 0x4d9, (0x1 << 3), (0) << 3);\r\nif (LCNREV_IS(pi->pubpi.phy_rev, 2)) {\r\nmod_radio_reg(pi, RADIO_2064_REG086, 0x4, 0x4);\r\n} else {\r\nmod_radio_reg(pi, RADIO_2064_REG03A, 1, 0);\r\nmod_radio_reg(pi, RADIO_2064_REG11A, 0x8, 0x8);\r\n}\r\n}\r\nmod_phy_reg(pi, 0x637, (0x3 << 14), (0) << 14);\r\nif (LCNPHY_TSSI_EXT == pos) {\r\nwrite_radio_reg(pi, RADIO_2064_REG07F, 1);\r\nmod_radio_reg(pi, RADIO_2064_REG005, 0x7, 0x2);\r\nmod_radio_reg(pi, RADIO_2064_REG112, 0x80, 0x1 << 7);\r\nmod_radio_reg(pi, RADIO_2064_REG028, 0x1f, 0x3);\r\n}\r\n}\r\nstatic u16 wlc_lcnphy_rfseq_tbl_adc_pwrup(struct brcms_phy *pi)\r\n{\r\nu16 N1, N2, N3, N4, N5, N6, N;\r\nN1 = ((read_phy_reg(pi, 0x4a5) & (0xff << 0))\r\n>> 0);\r\nN2 = 1 << ((read_phy_reg(pi, 0x4a5) & (0x7 << 12))\r\n>> 12);\r\nN3 = ((read_phy_reg(pi, 0x40d) & (0xff << 0))\r\n>> 0);\r\nN4 = 1 << ((read_phy_reg(pi, 0x40d) & (0x7 << 8))\r\n>> 8);\r\nN5 = ((read_phy_reg(pi, 0x4a2) & (0xff << 0))\r\n>> 0);\r\nN6 = 1 << ((read_phy_reg(pi, 0x4a2) & (0x7 << 8))\r\n>> 8);\r\nN = 2 * (N1 + N2 + N3 + N4 + 2 * (N5 + N6)) + 80;\r\nif (N < 1600)\r\nN = 1600;\r\nreturn N;\r\n}\r\nstatic void wlc_lcnphy_pwrctrl_rssiparams(struct brcms_phy *pi)\r\n{\r\nu16 auxpga_vmid, auxpga_vmid_temp, auxpga_gain_temp;\r\nstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\r\nauxpga_vmid = (2 << 8) |\r\n(pi_lcn->lcnphy_rssi_vc << 4) | pi_lcn->lcnphy_rssi_vf;\r\nauxpga_vmid_temp = (2 << 8) | (8 << 4) | 4;\r\nauxpga_gain_temp = 2;\r\nmod_phy_reg(pi, 0x4d8, (0x1 << 0), (0) << 0);\r\nmod_phy_reg(pi, 0x4d8, (0x1 << 1), (0) << 1);\r\nmod_phy_reg(pi, 0x4d7, (0x1 << 3), (0) << 3);\r\nmod_phy_reg(pi, 0x4db,\r\n(0x3ff << 0) |\r\n(0x7 << 12),\r\n(auxpga_vmid << 0) | (pi_lcn->lcnphy_rssi_gs << 12));\r\nmod_phy_reg(pi, 0x4dc,\r\n(0x3ff << 0) |\r\n(0x7 << 12),\r\n(auxpga_vmid << 0) | (pi_lcn->lcnphy_rssi_gs << 12));\r\nmod_phy_reg(pi, 0x40a,\r\n(0x3ff << 0) |\r\n(0x7 << 12),\r\n(auxpga_vmid << 0) | (pi_lcn->lcnphy_rssi_gs << 12));\r\nmod_phy_reg(pi, 0x40b,\r\n(0x3ff << 0) |\r\n(0x7 << 12),\r\n(auxpga_vmid_temp << 0) | (auxpga_gain_temp << 12));\r\nmod_phy_reg(pi, 0x40c,\r\n(0x3ff << 0) |\r\n(0x7 << 12),\r\n(auxpga_vmid_temp << 0) | (auxpga_gain_temp << 12));\r\nmod_radio_reg(pi, RADIO_2064_REG082, (1 << 5), (1 << 5));\r\n}\r\nstatic void wlc_lcnphy_tssi_setup(struct brcms_phy *pi)\r\n{\r\nstruct phytbl_info tab;\r\nu32 rfseq, ind;\r\ntab.tbl_id = LCNPHY_TBL_ID_TXPWRCTL;\r\ntab.tbl_width = 32;\r\ntab.tbl_ptr = &ind;\r\ntab.tbl_len = 1;\r\ntab.tbl_offset = 0;\r\nfor (ind = 0; ind < 128; ind++) {\r\nwlc_lcnphy_write_table(pi, &tab);\r\ntab.tbl_offset++;\r\n}\r\ntab.tbl_offset = 704;\r\nfor (ind = 0; ind < 128; ind++) {\r\nwlc_lcnphy_write_table(pi, &tab);\r\ntab.tbl_offset++;\r\n}\r\nmod_phy_reg(pi, 0x503, (0x1 << 0), (0) << 0);\r\nmod_phy_reg(pi, 0x503, (0x1 << 2), (0) << 2);\r\nmod_phy_reg(pi, 0x503, (0x1 << 4), (1) << 4);\r\nwlc_lcnphy_set_tssi_mux(pi, LCNPHY_TSSI_EXT);\r\nmod_phy_reg(pi, 0x4a4, (0x1 << 14), (0) << 14);\r\nmod_phy_reg(pi, 0x4a4, (0x1 << 15), (1) << 15);\r\nmod_phy_reg(pi, 0x4d0, (0x1 << 5), (0) << 5);\r\nmod_phy_reg(pi, 0x4a4, (0x1ff << 0), (0) << 0);\r\nmod_phy_reg(pi, 0x4a5, (0xff << 0), (255) << 0);\r\nmod_phy_reg(pi, 0x4a5, (0x7 << 12), (5) << 12);\r\nmod_phy_reg(pi, 0x4a5, (0x7 << 8), (0) << 8);\r\nmod_phy_reg(pi, 0x40d, (0xff << 0), (64) << 0);\r\nmod_phy_reg(pi, 0x40d, (0x7 << 8), (4) << 8);\r\nmod_phy_reg(pi, 0x4a2, (0xff << 0), (64) << 0);\r\nmod_phy_reg(pi, 0x4a2, (0x7 << 8), (4) << 8);\r\nmod_phy_reg(pi, 0x4d0, (0x1ff << 6), (0) << 6);\r\nmod_phy_reg(pi, 0x4a8, (0xff << 0), (0x1) << 0);\r\nwlc_lcnphy_clear_tx_power_offsets(pi);\r\nmod_phy_reg(pi, 0x4a6, (0x1 << 15), (1) << 15);\r\nmod_phy_reg(pi, 0x4a6, (0x1ff << 0), (0xff) << 0);\r\nmod_phy_reg(pi, 0x49a, (0x1ff << 0), (0xff) << 0);\r\nif (LCNREV_IS(pi->pubpi.phy_rev, 2)) {\r\nmod_radio_reg(pi, RADIO_2064_REG028, 0xf, 0xe);\r\nmod_radio_reg(pi, RADIO_2064_REG086, 0x4, 0x4);\r\n} else {\r\nmod_radio_reg(pi, RADIO_2064_REG03A, 0x1, 1);\r\nmod_radio_reg(pi, RADIO_2064_REG11A, 0x8, 1 << 3);\r\n}\r\nwrite_radio_reg(pi, RADIO_2064_REG025, 0xc);\r\nif (LCNREV_IS(pi->pubpi.phy_rev, 2)) {\r\nmod_radio_reg(pi, RADIO_2064_REG03A, 0x1, 1);\r\n} else {\r\nif (CHSPEC_IS2G(pi->radio_chanspec))\r\nmod_radio_reg(pi, RADIO_2064_REG03A, 0x2, 1 << 1);\r\nelse\r\nmod_radio_reg(pi, RADIO_2064_REG03A, 0x2, 0 << 1);\r\n}\r\nif (LCNREV_IS(pi->pubpi.phy_rev, 2))\r\nmod_radio_reg(pi, RADIO_2064_REG03A, 0x2, 1 << 1);\r\nelse\r\nmod_radio_reg(pi, RADIO_2064_REG03A, 0x4, 1 << 2);\r\nmod_radio_reg(pi, RADIO_2064_REG11A, 0x1, 1 << 0);\r\nmod_radio_reg(pi, RADIO_2064_REG005, 0x8, 1 << 3);\r\nif (!wlc_lcnphy_tempsense_based_pwr_ctrl_enabled(pi))\r\nmod_phy_reg(pi, 0x4d7,\r\n(0x1 << 3) | (0x7 << 12), 0 << 3 | 2 << 12);\r\nrfseq = wlc_lcnphy_rfseq_tbl_adc_pwrup(pi);\r\ntab.tbl_id = LCNPHY_TBL_ID_RFSEQ;\r\ntab.tbl_width = 16;\r\ntab.tbl_ptr = &rfseq;\r\ntab.tbl_len = 1;\r\ntab.tbl_offset = 6;\r\nwlc_lcnphy_write_table(pi, &tab);\r\nmod_phy_reg(pi, 0x938, (0x1 << 2), (1) << 2);\r\nmod_phy_reg(pi, 0x939, (0x1 << 2), (1) << 2);\r\nmod_phy_reg(pi, 0x4a4, (0x1 << 12), (1) << 12);\r\nmod_phy_reg(pi, 0x4d7, (0x1 << 2), (1) << 2);\r\nmod_phy_reg(pi, 0x4d7, (0xf << 8), (0) << 8);\r\nwlc_lcnphy_pwrctrl_rssiparams(pi);\r\n}\r\nvoid wlc_lcnphy_tx_pwr_update_npt(struct brcms_phy *pi)\r\n{\r\nu16 tx_cnt, tx_total, npt;\r\nstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\r\ntx_total = wlc_lcnphy_total_tx_frames(pi);\r\ntx_cnt = tx_total - pi_lcn->lcnphy_tssi_tx_cnt;\r\nnpt = wlc_lcnphy_get_tx_pwr_npt(pi);\r\nif (tx_cnt > (1 << npt)) {\r\npi_lcn->lcnphy_tssi_tx_cnt = tx_total;\r\npi_lcn->lcnphy_tssi_idx = wlc_lcnphy_get_current_tx_pwr_idx(pi);\r\npi_lcn->lcnphy_tssi_npt = npt;\r\n}\r\n}\r\ns32 wlc_lcnphy_tssi2dbm(s32 tssi, s32 a1, s32 b0, s32 b1)\r\n{\r\ns32 a, b, p;\r\na = 32768 + (a1 * tssi);\r\nb = (1024 * b0) + (64 * b1 * tssi);\r\np = ((2 * b) + a) / (2 * a);\r\nreturn p;\r\n}\r\nstatic void wlc_lcnphy_txpower_reset_npt(struct brcms_phy *pi)\r\n{\r\nstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\r\nif (wlc_lcnphy_tempsense_based_pwr_ctrl_enabled(pi))\r\nreturn;\r\npi_lcn->lcnphy_tssi_idx = LCNPHY_TX_PWR_CTRL_START_INDEX_2G_4313;\r\npi_lcn->lcnphy_tssi_npt = LCNPHY_TX_PWR_CTRL_START_NPT;\r\n}\r\nvoid wlc_lcnphy_txpower_recalc_target(struct brcms_phy *pi)\r\n{\r\nstruct phytbl_info tab;\r\nu32 rate_table[BRCMS_NUM_RATES_CCK + BRCMS_NUM_RATES_OFDM +\r\nBRCMS_NUM_RATES_MCS_1_STREAM];\r\nuint i, j;\r\nif (wlc_lcnphy_tempsense_based_pwr_ctrl_enabled(pi))\r\nreturn;\r\nfor (i = 0, j = 0; i < ARRAY_SIZE(rate_table); i++, j++) {\r\nif (i == BRCMS_NUM_RATES_CCK + BRCMS_NUM_RATES_OFDM)\r\nj = TXP_FIRST_MCS_20_SISO;\r\nrate_table[i] = (u32) ((s32) (-pi->tx_power_offset[j]));\r\n}\r\ntab.tbl_id = LCNPHY_TBL_ID_TXPWRCTL;\r\ntab.tbl_width = 32;\r\ntab.tbl_len = ARRAY_SIZE(rate_table);\r\ntab.tbl_ptr = rate_table;\r\ntab.tbl_offset = LCNPHY_TX_PWR_CTRL_RATE_OFFSET;\r\nwlc_lcnphy_write_table(pi, &tab);\r\nif (wlc_lcnphy_get_target_tx_pwr(pi) != pi->tx_power_min) {\r\nwlc_lcnphy_set_target_tx_pwr(pi, pi->tx_power_min);\r\nwlc_lcnphy_txpower_reset_npt(pi);\r\n}\r\n}\r\nstatic void wlc_lcnphy_set_tx_pwr_soft_ctrl(struct brcms_phy *pi, s8 index)\r\n{\r\nu32 cck_offset[4] = { 22, 22, 22, 22 };\r\nu32 ofdm_offset, reg_offset_cck;\r\nint i;\r\nu16 index2;\r\nstruct phytbl_info tab;\r\nif (wlc_lcnphy_tssi_based_pwr_ctrl_enabled(pi))\r\nreturn;\r\nmod_phy_reg(pi, 0x4a4, (0x1 << 14), (0x1) << 14);\r\nmod_phy_reg(pi, 0x4a4, (0x1 << 14), (0x0) << 14);\r\nor_phy_reg(pi, 0x6da, 0x0040);\r\nreg_offset_cck = 0;\r\nfor (i = 0; i < 4; i++)\r\ncck_offset[i] -= reg_offset_cck;\r\ntab.tbl_id = LCNPHY_TBL_ID_TXPWRCTL;\r\ntab.tbl_width = 32;\r\ntab.tbl_len = 4;\r\ntab.tbl_ptr = cck_offset;\r\ntab.tbl_offset = LCNPHY_TX_PWR_CTRL_RATE_OFFSET;\r\nwlc_lcnphy_write_table(pi, &tab);\r\nofdm_offset = 0;\r\ntab.tbl_len = 1;\r\ntab.tbl_ptr = &ofdm_offset;\r\nfor (i = 836; i < 862; i++) {\r\ntab.tbl_offset = i;\r\nwlc_lcnphy_write_table(pi, &tab);\r\n}\r\nmod_phy_reg(pi, 0x4a4, (0x1 << 15), (0x1) << 15);\r\nmod_phy_reg(pi, 0x4a4, (0x1 << 14), (0x1) << 14);\r\nmod_phy_reg(pi, 0x4a4, (0x1 << 13), (0x1) << 13);\r\nmod_phy_reg(pi, 0x4b0, (0x1 << 7), (0) << 7);\r\nmod_phy_reg(pi, 0x43b, (0x1 << 6), (0) << 6);\r\nmod_phy_reg(pi, 0x4a9, (0x1 << 15), (1) << 15);\r\nindex2 = (u16) (index * 2);\r\nmod_phy_reg(pi, 0x4a9, (0x1ff << 0), (index2) << 0);\r\nmod_phy_reg(pi, 0x6a3, (0x1 << 4), (0) << 4);\r\n}\r\nstatic s8 wlc_lcnphy_tempcompensated_txpwrctrl(struct brcms_phy *pi)\r\n{\r\ns8 index, delta_brd, delta_temp, new_index, tempcorrx;\r\ns16 manp, meas_temp, temp_diff;\r\nbool neg = false;\r\nu16 temp;\r\nstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\r\nif (wlc_lcnphy_tssi_based_pwr_ctrl_enabled(pi))\r\nreturn pi_lcn->lcnphy_current_index;\r\nindex = FIXED_TXPWR;\r\nif (pi_lcn->lcnphy_tempsense_slope == 0)\r\nreturn index;\r\ntemp = (u16) wlc_lcnphy_tempsense(pi, 0);\r\nmeas_temp = LCNPHY_TEMPSENSE(temp);\r\nif (pi->tx_power_min != 0)\r\ndelta_brd = (pi_lcn->lcnphy_measPower - pi->tx_power_min);\r\nelse\r\ndelta_brd = 0;\r\nmanp = LCNPHY_TEMPSENSE(pi_lcn->lcnphy_rawtempsense);\r\ntemp_diff = manp - meas_temp;\r\nif (temp_diff < 0) {\r\nneg = true;\r\ntemp_diff = -temp_diff;\r\n}\r\ndelta_temp = (s8) wlc_lcnphy_qdiv_roundup((u32) (temp_diff * 192),\r\n(u32) (pi_lcn->\r\nlcnphy_tempsense_slope\r\n* 10), 0);\r\nif (neg)\r\ndelta_temp = -delta_temp;\r\nif (pi_lcn->lcnphy_tempsense_option == 3\r\n&& LCNREV_IS(pi->pubpi.phy_rev, 0))\r\ndelta_temp = 0;\r\nif (pi_lcn->lcnphy_tempcorrx > 31)\r\ntempcorrx = (s8) (pi_lcn->lcnphy_tempcorrx - 64);\r\nelse\r\ntempcorrx = (s8) pi_lcn->lcnphy_tempcorrx;\r\nif (LCNREV_IS(pi->pubpi.phy_rev, 1))\r\ntempcorrx = 4;\r\nnew_index =\r\nindex + delta_brd + delta_temp - pi_lcn->lcnphy_bandedge_corr;\r\nnew_index += tempcorrx;\r\nif (LCNREV_IS(pi->pubpi.phy_rev, 1))\r\nindex = 127;\r\nif (new_index < 0 || new_index > 126)\r\nreturn index;\r\nreturn new_index;\r\n}\r\nstatic u16 wlc_lcnphy_set_tx_pwr_ctrl_mode(struct brcms_phy *pi, u16 mode)\r\n{\r\nu16 current_mode = mode;\r\nif (wlc_lcnphy_tempsense_based_pwr_ctrl_enabled(pi) &&\r\nmode == LCNPHY_TX_PWR_CTRL_HW)\r\ncurrent_mode = LCNPHY_TX_PWR_CTRL_TEMPBASED;\r\nif (wlc_lcnphy_tssi_based_pwr_ctrl_enabled(pi) &&\r\nmode == LCNPHY_TX_PWR_CTRL_TEMPBASED)\r\ncurrent_mode = LCNPHY_TX_PWR_CTRL_HW;\r\nreturn current_mode;\r\n}\r\nvoid wlc_lcnphy_set_tx_pwr_ctrl(struct brcms_phy *pi, u16 mode)\r\n{\r\nu16 old_mode = wlc_lcnphy_get_tx_pwr_ctrl(pi);\r\ns8 index;\r\nstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\r\nmode = wlc_lcnphy_set_tx_pwr_ctrl_mode(pi, mode);\r\nold_mode = wlc_lcnphy_set_tx_pwr_ctrl_mode(pi, old_mode);\r\nmod_phy_reg(pi, 0x6da, (0x1 << 6),\r\n((LCNPHY_TX_PWR_CTRL_HW == mode) ? 1 : 0) << 6);\r\nmod_phy_reg(pi, 0x6a3, (0x1 << 4),\r\n((LCNPHY_TX_PWR_CTRL_HW == mode) ? 0 : 1) << 4);\r\nif (old_mode != mode) {\r\nif (LCNPHY_TX_PWR_CTRL_HW == old_mode) {\r\nwlc_lcnphy_tx_pwr_update_npt(pi);\r\nwlc_lcnphy_clear_tx_power_offsets(pi);\r\n}\r\nif (LCNPHY_TX_PWR_CTRL_HW == mode) {\r\nwlc_lcnphy_txpower_recalc_target(pi);\r\nwlc_lcnphy_set_start_tx_pwr_idx(pi,\r\npi_lcn->\r\nlcnphy_tssi_idx);\r\nwlc_lcnphy_set_tx_pwr_npt(pi, pi_lcn->lcnphy_tssi_npt);\r\nmod_radio_reg(pi, RADIO_2064_REG11F, 0x4, 0);\r\npi_lcn->lcnphy_tssi_tx_cnt =\r\nwlc_lcnphy_total_tx_frames(pi);\r\nwlc_lcnphy_disable_tx_gain_override(pi);\r\npi_lcn->lcnphy_tx_power_idx_override = -1;\r\n} else\r\nwlc_lcnphy_enable_tx_gain_override(pi);\r\nmod_phy_reg(pi, 0x4a4,\r\n((0x1 << 15) | (0x1 << 14) | (0x1 << 13)), mode);\r\nif (mode == LCNPHY_TX_PWR_CTRL_TEMPBASED) {\r\nindex = wlc_lcnphy_tempcompensated_txpwrctrl(pi);\r\nwlc_lcnphy_set_tx_pwr_soft_ctrl(pi, index);\r\npi_lcn->lcnphy_current_index = (s8)\r\n((read_phy_reg(pi,\r\n0x4a9) &\r\n0xFF) / 2);\r\n}\r\n}\r\n}\r\nstatic void\r\nwlc_lcnphy_tx_iqlo_loopback(struct brcms_phy *pi, u16 *values_to_save)\r\n{\r\nu16 vmid;\r\nint i;\r\nfor (i = 0; i < 20; i++)\r\nvalues_to_save[i] =\r\nread_radio_reg(pi, iqlo_loopback_rf_regs[i]);\r\nmod_phy_reg(pi, 0x44c, (0x1 << 12), 1 << 12);\r\nmod_phy_reg(pi, 0x44d, (0x1 << 14), 1 << 14);\r\nmod_phy_reg(pi, 0x44c, (0x1 << 11), 1 << 11);\r\nmod_phy_reg(pi, 0x44d, (0x1 << 13), 0 << 13);\r\nmod_phy_reg(pi, 0x43b, (0x1 << 1), 1 << 1);\r\nmod_phy_reg(pi, 0x43c, (0x1 << 1), 0 << 1);\r\nmod_phy_reg(pi, 0x43b, (0x1 << 0), 1 << 0);\r\nmod_phy_reg(pi, 0x43c, (0x1 << 0), 0 << 0);\r\nif (LCNREV_IS(pi->pubpi.phy_rev, 2))\r\nand_radio_reg(pi, RADIO_2064_REG03A, 0xFD);\r\nelse\r\nand_radio_reg(pi, RADIO_2064_REG03A, 0xF9);\r\nor_radio_reg(pi, RADIO_2064_REG11A, 0x1);\r\nor_radio_reg(pi, RADIO_2064_REG036, 0x01);\r\nor_radio_reg(pi, RADIO_2064_REG11A, 0x18);\r\nudelay(20);\r\nif (LCNREV_IS(pi->pubpi.phy_rev, 2)) {\r\nif (CHSPEC_IS5G(pi->radio_chanspec))\r\nmod_radio_reg(pi, RADIO_2064_REG03A, 1, 0);\r\nelse\r\nor_radio_reg(pi, RADIO_2064_REG03A, 1);\r\n} else {\r\nif (CHSPEC_IS5G(pi->radio_chanspec))\r\nmod_radio_reg(pi, RADIO_2064_REG03A, 3, 1);\r\nelse\r\nor_radio_reg(pi, RADIO_2064_REG03A, 0x3);\r\n}\r\nudelay(20);\r\nwrite_radio_reg(pi, RADIO_2064_REG025, 0xF);\r\nif (LCNREV_IS(pi->pubpi.phy_rev, 2)) {\r\nif (CHSPEC_IS5G(pi->radio_chanspec))\r\nmod_radio_reg(pi, RADIO_2064_REG028, 0xF, 0x4);\r\nelse\r\nmod_radio_reg(pi, RADIO_2064_REG028, 0xF, 0x6);\r\n} else {\r\nif (CHSPEC_IS5G(pi->radio_chanspec))\r\nmod_radio_reg(pi, RADIO_2064_REG028, 0x1e, 0x4 << 1);\r\nelse\r\nmod_radio_reg(pi, RADIO_2064_REG028, 0x1e, 0x6 << 1);\r\n}\r\nudelay(20);\r\nwrite_radio_reg(pi, RADIO_2064_REG005, 0x8);\r\nor_radio_reg(pi, RADIO_2064_REG112, 0x80);\r\nudelay(20);\r\nor_radio_reg(pi, RADIO_2064_REG0FF, 0x10);\r\nor_radio_reg(pi, RADIO_2064_REG11F, 0x44);\r\nudelay(20);\r\nor_radio_reg(pi, RADIO_2064_REG00B, 0x7);\r\nor_radio_reg(pi, RADIO_2064_REG113, 0x10);\r\nudelay(20);\r\nwrite_radio_reg(pi, RADIO_2064_REG007, 0x1);\r\nudelay(20);\r\nvmid = 0x2A6;\r\nmod_radio_reg(pi, RADIO_2064_REG0FC, 0x3 << 0, (vmid >> 8) & 0x3);\r\nwrite_radio_reg(pi, RADIO_2064_REG0FD, (vmid & 0xff));\r\nor_radio_reg(pi, RADIO_2064_REG11F, 0x44);\r\nudelay(20);\r\nor_radio_reg(pi, RADIO_2064_REG0FF, 0x10);\r\nudelay(20);\r\nwrite_radio_reg(pi, RADIO_2064_REG012, 0x02);\r\nor_radio_reg(pi, RADIO_2064_REG112, 0x06);\r\nwrite_radio_reg(pi, RADIO_2064_REG036, 0x11);\r\nwrite_radio_reg(pi, RADIO_2064_REG059, 0xcc);\r\nwrite_radio_reg(pi, RADIO_2064_REG05C, 0x2e);\r\nwrite_radio_reg(pi, RADIO_2064_REG078, 0xd7);\r\nwrite_radio_reg(pi, RADIO_2064_REG092, 0x15);\r\n}\r\nstatic bool wlc_lcnphy_iqcal_wait(struct brcms_phy *pi)\r\n{\r\nuint delay_count = 0;\r\nwhile (wlc_lcnphy_iqcal_active(pi)) {\r\nudelay(100);\r\ndelay_count++;\r\nif (delay_count > (10 * 500))\r\nbreak;\r\n}\r\nreturn (0 == wlc_lcnphy_iqcal_active(pi));\r\n}\r\nstatic void\r\nwlc_lcnphy_tx_iqlo_loopback_cleanup(struct brcms_phy *pi, u16 *values_to_save)\r\n{\r\nint i;\r\nand_phy_reg(pi, 0x44c, 0x0 >> 11);\r\nand_phy_reg(pi, 0x43b, 0xC);\r\nfor (i = 0; i < 20; i++)\r\nwrite_radio_reg(pi, iqlo_loopback_rf_regs[i],\r\nvalues_to_save[i]);\r\n}\r\nstatic void\r\nwlc_lcnphy_tx_iqlo_cal(struct brcms_phy *pi,\r\nstruct lcnphy_txgains *target_gains,\r\nenum lcnphy_cal_mode cal_mode, bool keep_tone)\r\n{\r\nstruct lcnphy_txgains cal_gains, temp_gains;\r\nu16 hash;\r\nu8 band_idx;\r\nint j;\r\nu16 ncorr_override[5];\r\nu16 syst_coeffs[] = { 0x0000, 0x0000, 0x0000, 0x0000, 0x0000, 0x0000,\r\n0x0000, 0x0000, 0x0000, 0x0000, 0x0000};\r\nu16 commands_fullcal[] = {\r\n0x8434, 0x8334, 0x8084, 0x8267, 0x8056, 0x8234\r\n};\r\nu16 commands_recal[] = {\r\n0x8434, 0x8334, 0x8084, 0x8267, 0x8056, 0x8234\r\n};\r\nu16 command_nums_fullcal[] = {\r\n0x7a97, 0x7a97, 0x7a97, 0x7a87, 0x7a87, 0x7b97\r\n};\r\nu16 command_nums_recal[] = {\r\n0x7a97, 0x7a97, 0x7a97, 0x7a87, 0x7a87, 0x7b97\r\n};\r\nu16 *command_nums = command_nums_fullcal;\r\nu16 *start_coeffs = NULL, *cal_cmds = NULL, cal_type, diq_start;\r\nu16 tx_pwr_ctrl_old, save_txpwrctrlrfctrl2;\r\nu16 save_sslpnCalibClkEnCtrl, save_sslpnRxFeClkEnCtrl;\r\nbool tx_gain_override_old;\r\nstruct lcnphy_txgains old_gains;\r\nuint i, n_cal_cmds = 0, n_cal_start = 0;\r\nu16 *values_to_save;\r\nstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\r\nvalues_to_save = kmalloc(sizeof(u16) * 20, GFP_ATOMIC);\r\nif (NULL == values_to_save)\r\nreturn;\r\nsave_sslpnRxFeClkEnCtrl = read_phy_reg(pi, 0x6db);\r\nsave_sslpnCalibClkEnCtrl = read_phy_reg(pi, 0x6da);\r\nor_phy_reg(pi, 0x6da, 0x40);\r\nor_phy_reg(pi, 0x6db, 0x3);\r\nswitch (cal_mode) {\r\ncase LCNPHY_CAL_FULL:\r\nstart_coeffs = syst_coeffs;\r\ncal_cmds = commands_fullcal;\r\nn_cal_cmds = ARRAY_SIZE(commands_fullcal);\r\nbreak;\r\ncase LCNPHY_CAL_RECAL:\r\nstart_coeffs = syst_coeffs;\r\ncal_cmds = commands_recal;\r\nn_cal_cmds = ARRAY_SIZE(commands_recal);\r\ncommand_nums = command_nums_recal;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nwlc_lcnphy_common_write_table(pi, LCNPHY_TBL_ID_IQLOCAL,\r\nstart_coeffs, 11, 16, 64);\r\nwrite_phy_reg(pi, 0x6da, 0xffff);\r\nmod_phy_reg(pi, 0x503, (0x1 << 3), (1) << 3);\r\ntx_pwr_ctrl_old = wlc_lcnphy_get_tx_pwr_ctrl(pi);\r\nmod_phy_reg(pi, 0x4a4, (0x1 << 12), (1) << 12);\r\nwlc_lcnphy_set_tx_pwr_ctrl(pi, LCNPHY_TX_PWR_CTRL_OFF);\r\nsave_txpwrctrlrfctrl2 = read_phy_reg(pi, 0x4db);\r\nmod_phy_reg(pi, 0x4db, (0x3ff << 0), (0x2a6) << 0);\r\nmod_phy_reg(pi, 0x4db, (0x7 << 12), (2) << 12);\r\nwlc_lcnphy_tx_iqlo_loopback(pi, values_to_save);\r\ntx_gain_override_old = wlc_lcnphy_tx_gain_override_enabled(pi);\r\nif (tx_gain_override_old)\r\nwlc_lcnphy_get_tx_gain(pi, &old_gains);\r\nif (!target_gains) {\r\nif (!tx_gain_override_old)\r\nwlc_lcnphy_set_tx_pwr_by_index(pi,\r\npi_lcn->lcnphy_tssi_idx);\r\nwlc_lcnphy_get_tx_gain(pi, &temp_gains);\r\ntarget_gains = &temp_gains;\r\n}\r\nhash = (target_gains->gm_gain << 8) |\r\n(target_gains->pga_gain << 4) | (target_gains->pad_gain);\r\nband_idx = (CHSPEC_IS5G(pi->radio_chanspec) ? 1 : 0);\r\ncal_gains = *target_gains;\r\nmemset(ncorr_override, 0, sizeof(ncorr_override));\r\nfor (j = 0; j < iqcal_gainparams_numgains_lcnphy[band_idx]; j++) {\r\nif (hash == tbl_iqcal_gainparams_lcnphy[band_idx][j][0]) {\r\ncal_gains.gm_gain =\r\ntbl_iqcal_gainparams_lcnphy[band_idx][j][1];\r\ncal_gains.pga_gain =\r\ntbl_iqcal_gainparams_lcnphy[band_idx][j][2];\r\ncal_gains.pad_gain =\r\ntbl_iqcal_gainparams_lcnphy[band_idx][j][3];\r\nmemcpy(ncorr_override,\r\n&tbl_iqcal_gainparams_lcnphy[band_idx][j][3],\r\nsizeof(ncorr_override));\r\nbreak;\r\n}\r\n}\r\nwlc_lcnphy_set_tx_gain(pi, &cal_gains);\r\nwrite_phy_reg(pi, 0x453, 0xaa9);\r\nwrite_phy_reg(pi, 0x93d, 0xc0);\r\nwlc_lcnphy_common_write_table(pi, LCNPHY_TBL_ID_IQLOCAL,\r\nlcnphy_iqcal_loft_gainladder,\r\nARRAY_SIZE(lcnphy_iqcal_loft_gainladder),\r\n16, 0);\r\nwlc_lcnphy_common_write_table(pi, LCNPHY_TBL_ID_IQLOCAL,\r\nlcnphy_iqcal_ir_gainladder,\r\nARRAY_SIZE(\r\nlcnphy_iqcal_ir_gainladder), 16,\r\n32);\r\nif (pi->phy_tx_tone_freq) {\r\nwlc_lcnphy_stop_tx_tone(pi);\r\nudelay(5);\r\nwlc_lcnphy_start_tx_tone(pi, 3750, 88, 1);\r\n} else {\r\nwlc_lcnphy_start_tx_tone(pi, 3750, 88, 1);\r\n}\r\nwrite_phy_reg(pi, 0x6da, 0xffff);\r\nfor (i = n_cal_start; i < n_cal_cmds; i++) {\r\nu16 zero_diq = 0;\r\nu16 best_coeffs[11];\r\nu16 command_num;\r\ncal_type = (cal_cmds[i] & 0x0f00) >> 8;\r\ncommand_num = command_nums[i];\r\nif (ncorr_override[cal_type])\r\ncommand_num =\r\nncorr_override[cal_type] << 8 | (command_num &\r\n0xff);\r\nwrite_phy_reg(pi, 0x452, command_num);\r\nif ((cal_type == 3) || (cal_type == 4)) {\r\nwlc_lcnphy_common_read_table(pi, LCNPHY_TBL_ID_IQLOCAL,\r\n&diq_start, 1, 16, 69);\r\nwlc_lcnphy_common_write_table(pi, LCNPHY_TBL_ID_IQLOCAL,\r\n&zero_diq, 1, 16, 69);\r\n}\r\nwrite_phy_reg(pi, 0x451, cal_cmds[i]);\r\nif (!wlc_lcnphy_iqcal_wait(pi))\r\ngoto cleanup;\r\nwlc_lcnphy_common_read_table(pi, LCNPHY_TBL_ID_IQLOCAL,\r\nbest_coeffs,\r\nARRAY_SIZE(best_coeffs), 16, 96);\r\nwlc_lcnphy_common_write_table(pi, LCNPHY_TBL_ID_IQLOCAL,\r\nbest_coeffs,\r\nARRAY_SIZE(best_coeffs), 16, 64);\r\nif ((cal_type == 3) || (cal_type == 4))\r\nwlc_lcnphy_common_write_table(pi, LCNPHY_TBL_ID_IQLOCAL,\r\n&diq_start, 1, 16, 69);\r\nwlc_lcnphy_common_read_table(pi, LCNPHY_TBL_ID_IQLOCAL,\r\npi_lcn->lcnphy_cal_results.\r\ntxiqlocal_bestcoeffs,\r\nARRAY_SIZE(pi_lcn->\r\nlcnphy_cal_results.\r\ntxiqlocal_bestcoeffs),\r\n16, 96);\r\n}\r\nwlc_lcnphy_common_read_table(pi, LCNPHY_TBL_ID_IQLOCAL,\r\npi_lcn->lcnphy_cal_results.\r\ntxiqlocal_bestcoeffs,\r\nARRAY_SIZE(pi_lcn->lcnphy_cal_results.\r\ntxiqlocal_bestcoeffs), 16, 96);\r\npi_lcn->lcnphy_cal_results.txiqlocal_bestcoeffs_valid = true;\r\nwlc_lcnphy_common_write_table(pi, LCNPHY_TBL_ID_IQLOCAL,\r\n&pi_lcn->lcnphy_cal_results.\r\ntxiqlocal_bestcoeffs[0], 4, 16, 80);\r\nwlc_lcnphy_common_write_table(pi, LCNPHY_TBL_ID_IQLOCAL,\r\n&pi_lcn->lcnphy_cal_results.\r\ntxiqlocal_bestcoeffs[5], 2, 16, 85);\r\ncleanup:\r\nwlc_lcnphy_tx_iqlo_loopback_cleanup(pi, values_to_save);\r\nkfree(values_to_save);\r\nif (!keep_tone)\r\nwlc_lcnphy_stop_tx_tone(pi);\r\nwrite_phy_reg(pi, 0x4db, save_txpwrctrlrfctrl2);\r\nwrite_phy_reg(pi, 0x453, 0);\r\nif (tx_gain_override_old)\r\nwlc_lcnphy_set_tx_gain(pi, &old_gains);\r\nwlc_lcnphy_set_tx_pwr_ctrl(pi, tx_pwr_ctrl_old);\r\nwrite_phy_reg(pi, 0x6da, save_sslpnCalibClkEnCtrl);\r\nwrite_phy_reg(pi, 0x6db, save_sslpnRxFeClkEnCtrl);\r\n}\r\nstatic void wlc_lcnphy_idle_tssi_est(struct brcms_phy_pub *ppi)\r\n{\r\nbool suspend, tx_gain_override_old;\r\nstruct lcnphy_txgains old_gains;\r\nstruct brcms_phy *pi = (struct brcms_phy *) ppi;\r\nu16 idleTssi, idleTssi0_2C, idleTssi0_OB, idleTssi0_regvalue_OB,\r\nidleTssi0_regvalue_2C;\r\nu16 SAVE_txpwrctrl = wlc_lcnphy_get_tx_pwr_ctrl(pi);\r\nu16 SAVE_lpfgain = read_radio_reg(pi, RADIO_2064_REG112);\r\nu16 SAVE_jtag_bb_afe_switch =\r\nread_radio_reg(pi, RADIO_2064_REG007) & 1;\r\nu16 SAVE_jtag_auxpga = read_radio_reg(pi, RADIO_2064_REG0FF) & 0x10;\r\nu16 SAVE_iqadc_aux_en = read_radio_reg(pi, RADIO_2064_REG11F) & 4;\r\nidleTssi = read_phy_reg(pi, 0x4ab);\r\nsuspend = (0 == (bcma_read32(pi->d11core, D11REGOFFS(maccontrol)) &\r\nMCTL_EN_MAC));\r\nif (!suspend)\r\nwlapi_suspend_mac_and_wait(pi->sh->physhim);\r\nwlc_lcnphy_set_tx_pwr_ctrl(pi, LCNPHY_TX_PWR_CTRL_OFF);\r\ntx_gain_override_old = wlc_lcnphy_tx_gain_override_enabled(pi);\r\nwlc_lcnphy_get_tx_gain(pi, &old_gains);\r\nwlc_lcnphy_enable_tx_gain_override(pi);\r\nwlc_lcnphy_set_tx_pwr_by_index(pi, 127);\r\nwrite_radio_reg(pi, RADIO_2064_REG112, 0x6);\r\nmod_radio_reg(pi, RADIO_2064_REG007, 0x1, 1);\r\nmod_radio_reg(pi, RADIO_2064_REG0FF, 0x10, 1 << 4);\r\nmod_radio_reg(pi, RADIO_2064_REG11F, 0x4, 1 << 2);\r\nwlc_lcnphy_tssi_setup(pi);\r\nwlc_phy_do_dummy_tx(pi, true, OFF);\r\nidleTssi = ((read_phy_reg(pi, 0x4ab) & (0x1ff << 0))\r\n>> 0);\r\nidleTssi0_2C = ((read_phy_reg(pi, 0x63e) & (0x1ff << 0))\r\n>> 0);\r\nif (idleTssi0_2C >= 256)\r\nidleTssi0_OB = idleTssi0_2C - 256;\r\nelse\r\nidleTssi0_OB = idleTssi0_2C + 256;\r\nidleTssi0_regvalue_OB = idleTssi0_OB;\r\nif (idleTssi0_regvalue_OB >= 256)\r\nidleTssi0_regvalue_2C = idleTssi0_regvalue_OB - 256;\r\nelse\r\nidleTssi0_regvalue_2C = idleTssi0_regvalue_OB + 256;\r\nmod_phy_reg(pi, 0x4a6, (0x1ff << 0), (idleTssi0_regvalue_2C) << 0);\r\nmod_phy_reg(pi, 0x44c, (0x1 << 12), (0) << 12);\r\nwlc_lcnphy_set_tx_gain_override(pi, tx_gain_override_old);\r\nwlc_lcnphy_set_tx_gain(pi, &old_gains);\r\nwlc_lcnphy_set_tx_pwr_ctrl(pi, SAVE_txpwrctrl);\r\nwrite_radio_reg(pi, RADIO_2064_REG112, SAVE_lpfgain);\r\nmod_radio_reg(pi, RADIO_2064_REG007, 0x1, SAVE_jtag_bb_afe_switch);\r\nmod_radio_reg(pi, RADIO_2064_REG0FF, 0x10, SAVE_jtag_auxpga);\r\nmod_radio_reg(pi, RADIO_2064_REG11F, 0x4, SAVE_iqadc_aux_en);\r\nmod_radio_reg(pi, RADIO_2064_REG112, 0x80, 1 << 7);\r\nif (!suspend)\r\nwlapi_enable_mac(pi->sh->physhim);\r\n}\r\nstatic void wlc_lcnphy_vbat_temp_sense_setup(struct brcms_phy *pi, u8 mode)\r\n{\r\nbool suspend;\r\nu16 save_txpwrCtrlEn;\r\nu8 auxpga_vmidcourse, auxpga_vmidfine, auxpga_gain;\r\nu16 auxpga_vmid;\r\nstruct phytbl_info tab;\r\nu32 val;\r\nu8 save_reg007, save_reg0FF, save_reg11F, save_reg005, save_reg025,\r\nsave_reg112;\r\nu16 values_to_save[14];\r\ns8 index;\r\nint i;\r\nstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\r\nudelay(999);\r\nsave_reg007 = (u8) read_radio_reg(pi, RADIO_2064_REG007);\r\nsave_reg0FF = (u8) read_radio_reg(pi, RADIO_2064_REG0FF);\r\nsave_reg11F = (u8) read_radio_reg(pi, RADIO_2064_REG11F);\r\nsave_reg005 = (u8) read_radio_reg(pi, RADIO_2064_REG005);\r\nsave_reg025 = (u8) read_radio_reg(pi, RADIO_2064_REG025);\r\nsave_reg112 = (u8) read_radio_reg(pi, RADIO_2064_REG112);\r\nfor (i = 0; i < 14; i++)\r\nvalues_to_save[i] = read_phy_reg(pi, tempsense_phy_regs[i]);\r\nsuspend = (0 == (bcma_read32(pi->d11core, D11REGOFFS(maccontrol)) &\r\nMCTL_EN_MAC));\r\nif (!suspend)\r\nwlapi_suspend_mac_and_wait(pi->sh->physhim);\r\nsave_txpwrCtrlEn = read_radio_reg(pi, 0x4a4);\r\nwlc_lcnphy_set_tx_pwr_ctrl(pi, LCNPHY_TX_PWR_CTRL_OFF);\r\nindex = pi_lcn->lcnphy_current_index;\r\nwlc_lcnphy_set_tx_pwr_by_index(pi, 127);\r\nmod_radio_reg(pi, RADIO_2064_REG007, 0x1, 0x1);\r\nmod_radio_reg(pi, RADIO_2064_REG0FF, 0x10, 0x1 << 4);\r\nmod_radio_reg(pi, RADIO_2064_REG11F, 0x4, 0x1 << 2);\r\nmod_phy_reg(pi, 0x503, (0x1 << 0), (0) << 0);\r\nmod_phy_reg(pi, 0x503, (0x1 << 2), (0) << 2);\r\nmod_phy_reg(pi, 0x4a4, (0x1 << 14), (0) << 14);\r\nmod_phy_reg(pi, 0x4a4, (0x1 << 15), (0) << 15);\r\nmod_phy_reg(pi, 0x4d0, (0x1 << 5), (0) << 5);\r\nmod_phy_reg(pi, 0x4a5, (0xff << 0), (255) << 0);\r\nmod_phy_reg(pi, 0x4a5, (0x7 << 12), (5) << 12);\r\nmod_phy_reg(pi, 0x4a5, (0x7 << 8), (0) << 8);\r\nmod_phy_reg(pi, 0x40d, (0xff << 0), (64) << 0);\r\nmod_phy_reg(pi, 0x40d, (0x7 << 8), (6) << 8);\r\nmod_phy_reg(pi, 0x4a2, (0xff << 0), (64) << 0);\r\nmod_phy_reg(pi, 0x4a2, (0x7 << 8), (6) << 8);\r\nmod_phy_reg(pi, 0x4d9, (0x7 << 4), (2) << 4);\r\nmod_phy_reg(pi, 0x4d9, (0x7 << 8), (3) << 8);\r\nmod_phy_reg(pi, 0x4d9, (0x7 << 12), (1) << 12);\r\nmod_phy_reg(pi, 0x4da, (0x1 << 12), (0) << 12);\r\nmod_phy_reg(pi, 0x4da, (0x1 << 13), (1) << 13);\r\nmod_phy_reg(pi, 0x4a6, (0x1 << 15), (1) << 15);\r\nwrite_radio_reg(pi, RADIO_2064_REG025, 0xC);\r\nmod_radio_reg(pi, RADIO_2064_REG005, 0x8, 0x1 << 3);\r\nmod_phy_reg(pi, 0x938, (0x1 << 2), (1) << 2);\r\nmod_phy_reg(pi, 0x939, (0x1 << 2), (1) << 2);\r\nmod_phy_reg(pi, 0x4a4, (0x1 << 12), (1) << 12);\r\nval = wlc_lcnphy_rfseq_tbl_adc_pwrup(pi);\r\ntab.tbl_id = LCNPHY_TBL_ID_RFSEQ;\r\ntab.tbl_width = 16;\r\ntab.tbl_len = 1;\r\ntab.tbl_ptr = &val;\r\ntab.tbl_offset = 6;\r\nwlc_lcnphy_write_table(pi, &tab);\r\nif (mode == TEMPSENSE) {\r\nmod_phy_reg(pi, 0x4d7, (0x1 << 3), (1) << 3);\r\nmod_phy_reg(pi, 0x4d7, (0x7 << 12), (1) << 12);\r\nauxpga_vmidcourse = 8;\r\nauxpga_vmidfine = 0x4;\r\nauxpga_gain = 2;\r\nmod_radio_reg(pi, RADIO_2064_REG082, 0x20, 1 << 5);\r\n} else {\r\nmod_phy_reg(pi, 0x4d7, (0x1 << 3), (1) << 3);\r\nmod_phy_reg(pi, 0x4d7, (0x7 << 12), (3) << 12);\r\nauxpga_vmidcourse = 7;\r\nauxpga_vmidfine = 0xa;\r\nauxpga_gain = 2;\r\n}\r\nauxpga_vmid =\r\n(u16) ((2 << 8) | (auxpga_vmidcourse << 4) | auxpga_vmidfine);\r\nmod_phy_reg(pi, 0x4d8, (0x1 << 0), (1) << 0);\r\nmod_phy_reg(pi, 0x4d8, (0x3ff << 2), (auxpga_vmid) << 2);\r\nmod_phy_reg(pi, 0x4d8, (0x1 << 1), (1) << 1);\r\nmod_phy_reg(pi, 0x4d8, (0x7 << 12), (auxpga_gain) << 12);\r\nmod_phy_reg(pi, 0x4d0, (0x1 << 5), (1) << 5);\r\nwrite_radio_reg(pi, RADIO_2064_REG112, 0x6);\r\nwlc_phy_do_dummy_tx(pi, true, OFF);\r\nif (!tempsense_done(pi))\r\nudelay(10);\r\nwrite_radio_reg(pi, RADIO_2064_REG007, (u16) save_reg007);\r\nwrite_radio_reg(pi, RADIO_2064_REG0FF, (u16) save_reg0FF);\r\nwrite_radio_reg(pi, RADIO_2064_REG11F, (u16) save_reg11F);\r\nwrite_radio_reg(pi, RADIO_2064_REG005, (u16) save_reg005);\r\nwrite_radio_reg(pi, RADIO_2064_REG025, (u16) save_reg025);\r\nwrite_radio_reg(pi, RADIO_2064_REG112, (u16) save_reg112);\r\nfor (i = 0; i < 14; i++)\r\nwrite_phy_reg(pi, tempsense_phy_regs[i], values_to_save[i]);\r\nwlc_lcnphy_set_tx_pwr_by_index(pi, (int)index);\r\nwrite_radio_reg(pi, 0x4a4, save_txpwrCtrlEn);\r\nif (!suspend)\r\nwlapi_enable_mac(pi->sh->physhim);\r\nudelay(999);\r\n}\r\nstatic void wlc_lcnphy_tx_pwr_ctrl_init(struct brcms_phy_pub *ppi)\r\n{\r\nstruct lcnphy_txgains tx_gains;\r\nu8 bbmult;\r\nstruct phytbl_info tab;\r\ns32 a1, b0, b1;\r\ns32 tssi, pwr, maxtargetpwr, mintargetpwr;\r\nbool suspend;\r\nstruct brcms_phy *pi = (struct brcms_phy *) ppi;\r\nsuspend = (0 == (bcma_read32(pi->d11core, D11REGOFFS(maccontrol)) &\r\nMCTL_EN_MAC));\r\nif (!suspend)\r\nwlapi_suspend_mac_and_wait(pi->sh->physhim);\r\nif (!pi->hwpwrctrl_capable) {\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\ntx_gains.gm_gain = 4;\r\ntx_gains.pga_gain = 12;\r\ntx_gains.pad_gain = 12;\r\ntx_gains.dac_gain = 0;\r\nbbmult = 150;\r\n} else {\r\ntx_gains.gm_gain = 7;\r\ntx_gains.pga_gain = 15;\r\ntx_gains.pad_gain = 14;\r\ntx_gains.dac_gain = 0;\r\nbbmult = 150;\r\n}\r\nwlc_lcnphy_set_tx_gain(pi, &tx_gains);\r\nwlc_lcnphy_set_bbmult(pi, bbmult);\r\nwlc_lcnphy_vbat_temp_sense_setup(pi, TEMPSENSE);\r\n} else {\r\nwlc_lcnphy_idle_tssi_est(ppi);\r\nwlc_lcnphy_clear_tx_power_offsets(pi);\r\nb0 = pi->txpa_2g[0];\r\nb1 = pi->txpa_2g[1];\r\na1 = pi->txpa_2g[2];\r\nmaxtargetpwr = wlc_lcnphy_tssi2dbm(10, a1, b0, b1);\r\nmintargetpwr = wlc_lcnphy_tssi2dbm(125, a1, b0, b1);\r\ntab.tbl_id = LCNPHY_TBL_ID_TXPWRCTL;\r\ntab.tbl_width = 32;\r\ntab.tbl_ptr = &pwr;\r\ntab.tbl_len = 1;\r\ntab.tbl_offset = 0;\r\nfor (tssi = 0; tssi < 128; tssi++) {\r\npwr = wlc_lcnphy_tssi2dbm(tssi, a1, b0, b1);\r\npwr = (pwr < mintargetpwr) ? mintargetpwr : pwr;\r\nwlc_lcnphy_write_table(pi, &tab);\r\ntab.tbl_offset++;\r\n}\r\nmod_phy_reg(pi, 0x410, (0x1 << 7), (0) << 7);\r\nwrite_phy_reg(pi, 0x4a8, 10);\r\nwlc_lcnphy_set_target_tx_pwr(pi, LCN_TARGET_PWR);\r\nwlc_lcnphy_set_tx_pwr_ctrl(pi, LCNPHY_TX_PWR_CTRL_HW);\r\n}\r\nif (!suspend)\r\nwlapi_enable_mac(pi->sh->physhim);\r\n}\r\nstatic void wlc_lcnphy_set_pa_gain(struct brcms_phy *pi, u16 gain)\r\n{\r\nmod_phy_reg(pi, 0x4fb,\r\nLCNPHY_txgainctrlovrval1_pagain_ovr_val1_MASK,\r\ngain << LCNPHY_txgainctrlovrval1_pagain_ovr_val1_SHIFT);\r\nmod_phy_reg(pi, 0x4fd,\r\nLCNPHY_stxtxgainctrlovrval1_pagain_ovr_val1_MASK,\r\ngain << LCNPHY_stxtxgainctrlovrval1_pagain_ovr_val1_SHIFT);\r\n}\r\nvoid\r\nwlc_lcnphy_get_radio_loft(struct brcms_phy *pi,\r\nu8 *ei0, u8 *eq0, u8 *fi0, u8 *fq0)\r\n{\r\n*ei0 = LCNPHY_IQLOCC_READ(read_radio_reg(pi, RADIO_2064_REG089));\r\n*eq0 = LCNPHY_IQLOCC_READ(read_radio_reg(pi, RADIO_2064_REG08A));\r\n*fi0 = LCNPHY_IQLOCC_READ(read_radio_reg(pi, RADIO_2064_REG08B));\r\n*fq0 = LCNPHY_IQLOCC_READ(read_radio_reg(pi, RADIO_2064_REG08C));\r\n}\r\nvoid wlc_lcnphy_set_tx_iqcc(struct brcms_phy *pi, u16 a, u16 b)\r\n{\r\nstruct phytbl_info tab;\r\nu16 iqcc[2];\r\niqcc[0] = a;\r\niqcc[1] = b;\r\ntab.tbl_id = LCNPHY_TBL_ID_IQLOCAL;\r\ntab.tbl_width = 16;\r\ntab.tbl_ptr = iqcc;\r\ntab.tbl_len = 2;\r\ntab.tbl_offset = 80;\r\nwlc_lcnphy_write_table(pi, &tab);\r\n}\r\nvoid wlc_lcnphy_set_tx_locc(struct brcms_phy *pi, u16 didq)\r\n{\r\nstruct phytbl_info tab;\r\ntab.tbl_id = LCNPHY_TBL_ID_IQLOCAL;\r\ntab.tbl_width = 16;\r\ntab.tbl_ptr = &didq;\r\ntab.tbl_len = 1;\r\ntab.tbl_offset = 85;\r\nwlc_lcnphy_write_table(pi, &tab);\r\n}\r\nvoid wlc_lcnphy_set_tx_pwr_by_index(struct brcms_phy *pi, int index)\r\n{\r\nstruct phytbl_info tab;\r\nu16 a, b;\r\nu8 bb_mult;\r\nu32 bbmultiqcomp, txgain, locoeffs, rfpower;\r\nstruct lcnphy_txgains gains;\r\nstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\r\npi_lcn->lcnphy_tx_power_idx_override = (s8) index;\r\npi_lcn->lcnphy_current_index = (u8) index;\r\ntab.tbl_id = LCNPHY_TBL_ID_TXPWRCTL;\r\ntab.tbl_width = 32;\r\ntab.tbl_len = 1;\r\nwlc_lcnphy_set_tx_pwr_ctrl(pi, LCNPHY_TX_PWR_CTRL_OFF);\r\ntab.tbl_offset = LCNPHY_TX_PWR_CTRL_IQ_OFFSET + index;\r\ntab.tbl_ptr = &bbmultiqcomp;\r\nwlc_lcnphy_read_table(pi, &tab);\r\ntab.tbl_offset = LCNPHY_TX_PWR_CTRL_GAIN_OFFSET + index;\r\ntab.tbl_width = 32;\r\ntab.tbl_ptr = &txgain;\r\nwlc_lcnphy_read_table(pi, &tab);\r\ngains.gm_gain = (u16) (txgain & 0xff);\r\ngains.pga_gain = (u16) (txgain >> 8) & 0xff;\r\ngains.pad_gain = (u16) (txgain >> 16) & 0xff;\r\ngains.dac_gain = (u16) (bbmultiqcomp >> 28) & 0x07;\r\nwlc_lcnphy_set_tx_gain(pi, &gains);\r\nwlc_lcnphy_set_pa_gain(pi, (u16) (txgain >> 24) & 0x7f);\r\nbb_mult = (u8) ((bbmultiqcomp >> 20) & 0xff);\r\nwlc_lcnphy_set_bbmult(pi, bb_mult);\r\nwlc_lcnphy_enable_tx_gain_override(pi);\r\nif (!wlc_lcnphy_tempsense_based_pwr_ctrl_enabled(pi)) {\r\na = (u16) ((bbmultiqcomp >> 10) & 0x3ff);\r\nb = (u16) (bbmultiqcomp & 0x3ff);\r\nwlc_lcnphy_set_tx_iqcc(pi, a, b);\r\ntab.tbl_offset = LCNPHY_TX_PWR_CTRL_LO_OFFSET + index;\r\ntab.tbl_ptr = &locoeffs;\r\nwlc_lcnphy_read_table(pi, &tab);\r\nwlc_lcnphy_set_tx_locc(pi, (u16) locoeffs);\r\ntab.tbl_offset = LCNPHY_TX_PWR_CTRL_PWR_OFFSET + index;\r\ntab.tbl_ptr = &rfpower;\r\nwlc_lcnphy_read_table(pi, &tab);\r\nmod_phy_reg(pi, 0x6a6, (0x1fff << 0), (rfpower * 8) << 0);\r\n}\r\n}\r\nstatic void wlc_lcnphy_clear_papd_comptable(struct brcms_phy *pi)\r\n{\r\nu32 j;\r\nstruct phytbl_info tab;\r\nu32 temp_offset[128];\r\ntab.tbl_ptr = temp_offset;\r\ntab.tbl_len = 128;\r\ntab.tbl_id = LCNPHY_TBL_ID_PAPDCOMPDELTATBL;\r\ntab.tbl_width = 32;\r\ntab.tbl_offset = 0;\r\nmemset(temp_offset, 0, sizeof(temp_offset));\r\nfor (j = 1; j < 128; j += 2)\r\ntemp_offset[j] = 0x80000;\r\nwlc_lcnphy_write_table(pi, &tab);\r\nreturn;\r\n}\r\nvoid wlc_lcnphy_tx_pu(struct brcms_phy *pi, bool bEnable)\r\n{\r\nif (!bEnable) {\r\nand_phy_reg(pi, 0x43b, ~(u16) ((0x1 << 1) | (0x1 << 4)));\r\nmod_phy_reg(pi, 0x43c, (0x1 << 1), 1 << 1);\r\nand_phy_reg(pi, 0x44c,\r\n~(u16) ((0x1 << 3) |\r\n(0x1 << 5) |\r\n(0x1 << 12) |\r\n(0x1 << 0) | (0x1 << 1) | (0x1 << 2)));\r\nand_phy_reg(pi, 0x44d,\r\n~(u16) ((0x1 << 3) | (0x1 << 5) | (0x1 << 14)));\r\nmod_phy_reg(pi, 0x44d, (0x1 << 2), 1 << 2);\r\nmod_phy_reg(pi, 0x44d, (0x1 << 1) | (0x1 << 0), (0x1 << 0));\r\nand_phy_reg(pi, 0x4f9,\r\n~(u16) ((0x1 << 0) | (0x1 << 1) | (0x1 << 2)));\r\nand_phy_reg(pi, 0x4fa,\r\n~(u16) ((0x1 << 0) | (0x1 << 1) | (0x1 << 2)));\r\n} else {\r\nmod_phy_reg(pi, 0x43b, (0x1 << 1), 1 << 1);\r\nmod_phy_reg(pi, 0x43c, (0x1 << 1), 0 << 1);\r\nmod_phy_reg(pi, 0x43b, (0x1 << 4), 1 << 4);\r\nmod_phy_reg(pi, 0x43c, (0x1 << 6), 0 << 6);\r\nmod_phy_reg(pi, 0x44c, (0x1 << 12), 1 << 12);\r\nmod_phy_reg(pi, 0x44d, (0x1 << 14), 1 << 14);\r\nwlc_lcnphy_set_trsw_override(pi, true, false);\r\nmod_phy_reg(pi, 0x44d, (0x1 << 2), 0 << 2);\r\nmod_phy_reg(pi, 0x44c, (0x1 << 2), 1 << 2);\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nmod_phy_reg(pi, 0x44c, (0x1 << 3), 1 << 3);\r\nmod_phy_reg(pi, 0x44d, (0x1 << 3), 1 << 3);\r\nmod_phy_reg(pi, 0x44c, (0x1 << 5), 1 << 5);\r\nmod_phy_reg(pi, 0x44d, (0x1 << 5), 0 << 5);\r\nmod_phy_reg(pi, 0x4f9, (0x1 << 1), 1 << 1);\r\nmod_phy_reg(pi, 0x4fa, (0x1 << 1), 1 << 1);\r\nmod_phy_reg(pi, 0x4f9, (0x1 << 2), 1 << 2);\r\nmod_phy_reg(pi, 0x4fa, (0x1 << 2), 1 << 2);\r\nmod_phy_reg(pi, 0x4f9, (0x1 << 0), 1 << 0);\r\nmod_phy_reg(pi, 0x4fa, (0x1 << 0), 1 << 0);\r\n} else {\r\nmod_phy_reg(pi, 0x44c, (0x1 << 3), 1 << 3);\r\nmod_phy_reg(pi, 0x44d, (0x1 << 3), 0 << 3);\r\nmod_phy_reg(pi, 0x44c, (0x1 << 5), 1 << 5);\r\nmod_phy_reg(pi, 0x44d, (0x1 << 5), 1 << 5);\r\nmod_phy_reg(pi, 0x4f9, (0x1 << 1), 1 << 1);\r\nmod_phy_reg(pi, 0x4fa, (0x1 << 1), 0 << 1);\r\nmod_phy_reg(pi, 0x4f9, (0x1 << 2), 1 << 2);\r\nmod_phy_reg(pi, 0x4fa, (0x1 << 2), 0 << 2);\r\nmod_phy_reg(pi, 0x4f9, (0x1 << 0), 1 << 0);\r\nmod_phy_reg(pi, 0x4fa, (0x1 << 0), 0 << 0);\r\n}\r\n}\r\n}\r\nstatic void\r\nwlc_lcnphy_run_samples(struct brcms_phy *pi,\r\nu16 num_samps,\r\nu16 num_loops, u16 wait, bool iqcalmode)\r\n{\r\nor_phy_reg(pi, 0x6da, 0x8080);\r\nmod_phy_reg(pi, 0x642, (0x7f << 0), (num_samps - 1) << 0);\r\nif (num_loops != 0xffff)\r\nnum_loops--;\r\nmod_phy_reg(pi, 0x640, (0xffff << 0), num_loops << 0);\r\nmod_phy_reg(pi, 0x641, (0xffff << 0), wait << 0);\r\nif (iqcalmode) {\r\nand_phy_reg(pi, 0x453, (u16) ~(0x1 << 15));\r\nor_phy_reg(pi, 0x453, (0x1 << 15));\r\n} else {\r\nwrite_phy_reg(pi, 0x63f, 1);\r\nwlc_lcnphy_tx_pu(pi, 1);\r\n}\r\nor_radio_reg(pi, RADIO_2064_REG112, 0x6);\r\n}\r\nvoid wlc_lcnphy_deaf_mode(struct brcms_phy *pi, bool mode)\r\n{\r\nu8 phybw40;\r\nphybw40 = CHSPEC_IS40(pi->radio_chanspec);\r\nif (LCNREV_LT(pi->pubpi.phy_rev, 2)) {\r\nmod_phy_reg(pi, 0x4b0, (0x1 << 5), (mode) << 5);\r\nmod_phy_reg(pi, 0x4b1, (0x1 << 9), 0 << 9);\r\n} else {\r\nmod_phy_reg(pi, 0x4b0, (0x1 << 5), (mode) << 5);\r\nmod_phy_reg(pi, 0x4b1, (0x1 << 9), 0 << 9);\r\n}\r\nif (phybw40 == 0) {\r\nmod_phy_reg((pi), 0x410,\r\n(0x1 << 6) |\r\n(0x1 << 5),\r\n((CHSPEC_IS2G(\r\npi->radio_chanspec)) ? (!mode) : 0) <<\r\n6 | (!mode) << 5);\r\nmod_phy_reg(pi, 0x410, (0x1 << 7), (mode) << 7);\r\n}\r\n}\r\nvoid\r\nwlc_lcnphy_start_tx_tone(struct brcms_phy *pi, s32 f_kHz, u16 max_val,\r\nbool iqcalmode)\r\n{\r\nu8 phy_bw;\r\nu16 num_samps, t, k;\r\nu32 bw;\r\ns32 theta = 0, rot = 0;\r\nstruct cordic_iq tone_samp;\r\nu32 data_buf[64];\r\nu16 i_samp, q_samp;\r\nstruct phytbl_info tab;\r\nstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\r\npi->phy_tx_tone_freq = f_kHz;\r\nwlc_lcnphy_deaf_mode(pi, true);\r\nphy_bw = 40;\r\nif (pi_lcn->lcnphy_spurmod) {\r\nwrite_phy_reg(pi, 0x942, 0x2);\r\nwrite_phy_reg(pi, 0x93b, 0x0);\r\nwrite_phy_reg(pi, 0x93c, 0x0);\r\nwlc_lcnphy_txrx_spur_avoidance_mode(pi, false);\r\n}\r\nif (f_kHz) {\r\nk = 1;\r\ndo {\r\nbw = phy_bw * 1000 * k;\r\nnum_samps = bw / abs(f_kHz);\r\nk++;\r\n} while ((num_samps * (u32) (abs(f_kHz))) != bw);\r\n} else\r\nnum_samps = 2;\r\nrot = ((f_kHz * 36) / phy_bw) / 100;\r\ntheta = 0;\r\nfor (t = 0; t < num_samps; t++) {\r\ntone_samp = cordic_calc_iq(theta);\r\ntheta += rot;\r\ni_samp = (u16) (FLOAT(tone_samp.i * max_val) & 0x3ff);\r\nq_samp = (u16) (FLOAT(tone_samp.q * max_val) & 0x3ff);\r\ndata_buf[t] = (i_samp << 10) | q_samp;\r\n}\r\nmod_phy_reg(pi, 0x6d6, (0x3 << 0), 0 << 0);\r\nmod_phy_reg(pi, 0x6da, (0x1 << 3), 1 << 3);\r\ntab.tbl_ptr = data_buf;\r\ntab.tbl_len = num_samps;\r\ntab.tbl_id = LCNPHY_TBL_ID_SAMPLEPLAY;\r\ntab.tbl_offset = 0;\r\ntab.tbl_width = 32;\r\nwlc_lcnphy_write_table(pi, &tab);\r\nwlc_lcnphy_run_samples(pi, num_samps, 0xffff, 0, iqcalmode);\r\n}\r\nvoid wlc_lcnphy_stop_tx_tone(struct brcms_phy *pi)\r\n{\r\ns16 playback_status;\r\nstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\r\npi->phy_tx_tone_freq = 0;\r\nif (pi_lcn->lcnphy_spurmod) {\r\nwrite_phy_reg(pi, 0x942, 0x7);\r\nwrite_phy_reg(pi, 0x93b, 0x2017);\r\nwrite_phy_reg(pi, 0x93c, 0x27c5);\r\nwlc_lcnphy_txrx_spur_avoidance_mode(pi, true);\r\n}\r\nplayback_status = read_phy_reg(pi, 0x644);\r\nif (playback_status & (0x1 << 0)) {\r\nwlc_lcnphy_tx_pu(pi, 0);\r\nmod_phy_reg(pi, 0x63f, (0x1 << 1), 1 << 1);\r\n} else if (playback_status & (0x1 << 1))\r\nmod_phy_reg(pi, 0x453, (0x1 << 15), 0 << 15);\r\nmod_phy_reg(pi, 0x6d6, (0x3 << 0), 1 << 0);\r\nmod_phy_reg(pi, 0x6da, (0x1 << 3), 0 << 3);\r\nmod_phy_reg(pi, 0x6da, (0x1 << 7), 0 << 7);\r\nand_radio_reg(pi, RADIO_2064_REG112, 0xFFF9);\r\nwlc_lcnphy_deaf_mode(pi, false);\r\n}\r\nstatic void\r\nwlc_lcnphy_set_cc(struct brcms_phy *pi, int cal_type, s16 coeff_x, s16 coeff_y)\r\n{\r\nu16 di0dq0;\r\nu16 x, y, data_rf;\r\nint k;\r\nswitch (cal_type) {\r\ncase 0:\r\nwlc_lcnphy_set_tx_iqcc(pi, coeff_x, coeff_y);\r\nbreak;\r\ncase 2:\r\ndi0dq0 = (coeff_x & 0xff) << 8 | (coeff_y & 0xff);\r\nwlc_lcnphy_set_tx_locc(pi, di0dq0);\r\nbreak;\r\ncase 3:\r\nk = wlc_lcnphy_calc_floor(coeff_x, 0);\r\ny = 8 + k;\r\nk = wlc_lcnphy_calc_floor(coeff_x, 1);\r\nx = 8 - k;\r\ndata_rf = (x * 16 + y);\r\nwrite_radio_reg(pi, RADIO_2064_REG089, data_rf);\r\nk = wlc_lcnphy_calc_floor(coeff_y, 0);\r\ny = 8 + k;\r\nk = wlc_lcnphy_calc_floor(coeff_y, 1);\r\nx = 8 - k;\r\ndata_rf = (x * 16 + y);\r\nwrite_radio_reg(pi, RADIO_2064_REG08A, data_rf);\r\nbreak;\r\ncase 4:\r\nk = wlc_lcnphy_calc_floor(coeff_x, 0);\r\ny = 8 + k;\r\nk = wlc_lcnphy_calc_floor(coeff_x, 1);\r\nx = 8 - k;\r\ndata_rf = (x * 16 + y);\r\nwrite_radio_reg(pi, RADIO_2064_REG08B, data_rf);\r\nk = wlc_lcnphy_calc_floor(coeff_y, 0);\r\ny = 8 + k;\r\nk = wlc_lcnphy_calc_floor(coeff_y, 1);\r\nx = 8 - k;\r\ndata_rf = (x * 16 + y);\r\nwrite_radio_reg(pi, RADIO_2064_REG08C, data_rf);\r\nbreak;\r\n}\r\n}\r\nstatic struct lcnphy_unsign16_struct\r\nwlc_lcnphy_get_cc(struct brcms_phy *pi, int cal_type)\r\n{\r\nu16 a, b, didq;\r\nu8 di0, dq0, ei, eq, fi, fq;\r\nstruct lcnphy_unsign16_struct cc;\r\ncc.re = 0;\r\ncc.im = 0;\r\nswitch (cal_type) {\r\ncase 0:\r\nwlc_lcnphy_get_tx_iqcc(pi, &a, &b);\r\ncc.re = a;\r\ncc.im = b;\r\nbreak;\r\ncase 2:\r\ndidq = wlc_lcnphy_get_tx_locc(pi);\r\ndi0 = (((didq & 0xff00) << 16) >> 24);\r\ndq0 = (((didq & 0x00ff) << 24) >> 24);\r\ncc.re = (u16) di0;\r\ncc.im = (u16) dq0;\r\nbreak;\r\ncase 3:\r\nwlc_lcnphy_get_radio_loft(pi, &ei, &eq, &fi, &fq);\r\ncc.re = (u16) ei;\r\ncc.im = (u16) eq;\r\nbreak;\r\ncase 4:\r\nwlc_lcnphy_get_radio_loft(pi, &ei, &eq, &fi, &fq);\r\ncc.re = (u16) fi;\r\ncc.im = (u16) fq;\r\nbreak;\r\n}\r\nreturn cc;\r\n}\r\nstatic void\r\nwlc_lcnphy_samp_cap(struct brcms_phy *pi, int clip_detect_algo, u16 thresh,\r\ns16 *ptr, int mode)\r\n{\r\nu32 curval1, curval2, stpptr, curptr, strptr, val;\r\nu16 sslpnCalibClkEnCtrl, timer;\r\nu16 old_sslpnCalibClkEnCtrl;\r\ns16 imag, real;\r\nstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\r\ntimer = 0;\r\nold_sslpnCalibClkEnCtrl = read_phy_reg(pi, 0x6da);\r\ncurval1 = bcma_read16(pi->d11core, D11REGOFFS(psm_corectlsts));\r\nptr[130] = 0;\r\nbcma_write16(pi->d11core, D11REGOFFS(psm_corectlsts),\r\n((1 << 6) | curval1));\r\nbcma_write16(pi->d11core, D11REGOFFS(smpl_clct_strptr), 0x7E00);\r\nbcma_write16(pi->d11core, D11REGOFFS(smpl_clct_stpptr), 0x8000);\r\nudelay(20);\r\ncurval2 = bcma_read16(pi->d11core, D11REGOFFS(psm_phy_hdr_param));\r\nbcma_write16(pi->d11core, D11REGOFFS(psm_phy_hdr_param),\r\ncurval2 | 0x30);\r\nwrite_phy_reg(pi, 0x555, 0x0);\r\nwrite_phy_reg(pi, 0x5a6, 0x5);\r\nwrite_phy_reg(pi, 0x5a2, (u16) (mode | mode << 6));\r\nwrite_phy_reg(pi, 0x5cf, 3);\r\nwrite_phy_reg(pi, 0x5a5, 0x3);\r\nwrite_phy_reg(pi, 0x583, 0x0);\r\nwrite_phy_reg(pi, 0x584, 0x0);\r\nwrite_phy_reg(pi, 0x585, 0x0fff);\r\nwrite_phy_reg(pi, 0x586, 0x0000);\r\nwrite_phy_reg(pi, 0x580, 0x4501);\r\nsslpnCalibClkEnCtrl = read_phy_reg(pi, 0x6da);\r\nwrite_phy_reg(pi, 0x6da, (u32) (sslpnCalibClkEnCtrl | 0x2008));\r\nstpptr = bcma_read16(pi->d11core, D11REGOFFS(smpl_clct_stpptr));\r\ncurptr = bcma_read16(pi->d11core, D11REGOFFS(smpl_clct_curptr));\r\ndo {\r\nudelay(10);\r\ncurptr = bcma_read16(pi->d11core, D11REGOFFS(smpl_clct_curptr));\r\ntimer++;\r\n} while ((curptr != stpptr) && (timer < 500));\r\nbcma_write16(pi->d11core, D11REGOFFS(psm_phy_hdr_param), 0x2);\r\nstrptr = 0x7E00;\r\nbcma_write32(pi->d11core, D11REGOFFS(tplatewrptr), strptr);\r\nwhile (strptr < 0x8000) {\r\nval = bcma_read32(pi->d11core, D11REGOFFS(tplatewrdata));\r\nimag = ((val >> 16) & 0x3ff);\r\nreal = ((val) & 0x3ff);\r\nif (imag > 511)\r\nimag -= 1024;\r\nif (real > 511)\r\nreal -= 1024;\r\nif (pi_lcn->lcnphy_iqcal_swp_dis)\r\nptr[(strptr - 0x7E00) / 4] = real;\r\nelse\r\nptr[(strptr - 0x7E00) / 4] = imag;\r\nif (clip_detect_algo) {\r\nif (imag > thresh || imag < -thresh) {\r\nstrptr = 0x8000;\r\nptr[130] = 1;\r\n}\r\n}\r\nstrptr += 4;\r\n}\r\nwrite_phy_reg(pi, 0x6da, old_sslpnCalibClkEnCtrl);\r\nbcma_write16(pi->d11core, D11REGOFFS(psm_phy_hdr_param), curval2);\r\nbcma_write16(pi->d11core, D11REGOFFS(psm_corectlsts), curval1);\r\n}\r\nstatic void\r\nwlc_lcnphy_a1(struct brcms_phy *pi, int cal_type, int num_levels,\r\nint step_size_lg2)\r\n{\r\nconst struct lcnphy_spb_tone *phy_c1;\r\nstruct lcnphy_spb_tone phy_c2;\r\nstruct lcnphy_unsign16_struct phy_c3;\r\nint phy_c4, phy_c5, k, l, j, phy_c6;\r\nu16 phy_c7, phy_c8, phy_c9;\r\ns16 phy_c10, phy_c11, phy_c12, phy_c13, phy_c14, phy_c15, phy_c16;\r\ns16 *ptr, phy_c17;\r\ns32 phy_c18, phy_c19;\r\nu32 phy_c20, phy_c21;\r\nbool phy_c22, phy_c23, phy_c24, phy_c25;\r\nu16 phy_c26, phy_c27;\r\nu16 phy_c28, phy_c29, phy_c30;\r\nu16 phy_c31;\r\nu16 *phy_c32;\r\nphy_c21 = 0;\r\nphy_c10 = phy_c13 = phy_c14 = phy_c8 = 0;\r\nptr = kmalloc(sizeof(s16) * 131, GFP_ATOMIC);\r\nif (NULL == ptr)\r\nreturn;\r\nphy_c32 = kmalloc(sizeof(u16) * 20, GFP_ATOMIC);\r\nif (NULL == phy_c32) {\r\nkfree(ptr);\r\nreturn;\r\n}\r\nphy_c26 = read_phy_reg(pi, 0x6da);\r\nphy_c27 = read_phy_reg(pi, 0x6db);\r\nphy_c31 = read_radio_reg(pi, RADIO_2064_REG026);\r\nwrite_phy_reg(pi, 0x93d, 0xC0);\r\nwlc_lcnphy_start_tx_tone(pi, 3750, 88, 0);\r\nwrite_phy_reg(pi, 0x6da, 0xffff);\r\nor_phy_reg(pi, 0x6db, 0x3);\r\nwlc_lcnphy_tx_iqlo_loopback(pi, phy_c32);\r\nudelay(500);\r\nphy_c28 = read_phy_reg(pi, 0x938);\r\nphy_c29 = read_phy_reg(pi, 0x4d7);\r\nphy_c30 = read_phy_reg(pi, 0x4d8);\r\nor_phy_reg(pi, 0x938, 0x1 << 2);\r\nor_phy_reg(pi, 0x4d7, 0x1 << 2);\r\nor_phy_reg(pi, 0x4d7, 0x1 << 3);\r\nmod_phy_reg(pi, 0x4d7, (0x7 << 12), 0x2 << 12);\r\nor_phy_reg(pi, 0x4d8, 1 << 0);\r\nor_phy_reg(pi, 0x4d8, 1 << 1);\r\nmod_phy_reg(pi, 0x4d8, (0x3ff << 2), 0x23A << 2);\r\nmod_phy_reg(pi, 0x4d8, (0x7 << 12), 0x7 << 12);\r\nphy_c1 = &lcnphy_spb_tone_3750[0];\r\nphy_c4 = 32;\r\nif (num_levels == 0) {\r\nif (cal_type != 0)\r\nnum_levels = 4;\r\nelse\r\nnum_levels = 9;\r\n}\r\nif (step_size_lg2 == 0) {\r\nif (cal_type != 0)\r\nstep_size_lg2 = 3;\r\nelse\r\nstep_size_lg2 = 8;\r\n}\r\nphy_c7 = (1 << step_size_lg2);\r\nphy_c3 = wlc_lcnphy_get_cc(pi, cal_type);\r\nphy_c15 = (s16) phy_c3.re;\r\nphy_c16 = (s16) phy_c3.im;\r\nif (cal_type == 2) {\r\nif (phy_c3.re > 127)\r\nphy_c15 = phy_c3.re - 256;\r\nif (phy_c3.im > 127)\r\nphy_c16 = phy_c3.im - 256;\r\n}\r\nwlc_lcnphy_set_cc(pi, cal_type, phy_c15, phy_c16);\r\nudelay(20);\r\nfor (phy_c8 = 0; phy_c7 != 0 && phy_c8 < num_levels; phy_c8++) {\r\nphy_c23 = true;\r\nphy_c22 = false;\r\nswitch (cal_type) {\r\ncase 0:\r\nphy_c10 = 511;\r\nbreak;\r\ncase 2:\r\nphy_c10 = 127;\r\nbreak;\r\ncase 3:\r\nphy_c10 = 15;\r\nbreak;\r\ncase 4:\r\nphy_c10 = 15;\r\nbreak;\r\n}\r\nphy_c9 = read_phy_reg(pi, 0x93d);\r\nphy_c9 = 2 * phy_c9;\r\nphy_c24 = false;\r\nphy_c5 = 7;\r\nphy_c25 = true;\r\nwhile (1) {\r\nwrite_radio_reg(pi, RADIO_2064_REG026,\r\n(phy_c5 & 0x7) | ((phy_c5 & 0x7) << 4));\r\nudelay(50);\r\nphy_c22 = false;\r\nptr[130] = 0;\r\nwlc_lcnphy_samp_cap(pi, 1, phy_c9, &ptr[0], 2);\r\nif (ptr[130] == 1)\r\nphy_c22 = true;\r\nif (phy_c22)\r\nphy_c5 -= 1;\r\nif ((phy_c22 != phy_c24) && (!phy_c25))\r\nbreak;\r\nif (!phy_c22)\r\nphy_c5 += 1;\r\nif (phy_c5 <= 0 || phy_c5 >= 7)\r\nbreak;\r\nphy_c24 = phy_c22;\r\nphy_c25 = false;\r\n}\r\nif (phy_c5 < 0)\r\nphy_c5 = 0;\r\nelse if (phy_c5 > 7)\r\nphy_c5 = 7;\r\nfor (k = -phy_c7; k <= phy_c7; k += phy_c7) {\r\nfor (l = -phy_c7; l <= phy_c7; l += phy_c7) {\r\nphy_c11 = phy_c15 + k;\r\nphy_c12 = phy_c16 + l;\r\nif (phy_c11 < -phy_c10)\r\nphy_c11 = -phy_c10;\r\nelse if (phy_c11 > phy_c10)\r\nphy_c11 = phy_c10;\r\nif (phy_c12 < -phy_c10)\r\nphy_c12 = -phy_c10;\r\nelse if (phy_c12 > phy_c10)\r\nphy_c12 = phy_c10;\r\nwlc_lcnphy_set_cc(pi, cal_type, phy_c11,\r\nphy_c12);\r\nudelay(20);\r\nwlc_lcnphy_samp_cap(pi, 0, 0, ptr, 2);\r\nphy_c18 = 0;\r\nphy_c19 = 0;\r\nfor (j = 0; j < 128; j++) {\r\nif (cal_type != 0)\r\nphy_c6 = j % phy_c4;\r\nelse\r\nphy_c6 = (2 * j) % phy_c4;\r\nphy_c2.re = phy_c1[phy_c6].re;\r\nphy_c2.im = phy_c1[phy_c6].im;\r\nphy_c17 = ptr[j];\r\nphy_c18 = phy_c18 + phy_c17 * phy_c2.re;\r\nphy_c19 = phy_c19 + phy_c17 * phy_c2.im;\r\n}\r\nphy_c18 = phy_c18 >> 10;\r\nphy_c19 = phy_c19 >> 10;\r\nphy_c20 = ((phy_c18 * phy_c18) +\r\n(phy_c19 * phy_c19));\r\nif (phy_c23 || phy_c20 < phy_c21) {\r\nphy_c21 = phy_c20;\r\nphy_c13 = phy_c11;\r\nphy_c14 = phy_c12;\r\n}\r\nphy_c23 = false;\r\n}\r\n}\r\nphy_c23 = true;\r\nphy_c15 = phy_c13;\r\nphy_c16 = phy_c14;\r\nphy_c7 = phy_c7 >> 1;\r\nwlc_lcnphy_set_cc(pi, cal_type, phy_c15, phy_c16);\r\nudelay(20);\r\n}\r\ngoto cleanup;\r\ncleanup:\r\nwlc_lcnphy_tx_iqlo_loopback_cleanup(pi, phy_c32);\r\nwlc_lcnphy_stop_tx_tone(pi);\r\nwrite_phy_reg(pi, 0x6da, phy_c26);\r\nwrite_phy_reg(pi, 0x6db, phy_c27);\r\nwrite_phy_reg(pi, 0x938, phy_c28);\r\nwrite_phy_reg(pi, 0x4d7, phy_c29);\r\nwrite_phy_reg(pi, 0x4d8, phy_c30);\r\nwrite_radio_reg(pi, RADIO_2064_REG026, phy_c31);\r\nkfree(phy_c32);\r\nkfree(ptr);\r\n}\r\nvoid wlc_lcnphy_get_tx_iqcc(struct brcms_phy *pi, u16 *a, u16 *b)\r\n{\r\nu16 iqcc[2];\r\nstruct phytbl_info tab;\r\ntab.tbl_ptr = iqcc;\r\ntab.tbl_len = 2;\r\ntab.tbl_id = 0;\r\ntab.tbl_offset = 80;\r\ntab.tbl_width = 16;\r\nwlc_lcnphy_read_table(pi, &tab);\r\n*a = iqcc[0];\r\n*b = iqcc[1];\r\n}\r\nstatic void wlc_lcnphy_tx_iqlo_soft_cal_full(struct brcms_phy *pi)\r\n{\r\nstruct lcnphy_unsign16_struct iqcc0, locc2, locc3, locc4;\r\nwlc_lcnphy_set_cc(pi, 0, 0, 0);\r\nwlc_lcnphy_set_cc(pi, 2, 0, 0);\r\nwlc_lcnphy_set_cc(pi, 3, 0, 0);\r\nwlc_lcnphy_set_cc(pi, 4, 0, 0);\r\nwlc_lcnphy_a1(pi, 4, 0, 0);\r\nwlc_lcnphy_a1(pi, 3, 0, 0);\r\nwlc_lcnphy_a1(pi, 2, 3, 2);\r\nwlc_lcnphy_a1(pi, 0, 5, 8);\r\nwlc_lcnphy_a1(pi, 2, 2, 1);\r\nwlc_lcnphy_a1(pi, 0, 4, 3);\r\niqcc0 = wlc_lcnphy_get_cc(pi, 0);\r\nlocc2 = wlc_lcnphy_get_cc(pi, 2);\r\nlocc3 = wlc_lcnphy_get_cc(pi, 3);\r\nlocc4 = wlc_lcnphy_get_cc(pi, 4);\r\n}\r\nu16 wlc_lcnphy_get_tx_locc(struct brcms_phy *pi)\r\n{\r\nstruct phytbl_info tab;\r\nu16 didq;\r\ntab.tbl_id = 0;\r\ntab.tbl_width = 16;\r\ntab.tbl_ptr = &didq;\r\ntab.tbl_len = 1;\r\ntab.tbl_offset = 85;\r\nwlc_lcnphy_read_table(pi, &tab);\r\nreturn didq;\r\n}\r\nstatic void wlc_lcnphy_txpwrtbl_iqlo_cal(struct brcms_phy *pi)\r\n{\r\nstruct lcnphy_txgains target_gains, old_gains;\r\nu8 save_bb_mult;\r\nu16 a, b, didq, save_pa_gain = 0;\r\nuint idx, SAVE_txpwrindex = 0xFF;\r\nu32 val;\r\nu16 SAVE_txpwrctrl = wlc_lcnphy_get_tx_pwr_ctrl(pi);\r\nstruct phytbl_info tab;\r\nu8 ei0, eq0, fi0, fq0;\r\nstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\r\nwlc_lcnphy_get_tx_gain(pi, &old_gains);\r\nsave_pa_gain = wlc_lcnphy_get_pa_gain(pi);\r\nsave_bb_mult = wlc_lcnphy_get_bbmult(pi);\r\nif (SAVE_txpwrctrl == LCNPHY_TX_PWR_CTRL_OFF)\r\nSAVE_txpwrindex = wlc_lcnphy_get_current_tx_pwr_idx(pi);\r\nwlc_lcnphy_set_tx_pwr_ctrl(pi, LCNPHY_TX_PWR_CTRL_OFF);\r\ntarget_gains.gm_gain = 7;\r\ntarget_gains.pga_gain = 0;\r\ntarget_gains.pad_gain = 21;\r\ntarget_gains.dac_gain = 0;\r\nwlc_lcnphy_set_tx_gain(pi, &target_gains);\r\nwlc_lcnphy_set_tx_pwr_by_index(pi, 16);\r\nif (LCNREV_IS(pi->pubpi.phy_rev, 1) || pi_lcn->lcnphy_hw_iqcal_en) {\r\nwlc_lcnphy_set_tx_pwr_by_index(pi, 30);\r\nwlc_lcnphy_tx_iqlo_cal(pi, &target_gains,\r\n(pi_lcn->\r\nlcnphy_recal ? LCNPHY_CAL_RECAL :\r\nLCNPHY_CAL_FULL), false);\r\n} else {\r\nwlc_lcnphy_tx_iqlo_soft_cal_full(pi);\r\n}\r\nwlc_lcnphy_get_radio_loft(pi, &ei0, &eq0, &fi0, &fq0);\r\nif ((abs((s8) fi0) == 15) && (abs((s8) fq0) == 15)) {\r\nif (CHSPEC_IS5G(pi->radio_chanspec)) {\r\ntarget_gains.gm_gain = 255;\r\ntarget_gains.pga_gain = 255;\r\ntarget_gains.pad_gain = 0xf0;\r\ntarget_gains.dac_gain = 0;\r\n} else {\r\ntarget_gains.gm_gain = 7;\r\ntarget_gains.pga_gain = 45;\r\ntarget_gains.pad_gain = 186;\r\ntarget_gains.dac_gain = 0;\r\n}\r\nif (LCNREV_IS(pi->pubpi.phy_rev, 1)\r\n|| pi_lcn->lcnphy_hw_iqcal_en) {\r\ntarget_gains.pga_gain = 0;\r\ntarget_gains.pad_gain = 30;\r\nwlc_lcnphy_set_tx_pwr_by_index(pi, 16);\r\nwlc_lcnphy_tx_iqlo_cal(pi, &target_gains,\r\nLCNPHY_CAL_FULL, false);\r\n} else {\r\nwlc_lcnphy_tx_iqlo_soft_cal_full(pi);\r\n}\r\n}\r\nwlc_lcnphy_get_tx_iqcc(pi, &a, &b);\r\ndidq = wlc_lcnphy_get_tx_locc(pi);\r\ntab.tbl_id = LCNPHY_TBL_ID_TXPWRCTL;\r\ntab.tbl_width = 32;\r\ntab.tbl_ptr = &val;\r\ntab.tbl_len = 1;\r\ntab.tbl_offset = LCNPHY_TX_PWR_CTRL_RATE_OFFSET;\r\nfor (idx = 0; idx < 128; idx++) {\r\ntab.tbl_offset = LCNPHY_TX_PWR_CTRL_IQ_OFFSET + idx;\r\nwlc_lcnphy_read_table(pi, &tab);\r\nval = (val & 0xfff00000) |\r\n((u32) (a & 0x3FF) << 10) | (b & 0x3ff);\r\nwlc_lcnphy_write_table(pi, &tab);\r\nval = didq;\r\ntab.tbl_offset = LCNPHY_TX_PWR_CTRL_LO_OFFSET + idx;\r\nwlc_lcnphy_write_table(pi, &tab);\r\n}\r\npi_lcn->lcnphy_cal_results.txiqlocal_a = a;\r\npi_lcn->lcnphy_cal_results.txiqlocal_b = b;\r\npi_lcn->lcnphy_cal_results.txiqlocal_didq = didq;\r\npi_lcn->lcnphy_cal_results.txiqlocal_ei0 = ei0;\r\npi_lcn->lcnphy_cal_results.txiqlocal_eq0 = eq0;\r\npi_lcn->lcnphy_cal_results.txiqlocal_fi0 = fi0;\r\npi_lcn->lcnphy_cal_results.txiqlocal_fq0 = fq0;\r\nwlc_lcnphy_set_bbmult(pi, save_bb_mult);\r\nwlc_lcnphy_set_pa_gain(pi, save_pa_gain);\r\nwlc_lcnphy_set_tx_gain(pi, &old_gains);\r\nif (SAVE_txpwrctrl != LCNPHY_TX_PWR_CTRL_OFF)\r\nwlc_lcnphy_set_tx_pwr_ctrl(pi, SAVE_txpwrctrl);\r\nelse\r\nwlc_lcnphy_set_tx_pwr_by_index(pi, SAVE_txpwrindex);\r\n}\r\ns16 wlc_lcnphy_tempsense_new(struct brcms_phy *pi, bool mode)\r\n{\r\nu16 tempsenseval1, tempsenseval2;\r\ns16 avg = 0;\r\nbool suspend = false;\r\nif (mode == 1) {\r\nsuspend = (0 == (bcma_read32(pi->d11core,\r\nD11REGOFFS(maccontrol)) &\r\nMCTL_EN_MAC));\r\nif (!suspend)\r\nwlapi_suspend_mac_and_wait(pi->sh->physhim);\r\nwlc_lcnphy_vbat_temp_sense_setup(pi, TEMPSENSE);\r\n}\r\ntempsenseval1 = read_phy_reg(pi, 0x476) & 0x1FF;\r\ntempsenseval2 = read_phy_reg(pi, 0x477) & 0x1FF;\r\nif (tempsenseval1 > 255)\r\navg = (s16) (tempsenseval1 - 512);\r\nelse\r\navg = (s16) tempsenseval1;\r\nif (tempsenseval2 > 255)\r\navg += (s16) (tempsenseval2 - 512);\r\nelse\r\navg += (s16) tempsenseval2;\r\navg /= 2;\r\nif (mode == 1) {\r\nmod_phy_reg(pi, 0x448, (0x1 << 14), (1) << 14);\r\nudelay(100);\r\nmod_phy_reg(pi, 0x448, (0x1 << 14), (0) << 14);\r\nif (!suspend)\r\nwlapi_enable_mac(pi->sh->physhim);\r\n}\r\nreturn avg;\r\n}\r\nu16 wlc_lcnphy_tempsense(struct brcms_phy *pi, bool mode)\r\n{\r\nu16 tempsenseval1, tempsenseval2;\r\ns32 avg = 0;\r\nbool suspend = false;\r\nu16 SAVE_txpwrctrl = wlc_lcnphy_get_tx_pwr_ctrl(pi);\r\nstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\r\nif (mode == 1) {\r\nsuspend = (0 == (bcma_read32(pi->d11core,\r\nD11REGOFFS(maccontrol)) &\r\nMCTL_EN_MAC));\r\nif (!suspend)\r\nwlapi_suspend_mac_and_wait(pi->sh->physhim);\r\nwlc_lcnphy_vbat_temp_sense_setup(pi, TEMPSENSE);\r\n}\r\ntempsenseval1 = read_phy_reg(pi, 0x476) & 0x1FF;\r\ntempsenseval2 = read_phy_reg(pi, 0x477) & 0x1FF;\r\nif (tempsenseval1 > 255)\r\navg = (int)(tempsenseval1 - 512);\r\nelse\r\navg = (int)tempsenseval1;\r\nif (pi_lcn->lcnphy_tempsense_option == 1 || pi->hwpwrctrl_capable) {\r\nif (tempsenseval2 > 255)\r\navg = (int)(avg - tempsenseval2 + 512);\r\nelse\r\navg = (int)(avg - tempsenseval2);\r\n} else {\r\nif (tempsenseval2 > 255)\r\navg = (int)(avg + tempsenseval2 - 512);\r\nelse\r\navg = (int)(avg + tempsenseval2);\r\navg = avg / 2;\r\n}\r\nif (avg < 0)\r\navg = avg + 512;\r\nif (pi_lcn->lcnphy_tempsense_option == 2)\r\navg = tempsenseval1;\r\nif (mode)\r\nwlc_lcnphy_set_tx_pwr_ctrl(pi, SAVE_txpwrctrl);\r\nif (mode == 1) {\r\nmod_phy_reg(pi, 0x448, (0x1 << 14), (1) << 14);\r\nudelay(100);\r\nmod_phy_reg(pi, 0x448, (0x1 << 14), (0) << 14);\r\nif (!suspend)\r\nwlapi_enable_mac(pi->sh->physhim);\r\n}\r\nreturn (u16) avg;\r\n}\r\ns8 wlc_lcnphy_tempsense_degree(struct brcms_phy *pi, bool mode)\r\n{\r\ns32 degree = wlc_lcnphy_tempsense_new(pi, mode);\r\ndegree =\r\n((degree <<\r\n10) + LCN_TEMPSENSE_OFFSET + (LCN_TEMPSENSE_DEN >> 1))\r\n/ LCN_TEMPSENSE_DEN;\r\nreturn (s8) degree;\r\n}\r\ns8 wlc_lcnphy_vbatsense(struct brcms_phy *pi, bool mode)\r\n{\r\nu16 vbatsenseval;\r\ns32 avg = 0;\r\nbool suspend = false;\r\nif (mode == 1) {\r\nsuspend = (0 == (bcma_read32(pi->d11core,\r\nD11REGOFFS(maccontrol)) &\r\nMCTL_EN_MAC));\r\nif (!suspend)\r\nwlapi_suspend_mac_and_wait(pi->sh->physhim);\r\nwlc_lcnphy_vbat_temp_sense_setup(pi, VBATSENSE);\r\n}\r\nvbatsenseval = read_phy_reg(pi, 0x475) & 0x1FF;\r\nif (vbatsenseval > 255)\r\navg = (s32) (vbatsenseval - 512);\r\nelse\r\navg = (s32) vbatsenseval;\r\navg = (avg * LCN_VBAT_SCALE_NOM +\r\n(LCN_VBAT_SCALE_DEN >> 1)) / LCN_VBAT_SCALE_DEN;\r\nif (mode == 1) {\r\nif (!suspend)\r\nwlapi_enable_mac(pi->sh->physhim);\r\n}\r\nreturn (s8) avg;\r\n}\r\nstatic void wlc_lcnphy_afe_clk_init(struct brcms_phy *pi, u8 mode)\r\n{\r\nu8 phybw40;\r\nphybw40 = CHSPEC_IS40(pi->radio_chanspec);\r\nmod_phy_reg(pi, 0x6d1, (0x1 << 7), (1) << 7);\r\nif (((mode == AFE_CLK_INIT_MODE_PAPD) && (phybw40 == 0)) ||\r\n(mode == AFE_CLK_INIT_MODE_TXRX2X))\r\nwrite_phy_reg(pi, 0x6d0, 0x7);\r\nwlc_lcnphy_toggle_afe_pwdn(pi);\r\n}\r\nstatic void wlc_lcnphy_temp_adj(struct brcms_phy *pi)\r\n{\r\n}\r\nstatic void wlc_lcnphy_glacial_timer_based_cal(struct brcms_phy *pi)\r\n{\r\nbool suspend;\r\ns8 index;\r\nu16 SAVE_pwrctrl = wlc_lcnphy_get_tx_pwr_ctrl(pi);\r\nstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\r\nsuspend = (0 == (bcma_read32(pi->d11core, D11REGOFFS(maccontrol)) &\r\nMCTL_EN_MAC));\r\nif (!suspend)\r\nwlapi_suspend_mac_and_wait(pi->sh->physhim);\r\nwlc_lcnphy_deaf_mode(pi, true);\r\npi->phy_lastcal = pi->sh->now;\r\npi->phy_forcecal = false;\r\nindex = pi_lcn->lcnphy_current_index;\r\nwlc_lcnphy_txpwrtbl_iqlo_cal(pi);\r\nwlc_lcnphy_set_tx_pwr_by_index(pi, index);\r\nwlc_lcnphy_set_tx_pwr_ctrl(pi, SAVE_pwrctrl);\r\nwlc_lcnphy_deaf_mode(pi, false);\r\nif (!suspend)\r\nwlapi_enable_mac(pi->sh->physhim);\r\n}\r\nstatic void wlc_lcnphy_periodic_cal(struct brcms_phy *pi)\r\n{\r\nbool suspend, full_cal;\r\nconst struct lcnphy_rx_iqcomp *rx_iqcomp;\r\nint rx_iqcomp_sz;\r\nu16 SAVE_pwrctrl = wlc_lcnphy_get_tx_pwr_ctrl(pi);\r\ns8 index;\r\nstruct phytbl_info tab;\r\ns32 a1, b0, b1;\r\ns32 tssi, pwr, maxtargetpwr, mintargetpwr;\r\nstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\r\npi->phy_lastcal = pi->sh->now;\r\npi->phy_forcecal = false;\r\nfull_cal =\r\n(pi_lcn->lcnphy_full_cal_channel !=\r\nCHSPEC_CHANNEL(pi->radio_chanspec));\r\npi_lcn->lcnphy_full_cal_channel = CHSPEC_CHANNEL(pi->radio_chanspec);\r\nindex = pi_lcn->lcnphy_current_index;\r\nsuspend = (0 == (bcma_read32(pi->d11core, D11REGOFFS(maccontrol)) &\r\nMCTL_EN_MAC));\r\nif (!suspend) {\r\nwlapi_bmac_write_shm(pi->sh->physhim, M_CTS_DURATION, 10000);\r\nwlapi_suspend_mac_and_wait(pi->sh->physhim);\r\n}\r\nwlc_lcnphy_deaf_mode(pi, true);\r\nwlc_lcnphy_txpwrtbl_iqlo_cal(pi);\r\nrx_iqcomp = lcnphy_rx_iqcomp_table_rev0;\r\nrx_iqcomp_sz = ARRAY_SIZE(lcnphy_rx_iqcomp_table_rev0);\r\nif (LCNREV_IS(pi->pubpi.phy_rev, 1))\r\nwlc_lcnphy_rx_iq_cal(pi, NULL, 0, true, false, 1, 40);\r\nelse\r\nwlc_lcnphy_rx_iq_cal(pi, NULL, 0, true, false, 1, 127);\r\nif (wlc_lcnphy_tssi_based_pwr_ctrl_enabled(pi)) {\r\nwlc_lcnphy_idle_tssi_est((struct brcms_phy_pub *) pi);\r\nb0 = pi->txpa_2g[0];\r\nb1 = pi->txpa_2g[1];\r\na1 = pi->txpa_2g[2];\r\nmaxtargetpwr = wlc_lcnphy_tssi2dbm(10, a1, b0, b1);\r\nmintargetpwr = wlc_lcnphy_tssi2dbm(125, a1, b0, b1);\r\ntab.tbl_id = LCNPHY_TBL_ID_TXPWRCTL;\r\ntab.tbl_width = 32;\r\ntab.tbl_ptr = &pwr;\r\ntab.tbl_len = 1;\r\ntab.tbl_offset = 0;\r\nfor (tssi = 0; tssi < 128; tssi++) {\r\npwr = wlc_lcnphy_tssi2dbm(tssi, a1, b0, b1);\r\npwr = (pwr < mintargetpwr) ? mintargetpwr : pwr;\r\nwlc_lcnphy_write_table(pi, &tab);\r\ntab.tbl_offset++;\r\n}\r\n}\r\nwlc_lcnphy_set_tx_pwr_by_index(pi, index);\r\nwlc_lcnphy_set_tx_pwr_ctrl(pi, SAVE_pwrctrl);\r\nwlc_lcnphy_deaf_mode(pi, false);\r\nif (!suspend)\r\nwlapi_enable_mac(pi->sh->physhim);\r\n}\r\nvoid wlc_lcnphy_calib_modes(struct brcms_phy *pi, uint mode)\r\n{\r\nu16 temp_new;\r\nint temp1, temp2, temp_diff;\r\nstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\r\nswitch (mode) {\r\ncase PHY_PERICAL_CHAN:\r\nbreak;\r\ncase PHY_FULLCAL:\r\nwlc_lcnphy_periodic_cal(pi);\r\nbreak;\r\ncase PHY_PERICAL_PHYINIT:\r\nwlc_lcnphy_periodic_cal(pi);\r\nbreak;\r\ncase PHY_PERICAL_WATCHDOG:\r\nif (wlc_lcnphy_tempsense_based_pwr_ctrl_enabled(pi)) {\r\ntemp_new = wlc_lcnphy_tempsense(pi, 0);\r\ntemp1 = LCNPHY_TEMPSENSE(temp_new);\r\ntemp2 = LCNPHY_TEMPSENSE(pi_lcn->lcnphy_cal_temper);\r\ntemp_diff = temp1 - temp2;\r\nif ((pi_lcn->lcnphy_cal_counter > 90) ||\r\n(temp_diff > 60) || (temp_diff < -60)) {\r\nwlc_lcnphy_glacial_timer_based_cal(pi);\r\nwlc_2064_vco_cal(pi);\r\npi_lcn->lcnphy_cal_temper = temp_new;\r\npi_lcn->lcnphy_cal_counter = 0;\r\n} else\r\npi_lcn->lcnphy_cal_counter++;\r\n}\r\nbreak;\r\ncase LCNPHY_PERICAL_TEMPBASED_TXPWRCTRL:\r\nif (wlc_lcnphy_tempsense_based_pwr_ctrl_enabled(pi))\r\nwlc_lcnphy_tx_power_adjustment(\r\n(struct brcms_phy_pub *) pi);\r\nbreak;\r\n}\r\n}\r\nvoid wlc_lcnphy_get_tssi(struct brcms_phy *pi, s8 *ofdm_pwr, s8 *cck_pwr)\r\n{\r\ns8 cck_offset;\r\nu16 status;\r\nstatus = (read_phy_reg(pi, 0x4ab));\r\nif (wlc_lcnphy_tssi_based_pwr_ctrl_enabled(pi) &&\r\n(status & (0x1 << 15))) {\r\n*ofdm_pwr = (s8) (((read_phy_reg(pi, 0x4ab) & (0x1ff << 0))\r\n>> 0) >> 1);\r\nif (wlc_phy_tpc_isenabled_lcnphy(pi))\r\ncck_offset = pi->tx_power_offset[TXP_FIRST_CCK];\r\nelse\r\ncck_offset = 0;\r\n*cck_pwr = *ofdm_pwr + cck_offset;\r\n} else {\r\n*cck_pwr = 0;\r\n*ofdm_pwr = 0;\r\n}\r\n}\r\nvoid wlc_phy_cal_init_lcnphy(struct brcms_phy *pi)\r\n{\r\nreturn;\r\n}\r\nvoid wlc_lcnphy_tx_power_adjustment(struct brcms_phy_pub *ppi)\r\n{\r\ns8 index;\r\nu16 index2;\r\nstruct brcms_phy *pi = (struct brcms_phy *) ppi;\r\nstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\r\nu16 SAVE_txpwrctrl = wlc_lcnphy_get_tx_pwr_ctrl(pi);\r\nif (wlc_lcnphy_tempsense_based_pwr_ctrl_enabled(pi) &&\r\nSAVE_txpwrctrl) {\r\nindex = wlc_lcnphy_tempcompensated_txpwrctrl(pi);\r\nindex2 = (u16) (index * 2);\r\nmod_phy_reg(pi, 0x4a9, (0x1ff << 0), (index2) << 0);\r\npi_lcn->lcnphy_current_index =\r\n(s8)((read_phy_reg(pi, 0x4a9) & 0xFF) / 2);\r\n}\r\n}\r\nstatic void\r\nwlc_lcnphy_load_tx_gain_table(struct brcms_phy *pi,\r\nconst struct lcnphy_tx_gain_tbl_entry *gain_table)\r\n{\r\nu32 j;\r\nstruct phytbl_info tab;\r\nu32 val;\r\nu16 pa_gain;\r\nu16 gm_gain;\r\nif (CHSPEC_IS5G(pi->radio_chanspec))\r\npa_gain = 0x70;\r\nelse\r\npa_gain = 0x70;\r\nif (pi->sh->boardflags & BFL_FEM)\r\npa_gain = 0x10;\r\ntab.tbl_id = LCNPHY_TBL_ID_TXPWRCTL;\r\ntab.tbl_width = 32;\r\ntab.tbl_len = 1;\r\ntab.tbl_ptr = &val;\r\nfor (j = 0; j < 128; j++) {\r\ngm_gain = gain_table[j].gm;\r\nval = (((u32) pa_gain << 24) |\r\n(gain_table[j].pad << 16) |\r\n(gain_table[j].pga << 8) | gm_gain);\r\ntab.tbl_offset = LCNPHY_TX_PWR_CTRL_GAIN_OFFSET + j;\r\nwlc_lcnphy_write_table(pi, &tab);\r\nval = (gain_table[j].dac << 28) | (gain_table[j].bb_mult << 20);\r\ntab.tbl_offset = LCNPHY_TX_PWR_CTRL_IQ_OFFSET + j;\r\nwlc_lcnphy_write_table(pi, &tab);\r\n}\r\n}\r\nstatic void wlc_lcnphy_load_rfpower(struct brcms_phy *pi)\r\n{\r\nstruct phytbl_info tab;\r\nu32 val, bbmult, rfgain;\r\nu8 index;\r\nu8 scale_factor = 1;\r\ns16 temp, temp1, temp2, qQ, qQ1, qQ2, shift;\r\ntab.tbl_id = LCNPHY_TBL_ID_TXPWRCTL;\r\ntab.tbl_width = 32;\r\ntab.tbl_len = 1;\r\nfor (index = 0; index < 128; index++) {\r\ntab.tbl_ptr = &bbmult;\r\ntab.tbl_offset = LCNPHY_TX_PWR_CTRL_IQ_OFFSET + index;\r\nwlc_lcnphy_read_table(pi, &tab);\r\nbbmult = bbmult >> 20;\r\ntab.tbl_ptr = &rfgain;\r\ntab.tbl_offset = LCNPHY_TX_PWR_CTRL_GAIN_OFFSET + index;\r\nwlc_lcnphy_read_table(pi, &tab);\r\nqm_log10((s32) (bbmult), 0, &temp1, &qQ1);\r\nqm_log10((s32) (1 << 6), 0, &temp2, &qQ2);\r\nif (qQ1 < qQ2) {\r\ntemp2 = qm_shr16(temp2, qQ2 - qQ1);\r\nqQ = qQ1;\r\n} else {\r\ntemp1 = qm_shr16(temp1, qQ1 - qQ2);\r\nqQ = qQ2;\r\n}\r\ntemp = qm_sub16(temp1, temp2);\r\nif (qQ >= 4)\r\nshift = qQ - 4;\r\nelse\r\nshift = 4 - qQ;\r\nval = (((index << shift) + (5 * temp) +\r\n(1 << (scale_factor + shift - 3))) >> (scale_factor +\r\nshift - 2));\r\ntab.tbl_ptr = &val;\r\ntab.tbl_offset = LCNPHY_TX_PWR_CTRL_PWR_OFFSET + index;\r\nwlc_lcnphy_write_table(pi, &tab);\r\n}\r\n}\r\nstatic void wlc_lcnphy_bu_tweaks(struct brcms_phy *pi)\r\n{\r\nor_phy_reg(pi, 0x805, 0x1);\r\nmod_phy_reg(pi, 0x42f, (0x7 << 0), (0x3) << 0);\r\nmod_phy_reg(pi, 0x030, (0x7 << 0), (0x3) << 0);\r\nwrite_phy_reg(pi, 0x414, 0x1e10);\r\nwrite_phy_reg(pi, 0x415, 0x0640);\r\nmod_phy_reg(pi, 0x4df, (0xff << 8), -9 << 8);\r\nor_phy_reg(pi, 0x44a, 0x44);\r\nwrite_phy_reg(pi, 0x44a, 0x80);\r\nmod_phy_reg(pi, 0x434, (0xff << 0), (0xFD) << 0);\r\nmod_phy_reg(pi, 0x420, (0xff << 0), (16) << 0);\r\nif (!(pi->sh->boardrev < 0x1204))\r\nmod_radio_reg(pi, RADIO_2064_REG09B, 0xF0, 0xF0);\r\nwrite_phy_reg(pi, 0x7d6, 0x0902);\r\nmod_phy_reg(pi, 0x429, (0xf << 0), (0x9) << 0);\r\nmod_phy_reg(pi, 0x429, (0x3f << 4), (0xe) << 4);\r\nif (LCNREV_IS(pi->pubpi.phy_rev, 1)) {\r\nmod_phy_reg(pi, 0x423, (0xff << 0), (0x46) << 0);\r\nmod_phy_reg(pi, 0x411, (0xff << 0), (1) << 0);\r\nmod_phy_reg(pi, 0x434, (0xff << 0), (0xFF) << 0);\r\nmod_phy_reg(pi, 0x656, (0xf << 0), (2) << 0);\r\nmod_phy_reg(pi, 0x44d, (0x1 << 2), (1) << 2);\r\nmod_radio_reg(pi, RADIO_2064_REG0F7, 0x4, 0x4);\r\nmod_radio_reg(pi, RADIO_2064_REG0F1, 0x3, 0);\r\nmod_radio_reg(pi, RADIO_2064_REG0F2, 0xF8, 0x90);\r\nmod_radio_reg(pi, RADIO_2064_REG0F3, 0x3, 0x2);\r\nmod_radio_reg(pi, RADIO_2064_REG0F3, 0xf0, 0xa0);\r\nmod_radio_reg(pi, RADIO_2064_REG11F, 0x2, 0x2);\r\nwlc_lcnphy_clear_tx_power_offsets(pi);\r\nmod_phy_reg(pi, 0x4d0, (0x1ff << 6), (10) << 6);\r\n}\r\n}\r\nstatic void wlc_lcnphy_rcal(struct brcms_phy *pi)\r\n{\r\nu8 rcal_value;\r\nand_radio_reg(pi, RADIO_2064_REG05B, 0xfD);\r\nor_radio_reg(pi, RADIO_2064_REG004, 0x40);\r\nor_radio_reg(pi, RADIO_2064_REG120, 0x10);\r\nor_radio_reg(pi, RADIO_2064_REG078, 0x80);\r\nor_radio_reg(pi, RADIO_2064_REG129, 0x02);\r\nor_radio_reg(pi, RADIO_2064_REG057, 0x01);\r\nor_radio_reg(pi, RADIO_2064_REG05B, 0x02);\r\nmdelay(5);\r\nSPINWAIT(!wlc_radio_2064_rcal_done(pi), 10 * 1000 * 1000);\r\nif (wlc_radio_2064_rcal_done(pi)) {\r\nrcal_value = (u8) read_radio_reg(pi, RADIO_2064_REG05C);\r\nrcal_value = rcal_value & 0x1f;\r\n}\r\nand_radio_reg(pi, RADIO_2064_REG05B, 0xfD);\r\nand_radio_reg(pi, RADIO_2064_REG057, 0xFE);\r\n}\r\nstatic void wlc_lcnphy_rc_cal(struct brcms_phy *pi)\r\n{\r\nu8 dflt_rc_cal_val;\r\nu16 flt_val;\r\ndflt_rc_cal_val = 7;\r\nif (LCNREV_IS(pi->pubpi.phy_rev, 1))\r\ndflt_rc_cal_val = 11;\r\nflt_val =\r\n(dflt_rc_cal_val << 10) | (dflt_rc_cal_val << 5) |\r\n(dflt_rc_cal_val);\r\nwrite_phy_reg(pi, 0x933, flt_val);\r\nwrite_phy_reg(pi, 0x934, flt_val);\r\nwrite_phy_reg(pi, 0x935, flt_val);\r\nwrite_phy_reg(pi, 0x936, flt_val);\r\nwrite_phy_reg(pi, 0x937, (flt_val & 0x1FF));\r\nreturn;\r\n}\r\nstatic void wlc_radio_2064_init(struct brcms_phy *pi)\r\n{\r\nu32 i;\r\nconst struct lcnphy_radio_regs *lcnphyregs = NULL;\r\nlcnphyregs = lcnphy_radio_regs_2064;\r\nfor (i = 0; lcnphyregs[i].address != 0xffff; i++)\r\nif (CHSPEC_IS5G(pi->radio_chanspec) && lcnphyregs[i].do_init_a)\r\nwrite_radio_reg(pi,\r\n((lcnphyregs[i].address & 0x3fff) |\r\nRADIO_DEFAULT_CORE),\r\n(u16) lcnphyregs[i].init_a);\r\nelse if (lcnphyregs[i].do_init_g)\r\nwrite_radio_reg(pi,\r\n((lcnphyregs[i].address & 0x3fff) |\r\nRADIO_DEFAULT_CORE),\r\n(u16) lcnphyregs[i].init_g);\r\nwrite_radio_reg(pi, RADIO_2064_REG032, 0x62);\r\nwrite_radio_reg(pi, RADIO_2064_REG033, 0x19);\r\nwrite_radio_reg(pi, RADIO_2064_REG090, 0x10);\r\nwrite_radio_reg(pi, RADIO_2064_REG010, 0x00);\r\nif (LCNREV_IS(pi->pubpi.phy_rev, 1)) {\r\nwrite_radio_reg(pi, RADIO_2064_REG060, 0x7f);\r\nwrite_radio_reg(pi, RADIO_2064_REG061, 0x72);\r\nwrite_radio_reg(pi, RADIO_2064_REG062, 0x7f);\r\n}\r\nwrite_radio_reg(pi, RADIO_2064_REG01D, 0x02);\r\nwrite_radio_reg(pi, RADIO_2064_REG01E, 0x06);\r\nmod_phy_reg(pi, 0x4ea, (0x7 << 0), 0 << 0);\r\nmod_phy_reg(pi, 0x4ea, (0x7 << 3), 1 << 3);\r\nmod_phy_reg(pi, 0x4ea, (0x7 << 6), 2 << 6);\r\nmod_phy_reg(pi, 0x4ea, (0x7 << 9), 3 << 9);\r\nmod_phy_reg(pi, 0x4ea, (0x7 << 12), 4 << 12);\r\nwrite_phy_reg(pi, 0x4ea, 0x4688);\r\nmod_phy_reg(pi, 0x4eb, (0x7 << 0), 2 << 0);\r\nmod_phy_reg(pi, 0x4eb, (0x7 << 6), 0 << 6);\r\nmod_phy_reg(pi, 0x46a, (0xffff << 0), 25 << 0);\r\nwlc_lcnphy_set_tx_locc(pi, 0);\r\nwlc_lcnphy_rcal(pi);\r\nwlc_lcnphy_rc_cal(pi);\r\n}\r\nstatic void wlc_lcnphy_radio_init(struct brcms_phy *pi)\r\n{\r\nwlc_radio_2064_init(pi);\r\n}\r\nstatic void wlc_lcnphy_tbl_init(struct brcms_phy *pi)\r\n{\r\nuint idx;\r\nu8 phybw40;\r\nstruct phytbl_info tab;\r\nu32 val;\r\nphybw40 = CHSPEC_IS40(pi->radio_chanspec);\r\nfor (idx = 0; idx < dot11lcnphytbl_info_sz_rev0; idx++)\r\nwlc_lcnphy_write_table(pi, &dot11lcnphytbl_info_rev0[idx]);\r\nif (pi->sh->boardflags & BFL_FEM_BT) {\r\ntab.tbl_id = LCNPHY_TBL_ID_RFSEQ;\r\ntab.tbl_width = 16;\r\ntab.tbl_ptr = &val;\r\ntab.tbl_len = 1;\r\nval = 100;\r\ntab.tbl_offset = 4;\r\nwlc_lcnphy_write_table(pi, &tab);\r\n}\r\ntab.tbl_id = LCNPHY_TBL_ID_RFSEQ;\r\ntab.tbl_width = 16;\r\ntab.tbl_ptr = &val;\r\ntab.tbl_len = 1;\r\nval = 114;\r\ntab.tbl_offset = 0;\r\nwlc_lcnphy_write_table(pi, &tab);\r\nval = 130;\r\ntab.tbl_offset = 1;\r\nwlc_lcnphy_write_table(pi, &tab);\r\nval = 6;\r\ntab.tbl_offset = 8;\r\nwlc_lcnphy_write_table(pi, &tab);\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nif (pi->sh->boardflags & BFL_FEM)\r\nwlc_lcnphy_load_tx_gain_table(\r\npi,\r\ndot11lcnphy_2GHz_extPA_gaintable_rev0);\r\nelse\r\nwlc_lcnphy_load_tx_gain_table(\r\npi,\r\ndot11lcnphy_2GHz_gaintable_rev0);\r\n}\r\nif (LCNREV_IS(pi->pubpi.phy_rev, 2)) {\r\nconst struct phytbl_info *tb;\r\nint l;\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nl = dot11lcnphytbl_rx_gain_info_2G_rev2_sz;\r\nif (pi->sh->boardflags & BFL_EXTLNA)\r\ntb = dot11lcnphytbl_rx_gain_info_extlna_2G_rev2;\r\nelse\r\ntb = dot11lcnphytbl_rx_gain_info_2G_rev2;\r\n} else {\r\nl = dot11lcnphytbl_rx_gain_info_5G_rev2_sz;\r\nif (pi->sh->boardflags & BFL_EXTLNA_5GHz)\r\ntb = dot11lcnphytbl_rx_gain_info_extlna_5G_rev2;\r\nelse\r\ntb = dot11lcnphytbl_rx_gain_info_5G_rev2;\r\n}\r\nfor (idx = 0; idx < l; idx++)\r\nwlc_lcnphy_write_table(pi, &tb[idx]);\r\n}\r\nif ((pi->sh->boardflags & BFL_FEM)\r\n&& !(pi->sh->boardflags & BFL_FEM_BT))\r\nwlc_lcnphy_write_table(pi, &dot11lcn_sw_ctrl_tbl_info_4313_epa);\r\nelse if (pi->sh->boardflags & BFL_FEM_BT) {\r\nif (pi->sh->boardrev < 0x1250)\r\nwlc_lcnphy_write_table(\r\npi,\r\n&dot11lcn_sw_ctrl_tbl_info_4313_bt_epa);\r\nelse\r\nwlc_lcnphy_write_table(\r\npi,\r\n&dot11lcn_sw_ctrl_tbl_info_4313_bt_epa_p250);\r\n} else\r\nwlc_lcnphy_write_table(pi, &dot11lcn_sw_ctrl_tbl_info_4313);\r\nwlc_lcnphy_load_rfpower(pi);\r\nwlc_lcnphy_clear_papd_comptable(pi);\r\n}\r\nstatic void wlc_lcnphy_rev0_baseband_init(struct brcms_phy *pi)\r\n{\r\nu16 afectrl1;\r\nstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\r\nwrite_radio_reg(pi, RADIO_2064_REG11C, 0x0);\r\nwrite_phy_reg(pi, 0x43b, 0x0);\r\nwrite_phy_reg(pi, 0x43c, 0x0);\r\nwrite_phy_reg(pi, 0x44c, 0x0);\r\nwrite_phy_reg(pi, 0x4e6, 0x0);\r\nwrite_phy_reg(pi, 0x4f9, 0x0);\r\nwrite_phy_reg(pi, 0x4b0, 0x0);\r\nwrite_phy_reg(pi, 0x938, 0x0);\r\nwrite_phy_reg(pi, 0x4b0, 0x0);\r\nwrite_phy_reg(pi, 0x44e, 0);\r\nor_phy_reg(pi, 0x567, 0x03);\r\nor_phy_reg(pi, 0x44a, 0x44);\r\nwrite_phy_reg(pi, 0x44a, 0x80);\r\nif (!(pi->sh->boardflags & BFL_FEM))\r\nwlc_lcnphy_set_tx_pwr_by_index(pi, 52);\r\nif (0) {\r\nafectrl1 = 0;\r\nafectrl1 = (u16) ((pi_lcn->lcnphy_rssi_vf) |\r\n(pi_lcn->lcnphy_rssi_vc << 4) |\r\n(pi_lcn->lcnphy_rssi_gs << 10));\r\nwrite_phy_reg(pi, 0x43e, afectrl1);\r\n}\r\nmod_phy_reg(pi, 0x634, (0xff << 0), 0xC << 0);\r\nif (pi->sh->boardflags & BFL_FEM) {\r\nmod_phy_reg(pi, 0x634, (0xff << 0), 0xA << 0);\r\nwrite_phy_reg(pi, 0x910, 0x1);\r\n}\r\nmod_phy_reg(pi, 0x448, (0x3 << 8), 1 << 8);\r\nmod_phy_reg(pi, 0x608, (0xff << 0), 0x17 << 0);\r\nmod_phy_reg(pi, 0x604, (0x7ff << 0), 0x3EA << 0);\r\n}\r\nstatic void wlc_lcnphy_rev2_baseband_init(struct brcms_phy *pi)\r\n{\r\nif (CHSPEC_IS5G(pi->radio_chanspec)) {\r\nmod_phy_reg(pi, 0x416, (0xff << 0), 80 << 0);\r\nmod_phy_reg(pi, 0x416, (0xff << 8), 80 << 8);\r\n}\r\n}\r\nstatic void wlc_lcnphy_agc_temp_init(struct brcms_phy *pi)\r\n{\r\ns16 temp;\r\nstruct phytbl_info tab;\r\nu32 tableBuffer[2];\r\nstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\r\ntemp = (s16) read_phy_reg(pi, 0x4df);\r\npi_lcn->lcnphy_ofdmgainidxtableoffset = (temp & (0xff << 0)) >> 0;\r\nif (pi_lcn->lcnphy_ofdmgainidxtableoffset > 127)\r\npi_lcn->lcnphy_ofdmgainidxtableoffset -= 256;\r\npi_lcn->lcnphy_dsssgainidxtableoffset = (temp & (0xff << 8)) >> 8;\r\nif (pi_lcn->lcnphy_dsssgainidxtableoffset > 127)\r\npi_lcn->lcnphy_dsssgainidxtableoffset -= 256;\r\ntab.tbl_ptr = tableBuffer;\r\ntab.tbl_len = 2;\r\ntab.tbl_id = 17;\r\ntab.tbl_offset = 59;\r\ntab.tbl_width = 32;\r\nwlc_lcnphy_read_table(pi, &tab);\r\nif (tableBuffer[0] > 63)\r\ntableBuffer[0] -= 128;\r\npi_lcn->lcnphy_tr_R_gain_val = tableBuffer[0];\r\nif (tableBuffer[1] > 63)\r\ntableBuffer[1] -= 128;\r\npi_lcn->lcnphy_tr_T_gain_val = tableBuffer[1];\r\ntemp = (s16) (read_phy_reg(pi, 0x434) & (0xff << 0));\r\nif (temp > 127)\r\ntemp -= 256;\r\npi_lcn->lcnphy_input_pwr_offset_db = (s8) temp;\r\npi_lcn->lcnphy_Med_Low_Gain_db =\r\n(read_phy_reg(pi, 0x424) & (0xff << 8)) >> 8;\r\npi_lcn->lcnphy_Very_Low_Gain_db =\r\n(read_phy_reg(pi, 0x425) & (0xff << 0)) >> 0;\r\ntab.tbl_ptr = tableBuffer;\r\ntab.tbl_len = 2;\r\ntab.tbl_id = LCNPHY_TBL_ID_GAIN_IDX;\r\ntab.tbl_offset = 28;\r\ntab.tbl_width = 32;\r\nwlc_lcnphy_read_table(pi, &tab);\r\npi_lcn->lcnphy_gain_idx_14_lowword = tableBuffer[0];\r\npi_lcn->lcnphy_gain_idx_14_hiword = tableBuffer[1];\r\n}\r\nstatic void wlc_lcnphy_baseband_init(struct brcms_phy *pi)\r\n{\r\nwlc_lcnphy_tbl_init(pi);\r\nwlc_lcnphy_rev0_baseband_init(pi);\r\nif (LCNREV_IS(pi->pubpi.phy_rev, 2))\r\nwlc_lcnphy_rev2_baseband_init(pi);\r\nwlc_lcnphy_bu_tweaks(pi);\r\n}\r\nvoid wlc_phy_init_lcnphy(struct brcms_phy *pi)\r\n{\r\nu8 phybw40;\r\nstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\r\nphybw40 = CHSPEC_IS40(pi->radio_chanspec);\r\npi_lcn->lcnphy_cal_counter = 0;\r\npi_lcn->lcnphy_cal_temper = pi_lcn->lcnphy_rawtempsense;\r\nor_phy_reg(pi, 0x44a, 0x80);\r\nand_phy_reg(pi, 0x44a, 0x7f);\r\nwlc_lcnphy_afe_clk_init(pi, AFE_CLK_INIT_MODE_TXRX2X);\r\nwrite_phy_reg(pi, 0x60a, 160);\r\nwrite_phy_reg(pi, 0x46a, 25);\r\nwlc_lcnphy_baseband_init(pi);\r\nwlc_lcnphy_radio_init(pi);\r\nif (CHSPEC_IS2G(pi->radio_chanspec))\r\nwlc_lcnphy_tx_pwr_ctrl_init((struct brcms_phy_pub *) pi);\r\nwlc_phy_chanspec_set((struct brcms_phy_pub *) pi, pi->radio_chanspec);\r\nbcma_chipco_regctl_maskset(&pi->d11core->bus->drv_cc, 0, ~0xf, 0x9);\r\nbcma_chipco_chipctl_maskset(&pi->d11core->bus->drv_cc, 0, 0x0,\r\n0x03CDDDDD);\r\nif ((pi->sh->boardflags & BFL_FEM)\r\n&& wlc_lcnphy_tempsense_based_pwr_ctrl_enabled(pi))\r\nwlc_lcnphy_set_tx_pwr_by_index(pi, FIXED_TXPWR);\r\nwlc_lcnphy_agc_temp_init(pi);\r\nwlc_lcnphy_temp_adj(pi);\r\nmod_phy_reg(pi, 0x448, (0x1 << 14), (1) << 14);\r\nudelay(100);\r\nmod_phy_reg(pi, 0x448, (0x1 << 14), (0) << 14);\r\nwlc_lcnphy_set_tx_pwr_ctrl(pi, LCNPHY_TX_PWR_CTRL_HW);\r\npi_lcn->lcnphy_noise_samples = LCNPHY_NOISE_SAMPLES_DEFAULT;\r\nwlc_lcnphy_calib_modes(pi, PHY_PERICAL_PHYINIT);\r\n}\r\nstatic bool wlc_phy_txpwr_srom_read_lcnphy(struct brcms_phy *pi)\r\n{\r\ns8 txpwr = 0;\r\nint i;\r\nstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\r\nstruct ssb_sprom *sprom = &pi->d11core->bus->sprom;\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nu16 cckpo = 0;\r\nu32 offset_ofdm, offset_mcs;\r\npi_lcn->lcnphy_tr_isolation_mid = sprom->fem.ghz2.tr_iso;\r\npi_lcn->lcnphy_rx_power_offset = sprom->rxpo2g;\r\npi->txpa_2g[0] = sprom->pa0b0;\r\npi->txpa_2g[1] = sprom->pa0b1;\r\npi->txpa_2g[2] = sprom->pa0b2;\r\npi_lcn->lcnphy_rssi_vf = sprom->rssismf2g;\r\npi_lcn->lcnphy_rssi_vc = sprom->rssismc2g;\r\npi_lcn->lcnphy_rssi_gs = sprom->rssisav2g;\r\npi_lcn->lcnphy_rssi_vf_lowtemp = pi_lcn->lcnphy_rssi_vf;\r\npi_lcn->lcnphy_rssi_vc_lowtemp = pi_lcn->lcnphy_rssi_vc;\r\npi_lcn->lcnphy_rssi_gs_lowtemp = pi_lcn->lcnphy_rssi_gs;\r\npi_lcn->lcnphy_rssi_vf_hightemp = pi_lcn->lcnphy_rssi_vf;\r\npi_lcn->lcnphy_rssi_vc_hightemp = pi_lcn->lcnphy_rssi_vc;\r\npi_lcn->lcnphy_rssi_gs_hightemp = pi_lcn->lcnphy_rssi_gs;\r\ntxpwr = sprom->core_pwr_info[0].maxpwr_2g;\r\npi->tx_srom_max_2g = txpwr;\r\nfor (i = 0; i < PWRTBL_NUM_COEFF; i++) {\r\npi->txpa_2g_low_temp[i] = pi->txpa_2g[i];\r\npi->txpa_2g_high_temp[i] = pi->txpa_2g[i];\r\n}\r\ncckpo = sprom->cck2gpo;\r\noffset_ofdm = sprom->ofdm2gpo;\r\nif (cckpo) {\r\nuint max_pwr_chan = txpwr;\r\nfor (i = TXP_FIRST_CCK; i <= TXP_LAST_CCK; i++) {\r\npi->tx_srom_max_rate_2g[i] =\r\nmax_pwr_chan - ((cckpo & 0xf) * 2);\r\ncckpo >>= 4;\r\n}\r\nfor (i = TXP_FIRST_OFDM; i <= TXP_LAST_OFDM; i++) {\r\npi->tx_srom_max_rate_2g[i] =\r\nmax_pwr_chan -\r\n((offset_ofdm & 0xf) * 2);\r\noffset_ofdm >>= 4;\r\n}\r\n} else {\r\nu8 opo = 0;\r\nopo = sprom->opo;\r\nfor (i = TXP_FIRST_CCK; i <= TXP_LAST_CCK; i++)\r\npi->tx_srom_max_rate_2g[i] = txpwr;\r\nfor (i = TXP_FIRST_OFDM; i <= TXP_LAST_OFDM; i++) {\r\npi->tx_srom_max_rate_2g[i] = txpwr -\r\n((offset_ofdm & 0xf) * 2);\r\noffset_ofdm >>= 4;\r\n}\r\noffset_mcs = sprom->mcs2gpo[1] << 16;\r\noffset_mcs |= sprom->mcs2gpo[0];\r\npi_lcn->lcnphy_mcs20_po = offset_mcs;\r\nfor (i = TXP_FIRST_SISO_MCS_20;\r\ni <= TXP_LAST_SISO_MCS_20; i++) {\r\npi->tx_srom_max_rate_2g[i] =\r\ntxpwr - ((offset_mcs & 0xf) * 2);\r\noffset_mcs >>= 4;\r\n}\r\n}\r\npi_lcn->lcnphy_rawtempsense = sprom->rawtempsense;\r\npi_lcn->lcnphy_measPower = sprom->measpower;\r\npi_lcn->lcnphy_tempsense_slope = sprom->tempsense_slope;\r\npi_lcn->lcnphy_hw_iqcal_en = sprom->hw_iqcal_en;\r\npi_lcn->lcnphy_iqcal_swp_dis = sprom->iqcal_swp_dis;\r\npi_lcn->lcnphy_tempcorrx = sprom->tempcorrx;\r\npi_lcn->lcnphy_tempsense_option = sprom->tempsense_option;\r\npi_lcn->lcnphy_freqoffset_corr = sprom->freqoffset_corr;\r\nif (sprom->ant_available_bg > 1)\r\nwlc_phy_ant_rxdiv_set((struct brcms_phy_pub *) pi,\r\nsprom->ant_available_bg);\r\n}\r\npi_lcn->lcnphy_cck_dig_filt_type = -1;\r\nreturn true;\r\n}\r\nvoid wlc_2064_vco_cal(struct brcms_phy *pi)\r\n{\r\nu8 calnrst;\r\nmod_radio_reg(pi, RADIO_2064_REG057, 1 << 3, 1 << 3);\r\ncalnrst = (u8) read_radio_reg(pi, RADIO_2064_REG056) & 0xf8;\r\nwrite_radio_reg(pi, RADIO_2064_REG056, calnrst);\r\nudelay(1);\r\nwrite_radio_reg(pi, RADIO_2064_REG056, calnrst | 0x03);\r\nudelay(1);\r\nwrite_radio_reg(pi, RADIO_2064_REG056, calnrst | 0x07);\r\nudelay(300);\r\nmod_radio_reg(pi, RADIO_2064_REG057, 1 << 3, 0);\r\n}\r\nbool wlc_phy_tpc_isenabled_lcnphy(struct brcms_phy *pi)\r\n{\r\nif (wlc_lcnphy_tempsense_based_pwr_ctrl_enabled(pi))\r\nreturn 0;\r\nelse\r\nreturn (LCNPHY_TX_PWR_CTRL_HW ==\r\nwlc_lcnphy_get_tx_pwr_ctrl((pi)));\r\n}\r\nvoid wlc_phy_txpower_recalc_target_lcnphy(struct brcms_phy *pi)\r\n{\r\nu16 pwr_ctrl;\r\nif (wlc_lcnphy_tempsense_based_pwr_ctrl_enabled(pi)) {\r\nwlc_lcnphy_calib_modes(pi, LCNPHY_PERICAL_TEMPBASED_TXPWRCTRL);\r\n} else if (wlc_lcnphy_tssi_based_pwr_ctrl_enabled(pi)) {\r\npwr_ctrl = wlc_lcnphy_get_tx_pwr_ctrl(pi);\r\nwlc_lcnphy_set_tx_pwr_ctrl(pi, LCNPHY_TX_PWR_CTRL_OFF);\r\nwlc_lcnphy_txpower_recalc_target(pi);\r\nwlc_lcnphy_set_tx_pwr_ctrl(pi, pwr_ctrl);\r\n}\r\n}\r\nvoid wlc_phy_chanspec_set_lcnphy(struct brcms_phy *pi, u16 chanspec)\r\n{\r\nu8 channel = CHSPEC_CHANNEL(chanspec);\r\nwlc_phy_chanspec_radio_set((struct brcms_phy_pub *)pi, chanspec);\r\nwlc_lcnphy_set_chanspec_tweaks(pi, pi->radio_chanspec);\r\nor_phy_reg(pi, 0x44a, 0x44);\r\nwrite_phy_reg(pi, 0x44a, 0x80);\r\nwlc_lcnphy_radio_2064_channel_tune_4313(pi, channel);\r\nudelay(1000);\r\nwlc_lcnphy_toggle_afe_pwdn(pi);\r\nwrite_phy_reg(pi, 0x657, lcnphy_sfo_cfg[channel - 1].ptcentreTs20);\r\nwrite_phy_reg(pi, 0x658, lcnphy_sfo_cfg[channel - 1].ptcentreFactor);\r\nif (CHSPEC_CHANNEL(pi->radio_chanspec) == 14) {\r\nmod_phy_reg(pi, 0x448, (0x3 << 8), (2) << 8);\r\nwlc_lcnphy_load_tx_iir_filter(pi, false, 3);\r\n} else {\r\nmod_phy_reg(pi, 0x448, (0x3 << 8), (1) << 8);\r\nwlc_lcnphy_load_tx_iir_filter(pi, false, 2);\r\n}\r\nif (pi->sh->boardflags & BFL_FEM)\r\nwlc_lcnphy_load_tx_iir_filter(pi, true, 0);\r\nelse\r\nwlc_lcnphy_load_tx_iir_filter(pi, true, 3);\r\nmod_phy_reg(pi, 0x4eb, (0x7 << 3), (1) << 3);\r\n}\r\nvoid wlc_phy_detach_lcnphy(struct brcms_phy *pi)\r\n{\r\nkfree(pi->u.pi_lcnphy);\r\n}\r\nbool wlc_phy_attach_lcnphy(struct brcms_phy *pi)\r\n{\r\nstruct brcms_phy_lcnphy *pi_lcn;\r\npi->u.pi_lcnphy = kzalloc(sizeof(struct brcms_phy_lcnphy), GFP_ATOMIC);\r\nif (pi->u.pi_lcnphy == NULL)\r\nreturn false;\r\npi_lcn = pi->u.pi_lcnphy;\r\nif (0 == (pi->sh->boardflags & BFL_NOPA)) {\r\npi->hwpwrctrl = true;\r\npi->hwpwrctrl_capable = true;\r\n}\r\npi->xtalfreq = bcma_chipco_get_alp_clock(&pi->d11core->bus->drv_cc);\r\npi_lcn->lcnphy_papd_rxGnCtrl_init = 0;\r\npi->pi_fptr.init = wlc_phy_init_lcnphy;\r\npi->pi_fptr.calinit = wlc_phy_cal_init_lcnphy;\r\npi->pi_fptr.chanset = wlc_phy_chanspec_set_lcnphy;\r\npi->pi_fptr.txpwrrecalc = wlc_phy_txpower_recalc_target_lcnphy;\r\npi->pi_fptr.txiqccget = wlc_lcnphy_get_tx_iqcc;\r\npi->pi_fptr.txiqccset = wlc_lcnphy_set_tx_iqcc;\r\npi->pi_fptr.txloccget = wlc_lcnphy_get_tx_locc;\r\npi->pi_fptr.radioloftget = wlc_lcnphy_get_radio_loft;\r\npi->pi_fptr.detach = wlc_phy_detach_lcnphy;\r\nif (!wlc_phy_txpwr_srom_read_lcnphy(pi))\r\nreturn false;\r\nif ((pi->sh->boardflags & BFL_FEM) &&\r\n(LCNREV_IS(pi->pubpi.phy_rev, 1))) {\r\nif (pi_lcn->lcnphy_tempsense_option == 3) {\r\npi->hwpwrctrl = true;\r\npi->hwpwrctrl_capable = true;\r\npi->temppwrctrl_capable = false;\r\n} else {\r\npi->hwpwrctrl = false;\r\npi->hwpwrctrl_capable = false;\r\npi->temppwrctrl_capable = true;\r\n}\r\n}\r\nreturn true;\r\n}\r\nstatic void wlc_lcnphy_set_rx_gain(struct brcms_phy *pi, u32 gain)\r\n{\r\nu16 trsw, ext_lna, lna1, lna2, tia, biq0, biq1, gain0_15, gain16_19;\r\ntrsw = (gain & ((u32) 1 << 28)) ? 0 : 1;\r\next_lna = (u16) (gain >> 29) & 0x01;\r\nlna1 = (u16) (gain >> 0) & 0x0f;\r\nlna2 = (u16) (gain >> 4) & 0x0f;\r\ntia = (u16) (gain >> 8) & 0xf;\r\nbiq0 = (u16) (gain >> 12) & 0xf;\r\nbiq1 = (u16) (gain >> 16) & 0xf;\r\ngain0_15 = (u16) ((lna1 & 0x3) | ((lna1 & 0x3) << 2) |\r\n((lna2 & 0x3) << 4) | ((lna2 & 0x3) << 6) |\r\n((tia & 0xf) << 8) | ((biq0 & 0xf) << 12));\r\ngain16_19 = biq1;\r\nmod_phy_reg(pi, 0x44d, (0x1 << 0), trsw << 0);\r\nmod_phy_reg(pi, 0x4b1, (0x1 << 9), ext_lna << 9);\r\nmod_phy_reg(pi, 0x4b1, (0x1 << 10), ext_lna << 10);\r\nmod_phy_reg(pi, 0x4b6, (0xffff << 0), gain0_15 << 0);\r\nmod_phy_reg(pi, 0x4b7, (0xf << 0), gain16_19 << 0);\r\nif (CHSPEC_IS2G(pi->radio_chanspec)) {\r\nmod_phy_reg(pi, 0x4b1, (0x3 << 11), lna1 << 11);\r\nmod_phy_reg(pi, 0x4e6, (0x3 << 3), lna1 << 3);\r\n}\r\nwlc_lcnphy_rx_gain_override_enable(pi, true);\r\n}\r\nstatic u32 wlc_lcnphy_get_receive_power(struct brcms_phy *pi, s32 *gain_index)\r\n{\r\nu32 received_power = 0;\r\ns32 max_index = 0;\r\nu32 gain_code = 0;\r\nstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\r\nmax_index = 36;\r\nif (*gain_index >= 0)\r\ngain_code = lcnphy_23bitgaincode_table[*gain_index];\r\nif (-1 == *gain_index) {\r\n*gain_index = 0;\r\nwhile ((*gain_index <= (s32) max_index)\r\n&& (received_power < 700)) {\r\nwlc_lcnphy_set_rx_gain(pi,\r\nlcnphy_23bitgaincode_table\r\n[*gain_index]);\r\nreceived_power =\r\nwlc_lcnphy_measure_digital_power(\r\npi,\r\npi_lcn->\r\nlcnphy_noise_samples);\r\n(*gain_index)++;\r\n}\r\n(*gain_index)--;\r\n} else {\r\nwlc_lcnphy_set_rx_gain(pi, gain_code);\r\nreceived_power =\r\nwlc_lcnphy_measure_digital_power(pi,\r\npi_lcn->\r\nlcnphy_noise_samples);\r\n}\r\nreturn received_power;\r\n}\r\ns32 wlc_lcnphy_rx_signal_power(struct brcms_phy *pi, s32 gain_index)\r\n{\r\ns32 gain = 0;\r\ns32 nominal_power_db;\r\ns32 log_val, gain_mismatch, desired_gain, input_power_offset_db,\r\ninput_power_db;\r\ns32 received_power, temperature;\r\nu32 power;\r\nu32 msb1, msb2, val1, val2, diff1, diff2;\r\nuint freq;\r\nstruct brcms_phy_lcnphy *pi_lcn = pi->u.pi_lcnphy;\r\nreceived_power = wlc_lcnphy_get_receive_power(pi, &gain_index);\r\ngain = lcnphy_gain_table[gain_index];\r\nnominal_power_db = read_phy_reg(pi, 0x425) >> 8;\r\npower = (received_power * 16);\r\nmsb1 = ffs(power) - 1;\r\nmsb2 = msb1 + 1;\r\nval1 = 1 << msb1;\r\nval2 = 1 << msb2;\r\ndiff1 = (power - val1);\r\ndiff2 = (val2 - power);\r\nif (diff1 < diff2)\r\nlog_val = msb1;\r\nelse\r\nlog_val = msb2;\r\nlog_val = log_val * 3;\r\ngain_mismatch = (nominal_power_db / 2) - (log_val);\r\ndesired_gain = gain + gain_mismatch;\r\ninput_power_offset_db = read_phy_reg(pi, 0x434) & 0xFF;\r\nif (input_power_offset_db > 127)\r\ninput_power_offset_db -= 256;\r\ninput_power_db = input_power_offset_db - desired_gain;\r\ninput_power_db =\r\ninput_power_db + lcnphy_gain_index_offset_for_rssi[gain_index];\r\nfreq = wlc_phy_channel2freq(CHSPEC_CHANNEL(pi->radio_chanspec));\r\nif ((freq > 2427) && (freq <= 2467))\r\ninput_power_db = input_power_db - 1;\r\ntemperature = pi_lcn->lcnphy_lastsensed_temperature;\r\nif ((temperature - 15) < -30)\r\ninput_power_db =\r\ninput_power_db +\r\n(((temperature - 10 - 25) * 286) >> 12) -\r\n7;\r\nelse if ((temperature - 15) < 4)\r\ninput_power_db =\r\ninput_power_db +\r\n(((temperature - 10 - 25) * 286) >> 12) -\r\n3;\r\nelse\r\ninput_power_db = input_power_db +\r\n(((temperature - 10 - 25) * 286) >> 12);\r\nwlc_lcnphy_rx_gain_override_enable(pi, 0);\r\nreturn input_power_db;\r\n}

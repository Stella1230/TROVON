static inline void ehci_qtd_init(struct ehci_hcd *ehci, struct ehci_qtd *qtd,\r\ndma_addr_t dma)\r\n{\r\nmemset (qtd, 0, sizeof *qtd);\r\nqtd->qtd_dma = dma;\r\nqtd->hw_token = cpu_to_hc32(ehci, QTD_STS_HALT);\r\nqtd->hw_next = EHCI_LIST_END(ehci);\r\nqtd->hw_alt_next = EHCI_LIST_END(ehci);\r\nINIT_LIST_HEAD (&qtd->qtd_list);\r\n}\r\nstatic struct ehci_qtd *ehci_qtd_alloc (struct ehci_hcd *ehci, gfp_t flags)\r\n{\r\nstruct ehci_qtd *qtd;\r\ndma_addr_t dma;\r\nqtd = dma_pool_alloc (ehci->qtd_pool, flags, &dma);\r\nif (qtd != NULL) {\r\nehci_qtd_init(ehci, qtd, dma);\r\n}\r\nreturn qtd;\r\n}\r\nstatic inline void ehci_qtd_free (struct ehci_hcd *ehci, struct ehci_qtd *qtd)\r\n{\r\ndma_pool_free (ehci->qtd_pool, qtd, qtd->qtd_dma);\r\n}\r\nstatic void qh_destroy(struct ehci_hcd *ehci, struct ehci_qh *qh)\r\n{\r\nif (!list_empty (&qh->qtd_list) || qh->qh_next.ptr) {\r\nehci_dbg (ehci, "unused qh not empty!\n");\r\nBUG ();\r\n}\r\nif (qh->dummy)\r\nehci_qtd_free (ehci, qh->dummy);\r\ndma_pool_free(ehci->qh_pool, qh->hw, qh->qh_dma);\r\nkfree(qh);\r\n}\r\nstatic struct ehci_qh *ehci_qh_alloc (struct ehci_hcd *ehci, gfp_t flags)\r\n{\r\nstruct ehci_qh *qh;\r\ndma_addr_t dma;\r\nqh = kzalloc(sizeof *qh, GFP_ATOMIC);\r\nif (!qh)\r\ngoto done;\r\nqh->hw = (struct ehci_qh_hw *)\r\ndma_pool_alloc(ehci->qh_pool, flags, &dma);\r\nif (!qh->hw)\r\ngoto fail;\r\nmemset(qh->hw, 0, sizeof *qh->hw);\r\nqh->qh_dma = dma;\r\nINIT_LIST_HEAD (&qh->qtd_list);\r\nqh->dummy = ehci_qtd_alloc (ehci, flags);\r\nif (qh->dummy == NULL) {\r\nehci_dbg (ehci, "no dummy td\n");\r\ngoto fail1;\r\n}\r\ndone:\r\nreturn qh;\r\nfail1:\r\ndma_pool_free(ehci->qh_pool, qh->hw, qh->qh_dma);\r\nfail:\r\nkfree(qh);\r\nreturn NULL;\r\n}\r\nstatic void ehci_mem_cleanup (struct ehci_hcd *ehci)\r\n{\r\nif (ehci->async)\r\nqh_destroy(ehci, ehci->async);\r\nehci->async = NULL;\r\nif (ehci->dummy)\r\nqh_destroy(ehci, ehci->dummy);\r\nehci->dummy = NULL;\r\nif (ehci->qtd_pool)\r\ndma_pool_destroy (ehci->qtd_pool);\r\nehci->qtd_pool = NULL;\r\nif (ehci->qh_pool) {\r\ndma_pool_destroy (ehci->qh_pool);\r\nehci->qh_pool = NULL;\r\n}\r\nif (ehci->itd_pool)\r\ndma_pool_destroy (ehci->itd_pool);\r\nehci->itd_pool = NULL;\r\nif (ehci->sitd_pool)\r\ndma_pool_destroy (ehci->sitd_pool);\r\nehci->sitd_pool = NULL;\r\nif (ehci->periodic)\r\ndma_free_coherent (ehci_to_hcd(ehci)->self.controller,\r\nehci->periodic_size * sizeof (u32),\r\nehci->periodic, ehci->periodic_dma);\r\nehci->periodic = NULL;\r\nkfree(ehci->pshadow);\r\nehci->pshadow = NULL;\r\n}\r\nstatic int ehci_mem_init (struct ehci_hcd *ehci, gfp_t flags)\r\n{\r\nint i;\r\nehci->qtd_pool = dma_pool_create ("ehci_qtd",\r\nehci_to_hcd(ehci)->self.controller,\r\nsizeof (struct ehci_qtd),\r\n32 ,\r\n4096 );\r\nif (!ehci->qtd_pool) {\r\ngoto fail;\r\n}\r\nehci->qh_pool = dma_pool_create ("ehci_qh",\r\nehci_to_hcd(ehci)->self.controller,\r\nsizeof(struct ehci_qh_hw),\r\n32 ,\r\n4096 );\r\nif (!ehci->qh_pool) {\r\ngoto fail;\r\n}\r\nehci->async = ehci_qh_alloc (ehci, flags);\r\nif (!ehci->async) {\r\ngoto fail;\r\n}\r\nehci->itd_pool = dma_pool_create ("ehci_itd",\r\nehci_to_hcd(ehci)->self.controller,\r\nsizeof (struct ehci_itd),\r\n32 ,\r\n4096 );\r\nif (!ehci->itd_pool) {\r\ngoto fail;\r\n}\r\nehci->sitd_pool = dma_pool_create ("ehci_sitd",\r\nehci_to_hcd(ehci)->self.controller,\r\nsizeof (struct ehci_sitd),\r\n32 ,\r\n4096 );\r\nif (!ehci->sitd_pool) {\r\ngoto fail;\r\n}\r\nehci->periodic = (__le32 *)\r\ndma_alloc_coherent (ehci_to_hcd(ehci)->self.controller,\r\nehci->periodic_size * sizeof(__le32),\r\n&ehci->periodic_dma, 0);\r\nif (ehci->periodic == NULL) {\r\ngoto fail;\r\n}\r\nif (ehci->use_dummy_qh) {\r\nstruct ehci_qh_hw *hw;\r\nehci->dummy = ehci_qh_alloc(ehci, flags);\r\nif (!ehci->dummy)\r\ngoto fail;\r\nhw = ehci->dummy->hw;\r\nhw->hw_next = EHCI_LIST_END(ehci);\r\nhw->hw_qtd_next = EHCI_LIST_END(ehci);\r\nhw->hw_alt_next = EHCI_LIST_END(ehci);\r\nhw->hw_token &= ~QTD_STS_ACTIVE;\r\nehci->dummy->hw = hw;\r\nfor (i = 0; i < ehci->periodic_size; i++)\r\nehci->periodic[i] = ehci->dummy->qh_dma;\r\n} else {\r\nfor (i = 0; i < ehci->periodic_size; i++)\r\nehci->periodic[i] = EHCI_LIST_END(ehci);\r\n}\r\nehci->pshadow = kcalloc(ehci->periodic_size, sizeof(void *), flags);\r\nif (ehci->pshadow != NULL)\r\nreturn 0;\r\nfail:\r\nehci_dbg (ehci, "couldn't init memory\n");\r\nehci_mem_cleanup (ehci);\r\nreturn -ENOMEM;\r\n}

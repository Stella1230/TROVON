static int tosa_tg_send(struct spi_device *spi, int adrs, uint8_t data)\r\n{\r\nu8 buf[1];\r\nstruct spi_message msg;\r\nstruct spi_transfer xfer = {\r\n.len = 1,\r\n.cs_change = 1,\r\n.tx_buf = buf,\r\n};\r\nbuf[0] = ((adrs & 0x07) << 5) | (data & 0x1f);\r\nspi_message_init(&msg);\r\nspi_message_add_tail(&xfer, &msg);\r\nreturn spi_sync(spi, &msg);\r\n}\r\nint tosa_bl_enable(struct spi_device *spi, int enable)\r\n{\r\nreturn tosa_tg_send(spi, TG_GPODR2, enable ? 0x01 : 0x00);\r\n}\r\nstatic void tosa_lcd_tg_init(struct tosa_lcd_data *data)\r\n{\r\ngpio_set_value(TOSA_GPIO_TG_ON, 0);\r\nmdelay(60);\r\ntosa_tg_send(data->spi, TG_TPOSCTL, 0x00);\r\ntosa_tg_send(data->spi, TG_GPOSR, 0x02);\r\n}\r\nstatic void tosa_lcd_tg_on(struct tosa_lcd_data *data)\r\n{\r\nstruct spi_device *spi = data->spi;\r\nint value = TG_REG0_COLOR | TG_REG0_UD | TG_REG0_LR;\r\nif (data->is_vga)\r\nvalue |= TG_REG0_VQV;\r\ntosa_tg_send(spi, TG_PNLCTL, value);\r\ntosa_tg_send(spi, TG_PINICTL, 0x4);\r\nmdelay(50);\r\ntosa_tg_send(spi, TG_PINICTL, 0x0);\r\nif (!data->i2c) {\r\nstruct i2c_adapter *adap = i2c_get_adapter(0);\r\nstruct i2c_board_info info = {\r\n.type = "tosa-bl",\r\n.addr = DAC_BASE,\r\n.platform_data = data->spi,\r\n};\r\ndata->i2c = i2c_new_device(adap, &info);\r\n}\r\n}\r\nstatic void tosa_lcd_tg_off(struct tosa_lcd_data *data)\r\n{\r\nstruct spi_device *spi = data->spi;\r\ntosa_tg_send(spi, TG_PINICTL, 0x4);\r\nmdelay(50);\r\ntosa_tg_send(spi, TG_PINICTL, 0x6);\r\nmdelay(50);\r\ngpio_set_value(TOSA_GPIO_TG_ON, 1);\r\nmdelay(100);\r\n}\r\nint tosa_lcd_set_power(struct lcd_device *lcd, int power)\r\n{\r\nstruct tosa_lcd_data *data = lcd_get_data(lcd);\r\nif (POWER_IS_ON(power) && !POWER_IS_ON(data->lcd_power))\r\ntosa_lcd_tg_on(data);\r\nif (!POWER_IS_ON(power) && POWER_IS_ON(data->lcd_power))\r\ntosa_lcd_tg_off(data);\r\ndata->lcd_power = power;\r\nreturn 0;\r\n}\r\nstatic int tosa_lcd_get_power(struct lcd_device *lcd)\r\n{\r\nstruct tosa_lcd_data *data = lcd_get_data(lcd);\r\nreturn data->lcd_power;\r\n}\r\nstatic int tosa_lcd_set_mode(struct lcd_device *lcd, struct fb_videomode *mode)\r\n{\r\nstruct tosa_lcd_data *data = lcd_get_data(lcd);\r\nif (mode->xres == 320 || mode->yres == 320)\r\ndata->is_vga = false;\r\nelse\r\ndata->is_vga = true;\r\nif (POWER_IS_ON(data->lcd_power))\r\ntosa_lcd_tg_on(data);\r\nreturn 0;\r\n}\r\nstatic int tosa_lcd_probe(struct spi_device *spi)\r\n{\r\nint ret;\r\nstruct tosa_lcd_data *data;\r\ndata = devm_kzalloc(&spi->dev, sizeof(struct tosa_lcd_data),\r\nGFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\ndata->is_vga = true;\r\nspi->bits_per_word = 8;\r\nret = spi_setup(spi);\r\nif (ret < 0)\r\nreturn ret;\r\ndata->spi = spi;\r\nspi_set_drvdata(spi, data);\r\nret = devm_gpio_request_one(&spi->dev, TOSA_GPIO_TG_ON,\r\nGPIOF_OUT_INIT_LOW, "tg #pwr");\r\nif (ret < 0)\r\ngoto err_gpio_tg;\r\nmdelay(60);\r\ntosa_lcd_tg_init(data);\r\ntosa_lcd_tg_on(data);\r\ndata->lcd = lcd_device_register("tosa-lcd", &spi->dev, data,\r\n&tosa_lcd_ops);\r\nif (IS_ERR(data->lcd)) {\r\nret = PTR_ERR(data->lcd);\r\ndata->lcd = NULL;\r\ngoto err_register;\r\n}\r\nreturn 0;\r\nerr_register:\r\ntosa_lcd_tg_off(data);\r\nerr_gpio_tg:\r\nspi_set_drvdata(spi, NULL);\r\nreturn ret;\r\n}\r\nstatic int tosa_lcd_remove(struct spi_device *spi)\r\n{\r\nstruct tosa_lcd_data *data = spi_get_drvdata(spi);\r\nlcd_device_unregister(data->lcd);\r\nif (data->i2c)\r\ni2c_unregister_device(data->i2c);\r\ntosa_lcd_tg_off(data);\r\nspi_set_drvdata(spi, NULL);\r\nreturn 0;\r\n}\r\nstatic int tosa_lcd_suspend(struct device *dev)\r\n{\r\nstruct tosa_lcd_data *data = dev_get_drvdata(dev);\r\ntosa_lcd_tg_off(data);\r\nreturn 0;\r\n}\r\nstatic int tosa_lcd_resume(struct device *dev)\r\n{\r\nstruct tosa_lcd_data *data = dev_get_drvdata(dev);\r\ntosa_lcd_tg_init(data);\r\nif (POWER_IS_ON(data->lcd_power))\r\ntosa_lcd_tg_on(data);\r\nelse\r\ntosa_lcd_tg_off(data);\r\nreturn 0;\r\n}

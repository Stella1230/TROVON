struct pci_dev *\r\npci_find_upstream_pcie_bridge(struct pci_dev *pdev)\r\n{\r\nstruct pci_dev *tmp = NULL;\r\nif (pci_is_pcie(pdev))\r\nreturn NULL;\r\nwhile (1) {\r\nif (pci_is_root_bus(pdev->bus))\r\nbreak;\r\npdev = pdev->bus->self;\r\nif (!pci_is_pcie(pdev)) {\r\ntmp = pdev;\r\ncontinue;\r\n}\r\nif (pci_pcie_type(pdev) != PCI_EXP_TYPE_PCI_BRIDGE) {\r\nWARN_ON_ONCE(1);\r\nreturn NULL;\r\n}\r\nreturn pdev;\r\n}\r\nreturn tmp;\r\n}\r\nstatic struct pci_bus *pci_do_find_bus(struct pci_bus *bus, unsigned char busnr)\r\n{\r\nstruct pci_bus* child;\r\nstruct list_head *tmp;\r\nif(bus->number == busnr)\r\nreturn bus;\r\nlist_for_each(tmp, &bus->children) {\r\nchild = pci_do_find_bus(pci_bus_b(tmp), busnr);\r\nif(child)\r\nreturn child;\r\n}\r\nreturn NULL;\r\n}\r\nstruct pci_bus * pci_find_bus(int domain, int busnr)\r\n{\r\nstruct pci_bus *bus = NULL;\r\nstruct pci_bus *tmp_bus;\r\nwhile ((bus = pci_find_next_bus(bus)) != NULL) {\r\nif (pci_domain_nr(bus) != domain)\r\ncontinue;\r\ntmp_bus = pci_do_find_bus(bus, busnr);\r\nif (tmp_bus)\r\nreturn tmp_bus;\r\n}\r\nreturn NULL;\r\n}\r\nstruct pci_bus *\r\npci_find_next_bus(const struct pci_bus *from)\r\n{\r\nstruct list_head *n;\r\nstruct pci_bus *b = NULL;\r\nWARN_ON(in_interrupt());\r\ndown_read(&pci_bus_sem);\r\nn = from ? from->node.next : pci_root_buses.next;\r\nif (n != &pci_root_buses)\r\nb = pci_bus_b(n);\r\nup_read(&pci_bus_sem);\r\nreturn b;\r\n}\r\nstruct pci_dev *pci_get_slot(struct pci_bus *bus, unsigned int devfn)\r\n{\r\nstruct pci_dev *dev;\r\nWARN_ON(in_interrupt());\r\ndown_read(&pci_bus_sem);\r\nlist_for_each_entry(dev, &bus->devices, bus_list) {\r\nif (dev->devfn == devfn)\r\ngoto out;\r\n}\r\ndev = NULL;\r\nout:\r\npci_dev_get(dev);\r\nup_read(&pci_bus_sem);\r\nreturn dev;\r\n}\r\nstruct pci_dev *pci_get_domain_bus_and_slot(int domain, unsigned int bus,\r\nunsigned int devfn)\r\n{\r\nstruct pci_dev *dev = NULL;\r\nfor_each_pci_dev(dev) {\r\nif (pci_domain_nr(dev->bus) == domain &&\r\n(dev->bus->number == bus && dev->devfn == devfn))\r\nreturn dev;\r\n}\r\nreturn NULL;\r\n}\r\nstatic int match_pci_dev_by_id(struct device *dev, void *data)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(dev);\r\nstruct pci_device_id *id = data;\r\nif (pci_match_one_device(id, pdev))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic struct pci_dev *pci_get_dev_by_id(const struct pci_device_id *id,\r\nstruct pci_dev *from)\r\n{\r\nstruct device *dev;\r\nstruct device *dev_start = NULL;\r\nstruct pci_dev *pdev = NULL;\r\nWARN_ON(in_interrupt());\r\nif (from)\r\ndev_start = &from->dev;\r\ndev = bus_find_device(&pci_bus_type, dev_start, (void *)id,\r\nmatch_pci_dev_by_id);\r\nif (dev)\r\npdev = to_pci_dev(dev);\r\nif (from)\r\npci_dev_put(from);\r\nreturn pdev;\r\n}\r\nstruct pci_dev *pci_get_subsys(unsigned int vendor, unsigned int device,\r\nunsigned int ss_vendor, unsigned int ss_device,\r\nstruct pci_dev *from)\r\n{\r\nstruct pci_device_id id = {\r\n.vendor = vendor,\r\n.device = device,\r\n.subvendor = ss_vendor,\r\n.subdevice = ss_device,\r\n};\r\nreturn pci_get_dev_by_id(&id, from);\r\n}\r\nstruct pci_dev *\r\npci_get_device(unsigned int vendor, unsigned int device, struct pci_dev *from)\r\n{\r\nreturn pci_get_subsys(vendor, device, PCI_ANY_ID, PCI_ANY_ID, from);\r\n}\r\nstruct pci_dev *pci_get_class(unsigned int class, struct pci_dev *from)\r\n{\r\nstruct pci_device_id id = {\r\n.vendor = PCI_ANY_ID,\r\n.device = PCI_ANY_ID,\r\n.subvendor = PCI_ANY_ID,\r\n.subdevice = PCI_ANY_ID,\r\n.class_mask = PCI_ANY_ID,\r\n.class = class,\r\n};\r\nreturn pci_get_dev_by_id(&id, from);\r\n}\r\nint pci_dev_present(const struct pci_device_id *ids)\r\n{\r\nstruct pci_dev *found = NULL;\r\nWARN_ON(in_interrupt());\r\nwhile (ids->vendor || ids->subvendor || ids->class_mask) {\r\nfound = pci_get_dev_by_id(ids, NULL);\r\nif (found) {\r\npci_dev_put(found);\r\nreturn 1;\r\n}\r\nids++;\r\n}\r\nreturn 0;\r\n}

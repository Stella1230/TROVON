struct dma_async_tx_descriptor *\r\nasync_memcpy(struct page *dest, struct page *src, unsigned int dest_offset,\r\nunsigned int src_offset, size_t len,\r\nstruct async_submit_ctl *submit)\r\n{\r\nstruct dma_chan *chan = async_tx_find_channel(submit, DMA_MEMCPY,\r\n&dest, 1, &src, 1, len);\r\nstruct dma_device *device = chan ? chan->device : NULL;\r\nstruct dma_async_tx_descriptor *tx = NULL;\r\nif (device && is_dma_copy_aligned(device, src_offset, dest_offset, len)) {\r\ndma_addr_t dma_dest, dma_src;\r\nunsigned long dma_prep_flags = 0;\r\nif (submit->cb_fn)\r\ndma_prep_flags |= DMA_PREP_INTERRUPT;\r\nif (submit->flags & ASYNC_TX_FENCE)\r\ndma_prep_flags |= DMA_PREP_FENCE;\r\ndma_dest = dma_map_page(device->dev, dest, dest_offset, len,\r\nDMA_FROM_DEVICE);\r\ndma_src = dma_map_page(device->dev, src, src_offset, len,\r\nDMA_TO_DEVICE);\r\ntx = device->device_prep_dma_memcpy(chan, dma_dest, dma_src,\r\nlen, dma_prep_flags);\r\nif (!tx) {\r\ndma_unmap_page(device->dev, dma_dest, len,\r\nDMA_FROM_DEVICE);\r\ndma_unmap_page(device->dev, dma_src, len,\r\nDMA_TO_DEVICE);\r\n}\r\n}\r\nif (tx) {\r\npr_debug("%s: (async) len: %zu\n", __func__, len);\r\nasync_tx_submit(chan, tx, submit);\r\n} else {\r\nvoid *dest_buf, *src_buf;\r\npr_debug("%s: (sync) len: %zu\n", __func__, len);\r\nasync_tx_quiesce(&submit->depend_tx);\r\ndest_buf = kmap_atomic(dest) + dest_offset;\r\nsrc_buf = kmap_atomic(src) + src_offset;\r\nmemcpy(dest_buf, src_buf, len);\r\nkunmap_atomic(src_buf);\r\nkunmap_atomic(dest_buf);\r\nasync_tx_sync_epilog(submit);\r\n}\r\nreturn tx;\r\n}

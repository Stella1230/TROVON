static void cbus_send_bit(struct cbus_host *host, unsigned bit)\r\n{\r\ngpio_set_value(host->dat_gpio, bit ? 1 : 0);\r\ngpio_set_value(host->clk_gpio, 1);\r\ngpio_set_value(host->clk_gpio, 0);\r\n}\r\nstatic void cbus_send_data(struct cbus_host *host, unsigned data, unsigned len)\r\n{\r\nint i;\r\nfor (i = len; i > 0; i--)\r\ncbus_send_bit(host, data & (1 << (i - 1)));\r\n}\r\nstatic int cbus_receive_bit(struct cbus_host *host)\r\n{\r\nint ret;\r\ngpio_set_value(host->clk_gpio, 1);\r\nret = gpio_get_value(host->dat_gpio);\r\ngpio_set_value(host->clk_gpio, 0);\r\nreturn ret;\r\n}\r\nstatic int cbus_receive_word(struct cbus_host *host)\r\n{\r\nint ret = 0;\r\nint i;\r\nfor (i = 16; i > 0; i--) {\r\nint bit = cbus_receive_bit(host);\r\nif (bit < 0)\r\nreturn bit;\r\nif (bit)\r\nret |= 1 << (i - 1);\r\n}\r\nreturn ret;\r\n}\r\nstatic int cbus_transfer(struct cbus_host *host, char rw, unsigned dev,\r\nunsigned reg, unsigned data)\r\n{\r\nunsigned long flags;\r\nint ret;\r\nspin_lock_irqsave(&host->lock, flags);\r\ngpio_set_value(host->sel_gpio, 0);\r\ngpio_direction_output(host->dat_gpio, 1);\r\ncbus_send_data(host, dev, CBUS_ADDR_BITS);\r\ncbus_send_bit(host, rw == I2C_SMBUS_READ);\r\ncbus_send_data(host, reg, CBUS_REG_BITS);\r\nif (rw == I2C_SMBUS_WRITE) {\r\ncbus_send_data(host, data, 16);\r\nret = 0;\r\n} else {\r\nret = gpio_direction_input(host->dat_gpio);\r\nif (ret) {\r\ndev_dbg(host->dev, "failed setting direction\n");\r\ngoto out;\r\n}\r\ngpio_set_value(host->clk_gpio, 1);\r\nret = cbus_receive_word(host);\r\nif (ret < 0) {\r\ndev_dbg(host->dev, "failed receiving data\n");\r\ngoto out;\r\n}\r\n}\r\ngpio_set_value(host->sel_gpio, 1);\r\ngpio_set_value(host->clk_gpio, 1);\r\ngpio_set_value(host->clk_gpio, 0);\r\nout:\r\nspin_unlock_irqrestore(&host->lock, flags);\r\nreturn ret;\r\n}\r\nstatic int cbus_i2c_smbus_xfer(struct i2c_adapter *adapter,\r\nu16 addr,\r\nunsigned short flags,\r\nchar read_write,\r\nu8 command,\r\nint size,\r\nunion i2c_smbus_data *data)\r\n{\r\nstruct cbus_host *chost = i2c_get_adapdata(adapter);\r\nint ret;\r\nif (size != I2C_SMBUS_WORD_DATA)\r\nreturn -EINVAL;\r\nret = cbus_transfer(chost, read_write == I2C_SMBUS_READ, addr,\r\ncommand, data->word);\r\nif (ret < 0)\r\nreturn ret;\r\nif (read_write == I2C_SMBUS_READ)\r\ndata->word = ret;\r\nreturn 0;\r\n}\r\nstatic u32 cbus_i2c_func(struct i2c_adapter *adapter)\r\n{\r\nreturn I2C_FUNC_SMBUS_READ_WORD_DATA | I2C_FUNC_SMBUS_WRITE_WORD_DATA;\r\n}\r\nstatic int cbus_i2c_remove(struct platform_device *pdev)\r\n{\r\nstruct i2c_adapter *adapter = platform_get_drvdata(pdev);\r\ni2c_del_adapter(adapter);\r\nreturn 0;\r\n}\r\nstatic int cbus_i2c_probe(struct platform_device *pdev)\r\n{\r\nstruct i2c_adapter *adapter;\r\nstruct cbus_host *chost;\r\nint ret;\r\nadapter = devm_kzalloc(&pdev->dev, sizeof(struct i2c_adapter),\r\nGFP_KERNEL);\r\nif (!adapter)\r\nreturn -ENOMEM;\r\nchost = devm_kzalloc(&pdev->dev, sizeof(*chost), GFP_KERNEL);\r\nif (!chost)\r\nreturn -ENOMEM;\r\nif (pdev->dev.of_node) {\r\nstruct device_node *dnode = pdev->dev.of_node;\r\nif (of_gpio_count(dnode) != 3)\r\nreturn -ENODEV;\r\nchost->clk_gpio = of_get_gpio(dnode, 0);\r\nchost->dat_gpio = of_get_gpio(dnode, 1);\r\nchost->sel_gpio = of_get_gpio(dnode, 2);\r\n} else if (pdev->dev.platform_data) {\r\nstruct i2c_cbus_platform_data *pdata = pdev->dev.platform_data;\r\nchost->clk_gpio = pdata->clk_gpio;\r\nchost->dat_gpio = pdata->dat_gpio;\r\nchost->sel_gpio = pdata->sel_gpio;\r\n} else {\r\nreturn -ENODEV;\r\n}\r\nadapter->owner = THIS_MODULE;\r\nadapter->class = I2C_CLASS_HWMON;\r\nadapter->dev.parent = &pdev->dev;\r\nadapter->nr = pdev->id;\r\nadapter->timeout = HZ;\r\nadapter->algo = &cbus_i2c_algo;\r\nstrlcpy(adapter->name, "CBUS I2C adapter", sizeof(adapter->name));\r\nspin_lock_init(&chost->lock);\r\nchost->dev = &pdev->dev;\r\nret = devm_gpio_request_one(&pdev->dev, chost->clk_gpio,\r\nGPIOF_OUT_INIT_LOW, "CBUS clk");\r\nif (ret)\r\nreturn ret;\r\nret = devm_gpio_request_one(&pdev->dev, chost->dat_gpio, GPIOF_IN,\r\n"CBUS data");\r\nif (ret)\r\nreturn ret;\r\nret = devm_gpio_request_one(&pdev->dev, chost->sel_gpio,\r\nGPIOF_OUT_INIT_HIGH, "CBUS sel");\r\nif (ret)\r\nreturn ret;\r\ni2c_set_adapdata(adapter, chost);\r\nplatform_set_drvdata(pdev, adapter);\r\nreturn i2c_add_numbered_adapter(adapter);\r\n}

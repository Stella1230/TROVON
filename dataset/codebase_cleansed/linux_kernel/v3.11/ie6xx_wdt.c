static void ie6xx_wdt_unlock_registers(void)\r\n{\r\noutb(0x80, ie6xx_wdt_data.sch_wdtba + RR0);\r\noutb(0x86, ie6xx_wdt_data.sch_wdtba + RR0);\r\n}\r\nstatic int ie6xx_wdt_ping(struct watchdog_device *wdd)\r\n{\r\nspin_lock(&ie6xx_wdt_data.unlock_sequence);\r\nie6xx_wdt_unlock_registers();\r\noutb(WDT_RELOAD, ie6xx_wdt_data.sch_wdtba + RR1);\r\nspin_unlock(&ie6xx_wdt_data.unlock_sequence);\r\nreturn 0;\r\n}\r\nstatic int ie6xx_wdt_set_timeout(struct watchdog_device *wdd, unsigned int t)\r\n{\r\nu32 preload;\r\nu64 clock;\r\nu8 wdtcr;\r\nclock = 33000000;\r\npreload = (t * clock) >> 15;\r\npreload -= 1;\r\nspin_lock(&ie6xx_wdt_data.unlock_sequence);\r\nwdtcr = resetmode & 0x38;\r\noutb(wdtcr, ie6xx_wdt_data.sch_wdtba + WDTCR);\r\nie6xx_wdt_unlock_registers();\r\noutl(0, ie6xx_wdt_data.sch_wdtba + PV1);\r\nie6xx_wdt_unlock_registers();\r\noutl(preload, ie6xx_wdt_data.sch_wdtba + PV2);\r\nie6xx_wdt_unlock_registers();\r\noutb(WDT_RELOAD | WDT_TOUT, ie6xx_wdt_data.sch_wdtba + RR1);\r\nspin_unlock(&ie6xx_wdt_data.unlock_sequence);\r\nwdd->timeout = t;\r\nreturn 0;\r\n}\r\nstatic int ie6xx_wdt_start(struct watchdog_device *wdd)\r\n{\r\nie6xx_wdt_set_timeout(wdd, wdd->timeout);\r\nspin_lock(&ie6xx_wdt_data.unlock_sequence);\r\noutb(WDT_ENABLE, ie6xx_wdt_data.sch_wdtba + WDTLR);\r\nspin_unlock(&ie6xx_wdt_data.unlock_sequence);\r\nreturn 0;\r\n}\r\nstatic int ie6xx_wdt_stop(struct watchdog_device *wdd)\r\n{\r\nif (inb(ie6xx_wdt_data.sch_wdtba + WDTLR) & WDT_LOCK)\r\nreturn -1;\r\nspin_lock(&ie6xx_wdt_data.unlock_sequence);\r\noutb(0, ie6xx_wdt_data.sch_wdtba + WDTLR);\r\nspin_unlock(&ie6xx_wdt_data.unlock_sequence);\r\nreturn 0;\r\n}\r\nstatic int ie6xx_wdt_dbg_show(struct seq_file *s, void *unused)\r\n{\r\nseq_printf(s, "PV1 = 0x%08x\n",\r\ninl(ie6xx_wdt_data.sch_wdtba + PV1));\r\nseq_printf(s, "PV2 = 0x%08x\n",\r\ninl(ie6xx_wdt_data.sch_wdtba + PV2));\r\nseq_printf(s, "RR = 0x%08x\n",\r\ninw(ie6xx_wdt_data.sch_wdtba + RR0));\r\nseq_printf(s, "WDTCR = 0x%08x\n",\r\ninw(ie6xx_wdt_data.sch_wdtba + WDTCR));\r\nseq_printf(s, "DCR = 0x%08x\n",\r\ninl(ie6xx_wdt_data.sch_wdtba + DCR));\r\nseq_printf(s, "WDTLR = 0x%08x\n",\r\ninw(ie6xx_wdt_data.sch_wdtba + WDTLR));\r\nseq_printf(s, "\n");\r\nreturn 0;\r\n}\r\nstatic int ie6xx_wdt_dbg_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ie6xx_wdt_dbg_show, NULL);\r\n}\r\nstatic void ie6xx_wdt_debugfs_init(void)\r\n{\r\nie6xx_wdt_data.debugfs = debugfs_create_file("ie6xx_wdt",\r\nS_IFREG | S_IRUGO, NULL, NULL, &ie6xx_wdt_dbg_operations);\r\n}\r\nstatic void ie6xx_wdt_debugfs_exit(void)\r\n{\r\ndebugfs_remove(ie6xx_wdt_data.debugfs);\r\n}\r\nstatic void ie6xx_wdt_debugfs_init(void)\r\n{\r\n}\r\nstatic void ie6xx_wdt_debugfs_exit(void)\r\n{\r\n}\r\nstatic int ie6xx_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nu8 wdtlr;\r\nint ret;\r\nres = platform_get_resource(pdev, IORESOURCE_IO, 0);\r\nif (!res)\r\nreturn -ENODEV;\r\nif (!request_region(res->start, resource_size(res), pdev->name)) {\r\ndev_err(&pdev->dev, "Watchdog region 0x%llx already in use!\n",\r\n(u64)res->start);\r\nreturn -EBUSY;\r\n}\r\nie6xx_wdt_data.sch_wdtba = res->start;\r\ndev_dbg(&pdev->dev, "WDT = 0x%X\n", ie6xx_wdt_data.sch_wdtba);\r\nie6xx_wdt_dev.timeout = timeout;\r\nwatchdog_set_nowayout(&ie6xx_wdt_dev, nowayout);\r\nspin_lock_init(&ie6xx_wdt_data.unlock_sequence);\r\nwdtlr = inb(ie6xx_wdt_data.sch_wdtba + WDTLR);\r\nif (wdtlr & WDT_LOCK)\r\ndev_warn(&pdev->dev,\r\n"Watchdog Timer is Locked (Reg=0x%x)\n", wdtlr);\r\nie6xx_wdt_debugfs_init();\r\nret = watchdog_register_device(&ie6xx_wdt_dev);\r\nif (ret) {\r\ndev_err(&pdev->dev,\r\n"Watchdog timer: cannot register device (err =%d)\n",\r\nret);\r\ngoto misc_register_error;\r\n}\r\nreturn 0;\r\nmisc_register_error:\r\nie6xx_wdt_debugfs_exit();\r\nrelease_region(res->start, resource_size(res));\r\nie6xx_wdt_data.sch_wdtba = 0;\r\nreturn ret;\r\n}\r\nstatic int ie6xx_wdt_remove(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nres = platform_get_resource(pdev, IORESOURCE_IO, 0);\r\nie6xx_wdt_stop(NULL);\r\nwatchdog_unregister_device(&ie6xx_wdt_dev);\r\nie6xx_wdt_debugfs_exit();\r\nrelease_region(res->start, resource_size(res));\r\nie6xx_wdt_data.sch_wdtba = 0;\r\nreturn 0;\r\n}\r\nstatic int __init ie6xx_wdt_init(void)\r\n{\r\nif ((timeout < MIN_TIME) ||\r\n(timeout > MAX_TIME)) {\r\npr_err("Watchdog timer: value of timeout %d (dec) "\r\n"is out of range from %d to %d (dec)\n",\r\ntimeout, MIN_TIME, MAX_TIME);\r\nreturn -EINVAL;\r\n}\r\nreturn platform_driver_register(&ie6xx_wdt_driver);\r\n}\r\nstatic void __exit ie6xx_wdt_exit(void)\r\n{\r\nplatform_driver_unregister(&ie6xx_wdt_driver);\r\n}

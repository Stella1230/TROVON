struct omap_dss_device *omap_encoder_get_dssdev(struct drm_encoder *encoder)\r\n{\r\nstruct omap_encoder *omap_encoder = to_omap_encoder(encoder);\r\nreturn omap_encoder->dssdev;\r\n}\r\nstatic void omap_encoder_destroy(struct drm_encoder *encoder)\r\n{\r\nstruct omap_encoder *omap_encoder = to_omap_encoder(encoder);\r\ndrm_encoder_cleanup(encoder);\r\nkfree(omap_encoder);\r\n}\r\nstatic void omap_encoder_dpms(struct drm_encoder *encoder, int mode)\r\n{\r\n}\r\nstatic bool omap_encoder_mode_fixup(struct drm_encoder *encoder,\r\nconst struct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nreturn true;\r\n}\r\nstatic void omap_encoder_mode_set(struct drm_encoder *encoder,\r\nstruct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\n}\r\nstatic void omap_encoder_prepare(struct drm_encoder *encoder)\r\n{\r\n}\r\nstatic void omap_encoder_commit(struct drm_encoder *encoder)\r\n{\r\n}\r\nint omap_encoder_set_enabled(struct drm_encoder *encoder, bool enabled)\r\n{\r\nstruct omap_encoder *omap_encoder = to_omap_encoder(encoder);\r\nstruct omap_dss_device *dssdev = omap_encoder->dssdev;\r\nstruct omap_dss_driver *dssdrv = dssdev->driver;\r\nif (enabled) {\r\nreturn dssdrv->enable(dssdev);\r\n} else {\r\ndssdrv->disable(dssdev);\r\nreturn 0;\r\n}\r\n}\r\nint omap_encoder_update(struct drm_encoder *encoder,\r\nstruct omap_overlay_manager *mgr,\r\nstruct omap_video_timings *timings)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct omap_encoder *omap_encoder = to_omap_encoder(encoder);\r\nstruct omap_dss_device *dssdev = omap_encoder->dssdev;\r\nstruct omap_dss_driver *dssdrv = dssdev->driver;\r\nint ret;\r\ndssdev->output->manager = mgr;\r\nif (dssdrv->check_timings) {\r\nret = dssdrv->check_timings(dssdev, timings);\r\n} else {\r\nstruct omap_video_timings t = {0};\r\ndssdrv->get_timings(dssdev, &t);\r\nif (memcmp(timings, &t, sizeof(struct omap_video_timings)))\r\nret = -EINVAL;\r\nelse\r\nret = 0;\r\n}\r\nif (ret) {\r\ndev_err(dev->dev, "could not set timings: %d\n", ret);\r\nreturn ret;\r\n}\r\nif (dssdrv->set_timings)\r\ndssdrv->set_timings(dssdev, timings);\r\nreturn 0;\r\n}\r\nstruct drm_encoder *omap_encoder_init(struct drm_device *dev,\r\nstruct omap_dss_device *dssdev)\r\n{\r\nstruct drm_encoder *encoder = NULL;\r\nstruct omap_encoder *omap_encoder;\r\nomap_encoder = kzalloc(sizeof(*omap_encoder), GFP_KERNEL);\r\nif (!omap_encoder)\r\ngoto fail;\r\nomap_encoder->dssdev = dssdev;\r\nencoder = &omap_encoder->base;\r\ndrm_encoder_init(dev, encoder, &omap_encoder_funcs,\r\nDRM_MODE_ENCODER_TMDS);\r\ndrm_encoder_helper_add(encoder, &omap_encoder_helper_funcs);\r\nreturn encoder;\r\nfail:\r\nif (encoder)\r\nomap_encoder_destroy(encoder);\r\nreturn NULL;\r\n}

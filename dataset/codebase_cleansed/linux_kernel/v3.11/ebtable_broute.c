static int check(const struct ebt_table_info *info, unsigned int valid_hooks)\r\n{\r\nif (valid_hooks & ~(1 << NF_BR_BROUTING))\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int ebt_broute(struct sk_buff *skb)\r\n{\r\nint ret;\r\nret = ebt_do_table(NF_BR_BROUTING, skb, skb->dev, NULL,\r\ndev_net(skb->dev)->xt.broute_table);\r\nif (ret == NF_DROP)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int __net_init broute_net_init(struct net *net)\r\n{\r\nnet->xt.broute_table = ebt_register_table(net, &broute_table);\r\nreturn PTR_RET(net->xt.broute_table);\r\n}\r\nstatic void __net_exit broute_net_exit(struct net *net)\r\n{\r\nebt_unregister_table(net, net->xt.broute_table);\r\n}\r\nstatic int __init ebtable_broute_init(void)\r\n{\r\nint ret;\r\nret = register_pernet_subsys(&broute_net_ops);\r\nif (ret < 0)\r\nreturn ret;\r\nRCU_INIT_POINTER(br_should_route_hook,\r\n(br_should_route_hook_t *)ebt_broute);\r\nreturn 0;\r\n}\r\nstatic void __exit ebtable_broute_fini(void)\r\n{\r\nRCU_INIT_POINTER(br_should_route_hook, NULL);\r\nsynchronize_net();\r\nunregister_pernet_subsys(&broute_net_ops);\r\n}

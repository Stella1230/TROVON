int ieee80211_wx_set_freq(struct ieee80211_device *ieee, struct iw_request_info *a,\r\nunion iwreq_data *wrqu, char *b)\r\n{\r\nint ret;\r\nstruct iw_freq *fwrq = &wrqu->freq;\r\ndown(&ieee->wx_sem);\r\nif (ieee->iw_mode == IW_MODE_INFRA) {\r\nret = -EOPNOTSUPP;\r\ngoto out;\r\n}\r\nif (fwrq->e == 1) {\r\nif ((fwrq->m >= (int) 2.412e8 &&\r\nfwrq->m <= (int) 2.487e8)) {\r\nint f = fwrq->m / 100000;\r\nint c = 0;\r\nwhile ((c < 14) && (f != ieee80211_wlan_frequencies[c]))\r\nc++;\r\nfwrq->e = 0;\r\nfwrq->m = c + 1;\r\n}\r\n}\r\nif (fwrq->e > 0 || fwrq->m > 14 || fwrq->m < 1) {\r\nret = -EOPNOTSUPP;\r\ngoto out;\r\n} else {\r\nieee->current_network.channel = fwrq->m;\r\nieee->set_chan(ieee->dev, ieee->current_network.channel);\r\nif (ieee->iw_mode == IW_MODE_ADHOC || ieee->iw_mode == IW_MODE_MASTER)\r\nif (ieee->state == IEEE80211_LINKED) {\r\nieee80211_stop_send_beacons(ieee);\r\nieee80211_start_send_beacons(ieee);\r\n}\r\n}\r\nret = 0;\r\nout:\r\nup(&ieee->wx_sem);\r\nreturn ret;\r\n}\r\nint ieee80211_wx_get_freq(struct ieee80211_device *ieee,\r\nstruct iw_request_info *a,\r\nunion iwreq_data *wrqu, char *b)\r\n{\r\nstruct iw_freq *fwrq = &wrqu->freq;\r\nif (ieee->current_network.channel == 0)\r\nreturn -1;\r\nfwrq->m = ieee->current_network.channel;\r\nfwrq->e = 0;\r\nreturn 0;\r\n}\r\nint ieee80211_wx_get_wap(struct ieee80211_device *ieee,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nunsigned long flags;\r\nwrqu->ap_addr.sa_family = ARPHRD_ETHER;\r\nif (ieee->iw_mode == IW_MODE_MONITOR)\r\nreturn -1;\r\nspin_lock_irqsave(&ieee->lock, flags);\r\nif (ieee->state != IEEE80211_LINKED &&\r\nieee->state != IEEE80211_LINKED_SCANNING &&\r\nieee->wap_set == 0)\r\nmemset(wrqu->ap_addr.sa_data, 0, ETH_ALEN);\r\nelse\r\nmemcpy(wrqu->ap_addr.sa_data,\r\nieee->current_network.bssid, ETH_ALEN);\r\nspin_unlock_irqrestore(&ieee->lock, flags);\r\nreturn 0;\r\n}\r\nint ieee80211_wx_set_wap(struct ieee80211_device *ieee,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *awrq,\r\nchar *extra)\r\n{\r\nint ret = 0;\r\nunsigned long flags;\r\nshort ifup = ieee->proto_started;\r\nstruct sockaddr *temp = (struct sockaddr *)awrq;\r\nieee->sync_scan_hurryup = 1;\r\ndown(&ieee->wx_sem);\r\nif (ieee->iw_mode == IW_MODE_MASTER) {\r\nret = -1;\r\ngoto out;\r\n}\r\nif (temp->sa_family != ARPHRD_ETHER) {\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nif (ifup)\r\nieee80211_stop_protocol(ieee);\r\nspin_lock_irqsave(&ieee->lock, flags);\r\nmemcpy(ieee->current_network.bssid, temp->sa_data, ETH_ALEN);\r\nieee->wap_set = !is_zero_ether_addr(temp->sa_data);\r\nspin_unlock_irqrestore(&ieee->lock, flags);\r\nif (ifup)\r\nieee80211_start_protocol(ieee);\r\nout:\r\nup(&ieee->wx_sem);\r\nreturn ret;\r\n}\r\nint ieee80211_wx_get_essid(struct ieee80211_device *ieee, struct iw_request_info *a,\r\nunion iwreq_data *wrqu, char *b)\r\n{\r\nint len, ret = 0;\r\nunsigned long flags;\r\nif (ieee->iw_mode == IW_MODE_MONITOR)\r\nreturn -1;\r\nspin_lock_irqsave(&ieee->lock, flags);\r\nif (ieee->current_network.ssid[0] == '\0' ||\r\nieee->current_network.ssid_len == 0){\r\nret = -1;\r\ngoto out;\r\n}\r\nif (ieee->state != IEEE80211_LINKED &&\r\nieee->state != IEEE80211_LINKED_SCANNING &&\r\nieee->ssid_set == 0){\r\nret = -1;\r\ngoto out;\r\n}\r\nlen = ieee->current_network.ssid_len;\r\nwrqu->essid.length = len;\r\nstrncpy(b, ieee->current_network.ssid, len);\r\nwrqu->essid.flags = 1;\r\nout:\r\nspin_unlock_irqrestore(&ieee->lock, flags);\r\nreturn ret;\r\n}\r\nint ieee80211_wx_set_rate(struct ieee80211_device *ieee,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nu32 target_rate = wrqu->bitrate.value;\r\nif (target_rate == -1)\r\nieee->rate = 110;\r\nelse\r\nieee->rate = target_rate/100000;\r\nreturn 0;\r\n}\r\nint ieee80211_wx_get_rate(struct ieee80211_device *ieee,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nwrqu->bitrate.value = ieee->rate * 100000;\r\nreturn 0;\r\n}\r\nint ieee80211_wx_set_mode(struct ieee80211_device *ieee, struct iw_request_info *a,\r\nunion iwreq_data *wrqu, char *b)\r\n{\r\nieee->sync_scan_hurryup = 1;\r\ndown(&ieee->wx_sem);\r\nif (wrqu->mode == ieee->iw_mode)\r\ngoto out;\r\nif (wrqu->mode == IW_MODE_MONITOR)\r\nieee->dev->type = ARPHRD_IEEE80211;\r\nelse\r\nieee->dev->type = ARPHRD_ETHER;\r\nif (!ieee->proto_started) {\r\nieee->iw_mode = wrqu->mode;\r\n} else {\r\nieee80211_stop_protocol(ieee);\r\nieee->iw_mode = wrqu->mode;\r\nieee80211_start_protocol(ieee);\r\n}\r\nout:\r\nup(&ieee->wx_sem);\r\nreturn 0;\r\n}\r\nvoid ieee80211_wx_sync_scan_wq(struct work_struct *work)\r\n{\r\nstruct ieee80211_device *ieee = container_of(work, struct ieee80211_device, wx_sync_scan_wq);\r\nshort chan;\r\nchan = ieee->current_network.channel;\r\nif (ieee->data_hard_stop)\r\nieee->data_hard_stop(ieee->dev);\r\nieee80211_stop_send_beacons(ieee);\r\nieee->state = IEEE80211_LINKED_SCANNING;\r\nieee->link_change(ieee->dev);\r\nieee80211_start_scan_syncro(ieee);\r\nieee->set_chan(ieee->dev, chan);\r\nieee->state = IEEE80211_LINKED;\r\nieee->link_change(ieee->dev);\r\nif (ieee->data_hard_resume)\r\nieee->data_hard_resume(ieee->dev);\r\nif (ieee->iw_mode == IW_MODE_ADHOC || ieee->iw_mode == IW_MODE_MASTER)\r\nieee80211_start_send_beacons(ieee);\r\nup(&ieee->wx_sem);\r\n}\r\nint ieee80211_wx_set_scan(struct ieee80211_device *ieee, struct iw_request_info *a,\r\nunion iwreq_data *wrqu, char *b)\r\n{\r\nint ret = 0;\r\ndown(&ieee->wx_sem);\r\nif (ieee->iw_mode == IW_MODE_MONITOR || !(ieee->proto_started)) {\r\nret = -1;\r\ngoto out;\r\n}\r\nif (ieee->state == IEEE80211_LINKED) {\r\nqueue_work(ieee->wq, &ieee->wx_sync_scan_wq);\r\nreturn 0;\r\n}\r\nout:\r\nup(&ieee->wx_sem);\r\nreturn ret;\r\n}\r\nint ieee80211_wx_set_essid(struct ieee80211_device *ieee,\r\nstruct iw_request_info *a,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nint ret = 0, len;\r\nshort proto_started;\r\nunsigned long flags;\r\nieee->sync_scan_hurryup = 1;\r\ndown(&ieee->wx_sem);\r\nproto_started = ieee->proto_started;\r\nif (wrqu->essid.length > IW_ESSID_MAX_SIZE) {\r\nret = -E2BIG;\r\ngoto out;\r\n}\r\nif (ieee->iw_mode == IW_MODE_MONITOR) {\r\nret = -1;\r\ngoto out;\r\n}\r\nif (proto_started)\r\nieee80211_stop_protocol(ieee);\r\nspin_lock_irqsave(&ieee->lock, flags);\r\nif (wrqu->essid.flags && wrqu->essid.length) {\r\nlen = (wrqu->essid.length < IW_ESSID_MAX_SIZE) ? (wrqu->essid.length) : IW_ESSID_MAX_SIZE;\r\nmemset(ieee->current_network.ssid, 0, ieee->current_network.ssid_len);\r\nstrncpy(ieee->current_network.ssid, extra, len);\r\nieee->current_network.ssid_len = len;\r\nieee->ssid_set = 1;\r\nif (len == 0) {\r\nmemset(ieee->current_network.bssid, 0, ETH_ALEN);\r\nieee->current_network.capability = 0;\r\n}\r\n} else {\r\nieee->ssid_set = 0;\r\nieee->current_network.ssid[0] = '\0';\r\nieee->current_network.ssid_len = 0;\r\n}\r\nspin_unlock_irqrestore(&ieee->lock, flags);\r\nif (proto_started)\r\nieee80211_start_protocol(ieee);\r\nout:\r\nup(&ieee->wx_sem);\r\nreturn ret;\r\n}\r\nint ieee80211_wx_get_mode(struct ieee80211_device *ieee, struct iw_request_info *a,\r\nunion iwreq_data *wrqu, char *b)\r\n{\r\nwrqu->mode = ieee->iw_mode;\r\nreturn 0;\r\n}\r\nint ieee80211_wx_set_rawtx(struct ieee80211_device *ieee,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nint *parms = (int *)extra;\r\nint enable = (parms[0] > 0);\r\nshort prev = ieee->raw_tx;\r\ndown(&ieee->wx_sem);\r\nif (enable)\r\nieee->raw_tx = 1;\r\nelse\r\nieee->raw_tx = 0;\r\nnetdev_info(ieee->dev, "raw TX is %s\n",\r\nieee->raw_tx ? "enabled" : "disabled");\r\nif (ieee->iw_mode == IW_MODE_MONITOR) {\r\nif (prev == 0 && ieee->raw_tx) {\r\nif (ieee->data_hard_resume)\r\nieee->data_hard_resume(ieee->dev);\r\nnetif_carrier_on(ieee->dev);\r\n}\r\nif (prev && ieee->raw_tx == 1)\r\nnetif_carrier_off(ieee->dev);\r\n}\r\nup(&ieee->wx_sem);\r\nreturn 0;\r\n}\r\nint ieee80211_wx_get_name(struct ieee80211_device *ieee,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstrlcpy(wrqu->name, "802.11", IFNAMSIZ);\r\nif (ieee->modulation & IEEE80211_CCK_MODULATION) {\r\nstrlcat(wrqu->name, "b", IFNAMSIZ);\r\nif (ieee->modulation & IEEE80211_OFDM_MODULATION)\r\nstrlcat(wrqu->name, "/g", IFNAMSIZ);\r\n} else if (ieee->modulation & IEEE80211_OFDM_MODULATION)\r\nstrlcat(wrqu->name, "g", IFNAMSIZ);\r\nif ((ieee->state == IEEE80211_LINKED) ||\r\n(ieee->state == IEEE80211_LINKED_SCANNING))\r\nstrlcat(wrqu->name, " link", IFNAMSIZ);\r\nelse if (ieee->state != IEEE80211_NOLINK)\r\nstrlcat(wrqu->name, " .....", IFNAMSIZ);\r\nreturn 0;\r\n}\r\nint ieee80211_wx_set_power(struct ieee80211_device *ieee,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nint ret = 0;\r\nif ((!ieee->sta_wake_up) ||\r\n(!ieee->ps_request_tx_ack) ||\r\n(!ieee->enter_sleep_state) ||\r\n(!ieee->ps_is_queue_empty)) {\r\nprintk("ERROR. PS mode tried to be use but driver missed a callback\n\n");\r\nreturn -1;\r\n}\r\ndown(&ieee->wx_sem);\r\nif (wrqu->power.disabled) {\r\nieee->ps = IEEE80211_PS_DISABLED;\r\ngoto exit;\r\n}\r\nswitch (wrqu->power.flags & IW_POWER_MODE) {\r\ncase IW_POWER_UNICAST_R:\r\nieee->ps = IEEE80211_PS_UNICAST;\r\nbreak;\r\ncase IW_POWER_ALL_R:\r\nieee->ps = IEEE80211_PS_UNICAST | IEEE80211_PS_MBCAST;\r\nbreak;\r\ncase IW_POWER_ON:\r\nieee->ps = IEEE80211_PS_DISABLED;\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\ngoto exit;\r\n}\r\nif (wrqu->power.flags & IW_POWER_TIMEOUT) {\r\nieee->ps_timeout = wrqu->power.value / 1000;\r\nprintk("Timeout %d\n", ieee->ps_timeout);\r\n}\r\nif (wrqu->power.flags & IW_POWER_PERIOD) {\r\nret = -EOPNOTSUPP;\r\ngoto exit;\r\n}\r\nexit:\r\nup(&ieee->wx_sem);\r\nreturn ret;\r\n}\r\nint ieee80211_wx_get_power(struct ieee80211_device *ieee,\r\nstruct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nint ret = 0;\r\ndown(&ieee->wx_sem);\r\nif (ieee->ps == IEEE80211_PS_DISABLED) {\r\nwrqu->power.disabled = 1;\r\ngoto exit;\r\n}\r\nwrqu->power.disabled = 0;\r\nwrqu->power.flags = IW_POWER_TIMEOUT;\r\nwrqu->power.value = ieee->ps_timeout * 1000;\r\nif (ieee->ps & IEEE80211_PS_MBCAST)\r\nwrqu->power.flags |= IW_POWER_ALL_R;\r\nelse\r\nwrqu->power.flags |= IW_POWER_UNICAST_R;\r\nexit:\r\nup(&ieee->wx_sem);\r\nreturn ret;\r\n}

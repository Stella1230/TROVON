static void txx9_irq_unmask(struct irq_data *d)\r\n{\r\nunsigned int irq_nr = d->irq - TXX9_IRQ_BASE;\r\nu32 __iomem *ilrp = &txx9_ircptr->ilr[(irq_nr % 16 ) / 2];\r\nint ofs = irq_nr / 16 * 16 + (irq_nr & 1) * 8;\r\n__raw_writel((__raw_readl(ilrp) & ~(0xff << ofs))\r\n| (txx9irq[irq_nr].level << ofs),\r\nilrp);\r\n#ifdef CONFIG_CPU_TX39XX\r\n__raw_writel(0, &txx9_ircptr->imr);\r\n__raw_writel(irc_elevel, &txx9_ircptr->imr);\r\n#endif\r\n}\r\nstatic inline void txx9_irq_mask(struct irq_data *d)\r\n{\r\nunsigned int irq_nr = d->irq - TXX9_IRQ_BASE;\r\nu32 __iomem *ilrp = &txx9_ircptr->ilr[(irq_nr % 16) / 2];\r\nint ofs = irq_nr / 16 * 16 + (irq_nr & 1) * 8;\r\n__raw_writel((__raw_readl(ilrp) & ~(0xff << ofs))\r\n| (irc_dlevel << ofs),\r\nilrp);\r\n#ifdef CONFIG_CPU_TX39XX\r\n__raw_writel(0, &txx9_ircptr->imr);\r\n__raw_writel(irc_elevel, &txx9_ircptr->imr);\r\n__raw_readl(&txx9_ircptr->ssr);\r\n#else\r\nmmiowb();\r\n#endif\r\n}\r\nstatic void txx9_irq_mask_ack(struct irq_data *d)\r\n{\r\nunsigned int irq_nr = d->irq - TXX9_IRQ_BASE;\r\ntxx9_irq_mask(d);\r\nif (unlikely(TXx9_IRCR_EDGE(txx9irq[irq_nr].mode)))\r\n__raw_writel(TXx9_IRSCR_EIClrE | irq_nr, &txx9_ircptr->scr);\r\n}\r\nstatic int txx9_irq_set_type(struct irq_data *d, unsigned int flow_type)\r\n{\r\nunsigned int irq_nr = d->irq - TXX9_IRQ_BASE;\r\nu32 cr;\r\nu32 __iomem *crp;\r\nint ofs;\r\nint mode;\r\nif (flow_type & IRQF_TRIGGER_PROBE)\r\nreturn 0;\r\nswitch (flow_type & IRQF_TRIGGER_MASK) {\r\ncase IRQF_TRIGGER_RISING: mode = TXx9_IRCR_UP; break;\r\ncase IRQF_TRIGGER_FALLING: mode = TXx9_IRCR_DOWN; break;\r\ncase IRQF_TRIGGER_HIGH: mode = TXx9_IRCR_HIGH; break;\r\ncase IRQF_TRIGGER_LOW: mode = TXx9_IRCR_LOW; break;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ncrp = &txx9_ircptr->cr[(unsigned int)irq_nr / 8];\r\ncr = __raw_readl(crp);\r\nofs = (irq_nr & (8 - 1)) * 2;\r\ncr &= ~(0x3 << ofs);\r\ncr |= (mode & 0x3) << ofs;\r\n__raw_writel(cr, crp);\r\ntxx9irq[irq_nr].mode = mode;\r\nreturn 0;\r\n}\r\nvoid __init txx9_irq_init(unsigned long baseaddr)\r\n{\r\nint i;\r\ntxx9_ircptr = ioremap(baseaddr, sizeof(struct txx9_irc_reg));\r\nfor (i = 0; i < TXx9_MAX_IR; i++) {\r\ntxx9irq[i].level = 4;\r\ntxx9irq[i].mode = TXx9_IRCR_LOW;\r\nirq_set_chip_and_handler(TXX9_IRQ_BASE + i, &txx9_irq_chip,\r\nhandle_level_irq);\r\n}\r\n__raw_writel(0, &txx9_ircptr->imr);\r\nfor (i = 0; i < 8; i++)\r\n__raw_writel(0, &txx9_ircptr->ilr[i]);\r\nfor (i = 0; i < 2; i++)\r\n__raw_writel(0, &txx9_ircptr->cr[i]);\r\n__raw_writel(TXx9_IRCER_ICE, &txx9_ircptr->cer);\r\n__raw_writel(irc_elevel, &txx9_ircptr->imr);\r\n}\r\nint __init txx9_irq_set_pri(int irc_irq, int new_pri)\r\n{\r\nint old_pri;\r\nif ((unsigned int)irc_irq >= TXx9_MAX_IR)\r\nreturn 0;\r\nold_pri = txx9irq[irc_irq].level;\r\ntxx9irq[irc_irq].level = new_pri;\r\nreturn old_pri;\r\n}\r\nint txx9_irq(void)\r\n{\r\nu32 csr = __raw_readl(&txx9_ircptr->csr);\r\nif (likely(!(csr & TXx9_IRCSR_IF)))\r\nreturn TXX9_IRQ_BASE + (csr & (TXx9_MAX_IR - 1));\r\nreturn -1;\r\n}

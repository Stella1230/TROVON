static void amiga_write_data(struct parport *p, unsigned char data)\r\n{\r\nDPRINTK(KERN_DEBUG "write_data %c\n",data);\r\nciaa.prb = data;\r\nmb();\r\n}\r\nstatic unsigned char amiga_read_data(struct parport *p)\r\n{\r\nreturn ciaa.prb;\r\n}\r\nstatic unsigned char control_amiga_to_pc(unsigned char control)\r\n{\r\nreturn PARPORT_CONTROL_SELECT |\r\nPARPORT_CONTROL_AUTOFD | PARPORT_CONTROL_STROBE;\r\n}\r\nstatic void amiga_write_control(struct parport *p, unsigned char control)\r\n{\r\nDPRINTK(KERN_DEBUG "write_control %02x\n",control);\r\n}\r\nstatic unsigned char amiga_read_control( struct parport *p)\r\n{\r\nDPRINTK(KERN_DEBUG "read_control \n");\r\nreturn control_amiga_to_pc(0);\r\n}\r\nstatic unsigned char amiga_frob_control( struct parport *p, unsigned char mask, unsigned char val)\r\n{\r\nunsigned char old;\r\nDPRINTK(KERN_DEBUG "frob_control mask %02x, value %02x\n",mask,val);\r\nold = amiga_read_control(p);\r\namiga_write_control(p, (old & ~mask) ^ val);\r\nreturn old;\r\n}\r\nstatic unsigned char status_amiga_to_pc(unsigned char status)\r\n{\r\nunsigned char ret = PARPORT_STATUS_BUSY | PARPORT_STATUS_ACK | PARPORT_STATUS_ERROR;\r\nif (status & 1)\r\nret &= ~PARPORT_STATUS_BUSY;\r\nif (status & 2)\r\nret |= PARPORT_STATUS_PAPEROUT;\r\nif (status & 4)\r\nret |= PARPORT_STATUS_SELECT;\r\nreturn ret;\r\n}\r\nstatic unsigned char amiga_read_status(struct parport *p)\r\n{\r\nunsigned char status;\r\nstatus = status_amiga_to_pc(ciab.pra & 7);\r\nDPRINTK(KERN_DEBUG "read_status %02x\n", status);\r\nreturn status;\r\n}\r\nstatic void amiga_enable_irq(struct parport *p)\r\n{\r\nenable_irq(IRQ_AMIGA_CIAA_FLG);\r\n}\r\nstatic void amiga_disable_irq(struct parport *p)\r\n{\r\ndisable_irq(IRQ_AMIGA_CIAA_FLG);\r\n}\r\nstatic void amiga_data_forward(struct parport *p)\r\n{\r\nDPRINTK(KERN_DEBUG "forward\n");\r\nciaa.ddrb = 0xff;\r\nmb();\r\n}\r\nstatic void amiga_data_reverse(struct parport *p)\r\n{\r\nDPRINTK(KERN_DEBUG "reverse\n");\r\nciaa.ddrb = 0;\r\nmb();\r\n}\r\nstatic void amiga_init_state(struct pardevice *dev, struct parport_state *s)\r\n{\r\ns->u.amiga.data = 0;\r\ns->u.amiga.datadir = 255;\r\ns->u.amiga.status = 0;\r\ns->u.amiga.statusdir = 0;\r\n}\r\nstatic void amiga_save_state(struct parport *p, struct parport_state *s)\r\n{\r\nmb();\r\ns->u.amiga.data = ciaa.prb;\r\ns->u.amiga.datadir = ciaa.ddrb;\r\ns->u.amiga.status = ciab.pra & 7;\r\ns->u.amiga.statusdir = ciab.ddra & 7;\r\nmb();\r\n}\r\nstatic void amiga_restore_state(struct parport *p, struct parport_state *s)\r\n{\r\nmb();\r\nciaa.prb = s->u.amiga.data;\r\nciaa.ddrb = s->u.amiga.datadir;\r\nciab.pra |= (ciab.pra & 0xf8) | s->u.amiga.status;\r\nciab.ddra |= (ciab.ddra & 0xf8) | s->u.amiga.statusdir;\r\nmb();\r\n}\r\nstatic int __init amiga_parallel_probe(struct platform_device *pdev)\r\n{\r\nstruct parport *p;\r\nint err;\r\nciaa.ddrb = 0xff;\r\nciab.ddra &= 0xf8;\r\nmb();\r\np = parport_register_port((unsigned long)&ciaa.prb, IRQ_AMIGA_CIAA_FLG,\r\nPARPORT_DMA_NONE, &pp_amiga_ops);\r\nif (!p)\r\nreturn -EBUSY;\r\nerr = request_irq(IRQ_AMIGA_CIAA_FLG, parport_irq_handler, 0, p->name,\r\np);\r\nif (err)\r\ngoto out_irq;\r\nprintk(KERN_INFO "%s: Amiga built-in port using irq\n", p->name);\r\nparport_announce_port(p);\r\nplatform_set_drvdata(pdev, p);\r\nreturn 0;\r\nout_irq:\r\nparport_put_port(p);\r\nreturn err;\r\n}\r\nstatic int __exit amiga_parallel_remove(struct platform_device *pdev)\r\n{\r\nstruct parport *port = platform_get_drvdata(pdev);\r\nparport_remove_port(port);\r\nif (port->irq != PARPORT_IRQ_NONE)\r\nfree_irq(IRQ_AMIGA_CIAA_FLG, port);\r\nparport_put_port(port);\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn 0;\r\n}

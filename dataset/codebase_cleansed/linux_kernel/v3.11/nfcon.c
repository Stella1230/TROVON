static void nfputs(const char *str, unsigned int count)\r\n{\r\nchar buf[68];\r\nbuf[64] = 0;\r\nwhile (count > 64) {\r\nmemcpy(buf, str, 64);\r\nnf_call(stderr_id, buf);\r\nstr += 64;\r\ncount -= 64;\r\n}\r\nmemcpy(buf, str, count);\r\nbuf[count] = 0;\r\nnf_call(stderr_id, buf);\r\n}\r\nstatic void nfcon_write(struct console *con, const char *str,\r\nunsigned int count)\r\n{\r\nnfputs(str, count);\r\n}\r\nstatic struct tty_driver *nfcon_device(struct console *con, int *index)\r\n{\r\n*index = 0;\r\nreturn (con->flags & CON_ENABLED) ? nfcon_tty_driver : NULL;\r\n}\r\nstatic int nfcon_tty_open(struct tty_struct *tty, struct file *filp)\r\n{\r\nreturn 0;\r\n}\r\nstatic void nfcon_tty_close(struct tty_struct *tty, struct file *filp)\r\n{\r\n}\r\nstatic int nfcon_tty_write(struct tty_struct *tty, const unsigned char *buf,\r\nint count)\r\n{\r\nnfputs(buf, count);\r\nreturn count;\r\n}\r\nstatic int nfcon_tty_put_char(struct tty_struct *tty, unsigned char ch)\r\n{\r\nchar temp[2] = { ch, 0 };\r\nnf_call(stderr_id, temp);\r\nreturn 1;\r\n}\r\nstatic int nfcon_tty_write_room(struct tty_struct *tty)\r\n{\r\nreturn 64;\r\n}\r\nstatic int __init nf_debug_setup(char *arg)\r\n{\r\nif (strcmp(arg, "nfcon"))\r\nreturn 0;\r\nstderr_id = nf_get_id("NF_STDERR");\r\nif (stderr_id) {\r\nnf_console.flags |= CON_ENABLED;\r\nregister_console(&nf_console);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init nfcon_init(void)\r\n{\r\nint res;\r\nstderr_id = nf_get_id("NF_STDERR");\r\nif (!stderr_id)\r\nreturn -ENODEV;\r\nnfcon_tty_driver = alloc_tty_driver(1);\r\nif (!nfcon_tty_driver)\r\nreturn -ENOMEM;\r\ntty_port_init(&nfcon_tty_port);\r\nnfcon_tty_driver->driver_name = "nfcon";\r\nnfcon_tty_driver->name = "nfcon";\r\nnfcon_tty_driver->type = TTY_DRIVER_TYPE_SYSTEM;\r\nnfcon_tty_driver->subtype = SYSTEM_TYPE_TTY;\r\nnfcon_tty_driver->init_termios = tty_std_termios;\r\nnfcon_tty_driver->flags = TTY_DRIVER_REAL_RAW;\r\ntty_set_operations(nfcon_tty_driver, &nfcon_tty_ops);\r\ntty_port_link_device(&nfcon_tty_port, nfcon_tty_driver, 0);\r\nres = tty_register_driver(nfcon_tty_driver);\r\nif (res) {\r\npr_err("failed to register nfcon tty driver\n");\r\nput_tty_driver(nfcon_tty_driver);\r\ntty_port_destroy(&nfcon_tty_port);\r\nreturn res;\r\n}\r\nif (!(nf_console.flags & CON_ENABLED))\r\nregister_console(&nf_console);\r\nreturn 0;\r\n}\r\nstatic void __exit nfcon_exit(void)\r\n{\r\nunregister_console(&nf_console);\r\ntty_unregister_driver(nfcon_tty_driver);\r\nput_tty_driver(nfcon_tty_driver);\r\ntty_port_destroy(&nfcon_tty_port);\r\n}

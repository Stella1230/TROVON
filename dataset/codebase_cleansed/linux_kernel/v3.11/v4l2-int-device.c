void v4l2_int_device_try_attach_all(void)\r\n{\r\nstruct v4l2_int_device *m, *s;\r\nlist_for_each_entry(m, &int_list, head) {\r\nif (m->type != v4l2_int_type_master)\r\ncontinue;\r\nlist_for_each_entry(s, &int_list, head) {\r\nif (s->type != v4l2_int_type_slave)\r\ncontinue;\r\nif (s->u.slave->master)\r\ncontinue;\r\nif (s->u.slave->attach_to[0] != 0\r\n&& strncmp(m->name, s->u.slave->attach_to,\r\nV4L2NAMESIZE))\r\ncontinue;\r\nif (!try_module_get(m->module))\r\ncontinue;\r\ns->u.slave->master = m;\r\nif (m->u.master->attach(s)) {\r\ns->u.slave->master = NULL;\r\nmodule_put(m->module);\r\ncontinue;\r\n}\r\n}\r\n}\r\n}\r\nstatic int ioctl_sort_cmp(const void *a, const void *b)\r\n{\r\nconst struct v4l2_int_ioctl_desc *d1 = a, *d2 = b;\r\nif (d1->num > d2->num)\r\nreturn 1;\r\nif (d1->num < d2->num)\r\nreturn -1;\r\nreturn 0;\r\n}\r\nint v4l2_int_device_register(struct v4l2_int_device *d)\r\n{\r\nif (d->type == v4l2_int_type_slave)\r\nsort(d->u.slave->ioctls, d->u.slave->num_ioctls,\r\nsizeof(struct v4l2_int_ioctl_desc),\r\n&ioctl_sort_cmp, NULL);\r\nmutex_lock(&mutex);\r\nlist_add(&d->head, &int_list);\r\nv4l2_int_device_try_attach_all();\r\nmutex_unlock(&mutex);\r\nreturn 0;\r\n}\r\nvoid v4l2_int_device_unregister(struct v4l2_int_device *d)\r\n{\r\nmutex_lock(&mutex);\r\nlist_del(&d->head);\r\nif (d->type == v4l2_int_type_slave\r\n&& d->u.slave->master != NULL) {\r\nd->u.slave->master->u.master->detach(d);\r\nmodule_put(d->u.slave->master->module);\r\nd->u.slave->master = NULL;\r\n}\r\nmutex_unlock(&mutex);\r\n}\r\nstatic v4l2_int_ioctl_func *find_ioctl(struct v4l2_int_slave *slave, int cmd,\r\nv4l2_int_ioctl_func *no_such_ioctl)\r\n{\r\nconst struct v4l2_int_ioctl_desc *first = slave->ioctls;\r\nconst struct v4l2_int_ioctl_desc *last =\r\nfirst + slave->num_ioctls - 1;\r\nwhile (first <= last) {\r\nconst struct v4l2_int_ioctl_desc *mid;\r\nmid = (last - first) / 2 + first;\r\nif (mid->num < cmd)\r\nfirst = mid + 1;\r\nelse if (mid->num > cmd)\r\nlast = mid - 1;\r\nelse\r\nreturn mid->func;\r\n}\r\nreturn no_such_ioctl;\r\n}\r\nstatic int no_such_ioctl_0(struct v4l2_int_device *d)\r\n{\r\nreturn -ENOIOCTLCMD;\r\n}\r\nint v4l2_int_ioctl_0(struct v4l2_int_device *d, int cmd)\r\n{\r\nreturn ((v4l2_int_ioctl_func_0 *)\r\nfind_ioctl(d->u.slave, cmd,\r\n(v4l2_int_ioctl_func *)no_such_ioctl_0))(d);\r\n}\r\nstatic int no_such_ioctl_1(struct v4l2_int_device *d, void *arg)\r\n{\r\nreturn -ENOIOCTLCMD;\r\n}\r\nint v4l2_int_ioctl_1(struct v4l2_int_device *d, int cmd, void *arg)\r\n{\r\nreturn ((v4l2_int_ioctl_func_1 *)\r\nfind_ioctl(d->u.slave, cmd,\r\n(v4l2_int_ioctl_func *)no_such_ioctl_1))(d, arg);\r\n}

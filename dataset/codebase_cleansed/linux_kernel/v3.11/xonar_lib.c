void xonar_enable_output(struct oxygen *chip)\r\n{\r\nstruct xonar_generic *data = chip->model_data;\r\noxygen_set_bits16(chip, OXYGEN_GPIO_CONTROL, data->output_enable_bit);\r\nmsleep(data->anti_pop_delay);\r\noxygen_set_bits16(chip, OXYGEN_GPIO_DATA, data->output_enable_bit);\r\n}\r\nvoid xonar_disable_output(struct oxygen *chip)\r\n{\r\nstruct xonar_generic *data = chip->model_data;\r\noxygen_clear_bits16(chip, OXYGEN_GPIO_DATA, data->output_enable_bit);\r\n}\r\nstatic void xonar_ext_power_gpio_changed(struct oxygen *chip)\r\n{\r\nstruct xonar_generic *data = chip->model_data;\r\nu8 has_power;\r\nhas_power = !!(oxygen_read8(chip, data->ext_power_reg)\r\n& data->ext_power_bit);\r\nif (has_power != data->has_power) {\r\ndata->has_power = has_power;\r\nif (has_power) {\r\nsnd_printk(KERN_NOTICE "power restored\n");\r\n} else {\r\nsnd_printk(KERN_CRIT\r\n"Hey! Don't unplug the power cable!\n");\r\n}\r\n}\r\n}\r\nvoid xonar_init_ext_power(struct oxygen *chip)\r\n{\r\nstruct xonar_generic *data = chip->model_data;\r\noxygen_set_bits8(chip, data->ext_power_int_reg,\r\ndata->ext_power_bit);\r\nchip->interrupt_mask |= OXYGEN_INT_GPIO;\r\nchip->model.gpio_changed = xonar_ext_power_gpio_changed;\r\ndata->has_power = !!(oxygen_read8(chip, data->ext_power_reg)\r\n& data->ext_power_bit);\r\n}\r\nvoid xonar_init_cs53x1(struct oxygen *chip)\r\n{\r\noxygen_set_bits16(chip, OXYGEN_GPIO_CONTROL, GPIO_CS53x1_M_MASK);\r\noxygen_write16_masked(chip, OXYGEN_GPIO_DATA,\r\nGPIO_CS53x1_M_SINGLE, GPIO_CS53x1_M_MASK);\r\n}\r\nvoid xonar_set_cs53x1_params(struct oxygen *chip,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nunsigned int value;\r\nif (params_rate(params) <= 54000)\r\nvalue = GPIO_CS53x1_M_SINGLE;\r\nelse if (params_rate(params) <= 108000)\r\nvalue = GPIO_CS53x1_M_DOUBLE;\r\nelse\r\nvalue = GPIO_CS53x1_M_QUAD;\r\noxygen_write16_masked(chip, OXYGEN_GPIO_DATA,\r\nvalue, GPIO_CS53x1_M_MASK);\r\n}\r\nint xonar_gpio_bit_switch_get(struct snd_kcontrol *ctl,\r\nstruct snd_ctl_elem_value *value)\r\n{\r\nstruct oxygen *chip = ctl->private_data;\r\nu16 bit = ctl->private_value;\r\nbool invert = ctl->private_value & XONAR_GPIO_BIT_INVERT;\r\nvalue->value.integer.value[0] =\r\n!!(oxygen_read16(chip, OXYGEN_GPIO_DATA) & bit) ^ invert;\r\nreturn 0;\r\n}\r\nint xonar_gpio_bit_switch_put(struct snd_kcontrol *ctl,\r\nstruct snd_ctl_elem_value *value)\r\n{\r\nstruct oxygen *chip = ctl->private_data;\r\nu16 bit = ctl->private_value;\r\nbool invert = ctl->private_value & XONAR_GPIO_BIT_INVERT;\r\nu16 old_bits, new_bits;\r\nint changed;\r\nspin_lock_irq(&chip->reg_lock);\r\nold_bits = oxygen_read16(chip, OXYGEN_GPIO_DATA);\r\nif (!!value->value.integer.value[0] ^ invert)\r\nnew_bits = old_bits | bit;\r\nelse\r\nnew_bits = old_bits & ~bit;\r\nchanged = new_bits != old_bits;\r\nif (changed)\r\noxygen_write16(chip, OXYGEN_GPIO_DATA, new_bits);\r\nspin_unlock_irq(&chip->reg_lock);\r\nreturn changed;\r\n}

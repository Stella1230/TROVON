void hfs_cat_build_key(struct super_block *sb, btree_key *key, u32 parent, struct qstr *name)\r\n{\r\nkey->cat.reserved = 0;\r\nkey->cat.ParID = cpu_to_be32(parent);\r\nif (name) {\r\nhfs_asc2mac(sb, &key->cat.CName, name);\r\nkey->key_len = 6 + key->cat.CName.len;\r\n} else {\r\nmemset(&key->cat.CName, 0, sizeof(struct hfs_name));\r\nkey->key_len = 6;\r\n}\r\n}\r\nstatic int hfs_cat_build_record(hfs_cat_rec *rec, u32 cnid, struct inode *inode)\r\n{\r\n__be32 mtime = hfs_mtime();\r\nmemset(rec, 0, sizeof(*rec));\r\nif (S_ISDIR(inode->i_mode)) {\r\nrec->type = HFS_CDR_DIR;\r\nrec->dir.DirID = cpu_to_be32(cnid);\r\nrec->dir.CrDat = mtime;\r\nrec->dir.MdDat = mtime;\r\nrec->dir.BkDat = 0;\r\nrec->dir.UsrInfo.frView = cpu_to_be16(0xff);\r\nreturn sizeof(struct hfs_cat_dir);\r\n} else {\r\nrec->type = HFS_CDR_FIL;\r\nrec->file.Flags = HFS_FIL_USED | HFS_FIL_THD;\r\nif (!(inode->i_mode & S_IWUSR))\r\nrec->file.Flags |= HFS_FIL_LOCK;\r\nrec->file.FlNum = cpu_to_be32(cnid);\r\nrec->file.CrDat = mtime;\r\nrec->file.MdDat = mtime;\r\nrec->file.BkDat = 0;\r\nrec->file.UsrWds.fdType = HFS_SB(inode->i_sb)->s_type;\r\nrec->file.UsrWds.fdCreator = HFS_SB(inode->i_sb)->s_creator;\r\nreturn sizeof(struct hfs_cat_file);\r\n}\r\n}\r\nstatic int hfs_cat_build_thread(struct super_block *sb,\r\nhfs_cat_rec *rec, int type,\r\nu32 parentid, struct qstr *name)\r\n{\r\nrec->type = type;\r\nmemset(rec->thread.reserved, 0, sizeof(rec->thread.reserved));\r\nrec->thread.ParID = cpu_to_be32(parentid);\r\nhfs_asc2mac(sb, &rec->thread.CName, name);\r\nreturn sizeof(struct hfs_cat_thread);\r\n}\r\nint hfs_cat_create(u32 cnid, struct inode *dir, struct qstr *str, struct inode *inode)\r\n{\r\nstruct hfs_find_data fd;\r\nstruct super_block *sb;\r\nunion hfs_cat_rec entry;\r\nint entry_size;\r\nint err;\r\nhfs_dbg(CAT_MOD, "create_cat: %s,%u(%d)\n",\r\nstr->name, cnid, inode->i_nlink);\r\nif (dir->i_size >= HFS_MAX_VALENCE)\r\nreturn -ENOSPC;\r\nsb = dir->i_sb;\r\nerr = hfs_find_init(HFS_SB(sb)->cat_tree, &fd);\r\nif (err)\r\nreturn err;\r\nhfs_cat_build_key(sb, fd.search_key, cnid, NULL);\r\nentry_size = hfs_cat_build_thread(sb, &entry, S_ISDIR(inode->i_mode) ?\r\nHFS_CDR_THD : HFS_CDR_FTH,\r\ndir->i_ino, str);\r\nerr = hfs_brec_find(&fd);\r\nif (err != -ENOENT) {\r\nif (!err)\r\nerr = -EEXIST;\r\ngoto err2;\r\n}\r\nerr = hfs_brec_insert(&fd, &entry, entry_size);\r\nif (err)\r\ngoto err2;\r\nhfs_cat_build_key(sb, fd.search_key, dir->i_ino, str);\r\nentry_size = hfs_cat_build_record(&entry, cnid, inode);\r\nerr = hfs_brec_find(&fd);\r\nif (err != -ENOENT) {\r\nif (!err)\r\nerr = -EEXIST;\r\ngoto err1;\r\n}\r\nerr = hfs_brec_insert(&fd, &entry, entry_size);\r\nif (err)\r\ngoto err1;\r\ndir->i_size++;\r\ndir->i_mtime = dir->i_ctime = CURRENT_TIME_SEC;\r\nmark_inode_dirty(dir);\r\nhfs_find_exit(&fd);\r\nreturn 0;\r\nerr1:\r\nhfs_cat_build_key(sb, fd.search_key, cnid, NULL);\r\nif (!hfs_brec_find(&fd))\r\nhfs_brec_remove(&fd);\r\nerr2:\r\nhfs_find_exit(&fd);\r\nreturn err;\r\n}\r\nint hfs_cat_keycmp(const btree_key *key1, const btree_key *key2)\r\n{\r\nint retval;\r\nretval = be32_to_cpu(key1->cat.ParID) - be32_to_cpu(key2->cat.ParID);\r\nif (!retval)\r\nretval = hfs_strcmp(key1->cat.CName.name, key1->cat.CName.len,\r\nkey2->cat.CName.name, key2->cat.CName.len);\r\nreturn retval;\r\n}\r\nint hfs_cat_find_brec(struct super_block *sb, u32 cnid,\r\nstruct hfs_find_data *fd)\r\n{\r\nhfs_cat_rec rec;\r\nint res, len, type;\r\nhfs_cat_build_key(sb, fd->search_key, cnid, NULL);\r\nres = hfs_brec_read(fd, &rec, sizeof(rec));\r\nif (res)\r\nreturn res;\r\ntype = rec.type;\r\nif (type != HFS_CDR_THD && type != HFS_CDR_FTH) {\r\npr_err("found bad thread record in catalog\n");\r\nreturn -EIO;\r\n}\r\nfd->search_key->cat.ParID = rec.thread.ParID;\r\nlen = fd->search_key->cat.CName.len = rec.thread.CName.len;\r\nif (len > HFS_NAMELEN) {\r\npr_err("bad catalog namelength\n");\r\nreturn -EIO;\r\n}\r\nmemcpy(fd->search_key->cat.CName.name, rec.thread.CName.name, len);\r\nreturn hfs_brec_find(fd);\r\n}\r\nint hfs_cat_delete(u32 cnid, struct inode *dir, struct qstr *str)\r\n{\r\nstruct super_block *sb;\r\nstruct hfs_find_data fd;\r\nstruct list_head *pos;\r\nint res, type;\r\nhfs_dbg(CAT_MOD, "delete_cat: %s,%u\n", str ? str->name : NULL, cnid);\r\nsb = dir->i_sb;\r\nres = hfs_find_init(HFS_SB(sb)->cat_tree, &fd);\r\nif (res)\r\nreturn res;\r\nhfs_cat_build_key(sb, fd.search_key, dir->i_ino, str);\r\nres = hfs_brec_find(&fd);\r\nif (res)\r\ngoto out;\r\ntype = hfs_bnode_read_u8(fd.bnode, fd.entryoffset);\r\nif (type == HFS_CDR_FIL) {\r\nstruct hfs_cat_file file;\r\nhfs_bnode_read(fd.bnode, &file, fd.entryoffset, sizeof(file));\r\nif (be32_to_cpu(file.FlNum) == cnid) {\r\n#if 0\r\nhfs_free_fork(sb, &file, HFS_FK_DATA);\r\n#endif\r\nhfs_free_fork(sb, &file, HFS_FK_RSRC);\r\n}\r\n}\r\nlist_for_each(pos, &HFS_I(dir)->open_dir_list) {\r\nstruct hfs_readdir_data *rd =\r\nlist_entry(pos, struct hfs_readdir_data, list);\r\nif (fd.tree->keycmp(fd.search_key, (void *)&rd->key) < 0)\r\nrd->file->f_pos--;\r\n}\r\nres = hfs_brec_remove(&fd);\r\nif (res)\r\ngoto out;\r\nhfs_cat_build_key(sb, fd.search_key, cnid, NULL);\r\nres = hfs_brec_find(&fd);\r\nif (!res) {\r\nres = hfs_brec_remove(&fd);\r\nif (res)\r\ngoto out;\r\n}\r\ndir->i_size--;\r\ndir->i_mtime = dir->i_ctime = CURRENT_TIME_SEC;\r\nmark_inode_dirty(dir);\r\nres = 0;\r\nout:\r\nhfs_find_exit(&fd);\r\nreturn res;\r\n}\r\nint hfs_cat_move(u32 cnid, struct inode *src_dir, struct qstr *src_name,\r\nstruct inode *dst_dir, struct qstr *dst_name)\r\n{\r\nstruct super_block *sb;\r\nstruct hfs_find_data src_fd, dst_fd;\r\nunion hfs_cat_rec entry;\r\nint entry_size, type;\r\nint err;\r\nhfs_dbg(CAT_MOD, "rename_cat: %u - %lu,%s - %lu,%s\n",\r\ncnid, src_dir->i_ino, src_name->name,\r\ndst_dir->i_ino, dst_name->name);\r\nsb = src_dir->i_sb;\r\nerr = hfs_find_init(HFS_SB(sb)->cat_tree, &src_fd);\r\nif (err)\r\nreturn err;\r\ndst_fd = src_fd;\r\nhfs_cat_build_key(sb, src_fd.search_key, src_dir->i_ino, src_name);\r\nerr = hfs_brec_find(&src_fd);\r\nif (err)\r\ngoto out;\r\nif (src_fd.entrylength > sizeof(entry) || src_fd.entrylength < 0) {\r\nerr = -EIO;\r\ngoto out;\r\n}\r\nhfs_bnode_read(src_fd.bnode, &entry, src_fd.entryoffset,\r\nsrc_fd.entrylength);\r\nhfs_cat_build_key(sb, dst_fd.search_key, dst_dir->i_ino, dst_name);\r\nerr = hfs_brec_find(&dst_fd);\r\nif (err != -ENOENT) {\r\nif (!err)\r\nerr = -EEXIST;\r\ngoto out;\r\n}\r\nerr = hfs_brec_insert(&dst_fd, &entry, src_fd.entrylength);\r\nif (err)\r\ngoto out;\r\ndst_dir->i_size++;\r\ndst_dir->i_mtime = dst_dir->i_ctime = CURRENT_TIME_SEC;\r\nmark_inode_dirty(dst_dir);\r\nhfs_cat_build_key(sb, src_fd.search_key, src_dir->i_ino, src_name);\r\nerr = hfs_brec_find(&src_fd);\r\nif (err)\r\ngoto out;\r\nerr = hfs_brec_remove(&src_fd);\r\nif (err)\r\ngoto out;\r\nsrc_dir->i_size--;\r\nsrc_dir->i_mtime = src_dir->i_ctime = CURRENT_TIME_SEC;\r\nmark_inode_dirty(src_dir);\r\ntype = entry.type;\r\nif (type == HFS_CDR_FIL && !(entry.file.Flags & HFS_FIL_THD))\r\ngoto out;\r\nhfs_cat_build_key(sb, src_fd.search_key, cnid, NULL);\r\nerr = hfs_brec_find(&src_fd);\r\nif (err)\r\ngoto out;\r\nerr = hfs_brec_remove(&src_fd);\r\nif (err)\r\ngoto out;\r\nhfs_cat_build_key(sb, dst_fd.search_key, cnid, NULL);\r\nentry_size = hfs_cat_build_thread(sb, &entry, type == HFS_CDR_FIL ? HFS_CDR_FTH : HFS_CDR_THD,\r\ndst_dir->i_ino, dst_name);\r\nerr = hfs_brec_find(&dst_fd);\r\nif (err != -ENOENT) {\r\nif (!err)\r\nerr = -EEXIST;\r\ngoto out;\r\n}\r\nerr = hfs_brec_insert(&dst_fd, &entry, entry_size);\r\nout:\r\nhfs_bnode_put(dst_fd.bnode);\r\nhfs_find_exit(&src_fd);\r\nreturn err;\r\n}

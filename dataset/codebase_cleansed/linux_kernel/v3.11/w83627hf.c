static inline void\r\nsuperio_outb(struct w83627hf_sio_data *sio, int reg, int val)\r\n{\r\noutb(reg, sio->sioaddr);\r\noutb(val, sio->sioaddr + 1);\r\n}\r\nstatic inline int\r\nsuperio_inb(struct w83627hf_sio_data *sio, int reg)\r\n{\r\noutb(reg, sio->sioaddr);\r\nreturn inb(sio->sioaddr + 1);\r\n}\r\nstatic inline void\r\nsuperio_select(struct w83627hf_sio_data *sio, int ld)\r\n{\r\noutb(DEV, sio->sioaddr);\r\noutb(ld, sio->sioaddr + 1);\r\n}\r\nstatic inline void\r\nsuperio_enter(struct w83627hf_sio_data *sio)\r\n{\r\noutb(0x87, sio->sioaddr);\r\noutb(0x87, sio->sioaddr);\r\n}\r\nstatic inline void\r\nsuperio_exit(struct w83627hf_sio_data *sio)\r\n{\r\noutb(0xAA, sio->sioaddr);\r\n}\r\nstatic inline u8 FAN_TO_REG(long rpm, int div)\r\n{\r\nif (rpm == 0)\r\nreturn 255;\r\nrpm = clamp_val(rpm, 1, 1000000);\r\nreturn clamp_val((1350000 + rpm * div / 2) / (rpm * div), 1, 254);\r\n}\r\nstatic u8 TEMP_TO_REG(long temp)\r\n{\r\nint ntemp = clamp_val(temp, TEMP_MIN, TEMP_MAX);\r\nntemp += (ntemp < 0 ? -500 : 500);\r\nreturn (u8)(ntemp / 1000);\r\n}\r\nstatic int TEMP_FROM_REG(u8 reg)\r\n{\r\nreturn (s8)reg * 1000;\r\n}\r\nstatic inline unsigned long pwm_freq_from_reg_627hf(u8 reg)\r\n{\r\nunsigned long freq;\r\nfreq = W83627HF_BASE_PWM_FREQ >> reg;\r\nreturn freq;\r\n}\r\nstatic inline u8 pwm_freq_to_reg_627hf(unsigned long val)\r\n{\r\nu8 i;\r\nfor (i = 0; i < 4; i++) {\r\nif (val > (((W83627HF_BASE_PWM_FREQ >> i) +\r\n(W83627HF_BASE_PWM_FREQ >> (i+1))) / 2))\r\nbreak;\r\n}\r\nreturn i;\r\n}\r\nstatic inline unsigned long pwm_freq_from_reg(u8 reg)\r\n{\r\nunsigned long clock = (reg & 0x80) ? 180000UL : 24000000UL;\r\nreg &= 0x7f;\r\nif (reg == 0)\r\nreg++;\r\nreturn clock / (reg << 8);\r\n}\r\nstatic inline u8 pwm_freq_to_reg(unsigned long val)\r\n{\r\nif (val >= 93750)\r\nreturn 0x01;\r\nif (val >= 720)\r\nreturn 24000000UL / (val << 8);\r\nif (val < 6)\r\nreturn 0xFF;\r\nelse\r\nreturn 0x80 | (180000UL / (val << 8));\r\n}\r\nstatic inline u8 DIV_TO_REG(long val)\r\n{\r\nint i;\r\nval = clamp_val(val, 1, 128) >> 1;\r\nfor (i = 0; i < 7; i++) {\r\nif (val == 0)\r\nbreak;\r\nval >>= 1;\r\n}\r\nreturn (u8)i;\r\n}\r\nstatic int w83627hf_suspend(struct device *dev)\r\n{\r\nstruct w83627hf_data *data = w83627hf_update_device(dev);\r\nmutex_lock(&data->update_lock);\r\ndata->scfg1 = w83627hf_read_value(data, W83781D_REG_SCFG1);\r\ndata->scfg2 = w83627hf_read_value(data, W83781D_REG_SCFG2);\r\nmutex_unlock(&data->update_lock);\r\nreturn 0;\r\n}\r\nstatic int w83627hf_resume(struct device *dev)\r\n{\r\nstruct w83627hf_data *data = dev_get_drvdata(dev);\r\nint i, num_temps = (data->type == w83697hf) ? 2 : 3;\r\nmutex_lock(&data->update_lock);\r\nfor (i = 0; i <= 8; i++) {\r\nif (((data->type == w83697hf) && (i == 1)) ||\r\n((data->type != w83627hf && data->type != w83697hf)\r\n&& (i == 5 || i == 6)))\r\ncontinue;\r\nw83627hf_write_value(data, W83781D_REG_IN_MAX(i),\r\ndata->in_max[i]);\r\nw83627hf_write_value(data, W83781D_REG_IN_MIN(i),\r\ndata->in_min[i]);\r\n}\r\nfor (i = 0; i <= 2; i++)\r\nw83627hf_write_value(data, W83627HF_REG_FAN_MIN(i),\r\ndata->fan_min[i]);\r\nfor (i = 0; i < num_temps; i++) {\r\nw83627hf_write_value(data, w83627hf_reg_temp_over[i],\r\ndata->temp_max[i]);\r\nw83627hf_write_value(data, w83627hf_reg_temp_hyst[i],\r\ndata->temp_max_hyst[i]);\r\n}\r\nif (data->type == w83627thf || data->type == w83637hf ||\r\ndata->type == w83687thf)\r\nw83627hf_write_value(data, W83627THF_REG_VRM_OVT_CFG,\r\ndata->vrm_ovt);\r\nw83627hf_write_value(data, W83781D_REG_SCFG1, data->scfg1);\r\nw83627hf_write_value(data, W83781D_REG_SCFG2, data->scfg2);\r\ndata->valid = 0;\r\nmutex_unlock(&data->update_lock);\r\nreturn 0;\r\n}\r\nstatic ssize_t\r\nshow_in_input(struct device *dev, struct device_attribute *devattr, char *buf)\r\n{\r\nint nr = to_sensor_dev_attr(devattr)->index;\r\nstruct w83627hf_data *data = w83627hf_update_device(dev);\r\nreturn sprintf(buf, "%ld\n", (long)IN_FROM_REG(data->in[nr]));\r\n}\r\nstatic ssize_t\r\nshow_in_min(struct device *dev, struct device_attribute *devattr, char *buf)\r\n{\r\nint nr = to_sensor_dev_attr(devattr)->index;\r\nstruct w83627hf_data *data = w83627hf_update_device(dev);\r\nreturn sprintf(buf, "%ld\n", (long)IN_FROM_REG(data->in_min[nr]));\r\n}\r\nstatic ssize_t\r\nshow_in_max(struct device *dev, struct device_attribute *devattr, char *buf)\r\n{\r\nint nr = to_sensor_dev_attr(devattr)->index;\r\nstruct w83627hf_data *data = w83627hf_update_device(dev);\r\nreturn sprintf(buf, "%ld\n", (long)IN_FROM_REG(data->in_max[nr]));\r\n}\r\nstatic ssize_t\r\nstore_in_min(struct device *dev, struct device_attribute *devattr,\r\nconst char *buf, size_t count)\r\n{\r\nint nr = to_sensor_dev_attr(devattr)->index;\r\nstruct w83627hf_data *data = dev_get_drvdata(dev);\r\nlong val;\r\nint err;\r\nerr = kstrtol(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->in_min[nr] = IN_TO_REG(val);\r\nw83627hf_write_value(data, W83781D_REG_IN_MIN(nr), data->in_min[nr]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nstore_in_max(struct device *dev, struct device_attribute *devattr,\r\nconst char *buf, size_t count)\r\n{\r\nint nr = to_sensor_dev_attr(devattr)->index;\r\nstruct w83627hf_data *data = dev_get_drvdata(dev);\r\nlong val;\r\nint err;\r\nerr = kstrtol(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->in_max[nr] = IN_TO_REG(val);\r\nw83627hf_write_value(data, W83781D_REG_IN_MAX(nr), data->in_max[nr]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_in_0(struct w83627hf_data *data, char *buf, u8 reg)\r\n{\r\nlong in0;\r\nif ((data->vrm_ovt & 0x01) &&\r\n(w83627thf == data->type || w83637hf == data->type\r\n|| w83687thf == data->type))\r\nin0 = (long)((reg * 488 + 70000 + 50) / 100);\r\nelse\r\nin0 = (long)IN_FROM_REG(reg);\r\nreturn sprintf(buf,"%ld\n", in0);\r\n}\r\nstatic ssize_t show_regs_in_0(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct w83627hf_data *data = w83627hf_update_device(dev);\r\nreturn show_in_0(data, buf, data->in[0]);\r\n}\r\nstatic ssize_t show_regs_in_min0(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct w83627hf_data *data = w83627hf_update_device(dev);\r\nreturn show_in_0(data, buf, data->in_min[0]);\r\n}\r\nstatic ssize_t show_regs_in_max0(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct w83627hf_data *data = w83627hf_update_device(dev);\r\nreturn show_in_0(data, buf, data->in_max[0]);\r\n}\r\nstatic ssize_t store_regs_in_min0(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct w83627hf_data *data = dev_get_drvdata(dev);\r\nunsigned long val;\r\nint err;\r\nerr = kstrtoul(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\nif ((data->vrm_ovt & 0x01) &&\r\n(w83627thf == data->type || w83637hf == data->type\r\n|| w83687thf == data->type))\r\ndata->in_min[0] =\r\nclamp_val(((val * 100) - 70000 + 244) / 488, 0, 255);\r\nelse\r\ndata->in_min[0] = IN_TO_REG(val);\r\nw83627hf_write_value(data, W83781D_REG_IN_MIN(0), data->in_min[0]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t store_regs_in_max0(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct w83627hf_data *data = dev_get_drvdata(dev);\r\nunsigned long val;\r\nint err;\r\nerr = kstrtoul(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\nif ((data->vrm_ovt & 0x01) &&\r\n(w83627thf == data->type || w83637hf == data->type\r\n|| w83687thf == data->type))\r\ndata->in_max[0] =\r\nclamp_val(((val * 100) - 70000 + 244) / 488, 0, 255);\r\nelse\r\ndata->in_max[0] = IN_TO_REG(val);\r\nw83627hf_write_value(data, W83781D_REG_IN_MAX(0), data->in_max[0]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nshow_fan_input(struct device *dev, struct device_attribute *devattr, char *buf)\r\n{\r\nint nr = to_sensor_dev_attr(devattr)->index;\r\nstruct w83627hf_data *data = w83627hf_update_device(dev);\r\nreturn sprintf(buf, "%ld\n", FAN_FROM_REG(data->fan[nr],\r\n(long)DIV_FROM_REG(data->fan_div[nr])));\r\n}\r\nstatic ssize_t\r\nshow_fan_min(struct device *dev, struct device_attribute *devattr, char *buf)\r\n{\r\nint nr = to_sensor_dev_attr(devattr)->index;\r\nstruct w83627hf_data *data = w83627hf_update_device(dev);\r\nreturn sprintf(buf, "%ld\n", FAN_FROM_REG(data->fan_min[nr],\r\n(long)DIV_FROM_REG(data->fan_div[nr])));\r\n}\r\nstatic ssize_t\r\nstore_fan_min(struct device *dev, struct device_attribute *devattr,\r\nconst char *buf, size_t count)\r\n{\r\nint nr = to_sensor_dev_attr(devattr)->index;\r\nstruct w83627hf_data *data = dev_get_drvdata(dev);\r\nunsigned long val;\r\nint err;\r\nerr = kstrtoul(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->fan_min[nr] = FAN_TO_REG(val, DIV_FROM_REG(data->fan_div[nr]));\r\nw83627hf_write_value(data, W83627HF_REG_FAN_MIN(nr),\r\ndata->fan_min[nr]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nshow_temp(struct device *dev, struct device_attribute *devattr, char *buf)\r\n{\r\nint nr = to_sensor_dev_attr(devattr)->index;\r\nstruct w83627hf_data *data = w83627hf_update_device(dev);\r\nu16 tmp = data->temp[nr];\r\nreturn sprintf(buf, "%ld\n", (nr) ? (long) LM75_TEMP_FROM_REG(tmp)\r\n: (long) TEMP_FROM_REG(tmp));\r\n}\r\nstatic ssize_t\r\nshow_temp_max(struct device *dev, struct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nint nr = to_sensor_dev_attr(devattr)->index;\r\nstruct w83627hf_data *data = w83627hf_update_device(dev);\r\nu16 tmp = data->temp_max[nr];\r\nreturn sprintf(buf, "%ld\n", (nr) ? (long) LM75_TEMP_FROM_REG(tmp)\r\n: (long) TEMP_FROM_REG(tmp));\r\n}\r\nstatic ssize_t\r\nshow_temp_max_hyst(struct device *dev, struct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nint nr = to_sensor_dev_attr(devattr)->index;\r\nstruct w83627hf_data *data = w83627hf_update_device(dev);\r\nu16 tmp = data->temp_max_hyst[nr];\r\nreturn sprintf(buf, "%ld\n", (nr) ? (long) LM75_TEMP_FROM_REG(tmp)\r\n: (long) TEMP_FROM_REG(tmp));\r\n}\r\nstatic ssize_t\r\nstore_temp_max(struct device *dev, struct device_attribute *devattr,\r\nconst char *buf, size_t count)\r\n{\r\nint nr = to_sensor_dev_attr(devattr)->index;\r\nstruct w83627hf_data *data = dev_get_drvdata(dev);\r\nu16 tmp;\r\nlong val;\r\nint err;\r\nerr = kstrtol(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\ntmp = (nr) ? LM75_TEMP_TO_REG(val) : TEMP_TO_REG(val);\r\nmutex_lock(&data->update_lock);\r\ndata->temp_max[nr] = tmp;\r\nw83627hf_write_value(data, w83627hf_reg_temp_over[nr], tmp);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nstore_temp_max_hyst(struct device *dev, struct device_attribute *devattr,\r\nconst char *buf, size_t count)\r\n{\r\nint nr = to_sensor_dev_attr(devattr)->index;\r\nstruct w83627hf_data *data = dev_get_drvdata(dev);\r\nu16 tmp;\r\nlong val;\r\nint err;\r\nerr = kstrtol(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\ntmp = (nr) ? LM75_TEMP_TO_REG(val) : TEMP_TO_REG(val);\r\nmutex_lock(&data->update_lock);\r\ndata->temp_max_hyst[nr] = tmp;\r\nw83627hf_write_value(data, w83627hf_reg_temp_hyst[nr], tmp);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nshow_vid_reg(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct w83627hf_data *data = w83627hf_update_device(dev);\r\nreturn sprintf(buf, "%ld\n", (long) vid_from_reg(data->vid, data->vrm));\r\n}\r\nstatic ssize_t\r\nshow_vrm_reg(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct w83627hf_data *data = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%ld\n", (long) data->vrm);\r\n}\r\nstatic ssize_t\r\nstore_vrm_reg(struct device *dev, struct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nstruct w83627hf_data *data = dev_get_drvdata(dev);\r\nunsigned long val;\r\nint err;\r\nerr = kstrtoul(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\ndata->vrm = val;\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nshow_alarms_reg(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct w83627hf_data *data = w83627hf_update_device(dev);\r\nreturn sprintf(buf, "%ld\n", (long) data->alarms);\r\n}\r\nstatic ssize_t\r\nshow_alarm(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct w83627hf_data *data = w83627hf_update_device(dev);\r\nint bitnr = to_sensor_dev_attr(attr)->index;\r\nreturn sprintf(buf, "%u\n", (data->alarms >> bitnr) & 1);\r\n}\r\nstatic ssize_t\r\nshow_beep_mask(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct w83627hf_data *data = w83627hf_update_device(dev);\r\nreturn sprintf(buf, "%ld\n",\r\n(long)BEEP_MASK_FROM_REG(data->beep_mask));\r\n}\r\nstatic ssize_t\r\nstore_beep_mask(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct w83627hf_data *data = dev_get_drvdata(dev);\r\nunsigned long val;\r\nint err;\r\nerr = kstrtoul(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->beep_mask = (data->beep_mask & 0x8000)\r\n| BEEP_MASK_TO_REG(val);\r\nw83627hf_write_value(data, W83781D_REG_BEEP_INTS1,\r\ndata->beep_mask & 0xff);\r\nw83627hf_write_value(data, W83781D_REG_BEEP_INTS3,\r\n((data->beep_mask) >> 16) & 0xff);\r\nw83627hf_write_value(data, W83781D_REG_BEEP_INTS2,\r\n(data->beep_mask >> 8) & 0xff);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nshow_beep(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct w83627hf_data *data = w83627hf_update_device(dev);\r\nint bitnr = to_sensor_dev_attr(attr)->index;\r\nreturn sprintf(buf, "%u\n", (data->beep_mask >> bitnr) & 1);\r\n}\r\nstatic ssize_t\r\nstore_beep(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct w83627hf_data *data = dev_get_drvdata(dev);\r\nint bitnr = to_sensor_dev_attr(attr)->index;\r\nu8 reg;\r\nunsigned long bit;\r\nint err;\r\nerr = kstrtoul(buf, 10, &bit);\r\nif (err)\r\nreturn err;\r\nif (bit & ~1)\r\nreturn -EINVAL;\r\nmutex_lock(&data->update_lock);\r\nif (bit)\r\ndata->beep_mask |= (1 << bitnr);\r\nelse\r\ndata->beep_mask &= ~(1 << bitnr);\r\nif (bitnr < 8) {\r\nreg = w83627hf_read_value(data, W83781D_REG_BEEP_INTS1);\r\nif (bit)\r\nreg |= (1 << bitnr);\r\nelse\r\nreg &= ~(1 << bitnr);\r\nw83627hf_write_value(data, W83781D_REG_BEEP_INTS1, reg);\r\n} else if (bitnr < 16) {\r\nreg = w83627hf_read_value(data, W83781D_REG_BEEP_INTS2);\r\nif (bit)\r\nreg |= (1 << (bitnr - 8));\r\nelse\r\nreg &= ~(1 << (bitnr - 8));\r\nw83627hf_write_value(data, W83781D_REG_BEEP_INTS2, reg);\r\n} else {\r\nreg = w83627hf_read_value(data, W83781D_REG_BEEP_INTS3);\r\nif (bit)\r\nreg |= (1 << (bitnr - 16));\r\nelse\r\nreg &= ~(1 << (bitnr - 16));\r\nw83627hf_write_value(data, W83781D_REG_BEEP_INTS3, reg);\r\n}\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nshow_fan_div(struct device *dev, struct device_attribute *devattr, char *buf)\r\n{\r\nint nr = to_sensor_dev_attr(devattr)->index;\r\nstruct w83627hf_data *data = w83627hf_update_device(dev);\r\nreturn sprintf(buf, "%ld\n",\r\n(long) DIV_FROM_REG(data->fan_div[nr]));\r\n}\r\nstatic ssize_t\r\nstore_fan_div(struct device *dev, struct device_attribute *devattr,\r\nconst char *buf, size_t count)\r\n{\r\nint nr = to_sensor_dev_attr(devattr)->index;\r\nstruct w83627hf_data *data = dev_get_drvdata(dev);\r\nunsigned long min;\r\nu8 reg;\r\nunsigned long val;\r\nint err;\r\nerr = kstrtoul(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\nmin = FAN_FROM_REG(data->fan_min[nr],\r\nDIV_FROM_REG(data->fan_div[nr]));\r\ndata->fan_div[nr] = DIV_TO_REG(val);\r\nreg = (w83627hf_read_value(data, nr==2 ? W83781D_REG_PIN : W83781D_REG_VID_FANDIV)\r\n& (nr==0 ? 0xcf : 0x3f))\r\n| ((data->fan_div[nr] & 0x03) << (nr==0 ? 4 : 6));\r\nw83627hf_write_value(data, nr==2 ? W83781D_REG_PIN : W83781D_REG_VID_FANDIV, reg);\r\nreg = (w83627hf_read_value(data, W83781D_REG_VBAT)\r\n& ~(1 << (5 + nr)))\r\n| ((data->fan_div[nr] & 0x04) << (3 + nr));\r\nw83627hf_write_value(data, W83781D_REG_VBAT, reg);\r\ndata->fan_min[nr] = FAN_TO_REG(min, DIV_FROM_REG(data->fan_div[nr]));\r\nw83627hf_write_value(data, W83627HF_REG_FAN_MIN(nr), data->fan_min[nr]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nshow_pwm(struct device *dev, struct device_attribute *devattr, char *buf)\r\n{\r\nint nr = to_sensor_dev_attr(devattr)->index;\r\nstruct w83627hf_data *data = w83627hf_update_device(dev);\r\nreturn sprintf(buf, "%ld\n", (long) data->pwm[nr]);\r\n}\r\nstatic ssize_t\r\nstore_pwm(struct device *dev, struct device_attribute *devattr,\r\nconst char *buf, size_t count)\r\n{\r\nint nr = to_sensor_dev_attr(devattr)->index;\r\nstruct w83627hf_data *data = dev_get_drvdata(dev);\r\nunsigned long val;\r\nint err;\r\nerr = kstrtoul(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\nif (data->type == w83627thf) {\r\ndata->pwm[nr] = PWM_TO_REG(val) & 0xf0;\r\nw83627hf_write_value(data,\r\nW836X7HF_REG_PWM(data->type, nr),\r\ndata->pwm[nr] |\r\n(w83627hf_read_value(data,\r\nW836X7HF_REG_PWM(data->type, nr)) & 0x0f));\r\n} else {\r\ndata->pwm[nr] = PWM_TO_REG(val);\r\nw83627hf_write_value(data,\r\nW836X7HF_REG_PWM(data->type, nr),\r\ndata->pwm[nr]);\r\n}\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nshow_pwm_enable(struct device *dev, struct device_attribute *devattr, char *buf)\r\n{\r\nint nr = to_sensor_dev_attr(devattr)->index;\r\nstruct w83627hf_data *data = w83627hf_update_device(dev);\r\nreturn sprintf(buf, "%d\n", data->pwm_enable[nr]);\r\n}\r\nstatic ssize_t\r\nstore_pwm_enable(struct device *dev, struct device_attribute *devattr,\r\nconst char *buf, size_t count)\r\n{\r\nint nr = to_sensor_dev_attr(devattr)->index;\r\nstruct w83627hf_data *data = dev_get_drvdata(dev);\r\nu8 reg;\r\nunsigned long val;\r\nint err;\r\nerr = kstrtoul(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nif (!val || val > 3)\r\nreturn -EINVAL;\r\nmutex_lock(&data->update_lock);\r\ndata->pwm_enable[nr] = val;\r\nreg = w83627hf_read_value(data, W83627THF_REG_PWM_ENABLE[nr]);\r\nreg &= ~(0x03 << W83627THF_PWM_ENABLE_SHIFT[nr]);\r\nreg |= (val - 1) << W83627THF_PWM_ENABLE_SHIFT[nr];\r\nw83627hf_write_value(data, W83627THF_REG_PWM_ENABLE[nr], reg);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nshow_pwm_freq(struct device *dev, struct device_attribute *devattr, char *buf)\r\n{\r\nint nr = to_sensor_dev_attr(devattr)->index;\r\nstruct w83627hf_data *data = w83627hf_update_device(dev);\r\nif (data->type == w83627hf)\r\nreturn sprintf(buf, "%ld\n",\r\npwm_freq_from_reg_627hf(data->pwm_freq[nr]));\r\nelse\r\nreturn sprintf(buf, "%ld\n",\r\npwm_freq_from_reg(data->pwm_freq[nr]));\r\n}\r\nstatic ssize_t\r\nstore_pwm_freq(struct device *dev, struct device_attribute *devattr,\r\nconst char *buf, size_t count)\r\n{\r\nint nr = to_sensor_dev_attr(devattr)->index;\r\nstruct w83627hf_data *data = dev_get_drvdata(dev);\r\nstatic const u8 mask[]={0xF8, 0x8F};\r\nunsigned long val;\r\nint err;\r\nerr = kstrtoul(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\nif (data->type == w83627hf) {\r\ndata->pwm_freq[nr] = pwm_freq_to_reg_627hf(val);\r\nw83627hf_write_value(data, W83627HF_REG_PWM_FREQ,\r\n(data->pwm_freq[nr] << (nr*4)) |\r\n(w83627hf_read_value(data,\r\nW83627HF_REG_PWM_FREQ) & mask[nr]));\r\n} else {\r\ndata->pwm_freq[nr] = pwm_freq_to_reg(val);\r\nw83627hf_write_value(data, W83637HF_REG_PWM_FREQ[nr],\r\ndata->pwm_freq[nr]);\r\n}\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nshow_temp_type(struct device *dev, struct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nint nr = to_sensor_dev_attr(devattr)->index;\r\nstruct w83627hf_data *data = w83627hf_update_device(dev);\r\nreturn sprintf(buf, "%ld\n", (long) data->sens[nr]);\r\n}\r\nstatic ssize_t\r\nstore_temp_type(struct device *dev, struct device_attribute *devattr,\r\nconst char *buf, size_t count)\r\n{\r\nint nr = to_sensor_dev_attr(devattr)->index;\r\nstruct w83627hf_data *data = dev_get_drvdata(dev);\r\nunsigned long val;\r\nu32 tmp;\r\nint err;\r\nerr = kstrtoul(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\nswitch (val) {\r\ncase 1:\r\ntmp = w83627hf_read_value(data, W83781D_REG_SCFG1);\r\nw83627hf_write_value(data, W83781D_REG_SCFG1,\r\ntmp | BIT_SCFG1[nr]);\r\ntmp = w83627hf_read_value(data, W83781D_REG_SCFG2);\r\nw83627hf_write_value(data, W83781D_REG_SCFG2,\r\ntmp | BIT_SCFG2[nr]);\r\ndata->sens[nr] = val;\r\nbreak;\r\ncase 2:\r\ntmp = w83627hf_read_value(data, W83781D_REG_SCFG1);\r\nw83627hf_write_value(data, W83781D_REG_SCFG1,\r\ntmp | BIT_SCFG1[nr]);\r\ntmp = w83627hf_read_value(data, W83781D_REG_SCFG2);\r\nw83627hf_write_value(data, W83781D_REG_SCFG2,\r\ntmp & ~BIT_SCFG2[nr]);\r\ndata->sens[nr] = val;\r\nbreak;\r\ncase W83781D_DEFAULT_BETA:\r\ndev_warn(dev, "Sensor type %d is deprecated, please use 4 "\r\n"instead\n", W83781D_DEFAULT_BETA);\r\ncase 4:\r\ntmp = w83627hf_read_value(data, W83781D_REG_SCFG1);\r\nw83627hf_write_value(data, W83781D_REG_SCFG1,\r\ntmp & ~BIT_SCFG1[nr]);\r\ndata->sens[nr] = val;\r\nbreak;\r\ndefault:\r\ndev_err(dev,\r\n"Invalid sensor type %ld; must be 1, 2, or 4\n",\r\n(long) val);\r\nbreak;\r\n}\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nshow_name(struct device *dev, struct device_attribute *devattr, char *buf)\r\n{\r\nstruct w83627hf_data *data = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%s\n", data->name);\r\n}\r\nstatic int __init w83627hf_find(int sioaddr, unsigned short *addr,\r\nstruct w83627hf_sio_data *sio_data)\r\n{\r\nint err = -ENODEV;\r\nu16 val;\r\nstatic __initconst char *const names[] = {\r\n"W83627HF",\r\n"W83627THF",\r\n"W83697HF",\r\n"W83637HF",\r\n"W83687THF",\r\n};\r\nsio_data->sioaddr = sioaddr;\r\nsuperio_enter(sio_data);\r\nval = force_id ? force_id : superio_inb(sio_data, DEVID);\r\nswitch (val) {\r\ncase W627_DEVID:\r\nsio_data->type = w83627hf;\r\nbreak;\r\ncase W627THF_DEVID:\r\nsio_data->type = w83627thf;\r\nbreak;\r\ncase W697_DEVID:\r\nsio_data->type = w83697hf;\r\nbreak;\r\ncase W637_DEVID:\r\nsio_data->type = w83637hf;\r\nbreak;\r\ncase W687THF_DEVID:\r\nsio_data->type = w83687thf;\r\nbreak;\r\ncase 0xff:\r\ngoto exit;\r\ndefault:\r\npr_debug(DRVNAME ": Unsupported chip (DEVID=0x%02x)\n", val);\r\ngoto exit;\r\n}\r\nsuperio_select(sio_data, W83627HF_LD_HWM);\r\nval = (superio_inb(sio_data, WINB_BASE_REG) << 8) |\r\nsuperio_inb(sio_data, WINB_BASE_REG + 1);\r\n*addr = val & WINB_ALIGNMENT;\r\nif (*addr == 0) {\r\npr_warn("Base address not set, skipping\n");\r\ngoto exit;\r\n}\r\nval = superio_inb(sio_data, WINB_ACT_REG);\r\nif (!(val & 0x01)) {\r\npr_warn("Enabling HWM logical device\n");\r\nsuperio_outb(sio_data, WINB_ACT_REG, val | 0x01);\r\n}\r\nerr = 0;\r\npr_info(DRVNAME ": Found %s chip at %#x\n",\r\nnames[sio_data->type], *addr);\r\nexit:\r\nsuperio_exit(sio_data);\r\nreturn err;\r\n}\r\nstatic int w83627hf_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct w83627hf_sio_data *sio_data = dev->platform_data;\r\nstruct w83627hf_data *data;\r\nstruct resource *res;\r\nint err, i;\r\nstatic const char *names[] = {\r\n"w83627hf",\r\n"w83627thf",\r\n"w83697hf",\r\n"w83637hf",\r\n"w83687thf",\r\n};\r\nres = platform_get_resource(pdev, IORESOURCE_IO, 0);\r\nif (!devm_request_region(dev, res->start, WINB_REGION_SIZE, DRVNAME)) {\r\ndev_err(dev, "Failed to request region 0x%lx-0x%lx\n",\r\n(unsigned long)res->start,\r\n(unsigned long)(res->start + WINB_REGION_SIZE - 1));\r\nreturn -EBUSY;\r\n}\r\ndata = devm_kzalloc(dev, sizeof(struct w83627hf_data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\ndata->addr = res->start;\r\ndata->type = sio_data->type;\r\ndata->name = names[sio_data->type];\r\nmutex_init(&data->lock);\r\nmutex_init(&data->update_lock);\r\nplatform_set_drvdata(pdev, data);\r\nw83627hf_init_device(pdev);\r\nfor (i = 0; i <= 2; i++)\r\ndata->fan_min[i] = w83627hf_read_value(\r\ndata, W83627HF_REG_FAN_MIN(i));\r\nw83627hf_update_fan_div(data);\r\nerr = sysfs_create_group(&dev->kobj, &w83627hf_group);\r\nif (err)\r\nreturn err;\r\nif (data->type == w83627hf || data->type == w83697hf)\r\nif ((err = device_create_file(dev,\r\n&sensor_dev_attr_in5_input.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_in5_min.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_in5_max.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_in5_alarm.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_in5_beep.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_in6_input.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_in6_min.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_in6_max.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_in6_alarm.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_in6_beep.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_pwm1_freq.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_pwm2_freq.dev_attr)))\r\ngoto error;\r\nif (data->type != w83697hf)\r\nif ((err = device_create_file(dev,\r\n&sensor_dev_attr_in1_input.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_in1_min.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_in1_max.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_in1_alarm.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_in1_beep.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_fan3_input.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_fan3_min.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_fan3_div.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_fan3_alarm.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_fan3_beep.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_temp3_input.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_temp3_max.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_temp3_max_hyst.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_temp3_alarm.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_temp3_beep.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_temp3_type.dev_attr)))\r\ngoto error;\r\nif (data->type != w83697hf && data->vid != 0xff) {\r\ndata->vrm = vid_which_vrm();\r\nif ((err = device_create_file(dev, &dev_attr_cpu0_vid))\r\n|| (err = device_create_file(dev, &dev_attr_vrm)))\r\ngoto error;\r\n}\r\nif (data->type == w83627thf || data->type == w83637hf\r\n|| data->type == w83687thf) {\r\nerr = device_create_file(dev, &sensor_dev_attr_pwm3.dev_attr);\r\nif (err)\r\ngoto error;\r\n}\r\nif (data->type == w83637hf || data->type == w83687thf)\r\nif ((err = device_create_file(dev,\r\n&sensor_dev_attr_pwm1_freq.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_pwm2_freq.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_pwm3_freq.dev_attr)))\r\ngoto error;\r\nif (data->type != w83627hf)\r\nif ((err = device_create_file(dev,\r\n&sensor_dev_attr_pwm1_enable.dev_attr))\r\n|| (err = device_create_file(dev,\r\n&sensor_dev_attr_pwm2_enable.dev_attr)))\r\ngoto error;\r\nif (data->type == w83627thf || data->type == w83637hf\r\n|| data->type == w83687thf) {\r\nerr = device_create_file(dev,\r\n&sensor_dev_attr_pwm3_enable.dev_attr);\r\nif (err)\r\ngoto error;\r\n}\r\ndata->hwmon_dev = hwmon_device_register(dev);\r\nif (IS_ERR(data->hwmon_dev)) {\r\nerr = PTR_ERR(data->hwmon_dev);\r\ngoto error;\r\n}\r\nreturn 0;\r\nerror:\r\nsysfs_remove_group(&dev->kobj, &w83627hf_group);\r\nsysfs_remove_group(&dev->kobj, &w83627hf_group_opt);\r\nreturn err;\r\n}\r\nstatic int w83627hf_remove(struct platform_device *pdev)\r\n{\r\nstruct w83627hf_data *data = platform_get_drvdata(pdev);\r\nhwmon_device_unregister(data->hwmon_dev);\r\nsysfs_remove_group(&pdev->dev.kobj, &w83627hf_group);\r\nsysfs_remove_group(&pdev->dev.kobj, &w83627hf_group_opt);\r\nreturn 0;\r\n}\r\nstatic inline void w83627hf_set_bank(struct w83627hf_data *data, u16 reg)\r\n{\r\nif ((reg & 0x00f0) == 0x50) {\r\noutb_p(W83781D_REG_BANK, data->addr + W83781D_ADDR_REG_OFFSET);\r\noutb_p(reg >> 8, data->addr + W83781D_DATA_REG_OFFSET);\r\n}\r\n}\r\nstatic inline void w83627hf_reset_bank(struct w83627hf_data *data, u16 reg)\r\n{\r\nif (reg & 0xff00) {\r\noutb_p(W83781D_REG_BANK, data->addr + W83781D_ADDR_REG_OFFSET);\r\noutb_p(0, data->addr + W83781D_DATA_REG_OFFSET);\r\n}\r\n}\r\nstatic int w83627hf_read_value(struct w83627hf_data *data, u16 reg)\r\n{\r\nint res, word_sized;\r\nmutex_lock(&data->lock);\r\nword_sized = (((reg & 0xff00) == 0x100)\r\n|| ((reg & 0xff00) == 0x200))\r\n&& (((reg & 0x00ff) == 0x50)\r\n|| ((reg & 0x00ff) == 0x53)\r\n|| ((reg & 0x00ff) == 0x55));\r\nw83627hf_set_bank(data, reg);\r\noutb_p(reg & 0xff, data->addr + W83781D_ADDR_REG_OFFSET);\r\nres = inb_p(data->addr + W83781D_DATA_REG_OFFSET);\r\nif (word_sized) {\r\noutb_p((reg & 0xff) + 1,\r\ndata->addr + W83781D_ADDR_REG_OFFSET);\r\nres =\r\n(res << 8) + inb_p(data->addr +\r\nW83781D_DATA_REG_OFFSET);\r\n}\r\nw83627hf_reset_bank(data, reg);\r\nmutex_unlock(&data->lock);\r\nreturn res;\r\n}\r\nstatic int w83627thf_read_gpio5(struct platform_device *pdev)\r\n{\r\nstruct w83627hf_sio_data *sio_data = pdev->dev.platform_data;\r\nint res = 0xff, sel;\r\nsuperio_enter(sio_data);\r\nsuperio_select(sio_data, W83627HF_LD_GPIO5);\r\nif (!(superio_inb(sio_data, W83627THF_GPIO5_EN) & (1<<3))) {\r\ndev_dbg(&pdev->dev, "GPIO5 disabled, no VID function\n");\r\ngoto exit;\r\n}\r\nsel = superio_inb(sio_data, W83627THF_GPIO5_IOSR) & 0x3f;\r\nif ((sel & 0x1f) != 0x1f) {\r\ndev_dbg(&pdev->dev, "GPIO5 not configured for VID "\r\n"function\n");\r\ngoto exit;\r\n}\r\ndev_info(&pdev->dev, "Reading VID from GPIO5\n");\r\nres = superio_inb(sio_data, W83627THF_GPIO5_DR) & sel;\r\nexit:\r\nsuperio_exit(sio_data);\r\nreturn res;\r\n}\r\nstatic int w83687thf_read_vid(struct platform_device *pdev)\r\n{\r\nstruct w83627hf_sio_data *sio_data = pdev->dev.platform_data;\r\nint res = 0xff;\r\nsuperio_enter(sio_data);\r\nsuperio_select(sio_data, W83627HF_LD_HWM);\r\nif (!(superio_inb(sio_data, W83687THF_VID_EN) & (1 << 2))) {\r\ndev_dbg(&pdev->dev, "VID disabled, no VID function\n");\r\ngoto exit;\r\n}\r\nif (!(superio_inb(sio_data, W83687THF_VID_CFG) & (1 << 4))) {\r\ndev_dbg(&pdev->dev, "VID configured as output, "\r\n"no VID function\n");\r\ngoto exit;\r\n}\r\nres = superio_inb(sio_data, W83687THF_VID_DATA) & 0x3f;\r\nexit:\r\nsuperio_exit(sio_data);\r\nreturn res;\r\n}\r\nstatic int w83627hf_write_value(struct w83627hf_data *data, u16 reg, u16 value)\r\n{\r\nint word_sized;\r\nmutex_lock(&data->lock);\r\nword_sized = (((reg & 0xff00) == 0x100)\r\n|| ((reg & 0xff00) == 0x200))\r\n&& (((reg & 0x00ff) == 0x53)\r\n|| ((reg & 0x00ff) == 0x55));\r\nw83627hf_set_bank(data, reg);\r\noutb_p(reg & 0xff, data->addr + W83781D_ADDR_REG_OFFSET);\r\nif (word_sized) {\r\noutb_p(value >> 8,\r\ndata->addr + W83781D_DATA_REG_OFFSET);\r\noutb_p((reg & 0xff) + 1,\r\ndata->addr + W83781D_ADDR_REG_OFFSET);\r\n}\r\noutb_p(value & 0xff,\r\ndata->addr + W83781D_DATA_REG_OFFSET);\r\nw83627hf_reset_bank(data, reg);\r\nmutex_unlock(&data->lock);\r\nreturn 0;\r\n}\r\nstatic void w83627hf_init_device(struct platform_device *pdev)\r\n{\r\nstruct w83627hf_data *data = platform_get_drvdata(pdev);\r\nint i;\r\nenum chips type = data->type;\r\nu8 tmp;\r\nif (type == w83627hf) {\r\nw83627hf_write_value(data, W83781D_REG_I2C_SUBADDR, 0x89);\r\nw83627hf_write_value(data, W83781D_REG_I2C_ADDR, force_i2c);\r\n}\r\nif (type == w83627hf || type == w83637hf) {\r\nint lo = w83627hf_read_value(data, W83781D_REG_VID_FANDIV);\r\nint hi = w83627hf_read_value(data, W83781D_REG_CHIPID);\r\ndata->vid = (lo & 0x0f) | ((hi & 0x01) << 4);\r\n} else if (type == w83627thf) {\r\ndata->vid = w83627thf_read_gpio5(pdev);\r\n} else if (type == w83687thf) {\r\ndata->vid = w83687thf_read_vid(pdev);\r\n}\r\nif (type == w83627thf || type == w83637hf || type == w83687thf) {\r\ndata->vrm_ovt =\r\nw83627hf_read_value(data, W83627THF_REG_VRM_OVT_CFG);\r\n}\r\ntmp = w83627hf_read_value(data, W83781D_REG_SCFG1);\r\nfor (i = 1; i <= 3; i++) {\r\nif (!(tmp & BIT_SCFG1[i - 1])) {\r\ndata->sens[i - 1] = 4;\r\n} else {\r\nif (w83627hf_read_value\r\n(data,\r\nW83781D_REG_SCFG2) & BIT_SCFG2[i - 1])\r\ndata->sens[i - 1] = 1;\r\nelse\r\ndata->sens[i - 1] = 2;\r\n}\r\nif ((type == w83697hf) && (i == 2))\r\nbreak;\r\n}\r\nif(init) {\r\ntmp = w83627hf_read_value(data, W83627HF_REG_TEMP2_CONFIG);\r\nif (tmp & 0x01) {\r\ndev_warn(&pdev->dev, "Enabling temp2, readings "\r\n"might not make sense\n");\r\nw83627hf_write_value(data, W83627HF_REG_TEMP2_CONFIG,\r\ntmp & 0xfe);\r\n}\r\nif (type != w83697hf) {\r\ntmp = w83627hf_read_value(data,\r\nW83627HF_REG_TEMP3_CONFIG);\r\nif (tmp & 0x01) {\r\ndev_warn(&pdev->dev, "Enabling temp3, "\r\n"readings might not make sense\n");\r\nw83627hf_write_value(data,\r\nW83627HF_REG_TEMP3_CONFIG, tmp & 0xfe);\r\n}\r\n}\r\n}\r\nw83627hf_write_value(data, W83781D_REG_CONFIG,\r\n(w83627hf_read_value(data,\r\nW83781D_REG_CONFIG) & 0xf7)\r\n| 0x01);\r\ntmp = w83627hf_read_value(data, W83781D_REG_VBAT);\r\nif (!(tmp & 0x01))\r\nw83627hf_write_value(data, W83781D_REG_VBAT, tmp | 0x01);\r\n}\r\nstatic void w83627hf_update_fan_div(struct w83627hf_data *data)\r\n{\r\nint reg;\r\nreg = w83627hf_read_value(data, W83781D_REG_VID_FANDIV);\r\ndata->fan_div[0] = (reg >> 4) & 0x03;\r\ndata->fan_div[1] = (reg >> 6) & 0x03;\r\nif (data->type != w83697hf) {\r\ndata->fan_div[2] = (w83627hf_read_value(data,\r\nW83781D_REG_PIN) >> 6) & 0x03;\r\n}\r\nreg = w83627hf_read_value(data, W83781D_REG_VBAT);\r\ndata->fan_div[0] |= (reg >> 3) & 0x04;\r\ndata->fan_div[1] |= (reg >> 4) & 0x04;\r\nif (data->type != w83697hf)\r\ndata->fan_div[2] |= (reg >> 5) & 0x04;\r\n}\r\nstatic struct w83627hf_data *w83627hf_update_device(struct device *dev)\r\n{\r\nstruct w83627hf_data *data = dev_get_drvdata(dev);\r\nint i, num_temps = (data->type == w83697hf) ? 2 : 3;\r\nint num_pwms = (data->type == w83697hf) ? 2 : 3;\r\nmutex_lock(&data->update_lock);\r\nif (time_after(jiffies, data->last_updated + HZ + HZ / 2)\r\n|| !data->valid) {\r\nfor (i = 0; i <= 8; i++) {\r\nif (((data->type == w83697hf) && (i == 1)) ||\r\n((data->type != w83627hf && data->type != w83697hf)\r\n&& (i == 5 || i == 6)))\r\ncontinue;\r\ndata->in[i] =\r\nw83627hf_read_value(data, W83781D_REG_IN(i));\r\ndata->in_min[i] =\r\nw83627hf_read_value(data,\r\nW83781D_REG_IN_MIN(i));\r\ndata->in_max[i] =\r\nw83627hf_read_value(data,\r\nW83781D_REG_IN_MAX(i));\r\n}\r\nfor (i = 0; i <= 2; i++) {\r\ndata->fan[i] =\r\nw83627hf_read_value(data, W83627HF_REG_FAN(i));\r\ndata->fan_min[i] =\r\nw83627hf_read_value(data,\r\nW83627HF_REG_FAN_MIN(i));\r\n}\r\nfor (i = 0; i <= 2; i++) {\r\nu8 tmp = w83627hf_read_value(data,\r\nW836X7HF_REG_PWM(data->type, i));\r\nif (data->type == w83627thf)\r\ntmp &= 0xf0;\r\ndata->pwm[i] = tmp;\r\nif (i == 1 &&\r\n(data->type == w83627hf || data->type == w83697hf))\r\nbreak;\r\n}\r\nif (data->type == w83627hf) {\r\nu8 tmp = w83627hf_read_value(data,\r\nW83627HF_REG_PWM_FREQ);\r\ndata->pwm_freq[0] = tmp & 0x07;\r\ndata->pwm_freq[1] = (tmp >> 4) & 0x07;\r\n} else if (data->type != w83627thf) {\r\nfor (i = 1; i <= 3; i++) {\r\ndata->pwm_freq[i - 1] =\r\nw83627hf_read_value(data,\r\nW83637HF_REG_PWM_FREQ[i - 1]);\r\nif (i == 2 && (data->type == w83697hf))\r\nbreak;\r\n}\r\n}\r\nif (data->type != w83627hf) {\r\nfor (i = 0; i < num_pwms; i++) {\r\nu8 tmp = w83627hf_read_value(data,\r\nW83627THF_REG_PWM_ENABLE[i]);\r\ndata->pwm_enable[i] =\r\n((tmp >> W83627THF_PWM_ENABLE_SHIFT[i])\r\n& 0x03) + 1;\r\n}\r\n}\r\nfor (i = 0; i < num_temps; i++) {\r\ndata->temp[i] = w83627hf_read_value(\r\ndata, w83627hf_reg_temp[i]);\r\ndata->temp_max[i] = w83627hf_read_value(\r\ndata, w83627hf_reg_temp_over[i]);\r\ndata->temp_max_hyst[i] = w83627hf_read_value(\r\ndata, w83627hf_reg_temp_hyst[i]);\r\n}\r\nw83627hf_update_fan_div(data);\r\ndata->alarms =\r\nw83627hf_read_value(data, W83781D_REG_ALARM1) |\r\n(w83627hf_read_value(data, W83781D_REG_ALARM2) << 8) |\r\n(w83627hf_read_value(data, W83781D_REG_ALARM3) << 16);\r\ni = w83627hf_read_value(data, W83781D_REG_BEEP_INTS2);\r\ndata->beep_mask = (i << 8) |\r\nw83627hf_read_value(data, W83781D_REG_BEEP_INTS1) |\r\nw83627hf_read_value(data, W83781D_REG_BEEP_INTS3) << 16;\r\ndata->last_updated = jiffies;\r\ndata->valid = 1;\r\n}\r\nmutex_unlock(&data->update_lock);\r\nreturn data;\r\n}\r\nstatic int __init w83627hf_device_add(unsigned short address,\r\nconst struct w83627hf_sio_data *sio_data)\r\n{\r\nstruct resource res = {\r\n.start = address + WINB_REGION_OFFSET,\r\n.end = address + WINB_REGION_OFFSET + WINB_REGION_SIZE - 1,\r\n.name = DRVNAME,\r\n.flags = IORESOURCE_IO,\r\n};\r\nint err;\r\nerr = acpi_check_resource_conflict(&res);\r\nif (err)\r\ngoto exit;\r\npdev = platform_device_alloc(DRVNAME, address);\r\nif (!pdev) {\r\nerr = -ENOMEM;\r\npr_err("Device allocation failed\n");\r\ngoto exit;\r\n}\r\nerr = platform_device_add_resources(pdev, &res, 1);\r\nif (err) {\r\npr_err("Device resource addition failed (%d)\n", err);\r\ngoto exit_device_put;\r\n}\r\nerr = platform_device_add_data(pdev, sio_data,\r\nsizeof(struct w83627hf_sio_data));\r\nif (err) {\r\npr_err("Platform data allocation failed\n");\r\ngoto exit_device_put;\r\n}\r\nerr = platform_device_add(pdev);\r\nif (err) {\r\npr_err("Device addition failed (%d)\n", err);\r\ngoto exit_device_put;\r\n}\r\nreturn 0;\r\nexit_device_put:\r\nplatform_device_put(pdev);\r\nexit:\r\nreturn err;\r\n}\r\nstatic int __init sensors_w83627hf_init(void)\r\n{\r\nint err;\r\nunsigned short address;\r\nstruct w83627hf_sio_data sio_data;\r\nif (w83627hf_find(0x2e, &address, &sio_data)\r\n&& w83627hf_find(0x4e, &address, &sio_data))\r\nreturn -ENODEV;\r\nerr = platform_driver_register(&w83627hf_driver);\r\nif (err)\r\ngoto exit;\r\nerr = w83627hf_device_add(address, &sio_data);\r\nif (err)\r\ngoto exit_driver;\r\nreturn 0;\r\nexit_driver:\r\nplatform_driver_unregister(&w83627hf_driver);\r\nexit:\r\nreturn err;\r\n}\r\nstatic void __exit sensors_w83627hf_exit(void)\r\n{\r\nplatform_device_unregister(pdev);\r\nplatform_driver_unregister(&w83627hf_driver);\r\n}

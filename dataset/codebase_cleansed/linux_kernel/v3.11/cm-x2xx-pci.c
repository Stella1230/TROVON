static void cmx2xx_it8152_irq_demux(unsigned int irq, struct irq_desc *desc)\r\n{\r\ndesc->irq_data.chip->irq_ack(&desc->irq_data);\r\nit8152_irq_demux(irq, desc);\r\n}\r\nvoid __cmx2xx_pci_init_irq(int irq_gpio)\r\n{\r\nit8152_init_irq();\r\ncmx2xx_it8152_irq_gpio = irq_gpio;\r\nirq_set_irq_type(gpio_to_irq(irq_gpio), IRQ_TYPE_EDGE_RISING);\r\nirq_set_chained_handler(gpio_to_irq(irq_gpio),\r\ncmx2xx_it8152_irq_demux);\r\n}\r\nvoid __cmx2xx_pci_suspend(void)\r\n{\r\nsleep_save_ite[0] = __raw_readl(IT8152_INTC_PDCNIMR);\r\nsleep_save_ite[1] = __raw_readl(IT8152_INTC_LPCNIMR);\r\nsleep_save_ite[2] = __raw_readl(IT8152_INTC_LPNIAR);\r\n__raw_writel((0), IT8152_INTC_PDCNIRR);\r\n__raw_writel((0), IT8152_INTC_LPCNIRR);\r\n}\r\nvoid __cmx2xx_pci_resume(void)\r\n{\r\n__raw_writel((sleep_save_ite[0]), IT8152_INTC_PDCNIMR);\r\n__raw_writel((sleep_save_ite[1]), IT8152_INTC_LPCNIMR);\r\n__raw_writel((sleep_save_ite[2]), IT8152_INTC_LPNIAR);\r\n}\r\nvoid cmx2xx_pci_suspend(void) {}\r\nvoid cmx2xx_pci_resume(void) {}\r\nstatic int __init cmx2xx_pci_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nint irq;\r\ndev_dbg(&dev->dev, "%s: slot=%x, pin=%x\n", __func__, slot, pin);\r\nirq = it8152_pci_map_irq(dev, slot, pin);\r\nif (irq)\r\nreturn irq;\r\nif (slot == 7)\r\nreturn IT8152_PCI_INTA;\r\nif (slot == 8 || slot == 0)\r\nreturn IT8152_PCI_INTB;\r\nif (slot == 9)\r\nreturn IT8152_PCI_INTA;\r\nif (slot == 15)\r\nreturn IT8152_PCI_INTC;\r\nif (slot == 16)\r\nreturn IT8152_PCI_INTA;\r\nif ((slot == 17) || (slot == 19))\r\nreturn IT8152_PCI_INTA;\r\nif ((slot == 18) || (slot == 20))\r\nreturn IT8152_PCI_INTB;\r\nreturn(0);\r\n}\r\nstatic void cmx2xx_pci_preinit(void)\r\n{\r\npr_info("Initializing CM-X2XX PCI subsystem\n");\r\npcibios_min_io = 0;\r\npcibios_min_mem = 0;\r\n__raw_writel(0x800, IT8152_PCI_CFG_ADDR);\r\nif (__raw_readl(IT8152_PCI_CFG_DATA) == 0x81521283) {\r\npr_info("PCI Bridge found.\n");\r\nwritel(0x848, IT8152_PCI_CFG_ADDR);\r\nwritel(0, IT8152_PCI_CFG_DATA);\r\nwritel(0x840, IT8152_PCI_CFG_ADDR);\r\nwritel(0, IT8152_PCI_CFG_DATA);\r\nwritel(0x20, IT8152_GPIO_GPDR);\r\nwritel(0x4000, IT8152_PCI_CFG_ADDR);\r\nif (readl(IT8152_PCI_CFG_DATA) == 0xAC51104C) {\r\npr_info("CardBus Bridge found.\n");\r\nwritel(0x408C, IT8152_PCI_CFG_ADDR);\r\nwritel(0x1022, IT8152_PCI_CFG_DATA);\r\nwritel(0x4080, IT8152_PCI_CFG_ADDR);\r\nwritel(0x3844d060, IT8152_PCI_CFG_DATA);\r\nwritel(0x4090, IT8152_PCI_CFG_ADDR);\r\nwritel(((readl(IT8152_PCI_CFG_DATA) & 0xffff) |\r\n0x60440000),\r\nIT8152_PCI_CFG_DATA);\r\nwritel(0x4018, IT8152_PCI_CFG_ADDR);\r\nwritel(0xb0000000, IT8152_PCI_CFG_DATA);\r\nwritel(0x418C, IT8152_PCI_CFG_ADDR);\r\nwritel(0x1022, IT8152_PCI_CFG_DATA);\r\nwritel(0x4180, IT8152_PCI_CFG_ADDR);\r\nwritel(0x3844d060, IT8152_PCI_CFG_DATA);\r\nwritel(0x4190, IT8152_PCI_CFG_ADDR);\r\nwritel(((readl(IT8152_PCI_CFG_DATA) & 0xffff) |\r\n0x60440000),\r\nIT8152_PCI_CFG_DATA);\r\nwritel(0x4118, IT8152_PCI_CFG_ADDR);\r\nwritel(0xb0000000, IT8152_PCI_CFG_DATA);\r\n}\r\n}\r\n}\r\nstatic int __init cmx2xx_init_pci(void)\r\n{\r\nif (machine_is_armcore())\r\npci_common_init(&cmx2xx_pci);\r\nreturn 0;\r\n}

static int ad5446_set_powerdown_mode(struct iio_dev *indio_dev,\r\nconst struct iio_chan_spec *chan, unsigned int mode)\r\n{\r\nstruct ad5446_state *st = iio_priv(indio_dev);\r\nst->pwr_down_mode = mode + 1;\r\nreturn 0;\r\n}\r\nstatic int ad5446_get_powerdown_mode(struct iio_dev *indio_dev,\r\nconst struct iio_chan_spec *chan)\r\n{\r\nstruct ad5446_state *st = iio_priv(indio_dev);\r\nreturn st->pwr_down_mode - 1;\r\n}\r\nstatic ssize_t ad5446_read_dac_powerdown(struct iio_dev *indio_dev,\r\nuintptr_t private,\r\nconst struct iio_chan_spec *chan,\r\nchar *buf)\r\n{\r\nstruct ad5446_state *st = iio_priv(indio_dev);\r\nreturn sprintf(buf, "%d\n", st->pwr_down);\r\n}\r\nstatic ssize_t ad5446_write_dac_powerdown(struct iio_dev *indio_dev,\r\nuintptr_t private,\r\nconst struct iio_chan_spec *chan,\r\nconst char *buf, size_t len)\r\n{\r\nstruct ad5446_state *st = iio_priv(indio_dev);\r\nunsigned int shift;\r\nunsigned int val;\r\nbool powerdown;\r\nint ret;\r\nret = strtobool(buf, &powerdown);\r\nif (ret)\r\nreturn ret;\r\nmutex_lock(&indio_dev->mlock);\r\nst->pwr_down = powerdown;\r\nif (st->pwr_down) {\r\nshift = chan->scan_type.realbits + chan->scan_type.shift;\r\nval = st->pwr_down_mode << shift;\r\n} else {\r\nval = st->cached_val;\r\n}\r\nret = st->chip_info->write(st, val);\r\nmutex_unlock(&indio_dev->mlock);\r\nreturn ret ? ret : len;\r\n}\r\nstatic int ad5446_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint *val,\r\nint *val2,\r\nlong m)\r\n{\r\nstruct ad5446_state *st = iio_priv(indio_dev);\r\nunsigned long scale_uv;\r\nswitch (m) {\r\ncase IIO_CHAN_INFO_RAW:\r\n*val = st->cached_val;\r\nreturn IIO_VAL_INT;\r\ncase IIO_CHAN_INFO_SCALE:\r\nscale_uv = (st->vref_mv * 1000) >> chan->scan_type.realbits;\r\n*val = scale_uv / 1000;\r\n*val2 = (scale_uv % 1000) * 1000;\r\nreturn IIO_VAL_INT_PLUS_MICRO;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int ad5446_write_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint val,\r\nint val2,\r\nlong mask)\r\n{\r\nstruct ad5446_state *st = iio_priv(indio_dev);\r\nint ret = 0;\r\nswitch (mask) {\r\ncase IIO_CHAN_INFO_RAW:\r\nif (val >= (1 << chan->scan_type.realbits) || val < 0)\r\nreturn -EINVAL;\r\nval <<= chan->scan_type.shift;\r\nmutex_lock(&indio_dev->mlock);\r\nst->cached_val = val;\r\nif (!st->pwr_down)\r\nret = st->chip_info->write(st, val);\r\nmutex_unlock(&indio_dev->mlock);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\n}\r\nreturn ret;\r\n}\r\nstatic int ad5446_probe(struct device *dev, const char *name,\r\nconst struct ad5446_chip_info *chip_info)\r\n{\r\nstruct ad5446_state *st;\r\nstruct iio_dev *indio_dev;\r\nstruct regulator *reg;\r\nint ret, voltage_uv = 0;\r\nreg = regulator_get(dev, "vcc");\r\nif (!IS_ERR(reg)) {\r\nret = regulator_enable(reg);\r\nif (ret)\r\ngoto error_put_reg;\r\nret = regulator_get_voltage(reg);\r\nif (ret < 0)\r\ngoto error_disable_reg;\r\nvoltage_uv = ret;\r\n}\r\nindio_dev = iio_device_alloc(sizeof(*st));\r\nif (indio_dev == NULL) {\r\nret = -ENOMEM;\r\ngoto error_disable_reg;\r\n}\r\nst = iio_priv(indio_dev);\r\nst->chip_info = chip_info;\r\ndev_set_drvdata(dev, indio_dev);\r\nst->reg = reg;\r\nst->dev = dev;\r\nindio_dev->dev.parent = dev;\r\nindio_dev->name = name;\r\nindio_dev->info = &ad5446_info;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nindio_dev->channels = &st->chip_info->channel;\r\nindio_dev->num_channels = 1;\r\nst->pwr_down_mode = MODE_PWRDWN_1k;\r\nif (st->chip_info->int_vref_mv)\r\nst->vref_mv = st->chip_info->int_vref_mv;\r\nelse if (voltage_uv)\r\nst->vref_mv = voltage_uv / 1000;\r\nelse\r\ndev_warn(dev, "reference voltage unspecified\n");\r\nret = iio_device_register(indio_dev);\r\nif (ret)\r\ngoto error_free_device;\r\nreturn 0;\r\nerror_free_device:\r\niio_device_free(indio_dev);\r\nerror_disable_reg:\r\nif (!IS_ERR(reg))\r\nregulator_disable(reg);\r\nerror_put_reg:\r\nif (!IS_ERR(reg))\r\nregulator_put(reg);\r\nreturn ret;\r\n}\r\nstatic int ad5446_remove(struct device *dev)\r\n{\r\nstruct iio_dev *indio_dev = dev_get_drvdata(dev);\r\nstruct ad5446_state *st = iio_priv(indio_dev);\r\niio_device_unregister(indio_dev);\r\nif (!IS_ERR(st->reg)) {\r\nregulator_disable(st->reg);\r\nregulator_put(st->reg);\r\n}\r\niio_device_free(indio_dev);\r\nreturn 0;\r\n}\r\nstatic int ad5446_write(struct ad5446_state *st, unsigned val)\r\n{\r\nstruct spi_device *spi = to_spi_device(st->dev);\r\n__be16 data = cpu_to_be16(val);\r\nreturn spi_write(spi, &data, sizeof(data));\r\n}\r\nstatic int ad5660_write(struct ad5446_state *st, unsigned val)\r\n{\r\nstruct spi_device *spi = to_spi_device(st->dev);\r\nuint8_t data[3];\r\ndata[0] = (val >> 16) & 0xFF;\r\ndata[1] = (val >> 8) & 0xFF;\r\ndata[2] = val & 0xFF;\r\nreturn spi_write(spi, data, sizeof(data));\r\n}\r\nstatic int ad5446_spi_probe(struct spi_device *spi)\r\n{\r\nconst struct spi_device_id *id = spi_get_device_id(spi);\r\nreturn ad5446_probe(&spi->dev, id->name,\r\n&ad5446_spi_chip_info[id->driver_data]);\r\n}\r\nstatic int ad5446_spi_remove(struct spi_device *spi)\r\n{\r\nreturn ad5446_remove(&spi->dev);\r\n}\r\nstatic int __init ad5446_spi_register_driver(void)\r\n{\r\nreturn spi_register_driver(&ad5446_spi_driver);\r\n}\r\nstatic void ad5446_spi_unregister_driver(void)\r\n{\r\nspi_unregister_driver(&ad5446_spi_driver);\r\n}\r\nstatic inline int ad5446_spi_register_driver(void) { return 0; }\r\nstatic inline void ad5446_spi_unregister_driver(void) { }\r\nstatic int ad5622_write(struct ad5446_state *st, unsigned val)\r\n{\r\nstruct i2c_client *client = to_i2c_client(st->dev);\r\n__be16 data = cpu_to_be16(val);\r\nreturn i2c_master_send(client, (char *)&data, sizeof(data));\r\n}\r\nstatic int ad5446_i2c_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nreturn ad5446_probe(&i2c->dev, id->name,\r\n&ad5446_i2c_chip_info[id->driver_data]);\r\n}\r\nstatic int ad5446_i2c_remove(struct i2c_client *i2c)\r\n{\r\nreturn ad5446_remove(&i2c->dev);\r\n}\r\nstatic int __init ad5446_i2c_register_driver(void)\r\n{\r\nreturn i2c_add_driver(&ad5446_i2c_driver);\r\n}\r\nstatic void __exit ad5446_i2c_unregister_driver(void)\r\n{\r\ni2c_del_driver(&ad5446_i2c_driver);\r\n}\r\nstatic inline int ad5446_i2c_register_driver(void) { return 0; }\r\nstatic inline void ad5446_i2c_unregister_driver(void) { }\r\nstatic int __init ad5446_init(void)\r\n{\r\nint ret;\r\nret = ad5446_spi_register_driver();\r\nif (ret)\r\nreturn ret;\r\nret = ad5446_i2c_register_driver();\r\nif (ret) {\r\nad5446_spi_unregister_driver();\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit ad5446_exit(void)\r\n{\r\nad5446_i2c_unregister_driver();\r\nad5446_spi_unregister_driver();\r\n}

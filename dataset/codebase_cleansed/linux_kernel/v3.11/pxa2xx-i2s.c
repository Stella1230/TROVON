static int pxa2xx_i2s_startup(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nif (IS_ERR(clk_i2s))\r\nreturn PTR_ERR(clk_i2s);\r\nif (!cpu_dai->active)\r\nSACR0 = 0;\r\nreturn 0;\r\n}\r\nstatic int pxa_i2s_wait(void)\r\n{\r\nint i;\r\nfor(i = 0; i < 16; i++)\r\nSADR;\r\nreturn 0;\r\n}\r\nstatic int pxa2xx_i2s_set_dai_fmt(struct snd_soc_dai *cpu_dai,\r\nunsigned int fmt)\r\n{\r\nswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\r\ncase SND_SOC_DAIFMT_I2S:\r\npxa_i2s.fmt = 0;\r\nbreak;\r\ncase SND_SOC_DAIFMT_LEFT_J:\r\npxa_i2s.fmt = SACR1_AMSL;\r\nbreak;\r\n}\r\nswitch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {\r\ncase SND_SOC_DAIFMT_CBS_CFS:\r\npxa_i2s.master = 1;\r\nbreak;\r\ncase SND_SOC_DAIFMT_CBM_CFS:\r\npxa_i2s.master = 0;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int pxa2xx_i2s_set_dai_sysclk(struct snd_soc_dai *cpu_dai,\r\nint clk_id, unsigned int freq, int dir)\r\n{\r\nif (clk_id != PXA2XX_I2S_SYSCLK)\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nstatic int pxa2xx_i2s_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct pxa2xx_pcm_dma_params *dma_data;\r\nBUG_ON(IS_ERR(clk_i2s));\r\nclk_prepare_enable(clk_i2s);\r\nclk_ena = 1;\r\npxa_i2s_wait();\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\ndma_data = &pxa2xx_i2s_pcm_stereo_out;\r\nelse\r\ndma_data = &pxa2xx_i2s_pcm_stereo_in;\r\nsnd_soc_dai_set_dma_data(dai, substream, dma_data);\r\nif (!(SACR0 & SACR0_ENB)) {\r\nSACR0 = 0;\r\nif (pxa_i2s.master)\r\nSACR0 |= SACR0_BCKD;\r\nSACR0 |= SACR0_RFTH(14) | SACR0_TFTH(1);\r\nSACR1 |= pxa_i2s.fmt;\r\n}\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nSAIMR |= SAIMR_TFS;\r\nelse\r\nSAIMR |= SAIMR_RFS;\r\nswitch (params_rate(params)) {\r\ncase 8000:\r\nSADIV = 0x48;\r\nbreak;\r\ncase 11025:\r\nSADIV = 0x34;\r\nbreak;\r\ncase 16000:\r\nSADIV = 0x24;\r\nbreak;\r\ncase 22050:\r\nSADIV = 0x1a;\r\nbreak;\r\ncase 44100:\r\nSADIV = 0xd;\r\nbreak;\r\ncase 48000:\r\nSADIV = 0xc;\r\nbreak;\r\ncase 96000:\r\nSADIV = 0x6;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int pxa2xx_i2s_trigger(struct snd_pcm_substream *substream, int cmd,\r\nstruct snd_soc_dai *dai)\r\n{\r\nint ret = 0;\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nSACR1 &= ~SACR1_DRPL;\r\nelse\r\nSACR1 &= ~SACR1_DREC;\r\nSACR0 |= SACR0_ENB;\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\n}\r\nreturn ret;\r\n}\r\nstatic void pxa2xx_i2s_shutdown(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK) {\r\nSACR1 |= SACR1_DRPL;\r\nSAIMR &= ~SAIMR_TFS;\r\n} else {\r\nSACR1 |= SACR1_DREC;\r\nSAIMR &= ~SAIMR_RFS;\r\n}\r\nif ((SACR1 & (SACR1_DREC | SACR1_DRPL)) == (SACR1_DREC | SACR1_DRPL)) {\r\nSACR0 &= ~SACR0_ENB;\r\npxa_i2s_wait();\r\nif (clk_ena) {\r\nclk_disable_unprepare(clk_i2s);\r\nclk_ena = 0;\r\n}\r\n}\r\n}\r\nstatic int pxa2xx_i2s_suspend(struct snd_soc_dai *dai)\r\n{\r\npxa_i2s.sacr0 = SACR0;\r\npxa_i2s.sacr1 = SACR1;\r\npxa_i2s.saimr = SAIMR;\r\npxa_i2s.sadiv = SADIV;\r\nSACR0 &= ~SACR0_ENB;\r\npxa_i2s_wait();\r\nreturn 0;\r\n}\r\nstatic int pxa2xx_i2s_resume(struct snd_soc_dai *dai)\r\n{\r\npxa_i2s_wait();\r\nSACR0 = pxa_i2s.sacr0 & ~SACR0_ENB;\r\nSACR1 = pxa_i2s.sacr1;\r\nSAIMR = pxa_i2s.saimr;\r\nSADIV = pxa_i2s.sadiv;\r\nSACR0 = pxa_i2s.sacr0;\r\nreturn 0;\r\n}\r\nstatic int pxa2xx_i2s_probe(struct snd_soc_dai *dai)\r\n{\r\nclk_i2s = clk_get(dai->dev, "I2SCLK");\r\nif (IS_ERR(clk_i2s))\r\nreturn PTR_ERR(clk_i2s);\r\nSACR0 = SACR0_RST;\r\nSACR0 = 0;\r\nSACR1 = SACR1_DRPL | SACR1_DREC;\r\nSAIMR &= ~(SAIMR_RFS | SAIMR_TFS);\r\nreturn 0;\r\n}\r\nstatic int pxa2xx_i2s_remove(struct snd_soc_dai *dai)\r\n{\r\nclk_put(clk_i2s);\r\nclk_i2s = ERR_PTR(-ENOENT);\r\nreturn 0;\r\n}\r\nstatic int pxa2xx_i2s_drv_probe(struct platform_device *pdev)\r\n{\r\nreturn snd_soc_register_component(&pdev->dev, &pxa_i2s_component,\r\n&pxa_i2s_dai, 1);\r\n}\r\nstatic int pxa2xx_i2s_drv_remove(struct platform_device *pdev)\r\n{\r\nsnd_soc_unregister_component(&pdev->dev);\r\nreturn 0;\r\n}\r\nstatic int __init pxa2xx_i2s_init(void)\r\n{\r\nclk_i2s = ERR_PTR(-ENOENT);\r\nreturn platform_driver_register(&pxa2xx_i2s_driver);\r\n}\r\nstatic void __exit pxa2xx_i2s_exit(void)\r\n{\r\nplatform_driver_unregister(&pxa2xx_i2s_driver);\r\n}

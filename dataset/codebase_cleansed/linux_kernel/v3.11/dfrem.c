int\r\ndbl_frem (dbl_floating_point * srcptr1, dbl_floating_point * srcptr2,\r\ndbl_floating_point * dstptr, unsigned int *status)\r\n{\r\nregister unsigned int opnd1p1, opnd1p2, opnd2p1, opnd2p2;\r\nregister unsigned int resultp1, resultp2;\r\nregister int opnd1_exponent, opnd2_exponent, dest_exponent, stepcount;\r\nregister boolean roundup = FALSE;\r\nDbl_copyfromptr(srcptr1,opnd1p1,opnd1p2);\r\nDbl_copyfromptr(srcptr2,opnd2p1,opnd2p2);\r\nif ((opnd1_exponent = Dbl_exponent(opnd1p1)) == DBL_INFINITY_EXPONENT) {\r\nif (Dbl_iszero_mantissa(opnd1p1,opnd1p2)) {\r\nif (Dbl_isnotnan(opnd2p1,opnd2p2)) {\r\nif (Is_invalidtrap_enabled())\r\nreturn(INVALIDEXCEPTION);\r\nSet_invalidflag();\r\nDbl_makequietnan(resultp1,resultp2);\r\nDbl_copytoptr(resultp1,resultp2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\n}\r\nelse {\r\nif (Dbl_isone_signaling(opnd1p1)) {\r\nif (Is_invalidtrap_enabled())\r\nreturn(INVALIDEXCEPTION);\r\nSet_invalidflag();\r\nDbl_set_quiet(opnd1p1);\r\n}\r\nelse if (Dbl_is_signalingnan(opnd2p1)) {\r\nif (Is_invalidtrap_enabled())\r\nreturn(INVALIDEXCEPTION);\r\nSet_invalidflag();\r\nDbl_set_quiet(opnd2p1);\r\nDbl_copytoptr(opnd2p1,opnd2p2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\nDbl_copytoptr(opnd1p1,opnd1p2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\n}\r\nif ((opnd2_exponent = Dbl_exponent(opnd2p1)) == DBL_INFINITY_EXPONENT) {\r\nif (Dbl_iszero_mantissa(opnd2p1,opnd2p2)) {\r\nDbl_copytoptr(opnd1p1,opnd1p2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\nif (Dbl_isone_signaling(opnd2p1)) {\r\nif (Is_invalidtrap_enabled()) return(INVALIDEXCEPTION);\r\nSet_invalidflag();\r\nDbl_set_quiet(opnd2p1);\r\n}\r\nDbl_copytoptr(opnd2p1,opnd2p2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\nif (Dbl_iszero_exponentmantissa(opnd2p1,opnd2p2)) {\r\nif (Is_invalidtrap_enabled()) return(INVALIDEXCEPTION);\r\nSet_invalidflag();\r\nDbl_makequietnan(resultp1,resultp2);\r\nDbl_copytoptr(resultp1,resultp2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\nresultp1 = opnd1p1;\r\nif (opnd1_exponent == 0) {\r\nif (Dbl_iszero_mantissa(opnd1p1,opnd1p2)) {\r\nDbl_copytoptr(opnd1p1,opnd1p2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\nopnd1_exponent = 1;\r\nDbl_normalize(opnd1p1,opnd1p2,opnd1_exponent);\r\n}\r\nelse {\r\nDbl_clear_signexponent_set_hidden(opnd1p1);\r\n}\r\nif (opnd2_exponent == 0) {\r\nopnd2_exponent = 1;\r\nDbl_normalize(opnd2p1,opnd2p2,opnd2_exponent);\r\n}\r\nelse {\r\nDbl_clear_signexponent_set_hidden(opnd2p1);\r\n}\r\ndest_exponent = opnd2_exponent - 1;\r\nstepcount = opnd1_exponent - opnd2_exponent;\r\nif (stepcount < 0) {\r\nif (stepcount == -1 &&\r\nDbl_isgreaterthan(opnd1p1,opnd1p2,opnd2p1,opnd2p2)) {\r\nDbl_allp1(resultp1) = ~Dbl_allp1(resultp1);\r\nDbl_leftshiftby1(opnd2p1,opnd2p2);\r\nDbl_subtract(opnd2p1,opnd2p2,opnd1p1,opnd1p2,\r\nopnd2p1,opnd2p2);\r\nwhile (Dbl_iszero_hidden(opnd2p1)) {\r\nDbl_leftshiftby1(opnd2p1,opnd2p2);\r\ndest_exponent--;\r\n}\r\nDbl_set_exponentmantissa(resultp1,resultp2,opnd2p1,opnd2p2);\r\ngoto testforunderflow;\r\n}\r\nDbl_set_exponentmantissa(resultp1,resultp2,opnd1p1,opnd1p2);\r\ndest_exponent = opnd1_exponent;\r\ngoto testforunderflow;\r\n}\r\nwhile (stepcount-- > 0 && (Dbl_allp1(opnd1p1) || Dbl_allp2(opnd1p2))) {\r\nif (Dbl_isnotlessthan(opnd1p1,opnd1p2,opnd2p1,opnd2p2)) {\r\nDbl_subtract(opnd1p1,opnd1p2,opnd2p1,opnd2p2,opnd1p1,opnd1p2);\r\n}\r\nDbl_leftshiftby1(opnd1p1,opnd1p2);\r\n}\r\nif (Dbl_isnotlessthan(opnd1p1,opnd1p2,opnd2p1,opnd2p2)) {\r\nDbl_subtract(opnd1p1,opnd1p2,opnd2p1,opnd2p2,opnd1p1,opnd1p2);\r\nroundup = TRUE;\r\n}\r\nif (stepcount > 0 || Dbl_iszero(opnd1p1,opnd1p2)) {\r\nDbl_setzero_exponentmantissa(resultp1,resultp2);\r\nDbl_copytoptr(resultp1,resultp2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}\r\nDbl_leftshiftby1(opnd1p1,opnd1p2);\r\nif (Dbl_isgreaterthan(opnd1p1,opnd1p2,opnd2p1,opnd2p2)) {\r\nDbl_invert_sign(resultp1);\r\nDbl_leftshiftby1(opnd2p1,opnd2p2);\r\nDbl_subtract(opnd2p1,opnd2p2,opnd1p1,opnd1p2,opnd1p1,opnd1p2);\r\n}\r\nelse if (Dbl_isequal(opnd1p1,opnd1p2,opnd2p1,opnd2p2) && roundup) {\r\nDbl_invert_sign(resultp1);\r\n}\r\nwhile (Dbl_iszero_hidden(opnd1p1)) {\r\ndest_exponent--;\r\nDbl_leftshiftby1(opnd1p1,opnd1p2);\r\n}\r\nDbl_set_exponentmantissa(resultp1,resultp2,opnd1p1,opnd1p2);\r\ntestforunderflow:\r\nif (dest_exponent <= 0) {\r\nif (Is_underflowtrap_enabled()) {\r\nDbl_setwrapped_exponent(resultp1,dest_exponent,unfl);\r\nDbl_copytoptr(resultp1,resultp2,dstptr);\r\nreturn(UNDERFLOWEXCEPTION);\r\n}\r\nif (dest_exponent >= (1 - DBL_P)) {\r\nDbl_rightshift_exponentmantissa(resultp1,resultp2,\r\n1-dest_exponent);\r\n}\r\nelse {\r\nDbl_setzero_exponentmantissa(resultp1,resultp2);\r\n}\r\n}\r\nelse Dbl_set_exponent(resultp1,dest_exponent);\r\nDbl_copytoptr(resultp1,resultp2,dstptr);\r\nreturn(NOEXCEPTION);\r\n}

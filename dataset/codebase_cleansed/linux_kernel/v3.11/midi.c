static int snd_usb_caiaq_midi_input_open(struct snd_rawmidi_substream *substream)\r\n{\r\nreturn 0;\r\n}\r\nstatic int snd_usb_caiaq_midi_input_close(struct snd_rawmidi_substream *substream)\r\n{\r\nreturn 0;\r\n}\r\nstatic void snd_usb_caiaq_midi_input_trigger(struct snd_rawmidi_substream *substream, int up)\r\n{\r\nstruct snd_usb_caiaqdev *cdev = substream->rmidi->private_data;\r\nif (!cdev)\r\nreturn;\r\ncdev->midi_receive_substream = up ? substream : NULL;\r\n}\r\nstatic int snd_usb_caiaq_midi_output_open(struct snd_rawmidi_substream *substream)\r\n{\r\nreturn 0;\r\n}\r\nstatic int snd_usb_caiaq_midi_output_close(struct snd_rawmidi_substream *substream)\r\n{\r\nstruct snd_usb_caiaqdev *cdev = substream->rmidi->private_data;\r\nif (cdev->midi_out_active) {\r\nusb_kill_urb(&cdev->midi_out_urb);\r\ncdev->midi_out_active = 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic void snd_usb_caiaq_midi_send(struct snd_usb_caiaqdev *cdev,\r\nstruct snd_rawmidi_substream *substream)\r\n{\r\nint len, ret;\r\nstruct device *dev = caiaqdev_to_dev(cdev);\r\ncdev->midi_out_buf[0] = EP1_CMD_MIDI_WRITE;\r\ncdev->midi_out_buf[1] = 0;\r\nlen = snd_rawmidi_transmit(substream, cdev->midi_out_buf + 3,\r\nEP1_BUFSIZE - 3);\r\nif (len <= 0)\r\nreturn;\r\ncdev->midi_out_buf[2] = len;\r\ncdev->midi_out_urb.transfer_buffer_length = len+3;\r\nret = usb_submit_urb(&cdev->midi_out_urb, GFP_ATOMIC);\r\nif (ret < 0)\r\ndev_err(dev,\r\n"snd_usb_caiaq_midi_send(%p): usb_submit_urb() failed,"\r\n"ret=%d, len=%d\n", substream, ret, len);\r\nelse\r\ncdev->midi_out_active = 1;\r\n}\r\nstatic void snd_usb_caiaq_midi_output_trigger(struct snd_rawmidi_substream *substream, int up)\r\n{\r\nstruct snd_usb_caiaqdev *cdev = substream->rmidi->private_data;\r\nif (up) {\r\ncdev->midi_out_substream = substream;\r\nif (!cdev->midi_out_active)\r\nsnd_usb_caiaq_midi_send(cdev, substream);\r\n} else {\r\ncdev->midi_out_substream = NULL;\r\n}\r\n}\r\nvoid snd_usb_caiaq_midi_handle_input(struct snd_usb_caiaqdev *cdev,\r\nint port, const char *buf, int len)\r\n{\r\nif (!cdev->midi_receive_substream)\r\nreturn;\r\nsnd_rawmidi_receive(cdev->midi_receive_substream, buf, len);\r\n}\r\nint snd_usb_caiaq_midi_init(struct snd_usb_caiaqdev *device)\r\n{\r\nint ret;\r\nstruct snd_rawmidi *rmidi;\r\nret = snd_rawmidi_new(device->chip.card, device->product_name, 0,\r\ndevice->spec.num_midi_out,\r\ndevice->spec.num_midi_in,\r\n&rmidi);\r\nif (ret < 0)\r\nreturn ret;\r\nstrlcpy(rmidi->name, device->product_name, sizeof(rmidi->name));\r\nrmidi->info_flags = SNDRV_RAWMIDI_INFO_DUPLEX;\r\nrmidi->private_data = device;\r\nif (device->spec.num_midi_out > 0) {\r\nrmidi->info_flags |= SNDRV_RAWMIDI_INFO_OUTPUT;\r\nsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_OUTPUT,\r\n&snd_usb_caiaq_midi_output);\r\n}\r\nif (device->spec.num_midi_in > 0) {\r\nrmidi->info_flags |= SNDRV_RAWMIDI_INFO_INPUT;\r\nsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_INPUT,\r\n&snd_usb_caiaq_midi_input);\r\n}\r\ndevice->rmidi = rmidi;\r\nreturn 0;\r\n}\r\nvoid snd_usb_caiaq_midi_output_done(struct urb* urb)\r\n{\r\nstruct snd_usb_caiaqdev *cdev = urb->context;\r\ncdev->midi_out_active = 0;\r\nif (urb->status != 0)\r\nreturn;\r\nif (!cdev->midi_out_substream)\r\nreturn;\r\nsnd_usb_caiaq_midi_send(cdev, cdev->midi_out_substream);\r\n}

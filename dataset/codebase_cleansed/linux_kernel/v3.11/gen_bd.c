struct bcom_task *\r\nbcom_gen_bd_rx_init(int queue_len, phys_addr_t fifo,\r\nint initiator, int ipr, int maxbufsize)\r\n{\r\nstruct bcom_task *tsk;\r\nstruct bcom_gen_bd_priv *priv;\r\ntsk = bcom_task_alloc(queue_len, sizeof(struct bcom_gen_bd),\r\nsizeof(struct bcom_gen_bd_priv));\r\nif (!tsk)\r\nreturn NULL;\r\ntsk->flags = BCOM_FLAGS_NONE;\r\npriv = tsk->priv;\r\npriv->fifo = fifo;\r\npriv->initiator = initiator;\r\npriv->ipr = ipr;\r\npriv->maxbufsize = maxbufsize;\r\nif (bcom_gen_bd_rx_reset(tsk)) {\r\nbcom_task_free(tsk);\r\nreturn NULL;\r\n}\r\nreturn tsk;\r\n}\r\nint\r\nbcom_gen_bd_rx_reset(struct bcom_task *tsk)\r\n{\r\nstruct bcom_gen_bd_priv *priv = tsk->priv;\r\nstruct bcom_gen_bd_rx_var *var;\r\nstruct bcom_gen_bd_rx_inc *inc;\r\nbcom_disable_task(tsk->tasknum);\r\nvar = (struct bcom_gen_bd_rx_var *) bcom_task_var(tsk->tasknum);\r\ninc = (struct bcom_gen_bd_rx_inc *) bcom_task_inc(tsk->tasknum);\r\nif (bcom_load_image(tsk->tasknum, bcom_gen_bd_rx_task))\r\nreturn -1;\r\nvar->enable = bcom_eng->regs_base +\r\noffsetof(struct mpc52xx_sdma, tcr[tsk->tasknum]);\r\nvar->fifo = (u32) priv->fifo;\r\nvar->bd_base = tsk->bd_pa;\r\nvar->bd_last = tsk->bd_pa + ((tsk->num_bd-1) * tsk->bd_size);\r\nvar->bd_start = tsk->bd_pa;\r\nvar->buffer_size = priv->maxbufsize;\r\ninc->incr_bytes = -(s16)sizeof(u32);\r\ninc->incr_dst = sizeof(u32);\r\ntsk->index = 0;\r\ntsk->outdex = 0;\r\nmemset(tsk->bd, 0x00, tsk->num_bd * tsk->bd_size);\r\nbcom_set_task_pragma(tsk->tasknum, BCOM_GEN_RX_BD_PRAGMA);\r\nbcom_set_task_auto_start(tsk->tasknum, tsk->tasknum);\r\nout_8(&bcom_eng->regs->ipr[priv->initiator], priv->ipr);\r\nbcom_set_initiator(tsk->tasknum, priv->initiator);\r\nout_be32(&bcom_eng->regs->IntPend, 1<<tsk->tasknum);\r\nreturn 0;\r\n}\r\nvoid\r\nbcom_gen_bd_rx_release(struct bcom_task *tsk)\r\n{\r\nbcom_task_free(tsk);\r\n}\r\nextern struct bcom_task *\r\nbcom_gen_bd_tx_init(int queue_len, phys_addr_t fifo,\r\nint initiator, int ipr)\r\n{\r\nstruct bcom_task *tsk;\r\nstruct bcom_gen_bd_priv *priv;\r\ntsk = bcom_task_alloc(queue_len, sizeof(struct bcom_gen_bd),\r\nsizeof(struct bcom_gen_bd_priv));\r\nif (!tsk)\r\nreturn NULL;\r\ntsk->flags = BCOM_FLAGS_NONE;\r\npriv = tsk->priv;\r\npriv->fifo = fifo;\r\npriv->initiator = initiator;\r\npriv->ipr = ipr;\r\nif (bcom_gen_bd_tx_reset(tsk)) {\r\nbcom_task_free(tsk);\r\nreturn NULL;\r\n}\r\nreturn tsk;\r\n}\r\nint\r\nbcom_gen_bd_tx_reset(struct bcom_task *tsk)\r\n{\r\nstruct bcom_gen_bd_priv *priv = tsk->priv;\r\nstruct bcom_gen_bd_tx_var *var;\r\nstruct bcom_gen_bd_tx_inc *inc;\r\nbcom_disable_task(tsk->tasknum);\r\nvar = (struct bcom_gen_bd_tx_var *) bcom_task_var(tsk->tasknum);\r\ninc = (struct bcom_gen_bd_tx_inc *) bcom_task_inc(tsk->tasknum);\r\nif (bcom_load_image(tsk->tasknum, bcom_gen_bd_tx_task))\r\nreturn -1;\r\nvar->enable = bcom_eng->regs_base +\r\noffsetof(struct mpc52xx_sdma, tcr[tsk->tasknum]);\r\nvar->fifo = (u32) priv->fifo;\r\nvar->bd_base = tsk->bd_pa;\r\nvar->bd_last = tsk->bd_pa + ((tsk->num_bd-1) * tsk->bd_size);\r\nvar->bd_start = tsk->bd_pa;\r\ninc->incr_bytes = -(s16)sizeof(u32);\r\ninc->incr_src = sizeof(u32);\r\ninc->incr_src_ma = sizeof(u8);\r\ntsk->index = 0;\r\ntsk->outdex = 0;\r\nmemset(tsk->bd, 0x00, tsk->num_bd * tsk->bd_size);\r\nbcom_set_task_pragma(tsk->tasknum, BCOM_GEN_TX_BD_PRAGMA);\r\nbcom_set_task_auto_start(tsk->tasknum, tsk->tasknum);\r\nout_8(&bcom_eng->regs->ipr[priv->initiator], priv->ipr);\r\nbcom_set_initiator(tsk->tasknum, priv->initiator);\r\nout_be32(&bcom_eng->regs->IntPend, 1<<tsk->tasknum);\r\nreturn 0;\r\n}\r\nvoid\r\nbcom_gen_bd_tx_release(struct bcom_task *tsk)\r\n{\r\nbcom_task_free(tsk);\r\n}\r\nstruct bcom_task * bcom_psc_gen_bd_rx_init(unsigned psc_num, int queue_len,\r\nphys_addr_t fifo, int maxbufsize)\r\n{\r\nif (psc_num >= MPC52xx_PSC_MAXNUM)\r\nreturn NULL;\r\nreturn bcom_gen_bd_rx_init(queue_len, fifo,\r\nbcom_psc_params[psc_num].rx_initiator,\r\nbcom_psc_params[psc_num].rx_ipr,\r\nmaxbufsize);\r\n}\r\nstruct bcom_task *\r\nbcom_psc_gen_bd_tx_init(unsigned psc_num, int queue_len, phys_addr_t fifo)\r\n{\r\nstruct psc;\r\nreturn bcom_gen_bd_tx_init(queue_len, fifo,\r\nbcom_psc_params[psc_num].tx_initiator,\r\nbcom_psc_params[psc_num].tx_ipr);\r\n}

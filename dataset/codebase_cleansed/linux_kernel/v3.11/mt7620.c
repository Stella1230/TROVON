void __init ralink_clk_init(void)\r\n{\r\nunsigned long cpu_rate, sys_rate;\r\nu32 c0 = rt_sysc_r32(SYSC_REG_CPLL_CONFIG0);\r\nu32 c1 = rt_sysc_r32(SYSC_REG_CPLL_CONFIG1);\r\nu32 swconfig = (c0 >> CPLL_SW_CONFIG_SHIFT) & CPLL_SW_CONFIG_MASK;\r\nu32 cpu_clk = (c1 >> CPLL_CPU_CLK_SHIFT) & CPLL_CPU_CLK_MASK;\r\nif (cpu_clk) {\r\ncpu_rate = 480000000;\r\n} else if (!swconfig) {\r\ncpu_rate = 600000000;\r\n} else {\r\nu32 m = (c0 >> CPLL_MULT_RATIO_SHIFT) & CPLL_MULT_RATIO;\r\nu32 d = (c0 >> CPLL_DIV_RATIO_SHIFT) & CPLL_DIV_RATIO;\r\ncpu_rate = ((40 * (m + 24)) / mt7620_clk_divider[d]) * 1000000;\r\n}\r\nif (dram_type == SYSCFG0_DRAM_TYPE_SDRAM)\r\nsys_rate = cpu_rate / 4;\r\nelse\r\nsys_rate = cpu_rate / 3;\r\nralink_clk_add("cpu", cpu_rate);\r\nralink_clk_add("10000100.timer", 40000000);\r\nralink_clk_add("10000500.uart", 40000000);\r\nralink_clk_add("10000c00.uartlite", 40000000);\r\n}\r\nvoid __init ralink_of_remap(void)\r\n{\r\nrt_sysc_membase = plat_of_remap_node("ralink,mt7620a-sysc");\r\nrt_memc_membase = plat_of_remap_node("ralink,mt7620a-memc");\r\nif (!rt_sysc_membase || !rt_memc_membase)\r\npanic("Failed to remap core resources");\r\n}\r\nvoid prom_soc_init(struct ralink_soc_info *soc_info)\r\n{\r\nvoid __iomem *sysc = (void __iomem *) KSEG1ADDR(MT7620_SYSC_BASE);\r\nunsigned char *name = NULL;\r\nu32 n0;\r\nu32 n1;\r\nu32 rev;\r\nu32 cfg0;\r\nn0 = __raw_readl(sysc + SYSC_REG_CHIP_NAME0);\r\nn1 = __raw_readl(sysc + SYSC_REG_CHIP_NAME1);\r\nif (n0 == MT7620N_CHIP_NAME0 && n1 == MT7620N_CHIP_NAME1) {\r\nname = "MT7620N";\r\nsoc_info->compatible = "ralink,mt7620n-soc";\r\n} else if (n0 == MT7620A_CHIP_NAME0 && n1 == MT7620A_CHIP_NAME1) {\r\nname = "MT7620A";\r\nsoc_info->compatible = "ralink,mt7620a-soc";\r\n} else {\r\npanic("mt7620: unknown SoC, n0:%08x n1:%08x\n", n0, n1);\r\n}\r\nrev = __raw_readl(sysc + SYSC_REG_CHIP_REV);\r\nsnprintf(soc_info->sys_type, RAMIPS_SYS_TYPE_LEN,\r\n"Ralink %s ver:%u eco:%u",\r\nname,\r\n(rev >> CHIP_REV_VER_SHIFT) & CHIP_REV_VER_MASK,\r\n(rev & CHIP_REV_ECO_MASK));\r\ncfg0 = __raw_readl(sysc + SYSC_REG_SYSTEM_CONFIG0);\r\ndram_type = (cfg0 >> SYSCFG0_DRAM_TYPE_SHIFT) & SYSCFG0_DRAM_TYPE_MASK;\r\nswitch (dram_type) {\r\ncase SYSCFG0_DRAM_TYPE_SDRAM:\r\nsoc_info->mem_size_min = MT7620_SDRAM_SIZE_MIN;\r\nsoc_info->mem_size_max = MT7620_SDRAM_SIZE_MAX;\r\nbreak;\r\ncase SYSCFG0_DRAM_TYPE_DDR1:\r\nsoc_info->mem_size_min = MT7620_DDR1_SIZE_MIN;\r\nsoc_info->mem_size_max = MT7620_DDR1_SIZE_MAX;\r\nbreak;\r\ncase SYSCFG0_DRAM_TYPE_DDR2:\r\nsoc_info->mem_size_min = MT7620_DDR2_SIZE_MIN;\r\nsoc_info->mem_size_max = MT7620_DDR2_SIZE_MAX;\r\nbreak;\r\ndefault:\r\nBUG();\r\n}\r\nsoc_info->mem_base = MT7620_DRAM_BASE;\r\n}

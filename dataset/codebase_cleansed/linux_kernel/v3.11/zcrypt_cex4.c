static int zcrypt_cex4_probe(struct ap_device *ap_dev)\r\n{\r\nstruct zcrypt_device *zdev = NULL;\r\nint rc = 0;\r\nswitch (ap_dev->device_type) {\r\ncase AP_DEVICE_TYPE_CEX4:\r\nif (ap_test_bit(&ap_dev->functions, AP_FUNC_ACCEL)) {\r\nzdev = zcrypt_device_alloc(CEX4A_MAX_MESSAGE_SIZE);\r\nif (!zdev)\r\nreturn -ENOMEM;\r\nzdev->type_string = "CEX4A";\r\nzdev->user_space_type = ZCRYPT_CEX3A;\r\nzdev->min_mod_size = CEX4A_MIN_MOD_SIZE;\r\nif (ap_test_bit(&ap_dev->functions, AP_FUNC_MEX4K) &&\r\nap_test_bit(&ap_dev->functions, AP_FUNC_CRT4K)) {\r\nzdev->max_mod_size =\r\nCEX4A_MAX_MOD_SIZE_4K;\r\nzdev->max_exp_bit_length =\r\nCEX4A_MAX_MOD_SIZE_4K;\r\n} else {\r\nzdev->max_mod_size =\r\nCEX4A_MAX_MOD_SIZE_2K;\r\nzdev->max_exp_bit_length =\r\nCEX4A_MAX_MOD_SIZE_2K;\r\n}\r\nzdev->short_crt = 1;\r\nzdev->speed_rating = CEX4A_SPEED_RATING;\r\nzdev->ops = zcrypt_msgtype_request(MSGTYPE50_NAME,\r\nMSGTYPE50_VARIANT_DEFAULT);\r\n} else if (ap_test_bit(&ap_dev->functions, AP_FUNC_COPRO)) {\r\nzdev = zcrypt_device_alloc(CEX4C_MAX_MESSAGE_SIZE);\r\nif (!zdev)\r\nreturn -ENOMEM;\r\nzdev->type_string = "CEX4C";\r\nzdev->user_space_type = ZCRYPT_CEX3C;\r\nzdev->min_mod_size = CEX4C_MIN_MOD_SIZE;\r\nzdev->max_mod_size = CEX4C_MAX_MOD_SIZE;\r\nzdev->max_exp_bit_length = CEX4C_MAX_MOD_SIZE;\r\nzdev->short_crt = 0;\r\nzdev->speed_rating = CEX4C_SPEED_RATING;\r\nzdev->ops = zcrypt_msgtype_request(MSGTYPE06_NAME,\r\nMSGTYPE06_VARIANT_DEFAULT);\r\n}\r\nbreak;\r\n}\r\nif (!zdev)\r\nreturn -ENODEV;\r\nzdev->ap_dev = ap_dev;\r\nzdev->online = 1;\r\nap_dev->reply = &zdev->reply;\r\nap_dev->private = zdev;\r\nrc = zcrypt_device_register(zdev);\r\nif (rc) {\r\nzcrypt_msgtype_release(zdev->ops);\r\nap_dev->private = NULL;\r\nzcrypt_device_free(zdev);\r\n}\r\nreturn rc;\r\n}\r\nstatic void zcrypt_cex4_remove(struct ap_device *ap_dev)\r\n{\r\nstruct zcrypt_device *zdev = ap_dev->private;\r\nstruct zcrypt_ops *zops;\r\nif (zdev) {\r\nzops = zdev->ops;\r\nzcrypt_device_unregister(zdev);\r\nzcrypt_msgtype_release(zops);\r\n}\r\n}\r\nint __init zcrypt_cex4_init(void)\r\n{\r\nreturn ap_driver_register(&zcrypt_cex4_driver, THIS_MODULE, "cex4");\r\n}\r\nvoid __exit zcrypt_cex4_exit(void)\r\n{\r\nap_driver_unregister(&zcrypt_cex4_driver);\r\n}

static void print_chunk(struct extent_buffer *eb, struct btrfs_chunk *chunk)\r\n{\r\nint num_stripes = btrfs_chunk_num_stripes(eb, chunk);\r\nint i;\r\nprintk(KERN_INFO "\t\tchunk length %llu owner %llu type %llu "\r\n"num_stripes %d\n",\r\n(unsigned long long)btrfs_chunk_length(eb, chunk),\r\n(unsigned long long)btrfs_chunk_owner(eb, chunk),\r\n(unsigned long long)btrfs_chunk_type(eb, chunk),\r\nnum_stripes);\r\nfor (i = 0 ; i < num_stripes ; i++) {\r\nprintk(KERN_INFO "\t\t\tstripe %d devid %llu offset %llu\n", i,\r\n(unsigned long long)btrfs_stripe_devid_nr(eb, chunk, i),\r\n(unsigned long long)btrfs_stripe_offset_nr(eb, chunk, i));\r\n}\r\n}\r\nstatic void print_dev_item(struct extent_buffer *eb,\r\nstruct btrfs_dev_item *dev_item)\r\n{\r\nprintk(KERN_INFO "\t\tdev item devid %llu "\r\n"total_bytes %llu bytes used %llu\n",\r\n(unsigned long long)btrfs_device_id(eb, dev_item),\r\n(unsigned long long)btrfs_device_total_bytes(eb, dev_item),\r\n(unsigned long long)btrfs_device_bytes_used(eb, dev_item));\r\n}\r\nstatic void print_extent_data_ref(struct extent_buffer *eb,\r\nstruct btrfs_extent_data_ref *ref)\r\n{\r\nprintk(KERN_INFO "\t\textent data backref root %llu "\r\n"objectid %llu offset %llu count %u\n",\r\n(unsigned long long)btrfs_extent_data_ref_root(eb, ref),\r\n(unsigned long long)btrfs_extent_data_ref_objectid(eb, ref),\r\n(unsigned long long)btrfs_extent_data_ref_offset(eb, ref),\r\nbtrfs_extent_data_ref_count(eb, ref));\r\n}\r\nstatic void print_extent_item(struct extent_buffer *eb, int slot)\r\n{\r\nstruct btrfs_extent_item *ei;\r\nstruct btrfs_extent_inline_ref *iref;\r\nstruct btrfs_extent_data_ref *dref;\r\nstruct btrfs_shared_data_ref *sref;\r\nstruct btrfs_disk_key key;\r\nunsigned long end;\r\nunsigned long ptr;\r\nint type;\r\nu32 item_size = btrfs_item_size_nr(eb, slot);\r\nu64 flags;\r\nu64 offset;\r\nif (item_size < sizeof(*ei)) {\r\n#ifdef BTRFS_COMPAT_EXTENT_TREE_V0\r\nstruct btrfs_extent_item_v0 *ei0;\r\nBUG_ON(item_size != sizeof(*ei0));\r\nei0 = btrfs_item_ptr(eb, slot, struct btrfs_extent_item_v0);\r\nprintk(KERN_INFO "\t\textent refs %u\n",\r\nbtrfs_extent_refs_v0(eb, ei0));\r\nreturn;\r\n#else\r\nBUG();\r\n#endif\r\n}\r\nei = btrfs_item_ptr(eb, slot, struct btrfs_extent_item);\r\nflags = btrfs_extent_flags(eb, ei);\r\nprintk(KERN_INFO "\t\textent refs %llu gen %llu flags %llu\n",\r\n(unsigned long long)btrfs_extent_refs(eb, ei),\r\n(unsigned long long)btrfs_extent_generation(eb, ei),\r\n(unsigned long long)flags);\r\nif (flags & BTRFS_EXTENT_FLAG_TREE_BLOCK) {\r\nstruct btrfs_tree_block_info *info;\r\ninfo = (struct btrfs_tree_block_info *)(ei + 1);\r\nbtrfs_tree_block_key(eb, info, &key);\r\nprintk(KERN_INFO "\t\ttree block key (%llu %x %llu) "\r\n"level %d\n",\r\n(unsigned long long)btrfs_disk_key_objectid(&key),\r\nkey.type,\r\n(unsigned long long)btrfs_disk_key_offset(&key),\r\nbtrfs_tree_block_level(eb, info));\r\niref = (struct btrfs_extent_inline_ref *)(info + 1);\r\n} else {\r\niref = (struct btrfs_extent_inline_ref *)(ei + 1);\r\n}\r\nptr = (unsigned long)iref;\r\nend = (unsigned long)ei + item_size;\r\nwhile (ptr < end) {\r\niref = (struct btrfs_extent_inline_ref *)ptr;\r\ntype = btrfs_extent_inline_ref_type(eb, iref);\r\noffset = btrfs_extent_inline_ref_offset(eb, iref);\r\nswitch (type) {\r\ncase BTRFS_TREE_BLOCK_REF_KEY:\r\nprintk(KERN_INFO "\t\ttree block backref "\r\n"root %llu\n", (unsigned long long)offset);\r\nbreak;\r\ncase BTRFS_SHARED_BLOCK_REF_KEY:\r\nprintk(KERN_INFO "\t\tshared block backref "\r\n"parent %llu\n", (unsigned long long)offset);\r\nbreak;\r\ncase BTRFS_EXTENT_DATA_REF_KEY:\r\ndref = (struct btrfs_extent_data_ref *)(&iref->offset);\r\nprint_extent_data_ref(eb, dref);\r\nbreak;\r\ncase BTRFS_SHARED_DATA_REF_KEY:\r\nsref = (struct btrfs_shared_data_ref *)(iref + 1);\r\nprintk(KERN_INFO "\t\tshared data backref "\r\n"parent %llu count %u\n",\r\n(unsigned long long)offset,\r\nbtrfs_shared_data_ref_count(eb, sref));\r\nbreak;\r\ndefault:\r\nBUG();\r\n}\r\nptr += btrfs_extent_inline_ref_size(type);\r\n}\r\nWARN_ON(ptr > end);\r\n}\r\nstatic void print_extent_ref_v0(struct extent_buffer *eb, int slot)\r\n{\r\nstruct btrfs_extent_ref_v0 *ref0;\r\nref0 = btrfs_item_ptr(eb, slot, struct btrfs_extent_ref_v0);\r\nprintk("\t\textent back ref root %llu gen %llu "\r\n"owner %llu num_refs %lu\n",\r\n(unsigned long long)btrfs_ref_root_v0(eb, ref0),\r\n(unsigned long long)btrfs_ref_generation_v0(eb, ref0),\r\n(unsigned long long)btrfs_ref_objectid_v0(eb, ref0),\r\n(unsigned long)btrfs_ref_count_v0(eb, ref0));\r\n}\r\nvoid btrfs_print_leaf(struct btrfs_root *root, struct extent_buffer *l)\r\n{\r\nint i;\r\nu32 type, nr;\r\nstruct btrfs_item *item;\r\nstruct btrfs_root_item *ri;\r\nstruct btrfs_dir_item *di;\r\nstruct btrfs_inode_item *ii;\r\nstruct btrfs_block_group_item *bi;\r\nstruct btrfs_file_extent_item *fi;\r\nstruct btrfs_extent_data_ref *dref;\r\nstruct btrfs_shared_data_ref *sref;\r\nstruct btrfs_dev_extent *dev_extent;\r\nstruct btrfs_key key;\r\nstruct btrfs_key found_key;\r\nif (!l)\r\nreturn;\r\nnr = btrfs_header_nritems(l);\r\nbtrfs_info(root->fs_info, "leaf %llu total ptrs %d free space %d",\r\n(unsigned long long)btrfs_header_bytenr(l), nr,\r\nbtrfs_leaf_free_space(root, l));\r\nfor (i = 0 ; i < nr ; i++) {\r\nitem = btrfs_item_nr(l, i);\r\nbtrfs_item_key_to_cpu(l, &key, i);\r\ntype = btrfs_key_type(&key);\r\nprintk(KERN_INFO "\titem %d key (%llu %x %llu) itemoff %d "\r\n"itemsize %d\n",\r\ni,\r\n(unsigned long long)key.objectid, type,\r\n(unsigned long long)key.offset,\r\nbtrfs_item_offset(l, item), btrfs_item_size(l, item));\r\nswitch (type) {\r\ncase BTRFS_INODE_ITEM_KEY:\r\nii = btrfs_item_ptr(l, i, struct btrfs_inode_item);\r\nprintk(KERN_INFO "\t\tinode generation %llu size %llu "\r\n"mode %o\n",\r\n(unsigned long long)\r\nbtrfs_inode_generation(l, ii),\r\n(unsigned long long)btrfs_inode_size(l, ii),\r\nbtrfs_inode_mode(l, ii));\r\nbreak;\r\ncase BTRFS_DIR_ITEM_KEY:\r\ndi = btrfs_item_ptr(l, i, struct btrfs_dir_item);\r\nbtrfs_dir_item_key_to_cpu(l, di, &found_key);\r\nprintk(KERN_INFO "\t\tdir oid %llu type %u\n",\r\n(unsigned long long)found_key.objectid,\r\nbtrfs_dir_type(l, di));\r\nbreak;\r\ncase BTRFS_ROOT_ITEM_KEY:\r\nri = btrfs_item_ptr(l, i, struct btrfs_root_item);\r\nprintk(KERN_INFO "\t\troot data bytenr %llu refs %u\n",\r\n(unsigned long long)\r\nbtrfs_disk_root_bytenr(l, ri),\r\nbtrfs_disk_root_refs(l, ri));\r\nbreak;\r\ncase BTRFS_EXTENT_ITEM_KEY:\r\nprint_extent_item(l, i);\r\nbreak;\r\ncase BTRFS_TREE_BLOCK_REF_KEY:\r\nprintk(KERN_INFO "\t\ttree block backref\n");\r\nbreak;\r\ncase BTRFS_SHARED_BLOCK_REF_KEY:\r\nprintk(KERN_INFO "\t\tshared block backref\n");\r\nbreak;\r\ncase BTRFS_EXTENT_DATA_REF_KEY:\r\ndref = btrfs_item_ptr(l, i,\r\nstruct btrfs_extent_data_ref);\r\nprint_extent_data_ref(l, dref);\r\nbreak;\r\ncase BTRFS_SHARED_DATA_REF_KEY:\r\nsref = btrfs_item_ptr(l, i,\r\nstruct btrfs_shared_data_ref);\r\nprintk(KERN_INFO "\t\tshared data backref count %u\n",\r\nbtrfs_shared_data_ref_count(l, sref));\r\nbreak;\r\ncase BTRFS_EXTENT_DATA_KEY:\r\nfi = btrfs_item_ptr(l, i,\r\nstruct btrfs_file_extent_item);\r\nif (btrfs_file_extent_type(l, fi) ==\r\nBTRFS_FILE_EXTENT_INLINE) {\r\nprintk(KERN_INFO "\t\tinline extent data "\r\n"size %u\n",\r\nbtrfs_file_extent_inline_len(l, fi));\r\nbreak;\r\n}\r\nprintk(KERN_INFO "\t\textent data disk bytenr %llu "\r\n"nr %llu\n",\r\n(unsigned long long)\r\nbtrfs_file_extent_disk_bytenr(l, fi),\r\n(unsigned long long)\r\nbtrfs_file_extent_disk_num_bytes(l, fi));\r\nprintk(KERN_INFO "\t\textent data offset %llu "\r\n"nr %llu ram %llu\n",\r\n(unsigned long long)\r\nbtrfs_file_extent_offset(l, fi),\r\n(unsigned long long)\r\nbtrfs_file_extent_num_bytes(l, fi),\r\n(unsigned long long)\r\nbtrfs_file_extent_ram_bytes(l, fi));\r\nbreak;\r\ncase BTRFS_EXTENT_REF_V0_KEY:\r\n#ifdef BTRFS_COMPAT_EXTENT_TREE_V0\r\nprint_extent_ref_v0(l, i);\r\n#else\r\nBUG();\r\n#endif\r\nbreak;\r\ncase BTRFS_BLOCK_GROUP_ITEM_KEY:\r\nbi = btrfs_item_ptr(l, i,\r\nstruct btrfs_block_group_item);\r\nprintk(KERN_INFO "\t\tblock group used %llu\n",\r\n(unsigned long long)\r\nbtrfs_disk_block_group_used(l, bi));\r\nbreak;\r\ncase BTRFS_CHUNK_ITEM_KEY:\r\nprint_chunk(l, btrfs_item_ptr(l, i,\r\nstruct btrfs_chunk));\r\nbreak;\r\ncase BTRFS_DEV_ITEM_KEY:\r\nprint_dev_item(l, btrfs_item_ptr(l, i,\r\nstruct btrfs_dev_item));\r\nbreak;\r\ncase BTRFS_DEV_EXTENT_KEY:\r\ndev_extent = btrfs_item_ptr(l, i,\r\nstruct btrfs_dev_extent);\r\nprintk(KERN_INFO "\t\tdev extent chunk_tree %llu\n"\r\n"\t\tchunk objectid %llu chunk offset %llu "\r\n"length %llu\n",\r\n(unsigned long long)\r\nbtrfs_dev_extent_chunk_tree(l, dev_extent),\r\n(unsigned long long)\r\nbtrfs_dev_extent_chunk_objectid(l, dev_extent),\r\n(unsigned long long)\r\nbtrfs_dev_extent_chunk_offset(l, dev_extent),\r\n(unsigned long long)\r\nbtrfs_dev_extent_length(l, dev_extent));\r\nbreak;\r\ncase BTRFS_DEV_STATS_KEY:\r\nprintk(KERN_INFO "\t\tdevice stats\n");\r\nbreak;\r\ncase BTRFS_DEV_REPLACE_KEY:\r\nprintk(KERN_INFO "\t\tdev replace\n");\r\nbreak;\r\n};\r\n}\r\n}\r\nvoid btrfs_print_tree(struct btrfs_root *root, struct extent_buffer *c)\r\n{\r\nint i; u32 nr;\r\nstruct btrfs_key key;\r\nint level;\r\nif (!c)\r\nreturn;\r\nnr = btrfs_header_nritems(c);\r\nlevel = btrfs_header_level(c);\r\nif (level == 0) {\r\nbtrfs_print_leaf(root, c);\r\nreturn;\r\n}\r\nbtrfs_info(root->fs_info, "node %llu level %d total ptrs %d free spc %u",\r\n(unsigned long long)btrfs_header_bytenr(c),\r\nlevel, nr, (u32)BTRFS_NODEPTRS_PER_BLOCK(root) - nr);\r\nfor (i = 0; i < nr; i++) {\r\nbtrfs_node_key_to_cpu(c, &key, i);\r\nprintk(KERN_INFO "\tkey %d (%llu %u %llu) block %llu\n",\r\ni,\r\n(unsigned long long)key.objectid,\r\nkey.type,\r\n(unsigned long long)key.offset,\r\n(unsigned long long)btrfs_node_blockptr(c, i));\r\n}\r\nfor (i = 0; i < nr; i++) {\r\nstruct extent_buffer *next = read_tree_block(root,\r\nbtrfs_node_blockptr(c, i),\r\nbtrfs_level_size(root, level - 1),\r\nbtrfs_node_ptr_generation(c, i));\r\nif (btrfs_is_leaf(next) &&\r\nlevel != 1)\r\nBUG();\r\nif (btrfs_header_level(next) !=\r\nlevel - 1)\r\nBUG();\r\nbtrfs_print_tree(root, next);\r\nfree_extent_buffer(next);\r\n}\r\n}

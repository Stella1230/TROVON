int jffs2_sum_init(struct jffs2_sb_info *c)\r\n{\r\nuint32_t sum_size = min_t(uint32_t, c->sector_size, MAX_SUMMARY_SIZE);\r\nc->summary = kzalloc(sizeof(struct jffs2_summary), GFP_KERNEL);\r\nif (!c->summary) {\r\nJFFS2_WARNING("Can't allocate memory for summary information!\n");\r\nreturn -ENOMEM;\r\n}\r\nc->summary->sum_buf = kmalloc(sum_size, GFP_KERNEL);\r\nif (!c->summary->sum_buf) {\r\nJFFS2_WARNING("Can't allocate buffer for writing out summary information!\n");\r\nkfree(c->summary);\r\nreturn -ENOMEM;\r\n}\r\ndbg_summary("returned successfully\n");\r\nreturn 0;\r\n}\r\nvoid jffs2_sum_exit(struct jffs2_sb_info *c)\r\n{\r\ndbg_summary("called\n");\r\njffs2_sum_disable_collecting(c->summary);\r\nkfree(c->summary->sum_buf);\r\nc->summary->sum_buf = NULL;\r\nkfree(c->summary);\r\nc->summary = NULL;\r\n}\r\nstatic int jffs2_sum_add_mem(struct jffs2_summary *s, union jffs2_sum_mem *item)\r\n{\r\nif (!s->sum_list_head)\r\ns->sum_list_head = (union jffs2_sum_mem *) item;\r\nif (s->sum_list_tail)\r\ns->sum_list_tail->u.next = (union jffs2_sum_mem *) item;\r\ns->sum_list_tail = (union jffs2_sum_mem *) item;\r\nswitch (je16_to_cpu(item->u.nodetype)) {\r\ncase JFFS2_NODETYPE_INODE:\r\ns->sum_size += JFFS2_SUMMARY_INODE_SIZE;\r\ns->sum_num++;\r\ndbg_summary("inode (%u) added to summary\n",\r\nje32_to_cpu(item->i.inode));\r\nbreak;\r\ncase JFFS2_NODETYPE_DIRENT:\r\ns->sum_size += JFFS2_SUMMARY_DIRENT_SIZE(item->d.nsize);\r\ns->sum_num++;\r\ndbg_summary("dirent (%u) added to summary\n",\r\nje32_to_cpu(item->d.ino));\r\nbreak;\r\n#ifdef CONFIG_JFFS2_FS_XATTR\r\ncase JFFS2_NODETYPE_XATTR:\r\ns->sum_size += JFFS2_SUMMARY_XATTR_SIZE;\r\ns->sum_num++;\r\ndbg_summary("xattr (xid=%u, version=%u) added to summary\n",\r\nje32_to_cpu(item->x.xid), je32_to_cpu(item->x.version));\r\nbreak;\r\ncase JFFS2_NODETYPE_XREF:\r\ns->sum_size += JFFS2_SUMMARY_XREF_SIZE;\r\ns->sum_num++;\r\ndbg_summary("xref added to summary\n");\r\nbreak;\r\n#endif\r\ndefault:\r\nJFFS2_WARNING("UNKNOWN node type %u\n",\r\nje16_to_cpu(item->u.nodetype));\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nint jffs2_sum_add_padding_mem(struct jffs2_summary *s, uint32_t size)\r\n{\r\ndbg_summary("called with %u\n", size);\r\ns->sum_padded += size;\r\nreturn 0;\r\n}\r\nint jffs2_sum_add_inode_mem(struct jffs2_summary *s, struct jffs2_raw_inode *ri,\r\nuint32_t ofs)\r\n{\r\nstruct jffs2_sum_inode_mem *temp = kmalloc(sizeof(struct jffs2_sum_inode_mem), GFP_KERNEL);\r\nif (!temp)\r\nreturn -ENOMEM;\r\ntemp->nodetype = ri->nodetype;\r\ntemp->inode = ri->ino;\r\ntemp->version = ri->version;\r\ntemp->offset = cpu_to_je32(ofs);\r\ntemp->totlen = ri->totlen;\r\ntemp->next = NULL;\r\nreturn jffs2_sum_add_mem(s, (union jffs2_sum_mem *)temp);\r\n}\r\nint jffs2_sum_add_dirent_mem(struct jffs2_summary *s, struct jffs2_raw_dirent *rd,\r\nuint32_t ofs)\r\n{\r\nstruct jffs2_sum_dirent_mem *temp =\r\nkmalloc(sizeof(struct jffs2_sum_dirent_mem) + rd->nsize, GFP_KERNEL);\r\nif (!temp)\r\nreturn -ENOMEM;\r\ntemp->nodetype = rd->nodetype;\r\ntemp->totlen = rd->totlen;\r\ntemp->offset = cpu_to_je32(ofs);\r\ntemp->pino = rd->pino;\r\ntemp->version = rd->version;\r\ntemp->ino = rd->ino;\r\ntemp->nsize = rd->nsize;\r\ntemp->type = rd->type;\r\ntemp->next = NULL;\r\nmemcpy(temp->name, rd->name, rd->nsize);\r\nreturn jffs2_sum_add_mem(s, (union jffs2_sum_mem *)temp);\r\n}\r\nint jffs2_sum_add_xattr_mem(struct jffs2_summary *s, struct jffs2_raw_xattr *rx, uint32_t ofs)\r\n{\r\nstruct jffs2_sum_xattr_mem *temp;\r\ntemp = kmalloc(sizeof(struct jffs2_sum_xattr_mem), GFP_KERNEL);\r\nif (!temp)\r\nreturn -ENOMEM;\r\ntemp->nodetype = rx->nodetype;\r\ntemp->xid = rx->xid;\r\ntemp->version = rx->version;\r\ntemp->offset = cpu_to_je32(ofs);\r\ntemp->totlen = rx->totlen;\r\ntemp->next = NULL;\r\nreturn jffs2_sum_add_mem(s, (union jffs2_sum_mem *)temp);\r\n}\r\nint jffs2_sum_add_xref_mem(struct jffs2_summary *s, struct jffs2_raw_xref *rr, uint32_t ofs)\r\n{\r\nstruct jffs2_sum_xref_mem *temp;\r\ntemp = kmalloc(sizeof(struct jffs2_sum_xref_mem), GFP_KERNEL);\r\nif (!temp)\r\nreturn -ENOMEM;\r\ntemp->nodetype = rr->nodetype;\r\ntemp->offset = cpu_to_je32(ofs);\r\ntemp->next = NULL;\r\nreturn jffs2_sum_add_mem(s, (union jffs2_sum_mem *)temp);\r\n}\r\nstatic void jffs2_sum_clean_collected(struct jffs2_summary *s)\r\n{\r\nunion jffs2_sum_mem *temp;\r\nif (!s->sum_list_head) {\r\ndbg_summary("already empty\n");\r\n}\r\nwhile (s->sum_list_head) {\r\ntemp = s->sum_list_head;\r\ns->sum_list_head = s->sum_list_head->u.next;\r\nkfree(temp);\r\n}\r\ns->sum_list_tail = NULL;\r\ns->sum_padded = 0;\r\ns->sum_num = 0;\r\n}\r\nvoid jffs2_sum_reset_collected(struct jffs2_summary *s)\r\n{\r\ndbg_summary("called\n");\r\njffs2_sum_clean_collected(s);\r\ns->sum_size = 0;\r\n}\r\nvoid jffs2_sum_disable_collecting(struct jffs2_summary *s)\r\n{\r\ndbg_summary("called\n");\r\njffs2_sum_clean_collected(s);\r\ns->sum_size = JFFS2_SUMMARY_NOSUM_SIZE;\r\n}\r\nint jffs2_sum_is_disabled(struct jffs2_summary *s)\r\n{\r\nreturn (s->sum_size == JFFS2_SUMMARY_NOSUM_SIZE);\r\n}\r\nvoid jffs2_sum_move_collected(struct jffs2_sb_info *c, struct jffs2_summary *s)\r\n{\r\ndbg_summary("oldsize=0x%x oldnum=%u => newsize=0x%x newnum=%u\n",\r\nc->summary->sum_size, c->summary->sum_num,\r\ns->sum_size, s->sum_num);\r\nc->summary->sum_size = s->sum_size;\r\nc->summary->sum_num = s->sum_num;\r\nc->summary->sum_padded = s->sum_padded;\r\nc->summary->sum_list_head = s->sum_list_head;\r\nc->summary->sum_list_tail = s->sum_list_tail;\r\ns->sum_list_head = s->sum_list_tail = NULL;\r\n}\r\nint jffs2_sum_add_kvec(struct jffs2_sb_info *c, const struct kvec *invecs,\r\nunsigned long count, uint32_t ofs)\r\n{\r\nunion jffs2_node_union *node;\r\nstruct jffs2_eraseblock *jeb;\r\nif (c->summary->sum_size == JFFS2_SUMMARY_NOSUM_SIZE) {\r\ndbg_summary("Summary is disabled for this jeb! Skipping summary info!\n");\r\nreturn 0;\r\n}\r\nnode = invecs[0].iov_base;\r\njeb = &c->blocks[ofs / c->sector_size];\r\nofs -= jeb->offset;\r\nswitch (je16_to_cpu(node->u.nodetype)) {\r\ncase JFFS2_NODETYPE_INODE: {\r\nstruct jffs2_sum_inode_mem *temp =\r\nkmalloc(sizeof(struct jffs2_sum_inode_mem), GFP_KERNEL);\r\nif (!temp)\r\ngoto no_mem;\r\ntemp->nodetype = node->i.nodetype;\r\ntemp->inode = node->i.ino;\r\ntemp->version = node->i.version;\r\ntemp->offset = cpu_to_je32(ofs);\r\ntemp->totlen = node->i.totlen;\r\ntemp->next = NULL;\r\nreturn jffs2_sum_add_mem(c->summary, (union jffs2_sum_mem *)temp);\r\n}\r\ncase JFFS2_NODETYPE_DIRENT: {\r\nstruct jffs2_sum_dirent_mem *temp =\r\nkmalloc(sizeof(struct jffs2_sum_dirent_mem) + node->d.nsize, GFP_KERNEL);\r\nif (!temp)\r\ngoto no_mem;\r\ntemp->nodetype = node->d.nodetype;\r\ntemp->totlen = node->d.totlen;\r\ntemp->offset = cpu_to_je32(ofs);\r\ntemp->pino = node->d.pino;\r\ntemp->version = node->d.version;\r\ntemp->ino = node->d.ino;\r\ntemp->nsize = node->d.nsize;\r\ntemp->type = node->d.type;\r\ntemp->next = NULL;\r\nswitch (count) {\r\ncase 1:\r\nmemcpy(temp->name,node->d.name,node->d.nsize);\r\nbreak;\r\ncase 2:\r\nmemcpy(temp->name,invecs[1].iov_base,node->d.nsize);\r\nbreak;\r\ndefault:\r\nBUG();\r\nbreak;\r\n}\r\nreturn jffs2_sum_add_mem(c->summary, (union jffs2_sum_mem *)temp);\r\n}\r\n#ifdef CONFIG_JFFS2_FS_XATTR\r\ncase JFFS2_NODETYPE_XATTR: {\r\nstruct jffs2_sum_xattr_mem *temp;\r\ntemp = kmalloc(sizeof(struct jffs2_sum_xattr_mem), GFP_KERNEL);\r\nif (!temp)\r\ngoto no_mem;\r\ntemp->nodetype = node->x.nodetype;\r\ntemp->xid = node->x.xid;\r\ntemp->version = node->x.version;\r\ntemp->totlen = node->x.totlen;\r\ntemp->offset = cpu_to_je32(ofs);\r\ntemp->next = NULL;\r\nreturn jffs2_sum_add_mem(c->summary, (union jffs2_sum_mem *)temp);\r\n}\r\ncase JFFS2_NODETYPE_XREF: {\r\nstruct jffs2_sum_xref_mem *temp;\r\ntemp = kmalloc(sizeof(struct jffs2_sum_xref_mem), GFP_KERNEL);\r\nif (!temp)\r\ngoto no_mem;\r\ntemp->nodetype = node->r.nodetype;\r\ntemp->offset = cpu_to_je32(ofs);\r\ntemp->next = NULL;\r\nreturn jffs2_sum_add_mem(c->summary, (union jffs2_sum_mem *)temp);\r\n}\r\n#endif\r\ncase JFFS2_NODETYPE_PADDING:\r\ndbg_summary("node PADDING\n");\r\nc->summary->sum_padded += je32_to_cpu(node->u.totlen);\r\nbreak;\r\ncase JFFS2_NODETYPE_CLEANMARKER:\r\ndbg_summary("node CLEANMARKER\n");\r\nbreak;\r\ncase JFFS2_NODETYPE_SUMMARY:\r\ndbg_summary("node SUMMARY\n");\r\nbreak;\r\ndefault:\r\nBUG();\r\nbreak;\r\n}\r\nreturn 0;\r\nno_mem:\r\nJFFS2_WARNING("MEMORY ALLOCATION ERROR!");\r\nreturn -ENOMEM;\r\n}\r\nstatic struct jffs2_raw_node_ref *sum_link_node_ref(struct jffs2_sb_info *c,\r\nstruct jffs2_eraseblock *jeb,\r\nuint32_t ofs, uint32_t len,\r\nstruct jffs2_inode_cache *ic)\r\n{\r\nif ((ofs & ~3) > c->sector_size - jeb->free_size) {\r\njffs2_scan_dirty_space(c, jeb, (ofs & ~3) - (c->sector_size - jeb->free_size));\r\n}\r\nreturn jffs2_link_node_ref(c, jeb, jeb->offset + ofs, len, ic);\r\n}\r\nstatic int jffs2_sum_process_sum_data(struct jffs2_sb_info *c, struct jffs2_eraseblock *jeb,\r\nstruct jffs2_raw_summary *summary, uint32_t *pseudo_random)\r\n{\r\nstruct jffs2_inode_cache *ic;\r\nstruct jffs2_full_dirent *fd;\r\nvoid *sp;\r\nint i, ino;\r\nint err;\r\nsp = summary->sum;\r\nfor (i=0; i<je32_to_cpu(summary->sum_num); i++) {\r\ndbg_summary("processing summary index %d\n", i);\r\ncond_resched();\r\nerr = jffs2_prealloc_raw_node_refs(c, jeb, 2);\r\nif (err)\r\nreturn err;\r\nswitch (je16_to_cpu(((struct jffs2_sum_unknown_flash *)sp)->nodetype)) {\r\ncase JFFS2_NODETYPE_INODE: {\r\nstruct jffs2_sum_inode_flash *spi;\r\nspi = sp;\r\nino = je32_to_cpu(spi->inode);\r\ndbg_summary("Inode at 0x%08x-0x%08x\n",\r\njeb->offset + je32_to_cpu(spi->offset),\r\njeb->offset + je32_to_cpu(spi->offset) + je32_to_cpu(spi->totlen));\r\nic = jffs2_scan_make_ino_cache(c, ino);\r\nif (!ic) {\r\nJFFS2_NOTICE("scan_make_ino_cache failed\n");\r\nreturn -ENOMEM;\r\n}\r\nsum_link_node_ref(c, jeb, je32_to_cpu(spi->offset) | REF_UNCHECKED,\r\nPAD(je32_to_cpu(spi->totlen)), ic);\r\n*pseudo_random += je32_to_cpu(spi->version);\r\nsp += JFFS2_SUMMARY_INODE_SIZE;\r\nbreak;\r\n}\r\ncase JFFS2_NODETYPE_DIRENT: {\r\nstruct jffs2_sum_dirent_flash *spd;\r\nint checkedlen;\r\nspd = sp;\r\ndbg_summary("Dirent at 0x%08x-0x%08x\n",\r\njeb->offset + je32_to_cpu(spd->offset),\r\njeb->offset + je32_to_cpu(spd->offset) + je32_to_cpu(spd->totlen));\r\ncheckedlen = strnlen(spd->name, spd->nsize);\r\nif (!checkedlen) {\r\npr_err("Dirent at %08x has zero at start of name. Aborting mount.\n",\r\njeb->offset +\r\nje32_to_cpu(spd->offset));\r\nreturn -EIO;\r\n}\r\nif (checkedlen < spd->nsize) {\r\npr_err("Dirent at %08x has zeroes in name. Truncating to %d chars\n",\r\njeb->offset +\r\nje32_to_cpu(spd->offset),\r\ncheckedlen);\r\n}\r\nfd = jffs2_alloc_full_dirent(checkedlen+1);\r\nif (!fd)\r\nreturn -ENOMEM;\r\nmemcpy(&fd->name, spd->name, checkedlen);\r\nfd->name[checkedlen] = 0;\r\nic = jffs2_scan_make_ino_cache(c, je32_to_cpu(spd->pino));\r\nif (!ic) {\r\njffs2_free_full_dirent(fd);\r\nreturn -ENOMEM;\r\n}\r\nfd->raw = sum_link_node_ref(c, jeb, je32_to_cpu(spd->offset) | REF_UNCHECKED,\r\nPAD(je32_to_cpu(spd->totlen)), ic);\r\nfd->next = NULL;\r\nfd->version = je32_to_cpu(spd->version);\r\nfd->ino = je32_to_cpu(spd->ino);\r\nfd->nhash = full_name_hash(fd->name, checkedlen);\r\nfd->type = spd->type;\r\njffs2_add_fd_to_list(c, fd, &ic->scan_dents);\r\n*pseudo_random += je32_to_cpu(spd->version);\r\nsp += JFFS2_SUMMARY_DIRENT_SIZE(spd->nsize);\r\nbreak;\r\n}\r\n#ifdef CONFIG_JFFS2_FS_XATTR\r\ncase JFFS2_NODETYPE_XATTR: {\r\nstruct jffs2_xattr_datum *xd;\r\nstruct jffs2_sum_xattr_flash *spx;\r\nspx = (struct jffs2_sum_xattr_flash *)sp;\r\ndbg_summary("xattr at %#08x-%#08x (xid=%u, version=%u)\n",\r\njeb->offset + je32_to_cpu(spx->offset),\r\njeb->offset + je32_to_cpu(spx->offset) + je32_to_cpu(spx->totlen),\r\nje32_to_cpu(spx->xid), je32_to_cpu(spx->version));\r\nxd = jffs2_setup_xattr_datum(c, je32_to_cpu(spx->xid),\r\nje32_to_cpu(spx->version));\r\nif (IS_ERR(xd))\r\nreturn PTR_ERR(xd);\r\nif (xd->version > je32_to_cpu(spx->version)) {\r\nstruct jffs2_raw_node_ref *raw\r\n= sum_link_node_ref(c, jeb, je32_to_cpu(spx->offset) | REF_UNCHECKED,\r\nPAD(je32_to_cpu(spx->totlen)), NULL);\r\nraw->next_in_ino = xd->node->next_in_ino;\r\nxd->node->next_in_ino = raw;\r\n} else {\r\nxd->version = je32_to_cpu(spx->version);\r\nsum_link_node_ref(c, jeb, je32_to_cpu(spx->offset) | REF_UNCHECKED,\r\nPAD(je32_to_cpu(spx->totlen)), (void *)xd);\r\n}\r\n*pseudo_random += je32_to_cpu(spx->xid);\r\nsp += JFFS2_SUMMARY_XATTR_SIZE;\r\nbreak;\r\n}\r\ncase JFFS2_NODETYPE_XREF: {\r\nstruct jffs2_xattr_ref *ref;\r\nstruct jffs2_sum_xref_flash *spr;\r\nspr = (struct jffs2_sum_xref_flash *)sp;\r\ndbg_summary("xref at %#08x-%#08x\n",\r\njeb->offset + je32_to_cpu(spr->offset),\r\njeb->offset + je32_to_cpu(spr->offset) +\r\n(uint32_t)PAD(sizeof(struct jffs2_raw_xref)));\r\nref = jffs2_alloc_xattr_ref();\r\nif (!ref) {\r\nJFFS2_NOTICE("allocation of xattr_datum failed\n");\r\nreturn -ENOMEM;\r\n}\r\nref->next = c->xref_temp;\r\nc->xref_temp = ref;\r\nsum_link_node_ref(c, jeb, je32_to_cpu(spr->offset) | REF_UNCHECKED,\r\nPAD(sizeof(struct jffs2_raw_xref)), (void *)ref);\r\n*pseudo_random += ref->node->flash_offset;\r\nsp += JFFS2_SUMMARY_XREF_SIZE;\r\nbreak;\r\n}\r\n#endif\r\ndefault : {\r\nuint16_t nodetype = je16_to_cpu(((struct jffs2_sum_unknown_flash *)sp)->nodetype);\r\nJFFS2_WARNING("Unsupported node type %x found in summary! Exiting...\n", nodetype);\r\nif ((nodetype & JFFS2_COMPAT_MASK) == JFFS2_FEATURE_INCOMPAT)\r\nreturn -EIO;\r\nc->wasted_size -= jeb->wasted_size;\r\nc->free_size += c->sector_size - jeb->free_size;\r\nc->used_size -= jeb->used_size;\r\nc->dirty_size -= jeb->dirty_size;\r\njeb->wasted_size = jeb->used_size = jeb->dirty_size = 0;\r\njeb->free_size = c->sector_size;\r\njffs2_free_jeb_node_refs(c, jeb);\r\nreturn -ENOTRECOVERABLE;\r\n}\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint jffs2_sum_scan_sumnode(struct jffs2_sb_info *c, struct jffs2_eraseblock *jeb,\r\nstruct jffs2_raw_summary *summary, uint32_t sumsize,\r\nuint32_t *pseudo_random)\r\n{\r\nstruct jffs2_unknown_node crcnode;\r\nint ret, ofs;\r\nuint32_t crc;\r\nofs = c->sector_size - sumsize;\r\ndbg_summary("summary found for 0x%08x at 0x%08x (0x%x bytes)\n",\r\njeb->offset, jeb->offset + ofs, sumsize);\r\ncrcnode.magic = cpu_to_je16(JFFS2_MAGIC_BITMASK);\r\ncrcnode.nodetype = cpu_to_je16(JFFS2_NODETYPE_SUMMARY);\r\ncrcnode.totlen = summary->totlen;\r\ncrc = crc32(0, &crcnode, sizeof(crcnode)-4);\r\nif (je32_to_cpu(summary->hdr_crc) != crc) {\r\ndbg_summary("Summary node header is corrupt (bad CRC or "\r\n"no summary at all)\n");\r\ngoto crc_err;\r\n}\r\nif (je32_to_cpu(summary->totlen) != sumsize) {\r\ndbg_summary("Summary node is corrupt (wrong erasesize?)\n");\r\ngoto crc_err;\r\n}\r\ncrc = crc32(0, summary, sizeof(struct jffs2_raw_summary)-8);\r\nif (je32_to_cpu(summary->node_crc) != crc) {\r\ndbg_summary("Summary node is corrupt (bad CRC)\n");\r\ngoto crc_err;\r\n}\r\ncrc = crc32(0, summary->sum, sumsize - sizeof(struct jffs2_raw_summary));\r\nif (je32_to_cpu(summary->sum_crc) != crc) {\r\ndbg_summary("Summary node data is corrupt (bad CRC)\n");\r\ngoto crc_err;\r\n}\r\nif ( je32_to_cpu(summary->cln_mkr) ) {\r\ndbg_summary("Summary : CLEANMARKER node \n");\r\nret = jffs2_prealloc_raw_node_refs(c, jeb, 1);\r\nif (ret)\r\nreturn ret;\r\nif (je32_to_cpu(summary->cln_mkr) != c->cleanmarker_size) {\r\ndbg_summary("CLEANMARKER node has totlen 0x%x != normal 0x%x\n",\r\nje32_to_cpu(summary->cln_mkr), c->cleanmarker_size);\r\nif ((ret = jffs2_scan_dirty_space(c, jeb, PAD(je32_to_cpu(summary->cln_mkr)))))\r\nreturn ret;\r\n} else if (jeb->first_node) {\r\ndbg_summary("CLEANMARKER node not first node in block "\r\n"(0x%08x)\n", jeb->offset);\r\nif ((ret = jffs2_scan_dirty_space(c, jeb, PAD(je32_to_cpu(summary->cln_mkr)))))\r\nreturn ret;\r\n} else {\r\njffs2_link_node_ref(c, jeb, jeb->offset | REF_NORMAL,\r\nje32_to_cpu(summary->cln_mkr), NULL);\r\n}\r\n}\r\nret = jffs2_sum_process_sum_data(c, jeb, summary, pseudo_random);\r\nif (ret == -ENOTRECOVERABLE)\r\nreturn 0;\r\nif (ret)\r\nreturn ret;\r\nret = jffs2_prealloc_raw_node_refs(c, jeb, 2);\r\nif (ret)\r\nreturn ret;\r\nsum_link_node_ref(c, jeb, ofs | REF_NORMAL, sumsize, NULL);\r\nif (unlikely(jeb->free_size)) {\r\nJFFS2_WARNING("Free size 0x%x bytes in eraseblock @0x%08x with summary?\n",\r\njeb->free_size, jeb->offset);\r\njeb->wasted_size += jeb->free_size;\r\nc->wasted_size += jeb->free_size;\r\nc->free_size -= jeb->free_size;\r\njeb->free_size = 0;\r\n}\r\nreturn jffs2_scan_classify_jeb(c, jeb);\r\ncrc_err:\r\nJFFS2_WARNING("Summary node crc error, skipping summary information.\n");\r\nreturn 0;\r\n}\r\nstatic int jffs2_sum_write_data(struct jffs2_sb_info *c, struct jffs2_eraseblock *jeb,\r\nuint32_t infosize, uint32_t datasize, int padsize)\r\n{\r\nstruct jffs2_raw_summary isum;\r\nunion jffs2_sum_mem *temp;\r\nstruct jffs2_sum_marker *sm;\r\nstruct kvec vecs[2];\r\nuint32_t sum_ofs;\r\nvoid *wpage;\r\nint ret;\r\nsize_t retlen;\r\nif (padsize + datasize > MAX_SUMMARY_SIZE) {\r\njffs2_sum_disable_collecting(c->summary);\r\nJFFS2_WARNING("Summary too big (%d data, %d pad) in eraseblock at %08x\n",\r\ndatasize, padsize, jeb->offset);\r\nreturn 0;\r\n}\r\nif (padsize < 0) {\r\njffs2_sum_disable_collecting(c->summary);\r\nJFFS2_WARNING("Not enough space for summary, padsize = %d\n",\r\npadsize);\r\nreturn 0;\r\n}\r\nmemset(c->summary->sum_buf, 0xff, datasize);\r\nmemset(&isum, 0, sizeof(isum));\r\nisum.magic = cpu_to_je16(JFFS2_MAGIC_BITMASK);\r\nisum.nodetype = cpu_to_je16(JFFS2_NODETYPE_SUMMARY);\r\nisum.totlen = cpu_to_je32(infosize);\r\nisum.hdr_crc = cpu_to_je32(crc32(0, &isum, sizeof(struct jffs2_unknown_node) - 4));\r\nisum.padded = cpu_to_je32(c->summary->sum_padded);\r\nisum.cln_mkr = cpu_to_je32(c->cleanmarker_size);\r\nisum.sum_num = cpu_to_je32(c->summary->sum_num);\r\nwpage = c->summary->sum_buf;\r\nwhile (c->summary->sum_num) {\r\ntemp = c->summary->sum_list_head;\r\nswitch (je16_to_cpu(temp->u.nodetype)) {\r\ncase JFFS2_NODETYPE_INODE: {\r\nstruct jffs2_sum_inode_flash *sino_ptr = wpage;\r\nsino_ptr->nodetype = temp->i.nodetype;\r\nsino_ptr->inode = temp->i.inode;\r\nsino_ptr->version = temp->i.version;\r\nsino_ptr->offset = temp->i.offset;\r\nsino_ptr->totlen = temp->i.totlen;\r\nwpage += JFFS2_SUMMARY_INODE_SIZE;\r\nbreak;\r\n}\r\ncase JFFS2_NODETYPE_DIRENT: {\r\nstruct jffs2_sum_dirent_flash *sdrnt_ptr = wpage;\r\nsdrnt_ptr->nodetype = temp->d.nodetype;\r\nsdrnt_ptr->totlen = temp->d.totlen;\r\nsdrnt_ptr->offset = temp->d.offset;\r\nsdrnt_ptr->pino = temp->d.pino;\r\nsdrnt_ptr->version = temp->d.version;\r\nsdrnt_ptr->ino = temp->d.ino;\r\nsdrnt_ptr->nsize = temp->d.nsize;\r\nsdrnt_ptr->type = temp->d.type;\r\nmemcpy(sdrnt_ptr->name, temp->d.name,\r\ntemp->d.nsize);\r\nwpage += JFFS2_SUMMARY_DIRENT_SIZE(temp->d.nsize);\r\nbreak;\r\n}\r\n#ifdef CONFIG_JFFS2_FS_XATTR\r\ncase JFFS2_NODETYPE_XATTR: {\r\nstruct jffs2_sum_xattr_flash *sxattr_ptr = wpage;\r\ntemp = c->summary->sum_list_head;\r\nsxattr_ptr->nodetype = temp->x.nodetype;\r\nsxattr_ptr->xid = temp->x.xid;\r\nsxattr_ptr->version = temp->x.version;\r\nsxattr_ptr->offset = temp->x.offset;\r\nsxattr_ptr->totlen = temp->x.totlen;\r\nwpage += JFFS2_SUMMARY_XATTR_SIZE;\r\nbreak;\r\n}\r\ncase JFFS2_NODETYPE_XREF: {\r\nstruct jffs2_sum_xref_flash *sxref_ptr = wpage;\r\ntemp = c->summary->sum_list_head;\r\nsxref_ptr->nodetype = temp->r.nodetype;\r\nsxref_ptr->offset = temp->r.offset;\r\nwpage += JFFS2_SUMMARY_XREF_SIZE;\r\nbreak;\r\n}\r\n#endif\r\ndefault : {\r\nif ((je16_to_cpu(temp->u.nodetype) & JFFS2_COMPAT_MASK)\r\n== JFFS2_FEATURE_RWCOMPAT_COPY) {\r\ndbg_summary("Writing unknown RWCOMPAT_COPY node type %x\n",\r\nje16_to_cpu(temp->u.nodetype));\r\njffs2_sum_disable_collecting(c->summary);\r\n} else {\r\nBUG();\r\n}\r\n}\r\n}\r\nc->summary->sum_list_head = temp->u.next;\r\nkfree(temp);\r\nc->summary->sum_num--;\r\n}\r\njffs2_sum_reset_collected(c->summary);\r\nwpage += padsize;\r\nsm = wpage;\r\nsm->offset = cpu_to_je32(c->sector_size - jeb->free_size);\r\nsm->magic = cpu_to_je32(JFFS2_SUM_MAGIC);\r\nisum.sum_crc = cpu_to_je32(crc32(0, c->summary->sum_buf, datasize));\r\nisum.node_crc = cpu_to_je32(crc32(0, &isum, sizeof(isum) - 8));\r\nvecs[0].iov_base = &isum;\r\nvecs[0].iov_len = sizeof(isum);\r\nvecs[1].iov_base = c->summary->sum_buf;\r\nvecs[1].iov_len = datasize;\r\nsum_ofs = jeb->offset + c->sector_size - jeb->free_size;\r\ndbg_summary("writing out data to flash to pos : 0x%08x\n", sum_ofs);\r\nret = jffs2_flash_writev(c, vecs, 2, sum_ofs, &retlen, 0);\r\nif (ret || (retlen != infosize)) {\r\nJFFS2_WARNING("Write of %u bytes at 0x%08x failed. returned %d, retlen %zd\n",\r\ninfosize, sum_ofs, ret, retlen);\r\nif (retlen) {\r\nspin_lock(&c->erase_completion_lock);\r\njffs2_link_node_ref(c, jeb, sum_ofs | REF_OBSOLETE, infosize, NULL);\r\nspin_unlock(&c->erase_completion_lock);\r\n}\r\nc->summary->sum_size = JFFS2_SUMMARY_NOSUM_SIZE;\r\nreturn 0;\r\n}\r\nspin_lock(&c->erase_completion_lock);\r\njffs2_link_node_ref(c, jeb, sum_ofs | REF_NORMAL, infosize, NULL);\r\nspin_unlock(&c->erase_completion_lock);\r\nreturn 0;\r\n}\r\nint jffs2_sum_write_sumnode(struct jffs2_sb_info *c)\r\n{\r\nint datasize, infosize, padsize;\r\nstruct jffs2_eraseblock *jeb;\r\nint ret = 0;\r\ndbg_summary("called\n");\r\nspin_unlock(&c->erase_completion_lock);\r\njeb = c->nextblock;\r\njffs2_prealloc_raw_node_refs(c, jeb, 1);\r\nif (!c->summary->sum_num || !c->summary->sum_list_head) {\r\nJFFS2_WARNING("Empty summary info!!!\n");\r\nBUG();\r\n}\r\ndatasize = c->summary->sum_size + sizeof(struct jffs2_sum_marker);\r\ninfosize = sizeof(struct jffs2_raw_summary) + datasize;\r\npadsize = jeb->free_size - infosize;\r\ninfosize += padsize;\r\ndatasize += padsize;\r\nret = jffs2_sum_write_data(c, jeb, infosize, datasize, padsize);\r\nspin_lock(&c->erase_completion_lock);\r\nreturn ret;\r\n}

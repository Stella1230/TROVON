static int lifebook_limit_serio3(const struct dmi_system_id *d)\r\n{\r\ndesired_serio_phys = "isa0060/serio3";\r\nreturn 1;\r\n}\r\nstatic int lifebook_set_6byte_proto(const struct dmi_system_id *d)\r\n{\r\nlifebook_use_6byte_proto = true;\r\nreturn 1;\r\n}\r\nvoid __init lifebook_module_init(void)\r\n{\r\nlifebook_present = dmi_check_system(lifebook_dmi_table);\r\n}\r\nstatic psmouse_ret_t lifebook_process_byte(struct psmouse *psmouse)\r\n{\r\nstruct lifebook_data *priv = psmouse->private;\r\nstruct input_dev *dev1 = psmouse->dev;\r\nstruct input_dev *dev2 = priv ? priv->dev2 : NULL;\r\nunsigned char *packet = psmouse->packet;\r\nbool relative_packet = packet[0] & 0x08;\r\nif (relative_packet || !lifebook_use_6byte_proto) {\r\nif (psmouse->pktcnt != 3)\r\nreturn PSMOUSE_GOOD_DATA;\r\n} else {\r\nswitch (psmouse->pktcnt) {\r\ncase 1:\r\nreturn (packet[0] & 0xf8) == 0x00 ?\r\nPSMOUSE_GOOD_DATA : PSMOUSE_BAD_DATA;\r\ncase 2:\r\nreturn PSMOUSE_GOOD_DATA;\r\ncase 3:\r\nreturn ((packet[2] & 0x30) << 2) == (packet[2] & 0xc0) ?\r\nPSMOUSE_GOOD_DATA : PSMOUSE_BAD_DATA;\r\ncase 4:\r\nreturn (packet[3] & 0xf8) == 0xc0 ?\r\nPSMOUSE_GOOD_DATA : PSMOUSE_BAD_DATA;\r\ncase 5:\r\nreturn (packet[4] & 0xc0) == (packet[2] & 0xc0) ?\r\nPSMOUSE_GOOD_DATA : PSMOUSE_BAD_DATA;\r\ncase 6:\r\nif (((packet[5] & 0x30) << 2) != (packet[5] & 0xc0))\r\nreturn PSMOUSE_BAD_DATA;\r\nif ((packet[5] & 0xc0) != (packet[1] & 0xc0))\r\nreturn PSMOUSE_BAD_DATA;\r\nbreak;\r\n}\r\n}\r\nif (relative_packet) {\r\nif (!dev2)\r\npsmouse_warn(psmouse,\r\n"got relative packet but no relative device set up\n");\r\n} else {\r\nif (lifebook_use_6byte_proto) {\r\ninput_report_abs(dev1, ABS_X,\r\n((packet[1] & 0x3f) << 6) | (packet[2] & 0x3f));\r\ninput_report_abs(dev1, ABS_Y,\r\n4096 - (((packet[4] & 0x3f) << 6) | (packet[5] & 0x3f)));\r\n} else {\r\ninput_report_abs(dev1, ABS_X,\r\n(packet[1] | ((packet[0] & 0x30) << 4)));\r\ninput_report_abs(dev1, ABS_Y,\r\n1024 - (packet[2] | ((packet[0] & 0xC0) << 2)));\r\n}\r\ninput_report_key(dev1, BTN_TOUCH, packet[0] & 0x04);\r\ninput_sync(dev1);\r\n}\r\nif (dev2) {\r\nif (relative_packet) {\r\ninput_report_rel(dev2, REL_X,\r\n((packet[0] & 0x10) ? packet[1] - 256 : packet[1]));\r\ninput_report_rel(dev2, REL_Y,\r\n-(int)((packet[0] & 0x20) ? packet[2] - 256 : packet[2]));\r\n}\r\ninput_report_key(dev2, BTN_LEFT, packet[0] & 0x01);\r\ninput_report_key(dev2, BTN_RIGHT, packet[0] & 0x02);\r\ninput_sync(dev2);\r\n}\r\nreturn PSMOUSE_FULL_PACKET;\r\n}\r\nstatic int lifebook_absolute_mode(struct psmouse *psmouse)\r\n{\r\nstruct ps2dev *ps2dev = &psmouse->ps2dev;\r\nunsigned char param;\r\nif (psmouse_reset(psmouse))\r\nreturn -1;\r\nparam = lifebook_use_6byte_proto ? 0x08 : 0x07;\r\nps2_command(ps2dev, &param, PSMOUSE_CMD_SETRES);\r\nreturn 0;\r\n}\r\nstatic void lifebook_relative_mode(struct psmouse *psmouse)\r\n{\r\nstruct ps2dev *ps2dev = &psmouse->ps2dev;\r\nunsigned char param = 0x06;\r\nps2_command(ps2dev, &param, PSMOUSE_CMD_SETRES);\r\n}\r\nstatic void lifebook_set_resolution(struct psmouse *psmouse, unsigned int resolution)\r\n{\r\nstatic const unsigned char params[] = { 0, 1, 2, 2, 3 };\r\nunsigned char p;\r\nif (resolution == 0 || resolution > 400)\r\nresolution = 400;\r\np = params[resolution / 100];\r\nps2_command(&psmouse->ps2dev, &p, PSMOUSE_CMD_SETRES);\r\npsmouse->resolution = 50 << p;\r\n}\r\nstatic void lifebook_disconnect(struct psmouse *psmouse)\r\n{\r\nstruct lifebook_data *priv = psmouse->private;\r\npsmouse_reset(psmouse);\r\nif (priv) {\r\ninput_unregister_device(priv->dev2);\r\nkfree(priv);\r\n}\r\npsmouse->private = NULL;\r\n}\r\nint lifebook_detect(struct psmouse *psmouse, bool set_properties)\r\n{\r\nif (!lifebook_present)\r\nreturn -1;\r\nif (desired_serio_phys &&\r\nstrcmp(psmouse->ps2dev.serio->phys, desired_serio_phys))\r\nreturn -1;\r\nif (set_properties) {\r\npsmouse->vendor = "Fujitsu";\r\npsmouse->name = "Lifebook TouchScreen";\r\n}\r\nreturn 0;\r\n}\r\nstatic int lifebook_create_relative_device(struct psmouse *psmouse)\r\n{\r\nstruct input_dev *dev2;\r\nstruct lifebook_data *priv;\r\nint error = -ENOMEM;\r\npriv = kzalloc(sizeof(struct lifebook_data), GFP_KERNEL);\r\ndev2 = input_allocate_device();\r\nif (!priv || !dev2)\r\ngoto err_out;\r\npriv->dev2 = dev2;\r\nsnprintf(priv->phys, sizeof(priv->phys),\r\n"%s/input1", psmouse->ps2dev.serio->phys);\r\ndev2->phys = priv->phys;\r\ndev2->name = "PS/2 Touchpad";\r\ndev2->id.bustype = BUS_I8042;\r\ndev2->id.vendor = 0x0002;\r\ndev2->id.product = PSMOUSE_LIFEBOOK;\r\ndev2->id.version = 0x0000;\r\ndev2->dev.parent = &psmouse->ps2dev.serio->dev;\r\ndev2->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_REL);\r\ndev2->relbit[BIT_WORD(REL_X)] = BIT_MASK(REL_X) | BIT_MASK(REL_Y);\r\ndev2->keybit[BIT_WORD(BTN_LEFT)] =\r\nBIT_MASK(BTN_LEFT) | BIT_MASK(BTN_RIGHT);\r\nerror = input_register_device(priv->dev2);\r\nif (error)\r\ngoto err_out;\r\npsmouse->private = priv;\r\nreturn 0;\r\nerr_out:\r\ninput_free_device(dev2);\r\nkfree(priv);\r\nreturn error;\r\n}\r\nint lifebook_init(struct psmouse *psmouse)\r\n{\r\nstruct input_dev *dev1 = psmouse->dev;\r\nint max_coord = lifebook_use_6byte_proto ? 4096 : 1024;\r\nif (lifebook_absolute_mode(psmouse))\r\nreturn -1;\r\ndev1->evbit[0] = BIT_MASK(EV_ABS) | BIT_MASK(EV_KEY);\r\ndev1->relbit[0] = 0;\r\ndev1->keybit[BIT_WORD(BTN_MOUSE)] = 0;\r\ndev1->keybit[BIT_WORD(BTN_TOUCH)] = BIT_MASK(BTN_TOUCH);\r\ninput_set_abs_params(dev1, ABS_X, 0, max_coord, 0, 0);\r\ninput_set_abs_params(dev1, ABS_Y, 0, max_coord, 0, 0);\r\nif (!desired_serio_phys) {\r\nif (lifebook_create_relative_device(psmouse)) {\r\nlifebook_relative_mode(psmouse);\r\nreturn -1;\r\n}\r\n}\r\npsmouse->protocol_handler = lifebook_process_byte;\r\npsmouse->set_resolution = lifebook_set_resolution;\r\npsmouse->disconnect = lifebook_disconnect;\r\npsmouse->reconnect = lifebook_absolute_mode;\r\npsmouse->model = lifebook_use_6byte_proto ? 6 : 3;\r\npsmouse->pktsize = 3;\r\nreturn 0;\r\n}

static int h4_open(struct hci_uart *hu)\r\n{\r\nstruct h4_struct *h4;\r\nBT_DBG("hu %p", hu);\r\nh4 = kzalloc(sizeof(*h4), GFP_KERNEL);\r\nif (!h4)\r\nreturn -ENOMEM;\r\nskb_queue_head_init(&h4->txq);\r\nhu->priv = h4;\r\nreturn 0;\r\n}\r\nstatic int h4_flush(struct hci_uart *hu)\r\n{\r\nstruct h4_struct *h4 = hu->priv;\r\nBT_DBG("hu %p", hu);\r\nskb_queue_purge(&h4->txq);\r\nreturn 0;\r\n}\r\nstatic int h4_close(struct hci_uart *hu)\r\n{\r\nstruct h4_struct *h4 = hu->priv;\r\nhu->priv = NULL;\r\nBT_DBG("hu %p", hu);\r\nskb_queue_purge(&h4->txq);\r\nkfree_skb(h4->rx_skb);\r\nhu->priv = NULL;\r\nkfree(h4);\r\nreturn 0;\r\n}\r\nstatic int h4_enqueue(struct hci_uart *hu, struct sk_buff *skb)\r\n{\r\nstruct h4_struct *h4 = hu->priv;\r\nBT_DBG("hu %p skb %p", hu, skb);\r\nmemcpy(skb_push(skb, 1), &bt_cb(skb)->pkt_type, 1);\r\nskb_queue_tail(&h4->txq, skb);\r\nreturn 0;\r\n}\r\nstatic inline int h4_check_data_len(struct h4_struct *h4, int len)\r\n{\r\nint room = skb_tailroom(h4->rx_skb);\r\nBT_DBG("len %d room %d", len, room);\r\nif (!len) {\r\nhci_recv_frame(h4->rx_skb);\r\n} else if (len > room) {\r\nBT_ERR("Data length is too large");\r\nkfree_skb(h4->rx_skb);\r\n} else {\r\nh4->rx_state = H4_W4_DATA;\r\nh4->rx_count = len;\r\nreturn len;\r\n}\r\nh4->rx_state = H4_W4_PACKET_TYPE;\r\nh4->rx_skb = NULL;\r\nh4->rx_count = 0;\r\nreturn 0;\r\n}\r\nstatic int h4_recv(struct hci_uart *hu, void *data, int count)\r\n{\r\nint ret;\r\nif (!test_bit(HCI_UART_REGISTERED, &hu->flags))\r\nreturn -EUNATCH;\r\nret = hci_recv_stream_fragment(hu->hdev, data, count);\r\nif (ret < 0) {\r\nBT_ERR("Frame Reassembly Failed");\r\nreturn ret;\r\n}\r\nreturn count;\r\n}\r\nstatic struct sk_buff *h4_dequeue(struct hci_uart *hu)\r\n{\r\nstruct h4_struct *h4 = hu->priv;\r\nreturn skb_dequeue(&h4->txq);\r\n}\r\nint __init h4_init(void)\r\n{\r\nint err = hci_uart_register_proto(&h4p);\r\nif (!err)\r\nBT_INFO("HCI H4 protocol initialized");\r\nelse\r\nBT_ERR("HCI H4 protocol registration failed");\r\nreturn err;\r\n}\r\nint __exit h4_deinit(void)\r\n{\r\nreturn hci_uart_unregister_proto(&h4p);\r\n}

struct inode *nilfs_bmap_get_dat(const struct nilfs_bmap *bmap)\r\n{\r\nstruct the_nilfs *nilfs = bmap->b_inode->i_sb->s_fs_info;\r\nreturn nilfs->ns_dat;\r\n}\r\nstatic int nilfs_bmap_convert_error(struct nilfs_bmap *bmap,\r\nconst char *fname, int err)\r\n{\r\nstruct inode *inode = bmap->b_inode;\r\nif (err == -EINVAL) {\r\nnilfs_error(inode->i_sb, fname,\r\n"broken bmap (inode number=%lu)\n", inode->i_ino);\r\nerr = -EIO;\r\n}\r\nreturn err;\r\n}\r\nint nilfs_bmap_lookup_at_level(struct nilfs_bmap *bmap, __u64 key, int level,\r\n__u64 *ptrp)\r\n{\r\nsector_t blocknr;\r\nint ret;\r\ndown_read(&bmap->b_sem);\r\nret = bmap->b_ops->bop_lookup(bmap, key, level, ptrp);\r\nif (ret < 0) {\r\nret = nilfs_bmap_convert_error(bmap, __func__, ret);\r\ngoto out;\r\n}\r\nif (NILFS_BMAP_USE_VBN(bmap)) {\r\nret = nilfs_dat_translate(nilfs_bmap_get_dat(bmap), *ptrp,\r\n&blocknr);\r\nif (!ret)\r\n*ptrp = blocknr;\r\n}\r\nout:\r\nup_read(&bmap->b_sem);\r\nreturn ret;\r\n}\r\nint nilfs_bmap_lookup_contig(struct nilfs_bmap *bmap, __u64 key, __u64 *ptrp,\r\nunsigned maxblocks)\r\n{\r\nint ret;\r\ndown_read(&bmap->b_sem);\r\nret = bmap->b_ops->bop_lookup_contig(bmap, key, ptrp, maxblocks);\r\nup_read(&bmap->b_sem);\r\nreturn nilfs_bmap_convert_error(bmap, __func__, ret);\r\n}\r\nstatic int nilfs_bmap_do_insert(struct nilfs_bmap *bmap, __u64 key, __u64 ptr)\r\n{\r\n__u64 keys[NILFS_BMAP_SMALL_HIGH + 1];\r\n__u64 ptrs[NILFS_BMAP_SMALL_HIGH + 1];\r\nint ret, n;\r\nif (bmap->b_ops->bop_check_insert != NULL) {\r\nret = bmap->b_ops->bop_check_insert(bmap, key);\r\nif (ret > 0) {\r\nn = bmap->b_ops->bop_gather_data(\r\nbmap, keys, ptrs, NILFS_BMAP_SMALL_HIGH + 1);\r\nif (n < 0)\r\nreturn n;\r\nret = nilfs_btree_convert_and_insert(\r\nbmap, key, ptr, keys, ptrs, n);\r\nif (ret == 0)\r\nbmap->b_u.u_flags |= NILFS_BMAP_LARGE;\r\nreturn ret;\r\n} else if (ret < 0)\r\nreturn ret;\r\n}\r\nreturn bmap->b_ops->bop_insert(bmap, key, ptr);\r\n}\r\nint nilfs_bmap_insert(struct nilfs_bmap *bmap,\r\nunsigned long key,\r\nunsigned long rec)\r\n{\r\nint ret;\r\ndown_write(&bmap->b_sem);\r\nret = nilfs_bmap_do_insert(bmap, key, rec);\r\nup_write(&bmap->b_sem);\r\nreturn nilfs_bmap_convert_error(bmap, __func__, ret);\r\n}\r\nstatic int nilfs_bmap_do_delete(struct nilfs_bmap *bmap, __u64 key)\r\n{\r\n__u64 keys[NILFS_BMAP_LARGE_LOW + 1];\r\n__u64 ptrs[NILFS_BMAP_LARGE_LOW + 1];\r\nint ret, n;\r\nif (bmap->b_ops->bop_check_delete != NULL) {\r\nret = bmap->b_ops->bop_check_delete(bmap, key);\r\nif (ret > 0) {\r\nn = bmap->b_ops->bop_gather_data(\r\nbmap, keys, ptrs, NILFS_BMAP_LARGE_LOW + 1);\r\nif (n < 0)\r\nreturn n;\r\nret = nilfs_direct_delete_and_convert(\r\nbmap, key, keys, ptrs, n);\r\nif (ret == 0)\r\nbmap->b_u.u_flags &= ~NILFS_BMAP_LARGE;\r\nreturn ret;\r\n} else if (ret < 0)\r\nreturn ret;\r\n}\r\nreturn bmap->b_ops->bop_delete(bmap, key);\r\n}\r\nint nilfs_bmap_last_key(struct nilfs_bmap *bmap, unsigned long *key)\r\n{\r\n__u64 lastkey;\r\nint ret;\r\ndown_read(&bmap->b_sem);\r\nret = bmap->b_ops->bop_last_key(bmap, &lastkey);\r\nup_read(&bmap->b_sem);\r\nif (ret < 0)\r\nret = nilfs_bmap_convert_error(bmap, __func__, ret);\r\nelse\r\n*key = lastkey;\r\nreturn ret;\r\n}\r\nint nilfs_bmap_delete(struct nilfs_bmap *bmap, unsigned long key)\r\n{\r\nint ret;\r\ndown_write(&bmap->b_sem);\r\nret = nilfs_bmap_do_delete(bmap, key);\r\nup_write(&bmap->b_sem);\r\nreturn nilfs_bmap_convert_error(bmap, __func__, ret);\r\n}\r\nstatic int nilfs_bmap_do_truncate(struct nilfs_bmap *bmap, unsigned long key)\r\n{\r\n__u64 lastkey;\r\nint ret;\r\nret = bmap->b_ops->bop_last_key(bmap, &lastkey);\r\nif (ret < 0) {\r\nif (ret == -ENOENT)\r\nret = 0;\r\nreturn ret;\r\n}\r\nwhile (key <= lastkey) {\r\nret = nilfs_bmap_do_delete(bmap, lastkey);\r\nif (ret < 0)\r\nreturn ret;\r\nret = bmap->b_ops->bop_last_key(bmap, &lastkey);\r\nif (ret < 0) {\r\nif (ret == -ENOENT)\r\nret = 0;\r\nreturn ret;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint nilfs_bmap_truncate(struct nilfs_bmap *bmap, unsigned long key)\r\n{\r\nint ret;\r\ndown_write(&bmap->b_sem);\r\nret = nilfs_bmap_do_truncate(bmap, key);\r\nup_write(&bmap->b_sem);\r\nreturn nilfs_bmap_convert_error(bmap, __func__, ret);\r\n}\r\nvoid nilfs_bmap_clear(struct nilfs_bmap *bmap)\r\n{\r\ndown_write(&bmap->b_sem);\r\nif (bmap->b_ops->bop_clear != NULL)\r\nbmap->b_ops->bop_clear(bmap);\r\nup_write(&bmap->b_sem);\r\n}\r\nint nilfs_bmap_propagate(struct nilfs_bmap *bmap, struct buffer_head *bh)\r\n{\r\nint ret;\r\ndown_write(&bmap->b_sem);\r\nret = bmap->b_ops->bop_propagate(bmap, bh);\r\nup_write(&bmap->b_sem);\r\nreturn nilfs_bmap_convert_error(bmap, __func__, ret);\r\n}\r\nvoid nilfs_bmap_lookup_dirty_buffers(struct nilfs_bmap *bmap,\r\nstruct list_head *listp)\r\n{\r\nif (bmap->b_ops->bop_lookup_dirty_buffers != NULL)\r\nbmap->b_ops->bop_lookup_dirty_buffers(bmap, listp);\r\n}\r\nint nilfs_bmap_assign(struct nilfs_bmap *bmap,\r\nstruct buffer_head **bh,\r\nunsigned long blocknr,\r\nunion nilfs_binfo *binfo)\r\n{\r\nint ret;\r\ndown_write(&bmap->b_sem);\r\nret = bmap->b_ops->bop_assign(bmap, bh, blocknr, binfo);\r\nup_write(&bmap->b_sem);\r\nreturn nilfs_bmap_convert_error(bmap, __func__, ret);\r\n}\r\nint nilfs_bmap_mark(struct nilfs_bmap *bmap, __u64 key, int level)\r\n{\r\nint ret;\r\nif (bmap->b_ops->bop_mark == NULL)\r\nreturn 0;\r\ndown_write(&bmap->b_sem);\r\nret = bmap->b_ops->bop_mark(bmap, key, level);\r\nup_write(&bmap->b_sem);\r\nreturn nilfs_bmap_convert_error(bmap, __func__, ret);\r\n}\r\nint nilfs_bmap_test_and_clear_dirty(struct nilfs_bmap *bmap)\r\n{\r\nint ret;\r\ndown_write(&bmap->b_sem);\r\nret = nilfs_bmap_dirty(bmap);\r\nnilfs_bmap_clear_dirty(bmap);\r\nup_write(&bmap->b_sem);\r\nreturn ret;\r\n}\r\n__u64 nilfs_bmap_data_get_key(const struct nilfs_bmap *bmap,\r\nconst struct buffer_head *bh)\r\n{\r\nstruct buffer_head *pbh;\r\n__u64 key;\r\nkey = page_index(bh->b_page) << (PAGE_CACHE_SHIFT -\r\nbmap->b_inode->i_blkbits);\r\nfor (pbh = page_buffers(bh->b_page); pbh != bh; pbh = pbh->b_this_page)\r\nkey++;\r\nreturn key;\r\n}\r\n__u64 nilfs_bmap_find_target_seq(const struct nilfs_bmap *bmap, __u64 key)\r\n{\r\n__s64 diff;\r\ndiff = key - bmap->b_last_allocated_key;\r\nif ((nilfs_bmap_keydiff_abs(diff) < NILFS_INODE_BMAP_SIZE) &&\r\n(bmap->b_last_allocated_ptr != NILFS_BMAP_INVALID_PTR) &&\r\n(bmap->b_last_allocated_ptr + diff > 0))\r\nreturn bmap->b_last_allocated_ptr + diff;\r\nelse\r\nreturn NILFS_BMAP_INVALID_PTR;\r\n}\r\n__u64 nilfs_bmap_find_target_in_group(const struct nilfs_bmap *bmap)\r\n{\r\nstruct inode *dat = nilfs_bmap_get_dat(bmap);\r\nunsigned long entries_per_group = nilfs_palloc_entries_per_group(dat);\r\nunsigned long group = bmap->b_inode->i_ino / entries_per_group;\r\nreturn group * entries_per_group +\r\n(bmap->b_inode->i_ino % NILFS_BMAP_GROUP_DIV) *\r\n(entries_per_group / NILFS_BMAP_GROUP_DIV);\r\n}\r\nint nilfs_bmap_read(struct nilfs_bmap *bmap, struct nilfs_inode *raw_inode)\r\n{\r\nif (raw_inode == NULL)\r\nmemset(bmap->b_u.u_data, 0, NILFS_BMAP_SIZE);\r\nelse\r\nmemcpy(bmap->b_u.u_data, raw_inode->i_bmap, NILFS_BMAP_SIZE);\r\ninit_rwsem(&bmap->b_sem);\r\nbmap->b_state = 0;\r\nbmap->b_inode = &NILFS_BMAP_I(bmap)->vfs_inode;\r\nswitch (bmap->b_inode->i_ino) {\r\ncase NILFS_DAT_INO:\r\nbmap->b_ptr_type = NILFS_BMAP_PTR_P;\r\nbmap->b_last_allocated_key = 0;\r\nbmap->b_last_allocated_ptr = NILFS_BMAP_NEW_PTR_INIT;\r\nlockdep_set_class(&bmap->b_sem, &nilfs_bmap_dat_lock_key);\r\nbreak;\r\ncase NILFS_CPFILE_INO:\r\ncase NILFS_SUFILE_INO:\r\nbmap->b_ptr_type = NILFS_BMAP_PTR_VS;\r\nbmap->b_last_allocated_key = 0;\r\nbmap->b_last_allocated_ptr = NILFS_BMAP_INVALID_PTR;\r\nlockdep_set_class(&bmap->b_sem, &nilfs_bmap_mdt_lock_key);\r\nbreak;\r\ncase NILFS_IFILE_INO:\r\nlockdep_set_class(&bmap->b_sem, &nilfs_bmap_mdt_lock_key);\r\ndefault:\r\nbmap->b_ptr_type = NILFS_BMAP_PTR_VM;\r\nbmap->b_last_allocated_key = 0;\r\nbmap->b_last_allocated_ptr = NILFS_BMAP_INVALID_PTR;\r\nbreak;\r\n}\r\nreturn (bmap->b_u.u_flags & NILFS_BMAP_LARGE) ?\r\nnilfs_btree_init(bmap) : nilfs_direct_init(bmap);\r\n}\r\nvoid nilfs_bmap_write(struct nilfs_bmap *bmap, struct nilfs_inode *raw_inode)\r\n{\r\ndown_write(&bmap->b_sem);\r\nmemcpy(raw_inode->i_bmap, bmap->b_u.u_data,\r\nNILFS_INODE_BMAP_SIZE * sizeof(__le64));\r\nif (bmap->b_inode->i_ino == NILFS_DAT_INO)\r\nbmap->b_last_allocated_ptr = NILFS_BMAP_NEW_PTR_INIT;\r\nup_write(&bmap->b_sem);\r\n}\r\nvoid nilfs_bmap_init_gc(struct nilfs_bmap *bmap)\r\n{\r\nmemset(&bmap->b_u, 0, NILFS_BMAP_SIZE);\r\ninit_rwsem(&bmap->b_sem);\r\nbmap->b_inode = &NILFS_BMAP_I(bmap)->vfs_inode;\r\nbmap->b_ptr_type = NILFS_BMAP_PTR_U;\r\nbmap->b_last_allocated_key = 0;\r\nbmap->b_last_allocated_ptr = NILFS_BMAP_INVALID_PTR;\r\nbmap->b_state = 0;\r\nnilfs_btree_init_gc(bmap);\r\n}\r\nvoid nilfs_bmap_save(const struct nilfs_bmap *bmap,\r\nstruct nilfs_bmap_store *store)\r\n{\r\nmemcpy(store->data, bmap->b_u.u_data, sizeof(store->data));\r\nstore->last_allocated_key = bmap->b_last_allocated_key;\r\nstore->last_allocated_ptr = bmap->b_last_allocated_ptr;\r\nstore->state = bmap->b_state;\r\n}\r\nvoid nilfs_bmap_restore(struct nilfs_bmap *bmap,\r\nconst struct nilfs_bmap_store *store)\r\n{\r\nmemcpy(bmap->b_u.u_data, store->data, sizeof(store->data));\r\nbmap->b_last_allocated_key = store->last_allocated_key;\r\nbmap->b_last_allocated_ptr = store->last_allocated_ptr;\r\nbmap->b_state = store->state;\r\n}

static int fsa9480_write_reg(struct i2c_client *client,\r\nint reg, int value)\r\n{\r\nint ret;\r\nret = i2c_smbus_write_byte_data(client, reg, value);\r\nif (ret < 0)\r\ndev_err(&client->dev, "%s: err %d\n", __func__, ret);\r\nreturn ret;\r\n}\r\nstatic int fsa9480_read_reg(struct i2c_client *client, int reg)\r\n{\r\nint ret;\r\nret = i2c_smbus_read_byte_data(client, reg);\r\nif (ret < 0)\r\ndev_err(&client->dev, "%s: err %d\n", __func__, ret);\r\nreturn ret;\r\n}\r\nstatic int fsa9480_read_irq(struct i2c_client *client, int *value)\r\n{\r\nint ret;\r\nret = i2c_smbus_read_i2c_block_data(client,\r\nFSA9480_REG_INT1, 2, (u8 *)value);\r\n*value &= 0xffff;\r\nif (ret < 0)\r\ndev_err(&client->dev, "%s: err %d\n", __func__, ret);\r\nreturn ret;\r\n}\r\nstatic void fsa9480_set_switch(const char *buf)\r\n{\r\nstruct fsa9480_usbsw *usbsw = chip;\r\nstruct i2c_client *client = usbsw->client;\r\nunsigned int value;\r\nunsigned int path = 0;\r\nvalue = fsa9480_read_reg(client, FSA9480_REG_CTRL);\r\nif (!strncmp(buf, "VAUDIO", 6)) {\r\npath = SW_VAUDIO;\r\nvalue &= ~CON_MANUAL_SW;\r\n} else if (!strncmp(buf, "UART", 4)) {\r\npath = SW_UART;\r\nvalue &= ~CON_MANUAL_SW;\r\n} else if (!strncmp(buf, "AUDIO", 5)) {\r\npath = SW_AUDIO;\r\nvalue &= ~CON_MANUAL_SW;\r\n} else if (!strncmp(buf, "DHOST", 5)) {\r\npath = SW_DHOST;\r\nvalue &= ~CON_MANUAL_SW;\r\n} else if (!strncmp(buf, "AUTO", 4)) {\r\npath = SW_AUTO;\r\nvalue |= CON_MANUAL_SW;\r\n} else {\r\nprintk(KERN_ERR "Wrong command\n");\r\nreturn;\r\n}\r\nusbsw->mansw = path;\r\nfsa9480_write_reg(client, FSA9480_REG_MANSW1, path);\r\nfsa9480_write_reg(client, FSA9480_REG_CTRL, value);\r\n}\r\nstatic ssize_t fsa9480_get_switch(char *buf)\r\n{\r\nstruct fsa9480_usbsw *usbsw = chip;\r\nstruct i2c_client *client = usbsw->client;\r\nunsigned int value;\r\nvalue = fsa9480_read_reg(client, FSA9480_REG_MANSW1);\r\nif (value == SW_VAUDIO)\r\nreturn sprintf(buf, "VAUDIO\n");\r\nelse if (value == SW_UART)\r\nreturn sprintf(buf, "UART\n");\r\nelse if (value == SW_AUDIO)\r\nreturn sprintf(buf, "AUDIO\n");\r\nelse if (value == SW_DHOST)\r\nreturn sprintf(buf, "DHOST\n");\r\nelse if (value == SW_AUTO)\r\nreturn sprintf(buf, "AUTO\n");\r\nelse\r\nreturn sprintf(buf, "%x", value);\r\n}\r\nstatic ssize_t fsa9480_show_device(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct fsa9480_usbsw *usbsw = dev_get_drvdata(dev);\r\nstruct i2c_client *client = usbsw->client;\r\nint dev1, dev2;\r\ndev1 = fsa9480_read_reg(client, FSA9480_REG_DEV_T1);\r\ndev2 = fsa9480_read_reg(client, FSA9480_REG_DEV_T2);\r\nif (!dev1 && !dev2)\r\nreturn sprintf(buf, "NONE\n");\r\nif (dev1 & DEV_T1_USB_MASK || dev2 & DEV_T2_USB_MASK)\r\nreturn sprintf(buf, "USB\n");\r\nif (dev1 & DEV_T1_UART_MASK || dev2 & DEV_T2_UART_MASK)\r\nreturn sprintf(buf, "UART\n");\r\nif (dev1 & DEV_T1_CHARGER_MASK)\r\nreturn sprintf(buf, "CHARGER\n");\r\nif (dev2 & DEV_T2_JIG_MASK)\r\nreturn sprintf(buf, "JIG\n");\r\nreturn sprintf(buf, "UNKNOWN\n");\r\n}\r\nstatic ssize_t fsa9480_show_manualsw(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn fsa9480_get_switch(buf);\r\n}\r\nstatic ssize_t fsa9480_set_manualsw(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nfsa9480_set_switch(buf);\r\nreturn count;\r\n}\r\nstatic void fsa9480_detect_dev(struct fsa9480_usbsw *usbsw, int intr)\r\n{\r\nint val1, val2, ctrl;\r\nstruct fsa9480_platform_data *pdata = usbsw->pdata;\r\nstruct i2c_client *client = usbsw->client;\r\nval1 = fsa9480_read_reg(client, FSA9480_REG_DEV_T1);\r\nval2 = fsa9480_read_reg(client, FSA9480_REG_DEV_T2);\r\nctrl = fsa9480_read_reg(client, FSA9480_REG_CTRL);\r\ndev_info(&client->dev, "intr: 0x%x, dev1: 0x%x, dev2: 0x%x\n",\r\nintr, val1, val2);\r\nif (!intr)\r\ngoto out;\r\nif (intr & INT_ATTACH) {\r\nif (val1 & DEV_T1_USB_MASK || val2 & DEV_T2_USB_MASK) {\r\nif (pdata->usb_cb)\r\npdata->usb_cb(FSA9480_ATTACHED);\r\nif (usbsw->mansw) {\r\nfsa9480_write_reg(client,\r\nFSA9480_REG_MANSW1, usbsw->mansw);\r\n}\r\n}\r\nif (val1 & DEV_T1_UART_MASK || val2 & DEV_T2_UART_MASK) {\r\nif (pdata->uart_cb)\r\npdata->uart_cb(FSA9480_ATTACHED);\r\nif (!(ctrl & CON_MANUAL_SW)) {\r\nfsa9480_write_reg(client,\r\nFSA9480_REG_MANSW1, SW_UART);\r\n}\r\n}\r\nif (val1 & DEV_T1_CHARGER_MASK) {\r\nif (pdata->charger_cb)\r\npdata->charger_cb(FSA9480_ATTACHED);\r\n}\r\nif (val2 & DEV_T2_JIG_MASK) {\r\nif (pdata->jig_cb)\r\npdata->jig_cb(FSA9480_ATTACHED);\r\n}\r\n} else if (intr & INT_DETACH) {\r\nif (usbsw->dev1 & DEV_T1_USB_MASK ||\r\nusbsw->dev2 & DEV_T2_USB_MASK) {\r\nif (pdata->usb_cb)\r\npdata->usb_cb(FSA9480_DETACHED);\r\n}\r\nif (usbsw->dev1 & DEV_T1_UART_MASK ||\r\nusbsw->dev2 & DEV_T2_UART_MASK) {\r\nif (pdata->uart_cb)\r\npdata->uart_cb(FSA9480_DETACHED);\r\n}\r\nif (usbsw->dev1 & DEV_T1_CHARGER_MASK) {\r\nif (pdata->charger_cb)\r\npdata->charger_cb(FSA9480_DETACHED);\r\n}\r\nif (usbsw->dev2 & DEV_T2_JIG_MASK) {\r\nif (pdata->jig_cb)\r\npdata->jig_cb(FSA9480_DETACHED);\r\n}\r\n}\r\nusbsw->dev1 = val1;\r\nusbsw->dev2 = val2;\r\nout:\r\nctrl &= ~CON_INT_MASK;\r\nfsa9480_write_reg(client, FSA9480_REG_CTRL, ctrl);\r\n}\r\nstatic irqreturn_t fsa9480_irq_handler(int irq, void *data)\r\n{\r\nstruct fsa9480_usbsw *usbsw = data;\r\nstruct i2c_client *client = usbsw->client;\r\nint intr;\r\nfsa9480_read_irq(client, &intr);\r\nfsa9480_detect_dev(usbsw, intr);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int fsa9480_irq_init(struct fsa9480_usbsw *usbsw)\r\n{\r\nstruct fsa9480_platform_data *pdata = usbsw->pdata;\r\nstruct i2c_client *client = usbsw->client;\r\nint ret;\r\nint intr;\r\nunsigned int ctrl = CON_MASK;\r\nfsa9480_read_irq(client, &intr);\r\nfsa9480_write_reg(client, FSA9480_REG_INT1_MASK, 0xfc);\r\nfsa9480_write_reg(client, FSA9480_REG_INT2_MASK, 0x1f);\r\nusbsw->mansw = fsa9480_read_reg(client, FSA9480_REG_MANSW1);\r\nif (usbsw->mansw)\r\nctrl &= ~CON_MANUAL_SW;\r\nfsa9480_write_reg(client, FSA9480_REG_CTRL, ctrl);\r\nif (pdata && pdata->cfg_gpio)\r\npdata->cfg_gpio();\r\nif (client->irq) {\r\nret = request_threaded_irq(client->irq, NULL,\r\nfsa9480_irq_handler,\r\nIRQF_TRIGGER_FALLING | IRQF_ONESHOT,\r\n"fsa9480 micro USB", usbsw);\r\nif (ret) {\r\ndev_err(&client->dev, "failed to reqeust IRQ\n");\r\nreturn ret;\r\n}\r\nif (pdata)\r\ndevice_init_wakeup(&client->dev, pdata->wakeup);\r\n}\r\nreturn 0;\r\n}\r\nstatic int fsa9480_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct i2c_adapter *adapter = to_i2c_adapter(client->dev.parent);\r\nstruct fsa9480_usbsw *usbsw;\r\nint ret = 0;\r\nif (!i2c_check_functionality(adapter, I2C_FUNC_SMBUS_BYTE_DATA))\r\nreturn -EIO;\r\nusbsw = kzalloc(sizeof(struct fsa9480_usbsw), GFP_KERNEL);\r\nif (!usbsw) {\r\ndev_err(&client->dev, "failed to allocate driver data\n");\r\nreturn -ENOMEM;\r\n}\r\nusbsw->client = client;\r\nusbsw->pdata = client->dev.platform_data;\r\nchip = usbsw;\r\ni2c_set_clientdata(client, usbsw);\r\nret = fsa9480_irq_init(usbsw);\r\nif (ret)\r\ngoto fail1;\r\nret = sysfs_create_group(&client->dev.kobj, &fsa9480_group);\r\nif (ret) {\r\ndev_err(&client->dev,\r\n"failed to create fsa9480 attribute group\n");\r\ngoto fail2;\r\n}\r\nfsa9480_write_reg(client, FSA9480_REG_TIMING1, 0x6);\r\nif (chip->pdata->reset_cb)\r\nchip->pdata->reset_cb();\r\nfsa9480_detect_dev(usbsw, INT_ATTACH);\r\npm_runtime_set_active(&client->dev);\r\nreturn 0;\r\nfail2:\r\nif (client->irq)\r\nfree_irq(client->irq, usbsw);\r\nfail1:\r\nkfree(usbsw);\r\nreturn ret;\r\n}\r\nstatic int fsa9480_remove(struct i2c_client *client)\r\n{\r\nstruct fsa9480_usbsw *usbsw = i2c_get_clientdata(client);\r\nif (client->irq)\r\nfree_irq(client->irq, usbsw);\r\nsysfs_remove_group(&client->dev.kobj, &fsa9480_group);\r\ndevice_init_wakeup(&client->dev, 0);\r\nkfree(usbsw);\r\nreturn 0;\r\n}\r\nstatic int fsa9480_suspend(struct device *dev)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct fsa9480_usbsw *usbsw = i2c_get_clientdata(client);\r\nstruct fsa9480_platform_data *pdata = usbsw->pdata;\r\nif (device_may_wakeup(&client->dev) && client->irq)\r\nenable_irq_wake(client->irq);\r\nif (pdata->usb_power)\r\npdata->usb_power(0);\r\nreturn 0;\r\n}\r\nstatic int fsa9480_resume(struct device *dev)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct fsa9480_usbsw *usbsw = i2c_get_clientdata(client);\r\nint dev1, dev2;\r\nif (device_may_wakeup(&client->dev) && client->irq)\r\ndisable_irq_wake(client->irq);\r\nfsa9480_read_reg(client, FSA9480_REG_INT1);\r\nfsa9480_read_reg(client, FSA9480_REG_INT2);\r\ndev1 = fsa9480_read_reg(client, FSA9480_REG_DEV_T1);\r\ndev2 = fsa9480_read_reg(client, FSA9480_REG_DEV_T2);\r\nfsa9480_detect_dev(usbsw, (dev1 || dev2) ? INT_ATTACH : INT_DETACH);\r\nreturn 0;\r\n}

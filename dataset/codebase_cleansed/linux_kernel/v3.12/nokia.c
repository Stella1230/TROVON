static int __init nokia_bind_config(struct usb_configuration *c)\r\n{\r\nstruct usb_function *f_acm;\r\nstruct usb_function *f_phonet = NULL;\r\nstruct usb_function *f_obex1 = NULL;\r\nstruct usb_function *f_ecm;\r\nstruct usb_function *f_obex2 = NULL;\r\nint status = 0;\r\nint obex1_stat = 0;\r\nint obex2_stat = 0;\r\nint phonet_stat = 0;\r\nif (!IS_ERR(fi_phonet)) {\r\nf_phonet = usb_get_function(fi_phonet);\r\nif (IS_ERR(f_phonet))\r\npr_debug("could not get phonet function\n");\r\n}\r\nif (!IS_ERR(fi_obex1)) {\r\nf_obex1 = usb_get_function(fi_obex1);\r\nif (IS_ERR(f_obex1))\r\npr_debug("could not get obex function 0\n");\r\n}\r\nif (!IS_ERR(fi_obex2)) {\r\nf_obex2 = usb_get_function(fi_obex2);\r\nif (IS_ERR(f_obex2))\r\npr_debug("could not get obex function 1\n");\r\n}\r\nf_acm = usb_get_function(fi_acm);\r\nif (IS_ERR(f_acm)) {\r\nstatus = PTR_ERR(f_acm);\r\ngoto err_get_acm;\r\n}\r\nf_ecm = usb_get_function(fi_ecm);\r\nif (IS_ERR(f_ecm)) {\r\nstatus = PTR_ERR(f_ecm);\r\ngoto err_get_ecm;\r\n}\r\nif (!IS_ERR_OR_NULL(f_phonet)) {\r\nphonet_stat = usb_add_function(c, f_phonet);\r\nif (phonet_stat)\r\npr_debug("could not add phonet function\n");\r\n}\r\nif (!IS_ERR_OR_NULL(f_obex1)) {\r\nobex1_stat = usb_add_function(c, f_obex1);\r\nif (obex1_stat)\r\npr_debug("could not add obex function 0\n");\r\n}\r\nif (!IS_ERR_OR_NULL(f_obex2)) {\r\nobex2_stat = usb_add_function(c, f_obex2);\r\nif (obex2_stat)\r\npr_debug("could not add obex function 1\n");\r\n}\r\nstatus = usb_add_function(c, f_acm);\r\nif (status)\r\ngoto err_conf;\r\nstatus = usb_add_function(c, f_ecm);\r\nif (status) {\r\npr_debug("could not bind ecm config %d\n", status);\r\ngoto err_ecm;\r\n}\r\nif (c == &nokia_config_500ma_driver) {\r\nf_acm_cfg1 = f_acm;\r\nf_ecm_cfg1 = f_ecm;\r\nf_phonet_cfg1 = f_phonet;\r\nf_obex1_cfg1 = f_obex1;\r\nf_obex2_cfg1 = f_obex2;\r\n} else {\r\nf_acm_cfg2 = f_acm;\r\nf_ecm_cfg2 = f_ecm;\r\nf_phonet_cfg2 = f_phonet;\r\nf_obex1_cfg2 = f_obex1;\r\nf_obex2_cfg2 = f_obex2;\r\n}\r\nreturn status;\r\nerr_ecm:\r\nusb_remove_function(c, f_acm);\r\nerr_conf:\r\nif (!obex2_stat)\r\nusb_remove_function(c, f_obex2);\r\nif (!obex1_stat)\r\nusb_remove_function(c, f_obex1);\r\nif (!phonet_stat)\r\nusb_remove_function(c, f_phonet);\r\nusb_put_function(f_ecm);\r\nerr_get_ecm:\r\nusb_put_function(f_acm);\r\nerr_get_acm:\r\nif (!IS_ERR_OR_NULL(f_obex2))\r\nusb_put_function(f_obex2);\r\nif (!IS_ERR_OR_NULL(f_obex1))\r\nusb_put_function(f_obex1);\r\nif (!IS_ERR_OR_NULL(f_phonet))\r\nusb_put_function(f_phonet);\r\nreturn status;\r\n}\r\nstatic int __init nokia_bind(struct usb_composite_dev *cdev)\r\n{\r\nstruct usb_gadget *gadget = cdev->gadget;\r\nint status;\r\nstatus = usb_string_ids_tab(cdev, strings_dev);\r\nif (status < 0)\r\ngoto err_usb;\r\ndevice_desc.iManufacturer = strings_dev[USB_GADGET_MANUFACTURER_IDX].id;\r\ndevice_desc.iProduct = strings_dev[USB_GADGET_PRODUCT_IDX].id;\r\nstatus = strings_dev[STRING_DESCRIPTION_IDX].id;\r\nnokia_config_500ma_driver.iConfiguration = status;\r\nnokia_config_100ma_driver.iConfiguration = status;\r\nif (!gadget_supports_altsettings(gadget)) {\r\nstatus = -ENODEV;\r\ngoto err_usb;\r\n}\r\nfi_phonet = usb_get_function_instance("phonet");\r\nif (IS_ERR(fi_phonet))\r\npr_debug("could not find phonet function\n");\r\nfi_obex1 = usb_get_function_instance("obex");\r\nif (IS_ERR(fi_obex1))\r\npr_debug("could not find obex function 1\n");\r\nfi_obex2 = usb_get_function_instance("obex");\r\nif (IS_ERR(fi_obex2))\r\npr_debug("could not find obex function 2\n");\r\nfi_acm = usb_get_function_instance("acm");\r\nif (IS_ERR(fi_acm)) {\r\nstatus = PTR_ERR(fi_acm);\r\ngoto err_obex2_inst;\r\n}\r\nfi_ecm = usb_get_function_instance("ecm");\r\nif (IS_ERR(fi_ecm)) {\r\nstatus = PTR_ERR(fi_ecm);\r\ngoto err_acm_inst;\r\n}\r\nstatus = usb_add_config(cdev, &nokia_config_500ma_driver,\r\nnokia_bind_config);\r\nif (status < 0)\r\ngoto err_ecm_inst;\r\nstatus = usb_add_config(cdev, &nokia_config_100ma_driver,\r\nnokia_bind_config);\r\nif (status < 0)\r\ngoto err_put_cfg1;\r\nusb_composite_overwrite_options(cdev, &coverwrite);\r\ndev_info(&gadget->dev, "%s\n", NOKIA_LONG_NAME);\r\nreturn 0;\r\nerr_put_cfg1:\r\nusb_put_function(f_acm_cfg1);\r\nif (!IS_ERR_OR_NULL(f_obex1_cfg1))\r\nusb_put_function(f_obex1_cfg1);\r\nif (!IS_ERR_OR_NULL(f_obex2_cfg1))\r\nusb_put_function(f_obex2_cfg1);\r\nif (!IS_ERR_OR_NULL(f_phonet_cfg1))\r\nusb_put_function(f_phonet_cfg1);\r\nusb_put_function(f_ecm_cfg1);\r\nerr_ecm_inst:\r\nusb_put_function_instance(fi_ecm);\r\nerr_acm_inst:\r\nusb_put_function_instance(fi_acm);\r\nerr_obex2_inst:\r\nif (!IS_ERR(fi_obex2))\r\nusb_put_function_instance(fi_obex2);\r\nif (!IS_ERR(fi_obex1))\r\nusb_put_function_instance(fi_obex1);\r\nif (!IS_ERR(fi_phonet))\r\nusb_put_function_instance(fi_phonet);\r\nerr_usb:\r\nreturn status;\r\n}\r\nstatic int __exit nokia_unbind(struct usb_composite_dev *cdev)\r\n{\r\nif (!IS_ERR_OR_NULL(f_obex1_cfg2))\r\nusb_put_function(f_obex1_cfg2);\r\nif (!IS_ERR_OR_NULL(f_obex2_cfg2))\r\nusb_put_function(f_obex2_cfg2);\r\nif (!IS_ERR_OR_NULL(f_obex1_cfg1))\r\nusb_put_function(f_obex1_cfg1);\r\nif (!IS_ERR_OR_NULL(f_obex2_cfg1))\r\nusb_put_function(f_obex2_cfg1);\r\nif (!IS_ERR_OR_NULL(f_phonet_cfg1))\r\nusb_put_function(f_phonet_cfg1);\r\nif (!IS_ERR_OR_NULL(f_phonet_cfg2))\r\nusb_put_function(f_phonet_cfg2);\r\nusb_put_function(f_acm_cfg1);\r\nusb_put_function(f_acm_cfg2);\r\nusb_put_function(f_ecm_cfg1);\r\nusb_put_function(f_ecm_cfg2);\r\nusb_put_function_instance(fi_ecm);\r\nif (!IS_ERR(fi_obex2))\r\nusb_put_function_instance(fi_obex2);\r\nif (!IS_ERR(fi_obex1))\r\nusb_put_function_instance(fi_obex1);\r\nif (!IS_ERR(fi_phonet))\r\nusb_put_function_instance(fi_phonet);\r\nusb_put_function_instance(fi_acm);\r\nreturn 0;\r\n}\r\nstatic int __init nokia_init(void)\r\n{\r\nreturn usb_composite_probe(&nokia_driver);\r\n}\r\nstatic void __exit nokia_cleanup(void)\r\n{\r\nusb_composite_unregister(&nokia_driver);\r\n}

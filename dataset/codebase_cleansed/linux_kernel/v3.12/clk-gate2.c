static int clk_gate2_enable(struct clk_hw *hw)\r\n{\r\nstruct clk_gate *gate = to_clk_gate(hw);\r\nu32 reg;\r\nunsigned long flags = 0;\r\nif (gate->lock)\r\nspin_lock_irqsave(gate->lock, flags);\r\nreg = readl(gate->reg);\r\nreg |= 3 << gate->bit_idx;\r\nwritel(reg, gate->reg);\r\nif (gate->lock)\r\nspin_unlock_irqrestore(gate->lock, flags);\r\nreturn 0;\r\n}\r\nstatic void clk_gate2_disable(struct clk_hw *hw)\r\n{\r\nstruct clk_gate *gate = to_clk_gate(hw);\r\nu32 reg;\r\nunsigned long flags = 0;\r\nif (gate->lock)\r\nspin_lock_irqsave(gate->lock, flags);\r\nreg = readl(gate->reg);\r\nreg &= ~(3 << gate->bit_idx);\r\nwritel(reg, gate->reg);\r\nif (gate->lock)\r\nspin_unlock_irqrestore(gate->lock, flags);\r\n}\r\nstatic int clk_gate2_is_enabled(struct clk_hw *hw)\r\n{\r\nu32 reg;\r\nstruct clk_gate *gate = to_clk_gate(hw);\r\nreg = readl(gate->reg);\r\nif (((reg >> gate->bit_idx) & 3) == 3)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstruct clk *clk_register_gate2(struct device *dev, const char *name,\r\nconst char *parent_name, unsigned long flags,\r\nvoid __iomem *reg, u8 bit_idx,\r\nu8 clk_gate2_flags, spinlock_t *lock)\r\n{\r\nstruct clk_gate *gate;\r\nstruct clk *clk;\r\nstruct clk_init_data init;\r\ngate = kzalloc(sizeof(struct clk_gate), GFP_KERNEL);\r\nif (!gate)\r\nreturn ERR_PTR(-ENOMEM);\r\ngate->reg = reg;\r\ngate->bit_idx = bit_idx;\r\ngate->flags = clk_gate2_flags;\r\ngate->lock = lock;\r\ninit.name = name;\r\ninit.ops = &clk_gate2_ops;\r\ninit.flags = flags;\r\ninit.parent_names = parent_name ? &parent_name : NULL;\r\ninit.num_parents = parent_name ? 1 : 0;\r\ngate->hw.init = &init;\r\nclk = clk_register(dev, &gate->hw);\r\nif (IS_ERR(clk))\r\nkfree(gate);\r\nreturn clk;\r\n}

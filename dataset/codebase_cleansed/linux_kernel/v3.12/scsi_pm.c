static int scsi_dev_type_suspend(struct device *dev, int (*cb)(struct device *))\r\n{\r\nint err;\r\nerr = scsi_device_quiesce(to_scsi_device(dev));\r\nif (err == 0) {\r\nif (cb) {\r\nerr = cb(dev);\r\nif (err)\r\nscsi_device_resume(to_scsi_device(dev));\r\n}\r\n}\r\ndev_dbg(dev, "scsi suspend: %d\n", err);\r\nreturn err;\r\n}\r\nstatic int scsi_dev_type_resume(struct device *dev, int (*cb)(struct device *))\r\n{\r\nint err = 0;\r\nif (cb)\r\nerr = cb(dev);\r\nscsi_device_resume(to_scsi_device(dev));\r\ndev_dbg(dev, "scsi resume: %d\n", err);\r\nreturn err;\r\n}\r\nstatic int\r\nscsi_bus_suspend_common(struct device *dev, int (*cb)(struct device *))\r\n{\r\nint err = 0;\r\nif (scsi_is_sdev_device(dev)) {\r\nif (pm_runtime_suspended(dev))\r\nreturn 0;\r\nerr = scsi_dev_type_suspend(dev, cb);\r\n}\r\nreturn err;\r\n}\r\nstatic int\r\nscsi_bus_resume_common(struct device *dev, int (*cb)(struct device *))\r\n{\r\nint err = 0;\r\nif (scsi_is_sdev_device(dev))\r\nerr = scsi_dev_type_resume(dev, cb);\r\nif (err == 0) {\r\npm_runtime_disable(dev);\r\npm_runtime_set_active(dev);\r\npm_runtime_enable(dev);\r\n}\r\nreturn err;\r\n}\r\nstatic int scsi_bus_prepare(struct device *dev)\r\n{\r\nif (scsi_is_sdev_device(dev)) {\r\nasync_synchronize_full_domain(&scsi_sd_probe_domain);\r\n} else if (scsi_is_host_device(dev)) {\r\nscsi_complete_async_scans();\r\n}\r\nreturn 0;\r\n}\r\nstatic int scsi_bus_suspend(struct device *dev)\r\n{\r\nconst struct dev_pm_ops *pm = dev->driver ? dev->driver->pm : NULL;\r\nreturn scsi_bus_suspend_common(dev, pm ? pm->suspend : NULL);\r\n}\r\nstatic int scsi_bus_resume(struct device *dev)\r\n{\r\nconst struct dev_pm_ops *pm = dev->driver ? dev->driver->pm : NULL;\r\nreturn scsi_bus_resume_common(dev, pm ? pm->resume : NULL);\r\n}\r\nstatic int scsi_bus_freeze(struct device *dev)\r\n{\r\nconst struct dev_pm_ops *pm = dev->driver ? dev->driver->pm : NULL;\r\nreturn scsi_bus_suspend_common(dev, pm ? pm->freeze : NULL);\r\n}\r\nstatic int scsi_bus_thaw(struct device *dev)\r\n{\r\nconst struct dev_pm_ops *pm = dev->driver ? dev->driver->pm : NULL;\r\nreturn scsi_bus_resume_common(dev, pm ? pm->thaw : NULL);\r\n}\r\nstatic int scsi_bus_poweroff(struct device *dev)\r\n{\r\nconst struct dev_pm_ops *pm = dev->driver ? dev->driver->pm : NULL;\r\nreturn scsi_bus_suspend_common(dev, pm ? pm->poweroff : NULL);\r\n}\r\nstatic int scsi_bus_restore(struct device *dev)\r\n{\r\nconst struct dev_pm_ops *pm = dev->driver ? dev->driver->pm : NULL;\r\nreturn scsi_bus_resume_common(dev, pm ? pm->restore : NULL);\r\n}\r\nstatic int sdev_blk_runtime_suspend(struct scsi_device *sdev,\r\nint (*cb)(struct device *))\r\n{\r\nint err;\r\nerr = blk_pre_runtime_suspend(sdev->request_queue);\r\nif (err)\r\nreturn err;\r\nif (cb)\r\nerr = cb(&sdev->sdev_gendev);\r\nblk_post_runtime_suspend(sdev->request_queue, err);\r\nreturn err;\r\n}\r\nstatic int sdev_runtime_suspend(struct device *dev)\r\n{\r\nconst struct dev_pm_ops *pm = dev->driver ? dev->driver->pm : NULL;\r\nint (*cb)(struct device *) = pm ? pm->runtime_suspend : NULL;\r\nstruct scsi_device *sdev = to_scsi_device(dev);\r\nint err;\r\nif (sdev->request_queue->dev)\r\nreturn sdev_blk_runtime_suspend(sdev, cb);\r\nerr = scsi_dev_type_suspend(dev, cb);\r\nif (err == -EAGAIN)\r\npm_schedule_suspend(dev, jiffies_to_msecs(\r\nround_jiffies_up_relative(HZ/10)));\r\nreturn err;\r\n}\r\nstatic int scsi_runtime_suspend(struct device *dev)\r\n{\r\nint err = 0;\r\ndev_dbg(dev, "scsi_runtime_suspend\n");\r\nif (scsi_is_sdev_device(dev))\r\nerr = sdev_runtime_suspend(dev);\r\nreturn err;\r\n}\r\nstatic int sdev_blk_runtime_resume(struct scsi_device *sdev,\r\nint (*cb)(struct device *))\r\n{\r\nint err = 0;\r\nblk_pre_runtime_resume(sdev->request_queue);\r\nif (cb)\r\nerr = cb(&sdev->sdev_gendev);\r\nblk_post_runtime_resume(sdev->request_queue, err);\r\nreturn err;\r\n}\r\nstatic int sdev_runtime_resume(struct device *dev)\r\n{\r\nstruct scsi_device *sdev = to_scsi_device(dev);\r\nconst struct dev_pm_ops *pm = dev->driver ? dev->driver->pm : NULL;\r\nint (*cb)(struct device *) = pm ? pm->runtime_resume : NULL;\r\nif (sdev->request_queue->dev)\r\nreturn sdev_blk_runtime_resume(sdev, cb);\r\nelse\r\nreturn scsi_dev_type_resume(dev, cb);\r\n}\r\nstatic int scsi_runtime_resume(struct device *dev)\r\n{\r\nint err = 0;\r\ndev_dbg(dev, "scsi_runtime_resume\n");\r\nif (scsi_is_sdev_device(dev))\r\nerr = sdev_runtime_resume(dev);\r\nreturn err;\r\n}\r\nstatic int scsi_runtime_idle(struct device *dev)\r\n{\r\ndev_dbg(dev, "scsi_runtime_idle\n");\r\nif (scsi_is_sdev_device(dev)) {\r\nstruct scsi_device *sdev = to_scsi_device(dev);\r\nif (sdev->request_queue->dev) {\r\npm_runtime_mark_last_busy(dev);\r\npm_runtime_autosuspend(dev);\r\nreturn -EBUSY;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint scsi_autopm_get_device(struct scsi_device *sdev)\r\n{\r\nint err;\r\nerr = pm_runtime_get_sync(&sdev->sdev_gendev);\r\nif (err < 0 && err !=-EACCES)\r\npm_runtime_put_sync(&sdev->sdev_gendev);\r\nelse\r\nerr = 0;\r\nreturn err;\r\n}\r\nvoid scsi_autopm_put_device(struct scsi_device *sdev)\r\n{\r\npm_runtime_put_sync(&sdev->sdev_gendev);\r\n}\r\nvoid scsi_autopm_get_target(struct scsi_target *starget)\r\n{\r\npm_runtime_get_sync(&starget->dev);\r\n}\r\nvoid scsi_autopm_put_target(struct scsi_target *starget)\r\n{\r\npm_runtime_put_sync(&starget->dev);\r\n}\r\nint scsi_autopm_get_host(struct Scsi_Host *shost)\r\n{\r\nint err;\r\nerr = pm_runtime_get_sync(&shost->shost_gendev);\r\nif (err < 0 && err !=-EACCES)\r\npm_runtime_put_sync(&shost->shost_gendev);\r\nelse\r\nerr = 0;\r\nreturn err;\r\n}\r\nvoid scsi_autopm_put_host(struct Scsi_Host *shost)\r\n{\r\npm_runtime_put_sync(&shost->shost_gendev);\r\n}

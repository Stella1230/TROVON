s32 _s13_to_s32(u32 data)\r\n{\r\nu32 val;\r\nval = (data & 0x0FFF);\r\nif ((data & BIT(12)) != 0)\r\nval |= 0xFFFFF000;\r\nreturn (s32) val;\r\n}\r\nu32 _s32_to_s13(s32 data)\r\n{\r\nu32 val;\r\nif (data > 4095)\r\ndata = 4095;\r\nelse if (data < -4096)\r\ndata = -4096;\r\nval = data & 0x1FFF;\r\nreturn val;\r\n}\r\ns32 _s4_to_s32(u32 data)\r\n{\r\ns32 val;\r\nval = (data & 0x0007);\r\nif ((data & BIT(3)) != 0)\r\nval |= 0xFFFFFFF8;\r\nreturn val;\r\n}\r\nu32 _s32_to_s4(s32 data)\r\n{\r\nu32 val;\r\nif (data > 7)\r\ndata = 7;\r\nelse if (data < -8)\r\ndata = -8;\r\nval = data & 0x000F;\r\nreturn val;\r\n}\r\ns32 _s5_to_s32(u32 data)\r\n{\r\ns32 val;\r\nval = (data & 0x000F);\r\nif ((data & BIT(4)) != 0)\r\nval |= 0xFFFFFFF0;\r\nreturn val;\r\n}\r\nu32 _s32_to_s5(s32 data)\r\n{\r\nu32 val;\r\nif (data > 15)\r\ndata = 15;\r\nelse if (data < -16)\r\ndata = -16;\r\nval = data & 0x001F;\r\nreturn val;\r\n}\r\ns32 _s6_to_s32(u32 data)\r\n{\r\ns32 val;\r\nval = (data & 0x001F);\r\nif ((data & BIT(5)) != 0)\r\nval |= 0xFFFFFFE0;\r\nreturn val;\r\n}\r\nu32 _s32_to_s6(s32 data)\r\n{\r\nu32 val;\r\nif (data > 31)\r\ndata = 31;\r\nelse if (data < -32)\r\ndata = -32;\r\nval = data & 0x003F;\r\nreturn val;\r\n}\r\ns32 _s9_to_s32(u32 data)\r\n{\r\ns32 val;\r\nval = data & 0x00FF;\r\nif ((data & BIT(8)) != 0)\r\nval |= 0xFFFFFF00;\r\nreturn val;\r\n}\r\nu32 _s32_to_s9(s32 data)\r\n{\r\nu32 val;\r\nif (data > 255)\r\ndata = 255;\r\nelse if (data < -256)\r\ndata = -256;\r\nval = data & 0x01FF;\r\nreturn val;\r\n}\r\ns32 _floor(s32 n)\r\n{\r\nif (n > 0)\r\nn += 5;\r\nelse\r\nn -= 5;\r\nreturn n/10;\r\n}\r\nu32 _sqrt(u32 sqsum)\r\n{\r\nu32 sq_rt;\r\nint g0, g1, g2, g3, g4;\r\nint seed;\r\nint next;\r\nint step;\r\ng4 = sqsum / 100000000;\r\ng3 = (sqsum - g4*100000000) / 1000000;\r\ng2 = (sqsum - g4*100000000 - g3*1000000) / 10000;\r\ng1 = (sqsum - g4*100000000 - g3*1000000 - g2*10000) / 100;\r\ng0 = (sqsum - g4*100000000 - g3*1000000 - g2*10000 - g1*100);\r\nnext = g4;\r\nstep = 0;\r\nseed = 0;\r\nwhile (((seed+1)*(step+1)) <= next) {\r\nstep++;\r\nseed++;\r\n}\r\nsq_rt = seed * 10000;\r\nnext = (next-(seed*step))*100 + g3;\r\nstep = 0;\r\nseed = 2 * seed * 10;\r\nwhile (((seed+1)*(step+1)) <= next) {\r\nstep++;\r\nseed++;\r\n}\r\nsq_rt = sq_rt + step * 1000;\r\nnext = (next - seed * step) * 100 + g2;\r\nseed = (seed + step) * 10;\r\nstep = 0;\r\nwhile (((seed+1)*(step+1)) <= next) {\r\nstep++;\r\nseed++;\r\n}\r\nsq_rt = sq_rt + step * 100;\r\nnext = (next - seed * step) * 100 + g1;\r\nseed = (seed + step) * 10;\r\nstep = 0;\r\nwhile (((seed+1)*(step+1)) <= next) {\r\nstep++;\r\nseed++;\r\n}\r\nsq_rt = sq_rt + step * 10;\r\nnext = (next - seed * step) * 100 + g0;\r\nseed = (seed + step) * 10;\r\nstep = 0;\r\nwhile (((seed+1)*(step+1)) <= next) {\r\nstep++;\r\nseed++;\r\n}\r\nsq_rt = sq_rt + step;\r\nreturn sq_rt;\r\n}\r\nvoid _sin_cos(s32 angle, s32 *sin, s32 *cos)\r\n{\r\ns32 X, Y, TargetAngle, CurrAngle;\r\nunsigned Step;\r\nX = FIXED(AG_CONST);\r\nY = 0;\r\nTargetAngle = abs(angle);\r\nCurrAngle = 0;\r\nfor (Step = 0; Step < 12; Step++) {\r\ns32 NewX;\r\nif (TargetAngle > CurrAngle) {\r\nNewX = X - (Y >> Step);\r\nY = (X >> Step) + Y;\r\nX = NewX;\r\nCurrAngle += Angles[Step];\r\n} else {\r\nNewX = X + (Y >> Step);\r\nY = -(X >> Step) + Y;\r\nX = NewX;\r\nCurrAngle -= Angles[Step];\r\n}\r\n}\r\nif (angle > 0) {\r\n*cos = X;\r\n*sin = Y;\r\n} else {\r\n*cos = X;\r\n*sin = -Y;\r\n}\r\n}\r\nstatic unsigned char hal_get_dxx_reg(struct hw_data *pHwData, u16 number, u32 *pValue)\r\n{\r\nif (number < 0x1000)\r\nnumber += 0x1000;\r\nreturn Wb35Reg_ReadSync(pHwData, number, pValue);\r\n}\r\nstatic unsigned char hal_set_dxx_reg(struct hw_data *pHwData, u16 number, u32 value)\r\n{\r\nunsigned char ret;\r\nif (number < 0x1000)\r\nnumber += 0x1000;\r\nret = Wb35Reg_WriteSync(pHwData, number, value);\r\nreturn ret;\r\n}\r\nvoid _reset_rx_cal(struct hw_data *phw_data)\r\n{\r\nu32 val;\r\nhw_get_dxx_reg(phw_data, 0x54, &val);\r\nif (phw_data->revision == 0x2002)\r\nval &= 0xFFFF0000;\r\nelse\r\nval &= 0x000003FF;\r\nhw_set_dxx_reg(phw_data, 0x54, val);\r\n}\r\nvoid _rxadc_dc_offset_cancellation_winbond(struct hw_data *phw_data, u32 frequency)\r\n{\r\nu32 reg_agc_ctrl3;\r\nu32 reg_a_acq_ctrl;\r\nu32 reg_b_acq_ctrl;\r\nu32 val;\r\nPHY_DEBUG(("[CAL] -> [1]_rxadc_dc_offset_cancellation()\n"));\r\nphy_init_rf(phw_data);\r\nif ((RF_WB_242 == phw_data->phy_type) ||\r\n(RF_WB_242_1 == phw_data->phy_type)) {\r\nif ((frequency >= 2412) && (frequency <= 2484)) {\r\nPHY_DEBUG(("[CAL] W89RF242/11G/Channel=2390Mhz\n"));\r\nphy_set_rf_data(phw_data, 3, (3<<24)|0x025586);\r\n}\r\n} else {\r\n}\r\nhw_get_dxx_reg(phw_data, 0x5C, &val);\r\nval &= ~(0x03FF);\r\nhw_set_dxx_reg(phw_data, 0x5C, val);\r\nhw_set_dxx_reg(phw_data, 0x3C, 0);\r\nhw_set_dxx_reg(phw_data, 0x54, 0);\r\nhw_set_dxx_reg(phw_data, 0x58, 0x30303030);\r\nhw_get_dxx_reg(phw_data, REG_AGC_CTRL3, &reg_agc_ctrl3);\r\nreg_agc_ctrl3 &= ~BIT(2);\r\nreg_agc_ctrl3 |= (MASK_LNA_FIX_GAIN|MASK_AGC_FIX);\r\nhw_set_dxx_reg(phw_data, REG_AGC_CTRL3, reg_agc_ctrl3);\r\nhw_get_dxx_reg(phw_data, REG_AGC_CTRL5, &val);\r\nval |= MASK_AGC_FIX_GAIN;\r\nhw_set_dxx_reg(phw_data, REG_AGC_CTRL5, val);\r\nhw_get_dxx_reg(phw_data, REG_A_ACQ_CTRL, &reg_a_acq_ctrl);\r\nreg_a_acq_ctrl |= MASK_AMER_OFF_REG;\r\nhw_set_dxx_reg(phw_data, REG_A_ACQ_CTRL, reg_a_acq_ctrl);\r\nhw_get_dxx_reg(phw_data, REG_B_ACQ_CTRL, &reg_b_acq_ctrl);\r\nreg_b_acq_ctrl |= MASK_BMER_OFF_REG;\r\nhw_set_dxx_reg(phw_data, REG_B_ACQ_CTRL, reg_b_acq_ctrl);\r\nhw_get_dxx_reg(phw_data, REG_MODE_CTRL, &val);\r\nval &= ~MASK_ADC_DC_CAL_STR;\r\nhw_set_dxx_reg(phw_data, REG_MODE_CTRL, val);\r\nval |= MASK_ADC_DC_CAL_STR;\r\nhw_set_dxx_reg(phw_data, REG_MODE_CTRL, val);\r\n#ifdef _DEBUG\r\nhw_get_dxx_reg(phw_data, REG_OFFSET_READ, &val);\r\nPHY_DEBUG(("[CAL] REG_OFFSET_READ = 0x%08X\n", val));\r\nPHY_DEBUG(("[CAL] ** adc_dc_cal_i = %d (0x%04X)\n",\r\n_s9_to_s32(val&0x000001FF), val&0x000001FF));\r\nPHY_DEBUG(("[CAL] ** adc_dc_cal_q = %d (0x%04X)\n",\r\n_s9_to_s32((val&0x0003FE00)>>9), (val&0x0003FE00)>>9));\r\n#endif\r\nhw_get_dxx_reg(phw_data, REG_MODE_CTRL, &val);\r\nval &= ~MASK_ADC_DC_CAL_STR;\r\nhw_set_dxx_reg(phw_data, REG_MODE_CTRL, val);\r\nreg_a_acq_ctrl &= ~MASK_AMER_OFF_REG;\r\nhw_set_dxx_reg(phw_data, REG_A_ACQ_CTRL, reg_a_acq_ctrl);\r\nreg_b_acq_ctrl &= ~MASK_BMER_OFF_REG;\r\nhw_set_dxx_reg(phw_data, REG_B_ACQ_CTRL, reg_b_acq_ctrl);\r\nreg_agc_ctrl3 |= BIT(2);\r\nreg_agc_ctrl3 &= ~(MASK_LNA_FIX_GAIN|MASK_AGC_FIX);\r\nhw_set_dxx_reg(phw_data, REG_AGC_CTRL3, reg_agc_ctrl3);\r\n}\r\nvoid _txidac_dc_offset_cancellation_winbond(struct hw_data *phw_data)\r\n{\r\nu32 reg_agc_ctrl3;\r\nu32 reg_mode_ctrl;\r\nu32 reg_dc_cancel;\r\ns32 iqcal_image_i;\r\ns32 iqcal_image_q;\r\nu32 sqsum;\r\ns32 mag_0;\r\ns32 mag_1;\r\ns32 fix_cancel_dc_i = 0;\r\nu32 val;\r\nint loop;\r\nPHY_DEBUG(("[CAL] -> [2]_txidac_dc_offset_cancellation()\n"));\r\nphy_set_rf_data(phw_data, 1, (1<<24)|0xEE3FC2);\r\nphy_set_rf_data(phw_data, 11, (11<<24)|0x1901D6);\r\nphy_set_rf_data(phw_data, 5, (5<<24)|0x24C48A);\r\nphy_set_rf_data(phw_data, 6, (6<<24)|0x06890C);\r\nphy_set_rf_data(phw_data, 0, (0<<24)|0xFDF1C0);\r\nhw_set_dxx_reg(phw_data, 0x58, 0x30303030);\r\nhw_get_dxx_reg(phw_data, REG_AGC_CTRL3, &reg_agc_ctrl3);\r\nreg_agc_ctrl3 &= ~BIT(2);\r\nreg_agc_ctrl3 |= (MASK_LNA_FIX_GAIN|MASK_AGC_FIX);\r\nhw_set_dxx_reg(phw_data, REG_AGC_CTRL3, reg_agc_ctrl3);\r\nhw_get_dxx_reg(phw_data, REG_AGC_CTRL5, &val);\r\nval |= MASK_AGC_FIX_GAIN;\r\nhw_set_dxx_reg(phw_data, REG_AGC_CTRL5, val);\r\nhw_get_dxx_reg(phw_data, REG_MODE_CTRL, &reg_mode_ctrl);\r\nPHY_DEBUG(("[CAL] MODE_CTRL (read) = 0x%08X\n", reg_mode_ctrl));\r\nreg_mode_ctrl &= ~(MASK_IQCAL_TONE_SEL|MASK_IQCAL_MODE);\r\nreg_mode_ctrl |= (MASK_CALIB_START|2|(2<<2));\r\nhw_set_dxx_reg(phw_data, REG_MODE_CTRL, reg_mode_ctrl);\r\nPHY_DEBUG(("[CAL] MODE_CTRL (write) = 0x%08X\n", reg_mode_ctrl));\r\nhw_get_dxx_reg(phw_data, 0x5C, &reg_dc_cancel);\r\nPHY_DEBUG(("[CAL] DC_CANCEL (read) = 0x%08X\n", reg_dc_cancel));\r\nfor (loop = 0; loop < LOOP_TIMES; loop++) {\r\nPHY_DEBUG(("[CAL] [%d.] ==================================\n", loop));\r\nreg_dc_cancel &= ~(0x03FF);\r\nPHY_DEBUG(("[CAL] DC_CANCEL (write) = 0x%08X\n", reg_dc_cancel));\r\nhw_set_dxx_reg(phw_data, 0x5C, reg_dc_cancel);\r\nhw_get_dxx_reg(phw_data, REG_CALIB_READ2, &val);\r\nPHY_DEBUG(("[CAL] CALIB_READ2 = 0x%08X\n", val));\r\niqcal_image_i = _s13_to_s32(val & 0x00001FFF);\r\niqcal_image_q = _s13_to_s32((val & 0x03FFE000) >> 13);\r\nsqsum = iqcal_image_i*iqcal_image_i + iqcal_image_q*iqcal_image_q;\r\nmag_0 = (s32) _sqrt(sqsum);\r\nPHY_DEBUG(("[CAL] mag_0=%d (iqcal_image_i=%d, iqcal_image_q=%d)\n",\r\nmag_0, iqcal_image_i, iqcal_image_q));\r\nreg_dc_cancel |= (1 << CANCEL_DC_I_SHIFT);\r\nPHY_DEBUG(("[CAL] DC_CANCEL (write) = 0x%08X\n", reg_dc_cancel));\r\nhw_set_dxx_reg(phw_data, 0x5C, reg_dc_cancel);\r\nhw_get_dxx_reg(phw_data, REG_CALIB_READ2, &val);\r\nPHY_DEBUG(("[CAL] CALIB_READ2 = 0x%08X\n", val));\r\niqcal_image_i = _s13_to_s32(val & 0x00001FFF);\r\niqcal_image_q = _s13_to_s32((val & 0x03FFE000) >> 13);\r\nsqsum = iqcal_image_i*iqcal_image_i + iqcal_image_q*iqcal_image_q;\r\nmag_1 = (s32) _sqrt(sqsum);\r\nPHY_DEBUG(("[CAL] mag_1=%d (iqcal_image_i=%d, iqcal_image_q=%d)\n",\r\nmag_1, iqcal_image_i, iqcal_image_q));\r\nif (mag_0 != mag_1)\r\nfix_cancel_dc_i = (mag_0*10000) / (mag_0*10000 - mag_1*10000);\r\nelse {\r\nif (mag_0 == mag_1)\r\nPHY_DEBUG(("[CAL] ***** mag_0 = mag_1 !!\n"));\r\nfix_cancel_dc_i = 0;\r\n}\r\nPHY_DEBUG(("[CAL] ** fix_cancel_dc_i = %d (0x%04X)\n",\r\nfix_cancel_dc_i, _s32_to_s5(fix_cancel_dc_i)));\r\nif ((abs(mag_1-mag_0)*6) > mag_0)\r\nbreak;\r\n}\r\nif (loop >= 19)\r\nfix_cancel_dc_i = 0;\r\nreg_dc_cancel &= ~(0x03FF);\r\nreg_dc_cancel |= (_s32_to_s5(fix_cancel_dc_i) << CANCEL_DC_I_SHIFT);\r\nhw_set_dxx_reg(phw_data, 0x5C, reg_dc_cancel);\r\nPHY_DEBUG(("[CAL] DC_CANCEL (write) = 0x%08X\n", reg_dc_cancel));\r\nreg_mode_ctrl &= ~MASK_CALIB_START;\r\nhw_set_dxx_reg(phw_data, REG_MODE_CTRL, reg_mode_ctrl);\r\nPHY_DEBUG(("[CAL] MODE_CTRL (write) = 0x%08X\n", reg_mode_ctrl));\r\n}\r\nvoid _txqdac_dc_offset_cacellation_winbond(struct hw_data *phw_data)\r\n{\r\nu32 reg_agc_ctrl3;\r\nu32 reg_mode_ctrl;\r\nu32 reg_dc_cancel;\r\ns32 iqcal_image_i;\r\ns32 iqcal_image_q;\r\nu32 sqsum;\r\ns32 mag_0;\r\ns32 mag_1;\r\ns32 fix_cancel_dc_q = 0;\r\nu32 val;\r\nint loop;\r\nPHY_DEBUG(("[CAL] -> [3]_txqdac_dc_offset_cacellation()\n"));\r\nphy_set_rf_data(phw_data, 1, (1<<24)|0xEE3FC2);\r\nphy_set_rf_data(phw_data, 11, (11<<24)|0x1901D6);\r\nphy_set_rf_data(phw_data, 5, (5<<24)|0x24C48A);\r\nphy_set_rf_data(phw_data, 6, (6<<24)|0x06890C);\r\nphy_set_rf_data(phw_data, 0, (0<<24)|0xFDF1C0);\r\nhw_set_dxx_reg(phw_data, 0x58, 0x30303030);\r\nhw_get_dxx_reg(phw_data, REG_AGC_CTRL3, &reg_agc_ctrl3);\r\nreg_agc_ctrl3 &= ~BIT(2);\r\nreg_agc_ctrl3 |= (MASK_LNA_FIX_GAIN|MASK_AGC_FIX);\r\nhw_set_dxx_reg(phw_data, REG_AGC_CTRL3, reg_agc_ctrl3);\r\nhw_get_dxx_reg(phw_data, REG_AGC_CTRL5, &val);\r\nval |= MASK_AGC_FIX_GAIN;\r\nhw_set_dxx_reg(phw_data, REG_AGC_CTRL5, val);\r\nhw_get_dxx_reg(phw_data, REG_MODE_CTRL, &reg_mode_ctrl);\r\nPHY_DEBUG(("[CAL] MODE_CTRL (read) = 0x%08X\n", reg_mode_ctrl));\r\nreg_mode_ctrl &= ~(MASK_IQCAL_MODE);\r\nreg_mode_ctrl |= (MASK_CALIB_START|3);\r\nhw_set_dxx_reg(phw_data, REG_MODE_CTRL, reg_mode_ctrl);\r\nPHY_DEBUG(("[CAL] MODE_CTRL (write) = 0x%08X\n", reg_mode_ctrl));\r\nhw_get_dxx_reg(phw_data, 0x5C, &reg_dc_cancel);\r\nPHY_DEBUG(("[CAL] DC_CANCEL (read) = 0x%08X\n", reg_dc_cancel));\r\nfor (loop = 0; loop < LOOP_TIMES; loop++) {\r\nPHY_DEBUG(("[CAL] [%d.] ==================================\n", loop));\r\nreg_dc_cancel &= ~(0x001F);\r\nPHY_DEBUG(("[CAL] DC_CANCEL (write) = 0x%08X\n", reg_dc_cancel));\r\nhw_set_dxx_reg(phw_data, 0x5C, reg_dc_cancel);\r\nhw_get_dxx_reg(phw_data, REG_CALIB_READ2, &val);\r\nPHY_DEBUG(("[CAL] CALIB_READ2 = 0x%08X\n", val));\r\niqcal_image_i = _s13_to_s32(val & 0x00001FFF);\r\niqcal_image_q = _s13_to_s32((val & 0x03FFE000) >> 13);\r\nsqsum = iqcal_image_i*iqcal_image_i + iqcal_image_q*iqcal_image_q;\r\nmag_0 = _sqrt(sqsum);\r\nPHY_DEBUG(("[CAL] mag_0=%d (iqcal_image_i=%d, iqcal_image_q=%d)\n",\r\nmag_0, iqcal_image_i, iqcal_image_q));\r\nreg_dc_cancel |= (1 << CANCEL_DC_Q_SHIFT);\r\nPHY_DEBUG(("[CAL] DC_CANCEL (write) = 0x%08X\n", reg_dc_cancel));\r\nhw_set_dxx_reg(phw_data, 0x5C, reg_dc_cancel);\r\nhw_get_dxx_reg(phw_data, REG_CALIB_READ2, &val);\r\nPHY_DEBUG(("[CAL] CALIB_READ2 = 0x%08X\n", val));\r\niqcal_image_i = _s13_to_s32(val & 0x00001FFF);\r\niqcal_image_q = _s13_to_s32((val & 0x03FFE000) >> 13);\r\nsqsum = iqcal_image_i*iqcal_image_i + iqcal_image_q*iqcal_image_q;\r\nmag_1 = _sqrt(sqsum);\r\nPHY_DEBUG(("[CAL] mag_1=%d (iqcal_image_i=%d, iqcal_image_q=%d)\n",\r\nmag_1, iqcal_image_i, iqcal_image_q));\r\nif (mag_0 != mag_1)\r\nfix_cancel_dc_q = (mag_0*10000) / (mag_0*10000 - mag_1*10000);\r\nelse {\r\nif (mag_0 == mag_1)\r\nPHY_DEBUG(("[CAL] ***** mag_0 = mag_1 !!\n"));\r\nfix_cancel_dc_q = 0;\r\n}\r\nPHY_DEBUG(("[CAL] ** fix_cancel_dc_q = %d (0x%04X)\n",\r\nfix_cancel_dc_q, _s32_to_s5(fix_cancel_dc_q)));\r\nif ((abs(mag_1-mag_0)*6) > mag_0)\r\nbreak;\r\n}\r\nif (loop >= 19)\r\nfix_cancel_dc_q = 0;\r\nreg_dc_cancel &= ~(0x001F);\r\nreg_dc_cancel |= (_s32_to_s5(fix_cancel_dc_q) << CANCEL_DC_Q_SHIFT);\r\nhw_set_dxx_reg(phw_data, 0x5C, reg_dc_cancel);\r\nPHY_DEBUG(("[CAL] DC_CANCEL (write) = 0x%08X\n", reg_dc_cancel));\r\nreg_mode_ctrl &= ~MASK_CALIB_START;\r\nhw_set_dxx_reg(phw_data, REG_MODE_CTRL, reg_mode_ctrl);\r\nPHY_DEBUG(("[CAL] MODE_CTRL (write) = 0x%08X\n", reg_mode_ctrl));\r\n}\r\nu8 _tx_iq_calibration_loop_winbond(struct hw_data *phw_data,\r\ns32 a_2_threshold,\r\ns32 b_2_threshold)\r\n{\r\nu32 reg_mode_ctrl;\r\ns32 iq_mag_0_tx;\r\ns32 iqcal_tone_i0;\r\ns32 iqcal_tone_q0;\r\ns32 iqcal_tone_i;\r\ns32 iqcal_tone_q;\r\nu32 sqsum;\r\ns32 rot_i_b;\r\ns32 rot_q_b;\r\ns32 tx_cal_flt_b[4];\r\ns32 tx_cal[4];\r\ns32 tx_cal_reg[4];\r\ns32 a_2, b_2;\r\ns32 sin_b, sin_2b;\r\ns32 cos_b, cos_2b;\r\ns32 divisor;\r\ns32 temp1, temp2;\r\nu32 val;\r\nu16 loop;\r\ns32 iqcal_tone_i_avg, iqcal_tone_q_avg;\r\nu8 verify_count;\r\nint capture_time;\r\nPHY_DEBUG(("[CAL] -> _tx_iq_calibration_loop()\n"));\r\nPHY_DEBUG(("[CAL] ** a_2_threshold = %d\n", a_2_threshold));\r\nPHY_DEBUG(("[CAL] ** b_2_threshold = %d\n", b_2_threshold));\r\nverify_count = 0;\r\nhw_get_dxx_reg(phw_data, REG_MODE_CTRL, &reg_mode_ctrl);\r\nPHY_DEBUG(("[CAL] MODE_CTRL (read) = 0x%08X\n", reg_mode_ctrl));\r\nloop = LOOP_TIMES;\r\nwhile (loop > 0) {\r\nPHY_DEBUG(("[CAL] [%d.] <_tx_iq_calibration_loop>\n", (LOOP_TIMES-loop+1)));\r\niqcal_tone_i_avg = 0;\r\niqcal_tone_q_avg = 0;\r\nif (!hw_set_dxx_reg(phw_data, 0x3C, 0x00))\r\nreturn 0;\r\nfor (capture_time = 0; capture_time < 10; capture_time++) {\r\nreg_mode_ctrl &= ~(MASK_IQCAL_TONE_SEL|MASK_IQCAL_MODE);\r\nreg_mode_ctrl &= ~MASK_IQCAL_MODE;\r\nreg_mode_ctrl |= (MASK_CALIB_START|0x02);\r\nreg_mode_ctrl |= (MASK_CALIB_START|0x02|2<<2);\r\nhw_set_dxx_reg(phw_data, REG_MODE_CTRL, reg_mode_ctrl);\r\nPHY_DEBUG(("[CAL] MODE_CTRL (write) = 0x%08X\n", reg_mode_ctrl));\r\nhw_get_dxx_reg(phw_data, REG_CALIB_READ1, &val);\r\nPHY_DEBUG(("[CAL] CALIB_READ1 = 0x%08X\n", val));\r\niqcal_tone_i0 = _s13_to_s32(val & 0x00001FFF);\r\niqcal_tone_q0 = _s13_to_s32((val & 0x03FFE000) >> 13);\r\nPHY_DEBUG(("[CAL] ** iqcal_tone_i0=%d, iqcal_tone_q0=%d\n",\r\niqcal_tone_i0, iqcal_tone_q0));\r\nsqsum = iqcal_tone_i0*iqcal_tone_i0 +\r\niqcal_tone_q0*iqcal_tone_q0;\r\niq_mag_0_tx = (s32) _sqrt(sqsum);\r\nPHY_DEBUG(("[CAL] ** iq_mag_0_tx=%d\n", iq_mag_0_tx));\r\nreg_mode_ctrl &= ~MASK_CALIB_START;\r\nhw_set_dxx_reg(phw_data, REG_MODE_CTRL, reg_mode_ctrl);\r\nPHY_DEBUG(("[CAL] MODE_CTRL (write) = 0x%08X\n", reg_mode_ctrl));\r\nhw_get_dxx_reg(phw_data, REG_MODE_CTRL, &reg_mode_ctrl);\r\nreg_mode_ctrl &= ~MASK_IQCAL_MODE;\r\nreg_mode_ctrl |= (MASK_CALIB_START|0x03);\r\nhw_set_dxx_reg(phw_data, REG_MODE_CTRL, reg_mode_ctrl);\r\nPHY_DEBUG(("[CAL] MODE_CTRL (write) = 0x%08X\n", reg_mode_ctrl));\r\nhw_get_dxx_reg(phw_data, REG_CALIB_READ1, &val);\r\nPHY_DEBUG(("[CAL] CALIB_READ1 = 0x%08X\n", val));\r\niqcal_tone_i = _s13_to_s32(val & 0x00001FFF);\r\niqcal_tone_q = _s13_to_s32((val & 0x03FFE000) >> 13);\r\nPHY_DEBUG(("[CAL] ** iqcal_tone_i = %d, iqcal_tone_q = %d\n",\r\niqcal_tone_i, iqcal_tone_q));\r\nif (capture_time == 0)\r\ncontinue;\r\nelse {\r\niqcal_tone_i_avg = (iqcal_tone_i_avg*(capture_time-1) + iqcal_tone_i)/capture_time;\r\niqcal_tone_q_avg = (iqcal_tone_q_avg*(capture_time-1) + iqcal_tone_q)/capture_time;\r\n}\r\n}\r\niqcal_tone_i = iqcal_tone_i_avg;\r\niqcal_tone_q = iqcal_tone_q_avg;\r\nrot_i_b = (iqcal_tone_i * iqcal_tone_i0 +\r\niqcal_tone_q * iqcal_tone_q0) / 1024;\r\nrot_q_b = (iqcal_tone_i * iqcal_tone_q0 * (-1) +\r\niqcal_tone_q * iqcal_tone_i0) / 1024;\r\nPHY_DEBUG(("[CAL] ** rot_i_b = %d, rot_q_b = %d\n",\r\nrot_i_b, rot_q_b));\r\ndivisor = ((iq_mag_0_tx * iq_mag_0_tx * 2)/1024 - rot_i_b) * 2;\r\nif (divisor == 0) {\r\nPHY_DEBUG(("[CAL] ** <_tx_iq_calibration_loop> ERROR *******\n"));\r\nPHY_DEBUG(("[CAL] ** divisor=0 to calculate EPS and THETA !!\n"));\r\nPHY_DEBUG(("[CAL] ******************************************\n"));\r\nbreak;\r\n}\r\na_2 = (rot_i_b * 32768) / divisor;\r\nb_2 = (rot_q_b * (-32768)) / divisor;\r\nPHY_DEBUG(("[CAL] ***** EPSILON/2 = %d\n", a_2));\r\nPHY_DEBUG(("[CAL] ***** THETA/2 = %d\n", b_2));\r\nphw_data->iq_rsdl_gain_tx_d2 = a_2;\r\nphw_data->iq_rsdl_phase_tx_d2 = b_2;\r\nif ((abs(a_2) < a_2_threshold) && (abs(b_2) < b_2_threshold)) {\r\nverify_count++;\r\nPHY_DEBUG(("[CAL] ** <_tx_iq_calibration_loop> *************\n"));\r\nPHY_DEBUG(("[CAL] ** VERIFY OK # %d !!\n", verify_count));\r\nPHY_DEBUG(("[CAL] ******************************************\n"));\r\nif (verify_count > 2) {\r\nPHY_DEBUG(("[CAL] ** <_tx_iq_calibration_loop> *********\n"));\r\nPHY_DEBUG(("[CAL] ** TX_IQ_CALIBRATION (EPS,THETA) OK !!\n"));\r\nPHY_DEBUG(("[CAL] **************************************\n"));\r\nreturn 0;\r\n}\r\ncontinue;\r\n} else\r\nverify_count = 0;\r\n_sin_cos(b_2, &sin_b, &cos_b);\r\n_sin_cos(b_2*2, &sin_2b, &cos_2b);\r\nPHY_DEBUG(("[CAL] ** sin(b/2)=%d, cos(b/2)=%d\n", sin_b, cos_b));\r\nPHY_DEBUG(("[CAL] ** sin(b)=%d, cos(b)=%d\n", sin_2b, cos_2b));\r\nif (cos_2b == 0) {\r\nPHY_DEBUG(("[CAL] ** <_tx_iq_calibration_loop> ERROR *******\n"));\r\nPHY_DEBUG(("[CAL] ** cos(b)=0 !!\n"));\r\nPHY_DEBUG(("[CAL] ******************************************\n"));\r\nbreak;\r\n}\r\ntemp1 = (41943040/cos_2b)*cos_b;\r\nif (phw_data->revision == 0x2002)\r\ntemp2 = (41943040/cos_2b)*sin_b*(-1);\r\nelse\r\ntemp2 = (41943040*4/cos_2b)*sin_b*(-1);\r\ntx_cal_flt_b[0] = _floor(temp1/(32768+a_2));\r\ntx_cal_flt_b[1] = _floor(temp2/(32768+a_2));\r\ntx_cal_flt_b[2] = _floor(temp2/(32768-a_2));\r\ntx_cal_flt_b[3] = _floor(temp1/(32768-a_2));\r\nPHY_DEBUG(("[CAL] ** tx_cal_flt_b[0] = %d\n", tx_cal_flt_b[0]));\r\nPHY_DEBUG(("[CAL] tx_cal_flt_b[1] = %d\n", tx_cal_flt_b[1]));\r\nPHY_DEBUG(("[CAL] tx_cal_flt_b[2] = %d\n", tx_cal_flt_b[2]));\r\nPHY_DEBUG(("[CAL] tx_cal_flt_b[3] = %d\n", tx_cal_flt_b[3]));\r\ntx_cal[2] = tx_cal_flt_b[2];\r\ntx_cal[2] = tx_cal[2] + 3;\r\ntx_cal[1] = tx_cal[2];\r\ntx_cal[3] = tx_cal_flt_b[3] - 128;\r\ntx_cal[0] = -tx_cal[3] + 1;\r\nPHY_DEBUG(("[CAL] tx_cal[0] = %d\n", tx_cal[0]));\r\nPHY_DEBUG(("[CAL] tx_cal[1] = %d\n", tx_cal[1]));\r\nPHY_DEBUG(("[CAL] tx_cal[2] = %d\n", tx_cal[2]));\r\nPHY_DEBUG(("[CAL] tx_cal[3] = %d\n", tx_cal[3]));\r\nif (phw_data->revision == 0x2002) {\r\nhw_get_dxx_reg(phw_data, 0x54, &val);\r\nPHY_DEBUG(("[CAL] ** 0x54 = 0x%08X\n", val));\r\ntx_cal_reg[0] = _s4_to_s32((val & 0xF0000000) >> 28);\r\ntx_cal_reg[1] = _s4_to_s32((val & 0x0F000000) >> 24);\r\ntx_cal_reg[2] = _s4_to_s32((val & 0x00F00000) >> 20);\r\ntx_cal_reg[3] = _s4_to_s32((val & 0x000F0000) >> 16);\r\n} else {\r\nhw_get_dxx_reg(phw_data, 0x3C, &val);\r\nPHY_DEBUG(("[CAL] ** 0x3C = 0x%08X\n", val));\r\ntx_cal_reg[0] = _s5_to_s32((val & 0xF8000000) >> 27);\r\ntx_cal_reg[1] = _s6_to_s32((val & 0x07E00000) >> 21);\r\ntx_cal_reg[2] = _s6_to_s32((val & 0x001F8000) >> 15);\r\ntx_cal_reg[3] = _s5_to_s32((val & 0x00007C00) >> 10);\r\n}\r\nPHY_DEBUG(("[CAL] ** tx_cal_reg[0] = %d\n", tx_cal_reg[0]));\r\nPHY_DEBUG(("[CAL] tx_cal_reg[1] = %d\n", tx_cal_reg[1]));\r\nPHY_DEBUG(("[CAL] tx_cal_reg[2] = %d\n", tx_cal_reg[2]));\r\nPHY_DEBUG(("[CAL] tx_cal_reg[3] = %d\n", tx_cal_reg[3]));\r\nif (phw_data->revision == 0x2002) {\r\nif (((tx_cal_reg[0] == 7) || (tx_cal_reg[0] == (-8))) &&\r\n((tx_cal_reg[3] == 7) || (tx_cal_reg[3] == (-8)))) {\r\nPHY_DEBUG(("[CAL] ** <_tx_iq_calibration_loop> *********\n"));\r\nPHY_DEBUG(("[CAL] ** TX_IQ_CALIBRATION SATUATION !!\n"));\r\nPHY_DEBUG(("[CAL] **************************************\n"));\r\nbreak;\r\n}\r\n} else {\r\nif (((tx_cal_reg[0] == 31) || (tx_cal_reg[0] == (-32))) &&\r\n((tx_cal_reg[3] == 31) || (tx_cal_reg[3] == (-32)))) {\r\nPHY_DEBUG(("[CAL] ** <_tx_iq_calibration_loop> *********\n"));\r\nPHY_DEBUG(("[CAL] ** TX_IQ_CALIBRATION SATUATION !!\n"));\r\nPHY_DEBUG(("[CAL] **************************************\n"));\r\nbreak;\r\n}\r\n}\r\ntx_cal[0] = tx_cal[0] + tx_cal_reg[0];\r\ntx_cal[1] = tx_cal[1] + tx_cal_reg[1];\r\ntx_cal[2] = tx_cal[2] + tx_cal_reg[2];\r\ntx_cal[3] = tx_cal[3] + tx_cal_reg[3];\r\nPHY_DEBUG(("[CAL] ** apply tx_cal[0] = %d\n", tx_cal[0]));\r\nPHY_DEBUG(("[CAL] apply tx_cal[1] = %d\n", tx_cal[1]));\r\nPHY_DEBUG(("[CAL] apply tx_cal[2] = %d\n", tx_cal[2]));\r\nPHY_DEBUG(("[CAL] apply tx_cal[3] = %d\n", tx_cal[3]));\r\nif (phw_data->revision == 0x2002) {\r\nval &= 0x0000FFFF;\r\nval |= ((_s32_to_s4(tx_cal[0]) << 28)|\r\n(_s32_to_s4(tx_cal[1]) << 24)|\r\n(_s32_to_s4(tx_cal[2]) << 20)|\r\n(_s32_to_s4(tx_cal[3]) << 16));\r\nhw_set_dxx_reg(phw_data, 0x54, val);\r\nPHY_DEBUG(("[CAL] ** CALIB_DATA = 0x%08X\n", val));\r\nreturn 0;\r\n} else {\r\nval &= 0x000003FF;\r\nval |= ((_s32_to_s5(tx_cal[0]) << 27)|\r\n(_s32_to_s6(tx_cal[1]) << 21)|\r\n(_s32_to_s6(tx_cal[2]) << 15)|\r\n(_s32_to_s5(tx_cal[3]) << 10));\r\nhw_set_dxx_reg(phw_data, 0x3C, val);\r\nPHY_DEBUG(("[CAL] ** TX_IQ_CALIBRATION = 0x%08X\n", val));\r\nreturn 0;\r\n}\r\nreg_mode_ctrl &= ~MASK_CALIB_START;\r\nhw_set_dxx_reg(phw_data, REG_MODE_CTRL, reg_mode_ctrl);\r\nPHY_DEBUG(("[CAL] MODE_CTRL (write) = 0x%08X\n", reg_mode_ctrl));\r\nloop--;\r\n}\r\nreturn 1;\r\n}\r\nvoid _tx_iq_calibration_winbond(struct hw_data *phw_data)\r\n{\r\nu32 reg_agc_ctrl3;\r\n#ifdef _DEBUG\r\ns32 tx_cal_reg[4];\r\n#endif\r\nu32 reg_mode_ctrl;\r\nu32 val;\r\nu8 result;\r\nPHY_DEBUG(("[CAL] -> [4]_tx_iq_calibration()\n"));\r\nphy_set_rf_data(phw_data, 1, (1<<24)|0xEE3FC2);\r\nphy_set_rf_data(phw_data, 11, (11<<24)|0x19BDD6);\r\nphy_set_rf_data(phw_data, 5, (5<<24)|0x24C60A);\r\nphy_set_rf_data(phw_data, 6, (6<<24)|0x34880C);\r\nphy_set_rf_data(phw_data, 0, (0<<24)|0xFDF1C0);\r\nmsleep(30);\r\nadjust_TXVGA_for_iq_mag(phw_data);\r\nhw_get_dxx_reg(phw_data, REG_AGC_CTRL3, &reg_agc_ctrl3);\r\nreg_agc_ctrl3 &= ~BIT(2);\r\nreg_agc_ctrl3 |= (MASK_LNA_FIX_GAIN|MASK_AGC_FIX);\r\nhw_set_dxx_reg(phw_data, REG_AGC_CTRL3, reg_agc_ctrl3);\r\nhw_get_dxx_reg(phw_data, REG_AGC_CTRL5, &val);\r\nval |= MASK_AGC_FIX_GAIN;\r\nhw_set_dxx_reg(phw_data, REG_AGC_CTRL5, val);\r\nresult = _tx_iq_calibration_loop_winbond(phw_data, 150, 100);\r\nif (result > 0) {\r\nif (phw_data->revision == 0x2002) {\r\nhw_get_dxx_reg(phw_data, 0x54, &val);\r\nval &= 0x0000FFFF;\r\nhw_set_dxx_reg(phw_data, 0x54, val);\r\n} else {\r\nhw_get_dxx_reg(phw_data, 0x3C, &val);\r\nval &= 0x000003FF;\r\nhw_set_dxx_reg(phw_data, 0x3C, val);\r\n}\r\nresult = _tx_iq_calibration_loop_winbond(phw_data, 300, 200);\r\nif (result > 0) {\r\nif (phw_data->revision == 0x2002) {\r\nhw_get_dxx_reg(phw_data, 0x54, &val);\r\nval &= 0x0000FFFF;\r\nhw_set_dxx_reg(phw_data, 0x54, val);\r\n} else {\r\nhw_get_dxx_reg(phw_data, 0x3C, &val);\r\nval &= 0x000003FF;\r\nhw_set_dxx_reg(phw_data, 0x3C, val);\r\n}\r\nresult = _tx_iq_calibration_loop_winbond(phw_data, 500, 400);\r\nif (result > 0) {\r\nif (phw_data->revision == 0x2002) {\r\nhw_get_dxx_reg(phw_data, 0x54, &val);\r\nval &= 0x0000FFFF;\r\nhw_set_dxx_reg(phw_data, 0x54, val);\r\n} else {\r\nhw_get_dxx_reg(phw_data, 0x3C, &val);\r\nval &= 0x000003FF;\r\nhw_set_dxx_reg(phw_data, 0x3C, val);\r\n}\r\nresult = _tx_iq_calibration_loop_winbond(phw_data, 700, 500);\r\nif (result > 0) {\r\nPHY_DEBUG(("[CAL] ** <_tx_iq_calibration> **************\n"));\r\nPHY_DEBUG(("[CAL] ** TX_IQ_CALIBRATION FAILURE !!\n"));\r\nPHY_DEBUG(("[CAL] **************************************\n"));\r\nif (phw_data->revision == 0x2002) {\r\nhw_get_dxx_reg(phw_data, 0x54, &val);\r\nval &= 0x0000FFFF;\r\nhw_set_dxx_reg(phw_data, 0x54, val);\r\n} else {\r\nhw_get_dxx_reg(phw_data, 0x3C, &val);\r\nval &= 0x000003FF;\r\nhw_set_dxx_reg(phw_data, 0x3C, val);\r\n}\r\n}\r\n}\r\n}\r\n}\r\nhw_get_dxx_reg(phw_data, REG_MODE_CTRL, &reg_mode_ctrl);\r\nreg_mode_ctrl &= ~MASK_CALIB_START;\r\nhw_set_dxx_reg(phw_data, REG_MODE_CTRL, reg_mode_ctrl);\r\nPHY_DEBUG(("[CAL] MODE_CTRL (write) = 0x%08X\n", reg_mode_ctrl));\r\nreg_agc_ctrl3 |= BIT(2);\r\nreg_agc_ctrl3 &= ~(MASK_LNA_FIX_GAIN|MASK_AGC_FIX);\r\nhw_set_dxx_reg(phw_data, REG_AGC_CTRL3, reg_agc_ctrl3);\r\n#ifdef _DEBUG\r\nif (phw_data->revision == 0x2002) {\r\nhw_get_dxx_reg(phw_data, 0x54, &val);\r\nPHY_DEBUG(("[CAL] ** 0x54 = 0x%08X\n", val));\r\ntx_cal_reg[0] = _s4_to_s32((val & 0xF0000000) >> 28);\r\ntx_cal_reg[1] = _s4_to_s32((val & 0x0F000000) >> 24);\r\ntx_cal_reg[2] = _s4_to_s32((val & 0x00F00000) >> 20);\r\ntx_cal_reg[3] = _s4_to_s32((val & 0x000F0000) >> 16);\r\n} else {\r\nhw_get_dxx_reg(phw_data, 0x3C, &val);\r\nPHY_DEBUG(("[CAL] ** 0x3C = 0x%08X\n", val));\r\ntx_cal_reg[0] = _s5_to_s32((val & 0xF8000000) >> 27);\r\ntx_cal_reg[1] = _s6_to_s32((val & 0x07E00000) >> 21);\r\ntx_cal_reg[2] = _s6_to_s32((val & 0x001F8000) >> 15);\r\ntx_cal_reg[3] = _s5_to_s32((val & 0x00007C00) >> 10);\r\n}\r\nPHY_DEBUG(("[CAL] ** tx_cal_reg[0] = %d\n", tx_cal_reg[0]));\r\nPHY_DEBUG(("[CAL] tx_cal_reg[1] = %d\n", tx_cal_reg[1]));\r\nPHY_DEBUG(("[CAL] tx_cal_reg[2] = %d\n", tx_cal_reg[2]));\r\nPHY_DEBUG(("[CAL] tx_cal_reg[3] = %d\n", tx_cal_reg[3]));\r\n#endif\r\n}\r\nu8 _rx_iq_calibration_loop_winbond(struct hw_data *phw_data, u16 factor, u32 frequency)\r\n{\r\nu32 reg_mode_ctrl;\r\ns32 iqcal_tone_i;\r\ns32 iqcal_tone_q;\r\ns32 iqcal_image_i;\r\ns32 iqcal_image_q;\r\ns32 rot_tone_i_b;\r\ns32 rot_tone_q_b;\r\ns32 rot_image_i_b;\r\ns32 rot_image_q_b;\r\ns32 rx_cal_flt_b[4];\r\ns32 rx_cal[4];\r\ns32 rx_cal_reg[4];\r\ns32 a_2, b_2;\r\ns32 sin_b, sin_2b;\r\ns32 cos_b, cos_2b;\r\ns32 temp1, temp2;\r\nu32 val;\r\nu16 loop;\r\nu32 pwr_tone;\r\nu32 pwr_image;\r\nu8 verify_count;\r\ns32 iqcal_tone_i_avg, iqcal_tone_q_avg;\r\ns32 iqcal_image_i_avg, iqcal_image_q_avg;\r\nu16 capture_time;\r\nPHY_DEBUG(("[CAL] -> [5]_rx_iq_calibration_loop()\n"));\r\nPHY_DEBUG(("[CAL] ** factor = %d\n", factor));\r\nhw_set_dxx_reg(phw_data, 0x58, 0x44444444);\r\nhw_get_dxx_reg(phw_data, REG_MODE_CTRL, &reg_mode_ctrl);\r\nPHY_DEBUG(("[CAL] MODE_CTRL (read) = 0x%08X\n", reg_mode_ctrl));\r\nverify_count = 0;\r\nloop = LOOP_TIMES;\r\nwhile (loop > 0) {\r\nPHY_DEBUG(("[CAL] [%d.] <_rx_iq_calibration_loop>\n", (LOOP_TIMES-loop+1)));\r\niqcal_tone_i_avg = 0;\r\niqcal_tone_q_avg = 0;\r\niqcal_image_i_avg = 0;\r\niqcal_image_q_avg = 0;\r\ncapture_time = 0;\r\nfor (capture_time = 0; capture_time < 10; capture_time++) {\r\nreg_mode_ctrl &= ~MASK_CALIB_START;\r\nif (!hw_set_dxx_reg(phw_data, REG_MODE_CTRL, reg_mode_ctrl))\r\nreturn 0;\r\nPHY_DEBUG(("[CAL] MODE_CTRL (write) = 0x%08X\n", reg_mode_ctrl));\r\nreg_mode_ctrl &= ~MASK_IQCAL_MODE;\r\nreg_mode_ctrl |= (MASK_CALIB_START|0x1);\r\nhw_set_dxx_reg(phw_data, REG_MODE_CTRL, reg_mode_ctrl);\r\nPHY_DEBUG(("[CAL] MODE_CTRL (write) = 0x%08X\n", reg_mode_ctrl));\r\nhw_get_dxx_reg(phw_data, REG_CALIB_READ1, &val);\r\nPHY_DEBUG(("[CAL] CALIB_READ1 = 0x%08X\n", val));\r\niqcal_tone_i = _s13_to_s32(val & 0x00001FFF);\r\niqcal_tone_q = _s13_to_s32((val & 0x03FFE000) >> 13);\r\nPHY_DEBUG(("[CAL] ** iqcal_tone_i = %d, iqcal_tone_q = %d\n",\r\niqcal_tone_i, iqcal_tone_q));\r\nhw_get_dxx_reg(phw_data, REG_CALIB_READ2, &val);\r\nPHY_DEBUG(("[CAL] CALIB_READ2 = 0x%08X\n", val));\r\niqcal_image_i = _s13_to_s32(val & 0x00001FFF);\r\niqcal_image_q = _s13_to_s32((val & 0x03FFE000) >> 13);\r\nPHY_DEBUG(("[CAL] ** iqcal_image_i = %d, iqcal_image_q = %d\n",\r\niqcal_image_i, iqcal_image_q));\r\nif (capture_time == 0)\r\ncontinue;\r\nelse {\r\niqcal_image_i_avg = (iqcal_image_i_avg*(capture_time-1) + iqcal_image_i)/capture_time;\r\niqcal_image_q_avg = (iqcal_image_q_avg*(capture_time-1) + iqcal_image_q)/capture_time;\r\niqcal_tone_i_avg = (iqcal_tone_i_avg*(capture_time-1) + iqcal_tone_i)/capture_time;\r\niqcal_tone_q_avg = (iqcal_tone_q_avg*(capture_time-1) + iqcal_tone_q)/capture_time;\r\n}\r\n}\r\niqcal_image_i = iqcal_image_i_avg;\r\niqcal_image_q = iqcal_image_q_avg;\r\niqcal_tone_i = iqcal_tone_i_avg;\r\niqcal_tone_q = iqcal_tone_q_avg;\r\nrot_tone_i_b = (iqcal_tone_i * iqcal_tone_i +\r\niqcal_tone_q * iqcal_tone_q) / 1024;\r\nrot_tone_q_b = (iqcal_tone_i * iqcal_tone_q * (-1) +\r\niqcal_tone_q * iqcal_tone_i) / 1024;\r\nrot_image_i_b = (iqcal_image_i * iqcal_tone_i -\r\niqcal_image_q * iqcal_tone_q) / 1024;\r\nrot_image_q_b = (iqcal_image_i * iqcal_tone_q +\r\niqcal_image_q * iqcal_tone_i) / 1024;\r\nPHY_DEBUG(("[CAL] ** rot_tone_i_b = %d\n", rot_tone_i_b));\r\nPHY_DEBUG(("[CAL] ** rot_tone_q_b = %d\n", rot_tone_q_b));\r\nPHY_DEBUG(("[CAL] ** rot_image_i_b = %d\n", rot_image_i_b));\r\nPHY_DEBUG(("[CAL] ** rot_image_q_b = %d\n", rot_image_q_b));\r\nif (rot_tone_i_b == 0) {\r\nPHY_DEBUG(("[CAL] ** <_rx_iq_calibration_loop> ERROR *******\n"));\r\nPHY_DEBUG(("[CAL] ** rot_tone_i_b=0 to calculate EPS and THETA !!\n"));\r\nPHY_DEBUG(("[CAL] ******************************************\n"));\r\nbreak;\r\n}\r\na_2 = (rot_image_i_b * 32768) / rot_tone_i_b -\r\nphw_data->iq_rsdl_gain_tx_d2;\r\nb_2 = (rot_image_q_b * 32768) / rot_tone_i_b -\r\nphw_data->iq_rsdl_phase_tx_d2;\r\nPHY_DEBUG(("[CAL] ** iq_rsdl_gain_tx_d2 = %d\n", phw_data->iq_rsdl_gain_tx_d2));\r\nPHY_DEBUG(("[CAL] ** iq_rsdl_phase_tx_d2= %d\n", phw_data->iq_rsdl_phase_tx_d2));\r\nPHY_DEBUG(("[CAL] ***** EPSILON/2 = %d\n", a_2));\r\nPHY_DEBUG(("[CAL] ***** THETA/2 = %d\n", b_2));\r\n_sin_cos(b_2, &sin_b, &cos_b);\r\n_sin_cos(b_2*2, &sin_2b, &cos_2b);\r\nPHY_DEBUG(("[CAL] ** sin(b/2)=%d, cos(b/2)=%d\n", sin_b, cos_b));\r\nPHY_DEBUG(("[CAL] ** sin(b)=%d, cos(b)=%d\n", sin_2b, cos_2b));\r\nif (cos_2b == 0) {\r\nPHY_DEBUG(("[CAL] ** <_rx_iq_calibration_loop> ERROR *******\n"));\r\nPHY_DEBUG(("[CAL] ** cos(b)=0 !!\n"));\r\nPHY_DEBUG(("[CAL] ******************************************\n"));\r\nbreak;\r\n}\r\ntemp1 = (41943040/cos_2b)*cos_b;\r\nif (phw_data->revision == 0x2002)\r\ntemp2 = (41943040/cos_2b)*sin_b*(-1);\r\nelse\r\ntemp2 = (41943040*4/cos_2b)*sin_b*(-1);\r\nrx_cal_flt_b[0] = _floor(temp1/(32768+a_2));\r\nrx_cal_flt_b[1] = _floor(temp2/(32768-a_2));\r\nrx_cal_flt_b[2] = _floor(temp2/(32768+a_2));\r\nrx_cal_flt_b[3] = _floor(temp1/(32768-a_2));\r\nPHY_DEBUG(("[CAL] ** rx_cal_flt_b[0] = %d\n", rx_cal_flt_b[0]));\r\nPHY_DEBUG(("[CAL] rx_cal_flt_b[1] = %d\n", rx_cal_flt_b[1]));\r\nPHY_DEBUG(("[CAL] rx_cal_flt_b[2] = %d\n", rx_cal_flt_b[2]));\r\nPHY_DEBUG(("[CAL] rx_cal_flt_b[3] = %d\n", rx_cal_flt_b[3]));\r\nrx_cal[0] = rx_cal_flt_b[0] - 128;\r\nrx_cal[1] = rx_cal_flt_b[1];\r\nrx_cal[2] = rx_cal_flt_b[2];\r\nrx_cal[3] = rx_cal_flt_b[3] - 128;\r\nPHY_DEBUG(("[CAL] ** rx_cal[0] = %d\n", rx_cal[0]));\r\nPHY_DEBUG(("[CAL] rx_cal[1] = %d\n", rx_cal[1]));\r\nPHY_DEBUG(("[CAL] rx_cal[2] = %d\n", rx_cal[2]));\r\nPHY_DEBUG(("[CAL] rx_cal[3] = %d\n", rx_cal[3]));\r\npwr_tone = (iqcal_tone_i*iqcal_tone_i + iqcal_tone_q*iqcal_tone_q);\r\npwr_image = (iqcal_image_i*iqcal_image_i + iqcal_image_q*iqcal_image_q)*factor;\r\nPHY_DEBUG(("[CAL] ** pwr_tone = %d\n", pwr_tone));\r\nPHY_DEBUG(("[CAL] ** pwr_image = %d\n", pwr_image));\r\nif (pwr_tone > pwr_image) {\r\nverify_count++;\r\nPHY_DEBUG(("[CAL] ** <_rx_iq_calibration_loop> *************\n"));\r\nPHY_DEBUG(("[CAL] ** VERIFY OK # %d !!\n", verify_count));\r\nPHY_DEBUG(("[CAL] ******************************************\n"));\r\nif (verify_count > 2) {\r\nPHY_DEBUG(("[CAL] ** <_rx_iq_calibration_loop> *********\n"));\r\nPHY_DEBUG(("[CAL] ** RX_IQ_CALIBRATION OK !!\n"));\r\nPHY_DEBUG(("[CAL] **************************************\n"));\r\nreturn 0;\r\n}\r\ncontinue;\r\n}\r\nhw_get_dxx_reg(phw_data, 0x54, &val);\r\nPHY_DEBUG(("[CAL] ** 0x54 = 0x%08X\n", val));\r\nif (phw_data->revision == 0x2002) {\r\nrx_cal_reg[0] = _s4_to_s32((val & 0x0000F000) >> 12);\r\nrx_cal_reg[1] = _s4_to_s32((val & 0x00000F00) >> 8);\r\nrx_cal_reg[2] = _s4_to_s32((val & 0x000000F0) >> 4);\r\nrx_cal_reg[3] = _s4_to_s32((val & 0x0000000F));\r\n} else {\r\nrx_cal_reg[0] = _s5_to_s32((val & 0xF8000000) >> 27);\r\nrx_cal_reg[1] = _s6_to_s32((val & 0x07E00000) >> 21);\r\nrx_cal_reg[2] = _s6_to_s32((val & 0x001F8000) >> 15);\r\nrx_cal_reg[3] = _s5_to_s32((val & 0x00007C00) >> 10);\r\n}\r\nPHY_DEBUG(("[CAL] ** rx_cal_reg[0] = %d\n", rx_cal_reg[0]));\r\nPHY_DEBUG(("[CAL] rx_cal_reg[1] = %d\n", rx_cal_reg[1]));\r\nPHY_DEBUG(("[CAL] rx_cal_reg[2] = %d\n", rx_cal_reg[2]));\r\nPHY_DEBUG(("[CAL] rx_cal_reg[3] = %d\n", rx_cal_reg[3]));\r\nif (phw_data->revision == 0x2002) {\r\nif (((rx_cal_reg[0] == 7) || (rx_cal_reg[0] == (-8))) &&\r\n((rx_cal_reg[3] == 7) || (rx_cal_reg[3] == (-8)))) {\r\nPHY_DEBUG(("[CAL] ** <_rx_iq_calibration_loop> *********\n"));\r\nPHY_DEBUG(("[CAL] ** RX_IQ_CALIBRATION SATUATION !!\n"));\r\nPHY_DEBUG(("[CAL] **************************************\n"));\r\nbreak;\r\n}\r\n} else {\r\nif (((rx_cal_reg[0] == 31) || (rx_cal_reg[0] == (-32))) &&\r\n((rx_cal_reg[3] == 31) || (rx_cal_reg[3] == (-32)))) {\r\nPHY_DEBUG(("[CAL] ** <_rx_iq_calibration_loop> *********\n"));\r\nPHY_DEBUG(("[CAL] ** RX_IQ_CALIBRATION SATUATION !!\n"));\r\nPHY_DEBUG(("[CAL] **************************************\n"));\r\nbreak;\r\n}\r\n}\r\nrx_cal[0] = rx_cal[0] + rx_cal_reg[0];\r\nrx_cal[1] = rx_cal[1] + rx_cal_reg[1];\r\nrx_cal[2] = rx_cal[2] + rx_cal_reg[2];\r\nrx_cal[3] = rx_cal[3] + rx_cal_reg[3];\r\nPHY_DEBUG(("[CAL] ** apply rx_cal[0] = %d\n", rx_cal[0]));\r\nPHY_DEBUG(("[CAL] apply rx_cal[1] = %d\n", rx_cal[1]));\r\nPHY_DEBUG(("[CAL] apply rx_cal[2] = %d\n", rx_cal[2]));\r\nPHY_DEBUG(("[CAL] apply rx_cal[3] = %d\n", rx_cal[3]));\r\nhw_get_dxx_reg(phw_data, 0x54, &val);\r\nif (phw_data->revision == 0x2002) {\r\nval &= 0x0000FFFF;\r\nval |= ((_s32_to_s4(rx_cal[0]) << 12)|\r\n(_s32_to_s4(rx_cal[1]) << 8)|\r\n(_s32_to_s4(rx_cal[2]) << 4)|\r\n(_s32_to_s4(rx_cal[3])));\r\nhw_set_dxx_reg(phw_data, 0x54, val);\r\n} else {\r\nval &= 0x000003FF;\r\nval |= ((_s32_to_s5(rx_cal[0]) << 27)|\r\n(_s32_to_s6(rx_cal[1]) << 21)|\r\n(_s32_to_s6(rx_cal[2]) << 15)|\r\n(_s32_to_s5(rx_cal[3]) << 10));\r\nhw_set_dxx_reg(phw_data, 0x54, val);\r\nif (loop == 3)\r\nreturn 0;\r\n}\r\nPHY_DEBUG(("[CAL] ** CALIB_DATA = 0x%08X\n", val));\r\nloop--;\r\n}\r\nreturn 1;\r\n}\r\nvoid _rx_iq_calibration_winbond(struct hw_data *phw_data, u32 frequency)\r\n{\r\n#ifdef _DEBUG\r\ns32 rx_cal_reg[4];\r\nu32 val;\r\n#endif\r\nu8 result;\r\nPHY_DEBUG(("[CAL] -> [5]_rx_iq_calibration()\n"));\r\nphy_set_rf_data(phw_data, 1, (1<<24)|0xEFBFC2);\r\nphy_set_rf_data(phw_data, 11, (11<<24)|0x1A05D6);\r\nphy_set_rf_data(phw_data, 5, (5<<24) | phw_data->txvga_setting_for_cal);\r\nphy_set_rf_data(phw_data, 6, (6<<24)|0x06834C);\r\nphy_set_rf_data(phw_data, 0, (0<<24)|0xFFF1C0);\r\nresult = _rx_iq_calibration_loop_winbond(phw_data, 12589, frequency);\r\nif (result > 0) {\r\n_reset_rx_cal(phw_data);\r\nresult = _rx_iq_calibration_loop_winbond(phw_data, 7943, frequency);\r\nif (result > 0) {\r\n_reset_rx_cal(phw_data);\r\nresult = _rx_iq_calibration_loop_winbond(phw_data, 5011, frequency);\r\nif (result > 0) {\r\nPHY_DEBUG(("[CAL] ** <_rx_iq_calibration> **************\n"));\r\nPHY_DEBUG(("[CAL] ** RX_IQ_CALIBRATION FAILURE !!\n"));\r\nPHY_DEBUG(("[CAL] **************************************\n"));\r\n_reset_rx_cal(phw_data);\r\n}\r\n}\r\n}\r\n#ifdef _DEBUG\r\nhw_get_dxx_reg(phw_data, 0x54, &val);\r\nPHY_DEBUG(("[CAL] ** 0x54 = 0x%08X\n", val));\r\nif (phw_data->revision == 0x2002) {\r\nrx_cal_reg[0] = _s4_to_s32((val & 0x0000F000) >> 12);\r\nrx_cal_reg[1] = _s4_to_s32((val & 0x00000F00) >> 8);\r\nrx_cal_reg[2] = _s4_to_s32((val & 0x000000F0) >> 4);\r\nrx_cal_reg[3] = _s4_to_s32((val & 0x0000000F));\r\n} else {\r\nrx_cal_reg[0] = _s5_to_s32((val & 0xF8000000) >> 27);\r\nrx_cal_reg[1] = _s6_to_s32((val & 0x07E00000) >> 21);\r\nrx_cal_reg[2] = _s6_to_s32((val & 0x001F8000) >> 15);\r\nrx_cal_reg[3] = _s5_to_s32((val & 0x00007C00) >> 10);\r\n}\r\nPHY_DEBUG(("[CAL] ** rx_cal_reg[0] = %d\n", rx_cal_reg[0]));\r\nPHY_DEBUG(("[CAL] rx_cal_reg[1] = %d\n", rx_cal_reg[1]));\r\nPHY_DEBUG(("[CAL] rx_cal_reg[2] = %d\n", rx_cal_reg[2]));\r\nPHY_DEBUG(("[CAL] rx_cal_reg[3] = %d\n", rx_cal_reg[3]));\r\n#endif\r\n}\r\nvoid phy_calibration_winbond(struct hw_data *phw_data, u32 frequency)\r\n{\r\nu32 reg_mode_ctrl;\r\nu32 iq_alpha;\r\nPHY_DEBUG(("[CAL] -> phy_calibration_winbond()\n"));\r\nhw_get_dxx_reg(phw_data, 0x58, &iq_alpha);\r\n_rxadc_dc_offset_cancellation_winbond(phw_data, frequency);\r\n_tx_iq_calibration_winbond(phw_data);\r\n_rx_iq_calibration_winbond(phw_data, frequency);\r\nhw_get_dxx_reg(phw_data, REG_MODE_CTRL, &reg_mode_ctrl);\r\nreg_mode_ctrl &= ~(MASK_IQCAL_TONE_SEL|MASK_IQCAL_MODE|MASK_CALIB_START);\r\nhw_set_dxx_reg(phw_data, REG_MODE_CTRL, reg_mode_ctrl);\r\nPHY_DEBUG(("[CAL] MODE_CTRL (write) = 0x%08X\n", reg_mode_ctrl));\r\nhw_set_dxx_reg(phw_data, 0x58, iq_alpha);\r\nphy_init_rf(phw_data);\r\n}\r\nvoid phy_set_rf_data(struct hw_data *pHwData, u32 index, u32 value)\r\n{\r\nu32 ltmp = 0;\r\nswitch (pHwData->phy_type) {\r\ncase RF_MAXIM_2825:\r\ncase RF_MAXIM_V1:\r\nltmp = (1 << 31) | (0 << 30) | (18 << 24) | BitReverse(value, 18);\r\nbreak;\r\ncase RF_MAXIM_2827:\r\nltmp = (1 << 31) | (0 << 30) | (18 << 24) | BitReverse(value, 18);\r\nbreak;\r\ncase RF_MAXIM_2828:\r\nltmp = (1 << 31) | (0 << 30) | (18 << 24) | BitReverse(value, 18);\r\nbreak;\r\ncase RF_MAXIM_2829:\r\nltmp = (1 << 31) | (0 << 30) | (18 << 24) | BitReverse(value, 18);\r\nbreak;\r\ncase RF_AIROHA_2230:\r\ncase RF_AIROHA_2230S:\r\nltmp = (1 << 31) | (0 << 30) | (20 << 24) | BitReverse(value, 20);\r\nbreak;\r\ncase RF_AIROHA_7230:\r\nltmp = (1 << 31) | (0 << 30) | (24 << 24) | (value&0xffffff);\r\nbreak;\r\ncase RF_WB_242:\r\ncase RF_WB_242_1:\r\nltmp = (1 << 31) | (0 << 30) | (24 << 24) | BitReverse(value, 24);\r\nbreak;\r\n}\r\nWb35Reg_WriteSync(pHwData, 0x0864, ltmp);\r\n}\r\nunsigned char adjust_TXVGA_for_iq_mag(struct hw_data *phw_data)\r\n{\r\nint init_txvga = 0;\r\nu32 reg_mode_ctrl;\r\nu32 val;\r\ns32 iqcal_tone_i0;\r\ns32 iqcal_tone_q0;\r\nu32 sqsum;\r\ns32 iq_mag_0_tx;\r\nu8 reg_state;\r\nint current_txvga;\r\nreg_state = 0;\r\nfor (init_txvga = 0; init_txvga < 10; init_txvga++) {\r\ncurrent_txvga = (0x24C40A|(init_txvga<<6));\r\nphy_set_rf_data(phw_data, 5, ((5<<24)|current_txvga));\r\nphw_data->txvga_setting_for_cal = current_txvga;\r\nmsleep(30);\r\nif (!hw_get_dxx_reg(phw_data, REG_MODE_CTRL, &reg_mode_ctrl))\r\nreturn false;\r\nPHY_DEBUG(("[CAL] MODE_CTRL (read) = 0x%08X\n", reg_mode_ctrl));\r\nreg_mode_ctrl &= ~(MASK_IQCAL_TONE_SEL|MASK_IQCAL_MODE);\r\nreg_mode_ctrl &= ~MASK_IQCAL_MODE;\r\nreg_mode_ctrl |= (MASK_CALIB_START|0x02);\r\nreg_mode_ctrl |= (MASK_CALIB_START|0x02|2<<2);\r\nhw_set_dxx_reg(phw_data, REG_MODE_CTRL, reg_mode_ctrl);\r\nPHY_DEBUG(("[CAL] MODE_CTRL (write) = 0x%08X\n", reg_mode_ctrl));\r\nudelay(1);\r\nudelay(300);\r\nhw_get_dxx_reg(phw_data, REG_CALIB_READ1, &val);\r\nPHY_DEBUG(("[CAL] CALIB_READ1 = 0x%08X\n", val));\r\nudelay(300);\r\niqcal_tone_i0 = _s13_to_s32(val & 0x00001FFF);\r\niqcal_tone_q0 = _s13_to_s32((val & 0x03FFE000) >> 13);\r\nPHY_DEBUG(("[CAL] ** iqcal_tone_i0=%d, iqcal_tone_q0=%d\n",\r\niqcal_tone_i0, iqcal_tone_q0));\r\nsqsum = iqcal_tone_i0*iqcal_tone_i0 + iqcal_tone_q0*iqcal_tone_q0;\r\niq_mag_0_tx = (s32) _sqrt(sqsum);\r\nPHY_DEBUG(("[CAL] ** auto_adjust_txvga_for_iq_mag_0_tx=%d\n", iq_mag_0_tx));\r\nif (iq_mag_0_tx >= 700 && iq_mag_0_tx <= 1750)\r\nbreak;\r\nelse if (iq_mag_0_tx > 1750) {\r\ninit_txvga = -2;\r\ncontinue;\r\n} else\r\ncontinue;\r\n}\r\nif (iq_mag_0_tx >= 700 && iq_mag_0_tx <= 1750)\r\nreturn true;\r\nelse\r\nreturn false;\r\n}

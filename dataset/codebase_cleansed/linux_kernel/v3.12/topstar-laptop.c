static void acpi_topstar_notify(struct acpi_device *device, u32 event)\r\n{\r\nstatic bool dup_evnt[2];\r\nbool *dup;\r\nstruct topstar_hkey *hkey = acpi_driver_data(device);\r\nif (event == 0x83 || event == 0x84) {\r\ndup = &dup_evnt[event - 0x83];\r\nif (*dup) {\r\n*dup = false;\r\nreturn;\r\n}\r\n*dup = true;\r\n}\r\nif (!sparse_keymap_report_event(hkey->inputdev, event, 1, true))\r\npr_info("unknown event = 0x%02x\n", event);\r\n}\r\nstatic int acpi_topstar_fncx_switch(struct acpi_device *device, bool state)\r\n{\r\nacpi_status status;\r\nunion acpi_object fncx_params[1] = {\r\n{ .type = ACPI_TYPE_INTEGER }\r\n};\r\nstruct acpi_object_list fncx_arg_list = { 1, &fncx_params[0] };\r\nfncx_params[0].integer.value = state ? 0x86 : 0x87;\r\nstatus = acpi_evaluate_object(device->handle, "FNCX", &fncx_arg_list, NULL);\r\nif (ACPI_FAILURE(status)) {\r\npr_err("Unable to switch FNCX notifications\n");\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic int acpi_topstar_init_hkey(struct topstar_hkey *hkey)\r\n{\r\nstruct input_dev *input;\r\nint error;\r\ninput = input_allocate_device();\r\nif (!input) {\r\npr_err("Unable to allocate input device\n");\r\nreturn -ENOMEM;\r\n}\r\ninput->name = "Topstar Laptop extra buttons";\r\ninput->phys = "topstar/input0";\r\ninput->id.bustype = BUS_HOST;\r\nerror = sparse_keymap_setup(input, topstar_keymap, NULL);\r\nif (error) {\r\npr_err("Unable to setup input device keymap\n");\r\ngoto err_free_dev;\r\n}\r\nerror = input_register_device(input);\r\nif (error) {\r\npr_err("Unable to register input device\n");\r\ngoto err_free_keymap;\r\n}\r\nhkey->inputdev = input;\r\nreturn 0;\r\nerr_free_keymap:\r\nsparse_keymap_free(input);\r\nerr_free_dev:\r\ninput_free_device(input);\r\nreturn error;\r\n}\r\nstatic int acpi_topstar_add(struct acpi_device *device)\r\n{\r\nstruct topstar_hkey *tps_hkey;\r\ntps_hkey = kzalloc(sizeof(struct topstar_hkey), GFP_KERNEL);\r\nif (!tps_hkey)\r\nreturn -ENOMEM;\r\nstrcpy(acpi_device_name(device), "Topstar TPSACPI");\r\nstrcpy(acpi_device_class(device), ACPI_TOPSTAR_CLASS);\r\nif (acpi_topstar_fncx_switch(device, true))\r\ngoto add_err;\r\nif (acpi_topstar_init_hkey(tps_hkey))\r\ngoto add_err;\r\ndevice->driver_data = tps_hkey;\r\nreturn 0;\r\nadd_err:\r\nkfree(tps_hkey);\r\nreturn -ENODEV;\r\n}\r\nstatic int acpi_topstar_remove(struct acpi_device *device)\r\n{\r\nstruct topstar_hkey *tps_hkey = acpi_driver_data(device);\r\nacpi_topstar_fncx_switch(device, false);\r\nsparse_keymap_free(tps_hkey->inputdev);\r\ninput_unregister_device(tps_hkey->inputdev);\r\nkfree(tps_hkey);\r\nreturn 0;\r\n}

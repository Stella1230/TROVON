static inline int sht21_temp_ticks_to_millicelsius(int ticks)\r\n{\r\nticks &= ~0x0003;\r\nreturn ((21965 * ticks) >> 13) - 46850;\r\n}\r\nstatic inline int sht21_rh_ticks_to_per_cent_mille(int ticks)\r\n{\r\nticks &= ~0x0003;\r\nreturn ((15625 * ticks) >> 13) - 6000;\r\n}\r\nstatic int sht21_update_measurements(struct i2c_client *client)\r\n{\r\nint ret = 0;\r\nstruct sht21 *sht21 = i2c_get_clientdata(client);\r\nmutex_lock(&sht21->lock);\r\nif (time_after(jiffies, sht21->last_update + HZ / 2) || !sht21->valid) {\r\nret = i2c_smbus_read_word_swapped(client,\r\nSHT21_TRIG_T_MEASUREMENT_HM);\r\nif (ret < 0)\r\ngoto out;\r\nsht21->temperature = sht21_temp_ticks_to_millicelsius(ret);\r\nret = i2c_smbus_read_word_swapped(client,\r\nSHT21_TRIG_RH_MEASUREMENT_HM);\r\nif (ret < 0)\r\ngoto out;\r\nsht21->humidity = sht21_rh_ticks_to_per_cent_mille(ret);\r\nsht21->last_update = jiffies;\r\nsht21->valid = 1;\r\n}\r\nout:\r\nmutex_unlock(&sht21->lock);\r\nreturn ret >= 0 ? 0 : ret;\r\n}\r\nstatic ssize_t sht21_show_temperature(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct sht21 *sht21 = i2c_get_clientdata(client);\r\nint ret = sht21_update_measurements(client);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn sprintf(buf, "%d\n", sht21->temperature);\r\n}\r\nstatic ssize_t sht21_show_humidity(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct sht21 *sht21 = i2c_get_clientdata(client);\r\nint ret = sht21_update_measurements(client);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn sprintf(buf, "%d\n", sht21->humidity);\r\n}\r\nstatic int sht21_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct sht21 *sht21;\r\nint err;\r\nif (!i2c_check_functionality(client->adapter,\r\nI2C_FUNC_SMBUS_WORD_DATA)) {\r\ndev_err(&client->dev,\r\n"adapter does not support SMBus word transactions\n");\r\nreturn -ENODEV;\r\n}\r\nsht21 = devm_kzalloc(&client->dev, sizeof(*sht21), GFP_KERNEL);\r\nif (!sht21)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(client, sht21);\r\nmutex_init(&sht21->lock);\r\nerr = sysfs_create_group(&client->dev.kobj, &sht21_attr_group);\r\nif (err) {\r\ndev_dbg(&client->dev, "could not create sysfs files\n");\r\nreturn err;\r\n}\r\nsht21->hwmon_dev = hwmon_device_register(&client->dev);\r\nif (IS_ERR(sht21->hwmon_dev)) {\r\ndev_dbg(&client->dev, "unable to register hwmon device\n");\r\nerr = PTR_ERR(sht21->hwmon_dev);\r\ngoto fail_remove_sysfs;\r\n}\r\ndev_info(&client->dev, "initialized\n");\r\nreturn 0;\r\nfail_remove_sysfs:\r\nsysfs_remove_group(&client->dev.kobj, &sht21_attr_group);\r\nreturn err;\r\n}\r\nstatic int sht21_remove(struct i2c_client *client)\r\n{\r\nstruct sht21 *sht21 = i2c_get_clientdata(client);\r\nhwmon_device_unregister(sht21->hwmon_dev);\r\nsysfs_remove_group(&client->dev.kobj, &sht21_attr_group);\r\nreturn 0;\r\n}

static void report_key_event(struct input_dev *input, int keycode)\r\n{\r\ninput_report_key(input, keycode, 1);\r\ninput_sync(input);\r\ninput_report_key(input, keycode, 0);\r\ninput_sync(input);\r\n}\r\nstatic void report_rotary_event(struct bfin_rot *rotary, int delta)\r\n{\r\nstruct input_dev *input = rotary->input;\r\nif (rotary->up_key) {\r\nreport_key_event(input,\r\ndelta > 0 ? rotary->up_key : rotary->down_key);\r\n} else {\r\ninput_report_rel(input, rotary->rel_code, delta);\r\ninput_sync(input);\r\n}\r\n}\r\nstatic irqreturn_t bfin_rotary_isr(int irq, void *dev_id)\r\n{\r\nstruct platform_device *pdev = dev_id;\r\nstruct bfin_rot *rotary = platform_get_drvdata(pdev);\r\nint delta;\r\nswitch (bfin_read_CNT_STATUS()) {\r\ncase ICII:\r\nbreak;\r\ncase UCII:\r\ncase DCII:\r\ndelta = bfin_read_CNT_COUNTER();\r\nif (delta)\r\nreport_rotary_event(rotary, delta);\r\nbreak;\r\ncase CZMII:\r\nreport_key_event(rotary->input, rotary->button_key);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbfin_write_CNT_COMMAND(W1LCNT_ZERO);\r\nbfin_write_CNT_STATUS(-1);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int bfin_rotary_probe(struct platform_device *pdev)\r\n{\r\nstruct bfin_rotary_platform_data *pdata = pdev->dev.platform_data;\r\nstruct bfin_rot *rotary;\r\nstruct input_dev *input;\r\nint error;\r\nif ((pdata->rotary_up_key && !pdata->rotary_down_key) ||\r\n(!pdata->rotary_up_key && pdata->rotary_down_key)) {\r\nreturn -EINVAL;\r\n}\r\nerror = peripheral_request_list(per_cnt, dev_name(&pdev->dev));\r\nif (error) {\r\ndev_err(&pdev->dev, "requesting peripherals failed\n");\r\nreturn error;\r\n}\r\nrotary = kzalloc(sizeof(struct bfin_rot), GFP_KERNEL);\r\ninput = input_allocate_device();\r\nif (!rotary || !input) {\r\nerror = -ENOMEM;\r\ngoto out1;\r\n}\r\nrotary->input = input;\r\nrotary->up_key = pdata->rotary_up_key;\r\nrotary->down_key = pdata->rotary_down_key;\r\nrotary->button_key = pdata->rotary_button_key;\r\nrotary->rel_code = pdata->rotary_rel_code;\r\nerror = rotary->irq = platform_get_irq(pdev, 0);\r\nif (error < 0)\r\ngoto out1;\r\ninput->name = pdev->name;\r\ninput->phys = "bfin-rotary/input0";\r\ninput->dev.parent = &pdev->dev;\r\ninput_set_drvdata(input, rotary);\r\ninput->id.bustype = BUS_HOST;\r\ninput->id.vendor = 0x0001;\r\ninput->id.product = 0x0001;\r\ninput->id.version = 0x0100;\r\nif (rotary->up_key) {\r\n__set_bit(EV_KEY, input->evbit);\r\n__set_bit(rotary->up_key, input->keybit);\r\n__set_bit(rotary->down_key, input->keybit);\r\n} else {\r\n__set_bit(EV_REL, input->evbit);\r\n__set_bit(rotary->rel_code, input->relbit);\r\n}\r\nif (rotary->button_key) {\r\n__set_bit(EV_KEY, input->evbit);\r\n__set_bit(rotary->button_key, input->keybit);\r\n}\r\nerror = request_irq(rotary->irq, bfin_rotary_isr,\r\n0, dev_name(&pdev->dev), pdev);\r\nif (error) {\r\ndev_err(&pdev->dev,\r\n"unable to claim irq %d; error %d\n",\r\nrotary->irq, error);\r\ngoto out1;\r\n}\r\nerror = input_register_device(input);\r\nif (error) {\r\ndev_err(&pdev->dev,\r\n"unable to register input device (%d)\n", error);\r\ngoto out2;\r\n}\r\nif (pdata->rotary_button_key)\r\nbfin_write_CNT_IMASK(CZMIE);\r\nif (pdata->mode & ROT_DEBE)\r\nbfin_write_CNT_DEBOUNCE(pdata->debounce & DPRESCALE);\r\nif (pdata->mode)\r\nbfin_write_CNT_CONFIG(bfin_read_CNT_CONFIG() |\r\n(pdata->mode & ~CNTE));\r\nbfin_write_CNT_IMASK(bfin_read_CNT_IMASK() | UCIE | DCIE);\r\nbfin_write_CNT_CONFIG(bfin_read_CNT_CONFIG() | CNTE);\r\nplatform_set_drvdata(pdev, rotary);\r\ndevice_init_wakeup(&pdev->dev, 1);\r\nreturn 0;\r\nout2:\r\nfree_irq(rotary->irq, pdev);\r\nout1:\r\ninput_free_device(input);\r\nkfree(rotary);\r\nperipheral_free_list(per_cnt);\r\nreturn error;\r\n}\r\nstatic int bfin_rotary_remove(struct platform_device *pdev)\r\n{\r\nstruct bfin_rot *rotary = platform_get_drvdata(pdev);\r\nbfin_write_CNT_CONFIG(0);\r\nbfin_write_CNT_IMASK(0);\r\nfree_irq(rotary->irq, pdev);\r\ninput_unregister_device(rotary->input);\r\nperipheral_free_list(per_cnt);\r\nkfree(rotary);\r\nreturn 0;\r\n}\r\nstatic int bfin_rotary_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct bfin_rot *rotary = platform_get_drvdata(pdev);\r\nrotary->cnt_config = bfin_read_CNT_CONFIG();\r\nrotary->cnt_imask = bfin_read_CNT_IMASK();\r\nrotary->cnt_debounce = bfin_read_CNT_DEBOUNCE();\r\nif (device_may_wakeup(&pdev->dev))\r\nenable_irq_wake(rotary->irq);\r\nreturn 0;\r\n}\r\nstatic int bfin_rotary_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct bfin_rot *rotary = platform_get_drvdata(pdev);\r\nbfin_write_CNT_DEBOUNCE(rotary->cnt_debounce);\r\nbfin_write_CNT_IMASK(rotary->cnt_imask);\r\nbfin_write_CNT_CONFIG(rotary->cnt_config & ~CNTE);\r\nif (device_may_wakeup(&pdev->dev))\r\ndisable_irq_wake(rotary->irq);\r\nif (rotary->cnt_config & CNTE)\r\nbfin_write_CNT_CONFIG(rotary->cnt_config);\r\nreturn 0;\r\n}

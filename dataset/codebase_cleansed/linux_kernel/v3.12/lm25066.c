static int lm25066_read_word_data(struct i2c_client *client, int page, int reg)\r\n{\r\nconst struct pmbus_driver_info *info = pmbus_get_driver_info(client);\r\nconst struct lm25066_data *data = to_lm25066_data(info);\r\nint ret;\r\nswitch (reg) {\r\ncase PMBUS_VIRT_READ_VMON:\r\nret = pmbus_read_word_data(client, 0, LM25066_READ_VAUX);\r\nif (ret < 0)\r\nbreak;\r\nswitch (data->id) {\r\ncase lm25056:\r\nret = DIV_ROUND_CLOSEST(ret * 293, 6140);\r\nbreak;\r\ncase lm25066:\r\nret = DIV_ROUND_CLOSEST(ret * 2832, 45400);\r\nbreak;\r\ncase lm5064:\r\nret = DIV_ROUND_CLOSEST(ret * 70, 453);\r\nbreak;\r\ncase lm5066:\r\nret = DIV_ROUND_CLOSEST(ret * 725, 2180);\r\nbreak;\r\n}\r\nbreak;\r\ncase PMBUS_READ_IIN:\r\nret = pmbus_read_word_data(client, 0, LM25066_MFR_READ_IIN);\r\nbreak;\r\ncase PMBUS_READ_PIN:\r\nret = pmbus_read_word_data(client, 0, LM25066_MFR_READ_PIN);\r\nbreak;\r\ncase PMBUS_IIN_OC_WARN_LIMIT:\r\nret = pmbus_read_word_data(client, 0,\r\nLM25066_MFR_IIN_OC_WARN_LIMIT);\r\nbreak;\r\ncase PMBUS_PIN_OP_WARN_LIMIT:\r\nret = pmbus_read_word_data(client, 0,\r\nLM25066_MFR_PIN_OP_WARN_LIMIT);\r\nbreak;\r\ncase PMBUS_VIRT_READ_VIN_AVG:\r\nret = pmbus_read_word_data(client, 0, LM25066_READ_AVG_VIN);\r\nbreak;\r\ncase PMBUS_VIRT_READ_VOUT_AVG:\r\nret = pmbus_read_word_data(client, 0, LM25066_READ_AVG_VOUT);\r\nbreak;\r\ncase PMBUS_VIRT_READ_IIN_AVG:\r\nret = pmbus_read_word_data(client, 0, LM25066_READ_AVG_IIN);\r\nbreak;\r\ncase PMBUS_VIRT_READ_PIN_AVG:\r\nret = pmbus_read_word_data(client, 0, LM25066_READ_AVG_PIN);\r\nbreak;\r\ncase PMBUS_VIRT_READ_PIN_MAX:\r\nret = pmbus_read_word_data(client, 0, LM25066_READ_PIN_PEAK);\r\nbreak;\r\ncase PMBUS_VIRT_RESET_PIN_HISTORY:\r\nret = 0;\r\nbreak;\r\ndefault:\r\nret = -ENODATA;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int lm25056_read_word_data(struct i2c_client *client, int page, int reg)\r\n{\r\nint ret;\r\nswitch (reg) {\r\ncase PMBUS_VIRT_VMON_UV_WARN_LIMIT:\r\nret = pmbus_read_word_data(client, 0,\r\nLM25056_VAUX_UV_WARN_LIMIT);\r\nif (ret < 0)\r\nbreak;\r\nret = DIV_ROUND_CLOSEST(ret * 293, 6140);\r\nbreak;\r\ncase PMBUS_VIRT_VMON_OV_WARN_LIMIT:\r\nret = pmbus_read_word_data(client, 0,\r\nLM25056_VAUX_OV_WARN_LIMIT);\r\nif (ret < 0)\r\nbreak;\r\nret = DIV_ROUND_CLOSEST(ret * 293, 6140);\r\nbreak;\r\ndefault:\r\nret = lm25066_read_word_data(client, page, reg);\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int lm25056_read_byte_data(struct i2c_client *client, int page, int reg)\r\n{\r\nint ret, s;\r\nswitch (reg) {\r\ncase PMBUS_VIRT_STATUS_VMON:\r\nret = pmbus_read_byte_data(client, 0,\r\nPMBUS_STATUS_MFR_SPECIFIC);\r\nif (ret < 0)\r\nbreak;\r\ns = 0;\r\nif (ret & LM25056_MFR_STS_VAUX_UV_WARN)\r\ns |= PB_VOLTAGE_UV_WARNING;\r\nif (ret & LM25056_MFR_STS_VAUX_OV_WARN)\r\ns |= PB_VOLTAGE_OV_WARNING;\r\nret = s;\r\nbreak;\r\ndefault:\r\nret = -ENODATA;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int lm25066_write_word_data(struct i2c_client *client, int page, int reg,\r\nu16 word)\r\n{\r\nint ret;\r\nswitch (reg) {\r\ncase PMBUS_VOUT_UV_WARN_LIMIT:\r\ncase PMBUS_OT_FAULT_LIMIT:\r\ncase PMBUS_OT_WARN_LIMIT:\r\ncase PMBUS_VIN_UV_WARN_LIMIT:\r\ncase PMBUS_VIN_OV_WARN_LIMIT:\r\nword = ((s16)word < 0) ? 0 : clamp_val(word, 0, 0x0fff);\r\nret = pmbus_write_word_data(client, 0, reg, word);\r\npmbus_clear_cache(client);\r\nbreak;\r\ncase PMBUS_IIN_OC_WARN_LIMIT:\r\nword = ((s16)word < 0) ? 0 : clamp_val(word, 0, 0x0fff);\r\nret = pmbus_write_word_data(client, 0,\r\nLM25066_MFR_IIN_OC_WARN_LIMIT,\r\nword);\r\npmbus_clear_cache(client);\r\nbreak;\r\ncase PMBUS_PIN_OP_WARN_LIMIT:\r\nword = ((s16)word < 0) ? 0 : clamp_val(word, 0, 0x0fff);\r\nret = pmbus_write_word_data(client, 0,\r\nLM25066_MFR_PIN_OP_WARN_LIMIT,\r\nword);\r\npmbus_clear_cache(client);\r\nbreak;\r\ncase PMBUS_VIRT_VMON_UV_WARN_LIMIT:\r\nword = DIV_ROUND_CLOSEST((int)word * 6140, 293);\r\nword = ((s16)word < 0) ? 0 : clamp_val(word, 0, 0x0fff);\r\nret = pmbus_write_word_data(client, 0,\r\nLM25056_VAUX_UV_WARN_LIMIT, word);\r\npmbus_clear_cache(client);\r\nbreak;\r\ncase PMBUS_VIRT_VMON_OV_WARN_LIMIT:\r\nword = DIV_ROUND_CLOSEST((int)word * 6140, 293);\r\nword = ((s16)word < 0) ? 0 : clamp_val(word, 0, 0x0fff);\r\nret = pmbus_write_word_data(client, 0,\r\nLM25056_VAUX_OV_WARN_LIMIT, word);\r\npmbus_clear_cache(client);\r\nbreak;\r\ncase PMBUS_VIRT_RESET_PIN_HISTORY:\r\nret = pmbus_write_byte(client, 0, LM25066_CLEAR_PIN_PEAK);\r\nbreak;\r\ndefault:\r\nret = -ENODATA;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int lm25066_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nint config;\r\nstruct lm25066_data *data;\r\nstruct pmbus_driver_info *info;\r\nstruct __coeff *coeff;\r\nif (!i2c_check_functionality(client->adapter,\r\nI2C_FUNC_SMBUS_READ_BYTE_DATA))\r\nreturn -ENODEV;\r\ndata = devm_kzalloc(&client->dev, sizeof(struct lm25066_data),\r\nGFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\nconfig = i2c_smbus_read_byte_data(client, LM25066_DEVICE_SETUP);\r\nif (config < 0)\r\nreturn config;\r\ndata->id = id->driver_data;\r\ninfo = &data->info;\r\ninfo->pages = 1;\r\ninfo->format[PSC_VOLTAGE_IN] = direct;\r\ninfo->format[PSC_VOLTAGE_OUT] = direct;\r\ninfo->format[PSC_CURRENT_IN] = direct;\r\ninfo->format[PSC_TEMPERATURE] = direct;\r\ninfo->format[PSC_POWER] = direct;\r\ninfo->func[0] = PMBUS_HAVE_VIN | PMBUS_HAVE_VMON\r\n| PMBUS_HAVE_PIN | PMBUS_HAVE_IIN | PMBUS_HAVE_STATUS_INPUT\r\n| PMBUS_HAVE_TEMP | PMBUS_HAVE_STATUS_TEMP;\r\nif (data->id == lm25056) {\r\ninfo->func[0] |= PMBUS_HAVE_STATUS_VMON;\r\ninfo->read_word_data = lm25056_read_word_data;\r\ninfo->read_byte_data = lm25056_read_byte_data;\r\n} else {\r\ninfo->func[0] |= PMBUS_HAVE_VOUT | PMBUS_HAVE_STATUS_VOUT;\r\ninfo->read_word_data = lm25066_read_word_data;\r\n}\r\ninfo->write_word_data = lm25066_write_word_data;\r\ncoeff = &lm25066_coeff[data->id][0];\r\ninfo->m[PSC_TEMPERATURE] = coeff[PSC_TEMPERATURE].m;\r\ninfo->b[PSC_TEMPERATURE] = coeff[PSC_TEMPERATURE].b;\r\ninfo->R[PSC_TEMPERATURE] = coeff[PSC_TEMPERATURE].R;\r\ninfo->m[PSC_VOLTAGE_IN] = coeff[PSC_VOLTAGE_IN].m;\r\ninfo->b[PSC_VOLTAGE_IN] = coeff[PSC_VOLTAGE_IN].b;\r\ninfo->R[PSC_VOLTAGE_IN] = coeff[PSC_VOLTAGE_IN].R;\r\ninfo->m[PSC_VOLTAGE_OUT] = coeff[PSC_VOLTAGE_OUT].m;\r\ninfo->b[PSC_VOLTAGE_OUT] = coeff[PSC_VOLTAGE_OUT].b;\r\ninfo->R[PSC_VOLTAGE_OUT] = coeff[PSC_VOLTAGE_OUT].R;\r\ninfo->b[PSC_CURRENT_IN] = coeff[PSC_CURRENT_IN].b;\r\ninfo->R[PSC_CURRENT_IN] = coeff[PSC_CURRENT_IN].R;\r\ninfo->b[PSC_POWER] = coeff[PSC_POWER].b;\r\ninfo->R[PSC_POWER] = coeff[PSC_POWER].R;\r\nif (config & LM25066_DEV_SETUP_CL) {\r\ninfo->m[PSC_CURRENT_IN] = coeff[PSC_CURRENT_IN_L].m;\r\ninfo->m[PSC_POWER] = coeff[PSC_POWER_L].m;\r\n} else {\r\ninfo->m[PSC_CURRENT_IN] = coeff[PSC_CURRENT_IN].m;\r\ninfo->m[PSC_POWER] = coeff[PSC_POWER].m;\r\n}\r\nreturn pmbus_do_probe(client, id, info);\r\n}

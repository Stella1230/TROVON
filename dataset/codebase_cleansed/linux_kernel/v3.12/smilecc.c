static void trans_result(BYTE reg2, BYTE reg3, BYTE *ecc1, BYTE *ecc2)\r\n{\r\nBYTE a;\r\nBYTE b;\r\nBYTE i;\r\na = BIT7; b = BIT7;\r\n*ecc1 = *ecc2 = 0;\r\nfor (i = 0; i < 4; ++i) {\r\nif ((reg3&a) != 0)\r\n*ecc1 |= b;\r\nb = b>>1;\r\nif ((reg2&a) != 0)\r\n*ecc1 |= b;\r\nb = b>>1;\r\na = a>>1;\r\n}\r\nb = BIT7;\r\nfor (i = 0; i < 4; ++i) {\r\nif ((reg3&a) != 0)\r\n*ecc2 |= b;\r\nb = b>>1;\r\nif ((reg2&a) != 0)\r\n*ecc2 |= b;\r\nb = b>>1;\r\na = a>>1;\r\n}\r\n}\r\nvoid calculate_ecc(BYTE *table, BYTE *data, BYTE *ecc1, BYTE *ecc2, BYTE *ecc3)\r\n{\r\nDWORD i;\r\nBYTE a;\r\nBYTE reg1;\r\nBYTE reg2;\r\nBYTE reg3;\r\nreg1 = reg2 = reg3 = 0;\r\nfor (i = 0; i < 256; ++i) {\r\na = table[data[i]];\r\nreg1 ^= (a&MASK_CPS);\r\nif ((a&BIT6) != 0) {\r\nreg3 ^= (BYTE)i;\r\nreg2 ^= ~((BYTE)i);\r\n}\r\n}\r\ntrans_result(reg2, reg3, ecc1, ecc2);\r\n*ecc1 = ~(*ecc1); *ecc2 = ~(*ecc2);\r\n*ecc3 = ((~reg1)<<2)|BIT1BIT0;\r\n}\r\nBYTE correct_data(BYTE *data, BYTE *eccdata, BYTE ecc1, BYTE ecc2, BYTE ecc3)\r\n{\r\nDWORD l;\r\nDWORD d;\r\nDWORD i;\r\nBYTE d1, d2, d3;\r\nBYTE a;\r\nBYTE add;\r\nBYTE b;\r\nBYTE bit;\r\nd1 = ecc1^eccdata[1]; d2 = ecc2^eccdata[0];\r\nd3 = ecc3^eccdata[2];\r\nd = ((DWORD)d1<<16)\r\n+((DWORD)d2<<8)\r\n+(DWORD)d3;\r\nif (d == 0)\r\nreturn 0;\r\nif (((d^(d>>1))&CORRECTABLE) == CORRECTABLE) {\r\nl = BIT23;\r\nadd = 0;\r\na = BIT7;\r\nfor (i = 0; i < 8; ++i) {\r\nif ((d&l) != 0)\r\nadd |= a;\r\nl >>= 2; a >>= 1;\r\n}\r\nbit = 0;\r\nb = BIT2;\r\nfor (i = 0; i < 3; ++i) {\r\nif ((d&l) != 0)\r\nbit |= b;\r\nl >>= 2; b >>= 1;\r\n}\r\nb = BIT0;\r\ndata[add] ^= (b<<bit);\r\nreturn 1;\r\n}\r\ni = 0;\r\nd &= 0x00ffffffL;\r\nwhile (d) {\r\nif (d&BIT0)\r\n++i;\r\nd >>= 1;\r\n}\r\nif (i == 1) {\r\neccdata[1] = ecc1; eccdata[0] = ecc2;\r\neccdata[2] = ecc3;\r\nreturn 2;\r\n}\r\nreturn 3;\r\n}\r\nint _Correct_D_SwECC(BYTE *buf, BYTE *redundant_ecc, BYTE *calculate_ecc)\r\n{\r\nDWORD err;\r\nerr = correct_data(buf, redundant_ecc, *(calculate_ecc + 1),\r\n*(calculate_ecc), *(calculate_ecc + 2));\r\nif (err == 1)\r\nmemcpy(calculate_ecc, redundant_ecc, 3);\r\nif (err == 0 || err == 1 || err == 2)\r\nreturn 0;\r\nreturn -1;\r\n}\r\nvoid _Calculate_D_SwECC(BYTE *buf, BYTE *ecc)\r\n{\r\ncalculate_ecc(ecctable, buf, ecc+1, ecc+0, ecc+2);\r\n}

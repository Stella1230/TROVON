static unsigned short psc_ac97_read(struct snd_ac97 *ac97, unsigned short reg)\r\n{\r\nint status;\r\nunsigned int val;\r\nmutex_lock(&psc_dma->mutex);\r\nstatus = spin_event_timeout(!(in_be16(&psc_dma->psc_regs->sr_csr.status) &\r\nMPC52xx_PSC_SR_CMDSEND), 100, 0);\r\nif (status == 0) {\r\npr_err("timeout on ac97 bus (rdy)\n");\r\nmutex_unlock(&psc_dma->mutex);\r\nreturn -ENODEV;\r\n}\r\nin_be32(&psc_dma->psc_regs->ac97_data);\r\nout_be32(&psc_dma->psc_regs->ac97_cmd, (1<<31) | ((reg & 0x7f) << 24));\r\nstatus = spin_event_timeout((in_be16(&psc_dma->psc_regs->sr_csr.status) &\r\nMPC52xx_PSC_SR_DATA_VAL), 100, 0);\r\nif (status == 0) {\r\npr_err("timeout on ac97 read (val) %x\n",\r\nin_be16(&psc_dma->psc_regs->sr_csr.status));\r\nmutex_unlock(&psc_dma->mutex);\r\nreturn -ENODEV;\r\n}\r\nval = in_be32(&psc_dma->psc_regs->ac97_data);\r\nif (((val >> 24) & 0x7f) != reg) {\r\npr_err("reg echo error on ac97 read\n");\r\nmutex_unlock(&psc_dma->mutex);\r\nreturn -ENODEV;\r\n}\r\nval = (val >> 8) & 0xffff;\r\nmutex_unlock(&psc_dma->mutex);\r\nreturn (unsigned short) val;\r\n}\r\nstatic void psc_ac97_write(struct snd_ac97 *ac97,\r\nunsigned short reg, unsigned short val)\r\n{\r\nint status;\r\nmutex_lock(&psc_dma->mutex);\r\nstatus = spin_event_timeout(!(in_be16(&psc_dma->psc_regs->sr_csr.status) &\r\nMPC52xx_PSC_SR_CMDSEND), 100, 0);\r\nif (status == 0) {\r\npr_err("timeout on ac97 bus (write)\n");\r\ngoto out;\r\n}\r\nout_be32(&psc_dma->psc_regs->ac97_cmd,\r\n((reg & 0x7f) << 24) | (val << 8));\r\nout:\r\nmutex_unlock(&psc_dma->mutex);\r\n}\r\nstatic void psc_ac97_warm_reset(struct snd_ac97 *ac97)\r\n{\r\nstruct mpc52xx_psc __iomem *regs = psc_dma->psc_regs;\r\nmutex_lock(&psc_dma->mutex);\r\nout_be32(&regs->sicr, psc_dma->sicr | MPC52xx_PSC_SICR_AWR);\r\nudelay(3);\r\nout_be32(&regs->sicr, psc_dma->sicr);\r\nmutex_unlock(&psc_dma->mutex);\r\n}\r\nstatic void psc_ac97_cold_reset(struct snd_ac97 *ac97)\r\n{\r\nstruct mpc52xx_psc __iomem *regs = psc_dma->psc_regs;\r\nmutex_lock(&psc_dma->mutex);\r\ndev_dbg(psc_dma->dev, "cold reset\n");\r\nmpc5200_psc_ac97_gpio_reset(psc_dma->id);\r\nout_be32(&regs->sicr, psc_dma->sicr | MPC52xx_PSC_SICR_ACRB);\r\nout_8(&regs->command, MPC52xx_PSC_TX_ENABLE | MPC52xx_PSC_RX_ENABLE);\r\nmutex_unlock(&psc_dma->mutex);\r\nmsleep(1);\r\npsc_ac97_warm_reset(ac97);\r\n}\r\nstatic int psc_ac97_hw_analog_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *cpu_dai)\r\n{\r\nstruct psc_dma *psc_dma = snd_soc_dai_get_drvdata(cpu_dai);\r\nstruct psc_dma_stream *s = to_psc_dma_stream(substream, psc_dma);\r\ndev_dbg(psc_dma->dev, "%s(substream=%p) p_size=%i p_bytes=%i"\r\n" periods=%i buffer_size=%i buffer_bytes=%i channels=%i"\r\n" rate=%i format=%i\n",\r\n__func__, substream, params_period_size(params),\r\nparams_period_bytes(params), params_periods(params),\r\nparams_buffer_size(params), params_buffer_bytes(params),\r\nparams_channels(params), params_rate(params),\r\nparams_format(params));\r\ns->ac97_slot_bits = (params_channels(params) == 1) ? 0x100 : 0x300;\r\nif (substream->pstr->stream != SNDRV_PCM_STREAM_CAPTURE)\r\ns->ac97_slot_bits <<= 16;\r\nreturn 0;\r\n}\r\nstatic int psc_ac97_hw_digital_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *cpu_dai)\r\n{\r\nstruct psc_dma *psc_dma = snd_soc_dai_get_drvdata(cpu_dai);\r\ndev_dbg(psc_dma->dev, "%s(substream=%p)\n", __func__, substream);\r\nif (params_channels(params) == 1)\r\nout_be32(&psc_dma->psc_regs->ac97_slots, 0x01000000);\r\nelse\r\nout_be32(&psc_dma->psc_regs->ac97_slots, 0x03000000);\r\nreturn 0;\r\n}\r\nstatic int psc_ac97_trigger(struct snd_pcm_substream *substream, int cmd,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct psc_dma *psc_dma = snd_soc_dai_get_drvdata(dai);\r\nstruct psc_dma_stream *s = to_psc_dma_stream(substream, psc_dma);\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\ndev_dbg(psc_dma->dev, "AC97 START: stream=%i\n",\r\nsubstream->pstr->stream);\r\npsc_dma->slots |= s->ac97_slot_bits;\r\nout_be32(&psc_dma->psc_regs->ac97_slots, psc_dma->slots);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ndev_dbg(psc_dma->dev, "AC97 STOP: stream=%i\n",\r\nsubstream->pstr->stream);\r\npsc_dma->slots &= ~(s->ac97_slot_bits);\r\nout_be32(&psc_dma->psc_regs->ac97_slots, psc_dma->slots);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int psc_ac97_probe(struct snd_soc_dai *cpu_dai)\r\n{\r\nstruct psc_dma *psc_dma = snd_soc_dai_get_drvdata(cpu_dai);\r\nstruct mpc52xx_psc __iomem *regs = psc_dma->psc_regs;\r\nout_8(&regs->command, MPC52xx_PSC_TX_ENABLE | MPC52xx_PSC_RX_ENABLE);\r\nreturn 0;\r\n}\r\nstatic int psc_ac97_of_probe(struct platform_device *op)\r\n{\r\nint rc;\r\nstruct snd_ac97 ac97;\r\nstruct mpc52xx_psc __iomem *regs;\r\nrc = mpc5200_audio_dma_create(op);\r\nif (rc != 0)\r\nreturn rc;\r\nrc = snd_soc_set_ac97_ops(&psc_ac97_ops);\r\nif (rc != 0) {\r\ndev_err(&op->dev, "Failed to set AC'97 ops: %d\n", ret);\r\nreturn rc;\r\n}\r\nrc = snd_soc_register_component(&op->dev, &psc_ac97_component,\r\npsc_ac97_dai, ARRAY_SIZE(psc_ac97_dai));\r\nif (rc != 0) {\r\ndev_err(&op->dev, "Failed to register DAI\n");\r\nreturn rc;\r\n}\r\npsc_dma = dev_get_drvdata(&op->dev);\r\nregs = psc_dma->psc_regs;\r\nac97.private_data = psc_dma;\r\npsc_dma->imr = 0;\r\nout_be16(&psc_dma->psc_regs->isr_imr.imr, psc_dma->imr);\r\npsc_dma->sicr = MPC52xx_PSC_SICR_SIM_AC97 | MPC52xx_PSC_SICR_ENAC97;\r\nout_be32(&regs->sicr, psc_dma->sicr);\r\nout_be32(&regs->ac97_slots, 0x00000000);\r\nreturn 0;\r\n}\r\nstatic int psc_ac97_of_remove(struct platform_device *op)\r\n{\r\nmpc5200_audio_dma_destroy(op);\r\nsnd_soc_unregister_component(&op->dev);\r\nsnd_soc_set_ac97_ops(NULL);\r\nreturn 0;\r\n}

static int __init mxc_init_extuart(void)\r\n{\r\nserial_platform_data[0].irq = irq_find_mapping(domain,\r\nEXPIO_INT_XUART_INTA);\r\nserial_platform_data[1].irq = irq_find_mapping(domain,\r\nEXPIO_INT_XUART_INTB);\r\nreturn platform_device_register(&serial_device);\r\n}\r\nstatic void __init mxc_init_ext_ethernet(void)\r\n{\r\nmx31ads_cs8900_resources[1].start =\r\nirq_find_mapping(domain, EXPIO_INT_ENET_INT);\r\nmx31ads_cs8900_resources[1].end =\r\nirq_find_mapping(domain, EXPIO_INT_ENET_INT);\r\nplatform_device_register_full(\r\n(struct platform_device_info *)&mx31ads_cs8900_devinfo);\r\n}\r\nstatic inline void mxc_init_imx_uart(void)\r\n{\r\nmxc_iomux_setup_multiple_pins(uart_pins, ARRAY_SIZE(uart_pins), "uart-0");\r\nimx31_add_imx_uart0(&uart_pdata);\r\n}\r\nstatic void mx31ads_expio_irq_handler(u32 irq, struct irq_desc *desc)\r\n{\r\nu32 imr_val;\r\nu32 int_valid;\r\nu32 expio_irq;\r\nimr_val = __raw_readw(PBC_INTMASK_SET_REG);\r\nint_valid = __raw_readw(PBC_INTSTATUS_REG) & imr_val;\r\nexpio_irq = 0;\r\nfor (; int_valid != 0; int_valid >>= 1, expio_irq++) {\r\nif ((int_valid & 1) == 0)\r\ncontinue;\r\ngeneric_handle_irq(irq_find_mapping(domain, expio_irq));\r\n}\r\n}\r\nstatic void expio_mask_irq(struct irq_data *d)\r\n{\r\nu32 expio = d->hwirq;\r\n__raw_writew(1 << expio, PBC_INTMASK_CLEAR_REG);\r\n__raw_readw(PBC_INTMASK_CLEAR_REG);\r\n}\r\nstatic void expio_ack_irq(struct irq_data *d)\r\n{\r\nu32 expio = d->hwirq;\r\n__raw_writew(1 << expio, PBC_INTSTATUS_REG);\r\n}\r\nstatic void expio_unmask_irq(struct irq_data *d)\r\n{\r\nu32 expio = d->hwirq;\r\n__raw_writew(1 << expio, PBC_INTMASK_SET_REG);\r\n}\r\nstatic void __init mx31ads_init_expio(void)\r\n{\r\nint irq_base;\r\nint i, irq;\r\nprintk(KERN_INFO "MX31ADS EXPIO(CPLD) hardware\n");\r\nmxc_iomux_alloc_pin(IOMUX_MODE(MX31_PIN_GPIO1_4, IOMUX_CONFIG_GPIO), "expio");\r\n__raw_writew(0xFFFF, PBC_INTMASK_CLEAR_REG);\r\n__raw_writew(0xFFFF, PBC_INTSTATUS_REG);\r\nirq_base = irq_alloc_descs(-1, 0, MXC_MAX_EXP_IO_LINES, numa_node_id());\r\nWARN_ON(irq_base < 0);\r\ndomain = irq_domain_add_legacy(NULL, MXC_MAX_EXP_IO_LINES, irq_base, 0,\r\n&irq_domain_simple_ops, NULL);\r\nWARN_ON(!domain);\r\nfor (i = irq_base; i < irq_base + MXC_MAX_EXP_IO_LINES; i++) {\r\nirq_set_chip_and_handler(i, &expio_irq_chip, handle_level_irq);\r\nset_irq_flags(i, IRQF_VALID);\r\n}\r\nirq = gpio_to_irq(IOMUX_TO_GPIO(MX31_PIN_GPIO1_4));\r\nirq_set_irq_type(irq, IRQ_TYPE_LEVEL_HIGH);\r\nirq_set_chained_handler(irq, mx31ads_expio_irq_handler);\r\n}\r\nstatic int mx31_wm8350_init(struct wm8350 *wm8350)\r\n{\r\nwm8350_gpio_config(wm8350, 0, WM8350_GPIO_DIR_IN,\r\nWM8350_GPIO0_PWR_ON_IN, WM8350_GPIO_ACTIVE_LOW,\r\nWM8350_GPIO_PULL_UP, WM8350_GPIO_INVERT_OFF,\r\nWM8350_GPIO_DEBOUNCE_ON);\r\nwm8350_gpio_config(wm8350, 3, WM8350_GPIO_DIR_IN,\r\nWM8350_GPIO3_PWR_OFF_IN, WM8350_GPIO_ACTIVE_HIGH,\r\nWM8350_GPIO_PULL_DOWN, WM8350_GPIO_INVERT_OFF,\r\nWM8350_GPIO_DEBOUNCE_ON);\r\nwm8350_gpio_config(wm8350, 4, WM8350_GPIO_DIR_IN,\r\nWM8350_GPIO4_MR_IN, WM8350_GPIO_ACTIVE_HIGH,\r\nWM8350_GPIO_PULL_DOWN, WM8350_GPIO_INVERT_OFF,\r\nWM8350_GPIO_DEBOUNCE_OFF);\r\nwm8350_gpio_config(wm8350, 7, WM8350_GPIO_DIR_IN,\r\nWM8350_GPIO7_HIBERNATE_IN, WM8350_GPIO_ACTIVE_HIGH,\r\nWM8350_GPIO_PULL_DOWN, WM8350_GPIO_INVERT_OFF,\r\nWM8350_GPIO_DEBOUNCE_OFF);\r\nwm8350_gpio_config(wm8350, 6, WM8350_GPIO_DIR_OUT,\r\nWM8350_GPIO6_SDOUT_OUT, WM8350_GPIO_ACTIVE_HIGH,\r\nWM8350_GPIO_PULL_NONE, WM8350_GPIO_INVERT_OFF,\r\nWM8350_GPIO_DEBOUNCE_OFF);\r\nwm8350_gpio_config(wm8350, 8, WM8350_GPIO_DIR_OUT,\r\nWM8350_GPIO8_VCC_FAULT_OUT, WM8350_GPIO_ACTIVE_LOW,\r\nWM8350_GPIO_PULL_NONE, WM8350_GPIO_INVERT_OFF,\r\nWM8350_GPIO_DEBOUNCE_OFF);\r\nwm8350_gpio_config(wm8350, 9, WM8350_GPIO_DIR_OUT,\r\nWM8350_GPIO9_BATT_FAULT_OUT, WM8350_GPIO_ACTIVE_LOW,\r\nWM8350_GPIO_PULL_NONE, WM8350_GPIO_INVERT_OFF,\r\nWM8350_GPIO_DEBOUNCE_OFF);\r\nwm8350_register_regulator(wm8350, WM8350_DCDC_1, &sw1a_data);\r\nwm8350_register_regulator(wm8350, WM8350_DCDC_3, &viohi_data);\r\nwm8350_register_regulator(wm8350, WM8350_DCDC_4, &violo_data);\r\nwm8350_register_regulator(wm8350, WM8350_DCDC_6, &sw2a_data);\r\nwm8350_register_regulator(wm8350, WM8350_LDO_1, &ldo1_data);\r\nwm8350_register_regulator(wm8350, WM8350_LDO_2, &ldo2_data);\r\nwm8350_register_regulator(wm8350, WM8350_LDO_3, &vdig_data);\r\nwm8350_register_regulator(wm8350, WM8350_LDO_4, &ldo4_data);\r\nwm8350_dcdc_set_slot(wm8350, WM8350_DCDC_5, 1, 1,\r\nWM8350_DC5_ERRACT_SHUTDOWN_CONV);\r\nwm8350_isink_set_flash(wm8350, WM8350_ISINK_A,\r\nWM8350_ISINK_FLASH_DISABLE,\r\nWM8350_ISINK_FLASH_TRIG_BIT,\r\nWM8350_ISINK_FLASH_DUR_32MS,\r\nWM8350_ISINK_FLASH_ON_INSTANT,\r\nWM8350_ISINK_FLASH_OFF_INSTANT,\r\nWM8350_ISINK_FLASH_MODE_EN);\r\nwm8350_dcdc25_set_mode(wm8350, WM8350_DCDC_5,\r\nWM8350_ISINK_MODE_BOOST,\r\nWM8350_ISINK_ILIM_NORMAL,\r\nWM8350_DC5_RMP_20V,\r\nWM8350_DC5_FBSRC_ISINKA);\r\nwm8350_register_led(wm8350, 0, WM8350_DCDC_5, WM8350_ISINK_A,\r\n&wm8350_led_data);\r\nwm8350->codec.platform_data = &imx32ads_wm8350_setup;\r\nregulator_has_full_constraints();\r\nreturn 0;\r\n}\r\nstatic void __init mxc_init_i2c(void)\r\n{\r\n#ifdef CONFIG_MACH_MX31ADS_WM1133_EV1\r\nmx31ads_i2c1_devices[0].irq =\r\ngpio_to_irq(IOMUX_TO_GPIO(MX31_PIN_GPIO1_3));\r\n#endif\r\ni2c_register_board_info(1, mx31ads_i2c1_devices,\r\nARRAY_SIZE(mx31ads_i2c1_devices));\r\nmxc_iomux_mode(IOMUX_MODE(MX31_PIN_CSPI2_MOSI, IOMUX_CONFIG_ALT1));\r\nmxc_iomux_mode(IOMUX_MODE(MX31_PIN_CSPI2_MISO, IOMUX_CONFIG_ALT1));\r\nimx31_add_imx_i2c1(NULL);\r\n}\r\nstatic void __init mxc_init_audio(void)\r\n{\r\nimx31_add_imx_ssi(0, NULL);\r\nmxc_iomux_setup_multiple_pins(ssi_pins, ARRAY_SIZE(ssi_pins), "ssi");\r\n}\r\nstatic void __init mx31ads_map_io(void)\r\n{\r\nmx31_map_io();\r\niotable_init(mx31ads_io_desc, ARRAY_SIZE(mx31ads_io_desc));\r\n}\r\nstatic void __init mx31ads_init_irq(void)\r\n{\r\nmx31_init_irq();\r\nmx31ads_init_expio();\r\n}\r\nstatic void __init mx31ads_init(void)\r\n{\r\nimx31_soc_init();\r\nmxc_init_extuart();\r\nmxc_init_imx_uart();\r\nmxc_init_i2c();\r\nmxc_init_audio();\r\nmxc_init_ext_ethernet();\r\n}\r\nstatic void __init mx31ads_timer_init(void)\r\n{\r\nmx31_clocks_init(26000000);\r\n}

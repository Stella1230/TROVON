static int ad2s1200_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint *val,\r\nint *val2,\r\nlong m)\r\n{\r\nint ret = 0;\r\ns16 vel;\r\nstruct ad2s1200_state *st = iio_priv(indio_dev);\r\nmutex_lock(&st->lock);\r\ngpio_set_value(st->sample, 0);\r\nudelay(1);\r\ngpio_set_value(st->sample, 1);\r\ngpio_set_value(st->rdvel, !!(chan->type == IIO_ANGL));\r\nret = spi_read(st->sdev, st->rx, 2);\r\nif (ret < 0) {\r\nmutex_unlock(&st->lock);\r\nreturn ret;\r\n}\r\nswitch (chan->type) {\r\ncase IIO_ANGL:\r\n*val = (((u16)(st->rx[0])) << 4) | ((st->rx[1] & 0xF0) >> 4);\r\nbreak;\r\ncase IIO_ANGL_VEL:\r\nvel = (((s16)(st->rx[0])) << 4) | ((st->rx[1] & 0xF0) >> 4);\r\nvel = (vel << 4) >> 4;\r\n*val = vel;\r\ndefault:\r\nmutex_unlock(&st->lock);\r\nreturn -EINVAL;\r\n}\r\nudelay(1);\r\nmutex_unlock(&st->lock);\r\nreturn IIO_VAL_INT;\r\n}\r\nstatic int ad2s1200_probe(struct spi_device *spi)\r\n{\r\nstruct ad2s1200_state *st;\r\nstruct iio_dev *indio_dev;\r\nint pn, ret = 0;\r\nunsigned short *pins = spi->dev.platform_data;\r\nfor (pn = 0; pn < AD2S1200_PN; pn++)\r\nif (gpio_request_one(pins[pn], GPIOF_DIR_OUT, DRV_NAME)) {\r\npr_err("%s: request gpio pin %d failed\n",\r\nDRV_NAME, pins[pn]);\r\ngoto error_ret;\r\n}\r\nindio_dev = iio_device_alloc(sizeof(*st));\r\nif (indio_dev == NULL) {\r\nret = -ENOMEM;\r\ngoto error_ret;\r\n}\r\nspi_set_drvdata(spi, indio_dev);\r\nst = iio_priv(indio_dev);\r\nmutex_init(&st->lock);\r\nst->sdev = spi;\r\nst->sample = pins[0];\r\nst->rdvel = pins[1];\r\nindio_dev->dev.parent = &spi->dev;\r\nindio_dev->info = &ad2s1200_info;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nindio_dev->channels = ad2s1200_channels;\r\nindio_dev->num_channels = ARRAY_SIZE(ad2s1200_channels);\r\nindio_dev->name = spi_get_device_id(spi)->name;\r\nret = iio_device_register(indio_dev);\r\nif (ret)\r\ngoto error_free_dev;\r\nspi->max_speed_hz = AD2S1200_HZ;\r\nspi->mode = SPI_MODE_3;\r\nspi_setup(spi);\r\nreturn 0;\r\nerror_free_dev:\r\niio_device_free(indio_dev);\r\nerror_ret:\r\nfor (--pn; pn >= 0; pn--)\r\ngpio_free(pins[pn]);\r\nreturn ret;\r\n}\r\nstatic int ad2s1200_remove(struct spi_device *spi)\r\n{\r\niio_device_unregister(spi_get_drvdata(spi));\r\niio_device_free(spi_get_drvdata(spi));\r\nreturn 0;\r\n}

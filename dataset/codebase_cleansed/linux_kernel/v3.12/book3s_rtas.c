static void kvm_rtas_set_xive(struct kvm_vcpu *vcpu, struct rtas_args *args)\r\n{\r\nu32 irq, server, priority;\r\nint rc;\r\nif (args->nargs != 3 || args->nret != 1) {\r\nrc = -3;\r\ngoto out;\r\n}\r\nirq = args->args[0];\r\nserver = args->args[1];\r\npriority = args->args[2];\r\nrc = kvmppc_xics_set_xive(vcpu->kvm, irq, server, priority);\r\nif (rc)\r\nrc = -3;\r\nout:\r\nargs->rets[0] = rc;\r\n}\r\nstatic void kvm_rtas_get_xive(struct kvm_vcpu *vcpu, struct rtas_args *args)\r\n{\r\nu32 irq, server, priority;\r\nint rc;\r\nif (args->nargs != 1 || args->nret != 3) {\r\nrc = -3;\r\ngoto out;\r\n}\r\nirq = args->args[0];\r\nserver = priority = 0;\r\nrc = kvmppc_xics_get_xive(vcpu->kvm, irq, &server, &priority);\r\nif (rc) {\r\nrc = -3;\r\ngoto out;\r\n}\r\nargs->rets[1] = server;\r\nargs->rets[2] = priority;\r\nout:\r\nargs->rets[0] = rc;\r\n}\r\nstatic void kvm_rtas_int_off(struct kvm_vcpu *vcpu, struct rtas_args *args)\r\n{\r\nu32 irq;\r\nint rc;\r\nif (args->nargs != 1 || args->nret != 1) {\r\nrc = -3;\r\ngoto out;\r\n}\r\nirq = args->args[0];\r\nrc = kvmppc_xics_int_off(vcpu->kvm, irq);\r\nif (rc)\r\nrc = -3;\r\nout:\r\nargs->rets[0] = rc;\r\n}\r\nstatic void kvm_rtas_int_on(struct kvm_vcpu *vcpu, struct rtas_args *args)\r\n{\r\nu32 irq;\r\nint rc;\r\nif (args->nargs != 1 || args->nret != 1) {\r\nrc = -3;\r\ngoto out;\r\n}\r\nirq = args->args[0];\r\nrc = kvmppc_xics_int_on(vcpu->kvm, irq);\r\nif (rc)\r\nrc = -3;\r\nout:\r\nargs->rets[0] = rc;\r\n}\r\nstatic int rtas_name_matches(char *s1, char *s2)\r\n{\r\nstruct kvm_rtas_token_args args;\r\nreturn !strncmp(s1, s2, sizeof(args.name));\r\n}\r\nstatic int rtas_token_undefine(struct kvm *kvm, char *name)\r\n{\r\nstruct rtas_token_definition *d, *tmp;\r\nlockdep_assert_held(&kvm->lock);\r\nlist_for_each_entry_safe(d, tmp, &kvm->arch.rtas_tokens, list) {\r\nif (rtas_name_matches(d->handler->name, name)) {\r\nlist_del(&d->list);\r\nkfree(d);\r\nreturn 0;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int rtas_token_define(struct kvm *kvm, char *name, u64 token)\r\n{\r\nstruct rtas_token_definition *d;\r\nstruct rtas_handler *h = NULL;\r\nbool found;\r\nint i;\r\nlockdep_assert_held(&kvm->lock);\r\nlist_for_each_entry(d, &kvm->arch.rtas_tokens, list) {\r\nif (d->token == token)\r\nreturn -EEXIST;\r\n}\r\nfound = false;\r\nfor (i = 0; i < ARRAY_SIZE(rtas_handlers); i++) {\r\nh = &rtas_handlers[i];\r\nif (rtas_name_matches(h->name, name)) {\r\nfound = true;\r\nbreak;\r\n}\r\n}\r\nif (!found)\r\nreturn -ENOENT;\r\nd = kzalloc(sizeof(*d), GFP_KERNEL);\r\nif (!d)\r\nreturn -ENOMEM;\r\nd->handler = h;\r\nd->token = token;\r\nlist_add_tail(&d->list, &kvm->arch.rtas_tokens);\r\nreturn 0;\r\n}\r\nint kvm_vm_ioctl_rtas_define_token(struct kvm *kvm, void __user *argp)\r\n{\r\nstruct kvm_rtas_token_args args;\r\nint rc;\r\nif (copy_from_user(&args, argp, sizeof(args)))\r\nreturn -EFAULT;\r\nmutex_lock(&kvm->lock);\r\nif (args.token)\r\nrc = rtas_token_define(kvm, args.name, args.token);\r\nelse\r\nrc = rtas_token_undefine(kvm, args.name);\r\nmutex_unlock(&kvm->lock);\r\nreturn rc;\r\n}\r\nint kvmppc_rtas_hcall(struct kvm_vcpu *vcpu)\r\n{\r\nstruct rtas_token_definition *d;\r\nstruct rtas_args args;\r\nrtas_arg_t *orig_rets;\r\ngpa_t args_phys;\r\nint rc;\r\nargs_phys = kvmppc_get_gpr(vcpu, 4);\r\nrc = kvm_read_guest(vcpu->kvm, args_phys, &args, sizeof(args));\r\nif (rc)\r\ngoto fail;\r\norig_rets = args.rets;\r\nargs.rets = &args.args[args.nargs];\r\nmutex_lock(&vcpu->kvm->lock);\r\nrc = -ENOENT;\r\nlist_for_each_entry(d, &vcpu->kvm->arch.rtas_tokens, list) {\r\nif (d->token == args.token) {\r\nd->handler->handler(vcpu, &args);\r\nrc = 0;\r\nbreak;\r\n}\r\n}\r\nmutex_unlock(&vcpu->kvm->lock);\r\nif (rc == 0) {\r\nargs.rets = orig_rets;\r\nrc = kvm_write_guest(vcpu->kvm, args_phys, &args, sizeof(args));\r\nif (rc)\r\ngoto fail;\r\n}\r\nreturn rc;\r\nfail:\r\nreturn rc;\r\n}\r\nvoid kvmppc_rtas_tokens_free(struct kvm *kvm)\r\n{\r\nstruct rtas_token_definition *d, *tmp;\r\nlockdep_assert_held(&kvm->lock);\r\nlist_for_each_entry_safe(d, tmp, &kvm->arch.rtas_tokens, list) {\r\nlist_del(&d->list);\r\nkfree(d);\r\n}\r\n}

static inline struct max8998_irq_data *\r\nirq_to_max8998_irq(struct max8998_dev *max8998, int irq)\r\n{\r\nstruct irq_data *data = irq_get_irq_data(irq);\r\nreturn &max8998_irqs[data->hwirq];\r\n}\r\nstatic void max8998_irq_lock(struct irq_data *data)\r\n{\r\nstruct max8998_dev *max8998 = irq_data_get_irq_chip_data(data);\r\nmutex_lock(&max8998->irqlock);\r\n}\r\nstatic void max8998_irq_sync_unlock(struct irq_data *data)\r\n{\r\nstruct max8998_dev *max8998 = irq_data_get_irq_chip_data(data);\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(max8998->irq_masks_cur); i++) {\r\nif (max8998->irq_masks_cur[i] != max8998->irq_masks_cache[i]) {\r\nmax8998->irq_masks_cache[i] = max8998->irq_masks_cur[i];\r\nmax8998_write_reg(max8998->i2c, MAX8998_REG_IRQM1 + i,\r\nmax8998->irq_masks_cur[i]);\r\n}\r\n}\r\nmutex_unlock(&max8998->irqlock);\r\n}\r\nstatic void max8998_irq_unmask(struct irq_data *data)\r\n{\r\nstruct max8998_dev *max8998 = irq_data_get_irq_chip_data(data);\r\nstruct max8998_irq_data *irq_data = irq_to_max8998_irq(max8998,\r\ndata->irq);\r\nmax8998->irq_masks_cur[irq_data->reg - 1] &= ~irq_data->mask;\r\n}\r\nstatic void max8998_irq_mask(struct irq_data *data)\r\n{\r\nstruct max8998_dev *max8998 = irq_data_get_irq_chip_data(data);\r\nstruct max8998_irq_data *irq_data = irq_to_max8998_irq(max8998,\r\ndata->irq);\r\nmax8998->irq_masks_cur[irq_data->reg - 1] |= irq_data->mask;\r\n}\r\nstatic irqreturn_t max8998_irq_thread(int irq, void *data)\r\n{\r\nstruct max8998_dev *max8998 = data;\r\nu8 irq_reg[MAX8998_NUM_IRQ_REGS];\r\nint ret;\r\nint i;\r\nret = max8998_bulk_read(max8998->i2c, MAX8998_REG_IRQ1,\r\nMAX8998_NUM_IRQ_REGS, irq_reg);\r\nif (ret < 0) {\r\ndev_err(max8998->dev, "Failed to read interrupt register: %d\n",\r\nret);\r\nreturn IRQ_NONE;\r\n}\r\nfor (i = 0; i < MAX8998_NUM_IRQ_REGS; i++)\r\nirq_reg[i] &= ~max8998->irq_masks_cur[i];\r\nfor (i = 0; i < MAX8998_IRQ_NR; i++) {\r\nif (irq_reg[max8998_irqs[i].reg - 1] & max8998_irqs[i].mask) {\r\nirq = irq_find_mapping(max8998->irq_domain, i);\r\nif (WARN_ON(!irq)) {\r\ndisable_irq_nosync(max8998->irq);\r\nreturn IRQ_NONE;\r\n}\r\nhandle_nested_irq(irq);\r\n}\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nint max8998_irq_resume(struct max8998_dev *max8998)\r\n{\r\nif (max8998->irq && max8998->irq_domain)\r\nmax8998_irq_thread(max8998->irq, max8998);\r\nreturn 0;\r\n}\r\nstatic int max8998_irq_domain_map(struct irq_domain *d, unsigned int irq,\r\nirq_hw_number_t hw)\r\n{\r\nstruct max8997_dev *max8998 = d->host_data;\r\nirq_set_chip_data(irq, max8998);\r\nirq_set_chip_and_handler(irq, &max8998_irq_chip, handle_edge_irq);\r\nirq_set_nested_thread(irq, 1);\r\n#ifdef CONFIG_ARM\r\nset_irq_flags(irq, IRQF_VALID);\r\n#else\r\nirq_set_noprobe(irq);\r\n#endif\r\nreturn 0;\r\n}\r\nint max8998_irq_init(struct max8998_dev *max8998)\r\n{\r\nint i;\r\nint ret;\r\nstruct irq_domain *domain;\r\nif (!max8998->irq) {\r\ndev_warn(max8998->dev,\r\n"No interrupt specified, no interrupts\n");\r\nreturn 0;\r\n}\r\nmutex_init(&max8998->irqlock);\r\nfor (i = 0; i < MAX8998_NUM_IRQ_REGS; i++) {\r\nmax8998->irq_masks_cur[i] = 0xff;\r\nmax8998->irq_masks_cache[i] = 0xff;\r\nmax8998_write_reg(max8998->i2c, MAX8998_REG_IRQM1 + i, 0xff);\r\n}\r\nmax8998_write_reg(max8998->i2c, MAX8998_REG_STATUSM1, 0xff);\r\nmax8998_write_reg(max8998->i2c, MAX8998_REG_STATUSM2, 0xff);\r\ndomain = irq_domain_add_simple(NULL, MAX8998_IRQ_NR,\r\nmax8998->irq_base, &max8998_irq_domain_ops, max8998);\r\nif (!domain) {\r\ndev_err(max8998->dev, "could not create irq domain\n");\r\nreturn -ENODEV;\r\n}\r\nmax8998->irq_domain = domain;\r\nret = request_threaded_irq(max8998->irq, NULL, max8998_irq_thread,\r\nIRQF_TRIGGER_FALLING | IRQF_ONESHOT,\r\n"max8998-irq", max8998);\r\nif (ret) {\r\ndev_err(max8998->dev, "Failed to request IRQ %d: %d\n",\r\nmax8998->irq, ret);\r\nreturn ret;\r\n}\r\nif (!max8998->ono)\r\nreturn 0;\r\nret = request_threaded_irq(max8998->ono, NULL, max8998_irq_thread,\r\nIRQF_TRIGGER_FALLING | IRQF_TRIGGER_RISING |\r\nIRQF_ONESHOT, "max8998-ono", max8998);\r\nif (ret)\r\ndev_err(max8998->dev, "Failed to request IRQ %d: %d\n",\r\nmax8998->ono, ret);\r\nreturn 0;\r\n}\r\nvoid max8998_irq_exit(struct max8998_dev *max8998)\r\n{\r\nif (max8998->ono)\r\nfree_irq(max8998->ono, max8998);\r\nif (max8998->irq)\r\nfree_irq(max8998->irq, max8998);\r\n}

static u8 calc_cksum(int start, int end, u8 *mem)\r\n{\r\nu8 tmp = 0;\r\nint i;\r\nfor (i = start; i < end; i++)\r\ntmp += mem[i];\r\nreturn tmp;\r\n}\r\nstatic u16 calc_img_cksum(u16 *start, int length)\r\n{\r\nu16 tmp = 0;\r\nwhile (length--)\r\ntmp += *start++;\r\nreturn tmp;\r\n}\r\nstatic int load_waveform(u8 *mem, size_t size, int m, int t,\r\nstruct metronomefb_par *par)\r\n{\r\nint tta;\r\nint wmta;\r\nint trn = 0;\r\nint i;\r\nunsigned char v;\r\nu8 cksum;\r\nint cksum_idx;\r\nint wfm_idx, owfm_idx;\r\nint mem_idx = 0;\r\nstruct waveform_hdr *wfm_hdr;\r\nu8 *metromem = par->metromem_wfm;\r\nstruct device *dev = par->info->dev;\r\nif (user_wfm_size)\r\nepd_frame_table[par->dt].wfm_size = user_wfm_size;\r\nif (size != epd_frame_table[par->dt].wfm_size) {\r\ndev_err(dev, "Error: unexpected size %Zd != %d\n", size,\r\nepd_frame_table[par->dt].wfm_size);\r\nreturn -EINVAL;\r\n}\r\nwfm_hdr = (struct waveform_hdr *) mem;\r\nif (wfm_hdr->fvsn != 1) {\r\ndev_err(dev, "Error: bad fvsn %x\n", wfm_hdr->fvsn);\r\nreturn -EINVAL;\r\n}\r\nif (wfm_hdr->luts != 0) {\r\ndev_err(dev, "Error: bad luts %x\n", wfm_hdr->luts);\r\nreturn -EINVAL;\r\n}\r\ncksum = calc_cksum(32, 47, mem);\r\nif (cksum != wfm_hdr->wfm_cs) {\r\ndev_err(dev, "Error: bad cksum %x != %x\n", cksum,\r\nwfm_hdr->wfm_cs);\r\nreturn -EINVAL;\r\n}\r\nwfm_hdr->mc += 1;\r\nwfm_hdr->trc += 1;\r\nfor (i = 0; i < 5; i++) {\r\nif (*(wfm_hdr->stuff2a + i) != 0) {\r\ndev_err(dev, "Error: unexpected value in padding\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\nif ((sizeof(*wfm_hdr) + wfm_hdr->trc) > size)\r\nreturn -EINVAL;\r\nfor (i = sizeof(*wfm_hdr); i <= sizeof(*wfm_hdr) + wfm_hdr->trc; i++) {\r\nif (mem[i] > t) {\r\ntrn = i - sizeof(*wfm_hdr) - 1;\r\nbreak;\r\n}\r\n}\r\ncksum_idx = sizeof(*wfm_hdr) + wfm_hdr->trc + 1;\r\nif (cksum_idx > size)\r\nreturn -EINVAL;\r\ncksum = calc_cksum(sizeof(*wfm_hdr), cksum_idx, mem);\r\nif (cksum != mem[cksum_idx]) {\r\ndev_err(dev, "Error: bad temperature range table cksum"\r\n" %x != %x\n", cksum, mem[cksum_idx]);\r\nreturn -EINVAL;\r\n}\r\nwmta = get_unaligned_le32(wfm_hdr->wmta) & 0x00FFFFFF;\r\ncksum_idx = wmta + m*4 + 3;\r\nif (cksum_idx > size)\r\nreturn -EINVAL;\r\ncksum = calc_cksum(cksum_idx - 3, cksum_idx, mem);\r\nif (cksum != mem[cksum_idx]) {\r\ndev_err(dev, "Error: bad mode table address cksum"\r\n" %x != %x\n", cksum, mem[cksum_idx]);\r\nreturn -EINVAL;\r\n}\r\ntta = get_unaligned_le32(mem + wmta + m * 4) & 0x00FFFFFF;\r\ncksum_idx = tta + trn*4 + 3;\r\nif (cksum_idx > size)\r\nreturn -EINVAL;\r\ncksum = calc_cksum(cksum_idx - 3, cksum_idx, mem);\r\nif (cksum != mem[cksum_idx]) {\r\ndev_err(dev, "Error: bad temperature table address cksum"\r\n" %x != %x\n", cksum, mem[cksum_idx]);\r\nreturn -EINVAL;\r\n}\r\nwfm_idx = get_unaligned_le32(mem + tta + trn * 4) & 0x00FFFFFF;\r\nowfm_idx = wfm_idx;\r\nif (wfm_idx > size)\r\nreturn -EINVAL;\r\nwhile (wfm_idx < size) {\r\nunsigned char rl;\r\nv = mem[wfm_idx++];\r\nif (v == wfm_hdr->swtb) {\r\nwhile (((v = mem[wfm_idx++]) != wfm_hdr->swtb) &&\r\nwfm_idx < size)\r\nmetromem[mem_idx++] = v;\r\ncontinue;\r\n}\r\nif (v == wfm_hdr->endb)\r\nbreak;\r\nrl = mem[wfm_idx++];\r\nfor (i = 0; i <= rl; i++)\r\nmetromem[mem_idx++] = v;\r\n}\r\ncksum_idx = wfm_idx;\r\nif (cksum_idx > size)\r\nreturn -EINVAL;\r\ncksum = calc_cksum(owfm_idx, cksum_idx, mem);\r\nif (cksum != mem[cksum_idx]) {\r\ndev_err(dev, "Error: bad waveform data cksum"\r\n" %x != %x\n", cksum, mem[cksum_idx]);\r\nreturn -EINVAL;\r\n}\r\npar->frame_count = (mem_idx/64);\r\nreturn 0;\r\n}\r\nstatic int metronome_display_cmd(struct metronomefb_par *par)\r\n{\r\nint i;\r\nu16 cs;\r\nu16 opcode;\r\nstatic u8 borderval;\r\nif (par->metromem_cmd->opcode == 0xCC40)\r\nopcode = cs = 0xCC41;\r\nelse\r\nopcode = cs = 0xCC40;\r\ni = 0;\r\npar->metromem_cmd->args[i] = 1 << 3\r\n| ((borderval++ % 4) & 0x0F) << 4\r\n| (par->frame_count - 1) << 8;\r\ncs += par->metromem_cmd->args[i++];\r\nmemset((u8 *) (par->metromem_cmd->args + i), 0, (32-i)*2);\r\npar->metromem_cmd->csum = cs;\r\npar->metromem_cmd->opcode = opcode;\r\nreturn par->board->met_wait_event_intr(par);\r\n}\r\nstatic int metronome_powerup_cmd(struct metronomefb_par *par)\r\n{\r\nint i;\r\nu16 cs;\r\npar->metromem_cmd->opcode = 0x1234;\r\ncs = par->metromem_cmd->opcode;\r\nfor (i = 0; i < 3; i++) {\r\npar->metromem_cmd->args[i] = 1024;\r\ncs += par->metromem_cmd->args[i];\r\n}\r\nmemset((u8 *) (par->metromem_cmd->args + i), 0, (32-i)*2);\r\npar->metromem_cmd->csum = cs;\r\nmsleep(1);\r\npar->board->set_rst(par, 1);\r\nmsleep(1);\r\npar->board->set_stdby(par, 1);\r\nreturn par->board->met_wait_event(par);\r\n}\r\nstatic int metronome_config_cmd(struct metronomefb_par *par)\r\n{\r\nmemcpy(par->metromem_cmd->args, epd_frame_table[par->dt].config,\r\nsizeof(epd_frame_table[par->dt].config));\r\nmemset((u8 *) (par->metromem_cmd->args + 4), 0, (32-4)*2);\r\npar->metromem_cmd->csum = 0xCC10;\r\npar->metromem_cmd->csum += calc_img_cksum(par->metromem_cmd->args, 4);\r\npar->metromem_cmd->opcode = 0xCC10;\r\nreturn par->board->met_wait_event(par);\r\n}\r\nstatic int metronome_init_cmd(struct metronomefb_par *par)\r\n{\r\nint i;\r\nu16 cs;\r\ncs = 0xCC20;\r\ni = 0;\r\npar->metromem_cmd->args[i] = 0;\r\ncs += par->metromem_cmd->args[i++];\r\nmemset((u8 *) (par->metromem_cmd->args + i), 0, (32-i)*2);\r\npar->metromem_cmd->csum = cs;\r\npar->metromem_cmd->opcode = 0xCC20;\r\nreturn par->board->met_wait_event(par);\r\n}\r\nstatic int metronome_init_regs(struct metronomefb_par *par)\r\n{\r\nint res;\r\nres = par->board->setup_io(par);\r\nif (res)\r\nreturn res;\r\nres = metronome_powerup_cmd(par);\r\nif (res)\r\nreturn res;\r\nres = metronome_config_cmd(par);\r\nif (res)\r\nreturn res;\r\nres = metronome_init_cmd(par);\r\nreturn res;\r\n}\r\nstatic void metronomefb_dpy_update(struct metronomefb_par *par)\r\n{\r\nint fbsize;\r\nu16 cksum;\r\nunsigned char *buf = (unsigned char __force *)par->info->screen_base;\r\nfbsize = par->info->fix.smem_len;\r\nmemcpy(par->metromem_img, buf, fbsize);\r\ncksum = calc_img_cksum((u16 *) par->metromem_img, fbsize/2);\r\n*((u16 *)(par->metromem_img) + fbsize/2) = cksum;\r\nmetronome_display_cmd(par);\r\n}\r\nstatic u16 metronomefb_dpy_update_page(struct metronomefb_par *par, int index)\r\n{\r\nint i;\r\nu16 csum = 0;\r\nu16 *buf = (u16 __force *)(par->info->screen_base + index);\r\nu16 *img = (u16 *)(par->metromem_img + index);\r\nfor (i = 0; i < PAGE_SIZE/2; i++) {\r\n*(img + i) = (buf[i] << 5) & 0xE0E0;\r\ncsum += *(img + i);\r\n}\r\nreturn csum;\r\n}\r\nstatic void metronomefb_dpy_deferred_io(struct fb_info *info,\r\nstruct list_head *pagelist)\r\n{\r\nu16 cksum;\r\nstruct page *cur;\r\nstruct fb_deferred_io *fbdefio = info->fbdefio;\r\nstruct metronomefb_par *par = info->par;\r\nlist_for_each_entry(cur, &fbdefio->pagelist, lru) {\r\ncksum = metronomefb_dpy_update_page(par,\r\n(cur->index << PAGE_SHIFT));\r\npar->metromem_img_csum -= par->csum_table[cur->index];\r\npar->csum_table[cur->index] = cksum;\r\npar->metromem_img_csum += cksum;\r\n}\r\nmetronome_display_cmd(par);\r\n}\r\nstatic void metronomefb_fillrect(struct fb_info *info,\r\nconst struct fb_fillrect *rect)\r\n{\r\nstruct metronomefb_par *par = info->par;\r\nsys_fillrect(info, rect);\r\nmetronomefb_dpy_update(par);\r\n}\r\nstatic void metronomefb_copyarea(struct fb_info *info,\r\nconst struct fb_copyarea *area)\r\n{\r\nstruct metronomefb_par *par = info->par;\r\nsys_copyarea(info, area);\r\nmetronomefb_dpy_update(par);\r\n}\r\nstatic void metronomefb_imageblit(struct fb_info *info,\r\nconst struct fb_image *image)\r\n{\r\nstruct metronomefb_par *par = info->par;\r\nsys_imageblit(info, image);\r\nmetronomefb_dpy_update(par);\r\n}\r\nstatic ssize_t metronomefb_write(struct fb_info *info, const char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct metronomefb_par *par = info->par;\r\nunsigned long p = *ppos;\r\nvoid *dst;\r\nint err = 0;\r\nunsigned long total_size;\r\nif (info->state != FBINFO_STATE_RUNNING)\r\nreturn -EPERM;\r\ntotal_size = info->fix.smem_len;\r\nif (p > total_size)\r\nreturn -EFBIG;\r\nif (count > total_size) {\r\nerr = -EFBIG;\r\ncount = total_size;\r\n}\r\nif (count + p > total_size) {\r\nif (!err)\r\nerr = -ENOSPC;\r\ncount = total_size - p;\r\n}\r\ndst = (void __force *)(info->screen_base + p);\r\nif (copy_from_user(dst, buf, count))\r\nerr = -EFAULT;\r\nif (!err)\r\n*ppos += count;\r\nmetronomefb_dpy_update(par);\r\nreturn (err) ? err : count;\r\n}\r\nstatic int metronomefb_probe(struct platform_device *dev)\r\n{\r\nstruct fb_info *info;\r\nstruct metronome_board *board;\r\nint retval = -ENOMEM;\r\nint videomemorysize;\r\nunsigned char *videomemory;\r\nstruct metronomefb_par *par;\r\nconst struct firmware *fw_entry;\r\nint i;\r\nint panel_type;\r\nint fw, fh;\r\nint epd_dt_index;\r\nboard = dev->dev.platform_data;\r\nif (!board)\r\nreturn -EINVAL;\r\nif (!try_module_get(board->owner))\r\nreturn -ENODEV;\r\ninfo = framebuffer_alloc(sizeof(struct metronomefb_par), &dev->dev);\r\nif (!info)\r\ngoto err;\r\npanel_type = board->get_panel_type();\r\nswitch (panel_type) {\r\ncase 6:\r\nepd_dt_index = 0;\r\nbreak;\r\ncase 8:\r\nepd_dt_index = 1;\r\nbreak;\r\ncase 97:\r\nepd_dt_index = 2;\r\nbreak;\r\ndefault:\r\ndev_err(&dev->dev, "Unexpected panel type. Defaulting to 6\n");\r\nepd_dt_index = 0;\r\nbreak;\r\n}\r\nfw = epd_frame_table[epd_dt_index].fw;\r\nfh = epd_frame_table[epd_dt_index].fh;\r\nvideomemorysize = PAGE_SIZE + (fw * fh);\r\nvideomemory = vzalloc(videomemorysize);\r\nif (!videomemory)\r\ngoto err_fb_rel;\r\ninfo->screen_base = (char __force __iomem *)videomemory;\r\ninfo->fbops = &metronomefb_ops;\r\nmetronomefb_fix.line_length = fw;\r\nmetronomefb_var.xres = fw;\r\nmetronomefb_var.yres = fh;\r\nmetronomefb_var.xres_virtual = fw;\r\nmetronomefb_var.yres_virtual = fh;\r\ninfo->var = metronomefb_var;\r\ninfo->fix = metronomefb_fix;\r\ninfo->fix.smem_len = videomemorysize;\r\npar = info->par;\r\npar->info = info;\r\npar->board = board;\r\npar->dt = epd_dt_index;\r\ninit_waitqueue_head(&par->waitq);\r\npar->csum_table = vmalloc(videomemorysize/PAGE_SIZE);\r\nif (!par->csum_table)\r\ngoto err_vfree;\r\nretval = board->setup_fb(par);\r\nif (retval) {\r\ndev_err(&dev->dev, "Failed to setup fb\n");\r\ngoto err_csum_table;\r\n}\r\nif ((!par->metromem_wfm) || (!par->metromem_img) ||\r\n(!par->metromem_dma)) {\r\ndev_err(&dev->dev, "fb access failure\n");\r\nretval = -EINVAL;\r\ngoto err_csum_table;\r\n}\r\ninfo->fix.smem_start = par->metromem_dma;\r\nretval = request_firmware(&fw_entry, "metronome.wbf", &dev->dev);\r\nif (retval < 0) {\r\ndev_err(&dev->dev, "Failed to get waveform\n");\r\ngoto err_csum_table;\r\n}\r\nretval = load_waveform((u8 *) fw_entry->data, fw_entry->size, 3, 31,\r\npar);\r\nrelease_firmware(fw_entry);\r\nif (retval < 0) {\r\ndev_err(&dev->dev, "Failed processing waveform\n");\r\ngoto err_csum_table;\r\n}\r\nif (board->setup_irq(info))\r\ngoto err_csum_table;\r\nretval = metronome_init_regs(par);\r\nif (retval < 0)\r\ngoto err_free_irq;\r\ninfo->flags = FBINFO_FLAG_DEFAULT | FBINFO_VIRTFB;\r\ninfo->fbdefio = &metronomefb_defio;\r\nfb_deferred_io_init(info);\r\nretval = fb_alloc_cmap(&info->cmap, 8, 0);\r\nif (retval < 0) {\r\ndev_err(&dev->dev, "Failed to allocate colormap\n");\r\ngoto err_free_irq;\r\n}\r\nfor (i = 0; i < 8; i++)\r\ninfo->cmap.red[i] = (((2*i)+1)*(0xFFFF))/16;\r\nmemcpy(info->cmap.green, info->cmap.red, sizeof(u16)*8);\r\nmemcpy(info->cmap.blue, info->cmap.red, sizeof(u16)*8);\r\nretval = register_framebuffer(info);\r\nif (retval < 0)\r\ngoto err_cmap;\r\nplatform_set_drvdata(dev, info);\r\ndev_dbg(&dev->dev,\r\n"fb%d: Metronome frame buffer device, using %dK of video"\r\n" memory\n", info->node, videomemorysize >> 10);\r\nreturn 0;\r\nerr_cmap:\r\nfb_dealloc_cmap(&info->cmap);\r\nerr_free_irq:\r\nboard->cleanup(par);\r\nerr_csum_table:\r\nvfree(par->csum_table);\r\nerr_vfree:\r\nvfree(videomemory);\r\nerr_fb_rel:\r\nframebuffer_release(info);\r\nerr:\r\nmodule_put(board->owner);\r\nreturn retval;\r\n}\r\nstatic int metronomefb_remove(struct platform_device *dev)\r\n{\r\nstruct fb_info *info = platform_get_drvdata(dev);\r\nif (info) {\r\nstruct metronomefb_par *par = info->par;\r\nunregister_framebuffer(info);\r\nfb_deferred_io_cleanup(info);\r\nfb_dealloc_cmap(&info->cmap);\r\npar->board->cleanup(par);\r\nvfree(par->csum_table);\r\nvfree((void __force *)info->screen_base);\r\nmodule_put(par->board->owner);\r\ndev_dbg(&dev->dev, "calling release\n");\r\nframebuffer_release(info);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init metronomefb_init(void)\r\n{\r\nreturn platform_driver_register(&metronomefb_driver);\r\n}\r\nstatic void __exit metronomefb_exit(void)\r\n{\r\nplatform_driver_unregister(&metronomefb_driver);\r\n}

int\r\nnv84_temp_get(struct nouveau_therm *therm)\r\n{\r\nreturn nv_rd32(therm, 0x20400);\r\n}\r\nstatic void\r\nnv84_therm_program_alarms(struct nouveau_therm *therm)\r\n{\r\nstruct nouveau_therm_priv *priv = (void *)therm;\r\nstruct nvbios_therm_sensor *sensor = &priv->bios_sensor;\r\nunsigned long flags;\r\nspin_lock_irqsave(&priv->sensor.alarm_program_lock, flags);\r\nnv_wr32(therm, 0x20000, 0x000003ff);\r\nnv_wr32(therm, 0x20484, sensor->thrs_shutdown.hysteresis);\r\nnv_wr32(therm, 0x20480, sensor->thrs_shutdown.temp);\r\nnv_wr32(therm, 0x204c4, sensor->thrs_fan_boost.temp);\r\nnv_wr32(therm, 0x204c0, sensor->thrs_critical.temp);\r\nnv_wr32(therm, 0x20414, sensor->thrs_down_clock.temp);\r\nspin_unlock_irqrestore(&priv->sensor.alarm_program_lock, flags);\r\nnv_debug(therm,\r\n"Programmed thresholds [ %d(%d), %d(%d), %d(%d), %d(%d) ]\n",\r\nsensor->thrs_fan_boost.temp, sensor->thrs_fan_boost.hysteresis,\r\nsensor->thrs_down_clock.temp,\r\nsensor->thrs_down_clock.hysteresis,\r\nsensor->thrs_critical.temp, sensor->thrs_critical.hysteresis,\r\nsensor->thrs_shutdown.temp, sensor->thrs_shutdown.hysteresis);\r\n}\r\nstatic void\r\nnv84_therm_threshold_hyst_emulation(struct nouveau_therm *therm,\r\nuint32_t thrs_reg, u8 status_bit,\r\nconst struct nvbios_therm_threshold *thrs,\r\nenum nouveau_therm_thrs thrs_name)\r\n{\r\nenum nouveau_therm_thrs_direction direction;\r\nenum nouveau_therm_thrs_state prev_state, new_state;\r\nint temp, cur;\r\nprev_state = nouveau_therm_sensor_get_threshold_state(therm, thrs_name);\r\ntemp = nv_rd32(therm, thrs_reg);\r\nif (temp == thrs->temp) {\r\nnv_wr32(therm, thrs_reg, thrs->temp - thrs->hysteresis);\r\nnew_state = NOUVEAU_THERM_THRS_HIGHER;\r\n} else {\r\nnv_wr32(therm, thrs_reg, thrs->temp);\r\nnew_state = NOUVEAU_THERM_THRS_LOWER;\r\n}\r\ncur = therm->temp_get(therm);\r\nif (new_state == NOUVEAU_THERM_THRS_LOWER && cur > thrs->temp)\r\nnew_state = NOUVEAU_THERM_THRS_HIGHER;\r\nelse if (new_state == NOUVEAU_THERM_THRS_HIGHER &&\r\ncur < thrs->temp - thrs->hysteresis)\r\nnew_state = NOUVEAU_THERM_THRS_LOWER;\r\nnouveau_therm_sensor_set_threshold_state(therm, thrs_name, new_state);\r\nif (prev_state < new_state)\r\ndirection = NOUVEAU_THERM_THRS_RISING;\r\nelse if (prev_state > new_state)\r\ndirection = NOUVEAU_THERM_THRS_FALLING;\r\nelse\r\nreturn;\r\nnouveau_therm_sensor_event(therm, thrs_name, direction);\r\n}\r\nstatic void\r\nnv84_therm_intr(struct nouveau_subdev *subdev)\r\n{\r\nstruct nouveau_therm *therm = nouveau_therm(subdev);\r\nstruct nouveau_therm_priv *priv = (void *)therm;\r\nstruct nvbios_therm_sensor *sensor = &priv->bios_sensor;\r\nunsigned long flags;\r\nuint32_t intr;\r\nspin_lock_irqsave(&priv->sensor.alarm_program_lock, flags);\r\nintr = nv_rd32(therm, 0x20100);\r\nif (intr & 0x002) {\r\nnv84_therm_threshold_hyst_emulation(therm, 0x20414, 24,\r\n&sensor->thrs_down_clock,\r\nNOUVEAU_THERM_THRS_DOWNCLOCK);\r\nintr &= ~0x002;\r\n}\r\nif (intr & 0x004) {\r\nnv84_therm_threshold_hyst_emulation(therm, 0x20480, 20,\r\n&sensor->thrs_shutdown,\r\nNOUVEAU_THERM_THRS_SHUTDOWN);\r\nintr &= ~0x004;\r\n}\r\nif (intr & 0x008) {\r\nnv84_therm_threshold_hyst_emulation(therm, 0x204c4, 21,\r\n&sensor->thrs_fan_boost,\r\nNOUVEAU_THERM_THRS_FANBOOST);\r\nintr &= ~0x008;\r\n}\r\nif (intr & 0x010) {\r\nnv84_therm_threshold_hyst_emulation(therm, 0x204c0, 22,\r\n&sensor->thrs_critical,\r\nNOUVEAU_THERM_THRS_CRITICAL);\r\nintr &= ~0x010;\r\n}\r\nif (intr)\r\nnv_error(therm, "unhandled intr 0x%08x\n", intr);\r\nnv_wr32(therm, 0x20100, 0xffffffff);\r\nnv_wr32(therm, 0x1100, 0x10000);\r\nspin_unlock_irqrestore(&priv->sensor.alarm_program_lock, flags);\r\n}\r\nstatic int\r\nnv84_therm_ctor(struct nouveau_object *parent,\r\nstruct nouveau_object *engine,\r\nstruct nouveau_oclass *oclass, void *data, u32 size,\r\nstruct nouveau_object **pobject)\r\n{\r\nstruct nv84_therm_priv *priv;\r\nint ret;\r\nret = nouveau_therm_create(parent, engine, oclass, &priv);\r\n*pobject = nv_object(priv);\r\nif (ret)\r\nreturn ret;\r\npriv->base.base.pwm_ctrl = nv50_fan_pwm_ctrl;\r\npriv->base.base.pwm_get = nv50_fan_pwm_get;\r\npriv->base.base.pwm_set = nv50_fan_pwm_set;\r\npriv->base.base.pwm_clock = nv50_fan_pwm_clock;\r\npriv->base.base.temp_get = nv84_temp_get;\r\npriv->base.sensor.program_alarms = nv84_therm_program_alarms;\r\nnv_subdev(priv)->intr = nv84_therm_intr;\r\nnouveau_therm_sensor_set_threshold_state(&priv->base.base,\r\nNOUVEAU_THERM_THRS_SHUTDOWN,\r\nNOUVEAU_THERM_THRS_LOWER);\r\nnouveau_therm_sensor_set_threshold_state(&priv->base.base,\r\nNOUVEAU_THERM_THRS_FANBOOST,\r\nNOUVEAU_THERM_THRS_LOWER);\r\nnouveau_therm_sensor_set_threshold_state(&priv->base.base,\r\nNOUVEAU_THERM_THRS_CRITICAL,\r\nNOUVEAU_THERM_THRS_LOWER);\r\nnouveau_therm_sensor_set_threshold_state(&priv->base.base,\r\nNOUVEAU_THERM_THRS_DOWNCLOCK,\r\nNOUVEAU_THERM_THRS_LOWER);\r\nreturn nouveau_therm_preinit(&priv->base.base);\r\n}

static int ipoib_fill_info(struct sk_buff *skb, const struct net_device *dev)\r\n{\r\nstruct ipoib_dev_priv *priv = netdev_priv(dev);\r\nu16 val;\r\nif (nla_put_u16(skb, IFLA_IPOIB_PKEY, priv->pkey))\r\ngoto nla_put_failure;\r\nval = test_bit(IPOIB_FLAG_ADMIN_CM, &priv->flags);\r\nif (nla_put_u16(skb, IFLA_IPOIB_MODE, val))\r\ngoto nla_put_failure;\r\nval = test_bit(IPOIB_FLAG_UMCAST, &priv->flags);\r\nif (nla_put_u16(skb, IFLA_IPOIB_UMCAST, val))\r\ngoto nla_put_failure;\r\nreturn 0;\r\nnla_put_failure:\r\nreturn -EMSGSIZE;\r\n}\r\nstatic int ipoib_changelink(struct net_device *dev,\r\nstruct nlattr *tb[], struct nlattr *data[])\r\n{\r\nu16 mode, umcast;\r\nint ret = 0;\r\nif (data[IFLA_IPOIB_MODE]) {\r\nmode = nla_get_u16(data[IFLA_IPOIB_MODE]);\r\nif (mode == IPOIB_MODE_DATAGRAM)\r\nret = ipoib_set_mode(dev, "datagram\n");\r\nelse if (mode == IPOIB_MODE_CONNECTED)\r\nret = ipoib_set_mode(dev, "connected\n");\r\nelse\r\nret = -EINVAL;\r\nif (ret < 0)\r\ngoto out_err;\r\n}\r\nif (data[IFLA_IPOIB_UMCAST]) {\r\numcast = nla_get_u16(data[IFLA_IPOIB_UMCAST]);\r\nipoib_set_umcast(dev, umcast);\r\n}\r\nout_err:\r\nreturn ret;\r\n}\r\nstatic int ipoib_new_child_link(struct net *src_net, struct net_device *dev,\r\nstruct nlattr *tb[], struct nlattr *data[])\r\n{\r\nstruct net_device *pdev;\r\nstruct ipoib_dev_priv *ppriv;\r\nu16 child_pkey;\r\nint err;\r\nif (!tb[IFLA_LINK])\r\nreturn -EINVAL;\r\npdev = __dev_get_by_index(src_net, nla_get_u32(tb[IFLA_LINK]));\r\nif (!pdev)\r\nreturn -ENODEV;\r\nppriv = netdev_priv(pdev);\r\nif (test_bit(IPOIB_FLAG_SUBINTERFACE, &ppriv->flags)) {\r\nipoib_warn(ppriv, "child creation disallowed for child devices\n");\r\nreturn -EINVAL;\r\n}\r\nif (!data || !data[IFLA_IPOIB_PKEY]) {\r\nipoib_dbg(ppriv, "no pkey specified, using parent pkey\n");\r\nchild_pkey = ppriv->pkey;\r\n} else\r\nchild_pkey = nla_get_u16(data[IFLA_IPOIB_PKEY]);\r\nif (child_pkey == 0 || child_pkey == 0x8000)\r\nreturn -EINVAL;\r\nchild_pkey |= 0x8000;\r\nerr = __ipoib_vlan_add(ppriv, netdev_priv(dev), child_pkey, IPOIB_RTNL_CHILD);\r\nif (!err && data)\r\nerr = ipoib_changelink(dev, tb, data);\r\nreturn err;\r\n}\r\nstatic void ipoib_unregister_child_dev(struct net_device *dev, struct list_head *head)\r\n{\r\nstruct ipoib_dev_priv *priv, *ppriv;\r\npriv = netdev_priv(dev);\r\nppriv = netdev_priv(priv->parent);\r\nmutex_lock(&ppriv->vlan_mutex);\r\nunregister_netdevice_queue(dev, head);\r\nlist_del(&priv->list);\r\nmutex_unlock(&ppriv->vlan_mutex);\r\n}\r\nstatic size_t ipoib_get_size(const struct net_device *dev)\r\n{\r\nreturn nla_total_size(2) +\r\nnla_total_size(2) +\r\nnla_total_size(2);\r\n}\r\nint __init ipoib_netlink_init(void)\r\n{\r\nreturn rtnl_link_register(&ipoib_link_ops);\r\n}\r\nvoid __exit ipoib_netlink_fini(void)\r\n{\r\nrtnl_link_unregister(&ipoib_link_ops);\r\n}

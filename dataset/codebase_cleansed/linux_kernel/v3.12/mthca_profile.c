s64 mthca_make_profile(struct mthca_dev *dev,\r\nstruct mthca_profile *request,\r\nstruct mthca_dev_lim *dev_lim,\r\nstruct mthca_init_hca_param *init_hca)\r\n{\r\nstruct mthca_resource {\r\nu64 size;\r\nu64 start;\r\nint type;\r\nint num;\r\nint log_num;\r\n};\r\nu64 mem_base, mem_avail;\r\ns64 total_size = 0;\r\nstruct mthca_resource *profile;\r\nstruct mthca_resource tmp;\r\nint i, j;\r\nprofile = kzalloc(MTHCA_RES_NUM * sizeof *profile, GFP_KERNEL);\r\nif (!profile)\r\nreturn -ENOMEM;\r\nprofile[MTHCA_RES_QP].size = dev_lim->qpc_entry_sz;\r\nprofile[MTHCA_RES_EEC].size = dev_lim->eec_entry_sz;\r\nprofile[MTHCA_RES_SRQ].size = dev_lim->srq_entry_sz;\r\nprofile[MTHCA_RES_CQ].size = dev_lim->cqc_entry_sz;\r\nprofile[MTHCA_RES_EQP].size = dev_lim->eqpc_entry_sz;\r\nprofile[MTHCA_RES_EEEC].size = dev_lim->eeec_entry_sz;\r\nprofile[MTHCA_RES_EQ].size = dev_lim->eqc_entry_sz;\r\nprofile[MTHCA_RES_RDB].size = MTHCA_RDB_ENTRY_SIZE;\r\nprofile[MTHCA_RES_MCG].size = MTHCA_MGM_ENTRY_SIZE;\r\nprofile[MTHCA_RES_MPT].size = dev_lim->mpt_entry_sz;\r\nprofile[MTHCA_RES_MTT].size = dev->limits.mtt_seg_size;\r\nprofile[MTHCA_RES_UAR].size = dev_lim->uar_scratch_entry_sz;\r\nprofile[MTHCA_RES_UDAV].size = MTHCA_AV_SIZE;\r\nprofile[MTHCA_RES_UARC].size = request->uarc_size;\r\nprofile[MTHCA_RES_QP].num = request->num_qp;\r\nprofile[MTHCA_RES_SRQ].num = request->num_srq;\r\nprofile[MTHCA_RES_EQP].num = request->num_qp;\r\nprofile[MTHCA_RES_RDB].num = request->num_qp * request->rdb_per_qp;\r\nprofile[MTHCA_RES_CQ].num = request->num_cq;\r\nprofile[MTHCA_RES_EQ].num = MTHCA_NUM_EQS;\r\nprofile[MTHCA_RES_MCG].num = request->num_mcg;\r\nprofile[MTHCA_RES_MPT].num = request->num_mpt;\r\nprofile[MTHCA_RES_MTT].num = request->num_mtt;\r\nprofile[MTHCA_RES_UAR].num = request->num_uar;\r\nprofile[MTHCA_RES_UARC].num = request->num_uar;\r\nprofile[MTHCA_RES_UDAV].num = request->num_udav;\r\nfor (i = 0; i < MTHCA_RES_NUM; ++i) {\r\nprofile[i].type = i;\r\nprofile[i].log_num = max(ffs(profile[i].num) - 1, 0);\r\nprofile[i].size *= profile[i].num;\r\nif (mthca_is_memfree(dev))\r\nprofile[i].size = max(profile[i].size, (u64) PAGE_SIZE);\r\n}\r\nif (mthca_is_memfree(dev)) {\r\nmem_base = 0;\r\nmem_avail = dev_lim->hca.arbel.max_icm_sz;\r\n} else {\r\nmem_base = dev->ddr_start;\r\nmem_avail = dev->fw.tavor.fw_start - dev->ddr_start;\r\n}\r\nfor (i = MTHCA_RES_NUM; i > 0; --i)\r\nfor (j = 1; j < i; ++j) {\r\nif (profile[j].size > profile[j - 1].size) {\r\ntmp = profile[j];\r\nprofile[j] = profile[j - 1];\r\nprofile[j - 1] = tmp;\r\n}\r\n}\r\nfor (i = 0; i < MTHCA_RES_NUM; ++i) {\r\nif (profile[i].size) {\r\nprofile[i].start = mem_base + total_size;\r\ntotal_size += profile[i].size;\r\n}\r\nif (total_size > mem_avail) {\r\nmthca_err(dev, "Profile requires 0x%llx bytes; "\r\n"won't fit in 0x%llx bytes of context memory.\n",\r\n(unsigned long long) total_size,\r\n(unsigned long long) mem_avail);\r\nkfree(profile);\r\nreturn -ENOMEM;\r\n}\r\nif (profile[i].size)\r\nmthca_dbg(dev, "profile[%2d]--%2d/%2d @ 0x%16llx "\r\n"(size 0x%8llx)\n",\r\ni, profile[i].type, profile[i].log_num,\r\n(unsigned long long) profile[i].start,\r\n(unsigned long long) profile[i].size);\r\n}\r\nif (mthca_is_memfree(dev))\r\nmthca_dbg(dev, "HCA context memory: reserving %d KB\n",\r\n(int) (total_size >> 10));\r\nelse\r\nmthca_dbg(dev, "HCA memory: allocated %d KB/%d KB (%d KB free)\n",\r\n(int) (total_size >> 10), (int) (mem_avail >> 10),\r\n(int) ((mem_avail - total_size) >> 10));\r\nfor (i = 0; i < MTHCA_RES_NUM; ++i) {\r\nswitch (profile[i].type) {\r\ncase MTHCA_RES_QP:\r\ndev->limits.num_qps = profile[i].num;\r\ninit_hca->qpc_base = profile[i].start;\r\ninit_hca->log_num_qps = profile[i].log_num;\r\nbreak;\r\ncase MTHCA_RES_EEC:\r\ndev->limits.num_eecs = profile[i].num;\r\ninit_hca->eec_base = profile[i].start;\r\ninit_hca->log_num_eecs = profile[i].log_num;\r\nbreak;\r\ncase MTHCA_RES_SRQ:\r\ndev->limits.num_srqs = profile[i].num;\r\ninit_hca->srqc_base = profile[i].start;\r\ninit_hca->log_num_srqs = profile[i].log_num;\r\nbreak;\r\ncase MTHCA_RES_CQ:\r\ndev->limits.num_cqs = profile[i].num;\r\ninit_hca->cqc_base = profile[i].start;\r\ninit_hca->log_num_cqs = profile[i].log_num;\r\nbreak;\r\ncase MTHCA_RES_EQP:\r\ninit_hca->eqpc_base = profile[i].start;\r\nbreak;\r\ncase MTHCA_RES_EEEC:\r\ninit_hca->eeec_base = profile[i].start;\r\nbreak;\r\ncase MTHCA_RES_EQ:\r\ndev->limits.num_eqs = profile[i].num;\r\ninit_hca->eqc_base = profile[i].start;\r\ninit_hca->log_num_eqs = profile[i].log_num;\r\nbreak;\r\ncase MTHCA_RES_RDB:\r\nfor (dev->qp_table.rdb_shift = 0;\r\nrequest->num_qp << dev->qp_table.rdb_shift < profile[i].num;\r\n++dev->qp_table.rdb_shift)\r\n;\r\ndev->qp_table.rdb_base = (u32) profile[i].start;\r\ninit_hca->rdb_base = profile[i].start;\r\nbreak;\r\ncase MTHCA_RES_MCG:\r\ndev->limits.num_mgms = profile[i].num >> 1;\r\ndev->limits.num_amgms = profile[i].num >> 1;\r\ninit_hca->mc_base = profile[i].start;\r\ninit_hca->log_mc_entry_sz = ffs(MTHCA_MGM_ENTRY_SIZE) - 1;\r\ninit_hca->log_mc_table_sz = profile[i].log_num;\r\ninit_hca->mc_hash_sz = 1 << (profile[i].log_num - 1);\r\nbreak;\r\ncase MTHCA_RES_MPT:\r\ndev->limits.num_mpts = profile[i].num;\r\ndev->mr_table.mpt_base = profile[i].start;\r\ninit_hca->mpt_base = profile[i].start;\r\ninit_hca->log_mpt_sz = profile[i].log_num;\r\nbreak;\r\ncase MTHCA_RES_MTT:\r\ndev->limits.num_mtt_segs = profile[i].num;\r\ndev->mr_table.mtt_base = profile[i].start;\r\ninit_hca->mtt_base = profile[i].start;\r\ninit_hca->mtt_seg_sz = ffs(dev->limits.mtt_seg_size) - 7;\r\nbreak;\r\ncase MTHCA_RES_UAR:\r\ndev->limits.num_uars = profile[i].num;\r\ninit_hca->uar_scratch_base = profile[i].start;\r\nbreak;\r\ncase MTHCA_RES_UDAV:\r\ndev->av_table.ddr_av_base = profile[i].start;\r\ndev->av_table.num_ddr_avs = profile[i].num;\r\nbreak;\r\ncase MTHCA_RES_UARC:\r\ndev->uar_table.uarc_size = request->uarc_size;\r\ndev->uar_table.uarc_base = profile[i].start;\r\ninit_hca->uarc_base = profile[i].start;\r\ninit_hca->log_uarc_sz = ffs(request->uarc_size) - 13;\r\ninit_hca->log_uar_sz = ffs(request->num_uar) - 1;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\ndev->limits.num_pds = MTHCA_NUM_PDS;\r\nif (dev->mthca_flags & MTHCA_FLAG_SINAI_OPT &&\r\ninit_hca->log_mpt_sz > 23) {\r\nmthca_warn(dev, "MPT table too large (requested size 2^%d >= 2^24)\n",\r\ninit_hca->log_mpt_sz);\r\nmthca_warn(dev, "Disabling memory key throughput optimization.\n");\r\ndev->mthca_flags &= ~MTHCA_FLAG_SINAI_OPT;\r\n}\r\nif (mthca_is_memfree(dev) || BITS_PER_LONG == 64)\r\ndev->limits.fmr_reserved_mtts = 0;\r\nelse\r\ndev->limits.fmr_reserved_mtts = request->fmr_reserved_mtts;\r\nkfree(profile);\r\nreturn total_size;\r\n}

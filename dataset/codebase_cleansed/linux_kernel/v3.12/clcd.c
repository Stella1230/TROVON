int nspire_clcd_setup(struct clcd_fb *fb)\r\n{\r\nstruct clcd_panel *panel;\r\nsize_t panel_size;\r\nconst char *type;\r\ndma_addr_t dma;\r\nint err;\r\nBUG_ON(!fb->dev->dev.of_node);\r\nerr = of_property_read_string(fb->dev->dev.of_node, "lcd-type", &type);\r\nif (err) {\r\npr_err("CLCD: Could not find lcd-type property\n");\r\nreturn err;\r\n}\r\nif (!strcmp(type, "cx")) {\r\npanel = &nspire_cx_lcd_panel;\r\n} else if (!strcmp(type, "classic")) {\r\npanel = &nspire_classic_lcd_panel;\r\n} else {\r\npr_err("CLCD: Unknown lcd-type %s\n", type);\r\nreturn -EINVAL;\r\n}\r\npanel_size = ((panel->mode.xres * panel->mode.yres) * panel->bpp) / 8;\r\npanel_size = ALIGN(panel_size, PAGE_SIZE);\r\nfb->fb.screen_base = dma_alloc_writecombine(&fb->dev->dev,\r\npanel_size, &dma, GFP_KERNEL);\r\nif (!fb->fb.screen_base) {\r\npr_err("CLCD: unable to map framebuffer\n");\r\nreturn -ENOMEM;\r\n}\r\nfb->fb.fix.smem_start = dma;\r\nfb->fb.fix.smem_len = panel_size;\r\nfb->panel = panel;\r\nreturn 0;\r\n}\r\nint nspire_clcd_mmap(struct clcd_fb *fb, struct vm_area_struct *vma)\r\n{\r\nreturn dma_mmap_writecombine(&fb->dev->dev, vma,\r\nfb->fb.screen_base, fb->fb.fix.smem_start,\r\nfb->fb.fix.smem_len);\r\n}\r\nvoid nspire_clcd_remove(struct clcd_fb *fb)\r\n{\r\ndma_free_writecombine(&fb->dev->dev, fb->fb.fix.smem_len,\r\nfb->fb.screen_base, fb->fb.fix.smem_start);\r\n}

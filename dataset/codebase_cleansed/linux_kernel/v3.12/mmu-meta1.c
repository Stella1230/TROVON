static unsigned long map_addr(unsigned long phys)\r\n{\r\nstatic unsigned long dm_base = 0xFFFFFFFF;\r\nint offset;\r\noffset = phys - dm_base;\r\nif ((offset < 0) || (offset >= MMCU_DIRECTMAPn_ADDR_SCALE)) {\r\ndm_base = phys & ~(MMCU_DIRECTMAPn_ADDR_SCALE - 1);\r\nmetag_out32(dm_base, MMCU_DIRECTMAP3_ADDR);\r\noffset = phys - dm_base;\r\n}\r\nreturn DM3_BASE + offset;\r\n}\r\nstatic inline unsigned long __get_mmu_base(void)\r\n{\r\nunsigned long base_phys;\r\nunsigned int stride;\r\nif (is_global_space(PAGE_OFFSET))\r\nstride = 4;\r\nelse\r\nstride = hard_processor_id();\r\nbase_phys = metag_in32(MMCU_TABLE_PHYS_ADDR);\r\nbase_phys += (0x800 * stride);\r\nreturn base_phys;\r\n}\r\nstatic unsigned long pgd_entry_addr(unsigned long virt)\r\n{\r\nunsigned long pgd_phys;\r\nunsigned long pgd_virt;\r\nif (!mmu_base_phys)\r\nmmu_base_phys = __get_mmu_base();\r\nif (is_global_space(virt)) {\r\nvirt &= ~0x80000000;\r\n}\r\npgd_phys = mmu_base_phys + ((virt >> PGDIR_SHIFT) * 4);\r\npgd_virt = map_addr(pgd_phys);\r\nreturn pgd_virt;\r\n}\r\nstatic unsigned long pgtable_entry_addr(unsigned long virt)\r\n{\r\nunsigned long pgtable_phys;\r\nunsigned long pgtable_virt, pte_virt;\r\npgtable_phys = metag_in32(pgd_entry_addr(virt)) & MMCU_ENTRY_ADDR_BITS;\r\npgtable_virt = map_addr(pgtable_phys);\r\npte_virt = pgtable_virt + ((virt >> PAGE_SHIFT) & 0x3FF) * 4;\r\nreturn pte_virt;\r\n}\r\nunsigned long mmu_read_first_level_page(unsigned long vaddr)\r\n{\r\nreturn metag_in32(pgd_entry_addr(vaddr));\r\n}\r\nunsigned long mmu_read_second_level_page(unsigned long vaddr)\r\n{\r\nreturn metag_in32(pgtable_entry_addr(vaddr));\r\n}\r\nunsigned long mmu_get_base(void)\r\n{\r\nstatic unsigned long __base;\r\nif (!__base)\r\n__base = pgd_entry_addr(0);\r\nreturn __base;\r\n}\r\nvoid __init mmu_init(unsigned long mem_end)\r\n{\r\nunsigned long entry, addr;\r\npgd_t *p_swapper_pg_dir;\r\naddr = PAGE_OFFSET;\r\nentry = pgd_index(PAGE_OFFSET);\r\np_swapper_pg_dir = pgd_offset_k(0) + entry;\r\nwhile (addr <= META_MEMORY_LIMIT) {\r\nunsigned long pgd_entry;\r\npgd_entry = mmu_read_first_level_page(addr);\r\npgd_val(*p_swapper_pg_dir) = pgd_entry;\r\np_swapper_pg_dir++;\r\naddr += PGDIR_SIZE;\r\nentry++;\r\n}\r\n}

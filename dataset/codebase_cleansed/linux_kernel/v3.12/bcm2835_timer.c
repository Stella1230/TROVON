static u32 notrace bcm2835_sched_read(void)\r\n{\r\nreturn readl_relaxed(system_clock);\r\n}\r\nstatic void bcm2835_time_set_mode(enum clock_event_mode mode,\r\nstruct clock_event_device *evt_dev)\r\n{\r\nswitch (mode) {\r\ncase CLOCK_EVT_MODE_ONESHOT:\r\ncase CLOCK_EVT_MODE_UNUSED:\r\ncase CLOCK_EVT_MODE_SHUTDOWN:\r\ncase CLOCK_EVT_MODE_RESUME:\r\nbreak;\r\ndefault:\r\nWARN(1, "%s: unhandled event mode %d\n", __func__, mode);\r\nbreak;\r\n}\r\n}\r\nstatic int bcm2835_time_set_next_event(unsigned long event,\r\nstruct clock_event_device *evt_dev)\r\n{\r\nstruct bcm2835_timer *timer = container_of(evt_dev,\r\nstruct bcm2835_timer, evt);\r\nwritel_relaxed(readl_relaxed(system_clock) + event,\r\ntimer->compare);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t bcm2835_time_interrupt(int irq, void *dev_id)\r\n{\r\nstruct bcm2835_timer *timer = dev_id;\r\nvoid (*event_handler)(struct clock_event_device *);\r\nif (readl_relaxed(timer->control) & timer->match_mask) {\r\nwritel_relaxed(timer->match_mask, timer->control);\r\nevent_handler = ACCESS_ONCE(timer->evt.event_handler);\r\nif (event_handler)\r\nevent_handler(&timer->evt);\r\nreturn IRQ_HANDLED;\r\n} else {\r\nreturn IRQ_NONE;\r\n}\r\n}\r\nstatic void __init bcm2835_timer_init(struct device_node *node)\r\n{\r\nvoid __iomem *base;\r\nu32 freq;\r\nint irq;\r\nstruct bcm2835_timer *timer;\r\nbase = of_iomap(node, 0);\r\nif (!base)\r\npanic("Can't remap registers");\r\nif (of_property_read_u32(node, "clock-frequency", &freq))\r\npanic("Can't read clock-frequency");\r\nsystem_clock = base + REG_COUNTER_LO;\r\nsetup_sched_clock(bcm2835_sched_read, 32, freq);\r\nclocksource_mmio_init(base + REG_COUNTER_LO, node->name,\r\nfreq, 300, 32, clocksource_mmio_readl_up);\r\nirq = irq_of_parse_and_map(node, DEFAULT_TIMER);\r\nif (irq <= 0)\r\npanic("Can't parse IRQ");\r\ntimer = kzalloc(sizeof(*timer), GFP_KERNEL);\r\nif (!timer)\r\npanic("Can't allocate timer struct\n");\r\ntimer->control = base + REG_CONTROL;\r\ntimer->compare = base + REG_COMPARE(DEFAULT_TIMER);\r\ntimer->match_mask = BIT(DEFAULT_TIMER);\r\ntimer->evt.name = node->name;\r\ntimer->evt.rating = 300;\r\ntimer->evt.features = CLOCK_EVT_FEAT_ONESHOT;\r\ntimer->evt.set_mode = bcm2835_time_set_mode;\r\ntimer->evt.set_next_event = bcm2835_time_set_next_event;\r\ntimer->evt.cpumask = cpumask_of(0);\r\ntimer->act.name = node->name;\r\ntimer->act.flags = IRQF_TIMER | IRQF_SHARED;\r\ntimer->act.dev_id = timer;\r\ntimer->act.handler = bcm2835_time_interrupt;\r\nif (setup_irq(irq, &timer->act))\r\npanic("Can't set up timer IRQ\n");\r\nclockevents_config_and_register(&timer->evt, freq, 0xf, 0xffffffff);\r\npr_info("bcm2835: system timer (irq = %d)\n", irq);\r\n}

static void __init mp_sfi_register_lapic(u8 id)\r\n{\r\nif (MAX_LOCAL_APIC - id <= 0) {\r\npr_warning("Processor #%d invalid (max %d)\n",\r\nid, MAX_LOCAL_APIC);\r\nreturn;\r\n}\r\npr_info("registering lapic[%d]\n", id);\r\ngeneric_processor_info(id, GET_APIC_VERSION(apic_read(APIC_LVR)));\r\n}\r\nstatic int __init sfi_parse_cpus(struct sfi_table_header *table)\r\n{\r\nstruct sfi_table_simple *sb;\r\nstruct sfi_cpu_table_entry *pentry;\r\nint i;\r\nint cpu_num;\r\nsb = (struct sfi_table_simple *)table;\r\ncpu_num = SFI_GET_NUM_ENTRIES(sb, struct sfi_cpu_table_entry);\r\npentry = (struct sfi_cpu_table_entry *)sb->pentry;\r\nfor (i = 0; i < cpu_num; i++) {\r\nmp_sfi_register_lapic(pentry->apic_id);\r\npentry++;\r\n}\r\nsmp_found_config = 1;\r\nreturn 0;\r\n}\r\nstatic int __init sfi_parse_ioapic(struct sfi_table_header *table)\r\n{\r\nstruct sfi_table_simple *sb;\r\nstruct sfi_apic_table_entry *pentry;\r\nint i, num;\r\nsb = (struct sfi_table_simple *)table;\r\nnum = SFI_GET_NUM_ENTRIES(sb, struct sfi_apic_table_entry);\r\npentry = (struct sfi_apic_table_entry *)sb->pentry;\r\nfor (i = 0; i < num; i++) {\r\nmp_register_ioapic(i, pentry->phys_addr, gsi_top);\r\npentry++;\r\n}\r\nWARN(pic_mode, KERN_WARNING\r\n"SFI: pic_mod shouldn't be 1 when IOAPIC table is present\n");\r\npic_mode = 0;\r\nreturn 0;\r\n}\r\nint __init sfi_platform_init(void)\r\n{\r\n#ifdef CONFIG_X86_LOCAL_APIC\r\nregister_lapic_address(sfi_lapic_addr);\r\nsfi_table_parse(SFI_SIG_CPUS, NULL, NULL, sfi_parse_cpus);\r\n#endif\r\n#ifdef CONFIG_X86_IO_APIC\r\nsfi_table_parse(SFI_SIG_APIC, NULL, NULL, sfi_parse_ioapic);\r\n#endif\r\nreturn 0;\r\n}

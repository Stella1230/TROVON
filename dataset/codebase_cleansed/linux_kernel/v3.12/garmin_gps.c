static inline int getLayerId(const __u8 *usbPacket)\r\n{\r\nreturn __le32_to_cpup((__le32 *)(usbPacket));\r\n}\r\nstatic inline int getPacketId(const __u8 *usbPacket)\r\n{\r\nreturn __le32_to_cpup((__le32 *)(usbPacket+4));\r\n}\r\nstatic inline int getDataLength(const __u8 *usbPacket)\r\n{\r\nreturn __le32_to_cpup((__le32 *)(usbPacket+8));\r\n}\r\nstatic inline int isAbortTrfCmnd(const unsigned char *buf)\r\n{\r\nif (0 == memcmp(buf, GARMIN_STOP_TRANSFER_REQ,\r\nsizeof(GARMIN_STOP_TRANSFER_REQ)) ||\r\n0 == memcmp(buf, GARMIN_STOP_TRANSFER_REQ_V2,\r\nsizeof(GARMIN_STOP_TRANSFER_REQ_V2)))\r\nreturn 1;\r\nelse\r\nreturn 0;\r\n}\r\nstatic void send_to_tty(struct usb_serial_port *port,\r\nchar *data, unsigned int actual_length)\r\n{\r\nif (actual_length) {\r\nusb_serial_debug_data(&port->dev, __func__, actual_length, data);\r\ntty_insert_flip_string(&port->port, data, actual_length);\r\ntty_flip_buffer_push(&port->port);\r\n}\r\n}\r\nstatic int pkt_add(struct garmin_data *garmin_data_p,\r\nunsigned char *data, unsigned int data_length)\r\n{\r\nint state = 0;\r\nint result = 0;\r\nunsigned long flags;\r\nstruct garmin_packet *pkt;\r\nif (data_length) {\r\npkt = kmalloc(sizeof(struct garmin_packet)+data_length,\r\nGFP_ATOMIC);\r\nif (pkt == NULL) {\r\ndev_err(&garmin_data_p->port->dev, "out of memory\n");\r\nreturn 0;\r\n}\r\npkt->size = data_length;\r\nmemcpy(pkt->data, data, data_length);\r\nspin_lock_irqsave(&garmin_data_p->lock, flags);\r\ngarmin_data_p->flags |= FLAGS_QUEUING;\r\nresult = list_empty(&garmin_data_p->pktlist);\r\npkt->seq = garmin_data_p->seq_counter++;\r\nlist_add_tail(&pkt->list, &garmin_data_p->pktlist);\r\nstate = garmin_data_p->state;\r\nspin_unlock_irqrestore(&garmin_data_p->lock, flags);\r\ndev_dbg(&garmin_data_p->port->dev,\r\n"%s - added: pkt: %d - %d bytes\n", __func__,\r\npkt->seq, data_length);\r\nif (result && (state == STATE_GSP_WAIT_DATA))\r\ngsp_next_packet(garmin_data_p);\r\n}\r\nreturn result;\r\n}\r\nstatic struct garmin_packet *pkt_pop(struct garmin_data *garmin_data_p)\r\n{\r\nunsigned long flags;\r\nstruct garmin_packet *result = NULL;\r\nspin_lock_irqsave(&garmin_data_p->lock, flags);\r\nif (!list_empty(&garmin_data_p->pktlist)) {\r\nresult = (struct garmin_packet *)garmin_data_p->pktlist.next;\r\nlist_del(&result->list);\r\n}\r\nspin_unlock_irqrestore(&garmin_data_p->lock, flags);\r\nreturn result;\r\n}\r\nstatic void pkt_clear(struct garmin_data *garmin_data_p)\r\n{\r\nunsigned long flags;\r\nstruct garmin_packet *result = NULL;\r\nspin_lock_irqsave(&garmin_data_p->lock, flags);\r\nwhile (!list_empty(&garmin_data_p->pktlist)) {\r\nresult = (struct garmin_packet *)garmin_data_p->pktlist.next;\r\nlist_del(&result->list);\r\nkfree(result);\r\n}\r\nspin_unlock_irqrestore(&garmin_data_p->lock, flags);\r\n}\r\nstatic int gsp_send_ack(struct garmin_data *garmin_data_p, __u8 pkt_id)\r\n{\r\n__u8 pkt[10];\r\n__u8 cksum = 0;\r\n__u8 *ptr = pkt;\r\nunsigned l = 0;\r\ndev_dbg(&garmin_data_p->port->dev, "%s - pkt-id: 0x%X.\n", __func__,\r\n0xFF & pkt_id);\r\n*ptr++ = DLE;\r\n*ptr++ = ACK;\r\ncksum += ACK;\r\n*ptr++ = 2;\r\ncksum += 2;\r\n*ptr++ = pkt_id;\r\ncksum += pkt_id;\r\nif (pkt_id == DLE)\r\n*ptr++ = DLE;\r\n*ptr++ = 0;\r\n*ptr++ = 0xFF & (-cksum);\r\n*ptr++ = DLE;\r\n*ptr++ = ETX;\r\nl = ptr-pkt;\r\nsend_to_tty(garmin_data_p->port, pkt, l);\r\nreturn 0;\r\n}\r\nstatic int gsp_rec_packet(struct garmin_data *garmin_data_p, int count)\r\n{\r\nstruct device *dev = &garmin_data_p->port->dev;\r\nunsigned long flags;\r\nconst __u8 *recpkt = garmin_data_p->inbuffer+GSP_INITIAL_OFFSET;\r\n__le32 *usbdata = (__le32 *) garmin_data_p->inbuffer;\r\nint cksum = 0;\r\nint n = 0;\r\nint pktid = recpkt[0];\r\nint size = recpkt[1];\r\nusb_serial_debug_data(&garmin_data_p->port->dev, __func__,\r\ncount-GSP_INITIAL_OFFSET, recpkt);\r\nif (size != (count-GSP_INITIAL_OFFSET-3)) {\r\ndev_dbg(dev, "%s - invalid size, expected %d bytes, got %d\n",\r\n__func__, size, (count-GSP_INITIAL_OFFSET-3));\r\nreturn -EINVPKT;\r\n}\r\ncksum += *recpkt++;\r\ncksum += *recpkt++;\r\nif ((__u8 *)&(usbdata[3]) != recpkt) {\r\ndev_dbg(dev, "%s - ptr mismatch %p - %p\n", __func__,\r\n&(usbdata[4]), recpkt);\r\nreturn -EINVPKT;\r\n}\r\nwhile (n < size) {\r\ncksum += *recpkt++;\r\nn++;\r\n}\r\nif ((0xff & (cksum + *recpkt)) != 0) {\r\ndev_dbg(dev, "%s - invalid checksum, expected %02x, got %02x\n",\r\n__func__, 0xff & -cksum, 0xff & *recpkt);\r\nreturn -EINVPKT;\r\n}\r\nusbdata[0] = __cpu_to_le32(GARMIN_LAYERID_APPL);\r\nusbdata[1] = __cpu_to_le32(pktid);\r\nusbdata[2] = __cpu_to_le32(size);\r\ngarmin_write_bulk(garmin_data_p->port, garmin_data_p->inbuffer,\r\nGARMIN_PKTHDR_LENGTH+size, 0);\r\nif (isAbortTrfCmnd(garmin_data_p->inbuffer)) {\r\nspin_lock_irqsave(&garmin_data_p->lock, flags);\r\ngarmin_data_p->flags |= FLAGS_DROP_DATA;\r\nspin_unlock_irqrestore(&garmin_data_p->lock, flags);\r\npkt_clear(garmin_data_p);\r\n}\r\nreturn count;\r\n}\r\nstatic int gsp_receive(struct garmin_data *garmin_data_p,\r\nconst unsigned char *buf, int count)\r\n{\r\nstruct device *dev = &garmin_data_p->port->dev;\r\nunsigned long flags;\r\nint offs = 0;\r\nint ack_or_nak_seen = 0;\r\n__u8 *dest;\r\nint size;\r\nint dleSeen;\r\nint skip;\r\n__u8 data;\r\nspin_lock_irqsave(&garmin_data_p->lock, flags);\r\ndest = garmin_data_p->inbuffer;\r\nsize = garmin_data_p->insize;\r\ndleSeen = garmin_data_p->flags & FLAGS_GSP_DLESEEN;\r\nskip = garmin_data_p->flags & FLAGS_GSP_SKIP;\r\nspin_unlock_irqrestore(&garmin_data_p->lock, flags);\r\nif (size == 0)\r\nsize = GSP_INITIAL_OFFSET;\r\nwhile (offs < count) {\r\ndata = *(buf+offs);\r\noffs++;\r\nif (data == DLE) {\r\nif (skip) {\r\nskip = 0;\r\nsize = GSP_INITIAL_OFFSET;\r\ndleSeen = 1;\r\n} else if (dleSeen) {\r\ndest[size++] = data;\r\ndleSeen = 0;\r\n} else {\r\ndleSeen = 1;\r\n}\r\n} else if (data == ETX) {\r\nif (dleSeen) {\r\ndata = dest[GSP_INITIAL_OFFSET];\r\nif (data == ACK) {\r\nack_or_nak_seen = ACK;\r\ndev_dbg(dev, "ACK packet complete.\n");\r\n} else if (data == NAK) {\r\nack_or_nak_seen = NAK;\r\ndev_dbg(dev, "NAK packet complete.\n");\r\n} else {\r\ndev_dbg(dev, "packet complete - id=0x%X.\n",\r\n0xFF & data);\r\ngsp_rec_packet(garmin_data_p, size);\r\n}\r\nskip = 1;\r\nsize = GSP_INITIAL_OFFSET;\r\ndleSeen = 0;\r\n} else {\r\ndest[size++] = data;\r\n}\r\n} else if (!skip) {\r\nif (dleSeen) {\r\nsize = GSP_INITIAL_OFFSET;\r\ndleSeen = 0;\r\n}\r\ndest[size++] = data;\r\n}\r\nif (size >= GPS_IN_BUFSIZ) {\r\ndev_dbg(dev, "%s - packet too large.\n", __func__);\r\nskip = 1;\r\nsize = GSP_INITIAL_OFFSET;\r\ndleSeen = 0;\r\n}\r\n}\r\nspin_lock_irqsave(&garmin_data_p->lock, flags);\r\ngarmin_data_p->insize = size;\r\nif (skip)\r\ngarmin_data_p->flags |= FLAGS_GSP_SKIP;\r\nelse\r\ngarmin_data_p->flags &= ~FLAGS_GSP_SKIP;\r\nif (dleSeen)\r\ngarmin_data_p->flags |= FLAGS_GSP_DLESEEN;\r\nelse\r\ngarmin_data_p->flags &= ~FLAGS_GSP_DLESEEN;\r\nspin_unlock_irqrestore(&garmin_data_p->lock, flags);\r\nif (ack_or_nak_seen) {\r\nif (gsp_next_packet(garmin_data_p) > 0)\r\ngarmin_data_p->state = STATE_ACTIVE;\r\nelse\r\ngarmin_data_p->state = STATE_GSP_WAIT_DATA;\r\n}\r\nreturn count;\r\n}\r\nstatic int gsp_send(struct garmin_data *garmin_data_p,\r\nconst unsigned char *buf, int count)\r\n{\r\nstruct device *dev = &garmin_data_p->port->dev;\r\nconst unsigned char *src;\r\nunsigned char *dst;\r\nint pktid = 0;\r\nint datalen = 0;\r\nint cksum = 0;\r\nint i = 0;\r\nint k;\r\ndev_dbg(dev, "%s - state %d - %d bytes.\n", __func__,\r\ngarmin_data_p->state, count);\r\nk = garmin_data_p->outsize;\r\nif ((k+count) > GPS_OUT_BUFSIZ) {\r\ndev_dbg(dev, "packet too large\n");\r\ngarmin_data_p->outsize = 0;\r\nreturn -4;\r\n}\r\nmemcpy(garmin_data_p->outbuffer+k, buf, count);\r\nk += count;\r\ngarmin_data_p->outsize = k;\r\nif (k >= GARMIN_PKTHDR_LENGTH) {\r\npktid = getPacketId(garmin_data_p->outbuffer);\r\ndatalen = getDataLength(garmin_data_p->outbuffer);\r\ni = GARMIN_PKTHDR_LENGTH + datalen;\r\nif (k < i)\r\nreturn 0;\r\n} else {\r\nreturn 0;\r\n}\r\ndev_dbg(dev, "%s - %d bytes in buffer, %d bytes in pkt.\n", __func__, k, i);\r\nusb_serial_debug_data(&garmin_data_p->port->dev, __func__, k,\r\ngarmin_data_p->outbuffer);\r\ngarmin_data_p->outsize = 0;\r\nif (GARMIN_LAYERID_APPL != getLayerId(garmin_data_p->outbuffer)) {\r\ndev_dbg(dev, "not an application packet (%d)\n",\r\ngetLayerId(garmin_data_p->outbuffer));\r\nreturn -1;\r\n}\r\nif (pktid > 255) {\r\ndev_dbg(dev, "packet-id %d too large\n", pktid);\r\nreturn -2;\r\n}\r\nif (datalen > 255) {\r\ndev_dbg(dev, "packet-size %d too large\n", datalen);\r\nreturn -3;\r\n}\r\nk = 0;\r\nsrc = garmin_data_p->outbuffer+GARMIN_PKTHDR_LENGTH;\r\nfor (i = 0; i < datalen; i++) {\r\nif (*src++ == DLE)\r\nk++;\r\n}\r\nsrc = garmin_data_p->outbuffer+GARMIN_PKTHDR_LENGTH;\r\nif (k > (GARMIN_PKTHDR_LENGTH-2)) {\r\ndst = garmin_data_p->outbuffer+GPS_OUT_BUFSIZ-datalen;\r\nmemcpy(dst, src, datalen);\r\nsrc = dst;\r\n}\r\ndst = garmin_data_p->outbuffer;\r\n*dst++ = DLE;\r\n*dst++ = pktid;\r\ncksum += pktid;\r\n*dst++ = datalen;\r\ncksum += datalen;\r\nif (datalen == DLE)\r\n*dst++ = DLE;\r\nfor (i = 0; i < datalen; i++) {\r\n__u8 c = *src++;\r\n*dst++ = c;\r\ncksum += c;\r\nif (c == DLE)\r\n*dst++ = DLE;\r\n}\r\ncksum = 0xFF & -cksum;\r\n*dst++ = cksum;\r\nif (cksum == DLE)\r\n*dst++ = DLE;\r\n*dst++ = DLE;\r\n*dst++ = ETX;\r\ni = dst-garmin_data_p->outbuffer;\r\nsend_to_tty(garmin_data_p->port, garmin_data_p->outbuffer, i);\r\ngarmin_data_p->pkt_id = pktid;\r\ngarmin_data_p->state = STATE_WAIT_TTY_ACK;\r\nreturn i;\r\n}\r\nstatic int gsp_next_packet(struct garmin_data *garmin_data_p)\r\n{\r\nint result = 0;\r\nstruct garmin_packet *pkt = NULL;\r\nwhile ((pkt = pkt_pop(garmin_data_p)) != NULL) {\r\ndev_dbg(&garmin_data_p->port->dev, "%s - next pkt: %d\n", __func__, pkt->seq);\r\nresult = gsp_send(garmin_data_p, pkt->data, pkt->size);\r\nif (result > 0) {\r\nkfree(pkt);\r\nreturn result;\r\n}\r\nkfree(pkt);\r\n}\r\nreturn result;\r\n}\r\nstatic int nat_receive(struct garmin_data *garmin_data_p,\r\nconst unsigned char *buf, int count)\r\n{\r\nunsigned long flags;\r\n__u8 *dest;\r\nint offs = 0;\r\nint result = count;\r\nint len;\r\nwhile (offs < count) {\r\nif (garmin_data_p->insize >= GARMIN_PKTHDR_LENGTH)\r\nlen = GARMIN_PKTHDR_LENGTH\r\n+getDataLength(garmin_data_p->inbuffer);\r\nelse\r\nlen = GARMIN_PKTHDR_LENGTH;\r\nif (len >= GPS_IN_BUFSIZ) {\r\ndev_dbg(&garmin_data_p->port->dev,\r\n"%s - packet size too large: %d\n",\r\n__func__, len);\r\ngarmin_data_p->insize = 0;\r\ncount = 0;\r\nresult = -EINVPKT;\r\n} else {\r\nlen -= garmin_data_p->insize;\r\nif (len > (count-offs))\r\nlen = (count-offs);\r\nif (len > 0) {\r\ndest = garmin_data_p->inbuffer\r\n+ garmin_data_p->insize;\r\nmemcpy(dest, buf+offs, len);\r\ngarmin_data_p->insize += len;\r\noffs += len;\r\n}\r\n}\r\nif (garmin_data_p->insize >= GARMIN_PKTHDR_LENGTH) {\r\nlen = GARMIN_PKTHDR_LENGTH+\r\ngetDataLength(garmin_data_p->inbuffer);\r\nif (garmin_data_p->insize >= len) {\r\ngarmin_write_bulk(garmin_data_p->port,\r\ngarmin_data_p->inbuffer,\r\nlen, 0);\r\ngarmin_data_p->insize = 0;\r\nif (isAbortTrfCmnd(garmin_data_p->inbuffer)) {\r\nspin_lock_irqsave(&garmin_data_p->lock,\r\nflags);\r\ngarmin_data_p->flags |= FLAGS_DROP_DATA;\r\nspin_unlock_irqrestore(\r\n&garmin_data_p->lock, flags);\r\npkt_clear(garmin_data_p);\r\n}\r\n}\r\n}\r\n}\r\nreturn result;\r\n}\r\nstatic void priv_status_resp(struct usb_serial_port *port)\r\n{\r\nstruct garmin_data *garmin_data_p = usb_get_serial_port_data(port);\r\n__le32 *pkt = (__le32 *)garmin_data_p->privpkt;\r\npkt[0] = __cpu_to_le32(GARMIN_LAYERID_PRIVATE);\r\npkt[1] = __cpu_to_le32(PRIV_PKTID_INFO_RESP);\r\npkt[2] = __cpu_to_le32(12);\r\npkt[3] = __cpu_to_le32(VERSION_MAJOR << 16 | VERSION_MINOR);\r\npkt[4] = __cpu_to_le32(garmin_data_p->mode);\r\npkt[5] = __cpu_to_le32(garmin_data_p->serial_num);\r\nsend_to_tty(port, (__u8 *)pkt, 6 * 4);\r\n}\r\nstatic int process_resetdev_request(struct usb_serial_port *port)\r\n{\r\nunsigned long flags;\r\nint status;\r\nstruct garmin_data *garmin_data_p = usb_get_serial_port_data(port);\r\nspin_lock_irqsave(&garmin_data_p->lock, flags);\r\ngarmin_data_p->flags &= ~(CLEAR_HALT_REQUIRED);\r\ngarmin_data_p->state = STATE_RESET;\r\ngarmin_data_p->serial_num = 0;\r\nspin_unlock_irqrestore(&garmin_data_p->lock, flags);\r\nusb_kill_urb(port->interrupt_in_urb);\r\ndev_dbg(&port->dev, "%s - usb_reset_device\n", __func__);\r\nstatus = usb_reset_device(port->serial->dev);\r\nif (status)\r\ndev_dbg(&port->dev, "%s - usb_reset_device failed: %d\n",\r\n__func__, status);\r\nreturn status;\r\n}\r\nstatic int garmin_clear(struct garmin_data *garmin_data_p)\r\n{\r\nunsigned long flags;\r\nint status = 0;\r\npkt_clear(garmin_data_p);\r\nspin_lock_irqsave(&garmin_data_p->lock, flags);\r\ngarmin_data_p->insize = 0;\r\ngarmin_data_p->outsize = 0;\r\nspin_unlock_irqrestore(&garmin_data_p->lock, flags);\r\nreturn status;\r\n}\r\nstatic int garmin_init_session(struct usb_serial_port *port)\r\n{\r\nstruct usb_serial *serial = port->serial;\r\nstruct garmin_data *garmin_data_p = usb_get_serial_port_data(port);\r\nint status = 0;\r\nint i = 0;\r\nif (status == 0) {\r\nusb_kill_urb(port->interrupt_in_urb);\r\ndev_dbg(&serial->dev->dev, "%s - adding interrupt input\n", __func__);\r\nstatus = usb_submit_urb(port->interrupt_in_urb, GFP_KERNEL);\r\nif (status)\r\ndev_err(&serial->dev->dev,\r\n"%s - failed submitting interrupt urb, error %d\n",\r\n__func__, status);\r\n}\r\nif (status == 0) {\r\ndev_dbg(&serial->dev->dev, "%s - starting session ...\n", __func__);\r\ngarmin_data_p->state = STATE_ACTIVE;\r\nfor (i = 0; i < 3; i++) {\r\nstatus = garmin_write_bulk(port,\r\nGARMIN_START_SESSION_REQ,\r\nsizeof(GARMIN_START_SESSION_REQ), 0);\r\nif (status < 0)\r\nbreak;\r\n}\r\nif (status > 0)\r\nstatus = 0;\r\n}\r\nreturn status;\r\n}\r\nstatic int garmin_open(struct tty_struct *tty, struct usb_serial_port *port)\r\n{\r\nunsigned long flags;\r\nint status = 0;\r\nstruct garmin_data *garmin_data_p = usb_get_serial_port_data(port);\r\nspin_lock_irqsave(&garmin_data_p->lock, flags);\r\ngarmin_data_p->mode = initial_mode;\r\ngarmin_data_p->count = 0;\r\ngarmin_data_p->flags &= FLAGS_SESSION_REPLY1_SEEN;\r\nspin_unlock_irqrestore(&garmin_data_p->lock, flags);\r\nusb_kill_urb(port->write_urb);\r\nusb_kill_urb(port->read_urb);\r\nif (garmin_data_p->state == STATE_RESET)\r\nstatus = garmin_init_session(port);\r\ngarmin_data_p->state = STATE_ACTIVE;\r\nreturn status;\r\n}\r\nstatic void garmin_close(struct usb_serial_port *port)\r\n{\r\nstruct garmin_data *garmin_data_p = usb_get_serial_port_data(port);\r\ndev_dbg(&port->dev, "%s - mode=%d state=%d flags=0x%X\n",\r\n__func__, garmin_data_p->mode, garmin_data_p->state,\r\ngarmin_data_p->flags);\r\ngarmin_clear(garmin_data_p);\r\nusb_kill_urb(port->read_urb);\r\nusb_kill_urb(port->write_urb);\r\nif (garmin_data_p->state != STATE_RESET)\r\ngarmin_data_p->state = STATE_DISCONNECTED;\r\n}\r\nstatic void garmin_write_bulk_callback(struct urb *urb)\r\n{\r\nstruct usb_serial_port *port = urb->context;\r\nif (port) {\r\nstruct garmin_data *garmin_data_p =\r\nusb_get_serial_port_data(port);\r\nif (GARMIN_LAYERID_APPL == getLayerId(urb->transfer_buffer)) {\r\nif (garmin_data_p->mode == MODE_GARMIN_SERIAL) {\r\ngsp_send_ack(garmin_data_p,\r\n((__u8 *)urb->transfer_buffer)[4]);\r\n}\r\n}\r\nusb_serial_port_softint(port);\r\n}\r\nkfree(urb->transfer_buffer);\r\n}\r\nstatic int garmin_write_bulk(struct usb_serial_port *port,\r\nconst unsigned char *buf, int count,\r\nint dismiss_ack)\r\n{\r\nunsigned long flags;\r\nstruct usb_serial *serial = port->serial;\r\nstruct garmin_data *garmin_data_p = usb_get_serial_port_data(port);\r\nstruct urb *urb;\r\nunsigned char *buffer;\r\nint status;\r\nspin_lock_irqsave(&garmin_data_p->lock, flags);\r\ngarmin_data_p->flags &= ~FLAGS_DROP_DATA;\r\nspin_unlock_irqrestore(&garmin_data_p->lock, flags);\r\nbuffer = kmalloc(count, GFP_ATOMIC);\r\nif (!buffer) {\r\ndev_err(&port->dev, "out of memory\n");\r\nreturn -ENOMEM;\r\n}\r\nurb = usb_alloc_urb(0, GFP_ATOMIC);\r\nif (!urb) {\r\ndev_err(&port->dev, "no more free urbs\n");\r\nkfree(buffer);\r\nreturn -ENOMEM;\r\n}\r\nmemcpy(buffer, buf, count);\r\nusb_serial_debug_data(&port->dev, __func__, count, buffer);\r\nusb_fill_bulk_urb(urb, serial->dev,\r\nusb_sndbulkpipe(serial->dev,\r\nport->bulk_out_endpointAddress),\r\nbuffer, count,\r\ngarmin_write_bulk_callback,\r\ndismiss_ack ? NULL : port);\r\nurb->transfer_flags |= URB_ZERO_PACKET;\r\nif (GARMIN_LAYERID_APPL == getLayerId(buffer)) {\r\nspin_lock_irqsave(&garmin_data_p->lock, flags);\r\ngarmin_data_p->flags |= APP_REQ_SEEN;\r\nspin_unlock_irqrestore(&garmin_data_p->lock, flags);\r\nif (garmin_data_p->mode == MODE_GARMIN_SERIAL) {\r\npkt_clear(garmin_data_p);\r\ngarmin_data_p->state = STATE_GSP_WAIT_DATA;\r\n}\r\n}\r\nstatus = usb_submit_urb(urb, GFP_ATOMIC);\r\nif (status) {\r\ndev_err(&port->dev,\r\n"%s - usb_submit_urb(write bulk) failed with status = %d\n",\r\n__func__, status);\r\ncount = status;\r\n}\r\nusb_free_urb(urb);\r\nreturn count;\r\n}\r\nstatic int garmin_write(struct tty_struct *tty, struct usb_serial_port *port,\r\nconst unsigned char *buf, int count)\r\n{\r\nstruct device *dev = &port->dev;\r\nint pktid, pktsiz, len;\r\nstruct garmin_data *garmin_data_p = usb_get_serial_port_data(port);\r\n__le32 *privpkt = (__le32 *)garmin_data_p->privpkt;\r\nusb_serial_debug_data(dev, __func__, count, buf);\r\nif (garmin_data_p->state == STATE_RESET)\r\nreturn -EIO;\r\nif (count >= GARMIN_PKTHDR_LENGTH) {\r\nlen = PRIVPKTSIZ;\r\nif (count < len)\r\nlen = count;\r\nmemcpy(garmin_data_p->privpkt, buf, len);\r\npktsiz = getDataLength(garmin_data_p->privpkt);\r\npktid = getPacketId(garmin_data_p->privpkt);\r\nif (count == (GARMIN_PKTHDR_LENGTH+pktsiz)\r\n&& GARMIN_LAYERID_PRIVATE ==\r\ngetLayerId(garmin_data_p->privpkt)) {\r\ndev_dbg(dev, "%s - processing private request %d\n",\r\n__func__, pktid);\r\ngarmin_clear(garmin_data_p);\r\nswitch (pktid) {\r\ncase PRIV_PKTID_SET_MODE:\r\nif (pktsiz != 4)\r\nreturn -EINVPKT;\r\ngarmin_data_p->mode = __le32_to_cpu(privpkt[3]);\r\ndev_dbg(dev, "%s - mode set to %d\n",\r\n__func__, garmin_data_p->mode);\r\nbreak;\r\ncase PRIV_PKTID_INFO_REQ:\r\npriv_status_resp(port);\r\nbreak;\r\ncase PRIV_PKTID_RESET_REQ:\r\nprocess_resetdev_request(port);\r\nbreak;\r\ncase PRIV_PKTID_SET_DEF_MODE:\r\nif (pktsiz != 4)\r\nreturn -EINVPKT;\r\ninitial_mode = __le32_to_cpu(privpkt[3]);\r\ndev_dbg(dev, "%s - initial_mode set to %d\n",\r\n__func__,\r\ngarmin_data_p->mode);\r\nbreak;\r\n}\r\nreturn count;\r\n}\r\n}\r\nif (garmin_data_p->mode == MODE_GARMIN_SERIAL) {\r\nreturn gsp_receive(garmin_data_p, buf, count);\r\n} else {\r\nreturn nat_receive(garmin_data_p, buf, count);\r\n}\r\n}\r\nstatic int garmin_write_room(struct tty_struct *tty)\r\n{\r\nstruct usb_serial_port *port = tty->driver_data;\r\nstruct garmin_data *garmin_data_p = usb_get_serial_port_data(port);\r\nreturn GPS_OUT_BUFSIZ-garmin_data_p->outsize;\r\n}\r\nstatic void garmin_read_process(struct garmin_data *garmin_data_p,\r\nunsigned char *data, unsigned data_length,\r\nint bulk_data)\r\n{\r\nunsigned long flags;\r\nif (garmin_data_p->flags & FLAGS_DROP_DATA) {\r\ndev_dbg(&garmin_data_p->port->dev, "%s - pkt dropped\n", __func__);\r\n} else if (garmin_data_p->state != STATE_DISCONNECTED &&\r\ngarmin_data_p->state != STATE_RESET) {\r\nif (garmin_data_p->flags & FLAGS_QUEUING) {\r\npkt_add(garmin_data_p, data, data_length);\r\n} else if (bulk_data ||\r\ngetLayerId(data) == GARMIN_LAYERID_APPL) {\r\nspin_lock_irqsave(&garmin_data_p->lock, flags);\r\ngarmin_data_p->flags |= APP_RESP_SEEN;\r\nspin_unlock_irqrestore(&garmin_data_p->lock, flags);\r\nif (garmin_data_p->mode == MODE_GARMIN_SERIAL) {\r\npkt_add(garmin_data_p, data, data_length);\r\n} else {\r\nsend_to_tty(garmin_data_p->port, data,\r\ndata_length);\r\n}\r\n}\r\n}\r\n}\r\nstatic void garmin_read_bulk_callback(struct urb *urb)\r\n{\r\nunsigned long flags;\r\nstruct usb_serial_port *port = urb->context;\r\nstruct garmin_data *garmin_data_p = usb_get_serial_port_data(port);\r\nunsigned char *data = urb->transfer_buffer;\r\nint status = urb->status;\r\nint retval;\r\nif (status) {\r\ndev_dbg(&urb->dev->dev, "%s - nonzero read bulk status received: %d\n",\r\n__func__, status);\r\nreturn;\r\n}\r\nusb_serial_debug_data(&port->dev, __func__, urb->actual_length, data);\r\ngarmin_read_process(garmin_data_p, data, urb->actual_length, 1);\r\nif (urb->actual_length == 0 &&\r\n0 != (garmin_data_p->flags & FLAGS_BULK_IN_RESTART)) {\r\nspin_lock_irqsave(&garmin_data_p->lock, flags);\r\ngarmin_data_p->flags &= ~FLAGS_BULK_IN_RESTART;\r\nspin_unlock_irqrestore(&garmin_data_p->lock, flags);\r\nretval = usb_submit_urb(port->read_urb, GFP_ATOMIC);\r\nif (retval)\r\ndev_err(&port->dev,\r\n"%s - failed resubmitting read urb, error %d\n",\r\n__func__, retval);\r\n} else if (urb->actual_length > 0) {\r\nif (0 == (garmin_data_p->flags & FLAGS_THROTTLED)) {\r\nretval = usb_submit_urb(port->read_urb, GFP_ATOMIC);\r\nif (retval)\r\ndev_err(&port->dev,\r\n"%s - failed resubmitting read urb, error %d\n",\r\n__func__, retval);\r\n}\r\n} else {\r\ndev_dbg(&port->dev, "%s - end of bulk data\n", __func__);\r\nspin_lock_irqsave(&garmin_data_p->lock, flags);\r\ngarmin_data_p->flags &= ~FLAGS_BULK_IN_ACTIVE;\r\nspin_unlock_irqrestore(&garmin_data_p->lock, flags);\r\n}\r\n}\r\nstatic void garmin_read_int_callback(struct urb *urb)\r\n{\r\nunsigned long flags;\r\nint retval;\r\nstruct usb_serial_port *port = urb->context;\r\nstruct garmin_data *garmin_data_p = usb_get_serial_port_data(port);\r\nunsigned char *data = urb->transfer_buffer;\r\nint status = urb->status;\r\nswitch (status) {\r\ncase 0:\r\nbreak;\r\ncase -ECONNRESET:\r\ncase -ENOENT:\r\ncase -ESHUTDOWN:\r\ndev_dbg(&urb->dev->dev, "%s - urb shutting down with status: %d\n",\r\n__func__, status);\r\nreturn;\r\ndefault:\r\ndev_dbg(&urb->dev->dev, "%s - nonzero urb status received: %d\n",\r\n__func__, status);\r\nreturn;\r\n}\r\nusb_serial_debug_data(&port->dev, __func__, urb->actual_length,\r\nurb->transfer_buffer);\r\nif (urb->actual_length == sizeof(GARMIN_BULK_IN_AVAIL_REPLY) &&\r\n0 == memcmp(data, GARMIN_BULK_IN_AVAIL_REPLY,\r\nsizeof(GARMIN_BULK_IN_AVAIL_REPLY))) {\r\ndev_dbg(&port->dev, "%s - bulk data available.\n", __func__);\r\nif (0 == (garmin_data_p->flags & FLAGS_BULK_IN_ACTIVE)) {\r\nretval = usb_submit_urb(port->read_urb, GFP_ATOMIC);\r\nif (retval) {\r\ndev_err(&port->dev,\r\n"%s - failed submitting read urb, error %d\n",\r\n__func__, retval);\r\n} else {\r\nspin_lock_irqsave(&garmin_data_p->lock, flags);\r\ngarmin_data_p->flags |= FLAGS_BULK_IN_ACTIVE;\r\nspin_unlock_irqrestore(&garmin_data_p->lock,\r\nflags);\r\n}\r\n} else {\r\nspin_lock_irqsave(&garmin_data_p->lock, flags);\r\ngarmin_data_p->flags |= FLAGS_BULK_IN_RESTART;\r\nspin_unlock_irqrestore(&garmin_data_p->lock, flags);\r\n}\r\n} else if (urb->actual_length == (4+sizeof(GARMIN_START_SESSION_REPLY))\r\n&& 0 == memcmp(data, GARMIN_START_SESSION_REPLY,\r\nsizeof(GARMIN_START_SESSION_REPLY))) {\r\nspin_lock_irqsave(&garmin_data_p->lock, flags);\r\ngarmin_data_p->flags |= FLAGS_SESSION_REPLY1_SEEN;\r\nspin_unlock_irqrestore(&garmin_data_p->lock, flags);\r\ngarmin_data_p->serial_num = __le32_to_cpup(\r\n(__le32 *)(data+GARMIN_PKTHDR_LENGTH));\r\ndev_dbg(&port->dev, "%s - start-of-session reply seen - serial %u.\n",\r\n__func__, garmin_data_p->serial_num);\r\n}\r\ngarmin_read_process(garmin_data_p, data, urb->actual_length, 0);\r\nretval = usb_submit_urb(urb, GFP_ATOMIC);\r\nif (retval)\r\ndev_err(&urb->dev->dev,\r\n"%s - Error %d submitting interrupt urb\n",\r\n__func__, retval);\r\n}\r\nstatic int garmin_flush_queue(struct garmin_data *garmin_data_p)\r\n{\r\nunsigned long flags;\r\nstruct garmin_packet *pkt;\r\nif ((garmin_data_p->flags & FLAGS_THROTTLED) == 0) {\r\npkt = pkt_pop(garmin_data_p);\r\nif (pkt != NULL) {\r\nsend_to_tty(garmin_data_p->port, pkt->data, pkt->size);\r\nkfree(pkt);\r\nmod_timer(&garmin_data_p->timer, (1)+jiffies);\r\n} else {\r\nspin_lock_irqsave(&garmin_data_p->lock, flags);\r\ngarmin_data_p->flags &= ~FLAGS_QUEUING;\r\nspin_unlock_irqrestore(&garmin_data_p->lock, flags);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void garmin_throttle(struct tty_struct *tty)\r\n{\r\nstruct usb_serial_port *port = tty->driver_data;\r\nstruct garmin_data *garmin_data_p = usb_get_serial_port_data(port);\r\nspin_lock_irq(&garmin_data_p->lock);\r\ngarmin_data_p->flags |= FLAGS_QUEUING|FLAGS_THROTTLED;\r\nspin_unlock_irq(&garmin_data_p->lock);\r\n}\r\nstatic void garmin_unthrottle(struct tty_struct *tty)\r\n{\r\nstruct usb_serial_port *port = tty->driver_data;\r\nstruct garmin_data *garmin_data_p = usb_get_serial_port_data(port);\r\nint status;\r\nspin_lock_irq(&garmin_data_p->lock);\r\ngarmin_data_p->flags &= ~FLAGS_THROTTLED;\r\nspin_unlock_irq(&garmin_data_p->lock);\r\nif (garmin_data_p->mode == MODE_NATIVE)\r\ngarmin_flush_queue(garmin_data_p);\r\nif (0 != (garmin_data_p->flags & FLAGS_BULK_IN_ACTIVE)) {\r\nstatus = usb_submit_urb(port->read_urb, GFP_KERNEL);\r\nif (status)\r\ndev_err(&port->dev,\r\n"%s - failed resubmitting read urb, error %d\n",\r\n__func__, status);\r\n}\r\n}\r\nstatic void timeout_handler(unsigned long data)\r\n{\r\nstruct garmin_data *garmin_data_p = (struct garmin_data *) data;\r\nif (garmin_data_p->mode == MODE_NATIVE)\r\nif (garmin_data_p->flags & FLAGS_QUEUING)\r\ngarmin_flush_queue(garmin_data_p);\r\n}\r\nstatic int garmin_port_probe(struct usb_serial_port *port)\r\n{\r\nint status;\r\nstruct garmin_data *garmin_data_p;\r\ngarmin_data_p = kzalloc(sizeof(struct garmin_data), GFP_KERNEL);\r\nif (garmin_data_p == NULL) {\r\ndev_err(&port->dev, "%s - Out of memory\n", __func__);\r\nreturn -ENOMEM;\r\n}\r\ninit_timer(&garmin_data_p->timer);\r\nspin_lock_init(&garmin_data_p->lock);\r\nINIT_LIST_HEAD(&garmin_data_p->pktlist);\r\ngarmin_data_p->timer.data = (unsigned long)garmin_data_p;\r\ngarmin_data_p->timer.function = timeout_handler;\r\ngarmin_data_p->port = port;\r\ngarmin_data_p->state = 0;\r\ngarmin_data_p->flags = 0;\r\ngarmin_data_p->count = 0;\r\nusb_set_serial_port_data(port, garmin_data_p);\r\nstatus = garmin_init_session(port);\r\nreturn status;\r\n}\r\nstatic int garmin_port_remove(struct usb_serial_port *port)\r\n{\r\nstruct garmin_data *garmin_data_p = usb_get_serial_port_data(port);\r\nusb_kill_urb(port->interrupt_in_urb);\r\ndel_timer_sync(&garmin_data_p->timer);\r\nkfree(garmin_data_p);\r\nreturn 0;\r\n}

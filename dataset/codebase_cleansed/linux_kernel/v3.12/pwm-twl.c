static inline struct twl_pwm_chip *to_twl(struct pwm_chip *chip)\r\n{\r\nreturn container_of(chip, struct twl_pwm_chip, chip);\r\n}\r\nstatic int twl_pwm_config(struct pwm_chip *chip, struct pwm_device *pwm,\r\nint duty_ns, int period_ns)\r\n{\r\nint duty_cycle = DIV_ROUND_UP(duty_ns * TWL_PWM_MAX, period_ns) + 1;\r\nu8 pwm_config[2] = { 1, 0 };\r\nint base, ret;\r\nif (duty_cycle == 1)\r\nduty_cycle = 2;\r\nelse if (duty_cycle > TWL_PWM_MAX)\r\nduty_cycle = 1;\r\nbase = pwm->hwpwm * 3;\r\npwm_config[1] = duty_cycle;\r\nret = twl_i2c_write(TWL_MODULE_PWM, pwm_config, base, 2);\r\nif (ret < 0)\r\ndev_err(chip->dev, "%s: Failed to configure PWM\n", pwm->label);\r\nreturn ret;\r\n}\r\nstatic int twl4030_pwm_enable(struct pwm_chip *chip, struct pwm_device *pwm)\r\n{\r\nstruct twl_pwm_chip *twl = to_twl(chip);\r\nint ret;\r\nu8 val;\r\nmutex_lock(&twl->mutex);\r\nret = twl_i2c_read_u8(TWL4030_MODULE_INTBR, &val, TWL4030_GPBR1_REG);\r\nif (ret < 0) {\r\ndev_err(chip->dev, "%s: Failed to read GPBR1\n", pwm->label);\r\ngoto out;\r\n}\r\nval |= TWL4030_PWM_TOGGLE(pwm->hwpwm, TWL4030_PWMXCLK_ENABLE);\r\nret = twl_i2c_write_u8(TWL4030_MODULE_INTBR, val, TWL4030_GPBR1_REG);\r\nif (ret < 0)\r\ndev_err(chip->dev, "%s: Failed to enable PWM\n", pwm->label);\r\nval |= TWL4030_PWM_TOGGLE(pwm->hwpwm, TWL4030_PWMX_ENABLE);\r\nret = twl_i2c_write_u8(TWL4030_MODULE_INTBR, val, TWL4030_GPBR1_REG);\r\nif (ret < 0)\r\ndev_err(chip->dev, "%s: Failed to enable PWM\n", pwm->label);\r\nout:\r\nmutex_unlock(&twl->mutex);\r\nreturn ret;\r\n}\r\nstatic void twl4030_pwm_disable(struct pwm_chip *chip, struct pwm_device *pwm)\r\n{\r\nstruct twl_pwm_chip *twl = to_twl(chip);\r\nint ret;\r\nu8 val;\r\nmutex_lock(&twl->mutex);\r\nret = twl_i2c_read_u8(TWL4030_MODULE_INTBR, &val, TWL4030_GPBR1_REG);\r\nif (ret < 0) {\r\ndev_err(chip->dev, "%s: Failed to read GPBR1\n", pwm->label);\r\ngoto out;\r\n}\r\nval &= ~TWL4030_PWM_TOGGLE(pwm->hwpwm, TWL4030_PWMX_ENABLE);\r\nret = twl_i2c_write_u8(TWL4030_MODULE_INTBR, val, TWL4030_GPBR1_REG);\r\nif (ret < 0)\r\ndev_err(chip->dev, "%s: Failed to disable PWM\n", pwm->label);\r\nval &= ~TWL4030_PWM_TOGGLE(pwm->hwpwm, TWL4030_PWMXCLK_ENABLE);\r\nret = twl_i2c_write_u8(TWL4030_MODULE_INTBR, val, TWL4030_GPBR1_REG);\r\nif (ret < 0)\r\ndev_err(chip->dev, "%s: Failed to disable PWM\n", pwm->label);\r\nout:\r\nmutex_unlock(&twl->mutex);\r\n}\r\nstatic int twl4030_pwm_request(struct pwm_chip *chip, struct pwm_device *pwm)\r\n{\r\nstruct twl_pwm_chip *twl = to_twl(chip);\r\nint ret;\r\nu8 val, mask, bits;\r\nif (pwm->hwpwm == 1) {\r\nmask = TWL4030_GPIO7_VIBRASYNC_PWM1_MASK;\r\nbits = TWL4030_GPIO7_VIBRASYNC_PWM1_PWM1;\r\n} else {\r\nmask = TWL4030_GPIO6_PWM0_MUTE_MASK;\r\nbits = TWL4030_GPIO6_PWM0_MUTE_PWM0;\r\n}\r\nmutex_lock(&twl->mutex);\r\nret = twl_i2c_read_u8(TWL4030_MODULE_INTBR, &val, TWL4030_PMBR1_REG);\r\nif (ret < 0) {\r\ndev_err(chip->dev, "%s: Failed to read PMBR1\n", pwm->label);\r\ngoto out;\r\n}\r\ntwl->twl4030_pwm_mux &= ~mask;\r\ntwl->twl4030_pwm_mux |= (val & mask);\r\nval &= ~mask;\r\nval |= bits;\r\nret = twl_i2c_write_u8(TWL4030_MODULE_INTBR, val, TWL4030_PMBR1_REG);\r\nif (ret < 0)\r\ndev_err(chip->dev, "%s: Failed to request PWM\n", pwm->label);\r\nout:\r\nmutex_unlock(&twl->mutex);\r\nreturn ret;\r\n}\r\nstatic void twl4030_pwm_free(struct pwm_chip *chip, struct pwm_device *pwm)\r\n{\r\nstruct twl_pwm_chip *twl = to_twl(chip);\r\nint ret;\r\nu8 val, mask;\r\nif (pwm->hwpwm == 1)\r\nmask = TWL4030_GPIO7_VIBRASYNC_PWM1_MASK;\r\nelse\r\nmask = TWL4030_GPIO6_PWM0_MUTE_MASK;\r\nmutex_lock(&twl->mutex);\r\nret = twl_i2c_read_u8(TWL4030_MODULE_INTBR, &val, TWL4030_PMBR1_REG);\r\nif (ret < 0) {\r\ndev_err(chip->dev, "%s: Failed to read PMBR1\n", pwm->label);\r\ngoto out;\r\n}\r\nval &= ~mask;\r\nval |= (twl->twl4030_pwm_mux & mask);\r\nret = twl_i2c_write_u8(TWL4030_MODULE_INTBR, val, TWL4030_PMBR1_REG);\r\nif (ret < 0)\r\ndev_err(chip->dev, "%s: Failed to free PWM\n", pwm->label);\r\nout:\r\nmutex_unlock(&twl->mutex);\r\n}\r\nstatic int twl6030_pwm_enable(struct pwm_chip *chip, struct pwm_device *pwm)\r\n{\r\nstruct twl_pwm_chip *twl = to_twl(chip);\r\nint ret;\r\nu8 val;\r\nmutex_lock(&twl->mutex);\r\nval = twl->twl6030_toggle3;\r\nval |= TWL6030_PWM_TOGGLE(pwm->hwpwm, TWL6030_PWMXS | TWL6030_PWMXEN);\r\nval &= ~TWL6030_PWM_TOGGLE(pwm->hwpwm, TWL6030_PWMXR);\r\nret = twl_i2c_write_u8(TWL6030_MODULE_ID1, val, TWL6030_TOGGLE3_REG);\r\nif (ret < 0) {\r\ndev_err(chip->dev, "%s: Failed to enable PWM\n", pwm->label);\r\ngoto out;\r\n}\r\ntwl->twl6030_toggle3 = val;\r\nout:\r\nmutex_unlock(&twl->mutex);\r\nreturn ret;\r\n}\r\nstatic void twl6030_pwm_disable(struct pwm_chip *chip, struct pwm_device *pwm)\r\n{\r\nstruct twl_pwm_chip *twl = to_twl(chip);\r\nint ret;\r\nu8 val;\r\nmutex_lock(&twl->mutex);\r\nval = twl->twl6030_toggle3;\r\nval |= TWL6030_PWM_TOGGLE(pwm->hwpwm, TWL6030_PWMXR);\r\nval &= ~TWL6030_PWM_TOGGLE(pwm->hwpwm, TWL6030_PWMXS | TWL6030_PWMXEN);\r\nret = twl_i2c_write_u8(TWL6030_MODULE_ID1, val, TWL6030_TOGGLE3_REG);\r\nif (ret < 0) {\r\ndev_err(chip->dev, "%s: Failed to read TOGGLE3\n", pwm->label);\r\ngoto out;\r\n}\r\nval |= TWL6030_PWM_TOGGLE(pwm->hwpwm, TWL6030_PWMXS | TWL6030_PWMXEN);\r\nret = twl_i2c_write_u8(TWL6030_MODULE_ID1, val, TWL6030_TOGGLE3_REG);\r\nif (ret < 0) {\r\ndev_err(chip->dev, "%s: Failed to disable PWM\n", pwm->label);\r\ngoto out;\r\n}\r\ntwl->twl6030_toggle3 = val;\r\nout:\r\nmutex_unlock(&twl->mutex);\r\n}\r\nstatic int twl_pwm_probe(struct platform_device *pdev)\r\n{\r\nstruct twl_pwm_chip *twl;\r\nint ret;\r\ntwl = devm_kzalloc(&pdev->dev, sizeof(*twl), GFP_KERNEL);\r\nif (!twl)\r\nreturn -ENOMEM;\r\nif (twl_class_is_4030())\r\ntwl->chip.ops = &twl4030_pwm_ops;\r\nelse\r\ntwl->chip.ops = &twl6030_pwm_ops;\r\ntwl->chip.dev = &pdev->dev;\r\ntwl->chip.base = -1;\r\ntwl->chip.npwm = 2;\r\ntwl->chip.can_sleep = true;\r\nmutex_init(&twl->mutex);\r\nret = pwmchip_add(&twl->chip);\r\nif (ret < 0)\r\nreturn ret;\r\nplatform_set_drvdata(pdev, twl);\r\nreturn 0;\r\n}\r\nstatic int twl_pwm_remove(struct platform_device *pdev)\r\n{\r\nstruct twl_pwm_chip *twl = platform_get_drvdata(pdev);\r\nreturn pwmchip_remove(&twl->chip);\r\n}

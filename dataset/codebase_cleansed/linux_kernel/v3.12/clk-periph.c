static u8 clk_periph_get_parent(struct clk_hw *hw)\r\n{\r\nstruct tegra_clk_periph *periph = to_clk_periph(hw);\r\nconst struct clk_ops *mux_ops = periph->mux_ops;\r\nstruct clk_hw *mux_hw = &periph->mux.hw;\r\nmux_hw->clk = hw->clk;\r\nreturn mux_ops->get_parent(mux_hw);\r\n}\r\nstatic int clk_periph_set_parent(struct clk_hw *hw, u8 index)\r\n{\r\nstruct tegra_clk_periph *periph = to_clk_periph(hw);\r\nconst struct clk_ops *mux_ops = periph->mux_ops;\r\nstruct clk_hw *mux_hw = &periph->mux.hw;\r\nmux_hw->clk = hw->clk;\r\nreturn mux_ops->set_parent(mux_hw, index);\r\n}\r\nstatic unsigned long clk_periph_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct tegra_clk_periph *periph = to_clk_periph(hw);\r\nconst struct clk_ops *div_ops = periph->div_ops;\r\nstruct clk_hw *div_hw = &periph->divider.hw;\r\ndiv_hw->clk = hw->clk;\r\nreturn div_ops->recalc_rate(div_hw, parent_rate);\r\n}\r\nstatic long clk_periph_round_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long *prate)\r\n{\r\nstruct tegra_clk_periph *periph = to_clk_periph(hw);\r\nconst struct clk_ops *div_ops = periph->div_ops;\r\nstruct clk_hw *div_hw = &periph->divider.hw;\r\ndiv_hw->clk = hw->clk;\r\nreturn div_ops->round_rate(div_hw, rate, prate);\r\n}\r\nstatic int clk_periph_set_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nstruct tegra_clk_periph *periph = to_clk_periph(hw);\r\nconst struct clk_ops *div_ops = periph->div_ops;\r\nstruct clk_hw *div_hw = &periph->divider.hw;\r\ndiv_hw->clk = hw->clk;\r\nreturn div_ops->set_rate(div_hw, rate, parent_rate);\r\n}\r\nstatic int clk_periph_is_enabled(struct clk_hw *hw)\r\n{\r\nstruct tegra_clk_periph *periph = to_clk_periph(hw);\r\nconst struct clk_ops *gate_ops = periph->gate_ops;\r\nstruct clk_hw *gate_hw = &periph->gate.hw;\r\ngate_hw->clk = hw->clk;\r\nreturn gate_ops->is_enabled(gate_hw);\r\n}\r\nstatic int clk_periph_enable(struct clk_hw *hw)\r\n{\r\nstruct tegra_clk_periph *periph = to_clk_periph(hw);\r\nconst struct clk_ops *gate_ops = periph->gate_ops;\r\nstruct clk_hw *gate_hw = &periph->gate.hw;\r\ngate_hw->clk = hw->clk;\r\nreturn gate_ops->enable(gate_hw);\r\n}\r\nstatic void clk_periph_disable(struct clk_hw *hw)\r\n{\r\nstruct tegra_clk_periph *periph = to_clk_periph(hw);\r\nconst struct clk_ops *gate_ops = periph->gate_ops;\r\nstruct clk_hw *gate_hw = &periph->gate.hw;\r\ngate_ops->disable(gate_hw);\r\n}\r\nvoid tegra_periph_reset_deassert(struct clk *c)\r\n{\r\nstruct clk_hw *hw = __clk_get_hw(c);\r\nstruct tegra_clk_periph *periph = to_clk_periph(hw);\r\nstruct tegra_clk_periph_gate *gate;\r\nif (periph->magic != TEGRA_CLK_PERIPH_MAGIC) {\r\ngate = to_clk_periph_gate(hw);\r\nif (gate->magic != TEGRA_CLK_PERIPH_GATE_MAGIC) {\r\nWARN_ON(1);\r\nreturn;\r\n}\r\n} else {\r\ngate = &periph->gate;\r\n}\r\ntegra_periph_reset(gate, 0);\r\n}\r\nvoid tegra_periph_reset_assert(struct clk *c)\r\n{\r\nstruct clk_hw *hw = __clk_get_hw(c);\r\nstruct tegra_clk_periph *periph = to_clk_periph(hw);\r\nstruct tegra_clk_periph_gate *gate;\r\nif (periph->magic != TEGRA_CLK_PERIPH_MAGIC) {\r\ngate = to_clk_periph_gate(hw);\r\nif (gate->magic != TEGRA_CLK_PERIPH_GATE_MAGIC) {\r\nWARN_ON(1);\r\nreturn;\r\n}\r\n} else {\r\ngate = &periph->gate;\r\n}\r\ntegra_periph_reset(gate, 1);\r\n}\r\nstatic struct clk *_tegra_clk_register_periph(const char *name,\r\nconst char **parent_names, int num_parents,\r\nstruct tegra_clk_periph *periph,\r\nvoid __iomem *clk_base, u32 offset, bool div,\r\nunsigned long flags)\r\n{\r\nstruct clk *clk;\r\nstruct clk_init_data init;\r\ninit.name = name;\r\ninit.ops = div ? &tegra_clk_periph_ops : &tegra_clk_periph_nodiv_ops;\r\ninit.flags = flags;\r\ninit.parent_names = parent_names;\r\ninit.num_parents = num_parents;\r\nperiph->hw.init = &init;\r\nperiph->magic = TEGRA_CLK_PERIPH_MAGIC;\r\nperiph->mux.reg = clk_base + offset;\r\nperiph->divider.reg = div ? (clk_base + offset) : NULL;\r\nperiph->gate.clk_base = clk_base;\r\nclk = clk_register(NULL, &periph->hw);\r\nif (IS_ERR(clk))\r\nreturn clk;\r\nperiph->mux.hw.clk = clk;\r\nperiph->divider.hw.clk = div ? clk : NULL;\r\nperiph->gate.hw.clk = clk;\r\nreturn clk;\r\n}\r\nstruct clk *tegra_clk_register_periph(const char *name,\r\nconst char **parent_names, int num_parents,\r\nstruct tegra_clk_periph *periph, void __iomem *clk_base,\r\nu32 offset, unsigned long flags)\r\n{\r\nreturn _tegra_clk_register_periph(name, parent_names, num_parents,\r\nperiph, clk_base, offset, true, flags);\r\n}\r\nstruct clk *tegra_clk_register_periph_nodiv(const char *name,\r\nconst char **parent_names, int num_parents,\r\nstruct tegra_clk_periph *periph, void __iomem *clk_base,\r\nu32 offset)\r\n{\r\nreturn _tegra_clk_register_periph(name, parent_names, num_parents,\r\nperiph, clk_base, offset, false, CLK_SET_RATE_PARENT);\r\n}

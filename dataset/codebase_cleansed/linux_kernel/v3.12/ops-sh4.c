static int sh4_pci_read(struct pci_bus *bus, unsigned int devfn,\r\nint where, int size, u32 *val)\r\n{\r\nstruct pci_channel *chan = bus->sysdata;\r\nunsigned long flags;\r\nu32 data;\r\nraw_spin_lock_irqsave(&pci_config_lock, flags);\r\npci_write_reg(chan, CONFIG_CMD(bus, devfn, where), SH4_PCIPAR);\r\ndata = pci_read_reg(chan, SH4_PCIPDR);\r\nraw_spin_unlock_irqrestore(&pci_config_lock, flags);\r\nswitch (size) {\r\ncase 1:\r\n*val = (data >> ((where & 3) << 3)) & 0xff;\r\nbreak;\r\ncase 2:\r\n*val = (data >> ((where & 2) << 3)) & 0xffff;\r\nbreak;\r\ncase 4:\r\n*val = data;\r\nbreak;\r\ndefault:\r\nreturn PCIBIOS_FUNC_NOT_SUPPORTED;\r\n}\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int sh4_pci_write(struct pci_bus *bus, unsigned int devfn,\r\nint where, int size, u32 val)\r\n{\r\nstruct pci_channel *chan = bus->sysdata;\r\nunsigned long flags;\r\nint shift;\r\nu32 data;\r\nraw_spin_lock_irqsave(&pci_config_lock, flags);\r\npci_write_reg(chan, CONFIG_CMD(bus, devfn, where), SH4_PCIPAR);\r\ndata = pci_read_reg(chan, SH4_PCIPDR);\r\nraw_spin_unlock_irqrestore(&pci_config_lock, flags);\r\nswitch (size) {\r\ncase 1:\r\nshift = (where & 3) << 3;\r\ndata &= ~(0xff << shift);\r\ndata |= ((val & 0xff) << shift);\r\nbreak;\r\ncase 2:\r\nshift = (where & 2) << 3;\r\ndata &= ~(0xffff << shift);\r\ndata |= ((val & 0xffff) << shift);\r\nbreak;\r\ncase 4:\r\ndata = val;\r\nbreak;\r\ndefault:\r\nreturn PCIBIOS_FUNC_NOT_SUPPORTED;\r\n}\r\npci_write_reg(chan, data, SH4_PCIPDR);\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}

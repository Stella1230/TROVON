static void ltc4245_update_gpios(struct device *dev)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct ltc4245_data *data = i2c_get_clientdata(client);\r\nu8 gpio_curr, gpio_next, gpio_reg;\r\nint i;\r\nif (!data->use_extra_gpios) {\r\ndata->gpios[0] = data->vregs[LTC4245_GPIOADC - 0x10];\r\nreturn;\r\n}\r\nif (time_after(jiffies, data->last_updated + 5 * HZ)) {\r\ndev_dbg(&client->dev, "Marking GPIOs invalid\n");\r\nfor (i = 0; i < ARRAY_SIZE(data->gpios); i++)\r\ndata->gpios[i] = -EAGAIN;\r\n}\r\ngpio_curr = (data->cregs[LTC4245_GPIO] & 0xc0) >> 6;\r\nif (gpio_curr > 0)\r\ngpio_curr -= 1;\r\ndata->gpios[gpio_curr] = data->vregs[LTC4245_GPIOADC - 0x10];\r\ngpio_next = (gpio_curr + 1) % ARRAY_SIZE(data->gpios);\r\ngpio_reg = (data->cregs[LTC4245_GPIO] & 0x3f) | ((gpio_next + 1) << 6);\r\ni2c_smbus_write_byte_data(client, LTC4245_GPIO, gpio_reg);\r\ndata->cregs[LTC4245_GPIO] = gpio_reg;\r\n}\r\nstatic struct ltc4245_data *ltc4245_update_device(struct device *dev)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct ltc4245_data *data = i2c_get_clientdata(client);\r\ns32 val;\r\nint i;\r\nmutex_lock(&data->update_lock);\r\nif (time_after(jiffies, data->last_updated + HZ) || !data->valid) {\r\ndev_dbg(&client->dev, "Starting ltc4245 update\n");\r\nfor (i = 0; i < ARRAY_SIZE(data->cregs); i++) {\r\nval = i2c_smbus_read_byte_data(client, i);\r\nif (unlikely(val < 0))\r\ndata->cregs[i] = 0;\r\nelse\r\ndata->cregs[i] = val;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(data->vregs); i++) {\r\nval = i2c_smbus_read_byte_data(client, i+0x10);\r\nif (unlikely(val < 0))\r\ndata->vregs[i] = 0;\r\nelse\r\ndata->vregs[i] = val;\r\n}\r\nltc4245_update_gpios(dev);\r\ndata->last_updated = jiffies;\r\ndata->valid = 1;\r\n}\r\nmutex_unlock(&data->update_lock);\r\nreturn data;\r\n}\r\nstatic int ltc4245_get_voltage(struct device *dev, u8 reg)\r\n{\r\nstruct ltc4245_data *data = ltc4245_update_device(dev);\r\nconst u8 regval = data->vregs[reg - 0x10];\r\nu32 voltage = 0;\r\nswitch (reg) {\r\ncase LTC4245_12VIN:\r\ncase LTC4245_12VOUT:\r\nvoltage = regval * 55;\r\nbreak;\r\ncase LTC4245_5VIN:\r\ncase LTC4245_5VOUT:\r\nvoltage = regval * 22;\r\nbreak;\r\ncase LTC4245_3VIN:\r\ncase LTC4245_3VOUT:\r\nvoltage = regval * 15;\r\nbreak;\r\ncase LTC4245_VEEIN:\r\ncase LTC4245_VEEOUT:\r\nvoltage = regval * -55;\r\nbreak;\r\ncase LTC4245_GPIOADC:\r\nvoltage = regval * 10;\r\nbreak;\r\ndefault:\r\nWARN_ON_ONCE(1);\r\nbreak;\r\n}\r\nreturn voltage;\r\n}\r\nstatic unsigned int ltc4245_get_current(struct device *dev, u8 reg)\r\n{\r\nstruct ltc4245_data *data = ltc4245_update_device(dev);\r\nconst u8 regval = data->vregs[reg - 0x10];\r\nunsigned int voltage;\r\nunsigned int curr;\r\nswitch (reg) {\r\ncase LTC4245_12VSENSE:\r\nvoltage = regval * 250;\r\ncurr = voltage / 50;\r\nbreak;\r\ncase LTC4245_5VSENSE:\r\nvoltage = regval * 125;\r\ncurr = (voltage * 10) / 35;\r\nbreak;\r\ncase LTC4245_3VSENSE:\r\nvoltage = regval * 125;\r\ncurr = (voltage * 10) / 25;\r\nbreak;\r\ncase LTC4245_VEESENSE:\r\nvoltage = regval * 250;\r\ncurr = voltage / 100;\r\nbreak;\r\ndefault:\r\nWARN_ON_ONCE(1);\r\ncurr = 0;\r\nbreak;\r\n}\r\nreturn curr;\r\n}\r\nstatic ssize_t ltc4245_show_voltage(struct device *dev,\r\nstruct device_attribute *da,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(da);\r\nconst int voltage = ltc4245_get_voltage(dev, attr->index);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", voltage);\r\n}\r\nstatic ssize_t ltc4245_show_current(struct device *dev,\r\nstruct device_attribute *da,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(da);\r\nconst unsigned int curr = ltc4245_get_current(dev, attr->index);\r\nreturn snprintf(buf, PAGE_SIZE, "%u\n", curr);\r\n}\r\nstatic ssize_t ltc4245_show_power(struct device *dev,\r\nstruct device_attribute *da,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(da);\r\nconst unsigned int curr = ltc4245_get_current(dev, attr->index);\r\nconst int output_voltage = ltc4245_get_voltage(dev, attr->index+1);\r\nconst unsigned int power = abs(output_voltage * curr);\r\nreturn snprintf(buf, PAGE_SIZE, "%u\n", power);\r\n}\r\nstatic ssize_t ltc4245_show_alarm(struct device *dev,\r\nstruct device_attribute *da,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute_2 *attr = to_sensor_dev_attr_2(da);\r\nstruct ltc4245_data *data = ltc4245_update_device(dev);\r\nconst u8 reg = data->cregs[attr->index];\r\nconst u32 mask = attr->nr;\r\nreturn snprintf(buf, PAGE_SIZE, "%u\n", (reg & mask) ? 1 : 0);\r\n}\r\nstatic ssize_t ltc4245_show_gpio(struct device *dev,\r\nstruct device_attribute *da,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(da);\r\nstruct ltc4245_data *data = ltc4245_update_device(dev);\r\nint val = data->gpios[attr->index];\r\nif (val < 0)\r\nreturn val;\r\nreturn snprintf(buf, PAGE_SIZE, "%u\n", val * 10);\r\n}\r\nstatic int ltc4245_sysfs_create_groups(struct i2c_client *client)\r\n{\r\nstruct ltc4245_data *data = i2c_get_clientdata(client);\r\nstruct device *dev = &client->dev;\r\nint ret;\r\nret = sysfs_create_group(&dev->kobj, &ltc4245_std_group);\r\nif (ret) {\r\ndev_err(dev, "unable to register standard attributes\n");\r\nreturn ret;\r\n}\r\nif (data->use_extra_gpios) {\r\nret = sysfs_create_group(&dev->kobj, &ltc4245_gpio_group);\r\nif (ret) {\r\ndev_err(dev, "unable to register gpio attributes\n");\r\nsysfs_remove_group(&dev->kobj, &ltc4245_std_group);\r\nreturn ret;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void ltc4245_sysfs_remove_groups(struct i2c_client *client)\r\n{\r\nstruct ltc4245_data *data = i2c_get_clientdata(client);\r\nstruct device *dev = &client->dev;\r\nif (data->use_extra_gpios)\r\nsysfs_remove_group(&dev->kobj, &ltc4245_gpio_group);\r\nsysfs_remove_group(&dev->kobj, &ltc4245_std_group);\r\n}\r\nstatic bool ltc4245_use_extra_gpios(struct i2c_client *client)\r\n{\r\nstruct ltc4245_platform_data *pdata = dev_get_platdata(&client->dev);\r\n#ifdef CONFIG_OF\r\nstruct device_node *np = client->dev.of_node;\r\n#endif\r\nif (pdata)\r\nreturn pdata->use_extra_gpios;\r\n#ifdef CONFIG_OF\r\nif (of_find_property(np, "ltc4245,use-extra-gpios", NULL))\r\nreturn true;\r\n#endif\r\nreturn false;\r\n}\r\nstatic int ltc4245_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct i2c_adapter *adapter = client->adapter;\r\nstruct ltc4245_data *data;\r\nint ret;\r\nif (!i2c_check_functionality(adapter, I2C_FUNC_SMBUS_BYTE_DATA))\r\nreturn -ENODEV;\r\ndata = devm_kzalloc(&client->dev, sizeof(*data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(client, data);\r\nmutex_init(&data->update_lock);\r\ndata->use_extra_gpios = ltc4245_use_extra_gpios(client);\r\ni2c_smbus_write_byte_data(client, LTC4245_FAULT1, 0x00);\r\ni2c_smbus_write_byte_data(client, LTC4245_FAULT2, 0x00);\r\nret = ltc4245_sysfs_create_groups(client);\r\nif (ret)\r\nreturn ret;\r\ndata->hwmon_dev = hwmon_device_register(&client->dev);\r\nif (IS_ERR(data->hwmon_dev)) {\r\nret = PTR_ERR(data->hwmon_dev);\r\ngoto out_hwmon_device_register;\r\n}\r\nreturn 0;\r\nout_hwmon_device_register:\r\nltc4245_sysfs_remove_groups(client);\r\nreturn ret;\r\n}\r\nstatic int ltc4245_remove(struct i2c_client *client)\r\n{\r\nstruct ltc4245_data *data = i2c_get_clientdata(client);\r\nhwmon_device_unregister(data->hwmon_dev);\r\nltc4245_sysfs_remove_groups(client);\r\nreturn 0;\r\n}

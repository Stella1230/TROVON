static u32 *decode_read_list(u32 *va, u32 *vaend)\r\n{\r\nstruct rpcrdma_read_chunk *ch = (struct rpcrdma_read_chunk *)va;\r\nwhile (ch->rc_discrim != xdr_zero) {\r\nif (((unsigned long)ch + sizeof(struct rpcrdma_read_chunk)) >\r\n(unsigned long)vaend) {\r\ndprintk("svcrdma: vaend=%p, ch=%p\n", vaend, ch);\r\nreturn NULL;\r\n}\r\nch++;\r\n}\r\nreturn (u32 *)&ch->rc_position;\r\n}\r\nvoid svc_rdma_rcl_chunk_counts(struct rpcrdma_read_chunk *ch,\r\nint *ch_count, int *byte_count)\r\n{\r\n*byte_count = 0;\r\n*ch_count = 0;\r\nfor (; ch->rc_discrim != 0; ch++) {\r\n*byte_count = *byte_count + ntohl(ch->rc_target.rs_length);\r\n*ch_count = *ch_count + 1;\r\n}\r\n}\r\nstatic u32 *decode_write_list(u32 *va, u32 *vaend)\r\n{\r\nunsigned long start, end;\r\nint nchunks;\r\nstruct rpcrdma_write_array *ary =\r\n(struct rpcrdma_write_array *)va;\r\nif (ary->wc_discrim == xdr_zero)\r\nreturn (u32 *)&ary->wc_nchunks;\r\nif ((unsigned long)ary + sizeof(struct rpcrdma_write_array) >\r\n(unsigned long)vaend) {\r\ndprintk("svcrdma: ary=%p, vaend=%p\n", ary, vaend);\r\nreturn NULL;\r\n}\r\nnchunks = ntohl(ary->wc_nchunks);\r\nstart = (unsigned long)&ary->wc_array[0];\r\nend = (unsigned long)vaend;\r\nif (nchunks < 0 ||\r\nnchunks > (SIZE_MAX - start) / sizeof(struct rpcrdma_write_chunk) ||\r\n(start + (sizeof(struct rpcrdma_write_chunk) * nchunks)) > end) {\r\ndprintk("svcrdma: ary=%p, wc_nchunks=%d, vaend=%p\n",\r\nary, nchunks, vaend);\r\nreturn NULL;\r\n}\r\nreturn (u32 *)&ary->wc_array[nchunks].wc_target.rs_length;\r\n}\r\nstatic u32 *decode_reply_array(u32 *va, u32 *vaend)\r\n{\r\nunsigned long start, end;\r\nint nchunks;\r\nstruct rpcrdma_write_array *ary =\r\n(struct rpcrdma_write_array *)va;\r\nif (ary->wc_discrim == xdr_zero)\r\nreturn (u32 *)&ary->wc_nchunks;\r\nif ((unsigned long)ary + sizeof(struct rpcrdma_write_array) >\r\n(unsigned long)vaend) {\r\ndprintk("svcrdma: ary=%p, vaend=%p\n", ary, vaend);\r\nreturn NULL;\r\n}\r\nnchunks = ntohl(ary->wc_nchunks);\r\nstart = (unsigned long)&ary->wc_array[0];\r\nend = (unsigned long)vaend;\r\nif (nchunks < 0 ||\r\nnchunks > (SIZE_MAX - start) / sizeof(struct rpcrdma_write_chunk) ||\r\n(start + (sizeof(struct rpcrdma_write_chunk) * nchunks)) > end) {\r\ndprintk("svcrdma: ary=%p, wc_nchunks=%d, vaend=%p\n",\r\nary, nchunks, vaend);\r\nreturn NULL;\r\n}\r\nreturn (u32 *)&ary->wc_array[nchunks];\r\n}\r\nint svc_rdma_xdr_decode_req(struct rpcrdma_msg **rdma_req,\r\nstruct svc_rqst *rqstp)\r\n{\r\nstruct rpcrdma_msg *rmsgp = NULL;\r\nu32 *va;\r\nu32 *vaend;\r\nu32 hdr_len;\r\nrmsgp = (struct rpcrdma_msg *)rqstp->rq_arg.head[0].iov_base;\r\nif (rqstp->rq_arg.len <= RPCRDMA_HDRLEN_MIN) {\r\ndprintk("svcrdma: header too short = %d\n",\r\nrqstp->rq_arg.len);\r\nreturn -EINVAL;\r\n}\r\nrmsgp->rm_xid = ntohl(rmsgp->rm_xid);\r\nrmsgp->rm_vers = ntohl(rmsgp->rm_vers);\r\nrmsgp->rm_credit = ntohl(rmsgp->rm_credit);\r\nrmsgp->rm_type = ntohl(rmsgp->rm_type);\r\nif (rmsgp->rm_vers != RPCRDMA_VERSION)\r\nreturn -ENOSYS;\r\nif (rmsgp->rm_type == RDMA_MSGP) {\r\nint hdrlen;\r\nrmsgp->rm_body.rm_padded.rm_align =\r\nntohl(rmsgp->rm_body.rm_padded.rm_align);\r\nrmsgp->rm_body.rm_padded.rm_thresh =\r\nntohl(rmsgp->rm_body.rm_padded.rm_thresh);\r\nva = &rmsgp->rm_body.rm_padded.rm_pempty[4];\r\nrqstp->rq_arg.head[0].iov_base = va;\r\nhdrlen = (u32)((unsigned long)va - (unsigned long)rmsgp);\r\nrqstp->rq_arg.head[0].iov_len -= hdrlen;\r\nif (hdrlen > rqstp->rq_arg.len)\r\nreturn -EINVAL;\r\nreturn hdrlen;\r\n}\r\nva = &rmsgp->rm_body.rm_chunks[0];\r\nvaend = (u32 *)((unsigned long)rmsgp + rqstp->rq_arg.len);\r\nva = decode_read_list(va, vaend);\r\nif (!va)\r\nreturn -EINVAL;\r\nva = decode_write_list(va, vaend);\r\nif (!va)\r\nreturn -EINVAL;\r\nva = decode_reply_array(va, vaend);\r\nif (!va)\r\nreturn -EINVAL;\r\nrqstp->rq_arg.head[0].iov_base = va;\r\nhdr_len = (unsigned long)va - (unsigned long)rmsgp;\r\nrqstp->rq_arg.head[0].iov_len -= hdr_len;\r\n*rdma_req = rmsgp;\r\nreturn hdr_len;\r\n}\r\nint svc_rdma_xdr_decode_deferred_req(struct svc_rqst *rqstp)\r\n{\r\nstruct rpcrdma_msg *rmsgp = NULL;\r\nstruct rpcrdma_read_chunk *ch;\r\nstruct rpcrdma_write_array *ary;\r\nu32 *va;\r\nu32 hdrlen;\r\ndprintk("svcrdma: processing deferred RDMA header on rqstp=%p\n",\r\nrqstp);\r\nrmsgp = (struct rpcrdma_msg *)rqstp->rq_arg.head[0].iov_base;\r\nif (rmsgp->rm_type == RDMA_MSGP) {\r\nva = &rmsgp->rm_body.rm_padded.rm_pempty[4];\r\nrqstp->rq_arg.head[0].iov_base = va;\r\nhdrlen = (u32)((unsigned long)va - (unsigned long)rmsgp);\r\nrqstp->rq_arg.head[0].iov_len -= hdrlen;\r\nreturn hdrlen;\r\n}\r\nva = &rmsgp->rm_body.rm_chunks[0];\r\nfor (ch = (struct rpcrdma_read_chunk *)va;\r\nch->rc_discrim != xdr_zero; ch++);\r\nva = (u32 *)&ch->rc_position;\r\nary = (struct rpcrdma_write_array *)va;\r\nif (ary->wc_discrim == xdr_zero)\r\nva = (u32 *)&ary->wc_nchunks;\r\nelse\r\nva = (u32 *)&ary->wc_array[ary->wc_nchunks].wc_target.rs_length;\r\nary = (struct rpcrdma_write_array *)va;\r\nif (ary->wc_discrim == xdr_zero)\r\nva = (u32 *)&ary->wc_nchunks;\r\nelse\r\nva = (u32 *)&ary->wc_array[ary->wc_nchunks];\r\nrqstp->rq_arg.head[0].iov_base = va;\r\nhdrlen = (unsigned long)va - (unsigned long)rmsgp;\r\nrqstp->rq_arg.head[0].iov_len -= hdrlen;\r\nreturn hdrlen;\r\n}\r\nint svc_rdma_xdr_encode_error(struct svcxprt_rdma *xprt,\r\nstruct rpcrdma_msg *rmsgp,\r\nenum rpcrdma_errcode err, u32 *va)\r\n{\r\nu32 *startp = va;\r\n*va++ = htonl(rmsgp->rm_xid);\r\n*va++ = htonl(rmsgp->rm_vers);\r\n*va++ = htonl(xprt->sc_max_requests);\r\n*va++ = htonl(RDMA_ERROR);\r\n*va++ = htonl(err);\r\nif (err == ERR_VERS) {\r\n*va++ = htonl(RPCRDMA_VERSION);\r\n*va++ = htonl(RPCRDMA_VERSION);\r\n}\r\nreturn (int)((unsigned long)va - (unsigned long)startp);\r\n}\r\nint svc_rdma_xdr_get_reply_hdr_len(struct rpcrdma_msg *rmsgp)\r\n{\r\nstruct rpcrdma_write_array *wr_ary;\r\nwr_ary = (struct rpcrdma_write_array *)\r\n&rmsgp->rm_body.rm_chunks[1];\r\nif (wr_ary->wc_discrim)\r\nwr_ary = (struct rpcrdma_write_array *)\r\n&wr_ary->wc_array[ntohl(wr_ary->wc_nchunks)].\r\nwc_target.rs_length;\r\nelse\r\nwr_ary = (struct rpcrdma_write_array *)\r\n&wr_ary->wc_nchunks;\r\nif (wr_ary->wc_discrim)\r\nwr_ary = (struct rpcrdma_write_array *)\r\n&wr_ary->wc_array[ntohl(wr_ary->wc_nchunks)];\r\nelse\r\nwr_ary = (struct rpcrdma_write_array *)\r\n&wr_ary->wc_nchunks;\r\nreturn (unsigned long) wr_ary - (unsigned long) rmsgp;\r\n}\r\nvoid svc_rdma_xdr_encode_write_list(struct rpcrdma_msg *rmsgp, int chunks)\r\n{\r\nstruct rpcrdma_write_array *ary;\r\nrmsgp->rm_body.rm_chunks[0] = xdr_zero;\r\nary = (struct rpcrdma_write_array *)\r\n&rmsgp->rm_body.rm_chunks[1];\r\nary->wc_discrim = xdr_one;\r\nary->wc_nchunks = htonl(chunks);\r\nary->wc_array[chunks].wc_target.rs_handle = xdr_zero;\r\nary->wc_array[chunks].wc_target.rs_length = xdr_zero;\r\n}\r\nvoid svc_rdma_xdr_encode_reply_array(struct rpcrdma_write_array *ary,\r\nint chunks)\r\n{\r\nary->wc_discrim = xdr_one;\r\nary->wc_nchunks = htonl(chunks);\r\n}\r\nvoid svc_rdma_xdr_encode_array_chunk(struct rpcrdma_write_array *ary,\r\nint chunk_no,\r\n__be32 rs_handle,\r\n__be64 rs_offset,\r\nu32 write_len)\r\n{\r\nstruct rpcrdma_segment *seg = &ary->wc_array[chunk_no].wc_target;\r\nseg->rs_handle = rs_handle;\r\nseg->rs_offset = rs_offset;\r\nseg->rs_length = htonl(write_len);\r\n}\r\nvoid svc_rdma_xdr_encode_reply_header(struct svcxprt_rdma *xprt,\r\nstruct rpcrdma_msg *rdma_argp,\r\nstruct rpcrdma_msg *rdma_resp,\r\nenum rpcrdma_proc rdma_type)\r\n{\r\nrdma_resp->rm_xid = htonl(rdma_argp->rm_xid);\r\nrdma_resp->rm_vers = htonl(rdma_argp->rm_vers);\r\nrdma_resp->rm_credit = htonl(xprt->sc_max_requests);\r\nrdma_resp->rm_type = htonl(rdma_type);\r\nrdma_resp->rm_body.rm_chunks[0] = xdr_zero;\r\nrdma_resp->rm_body.rm_chunks[1] = xdr_zero;\r\nrdma_resp->rm_body.rm_chunks[2] = xdr_zero;\r\n}

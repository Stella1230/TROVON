static void nfsd_inject_set(struct nfsd_fault_inject_op *op, u64 val)\r\n{\r\nu64 count = 0;\r\nif (val == 0)\r\nprintk(KERN_INFO "NFSD Fault Injection: %s (all)", op->file);\r\nelse\r\nprintk(KERN_INFO "NFSD Fault Injection: %s (n = %llu)", op->file, val);\r\nnfs4_lock_state();\r\ncount = nfsd_for_n_state(val, op->forget);\r\nnfs4_unlock_state();\r\nprintk(KERN_INFO "NFSD: %s: found %llu", op->file, count);\r\n}\r\nstatic void nfsd_inject_set_client(struct nfsd_fault_inject_op *op,\r\nstruct sockaddr_storage *addr,\r\nsize_t addr_size)\r\n{\r\nchar buf[INET6_ADDRSTRLEN];\r\nstruct nfs4_client *clp;\r\nu64 count;\r\nnfs4_lock_state();\r\nclp = nfsd_find_client(addr, addr_size);\r\nif (clp) {\r\ncount = op->forget(clp, 0);\r\nrpc_ntop((struct sockaddr *)&clp->cl_addr, buf, sizeof(buf));\r\nprintk(KERN_INFO "NFSD [%s]: Client %s had %llu state object(s)\n", op->file, buf, count);\r\n}\r\nnfs4_unlock_state();\r\n}\r\nstatic void nfsd_inject_get(struct nfsd_fault_inject_op *op, u64 *val)\r\n{\r\nnfs4_lock_state();\r\n*val = nfsd_for_n_state(0, op->print);\r\nnfs4_unlock_state();\r\n}\r\nstatic ssize_t fault_inject_read(struct file *file, char __user *buf,\r\nsize_t len, loff_t *ppos)\r\n{\r\nstatic u64 val;\r\nchar read_buf[25];\r\nsize_t size, ret;\r\nloff_t pos = *ppos;\r\nif (!pos)\r\nnfsd_inject_get(file_inode(file)->i_private, &val);\r\nsize = scnprintf(read_buf, sizeof(read_buf), "%llu\n", val);\r\nif (pos < 0)\r\nreturn -EINVAL;\r\nif (pos >= size || !len)\r\nreturn 0;\r\nif (len > size - pos)\r\nlen = size - pos;\r\nret = copy_to_user(buf, read_buf + pos, len);\r\nif (ret == len)\r\nreturn -EFAULT;\r\nlen -= ret;\r\n*ppos = pos + len;\r\nreturn len;\r\n}\r\nstatic ssize_t fault_inject_write(struct file *file, const char __user *buf,\r\nsize_t len, loff_t *ppos)\r\n{\r\nchar write_buf[INET6_ADDRSTRLEN];\r\nsize_t size = min(sizeof(write_buf) - 1, len);\r\nstruct net *net = current->nsproxy->net_ns;\r\nstruct sockaddr_storage sa;\r\nu64 val;\r\nif (copy_from_user(write_buf, buf, size))\r\nreturn -EFAULT;\r\nwrite_buf[size] = '\0';\r\nsize = rpc_pton(net, write_buf, size, (struct sockaddr *)&sa, sizeof(sa));\r\nif (size > 0)\r\nnfsd_inject_set_client(file_inode(file)->i_private, &sa, size);\r\nelse {\r\nval = simple_strtoll(write_buf, NULL, 0);\r\nnfsd_inject_set(file_inode(file)->i_private, val);\r\n}\r\nreturn len;\r\n}\r\nvoid nfsd_fault_inject_cleanup(void)\r\n{\r\ndebugfs_remove_recursive(debug_dir);\r\n}\r\nint nfsd_fault_inject_init(void)\r\n{\r\nunsigned int i;\r\nstruct nfsd_fault_inject_op *op;\r\numode_t mode = S_IFREG | S_IRUSR | S_IWUSR;\r\ndebug_dir = debugfs_create_dir("nfsd", NULL);\r\nif (!debug_dir)\r\ngoto fail;\r\nfor (i = 0; i < NUM_INJECT_OPS; i++) {\r\nop = &inject_ops[i];\r\nif (!debugfs_create_file(op->file, mode, debug_dir, op, &fops_nfsd))\r\ngoto fail;\r\n}\r\nreturn 0;\r\nfail:\r\nnfsd_fault_inject_cleanup();\r\nreturn -ENOMEM;\r\n}

static bool irq_remapped(struct irq_cfg *cfg)\r\n{\r\nreturn (cfg->remapped == 1);\r\n}\r\nstatic void irq_remapping_disable_io_apic(void)\r\n{\r\nif (cpu_has_apic || apic_from_smp_config())\r\ndisconnect_bsp_APIC(0);\r\n}\r\nstatic int do_setup_msi_irqs(struct pci_dev *dev, int nvec)\r\n{\r\nint node, ret, sub_handle, nvec_pow2, index = 0;\r\nunsigned int irq;\r\nstruct msi_desc *msidesc;\r\nWARN_ON(!list_is_singular(&dev->msi_list));\r\nmsidesc = list_entry(dev->msi_list.next, struct msi_desc, list);\r\nWARN_ON(msidesc->irq);\r\nWARN_ON(msidesc->msi_attrib.multiple);\r\nWARN_ON(msidesc->nvec_used);\r\nnode = dev_to_node(&dev->dev);\r\nirq = __create_irqs(get_nr_irqs_gsi(), nvec, node);\r\nif (irq == 0)\r\nreturn -ENOSPC;\r\nnvec_pow2 = __roundup_pow_of_two(nvec);\r\nmsidesc->nvec_used = nvec;\r\nmsidesc->msi_attrib.multiple = ilog2(nvec_pow2);\r\nfor (sub_handle = 0; sub_handle < nvec; sub_handle++) {\r\nif (!sub_handle) {\r\nindex = msi_alloc_remapped_irq(dev, irq, nvec_pow2);\r\nif (index < 0) {\r\nret = index;\r\ngoto error;\r\n}\r\n} else {\r\nret = msi_setup_remapped_irq(dev, irq + sub_handle,\r\nindex, sub_handle);\r\nif (ret < 0)\r\ngoto error;\r\n}\r\nret = setup_msi_irq(dev, msidesc, irq, sub_handle);\r\nif (ret < 0)\r\ngoto error;\r\n}\r\nreturn 0;\r\nerror:\r\ndestroy_irqs(irq, nvec);\r\nmsidesc->irq = 0;\r\nmsidesc->nvec_used = 0;\r\nmsidesc->msi_attrib.multiple = 0;\r\nreturn ret;\r\n}\r\nstatic int do_setup_msix_irqs(struct pci_dev *dev, int nvec)\r\n{\r\nint node, ret, sub_handle, index = 0;\r\nstruct msi_desc *msidesc;\r\nunsigned int irq;\r\nnode = dev_to_node(&dev->dev);\r\nirq = get_nr_irqs_gsi();\r\nsub_handle = 0;\r\nlist_for_each_entry(msidesc, &dev->msi_list, list) {\r\nirq = create_irq_nr(irq, node);\r\nif (irq == 0)\r\nreturn -1;\r\nif (sub_handle == 0)\r\nret = index = msi_alloc_remapped_irq(dev, irq, nvec);\r\nelse\r\nret = msi_setup_remapped_irq(dev, irq, index, sub_handle);\r\nif (ret < 0)\r\ngoto error;\r\nret = setup_msi_irq(dev, msidesc, irq, 0);\r\nif (ret < 0)\r\ngoto error;\r\nsub_handle += 1;\r\nirq += 1;\r\n}\r\nreturn 0;\r\nerror:\r\ndestroy_irq(irq);\r\nreturn ret;\r\n}\r\nstatic int irq_remapping_setup_msi_irqs(struct pci_dev *dev,\r\nint nvec, int type)\r\n{\r\nif (type == PCI_CAP_ID_MSI)\r\nreturn do_setup_msi_irqs(dev, nvec);\r\nelse\r\nreturn do_setup_msix_irqs(dev, nvec);\r\n}\r\nvoid eoi_ioapic_pin_remapped(int apic, int pin, int vector)\r\n{\r\nio_apic_eoi(apic, pin);\r\n}\r\nstatic void __init irq_remapping_modify_x86_ops(void)\r\n{\r\nx86_io_apic_ops.disable = irq_remapping_disable_io_apic;\r\nx86_io_apic_ops.set_affinity = set_remapped_irq_affinity;\r\nx86_io_apic_ops.setup_entry = setup_ioapic_remapped_entry;\r\nx86_io_apic_ops.eoi_ioapic_pin = eoi_ioapic_pin_remapped;\r\nx86_msi.setup_msi_irqs = irq_remapping_setup_msi_irqs;\r\nx86_msi.setup_hpet_msi = setup_hpet_msi_remapped;\r\nx86_msi.compose_msi_msg = compose_remapped_msi_msg;\r\n}\r\nstatic __init int setup_nointremap(char *str)\r\n{\r\ndisable_irq_remap = 1;\r\nreturn 0;\r\n}\r\nstatic __init int setup_irqremap(char *str)\r\n{\r\nif (!str)\r\nreturn -EINVAL;\r\nwhile (*str) {\r\nif (!strncmp(str, "on", 2))\r\ndisable_irq_remap = 0;\r\nelse if (!strncmp(str, "off", 3))\r\ndisable_irq_remap = 1;\r\nelse if (!strncmp(str, "nosid", 5))\r\ndisable_sourceid_checking = 1;\r\nelse if (!strncmp(str, "no_x2apic_optout", 16))\r\nno_x2apic_optout = 1;\r\nstr += strcspn(str, ",");\r\nwhile (*str == ',')\r\nstr++;\r\n}\r\nreturn 0;\r\n}\r\nvoid __init setup_irq_remapping_ops(void)\r\n{\r\nremap_ops = &intel_irq_remap_ops;\r\n#ifdef CONFIG_AMD_IOMMU\r\nif (amd_iommu_irq_ops.prepare() == 0)\r\nremap_ops = &amd_iommu_irq_ops;\r\n#endif\r\n}\r\nvoid set_irq_remapping_broken(void)\r\n{\r\nirq_remap_broken = 1;\r\n}\r\nint irq_remapping_supported(void)\r\n{\r\nif (disable_irq_remap)\r\nreturn 0;\r\nif (!remap_ops || !remap_ops->supported)\r\nreturn 0;\r\nreturn remap_ops->supported();\r\n}\r\nint __init irq_remapping_prepare(void)\r\n{\r\nif (!remap_ops || !remap_ops->prepare)\r\nreturn -ENODEV;\r\nreturn remap_ops->prepare();\r\n}\r\nint __init irq_remapping_enable(void)\r\n{\r\nint ret;\r\nif (!remap_ops || !remap_ops->enable)\r\nreturn -ENODEV;\r\nret = remap_ops->enable();\r\nif (irq_remapping_enabled)\r\nirq_remapping_modify_x86_ops();\r\nreturn ret;\r\n}\r\nvoid irq_remapping_disable(void)\r\n{\r\nif (!irq_remapping_enabled ||\r\n!remap_ops ||\r\n!remap_ops->disable)\r\nreturn;\r\nremap_ops->disable();\r\n}\r\nint irq_remapping_reenable(int mode)\r\n{\r\nif (!irq_remapping_enabled ||\r\n!remap_ops ||\r\n!remap_ops->reenable)\r\nreturn 0;\r\nreturn remap_ops->reenable(mode);\r\n}\r\nint __init irq_remap_enable_fault_handling(void)\r\n{\r\nif (!irq_remapping_enabled)\r\nreturn 0;\r\nif (!remap_ops || !remap_ops->enable_faulting)\r\nreturn -ENODEV;\r\nreturn remap_ops->enable_faulting();\r\n}\r\nint setup_ioapic_remapped_entry(int irq,\r\nstruct IO_APIC_route_entry *entry,\r\nunsigned int destination, int vector,\r\nstruct io_apic_irq_attr *attr)\r\n{\r\nif (!remap_ops || !remap_ops->setup_ioapic_entry)\r\nreturn -ENODEV;\r\nreturn remap_ops->setup_ioapic_entry(irq, entry, destination,\r\nvector, attr);\r\n}\r\nint set_remapped_irq_affinity(struct irq_data *data, const struct cpumask *mask,\r\nbool force)\r\n{\r\nif (!config_enabled(CONFIG_SMP) || !remap_ops ||\r\n!remap_ops->set_affinity)\r\nreturn 0;\r\nreturn remap_ops->set_affinity(data, mask, force);\r\n}\r\nvoid free_remapped_irq(int irq)\r\n{\r\nstruct irq_cfg *cfg = irq_get_chip_data(irq);\r\nif (!remap_ops || !remap_ops->free_irq)\r\nreturn;\r\nif (irq_remapped(cfg))\r\nremap_ops->free_irq(irq);\r\n}\r\nvoid compose_remapped_msi_msg(struct pci_dev *pdev,\r\nunsigned int irq, unsigned int dest,\r\nstruct msi_msg *msg, u8 hpet_id)\r\n{\r\nstruct irq_cfg *cfg = irq_get_chip_data(irq);\r\nif (!irq_remapped(cfg))\r\nnative_compose_msi_msg(pdev, irq, dest, msg, hpet_id);\r\nelse if (remap_ops && remap_ops->compose_msi_msg)\r\nremap_ops->compose_msi_msg(pdev, irq, dest, msg, hpet_id);\r\n}\r\nstatic int msi_alloc_remapped_irq(struct pci_dev *pdev, int irq, int nvec)\r\n{\r\nif (!remap_ops || !remap_ops->msi_alloc_irq)\r\nreturn -ENODEV;\r\nreturn remap_ops->msi_alloc_irq(pdev, irq, nvec);\r\n}\r\nstatic int msi_setup_remapped_irq(struct pci_dev *pdev, unsigned int irq,\r\nint index, int sub_handle)\r\n{\r\nif (!remap_ops || !remap_ops->msi_setup_irq)\r\nreturn -ENODEV;\r\nreturn remap_ops->msi_setup_irq(pdev, irq, index, sub_handle);\r\n}\r\nint setup_hpet_msi_remapped(unsigned int irq, unsigned int id)\r\n{\r\nif (!remap_ops || !remap_ops->setup_hpet_msi)\r\nreturn -ENODEV;\r\nreturn remap_ops->setup_hpet_msi(irq, id);\r\n}\r\nvoid panic_if_irq_remap(const char *msg)\r\n{\r\nif (irq_remapping_enabled)\r\npanic(msg);\r\n}\r\nstatic void ir_ack_apic_edge(struct irq_data *data)\r\n{\r\nack_APIC_irq();\r\n}\r\nstatic void ir_ack_apic_level(struct irq_data *data)\r\n{\r\nack_APIC_irq();\r\neoi_ioapic_irq(data->irq, data->chip_data);\r\n}\r\nstatic void ir_print_prefix(struct irq_data *data, struct seq_file *p)\r\n{\r\nseq_printf(p, " IR-%s", data->chip->name);\r\n}\r\nvoid irq_remap_modify_chip_defaults(struct irq_chip *chip)\r\n{\r\nchip->irq_print_chip = ir_print_prefix;\r\nchip->irq_ack = ir_ack_apic_edge;\r\nchip->irq_eoi = ir_ack_apic_level;\r\nchip->irq_set_affinity = x86_io_apic_ops.set_affinity;\r\n}\r\nbool setup_remapped_irq(int irq, struct irq_cfg *cfg, struct irq_chip *chip)\r\n{\r\nif (!irq_remapped(cfg))\r\nreturn false;\r\nirq_set_status_flags(irq, IRQ_MOVE_PCNTXT);\r\nirq_remap_modify_chip_defaults(chip);\r\nreturn true;\r\n}

static irqreturn_t sirfsoc_pwrc_isr(int irq, void *dev_id)\r\n{\r\nstruct sirfsoc_pwrc_drvdata *pwrcdrv = dev_id;\r\nu32 int_status;\r\nint_status = sirfsoc_rtc_iobrg_readl(pwrcdrv->pwrc_base +\r\nPWRC_INT_STATUS);\r\nsirfsoc_rtc_iobrg_writel(int_status & ~PWRC_ON_KEY_BIT,\r\npwrcdrv->pwrc_base + PWRC_INT_STATUS);\r\ninput_event(pwrcdrv->input, EV_PWR, KEY_SUSPEND, 1);\r\ninput_sync(pwrcdrv->input);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int sirfsoc_pwrc_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct sirfsoc_pwrc_drvdata *pwrcdrv;\r\nint irq;\r\nint error;\r\npwrcdrv = devm_kzalloc(&pdev->dev, sizeof(struct sirfsoc_pwrc_drvdata),\r\nGFP_KERNEL);\r\nif (!pwrcdrv) {\r\ndev_info(&pdev->dev, "Not enough memory for the device data\n");\r\nreturn -ENOMEM;\r\n}\r\nerror = of_property_read_u32(np, "reg", &pwrcdrv->pwrc_base);\r\nif (error) {\r\ndev_err(&pdev->dev,\r\n"unable to find base address of pwrc node in dtb\n");\r\nreturn error;\r\n}\r\npwrcdrv->input = devm_input_allocate_device(&pdev->dev);\r\nif (!pwrcdrv->input)\r\nreturn -ENOMEM;\r\npwrcdrv->input->name = "sirfsoc pwrckey";\r\npwrcdrv->input->phys = "pwrc/input0";\r\npwrcdrv->input->evbit[0] = BIT_MASK(EV_PWR);\r\nirq = platform_get_irq(pdev, 0);\r\nerror = devm_request_irq(&pdev->dev, irq,\r\nsirfsoc_pwrc_isr, IRQF_SHARED,\r\n"sirfsoc_pwrc_int", pwrcdrv);\r\nif (error) {\r\ndev_err(&pdev->dev, "unable to claim irq %d, error: %d\n",\r\nirq, error);\r\nreturn error;\r\n}\r\nsirfsoc_rtc_iobrg_writel(\r\nsirfsoc_rtc_iobrg_readl(pwrcdrv->pwrc_base + PWRC_INT_MASK) |\r\nPWRC_ON_KEY_BIT,\r\npwrcdrv->pwrc_base + PWRC_INT_MASK);\r\nerror = input_register_device(pwrcdrv->input);\r\nif (error) {\r\ndev_err(&pdev->dev,\r\n"unable to register input device, error: %d\n",\r\nerror);\r\nreturn error;\r\n}\r\nplatform_set_drvdata(pdev, pwrcdrv);\r\ndevice_init_wakeup(&pdev->dev, 1);\r\nreturn 0;\r\n}\r\nstatic int sirfsoc_pwrc_remove(struct platform_device *pdev)\r\n{\r\ndevice_init_wakeup(&pdev->dev, 0);\r\nreturn 0;\r\n}\r\nstatic int pwrc_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct sirfsoc_pwrc_drvdata *pwrcdrv = platform_get_drvdata(pdev);\r\nsirfsoc_rtc_iobrg_writel(\r\nsirfsoc_rtc_iobrg_readl(\r\npwrcdrv->pwrc_base + PWRC_INT_MASK) | PWRC_ON_KEY_BIT,\r\npwrcdrv->pwrc_base + PWRC_INT_MASK);\r\nreturn 0;\r\n}

void __init_or_module\r\nparavirt_flush_i_cache_range(const void *instr, unsigned long size)\r\n{\r\nextern void paravirt_fc_i(const void *addr);\r\nunsigned long i;\r\nfor (i = 0; i < size; i += sizeof(bundle_t))\r\nparavirt_fc_i(instr + i);\r\n}\r\nbundle_t* __init_or_module\r\nparavirt_get_bundle(unsigned long tag)\r\n{\r\nreturn (bundle_t *)(tag & ~3UL);\r\n}\r\nunsigned long __init_or_module\r\nparavirt_get_slot(unsigned long tag)\r\n{\r\nreturn tag & 3UL;\r\n}\r\nunsigned long __init_or_module\r\nparavirt_get_num_inst(unsigned long stag, unsigned long etag)\r\n{\r\nbundle_t *sbundle = paravirt_get_bundle(stag);\r\nunsigned long sslot = paravirt_get_slot(stag);\r\nbundle_t *ebundle = paravirt_get_bundle(etag);\r\nunsigned long eslot = paravirt_get_slot(etag);\r\nreturn (ebundle - sbundle) * 3 + eslot - sslot + 1;\r\n}\r\nunsigned long __init_or_module\r\nparavirt_get_next_tag(unsigned long tag)\r\n{\r\nunsigned long slot = paravirt_get_slot(tag);\r\nswitch (slot) {\r\ncase 0:\r\ncase 1:\r\nreturn tag + 1;\r\ncase 2: {\r\nbundle_t *bundle = paravirt_get_bundle(tag);\r\nreturn (unsigned long)(bundle + 1);\r\n}\r\ndefault:\r\nBUG();\r\n}\r\n}\r\nia64_inst_t __init_or_module\r\nparavirt_read_slot0(const bundle_t *bundle)\r\n{\r\nia64_inst_t inst;\r\ninst.l = bundle->quad0.slot0;\r\nreturn inst;\r\n}\r\nia64_inst_t __init_or_module\r\nparavirt_read_slot1(const bundle_t *bundle)\r\n{\r\nia64_inst_t inst;\r\ninst.l = bundle->quad0.slot1_p0 |\r\n((unsigned long long)bundle->quad1.slot1_p1 << 18UL);\r\nreturn inst;\r\n}\r\nia64_inst_t __init_or_module\r\nparavirt_read_slot2(const bundle_t *bundle)\r\n{\r\nia64_inst_t inst;\r\ninst.l = bundle->quad1.slot2;\r\nreturn inst;\r\n}\r\nia64_inst_t __init_or_module\r\nparavirt_read_inst(unsigned long tag)\r\n{\r\nbundle_t *bundle = paravirt_get_bundle(tag);\r\nunsigned long slot = paravirt_get_slot(tag);\r\nswitch (slot) {\r\ncase 0:\r\nreturn paravirt_read_slot0(bundle);\r\ncase 1:\r\nreturn paravirt_read_slot1(bundle);\r\ncase 2:\r\nreturn paravirt_read_slot2(bundle);\r\ndefault:\r\nBUG();\r\n}\r\n}\r\nvoid __init_or_module\r\nparavirt_write_slot0(bundle_t *bundle, ia64_inst_t inst)\r\n{\r\nbundle->quad0.slot0 = inst.l;\r\n}\r\nvoid __init_or_module\r\nparavirt_write_slot1(bundle_t *bundle, ia64_inst_t inst)\r\n{\r\nbundle->quad0.slot1_p0 = inst.l;\r\nbundle->quad1.slot1_p1 = inst.l >> 18UL;\r\n}\r\nvoid __init_or_module\r\nparavirt_write_slot2(bundle_t *bundle, ia64_inst_t inst)\r\n{\r\nbundle->quad1.slot2 = inst.l;\r\n}\r\nvoid __init_or_module\r\nparavirt_write_inst(unsigned long tag, ia64_inst_t inst)\r\n{\r\nbundle_t *bundle = paravirt_get_bundle(tag);\r\nunsigned long slot = paravirt_get_slot(tag);\r\nswitch (slot) {\r\ncase 0:\r\nparavirt_write_slot0(bundle, inst);\r\nbreak;\r\ncase 1:\r\nparavirt_write_slot1(bundle, inst);\r\nbreak;\r\ncase 2:\r\nparavirt_write_slot2(bundle, inst);\r\nbreak;\r\ndefault:\r\nBUG();\r\nbreak;\r\n}\r\nparavirt_flush_i_cache_range(bundle, sizeof(*bundle));\r\n}\r\nvoid\r\nparavirt_print_bundle(const bundle_t *bundle)\r\n{\r\nconst unsigned long *quad = (const unsigned long *)bundle;\r\nia64_inst_t slot0 = paravirt_read_slot0(bundle);\r\nia64_inst_t slot1 = paravirt_read_slot1(bundle);\r\nia64_inst_t slot2 = paravirt_read_slot2(bundle);\r\nprintk(KERN_DEBUG\r\n"bundle 0x%p 0x%016lx 0x%016lx\n", bundle, quad[0], quad[1]);\r\nprintk(KERN_DEBUG\r\n"bundle template 0x%x\n",\r\nbundle->quad0.template);\r\nprintk(KERN_DEBUG\r\n"slot0 0x%lx slot1_p0 0x%lx slot1_p1 0x%lx slot2 0x%lx\n",\r\n(unsigned long)bundle->quad0.slot0,\r\n(unsigned long)bundle->quad0.slot1_p0,\r\n(unsigned long)bundle->quad1.slot1_p1,\r\n(unsigned long)bundle->quad1.slot2);\r\nprintk(KERN_DEBUG\r\n"slot0 0x%016llx slot1 0x%016llx slot2 0x%016llx\n",\r\nslot0.l, slot1.l, slot2.l);\r\n}\r\nstatic int __init setup_noreplace_paravirt(char *str)\r\n{\r\nnoreplace_paravirt = 1;\r\nreturn 1;\r\n}\r\nstatic void __init_or_module\r\nfill_nop_bundle(void *sbundle, void *ebundle)\r\n{\r\nextern const char paravirt_nop_bundle[];\r\nextern const unsigned long paravirt_nop_bundle_size;\r\nvoid *bundle = sbundle;\r\nBUG_ON((((unsigned long)sbundle) % sizeof(bundle_t)) != 0);\r\nBUG_ON((((unsigned long)ebundle) % sizeof(bundle_t)) != 0);\r\nwhile (bundle < ebundle) {\r\nmemcpy(bundle, paravirt_nop_bundle, paravirt_nop_bundle_size);\r\nbundle += paravirt_nop_bundle_size;\r\n}\r\n}\r\nunsigned long __init_or_module\r\n__paravirt_patch_apply_bundle(void *sbundle, void *ebundle, unsigned long type,\r\nconst struct paravirt_patch_bundle_elem *elems,\r\nunsigned long nelems,\r\nconst struct paravirt_patch_bundle_elem **found)\r\n{\r\nunsigned long used = 0;\r\nunsigned long i;\r\nBUG_ON((((unsigned long)sbundle) % sizeof(bundle_t)) != 0);\r\nBUG_ON((((unsigned long)ebundle) % sizeof(bundle_t)) != 0);\r\nfound = NULL;\r\nfor (i = 0; i < nelems; i++) {\r\nconst struct paravirt_patch_bundle_elem *p = &elems[i];\r\nif (p->type == type) {\r\nunsigned long need = p->ebundle - p->sbundle;\r\nunsigned long room = ebundle - sbundle;\r\nif (found != NULL)\r\n*found = p;\r\nif (room < need) {\r\nprintk(KERN_DEBUG\r\n"the space is too small to put "\r\n"bundles. type %ld need %ld room %ld\n",\r\ntype, need, room);\r\nbreak;\r\n}\r\nused = need;\r\nmemcpy(sbundle, p->sbundle, used);\r\nbreak;\r\n}\r\n}\r\nreturn used;\r\n}\r\nvoid __init_or_module\r\nparavirt_patch_apply_bundle(const struct paravirt_patch_site_bundle *start,\r\nconst struct paravirt_patch_site_bundle *end)\r\n{\r\nconst struct paravirt_patch_site_bundle *p;\r\nif (noreplace_paravirt)\r\nreturn;\r\nif (pv_init_ops.patch_bundle == NULL)\r\nreturn;\r\nfor (p = start; p < end; p++) {\r\nunsigned long used;\r\nused = (*pv_init_ops.patch_bundle)(p->sbundle, p->ebundle,\r\np->type);\r\nif (used == 0)\r\ncontinue;\r\nfill_nop_bundle(p->sbundle + used, p->ebundle);\r\nparavirt_flush_i_cache_range(p->sbundle,\r\np->ebundle - p->sbundle);\r\n}\r\nia64_sync_i();\r\nia64_srlz_i();\r\n}\r\nstatic void __init_or_module\r\nfill_nop_inst(unsigned long stag, unsigned long etag)\r\n{\r\nextern const bundle_t paravirt_nop_mfi_inst_bundle[];\r\nunsigned long tag;\r\nconst ia64_inst_t nop_inst =\r\nparavirt_read_slot0(paravirt_nop_mfi_inst_bundle);\r\nfor (tag = stag; tag < etag; tag = paravirt_get_next_tag(tag))\r\nparavirt_write_inst(tag, nop_inst);\r\n}\r\nvoid __init_or_module\r\nparavirt_patch_apply_inst(const struct paravirt_patch_site_inst *start,\r\nconst struct paravirt_patch_site_inst *end)\r\n{\r\nconst struct paravirt_patch_site_inst *p;\r\nif (noreplace_paravirt)\r\nreturn;\r\nif (pv_init_ops.patch_inst == NULL)\r\nreturn;\r\nfor (p = start; p < end; p++) {\r\nunsigned long tag;\r\nbundle_t *sbundle;\r\nbundle_t *ebundle;\r\ntag = (*pv_init_ops.patch_inst)(p->stag, p->etag, p->type);\r\nif (tag == p->stag)\r\ncontinue;\r\nfill_nop_inst(tag, p->etag);\r\nsbundle = paravirt_get_bundle(p->stag);\r\nebundle = paravirt_get_bundle(p->etag) + 1;\r\nparavirt_flush_i_cache_range(sbundle, (ebundle - sbundle) *\r\nsizeof(bundle_t));\r\n}\r\nia64_sync_i();\r\nia64_srlz_i();\r\n}\r\nvoid __init_or_module\r\nparavirt_patch_reloc_brl(unsigned long tag, const void *target)\r\n{\r\nunsigned long tag_op = paravirt_get_next_tag(tag);\r\nunsigned long tag_imm = tag;\r\nbundle_t *bundle = paravirt_get_bundle(tag);\r\nia64_inst_t inst_op = paravirt_read_inst(tag_op);\r\nia64_inst_t inst_imm = paravirt_read_inst(tag_imm);\r\ninst_x3_op_t inst_x3_op = { .l = inst_op.l };\r\ninst_x3_imm_t inst_x3_imm = { .l = inst_imm.l };\r\nunsigned long imm60 =\r\n((unsigned long)target - (unsigned long)bundle) >> 4;\r\nBUG_ON(paravirt_get_slot(tag) != 1);\r\nBUG_ON(((unsigned long)target & (sizeof(bundle_t) - 1)) != 0);\r\ninst_x3_op.i = (imm60 >> 59) & 1;\r\ninst_x3_op.imm20b = imm60 & ((1UL << 20) - 1);\r\ninst_x3_imm.imm39 = (imm60 >> 20) & ((1UL << 39) - 1);\r\ninst_op.l = inst_x3_op.l;\r\ninst_imm.l = inst_x3_imm.l;\r\nparavirt_write_inst(tag_op, inst_op);\r\nparavirt_write_inst(tag_imm, inst_imm);\r\n}\r\nvoid __init\r\nparavirt_patch_reloc_br(unsigned long tag, const void *target)\r\n{\r\nbundle_t *bundle = paravirt_get_bundle(tag);\r\nia64_inst_t inst = paravirt_read_inst(tag);\r\nunsigned long target25 = (unsigned long)target - (unsigned long)bundle;\r\ninst_b1_t inst_b1;\r\nBUG_ON(((unsigned long)target & (sizeof(bundle_t) - 1)) != 0);\r\ninst_b1.l = inst.l;\r\nif (target25 & (1UL << 63))\r\ninst_b1.s = 1;\r\nelse\r\ninst_b1.s = 0;\r\ninst_b1.imm20b = target25 >> 4;\r\ninst.l = inst_b1.l;\r\nparavirt_write_inst(tag, inst);\r\n}\r\nvoid __init\r\n__paravirt_patch_apply_branch(\r\nunsigned long tag, unsigned long type,\r\nconst struct paravirt_patch_branch_target *entries,\r\nunsigned int nr_entries)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < nr_entries; i++) {\r\nif (entries[i].type == type) {\r\nparavirt_patch_reloc_br(tag, entries[i].entry);\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void __init\r\nparavirt_patch_apply_branch(const struct paravirt_patch_site_branch *start,\r\nconst struct paravirt_patch_site_branch *end)\r\n{\r\nconst struct paravirt_patch_site_branch *p;\r\nif (noreplace_paravirt)\r\nreturn;\r\nif (pv_init_ops.patch_branch == NULL)\r\nreturn;\r\nfor (p = start; p < end; p++)\r\n(*pv_init_ops.patch_branch)(p->tag, p->type);\r\nia64_sync_i();\r\nia64_srlz_i();\r\n}\r\nvoid __init\r\nparavirt_patch_apply(void)\r\n{\r\nextern const char __start_paravirt_bundles[];\r\nextern const char __stop_paravirt_bundles[];\r\nextern const char __start_paravirt_insts[];\r\nextern const char __stop_paravirt_insts[];\r\nextern const char __start_paravirt_branches[];\r\nextern const char __stop_paravirt_branches[];\r\nparavirt_patch_apply_bundle((const struct paravirt_patch_site_bundle *)\r\n__start_paravirt_bundles,\r\n(const struct paravirt_patch_site_bundle *)\r\n__stop_paravirt_bundles);\r\nparavirt_patch_apply_inst((const struct paravirt_patch_site_inst *)\r\n__start_paravirt_insts,\r\n(const struct paravirt_patch_site_inst *)\r\n__stop_paravirt_insts);\r\nparavirt_patch_apply_branch((const struct paravirt_patch_site_branch *)\r\n__start_paravirt_branches,\r\n(const struct paravirt_patch_site_branch *)\r\n__stop_paravirt_branches);\r\n}

static int bh1780_write(struct bh1780_data *ddata, u8 reg, u8 val, char *msg)\r\n{\r\nint ret = i2c_smbus_write_byte_data(ddata->client, reg, val);\r\nif (ret < 0)\r\ndev_err(&ddata->client->dev,\r\n"i2c_smbus_write_byte_data failed error %d Register (%s)\n",\r\nret, msg);\r\nreturn ret;\r\n}\r\nstatic int bh1780_read(struct bh1780_data *ddata, u8 reg, char *msg)\r\n{\r\nint ret = i2c_smbus_read_byte_data(ddata->client, reg);\r\nif (ret < 0)\r\ndev_err(&ddata->client->dev,\r\n"i2c_smbus_read_byte_data failed error %d Register (%s)\n",\r\nret, msg);\r\nreturn ret;\r\n}\r\nstatic ssize_t bh1780_show_lux(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct bh1780_data *ddata = platform_get_drvdata(pdev);\r\nint lsb, msb;\r\nlsb = bh1780_read(ddata, BH1780_REG_DLOW, "DLOW");\r\nif (lsb < 0)\r\nreturn lsb;\r\nmsb = bh1780_read(ddata, BH1780_REG_DHIGH, "DHIGH");\r\nif (msb < 0)\r\nreturn msb;\r\nreturn sprintf(buf, "%d\n", (msb << 8) | lsb);\r\n}\r\nstatic ssize_t bh1780_show_power_state(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct bh1780_data *ddata = platform_get_drvdata(pdev);\r\nint state;\r\nstate = bh1780_read(ddata, BH1780_REG_CONTROL, "CONTROL");\r\nif (state < 0)\r\nreturn state;\r\nreturn sprintf(buf, "%d\n", state & BH1780_POWMASK);\r\n}\r\nstatic ssize_t bh1780_store_power_state(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct bh1780_data *ddata = platform_get_drvdata(pdev);\r\nunsigned long val;\r\nint error;\r\nerror = kstrtoul(buf, 0, &val);\r\nif (error)\r\nreturn error;\r\nif (val < BH1780_POFF || val > BH1780_PON)\r\nreturn -EINVAL;\r\nmutex_lock(&ddata->lock);\r\nerror = bh1780_write(ddata, BH1780_REG_CONTROL, val, "CONTROL");\r\nif (error < 0) {\r\nmutex_unlock(&ddata->lock);\r\nreturn error;\r\n}\r\nmsleep(BH1780_PON_DELAY);\r\nddata->power_state = val;\r\nmutex_unlock(&ddata->lock);\r\nreturn count;\r\n}\r\nstatic int bh1780_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nint ret;\r\nstruct bh1780_data *ddata = NULL;\r\nstruct i2c_adapter *adapter = to_i2c_adapter(client->dev.parent);\r\nif (!i2c_check_functionality(adapter, I2C_FUNC_SMBUS_BYTE)) {\r\nret = -EIO;\r\ngoto err_op_failed;\r\n}\r\nddata = kzalloc(sizeof(struct bh1780_data), GFP_KERNEL);\r\nif (ddata == NULL) {\r\nret = -ENOMEM;\r\ngoto err_op_failed;\r\n}\r\nddata->client = client;\r\ni2c_set_clientdata(client, ddata);\r\nret = bh1780_read(ddata, BH1780_REG_PARTID, "PART ID");\r\nif (ret < 0)\r\ngoto err_op_failed;\r\ndev_info(&client->dev, "Ambient Light Sensor, Rev : %d\n",\r\n(ret & BH1780_REVMASK));\r\nmutex_init(&ddata->lock);\r\nret = sysfs_create_group(&client->dev.kobj, &bh1780_attr_group);\r\nif (ret)\r\ngoto err_op_failed;\r\nreturn 0;\r\nerr_op_failed:\r\nkfree(ddata);\r\nreturn ret;\r\n}\r\nstatic int bh1780_remove(struct i2c_client *client)\r\n{\r\nstruct bh1780_data *ddata;\r\nddata = i2c_get_clientdata(client);\r\nsysfs_remove_group(&client->dev.kobj, &bh1780_attr_group);\r\nkfree(ddata);\r\nreturn 0;\r\n}\r\nstatic int bh1780_suspend(struct device *dev)\r\n{\r\nstruct bh1780_data *ddata;\r\nint state, ret;\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nddata = i2c_get_clientdata(client);\r\nstate = bh1780_read(ddata, BH1780_REG_CONTROL, "CONTROL");\r\nif (state < 0)\r\nreturn state;\r\nddata->power_state = state & BH1780_POWMASK;\r\nret = bh1780_write(ddata, BH1780_REG_CONTROL, BH1780_POFF,\r\n"CONTROL");\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int bh1780_resume(struct device *dev)\r\n{\r\nstruct bh1780_data *ddata;\r\nint state, ret;\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nddata = i2c_get_clientdata(client);\r\nstate = ddata->power_state;\r\nret = bh1780_write(ddata, BH1780_REG_CONTROL, state,\r\n"CONTROL");\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}

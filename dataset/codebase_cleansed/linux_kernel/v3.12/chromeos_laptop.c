static struct i2c_client __init *__add_probed_i2c_device(\r\nconst char *name,\r\nint bus,\r\nstruct i2c_board_info *info,\r\nconst unsigned short *addrs)\r\n{\r\nconst struct dmi_device *dmi_dev;\r\nconst struct dmi_dev_onboard *dev_data;\r\nstruct i2c_adapter *adapter;\r\nstruct i2c_client *client;\r\nif (bus < 0)\r\nreturn NULL;\r\nif (name) {\r\ndmi_dev = dmi_find_device(DMI_DEV_TYPE_DEV_ONBOARD, name, NULL);\r\nif (!dmi_dev) {\r\npr_err("%s failed to dmi find device %s.\n",\r\n__func__,\r\nname);\r\nreturn NULL;\r\n}\r\ndev_data = (struct dmi_dev_onboard *)dmi_dev->device_data;\r\nif (!dev_data) {\r\npr_err("%s failed to get data from dmi for %s.\n",\r\n__func__, name);\r\nreturn NULL;\r\n}\r\ninfo->irq = dev_data->instance;\r\n}\r\nadapter = i2c_get_adapter(bus);\r\nif (!adapter) {\r\npr_err("%s failed to get i2c adapter %d.\n", __func__, bus);\r\nreturn NULL;\r\n}\r\nclient = i2c_new_probed_device(adapter, info, addrs, NULL);\r\nif (!client)\r\npr_err("%s failed to register device %d-%02x\n",\r\n__func__, bus, info->addr);\r\nelse\r\npr_debug("%s added i2c device %d-%02x\n",\r\n__func__, bus, info->addr);\r\ni2c_put_adapter(adapter);\r\nreturn client;\r\n}\r\nstatic int __init __find_i2c_adap(struct device *dev, void *data)\r\n{\r\nconst char *name = data;\r\nstatic const char *prefix = "i2c-";\r\nstruct i2c_adapter *adapter;\r\nif (strncmp(dev_name(dev), prefix, strlen(prefix)) != 0)\r\nreturn 0;\r\nadapter = to_i2c_adapter(dev);\r\nreturn (strncmp(adapter->name, name, strlen(name)) == 0);\r\n}\r\nstatic int __init find_i2c_adapter_num(enum i2c_adapter_type type)\r\n{\r\nstruct device *dev = NULL;\r\nstruct i2c_adapter *adapter;\r\nconst char *name = i2c_adapter_names[type];\r\ndev = bus_find_device(&i2c_bus_type, NULL, (void *)name,\r\n__find_i2c_adap);\r\nif (!dev) {\r\npr_err("%s: i2c adapter %s not found on system.\n", __func__,\r\nname);\r\nreturn -ENODEV;\r\n}\r\nadapter = to_i2c_adapter(dev);\r\nreturn adapter->nr;\r\n}\r\nstatic struct i2c_client __init *add_smbus_device(const char *name,\r\nstruct i2c_board_info *info)\r\n{\r\nreturn add_i2c_device(name, I2C_ADAPTER_SMBUS, info);\r\n}\r\nstatic int __init setup_cyapa_smbus_tp(const struct dmi_system_id *id)\r\n{\r\ntp = add_smbus_device("trackpad", &cyapa_device);\r\nreturn 0;\r\n}\r\nstatic int __init setup_atmel_224s_tp(const struct dmi_system_id *id)\r\n{\r\nconst unsigned short addr_list[] = { ATMEL_TP_I2C_BL_ADDR,\r\nATMEL_TP_I2C_ADDR,\r\nI2C_CLIENT_END };\r\ntp = add_probed_i2c_device("trackpad", I2C_ADAPTER_VGADDC,\r\n&atmel_224s_tp_device, addr_list);\r\nreturn 0;\r\n}\r\nstatic int __init setup_atmel_1664s_ts(const struct dmi_system_id *id)\r\n{\r\nconst unsigned short addr_list[] = { ATMEL_TS_I2C_BL_ADDR,\r\nATMEL_TS_I2C_ADDR,\r\nI2C_CLIENT_END };\r\nts = add_probed_i2c_device("touchscreen", I2C_ADAPTER_PANEL,\r\n&atmel_1664s_device, addr_list);\r\nreturn 0;\r\n}\r\nstatic int __init setup_isl29018_als(const struct dmi_system_id *id)\r\n{\r\nals = add_smbus_device("lightsensor", &isl_als_device);\r\nreturn 0;\r\n}\r\nstatic int __init setup_isl29023_als(const struct dmi_system_id *id)\r\n{\r\nals = add_i2c_device("lightsensor", I2C_ADAPTER_PANEL,\r\n&isl_als_device);\r\nreturn 0;\r\n}\r\nstatic int __init setup_tsl2583_als(const struct dmi_system_id *id)\r\n{\r\nals = add_smbus_device(NULL, &tsl2583_als_device);\r\nreturn 0;\r\n}\r\nstatic int __init setup_tsl2563_als(const struct dmi_system_id *id)\r\n{\r\nals = add_smbus_device(NULL, &tsl2563_als_device);\r\nreturn 0;\r\n}\r\nstatic int __init chromeos_laptop_init(void)\r\n{\r\nif (!dmi_check_system(chromeos_laptop_dmi_table)) {\r\npr_debug("%s unsupported system.\n", __func__);\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit chromeos_laptop_exit(void)\r\n{\r\nif (als)\r\ni2c_unregister_device(als);\r\nif (tp)\r\ni2c_unregister_device(tp);\r\nif (ts)\r\ni2c_unregister_device(ts);\r\n}

static int bells_set_bias_level(struct snd_soc_card *card,\r\nstruct snd_soc_dapm_context *dapm,\r\nenum snd_soc_bias_level level)\r\n{\r\nstruct snd_soc_dai *codec_dai = card->rtd[DAI_DSP_CODEC].codec_dai;\r\nstruct snd_soc_codec *codec = codec_dai->codec;\r\nstruct bells_drvdata *bells = card->drvdata;\r\nint ret;\r\nif (dapm->dev != codec_dai->dev)\r\nreturn 0;\r\nswitch (level) {\r\ncase SND_SOC_BIAS_PREPARE:\r\nif (dapm->bias_level != SND_SOC_BIAS_STANDBY)\r\nbreak;\r\nret = snd_soc_codec_set_pll(codec, WM5102_FLL1,\r\nARIZONA_FLL_SRC_MCLK1,\r\nMCLK_RATE,\r\nbells->sysclk_rate);\r\nif (ret < 0)\r\npr_err("Failed to start FLL: %d\n", ret);\r\nif (bells->asyncclk_rate) {\r\nret = snd_soc_codec_set_pll(codec, WM5102_FLL2,\r\nARIZONA_FLL_SRC_AIF2BCLK,\r\nBCLK2_RATE,\r\nbells->asyncclk_rate);\r\nif (ret < 0)\r\npr_err("Failed to start FLL: %d\n", ret);\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int bells_set_bias_level_post(struct snd_soc_card *card,\r\nstruct snd_soc_dapm_context *dapm,\r\nenum snd_soc_bias_level level)\r\n{\r\nstruct snd_soc_dai *codec_dai = card->rtd[DAI_DSP_CODEC].codec_dai;\r\nstruct snd_soc_codec *codec = codec_dai->codec;\r\nstruct bells_drvdata *bells = card->drvdata;\r\nint ret;\r\nif (dapm->dev != codec_dai->dev)\r\nreturn 0;\r\nswitch (level) {\r\ncase SND_SOC_BIAS_STANDBY:\r\nret = snd_soc_codec_set_pll(codec, WM5102_FLL1, 0, 0, 0);\r\nif (ret < 0) {\r\npr_err("Failed to stop FLL: %d\n", ret);\r\nreturn ret;\r\n}\r\nif (bells->asyncclk_rate) {\r\nret = snd_soc_codec_set_pll(codec, WM5102_FLL2,\r\n0, 0, 0);\r\nif (ret < 0) {\r\npr_err("Failed to stop FLL: %d\n", ret);\r\nreturn ret;\r\n}\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\ndapm->bias_level = level;\r\nreturn 0;\r\n}\r\nstatic int bells_late_probe(struct snd_soc_card *card)\r\n{\r\nstruct bells_drvdata *bells = card->drvdata;\r\nstruct snd_soc_codec *wm0010 = card->rtd[DAI_AP_DSP].codec;\r\nstruct snd_soc_codec *codec = card->rtd[DAI_DSP_CODEC].codec;\r\nstruct snd_soc_dai *aif1_dai = card->rtd[DAI_DSP_CODEC].codec_dai;\r\nstruct snd_soc_dai *aif2_dai;\r\nstruct snd_soc_dai *aif3_dai;\r\nstruct snd_soc_dai *wm9081_dai;\r\nint ret;\r\nret = snd_soc_codec_set_sysclk(codec, ARIZONA_CLK_SYSCLK,\r\nARIZONA_CLK_SRC_FLL1,\r\nbells->sysclk_rate,\r\nSND_SOC_CLOCK_IN);\r\nif (ret != 0) {\r\ndev_err(codec->dev, "Failed to set SYSCLK: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = snd_soc_codec_set_sysclk(wm0010, 0, 0, SYS_MCLK_RATE, 0);\r\nif (ret != 0) {\r\ndev_err(wm0010->dev, "Failed to set WM0010 clock: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = snd_soc_dai_set_sysclk(aif1_dai, ARIZONA_CLK_SYSCLK, 0, 0);\r\nif (ret != 0)\r\ndev_err(aif1_dai->dev, "Failed to set AIF1 clock: %d\n", ret);\r\nret = snd_soc_codec_set_sysclk(codec, ARIZONA_CLK_OPCLK, 0,\r\nSYS_MCLK_RATE, SND_SOC_CLOCK_OUT);\r\nif (ret != 0)\r\ndev_err(codec->dev, "Failed to set OPCLK: %d\n", ret);\r\nif (card->num_rtd == DAI_CODEC_CP)\r\nreturn 0;\r\nret = snd_soc_codec_set_sysclk(codec, ARIZONA_CLK_ASYNCCLK,\r\nARIZONA_CLK_SRC_FLL2,\r\nbells->asyncclk_rate,\r\nSND_SOC_CLOCK_IN);\r\nif (ret != 0) {\r\ndev_err(codec->dev, "Failed to set ASYNCCLK: %d\n", ret);\r\nreturn ret;\r\n}\r\naif2_dai = card->rtd[DAI_CODEC_CP].cpu_dai;\r\nret = snd_soc_dai_set_sysclk(aif2_dai, ARIZONA_CLK_ASYNCCLK, 0, 0);\r\nif (ret != 0) {\r\ndev_err(aif2_dai->dev, "Failed to set AIF2 clock: %d\n", ret);\r\nreturn ret;\r\n}\r\nif (card->num_rtd == DAI_CODEC_SUB)\r\nreturn 0;\r\naif3_dai = card->rtd[DAI_CODEC_SUB].cpu_dai;\r\nwm9081_dai = card->rtd[DAI_CODEC_SUB].codec_dai;\r\nret = snd_soc_dai_set_sysclk(aif3_dai, ARIZONA_CLK_SYSCLK, 0, 0);\r\nif (ret != 0) {\r\ndev_err(aif1_dai->dev, "Failed to set AIF1 clock: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = snd_soc_codec_set_sysclk(wm9081_dai->codec, WM9081_SYSCLK_MCLK,\r\n0, SYS_MCLK_RATE, 0);\r\nif (ret != 0) {\r\ndev_err(wm9081_dai->dev, "Failed to set MCLK: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int bells_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nbells_cards[pdev->id].dev = &pdev->dev;\r\nret = snd_soc_register_card(&bells_cards[pdev->id]);\r\nif (ret) {\r\ndev_err(&pdev->dev,\r\n"snd_soc_register_card(%s) failed: %d\n",\r\nbells_cards[pdev->id].name, ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int bells_remove(struct platform_device *pdev)\r\n{\r\nsnd_soc_unregister_card(&bells_cards[pdev->id]);\r\nreturn 0;\r\n}

static int joydump_connect(struct gameport *gameport, struct gameport_driver *drv)\r\n{\r\nstruct joydump *buf;\r\nstruct joydump *dump, *prev;\r\nint axes[4], buttons;\r\nint i, j, t, timeout;\r\nunsigned long flags;\r\nunsigned char u;\r\nprintk(KERN_INFO "joydump: ,------------------ START ----------------.\n");\r\nprintk(KERN_INFO "joydump: | Dumping: %30s |\n", gameport->phys);\r\nprintk(KERN_INFO "joydump: | Speed: %28d kHz |\n", gameport->speed);\r\nif (gameport_open(gameport, drv, GAMEPORT_MODE_RAW)) {\r\nprintk(KERN_INFO "joydump: | Raw mode not available - trying cooked. |\n");\r\nif (gameport_open(gameport, drv, GAMEPORT_MODE_COOKED)) {\r\nprintk(KERN_INFO "joydump: | Cooked not available either. Failing. |\n");\r\nprintk(KERN_INFO "joydump: `------------------- END -----------------'\n");\r\nreturn -ENODEV;\r\n}\r\ngameport_cooked_read(gameport, axes, &buttons);\r\nfor (i = 0; i < 4; i++)\r\nprintk(KERN_INFO "joydump: | Axis %d: %4d. |\n", i, axes[i]);\r\nprintk(KERN_INFO "joydump: | Buttons %02x. |\n", buttons);\r\nprintk(KERN_INFO "joydump: `------------------- END -----------------'\n");\r\n}\r\ntimeout = gameport_time(gameport, 10000);\r\nbuf = kmalloc(BUF_SIZE * sizeof(struct joydump), GFP_KERNEL);\r\nif (!buf) {\r\nprintk(KERN_INFO "joydump: no memory for testing\n");\r\ngoto jd_end;\r\n}\r\ndump = buf;\r\nt = 0;\r\ni = 1;\r\nlocal_irq_save(flags);\r\nu = gameport_read(gameport);\r\ndump->data = u;\r\ndump->time = t;\r\ndump++;\r\ngameport_trigger(gameport);\r\nwhile (i < BUF_SIZE && t < timeout) {\r\ndump->data = gameport_read(gameport);\r\nif (dump->data ^ u) {\r\nu = dump->data;\r\ndump->time = t;\r\ni++;\r\ndump++;\r\n}\r\nt++;\r\n}\r\nlocal_irq_restore(flags);\r\nt = i;\r\ndump = buf;\r\nprev = dump;\r\nprintk(KERN_INFO "joydump: >------------------ DATA -----------------<\n");\r\nprintk(KERN_INFO "joydump: | index: %3d delta: %3d us data: ", 0, 0);\r\nfor (j = 7; j >= 0; j--)\r\nprintk("%d", (dump->data >> j) & 1);\r\nprintk(" |\n");\r\ndump++;\r\nfor (i = 1; i < t; i++, dump++, prev++) {\r\nprintk(KERN_INFO "joydump: | index: %3d delta: %3d us data: ",\r\ni, dump->time - prev->time);\r\nfor (j = 7; j >= 0; j--)\r\nprintk("%d", (dump->data >> j) & 1);\r\nprintk(" |\n");\r\n}\r\nkfree(buf);\r\njd_end:\r\nprintk(KERN_INFO "joydump: `------------------- END -----------------'\n");\r\nreturn 0;\r\n}\r\nstatic void joydump_disconnect(struct gameport *gameport)\r\n{\r\ngameport_close(gameport);\r\n}

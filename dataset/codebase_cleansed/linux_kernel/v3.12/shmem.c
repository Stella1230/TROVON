void memcpy_toshmem(int card, void *dest, const void *src, size_t n)\r\n{\r\nunsigned long flags;\r\nunsigned char ch;\r\nunsigned long dest_rem = ((unsigned long) dest) % 0x4000;\r\nif (!IS_VALID_CARD(card)) {\r\npr_debug("Invalid param: %d is not a valid card id\n", card);\r\nreturn;\r\n}\r\nif (n > SRAM_PAGESIZE)\r\nreturn;\r\nch = (unsigned long) dest / SRAM_PAGESIZE;\r\npr_debug("%s: loaded page %d\n", sc_adapter[card]->devicename, ch);\r\nspin_lock_irqsave(&sc_adapter[card]->lock, flags);\r\noutb(((sc_adapter[card]->shmem_magic + ch * SRAM_PAGESIZE) >> 14) | 0x80,\r\nsc_adapter[card]->ioport[sc_adapter[card]->shmem_pgport]);\r\nmemcpy_toio((void __iomem *)(sc_adapter[card]->rambase + dest_rem), src, n);\r\nspin_unlock_irqrestore(&sc_adapter[card]->lock, flags);\r\npr_debug("%s: set page to %#x\n", sc_adapter[card]->devicename,\r\n((sc_adapter[card]->shmem_magic + ch * SRAM_PAGESIZE) >> 14) | 0x80);\r\npr_debug("%s: copying %zu bytes from %#lx to %#lx\n",\r\nsc_adapter[card]->devicename, n,\r\n(unsigned long) src,\r\nsc_adapter[card]->rambase + ((unsigned long) dest % 0x4000));\r\n}\r\nvoid memcpy_fromshmem(int card, void *dest, const void *src, size_t n)\r\n{\r\nunsigned long flags;\r\nunsigned char ch;\r\nif (!IS_VALID_CARD(card)) {\r\npr_debug("Invalid param: %d is not a valid card id\n", card);\r\nreturn;\r\n}\r\nif (n > SRAM_PAGESIZE) {\r\nreturn;\r\n}\r\nch = (unsigned long) src / SRAM_PAGESIZE;\r\npr_debug("%s: loaded page %d\n", sc_adapter[card]->devicename, ch);\r\nspin_lock_irqsave(&sc_adapter[card]->lock, flags);\r\noutb(((sc_adapter[card]->shmem_magic + ch * SRAM_PAGESIZE) >> 14) | 0x80,\r\nsc_adapter[card]->ioport[sc_adapter[card]->shmem_pgport]);\r\nmemcpy_fromio(dest, (void *)(sc_adapter[card]->rambase +\r\n((unsigned long) src % 0x4000)), n);\r\nspin_unlock_irqrestore(&sc_adapter[card]->lock, flags);\r\npr_debug("%s: set page to %#x\n", sc_adapter[card]->devicename,\r\n((sc_adapter[card]->shmem_magic + ch * SRAM_PAGESIZE) >> 14) | 0x80);\r\n}

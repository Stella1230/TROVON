static int lpc_sch_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *id)\r\n{\r\nunsigned int base_addr_cfg;\r\nunsigned short base_addr;\r\nint i, cells = 0;\r\nint ret;\r\npci_read_config_dword(dev, SMBASE, &base_addr_cfg);\r\nbase_addr = 0;\r\nif (!(base_addr_cfg & (1 << 31)))\r\ndev_warn(&dev->dev, "Decode of the SMBus I/O range disabled\n");\r\nelse\r\nbase_addr = (unsigned short)base_addr_cfg;\r\nif (base_addr == 0) {\r\ndev_warn(&dev->dev, "I/O space for SMBus uninitialized\n");\r\n} else {\r\nlpc_sch_cells[cells++] = isch_smbus_cell;\r\nsmbus_sch_resource.start = base_addr;\r\nsmbus_sch_resource.end = base_addr + SMBUS_IO_SIZE - 1;\r\n}\r\npci_read_config_dword(dev, GPIOBASE, &base_addr_cfg);\r\nbase_addr = 0;\r\nif (!(base_addr_cfg & (1 << 31)))\r\ndev_warn(&dev->dev, "Decode of the GPIO I/O range disabled\n");\r\nelse\r\nbase_addr = (unsigned short)base_addr_cfg;\r\nif (base_addr == 0) {\r\ndev_warn(&dev->dev, "I/O space for GPIO uninitialized\n");\r\n} else {\r\nlpc_sch_cells[cells++] = sch_gpio_cell;\r\ngpio_sch_resource.start = base_addr;\r\nif (id->device == PCI_DEVICE_ID_INTEL_CENTERTON_ILB)\r\ngpio_sch_resource.end = base_addr + GPIO_IO_SIZE_CENTERTON - 1;\r\nelse\r\ngpio_sch_resource.end = base_addr + GPIO_IO_SIZE - 1;\r\n}\r\nif (id->device == PCI_DEVICE_ID_INTEL_ITC_LPC\r\n|| id->device == PCI_DEVICE_ID_INTEL_CENTERTON_ILB) {\r\npci_read_config_dword(dev, WDTBASE, &base_addr_cfg);\r\nbase_addr = 0;\r\nif (!(base_addr_cfg & (1 << 31)))\r\ndev_warn(&dev->dev, "Decode of the WDT I/O range disabled\n");\r\nelse\r\nbase_addr = (unsigned short)base_addr_cfg;\r\nif (base_addr == 0)\r\ndev_warn(&dev->dev, "I/O space for WDT uninitialized\n");\r\nelse {\r\nlpc_sch_cells[cells++] = wdt_sch_cell;\r\nwdt_sch_resource.start = base_addr;\r\nwdt_sch_resource.end = base_addr + WDT_IO_SIZE - 1;\r\n}\r\n}\r\nif (WARN_ON(cells > ARRAY_SIZE(lpc_sch_cells))) {\r\ndev_err(&dev->dev, "Cell count exceeds array size");\r\nreturn -ENODEV;\r\n}\r\nif (cells == 0) {\r\ndev_err(&dev->dev, "All decode registers disabled.\n");\r\nreturn -ENODEV;\r\n}\r\nfor (i = 0; i < cells; i++)\r\nlpc_sch_cells[i].id = id->device;\r\nret = mfd_add_devices(&dev->dev, 0, lpc_sch_cells, cells, NULL, 0, NULL);\r\nif (ret)\r\nmfd_remove_devices(&dev->dev);\r\nreturn ret;\r\n}\r\nstatic void lpc_sch_remove(struct pci_dev *dev)\r\n{\r\nmfd_remove_devices(&dev->dev);\r\n}

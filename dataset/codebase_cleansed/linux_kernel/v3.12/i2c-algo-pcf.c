static void i2c_start(struct i2c_algo_pcf_data *adap)\r\n{\r\nDEBPROTO(printk(KERN_DEBUG "S "));\r\nset_pcf(adap, 1, I2C_PCF_START);\r\n}\r\nstatic void i2c_repstart(struct i2c_algo_pcf_data *adap)\r\n{\r\nDEBPROTO(printk(" Sr "));\r\nset_pcf(adap, 1, I2C_PCF_REPSTART);\r\n}\r\nstatic void i2c_stop(struct i2c_algo_pcf_data *adap)\r\n{\r\nDEBPROTO(printk("P\n"));\r\nset_pcf(adap, 1, I2C_PCF_STOP);\r\n}\r\nstatic void handle_lab(struct i2c_algo_pcf_data *adap, const int *status)\r\n{\r\nDEB2(printk(KERN_INFO\r\n"i2c-algo-pcf.o: lost arbitration (CSR 0x%02x)\n",\r\n*status));\r\nset_pcf(adap, 1, I2C_PCF_PIN);\r\nset_pcf(adap, 1, I2C_PCF_ESO);\r\nif (adap->lab_mdelay)\r\nmdelay(adap->lab_mdelay);\r\nDEB2(printk(KERN_INFO\r\n"i2c-algo-pcf.o: reset LAB condition (CSR 0x%02x)\n",\r\nget_pcf(adap, 1)));\r\n}\r\nstatic int wait_for_bb(struct i2c_algo_pcf_data *adap)\r\n{\r\nint timeout = DEF_TIMEOUT;\r\nint status;\r\nstatus = get_pcf(adap, 1);\r\nwhile (!(status & I2C_PCF_BB) && --timeout) {\r\nudelay(100);\r\nstatus = get_pcf(adap, 1);\r\n}\r\nif (timeout == 0) {\r\nprintk(KERN_ERR "Timeout waiting for Bus Busy\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nreturn 0;\r\n}\r\nstatic int wait_for_pin(struct i2c_algo_pcf_data *adap, int *status)\r\n{\r\nint timeout = DEF_TIMEOUT;\r\n*status = get_pcf(adap, 1);\r\nwhile ((*status & I2C_PCF_PIN) && --timeout) {\r\nadap->waitforpin(adap->data);\r\n*status = get_pcf(adap, 1);\r\n}\r\nif (*status & I2C_PCF_LAB) {\r\nhandle_lab(adap, status);\r\nreturn -EINTR;\r\n}\r\nif (timeout == 0)\r\nreturn -ETIMEDOUT;\r\nreturn 0;\r\n}\r\nstatic int pcf_init_8584 (struct i2c_algo_pcf_data *adap)\r\n{\r\nunsigned char temp;\r\nDEB3(printk(KERN_DEBUG "i2c-algo-pcf.o: PCF state 0x%02x\n",\r\nget_pcf(adap, 1)));\r\nset_pcf(adap, 1, I2C_PCF_PIN);\r\nif (((temp = get_pcf(adap, 1)) & 0x7f) != (0)) {\r\nDEB2(printk(KERN_ERR "i2c-algo-pcf.o: PCF detection failed -- can't select S0 (0x%02x).\n", temp));\r\nreturn -ENXIO;\r\n}\r\ni2c_outb(adap, get_own(adap));\r\nif ((temp = i2c_inb(adap)) != get_own(adap)) {\r\nDEB2(printk(KERN_ERR "i2c-algo-pcf.o: PCF detection failed -- can't set S0 (0x%02x).\n", temp));\r\nreturn -ENXIO;\r\n}\r\nset_pcf(adap, 1, I2C_PCF_PIN | I2C_PCF_ES1);\r\nif (((temp = get_pcf(adap, 1)) & 0x7f) != I2C_PCF_ES1) {\r\nDEB2(printk(KERN_ERR "i2c-algo-pcf.o: PCF detection failed -- can't select S2 (0x%02x).\n", temp));\r\nreturn -ENXIO;\r\n}\r\ni2c_outb(adap, get_clock(adap));\r\nif (((temp = i2c_inb(adap)) & 0x1f) != get_clock(adap)) {\r\nDEB2(printk(KERN_ERR "i2c-algo-pcf.o: PCF detection failed -- can't set S2 (0x%02x).\n", temp));\r\nreturn -ENXIO;\r\n}\r\nset_pcf(adap, 1, I2C_PCF_IDLE);\r\nif ((temp = get_pcf(adap, 1)) != (I2C_PCF_PIN | I2C_PCF_BB)) {\r\nDEB2(printk(KERN_ERR "i2c-algo-pcf.o: PCF detection failed -- can't select S1` (0x%02x).\n", temp));\r\nreturn -ENXIO;\r\n}\r\nprintk(KERN_DEBUG "i2c-algo-pcf.o: detected and initialized PCF8584.\n");\r\nreturn 0;\r\n}\r\nstatic int pcf_sendbytes(struct i2c_adapter *i2c_adap, const char *buf,\r\nint count, int last)\r\n{\r\nstruct i2c_algo_pcf_data *adap = i2c_adap->algo_data;\r\nint wrcount, status, timeout;\r\nfor (wrcount=0; wrcount<count; ++wrcount) {\r\nDEB2(dev_dbg(&i2c_adap->dev, "i2c_write: writing %2.2X\n",\r\nbuf[wrcount] & 0xff));\r\ni2c_outb(adap, buf[wrcount]);\r\ntimeout = wait_for_pin(adap, &status);\r\nif (timeout) {\r\nif (timeout == -EINTR)\r\nreturn -EINTR;\r\ni2c_stop(adap);\r\ndev_err(&i2c_adap->dev, "i2c_write: error - timeout.\n");\r\nreturn -EREMOTEIO;\r\n}\r\nif (status & I2C_PCF_LRB) {\r\ni2c_stop(adap);\r\ndev_err(&i2c_adap->dev, "i2c_write: error - no ack.\n");\r\nreturn -EREMOTEIO;\r\n}\r\n}\r\nif (last)\r\ni2c_stop(adap);\r\nelse\r\ni2c_repstart(adap);\r\nreturn wrcount;\r\n}\r\nstatic int pcf_readbytes(struct i2c_adapter *i2c_adap, char *buf,\r\nint count, int last)\r\n{\r\nint i, status;\r\nstruct i2c_algo_pcf_data *adap = i2c_adap->algo_data;\r\nint wfp;\r\nfor (i = 0; i <= count; i++) {\r\nif ((wfp = wait_for_pin(adap, &status))) {\r\nif (wfp == -EINTR)\r\nreturn -EINTR;\r\ni2c_stop(adap);\r\ndev_err(&i2c_adap->dev, "pcf_readbytes timed out.\n");\r\nreturn -1;\r\n}\r\nif ((status & I2C_PCF_LRB) && (i != count)) {\r\ni2c_stop(adap);\r\ndev_err(&i2c_adap->dev, "i2c_read: i2c_inb, No ack.\n");\r\nreturn -1;\r\n}\r\nif (i == count - 1) {\r\nset_pcf(adap, 1, I2C_PCF_ESO);\r\n} else if (i == count) {\r\nif (last)\r\ni2c_stop(adap);\r\nelse\r\ni2c_repstart(adap);\r\n}\r\nif (i)\r\nbuf[i - 1] = i2c_inb(adap);\r\nelse\r\ni2c_inb(adap);\r\n}\r\nreturn i - 1;\r\n}\r\nstatic int pcf_doAddress(struct i2c_algo_pcf_data *adap,\r\nstruct i2c_msg *msg)\r\n{\r\nunsigned short flags = msg->flags;\r\nunsigned char addr;\r\naddr = msg->addr << 1;\r\nif (flags & I2C_M_RD)\r\naddr |= 1;\r\nif (flags & I2C_M_REV_DIR_ADDR)\r\naddr ^= 1;\r\ni2c_outb(adap, addr);\r\nreturn 0;\r\n}\r\nstatic int pcf_xfer(struct i2c_adapter *i2c_adap,\r\nstruct i2c_msg *msgs,\r\nint num)\r\n{\r\nstruct i2c_algo_pcf_data *adap = i2c_adap->algo_data;\r\nstruct i2c_msg *pmsg;\r\nint i;\r\nint ret=0, timeout, status;\r\nif (adap->xfer_begin)\r\nadap->xfer_begin(adap->data);\r\ntimeout = wait_for_bb(adap);\r\nif (timeout) {\r\nDEB2(printk(KERN_ERR "i2c-algo-pcf.o: "\r\n"Timeout waiting for BB in pcf_xfer\n");)\r\ni = -EIO;\r\ngoto out;\r\n}\r\nfor (i = 0;ret >= 0 && i < num; i++) {\r\npmsg = &msgs[i];\r\nDEB2(printk(KERN_DEBUG "i2c-algo-pcf.o: Doing %s %d bytes to 0x%02x - %d of %d messages\n",\r\npmsg->flags & I2C_M_RD ? "read" : "write",\r\npmsg->len, pmsg->addr, i + 1, num);)\r\nret = pcf_doAddress(adap, pmsg);\r\nif (i == 0)\r\ni2c_start(adap);\r\ntimeout = wait_for_pin(adap, &status);\r\nif (timeout) {\r\nif (timeout == -EINTR) {\r\ni = -EINTR;\r\ngoto out;\r\n}\r\ni2c_stop(adap);\r\nDEB2(printk(KERN_ERR "i2c-algo-pcf.o: Timeout waiting "\r\n"for PIN(1) in pcf_xfer\n");)\r\ni = -EREMOTEIO;\r\ngoto out;\r\n}\r\nif (status & I2C_PCF_LRB) {\r\ni2c_stop(adap);\r\nDEB2(printk(KERN_ERR "i2c-algo-pcf.o: No LRB(1) in pcf_xfer\n");)\r\ni = -EREMOTEIO;\r\ngoto out;\r\n}\r\nDEB3(printk(KERN_DEBUG "i2c-algo-pcf.o: Msg %d, addr=0x%x, flags=0x%x, len=%d\n",\r\ni, msgs[i].addr, msgs[i].flags, msgs[i].len);)\r\nif (pmsg->flags & I2C_M_RD) {\r\nret = pcf_readbytes(i2c_adap, pmsg->buf, pmsg->len,\r\n(i + 1 == num));\r\nif (ret != pmsg->len) {\r\nDEB2(printk(KERN_DEBUG "i2c-algo-pcf.o: fail: "\r\n"only read %d bytes.\n",ret));\r\n} else {\r\nDEB2(printk(KERN_DEBUG "i2c-algo-pcf.o: read %d bytes.\n",ret));\r\n}\r\n} else {\r\nret = pcf_sendbytes(i2c_adap, pmsg->buf, pmsg->len,\r\n(i + 1 == num));\r\nif (ret != pmsg->len) {\r\nDEB2(printk(KERN_DEBUG "i2c-algo-pcf.o: fail: "\r\n"only wrote %d bytes.\n",ret));\r\n} else {\r\nDEB2(printk(KERN_DEBUG "i2c-algo-pcf.o: wrote %d bytes.\n",ret));\r\n}\r\n}\r\n}\r\nout:\r\nif (adap->xfer_end)\r\nadap->xfer_end(adap->data);\r\nreturn i;\r\n}\r\nstatic u32 pcf_func(struct i2c_adapter *adap)\r\n{\r\nreturn I2C_FUNC_I2C | I2C_FUNC_SMBUS_EMUL |\r\nI2C_FUNC_PROTOCOL_MANGLING;\r\n}\r\nint i2c_pcf_add_bus(struct i2c_adapter *adap)\r\n{\r\nstruct i2c_algo_pcf_data *pcf_adap = adap->algo_data;\r\nint rval;\r\nDEB2(dev_dbg(&adap->dev, "hw routines registered.\n"));\r\nadap->algo = &pcf_algo;\r\nif ((rval = pcf_init_8584(pcf_adap)))\r\nreturn rval;\r\nrval = i2c_add_adapter(adap);\r\nreturn rval;\r\n}

static void ar9003_hw_setup_calibration(struct ath_hw *ah,\r\nstruct ath9k_cal_list *currCal)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nswitch (currCal->calData->calType) {\r\ncase IQ_MISMATCH_CAL:\r\nREG_RMW_FIELD(ah, AR_PHY_TIMING4,\r\nAR_PHY_TIMING4_IQCAL_LOG_COUNT_MAX,\r\ncurrCal->calData->calCountMax);\r\nREG_WRITE(ah, AR_PHY_CALMODE, AR_PHY_CALMODE_IQ);\r\nath_dbg(common, CALIBRATE,\r\n"starting IQ Mismatch Calibration\n");\r\nREG_SET_BIT(ah, AR_PHY_TIMING4, AR_PHY_TIMING4_DO_CAL);\r\nbreak;\r\ndefault:\r\nath_err(common, "Invalid calibration type\n");\r\nbreak;\r\n}\r\n}\r\nstatic bool ar9003_hw_per_calibration(struct ath_hw *ah,\r\nstruct ath9k_channel *ichan,\r\nu8 rxchainmask,\r\nstruct ath9k_cal_list *currCal)\r\n{\r\nstruct ath9k_hw_cal_data *caldata = ah->caldata;\r\nbool iscaldone = false;\r\nif (currCal->calState == CAL_RUNNING) {\r\nif (!(REG_READ(ah, AR_PHY_TIMING4) & AR_PHY_TIMING4_DO_CAL)) {\r\ncurrCal->calData->calCollect(ah);\r\nah->cal_samples++;\r\nif (ah->cal_samples >=\r\ncurrCal->calData->calNumSamples) {\r\nunsigned int i, numChains = 0;\r\nfor (i = 0; i < AR9300_MAX_CHAINS; i++) {\r\nif (rxchainmask & (1 << i))\r\nnumChains++;\r\n}\r\ncurrCal->calData->calPostProc(ah, numChains);\r\ncaldata->CalValid |= currCal->calData->calType;\r\ncurrCal->calState = CAL_DONE;\r\niscaldone = true;\r\n} else {\r\nar9003_hw_setup_calibration(ah, currCal);\r\n}\r\n}\r\n} else if (!(caldata->CalValid & currCal->calData->calType)) {\r\nath9k_hw_reset_calibration(ah, currCal);\r\n}\r\nreturn iscaldone;\r\n}\r\nstatic bool ar9003_hw_calibrate(struct ath_hw *ah,\r\nstruct ath9k_channel *chan,\r\nu8 rxchainmask,\r\nbool longcal)\r\n{\r\nbool iscaldone = true;\r\nstruct ath9k_cal_list *currCal = ah->cal_list_curr;\r\nif (currCal &&\r\n(currCal->calState == CAL_RUNNING ||\r\ncurrCal->calState == CAL_WAITING)) {\r\niscaldone = ar9003_hw_per_calibration(ah, chan,\r\nrxchainmask, currCal);\r\nif (iscaldone) {\r\nah->cal_list_curr = currCal = currCal->calNext;\r\nif (currCal->calState == CAL_WAITING) {\r\niscaldone = false;\r\nath9k_hw_reset_calibration(ah, currCal);\r\n}\r\n}\r\n}\r\nif (longcal && ath9k_hw_getnf(ah, chan)) {\r\nath9k_hw_loadnf(ah, ah->curchan);\r\nath9k_hw_start_nfcal(ah, false);\r\n}\r\nreturn iscaldone;\r\n}\r\nstatic void ar9003_hw_iqcal_collect(struct ath_hw *ah)\r\n{\r\nint i;\r\nfor (i = 0; i < AR5416_MAX_CHAINS; i++) {\r\nif (ah->txchainmask & BIT(i)) {\r\nah->totalPowerMeasI[i] +=\r\nREG_READ(ah, AR_PHY_CAL_MEAS_0(i));\r\nah->totalPowerMeasQ[i] +=\r\nREG_READ(ah, AR_PHY_CAL_MEAS_1(i));\r\nah->totalIqCorrMeas[i] +=\r\n(int32_t) REG_READ(ah, AR_PHY_CAL_MEAS_2(i));\r\nath_dbg(ath9k_hw_common(ah), CALIBRATE,\r\n"%d: Chn %d pmi=0x%08x;pmq=0x%08x;iqcm=0x%08x;\n",\r\nah->cal_samples, i, ah->totalPowerMeasI[i],\r\nah->totalPowerMeasQ[i],\r\nah->totalIqCorrMeas[i]);\r\n}\r\n}\r\n}\r\nstatic void ar9003_hw_iqcalibrate(struct ath_hw *ah, u8 numChains)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nu32 powerMeasQ, powerMeasI, iqCorrMeas;\r\nu32 qCoffDenom, iCoffDenom;\r\nint32_t qCoff, iCoff;\r\nint iqCorrNeg, i;\r\nstatic const u_int32_t offset_array[3] = {\r\nAR_PHY_RX_IQCAL_CORR_B0,\r\nAR_PHY_RX_IQCAL_CORR_B1,\r\nAR_PHY_RX_IQCAL_CORR_B2,\r\n};\r\nfor (i = 0; i < numChains; i++) {\r\npowerMeasI = ah->totalPowerMeasI[i];\r\npowerMeasQ = ah->totalPowerMeasQ[i];\r\niqCorrMeas = ah->totalIqCorrMeas[i];\r\nath_dbg(common, CALIBRATE,\r\n"Starting IQ Cal and Correction for Chain %d\n", i);\r\nath_dbg(common, CALIBRATE,\r\n"Original: Chn %d iq_corr_meas = 0x%08x\n",\r\ni, ah->totalIqCorrMeas[i]);\r\niqCorrNeg = 0;\r\nif (iqCorrMeas > 0x80000000) {\r\niqCorrMeas = (0xffffffff - iqCorrMeas) + 1;\r\niqCorrNeg = 1;\r\n}\r\nath_dbg(common, CALIBRATE, "Chn %d pwr_meas_i = 0x%08x\n",\r\ni, powerMeasI);\r\nath_dbg(common, CALIBRATE, "Chn %d pwr_meas_q = 0x%08x\n",\r\ni, powerMeasQ);\r\nath_dbg(common, CALIBRATE, "iqCorrNeg is 0x%08x\n", iqCorrNeg);\r\niCoffDenom = (powerMeasI / 2 + powerMeasQ / 2) / 256;\r\nqCoffDenom = powerMeasQ / 64;\r\nif ((iCoffDenom != 0) && (qCoffDenom != 0)) {\r\niCoff = iqCorrMeas / iCoffDenom;\r\nqCoff = powerMeasI / qCoffDenom - 64;\r\nath_dbg(common, CALIBRATE, "Chn %d iCoff = 0x%08x\n",\r\ni, iCoff);\r\nath_dbg(common, CALIBRATE, "Chn %d qCoff = 0x%08x\n",\r\ni, qCoff);\r\nif (iCoff >= 63)\r\niCoff = 63;\r\nelse if (iCoff <= -63)\r\niCoff = -63;\r\nif (iqCorrNeg == 0x0)\r\niCoff = -iCoff;\r\nif (qCoff >= 63)\r\nqCoff = 63;\r\nelse if (qCoff <= -63)\r\nqCoff = -63;\r\niCoff = iCoff & 0x7f;\r\nqCoff = qCoff & 0x7f;\r\nath_dbg(common, CALIBRATE,\r\n"Chn %d : iCoff = 0x%x qCoff = 0x%x\n",\r\ni, iCoff, qCoff);\r\nath_dbg(common, CALIBRATE,\r\n"Register offset (0x%04x) before update = 0x%x\n",\r\noffset_array[i],\r\nREG_READ(ah, offset_array[i]));\r\nif (AR_SREV_9565(ah) &&\r\n(iCoff == 63 || qCoff == 63 ||\r\niCoff == -63 || qCoff == -63))\r\nreturn;\r\nREG_RMW_FIELD(ah, offset_array[i],\r\nAR_PHY_RX_IQCAL_CORR_IQCORR_Q_I_COFF,\r\niCoff);\r\nREG_RMW_FIELD(ah, offset_array[i],\r\nAR_PHY_RX_IQCAL_CORR_IQCORR_Q_Q_COFF,\r\nqCoff);\r\nath_dbg(common, CALIBRATE,\r\n"Register offset (0x%04x) QI COFF (bitfields 0x%08x) after update = 0x%x\n",\r\noffset_array[i],\r\nAR_PHY_RX_IQCAL_CORR_IQCORR_Q_I_COFF,\r\nREG_READ(ah, offset_array[i]));\r\nath_dbg(common, CALIBRATE,\r\n"Register offset (0x%04x) QQ COFF (bitfields 0x%08x) after update = 0x%x\n",\r\noffset_array[i],\r\nAR_PHY_RX_IQCAL_CORR_IQCORR_Q_Q_COFF,\r\nREG_READ(ah, offset_array[i]));\r\nath_dbg(common, CALIBRATE,\r\n"IQ Cal and Correction done for Chain %d\n", i);\r\n}\r\n}\r\nREG_SET_BIT(ah, AR_PHY_RX_IQCAL_CORR_B0,\r\nAR_PHY_RX_IQCAL_CORR_IQCORR_ENABLE);\r\nath_dbg(common, CALIBRATE,\r\n"IQ Cal and Correction (offset 0x%04x) enabled (bit position 0x%08x). New Value 0x%08x\n",\r\n(unsigned) (AR_PHY_RX_IQCAL_CORR_B0),\r\nAR_PHY_RX_IQCAL_CORR_IQCORR_ENABLE,\r\nREG_READ(ah, AR_PHY_RX_IQCAL_CORR_B0));\r\n}\r\nstatic void ar9003_hw_init_cal_settings(struct ath_hw *ah)\r\n{\r\nah->iq_caldata.calData = &iq_cal_single_sample;\r\nif (AR_SREV_9300_20_OR_LATER(ah)) {\r\nah->enabled_cals |= TX_IQ_CAL;\r\nif (AR_SREV_9485_OR_LATER(ah) && !AR_SREV_9340(ah))\r\nah->enabled_cals |= TX_IQ_ON_AGC_CAL;\r\n}\r\nah->supp_cals = IQ_MISMATCH_CAL;\r\n}\r\nstatic bool ar9003_hw_solve_iq_cal(struct ath_hw *ah,\r\ns32 sin_2phi_1,\r\ns32 cos_2phi_1,\r\ns32 sin_2phi_2,\r\ns32 cos_2phi_2,\r\ns32 mag_a0_d0,\r\ns32 phs_a0_d0,\r\ns32 mag_a1_d0,\r\ns32 phs_a1_d0,\r\ns32 solved_eq[])\r\n{\r\ns32 f1 = cos_2phi_1 - cos_2phi_2,\r\nf3 = sin_2phi_1 - sin_2phi_2,\r\nf2;\r\ns32 mag_tx, phs_tx, mag_rx, phs_rx;\r\nconst s32 result_shift = 1 << 15;\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nf2 = (f1 * f1 + f3 * f3) / result_shift;\r\nif (!f2) {\r\nath_dbg(common, CALIBRATE, "Divide by 0\n");\r\nreturn false;\r\n}\r\nmag_tx = f1 * (mag_a0_d0 - mag_a1_d0) + f3 * (phs_a0_d0 - phs_a1_d0);\r\nphs_tx = f3 * (-mag_a0_d0 + mag_a1_d0) + f1 * (phs_a0_d0 - phs_a1_d0);\r\nmag_tx = (mag_tx / f2);\r\nphs_tx = (phs_tx / f2);\r\nmag_rx = mag_a0_d0 - (cos_2phi_1 * mag_tx + sin_2phi_1 * phs_tx) /\r\nresult_shift;\r\nphs_rx = phs_a0_d0 + (sin_2phi_1 * mag_tx - cos_2phi_1 * phs_tx) /\r\nresult_shift;\r\nsolved_eq[0] = mag_tx;\r\nsolved_eq[1] = phs_tx;\r\nsolved_eq[2] = mag_rx;\r\nsolved_eq[3] = phs_rx;\r\nreturn true;\r\n}\r\nstatic s32 ar9003_hw_find_mag_approx(struct ath_hw *ah, s32 in_re, s32 in_im)\r\n{\r\ns32 abs_i = abs(in_re),\r\nabs_q = abs(in_im),\r\nmax_abs, min_abs;\r\nif (abs_i > abs_q) {\r\nmax_abs = abs_i;\r\nmin_abs = abs_q;\r\n} else {\r\nmax_abs = abs_q;\r\nmin_abs = abs_i;\r\n}\r\nreturn max_abs - (max_abs / 32) + (min_abs / 8) + (min_abs / 4);\r\n}\r\nstatic bool ar9003_hw_calc_iq_corr(struct ath_hw *ah,\r\ns32 chain_idx,\r\nconst s32 iq_res[],\r\ns32 iqc_coeff[])\r\n{\r\ns32 i2_m_q2_a0_d0, i2_p_q2_a0_d0, iq_corr_a0_d0,\r\ni2_m_q2_a0_d1, i2_p_q2_a0_d1, iq_corr_a0_d1,\r\ni2_m_q2_a1_d0, i2_p_q2_a1_d0, iq_corr_a1_d0,\r\ni2_m_q2_a1_d1, i2_p_q2_a1_d1, iq_corr_a1_d1;\r\ns32 mag_a0_d0, mag_a1_d0, mag_a0_d1, mag_a1_d1,\r\nphs_a0_d0, phs_a1_d0, phs_a0_d1, phs_a1_d1,\r\nsin_2phi_1, cos_2phi_1,\r\nsin_2phi_2, cos_2phi_2;\r\ns32 mag_tx, phs_tx, mag_rx, phs_rx;\r\ns32 solved_eq[4], mag_corr_tx, phs_corr_tx, mag_corr_rx, phs_corr_rx,\r\nq_q_coff, q_i_coff;\r\nconst s32 res_scale = 1 << 15;\r\nconst s32 delpt_shift = 1 << 8;\r\ns32 mag1, mag2;\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\ni2_m_q2_a0_d0 = iq_res[0] & 0xfff;\r\ni2_p_q2_a0_d0 = (iq_res[0] >> 12) & 0xfff;\r\niq_corr_a0_d0 = ((iq_res[0] >> 24) & 0xff) + ((iq_res[1] & 0xf) << 8);\r\nif (i2_m_q2_a0_d0 > 0x800)\r\ni2_m_q2_a0_d0 = -((0xfff - i2_m_q2_a0_d0) + 1);\r\nif (i2_p_q2_a0_d0 > 0x800)\r\ni2_p_q2_a0_d0 = -((0xfff - i2_p_q2_a0_d0) + 1);\r\nif (iq_corr_a0_d0 > 0x800)\r\niq_corr_a0_d0 = -((0xfff - iq_corr_a0_d0) + 1);\r\ni2_m_q2_a0_d1 = (iq_res[1] >> 4) & 0xfff;\r\ni2_p_q2_a0_d1 = (iq_res[2] & 0xfff);\r\niq_corr_a0_d1 = (iq_res[2] >> 12) & 0xfff;\r\nif (i2_m_q2_a0_d1 > 0x800)\r\ni2_m_q2_a0_d1 = -((0xfff - i2_m_q2_a0_d1) + 1);\r\nif (i2_p_q2_a0_d1 > 0x800)\r\ni2_p_q2_a0_d1 = -((0xfff - i2_p_q2_a0_d1) + 1);\r\nif (iq_corr_a0_d1 > 0x800)\r\niq_corr_a0_d1 = -((0xfff - iq_corr_a0_d1) + 1);\r\ni2_m_q2_a1_d0 = ((iq_res[2] >> 24) & 0xff) + ((iq_res[3] & 0xf) << 8);\r\ni2_p_q2_a1_d0 = (iq_res[3] >> 4) & 0xfff;\r\niq_corr_a1_d0 = iq_res[4] & 0xfff;\r\nif (i2_m_q2_a1_d0 > 0x800)\r\ni2_m_q2_a1_d0 = -((0xfff - i2_m_q2_a1_d0) + 1);\r\nif (i2_p_q2_a1_d0 > 0x800)\r\ni2_p_q2_a1_d0 = -((0xfff - i2_p_q2_a1_d0) + 1);\r\nif (iq_corr_a1_d0 > 0x800)\r\niq_corr_a1_d0 = -((0xfff - iq_corr_a1_d0) + 1);\r\ni2_m_q2_a1_d1 = (iq_res[4] >> 12) & 0xfff;\r\ni2_p_q2_a1_d1 = ((iq_res[4] >> 24) & 0xff) + ((iq_res[5] & 0xf) << 8);\r\niq_corr_a1_d1 = (iq_res[5] >> 4) & 0xfff;\r\nif (i2_m_q2_a1_d1 > 0x800)\r\ni2_m_q2_a1_d1 = -((0xfff - i2_m_q2_a1_d1) + 1);\r\nif (i2_p_q2_a1_d1 > 0x800)\r\ni2_p_q2_a1_d1 = -((0xfff - i2_p_q2_a1_d1) + 1);\r\nif (iq_corr_a1_d1 > 0x800)\r\niq_corr_a1_d1 = -((0xfff - iq_corr_a1_d1) + 1);\r\nif ((i2_p_q2_a0_d0 == 0) || (i2_p_q2_a0_d1 == 0) ||\r\n(i2_p_q2_a1_d0 == 0) || (i2_p_q2_a1_d1 == 0)) {\r\nath_dbg(common, CALIBRATE,\r\n"Divide by 0:\n"\r\n"a0_d0=%d\n"\r\n"a0_d1=%d\n"\r\n"a2_d0=%d\n"\r\n"a1_d1=%d\n",\r\ni2_p_q2_a0_d0, i2_p_q2_a0_d1,\r\ni2_p_q2_a1_d0, i2_p_q2_a1_d1);\r\nreturn false;\r\n}\r\nmag_a0_d0 = (i2_m_q2_a0_d0 * res_scale) / i2_p_q2_a0_d0;\r\nphs_a0_d0 = (iq_corr_a0_d0 * res_scale) / i2_p_q2_a0_d0;\r\nmag_a0_d1 = (i2_m_q2_a0_d1 * res_scale) / i2_p_q2_a0_d1;\r\nphs_a0_d1 = (iq_corr_a0_d1 * res_scale) / i2_p_q2_a0_d1;\r\nmag_a1_d0 = (i2_m_q2_a1_d0 * res_scale) / i2_p_q2_a1_d0;\r\nphs_a1_d0 = (iq_corr_a1_d0 * res_scale) / i2_p_q2_a1_d0;\r\nmag_a1_d1 = (i2_m_q2_a1_d1 * res_scale) / i2_p_q2_a1_d1;\r\nphs_a1_d1 = (iq_corr_a1_d1 * res_scale) / i2_p_q2_a1_d1;\r\nsin_2phi_1 = (((mag_a0_d0 - mag_a0_d1) * delpt_shift) / DELPT);\r\ncos_2phi_1 = (((phs_a0_d1 - phs_a0_d0) * delpt_shift) / DELPT);\r\nsin_2phi_2 = (((mag_a1_d0 - mag_a1_d1) * delpt_shift) / DELPT);\r\ncos_2phi_2 = (((phs_a1_d1 - phs_a1_d0) * delpt_shift) / DELPT);\r\nmag1 = ar9003_hw_find_mag_approx(ah, cos_2phi_1, sin_2phi_1);\r\nmag2 = ar9003_hw_find_mag_approx(ah, cos_2phi_2, sin_2phi_2);\r\nif ((mag1 == 0) || (mag2 == 0)) {\r\nath_dbg(common, CALIBRATE, "Divide by 0: mag1=%d, mag2=%d\n",\r\nmag1, mag2);\r\nreturn false;\r\n}\r\nsin_2phi_1 = (sin_2phi_1 * res_scale / mag1);\r\ncos_2phi_1 = (cos_2phi_1 * res_scale / mag1);\r\nsin_2phi_2 = (sin_2phi_2 * res_scale / mag2);\r\ncos_2phi_2 = (cos_2phi_2 * res_scale / mag2);\r\nif (!ar9003_hw_solve_iq_cal(ah,\r\nsin_2phi_1, cos_2phi_1,\r\nsin_2phi_2, cos_2phi_2,\r\nmag_a0_d0, phs_a0_d0,\r\nmag_a1_d0,\r\nphs_a1_d0, solved_eq)) {\r\nath_dbg(common, CALIBRATE,\r\n"Call to ar9003_hw_solve_iq_cal() failed\n");\r\nreturn false;\r\n}\r\nmag_tx = solved_eq[0];\r\nphs_tx = solved_eq[1];\r\nmag_rx = solved_eq[2];\r\nphs_rx = solved_eq[3];\r\nath_dbg(common, CALIBRATE,\r\n"chain %d: mag mismatch=%d phase mismatch=%d\n",\r\nchain_idx, mag_tx/res_scale, phs_tx/res_scale);\r\nif (res_scale == mag_tx) {\r\nath_dbg(common, CALIBRATE,\r\n"Divide by 0: mag_tx=%d, res_scale=%d\n",\r\nmag_tx, res_scale);\r\nreturn false;\r\n}\r\nmag_corr_tx = (mag_tx * res_scale) / (res_scale - mag_tx);\r\nphs_corr_tx = -phs_tx;\r\nq_q_coff = (mag_corr_tx * 128 / res_scale);\r\nq_i_coff = (phs_corr_tx * 256 / res_scale);\r\nath_dbg(common, CALIBRATE, "tx chain %d: mag corr=%d phase corr=%d\n",\r\nchain_idx, q_q_coff, q_i_coff);\r\nif (q_i_coff < -63)\r\nq_i_coff = -63;\r\nif (q_i_coff > 63)\r\nq_i_coff = 63;\r\nif (q_q_coff < -63)\r\nq_q_coff = -63;\r\nif (q_q_coff > 63)\r\nq_q_coff = 63;\r\niqc_coeff[0] = (q_q_coff * 128) + q_i_coff;\r\nath_dbg(common, CALIBRATE, "tx chain %d: iq corr coeff=%x\n",\r\nchain_idx, iqc_coeff[0]);\r\nif (-mag_rx == res_scale) {\r\nath_dbg(common, CALIBRATE,\r\n"Divide by 0: mag_rx=%d, res_scale=%d\n",\r\nmag_rx, res_scale);\r\nreturn false;\r\n}\r\nmag_corr_rx = (-mag_rx * res_scale) / (res_scale + mag_rx);\r\nphs_corr_rx = -phs_rx;\r\nq_q_coff = (mag_corr_rx * 128 / res_scale);\r\nq_i_coff = (phs_corr_rx * 256 / res_scale);\r\nath_dbg(common, CALIBRATE, "rx chain %d: mag corr=%d phase corr=%d\n",\r\nchain_idx, q_q_coff, q_i_coff);\r\nif (q_i_coff < -63)\r\nq_i_coff = -63;\r\nif (q_i_coff > 63)\r\nq_i_coff = 63;\r\nif (q_q_coff < -63)\r\nq_q_coff = -63;\r\nif (q_q_coff > 63)\r\nq_q_coff = 63;\r\niqc_coeff[1] = (q_q_coff * 128) + q_i_coff;\r\nath_dbg(common, CALIBRATE, "rx chain %d: iq corr coeff=%x\n",\r\nchain_idx, iqc_coeff[1]);\r\nreturn true;\r\n}\r\nstatic void ar9003_hw_detect_outlier(int *mp_coeff, int nmeasurement,\r\nint max_delta)\r\n{\r\nint mp_max = -64, max_idx = 0;\r\nint mp_min = 63, min_idx = 0;\r\nint mp_avg = 0, i, outlier_idx = 0, mp_count = 0;\r\nfor (i = 0; i < nmeasurement; i++) {\r\nif (mp_coeff[i] > mp_max) {\r\nmp_max = mp_coeff[i];\r\nmax_idx = i;\r\n} else if (mp_coeff[i] < mp_min) {\r\nmp_min = mp_coeff[i];\r\nmin_idx = i;\r\n}\r\n}\r\nfor (i = 0; i < nmeasurement; i++) {\r\nif ((abs(mp_coeff[i]) < abs(mp_max)) ||\r\n(abs(mp_coeff[i]) < abs(mp_min))) {\r\nmp_avg += mp_coeff[i];\r\nmp_count++;\r\n}\r\n}\r\nif (mp_count)\r\nmp_avg /= mp_count;\r\nelse\r\nmp_avg = mp_coeff[nmeasurement - 1];\r\nif (abs(mp_max - mp_min) > max_delta) {\r\nif (abs(mp_max - mp_avg) > abs(mp_min - mp_avg))\r\noutlier_idx = max_idx;\r\nelse\r\noutlier_idx = min_idx;\r\nmp_coeff[outlier_idx] = mp_avg;\r\n}\r\n}\r\nstatic void ar9003_hw_tx_iqcal_load_avg_2_passes(struct ath_hw *ah,\r\nstruct coeff *coeff,\r\nbool is_reusable)\r\n{\r\nint i, im, nmeasurement;\r\nu32 tx_corr_coeff[MAX_MEASUREMENT][AR9300_MAX_CHAINS];\r\nstruct ath9k_hw_cal_data *caldata = ah->caldata;\r\nmemset(tx_corr_coeff, 0, sizeof(tx_corr_coeff));\r\nfor (i = 0; i < MAX_MEASUREMENT / 2; i++) {\r\ntx_corr_coeff[i * 2][0] = tx_corr_coeff[(i * 2) + 1][0] =\r\nAR_PHY_TX_IQCAL_CORR_COEFF_B0(i);\r\nif (!AR_SREV_9485(ah)) {\r\ntx_corr_coeff[i * 2][1] =\r\ntx_corr_coeff[(i * 2) + 1][1] =\r\nAR_PHY_TX_IQCAL_CORR_COEFF_B1(i);\r\ntx_corr_coeff[i * 2][2] =\r\ntx_corr_coeff[(i * 2) + 1][2] =\r\nAR_PHY_TX_IQCAL_CORR_COEFF_B2(i);\r\n}\r\n}\r\nfor (i = 0; i < AR9300_MAX_CHAINS; i++) {\r\nif (!(ah->txchainmask & (1 << i)))\r\ncontinue;\r\nnmeasurement = REG_READ_FIELD(ah,\r\nAR_PHY_TX_IQCAL_STATUS_B0,\r\nAR_PHY_CALIBRATED_GAINS_0);\r\nif (nmeasurement > MAX_MEASUREMENT)\r\nnmeasurement = MAX_MEASUREMENT;\r\nif (nmeasurement > 1) {\r\nar9003_hw_detect_outlier(coeff->mag_coeff[i],\r\nnmeasurement, MAX_MAG_DELTA);\r\nar9003_hw_detect_outlier(coeff->phs_coeff[i],\r\nnmeasurement, MAX_PHS_DELTA);\r\n}\r\nfor (im = 0; im < nmeasurement; im++) {\r\ncoeff->iqc_coeff[0] = (coeff->mag_coeff[i][im] & 0x7f) |\r\n((coeff->phs_coeff[i][im] & 0x7f) << 7);\r\nif ((im % 2) == 0)\r\nREG_RMW_FIELD(ah, tx_corr_coeff[im][i],\r\nAR_PHY_TX_IQCAL_CORR_COEFF_00_COEFF_TABLE,\r\ncoeff->iqc_coeff[0]);\r\nelse\r\nREG_RMW_FIELD(ah, tx_corr_coeff[im][i],\r\nAR_PHY_TX_IQCAL_CORR_COEFF_01_COEFF_TABLE,\r\ncoeff->iqc_coeff[0]);\r\nif (caldata)\r\ncaldata->tx_corr_coeff[im][i] =\r\ncoeff->iqc_coeff[0];\r\n}\r\nif (caldata)\r\ncaldata->num_measures[i] = nmeasurement;\r\n}\r\nREG_RMW_FIELD(ah, AR_PHY_TX_IQCAL_CONTROL_3,\r\nAR_PHY_TX_IQCAL_CONTROL_3_IQCORR_EN, 0x1);\r\nREG_RMW_FIELD(ah, AR_PHY_RX_IQCAL_CORR_B0,\r\nAR_PHY_RX_IQCAL_CORR_B0_LOOPBACK_IQCORR_EN, 0x1);\r\nif (caldata)\r\ncaldata->done_txiqcal_once = is_reusable;\r\nreturn;\r\n}\r\nstatic bool ar9003_hw_tx_iq_cal_run(struct ath_hw *ah)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nu8 tx_gain_forced;\r\ntx_gain_forced = REG_READ_FIELD(ah, AR_PHY_TX_FORCED_GAIN,\r\nAR_PHY_TXGAIN_FORCE);\r\nif (tx_gain_forced)\r\nREG_RMW_FIELD(ah, AR_PHY_TX_FORCED_GAIN,\r\nAR_PHY_TXGAIN_FORCE, 0);\r\nREG_RMW_FIELD(ah, AR_PHY_TX_IQCAL_START,\r\nAR_PHY_TX_IQCAL_START_DO_CAL, 1);\r\nif (!ath9k_hw_wait(ah, AR_PHY_TX_IQCAL_START,\r\nAR_PHY_TX_IQCAL_START_DO_CAL, 0,\r\nAH_WAIT_TIMEOUT)) {\r\nath_dbg(common, CALIBRATE, "Tx IQ Cal is not completed\n");\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nstatic void ar9003_hw_tx_iq_cal_post_proc(struct ath_hw *ah, bool is_reusable)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nconst u32 txiqcal_status[AR9300_MAX_CHAINS] = {\r\nAR_PHY_TX_IQCAL_STATUS_B0,\r\nAR_PHY_TX_IQCAL_STATUS_B1,\r\nAR_PHY_TX_IQCAL_STATUS_B2,\r\n};\r\nconst u_int32_t chan_info_tab[] = {\r\nAR_PHY_CHAN_INFO_TAB_0,\r\nAR_PHY_CHAN_INFO_TAB_1,\r\nAR_PHY_CHAN_INFO_TAB_2,\r\n};\r\nstruct coeff coeff;\r\ns32 iq_res[6];\r\nint i, im, j;\r\nint nmeasurement;\r\nfor (i = 0; i < AR9300_MAX_CHAINS; i++) {\r\nif (!(ah->txchainmask & (1 << i)))\r\ncontinue;\r\nnmeasurement = REG_READ_FIELD(ah,\r\nAR_PHY_TX_IQCAL_STATUS_B0,\r\nAR_PHY_CALIBRATED_GAINS_0);\r\nif (nmeasurement > MAX_MEASUREMENT)\r\nnmeasurement = MAX_MEASUREMENT;\r\nfor (im = 0; im < nmeasurement; im++) {\r\nath_dbg(common, CALIBRATE,\r\n"Doing Tx IQ Cal for chain %d\n", i);\r\nif (REG_READ(ah, txiqcal_status[i]) &\r\nAR_PHY_TX_IQCAL_STATUS_FAILED) {\r\nath_dbg(common, CALIBRATE,\r\n"Tx IQ Cal failed for chain %d\n", i);\r\ngoto tx_iqcal_fail;\r\n}\r\nfor (j = 0; j < 3; j++) {\r\nu32 idx = 2 * j, offset = 4 * (3 * im + j);\r\nREG_RMW_FIELD(ah,\r\nAR_PHY_CHAN_INFO_MEMORY,\r\nAR_PHY_CHAN_INFO_TAB_S2_READ,\r\n0);\r\niq_res[idx] = REG_READ(ah,\r\nchan_info_tab[i] +\r\noffset);\r\nREG_RMW_FIELD(ah,\r\nAR_PHY_CHAN_INFO_MEMORY,\r\nAR_PHY_CHAN_INFO_TAB_S2_READ,\r\n1);\r\niq_res[idx + 1] = 0xffff & REG_READ(ah,\r\nchan_info_tab[i] + offset);\r\nath_dbg(common, CALIBRATE,\r\n"IQ_RES[%d]=0x%x IQ_RES[%d]=0x%x\n",\r\nidx, iq_res[idx], idx + 1,\r\niq_res[idx + 1]);\r\n}\r\nif (!ar9003_hw_calc_iq_corr(ah, i, iq_res,\r\ncoeff.iqc_coeff)) {\r\nath_dbg(common, CALIBRATE,\r\n"Failed in calculation of IQ correction\n");\r\ngoto tx_iqcal_fail;\r\n}\r\ncoeff.mag_coeff[i][im] = coeff.iqc_coeff[0] & 0x7f;\r\ncoeff.phs_coeff[i][im] =\r\n(coeff.iqc_coeff[0] >> 7) & 0x7f;\r\nif (coeff.mag_coeff[i][im] > 63)\r\ncoeff.mag_coeff[i][im] -= 128;\r\nif (coeff.phs_coeff[i][im] > 63)\r\ncoeff.phs_coeff[i][im] -= 128;\r\n}\r\n}\r\nar9003_hw_tx_iqcal_load_avg_2_passes(ah, &coeff, is_reusable);\r\nreturn;\r\ntx_iqcal_fail:\r\nath_dbg(common, CALIBRATE, "Tx IQ Cal failed\n");\r\nreturn;\r\n}\r\nstatic void ar9003_hw_tx_iq_cal_reload(struct ath_hw *ah)\r\n{\r\nstruct ath9k_hw_cal_data *caldata = ah->caldata;\r\nu32 tx_corr_coeff[MAX_MEASUREMENT][AR9300_MAX_CHAINS];\r\nint i, im;\r\nmemset(tx_corr_coeff, 0, sizeof(tx_corr_coeff));\r\nfor (i = 0; i < MAX_MEASUREMENT / 2; i++) {\r\ntx_corr_coeff[i * 2][0] = tx_corr_coeff[(i * 2) + 1][0] =\r\nAR_PHY_TX_IQCAL_CORR_COEFF_B0(i);\r\nif (!AR_SREV_9485(ah)) {\r\ntx_corr_coeff[i * 2][1] =\r\ntx_corr_coeff[(i * 2) + 1][1] =\r\nAR_PHY_TX_IQCAL_CORR_COEFF_B1(i);\r\ntx_corr_coeff[i * 2][2] =\r\ntx_corr_coeff[(i * 2) + 1][2] =\r\nAR_PHY_TX_IQCAL_CORR_COEFF_B2(i);\r\n}\r\n}\r\nfor (i = 0; i < AR9300_MAX_CHAINS; i++) {\r\nif (!(ah->txchainmask & (1 << i)))\r\ncontinue;\r\nfor (im = 0; im < caldata->num_measures[i]; im++) {\r\nif ((im % 2) == 0)\r\nREG_RMW_FIELD(ah, tx_corr_coeff[im][i],\r\nAR_PHY_TX_IQCAL_CORR_COEFF_00_COEFF_TABLE,\r\ncaldata->tx_corr_coeff[im][i]);\r\nelse\r\nREG_RMW_FIELD(ah, tx_corr_coeff[im][i],\r\nAR_PHY_TX_IQCAL_CORR_COEFF_01_COEFF_TABLE,\r\ncaldata->tx_corr_coeff[im][i]);\r\n}\r\n}\r\nREG_RMW_FIELD(ah, AR_PHY_TX_IQCAL_CONTROL_3,\r\nAR_PHY_TX_IQCAL_CONTROL_3_IQCORR_EN, 0x1);\r\nREG_RMW_FIELD(ah, AR_PHY_RX_IQCAL_CORR_B0,\r\nAR_PHY_RX_IQCAL_CORR_B0_LOOPBACK_IQCORR_EN, 0x1);\r\n}\r\nstatic void ar9003_hw_manual_peak_cal(struct ath_hw *ah, u8 chain, bool is_2g)\r\n{\r\nint offset[8], total = 0, test;\r\nint agc_out, i;\r\nREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_GAINSTAGES(chain),\r\nAR_PHY_65NM_RXRF_GAINSTAGES_RX_OVERRIDE, 0x1);\r\nREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_GAINSTAGES(chain),\r\nAR_PHY_65NM_RXRF_GAINSTAGES_LNAON_CALDC, 0x0);\r\nif (is_2g)\r\nREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_GAINSTAGES(chain),\r\nAR_PHY_65NM_RXRF_GAINSTAGES_LNA2G_GAIN_OVR, 0x0);\r\nelse\r\nREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_GAINSTAGES(chain),\r\nAR_PHY_65NM_RXRF_GAINSTAGES_LNA5G_GAIN_OVR, 0x0);\r\nREG_RMW_FIELD(ah, AR_PHY_65NM_RXTX2(chain),\r\nAR_PHY_65NM_RXTX2_RXON_OVR, 0x1);\r\nREG_RMW_FIELD(ah, AR_PHY_65NM_RXTX2(chain),\r\nAR_PHY_65NM_RXTX2_RXON, 0x0);\r\nREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_AGC(chain),\r\nAR_PHY_65NM_RXRF_AGC_AGC_OVERRIDE, 0x1);\r\nREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_AGC(chain),\r\nAR_PHY_65NM_RXRF_AGC_AGC_ON_OVR, 0x1);\r\nREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_AGC(chain),\r\nAR_PHY_65NM_RXRF_AGC_AGC_CAL_OVR, 0x1);\r\nif (is_2g)\r\nREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_AGC(chain),\r\nAR_PHY_65NM_RXRF_AGC_AGC2G_DBDAC_OVR, 0x0);\r\nelse\r\nREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_AGC(chain),\r\nAR_PHY_65NM_RXRF_AGC_AGC5G_DBDAC_OVR, 0x0);\r\nfor (i = 6; i > 0; i--) {\r\noffset[i] = BIT(i - 1);\r\ntest = total + offset[i];\r\nif (is_2g)\r\nREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_AGC(chain),\r\nAR_PHY_65NM_RXRF_AGC_AGC2G_CALDAC_OVR,\r\ntest);\r\nelse\r\nREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_AGC(chain),\r\nAR_PHY_65NM_RXRF_AGC_AGC5G_CALDAC_OVR,\r\ntest);\r\nudelay(100);\r\nagc_out = REG_READ_FIELD(ah, AR_PHY_65NM_RXRF_AGC(chain),\r\nAR_PHY_65NM_RXRF_AGC_AGC_OUT);\r\noffset[i] = (agc_out) ? 0 : 1;\r\ntotal += (offset[i] << (i - 1));\r\n}\r\nif (is_2g)\r\nREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_AGC(chain),\r\nAR_PHY_65NM_RXRF_AGC_AGC2G_CALDAC_OVR, total);\r\nelse\r\nREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_AGC(chain),\r\nAR_PHY_65NM_RXRF_AGC_AGC5G_CALDAC_OVR, total);\r\nREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_GAINSTAGES(chain),\r\nAR_PHY_65NM_RXRF_GAINSTAGES_RX_OVERRIDE, 0);\r\nREG_RMW_FIELD(ah, AR_PHY_65NM_RXTX2(chain),\r\nAR_PHY_65NM_RXTX2_RXON_OVR, 0);\r\nREG_RMW_FIELD(ah, AR_PHY_65NM_RXRF_AGC(chain),\r\nAR_PHY_65NM_RXRF_AGC_AGC_CAL_OVR, 0);\r\n}\r\nstatic void ar9003_hw_do_manual_peak_cal(struct ath_hw *ah,\r\nstruct ath9k_channel *chan)\r\n{\r\nint i;\r\nif (!AR_SREV_9462(ah) && !AR_SREV_9565(ah) && !AR_SREV_9485(ah))\r\nreturn;\r\nfor (i = 0; i < AR9300_MAX_CHAINS; i++) {\r\nif (!(ah->rxchainmask & (1 << i)))\r\ncontinue;\r\nar9003_hw_manual_peak_cal(ah, i, IS_CHAN_2GHZ(chan));\r\n}\r\n}\r\nstatic void ar9003_hw_cl_cal_post_proc(struct ath_hw *ah, bool is_reusable)\r\n{\r\nu32 cl_idx[AR9300_MAX_CHAINS] = { AR_PHY_CL_TAB_0,\r\nAR_PHY_CL_TAB_1,\r\nAR_PHY_CL_TAB_2 };\r\nstruct ath9k_hw_cal_data *caldata = ah->caldata;\r\nbool txclcal_done = false;\r\nint i, j;\r\nif (!caldata || !(ah->enabled_cals & TX_CL_CAL))\r\nreturn;\r\ntxclcal_done = !!(REG_READ(ah, AR_PHY_AGC_CONTROL) &\r\nAR_PHY_AGC_CONTROL_CLC_SUCCESS);\r\nif (caldata->done_txclcal_once) {\r\nfor (i = 0; i < AR9300_MAX_CHAINS; i++) {\r\nif (!(ah->txchainmask & (1 << i)))\r\ncontinue;\r\nfor (j = 0; j < MAX_CL_TAB_ENTRY; j++)\r\nREG_WRITE(ah, CL_TAB_ENTRY(cl_idx[i]),\r\ncaldata->tx_clcal[i][j]);\r\n}\r\n} else if (is_reusable && txclcal_done) {\r\nfor (i = 0; i < AR9300_MAX_CHAINS; i++) {\r\nif (!(ah->txchainmask & (1 << i)))\r\ncontinue;\r\nfor (j = 0; j < MAX_CL_TAB_ENTRY; j++)\r\ncaldata->tx_clcal[i][j] =\r\nREG_READ(ah, CL_TAB_ENTRY(cl_idx[i]));\r\n}\r\ncaldata->done_txclcal_once = true;\r\n}\r\n}\r\nstatic bool ar9003_hw_init_cal(struct ath_hw *ah,\r\nstruct ath9k_channel *chan)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nstruct ath9k_hw_cal_data *caldata = ah->caldata;\r\nbool txiqcal_done = false;\r\nbool is_reusable = true, status = true;\r\nbool run_rtt_cal = false, run_agc_cal, sep_iq_cal = false;\r\nbool rtt = !!(ah->caps.hw_caps & ATH9K_HW_CAP_RTT);\r\nu32 agc_ctrl = 0, agc_supp_cals = AR_PHY_AGC_CONTROL_OFFSET_CAL |\r\nAR_PHY_AGC_CONTROL_FLTR_CAL |\r\nAR_PHY_AGC_CONTROL_PKDET_CAL;\r\nar9003_hw_set_chain_masks(ah, ah->caps.rx_chainmask, ah->caps.tx_chainmask);\r\nif (rtt) {\r\nif (!ar9003_hw_rtt_restore(ah, chan))\r\nrun_rtt_cal = true;\r\nif (run_rtt_cal)\r\nath_dbg(common, CALIBRATE, "RTT calibration to be done\n");\r\n}\r\nrun_agc_cal = run_rtt_cal;\r\nif (run_rtt_cal) {\r\nar9003_hw_rtt_enable(ah);\r\nar9003_hw_rtt_set_mask(ah, 0x00);\r\nar9003_hw_rtt_clear_hist(ah);\r\n}\r\nif (rtt && !run_rtt_cal) {\r\nagc_ctrl = REG_READ(ah, AR_PHY_AGC_CONTROL);\r\nagc_supp_cals &= agc_ctrl;\r\nagc_ctrl &= ~(AR_PHY_AGC_CONTROL_OFFSET_CAL |\r\nAR_PHY_AGC_CONTROL_FLTR_CAL |\r\nAR_PHY_AGC_CONTROL_PKDET_CAL);\r\nREG_WRITE(ah, AR_PHY_AGC_CONTROL, agc_ctrl);\r\n}\r\nif (ah->enabled_cals & TX_CL_CAL) {\r\nif (caldata && caldata->done_txclcal_once)\r\nREG_CLR_BIT(ah, AR_PHY_CL_CAL_CTL,\r\nAR_PHY_CL_CAL_ENABLE);\r\nelse {\r\nREG_SET_BIT(ah, AR_PHY_CL_CAL_CTL,\r\nAR_PHY_CL_CAL_ENABLE);\r\nrun_agc_cal = true;\r\n}\r\n}\r\nif ((IS_CHAN_HALF_RATE(chan) || IS_CHAN_QUARTER_RATE(chan)) ||\r\n!(ah->enabled_cals & TX_IQ_CAL))\r\ngoto skip_tx_iqcal;\r\nREG_RMW_FIELD(ah, AR_PHY_TX_IQCAL_CONTROL_1,\r\nAR_PHY_TX_IQCAL_CONTROL_1_IQCORR_I_Q_COFF_DELPT,\r\nDELPT);\r\nif (ah->enabled_cals & TX_IQ_ON_AGC_CAL) {\r\nif (caldata && !caldata->done_txiqcal_once)\r\nREG_SET_BIT(ah, AR_PHY_TX_IQCAL_CONTROL_0,\r\nAR_PHY_TX_IQCAL_CONTROL_0_ENABLE_TXIQ_CAL);\r\nelse\r\nREG_CLR_BIT(ah, AR_PHY_TX_IQCAL_CONTROL_0,\r\nAR_PHY_TX_IQCAL_CONTROL_0_ENABLE_TXIQ_CAL);\r\ntxiqcal_done = run_agc_cal = true;\r\n} else if (caldata && !caldata->done_txiqcal_once) {\r\nrun_agc_cal = true;\r\nsep_iq_cal = true;\r\n}\r\nskip_tx_iqcal:\r\nif (ath9k_hw_mci_is_enabled(ah) && IS_CHAN_2GHZ(chan) && run_agc_cal)\r\nar9003_mci_init_cal_req(ah, &is_reusable);\r\nif (sep_iq_cal) {\r\ntxiqcal_done = ar9003_hw_tx_iq_cal_run(ah);\r\nREG_WRITE(ah, AR_PHY_ACTIVE, AR_PHY_ACTIVE_DIS);\r\nudelay(5);\r\nREG_WRITE(ah, AR_PHY_ACTIVE, AR_PHY_ACTIVE_EN);\r\n}\r\nif (run_agc_cal || !(ah->ah_flags & AH_FASTCC)) {\r\nREG_WRITE(ah, AR_PHY_AGC_CONTROL,\r\nREG_READ(ah, AR_PHY_AGC_CONTROL) |\r\nAR_PHY_AGC_CONTROL_CAL);\r\nstatus = ath9k_hw_wait(ah, AR_PHY_AGC_CONTROL,\r\nAR_PHY_AGC_CONTROL_CAL,\r\n0, AH_WAIT_TIMEOUT);\r\nar9003_hw_do_manual_peak_cal(ah, chan);\r\n}\r\nif (ath9k_hw_mci_is_enabled(ah) && IS_CHAN_2GHZ(chan) && run_agc_cal)\r\nar9003_mci_init_cal_done(ah);\r\nif (rtt && !run_rtt_cal) {\r\nagc_ctrl |= agc_supp_cals;\r\nREG_WRITE(ah, AR_PHY_AGC_CONTROL, agc_ctrl);\r\n}\r\nif (!status) {\r\nif (run_rtt_cal)\r\nar9003_hw_rtt_disable(ah);\r\nath_dbg(common, CALIBRATE,\r\n"offset calibration failed to complete in %d ms; noisy environment?\n",\r\nAH_WAIT_TIMEOUT / 1000);\r\nreturn false;\r\n}\r\nif (txiqcal_done)\r\nar9003_hw_tx_iq_cal_post_proc(ah, is_reusable);\r\nelse if (caldata && caldata->done_txiqcal_once)\r\nar9003_hw_tx_iq_cal_reload(ah);\r\nar9003_hw_cl_cal_post_proc(ah, is_reusable);\r\nif (run_rtt_cal && caldata) {\r\nif (is_reusable) {\r\nif (!ath9k_hw_rfbus_req(ah))\r\nath_err(ath9k_hw_common(ah),\r\n"Could not stop baseband\n");\r\nelse\r\nar9003_hw_rtt_fill_hist(ah);\r\nath9k_hw_rfbus_done(ah);\r\n}\r\nar9003_hw_rtt_disable(ah);\r\n}\r\nar9003_hw_set_chain_masks(ah, ah->rxchainmask, ah->txchainmask);\r\nah->cal_list = ah->cal_list_last = ah->cal_list_curr = NULL;\r\nINIT_CAL(&ah->iq_caldata);\r\nINSERT_CAL(ah, &ah->iq_caldata);\r\nath_dbg(common, CALIBRATE, "enabling IQ Calibration\n");\r\nah->cal_list_curr = ah->cal_list;\r\nif (ah->cal_list_curr)\r\nath9k_hw_reset_calibration(ah, ah->cal_list_curr);\r\nif (caldata)\r\ncaldata->CalValid = 0;\r\nreturn true;\r\n}\r\nvoid ar9003_hw_attach_calib_ops(struct ath_hw *ah)\r\n{\r\nstruct ath_hw_private_ops *priv_ops = ath9k_hw_private_ops(ah);\r\nstruct ath_hw_ops *ops = ath9k_hw_ops(ah);\r\npriv_ops->init_cal_settings = ar9003_hw_init_cal_settings;\r\npriv_ops->init_cal = ar9003_hw_init_cal;\r\npriv_ops->setup_calibration = ar9003_hw_setup_calibration;\r\nops->calibrate = ar9003_hw_calibrate;\r\n}

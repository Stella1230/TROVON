static int do_cmd(struct net_device *dev, struct ifreq *ifr, int cmd, int *data)\r\n{\r\nint ret = -1;\r\nstruct if_bypass *bypass_cb;\r\nstatic int (*ioctl) (struct net_device *, struct ifreq *, int);\r\nbypass_cb = (struct if_bypass *)ifr;\r\nbypass_cb->cmd = cmd;\r\nbypass_cb->data = *data;\r\nif ((dev->netdev_ops) && (ioctl = dev->netdev_ops->ndo_do_ioctl)) {\r\nret = ioctl(dev, ifr, SIOCGIFBYPASS);\r\n*data = bypass_cb->data;\r\n}\r\nreturn ret;\r\n}\r\nstatic int doit(int cmd, int if_index, int *data)\r\n{\r\nstruct ifreq ifr;\r\nint ret = -1;\r\nstruct net_device *dev;\r\nstruct net_device *n;\r\nfor_each_netdev_safe(&init_net, dev, n) {\r\nif (dev->ifindex == if_index) {\r\nret = do_cmd(dev, &ifr, cmd, data);\r\nif (ret < 0)\r\nret = -1;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic int is_dev_sd(int if_index)\r\n{\r\nint ret = 0;\r\nSET_BPLIB_INT_FN(is_bypass, int, if_index, ret);\r\nreturn (ret >= 0 ? 1 : 0);\r\n}\r\nstatic int is_bypass_dev(int if_index)\r\n{\r\nstruct pci_dev *pdev = NULL;\r\nstruct net_device *dev = NULL;\r\nstruct ifreq ifr;\r\nint ret = 0, data = 0;\r\nwhile ((pdev = pci_get_class(PCI_CLASS_NETWORK_ETHERNET << 8, pdev))) {\r\nif ((dev = pci_get_drvdata(pdev)) != NULL)\r\nif (((dev = pci_get_drvdata(pdev)) != NULL) &&\r\n(dev->ifindex == if_index)) {\r\nif ((pdev->vendor == SILICOM_VID) &&\r\n(pdev->device >= SILICOM_BP_PID_MIN) &&\r\n(pdev->device <= SILICOM_BP_PID_MAX))\r\ngoto send_cmd;\r\n#if defined(BP_VENDOR_SUPPORT) && defined(ETHTOOL_GDRVINFO)\r\nelse {\r\nstruct ethtool_drvinfo info;\r\nconst struct ethtool_ops *ops =\r\ndev->ethtool_ops;\r\nint k = 0;\r\nif (ops->get_drvinfo) {\r\nmemset(&info, 0, sizeof(info));\r\ninfo.cmd = ETHTOOL_GDRVINFO;\r\nops->get_drvinfo(dev, &info);\r\nfor (; bp_desc_array[k]; k++)\r\nif (!\r\n(strcmp\r\n(bp_desc_array[k],\r\ninfo.driver)))\r\ngoto send_cmd;\r\n}\r\n}\r\n#endif\r\nreturn -1;\r\n}\r\n}\r\nsend_cmd:\r\nret = do_cmd(dev, &ifr, IS_BYPASS, &data);\r\nreturn (ret < 0 ? -1 : ret);\r\n}\r\nstatic int is_bypass(int if_index)\r\n{\r\nint ret = 0;\r\nSET_BPLIB_INT_FN(is_bypass, int, if_index, ret);\r\nif (ret < 0)\r\nreturn is_bypass_dev(if_index);\r\nreturn ret;\r\n}\r\nstatic int get_bypass_slave(int if_index)\r\n{\r\nDO_BPLIB_GET_ARG_FN(get_bypass_slave, GET_BYPASS_SLAVE, if_index);\r\n}\r\nstatic int get_bypass_caps(int if_index)\r\n{\r\nDO_BPLIB_GET_ARG_FN(get_bypass_caps, GET_BYPASS_CAPS, if_index);\r\n}\r\nstatic int get_wd_set_caps(int if_index)\r\n{\r\nDO_BPLIB_GET_ARG_FN(get_wd_set_caps, GET_WD_SET_CAPS, if_index);\r\n}\r\nstatic int set_bypass(int if_index, int bypass_mode)\r\n{\r\nDO_BPLIB_SET_ARG_FN(set_bypass, SET_BYPASS, if_index, bypass_mode);\r\n}\r\nstatic int get_bypass(int if_index)\r\n{\r\nDO_BPLIB_GET_ARG_FN(get_bypass, GET_BYPASS, if_index);\r\n}\r\nstatic int get_bypass_change(int if_index)\r\n{\r\nDO_BPLIB_GET_ARG_FN(get_bypass_change, GET_BYPASS_CHANGE, if_index);\r\n}\r\nstatic int set_dis_bypass(int if_index, int dis_bypass)\r\n{\r\nDO_BPLIB_SET_ARG_FN(set_dis_bypass, SET_DIS_BYPASS, if_index,\r\ndis_bypass);\r\n}\r\nstatic int get_dis_bypass(int if_index)\r\n{\r\nDO_BPLIB_GET_ARG_FN(get_dis_bypass, GET_DIS_BYPASS, if_index);\r\n}\r\nstatic int set_bypass_pwoff(int if_index, int bypass_mode)\r\n{\r\nDO_BPLIB_SET_ARG_FN(set_bypass_pwoff, SET_BYPASS_PWOFF, if_index,\r\nbypass_mode);\r\n}\r\nstatic int get_bypass_pwoff(int if_index)\r\n{\r\nDO_BPLIB_GET_ARG_FN(get_bypass_pwoff, GET_BYPASS_PWOFF, if_index);\r\n}\r\nstatic int set_bypass_pwup(int if_index, int bypass_mode)\r\n{\r\nDO_BPLIB_SET_ARG_FN(set_bypass_pwup, SET_BYPASS_PWUP, if_index,\r\nbypass_mode);\r\n}\r\nstatic int get_bypass_pwup(int if_index)\r\n{\r\nDO_BPLIB_GET_ARG_FN(get_bypass_pwup, GET_BYPASS_PWUP, if_index);\r\n}\r\nstatic int set_bypass_wd(int if_index, int ms_timeout, int *ms_timeout_set)\r\n{\r\nint data = ms_timeout, ret = 0;\r\nif (is_dev_sd(if_index))\r\nSET_BPLIB_INT_FN3(set_bypass_wd, int, if_index, int, ms_timeout,\r\nint *, ms_timeout_set, ret);\r\nelse {\r\nret = doit(SET_BYPASS_WD, if_index, &data);\r\nif (ret > 0) {\r\n*ms_timeout_set = ret;\r\nret = 0;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic int get_bypass_wd(int if_index, int *ms_timeout_set)\r\n{\r\nint *data = ms_timeout_set, ret = 0;\r\nif (is_dev_sd(if_index))\r\nSET_BPLIB_INT_FN2(get_bypass_wd, int, if_index, int *,\r\nms_timeout_set, ret);\r\nelse\r\nret = doit(GET_BYPASS_WD, if_index, data);\r\nreturn ret;\r\n}\r\nstatic int get_wd_expire_time(int if_index, int *ms_time_left)\r\n{\r\nint *data = ms_time_left, ret = 0;\r\nif (is_dev_sd(if_index))\r\nSET_BPLIB_INT_FN2(get_wd_expire_time, int, if_index, int *,\r\nms_time_left, ret);\r\nelse {\r\nret = doit(GET_WD_EXPIRE_TIME, if_index, data);\r\nif ((ret == 0) && (*data != 0))\r\nret = 1;\r\n}\r\nreturn ret;\r\n}\r\nstatic int reset_bypass_wd_timer(int if_index)\r\n{\r\nDO_BPLIB_GET_ARG_FN(reset_bypass_wd_timer, RESET_BYPASS_WD_TIMER,\r\nif_index);\r\n}\r\nstatic int set_std_nic(int if_index, int bypass_mode)\r\n{\r\nDO_BPLIB_SET_ARG_FN(set_std_nic, SET_STD_NIC, if_index, bypass_mode);\r\n}\r\nstatic int get_std_nic(int if_index)\r\n{\r\nDO_BPLIB_GET_ARG_FN(get_std_nic, GET_STD_NIC, if_index);\r\n}\r\nstatic int set_tx(int if_index, int tx_state)\r\n{\r\nDO_BPLIB_SET_ARG_FN(set_tx, SET_TX, if_index, tx_state);\r\n}\r\nstatic int get_tx(int if_index)\r\n{\r\nDO_BPLIB_GET_ARG_FN(get_tx, GET_TX, if_index);\r\n}\r\nstatic int set_tap(int if_index, int tap_mode)\r\n{\r\nDO_BPLIB_SET_ARG_FN(set_tap, SET_TAP, if_index, tap_mode);\r\n}\r\nstatic int get_tap(int if_index)\r\n{\r\nDO_BPLIB_GET_ARG_FN(get_tap, GET_TAP, if_index);\r\n}\r\nstatic int get_tap_change(int if_index)\r\n{\r\nDO_BPLIB_GET_ARG_FN(get_tap_change, GET_TAP_CHANGE, if_index);\r\n}\r\nstatic int set_dis_tap(int if_index, int dis_tap)\r\n{\r\nDO_BPLIB_SET_ARG_FN(set_dis_tap, SET_DIS_TAP, if_index, dis_tap);\r\n}\r\nstatic int get_dis_tap(int if_index)\r\n{\r\nDO_BPLIB_GET_ARG_FN(get_dis_tap, GET_DIS_TAP, if_index);\r\n}\r\nstatic int set_tap_pwup(int if_index, int tap_mode)\r\n{\r\nDO_BPLIB_SET_ARG_FN(set_tap_pwup, SET_TAP_PWUP, if_index, tap_mode);\r\n}\r\nstatic int get_tap_pwup(int if_index)\r\n{\r\nDO_BPLIB_GET_ARG_FN(get_tap_pwup, GET_TAP_PWUP, if_index);\r\n}\r\nstatic int set_bp_disc(int if_index, int disc_mode)\r\n{\r\nDO_BPLIB_SET_ARG_FN(set_bp_disc, SET_DISC, if_index, disc_mode);\r\n}\r\nstatic int get_bp_disc(int if_index)\r\n{\r\nDO_BPLIB_GET_ARG_FN(get_bp_disc, GET_DISC, if_index);\r\n}\r\nstatic int get_bp_disc_change(int if_index)\r\n{\r\nDO_BPLIB_GET_ARG_FN(get_bp_disc_change, GET_DISC_CHANGE, if_index);\r\n}\r\nstatic int set_bp_dis_disc(int if_index, int dis_disc)\r\n{\r\nDO_BPLIB_SET_ARG_FN(set_bp_dis_disc, SET_DIS_DISC, if_index, dis_disc);\r\n}\r\nstatic int get_bp_dis_disc(int if_index)\r\n{\r\nDO_BPLIB_GET_ARG_FN(get_bp_dis_disc, GET_DIS_DISC, if_index);\r\n}\r\nstatic int set_bp_disc_pwup(int if_index, int disc_mode)\r\n{\r\nDO_BPLIB_SET_ARG_FN(set_bp_disc_pwup, SET_DISC_PWUP, if_index,\r\ndisc_mode);\r\n}\r\nstatic int get_bp_disc_pwup(int if_index)\r\n{\r\nDO_BPLIB_GET_ARG_FN(get_bp_disc_pwup, GET_DISC_PWUP, if_index);\r\n}\r\nstatic int set_wd_exp_mode(int if_index, int mode)\r\n{\r\nDO_BPLIB_SET_ARG_FN(set_wd_exp_mode, SET_WD_EXP_MODE, if_index, mode);\r\n}\r\nstatic int get_wd_exp_mode(int if_index)\r\n{\r\nDO_BPLIB_GET_ARG_FN(get_wd_exp_mode, GET_WD_EXP_MODE, if_index);\r\n}\r\nstatic int set_wd_autoreset(int if_index, int time)\r\n{\r\nDO_BPLIB_SET_ARG_FN(set_wd_autoreset, SET_WD_AUTORESET, if_index, time);\r\n}\r\nstatic int get_wd_autoreset(int if_index)\r\n{\r\nDO_BPLIB_GET_ARG_FN(get_wd_autoreset, GET_WD_AUTORESET, if_index);\r\n}\r\nstatic int set_tpl(int if_index, int tpl_mode)\r\n{\r\nDO_BPLIB_SET_ARG_FN(set_tpl, SET_TPL, if_index, tpl_mode);\r\n}\r\nstatic int get_tpl(int if_index)\r\n{\r\nDO_BPLIB_GET_ARG_FN(get_tpl, GET_TPL, if_index);\r\n}\r\nstatic int set_bp_hw_reset(int if_index, int mode)\r\n{\r\nDO_BPLIB_SET_ARG_FN(set_tpl, SET_BP_HW_RESET, if_index, mode);\r\n}\r\nstatic int get_bp_hw_reset(int if_index)\r\n{\r\nDO_BPLIB_GET_ARG_FN(get_tpl, GET_BP_HW_RESET, if_index);\r\n}\r\nstatic int get_bypass_info(int if_index, struct bp_info *bp_info)\r\n{\r\nint ret = 0;\r\nif (is_dev_sd(if_index)) {\r\nSET_BPLIB_INT_FN2(get_bypass_info, int, if_index,\r\nstruct bp_info *, bp_info, ret);\r\n} else {\r\nstatic int (*ioctl) (struct net_device *, struct ifreq *, int);\r\nstruct net_device *dev;\r\nstruct net_device *n;\r\nfor_each_netdev_safe(&init_net, dev, n) {\r\nif (dev->ifindex == if_index) {\r\nstruct if_bypass_info *bypass_cb;\r\nstruct ifreq ifr;\r\nmemset(&ifr, 0, sizeof(ifr));\r\nbypass_cb = (struct if_bypass_info *)&ifr;\r\nbypass_cb->cmd = GET_BYPASS_INFO;\r\nif ((dev->netdev_ops) &&\r\n(ioctl = dev->netdev_ops->ndo_do_ioctl)) {\r\nret = ioctl(dev, &ifr, SIOCGIFBYPASS);\r\n}\r\nelse\r\nret = -1;\r\nif (ret == 0)\r\nmemcpy(bp_info, &bypass_cb->bp_info,\r\nsizeof(struct bp_info));\r\nret = (ret < 0 ? -1 : 0);\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn ret;\r\n}\r\nint init_lib_module(void)\r\n{\r\nprintk(VERSION);\r\nreturn 0;\r\n}\r\nvoid cleanup_lib_module(void)\r\n{\r\n}

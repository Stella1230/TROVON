static void _gef_gpio_set(void __iomem *reg, unsigned int offset, int value)\r\n{\r\nunsigned int data;\r\ndata = ioread32be(reg);\r\nif (value & 0x1)\r\ndata = data | (0x1 << offset);\r\nelse\r\ndata = data & ~(0x1 << offset);\r\niowrite32be(data, reg);\r\n}\r\nstatic int gef_gpio_dir_in(struct gpio_chip *chip, unsigned offset)\r\n{\r\nunsigned int data;\r\nstruct of_mm_gpio_chip *mmchip = to_of_mm_gpio_chip(chip);\r\ndata = ioread32be(mmchip->regs + GEF_GPIO_DIRECT);\r\ndata = data | (0x1 << offset);\r\niowrite32be(data, mmchip->regs + GEF_GPIO_DIRECT);\r\nreturn 0;\r\n}\r\nstatic int gef_gpio_dir_out(struct gpio_chip *chip, unsigned offset, int value)\r\n{\r\nunsigned int data;\r\nstruct of_mm_gpio_chip *mmchip = to_of_mm_gpio_chip(chip);\r\n_gef_gpio_set(mmchip->regs + GEF_GPIO_OUT, offset, value);\r\ndata = ioread32be(mmchip->regs + GEF_GPIO_DIRECT);\r\ndata = data & ~(0x1 << offset);\r\niowrite32be(data, mmchip->regs + GEF_GPIO_DIRECT);\r\nreturn 0;\r\n}\r\nstatic int gef_gpio_get(struct gpio_chip *chip, unsigned offset)\r\n{\r\nunsigned int data;\r\nint state = 0;\r\nstruct of_mm_gpio_chip *mmchip = to_of_mm_gpio_chip(chip);\r\ndata = ioread32be(mmchip->regs + GEF_GPIO_IN);\r\nstate = (int)((data >> offset) & 0x1);\r\nreturn state;\r\n}\r\nstatic void gef_gpio_set(struct gpio_chip *chip, unsigned offset, int value)\r\n{\r\nstruct of_mm_gpio_chip *mmchip = to_of_mm_gpio_chip(chip);\r\n_gef_gpio_set(mmchip->regs + GEF_GPIO_OUT, offset, value);\r\n}\r\nstatic int __init gef_gpio_init(void)\r\n{\r\nstruct device_node *np;\r\nint retval;\r\nstruct of_mm_gpio_chip *gef_gpio_chip;\r\nfor_each_compatible_node(np, NULL, "gef,sbc610-gpio") {\r\npr_debug("%s: Initialising GEF GPIO\n", np->full_name);\r\ngef_gpio_chip = kzalloc(sizeof(*gef_gpio_chip), GFP_KERNEL);\r\nif (!gef_gpio_chip) {\r\npr_err("%s: Unable to allocate structure\n",\r\nnp->full_name);\r\ncontinue;\r\n}\r\ngef_gpio_chip->gc.of_gpio_n_cells = 2;\r\ngef_gpio_chip->gc.ngpio = 19;\r\ngef_gpio_chip->gc.direction_input = gef_gpio_dir_in;\r\ngef_gpio_chip->gc.direction_output = gef_gpio_dir_out;\r\ngef_gpio_chip->gc.get = gef_gpio_get;\r\ngef_gpio_chip->gc.set = gef_gpio_set;\r\nretval = of_mm_gpiochip_add(np, gef_gpio_chip);\r\nif (retval) {\r\nkfree(gef_gpio_chip);\r\npr_err("%s: Unable to add GPIO\n", np->full_name);\r\n}\r\n}\r\nfor_each_compatible_node(np, NULL, "gef,sbc310-gpio") {\r\npr_debug("%s: Initialising GEF GPIO\n", np->full_name);\r\ngef_gpio_chip = kzalloc(sizeof(*gef_gpio_chip), GFP_KERNEL);\r\nif (!gef_gpio_chip) {\r\npr_err("%s: Unable to allocate structure\n",\r\nnp->full_name);\r\ncontinue;\r\n}\r\ngef_gpio_chip->gc.of_gpio_n_cells = 2;\r\ngef_gpio_chip->gc.ngpio = 6;\r\ngef_gpio_chip->gc.direction_input = gef_gpio_dir_in;\r\ngef_gpio_chip->gc.direction_output = gef_gpio_dir_out;\r\ngef_gpio_chip->gc.get = gef_gpio_get;\r\ngef_gpio_chip->gc.set = gef_gpio_set;\r\nretval = of_mm_gpiochip_add(np, gef_gpio_chip);\r\nif (retval) {\r\nkfree(gef_gpio_chip);\r\npr_err("%s: Unable to add GPIO\n", np->full_name);\r\n}\r\n}\r\nfor_each_compatible_node(np, NULL, "ge,imp3a-gpio") {\r\npr_debug("%s: Initialising GE GPIO\n", np->full_name);\r\ngef_gpio_chip = kzalloc(sizeof(*gef_gpio_chip), GFP_KERNEL);\r\nif (!gef_gpio_chip) {\r\npr_err("%s: Unable to allocate structure\n",\r\nnp->full_name);\r\ncontinue;\r\n}\r\ngef_gpio_chip->gc.of_gpio_n_cells = 2;\r\ngef_gpio_chip->gc.ngpio = 16;\r\ngef_gpio_chip->gc.direction_input = gef_gpio_dir_in;\r\ngef_gpio_chip->gc.direction_output = gef_gpio_dir_out;\r\ngef_gpio_chip->gc.get = gef_gpio_get;\r\ngef_gpio_chip->gc.set = gef_gpio_set;\r\nretval = of_mm_gpiochip_add(np, gef_gpio_chip);\r\nif (retval) {\r\nkfree(gef_gpio_chip);\r\npr_err("%s: Unable to add GPIO\n", np->full_name);\r\n}\r\n}\r\nreturn 0;\r\n}

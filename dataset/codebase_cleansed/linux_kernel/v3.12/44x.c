void kvmppc_core_vcpu_load(struct kvm_vcpu *vcpu, int cpu)\r\n{\r\nkvmppc_booke_vcpu_load(vcpu, cpu);\r\nkvmppc_44x_tlb_load(vcpu);\r\n}\r\nvoid kvmppc_core_vcpu_put(struct kvm_vcpu *vcpu)\r\n{\r\nkvmppc_44x_tlb_put(vcpu);\r\nkvmppc_booke_vcpu_put(vcpu);\r\n}\r\nint kvmppc_core_check_processor_compat(void)\r\n{\r\nint r;\r\nif (strncmp(cur_cpu_spec->platform, "ppc440", 6) == 0)\r\nr = 0;\r\nelse\r\nr = -ENOTSUPP;\r\nreturn r;\r\n}\r\nint kvmppc_core_vcpu_setup(struct kvm_vcpu *vcpu)\r\n{\r\nstruct kvmppc_vcpu_44x *vcpu_44x = to_44x(vcpu);\r\nstruct kvmppc_44x_tlbe *tlbe = &vcpu_44x->guest_tlb[0];\r\nint i;\r\ntlbe->tid = 0;\r\ntlbe->word0 = PPC44x_TLB_16M | PPC44x_TLB_VALID;\r\ntlbe->word1 = 0;\r\ntlbe->word2 = PPC44x_TLB_SX | PPC44x_TLB_SW | PPC44x_TLB_SR;\r\ntlbe++;\r\ntlbe->tid = 0;\r\ntlbe->word0 = 0xef600000 | PPC44x_TLB_4K | PPC44x_TLB_VALID;\r\ntlbe->word1 = 0xef600000;\r\ntlbe->word2 = PPC44x_TLB_SX | PPC44x_TLB_SW | PPC44x_TLB_SR\r\n| PPC44x_TLB_I | PPC44x_TLB_G;\r\nvcpu->arch.ccr1 = mfspr(SPRN_CCR1);\r\nfor (i = 0; i < ARRAY_SIZE(vcpu_44x->shadow_refs); i++)\r\nvcpu_44x->shadow_refs[i].gtlb_index = -1;\r\nvcpu->arch.cpu_type = KVM_CPU_440;\r\nvcpu->arch.pvr = mfspr(SPRN_PVR);\r\nreturn 0;\r\n}\r\nint kvmppc_core_vcpu_translate(struct kvm_vcpu *vcpu,\r\nstruct kvm_translation *tr)\r\n{\r\nint index;\r\ngva_t eaddr;\r\nu8 pid;\r\nu8 as;\r\neaddr = tr->linear_address;\r\npid = (tr->linear_address >> 32) & 0xff;\r\nas = (tr->linear_address >> 40) & 0x1;\r\nindex = kvmppc_44x_tlb_index(vcpu, eaddr, pid, as);\r\nif (index == -1) {\r\ntr->valid = 0;\r\nreturn 0;\r\n}\r\ntr->physical_address = kvmppc_mmu_xlate(vcpu, index, eaddr);\r\ntr->valid = 1;\r\nreturn 0;\r\n}\r\nvoid kvmppc_core_get_sregs(struct kvm_vcpu *vcpu, struct kvm_sregs *sregs)\r\n{\r\nkvmppc_get_sregs_ivor(vcpu, sregs);\r\n}\r\nint kvmppc_core_set_sregs(struct kvm_vcpu *vcpu, struct kvm_sregs *sregs)\r\n{\r\nreturn kvmppc_set_sregs_ivor(vcpu, sregs);\r\n}\r\nint kvmppc_get_one_reg(struct kvm_vcpu *vcpu, u64 id,\r\nunion kvmppc_one_reg *val)\r\n{\r\nreturn -EINVAL;\r\n}\r\nint kvmppc_set_one_reg(struct kvm_vcpu *vcpu, u64 id,\r\nunion kvmppc_one_reg *val)\r\n{\r\nreturn -EINVAL;\r\n}\r\nstruct kvm_vcpu *kvmppc_core_vcpu_create(struct kvm *kvm, unsigned int id)\r\n{\r\nstruct kvmppc_vcpu_44x *vcpu_44x;\r\nstruct kvm_vcpu *vcpu;\r\nint err;\r\nvcpu_44x = kmem_cache_zalloc(kvm_vcpu_cache, GFP_KERNEL);\r\nif (!vcpu_44x) {\r\nerr = -ENOMEM;\r\ngoto out;\r\n}\r\nvcpu = &vcpu_44x->vcpu;\r\nerr = kvm_vcpu_init(vcpu, kvm, id);\r\nif (err)\r\ngoto free_vcpu;\r\nvcpu->arch.shared = (void*)__get_free_page(GFP_KERNEL|__GFP_ZERO);\r\nif (!vcpu->arch.shared)\r\ngoto uninit_vcpu;\r\nreturn vcpu;\r\nuninit_vcpu:\r\nkvm_vcpu_uninit(vcpu);\r\nfree_vcpu:\r\nkmem_cache_free(kvm_vcpu_cache, vcpu_44x);\r\nout:\r\nreturn ERR_PTR(err);\r\n}\r\nvoid kvmppc_core_vcpu_free(struct kvm_vcpu *vcpu)\r\n{\r\nstruct kvmppc_vcpu_44x *vcpu_44x = to_44x(vcpu);\r\nfree_page((unsigned long)vcpu->arch.shared);\r\nkvm_vcpu_uninit(vcpu);\r\nkmem_cache_free(kvm_vcpu_cache, vcpu_44x);\r\n}\r\nint kvmppc_core_init_vm(struct kvm *kvm)\r\n{\r\nreturn 0;\r\n}\r\nvoid kvmppc_core_destroy_vm(struct kvm *kvm)\r\n{\r\n}\r\nstatic int __init kvmppc_44x_init(void)\r\n{\r\nint r;\r\nr = kvmppc_booke_init();\r\nif (r)\r\nreturn r;\r\nreturn kvm_init(NULL, sizeof(struct kvmppc_vcpu_44x), 0, THIS_MODULE);\r\n}\r\nstatic void __exit kvmppc_44x_exit(void)\r\n{\r\nkvmppc_booke_exit();\r\n}

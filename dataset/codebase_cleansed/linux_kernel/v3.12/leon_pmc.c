int pmc_leon_need_fixup(void)\r\n{\r\nunsigned int systemid = amba_system_id >> 16;\r\nunsigned int *id;\r\nid = &pmc_leon_fixup_ids[0];\r\nwhile (*id != 0) {\r\nif (*id == systemid)\r\nreturn 1;\r\nid++;\r\n}\r\nreturn 0;\r\n}\r\nvoid pmc_leon_idle_fixup(void)\r\n{\r\nregister unsigned int address = (unsigned int)leon3_irqctrl_regs;\r\nlocal_irq_enable();\r\n__asm__ __volatile__ (\r\n"wr %%g0, %%asr19\n"\r\n"lda [%0] %1, %%g0\n"\r\n:\r\n: "r"(address), "i"(ASI_LEON_BYPASS));\r\n}\r\nvoid pmc_leon_idle(void)\r\n{\r\nlocal_irq_enable();\r\n__asm__ __volatile__ ("wr %g0, %asr19\n\t");\r\n}\r\nstatic int __init leon_pmc_install(void)\r\n{\r\nif (sparc_cpu_model == sparc_leon) {\r\nif (pmc_leon_need_fixup())\r\nsparc_idle = pmc_leon_idle_fixup;\r\nelse\r\nsparc_idle = pmc_leon_idle;\r\nprintk(KERN_INFO "leon: power management initialized\n");\r\n}\r\nreturn 0;\r\n}

static void __init ima_add_boot_aggregate(void)\r\n{\r\nstruct ima_template_entry *entry;\r\nconst char *op = "add_boot_aggregate";\r\nconst char *audit_cause = "ENOMEM";\r\nint result = -ENOMEM;\r\nint violation = 1;\r\nentry = kmalloc(sizeof(*entry), GFP_KERNEL);\r\nif (!entry)\r\ngoto err_out;\r\nmemset(&entry->template, 0, sizeof(entry->template));\r\nstrncpy(entry->template.file_name, boot_aggregate_name,\r\nIMA_EVENT_NAME_LEN_MAX);\r\nif (ima_used_chip) {\r\nviolation = 0;\r\nresult = ima_calc_boot_aggregate(entry->template.digest);\r\nif (result < 0) {\r\naudit_cause = "hashing_error";\r\nkfree(entry);\r\ngoto err_out;\r\n}\r\n}\r\nresult = ima_store_template(entry, violation, NULL);\r\nif (result < 0)\r\nkfree(entry);\r\nreturn;\r\nerr_out:\r\nintegrity_audit_msg(AUDIT_INTEGRITY_PCR, NULL, boot_aggregate_name, op,\r\naudit_cause, result, 0);\r\n}\r\nint __init ima_init(void)\r\n{\r\nu8 pcr_i[IMA_DIGEST_SIZE];\r\nint rc;\r\nima_used_chip = 0;\r\nrc = tpm_pcr_read(TPM_ANY_NUM, 0, pcr_i);\r\nif (rc == 0)\r\nima_used_chip = 1;\r\nif (!ima_used_chip)\r\npr_info("IMA: No TPM chip found, activating TPM-bypass!\n");\r\nrc = ima_init_crypto();\r\nif (rc)\r\nreturn rc;\r\nima_add_boot_aggregate();\r\nima_init_policy();\r\nreturn ima_fs_init();\r\n}

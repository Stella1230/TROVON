static int __init sirfsoc_of_rstc_init(void)\r\n{\r\nstruct device_node *np;\r\nnp = of_find_matching_node(NULL, rstc_ids);\r\nif (!np) {\r\npr_err("unable to find compatible sirf rstc node in dtb\n");\r\nreturn -ENOENT;\r\n}\r\nsirfsoc_rstc_base = of_iomap(np, 0);\r\nif (!sirfsoc_rstc_base)\r\npanic("unable to map rstc cpu registers\n");\r\nof_node_put(np);\r\nreturn 0;\r\n}\r\nint sirfsoc_reset_device(struct device *dev)\r\n{\r\nu32 reset_bit;\r\nif (of_property_read_u32(dev->of_node, "reset-bit", &reset_bit))\r\nreturn -EINVAL;\r\nmutex_lock(&rstc_lock);\r\nif (of_device_is_compatible(dev->of_node, "sirf,prima2-rstc")) {\r\nwritel(readl(sirfsoc_rstc_base + (reset_bit / 32) * 4) | reset_bit,\r\nsirfsoc_rstc_base + (reset_bit / 32) * 4);\r\nmsleep(10);\r\nwritel(readl(sirfsoc_rstc_base + (reset_bit / 32) * 4) & ~reset_bit,\r\nsirfsoc_rstc_base + (reset_bit / 32) * 4);\r\n} else {\r\nwritel(reset_bit, sirfsoc_rstc_base + (reset_bit / 32) * 8);\r\nmsleep(10);\r\nwritel(reset_bit, sirfsoc_rstc_base + (reset_bit / 32) * 8 + 4);\r\n}\r\nmutex_unlock(&rstc_lock);\r\nreturn 0;\r\n}\r\nvoid sirfsoc_restart(enum reboot_mode mode, const char *cmd)\r\n{\r\nwritel(SIRFSOC_SYS_RST_BIT, sirfsoc_rstc_base);\r\n}

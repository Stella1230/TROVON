static int vendor_command(struct cypress *dev, unsigned char request,\r\nunsigned char address, unsigned char data)\r\n{\r\nint retval = 0;\r\nunsigned int pipe;\r\nunsigned char *iobuf;\r\niobuf = kzalloc(CYPRESS_MAX_REQSIZE, GFP_KERNEL);\r\nif (!iobuf) {\r\ndev_err(&dev->udev->dev, "Out of memory!\n");\r\nretval = -ENOMEM;\r\ngoto error;\r\n}\r\ndev_dbg(&dev->udev->dev, "Sending usb_control_msg (data: %d)\n", data);\r\npipe = usb_rcvctrlpipe(dev->udev, 0);\r\nretval = usb_control_msg(dev->udev, pipe, request,\r\nUSB_DIR_IN | USB_TYPE_VENDOR | USB_RECIP_OTHER,\r\naddress, data, iobuf, CYPRESS_MAX_REQSIZE,\r\nUSB_CTRL_GET_TIMEOUT);\r\nswitch (request) {\r\ncase CYPRESS_READ_PORT:\r\nif (address == CYPRESS_READ_PORT_ID0) {\r\ndev->port[0] = iobuf[1];\r\ndev_dbg(&dev->udev->dev,\r\n"READ_PORT0 returned: %d\n",\r\ndev->port[0]);\r\n}\r\nelse if (address == CYPRESS_READ_PORT_ID1) {\r\ndev->port[1] = iobuf[1];\r\ndev_dbg(&dev->udev->dev,\r\n"READ_PORT1 returned: %d\n",\r\ndev->port[1]);\r\n}\r\nbreak;\r\n}\r\nkfree(iobuf);\r\nerror:\r\nreturn retval;\r\n}\r\nstatic ssize_t write_port(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count,\r\nint port_num, int write_id)\r\n{\r\nint value = -1;\r\nint result = 0;\r\nstruct usb_interface *intf = to_usb_interface(dev);\r\nstruct cypress *cyp = usb_get_intfdata(intf);\r\ndev_dbg(&cyp->udev->dev, "WRITE_PORT%d called\n", port_num);\r\nif (sscanf(buf, "%d", &value) < 1) {\r\nresult = -EINVAL;\r\ngoto error;\r\n}\r\nif (value < 0 || value > 255) {\r\nresult = -EINVAL;\r\ngoto error;\r\n}\r\nresult = vendor_command(cyp, CYPRESS_WRITE_PORT, write_id,\r\n(unsigned char)value);\r\ndev_dbg(&cyp->udev->dev, "Result of vendor_command: %d\n\n", result);\r\nerror:\r\nreturn result < 0 ? result : count;\r\n}\r\nstatic ssize_t set_port0_handler(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nreturn write_port(dev, attr, buf, count, 0, CYPRESS_WRITE_PORT_ID0);\r\n}\r\nstatic ssize_t set_port1_handler(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nreturn write_port(dev, attr, buf, count, 1, CYPRESS_WRITE_PORT_ID1);\r\n}\r\nstatic ssize_t read_port(struct device *dev, struct device_attribute *attr,\r\nchar *buf, int port_num, int read_id)\r\n{\r\nint result = 0;\r\nstruct usb_interface *intf = to_usb_interface(dev);\r\nstruct cypress *cyp = usb_get_intfdata(intf);\r\ndev_dbg(&cyp->udev->dev, "READ_PORT%d called\n", port_num);\r\nresult = vendor_command(cyp, CYPRESS_READ_PORT, read_id, 0);\r\ndev_dbg(&cyp->udev->dev, "Result of vendor_command: %d\n\n", result);\r\nreturn sprintf(buf, "%d", cyp->port[port_num]);\r\n}\r\nstatic ssize_t get_port0_handler(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn read_port(dev, attr, buf, 0, CYPRESS_READ_PORT_ID0);\r\n}\r\nstatic ssize_t get_port1_handler(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn read_port(dev, attr, buf, 1, CYPRESS_READ_PORT_ID1);\r\n}\r\nstatic int cypress_probe(struct usb_interface *interface,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct cypress *dev = NULL;\r\nint retval = -ENOMEM;\r\ndev = kzalloc(sizeof(*dev), GFP_KERNEL);\r\nif (dev == NULL) {\r\ndev_err(&interface->dev, "Out of memory!\n");\r\ngoto error_mem;\r\n}\r\ndev->udev = usb_get_dev(interface_to_usbdev(interface));\r\nusb_set_intfdata(interface, dev);\r\nretval = device_create_file(&interface->dev, &dev_attr_port0);\r\nif (retval)\r\ngoto error;\r\nretval = device_create_file(&interface->dev, &dev_attr_port1);\r\nif (retval)\r\ngoto error;\r\ndev_info(&interface->dev,\r\n"Cypress CY7C63xxx device now attached\n");\r\nreturn 0;\r\nerror:\r\ndevice_remove_file(&interface->dev, &dev_attr_port0);\r\ndevice_remove_file(&interface->dev, &dev_attr_port1);\r\nusb_set_intfdata(interface, NULL);\r\nusb_put_dev(dev->udev);\r\nkfree(dev);\r\nerror_mem:\r\nreturn retval;\r\n}\r\nstatic void cypress_disconnect(struct usb_interface *interface)\r\n{\r\nstruct cypress *dev;\r\ndev = usb_get_intfdata(interface);\r\ndevice_remove_file(&interface->dev, &dev_attr_port0);\r\ndevice_remove_file(&interface->dev, &dev_attr_port1);\r\nusb_set_intfdata(interface, NULL);\r\nusb_put_dev(dev->udev);\r\ndev_info(&interface->dev,\r\n"Cypress CY7C63xxx device now disconnected\n");\r\nkfree(dev);\r\n}

int\r\nlwt_lookup_string (int *size, char *knl_ptr,\r\nchar *user_ptr, int user_size)\r\n{\r\nint maxsize = 128;\r\nif (!cfs_capable(CFS_CAP_SYS_ADMIN))\r\nreturn (-EPERM);\r\nif (user_size > 0 &&\r\nmaxsize > user_size)\r\nmaxsize = user_size;\r\n*size = strnlen (knl_ptr, maxsize - 1) + 1;\r\nif (user_ptr != NULL) {\r\nif (user_size < 4)\r\nreturn (-EINVAL);\r\nif (copy_to_user (user_ptr, knl_ptr, *size))\r\nreturn (-EFAULT);\r\nif (knl_ptr[*size - 1] != 0)\r\ncopy_to_user (user_ptr + *size - 4, "...", 4);\r\n}\r\nreturn (0);\r\n}\r\nint\r\nlwt_control (int enable, int clear)\r\n{\r\nlwt_page_t *p;\r\nint i;\r\nint j;\r\nif (!cfs_capable(CFS_CAP_SYS_ADMIN))\r\nreturn (-EPERM);\r\nif (!enable) {\r\nLWT_EVENT(0,0,0,0);\r\nlwt_enabled = 0;\r\nmb();\r\nschedule_timeout(10);\r\n}\r\nfor (i = 0; i < num_online_cpus(); i++) {\r\np = lwt_cpus[i].lwtc_current_page;\r\nif (p == NULL)\r\nreturn (-ENODATA);\r\nif (!clear)\r\ncontinue;\r\nfor (j = 0; j < lwt_pages_per_cpu; j++) {\r\nmemset (p->lwtp_events, 0, PAGE_CACHE_SIZE);\r\np = list_entry (p->lwtp_list.next,\r\nlwt_page_t, lwtp_list);\r\n}\r\n}\r\nif (enable) {\r\nlwt_enabled = 1;\r\nmb();\r\nLWT_EVENT(0,0,0,0);\r\n}\r\nreturn (0);\r\n}\r\nint\r\nlwt_snapshot (cfs_cycles_t *now, int *ncpu, int *total_size,\r\nvoid *user_ptr, int user_size)\r\n{\r\nconst int events_per_page = PAGE_CACHE_SIZE / sizeof(lwt_event_t);\r\nconst int bytes_per_page = events_per_page * sizeof(lwt_event_t);\r\nlwt_page_t *p;\r\nint i;\r\nint j;\r\nif (!cfs_capable(CFS_CAP_SYS_ADMIN))\r\nreturn (-EPERM);\r\n*ncpu = num_online_cpus();\r\n*total_size = num_online_cpus() * lwt_pages_per_cpu *\r\nbytes_per_page;\r\n*now = get_cycles();\r\nif (user_ptr == NULL)\r\nreturn (0);\r\nfor (i = 0; i < num_online_cpus(); i++) {\r\np = lwt_cpus[i].lwtc_current_page;\r\nif (p == NULL)\r\nreturn (-ENODATA);\r\nfor (j = 0; j < lwt_pages_per_cpu; j++) {\r\nif (copy_to_user(user_ptr, p->lwtp_events,\r\nbytes_per_page))\r\nreturn (-EFAULT);\r\nuser_ptr = ((char *)user_ptr) + bytes_per_page;\r\np = list_entry(p->lwtp_list.next,\r\nlwt_page_t, lwtp_list);\r\n}\r\n}\r\nreturn (0);\r\n}\r\nint\r\nlwt_init ()\r\n{\r\nint i;\r\nint j;\r\nfor (i = 0; i < num_online_cpus(); i++)\r\nif (lwt_cpus[i].lwtc_current_page != NULL)\r\nreturn (-EALREADY);\r\nLASSERT (!lwt_enabled);\r\nmemset (lwt_cpus, 0, sizeof (lwt_cpus));\r\nlwt_pages_per_cpu =\r\nLWT_MEMORY / (num_online_cpus() * PAGE_CACHE_SIZE);\r\nfor (i = 0; i < num_online_cpus(); i++)\r\nfor (j = 0; j < lwt_pages_per_cpu; j++) {\r\nstruct page *page = alloc_page (GFP_KERNEL);\r\nlwt_page_t *lwtp;\r\nif (page == NULL) {\r\nCERROR ("Can't allocate page\n");\r\nlwt_fini ();\r\nreturn (-ENOMEM);\r\n}\r\nLIBCFS_ALLOC(lwtp, sizeof (*lwtp));\r\nif (lwtp == NULL) {\r\nCERROR ("Can't allocate lwtp\n");\r\n__free_page(page);\r\nlwt_fini ();\r\nreturn (-ENOMEM);\r\n}\r\nlwtp->lwtp_page = page;\r\nlwtp->lwtp_events = page_address(page);\r\nmemset (lwtp->lwtp_events, 0, PAGE_CACHE_SIZE);\r\nif (j == 0) {\r\nINIT_LIST_HEAD (&lwtp->lwtp_list);\r\nlwt_cpus[i].lwtc_current_page = lwtp;\r\n} else {\r\nlist_add (&lwtp->lwtp_list,\r\n&lwt_cpus[i].lwtc_current_page->lwtp_list);\r\n}\r\n}\r\nlwt_enabled = 1;\r\nmb();\r\nLWT_EVENT(0,0,0,0);\r\nreturn (0);\r\n}\r\nvoid\r\nlwt_fini ()\r\n{\r\nint i;\r\nlwt_control(0, 0);\r\nfor (i = 0; i < num_online_cpus(); i++)\r\nwhile (lwt_cpus[i].lwtc_current_page != NULL) {\r\nlwt_page_t *lwtp = lwt_cpus[i].lwtc_current_page;\r\nif (list_empty (&lwtp->lwtp_list)) {\r\nlwt_cpus[i].lwtc_current_page = NULL;\r\n} else {\r\nlwt_cpus[i].lwtc_current_page =\r\nlist_entry (lwtp->lwtp_list.next,\r\nlwt_page_t, lwtp_list);\r\nlist_del (&lwtp->lwtp_list);\r\n}\r\n__free_page (lwtp->lwtp_page);\r\nLIBCFS_FREE (lwtp, sizeof (*lwtp));\r\n}\r\n}

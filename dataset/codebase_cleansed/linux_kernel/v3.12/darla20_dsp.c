static int init_hw(struct echoaudio *chip, u16 device_id, u16 subdevice_id)\r\n{\r\nint err;\r\nDE_INIT(("init_hw() - Darla20\n"));\r\nif (snd_BUG_ON((subdevice_id & 0xfff0) != DARLA20))\r\nreturn -ENODEV;\r\nif ((err = init_dsp_comm_page(chip))) {\r\nDE_INIT(("init_hw - could not initialize DSP comm page\n"));\r\nreturn err;\r\n}\r\nchip->device_id = device_id;\r\nchip->subdevice_id = subdevice_id;\r\nchip->bad_board = TRUE;\r\nchip->dsp_code_to_load = FW_DARLA20_DSP;\r\nchip->spdif_status = GD_SPDIF_STATUS_UNDEF;\r\nchip->clock_state = GD_CLOCK_UNDEF;\r\nchip->asic_loaded = TRUE;\r\nchip->input_clock_types = ECHO_CLOCK_BIT_INTERNAL;\r\nif ((err = load_firmware(chip)) < 0)\r\nreturn err;\r\nchip->bad_board = FALSE;\r\nDE_INIT(("init_hw done\n"));\r\nreturn err;\r\n}\r\nstatic int set_mixer_defaults(struct echoaudio *chip)\r\n{\r\nreturn init_line_levels(chip);\r\n}\r\nstatic u32 detect_input_clocks(const struct echoaudio *chip)\r\n{\r\nreturn ECHO_CLOCK_BIT_INTERNAL;\r\n}\r\nstatic int load_asic(struct echoaudio *chip)\r\n{\r\nreturn 0;\r\n}\r\nstatic int set_sample_rate(struct echoaudio *chip, u32 rate)\r\n{\r\nu8 clock_state, spdif_status;\r\nif (wait_handshake(chip))\r\nreturn -EIO;\r\nswitch (rate) {\r\ncase 44100:\r\nclock_state = GD_CLOCK_44;\r\nspdif_status = GD_SPDIF_STATUS_44;\r\nbreak;\r\ncase 48000:\r\nclock_state = GD_CLOCK_48;\r\nspdif_status = GD_SPDIF_STATUS_48;\r\nbreak;\r\ndefault:\r\nclock_state = GD_CLOCK_NOCHANGE;\r\nspdif_status = GD_SPDIF_STATUS_NOCHANGE;\r\nbreak;\r\n}\r\nif (chip->clock_state == clock_state)\r\nclock_state = GD_CLOCK_NOCHANGE;\r\nif (spdif_status == chip->spdif_status)\r\nspdif_status = GD_SPDIF_STATUS_NOCHANGE;\r\nchip->comm_page->sample_rate = cpu_to_le32(rate);\r\nchip->comm_page->gd_clock_state = clock_state;\r\nchip->comm_page->gd_spdif_status = spdif_status;\r\nchip->comm_page->gd_resampler_state = 3;\r\nif (clock_state != GD_CLOCK_NOCHANGE)\r\nchip->clock_state = clock_state;\r\nif (spdif_status != GD_SPDIF_STATUS_NOCHANGE)\r\nchip->spdif_status = spdif_status;\r\nchip->sample_rate = rate;\r\nclear_handshake(chip);\r\nreturn send_vector(chip, DSP_VC_SET_GD_AUDIO_STATE);\r\n}

irqreturn_t snd_sb8dsp_midi_interrupt(struct snd_sb *chip)\r\n{\r\nstruct snd_rawmidi *rmidi;\r\nint max = 64;\r\nchar byte;\r\nif (!chip)\r\nreturn IRQ_NONE;\r\nrmidi = chip->rmidi;\r\nif (!rmidi) {\r\ninb(SBP(chip, DATA_AVAIL));\r\nreturn IRQ_NONE;\r\n}\r\nspin_lock(&chip->midi_input_lock);\r\nwhile (max-- > 0) {\r\nif (inb(SBP(chip, DATA_AVAIL)) & 0x80) {\r\nbyte = inb(SBP(chip, READ));\r\nif (chip->open & SB_OPEN_MIDI_INPUT_TRIGGER) {\r\nsnd_rawmidi_receive(chip->midi_substream_input, &byte, 1);\r\n}\r\n}\r\n}\r\nspin_unlock(&chip->midi_input_lock);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int snd_sb8dsp_midi_input_open(struct snd_rawmidi_substream *substream)\r\n{\r\nunsigned long flags;\r\nstruct snd_sb *chip;\r\nunsigned int valid_open_flags;\r\nchip = substream->rmidi->private_data;\r\nvalid_open_flags = chip->hardware >= SB_HW_20\r\n? SB_OPEN_MIDI_OUTPUT | SB_OPEN_MIDI_OUTPUT_TRIGGER : 0;\r\nspin_lock_irqsave(&chip->open_lock, flags);\r\nif (chip->open & ~valid_open_flags) {\r\nspin_unlock_irqrestore(&chip->open_lock, flags);\r\nreturn -EAGAIN;\r\n}\r\nchip->open |= SB_OPEN_MIDI_INPUT;\r\nchip->midi_substream_input = substream;\r\nif (!(chip->open & SB_OPEN_MIDI_OUTPUT)) {\r\nspin_unlock_irqrestore(&chip->open_lock, flags);\r\nsnd_sbdsp_reset(chip);\r\nif (chip->hardware >= SB_HW_20)\r\nsnd_sbdsp_command(chip, SB_DSP_MIDI_UART_IRQ);\r\n} else {\r\nspin_unlock_irqrestore(&chip->open_lock, flags);\r\n}\r\nreturn 0;\r\n}\r\nstatic int snd_sb8dsp_midi_output_open(struct snd_rawmidi_substream *substream)\r\n{\r\nunsigned long flags;\r\nstruct snd_sb *chip;\r\nunsigned int valid_open_flags;\r\nchip = substream->rmidi->private_data;\r\nvalid_open_flags = chip->hardware >= SB_HW_20\r\n? SB_OPEN_MIDI_INPUT | SB_OPEN_MIDI_INPUT_TRIGGER : 0;\r\nspin_lock_irqsave(&chip->open_lock, flags);\r\nif (chip->open & ~valid_open_flags) {\r\nspin_unlock_irqrestore(&chip->open_lock, flags);\r\nreturn -EAGAIN;\r\n}\r\nchip->open |= SB_OPEN_MIDI_OUTPUT;\r\nchip->midi_substream_output = substream;\r\nif (!(chip->open & SB_OPEN_MIDI_INPUT)) {\r\nspin_unlock_irqrestore(&chip->open_lock, flags);\r\nsnd_sbdsp_reset(chip);\r\nif (chip->hardware >= SB_HW_20)\r\nsnd_sbdsp_command(chip, SB_DSP_MIDI_UART_IRQ);\r\n} else {\r\nspin_unlock_irqrestore(&chip->open_lock, flags);\r\n}\r\nreturn 0;\r\n}\r\nstatic int snd_sb8dsp_midi_input_close(struct snd_rawmidi_substream *substream)\r\n{\r\nunsigned long flags;\r\nstruct snd_sb *chip;\r\nchip = substream->rmidi->private_data;\r\nspin_lock_irqsave(&chip->open_lock, flags);\r\nchip->open &= ~(SB_OPEN_MIDI_INPUT | SB_OPEN_MIDI_INPUT_TRIGGER);\r\nchip->midi_substream_input = NULL;\r\nif (!(chip->open & SB_OPEN_MIDI_OUTPUT)) {\r\nspin_unlock_irqrestore(&chip->open_lock, flags);\r\nsnd_sbdsp_reset(chip);\r\n} else {\r\nspin_unlock_irqrestore(&chip->open_lock, flags);\r\n}\r\nreturn 0;\r\n}\r\nstatic int snd_sb8dsp_midi_output_close(struct snd_rawmidi_substream *substream)\r\n{\r\nunsigned long flags;\r\nstruct snd_sb *chip;\r\nchip = substream->rmidi->private_data;\r\nspin_lock_irqsave(&chip->open_lock, flags);\r\nchip->open &= ~(SB_OPEN_MIDI_OUTPUT | SB_OPEN_MIDI_OUTPUT_TRIGGER);\r\nchip->midi_substream_output = NULL;\r\nif (!(chip->open & SB_OPEN_MIDI_INPUT)) {\r\nspin_unlock_irqrestore(&chip->open_lock, flags);\r\nsnd_sbdsp_reset(chip);\r\n} else {\r\nspin_unlock_irqrestore(&chip->open_lock, flags);\r\n}\r\nreturn 0;\r\n}\r\nstatic void snd_sb8dsp_midi_input_trigger(struct snd_rawmidi_substream *substream, int up)\r\n{\r\nunsigned long flags;\r\nstruct snd_sb *chip;\r\nchip = substream->rmidi->private_data;\r\nspin_lock_irqsave(&chip->open_lock, flags);\r\nif (up) {\r\nif (!(chip->open & SB_OPEN_MIDI_INPUT_TRIGGER)) {\r\nif (chip->hardware < SB_HW_20)\r\nsnd_sbdsp_command(chip, SB_DSP_MIDI_INPUT_IRQ);\r\nchip->open |= SB_OPEN_MIDI_INPUT_TRIGGER;\r\n}\r\n} else {\r\nif (chip->open & SB_OPEN_MIDI_INPUT_TRIGGER) {\r\nif (chip->hardware < SB_HW_20)\r\nsnd_sbdsp_command(chip, SB_DSP_MIDI_INPUT_IRQ);\r\nchip->open &= ~SB_OPEN_MIDI_INPUT_TRIGGER;\r\n}\r\n}\r\nspin_unlock_irqrestore(&chip->open_lock, flags);\r\n}\r\nstatic void snd_sb8dsp_midi_output_write(struct snd_rawmidi_substream *substream)\r\n{\r\nunsigned long flags;\r\nstruct snd_sb *chip;\r\nchar byte;\r\nint max = 32;\r\nchip = substream->rmidi->private_data;\r\nwhile (max-- > 0) {\r\nspin_lock_irqsave(&chip->open_lock, flags);\r\nif (snd_rawmidi_transmit_peek(substream, &byte, 1) != 1) {\r\nchip->open &= ~SB_OPEN_MIDI_OUTPUT_TRIGGER;\r\ndel_timer(&chip->midi_timer);\r\nspin_unlock_irqrestore(&chip->open_lock, flags);\r\nbreak;\r\n}\r\nif (chip->hardware >= SB_HW_20) {\r\nint timeout = 8;\r\nwhile ((inb(SBP(chip, STATUS)) & 0x80) != 0 && --timeout > 0)\r\n;\r\nif (timeout == 0) {\r\nspin_unlock_irqrestore(&chip->open_lock, flags);\r\nbreak;\r\n}\r\noutb(byte, SBP(chip, WRITE));\r\n} else {\r\nsnd_sbdsp_command(chip, SB_DSP_MIDI_OUTPUT);\r\nsnd_sbdsp_command(chip, byte);\r\n}\r\nsnd_rawmidi_transmit_ack(substream, 1);\r\nspin_unlock_irqrestore(&chip->open_lock, flags);\r\n}\r\n}\r\nstatic void snd_sb8dsp_midi_output_timer(unsigned long data)\r\n{\r\nstruct snd_rawmidi_substream *substream = (struct snd_rawmidi_substream *) data;\r\nstruct snd_sb * chip = substream->rmidi->private_data;\r\nunsigned long flags;\r\nspin_lock_irqsave(&chip->open_lock, flags);\r\nchip->midi_timer.expires = 1 + jiffies;\r\nadd_timer(&chip->midi_timer);\r\nspin_unlock_irqrestore(&chip->open_lock, flags);\r\nsnd_sb8dsp_midi_output_write(substream);\r\n}\r\nstatic void snd_sb8dsp_midi_output_trigger(struct snd_rawmidi_substream *substream, int up)\r\n{\r\nunsigned long flags;\r\nstruct snd_sb *chip;\r\nchip = substream->rmidi->private_data;\r\nspin_lock_irqsave(&chip->open_lock, flags);\r\nif (up) {\r\nif (!(chip->open & SB_OPEN_MIDI_OUTPUT_TRIGGER)) {\r\ninit_timer(&chip->midi_timer);\r\nchip->midi_timer.function = snd_sb8dsp_midi_output_timer;\r\nchip->midi_timer.data = (unsigned long) substream;\r\nchip->midi_timer.expires = 1 + jiffies;\r\nadd_timer(&chip->midi_timer);\r\nchip->open |= SB_OPEN_MIDI_OUTPUT_TRIGGER;\r\n}\r\n} else {\r\nif (chip->open & SB_OPEN_MIDI_OUTPUT_TRIGGER) {\r\nchip->open &= ~SB_OPEN_MIDI_OUTPUT_TRIGGER;\r\n}\r\n}\r\nspin_unlock_irqrestore(&chip->open_lock, flags);\r\nif (up)\r\nsnd_sb8dsp_midi_output_write(substream);\r\n}\r\nint snd_sb8dsp_midi(struct snd_sb *chip, int device, struct snd_rawmidi ** rrawmidi)\r\n{\r\nstruct snd_rawmidi *rmidi;\r\nint err;\r\nif (rrawmidi)\r\n*rrawmidi = NULL;\r\nif ((err = snd_rawmidi_new(chip->card, "SB8 MIDI", device, 1, 1, &rmidi)) < 0)\r\nreturn err;\r\nstrcpy(rmidi->name, "SB8 MIDI");\r\nsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_OUTPUT, &snd_sb8dsp_midi_output);\r\nsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_INPUT, &snd_sb8dsp_midi_input);\r\nrmidi->info_flags |= SNDRV_RAWMIDI_INFO_OUTPUT | SNDRV_RAWMIDI_INFO_INPUT;\r\nif (chip->hardware >= SB_HW_20)\r\nrmidi->info_flags |= SNDRV_RAWMIDI_INFO_DUPLEX;\r\nrmidi->private_data = chip;\r\nchip->rmidi = rmidi;\r\nif (rrawmidi)\r\n*rrawmidi = rmidi;\r\nreturn 0;\r\n}

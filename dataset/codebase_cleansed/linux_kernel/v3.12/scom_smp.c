static scom_map_t get_scom(int cpu, struct device_node *np, int *first_thread)\r\n{\r\nscom_map_t scom = per_cpu(scom_ptrs, cpu);\r\nint tcpu;\r\nif (scom_map_ok(scom)) {\r\n*first_thread = 0;\r\nreturn scom;\r\n}\r\n*first_thread = 1;\r\nscom = scom_map_device(np, 0);\r\nfor (tcpu = cpu_first_thread_sibling(cpu);\r\ntcpu <= cpu_last_thread_sibling(cpu); tcpu++)\r\nper_cpu(scom_ptrs, tcpu) = scom;\r\nif (cpu_first_thread_sibling(cpu) == 0)\r\n*first_thread = 0;\r\nreturn scom;\r\n}\r\nstatic int a2_scom_ram(scom_map_t scom, int thread, u32 insn, int extmask)\r\n{\r\nu64 cmd, mask, val;\r\nint n = 0;\r\ncmd = ((u64)insn << 32) | (((u64)extmask & 0xf) << 28)\r\n| ((u64)thread << 17) | SCOM_RAMC_ENABLE | SCOM_RAMC_EXECUTE;\r\nmask = SCOM_RAMC_DONE | SCOM_RAMC_INTERRUPT | SCOM_RAMC_ERROR;\r\nscom_write(scom, SCOM_RAMIC, cmd);\r\nwhile (!((val = scom_read(scom, SCOM_RAMC)) & mask)) {\r\npr_devel("Waiting on RAMC = 0x%llx\n", val);\r\nif (++n == 3) {\r\npr_err("RAMC timeout on instruction 0x%08x, thread %d\n",\r\ninsn, thread);\r\nreturn -1;\r\n}\r\n}\r\nif (val & SCOM_RAMC_INTERRUPT) {\r\npr_err("RAMC interrupt on instruction 0x%08x, thread %d\n",\r\ninsn, thread);\r\nreturn -SCOM_RAMC_INTERRUPT;\r\n}\r\nif (val & SCOM_RAMC_ERROR) {\r\npr_err("RAMC error on instruction 0x%08x, thread %d\n",\r\ninsn, thread);\r\nreturn -SCOM_RAMC_ERROR;\r\n}\r\nreturn 0;\r\n}\r\nstatic int a2_scom_getgpr(scom_map_t scom, int thread, int gpr, int alt,\r\nu64 *out_gpr)\r\n{\r\nint rc;\r\nu32 insn = 0x7c000378 | (gpr << 21) | (gpr << 16) | (gpr << 11);\r\nrc = a2_scom_ram(scom, thread, insn, alt ? 0xf : 0x0);\r\nif (rc)\r\nreturn rc;\r\n*out_gpr = scom_read(scom, SCOM_RAMD);\r\nreturn 0;\r\n}\r\nstatic int a2_scom_getspr(scom_map_t scom, int thread, int spr, u64 *out_spr)\r\n{\r\nint rc, sprhi, sprlo;\r\nu32 insn;\r\nsprhi = spr >> 5;\r\nsprlo = spr & 0x1f;\r\ninsn = 0x7c2002a6 | (sprlo << 16) | (sprhi << 11);\r\nif (spr == 0x0ff0)\r\ninsn = 0x7c2000a6;\r\nrc = a2_scom_ram(scom, thread, insn, 0xf);\r\nif (rc)\r\nreturn rc;\r\nreturn a2_scom_getgpr(scom, thread, 1, 1, out_spr);\r\n}\r\nstatic int a2_scom_setgpr(scom_map_t scom, int thread, int gpr,\r\nint alt, u64 val)\r\n{\r\nu32 lis = 0x3c000000 | (gpr << 21);\r\nu32 li = 0x38000000 | (gpr << 21);\r\nu32 oris = 0x64000000 | (gpr << 21) | (gpr << 16);\r\nu32 ori = 0x60000000 | (gpr << 21) | (gpr << 16);\r\nu32 rldicr32 = 0x780007c6 | (gpr << 21) | (gpr << 16);\r\nu32 highest = val >> 48;\r\nu32 higher = (val >> 32) & 0xffff;\r\nu32 high = (val >> 16) & 0xffff;\r\nu32 low = val & 0xffff;\r\nint lext = alt ? 0x8 : 0x0;\r\nint oext = alt ? 0xf : 0x0;\r\nint rc = 0;\r\nif (highest)\r\nrc |= a2_scom_ram(scom, thread, lis | highest, lext);\r\nif (higher) {\r\nif (highest)\r\nrc |= a2_scom_ram(scom, thread, oris | higher, oext);\r\nelse\r\nrc |= a2_scom_ram(scom, thread, li | higher, lext);\r\n}\r\nif (highest || higher)\r\nrc |= a2_scom_ram(scom, thread, rldicr32, oext);\r\nif (high) {\r\nif (highest || higher)\r\nrc |= a2_scom_ram(scom, thread, oris | high, oext);\r\nelse\r\nrc |= a2_scom_ram(scom, thread, lis | high, lext);\r\n}\r\nif (highest || higher || high)\r\nrc |= a2_scom_ram(scom, thread, ori | low, oext);\r\nelse\r\nrc |= a2_scom_ram(scom, thread, li | low, lext);\r\nreturn rc;\r\n}\r\nstatic int a2_scom_setspr(scom_map_t scom, int thread, int spr, u64 val)\r\n{\r\nint sprhi = spr >> 5;\r\nint sprlo = spr & 0x1f;\r\nu32 insn = 0x7c2003a6 | (sprlo << 16) | (sprhi << 11);\r\nif (spr == 0x0ff0)\r\ninsn = 0x7c200124;\r\nif (a2_scom_setgpr(scom, thread, 1, 1, val))\r\nreturn -1;\r\nreturn a2_scom_ram(scom, thread, insn, 0xf);\r\n}\r\nstatic int a2_scom_initial_tlb(scom_map_t scom, int thread)\r\n{\r\nextern u32 a2_tlbinit_code_start[], a2_tlbinit_code_end[];\r\nextern u32 a2_tlbinit_after_iprot_flush[];\r\nextern u32 a2_tlbinit_after_linear_map[];\r\nu32 assoc, entries, i;\r\nu64 epn, tlbcfg;\r\nu32 *p;\r\nint rc;\r\nrc = a2_scom_getspr(scom, thread, SPRN_TLB0CFG, &tlbcfg);\r\nif (rc)\r\ngoto scom_fail;\r\nentries = tlbcfg & TLBnCFG_N_ENTRY;\r\nassoc = (tlbcfg & TLBnCFG_ASSOC) >> 24;\r\nepn = 0;\r\na2_scom_setspr(scom, thread, SPRN_MMUCR2, 0x000a7531);\r\na2_scom_setspr(scom, thread, SPRN_MMUCR3, 0x0000000f);\r\na2_scom_setspr(scom, thread, SPRN_MAS1, MAS1_TSIZE(BOOK3E_PAGESZ_1GB));\r\na2_scom_setspr(scom, thread, SPRN_MAS2, epn);\r\nfor (i = 0; i < entries; i++) {\r\na2_scom_setspr(scom, thread, SPRN_MAS0, MAS0_ESEL(i % assoc));\r\nrc = a2_scom_ram(scom, thread, 0x7c0007a4, 0);\r\nif (rc)\r\ngoto scom_fail;\r\nif((i + 1) % assoc == 0) {\r\nepn += (1 << 30);\r\na2_scom_setspr(scom, thread, SPRN_MAS2, epn);\r\n}\r\n}\r\nrc = a2_scom_setgpr(scom, thread, 3, 0, MAS0_TLBSEL(0));\r\nif (rc)\r\ngoto scom_fail;\r\nfor (p = a2_tlbinit_code_start; p < a2_tlbinit_after_linear_map; p++) {\r\nrc = a2_scom_ram(scom, thread, *p, 0);\r\nif (rc)\r\ngoto scom_fail;\r\n}\r\nfor (p = a2_tlbinit_after_iprot_flush; p < a2_tlbinit_code_end; p++) {\r\nrc = a2_scom_ram(scom, thread, *p, 0);\r\nif (rc)\r\ngoto scom_fail;\r\n}\r\nscom_fail:\r\nif (rc)\r\npr_err("Setting up initial TLB failed, err %d\n", rc);\r\nif (rc == -SCOM_RAMC_INTERRUPT) {\r\nint rc[10];\r\nu64 iar, srr0, srr1, esr, mas0, mas1, mas2, mas7_3, mas8, ccr2;\r\nrc[0] = a2_scom_getspr(scom, thread, SPRN_IAR, &iar);\r\nrc[1] = a2_scom_getspr(scom, thread, SPRN_SRR0, &srr0);\r\nrc[2] = a2_scom_getspr(scom, thread, SPRN_SRR1, &srr1);\r\nrc[3] = a2_scom_getspr(scom, thread, SPRN_ESR, &esr);\r\nrc[4] = a2_scom_getspr(scom, thread, SPRN_MAS0, &mas0);\r\nrc[5] = a2_scom_getspr(scom, thread, SPRN_MAS1, &mas1);\r\nrc[6] = a2_scom_getspr(scom, thread, SPRN_MAS2, &mas2);\r\nrc[7] = a2_scom_getspr(scom, thread, SPRN_MAS7_MAS3, &mas7_3);\r\nrc[8] = a2_scom_getspr(scom, thread, SPRN_MAS8, &mas8);\r\nrc[9] = a2_scom_getspr(scom, thread, SPRN_A2_CCR2, &ccr2);\r\npr_err(" -> retreived IAR =0x%llx (err %d)\n", iar, rc[0]);\r\npr_err(" retreived SRR0=0x%llx (err %d)\n", srr0, rc[1]);\r\npr_err(" retreived SRR1=0x%llx (err %d)\n", srr1, rc[2]);\r\npr_err(" retreived ESR =0x%llx (err %d)\n", esr, rc[3]);\r\npr_err(" retreived MAS0=0x%llx (err %d)\n", mas0, rc[4]);\r\npr_err(" retreived MAS1=0x%llx (err %d)\n", mas1, rc[5]);\r\npr_err(" retreived MAS2=0x%llx (err %d)\n", mas2, rc[6]);\r\npr_err(" retreived MS73=0x%llx (err %d)\n", mas7_3, rc[7]);\r\npr_err(" retreived MAS8=0x%llx (err %d)\n", mas8, rc[8]);\r\npr_err(" retreived CCR2=0x%llx (err %d)\n", ccr2, rc[9]);\r\n}\r\nreturn rc;\r\n}\r\nint a2_scom_startup_cpu(unsigned int lcpu, int thr_idx, struct device_node *np)\r\n{\r\nu64 init_iar, init_msr, init_ccr2;\r\nunsigned long start_here;\r\nint rc, core_setup;\r\nscom_map_t scom;\r\nu64 pccr0;\r\nscom = get_scom(lcpu, np, &core_setup);\r\nif (!scom) {\r\nprintk(KERN_ERR "Couldn't map SCOM for CPU%d\n", lcpu);\r\nreturn -1;\r\n}\r\npr_devel("Bringing up CPU%d using SCOM...\n", lcpu);\r\npccr0 = scom_read(scom, SCOM_PCCR0);\r\nscom_write(scom, SCOM_PCCR0, pccr0 | SCOM_PCCR0_ENABLE_DEBUG |\r\nSCOM_PCCR0_ENABLE_RAM);\r\nif (core_setup)\r\nscom_write(scom, SCOM_THRCTL_OR,\r\nSCOM_THRCTL_T0_STOP |\r\nSCOM_THRCTL_T1_STOP |\r\nSCOM_THRCTL_T2_STOP |\r\nSCOM_THRCTL_T3_STOP |\r\nSCOM_THRCTL_ASYNC_DIS);\r\nelse\r\nscom_write(scom, SCOM_THRCTL_OR, SCOM_THRCTL_T0_STOP >> thr_idx);\r\nscom_write(scom, SCOM_RAMC, ((u64)thr_idx << 17) |\r\nSCOM_RAMC_FLUSH | SCOM_RAMC_ENABLE);\r\na2_scom_getspr(scom, thr_idx, SPRN_IAR, &init_iar);\r\na2_scom_getspr(scom, thr_idx, 0x0ff0, &init_msr);\r\na2_scom_getspr(scom, thr_idx, SPRN_A2_CCR2, &init_ccr2);\r\nrc = a2_scom_setspr(scom, thr_idx, 0x0ff0, MSR_CM);\r\nif (rc) {\r\npr_err("Failed to set MSR ! err %d\n", rc);\r\nreturn rc;\r\n}\r\na2_scom_ram(scom, thr_idx, 0x7c0004ac, 0);\r\na2_scom_ram(scom, thr_idx, 0x4c00012c, 0);\r\nif (core_setup) {\r\npr_devel("CPU%d is first thread in core, initializing TLB...\n",\r\nlcpu);\r\nrc = a2_scom_initial_tlb(scom, thr_idx);\r\nif (rc)\r\ngoto fail;\r\n}\r\nstart_here = *(unsigned long *)(core_setup ? generic_secondary_smp_init\r\n: generic_secondary_thread_init);\r\npr_devel("CPU%d entry point at 0x%lx...\n", lcpu, start_here);\r\nrc |= a2_scom_setspr(scom, thr_idx, SPRN_IAR, start_here);\r\nrc |= a2_scom_setgpr(scom, thr_idx, 3, 0,\r\nget_hard_smp_processor_id(lcpu));\r\nrc |= a2_scom_setgpr(scom, thr_idx, 4, 0, 1);\r\nrc |= a2_scom_setspr(scom, thr_idx, SPRN_TENS, 0x1 << thr_idx);\r\nscom_write(scom, SCOM_RAMC, 0);\r\nscom_write(scom, SCOM_THRCTL_AND, ~(SCOM_THRCTL_T0_STOP >> thr_idx));\r\nscom_write(scom, SCOM_PCCR0, pccr0);\r\nfail:\r\npr_devel(" SCOM initialization %s\n", rc ? "failed" : "succeeded");\r\nif (rc) {\r\npr_err("Old IAR=0x%08llx MSR=0x%08llx CCR2=0x%08llx\n",\r\ninit_iar, init_msr, init_ccr2);\r\n}\r\nreturn rc;\r\n}

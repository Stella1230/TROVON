static struct sk_buff *mpls_gso_segment(struct sk_buff *skb,\r\nnetdev_features_t features)\r\n{\r\nstruct sk_buff *segs = ERR_PTR(-EINVAL);\r\nnetdev_features_t mpls_features;\r\n__be16 mpls_protocol;\r\nif (unlikely(skb_shinfo(skb)->gso_type &\r\n~(SKB_GSO_TCPV4 |\r\nSKB_GSO_TCPV6 |\r\nSKB_GSO_UDP |\r\nSKB_GSO_DODGY |\r\nSKB_GSO_TCP_ECN |\r\nSKB_GSO_GRE |\r\nSKB_GSO_MPLS)))\r\ngoto out;\r\nmpls_protocol = skb->protocol;\r\nskb->protocol = skb->inner_protocol;\r\n__skb_push(skb, skb->mac_len);\r\nmpls_features = skb->dev->mpls_features & netif_skb_features(skb);\r\nsegs = skb_mac_gso_segment(skb, mpls_features);\r\nskb->protocol = mpls_protocol;\r\n__skb_push(skb, skb->data - skb_mac_header(skb));\r\nout:\r\nreturn segs;\r\n}\r\nstatic int mpls_gso_send_check(struct sk_buff *skb)\r\n{\r\nreturn 0;\r\n}\r\nstatic int __init mpls_gso_init(void)\r\n{\r\npr_info("MPLS GSO support\n");\r\ndev_add_offload(&mpls_uc_offload);\r\ndev_add_offload(&mpls_mc_offload);\r\nreturn 0;\r\n}\r\nstatic void __exit mpls_gso_exit(void)\r\n{\r\ndev_remove_offload(&mpls_uc_offload);\r\ndev_remove_offload(&mpls_mc_offload);\r\n}

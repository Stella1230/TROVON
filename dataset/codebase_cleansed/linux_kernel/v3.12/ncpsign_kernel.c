static inline __u16\r\nWVAL_LH(const __u8 * buf, int pos)\r\n{\r\nreturn PVAL(buf, pos) | PVAL(buf, pos + 1) << 8;\r\n}\r\nstatic inline __u32\r\nDVAL_LH(const __u8 * buf, int pos)\r\n{\r\nreturn WVAL_LH(buf, pos) | WVAL_LH(buf, pos + 2) << 16;\r\n}\r\nstatic inline void\r\nWSET_LH(__u8 * buf, int pos, __u16 val)\r\n{\r\nBSET(buf, pos, val & 0xff);\r\nBSET(buf, pos + 1, val >> 8);\r\n}\r\nstatic inline void\r\nDSET_LH(__u8 * buf, int pos, __u32 val)\r\n{\r\nWSET_LH(buf, pos, val & 0xffff);\r\nWSET_LH(buf, pos + 2, val >> 16);\r\n}\r\nstatic void nwsign(char *r_data1, char *r_data2, char *outdata) {\r\nint i;\r\nunsigned int w0,w1,w2,w3;\r\nstatic int rbit[4]={0, 2, 1, 3};\r\n#ifdef __i386__\r\nunsigned int *data2=(unsigned int *)r_data2;\r\n#else\r\nunsigned int data2[16];\r\nfor (i=0;i<16;i++)\r\ndata2[i]=GET_LE32(r_data2+(i<<2));\r\n#endif\r\nw0=GET_LE32(r_data1);\r\nw1=GET_LE32(r_data1+4);\r\nw2=GET_LE32(r_data1+8);\r\nw3=GET_LE32(r_data1+12);\r\nfor (i=0;i<16;i+=4) {\r\nw0=rol32(w0 + ((w1 & w2) | ((~w1) & w3)) + data2[i+0],3);\r\nw3=rol32(w3 + ((w0 & w1) | ((~w0) & w2)) + data2[i+1],7);\r\nw2=rol32(w2 + ((w3 & w0) | ((~w3) & w1)) + data2[i+2],11);\r\nw1=rol32(w1 + ((w2 & w3) | ((~w2) & w0)) + data2[i+3],19);\r\n}\r\nfor (i=0;i<4;i++) {\r\nw0=rol32(w0 + (((w2 | w3) & w1) | (w2 & w3)) + 0x5a827999 + data2[i+0],3);\r\nw3=rol32(w3 + (((w1 | w2) & w0) | (w1 & w2)) + 0x5a827999 + data2[i+4],5);\r\nw2=rol32(w2 + (((w0 | w1) & w3) | (w0 & w1)) + 0x5a827999 + data2[i+8],9);\r\nw1=rol32(w1 + (((w3 | w0) & w2) | (w3 & w0)) + 0x5a827999 + data2[i+12],13);\r\n}\r\nfor (i=0;i<4;i++) {\r\nw0=rol32(w0 + ((w1 ^ w2) ^ w3) + 0x6ed9eba1 + data2[rbit[i]+0],3);\r\nw3=rol32(w3 + ((w0 ^ w1) ^ w2) + 0x6ed9eba1 + data2[rbit[i]+8],9);\r\nw2=rol32(w2 + ((w3 ^ w0) ^ w1) + 0x6ed9eba1 + data2[rbit[i]+4],11);\r\nw1=rol32(w1 + ((w2 ^ w3) ^ w0) + 0x6ed9eba1 + data2[rbit[i]+12],15);\r\n}\r\nPUT_LE32(outdata,(w0+GET_LE32(r_data1)) & 0xffffffff);\r\nPUT_LE32(outdata+4,(w1+GET_LE32(r_data1+4)) & 0xffffffff);\r\nPUT_LE32(outdata+8,(w2+GET_LE32(r_data1+8)) & 0xffffffff);\r\nPUT_LE32(outdata+12,(w3+GET_LE32(r_data1+12)) & 0xffffffff);\r\n}\r\nvoid __sign_packet(struct ncp_server *server, const char *packet, size_t size, __u32 totalsize, void *sign_buff) {\r\nunsigned char data[64];\r\nmemcpy(data, server->sign_root, 8);\r\n*(__u32*)(data + 8) = totalsize;\r\nif (size < 52) {\r\nmemcpy(data + 12, packet, size);\r\nmemset(data + 12 + size, 0, 52 - size);\r\n} else {\r\nmemcpy(data + 12, packet, 52);\r\n}\r\nnwsign(server->sign_last, data, server->sign_last);\r\nmemcpy(sign_buff, server->sign_last, 8);\r\n}\r\nint sign_verify_reply(struct ncp_server *server, const char *packet, size_t size, __u32 totalsize, const void *sign_buff) {\r\nunsigned char data[64];\r\nunsigned char hash[16];\r\nmemcpy(data, server->sign_root, 8);\r\n*(__u32*)(data + 8) = totalsize;\r\nif (size < 52) {\r\nmemcpy(data + 12, packet, size);\r\nmemset(data + 12 + size, 0, 52 - size);\r\n} else {\r\nmemcpy(data + 12, packet, 52);\r\n}\r\nnwsign(server->sign_last, data, hash);\r\nreturn memcmp(sign_buff, hash, 8);\r\n}

static void xilinx_pci_fixup_bridge(struct pci_dev *dev)\r\n{\r\nstruct pci_controller *hose;\r\nint i;\r\nif (dev->devfn || dev->bus->self)\r\nreturn;\r\nhose = pci_bus_to_host(dev->bus);\r\nif (!hose)\r\nreturn;\r\nif (!of_match_node(xilinx_pci_match, hose->dn))\r\nreturn;\r\nfor (i = 0; i < DEVICE_COUNT_RESOURCE; i++) {\r\ndev->resource[i].start = 0;\r\ndev->resource[i].end = 0;\r\ndev->resource[i].flags = 0;\r\n}\r\ndev_info(&dev->dev, "Hiding Xilinx plb-pci host bridge resources %s\n",\r\npci_name(dev));\r\n}\r\nstatic int\r\nxilinx_pci_exclude_device(struct pci_controller *hose, u_char bus, u8 devfn)\r\n{\r\nreturn (bus != 0);\r\n}\r\nvoid __init xilinx_pci_init(void)\r\n{\r\nstruct pci_controller *hose;\r\nstruct resource r;\r\nvoid __iomem *pci_reg;\r\nstruct device_node *pci_node;\r\npci_node = of_find_matching_node(NULL, xilinx_pci_match);\r\nif(!pci_node)\r\nreturn;\r\nif (of_address_to_resource(pci_node, 0, &r)) {\r\npr_err("xilinx-pci: cannot resolve base address\n");\r\nreturn;\r\n}\r\nhose = pcibios_alloc_controller(pci_node);\r\nif (!hose) {\r\npr_err("xilinx-pci: pcibios_alloc_controller() failed\n");\r\nreturn;\r\n}\r\nsetup_indirect_pci(hose, r.start + XPLB_PCI_ADDR,\r\nr.start + XPLB_PCI_DATA,\r\nPPC_INDIRECT_TYPE_SET_CFG_TYPE);\r\nearly_write_config_word(hose, 0, 0, PCI_COMMAND, PCI_HOST_ENABLE_CMD);\r\nearly_write_config_byte(hose, 0, 0, PCI_LATENCY_TIMER, 0xff);\r\npci_reg = of_iomap(pci_node, 0);\r\nout_8(pci_reg + XPLB_PCI_BUS, 0xff);\r\niounmap(pci_reg);\r\nif (!ppc_md.pci_exclude_device)\r\nppc_md.pci_exclude_device = xilinx_pci_exclude_device;\r\npci_process_bridge_OF_ranges(hose, pci_node, 1);\r\npr_info("xilinx-pci: Registered PCI host bridge\n");\r\n}

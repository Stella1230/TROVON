static void\r\nio7_device_interrupt(unsigned long vector)\r\n{\r\nunsigned int pid;\r\nunsigned int irq;\r\npid = vector >> 16;\r\nirq = ((vector & 0xffff) - 0x800) >> 4;\r\nirq += 16;\r\nirq &= MARVEL_IRQ_VEC_IRQ_MASK;\r\nirq |= pid << MARVEL_IRQ_VEC_PE_SHIFT;\r\nhandle_irq(irq);\r\n}\r\nstatic volatile unsigned long *\r\nio7_get_irq_ctl(unsigned int irq, struct io7 **pio7)\r\n{\r\nvolatile unsigned long *ctl;\r\nunsigned int pid;\r\nstruct io7 *io7;\r\npid = irq >> MARVEL_IRQ_VEC_PE_SHIFT;\r\nif (!(io7 = marvel_find_io7(pid))) {\r\nprintk(KERN_ERR\r\n"%s for nonexistent io7 -- vec %x, pid %d\n",\r\n__func__, irq, pid);\r\nreturn NULL;\r\n}\r\nirq &= MARVEL_IRQ_VEC_IRQ_MASK;\r\nirq -= 16;\r\nif (irq >= 0x180) {\r\nprintk(KERN_ERR\r\n"%s for invalid irq -- pid %d adjusted irq %x\n",\r\n__func__, pid, irq);\r\nreturn NULL;\r\n}\r\nctl = &io7->csrs->PO7_LSI_CTL[irq & 0xff].csr;\r\nif (irq >= 0x80)\r\nctl = &io7->csrs->PO7_MSI_CTL[((irq - 0x80) >> 5) & 0x0f].csr;\r\nif (pio7) *pio7 = io7;\r\nreturn ctl;\r\n}\r\nstatic void\r\nio7_enable_irq(struct irq_data *d)\r\n{\r\nvolatile unsigned long *ctl;\r\nunsigned int irq = d->irq;\r\nstruct io7 *io7;\r\nctl = io7_get_irq_ctl(irq, &io7);\r\nif (!ctl || !io7) {\r\nprintk(KERN_ERR "%s: get_ctl failed for irq %x\n",\r\n__func__, irq);\r\nreturn;\r\n}\r\nspin_lock(&io7->irq_lock);\r\n*ctl |= 1UL << 24;\r\nmb();\r\n*ctl;\r\nspin_unlock(&io7->irq_lock);\r\n}\r\nstatic void\r\nio7_disable_irq(struct irq_data *d)\r\n{\r\nvolatile unsigned long *ctl;\r\nunsigned int irq = d->irq;\r\nstruct io7 *io7;\r\nctl = io7_get_irq_ctl(irq, &io7);\r\nif (!ctl || !io7) {\r\nprintk(KERN_ERR "%s: get_ctl failed for irq %x\n",\r\n__func__, irq);\r\nreturn;\r\n}\r\nspin_lock(&io7->irq_lock);\r\n*ctl &= ~(1UL << 24);\r\nmb();\r\n*ctl;\r\nspin_unlock(&io7->irq_lock);\r\n}\r\nstatic void\r\nmarvel_irq_noop(struct irq_data *d)\r\n{\r\nreturn;\r\n}\r\nstatic void\r\nio7_redirect_irq(struct io7 *io7,\r\nvolatile unsigned long *csr,\r\nunsigned int where)\r\n{\r\nunsigned long val;\r\nval = *csr;\r\nval &= ~(0x1ffUL << 24);\r\nval |= ((unsigned long)where << 24);\r\n*csr = val;\r\nmb();\r\n*csr;\r\n}\r\nstatic void\r\nio7_redirect_one_lsi(struct io7 *io7, unsigned int which, unsigned int where)\r\n{\r\nunsigned long val;\r\nval = io7->csrs->PO7_LSI_CTL[which].csr;\r\nval &= ~(0x1ffUL << 14);\r\nval |= ((unsigned long)where << 14);\r\nio7->csrs->PO7_LSI_CTL[which].csr = val;\r\nmb();\r\nio7->csrs->PO7_LSI_CTL[which].csr;\r\n}\r\nstatic void\r\nio7_redirect_one_msi(struct io7 *io7, unsigned int which, unsigned int where)\r\n{\r\nunsigned long val;\r\nval = io7->csrs->PO7_MSI_CTL[which].csr;\r\nval &= ~(0x1ffUL << 14);\r\nval |= ((unsigned long)where << 14);\r\nio7->csrs->PO7_MSI_CTL[which].csr = val;\r\nmb();\r\nio7->csrs->PO7_MSI_CTL[which].csr;\r\n}\r\nstatic void __init\r\ninit_one_io7_lsi(struct io7 *io7, unsigned int which, unsigned int where)\r\n{\r\nio7->csrs->PO7_LSI_CTL[which].csr = ((unsigned long)where << 14);\r\nmb();\r\nio7->csrs->PO7_LSI_CTL[which].csr;\r\n}\r\nstatic void __init\r\ninit_one_io7_msi(struct io7 *io7, unsigned int which, unsigned int where)\r\n{\r\nio7->csrs->PO7_MSI_CTL[which].csr = ((unsigned long)where << 14);\r\nmb();\r\nio7->csrs->PO7_MSI_CTL[which].csr;\r\n}\r\nstatic void __init\r\ninit_io7_irqs(struct io7 *io7,\r\nstruct irq_chip *lsi_ops,\r\nstruct irq_chip *msi_ops)\r\n{\r\nlong base = (io7->pe << MARVEL_IRQ_VEC_PE_SHIFT) + 16;\r\nlong i;\r\nprintk("Initializing interrupts for IO7 at PE %u - base %lx\n",\r\nio7->pe, base);\r\nprintk(" Interrupts reported to CPU at PE %u\n", boot_cpuid);\r\nspin_lock(&io7->irq_lock);\r\nio7_redirect_irq(io7, &io7->csrs->HLT_CTL.csr, boot_cpuid);\r\nio7_redirect_irq(io7, &io7->csrs->HPI_CTL.csr, boot_cpuid);\r\nio7_redirect_irq(io7, &io7->csrs->CRD_CTL.csr, boot_cpuid);\r\nio7_redirect_irq(io7, &io7->csrs->STV_CTL.csr, boot_cpuid);\r\nio7_redirect_irq(io7, &io7->csrs->HEI_CTL.csr, boot_cpuid);\r\nfor (i = 0; i < 128; ++i) {\r\nirq_set_chip_and_handler(base + i, lsi_ops, handle_level_irq);\r\nirq_set_status_flags(i, IRQ_LEVEL);\r\n}\r\nfor (i = 0; i < 0x60; ++i)\r\ninit_one_io7_lsi(io7, i, boot_cpuid);\r\ninit_one_io7_lsi(io7, 0x74, boot_cpuid);\r\ninit_one_io7_lsi(io7, 0x75, boot_cpuid);\r\nfor (i = 128; i < (128 + 512); ++i) {\r\nirq_set_chip_and_handler(base + i, msi_ops, handle_level_irq);\r\nirq_set_status_flags(i, IRQ_LEVEL);\r\n}\r\nfor (i = 0; i < 16; ++i)\r\ninit_one_io7_msi(io7, i, boot_cpuid);\r\nspin_unlock(&io7->irq_lock);\r\n}\r\nstatic void __init\r\nmarvel_init_irq(void)\r\n{\r\nint i;\r\nstruct io7 *io7 = NULL;\r\nfor (i = 0; i < 16; ++i) {\r\nirq_set_chip_and_handler(i, &marvel_legacy_irq_type,\r\nhandle_level_irq);\r\n}\r\nfor (io7 = NULL; (io7 = marvel_next_io7(io7)) != NULL; )\r\ninit_io7_irqs(io7, &io7_lsi_irq_type, &io7_msi_irq_type);\r\n}\r\nstatic int\r\nmarvel_map_irq(const struct pci_dev *cdev, u8 slot, u8 pin)\r\n{\r\nstruct pci_dev *dev = (struct pci_dev *)cdev;\r\nstruct pci_controller *hose = dev->sysdata;\r\nstruct io7_port *io7_port = hose->sysdata;\r\nstruct io7 *io7 = io7_port->io7;\r\nint msi_loc, msi_data_off;\r\nu16 msg_ctl;\r\nu16 msg_dat;\r\nu8 intline;\r\nint irq;\r\npci_read_config_byte(dev, PCI_INTERRUPT_LINE, &intline);\r\nirq = intline;\r\nmsi_loc = pci_find_capability(dev, PCI_CAP_ID_MSI);\r\nmsg_ctl = 0;\r\nif (msi_loc)\r\npci_read_config_word(dev, msi_loc + PCI_MSI_FLAGS, &msg_ctl);\r\nif (msg_ctl & PCI_MSI_FLAGS_ENABLE) {\r\nmsi_data_off = PCI_MSI_DATA_32;\r\nif (msg_ctl & PCI_MSI_FLAGS_64BIT)\r\nmsi_data_off = PCI_MSI_DATA_64;\r\npci_read_config_word(dev, msi_loc + msi_data_off, &msg_dat);\r\nirq = msg_dat & 0x1ff;\r\nirq += 0x80;\r\n#if 1\r\nprintk("PCI:%d:%d:%d (hose %d) is using MSI\n",\r\ndev->bus->number,\r\nPCI_SLOT(dev->devfn),\r\nPCI_FUNC(dev->devfn),\r\nhose->index);\r\nprintk(" %d message(s) from 0x%04x\n",\r\n1 << ((msg_ctl & PCI_MSI_FLAGS_QSIZE) >> 4),\r\nmsg_dat);\r\nprintk(" reporting on %d IRQ(s) from %d (0x%x)\n",\r\n1 << ((msg_ctl & PCI_MSI_FLAGS_QSIZE) >> 4),\r\n(irq + 16) | (io7->pe << MARVEL_IRQ_VEC_PE_SHIFT),\r\n(irq + 16) | (io7->pe << MARVEL_IRQ_VEC_PE_SHIFT));\r\n#endif\r\n#if 0\r\npci_write_config_word(dev, msi_loc + PCI_MSI_FLAGS,\r\nmsg_ctl & ~PCI_MSI_FLAGS_ENABLE);\r\npci_read_config_byte(dev, PCI_INTERRUPT_LINE, &intline);\r\nirq = intline;\r\nprintk(" forcing LSI interrupt on irq %d [0x%x]\n", irq, irq);\r\n#endif\r\n}\r\nirq += 16;\r\nirq |= io7->pe << MARVEL_IRQ_VEC_PE_SHIFT;\r\nreturn irq;\r\n}\r\nstatic void __init\r\nmarvel_init_pci(void)\r\n{\r\nstruct io7 *io7;\r\nmarvel_register_error_handlers();\r\npci_set_flags(PCI_PROBE_ONLY);\r\ncommon_init_pci();\r\nlocate_and_init_vga(NULL);\r\nfor (io7 = NULL; (io7 = marvel_next_io7(io7)) != NULL; )\r\nio7_clear_errors(io7);\r\n}\r\nstatic void __init\r\nmarvel_init_rtc(void)\r\n{\r\ninit_rtc_irq();\r\n}\r\nstatic void\r\nsmp_get_rtc_time(void *data)\r\n{\r\nstruct marvel_rtc_time *mrt = data;\r\nmrt->retval = __get_rtc_time(mrt->time);\r\n}\r\nstatic void\r\nsmp_set_rtc_time(void *data)\r\n{\r\nstruct marvel_rtc_time *mrt = data;\r\nmrt->retval = __set_rtc_time(mrt->time);\r\n}\r\nstatic unsigned int\r\nmarvel_get_rtc_time(struct rtc_time *time)\r\n{\r\n#ifdef CONFIG_SMP\r\nstruct marvel_rtc_time mrt;\r\nif (smp_processor_id() != boot_cpuid) {\r\nmrt.time = time;\r\nsmp_call_function_single(boot_cpuid, smp_get_rtc_time, &mrt, 1);\r\nreturn mrt.retval;\r\n}\r\n#endif\r\nreturn __get_rtc_time(time);\r\n}\r\nstatic int\r\nmarvel_set_rtc_time(struct rtc_time *time)\r\n{\r\n#ifdef CONFIG_SMP\r\nstruct marvel_rtc_time mrt;\r\nif (smp_processor_id() != boot_cpuid) {\r\nmrt.time = time;\r\nsmp_call_function_single(boot_cpuid, smp_set_rtc_time, &mrt, 1);\r\nreturn mrt.retval;\r\n}\r\n#endif\r\nreturn __set_rtc_time(time);\r\n}\r\nstatic void\r\nmarvel_smp_callin(void)\r\n{\r\nint cpuid = hard_smp_processor_id();\r\nstruct io7 *io7 = marvel_find_io7(cpuid);\r\nunsigned int i;\r\nif (!io7)\r\nreturn;\r\nprintk("Redirecting IO7 interrupts to local CPU at PE %u\n", cpuid);\r\nio7_redirect_irq(io7, &io7->csrs->HLT_CTL.csr, cpuid);\r\nio7_redirect_irq(io7, &io7->csrs->HPI_CTL.csr, cpuid);\r\nio7_redirect_irq(io7, &io7->csrs->CRD_CTL.csr, cpuid);\r\nio7_redirect_irq(io7, &io7->csrs->STV_CTL.csr, cpuid);\r\nio7_redirect_irq(io7, &io7->csrs->HEI_CTL.csr, cpuid);\r\nfor (i = 0; i < 0x60; ++i)\r\nio7_redirect_one_lsi(io7, i, cpuid);\r\nio7_redirect_one_lsi(io7, 0x74, cpuid);\r\nio7_redirect_one_lsi(io7, 0x75, cpuid);\r\nfor (i = 0; i < 16; ++i)\r\nio7_redirect_one_msi(io7, i, cpuid);\r\n}

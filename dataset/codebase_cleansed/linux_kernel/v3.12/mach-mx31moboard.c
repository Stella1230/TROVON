static int moboard_uart0_init(struct platform_device *pdev)\r\n{\r\nint ret = gpio_request(IOMUX_TO_GPIO(MX31_PIN_CTS1), "uart0-cts-hack");\r\nif (ret)\r\nreturn ret;\r\nret = gpio_direction_output(IOMUX_TO_GPIO(MX31_PIN_CTS1), 0);\r\nif (ret)\r\ngpio_free(IOMUX_TO_GPIO(MX31_PIN_CTS1));\r\nreturn ret;\r\n}\r\nstatic void moboard_uart0_exit(struct platform_device *pdev)\r\n{\r\ngpio_free(IOMUX_TO_GPIO(MX31_PIN_CTS1));\r\n}\r\nstatic int moboard_sdhc1_get_ro(struct device *dev)\r\n{\r\nreturn !gpio_get_value(SDHC1_WP);\r\n}\r\nstatic int moboard_sdhc1_init(struct device *dev, irq_handler_t detect_irq,\r\nvoid *data)\r\n{\r\nint ret;\r\nret = gpio_request(SDHC1_CD, "sdhc-detect");\r\nif (ret)\r\nreturn ret;\r\ngpio_direction_input(SDHC1_CD);\r\nret = gpio_request(SDHC1_WP, "sdhc-wp");\r\nif (ret)\r\ngoto err_gpio_free;\r\ngpio_direction_input(SDHC1_WP);\r\nret = request_irq(gpio_to_irq(SDHC1_CD), detect_irq,\r\nIRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING,\r\n"sdhc1-card-detect", data);\r\nif (ret)\r\ngoto err_gpio_free_2;\r\nreturn 0;\r\nerr_gpio_free_2:\r\ngpio_free(SDHC1_WP);\r\nerr_gpio_free:\r\ngpio_free(SDHC1_CD);\r\nreturn ret;\r\n}\r\nstatic void moboard_sdhc1_exit(struct device *dev, void *data)\r\n{\r\nfree_irq(gpio_to_irq(SDHC1_CD), data);\r\ngpio_free(SDHC1_WP);\r\ngpio_free(SDHC1_CD);\r\n}\r\nstatic void usb_xcvr_reset(void)\r\n{\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_DATA0, USB_PAD_CFG | PAD_CTL_100K_PD);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_DATA1, USB_PAD_CFG | PAD_CTL_100K_PD);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_DATA2, USB_PAD_CFG | PAD_CTL_100K_PD);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_DATA3, USB_PAD_CFG | PAD_CTL_100K_PD);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_DATA4, USB_PAD_CFG | PAD_CTL_100K_PD);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_DATA5, USB_PAD_CFG | PAD_CTL_100K_PD);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_DATA6, USB_PAD_CFG | PAD_CTL_100K_PD);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_DATA7, USB_PAD_CFG | PAD_CTL_100K_PD);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_CLK, USB_PAD_CFG | PAD_CTL_100K_PU);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_DIR, USB_PAD_CFG | PAD_CTL_100K_PU);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_NXT, USB_PAD_CFG | PAD_CTL_100K_PU);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_STP, USB_PAD_CFG | PAD_CTL_100K_PU);\r\nmxc_iomux_set_gpr(MUX_PGP_UH2, true);\r\nmxc_iomux_set_pad(MX31_PIN_USBH2_CLK, USB_PAD_CFG | PAD_CTL_100K_PU);\r\nmxc_iomux_set_pad(MX31_PIN_USBH2_DIR, USB_PAD_CFG | PAD_CTL_100K_PU);\r\nmxc_iomux_set_pad(MX31_PIN_USBH2_NXT, USB_PAD_CFG | PAD_CTL_100K_PU);\r\nmxc_iomux_set_pad(MX31_PIN_USBH2_STP, USB_PAD_CFG | PAD_CTL_100K_PU);\r\nmxc_iomux_set_pad(MX31_PIN_USBH2_DATA0, USB_PAD_CFG | PAD_CTL_100K_PD);\r\nmxc_iomux_set_pad(MX31_PIN_USBH2_DATA1, USB_PAD_CFG | PAD_CTL_100K_PD);\r\nmxc_iomux_set_pad(MX31_PIN_SRXD6, USB_PAD_CFG | PAD_CTL_100K_PD);\r\nmxc_iomux_set_pad(MX31_PIN_STXD6, USB_PAD_CFG | PAD_CTL_100K_PD);\r\nmxc_iomux_set_pad(MX31_PIN_SFS3, USB_PAD_CFG | PAD_CTL_100K_PD);\r\nmxc_iomux_set_pad(MX31_PIN_SCK3, USB_PAD_CFG | PAD_CTL_100K_PD);\r\nmxc_iomux_set_pad(MX31_PIN_SRXD3, USB_PAD_CFG | PAD_CTL_100K_PD);\r\nmxc_iomux_set_pad(MX31_PIN_STXD3, USB_PAD_CFG | PAD_CTL_100K_PD);\r\ngpio_request(OTG_EN_B, "usb-udc-en");\r\ngpio_direction_output(OTG_EN_B, 0);\r\ngpio_request(USBH2_EN_B, "usbh2-en");\r\ngpio_direction_output(USBH2_EN_B, 0);\r\ngpio_request(USB_RESET_B, "usb-reset");\r\ngpio_direction_output(USB_RESET_B, 0);\r\nmdelay(1);\r\ngpio_set_value(USB_RESET_B, 1);\r\nmdelay(1);\r\n}\r\nstatic int moboard_usbh2_init_hw(struct platform_device *pdev)\r\n{\r\nreturn mx31_initialize_usb_hw(pdev->id, MXC_EHCI_POWER_PINS_ENABLED);\r\n}\r\nstatic int __init moboard_usbh2_init(void)\r\n{\r\nstruct platform_device *pdev;\r\nusbh2_pdata.otg = imx_otg_ulpi_create(ULPI_OTG_DRVVBUS |\r\nULPI_OTG_DRVVBUS_EXT);\r\nif (!usbh2_pdata.otg)\r\nreturn -ENODEV;\r\npdev = imx31_add_mxc_ehci_hs(2, &usbh2_pdata);\r\nif (IS_ERR(pdev))\r\nreturn PTR_ERR(pdev);\r\nreturn 0;\r\n}\r\nstatic int __init mx31moboard_init_cam(void)\r\n{\r\nint dma, ret = -ENOMEM;\r\nstruct platform_device *pdev;\r\nimx31_add_ipu_core();\r\npdev = imx31_alloc_mx3_camera(&camera_pdata);\r\nif (IS_ERR(pdev))\r\nreturn PTR_ERR(pdev);\r\ndma = dma_declare_coherent_memory(&pdev->dev,\r\nmx3_camera_base, mx3_camera_base,\r\nMX3_CAMERA_BUF_SIZE,\r\nDMA_MEMORY_MAP | DMA_MEMORY_EXCLUSIVE);\r\nif (!(dma & DMA_MEMORY_MAP))\r\ngoto err;\r\nret = platform_device_add(pdev);\r\nif (ret)\r\nerr:\r\nplatform_device_put(pdev);\r\nreturn ret;\r\n}\r\nstatic void mx31moboard_poweroff(void)\r\n{\r\nstruct clk *clk = clk_get_sys("imx2-wdt.0", NULL);\r\nif (!IS_ERR(clk))\r\nclk_prepare_enable(clk);\r\nmxc_iomux_mode(MX31_PIN_WATCHDOG_RST__WATCHDOG_RST);\r\n__raw_writew(1 << 6 | 1 << 2, MX31_IO_ADDRESS(MX31_WDOG_BASE_ADDR));\r\n}\r\nstatic void __init mx31moboard_init(void)\r\n{\r\nimx31_soc_init();\r\nmxc_iomux_setup_multiple_pins(moboard_pins, ARRAY_SIZE(moboard_pins),\r\n"moboard");\r\nplatform_add_devices(devices, ARRAY_SIZE(devices));\r\ngpio_led_register_device(-1, &mx31moboard_led_pdata);\r\nimx31_add_imx2_wdt();\r\nimx31_add_imx_uart0(&uart0_pdata);\r\nimx31_add_imx_uart4(&uart4_pdata);\r\nimx31_add_imx_i2c0(&moboard_i2c0_data);\r\nimx31_add_imx_i2c1(&moboard_i2c1_data);\r\nimx31_add_spi_imx1(&moboard_spi1_pdata);\r\nimx31_add_spi_imx2(&moboard_spi2_pdata);\r\ngpio_request(IOMUX_TO_GPIO(MX31_PIN_GPIO1_3), "pmic-irq");\r\ngpio_direction_input(IOMUX_TO_GPIO(MX31_PIN_GPIO1_3));\r\nmoboard_spi_board_info[0].irq =\r\ngpio_to_irq(IOMUX_TO_GPIO(MX31_PIN_GPIO1_3));\r\nspi_register_board_info(moboard_spi_board_info,\r\nARRAY_SIZE(moboard_spi_board_info));\r\nimx31_add_mxc_mmc(0, &sdhc1_pdata);\r\nmx31moboard_init_cam();\r\nusb_xcvr_reset();\r\nmoboard_usbh2_init();\r\nimx31_add_imx_ssi(0, &moboard_ssi_pdata);\r\nimx_add_platform_device("imx_mc13783", 0, NULL, 0, NULL, 0);\r\npm_power_off = mx31moboard_poweroff;\r\nswitch (mx31moboard_baseboard) {\r\ncase MX31NOBOARD:\r\nbreak;\r\ncase MX31DEVBOARD:\r\nmx31moboard_devboard_init();\r\nbreak;\r\ncase MX31MARXBOT:\r\nmx31moboard_marxbot_init();\r\nbreak;\r\ncase MX31SMARTBOT:\r\ncase MX31EYEBOT:\r\nmx31moboard_smartbot_init(mx31moboard_baseboard);\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "Illegal mx31moboard_baseboard type %d\n",\r\nmx31moboard_baseboard);\r\n}\r\n}\r\nstatic void __init mx31moboard_timer_init(void)\r\n{\r\nmx31_clocks_init(26000000);\r\n}\r\nstatic void __init mx31moboard_reserve(void)\r\n{\r\nmx3_camera_base = arm_memblock_steal(MX3_CAMERA_BUF_SIZE,\r\nMX3_CAMERA_BUF_SIZE);\r\n}

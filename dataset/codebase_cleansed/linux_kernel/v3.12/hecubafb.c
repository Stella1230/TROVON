static void apollo_send_data(struct hecubafb_par *par, unsigned char data)\r\n{\r\npar->board->set_data(par, data);\r\npar->board->set_ctl(par, HCB_DS_BIT, 0);\r\npar->board->wait_for_ack(par, 0);\r\npar->board->set_ctl(par, HCB_DS_BIT, 1);\r\npar->board->wait_for_ack(par, 1);\r\n}\r\nstatic void apollo_send_command(struct hecubafb_par *par, unsigned char data)\r\n{\r\npar->board->set_ctl(par, HCB_CD_BIT, 1);\r\napollo_send_data(par, data);\r\npar->board->set_ctl(par, HCB_CD_BIT, 0);\r\n}\r\nstatic void hecubafb_dpy_update(struct hecubafb_par *par)\r\n{\r\nint i;\r\nunsigned char *buf = (unsigned char __force *)par->info->screen_base;\r\napollo_send_command(par, APOLLO_START_NEW_IMG);\r\nfor (i=0; i < (DPY_W*DPY_H/8); i++) {\r\napollo_send_data(par, *(buf++));\r\n}\r\napollo_send_command(par, APOLLO_STOP_IMG_DATA);\r\napollo_send_command(par, APOLLO_DISPLAY_IMG);\r\n}\r\nstatic void hecubafb_dpy_deferred_io(struct fb_info *info,\r\nstruct list_head *pagelist)\r\n{\r\nhecubafb_dpy_update(info->par);\r\n}\r\nstatic void hecubafb_fillrect(struct fb_info *info,\r\nconst struct fb_fillrect *rect)\r\n{\r\nstruct hecubafb_par *par = info->par;\r\nsys_fillrect(info, rect);\r\nhecubafb_dpy_update(par);\r\n}\r\nstatic void hecubafb_copyarea(struct fb_info *info,\r\nconst struct fb_copyarea *area)\r\n{\r\nstruct hecubafb_par *par = info->par;\r\nsys_copyarea(info, area);\r\nhecubafb_dpy_update(par);\r\n}\r\nstatic void hecubafb_imageblit(struct fb_info *info,\r\nconst struct fb_image *image)\r\n{\r\nstruct hecubafb_par *par = info->par;\r\nsys_imageblit(info, image);\r\nhecubafb_dpy_update(par);\r\n}\r\nstatic ssize_t hecubafb_write(struct fb_info *info, const char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct hecubafb_par *par = info->par;\r\nunsigned long p = *ppos;\r\nvoid *dst;\r\nint err = 0;\r\nunsigned long total_size;\r\nif (info->state != FBINFO_STATE_RUNNING)\r\nreturn -EPERM;\r\ntotal_size = info->fix.smem_len;\r\nif (p > total_size)\r\nreturn -EFBIG;\r\nif (count > total_size) {\r\nerr = -EFBIG;\r\ncount = total_size;\r\n}\r\nif (count + p > total_size) {\r\nif (!err)\r\nerr = -ENOSPC;\r\ncount = total_size - p;\r\n}\r\ndst = (void __force *) (info->screen_base + p);\r\nif (copy_from_user(dst, buf, count))\r\nerr = -EFAULT;\r\nif (!err)\r\n*ppos += count;\r\nhecubafb_dpy_update(par);\r\nreturn (err) ? err : count;\r\n}\r\nstatic int hecubafb_probe(struct platform_device *dev)\r\n{\r\nstruct fb_info *info;\r\nstruct hecuba_board *board;\r\nint retval = -ENOMEM;\r\nint videomemorysize;\r\nunsigned char *videomemory;\r\nstruct hecubafb_par *par;\r\nboard = dev->dev.platform_data;\r\nif (!board)\r\nreturn -EINVAL;\r\nif (!try_module_get(board->owner))\r\nreturn -ENODEV;\r\nvideomemorysize = (DPY_W*DPY_H)/8;\r\nvideomemory = vzalloc(videomemorysize);\r\nif (!videomemory)\r\ngoto err_videomem_alloc;\r\ninfo = framebuffer_alloc(sizeof(struct hecubafb_par), &dev->dev);\r\nif (!info)\r\ngoto err_fballoc;\r\ninfo->screen_base = (char __force __iomem *)videomemory;\r\ninfo->fbops = &hecubafb_ops;\r\ninfo->var = hecubafb_var;\r\ninfo->fix = hecubafb_fix;\r\ninfo->fix.smem_len = videomemorysize;\r\npar = info->par;\r\npar->info = info;\r\npar->board = board;\r\npar->send_command = apollo_send_command;\r\npar->send_data = apollo_send_data;\r\ninfo->flags = FBINFO_FLAG_DEFAULT | FBINFO_VIRTFB;\r\ninfo->fbdefio = &hecubafb_defio;\r\nfb_deferred_io_init(info);\r\nretval = register_framebuffer(info);\r\nif (retval < 0)\r\ngoto err_fbreg;\r\nplatform_set_drvdata(dev, info);\r\nprintk(KERN_INFO\r\n"fb%d: Hecuba frame buffer device, using %dK of video memory\n",\r\ninfo->node, videomemorysize >> 10);\r\nretval = par->board->init(par);\r\nif (retval < 0)\r\ngoto err_fbreg;\r\nreturn 0;\r\nerr_fbreg:\r\nframebuffer_release(info);\r\nerr_fballoc:\r\nvfree(videomemory);\r\nerr_videomem_alloc:\r\nmodule_put(board->owner);\r\nreturn retval;\r\n}\r\nstatic int hecubafb_remove(struct platform_device *dev)\r\n{\r\nstruct fb_info *info = platform_get_drvdata(dev);\r\nif (info) {\r\nstruct hecubafb_par *par = info->par;\r\nfb_deferred_io_cleanup(info);\r\nunregister_framebuffer(info);\r\nvfree((void __force *)info->screen_base);\r\nif (par->board->remove)\r\npar->board->remove(par);\r\nmodule_put(par->board->owner);\r\nframebuffer_release(info);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init hecubafb_init(void)\r\n{\r\nreturn platform_driver_register(&hecubafb_driver);\r\n}\r\nstatic void __exit hecubafb_exit(void)\r\n{\r\nplatform_driver_unregister(&hecubafb_driver);\r\n}

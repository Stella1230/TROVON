unsigned long r3k_cache_size(unsigned long ca_flags)\r\n{\r\nunsigned long flags, status, dummy, size;\r\nvolatile unsigned long *p;\r\np = (volatile unsigned long *) KSEG0;\r\nflags = read_c0_status();\r\nwrite_c0_status((ca_flags|flags)&~ST0_IEC);\r\n*p = 0xa5a55a5a;\r\ndummy = *p;\r\nstatus = read_c0_status();\r\nif (dummy != 0xa5a55a5a || (status & ST0_CM)) {\r\nsize = 0;\r\n} else {\r\nfor (size = 128; size <= 0x40000; size <<= 1)\r\n*(p + size) = 0;\r\n*p = -1;\r\nfor (size = 128;\r\n(size <= 0x40000) && (*(p + size) == 0);\r\nsize <<= 1)\r\n;\r\nif (size > 0x40000)\r\nsize = 0;\r\n}\r\nwrite_c0_status(flags);\r\nreturn size * sizeof(*p);\r\n}\r\nunsigned long r3k_cache_lsize(unsigned long ca_flags)\r\n{\r\nunsigned long flags, status, lsize, i;\r\nvolatile unsigned long *p;\r\np = (volatile unsigned long *) KSEG0;\r\nflags = read_c0_status();\r\nwrite_c0_status((ca_flags|flags)&~ST0_IEC);\r\nfor (i = 0; i < 128; i++)\r\n*(p + i) = 0;\r\n*(volatile unsigned char *)p = 0;\r\nfor (lsize = 1; lsize < 128; lsize <<= 1) {\r\n*(p + lsize);\r\nstatus = read_c0_status();\r\nif (!(status & ST0_CM))\r\nbreak;\r\n}\r\nfor (i = 0; i < 128; i += lsize)\r\n*(volatile unsigned char *)(p + i) = 0;\r\nwrite_c0_status(flags);\r\nreturn lsize * sizeof(*p);\r\n}\r\nstatic void r3k_probe_cache(void)\r\n{\r\ndcache_size = r3k_cache_size(ST0_ISC);\r\nif (dcache_size)\r\ndcache_lsize = r3k_cache_lsize(ST0_ISC);\r\nicache_size = r3k_cache_size(ST0_ISC|ST0_SWC);\r\nif (icache_size)\r\nicache_lsize = r3k_cache_lsize(ST0_ISC|ST0_SWC);\r\n}\r\nstatic void r3k_flush_icache_range(unsigned long start, unsigned long end)\r\n{\r\nunsigned long size, i, flags;\r\nvolatile unsigned char *p;\r\nsize = end - start;\r\nif (size > icache_size || KSEGX(start) != KSEG0) {\r\nstart = KSEG0;\r\nsize = icache_size;\r\n}\r\np = (char *)start;\r\nflags = read_c0_status();\r\nwrite_c0_status((ST0_ISC|ST0_SWC|flags)&~ST0_IEC);\r\nfor (i = 0; i < size; i += 0x080) {\r\nasm( "sb\t$0, 0x000(%0)\n\t"\r\n"sb\t$0, 0x004(%0)\n\t"\r\n"sb\t$0, 0x008(%0)\n\t"\r\n"sb\t$0, 0x00c(%0)\n\t"\r\n"sb\t$0, 0x010(%0)\n\t"\r\n"sb\t$0, 0x014(%0)\n\t"\r\n"sb\t$0, 0x018(%0)\n\t"\r\n"sb\t$0, 0x01c(%0)\n\t"\r\n"sb\t$0, 0x020(%0)\n\t"\r\n"sb\t$0, 0x024(%0)\n\t"\r\n"sb\t$0, 0x028(%0)\n\t"\r\n"sb\t$0, 0x02c(%0)\n\t"\r\n"sb\t$0, 0x030(%0)\n\t"\r\n"sb\t$0, 0x034(%0)\n\t"\r\n"sb\t$0, 0x038(%0)\n\t"\r\n"sb\t$0, 0x03c(%0)\n\t"\r\n"sb\t$0, 0x040(%0)\n\t"\r\n"sb\t$0, 0x044(%0)\n\t"\r\n"sb\t$0, 0x048(%0)\n\t"\r\n"sb\t$0, 0x04c(%0)\n\t"\r\n"sb\t$0, 0x050(%0)\n\t"\r\n"sb\t$0, 0x054(%0)\n\t"\r\n"sb\t$0, 0x058(%0)\n\t"\r\n"sb\t$0, 0x05c(%0)\n\t"\r\n"sb\t$0, 0x060(%0)\n\t"\r\n"sb\t$0, 0x064(%0)\n\t"\r\n"sb\t$0, 0x068(%0)\n\t"\r\n"sb\t$0, 0x06c(%0)\n\t"\r\n"sb\t$0, 0x070(%0)\n\t"\r\n"sb\t$0, 0x074(%0)\n\t"\r\n"sb\t$0, 0x078(%0)\n\t"\r\n"sb\t$0, 0x07c(%0)\n\t"\r\n: : "r" (p) );\r\np += 0x080;\r\n}\r\nwrite_c0_status(flags);\r\n}\r\nstatic void r3k_flush_dcache_range(unsigned long start, unsigned long end)\r\n{\r\nunsigned long size, i, flags;\r\nvolatile unsigned char *p;\r\nsize = end - start;\r\nif (size > dcache_size || KSEGX(start) != KSEG0) {\r\nstart = KSEG0;\r\nsize = dcache_size;\r\n}\r\np = (char *)start;\r\nflags = read_c0_status();\r\nwrite_c0_status((ST0_ISC|flags)&~ST0_IEC);\r\nfor (i = 0; i < size; i += 0x080) {\r\nasm( "sb\t$0, 0x000(%0)\n\t"\r\n"sb\t$0, 0x004(%0)\n\t"\r\n"sb\t$0, 0x008(%0)\n\t"\r\n"sb\t$0, 0x00c(%0)\n\t"\r\n"sb\t$0, 0x010(%0)\n\t"\r\n"sb\t$0, 0x014(%0)\n\t"\r\n"sb\t$0, 0x018(%0)\n\t"\r\n"sb\t$0, 0x01c(%0)\n\t"\r\n"sb\t$0, 0x020(%0)\n\t"\r\n"sb\t$0, 0x024(%0)\n\t"\r\n"sb\t$0, 0x028(%0)\n\t"\r\n"sb\t$0, 0x02c(%0)\n\t"\r\n"sb\t$0, 0x030(%0)\n\t"\r\n"sb\t$0, 0x034(%0)\n\t"\r\n"sb\t$0, 0x038(%0)\n\t"\r\n"sb\t$0, 0x03c(%0)\n\t"\r\n"sb\t$0, 0x040(%0)\n\t"\r\n"sb\t$0, 0x044(%0)\n\t"\r\n"sb\t$0, 0x048(%0)\n\t"\r\n"sb\t$0, 0x04c(%0)\n\t"\r\n"sb\t$0, 0x050(%0)\n\t"\r\n"sb\t$0, 0x054(%0)\n\t"\r\n"sb\t$0, 0x058(%0)\n\t"\r\n"sb\t$0, 0x05c(%0)\n\t"\r\n"sb\t$0, 0x060(%0)\n\t"\r\n"sb\t$0, 0x064(%0)\n\t"\r\n"sb\t$0, 0x068(%0)\n\t"\r\n"sb\t$0, 0x06c(%0)\n\t"\r\n"sb\t$0, 0x070(%0)\n\t"\r\n"sb\t$0, 0x074(%0)\n\t"\r\n"sb\t$0, 0x078(%0)\n\t"\r\n"sb\t$0, 0x07c(%0)\n\t"\r\n: : "r" (p) );\r\np += 0x080;\r\n}\r\nwrite_c0_status(flags);\r\n}\r\nstatic inline void r3k_flush_cache_all(void)\r\n{\r\n}\r\nstatic inline void r3k___flush_cache_all(void)\r\n{\r\nr3k_flush_dcache_range(KSEG0, KSEG0 + dcache_size);\r\nr3k_flush_icache_range(KSEG0, KSEG0 + icache_size);\r\n}\r\nstatic void r3k_flush_cache_mm(struct mm_struct *mm)\r\n{\r\n}\r\nstatic void r3k_flush_cache_range(struct vm_area_struct *vma,\r\nunsigned long start, unsigned long end)\r\n{\r\n}\r\nstatic void r3k_flush_cache_page(struct vm_area_struct *vma,\r\nunsigned long addr, unsigned long pfn)\r\n{\r\nunsigned long kaddr = KSEG0ADDR(pfn << PAGE_SHIFT);\r\nint exec = vma->vm_flags & VM_EXEC;\r\nstruct mm_struct *mm = vma->vm_mm;\r\npgd_t *pgdp;\r\npud_t *pudp;\r\npmd_t *pmdp;\r\npte_t *ptep;\r\npr_debug("cpage[%08lx,%08lx]\n",\r\ncpu_context(smp_processor_id(), mm), addr);\r\nif (cpu_context(smp_processor_id(), mm) == 0)\r\nreturn;\r\npgdp = pgd_offset(mm, addr);\r\npudp = pud_offset(pgdp, addr);\r\npmdp = pmd_offset(pudp, addr);\r\nptep = pte_offset(pmdp, addr);\r\nif (!(pte_val(*ptep) & _PAGE_PRESENT))\r\nreturn;\r\nr3k_flush_dcache_range(kaddr, kaddr + PAGE_SIZE);\r\nif (exec)\r\nr3k_flush_icache_range(kaddr, kaddr + PAGE_SIZE);\r\n}\r\nstatic void local_r3k_flush_data_cache_page(void *addr)\r\n{\r\n}\r\nstatic void r3k_flush_data_cache_page(unsigned long addr)\r\n{\r\n}\r\nstatic void r3k_flush_cache_sigtramp(unsigned long addr)\r\n{\r\nunsigned long flags;\r\npr_debug("csigtramp[%08lx]\n", addr);\r\nflags = read_c0_status();\r\nwrite_c0_status(flags&~ST0_IEC);\r\nasm( "lw\t$0, 0x000(%0)\n\t"\r\n"lw\t$0, 0x004(%0)\n\t"\r\n: : "r" (addr) );\r\nwrite_c0_status((ST0_ISC|ST0_SWC|flags)&~ST0_IEC);\r\nasm( "sb\t$0, 0x000(%0)\n\t"\r\n"sb\t$0, 0x004(%0)\n\t"\r\n: : "r" (addr) );\r\nwrite_c0_status(flags);\r\n}\r\nstatic void r3k_flush_kernel_vmap_range(unsigned long vaddr, int size)\r\n{\r\nBUG();\r\n}\r\nstatic void r3k_dma_cache_wback_inv(unsigned long start, unsigned long size)\r\n{\r\nBUG_ON(size == 0);\r\niob();\r\nr3k_flush_dcache_range(start, start + size);\r\n}\r\nvoid r3k_cache_init(void)\r\n{\r\nextern void build_clear_page(void);\r\nextern void build_copy_page(void);\r\nr3k_probe_cache();\r\nflush_cache_all = r3k_flush_cache_all;\r\n__flush_cache_all = r3k___flush_cache_all;\r\nflush_cache_mm = r3k_flush_cache_mm;\r\nflush_cache_range = r3k_flush_cache_range;\r\nflush_cache_page = r3k_flush_cache_page;\r\nflush_icache_range = r3k_flush_icache_range;\r\nlocal_flush_icache_range = r3k_flush_icache_range;\r\n__flush_kernel_vmap_range = r3k_flush_kernel_vmap_range;\r\nflush_cache_sigtramp = r3k_flush_cache_sigtramp;\r\nlocal_flush_data_cache_page = local_r3k_flush_data_cache_page;\r\nflush_data_cache_page = r3k_flush_data_cache_page;\r\n_dma_cache_wback_inv = r3k_dma_cache_wback_inv;\r\n_dma_cache_wback = r3k_dma_cache_wback_inv;\r\n_dma_cache_inv = r3k_dma_cache_wback_inv;\r\nprintk("Primary instruction cache %ldkB, linesize %ld bytes.\n",\r\nicache_size >> 10, icache_lsize);\r\nprintk("Primary data cache %ldkB, linesize %ld bytes.\n",\r\ndcache_size >> 10, dcache_lsize);\r\nbuild_clear_page();\r\nbuild_copy_page();\r\n}

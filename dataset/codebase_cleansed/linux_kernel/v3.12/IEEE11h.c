static bool s_bRxMSRReq(PSMgmtObject pMgmt, PWLAN_FRAME_MSRREQ pMSRReq,\r\nunsigned int uLength)\r\n{\r\nsize_t uNumOfEIDs = 0;\r\nbool bResult = true;\r\nif (uLength <= WLAN_A3FR_MAXLEN)\r\nmemcpy(pMgmt->abyCurrentMSRReq, pMSRReq, uLength);\r\nuNumOfEIDs = ((uLength - offsetof(WLAN_FRAME_MSRREQ,\r\nsMSRReqEIDs))/\r\n(sizeof(WLAN_IE_MEASURE_REQ)));\r\npMgmt->pCurrMeasureEIDRep = &(((PWLAN_FRAME_MSRREP)\r\n(pMgmt->abyCurrentMSRRep))->sMSRRepEIDs[0]);\r\npMgmt->uLengthOfRepEIDs = 0;\r\nbResult = CARDbStartMeasure(pMgmt->pAdapter,\r\n((PWLAN_FRAME_MSRREQ)\r\n(pMgmt->abyCurrentMSRReq))->sMSRReqEIDs,\r\nuNumOfEIDs\r\n);\r\nreturn bResult;\r\n}\r\nstatic bool s_bRxTPCReq(PSMgmtObject pMgmt,\r\nPWLAN_FRAME_TPCREQ pTPCReq,\r\nunsigned char byRate,\r\nunsigned char byRSSI)\r\n{\r\nPWLAN_FRAME_TPCREP pFrame;\r\nPSTxMgmtPacket pTxPacket = NULL;\r\npTxPacket = (PSTxMgmtPacket)pMgmt->pbyMgmtPacketPool;\r\nmemset(pTxPacket, 0, sizeof(STxMgmtPacket) + WLAN_A3FR_MAXLEN);\r\npTxPacket->p80211Header = (PUWLAN_80211HDR)((unsigned char *)pTxPacket +\r\nsizeof(STxMgmtPacket));\r\npFrame = (PWLAN_FRAME_TPCREP)((unsigned char *)pTxPacket +\r\nsizeof(STxMgmtPacket));\r\npFrame->Header.wFrameCtl = (WLAN_SET_FC_FTYPE(WLAN_FTYPE_MGMT) |\r\nWLAN_SET_FC_FSTYPE(WLAN_FSTYPE_ACTION)\r\n);\r\nmemcpy(pFrame->Header.abyAddr1,\r\npTPCReq->Header.abyAddr2,\r\nWLAN_ADDR_LEN);\r\nmemcpy(pFrame->Header.abyAddr2,\r\nCARDpGetCurrentAddress(pMgmt->pAdapter),\r\nWLAN_ADDR_LEN);\r\nmemcpy(pFrame->Header.abyAddr3,\r\npMgmt->abyCurrBSSID,\r\nWLAN_BSSID_LEN);\r\npFrame->byCategory = 0;\r\npFrame->byAction = 3;\r\npFrame->byDialogToken = ((PWLAN_FRAME_MSRREQ)\r\n(pMgmt->abyCurrentMSRReq))->byDialogToken;\r\npFrame->sTPCRepEIDs.byElementID = WLAN_EID_TPC_REP;\r\npFrame->sTPCRepEIDs.len = 2;\r\npFrame->sTPCRepEIDs.byTxPower = CARDbyGetTransmitPower(pMgmt->pAdapter);\r\nswitch (byRate) {\r\ncase RATE_54M:\r\npFrame->sTPCRepEIDs.byLinkMargin = 65 - byRSSI;\r\nbreak;\r\ncase RATE_48M:\r\npFrame->sTPCRepEIDs.byLinkMargin = 66 - byRSSI;\r\nbreak;\r\ncase RATE_36M:\r\npFrame->sTPCRepEIDs.byLinkMargin = 70 - byRSSI;\r\nbreak;\r\ncase RATE_24M:\r\npFrame->sTPCRepEIDs.byLinkMargin = 74 - byRSSI;\r\nbreak;\r\ncase RATE_18M:\r\npFrame->sTPCRepEIDs.byLinkMargin = 77 - byRSSI;\r\nbreak;\r\ncase RATE_12M:\r\npFrame->sTPCRepEIDs.byLinkMargin = 79 - byRSSI;\r\nbreak;\r\ncase RATE_9M:\r\npFrame->sTPCRepEIDs.byLinkMargin = 81 - byRSSI;\r\nbreak;\r\ncase RATE_6M:\r\ndefault:\r\npFrame->sTPCRepEIDs.byLinkMargin = 82 - byRSSI;\r\nbreak;\r\n}\r\npTxPacket->cbMPDULen = sizeof(WLAN_FRAME_TPCREP);\r\npTxPacket->cbPayloadLen = sizeof(WLAN_FRAME_TPCREP) -\r\nWLAN_HDR_ADDR3_LEN;\r\nif (csMgmt_xmit(pMgmt->pAdapter, pTxPacket) != CMD_STATUS_PENDING)\r\nreturn false;\r\nreturn true;\r\n}\r\nbool\r\nIEEE11hbMgrRxAction(void *pMgmtHandle, void *pRxPacket)\r\n{\r\nPSMgmtObject pMgmt = (PSMgmtObject) pMgmtHandle;\r\nPWLAN_FRAME_ACTION pAction = NULL;\r\nunsigned int uLength = 0;\r\nPWLAN_IE_CH_SW pChannelSwitch = NULL;\r\nuLength = ((PSRxMgmtPacket)pRxPacket)->cbMPDULen;\r\nif (uLength > WLAN_A3FR_MAXLEN)\r\nreturn false;\r\npAction = (PWLAN_FRAME_ACTION)\r\n(((PSRxMgmtPacket)pRxPacket)->p80211Header);\r\nif (pAction->byCategory == 0) {\r\nswitch (pAction->byAction) {\r\ncase ACTION_MSRREQ:\r\nreturn s_bRxMSRReq(pMgmt,\r\n(PWLAN_FRAME_MSRREQ)\r\npAction,\r\nuLength);\r\nbreak;\r\ncase ACTION_MSRREP:\r\nbreak;\r\ncase ACTION_TPCREQ:\r\nreturn s_bRxTPCReq(pMgmt,\r\n(PWLAN_FRAME_TPCREQ) pAction,\r\n((PSRxMgmtPacket)pRxPacket)->byRxRate,\r\n(unsigned char)\r\n((PSRxMgmtPacket)pRxPacket)->uRSSI);\r\nbreak;\r\ncase ACTION_TPCREP:\r\nbreak;\r\ncase ACTION_CHSW:\r\npChannelSwitch = (PWLAN_IE_CH_SW) (pAction->abyVars);\r\nif ((pChannelSwitch->byElementID == WLAN_EID_CH_SWITCH)\r\n&& (pChannelSwitch->len == 3)) {\r\nCARDbChannelSwitch(pMgmt->pAdapter,\r\npChannelSwitch->byMode,\r\nget_channel_mapping(pMgmt->pAdapter,\r\npChannelSwitch->byChannel,\r\npMgmt->eCurrentPHYMode),\r\npChannelSwitch->byCount);\r\n}\r\nbreak;\r\ndefault:\r\nDBG_PRT(MSG_LEVEL_DEBUG,\r\nKERN_INFO "Unknown Action = %d\n",\r\npAction->byAction);\r\nbreak;\r\n}\r\n} else {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Unknown Category = %d\n",\r\npAction->byCategory);\r\npAction->byCategory |= 0x80;\r\nreturn true;\r\n}\r\nreturn true;\r\n}\r\nbool IEEE11hbMSRRepTx(void *pMgmtHandle)\r\n{\r\nPSMgmtObject pMgmt = (PSMgmtObject) pMgmtHandle;\r\nPWLAN_FRAME_MSRREP pMSRRep = (PWLAN_FRAME_MSRREP)\r\n(pMgmt->abyCurrentMSRRep + sizeof(STxMgmtPacket));\r\nsize_t uLength = 0;\r\nPSTxMgmtPacket pTxPacket = NULL;\r\npTxPacket = (PSTxMgmtPacket)pMgmt->abyCurrentMSRRep;\r\nmemset(pTxPacket, 0, sizeof(STxMgmtPacket) + WLAN_A3FR_MAXLEN);\r\npTxPacket->p80211Header = (PUWLAN_80211HDR)((unsigned char *)pTxPacket +\r\nsizeof(STxMgmtPacket));\r\npMSRRep->Header.wFrameCtl = (WLAN_SET_FC_FTYPE(WLAN_FTYPE_MGMT) |\r\nWLAN_SET_FC_FSTYPE(WLAN_FSTYPE_ACTION)\r\n);\r\nmemcpy(pMSRRep->Header.abyAddr1, ((PWLAN_FRAME_MSRREQ)\r\n(pMgmt->abyCurrentMSRReq))->Header.abyAddr2, WLAN_ADDR_LEN);\r\nmemcpy(pMSRRep->Header.abyAddr2,\r\nCARDpGetCurrentAddress(pMgmt->pAdapter), WLAN_ADDR_LEN);\r\nmemcpy(pMSRRep->Header.abyAddr3, pMgmt->abyCurrBSSID, WLAN_BSSID_LEN);\r\npMSRRep->byCategory = 0;\r\npMSRRep->byAction = 1;\r\npMSRRep->byDialogToken = ((PWLAN_FRAME_MSRREQ)\r\n(pMgmt->abyCurrentMSRReq))->byDialogToken;\r\nuLength = pMgmt->uLengthOfRepEIDs + offsetof(WLAN_FRAME_MSRREP,\r\nsMSRRepEIDs);\r\npTxPacket->cbMPDULen = uLength;\r\npTxPacket->cbPayloadLen = uLength - WLAN_HDR_ADDR3_LEN;\r\nif (csMgmt_xmit(pMgmt->pAdapter, pTxPacket) != CMD_STATUS_PENDING)\r\nreturn false;\r\nreturn true;\r\n}

static int fmc_check_version(unsigned long version, const char *name)\r\n{\r\nif (__FMC_MAJOR(version) != FMC_MAJOR) {\r\npr_err("%s: \"%s\" has wrong major (has %li, expected %i)\n",\r\n__func__, name, __FMC_MAJOR(version), FMC_MAJOR);\r\nreturn -EINVAL;\r\n}\r\nif (__FMC_MINOR(version) != FMC_MINOR)\r\npr_info("%s: \"%s\" has wrong minor (has %li, expected %i)\n",\r\n__func__, name, __FMC_MINOR(version), FMC_MINOR);\r\nreturn 0;\r\n}\r\nstatic int fmc_uevent(struct device *dev, struct kobj_uevent_env *env)\r\n{\r\nadd_uevent_var(env, "MODALIAS=%s", "fmc");\r\nreturn 0;\r\n}\r\nstatic int fmc_probe(struct device *dev)\r\n{\r\nstruct fmc_driver *fdrv = to_fmc_driver(dev->driver);\r\nstruct fmc_device *fdev = to_fmc_device(dev);\r\nreturn fdrv->probe(fdev);\r\n}\r\nstatic int fmc_remove(struct device *dev)\r\n{\r\nstruct fmc_driver *fdrv = to_fmc_driver(dev->driver);\r\nstruct fmc_device *fdev = to_fmc_device(dev);\r\nreturn fdrv->remove(fdev);\r\n}\r\nstatic void fmc_shutdown(struct device *dev)\r\n{\r\n}\r\nstatic void fmc_release(struct device *dev)\r\n{\r\nstruct fmc_device *fmc = container_of(dev, struct fmc_device, dev);\r\nkfree(fmc);\r\n}\r\nstatic ssize_t fmc_read_eeprom(struct file *file, struct kobject *kobj,\r\nstruct bin_attribute *bin_attr,\r\nchar *buf, loff_t off, size_t count)\r\n{\r\nstruct device *dev;\r\nstruct fmc_device *fmc;\r\nint eelen;\r\ndev = container_of(kobj, struct device, kobj);\r\nfmc = container_of(dev, struct fmc_device, dev);\r\neelen = fmc->eeprom_len;\r\nif (off > eelen)\r\nreturn -ESPIPE;\r\nif (off == eelen)\r\nreturn 0;\r\nif (off + count > eelen)\r\ncount = eelen - off;\r\nmemcpy(buf, fmc->eeprom + off, count);\r\nreturn count;\r\n}\r\nint fmc_driver_register(struct fmc_driver *drv)\r\n{\r\nif (fmc_check_version(drv->version, drv->driver.name))\r\nreturn -EINVAL;\r\ndrv->driver.bus = &fmc_bus_type;\r\nreturn driver_register(&drv->driver);\r\n}\r\nvoid fmc_driver_unregister(struct fmc_driver *drv)\r\n{\r\ndriver_unregister(&drv->driver);\r\n}\r\nint fmc_device_register_n(struct fmc_device **devs, int n)\r\n{\r\nstruct fmc_device *fmc, **devarray;\r\nuint32_t device_id;\r\nint i, ret = 0;\r\nif (n < 1)\r\nreturn 0;\r\nif (fmc_check_version(devs[0]->version, devs[0]->carrier_name))\r\nreturn -EINVAL;\r\ndevarray = kmemdup(devs, n * sizeof(*devs), GFP_KERNEL);\r\nif (!devarray)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < n; i++) {\r\nfmc = devarray[i];\r\nif (!fmc->hwdev) {\r\npr_err("%s: device nr. %i has no hwdev pointer\n",\r\n__func__, i);\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nif (fmc->flags == FMC_DEVICE_NO_MEZZANINE) {\r\ndev_info(fmc->hwdev, "absent mezzanine in slot %d\n",\r\nfmc->slot_id);\r\ncontinue;\r\n}\r\nif (!fmc->eeprom) {\r\ndev_err(fmc->hwdev, "no eeprom provided for slot %i\n",\r\nfmc->slot_id);\r\nret = -EINVAL;\r\n}\r\nif (!fmc->eeprom_addr) {\r\ndev_err(fmc->hwdev, "no eeprom_addr for slot %i\n",\r\nfmc->slot_id);\r\nret = -EINVAL;\r\n}\r\nif (!fmc->carrier_name || !fmc->carrier_data ||\r\n!fmc->device_id) {\r\ndev_err(fmc->hwdev,\r\n"deivce nr %i: carrier name, "\r\n"data or dev_id not set\n", i);\r\nret = -EINVAL;\r\n}\r\nif (ret)\r\nbreak;\r\n}\r\nif (ret) {\r\nkfree(devarray);\r\nreturn ret;\r\n}\r\nfor (i = 0; i < n; i++) {\r\nfmc = devarray[i];\r\nif (fmc->flags == FMC_DEVICE_NO_MEZZANINE)\r\ncontinue;\r\nfmc->nr_slots = n;\r\nfmc->devarray = devarray;\r\ndevice_initialize(&fmc->dev);\r\nfmc->dev.release = fmc_release;\r\nfmc->dev.parent = fmc->hwdev;\r\nfmc_fill_id_info(fmc);\r\nfmc->dev.bus = &fmc_bus_type;\r\ndevice_id = fmc->device_id;\r\nif (!fmc->mezzanine_name)\r\ndev_set_name(&fmc->dev, "fmc-%04x", device_id);\r\nelse\r\ndev_set_name(&fmc->dev, "%s-%04x", fmc->mezzanine_name,\r\ndevice_id);\r\nret = device_add(&fmc->dev);\r\nif (ret < 0) {\r\ndev_err(fmc->hwdev, "Slot %i: Failed in registering "\r\n"\"%s\"\n", fmc->slot_id, fmc->dev.kobj.name);\r\ngoto out;\r\n}\r\nret = sysfs_create_bin_file(&fmc->dev.kobj, &fmc_eeprom_attr);\r\nif (ret < 0) {\r\ndev_err(&fmc->dev, "Failed in registering eeprom\n");\r\ngoto out1;\r\n}\r\nfmc_dump_eeprom(fmc);\r\nfmc_dump_sdb(fmc);\r\n}\r\nreturn 0;\r\nout1:\r\ndevice_del(&fmc->dev);\r\nout:\r\nfmc_free_id_info(fmc);\r\nput_device(&fmc->dev);\r\nkfree(devarray);\r\nfor (i--; i >= 0; i--) {\r\nsysfs_remove_bin_file(&devs[i]->dev.kobj, &fmc_eeprom_attr);\r\ndevice_del(&devs[i]->dev);\r\nfmc_free_id_info(devs[i]);\r\nput_device(&devs[i]->dev);\r\n}\r\nreturn ret;\r\n}\r\nint fmc_device_register(struct fmc_device *fmc)\r\n{\r\nreturn fmc_device_register_n(&fmc, 1);\r\n}\r\nvoid fmc_device_unregister_n(struct fmc_device **devs, int n)\r\n{\r\nint i;\r\nif (n < 1)\r\nreturn;\r\nkfree(devs[0]->devarray);\r\nfor (i = 0; i < n; i++) {\r\nif (devs[i]->flags == FMC_DEVICE_NO_MEZZANINE)\r\ncontinue;\r\nsysfs_remove_bin_file(&devs[i]->dev.kobj, &fmc_eeprom_attr);\r\ndevice_del(&devs[i]->dev);\r\nfmc_free_id_info(devs[i]);\r\nput_device(&devs[i]->dev);\r\n}\r\n}\r\nvoid fmc_device_unregister(struct fmc_device *fmc)\r\n{\r\nfmc_device_unregister_n(&fmc, 1);\r\n}\r\nstatic int fmc_init(void)\r\n{\r\nreturn bus_register(&fmc_bus_type);\r\n}\r\nstatic void fmc_exit(void)\r\n{\r\nbus_unregister(&fmc_bus_type);\r\n}

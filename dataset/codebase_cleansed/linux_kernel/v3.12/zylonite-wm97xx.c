static void wm97xx_acc_pen_up(struct wm97xx *wm)\r\n{\r\nint i;\r\nmsleep(1);\r\nfor (i = 0; i < 16; i++)\r\nMODR;\r\n}\r\nstatic int wm97xx_acc_pen_down(struct wm97xx *wm)\r\n{\r\nu16 x, y, p = 0x100 | WM97XX_ADCSEL_PRES;\r\nint reads = 0;\r\nstatic u16 last, tries;\r\nmsleep(1);\r\nif (tries > 5) {\r\ntries = 0;\r\nreturn RC_PENUP;\r\n}\r\nx = MODR;\r\nif (x == last) {\r\ntries++;\r\nreturn RC_AGAIN;\r\n}\r\nlast = x;\r\ndo {\r\nif (reads)\r\nx = MODR;\r\ny = MODR;\r\nif (pressure)\r\np = MODR;\r\ndev_dbg(wm->dev, "Raw coordinates: x=%x, y=%x, p=%x\n",\r\nx, y, p);\r\nif ((x & WM97XX_ADCSEL_MASK) != WM97XX_ADCSEL_X ||\r\n(y & WM97XX_ADCSEL_MASK) != WM97XX_ADCSEL_Y ||\r\n(p & WM97XX_ADCSEL_MASK) != WM97XX_ADCSEL_PRES)\r\ngoto up;\r\ntries = 0;\r\ninput_report_abs(wm->input_dev, ABS_X, x & 0xfff);\r\ninput_report_abs(wm->input_dev, ABS_Y, y & 0xfff);\r\ninput_report_abs(wm->input_dev, ABS_PRESSURE, p & 0xfff);\r\ninput_report_key(wm->input_dev, BTN_TOUCH, (p != 0));\r\ninput_sync(wm->input_dev);\r\nreads++;\r\n} while (reads < cinfo[sp_idx].reads);\r\nup:\r\nreturn RC_PENDOWN | RC_AGAIN;\r\n}\r\nstatic int wm97xx_acc_startup(struct wm97xx *wm)\r\n{\r\nint idx;\r\nif (wm->ac97 == NULL)\r\nreturn -ENODEV;\r\nfor (idx = 0; idx < ARRAY_SIZE(cinfo); idx++) {\r\nif (wm->id != cinfo[idx].id)\r\ncontinue;\r\nsp_idx = idx;\r\nif (cont_rate <= cinfo[idx].speed)\r\nbreak;\r\n}\r\nwm->acc_rate = cinfo[sp_idx].code;\r\nwm->acc_slot = ac97_touch_slot;\r\ndev_info(wm->dev,\r\n"zylonite accelerated touchscreen driver, %d samples/sec\n",\r\ncinfo[sp_idx].speed);\r\nreturn 0;\r\n}\r\nstatic void wm97xx_irq_enable(struct wm97xx *wm, int enable)\r\n{\r\nif (enable)\r\nenable_irq(wm->pen_irq);\r\nelse\r\ndisable_irq_nosync(wm->pen_irq);\r\n}\r\nstatic int zylonite_wm97xx_probe(struct platform_device *pdev)\r\n{\r\nstruct wm97xx *wm = platform_get_drvdata(pdev);\r\nint gpio_touch_irq;\r\nif (cpu_is_pxa320())\r\ngpio_touch_irq = mfp_to_gpio(MFP_PIN_GPIO15);\r\nelse\r\ngpio_touch_irq = mfp_to_gpio(MFP_PIN_GPIO26);\r\nwm->pen_irq = gpio_to_irq(gpio_touch_irq);\r\nirq_set_irq_type(wm->pen_irq, IRQ_TYPE_EDGE_BOTH);\r\nwm97xx_config_gpio(wm, WM97XX_GPIO_13, WM97XX_GPIO_IN,\r\nWM97XX_GPIO_POL_HIGH,\r\nWM97XX_GPIO_STICKY,\r\nWM97XX_GPIO_WAKE);\r\nwm97xx_config_gpio(wm, WM97XX_GPIO_2, WM97XX_GPIO_OUT,\r\nWM97XX_GPIO_POL_HIGH,\r\nWM97XX_GPIO_NOTSTICKY,\r\nWM97XX_GPIO_NOWAKE);\r\nreturn wm97xx_register_mach_ops(wm, &zylonite_mach_ops);\r\n}\r\nstatic int zylonite_wm97xx_remove(struct platform_device *pdev)\r\n{\r\nstruct wm97xx *wm = platform_get_drvdata(pdev);\r\nwm97xx_unregister_mach_ops(wm);\r\nreturn 0;\r\n}

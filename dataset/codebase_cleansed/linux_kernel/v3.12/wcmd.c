static\r\nvoid\r\nvAdHocBeaconStop(PSDevice pDevice)\r\n{\r\nPSMgmtObject pMgmt = &(pDevice->sMgmtObj);\r\nbool bStop;\r\nbStop = false;\r\nif ((pMgmt->eCurrMode == WMAC_MODE_IBSS_STA) &&\r\n(pMgmt->eCurrState >= WMAC_STATE_STARTED)) {\r\nif ((pMgmt->uIBSSChannel <= CB_MAX_CHANNEL_24G) &&\r\n(pMgmt->uScanChannel > CB_MAX_CHANNEL_24G)) {\r\nbStop = true;\r\n}\r\nif (pMgmt->uIBSSChannel > CB_MAX_CHANNEL_24G) {\r\nbStop = true;\r\n}\r\n}\r\nif (bStop) {\r\nMACvRegBitsOff(pDevice->PortOffset, MAC_REG_TCR, TCR_AUTOBCNTX);\r\n}\r\n}\r\nstatic\r\nvoid\r\nvAdHocBeaconRestart(PSDevice pDevice)\r\n{\r\nPSMgmtObject pMgmt = &(pDevice->sMgmtObj);\r\nif ((pMgmt->eCurrMode == WMAC_MODE_IBSS_STA) &&\r\n(pMgmt->eCurrState >= WMAC_STATE_STARTED)) {\r\nMACvRegBitsOn(pDevice->PortOffset, MAC_REG_TCR, TCR_AUTOBCNTX);\r\n}\r\n}\r\nstatic\r\nvoid\r\ns_vProbeChannel(\r\nPSDevice pDevice\r\n)\r\n{\r\nunsigned char abyCurrSuppRatesG[] = {WLAN_EID_SUPP_RATES, 8, 0x02, 0x04, 0x0B, 0x16, 0x24, 0x30, 0x48, 0x6C};\r\nunsigned char abyCurrExtSuppRatesG[] = {WLAN_EID_EXTSUPP_RATES, 4, 0x0C, 0x12, 0x18, 0x60};\r\nunsigned char abyCurrSuppRatesA[] = {WLAN_EID_SUPP_RATES, 8, 0x0C, 0x12, 0x18, 0x24, 0x30, 0x48, 0x60, 0x6C};\r\nunsigned char abyCurrSuppRatesB[] = {WLAN_EID_SUPP_RATES, 4, 0x02, 0x04, 0x0B, 0x16};\r\nunsigned char *pbyRate;\r\nPSTxMgmtPacket pTxPacket;\r\nPSMgmtObject pMgmt = pDevice->pMgmt;\r\nunsigned int ii;\r\nif (pDevice->eCurrentPHYType == PHY_TYPE_11A) {\r\npbyRate = &abyCurrSuppRatesA[0];\r\n} else if (pDevice->eCurrentPHYType == PHY_TYPE_11B) {\r\npbyRate = &abyCurrSuppRatesB[0];\r\n} else {\r\npbyRate = &abyCurrSuppRatesG[0];\r\n}\r\npTxPacket = s_MgrMakeProbeRequest\r\n(\r\npDevice,\r\npMgmt,\r\npMgmt->abyScanBSSID,\r\n(PWLAN_IE_SSID)pMgmt->abyScanSSID,\r\n(PWLAN_IE_SUPP_RATES)pbyRate,\r\n(PWLAN_IE_SUPP_RATES)abyCurrExtSuppRatesG\r\n);\r\nif (pTxPacket != NULL) {\r\nfor (ii = 0; ii < 2; ii++) {\r\nif (csMgmt_xmit(pDevice, pTxPacket) != CMD_STATUS_PENDING) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Probe request sending fail.. \n");\r\n} else {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Probe request is sending.. \n");\r\n}\r\n}\r\n}\r\n}\r\nPSTxMgmtPacket\r\ns_MgrMakeProbeRequest(\r\nPSDevice pDevice,\r\nPSMgmtObject pMgmt,\r\nunsigned char *pScanBSSID,\r\nPWLAN_IE_SSID pSSID,\r\nPWLAN_IE_SUPP_RATES pCurrRates,\r\nPWLAN_IE_SUPP_RATES pCurrExtSuppRates\r\n)\r\n{\r\nPSTxMgmtPacket pTxPacket = NULL;\r\nWLAN_FR_PROBEREQ sFrame;\r\npTxPacket = (PSTxMgmtPacket)pMgmt->pbyMgmtPacketPool;\r\nmemset(pTxPacket, 0, sizeof(STxMgmtPacket) + WLAN_PROBEREQ_FR_MAXLEN);\r\npTxPacket->p80211Header = (PUWLAN_80211HDR)((unsigned char *)pTxPacket + sizeof(STxMgmtPacket));\r\nsFrame.pBuf = (unsigned char *)pTxPacket->p80211Header;\r\nsFrame.len = WLAN_PROBEREQ_FR_MAXLEN;\r\nvMgrEncodeProbeRequest(&sFrame);\r\nsFrame.pHdr->sA3.wFrameCtl = cpu_to_le16(\r\n(\r\nWLAN_SET_FC_FTYPE(WLAN_TYPE_MGR) |\r\nWLAN_SET_FC_FSTYPE(WLAN_FSTYPE_PROBEREQ)\r\n));\r\nmemcpy(sFrame.pHdr->sA3.abyAddr1, pScanBSSID, WLAN_ADDR_LEN);\r\nmemcpy(sFrame.pHdr->sA3.abyAddr2, pMgmt->abyMACAddr, WLAN_ADDR_LEN);\r\nmemcpy(sFrame.pHdr->sA3.abyAddr3, pScanBSSID, WLAN_BSSID_LEN);\r\nsFrame.pSSID = (PWLAN_IE_SSID)(sFrame.pBuf + sFrame.len);\r\nsFrame.len += pSSID->len + WLAN_IEHDR_LEN;\r\nmemcpy(sFrame.pSSID, pSSID, pSSID->len + WLAN_IEHDR_LEN);\r\nsFrame.pSuppRates = (PWLAN_IE_SUPP_RATES)(sFrame.pBuf + sFrame.len);\r\nsFrame.len += pCurrRates->len + WLAN_IEHDR_LEN;\r\nmemcpy(sFrame.pSuppRates, pCurrRates, pCurrRates->len + WLAN_IEHDR_LEN);\r\nif (pDevice->eCurrentPHYType == PHY_TYPE_11G) {\r\nsFrame.pExtSuppRates = (PWLAN_IE_SUPP_RATES)(sFrame.pBuf + sFrame.len);\r\nsFrame.len += pCurrExtSuppRates->len + WLAN_IEHDR_LEN;\r\nmemcpy(sFrame.pExtSuppRates, pCurrExtSuppRates, pCurrExtSuppRates->len + WLAN_IEHDR_LEN);\r\n}\r\npTxPacket->cbMPDULen = sFrame.len;\r\npTxPacket->cbPayloadLen = sFrame.len - WLAN_HDR_ADDR3_LEN;\r\nreturn pTxPacket;\r\n}\r\nvoid\r\nvCommandTimerWait(\r\nvoid *hDeviceContext,\r\nunsigned int MSecond\r\n)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\ninit_timer(&pDevice->sTimerCommand);\r\npDevice->sTimerCommand.data = (unsigned long) pDevice;\r\npDevice->sTimerCommand.function = (TimerFunction)vCommandTimer;\r\npDevice->sTimerCommand.expires = (unsigned int)RUN_AT((MSecond * HZ) >> 10);\r\nadd_timer(&pDevice->sTimerCommand);\r\nreturn;\r\n}\r\nvoid\r\nvCommandTimer(\r\nvoid *hDeviceContext\r\n)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPSMgmtObject pMgmt = pDevice->pMgmt;\r\nPWLAN_IE_SSID pItemSSID;\r\nPWLAN_IE_SSID pItemSSIDCurr;\r\nCMD_STATUS Status;\r\nunsigned int ii;\r\nunsigned char byMask[8] = {1, 2, 4, 8, 0x10, 0x20, 0x40, 0x80};\r\nstruct sk_buff *skb;\r\nif (pDevice->dwDiagRefCount != 0)\r\nreturn;\r\nif (pDevice->bCmdRunning != true)\r\nreturn;\r\nspin_lock_irq(&pDevice->lock);\r\nswitch (pDevice->eCommandState) {\r\ncase WLAN_CMD_SCAN_START:\r\npDevice->byReAssocCount = 0;\r\nif (pDevice->bRadioOff == true) {\r\ns_bCommandComplete(pDevice);\r\nspin_unlock_irq(&pDevice->lock);\r\nreturn;\r\n}\r\nif (pMgmt->eCurrMode == WMAC_MODE_ESS_AP) {\r\ns_bCommandComplete(pDevice);\r\nCARDbSetBSSID(pMgmt->pAdapter, pMgmt->abyCurrBSSID, OP_MODE_AP);\r\nspin_unlock_irq(&pDevice->lock);\r\nreturn;\r\n}\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "eCommandState= WLAN_CMD_SCAN_START\n");\r\npItemSSID = (PWLAN_IE_SSID)pMgmt->abyScanSSID;\r\nif (pDevice->iTDUsed[TYPE_AC0DMA] != 0) {\r\nspin_unlock_irq(&pDevice->lock);\r\nvCommandTimerWait((void *)pDevice, 10);\r\nreturn;\r\n}\r\nif (pMgmt->uScanChannel == 0) {\r\npMgmt->uScanChannel = pDevice->byMinChannel;\r\n}\r\nif (pMgmt->uScanChannel > pDevice->byMaxChannel) {\r\npMgmt->eScanState = WMAC_NO_SCANNING;\r\nset_channel(pMgmt->pAdapter, pMgmt->uCurrChannel);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Scanning, set back to channel: [%d]\n", pMgmt->uCurrChannel);\r\nif (pMgmt->eCurrMode == WMAC_MODE_IBSS_STA) {\r\nCARDbSetBSSID(pMgmt->pAdapter, pMgmt->abyCurrBSSID, OP_MODE_ADHOC);\r\n} else {\r\nCARDbSetBSSID(pMgmt->pAdapter, pMgmt->abyCurrBSSID, OP_MODE_INFRASTRUCTURE);\r\n}\r\nvAdHocBeaconRestart(pDevice);\r\ns_bCommandComplete(pDevice);\r\n} else {\r\nif (!is_channel_valid(pMgmt->uScanChannel)) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Invalid channel pMgmt->uScanChannel = %d \n", pMgmt->uScanChannel);\r\ns_bCommandComplete(pDevice);\r\nspin_unlock_irq(&pDevice->lock);\r\nreturn;\r\n}\r\nif (pMgmt->uScanChannel == pDevice->byMinChannel) {\r\npMgmt->abyScanBSSID[0] = 0xFF;\r\npMgmt->abyScanBSSID[1] = 0xFF;\r\npMgmt->abyScanBSSID[2] = 0xFF;\r\npMgmt->abyScanBSSID[3] = 0xFF;\r\npMgmt->abyScanBSSID[4] = 0xFF;\r\npMgmt->abyScanBSSID[5] = 0xFF;\r\npItemSSID->byElementID = WLAN_EID_SSID;\r\npMgmt->eScanState = WMAC_IS_SCANNING;\r\n}\r\nvAdHocBeaconStop(pDevice);\r\nif (set_channel(pMgmt->pAdapter, pMgmt->uScanChannel) == true) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "SCAN Channel: %d\n", pMgmt->uScanChannel);\r\n} else {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "SET SCAN Channel Fail: %d\n", pMgmt->uScanChannel);\r\n}\r\nCARDbSetBSSID(pMgmt->pAdapter, pMgmt->abyCurrBSSID, OP_MODE_UNKNOWN);\r\npMgmt->uScanChannel++;\r\nif (!is_channel_valid(pMgmt->uScanChannel) &&\r\npMgmt->uScanChannel <= pDevice->byMaxChannel) {\r\npMgmt->uScanChannel = pDevice->byMaxChannel + 1;\r\npMgmt->eCommandState = WLAN_CMD_SCAN_END;\r\n}\r\nif ((pMgmt->b11hEnable == false) ||\r\n(pMgmt->uScanChannel < CB_MAX_CHANNEL_24G)) {\r\ns_vProbeChannel(pDevice);\r\nspin_unlock_irq(&pDevice->lock);\r\nvCommandTimerWait((void *)pDevice, WCMD_ACTIVE_SCAN_TIME);\r\nreturn;\r\n} else {\r\nspin_unlock_irq(&pDevice->lock);\r\nvCommandTimerWait((void *)pDevice, WCMD_PASSIVE_SCAN_TIME);\r\nreturn;\r\n}\r\n}\r\nbreak;\r\ncase WLAN_CMD_SCAN_END:\r\nset_channel(pMgmt->pAdapter, pMgmt->uCurrChannel);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Scanning, set back to channel: [%d]\n", pMgmt->uCurrChannel);\r\nif (pMgmt->eCurrMode == WMAC_MODE_IBSS_STA) {\r\nCARDbSetBSSID(pMgmt->pAdapter, pMgmt->abyCurrBSSID, OP_MODE_ADHOC);\r\n} else {\r\nCARDbSetBSSID(pMgmt->pAdapter, pMgmt->abyCurrBSSID, OP_MODE_INFRASTRUCTURE);\r\n}\r\npMgmt->eScanState = WMAC_NO_SCANNING;\r\nvAdHocBeaconRestart(pDevice);\r\n#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT\r\nif (pMgmt->eScanType == WMAC_SCAN_PASSIVE)\r\n{\r\nunion iwreq_data wrqu;\r\nmemset(&wrqu, 0, sizeof(wrqu));\r\nwireless_send_event(pDevice->dev, SIOCGIWSCAN, &wrqu, NULL);\r\n}\r\n#endif\r\ns_bCommandComplete(pDevice);\r\nbreak;\r\ncase WLAN_CMD_DISASSOCIATE_START:\r\npDevice->byReAssocCount = 0;\r\nif ((pMgmt->eCurrMode == WMAC_MODE_ESS_STA) &&\r\n(pMgmt->eCurrState != WMAC_STATE_ASSOC)) {\r\ns_bCommandComplete(pDevice);\r\nspin_unlock_irq(&pDevice->lock);\r\nreturn;\r\n} else {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Send Disassociation Packet..\n");\r\nvMgrDisassocBeginSta((void *)pDevice, pMgmt, pMgmt->abyCurrBSSID, (8), &Status);\r\npDevice->bLinkPass = false;\r\npItemSSID = (PWLAN_IE_SSID)pMgmt->abyCurrSSID;\r\npItemSSID->len = 0;\r\nmemset(pItemSSID->abySSID, 0, WLAN_SSID_MAXLEN);\r\npMgmt->eCurrState = WMAC_STATE_IDLE;\r\npMgmt->sNodeDBTable[0].bActive = false;\r\n}\r\nnetif_stop_queue(pDevice->dev);\r\npDevice->eCommandState = WLAN_DISASSOCIATE_WAIT;\r\nif (pDevice->iTDUsed[TYPE_TXDMA0] != 0) {\r\nvCommandTimerWait((void *)pDevice, 10);\r\nspin_unlock_irq(&pDevice->lock);\r\nreturn;\r\n}\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO " CARDbRadioPowerOff\n");\r\ns_bCommandComplete(pDevice);\r\nbreak;\r\ncase WLAN_DISASSOCIATE_WAIT:\r\nif (pDevice->iTDUsed[TYPE_TXDMA0] != 0) {\r\nvCommandTimerWait((void *)pDevice, 10);\r\nspin_unlock_irq(&pDevice->lock);\r\nreturn;\r\n}\r\ns_bCommandComplete(pDevice);\r\nbreak;\r\ncase WLAN_CMD_SSID_START:\r\npDevice->byReAssocCount = 0;\r\nif (pDevice->bRadioOff == true) {\r\ns_bCommandComplete(pDevice);\r\nspin_unlock_irq(&pDevice->lock);\r\nreturn;\r\n}\r\nprintk("chester-abyDesireSSID=%s\n", ((PWLAN_IE_SSID)pMgmt->abyDesireSSID)->abySSID);\r\npItemSSID = (PWLAN_IE_SSID)pMgmt->abyDesireSSID;\r\npItemSSIDCurr = (PWLAN_IE_SSID)pMgmt->abyCurrSSID;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO " cmd: desire ssid = %s\n", pItemSSID->abySSID);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO " cmd: curr ssid = %s\n", pItemSSIDCurr->abySSID);\r\nif (pMgmt->eCurrState == WMAC_STATE_ASSOC) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO " Cmd pMgmt->eCurrState == WMAC_STATE_ASSOC\n");\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO " pItemSSID->len =%d\n", pItemSSID->len);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO " pItemSSIDCurr->len = %d\n", pItemSSIDCurr->len);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO " desire ssid = %s\n", pItemSSID->abySSID);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO " curr ssid = %s\n", pItemSSIDCurr->abySSID);\r\n}\r\nif ((pMgmt->eCurrState == WMAC_STATE_ASSOC) ||\r\n((pMgmt->eCurrMode == WMAC_MODE_IBSS_STA) && (pMgmt->eCurrState == WMAC_STATE_JOINTED))) {\r\nif (pItemSSID->len == pItemSSIDCurr->len) {\r\nif (memcmp(pItemSSID->abySSID, pItemSSIDCurr->abySSID, pItemSSID->len) == 0) {\r\ns_bCommandComplete(pDevice);\r\nspin_unlock_irq(&pDevice->lock);\r\nreturn;\r\n}\r\n}\r\nnetif_stop_queue(pDevice->dev);\r\npDevice->bLinkPass = false;\r\n}\r\npMgmt->eCurrState = WMAC_STATE_IDLE;\r\npMgmt->eCurrMode = WMAC_MODE_STANDBY;\r\nPSvDisablePowerSaving((void *)pDevice);\r\nBSSvClearNodeDBTable(pDevice, 0);\r\nvMgrJoinBSSBegin((void *)pDevice, &Status);\r\nif ((pMgmt->eCurrMode == WMAC_MODE_ESS_STA) && (pMgmt->eCurrState == WMAC_STATE_JOINTED)) {\r\nif (pMgmt->eCurrState >= WMAC_STATE_AUTH) {\r\nvMgrDeAuthenBeginSta((void *)pDevice, pMgmt, pMgmt->abyCurrBSSID, (3), &Status);\r\n}\r\nvMgrAuthenBeginSta((void *)pDevice, pMgmt, &Status);\r\nif (Status == CMD_STATUS_SUCCESS) {\r\npDevice->byLinkWaitCount = 0;\r\npDevice->eCommandState = WLAN_AUTHENTICATE_WAIT;\r\nvCommandTimerWait((void *)pDevice, AUTHENTICATE_TIMEOUT);\r\nspin_unlock_irq(&pDevice->lock);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO " Set eCommandState = WLAN_AUTHENTICATE_WAIT\n");\r\nreturn;\r\n}\r\n}\r\nelse if (pMgmt->eCurrMode == WMAC_MODE_IBSS_STA) {\r\nif (pMgmt->eCurrState == WMAC_STATE_JOINTED) {\r\nif (netif_queue_stopped(pDevice->dev)) {\r\nnetif_wake_queue(pDevice->dev);\r\n}\r\npDevice->bLinkPass = true;\r\npMgmt->sNodeDBTable[0].bActive = true;\r\npMgmt->sNodeDBTable[0].uInActiveCount = 0;\r\nbClearBSSID_SCAN(pDevice);\r\n} else {\r\nvMgrCreateOwnIBSS((void *)pDevice, &Status);\r\nif (Status != CMD_STATUS_SUCCESS) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO " WLAN_CMD_IBSS_CREATE fail ! \n");\r\n}\r\nBSSvAddMulticastNode(pDevice);\r\n}\r\n}\r\nelse if (pMgmt->eCurrMode == WMAC_MODE_STANDBY) {\r\nif (pMgmt->eConfigMode == WMAC_CONFIG_IBSS_STA ||\r\npMgmt->eConfigMode == WMAC_CONFIG_AUTO) {\r\nvMgrCreateOwnIBSS((void *)pDevice, &Status);\r\nif (Status != CMD_STATUS_SUCCESS) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO " WLAN_CMD_IBSS_CREATE fail ! \n");\r\n}\r\nBSSvAddMulticastNode(pDevice);\r\nif (netif_queue_stopped(pDevice->dev)) {\r\nnetif_wake_queue(pDevice->dev);\r\n}\r\npDevice->bLinkPass = true;\r\n} else {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Disconnect SSID none\n");\r\n#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT\r\n{\r\nunion iwreq_data wrqu;\r\nmemset(&wrqu, 0, sizeof(wrqu));\r\nwrqu.ap_addr.sa_family = ARPHRD_ETHER;\r\nprintk("wireless_send_event--->SIOCGIWAP(disassociated:vMgrJoinBSSBegin Fail !!)\n");\r\nwireless_send_event(pDevice->dev, SIOCGIWAP, &wrqu, NULL);\r\n}\r\n#endif\r\n}\r\n}\r\ns_bCommandComplete(pDevice);\r\nbreak;\r\ncase WLAN_AUTHENTICATE_WAIT:\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "eCommandState == WLAN_AUTHENTICATE_WAIT\n");\r\nif (pMgmt->eCurrState == WMAC_STATE_AUTH) {\r\npDevice->byLinkWaitCount = 0;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "eCurrState == WMAC_STATE_AUTH\n");\r\nvMgrAssocBeginSta((void *)pDevice, pMgmt, &Status);\r\nif (Status == CMD_STATUS_SUCCESS) {\r\npDevice->byLinkWaitCount = 0;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "eCommandState = WLAN_ASSOCIATE_WAIT\n");\r\npDevice->eCommandState = WLAN_ASSOCIATE_WAIT;\r\nvCommandTimerWait((void *)pDevice, ASSOCIATE_TIMEOUT);\r\nspin_unlock_irq(&pDevice->lock);\r\nreturn;\r\n}\r\n}\r\nelse if (pMgmt->eCurrState < WMAC_STATE_AUTHPENDING) {\r\nprintk("WLAN_AUTHENTICATE_WAIT:Authen Fail???\n");\r\n} else if (pDevice->byLinkWaitCount <= 4) {\r\npDevice->byLinkWaitCount++;\r\nprintk("WLAN_AUTHENTICATE_WAIT:wait %d times!!\n", pDevice->byLinkWaitCount);\r\nspin_unlock_irq(&pDevice->lock);\r\nvCommandTimerWait((void *)pDevice, AUTHENTICATE_TIMEOUT/2);\r\nreturn;\r\n}\r\npDevice->byLinkWaitCount = 0;\r\ns_bCommandComplete(pDevice);\r\nbreak;\r\ncase WLAN_ASSOCIATE_WAIT:\r\nif (pMgmt->eCurrState == WMAC_STATE_ASSOC) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "eCurrState == WMAC_STATE_ASSOC\n");\r\nif (pDevice->ePSMode != WMAC_POWER_CAM) {\r\nPSvEnablePowerSaving((void *)pDevice, pMgmt->wListenInterval);\r\n}\r\nif (pMgmt->eAuthenMode >= WMAC_AUTH_WPA) {\r\nKeybRemoveAllKey(&(pDevice->sKey), pDevice->abyBSSID, pDevice->PortOffset);\r\n}\r\npDevice->bLinkPass = true;\r\npDevice->byLinkWaitCount = 0;\r\npDevice->byReAssocCount = 0;\r\nbClearBSSID_SCAN(pDevice);\r\nif (pDevice->byFOETuning) {\r\nBBvSetFOE(pDevice->PortOffset);\r\nPSbSendNullPacket(pDevice);\r\n}\r\nif (netif_queue_stopped(pDevice->dev)) {\r\nnetif_wake_queue(pDevice->dev);\r\n}\r\n#ifdef TxInSleep\r\nif (pDevice->IsTxDataTrigger != false) {\r\ndel_timer(&pDevice->sTimerTxData);\r\ninit_timer(&pDevice->sTimerTxData);\r\npDevice->sTimerTxData.data = (unsigned long) pDevice;\r\npDevice->sTimerTxData.function = (TimerFunction)BSSvSecondTxData;\r\npDevice->sTimerTxData.expires = RUN_AT(10*HZ);\r\npDevice->fTxDataInSleep = false;\r\npDevice->nTxDataTimeCout = 0;\r\n} else {\r\n}\r\npDevice->IsTxDataTrigger = true;\r\nadd_timer(&pDevice->sTimerTxData);\r\n#endif\r\n} else if (pMgmt->eCurrState < WMAC_STATE_ASSOCPENDING) {\r\nprintk("WLAN_ASSOCIATE_WAIT:Association Fail???\n");\r\n} else if (pDevice->byLinkWaitCount <= 4) {\r\npDevice->byLinkWaitCount++;\r\nprintk("WLAN_ASSOCIATE_WAIT:wait %d times!!\n", pDevice->byLinkWaitCount);\r\nspin_unlock_irq(&pDevice->lock);\r\nvCommandTimerWait((void *)pDevice, ASSOCIATE_TIMEOUT/2);\r\nreturn;\r\n}\r\npDevice->byLinkWaitCount = 0;\r\ns_bCommandComplete(pDevice);\r\nbreak;\r\ncase WLAN_CMD_AP_MODE_START:\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "eCommandState == WLAN_CMD_AP_MODE_START\n");\r\nif (pMgmt->eConfigMode == WMAC_CONFIG_AP) {\r\ndel_timer(&pMgmt->sTimerSecondCallback);\r\npMgmt->eCurrState = WMAC_STATE_IDLE;\r\npMgmt->eCurrMode = WMAC_MODE_STANDBY;\r\npDevice->bLinkPass = false;\r\nif (pDevice->bEnableHostWEP == true)\r\nBSSvClearNodeDBTable(pDevice, 1);\r\nelse\r\nBSSvClearNodeDBTable(pDevice, 0);\r\npDevice->uAssocCount = 0;\r\npMgmt->eCurrState = WMAC_STATE_IDLE;\r\npDevice->bFixRate = false;\r\nvMgrCreateOwnIBSS((void *)pDevice, &Status);\r\nif (Status != CMD_STATUS_SUCCESS) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO " vMgrCreateOwnIBSS fail ! \n");\r\n}\r\nMACvRegBitsOff(pDevice->PortOffset, MAC_REG_RCR, RCR_UNICAST);\r\npDevice->byRxMode &= ~RCR_UNICAST;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "wcmd: rx_mode = %x\n", pDevice->byRxMode);\r\nBSSvAddMulticastNode(pDevice);\r\nif (netif_queue_stopped(pDevice->dev)) {\r\nnetif_wake_queue(pDevice->dev);\r\n}\r\npDevice->bLinkPass = true;\r\nadd_timer(&pMgmt->sTimerSecondCallback);\r\n}\r\ns_bCommandComplete(pDevice);\r\nbreak;\r\ncase WLAN_CMD_TX_PSPACKET_START:\r\nif (pMgmt->sNodeDBTable[0].bRxPSPoll) {\r\nwhile ((skb = skb_dequeue(&pMgmt->sNodeDBTable[0].sTxPSQueue)) != NULL) {\r\nif (skb_queue_empty(&pMgmt->sNodeDBTable[0].sTxPSQueue)) {\r\npMgmt->abyPSTxMap[0] &= ~byMask[0];\r\npDevice->bMoreData = false;\r\n} else {\r\npDevice->bMoreData = true;\r\n}\r\nif (!device_dma0_xmit(pDevice, skb, 0)) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Multicast ps tx fail \n");\r\n}\r\npMgmt->sNodeDBTable[0].wEnQueueCnt--;\r\n}\r\n}\r\nfor (ii = 1; ii < (MAX_NODE_NUM + 1); ii++) {\r\nif (pMgmt->sNodeDBTable[ii].bActive &&\r\npMgmt->sNodeDBTable[ii].bRxPSPoll) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Index=%d Enqueu Cnt= %d\n",\r\nii, pMgmt->sNodeDBTable[ii].wEnQueueCnt);\r\nwhile ((skb = skb_dequeue(&pMgmt->sNodeDBTable[ii].sTxPSQueue)) != NULL) {\r\nif (skb_queue_empty(&pMgmt->sNodeDBTable[ii].sTxPSQueue)) {\r\npMgmt->abyPSTxMap[pMgmt->sNodeDBTable[ii].wAID >> 3] &=\r\n~byMask[pMgmt->sNodeDBTable[ii].wAID & 7];\r\npDevice->bMoreData = false;\r\n} else {\r\npDevice->bMoreData = true;\r\n}\r\nif (!device_dma0_xmit(pDevice, skb, ii)) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "sta ps tx fail \n");\r\n}\r\npMgmt->sNodeDBTable[ii].wEnQueueCnt--;\r\nif (pMgmt->sNodeDBTable[ii].bPSEnable)\r\nbreak;\r\n}\r\nif (skb_queue_empty(&pMgmt->sNodeDBTable[ii].sTxPSQueue)) {\r\npMgmt->abyPSTxMap[pMgmt->sNodeDBTable[ii].wAID >> 3] &=\r\n~byMask[pMgmt->sNodeDBTable[ii].wAID & 7];\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Index=%d PS queue clear \n", ii);\r\n}\r\npMgmt->sNodeDBTable[ii].bRxPSPoll = false;\r\n}\r\n}\r\ns_bCommandComplete(pDevice);\r\nbreak;\r\ncase WLAN_CMD_RADIO_START:\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "eCommandState == WLAN_CMD_RADIO_START\n");\r\nif (pDevice->bRadioCmd == true)\r\nCARDbRadioPowerOn(pDevice);\r\nelse\r\nCARDbRadioPowerOff(pDevice);\r\ns_bCommandComplete(pDevice);\r\nbreak;\r\ncase WLAN_CMD_CHECK_BBSENSITIVITY_CHANGE:\r\nif (pDevice->iTDUsed[TYPE_AC0DMA] != 0) {\r\nvCommandTimerWait((void *)pDevice, 10);\r\nspin_unlock_irq(&pDevice->lock);\r\nreturn;\r\n}\r\nif (pDevice->iTDUsed[TYPE_TXDMA0] != 0) {\r\nvCommandTimerWait((void *)pDevice, 10);\r\nspin_unlock_irq(&pDevice->lock);\r\nreturn;\r\n}\r\npDevice->byBBVGACurrent = pDevice->byBBVGANew;\r\nBBvSetVGAGainOffset(pDevice, pDevice->byBBVGACurrent);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "SetVGAGainOffset %02X\n", pDevice->byBBVGACurrent);\r\ns_bCommandComplete(pDevice);\r\nbreak;\r\ndefault:\r\ns_bCommandComplete(pDevice);\r\nbreak;\r\n}\r\nspin_unlock_irq(&pDevice->lock);\r\nreturn;\r\n}\r\nstatic\r\nbool\r\ns_bCommandComplete(\r\nPSDevice pDevice\r\n)\r\n{\r\nPWLAN_IE_SSID pSSID;\r\nbool bRadioCmd = false;\r\nbool bForceSCAN = true;\r\nPSMgmtObject pMgmt = pDevice->pMgmt;\r\npDevice->eCommandState = WLAN_CMD_IDLE;\r\nif (pDevice->cbFreeCmdQueue == CMD_Q_SIZE) {\r\npDevice->bCmdRunning = false;\r\nreturn true;\r\n} else {\r\npDevice->eCommand = pDevice->eCmdQueue[pDevice->uCmdDequeueIdx].eCmd;\r\npSSID = (PWLAN_IE_SSID)pDevice->eCmdQueue[pDevice->uCmdDequeueIdx].abyCmdDesireSSID;\r\nbRadioCmd = pDevice->eCmdQueue[pDevice->uCmdDequeueIdx].bRadioCmd;\r\nbForceSCAN = pDevice->eCmdQueue[pDevice->uCmdDequeueIdx].bForceSCAN;\r\nADD_ONE_WITH_WRAP_AROUND(pDevice->uCmdDequeueIdx, CMD_Q_SIZE);\r\npDevice->cbFreeCmdQueue++;\r\npDevice->bCmdRunning = true;\r\nswitch (pDevice->eCommand) {\r\ncase WLAN_CMD_BSSID_SCAN:\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "eCommandState= WLAN_CMD_BSSID_SCAN\n");\r\npDevice->eCommandState = WLAN_CMD_SCAN_START;\r\npMgmt->uScanChannel = 0;\r\nif (pSSID->len != 0) {\r\nmemcpy(pMgmt->abyScanSSID, pSSID, WLAN_IEHDR_LEN + WLAN_SSID_MAXLEN + 1);\r\n} else {\r\nmemset(pMgmt->abyScanSSID, 0, WLAN_IEHDR_LEN + WLAN_SSID_MAXLEN + 1);\r\n}\r\nbreak;\r\ncase WLAN_CMD_SSID:\r\npDevice->eCommandState = WLAN_CMD_SSID_START;\r\nif (pSSID->len > WLAN_SSID_MAXLEN)\r\npSSID->len = WLAN_SSID_MAXLEN;\r\nif (pSSID->len != 0)\r\nmemcpy(pDevice->pMgmt->abyDesireSSID, pSSID, WLAN_IEHDR_LEN + WLAN_SSID_MAXLEN + 1);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "eCommandState= WLAN_CMD_SSID_START\n");\r\nbreak;\r\ncase WLAN_CMD_DISASSOCIATE:\r\npDevice->eCommandState = WLAN_CMD_DISASSOCIATE_START;\r\nbreak;\r\ncase WLAN_CMD_RX_PSPOLL:\r\npDevice->eCommandState = WLAN_CMD_TX_PSPACKET_START;\r\nbreak;\r\ncase WLAN_CMD_RUN_AP:\r\npDevice->eCommandState = WLAN_CMD_AP_MODE_START;\r\nbreak;\r\ncase WLAN_CMD_RADIO:\r\npDevice->eCommandState = WLAN_CMD_RADIO_START;\r\npDevice->bRadioCmd = bRadioCmd;\r\nbreak;\r\ncase WLAN_CMD_CHANGE_BBSENSITIVITY:\r\npDevice->eCommandState = WLAN_CMD_CHECK_BBSENSITIVITY_CHANGE;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nvCommandTimerWait((void *)pDevice, 0);\r\n}\r\nreturn true;\r\n}\r\nbool bScheduleCommand(\r\nvoid *hDeviceContext,\r\nCMD_CODE eCommand,\r\nunsigned char *pbyItem0\r\n)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nif (pDevice->cbFreeCmdQueue == 0) {\r\nreturn false;\r\n}\r\npDevice->eCmdQueue[pDevice->uCmdEnqueueIdx].eCmd = eCommand;\r\npDevice->eCmdQueue[pDevice->uCmdEnqueueIdx].bForceSCAN = true;\r\nmemset(pDevice->eCmdQueue[pDevice->uCmdEnqueueIdx].abyCmdDesireSSID, 0 , WLAN_IEHDR_LEN + WLAN_SSID_MAXLEN + 1);\r\nif (pbyItem0 != NULL) {\r\nswitch (eCommand) {\r\ncase WLAN_CMD_BSSID_SCAN:\r\nmemcpy(pDevice->eCmdQueue[pDevice->uCmdEnqueueIdx].abyCmdDesireSSID,\r\npbyItem0, WLAN_IEHDR_LEN + WLAN_SSID_MAXLEN + 1);\r\npDevice->eCmdQueue[pDevice->uCmdEnqueueIdx].bForceSCAN = false;\r\nbreak;\r\ncase WLAN_CMD_SSID:\r\nmemcpy(pDevice->eCmdQueue[pDevice->uCmdEnqueueIdx].abyCmdDesireSSID,\r\npbyItem0, WLAN_IEHDR_LEN + WLAN_SSID_MAXLEN + 1);\r\nbreak;\r\ncase WLAN_CMD_DISASSOCIATE:\r\npDevice->eCmdQueue[pDevice->uCmdEnqueueIdx].bNeedRadioOFF = *((int *)pbyItem0);\r\nbreak;\r\ncase WLAN_CMD_RX_PSPOLL:\r\nbreak;\r\ncase WLAN_CMD_RADIO:\r\npDevice->eCmdQueue[pDevice->uCmdEnqueueIdx].bRadioCmd = *((int *)pbyItem0);\r\nbreak;\r\ncase WLAN_CMD_CHANGE_BBSENSITIVITY:\r\npDevice->eCommandState = WLAN_CMD_CHECK_BBSENSITIVITY_CHANGE;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nADD_ONE_WITH_WRAP_AROUND(pDevice->uCmdEnqueueIdx, CMD_Q_SIZE);\r\npDevice->cbFreeCmdQueue--;\r\nif (pDevice->bCmdRunning == false) {\r\ns_bCommandComplete(pDevice);\r\n} else {\r\n}\r\nreturn true;\r\n}\r\nbool bClearBSSID_SCAN(\r\nvoid *hDeviceContext\r\n)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nunsigned int uCmdDequeueIdx = pDevice->uCmdDequeueIdx;\r\nunsigned int ii;\r\nif ((pDevice->cbFreeCmdQueue < CMD_Q_SIZE) && (uCmdDequeueIdx != pDevice->uCmdEnqueueIdx)) {\r\nfor (ii = 0; ii < (CMD_Q_SIZE - pDevice->cbFreeCmdQueue); ii++) {\r\nif (pDevice->eCmdQueue[uCmdDequeueIdx].eCmd == WLAN_CMD_BSSID_SCAN)\r\npDevice->eCmdQueue[uCmdDequeueIdx].eCmd = WLAN_CMD_IDLE;\r\nADD_ONE_WITH_WRAP_AROUND(uCmdDequeueIdx, CMD_Q_SIZE);\r\nif (uCmdDequeueIdx == pDevice->uCmdEnqueueIdx)\r\nbreak;\r\n}\r\n}\r\nreturn true;\r\n}\r\nvoid\r\nvResetCommandTimer(\r\nvoid *hDeviceContext\r\n)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\ndel_timer(&pDevice->sTimerCommand);\r\ninit_timer(&pDevice->sTimerCommand);\r\npDevice->sTimerCommand.data = (unsigned long) pDevice;\r\npDevice->sTimerCommand.function = (TimerFunction)vCommandTimer;\r\npDevice->sTimerCommand.expires = RUN_AT(HZ);\r\npDevice->cbFreeCmdQueue = CMD_Q_SIZE;\r\npDevice->uCmdDequeueIdx = 0;\r\npDevice->uCmdEnqueueIdx = 0;\r\npDevice->eCommandState = WLAN_CMD_IDLE;\r\npDevice->bCmdRunning = false;\r\npDevice->bCmdClear = false;\r\n}\r\nvoid\r\nBSSvSecondTxData(\r\nvoid *hDeviceContext\r\n)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPSMgmtObject pMgmt = &(pDevice->sMgmtObj);\r\npDevice->nTxDataTimeCout++;\r\nif (pDevice->nTxDataTimeCout < 4)\r\n{\r\npDevice->sTimerTxData.expires = RUN_AT(10*HZ);\r\nadd_timer(&pDevice->sTimerTxData);\r\nreturn;\r\n}\r\nspin_lock_irq(&pDevice->lock);\r\n#if 1\r\nif (((pDevice->bLinkPass == true) && (pMgmt->eAuthenMode < WMAC_AUTH_WPA)) ||\r\n(pDevice->fWPA_Authened == true)) {\r\n#else\r\nif (pDevice->bLinkPass == true) {\r\n#endif\r\npDevice->fTxDataInSleep = true;\r\nPSbSendNullPacket(pDevice);\r\npDevice->fTxDataInSleep = false;\r\n}\r\nspin_unlock_irq(&pDevice->lock);\r\npDevice->sTimerTxData.expires = RUN_AT(10*HZ);\r\nadd_timer(&pDevice->sTimerTxData);\r\nreturn;\r\n}

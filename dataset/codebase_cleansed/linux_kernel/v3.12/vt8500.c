void vt8500_restart(enum reboot_mode mode, const char *cmd)\r\n{\r\nif (pmc_base)\r\nwritel(1, pmc_base + VT8500_PMSR_REG);\r\n}\r\nvoid __init vt8500_map_io(void)\r\n{\r\niotable_init(vt8500_io_desc, ARRAY_SIZE(vt8500_io_desc));\r\n}\r\nstatic void vt8500_power_off(void)\r\n{\r\nlocal_irq_disable();\r\nwritew(5, pmc_base + VT8500_HCR_REG);\r\nasm("mcr%? p15, 0, %0, c7, c0, 4" : : "r" (0));\r\n}\r\nvoid __init vt8500_init(void)\r\n{\r\nstruct device_node *np;\r\n#if defined(CONFIG_FB_VT8500) || defined(CONFIG_FB_WM8505)\r\nstruct device_node *fb;\r\nvoid __iomem *gpio_base;\r\n#endif\r\n#ifdef CONFIG_FB_VT8500\r\nfb = of_find_compatible_node(NULL, NULL, "via,vt8500-fb");\r\nif (fb) {\r\nnp = of_find_compatible_node(NULL, NULL, "via,vt8500-gpio");\r\nif (np) {\r\ngpio_base = of_iomap(np, 0);\r\nif (!gpio_base)\r\npr_err("%s: of_iomap(gpio_mux) failed\n",\r\n__func__);\r\nof_node_put(np);\r\n} else {\r\ngpio_base = ioremap(LEGACY_GPIO_BASE, 0x1000);\r\nif (!gpio_base)\r\npr_err("%s: ioremap(legacy_gpio_mux) failed\n",\r\n__func__);\r\n}\r\nif (gpio_base) {\r\nwritel(readl(gpio_base + VT8500_GPIO_MUX_REG) | 1,\r\ngpio_base + VT8500_GPIO_MUX_REG);\r\niounmap(gpio_base);\r\n} else\r\npr_err("%s: Could not remap GPIO mux\n", __func__);\r\nof_node_put(fb);\r\n}\r\n#endif\r\n#ifdef CONFIG_FB_WM8505\r\nfb = of_find_compatible_node(NULL, NULL, "wm,wm8505-fb");\r\nif (fb) {\r\nnp = of_find_compatible_node(NULL, NULL, "wm,wm8505-gpio");\r\nif (!np)\r\nnp = of_find_compatible_node(NULL, NULL,\r\n"wm,wm8650-gpio");\r\nif (np) {\r\ngpio_base = of_iomap(np, 0);\r\nif (!gpio_base)\r\npr_err("%s: of_iomap(gpio_mux) failed\n",\r\n__func__);\r\nof_node_put(np);\r\n} else {\r\ngpio_base = ioremap(LEGACY_GPIO_BASE, 0x1000);\r\nif (!gpio_base)\r\npr_err("%s: ioremap(legacy_gpio_mux) failed\n",\r\n__func__);\r\n}\r\nif (gpio_base) {\r\nwritel(readl(gpio_base + VT8500_GPIO_MUX_REG) |\r\n0x80000000, gpio_base + VT8500_GPIO_MUX_REG);\r\niounmap(gpio_base);\r\n} else\r\npr_err("%s: Could not remap GPIO mux\n", __func__);\r\nof_node_put(fb);\r\n}\r\n#endif\r\nnp = of_find_compatible_node(NULL, NULL, "via,vt8500-pmc");\r\nif (np) {\r\npmc_base = of_iomap(np, 0);\r\nif (!pmc_base)\r\npr_err("%s:of_iomap(pmc) failed\n", __func__);\r\nof_node_put(np);\r\n} else {\r\npmc_base = ioremap(LEGACY_PMC_BASE, 0x1000);\r\nif (!pmc_base)\r\npr_err("%s:ioremap(power_off) failed\n", __func__);\r\n}\r\nif (pmc_base)\r\npm_power_off = &vt8500_power_off;\r\nelse\r\npr_err("%s: PMC Hibernation register could not be remapped, not enabling power off!\n", __func__);\r\nvtwm_clk_init(pmc_base);\r\nof_platform_populate(NULL, of_default_bus_match_table, NULL, NULL);\r\n}

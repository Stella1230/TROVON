static void reset_mpidr(struct kvm_vcpu *vcpu, const struct coproc_reg *r)\r\n{\r\nvcpu->arch.cp15[c0_MPIDR] = (read_cpuid_mpidr() & ~MPIDR_LEVEL_MASK)\r\n| (vcpu->vcpu_id & MPIDR_LEVEL_MASK);\r\n}\r\nstatic bool access_actlr(struct kvm_vcpu *vcpu,\r\nconst struct coproc_params *p,\r\nconst struct coproc_reg *r)\r\n{\r\nif (p->is_write)\r\nreturn ignore_write(vcpu, p);\r\n*vcpu_reg(vcpu, p->Rt1) = vcpu->arch.cp15[c1_ACTLR];\r\nreturn true;\r\n}\r\nstatic bool access_cbar(struct kvm_vcpu *vcpu,\r\nconst struct coproc_params *p,\r\nconst struct coproc_reg *r)\r\n{\r\nif (p->is_write)\r\nreturn write_to_read_only(vcpu, p);\r\nreturn read_zero(vcpu, p);\r\n}\r\nstatic bool access_l2ctlr(struct kvm_vcpu *vcpu,\r\nconst struct coproc_params *p,\r\nconst struct coproc_reg *r)\r\n{\r\nif (p->is_write)\r\nreturn ignore_write(vcpu, p);\r\n*vcpu_reg(vcpu, p->Rt1) = vcpu->arch.cp15[c9_L2CTLR];\r\nreturn true;\r\n}\r\nstatic void reset_l2ctlr(struct kvm_vcpu *vcpu, const struct coproc_reg *r)\r\n{\r\nu32 l2ctlr, ncores;\r\nasm volatile("mrc p15, 1, %0, c9, c0, 2\n" : "=r" (l2ctlr));\r\nl2ctlr &= ~(3 << 24);\r\nncores = atomic_read(&vcpu->kvm->online_vcpus) - 1;\r\nl2ctlr |= (ncores & 3) << 24;\r\nvcpu->arch.cp15[c9_L2CTLR] = l2ctlr;\r\n}\r\nstatic void reset_actlr(struct kvm_vcpu *vcpu, const struct coproc_reg *r)\r\n{\r\nu32 actlr;\r\nasm volatile("mrc p15, 0, %0, c1, c0, 1\n" : "=r" (actlr));\r\nif (atomic_read(&vcpu->kvm->online_vcpus) > 1)\r\nactlr |= 1U << 6;\r\nelse\r\nactlr &= ~(1U << 6);\r\nvcpu->arch.cp15[c1_ACTLR] = actlr;\r\n}\r\nstatic bool access_l2ectlr(struct kvm_vcpu *vcpu,\r\nconst struct coproc_params *p,\r\nconst struct coproc_reg *r)\r\n{\r\nif (p->is_write)\r\nreturn ignore_write(vcpu, p);\r\n*vcpu_reg(vcpu, p->Rt1) = 0;\r\nreturn true;\r\n}\r\nstatic int __init coproc_a15_init(void)\r\n{\r\nunsigned int i;\r\nfor (i = 1; i < ARRAY_SIZE(a15_regs); i++)\r\nBUG_ON(cmp_reg(&a15_regs[i-1],\r\n&a15_regs[i]) >= 0);\r\nkvm_register_target_coproc_table(&a15_target_table);\r\nreturn 0;\r\n}

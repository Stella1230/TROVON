void blk_iopoll_sched(struct blk_iopoll *iop)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nlist_add_tail(&iop->list, &__get_cpu_var(blk_cpu_iopoll));\r\n__raise_softirq_irqoff(BLOCK_IOPOLL_SOFTIRQ);\r\nlocal_irq_restore(flags);\r\n}\r\nvoid __blk_iopoll_complete(struct blk_iopoll *iop)\r\n{\r\nlist_del(&iop->list);\r\nsmp_mb__before_clear_bit();\r\nclear_bit_unlock(IOPOLL_F_SCHED, &iop->state);\r\n}\r\nvoid blk_iopoll_complete(struct blk_iopoll *iopoll)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\n__blk_iopoll_complete(iopoll);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void blk_iopoll_softirq(struct softirq_action *h)\r\n{\r\nstruct list_head *list = &__get_cpu_var(blk_cpu_iopoll);\r\nint rearm = 0, budget = blk_iopoll_budget;\r\nunsigned long start_time = jiffies;\r\nlocal_irq_disable();\r\nwhile (!list_empty(list)) {\r\nstruct blk_iopoll *iop;\r\nint work, weight;\r\nif (budget <= 0 || time_after(jiffies, start_time)) {\r\nrearm = 1;\r\nbreak;\r\n}\r\nlocal_irq_enable();\r\niop = list_entry(list->next, struct blk_iopoll, list);\r\nweight = iop->weight;\r\nwork = 0;\r\nif (test_bit(IOPOLL_F_SCHED, &iop->state))\r\nwork = iop->poll(iop, weight);\r\nbudget -= work;\r\nlocal_irq_disable();\r\nif (work >= weight) {\r\nif (blk_iopoll_disable_pending(iop))\r\n__blk_iopoll_complete(iop);\r\nelse\r\nlist_move_tail(&iop->list, list);\r\n}\r\n}\r\nif (rearm)\r\n__raise_softirq_irqoff(BLOCK_IOPOLL_SOFTIRQ);\r\nlocal_irq_enable();\r\n}\r\nvoid blk_iopoll_disable(struct blk_iopoll *iop)\r\n{\r\nset_bit(IOPOLL_F_DISABLE, &iop->state);\r\nwhile (test_and_set_bit(IOPOLL_F_SCHED, &iop->state))\r\nmsleep(1);\r\nclear_bit(IOPOLL_F_DISABLE, &iop->state);\r\n}\r\nvoid blk_iopoll_enable(struct blk_iopoll *iop)\r\n{\r\nBUG_ON(!test_bit(IOPOLL_F_SCHED, &iop->state));\r\nsmp_mb__before_clear_bit();\r\nclear_bit_unlock(IOPOLL_F_SCHED, &iop->state);\r\n}\r\nvoid blk_iopoll_init(struct blk_iopoll *iop, int weight, blk_iopoll_fn *poll_fn)\r\n{\r\nmemset(iop, 0, sizeof(*iop));\r\nINIT_LIST_HEAD(&iop->list);\r\niop->weight = weight;\r\niop->poll = poll_fn;\r\nset_bit(IOPOLL_F_SCHED, &iop->state);\r\n}\r\nstatic int blk_iopoll_cpu_notify(struct notifier_block *self,\r\nunsigned long action, void *hcpu)\r\n{\r\nif (action == CPU_DEAD || action == CPU_DEAD_FROZEN) {\r\nint cpu = (unsigned long) hcpu;\r\nlocal_irq_disable();\r\nlist_splice_init(&per_cpu(blk_cpu_iopoll, cpu),\r\n&__get_cpu_var(blk_cpu_iopoll));\r\n__raise_softirq_irqoff(BLOCK_IOPOLL_SOFTIRQ);\r\nlocal_irq_enable();\r\n}\r\nreturn NOTIFY_OK;\r\n}\r\nstatic __init int blk_iopoll_setup(void)\r\n{\r\nint i;\r\nfor_each_possible_cpu(i)\r\nINIT_LIST_HEAD(&per_cpu(blk_cpu_iopoll, i));\r\nopen_softirq(BLOCK_IOPOLL_SOFTIRQ, blk_iopoll_softirq);\r\nregister_hotcpu_notifier(&blk_iopoll_cpu_notifier);\r\nreturn 0;\r\n}

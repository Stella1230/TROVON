static int __init x86_rdrand_setup(char *s)\r\n{\r\nsetup_clear_cpu_cap(X86_FEATURE_RDRAND);\r\nreturn 1;\r\n}\r\nstatic inline int rdrand_long(unsigned long *v)\r\n{\r\nint ok;\r\nasm volatile("1: " RDRAND_LONG "\n\t"\r\n"jc 2f\n\t"\r\n"decl %0\n\t"\r\n"jnz 1b\n\t"\r\n"2:"\r\n: "=r" (ok), "=a" (*v)\r\n: "0" (RDRAND_RETRY_LOOPS));\r\nreturn ok;\r\n}\r\nvoid x86_init_rdrand(struct cpuinfo_x86 *c)\r\n{\r\n#ifdef CONFIG_ARCH_RANDOM\r\nunsigned long tmp;\r\nint i, count, ok;\r\nif (!cpu_has(c, X86_FEATURE_RDRAND))\r\nreturn;\r\nfor (count = i = 0; i < RESEED_LOOP; i++) {\r\nok = rdrand_long(&tmp);\r\nif (ok)\r\ncount++;\r\n}\r\nif (count != RESEED_LOOP)\r\nclear_cpu_cap(c, X86_FEATURE_RDRAND);\r\n#endif\r\n}

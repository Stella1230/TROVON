static int __init integrity_audit_setup(char *str)\r\n{\r\nunsigned long audit;\r\nif (!strict_strtoul(str, 0, &audit))\r\nintegrity_audit_info = audit ? 1 : 0;\r\nreturn 1;\r\n}\r\nvoid integrity_audit_msg(int audit_msgno, struct inode *inode,\r\nconst unsigned char *fname, const char *op,\r\nconst char *cause, int result, int audit_info)\r\n{\r\nstruct audit_buffer *ab;\r\nif (!integrity_audit_info && audit_info == 1)\r\nreturn;\r\nab = audit_log_start(current->audit_context, GFP_KERNEL, audit_msgno);\r\naudit_log_format(ab, "pid=%d uid=%u auid=%u ses=%u",\r\ncurrent->pid,\r\nfrom_kuid(&init_user_ns, current_cred()->uid),\r\nfrom_kuid(&init_user_ns, audit_get_loginuid(current)),\r\naudit_get_sessionid(current));\r\naudit_log_task_context(ab);\r\naudit_log_format(ab, " op=");\r\naudit_log_string(ab, op);\r\naudit_log_format(ab, " cause=");\r\naudit_log_string(ab, cause);\r\naudit_log_format(ab, " comm=");\r\naudit_log_untrustedstring(ab, current->comm);\r\nif (fname) {\r\naudit_log_format(ab, " name=");\r\naudit_log_untrustedstring(ab, fname);\r\n}\r\nif (inode) {\r\naudit_log_format(ab, " dev=");\r\naudit_log_untrustedstring(ab, inode->i_sb->s_id);\r\naudit_log_format(ab, " ino=%lu", inode->i_ino);\r\n}\r\naudit_log_format(ab, " res=%d", !result);\r\naudit_log_end(ab);\r\n}

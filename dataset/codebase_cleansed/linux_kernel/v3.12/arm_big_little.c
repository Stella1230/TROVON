static unsigned int bL_cpufreq_get(unsigned int cpu)\r\n{\r\nu32 cur_cluster = cpu_to_cluster(cpu);\r\nreturn clk_get_rate(clk[cur_cluster]) / 1000;\r\n}\r\nstatic int bL_cpufreq_verify_policy(struct cpufreq_policy *policy)\r\n{\r\nu32 cur_cluster = cpu_to_cluster(policy->cpu);\r\nreturn cpufreq_frequency_table_verify(policy, freq_table[cur_cluster]);\r\n}\r\nstatic int bL_cpufreq_set_target(struct cpufreq_policy *policy,\r\nunsigned int target_freq, unsigned int relation)\r\n{\r\nstruct cpufreq_freqs freqs;\r\nu32 cpu = policy->cpu, freq_tab_idx, cur_cluster;\r\nint ret = 0;\r\ncur_cluster = cpu_to_cluster(policy->cpu);\r\nfreqs.old = bL_cpufreq_get(policy->cpu);\r\ncpufreq_frequency_table_target(policy, freq_table[cur_cluster],\r\ntarget_freq, relation, &freq_tab_idx);\r\nfreqs.new = freq_table[cur_cluster][freq_tab_idx].frequency;\r\npr_debug("%s: cpu: %d, cluster: %d, oldfreq: %d, target freq: %d, new freq: %d\n",\r\n__func__, cpu, cur_cluster, freqs.old, target_freq,\r\nfreqs.new);\r\nif (freqs.old == freqs.new)\r\nreturn 0;\r\ncpufreq_notify_transition(policy, &freqs, CPUFREQ_PRECHANGE);\r\nret = clk_set_rate(clk[cur_cluster], freqs.new * 1000);\r\nif (ret) {\r\npr_err("clk_set_rate failed: %d\n", ret);\r\nfreqs.new = freqs.old;\r\n}\r\ncpufreq_notify_transition(policy, &freqs, CPUFREQ_POSTCHANGE);\r\nreturn ret;\r\n}\r\nstatic void put_cluster_clk_and_freq_table(struct device *cpu_dev)\r\n{\r\nu32 cluster = cpu_to_cluster(cpu_dev->id);\r\nif (!atomic_dec_return(&cluster_usage[cluster])) {\r\nclk_put(clk[cluster]);\r\nopp_free_cpufreq_table(cpu_dev, &freq_table[cluster]);\r\ndev_dbg(cpu_dev, "%s: cluster: %d\n", __func__, cluster);\r\n}\r\n}\r\nstatic int get_cluster_clk_and_freq_table(struct device *cpu_dev)\r\n{\r\nu32 cluster = cpu_to_cluster(cpu_dev->id);\r\nchar name[14] = "cpu-cluster.";\r\nint ret;\r\nif (atomic_inc_return(&cluster_usage[cluster]) != 1)\r\nreturn 0;\r\nret = arm_bL_ops->init_opp_table(cpu_dev);\r\nif (ret) {\r\ndev_err(cpu_dev, "%s: init_opp_table failed, cpu: %d, err: %d\n",\r\n__func__, cpu_dev->id, ret);\r\ngoto atomic_dec;\r\n}\r\nret = opp_init_cpufreq_table(cpu_dev, &freq_table[cluster]);\r\nif (ret) {\r\ndev_err(cpu_dev, "%s: failed to init cpufreq table, cpu: %d, err: %d\n",\r\n__func__, cpu_dev->id, ret);\r\ngoto atomic_dec;\r\n}\r\nname[12] = cluster + '0';\r\nclk[cluster] = clk_get_sys(name, NULL);\r\nif (!IS_ERR(clk[cluster])) {\r\ndev_dbg(cpu_dev, "%s: clk: %p & freq table: %p, cluster: %d\n",\r\n__func__, clk[cluster], freq_table[cluster],\r\ncluster);\r\nreturn 0;\r\n}\r\ndev_err(cpu_dev, "%s: Failed to get clk for cpu: %d, cluster: %d\n",\r\n__func__, cpu_dev->id, cluster);\r\nret = PTR_ERR(clk[cluster]);\r\nopp_free_cpufreq_table(cpu_dev, &freq_table[cluster]);\r\natomic_dec:\r\natomic_dec(&cluster_usage[cluster]);\r\ndev_err(cpu_dev, "%s: Failed to get data for cluster: %d\n", __func__,\r\ncluster);\r\nreturn ret;\r\n}\r\nstatic int bL_cpufreq_init(struct cpufreq_policy *policy)\r\n{\r\nu32 cur_cluster = cpu_to_cluster(policy->cpu);\r\nstruct device *cpu_dev;\r\nint ret;\r\ncpu_dev = get_cpu_device(policy->cpu);\r\nif (!cpu_dev) {\r\npr_err("%s: failed to get cpu%d device\n", __func__,\r\npolicy->cpu);\r\nreturn -ENODEV;\r\n}\r\nret = get_cluster_clk_and_freq_table(cpu_dev);\r\nif (ret)\r\nreturn ret;\r\nret = cpufreq_frequency_table_cpuinfo(policy, freq_table[cur_cluster]);\r\nif (ret) {\r\ndev_err(cpu_dev, "CPU %d, cluster: %d invalid freq table\n",\r\npolicy->cpu, cur_cluster);\r\nput_cluster_clk_and_freq_table(cpu_dev);\r\nreturn ret;\r\n}\r\ncpufreq_frequency_table_get_attr(freq_table[cur_cluster], policy->cpu);\r\nif (arm_bL_ops->get_transition_latency)\r\npolicy->cpuinfo.transition_latency =\r\narm_bL_ops->get_transition_latency(cpu_dev);\r\nelse\r\npolicy->cpuinfo.transition_latency = CPUFREQ_ETERNAL;\r\npolicy->cur = bL_cpufreq_get(policy->cpu);\r\ncpumask_copy(policy->cpus, topology_core_cpumask(policy->cpu));\r\ndev_info(cpu_dev, "%s: CPU %d initialized\n", __func__, policy->cpu);\r\nreturn 0;\r\n}\r\nstatic int bL_cpufreq_exit(struct cpufreq_policy *policy)\r\n{\r\nstruct device *cpu_dev;\r\ncpu_dev = get_cpu_device(policy->cpu);\r\nif (!cpu_dev) {\r\npr_err("%s: failed to get cpu%d device\n", __func__,\r\npolicy->cpu);\r\nreturn -ENODEV;\r\n}\r\nput_cluster_clk_and_freq_table(cpu_dev);\r\ndev_dbg(cpu_dev, "%s: Exited, cpu: %d\n", __func__, policy->cpu);\r\nreturn 0;\r\n}\r\nint bL_cpufreq_register(struct cpufreq_arm_bL_ops *ops)\r\n{\r\nint ret;\r\nif (arm_bL_ops) {\r\npr_debug("%s: Already registered: %s, exiting\n", __func__,\r\narm_bL_ops->name);\r\nreturn -EBUSY;\r\n}\r\nif (!ops || !strlen(ops->name) || !ops->init_opp_table) {\r\npr_err("%s: Invalid arm_bL_ops, exiting\n", __func__);\r\nreturn -ENODEV;\r\n}\r\narm_bL_ops = ops;\r\nret = cpufreq_register_driver(&bL_cpufreq_driver);\r\nif (ret) {\r\npr_info("%s: Failed registering platform driver: %s, err: %d\n",\r\n__func__, ops->name, ret);\r\narm_bL_ops = NULL;\r\n} else {\r\npr_info("%s: Registered platform driver: %s\n", __func__,\r\nops->name);\r\n}\r\nreturn ret;\r\n}\r\nvoid bL_cpufreq_unregister(struct cpufreq_arm_bL_ops *ops)\r\n{\r\nif (arm_bL_ops != ops) {\r\npr_err("%s: Registered with: %s, can't unregister, exiting\n",\r\n__func__, arm_bL_ops->name);\r\nreturn;\r\n}\r\ncpufreq_unregister_driver(&bL_cpufreq_driver);\r\npr_info("%s: Un-registered platform driver: %s\n", __func__,\r\narm_bL_ops->name);\r\narm_bL_ops = NULL;\r\n}

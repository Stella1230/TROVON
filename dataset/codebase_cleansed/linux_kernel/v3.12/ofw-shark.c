asmlinkage void\r\ncreate_params (unsigned long *buffer)\r\n{\r\nstruct tag *tag = (struct tag *) 0x08003000;\r\nint j,i,m,k,nr_banks,size;\r\nunsigned char *c;\r\nk = 0;\r\ntag->hdr.tag = ATAG_CORE;\r\ntag->hdr.size = tag_size(tag_core);\r\ntag->u.core.flags = 1;\r\ntag->u.core.pagesize = PAGE_SIZE;\r\ntag->u.core.rootdev = 0;\r\nsize=0;\r\nnr_banks=(unsigned int) buffer[0];\r\nfor (j=0;j<nr_banks;j++){\r\nm=0xffffffff;\r\nfor (i=0;i<(unsigned int) buffer[0];i++){\r\nif (buffer[2*i+1]<m) {\r\nm=buffer[2*i+1];\r\nk=i;\r\n}\r\n}\r\ntag = tag_next(tag);\r\ntag->hdr.tag = ATAG_MEM;\r\ntag->hdr.size = tag_size(tag_mem32);\r\ntag->u.mem.size = buffer[2*k+2];\r\ntag->u.mem.start = buffer[2*k+1];\r\nsize += buffer[2*k+2];\r\nbuffer[2*k+1]=0xffffffff;\r\n}\r\ntag = tag_next(tag);\r\ntag->hdr.tag = ATAG_CMDLINE;\r\nc=(unsigned char *)(&buffer[34]);\r\nj=0;\r\nwhile (*c) tag->u.cmdline.cmdline[j++]=*c++;\r\ntag->u.cmdline.cmdline[j]=0;\r\ntag->hdr.size = (j + 7 + sizeof(struct tag_header)) >> 2;\r\ntag = tag_next(tag);\r\ntag->hdr.tag = ATAG_REVISION;\r\ntag->hdr.size = tag_size(tag_revision);\r\ntag->u.revision.rev = ((unsigned char) buffer[33])-'0';\r\ntag = tag_next(tag);\r\ntag->hdr.tag = 0;\r\ntag->hdr.size = 0;\r\n}\r\nint\r\nof_decode_int(const unsigned char *p)\r\n{\r\nunsigned int i = *p++ << 8;\r\ni = (i + *p++) << 8;\r\ni = (i + *p++) << 8;\r\nreturn (i + *p);\r\n}\r\nint\r\nOF_finddevice(ofw_handle_t openfirmware, char *name)\r\n{\r\nunsigned int args[8];\r\nchar service[12];\r\nservice[0]='f';\r\nservice[1]='i';\r\nservice[2]='n';\r\nservice[3]='d';\r\nservice[4]='d';\r\nservice[5]='e';\r\nservice[6]='v';\r\nservice[7]='i';\r\nservice[8]='c';\r\nservice[9]='e';\r\nservice[10]='\0';\r\nargs[0]=(unsigned int)service;\r\nargs[1]=1;\r\nargs[2]=1;\r\nargs[3]=(unsigned int)name;\r\nif (openfirmware(args) == -1)\r\nreturn -1;\r\nreturn args[4];\r\n}\r\nint\r\nOF_getproplen(ofw_handle_t openfirmware, int handle, char *prop)\r\n{\r\nunsigned int args[8];\r\nchar service[12];\r\nservice[0]='g';\r\nservice[1]='e';\r\nservice[2]='t';\r\nservice[3]='p';\r\nservice[4]='r';\r\nservice[5]='o';\r\nservice[6]='p';\r\nservice[7]='l';\r\nservice[8]='e';\r\nservice[9]='n';\r\nservice[10]='\0';\r\nargs[0] = (unsigned int)service;\r\nargs[1] = 2;\r\nargs[2] = 1;\r\nargs[3] = (unsigned int)handle;\r\nargs[4] = (unsigned int)prop;\r\nif (openfirmware(args) == -1)\r\nreturn -1;\r\nreturn args[5];\r\n}\r\nint\r\nOF_getprop(ofw_handle_t openfirmware, int handle, char *prop, void *buf, unsigned int buflen)\r\n{\r\nunsigned int args[8];\r\nchar service[8];\r\nservice[0]='g';\r\nservice[1]='e';\r\nservice[2]='t';\r\nservice[3]='p';\r\nservice[4]='r';\r\nservice[5]='o';\r\nservice[6]='p';\r\nservice[7]='\0';\r\nargs[0] = (unsigned int)service;\r\nargs[1] = 4;\r\nargs[2] = 1;\r\nargs[3] = (unsigned int)handle;\r\nargs[4] = (unsigned int)prop;\r\nargs[5] = (unsigned int)buf;\r\nargs[6] = buflen;\r\nif (openfirmware(args) == -1)\r\nreturn -1;\r\nreturn args[7];\r\n}\r\nasmlinkage void ofw_init(ofw_handle_t o, int *nomr, int *pointer)\r\n{\r\nint phandle,i,mem_len,buffer[32];\r\nchar temp[15];\r\ntemp[0]='/';\r\ntemp[1]='m';\r\ntemp[2]='e';\r\ntemp[3]='m';\r\ntemp[4]='o';\r\ntemp[5]='r';\r\ntemp[6]='y';\r\ntemp[7]='\0';\r\nphandle=OF_finddevice(o,temp);\r\ntemp[0]='r';\r\ntemp[1]='e';\r\ntemp[2]='g';\r\ntemp[3]='\0';\r\nmem_len = OF_getproplen(o,phandle, temp);\r\nOF_getprop(o,phandle, temp, buffer, mem_len);\r\n*nomr=mem_len >> 3;\r\nfor (i=0; i<=mem_len/4; i++) pointer[i]=of_decode_int((const unsigned char *)&buffer[i]);\r\ntemp[0]='/';\r\ntemp[1]='c';\r\ntemp[2]='h';\r\ntemp[3]='o';\r\ntemp[4]='s';\r\ntemp[5]='e';\r\ntemp[6]='n';\r\ntemp[7]='\0';\r\nphandle=OF_finddevice(o,temp);\r\ntemp[0]='b';\r\ntemp[1]='o';\r\ntemp[2]='o';\r\ntemp[3]='t';\r\ntemp[4]='a';\r\ntemp[5]='r';\r\ntemp[6]='g';\r\ntemp[7]='s';\r\ntemp[8]='\0';\r\nmem_len = OF_getproplen(o,phandle, temp);\r\nOF_getprop(o,phandle, temp, buffer, mem_len);\r\nif (mem_len > 128) mem_len=128;\r\nfor (i=0; i<=mem_len/4; i++) pointer[i+33]=buffer[i];\r\npointer[i+33]=0;\r\ntemp[0]='/';\r\ntemp[1]='\0';\r\nphandle=OF_finddevice(o,temp);\r\ntemp[0]='b';\r\ntemp[1]='a';\r\ntemp[2]='n';\r\ntemp[3]='n';\r\ntemp[4]='e';\r\ntemp[5]='r';\r\ntemp[6]='-';\r\ntemp[7]='n';\r\ntemp[8]='a';\r\ntemp[9]='m';\r\ntemp[10]='e';\r\ntemp[11]='\0';\r\nmem_len = OF_getproplen(o,phandle, temp);\r\nOF_getprop(o,phandle, temp, buffer, mem_len);\r\n* ((unsigned char *) &pointer[32]) = ((unsigned char *) buffer)[mem_len-2];\r\n}

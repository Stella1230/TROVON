static void armada_370_xp_irq_mask(struct irq_data *d)\r\n{\r\nirq_hw_number_t hwirq = irqd_to_hwirq(d);\r\nif (hwirq != ARMADA_370_XP_TIMER0_PER_CPU_IRQ)\r\nwritel(hwirq, main_int_base +\r\nARMADA_370_XP_INT_CLEAR_ENABLE_OFFS);\r\nelse\r\nwritel(hwirq, per_cpu_int_base +\r\nARMADA_370_XP_INT_SET_MASK_OFFS);\r\n}\r\nstatic void armada_370_xp_irq_unmask(struct irq_data *d)\r\n{\r\nirq_hw_number_t hwirq = irqd_to_hwirq(d);\r\nif (hwirq != ARMADA_370_XP_TIMER0_PER_CPU_IRQ)\r\nwritel(hwirq, main_int_base +\r\nARMADA_370_XP_INT_SET_ENABLE_OFFS);\r\nelse\r\nwritel(hwirq, per_cpu_int_base +\r\nARMADA_370_XP_INT_CLEAR_MASK_OFFS);\r\n}\r\nstatic int armada_xp_set_affinity(struct irq_data *d,\r\nconst struct cpumask *mask_val, bool force)\r\n{\r\nunsigned long reg;\r\nunsigned long new_mask = 0;\r\nunsigned long online_mask = 0;\r\nunsigned long count = 0;\r\nirq_hw_number_t hwirq = irqd_to_hwirq(d);\r\nint cpu;\r\nfor_each_cpu(cpu, mask_val) {\r\nnew_mask |= 1 << cpu_logical_map(cpu);\r\ncount++;\r\n}\r\nif (count > 1)\r\nreturn -EINVAL;\r\nfor_each_cpu(cpu, cpu_online_mask)\r\nonline_mask |= 1 << cpu_logical_map(cpu);\r\nraw_spin_lock(&irq_controller_lock);\r\nreg = readl(main_int_base + ARMADA_370_XP_INT_SOURCE_CTL(hwirq));\r\nreg = (reg & (~online_mask)) | new_mask;\r\nwritel(reg, main_int_base + ARMADA_370_XP_INT_SOURCE_CTL(hwirq));\r\nraw_spin_unlock(&irq_controller_lock);\r\nreturn 0;\r\n}\r\nstatic int armada_370_xp_mpic_irq_map(struct irq_domain *h,\r\nunsigned int virq, irq_hw_number_t hw)\r\n{\r\narmada_370_xp_irq_mask(irq_get_irq_data(virq));\r\nif (hw != ARMADA_370_XP_TIMER0_PER_CPU_IRQ)\r\nwritel(hw, per_cpu_int_base +\r\nARMADA_370_XP_INT_CLEAR_MASK_OFFS);\r\nelse\r\nwritel(hw, main_int_base + ARMADA_370_XP_INT_SET_ENABLE_OFFS);\r\nirq_set_status_flags(virq, IRQ_LEVEL);\r\nif (hw == ARMADA_370_XP_TIMER0_PER_CPU_IRQ) {\r\nirq_set_percpu_devid(virq);\r\nirq_set_chip_and_handler(virq, &armada_370_xp_irq_chip,\r\nhandle_percpu_devid_irq);\r\n} else {\r\nirq_set_chip_and_handler(virq, &armada_370_xp_irq_chip,\r\nhandle_level_irq);\r\n}\r\nset_irq_flags(virq, IRQF_VALID | IRQF_PROBE);\r\nreturn 0;\r\n}\r\nvoid armada_mpic_send_doorbell(const struct cpumask *mask, unsigned int irq)\r\n{\r\nint cpu;\r\nunsigned long map = 0;\r\nfor_each_cpu(cpu, mask)\r\nmap |= 1 << cpu_logical_map(cpu);\r\ndsb();\r\nwritel((map << 8) | irq, main_int_base +\r\nARMADA_370_XP_SW_TRIG_INT_OFFS);\r\n}\r\nvoid armada_xp_mpic_smp_cpu_init(void)\r\n{\r\nwritel(0, per_cpu_int_base + ARMADA_370_XP_IN_DRBEL_CAUSE_OFFS);\r\nwritel(IPI_DOORBELL_MASK, per_cpu_int_base +\r\nARMADA_370_XP_IN_DRBEL_MSK_OFFS);\r\nwritel(0, per_cpu_int_base + ARMADA_370_XP_INT_CLEAR_MASK_OFFS);\r\n}\r\nstatic asmlinkage void __exception_irq_entry\r\narmada_370_xp_handle_irq(struct pt_regs *regs)\r\n{\r\nu32 irqstat, irqnr;\r\ndo {\r\nirqstat = readl_relaxed(per_cpu_int_base +\r\nARMADA_370_XP_CPU_INTACK_OFFS);\r\nirqnr = irqstat & 0x3FF;\r\nif (irqnr > 1022)\r\nbreak;\r\nif (irqnr > 0) {\r\nirqnr = irq_find_mapping(armada_370_xp_mpic_domain,\r\nirqnr);\r\nhandle_IRQ(irqnr, regs);\r\ncontinue;\r\n}\r\n#ifdef CONFIG_SMP\r\nif (irqnr == 0) {\r\nu32 ipimask, ipinr;\r\nipimask = readl_relaxed(per_cpu_int_base +\r\nARMADA_370_XP_IN_DRBEL_CAUSE_OFFS)\r\n& IPI_DOORBELL_MASK;\r\nwritel(~IPI_DOORBELL_MASK, per_cpu_int_base +\r\nARMADA_370_XP_IN_DRBEL_CAUSE_OFFS);\r\nfor (ipinr = IPI_DOORBELL_START;\r\nipinr < IPI_DOORBELL_END; ipinr++) {\r\nif (ipimask & (0x1 << ipinr))\r\nhandle_IPI(ipinr, regs);\r\n}\r\ncontinue;\r\n}\r\n#endif\r\n} while (1);\r\n}\r\nstatic int __init armada_370_xp_mpic_of_init(struct device_node *node,\r\nstruct device_node *parent)\r\n{\r\nu32 control;\r\nmain_int_base = of_iomap(node, 0);\r\nper_cpu_int_base = of_iomap(node, 1);\r\nBUG_ON(!main_int_base);\r\nBUG_ON(!per_cpu_int_base);\r\ncontrol = readl(main_int_base + ARMADA_370_XP_INT_CONTROL);\r\narmada_370_xp_mpic_domain =\r\nirq_domain_add_linear(node, (control >> 2) & 0x3ff,\r\n&armada_370_xp_mpic_irq_ops, NULL);\r\nif (!armada_370_xp_mpic_domain)\r\npanic("Unable to add Armada_370_Xp MPIC irq domain (DT)\n");\r\nirq_set_default_host(armada_370_xp_mpic_domain);\r\n#ifdef CONFIG_SMP\r\narmada_xp_mpic_smp_cpu_init();\r\ncpumask_clear(irq_default_affinity);\r\ncpumask_set_cpu(smp_processor_id(), irq_default_affinity);\r\n#endif\r\nset_handle_irq(armada_370_xp_handle_irq);\r\nreturn 0;\r\n}

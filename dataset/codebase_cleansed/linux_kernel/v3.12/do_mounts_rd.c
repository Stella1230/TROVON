static int __init prompt_ramdisk(char *str)\r\n{\r\nrd_prompt = simple_strtol(str,NULL,0) & 1;\r\nreturn 1;\r\n}\r\nstatic int __init ramdisk_start_setup(char *str)\r\n{\r\nrd_image_start = simple_strtol(str,NULL,0);\r\nreturn 1;\r\n}\r\nstatic int __init\r\nidentify_ramdisk_image(int fd, int start_block, decompress_fn *decompressor)\r\n{\r\nconst int size = 512;\r\nstruct minix_super_block *minixsb;\r\nstruct romfs_super_block *romfsb;\r\nstruct cramfs_super *cramfsb;\r\nstruct squashfs_super_block *squashfsb;\r\nint nblocks = -1;\r\nunsigned char *buf;\r\nconst char *compress_name;\r\nunsigned long n;\r\nbuf = kmalloc(size, GFP_KERNEL);\r\nif (!buf)\r\nreturn -ENOMEM;\r\nminixsb = (struct minix_super_block *) buf;\r\nromfsb = (struct romfs_super_block *) buf;\r\ncramfsb = (struct cramfs_super *) buf;\r\nsquashfsb = (struct squashfs_super_block *) buf;\r\nmemset(buf, 0xe5, size);\r\nsys_lseek(fd, start_block * BLOCK_SIZE, 0);\r\nsys_read(fd, buf, size);\r\n*decompressor = decompress_method(buf, size, &compress_name);\r\nif (compress_name) {\r\nprintk(KERN_NOTICE "RAMDISK: %s image found at block %d\n",\r\ncompress_name, start_block);\r\nif (!*decompressor)\r\nprintk(KERN_EMERG\r\n"RAMDISK: %s decompressor not configured!\n",\r\ncompress_name);\r\nnblocks = 0;\r\ngoto done;\r\n}\r\nif (romfsb->word0 == ROMSB_WORD0 &&\r\nromfsb->word1 == ROMSB_WORD1) {\r\nprintk(KERN_NOTICE\r\n"RAMDISK: romfs filesystem found at block %d\n",\r\nstart_block);\r\nnblocks = (ntohl(romfsb->size)+BLOCK_SIZE-1)>>BLOCK_SIZE_BITS;\r\ngoto done;\r\n}\r\nif (cramfsb->magic == CRAMFS_MAGIC) {\r\nprintk(KERN_NOTICE\r\n"RAMDISK: cramfs filesystem found at block %d\n",\r\nstart_block);\r\nnblocks = (cramfsb->size + BLOCK_SIZE - 1) >> BLOCK_SIZE_BITS;\r\ngoto done;\r\n}\r\nif (le32_to_cpu(squashfsb->s_magic) == SQUASHFS_MAGIC) {\r\nprintk(KERN_NOTICE\r\n"RAMDISK: squashfs filesystem found at block %d\n",\r\nstart_block);\r\nnblocks = (le64_to_cpu(squashfsb->bytes_used) + BLOCK_SIZE - 1)\r\n>> BLOCK_SIZE_BITS;\r\ngoto done;\r\n}\r\nsys_lseek(fd, start_block * BLOCK_SIZE + 0x200, 0);\r\nsys_read(fd, buf, size);\r\nif (cramfsb->magic == CRAMFS_MAGIC) {\r\nprintk(KERN_NOTICE\r\n"RAMDISK: cramfs filesystem found at block %d\n",\r\nstart_block);\r\nnblocks = (cramfsb->size + BLOCK_SIZE - 1) >> BLOCK_SIZE_BITS;\r\ngoto done;\r\n}\r\nsys_lseek(fd, (start_block+1) * BLOCK_SIZE, 0);\r\nsys_read(fd, buf, size);\r\nif (minixsb->s_magic == MINIX_SUPER_MAGIC ||\r\nminixsb->s_magic == MINIX_SUPER_MAGIC2) {\r\nprintk(KERN_NOTICE\r\n"RAMDISK: Minix filesystem found at block %d\n",\r\nstart_block);\r\nnblocks = minixsb->s_nzones << minixsb->s_log_zone_size;\r\ngoto done;\r\n}\r\nn = ext2_image_size(buf);\r\nif (n) {\r\nprintk(KERN_NOTICE\r\n"RAMDISK: ext2 filesystem found at block %d\n",\r\nstart_block);\r\nnblocks = n;\r\ngoto done;\r\n}\r\nprintk(KERN_NOTICE\r\n"RAMDISK: Couldn't find valid RAM disk image starting at %d.\n",\r\nstart_block);\r\ndone:\r\nsys_lseek(fd, start_block * BLOCK_SIZE, 0);\r\nkfree(buf);\r\nreturn nblocks;\r\n}\r\nint __init rd_load_image(char *from)\r\n{\r\nint res = 0;\r\nint in_fd, out_fd;\r\nunsigned long rd_blocks, devblocks;\r\nint nblocks, i, disk;\r\nchar *buf = NULL;\r\nunsigned short rotate = 0;\r\ndecompress_fn decompressor = NULL;\r\n#if !defined(CONFIG_S390)\r\nchar rotator[4] = { '|' , '/' , '-' , '\\' };\r\n#endif\r\nout_fd = sys_open("/dev/ram", O_RDWR, 0);\r\nif (out_fd < 0)\r\ngoto out;\r\nin_fd = sys_open(from, O_RDONLY, 0);\r\nif (in_fd < 0)\r\ngoto noclose_input;\r\nnblocks = identify_ramdisk_image(in_fd, rd_image_start, &decompressor);\r\nif (nblocks < 0)\r\ngoto done;\r\nif (nblocks == 0) {\r\nif (crd_load(in_fd, out_fd, decompressor) == 0)\r\ngoto successful_load;\r\ngoto done;\r\n}\r\nif (sys_ioctl(out_fd, BLKGETSIZE, (unsigned long)&rd_blocks) < 0)\r\nrd_blocks = 0;\r\nelse\r\nrd_blocks >>= 1;\r\nif (nblocks > rd_blocks) {\r\nprintk("RAMDISK: image too big! (%dKiB/%ldKiB)\n",\r\nnblocks, rd_blocks);\r\ngoto done;\r\n}\r\nif (sys_ioctl(in_fd, BLKGETSIZE, (unsigned long)&devblocks) < 0)\r\ndevblocks = 0;\r\nelse\r\ndevblocks >>= 1;\r\nif (strcmp(from, "/initrd.image") == 0)\r\ndevblocks = nblocks;\r\nif (devblocks == 0) {\r\nprintk(KERN_ERR "RAMDISK: could not determine device size\n");\r\ngoto done;\r\n}\r\nbuf = kmalloc(BLOCK_SIZE, GFP_KERNEL);\r\nif (!buf) {\r\nprintk(KERN_ERR "RAMDISK: could not allocate buffer\n");\r\ngoto done;\r\n}\r\nprintk(KERN_NOTICE "RAMDISK: Loading %dKiB [%ld disk%s] into ram disk... ",\r\nnblocks, ((nblocks-1)/devblocks)+1, nblocks>devblocks ? "s" : "");\r\nfor (i = 0, disk = 1; i < nblocks; i++) {\r\nif (i && (i % devblocks == 0)) {\r\nprintk("done disk #%d.\n", disk++);\r\nrotate = 0;\r\nif (sys_close(in_fd)) {\r\nprintk("Error closing the disk.\n");\r\ngoto noclose_input;\r\n}\r\nchange_floppy("disk #%d", disk);\r\nin_fd = sys_open(from, O_RDONLY, 0);\r\nif (in_fd < 0) {\r\nprintk("Error opening disk.\n");\r\ngoto noclose_input;\r\n}\r\nprintk("Loading disk #%d... ", disk);\r\n}\r\nsys_read(in_fd, buf, BLOCK_SIZE);\r\nsys_write(out_fd, buf, BLOCK_SIZE);\r\n#if !defined(CONFIG_S390)\r\nif (!(i % 16)) {\r\nprintk("%c\b", rotator[rotate & 0x3]);\r\nrotate++;\r\n}\r\n#endif\r\n}\r\nprintk("done.\n");\r\nsuccessful_load:\r\nres = 1;\r\ndone:\r\nsys_close(in_fd);\r\nnoclose_input:\r\nsys_close(out_fd);\r\nout:\r\nkfree(buf);\r\nsys_unlink("/dev/ram");\r\nreturn res;\r\n}\r\nint __init rd_load_disk(int n)\r\n{\r\nif (rd_prompt)\r\nchange_floppy("root floppy disk to be loaded into RAM disk");\r\ncreate_dev("/dev/root", ROOT_DEV);\r\ncreate_dev("/dev/ram", MKDEV(RAMDISK_MAJOR, n));\r\nreturn rd_load_image("/dev/root");\r\n}\r\nstatic int __init compr_fill(void *buf, unsigned int len)\r\n{\r\nint r = sys_read(crd_infd, buf, len);\r\nif (r < 0)\r\nprintk(KERN_ERR "RAMDISK: error while reading compressed data");\r\nelse if (r == 0)\r\nprintk(KERN_ERR "RAMDISK: EOF while reading compressed data");\r\nreturn r;\r\n}\r\nstatic int __init compr_flush(void *window, unsigned int outcnt)\r\n{\r\nint written = sys_write(crd_outfd, window, outcnt);\r\nif (written != outcnt) {\r\nif (decompress_error == 0)\r\nprintk(KERN_ERR\r\n"RAMDISK: incomplete write (%d != %d)\n",\r\nwritten, outcnt);\r\ndecompress_error = 1;\r\nreturn -1;\r\n}\r\nreturn outcnt;\r\n}\r\nstatic void __init error(char *x)\r\n{\r\nprintk(KERN_ERR "%s\n", x);\r\nexit_code = 1;\r\ndecompress_error = 1;\r\n}\r\nstatic int __init crd_load(int in_fd, int out_fd, decompress_fn deco)\r\n{\r\nint result;\r\ncrd_infd = in_fd;\r\ncrd_outfd = out_fd;\r\nresult = deco(NULL, 0, compr_fill, compr_flush, NULL, NULL, error);\r\nif (decompress_error)\r\nresult = 1;\r\nreturn result;\r\n}

static int __init alloc_workspaces(void)\r\n{\r\ndef_strm.workspace = vmalloc(zlib_deflate_workspacesize(MAX_WBITS,\r\nMAX_MEM_LEVEL));\r\nif (!def_strm.workspace)\r\nreturn -ENOMEM;\r\njffs2_dbg(1, "Allocated %d bytes for deflate workspace\n",\r\nzlib_deflate_workspacesize(MAX_WBITS, MAX_MEM_LEVEL));\r\ninf_strm.workspace = vmalloc(zlib_inflate_workspacesize());\r\nif (!inf_strm.workspace) {\r\nvfree(def_strm.workspace);\r\nreturn -ENOMEM;\r\n}\r\njffs2_dbg(1, "Allocated %d bytes for inflate workspace\n",\r\nzlib_inflate_workspacesize());\r\nreturn 0;\r\n}\r\nstatic void free_workspaces(void)\r\n{\r\nvfree(def_strm.workspace);\r\nvfree(inf_strm.workspace);\r\n}\r\nstatic int jffs2_zlib_compress(unsigned char *data_in,\r\nunsigned char *cpage_out,\r\nuint32_t *sourcelen, uint32_t *dstlen)\r\n{\r\nint ret;\r\nif (*dstlen <= STREAM_END_SPACE)\r\nreturn -1;\r\nmutex_lock(&deflate_mutex);\r\nif (Z_OK != zlib_deflateInit(&def_strm, 3)) {\r\npr_warn("deflateInit failed\n");\r\nmutex_unlock(&deflate_mutex);\r\nreturn -1;\r\n}\r\ndef_strm.next_in = data_in;\r\ndef_strm.total_in = 0;\r\ndef_strm.next_out = cpage_out;\r\ndef_strm.total_out = 0;\r\nwhile (def_strm.total_out < *dstlen - STREAM_END_SPACE && def_strm.total_in < *sourcelen) {\r\ndef_strm.avail_out = *dstlen - (def_strm.total_out + STREAM_END_SPACE);\r\ndef_strm.avail_in = min((unsigned)(*sourcelen-def_strm.total_in), def_strm.avail_out);\r\njffs2_dbg(1, "calling deflate with avail_in %d, avail_out %d\n",\r\ndef_strm.avail_in, def_strm.avail_out);\r\nret = zlib_deflate(&def_strm, Z_PARTIAL_FLUSH);\r\njffs2_dbg(1, "deflate returned with avail_in %d, avail_out %d, total_in %ld, total_out %ld\n",\r\ndef_strm.avail_in, def_strm.avail_out,\r\ndef_strm.total_in, def_strm.total_out);\r\nif (ret != Z_OK) {\r\njffs2_dbg(1, "deflate in loop returned %d\n", ret);\r\nzlib_deflateEnd(&def_strm);\r\nmutex_unlock(&deflate_mutex);\r\nreturn -1;\r\n}\r\n}\r\ndef_strm.avail_out += STREAM_END_SPACE;\r\ndef_strm.avail_in = 0;\r\nret = zlib_deflate(&def_strm, Z_FINISH);\r\nzlib_deflateEnd(&def_strm);\r\nif (ret != Z_STREAM_END) {\r\njffs2_dbg(1, "final deflate returned %d\n", ret);\r\nret = -1;\r\ngoto out;\r\n}\r\nif (def_strm.total_out >= def_strm.total_in) {\r\njffs2_dbg(1, "zlib compressed %ld bytes into %ld; failing\n",\r\ndef_strm.total_in, def_strm.total_out);\r\nret = -1;\r\ngoto out;\r\n}\r\njffs2_dbg(1, "zlib compressed %ld bytes into %ld\n",\r\ndef_strm.total_in, def_strm.total_out);\r\n*dstlen = def_strm.total_out;\r\n*sourcelen = def_strm.total_in;\r\nret = 0;\r\nout:\r\nmutex_unlock(&deflate_mutex);\r\nreturn ret;\r\n}\r\nstatic int jffs2_zlib_decompress(unsigned char *data_in,\r\nunsigned char *cpage_out,\r\nuint32_t srclen, uint32_t destlen)\r\n{\r\nint ret;\r\nint wbits = MAX_WBITS;\r\nmutex_lock(&inflate_mutex);\r\ninf_strm.next_in = data_in;\r\ninf_strm.avail_in = srclen;\r\ninf_strm.total_in = 0;\r\ninf_strm.next_out = cpage_out;\r\ninf_strm.avail_out = destlen;\r\ninf_strm.total_out = 0;\r\nif (srclen > 2 && !(data_in[1] & PRESET_DICT) &&\r\n((data_in[0] & 0x0f) == Z_DEFLATED) &&\r\n!(((data_in[0]<<8) + data_in[1]) % 31)) {\r\njffs2_dbg(2, "inflate skipping adler32\n");\r\nwbits = -((data_in[0] >> 4) + 8);\r\ninf_strm.next_in += 2;\r\ninf_strm.avail_in -= 2;\r\n} else {\r\njffs2_dbg(1, "inflate not skipping adler32\n");\r\n}\r\nif (Z_OK != zlib_inflateInit2(&inf_strm, wbits)) {\r\npr_warn("inflateInit failed\n");\r\nmutex_unlock(&inflate_mutex);\r\nreturn 1;\r\n}\r\nwhile((ret = zlib_inflate(&inf_strm, Z_FINISH)) == Z_OK)\r\n;\r\nif (ret != Z_STREAM_END) {\r\npr_notice("inflate returned %d\n", ret);\r\n}\r\nzlib_inflateEnd(&inf_strm);\r\nmutex_unlock(&inflate_mutex);\r\nreturn 0;\r\n}\r\nint __init jffs2_zlib_init(void)\r\n{\r\nint ret;\r\nret = alloc_workspaces();\r\nif (ret)\r\nreturn ret;\r\nret = jffs2_register_compressor(&jffs2_zlib_comp);\r\nif (ret)\r\nfree_workspaces();\r\nreturn ret;\r\n}\r\nvoid jffs2_zlib_exit(void)\r\n{\r\njffs2_unregister_compressor(&jffs2_zlib_comp);\r\nfree_workspaces();\r\n}

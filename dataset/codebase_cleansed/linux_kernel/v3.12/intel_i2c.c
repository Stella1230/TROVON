static int get_clock(void *data)\r\n{\r\nstruct psb_intel_i2c_chan *chan = data;\r\nstruct drm_device *dev = chan->drm_dev;\r\nu32 val;\r\nval = REG_READ(chan->reg);\r\nreturn (val & GPIO_CLOCK_VAL_IN) != 0;\r\n}\r\nstatic int get_data(void *data)\r\n{\r\nstruct psb_intel_i2c_chan *chan = data;\r\nstruct drm_device *dev = chan->drm_dev;\r\nu32 val;\r\nval = REG_READ(chan->reg);\r\nreturn (val & GPIO_DATA_VAL_IN) != 0;\r\n}\r\nstatic void set_clock(void *data, int state_high)\r\n{\r\nstruct psb_intel_i2c_chan *chan = data;\r\nstruct drm_device *dev = chan->drm_dev;\r\nu32 reserved = 0, clock_bits;\r\nreserved =\r\nREG_READ(chan->reg) & (GPIO_DATA_PULLUP_DISABLE |\r\nGPIO_CLOCK_PULLUP_DISABLE);\r\nif (state_high)\r\nclock_bits = GPIO_CLOCK_DIR_IN | GPIO_CLOCK_DIR_MASK;\r\nelse\r\nclock_bits = GPIO_CLOCK_DIR_OUT | GPIO_CLOCK_DIR_MASK |\r\nGPIO_CLOCK_VAL_MASK;\r\nREG_WRITE(chan->reg, reserved | clock_bits);\r\nudelay(I2C_RISEFALL_TIME);\r\n}\r\nstatic void set_data(void *data, int state_high)\r\n{\r\nstruct psb_intel_i2c_chan *chan = data;\r\nstruct drm_device *dev = chan->drm_dev;\r\nu32 reserved = 0, data_bits;\r\nreserved =\r\nREG_READ(chan->reg) & (GPIO_DATA_PULLUP_DISABLE |\r\nGPIO_CLOCK_PULLUP_DISABLE);\r\nif (state_high)\r\ndata_bits = GPIO_DATA_DIR_IN | GPIO_DATA_DIR_MASK;\r\nelse\r\ndata_bits =\r\nGPIO_DATA_DIR_OUT | GPIO_DATA_DIR_MASK |\r\nGPIO_DATA_VAL_MASK;\r\nREG_WRITE(chan->reg, reserved | data_bits);\r\nudelay(I2C_RISEFALL_TIME);\r\n}\r\nstruct psb_intel_i2c_chan *psb_intel_i2c_create(struct drm_device *dev,\r\nconst u32 reg, const char *name)\r\n{\r\nstruct psb_intel_i2c_chan *chan;\r\nchan = kzalloc(sizeof(struct psb_intel_i2c_chan), GFP_KERNEL);\r\nif (!chan)\r\ngoto out_free;\r\nchan->drm_dev = dev;\r\nchan->reg = reg;\r\nsnprintf(chan->adapter.name, I2C_NAME_SIZE, "intel drm %s", name);\r\nchan->adapter.owner = THIS_MODULE;\r\nchan->adapter.algo_data = &chan->algo;\r\nchan->adapter.dev.parent = &dev->pdev->dev;\r\nchan->algo.setsda = set_data;\r\nchan->algo.setscl = set_clock;\r\nchan->algo.getsda = get_data;\r\nchan->algo.getscl = get_clock;\r\nchan->algo.udelay = 20;\r\nchan->algo.timeout = usecs_to_jiffies(2200);\r\nchan->algo.data = chan;\r\ni2c_set_adapdata(&chan->adapter, chan);\r\nif (i2c_bit_add_bus(&chan->adapter))\r\ngoto out_free;\r\nset_data(chan, 1);\r\nset_clock(chan, 1);\r\nudelay(20);\r\nreturn chan;\r\nout_free:\r\nkfree(chan);\r\nreturn NULL;\r\n}\r\nvoid psb_intel_i2c_destroy(struct psb_intel_i2c_chan *chan)\r\n{\r\nif (!chan)\r\nreturn;\r\ni2c_del_adapter(&chan->adapter);\r\nkfree(chan);\r\n}

static int rc5t583_rtc_alarm_irq_enable(struct device *dev, unsigned enabled)\r\n{\r\nstruct rc5t583 *rc5t583 = dev_get_drvdata(dev->parent);\r\nu8 val;\r\nval = enabled ? SET_YAL : 0;\r\nreturn regmap_update_bits(rc5t583->regmap, RC5T583_RTC_CTL1, SET_YAL,\r\nval);\r\n}\r\nstatic int rc5t583_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct rc5t583 *rc5t583 = dev_get_drvdata(dev->parent);\r\nu8 rtc_data[NUM_TIME_REGS];\r\nint ret;\r\nret = regmap_bulk_read(rc5t583->regmap, RC5T583_RTC_SEC, rtc_data,\r\nNUM_TIME_REGS);\r\nif (ret < 0) {\r\ndev_err(dev, "RTC read time failed with err:%d\n", ret);\r\nreturn ret;\r\n}\r\ntm->tm_sec = bcd2bin(rtc_data[0]);\r\ntm->tm_min = bcd2bin(rtc_data[1]);\r\ntm->tm_hour = bcd2bin(rtc_data[2]);\r\ntm->tm_wday = bcd2bin(rtc_data[3]);\r\ntm->tm_mday = bcd2bin(rtc_data[4]);\r\ntm->tm_mon = bcd2bin(rtc_data[5]) - 1;\r\ntm->tm_year = bcd2bin(rtc_data[6]) + 100;\r\nreturn ret;\r\n}\r\nstatic int rc5t583_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct rc5t583 *rc5t583 = dev_get_drvdata(dev->parent);\r\nunsigned char rtc_data[NUM_TIME_REGS];\r\nint ret;\r\nrtc_data[0] = bin2bcd(tm->tm_sec);\r\nrtc_data[1] = bin2bcd(tm->tm_min);\r\nrtc_data[2] = bin2bcd(tm->tm_hour);\r\nrtc_data[3] = bin2bcd(tm->tm_wday);\r\nrtc_data[4] = bin2bcd(tm->tm_mday);\r\nrtc_data[5] = bin2bcd(tm->tm_mon + 1);\r\nrtc_data[6] = bin2bcd(tm->tm_year - 100);\r\nret = regmap_bulk_write(rc5t583->regmap, RC5T583_RTC_SEC, rtc_data,\r\nNUM_TIME_REGS);\r\nif (ret < 0) {\r\ndev_err(dev, "RTC set time failed with error %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn ret;\r\n}\r\nstatic int rc5t583_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alm)\r\n{\r\nstruct rc5t583 *rc5t583 = dev_get_drvdata(dev->parent);\r\nunsigned char alarm_data[NUM_YAL_REGS];\r\nu32 interrupt_enable;\r\nint ret;\r\nret = regmap_bulk_read(rc5t583->regmap, RC5T583_RTC_AY_MIN, alarm_data,\r\nNUM_YAL_REGS);\r\nif (ret < 0) {\r\ndev_err(dev, "rtc_read_alarm error %d\n", ret);\r\nreturn ret;\r\n}\r\nalm->time.tm_min = bcd2bin(alarm_data[0]);\r\nalm->time.tm_hour = bcd2bin(alarm_data[1]);\r\nalm->time.tm_mday = bcd2bin(alarm_data[2]);\r\nalm->time.tm_mon = bcd2bin(alarm_data[3]) - 1;\r\nalm->time.tm_year = bcd2bin(alarm_data[4]) + 100;\r\nret = regmap_read(rc5t583->regmap, RC5T583_RTC_CTL1, &interrupt_enable);\r\nif (ret < 0)\r\nreturn ret;\r\nif (interrupt_enable & SET_YAL)\r\nalm->enabled = 1;\r\nreturn ret;\r\n}\r\nstatic int rc5t583_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alm)\r\n{\r\nstruct rc5t583 *rc5t583 = dev_get_drvdata(dev->parent);\r\nunsigned char alarm_data[NUM_YAL_REGS];\r\nint ret;\r\nret = rc5t583_rtc_alarm_irq_enable(dev, 0);\r\nif (ret)\r\nreturn ret;\r\nalarm_data[0] = bin2bcd(alm->time.tm_min);\r\nalarm_data[1] = bin2bcd(alm->time.tm_hour);\r\nalarm_data[2] = bin2bcd(alm->time.tm_mday);\r\nalarm_data[3] = bin2bcd(alm->time.tm_mon + 1);\r\nalarm_data[4] = bin2bcd(alm->time.tm_year - 100);\r\nret = regmap_bulk_write(rc5t583->regmap, RC5T583_RTC_AY_MIN, alarm_data,\r\nNUM_YAL_REGS);\r\nif (ret) {\r\ndev_err(dev, "rtc_set_alarm error %d\n", ret);\r\nreturn ret;\r\n}\r\nif (alm->enabled)\r\nret = rc5t583_rtc_alarm_irq_enable(dev, 1);\r\nreturn ret;\r\n}\r\nstatic irqreturn_t rc5t583_rtc_interrupt(int irq, void *rtc)\r\n{\r\nstruct device *dev = rtc;\r\nstruct rc5t583 *rc5t583 = dev_get_drvdata(dev->parent);\r\nstruct rc5t583_rtc *rc5t583_rtc = dev_get_drvdata(dev);\r\nunsigned long events = 0;\r\nint ret;\r\nu32 rtc_reg;\r\nret = regmap_read(rc5t583->regmap, RC5T583_RTC_CTL2, &rtc_reg);\r\nif (ret < 0)\r\nreturn IRQ_NONE;\r\nif (rtc_reg & GET_YAL_STATUS) {\r\nevents = RTC_IRQF | RTC_AF;\r\nrtc_reg &= ~GET_YAL_STATUS;\r\n}\r\nret = regmap_write(rc5t583->regmap, RC5T583_RTC_CTL2, rtc_reg);\r\nif (ret)\r\nreturn IRQ_NONE;\r\nrtc_update_irq(rc5t583_rtc->rtc, 1, events);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int rc5t583_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct rc5t583 *rc5t583 = dev_get_drvdata(pdev->dev.parent);\r\nstruct rc5t583_rtc *ricoh_rtc;\r\nstruct rc5t583_platform_data *pmic_plat_data;\r\nint ret;\r\nint irq;\r\nricoh_rtc = devm_kzalloc(&pdev->dev, sizeof(struct rc5t583_rtc),\r\nGFP_KERNEL);\r\nif (!ricoh_rtc)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, ricoh_rtc);\r\nret = regmap_write(rc5t583->regmap, RC5T583_RTC_CTL2, 0);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_write(rc5t583->regmap, RC5T583_RTC_ADJ, 0);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "unable to program rtc_adjust reg\n");\r\nreturn -EBUSY;\r\n}\r\npmic_plat_data = dev_get_platdata(rc5t583->dev);\r\nirq = pmic_plat_data->irq_base;\r\nif (irq <= 0) {\r\ndev_warn(&pdev->dev, "Wake up is not possible as irq = %d\n",\r\nirq);\r\nreturn ret;\r\n}\r\nirq += RC5T583_IRQ_YALE;\r\nret = devm_request_threaded_irq(&pdev->dev, irq, NULL,\r\nrc5t583_rtc_interrupt, IRQF_TRIGGER_LOW,\r\n"rtc-rc5t583", &pdev->dev);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "IRQ is not free.\n");\r\nreturn ret;\r\n}\r\ndevice_init_wakeup(&pdev->dev, 1);\r\nricoh_rtc->rtc = devm_rtc_device_register(&pdev->dev, pdev->name,\r\n&rc5t583_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(ricoh_rtc->rtc)) {\r\nret = PTR_ERR(ricoh_rtc->rtc);\r\ndev_err(&pdev->dev, "RTC device register: err %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rc5t583_rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct rc5t583_rtc *rc5t583_rtc = platform_get_drvdata(pdev);\r\nrc5t583_rtc_alarm_irq_enable(&rc5t583_rtc->rtc->dev, 0);\r\nreturn 0;\r\n}\r\nstatic int rc5t583_rtc_suspend(struct device *dev)\r\n{\r\nstruct rc5t583 *rc5t583 = dev_get_drvdata(dev->parent);\r\nstruct rc5t583_rtc *rc5t583_rtc = dev_get_drvdata(dev);\r\nint ret;\r\nret = regmap_read(rc5t583->regmap, RC5T583_RTC_CTL1,\r\n&rc5t583_rtc->irqen);\r\nreturn ret;\r\n}\r\nstatic int rc5t583_rtc_resume(struct device *dev)\r\n{\r\nstruct rc5t583 *rc5t583 = dev_get_drvdata(dev->parent);\r\nstruct rc5t583_rtc *rc5t583_rtc = dev_get_drvdata(dev);\r\nreturn regmap_write(rc5t583->regmap, RC5T583_RTC_CTL1,\r\nrc5t583_rtc->irqen);\r\n}

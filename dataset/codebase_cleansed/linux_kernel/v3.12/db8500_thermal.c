static int db8500_thermal_match_cdev(struct thermal_cooling_device *cdev,\r\nstruct db8500_trip_point *trip_point)\r\n{\r\nint i;\r\nif (!strlen(cdev->type))\r\nreturn -EINVAL;\r\nfor (i = 0; i < COOLING_DEV_MAX; i++) {\r\nif (!strcmp(trip_point->cdev_name[i], cdev->type))\r\nreturn 0;\r\n}\r\nreturn -ENODEV;\r\n}\r\nstatic int db8500_cdev_bind(struct thermal_zone_device *thermal,\r\nstruct thermal_cooling_device *cdev)\r\n{\r\nstruct db8500_thermal_zone *pzone = thermal->devdata;\r\nstruct db8500_thsens_platform_data *ptrips = pzone->trip_tab;\r\nunsigned long max_state, upper, lower;\r\nint i, ret = -EINVAL;\r\ncdev->ops->get_max_state(cdev, &max_state);\r\nfor (i = 0; i < ptrips->num_trips; i++) {\r\nif (db8500_thermal_match_cdev(cdev, &ptrips->trip_points[i]))\r\ncontinue;\r\nupper = lower = i > max_state ? max_state : i;\r\nret = thermal_zone_bind_cooling_device(thermal, i, cdev,\r\nupper, lower);\r\ndev_info(&cdev->device, "%s bind to %d: %d-%s\n", cdev->type,\r\ni, ret, ret ? "fail" : "succeed");\r\n}\r\nreturn ret;\r\n}\r\nstatic int db8500_cdev_unbind(struct thermal_zone_device *thermal,\r\nstruct thermal_cooling_device *cdev)\r\n{\r\nstruct db8500_thermal_zone *pzone = thermal->devdata;\r\nstruct db8500_thsens_platform_data *ptrips = pzone->trip_tab;\r\nint i, ret = -EINVAL;\r\nfor (i = 0; i < ptrips->num_trips; i++) {\r\nif (db8500_thermal_match_cdev(cdev, &ptrips->trip_points[i]))\r\ncontinue;\r\nret = thermal_zone_unbind_cooling_device(thermal, i, cdev);\r\ndev_info(&cdev->device, "%s unbind from %d: %s\n", cdev->type,\r\ni, ret ? "fail" : "succeed");\r\n}\r\nreturn ret;\r\n}\r\nstatic int db8500_sys_get_temp(struct thermal_zone_device *thermal,\r\nunsigned long *temp)\r\n{\r\nstruct db8500_thermal_zone *pzone = thermal->devdata;\r\n*temp = pzone->cur_temp_pseudo;\r\nreturn 0;\r\n}\r\nstatic int db8500_sys_get_trend(struct thermal_zone_device *thermal,\r\nint trip, enum thermal_trend *trend)\r\n{\r\nstruct db8500_thermal_zone *pzone = thermal->devdata;\r\n*trend = pzone->trend;\r\nreturn 0;\r\n}\r\nstatic int db8500_sys_get_mode(struct thermal_zone_device *thermal,\r\nenum thermal_device_mode *mode)\r\n{\r\nstruct db8500_thermal_zone *pzone = thermal->devdata;\r\nmutex_lock(&pzone->th_lock);\r\n*mode = pzone->mode;\r\nmutex_unlock(&pzone->th_lock);\r\nreturn 0;\r\n}\r\nstatic int db8500_sys_set_mode(struct thermal_zone_device *thermal,\r\nenum thermal_device_mode mode)\r\n{\r\nstruct db8500_thermal_zone *pzone = thermal->devdata;\r\nmutex_lock(&pzone->th_lock);\r\npzone->mode = mode;\r\nif (mode == THERMAL_DEVICE_ENABLED)\r\nschedule_work(&pzone->therm_work);\r\nmutex_unlock(&pzone->th_lock);\r\nreturn 0;\r\n}\r\nstatic int db8500_sys_get_trip_type(struct thermal_zone_device *thermal,\r\nint trip, enum thermal_trip_type *type)\r\n{\r\nstruct db8500_thermal_zone *pzone = thermal->devdata;\r\nstruct db8500_thsens_platform_data *ptrips = pzone->trip_tab;\r\nif (trip >= ptrips->num_trips)\r\nreturn -EINVAL;\r\n*type = ptrips->trip_points[trip].type;\r\nreturn 0;\r\n}\r\nstatic int db8500_sys_get_trip_temp(struct thermal_zone_device *thermal,\r\nint trip, unsigned long *temp)\r\n{\r\nstruct db8500_thermal_zone *pzone = thermal->devdata;\r\nstruct db8500_thsens_platform_data *ptrips = pzone->trip_tab;\r\nif (trip >= ptrips->num_trips)\r\nreturn -EINVAL;\r\n*temp = ptrips->trip_points[trip].temp;\r\nreturn 0;\r\n}\r\nstatic int db8500_sys_get_crit_temp(struct thermal_zone_device *thermal,\r\nunsigned long *temp)\r\n{\r\nstruct db8500_thermal_zone *pzone = thermal->devdata;\r\nstruct db8500_thsens_platform_data *ptrips = pzone->trip_tab;\r\nint i;\r\nfor (i = ptrips->num_trips - 1; i > 0; i--) {\r\nif (ptrips->trip_points[i].type == THERMAL_TRIP_CRITICAL) {\r\n*temp = ptrips->trip_points[i].temp;\r\nreturn 0;\r\n}\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic void db8500_thermal_update_config(struct db8500_thermal_zone *pzone,\r\nunsigned int idx, enum thermal_trend trend,\r\nunsigned long next_low, unsigned long next_high)\r\n{\r\nprcmu_stop_temp_sense();\r\npzone->cur_index = idx;\r\npzone->cur_temp_pseudo = (next_low + next_high)/2;\r\npzone->trend = trend;\r\nprcmu_config_hotmon((u8)(next_low/1000), (u8)(next_high/1000));\r\nprcmu_start_temp_sense(PRCMU_DEFAULT_MEASURE_TIME);\r\n}\r\nstatic irqreturn_t prcmu_low_irq_handler(int irq, void *irq_data)\r\n{\r\nstruct db8500_thermal_zone *pzone = irq_data;\r\nstruct db8500_thsens_platform_data *ptrips = pzone->trip_tab;\r\nunsigned int idx = pzone->cur_index;\r\nunsigned long next_low, next_high;\r\nif (unlikely(idx == 0))\r\nreturn IRQ_HANDLED;\r\nif (idx == 1) {\r\nnext_high = ptrips->trip_points[0].temp;\r\nnext_low = PRCMU_DEFAULT_LOW_TEMP;\r\n} else {\r\nnext_high = ptrips->trip_points[idx-1].temp;\r\nnext_low = ptrips->trip_points[idx-2].temp;\r\n}\r\nidx -= 1;\r\ndb8500_thermal_update_config(pzone, idx, THERMAL_TREND_DROPPING,\r\nnext_low, next_high);\r\ndev_dbg(&pzone->therm_dev->device,\r\n"PRCMU set max %ld, min %ld\n", next_high, next_low);\r\nschedule_work(&pzone->therm_work);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t prcmu_high_irq_handler(int irq, void *irq_data)\r\n{\r\nstruct db8500_thermal_zone *pzone = irq_data;\r\nstruct db8500_thsens_platform_data *ptrips = pzone->trip_tab;\r\nunsigned int idx = pzone->cur_index;\r\nunsigned long next_low, next_high;\r\nif (idx < ptrips->num_trips - 1) {\r\nnext_high = ptrips->trip_points[idx+1].temp;\r\nnext_low = ptrips->trip_points[idx].temp;\r\nidx += 1;\r\ndb8500_thermal_update_config(pzone, idx, THERMAL_TREND_RAISING,\r\nnext_low, next_high);\r\ndev_dbg(&pzone->therm_dev->device,\r\n"PRCMU set max %ld, min %ld\n", next_high, next_low);\r\n} else if (idx == ptrips->num_trips - 1)\r\npzone->cur_temp_pseudo = ptrips->trip_points[idx].temp + 1;\r\nschedule_work(&pzone->therm_work);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void db8500_thermal_work(struct work_struct *work)\r\n{\r\nenum thermal_device_mode cur_mode;\r\nstruct db8500_thermal_zone *pzone;\r\npzone = container_of(work, struct db8500_thermal_zone, therm_work);\r\nmutex_lock(&pzone->th_lock);\r\ncur_mode = pzone->mode;\r\nmutex_unlock(&pzone->th_lock);\r\nif (cur_mode == THERMAL_DEVICE_DISABLED)\r\nreturn;\r\nthermal_zone_device_update(pzone->therm_dev);\r\ndev_dbg(&pzone->therm_dev->device, "thermal work finished.\n");\r\n}\r\nstatic struct db8500_thsens_platform_data*\r\ndb8500_thermal_parse_dt(struct platform_device *pdev)\r\n{\r\nstruct db8500_thsens_platform_data *ptrips;\r\nstruct device_node *np = pdev->dev.of_node;\r\nchar prop_name[32];\r\nconst char *tmp_str;\r\nu32 tmp_data;\r\nint i, j;\r\nptrips = devm_kzalloc(&pdev->dev, sizeof(*ptrips), GFP_KERNEL);\r\nif (!ptrips)\r\nreturn NULL;\r\nif (of_property_read_u32(np, "num-trips", &tmp_data))\r\ngoto err_parse_dt;\r\nif (tmp_data > THERMAL_MAX_TRIPS)\r\ngoto err_parse_dt;\r\nptrips->num_trips = tmp_data;\r\nfor (i = 0; i < ptrips->num_trips; i++) {\r\nsprintf(prop_name, "trip%d-temp", i);\r\nif (of_property_read_u32(np, prop_name, &tmp_data))\r\ngoto err_parse_dt;\r\nptrips->trip_points[i].temp = tmp_data;\r\nsprintf(prop_name, "trip%d-type", i);\r\nif (of_property_read_string(np, prop_name, &tmp_str))\r\ngoto err_parse_dt;\r\nif (!strcmp(tmp_str, "active"))\r\nptrips->trip_points[i].type = THERMAL_TRIP_ACTIVE;\r\nelse if (!strcmp(tmp_str, "passive"))\r\nptrips->trip_points[i].type = THERMAL_TRIP_PASSIVE;\r\nelse if (!strcmp(tmp_str, "hot"))\r\nptrips->trip_points[i].type = THERMAL_TRIP_HOT;\r\nelse if (!strcmp(tmp_str, "critical"))\r\nptrips->trip_points[i].type = THERMAL_TRIP_CRITICAL;\r\nelse\r\ngoto err_parse_dt;\r\nsprintf(prop_name, "trip%d-cdev-num", i);\r\nif (of_property_read_u32(np, prop_name, &tmp_data))\r\ngoto err_parse_dt;\r\nif (tmp_data > COOLING_DEV_MAX)\r\ngoto err_parse_dt;\r\nfor (j = 0; j < tmp_data; j++) {\r\nsprintf(prop_name, "trip%d-cdev-name%d", i, j);\r\nif (of_property_read_string(np, prop_name, &tmp_str))\r\ngoto err_parse_dt;\r\nif (strlen(tmp_str) >= THERMAL_NAME_LENGTH)\r\ngoto err_parse_dt;\r\nstrcpy(ptrips->trip_points[i].cdev_name[j], tmp_str);\r\n}\r\n}\r\nreturn ptrips;\r\nerr_parse_dt:\r\ndev_err(&pdev->dev, "Parsing device tree data error.\n");\r\nreturn NULL;\r\n}\r\nstatic inline struct db8500_thsens_platform_data*\r\ndb8500_thermal_parse_dt(struct platform_device *pdev)\r\n{\r\nreturn NULL;\r\n}\r\nstatic int db8500_thermal_probe(struct platform_device *pdev)\r\n{\r\nstruct db8500_thermal_zone *pzone = NULL;\r\nstruct db8500_thsens_platform_data *ptrips = NULL;\r\nstruct device_node *np = pdev->dev.of_node;\r\nint low_irq, high_irq, ret = 0;\r\nunsigned long dft_low, dft_high;\r\nif (np)\r\nptrips = db8500_thermal_parse_dt(pdev);\r\nelse\r\nptrips = dev_get_platdata(&pdev->dev);\r\nif (!ptrips)\r\nreturn -EINVAL;\r\npzone = devm_kzalloc(&pdev->dev, sizeof(*pzone), GFP_KERNEL);\r\nif (!pzone)\r\nreturn -ENOMEM;\r\nmutex_init(&pzone->th_lock);\r\nmutex_lock(&pzone->th_lock);\r\npzone->mode = THERMAL_DEVICE_DISABLED;\r\npzone->trip_tab = ptrips;\r\nINIT_WORK(&pzone->therm_work, db8500_thermal_work);\r\nlow_irq = platform_get_irq_byname(pdev, "IRQ_HOTMON_LOW");\r\nif (low_irq < 0) {\r\ndev_err(&pdev->dev, "Get IRQ_HOTMON_LOW failed.\n");\r\nret = low_irq;\r\ngoto out_unlock;\r\n}\r\nret = devm_request_threaded_irq(&pdev->dev, low_irq, NULL,\r\nprcmu_low_irq_handler, IRQF_NO_SUSPEND | IRQF_ONESHOT,\r\n"dbx500_temp_low", pzone);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Failed to allocate temp low irq.\n");\r\ngoto out_unlock;\r\n}\r\nhigh_irq = platform_get_irq_byname(pdev, "IRQ_HOTMON_HIGH");\r\nif (high_irq < 0) {\r\ndev_err(&pdev->dev, "Get IRQ_HOTMON_HIGH failed.\n");\r\nret = high_irq;\r\ngoto out_unlock;\r\n}\r\nret = devm_request_threaded_irq(&pdev->dev, high_irq, NULL,\r\nprcmu_high_irq_handler, IRQF_NO_SUSPEND | IRQF_ONESHOT,\r\n"dbx500_temp_high", pzone);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Failed to allocate temp high irq.\n");\r\ngoto out_unlock;\r\n}\r\npzone->therm_dev = thermal_zone_device_register("db8500_thermal_zone",\r\nptrips->num_trips, 0, pzone, &thdev_ops, NULL, 0, 0);\r\nif (IS_ERR(pzone->therm_dev)) {\r\ndev_err(&pdev->dev, "Register thermal zone device failed.\n");\r\nret = PTR_ERR(pzone->therm_dev);\r\ngoto out_unlock;\r\n}\r\ndev_info(&pdev->dev, "Thermal zone device registered.\n");\r\ndft_low = PRCMU_DEFAULT_LOW_TEMP;\r\ndft_high = ptrips->trip_points[0].temp;\r\ndb8500_thermal_update_config(pzone, 0, THERMAL_TREND_STABLE,\r\ndft_low, dft_high);\r\nplatform_set_drvdata(pdev, pzone);\r\npzone->mode = THERMAL_DEVICE_ENABLED;\r\nout_unlock:\r\nmutex_unlock(&pzone->th_lock);\r\nreturn ret;\r\n}\r\nstatic int db8500_thermal_remove(struct platform_device *pdev)\r\n{\r\nstruct db8500_thermal_zone *pzone = platform_get_drvdata(pdev);\r\nthermal_zone_device_unregister(pzone->therm_dev);\r\ncancel_work_sync(&pzone->therm_work);\r\nmutex_destroy(&pzone->th_lock);\r\nreturn 0;\r\n}\r\nstatic int db8500_thermal_suspend(struct platform_device *pdev,\r\npm_message_t state)\r\n{\r\nstruct db8500_thermal_zone *pzone = platform_get_drvdata(pdev);\r\nflush_work(&pzone->therm_work);\r\nprcmu_stop_temp_sense();\r\nreturn 0;\r\n}\r\nstatic int db8500_thermal_resume(struct platform_device *pdev)\r\n{\r\nstruct db8500_thermal_zone *pzone = platform_get_drvdata(pdev);\r\nstruct db8500_thsens_platform_data *ptrips = pzone->trip_tab;\r\nunsigned long dft_low, dft_high;\r\ndft_low = PRCMU_DEFAULT_LOW_TEMP;\r\ndft_high = ptrips->trip_points[0].temp;\r\ndb8500_thermal_update_config(pzone, 0, THERMAL_TREND_STABLE,\r\ndft_low, dft_high);\r\nreturn 0;\r\n}

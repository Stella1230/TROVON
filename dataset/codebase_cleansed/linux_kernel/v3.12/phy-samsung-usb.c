int samsung_usbphy_parse_dt(struct samsung_usbphy *sphy)\r\n{\r\nstruct device_node *usbphy_sys;\r\nusbphy_sys = of_get_child_by_name(sphy->dev->of_node, "usbphy-sys");\r\nif (!usbphy_sys) {\r\ndev_err(sphy->dev, "No sys-controller interface for usb-phy\n");\r\nreturn -ENODEV;\r\n}\r\nsphy->pmuregs = of_iomap(usbphy_sys, 0);\r\nif (sphy->pmuregs == NULL) {\r\ndev_err(sphy->dev, "Can't get usb-phy pmu control register\n");\r\ngoto err0;\r\n}\r\nsphy->sysreg = of_iomap(usbphy_sys, 1);\r\nif (sphy->sysreg == NULL)\r\ndev_warn(sphy->dev, "Can't get usb-phy sysreg cfg register\n");\r\nof_node_put(usbphy_sys);\r\nreturn 0;\r\nerr0:\r\nof_node_put(usbphy_sys);\r\nreturn -ENXIO;\r\n}\r\nvoid samsung_usbphy_set_isolation_4210(struct samsung_usbphy *sphy, bool on)\r\n{\r\nvoid __iomem *reg = NULL;\r\nu32 reg_val;\r\nu32 en_mask = 0;\r\nif (!sphy->pmuregs) {\r\ndev_warn(sphy->dev, "Can't set pmu isolation\n");\r\nreturn;\r\n}\r\nif (sphy->phy_type == USB_PHY_TYPE_DEVICE) {\r\nreg = sphy->pmuregs + sphy->drv_data->devphy_reg_offset;\r\nen_mask = sphy->drv_data->devphy_en_mask;\r\n} else if (sphy->phy_type == USB_PHY_TYPE_HOST) {\r\nreg = sphy->pmuregs + sphy->drv_data->hostphy_reg_offset;\r\nen_mask = sphy->drv_data->hostphy_en_mask;\r\n}\r\nreg_val = readl(reg);\r\nif (on)\r\nreg_val &= ~en_mask;\r\nelse\r\nreg_val |= en_mask;\r\nwritel(reg_val, reg);\r\nif (sphy->drv_data->cpu_type == TYPE_EXYNOS4X12) {\r\nwritel(reg_val, sphy->pmuregs + EXYNOS4X12_PHY_HSIC_CTRL0);\r\nwritel(reg_val, sphy->pmuregs + EXYNOS4X12_PHY_HSIC_CTRL1);\r\n}\r\n}\r\nvoid samsung_usbphy_cfg_sel(struct samsung_usbphy *sphy)\r\n{\r\nu32 reg;\r\nif (!sphy->sysreg) {\r\ndev_warn(sphy->dev, "Can't configure specified phy mode\n");\r\nreturn;\r\n}\r\nreg = readl(sphy->sysreg);\r\nif (sphy->phy_type == USB_PHY_TYPE_DEVICE)\r\nreg &= ~EXYNOS_USB20PHY_CFG_HOST_LINK;\r\nelse if (sphy->phy_type == USB_PHY_TYPE_HOST)\r\nreg |= EXYNOS_USB20PHY_CFG_HOST_LINK;\r\nwritel(reg, sphy->sysreg);\r\n}\r\nint samsung_usbphy_set_type(struct usb_phy *phy,\r\nenum samsung_usb_phy_type phy_type)\r\n{\r\nstruct samsung_usbphy *sphy = phy_to_sphy(phy);\r\nsphy->phy_type = phy_type;\r\nreturn 0;\r\n}\r\nint samsung_usbphy_rate_to_clksel_64xx(struct samsung_usbphy *sphy,\r\nunsigned long rate)\r\n{\r\nunsigned int clksel;\r\nswitch (rate) {\r\ncase 12 * MHZ:\r\nclksel = PHYCLK_CLKSEL_12M;\r\nbreak;\r\ncase 24 * MHZ:\r\nclksel = PHYCLK_CLKSEL_24M;\r\nbreak;\r\ncase 48 * MHZ:\r\nclksel = PHYCLK_CLKSEL_48M;\r\nbreak;\r\ndefault:\r\ndev_err(sphy->dev,\r\n"Invalid reference clock frequency: %lu\n", rate);\r\nreturn -EINVAL;\r\n}\r\nreturn clksel;\r\n}\r\nint samsung_usbphy_rate_to_clksel_4x12(struct samsung_usbphy *sphy,\r\nunsigned long rate)\r\n{\r\nunsigned int clksel;\r\nswitch (rate) {\r\ncase 9600 * KHZ:\r\nclksel = FSEL_CLKSEL_9600K;\r\nbreak;\r\ncase 10 * MHZ:\r\nclksel = FSEL_CLKSEL_10M;\r\nbreak;\r\ncase 12 * MHZ:\r\nclksel = FSEL_CLKSEL_12M;\r\nbreak;\r\ncase 19200 * KHZ:\r\nclksel = FSEL_CLKSEL_19200K;\r\nbreak;\r\ncase 20 * MHZ:\r\nclksel = FSEL_CLKSEL_20M;\r\nbreak;\r\ncase 24 * MHZ:\r\nclksel = FSEL_CLKSEL_24M;\r\nbreak;\r\ncase 50 * MHZ:\r\nclksel = FSEL_CLKSEL_50M;\r\nbreak;\r\ndefault:\r\ndev_err(sphy->dev,\r\n"Invalid reference clock frequency: %lu\n", rate);\r\nreturn -EINVAL;\r\n}\r\nreturn clksel;\r\n}\r\nint samsung_usbphy_get_refclk_freq(struct samsung_usbphy *sphy)\r\n{\r\nstruct clk *ref_clk;\r\nunsigned long rate;\r\nint refclk_freq;\r\nif (sphy->drv_data->cpu_type == TYPE_EXYNOS5250)\r\nref_clk = clk_get(sphy->dev, "ext_xtal");\r\nelse\r\nref_clk = clk_get(sphy->dev, "xusbxti");\r\nif (IS_ERR(ref_clk)) {\r\ndev_err(sphy->dev, "Failed to get reference clock\n");\r\nreturn PTR_ERR(ref_clk);\r\n}\r\nrate = clk_get_rate(ref_clk);\r\nrefclk_freq = sphy->drv_data->rate_to_clksel(sphy, rate);\r\nclk_put(ref_clk);\r\nreturn refclk_freq;\r\n}

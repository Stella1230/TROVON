static int __init no_initrd(char *str)\r\n{\r\nmount_initrd = 0;\r\nreturn 1;\r\n}\r\nstatic int init_linuxrc(struct subprocess_info *info, struct cred *new)\r\n{\r\nsys_unshare(CLONE_FS | CLONE_FILES);\r\nsys_open("/dev/console", O_RDWR, 0);\r\nsys_dup(0);\r\nsys_dup(0);\r\nsys_chdir("/root");\r\nsys_mount(".", "/", NULL, MS_MOVE, NULL);\r\nsys_chroot(".");\r\nsys_setsid();\r\nreturn 0;\r\n}\r\nstatic void __init handle_initrd(void)\r\n{\r\nstruct subprocess_info *info;\r\nstatic char *argv[] = { "linuxrc", NULL, };\r\nextern char *envp_init[];\r\nint error;\r\nreal_root_dev = new_encode_dev(ROOT_DEV);\r\ncreate_dev("/dev/root.old", Root_RAM0);\r\nmount_block_root("/dev/root.old", root_mountflags & ~MS_RDONLY);\r\nsys_mkdir("/old", 0700);\r\nsys_chdir("/old");\r\nload_default_modules();\r\ncurrent->flags |= PF_FREEZER_SKIP;\r\ninfo = call_usermodehelper_setup("/linuxrc", argv, envp_init,\r\nGFP_KERNEL, init_linuxrc, NULL, NULL);\r\nif (!info)\r\nreturn;\r\ncall_usermodehelper_exec(info, UMH_WAIT_PROC);\r\ncurrent->flags &= ~PF_FREEZER_SKIP;\r\nsys_mount("..", ".", NULL, MS_MOVE, NULL);\r\nsys_chroot("..");\r\nif (new_decode_dev(real_root_dev) == Root_RAM0) {\r\nsys_chdir("/old");\r\nreturn;\r\n}\r\nsys_chdir("/");\r\nROOT_DEV = new_decode_dev(real_root_dev);\r\nmount_root();\r\nprintk(KERN_NOTICE "Trying to move old root to /initrd ... ");\r\nerror = sys_mount("/old", "/root/initrd", NULL, MS_MOVE, NULL);\r\nif (!error)\r\nprintk("okay\n");\r\nelse {\r\nint fd = sys_open("/dev/root.old", O_RDWR, 0);\r\nif (error == -ENOENT)\r\nprintk("/initrd does not exist. Ignored.\n");\r\nelse\r\nprintk("failed\n");\r\nprintk(KERN_NOTICE "Unmounting old root\n");\r\nsys_umount("/old", MNT_DETACH);\r\nprintk(KERN_NOTICE "Trying to free ramdisk memory ... ");\r\nif (fd < 0) {\r\nerror = fd;\r\n} else {\r\nerror = sys_ioctl(fd, BLKFLSBUF, 0);\r\nsys_close(fd);\r\n}\r\nprintk(!error ? "okay\n" : "failed\n");\r\n}\r\n}\r\nint __init initrd_load(void)\r\n{\r\nif (mount_initrd) {\r\ncreate_dev("/dev/ram", Root_RAM0);\r\nif (rd_load_image("/initrd.image") && ROOT_DEV != Root_RAM0) {\r\nsys_unlink("/initrd.image");\r\nhandle_initrd();\r\nreturn 1;\r\n}\r\n}\r\nsys_unlink("/initrd.image");\r\nreturn 0;\r\n}

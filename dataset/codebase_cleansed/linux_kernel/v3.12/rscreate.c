acpi_status\r\nacpi_buffer_to_resource(u8 *aml_buffer,\r\nu16 aml_buffer_length,\r\nstruct acpi_resource **resource_ptr)\r\n{\r\nacpi_status status;\r\nacpi_size list_size_needed;\r\nvoid *resource;\r\nvoid *current_resource_ptr;\r\nstatus = acpi_rs_get_list_length(aml_buffer, aml_buffer_length,\r\n&list_size_needed);\r\nif (status == AE_AML_NO_RESOURCE_END_TAG) {\r\nstatus = AE_OK;\r\n}\r\nif (ACPI_FAILURE(status)) {\r\nreturn (status);\r\n}\r\nresource = ACPI_ALLOCATE_ZEROED(list_size_needed);\r\ncurrent_resource_ptr = resource;\r\nif (!resource) {\r\nreturn (AE_NO_MEMORY);\r\n}\r\nstatus = acpi_ut_walk_aml_resources(NULL, aml_buffer, aml_buffer_length,\r\nacpi_rs_convert_aml_to_resources,\r\n&current_resource_ptr);\r\nif (status == AE_AML_NO_RESOURCE_END_TAG) {\r\nstatus = AE_OK;\r\n}\r\nif (ACPI_FAILURE(status)) {\r\nACPI_FREE(resource);\r\n} else {\r\n*resource_ptr = resource;\r\n}\r\nreturn (status);\r\n}\r\nacpi_status\r\nacpi_rs_create_resource_list(union acpi_operand_object *aml_buffer,\r\nstruct acpi_buffer * output_buffer)\r\n{\r\nacpi_status status;\r\nu8 *aml_start;\r\nacpi_size list_size_needed = 0;\r\nu32 aml_buffer_length;\r\nvoid *resource;\r\nACPI_FUNCTION_TRACE(rs_create_resource_list);\r\nACPI_DEBUG_PRINT((ACPI_DB_INFO, "AmlBuffer = %p\n", aml_buffer));\r\naml_buffer_length = aml_buffer->buffer.length;\r\naml_start = aml_buffer->buffer.pointer;\r\nstatus = acpi_rs_get_list_length(aml_start, aml_buffer_length,\r\n&list_size_needed);\r\nACPI_DEBUG_PRINT((ACPI_DB_INFO, "Status=%X ListSizeNeeded=%X\n",\r\nstatus, (u32) list_size_needed));\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nstatus = acpi_ut_initialize_buffer(output_buffer, list_size_needed);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nresource = output_buffer->pointer;\r\nstatus = acpi_ut_walk_aml_resources(NULL, aml_start, aml_buffer_length,\r\nacpi_rs_convert_aml_to_resources,\r\n&resource);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_INFO, "OutputBuffer %p Length %X\n",\r\noutput_buffer->pointer, (u32) output_buffer->length));\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nacpi_status\r\nacpi_rs_create_pci_routing_table(union acpi_operand_object *package_object,\r\nstruct acpi_buffer *output_buffer)\r\n{\r\nu8 *buffer;\r\nunion acpi_operand_object **top_object_list;\r\nunion acpi_operand_object **sub_object_list;\r\nunion acpi_operand_object *obj_desc;\r\nacpi_size buffer_size_needed = 0;\r\nu32 number_of_elements;\r\nu32 index;\r\nstruct acpi_pci_routing_table *user_prt;\r\nstruct acpi_namespace_node *node;\r\nacpi_status status;\r\nstruct acpi_buffer path_buffer;\r\nACPI_FUNCTION_TRACE(rs_create_pci_routing_table);\r\nstatus = acpi_rs_get_pci_routing_table_length(package_object,\r\n&buffer_size_needed);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_INFO, "BufferSizeNeeded = %X\n",\r\n(u32) buffer_size_needed));\r\nstatus = acpi_ut_initialize_buffer(output_buffer, buffer_size_needed);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\ntop_object_list = package_object->package.elements;\r\nnumber_of_elements = package_object->package.count;\r\nbuffer = output_buffer->pointer;\r\nuser_prt = ACPI_CAST_PTR(struct acpi_pci_routing_table, buffer);\r\nfor (index = 0; index < number_of_elements; index++) {\r\nbuffer += user_prt->length;\r\nuser_prt = ACPI_CAST_PTR(struct acpi_pci_routing_table, buffer);\r\nuser_prt->length = (sizeof(struct acpi_pci_routing_table) - 4);\r\nif ((*top_object_list)->package.count != 4) {\r\nACPI_ERROR((AE_INFO,\r\n"(PRT[%u]) Need package of length 4, found length %u",\r\nindex, (*top_object_list)->package.count));\r\nreturn_ACPI_STATUS(AE_AML_PACKAGE_LIMIT);\r\n}\r\nsub_object_list = (*top_object_list)->package.elements;\r\nobj_desc = sub_object_list[0];\r\nif (obj_desc->common.type != ACPI_TYPE_INTEGER) {\r\nACPI_ERROR((AE_INFO,\r\n"(PRT[%u].Address) Need Integer, found %s",\r\nindex,\r\nacpi_ut_get_object_type_name(obj_desc)));\r\nreturn_ACPI_STATUS(AE_BAD_DATA);\r\n}\r\nuser_prt->address = obj_desc->integer.value;\r\nobj_desc = sub_object_list[1];\r\nif (obj_desc->common.type != ACPI_TYPE_INTEGER) {\r\nACPI_ERROR((AE_INFO,\r\n"(PRT[%u].Pin) Need Integer, found %s",\r\nindex,\r\nacpi_ut_get_object_type_name(obj_desc)));\r\nreturn_ACPI_STATUS(AE_BAD_DATA);\r\n}\r\nuser_prt->pin = (u32) obj_desc->integer.value;\r\nobj_desc = sub_object_list[2];\r\nif (obj_desc) {\r\nswitch (obj_desc->common.type) {\r\ncase ACPI_TYPE_LOCAL_REFERENCE:\r\nif (obj_desc->reference.class !=\r\nACPI_REFCLASS_NAME) {\r\nACPI_ERROR((AE_INFO,\r\n"(PRT[%u].Source) Need name, found Reference Class 0x%X",\r\nindex,\r\nobj_desc->reference.class));\r\nreturn_ACPI_STATUS(AE_BAD_DATA);\r\n}\r\nnode = obj_desc->reference.node;\r\npath_buffer.length = output_buffer->length -\r\n(u32) ((u8 *) user_prt->source -\r\n(u8 *) output_buffer->pointer);\r\npath_buffer.pointer = user_prt->source;\r\nstatus =\r\nacpi_ns_handle_to_pathname((acpi_handle)\r\nnode,\r\n&path_buffer);\r\nuser_prt->length +=\r\n(u32) ACPI_STRLEN(user_prt->source) + 1;\r\nbreak;\r\ncase ACPI_TYPE_STRING:\r\nACPI_STRCPY(user_prt->source,\r\nobj_desc->string.pointer);\r\nuser_prt->length += obj_desc->string.length + 1;\r\nbreak;\r\ncase ACPI_TYPE_INTEGER:\r\nuser_prt->length += sizeof(u32);\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"(PRT[%u].Source) Need Ref/String/Integer, found %s",\r\nindex,\r\nacpi_ut_get_object_type_name\r\n(obj_desc)));\r\nreturn_ACPI_STATUS(AE_BAD_DATA);\r\n}\r\n}\r\nuser_prt->length =\r\n(u32) ACPI_ROUND_UP_TO_64BIT(user_prt->length);\r\nobj_desc = sub_object_list[3];\r\nif (obj_desc->common.type != ACPI_TYPE_INTEGER) {\r\nACPI_ERROR((AE_INFO,\r\n"(PRT[%u].SourceIndex) Need Integer, found %s",\r\nindex,\r\nacpi_ut_get_object_type_name(obj_desc)));\r\nreturn_ACPI_STATUS(AE_BAD_DATA);\r\n}\r\nuser_prt->source_index = (u32) obj_desc->integer.value;\r\ntop_object_list++;\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_INFO, "OutputBuffer %p Length %X\n",\r\noutput_buffer->pointer, (u32) output_buffer->length));\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nacpi_status\r\nacpi_rs_create_aml_resources(struct acpi_resource *linked_list_buffer,\r\nstruct acpi_buffer *output_buffer)\r\n{\r\nacpi_status status;\r\nacpi_size aml_size_needed = 0;\r\nACPI_FUNCTION_TRACE(rs_create_aml_resources);\r\nACPI_DEBUG_PRINT((ACPI_DB_INFO, "LinkedListBuffer = %p\n",\r\nlinked_list_buffer));\r\nstatus = acpi_rs_get_aml_length(linked_list_buffer, &aml_size_needed);\r\nACPI_DEBUG_PRINT((ACPI_DB_INFO, "AmlSizeNeeded=%X, %s\n",\r\n(u32)aml_size_needed, acpi_format_exception(status)));\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nstatus = acpi_ut_initialize_buffer(output_buffer, aml_size_needed);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nstatus =\r\nacpi_rs_convert_resources_to_aml(linked_list_buffer,\r\naml_size_needed,\r\noutput_buffer->pointer);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_INFO, "OutputBuffer %p Length %X\n",\r\noutput_buffer->pointer, (u32) output_buffer->length));\r\nreturn_ACPI_STATUS(AE_OK);\r\n}

static int gre_gso_send_check(struct sk_buff *skb)\r\n{\r\nif (!skb->encapsulation)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic struct sk_buff *gre_gso_segment(struct sk_buff *skb,\r\nnetdev_features_t features)\r\n{\r\nstruct sk_buff *segs = ERR_PTR(-EINVAL);\r\nnetdev_features_t enc_features;\r\nint ghl = GRE_HEADER_SECTION;\r\nstruct gre_base_hdr *greh;\r\nint mac_len = skb->mac_len;\r\n__be16 protocol = skb->protocol;\r\nint tnl_hlen;\r\nbool csum;\r\nif (unlikely(skb_shinfo(skb)->gso_type &\r\n~(SKB_GSO_TCPV4 |\r\nSKB_GSO_TCPV6 |\r\nSKB_GSO_UDP |\r\nSKB_GSO_DODGY |\r\nSKB_GSO_TCP_ECN |\r\nSKB_GSO_GRE)))\r\ngoto out;\r\nif (unlikely(!pskb_may_pull(skb, sizeof(*greh))))\r\ngoto out;\r\ngreh = (struct gre_base_hdr *)skb_transport_header(skb);\r\nif (greh->flags & GRE_KEY)\r\nghl += GRE_HEADER_SECTION;\r\nif (greh->flags & GRE_SEQ)\r\nghl += GRE_HEADER_SECTION;\r\nif (greh->flags & GRE_CSUM) {\r\nghl += GRE_HEADER_SECTION;\r\ncsum = true;\r\n} else\r\ncsum = false;\r\nskb->protocol = greh->protocol;\r\nskb->encapsulation = 0;\r\nif (unlikely(!pskb_may_pull(skb, ghl)))\r\ngoto out;\r\n__skb_pull(skb, ghl);\r\nskb_reset_mac_header(skb);\r\nskb_set_network_header(skb, skb_inner_network_offset(skb));\r\nskb->mac_len = skb_inner_network_offset(skb);\r\nenc_features = skb->dev->hw_enc_features & netif_skb_features(skb);\r\nsegs = skb_mac_gso_segment(skb, enc_features);\r\nif (!segs || IS_ERR(segs))\r\ngoto out;\r\nskb = segs;\r\ntnl_hlen = skb_tnl_header_len(skb);\r\ndo {\r\n__skb_push(skb, ghl);\r\nif (csum) {\r\n__be32 *pcsum;\r\nif (skb_has_shared_frag(skb)) {\r\nint err;\r\nerr = __skb_linearize(skb);\r\nif (err) {\r\nkfree_skb_list(segs);\r\nsegs = ERR_PTR(err);\r\ngoto out;\r\n}\r\n}\r\ngreh = (struct gre_base_hdr *)(skb->data);\r\npcsum = (__be32 *)(greh + 1);\r\n*pcsum = 0;\r\n*(__sum16 *)pcsum = csum_fold(skb_checksum(skb, 0, skb->len, 0));\r\n}\r\n__skb_push(skb, tnl_hlen - ghl);\r\nskb_reset_inner_headers(skb);\r\nskb->encapsulation = 1;\r\nskb_reset_mac_header(skb);\r\nskb_set_network_header(skb, mac_len);\r\nskb->mac_len = mac_len;\r\nskb->protocol = protocol;\r\n} while ((skb = skb->next));\r\nout:\r\nreturn segs;\r\n}\r\nint __init gre_offload_init(void)\r\n{\r\nreturn inet_add_offload(&gre_offload, IPPROTO_GRE);\r\n}\r\nvoid __exit gre_offload_exit(void)\r\n{\r\ninet_del_offload(&gre_offload, IPPROTO_GRE);\r\n}

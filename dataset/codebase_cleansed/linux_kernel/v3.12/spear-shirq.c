static void shirq_irq_mask_unmask(struct irq_data *d, bool mask)\r\n{\r\nstruct spear_shirq *shirq = irq_data_get_irq_chip_data(d);\r\nu32 val, offset = d->irq - shirq->irq_base;\r\nunsigned long flags;\r\nif (shirq->regs.enb_reg == -1)\r\nreturn;\r\nspin_lock_irqsave(&lock, flags);\r\nval = readl(shirq->base + shirq->regs.enb_reg);\r\nif (mask ^ shirq->regs.reset_to_enb)\r\nval &= ~(0x1 << shirq->irq_bit_off << offset);\r\nelse\r\nval |= 0x1 << shirq->irq_bit_off << offset;\r\nwritel(val, shirq->base + shirq->regs.enb_reg);\r\nspin_unlock_irqrestore(&lock, flags);\r\n}\r\nstatic void shirq_irq_mask(struct irq_data *d)\r\n{\r\nshirq_irq_mask_unmask(d, 1);\r\n}\r\nstatic void shirq_irq_unmask(struct irq_data *d)\r\n{\r\nshirq_irq_mask_unmask(d, 0);\r\n}\r\nstatic void shirq_handler(unsigned irq, struct irq_desc *desc)\r\n{\r\nu32 i, j, val, mask, tmp;\r\nstruct irq_chip *chip;\r\nstruct spear_shirq *shirq = irq_get_handler_data(irq);\r\nchip = irq_get_chip(irq);\r\nchip->irq_ack(&desc->irq_data);\r\nmask = ((0x1 << shirq->irq_nr) - 1) << shirq->irq_bit_off;\r\nwhile ((val = readl(shirq->base + shirq->regs.status_reg) &\r\nmask)) {\r\nval >>= shirq->irq_bit_off;\r\nfor (i = 0, j = 1; i < shirq->irq_nr; i++, j <<= 1) {\r\nif (!(j & val))\r\ncontinue;\r\ngeneric_handle_irq(shirq->irq_base + i);\r\nif (shirq->regs.clear_reg == -1)\r\ncontinue;\r\ntmp = readl(shirq->base + shirq->regs.clear_reg);\r\nif (shirq->regs.reset_to_clear)\r\ntmp &= ~(j << shirq->irq_bit_off);\r\nelse\r\ntmp |= (j << shirq->irq_bit_off);\r\nwritel(tmp, shirq->base + shirq->regs.clear_reg);\r\n}\r\n}\r\nchip->irq_unmask(&desc->irq_data);\r\n}\r\nstatic void __init spear_shirq_register(struct spear_shirq *shirq)\r\n{\r\nint i;\r\nif (shirq->invalid_irq)\r\nreturn;\r\nirq_set_chained_handler(shirq->irq, shirq_handler);\r\nfor (i = 0; i < shirq->irq_nr; i++) {\r\nirq_set_chip_and_handler(shirq->irq_base + i,\r\n&shirq_chip, handle_simple_irq);\r\nset_irq_flags(shirq->irq_base + i, IRQF_VALID);\r\nirq_set_chip_data(shirq->irq_base + i, shirq);\r\n}\r\nirq_set_handler_data(shirq->irq, shirq);\r\n}\r\nstatic int __init shirq_init(struct spear_shirq **shirq_blocks, int block_nr,\r\nstruct device_node *np)\r\n{\r\nint i, irq_base, hwirq = 0, irq_nr = 0;\r\nstatic struct irq_domain *shirq_domain;\r\nvoid __iomem *base;\r\nbase = of_iomap(np, 0);\r\nif (!base) {\r\npr_err("%s: failed to map shirq registers\n", __func__);\r\nreturn -ENXIO;\r\n}\r\nfor (i = 0; i < block_nr; i++)\r\nirq_nr += shirq_blocks[i]->irq_nr;\r\nirq_base = irq_alloc_descs(-1, 0, irq_nr, 0);\r\nif (IS_ERR_VALUE(irq_base)) {\r\npr_err("%s: irq desc alloc failed\n", __func__);\r\ngoto err_unmap;\r\n}\r\nshirq_domain = irq_domain_add_legacy(np, irq_nr, irq_base, 0,\r\n&irq_domain_simple_ops, NULL);\r\nif (WARN_ON(!shirq_domain)) {\r\npr_warn("%s: irq domain init failed\n", __func__);\r\ngoto err_free_desc;\r\n}\r\nfor (i = 0; i < block_nr; i++) {\r\nshirq_blocks[i]->base = base;\r\nshirq_blocks[i]->irq_base = irq_find_mapping(shirq_domain,\r\nhwirq);\r\nshirq_blocks[i]->irq = irq_of_parse_and_map(np, i);\r\nspear_shirq_register(shirq_blocks[i]);\r\nhwirq += shirq_blocks[i]->irq_nr;\r\n}\r\nreturn 0;\r\nerr_free_desc:\r\nirq_free_descs(irq_base, irq_nr);\r\nerr_unmap:\r\niounmap(base);\r\nreturn -ENXIO;\r\n}\r\nint __init spear300_shirq_of_init(struct device_node *np,\r\nstruct device_node *parent)\r\n{\r\nreturn shirq_init(spear300_shirq_blocks,\r\nARRAY_SIZE(spear300_shirq_blocks), np);\r\n}\r\nint __init spear310_shirq_of_init(struct device_node *np,\r\nstruct device_node *parent)\r\n{\r\nreturn shirq_init(spear310_shirq_blocks,\r\nARRAY_SIZE(spear310_shirq_blocks), np);\r\n}\r\nint __init spear320_shirq_of_init(struct device_node *np,\r\nstruct device_node *parent)\r\n{\r\nreturn shirq_init(spear320_shirq_blocks,\r\nARRAY_SIZE(spear320_shirq_blocks), np);\r\n}

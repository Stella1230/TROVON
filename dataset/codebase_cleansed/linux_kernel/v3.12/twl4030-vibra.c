static void vibra_disable_leds(void)\r\n{\r\nu8 reg;\r\ntwl_i2c_read_u8(TWL4030_MODULE_LED, &reg, LEDEN);\r\nreg &= ~0x03;\r\ntwl_i2c_write_u8(TWL4030_MODULE_LED, LEDEN, reg);\r\n}\r\nstatic void vibra_enable(struct vibra_info *info)\r\n{\r\nu8 reg;\r\ntwl4030_audio_enable_resource(TWL4030_AUDIO_RES_POWER);\r\ntwl_i2c_read_u8(TWL4030_MODULE_AUDIO_VOICE,\r\n&reg, TWL4030_REG_VIBRA_CTL);\r\ntwl_i2c_write_u8(TWL4030_MODULE_AUDIO_VOICE,\r\n(reg | TWL4030_VIBRA_EN), TWL4030_REG_VIBRA_CTL);\r\ntwl4030_audio_enable_resource(TWL4030_AUDIO_RES_APLL);\r\ninfo->enabled = true;\r\n}\r\nstatic void vibra_disable(struct vibra_info *info)\r\n{\r\nu8 reg;\r\ntwl_i2c_read_u8(TWL4030_MODULE_AUDIO_VOICE,\r\n&reg, TWL4030_REG_VIBRA_CTL);\r\ntwl_i2c_write_u8(TWL4030_MODULE_AUDIO_VOICE,\r\n(reg & ~TWL4030_VIBRA_EN), TWL4030_REG_VIBRA_CTL);\r\ntwl4030_audio_disable_resource(TWL4030_AUDIO_RES_APLL);\r\ntwl4030_audio_disable_resource(TWL4030_AUDIO_RES_POWER);\r\ninfo->enabled = false;\r\n}\r\nstatic void vibra_play_work(struct work_struct *work)\r\n{\r\nstruct vibra_info *info = container_of(work,\r\nstruct vibra_info, play_work);\r\nint dir;\r\nint pwm;\r\nu8 reg;\r\ndir = info->direction;\r\npwm = info->speed;\r\ntwl_i2c_read_u8(TWL4030_MODULE_AUDIO_VOICE,\r\n&reg, TWL4030_REG_VIBRA_CTL);\r\nif (pwm && (!info->coexist || !(reg & TWL4030_VIBRA_SEL))) {\r\nif (!info->enabled)\r\nvibra_enable(info);\r\ntwl_i2c_read_u8(TWL4030_MODULE_AUDIO_VOICE,\r\n&reg, TWL4030_REG_VIBRA_CTL);\r\nreg = (dir) ? (reg | TWL4030_VIBRA_DIR) :\r\n(reg & ~TWL4030_VIBRA_DIR);\r\ntwl_i2c_write_u8(TWL4030_MODULE_AUDIO_VOICE,\r\nreg, TWL4030_REG_VIBRA_CTL);\r\ntwl_i2c_write_u8(TWL4030_MODULE_AUDIO_VOICE,\r\n256 - pwm, TWL4030_REG_VIBRA_SET);\r\n} else {\r\nif (info->enabled)\r\nvibra_disable(info);\r\n}\r\n}\r\nstatic int vibra_play(struct input_dev *input, void *data,\r\nstruct ff_effect *effect)\r\n{\r\nstruct vibra_info *info = input_get_drvdata(input);\r\ninfo->speed = effect->u.rumble.strong_magnitude >> 8;\r\nif (!info->speed)\r\ninfo->speed = effect->u.rumble.weak_magnitude >> 9;\r\ninfo->direction = effect->direction < EFFECT_DIR_180_DEG ? 0 : 1;\r\nschedule_work(&info->play_work);\r\nreturn 0;\r\n}\r\nstatic void twl4030_vibra_close(struct input_dev *input)\r\n{\r\nstruct vibra_info *info = input_get_drvdata(input);\r\ncancel_work_sync(&info->play_work);\r\nif (info->enabled)\r\nvibra_disable(info);\r\n}\r\nstatic int twl4030_vibra_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct vibra_info *info = platform_get_drvdata(pdev);\r\nif (info->enabled)\r\nvibra_disable(info);\r\nreturn 0;\r\n}\r\nstatic int twl4030_vibra_resume(struct device *dev)\r\n{\r\nvibra_disable_leds();\r\nreturn 0;\r\n}\r\nstatic bool twl4030_vibra_check_coexist(struct twl4030_vibra_data *pdata,\r\nstruct device_node *node)\r\n{\r\nif (pdata && pdata->coexist)\r\nreturn true;\r\nif (of_find_node_by_name(node, "codec"))\r\nreturn true;\r\nreturn false;\r\n}\r\nstatic int twl4030_vibra_probe(struct platform_device *pdev)\r\n{\r\nstruct twl4030_vibra_data *pdata = pdev->dev.platform_data;\r\nstruct device_node *twl4030_core_node = pdev->dev.parent->of_node;\r\nstruct vibra_info *info;\r\nint ret;\r\nif (!pdata && !twl4030_core_node) {\r\ndev_dbg(&pdev->dev, "platform_data not available\n");\r\nreturn -EINVAL;\r\n}\r\ninfo = devm_kzalloc(&pdev->dev, sizeof(*info), GFP_KERNEL);\r\nif (!info)\r\nreturn -ENOMEM;\r\ninfo->dev = &pdev->dev;\r\ninfo->coexist = twl4030_vibra_check_coexist(pdata, twl4030_core_node);\r\nINIT_WORK(&info->play_work, vibra_play_work);\r\ninfo->input_dev = devm_input_allocate_device(&pdev->dev);\r\nif (info->input_dev == NULL) {\r\ndev_err(&pdev->dev, "couldn't allocate input device\n");\r\nreturn -ENOMEM;\r\n}\r\ninput_set_drvdata(info->input_dev, info);\r\ninfo->input_dev->name = "twl4030:vibrator";\r\ninfo->input_dev->id.version = 1;\r\ninfo->input_dev->dev.parent = pdev->dev.parent;\r\ninfo->input_dev->close = twl4030_vibra_close;\r\n__set_bit(FF_RUMBLE, info->input_dev->ffbit);\r\nret = input_ff_create_memless(info->input_dev, NULL, vibra_play);\r\nif (ret < 0) {\r\ndev_dbg(&pdev->dev, "couldn't register vibrator to FF\n");\r\nreturn ret;\r\n}\r\nret = input_register_device(info->input_dev);\r\nif (ret < 0) {\r\ndev_dbg(&pdev->dev, "couldn't register input device\n");\r\ngoto err_iff;\r\n}\r\nvibra_disable_leds();\r\nplatform_set_drvdata(pdev, info);\r\nreturn 0;\r\nerr_iff:\r\ninput_ff_destroy(info->input_dev);\r\nreturn ret;\r\n}

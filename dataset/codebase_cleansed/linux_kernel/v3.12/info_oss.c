int snd_oss_info_register(int dev, int num, char *string)\r\n{\r\nchar *x;\r\nif (snd_BUG_ON(dev < 0 || dev >= SNDRV_OSS_INFO_DEV_COUNT))\r\nreturn -ENXIO;\r\nif (snd_BUG_ON(num < 0 || num >= SNDRV_CARDS))\r\nreturn -ENXIO;\r\nmutex_lock(&strings);\r\nif (string == NULL) {\r\nif ((x = snd_sndstat_strings[num][dev]) != NULL) {\r\nkfree(x);\r\nx = NULL;\r\n}\r\n} else {\r\nx = kstrdup(string, GFP_KERNEL);\r\nif (x == NULL) {\r\nmutex_unlock(&strings);\r\nreturn -ENOMEM;\r\n}\r\n}\r\nsnd_sndstat_strings[num][dev] = x;\r\nmutex_unlock(&strings);\r\nreturn 0;\r\n}\r\nstatic int snd_sndstat_show_strings(struct snd_info_buffer *buf, char *id, int dev)\r\n{\r\nint idx, ok = -1;\r\nchar *str;\r\nsnd_iprintf(buf, "\n%s:", id);\r\nmutex_lock(&strings);\r\nfor (idx = 0; idx < SNDRV_CARDS; idx++) {\r\nstr = snd_sndstat_strings[idx][dev];\r\nif (str) {\r\nif (ok < 0) {\r\nsnd_iprintf(buf, "\n");\r\nok++;\r\n}\r\nsnd_iprintf(buf, "%i: %s\n", idx, str);\r\n}\r\n}\r\nmutex_unlock(&strings);\r\nif (ok < 0)\r\nsnd_iprintf(buf, " NOT ENABLED IN CONFIG\n");\r\nreturn ok;\r\n}\r\nstatic void snd_sndstat_proc_read(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nsnd_iprintf(buffer, "Sound Driver:3.8.1a-980706 (ALSA emulation code)\n");\r\nsnd_iprintf(buffer, "Kernel: %s %s %s %s %s\n",\r\ninit_utsname()->sysname,\r\ninit_utsname()->nodename,\r\ninit_utsname()->release,\r\ninit_utsname()->version,\r\ninit_utsname()->machine);\r\nsnd_iprintf(buffer, "Config options: 0\n");\r\nsnd_iprintf(buffer, "\nInstalled drivers: \n");\r\nsnd_iprintf(buffer, "Type 10: ALSA emulation\n");\r\nsnd_iprintf(buffer, "\nCard config: \n");\r\nsnd_card_info_read_oss(buffer);\r\nsnd_sndstat_show_strings(buffer, "Audio devices", SNDRV_OSS_INFO_DEV_AUDIO);\r\nsnd_sndstat_show_strings(buffer, "Synth devices", SNDRV_OSS_INFO_DEV_SYNTH);\r\nsnd_sndstat_show_strings(buffer, "Midi devices", SNDRV_OSS_INFO_DEV_MIDI);\r\nsnd_sndstat_show_strings(buffer, "Timers", SNDRV_OSS_INFO_DEV_TIMERS);\r\nsnd_sndstat_show_strings(buffer, "Mixers", SNDRV_OSS_INFO_DEV_MIXERS);\r\n}\r\nint snd_info_minor_register(void)\r\n{\r\nstruct snd_info_entry *entry;\r\nmemset(snd_sndstat_strings, 0, sizeof(snd_sndstat_strings));\r\nif ((entry = snd_info_create_module_entry(THIS_MODULE, "sndstat", snd_oss_root)) != NULL) {\r\nentry->c.text.read = snd_sndstat_proc_read;\r\nif (snd_info_register(entry) < 0) {\r\nsnd_info_free_entry(entry);\r\nentry = NULL;\r\n}\r\n}\r\nsnd_sndstat_proc_entry = entry;\r\nreturn 0;\r\n}\r\nint snd_info_minor_unregister(void)\r\n{\r\nsnd_info_free_entry(snd_sndstat_proc_entry);\r\nsnd_sndstat_proc_entry = NULL;\r\nreturn 0;\r\n}

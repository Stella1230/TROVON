static int dbx500_cpufreq_verify_speed(struct cpufreq_policy *policy)\r\n{\r\nreturn cpufreq_frequency_table_verify(policy, freq_table);\r\n}\r\nstatic int dbx500_cpufreq_target(struct cpufreq_policy *policy,\r\nunsigned int target_freq,\r\nunsigned int relation)\r\n{\r\nstruct cpufreq_freqs freqs;\r\nunsigned int idx;\r\nint ret;\r\nif (cpufreq_frequency_table_target(policy, freq_table, target_freq,\r\nrelation, &idx))\r\nreturn -EINVAL;\r\nfreqs.old = policy->cur;\r\nfreqs.new = freq_table[idx].frequency;\r\nif (freqs.old == freqs.new)\r\nreturn 0;\r\ncpufreq_notify_transition(policy, &freqs, CPUFREQ_PRECHANGE);\r\nret = clk_set_rate(armss_clk, freqs.new * 1000);\r\nif (ret) {\r\npr_err("dbx500-cpufreq: Failed to set armss_clk to %d Hz: error %d\n",\r\nfreqs.new * 1000, ret);\r\nfreqs.new = freqs.old;\r\n}\r\ncpufreq_notify_transition(policy, &freqs, CPUFREQ_POSTCHANGE);\r\nreturn ret;\r\n}\r\nstatic unsigned int dbx500_cpufreq_getspeed(unsigned int cpu)\r\n{\r\nint i = 0;\r\nunsigned long freq = clk_get_rate(armss_clk) / 1000;\r\nwhile (freq_table[i + 1].frequency != CPUFREQ_TABLE_END) {\r\nif (freq < freq_table[i].frequency +\r\n(freq_table[i + 1].frequency - freq_table[i].frequency) / 2)\r\nreturn freq_table[i].frequency;\r\ni++;\r\n}\r\nreturn freq_table[i].frequency;\r\n}\r\nstatic int dbx500_cpufreq_init(struct cpufreq_policy *policy)\r\n{\r\nint res;\r\nres = cpufreq_frequency_table_cpuinfo(policy, freq_table);\r\nif (!res)\r\ncpufreq_frequency_table_get_attr(freq_table, policy->cpu);\r\nelse {\r\npr_err("dbx500-cpufreq: Failed to read policy table\n");\r\nreturn res;\r\n}\r\npolicy->min = policy->cpuinfo.min_freq;\r\npolicy->max = policy->cpuinfo.max_freq;\r\npolicy->cur = dbx500_cpufreq_getspeed(policy->cpu);\r\npolicy->governor = CPUFREQ_DEFAULT_GOVERNOR;\r\npolicy->cpuinfo.transition_latency = 20 * 1000;\r\ncpumask_setall(policy->cpus);\r\nreturn 0;\r\n}\r\nstatic int dbx500_cpufreq_probe(struct platform_device *pdev)\r\n{\r\nint i = 0;\r\nfreq_table = dev_get_platdata(&pdev->dev);\r\nif (!freq_table) {\r\npr_err("dbx500-cpufreq: Failed to fetch cpufreq table\n");\r\nreturn -ENODEV;\r\n}\r\narmss_clk = clk_get(&pdev->dev, "armss");\r\nif (IS_ERR(armss_clk)) {\r\npr_err("dbx500-cpufreq: Failed to get armss clk\n");\r\nreturn PTR_ERR(armss_clk);\r\n}\r\npr_info("dbx500-cpufreq: Available frequencies:\n");\r\nwhile (freq_table[i].frequency != CPUFREQ_TABLE_END) {\r\npr_info(" %d Mhz\n", freq_table[i].frequency/1000);\r\ni++;\r\n}\r\nreturn cpufreq_register_driver(&dbx500_cpufreq_driver);\r\n}\r\nstatic int __init dbx500_cpufreq_register(void)\r\n{\r\nreturn platform_driver_register(&dbx500_cpufreq_plat_driver);\r\n}

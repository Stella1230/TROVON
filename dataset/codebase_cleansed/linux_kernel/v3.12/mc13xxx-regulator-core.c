static int mc13xxx_regulator_enable(struct regulator_dev *rdev)\r\n{\r\nstruct mc13xxx_regulator_priv *priv = rdev_get_drvdata(rdev);\r\nstruct mc13xxx_regulator *mc13xxx_regulators = priv->mc13xxx_regulators;\r\nint id = rdev_get_id(rdev);\r\nint ret;\r\ndev_dbg(rdev_get_dev(rdev), "%s id: %d\n", __func__, id);\r\nmc13xxx_lock(priv->mc13xxx);\r\nret = mc13xxx_reg_rmw(priv->mc13xxx, mc13xxx_regulators[id].reg,\r\nmc13xxx_regulators[id].enable_bit,\r\nmc13xxx_regulators[id].enable_bit);\r\nmc13xxx_unlock(priv->mc13xxx);\r\nreturn ret;\r\n}\r\nstatic int mc13xxx_regulator_disable(struct regulator_dev *rdev)\r\n{\r\nstruct mc13xxx_regulator_priv *priv = rdev_get_drvdata(rdev);\r\nstruct mc13xxx_regulator *mc13xxx_regulators = priv->mc13xxx_regulators;\r\nint id = rdev_get_id(rdev);\r\nint ret;\r\ndev_dbg(rdev_get_dev(rdev), "%s id: %d\n", __func__, id);\r\nmc13xxx_lock(priv->mc13xxx);\r\nret = mc13xxx_reg_rmw(priv->mc13xxx, mc13xxx_regulators[id].reg,\r\nmc13xxx_regulators[id].enable_bit, 0);\r\nmc13xxx_unlock(priv->mc13xxx);\r\nreturn ret;\r\n}\r\nstatic int mc13xxx_regulator_is_enabled(struct regulator_dev *rdev)\r\n{\r\nstruct mc13xxx_regulator_priv *priv = rdev_get_drvdata(rdev);\r\nstruct mc13xxx_regulator *mc13xxx_regulators = priv->mc13xxx_regulators;\r\nint ret, id = rdev_get_id(rdev);\r\nunsigned int val;\r\nmc13xxx_lock(priv->mc13xxx);\r\nret = mc13xxx_reg_read(priv->mc13xxx, mc13xxx_regulators[id].reg, &val);\r\nmc13xxx_unlock(priv->mc13xxx);\r\nif (ret)\r\nreturn ret;\r\nreturn (val & mc13xxx_regulators[id].enable_bit) != 0;\r\n}\r\nstatic int mc13xxx_regulator_set_voltage_sel(struct regulator_dev *rdev,\r\nunsigned selector)\r\n{\r\nstruct mc13xxx_regulator_priv *priv = rdev_get_drvdata(rdev);\r\nstruct mc13xxx_regulator *mc13xxx_regulators = priv->mc13xxx_regulators;\r\nint id = rdev_get_id(rdev);\r\nint ret;\r\nmc13xxx_lock(priv->mc13xxx);\r\nret = mc13xxx_reg_rmw(priv->mc13xxx, mc13xxx_regulators[id].vsel_reg,\r\nmc13xxx_regulators[id].vsel_mask,\r\nselector << mc13xxx_regulators[id].vsel_shift);\r\nmc13xxx_unlock(priv->mc13xxx);\r\nreturn ret;\r\n}\r\nstatic int mc13xxx_regulator_get_voltage(struct regulator_dev *rdev)\r\n{\r\nstruct mc13xxx_regulator_priv *priv = rdev_get_drvdata(rdev);\r\nstruct mc13xxx_regulator *mc13xxx_regulators = priv->mc13xxx_regulators;\r\nint ret, id = rdev_get_id(rdev);\r\nunsigned int val;\r\ndev_dbg(rdev_get_dev(rdev), "%s id: %d\n", __func__, id);\r\nmc13xxx_lock(priv->mc13xxx);\r\nret = mc13xxx_reg_read(priv->mc13xxx,\r\nmc13xxx_regulators[id].vsel_reg, &val);\r\nmc13xxx_unlock(priv->mc13xxx);\r\nif (ret)\r\nreturn ret;\r\nval = (val & mc13xxx_regulators[id].vsel_mask)\r\n>> mc13xxx_regulators[id].vsel_shift;\r\ndev_dbg(rdev_get_dev(rdev), "%s id: %d val: %d\n", __func__, id, val);\r\nBUG_ON(val >= mc13xxx_regulators[id].desc.n_voltages);\r\nreturn rdev->desc->volt_table[val];\r\n}\r\nint mc13xxx_fixed_regulator_set_voltage(struct regulator_dev *rdev, int min_uV,\r\nint max_uV, unsigned *selector)\r\n{\r\nint id = rdev_get_id(rdev);\r\ndev_dbg(rdev_get_dev(rdev), "%s id: %d min_uV: %d max_uV: %d\n",\r\n__func__, id, min_uV, max_uV);\r\nif (min_uV <= rdev->desc->volt_table[0] &&\r\nrdev->desc->volt_table[0] <= max_uV) {\r\n*selector = 0;\r\nreturn 0;\r\n} else {\r\nreturn -EINVAL;\r\n}\r\n}\r\nint mc13xxx_get_num_regulators_dt(struct platform_device *pdev)\r\n{\r\nstruct device_node *parent;\r\nint num;\r\nof_node_get(pdev->dev.parent->of_node);\r\nparent = of_find_node_by_name(pdev->dev.parent->of_node, "regulators");\r\nif (!parent)\r\nreturn -ENODEV;\r\nnum = of_get_child_count(parent);\r\nof_node_put(parent);\r\nreturn num;\r\n}\r\nstruct mc13xxx_regulator_init_data *mc13xxx_parse_regulators_dt(\r\nstruct platform_device *pdev, struct mc13xxx_regulator *regulators,\r\nint num_regulators)\r\n{\r\nstruct mc13xxx_regulator_priv *priv = platform_get_drvdata(pdev);\r\nstruct mc13xxx_regulator_init_data *data, *p;\r\nstruct device_node *parent, *child;\r\nint i, parsed = 0;\r\nof_node_get(pdev->dev.parent->of_node);\r\nparent = of_find_node_by_name(pdev->dev.parent->of_node, "regulators");\r\nif (!parent)\r\nreturn NULL;\r\ndata = devm_kzalloc(&pdev->dev, sizeof(*data) * priv->num_regulators,\r\nGFP_KERNEL);\r\nif (!data) {\r\nof_node_put(parent);\r\nreturn NULL;\r\n}\r\np = data;\r\nfor_each_child_of_node(parent, child) {\r\nint found = 0;\r\nfor (i = 0; i < num_regulators; i++) {\r\nif (!regulators[i].desc.name)\r\ncontinue;\r\nif (!of_node_cmp(child->name,\r\nregulators[i].desc.name)) {\r\np->id = i;\r\np->init_data = of_get_regulator_init_data(\r\n&pdev->dev, child);\r\np->node = child;\r\np++;\r\nparsed++;\r\nfound = 1;\r\nbreak;\r\n}\r\n}\r\nif (!found)\r\ndev_warn(&pdev->dev,\r\n"Unknown regulator: %s\n", child->name);\r\n}\r\nof_node_put(parent);\r\npriv->num_regulators = parsed;\r\nreturn data;\r\n}

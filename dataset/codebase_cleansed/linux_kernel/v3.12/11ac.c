static u16\r\nmwifiex_convert_mcsmap_to_maxrate(struct mwifiex_private *priv,\r\nu8 bands, u16 mcs_map)\r\n{\r\nu8 i, nss, max_mcs;\r\nu16 max_rate = 0;\r\nu32 usr_vht_cap_info = 0;\r\nstruct mwifiex_adapter *adapter = priv->adapter;\r\nu16 max_rate_lgi_80MHZ[8][3] = {\r\n{0x124, 0x15F, 0x186},\r\n{0x249, 0x2BE, 0x30C},\r\n{0x36D, 0x41D, 0x492},\r\n{0x492, 0x57C, 0x618},\r\n{0x5B6, 0x6DB, 0x79E},\r\n{0x6DB, 0x83A, 0x0},\r\n{0x7FF, 0x999, 0xAAA},\r\n{0x924, 0xAF8, 0xC30}\r\n};\r\nu16 max_rate_lgi_160MHZ[8][3] = {\r\n{0x249, 0x2BE, 0x30C},\r\n{0x492, 0x57C, 0x618},\r\n{0x6DB, 0x83A, 0x0},\r\n{0x924, 0xAF8, 0xC30},\r\n{0xB6D, 0xDB6, 0xF3C},\r\n{0xDB6, 0x1074, 0x1248},\r\n{0xFFF, 0x1332, 0x1554},\r\n{0x1248, 0x15F0, 0x1860}\r\n};\r\nif (bands & BAND_AAC)\r\nusr_vht_cap_info = adapter->usr_dot_11ac_dev_cap_a;\r\nelse\r\nusr_vht_cap_info = adapter->usr_dot_11ac_dev_cap_bg;\r\nnss = 0;\r\nfor (i = 0; i < 8; i++) {\r\nmax_mcs = (mcs_map >> (2 * i)) & 0x3;\r\nif (max_mcs < 3)\r\nnss = i;\r\n}\r\nmax_mcs = (mcs_map >> (2 * nss)) & 0x3;\r\nif (max_mcs >= 3)\r\nmax_mcs = 2;\r\nif (GET_VHTCAP_CHWDSET(usr_vht_cap_info)) {\r\nmax_rate = max_rate_lgi_160MHZ[nss][max_mcs];\r\nif (!max_rate)\r\nmax_rate = max_rate_lgi_160MHZ[nss][max_mcs - 1];\r\n} else {\r\nmax_rate = max_rate_lgi_80MHZ[nss][max_mcs];\r\nif (!max_rate)\r\nmax_rate = max_rate_lgi_80MHZ[nss][max_mcs - 1];\r\n}\r\nreturn max_rate;\r\n}\r\nstatic void\r\nmwifiex_fill_vht_cap_info(struct mwifiex_private *priv,\r\nstruct mwifiex_ie_types_vhtcap *vht_cap, u8 bands)\r\n{\r\nstruct mwifiex_adapter *adapter = priv->adapter;\r\nif (bands & BAND_A)\r\nvht_cap->vht_cap.vht_cap_info =\r\ncpu_to_le32(adapter->usr_dot_11ac_dev_cap_a);\r\nelse\r\nvht_cap->vht_cap.vht_cap_info =\r\ncpu_to_le32(adapter->usr_dot_11ac_dev_cap_bg);\r\n}\r\nstatic void\r\nmwifiex_fill_vht_cap_tlv(struct mwifiex_private *priv,\r\nstruct mwifiex_ie_types_vhtcap *vht_cap, u8 bands)\r\n{\r\nstruct mwifiex_adapter *adapter = priv->adapter;\r\nu16 mcs_map_user, mcs_map_resp, mcs_map_result;\r\nu16 mcs_user, mcs_resp, nss, tmp;\r\nmwifiex_fill_vht_cap_info(priv, vht_cap, bands);\r\nmcs_map_user = GET_DEVRXMCSMAP(adapter->usr_dot_11ac_mcs_support);\r\nmcs_map_resp = le16_to_cpu(vht_cap->vht_cap.supp_mcs.rx_mcs_map);\r\nmcs_map_result = 0;\r\nfor (nss = 1; nss <= 8; nss++) {\r\nmcs_user = GET_VHTNSSMCS(mcs_map_user, nss);\r\nmcs_resp = GET_VHTNSSMCS(mcs_map_resp, nss);\r\nif ((mcs_user == NO_NSS_SUPPORT) ||\r\n(mcs_resp == NO_NSS_SUPPORT))\r\nSET_VHTNSSMCS(mcs_map_result, nss, NO_NSS_SUPPORT);\r\nelse\r\nSET_VHTNSSMCS(mcs_map_result, nss,\r\nmin(mcs_user, mcs_resp));\r\n}\r\nvht_cap->vht_cap.supp_mcs.rx_mcs_map = cpu_to_le16(mcs_map_result);\r\ntmp = mwifiex_convert_mcsmap_to_maxrate(priv, bands, mcs_map_result);\r\nvht_cap->vht_cap.supp_mcs.rx_highest = cpu_to_le16(tmp);\r\nmcs_map_user = GET_DEVTXMCSMAP(adapter->usr_dot_11ac_mcs_support);\r\nmcs_map_resp = le16_to_cpu(vht_cap->vht_cap.supp_mcs.tx_mcs_map);\r\nmcs_map_result = 0;\r\nfor (nss = 1; nss <= 8; nss++) {\r\nmcs_user = GET_VHTNSSMCS(mcs_map_user, nss);\r\nmcs_resp = GET_VHTNSSMCS(mcs_map_resp, nss);\r\nif ((mcs_user == NO_NSS_SUPPORT) ||\r\n(mcs_resp == NO_NSS_SUPPORT))\r\nSET_VHTNSSMCS(mcs_map_result, nss, NO_NSS_SUPPORT);\r\nelse\r\nSET_VHTNSSMCS(mcs_map_result, nss,\r\nmin(mcs_user, mcs_resp));\r\n}\r\nvht_cap->vht_cap.supp_mcs.tx_mcs_map = cpu_to_le16(mcs_map_result);\r\ntmp = mwifiex_convert_mcsmap_to_maxrate(priv, bands, mcs_map_result);\r\nvht_cap->vht_cap.supp_mcs.tx_highest = cpu_to_le16(tmp);\r\nreturn;\r\n}\r\nint mwifiex_cmd_append_11ac_tlv(struct mwifiex_private *priv,\r\nstruct mwifiex_bssdescriptor *bss_desc,\r\nu8 **buffer)\r\n{\r\nstruct mwifiex_ie_types_vhtcap *vht_cap;\r\nstruct mwifiex_ie_types_oper_mode_ntf *oper_ntf;\r\nstruct ieee_types_oper_mode_ntf *ieee_oper_ntf;\r\nstruct mwifiex_ie_types_vht_oper *vht_op;\r\nstruct mwifiex_adapter *adapter = priv->adapter;\r\nu8 supp_chwd_set;\r\nu32 usr_vht_cap_info;\r\nint ret_len = 0;\r\nif (bss_desc->bss_band & BAND_A)\r\nusr_vht_cap_info = adapter->usr_dot_11ac_dev_cap_a;\r\nelse\r\nusr_vht_cap_info = adapter->usr_dot_11ac_dev_cap_bg;\r\nif (bss_desc->bcn_vht_cap) {\r\nvht_cap = (struct mwifiex_ie_types_vhtcap *)*buffer;\r\nmemset(vht_cap, 0, sizeof(*vht_cap));\r\nvht_cap->header.type = cpu_to_le16(WLAN_EID_VHT_CAPABILITY);\r\nvht_cap->header.len =\r\ncpu_to_le16(sizeof(struct ieee80211_vht_cap));\r\nmemcpy((u8 *)vht_cap + sizeof(struct mwifiex_ie_types_header),\r\n(u8 *)bss_desc->bcn_vht_cap +\r\nsizeof(struct ieee_types_header),\r\nle16_to_cpu(vht_cap->header.len));\r\nmwifiex_fill_vht_cap_tlv(priv, vht_cap, bss_desc->bss_band);\r\n*buffer += sizeof(*vht_cap);\r\nret_len += sizeof(*vht_cap);\r\n}\r\nif (bss_desc->bcn_vht_oper) {\r\nif (priv->bss_mode == NL80211_IFTYPE_STATION) {\r\nvht_op = (struct mwifiex_ie_types_vht_oper *)*buffer;\r\nmemset(vht_op, 0, sizeof(*vht_op));\r\nvht_op->header.type =\r\ncpu_to_le16(WLAN_EID_VHT_OPERATION);\r\nvht_op->header.len = cpu_to_le16(sizeof(*vht_op) -\r\nsizeof(struct mwifiex_ie_types_header));\r\nmemcpy((u8 *)vht_op +\r\nsizeof(struct mwifiex_ie_types_header),\r\n(u8 *)bss_desc->bcn_vht_oper +\r\nsizeof(struct ieee_types_header),\r\nle16_to_cpu(vht_op->header.len));\r\nsupp_chwd_set = GET_VHTCAP_CHWDSET(usr_vht_cap_info);\r\nswitch (supp_chwd_set) {\r\ncase 0:\r\nvht_op->chan_width =\r\nmin_t(u8, IEEE80211_VHT_CHANWIDTH_80MHZ,\r\nbss_desc->bcn_vht_oper->chan_width);\r\nbreak;\r\ncase 1:\r\nvht_op->chan_width =\r\nmin_t(u8, IEEE80211_VHT_CHANWIDTH_160MHZ,\r\nbss_desc->bcn_vht_oper->chan_width);\r\nbreak;\r\ncase 2:\r\nvht_op->chan_width =\r\nmin_t(u8, IEEE80211_VHT_CHANWIDTH_80P80MHZ,\r\nbss_desc->bcn_vht_oper->chan_width);\r\nbreak;\r\ndefault:\r\nvht_op->chan_width =\r\nIEEE80211_VHT_CHANWIDTH_USE_HT;\r\nbreak;\r\n}\r\n*buffer += sizeof(*vht_op);\r\nret_len += sizeof(*vht_op);\r\n}\r\n}\r\nif (bss_desc->oper_mode) {\r\nieee_oper_ntf = bss_desc->oper_mode;\r\noper_ntf = (void *)*buffer;\r\nmemset(oper_ntf, 0, sizeof(*oper_ntf));\r\noper_ntf->header.type = cpu_to_le16(WLAN_EID_OPMODE_NOTIF);\r\noper_ntf->header.len = cpu_to_le16(sizeof(u8));\r\noper_ntf->oper_mode = ieee_oper_ntf->oper_mode;\r\n*buffer += sizeof(*oper_ntf);\r\nret_len += sizeof(*oper_ntf);\r\n}\r\nreturn ret_len;\r\n}\r\nint mwifiex_cmd_11ac_cfg(struct mwifiex_private *priv,\r\nstruct host_cmd_ds_command *cmd, u16 cmd_action,\r\nstruct mwifiex_11ac_vht_cfg *cfg)\r\n{\r\nstruct host_cmd_11ac_vht_cfg *vhtcfg = &cmd->params.vht_cfg;\r\ncmd->command = cpu_to_le16(HostCmd_CMD_11AC_CFG);\r\ncmd->size = cpu_to_le16(sizeof(struct host_cmd_11ac_vht_cfg) +\r\nS_DS_GEN);\r\nvhtcfg->action = cpu_to_le16(cmd_action);\r\nvhtcfg->band_config = cfg->band_config;\r\nvhtcfg->misc_config = cfg->misc_config;\r\nvhtcfg->cap_info = cpu_to_le32(cfg->cap_info);\r\nvhtcfg->mcs_tx_set = cpu_to_le32(cfg->mcs_tx_set);\r\nvhtcfg->mcs_rx_set = cpu_to_le32(cfg->mcs_rx_set);\r\nreturn 0;\r\n}\r\nvoid mwifiex_set_11ac_ba_params(struct mwifiex_private *priv)\r\n{\r\npriv->add_ba_param.timeout = MWIFIEX_DEFAULT_BLOCK_ACK_TIMEOUT;\r\nif (GET_BSS_ROLE(priv) == MWIFIEX_BSS_ROLE_UAP) {\r\npriv->add_ba_param.tx_win_size =\r\nMWIFIEX_11AC_UAP_AMPDU_DEF_TXWINSIZE;\r\npriv->add_ba_param.rx_win_size =\r\nMWIFIEX_11AC_UAP_AMPDU_DEF_RXWINSIZE;\r\n} else {\r\npriv->add_ba_param.tx_win_size =\r\nMWIFIEX_11AC_STA_AMPDU_DEF_TXWINSIZE;\r\npriv->add_ba_param.rx_win_size =\r\nMWIFIEX_11AC_STA_AMPDU_DEF_RXWINSIZE;\r\n}\r\nreturn;\r\n}

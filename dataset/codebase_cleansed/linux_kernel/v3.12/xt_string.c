static bool\r\nstring_mt(const struct sk_buff *skb, struct xt_action_param *par)\r\n{\r\nconst struct xt_string_info *conf = par->matchinfo;\r\nstruct ts_state state;\r\nbool invert;\r\nmemset(&state, 0, sizeof(struct ts_state));\r\ninvert = conf->u.v1.flags & XT_STRING_FLAG_INVERT;\r\nreturn (skb_find_text((struct sk_buff *)skb, conf->from_offset,\r\nconf->to_offset, conf->config, &state)\r\n!= UINT_MAX) ^ invert;\r\n}\r\nstatic int string_mt_check(const struct xt_mtchk_param *par)\r\n{\r\nstruct xt_string_info *conf = par->matchinfo;\r\nstruct ts_config *ts_conf;\r\nint flags = TS_AUTOLOAD;\r\nif (conf->from_offset > conf->to_offset)\r\nreturn -EINVAL;\r\nif (conf->algo[XT_STRING_MAX_ALGO_NAME_SIZE - 1] != '\0')\r\nreturn -EINVAL;\r\nif (conf->patlen > XT_STRING_MAX_PATTERN_SIZE)\r\nreturn -EINVAL;\r\nif (conf->u.v1.flags &\r\n~(XT_STRING_FLAG_IGNORECASE | XT_STRING_FLAG_INVERT))\r\nreturn -EINVAL;\r\nif (conf->u.v1.flags & XT_STRING_FLAG_IGNORECASE)\r\nflags |= TS_IGNORECASE;\r\nts_conf = textsearch_prepare(conf->algo, conf->pattern, conf->patlen,\r\nGFP_KERNEL, flags);\r\nif (IS_ERR(ts_conf))\r\nreturn PTR_ERR(ts_conf);\r\nconf->config = ts_conf;\r\nreturn 0;\r\n}\r\nstatic void string_mt_destroy(const struct xt_mtdtor_param *par)\r\n{\r\ntextsearch_destroy(STRING_TEXT_PRIV(par->matchinfo)->config);\r\n}\r\nstatic int __init string_mt_init(void)\r\n{\r\nreturn xt_register_match(&xt_string_mt_reg);\r\n}\r\nstatic void __exit string_mt_exit(void)\r\n{\r\nxt_unregister_match(&xt_string_mt_reg);\r\n}

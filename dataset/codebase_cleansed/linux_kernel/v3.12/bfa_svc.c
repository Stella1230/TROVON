static int\r\nplkd_validate_logrec(struct bfa_plog_rec_s *pl_rec)\r\n{\r\nif ((pl_rec->log_type != BFA_PL_LOG_TYPE_INT) &&\r\n(pl_rec->log_type != BFA_PL_LOG_TYPE_STRING))\r\nreturn 1;\r\nif ((pl_rec->log_type != BFA_PL_LOG_TYPE_INT) &&\r\n(pl_rec->log_num_ints > BFA_PL_INT_LOG_SZ))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic u64\r\nbfa_get_log_time(void)\r\n{\r\nu64 system_time = 0;\r\nstruct timeval tv;\r\ndo_gettimeofday(&tv);\r\nsystem_time = tv.tv_sec;\r\nreturn system_time;\r\n}\r\nstatic void\r\nbfa_plog_add(struct bfa_plog_s *plog, struct bfa_plog_rec_s *pl_rec)\r\n{\r\nu16 tail;\r\nstruct bfa_plog_rec_s *pl_recp;\r\nif (plog->plog_enabled == 0)\r\nreturn;\r\nif (plkd_validate_logrec(pl_rec)) {\r\nWARN_ON(1);\r\nreturn;\r\n}\r\ntail = plog->tail;\r\npl_recp = &(plog->plog_recs[tail]);\r\nmemcpy(pl_recp, pl_rec, sizeof(struct bfa_plog_rec_s));\r\npl_recp->tv = bfa_get_log_time();\r\nBFA_PL_LOG_REC_INCR(plog->tail);\r\nif (plog->head == plog->tail)\r\nBFA_PL_LOG_REC_INCR(plog->head);\r\n}\r\nvoid\r\nbfa_plog_init(struct bfa_plog_s *plog)\r\n{\r\nmemset((char *)plog, 0, sizeof(struct bfa_plog_s));\r\nmemcpy(plog->plog_sig, BFA_PL_SIG_STR, BFA_PL_SIG_LEN);\r\nplog->head = plog->tail = 0;\r\nplog->plog_enabled = 1;\r\n}\r\nvoid\r\nbfa_plog_str(struct bfa_plog_s *plog, enum bfa_plog_mid mid,\r\nenum bfa_plog_eid event,\r\nu16 misc, char *log_str)\r\n{\r\nstruct bfa_plog_rec_s lp;\r\nif (plog->plog_enabled) {\r\nmemset(&lp, 0, sizeof(struct bfa_plog_rec_s));\r\nlp.mid = mid;\r\nlp.eid = event;\r\nlp.log_type = BFA_PL_LOG_TYPE_STRING;\r\nlp.misc = misc;\r\nstrncpy(lp.log_entry.string_log, log_str,\r\nBFA_PL_STRING_LOG_SZ - 1);\r\nlp.log_entry.string_log[BFA_PL_STRING_LOG_SZ - 1] = '\0';\r\nbfa_plog_add(plog, &lp);\r\n}\r\n}\r\nvoid\r\nbfa_plog_intarr(struct bfa_plog_s *plog, enum bfa_plog_mid mid,\r\nenum bfa_plog_eid event,\r\nu16 misc, u32 *intarr, u32 num_ints)\r\n{\r\nstruct bfa_plog_rec_s lp;\r\nu32 i;\r\nif (num_ints > BFA_PL_INT_LOG_SZ)\r\nnum_ints = BFA_PL_INT_LOG_SZ;\r\nif (plog->plog_enabled) {\r\nmemset(&lp, 0, sizeof(struct bfa_plog_rec_s));\r\nlp.mid = mid;\r\nlp.eid = event;\r\nlp.log_type = BFA_PL_LOG_TYPE_INT;\r\nlp.misc = misc;\r\nfor (i = 0; i < num_ints; i++)\r\nlp.log_entry.int_log[i] = intarr[i];\r\nlp.log_num_ints = (u8) num_ints;\r\nbfa_plog_add(plog, &lp);\r\n}\r\n}\r\nvoid\r\nbfa_plog_fchdr(struct bfa_plog_s *plog, enum bfa_plog_mid mid,\r\nenum bfa_plog_eid event,\r\nu16 misc, struct fchs_s *fchdr)\r\n{\r\nstruct bfa_plog_rec_s lp;\r\nu32 *tmp_int = (u32 *) fchdr;\r\nu32 ints[BFA_PL_INT_LOG_SZ];\r\nif (plog->plog_enabled) {\r\nmemset(&lp, 0, sizeof(struct bfa_plog_rec_s));\r\nints[0] = tmp_int[0];\r\nints[1] = tmp_int[1];\r\nints[2] = tmp_int[4];\r\nbfa_plog_intarr(plog, mid, event, misc, ints, 3);\r\n}\r\n}\r\nvoid\r\nbfa_plog_fchdr_and_pl(struct bfa_plog_s *plog, enum bfa_plog_mid mid,\r\nenum bfa_plog_eid event, u16 misc, struct fchs_s *fchdr,\r\nu32 pld_w0)\r\n{\r\nstruct bfa_plog_rec_s lp;\r\nu32 *tmp_int = (u32 *) fchdr;\r\nu32 ints[BFA_PL_INT_LOG_SZ];\r\nif (plog->plog_enabled) {\r\nmemset(&lp, 0, sizeof(struct bfa_plog_rec_s));\r\nints[0] = tmp_int[0];\r\nints[1] = tmp_int[1];\r\nints[2] = tmp_int[4];\r\nints[3] = pld_w0;\r\nbfa_plog_intarr(plog, mid, event, misc, ints, 4);\r\n}\r\n}\r\nstatic void\r\nclaim_fcxps_mem(struct bfa_fcxp_mod_s *mod)\r\n{\r\nu16 i;\r\nstruct bfa_fcxp_s *fcxp;\r\nfcxp = (struct bfa_fcxp_s *) bfa_mem_kva_curp(mod);\r\nmemset(fcxp, 0, sizeof(struct bfa_fcxp_s) * mod->num_fcxps);\r\nINIT_LIST_HEAD(&mod->fcxp_req_free_q);\r\nINIT_LIST_HEAD(&mod->fcxp_rsp_free_q);\r\nINIT_LIST_HEAD(&mod->fcxp_active_q);\r\nINIT_LIST_HEAD(&mod->fcxp_req_unused_q);\r\nINIT_LIST_HEAD(&mod->fcxp_rsp_unused_q);\r\nmod->fcxp_list = fcxp;\r\nfor (i = 0; i < mod->num_fcxps; i++) {\r\nfcxp->fcxp_mod = mod;\r\nfcxp->fcxp_tag = i;\r\nif (i < (mod->num_fcxps / 2)) {\r\nlist_add_tail(&fcxp->qe, &mod->fcxp_req_free_q);\r\nfcxp->req_rsp = BFA_TRUE;\r\n} else {\r\nlist_add_tail(&fcxp->qe, &mod->fcxp_rsp_free_q);\r\nfcxp->req_rsp = BFA_FALSE;\r\n}\r\nbfa_reqq_winit(&fcxp->reqq_wqe, bfa_fcxp_qresume, fcxp);\r\nfcxp->reqq_waiting = BFA_FALSE;\r\nfcxp = fcxp + 1;\r\n}\r\nbfa_mem_kva_curp(mod) = (void *)fcxp;\r\n}\r\nstatic void\r\nbfa_fcxp_meminfo(struct bfa_iocfc_cfg_s *cfg, struct bfa_meminfo_s *minfo,\r\nstruct bfa_s *bfa)\r\n{\r\nstruct bfa_fcxp_mod_s *fcxp_mod = BFA_FCXP_MOD(bfa);\r\nstruct bfa_mem_kva_s *fcxp_kva = BFA_MEM_FCXP_KVA(bfa);\r\nstruct bfa_mem_dma_s *seg_ptr;\r\nu16 nsegs, idx, per_seg_fcxp;\r\nu16 num_fcxps = cfg->fwcfg.num_fcxp_reqs;\r\nu32 per_fcxp_sz;\r\nif (num_fcxps == 0)\r\nreturn;\r\nif (cfg->drvcfg.min_cfg)\r\nper_fcxp_sz = 2 * BFA_FCXP_MAX_IBUF_SZ;\r\nelse\r\nper_fcxp_sz = BFA_FCXP_MAX_IBUF_SZ + BFA_FCXP_MAX_LBUF_SZ;\r\nnsegs = BFI_MEM_DMA_NSEGS(num_fcxps, per_fcxp_sz);\r\nper_seg_fcxp = BFI_MEM_NREQS_SEG(per_fcxp_sz);\r\nbfa_mem_dma_seg_iter(fcxp_mod, seg_ptr, nsegs, idx) {\r\nif (num_fcxps >= per_seg_fcxp) {\r\nnum_fcxps -= per_seg_fcxp;\r\nbfa_mem_dma_setup(minfo, seg_ptr,\r\nper_seg_fcxp * per_fcxp_sz);\r\n} else\r\nbfa_mem_dma_setup(minfo, seg_ptr,\r\nnum_fcxps * per_fcxp_sz);\r\n}\r\nbfa_mem_kva_setup(minfo, fcxp_kva,\r\ncfg->fwcfg.num_fcxp_reqs * sizeof(struct bfa_fcxp_s));\r\n}\r\nstatic void\r\nbfa_fcxp_attach(struct bfa_s *bfa, void *bfad, struct bfa_iocfc_cfg_s *cfg,\r\nstruct bfa_pcidev_s *pcidev)\r\n{\r\nstruct bfa_fcxp_mod_s *mod = BFA_FCXP_MOD(bfa);\r\nmod->bfa = bfa;\r\nmod->num_fcxps = cfg->fwcfg.num_fcxp_reqs;\r\nmod->req_pld_sz = mod->rsp_pld_sz = BFA_FCXP_MAX_IBUF_SZ;\r\nif (!cfg->drvcfg.min_cfg)\r\nmod->rsp_pld_sz = BFA_FCXP_MAX_LBUF_SZ;\r\nINIT_LIST_HEAD(&mod->req_wait_q);\r\nINIT_LIST_HEAD(&mod->rsp_wait_q);\r\nclaim_fcxps_mem(mod);\r\n}\r\nstatic void\r\nbfa_fcxp_detach(struct bfa_s *bfa)\r\n{\r\n}\r\nstatic void\r\nbfa_fcxp_start(struct bfa_s *bfa)\r\n{\r\n}\r\nstatic void\r\nbfa_fcxp_stop(struct bfa_s *bfa)\r\n{\r\n}\r\nstatic void\r\nbfa_fcxp_iocdisable(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcxp_mod_s *mod = BFA_FCXP_MOD(bfa);\r\nstruct bfa_fcxp_s *fcxp;\r\nstruct list_head *qe, *qen;\r\nlist_splice_tail_init(&mod->fcxp_req_unused_q, &mod->fcxp_req_free_q);\r\nlist_splice_tail_init(&mod->fcxp_rsp_unused_q, &mod->fcxp_rsp_free_q);\r\nlist_for_each_safe(qe, qen, &mod->fcxp_active_q) {\r\nfcxp = (struct bfa_fcxp_s *) qe;\r\nif (fcxp->caller == NULL) {\r\nfcxp->send_cbfn(fcxp->caller, fcxp, fcxp->send_cbarg,\r\nBFA_STATUS_IOC_FAILURE, 0, 0, NULL);\r\nbfa_fcxp_free(fcxp);\r\n} else {\r\nfcxp->rsp_status = BFA_STATUS_IOC_FAILURE;\r\nbfa_cb_queue(bfa, &fcxp->hcb_qe,\r\n__bfa_fcxp_send_cbfn, fcxp);\r\n}\r\n}\r\n}\r\nstatic struct bfa_fcxp_s *\r\nbfa_fcxp_get(struct bfa_fcxp_mod_s *fm, bfa_boolean_t req)\r\n{\r\nstruct bfa_fcxp_s *fcxp;\r\nif (req)\r\nbfa_q_deq(&fm->fcxp_req_free_q, &fcxp);\r\nelse\r\nbfa_q_deq(&fm->fcxp_rsp_free_q, &fcxp);\r\nif (fcxp)\r\nlist_add_tail(&fcxp->qe, &fm->fcxp_active_q);\r\nreturn fcxp;\r\n}\r\nstatic void\r\nbfa_fcxp_init_reqrsp(struct bfa_fcxp_s *fcxp,\r\nstruct bfa_s *bfa,\r\nu8 *use_ibuf,\r\nu32 *nr_sgles,\r\nbfa_fcxp_get_sgaddr_t *r_sga_cbfn,\r\nbfa_fcxp_get_sglen_t *r_sglen_cbfn,\r\nstruct list_head *r_sgpg_q,\r\nint n_sgles,\r\nbfa_fcxp_get_sgaddr_t sga_cbfn,\r\nbfa_fcxp_get_sglen_t sglen_cbfn)\r\n{\r\nWARN_ON(bfa == NULL);\r\nbfa_trc(bfa, fcxp->fcxp_tag);\r\nif (n_sgles == 0) {\r\n*use_ibuf = 1;\r\n} else {\r\nWARN_ON(*sga_cbfn == NULL);\r\nWARN_ON(*sglen_cbfn == NULL);\r\n*use_ibuf = 0;\r\n*r_sga_cbfn = sga_cbfn;\r\n*r_sglen_cbfn = sglen_cbfn;\r\n*nr_sgles = n_sgles;\r\nif (n_sgles > BFI_SGE_INLINE)\r\nWARN_ON(1);\r\n}\r\n}\r\nstatic void\r\nbfa_fcxp_init(struct bfa_fcxp_s *fcxp,\r\nvoid *caller, struct bfa_s *bfa, int nreq_sgles,\r\nint nrsp_sgles, bfa_fcxp_get_sgaddr_t req_sga_cbfn,\r\nbfa_fcxp_get_sglen_t req_sglen_cbfn,\r\nbfa_fcxp_get_sgaddr_t rsp_sga_cbfn,\r\nbfa_fcxp_get_sglen_t rsp_sglen_cbfn)\r\n{\r\nWARN_ON(bfa == NULL);\r\nbfa_trc(bfa, fcxp->fcxp_tag);\r\nfcxp->caller = caller;\r\nbfa_fcxp_init_reqrsp(fcxp, bfa,\r\n&fcxp->use_ireqbuf, &fcxp->nreq_sgles, &fcxp->req_sga_cbfn,\r\n&fcxp->req_sglen_cbfn, &fcxp->req_sgpg_q,\r\nnreq_sgles, req_sga_cbfn, req_sglen_cbfn);\r\nbfa_fcxp_init_reqrsp(fcxp, bfa,\r\n&fcxp->use_irspbuf, &fcxp->nrsp_sgles, &fcxp->rsp_sga_cbfn,\r\n&fcxp->rsp_sglen_cbfn, &fcxp->rsp_sgpg_q,\r\nnrsp_sgles, rsp_sga_cbfn, rsp_sglen_cbfn);\r\n}\r\nstatic void\r\nbfa_fcxp_put(struct bfa_fcxp_s *fcxp)\r\n{\r\nstruct bfa_fcxp_mod_s *mod = fcxp->fcxp_mod;\r\nstruct bfa_fcxp_wqe_s *wqe;\r\nif (fcxp->req_rsp)\r\nbfa_q_deq(&mod->req_wait_q, &wqe);\r\nelse\r\nbfa_q_deq(&mod->rsp_wait_q, &wqe);\r\nif (wqe) {\r\nbfa_trc(mod->bfa, fcxp->fcxp_tag);\r\nbfa_fcxp_init(fcxp, wqe->caller, wqe->bfa, wqe->nreq_sgles,\r\nwqe->nrsp_sgles, wqe->req_sga_cbfn,\r\nwqe->req_sglen_cbfn, wqe->rsp_sga_cbfn,\r\nwqe->rsp_sglen_cbfn);\r\nwqe->alloc_cbfn(wqe->alloc_cbarg, fcxp);\r\nreturn;\r\n}\r\nWARN_ON(!bfa_q_is_on_q(&mod->fcxp_active_q, fcxp));\r\nlist_del(&fcxp->qe);\r\nif (fcxp->req_rsp)\r\nlist_add_tail(&fcxp->qe, &mod->fcxp_req_free_q);\r\nelse\r\nlist_add_tail(&fcxp->qe, &mod->fcxp_rsp_free_q);\r\n}\r\nstatic void\r\nbfa_fcxp_null_comp(void *bfad_fcxp, struct bfa_fcxp_s *fcxp, void *cbarg,\r\nbfa_status_t req_status, u32 rsp_len,\r\nu32 resid_len, struct fchs_s *rsp_fchs)\r\n{\r\n}\r\nstatic void\r\n__bfa_fcxp_send_cbfn(void *cbarg, bfa_boolean_t complete)\r\n{\r\nstruct bfa_fcxp_s *fcxp = cbarg;\r\nif (complete) {\r\nfcxp->send_cbfn(fcxp->caller, fcxp, fcxp->send_cbarg,\r\nfcxp->rsp_status, fcxp->rsp_len,\r\nfcxp->residue_len, &fcxp->rsp_fchs);\r\n} else {\r\nbfa_fcxp_free(fcxp);\r\n}\r\n}\r\nstatic void\r\nhal_fcxp_send_comp(struct bfa_s *bfa, struct bfi_fcxp_send_rsp_s *fcxp_rsp)\r\n{\r\nstruct bfa_fcxp_mod_s *mod = BFA_FCXP_MOD(bfa);\r\nstruct bfa_fcxp_s *fcxp;\r\nu16 fcxp_tag = be16_to_cpu(fcxp_rsp->fcxp_tag);\r\nbfa_trc(bfa, fcxp_tag);\r\nfcxp_rsp->rsp_len = be32_to_cpu(fcxp_rsp->rsp_len);\r\nif (fcxp_rsp->req_status == BFA_STATUS_OK)\r\nfcxp_rsp->residue_len = 0;\r\nelse\r\nfcxp_rsp->residue_len = be32_to_cpu(fcxp_rsp->residue_len);\r\nfcxp = BFA_FCXP_FROM_TAG(mod, fcxp_tag);\r\nWARN_ON(fcxp->send_cbfn == NULL);\r\nhal_fcxp_rx_plog(mod->bfa, fcxp, fcxp_rsp);\r\nif (fcxp->send_cbfn != NULL) {\r\nbfa_trc(mod->bfa, (NULL == fcxp->caller));\r\nif (fcxp->caller == NULL) {\r\nfcxp->send_cbfn(fcxp->caller, fcxp, fcxp->send_cbarg,\r\nfcxp_rsp->req_status, fcxp_rsp->rsp_len,\r\nfcxp_rsp->residue_len, &fcxp_rsp->fchs);\r\nbfa_fcxp_free(fcxp);\r\n} else {\r\nfcxp->rsp_status = fcxp_rsp->req_status;\r\nfcxp->rsp_len = fcxp_rsp->rsp_len;\r\nfcxp->residue_len = fcxp_rsp->residue_len;\r\nfcxp->rsp_fchs = fcxp_rsp->fchs;\r\nbfa_cb_queue(bfa, &fcxp->hcb_qe,\r\n__bfa_fcxp_send_cbfn, fcxp);\r\n}\r\n} else {\r\nbfa_trc(bfa, (NULL == fcxp->send_cbfn));\r\n}\r\n}\r\nstatic void\r\nhal_fcxp_tx_plog(struct bfa_s *bfa, u32 reqlen, struct bfa_fcxp_s *fcxp,\r\nstruct fchs_s *fchs)\r\n{\r\nif (reqlen > 0) {\r\nif (fcxp->use_ireqbuf) {\r\nu32 pld_w0 =\r\n*((u32 *) BFA_FCXP_REQ_PLD(fcxp));\r\nbfa_plog_fchdr_and_pl(bfa->plog, BFA_PL_MID_HAL_FCXP,\r\nBFA_PL_EID_TX,\r\nreqlen + sizeof(struct fchs_s), fchs,\r\npld_w0);\r\n} else {\r\nbfa_plog_fchdr(bfa->plog, BFA_PL_MID_HAL_FCXP,\r\nBFA_PL_EID_TX,\r\nreqlen + sizeof(struct fchs_s),\r\nfchs);\r\n}\r\n} else {\r\nbfa_plog_fchdr(bfa->plog, BFA_PL_MID_HAL_FCXP, BFA_PL_EID_TX,\r\nreqlen + sizeof(struct fchs_s), fchs);\r\n}\r\n}\r\nstatic void\r\nhal_fcxp_rx_plog(struct bfa_s *bfa, struct bfa_fcxp_s *fcxp,\r\nstruct bfi_fcxp_send_rsp_s *fcxp_rsp)\r\n{\r\nif (fcxp_rsp->rsp_len > 0) {\r\nif (fcxp->use_irspbuf) {\r\nu32 pld_w0 =\r\n*((u32 *) BFA_FCXP_RSP_PLD(fcxp));\r\nbfa_plog_fchdr_and_pl(bfa->plog, BFA_PL_MID_HAL_FCXP,\r\nBFA_PL_EID_RX,\r\n(u16) fcxp_rsp->rsp_len,\r\n&fcxp_rsp->fchs, pld_w0);\r\n} else {\r\nbfa_plog_fchdr(bfa->plog, BFA_PL_MID_HAL_FCXP,\r\nBFA_PL_EID_RX,\r\n(u16) fcxp_rsp->rsp_len,\r\n&fcxp_rsp->fchs);\r\n}\r\n} else {\r\nbfa_plog_fchdr(bfa->plog, BFA_PL_MID_HAL_FCXP, BFA_PL_EID_RX,\r\n(u16) fcxp_rsp->rsp_len, &fcxp_rsp->fchs);\r\n}\r\n}\r\nstatic void\r\nbfa_fcxp_qresume(void *cbarg)\r\n{\r\nstruct bfa_fcxp_s *fcxp = cbarg;\r\nstruct bfa_s *bfa = fcxp->fcxp_mod->bfa;\r\nstruct bfi_fcxp_send_req_s *send_req;\r\nfcxp->reqq_waiting = BFA_FALSE;\r\nsend_req = bfa_reqq_next(bfa, BFA_REQQ_FCXP);\r\nbfa_fcxp_queue(fcxp, send_req);\r\n}\r\nstatic void\r\nbfa_fcxp_queue(struct bfa_fcxp_s *fcxp, struct bfi_fcxp_send_req_s *send_req)\r\n{\r\nstruct bfa_s *bfa = fcxp->fcxp_mod->bfa;\r\nstruct bfa_fcxp_req_info_s *reqi = &fcxp->req_info;\r\nstruct bfa_fcxp_rsp_info_s *rspi = &fcxp->rsp_info;\r\nstruct bfa_rport_s *rport = reqi->bfa_rport;\r\nbfi_h2i_set(send_req->mh, BFI_MC_FCXP, BFI_FCXP_H2I_SEND_REQ,\r\nbfa_fn_lpu(bfa));\r\nsend_req->fcxp_tag = cpu_to_be16(fcxp->fcxp_tag);\r\nif (rport) {\r\nsend_req->rport_fw_hndl = rport->fw_handle;\r\nsend_req->max_frmsz = cpu_to_be16(rport->rport_info.max_frmsz);\r\nif (send_req->max_frmsz == 0)\r\nsend_req->max_frmsz = cpu_to_be16(FC_MAX_PDUSZ);\r\n} else {\r\nsend_req->rport_fw_hndl = 0;\r\nsend_req->max_frmsz = cpu_to_be16(FC_MAX_PDUSZ);\r\n}\r\nsend_req->vf_id = cpu_to_be16(reqi->vf_id);\r\nsend_req->lp_fwtag = bfa_lps_get_fwtag(bfa, reqi->lp_tag);\r\nsend_req->class = reqi->class;\r\nsend_req->rsp_timeout = rspi->rsp_timeout;\r\nsend_req->cts = reqi->cts;\r\nsend_req->fchs = reqi->fchs;\r\nsend_req->req_len = cpu_to_be32(reqi->req_tot_len);\r\nsend_req->rsp_maxlen = cpu_to_be32(rspi->rsp_maxlen);\r\nif (fcxp->use_ireqbuf == 1) {\r\nbfa_alen_set(&send_req->req_alen, reqi->req_tot_len,\r\nBFA_FCXP_REQ_PLD_PA(fcxp));\r\n} else {\r\nif (fcxp->nreq_sgles > 0) {\r\nWARN_ON(fcxp->nreq_sgles != 1);\r\nbfa_alen_set(&send_req->req_alen, reqi->req_tot_len,\r\nfcxp->req_sga_cbfn(fcxp->caller, 0));\r\n} else {\r\nWARN_ON(reqi->req_tot_len != 0);\r\nbfa_alen_set(&send_req->rsp_alen, 0, 0);\r\n}\r\n}\r\nif (fcxp->use_irspbuf == 1) {\r\nWARN_ON(rspi->rsp_maxlen > BFA_FCXP_MAX_LBUF_SZ);\r\nbfa_alen_set(&send_req->rsp_alen, rspi->rsp_maxlen,\r\nBFA_FCXP_RSP_PLD_PA(fcxp));\r\n} else {\r\nif (fcxp->nrsp_sgles > 0) {\r\nWARN_ON(fcxp->nrsp_sgles != 1);\r\nbfa_alen_set(&send_req->rsp_alen, rspi->rsp_maxlen,\r\nfcxp->rsp_sga_cbfn(fcxp->caller, 0));\r\n} else {\r\nWARN_ON(rspi->rsp_maxlen != 0);\r\nbfa_alen_set(&send_req->rsp_alen, 0, 0);\r\n}\r\n}\r\nhal_fcxp_tx_plog(bfa, reqi->req_tot_len, fcxp, &reqi->fchs);\r\nbfa_reqq_produce(bfa, BFA_REQQ_FCXP, send_req->mh);\r\nbfa_trc(bfa, bfa_reqq_pi(bfa, BFA_REQQ_FCXP));\r\nbfa_trc(bfa, bfa_reqq_ci(bfa, BFA_REQQ_FCXP));\r\n}\r\nstruct bfa_fcxp_s *\r\nbfa_fcxp_req_rsp_alloc(void *caller, struct bfa_s *bfa, int nreq_sgles,\r\nint nrsp_sgles, bfa_fcxp_get_sgaddr_t req_sga_cbfn,\r\nbfa_fcxp_get_sglen_t req_sglen_cbfn,\r\nbfa_fcxp_get_sgaddr_t rsp_sga_cbfn,\r\nbfa_fcxp_get_sglen_t rsp_sglen_cbfn, bfa_boolean_t req)\r\n{\r\nstruct bfa_fcxp_s *fcxp = NULL;\r\nWARN_ON(bfa == NULL);\r\nfcxp = bfa_fcxp_get(BFA_FCXP_MOD(bfa), req);\r\nif (fcxp == NULL)\r\nreturn NULL;\r\nbfa_trc(bfa, fcxp->fcxp_tag);\r\nbfa_fcxp_init(fcxp, caller, bfa, nreq_sgles, nrsp_sgles, req_sga_cbfn,\r\nreq_sglen_cbfn, rsp_sga_cbfn, rsp_sglen_cbfn);\r\nreturn fcxp;\r\n}\r\nvoid *\r\nbfa_fcxp_get_reqbuf(struct bfa_fcxp_s *fcxp)\r\n{\r\nstruct bfa_fcxp_mod_s *mod = fcxp->fcxp_mod;\r\nvoid *reqbuf;\r\nWARN_ON(fcxp->use_ireqbuf != 1);\r\nreqbuf = bfa_mem_get_dmabuf_kva(mod, fcxp->fcxp_tag,\r\nmod->req_pld_sz + mod->rsp_pld_sz);\r\nreturn reqbuf;\r\n}\r\nu32\r\nbfa_fcxp_get_reqbufsz(struct bfa_fcxp_s *fcxp)\r\n{\r\nstruct bfa_fcxp_mod_s *mod = fcxp->fcxp_mod;\r\nreturn mod->req_pld_sz;\r\n}\r\nvoid *\r\nbfa_fcxp_get_rspbuf(struct bfa_fcxp_s *fcxp)\r\n{\r\nstruct bfa_fcxp_mod_s *mod = fcxp->fcxp_mod;\r\nvoid *fcxp_buf;\r\nWARN_ON(fcxp->use_irspbuf != 1);\r\nfcxp_buf = bfa_mem_get_dmabuf_kva(mod, fcxp->fcxp_tag,\r\nmod->req_pld_sz + mod->rsp_pld_sz);\r\nreturn ((u8 *) fcxp_buf) + mod->req_pld_sz;\r\n}\r\nvoid\r\nbfa_fcxp_free(struct bfa_fcxp_s *fcxp)\r\n{\r\nstruct bfa_fcxp_mod_s *mod = fcxp->fcxp_mod;\r\nWARN_ON(fcxp == NULL);\r\nbfa_trc(mod->bfa, fcxp->fcxp_tag);\r\nbfa_fcxp_put(fcxp);\r\n}\r\nvoid\r\nbfa_fcxp_send(struct bfa_fcxp_s *fcxp, struct bfa_rport_s *rport,\r\nu16 vf_id, u8 lp_tag, bfa_boolean_t cts, enum fc_cos cos,\r\nu32 reqlen, struct fchs_s *fchs, bfa_cb_fcxp_send_t cbfn,\r\nvoid *cbarg, u32 rsp_maxlen, u8 rsp_timeout)\r\n{\r\nstruct bfa_s *bfa = fcxp->fcxp_mod->bfa;\r\nstruct bfa_fcxp_req_info_s *reqi = &fcxp->req_info;\r\nstruct bfa_fcxp_rsp_info_s *rspi = &fcxp->rsp_info;\r\nstruct bfi_fcxp_send_req_s *send_req;\r\nbfa_trc(bfa, fcxp->fcxp_tag);\r\nreqi->bfa_rport = rport;\r\nreqi->vf_id = vf_id;\r\nreqi->lp_tag = lp_tag;\r\nreqi->class = cos;\r\nrspi->rsp_timeout = rsp_timeout;\r\nreqi->cts = cts;\r\nreqi->fchs = *fchs;\r\nreqi->req_tot_len = reqlen;\r\nrspi->rsp_maxlen = rsp_maxlen;\r\nfcxp->send_cbfn = cbfn ? cbfn : bfa_fcxp_null_comp;\r\nfcxp->send_cbarg = cbarg;\r\nsend_req = bfa_reqq_next(bfa, BFA_REQQ_FCXP);\r\nif (!send_req) {\r\nbfa_trc(bfa, fcxp->fcxp_tag);\r\nfcxp->reqq_waiting = BFA_TRUE;\r\nbfa_reqq_wait(bfa, BFA_REQQ_FCXP, &fcxp->reqq_wqe);\r\nreturn;\r\n}\r\nbfa_fcxp_queue(fcxp, send_req);\r\n}\r\nbfa_status_t\r\nbfa_fcxp_abort(struct bfa_fcxp_s *fcxp)\r\n{\r\nbfa_trc(fcxp->fcxp_mod->bfa, fcxp->fcxp_tag);\r\nWARN_ON(1);\r\nreturn BFA_STATUS_OK;\r\n}\r\nvoid\r\nbfa_fcxp_req_rsp_alloc_wait(struct bfa_s *bfa, struct bfa_fcxp_wqe_s *wqe,\r\nbfa_fcxp_alloc_cbfn_t alloc_cbfn, void *alloc_cbarg,\r\nvoid *caller, int nreq_sgles,\r\nint nrsp_sgles, bfa_fcxp_get_sgaddr_t req_sga_cbfn,\r\nbfa_fcxp_get_sglen_t req_sglen_cbfn,\r\nbfa_fcxp_get_sgaddr_t rsp_sga_cbfn,\r\nbfa_fcxp_get_sglen_t rsp_sglen_cbfn, bfa_boolean_t req)\r\n{\r\nstruct bfa_fcxp_mod_s *mod = BFA_FCXP_MOD(bfa);\r\nif (req)\r\nWARN_ON(!list_empty(&mod->fcxp_req_free_q));\r\nelse\r\nWARN_ON(!list_empty(&mod->fcxp_rsp_free_q));\r\nwqe->alloc_cbfn = alloc_cbfn;\r\nwqe->alloc_cbarg = alloc_cbarg;\r\nwqe->caller = caller;\r\nwqe->bfa = bfa;\r\nwqe->nreq_sgles = nreq_sgles;\r\nwqe->nrsp_sgles = nrsp_sgles;\r\nwqe->req_sga_cbfn = req_sga_cbfn;\r\nwqe->req_sglen_cbfn = req_sglen_cbfn;\r\nwqe->rsp_sga_cbfn = rsp_sga_cbfn;\r\nwqe->rsp_sglen_cbfn = rsp_sglen_cbfn;\r\nif (req)\r\nlist_add_tail(&wqe->qe, &mod->req_wait_q);\r\nelse\r\nlist_add_tail(&wqe->qe, &mod->rsp_wait_q);\r\n}\r\nvoid\r\nbfa_fcxp_walloc_cancel(struct bfa_s *bfa, struct bfa_fcxp_wqe_s *wqe)\r\n{\r\nstruct bfa_fcxp_mod_s *mod = BFA_FCXP_MOD(bfa);\r\nWARN_ON(!bfa_q_is_on_q(&mod->req_wait_q, wqe) ||\r\n!bfa_q_is_on_q(&mod->rsp_wait_q, wqe));\r\nlist_del(&wqe->qe);\r\n}\r\nvoid\r\nbfa_fcxp_discard(struct bfa_fcxp_s *fcxp)\r\n{\r\nif (fcxp->reqq_waiting) {\r\nfcxp->reqq_waiting = BFA_FALSE;\r\nbfa_reqq_wcancel(&fcxp->reqq_wqe);\r\nbfa_fcxp_free(fcxp);\r\nreturn;\r\n}\r\nfcxp->send_cbfn = bfa_fcxp_null_comp;\r\n}\r\nvoid\r\nbfa_fcxp_isr(struct bfa_s *bfa, struct bfi_msg_s *msg)\r\n{\r\nswitch (msg->mhdr.msg_id) {\r\ncase BFI_FCXP_I2H_SEND_RSP:\r\nhal_fcxp_send_comp(bfa, (struct bfi_fcxp_send_rsp_s *) msg);\r\nbreak;\r\ndefault:\r\nbfa_trc(bfa, msg->mhdr.msg_id);\r\nWARN_ON(1);\r\n}\r\n}\r\nu32\r\nbfa_fcxp_get_maxrsp(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcxp_mod_s *mod = BFA_FCXP_MOD(bfa);\r\nreturn mod->rsp_pld_sz;\r\n}\r\nvoid\r\nbfa_fcxp_res_recfg(struct bfa_s *bfa, u16 num_fcxp_fw)\r\n{\r\nstruct bfa_fcxp_mod_s *mod = BFA_FCXP_MOD(bfa);\r\nstruct list_head *qe;\r\nint i;\r\nfor (i = 0; i < (mod->num_fcxps - num_fcxp_fw); i++) {\r\nif (i < ((mod->num_fcxps - num_fcxp_fw) / 2)) {\r\nbfa_q_deq_tail(&mod->fcxp_req_free_q, &qe);\r\nlist_add_tail(qe, &mod->fcxp_req_unused_q);\r\n} else {\r\nbfa_q_deq_tail(&mod->fcxp_rsp_free_q, &qe);\r\nlist_add_tail(qe, &mod->fcxp_rsp_unused_q);\r\n}\r\n}\r\n}\r\nstatic void\r\nbfa_lps_sm_init(struct bfa_lps_s *lps, enum bfa_lps_event event)\r\n{\r\nbfa_trc(lps->bfa, lps->bfa_tag);\r\nbfa_trc(lps->bfa, event);\r\nswitch (event) {\r\ncase BFA_LPS_SM_LOGIN:\r\nif (bfa_reqq_full(lps->bfa, lps->reqq)) {\r\nbfa_sm_set_state(lps, bfa_lps_sm_loginwait);\r\nbfa_reqq_wait(lps->bfa, lps->reqq, &lps->wqe);\r\n} else {\r\nbfa_sm_set_state(lps, bfa_lps_sm_login);\r\nbfa_lps_send_login(lps);\r\n}\r\nif (lps->fdisc)\r\nbfa_plog_str(lps->bfa->plog, BFA_PL_MID_LPS,\r\nBFA_PL_EID_LOGIN, 0, "FDISC Request");\r\nelse\r\nbfa_plog_str(lps->bfa->plog, BFA_PL_MID_LPS,\r\nBFA_PL_EID_LOGIN, 0, "FLOGI Request");\r\nbreak;\r\ncase BFA_LPS_SM_LOGOUT:\r\nbfa_lps_logout_comp(lps);\r\nbreak;\r\ncase BFA_LPS_SM_DELETE:\r\nbfa_lps_free(lps);\r\nbreak;\r\ncase BFA_LPS_SM_RX_CVL:\r\ncase BFA_LPS_SM_OFFLINE:\r\nbreak;\r\ncase BFA_LPS_SM_FWRSP:\r\nbreak;\r\ncase BFA_LPS_SM_SET_N2N_PID:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(lps->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_lps_sm_login(struct bfa_lps_s *lps, enum bfa_lps_event event)\r\n{\r\nbfa_trc(lps->bfa, lps->bfa_tag);\r\nbfa_trc(lps->bfa, event);\r\nswitch (event) {\r\ncase BFA_LPS_SM_FWRSP:\r\nif (lps->status == BFA_STATUS_OK) {\r\nbfa_sm_set_state(lps, bfa_lps_sm_online);\r\nif (lps->fdisc)\r\nbfa_plog_str(lps->bfa->plog, BFA_PL_MID_LPS,\r\nBFA_PL_EID_LOGIN, 0, "FDISC Accept");\r\nelse\r\nbfa_plog_str(lps->bfa->plog, BFA_PL_MID_LPS,\r\nBFA_PL_EID_LOGIN, 0, "FLOGI Accept");\r\nbfa_trc(lps->bfa, lps->fport);\r\nbfa_trc(lps->bfa, lps->lp_pid);\r\nif (!lps->fport && lps->lp_pid)\r\nbfa_sm_send_event(lps, BFA_LPS_SM_SET_N2N_PID);\r\n} else {\r\nbfa_sm_set_state(lps, bfa_lps_sm_init);\r\nif (lps->fdisc)\r\nbfa_plog_str(lps->bfa->plog, BFA_PL_MID_LPS,\r\nBFA_PL_EID_LOGIN, 0,\r\n"FDISC Fail (RJT or timeout)");\r\nelse\r\nbfa_plog_str(lps->bfa->plog, BFA_PL_MID_LPS,\r\nBFA_PL_EID_LOGIN, 0,\r\n"FLOGI Fail (RJT or timeout)");\r\n}\r\nbfa_lps_login_comp(lps);\r\nbreak;\r\ncase BFA_LPS_SM_OFFLINE:\r\ncase BFA_LPS_SM_DELETE:\r\nbfa_sm_set_state(lps, bfa_lps_sm_init);\r\nbreak;\r\ncase BFA_LPS_SM_SET_N2N_PID:\r\nbfa_trc(lps->bfa, lps->fport);\r\nbfa_trc(lps->bfa, lps->lp_pid);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(lps->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_lps_sm_loginwait(struct bfa_lps_s *lps, enum bfa_lps_event event)\r\n{\r\nbfa_trc(lps->bfa, lps->bfa_tag);\r\nbfa_trc(lps->bfa, event);\r\nswitch (event) {\r\ncase BFA_LPS_SM_RESUME:\r\nbfa_sm_set_state(lps, bfa_lps_sm_login);\r\nbfa_lps_send_login(lps);\r\nbreak;\r\ncase BFA_LPS_SM_OFFLINE:\r\ncase BFA_LPS_SM_DELETE:\r\nbfa_sm_set_state(lps, bfa_lps_sm_init);\r\nbfa_reqq_wcancel(&lps->wqe);\r\nbreak;\r\ncase BFA_LPS_SM_RX_CVL:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(lps->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_lps_sm_online(struct bfa_lps_s *lps, enum bfa_lps_event event)\r\n{\r\nbfa_trc(lps->bfa, lps->bfa_tag);\r\nbfa_trc(lps->bfa, event);\r\nswitch (event) {\r\ncase BFA_LPS_SM_LOGOUT:\r\nif (bfa_reqq_full(lps->bfa, lps->reqq)) {\r\nbfa_sm_set_state(lps, bfa_lps_sm_logowait);\r\nbfa_reqq_wait(lps->bfa, lps->reqq, &lps->wqe);\r\n} else {\r\nbfa_sm_set_state(lps, bfa_lps_sm_logout);\r\nbfa_lps_send_logout(lps);\r\n}\r\nbfa_plog_str(lps->bfa->plog, BFA_PL_MID_LPS,\r\nBFA_PL_EID_LOGO, 0, "Logout");\r\nbreak;\r\ncase BFA_LPS_SM_RX_CVL:\r\nbfa_sm_set_state(lps, bfa_lps_sm_init);\r\nbfa_lps_cvl_event(lps);\r\nbfa_plog_str(lps->bfa->plog, BFA_PL_MID_LPS,\r\nBFA_PL_EID_FIP_FCF_CVL, 0, "FCF Clear Virt. Link Rx");\r\nbreak;\r\ncase BFA_LPS_SM_SET_N2N_PID:\r\nif (bfa_reqq_full(lps->bfa, lps->reqq)) {\r\nbfa_sm_set_state(lps, bfa_lps_sm_online_n2n_pid_wait);\r\nbfa_reqq_wait(lps->bfa, lps->reqq, &lps->wqe);\r\n} else\r\nbfa_lps_send_set_n2n_pid(lps);\r\nbreak;\r\ncase BFA_LPS_SM_OFFLINE:\r\ncase BFA_LPS_SM_DELETE:\r\nbfa_sm_set_state(lps, bfa_lps_sm_init);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(lps->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_lps_sm_online_n2n_pid_wait(struct bfa_lps_s *lps, enum bfa_lps_event event)\r\n{\r\nbfa_trc(lps->bfa, lps->bfa_tag);\r\nbfa_trc(lps->bfa, event);\r\nswitch (event) {\r\ncase BFA_LPS_SM_RESUME:\r\nbfa_sm_set_state(lps, bfa_lps_sm_online);\r\nbfa_lps_send_set_n2n_pid(lps);\r\nbreak;\r\ncase BFA_LPS_SM_LOGOUT:\r\nbfa_sm_set_state(lps, bfa_lps_sm_logowait);\r\nbfa_plog_str(lps->bfa->plog, BFA_PL_MID_LPS,\r\nBFA_PL_EID_LOGO, 0, "Logout");\r\nbreak;\r\ncase BFA_LPS_SM_RX_CVL:\r\nbfa_sm_set_state(lps, bfa_lps_sm_init);\r\nbfa_reqq_wcancel(&lps->wqe);\r\nbfa_lps_cvl_event(lps);\r\nbfa_plog_str(lps->bfa->plog, BFA_PL_MID_LPS,\r\nBFA_PL_EID_FIP_FCF_CVL, 0, "FCF Clear Virt. Link Rx");\r\nbreak;\r\ncase BFA_LPS_SM_OFFLINE:\r\ncase BFA_LPS_SM_DELETE:\r\nbfa_sm_set_state(lps, bfa_lps_sm_init);\r\nbfa_reqq_wcancel(&lps->wqe);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(lps->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_lps_sm_logout(struct bfa_lps_s *lps, enum bfa_lps_event event)\r\n{\r\nbfa_trc(lps->bfa, lps->bfa_tag);\r\nbfa_trc(lps->bfa, event);\r\nswitch (event) {\r\ncase BFA_LPS_SM_FWRSP:\r\ncase BFA_LPS_SM_OFFLINE:\r\nbfa_sm_set_state(lps, bfa_lps_sm_init);\r\nbfa_lps_logout_comp(lps);\r\nbreak;\r\ncase BFA_LPS_SM_DELETE:\r\nbfa_sm_set_state(lps, bfa_lps_sm_init);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(lps->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_lps_sm_logowait(struct bfa_lps_s *lps, enum bfa_lps_event event)\r\n{\r\nbfa_trc(lps->bfa, lps->bfa_tag);\r\nbfa_trc(lps->bfa, event);\r\nswitch (event) {\r\ncase BFA_LPS_SM_RESUME:\r\nbfa_sm_set_state(lps, bfa_lps_sm_logout);\r\nbfa_lps_send_logout(lps);\r\nbreak;\r\ncase BFA_LPS_SM_OFFLINE:\r\ncase BFA_LPS_SM_DELETE:\r\nbfa_sm_set_state(lps, bfa_lps_sm_init);\r\nbfa_reqq_wcancel(&lps->wqe);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(lps->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_lps_meminfo(struct bfa_iocfc_cfg_s *cfg, struct bfa_meminfo_s *minfo,\r\nstruct bfa_s *bfa)\r\n{\r\nstruct bfa_mem_kva_s *lps_kva = BFA_MEM_LPS_KVA(bfa);\r\nif (cfg->drvcfg.min_cfg)\r\nbfa_mem_kva_setup(minfo, lps_kva,\r\nsizeof(struct bfa_lps_s) * BFA_LPS_MIN_LPORTS);\r\nelse\r\nbfa_mem_kva_setup(minfo, lps_kva,\r\nsizeof(struct bfa_lps_s) * BFA_LPS_MAX_LPORTS);\r\n}\r\nstatic void\r\nbfa_lps_attach(struct bfa_s *bfa, void *bfad, struct bfa_iocfc_cfg_s *cfg,\r\nstruct bfa_pcidev_s *pcidev)\r\n{\r\nstruct bfa_lps_mod_s *mod = BFA_LPS_MOD(bfa);\r\nstruct bfa_lps_s *lps;\r\nint i;\r\nmod->num_lps = BFA_LPS_MAX_LPORTS;\r\nif (cfg->drvcfg.min_cfg)\r\nmod->num_lps = BFA_LPS_MIN_LPORTS;\r\nelse\r\nmod->num_lps = BFA_LPS_MAX_LPORTS;\r\nmod->lps_arr = lps = (struct bfa_lps_s *) bfa_mem_kva_curp(mod);\r\nbfa_mem_kva_curp(mod) += mod->num_lps * sizeof(struct bfa_lps_s);\r\nINIT_LIST_HEAD(&mod->lps_free_q);\r\nINIT_LIST_HEAD(&mod->lps_active_q);\r\nINIT_LIST_HEAD(&mod->lps_login_q);\r\nfor (i = 0; i < mod->num_lps; i++, lps++) {\r\nlps->bfa = bfa;\r\nlps->bfa_tag = (u8) i;\r\nlps->reqq = BFA_REQQ_LPS;\r\nbfa_reqq_winit(&lps->wqe, bfa_lps_reqq_resume, lps);\r\nlist_add_tail(&lps->qe, &mod->lps_free_q);\r\n}\r\n}\r\nstatic void\r\nbfa_lps_detach(struct bfa_s *bfa)\r\n{\r\n}\r\nstatic void\r\nbfa_lps_start(struct bfa_s *bfa)\r\n{\r\n}\r\nstatic void\r\nbfa_lps_stop(struct bfa_s *bfa)\r\n{\r\n}\r\nstatic void\r\nbfa_lps_iocdisable(struct bfa_s *bfa)\r\n{\r\nstruct bfa_lps_mod_s *mod = BFA_LPS_MOD(bfa);\r\nstruct bfa_lps_s *lps;\r\nstruct list_head *qe, *qen;\r\nlist_for_each_safe(qe, qen, &mod->lps_active_q) {\r\nlps = (struct bfa_lps_s *) qe;\r\nbfa_sm_send_event(lps, BFA_LPS_SM_OFFLINE);\r\n}\r\nlist_for_each_safe(qe, qen, &mod->lps_login_q) {\r\nlps = (struct bfa_lps_s *) qe;\r\nbfa_sm_send_event(lps, BFA_LPS_SM_OFFLINE);\r\n}\r\nlist_splice_tail_init(&mod->lps_login_q, &mod->lps_active_q);\r\n}\r\nstatic void\r\nbfa_lps_login_rsp(struct bfa_s *bfa, struct bfi_lps_login_rsp_s *rsp)\r\n{\r\nstruct bfa_lps_mod_s *mod = BFA_LPS_MOD(bfa);\r\nstruct bfa_lps_s *lps;\r\nWARN_ON(rsp->bfa_tag >= mod->num_lps);\r\nlps = BFA_LPS_FROM_TAG(mod, rsp->bfa_tag);\r\nlps->status = rsp->status;\r\nswitch (rsp->status) {\r\ncase BFA_STATUS_OK:\r\nlps->fw_tag = rsp->fw_tag;\r\nlps->fport = rsp->f_port;\r\nif (lps->fport)\r\nlps->lp_pid = rsp->lp_pid;\r\nlps->npiv_en = rsp->npiv_en;\r\nlps->pr_bbcred = be16_to_cpu(rsp->bb_credit);\r\nlps->pr_pwwn = rsp->port_name;\r\nlps->pr_nwwn = rsp->node_name;\r\nlps->auth_req = rsp->auth_req;\r\nlps->lp_mac = rsp->lp_mac;\r\nlps->brcd_switch = rsp->brcd_switch;\r\nlps->fcf_mac = rsp->fcf_mac;\r\nbreak;\r\ncase BFA_STATUS_FABRIC_RJT:\r\nlps->lsrjt_rsn = rsp->lsrjt_rsn;\r\nlps->lsrjt_expl = rsp->lsrjt_expl;\r\nbreak;\r\ncase BFA_STATUS_EPROTOCOL:\r\nlps->ext_status = rsp->ext_status;\r\nbreak;\r\ncase BFA_STATUS_VPORT_MAX:\r\nif (rsp->ext_status)\r\nbfa_lps_no_res(lps, rsp->ext_status);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nlist_del(&lps->qe);\r\nlist_add_tail(&lps->qe, &mod->lps_active_q);\r\nbfa_sm_send_event(lps, BFA_LPS_SM_FWRSP);\r\n}\r\nstatic void\r\nbfa_lps_no_res(struct bfa_lps_s *first_lps, u8 count)\r\n{\r\nstruct bfa_s *bfa = first_lps->bfa;\r\nstruct bfa_lps_mod_s *mod = BFA_LPS_MOD(bfa);\r\nstruct list_head *qe, *qe_next;\r\nstruct bfa_lps_s *lps;\r\nbfa_trc(bfa, count);\r\nqe = bfa_q_next(first_lps);\r\nwhile (count && qe) {\r\nqe_next = bfa_q_next(qe);\r\nlps = (struct bfa_lps_s *)qe;\r\nbfa_trc(bfa, lps->bfa_tag);\r\nlps->status = first_lps->status;\r\nlist_del(&lps->qe);\r\nlist_add_tail(&lps->qe, &mod->lps_active_q);\r\nbfa_sm_send_event(lps, BFA_LPS_SM_FWRSP);\r\nqe = qe_next;\r\ncount--;\r\n}\r\n}\r\nstatic void\r\nbfa_lps_logout_rsp(struct bfa_s *bfa, struct bfi_lps_logout_rsp_s *rsp)\r\n{\r\nstruct bfa_lps_mod_s *mod = BFA_LPS_MOD(bfa);\r\nstruct bfa_lps_s *lps;\r\nWARN_ON(rsp->bfa_tag >= mod->num_lps);\r\nlps = BFA_LPS_FROM_TAG(mod, rsp->bfa_tag);\r\nbfa_sm_send_event(lps, BFA_LPS_SM_FWRSP);\r\n}\r\nstatic void\r\nbfa_lps_rx_cvl_event(struct bfa_s *bfa, struct bfi_lps_cvl_event_s *cvl)\r\n{\r\nstruct bfa_lps_mod_s *mod = BFA_LPS_MOD(bfa);\r\nstruct bfa_lps_s *lps;\r\nlps = BFA_LPS_FROM_TAG(mod, cvl->bfa_tag);\r\nbfa_sm_send_event(lps, BFA_LPS_SM_RX_CVL);\r\n}\r\nstatic void\r\nbfa_lps_reqq_resume(void *lps_arg)\r\n{\r\nstruct bfa_lps_s *lps = lps_arg;\r\nbfa_sm_send_event(lps, BFA_LPS_SM_RESUME);\r\n}\r\nstatic void\r\nbfa_lps_free(struct bfa_lps_s *lps)\r\n{\r\nstruct bfa_lps_mod_s *mod = BFA_LPS_MOD(lps->bfa);\r\nlps->lp_pid = 0;\r\nlist_del(&lps->qe);\r\nlist_add_tail(&lps->qe, &mod->lps_free_q);\r\n}\r\nstatic void\r\nbfa_lps_send_login(struct bfa_lps_s *lps)\r\n{\r\nstruct bfa_lps_mod_s *mod = BFA_LPS_MOD(lps->bfa);\r\nstruct bfi_lps_login_req_s *m;\r\nm = bfa_reqq_next(lps->bfa, lps->reqq);\r\nWARN_ON(!m);\r\nbfi_h2i_set(m->mh, BFI_MC_LPS, BFI_LPS_H2I_LOGIN_REQ,\r\nbfa_fn_lpu(lps->bfa));\r\nm->bfa_tag = lps->bfa_tag;\r\nm->alpa = lps->alpa;\r\nm->pdu_size = cpu_to_be16(lps->pdusz);\r\nm->pwwn = lps->pwwn;\r\nm->nwwn = lps->nwwn;\r\nm->fdisc = lps->fdisc;\r\nm->auth_en = lps->auth_en;\r\nbfa_reqq_produce(lps->bfa, lps->reqq, m->mh);\r\nlist_del(&lps->qe);\r\nlist_add_tail(&lps->qe, &mod->lps_login_q);\r\n}\r\nstatic void\r\nbfa_lps_send_logout(struct bfa_lps_s *lps)\r\n{\r\nstruct bfi_lps_logout_req_s *m;\r\nm = bfa_reqq_next(lps->bfa, lps->reqq);\r\nWARN_ON(!m);\r\nbfi_h2i_set(m->mh, BFI_MC_LPS, BFI_LPS_H2I_LOGOUT_REQ,\r\nbfa_fn_lpu(lps->bfa));\r\nm->fw_tag = lps->fw_tag;\r\nm->port_name = lps->pwwn;\r\nbfa_reqq_produce(lps->bfa, lps->reqq, m->mh);\r\n}\r\nstatic void\r\nbfa_lps_send_set_n2n_pid(struct bfa_lps_s *lps)\r\n{\r\nstruct bfi_lps_n2n_pid_req_s *m;\r\nm = bfa_reqq_next(lps->bfa, lps->reqq);\r\nWARN_ON(!m);\r\nbfi_h2i_set(m->mh, BFI_MC_LPS, BFI_LPS_H2I_N2N_PID_REQ,\r\nbfa_fn_lpu(lps->bfa));\r\nm->fw_tag = lps->fw_tag;\r\nm->lp_pid = lps->lp_pid;\r\nbfa_reqq_produce(lps->bfa, lps->reqq, m->mh);\r\n}\r\nstatic void\r\nbfa_lps_login_comp_cb(void *arg, bfa_boolean_t complete)\r\n{\r\nstruct bfa_lps_s *lps = arg;\r\nif (!complete)\r\nreturn;\r\nif (lps->fdisc)\r\nbfa_cb_lps_fdisc_comp(lps->bfa->bfad, lps->uarg, lps->status);\r\nelse\r\nbfa_cb_lps_flogi_comp(lps->bfa->bfad, lps->uarg, lps->status);\r\n}\r\nstatic void\r\nbfa_lps_login_comp(struct bfa_lps_s *lps)\r\n{\r\nif (!lps->bfa->fcs) {\r\nbfa_cb_queue(lps->bfa, &lps->hcb_qe, bfa_lps_login_comp_cb,\r\nlps);\r\nreturn;\r\n}\r\nif (lps->fdisc)\r\nbfa_cb_lps_fdisc_comp(lps->bfa->bfad, lps->uarg, lps->status);\r\nelse\r\nbfa_cb_lps_flogi_comp(lps->bfa->bfad, lps->uarg, lps->status);\r\n}\r\nstatic void\r\nbfa_lps_logout_comp_cb(void *arg, bfa_boolean_t complete)\r\n{\r\nstruct bfa_lps_s *lps = arg;\r\nif (!complete)\r\nreturn;\r\nif (lps->fdisc)\r\nbfa_cb_lps_fdisclogo_comp(lps->bfa->bfad, lps->uarg);\r\nelse\r\nbfa_cb_lps_flogo_comp(lps->bfa->bfad, lps->uarg);\r\n}\r\nstatic void\r\nbfa_lps_logout_comp(struct bfa_lps_s *lps)\r\n{\r\nif (!lps->bfa->fcs) {\r\nbfa_cb_queue(lps->bfa, &lps->hcb_qe, bfa_lps_logout_comp_cb,\r\nlps);\r\nreturn;\r\n}\r\nif (lps->fdisc)\r\nbfa_cb_lps_fdisclogo_comp(lps->bfa->bfad, lps->uarg);\r\n}\r\nstatic void\r\nbfa_lps_cvl_event_cb(void *arg, bfa_boolean_t complete)\r\n{\r\nstruct bfa_lps_s *lps = arg;\r\nif (!complete)\r\nreturn;\r\nif (lps->fdisc)\r\nbfa_cb_lps_cvl_event(lps->bfa->bfad, lps->uarg);\r\n}\r\nstatic void\r\nbfa_lps_cvl_event(struct bfa_lps_s *lps)\r\n{\r\nif (!lps->bfa->fcs) {\r\nbfa_cb_queue(lps->bfa, &lps->hcb_qe, bfa_lps_cvl_event_cb,\r\nlps);\r\nreturn;\r\n}\r\nif (lps->fdisc)\r\nbfa_cb_lps_cvl_event(lps->bfa->bfad, lps->uarg);\r\n}\r\nu32\r\nbfa_lps_get_max_vport(struct bfa_s *bfa)\r\n{\r\nif (bfa_ioc_devid(&bfa->ioc) == BFA_PCI_DEVICE_ID_CT)\r\nreturn BFA_LPS_MAX_VPORTS_SUPP_CT;\r\nelse\r\nreturn BFA_LPS_MAX_VPORTS_SUPP_CB;\r\n}\r\nstruct bfa_lps_s *\r\nbfa_lps_alloc(struct bfa_s *bfa)\r\n{\r\nstruct bfa_lps_mod_s *mod = BFA_LPS_MOD(bfa);\r\nstruct bfa_lps_s *lps = NULL;\r\nbfa_q_deq(&mod->lps_free_q, &lps);\r\nif (lps == NULL)\r\nreturn NULL;\r\nlist_add_tail(&lps->qe, &mod->lps_active_q);\r\nbfa_sm_set_state(lps, bfa_lps_sm_init);\r\nreturn lps;\r\n}\r\nvoid\r\nbfa_lps_delete(struct bfa_lps_s *lps)\r\n{\r\nbfa_sm_send_event(lps, BFA_LPS_SM_DELETE);\r\n}\r\nvoid\r\nbfa_lps_flogi(struct bfa_lps_s *lps, void *uarg, u8 alpa, u16 pdusz,\r\nwwn_t pwwn, wwn_t nwwn, bfa_boolean_t auth_en)\r\n{\r\nlps->uarg = uarg;\r\nlps->alpa = alpa;\r\nlps->pdusz = pdusz;\r\nlps->pwwn = pwwn;\r\nlps->nwwn = nwwn;\r\nlps->fdisc = BFA_FALSE;\r\nlps->auth_en = auth_en;\r\nbfa_sm_send_event(lps, BFA_LPS_SM_LOGIN);\r\n}\r\nvoid\r\nbfa_lps_fdisc(struct bfa_lps_s *lps, void *uarg, u16 pdusz, wwn_t pwwn,\r\nwwn_t nwwn)\r\n{\r\nlps->uarg = uarg;\r\nlps->alpa = 0;\r\nlps->pdusz = pdusz;\r\nlps->pwwn = pwwn;\r\nlps->nwwn = nwwn;\r\nlps->fdisc = BFA_TRUE;\r\nlps->auth_en = BFA_FALSE;\r\nbfa_sm_send_event(lps, BFA_LPS_SM_LOGIN);\r\n}\r\nvoid\r\nbfa_lps_fdisclogo(struct bfa_lps_s *lps)\r\n{\r\nbfa_sm_send_event(lps, BFA_LPS_SM_LOGOUT);\r\n}\r\nu8\r\nbfa_lps_get_fwtag(struct bfa_s *bfa, u8 lp_tag)\r\n{\r\nstruct bfa_lps_mod_s *mod = BFA_LPS_MOD(bfa);\r\nreturn BFA_LPS_FROM_TAG(mod, lp_tag)->fw_tag;\r\n}\r\nu8\r\nbfa_lps_get_tag_from_pid(struct bfa_s *bfa, u32 pid)\r\n{\r\nstruct bfa_lps_mod_s *mod = BFA_LPS_MOD(bfa);\r\nstruct bfa_lps_s *lps;\r\nint i;\r\nfor (i = 0, lps = mod->lps_arr; i < mod->num_lps; i++, lps++) {\r\nif (lps->lp_pid == pid)\r\nreturn lps->bfa_tag;\r\n}\r\nreturn 0;\r\n}\r\nu32\r\nbfa_lps_get_base_pid(struct bfa_s *bfa)\r\n{\r\nstruct bfa_lps_mod_s *mod = BFA_LPS_MOD(bfa);\r\nreturn BFA_LPS_FROM_TAG(mod, 0)->lp_pid;\r\n}\r\nvoid\r\nbfa_lps_set_n2n_pid(struct bfa_lps_s *lps, uint32_t n2n_pid)\r\n{\r\nbfa_trc(lps->bfa, lps->bfa_tag);\r\nbfa_trc(lps->bfa, n2n_pid);\r\nlps->lp_pid = n2n_pid;\r\nbfa_sm_send_event(lps, BFA_LPS_SM_SET_N2N_PID);\r\n}\r\nvoid\r\nbfa_lps_isr(struct bfa_s *bfa, struct bfi_msg_s *m)\r\n{\r\nunion bfi_lps_i2h_msg_u msg;\r\nbfa_trc(bfa, m->mhdr.msg_id);\r\nmsg.msg = m;\r\nswitch (m->mhdr.msg_id) {\r\ncase BFI_LPS_I2H_LOGIN_RSP:\r\nbfa_lps_login_rsp(bfa, msg.login_rsp);\r\nbreak;\r\ncase BFI_LPS_I2H_LOGOUT_RSP:\r\nbfa_lps_logout_rsp(bfa, msg.logout_rsp);\r\nbreak;\r\ncase BFI_LPS_I2H_CVL_EVENT:\r\nbfa_lps_rx_cvl_event(bfa, msg.cvl_event);\r\nbreak;\r\ndefault:\r\nbfa_trc(bfa, m->mhdr.msg_id);\r\nWARN_ON(1);\r\n}\r\n}\r\nstatic void\r\nbfa_fcport_aen_post(struct bfa_fcport_s *fcport, enum bfa_port_aen_event event)\r\n{\r\nstruct bfad_s *bfad = (struct bfad_s *)fcport->bfa->bfad;\r\nstruct bfa_aen_entry_s *aen_entry;\r\nbfad_get_aen_entry(bfad, aen_entry);\r\nif (!aen_entry)\r\nreturn;\r\naen_entry->aen_data.port.ioc_type = bfa_get_type(fcport->bfa);\r\naen_entry->aen_data.port.pwwn = fcport->pwwn;\r\nbfad_im_post_vendor_event(aen_entry, bfad, ++fcport->bfa->bfa_aen_seq,\r\nBFA_AEN_CAT_PORT, event);\r\n}\r\nstatic void\r\nbfa_fcport_sm_uninit(struct bfa_fcport_s *fcport,\r\nenum bfa_fcport_sm_event event)\r\n{\r\nbfa_trc(fcport->bfa, event);\r\nswitch (event) {\r\ncase BFA_FCPORT_SM_START:\r\nfcport->use_flash_cfg = BFA_TRUE;\r\nif (bfa_fcport_send_enable(fcport)) {\r\nbfa_trc(fcport->bfa, BFA_TRUE);\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_enabling);\r\n} else {\r\nbfa_trc(fcport->bfa, BFA_FALSE);\r\nbfa_sm_set_state(fcport,\r\nbfa_fcport_sm_enabling_qwait);\r\n}\r\nbreak;\r\ncase BFA_FCPORT_SM_ENABLE:\r\nbreak;\r\ncase BFA_FCPORT_SM_DISABLE:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_disabled);\r\nbreak;\r\ncase BFA_FCPORT_SM_HWFAIL:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_iocdown);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(fcport->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcport_sm_enabling_qwait(struct bfa_fcport_s *fcport,\r\nenum bfa_fcport_sm_event event)\r\n{\r\nchar pwwn_buf[BFA_STRING_32];\r\nstruct bfad_s *bfad = (struct bfad_s *)fcport->bfa->bfad;\r\nbfa_trc(fcport->bfa, event);\r\nswitch (event) {\r\ncase BFA_FCPORT_SM_QRESUME:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_enabling);\r\nbfa_fcport_send_enable(fcport);\r\nbreak;\r\ncase BFA_FCPORT_SM_STOP:\r\nbfa_reqq_wcancel(&fcport->reqq_wait);\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_stopped);\r\nbreak;\r\ncase BFA_FCPORT_SM_ENABLE:\r\nbreak;\r\ncase BFA_FCPORT_SM_DISABLE:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_disabled);\r\nbfa_reqq_wcancel(&fcport->reqq_wait);\r\nbfa_plog_str(fcport->bfa->plog, BFA_PL_MID_HAL,\r\nBFA_PL_EID_PORT_DISABLE, 0, "Port Disable");\r\nwwn2str(pwwn_buf, fcport->pwwn);\r\nBFA_LOG(KERN_INFO, bfad, bfa_log_level,\r\n"Base port disabled: WWN = %s\n", pwwn_buf);\r\nbfa_fcport_aen_post(fcport, BFA_PORT_AEN_DISABLE);\r\nbreak;\r\ncase BFA_FCPORT_SM_LINKUP:\r\ncase BFA_FCPORT_SM_LINKDOWN:\r\nbreak;\r\ncase BFA_FCPORT_SM_HWFAIL:\r\nbfa_reqq_wcancel(&fcport->reqq_wait);\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_iocdown);\r\nbreak;\r\ncase BFA_FCPORT_SM_FAA_MISCONFIG:\r\nbfa_fcport_reset_linkinfo(fcport);\r\nbfa_fcport_aen_post(fcport, BFA_PORT_AEN_DISCONNECT);\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_faa_misconfig);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(fcport->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcport_sm_enabling(struct bfa_fcport_s *fcport,\r\nenum bfa_fcport_sm_event event)\r\n{\r\nchar pwwn_buf[BFA_STRING_32];\r\nstruct bfad_s *bfad = (struct bfad_s *)fcport->bfa->bfad;\r\nbfa_trc(fcport->bfa, event);\r\nswitch (event) {\r\ncase BFA_FCPORT_SM_FWRSP:\r\ncase BFA_FCPORT_SM_LINKDOWN:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_linkdown);\r\nbreak;\r\ncase BFA_FCPORT_SM_LINKUP:\r\nbfa_fcport_update_linkinfo(fcport);\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_linkup);\r\nWARN_ON(!fcport->event_cbfn);\r\nbfa_fcport_scn(fcport, BFA_PORT_LINKUP, BFA_FALSE);\r\nbreak;\r\ncase BFA_FCPORT_SM_ENABLE:\r\nbreak;\r\ncase BFA_FCPORT_SM_DISABLE:\r\nif (bfa_fcport_send_disable(fcport))\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_disabling);\r\nelse\r\nbfa_sm_set_state(fcport,\r\nbfa_fcport_sm_disabling_qwait);\r\nbfa_plog_str(fcport->bfa->plog, BFA_PL_MID_HAL,\r\nBFA_PL_EID_PORT_DISABLE, 0, "Port Disable");\r\nwwn2str(pwwn_buf, fcport->pwwn);\r\nBFA_LOG(KERN_INFO, bfad, bfa_log_level,\r\n"Base port disabled: WWN = %s\n", pwwn_buf);\r\nbfa_fcport_aen_post(fcport, BFA_PORT_AEN_DISABLE);\r\nbreak;\r\ncase BFA_FCPORT_SM_STOP:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_stopped);\r\nbreak;\r\ncase BFA_FCPORT_SM_HWFAIL:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_iocdown);\r\nbreak;\r\ncase BFA_FCPORT_SM_FAA_MISCONFIG:\r\nbfa_fcport_reset_linkinfo(fcport);\r\nbfa_fcport_aen_post(fcport, BFA_PORT_AEN_DISCONNECT);\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_faa_misconfig);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(fcport->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcport_sm_linkdown(struct bfa_fcport_s *fcport,\r\nenum bfa_fcport_sm_event event)\r\n{\r\nstruct bfi_fcport_event_s *pevent = fcport->event_arg.i2hmsg.event;\r\nchar pwwn_buf[BFA_STRING_32];\r\nstruct bfad_s *bfad = (struct bfad_s *)fcport->bfa->bfad;\r\nbfa_trc(fcport->bfa, event);\r\nswitch (event) {\r\ncase BFA_FCPORT_SM_LINKUP:\r\nbfa_fcport_update_linkinfo(fcport);\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_linkup);\r\nWARN_ON(!fcport->event_cbfn);\r\nbfa_plog_str(fcport->bfa->plog, BFA_PL_MID_HAL,\r\nBFA_PL_EID_PORT_ST_CHANGE, 0, "Port Linkup");\r\nif (!bfa_ioc_get_fcmode(&fcport->bfa->ioc)) {\r\nbfa_trc(fcport->bfa,\r\npevent->link_state.attr.vc_fcf.fcf.fipenabled);\r\nbfa_trc(fcport->bfa,\r\npevent->link_state.attr.vc_fcf.fcf.fipfailed);\r\nif (pevent->link_state.attr.vc_fcf.fcf.fipfailed)\r\nbfa_plog_str(fcport->bfa->plog, BFA_PL_MID_HAL,\r\nBFA_PL_EID_FIP_FCF_DISC, 0,\r\n"FIP FCF Discovery Failed");\r\nelse\r\nbfa_plog_str(fcport->bfa->plog, BFA_PL_MID_HAL,\r\nBFA_PL_EID_FIP_FCF_DISC, 0,\r\n"FIP FCF Discovered");\r\n}\r\nbfa_fcport_scn(fcport, BFA_PORT_LINKUP, BFA_FALSE);\r\nwwn2str(pwwn_buf, fcport->pwwn);\r\nBFA_LOG(KERN_INFO, bfad, bfa_log_level,\r\n"Base port online: WWN = %s\n", pwwn_buf);\r\nbfa_fcport_aen_post(fcport, BFA_PORT_AEN_ONLINE);\r\nif (fcport->cfg.qos_enabled &&\r\nfcport->qos_attr.state != BFA_QOS_ONLINE)\r\nbfa_fcport_aen_post(fcport, BFA_PORT_AEN_QOS_NEG);\r\nbreak;\r\ncase BFA_FCPORT_SM_LINKDOWN:\r\nbreak;\r\ncase BFA_FCPORT_SM_ENABLE:\r\nbreak;\r\ncase BFA_FCPORT_SM_DISABLE:\r\nif (bfa_fcport_send_disable(fcport))\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_disabling);\r\nelse\r\nbfa_sm_set_state(fcport,\r\nbfa_fcport_sm_disabling_qwait);\r\nbfa_plog_str(fcport->bfa->plog, BFA_PL_MID_HAL,\r\nBFA_PL_EID_PORT_DISABLE, 0, "Port Disable");\r\nwwn2str(pwwn_buf, fcport->pwwn);\r\nBFA_LOG(KERN_INFO, bfad, bfa_log_level,\r\n"Base port disabled: WWN = %s\n", pwwn_buf);\r\nbfa_fcport_aen_post(fcport, BFA_PORT_AEN_DISABLE);\r\nbreak;\r\ncase BFA_FCPORT_SM_STOP:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_stopped);\r\nbreak;\r\ncase BFA_FCPORT_SM_HWFAIL:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_iocdown);\r\nbreak;\r\ncase BFA_FCPORT_SM_FAA_MISCONFIG:\r\nbfa_fcport_reset_linkinfo(fcport);\r\nbfa_fcport_aen_post(fcport, BFA_PORT_AEN_DISCONNECT);\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_faa_misconfig);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(fcport->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcport_sm_linkup(struct bfa_fcport_s *fcport,\r\nenum bfa_fcport_sm_event event)\r\n{\r\nchar pwwn_buf[BFA_STRING_32];\r\nstruct bfad_s *bfad = (struct bfad_s *)fcport->bfa->bfad;\r\nbfa_trc(fcport->bfa, event);\r\nswitch (event) {\r\ncase BFA_FCPORT_SM_ENABLE:\r\nbreak;\r\ncase BFA_FCPORT_SM_DISABLE:\r\nif (bfa_fcport_send_disable(fcport))\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_disabling);\r\nelse\r\nbfa_sm_set_state(fcport,\r\nbfa_fcport_sm_disabling_qwait);\r\nbfa_fcport_reset_linkinfo(fcport);\r\nbfa_fcport_scn(fcport, BFA_PORT_LINKDOWN, BFA_FALSE);\r\nbfa_plog_str(fcport->bfa->plog, BFA_PL_MID_HAL,\r\nBFA_PL_EID_PORT_DISABLE, 0, "Port Disable");\r\nwwn2str(pwwn_buf, fcport->pwwn);\r\nBFA_LOG(KERN_INFO, bfad, bfa_log_level,\r\n"Base port offline: WWN = %s\n", pwwn_buf);\r\nbfa_fcport_aen_post(fcport, BFA_PORT_AEN_OFFLINE);\r\nBFA_LOG(KERN_INFO, bfad, bfa_log_level,\r\n"Base port disabled: WWN = %s\n", pwwn_buf);\r\nbfa_fcport_aen_post(fcport, BFA_PORT_AEN_DISABLE);\r\nbreak;\r\ncase BFA_FCPORT_SM_LINKDOWN:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_linkdown);\r\nbfa_fcport_reset_linkinfo(fcport);\r\nbfa_fcport_scn(fcport, BFA_PORT_LINKDOWN, BFA_FALSE);\r\nbfa_plog_str(fcport->bfa->plog, BFA_PL_MID_HAL,\r\nBFA_PL_EID_PORT_ST_CHANGE, 0, "Port Linkdown");\r\nwwn2str(pwwn_buf, fcport->pwwn);\r\nif (BFA_PORT_IS_DISABLED(fcport->bfa)) {\r\nBFA_LOG(KERN_INFO, bfad, bfa_log_level,\r\n"Base port offline: WWN = %s\n", pwwn_buf);\r\nbfa_fcport_aen_post(fcport, BFA_PORT_AEN_OFFLINE);\r\n} else {\r\nBFA_LOG(KERN_ERR, bfad, bfa_log_level,\r\n"Base port (WWN = %s) "\r\n"lost fabric connectivity\n", pwwn_buf);\r\nbfa_fcport_aen_post(fcport, BFA_PORT_AEN_DISCONNECT);\r\n}\r\nbreak;\r\ncase BFA_FCPORT_SM_STOP:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_stopped);\r\nbfa_fcport_reset_linkinfo(fcport);\r\nwwn2str(pwwn_buf, fcport->pwwn);\r\nif (BFA_PORT_IS_DISABLED(fcport->bfa)) {\r\nBFA_LOG(KERN_INFO, bfad, bfa_log_level,\r\n"Base port offline: WWN = %s\n", pwwn_buf);\r\nbfa_fcport_aen_post(fcport, BFA_PORT_AEN_OFFLINE);\r\n} else {\r\nBFA_LOG(KERN_ERR, bfad, bfa_log_level,\r\n"Base port (WWN = %s) "\r\n"lost fabric connectivity\n", pwwn_buf);\r\nbfa_fcport_aen_post(fcport, BFA_PORT_AEN_DISCONNECT);\r\n}\r\nbreak;\r\ncase BFA_FCPORT_SM_HWFAIL:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_iocdown);\r\nbfa_fcport_reset_linkinfo(fcport);\r\nbfa_fcport_scn(fcport, BFA_PORT_LINKDOWN, BFA_FALSE);\r\nwwn2str(pwwn_buf, fcport->pwwn);\r\nif (BFA_PORT_IS_DISABLED(fcport->bfa)) {\r\nBFA_LOG(KERN_INFO, bfad, bfa_log_level,\r\n"Base port offline: WWN = %s\n", pwwn_buf);\r\nbfa_fcport_aen_post(fcport, BFA_PORT_AEN_OFFLINE);\r\n} else {\r\nBFA_LOG(KERN_ERR, bfad, bfa_log_level,\r\n"Base port (WWN = %s) "\r\n"lost fabric connectivity\n", pwwn_buf);\r\nbfa_fcport_aen_post(fcport, BFA_PORT_AEN_DISCONNECT);\r\n}\r\nbreak;\r\ncase BFA_FCPORT_SM_FAA_MISCONFIG:\r\nbfa_fcport_reset_linkinfo(fcport);\r\nbfa_fcport_aen_post(fcport, BFA_PORT_AEN_DISCONNECT);\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_faa_misconfig);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(fcport->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcport_sm_disabling_qwait(struct bfa_fcport_s *fcport,\r\nenum bfa_fcport_sm_event event)\r\n{\r\nbfa_trc(fcport->bfa, event);\r\nswitch (event) {\r\ncase BFA_FCPORT_SM_QRESUME:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_disabling);\r\nbfa_fcport_send_disable(fcport);\r\nbreak;\r\ncase BFA_FCPORT_SM_STOP:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_stopped);\r\nbfa_reqq_wcancel(&fcport->reqq_wait);\r\nbreak;\r\ncase BFA_FCPORT_SM_ENABLE:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_toggling_qwait);\r\nbreak;\r\ncase BFA_FCPORT_SM_DISABLE:\r\nbreak;\r\ncase BFA_FCPORT_SM_LINKUP:\r\ncase BFA_FCPORT_SM_LINKDOWN:\r\nbreak;\r\ncase BFA_FCPORT_SM_HWFAIL:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_iocfail);\r\nbfa_reqq_wcancel(&fcport->reqq_wait);\r\nbreak;\r\ncase BFA_FCPORT_SM_FAA_MISCONFIG:\r\nbfa_fcport_reset_linkinfo(fcport);\r\nbfa_fcport_aen_post(fcport, BFA_PORT_AEN_DISCONNECT);\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_faa_misconfig);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(fcport->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcport_sm_toggling_qwait(struct bfa_fcport_s *fcport,\r\nenum bfa_fcport_sm_event event)\r\n{\r\nbfa_trc(fcport->bfa, event);\r\nswitch (event) {\r\ncase BFA_FCPORT_SM_QRESUME:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_disabling);\r\nbfa_fcport_send_disable(fcport);\r\nif (bfa_fcport_send_enable(fcport))\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_enabling);\r\nelse\r\nbfa_sm_set_state(fcport,\r\nbfa_fcport_sm_enabling_qwait);\r\nbreak;\r\ncase BFA_FCPORT_SM_STOP:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_stopped);\r\nbfa_reqq_wcancel(&fcport->reqq_wait);\r\nbreak;\r\ncase BFA_FCPORT_SM_ENABLE:\r\nbreak;\r\ncase BFA_FCPORT_SM_DISABLE:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_disabling_qwait);\r\nbreak;\r\ncase BFA_FCPORT_SM_LINKUP:\r\ncase BFA_FCPORT_SM_LINKDOWN:\r\nbreak;\r\ncase BFA_FCPORT_SM_HWFAIL:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_iocfail);\r\nbfa_reqq_wcancel(&fcport->reqq_wait);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(fcport->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcport_sm_disabling(struct bfa_fcport_s *fcport,\r\nenum bfa_fcport_sm_event event)\r\n{\r\nchar pwwn_buf[BFA_STRING_32];\r\nstruct bfad_s *bfad = (struct bfad_s *)fcport->bfa->bfad;\r\nbfa_trc(fcport->bfa, event);\r\nswitch (event) {\r\ncase BFA_FCPORT_SM_FWRSP:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_disabled);\r\nbreak;\r\ncase BFA_FCPORT_SM_DISABLE:\r\nbreak;\r\ncase BFA_FCPORT_SM_ENABLE:\r\nif (bfa_fcport_send_enable(fcport))\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_enabling);\r\nelse\r\nbfa_sm_set_state(fcport,\r\nbfa_fcport_sm_enabling_qwait);\r\nbfa_plog_str(fcport->bfa->plog, BFA_PL_MID_HAL,\r\nBFA_PL_EID_PORT_ENABLE, 0, "Port Enable");\r\nwwn2str(pwwn_buf, fcport->pwwn);\r\nBFA_LOG(KERN_INFO, bfad, bfa_log_level,\r\n"Base port enabled: WWN = %s\n", pwwn_buf);\r\nbfa_fcport_aen_post(fcport, BFA_PORT_AEN_ENABLE);\r\nbreak;\r\ncase BFA_FCPORT_SM_STOP:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_stopped);\r\nbreak;\r\ncase BFA_FCPORT_SM_LINKUP:\r\ncase BFA_FCPORT_SM_LINKDOWN:\r\nbreak;\r\ncase BFA_FCPORT_SM_HWFAIL:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_iocfail);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(fcport->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcport_sm_disabled(struct bfa_fcport_s *fcport,\r\nenum bfa_fcport_sm_event event)\r\n{\r\nchar pwwn_buf[BFA_STRING_32];\r\nstruct bfad_s *bfad = (struct bfad_s *)fcport->bfa->bfad;\r\nbfa_trc(fcport->bfa, event);\r\nswitch (event) {\r\ncase BFA_FCPORT_SM_START:\r\nbreak;\r\ncase BFA_FCPORT_SM_STOP:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_stopped);\r\nbreak;\r\ncase BFA_FCPORT_SM_ENABLE:\r\nif (bfa_fcport_send_enable(fcport))\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_enabling);\r\nelse\r\nbfa_sm_set_state(fcport,\r\nbfa_fcport_sm_enabling_qwait);\r\nbfa_plog_str(fcport->bfa->plog, BFA_PL_MID_HAL,\r\nBFA_PL_EID_PORT_ENABLE, 0, "Port Enable");\r\nwwn2str(pwwn_buf, fcport->pwwn);\r\nBFA_LOG(KERN_INFO, bfad, bfa_log_level,\r\n"Base port enabled: WWN = %s\n", pwwn_buf);\r\nbfa_fcport_aen_post(fcport, BFA_PORT_AEN_ENABLE);\r\nbreak;\r\ncase BFA_FCPORT_SM_DISABLE:\r\nbreak;\r\ncase BFA_FCPORT_SM_HWFAIL:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_iocfail);\r\nbreak;\r\ncase BFA_FCPORT_SM_DPORTENABLE:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_dport);\r\nbreak;\r\ncase BFA_FCPORT_SM_DDPORTENABLE:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_ddport);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(fcport->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcport_sm_stopped(struct bfa_fcport_s *fcport,\r\nenum bfa_fcport_sm_event event)\r\n{\r\nbfa_trc(fcport->bfa, event);\r\nswitch (event) {\r\ncase BFA_FCPORT_SM_START:\r\nif (bfa_fcport_send_enable(fcport))\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_enabling);\r\nelse\r\nbfa_sm_set_state(fcport,\r\nbfa_fcport_sm_enabling_qwait);\r\nbreak;\r\ndefault:\r\n;\r\n}\r\n}\r\nstatic void\r\nbfa_fcport_sm_iocdown(struct bfa_fcport_s *fcport,\r\nenum bfa_fcport_sm_event event)\r\n{\r\nbfa_trc(fcport->bfa, event);\r\nswitch (event) {\r\ncase BFA_FCPORT_SM_START:\r\nif (bfa_fcport_send_enable(fcport))\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_enabling);\r\nelse\r\nbfa_sm_set_state(fcport,\r\nbfa_fcport_sm_enabling_qwait);\r\nbreak;\r\ndefault:\r\n;\r\n}\r\n}\r\nstatic void\r\nbfa_fcport_sm_iocfail(struct bfa_fcport_s *fcport,\r\nenum bfa_fcport_sm_event event)\r\n{\r\nbfa_trc(fcport->bfa, event);\r\nswitch (event) {\r\ncase BFA_FCPORT_SM_START:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_disabled);\r\nbreak;\r\ncase BFA_FCPORT_SM_ENABLE:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_iocdown);\r\nbreak;\r\ndefault:\r\n;\r\n}\r\n}\r\nstatic void\r\nbfa_fcport_sm_dport(struct bfa_fcport_s *fcport, enum bfa_fcport_sm_event event)\r\n{\r\nbfa_trc(fcport->bfa, event);\r\nswitch (event) {\r\ncase BFA_FCPORT_SM_DPORTENABLE:\r\ncase BFA_FCPORT_SM_DISABLE:\r\ncase BFA_FCPORT_SM_ENABLE:\r\ncase BFA_FCPORT_SM_START:\r\nbreak;\r\ncase BFA_FCPORT_SM_STOP:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_stopped);\r\nbreak;\r\ncase BFA_FCPORT_SM_HWFAIL:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_iocfail);\r\nbreak;\r\ncase BFA_FCPORT_SM_DPORTDISABLE:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_disabled);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(fcport->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcport_sm_ddport(struct bfa_fcport_s *fcport,\r\nenum bfa_fcport_sm_event event)\r\n{\r\nbfa_trc(fcport->bfa, event);\r\nswitch (event) {\r\ncase BFA_FCPORT_SM_DISABLE:\r\ncase BFA_FCPORT_SM_DDPORTDISABLE:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_disabled);\r\nbreak;\r\ncase BFA_FCPORT_SM_DPORTENABLE:\r\ncase BFA_FCPORT_SM_DPORTDISABLE:\r\ncase BFA_FCPORT_SM_ENABLE:\r\ncase BFA_FCPORT_SM_START:\r\nbreak;\r\ncase BFA_FCPORT_SM_STOP:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_stopped);\r\nbreak;\r\ncase BFA_FCPORT_SM_HWFAIL:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_iocfail);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(fcport->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcport_sm_faa_misconfig(struct bfa_fcport_s *fcport,\r\nenum bfa_fcport_sm_event event)\r\n{\r\nbfa_trc(fcport->bfa, event);\r\nswitch (event) {\r\ncase BFA_FCPORT_SM_DPORTENABLE:\r\ncase BFA_FCPORT_SM_ENABLE:\r\ncase BFA_FCPORT_SM_START:\r\nbreak;\r\ncase BFA_FCPORT_SM_DISABLE:\r\nif (bfa_fcport_send_disable(fcport))\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_disabling);\r\nelse\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_disabling_qwait);\r\nbfa_fcport_reset_linkinfo(fcport);\r\nbfa_fcport_scn(fcport, BFA_PORT_LINKDOWN, BFA_FALSE);\r\nbfa_plog_str(fcport->bfa->plog, BFA_PL_MID_HAL,\r\nBFA_PL_EID_PORT_DISABLE, 0, "Port Disable");\r\nbfa_fcport_aen_post(fcport, BFA_PORT_AEN_DISABLE);\r\nbreak;\r\ncase BFA_FCPORT_SM_STOP:\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_stopped);\r\nbreak;\r\ncase BFA_FCPORT_SM_HWFAIL:\r\nbfa_fcport_reset_linkinfo(fcport);\r\nbfa_fcport_scn(fcport, BFA_PORT_LINKDOWN, BFA_FALSE);\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_iocdown);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(fcport->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcport_ln_sm_dn(struct bfa_fcport_ln_s *ln,\r\nenum bfa_fcport_ln_sm_event event)\r\n{\r\nbfa_trc(ln->fcport->bfa, event);\r\nswitch (event) {\r\ncase BFA_FCPORT_LN_SM_LINKUP:\r\nbfa_sm_set_state(ln, bfa_fcport_ln_sm_up_nf);\r\nbfa_fcport_queue_cb(ln, BFA_PORT_LINKUP);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(ln->fcport->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcport_ln_sm_dn_nf(struct bfa_fcport_ln_s *ln,\r\nenum bfa_fcport_ln_sm_event event)\r\n{\r\nbfa_trc(ln->fcport->bfa, event);\r\nswitch (event) {\r\ncase BFA_FCPORT_LN_SM_LINKUP:\r\nbfa_sm_set_state(ln, bfa_fcport_ln_sm_dn_up_nf);\r\nbreak;\r\ncase BFA_FCPORT_LN_SM_NOTIFICATION:\r\nbfa_sm_set_state(ln, bfa_fcport_ln_sm_dn);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(ln->fcport->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcport_ln_sm_dn_up_nf(struct bfa_fcport_ln_s *ln,\r\nenum bfa_fcport_ln_sm_event event)\r\n{\r\nbfa_trc(ln->fcport->bfa, event);\r\nswitch (event) {\r\ncase BFA_FCPORT_LN_SM_LINKDOWN:\r\nbfa_sm_set_state(ln, bfa_fcport_ln_sm_dn_nf);\r\nbreak;\r\ncase BFA_FCPORT_LN_SM_NOTIFICATION:\r\nbfa_sm_set_state(ln, bfa_fcport_ln_sm_up_nf);\r\nbfa_fcport_queue_cb(ln, BFA_PORT_LINKUP);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(ln->fcport->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcport_ln_sm_up(struct bfa_fcport_ln_s *ln,\r\nenum bfa_fcport_ln_sm_event event)\r\n{\r\nbfa_trc(ln->fcport->bfa, event);\r\nswitch (event) {\r\ncase BFA_FCPORT_LN_SM_LINKDOWN:\r\nbfa_sm_set_state(ln, bfa_fcport_ln_sm_dn_nf);\r\nbfa_fcport_queue_cb(ln, BFA_PORT_LINKDOWN);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(ln->fcport->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcport_ln_sm_up_nf(struct bfa_fcport_ln_s *ln,\r\nenum bfa_fcport_ln_sm_event event)\r\n{\r\nbfa_trc(ln->fcport->bfa, event);\r\nswitch (event) {\r\ncase BFA_FCPORT_LN_SM_LINKDOWN:\r\nbfa_sm_set_state(ln, bfa_fcport_ln_sm_up_dn_nf);\r\nbreak;\r\ncase BFA_FCPORT_LN_SM_NOTIFICATION:\r\nbfa_sm_set_state(ln, bfa_fcport_ln_sm_up);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(ln->fcport->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcport_ln_sm_up_dn_nf(struct bfa_fcport_ln_s *ln,\r\nenum bfa_fcport_ln_sm_event event)\r\n{\r\nbfa_trc(ln->fcport->bfa, event);\r\nswitch (event) {\r\ncase BFA_FCPORT_LN_SM_LINKUP:\r\nbfa_sm_set_state(ln, bfa_fcport_ln_sm_up_dn_up_nf);\r\nbreak;\r\ncase BFA_FCPORT_LN_SM_NOTIFICATION:\r\nbfa_sm_set_state(ln, bfa_fcport_ln_sm_dn_nf);\r\nbfa_fcport_queue_cb(ln, BFA_PORT_LINKDOWN);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(ln->fcport->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcport_ln_sm_up_dn_up_nf(struct bfa_fcport_ln_s *ln,\r\nenum bfa_fcport_ln_sm_event event)\r\n{\r\nbfa_trc(ln->fcport->bfa, event);\r\nswitch (event) {\r\ncase BFA_FCPORT_LN_SM_LINKDOWN:\r\nbfa_sm_set_state(ln, bfa_fcport_ln_sm_up_dn_nf);\r\nbreak;\r\ncase BFA_FCPORT_LN_SM_NOTIFICATION:\r\nbfa_sm_set_state(ln, bfa_fcport_ln_sm_dn_up_nf);\r\nbfa_fcport_queue_cb(ln, BFA_PORT_LINKDOWN);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(ln->fcport->bfa, event);\r\n}\r\n}\r\nstatic void\r\n__bfa_cb_fcport_event(void *cbarg, bfa_boolean_t complete)\r\n{\r\nstruct bfa_fcport_ln_s *ln = cbarg;\r\nif (complete)\r\nln->fcport->event_cbfn(ln->fcport->event_cbarg, ln->ln_event);\r\nelse\r\nbfa_sm_send_event(ln, BFA_FCPORT_LN_SM_NOTIFICATION);\r\n}\r\nstatic void\r\nbfa_fcport_scn(struct bfa_fcport_s *fcport, enum bfa_port_linkstate event,\r\nbfa_boolean_t trunk)\r\n{\r\nif (fcport->cfg.trunked && !trunk)\r\nreturn;\r\nswitch (event) {\r\ncase BFA_PORT_LINKUP:\r\nbfa_sm_send_event(&fcport->ln, BFA_FCPORT_LN_SM_LINKUP);\r\nbreak;\r\ncase BFA_PORT_LINKDOWN:\r\nbfa_sm_send_event(&fcport->ln, BFA_FCPORT_LN_SM_LINKDOWN);\r\nbreak;\r\ndefault:\r\nWARN_ON(1);\r\n}\r\n}\r\nstatic void\r\nbfa_fcport_queue_cb(struct bfa_fcport_ln_s *ln, enum bfa_port_linkstate event)\r\n{\r\nstruct bfa_fcport_s *fcport = ln->fcport;\r\nif (fcport->bfa->fcs) {\r\nfcport->event_cbfn(fcport->event_cbarg, event);\r\nbfa_sm_send_event(ln, BFA_FCPORT_LN_SM_NOTIFICATION);\r\n} else {\r\nln->ln_event = event;\r\nbfa_cb_queue(fcport->bfa, &ln->ln_qe,\r\n__bfa_cb_fcport_event, ln);\r\n}\r\n}\r\nstatic void\r\nbfa_fcport_meminfo(struct bfa_iocfc_cfg_s *cfg, struct bfa_meminfo_s *minfo,\r\nstruct bfa_s *bfa)\r\n{\r\nstruct bfa_mem_dma_s *fcport_dma = BFA_MEM_FCPORT_DMA(bfa);\r\nbfa_mem_dma_setup(minfo, fcport_dma, FCPORT_STATS_DMA_SZ);\r\n}\r\nstatic void\r\nbfa_fcport_qresume(void *cbarg)\r\n{\r\nstruct bfa_fcport_s *fcport = cbarg;\r\nbfa_sm_send_event(fcport, BFA_FCPORT_SM_QRESUME);\r\n}\r\nstatic void\r\nbfa_fcport_mem_claim(struct bfa_fcport_s *fcport)\r\n{\r\nstruct bfa_mem_dma_s *fcport_dma = &fcport->fcport_dma;\r\nfcport->stats_kva = bfa_mem_dma_virt(fcport_dma);\r\nfcport->stats_pa = bfa_mem_dma_phys(fcport_dma);\r\nfcport->stats = (union bfa_fcport_stats_u *)\r\nbfa_mem_dma_virt(fcport_dma);\r\n}\r\nstatic void\r\nbfa_fcport_attach(struct bfa_s *bfa, void *bfad, struct bfa_iocfc_cfg_s *cfg,\r\nstruct bfa_pcidev_s *pcidev)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nstruct bfa_port_cfg_s *port_cfg = &fcport->cfg;\r\nstruct bfa_fcport_ln_s *ln = &fcport->ln;\r\nstruct timeval tv;\r\nfcport->bfa = bfa;\r\nln->fcport = fcport;\r\nbfa_fcport_mem_claim(fcport);\r\nbfa_sm_set_state(fcport, bfa_fcport_sm_uninit);\r\nbfa_sm_set_state(ln, bfa_fcport_ln_sm_dn);\r\ndo_gettimeofday(&tv);\r\nfcport->stats_reset_time = tv.tv_sec;\r\nfcport->stats_dma_ready = BFA_FALSE;\r\nport_cfg->topology = BFA_PORT_TOPOLOGY_P2P;\r\nport_cfg->speed = BFA_PORT_SPEED_AUTO;\r\nport_cfg->trunked = BFA_FALSE;\r\nport_cfg->maxfrsize = 0;\r\nport_cfg->trl_def_speed = BFA_PORT_SPEED_1GBPS;\r\nport_cfg->qos_bw.high = BFA_QOS_BW_HIGH;\r\nport_cfg->qos_bw.med = BFA_QOS_BW_MED;\r\nport_cfg->qos_bw.low = BFA_QOS_BW_LOW;\r\nfcport->fec_state = BFA_FEC_OFFLINE;\r\nINIT_LIST_HEAD(&fcport->stats_pending_q);\r\nINIT_LIST_HEAD(&fcport->statsclr_pending_q);\r\nbfa_reqq_winit(&fcport->reqq_wait, bfa_fcport_qresume, fcport);\r\n}\r\nstatic void\r\nbfa_fcport_detach(struct bfa_s *bfa)\r\n{\r\n}\r\nstatic void\r\nbfa_fcport_start(struct bfa_s *bfa)\r\n{\r\nbfa_sm_send_event(BFA_FCPORT_MOD(bfa), BFA_FCPORT_SM_START);\r\n}\r\nstatic void\r\nbfa_fcport_stop(struct bfa_s *bfa)\r\n{\r\nbfa_sm_send_event(BFA_FCPORT_MOD(bfa), BFA_FCPORT_SM_STOP);\r\nbfa_trunk_iocdisable(bfa);\r\n}\r\nstatic void\r\nbfa_fcport_iocdisable(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nbfa_sm_send_event(fcport, BFA_FCPORT_SM_HWFAIL);\r\nbfa_trunk_iocdisable(bfa);\r\n}\r\nstatic void\r\nbfa_fcport_update_loop_info(struct bfa_fcport_s *fcport,\r\nstruct bfa_fcport_loop_info_s *loop_info)\r\n{\r\nfcport->myalpa = loop_info->myalpa;\r\nfcport->alpabm_valid =\r\nloop_info->alpabm_val;\r\nmemcpy(fcport->alpabm.alpa_bm,\r\nloop_info->alpabm.alpa_bm,\r\nsizeof(struct fc_alpabm_s));\r\n}\r\nstatic void\r\nbfa_fcport_update_linkinfo(struct bfa_fcport_s *fcport)\r\n{\r\nstruct bfi_fcport_event_s *pevent = fcport->event_arg.i2hmsg.event;\r\nstruct bfa_fcport_trunk_s *trunk = &fcport->trunk;\r\nfcport->speed = pevent->link_state.speed;\r\nfcport->topology = pevent->link_state.topology;\r\nif (fcport->topology == BFA_PORT_TOPOLOGY_LOOP) {\r\nbfa_fcport_update_loop_info(fcport,\r\n&pevent->link_state.attr.loop_info);\r\nreturn;\r\n}\r\nfcport->qos_attr = pevent->link_state.qos_attr;\r\nfcport->qos_vc_attr = pevent->link_state.attr.vc_fcf.qos_vc_attr;\r\nif (fcport->cfg.bb_cr_enabled)\r\nfcport->bbcr_attr = pevent->link_state.attr.bbcr_attr;\r\nfcport->fec_state = pevent->link_state.fec_state;\r\nif (!fcport->cfg.trunked)\r\ntrunk->attr.state = BFA_TRUNK_DISABLED;\r\nfcport->fcoe_vlan =\r\nbe16_to_cpu(pevent->link_state.attr.vc_fcf.fcf.vlan);\r\nbfa_trc(fcport->bfa, fcport->speed);\r\nbfa_trc(fcport->bfa, fcport->topology);\r\n}\r\nstatic void\r\nbfa_fcport_reset_linkinfo(struct bfa_fcport_s *fcport)\r\n{\r\nfcport->speed = BFA_PORT_SPEED_UNKNOWN;\r\nfcport->topology = BFA_PORT_TOPOLOGY_NONE;\r\nfcport->fec_state = BFA_FEC_OFFLINE;\r\n}\r\nstatic bfa_boolean_t\r\nbfa_fcport_send_enable(struct bfa_fcport_s *fcport)\r\n{\r\nstruct bfi_fcport_enable_req_s *m;\r\nfcport->msgtag++;\r\nm = bfa_reqq_next(fcport->bfa, BFA_REQQ_PORT);\r\nif (!m) {\r\nbfa_reqq_wait(fcport->bfa, BFA_REQQ_PORT,\r\n&fcport->reqq_wait);\r\nreturn BFA_FALSE;\r\n}\r\nbfi_h2i_set(m->mh, BFI_MC_FCPORT, BFI_FCPORT_H2I_ENABLE_REQ,\r\nbfa_fn_lpu(fcport->bfa));\r\nm->nwwn = fcport->nwwn;\r\nm->pwwn = fcport->pwwn;\r\nm->port_cfg = fcport->cfg;\r\nm->msgtag = fcport->msgtag;\r\nm->port_cfg.maxfrsize = cpu_to_be16(fcport->cfg.maxfrsize);\r\nm->use_flash_cfg = fcport->use_flash_cfg;\r\nbfa_dma_be_addr_set(m->stats_dma_addr, fcport->stats_pa);\r\nbfa_trc(fcport->bfa, m->stats_dma_addr.a32.addr_lo);\r\nbfa_trc(fcport->bfa, m->stats_dma_addr.a32.addr_hi);\r\nbfa_reqq_produce(fcport->bfa, BFA_REQQ_PORT, m->mh);\r\nreturn BFA_TRUE;\r\n}\r\nstatic bfa_boolean_t\r\nbfa_fcport_send_disable(struct bfa_fcport_s *fcport)\r\n{\r\nstruct bfi_fcport_req_s *m;\r\nfcport->msgtag++;\r\nm = bfa_reqq_next(fcport->bfa, BFA_REQQ_PORT);\r\nif (!m) {\r\nbfa_reqq_wait(fcport->bfa, BFA_REQQ_PORT,\r\n&fcport->reqq_wait);\r\nreturn BFA_FALSE;\r\n}\r\nbfi_h2i_set(m->mh, BFI_MC_FCPORT, BFI_FCPORT_H2I_DISABLE_REQ,\r\nbfa_fn_lpu(fcport->bfa));\r\nm->msgtag = fcport->msgtag;\r\nbfa_reqq_produce(fcport->bfa, BFA_REQQ_PORT, m->mh);\r\nreturn BFA_TRUE;\r\n}\r\nstatic void\r\nbfa_fcport_set_wwns(struct bfa_fcport_s *fcport)\r\n{\r\nfcport->pwwn = fcport->bfa->ioc.attr->pwwn;\r\nfcport->nwwn = fcport->bfa->ioc.attr->nwwn;\r\nbfa_trc(fcport->bfa, fcport->pwwn);\r\nbfa_trc(fcport->bfa, fcport->nwwn);\r\n}\r\nstatic void\r\nbfa_fcport_qos_stats_swap(struct bfa_qos_stats_s *d,\r\nstruct bfa_qos_stats_s *s)\r\n{\r\nu32 *dip = (u32 *) d;\r\n__be32 *sip = (__be32 *) s;\r\nint i;\r\nfor (i = 0; i < (sizeof(struct bfa_qos_stats_s)/sizeof(u32)); ++i)\r\ndip[i] = be32_to_cpu(sip[i]);\r\n}\r\nstatic void\r\nbfa_fcport_fcoe_stats_swap(struct bfa_fcoe_stats_s *d,\r\nstruct bfa_fcoe_stats_s *s)\r\n{\r\nu32 *dip = (u32 *) d;\r\n__be32 *sip = (__be32 *) s;\r\nint i;\r\nfor (i = 0; i < ((sizeof(struct bfa_fcoe_stats_s))/sizeof(u32));\r\ni = i + 2) {\r\n#ifdef __BIG_ENDIAN\r\ndip[i] = be32_to_cpu(sip[i]);\r\ndip[i + 1] = be32_to_cpu(sip[i + 1]);\r\n#else\r\ndip[i] = be32_to_cpu(sip[i + 1]);\r\ndip[i + 1] = be32_to_cpu(sip[i]);\r\n#endif\r\n}\r\n}\r\nstatic void\r\n__bfa_cb_fcport_stats_get(void *cbarg, bfa_boolean_t complete)\r\n{\r\nstruct bfa_fcport_s *fcport = (struct bfa_fcport_s *)cbarg;\r\nstruct bfa_cb_pending_q_s *cb;\r\nstruct list_head *qe, *qen;\r\nunion bfa_fcport_stats_u *ret;\r\nif (complete) {\r\nstruct timeval tv;\r\nif (fcport->stats_status == BFA_STATUS_OK)\r\ndo_gettimeofday(&tv);\r\nlist_for_each_safe(qe, qen, &fcport->stats_pending_q) {\r\nbfa_q_deq(&fcport->stats_pending_q, &qe);\r\ncb = (struct bfa_cb_pending_q_s *)qe;\r\nif (fcport->stats_status == BFA_STATUS_OK) {\r\nret = (union bfa_fcport_stats_u *)cb->data;\r\nif (bfa_ioc_get_fcmode(&fcport->bfa->ioc))\r\nbfa_fcport_qos_stats_swap(&ret->fcqos,\r\n&fcport->stats->fcqos);\r\nelse {\r\nbfa_fcport_fcoe_stats_swap(&ret->fcoe,\r\n&fcport->stats->fcoe);\r\nret->fcoe.secs_reset =\r\ntv.tv_sec - fcport->stats_reset_time;\r\n}\r\n}\r\nbfa_cb_queue_status(fcport->bfa, &cb->hcb_qe,\r\nfcport->stats_status);\r\n}\r\nfcport->stats_status = BFA_STATUS_OK;\r\n} else {\r\nINIT_LIST_HEAD(&fcport->stats_pending_q);\r\nfcport->stats_status = BFA_STATUS_OK;\r\n}\r\n}\r\nstatic void\r\nbfa_fcport_stats_get_timeout(void *cbarg)\r\n{\r\nstruct bfa_fcport_s *fcport = (struct bfa_fcport_s *) cbarg;\r\nbfa_trc(fcport->bfa, fcport->stats_qfull);\r\nif (fcport->stats_qfull) {\r\nbfa_reqq_wcancel(&fcport->stats_reqq_wait);\r\nfcport->stats_qfull = BFA_FALSE;\r\n}\r\nfcport->stats_status = BFA_STATUS_ETIMER;\r\n__bfa_cb_fcport_stats_get(fcport, BFA_TRUE);\r\n}\r\nstatic void\r\nbfa_fcport_send_stats_get(void *cbarg)\r\n{\r\nstruct bfa_fcport_s *fcport = (struct bfa_fcport_s *) cbarg;\r\nstruct bfi_fcport_req_s *msg;\r\nmsg = bfa_reqq_next(fcport->bfa, BFA_REQQ_PORT);\r\nif (!msg) {\r\nfcport->stats_qfull = BFA_TRUE;\r\nbfa_reqq_winit(&fcport->stats_reqq_wait,\r\nbfa_fcport_send_stats_get, fcport);\r\nbfa_reqq_wait(fcport->bfa, BFA_REQQ_PORT,\r\n&fcport->stats_reqq_wait);\r\nreturn;\r\n}\r\nfcport->stats_qfull = BFA_FALSE;\r\nmemset(msg, 0, sizeof(struct bfi_fcport_req_s));\r\nbfi_h2i_set(msg->mh, BFI_MC_FCPORT, BFI_FCPORT_H2I_STATS_GET_REQ,\r\nbfa_fn_lpu(fcport->bfa));\r\nbfa_reqq_produce(fcport->bfa, BFA_REQQ_PORT, msg->mh);\r\n}\r\nstatic void\r\n__bfa_cb_fcport_stats_clr(void *cbarg, bfa_boolean_t complete)\r\n{\r\nstruct bfa_fcport_s *fcport = (struct bfa_fcport_s *) cbarg;\r\nstruct bfa_cb_pending_q_s *cb;\r\nstruct list_head *qe, *qen;\r\nif (complete) {\r\nstruct timeval tv;\r\ndo_gettimeofday(&tv);\r\nfcport->stats_reset_time = tv.tv_sec;\r\nlist_for_each_safe(qe, qen, &fcport->statsclr_pending_q) {\r\nbfa_q_deq(&fcport->statsclr_pending_q, &qe);\r\ncb = (struct bfa_cb_pending_q_s *)qe;\r\nbfa_cb_queue_status(fcport->bfa, &cb->hcb_qe,\r\nfcport->stats_status);\r\n}\r\nfcport->stats_status = BFA_STATUS_OK;\r\n} else {\r\nINIT_LIST_HEAD(&fcport->statsclr_pending_q);\r\nfcport->stats_status = BFA_STATUS_OK;\r\n}\r\n}\r\nstatic void\r\nbfa_fcport_stats_clr_timeout(void *cbarg)\r\n{\r\nstruct bfa_fcport_s *fcport = (struct bfa_fcport_s *) cbarg;\r\nbfa_trc(fcport->bfa, fcport->stats_qfull);\r\nif (fcport->stats_qfull) {\r\nbfa_reqq_wcancel(&fcport->stats_reqq_wait);\r\nfcport->stats_qfull = BFA_FALSE;\r\n}\r\nfcport->stats_status = BFA_STATUS_ETIMER;\r\n__bfa_cb_fcport_stats_clr(fcport, BFA_TRUE);\r\n}\r\nstatic void\r\nbfa_fcport_send_stats_clear(void *cbarg)\r\n{\r\nstruct bfa_fcport_s *fcport = (struct bfa_fcport_s *) cbarg;\r\nstruct bfi_fcport_req_s *msg;\r\nmsg = bfa_reqq_next(fcport->bfa, BFA_REQQ_PORT);\r\nif (!msg) {\r\nfcport->stats_qfull = BFA_TRUE;\r\nbfa_reqq_winit(&fcport->stats_reqq_wait,\r\nbfa_fcport_send_stats_clear, fcport);\r\nbfa_reqq_wait(fcport->bfa, BFA_REQQ_PORT,\r\n&fcport->stats_reqq_wait);\r\nreturn;\r\n}\r\nfcport->stats_qfull = BFA_FALSE;\r\nmemset(msg, 0, sizeof(struct bfi_fcport_req_s));\r\nbfi_h2i_set(msg->mh, BFI_MC_FCPORT, BFI_FCPORT_H2I_STATS_CLEAR_REQ,\r\nbfa_fn_lpu(fcport->bfa));\r\nbfa_reqq_produce(fcport->bfa, BFA_REQQ_PORT, msg->mh);\r\n}\r\nstatic void\r\nbfa_trunk_scn(struct bfa_fcport_s *fcport, struct bfi_fcport_trunk_scn_s *scn)\r\n{\r\nstruct bfa_fcport_trunk_s *trunk = &fcport->trunk;\r\nstruct bfi_fcport_trunk_link_s *tlink;\r\nstruct bfa_trunk_link_attr_s *lattr;\r\nenum bfa_trunk_state state_prev;\r\nint i;\r\nint link_bm = 0;\r\nbfa_trc(fcport->bfa, fcport->cfg.trunked);\r\nWARN_ON(scn->trunk_state != BFA_TRUNK_ONLINE &&\r\nscn->trunk_state != BFA_TRUNK_OFFLINE);\r\nbfa_trc(fcport->bfa, trunk->attr.state);\r\nbfa_trc(fcport->bfa, scn->trunk_state);\r\nbfa_trc(fcport->bfa, scn->trunk_speed);\r\nstate_prev = trunk->attr.state;\r\nif (fcport->cfg.trunked && (trunk->attr.state != BFA_TRUNK_DISABLED))\r\ntrunk->attr.state = scn->trunk_state;\r\ntrunk->attr.speed = scn->trunk_speed;\r\nfor (i = 0; i < BFA_TRUNK_MAX_PORTS; i++) {\r\nlattr = &trunk->attr.link_attr[i];\r\ntlink = &scn->tlink[i];\r\nlattr->link_state = tlink->state;\r\nlattr->trunk_wwn = tlink->trunk_wwn;\r\nlattr->fctl = tlink->fctl;\r\nlattr->speed = tlink->speed;\r\nlattr->deskew = be32_to_cpu(tlink->deskew);\r\nif (tlink->state == BFA_TRUNK_LINK_STATE_UP) {\r\nfcport->speed = tlink->speed;\r\nfcport->topology = BFA_PORT_TOPOLOGY_P2P;\r\nlink_bm |= 1 << i;\r\n}\r\nbfa_trc(fcport->bfa, lattr->link_state);\r\nbfa_trc(fcport->bfa, lattr->trunk_wwn);\r\nbfa_trc(fcport->bfa, lattr->fctl);\r\nbfa_trc(fcport->bfa, lattr->speed);\r\nbfa_trc(fcport->bfa, lattr->deskew);\r\n}\r\nswitch (link_bm) {\r\ncase 3:\r\nbfa_plog_str(fcport->bfa->plog, BFA_PL_MID_HAL,\r\nBFA_PL_EID_TRUNK_SCN, 0, "Trunk up(0,1)");\r\nbreak;\r\ncase 2:\r\nbfa_plog_str(fcport->bfa->plog, BFA_PL_MID_HAL,\r\nBFA_PL_EID_TRUNK_SCN, 0, "Trunk up(-,1)");\r\nbreak;\r\ncase 1:\r\nbfa_plog_str(fcport->bfa->plog, BFA_PL_MID_HAL,\r\nBFA_PL_EID_TRUNK_SCN, 0, "Trunk up(0,-)");\r\nbreak;\r\ndefault:\r\nbfa_plog_str(fcport->bfa->plog, BFA_PL_MID_HAL,\r\nBFA_PL_EID_TRUNK_SCN, 0, "Trunk down");\r\n}\r\nif ((state_prev != trunk->attr.state) ||\r\n(scn->trunk_state == BFA_TRUNK_OFFLINE)) {\r\nbfa_fcport_scn(fcport, (scn->trunk_state == BFA_TRUNK_ONLINE) ?\r\nBFA_PORT_LINKUP : BFA_PORT_LINKDOWN, BFA_TRUE);\r\n}\r\n}\r\nstatic void\r\nbfa_trunk_iocdisable(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nint i = 0;\r\nif (fcport->cfg.trunked) {\r\nif (fcport->trunk.attr.state == BFA_TRUNK_ONLINE)\r\nbfa_fcport_scn(fcport, BFA_PORT_LINKDOWN, BFA_TRUE);\r\nfcport->trunk.attr.state = BFA_TRUNK_OFFLINE;\r\nfcport->trunk.attr.speed = BFA_PORT_SPEED_UNKNOWN;\r\nfor (i = 0; i < BFA_TRUNK_MAX_PORTS; i++) {\r\nfcport->trunk.attr.link_attr[i].trunk_wwn = 0;\r\nfcport->trunk.attr.link_attr[i].fctl =\r\nBFA_TRUNK_LINK_FCTL_NORMAL;\r\nfcport->trunk.attr.link_attr[i].link_state =\r\nBFA_TRUNK_LINK_STATE_DN_LINKDN;\r\nfcport->trunk.attr.link_attr[i].speed =\r\nBFA_PORT_SPEED_UNKNOWN;\r\nfcport->trunk.attr.link_attr[i].deskew = 0;\r\n}\r\n}\r\n}\r\nvoid\r\nbfa_fcport_init(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nbfa_fcport_set_wwns(fcport);\r\nif (fcport->cfg.maxfrsize == 0)\r\nfcport->cfg.maxfrsize = bfa_ioc_maxfrsize(&bfa->ioc);\r\nfcport->cfg.rx_bbcredit = bfa_ioc_rx_bbcredit(&bfa->ioc);\r\nfcport->speed_sup = bfa_ioc_speed_sup(&bfa->ioc);\r\nif (bfa_fcport_is_pbcdisabled(bfa))\r\nbfa->modules.port.pbc_disabled = BFA_TRUE;\r\nWARN_ON(!fcport->cfg.maxfrsize);\r\nWARN_ON(!fcport->cfg.rx_bbcredit);\r\nWARN_ON(!fcport->speed_sup);\r\n}\r\nvoid\r\nbfa_fcport_isr(struct bfa_s *bfa, struct bfi_msg_s *msg)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nunion bfi_fcport_i2h_msg_u i2hmsg;\r\ni2hmsg.msg = msg;\r\nfcport->event_arg.i2hmsg = i2hmsg;\r\nbfa_trc(bfa, msg->mhdr.msg_id);\r\nbfa_trc(bfa, bfa_sm_to_state(hal_port_sm_table, fcport->sm));\r\nswitch (msg->mhdr.msg_id) {\r\ncase BFI_FCPORT_I2H_ENABLE_RSP:\r\nif (fcport->msgtag == i2hmsg.penable_rsp->msgtag) {\r\nfcport->stats_dma_ready = BFA_TRUE;\r\nif (fcport->use_flash_cfg) {\r\nfcport->cfg = i2hmsg.penable_rsp->port_cfg;\r\nfcport->cfg.maxfrsize =\r\ncpu_to_be16(fcport->cfg.maxfrsize);\r\nfcport->cfg.path_tov =\r\ncpu_to_be16(fcport->cfg.path_tov);\r\nfcport->cfg.q_depth =\r\ncpu_to_be16(fcport->cfg.q_depth);\r\nif (fcport->cfg.trunked)\r\nfcport->trunk.attr.state =\r\nBFA_TRUNK_OFFLINE;\r\nelse\r\nfcport->trunk.attr.state =\r\nBFA_TRUNK_DISABLED;\r\nfcport->qos_attr.qos_bw =\r\ni2hmsg.penable_rsp->port_cfg.qos_bw;\r\nfcport->use_flash_cfg = BFA_FALSE;\r\n}\r\nif (fcport->cfg.qos_enabled)\r\nfcport->qos_attr.state = BFA_QOS_OFFLINE;\r\nelse\r\nfcport->qos_attr.state = BFA_QOS_DISABLED;\r\nfcport->qos_attr.qos_bw_op =\r\ni2hmsg.penable_rsp->port_cfg.qos_bw;\r\nif (fcport->cfg.bb_cr_enabled)\r\nfcport->bbcr_attr.state = BFA_BBCR_OFFLINE;\r\nelse\r\nfcport->bbcr_attr.state = BFA_BBCR_DISABLED;\r\nbfa_sm_send_event(fcport, BFA_FCPORT_SM_FWRSP);\r\n}\r\nbreak;\r\ncase BFI_FCPORT_I2H_DISABLE_RSP:\r\nif (fcport->msgtag == i2hmsg.penable_rsp->msgtag)\r\nbfa_sm_send_event(fcport, BFA_FCPORT_SM_FWRSP);\r\nbreak;\r\ncase BFI_FCPORT_I2H_EVENT:\r\nif (fcport->cfg.bb_cr_enabled)\r\nfcport->bbcr_attr.state = BFA_BBCR_OFFLINE;\r\nelse\r\nfcport->bbcr_attr.state = BFA_BBCR_DISABLED;\r\nif (i2hmsg.event->link_state.linkstate == BFA_PORT_LINKUP)\r\nbfa_sm_send_event(fcport, BFA_FCPORT_SM_LINKUP);\r\nelse {\r\nif (i2hmsg.event->link_state.linkstate_rsn ==\r\nBFA_PORT_LINKSTATE_RSN_FAA_MISCONFIG)\r\nbfa_sm_send_event(fcport,\r\nBFA_FCPORT_SM_FAA_MISCONFIG);\r\nelse\r\nbfa_sm_send_event(fcport,\r\nBFA_FCPORT_SM_LINKDOWN);\r\n}\r\nfcport->qos_attr.qos_bw_op =\r\ni2hmsg.event->link_state.qos_attr.qos_bw_op;\r\nbreak;\r\ncase BFI_FCPORT_I2H_TRUNK_SCN:\r\nbfa_trunk_scn(fcport, i2hmsg.trunk_scn);\r\nbreak;\r\ncase BFI_FCPORT_I2H_STATS_GET_RSP:\r\nif (list_empty(&fcport->stats_pending_q) ||\r\n(fcport->stats_status == BFA_STATUS_ETIMER))\r\nbreak;\r\nbfa_timer_stop(&fcport->timer);\r\nfcport->stats_status = i2hmsg.pstatsget_rsp->status;\r\n__bfa_cb_fcport_stats_get(fcport, BFA_TRUE);\r\nbreak;\r\ncase BFI_FCPORT_I2H_STATS_CLEAR_RSP:\r\nif (list_empty(&fcport->statsclr_pending_q) ||\r\n(fcport->stats_status == BFA_STATUS_ETIMER))\r\nbreak;\r\nbfa_timer_stop(&fcport->timer);\r\nfcport->stats_status = BFA_STATUS_OK;\r\n__bfa_cb_fcport_stats_clr(fcport, BFA_TRUE);\r\nbreak;\r\ncase BFI_FCPORT_I2H_ENABLE_AEN:\r\nbfa_sm_send_event(fcport, BFA_FCPORT_SM_ENABLE);\r\nbreak;\r\ncase BFI_FCPORT_I2H_DISABLE_AEN:\r\nbfa_sm_send_event(fcport, BFA_FCPORT_SM_DISABLE);\r\nbreak;\r\ndefault:\r\nWARN_ON(1);\r\nbreak;\r\n}\r\n}\r\nvoid\r\nbfa_fcport_event_register(struct bfa_s *bfa,\r\nvoid (*cbfn) (void *cbarg,\r\nenum bfa_port_linkstate event),\r\nvoid *cbarg)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nfcport->event_cbfn = cbfn;\r\nfcport->event_cbarg = cbarg;\r\n}\r\nbfa_status_t\r\nbfa_fcport_enable(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nif (bfa_fcport_is_pbcdisabled(bfa))\r\nreturn BFA_STATUS_PBC;\r\nif (bfa_ioc_is_disabled(&bfa->ioc))\r\nreturn BFA_STATUS_IOC_DISABLED;\r\nif (fcport->diag_busy)\r\nreturn BFA_STATUS_DIAG_BUSY;\r\nbfa_sm_send_event(BFA_FCPORT_MOD(bfa), BFA_FCPORT_SM_ENABLE);\r\nreturn BFA_STATUS_OK;\r\n}\r\nbfa_status_t\r\nbfa_fcport_disable(struct bfa_s *bfa)\r\n{\r\nif (bfa_fcport_is_pbcdisabled(bfa))\r\nreturn BFA_STATUS_PBC;\r\nif (bfa_ioc_is_disabled(&bfa->ioc))\r\nreturn BFA_STATUS_IOC_DISABLED;\r\nbfa_sm_send_event(BFA_FCPORT_MOD(bfa), BFA_FCPORT_SM_DISABLE);\r\nreturn BFA_STATUS_OK;\r\n}\r\nbfa_status_t\r\nbfa_fcport_is_pbcdisabled(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nstruct bfa_iocfc_s *iocfc = &bfa->iocfc;\r\nstruct bfi_iocfc_cfgrsp_s *cfgrsp = iocfc->cfgrsp;\r\nif (cfgrsp->pbc_cfg.port_enabled == BFI_PBC_PORT_DISABLED) {\r\nbfa_trc(bfa, fcport->pwwn);\r\nreturn BFA_STATUS_PBC;\r\n}\r\nreturn BFA_STATUS_OK;\r\n}\r\nbfa_status_t\r\nbfa_fcport_cfg_speed(struct bfa_s *bfa, enum bfa_port_speed speed)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nbfa_trc(bfa, speed);\r\nif (fcport->cfg.trunked == BFA_TRUE)\r\nreturn BFA_STATUS_TRUNK_ENABLED;\r\nif ((fcport->cfg.topology == BFA_PORT_TOPOLOGY_LOOP) &&\r\n(speed == BFA_PORT_SPEED_16GBPS))\r\nreturn BFA_STATUS_UNSUPP_SPEED;\r\nif ((speed != BFA_PORT_SPEED_AUTO) && (speed > fcport->speed_sup)) {\r\nbfa_trc(bfa, fcport->speed_sup);\r\nreturn BFA_STATUS_UNSUPP_SPEED;\r\n}\r\nif (bfa_ioc_get_type(&fcport->bfa->ioc) == BFA_IOC_TYPE_FC) {\r\nif ((speed == BFA_PORT_SPEED_1GBPS) &&\r\n(bfa_asic_id_ct2(bfa->ioc.pcidev.device_id)))\r\nreturn BFA_STATUS_UNSUPP_SPEED;\r\nif (!(speed == BFA_PORT_SPEED_1GBPS ||\r\nspeed == BFA_PORT_SPEED_2GBPS ||\r\nspeed == BFA_PORT_SPEED_4GBPS ||\r\nspeed == BFA_PORT_SPEED_8GBPS ||\r\nspeed == BFA_PORT_SPEED_16GBPS ||\r\nspeed == BFA_PORT_SPEED_AUTO))\r\nreturn BFA_STATUS_UNSUPP_SPEED;\r\n} else {\r\nif (speed != BFA_PORT_SPEED_10GBPS)\r\nreturn BFA_STATUS_UNSUPP_SPEED;\r\n}\r\nfcport->cfg.speed = speed;\r\nreturn BFA_STATUS_OK;\r\n}\r\nenum bfa_port_speed\r\nbfa_fcport_get_speed(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nreturn fcport->speed;\r\n}\r\nbfa_status_t\r\nbfa_fcport_cfg_topology(struct bfa_s *bfa, enum bfa_port_topology topology)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nbfa_trc(bfa, topology);\r\nbfa_trc(bfa, fcport->cfg.topology);\r\nswitch (topology) {\r\ncase BFA_PORT_TOPOLOGY_P2P:\r\nbreak;\r\ncase BFA_PORT_TOPOLOGY_LOOP:\r\nif ((bfa_fcport_is_qos_enabled(bfa) != BFA_FALSE) ||\r\n(fcport->qos_attr.state != BFA_QOS_DISABLED))\r\nreturn BFA_STATUS_ERROR_QOS_ENABLED;\r\nif (fcport->cfg.ratelimit != BFA_FALSE)\r\nreturn BFA_STATUS_ERROR_TRL_ENABLED;\r\nif ((bfa_fcport_is_trunk_enabled(bfa) != BFA_FALSE) ||\r\n(fcport->trunk.attr.state != BFA_TRUNK_DISABLED))\r\nreturn BFA_STATUS_ERROR_TRUNK_ENABLED;\r\nif ((bfa_fcport_get_speed(bfa) == BFA_PORT_SPEED_16GBPS) ||\r\n(fcport->cfg.speed == BFA_PORT_SPEED_16GBPS))\r\nreturn BFA_STATUS_UNSUPP_SPEED;\r\nif (bfa_mfg_is_mezz(bfa->ioc.attr->card_type))\r\nreturn BFA_STATUS_LOOP_UNSUPP_MEZZ;\r\nif (bfa_fcport_is_dport(bfa) != BFA_FALSE)\r\nreturn BFA_STATUS_DPORT_ERR;\r\nif (bfa_fcport_is_ddport(bfa) != BFA_FALSE)\r\nreturn BFA_STATUS_DPORT_ERR;\r\nbreak;\r\ncase BFA_PORT_TOPOLOGY_AUTO:\r\nbreak;\r\ndefault:\r\nreturn BFA_STATUS_EINVAL;\r\n}\r\nfcport->cfg.topology = topology;\r\nreturn BFA_STATUS_OK;\r\n}\r\nenum bfa_port_topology\r\nbfa_fcport_get_topology(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nreturn fcport->topology;\r\n}\r\nenum bfa_port_topology\r\nbfa_fcport_get_cfg_topology(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nreturn fcport->cfg.topology;\r\n}\r\nbfa_status_t\r\nbfa_fcport_cfg_hardalpa(struct bfa_s *bfa, u8 alpa)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nbfa_trc(bfa, alpa);\r\nbfa_trc(bfa, fcport->cfg.cfg_hardalpa);\r\nbfa_trc(bfa, fcport->cfg.hardalpa);\r\nfcport->cfg.cfg_hardalpa = BFA_TRUE;\r\nfcport->cfg.hardalpa = alpa;\r\nreturn BFA_STATUS_OK;\r\n}\r\nbfa_status_t\r\nbfa_fcport_clr_hardalpa(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nbfa_trc(bfa, fcport->cfg.cfg_hardalpa);\r\nbfa_trc(bfa, fcport->cfg.hardalpa);\r\nfcport->cfg.cfg_hardalpa = BFA_FALSE;\r\nreturn BFA_STATUS_OK;\r\n}\r\nbfa_boolean_t\r\nbfa_fcport_get_hardalpa(struct bfa_s *bfa, u8 *alpa)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\n*alpa = fcport->cfg.hardalpa;\r\nreturn fcport->cfg.cfg_hardalpa;\r\n}\r\nu8\r\nbfa_fcport_get_myalpa(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nreturn fcport->myalpa;\r\n}\r\nbfa_status_t\r\nbfa_fcport_cfg_maxfrsize(struct bfa_s *bfa, u16 maxfrsize)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nbfa_trc(bfa, maxfrsize);\r\nbfa_trc(bfa, fcport->cfg.maxfrsize);\r\nif ((maxfrsize > FC_MAX_PDUSZ) || (maxfrsize < FC_MIN_PDUSZ))\r\nreturn BFA_STATUS_INVLD_DFSZ;\r\nif ((maxfrsize != FC_MAX_PDUSZ) && (maxfrsize & (maxfrsize - 1)))\r\nreturn BFA_STATUS_INVLD_DFSZ;\r\nfcport->cfg.maxfrsize = maxfrsize;\r\nreturn BFA_STATUS_OK;\r\n}\r\nu16\r\nbfa_fcport_get_maxfrsize(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nreturn fcport->cfg.maxfrsize;\r\n}\r\nu8\r\nbfa_fcport_get_rx_bbcredit(struct bfa_s *bfa)\r\n{\r\nif (bfa_fcport_get_topology(bfa) != BFA_PORT_TOPOLOGY_LOOP)\r\nreturn (BFA_FCPORT_MOD(bfa))->cfg.rx_bbcredit;\r\nelse\r\nreturn 0;\r\n}\r\nvoid\r\nbfa_fcport_set_tx_bbcredit(struct bfa_s *bfa, u16 tx_bbcredit)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nfcport->cfg.tx_bbcredit = (u8)tx_bbcredit;\r\n}\r\nwwn_t\r\nbfa_fcport_get_wwn(struct bfa_s *bfa, bfa_boolean_t node)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nif (node)\r\nreturn fcport->nwwn;\r\nelse\r\nreturn fcport->pwwn;\r\n}\r\nvoid\r\nbfa_fcport_get_attr(struct bfa_s *bfa, struct bfa_port_attr_s *attr)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nmemset(attr, 0, sizeof(struct bfa_port_attr_s));\r\nattr->nwwn = fcport->nwwn;\r\nattr->pwwn = fcport->pwwn;\r\nattr->factorypwwn = bfa->ioc.attr->mfg_pwwn;\r\nattr->factorynwwn = bfa->ioc.attr->mfg_nwwn;\r\nmemcpy(&attr->pport_cfg, &fcport->cfg,\r\nsizeof(struct bfa_port_cfg_s));\r\nattr->pport_cfg.speed = fcport->cfg.speed;\r\nattr->speed_supported = fcport->speed_sup;\r\nattr->speed = fcport->speed;\r\nattr->cos_supported = FC_CLASS_3;\r\nattr->pport_cfg.topology = fcport->cfg.topology;\r\nattr->topology = fcport->topology;\r\nattr->pport_cfg.trunked = fcport->cfg.trunked;\r\nattr->beacon = fcport->beacon;\r\nattr->link_e2e_beacon = fcport->link_e2e_beacon;\r\nattr->pport_cfg.path_tov = bfa_fcpim_path_tov_get(bfa);\r\nattr->pport_cfg.q_depth = bfa_fcpim_qdepth_get(bfa);\r\nattr->port_state = bfa_sm_to_state(hal_port_sm_table, fcport->sm);\r\nattr->fec_state = fcport->fec_state;\r\nif (bfa_fcport_is_pbcdisabled(bfa))\r\nattr->port_state = BFA_PORT_ST_PREBOOT_DISABLED;\r\nelse {\r\nif (bfa_ioc_is_disabled(&fcport->bfa->ioc))\r\nattr->port_state = BFA_PORT_ST_IOCDIS;\r\nelse if (bfa_ioc_fw_mismatch(&fcport->bfa->ioc))\r\nattr->port_state = BFA_PORT_ST_FWMISMATCH;\r\n}\r\nattr->fcoe_vlan = fcport->fcoe_vlan;\r\n}\r\nbfa_status_t\r\nbfa_fcport_get_stats(struct bfa_s *bfa, struct bfa_cb_pending_q_s *cb)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nif (!bfa_iocfc_is_operational(bfa) ||\r\n!fcport->stats_dma_ready)\r\nreturn BFA_STATUS_IOC_NON_OP;\r\nif (!list_empty(&fcport->statsclr_pending_q))\r\nreturn BFA_STATUS_DEVBUSY;\r\nif (list_empty(&fcport->stats_pending_q)) {\r\nlist_add_tail(&cb->hcb_qe.qe, &fcport->stats_pending_q);\r\nbfa_fcport_send_stats_get(fcport);\r\nbfa_timer_start(bfa, &fcport->timer,\r\nbfa_fcport_stats_get_timeout,\r\nfcport, BFA_FCPORT_STATS_TOV);\r\n} else\r\nlist_add_tail(&cb->hcb_qe.qe, &fcport->stats_pending_q);\r\nreturn BFA_STATUS_OK;\r\n}\r\nbfa_status_t\r\nbfa_fcport_clear_stats(struct bfa_s *bfa, struct bfa_cb_pending_q_s *cb)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nif (!bfa_iocfc_is_operational(bfa) ||\r\n!fcport->stats_dma_ready)\r\nreturn BFA_STATUS_IOC_NON_OP;\r\nif (!list_empty(&fcport->stats_pending_q))\r\nreturn BFA_STATUS_DEVBUSY;\r\nif (list_empty(&fcport->statsclr_pending_q)) {\r\nlist_add_tail(&cb->hcb_qe.qe, &fcport->statsclr_pending_q);\r\nbfa_fcport_send_stats_clear(fcport);\r\nbfa_timer_start(bfa, &fcport->timer,\r\nbfa_fcport_stats_clr_timeout,\r\nfcport, BFA_FCPORT_STATS_TOV);\r\n} else\r\nlist_add_tail(&cb->hcb_qe.qe, &fcport->statsclr_pending_q);\r\nreturn BFA_STATUS_OK;\r\n}\r\nbfa_boolean_t\r\nbfa_fcport_is_disabled(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nreturn bfa_sm_to_state(hal_port_sm_table, fcport->sm) ==\r\nBFA_PORT_ST_DISABLED;\r\n}\r\nbfa_boolean_t\r\nbfa_fcport_is_dport(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nreturn (bfa_sm_to_state(hal_port_sm_table, fcport->sm) ==\r\nBFA_PORT_ST_DPORT);\r\n}\r\nbfa_boolean_t\r\nbfa_fcport_is_ddport(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nreturn (bfa_sm_to_state(hal_port_sm_table, fcport->sm) ==\r\nBFA_PORT_ST_DDPORT);\r\n}\r\nbfa_status_t\r\nbfa_fcport_set_qos_bw(struct bfa_s *bfa, struct bfa_qos_bw_s *qos_bw)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nenum bfa_ioc_type_e ioc_type = bfa_get_type(bfa);\r\nbfa_trc(bfa, ioc_type);\r\nif ((qos_bw->high == 0) || (qos_bw->med == 0) || (qos_bw->low == 0))\r\nreturn BFA_STATUS_QOS_BW_INVALID;\r\nif ((qos_bw->high + qos_bw->med + qos_bw->low) != 100)\r\nreturn BFA_STATUS_QOS_BW_INVALID;\r\nif ((qos_bw->med > qos_bw->high) || (qos_bw->low > qos_bw->med) ||\r\n(qos_bw->low > qos_bw->high))\r\nreturn BFA_STATUS_QOS_BW_INVALID;\r\nif ((ioc_type == BFA_IOC_TYPE_FC) &&\r\n(fcport->cfg.topology != BFA_PORT_TOPOLOGY_LOOP))\r\nfcport->cfg.qos_bw = *qos_bw;\r\nreturn BFA_STATUS_OK;\r\n}\r\nbfa_boolean_t\r\nbfa_fcport_is_ratelim(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nreturn fcport->cfg.ratelimit ? BFA_TRUE : BFA_FALSE;\r\n}\r\nvoid\r\nbfa_fcport_cfg_faa(struct bfa_s *bfa, u8 state)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nbfa_trc(bfa, state);\r\nfcport->cfg.faa_state = state;\r\n}\r\nenum bfa_port_speed\r\nbfa_fcport_get_ratelim_speed(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nbfa_trc(bfa, fcport->cfg.trl_def_speed);\r\nreturn fcport->cfg.trl_def_speed;\r\n}\r\nvoid\r\nbfa_fcport_beacon(void *dev, bfa_boolean_t beacon,\r\nbfa_boolean_t link_e2e_beacon)\r\n{\r\nstruct bfa_s *bfa = dev;\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nbfa_trc(bfa, beacon);\r\nbfa_trc(bfa, link_e2e_beacon);\r\nbfa_trc(bfa, fcport->beacon);\r\nbfa_trc(bfa, fcport->link_e2e_beacon);\r\nfcport->beacon = beacon;\r\nfcport->link_e2e_beacon = link_e2e_beacon;\r\n}\r\nbfa_boolean_t\r\nbfa_fcport_is_linkup(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nreturn (!fcport->cfg.trunked &&\r\nbfa_sm_cmp_state(fcport, bfa_fcport_sm_linkup)) ||\r\n(fcport->cfg.trunked &&\r\nfcport->trunk.attr.state == BFA_TRUNK_ONLINE);\r\n}\r\nbfa_boolean_t\r\nbfa_fcport_is_qos_enabled(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nreturn fcport->cfg.qos_enabled;\r\n}\r\nbfa_boolean_t\r\nbfa_fcport_is_trunk_enabled(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nreturn fcport->cfg.trunked;\r\n}\r\nbfa_status_t\r\nbfa_fcport_cfg_bbcr(struct bfa_s *bfa, bfa_boolean_t on_off, u8 bb_scn)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nbfa_trc(bfa, on_off);\r\nif (bfa_ioc_get_type(&fcport->bfa->ioc) != BFA_IOC_TYPE_FC)\r\nreturn BFA_STATUS_BBCR_FC_ONLY;\r\nif (bfa_mfg_is_mezz(bfa->ioc.attr->card_type) &&\r\n(bfa->ioc.attr->card_type != BFA_MFG_TYPE_CHINOOK))\r\nreturn BFA_STATUS_CMD_NOTSUPP_MEZZ;\r\nif (on_off) {\r\nif (fcport->cfg.topology == BFA_PORT_TOPOLOGY_LOOP)\r\nreturn BFA_STATUS_TOPOLOGY_LOOP;\r\nif (fcport->cfg.qos_enabled)\r\nreturn BFA_STATUS_ERROR_QOS_ENABLED;\r\nif (fcport->cfg.trunked)\r\nreturn BFA_STATUS_TRUNK_ENABLED;\r\nif ((fcport->cfg.speed != BFA_PORT_SPEED_AUTO) &&\r\n(fcport->cfg.speed < bfa_ioc_speed_sup(&bfa->ioc)))\r\nreturn BFA_STATUS_ERR_BBCR_SPEED_UNSUPPORT;\r\nif (bfa_ioc_speed_sup(&bfa->ioc) < BFA_PORT_SPEED_8GBPS)\r\nreturn BFA_STATUS_FEATURE_NOT_SUPPORTED;\r\nif (fcport->cfg.bb_cr_enabled) {\r\nif (bb_scn != fcport->cfg.bb_scn)\r\nreturn BFA_STATUS_BBCR_CFG_NO_CHANGE;\r\nelse\r\nreturn BFA_STATUS_NO_CHANGE;\r\n}\r\nif ((bb_scn == 0) || (bb_scn > BFA_BB_SCN_MAX))\r\nbb_scn = BFA_BB_SCN_DEF;\r\nfcport->cfg.bb_cr_enabled = on_off;\r\nfcport->cfg.bb_scn = bb_scn;\r\n} else {\r\nif (!fcport->cfg.bb_cr_enabled)\r\nreturn BFA_STATUS_NO_CHANGE;\r\nfcport->cfg.bb_cr_enabled = on_off;\r\nfcport->cfg.bb_scn = 0;\r\n}\r\nreturn BFA_STATUS_OK;\r\n}\r\nbfa_status_t\r\nbfa_fcport_get_bbcr_attr(struct bfa_s *bfa,\r\nstruct bfa_bbcr_attr_s *bbcr_attr)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(bfa);\r\nif (bfa_ioc_get_type(&fcport->bfa->ioc) != BFA_IOC_TYPE_FC)\r\nreturn BFA_STATUS_BBCR_FC_ONLY;\r\nif (fcport->cfg.topology == BFA_PORT_TOPOLOGY_LOOP)\r\nreturn BFA_STATUS_TOPOLOGY_LOOP;\r\n*bbcr_attr = fcport->bbcr_attr;\r\nreturn BFA_STATUS_OK;\r\n}\r\nvoid\r\nbfa_fcport_dportenable(struct bfa_s *bfa)\r\n{\r\nbfa_sm_send_event(BFA_FCPORT_MOD(bfa), BFA_FCPORT_SM_DPORTENABLE);\r\nbfa_port_set_dportenabled(&bfa->modules.port, BFA_TRUE);\r\n}\r\nvoid\r\nbfa_fcport_dportdisable(struct bfa_s *bfa)\r\n{\r\nbfa_sm_send_event(BFA_FCPORT_MOD(bfa), BFA_FCPORT_SM_DPORTDISABLE);\r\nbfa_port_set_dportenabled(&bfa->modules.port, BFA_FALSE);\r\n}\r\nvoid\r\nbfa_fcport_ddportenable(struct bfa_s *bfa)\r\n{\r\nbfa_sm_send_event(BFA_FCPORT_MOD(bfa), BFA_FCPORT_SM_DDPORTENABLE);\r\n}\r\nvoid\r\nbfa_fcport_ddportdisable(struct bfa_s *bfa)\r\n{\r\nbfa_sm_send_event(BFA_FCPORT_MOD(bfa), BFA_FCPORT_SM_DDPORTDISABLE);\r\n}\r\nstatic void\r\nbfa_rport_sm_uninit(struct bfa_rport_s *rp, enum bfa_rport_event event)\r\n{\r\nbfa_trc(rp->bfa, rp->rport_tag);\r\nbfa_trc(rp->bfa, event);\r\nswitch (event) {\r\ncase BFA_RPORT_SM_CREATE:\r\nbfa_stats(rp, sm_un_cr);\r\nbfa_sm_set_state(rp, bfa_rport_sm_created);\r\nbreak;\r\ndefault:\r\nbfa_stats(rp, sm_un_unexp);\r\nbfa_sm_fault(rp->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_rport_sm_created(struct bfa_rport_s *rp, enum bfa_rport_event event)\r\n{\r\nbfa_trc(rp->bfa, rp->rport_tag);\r\nbfa_trc(rp->bfa, event);\r\nswitch (event) {\r\ncase BFA_RPORT_SM_ONLINE:\r\nbfa_stats(rp, sm_cr_on);\r\nif (bfa_rport_send_fwcreate(rp))\r\nbfa_sm_set_state(rp, bfa_rport_sm_fwcreate);\r\nelse\r\nbfa_sm_set_state(rp, bfa_rport_sm_fwcreate_qfull);\r\nbreak;\r\ncase BFA_RPORT_SM_DELETE:\r\nbfa_stats(rp, sm_cr_del);\r\nbfa_sm_set_state(rp, bfa_rport_sm_uninit);\r\nbfa_rport_free(rp);\r\nbreak;\r\ncase BFA_RPORT_SM_HWFAIL:\r\nbfa_stats(rp, sm_cr_hwf);\r\nbfa_sm_set_state(rp, bfa_rport_sm_iocdisable);\r\nbreak;\r\ndefault:\r\nbfa_stats(rp, sm_cr_unexp);\r\nbfa_sm_fault(rp->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_rport_sm_fwcreate(struct bfa_rport_s *rp, enum bfa_rport_event event)\r\n{\r\nbfa_trc(rp->bfa, rp->rport_tag);\r\nbfa_trc(rp->bfa, event);\r\nswitch (event) {\r\ncase BFA_RPORT_SM_FWRSP:\r\nbfa_stats(rp, sm_fwc_rsp);\r\nbfa_sm_set_state(rp, bfa_rport_sm_online);\r\nbfa_rport_online_cb(rp);\r\nbreak;\r\ncase BFA_RPORT_SM_DELETE:\r\nbfa_stats(rp, sm_fwc_del);\r\nbfa_sm_set_state(rp, bfa_rport_sm_delete_pending);\r\nbreak;\r\ncase BFA_RPORT_SM_OFFLINE:\r\nbfa_stats(rp, sm_fwc_off);\r\nbfa_sm_set_state(rp, bfa_rport_sm_offline_pending);\r\nbreak;\r\ncase BFA_RPORT_SM_HWFAIL:\r\nbfa_stats(rp, sm_fwc_hwf);\r\nbfa_sm_set_state(rp, bfa_rport_sm_iocdisable);\r\nbreak;\r\ndefault:\r\nbfa_stats(rp, sm_fwc_unexp);\r\nbfa_sm_fault(rp->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_rport_sm_fwcreate_qfull(struct bfa_rport_s *rp, enum bfa_rport_event event)\r\n{\r\nbfa_trc(rp->bfa, rp->rport_tag);\r\nbfa_trc(rp->bfa, event);\r\nswitch (event) {\r\ncase BFA_RPORT_SM_QRESUME:\r\nbfa_sm_set_state(rp, bfa_rport_sm_fwcreate);\r\nbfa_rport_send_fwcreate(rp);\r\nbreak;\r\ncase BFA_RPORT_SM_DELETE:\r\nbfa_stats(rp, sm_fwc_del);\r\nbfa_sm_set_state(rp, bfa_rport_sm_uninit);\r\nbfa_reqq_wcancel(&rp->reqq_wait);\r\nbfa_rport_free(rp);\r\nbreak;\r\ncase BFA_RPORT_SM_OFFLINE:\r\nbfa_stats(rp, sm_fwc_off);\r\nbfa_sm_set_state(rp, bfa_rport_sm_offline);\r\nbfa_reqq_wcancel(&rp->reqq_wait);\r\nbfa_rport_offline_cb(rp);\r\nbreak;\r\ncase BFA_RPORT_SM_HWFAIL:\r\nbfa_stats(rp, sm_fwc_hwf);\r\nbfa_sm_set_state(rp, bfa_rport_sm_iocdisable);\r\nbfa_reqq_wcancel(&rp->reqq_wait);\r\nbreak;\r\ndefault:\r\nbfa_stats(rp, sm_fwc_unexp);\r\nbfa_sm_fault(rp->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_rport_sm_online(struct bfa_rport_s *rp, enum bfa_rport_event event)\r\n{\r\nstruct bfi_rport_qos_scn_s *qos_scn;\r\nbfa_trc(rp->bfa, rp->rport_tag);\r\nbfa_trc(rp->bfa, event);\r\nswitch (event) {\r\ncase BFA_RPORT_SM_OFFLINE:\r\nbfa_stats(rp, sm_on_off);\r\nif (bfa_rport_send_fwdelete(rp))\r\nbfa_sm_set_state(rp, bfa_rport_sm_fwdelete);\r\nelse\r\nbfa_sm_set_state(rp, bfa_rport_sm_fwdelete_qfull);\r\nbreak;\r\ncase BFA_RPORT_SM_DELETE:\r\nbfa_stats(rp, sm_on_del);\r\nif (bfa_rport_send_fwdelete(rp))\r\nbfa_sm_set_state(rp, bfa_rport_sm_deleting);\r\nelse\r\nbfa_sm_set_state(rp, bfa_rport_sm_deleting_qfull);\r\nbreak;\r\ncase BFA_RPORT_SM_HWFAIL:\r\nbfa_stats(rp, sm_on_hwf);\r\nbfa_sm_set_state(rp, bfa_rport_sm_iocdisable);\r\nbreak;\r\ncase BFA_RPORT_SM_SET_SPEED:\r\nbfa_rport_send_fwspeed(rp);\r\nbreak;\r\ncase BFA_RPORT_SM_QOS_SCN:\r\nqos_scn = (struct bfi_rport_qos_scn_s *) rp->event_arg.fw_msg;\r\nrp->qos_attr = qos_scn->new_qos_attr;\r\nbfa_trc(rp->bfa, qos_scn->old_qos_attr.qos_flow_id);\r\nbfa_trc(rp->bfa, qos_scn->new_qos_attr.qos_flow_id);\r\nbfa_trc(rp->bfa, qos_scn->old_qos_attr.qos_priority);\r\nbfa_trc(rp->bfa, qos_scn->new_qos_attr.qos_priority);\r\nqos_scn->old_qos_attr.qos_flow_id =\r\nbe32_to_cpu(qos_scn->old_qos_attr.qos_flow_id);\r\nqos_scn->new_qos_attr.qos_flow_id =\r\nbe32_to_cpu(qos_scn->new_qos_attr.qos_flow_id);\r\nif (qos_scn->old_qos_attr.qos_flow_id !=\r\nqos_scn->new_qos_attr.qos_flow_id)\r\nbfa_cb_rport_qos_scn_flowid(rp->rport_drv,\r\nqos_scn->old_qos_attr,\r\nqos_scn->new_qos_attr);\r\nif (qos_scn->old_qos_attr.qos_priority !=\r\nqos_scn->new_qos_attr.qos_priority)\r\nbfa_cb_rport_qos_scn_prio(rp->rport_drv,\r\nqos_scn->old_qos_attr,\r\nqos_scn->new_qos_attr);\r\nbreak;\r\ndefault:\r\nbfa_stats(rp, sm_on_unexp);\r\nbfa_sm_fault(rp->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_rport_sm_fwdelete(struct bfa_rport_s *rp, enum bfa_rport_event event)\r\n{\r\nbfa_trc(rp->bfa, rp->rport_tag);\r\nbfa_trc(rp->bfa, event);\r\nswitch (event) {\r\ncase BFA_RPORT_SM_FWRSP:\r\nbfa_stats(rp, sm_fwd_rsp);\r\nbfa_sm_set_state(rp, bfa_rport_sm_offline);\r\nbfa_rport_offline_cb(rp);\r\nbreak;\r\ncase BFA_RPORT_SM_DELETE:\r\nbfa_stats(rp, sm_fwd_del);\r\nbfa_sm_set_state(rp, bfa_rport_sm_deleting);\r\nbreak;\r\ncase BFA_RPORT_SM_HWFAIL:\r\nbfa_stats(rp, sm_fwd_hwf);\r\nbfa_sm_set_state(rp, bfa_rport_sm_iocdisable);\r\nbfa_rport_offline_cb(rp);\r\nbreak;\r\ndefault:\r\nbfa_stats(rp, sm_fwd_unexp);\r\nbfa_sm_fault(rp->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_rport_sm_fwdelete_qfull(struct bfa_rport_s *rp, enum bfa_rport_event event)\r\n{\r\nbfa_trc(rp->bfa, rp->rport_tag);\r\nbfa_trc(rp->bfa, event);\r\nswitch (event) {\r\ncase BFA_RPORT_SM_QRESUME:\r\nbfa_sm_set_state(rp, bfa_rport_sm_fwdelete);\r\nbfa_rport_send_fwdelete(rp);\r\nbreak;\r\ncase BFA_RPORT_SM_DELETE:\r\nbfa_stats(rp, sm_fwd_del);\r\nbfa_sm_set_state(rp, bfa_rport_sm_deleting_qfull);\r\nbreak;\r\ncase BFA_RPORT_SM_HWFAIL:\r\nbfa_stats(rp, sm_fwd_hwf);\r\nbfa_sm_set_state(rp, bfa_rport_sm_iocdisable);\r\nbfa_reqq_wcancel(&rp->reqq_wait);\r\nbfa_rport_offline_cb(rp);\r\nbreak;\r\ndefault:\r\nbfa_stats(rp, sm_fwd_unexp);\r\nbfa_sm_fault(rp->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_rport_sm_offline(struct bfa_rport_s *rp, enum bfa_rport_event event)\r\n{\r\nbfa_trc(rp->bfa, rp->rport_tag);\r\nbfa_trc(rp->bfa, event);\r\nswitch (event) {\r\ncase BFA_RPORT_SM_DELETE:\r\nbfa_stats(rp, sm_off_del);\r\nbfa_sm_set_state(rp, bfa_rport_sm_uninit);\r\nbfa_rport_free(rp);\r\nbreak;\r\ncase BFA_RPORT_SM_ONLINE:\r\nbfa_stats(rp, sm_off_on);\r\nif (bfa_rport_send_fwcreate(rp))\r\nbfa_sm_set_state(rp, bfa_rport_sm_fwcreate);\r\nelse\r\nbfa_sm_set_state(rp, bfa_rport_sm_fwcreate_qfull);\r\nbreak;\r\ncase BFA_RPORT_SM_HWFAIL:\r\nbfa_stats(rp, sm_off_hwf);\r\nbfa_sm_set_state(rp, bfa_rport_sm_iocdisable);\r\nbreak;\r\ncase BFA_RPORT_SM_OFFLINE:\r\nbfa_rport_offline_cb(rp);\r\nbreak;\r\ndefault:\r\nbfa_stats(rp, sm_off_unexp);\r\nbfa_sm_fault(rp->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_rport_sm_deleting(struct bfa_rport_s *rp, enum bfa_rport_event event)\r\n{\r\nbfa_trc(rp->bfa, rp->rport_tag);\r\nbfa_trc(rp->bfa, event);\r\nswitch (event) {\r\ncase BFA_RPORT_SM_FWRSP:\r\nbfa_stats(rp, sm_del_fwrsp);\r\nbfa_sm_set_state(rp, bfa_rport_sm_uninit);\r\nbfa_rport_free(rp);\r\nbreak;\r\ncase BFA_RPORT_SM_HWFAIL:\r\nbfa_stats(rp, sm_del_hwf);\r\nbfa_sm_set_state(rp, bfa_rport_sm_uninit);\r\nbfa_rport_free(rp);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rp->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_rport_sm_deleting_qfull(struct bfa_rport_s *rp, enum bfa_rport_event event)\r\n{\r\nbfa_trc(rp->bfa, rp->rport_tag);\r\nbfa_trc(rp->bfa, event);\r\nswitch (event) {\r\ncase BFA_RPORT_SM_QRESUME:\r\nbfa_stats(rp, sm_del_fwrsp);\r\nbfa_sm_set_state(rp, bfa_rport_sm_deleting);\r\nbfa_rport_send_fwdelete(rp);\r\nbreak;\r\ncase BFA_RPORT_SM_HWFAIL:\r\nbfa_stats(rp, sm_del_hwf);\r\nbfa_sm_set_state(rp, bfa_rport_sm_uninit);\r\nbfa_reqq_wcancel(&rp->reqq_wait);\r\nbfa_rport_free(rp);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rp->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_rport_sm_delete_pending(struct bfa_rport_s *rp,\r\nenum bfa_rport_event event)\r\n{\r\nbfa_trc(rp->bfa, rp->rport_tag);\r\nbfa_trc(rp->bfa, event);\r\nswitch (event) {\r\ncase BFA_RPORT_SM_FWRSP:\r\nbfa_stats(rp, sm_delp_fwrsp);\r\nif (bfa_rport_send_fwdelete(rp))\r\nbfa_sm_set_state(rp, bfa_rport_sm_deleting);\r\nelse\r\nbfa_sm_set_state(rp, bfa_rport_sm_deleting_qfull);\r\nbreak;\r\ncase BFA_RPORT_SM_HWFAIL:\r\nbfa_stats(rp, sm_delp_hwf);\r\nbfa_sm_set_state(rp, bfa_rport_sm_uninit);\r\nbfa_rport_free(rp);\r\nbreak;\r\ndefault:\r\nbfa_stats(rp, sm_delp_unexp);\r\nbfa_sm_fault(rp->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_rport_sm_offline_pending(struct bfa_rport_s *rp,\r\nenum bfa_rport_event event)\r\n{\r\nbfa_trc(rp->bfa, rp->rport_tag);\r\nbfa_trc(rp->bfa, event);\r\nswitch (event) {\r\ncase BFA_RPORT_SM_FWRSP:\r\nbfa_stats(rp, sm_offp_fwrsp);\r\nif (bfa_rport_send_fwdelete(rp))\r\nbfa_sm_set_state(rp, bfa_rport_sm_fwdelete);\r\nelse\r\nbfa_sm_set_state(rp, bfa_rport_sm_fwdelete_qfull);\r\nbreak;\r\ncase BFA_RPORT_SM_DELETE:\r\nbfa_stats(rp, sm_offp_del);\r\nbfa_sm_set_state(rp, bfa_rport_sm_delete_pending);\r\nbreak;\r\ncase BFA_RPORT_SM_HWFAIL:\r\nbfa_stats(rp, sm_offp_hwf);\r\nbfa_sm_set_state(rp, bfa_rport_sm_iocdisable);\r\nbfa_rport_offline_cb(rp);\r\nbreak;\r\ndefault:\r\nbfa_stats(rp, sm_offp_unexp);\r\nbfa_sm_fault(rp->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_rport_sm_iocdisable(struct bfa_rport_s *rp, enum bfa_rport_event event)\r\n{\r\nbfa_trc(rp->bfa, rp->rport_tag);\r\nbfa_trc(rp->bfa, event);\r\nswitch (event) {\r\ncase BFA_RPORT_SM_OFFLINE:\r\nbfa_stats(rp, sm_iocd_off);\r\nbfa_rport_offline_cb(rp);\r\nbreak;\r\ncase BFA_RPORT_SM_DELETE:\r\nbfa_stats(rp, sm_iocd_del);\r\nbfa_sm_set_state(rp, bfa_rport_sm_uninit);\r\nbfa_rport_free(rp);\r\nbreak;\r\ncase BFA_RPORT_SM_ONLINE:\r\nbfa_stats(rp, sm_iocd_on);\r\nif (bfa_rport_send_fwcreate(rp))\r\nbfa_sm_set_state(rp, bfa_rport_sm_fwcreate);\r\nelse\r\nbfa_sm_set_state(rp, bfa_rport_sm_fwcreate_qfull);\r\nbreak;\r\ncase BFA_RPORT_SM_HWFAIL:\r\nbreak;\r\ndefault:\r\nbfa_stats(rp, sm_iocd_unexp);\r\nbfa_sm_fault(rp->bfa, event);\r\n}\r\n}\r\nstatic void\r\n__bfa_cb_rport_online(void *cbarg, bfa_boolean_t complete)\r\n{\r\nstruct bfa_rport_s *rp = cbarg;\r\nif (complete)\r\nbfa_cb_rport_online(rp->rport_drv);\r\n}\r\nstatic void\r\n__bfa_cb_rport_offline(void *cbarg, bfa_boolean_t complete)\r\n{\r\nstruct bfa_rport_s *rp = cbarg;\r\nif (complete)\r\nbfa_cb_rport_offline(rp->rport_drv);\r\n}\r\nstatic void\r\nbfa_rport_qresume(void *cbarg)\r\n{\r\nstruct bfa_rport_s *rp = cbarg;\r\nbfa_sm_send_event(rp, BFA_RPORT_SM_QRESUME);\r\n}\r\nstatic void\r\nbfa_rport_meminfo(struct bfa_iocfc_cfg_s *cfg, struct bfa_meminfo_s *minfo,\r\nstruct bfa_s *bfa)\r\n{\r\nstruct bfa_mem_kva_s *rport_kva = BFA_MEM_RPORT_KVA(bfa);\r\nif (cfg->fwcfg.num_rports < BFA_RPORT_MIN)\r\ncfg->fwcfg.num_rports = BFA_RPORT_MIN;\r\nbfa_mem_kva_setup(minfo, rport_kva,\r\ncfg->fwcfg.num_rports * sizeof(struct bfa_rport_s));\r\n}\r\nstatic void\r\nbfa_rport_attach(struct bfa_s *bfa, void *bfad, struct bfa_iocfc_cfg_s *cfg,\r\nstruct bfa_pcidev_s *pcidev)\r\n{\r\nstruct bfa_rport_mod_s *mod = BFA_RPORT_MOD(bfa);\r\nstruct bfa_rport_s *rp;\r\nu16 i;\r\nINIT_LIST_HEAD(&mod->rp_free_q);\r\nINIT_LIST_HEAD(&mod->rp_active_q);\r\nINIT_LIST_HEAD(&mod->rp_unused_q);\r\nrp = (struct bfa_rport_s *) bfa_mem_kva_curp(mod);\r\nmod->rps_list = rp;\r\nmod->num_rports = cfg->fwcfg.num_rports;\r\nWARN_ON(!mod->num_rports ||\r\n(mod->num_rports & (mod->num_rports - 1)));\r\nfor (i = 0; i < mod->num_rports; i++, rp++) {\r\nmemset(rp, 0, sizeof(struct bfa_rport_s));\r\nrp->bfa = bfa;\r\nrp->rport_tag = i;\r\nbfa_sm_set_state(rp, bfa_rport_sm_uninit);\r\nif (i)\r\nlist_add_tail(&rp->qe, &mod->rp_free_q);\r\nbfa_reqq_winit(&rp->reqq_wait, bfa_rport_qresume, rp);\r\n}\r\nbfa_mem_kva_curp(mod) = (u8 *) rp;\r\n}\r\nstatic void\r\nbfa_rport_detach(struct bfa_s *bfa)\r\n{\r\n}\r\nstatic void\r\nbfa_rport_start(struct bfa_s *bfa)\r\n{\r\n}\r\nstatic void\r\nbfa_rport_stop(struct bfa_s *bfa)\r\n{\r\n}\r\nstatic void\r\nbfa_rport_iocdisable(struct bfa_s *bfa)\r\n{\r\nstruct bfa_rport_mod_s *mod = BFA_RPORT_MOD(bfa);\r\nstruct bfa_rport_s *rport;\r\nstruct list_head *qe, *qen;\r\nlist_splice_tail_init(&mod->rp_unused_q, &mod->rp_free_q);\r\nlist_for_each_safe(qe, qen, &mod->rp_active_q) {\r\nrport = (struct bfa_rport_s *) qe;\r\nbfa_sm_send_event(rport, BFA_RPORT_SM_HWFAIL);\r\n}\r\n}\r\nstatic struct bfa_rport_s *\r\nbfa_rport_alloc(struct bfa_rport_mod_s *mod)\r\n{\r\nstruct bfa_rport_s *rport;\r\nbfa_q_deq(&mod->rp_free_q, &rport);\r\nif (rport)\r\nlist_add_tail(&rport->qe, &mod->rp_active_q);\r\nreturn rport;\r\n}\r\nstatic void\r\nbfa_rport_free(struct bfa_rport_s *rport)\r\n{\r\nstruct bfa_rport_mod_s *mod = BFA_RPORT_MOD(rport->bfa);\r\nWARN_ON(!bfa_q_is_on_q(&mod->rp_active_q, rport));\r\nlist_del(&rport->qe);\r\nlist_add_tail(&rport->qe, &mod->rp_free_q);\r\n}\r\nstatic bfa_boolean_t\r\nbfa_rport_send_fwcreate(struct bfa_rport_s *rp)\r\n{\r\nstruct bfi_rport_create_req_s *m;\r\nm = bfa_reqq_next(rp->bfa, BFA_REQQ_RPORT);\r\nif (!m) {\r\nbfa_reqq_wait(rp->bfa, BFA_REQQ_RPORT, &rp->reqq_wait);\r\nreturn BFA_FALSE;\r\n}\r\nbfi_h2i_set(m->mh, BFI_MC_RPORT, BFI_RPORT_H2I_CREATE_REQ,\r\nbfa_fn_lpu(rp->bfa));\r\nm->bfa_handle = rp->rport_tag;\r\nm->max_frmsz = cpu_to_be16(rp->rport_info.max_frmsz);\r\nm->pid = rp->rport_info.pid;\r\nm->lp_fwtag = bfa_lps_get_fwtag(rp->bfa, (u8)rp->rport_info.lp_tag);\r\nm->local_pid = rp->rport_info.local_pid;\r\nm->fc_class = rp->rport_info.fc_class;\r\nm->vf_en = rp->rport_info.vf_en;\r\nm->vf_id = rp->rport_info.vf_id;\r\nm->cisc = rp->rport_info.cisc;\r\nbfa_reqq_produce(rp->bfa, BFA_REQQ_RPORT, m->mh);\r\nreturn BFA_TRUE;\r\n}\r\nstatic bfa_boolean_t\r\nbfa_rport_send_fwdelete(struct bfa_rport_s *rp)\r\n{\r\nstruct bfi_rport_delete_req_s *m;\r\nm = bfa_reqq_next(rp->bfa, BFA_REQQ_RPORT);\r\nif (!m) {\r\nbfa_reqq_wait(rp->bfa, BFA_REQQ_RPORT, &rp->reqq_wait);\r\nreturn BFA_FALSE;\r\n}\r\nbfi_h2i_set(m->mh, BFI_MC_RPORT, BFI_RPORT_H2I_DELETE_REQ,\r\nbfa_fn_lpu(rp->bfa));\r\nm->fw_handle = rp->fw_handle;\r\nbfa_reqq_produce(rp->bfa, BFA_REQQ_RPORT, m->mh);\r\nreturn BFA_TRUE;\r\n}\r\nstatic bfa_boolean_t\r\nbfa_rport_send_fwspeed(struct bfa_rport_s *rp)\r\n{\r\nstruct bfa_rport_speed_req_s *m;\r\nm = bfa_reqq_next(rp->bfa, BFA_REQQ_RPORT);\r\nif (!m) {\r\nbfa_trc(rp->bfa, rp->rport_info.speed);\r\nreturn BFA_FALSE;\r\n}\r\nbfi_h2i_set(m->mh, BFI_MC_RPORT, BFI_RPORT_H2I_SET_SPEED_REQ,\r\nbfa_fn_lpu(rp->bfa));\r\nm->fw_handle = rp->fw_handle;\r\nm->speed = (u8)rp->rport_info.speed;\r\nbfa_reqq_produce(rp->bfa, BFA_REQQ_RPORT, m->mh);\r\nreturn BFA_TRUE;\r\n}\r\nvoid\r\nbfa_rport_isr(struct bfa_s *bfa, struct bfi_msg_s *m)\r\n{\r\nunion bfi_rport_i2h_msg_u msg;\r\nstruct bfa_rport_s *rp;\r\nbfa_trc(bfa, m->mhdr.msg_id);\r\nmsg.msg = m;\r\nswitch (m->mhdr.msg_id) {\r\ncase BFI_RPORT_I2H_CREATE_RSP:\r\nrp = BFA_RPORT_FROM_TAG(bfa, msg.create_rsp->bfa_handle);\r\nrp->fw_handle = msg.create_rsp->fw_handle;\r\nrp->qos_attr = msg.create_rsp->qos_attr;\r\nbfa_rport_set_lunmask(bfa, rp);\r\nWARN_ON(msg.create_rsp->status != BFA_STATUS_OK);\r\nbfa_sm_send_event(rp, BFA_RPORT_SM_FWRSP);\r\nbreak;\r\ncase BFI_RPORT_I2H_DELETE_RSP:\r\nrp = BFA_RPORT_FROM_TAG(bfa, msg.delete_rsp->bfa_handle);\r\nWARN_ON(msg.delete_rsp->status != BFA_STATUS_OK);\r\nbfa_rport_unset_lunmask(bfa, rp);\r\nbfa_sm_send_event(rp, BFA_RPORT_SM_FWRSP);\r\nbreak;\r\ncase BFI_RPORT_I2H_QOS_SCN:\r\nrp = BFA_RPORT_FROM_TAG(bfa, msg.qos_scn_evt->bfa_handle);\r\nrp->event_arg.fw_msg = msg.qos_scn_evt;\r\nbfa_sm_send_event(rp, BFA_RPORT_SM_QOS_SCN);\r\nbreak;\r\ncase BFI_RPORT_I2H_LIP_SCN_ONLINE:\r\nbfa_fcport_update_loop_info(BFA_FCPORT_MOD(bfa),\r\n&msg.lip_scn->loop_info);\r\nbfa_cb_rport_scn_online(bfa);\r\nbreak;\r\ncase BFI_RPORT_I2H_LIP_SCN_OFFLINE:\r\nbfa_cb_rport_scn_offline(bfa);\r\nbreak;\r\ncase BFI_RPORT_I2H_NO_DEV:\r\nrp = BFA_RPORT_FROM_TAG(bfa, msg.lip_scn->bfa_handle);\r\nbfa_cb_rport_scn_no_dev(rp->rport_drv);\r\nbreak;\r\ndefault:\r\nbfa_trc(bfa, m->mhdr.msg_id);\r\nWARN_ON(1);\r\n}\r\n}\r\nvoid\r\nbfa_rport_res_recfg(struct bfa_s *bfa, u16 num_rport_fw)\r\n{\r\nstruct bfa_rport_mod_s *mod = BFA_RPORT_MOD(bfa);\r\nstruct list_head *qe;\r\nint i;\r\nfor (i = 0; i < (mod->num_rports - num_rport_fw); i++) {\r\nbfa_q_deq_tail(&mod->rp_free_q, &qe);\r\nlist_add_tail(qe, &mod->rp_unused_q);\r\n}\r\n}\r\nstruct bfa_rport_s *\r\nbfa_rport_create(struct bfa_s *bfa, void *rport_drv)\r\n{\r\nstruct bfa_rport_s *rp;\r\nrp = bfa_rport_alloc(BFA_RPORT_MOD(bfa));\r\nif (rp == NULL)\r\nreturn NULL;\r\nrp->bfa = bfa;\r\nrp->rport_drv = rport_drv;\r\nmemset(&rp->stats, 0, sizeof(rp->stats));\r\nWARN_ON(!bfa_sm_cmp_state(rp, bfa_rport_sm_uninit));\r\nbfa_sm_send_event(rp, BFA_RPORT_SM_CREATE);\r\nreturn rp;\r\n}\r\nvoid\r\nbfa_rport_online(struct bfa_rport_s *rport, struct bfa_rport_info_s *rport_info)\r\n{\r\nWARN_ON(rport_info->max_frmsz == 0);\r\nif (rport_info->max_frmsz == 0) {\r\nbfa_trc(rport->bfa, rport->rport_tag);\r\nrport_info->max_frmsz = FC_MIN_PDUSZ;\r\n}\r\nrport->rport_info = *rport_info;\r\nbfa_sm_send_event(rport, BFA_RPORT_SM_ONLINE);\r\n}\r\nvoid\r\nbfa_rport_speed(struct bfa_rport_s *rport, enum bfa_port_speed speed)\r\n{\r\nWARN_ON(speed == 0);\r\nWARN_ON(speed == BFA_PORT_SPEED_AUTO);\r\nif (rport) {\r\nrport->rport_info.speed = speed;\r\nbfa_sm_send_event(rport, BFA_RPORT_SM_SET_SPEED);\r\n}\r\n}\r\nvoid\r\nbfa_rport_set_lunmask(struct bfa_s *bfa, struct bfa_rport_s *rp)\r\n{\r\nstruct bfa_lps_mod_s *lps_mod = BFA_LPS_MOD(bfa);\r\nwwn_t lp_wwn, rp_wwn;\r\nu8 lp_tag = (u8)rp->rport_info.lp_tag;\r\nrp_wwn = ((struct bfa_fcs_rport_s *)rp->rport_drv)->pwwn;\r\nlp_wwn = (BFA_LPS_FROM_TAG(lps_mod, rp->rport_info.lp_tag))->pwwn;\r\nBFA_LPS_FROM_TAG(lps_mod, rp->rport_info.lp_tag)->lun_mask =\r\nrp->lun_mask = BFA_TRUE;\r\nbfa_fcpim_lunmask_rp_update(bfa, lp_wwn, rp_wwn, rp->rport_tag, lp_tag);\r\n}\r\nvoid\r\nbfa_rport_unset_lunmask(struct bfa_s *bfa, struct bfa_rport_s *rp)\r\n{\r\nstruct bfa_lps_mod_s *lps_mod = BFA_LPS_MOD(bfa);\r\nwwn_t lp_wwn, rp_wwn;\r\nrp_wwn = ((struct bfa_fcs_rport_s *)rp->rport_drv)->pwwn;\r\nlp_wwn = (BFA_LPS_FROM_TAG(lps_mod, rp->rport_info.lp_tag))->pwwn;\r\nBFA_LPS_FROM_TAG(lps_mod, rp->rport_info.lp_tag)->lun_mask =\r\nrp->lun_mask = BFA_FALSE;\r\nbfa_fcpim_lunmask_rp_update(bfa, lp_wwn, rp_wwn,\r\nBFA_RPORT_TAG_INVALID, BFA_LP_TAG_INVALID);\r\n}\r\nstatic void\r\nbfa_sgpg_meminfo(struct bfa_iocfc_cfg_s *cfg, struct bfa_meminfo_s *minfo,\r\nstruct bfa_s *bfa)\r\n{\r\nstruct bfa_sgpg_mod_s *sgpg_mod = BFA_SGPG_MOD(bfa);\r\nstruct bfa_mem_kva_s *sgpg_kva = BFA_MEM_SGPG_KVA(bfa);\r\nstruct bfa_mem_dma_s *seg_ptr;\r\nu16 nsegs, idx, per_seg_sgpg, num_sgpg;\r\nu32 sgpg_sz = sizeof(struct bfi_sgpg_s);\r\nif (cfg->drvcfg.num_sgpgs < BFA_SGPG_MIN)\r\ncfg->drvcfg.num_sgpgs = BFA_SGPG_MIN;\r\nelse if (cfg->drvcfg.num_sgpgs > BFA_SGPG_MAX)\r\ncfg->drvcfg.num_sgpgs = BFA_SGPG_MAX;\r\nnum_sgpg = cfg->drvcfg.num_sgpgs;\r\nnsegs = BFI_MEM_DMA_NSEGS(num_sgpg, sgpg_sz);\r\nper_seg_sgpg = BFI_MEM_NREQS_SEG(sgpg_sz);\r\nbfa_mem_dma_seg_iter(sgpg_mod, seg_ptr, nsegs, idx) {\r\nif (num_sgpg >= per_seg_sgpg) {\r\nnum_sgpg -= per_seg_sgpg;\r\nbfa_mem_dma_setup(minfo, seg_ptr,\r\nper_seg_sgpg * sgpg_sz);\r\n} else\r\nbfa_mem_dma_setup(minfo, seg_ptr,\r\nnum_sgpg * sgpg_sz);\r\n}\r\nbfa_mem_kva_setup(minfo, sgpg_kva,\r\ncfg->drvcfg.num_sgpgs * sizeof(struct bfa_sgpg_s));\r\n}\r\nstatic void\r\nbfa_sgpg_attach(struct bfa_s *bfa, void *bfad, struct bfa_iocfc_cfg_s *cfg,\r\nstruct bfa_pcidev_s *pcidev)\r\n{\r\nstruct bfa_sgpg_mod_s *mod = BFA_SGPG_MOD(bfa);\r\nstruct bfa_sgpg_s *hsgpg;\r\nstruct bfi_sgpg_s *sgpg;\r\nu64 align_len;\r\nstruct bfa_mem_dma_s *seg_ptr;\r\nu32 sgpg_sz = sizeof(struct bfi_sgpg_s);\r\nu16 i, idx, nsegs, per_seg_sgpg, num_sgpg;\r\nunion {\r\nu64 pa;\r\nunion bfi_addr_u addr;\r\n} sgpg_pa, sgpg_pa_tmp;\r\nINIT_LIST_HEAD(&mod->sgpg_q);\r\nINIT_LIST_HEAD(&mod->sgpg_wait_q);\r\nbfa_trc(bfa, cfg->drvcfg.num_sgpgs);\r\nmod->free_sgpgs = mod->num_sgpgs = cfg->drvcfg.num_sgpgs;\r\nnum_sgpg = cfg->drvcfg.num_sgpgs;\r\nnsegs = BFI_MEM_DMA_NSEGS(num_sgpg, sgpg_sz);\r\nhsgpg = (struct bfa_sgpg_s *) bfa_mem_kva_curp(mod);\r\nbfa_mem_dma_seg_iter(mod, seg_ptr, nsegs, idx) {\r\nif (!bfa_mem_dma_virt(seg_ptr))\r\nbreak;\r\nalign_len = BFA_SGPG_ROUNDUP(bfa_mem_dma_phys(seg_ptr)) -\r\nbfa_mem_dma_phys(seg_ptr);\r\nsgpg = (struct bfi_sgpg_s *)\r\n(((u8 *) bfa_mem_dma_virt(seg_ptr)) + align_len);\r\nsgpg_pa.pa = bfa_mem_dma_phys(seg_ptr) + align_len;\r\nWARN_ON(sgpg_pa.pa & (sgpg_sz - 1));\r\nper_seg_sgpg = (seg_ptr->mem_len - (u32)align_len) / sgpg_sz;\r\nfor (i = 0; num_sgpg > 0 && i < per_seg_sgpg; i++, num_sgpg--) {\r\nmemset(hsgpg, 0, sizeof(*hsgpg));\r\nmemset(sgpg, 0, sizeof(*sgpg));\r\nhsgpg->sgpg = sgpg;\r\nsgpg_pa_tmp.pa = bfa_sgaddr_le(sgpg_pa.pa);\r\nhsgpg->sgpg_pa = sgpg_pa_tmp.addr;\r\nlist_add_tail(&hsgpg->qe, &mod->sgpg_q);\r\nsgpg++;\r\nhsgpg++;\r\nsgpg_pa.pa += sgpg_sz;\r\n}\r\n}\r\nbfa_mem_kva_curp(mod) = (u8 *) hsgpg;\r\n}\r\nstatic void\r\nbfa_sgpg_detach(struct bfa_s *bfa)\r\n{\r\n}\r\nstatic void\r\nbfa_sgpg_start(struct bfa_s *bfa)\r\n{\r\n}\r\nstatic void\r\nbfa_sgpg_stop(struct bfa_s *bfa)\r\n{\r\n}\r\nstatic void\r\nbfa_sgpg_iocdisable(struct bfa_s *bfa)\r\n{\r\n}\r\nbfa_status_t\r\nbfa_sgpg_malloc(struct bfa_s *bfa, struct list_head *sgpg_q, int nsgpgs)\r\n{\r\nstruct bfa_sgpg_mod_s *mod = BFA_SGPG_MOD(bfa);\r\nstruct bfa_sgpg_s *hsgpg;\r\nint i;\r\nif (mod->free_sgpgs < nsgpgs)\r\nreturn BFA_STATUS_ENOMEM;\r\nfor (i = 0; i < nsgpgs; i++) {\r\nbfa_q_deq(&mod->sgpg_q, &hsgpg);\r\nWARN_ON(!hsgpg);\r\nlist_add_tail(&hsgpg->qe, sgpg_q);\r\n}\r\nmod->free_sgpgs -= nsgpgs;\r\nreturn BFA_STATUS_OK;\r\n}\r\nvoid\r\nbfa_sgpg_mfree(struct bfa_s *bfa, struct list_head *sgpg_q, int nsgpg)\r\n{\r\nstruct bfa_sgpg_mod_s *mod = BFA_SGPG_MOD(bfa);\r\nstruct bfa_sgpg_wqe_s *wqe;\r\nmod->free_sgpgs += nsgpg;\r\nWARN_ON(mod->free_sgpgs > mod->num_sgpgs);\r\nlist_splice_tail_init(sgpg_q, &mod->sgpg_q);\r\nif (list_empty(&mod->sgpg_wait_q))\r\nreturn;\r\ndo {\r\nwqe = bfa_q_first(&mod->sgpg_wait_q);\r\nif (mod->free_sgpgs < wqe->nsgpg)\r\nnsgpg = mod->free_sgpgs;\r\nelse\r\nnsgpg = wqe->nsgpg;\r\nbfa_sgpg_malloc(bfa, &wqe->sgpg_q, nsgpg);\r\nwqe->nsgpg -= nsgpg;\r\nif (wqe->nsgpg == 0) {\r\nlist_del(&wqe->qe);\r\nwqe->cbfn(wqe->cbarg);\r\n}\r\n} while (mod->free_sgpgs && !list_empty(&mod->sgpg_wait_q));\r\n}\r\nvoid\r\nbfa_sgpg_wait(struct bfa_s *bfa, struct bfa_sgpg_wqe_s *wqe, int nsgpg)\r\n{\r\nstruct bfa_sgpg_mod_s *mod = BFA_SGPG_MOD(bfa);\r\nWARN_ON(nsgpg <= 0);\r\nWARN_ON(nsgpg <= mod->free_sgpgs);\r\nwqe->nsgpg_total = wqe->nsgpg = nsgpg;\r\nif (mod->free_sgpgs) {\r\nWARN_ON(!list_empty(&mod->sgpg_wait_q));\r\nlist_splice_tail_init(&mod->sgpg_q, &wqe->sgpg_q);\r\nwqe->nsgpg -= mod->free_sgpgs;\r\nmod->free_sgpgs = 0;\r\n}\r\nlist_add_tail(&wqe->qe, &mod->sgpg_wait_q);\r\n}\r\nvoid\r\nbfa_sgpg_wcancel(struct bfa_s *bfa, struct bfa_sgpg_wqe_s *wqe)\r\n{\r\nstruct bfa_sgpg_mod_s *mod = BFA_SGPG_MOD(bfa);\r\nWARN_ON(!bfa_q_is_on_q(&mod->sgpg_wait_q, wqe));\r\nlist_del(&wqe->qe);\r\nif (wqe->nsgpg_total != wqe->nsgpg)\r\nbfa_sgpg_mfree(bfa, &wqe->sgpg_q,\r\nwqe->nsgpg_total - wqe->nsgpg);\r\n}\r\nvoid\r\nbfa_sgpg_winit(struct bfa_sgpg_wqe_s *wqe, void (*cbfn) (void *cbarg),\r\nvoid *cbarg)\r\n{\r\nINIT_LIST_HEAD(&wqe->sgpg_q);\r\nwqe->cbfn = cbfn;\r\nwqe->cbarg = cbarg;\r\n}\r\nstatic void\r\n__bfa_cb_uf_recv(void *cbarg, bfa_boolean_t complete)\r\n{\r\nstruct bfa_uf_s *uf = cbarg;\r\nstruct bfa_uf_mod_s *ufm = BFA_UF_MOD(uf->bfa);\r\nif (complete)\r\nufm->ufrecv(ufm->cbarg, uf);\r\n}\r\nstatic void\r\nclaim_uf_post_msgs(struct bfa_uf_mod_s *ufm)\r\n{\r\nstruct bfi_uf_buf_post_s *uf_bp_msg;\r\nu16 i;\r\nu16 buf_len;\r\nufm->uf_buf_posts = (struct bfi_uf_buf_post_s *) bfa_mem_kva_curp(ufm);\r\nuf_bp_msg = ufm->uf_buf_posts;\r\nfor (i = 0, uf_bp_msg = ufm->uf_buf_posts; i < ufm->num_ufs;\r\ni++, uf_bp_msg++) {\r\nmemset(uf_bp_msg, 0, sizeof(struct bfi_uf_buf_post_s));\r\nuf_bp_msg->buf_tag = i;\r\nbuf_len = sizeof(struct bfa_uf_buf_s);\r\nuf_bp_msg->buf_len = cpu_to_be16(buf_len);\r\nbfi_h2i_set(uf_bp_msg->mh, BFI_MC_UF, BFI_UF_H2I_BUF_POST,\r\nbfa_fn_lpu(ufm->bfa));\r\nbfa_alen_set(&uf_bp_msg->alen, buf_len, ufm_pbs_pa(ufm, i));\r\n}\r\nbfa_mem_kva_curp(ufm) = (u8 *) uf_bp_msg;\r\n}\r\nstatic void\r\nclaim_ufs(struct bfa_uf_mod_s *ufm)\r\n{\r\nu16 i;\r\nstruct bfa_uf_s *uf;\r\nufm->uf_list = (struct bfa_uf_s *) bfa_mem_kva_curp(ufm);\r\nfor (i = 0, uf = ufm->uf_list; i < ufm->num_ufs; i++, uf++) {\r\nmemset(uf, 0, sizeof(struct bfa_uf_s));\r\nuf->bfa = ufm->bfa;\r\nuf->uf_tag = i;\r\nuf->pb_len = BFA_PER_UF_DMA_SZ;\r\nuf->buf_kva = bfa_mem_get_dmabuf_kva(ufm, i, BFA_PER_UF_DMA_SZ);\r\nuf->buf_pa = ufm_pbs_pa(ufm, i);\r\nlist_add_tail(&uf->qe, &ufm->uf_free_q);\r\n}\r\nbfa_mem_kva_curp(ufm) = (u8 *) uf;\r\n}\r\nstatic void\r\nuf_mem_claim(struct bfa_uf_mod_s *ufm)\r\n{\r\nclaim_ufs(ufm);\r\nclaim_uf_post_msgs(ufm);\r\n}\r\nstatic void\r\nbfa_uf_meminfo(struct bfa_iocfc_cfg_s *cfg, struct bfa_meminfo_s *minfo,\r\nstruct bfa_s *bfa)\r\n{\r\nstruct bfa_uf_mod_s *ufm = BFA_UF_MOD(bfa);\r\nstruct bfa_mem_kva_s *uf_kva = BFA_MEM_UF_KVA(bfa);\r\nu32 num_ufs = cfg->fwcfg.num_uf_bufs;\r\nstruct bfa_mem_dma_s *seg_ptr;\r\nu16 nsegs, idx, per_seg_uf = 0;\r\nnsegs = BFI_MEM_DMA_NSEGS(num_ufs, BFA_PER_UF_DMA_SZ);\r\nper_seg_uf = BFI_MEM_NREQS_SEG(BFA_PER_UF_DMA_SZ);\r\nbfa_mem_dma_seg_iter(ufm, seg_ptr, nsegs, idx) {\r\nif (num_ufs >= per_seg_uf) {\r\nnum_ufs -= per_seg_uf;\r\nbfa_mem_dma_setup(minfo, seg_ptr,\r\nper_seg_uf * BFA_PER_UF_DMA_SZ);\r\n} else\r\nbfa_mem_dma_setup(minfo, seg_ptr,\r\nnum_ufs * BFA_PER_UF_DMA_SZ);\r\n}\r\nbfa_mem_kva_setup(minfo, uf_kva, cfg->fwcfg.num_uf_bufs *\r\n(sizeof(struct bfa_uf_s) + sizeof(struct bfi_uf_buf_post_s)));\r\n}\r\nstatic void\r\nbfa_uf_attach(struct bfa_s *bfa, void *bfad, struct bfa_iocfc_cfg_s *cfg,\r\nstruct bfa_pcidev_s *pcidev)\r\n{\r\nstruct bfa_uf_mod_s *ufm = BFA_UF_MOD(bfa);\r\nufm->bfa = bfa;\r\nufm->num_ufs = cfg->fwcfg.num_uf_bufs;\r\nINIT_LIST_HEAD(&ufm->uf_free_q);\r\nINIT_LIST_HEAD(&ufm->uf_posted_q);\r\nINIT_LIST_HEAD(&ufm->uf_unused_q);\r\nuf_mem_claim(ufm);\r\n}\r\nstatic void\r\nbfa_uf_detach(struct bfa_s *bfa)\r\n{\r\n}\r\nstatic struct bfa_uf_s *\r\nbfa_uf_get(struct bfa_uf_mod_s *uf_mod)\r\n{\r\nstruct bfa_uf_s *uf;\r\nbfa_q_deq(&uf_mod->uf_free_q, &uf);\r\nreturn uf;\r\n}\r\nstatic void\r\nbfa_uf_put(struct bfa_uf_mod_s *uf_mod, struct bfa_uf_s *uf)\r\n{\r\nlist_add_tail(&uf->qe, &uf_mod->uf_free_q);\r\n}\r\nstatic bfa_status_t\r\nbfa_uf_post(struct bfa_uf_mod_s *ufm, struct bfa_uf_s *uf)\r\n{\r\nstruct bfi_uf_buf_post_s *uf_post_msg;\r\nuf_post_msg = bfa_reqq_next(ufm->bfa, BFA_REQQ_FCXP);\r\nif (!uf_post_msg)\r\nreturn BFA_STATUS_FAILED;\r\nmemcpy(uf_post_msg, &ufm->uf_buf_posts[uf->uf_tag],\r\nsizeof(struct bfi_uf_buf_post_s));\r\nbfa_reqq_produce(ufm->bfa, BFA_REQQ_FCXP, uf_post_msg->mh);\r\nbfa_trc(ufm->bfa, uf->uf_tag);\r\nlist_add_tail(&uf->qe, &ufm->uf_posted_q);\r\nreturn BFA_STATUS_OK;\r\n}\r\nstatic void\r\nbfa_uf_post_all(struct bfa_uf_mod_s *uf_mod)\r\n{\r\nstruct bfa_uf_s *uf;\r\nwhile ((uf = bfa_uf_get(uf_mod)) != NULL) {\r\nif (bfa_uf_post(uf_mod, uf) != BFA_STATUS_OK)\r\nbreak;\r\n}\r\n}\r\nstatic void\r\nuf_recv(struct bfa_s *bfa, struct bfi_uf_frm_rcvd_s *m)\r\n{\r\nstruct bfa_uf_mod_s *ufm = BFA_UF_MOD(bfa);\r\nu16 uf_tag = m->buf_tag;\r\nstruct bfa_uf_s *uf = &ufm->uf_list[uf_tag];\r\nstruct bfa_uf_buf_s *uf_buf;\r\nuint8_t *buf;\r\nstruct fchs_s *fchs;\r\nuf_buf = (struct bfa_uf_buf_s *)\r\nbfa_mem_get_dmabuf_kva(ufm, uf_tag, uf->pb_len);\r\nbuf = &uf_buf->d[0];\r\nm->frm_len = be16_to_cpu(m->frm_len);\r\nm->xfr_len = be16_to_cpu(m->xfr_len);\r\nfchs = (struct fchs_s *)uf_buf;\r\nlist_del(&uf->qe);\r\nuf->data_ptr = buf;\r\nuf->data_len = m->xfr_len;\r\nWARN_ON(uf->data_len < sizeof(struct fchs_s));\r\nif (uf->data_len == sizeof(struct fchs_s)) {\r\nbfa_plog_fchdr(bfa->plog, BFA_PL_MID_HAL_UF, BFA_PL_EID_RX,\r\nuf->data_len, (struct fchs_s *)buf);\r\n} else {\r\nu32 pld_w0 = *((u32 *) (buf + sizeof(struct fchs_s)));\r\nbfa_plog_fchdr_and_pl(bfa->plog, BFA_PL_MID_HAL_UF,\r\nBFA_PL_EID_RX, uf->data_len,\r\n(struct fchs_s *)buf, pld_w0);\r\n}\r\nif (bfa->fcs)\r\n__bfa_cb_uf_recv(uf, BFA_TRUE);\r\nelse\r\nbfa_cb_queue(bfa, &uf->hcb_qe, __bfa_cb_uf_recv, uf);\r\n}\r\nstatic void\r\nbfa_uf_stop(struct bfa_s *bfa)\r\n{\r\n}\r\nstatic void\r\nbfa_uf_iocdisable(struct bfa_s *bfa)\r\n{\r\nstruct bfa_uf_mod_s *ufm = BFA_UF_MOD(bfa);\r\nstruct bfa_uf_s *uf;\r\nstruct list_head *qe, *qen;\r\nlist_splice_tail_init(&ufm->uf_unused_q, &ufm->uf_free_q);\r\nlist_for_each_safe(qe, qen, &ufm->uf_posted_q) {\r\nuf = (struct bfa_uf_s *) qe;\r\nlist_del(&uf->qe);\r\nbfa_uf_put(ufm, uf);\r\n}\r\n}\r\nstatic void\r\nbfa_uf_start(struct bfa_s *bfa)\r\n{\r\nbfa_uf_post_all(BFA_UF_MOD(bfa));\r\n}\r\nvoid\r\nbfa_uf_recv_register(struct bfa_s *bfa, bfa_cb_uf_recv_t ufrecv, void *cbarg)\r\n{\r\nstruct bfa_uf_mod_s *ufm = BFA_UF_MOD(bfa);\r\nufm->ufrecv = ufrecv;\r\nufm->cbarg = cbarg;\r\n}\r\nvoid\r\nbfa_uf_free(struct bfa_uf_s *uf)\r\n{\r\nbfa_uf_put(BFA_UF_MOD(uf->bfa), uf);\r\nbfa_uf_post_all(BFA_UF_MOD(uf->bfa));\r\n}\r\nvoid\r\nbfa_uf_isr(struct bfa_s *bfa, struct bfi_msg_s *msg)\r\n{\r\nbfa_trc(bfa, msg->mhdr.msg_id);\r\nswitch (msg->mhdr.msg_id) {\r\ncase BFI_UF_I2H_FRM_RCVD:\r\nuf_recv(bfa, (struct bfi_uf_frm_rcvd_s *) msg);\r\nbreak;\r\ndefault:\r\nbfa_trc(bfa, msg->mhdr.msg_id);\r\nWARN_ON(1);\r\n}\r\n}\r\nvoid\r\nbfa_uf_res_recfg(struct bfa_s *bfa, u16 num_uf_fw)\r\n{\r\nstruct bfa_uf_mod_s *mod = BFA_UF_MOD(bfa);\r\nstruct list_head *qe;\r\nint i;\r\nfor (i = 0; i < (mod->num_ufs - num_uf_fw); i++) {\r\nbfa_q_deq_tail(&mod->uf_free_q, &qe);\r\nlist_add_tail(qe, &mod->uf_unused_q);\r\n}\r\n}\r\nstatic void\r\nbfa_fcdiag_set_busy_status(struct bfa_fcdiag_s *fcdiag)\r\n{\r\nstruct bfa_fcport_s *fcport = BFA_FCPORT_MOD(fcdiag->bfa);\r\nif (fcdiag->lb.lock)\r\nfcport->diag_busy = BFA_TRUE;\r\nelse\r\nfcport->diag_busy = BFA_FALSE;\r\n}\r\nstatic void\r\nbfa_fcdiag_meminfo(struct bfa_iocfc_cfg_s *cfg, struct bfa_meminfo_s *meminfo,\r\nstruct bfa_s *bfa)\r\n{\r\n}\r\nstatic void\r\nbfa_fcdiag_attach(struct bfa_s *bfa, void *bfad, struct bfa_iocfc_cfg_s *cfg,\r\nstruct bfa_pcidev_s *pcidev)\r\n{\r\nstruct bfa_fcdiag_s *fcdiag = BFA_FCDIAG_MOD(bfa);\r\nstruct bfa_dport_s *dport = &fcdiag->dport;\r\nfcdiag->bfa = bfa;\r\nfcdiag->trcmod = bfa->trcmod;\r\ndport->bfa = bfa;\r\nbfa_sm_set_state(dport, bfa_dport_sm_disabled);\r\nbfa_reqq_winit(&dport->reqq_wait, bfa_dport_qresume, dport);\r\ndport->cbfn = NULL;\r\ndport->cbarg = NULL;\r\ndport->test_state = BFA_DPORT_ST_DISABLED;\r\nmemset(&dport->result, 0, sizeof(struct bfa_diag_dport_result_s));\r\n}\r\nstatic void\r\nbfa_fcdiag_iocdisable(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcdiag_s *fcdiag = BFA_FCDIAG_MOD(bfa);\r\nstruct bfa_dport_s *dport = &fcdiag->dport;\r\nbfa_trc(fcdiag, fcdiag->lb.lock);\r\nif (fcdiag->lb.lock) {\r\nfcdiag->lb.status = BFA_STATUS_IOC_FAILURE;\r\nfcdiag->lb.cbfn(fcdiag->lb.cbarg, fcdiag->lb.status);\r\nfcdiag->lb.lock = 0;\r\nbfa_fcdiag_set_busy_status(fcdiag);\r\n}\r\nbfa_sm_send_event(dport, BFA_DPORT_SM_HWFAIL);\r\n}\r\nstatic void\r\nbfa_fcdiag_detach(struct bfa_s *bfa)\r\n{\r\n}\r\nstatic void\r\nbfa_fcdiag_start(struct bfa_s *bfa)\r\n{\r\n}\r\nstatic void\r\nbfa_fcdiag_stop(struct bfa_s *bfa)\r\n{\r\n}\r\nstatic void\r\nbfa_fcdiag_queuetest_timeout(void *cbarg)\r\n{\r\nstruct bfa_fcdiag_s *fcdiag = cbarg;\r\nstruct bfa_diag_qtest_result_s *res = fcdiag->qtest.result;\r\nbfa_trc(fcdiag, fcdiag->qtest.all);\r\nbfa_trc(fcdiag, fcdiag->qtest.count);\r\nfcdiag->qtest.timer_active = 0;\r\nres->status = BFA_STATUS_ETIMER;\r\nres->count = QTEST_CNT_DEFAULT - fcdiag->qtest.count;\r\nif (fcdiag->qtest.all)\r\nres->queue = fcdiag->qtest.all;\r\nbfa_trc(fcdiag, BFA_STATUS_ETIMER);\r\nfcdiag->qtest.status = BFA_STATUS_ETIMER;\r\nfcdiag->qtest.cbfn(fcdiag->qtest.cbarg, fcdiag->qtest.status);\r\nfcdiag->qtest.lock = 0;\r\n}\r\nstatic bfa_status_t\r\nbfa_fcdiag_queuetest_send(struct bfa_fcdiag_s *fcdiag)\r\n{\r\nu32 i;\r\nstruct bfi_diag_qtest_req_s *req;\r\nreq = bfa_reqq_next(fcdiag->bfa, fcdiag->qtest.queue);\r\nif (!req)\r\nreturn BFA_STATUS_DEVBUSY;\r\nbfi_h2i_set(req->mh, BFI_MC_DIAG, BFI_DIAG_H2I_QTEST,\r\nbfa_fn_lpu(fcdiag->bfa));\r\nfor (i = 0; i < BFI_LMSG_PL_WSZ; i++)\r\nreq->data[i] = QTEST_PAT_DEFAULT;\r\nbfa_trc(fcdiag, fcdiag->qtest.queue);\r\nbfa_reqq_produce(fcdiag->bfa, fcdiag->qtest.queue, req->mh);\r\nreturn BFA_STATUS_OK;\r\n}\r\nstatic void\r\nbfa_fcdiag_queuetest_comp(struct bfa_fcdiag_s *fcdiag,\r\nbfi_diag_qtest_rsp_t *rsp)\r\n{\r\nstruct bfa_diag_qtest_result_s *res = fcdiag->qtest.result;\r\nbfa_status_t status = BFA_STATUS_OK;\r\nint i;\r\nif (!fcdiag->qtest.timer_active) {\r\nbfa_trc(fcdiag, fcdiag->qtest.timer_active);\r\nreturn;\r\n}\r\nfcdiag->qtest.count--;\r\nfor (i = 0; i < BFI_LMSG_PL_WSZ; i++) {\r\nif (rsp->data[i] != ~(QTEST_PAT_DEFAULT)) {\r\nres->status = BFA_STATUS_DATACORRUPTED;\r\nbreak;\r\n}\r\n}\r\nif (res->status == BFA_STATUS_OK) {\r\nif (fcdiag->qtest.count > 0) {\r\nstatus = bfa_fcdiag_queuetest_send(fcdiag);\r\nif (status == BFA_STATUS_OK)\r\nreturn;\r\nelse\r\nres->status = status;\r\n} else if (fcdiag->qtest.all > 0 &&\r\nfcdiag->qtest.queue < (BFI_IOC_MAX_CQS - 1)) {\r\nfcdiag->qtest.count = QTEST_CNT_DEFAULT;\r\nfcdiag->qtest.queue++;\r\nstatus = bfa_fcdiag_queuetest_send(fcdiag);\r\nif (status == BFA_STATUS_OK)\r\nreturn;\r\nelse\r\nres->status = status;\r\n}\r\n}\r\nif (fcdiag->qtest.timer_active) {\r\nbfa_timer_stop(&fcdiag->qtest.timer);\r\nfcdiag->qtest.timer_active = 0;\r\n}\r\nres->queue = fcdiag->qtest.queue;\r\nres->count = QTEST_CNT_DEFAULT - fcdiag->qtest.count;\r\nbfa_trc(fcdiag, res->count);\r\nbfa_trc(fcdiag, res->status);\r\nfcdiag->qtest.status = res->status;\r\nfcdiag->qtest.cbfn(fcdiag->qtest.cbarg, fcdiag->qtest.status);\r\nfcdiag->qtest.lock = 0;\r\n}\r\nstatic void\r\nbfa_fcdiag_loopback_comp(struct bfa_fcdiag_s *fcdiag,\r\nstruct bfi_diag_lb_rsp_s *rsp)\r\n{\r\nstruct bfa_diag_loopback_result_s *res = fcdiag->lb.result;\r\nres->numtxmfrm = be32_to_cpu(rsp->res.numtxmfrm);\r\nres->numosffrm = be32_to_cpu(rsp->res.numosffrm);\r\nres->numrcvfrm = be32_to_cpu(rsp->res.numrcvfrm);\r\nres->badfrminf = be32_to_cpu(rsp->res.badfrminf);\r\nres->badfrmnum = be32_to_cpu(rsp->res.badfrmnum);\r\nres->status = rsp->res.status;\r\nfcdiag->lb.status = rsp->res.status;\r\nbfa_trc(fcdiag, fcdiag->lb.status);\r\nfcdiag->lb.cbfn(fcdiag->lb.cbarg, fcdiag->lb.status);\r\nfcdiag->lb.lock = 0;\r\nbfa_fcdiag_set_busy_status(fcdiag);\r\n}\r\nstatic bfa_status_t\r\nbfa_fcdiag_loopback_send(struct bfa_fcdiag_s *fcdiag,\r\nstruct bfa_diag_loopback_s *loopback)\r\n{\r\nstruct bfi_diag_lb_req_s *lb_req;\r\nlb_req = bfa_reqq_next(fcdiag->bfa, BFA_REQQ_DIAG);\r\nif (!lb_req)\r\nreturn BFA_STATUS_DEVBUSY;\r\nbfi_h2i_set(lb_req->mh, BFI_MC_DIAG, BFI_DIAG_H2I_LOOPBACK,\r\nbfa_fn_lpu(fcdiag->bfa));\r\nlb_req->lb_mode = loopback->lb_mode;\r\nlb_req->speed = loopback->speed;\r\nlb_req->loopcnt = loopback->loopcnt;\r\nlb_req->pattern = loopback->pattern;\r\nbfa_reqq_produce(fcdiag->bfa, BFA_REQQ_DIAG, lb_req->mh);\r\nbfa_trc(fcdiag, loopback->lb_mode);\r\nbfa_trc(fcdiag, loopback->speed);\r\nbfa_trc(fcdiag, loopback->loopcnt);\r\nbfa_trc(fcdiag, loopback->pattern);\r\nreturn BFA_STATUS_OK;\r\n}\r\nvoid\r\nbfa_fcdiag_intr(struct bfa_s *bfa, struct bfi_msg_s *msg)\r\n{\r\nstruct bfa_fcdiag_s *fcdiag = BFA_FCDIAG_MOD(bfa);\r\nswitch (msg->mhdr.msg_id) {\r\ncase BFI_DIAG_I2H_LOOPBACK:\r\nbfa_fcdiag_loopback_comp(fcdiag,\r\n(struct bfi_diag_lb_rsp_s *) msg);\r\nbreak;\r\ncase BFI_DIAG_I2H_QTEST:\r\nbfa_fcdiag_queuetest_comp(fcdiag, (bfi_diag_qtest_rsp_t *)msg);\r\nbreak;\r\ncase BFI_DIAG_I2H_DPORT:\r\nbfa_dport_req_comp(&fcdiag->dport,\r\n(struct bfi_diag_dport_rsp_s *)msg);\r\nbreak;\r\ncase BFI_DIAG_I2H_DPORT_SCN:\r\nbfa_dport_scn(&fcdiag->dport,\r\n(struct bfi_diag_dport_scn_s *)msg);\r\nbreak;\r\ndefault:\r\nbfa_trc(fcdiag, msg->mhdr.msg_id);\r\nWARN_ON(1);\r\n}\r\n}\r\nbfa_status_t\r\nbfa_fcdiag_loopback(struct bfa_s *bfa, enum bfa_port_opmode opmode,\r\nenum bfa_port_speed speed, u32 lpcnt, u32 pat,\r\nstruct bfa_diag_loopback_result_s *result, bfa_cb_diag_t cbfn,\r\nvoid *cbarg)\r\n{\r\nstruct bfa_diag_loopback_s loopback;\r\nstruct bfa_port_attr_s attr;\r\nbfa_status_t status;\r\nstruct bfa_fcdiag_s *fcdiag = BFA_FCDIAG_MOD(bfa);\r\nif (!bfa_iocfc_is_operational(bfa))\r\nreturn BFA_STATUS_IOC_NON_OP;\r\nif (bfa_fcport_is_pbcdisabled(bfa)) {\r\nbfa_trc(fcdiag, BFA_STATUS_PBC);\r\nreturn BFA_STATUS_PBC;\r\n}\r\nif (bfa_fcport_is_disabled(bfa) == BFA_FALSE) {\r\nbfa_trc(fcdiag, opmode);\r\nreturn BFA_STATUS_PORT_NOT_DISABLED;\r\n}\r\nif (bfa_ioc_get_type(&bfa->ioc) == BFA_IOC_TYPE_FC) {\r\nif (!(speed == BFA_PORT_SPEED_1GBPS ||\r\nspeed == BFA_PORT_SPEED_2GBPS ||\r\nspeed == BFA_PORT_SPEED_4GBPS ||\r\nspeed == BFA_PORT_SPEED_8GBPS ||\r\nspeed == BFA_PORT_SPEED_16GBPS ||\r\nspeed == BFA_PORT_SPEED_AUTO)) {\r\nbfa_trc(fcdiag, speed);\r\nreturn BFA_STATUS_UNSUPP_SPEED;\r\n}\r\nbfa_fcport_get_attr(bfa, &attr);\r\nbfa_trc(fcdiag, attr.speed_supported);\r\nif (speed > attr.speed_supported)\r\nreturn BFA_STATUS_UNSUPP_SPEED;\r\n} else {\r\nif (speed != BFA_PORT_SPEED_10GBPS) {\r\nbfa_trc(fcdiag, speed);\r\nreturn BFA_STATUS_UNSUPP_SPEED;\r\n}\r\n}\r\nif ((speed == BFA_PORT_SPEED_1GBPS) &&\r\n(bfa_asic_id_ct2(bfa->ioc.pcidev.device_id))) {\r\nbfa_trc(fcdiag, speed);\r\nreturn BFA_STATUS_UNSUPP_SPEED;\r\n}\r\nif (bfa_mfg_is_mezz(bfa->ioc.attr->card_type)) {\r\nif (bfa_ioc_get_type(&bfa->ioc) == BFA_IOC_TYPE_FC) {\r\nif (!(speed == BFA_PORT_SPEED_1GBPS ||\r\nspeed == BFA_PORT_SPEED_2GBPS ||\r\nspeed == BFA_PORT_SPEED_4GBPS ||\r\nspeed == BFA_PORT_SPEED_8GBPS ||\r\nspeed == BFA_PORT_SPEED_16GBPS ||\r\nspeed == BFA_PORT_SPEED_AUTO))\r\nreturn BFA_STATUS_UNSUPP_SPEED;\r\n} else {\r\nif (speed != BFA_PORT_SPEED_10GBPS)\r\nreturn BFA_STATUS_UNSUPP_SPEED;\r\n}\r\n}\r\nif (bfa_fcport_is_dport(bfa)) {\r\nbfa_trc(fcdiag, fcdiag->lb.lock);\r\nreturn BFA_STATUS_DPORT_ENABLED;\r\n}\r\nif (fcdiag->lb.lock) {\r\nbfa_trc(fcdiag, fcdiag->lb.lock);\r\nreturn BFA_STATUS_DEVBUSY;\r\n}\r\nfcdiag->lb.lock = 1;\r\nloopback.lb_mode = opmode;\r\nloopback.speed = speed;\r\nloopback.loopcnt = lpcnt;\r\nloopback.pattern = pat;\r\nfcdiag->lb.result = result;\r\nfcdiag->lb.cbfn = cbfn;\r\nfcdiag->lb.cbarg = cbarg;\r\nmemset(result, 0, sizeof(struct bfa_diag_loopback_result_s));\r\nbfa_fcdiag_set_busy_status(fcdiag);\r\nstatus = bfa_fcdiag_loopback_send(fcdiag, &loopback);\r\nreturn status;\r\n}\r\nbfa_status_t\r\nbfa_fcdiag_queuetest(struct bfa_s *bfa, u32 force, u32 queue,\r\nstruct bfa_diag_qtest_result_s *result, bfa_cb_diag_t cbfn,\r\nvoid *cbarg)\r\n{\r\nstruct bfa_fcdiag_s *fcdiag = BFA_FCDIAG_MOD(bfa);\r\nbfa_status_t status;\r\nbfa_trc(fcdiag, force);\r\nbfa_trc(fcdiag, queue);\r\nif (!force && !bfa_iocfc_is_operational(bfa))\r\nreturn BFA_STATUS_IOC_NON_OP;\r\nif (fcdiag->qtest.lock) {\r\nbfa_trc(fcdiag, fcdiag->qtest.lock);\r\nreturn BFA_STATUS_DEVBUSY;\r\n}\r\nfcdiag->qtest.lock = 1;\r\nfcdiag->qtest.cbfn = cbfn;\r\nfcdiag->qtest.cbarg = cbarg;\r\nfcdiag->qtest.result = result;\r\nfcdiag->qtest.count = QTEST_CNT_DEFAULT;\r\nfcdiag->qtest.result->status = BFA_STATUS_OK;\r\nfcdiag->qtest.result->count = 0;\r\nif (queue < BFI_IOC_MAX_CQS) {\r\nfcdiag->qtest.result->queue = (u8)queue;\r\nfcdiag->qtest.queue = (u8)queue;\r\nfcdiag->qtest.all = 0;\r\n} else {\r\nfcdiag->qtest.result->queue = 0;\r\nfcdiag->qtest.queue = 0;\r\nfcdiag->qtest.all = 1;\r\n}\r\nstatus = bfa_fcdiag_queuetest_send(fcdiag);\r\nif (status == BFA_STATUS_OK) {\r\nbfa_timer_start(bfa, &fcdiag->qtest.timer,\r\nbfa_fcdiag_queuetest_timeout, fcdiag,\r\nBFA_DIAG_QTEST_TOV);\r\nfcdiag->qtest.timer_active = 1;\r\n}\r\nreturn status;\r\n}\r\nbfa_status_t\r\nbfa_fcdiag_lb_is_running(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcdiag_s *fcdiag = BFA_FCDIAG_MOD(bfa);\r\nreturn fcdiag->lb.lock ? BFA_STATUS_DIAG_BUSY : BFA_STATUS_OK;\r\n}\r\nstatic void\r\nbfa_cb_fcdiag_dport(struct bfa_dport_s *dport, bfa_status_t bfa_status)\r\n{\r\nif (dport->cbfn != NULL) {\r\ndport->cbfn(dport->cbarg, bfa_status);\r\ndport->cbfn = NULL;\r\ndport->cbarg = NULL;\r\n}\r\n}\r\nstatic void\r\nbfa_dport_sm_disabled(struct bfa_dport_s *dport, enum bfa_dport_sm_event event)\r\n{\r\nbfa_trc(dport->bfa, event);\r\nswitch (event) {\r\ncase BFA_DPORT_SM_ENABLE:\r\nbfa_fcport_dportenable(dport->bfa);\r\nif (bfa_dport_send_req(dport, BFI_DPORT_ENABLE))\r\nbfa_sm_set_state(dport, bfa_dport_sm_enabling);\r\nelse\r\nbfa_sm_set_state(dport, bfa_dport_sm_enabling_qwait);\r\nbreak;\r\ncase BFA_DPORT_SM_DISABLE:\r\nbreak;\r\ncase BFA_DPORT_SM_HWFAIL:\r\nbreak;\r\ncase BFA_DPORT_SM_SCN:\r\nif (dport->i2hmsg.scn.state == BFI_DPORT_SCN_DDPORT_ENABLE) {\r\nbfa_fcport_ddportenable(dport->bfa);\r\ndport->dynamic = BFA_TRUE;\r\ndport->test_state = BFA_DPORT_ST_NOTSTART;\r\nbfa_sm_set_state(dport, bfa_dport_sm_enabled);\r\n} else {\r\nbfa_trc(dport->bfa, dport->i2hmsg.scn.state);\r\nWARN_ON(1);\r\n}\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(dport->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_dport_sm_enabling_qwait(struct bfa_dport_s *dport,\r\nenum bfa_dport_sm_event event)\r\n{\r\nbfa_trc(dport->bfa, event);\r\nswitch (event) {\r\ncase BFA_DPORT_SM_QRESUME:\r\nbfa_sm_set_state(dport, bfa_dport_sm_enabling);\r\nbfa_dport_send_req(dport, BFI_DPORT_ENABLE);\r\nbreak;\r\ncase BFA_DPORT_SM_HWFAIL:\r\nbfa_reqq_wcancel(&dport->reqq_wait);\r\nbfa_sm_set_state(dport, bfa_dport_sm_disabled);\r\nbfa_cb_fcdiag_dport(dport, BFA_STATUS_FAILED);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(dport->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_dport_sm_enabling(struct bfa_dport_s *dport, enum bfa_dport_sm_event event)\r\n{\r\nbfa_trc(dport->bfa, event);\r\nswitch (event) {\r\ncase BFA_DPORT_SM_FWRSP:\r\nmemset(&dport->result, 0,\r\nsizeof(struct bfa_diag_dport_result_s));\r\nif (dport->i2hmsg.rsp.status == BFA_STATUS_DPORT_INV_SFP) {\r\ndport->test_state = BFA_DPORT_ST_NO_SFP;\r\n} else {\r\ndport->test_state = BFA_DPORT_ST_INP;\r\nbfa_dport_result_start(dport, BFA_DPORT_OPMODE_AUTO);\r\n}\r\nbfa_sm_set_state(dport, bfa_dport_sm_enabled);\r\nbreak;\r\ncase BFA_DPORT_SM_REQFAIL:\r\ndport->test_state = BFA_DPORT_ST_DISABLED;\r\nbfa_fcport_dportdisable(dport->bfa);\r\nbfa_sm_set_state(dport, bfa_dport_sm_disabled);\r\nbreak;\r\ncase BFA_DPORT_SM_HWFAIL:\r\nbfa_sm_set_state(dport, bfa_dport_sm_disabled);\r\nbfa_cb_fcdiag_dport(dport, BFA_STATUS_FAILED);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(dport->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_dport_sm_enabled(struct bfa_dport_s *dport, enum bfa_dport_sm_event event)\r\n{\r\nbfa_trc(dport->bfa, event);\r\nswitch (event) {\r\ncase BFA_DPORT_SM_START:\r\nif (bfa_dport_send_req(dport, BFI_DPORT_START))\r\nbfa_sm_set_state(dport, bfa_dport_sm_starting);\r\nelse\r\nbfa_sm_set_state(dport, bfa_dport_sm_starting_qwait);\r\nbreak;\r\ncase BFA_DPORT_SM_DISABLE:\r\nbfa_fcport_dportdisable(dport->bfa);\r\nif (bfa_dport_send_req(dport, BFI_DPORT_DISABLE))\r\nbfa_sm_set_state(dport, bfa_dport_sm_disabling);\r\nelse\r\nbfa_sm_set_state(dport, bfa_dport_sm_disabling_qwait);\r\nbreak;\r\ncase BFA_DPORT_SM_HWFAIL:\r\nbfa_sm_set_state(dport, bfa_dport_sm_disabled);\r\nbreak;\r\ncase BFA_DPORT_SM_SCN:\r\nswitch (dport->i2hmsg.scn.state) {\r\ncase BFI_DPORT_SCN_TESTCOMP:\r\ndport->test_state = BFA_DPORT_ST_COMP;\r\nbreak;\r\ncase BFI_DPORT_SCN_TESTSTART:\r\ndport->test_state = BFA_DPORT_ST_INP;\r\nbreak;\r\ncase BFI_DPORT_SCN_TESTSKIP:\r\ncase BFI_DPORT_SCN_SUBTESTSTART:\r\nbreak;\r\ncase BFI_DPORT_SCN_SFP_REMOVED:\r\ndport->test_state = BFA_DPORT_ST_NO_SFP;\r\nbreak;\r\ncase BFI_DPORT_SCN_DDPORT_DISABLE:\r\nbfa_fcport_ddportdisable(dport->bfa);\r\nif (bfa_dport_send_req(dport, BFI_DPORT_DYN_DISABLE))\r\nbfa_sm_set_state(dport,\r\nbfa_dport_sm_dynamic_disabling);\r\nelse\r\nbfa_sm_set_state(dport,\r\nbfa_dport_sm_dynamic_disabling_qwait);\r\nbreak;\r\ncase BFI_DPORT_SCN_FCPORT_DISABLE:\r\nbfa_fcport_ddportdisable(dport->bfa);\r\nbfa_sm_set_state(dport, bfa_dport_sm_disabled);\r\ndport->dynamic = BFA_FALSE;\r\nbreak;\r\ndefault:\r\nbfa_trc(dport->bfa, dport->i2hmsg.scn.state);\r\nbfa_sm_fault(dport->bfa, event);\r\n}\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(dport->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_dport_sm_disabling_qwait(struct bfa_dport_s *dport,\r\nenum bfa_dport_sm_event event)\r\n{\r\nbfa_trc(dport->bfa, event);\r\nswitch (event) {\r\ncase BFA_DPORT_SM_QRESUME:\r\nbfa_sm_set_state(dport, bfa_dport_sm_disabling);\r\nbfa_dport_send_req(dport, BFI_DPORT_DISABLE);\r\nbreak;\r\ncase BFA_DPORT_SM_HWFAIL:\r\nbfa_sm_set_state(dport, bfa_dport_sm_disabled);\r\nbfa_reqq_wcancel(&dport->reqq_wait);\r\nbfa_cb_fcdiag_dport(dport, BFA_STATUS_OK);\r\nbreak;\r\ncase BFA_DPORT_SM_SCN:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(dport->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_dport_sm_disabling(struct bfa_dport_s *dport, enum bfa_dport_sm_event event)\r\n{\r\nbfa_trc(dport->bfa, event);\r\nswitch (event) {\r\ncase BFA_DPORT_SM_FWRSP:\r\ndport->test_state = BFA_DPORT_ST_DISABLED;\r\nbfa_sm_set_state(dport, bfa_dport_sm_disabled);\r\nbreak;\r\ncase BFA_DPORT_SM_HWFAIL:\r\nbfa_sm_set_state(dport, bfa_dport_sm_disabled);\r\nbfa_cb_fcdiag_dport(dport, BFA_STATUS_OK);\r\nbreak;\r\ncase BFA_DPORT_SM_SCN:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(dport->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_dport_sm_starting_qwait(struct bfa_dport_s *dport,\r\nenum bfa_dport_sm_event event)\r\n{\r\nbfa_trc(dport->bfa, event);\r\nswitch (event) {\r\ncase BFA_DPORT_SM_QRESUME:\r\nbfa_sm_set_state(dport, bfa_dport_sm_starting);\r\nbfa_dport_send_req(dport, BFI_DPORT_START);\r\nbreak;\r\ncase BFA_DPORT_SM_HWFAIL:\r\nbfa_reqq_wcancel(&dport->reqq_wait);\r\nbfa_sm_set_state(dport, bfa_dport_sm_disabled);\r\nbfa_cb_fcdiag_dport(dport, BFA_STATUS_FAILED);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(dport->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_dport_sm_starting(struct bfa_dport_s *dport, enum bfa_dport_sm_event event)\r\n{\r\nbfa_trc(dport->bfa, event);\r\nswitch (event) {\r\ncase BFA_DPORT_SM_FWRSP:\r\nmemset(&dport->result, 0,\r\nsizeof(struct bfa_diag_dport_result_s));\r\nif (dport->i2hmsg.rsp.status == BFA_STATUS_DPORT_INV_SFP) {\r\ndport->test_state = BFA_DPORT_ST_NO_SFP;\r\n} else {\r\ndport->test_state = BFA_DPORT_ST_INP;\r\nbfa_dport_result_start(dport, BFA_DPORT_OPMODE_MANU);\r\n}\r\ncase BFA_DPORT_SM_REQFAIL:\r\nbfa_sm_set_state(dport, bfa_dport_sm_enabled);\r\nbreak;\r\ncase BFA_DPORT_SM_HWFAIL:\r\nbfa_sm_set_state(dport, bfa_dport_sm_disabled);\r\nbfa_cb_fcdiag_dport(dport, BFA_STATUS_FAILED);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(dport->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_dport_sm_dynamic_disabling(struct bfa_dport_s *dport,\r\nenum bfa_dport_sm_event event)\r\n{\r\nbfa_trc(dport->bfa, event);\r\nswitch (event) {\r\ncase BFA_DPORT_SM_SCN:\r\nswitch (dport->i2hmsg.scn.state) {\r\ncase BFI_DPORT_SCN_DDPORT_DISABLED:\r\nbfa_sm_set_state(dport, bfa_dport_sm_disabled);\r\ndport->dynamic = BFA_FALSE;\r\nbfa_fcport_enable(dport->bfa);\r\nbreak;\r\ndefault:\r\nbfa_trc(dport->bfa, dport->i2hmsg.scn.state);\r\nbfa_sm_fault(dport->bfa, event);\r\n}\r\nbreak;\r\ncase BFA_DPORT_SM_HWFAIL:\r\nbfa_sm_set_state(dport, bfa_dport_sm_disabled);\r\nbfa_cb_fcdiag_dport(dport, BFA_STATUS_OK);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(dport->bfa, event);\r\n}\r\n}\r\nstatic void\r\nbfa_dport_sm_dynamic_disabling_qwait(struct bfa_dport_s *dport,\r\nenum bfa_dport_sm_event event)\r\n{\r\nbfa_trc(dport->bfa, event);\r\nswitch (event) {\r\ncase BFA_DPORT_SM_QRESUME:\r\nbfa_sm_set_state(dport, bfa_dport_sm_dynamic_disabling);\r\nbfa_dport_send_req(dport, BFI_DPORT_DYN_DISABLE);\r\nbreak;\r\ncase BFA_DPORT_SM_HWFAIL:\r\nbfa_sm_set_state(dport, bfa_dport_sm_disabled);\r\nbfa_reqq_wcancel(&dport->reqq_wait);\r\nbfa_cb_fcdiag_dport(dport, BFA_STATUS_OK);\r\nbreak;\r\ncase BFA_DPORT_SM_SCN:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(dport->bfa, event);\r\n}\r\n}\r\nstatic bfa_boolean_t\r\nbfa_dport_send_req(struct bfa_dport_s *dport, enum bfi_dport_req req)\r\n{\r\nstruct bfi_diag_dport_req_s *m;\r\nm = bfa_reqq_next(dport->bfa, BFA_REQQ_DIAG);\r\nif (!m) {\r\nbfa_reqq_wait(dport->bfa, BFA_REQQ_PORT, &dport->reqq_wait);\r\nreturn BFA_FALSE;\r\n}\r\nbfi_h2i_set(m->mh, BFI_MC_DIAG, BFI_DIAG_H2I_DPORT,\r\nbfa_fn_lpu(dport->bfa));\r\nm->req = req;\r\nif ((req == BFI_DPORT_ENABLE) || (req == BFI_DPORT_START)) {\r\nm->lpcnt = cpu_to_be32(dport->lpcnt);\r\nm->payload = cpu_to_be32(dport->payload);\r\n}\r\nbfa_reqq_produce(dport->bfa, BFA_REQQ_DIAG, m->mh);\r\nreturn BFA_TRUE;\r\n}\r\nstatic void\r\nbfa_dport_qresume(void *cbarg)\r\n{\r\nstruct bfa_dport_s *dport = cbarg;\r\nbfa_sm_send_event(dport, BFA_DPORT_SM_QRESUME);\r\n}\r\nstatic void\r\nbfa_dport_req_comp(struct bfa_dport_s *dport, struct bfi_diag_dport_rsp_s *msg)\r\n{\r\nmsg->status = cpu_to_be32(msg->status);\r\ndport->i2hmsg.rsp.status = msg->status;\r\ndport->rp_pwwn = msg->pwwn;\r\ndport->rp_nwwn = msg->nwwn;\r\nif ((msg->status == BFA_STATUS_OK) ||\r\n(msg->status == BFA_STATUS_DPORT_NO_SFP)) {\r\nbfa_trc(dport->bfa, msg->status);\r\nbfa_trc(dport->bfa, dport->rp_pwwn);\r\nbfa_trc(dport->bfa, dport->rp_nwwn);\r\nbfa_sm_send_event(dport, BFA_DPORT_SM_FWRSP);\r\n} else {\r\nbfa_trc(dport->bfa, msg->status);\r\nbfa_sm_send_event(dport, BFA_DPORT_SM_REQFAIL);\r\n}\r\nbfa_cb_fcdiag_dport(dport, msg->status);\r\n}\r\nstatic bfa_boolean_t\r\nbfa_dport_is_sending_req(struct bfa_dport_s *dport)\r\n{\r\nif (bfa_sm_cmp_state(dport, bfa_dport_sm_enabling) ||\r\nbfa_sm_cmp_state(dport, bfa_dport_sm_enabling_qwait) ||\r\nbfa_sm_cmp_state(dport, bfa_dport_sm_disabling) ||\r\nbfa_sm_cmp_state(dport, bfa_dport_sm_disabling_qwait) ||\r\nbfa_sm_cmp_state(dport, bfa_dport_sm_starting) ||\r\nbfa_sm_cmp_state(dport, bfa_dport_sm_starting_qwait)) {\r\nreturn BFA_TRUE;\r\n} else {\r\nreturn BFA_FALSE;\r\n}\r\n}\r\nstatic void\r\nbfa_dport_scn(struct bfa_dport_s *dport, struct bfi_diag_dport_scn_s *msg)\r\n{\r\nint i;\r\nuint8_t subtesttype;\r\nbfa_trc(dport->bfa, msg->state);\r\ndport->i2hmsg.scn.state = msg->state;\r\nswitch (dport->i2hmsg.scn.state) {\r\ncase BFI_DPORT_SCN_TESTCOMP:\r\ndport->result.end_time = bfa_get_log_time();\r\nbfa_trc(dport->bfa, dport->result.end_time);\r\ndport->result.status = msg->info.testcomp.status;\r\nbfa_trc(dport->bfa, dport->result.status);\r\ndport->result.roundtrip_latency =\r\ncpu_to_be32(msg->info.testcomp.latency);\r\ndport->result.est_cable_distance =\r\ncpu_to_be32(msg->info.testcomp.distance);\r\ndport->result.buffer_required =\r\nbe16_to_cpu(msg->info.testcomp.numbuffer);\r\ndport->result.frmsz = be16_to_cpu(msg->info.testcomp.frm_sz);\r\ndport->result.speed = msg->info.testcomp.speed;\r\nbfa_trc(dport->bfa, dport->result.roundtrip_latency);\r\nbfa_trc(dport->bfa, dport->result.est_cable_distance);\r\nbfa_trc(dport->bfa, dport->result.buffer_required);\r\nbfa_trc(dport->bfa, dport->result.frmsz);\r\nbfa_trc(dport->bfa, dport->result.speed);\r\nfor (i = DPORT_TEST_ELOOP; i < DPORT_TEST_MAX; i++) {\r\ndport->result.subtest[i].status =\r\nmsg->info.testcomp.subtest_status[i];\r\nbfa_trc(dport->bfa, dport->result.subtest[i].status);\r\n}\r\nbreak;\r\ncase BFI_DPORT_SCN_TESTSKIP:\r\ncase BFI_DPORT_SCN_DDPORT_ENABLE:\r\nmemset(&dport->result, 0,\r\nsizeof(struct bfa_diag_dport_result_s));\r\nbreak;\r\ncase BFI_DPORT_SCN_TESTSTART:\r\nmemset(&dport->result, 0,\r\nsizeof(struct bfa_diag_dport_result_s));\r\ndport->rp_pwwn = msg->info.teststart.pwwn;\r\ndport->rp_nwwn = msg->info.teststart.nwwn;\r\ndport->lpcnt = cpu_to_be32(msg->info.teststart.numfrm);\r\nbfa_dport_result_start(dport, BFA_DPORT_OPMODE_AUTO);\r\nbreak;\r\ncase BFI_DPORT_SCN_SUBTESTSTART:\r\nsubtesttype = msg->info.teststart.type;\r\ndport->result.subtest[subtesttype].start_time =\r\nbfa_get_log_time();\r\ndport->result.subtest[subtesttype].status =\r\nDPORT_TEST_ST_INPRG;\r\nbfa_trc(dport->bfa, subtesttype);\r\nbfa_trc(dport->bfa,\r\ndport->result.subtest[subtesttype].start_time);\r\nbreak;\r\ncase BFI_DPORT_SCN_SFP_REMOVED:\r\ncase BFI_DPORT_SCN_DDPORT_DISABLED:\r\ncase BFI_DPORT_SCN_DDPORT_DISABLE:\r\ncase BFI_DPORT_SCN_FCPORT_DISABLE:\r\ndport->result.status = DPORT_TEST_ST_IDLE;\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(dport->bfa, msg->state);\r\n}\r\nbfa_sm_send_event(dport, BFA_DPORT_SM_SCN);\r\n}\r\nbfa_status_t\r\nbfa_dport_enable(struct bfa_s *bfa, u32 lpcnt, u32 pat,\r\nbfa_cb_diag_t cbfn, void *cbarg)\r\n{\r\nstruct bfa_fcdiag_s *fcdiag = BFA_FCDIAG_MOD(bfa);\r\nstruct bfa_dport_s *dport = &fcdiag->dport;\r\nif (bfa_mfg_is_mezz(dport->bfa->ioc.attr->card_type)) {\r\nbfa_trc(dport->bfa, BFA_STATUS_PBC);\r\nreturn BFA_STATUS_CMD_NOTSUPP_MEZZ;\r\n}\r\nif (!(bfa_asic_id_ct2(dport->bfa->ioc.pcidev.device_id))) {\r\nbfa_trc(dport->bfa, dport->bfa->ioc.pcidev.device_id);\r\nreturn BFA_STATUS_FEATURE_NOT_SUPPORTED;\r\n}\r\nif (!bfa_iocfc_is_operational(bfa))\r\nreturn BFA_STATUS_IOC_NON_OP;\r\nif (bfa_fcport_is_pbcdisabled(bfa)) {\r\nbfa_trc(dport->bfa, BFA_STATUS_PBC);\r\nreturn BFA_STATUS_PBC;\r\n}\r\nif (bfa_ioc_get_type(&bfa->ioc) != BFA_IOC_TYPE_FC) {\r\nbfa_trc(dport->bfa, bfa_ioc_get_type(&bfa->ioc));\r\nreturn BFA_STATUS_CMD_NOTSUPP_CNA;\r\n}\r\nif ((bfa_fcport_get_cfg_topology(bfa) == BFA_PORT_TOPOLOGY_LOOP) ||\r\n(bfa_fcport_get_topology(bfa) == BFA_PORT_TOPOLOGY_LOOP)) {\r\nbfa_trc(dport->bfa, 0);\r\nreturn BFA_STATUS_TOPOLOGY_LOOP;\r\n}\r\nif (bfa_fcport_is_trunk_enabled(bfa)) {\r\nbfa_trc(dport->bfa, 0);\r\nreturn BFA_STATUS_ERROR_TRUNK_ENABLED;\r\n}\r\nif (bfa_fcdiag_lb_is_running(bfa)) {\r\nbfa_trc(dport->bfa, 0);\r\nreturn BFA_STATUS_DIAG_BUSY;\r\n}\r\nif ((bfa_fcport_is_disabled(bfa) == BFA_FALSE) &&\r\n(bfa_fcport_is_dport(bfa) == BFA_FALSE)) {\r\nbfa_trc(dport->bfa, 0);\r\nreturn BFA_STATUS_PORT_NOT_DISABLED;\r\n}\r\nif (dport->dynamic)\r\nreturn BFA_STATUS_DDPORT_ERR;\r\nif (bfa_dport_is_sending_req(dport))\r\nreturn BFA_STATUS_DEVBUSY;\r\nif (bfa_sm_cmp_state(dport, bfa_dport_sm_enabled)) {\r\nbfa_trc(dport->bfa, 0);\r\nreturn BFA_STATUS_DPORT_ENABLED;\r\n}\r\nbfa_trc(dport->bfa, lpcnt);\r\nbfa_trc(dport->bfa, pat);\r\ndport->lpcnt = (lpcnt) ? lpcnt : DPORT_ENABLE_LOOPCNT_DEFAULT;\r\ndport->payload = (pat) ? pat : LB_PATTERN_DEFAULT;\r\ndport->cbfn = cbfn;\r\ndport->cbarg = cbarg;\r\nbfa_sm_send_event(dport, BFA_DPORT_SM_ENABLE);\r\nreturn BFA_STATUS_OK;\r\n}\r\nbfa_status_t\r\nbfa_dport_disable(struct bfa_s *bfa, bfa_cb_diag_t cbfn, void *cbarg)\r\n{\r\nstruct bfa_fcdiag_s *fcdiag = BFA_FCDIAG_MOD(bfa);\r\nstruct bfa_dport_s *dport = &fcdiag->dport;\r\nif (bfa_ioc_is_disabled(&bfa->ioc))\r\nreturn BFA_STATUS_IOC_DISABLED;\r\nif (bfa_fcport_is_pbcdisabled(bfa)) {\r\nbfa_trc(dport->bfa, BFA_STATUS_PBC);\r\nreturn BFA_STATUS_PBC;\r\n}\r\nif (dport->dynamic) {\r\nreturn BFA_STATUS_DDPORT_ERR;\r\n}\r\nif ((bfa_fcport_is_disabled(bfa) == BFA_FALSE) &&\r\n(bfa_fcport_is_dport(bfa) == BFA_FALSE)) {\r\nbfa_trc(dport->bfa, 0);\r\nreturn BFA_STATUS_PORT_NOT_DISABLED;\r\n}\r\nif (bfa_dport_is_sending_req(dport))\r\nreturn BFA_STATUS_DEVBUSY;\r\nif (bfa_sm_cmp_state(dport, bfa_dport_sm_disabled)) {\r\nbfa_trc(dport->bfa, 0);\r\nreturn BFA_STATUS_DPORT_DISABLED;\r\n}\r\ndport->cbfn = cbfn;\r\ndport->cbarg = cbarg;\r\nbfa_sm_send_event(dport, BFA_DPORT_SM_DISABLE);\r\nreturn BFA_STATUS_OK;\r\n}\r\nbfa_status_t\r\nbfa_dport_start(struct bfa_s *bfa, u32 lpcnt, u32 pat,\r\nbfa_cb_diag_t cbfn, void *cbarg)\r\n{\r\nstruct bfa_fcdiag_s *fcdiag = BFA_FCDIAG_MOD(bfa);\r\nstruct bfa_dport_s *dport = &fcdiag->dport;\r\nif (!bfa_iocfc_is_operational(bfa))\r\nreturn BFA_STATUS_IOC_NON_OP;\r\nif (dport->dynamic)\r\nreturn BFA_STATUS_DDPORT_ERR;\r\nif (bfa_dport_is_sending_req(dport))\r\nreturn BFA_STATUS_DEVBUSY;\r\nif (!bfa_sm_cmp_state(dport, bfa_dport_sm_enabled)) {\r\nbfa_trc(dport->bfa, 0);\r\nreturn BFA_STATUS_DPORT_DISABLED;\r\n} else {\r\nif (dport->test_state == BFA_DPORT_ST_NO_SFP)\r\nreturn BFA_STATUS_DPORT_INV_SFP;\r\nif (dport->test_state == BFA_DPORT_ST_INP)\r\nreturn BFA_STATUS_DEVBUSY;\r\nWARN_ON(dport->test_state != BFA_DPORT_ST_COMP);\r\n}\r\nbfa_trc(dport->bfa, lpcnt);\r\nbfa_trc(dport->bfa, pat);\r\ndport->lpcnt = (lpcnt) ? lpcnt : DPORT_ENABLE_LOOPCNT_DEFAULT;\r\ndport->payload = (pat) ? pat : LB_PATTERN_DEFAULT;\r\ndport->cbfn = cbfn;\r\ndport->cbarg = cbarg;\r\nbfa_sm_send_event(dport, BFA_DPORT_SM_START);\r\nreturn BFA_STATUS_OK;\r\n}\r\nbfa_status_t\r\nbfa_dport_show(struct bfa_s *bfa, struct bfa_diag_dport_result_s *result)\r\n{\r\nstruct bfa_fcdiag_s *fcdiag = BFA_FCDIAG_MOD(bfa);\r\nstruct bfa_dport_s *dport = &fcdiag->dport;\r\nif (!bfa_iocfc_is_operational(bfa))\r\nreturn BFA_STATUS_IOC_NON_OP;\r\nif (bfa_dport_is_sending_req(dport))\r\nreturn BFA_STATUS_DEVBUSY;\r\nif (!bfa_sm_cmp_state(dport, bfa_dport_sm_enabled)) {\r\nbfa_trc(dport->bfa, 0);\r\nreturn BFA_STATUS_DPORT_DISABLED;\r\n}\r\nif (dport->test_state == BFA_DPORT_ST_NO_SFP)\r\nreturn BFA_STATUS_DPORT_INV_SFP;\r\nmemcpy(result, &dport->result, sizeof(struct bfa_diag_dport_result_s));\r\nreturn BFA_STATUS_OK;\r\n}

static int pla_read_word(struct usb_device *udev, u16 index)\r\n{\r\nint ret;\r\nu8 shift = index & 2;\r\n__le32 *tmp;\r\ntmp = kmalloc(sizeof(*tmp), GFP_KERNEL);\r\nif (!tmp)\r\nreturn -ENOMEM;\r\nindex &= ~3;\r\nret = usb_control_msg(udev, usb_rcvctrlpipe(udev, 0),\r\nRTL815x_REQ_GET_REGS, RTL815x_REQT_READ,\r\nindex, MCU_TYPE_PLA, tmp, sizeof(*tmp), 500);\r\nif (ret < 0)\r\ngoto out2;\r\nret = __le32_to_cpu(*tmp);\r\nret >>= (shift * 8);\r\nret &= 0xffff;\r\nout2:\r\nkfree(tmp);\r\nreturn ret;\r\n}\r\nstatic int pla_write_word(struct usb_device *udev, u16 index, u32 data)\r\n{\r\n__le32 *tmp;\r\nu32 mask = 0xffff;\r\nu16 byen = BYTE_EN_WORD;\r\nu8 shift = index & 2;\r\nint ret;\r\ntmp = kmalloc(sizeof(*tmp), GFP_KERNEL);\r\nif (!tmp)\r\nreturn -ENOMEM;\r\ndata &= mask;\r\nif (shift) {\r\nbyen <<= shift;\r\nmask <<= (shift * 8);\r\ndata <<= (shift * 8);\r\nindex &= ~3;\r\n}\r\nret = usb_control_msg(udev, usb_rcvctrlpipe(udev, 0),\r\nRTL815x_REQ_GET_REGS, RTL815x_REQT_READ,\r\nindex, MCU_TYPE_PLA, tmp, sizeof(*tmp), 500);\r\nif (ret < 0)\r\ngoto out3;\r\ndata |= __le32_to_cpu(*tmp) & ~mask;\r\n*tmp = __cpu_to_le32(data);\r\nret = usb_control_msg(udev, usb_sndctrlpipe(udev, 0),\r\nRTL815x_REQ_SET_REGS, RTL815x_REQT_WRITE,\r\nindex, MCU_TYPE_PLA | byen, tmp, sizeof(*tmp),\r\n500);\r\nout3:\r\nkfree(tmp);\r\nreturn ret;\r\n}\r\nstatic int ocp_reg_read(struct usbnet *dev, u16 addr)\r\n{\r\nu16 ocp_base, ocp_index;\r\nint ret;\r\nocp_base = addr & 0xf000;\r\nret = pla_write_word(dev->udev, OCP_BASE, ocp_base);\r\nif (ret < 0)\r\ngoto out;\r\nocp_index = (addr & 0x0fff) | 0xb000;\r\nret = pla_read_word(dev->udev, ocp_index);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int ocp_reg_write(struct usbnet *dev, u16 addr, u16 data)\r\n{\r\nu16 ocp_base, ocp_index;\r\nint ret;\r\nocp_base = addr & 0xf000;\r\nret = pla_write_word(dev->udev, OCP_BASE, ocp_base);\r\nif (ret < 0)\r\ngoto out1;\r\nocp_index = (addr & 0x0fff) | 0xb000;\r\nret = pla_write_word(dev->udev, ocp_index, data);\r\nout1:\r\nreturn ret;\r\n}\r\nstatic int r815x_mdio_read(struct net_device *netdev, int phy_id, int reg)\r\n{\r\nstruct usbnet *dev = netdev_priv(netdev);\r\nint ret;\r\nif (phy_id != R815x_PHY_ID)\r\nreturn -EINVAL;\r\nif (usb_autopm_get_interface(dev->intf) < 0)\r\nreturn -ENODEV;\r\nret = ocp_reg_read(dev, BASE_MII + reg * 2);\r\nusb_autopm_put_interface(dev->intf);\r\nreturn ret;\r\n}\r\nstatic\r\nvoid r815x_mdio_write(struct net_device *netdev, int phy_id, int reg, int val)\r\n{\r\nstruct usbnet *dev = netdev_priv(netdev);\r\nif (phy_id != R815x_PHY_ID)\r\nreturn;\r\nif (usb_autopm_get_interface(dev->intf) < 0)\r\nreturn;\r\nocp_reg_write(dev, BASE_MII + reg * 2, val);\r\nusb_autopm_put_interface(dev->intf);\r\n}\r\nstatic int r8153_bind(struct usbnet *dev, struct usb_interface *intf)\r\n{\r\nint status;\r\nstatus = usbnet_cdc_bind(dev, intf);\r\nif (status < 0)\r\nreturn status;\r\ndev->mii.dev = dev->net;\r\ndev->mii.mdio_read = r815x_mdio_read;\r\ndev->mii.mdio_write = r815x_mdio_write;\r\ndev->mii.phy_id_mask = 0x3f;\r\ndev->mii.reg_num_mask = 0x1f;\r\ndev->mii.phy_id = R815x_PHY_ID;\r\ndev->mii.supports_gmii = 1;\r\nreturn status;\r\n}\r\nstatic int r8152_bind(struct usbnet *dev, struct usb_interface *intf)\r\n{\r\nint status;\r\nstatus = usbnet_cdc_bind(dev, intf);\r\nif (status < 0)\r\nreturn status;\r\ndev->mii.dev = dev->net;\r\ndev->mii.mdio_read = r815x_mdio_read;\r\ndev->mii.mdio_write = r815x_mdio_write;\r\ndev->mii.phy_id_mask = 0x3f;\r\ndev->mii.reg_num_mask = 0x1f;\r\ndev->mii.phy_id = R815x_PHY_ID;\r\ndev->mii.supports_gmii = 0;\r\nreturn status;\r\n}

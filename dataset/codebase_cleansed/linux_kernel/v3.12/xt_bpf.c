static int bpf_mt_check(const struct xt_mtchk_param *par)\r\n{\r\nstruct xt_bpf_info *info = par->matchinfo;\r\nstruct sock_fprog program;\r\nprogram.len = info->bpf_program_num_elem;\r\nprogram.filter = (struct sock_filter __user *) info->bpf_program;\r\nif (sk_unattached_filter_create(&info->filter, &program)) {\r\npr_info("bpf: check failed: parse error\n");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic bool bpf_mt(const struct sk_buff *skb, struct xt_action_param *par)\r\n{\r\nconst struct xt_bpf_info *info = par->matchinfo;\r\nreturn SK_RUN_FILTER(info->filter, skb);\r\n}\r\nstatic void bpf_mt_destroy(const struct xt_mtdtor_param *par)\r\n{\r\nconst struct xt_bpf_info *info = par->matchinfo;\r\nsk_unattached_filter_destroy(info->filter);\r\n}\r\nstatic int __init bpf_mt_init(void)\r\n{\r\nreturn xt_register_match(&bpf_mt_reg);\r\n}\r\nstatic void __exit bpf_mt_exit(void)\r\n{\r\nxt_unregister_match(&bpf_mt_reg);\r\n}

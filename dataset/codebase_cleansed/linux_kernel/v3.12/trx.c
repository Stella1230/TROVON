static u8 _rtl92de_map_hwqueue_to_fwqueue(struct sk_buff *skb, u8 hw_queue)\r\n{\r\n__le16 fc = rtl_get_fc(skb);\r\nif (unlikely(ieee80211_is_beacon(fc)))\r\nreturn QSLT_BEACON;\r\nif (ieee80211_is_mgmt(fc))\r\nreturn QSLT_MGNT;\r\nreturn skb->priority;\r\n}\r\nstatic u8 _rtl92d_query_rxpwrpercentage(char antpower)\r\n{\r\nif ((antpower <= -100) || (antpower >= 20))\r\nreturn 0;\r\nelse if (antpower >= 0)\r\nreturn 100;\r\nelse\r\nreturn 100 + antpower;\r\n}\r\nstatic u8 _rtl92d_evm_db_to_percentage(char value)\r\n{\r\nchar ret_val = value;\r\nif (ret_val >= 0)\r\nret_val = 0;\r\nif (ret_val <= -33)\r\nret_val = -33;\r\nret_val = 0 - ret_val;\r\nret_val *= 3;\r\nif (ret_val == 99)\r\nret_val = 100;\r\nreturn ret_val;\r\n}\r\nstatic long _rtl92de_translate_todbm(struct ieee80211_hw *hw,\r\nu8 signal_strength_index)\r\n{\r\nlong signal_power;\r\nsignal_power = (long)((signal_strength_index + 1) >> 1);\r\nsignal_power -= 95;\r\nreturn signal_power;\r\n}\r\nstatic long _rtl92de_signal_scale_mapping(struct ieee80211_hw *hw, long currsig)\r\n{\r\nlong retsig;\r\nif (currsig >= 61 && currsig <= 100)\r\nretsig = 90 + ((currsig - 60) / 4);\r\nelse if (currsig >= 41 && currsig <= 60)\r\nretsig = 78 + ((currsig - 40) / 2);\r\nelse if (currsig >= 31 && currsig <= 40)\r\nretsig = 66 + (currsig - 30);\r\nelse if (currsig >= 21 && currsig <= 30)\r\nretsig = 54 + (currsig - 20);\r\nelse if (currsig >= 5 && currsig <= 20)\r\nretsig = 42 + (((currsig - 5) * 2) / 3);\r\nelse if (currsig == 4)\r\nretsig = 36;\r\nelse if (currsig == 3)\r\nretsig = 27;\r\nelse if (currsig == 2)\r\nretsig = 18;\r\nelse if (currsig == 1)\r\nretsig = 9;\r\nelse\r\nretsig = currsig;\r\nreturn retsig;\r\n}\r\nstatic void _rtl92de_query_rxphystatus(struct ieee80211_hw *hw,\r\nstruct rtl_stats *pstats,\r\nstruct rx_desc_92d *pdesc,\r\nstruct rx_fwinfo_92d *p_drvinfo,\r\nbool packet_match_bssid,\r\nbool packet_toself,\r\nbool packet_beacon)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_ps_ctl *ppsc = rtl_psc(rtlpriv);\r\nstruct phy_sts_cck_8192d *cck_buf;\r\ns8 rx_pwr_all, rx_pwr[4];\r\nu8 rf_rx_num = 0, evm, pwdb_all;\r\nu8 i, max_spatial_stream;\r\nu32 rssi, total_rssi = 0;\r\nbool is_cck_rate;\r\nis_cck_rate = RX_HAL_IS_CCK_RATE(pdesc);\r\npstats->packet_matchbssid = packet_match_bssid;\r\npstats->packet_toself = packet_toself;\r\npstats->packet_beacon = packet_beacon;\r\npstats->is_cck = is_cck_rate;\r\npstats->rx_mimo_sig_qual[0] = -1;\r\npstats->rx_mimo_sig_qual[1] = -1;\r\nif (is_cck_rate) {\r\nu8 report, cck_highpwr;\r\ncck_buf = (struct phy_sts_cck_8192d *)p_drvinfo;\r\nif (ppsc->rfpwr_state == ERFON)\r\ncck_highpwr = (u8) rtl_get_bbreg(hw,\r\nRFPGA0_XA_HSSIPARAMETER2,\r\nBIT(9));\r\nelse\r\ncck_highpwr = false;\r\nif (!cck_highpwr) {\r\nu8 cck_agc_rpt = cck_buf->cck_agc_rpt;\r\nreport = cck_buf->cck_agc_rpt & 0xc0;\r\nreport = report >> 6;\r\nswitch (report) {\r\ncase 0x3:\r\nrx_pwr_all = -46 - (cck_agc_rpt & 0x3e);\r\nbreak;\r\ncase 0x2:\r\nrx_pwr_all = -26 - (cck_agc_rpt & 0x3e);\r\nbreak;\r\ncase 0x1:\r\nrx_pwr_all = -12 - (cck_agc_rpt & 0x3e);\r\nbreak;\r\ncase 0x0:\r\nrx_pwr_all = 16 - (cck_agc_rpt & 0x3e);\r\nbreak;\r\n}\r\n} else {\r\nu8 cck_agc_rpt = cck_buf->cck_agc_rpt;\r\nreport = p_drvinfo->cfosho[0] & 0x60;\r\nreport = report >> 5;\r\nswitch (report) {\r\ncase 0x3:\r\nrx_pwr_all = -46 - ((cck_agc_rpt & 0x1f) << 1);\r\nbreak;\r\ncase 0x2:\r\nrx_pwr_all = -26 - ((cck_agc_rpt & 0x1f) << 1);\r\nbreak;\r\ncase 0x1:\r\nrx_pwr_all = -12 - ((cck_agc_rpt & 0x1f) << 1);\r\nbreak;\r\ncase 0x0:\r\nrx_pwr_all = 16 - ((cck_agc_rpt & 0x1f) << 1);\r\nbreak;\r\n}\r\n}\r\npwdb_all = _rtl92d_query_rxpwrpercentage(rx_pwr_all);\r\npwdb_all += 6;\r\nif (pwdb_all > 100)\r\npwdb_all = 100;\r\nif (pwdb_all > 34 && pwdb_all <= 42)\r\npwdb_all -= 2;\r\nelse if (pwdb_all > 26 && pwdb_all <= 34)\r\npwdb_all -= 6;\r\nelse if (pwdb_all > 14 && pwdb_all <= 26)\r\npwdb_all -= 8;\r\nelse if (pwdb_all > 4 && pwdb_all <= 14)\r\npwdb_all -= 4;\r\npstats->rx_pwdb_all = pwdb_all;\r\npstats->recvsignalpower = rx_pwr_all;\r\nif (packet_match_bssid) {\r\nu8 sq;\r\nif (pstats->rx_pwdb_all > 40) {\r\nsq = 100;\r\n} else {\r\nsq = cck_buf->sq_rpt;\r\nif (sq > 64)\r\nsq = 0;\r\nelse if (sq < 20)\r\nsq = 100;\r\nelse\r\nsq = ((64 - sq) * 100) / 44;\r\n}\r\npstats->signalquality = sq;\r\npstats->rx_mimo_sig_qual[0] = sq;\r\npstats->rx_mimo_sig_qual[1] = -1;\r\n}\r\n} else {\r\nrtlpriv->dm.rfpath_rxenable[0] = true;\r\nrtlpriv->dm.rfpath_rxenable[1] = true;\r\nfor (i = RF90_PATH_A; i < RF6052_MAX_PATH; i++) {\r\nif (rtlpriv->dm.rfpath_rxenable[i])\r\nrf_rx_num++;\r\nrx_pwr[i] = ((p_drvinfo->gain_trsw[i] & 0x3f) * 2)\r\n- 110;\r\nrssi = _rtl92d_query_rxpwrpercentage(rx_pwr[i]);\r\ntotal_rssi += rssi;\r\nrtlpriv->stats.rx_snr_db[i] =\r\n(long)(p_drvinfo->rxsnr[i] / 2);\r\nif (packet_match_bssid)\r\npstats->rx_mimo_signalstrength[i] = (u8) rssi;\r\n}\r\nrx_pwr_all = ((p_drvinfo->pwdb_all >> 1) & 0x7f) - 106;\r\npwdb_all = _rtl92d_query_rxpwrpercentage(rx_pwr_all);\r\npstats->rx_pwdb_all = pwdb_all;\r\npstats->rxpower = rx_pwr_all;\r\npstats->recvsignalpower = rx_pwr_all;\r\nif (pdesc->rxht && pdesc->rxmcs >= DESC92_RATEMCS8 &&\r\npdesc->rxmcs <= DESC92_RATEMCS15)\r\nmax_spatial_stream = 2;\r\nelse\r\nmax_spatial_stream = 1;\r\nfor (i = 0; i < max_spatial_stream; i++) {\r\nevm = _rtl92d_evm_db_to_percentage(p_drvinfo->rxevm[i]);\r\nif (packet_match_bssid) {\r\nif (i == 0)\r\npstats->signalquality =\r\n(u8)(evm & 0xff);\r\npstats->rx_mimo_sig_qual[i] =\r\n(u8)(evm & 0xff);\r\n}\r\n}\r\n}\r\nif (is_cck_rate)\r\npstats->signalstrength = (u8)(_rtl92de_signal_scale_mapping(hw,\r\npwdb_all));\r\nelse if (rf_rx_num != 0)\r\npstats->signalstrength = (u8)(_rtl92de_signal_scale_mapping(hw,\r\ntotal_rssi /= rf_rx_num));\r\n}\r\nstatic void rtl92d_loop_over_paths(struct ieee80211_hw *hw,\r\nstruct rtl_stats *pstats)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_phy *rtlphy = &(rtlpriv->phy);\r\nu8 rfpath;\r\nfor (rfpath = RF90_PATH_A; rfpath < rtlphy->num_total_rfpath;\r\nrfpath++) {\r\nif (rtlpriv->stats.rx_rssi_percentage[rfpath] == 0) {\r\nrtlpriv->stats.rx_rssi_percentage[rfpath] =\r\npstats->rx_mimo_signalstrength[rfpath];\r\n}\r\nif (pstats->rx_mimo_signalstrength[rfpath] >\r\nrtlpriv->stats.rx_rssi_percentage[rfpath]) {\r\nrtlpriv->stats.rx_rssi_percentage[rfpath] =\r\n((rtlpriv->stats.rx_rssi_percentage[rfpath] *\r\n(RX_SMOOTH_FACTOR - 1)) +\r\n(pstats->rx_mimo_signalstrength[rfpath])) /\r\n(RX_SMOOTH_FACTOR);\r\nrtlpriv->stats.rx_rssi_percentage[rfpath] =\r\nrtlpriv->stats.rx_rssi_percentage[rfpath] + 1;\r\n} else {\r\nrtlpriv->stats.rx_rssi_percentage[rfpath] =\r\n((rtlpriv->stats.rx_rssi_percentage[rfpath] *\r\n(RX_SMOOTH_FACTOR - 1)) +\r\n(pstats->rx_mimo_signalstrength[rfpath])) /\r\n(RX_SMOOTH_FACTOR);\r\n}\r\n}\r\n}\r\nstatic void _rtl92de_process_ui_rssi(struct ieee80211_hw *hw,\r\nstruct rtl_stats *pstats)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nu32 last_rssi, tmpval;\r\nif (pstats->packet_toself || pstats->packet_beacon) {\r\nrtlpriv->stats.rssi_calculate_cnt++;\r\nif (rtlpriv->stats.ui_rssi.total_num++ >=\r\nPHY_RSSI_SLID_WIN_MAX) {\r\nrtlpriv->stats.ui_rssi.total_num =\r\nPHY_RSSI_SLID_WIN_MAX;\r\nlast_rssi = rtlpriv->stats.ui_rssi.elements[\r\nrtlpriv->stats.ui_rssi.index];\r\nrtlpriv->stats.ui_rssi.total_val -= last_rssi;\r\n}\r\nrtlpriv->stats.ui_rssi.total_val += pstats->signalstrength;\r\nrtlpriv->stats.ui_rssi.elements\r\n[rtlpriv->stats.ui_rssi.index++] =\r\npstats->signalstrength;\r\nif (rtlpriv->stats.ui_rssi.index >= PHY_RSSI_SLID_WIN_MAX)\r\nrtlpriv->stats.ui_rssi.index = 0;\r\ntmpval = rtlpriv->stats.ui_rssi.total_val /\r\nrtlpriv->stats.ui_rssi.total_num;\r\nrtlpriv->stats.signal_strength = _rtl92de_translate_todbm(hw,\r\n(u8) tmpval);\r\npstats->rssi = rtlpriv->stats.signal_strength;\r\n}\r\nif (!pstats->is_cck && pstats->packet_toself)\r\nrtl92d_loop_over_paths(hw, pstats);\r\n}\r\nstatic void _rtl92de_update_rxsignalstatistics(struct ieee80211_hw *hw,\r\nstruct rtl_stats *pstats)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nint weighting = 0;\r\nif (rtlpriv->stats.recv_signal_power == 0)\r\nrtlpriv->stats.recv_signal_power = pstats->recvsignalpower;\r\nif (pstats->recvsignalpower > rtlpriv->stats.recv_signal_power)\r\nweighting = 5;\r\nelse if (pstats->recvsignalpower < rtlpriv->stats.recv_signal_power)\r\nweighting = (-5);\r\nrtlpriv->stats.recv_signal_power = (rtlpriv->stats.recv_signal_power *\r\n5 + pstats->recvsignalpower + weighting) / 6;\r\n}\r\nstatic void _rtl92de_process_pwdb(struct ieee80211_hw *hw,\r\nstruct rtl_stats *pstats)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_mac *mac = rtl_mac(rtl_priv(hw));\r\nlong undec_sm_pwdb;\r\nif (mac->opmode == NL80211_IFTYPE_ADHOC ||\r\nmac->opmode == NL80211_IFTYPE_AP)\r\nreturn;\r\nelse\r\nundec_sm_pwdb = rtlpriv->dm.undec_sm_pwdb;\r\nif (pstats->packet_toself || pstats->packet_beacon) {\r\nif (undec_sm_pwdb < 0)\r\nundec_sm_pwdb = pstats->rx_pwdb_all;\r\nif (pstats->rx_pwdb_all > (u32) undec_sm_pwdb) {\r\nundec_sm_pwdb = (((undec_sm_pwdb) *\r\n(RX_SMOOTH_FACTOR - 1)) +\r\n(pstats->rx_pwdb_all)) / (RX_SMOOTH_FACTOR);\r\nundec_sm_pwdb = undec_sm_pwdb + 1;\r\n} else {\r\nundec_sm_pwdb = (((undec_sm_pwdb) *\r\n(RX_SMOOTH_FACTOR - 1)) +\r\n(pstats->rx_pwdb_all)) / (RX_SMOOTH_FACTOR);\r\n}\r\nrtlpriv->dm.undec_sm_pwdb = undec_sm_pwdb;\r\n_rtl92de_update_rxsignalstatistics(hw, pstats);\r\n}\r\n}\r\nstatic void rtl92d_loop_over_streams(struct ieee80211_hw *hw,\r\nstruct rtl_stats *pstats)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nint stream;\r\nfor (stream = 0; stream < 2; stream++) {\r\nif (pstats->rx_mimo_sig_qual[stream] != -1) {\r\nif (rtlpriv->stats.rx_evm_percentage[stream] == 0) {\r\nrtlpriv->stats.rx_evm_percentage[stream] =\r\npstats->rx_mimo_sig_qual[stream];\r\n}\r\nrtlpriv->stats.rx_evm_percentage[stream] =\r\n((rtlpriv->stats.rx_evm_percentage[stream]\r\n* (RX_SMOOTH_FACTOR - 1)) +\r\n(pstats->rx_mimo_sig_qual[stream] * 1)) /\r\n(RX_SMOOTH_FACTOR);\r\n}\r\n}\r\n}\r\nstatic void _rtl92de_process_ui_link_quality(struct ieee80211_hw *hw,\r\nstruct rtl_stats *pstats)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nu32 last_evm, tmpval;\r\nif (pstats->signalquality == 0)\r\nreturn;\r\nif (pstats->packet_toself || pstats->packet_beacon) {\r\nif (rtlpriv->stats.ui_link_quality.total_num++ >=\r\nPHY_LINKQUALITY_SLID_WIN_MAX) {\r\nrtlpriv->stats.ui_link_quality.total_num =\r\nPHY_LINKQUALITY_SLID_WIN_MAX;\r\nlast_evm = rtlpriv->stats.ui_link_quality.elements[\r\nrtlpriv->stats.ui_link_quality.index];\r\nrtlpriv->stats.ui_link_quality.total_val -= last_evm;\r\n}\r\nrtlpriv->stats.ui_link_quality.total_val +=\r\npstats->signalquality;\r\nrtlpriv->stats.ui_link_quality.elements[\r\nrtlpriv->stats.ui_link_quality.index++] =\r\npstats->signalquality;\r\nif (rtlpriv->stats.ui_link_quality.index >=\r\nPHY_LINKQUALITY_SLID_WIN_MAX)\r\nrtlpriv->stats.ui_link_quality.index = 0;\r\ntmpval = rtlpriv->stats.ui_link_quality.total_val /\r\nrtlpriv->stats.ui_link_quality.total_num;\r\nrtlpriv->stats.signal_quality = tmpval;\r\nrtlpriv->stats.last_sigstrength_inpercent = tmpval;\r\nrtl92d_loop_over_streams(hw, pstats);\r\n}\r\n}\r\nstatic void _rtl92de_process_phyinfo(struct ieee80211_hw *hw,\r\nu8 *buffer,\r\nstruct rtl_stats *pcurrent_stats)\r\n{\r\nif (!pcurrent_stats->packet_matchbssid &&\r\n!pcurrent_stats->packet_beacon)\r\nreturn;\r\n_rtl92de_process_ui_rssi(hw, pcurrent_stats);\r\n_rtl92de_process_pwdb(hw, pcurrent_stats);\r\n_rtl92de_process_ui_link_quality(hw, pcurrent_stats);\r\n}\r\nstatic void _rtl92de_translate_rx_signal_stuff(struct ieee80211_hw *hw,\r\nstruct sk_buff *skb,\r\nstruct rtl_stats *pstats,\r\nstruct rx_desc_92d *pdesc,\r\nstruct rx_fwinfo_92d *p_drvinfo)\r\n{\r\nstruct rtl_mac *mac = rtl_mac(rtl_priv(hw));\r\nstruct rtl_efuse *rtlefuse = rtl_efuse(rtl_priv(hw));\r\nstruct ieee80211_hdr *hdr;\r\nu8 *tmp_buf;\r\nu8 *praddr;\r\nu16 type, cfc;\r\n__le16 fc;\r\nbool packet_matchbssid, packet_toself, packet_beacon = false;\r\ntmp_buf = skb->data + pstats->rx_drvinfo_size + pstats->rx_bufshift;\r\nhdr = (struct ieee80211_hdr *)tmp_buf;\r\nfc = hdr->frame_control;\r\ncfc = le16_to_cpu(fc);\r\ntype = WLAN_FC_GET_TYPE(fc);\r\npraddr = hdr->addr1;\r\npacket_matchbssid = ((IEEE80211_FTYPE_CTL != type) &&\r\nether_addr_equal(mac->bssid,\r\n(cfc & IEEE80211_FCTL_TODS) ? hdr->addr1 :\r\n(cfc & IEEE80211_FCTL_FROMDS) ? hdr->addr2 :\r\nhdr->addr3) &&\r\n(!pstats->hwerror) && (!pstats->crc) && (!pstats->icv));\r\npacket_toself = packet_matchbssid &&\r\nether_addr_equal(praddr, rtlefuse->dev_addr);\r\nif (ieee80211_is_beacon(fc))\r\npacket_beacon = true;\r\n_rtl92de_query_rxphystatus(hw, pstats, pdesc, p_drvinfo,\r\npacket_matchbssid, packet_toself,\r\npacket_beacon);\r\n_rtl92de_process_phyinfo(hw, tmp_buf, pstats);\r\n}\r\nbool rtl92de_rx_query_desc(struct ieee80211_hw *hw, struct rtl_stats *stats,\r\nstruct ieee80211_rx_status *rx_status,\r\nu8 *p_desc, struct sk_buff *skb)\r\n{\r\nstruct rx_fwinfo_92d *p_drvinfo;\r\nstruct rx_desc_92d *pdesc = (struct rx_desc_92d *)p_desc;\r\nu32 phystatus = GET_RX_DESC_PHYST(pdesc);\r\nstats->length = (u16) GET_RX_DESC_PKT_LEN(pdesc);\r\nstats->rx_drvinfo_size = (u8) GET_RX_DESC_DRV_INFO_SIZE(pdesc) *\r\nRX_DRV_INFO_SIZE_UNIT;\r\nstats->rx_bufshift = (u8) (GET_RX_DESC_SHIFT(pdesc) & 0x03);\r\nstats->icv = (u16) GET_RX_DESC_ICV(pdesc);\r\nstats->crc = (u16) GET_RX_DESC_CRC32(pdesc);\r\nstats->hwerror = (stats->crc | stats->icv);\r\nstats->decrypted = !GET_RX_DESC_SWDEC(pdesc);\r\nstats->rate = (u8) GET_RX_DESC_RXMCS(pdesc);\r\nstats->shortpreamble = (u16) GET_RX_DESC_SPLCP(pdesc);\r\nstats->isampdu = (bool) (GET_RX_DESC_PAGGR(pdesc) == 1);\r\nstats->isfirst_ampdu = (bool) ((GET_RX_DESC_PAGGR(pdesc) == 1)\r\n&& (GET_RX_DESC_FAGGR(pdesc) == 1));\r\nstats->timestamp_low = GET_RX_DESC_TSFL(pdesc);\r\nstats->rx_is40Mhzpacket = (bool) GET_RX_DESC_BW(pdesc);\r\nrx_status->freq = hw->conf.chandef.chan->center_freq;\r\nrx_status->band = hw->conf.chandef.chan->band;\r\nif (GET_RX_DESC_CRC32(pdesc))\r\nrx_status->flag |= RX_FLAG_FAILED_FCS_CRC;\r\nif (!GET_RX_DESC_SWDEC(pdesc))\r\nrx_status->flag |= RX_FLAG_DECRYPTED;\r\nif (GET_RX_DESC_BW(pdesc))\r\nrx_status->flag |= RX_FLAG_40MHZ;\r\nif (GET_RX_DESC_RXHT(pdesc))\r\nrx_status->flag |= RX_FLAG_HT;\r\nrx_status->flag |= RX_FLAG_MACTIME_START;\r\nif (stats->decrypted)\r\nrx_status->flag |= RX_FLAG_DECRYPTED;\r\nrx_status->rate_idx = rtlwifi_rate_mapping(hw,\r\n(bool)GET_RX_DESC_RXHT(pdesc),\r\n(u8)GET_RX_DESC_RXMCS(pdesc),\r\n(bool)GET_RX_DESC_PAGGR(pdesc));\r\nrx_status->mactime = GET_RX_DESC_TSFL(pdesc);\r\nif (phystatus) {\r\np_drvinfo = (struct rx_fwinfo_92d *)(skb->data +\r\nstats->rx_bufshift);\r\n_rtl92de_translate_rx_signal_stuff(hw,\r\nskb, stats, pdesc,\r\np_drvinfo);\r\n}\r\nrx_status->signal = stats->rssi + 10;\r\nreturn true;\r\n}\r\nstatic void _rtl92de_insert_emcontent(struct rtl_tcb_desc *ptcb_desc,\r\nu8 *virtualaddress)\r\n{\r\nmemset(virtualaddress, 0, 8);\r\nSET_EARLYMODE_PKTNUM(virtualaddress, ptcb_desc->empkt_num);\r\nSET_EARLYMODE_LEN0(virtualaddress, ptcb_desc->empkt_len[0]);\r\nSET_EARLYMODE_LEN1(virtualaddress, ptcb_desc->empkt_len[1]);\r\nSET_EARLYMODE_LEN2_1(virtualaddress, ptcb_desc->empkt_len[2] & 0xF);\r\nSET_EARLYMODE_LEN2_2(virtualaddress, ptcb_desc->empkt_len[2] >> 4);\r\nSET_EARLYMODE_LEN3(virtualaddress, ptcb_desc->empkt_len[3]);\r\nSET_EARLYMODE_LEN4(virtualaddress, ptcb_desc->empkt_len[4]);\r\n}\r\nvoid rtl92de_tx_fill_desc(struct ieee80211_hw *hw,\r\nstruct ieee80211_hdr *hdr, u8 *pdesc_tx,\r\nstruct ieee80211_tx_info *info,\r\nstruct ieee80211_sta *sta,\r\nstruct sk_buff *skb,\r\nu8 hw_queue, struct rtl_tcb_desc *ptcb_desc)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_mac *mac = rtl_mac(rtl_priv(hw));\r\nstruct rtl_pci *rtlpci = rtl_pcidev(rtl_pcipriv(hw));\r\nstruct rtl_hal *rtlhal = rtl_hal(rtlpriv);\r\nstruct rtl_ps_ctl *ppsc = rtl_psc(rtl_priv(hw));\r\nu8 *pdesc = pdesc_tx;\r\nu16 seq_number;\r\n__le16 fc = hdr->frame_control;\r\nunsigned int buf_len = 0;\r\nunsigned int skb_len = skb->len;\r\nu8 fw_qsel = _rtl92de_map_hwqueue_to_fwqueue(skb, hw_queue);\r\nbool firstseg = ((hdr->seq_ctrl &\r\ncpu_to_le16(IEEE80211_SCTL_FRAG)) == 0);\r\nbool lastseg = ((hdr->frame_control &\r\ncpu_to_le16(IEEE80211_FCTL_MOREFRAGS)) == 0);\r\ndma_addr_t mapping;\r\nu8 bw_40 = 0;\r\nif (mac->opmode == NL80211_IFTYPE_STATION) {\r\nbw_40 = mac->bw_40;\r\n} else if (mac->opmode == NL80211_IFTYPE_AP ||\r\nmac->opmode == NL80211_IFTYPE_ADHOC) {\r\nif (sta)\r\nbw_40 = sta->bandwidth >= IEEE80211_STA_RX_BW_40;\r\n}\r\nseq_number = (le16_to_cpu(hdr->seq_ctrl) & IEEE80211_SCTL_SEQ) >> 4;\r\nrtl_get_tcb_desc(hw, info, sta, skb, ptcb_desc);\r\nif (rtlhal->earlymode_enable) {\r\nskb_push(skb, EM_HDR_LEN);\r\nmemset(skb->data, 0, EM_HDR_LEN);\r\n}\r\nbuf_len = skb->len;\r\nmapping = pci_map_single(rtlpci->pdev, skb->data, skb->len,\r\nPCI_DMA_TODEVICE);\r\nif (pci_dma_mapping_error(rtlpci->pdev, mapping)) {\r\nRT_TRACE(rtlpriv, COMP_SEND, DBG_TRACE,\r\n"DMA mapping error");\r\nreturn;\r\n}\r\nCLEAR_PCI_TX_DESC_CONTENT(pdesc, sizeof(struct tx_desc_92d));\r\nif (ieee80211_is_nullfunc(fc) || ieee80211_is_ctl(fc)) {\r\nfirstseg = true;\r\nlastseg = true;\r\n}\r\nif (firstseg) {\r\nif (rtlhal->earlymode_enable) {\r\nSET_TX_DESC_PKT_OFFSET(pdesc, 1);\r\nSET_TX_DESC_OFFSET(pdesc, USB_HWDESC_HEADER_LEN +\r\nEM_HDR_LEN);\r\nif (ptcb_desc->empkt_num) {\r\nRT_TRACE(rtlpriv, COMP_SEND, DBG_LOUD,\r\n"Insert 8 byte.pTcb->EMPktNum:%d\n",\r\nptcb_desc->empkt_num);\r\n_rtl92de_insert_emcontent(ptcb_desc,\r\n(u8 *)(skb->data));\r\n}\r\n} else {\r\nSET_TX_DESC_OFFSET(pdesc, USB_HWDESC_HEADER_LEN);\r\n}\r\nif (rtlhal->current_bandtype == BAND_ON_5G)\r\nif (ptcb_desc->hw_rate < DESC92_RATE6M)\r\nptcb_desc->hw_rate = DESC92_RATE6M;\r\nSET_TX_DESC_TX_RATE(pdesc, ptcb_desc->hw_rate);\r\nif (ptcb_desc->use_shortgi || ptcb_desc->use_shortpreamble)\r\nSET_TX_DESC_DATA_SHORTGI(pdesc, 1);\r\nif (rtlhal->macphymode == DUALMAC_DUALPHY &&\r\nptcb_desc->hw_rate == DESC92_RATEMCS7)\r\nSET_TX_DESC_DATA_SHORTGI(pdesc, 1);\r\nif (info->flags & IEEE80211_TX_CTL_AMPDU) {\r\nSET_TX_DESC_AGG_ENABLE(pdesc, 1);\r\nSET_TX_DESC_MAX_AGG_NUM(pdesc, 0x14);\r\n}\r\nSET_TX_DESC_SEQ(pdesc, seq_number);\r\nSET_TX_DESC_RTS_ENABLE(pdesc, ((ptcb_desc->rts_enable &&\r\n!ptcb_desc->cts_enable) ? 1 : 0));\r\nSET_TX_DESC_HW_RTS_ENABLE(pdesc, ((ptcb_desc->rts_enable\r\n|| ptcb_desc->cts_enable) ? 1 : 0));\r\nSET_TX_DESC_CTS2SELF(pdesc, ((ptcb_desc->cts_enable) ? 1 : 0));\r\nSET_TX_DESC_RTS_STBC(pdesc, ((ptcb_desc->rts_stbc) ? 1 : 0));\r\nif (rtlhal->current_bandtype == BAND_ON_5G)\r\nif (ptcb_desc->rts_rate < DESC92_RATE6M)\r\nptcb_desc->rts_rate = DESC92_RATE6M;\r\nSET_TX_DESC_RTS_RATE(pdesc, ptcb_desc->rts_rate);\r\nSET_TX_DESC_RTS_BW(pdesc, 0);\r\nSET_TX_DESC_RTS_SC(pdesc, ptcb_desc->rts_sc);\r\nSET_TX_DESC_RTS_SHORT(pdesc, ((ptcb_desc->rts_rate <=\r\nDESC92_RATE54M) ?\r\n(ptcb_desc->rts_use_shortpreamble ? 1 : 0) :\r\n(ptcb_desc->rts_use_shortgi ? 1 : 0)));\r\nif (bw_40) {\r\nif (ptcb_desc->packet_bw) {\r\nSET_TX_DESC_DATA_BW(pdesc, 1);\r\nSET_TX_DESC_TX_SUB_CARRIER(pdesc, 3);\r\n} else {\r\nSET_TX_DESC_DATA_BW(pdesc, 0);\r\nSET_TX_DESC_TX_SUB_CARRIER(pdesc,\r\nmac->cur_40_prime_sc);\r\n}\r\n} else {\r\nSET_TX_DESC_DATA_BW(pdesc, 0);\r\nSET_TX_DESC_TX_SUB_CARRIER(pdesc, 0);\r\n}\r\nSET_TX_DESC_LINIP(pdesc, 0);\r\nSET_TX_DESC_PKT_SIZE(pdesc, (u16) skb_len);\r\nif (sta) {\r\nu8 ampdu_density = sta->ht_cap.ampdu_density;\r\nSET_TX_DESC_AMPDU_DENSITY(pdesc, ampdu_density);\r\n}\r\nif (info->control.hw_key) {\r\nstruct ieee80211_key_conf *keyconf;\r\nkeyconf = info->control.hw_key;\r\nswitch (keyconf->cipher) {\r\ncase WLAN_CIPHER_SUITE_WEP40:\r\ncase WLAN_CIPHER_SUITE_WEP104:\r\ncase WLAN_CIPHER_SUITE_TKIP:\r\nSET_TX_DESC_SEC_TYPE(pdesc, 0x1);\r\nbreak;\r\ncase WLAN_CIPHER_SUITE_CCMP:\r\nSET_TX_DESC_SEC_TYPE(pdesc, 0x3);\r\nbreak;\r\ndefault:\r\nSET_TX_DESC_SEC_TYPE(pdesc, 0x0);\r\nbreak;\r\n}\r\n}\r\nSET_TX_DESC_PKT_ID(pdesc, 0);\r\nSET_TX_DESC_QUEUE_SEL(pdesc, fw_qsel);\r\nSET_TX_DESC_DATA_RATE_FB_LIMIT(pdesc, 0x1F);\r\nSET_TX_DESC_RTS_RATE_FB_LIMIT(pdesc, 0xF);\r\nSET_TX_DESC_DISABLE_FB(pdesc, ptcb_desc->disable_ratefallback ?\r\n1 : 0);\r\nSET_TX_DESC_USE_RATE(pdesc, ptcb_desc->use_driver_rate ? 1 : 0);\r\nif (!ptcb_desc->use_driver_rate) {\r\nSET_TX_DESC_RTS_RATE(pdesc, 0x08);\r\n}\r\nif (ieee80211_is_data_qos(fc)) {\r\nif (mac->rdg_en) {\r\nRT_TRACE(rtlpriv, COMP_SEND, DBG_TRACE,\r\n"Enable RDG function\n");\r\nSET_TX_DESC_RDG_ENABLE(pdesc, 1);\r\nSET_TX_DESC_HTC(pdesc, 1);\r\n}\r\n}\r\n}\r\nSET_TX_DESC_FIRST_SEG(pdesc, (firstseg ? 1 : 0));\r\nSET_TX_DESC_LAST_SEG(pdesc, (lastseg ? 1 : 0));\r\nSET_TX_DESC_TX_BUFFER_SIZE(pdesc, (u16) buf_len);\r\nSET_TX_DESC_TX_BUFFER_ADDRESS(pdesc, mapping);\r\nif (rtlpriv->dm.useramask) {\r\nSET_TX_DESC_RATE_ID(pdesc, ptcb_desc->ratr_index);\r\nSET_TX_DESC_MACID(pdesc, ptcb_desc->mac_id);\r\n} else {\r\nSET_TX_DESC_RATE_ID(pdesc, 0xC + ptcb_desc->ratr_index);\r\nSET_TX_DESC_MACID(pdesc, ptcb_desc->ratr_index);\r\n}\r\nif (ieee80211_is_data_qos(fc))\r\nSET_TX_DESC_QOS(pdesc, 1);\r\nif ((!ieee80211_is_data_qos(fc)) && ppsc->fwctrl_lps) {\r\nSET_TX_DESC_HWSEQ_EN(pdesc, 1);\r\nSET_TX_DESC_PKT_ID(pdesc, 8);\r\n}\r\nSET_TX_DESC_MORE_FRAG(pdesc, (lastseg ? 0 : 1));\r\nRT_TRACE(rtlpriv, COMP_SEND, DBG_TRACE, "\n");\r\n}\r\nvoid rtl92de_tx_fill_cmddesc(struct ieee80211_hw *hw,\r\nu8 *pdesc, bool firstseg,\r\nbool lastseg, struct sk_buff *skb)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_pci *rtlpci = rtl_pcidev(rtl_pcipriv(hw));\r\nstruct rtl_ps_ctl *ppsc = rtl_psc(rtlpriv);\r\nstruct rtl_hal *rtlhal = rtl_hal(rtlpriv);\r\nu8 fw_queue = QSLT_BEACON;\r\ndma_addr_t mapping = pci_map_single(rtlpci->pdev,\r\nskb->data, skb->len, PCI_DMA_TODEVICE);\r\nstruct ieee80211_hdr *hdr = (struct ieee80211_hdr *)(skb->data);\r\n__le16 fc = hdr->frame_control;\r\nif (pci_dma_mapping_error(rtlpci->pdev, mapping)) {\r\nRT_TRACE(rtlpriv, COMP_SEND, DBG_TRACE,\r\n"DMA mapping error");\r\nreturn;\r\n}\r\nCLEAR_PCI_TX_DESC_CONTENT(pdesc, TX_DESC_SIZE);\r\nif (firstseg)\r\nSET_TX_DESC_OFFSET(pdesc, USB_HWDESC_HEADER_LEN);\r\nif (rtlhal->current_bandtype == BAND_ON_5G) {\r\nSET_TX_DESC_TX_RATE(pdesc, DESC92_RATE6M);\r\n} else {\r\nSET_TX_DESC_TX_RATE(pdesc, DESC92_RATE1M);\r\n}\r\nSET_TX_DESC_SEQ(pdesc, 0);\r\nSET_TX_DESC_LINIP(pdesc, 0);\r\nSET_TX_DESC_QUEUE_SEL(pdesc, fw_queue);\r\nSET_TX_DESC_FIRST_SEG(pdesc, 1);\r\nSET_TX_DESC_LAST_SEG(pdesc, 1);\r\nSET_TX_DESC_TX_BUFFER_SIZE(pdesc, (u16)skb->len);\r\nSET_TX_DESC_TX_BUFFER_ADDRESS(pdesc, mapping);\r\nSET_TX_DESC_RATE_ID(pdesc, 7);\r\nSET_TX_DESC_MACID(pdesc, 0);\r\nSET_TX_DESC_PKT_SIZE(pdesc, (u16) (skb->len));\r\nSET_TX_DESC_FIRST_SEG(pdesc, 1);\r\nSET_TX_DESC_LAST_SEG(pdesc, 1);\r\nSET_TX_DESC_OFFSET(pdesc, 0x20);\r\nSET_TX_DESC_USE_RATE(pdesc, 1);\r\nif (!ieee80211_is_data_qos(fc) && ppsc->fwctrl_lps) {\r\nSET_TX_DESC_HWSEQ_EN(pdesc, 1);\r\nSET_TX_DESC_PKT_ID(pdesc, 8);\r\n}\r\nRT_PRINT_DATA(rtlpriv, COMP_CMD, DBG_LOUD,\r\n"H2C Tx Cmd Content", pdesc, TX_DESC_SIZE);\r\nwmb();\r\nSET_TX_DESC_OWN(pdesc, 1);\r\n}\r\nvoid rtl92de_set_desc(u8 *pdesc, bool istx, u8 desc_name, u8 *val)\r\n{\r\nif (istx) {\r\nswitch (desc_name) {\r\ncase HW_DESC_OWN:\r\nwmb();\r\nSET_TX_DESC_OWN(pdesc, 1);\r\nbreak;\r\ncase HW_DESC_TX_NEXTDESC_ADDR:\r\nSET_TX_DESC_NEXT_DESC_ADDRESS(pdesc, *(u32 *) val);\r\nbreak;\r\ndefault:\r\nRT_ASSERT(false, "ERR txdesc :%d not process\n",\r\ndesc_name);\r\nbreak;\r\n}\r\n} else {\r\nswitch (desc_name) {\r\ncase HW_DESC_RXOWN:\r\nwmb();\r\nSET_RX_DESC_OWN(pdesc, 1);\r\nbreak;\r\ncase HW_DESC_RXBUFF_ADDR:\r\nSET_RX_DESC_BUFF_ADDR(pdesc, *(u32 *) val);\r\nbreak;\r\ncase HW_DESC_RXPKT_LEN:\r\nSET_RX_DESC_PKT_LEN(pdesc, *(u32 *) val);\r\nbreak;\r\ncase HW_DESC_RXERO:\r\nSET_RX_DESC_EOR(pdesc, 1);\r\nbreak;\r\ndefault:\r\nRT_ASSERT(false, "ERR rxdesc :%d not process\n",\r\ndesc_name);\r\nbreak;\r\n}\r\n}\r\n}\r\nu32 rtl92de_get_desc(u8 *p_desc, bool istx, u8 desc_name)\r\n{\r\nu32 ret = 0;\r\nif (istx) {\r\nswitch (desc_name) {\r\ncase HW_DESC_OWN:\r\nret = GET_TX_DESC_OWN(p_desc);\r\nbreak;\r\ncase HW_DESC_TXBUFF_ADDR:\r\nret = GET_TX_DESC_TX_BUFFER_ADDRESS(p_desc);\r\nbreak;\r\ndefault:\r\nRT_ASSERT(false, "ERR txdesc :%d not process\n",\r\ndesc_name);\r\nbreak;\r\n}\r\n} else {\r\nstruct rx_desc_92c *pdesc = (struct rx_desc_92c *)p_desc;\r\nswitch (desc_name) {\r\ncase HW_DESC_OWN:\r\nret = GET_RX_DESC_OWN(pdesc);\r\nbreak;\r\ncase HW_DESC_RXPKT_LEN:\r\nret = GET_RX_DESC_PKT_LEN(pdesc);\r\nbreak;\r\ndefault:\r\nRT_ASSERT(false, "ERR rxdesc :%d not process\n",\r\ndesc_name);\r\nbreak;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nvoid rtl92de_tx_polling(struct ieee80211_hw *hw, u8 hw_queue)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nif (hw_queue == BEACON_QUEUE)\r\nrtl_write_word(rtlpriv, REG_PCIE_CTRL_REG, BIT(4));\r\nelse\r\nrtl_write_word(rtlpriv, REG_PCIE_CTRL_REG,\r\nBIT(0) << (hw_queue));\r\n}

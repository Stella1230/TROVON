void __init omap_dsp_reserve_sdram_memblock(void)\r\n{\r\nphys_addr_t size = CONFIG_TIDSPBRIDGE_MEMPOOL_SIZE;\r\nphys_addr_t paddr;\r\nif (!size)\r\nreturn;\r\npaddr = arm_memblock_steal(size, SZ_1M);\r\nif (!paddr) {\r\npr_err("%s: failed to reserve %llx bytes\n",\r\n__func__, (unsigned long long)size);\r\nreturn;\r\n}\r\nomap_dsp_phys_mempool_base = paddr;\r\n}\r\nstatic phys_addr_t omap_dsp_get_mempool_base(void)\r\n{\r\nreturn omap_dsp_phys_mempool_base;\r\n}\r\nstatic int __init omap_dsp_init(void)\r\n{\r\nstruct platform_device *pdev;\r\nint err = -ENOMEM;\r\nstruct omap_dsp_platform_data *pdata = &omap_dsp_pdata;\r\npdata->phys_mempool_base = omap_dsp_get_mempool_base();\r\nif (pdata->phys_mempool_base) {\r\npdata->phys_mempool_size = CONFIG_TIDSPBRIDGE_MEMPOOL_SIZE;\r\npr_info("%s: %llx bytes @ %llx\n", __func__,\r\n(unsigned long long)pdata->phys_mempool_size,\r\n(unsigned long long)pdata->phys_mempool_base);\r\n}\r\npdev = platform_device_alloc("omap-dsp", -1);\r\nif (!pdev)\r\ngoto err_out;\r\nerr = platform_device_add_data(pdev, pdata, sizeof(*pdata));\r\nif (err)\r\ngoto err_out;\r\nerr = platform_device_add(pdev);\r\nif (err)\r\ngoto err_out;\r\nomap_dsp_pdev = pdev;\r\nreturn 0;\r\nerr_out:\r\nplatform_device_put(pdev);\r\nreturn err;\r\n}\r\nstatic void __exit omap_dsp_exit(void)\r\n{\r\nplatform_device_unregister(omap_dsp_pdev);\r\n}

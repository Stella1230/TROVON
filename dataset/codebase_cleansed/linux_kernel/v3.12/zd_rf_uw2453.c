static int uw2453_synth_set_channel(struct zd_chip *chip, int channel,\r\nbool autocal)\r\n{\r\nint r;\r\nint idx = channel - 1;\r\nu32 val;\r\nif (autocal)\r\nval = UW2453_REGWRITE(1, uw2453_autocal_synth[idx]);\r\nelse\r\nval = UW2453_REGWRITE(1, uw2453_std_synth[idx]);\r\nr = zd_rfwrite_locked(chip, val, RF_RV_BITS);\r\nif (r)\r\nreturn r;\r\nreturn zd_rfwrite_locked(chip,\r\nUW2453_REGWRITE(2, uw2453_synth_divide[idx]), RF_RV_BITS);\r\n}\r\nstatic int uw2453_write_vco_cfg(struct zd_chip *chip, u16 value)\r\n{\r\nu32 val = 0x40000 | value;\r\nreturn zd_rfwrite_locked(chip, UW2453_REGWRITE(3, val), RF_RV_BITS);\r\n}\r\nstatic int uw2453_init_mode(struct zd_chip *chip)\r\n{\r\nstatic const u32 rv[] = {\r\nUW2453_REGWRITE(0, 0x25f98),\r\nUW2453_REGWRITE(0, 0x25f9a),\r\nUW2453_REGWRITE(0, 0x25f94),\r\nUW2453_REGWRITE(0, 0x27fd4),\r\n};\r\nreturn zd_rfwritev_locked(chip, rv, ARRAY_SIZE(rv), RF_RV_BITS);\r\n}\r\nstatic int uw2453_set_tx_gain_level(struct zd_chip *chip, int channel)\r\n{\r\nu8 int_value = chip->pwr_int_values[channel - 1];\r\nif (int_value >= ARRAY_SIZE(uw2453_txgain)) {\r\ndev_dbg_f(zd_chip_dev(chip), "can't configure TX gain for "\r\n"int value %x on channel %d\n", int_value, channel);\r\nreturn 0;\r\n}\r\nreturn zd_rfwrite_locked(chip,\r\nUW2453_REGWRITE(7, uw2453_txgain[int_value]), RF_RV_BITS);\r\n}\r\nstatic int uw2453_init_hw(struct zd_rf *rf)\r\n{\r\nint i, r;\r\nint found_config = -1;\r\nu16 intr_status;\r\nstruct zd_chip *chip = zd_rf_to_chip(rf);\r\nstatic const struct zd_ioreq16 ioreqs[] = {\r\n{ ZD_CR10, 0x89 }, { ZD_CR15, 0x20 },\r\n{ ZD_CR17, 0x28 },\r\n{ ZD_CR23, 0x38 }, { ZD_CR24, 0x20 }, { ZD_CR26, 0x93 },\r\n{ ZD_CR27, 0x15 }, { ZD_CR28, 0x3e }, { ZD_CR29, 0x00 },\r\n{ ZD_CR33, 0x28 }, { ZD_CR34, 0x30 },\r\n{ ZD_CR35, 0x43 },\r\n{ ZD_CR41, 0x24 }, { ZD_CR44, 0x32 },\r\n{ ZD_CR46, 0x92 },\r\n{ ZD_CR47, 0x1e },\r\n{ ZD_CR48, 0x04 },\r\n{ ZD_CR49, 0xfa }, { ZD_CR79, 0x58 }, { ZD_CR80, 0x30 },\r\n{ ZD_CR81, 0x30 }, { ZD_CR87, 0x0a }, { ZD_CR89, 0x04 },\r\n{ ZD_CR91, 0x00 }, { ZD_CR92, 0x0a }, { ZD_CR98, 0x8d },\r\n{ ZD_CR99, 0x28 }, { ZD_CR100, 0x02 },\r\n{ ZD_CR101, 0x09 },\r\n{ ZD_CR102, 0x27 },\r\n{ ZD_CR106, 0x1c },\r\n{ ZD_CR107, 0x1c },\r\n{ ZD_CR109, 0x13 },\r\n{ ZD_CR110, 0x1f },\r\n{ ZD_CR111, 0x13 }, { ZD_CR112, 0x1f }, { ZD_CR113, 0x27 },\r\n{ ZD_CR114, 0x23 },\r\n{ ZD_CR115, 0x24 },\r\n{ ZD_CR116, 0x24 },\r\n{ ZD_CR117, 0xfa },\r\n{ ZD_CR118, 0xf0 },\r\n{ ZD_CR119, 0x1a },\r\n{ ZD_CR120, 0x4f },\r\n{ ZD_CR121, 0x1f },\r\n{ ZD_CR122, 0xf0 }, { ZD_CR123, 0x57 }, { ZD_CR125, 0xad },\r\n{ ZD_CR126, 0x6c }, { ZD_CR127, 0x03 },\r\n{ ZD_CR128, 0x14 },\r\n{ ZD_CR129, 0x12 },\r\n{ ZD_CR130, 0x10 }, { ZD_CR137, 0x50 }, { ZD_CR138, 0xa8 },\r\n{ ZD_CR144, 0xac }, { ZD_CR146, 0x20 }, { ZD_CR252, 0xff },\r\n{ ZD_CR253, 0xff },\r\n};\r\nstatic const u32 rv[] = {\r\nUW2453_REGWRITE(4, 0x2b),\r\nUW2453_REGWRITE(5, 0x19e4f),\r\nUW2453_REGWRITE(6, 0xf81ad),\r\nUW2453_REGWRITE(7, 0x3fffe),\r\nUW2453_REGWRITE(0, 0x25f9c),\r\nUW2453_REGWRITE(1, 0x47),\r\nUW2453_REGWRITE(2, 0x999),\r\nUW2453_REGWRITE(3, 0x7602),\r\nUW2453_REGWRITE(3, 0x46063),\r\n};\r\nr = zd_iowrite16a_locked(chip, ioreqs, ARRAY_SIZE(ioreqs));\r\nif (r)\r\nreturn r;\r\nr = zd_rfwritev_locked(chip, rv, ARRAY_SIZE(rv), RF_RV_BITS);\r\nif (r)\r\nreturn r;\r\nr = uw2453_init_mode(chip);\r\nif (r)\r\nreturn r;\r\nfor (i = 0; i < ARRAY_SIZE(uw2453_std_vco_cfg) - 1; i++) {\r\nr = uw2453_synth_set_channel(chip, 1, false);\r\nif (r)\r\nreturn r;\r\nr = uw2453_write_vco_cfg(chip, uw2453_std_vco_cfg[i][0]);\r\nif (r)\r\nreturn r;\r\nr = zd_iowrite16_locked(chip, 0x0f, UW2453_INTR_REG);\r\nif (r)\r\nreturn r;\r\nr = zd_ioread16_locked(chip, &intr_status, UW2453_INTR_REG);\r\nif (r)\r\nreturn r;\r\nif (!(intr_status & 0xf)) {\r\ndev_dbg_f(zd_chip_dev(chip),\r\n"PLL locked on configuration %d\n", i);\r\nfound_config = i;\r\nbreak;\r\n}\r\n}\r\nif (found_config == -1) {\r\ndev_dbg_f(zd_chip_dev(chip),\r\n"PLL did not lock, using autocal\n");\r\nr = uw2453_synth_set_channel(chip, 1, true);\r\nif (r)\r\nreturn r;\r\nr = uw2453_write_vco_cfg(chip, UW2453_AUTOCAL_VCO_CFG);\r\nif (r)\r\nreturn r;\r\n}\r\nUW2453_PRIV(rf)->config = found_config + 1;\r\nreturn zd_iowrite16_locked(chip, 0x06, ZD_CR203);\r\n}\r\nstatic int uw2453_set_channel(struct zd_rf *rf, u8 channel)\r\n{\r\nint r;\r\nu16 vco_cfg;\r\nint config = UW2453_PRIV(rf)->config;\r\nbool autocal = (config == -1);\r\nstruct zd_chip *chip = zd_rf_to_chip(rf);\r\nstatic const struct zd_ioreq16 ioreqs[] = {\r\n{ ZD_CR80, 0x30 }, { ZD_CR81, 0x30 }, { ZD_CR79, 0x58 },\r\n{ ZD_CR12, 0xf0 }, { ZD_CR77, 0x1b }, { ZD_CR78, 0x58 },\r\n};\r\nr = uw2453_synth_set_channel(chip, channel, autocal);\r\nif (r)\r\nreturn r;\r\nif (autocal)\r\nvco_cfg = UW2453_AUTOCAL_VCO_CFG;\r\nelse\r\nvco_cfg = uw2453_std_vco_cfg[config][CHAN_TO_PAIRIDX(channel)];\r\nr = uw2453_write_vco_cfg(chip, vco_cfg);\r\nif (r)\r\nreturn r;\r\nr = uw2453_init_mode(chip);\r\nif (r)\r\nreturn r;\r\nr = zd_iowrite16a_locked(chip, ioreqs, ARRAY_SIZE(ioreqs));\r\nif (r)\r\nreturn r;\r\nr = uw2453_set_tx_gain_level(chip, channel);\r\nif (r)\r\nreturn r;\r\nreturn zd_iowrite16_locked(chip, 0x06, ZD_CR203);\r\n}\r\nstatic int uw2453_switch_radio_on(struct zd_rf *rf)\r\n{\r\nint r;\r\nstruct zd_chip *chip = zd_rf_to_chip(rf);\r\nstruct zd_ioreq16 ioreqs[] = {\r\n{ ZD_CR11, 0x00 }, { ZD_CR251, 0x3f },\r\n};\r\nr = zd_rfwrite_locked(chip, UW2453_REGWRITE(0, 0x25f94), RF_RV_BITS);\r\nif (r)\r\nreturn r;\r\nif (zd_chip_is_zd1211b(chip))\r\nioreqs[1].value = 0x7f;\r\nreturn zd_iowrite16a_locked(chip, ioreqs, ARRAY_SIZE(ioreqs));\r\n}\r\nstatic int uw2453_switch_radio_off(struct zd_rf *rf)\r\n{\r\nint r;\r\nstruct zd_chip *chip = zd_rf_to_chip(rf);\r\nstatic const struct zd_ioreq16 ioreqs[] = {\r\n{ ZD_CR11, 0x04 }, { ZD_CR251, 0x2f },\r\n};\r\nr = zd_rfwrite_locked(chip, UW2453_REGWRITE(0, 0x25f90), RF_RV_BITS);\r\nif (r)\r\nreturn r;\r\nreturn zd_iowrite16a_locked(chip, ioreqs, ARRAY_SIZE(ioreqs));\r\n}\r\nstatic void uw2453_clear(struct zd_rf *rf)\r\n{\r\nkfree(rf->priv);\r\n}\r\nint zd_rf_init_uw2453(struct zd_rf *rf)\r\n{\r\nrf->init_hw = uw2453_init_hw;\r\nrf->set_channel = uw2453_set_channel;\r\nrf->switch_radio_on = uw2453_switch_radio_on;\r\nrf->switch_radio_off = uw2453_switch_radio_off;\r\nrf->patch_6m_band_edge = zd_rf_generic_patch_6m;\r\nrf->clear = uw2453_clear;\r\nrf->update_channel_int = 0;\r\nrf->priv = kmalloc(sizeof(struct uw2453_priv), GFP_KERNEL);\r\nif (rf->priv == NULL)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}

static int ohci_sa1111_reset(struct usb_hcd *hcd)\r\n{\r\nstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\r\nohci_hcd_init(ohci);\r\nreturn ohci_init(ohci);\r\n}\r\nstatic int ohci_sa1111_start(struct usb_hcd *hcd)\r\n{\r\nstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\r\nint ret;\r\nret = ohci_run(ohci);\r\nif (ret < 0) {\r\nohci_err(ohci, "can't start\n");\r\nohci_stop(hcd);\r\n}\r\nreturn ret;\r\n}\r\nstatic int sa1111_start_hc(struct sa1111_dev *dev)\r\n{\r\nunsigned int usb_rst = 0;\r\nint ret;\r\ndev_dbg(&dev->dev, "starting SA-1111 OHCI USB Controller\n");\r\nif (machine_is_xp860() ||\r\nmachine_has_neponset() ||\r\nmachine_is_pfs168() ||\r\nmachine_is_badge4())\r\nusb_rst = USB_RESET_PWRSENSELOW | USB_RESET_PWRCTRLLOW;\r\nsa1111_writel(usb_rst | USB_RESET_FORCEIFRESET | USB_RESET_FORCEHCRESET,\r\ndev->mapbase + USB_RESET);\r\nret = sa1111_enable_device(dev);\r\nif (ret == 0) {\r\nudelay(11);\r\nsa1111_writel(usb_rst, dev->mapbase + USB_RESET);\r\n}\r\nreturn ret;\r\n}\r\nstatic void sa1111_stop_hc(struct sa1111_dev *dev)\r\n{\r\nunsigned int usb_rst;\r\ndev_dbg(&dev->dev, "stopping SA-1111 OHCI USB Controller\n");\r\nusb_rst = sa1111_readl(dev->mapbase + USB_RESET);\r\nsa1111_writel(usb_rst | USB_RESET_FORCEIFRESET | USB_RESET_FORCEHCRESET,\r\ndev->mapbase + USB_RESET);\r\nsa1111_disable_device(dev);\r\n}\r\nstatic int ohci_hcd_sa1111_probe(struct sa1111_dev *dev)\r\n{\r\nstruct usb_hcd *hcd;\r\nint ret;\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\nhcd = usb_create_hcd(&ohci_sa1111_hc_driver, &dev->dev, "sa1111");\r\nif (!hcd)\r\nreturn -ENOMEM;\r\nhcd->rsrc_start = dev->res.start;\r\nhcd->rsrc_len = resource_size(&dev->res);\r\nif (!request_mem_region(hcd->rsrc_start, hcd->rsrc_len, hcd_name)) {\r\ndev_dbg(&dev->dev, "request_mem_region failed\n");\r\nret = -EBUSY;\r\ngoto err1;\r\n}\r\nhcd->regs = dev->mapbase;\r\nret = sa1111_start_hc(dev);\r\nif (ret)\r\ngoto err2;\r\nret = usb_add_hcd(hcd, dev->irq[1], 0);\r\nif (ret == 0)\r\nreturn ret;\r\nsa1111_stop_hc(dev);\r\nerr2:\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nerr1:\r\nusb_put_hcd(hcd);\r\nreturn ret;\r\n}\r\nstatic int ohci_hcd_sa1111_remove(struct sa1111_dev *dev)\r\n{\r\nstruct usb_hcd *hcd = sa1111_get_drvdata(dev);\r\nusb_remove_hcd(hcd);\r\nsa1111_stop_hc(dev);\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nusb_put_hcd(hcd);\r\nreturn 0;\r\n}\r\nstatic void ohci_hcd_sa1111_shutdown(struct sa1111_dev *dev)\r\n{\r\nstruct usb_hcd *hcd = sa1111_get_drvdata(dev);\r\nif (test_bit(HCD_FLAG_HW_ACCESSIBLE, &hcd->flags)) {\r\nhcd->driver->shutdown(hcd);\r\nsa1111_stop_hc(dev);\r\n}\r\n}

void *scatterwalk_whichbuf(struct scatter_walk *walk, unsigned int nbytes, void *scratch)\r\n{\r\nif (nbytes <= walk->len_this_page &&\r\n(((unsigned long)walk->data) & (PAGE_CACHE_SIZE - 1)) + nbytes <=\r\nPAGE_CACHE_SIZE)\r\nreturn walk->data;\r\nelse\r\nreturn scratch;\r\n}\r\nstatic void memcpy_dir(void *buf, void *sgdata, size_t nbytes, int out)\r\n{\r\nif (out)\r\nmemcpy(sgdata, buf, nbytes);\r\nelse\r\nmemcpy(buf, sgdata, nbytes);\r\n}\r\nvoid scatterwalk_start(struct scatter_walk *walk, struct scatterlist *sg)\r\n{\r\nunsigned int rest_of_page;\r\nwalk->sg = sg;\r\nwalk->page = sg->page;\r\nwalk->len_this_segment = sg->length;\r\nrest_of_page = PAGE_CACHE_SIZE - (sg->offset & (PAGE_CACHE_SIZE - 1));\r\nwalk->len_this_page = min(sg->length, rest_of_page);\r\nwalk->offset = sg->offset;\r\n}\r\nvoid scatterwalk_map(struct scatter_walk *walk)\r\n{\r\nwalk->data = kmap_atomic(walk->page) + walk->offset;\r\n}\r\nstatic void scatterwalk_pagedone(struct scatter_walk *walk, int out,\r\nunsigned int more)\r\n{\r\nif (out)\r\nflush_dcache_page(walk->page);\r\nif (more) {\r\nwalk->len_this_segment -= walk->len_this_page;\r\nif (walk->len_this_segment) {\r\nwalk->page++;\r\nwalk->len_this_page = min(walk->len_this_segment,\r\n(unsigned)PAGE_CACHE_SIZE);\r\nwalk->offset = 0;\r\n}\r\nelse\r\nscatterwalk_start(walk, sg_next(walk->sg));\r\n}\r\n}\r\nvoid scatterwalk_done(struct scatter_walk *walk, int out, int more)\r\n{\r\ncrypto_kunmap(walk->data, out);\r\nif (walk->len_this_page == 0 || !more)\r\nscatterwalk_pagedone(walk, out, more);\r\n}\r\nint scatterwalk_copychunks(void *buf, struct scatter_walk *walk,\r\nsize_t nbytes)\r\n{\r\nif (buf != walk->data) {\r\nwhile (nbytes > walk->len_this_page) {\r\nmemcpy_dir(buf, walk->data, walk->len_this_page, out);\r\nbuf += walk->len_this_page;\r\nnbytes -= walk->len_this_page;\r\nkunmap_atomic(walk->data);\r\nscatterwalk_pagedone(walk, out, 1);\r\nscatterwalk_map(walk);\r\n}\r\nmemcpy_dir(buf, walk->data, nbytes, out);\r\n}\r\nwalk->offset += nbytes;\r\nwalk->len_this_page -= nbytes;\r\nwalk->len_this_segment -= nbytes;\r\nreturn 0;\r\n}

struct i2c_client *hdpvr_register_ir_tx_i2c(struct hdpvr_device *dev)\r\n{\r\nstruct IR_i2c_init_data *init_data = &dev->ir_i2c_init_data;\r\nstruct i2c_board_info hdpvr_ir_tx_i2c_board_info = {\r\nI2C_BOARD_INFO("ir_tx_z8f0811_hdpvr", Z8F0811_IR_TX_I2C_ADDR),\r\n};\r\ninit_data->name = "HD-PVR";\r\nhdpvr_ir_tx_i2c_board_info.platform_data = init_data;\r\nreturn i2c_new_device(&dev->i2c_adapter, &hdpvr_ir_tx_i2c_board_info);\r\n}\r\nstruct i2c_client *hdpvr_register_ir_rx_i2c(struct hdpvr_device *dev)\r\n{\r\nstruct IR_i2c_init_data *init_data = &dev->ir_i2c_init_data;\r\nstruct i2c_board_info hdpvr_ir_rx_i2c_board_info = {\r\nI2C_BOARD_INFO("ir_rx_z8f0811_hdpvr", Z8F0811_IR_RX_I2C_ADDR),\r\n};\r\ninit_data->ir_codes = RC_MAP_HAUPPAUGE;\r\ninit_data->internal_get_key_func = IR_KBD_GET_KEY_HAUP_XVR;\r\ninit_data->type = RC_BIT_RC5;\r\ninit_data->name = "HD-PVR";\r\ninit_data->polling_interval = 405;\r\nhdpvr_ir_rx_i2c_board_info.platform_data = init_data;\r\nreturn i2c_new_device(&dev->i2c_adapter, &hdpvr_ir_rx_i2c_board_info);\r\n}\r\nstatic int hdpvr_i2c_read(struct hdpvr_device *dev, int bus,\r\nunsigned char addr, char *wdata, int wlen,\r\nchar *data, int len)\r\n{\r\nint ret;\r\nif ((len > sizeof(dev->i2c_buf)) || (wlen > sizeof(dev->i2c_buf)))\r\nreturn -EINVAL;\r\nif (wlen) {\r\nmemcpy(&dev->i2c_buf, wdata, wlen);\r\nret = usb_control_msg(dev->udev, usb_sndctrlpipe(dev->udev, 0),\r\nREQTYPE_I2C_WRITE, CTRL_WRITE_REQUEST,\r\n(bus << 8) | addr, 0, &dev->i2c_buf,\r\nwlen, 1000);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nret = usb_control_msg(dev->udev, usb_rcvctrlpipe(dev->udev, 0),\r\nREQTYPE_I2C_READ, CTRL_READ_REQUEST,\r\n(bus << 8) | addr, 0, &dev->i2c_buf, len, 1000);\r\nif (ret == len) {\r\nmemcpy(data, &dev->i2c_buf, len);\r\nret = 0;\r\n} else if (ret >= 0)\r\nret = -EIO;\r\nreturn ret;\r\n}\r\nstatic int hdpvr_i2c_write(struct hdpvr_device *dev, int bus,\r\nunsigned char addr, char *data, int len)\r\n{\r\nint ret;\r\nif (len > sizeof(dev->i2c_buf))\r\nreturn -EINVAL;\r\nmemcpy(&dev->i2c_buf, data, len);\r\nret = usb_control_msg(dev->udev, usb_sndctrlpipe(dev->udev, 0),\r\nREQTYPE_I2C_WRITE, CTRL_WRITE_REQUEST,\r\n(bus << 8) | addr, 0, &dev->i2c_buf, len, 1000);\r\nif (ret < 0)\r\nreturn ret;\r\nret = usb_control_msg(dev->udev, usb_rcvctrlpipe(dev->udev, 0),\r\nREQTYPE_I2C_WRITE_STATT, CTRL_READ_REQUEST,\r\n0, 0, &dev->i2c_buf, 2, 1000);\r\nif ((ret == 2) && (dev->i2c_buf[1] == (len - 1)))\r\nret = 0;\r\nelse if (ret >= 0)\r\nret = -EIO;\r\nreturn ret;\r\n}\r\nstatic int hdpvr_transfer(struct i2c_adapter *i2c_adapter, struct i2c_msg *msgs,\r\nint num)\r\n{\r\nstruct hdpvr_device *dev = i2c_get_adapdata(i2c_adapter);\r\nint retval = 0, addr;\r\nif (num <= 0)\r\nreturn 0;\r\nmutex_lock(&dev->i2c_mutex);\r\naddr = msgs[0].addr << 1;\r\nif (num == 1) {\r\nif (msgs[0].flags & I2C_M_RD)\r\nretval = hdpvr_i2c_read(dev, 1, addr, NULL, 0,\r\nmsgs[0].buf, msgs[0].len);\r\nelse\r\nretval = hdpvr_i2c_write(dev, 1, addr, msgs[0].buf,\r\nmsgs[0].len);\r\n} else if (num == 2) {\r\nif (msgs[0].addr != msgs[1].addr) {\r\nv4l2_warn(&dev->v4l2_dev, "refusing 2-phase i2c xfer "\r\n"with conflicting target addresses\n");\r\nretval = -EINVAL;\r\ngoto out;\r\n}\r\nif ((msgs[0].flags & I2C_M_RD) || !(msgs[1].flags & I2C_M_RD)) {\r\nv4l2_warn(&dev->v4l2_dev, "refusing complex xfer with "\r\n"r0=%d, r1=%d\n", msgs[0].flags & I2C_M_RD,\r\nmsgs[1].flags & I2C_M_RD);\r\nretval = -EINVAL;\r\ngoto out;\r\n}\r\nretval = hdpvr_i2c_read(dev, 1, addr, msgs[0].buf, msgs[0].len,\r\nmsgs[1].buf, msgs[1].len);\r\n} else {\r\nv4l2_warn(&dev->v4l2_dev, "refusing %d-phase i2c xfer\n", num);\r\n}\r\nout:\r\nmutex_unlock(&dev->i2c_mutex);\r\nreturn retval ? retval : num;\r\n}\r\nstatic u32 hdpvr_functionality(struct i2c_adapter *adapter)\r\n{\r\nreturn I2C_FUNC_I2C | I2C_FUNC_SMBUS_EMUL;\r\n}\r\nstatic int hdpvr_activate_ir(struct hdpvr_device *dev)\r\n{\r\nchar buffer[2];\r\nmutex_lock(&dev->i2c_mutex);\r\nhdpvr_i2c_read(dev, 0, 0x54, NULL, 0, buffer, 1);\r\nbuffer[0] = 0;\r\nbuffer[1] = 0x8;\r\nhdpvr_i2c_write(dev, 1, 0x54, buffer, 2);\r\nbuffer[1] = 0x18;\r\nhdpvr_i2c_write(dev, 1, 0x54, buffer, 2);\r\nmutex_unlock(&dev->i2c_mutex);\r\nreturn 0;\r\n}\r\nint hdpvr_register_i2c_adapter(struct hdpvr_device *dev)\r\n{\r\nint retval = -ENOMEM;\r\nhdpvr_activate_ir(dev);\r\ndev->i2c_adapter = hdpvr_i2c_adapter_template;\r\ndev->i2c_adapter.dev.parent = &dev->udev->dev;\r\ni2c_set_adapdata(&dev->i2c_adapter, dev);\r\nretval = i2c_add_adapter(&dev->i2c_adapter);\r\nreturn retval;\r\n}

static int dmx3191d_probe_one(struct pci_dev *pdev,\r\nconst struct pci_device_id *id)\r\n{\r\nstruct Scsi_Host *shost;\r\nunsigned long io;\r\nint error = -ENODEV;\r\nif (pci_enable_device(pdev))\r\ngoto out;\r\nio = pci_resource_start(pdev, 0);\r\nif (!request_region(io, DMX3191D_REGION_LEN, DMX3191D_DRIVER_NAME)) {\r\nprintk(KERN_ERR "dmx3191: region 0x%lx-0x%lx already reserved\n",\r\nio, io + DMX3191D_REGION_LEN);\r\ngoto out_disable_device;\r\n}\r\nshost = scsi_host_alloc(&dmx3191d_driver_template,\r\nsizeof(struct NCR5380_hostdata));\r\nif (!shost)\r\ngoto out_release_region;\r\nshost->io_port = io;\r\nshost->irq = pdev->irq;\r\nNCR5380_init(shost, FLAG_NO_PSEUDO_DMA | FLAG_DTC3181E);\r\nif (request_irq(pdev->irq, NCR5380_intr, IRQF_SHARED,\r\nDMX3191D_DRIVER_NAME, shost)) {\r\nprintk(KERN_WARNING "dmx3191: IRQ %d not available - "\r\n"switching to polled mode.\n", pdev->irq);\r\nshost->irq = SCSI_IRQ_NONE;\r\n}\r\npci_set_drvdata(pdev, shost);\r\nerror = scsi_add_host(shost, &pdev->dev);\r\nif (error)\r\ngoto out_free_irq;\r\nscsi_scan_host(shost);\r\nreturn 0;\r\nout_free_irq:\r\nfree_irq(shost->irq, shost);\r\nout_release_region:\r\nrelease_region(io, DMX3191D_REGION_LEN);\r\nout_disable_device:\r\npci_disable_device(pdev);\r\nout:\r\nreturn error;\r\n}\r\nstatic void dmx3191d_remove_one(struct pci_dev *pdev)\r\n{\r\nstruct Scsi_Host *shost = pci_get_drvdata(pdev);\r\nscsi_remove_host(shost);\r\nNCR5380_exit(shost);\r\nif (shost->irq != SCSI_IRQ_NONE)\r\nfree_irq(shost->irq, shost);\r\nrelease_region(shost->io_port, DMX3191D_REGION_LEN);\r\npci_disable_device(pdev);\r\nscsi_host_put(shost);\r\n}\r\nstatic int __init dmx3191d_init(void)\r\n{\r\nreturn pci_register_driver(&dmx3191d_pci_driver);\r\n}\r\nstatic void __exit dmx3191d_exit(void)\r\n{\r\npci_unregister_driver(&dmx3191d_pci_driver);\r\n}

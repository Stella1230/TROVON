static int max77693_chg_is_enabled(struct regulator_dev *rdev)\r\n{\r\nint ret;\r\nu8 val;\r\nret = max77693_read_reg(rdev->regmap, rdev->desc->enable_reg, &val);\r\nif (ret)\r\nreturn ret;\r\nreturn (val & rdev->desc->enable_mask) == rdev->desc->enable_mask;\r\n}\r\nstatic int max77693_chg_get_current_limit(struct regulator_dev *rdev)\r\n{\r\nunsigned int chg_min_uA = rdev->constraints->min_uA;\r\nunsigned int chg_max_uA = rdev->constraints->max_uA;\r\nu8 reg, sel;\r\nunsigned int val;\r\nint ret;\r\nret = max77693_read_reg(rdev->regmap,\r\nMAX77693_CHG_REG_CHG_CNFG_09, &reg);\r\nif (ret < 0)\r\nreturn ret;\r\nsel = reg & CHG_CNFG_09_CHGIN_ILIM_MASK;\r\nif (sel <= 3)\r\nsel = 0;\r\nelse\r\nsel -= 3;\r\nval = chg_min_uA + CHGIN_ILIM_STEP_20mA * sel;\r\nif (val > chg_max_uA)\r\nreturn -EINVAL;\r\nreturn val;\r\n}\r\nstatic int max77693_chg_set_current_limit(struct regulator_dev *rdev,\r\nint min_uA, int max_uA)\r\n{\r\nunsigned int chg_min_uA = rdev->constraints->min_uA;\r\nint sel = 0;\r\nwhile (chg_min_uA + CHGIN_ILIM_STEP_20mA * sel < min_uA)\r\nsel++;\r\nif (chg_min_uA + CHGIN_ILIM_STEP_20mA * sel > max_uA)\r\nreturn -EINVAL;\r\nsel += 3;\r\nreturn max77693_write_reg(rdev->regmap,\r\nMAX77693_CHG_REG_CHG_CNFG_09, sel);\r\n}\r\nstatic int max77693_pmic_dt_parse_rdata(struct device *dev,\r\nstruct max77693_regulator_data **rdata)\r\n{\r\nstruct device_node *np;\r\nstruct of_regulator_match *rmatch;\r\nstruct max77693_regulator_data *tmp;\r\nint i, matched = 0;\r\nnp = of_find_node_by_name(dev->parent->of_node, "regulators");\r\nif (!np)\r\nreturn -EINVAL;\r\nrmatch = devm_kzalloc(dev,\r\nsizeof(*rmatch) * ARRAY_SIZE(regulators), GFP_KERNEL);\r\nif (!rmatch)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < ARRAY_SIZE(regulators); i++)\r\nrmatch[i].name = regulators[i].name;\r\nmatched = of_regulator_match(dev, np, rmatch, ARRAY_SIZE(regulators));\r\nif (matched <= 0)\r\nreturn matched;\r\n*rdata = devm_kzalloc(dev, sizeof(**rdata) * matched, GFP_KERNEL);\r\nif (!(*rdata))\r\nreturn -ENOMEM;\r\ntmp = *rdata;\r\nfor (i = 0; i < matched; i++) {\r\ntmp->initdata = rmatch[i].init_data;\r\ntmp->of_node = rmatch[i].of_node;\r\ntmp->id = regulators[i].id;\r\ntmp++;\r\n}\r\nreturn matched;\r\n}\r\nstatic int max77693_pmic_dt_parse_rdata(struct device *dev,\r\nstruct max77693_regulator_data **rdata)\r\n{\r\nreturn 0;\r\n}\r\nstatic int max77693_pmic_init_rdata(struct device *dev,\r\nstruct max77693_regulator_data **rdata)\r\n{\r\nstruct max77693_platform_data *pdata;\r\nint num_regulators = 0;\r\npdata = dev_get_platdata(dev->parent);\r\nif (pdata) {\r\n*rdata = pdata->regulators;\r\nnum_regulators = pdata->num_regulators;\r\n}\r\nif (!(*rdata) && dev->parent->of_node)\r\nnum_regulators = max77693_pmic_dt_parse_rdata(dev, rdata);\r\nreturn num_regulators;\r\n}\r\nstatic int max77693_pmic_probe(struct platform_device *pdev)\r\n{\r\nstruct max77693_dev *iodev = dev_get_drvdata(pdev->dev.parent);\r\nstruct max77693_pmic_dev *max77693_pmic;\r\nstruct max77693_regulator_data *rdata = NULL;\r\nint num_rdata, i, ret;\r\nstruct regulator_config config;\r\nnum_rdata = max77693_pmic_init_rdata(&pdev->dev, &rdata);\r\nif (!rdata || num_rdata <= 0) {\r\ndev_err(&pdev->dev, "No init data supplied.\n");\r\nreturn -ENODEV;\r\n}\r\nmax77693_pmic = devm_kzalloc(&pdev->dev,\r\nsizeof(struct max77693_pmic_dev),\r\nGFP_KERNEL);\r\nif (!max77693_pmic)\r\nreturn -ENOMEM;\r\nmax77693_pmic->rdev = devm_kzalloc(&pdev->dev,\r\nsizeof(struct regulator_dev *) * num_rdata,\r\nGFP_KERNEL);\r\nif (!max77693_pmic->rdev)\r\nreturn -ENOMEM;\r\nmax77693_pmic->dev = &pdev->dev;\r\nmax77693_pmic->iodev = iodev;\r\nmax77693_pmic->num_regulators = num_rdata;\r\nconfig.dev = &pdev->dev;\r\nconfig.regmap = iodev->regmap;\r\nconfig.driver_data = max77693_pmic;\r\nplatform_set_drvdata(pdev, max77693_pmic);\r\nfor (i = 0; i < max77693_pmic->num_regulators; i++) {\r\nint id = rdata[i].id;\r\nconfig.init_data = rdata[i].initdata;\r\nconfig.of_node = rdata[i].of_node;\r\nmax77693_pmic->rdev[i] = regulator_register(&regulators[id],\r\n&config);\r\nif (IS_ERR(max77693_pmic->rdev[i])) {\r\nret = PTR_ERR(max77693_pmic->rdev[i]);\r\ndev_err(max77693_pmic->dev,\r\n"Failed to initialize regulator-%d\n", id);\r\nmax77693_pmic->rdev[i] = NULL;\r\ngoto err;\r\n}\r\n}\r\nreturn 0;\r\nerr:\r\nwhile (--i >= 0)\r\nregulator_unregister(max77693_pmic->rdev[i]);\r\nreturn ret;\r\n}\r\nstatic int max77693_pmic_remove(struct platform_device *pdev)\r\n{\r\nstruct max77693_pmic_dev *max77693_pmic = platform_get_drvdata(pdev);\r\nstruct regulator_dev **rdev = max77693_pmic->rdev;\r\nint i;\r\nfor (i = 0; i < max77693_pmic->num_regulators; i++)\r\nif (rdev[i])\r\nregulator_unregister(rdev[i]);\r\nreturn 0;\r\n}

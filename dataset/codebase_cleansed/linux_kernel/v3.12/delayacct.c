static int __init delayacct_setup_disable(char *str)\r\n{\r\ndelayacct_on = 0;\r\nreturn 1;\r\n}\r\nvoid delayacct_init(void)\r\n{\r\ndelayacct_cache = KMEM_CACHE(task_delay_info, SLAB_PANIC);\r\ndelayacct_tsk_init(&init_task);\r\n}\r\nvoid __delayacct_tsk_init(struct task_struct *tsk)\r\n{\r\ntsk->delays = kmem_cache_zalloc(delayacct_cache, GFP_KERNEL);\r\nif (tsk->delays)\r\nspin_lock_init(&tsk->delays->lock);\r\n}\r\nstatic inline void delayacct_start(struct timespec *start)\r\n{\r\ndo_posix_clock_monotonic_gettime(start);\r\n}\r\nstatic void delayacct_end(struct timespec *start, struct timespec *end,\r\nu64 *total, u32 *count)\r\n{\r\nstruct timespec ts;\r\ns64 ns;\r\nunsigned long flags;\r\ndo_posix_clock_monotonic_gettime(end);\r\nts = timespec_sub(*end, *start);\r\nns = timespec_to_ns(&ts);\r\nif (ns < 0)\r\nreturn;\r\nspin_lock_irqsave(&current->delays->lock, flags);\r\n*total += ns;\r\n(*count)++;\r\nspin_unlock_irqrestore(&current->delays->lock, flags);\r\n}\r\nvoid __delayacct_blkio_start(void)\r\n{\r\ndelayacct_start(&current->delays->blkio_start);\r\n}\r\nvoid __delayacct_blkio_end(void)\r\n{\r\nif (current->delays->flags & DELAYACCT_PF_SWAPIN)\r\ndelayacct_end(&current->delays->blkio_start,\r\n&current->delays->blkio_end,\r\n&current->delays->swapin_delay,\r\n&current->delays->swapin_count);\r\nelse\r\ndelayacct_end(&current->delays->blkio_start,\r\n&current->delays->blkio_end,\r\n&current->delays->blkio_delay,\r\n&current->delays->blkio_count);\r\n}\r\nint __delayacct_add_tsk(struct taskstats *d, struct task_struct *tsk)\r\n{\r\ns64 tmp;\r\nunsigned long t1;\r\nunsigned long long t2, t3;\r\nunsigned long flags;\r\nstruct timespec ts;\r\ncputime_t utime, stime, stimescaled, utimescaled;\r\nif (!tsk->delays)\r\ngoto done;\r\ntmp = (s64)d->cpu_run_real_total;\r\ntask_cputime(tsk, &utime, &stime);\r\ncputime_to_timespec(utime + stime, &ts);\r\ntmp += timespec_to_ns(&ts);\r\nd->cpu_run_real_total = (tmp < (s64)d->cpu_run_real_total) ? 0 : tmp;\r\ntmp = (s64)d->cpu_scaled_run_real_total;\r\ntask_cputime_scaled(tsk, &utimescaled, &stimescaled);\r\ncputime_to_timespec(utimescaled + stimescaled, &ts);\r\ntmp += timespec_to_ns(&ts);\r\nd->cpu_scaled_run_real_total =\r\n(tmp < (s64)d->cpu_scaled_run_real_total) ? 0 : tmp;\r\nt1 = tsk->sched_info.pcount;\r\nt2 = tsk->sched_info.run_delay;\r\nt3 = tsk->se.sum_exec_runtime;\r\nd->cpu_count += t1;\r\ntmp = (s64)d->cpu_delay_total + t2;\r\nd->cpu_delay_total = (tmp < (s64)d->cpu_delay_total) ? 0 : tmp;\r\ntmp = (s64)d->cpu_run_virtual_total + t3;\r\nd->cpu_run_virtual_total =\r\n(tmp < (s64)d->cpu_run_virtual_total) ? 0 : tmp;\r\nspin_lock_irqsave(&tsk->delays->lock, flags);\r\ntmp = d->blkio_delay_total + tsk->delays->blkio_delay;\r\nd->blkio_delay_total = (tmp < d->blkio_delay_total) ? 0 : tmp;\r\ntmp = d->swapin_delay_total + tsk->delays->swapin_delay;\r\nd->swapin_delay_total = (tmp < d->swapin_delay_total) ? 0 : tmp;\r\ntmp = d->freepages_delay_total + tsk->delays->freepages_delay;\r\nd->freepages_delay_total = (tmp < d->freepages_delay_total) ? 0 : tmp;\r\nd->blkio_count += tsk->delays->blkio_count;\r\nd->swapin_count += tsk->delays->swapin_count;\r\nd->freepages_count += tsk->delays->freepages_count;\r\nspin_unlock_irqrestore(&tsk->delays->lock, flags);\r\ndone:\r\nreturn 0;\r\n}\r\n__u64 __delayacct_blkio_ticks(struct task_struct *tsk)\r\n{\r\n__u64 ret;\r\nunsigned long flags;\r\nspin_lock_irqsave(&tsk->delays->lock, flags);\r\nret = nsec_to_clock_t(tsk->delays->blkio_delay +\r\ntsk->delays->swapin_delay);\r\nspin_unlock_irqrestore(&tsk->delays->lock, flags);\r\nreturn ret;\r\n}\r\nvoid __delayacct_freepages_start(void)\r\n{\r\ndelayacct_start(&current->delays->freepages_start);\r\n}\r\nvoid __delayacct_freepages_end(void)\r\n{\r\ndelayacct_end(&current->delays->freepages_start,\r\n&current->delays->freepages_end,\r\n&current->delays->freepages_delay,\r\n&current->delays->freepages_count);\r\n}

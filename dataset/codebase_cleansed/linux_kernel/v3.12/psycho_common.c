static void psycho_check_stc_error(struct pci_pbm_info *pbm)\r\n{\r\nunsigned long err_base, tag_base, line_base;\r\nstruct strbuf *strbuf = &pbm->stc;\r\nu64 control;\r\nint i;\r\nif (!strbuf->strbuf_control)\r\nreturn;\r\nerr_base = strbuf->strbuf_err_stat;\r\ntag_base = strbuf->strbuf_tag_diag;\r\nline_base = strbuf->strbuf_line_diag;\r\nspin_lock(&stc_buf_lock);\r\ncontrol = upa_readq(strbuf->strbuf_control);\r\nupa_writeq(control | PSYCHO_STRBUF_CTRL_DENAB, strbuf->strbuf_control);\r\nfor (i = 0; i < 128; i++) {\r\nu64 val;\r\nval = upa_readq(err_base + (i * 8UL));\r\nupa_writeq(0UL, err_base + (i * 8UL));\r\nstc_error_buf[i] = val;\r\n}\r\nfor (i = 0; i < 16; i++) {\r\nstc_tag_buf[i] = upa_readq(tag_base + (i * 8UL));\r\nstc_line_buf[i] = upa_readq(line_base + (i * 8UL));\r\nupa_writeq(0UL, tag_base + (i * 8UL));\r\nupa_writeq(0UL, line_base + (i * 8UL));\r\n}\r\nupa_writeq(control, strbuf->strbuf_control);\r\nfor (i = 0; i < 16; i++) {\r\nint j, saw_error, first, last;\r\nsaw_error = 0;\r\nfirst = i * 8;\r\nlast = first + 8;\r\nfor (j = first; j < last; j++) {\r\nu64 errval = stc_error_buf[j];\r\nif (errval != 0) {\r\nsaw_error++;\r\nprintk(KERN_ERR "%s: STC_ERR(%d)[wr(%d)"\r\n"rd(%d)]\n",\r\npbm->name,\r\nj,\r\n(errval & PSYCHO_STCERR_WRITE) ? 1 : 0,\r\n(errval & PSYCHO_STCERR_READ) ? 1 : 0);\r\n}\r\n}\r\nif (saw_error != 0) {\r\nu64 tagval = stc_tag_buf[i];\r\nu64 lineval = stc_line_buf[i];\r\nprintk(KERN_ERR "%s: STC_TAG(%d)[PA(%016llx)VA(%08llx)"\r\n"V(%d)W(%d)]\n",\r\npbm->name,\r\ni,\r\n((tagval & PSYCHO_STCTAG_PPN) >> 19UL),\r\n(tagval & PSYCHO_STCTAG_VPN),\r\n((tagval & PSYCHO_STCTAG_VALID) ? 1 : 0),\r\n((tagval & PSYCHO_STCTAG_WRITE) ? 1 : 0));\r\nprintk(KERN_ERR "%s: STC_LINE(%d)[LIDX(%llx)SP(%llx)"\r\n"LADDR(%llx)EP(%llx)V(%d)FOFN(%d)]\n",\r\npbm->name,\r\ni,\r\n((lineval & PSYCHO_STCLINE_LINDX) >> 21UL),\r\n((lineval & PSYCHO_STCLINE_SPTR) >> 15UL),\r\n((lineval & PSYCHO_STCLINE_LADDR) >> 8UL),\r\n((lineval & PSYCHO_STCLINE_EPTR) >> 2UL),\r\n((lineval & PSYCHO_STCLINE_VALID) ? 1 : 0),\r\n((lineval & PSYCHO_STCLINE_FOFN) ? 1 : 0));\r\n}\r\n}\r\nspin_unlock(&stc_buf_lock);\r\n}\r\nstatic void psycho_record_iommu_tags_and_data(struct pci_pbm_info *pbm,\r\nu64 *tag, u64 *data)\r\n{\r\nint i;\r\nfor (i = 0; i < 16; i++) {\r\nunsigned long base = pbm->controller_regs;\r\nunsigned long off = i * 8UL;\r\ntag[i] = upa_readq(base + PSYCHO_IOMMU_TAG+off);\r\ndata[i] = upa_readq(base + PSYCHO_IOMMU_DATA+off);\r\nupa_writeq(0, base + PSYCHO_IOMMU_TAG + off);\r\nupa_writeq(0, base + PSYCHO_IOMMU_DATA + off);\r\n}\r\n}\r\nstatic void psycho_dump_iommu_tags_and_data(struct pci_pbm_info *pbm,\r\nu64 *tag, u64 *data)\r\n{\r\nint i;\r\nfor (i = 0; i < 16; i++) {\r\nu64 tag_val, data_val;\r\nconst char *type_str;\r\ntag_val = tag[i];\r\nif (!(tag_val & PSYCHO_IOMMU_TAG_ERR))\r\ncontinue;\r\ndata_val = data[i];\r\nswitch((tag_val & PSYCHO_IOMMU_TAG_ERRSTS) >> 23UL) {\r\ncase 0:\r\ntype_str = "Protection Error";\r\nbreak;\r\ncase 1:\r\ntype_str = "Invalid Error";\r\nbreak;\r\ncase 2:\r\ntype_str = "TimeOut Error";\r\nbreak;\r\ncase 3:\r\ndefault:\r\ntype_str = "ECC Error";\r\nbreak;\r\n}\r\nprintk(KERN_ERR "%s: IOMMU TAG(%d)[error(%s) wr(%d) "\r\n"str(%d) sz(%dK) vpg(%08llx)]\n",\r\npbm->name, i, type_str,\r\n((tag_val & PSYCHO_IOMMU_TAG_WRITE) ? 1 : 0),\r\n((tag_val & PSYCHO_IOMMU_TAG_STREAM) ? 1 : 0),\r\n((tag_val & PSYCHO_IOMMU_TAG_SIZE) ? 64 : 8),\r\n(tag_val & PSYCHO_IOMMU_TAG_VPAGE) << IOMMU_PAGE_SHIFT);\r\nprintk(KERN_ERR "%s: IOMMU DATA(%d)[valid(%d) cache(%d) "\r\n"ppg(%016llx)]\n",\r\npbm->name, i,\r\n((data_val & PSYCHO_IOMMU_DATA_VALID) ? 1 : 0),\r\n((data_val & PSYCHO_IOMMU_DATA_CACHE) ? 1 : 0),\r\n(data_val & PSYCHO_IOMMU_DATA_PPAGE) << IOMMU_PAGE_SHIFT);\r\n}\r\n}\r\nvoid psycho_check_iommu_error(struct pci_pbm_info *pbm,\r\nunsigned long afsr,\r\nunsigned long afar,\r\nenum psycho_error_type type)\r\n{\r\nu64 control, iommu_tag[16], iommu_data[16];\r\nstruct iommu *iommu = pbm->iommu;\r\nunsigned long flags;\r\nspin_lock_irqsave(&iommu->lock, flags);\r\ncontrol = upa_readq(iommu->iommu_control);\r\nif (control & PSYCHO_IOMMU_CTRL_XLTEERR) {\r\nconst char *type_str;\r\ncontrol &= ~PSYCHO_IOMMU_CTRL_XLTEERR;\r\nupa_writeq(control, iommu->iommu_control);\r\nswitch ((control & PSYCHO_IOMMU_CTRL_XLTESTAT) >> 25UL) {\r\ncase 0:\r\ntype_str = "Protection Error";\r\nbreak;\r\ncase 1:\r\ntype_str = "Invalid Error";\r\nbreak;\r\ncase 2:\r\ntype_str = "TimeOut Error";\r\nbreak;\r\ncase 3:\r\ndefault:\r\ntype_str = "ECC Error";\r\nbreak;\r\n}\r\nprintk(KERN_ERR "%s: IOMMU Error, type[%s]\n",\r\npbm->name, type_str);\r\npsycho_record_iommu_tags_and_data(pbm, iommu_tag, iommu_data);\r\npsycho_dump_iommu_tags_and_data(pbm, iommu_tag, iommu_data);\r\n}\r\npsycho_check_stc_error(pbm);\r\nspin_unlock_irqrestore(&iommu->lock, flags);\r\n}\r\nstatic irqreturn_t psycho_pcierr_intr_other(struct pci_pbm_info *pbm)\r\n{\r\nirqreturn_t ret = IRQ_NONE;\r\nu64 csr, csr_error_bits;\r\nu16 stat, *addr;\r\ncsr = upa_readq(pbm->pci_csr);\r\ncsr_error_bits = csr & (PSYCHO_PCICTRL_SBH_ERR | PSYCHO_PCICTRL_SERR);\r\nif (csr_error_bits) {\r\nupa_writeq(csr, pbm->pci_csr);\r\nif (csr_error_bits & PSYCHO_PCICTRL_SBH_ERR)\r\nprintk(KERN_ERR "%s: PCI streaming byte hole "\r\n"error asserted.\n", pbm->name);\r\nif (csr_error_bits & PSYCHO_PCICTRL_SERR)\r\nprintk(KERN_ERR "%s: PCI SERR signal asserted.\n",\r\npbm->name);\r\nret = IRQ_HANDLED;\r\n}\r\naddr = psycho_pci_config_mkaddr(pbm, pbm->pci_first_busno,\r\n0, PCI_STATUS);\r\npci_config_read16(addr, &stat);\r\nif (stat & (PCI_STATUS_PARITY |\r\nPCI_STATUS_SIG_TARGET_ABORT |\r\nPCI_STATUS_REC_TARGET_ABORT |\r\nPCI_STATUS_REC_MASTER_ABORT |\r\nPCI_STATUS_SIG_SYSTEM_ERROR)) {\r\nprintk(KERN_ERR "%s: PCI bus error, PCI_STATUS[%04x]\n",\r\npbm->name, stat);\r\npci_config_write16(addr, 0xffff);\r\nret = IRQ_HANDLED;\r\n}\r\nreturn ret;\r\n}\r\nirqreturn_t psycho_pcierr_intr(int irq, void *dev_id)\r\n{\r\nstruct pci_pbm_info *pbm = dev_id;\r\nu64 afsr, afar, error_bits;\r\nint reported;\r\nafsr = upa_readq(pbm->pci_afsr);\r\nafar = upa_readq(pbm->pci_afar);\r\nerror_bits = afsr &\r\n(PSYCHO_PCIAFSR_PMA | PSYCHO_PCIAFSR_PTA |\r\nPSYCHO_PCIAFSR_PRTRY | PSYCHO_PCIAFSR_PPERR |\r\nPSYCHO_PCIAFSR_SMA | PSYCHO_PCIAFSR_STA |\r\nPSYCHO_PCIAFSR_SRTRY | PSYCHO_PCIAFSR_SPERR);\r\nif (!error_bits)\r\nreturn psycho_pcierr_intr_other(pbm);\r\nupa_writeq(error_bits, pbm->pci_afsr);\r\nprintk(KERN_ERR "%s: PCI Error, primary error type[%s]\n",\r\npbm->name,\r\n(((error_bits & PSYCHO_PCIAFSR_PMA) ?\r\n"Master Abort" :\r\n((error_bits & PSYCHO_PCIAFSR_PTA) ?\r\n"Target Abort" :\r\n((error_bits & PSYCHO_PCIAFSR_PRTRY) ?\r\n"Excessive Retries" :\r\n((error_bits & PSYCHO_PCIAFSR_PPERR) ?\r\n"Parity Error" : "???"))))));\r\nprintk(KERN_ERR "%s: bytemask[%04llx] UPA_MID[%02llx] was_block(%d)\n",\r\npbm->name,\r\n(afsr & PSYCHO_PCIAFSR_BMSK) >> 32UL,\r\n(afsr & PSYCHO_PCIAFSR_MID) >> 25UL,\r\n(afsr & PSYCHO_PCIAFSR_BLK) ? 1 : 0);\r\nprintk(KERN_ERR "%s: PCI AFAR [%016llx]\n", pbm->name, afar);\r\nprintk(KERN_ERR "%s: PCI Secondary errors [", pbm->name);\r\nreported = 0;\r\nif (afsr & PSYCHO_PCIAFSR_SMA) {\r\nreported++;\r\nprintk("(Master Abort)");\r\n}\r\nif (afsr & PSYCHO_PCIAFSR_STA) {\r\nreported++;\r\nprintk("(Target Abort)");\r\n}\r\nif (afsr & PSYCHO_PCIAFSR_SRTRY) {\r\nreported++;\r\nprintk("(Excessive Retries)");\r\n}\r\nif (afsr & PSYCHO_PCIAFSR_SPERR) {\r\nreported++;\r\nprintk("(Parity Error)");\r\n}\r\nif (!reported)\r\nprintk("(none)");\r\nprintk("]\n");\r\nif (error_bits & (PSYCHO_PCIAFSR_PTA | PSYCHO_PCIAFSR_STA)) {\r\npsycho_check_iommu_error(pbm, afsr, afar, PCI_ERR);\r\npci_scan_for_target_abort(pbm, pbm->pci_bus);\r\n}\r\nif (error_bits & (PSYCHO_PCIAFSR_PMA | PSYCHO_PCIAFSR_SMA))\r\npci_scan_for_master_abort(pbm, pbm->pci_bus);\r\nif (error_bits & (PSYCHO_PCIAFSR_PPERR | PSYCHO_PCIAFSR_SPERR))\r\npci_scan_for_parity_error(pbm, pbm->pci_bus);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void psycho_iommu_flush(struct pci_pbm_info *pbm)\r\n{\r\nint i;\r\nfor (i = 0; i < 16; i++) {\r\nunsigned long off = i * 8;\r\nupa_writeq(0, pbm->controller_regs + PSYCHO_IOMMU_TAG + off);\r\nupa_writeq(0, pbm->controller_regs + PSYCHO_IOMMU_DATA + off);\r\n}\r\n}\r\nint psycho_iommu_init(struct pci_pbm_info *pbm, int tsbsize,\r\nu32 dvma_offset, u32 dma_mask,\r\nunsigned long write_complete_offset)\r\n{\r\nstruct iommu *iommu = pbm->iommu;\r\nu64 control;\r\nint err;\r\niommu->iommu_control = pbm->controller_regs + PSYCHO_IOMMU_CONTROL;\r\niommu->iommu_tsbbase = pbm->controller_regs + PSYCHO_IOMMU_TSBBASE;\r\niommu->iommu_flush = pbm->controller_regs + PSYCHO_IOMMU_FLUSH;\r\niommu->iommu_tags = pbm->controller_regs + PSYCHO_IOMMU_TAG;\r\niommu->write_complete_reg = (pbm->controller_regs +\r\nwrite_complete_offset);\r\niommu->iommu_ctxflush = 0;\r\ncontrol = upa_readq(iommu->iommu_control);\r\ncontrol |= PSYCHO_IOMMU_CTRL_DENAB;\r\nupa_writeq(control, iommu->iommu_control);\r\npsycho_iommu_flush(pbm);\r\nerr = iommu_table_init(iommu, tsbsize * 1024 * 8,\r\ndvma_offset, dma_mask, pbm->numa_node);\r\nif (err)\r\nreturn err;\r\nupa_writeq(__pa(iommu->page_table), iommu->iommu_tsbbase);\r\ncontrol = upa_readq(iommu->iommu_control);\r\ncontrol &= ~(PSYCHO_IOMMU_CTRL_TSBSZ | PSYCHO_IOMMU_CTRL_TBWSZ);\r\ncontrol |= PSYCHO_IOMMU_CTRL_ENAB;\r\nswitch (tsbsize) {\r\ncase 64:\r\ncontrol |= PSYCHO_IOMMU_TSBSZ_64K;\r\nbreak;\r\ncase 128:\r\ncontrol |= PSYCHO_IOMMU_TSBSZ_128K;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nupa_writeq(control, iommu->iommu_control);\r\nreturn 0;\r\n}\r\nvoid psycho_pbm_init_common(struct pci_pbm_info *pbm, struct platform_device *op,\r\nconst char *chip_name, int chip_type)\r\n{\r\nstruct device_node *dp = op->dev.of_node;\r\npbm->name = dp->full_name;\r\npbm->numa_node = -1;\r\npbm->chip_type = chip_type;\r\npbm->chip_version = of_getintprop_default(dp, "version#", 0);\r\npbm->chip_revision = of_getintprop_default(dp, "module-revision#", 0);\r\npbm->op = op;\r\npbm->pci_ops = &sun4u_pci_ops;\r\npbm->config_space_reg_bits = 8;\r\npbm->index = pci_num_pbms++;\r\npci_get_pbm_props(pbm);\r\npci_determine_mem_io_space(pbm);\r\nprintk(KERN_INFO "%s: %s PCI Bus Module ver[%x:%x]\n",\r\npbm->name, chip_name,\r\npbm->chip_version, pbm->chip_revision);\r\n}

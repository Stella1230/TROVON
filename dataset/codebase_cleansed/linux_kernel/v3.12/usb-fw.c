static\r\nssize_t i2400mu_tx_bulk_out(struct i2400mu *i2400mu, void *buf, size_t buf_size)\r\n{\r\nint result;\r\nstruct device *dev = &i2400mu->usb_iface->dev;\r\nint len;\r\nstruct usb_endpoint_descriptor *epd;\r\nint pipe, do_autopm = 1;\r\nresult = usb_autopm_get_interface(i2400mu->usb_iface);\r\nif (result < 0) {\r\ndev_err(dev, "BM-CMD: can't get autopm: %d\n", result);\r\ndo_autopm = 0;\r\n}\r\nepd = usb_get_epd(i2400mu->usb_iface, i2400mu->endpoint_cfg.bulk_out);\r\npipe = usb_sndbulkpipe(i2400mu->usb_dev, epd->bEndpointAddress);\r\nretry:\r\nresult = usb_bulk_msg(i2400mu->usb_dev, pipe, buf, buf_size, &len, 200);\r\nswitch (result) {\r\ncase 0:\r\nif (len != buf_size) {\r\ndev_err(dev, "BM-CMD: short write (%u B vs %zu "\r\n"expected)\n", len, buf_size);\r\nresult = -EIO;\r\nbreak;\r\n}\r\nresult = len;\r\nbreak;\r\ncase -EPIPE:\r\nif (edc_inc(&i2400mu->urb_edc,\r\n10 * EDC_MAX_ERRORS, EDC_ERROR_TIMEFRAME)) {\r\ndev_err(dev, "BM-CMD: too many stalls in "\r\n"URB; resetting device\n");\r\nusb_queue_reset_device(i2400mu->usb_iface);\r\n} else {\r\nusb_clear_halt(i2400mu->usb_dev, pipe);\r\nmsleep(10);\r\ngoto retry;\r\n}\r\ncase -EINVAL:\r\ncase -ENODEV:\r\ncase -ENOENT:\r\ncase -ESHUTDOWN:\r\ncase -ECONNRESET:\r\nresult = -ESHUTDOWN;\r\nbreak;\r\ncase -ETIMEDOUT:\r\nbreak;\r\ndefault:\r\nif (edc_inc(&i2400mu->urb_edc,\r\nEDC_MAX_ERRORS, EDC_ERROR_TIMEFRAME)) {\r\ndev_err(dev, "BM-CMD: maximum errors in "\r\n"URB exceeded; resetting device\n");\r\nusb_queue_reset_device(i2400mu->usb_iface);\r\nresult = -ENODEV;\r\nbreak;\r\n}\r\ndev_err(dev, "BM-CMD: URB error %d, retrying\n",\r\nresult);\r\ngoto retry;\r\n}\r\nif (do_autopm)\r\nusb_autopm_put_interface(i2400mu->usb_iface);\r\nreturn result;\r\n}\r\nssize_t i2400mu_bus_bm_cmd_send(struct i2400m *i2400m,\r\nconst struct i2400m_bootrom_header *_cmd,\r\nsize_t cmd_size, int flags)\r\n{\r\nssize_t result;\r\nstruct device *dev = i2400m_dev(i2400m);\r\nstruct i2400mu *i2400mu = container_of(i2400m, struct i2400mu, i2400m);\r\nint opcode = _cmd == NULL ? -1 : i2400m_brh_get_opcode(_cmd);\r\nstruct i2400m_bootrom_header *cmd;\r\nsize_t cmd_size_a = ALIGN(cmd_size, 16);\r\nd_fnstart(8, dev, "(i2400m %p cmd %p size %zu)\n",\r\ni2400m, _cmd, cmd_size);\r\nresult = -E2BIG;\r\nif (cmd_size > I2400M_BM_CMD_BUF_SIZE)\r\ngoto error_too_big;\r\nif (_cmd != i2400m->bm_cmd_buf)\r\nmemmove(i2400m->bm_cmd_buf, _cmd, cmd_size);\r\ncmd = i2400m->bm_cmd_buf;\r\nif (cmd_size_a > cmd_size)\r\nmemset(i2400m->bm_cmd_buf + cmd_size, 0, cmd_size_a - cmd_size);\r\nif ((flags & I2400M_BM_CMD_RAW) == 0) {\r\nif (WARN_ON(i2400m_brh_get_response_required(cmd) == 0))\r\ndev_warn(dev, "SW BUG: response_required == 0\n");\r\ni2400m_bm_cmd_prepare(cmd);\r\n}\r\nresult = i2400mu_tx_bulk_out(i2400mu, i2400m->bm_cmd_buf, cmd_size);\r\nif (result < 0) {\r\ndev_err(dev, "boot-mode cmd %d: cannot send: %zd\n",\r\nopcode, result);\r\ngoto error_cmd_send;\r\n}\r\nif (result != cmd_size) {\r\ndev_err(dev, "boot-mode cmd %d: incomplete transfer "\r\n"(%zd vs %zu submitted)\n", opcode, result, cmd_size);\r\nresult = -EIO;\r\ngoto error_cmd_size;\r\n}\r\nerror_cmd_size:\r\nerror_cmd_send:\r\nerror_too_big:\r\nd_fnend(8, dev, "(i2400m %p cmd %p size %zu) = %zd\n",\r\ni2400m, _cmd, cmd_size, result);\r\nreturn result;\r\n}\r\nstatic\r\nvoid __i2400mu_bm_notif_cb(struct urb *urb)\r\n{\r\ncomplete(urb->context);\r\n}\r\nstatic\r\nint i2400mu_notif_submit(struct i2400mu *i2400mu, struct urb *urb,\r\nstruct completion *completion)\r\n{\r\nstruct i2400m *i2400m = &i2400mu->i2400m;\r\nstruct usb_endpoint_descriptor *epd;\r\nint pipe;\r\nepd = usb_get_epd(i2400mu->usb_iface,\r\ni2400mu->endpoint_cfg.notification);\r\npipe = usb_rcvintpipe(i2400mu->usb_dev, epd->bEndpointAddress);\r\nusb_fill_int_urb(urb, i2400mu->usb_dev, pipe,\r\ni2400m->bm_ack_buf, I2400M_BM_ACK_BUF_SIZE,\r\n__i2400mu_bm_notif_cb, completion,\r\nepd->bInterval);\r\nreturn usb_submit_urb(urb, GFP_KERNEL);\r\n}\r\nssize_t i2400mu_bus_bm_wait_for_ack(struct i2400m *i2400m,\r\nstruct i2400m_bootrom_header *_ack,\r\nsize_t ack_size)\r\n{\r\nssize_t result = -ENOMEM;\r\nstruct device *dev = i2400m_dev(i2400m);\r\nstruct i2400mu *i2400mu = container_of(i2400m, struct i2400mu, i2400m);\r\nstruct urb notif_urb;\r\nvoid *ack = _ack;\r\nsize_t offset, len;\r\nlong val;\r\nint do_autopm = 1;\r\nDECLARE_COMPLETION_ONSTACK(notif_completion);\r\nd_fnstart(8, dev, "(i2400m %p ack %p size %zu)\n",\r\ni2400m, ack, ack_size);\r\nBUG_ON(_ack == i2400m->bm_ack_buf);\r\nresult = usb_autopm_get_interface(i2400mu->usb_iface);\r\nif (result < 0) {\r\ndev_err(dev, "BM-ACK: can't get autopm: %d\n", (int) result);\r\ndo_autopm = 0;\r\n}\r\nusb_init_urb(&notif_urb);\r\nusb_get_urb(&notif_urb);\r\noffset = 0;\r\nwhile (offset < ack_size) {\r\ninit_completion(&notif_completion);\r\nresult = i2400mu_notif_submit(i2400mu, &notif_urb,\r\n&notif_completion);\r\nif (result < 0)\r\ngoto error_notif_urb_submit;\r\nval = wait_for_completion_interruptible_timeout(\r\n&notif_completion, HZ);\r\nif (val == 0) {\r\nresult = -ETIMEDOUT;\r\nusb_kill_urb(&notif_urb);\r\ngoto error_notif_wait;\r\n}\r\nif (val == -ERESTARTSYS) {\r\nresult = -EINTR;\r\nusb_kill_urb(&notif_urb);\r\ngoto error_notif_wait;\r\n}\r\nresult = notif_urb.status;\r\nswitch (result) {\r\ncase 0:\r\nbreak;\r\ncase -EINVAL:\r\ncase -ENODEV:\r\ncase -ENOENT:\r\ncase -ESHUTDOWN:\r\ncase -ECONNRESET:\r\nresult = -ESHUTDOWN;\r\ngoto error_dev_gone;\r\ndefault:\r\nusb_kill_urb(&notif_urb);\r\nif (edc_inc(&i2400mu->urb_edc,\r\nEDC_MAX_ERRORS, EDC_ERROR_TIMEFRAME))\r\ngoto error_exceeded;\r\ndev_err(dev, "BM-ACK: URB error %d, "\r\n"retrying\n", notif_urb.status);\r\ncontinue;\r\n}\r\nif (notif_urb.actual_length == 0) {\r\nd_printf(6, dev, "ZLP received, retrying\n");\r\ncontinue;\r\n}\r\nlen = min(ack_size - offset, (size_t) notif_urb.actual_length);\r\nmemcpy(ack + offset, i2400m->bm_ack_buf, len);\r\noffset += len;\r\n}\r\nresult = offset;\r\nerror_notif_urb_submit:\r\nerror_notif_wait:\r\nerror_dev_gone:\r\nout:\r\nif (do_autopm)\r\nusb_autopm_put_interface(i2400mu->usb_iface);\r\nd_fnend(8, dev, "(i2400m %p ack %p size %zu) = %ld\n",\r\ni2400m, ack, ack_size, (long) result);\r\nreturn result;\r\nerror_exceeded:\r\ndev_err(dev, "bm: maximum errors in notification URB exceeded; "\r\n"resetting device\n");\r\nusb_queue_reset_device(i2400mu->usb_iface);\r\ngoto out;\r\n}

static int evm_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nint ret = 0;\r\nunsigned sysclk;\r\nif (machine_is_davinci_dm355_evm() || machine_is_davinci_dm6467_evm() ||\r\nmachine_is_davinci_dm365_evm())\r\nsysclk = 27000000;\r\nelse if (machine_is_davinci_evm())\r\nsysclk = 12288000;\r\nelse if (machine_is_davinci_da830_evm() ||\r\nmachine_is_davinci_da850_evm())\r\nsysclk = 24576000;\r\nelse\r\nreturn -EINVAL;\r\nret = snd_soc_dai_set_fmt(codec_dai, AUDIO_FORMAT);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_fmt(cpu_dai, AUDIO_FORMAT);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_sysclk(codec_dai, 0, sysclk, SND_SOC_CLOCK_OUT);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_sysclk(cpu_dai, 0, sysclk, SND_SOC_CLOCK_OUT);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int evm_spdif_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nreturn snd_soc_dai_set_fmt(cpu_dai, AUDIO_FORMAT);\r\n}\r\nstatic int evm_aic3x_init(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct snd_soc_codec *codec = rtd->codec;\r\nstruct snd_soc_dapm_context *dapm = &codec->dapm;\r\nsnd_soc_dapm_new_controls(dapm, aic3x_dapm_widgets,\r\nARRAY_SIZE(aic3x_dapm_widgets));\r\nsnd_soc_dapm_add_routes(dapm, audio_map, ARRAY_SIZE(audio_map));\r\nsnd_soc_dapm_disable_pin(dapm, "MONO_LOUT");\r\nsnd_soc_dapm_disable_pin(dapm, "HPLCOM");\r\nsnd_soc_dapm_disable_pin(dapm, "HPRCOM");\r\nsnd_soc_dapm_enable_pin(dapm, "Headphone Jack");\r\nsnd_soc_dapm_enable_pin(dapm, "Line Out");\r\nsnd_soc_dapm_enable_pin(dapm, "Mic Jack");\r\nsnd_soc_dapm_enable_pin(dapm, "Line In");\r\nreturn 0;\r\n}\r\nstatic int __init evm_init(void)\r\n{\r\nstruct snd_soc_card *evm_snd_dev_data;\r\nint index;\r\nint ret;\r\nif (machine_is_davinci_evm()) {\r\nevm_snd_dev_data = &dm6446_snd_soc_card_evm;\r\nindex = 0;\r\n} else if (machine_is_davinci_dm355_evm()) {\r\nevm_snd_dev_data = &dm355_snd_soc_card_evm;\r\nindex = 1;\r\n} else if (machine_is_davinci_dm365_evm()) {\r\nevm_snd_dev_data = &dm365_snd_soc_card_evm;\r\nindex = 0;\r\n} else if (machine_is_davinci_dm6467_evm()) {\r\nevm_snd_dev_data = &dm6467_snd_soc_card_evm;\r\nindex = 0;\r\n} else if (machine_is_davinci_da830_evm()) {\r\nevm_snd_dev_data = &da830_snd_soc_card;\r\nindex = 1;\r\n} else if (machine_is_davinci_da850_evm()) {\r\nevm_snd_dev_data = &da850_snd_soc_card;\r\nindex = 0;\r\n} else\r\nreturn -EINVAL;\r\nevm_snd_device = platform_device_alloc("soc-audio", index);\r\nif (!evm_snd_device)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(evm_snd_device, evm_snd_dev_data);\r\nret = platform_device_add(evm_snd_device);\r\nif (ret)\r\nplatform_device_put(evm_snd_device);\r\nreturn ret;\r\n}\r\nstatic void __exit evm_exit(void)\r\n{\r\nplatform_device_unregister(evm_snd_device);\r\n}

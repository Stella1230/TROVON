void sbecom_proc_brd_cleanup(ci_t *ci)\r\n{\r\nif (ci->dir_dev) {\r\nchar dir[7 + SBE_IFACETMPL_SIZE + 1];\r\nsnprintf(dir, sizeof(dir), "driver/%s", ci->devname);\r\nremove_proc_entry("info", ci->dir_dev);\r\nremove_proc_entry(dir, NULL);\r\nci->dir_dev = NULL;\r\n}\r\n}\r\nstatic void sbecom_proc_get_brdinfo(ci_t *ci, struct sbe_brd_info *bip)\r\n{\r\nhdw_info_t *hi = &hdw_info[ci->brdno];\r\nu_int8_t *bsn = 0;\r\nswitch (hi->promfmt)\r\n{\r\ncase PROM_FORMAT_TYPE1:\r\nbsn = (u_int8_t *) hi->mfg_info.pft1.Serial;\r\nbreak;\r\ncase PROM_FORMAT_TYPE2:\r\nbsn = (u_int8_t *) hi->mfg_info.pft2.Serial;\r\nbreak;\r\n}\r\nsbecom_get_brdinfo (ci, bip, bsn);\r\npr_devel(">> sbecom_get_brdinfo: returned, first_if %p <%s> last_if %p <%s>\n",\r\nbip->first_iname, bip->first_iname,\r\nbip->last_iname, bip->last_iname);\r\n}\r\nstatic int sbecom_proc_get_sbe_info(struct seq_file *m, void *v)\r\n{\r\nci_t *ci = m->private;\r\nchar *spd;\r\nstruct sbe_brd_info *bip;\r\nif (!(bip = OS_kmalloc(sizeof(struct sbe_brd_info))))\r\nreturn -ENOMEM;\r\npr_devel(">> sbecom_proc_get_sbe_info: entered\n");\r\nsbecom_proc_get_brdinfo(ci, bip);\r\nseq_puts(m, "Board Type: ");\r\nswitch (bip->brd_id) {\r\ncase SBE_BOARD_ID(PCI_VENDOR_ID_SBE, PCI_DEVICE_ID_WANPMC_C1T3):\r\nseq_puts(m, "wanPMC-C1T3");\r\nbreak;\r\ncase SBE_BOARD_ID(PCI_VENDOR_ID_SBE, PCI_DEVICE_ID_WANPTMC_256T3_E1):\r\nseq_puts(m, "wanPTMC-256T3 <E1>");\r\nbreak;\r\ncase SBE_BOARD_ID(PCI_VENDOR_ID_SBE, PCI_DEVICE_ID_WANPTMC_256T3_T1):\r\nseq_puts(m, "wanPTMC-256T3 <T1>");\r\nbreak;\r\ncase SBE_BOARD_ID(PCI_VENDOR_ID_SBE, PCI_DEVICE_ID_WANPTMC_C24TE1):\r\nseq_puts(m, "wanPTMC-C24TE1");\r\nbreak;\r\ncase SBE_BOARD_ID(PCI_VENDOR_ID_SBE, PCI_DEVICE_ID_WANPMC_C4T1E1):\r\ncase SBE_BOARD_ID(PCI_VENDOR_ID_SBE, PCI_DEVICE_ID_WANPMC_C4T1E1_L):\r\nseq_puts(m, "wanPMC-C4T1E1");\r\nbreak;\r\ncase SBE_BOARD_ID(PCI_VENDOR_ID_SBE, PCI_DEVICE_ID_WANPMC_C2T1E1):\r\ncase SBE_BOARD_ID(PCI_VENDOR_ID_SBE, PCI_DEVICE_ID_WANPMC_C2T1E1_L):\r\nseq_puts(m, "wanPMC-C2T1E1");\r\nbreak;\r\ncase SBE_BOARD_ID(PCI_VENDOR_ID_SBE, PCI_DEVICE_ID_WANPMC_C1T1E1):\r\ncase SBE_BOARD_ID(PCI_VENDOR_ID_SBE, PCI_DEVICE_ID_WANPMC_C1T1E1_L):\r\nseq_puts(m, "wanPMC-C1T1E1");\r\nbreak;\r\ncase SBE_BOARD_ID(PCI_VENDOR_ID_SBE, PCI_DEVICE_ID_WANPCI_C4T1E1):\r\nseq_puts(m, "wanPCI-C4T1E1");\r\nbreak;\r\ncase SBE_BOARD_ID(PCI_VENDOR_ID_SBE, PCI_DEVICE_ID_WANPCI_C2T1E1):\r\nseq_puts(m, "wanPCI-C2T1E1");\r\nbreak;\r\ncase SBE_BOARD_ID(PCI_VENDOR_ID_SBE, PCI_DEVICE_ID_WANPCI_C1T1E1):\r\nseq_puts(m, "wanPCI-C1T1E1");\r\nbreak;\r\ndefault:\r\nseq_puts(m, "unknown");\r\nbreak;\r\n}\r\nseq_printf(m, " [%08X]\n", bip->brd_id);\r\nseq_printf(m, "Board Number: %d\n", bip->brdno);\r\nseq_printf(m, "Hardware ID: 0x%02X\n", ci->hdw_bid);\r\nseq_printf(m, "Board SN: %06X\n", bip->brd_sn);\r\nseq_printf(m, "Board MAC: %pMF\n", bip->brd_mac_addr);\r\nseq_printf(m, "Ports: %d\n", ci->max_port);\r\nseq_printf(m, "Channels: %d\n", bip->brd_chan_cnt);\r\n#if 1\r\nseq_printf(m, "Interface: %s -> %s\n",\r\nbip->first_iname, bip->last_iname);\r\n#else\r\nseq_printf(m, "Interface: <not available> 1st %p lst %p\n",\r\nbip->first_iname, bip->last_iname);\r\n#endif\r\nswitch (bip->brd_pci_speed) {\r\ncase BINFO_PCI_SPEED_33:\r\nspd = "33Mhz";\r\nbreak;\r\ncase BINFO_PCI_SPEED_66:\r\nspd = "66Mhz";\r\nbreak;\r\ndefault:\r\nspd = "<not available>";\r\nbreak;\r\n}\r\nseq_printf(m, "PCI Bus Speed: %s\n", spd);\r\nseq_printf(m, "Release: %s\n", ci->release);\r\n#ifdef SBE_PMCC4_ENABLE\r\n{\r\nextern int cxt1e1_max_mru;\r\n#if 0\r\nextern int max_chans_used;\r\nextern int cxt1e1_max_mtu;\r\n#endif\r\nextern int max_rxdesc_used, max_txdesc_used;\r\nseq_printf(m, "\ncxt1e1_max_mru: %d\n", cxt1e1_max_mru);\r\n#if 0\r\nseq_printf(m, "\nmax_chans_used: %d\n", max_chans_used);\r\nseq_printf(m, "cxt1e1_max_mtu: %d\n", cxt1e1_max_mtu);\r\n#endif\r\nseq_printf(m, "max_rxdesc_used: %d\n", max_rxdesc_used);\r\nseq_printf(m, "max_txdesc_used: %d\n", max_txdesc_used);\r\n}\r\n#endif\r\nkfree(bip);\r\npr_devel(">> proc_fs: finished\n");\r\nreturn 0;\r\n}\r\nstatic int sbecom_proc_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, sbecom_proc_get_sbe_info, PDE_DATA(inode));\r\n}\r\nint __init sbecom_proc_brd_init(ci_t *ci)\r\n{\r\nchar dir[7 + SBE_IFACETMPL_SIZE + 1];\r\nsnprintf(dir, sizeof(dir), "driver/%s", ci->devname);\r\nci->dir_dev = proc_mkdir(dir, NULL);\r\nif (!ci->dir_dev) {\r\npr_err("Unable to create directory /proc/driver/%s\n", ci->devname);\r\ngoto fail;\r\n}\r\nif (!proc_create_data("info", S_IFREG | S_IRUGO, ci->dir_dev,\r\n&sbecom_proc_fops, ci)) {\r\npr_err("Unable to create entry /proc/driver/%s/info\n", ci->devname);\r\ngoto fail;\r\n}\r\nreturn 0;\r\nfail:\r\nsbecom_proc_brd_cleanup(ci);\r\nreturn 1;\r\n}

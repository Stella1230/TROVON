static irqreturn_t sdhci_dove_carddetect_irq(int irq, void *data)\r\n{\r\nstruct sdhci_host *host = data;\r\ntasklet_schedule(&host->card_tasklet);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic u16 sdhci_dove_readw(struct sdhci_host *host, int reg)\r\n{\r\nu16 ret;\r\nswitch (reg) {\r\ncase SDHCI_HOST_VERSION:\r\ncase SDHCI_SLOT_INT_STATUS:\r\nreturn 0;\r\ndefault:\r\nret = readw(host->ioaddr + reg);\r\n}\r\nreturn ret;\r\n}\r\nstatic u32 sdhci_dove_readl(struct sdhci_host *host, int reg)\r\n{\r\nstruct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);\r\nstruct sdhci_dove_priv *priv = pltfm_host->priv;\r\nu32 ret;\r\nret = readl(host->ioaddr + reg);\r\nswitch (reg) {\r\ncase SDHCI_CAPABILITIES:\r\nret &= ~SDHCI_CAN_VDD_300;\r\nbreak;\r\ncase SDHCI_PRESENT_STATE:\r\nif (gpio_is_valid(priv->gpio_cd)) {\r\nif (gpio_get_value(priv->gpio_cd) == 0)\r\nret |= SDHCI_CARD_PRESENT;\r\nelse\r\nret &= ~SDHCI_CARD_PRESENT;\r\n}\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int sdhci_dove_probe(struct platform_device *pdev)\r\n{\r\nstruct sdhci_host *host;\r\nstruct sdhci_pltfm_host *pltfm_host;\r\nstruct sdhci_dove_priv *priv;\r\nint ret;\r\npriv = devm_kzalloc(&pdev->dev, sizeof(struct sdhci_dove_priv),\r\nGFP_KERNEL);\r\nif (!priv) {\r\ndev_err(&pdev->dev, "unable to allocate private data");\r\nreturn -ENOMEM;\r\n}\r\npriv->clk = devm_clk_get(&pdev->dev, NULL);\r\nif (pdev->dev.of_node) {\r\npriv->gpio_cd = of_get_named_gpio(pdev->dev.of_node,\r\n"cd-gpios", 0);\r\n} else {\r\npriv->gpio_cd = -EINVAL;\r\n}\r\nif (gpio_is_valid(priv->gpio_cd)) {\r\nret = gpio_request(priv->gpio_cd, "sdhci-cd");\r\nif (ret) {\r\ndev_err(&pdev->dev, "card detect gpio request failed: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\ngpio_direction_input(priv->gpio_cd);\r\n}\r\nhost = sdhci_pltfm_init(pdev, &sdhci_dove_pdata, 0);\r\nif (IS_ERR(host)) {\r\nret = PTR_ERR(host);\r\ngoto err_sdhci_pltfm_init;\r\n}\r\npltfm_host = sdhci_priv(host);\r\npltfm_host->priv = priv;\r\nif (!IS_ERR(priv->clk))\r\nclk_prepare_enable(priv->clk);\r\nsdhci_get_of_property(pdev);\r\nret = sdhci_add_host(host);\r\nif (ret)\r\ngoto err_sdhci_add;\r\nif (gpio_is_valid(priv->gpio_cd)) {\r\nret = request_irq(gpio_to_irq(priv->gpio_cd),\r\nsdhci_dove_carddetect_irq,\r\nIRQF_TRIGGER_FALLING | IRQF_TRIGGER_RISING,\r\nmmc_hostname(host->mmc), host);\r\nif (ret) {\r\ndev_err(&pdev->dev, "card detect irq request failed: %d\n",\r\nret);\r\ngoto err_request_irq;\r\n}\r\n}\r\nreturn 0;\r\nerr_request_irq:\r\nsdhci_remove_host(host, 0);\r\nerr_sdhci_add:\r\nif (!IS_ERR(priv->clk))\r\nclk_disable_unprepare(priv->clk);\r\nsdhci_pltfm_free(pdev);\r\nerr_sdhci_pltfm_init:\r\nif (gpio_is_valid(priv->gpio_cd))\r\ngpio_free(priv->gpio_cd);\r\nreturn ret;\r\n}\r\nstatic int sdhci_dove_remove(struct platform_device *pdev)\r\n{\r\nstruct sdhci_host *host = platform_get_drvdata(pdev);\r\nstruct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);\r\nstruct sdhci_dove_priv *priv = pltfm_host->priv;\r\nsdhci_pltfm_unregister(pdev);\r\nif (gpio_is_valid(priv->gpio_cd)) {\r\nfree_irq(gpio_to_irq(priv->gpio_cd), host);\r\ngpio_free(priv->gpio_cd);\r\n}\r\nif (!IS_ERR(priv->clk))\r\nclk_disable_unprepare(priv->clk);\r\nreturn 0;\r\n}

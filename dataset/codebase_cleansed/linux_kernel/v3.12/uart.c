void ibmasm_register_uart(struct service_processor *sp)\r\n{\r\nstruct uart_8250_port uart;\r\nvoid __iomem *iomem_base;\r\niomem_base = sp->base_address + SCOUT_COM_B_BASE;\r\nif (0 == readl(iomem_base + UART_SCR)) {\r\ndev_info(sp->dev, "IBM SP UART not registered, owned by service processor\n");\r\nsp->serial_line = -1;\r\nreturn;\r\n}\r\nmemset(&uart, 0, sizeof(uart));\r\nuart.port.irq = sp->irq;\r\nuart.port.uartclk = 3686400;\r\nuart.port.flags = UPF_SHARE_IRQ;\r\nuart.port.iotype = UPIO_MEM;\r\nuart.port.membase = iomem_base;\r\nsp->serial_line = serial8250_register_8250_port(&uart);\r\nif (sp->serial_line < 0) {\r\ndev_err(sp->dev, "Failed to register serial port\n");\r\nreturn;\r\n}\r\nenable_uart_interrupts(sp->base_address);\r\n}\r\nvoid ibmasm_unregister_uart(struct service_processor *sp)\r\n{\r\nif (sp->serial_line < 0)\r\nreturn;\r\ndisable_uart_interrupts(sp->base_address);\r\nserial8250_unregister_port(sp->serial_line);\r\n}

static int ep93xxbl_set(struct backlight_device *bl, int brightness)\r\n{\r\nstruct ep93xxbl *ep93xxbl = bl_get_data(bl);\r\nwritel((brightness << 8) | EP93XX_MAX_COUNT, ep93xxbl->mmio);\r\nep93xxbl->brightness = brightness;\r\nreturn 0;\r\n}\r\nstatic int ep93xxbl_update_status(struct backlight_device *bl)\r\n{\r\nint brightness = bl->props.brightness;\r\nif (bl->props.power != FB_BLANK_UNBLANK ||\r\nbl->props.fb_blank != FB_BLANK_UNBLANK)\r\nbrightness = 0;\r\nreturn ep93xxbl_set(bl, brightness);\r\n}\r\nstatic int ep93xxbl_get_brightness(struct backlight_device *bl)\r\n{\r\nstruct ep93xxbl *ep93xxbl = bl_get_data(bl);\r\nreturn ep93xxbl->brightness;\r\n}\r\nstatic int ep93xxbl_probe(struct platform_device *dev)\r\n{\r\nstruct ep93xxbl *ep93xxbl;\r\nstruct backlight_device *bl;\r\nstruct backlight_properties props;\r\nstruct resource *res;\r\nep93xxbl = devm_kzalloc(&dev->dev, sizeof(*ep93xxbl), GFP_KERNEL);\r\nif (!ep93xxbl)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(dev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENXIO;\r\nep93xxbl->mmio = devm_ioremap(&dev->dev, res->start,\r\nresource_size(res));\r\nif (!ep93xxbl->mmio)\r\nreturn -ENXIO;\r\nmemset(&props, 0, sizeof(struct backlight_properties));\r\nprops.type = BACKLIGHT_RAW;\r\nprops.max_brightness = EP93XX_MAX_BRIGHT;\r\nbl = backlight_device_register(dev->name, &dev->dev, ep93xxbl,\r\n&ep93xxbl_ops, &props);\r\nif (IS_ERR(bl))\r\nreturn PTR_ERR(bl);\r\nbl->props.brightness = EP93XX_DEF_BRIGHT;\r\nplatform_set_drvdata(dev, bl);\r\nep93xxbl_update_status(bl);\r\nreturn 0;\r\n}\r\nstatic int ep93xxbl_remove(struct platform_device *dev)\r\n{\r\nstruct backlight_device *bl = platform_get_drvdata(dev);\r\nbacklight_device_unregister(bl);\r\nreturn 0;\r\n}\r\nstatic int ep93xxbl_suspend(struct device *dev)\r\n{\r\nstruct backlight_device *bl = dev_get_drvdata(dev);\r\nreturn ep93xxbl_set(bl, 0);\r\n}\r\nstatic int ep93xxbl_resume(struct device *dev)\r\n{\r\nstruct backlight_device *bl = dev_get_drvdata(dev);\r\nbacklight_update_status(bl);\r\nreturn 0;\r\n}

static inline void fifo_icap_fifo_write(struct hwicap_drvdata *drvdata,\r\nu32 data)\r\n{\r\ndev_dbg(drvdata->dev, "fifo_write: %x\n", data);\r\nout_be32(drvdata->base_address + XHI_WF_OFFSET, data);\r\n}\r\nstatic inline u32 fifo_icap_fifo_read(struct hwicap_drvdata *drvdata)\r\n{\r\nu32 data = in_be32(drvdata->base_address + XHI_RF_OFFSET);\r\ndev_dbg(drvdata->dev, "fifo_read: %x\n", data);\r\nreturn data;\r\n}\r\nstatic inline void fifo_icap_set_read_size(struct hwicap_drvdata *drvdata,\r\nu32 data)\r\n{\r\nout_be32(drvdata->base_address + XHI_SZ_OFFSET, data);\r\n}\r\nstatic inline void fifo_icap_start_config(struct hwicap_drvdata *drvdata)\r\n{\r\nout_be32(drvdata->base_address + XHI_CR_OFFSET, XHI_CR_WRITE_MASK);\r\ndev_dbg(drvdata->dev, "configuration started\n");\r\n}\r\nstatic inline void fifo_icap_start_readback(struct hwicap_drvdata *drvdata)\r\n{\r\nout_be32(drvdata->base_address + XHI_CR_OFFSET, XHI_CR_READ_MASK);\r\ndev_dbg(drvdata->dev, "readback started\n");\r\n}\r\nu32 fifo_icap_get_status(struct hwicap_drvdata *drvdata)\r\n{\r\nu32 status = in_be32(drvdata->base_address + XHI_SR_OFFSET);\r\ndev_dbg(drvdata->dev, "Getting status = %x\n", status);\r\nreturn status;\r\n}\r\nstatic inline u32 fifo_icap_busy(struct hwicap_drvdata *drvdata)\r\n{\r\nu32 status = in_be32(drvdata->base_address + XHI_SR_OFFSET);\r\nreturn (status & XHI_SR_DONE_MASK) ? 0 : 1;\r\n}\r\nstatic inline u32 fifo_icap_write_fifo_vacancy(\r\nstruct hwicap_drvdata *drvdata)\r\n{\r\nreturn in_be32(drvdata->base_address + XHI_WFV_OFFSET);\r\n}\r\nstatic inline u32 fifo_icap_read_fifo_occupancy(\r\nstruct hwicap_drvdata *drvdata)\r\n{\r\nreturn in_be32(drvdata->base_address + XHI_RFO_OFFSET);\r\n}\r\nint fifo_icap_set_configuration(struct hwicap_drvdata *drvdata,\r\nu32 *frame_buffer, u32 num_words)\r\n{\r\nu32 write_fifo_vacancy = 0;\r\nu32 retries = 0;\r\nu32 remaining_words;\r\ndev_dbg(drvdata->dev, "fifo_set_configuration\n");\r\nif (fifo_icap_busy(drvdata))\r\nreturn -EBUSY;\r\nremaining_words = num_words;\r\nwhile (remaining_words > 0) {\r\nwhile (write_fifo_vacancy == 0) {\r\nwrite_fifo_vacancy =\r\nfifo_icap_write_fifo_vacancy(drvdata);\r\nretries++;\r\nif (retries > XHI_MAX_RETRIES)\r\nreturn -EIO;\r\n}\r\nwhile ((write_fifo_vacancy != 0) &&\r\n(remaining_words > 0)) {\r\nfifo_icap_fifo_write(drvdata, *frame_buffer);\r\nremaining_words--;\r\nwrite_fifo_vacancy--;\r\nframe_buffer++;\r\n}\r\nfifo_icap_start_config(drvdata);\r\n}\r\nwhile (fifo_icap_busy(drvdata)) {\r\nretries++;\r\nif (retries > XHI_MAX_RETRIES)\r\nbreak;\r\n}\r\ndev_dbg(drvdata->dev, "done fifo_set_configuration\n");\r\nif (remaining_words != 0)\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nint fifo_icap_get_configuration(struct hwicap_drvdata *drvdata,\r\nu32 *frame_buffer, u32 num_words)\r\n{\r\nu32 read_fifo_occupancy = 0;\r\nu32 retries = 0;\r\nu32 *data = frame_buffer;\r\nu32 remaining_words;\r\nu32 words_to_read;\r\ndev_dbg(drvdata->dev, "fifo_get_configuration\n");\r\nif (fifo_icap_busy(drvdata))\r\nreturn -EBUSY;\r\nremaining_words = num_words;\r\nwhile (remaining_words > 0) {\r\nwords_to_read = remaining_words;\r\nif (words_to_read > XHI_MAX_READ_TRANSACTION_WORDS)\r\nwords_to_read = XHI_MAX_READ_TRANSACTION_WORDS;\r\nremaining_words -= words_to_read;\r\nfifo_icap_set_read_size(drvdata, words_to_read);\r\nfifo_icap_start_readback(drvdata);\r\nwhile (words_to_read > 0) {\r\nwhile (read_fifo_occupancy == 0) {\r\nread_fifo_occupancy =\r\nfifo_icap_read_fifo_occupancy(drvdata);\r\nretries++;\r\nif (retries > XHI_MAX_RETRIES)\r\nreturn -EIO;\r\n}\r\nif (read_fifo_occupancy > words_to_read)\r\nread_fifo_occupancy = words_to_read;\r\nwords_to_read -= read_fifo_occupancy;\r\nwhile (read_fifo_occupancy != 0) {\r\n*data++ = fifo_icap_fifo_read(drvdata);\r\nread_fifo_occupancy--;\r\n}\r\n}\r\n}\r\ndev_dbg(drvdata->dev, "done fifo_get_configuration\n");\r\nreturn 0;\r\n}\r\nvoid fifo_icap_reset(struct hwicap_drvdata *drvdata)\r\n{\r\nu32 reg_data;\r\nreg_data = in_be32(drvdata->base_address + XHI_CR_OFFSET);\r\nout_be32(drvdata->base_address + XHI_CR_OFFSET,\r\nreg_data | XHI_CR_SW_RESET_MASK);\r\nout_be32(drvdata->base_address + XHI_CR_OFFSET,\r\nreg_data & (~XHI_CR_SW_RESET_MASK));\r\n}\r\nvoid fifo_icap_flush_fifo(struct hwicap_drvdata *drvdata)\r\n{\r\nu32 reg_data;\r\nreg_data = in_be32(drvdata->base_address + XHI_CR_OFFSET);\r\nout_be32(drvdata->base_address + XHI_CR_OFFSET,\r\nreg_data | XHI_CR_FIFO_CLR_MASK);\r\nout_be32(drvdata->base_address + XHI_CR_OFFSET,\r\nreg_data & (~XHI_CR_FIFO_CLR_MASK));\r\n}

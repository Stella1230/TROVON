static int ams_delta_set_audio_mode(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_codec *codec = snd_kcontrol_chip(kcontrol);\r\nstruct snd_soc_dapm_context *dapm = &codec->dapm;\r\nstruct soc_enum *control = (struct soc_enum *)kcontrol->private_value;\r\nunsigned short pins;\r\nint pin, changed = 0;\r\nif (!codec->hw_write)\r\nreturn -EUNATCH;\r\nif (ucontrol->value.enumerated.item[0] >= control->max)\r\nreturn -EINVAL;\r\nmutex_lock(&codec->mutex);\r\npins = ams_delta_audio_mode_pins[ucontrol->value.enumerated.item[0]];\r\npin = !!(pins & (1 << AMS_DELTA_MOUTHPIECE));\r\nif (pin != snd_soc_dapm_get_pin_status(dapm, "Mouthpiece")) {\r\nchanged = 1;\r\nif (pin)\r\nsnd_soc_dapm_enable_pin(dapm, "Mouthpiece");\r\nelse\r\nsnd_soc_dapm_disable_pin(dapm, "Mouthpiece");\r\n}\r\npin = !!(pins & (1 << AMS_DELTA_EARPIECE));\r\nif (pin != snd_soc_dapm_get_pin_status(dapm, "Earpiece")) {\r\nchanged = 1;\r\nif (pin)\r\nsnd_soc_dapm_enable_pin(dapm, "Earpiece");\r\nelse\r\nsnd_soc_dapm_disable_pin(dapm, "Earpiece");\r\n}\r\npin = !!(pins & (1 << AMS_DELTA_MICROPHONE));\r\nif (pin != snd_soc_dapm_get_pin_status(dapm, "Microphone")) {\r\nchanged = 1;\r\nif (pin)\r\nsnd_soc_dapm_enable_pin(dapm, "Microphone");\r\nelse\r\nsnd_soc_dapm_disable_pin(dapm, "Microphone");\r\n}\r\npin = !!(pins & (1 << AMS_DELTA_SPEAKER));\r\nif (pin != snd_soc_dapm_get_pin_status(dapm, "Speaker")) {\r\nchanged = 1;\r\nif (pin)\r\nsnd_soc_dapm_enable_pin(dapm, "Speaker");\r\nelse\r\nsnd_soc_dapm_disable_pin(dapm, "Speaker");\r\n}\r\npin = !!(pins & (1 << AMS_DELTA_AGC));\r\nif (pin != ams_delta_audio_agc) {\r\nams_delta_audio_agc = pin;\r\nchanged = 1;\r\nif (pin)\r\nsnd_soc_dapm_enable_pin(dapm, "AGCIN");\r\nelse\r\nsnd_soc_dapm_disable_pin(dapm, "AGCIN");\r\n}\r\nif (changed)\r\nsnd_soc_dapm_sync(dapm);\r\nmutex_unlock(&codec->mutex);\r\nreturn changed;\r\n}\r\nstatic int ams_delta_get_audio_mode(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_codec *codec = snd_kcontrol_chip(kcontrol);\r\nstruct snd_soc_dapm_context *dapm = &codec->dapm;\r\nunsigned short pins, mode;\r\npins = ((snd_soc_dapm_get_pin_status(dapm, "Mouthpiece") <<\r\nAMS_DELTA_MOUTHPIECE) |\r\n(snd_soc_dapm_get_pin_status(dapm, "Earpiece") <<\r\nAMS_DELTA_EARPIECE));\r\nif (pins)\r\npins |= (snd_soc_dapm_get_pin_status(dapm, "Microphone") <<\r\nAMS_DELTA_MICROPHONE);\r\nelse\r\npins = ((snd_soc_dapm_get_pin_status(dapm, "Microphone") <<\r\nAMS_DELTA_MICROPHONE) |\r\n(snd_soc_dapm_get_pin_status(dapm, "Speaker") <<\r\nAMS_DELTA_SPEAKER) |\r\n(ams_delta_audio_agc << AMS_DELTA_AGC));\r\nfor (mode = 0; mode < ARRAY_SIZE(ams_delta_audio_mode); mode++)\r\nif (pins == ams_delta_audio_mode_pins[mode])\r\nbreak;\r\nif (mode >= ARRAY_SIZE(ams_delta_audio_mode))\r\nreturn -EINVAL;\r\nucontrol->value.enumerated.item[0] = mode;\r\nreturn 0;\r\n}\r\nstatic void cx81801_timeout(unsigned long data)\r\n{\r\nint muted;\r\nspin_lock(&ams_delta_lock);\r\ncx81801_cmd_pending = 0;\r\nmuted = ams_delta_muted;\r\nspin_unlock(&ams_delta_lock);\r\nif (!muted)\r\nams_delta_latch2_write(AMS_DELTA_LATCH2_MODEM_CODEC, 0);\r\n}\r\nstatic int cx81801_open(struct tty_struct *tty)\r\n{\r\nint ret;\r\nif (!cx20442_codec)\r\nreturn -ENODEV;\r\ntty->disc_data = cx20442_codec;\r\nret = v253_ops.open(tty);\r\nif (ret < 0)\r\ntty->disc_data = NULL;\r\nreturn ret;\r\n}\r\nstatic void cx81801_close(struct tty_struct *tty)\r\n{\r\nstruct snd_soc_codec *codec = tty->disc_data;\r\nstruct snd_soc_dapm_context *dapm = &codec->dapm;\r\ndel_timer_sync(&cx81801_timer);\r\nINIT_LIST_HEAD(&ams_delta_hook_switch.pins);\r\nif (!codec)\r\nreturn;\r\nv253_ops.close(tty);\r\nsnd_soc_dapm_disable_pin(dapm, "Mouthpiece");\r\nsnd_soc_dapm_enable_pin(dapm, "Earpiece");\r\nsnd_soc_dapm_enable_pin(dapm, "Microphone");\r\nsnd_soc_dapm_disable_pin(dapm, "Speaker");\r\nsnd_soc_dapm_disable_pin(dapm, "AGCIN");\r\nsnd_soc_dapm_sync(dapm);\r\n}\r\nstatic int cx81801_hangup(struct tty_struct *tty)\r\n{\r\ncx81801_close(tty);\r\nreturn 0;\r\n}\r\nstatic void cx81801_receive(struct tty_struct *tty,\r\nconst unsigned char *cp, char *fp, int count)\r\n{\r\nstruct snd_soc_codec *codec = tty->disc_data;\r\nconst unsigned char *c;\r\nint apply, ret;\r\nif (!codec)\r\nreturn;\r\nif (!codec->hw_write) {\r\nsetup_timer(&cx81801_timer, cx81801_timeout, 0);\r\nv253_ops.receive_buf(tty, cp, fp, count);\r\nret = snd_soc_jack_add_pins(&ams_delta_hook_switch,\r\nARRAY_SIZE(ams_delta_hook_switch_pins),\r\nams_delta_hook_switch_pins);\r\nif (ret)\r\ndev_warn(codec->dev,\r\n"Failed to link hook switch to DAPM pins, "\r\n"will continue with hook switch unlinked.\n");\r\nreturn;\r\n}\r\nv253_ops.receive_buf(tty, cp, fp, count);\r\nfor (c = &cp[count - 1]; c >= cp; c--) {\r\nif (*c != '\r')\r\ncontinue;\r\nspin_lock_bh(&ams_delta_lock);\r\nmod_timer(&cx81801_timer, jiffies + msecs_to_jiffies(150));\r\napply = !ams_delta_muted && !cx81801_cmd_pending;\r\ncx81801_cmd_pending = 1;\r\nspin_unlock_bh(&ams_delta_lock);\r\nif (apply)\r\nams_delta_latch2_write(AMS_DELTA_LATCH2_MODEM_CODEC,\r\nAMS_DELTA_LATCH2_MODEM_CODEC);\r\nbreak;\r\n}\r\n}\r\nstatic void cx81801_wakeup(struct tty_struct *tty)\r\n{\r\nv253_ops.write_wakeup(tty);\r\n}\r\nstatic int ams_delta_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nreturn snd_soc_dai_set_fmt(rtd->cpu_dai,\r\nSND_SOC_DAIFMT_DSP_A |\r\nSND_SOC_DAIFMT_NB_NF |\r\nSND_SOC_DAIFMT_CBM_CFM);\r\n}\r\nstatic int ams_delta_digital_mute(struct snd_soc_dai *dai, int mute)\r\n{\r\nint apply;\r\nif (ams_delta_muted == mute)\r\nreturn 0;\r\nspin_lock_bh(&ams_delta_lock);\r\nams_delta_muted = mute;\r\napply = !cx81801_cmd_pending;\r\nspin_unlock_bh(&ams_delta_lock);\r\nif (apply)\r\nams_delta_latch2_write(AMS_DELTA_LATCH2_MODEM_CODEC,\r\nmute ? AMS_DELTA_LATCH2_MODEM_CODEC : 0);\r\nreturn 0;\r\n}\r\nstatic int ams_delta_startup(struct snd_pcm_substream *substream)\r\n{\r\nreturn ams_delta_digital_mute(NULL, 0);\r\n}\r\nstatic void ams_delta_shutdown(struct snd_pcm_substream *substream)\r\n{\r\nams_delta_digital_mute(NULL, 1);\r\n}\r\nstatic int ams_delta_cx20442_init(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct snd_soc_codec *codec = rtd->codec;\r\nstruct snd_soc_dapm_context *dapm = &codec->dapm;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nstruct snd_soc_card *card = rtd->card;\r\nint ret;\r\ncx20442_codec = codec;\r\nif (!codec_dai->driver->ops) {\r\ncodec_dai->driver->ops = &ams_delta_dai_ops;\r\n} else {\r\nams_delta_ops.startup = ams_delta_startup;\r\nams_delta_ops.shutdown = ams_delta_shutdown;\r\n}\r\nret = snd_soc_jack_new(rtd->codec, "hook_switch",\r\nSND_JACK_HEADSET, &ams_delta_hook_switch);\r\nif (ret)\r\ndev_warn(card->dev,\r\n"Failed to allocate resources for hook switch, "\r\n"will continue without one.\n");\r\nelse {\r\nret = snd_soc_jack_add_gpios(&ams_delta_hook_switch,\r\nARRAY_SIZE(ams_delta_hook_switch_gpios),\r\nams_delta_hook_switch_gpios);\r\nif (ret)\r\ndev_warn(card->dev,\r\n"Failed to set up hook switch GPIO line, "\r\n"will continue with hook switch inactive.\n");\r\n}\r\nret = tty_register_ldisc(N_V253, &cx81801_ops);\r\nif (ret) {\r\ndev_warn(card->dev,\r\n"Failed to register line discipline, "\r\n"will continue without any controls.\n");\r\nreturn 0;\r\n}\r\nret = snd_soc_dapm_new_controls(dapm, ams_delta_dapm_widgets,\r\nARRAY_SIZE(ams_delta_dapm_widgets));\r\nif (ret) {\r\ndev_warn(card->dev,\r\n"Failed to register DAPM controls, "\r\n"will continue without any.\n");\r\nreturn 0;\r\n}\r\nret = snd_soc_dapm_add_routes(dapm, ams_delta_audio_map,\r\nARRAY_SIZE(ams_delta_audio_map));\r\nif (ret) {\r\ndev_warn(card->dev,\r\n"Failed to set up DAPM routes, "\r\n"will continue with codec default map.\n");\r\nreturn 0;\r\n}\r\nsnd_soc_dapm_disable_pin(dapm, "Mouthpiece");\r\nsnd_soc_dapm_enable_pin(dapm, "Earpiece");\r\nsnd_soc_dapm_enable_pin(dapm, "Microphone");\r\nsnd_soc_dapm_disable_pin(dapm, "Speaker");\r\nsnd_soc_dapm_disable_pin(dapm, "AGCIN");\r\nsnd_soc_dapm_disable_pin(dapm, "AGCOUT");\r\nret = snd_soc_add_codec_controls(codec, ams_delta_audio_controls,\r\nARRAY_SIZE(ams_delta_audio_controls));\r\nif (ret)\r\ndev_warn(card->dev,\r\n"Failed to register audio mode control, "\r\n"will continue without it.\n");\r\nreturn 0;\r\n}\r\nstatic int ams_delta_probe(struct platform_device *pdev)\r\n{\r\nstruct snd_soc_card *card = &ams_delta_audio_card;\r\nint ret;\r\ncard->dev = &pdev->dev;\r\nret = snd_soc_register_card(card);\r\nif (ret) {\r\ndev_err(&pdev->dev, "snd_soc_register_card failed (%d)\n", ret);\r\ncard->dev = NULL;\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ams_delta_remove(struct platform_device *pdev)\r\n{\r\nstruct snd_soc_card *card = platform_get_drvdata(pdev);\r\nif (tty_unregister_ldisc(N_V253) != 0)\r\ndev_warn(&pdev->dev,\r\n"failed to unregister V253 line discipline\n");\r\nsnd_soc_jack_free_gpios(&ams_delta_hook_switch,\r\nARRAY_SIZE(ams_delta_hook_switch_gpios),\r\nams_delta_hook_switch_gpios);\r\nsnd_soc_unregister_card(card);\r\ncard->dev = NULL;\r\nreturn 0;\r\n}

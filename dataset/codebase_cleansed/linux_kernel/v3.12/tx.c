static u32 convert_radiotap_rate_to_mv(u8 rate)\r\n{\r\nswitch (rate) {\r\ncase 2:\r\nreturn 0 | (1 << 4);\r\ncase 4:\r\nreturn 1 | (1 << 4);\r\ncase 11:\r\nreturn 2 | (1 << 4);\r\ncase 22:\r\nreturn 3 | (1 << 4);\r\ncase 12:\r\nreturn 4 | (1 << 4);\r\ncase 18:\r\nreturn 5 | (1 << 4);\r\ncase 24:\r\nreturn 6 | (1 << 4);\r\ncase 36:\r\nreturn 7 | (1 << 4);\r\ncase 48:\r\nreturn 8 | (1 << 4);\r\ncase 72:\r\nreturn 9 | (1 << 4);\r\ncase 96:\r\nreturn 10 | (1 << 4);\r\ncase 108:\r\nreturn 11 | (1 << 4);\r\n}\r\nreturn 0;\r\n}\r\nnetdev_tx_t lbs_hard_start_xmit(struct sk_buff *skb, struct net_device *dev)\r\n{\r\nunsigned long flags;\r\nstruct lbs_private *priv = dev->ml_priv;\r\nstruct txpd *txpd;\r\nchar *p802x_hdr;\r\nuint16_t pkt_len;\r\nnetdev_tx_t ret = NETDEV_TX_OK;\r\nlbs_deb_enter(LBS_DEB_TX);\r\nspin_lock_irqsave(&priv->driver_lock, flags);\r\nif (priv->surpriseremoved)\r\ngoto free;\r\nif (!skb->len || (skb->len > MRVDRV_ETH_TX_PACKET_BUFFER_SIZE)) {\r\nlbs_deb_tx("tx err: skb length %d 0 or > %zd\n",\r\nskb->len, MRVDRV_ETH_TX_PACKET_BUFFER_SIZE);\r\ndev->stats.tx_dropped++;\r\ndev->stats.tx_errors++;\r\ngoto free;\r\n}\r\nnetif_stop_queue(priv->dev);\r\nif (priv->mesh_dev)\r\nnetif_stop_queue(priv->mesh_dev);\r\nif (priv->tx_pending_len) {\r\nlbs_deb_tx("Packet on %s while busy\n", dev->name);\r\nret = NETDEV_TX_BUSY;\r\ngoto unlock;\r\n}\r\npriv->tx_pending_len = -1;\r\nspin_unlock_irqrestore(&priv->driver_lock, flags);\r\nlbs_deb_hex(LBS_DEB_TX, "TX Data", skb->data, min_t(unsigned int, skb->len, 100));\r\ntxpd = (void *)priv->tx_pending_buf;\r\nmemset(txpd, 0, sizeof(struct txpd));\r\np802x_hdr = skb->data;\r\npkt_len = skb->len;\r\nif (priv->wdev->iftype == NL80211_IFTYPE_MONITOR) {\r\nstruct tx_radiotap_hdr *rtap_hdr = (void *)skb->data;\r\ntxpd->tx_control = cpu_to_le32(convert_radiotap_rate_to_mv(rtap_hdr->rate));\r\np802x_hdr += sizeof(*rtap_hdr);\r\npkt_len -= sizeof(*rtap_hdr);\r\nmemcpy(txpd->tx_dest_addr_high, p802x_hdr + 4, ETH_ALEN);\r\n} else {\r\nmemcpy(txpd->tx_dest_addr_high, p802x_hdr, ETH_ALEN);\r\n}\r\ntxpd->tx_packet_length = cpu_to_le16(pkt_len);\r\ntxpd->tx_packet_location = cpu_to_le32(sizeof(struct txpd));\r\nlbs_mesh_set_txpd(priv, dev, txpd);\r\nlbs_deb_hex(LBS_DEB_TX, "txpd", (u8 *) &txpd, sizeof(struct txpd));\r\nlbs_deb_hex(LBS_DEB_TX, "Tx Data", (u8 *) p802x_hdr, le16_to_cpu(txpd->tx_packet_length));\r\nmemcpy(&txpd[1], p802x_hdr, le16_to_cpu(txpd->tx_packet_length));\r\nspin_lock_irqsave(&priv->driver_lock, flags);\r\npriv->tx_pending_len = pkt_len + sizeof(struct txpd);\r\nlbs_deb_tx("%s lined up packet\n", __func__);\r\ndev->stats.tx_packets++;\r\ndev->stats.tx_bytes += skb->len;\r\nif (priv->wdev->iftype == NL80211_IFTYPE_MONITOR) {\r\nskb_orphan(skb);\r\npriv->currenttxskb = skb;\r\n} else {\r\nfree:\r\ndev_kfree_skb_any(skb);\r\n}\r\nunlock:\r\nspin_unlock_irqrestore(&priv->driver_lock, flags);\r\nwake_up(&priv->waitq);\r\nlbs_deb_leave_args(LBS_DEB_TX, "ret %d", ret);\r\nreturn ret;\r\n}\r\nvoid lbs_send_tx_feedback(struct lbs_private *priv, u32 try_count)\r\n{\r\nstruct tx_radiotap_hdr *radiotap_hdr;\r\nif (priv->wdev->iftype != NL80211_IFTYPE_MONITOR ||\r\npriv->currenttxskb == NULL)\r\nreturn;\r\nradiotap_hdr = (struct tx_radiotap_hdr *)priv->currenttxskb->data;\r\nradiotap_hdr->data_retries = try_count ?\r\n(1 + priv->txretrycount - try_count) : 0;\r\npriv->currenttxskb->protocol = eth_type_trans(priv->currenttxskb,\r\npriv->dev);\r\nnetif_rx(priv->currenttxskb);\r\npriv->currenttxskb = NULL;\r\nif (priv->connect_status == LBS_CONNECTED)\r\nnetif_wake_queue(priv->dev);\r\nif (priv->mesh_dev && netif_running(priv->mesh_dev))\r\nnetif_wake_queue(priv->mesh_dev);\r\n}

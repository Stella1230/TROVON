const char *memstick_debug_get_tpc_name(int tpc)\r\n{\r\nreturn tpc_names[tpc-1];\r\n}\r\nstatic inline u32 r592_read_reg(struct r592_device *dev, int address)\r\n{\r\nu32 value = readl(dev->mmio + address);\r\ndbg_reg("reg #%02d == 0x%08x", address, value);\r\nreturn value;\r\n}\r\nstatic inline void r592_write_reg(struct r592_device *dev,\r\nint address, u32 value)\r\n{\r\ndbg_reg("reg #%02d <- 0x%08x", address, value);\r\nwritel(value, dev->mmio + address);\r\n}\r\nstatic inline u32 r592_read_reg_raw_be(struct r592_device *dev, int address)\r\n{\r\nu32 value = __raw_readl(dev->mmio + address);\r\ndbg_reg("reg #%02d == 0x%08x", address, value);\r\nreturn be32_to_cpu(value);\r\n}\r\nstatic inline void r592_write_reg_raw_be(struct r592_device *dev,\r\nint address, u32 value)\r\n{\r\ndbg_reg("reg #%02d <- 0x%08x", address, value);\r\n__raw_writel(cpu_to_be32(value), dev->mmio + address);\r\n}\r\nstatic inline void r592_set_reg_mask(struct r592_device *dev,\r\nint address, u32 mask)\r\n{\r\nu32 reg = readl(dev->mmio + address);\r\ndbg_reg("reg #%02d |= 0x%08x (old =0x%08x)", address, mask, reg);\r\nwritel(reg | mask , dev->mmio + address);\r\n}\r\nstatic inline void r592_clear_reg_mask(struct r592_device *dev,\r\nint address, u32 mask)\r\n{\r\nu32 reg = readl(dev->mmio + address);\r\ndbg_reg("reg #%02d &= 0x%08x (old = 0x%08x, mask = 0x%08x)",\r\naddress, ~mask, reg, mask);\r\nwritel(reg & ~mask, dev->mmio + address);\r\n}\r\nstatic int r592_wait_status(struct r592_device *dev, u32 mask, u32 wanted_mask)\r\n{\r\nunsigned long timeout = jiffies + msecs_to_jiffies(1000);\r\nu32 reg = r592_read_reg(dev, R592_STATUS);\r\nif ((reg & mask) == wanted_mask)\r\nreturn 0;\r\nwhile (time_before(jiffies, timeout)) {\r\nreg = r592_read_reg(dev, R592_STATUS);\r\nif ((reg & mask) == wanted_mask)\r\nreturn 0;\r\nif (reg & (R592_STATUS_SEND_ERR | R592_STATUS_RECV_ERR))\r\nreturn -EIO;\r\ncpu_relax();\r\n}\r\nreturn -ETIME;\r\n}\r\nstatic int r592_enable_device(struct r592_device *dev, bool enable)\r\n{\r\ndbg("%sabling the device", enable ? "en" : "dis");\r\nif (enable) {\r\nr592_write_reg(dev, R592_POWER, R592_POWER_0 | R592_POWER_1);\r\nr592_set_reg_mask(dev, R592_IO, R592_IO_RESET);\r\nmsleep(100);\r\n} else\r\nr592_write_reg(dev, R592_POWER, 0);\r\nreturn 0;\r\n}\r\nstatic int r592_set_mode(struct r592_device *dev, bool parallel_mode)\r\n{\r\nif (!parallel_mode) {\r\ndbg("switching to serial mode");\r\nr592_write_reg(dev, R592_IO_MODE, R592_IO_MODE_SERIAL);\r\nr592_clear_reg_mask(dev, R592_POWER, R592_POWER_20);\r\n} else {\r\ndbg("switching to parallel mode");\r\nr592_set_reg_mask(dev, R592_POWER, R592_POWER_20);\r\nr592_clear_reg_mask(dev, R592_IO,\r\nR592_IO_SERIAL1 | R592_IO_SERIAL2);\r\nr592_write_reg(dev, R592_IO_MODE, R592_IO_MODE_PARALLEL);\r\n}\r\ndev->parallel_mode = parallel_mode;\r\nreturn 0;\r\n}\r\nstatic void r592_host_reset(struct r592_device *dev)\r\n{\r\nr592_set_reg_mask(dev, R592_IO, R592_IO_RESET);\r\nmsleep(100);\r\nr592_set_mode(dev, dev->parallel_mode);\r\n}\r\nstatic void r592_clear_interrupts(struct r592_device *dev)\r\n{\r\nr592_clear_reg_mask(dev, R592_REG_MSC, IRQ_ALL_ACK_MASK);\r\nr592_clear_reg_mask(dev, R592_REG_MSC, IRQ_ALL_EN_MASK);\r\n}\r\nstatic int r592_test_io_error(struct r592_device *dev)\r\n{\r\nif (!(r592_read_reg(dev, R592_STATUS) &\r\n(R592_STATUS_SEND_ERR | R592_STATUS_RECV_ERR)))\r\nreturn 0;\r\nreturn -EIO;\r\n}\r\nstatic int r592_test_fifo_empty(struct r592_device *dev)\r\n{\r\nif (r592_read_reg(dev, R592_REG_MSC) & R592_REG_MSC_FIFO_EMPTY)\r\nreturn 0;\r\ndbg("FIFO not ready, trying to reset the device");\r\nr592_host_reset(dev);\r\nif (r592_read_reg(dev, R592_REG_MSC) & R592_REG_MSC_FIFO_EMPTY)\r\nreturn 0;\r\nmessage("FIFO still not ready, giving up");\r\nreturn -EIO;\r\n}\r\nstatic void r592_start_dma(struct r592_device *dev, bool is_write)\r\n{\r\nunsigned long flags;\r\nu32 reg;\r\nspin_lock_irqsave(&dev->irq_lock, flags);\r\nr592_clear_reg_mask(dev, R592_REG_MSC, DMA_IRQ_ACK_MASK);\r\nr592_set_reg_mask(dev, R592_REG_MSC, DMA_IRQ_EN_MASK);\r\nr592_write_reg(dev, R592_FIFO_DMA, sg_dma_address(&dev->req->sg));\r\nreg = r592_read_reg(dev, R592_FIFO_DMA_SETTINGS);\r\nreg |= R592_FIFO_DMA_SETTINGS_EN;\r\nif (!is_write)\r\nreg |= R592_FIFO_DMA_SETTINGS_DIR;\r\nelse\r\nreg &= ~R592_FIFO_DMA_SETTINGS_DIR;\r\nr592_write_reg(dev, R592_FIFO_DMA_SETTINGS, reg);\r\nspin_unlock_irqrestore(&dev->irq_lock, flags);\r\n}\r\nstatic void r592_stop_dma(struct r592_device *dev, int error)\r\n{\r\nr592_clear_reg_mask(dev, R592_FIFO_DMA_SETTINGS,\r\nR592_FIFO_DMA_SETTINGS_EN);\r\nr592_write_reg(dev, R592_FIFO_DMA,\r\ndev->dummy_dma_page_physical_address);\r\nr592_clear_reg_mask(dev, R592_REG_MSC, DMA_IRQ_EN_MASK);\r\nr592_clear_reg_mask(dev, R592_REG_MSC, DMA_IRQ_ACK_MASK);\r\ndev->dma_error = error;\r\n}\r\nstatic void r592_check_dma(struct r592_device *dev)\r\n{\r\ndev->dma_capable = r592_enable_dma &&\r\n(r592_read_reg(dev, R592_FIFO_DMA_SETTINGS) &\r\nR592_FIFO_DMA_SETTINGS_CAP);\r\n}\r\nstatic int r592_transfer_fifo_dma(struct r592_device *dev)\r\n{\r\nint len, sg_count;\r\nbool is_write;\r\nif (!dev->dma_capable || !dev->req->long_data)\r\nreturn -EINVAL;\r\nlen = dev->req->sg.length;\r\nis_write = dev->req->data_dir == WRITE;\r\nif (len != R592_LFIFO_SIZE)\r\nreturn -EINVAL;\r\ndbg_verbose("doing dma transfer");\r\ndev->dma_error = 0;\r\nINIT_COMPLETION(dev->dma_done);\r\nsg_count = dma_map_sg(&dev->pci_dev->dev, &dev->req->sg, 1, is_write ?\r\nPCI_DMA_TODEVICE : PCI_DMA_FROMDEVICE);\r\nif (sg_count != 1 ||\r\n(sg_dma_len(&dev->req->sg) < dev->req->sg.length)) {\r\nmessage("problem in dma_map_sg");\r\nreturn -EIO;\r\n}\r\nr592_start_dma(dev, is_write);\r\nif (!wait_for_completion_timeout(\r\n&dev->dma_done, msecs_to_jiffies(1000))) {\r\nmessage("DMA timeout");\r\nr592_stop_dma(dev, -ETIMEDOUT);\r\n}\r\ndma_unmap_sg(&dev->pci_dev->dev, &dev->req->sg, 1, is_write ?\r\nPCI_DMA_TODEVICE : PCI_DMA_FROMDEVICE);\r\nreturn dev->dma_error;\r\n}\r\nstatic void r592_write_fifo_pio(struct r592_device *dev,\r\nunsigned char *buffer, int len)\r\n{\r\nif (!kfifo_is_empty(&dev->pio_fifo)) {\r\nu8 tmp[4] = {0};\r\nint copy_len = kfifo_in(&dev->pio_fifo, buffer, len);\r\nif (!kfifo_is_full(&dev->pio_fifo))\r\nreturn;\r\nlen -= copy_len;\r\nbuffer += copy_len;\r\ncopy_len = kfifo_out(&dev->pio_fifo, tmp, 4);\r\nWARN_ON(copy_len != 4);\r\nr592_write_reg_raw_be(dev, R592_FIFO_PIO, *(u32 *)tmp);\r\n}\r\nWARN_ON(!kfifo_is_empty(&dev->pio_fifo));\r\nwhile (len >= 4) {\r\nr592_write_reg_raw_be(dev, R592_FIFO_PIO, *(u32 *)buffer);\r\nbuffer += 4;\r\nlen -= 4;\r\n}\r\nif (len)\r\nkfifo_in(&dev->pio_fifo, buffer, len);\r\n}\r\nstatic void r592_flush_fifo_write(struct r592_device *dev)\r\n{\r\nu8 buffer[4] = { 0 };\r\nint len;\r\nif (kfifo_is_empty(&dev->pio_fifo))\r\nreturn;\r\nlen = kfifo_out(&dev->pio_fifo, buffer, 4);\r\nr592_write_reg_raw_be(dev, R592_FIFO_PIO, *(u32 *)buffer);\r\n}\r\nstatic void r592_read_fifo_pio(struct r592_device *dev,\r\nunsigned char *buffer, int len)\r\n{\r\nu8 tmp[4];\r\nif (!kfifo_is_empty(&dev->pio_fifo)) {\r\nint bytes_copied =\r\nkfifo_out(&dev->pio_fifo, buffer, min(4, len));\r\nbuffer += bytes_copied;\r\nlen -= bytes_copied;\r\nif (!kfifo_is_empty(&dev->pio_fifo))\r\nreturn;\r\n}\r\nwhile (len >= 4) {\r\n*(u32 *)buffer = r592_read_reg_raw_be(dev, R592_FIFO_PIO);\r\nbuffer += 4;\r\nlen -= 4;\r\n}\r\nif (len) {\r\n*(u32 *)tmp = r592_read_reg_raw_be(dev, R592_FIFO_PIO);\r\nkfifo_in(&dev->pio_fifo, tmp, 4);\r\nlen -= kfifo_out(&dev->pio_fifo, buffer, len);\r\n}\r\nWARN_ON(len);\r\nreturn;\r\n}\r\nstatic int r592_transfer_fifo_pio(struct r592_device *dev)\r\n{\r\nunsigned long flags;\r\nbool is_write = dev->req->tpc >= MS_TPC_SET_RW_REG_ADRS;\r\nstruct sg_mapping_iter miter;\r\nkfifo_reset(&dev->pio_fifo);\r\nif (!dev->req->long_data) {\r\nif (is_write) {\r\nr592_write_fifo_pio(dev, dev->req->data,\r\ndev->req->data_len);\r\nr592_flush_fifo_write(dev);\r\n} else\r\nr592_read_fifo_pio(dev, dev->req->data,\r\ndev->req->data_len);\r\nreturn 0;\r\n}\r\nlocal_irq_save(flags);\r\nsg_miter_start(&miter, &dev->req->sg, 1, SG_MITER_ATOMIC |\r\n(is_write ? SG_MITER_FROM_SG : SG_MITER_TO_SG));\r\nwhile (sg_miter_next(&miter))\r\nif (is_write)\r\nr592_write_fifo_pio(dev, miter.addr, miter.length);\r\nelse\r\nr592_read_fifo_pio(dev, miter.addr, miter.length);\r\nif (is_write)\r\nr592_flush_fifo_write(dev);\r\nsg_miter_stop(&miter);\r\nlocal_irq_restore(flags);\r\nreturn 0;\r\n}\r\nstatic void r592_execute_tpc(struct r592_device *dev)\r\n{\r\nbool is_write;\r\nint len, error;\r\nu32 status, reg;\r\nif (!dev->req) {\r\nmessage("BUG: tpc execution without request!");\r\nreturn;\r\n}\r\nis_write = dev->req->tpc >= MS_TPC_SET_RW_REG_ADRS;\r\nlen = dev->req->long_data ?\r\ndev->req->sg.length : dev->req->data_len;\r\nif (len > R592_LFIFO_SIZE) {\r\nmessage("IO: hardware doesn't support TPCs longer that 512");\r\nerror = -ENOSYS;\r\ngoto out;\r\n}\r\nif (!(r592_read_reg(dev, R592_REG_MSC) & R592_REG_MSC_PRSNT)) {\r\ndbg("IO: refusing to send TPC because card is absent");\r\nerror = -ENODEV;\r\ngoto out;\r\n}\r\ndbg("IO: executing %s LEN=%d",\r\nmemstick_debug_get_tpc_name(dev->req->tpc), len);\r\nif (is_write)\r\nr592_set_reg_mask(dev, R592_IO, R592_IO_DIRECTION);\r\nelse\r\nr592_clear_reg_mask(dev, R592_IO, R592_IO_DIRECTION);\r\nerror = r592_test_fifo_empty(dev);\r\nif (error)\r\ngoto out;\r\nif (is_write) {\r\nerror = r592_transfer_fifo_dma(dev);\r\nif (error == -EINVAL)\r\nerror = r592_transfer_fifo_pio(dev);\r\n}\r\nif (error)\r\ngoto out;\r\nreg = (len << R592_TPC_EXEC_LEN_SHIFT) |\r\n(dev->req->tpc << R592_TPC_EXEC_TPC_SHIFT) |\r\nR592_TPC_EXEC_BIG_FIFO;\r\nr592_write_reg(dev, R592_TPC_EXEC, reg);\r\nstatus = R592_STATUS_RDY;\r\nif (dev->req->need_card_int)\r\nstatus |= R592_STATUS_CED;\r\nerror = r592_wait_status(dev, status, status);\r\nif (error) {\r\nmessage("card didn't respond");\r\ngoto out;\r\n}\r\nerror = r592_test_io_error(dev);\r\nif (error) {\r\ndbg("IO error");\r\ngoto out;\r\n}\r\nif (!is_write) {\r\nerror = r592_transfer_fifo_dma(dev);\r\nif (error == -EINVAL)\r\nerror = r592_transfer_fifo_pio(dev);\r\n}\r\nif (dev->parallel_mode && dev->req->need_card_int) {\r\ndev->req->int_reg = 0;\r\nstatus = r592_read_reg(dev, R592_STATUS);\r\nif (status & R592_STATUS_P_CMDNACK)\r\ndev->req->int_reg |= MEMSTICK_INT_CMDNAK;\r\nif (status & R592_STATUS_P_BREQ)\r\ndev->req->int_reg |= MEMSTICK_INT_BREQ;\r\nif (status & R592_STATUS_P_INTERR)\r\ndev->req->int_reg |= MEMSTICK_INT_ERR;\r\nif (status & R592_STATUS_P_CED)\r\ndev->req->int_reg |= MEMSTICK_INT_CED;\r\n}\r\nif (error)\r\ndbg("FIFO read error");\r\nout:\r\ndev->req->error = error;\r\nr592_clear_reg_mask(dev, R592_REG_MSC, R592_REG_MSC_LED);\r\nreturn;\r\n}\r\nstatic int r592_process_thread(void *data)\r\n{\r\nint error;\r\nstruct r592_device *dev = (struct r592_device *)data;\r\nunsigned long flags;\r\nwhile (!kthread_should_stop()) {\r\nspin_lock_irqsave(&dev->io_thread_lock, flags);\r\nset_current_state(TASK_INTERRUPTIBLE);\r\nerror = memstick_next_req(dev->host, &dev->req);\r\nspin_unlock_irqrestore(&dev->io_thread_lock, flags);\r\nif (error) {\r\nif (error == -ENXIO || error == -EAGAIN) {\r\ndbg_verbose("IO: done IO, sleeping");\r\n} else {\r\ndbg("IO: unknown error from "\r\n"memstick_next_req %d", error);\r\n}\r\nif (kthread_should_stop())\r\nset_current_state(TASK_RUNNING);\r\nschedule();\r\n} else {\r\nset_current_state(TASK_RUNNING);\r\nr592_execute_tpc(dev);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void r592_update_card_detect(struct r592_device *dev)\r\n{\r\nu32 reg = r592_read_reg(dev, R592_REG_MSC);\r\nbool card_detected = reg & R592_REG_MSC_PRSNT;\r\ndbg("update card detect. card state: %s", card_detected ?\r\n"present" : "absent");\r\nreg &= ~((R592_REG_MSC_IRQ_REMOVE | R592_REG_MSC_IRQ_INSERT) << 16);\r\nif (card_detected)\r\nreg |= (R592_REG_MSC_IRQ_REMOVE << 16);\r\nelse\r\nreg |= (R592_REG_MSC_IRQ_INSERT << 16);\r\nr592_write_reg(dev, R592_REG_MSC, reg);\r\n}\r\nstatic void r592_detect_timer(long unsigned int data)\r\n{\r\nstruct r592_device *dev = (struct r592_device *)data;\r\nr592_update_card_detect(dev);\r\nmemstick_detect_change(dev->host);\r\n}\r\nstatic irqreturn_t r592_irq(int irq, void *data)\r\n{\r\nstruct r592_device *dev = (struct r592_device *)data;\r\nirqreturn_t ret = IRQ_NONE;\r\nu32 reg;\r\nu16 irq_enable, irq_status;\r\nunsigned long flags;\r\nint error;\r\nspin_lock_irqsave(&dev->irq_lock, flags);\r\nreg = r592_read_reg(dev, R592_REG_MSC);\r\nirq_enable = reg >> 16;\r\nirq_status = reg & 0xFFFF;\r\nreg &= ~irq_status;\r\nr592_write_reg(dev, R592_REG_MSC, reg);\r\nirq_status &= (irq_enable);\r\nif (irq_status & (R592_REG_MSC_IRQ_INSERT | R592_REG_MSC_IRQ_REMOVE)) {\r\nbool card_was_added = irq_status & R592_REG_MSC_IRQ_INSERT;\r\nret = IRQ_HANDLED;\r\nmessage("IRQ: card %s", card_was_added ? "added" : "removed");\r\nmod_timer(&dev->detect_timer,\r\njiffies + msecs_to_jiffies(card_was_added ? 500 : 50));\r\n}\r\nif (irq_status &\r\n(R592_REG_MSC_FIFO_DMA_DONE | R592_REG_MSC_FIFO_DMA_ERR)) {\r\nret = IRQ_HANDLED;\r\nif (irq_status & R592_REG_MSC_FIFO_DMA_ERR) {\r\nmessage("IRQ: DMA error");\r\nerror = -EIO;\r\n} else {\r\ndbg_verbose("IRQ: dma done");\r\nerror = 0;\r\n}\r\nr592_stop_dma(dev, error);\r\ncomplete(&dev->dma_done);\r\n}\r\nspin_unlock_irqrestore(&dev->irq_lock, flags);\r\nreturn ret;\r\n}\r\nstatic int r592_set_param(struct memstick_host *host,\r\nenum memstick_param param, int value)\r\n{\r\nstruct r592_device *dev = memstick_priv(host);\r\nswitch (param) {\r\ncase MEMSTICK_POWER:\r\nswitch (value) {\r\ncase MEMSTICK_POWER_ON:\r\nreturn r592_enable_device(dev, true);\r\ncase MEMSTICK_POWER_OFF:\r\nreturn r592_enable_device(dev, false);\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ncase MEMSTICK_INTERFACE:\r\nswitch (value) {\r\ncase MEMSTICK_SERIAL:\r\nreturn r592_set_mode(dev, 0);\r\ncase MEMSTICK_PAR4:\r\nreturn r592_set_mode(dev, 1);\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic void r592_submit_req(struct memstick_host *host)\r\n{\r\nstruct r592_device *dev = memstick_priv(host);\r\nunsigned long flags;\r\nif (dev->req)\r\nreturn;\r\nspin_lock_irqsave(&dev->io_thread_lock, flags);\r\nif (wake_up_process(dev->io_thread))\r\ndbg_verbose("IO thread woken to process requests");\r\nspin_unlock_irqrestore(&dev->io_thread_lock, flags);\r\n}\r\nstatic int r592_probe(struct pci_dev *pdev, const struct pci_device_id *id)\r\n{\r\nint error = -ENOMEM;\r\nstruct memstick_host *host;\r\nstruct r592_device *dev;\r\nhost = memstick_alloc_host(sizeof(struct r592_device), &pdev->dev);\r\nif (!host)\r\ngoto error1;\r\ndev = memstick_priv(host);\r\ndev->host = host;\r\ndev->pci_dev = pdev;\r\npci_set_drvdata(pdev, dev);\r\nerror = pci_enable_device(pdev);\r\nif (error)\r\ngoto error2;\r\npci_set_master(pdev);\r\nerror = pci_set_dma_mask(pdev, DMA_BIT_MASK(32));\r\nif (error)\r\ngoto error3;\r\nerror = pci_request_regions(pdev, DRV_NAME);\r\nif (error)\r\ngoto error3;\r\ndev->mmio = pci_ioremap_bar(pdev, 0);\r\nif (!dev->mmio)\r\ngoto error4;\r\ndev->irq = pdev->irq;\r\nspin_lock_init(&dev->irq_lock);\r\nspin_lock_init(&dev->io_thread_lock);\r\ninit_completion(&dev->dma_done);\r\nINIT_KFIFO(dev->pio_fifo);\r\nsetup_timer(&dev->detect_timer,\r\nr592_detect_timer, (long unsigned int)dev);\r\nhost->caps = MEMSTICK_CAP_PAR4;\r\nhost->request = r592_submit_req;\r\nhost->set_param = r592_set_param;\r\nr592_check_dma(dev);\r\ndev->io_thread = kthread_run(r592_process_thread, dev, "r592_io");\r\nif (IS_ERR(dev->io_thread)) {\r\nerror = PTR_ERR(dev->io_thread);\r\ngoto error5;\r\n}\r\ndev->dummy_dma_page = pci_alloc_consistent(pdev, PAGE_SIZE,\r\n&dev->dummy_dma_page_physical_address);\r\nr592_stop_dma(dev , 0);\r\nif (request_irq(dev->irq, &r592_irq, IRQF_SHARED,\r\nDRV_NAME, dev))\r\ngoto error6;\r\nr592_update_card_detect(dev);\r\nif (memstick_add_host(host))\r\ngoto error7;\r\nmessage("driver successfully loaded");\r\nreturn 0;\r\nerror7:\r\nfree_irq(dev->irq, dev);\r\nerror6:\r\nif (dev->dummy_dma_page)\r\npci_free_consistent(pdev, PAGE_SIZE, dev->dummy_dma_page,\r\ndev->dummy_dma_page_physical_address);\r\nkthread_stop(dev->io_thread);\r\nerror5:\r\niounmap(dev->mmio);\r\nerror4:\r\npci_release_regions(pdev);\r\nerror3:\r\npci_disable_device(pdev);\r\nerror2:\r\nmemstick_free_host(host);\r\nerror1:\r\nreturn error;\r\n}\r\nstatic void r592_remove(struct pci_dev *pdev)\r\n{\r\nint error = 0;\r\nstruct r592_device *dev = pci_get_drvdata(pdev);\r\nkthread_stop(dev->io_thread);\r\nr592_enable_device(dev, false);\r\nwhile (!error && dev->req) {\r\ndev->req->error = -ETIME;\r\nerror = memstick_next_req(dev->host, &dev->req);\r\n}\r\nmemstick_remove_host(dev->host);\r\nfree_irq(dev->irq, dev);\r\niounmap(dev->mmio);\r\npci_release_regions(pdev);\r\npci_disable_device(pdev);\r\nmemstick_free_host(dev->host);\r\nif (dev->dummy_dma_page)\r\npci_free_consistent(pdev, PAGE_SIZE, dev->dummy_dma_page,\r\ndev->dummy_dma_page_physical_address);\r\n}\r\nstatic int r592_suspend(struct device *core_dev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(core_dev);\r\nstruct r592_device *dev = pci_get_drvdata(pdev);\r\nr592_clear_interrupts(dev);\r\nmemstick_suspend_host(dev->host);\r\ndel_timer_sync(&dev->detect_timer);\r\nreturn 0;\r\n}\r\nstatic int r592_resume(struct device *core_dev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(core_dev);\r\nstruct r592_device *dev = pci_get_drvdata(pdev);\r\nr592_clear_interrupts(dev);\r\nr592_enable_device(dev, false);\r\nmemstick_resume_host(dev->host);\r\nr592_update_card_detect(dev);\r\nreturn 0;\r\n}

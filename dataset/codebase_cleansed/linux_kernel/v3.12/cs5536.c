static int cs5536_read(struct pci_dev *pdev, int reg, u32 *val)\r\n{\r\nif (unlikely(use_msr)) {\r\nu32 dummy;\r\nrdmsr(MSR_IDE_CFG + reg, *val, dummy);\r\nreturn 0;\r\n}\r\nreturn pci_read_config_dword(pdev, PCI_IDE_CFG + reg * 4, val);\r\n}\r\nstatic int cs5536_write(struct pci_dev *pdev, int reg, int val)\r\n{\r\nif (unlikely(use_msr)) {\r\nwrmsr(MSR_IDE_CFG + reg, val, 0);\r\nreturn 0;\r\n}\r\nreturn pci_write_config_dword(pdev, PCI_IDE_CFG + reg * 4, val);\r\n}\r\nstatic void cs5536_program_dtc(ide_drive_t *drive, u8 tim)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(drive->hwif->dev);\r\nint dshift = (drive->dn & 1) ? IDE_D1_SHIFT : IDE_D0_SHIFT;\r\nu32 dtc;\r\ncs5536_read(pdev, DTC, &dtc);\r\ndtc &= ~(IDE_DRV_MASK << dshift);\r\ndtc |= tim << dshift;\r\ncs5536_write(pdev, DTC, dtc);\r\n}\r\nstatic u8 cs5536_cable_detect(ide_hwif_t *hwif)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(hwif->dev);\r\nu32 cfg;\r\ncs5536_read(pdev, CFG, &cfg);\r\nif (cfg & IDE_CFG_CABLE)\r\nreturn ATA_CBL_PATA80;\r\nelse\r\nreturn ATA_CBL_PATA40;\r\n}\r\nstatic void cs5536_set_pio_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nstatic const u8 drv_timings[5] = {\r\n0x98, 0x55, 0x32, 0x21, 0x20,\r\n};\r\nstatic const u8 addr_timings[5] = {\r\n0x2, 0x1, 0x0, 0x0, 0x0,\r\n};\r\nstatic const u8 cmd_timings[5] = {\r\n0x99, 0x92, 0x90, 0x22, 0x20,\r\n};\r\nstruct pci_dev *pdev = to_pci_dev(hwif->dev);\r\nide_drive_t *pair = ide_get_pair_dev(drive);\r\nint cshift = (drive->dn & 1) ? IDE_CAST_D1_SHIFT : IDE_CAST_D0_SHIFT;\r\nunsigned long timings = (unsigned long)ide_get_drivedata(drive);\r\nu32 cast;\r\nconst u8 pio = drive->pio_mode - XFER_PIO_0;\r\nu8 cmd_pio = pio;\r\nif (pair)\r\ncmd_pio = min_t(u8, pio, pair->pio_mode - XFER_PIO_0);\r\ntimings &= (IDE_DRV_MASK << 8);\r\ntimings |= drv_timings[pio];\r\nide_set_drivedata(drive, (void *)timings);\r\ncs5536_program_dtc(drive, drv_timings[pio]);\r\ncs5536_read(pdev, CAST, &cast);\r\ncast &= ~(IDE_CAST_DRV_MASK << cshift);\r\ncast |= addr_timings[pio] << cshift;\r\ncast &= ~(IDE_CAST_CMD_MASK << IDE_CAST_CMD_SHIFT);\r\ncast |= cmd_timings[cmd_pio] << IDE_CAST_CMD_SHIFT;\r\ncs5536_write(pdev, CAST, cast);\r\n}\r\nstatic void cs5536_set_dma_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nstatic const u8 udma_timings[6] = {\r\n0xc2, 0xc1, 0xc0, 0xc4, 0xc5, 0xc6,\r\n};\r\nstatic const u8 mwdma_timings[3] = {\r\n0x67, 0x21, 0x20,\r\n};\r\nstruct pci_dev *pdev = to_pci_dev(hwif->dev);\r\nint dshift = (drive->dn & 1) ? IDE_D1_SHIFT : IDE_D0_SHIFT;\r\nunsigned long timings = (unsigned long)ide_get_drivedata(drive);\r\nu32 etc;\r\nconst u8 mode = drive->dma_mode;\r\ncs5536_read(pdev, ETC, &etc);\r\nif (mode >= XFER_UDMA_0) {\r\netc &= ~(IDE_DRV_MASK << dshift);\r\netc |= udma_timings[mode - XFER_UDMA_0] << dshift;\r\n} else {\r\netc &= ~(IDE_ETC_UDMA_MASK << dshift);\r\ntimings &= IDE_DRV_MASK;\r\ntimings |= mwdma_timings[mode - XFER_MW_DMA_0] << 8;\r\nide_set_drivedata(drive, (void *)timings);\r\n}\r\ncs5536_write(pdev, ETC, etc);\r\n}\r\nstatic void cs5536_dma_start(ide_drive_t *drive)\r\n{\r\nunsigned long timings = (unsigned long)ide_get_drivedata(drive);\r\nif (drive->current_speed < XFER_UDMA_0 &&\r\n(timings >> 8) != (timings & IDE_DRV_MASK))\r\ncs5536_program_dtc(drive, timings >> 8);\r\nide_dma_start(drive);\r\n}\r\nstatic int cs5536_dma_end(ide_drive_t *drive)\r\n{\r\nint ret = ide_dma_end(drive);\r\nunsigned long timings = (unsigned long)ide_get_drivedata(drive);\r\nif (drive->current_speed < XFER_UDMA_0 &&\r\n(timings >> 8) != (timings & IDE_DRV_MASK))\r\ncs5536_program_dtc(drive, timings & IDE_DRV_MASK);\r\nreturn ret;\r\n}\r\nstatic int cs5536_init_one(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nu32 cfg;\r\nif (use_msr)\r\nprintk(KERN_INFO DRV_NAME ": Using MSR regs instead of PCI\n");\r\ncs5536_read(dev, CFG, &cfg);\r\nif ((cfg & IDE_CFG_CHANEN) == 0) {\r\nprintk(KERN_ERR DRV_NAME ": disabled by BIOS\n");\r\nreturn -ENODEV;\r\n}\r\nreturn ide_pci_init_one(dev, &cs5536_info, NULL);\r\n}\r\nstatic int __init cs5536_init(void)\r\n{\r\nreturn pci_register_driver(&cs5536_pci_driver);\r\n}\r\nstatic void __exit cs5536_exit(void)\r\n{\r\npci_unregister_driver(&cs5536_pci_driver);\r\n}

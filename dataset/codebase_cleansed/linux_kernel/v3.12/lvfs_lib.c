void lprocfs_counter_add(struct lprocfs_stats *stats, int idx, long amount)\r\n{\r\nstruct lprocfs_counter *percpu_cntr;\r\nstruct lprocfs_counter_header *header;\r\nint smp_id;\r\nunsigned long flags = 0;\r\nif (stats == NULL)\r\nreturn;\r\nsmp_id = lprocfs_stats_lock(stats, LPROCFS_GET_SMP_ID, &flags);\r\nif (smp_id < 0)\r\nreturn;\r\nheader = &stats->ls_cnt_header[idx];\r\npercpu_cntr = lprocfs_stats_counter_get(stats, smp_id, idx);\r\npercpu_cntr->lc_count++;\r\nif (header->lc_config & LPROCFS_CNTR_AVGMINMAX) {\r\nif (in_interrupt() &&\r\n(stats->ls_flags & LPROCFS_STATS_FLAG_IRQ_SAFE) != 0)\r\npercpu_cntr->lc_sum_irq += amount;\r\nelse\r\npercpu_cntr->lc_sum += amount;\r\nif (header->lc_config & LPROCFS_CNTR_STDDEV)\r\npercpu_cntr->lc_sumsquare += (__s64)amount * amount;\r\nif (amount < percpu_cntr->lc_min)\r\npercpu_cntr->lc_min = amount;\r\nif (amount > percpu_cntr->lc_max)\r\npercpu_cntr->lc_max = amount;\r\n}\r\nlprocfs_stats_unlock(stats, LPROCFS_GET_SMP_ID, &flags);\r\n}\r\nvoid lprocfs_counter_sub(struct lprocfs_stats *stats, int idx, long amount)\r\n{\r\nstruct lprocfs_counter *percpu_cntr;\r\nstruct lprocfs_counter_header *header;\r\nint smp_id;\r\nunsigned long flags = 0;\r\nif (stats == NULL)\r\nreturn;\r\nsmp_id = lprocfs_stats_lock(stats, LPROCFS_GET_SMP_ID, &flags);\r\nif (smp_id < 0)\r\nreturn;\r\nheader = &stats->ls_cnt_header[idx];\r\npercpu_cntr = lprocfs_stats_counter_get(stats, smp_id, idx);\r\nif (header->lc_config & LPROCFS_CNTR_AVGMINMAX) {\r\nif (in_interrupt() &&\r\n(stats->ls_flags & LPROCFS_STATS_FLAG_IRQ_SAFE) != 0)\r\npercpu_cntr->lc_sum_irq -= amount;\r\nelse\r\npercpu_cntr->lc_sum -= amount;\r\n}\r\nlprocfs_stats_unlock(stats, LPROCFS_GET_SMP_ID, &flags);\r\n}\r\nint lprocfs_stats_alloc_one(struct lprocfs_stats *stats, unsigned int cpuid)\r\n{\r\nstruct lprocfs_counter *cntr;\r\nunsigned int percpusize;\r\nint rc = -ENOMEM;\r\nunsigned long flags = 0;\r\nint i;\r\nLASSERT(stats->ls_percpu[cpuid] == NULL);\r\nLASSERT((stats->ls_flags & LPROCFS_STATS_FLAG_NOPERCPU) == 0);\r\npercpusize = lprocfs_stats_counter_size(stats);\r\nLIBCFS_ALLOC_ATOMIC(stats->ls_percpu[cpuid], percpusize);\r\nif (stats->ls_percpu[cpuid] != NULL) {\r\nrc = 0;\r\nif (unlikely(stats->ls_biggest_alloc_num <= cpuid)) {\r\nif (stats->ls_flags & LPROCFS_STATS_FLAG_IRQ_SAFE)\r\nspin_lock_irqsave(&stats->ls_lock, flags);\r\nelse\r\nspin_lock(&stats->ls_lock);\r\nif (stats->ls_biggest_alloc_num <= cpuid)\r\nstats->ls_biggest_alloc_num = cpuid + 1;\r\nif (stats->ls_flags & LPROCFS_STATS_FLAG_IRQ_SAFE) {\r\nspin_unlock_irqrestore(&stats->ls_lock, flags);\r\n} else {\r\nspin_unlock(&stats->ls_lock);\r\n}\r\n}\r\nfor (i = 0; i < stats->ls_num; ++i) {\r\ncntr = lprocfs_stats_counter_get(stats, cpuid, i);\r\ncntr->lc_min = LC_MIN_INIT;\r\n}\r\n}\r\nreturn rc;\r\n}

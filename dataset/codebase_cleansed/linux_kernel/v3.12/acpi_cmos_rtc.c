static acpi_status\r\nacpi_cmos_rtc_space_handler(u32 function, acpi_physical_address address,\r\nu32 bits, u64 *value64,\r\nvoid *handler_context, void *region_context)\r\n{\r\nint i;\r\nu8 *value = (u8 *)&value64;\r\nif (address > 0xff || !value64)\r\nreturn AE_BAD_PARAMETER;\r\nif (function != ACPI_WRITE && function != ACPI_READ)\r\nreturn AE_BAD_PARAMETER;\r\nspin_lock_irq(&rtc_lock);\r\nfor (i = 0; i < DIV_ROUND_UP(bits, 8); ++i, ++address, ++value)\r\nif (function == ACPI_READ)\r\n*value = CMOS_READ(address);\r\nelse\r\nCMOS_WRITE(*value, address);\r\nspin_unlock_irq(&rtc_lock);\r\nreturn AE_OK;\r\n}\r\nstatic int acpi_install_cmos_rtc_space_handler(struct acpi_device *adev,\r\nconst struct acpi_device_id *id)\r\n{\r\nacpi_status status;\r\nstatus = acpi_install_address_space_handler(adev->handle,\r\nACPI_ADR_SPACE_CMOS,\r\n&acpi_cmos_rtc_space_handler,\r\nNULL, NULL);\r\nif (ACPI_FAILURE(status)) {\r\npr_err(PREFIX "Error installing CMOS-RTC region handler\n");\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic void acpi_remove_cmos_rtc_space_handler(struct acpi_device *adev)\r\n{\r\nif (ACPI_FAILURE(acpi_remove_address_space_handler(adev->handle,\r\nACPI_ADR_SPACE_CMOS, &acpi_cmos_rtc_space_handler)))\r\npr_err(PREFIX "Error removing CMOS-RTC region handler\n");\r\n}\r\nvoid __init acpi_cmos_rtc_init(void)\r\n{\r\nacpi_scan_add_handler(&cmos_rtc_handler);\r\n}

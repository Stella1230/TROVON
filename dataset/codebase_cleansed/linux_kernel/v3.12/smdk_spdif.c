static int set_audio_clock_heirachy(struct platform_device *pdev)\r\n{\r\nstruct clk *fout_epll, *mout_epll, *sclk_audio0, *sclk_spdif;\r\nint ret = 0;\r\nfout_epll = clk_get(NULL, "fout_epll");\r\nif (IS_ERR(fout_epll)) {\r\nprintk(KERN_WARNING "%s: Cannot find fout_epll.\n",\r\n__func__);\r\nreturn -EINVAL;\r\n}\r\nmout_epll = clk_get(NULL, "mout_epll");\r\nif (IS_ERR(mout_epll)) {\r\nprintk(KERN_WARNING "%s: Cannot find mout_epll.\n",\r\n__func__);\r\nret = -EINVAL;\r\ngoto out1;\r\n}\r\nsclk_audio0 = clk_get(&pdev->dev, "sclk_audio");\r\nif (IS_ERR(sclk_audio0)) {\r\nprintk(KERN_WARNING "%s: Cannot find sclk_audio.\n",\r\n__func__);\r\nret = -EINVAL;\r\ngoto out2;\r\n}\r\nsclk_spdif = clk_get(NULL, "sclk_spdif");\r\nif (IS_ERR(sclk_spdif)) {\r\nprintk(KERN_WARNING "%s: Cannot find sclk_spdif.\n",\r\n__func__);\r\nret = -EINVAL;\r\ngoto out3;\r\n}\r\nclk_set_parent(mout_epll, fout_epll);\r\nclk_set_parent(sclk_audio0, mout_epll);\r\nclk_set_parent(sclk_spdif, sclk_audio0);\r\nclk_put(sclk_spdif);\r\nout3:\r\nclk_put(sclk_audio0);\r\nout2:\r\nclk_put(mout_epll);\r\nout1:\r\nclk_put(fout_epll);\r\nreturn ret;\r\n}\r\nstatic int set_audio_clock_rate(unsigned long epll_rate,\r\nunsigned long audio_rate)\r\n{\r\nstruct clk *fout_epll, *sclk_spdif;\r\nfout_epll = clk_get(NULL, "fout_epll");\r\nif (IS_ERR(fout_epll)) {\r\nprintk(KERN_ERR "%s: failed to get fout_epll\n", __func__);\r\nreturn -ENOENT;\r\n}\r\nclk_set_rate(fout_epll, epll_rate);\r\nclk_put(fout_epll);\r\nsclk_spdif = clk_get(NULL, "sclk_spdif");\r\nif (IS_ERR(sclk_spdif)) {\r\nprintk(KERN_ERR "%s: failed to get sclk_spdif\n", __func__);\r\nreturn -ENOENT;\r\n}\r\nclk_set_rate(sclk_spdif, audio_rate);\r\nclk_put(sclk_spdif);\r\nreturn 0;\r\n}\r\nstatic int smdk_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nunsigned long pll_out, rclk_rate;\r\nint ret, ratio;\r\nswitch (params_rate(params)) {\r\ncase 44100:\r\npll_out = 45158400;\r\nbreak;\r\ncase 32000:\r\ncase 48000:\r\ncase 96000:\r\npll_out = 49152000;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nratio = 512;\r\nrclk_rate = params_rate(params) * ratio;\r\nret = set_audio_clock_rate(pll_out, rclk_rate);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_sysclk(cpu_dai, SND_SOC_SPDIF_INT_MCLK,\r\nrclk_rate, SND_SOC_CLOCK_IN);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn ret;\r\n}\r\nstatic int __init smdk_init(void)\r\n{\r\nint ret;\r\nsmdk_snd_spdif_dit_device = platform_device_alloc("spdif-dit", -1);\r\nif (!smdk_snd_spdif_dit_device)\r\nreturn -ENOMEM;\r\nret = platform_device_add(smdk_snd_spdif_dit_device);\r\nif (ret)\r\ngoto err1;\r\nsmdk_snd_spdif_device = platform_device_alloc("soc-audio", -1);\r\nif (!smdk_snd_spdif_device) {\r\nret = -ENOMEM;\r\ngoto err2;\r\n}\r\nplatform_set_drvdata(smdk_snd_spdif_device, &smdk);\r\nret = platform_device_add(smdk_snd_spdif_device);\r\nif (ret)\r\ngoto err3;\r\nret = set_audio_clock_heirachy(smdk_snd_spdif_device);\r\nif (ret)\r\ngoto err4;\r\nreturn 0;\r\nerr4:\r\nplatform_device_del(smdk_snd_spdif_device);\r\nerr3:\r\nplatform_device_put(smdk_snd_spdif_device);\r\nerr2:\r\nplatform_device_del(smdk_snd_spdif_dit_device);\r\nerr1:\r\nplatform_device_put(smdk_snd_spdif_dit_device);\r\nreturn ret;\r\n}\r\nstatic void __exit smdk_exit(void)\r\n{\r\nplatform_device_unregister(smdk_snd_spdif_device);\r\nplatform_device_unregister(smdk_snd_spdif_dit_device);\r\n}

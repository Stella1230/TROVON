static void\r\nfree_buffer(struct videobuf_queue *vq, struct au0828_buffer *buf)\r\n{\r\nstruct au0828_fh *fh = vq->priv_data;\r\nstruct au0828_dev *dev = fh->dev;\r\nunsigned long flags = 0;\r\nif (in_interrupt())\r\nBUG();\r\nspin_lock_irqsave(&dev->slock, flags);\r\nif (dev->isoc_ctl.vbi_buf == buf)\r\ndev->isoc_ctl.vbi_buf = NULL;\r\nspin_unlock_irqrestore(&dev->slock, flags);\r\nvideobuf_vmalloc_free(&buf->vb);\r\nbuf->vb.state = VIDEOBUF_NEEDS_INIT;\r\n}\r\nstatic int\r\nvbi_setup(struct videobuf_queue *q, unsigned int *count, unsigned int *size)\r\n{\r\nstruct au0828_fh *fh = q->priv_data;\r\nstruct au0828_dev *dev = fh->dev;\r\n*size = dev->vbi_width * dev->vbi_height * 2;\r\nif (0 == *count)\r\n*count = vbibufs;\r\nif (*count < 2)\r\n*count = 2;\r\nif (*count > 32)\r\n*count = 32;\r\nreturn 0;\r\n}\r\nstatic int\r\nvbi_prepare(struct videobuf_queue *q, struct videobuf_buffer *vb,\r\nenum v4l2_field field)\r\n{\r\nstruct au0828_fh *fh = q->priv_data;\r\nstruct au0828_dev *dev = fh->dev;\r\nstruct au0828_buffer *buf = container_of(vb, struct au0828_buffer, vb);\r\nint rc = 0;\r\nbuf->vb.size = dev->vbi_width * dev->vbi_height * 2;\r\nif (0 != buf->vb.baddr && buf->vb.bsize < buf->vb.size)\r\nreturn -EINVAL;\r\nbuf->vb.width = dev->vbi_width;\r\nbuf->vb.height = dev->vbi_height;\r\nbuf->vb.field = field;\r\nif (VIDEOBUF_NEEDS_INIT == buf->vb.state) {\r\nrc = videobuf_iolock(q, &buf->vb, NULL);\r\nif (rc < 0)\r\ngoto fail;\r\n}\r\nbuf->vb.state = VIDEOBUF_PREPARED;\r\nreturn 0;\r\nfail:\r\nfree_buffer(q, buf);\r\nreturn rc;\r\n}\r\nstatic void\r\nvbi_queue(struct videobuf_queue *vq, struct videobuf_buffer *vb)\r\n{\r\nstruct au0828_buffer *buf = container_of(vb,\r\nstruct au0828_buffer,\r\nvb);\r\nstruct au0828_fh *fh = vq->priv_data;\r\nstruct au0828_dev *dev = fh->dev;\r\nstruct au0828_dmaqueue *vbiq = &dev->vbiq;\r\nbuf->vb.state = VIDEOBUF_QUEUED;\r\nlist_add_tail(&buf->vb.queue, &vbiq->active);\r\n}\r\nstatic void vbi_release(struct videobuf_queue *q, struct videobuf_buffer *vb)\r\n{\r\nstruct au0828_buffer *buf = container_of(vb, struct au0828_buffer, vb);\r\nfree_buffer(q, buf);\r\n}

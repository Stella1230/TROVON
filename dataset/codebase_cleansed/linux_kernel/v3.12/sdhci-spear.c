static irqreturn_t sdhci_gpio_irq(int irq, void *dev_id)\r\n{\r\nstruct platform_device *pdev = dev_id;\r\nstruct sdhci_host *host = platform_get_drvdata(pdev);\r\nstruct spear_sdhci *sdhci = dev_get_platdata(&pdev->dev);\r\nunsigned long gpio_irq_type;\r\nint val;\r\nval = gpio_get_value(sdhci->data->card_int_gpio);\r\ngpio_irq_type = val ? IRQF_TRIGGER_LOW : IRQF_TRIGGER_HIGH;\r\nirq_set_irq_type(irq, gpio_irq_type);\r\nif (sdhci->data->card_power_gpio >= 0) {\r\nif (!sdhci->data->power_always_enb) {\r\nval = sdhci->data->power_active_high ? !val : val ;\r\ngpio_set_value(sdhci->data->card_power_gpio, val);\r\n}\r\n}\r\ntasklet_schedule(&host->card_tasklet);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic struct sdhci_plat_data *sdhci_probe_config_dt(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct sdhci_plat_data *pdata = NULL;\r\nint cd_gpio;\r\ncd_gpio = of_get_named_gpio(np, "cd-gpios", 0);\r\nif (!gpio_is_valid(cd_gpio))\r\ncd_gpio = -1;\r\nif (cd_gpio != -1) {\r\npdata = devm_kzalloc(&pdev->dev, sizeof(*pdata), GFP_KERNEL);\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "DT: kzalloc failed\n");\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\n}\r\npdata->card_int_gpio = cd_gpio;\r\nreturn pdata;\r\n}\r\nstatic struct sdhci_plat_data *sdhci_probe_config_dt(struct platform_device *pdev)\r\n{\r\nreturn ERR_PTR(-ENOSYS);\r\n}\r\nstatic int sdhci_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct sdhci_host *host;\r\nstruct resource *iomem;\r\nstruct spear_sdhci *sdhci;\r\nint ret;\r\niomem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!iomem) {\r\nret = -ENOMEM;\r\ndev_dbg(&pdev->dev, "memory resource not defined\n");\r\ngoto err;\r\n}\r\nif (!devm_request_mem_region(&pdev->dev, iomem->start,\r\nresource_size(iomem), "spear-sdhci")) {\r\nret = -EBUSY;\r\ndev_dbg(&pdev->dev, "cannot request region\n");\r\ngoto err;\r\n}\r\nsdhci = devm_kzalloc(&pdev->dev, sizeof(*sdhci), GFP_KERNEL);\r\nif (!sdhci) {\r\nret = -ENOMEM;\r\ndev_dbg(&pdev->dev, "cannot allocate memory for sdhci\n");\r\ngoto err;\r\n}\r\nsdhci->clk = clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(sdhci->clk)) {\r\nret = PTR_ERR(sdhci->clk);\r\ndev_dbg(&pdev->dev, "Error getting clock\n");\r\ngoto err;\r\n}\r\nret = clk_prepare_enable(sdhci->clk);\r\nif (ret) {\r\ndev_dbg(&pdev->dev, "Error enabling clock\n");\r\ngoto put_clk;\r\n}\r\nret = clk_set_rate(sdhci->clk, 50000000);\r\nif (ret)\r\ndev_dbg(&pdev->dev, "Error setting desired clk, clk=%lu\n",\r\nclk_get_rate(sdhci->clk));\r\nif (np) {\r\nsdhci->data = sdhci_probe_config_dt(pdev);\r\nif (IS_ERR(sdhci->data)) {\r\ndev_err(&pdev->dev, "DT: Failed to get pdata\n");\r\nreturn -ENODEV;\r\n}\r\n} else {\r\nsdhci->data = dev_get_platdata(&pdev->dev);\r\n}\r\npdev->dev.platform_data = sdhci;\r\nif (pdev->dev.parent)\r\nhost = sdhci_alloc_host(pdev->dev.parent, 0);\r\nelse\r\nhost = sdhci_alloc_host(&pdev->dev, 0);\r\nif (IS_ERR(host)) {\r\nret = PTR_ERR(host);\r\ndev_dbg(&pdev->dev, "error allocating host\n");\r\ngoto disable_clk;\r\n}\r\nhost->hw_name = "sdhci";\r\nhost->ops = &sdhci_pltfm_ops;\r\nhost->irq = platform_get_irq(pdev, 0);\r\nhost->quirks = SDHCI_QUIRK_BROKEN_ADMA;\r\nhost->ioaddr = devm_ioremap(&pdev->dev, iomem->start,\r\nresource_size(iomem));\r\nif (!host->ioaddr) {\r\nret = -ENOMEM;\r\ndev_dbg(&pdev->dev, "failed to remap registers\n");\r\ngoto free_host;\r\n}\r\nret = sdhci_add_host(host);\r\nif (ret) {\r\ndev_dbg(&pdev->dev, "error adding host\n");\r\ngoto free_host;\r\n}\r\nplatform_set_drvdata(pdev, host);\r\nif (!sdhci->data)\r\nreturn 0;\r\nif (sdhci->data->card_power_gpio >= 0) {\r\nint val = 0;\r\nret = devm_gpio_request(&pdev->dev,\r\nsdhci->data->card_power_gpio, "sdhci");\r\nif (ret < 0) {\r\ndev_dbg(&pdev->dev, "gpio request fail: %d\n",\r\nsdhci->data->card_power_gpio);\r\ngoto set_drvdata;\r\n}\r\nif (sdhci->data->power_always_enb)\r\nval = sdhci->data->power_active_high;\r\nelse\r\nval = !sdhci->data->power_active_high;\r\nret = gpio_direction_output(sdhci->data->card_power_gpio, val);\r\nif (ret) {\r\ndev_dbg(&pdev->dev, "gpio set direction fail: %d\n",\r\nsdhci->data->card_power_gpio);\r\ngoto set_drvdata;\r\n}\r\n}\r\nif (sdhci->data->card_int_gpio >= 0) {\r\nret = devm_gpio_request(&pdev->dev, sdhci->data->card_int_gpio,\r\n"sdhci");\r\nif (ret < 0) {\r\ndev_dbg(&pdev->dev, "gpio request fail: %d\n",\r\nsdhci->data->card_int_gpio);\r\ngoto set_drvdata;\r\n}\r\nret = gpio_direction_input(sdhci->data->card_int_gpio);\r\nif (ret) {\r\ndev_dbg(&pdev->dev, "gpio set direction fail: %d\n",\r\nsdhci->data->card_int_gpio);\r\ngoto set_drvdata;\r\n}\r\nret = devm_request_irq(&pdev->dev,\r\ngpio_to_irq(sdhci->data->card_int_gpio),\r\nsdhci_gpio_irq, IRQF_TRIGGER_LOW,\r\nmmc_hostname(host->mmc), pdev);\r\nif (ret) {\r\ndev_dbg(&pdev->dev, "gpio request irq fail: %d\n",\r\nsdhci->data->card_int_gpio);\r\ngoto set_drvdata;\r\n}\r\n}\r\nreturn 0;\r\nset_drvdata:\r\nsdhci_remove_host(host, 1);\r\nfree_host:\r\nsdhci_free_host(host);\r\ndisable_clk:\r\nclk_disable_unprepare(sdhci->clk);\r\nput_clk:\r\nclk_put(sdhci->clk);\r\nerr:\r\ndev_err(&pdev->dev, "spear-sdhci probe failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int sdhci_remove(struct platform_device *pdev)\r\n{\r\nstruct sdhci_host *host = platform_get_drvdata(pdev);\r\nstruct spear_sdhci *sdhci = dev_get_platdata(&pdev->dev);\r\nint dead = 0;\r\nu32 scratch;\r\nscratch = readl(host->ioaddr + SDHCI_INT_STATUS);\r\nif (scratch == (u32)-1)\r\ndead = 1;\r\nsdhci_remove_host(host, dead);\r\nsdhci_free_host(host);\r\nclk_disable_unprepare(sdhci->clk);\r\nclk_put(sdhci->clk);\r\nreturn 0;\r\n}\r\nstatic int sdhci_suspend(struct device *dev)\r\n{\r\nstruct sdhci_host *host = dev_get_drvdata(dev);\r\nstruct spear_sdhci *sdhci = dev_get_platdata(dev);\r\nint ret;\r\nret = sdhci_suspend_host(host);\r\nif (!ret)\r\nclk_disable(sdhci->clk);\r\nreturn ret;\r\n}\r\nstatic int sdhci_resume(struct device *dev)\r\n{\r\nstruct sdhci_host *host = dev_get_drvdata(dev);\r\nstruct spear_sdhci *sdhci = dev_get_platdata(dev);\r\nint ret;\r\nret = clk_enable(sdhci->clk);\r\nif (ret) {\r\ndev_dbg(dev, "Resume: Error enabling clock\n");\r\nreturn ret;\r\n}\r\nreturn sdhci_resume_host(host);\r\n}

static int fdomain_probe(struct pcmcia_device *link)\r\n{\r\nscsi_info_t *info;\r\ndev_dbg(&link->dev, "fdomain_attach()\n");\r\ninfo = kzalloc(sizeof(*info), GFP_KERNEL);\r\nif (!info)\r\nreturn -ENOMEM;\r\ninfo->p_dev = link;\r\nlink->priv = info;\r\nlink->config_flags |= CONF_ENABLE_IRQ | CONF_AUTO_SET_IO;\r\nlink->config_regs = PRESENT_OPTION;\r\nreturn fdomain_config(link);\r\n}\r\nstatic void fdomain_detach(struct pcmcia_device *link)\r\n{\r\ndev_dbg(&link->dev, "fdomain_detach\n");\r\nfdomain_release(link);\r\nkfree(link->priv);\r\n}\r\nstatic int fdomain_config_check(struct pcmcia_device *p_dev, void *priv_data)\r\n{\r\np_dev->io_lines = 10;\r\np_dev->resource[0]->end = 0x10;\r\np_dev->resource[0]->flags &= ~IO_DATA_PATH_WIDTH;\r\np_dev->resource[0]->flags |= IO_DATA_PATH_WIDTH_AUTO;\r\nreturn pcmcia_request_io(p_dev);\r\n}\r\nstatic int fdomain_config(struct pcmcia_device *link)\r\n{\r\nscsi_info_t *info = link->priv;\r\nint ret;\r\nchar str[22];\r\nstruct Scsi_Host *host;\r\ndev_dbg(&link->dev, "fdomain_config\n");\r\nret = pcmcia_loop_config(link, fdomain_config_check, NULL);\r\nif (ret)\r\ngoto failed;\r\nif (!link->irq)\r\ngoto failed;\r\nret = pcmcia_enable_device(link);\r\nif (ret)\r\ngoto failed;\r\nrelease_region(link->resource[0]->start, resource_size(link->resource[0]));\r\nsprintf(str, "%d,%d", (unsigned int) link->resource[0]->start, link->irq);\r\nfdomain_setup(str);\r\nhost = __fdomain_16x0_detect(&fdomain_driver_template);\r\nif (!host) {\r\nprintk(KERN_INFO "fdomain_cs: no SCSI devices found\n");\r\ngoto failed;\r\n}\r\nif (scsi_add_host(host, NULL))\r\ngoto failed;\r\nscsi_scan_host(host);\r\ninfo->host = host;\r\nreturn 0;\r\nfailed:\r\nfdomain_release(link);\r\nreturn -ENODEV;\r\n}\r\nstatic void fdomain_release(struct pcmcia_device *link)\r\n{\r\nscsi_info_t *info = link->priv;\r\ndev_dbg(&link->dev, "fdomain_release\n");\r\nscsi_remove_host(info->host);\r\npcmcia_disable_device(link);\r\nscsi_unregister(info->host);\r\n}\r\nstatic int fdomain_resume(struct pcmcia_device *link)\r\n{\r\nfdomain_16x0_bus_reset(NULL);\r\nreturn 0;\r\n}\r\nstatic int __init init_fdomain_cs(void)\r\n{\r\nreturn pcmcia_register_driver(&fdomain_cs_driver);\r\n}\r\nstatic void __exit exit_fdomain_cs(void)\r\n{\r\npcmcia_unregister_driver(&fdomain_cs_driver);\r\n}

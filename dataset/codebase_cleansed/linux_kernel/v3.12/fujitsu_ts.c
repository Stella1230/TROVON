static irqreturn_t fujitsu_interrupt(struct serio *serio,\r\nunsigned char data, unsigned int flags)\r\n{\r\nstruct fujitsu *fujitsu = serio_get_drvdata(serio);\r\nstruct input_dev *dev = fujitsu->dev;\r\nif (fujitsu->idx == 0) {\r\nif ((data & 0xf0) != 0x80)\r\nreturn IRQ_HANDLED;\r\n} else {\r\nif (data & 0x80) {\r\nfujitsu->idx = 0;\r\nreturn IRQ_HANDLED;\r\n}\r\n}\r\nfujitsu->data[fujitsu->idx++] = data;\r\nif (fujitsu->idx == FUJITSU_LENGTH) {\r\ninput_report_abs(dev, ABS_X,\r\n(fujitsu->data[2] << 7) | fujitsu->data[1]);\r\ninput_report_abs(dev, ABS_Y,\r\n(fujitsu->data[4] << 7) | fujitsu->data[3]);\r\ninput_report_key(dev, BTN_TOUCH,\r\n(fujitsu->data[0] & 0x03) != 2);\r\ninput_sync(dev);\r\nfujitsu->idx = 0;\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void fujitsu_disconnect(struct serio *serio)\r\n{\r\nstruct fujitsu *fujitsu = serio_get_drvdata(serio);\r\ninput_get_device(fujitsu->dev);\r\ninput_unregister_device(fujitsu->dev);\r\nserio_close(serio);\r\nserio_set_drvdata(serio, NULL);\r\ninput_put_device(fujitsu->dev);\r\nkfree(fujitsu);\r\n}\r\nstatic int fujitsu_connect(struct serio *serio, struct serio_driver *drv)\r\n{\r\nstruct fujitsu *fujitsu;\r\nstruct input_dev *input_dev;\r\nint err;\r\nfujitsu = kzalloc(sizeof(struct fujitsu), GFP_KERNEL);\r\ninput_dev = input_allocate_device();\r\nif (!fujitsu || !input_dev) {\r\nerr = -ENOMEM;\r\ngoto fail1;\r\n}\r\nfujitsu->serio = serio;\r\nfujitsu->dev = input_dev;\r\nsnprintf(fujitsu->phys, sizeof(fujitsu->phys),\r\n"%s/input0", serio->phys);\r\ninput_dev->name = "Fujitsu Serial Touchscreen";\r\ninput_dev->phys = fujitsu->phys;\r\ninput_dev->id.bustype = BUS_RS232;\r\ninput_dev->id.vendor = SERIO_FUJITSU;\r\ninput_dev->id.product = 0;\r\ninput_dev->id.version = 0x0100;\r\ninput_dev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_ABS);\r\ninput_dev->keybit[BIT_WORD(BTN_TOUCH)] = BIT_MASK(BTN_TOUCH);\r\ninput_set_abs_params(input_dev, ABS_X, 0, 4096, 0, 0);\r\ninput_set_abs_params(input_dev, ABS_Y, 0, 4096, 0, 0);\r\nserio_set_drvdata(serio, fujitsu);\r\nerr = serio_open(serio, drv);\r\nif (err)\r\ngoto fail2;\r\nerr = input_register_device(fujitsu->dev);\r\nif (err)\r\ngoto fail3;\r\nreturn 0;\r\nfail3:\r\nserio_close(serio);\r\nfail2:\r\nserio_set_drvdata(serio, NULL);\r\nfail1:\r\ninput_free_device(input_dev);\r\nkfree(fujitsu);\r\nreturn err;\r\n}

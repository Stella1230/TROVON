static ssize_t gfar_show_bd_stash(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct gfar_private *priv = netdev_priv(to_net_dev(dev));\r\nreturn sprintf(buf, "%s\n", priv->bd_stash_en ? "on" : "off");\r\n}\r\nstatic ssize_t gfar_set_bd_stash(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct gfar_private *priv = netdev_priv(to_net_dev(dev));\r\nstruct gfar __iomem *regs = priv->gfargrp[0].regs;\r\nint new_setting = 0;\r\nu32 temp;\r\nunsigned long flags;\r\nif (!(priv->device_flags & FSL_GIANFAR_DEV_HAS_BD_STASHING))\r\nreturn count;\r\nif (!strncmp("on", buf, count - 1) || !strncmp("1", buf, count - 1))\r\nnew_setting = 1;\r\nelse if (!strncmp("off", buf, count - 1) ||\r\n!strncmp("0", buf, count - 1))\r\nnew_setting = 0;\r\nelse\r\nreturn count;\r\nlocal_irq_save(flags);\r\nlock_rx_qs(priv);\r\npriv->bd_stash_en = new_setting;\r\ntemp = gfar_read(&regs->attr);\r\nif (new_setting)\r\ntemp |= ATTR_BDSTASH;\r\nelse\r\ntemp &= ~(ATTR_BDSTASH);\r\ngfar_write(&regs->attr, temp);\r\nunlock_rx_qs(priv);\r\nlocal_irq_restore(flags);\r\nreturn count;\r\n}\r\nstatic ssize_t gfar_show_rx_stash_size(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct gfar_private *priv = netdev_priv(to_net_dev(dev));\r\nreturn sprintf(buf, "%d\n", priv->rx_stash_size);\r\n}\r\nstatic ssize_t gfar_set_rx_stash_size(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct gfar_private *priv = netdev_priv(to_net_dev(dev));\r\nstruct gfar __iomem *regs = priv->gfargrp[0].regs;\r\nunsigned int length = simple_strtoul(buf, NULL, 0);\r\nu32 temp;\r\nunsigned long flags;\r\nif (!(priv->device_flags & FSL_GIANFAR_DEV_HAS_BUF_STASHING))\r\nreturn count;\r\nlocal_irq_save(flags);\r\nlock_rx_qs(priv);\r\nif (length > priv->rx_buffer_size)\r\ngoto out;\r\nif (length == priv->rx_stash_size)\r\ngoto out;\r\npriv->rx_stash_size = length;\r\ntemp = gfar_read(&regs->attreli);\r\ntemp &= ~ATTRELI_EL_MASK;\r\ntemp |= ATTRELI_EL(length);\r\ngfar_write(&regs->attreli, temp);\r\ntemp = gfar_read(&regs->attr);\r\nif (length)\r\ntemp |= ATTR_BUFSTASH;\r\nelse\r\ntemp &= ~(ATTR_BUFSTASH);\r\ngfar_write(&regs->attr, temp);\r\nout:\r\nunlock_rx_qs(priv);\r\nlocal_irq_restore(flags);\r\nreturn count;\r\n}\r\nstatic ssize_t gfar_show_rx_stash_index(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct gfar_private *priv = netdev_priv(to_net_dev(dev));\r\nreturn sprintf(buf, "%d\n", priv->rx_stash_index);\r\n}\r\nstatic ssize_t gfar_set_rx_stash_index(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct gfar_private *priv = netdev_priv(to_net_dev(dev));\r\nstruct gfar __iomem *regs = priv->gfargrp[0].regs;\r\nunsigned short index = simple_strtoul(buf, NULL, 0);\r\nu32 temp;\r\nunsigned long flags;\r\nif (!(priv->device_flags & FSL_GIANFAR_DEV_HAS_BUF_STASHING))\r\nreturn count;\r\nlocal_irq_save(flags);\r\nlock_rx_qs(priv);\r\nif (index > priv->rx_stash_size)\r\ngoto out;\r\nif (index == priv->rx_stash_index)\r\ngoto out;\r\npriv->rx_stash_index = index;\r\ntemp = gfar_read(&regs->attreli);\r\ntemp &= ~ATTRELI_EI_MASK;\r\ntemp |= ATTRELI_EI(index);\r\ngfar_write(&regs->attreli, temp);\r\nout:\r\nunlock_rx_qs(priv);\r\nlocal_irq_restore(flags);\r\nreturn count;\r\n}\r\nstatic ssize_t gfar_show_fifo_threshold(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct gfar_private *priv = netdev_priv(to_net_dev(dev));\r\nreturn sprintf(buf, "%d\n", priv->fifo_threshold);\r\n}\r\nstatic ssize_t gfar_set_fifo_threshold(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct gfar_private *priv = netdev_priv(to_net_dev(dev));\r\nstruct gfar __iomem *regs = priv->gfargrp[0].regs;\r\nunsigned int length = simple_strtoul(buf, NULL, 0);\r\nu32 temp;\r\nunsigned long flags;\r\nif (length > GFAR_MAX_FIFO_THRESHOLD)\r\nreturn count;\r\nlocal_irq_save(flags);\r\nlock_tx_qs(priv);\r\npriv->fifo_threshold = length;\r\ntemp = gfar_read(&regs->fifo_tx_thr);\r\ntemp &= ~FIFO_TX_THR_MASK;\r\ntemp |= length;\r\ngfar_write(&regs->fifo_tx_thr, temp);\r\nunlock_tx_qs(priv);\r\nlocal_irq_restore(flags);\r\nreturn count;\r\n}\r\nstatic ssize_t gfar_show_fifo_starve(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct gfar_private *priv = netdev_priv(to_net_dev(dev));\r\nreturn sprintf(buf, "%d\n", priv->fifo_starve);\r\n}\r\nstatic ssize_t gfar_set_fifo_starve(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct gfar_private *priv = netdev_priv(to_net_dev(dev));\r\nstruct gfar __iomem *regs = priv->gfargrp[0].regs;\r\nunsigned int num = simple_strtoul(buf, NULL, 0);\r\nu32 temp;\r\nunsigned long flags;\r\nif (num > GFAR_MAX_FIFO_STARVE)\r\nreturn count;\r\nlocal_irq_save(flags);\r\nlock_tx_qs(priv);\r\npriv->fifo_starve = num;\r\ntemp = gfar_read(&regs->fifo_tx_starve);\r\ntemp &= ~FIFO_TX_STARVE_MASK;\r\ntemp |= num;\r\ngfar_write(&regs->fifo_tx_starve, temp);\r\nunlock_tx_qs(priv);\r\nlocal_irq_restore(flags);\r\nreturn count;\r\n}\r\nstatic ssize_t gfar_show_fifo_starve_off(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct gfar_private *priv = netdev_priv(to_net_dev(dev));\r\nreturn sprintf(buf, "%d\n", priv->fifo_starve_off);\r\n}\r\nstatic ssize_t gfar_set_fifo_starve_off(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct gfar_private *priv = netdev_priv(to_net_dev(dev));\r\nstruct gfar __iomem *regs = priv->gfargrp[0].regs;\r\nunsigned int num = simple_strtoul(buf, NULL, 0);\r\nu32 temp;\r\nunsigned long flags;\r\nif (num > GFAR_MAX_FIFO_STARVE_OFF)\r\nreturn count;\r\nlocal_irq_save(flags);\r\nlock_tx_qs(priv);\r\npriv->fifo_starve_off = num;\r\ntemp = gfar_read(&regs->fifo_tx_starve_shutoff);\r\ntemp &= ~FIFO_TX_STARVE_OFF_MASK;\r\ntemp |= num;\r\ngfar_write(&regs->fifo_tx_starve_shutoff, temp);\r\nunlock_tx_qs(priv);\r\nlocal_irq_restore(flags);\r\nreturn count;\r\n}\r\nvoid gfar_init_sysfs(struct net_device *dev)\r\n{\r\nstruct gfar_private *priv = netdev_priv(dev);\r\nint rc;\r\npriv->fifo_threshold = DEFAULT_FIFO_TX_THR;\r\npriv->fifo_starve = DEFAULT_FIFO_TX_STARVE;\r\npriv->fifo_starve_off = DEFAULT_FIFO_TX_STARVE_OFF;\r\nrc = device_create_file(&dev->dev, &dev_attr_bd_stash);\r\nrc |= device_create_file(&dev->dev, &dev_attr_rx_stash_size);\r\nrc |= device_create_file(&dev->dev, &dev_attr_rx_stash_index);\r\nrc |= device_create_file(&dev->dev, &dev_attr_fifo_threshold);\r\nrc |= device_create_file(&dev->dev, &dev_attr_fifo_starve);\r\nrc |= device_create_file(&dev->dev, &dev_attr_fifo_starve_off);\r\nif (rc)\r\ndev_err(&dev->dev, "Error creating gianfar sysfs files\n");\r\n}

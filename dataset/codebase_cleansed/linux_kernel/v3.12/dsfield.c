static acpi_status\r\nacpi_ds_create_external_region(acpi_status lookup_status,\r\nunion acpi_parse_object *op,\r\nchar *path,\r\nstruct acpi_walk_state *walk_state,\r\nstruct acpi_namespace_node **node)\r\n{\r\nacpi_status status;\r\nunion acpi_operand_object *obj_desc;\r\nif (lookup_status != AE_NOT_FOUND) {\r\nreturn (lookup_status);\r\n}\r\nacpi_dm_add_to_external_list(op, path, ACPI_TYPE_REGION, 0);\r\nstatus = acpi_ns_lookup(walk_state->scope_info, path, ACPI_TYPE_REGION,\r\nACPI_IMODE_LOAD_PASS1, ACPI_NS_SEARCH_PARENT,\r\nwalk_state, node);\r\nif (ACPI_FAILURE(status)) {\r\nreturn (status);\r\n}\r\nobj_desc = acpi_ut_create_internal_object(ACPI_TYPE_REGION);\r\nif (!obj_desc) {\r\nreturn (AE_NO_MEMORY);\r\n}\r\nobj_desc->region.node = *node;\r\nstatus = acpi_ns_attach_object(*node, obj_desc, ACPI_TYPE_REGION);\r\nreturn (status);\r\n}\r\nacpi_status\r\nacpi_ds_create_buffer_field(union acpi_parse_object *op,\r\nstruct acpi_walk_state *walk_state)\r\n{\r\nunion acpi_parse_object *arg;\r\nstruct acpi_namespace_node *node;\r\nacpi_status status;\r\nunion acpi_operand_object *obj_desc;\r\nunion acpi_operand_object *second_desc = NULL;\r\nu32 flags;\r\nACPI_FUNCTION_TRACE(ds_create_buffer_field);\r\nif (op->common.aml_opcode == AML_CREATE_FIELD_OP) {\r\narg = acpi_ps_get_arg(op, 3);\r\n} else {\r\narg = acpi_ps_get_arg(op, 2);\r\n}\r\nif (!arg) {\r\nreturn_ACPI_STATUS(AE_AML_NO_OPERAND);\r\n}\r\nif (walk_state->deferred_node) {\r\nnode = walk_state->deferred_node;\r\nstatus = AE_OK;\r\n} else {\r\nif (!(walk_state->parse_flags & ACPI_PARSE_EXECUTE)) {\r\nreturn_ACPI_STATUS(AE_AML_INTERNAL);\r\n}\r\nflags = ACPI_NS_NO_UPSEARCH | ACPI_NS_DONT_OPEN_SCOPE |\r\nACPI_NS_ERROR_IF_FOUND;\r\nif (walk_state->method_node &&\r\n!(walk_state->parse_flags & ACPI_PARSE_MODULE_LEVEL)) {\r\nflags |= ACPI_NS_TEMPORARY;\r\n}\r\nstatus =\r\nacpi_ns_lookup(walk_state->scope_info,\r\narg->common.value.string, ACPI_TYPE_ANY,\r\nACPI_IMODE_LOAD_PASS1, flags, walk_state,\r\n&node);\r\nif (ACPI_FAILURE(status)) {\r\nACPI_ERROR_NAMESPACE(arg->common.value.string, status);\r\nreturn_ACPI_STATUS(status);\r\n}\r\n}\r\nop->common.node = node;\r\nobj_desc = acpi_ns_get_attached_object(node);\r\nif (obj_desc) {\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nobj_desc = acpi_ut_create_internal_object(ACPI_TYPE_BUFFER_FIELD);\r\nif (!obj_desc) {\r\nstatus = AE_NO_MEMORY;\r\ngoto cleanup;\r\n}\r\nsecond_desc = obj_desc->common.next_object;\r\nsecond_desc->extra.aml_start = op->named.data;\r\nsecond_desc->extra.aml_length = op->named.length;\r\nobj_desc->buffer_field.node = node;\r\nstatus = acpi_ns_attach_object(node, obj_desc, ACPI_TYPE_BUFFER_FIELD);\r\nif (ACPI_FAILURE(status)) {\r\ngoto cleanup;\r\n}\r\ncleanup:\r\nacpi_ut_remove_reference(obj_desc);\r\nreturn_ACPI_STATUS(status);\r\n}\r\nstatic acpi_status\r\nacpi_ds_get_field_names(struct acpi_create_field_info *info,\r\nstruct acpi_walk_state *walk_state,\r\nunion acpi_parse_object *arg)\r\n{\r\nacpi_status status;\r\nu64 position;\r\nunion acpi_parse_object *child;\r\nACPI_FUNCTION_TRACE_PTR(ds_get_field_names, info);\r\ninfo->field_bit_position = 0;\r\nwhile (arg) {\r\nswitch (arg->common.aml_opcode) {\r\ncase AML_INT_RESERVEDFIELD_OP:\r\nposition = (u64) info->field_bit_position\r\n+ (u64) arg->common.value.size;\r\nif (position > ACPI_UINT32_MAX) {\r\nACPI_ERROR((AE_INFO,\r\n"Bit offset within field too large (> 0xFFFFFFFF)"));\r\nreturn_ACPI_STATUS(AE_SUPPORT);\r\n}\r\ninfo->field_bit_position = (u32) position;\r\nbreak;\r\ncase AML_INT_ACCESSFIELD_OP:\r\ncase AML_INT_EXTACCESSFIELD_OP:\r\ninfo->field_flags = (u8)\r\n((info->\r\nfield_flags & ~(AML_FIELD_ACCESS_TYPE_MASK)) |\r\n((u8)((u32)(arg->common.value.integer & 0x07))));\r\ninfo->attribute =\r\n(u8)((arg->common.value.integer >> 8) & 0xFF);\r\ninfo->access_length =\r\n(u8)((arg->common.value.integer >> 16) & 0xFF);\r\nbreak;\r\ncase AML_INT_CONNECTION_OP:\r\ninfo->resource_buffer = NULL;\r\ninfo->connection_node = NULL;\r\nchild = arg->common.value.arg;\r\nif (child->common.aml_opcode == AML_INT_BYTELIST_OP) {\r\ninfo->resource_buffer = child->named.data;\r\ninfo->resource_length =\r\n(u16)child->named.value.integer;\r\n} else {\r\nstatus = acpi_ns_lookup(walk_state->scope_info,\r\nchild->common.value.\r\nname, ACPI_TYPE_ANY,\r\nACPI_IMODE_EXECUTE,\r\nACPI_NS_DONT_OPEN_SCOPE,\r\nwalk_state,\r\n&info->connection_node);\r\nif (ACPI_FAILURE(status)) {\r\nACPI_ERROR_NAMESPACE(child->common.\r\nvalue.name,\r\nstatus);\r\nreturn_ACPI_STATUS(status);\r\n}\r\n}\r\nbreak;\r\ncase AML_INT_NAMEDFIELD_OP:\r\nstatus = acpi_ns_lookup(walk_state->scope_info,\r\n(char *)&arg->named.name,\r\ninfo->field_type,\r\nACPI_IMODE_EXECUTE,\r\nACPI_NS_DONT_OPEN_SCOPE,\r\nwalk_state, &info->field_node);\r\nif (ACPI_FAILURE(status)) {\r\nACPI_ERROR_NAMESPACE((char *)&arg->named.name,\r\nstatus);\r\nreturn_ACPI_STATUS(status);\r\n} else {\r\narg->common.node = info->field_node;\r\ninfo->field_bit_length = arg->common.value.size;\r\nif (!acpi_ns_get_attached_object\r\n(info->field_node)) {\r\nstatus = acpi_ex_prep_field_value(info);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\n}\r\n}\r\nposition = (u64) info->field_bit_position\r\n+ (u64) arg->common.value.size;\r\nif (position > ACPI_UINT32_MAX) {\r\nACPI_ERROR((AE_INFO,\r\n"Field [%4.4s] bit offset too large (> 0xFFFFFFFF)",\r\nACPI_CAST_PTR(char,\r\n&info->field_node->\r\nname)));\r\nreturn_ACPI_STATUS(AE_SUPPORT);\r\n}\r\ninfo->field_bit_position += info->field_bit_length;\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"Invalid opcode in field list: 0x%X",\r\narg->common.aml_opcode));\r\nreturn_ACPI_STATUS(AE_AML_BAD_OPCODE);\r\n}\r\narg = arg->common.next;\r\n}\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nacpi_status\r\nacpi_ds_create_field(union acpi_parse_object *op,\r\nstruct acpi_namespace_node *region_node,\r\nstruct acpi_walk_state *walk_state)\r\n{\r\nacpi_status status;\r\nunion acpi_parse_object *arg;\r\nstruct acpi_create_field_info info;\r\nACPI_FUNCTION_TRACE_PTR(ds_create_field, op);\r\narg = op->common.value.arg;\r\nif (!region_node) {\r\nstatus =\r\nacpi_ns_lookup(walk_state->scope_info,\r\narg->common.value.name, ACPI_TYPE_REGION,\r\nACPI_IMODE_EXECUTE, ACPI_NS_SEARCH_PARENT,\r\nwalk_state, &region_node);\r\n#ifdef ACPI_ASL_COMPILER\r\nstatus = acpi_ds_create_external_region(status, arg,\r\narg->common.value.name,\r\nwalk_state,\r\n&region_node);\r\n#endif\r\nif (ACPI_FAILURE(status)) {\r\nACPI_ERROR_NAMESPACE(arg->common.value.name, status);\r\nreturn_ACPI_STATUS(status);\r\n}\r\n}\r\nACPI_MEMSET(&info, 0, sizeof(struct acpi_create_field_info));\r\narg = arg->common.next;\r\ninfo.field_flags = (u8) arg->common.value.integer;\r\ninfo.attribute = 0;\r\ninfo.field_type = ACPI_TYPE_LOCAL_REGION_FIELD;\r\ninfo.region_node = region_node;\r\nstatus = acpi_ds_get_field_names(&info, walk_state, arg->common.next);\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status\r\nacpi_ds_init_field_objects(union acpi_parse_object *op,\r\nstruct acpi_walk_state *walk_state)\r\n{\r\nacpi_status status;\r\nunion acpi_parse_object *arg = NULL;\r\nstruct acpi_namespace_node *node;\r\nu8 type = 0;\r\nu32 flags;\r\nACPI_FUNCTION_TRACE_PTR(ds_init_field_objects, op);\r\nif (!(walk_state->parse_flags & ACPI_PARSE_EXECUTE)) {\r\nif (walk_state->parse_flags & ACPI_PARSE_DEFERRED_OP) {\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nreturn_ACPI_STATUS(AE_AML_INTERNAL);\r\n}\r\nswitch (walk_state->opcode) {\r\ncase AML_FIELD_OP:\r\narg = acpi_ps_get_arg(op, 2);\r\ntype = ACPI_TYPE_LOCAL_REGION_FIELD;\r\nbreak;\r\ncase AML_BANK_FIELD_OP:\r\narg = acpi_ps_get_arg(op, 4);\r\ntype = ACPI_TYPE_LOCAL_BANK_FIELD;\r\nbreak;\r\ncase AML_INDEX_FIELD_OP:\r\narg = acpi_ps_get_arg(op, 3);\r\ntype = ACPI_TYPE_LOCAL_INDEX_FIELD;\r\nbreak;\r\ndefault:\r\nreturn_ACPI_STATUS(AE_BAD_PARAMETER);\r\n}\r\nflags = ACPI_NS_NO_UPSEARCH | ACPI_NS_DONT_OPEN_SCOPE |\r\nACPI_NS_ERROR_IF_FOUND;\r\nif (walk_state->method_node &&\r\n!(walk_state->parse_flags & ACPI_PARSE_MODULE_LEVEL)) {\r\nflags |= ACPI_NS_TEMPORARY;\r\n}\r\nwhile (arg) {\r\nif (arg->common.aml_opcode == AML_INT_NAMEDFIELD_OP) {\r\nstatus = acpi_ns_lookup(walk_state->scope_info,\r\n(char *)&arg->named.name, type,\r\nACPI_IMODE_LOAD_PASS1, flags,\r\nwalk_state, &node);\r\nif (ACPI_FAILURE(status)) {\r\nACPI_ERROR_NAMESPACE((char *)&arg->named.name,\r\nstatus);\r\nif (status != AE_ALREADY_EXISTS) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nstatus = AE_OK;\r\n}\r\narg->common.node = node;\r\n}\r\narg = arg->common.next;\r\n}\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nacpi_status\r\nacpi_ds_create_bank_field(union acpi_parse_object *op,\r\nstruct acpi_namespace_node *region_node,\r\nstruct acpi_walk_state *walk_state)\r\n{\r\nacpi_status status;\r\nunion acpi_parse_object *arg;\r\nstruct acpi_create_field_info info;\r\nACPI_FUNCTION_TRACE_PTR(ds_create_bank_field, op);\r\narg = op->common.value.arg;\r\nif (!region_node) {\r\nstatus =\r\nacpi_ns_lookup(walk_state->scope_info,\r\narg->common.value.name, ACPI_TYPE_REGION,\r\nACPI_IMODE_EXECUTE, ACPI_NS_SEARCH_PARENT,\r\nwalk_state, &region_node);\r\n#ifdef ACPI_ASL_COMPILER\r\nstatus = acpi_ds_create_external_region(status, arg,\r\narg->common.value.name,\r\nwalk_state,\r\n&region_node);\r\n#endif\r\nif (ACPI_FAILURE(status)) {\r\nACPI_ERROR_NAMESPACE(arg->common.value.name, status);\r\nreturn_ACPI_STATUS(status);\r\n}\r\n}\r\narg = arg->common.next;\r\nstatus =\r\nacpi_ns_lookup(walk_state->scope_info, arg->common.value.string,\r\nACPI_TYPE_ANY, ACPI_IMODE_EXECUTE,\r\nACPI_NS_SEARCH_PARENT, walk_state,\r\n&info.register_node);\r\nif (ACPI_FAILURE(status)) {\r\nACPI_ERROR_NAMESPACE(arg->common.value.string, status);\r\nreturn_ACPI_STATUS(status);\r\n}\r\narg = arg->common.next;\r\narg = arg->common.next;\r\ninfo.field_flags = (u8) arg->common.value.integer;\r\ninfo.field_type = ACPI_TYPE_LOCAL_BANK_FIELD;\r\ninfo.region_node = region_node;\r\ninfo.data_register_node = (struct acpi_namespace_node *)op;\r\nstatus = acpi_ds_get_field_names(&info, walk_state, arg->common.next);\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status\r\nacpi_ds_create_index_field(union acpi_parse_object *op,\r\nstruct acpi_namespace_node *region_node,\r\nstruct acpi_walk_state *walk_state)\r\n{\r\nacpi_status status;\r\nunion acpi_parse_object *arg;\r\nstruct acpi_create_field_info info;\r\nACPI_FUNCTION_TRACE_PTR(ds_create_index_field, op);\r\narg = op->common.value.arg;\r\nstatus =\r\nacpi_ns_lookup(walk_state->scope_info, arg->common.value.string,\r\nACPI_TYPE_ANY, ACPI_IMODE_EXECUTE,\r\nACPI_NS_SEARCH_PARENT, walk_state,\r\n&info.register_node);\r\nif (ACPI_FAILURE(status)) {\r\nACPI_ERROR_NAMESPACE(arg->common.value.string, status);\r\nreturn_ACPI_STATUS(status);\r\n}\r\narg = arg->common.next;\r\nstatus =\r\nacpi_ns_lookup(walk_state->scope_info, arg->common.value.string,\r\nACPI_TYPE_ANY, ACPI_IMODE_EXECUTE,\r\nACPI_NS_SEARCH_PARENT, walk_state,\r\n&info.data_register_node);\r\nif (ACPI_FAILURE(status)) {\r\nACPI_ERROR_NAMESPACE(arg->common.value.string, status);\r\nreturn_ACPI_STATUS(status);\r\n}\r\narg = arg->common.next;\r\ninfo.field_flags = (u8) arg->common.value.integer;\r\ninfo.field_type = ACPI_TYPE_LOCAL_INDEX_FIELD;\r\ninfo.region_node = region_node;\r\nstatus = acpi_ds_get_field_names(&info, walk_state, arg->common.next);\r\nreturn_ACPI_STATUS(status);\r\n}

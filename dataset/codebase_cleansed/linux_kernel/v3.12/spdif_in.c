static void spdif_in_configure(struct spdif_in_dev *host)\r\n{\r\nu32 ctrl = SPDIF_IN_PRTYEN | SPDIF_IN_STATEN | SPDIF_IN_USREN |\r\nSPDIF_IN_VALEN | SPDIF_IN_BLKEN;\r\nctrl |= SPDIF_MODE_16BIT | SPDIF_FIFO_THRES_16;\r\nwritel(ctrl, host->io_base + SPDIF_IN_CTRL);\r\nwritel(0xF, host->io_base + SPDIF_IN_IRQ_MASK);\r\n}\r\nstatic int spdif_in_dai_probe(struct snd_soc_dai *dai)\r\n{\r\nstruct spdif_in_dev *host = snd_soc_dai_get_drvdata(dai);\r\ndai->capture_dma_data = &host->dma_params;\r\nreturn 0;\r\n}\r\nstatic void spdif_in_shutdown(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct spdif_in_dev *host = snd_soc_dai_get_drvdata(dai);\r\nif (substream->stream != SNDRV_PCM_STREAM_CAPTURE)\r\nreturn;\r\nwritel(0x0, host->io_base + SPDIF_IN_IRQ_MASK);\r\n}\r\nstatic void spdif_in_format(struct spdif_in_dev *host, u32 format)\r\n{\r\nu32 ctrl = readl(host->io_base + SPDIF_IN_CTRL);\r\nswitch (format) {\r\ncase SNDRV_PCM_FORMAT_S16_LE:\r\nctrl |= SPDIF_XTRACT_16BIT;\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_IEC958_SUBFRAME_LE:\r\nctrl &= ~SPDIF_XTRACT_16BIT;\r\nbreak;\r\n}\r\nwritel(ctrl, host->io_base + SPDIF_IN_CTRL);\r\n}\r\nstatic int spdif_in_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct spdif_in_dev *host = snd_soc_dai_get_drvdata(dai);\r\nu32 format;\r\nif (substream->stream != SNDRV_PCM_STREAM_CAPTURE)\r\nreturn -EINVAL;\r\nformat = params_format(params);\r\nhost->saved_params.format = format;\r\nreturn 0;\r\n}\r\nstatic int spdif_in_trigger(struct snd_pcm_substream *substream, int cmd,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct spdif_in_dev *host = snd_soc_dai_get_drvdata(dai);\r\nu32 ctrl;\r\nint ret = 0;\r\nif (substream->stream != SNDRV_PCM_STREAM_CAPTURE)\r\nreturn -EINVAL;\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\r\nclk_enable(host->clk);\r\nspdif_in_configure(host);\r\nspdif_in_format(host, host->saved_params.format);\r\nctrl = readl(host->io_base + SPDIF_IN_CTRL);\r\nctrl |= SPDIF_IN_SAMPLE | SPDIF_IN_ENB;\r\nwritel(ctrl, host->io_base + SPDIF_IN_CTRL);\r\nwritel(0xF, host->io_base + SPDIF_IN_IRQ_MASK);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\r\nctrl = readl(host->io_base + SPDIF_IN_CTRL);\r\nctrl &= ~(SPDIF_IN_SAMPLE | SPDIF_IN_ENB);\r\nwritel(ctrl, host->io_base + SPDIF_IN_CTRL);\r\nwritel(0x0, host->io_base + SPDIF_IN_IRQ_MASK);\r\nif (host->reset_perip)\r\nhost->reset_perip();\r\nclk_disable(host->clk);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic irqreturn_t spdif_in_irq(int irq, void *arg)\r\n{\r\nstruct spdif_in_dev *host = (struct spdif_in_dev *)arg;\r\nu32 irq_status = readl(host->io_base + SPDIF_IN_IRQ);\r\nif (!irq_status)\r\nreturn IRQ_NONE;\r\nif (irq_status & SPDIF_IRQ_FIFOWRITE)\r\ndev_err(host->dev, "spdif in: fifo write error");\r\nif (irq_status & SPDIF_IRQ_EMPTYFIFOREAD)\r\ndev_err(host->dev, "spdif in: empty fifo read error");\r\nif (irq_status & SPDIF_IRQ_FIFOFULL)\r\ndev_err(host->dev, "spdif in: fifo full error");\r\nif (irq_status & SPDIF_IRQ_OUTOFRANGE)\r\ndev_err(host->dev, "spdif in: out of range error");\r\nwritel(0, host->io_base + SPDIF_IN_IRQ);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int spdif_in_probe(struct platform_device *pdev)\r\n{\r\nstruct spdif_in_dev *host;\r\nstruct spear_spdif_platform_data *pdata;\r\nstruct resource *res, *res_fifo;\r\nint ret;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -EINVAL;\r\nres_fifo = platform_get_resource(pdev, IORESOURCE_IO, 0);\r\nif (!res_fifo)\r\nreturn -EINVAL;\r\nif (!devm_request_mem_region(&pdev->dev, res->start,\r\nresource_size(res), pdev->name)) {\r\ndev_warn(&pdev->dev, "Failed to get memory resourse\n");\r\nreturn -ENOENT;\r\n}\r\nhost = devm_kzalloc(&pdev->dev, sizeof(*host), GFP_KERNEL);\r\nif (!host) {\r\ndev_warn(&pdev->dev, "kzalloc fail\n");\r\nreturn -ENOMEM;\r\n}\r\nhost->io_base = devm_ioremap(&pdev->dev, res->start,\r\nresource_size(res));\r\nif (!host->io_base) {\r\ndev_warn(&pdev->dev, "ioremap failed\n");\r\nreturn -ENOMEM;\r\n}\r\nhost->irq = platform_get_irq(pdev, 0);\r\nif (host->irq < 0)\r\nreturn -EINVAL;\r\nhost->clk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(host->clk))\r\nreturn PTR_ERR(host->clk);\r\npdata = dev_get_platdata(&pdev->dev);\r\nif (!pdata)\r\nreturn -EINVAL;\r\nhost->dma_params.data = pdata->dma_params;\r\nhost->dma_params.addr = res_fifo->start;\r\nhost->dma_params.max_burst = 16;\r\nhost->dma_params.addr_width = DMA_SLAVE_BUSWIDTH_4_BYTES;\r\nhost->dma_params.filter = pdata->filter;\r\nhost->reset_perip = pdata->reset_perip;\r\nhost->dev = &pdev->dev;\r\ndev_set_drvdata(&pdev->dev, host);\r\nret = devm_request_irq(&pdev->dev, host->irq, spdif_in_irq, 0,\r\n"spdif-in", host);\r\nif (ret) {\r\ndev_warn(&pdev->dev, "request_irq failed\n");\r\nreturn ret;\r\n}\r\nreturn snd_soc_register_component(&pdev->dev, &spdif_in_component,\r\n&spdif_in_dai, 1);\r\n}\r\nstatic int spdif_in_remove(struct platform_device *pdev)\r\n{\r\nsnd_soc_unregister_component(&pdev->dev);\r\nreturn 0;\r\n}

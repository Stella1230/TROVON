static void omap1_mcbsp_request(unsigned int id)\r\n{\r\nif (id == 0 || id == 2) {\r\nif (dsp_use++ == 0) {\r\napi_clk = clk_get(NULL, "api_ck");\r\ndsp_clk = clk_get(NULL, "dsp_ck");\r\nif (!IS_ERR(api_clk) && !IS_ERR(dsp_clk)) {\r\nclk_enable(api_clk);\r\nclk_enable(dsp_clk);\r\n__raw_writew(__raw_readw(DSP_RSTCT2) | DPS_RSTCT2_PER_EN |\r\nDSP_RSTCT2_WD_PER_EN, DSP_RSTCT2);\r\n}\r\n}\r\n}\r\n}\r\nstatic void omap1_mcbsp_free(unsigned int id)\r\n{\r\nif (id == 0 || id == 2) {\r\nif (--dsp_use == 0) {\r\nif (!IS_ERR(api_clk)) {\r\nclk_disable(api_clk);\r\nclk_put(api_clk);\r\n}\r\nif (!IS_ERR(dsp_clk)) {\r\nclk_disable(dsp_clk);\r\nclk_put(dsp_clk);\r\n}\r\n}\r\n}\r\n}\r\nstatic void omap_mcbsp_register_board_cfg(struct resource *res, int res_count,\r\nstruct omap_mcbsp_platform_data *config, int size)\r\n{\r\nint i;\r\nomap_mcbsp_devices = kzalloc(size * sizeof(struct platform_device *),\r\nGFP_KERNEL);\r\nif (!omap_mcbsp_devices) {\r\nprintk(KERN_ERR "Could not register McBSP devices\n");\r\nreturn;\r\n}\r\nfor (i = 0; i < size; i++) {\r\nstruct platform_device *new_mcbsp;\r\nint ret;\r\nnew_mcbsp = platform_device_alloc("omap-mcbsp", i + 1);\r\nif (!new_mcbsp)\r\ncontinue;\r\nplatform_device_add_resources(new_mcbsp, &res[i * res_count],\r\nres_count);\r\nconfig[i].reg_size = 2;\r\nconfig[i].reg_step = 2;\r\nnew_mcbsp->dev.platform_data = &config[i];\r\nret = platform_device_add(new_mcbsp);\r\nif (ret) {\r\nplatform_device_put(new_mcbsp);\r\ncontinue;\r\n}\r\nomap_mcbsp_devices[i] = new_mcbsp;\r\n}\r\n}\r\nstatic int __init omap1_mcbsp_init(void)\r\n{\r\nif (!cpu_class_is_omap1())\r\nreturn -ENODEV;\r\nif (cpu_is_omap7xx())\r\nomap_mcbsp_register_board_cfg(omap7xx_mcbsp_res_0,\r\nOMAP7XX_MCBSP_RES_SZ,\r\nomap7xx_mcbsp_pdata,\r\nOMAP7XX_MCBSP_COUNT);\r\nif (cpu_is_omap15xx())\r\nomap_mcbsp_register_board_cfg(omap15xx_mcbsp_res_0,\r\nOMAP15XX_MCBSP_RES_SZ,\r\nomap15xx_mcbsp_pdata,\r\nOMAP15XX_MCBSP_COUNT);\r\nif (cpu_is_omap16xx())\r\nomap_mcbsp_register_board_cfg(omap16xx_mcbsp_res_0,\r\nOMAP16XX_MCBSP_RES_SZ,\r\nomap16xx_mcbsp_pdata,\r\nOMAP16XX_MCBSP_COUNT);\r\nreturn 0;\r\n}

static u8 kvaser_pci_read_reg(const struct sja1000_priv *priv, int port)\r\n{\r\nreturn ioread8(priv->reg_base + port);\r\n}\r\nstatic void kvaser_pci_write_reg(const struct sja1000_priv *priv,\r\nint port, u8 val)\r\n{\r\niowrite8(val, priv->reg_base + port);\r\n}\r\nstatic void kvaser_pci_disable_irq(struct net_device *dev)\r\n{\r\nstruct sja1000_priv *priv = netdev_priv(dev);\r\nstruct kvaser_pci *board = priv->priv;\r\nu32 intcsr;\r\nintcsr = ioread32(board->conf_addr + S5920_INTCSR);\r\nintcsr &= ~INTCSR_ADDON_INTENABLE_M;\r\niowrite32(intcsr, board->conf_addr + S5920_INTCSR);\r\n}\r\nstatic void kvaser_pci_enable_irq(struct net_device *dev)\r\n{\r\nstruct sja1000_priv *priv = netdev_priv(dev);\r\nstruct kvaser_pci *board = priv->priv;\r\nu32 tmp_en_io;\r\ntmp_en_io = ioread32(board->conf_addr + S5920_INTCSR);\r\ntmp_en_io |= INTCSR_ADDON_INTENABLE_M;\r\niowrite32(tmp_en_io, board->conf_addr + S5920_INTCSR);\r\n}\r\nstatic int number_of_sja1000_chip(void __iomem *base_addr)\r\n{\r\nu8 status;\r\nint i;\r\nfor (i = 0; i < MAX_NO_OF_CHANNELS; i++) {\r\niowrite8(MOD_RM, base_addr +\r\n(i * KVASER_PCI_PORT_BYTES) + SJA1000_MOD);\r\nstatus = ioread8(base_addr +\r\n(i * KVASER_PCI_PORT_BYTES) + SJA1000_MOD);\r\nif (!(status & MOD_RM))\r\nbreak;\r\n}\r\nreturn i;\r\n}\r\nstatic void kvaser_pci_del_chan(struct net_device *dev)\r\n{\r\nstruct sja1000_priv *priv;\r\nstruct kvaser_pci *board;\r\nint i;\r\nif (!dev)\r\nreturn;\r\npriv = netdev_priv(dev);\r\nboard = priv->priv;\r\nif (!board)\r\nreturn;\r\ndev_info(&board->pci_dev->dev, "Removing device %s\n",\r\ndev->name);\r\nkvaser_pci_disable_irq(dev);\r\nfor (i = 0; i < board->no_channels - 1; i++) {\r\nif (board->slave_dev[i]) {\r\ndev_info(&board->pci_dev->dev, "Removing device %s\n",\r\nboard->slave_dev[i]->name);\r\nunregister_sja1000dev(board->slave_dev[i]);\r\nfree_sja1000dev(board->slave_dev[i]);\r\n}\r\n}\r\nunregister_sja1000dev(dev);\r\npci_iounmap(board->pci_dev, priv->reg_base);\r\npci_iounmap(board->pci_dev, board->conf_addr);\r\npci_iounmap(board->pci_dev, board->res_addr);\r\nfree_sja1000dev(dev);\r\n}\r\nstatic int kvaser_pci_add_chan(struct pci_dev *pdev, int channel,\r\nstruct net_device **master_dev,\r\nvoid __iomem *conf_addr,\r\nvoid __iomem *res_addr,\r\nvoid __iomem *base_addr)\r\n{\r\nstruct net_device *dev;\r\nstruct sja1000_priv *priv;\r\nstruct kvaser_pci *board;\r\nint err, init_step;\r\ndev = alloc_sja1000dev(sizeof(struct kvaser_pci));\r\nif (dev == NULL)\r\nreturn -ENOMEM;\r\npriv = netdev_priv(dev);\r\nboard = priv->priv;\r\nboard->pci_dev = pdev;\r\nboard->channel = channel;\r\nboard->conf_addr = conf_addr;\r\nboard->res_addr = res_addr;\r\nif (channel == 0) {\r\nboard->xilinx_ver =\r\nioread8(board->res_addr + XILINX_VERINT) >> 4;\r\ninit_step = 2;\r\niowrite32(0x80808080UL, board->conf_addr + S5920_PTCR);\r\nkvaser_pci_enable_irq(dev);\r\n} else {\r\nstruct sja1000_priv *master_priv = netdev_priv(*master_dev);\r\nstruct kvaser_pci *master_board = master_priv->priv;\r\nmaster_board->slave_dev[channel - 1] = dev;\r\nmaster_board->no_channels = channel + 1;\r\nboard->xilinx_ver = master_board->xilinx_ver;\r\n}\r\npriv->reg_base = base_addr + channel * KVASER_PCI_PORT_BYTES;\r\npriv->read_reg = kvaser_pci_read_reg;\r\npriv->write_reg = kvaser_pci_write_reg;\r\npriv->can.clock.freq = KVASER_PCI_CAN_CLOCK;\r\npriv->ocr = KVASER_PCI_OCR;\r\npriv->cdr = KVASER_PCI_CDR;\r\npriv->irq_flags = IRQF_SHARED;\r\ndev->irq = pdev->irq;\r\ninit_step = 4;\r\ndev_info(&pdev->dev, "reg_base=%p conf_addr=%p irq=%d\n",\r\npriv->reg_base, board->conf_addr, dev->irq);\r\nSET_NETDEV_DEV(dev, &pdev->dev);\r\nerr = register_sja1000dev(dev);\r\nif (err) {\r\ndev_err(&pdev->dev, "Registering device failed (err=%d)\n",\r\nerr);\r\ngoto failure;\r\n}\r\nif (channel == 0)\r\n*master_dev = dev;\r\nreturn 0;\r\nfailure:\r\nkvaser_pci_del_chan(dev);\r\nreturn err;\r\n}\r\nstatic int kvaser_pci_init_one(struct pci_dev *pdev,\r\nconst struct pci_device_id *ent)\r\n{\r\nint err;\r\nstruct net_device *master_dev = NULL;\r\nstruct sja1000_priv *priv;\r\nstruct kvaser_pci *board;\r\nint no_channels;\r\nvoid __iomem *base_addr = NULL;\r\nvoid __iomem *conf_addr = NULL;\r\nvoid __iomem *res_addr = NULL;\r\nint i;\r\ndev_info(&pdev->dev, "initializing device %04x:%04x\n",\r\npdev->vendor, pdev->device);\r\nerr = pci_enable_device(pdev);\r\nif (err)\r\ngoto failure;\r\nerr = pci_request_regions(pdev, DRV_NAME);\r\nif (err)\r\ngoto failure_release_pci;\r\nconf_addr = pci_iomap(pdev, 0, PCI_CONFIG_PORT_SIZE);\r\nif (conf_addr == NULL) {\r\nerr = -ENODEV;\r\ngoto failure_release_regions;\r\n}\r\nres_addr = pci_iomap(pdev, 2, PCI_PORT_XILINX_SIZE);\r\nif (res_addr == NULL) {\r\nerr = -ENOMEM;\r\ngoto failure_iounmap;\r\n}\r\nbase_addr = pci_iomap(pdev, 1, PCI_PORT_SIZE);\r\nif (base_addr == NULL) {\r\nerr = -ENOMEM;\r\ngoto failure_iounmap;\r\n}\r\nno_channels = number_of_sja1000_chip(base_addr);\r\nif (no_channels == 0) {\r\nerr = -ENOMEM;\r\ngoto failure_iounmap;\r\n}\r\nfor (i = 0; i < no_channels; i++) {\r\nerr = kvaser_pci_add_chan(pdev, i, &master_dev,\r\nconf_addr, res_addr,\r\nbase_addr);\r\nif (err)\r\ngoto failure_cleanup;\r\n}\r\npriv = netdev_priv(master_dev);\r\nboard = priv->priv;\r\ndev_info(&pdev->dev, "xilinx version=%d number of channels=%d\n",\r\nboard->xilinx_ver, board->no_channels);\r\npci_set_drvdata(pdev, master_dev);\r\nreturn 0;\r\nfailure_cleanup:\r\nkvaser_pci_del_chan(master_dev);\r\nfailure_iounmap:\r\nif (conf_addr != NULL)\r\npci_iounmap(pdev, conf_addr);\r\nif (res_addr != NULL)\r\npci_iounmap(pdev, res_addr);\r\nif (base_addr != NULL)\r\npci_iounmap(pdev, base_addr);\r\nfailure_release_regions:\r\npci_release_regions(pdev);\r\nfailure_release_pci:\r\npci_disable_device(pdev);\r\nfailure:\r\nreturn err;\r\n}\r\nstatic void kvaser_pci_remove_one(struct pci_dev *pdev)\r\n{\r\nstruct net_device *dev = pci_get_drvdata(pdev);\r\nkvaser_pci_del_chan(dev);\r\npci_release_regions(pdev);\r\npci_disable_device(pdev);\r\npci_set_drvdata(pdev, NULL);\r\n}

static int blink1_send_command(struct blink1_data *data,\r\nu8 buf[BLINK1_CMD_SIZE])\r\n{\r\nint ret;\r\nhid_dbg(data->hdev, "command: %d%c%.2x%.2x%.2x%.2x%.2x%.2x%.2x\n",\r\nbuf[0], buf[1], buf[2], buf[3], buf[4],\r\nbuf[5], buf[6], buf[7], buf[8]);\r\nret = data->hdev->hid_output_raw_report(data->hdev, buf,\r\nBLINK1_CMD_SIZE, HID_FEATURE_REPORT);\r\nreturn ret < 0 ? ret : 0;\r\n}\r\nstatic int blink1_update_color(struct blink1_data *data)\r\n{\r\nu8 buf[BLINK1_CMD_SIZE] = { 1, 'n', 0, 0, 0, 0, 0, 0, 0 };\r\nif (data->brightness) {\r\nunsigned int coef = DIV_ROUND_CLOSEST(255, data->brightness);\r\nbuf[2] = DIV_ROUND_CLOSEST(blink1_rgb_to_r(data->rgb), coef);\r\nbuf[3] = DIV_ROUND_CLOSEST(blink1_rgb_to_g(data->rgb), coef);\r\nbuf[4] = DIV_ROUND_CLOSEST(blink1_rgb_to_b(data->rgb), coef);\r\n}\r\nif (data->fade) {\r\nbuf[1] = 'c';\r\nbuf[5] = (data->fade & 0xFF00) >> 8;\r\nbuf[6] = (data->fade & 0x00FF);\r\n}\r\nreturn blink1_send_command(data, buf);\r\n}\r\nstatic void blink1_led_set(struct led_classdev *led_cdev,\r\nenum led_brightness brightness)\r\n{\r\nstruct blink1_data *data = dev_get_drvdata(led_cdev->dev->parent);\r\ndata->brightness = brightness;\r\nif (blink1_update_color(data))\r\nhid_err(data->hdev, "failed to update color\n");\r\n}\r\nstatic enum led_brightness blink1_led_get(struct led_classdev *led_cdev)\r\n{\r\nstruct blink1_data *data = dev_get_drvdata(led_cdev->dev->parent);\r\nreturn data->brightness;\r\n}\r\nstatic ssize_t blink1_show_rgb(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct blink1_data *data = dev_get_drvdata(dev->parent);\r\nreturn sprintf(buf, "%.6X\n", data->rgb);\r\n}\r\nstatic ssize_t blink1_store_rgb(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nstruct blink1_data *data = dev_get_drvdata(dev->parent);\r\nlong unsigned int rgb;\r\nint ret;\r\nret = kstrtoul(buf, 16, &rgb);\r\nif (ret)\r\nreturn ret;\r\nif (rgb > 0xFFFFFF)\r\nreturn -EINVAL;\r\ndata->rgb = rgb;\r\nret = blink1_update_color(data);\r\nreturn ret ? ret : count;\r\n}\r\nstatic ssize_t blink1_show_fade(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct blink1_data *data = dev_get_drvdata(dev->parent);\r\nreturn sprintf(buf, "%d\n", data->fade * 10);\r\n}\r\nstatic ssize_t blink1_store_fade(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nstruct blink1_data *data = dev_get_drvdata(dev->parent);\r\nlong unsigned int fade;\r\nint ret;\r\nret = kstrtoul(buf, 10, &fade);\r\nif (ret)\r\nreturn ret;\r\nfade = DIV_ROUND_CLOSEST(fade, 10);\r\nif (fade > 65535)\r\nreturn -EINVAL;\r\ndata->fade = fade;\r\nreturn count;\r\n}\r\nstatic ssize_t blink1_show_play(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct blink1_data *data = dev_get_drvdata(dev->parent);\r\nreturn sprintf(buf, "%d\n", data->play);\r\n}\r\nstatic ssize_t blink1_store_play(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nstruct blink1_data *data = dev_get_drvdata(dev->parent);\r\nu8 cmd[BLINK1_CMD_SIZE] = { 1, 'p', 0, 0, 0, 0, 0, 0, 0 };\r\nlong unsigned int play;\r\nint ret;\r\nret = kstrtoul(buf, 10, &play);\r\nif (ret)\r\nreturn ret;\r\ndata->play = !!play;\r\ncmd[2] = data->play;\r\nret = blink1_send_command(data, cmd);\r\nreturn ret ? ret : count;\r\n}\r\nstatic int thingm_probe(struct hid_device *hdev, const struct hid_device_id *id)\r\n{\r\nstruct blink1_data *data;\r\nstruct led_classdev *led;\r\nchar led_name[13];\r\nint ret;\r\ndata = devm_kzalloc(&hdev->dev, sizeof(struct blink1_data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\nhid_set_drvdata(hdev, data);\r\ndata->hdev = hdev;\r\ndata->rgb = 0xFFFFFF;\r\nret = hid_parse(hdev);\r\nif (ret)\r\ngoto error;\r\nret = hid_hw_start(hdev, HID_CONNECT_HIDRAW);\r\nif (ret)\r\ngoto error;\r\nled = &data->led_cdev;\r\nsnprintf(led_name, sizeof(led_name), "blink1::%s", hdev->uniq + 4);\r\nled->name = led_name;\r\nled->brightness_set = blink1_led_set;\r\nled->brightness_get = blink1_led_get;\r\nret = led_classdev_register(&hdev->dev, led);\r\nif (ret)\r\ngoto stop;\r\nret = sysfs_create_group(&led->dev->kobj, &blink1_sysfs_group);\r\nif (ret)\r\ngoto remove_led;\r\nreturn 0;\r\nremove_led:\r\nled_classdev_unregister(led);\r\nstop:\r\nhid_hw_stop(hdev);\r\nerror:\r\nreturn ret;\r\n}\r\nstatic void thingm_remove(struct hid_device *hdev)\r\n{\r\nstruct blink1_data *data = hid_get_drvdata(hdev);\r\nstruct led_classdev *led = &data->led_cdev;\r\nsysfs_remove_group(&led->dev->kobj, &blink1_sysfs_group);\r\nled_classdev_unregister(led);\r\nhid_hw_stop(hdev);\r\n}

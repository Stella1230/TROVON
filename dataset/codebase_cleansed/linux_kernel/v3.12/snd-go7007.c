static void parse_audio_stream_data(struct go7007 *go, u8 *buf, int length)\r\n{\r\nstruct go7007_snd *gosnd = go->snd_context;\r\nstruct snd_pcm_runtime *runtime = gosnd->substream->runtime;\r\nint frames = bytes_to_frames(runtime, length);\r\nspin_lock(&gosnd->lock);\r\ngosnd->hw_ptr += frames;\r\nif (gosnd->hw_ptr >= runtime->buffer_size)\r\ngosnd->hw_ptr -= runtime->buffer_size;\r\ngosnd->avail += frames;\r\nspin_unlock(&gosnd->lock);\r\nif (gosnd->w_idx + length > runtime->dma_bytes) {\r\nint cpy = runtime->dma_bytes - gosnd->w_idx;\r\nmemcpy(runtime->dma_area + gosnd->w_idx, buf, cpy);\r\nlength -= cpy;\r\nbuf += cpy;\r\ngosnd->w_idx = 0;\r\n}\r\nmemcpy(runtime->dma_area + gosnd->w_idx, buf, length);\r\ngosnd->w_idx += length;\r\nspin_lock(&gosnd->lock);\r\nif (gosnd->avail < runtime->period_size) {\r\nspin_unlock(&gosnd->lock);\r\nreturn;\r\n}\r\ngosnd->avail -= runtime->period_size;\r\nspin_unlock(&gosnd->lock);\r\nif (gosnd->capturing)\r\nsnd_pcm_period_elapsed(gosnd->substream);\r\n}\r\nstatic int go7007_snd_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *hw_params)\r\n{\r\nstruct go7007 *go = snd_pcm_substream_chip(substream);\r\nunsigned int bytes;\r\nbytes = params_buffer_bytes(hw_params);\r\nif (substream->runtime->dma_bytes > 0)\r\nvfree(substream->runtime->dma_area);\r\nsubstream->runtime->dma_bytes = 0;\r\nsubstream->runtime->dma_area = vmalloc(bytes);\r\nif (substream->runtime->dma_area == NULL)\r\nreturn -ENOMEM;\r\nsubstream->runtime->dma_bytes = bytes;\r\ngo->audio_deliver = parse_audio_stream_data;\r\nreturn 0;\r\n}\r\nstatic int go7007_snd_hw_free(struct snd_pcm_substream *substream)\r\n{\r\nstruct go7007 *go = snd_pcm_substream_chip(substream);\r\ngo->audio_deliver = NULL;\r\nif (substream->runtime->dma_bytes > 0)\r\nvfree(substream->runtime->dma_area);\r\nsubstream->runtime->dma_bytes = 0;\r\nreturn 0;\r\n}\r\nstatic int go7007_snd_capture_open(struct snd_pcm_substream *substream)\r\n{\r\nstruct go7007 *go = snd_pcm_substream_chip(substream);\r\nstruct go7007_snd *gosnd = go->snd_context;\r\nunsigned long flags;\r\nint r;\r\nspin_lock_irqsave(&gosnd->lock, flags);\r\nif (gosnd->substream == NULL) {\r\ngosnd->substream = substream;\r\nsubstream->runtime->hw = go7007_snd_capture_hw;\r\nr = 0;\r\n} else\r\nr = -EBUSY;\r\nspin_unlock_irqrestore(&gosnd->lock, flags);\r\nreturn r;\r\n}\r\nstatic int go7007_snd_capture_close(struct snd_pcm_substream *substream)\r\n{\r\nstruct go7007 *go = snd_pcm_substream_chip(substream);\r\nstruct go7007_snd *gosnd = go->snd_context;\r\ngosnd->substream = NULL;\r\nreturn 0;\r\n}\r\nstatic int go7007_snd_pcm_prepare(struct snd_pcm_substream *substream)\r\n{\r\nreturn 0;\r\n}\r\nstatic int go7007_snd_pcm_trigger(struct snd_pcm_substream *substream, int cmd)\r\n{\r\nstruct go7007 *go = snd_pcm_substream_chip(substream);\r\nstruct go7007_snd *gosnd = go->snd_context;\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\ngosnd->capturing = 1;\r\nreturn 0;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ngosnd->hw_ptr = gosnd->w_idx = gosnd->avail = 0;\r\ngosnd->capturing = 0;\r\nreturn 0;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic snd_pcm_uframes_t go7007_snd_pcm_pointer(struct snd_pcm_substream *substream)\r\n{\r\nstruct go7007 *go = snd_pcm_substream_chip(substream);\r\nstruct go7007_snd *gosnd = go->snd_context;\r\nreturn gosnd->hw_ptr;\r\n}\r\nstatic struct page *go7007_snd_pcm_page(struct snd_pcm_substream *substream,\r\nunsigned long offset)\r\n{\r\nreturn vmalloc_to_page(substream->runtime->dma_area + offset);\r\n}\r\nstatic int go7007_snd_free(struct snd_device *device)\r\n{\r\nstruct go7007 *go = device->device_data;\r\nkfree(go->snd_context);\r\ngo->snd_context = NULL;\r\nreturn 0;\r\n}\r\nint go7007_snd_init(struct go7007 *go)\r\n{\r\nstatic int dev;\r\nstruct go7007_snd *gosnd;\r\nint ret = 0;\r\nif (dev >= SNDRV_CARDS)\r\nreturn -ENODEV;\r\nif (!enable[dev]) {\r\ndev++;\r\nreturn -ENOENT;\r\n}\r\ngosnd = kmalloc(sizeof(struct go7007_snd), GFP_KERNEL);\r\nif (gosnd == NULL)\r\nreturn -ENOMEM;\r\nspin_lock_init(&gosnd->lock);\r\ngosnd->hw_ptr = gosnd->w_idx = gosnd->avail = 0;\r\ngosnd->capturing = 0;\r\nret = snd_card_create(index[dev], id[dev], THIS_MODULE, 0,\r\n&gosnd->card);\r\nif (ret < 0) {\r\nkfree(gosnd);\r\nreturn ret;\r\n}\r\nret = snd_device_new(gosnd->card, SNDRV_DEV_LOWLEVEL, go,\r\n&go7007_snd_device_ops);\r\nif (ret < 0) {\r\nkfree(gosnd);\r\nreturn ret;\r\n}\r\nsnd_card_set_dev(gosnd->card, go->dev);\r\nret = snd_pcm_new(gosnd->card, "go7007", 0, 0, 1, &gosnd->pcm);\r\nif (ret < 0) {\r\nsnd_card_free(gosnd->card);\r\nkfree(gosnd);\r\nreturn ret;\r\n}\r\nstrlcpy(gosnd->card->driver, "go7007", sizeof(gosnd->card->driver));\r\nstrlcpy(gosnd->card->shortname, go->name, sizeof(gosnd->card->driver));\r\nstrlcpy(gosnd->card->longname, gosnd->card->shortname,\r\nsizeof(gosnd->card->longname));\r\ngosnd->pcm->private_data = go;\r\nsnd_pcm_set_ops(gosnd->pcm, SNDRV_PCM_STREAM_CAPTURE,\r\n&go7007_snd_capture_ops);\r\nret = snd_card_register(gosnd->card);\r\nif (ret < 0) {\r\nsnd_card_free(gosnd->card);\r\nkfree(gosnd);\r\nreturn ret;\r\n}\r\ngosnd->substream = NULL;\r\ngo->snd_context = gosnd;\r\nv4l2_device_get(&go->v4l2_dev);\r\n++dev;\r\nreturn 0;\r\n}\r\nint go7007_snd_remove(struct go7007 *go)\r\n{\r\nstruct go7007_snd *gosnd = go->snd_context;\r\nsnd_card_disconnect(gosnd->card);\r\nsnd_card_free_when_closed(gosnd->card);\r\nv4l2_device_put(&go->v4l2_dev);\r\nreturn 0;\r\n}

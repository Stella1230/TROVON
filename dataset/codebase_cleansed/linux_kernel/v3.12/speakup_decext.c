static inline u_char get_last_char(void)\r\n{\r\nu_char avail = inb_p(speakup_info.port_tts + UART_LSR) & UART_LSR_DR;\r\nif (avail)\r\nlast_char = inb_p(speakup_info.port_tts + UART_RX);\r\nreturn last_char;\r\n}\r\nstatic inline bool synth_full(void)\r\n{\r\nreturn get_last_char() == 0x13;\r\n}\r\nstatic void do_catch_up(struct spk_synth *synth)\r\n{\r\nu_char ch;\r\nstatic u_char last = '\0';\r\nunsigned long flags;\r\nunsigned long jiff_max;\r\nstruct var_t *jiffy_delta;\r\nstruct var_t *delay_time;\r\nint jiffy_delta_val = 0;\r\nint delay_time_val = 0;\r\njiffy_delta = spk_get_var(JIFFY);\r\ndelay_time = spk_get_var(DELAY);\r\nspin_lock_irqsave(&speakup_info.spinlock, flags);\r\njiffy_delta_val = jiffy_delta->u.n.value;\r\nspin_unlock_irqrestore(&speakup_info.spinlock, flags);\r\njiff_max = jiffies + jiffy_delta_val;\r\nwhile (!kthread_should_stop()) {\r\nspin_lock_irqsave(&speakup_info.spinlock, flags);\r\nif (speakup_info.flushing) {\r\nspeakup_info.flushing = 0;\r\nspin_unlock_irqrestore(&speakup_info.spinlock, flags);\r\nsynth->flush(synth);\r\ncontinue;\r\n}\r\nif (synth_buffer_empty()) {\r\nspin_unlock_irqrestore(&speakup_info.spinlock, flags);\r\nbreak;\r\n}\r\nch = synth_buffer_peek();\r\nset_current_state(TASK_INTERRUPTIBLE);\r\ndelay_time_val = delay_time->u.n.value;\r\nspin_unlock_irqrestore(&speakup_info.spinlock, flags);\r\nif (ch == '\n')\r\nch = 0x0D;\r\nif (synth_full() || !spk_serial_out(ch)) {\r\nschedule_timeout(msecs_to_jiffies(delay_time_val));\r\ncontinue;\r\n}\r\nset_current_state(TASK_RUNNING);\r\nspin_lock_irqsave(&speakup_info.spinlock, flags);\r\nsynth_buffer_getc();\r\nspin_unlock_irqrestore(&speakup_info.spinlock, flags);\r\nif (ch == '[')\r\nin_escape = 1;\r\nelse if (ch == ']')\r\nin_escape = 0;\r\nelse if (ch <= SPACE) {\r\nif (!in_escape && strchr(",.!?;:", last))\r\nspk_serial_out(PROCSPEECH);\r\nif (jiffies >= jiff_max) {\r\nif (!in_escape)\r\nspk_serial_out(PROCSPEECH);\r\nspin_lock_irqsave(&speakup_info.spinlock, flags);\r\njiffy_delta_val = jiffy_delta->u.n.value;\r\ndelay_time_val = delay_time->u.n.value;\r\nspin_unlock_irqrestore(&speakup_info.spinlock, flags);\r\nschedule_timeout(msecs_to_jiffies\r\n(delay_time_val));\r\njiff_max = jiffies + jiffy_delta_val;\r\n}\r\n}\r\nlast = ch;\r\n}\r\nif (!in_escape)\r\nspk_serial_out(PROCSPEECH);\r\n}\r\nstatic void synth_flush(struct spk_synth *synth)\r\n{\r\nin_escape = 0;\r\nspk_synth_immediate(synth, "\033P;10z\033\\");\r\n}\r\nstatic int __init decext_init(void)\r\n{\r\nreturn synth_add(&synth_decext);\r\n}\r\nstatic void __exit decext_exit(void)\r\n{\r\nsynth_remove(&synth_decext);\r\n}

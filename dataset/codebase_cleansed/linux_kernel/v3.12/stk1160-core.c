int stk1160_read_reg(struct stk1160 *dev, u16 reg, u8 *value)\r\n{\r\nint ret;\r\nint pipe = usb_rcvctrlpipe(dev->udev, 0);\r\n*value = 0;\r\nret = usb_control_msg(dev->udev, pipe, 0x00,\r\nUSB_DIR_IN | USB_TYPE_VENDOR | USB_RECIP_DEVICE,\r\n0x00, reg, value, sizeof(u8), HZ);\r\nif (ret < 0) {\r\nstk1160_err("read failed on reg 0x%x (%d)\n",\r\nreg, ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nint stk1160_write_reg(struct stk1160 *dev, u16 reg, u16 value)\r\n{\r\nint ret;\r\nint pipe = usb_sndctrlpipe(dev->udev, 0);\r\nret = usb_control_msg(dev->udev, pipe, 0x01,\r\nUSB_DIR_OUT | USB_TYPE_VENDOR | USB_RECIP_DEVICE,\r\nvalue, reg, NULL, 0, HZ);\r\nif (ret < 0) {\r\nstk1160_err("write failed on reg 0x%x (%d)\n",\r\nreg, ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nvoid stk1160_select_input(struct stk1160 *dev)\r\n{\r\nint route;\r\nstatic const u8 gctrl[] = {\r\n0x98, 0x90, 0x88, 0x80, 0x98\r\n};\r\nif (dev->ctl_input == STK1160_SVIDEO_INPUT)\r\nroute = SAA7115_SVIDEO3;\r\nelse\r\nroute = SAA7115_COMPOSITE0;\r\nif (dev->ctl_input < ARRAY_SIZE(gctrl)) {\r\nv4l2_device_call_all(&dev->v4l2_dev, 0, video, s_routing,\r\nroute, 0, 0);\r\nstk1160_write_reg(dev, STK1160_GCTRL, gctrl[dev->ctl_input]);\r\n}\r\n}\r\nstatic void stk1160_reg_reset(struct stk1160 *dev)\r\n{\r\nint i;\r\nstatic const struct regval ctl[] = {\r\n{STK1160_GCTRL+2, 0x0078},\r\n{STK1160_RMCTL+1, 0x0000},\r\n{STK1160_RMCTL+3, 0x0002},\r\n{STK1160_PLLSO, 0x0010},\r\n{STK1160_PLLSO+1, 0x0000},\r\n{STK1160_PLLSO+2, 0x0014},\r\n{STK1160_PLLSO+3, 0x000E},\r\n{STK1160_PLLFD, 0x0046},\r\n{STK1160_TIGEN, 0x0012},\r\n{STK1160_TICTL, 0x002D},\r\n{STK1160_TICTL+1, 0x0001},\r\n{STK1160_TICTL+2, 0x0000},\r\n{STK1160_TICTL+3, 0x0000},\r\n{STK1160_TIGEN, 0x0080},\r\n{0xffff, 0xffff}\r\n};\r\nfor (i = 0; ctl[i].reg != 0xffff; i++)\r\nstk1160_write_reg(dev, ctl[i].reg, ctl[i].val);\r\n}\r\nstatic void stk1160_release(struct v4l2_device *v4l2_dev)\r\n{\r\nstruct stk1160 *dev = container_of(v4l2_dev, struct stk1160, v4l2_dev);\r\nstk1160_info("releasing all resources\n");\r\nstk1160_i2c_unregister(dev);\r\nv4l2_ctrl_handler_free(&dev->ctrl_handler);\r\nv4l2_device_unregister(&dev->v4l2_dev);\r\nkfree(dev->alt_max_pkt_size);\r\nkfree(dev);\r\n}\r\nstatic int stk1160_scan_usb(struct usb_interface *intf, struct usb_device *udev,\r\nunsigned int *max_pkt_size)\r\n{\r\nint i, e, sizedescr, size, ifnum;\r\nconst struct usb_endpoint_descriptor *desc;\r\nbool has_video = false, has_audio = false;\r\nconst char *speed;\r\nifnum = intf->altsetting[0].desc.bInterfaceNumber;\r\nfor (i = 0; i < intf->num_altsetting; i++) {\r\nfor (e = 0; e < intf->altsetting[i].desc.bNumEndpoints; e++) {\r\ndesc = &intf->altsetting[i].endpoint[e].desc;\r\nsizedescr = le16_to_cpu(desc->wMaxPacketSize);\r\nsize = sizedescr & 0x7ff;\r\nif (udev->speed == USB_SPEED_HIGH)\r\nsize = size * hb_mult(sizedescr);\r\nif (usb_endpoint_xfer_isoc(desc) &&\r\nusb_endpoint_dir_in(desc)) {\r\nswitch (desc->bEndpointAddress) {\r\ncase STK1160_EP_AUDIO:\r\nhas_audio = true;\r\nbreak;\r\ncase STK1160_EP_VIDEO:\r\nhas_video = true;\r\nmax_pkt_size[i] = size;\r\nbreak;\r\n}\r\n}\r\n}\r\n}\r\nif (!(has_audio || has_video)) {\r\ndev_err(&udev->dev, "no audio or video endpoints found\n");\r\nreturn -ENODEV;\r\n}\r\nswitch (udev->speed) {\r\ncase USB_SPEED_LOW:\r\nspeed = "1.5";\r\nbreak;\r\ncase USB_SPEED_FULL:\r\nspeed = "12";\r\nbreak;\r\ncase USB_SPEED_HIGH:\r\nspeed = "480";\r\nbreak;\r\ndefault:\r\nspeed = "unknown";\r\n}\r\ndev_info(&udev->dev, "New device %s %s @ %s Mbps (%04x:%04x, interface %d, class %d)\n",\r\nudev->manufacturer ? udev->manufacturer : "",\r\nudev->product ? udev->product : "",\r\nspeed,\r\nle16_to_cpu(udev->descriptor.idVendor),\r\nle16_to_cpu(udev->descriptor.idProduct),\r\nifnum,\r\nintf->altsetting->desc.bInterfaceNumber);\r\nif (has_audio)\r\ndev_warn(&udev->dev, "audio interface %d found.\n\\r\nThis is not implemented by this driver,\\r\nyou should use snd-usb-audio instead\n", ifnum);\r\nif (has_video)\r\ndev_info(&udev->dev, "video interface %d found\n",\r\nifnum);\r\nif (udev->speed != USB_SPEED_HIGH)\r\ndev_warn(&udev->dev, "must be connected to a high-speed USB 2.0 port\n\\r\nYou may not be able to stream video smoothly\n");\r\nreturn 0;\r\n}\r\nstatic int stk1160_probe(struct usb_interface *interface,\r\nconst struct usb_device_id *id)\r\n{\r\nint rc = 0;\r\nunsigned int *alt_max_pkt_size;\r\nstruct usb_device *udev;\r\nstruct stk1160 *dev;\r\nudev = interface_to_usbdev(interface);\r\nif (interface->altsetting[0].desc.bInterfaceClass == USB_CLASS_AUDIO)\r\nreturn -ENODEV;\r\nalt_max_pkt_size = kmalloc(sizeof(alt_max_pkt_size[0]) *\r\ninterface->num_altsetting, GFP_KERNEL);\r\nif (alt_max_pkt_size == NULL)\r\nreturn -ENOMEM;\r\nrc = stk1160_scan_usb(interface, udev, alt_max_pkt_size);\r\nif (rc < 0) {\r\nkfree(alt_max_pkt_size);\r\nreturn rc;\r\n}\r\ndev = kzalloc(sizeof(struct stk1160), GFP_KERNEL);\r\nif (dev == NULL) {\r\nkfree(alt_max_pkt_size);\r\nreturn -ENOMEM;\r\n}\r\ndev->alt_max_pkt_size = alt_max_pkt_size;\r\ndev->udev = udev;\r\ndev->num_alt = interface->num_altsetting;\r\ndev->ctl_input = input;\r\ndev->dev = &interface->dev;\r\nusb_set_intfdata(interface, dev);\r\nrc = stk1160_vb2_setup(dev);\r\nif (rc < 0)\r\ngoto free_err;\r\nspin_lock_init(&dev->buf_lock);\r\nmutex_init(&dev->v4l_lock);\r\nmutex_init(&dev->vb_queue_lock);\r\nrc = v4l2_ctrl_handler_init(&dev->ctrl_handler, 0);\r\nif (rc) {\r\nstk1160_err("v4l2_ctrl_handler_init failed (%d)\n", rc);\r\ngoto free_err;\r\n}\r\ndev->v4l2_dev.release = stk1160_release;\r\ndev->v4l2_dev.ctrl_handler = &dev->ctrl_handler;\r\nrc = v4l2_device_register(dev->dev, &dev->v4l2_dev);\r\nif (rc) {\r\nstk1160_err("v4l2_device_register failed (%d)\n", rc);\r\ngoto free_ctrl;\r\n}\r\nrc = stk1160_i2c_register(dev);\r\nif (rc < 0)\r\ngoto unreg_v4l2;\r\ndev->sd_saa7115 = v4l2_i2c_new_subdev(&dev->v4l2_dev, &dev->i2c_adap,\r\n"saa7115_auto", 0, saa7113_addrs);\r\nstk1160_info("driver ver %s successfully loaded\n",\r\nSTK1160_VERSION);\r\nv4l2_device_call_all(&dev->v4l2_dev, 0, core, reset, 0);\r\nv4l2_device_call_all(&dev->v4l2_dev, 0, video, s_stream, 0);\r\nstk1160_reg_reset(dev);\r\nstk1160_select_input(dev);\r\nstk1160_ac97_register(dev);\r\nrc = stk1160_video_register(dev);\r\nif (rc < 0)\r\ngoto unreg_i2c;\r\nreturn 0;\r\nunreg_i2c:\r\nstk1160_i2c_unregister(dev);\r\nunreg_v4l2:\r\nv4l2_device_unregister(&dev->v4l2_dev);\r\nfree_ctrl:\r\nv4l2_ctrl_handler_free(&dev->ctrl_handler);\r\nfree_err:\r\nkfree(alt_max_pkt_size);\r\nkfree(dev);\r\nreturn rc;\r\n}\r\nstatic void stk1160_disconnect(struct usb_interface *interface)\r\n{\r\nstruct stk1160 *dev;\r\ndev = usb_get_intfdata(interface);\r\nusb_set_intfdata(interface, NULL);\r\nmutex_lock(&dev->vb_queue_lock);\r\nmutex_lock(&dev->v4l_lock);\r\nstk1160_uninit_isoc(dev);\r\nstk1160_ac97_unregister(dev);\r\nstk1160_clear_queue(dev);\r\nvideo_unregister_device(&dev->vdev);\r\nv4l2_device_disconnect(&dev->v4l2_dev);\r\ndev->udev = NULL;\r\nmutex_unlock(&dev->v4l_lock);\r\nmutex_unlock(&dev->vb_queue_lock);\r\nv4l2_device_put(&dev->v4l2_dev);\r\n}

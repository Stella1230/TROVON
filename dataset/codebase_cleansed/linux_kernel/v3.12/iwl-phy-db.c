struct iwl_phy_db *iwl_phy_db_init(struct iwl_trans *trans)\r\n{\r\nstruct iwl_phy_db *phy_db = kzalloc(sizeof(struct iwl_phy_db),\r\nGFP_KERNEL);\r\nif (!phy_db)\r\nreturn phy_db;\r\nphy_db->trans = trans;\r\nreturn phy_db;\r\n}\r\nstatic struct iwl_phy_db_entry *\r\niwl_phy_db_get_section(struct iwl_phy_db *phy_db,\r\nenum iwl_phy_db_section_type type,\r\nu16 chg_id)\r\n{\r\nif (!phy_db || type >= IWL_PHY_DB_MAX)\r\nreturn NULL;\r\nswitch (type) {\r\ncase IWL_PHY_DB_CFG:\r\nreturn &phy_db->cfg;\r\ncase IWL_PHY_DB_CALIB_NCH:\r\nreturn &phy_db->calib_nch;\r\ncase IWL_PHY_DB_CALIB_CHG_PAPD:\r\nif (chg_id >= IWL_NUM_PAPD_CH_GROUPS)\r\nreturn NULL;\r\nreturn &phy_db->calib_ch_group_papd[chg_id];\r\ncase IWL_PHY_DB_CALIB_CHG_TXP:\r\nif (chg_id >= IWL_NUM_TXP_CH_GROUPS)\r\nreturn NULL;\r\nreturn &phy_db->calib_ch_group_txp[chg_id];\r\ndefault:\r\nreturn NULL;\r\n}\r\nreturn NULL;\r\n}\r\nstatic void iwl_phy_db_free_section(struct iwl_phy_db *phy_db,\r\nenum iwl_phy_db_section_type type,\r\nu16 chg_id)\r\n{\r\nstruct iwl_phy_db_entry *entry =\r\niwl_phy_db_get_section(phy_db, type, chg_id);\r\nif (!entry)\r\nreturn;\r\nkfree(entry->data);\r\nentry->data = NULL;\r\nentry->size = 0;\r\n}\r\nvoid iwl_phy_db_free(struct iwl_phy_db *phy_db)\r\n{\r\nint i;\r\nif (!phy_db)\r\nreturn;\r\niwl_phy_db_free_section(phy_db, IWL_PHY_DB_CFG, 0);\r\niwl_phy_db_free_section(phy_db, IWL_PHY_DB_CALIB_NCH, 0);\r\nfor (i = 0; i < IWL_NUM_PAPD_CH_GROUPS; i++)\r\niwl_phy_db_free_section(phy_db, IWL_PHY_DB_CALIB_CHG_PAPD, i);\r\nfor (i = 0; i < IWL_NUM_TXP_CH_GROUPS; i++)\r\niwl_phy_db_free_section(phy_db, IWL_PHY_DB_CALIB_CHG_TXP, i);\r\nkfree(phy_db);\r\n}\r\nint iwl_phy_db_set_section(struct iwl_phy_db *phy_db, struct iwl_rx_packet *pkt,\r\ngfp_t alloc_ctx)\r\n{\r\nstruct iwl_calib_res_notif_phy_db *phy_db_notif =\r\n(struct iwl_calib_res_notif_phy_db *)pkt->data;\r\nenum iwl_phy_db_section_type type = le16_to_cpu(phy_db_notif->type);\r\nu16 size = le16_to_cpu(phy_db_notif->length);\r\nstruct iwl_phy_db_entry *entry;\r\nu16 chg_id = 0;\r\nif (!phy_db)\r\nreturn -EINVAL;\r\nif (type == IWL_PHY_DB_CALIB_CHG_PAPD ||\r\ntype == IWL_PHY_DB_CALIB_CHG_TXP)\r\nchg_id = le16_to_cpup((__le16 *)phy_db_notif->data);\r\nentry = iwl_phy_db_get_section(phy_db, type, chg_id);\r\nif (!entry)\r\nreturn -EINVAL;\r\nkfree(entry->data);\r\nentry->data = kmemdup(phy_db_notif->data, size, alloc_ctx);\r\nif (!entry->data) {\r\nentry->size = 0;\r\nreturn -ENOMEM;\r\n}\r\nentry->size = size;\r\nIWL_DEBUG_INFO(phy_db->trans,\r\n"%s(%d): [PHYDB]SET: Type %d , Size: %d\n",\r\n__func__, __LINE__, type, size);\r\nreturn 0;\r\n}\r\nstatic int is_valid_channel(u16 ch_id)\r\n{\r\nif (ch_id <= 14 ||\r\n(36 <= ch_id && ch_id <= 64 && ch_id % 4 == 0) ||\r\n(100 <= ch_id && ch_id <= 140 && ch_id % 4 == 0) ||\r\n(145 <= ch_id && ch_id <= 165 && ch_id % 4 == 1))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic u8 ch_id_to_ch_index(u16 ch_id)\r\n{\r\nif (WARN_ON(!is_valid_channel(ch_id)))\r\nreturn 0xff;\r\nif (ch_id <= 14)\r\nreturn ch_id - 1;\r\nif (ch_id <= 64)\r\nreturn (ch_id + 20) / 4;\r\nif (ch_id <= 140)\r\nreturn (ch_id - 12) / 4;\r\nreturn (ch_id - 13) / 4;\r\n}\r\nstatic u16 channel_id_to_papd(u16 ch_id)\r\n{\r\nif (WARN_ON(!is_valid_channel(ch_id)))\r\nreturn 0xff;\r\nif (1 <= ch_id && ch_id <= 14)\r\nreturn 0;\r\nif (36 <= ch_id && ch_id <= 64)\r\nreturn 1;\r\nif (100 <= ch_id && ch_id <= 140)\r\nreturn 2;\r\nreturn 3;\r\n}\r\nstatic u16 channel_id_to_txp(struct iwl_phy_db *phy_db, u16 ch_id)\r\n{\r\nstruct iwl_phy_db_chg_txp *txp_chg;\r\nint i;\r\nu8 ch_index = ch_id_to_ch_index(ch_id);\r\nif (ch_index == 0xff)\r\nreturn 0xff;\r\nfor (i = 0; i < IWL_NUM_TXP_CH_GROUPS; i++) {\r\ntxp_chg = (void *)phy_db->calib_ch_group_txp[i].data;\r\nif (!txp_chg)\r\nreturn 0xff;\r\nif (le16_to_cpu(txp_chg->max_channel_idx) >= ch_index)\r\nreturn i;\r\n}\r\nreturn 0xff;\r\n}\r\nstatic\r\nint iwl_phy_db_get_section_data(struct iwl_phy_db *phy_db,\r\nu32 type, u8 **data, u16 *size, u16 ch_id)\r\n{\r\nstruct iwl_phy_db_entry *entry;\r\nu16 ch_group_id = 0;\r\nif (!phy_db)\r\nreturn -EINVAL;\r\nif (type == IWL_PHY_DB_CALIB_CHG_PAPD)\r\nch_group_id = channel_id_to_papd(ch_id);\r\nelse if (type == IWL_PHY_DB_CALIB_CHG_TXP)\r\nch_group_id = channel_id_to_txp(phy_db, ch_id);\r\nentry = iwl_phy_db_get_section(phy_db, type, ch_group_id);\r\nif (!entry)\r\nreturn -EINVAL;\r\n*data = entry->data;\r\n*size = entry->size;\r\nIWL_DEBUG_INFO(phy_db->trans,\r\n"%s(%d): [PHYDB] GET: Type %d , Size: %d\n",\r\n__func__, __LINE__, type, *size);\r\nreturn 0;\r\n}\r\nstatic int iwl_send_phy_db_cmd(struct iwl_phy_db *phy_db, u16 type,\r\nu16 length, void *data)\r\n{\r\nstruct iwl_phy_db_cmd phy_db_cmd;\r\nstruct iwl_host_cmd cmd = {\r\n.id = PHY_DB_CMD,\r\n.flags = CMD_SYNC,\r\n};\r\nIWL_DEBUG_INFO(phy_db->trans,\r\n"Sending PHY-DB hcmd of type %d, of length %d\n",\r\ntype, length);\r\nphy_db_cmd.type = cpu_to_le16(type);\r\nphy_db_cmd.length = cpu_to_le16(length);\r\ncmd.data[0] = &phy_db_cmd;\r\ncmd.len[0] = sizeof(struct iwl_phy_db_cmd);\r\ncmd.data[1] = data;\r\ncmd.len[1] = length;\r\ncmd.dataflags[1] = IWL_HCMD_DFL_NOCOPY;\r\nreturn iwl_trans_send_cmd(phy_db->trans, &cmd);\r\n}\r\nstatic int iwl_phy_db_send_all_channel_groups(\r\nstruct iwl_phy_db *phy_db,\r\nenum iwl_phy_db_section_type type,\r\nu8 max_ch_groups)\r\n{\r\nu16 i;\r\nint err;\r\nstruct iwl_phy_db_entry *entry;\r\nfor (i = 0; i < max_ch_groups; i++) {\r\nentry = iwl_phy_db_get_section(phy_db,\r\ntype,\r\ni);\r\nif (!entry)\r\nreturn -EINVAL;\r\nif (WARN_ON_ONCE(!entry->size))\r\ncontinue;\r\nerr = iwl_send_phy_db_cmd(phy_db,\r\ntype,\r\nentry->size,\r\nentry->data);\r\nif (err) {\r\nIWL_ERR(phy_db->trans,\r\n"Can't SEND phy_db section %d (%d), err %d",\r\ntype, i, err);\r\nreturn err;\r\n}\r\nIWL_DEBUG_INFO(phy_db->trans,\r\n"Sent PHY_DB HCMD, type = %d num = %d",\r\ntype, i);\r\n}\r\nreturn 0;\r\n}\r\nint iwl_send_phy_db_data(struct iwl_phy_db *phy_db)\r\n{\r\nu8 *data = NULL;\r\nu16 size = 0;\r\nint err;\r\nIWL_DEBUG_INFO(phy_db->trans,\r\n"Sending phy db data and configuration to runtime image\n");\r\nerr = iwl_phy_db_get_section_data(phy_db, IWL_PHY_DB_CFG,\r\n&data, &size, 0);\r\nif (err) {\r\nIWL_ERR(phy_db->trans, "Cannot get Phy DB cfg section\n");\r\nreturn err;\r\n}\r\nerr = iwl_send_phy_db_cmd(phy_db, IWL_PHY_DB_CFG, size, data);\r\nif (err) {\r\nIWL_ERR(phy_db->trans,\r\n"Cannot send HCMD of Phy DB cfg section\n");\r\nreturn err;\r\n}\r\nerr = iwl_phy_db_get_section_data(phy_db, IWL_PHY_DB_CALIB_NCH,\r\n&data, &size, 0);\r\nif (err) {\r\nIWL_ERR(phy_db->trans,\r\n"Cannot get Phy DB non specific channel section\n");\r\nreturn err;\r\n}\r\nerr = iwl_send_phy_db_cmd(phy_db, IWL_PHY_DB_CALIB_NCH, size, data);\r\nif (err) {\r\nIWL_ERR(phy_db->trans,\r\n"Cannot send HCMD of Phy DB non specific channel section\n");\r\nreturn err;\r\n}\r\nerr = iwl_phy_db_send_all_channel_groups(phy_db,\r\nIWL_PHY_DB_CALIB_CHG_PAPD,\r\nIWL_NUM_PAPD_CH_GROUPS);\r\nif (err) {\r\nIWL_ERR(phy_db->trans,\r\n"Cannot send channel specific PAPD groups");\r\nreturn err;\r\n}\r\nerr = iwl_phy_db_send_all_channel_groups(phy_db,\r\nIWL_PHY_DB_CALIB_CHG_TXP,\r\nIWL_NUM_TXP_CH_GROUPS);\r\nif (err) {\r\nIWL_ERR(phy_db->trans,\r\n"Cannot send channel specific TX power groups");\r\nreturn err;\r\n}\r\nIWL_DEBUG_INFO(phy_db->trans,\r\n"Finished sending phy db non channel data\n");\r\nreturn 0;\r\n}

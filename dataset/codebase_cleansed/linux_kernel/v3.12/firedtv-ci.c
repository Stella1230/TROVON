static int fdtv_ca_ready(struct firedtv_tuner_status *stat)\r\n{\r\nreturn stat->ca_initialization_status == 1 &&\r\nstat->ca_error_flag == 0 &&\r\nstat->ca_dvb_flag == 1 &&\r\nstat->ca_module_present_status == 1;\r\n}\r\nstatic int fdtv_get_ca_flags(struct firedtv_tuner_status *stat)\r\n{\r\nint flags = 0;\r\nif (stat->ca_module_present_status == 1)\r\nflags |= CA_CI_MODULE_PRESENT;\r\nif (stat->ca_initialization_status == 1 &&\r\nstat->ca_error_flag == 0 &&\r\nstat->ca_dvb_flag == 1)\r\nflags |= CA_CI_MODULE_READY;\r\nreturn flags;\r\n}\r\nstatic int fdtv_ca_get_caps(void *arg)\r\n{\r\nstruct ca_caps *cap = arg;\r\ncap->slot_num = 1;\r\ncap->slot_type = CA_CI;\r\ncap->descr_num = 1;\r\ncap->descr_type = CA_ECD;\r\nreturn 0;\r\n}\r\nstatic int fdtv_ca_get_slot_info(struct firedtv *fdtv, void *arg)\r\n{\r\nstruct firedtv_tuner_status stat;\r\nstruct ca_slot_info *slot = arg;\r\nint err;\r\nerr = avc_tuner_status(fdtv, &stat);\r\nif (err)\r\nreturn err;\r\nif (slot->num != 0)\r\nreturn -EACCES;\r\nslot->type = CA_CI;\r\nslot->flags = fdtv_get_ca_flags(&stat);\r\nreturn 0;\r\n}\r\nstatic int fdtv_ca_app_info(struct firedtv *fdtv, void *arg)\r\n{\r\nstruct ca_msg *reply = arg;\r\nreturn avc_ca_app_info(fdtv, reply->msg, &reply->length);\r\n}\r\nstatic int fdtv_ca_info(struct firedtv *fdtv, void *arg)\r\n{\r\nstruct ca_msg *reply = arg;\r\nreturn avc_ca_info(fdtv, reply->msg, &reply->length);\r\n}\r\nstatic int fdtv_ca_get_mmi(struct firedtv *fdtv, void *arg)\r\n{\r\nstruct ca_msg *reply = arg;\r\nreturn avc_ca_get_mmi(fdtv, reply->msg, &reply->length);\r\n}\r\nstatic int fdtv_ca_get_msg(struct firedtv *fdtv, void *arg)\r\n{\r\nstruct firedtv_tuner_status stat;\r\nint err;\r\nswitch (fdtv->ca_last_command) {\r\ncase EN50221_TAG_APP_INFO_ENQUIRY:\r\nerr = fdtv_ca_app_info(fdtv, arg);\r\nbreak;\r\ncase EN50221_TAG_CA_INFO_ENQUIRY:\r\nerr = fdtv_ca_info(fdtv, arg);\r\nbreak;\r\ndefault:\r\nerr = avc_tuner_status(fdtv, &stat);\r\nif (err)\r\nbreak;\r\nif (stat.ca_mmi == 1)\r\nerr = fdtv_ca_get_mmi(fdtv, arg);\r\nelse {\r\ndev_info(fdtv->device, "unhandled CA message 0x%08x\n",\r\nfdtv->ca_last_command);\r\nerr = -EACCES;\r\n}\r\n}\r\nfdtv->ca_last_command = 0;\r\nreturn err;\r\n}\r\nstatic int fdtv_ca_pmt(struct firedtv *fdtv, void *arg)\r\n{\r\nstruct ca_msg *msg = arg;\r\nint data_pos;\r\nint data_length;\r\nint i;\r\ndata_pos = 4;\r\nif (msg->msg[3] & 0x80) {\r\ndata_length = 0;\r\nfor (i = 0; i < (msg->msg[3] & 0x7f); i++)\r\ndata_length = (data_length << 8) + msg->msg[data_pos++];\r\n} else {\r\ndata_length = msg->msg[3];\r\n}\r\nreturn avc_ca_pmt(fdtv, &msg->msg[data_pos], data_length);\r\n}\r\nstatic int fdtv_ca_send_msg(struct firedtv *fdtv, void *arg)\r\n{\r\nstruct ca_msg *msg = arg;\r\nint err;\r\nfdtv->ca_last_command =\r\n(msg->msg[0] << 16) + (msg->msg[1] << 8) + msg->msg[2];\r\nswitch (fdtv->ca_last_command) {\r\ncase EN50221_TAG_CA_PMT:\r\nerr = fdtv_ca_pmt(fdtv, arg);\r\nbreak;\r\ncase EN50221_TAG_APP_INFO_ENQUIRY:\r\nerr = 0;\r\nbreak;\r\ncase EN50221_TAG_CA_INFO_ENQUIRY:\r\nerr = 0;\r\nbreak;\r\ncase EN50221_TAG_ENTER_MENU:\r\nerr = avc_ca_enter_menu(fdtv);\r\nbreak;\r\ndefault:\r\ndev_err(fdtv->device, "unhandled CA message 0x%08x\n",\r\nfdtv->ca_last_command);\r\nerr = -EACCES;\r\n}\r\nreturn err;\r\n}\r\nstatic int fdtv_ca_ioctl(struct file *file, unsigned int cmd, void *arg)\r\n{\r\nstruct dvb_device *dvbdev = file->private_data;\r\nstruct firedtv *fdtv = dvbdev->priv;\r\nstruct firedtv_tuner_status stat;\r\nint err;\r\nswitch (cmd) {\r\ncase CA_RESET:\r\nerr = avc_ca_reset(fdtv);\r\nbreak;\r\ncase CA_GET_CAP:\r\nerr = fdtv_ca_get_caps(arg);\r\nbreak;\r\ncase CA_GET_SLOT_INFO:\r\nerr = fdtv_ca_get_slot_info(fdtv, arg);\r\nbreak;\r\ncase CA_GET_MSG:\r\nerr = fdtv_ca_get_msg(fdtv, arg);\r\nbreak;\r\ncase CA_SEND_MSG:\r\nerr = fdtv_ca_send_msg(fdtv, arg);\r\nbreak;\r\ndefault:\r\ndev_info(fdtv->device, "unhandled CA ioctl %u\n", cmd);\r\nerr = -EOPNOTSUPP;\r\n}\r\navc_tuner_status(fdtv, &stat);\r\nreturn err;\r\n}\r\nstatic unsigned int fdtv_ca_io_poll(struct file *file, poll_table *wait)\r\n{\r\nreturn POLLIN;\r\n}\r\nint fdtv_ca_register(struct firedtv *fdtv)\r\n{\r\nstruct firedtv_tuner_status stat;\r\nint err;\r\nif (avc_tuner_status(fdtv, &stat))\r\nreturn -EINVAL;\r\nif (!fdtv_ca_ready(&stat))\r\nreturn -EFAULT;\r\nerr = dvb_register_device(&fdtv->adapter, &fdtv->cadev,\r\n&fdtv_ca, fdtv, DVB_DEVICE_CA);\r\nif (stat.ca_application_info == 0)\r\ndev_err(fdtv->device, "CaApplicationInfo is not set\n");\r\nif (stat.ca_date_time_request == 1)\r\navc_ca_get_time_date(fdtv, &fdtv->ca_time_interval);\r\nreturn err;\r\n}\r\nvoid fdtv_ca_release(struct firedtv *fdtv)\r\n{\r\nif (fdtv->cadev)\r\ndvb_unregister_device(fdtv->cadev);\r\n}

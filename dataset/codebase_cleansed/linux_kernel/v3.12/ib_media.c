static void ib_media_addr_set(const struct tipc_bearer *tb_ptr,\r\nstruct tipc_media_addr *a, char *mac)\r\n{\r\nBUILD_BUG_ON(sizeof(a->value) < INFINIBAND_ALEN);\r\nmemcpy(a->value, mac, INFINIBAND_ALEN);\r\na->media_id = TIPC_MEDIA_TYPE_IB;\r\na->broadcast = !memcmp(mac, tb_ptr->bcast_addr.value, INFINIBAND_ALEN);\r\n}\r\nstatic int send_msg(struct sk_buff *buf, struct tipc_bearer *tb_ptr,\r\nstruct tipc_media_addr *dest)\r\n{\r\nstruct sk_buff *clone;\r\nstruct net_device *dev;\r\nint delta;\r\nclone = skb_clone(buf, GFP_ATOMIC);\r\nif (!clone)\r\nreturn 0;\r\ndev = ((struct ib_bearer *)(tb_ptr->usr_handle))->dev;\r\ndelta = dev->hard_header_len - skb_headroom(buf);\r\nif ((delta > 0) &&\r\npskb_expand_head(clone, SKB_DATA_ALIGN(delta), 0, GFP_ATOMIC)) {\r\nkfree_skb(clone);\r\nreturn 0;\r\n}\r\nskb_reset_network_header(clone);\r\nclone->dev = dev;\r\nclone->protocol = htons(ETH_P_TIPC);\r\ndev_hard_header(clone, dev, ETH_P_TIPC, dest->value,\r\ndev->dev_addr, clone->len);\r\ndev_queue_xmit(clone);\r\nreturn 0;\r\n}\r\nstatic int recv_msg(struct sk_buff *buf, struct net_device *dev,\r\nstruct packet_type *pt, struct net_device *orig_dev)\r\n{\r\nstruct ib_bearer *ib_ptr = (struct ib_bearer *)pt->af_packet_priv;\r\nif (!net_eq(dev_net(dev), &init_net)) {\r\nkfree_skb(buf);\r\nreturn 0;\r\n}\r\nif (likely(ib_ptr->bearer)) {\r\nif (likely(buf->pkt_type <= PACKET_BROADCAST)) {\r\nbuf->next = NULL;\r\ntipc_recv_msg(buf, ib_ptr->bearer);\r\nreturn 0;\r\n}\r\n}\r\nkfree_skb(buf);\r\nreturn 0;\r\n}\r\nstatic void setup_bearer(struct work_struct *work)\r\n{\r\nstruct ib_bearer *ib_ptr =\r\ncontainer_of(work, struct ib_bearer, setup);\r\ndev_add_pack(&ib_ptr->tipc_packet_type);\r\n}\r\nstatic int enable_bearer(struct tipc_bearer *tb_ptr)\r\n{\r\nstruct net_device *dev;\r\nstruct ib_bearer *ib_ptr = &ib_bearers[0];\r\nstruct ib_bearer *stop = &ib_bearers[MAX_IB_BEARERS];\r\nchar *driver_name = strchr((const char *)tb_ptr->name, ':') + 1;\r\nint pending_dev = 0;\r\nwhile (ib_ptr->dev) {\r\nif (!ib_ptr->bearer)\r\npending_dev++;\r\nif (++ib_ptr == stop)\r\nreturn pending_dev ? -EAGAIN : -EDQUOT;\r\n}\r\ndev = dev_get_by_name(&init_net, driver_name);\r\nif (!dev)\r\nreturn -ENODEV;\r\nib_ptr->dev = dev;\r\nib_ptr->tipc_packet_type.type = htons(ETH_P_TIPC);\r\nib_ptr->tipc_packet_type.dev = dev;\r\nib_ptr->tipc_packet_type.func = recv_msg;\r\nib_ptr->tipc_packet_type.af_packet_priv = ib_ptr;\r\nINIT_LIST_HEAD(&(ib_ptr->tipc_packet_type.list));\r\nINIT_WORK(&ib_ptr->setup, setup_bearer);\r\nschedule_work(&ib_ptr->setup);\r\nib_ptr->bearer = tb_ptr;\r\ntb_ptr->usr_handle = (void *)ib_ptr;\r\nmemset(tb_ptr->bcast_addr.value, 0, sizeof(tb_ptr->bcast_addr.value));\r\nmemcpy(tb_ptr->bcast_addr.value, dev->broadcast, INFINIBAND_ALEN);\r\ntb_ptr->bcast_addr.media_id = TIPC_MEDIA_TYPE_IB;\r\ntb_ptr->bcast_addr.broadcast = 1;\r\ntb_ptr->mtu = dev->mtu;\r\ntb_ptr->blocked = 0;\r\nib_media_addr_set(tb_ptr, &tb_ptr->addr, (char *)dev->dev_addr);\r\nreturn 0;\r\n}\r\nstatic void cleanup_bearer(struct work_struct *work)\r\n{\r\nstruct ib_bearer *ib_ptr =\r\ncontainer_of(work, struct ib_bearer, cleanup);\r\ndev_remove_pack(&ib_ptr->tipc_packet_type);\r\ndev_put(ib_ptr->dev);\r\nib_ptr->dev = NULL;\r\n}\r\nstatic void disable_bearer(struct tipc_bearer *tb_ptr)\r\n{\r\nstruct ib_bearer *ib_ptr = (struct ib_bearer *)tb_ptr->usr_handle;\r\nib_ptr->bearer = NULL;\r\nINIT_WORK(&ib_ptr->cleanup, cleanup_bearer);\r\nschedule_work(&ib_ptr->cleanup);\r\n}\r\nstatic int recv_notification(struct notifier_block *nb, unsigned long evt,\r\nvoid *ptr)\r\n{\r\nstruct net_device *dev = netdev_notifier_info_to_dev(ptr);\r\nstruct ib_bearer *ib_ptr = &ib_bearers[0];\r\nstruct ib_bearer *stop = &ib_bearers[MAX_IB_BEARERS];\r\nif (!net_eq(dev_net(dev), &init_net))\r\nreturn NOTIFY_DONE;\r\nwhile ((ib_ptr->dev != dev)) {\r\nif (++ib_ptr == stop)\r\nreturn NOTIFY_DONE;\r\n}\r\nif (!ib_ptr->bearer)\r\nreturn NOTIFY_DONE;\r\nib_ptr->bearer->mtu = dev->mtu;\r\nswitch (evt) {\r\ncase NETDEV_CHANGE:\r\nif (netif_carrier_ok(dev))\r\ntipc_continue(ib_ptr->bearer);\r\nelse\r\ntipc_block_bearer(ib_ptr->bearer->name);\r\nbreak;\r\ncase NETDEV_UP:\r\ntipc_continue(ib_ptr->bearer);\r\nbreak;\r\ncase NETDEV_DOWN:\r\ntipc_block_bearer(ib_ptr->bearer->name);\r\nbreak;\r\ncase NETDEV_CHANGEMTU:\r\ncase NETDEV_CHANGEADDR:\r\ntipc_block_bearer(ib_ptr->bearer->name);\r\ntipc_continue(ib_ptr->bearer);\r\nbreak;\r\ncase NETDEV_UNREGISTER:\r\ncase NETDEV_CHANGENAME:\r\ntipc_disable_bearer(ib_ptr->bearer->name);\r\nbreak;\r\n}\r\nreturn NOTIFY_OK;\r\n}\r\nstatic int ib_addr2str(struct tipc_media_addr *a, char *str_buf, int str_size)\r\n{\r\nif (str_size < 60)\r\nreturn 1;\r\nsprintf(str_buf, "%20phC", a->value);\r\nreturn 0;\r\n}\r\nstatic int ib_addr2msg(struct tipc_media_addr *a, char *msg_area)\r\n{\r\nmemset(msg_area, 0, TIPC_MEDIA_ADDR_SIZE);\r\nmsg_area[TIPC_MEDIA_TYPE_OFFSET] = TIPC_MEDIA_TYPE_IB;\r\nmemcpy(msg_area, a->value, INFINIBAND_ALEN);\r\nreturn 0;\r\n}\r\nstatic int ib_msg2addr(const struct tipc_bearer *tb_ptr,\r\nstruct tipc_media_addr *a, char *msg_area)\r\n{\r\nib_media_addr_set(tb_ptr, a, msg_area);\r\nreturn 0;\r\n}\r\nint tipc_ib_media_start(void)\r\n{\r\nint res;\r\nif (ib_started)\r\nreturn -EINVAL;\r\nres = tipc_register_media(&ib_media_info);\r\nif (res)\r\nreturn res;\r\nres = register_netdevice_notifier(&notifier);\r\nif (!res)\r\nib_started = 1;\r\nreturn res;\r\n}\r\nvoid tipc_ib_media_stop(void)\r\n{\r\nif (!ib_started)\r\nreturn;\r\nflush_scheduled_work();\r\nunregister_netdevice_notifier(&notifier);\r\nib_started = 0;\r\n}

static int dvb_buf_setup(struct videobuf_queue *q,\r\nunsigned int *count, unsigned int *size)\r\n{\r\nstruct cx8802_dev *dev = q->priv_data;\r\ndev->ts_packet_size = 188 * 4;\r\ndev->ts_packet_count = dvb_buf_tscnt;\r\n*size = dev->ts_packet_size * dev->ts_packet_count;\r\n*count = dvb_buf_tscnt;\r\nreturn 0;\r\n}\r\nstatic int dvb_buf_prepare(struct videobuf_queue *q,\r\nstruct videobuf_buffer *vb, enum v4l2_field field)\r\n{\r\nstruct cx8802_dev *dev = q->priv_data;\r\nreturn cx8802_buf_prepare(q, dev, (struct cx88_buffer*)vb,field);\r\n}\r\nstatic void dvb_buf_queue(struct videobuf_queue *q, struct videobuf_buffer *vb)\r\n{\r\nstruct cx8802_dev *dev = q->priv_data;\r\ncx8802_buf_queue(dev, (struct cx88_buffer*)vb);\r\n}\r\nstatic void dvb_buf_release(struct videobuf_queue *q,\r\nstruct videobuf_buffer *vb)\r\n{\r\ncx88_free_buffer(q, (struct cx88_buffer*)vb);\r\n}\r\nstatic int cx88_dvb_bus_ctrl(struct dvb_frontend* fe, int acquire)\r\n{\r\nstruct cx8802_dev *dev= fe->dvb->priv;\r\nstruct cx8802_driver *drv = NULL;\r\nint ret = 0;\r\nint fe_id;\r\nfe_id = videobuf_dvb_find_frontend(&dev->frontends, fe);\r\nif (!fe_id) {\r\nprintk(KERN_ERR "%s() No frontend found\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nmutex_lock(&dev->core->lock);\r\ndrv = cx8802_get_driver(dev, CX88_MPEG_DVB);\r\nif (drv) {\r\nif (acquire){\r\ndev->frontends.active_fe_id = fe_id;\r\nret = drv->request_acquire(drv);\r\n} else {\r\nret = drv->request_release(drv);\r\ndev->frontends.active_fe_id = 0;\r\n}\r\n}\r\nmutex_unlock(&dev->core->lock);\r\nreturn ret;\r\n}\r\nstatic void cx88_dvb_gate_ctrl(struct cx88_core *core, int open)\r\n{\r\nstruct videobuf_dvb_frontends *f;\r\nstruct videobuf_dvb_frontend *fe;\r\nif (!core->dvbdev)\r\nreturn;\r\nf = &core->dvbdev->frontends;\r\nif (!f)\r\nreturn;\r\nif (f->gate <= 1)\r\nfe = videobuf_dvb_get_frontend(f, 1);\r\nelse\r\nfe = videobuf_dvb_get_frontend(f, f->gate);\r\nif (fe && fe->dvb.frontend && fe->dvb.frontend->ops.i2c_gate_ctrl)\r\nfe->dvb.frontend->ops.i2c_gate_ctrl(fe->dvb.frontend, open);\r\n}\r\nstatic int dvico_fusionhdtv_demod_init(struct dvb_frontend* fe)\r\n{\r\nstatic const u8 clock_config [] = { CLOCK_CTL, 0x38, 0x39 };\r\nstatic const u8 reset [] = { RESET, 0x80 };\r\nstatic const u8 adc_ctl_1_cfg [] = { ADC_CTL_1, 0x40 };\r\nstatic const u8 agc_cfg [] = { AGC_TARGET, 0x24, 0x20 };\r\nstatic const u8 gpp_ctl_cfg [] = { GPP_CTL, 0x33 };\r\nstatic const u8 capt_range_cfg[] = { CAPT_RANGE, 0x32 };\r\nmt352_write(fe, clock_config, sizeof(clock_config));\r\nudelay(200);\r\nmt352_write(fe, reset, sizeof(reset));\r\nmt352_write(fe, adc_ctl_1_cfg, sizeof(adc_ctl_1_cfg));\r\nmt352_write(fe, agc_cfg, sizeof(agc_cfg));\r\nmt352_write(fe, gpp_ctl_cfg, sizeof(gpp_ctl_cfg));\r\nmt352_write(fe, capt_range_cfg, sizeof(capt_range_cfg));\r\nreturn 0;\r\n}\r\nstatic int dvico_dual_demod_init(struct dvb_frontend *fe)\r\n{\r\nstatic const u8 clock_config [] = { CLOCK_CTL, 0x38, 0x38 };\r\nstatic const u8 reset [] = { RESET, 0x80 };\r\nstatic const u8 adc_ctl_1_cfg [] = { ADC_CTL_1, 0x40 };\r\nstatic const u8 agc_cfg [] = { AGC_TARGET, 0x28, 0x20 };\r\nstatic const u8 gpp_ctl_cfg [] = { GPP_CTL, 0x33 };\r\nstatic const u8 capt_range_cfg[] = { CAPT_RANGE, 0x32 };\r\nmt352_write(fe, clock_config, sizeof(clock_config));\r\nudelay(200);\r\nmt352_write(fe, reset, sizeof(reset));\r\nmt352_write(fe, adc_ctl_1_cfg, sizeof(adc_ctl_1_cfg));\r\nmt352_write(fe, agc_cfg, sizeof(agc_cfg));\r\nmt352_write(fe, gpp_ctl_cfg, sizeof(gpp_ctl_cfg));\r\nmt352_write(fe, capt_range_cfg, sizeof(capt_range_cfg));\r\nreturn 0;\r\n}\r\nstatic int dntv_live_dvbt_demod_init(struct dvb_frontend* fe)\r\n{\r\nstatic const u8 clock_config [] = { 0x89, 0x38, 0x39 };\r\nstatic const u8 reset [] = { 0x50, 0x80 };\r\nstatic const u8 adc_ctl_1_cfg [] = { 0x8E, 0x40 };\r\nstatic const u8 agc_cfg [] = { 0x67, 0x10, 0x23, 0x00, 0xFF, 0xFF,\r\n0x00, 0xFF, 0x00, 0x40, 0x40 };\r\nstatic const u8 dntv_extra[] = { 0xB5, 0x7A };\r\nstatic const u8 capt_range_cfg[] = { 0x75, 0x32 };\r\nmt352_write(fe, clock_config, sizeof(clock_config));\r\nudelay(2000);\r\nmt352_write(fe, reset, sizeof(reset));\r\nmt352_write(fe, adc_ctl_1_cfg, sizeof(adc_ctl_1_cfg));\r\nmt352_write(fe, agc_cfg, sizeof(agc_cfg));\r\nudelay(2000);\r\nmt352_write(fe, dntv_extra, sizeof(dntv_extra));\r\nmt352_write(fe, capt_range_cfg, sizeof(capt_range_cfg));\r\nreturn 0;\r\n}\r\nstatic int dntv_live_dvbt_pro_demod_init(struct dvb_frontend* fe)\r\n{\r\nstatic const u8 clock_config [] = { 0x89, 0x38, 0x38 };\r\nstatic const u8 reset [] = { 0x50, 0x80 };\r\nstatic const u8 adc_ctl_1_cfg [] = { 0x8E, 0x40 };\r\nstatic const u8 agc_cfg [] = { 0x67, 0x10, 0x20, 0x00, 0xFF, 0xFF,\r\n0x00, 0xFF, 0x00, 0x40, 0x40 };\r\nstatic const u8 dntv_extra[] = { 0xB5, 0x7A };\r\nstatic const u8 capt_range_cfg[] = { 0x75, 0x32 };\r\nmt352_write(fe, clock_config, sizeof(clock_config));\r\nudelay(2000);\r\nmt352_write(fe, reset, sizeof(reset));\r\nmt352_write(fe, adc_ctl_1_cfg, sizeof(adc_ctl_1_cfg));\r\nmt352_write(fe, agc_cfg, sizeof(agc_cfg));\r\nudelay(2000);\r\nmt352_write(fe, dntv_extra, sizeof(dntv_extra));\r\nmt352_write(fe, capt_range_cfg, sizeof(capt_range_cfg));\r\nreturn 0;\r\n}\r\nstatic int or51132_set_ts_param(struct dvb_frontend* fe, int is_punctured)\r\n{\r\nstruct cx8802_dev *dev= fe->dvb->priv;\r\ndev->ts_gen_cntrl = is_punctured ? 0x04 : 0x00;\r\nreturn 0;\r\n}\r\nstatic int lgdt330x_pll_rf_set(struct dvb_frontend* fe, int index)\r\n{\r\nstruct cx8802_dev *dev= fe->dvb->priv;\r\nstruct cx88_core *core = dev->core;\r\ndprintk(1, "%s: index = %d\n", __func__, index);\r\nif (index == 0)\r\ncx_clear(MO_GP0_IO, 8);\r\nelse\r\ncx_set(MO_GP0_IO, 8);\r\nreturn 0;\r\n}\r\nstatic int lgdt330x_set_ts_param(struct dvb_frontend* fe, int is_punctured)\r\n{\r\nstruct cx8802_dev *dev= fe->dvb->priv;\r\nif (is_punctured)\r\ndev->ts_gen_cntrl |= 0x04;\r\nelse\r\ndev->ts_gen_cntrl &= ~0x04;\r\nreturn 0;\r\n}\r\nstatic int nxt200x_set_ts_param(struct dvb_frontend* fe, int is_punctured)\r\n{\r\nstruct cx8802_dev *dev= fe->dvb->priv;\r\ndev->ts_gen_cntrl = is_punctured ? 0x04 : 0x00;\r\nreturn 0;\r\n}\r\nstatic int cx24123_set_ts_param(struct dvb_frontend* fe,\r\nint is_punctured)\r\n{\r\nstruct cx8802_dev *dev= fe->dvb->priv;\r\ndev->ts_gen_cntrl = 0x02;\r\nreturn 0;\r\n}\r\nstatic int kworld_dvbs_100_set_voltage(struct dvb_frontend* fe,\r\nfe_sec_voltage_t voltage)\r\n{\r\nstruct cx8802_dev *dev= fe->dvb->priv;\r\nstruct cx88_core *core = dev->core;\r\nif (voltage == SEC_VOLTAGE_OFF)\r\ncx_write(MO_GP0_IO, 0x000006fb);\r\nelse\r\ncx_write(MO_GP0_IO, 0x000006f9);\r\nif (core->prev_set_voltage)\r\nreturn core->prev_set_voltage(fe, voltage);\r\nreturn 0;\r\n}\r\nstatic int geniatech_dvbs_set_voltage(struct dvb_frontend *fe,\r\nfe_sec_voltage_t voltage)\r\n{\r\nstruct cx8802_dev *dev= fe->dvb->priv;\r\nstruct cx88_core *core = dev->core;\r\nif (voltage == SEC_VOLTAGE_OFF) {\r\ndprintk(1,"LNB Voltage OFF\n");\r\ncx_write(MO_GP0_IO, 0x0000efff);\r\n}\r\nif (core->prev_set_voltage)\r\nreturn core->prev_set_voltage(fe, voltage);\r\nreturn 0;\r\n}\r\nstatic int tevii_dvbs_set_voltage(struct dvb_frontend *fe,\r\nfe_sec_voltage_t voltage)\r\n{\r\nstruct cx8802_dev *dev= fe->dvb->priv;\r\nstruct cx88_core *core = dev->core;\r\ncx_set(MO_GP0_IO, 0x6040);\r\nswitch (voltage) {\r\ncase SEC_VOLTAGE_13:\r\ncx_clear(MO_GP0_IO, 0x20);\r\nbreak;\r\ncase SEC_VOLTAGE_18:\r\ncx_set(MO_GP0_IO, 0x20);\r\nbreak;\r\ncase SEC_VOLTAGE_OFF:\r\ncx_clear(MO_GP0_IO, 0x20);\r\nbreak;\r\n}\r\nif (core->prev_set_voltage)\r\nreturn core->prev_set_voltage(fe, voltage);\r\nreturn 0;\r\n}\r\nstatic int vp1027_set_voltage(struct dvb_frontend *fe,\r\nfe_sec_voltage_t voltage)\r\n{\r\nstruct cx8802_dev *dev = fe->dvb->priv;\r\nstruct cx88_core *core = dev->core;\r\nswitch (voltage) {\r\ncase SEC_VOLTAGE_13:\r\ndprintk(1, "LNB SEC Voltage=13\n");\r\ncx_write(MO_GP0_IO, 0x00001220);\r\nbreak;\r\ncase SEC_VOLTAGE_18:\r\ndprintk(1, "LNB SEC Voltage=18\n");\r\ncx_write(MO_GP0_IO, 0x00001222);\r\nbreak;\r\ncase SEC_VOLTAGE_OFF:\r\ndprintk(1, "LNB Voltage OFF\n");\r\ncx_write(MO_GP0_IO, 0x00001230);\r\nbreak;\r\n}\r\nif (core->prev_set_voltage)\r\nreturn core->prev_set_voltage(fe, voltage);\r\nreturn 0;\r\n}\r\nstatic int attach_xc3028(u8 addr, struct cx8802_dev *dev)\r\n{\r\nstruct dvb_frontend *fe;\r\nstruct videobuf_dvb_frontend *fe0 = NULL;\r\nstruct xc2028_ctrl ctl;\r\nstruct xc2028_config cfg = {\r\n.i2c_adap = &dev->core->i2c_adap,\r\n.i2c_addr = addr,\r\n.ctrl = &ctl,\r\n};\r\nfe0 = videobuf_dvb_get_frontend(&dev->frontends, 1);\r\nif (!fe0)\r\nreturn -EINVAL;\r\nif (!fe0->dvb.frontend) {\r\nprintk(KERN_ERR "%s/2: dvb frontend not attached. "\r\n"Can't attach xc3028\n",\r\ndev->core->name);\r\nreturn -EINVAL;\r\n}\r\ncx88_setup_xc3028(dev->core, &ctl);\r\nfe = dvb_attach(xc2028_attach, fe0->dvb.frontend, &cfg);\r\nif (!fe) {\r\nprintk(KERN_ERR "%s/2: xc3028 attach failed\n",\r\ndev->core->name);\r\ndvb_frontend_detach(fe0->dvb.frontend);\r\ndvb_unregister_frontend(fe0->dvb.frontend);\r\nfe0->dvb.frontend = NULL;\r\nreturn -EINVAL;\r\n}\r\nprintk(KERN_INFO "%s/2: xc3028 attached\n",\r\ndev->core->name);\r\nreturn 0;\r\n}\r\nstatic int attach_xc4000(struct cx8802_dev *dev, struct xc4000_config *cfg)\r\n{\r\nstruct dvb_frontend *fe;\r\nstruct videobuf_dvb_frontend *fe0 = NULL;\r\nfe0 = videobuf_dvb_get_frontend(&dev->frontends, 1);\r\nif (!fe0)\r\nreturn -EINVAL;\r\nif (!fe0->dvb.frontend) {\r\nprintk(KERN_ERR "%s/2: dvb frontend not attached. "\r\n"Can't attach xc4000\n",\r\ndev->core->name);\r\nreturn -EINVAL;\r\n}\r\nfe = dvb_attach(xc4000_attach, fe0->dvb.frontend, &dev->core->i2c_adap,\r\ncfg);\r\nif (!fe) {\r\nprintk(KERN_ERR "%s/2: xc4000 attach failed\n",\r\ndev->core->name);\r\ndvb_frontend_detach(fe0->dvb.frontend);\r\ndvb_unregister_frontend(fe0->dvb.frontend);\r\nfe0->dvb.frontend = NULL;\r\nreturn -EINVAL;\r\n}\r\nprintk(KERN_INFO "%s/2: xc4000 attached\n", dev->core->name);\r\nreturn 0;\r\n}\r\nstatic int cx24116_set_ts_param(struct dvb_frontend *fe,\r\nint is_punctured)\r\n{\r\nstruct cx8802_dev *dev = fe->dvb->priv;\r\ndev->ts_gen_cntrl = 0x2;\r\nreturn 0;\r\n}\r\nstatic int stv0900_set_ts_param(struct dvb_frontend *fe,\r\nint is_punctured)\r\n{\r\nstruct cx8802_dev *dev = fe->dvb->priv;\r\ndev->ts_gen_cntrl = 0;\r\nreturn 0;\r\n}\r\nstatic int cx24116_reset_device(struct dvb_frontend *fe)\r\n{\r\nstruct cx8802_dev *dev = fe->dvb->priv;\r\nstruct cx88_core *core = dev->core;\r\ncx_write(MO_SRST_IO, 0);\r\nmsleep(10);\r\ncx_write(MO_SRST_IO, 1);\r\nmsleep(10);\r\nreturn 0;\r\n}\r\nstatic int ds3000_set_ts_param(struct dvb_frontend *fe,\r\nint is_punctured)\r\n{\r\nstruct cx8802_dev *dev = fe->dvb->priv;\r\ndev->ts_gen_cntrl = 4;\r\nreturn 0;\r\n}\r\nstatic int cx8802_alloc_frontends(struct cx8802_dev *dev)\r\n{\r\nstruct cx88_core *core = dev->core;\r\nstruct videobuf_dvb_frontend *fe = NULL;\r\nint i;\r\nmutex_init(&dev->frontends.lock);\r\nINIT_LIST_HEAD(&dev->frontends.felist);\r\nif (!core->board.num_frontends)\r\nreturn -ENODEV;\r\nprintk(KERN_INFO "%s() allocating %d frontend(s)\n", __func__,\r\ncore->board.num_frontends);\r\nfor (i = 1; i <= core->board.num_frontends; i++) {\r\nfe = videobuf_dvb_alloc_frontend(&dev->frontends, i);\r\nif (!fe) {\r\nprintk(KERN_ERR "%s() failed to alloc\n", __func__);\r\nvideobuf_dvb_dealloc_frontends(&dev->frontends);\r\nreturn -ENOMEM;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int samsung_smt_7020_tuner_set_params(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *c = &fe->dtv_property_cache;\r\nstruct cx8802_dev *dev = fe->dvb->priv;\r\nu8 buf[4];\r\nu32 div;\r\nstruct i2c_msg msg = {\r\n.addr = 0x61,\r\n.flags = 0,\r\n.buf = buf,\r\n.len = sizeof(buf) };\r\ndiv = c->frequency / 125;\r\nbuf[0] = (div >> 8) & 0x7f;\r\nbuf[1] = div & 0xff;\r\nbuf[2] = 0x84;\r\nbuf[3] = 0x00;\r\nif (c->frequency < 1500000)\r\nbuf[3] |= 0x10;\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 1);\r\nif (i2c_transfer(&dev->core->i2c_adap, &msg, 1) != 1)\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic int samsung_smt_7020_set_tone(struct dvb_frontend *fe,\r\nfe_sec_tone_mode_t tone)\r\n{\r\nstruct cx8802_dev *dev = fe->dvb->priv;\r\nstruct cx88_core *core = dev->core;\r\ncx_set(MO_GP0_IO, 0x0800);\r\nswitch (tone) {\r\ncase SEC_TONE_ON:\r\ncx_set(MO_GP0_IO, 0x08);\r\nbreak;\r\ncase SEC_TONE_OFF:\r\ncx_clear(MO_GP0_IO, 0x08);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int samsung_smt_7020_set_voltage(struct dvb_frontend *fe,\r\nfe_sec_voltage_t voltage)\r\n{\r\nstruct cx8802_dev *dev = fe->dvb->priv;\r\nstruct cx88_core *core = dev->core;\r\nu8 data;\r\nstruct i2c_msg msg = {\r\n.addr = 8,\r\n.flags = 0,\r\n.buf = &data,\r\n.len = sizeof(data) };\r\ncx_set(MO_GP0_IO, 0x8000);\r\nswitch (voltage) {\r\ncase SEC_VOLTAGE_OFF:\r\nbreak;\r\ncase SEC_VOLTAGE_13:\r\ndata = ISL6421_EN1 | ISL6421_LLC1;\r\ncx_clear(MO_GP0_IO, 0x80);\r\nbreak;\r\ncase SEC_VOLTAGE_18:\r\ndata = ISL6421_EN1 | ISL6421_LLC1 | ISL6421_VSEL1;\r\ncx_clear(MO_GP0_IO, 0x80);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn (i2c_transfer(&dev->core->i2c_adap, &msg, 1) == 1) ? 0 : -EIO;\r\n}\r\nstatic int samsung_smt_7020_stv0299_set_symbol_rate(struct dvb_frontend *fe,\r\nu32 srate, u32 ratio)\r\n{\r\nu8 aclk = 0;\r\nu8 bclk = 0;\r\nif (srate < 1500000) {\r\naclk = 0xb7;\r\nbclk = 0x47;\r\n} else if (srate < 3000000) {\r\naclk = 0xb7;\r\nbclk = 0x4b;\r\n} else if (srate < 7000000) {\r\naclk = 0xb7;\r\nbclk = 0x4f;\r\n} else if (srate < 14000000) {\r\naclk = 0xb7;\r\nbclk = 0x53;\r\n} else if (srate < 30000000) {\r\naclk = 0xb6;\r\nbclk = 0x53;\r\n} else if (srate < 45000000) {\r\naclk = 0xb4;\r\nbclk = 0x51;\r\n}\r\nstv0299_writereg(fe, 0x13, aclk);\r\nstv0299_writereg(fe, 0x14, bclk);\r\nstv0299_writereg(fe, 0x1f, (ratio >> 16) & 0xff);\r\nstv0299_writereg(fe, 0x20, (ratio >> 8) & 0xff);\r\nstv0299_writereg(fe, 0x21, ratio & 0xf0);\r\nreturn 0;\r\n}\r\nstatic int dvb_register(struct cx8802_dev *dev)\r\n{\r\nstruct cx88_core *core = dev->core;\r\nstruct videobuf_dvb_frontend *fe0, *fe1 = NULL;\r\nint mfe_shared = 0;\r\nint res = -EINVAL;\r\nif (0 != core->i2c_rc) {\r\nprintk(KERN_ERR "%s/2: no i2c-bus available, cannot attach dvb drivers\n", core->name);\r\ngoto frontend_detach;\r\n}\r\nfe0 = videobuf_dvb_get_frontend(&dev->frontends, 1);\r\nif (!fe0)\r\ngoto frontend_detach;\r\ndev->frontends.gate = 0;\r\ncore->gate_ctrl = cx88_dvb_gate_ctrl;\r\nswitch (core->boardnr) {\r\ncase CX88_BOARD_HAUPPAUGE_DVB_T1:\r\nfe0->dvb.frontend = dvb_attach(cx22702_attach,\r\n&connexant_refboard_config,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nif (!dvb_attach(dvb_pll_attach, fe0->dvb.frontend,\r\n0x61, &core->i2c_adap,\r\nDVB_PLL_THOMSON_DTT759X))\r\ngoto frontend_detach;\r\n}\r\nbreak;\r\ncase CX88_BOARD_TERRATEC_CINERGY_1400_DVB_T1:\r\ncase CX88_BOARD_CONEXANT_DVB_T1:\r\ncase CX88_BOARD_KWORLD_DVB_T_CX22702:\r\ncase CX88_BOARD_WINFAST_DTV1000:\r\nfe0->dvb.frontend = dvb_attach(cx22702_attach,\r\n&connexant_refboard_config,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nif (!dvb_attach(dvb_pll_attach, fe0->dvb.frontend,\r\n0x60, &core->i2c_adap,\r\nDVB_PLL_THOMSON_DTT7579))\r\ngoto frontend_detach;\r\n}\r\nbreak;\r\ncase CX88_BOARD_WINFAST_DTV2000H:\r\ncase CX88_BOARD_HAUPPAUGE_HVR1100:\r\ncase CX88_BOARD_HAUPPAUGE_HVR1100LP:\r\ncase CX88_BOARD_HAUPPAUGE_HVR1300:\r\nfe0->dvb.frontend = dvb_attach(cx22702_attach,\r\n&hauppauge_hvr_config,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nif (!dvb_attach(simple_tuner_attach, fe0->dvb.frontend,\r\n&core->i2c_adap, 0x61,\r\nTUNER_PHILIPS_FMD1216ME_MK3))\r\ngoto frontend_detach;\r\n}\r\nbreak;\r\ncase CX88_BOARD_WINFAST_DTV2000H_J:\r\nfe0->dvb.frontend = dvb_attach(cx22702_attach,\r\n&hauppauge_hvr_config,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nif (!dvb_attach(simple_tuner_attach, fe0->dvb.frontend,\r\n&core->i2c_adap, 0x61,\r\nTUNER_PHILIPS_FMD1216MEX_MK3))\r\ngoto frontend_detach;\r\n}\r\nbreak;\r\ncase CX88_BOARD_HAUPPAUGE_HVR3000:\r\nmfe_shared = 1;\r\ndev->frontends.gate = 2;\r\nfe0->dvb.frontend = dvb_attach(cx24123_attach,\r\n&hauppauge_novas_config,\r\n&dev->core->i2c_adap);\r\nif (fe0->dvb.frontend) {\r\nif (!dvb_attach(isl6421_attach,\r\nfe0->dvb.frontend,\r\n&dev->core->i2c_adap,\r\n0x08, ISL6421_DCL, 0x00, false))\r\ngoto frontend_detach;\r\n}\r\nfe1 = videobuf_dvb_get_frontend(&dev->frontends, 2);\r\nif (!fe1)\r\ngoto frontend_detach;\r\nfe1->dvb.frontend = dvb_attach(cx22702_attach,\r\n&hauppauge_hvr_config,\r\n&dev->core->i2c_adap);\r\nif (fe1->dvb.frontend) {\r\nfe1->dvb.frontend->id = 1;\r\nif (!dvb_attach(simple_tuner_attach,\r\nfe1->dvb.frontend,\r\n&dev->core->i2c_adap,\r\n0x61, TUNER_PHILIPS_FMD1216ME_MK3))\r\ngoto frontend_detach;\r\n}\r\nbreak;\r\ncase CX88_BOARD_DVICO_FUSIONHDTV_DVB_T_PLUS:\r\nfe0->dvb.frontend = dvb_attach(mt352_attach,\r\n&dvico_fusionhdtv,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nif (!dvb_attach(dvb_pll_attach, fe0->dvb.frontend,\r\n0x60, NULL, DVB_PLL_THOMSON_DTT7579))\r\ngoto frontend_detach;\r\nbreak;\r\n}\r\nfe0->dvb.frontend = dvb_attach(zl10353_attach,\r\n&dvico_fusionhdtv_plus_v1_1,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nif (!dvb_attach(dvb_pll_attach, fe0->dvb.frontend,\r\n0x60, NULL, DVB_PLL_THOMSON_DTT7579))\r\ngoto frontend_detach;\r\n}\r\nbreak;\r\ncase CX88_BOARD_DVICO_FUSIONHDTV_DVB_T_DUAL:\r\nfe0->dvb.frontend = dvb_attach(mt352_attach,\r\n&dvico_fusionhdtv_dual,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nif (!dvb_attach(dvb_pll_attach, fe0->dvb.frontend,\r\n0x61, NULL, DVB_PLL_THOMSON_DTT7579))\r\ngoto frontend_detach;\r\nbreak;\r\n}\r\nfe0->dvb.frontend = dvb_attach(zl10353_attach,\r\n&dvico_fusionhdtv_plus_v1_1,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nif (!dvb_attach(dvb_pll_attach, fe0->dvb.frontend,\r\n0x61, NULL, DVB_PLL_THOMSON_DTT7579))\r\ngoto frontend_detach;\r\n}\r\nbreak;\r\ncase CX88_BOARD_DVICO_FUSIONHDTV_DVB_T1:\r\nfe0->dvb.frontend = dvb_attach(mt352_attach,\r\n&dvico_fusionhdtv,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nif (!dvb_attach(dvb_pll_attach, fe0->dvb.frontend,\r\n0x61, NULL, DVB_PLL_LG_Z201))\r\ngoto frontend_detach;\r\n}\r\nbreak;\r\ncase CX88_BOARD_KWORLD_DVB_T:\r\ncase CX88_BOARD_DNTV_LIVE_DVB_T:\r\ncase CX88_BOARD_ADSTECH_DVB_T_PCI:\r\nfe0->dvb.frontend = dvb_attach(mt352_attach,\r\n&dntv_live_dvbt_config,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nif (!dvb_attach(dvb_pll_attach, fe0->dvb.frontend,\r\n0x61, NULL, DVB_PLL_UNKNOWN_1))\r\ngoto frontend_detach;\r\n}\r\nbreak;\r\ncase CX88_BOARD_DNTV_LIVE_DVB_T_PRO:\r\n#if IS_ENABLED(CONFIG_VIDEO_CX88_VP3054)\r\nfe0->dvb.frontend = dvb_attach(mt352_attach, &dntv_live_dvbt_pro_config,\r\n&dev->vp3054->adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nif (!dvb_attach(simple_tuner_attach, fe0->dvb.frontend,\r\n&core->i2c_adap, 0x61,\r\nTUNER_PHILIPS_FMD1216ME_MK3))\r\ngoto frontend_detach;\r\n}\r\n#else\r\nprintk(KERN_ERR "%s/2: built without vp3054 support\n",\r\ncore->name);\r\n#endif\r\nbreak;\r\ncase CX88_BOARD_DVICO_FUSIONHDTV_DVB_T_HYBRID:\r\nfe0->dvb.frontend = dvb_attach(zl10353_attach,\r\n&dvico_fusionhdtv_hybrid,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nif (!dvb_attach(simple_tuner_attach, fe0->dvb.frontend,\r\n&core->i2c_adap, 0x61,\r\nTUNER_THOMSON_FE6600))\r\ngoto frontend_detach;\r\n}\r\nbreak;\r\ncase CX88_BOARD_DVICO_FUSIONHDTV_DVB_T_PRO:\r\nfe0->dvb.frontend = dvb_attach(zl10353_attach,\r\n&dvico_fusionhdtv_xc3028,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend == NULL)\r\nfe0->dvb.frontend = dvb_attach(mt352_attach,\r\n&dvico_fusionhdtv_mt352_xc3028,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend)\r\nfe0->dvb.frontend->ops.i2c_gate_ctrl = NULL;\r\nif (attach_xc3028(0x61, dev) < 0)\r\ngoto frontend_detach;\r\nbreak;\r\ncase CX88_BOARD_PCHDTV_HD3000:\r\nfe0->dvb.frontend = dvb_attach(or51132_attach, &pchdtv_hd3000,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nif (!dvb_attach(simple_tuner_attach, fe0->dvb.frontend,\r\n&core->i2c_adap, 0x61,\r\nTUNER_THOMSON_DTT761X))\r\ngoto frontend_detach;\r\n}\r\nbreak;\r\ncase CX88_BOARD_DVICO_FUSIONHDTV_3_GOLD_Q:\r\ndev->ts_gen_cntrl = 0x08;\r\ncx_clear(MO_GP0_IO, 1);\r\nmdelay(100);\r\ncx_set(MO_GP0_IO, 1);\r\nmdelay(200);\r\nfusionhdtv_3_gold.pll_rf_set = lgdt330x_pll_rf_set;\r\nfe0->dvb.frontend = dvb_attach(lgdt330x_attach,\r\n&fusionhdtv_3_gold,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nif (!dvb_attach(simple_tuner_attach, fe0->dvb.frontend,\r\n&core->i2c_adap, 0x61,\r\nTUNER_MICROTUNE_4042FI5))\r\ngoto frontend_detach;\r\n}\r\nbreak;\r\ncase CX88_BOARD_DVICO_FUSIONHDTV_3_GOLD_T:\r\ndev->ts_gen_cntrl = 0x08;\r\ncx_clear(MO_GP0_IO, 1);\r\nmdelay(100);\r\ncx_set(MO_GP0_IO, 9);\r\nmdelay(200);\r\nfe0->dvb.frontend = dvb_attach(lgdt330x_attach,\r\n&fusionhdtv_3_gold,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nif (!dvb_attach(simple_tuner_attach, fe0->dvb.frontend,\r\n&core->i2c_adap, 0x61,\r\nTUNER_THOMSON_DTT761X))\r\ngoto frontend_detach;\r\n}\r\nbreak;\r\ncase CX88_BOARD_DVICO_FUSIONHDTV_5_GOLD:\r\ndev->ts_gen_cntrl = 0x08;\r\ncx_clear(MO_GP0_IO, 1);\r\nmdelay(100);\r\ncx_set(MO_GP0_IO, 1);\r\nmdelay(200);\r\nfe0->dvb.frontend = dvb_attach(lgdt330x_attach,\r\n&fusionhdtv_5_gold,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nif (!dvb_attach(simple_tuner_attach, fe0->dvb.frontend,\r\n&core->i2c_adap, 0x61,\r\nTUNER_LG_TDVS_H06XF))\r\ngoto frontend_detach;\r\nif (!dvb_attach(tda9887_attach, fe0->dvb.frontend,\r\n&core->i2c_adap, 0x43))\r\ngoto frontend_detach;\r\n}\r\nbreak;\r\ncase CX88_BOARD_PCHDTV_HD5500:\r\ndev->ts_gen_cntrl = 0x08;\r\ncx_clear(MO_GP0_IO, 1);\r\nmdelay(100);\r\ncx_set(MO_GP0_IO, 1);\r\nmdelay(200);\r\nfe0->dvb.frontend = dvb_attach(lgdt330x_attach,\r\n&pchdtv_hd5500,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nif (!dvb_attach(simple_tuner_attach, fe0->dvb.frontend,\r\n&core->i2c_adap, 0x61,\r\nTUNER_LG_TDVS_H06XF))\r\ngoto frontend_detach;\r\nif (!dvb_attach(tda9887_attach, fe0->dvb.frontend,\r\n&core->i2c_adap, 0x43))\r\ngoto frontend_detach;\r\n}\r\nbreak;\r\ncase CX88_BOARD_ATI_HDTVWONDER:\r\nfe0->dvb.frontend = dvb_attach(nxt200x_attach,\r\n&ati_hdtvwonder,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nif (!dvb_attach(simple_tuner_attach, fe0->dvb.frontend,\r\n&core->i2c_adap, 0x61,\r\nTUNER_PHILIPS_TUV1236D))\r\ngoto frontend_detach;\r\n}\r\nbreak;\r\ncase CX88_BOARD_HAUPPAUGE_NOVASPLUS_S1:\r\ncase CX88_BOARD_HAUPPAUGE_NOVASE2_S1:\r\nfe0->dvb.frontend = dvb_attach(cx24123_attach,\r\n&hauppauge_novas_config,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend) {\r\nbool override_tone;\r\nif (core->model == 92001)\r\noverride_tone = true;\r\nelse\r\noverride_tone = false;\r\nif (!dvb_attach(isl6421_attach, fe0->dvb.frontend,\r\n&core->i2c_adap, 0x08, ISL6421_DCL, 0x00,\r\noverride_tone))\r\ngoto frontend_detach;\r\n}\r\nbreak;\r\ncase CX88_BOARD_KWORLD_DVBS_100:\r\nfe0->dvb.frontend = dvb_attach(cx24123_attach,\r\n&kworld_dvbs_100_config,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend) {\r\ncore->prev_set_voltage = fe0->dvb.frontend->ops.set_voltage;\r\nfe0->dvb.frontend->ops.set_voltage = kworld_dvbs_100_set_voltage;\r\n}\r\nbreak;\r\ncase CX88_BOARD_GENIATECH_DVBS:\r\nfe0->dvb.frontend = dvb_attach(cx24123_attach,\r\n&geniatech_dvbs_config,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend) {\r\ncore->prev_set_voltage = fe0->dvb.frontend->ops.set_voltage;\r\nfe0->dvb.frontend->ops.set_voltage = geniatech_dvbs_set_voltage;\r\n}\r\nbreak;\r\ncase CX88_BOARD_PINNACLE_PCTV_HD_800i:\r\nfe0->dvb.frontend = dvb_attach(s5h1409_attach,\r\n&pinnacle_pctv_hd_800i_config,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nif (!dvb_attach(xc5000_attach, fe0->dvb.frontend,\r\n&core->i2c_adap,\r\n&pinnacle_pctv_hd_800i_tuner_config))\r\ngoto frontend_detach;\r\n}\r\nbreak;\r\ncase CX88_BOARD_DVICO_FUSIONHDTV_5_PCI_NANO:\r\nfe0->dvb.frontend = dvb_attach(s5h1409_attach,\r\n&dvico_hdtv5_pci_nano_config,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nstruct dvb_frontend *fe;\r\nstruct xc2028_config cfg = {\r\n.i2c_adap = &core->i2c_adap,\r\n.i2c_addr = 0x61,\r\n};\r\nstatic struct xc2028_ctrl ctl = {\r\n.fname = XC2028_DEFAULT_FIRMWARE,\r\n.max_len = 64,\r\n.scode_table = XC3028_FE_OREN538,\r\n};\r\nfe = dvb_attach(xc2028_attach,\r\nfe0->dvb.frontend, &cfg);\r\nif (fe != NULL && fe->ops.tuner_ops.set_config != NULL)\r\nfe->ops.tuner_ops.set_config(fe, &ctl);\r\n}\r\nbreak;\r\ncase CX88_BOARD_PINNACLE_HYBRID_PCTV:\r\ncase CX88_BOARD_WINFAST_DTV1800H:\r\nfe0->dvb.frontend = dvb_attach(zl10353_attach,\r\n&cx88_pinnacle_hybrid_pctv,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend) {\r\nfe0->dvb.frontend->ops.i2c_gate_ctrl = NULL;\r\nif (attach_xc3028(0x61, dev) < 0)\r\ngoto frontend_detach;\r\n}\r\nbreak;\r\ncase CX88_BOARD_WINFAST_DTV1800H_XC4000:\r\ncase CX88_BOARD_WINFAST_DTV2000H_PLUS:\r\nfe0->dvb.frontend = dvb_attach(zl10353_attach,\r\n&cx88_pinnacle_hybrid_pctv,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend) {\r\nstruct xc4000_config cfg = {\r\n.i2c_address = 0x61,\r\n.default_pm = 0,\r\n.dvb_amplitude = 134,\r\n.set_smoothedcvbs = 1,\r\n.if_khz = 4560\r\n};\r\nfe0->dvb.frontend->ops.i2c_gate_ctrl = NULL;\r\nif (attach_xc4000(dev, &cfg) < 0)\r\ngoto frontend_detach;\r\n}\r\nbreak;\r\ncase CX88_BOARD_GENIATECH_X8000_MT:\r\ndev->ts_gen_cntrl = 0x00;\r\nfe0->dvb.frontend = dvb_attach(zl10353_attach,\r\n&cx88_geniatech_x8000_mt,\r\n&core->i2c_adap);\r\nif (attach_xc3028(0x61, dev) < 0)\r\ngoto frontend_detach;\r\nbreak;\r\ncase CX88_BOARD_KWORLD_ATSC_120:\r\nfe0->dvb.frontend = dvb_attach(s5h1409_attach,\r\n&kworld_atsc_120_config,\r\n&core->i2c_adap);\r\nif (attach_xc3028(0x61, dev) < 0)\r\ngoto frontend_detach;\r\nbreak;\r\ncase CX88_BOARD_DVICO_FUSIONHDTV_7_GOLD:\r\nfe0->dvb.frontend = dvb_attach(s5h1411_attach,\r\n&dvico_fusionhdtv7_config,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nif (!dvb_attach(xc5000_attach, fe0->dvb.frontend,\r\n&core->i2c_adap,\r\n&dvico_fusionhdtv7_tuner_config))\r\ngoto frontend_detach;\r\n}\r\nbreak;\r\ncase CX88_BOARD_HAUPPAUGE_HVR4000:\r\nmfe_shared = 1;\r\ndev->frontends.gate = 2;\r\nfe0->dvb.frontend = dvb_attach(cx24116_attach,\r\n&hauppauge_hvr4000_config,\r\n&dev->core->i2c_adap);\r\nif (fe0->dvb.frontend) {\r\nif (!dvb_attach(isl6421_attach,\r\nfe0->dvb.frontend,\r\n&dev->core->i2c_adap,\r\n0x08, ISL6421_DCL, 0x00, false))\r\ngoto frontend_detach;\r\n}\r\nfe1 = videobuf_dvb_get_frontend(&dev->frontends, 2);\r\nif (!fe1)\r\ngoto frontend_detach;\r\nfe1->dvb.frontend = dvb_attach(cx22702_attach,\r\n&hauppauge_hvr_config,\r\n&dev->core->i2c_adap);\r\nif (fe1->dvb.frontend) {\r\nfe1->dvb.frontend->id = 1;\r\nif (!dvb_attach(simple_tuner_attach,\r\nfe1->dvb.frontend,\r\n&dev->core->i2c_adap,\r\n0x61, TUNER_PHILIPS_FMD1216ME_MK3))\r\ngoto frontend_detach;\r\n}\r\nbreak;\r\ncase CX88_BOARD_HAUPPAUGE_HVR4000LITE:\r\nfe0->dvb.frontend = dvb_attach(cx24116_attach,\r\n&hauppauge_hvr4000_config,\r\n&dev->core->i2c_adap);\r\nif (fe0->dvb.frontend) {\r\nif (!dvb_attach(isl6421_attach,\r\nfe0->dvb.frontend,\r\n&dev->core->i2c_adap,\r\n0x08, ISL6421_DCL, 0x00, false))\r\ngoto frontend_detach;\r\n}\r\nbreak;\r\ncase CX88_BOARD_PROF_6200:\r\ncase CX88_BOARD_TBS_8910:\r\ncase CX88_BOARD_TEVII_S420:\r\nfe0->dvb.frontend = dvb_attach(stv0299_attach,\r\n&tevii_tuner_sharp_config,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nif (!dvb_attach(dvb_pll_attach, fe0->dvb.frontend, 0x60,\r\n&core->i2c_adap, DVB_PLL_OPERA1))\r\ngoto frontend_detach;\r\ncore->prev_set_voltage = fe0->dvb.frontend->ops.set_voltage;\r\nfe0->dvb.frontend->ops.set_voltage = tevii_dvbs_set_voltage;\r\n} else {\r\nfe0->dvb.frontend = dvb_attach(stv0288_attach,\r\n&tevii_tuner_earda_config,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nif (!dvb_attach(stb6000_attach, fe0->dvb.frontend, 0x61,\r\n&core->i2c_adap))\r\ngoto frontend_detach;\r\ncore->prev_set_voltage = fe0->dvb.frontend->ops.set_voltage;\r\nfe0->dvb.frontend->ops.set_voltage = tevii_dvbs_set_voltage;\r\n}\r\n}\r\nbreak;\r\ncase CX88_BOARD_TEVII_S460:\r\nfe0->dvb.frontend = dvb_attach(cx24116_attach,\r\n&tevii_s460_config,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend != NULL)\r\nfe0->dvb.frontend->ops.set_voltage = tevii_dvbs_set_voltage;\r\nbreak;\r\ncase CX88_BOARD_TEVII_S464:\r\nfe0->dvb.frontend = dvb_attach(ds3000_attach,\r\n&tevii_ds3000_config,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\ndvb_attach(ts2020_attach, fe0->dvb.frontend,\r\n&tevii_ts2020_config, &core->i2c_adap);\r\nfe0->dvb.frontend->ops.set_voltage =\r\ntevii_dvbs_set_voltage;\r\n}\r\nbreak;\r\ncase CX88_BOARD_OMICOM_SS4_PCI:\r\ncase CX88_BOARD_TBS_8920:\r\ncase CX88_BOARD_PROF_7300:\r\ncase CX88_BOARD_SATTRADE_ST4200:\r\nfe0->dvb.frontend = dvb_attach(cx24116_attach,\r\n&hauppauge_hvr4000_config,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend != NULL)\r\nfe0->dvb.frontend->ops.set_voltage = tevii_dvbs_set_voltage;\r\nbreak;\r\ncase CX88_BOARD_TERRATEC_CINERGY_HT_PCI_MKII:\r\nfe0->dvb.frontend = dvb_attach(zl10353_attach,\r\n&cx88_terratec_cinergy_ht_pci_mkii_config,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend) {\r\nfe0->dvb.frontend->ops.i2c_gate_ctrl = NULL;\r\nif (attach_xc3028(0x61, dev) < 0)\r\ngoto frontend_detach;\r\n}\r\nbreak;\r\ncase CX88_BOARD_PROF_7301:{\r\nstruct dvb_tuner_ops *tuner_ops = NULL;\r\nfe0->dvb.frontend = dvb_attach(stv0900_attach,\r\n&prof_7301_stv0900_config,\r\n&core->i2c_adap, 0);\r\nif (fe0->dvb.frontend != NULL) {\r\nif (!dvb_attach(stb6100_attach, fe0->dvb.frontend,\r\n&prof_7301_stb6100_config,\r\n&core->i2c_adap))\r\ngoto frontend_detach;\r\ntuner_ops = &fe0->dvb.frontend->ops.tuner_ops;\r\ntuner_ops->set_frequency = stb6100_set_freq;\r\ntuner_ops->get_frequency = stb6100_get_freq;\r\ntuner_ops->set_bandwidth = stb6100_set_bandw;\r\ntuner_ops->get_bandwidth = stb6100_get_bandw;\r\ncore->prev_set_voltage =\r\nfe0->dvb.frontend->ops.set_voltage;\r\nfe0->dvb.frontend->ops.set_voltage =\r\ntevii_dvbs_set_voltage;\r\n}\r\nbreak;\r\n}\r\ncase CX88_BOARD_SAMSUNG_SMT_7020:\r\ndev->ts_gen_cntrl = 0x08;\r\ncx_set(MO_GP0_IO, 0x0101);\r\ncx_clear(MO_GP0_IO, 0x01);\r\nmdelay(100);\r\ncx_set(MO_GP0_IO, 0x01);\r\nmdelay(200);\r\nfe0->dvb.frontend = dvb_attach(stv0299_attach,\r\n&samsung_stv0299_config,\r\n&dev->core->i2c_adap);\r\nif (fe0->dvb.frontend) {\r\nfe0->dvb.frontend->ops.tuner_ops.set_params =\r\nsamsung_smt_7020_tuner_set_params;\r\nfe0->dvb.frontend->tuner_priv =\r\n&dev->core->i2c_adap;\r\nfe0->dvb.frontend->ops.set_voltage =\r\nsamsung_smt_7020_set_voltage;\r\nfe0->dvb.frontend->ops.set_tone =\r\nsamsung_smt_7020_set_tone;\r\n}\r\nbreak;\r\ncase CX88_BOARD_TWINHAN_VP1027_DVBS:\r\ndev->ts_gen_cntrl = 0x00;\r\nfe0->dvb.frontend = dvb_attach(mb86a16_attach,\r\n&twinhan_vp1027,\r\n&core->i2c_adap);\r\nif (fe0->dvb.frontend) {\r\ncore->prev_set_voltage =\r\nfe0->dvb.frontend->ops.set_voltage;\r\nfe0->dvb.frontend->ops.set_voltage =\r\nvp1027_set_voltage;\r\n}\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "%s/2: The frontend of your DVB/ATSC card isn't supported yet\n",\r\ncore->name);\r\nbreak;\r\n}\r\nif ( (NULL == fe0->dvb.frontend) || (fe1 && NULL == fe1->dvb.frontend) ) {\r\nprintk(KERN_ERR\r\n"%s/2: frontend initialization failed\n",\r\ncore->name);\r\ngoto frontend_detach;\r\n}\r\nfe0->dvb.frontend->callback = cx88_tuner_callback;\r\nfe0->dvb.frontend->ops.ts_bus_ctrl = cx88_dvb_bus_ctrl;\r\nif (fe1)\r\nfe1->dvb.frontend->ops.ts_bus_ctrl = cx88_dvb_bus_ctrl;\r\ncall_all(core, core, s_power, 0);\r\nres = videobuf_dvb_register_bus(&dev->frontends, THIS_MODULE, dev,\r\n&dev->pci->dev, adapter_nr, mfe_shared);\r\nif (res)\r\ngoto frontend_detach;\r\nreturn res;\r\nfrontend_detach:\r\ncore->gate_ctrl = NULL;\r\nvideobuf_dvb_dealloc_frontends(&dev->frontends);\r\nreturn res;\r\n}\r\nstatic int cx8802_dvb_advise_acquire(struct cx8802_driver *drv)\r\n{\r\nstruct cx88_core *core = drv->core;\r\nint err = 0;\r\ndprintk( 1, "%s\n", __func__);\r\nswitch (core->boardnr) {\r\ncase CX88_BOARD_HAUPPAUGE_HVR1300:\r\ncx_set(MO_GP0_IO, 0x00000080);\r\nudelay(1000);\r\ncx_clear(MO_GP0_IO, 0x00000080);\r\nudelay(50);\r\ncx_set(MO_GP0_IO, 0x00000080);\r\nudelay(1000);\r\ncx_clear(MO_GP0_IO, 0x00000004);\r\nudelay(1000);\r\nbreak;\r\ncase CX88_BOARD_HAUPPAUGE_HVR3000:\r\ncase CX88_BOARD_HAUPPAUGE_HVR4000:\r\ncx_set(MO_GP0_IO, 0x00000080);\r\nudelay(1000);\r\ncx_clear(MO_GP0_IO, 0x00000080);\r\nudelay(50);\r\ncx_set(MO_GP0_IO, 0x00000080);\r\nudelay(1000);\r\nswitch (core->dvbdev->frontends.active_fe_id) {\r\ncase 1:\r\ncx_set(MO_GP0_IO, 0x00000004);\r\ncx_write(MO_SRST_IO, 1);\r\ncore->dvbdev->ts_gen_cntrl = 0x02;\r\nbreak;\r\ncase 2:\r\ncx_write(MO_SRST_IO, 0);\r\ncx_clear(MO_GP0_IO, 0x00000004);\r\ncore->dvbdev->ts_gen_cntrl = 0x0c;\r\nbreak;\r\n}\r\nudelay(1000);\r\nbreak;\r\ncase CX88_BOARD_WINFAST_DTV2000H_PLUS:\r\ncx_write(MO_GP2_IO, 0x0101);\r\nbreak;\r\ndefault:\r\nerr = -ENODEV;\r\n}\r\nreturn err;\r\n}\r\nstatic int cx8802_dvb_advise_release(struct cx8802_driver *drv)\r\n{\r\nstruct cx88_core *core = drv->core;\r\nint err = 0;\r\ndprintk( 1, "%s\n", __func__);\r\nswitch (core->boardnr) {\r\ncase CX88_BOARD_HAUPPAUGE_HVR1300:\r\nbreak;\r\ncase CX88_BOARD_HAUPPAUGE_HVR3000:\r\ncase CX88_BOARD_HAUPPAUGE_HVR4000:\r\nbreak;\r\ndefault:\r\nerr = -ENODEV;\r\n}\r\nreturn err;\r\n}\r\nstatic int cx8802_dvb_probe(struct cx8802_driver *drv)\r\n{\r\nstruct cx88_core *core = drv->core;\r\nstruct cx8802_dev *dev = drv->core->dvbdev;\r\nint err;\r\nstruct videobuf_dvb_frontend *fe;\r\nint i;\r\ndprintk( 1, "%s\n", __func__);\r\ndprintk( 1, " ->being probed by Card=%d Name=%s, PCI %02x:%02x\n",\r\ncore->boardnr,\r\ncore->name,\r\ncore->pci_bus,\r\ncore->pci_slot);\r\nerr = -ENODEV;\r\nif (!(core->board.mpeg & CX88_MPEG_DVB))\r\ngoto fail_core;\r\nerr = vp3054_i2c_probe(dev);\r\nif (0 != err)\r\ngoto fail_core;\r\nprintk(KERN_INFO "%s/2: cx2388x based DVB/ATSC card\n", core->name);\r\ndev->ts_gen_cntrl = 0x0c;\r\nerr = cx8802_alloc_frontends(dev);\r\nif (err)\r\ngoto fail_core;\r\nerr = -ENODEV;\r\nfor (i = 1; i <= core->board.num_frontends; i++) {\r\nfe = videobuf_dvb_get_frontend(&core->dvbdev->frontends, i);\r\nif (fe == NULL) {\r\nprintk(KERN_ERR "%s() failed to get frontend(%d)\n",\r\n__func__, i);\r\ngoto fail_probe;\r\n}\r\nvideobuf_queue_sg_init(&fe->dvb.dvbq, &dvb_qops,\r\n&dev->pci->dev, &dev->slock,\r\nV4L2_BUF_TYPE_VIDEO_CAPTURE,\r\nV4L2_FIELD_TOP,\r\nsizeof(struct cx88_buffer),\r\ndev, NULL);\r\nfe->dvb.name = dev->core->name;\r\n}\r\nerr = dvb_register(dev);\r\nif (err)\r\nprintk(KERN_ERR "%s/2: dvb_register failed (err = %d)\n",\r\ncore->name, err);\r\nreturn err;\r\nfail_probe:\r\nvideobuf_dvb_dealloc_frontends(&core->dvbdev->frontends);\r\nfail_core:\r\nreturn err;\r\n}\r\nstatic int cx8802_dvb_remove(struct cx8802_driver *drv)\r\n{\r\nstruct cx88_core *core = drv->core;\r\nstruct cx8802_dev *dev = drv->core->dvbdev;\r\ndprintk( 1, "%s\n", __func__);\r\nvideobuf_dvb_unregister_bus(&dev->frontends);\r\nvp3054_i2c_remove(dev);\r\ncore->gate_ctrl = NULL;\r\nreturn 0;\r\n}\r\nstatic int __init dvb_init(void)\r\n{\r\nprintk(KERN_INFO "cx88/2: cx2388x dvb driver version %s loaded\n",\r\nCX88_VERSION);\r\nreturn cx8802_register_driver(&cx8802_dvb_driver);\r\n}\r\nstatic void __exit dvb_fini(void)\r\n{\r\ncx8802_unregister_driver(&cx8802_dvb_driver);\r\n}

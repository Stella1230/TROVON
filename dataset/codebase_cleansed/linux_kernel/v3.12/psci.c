static void kvm_psci_vcpu_off(struct kvm_vcpu *vcpu)\r\n{\r\nvcpu->arch.pause = true;\r\n}\r\nstatic unsigned long kvm_psci_vcpu_on(struct kvm_vcpu *source_vcpu)\r\n{\r\nstruct kvm *kvm = source_vcpu->kvm;\r\nstruct kvm_vcpu *vcpu;\r\nwait_queue_head_t *wq;\r\nunsigned long cpu_id;\r\nphys_addr_t target_pc;\r\ncpu_id = *vcpu_reg(source_vcpu, 1);\r\nif (vcpu_mode_is_32bit(source_vcpu))\r\ncpu_id &= ~((u32) 0);\r\nif (cpu_id >= atomic_read(&kvm->online_vcpus))\r\nreturn KVM_PSCI_RET_INVAL;\r\ntarget_pc = *vcpu_reg(source_vcpu, 2);\r\nvcpu = kvm_get_vcpu(kvm, cpu_id);\r\nwq = kvm_arch_vcpu_wq(vcpu);\r\nif (!waitqueue_active(wq))\r\nreturn KVM_PSCI_RET_INVAL;\r\nkvm_reset_vcpu(vcpu);\r\nif (vcpu_mode_is_32bit(vcpu) && (target_pc & 1)) {\r\ntarget_pc &= ~((phys_addr_t) 1);\r\nvcpu_set_thumb(vcpu);\r\n}\r\n*vcpu_pc(vcpu) = target_pc;\r\nvcpu->arch.pause = false;\r\nsmp_mb();\r\nwake_up_interruptible(wq);\r\nreturn KVM_PSCI_RET_SUCCESS;\r\n}\r\nbool kvm_psci_call(struct kvm_vcpu *vcpu)\r\n{\r\nunsigned long psci_fn = *vcpu_reg(vcpu, 0) & ~((u32) 0);\r\nunsigned long val;\r\nswitch (psci_fn) {\r\ncase KVM_PSCI_FN_CPU_OFF:\r\nkvm_psci_vcpu_off(vcpu);\r\nval = KVM_PSCI_RET_SUCCESS;\r\nbreak;\r\ncase KVM_PSCI_FN_CPU_ON:\r\nval = kvm_psci_vcpu_on(vcpu);\r\nbreak;\r\ncase KVM_PSCI_FN_CPU_SUSPEND:\r\ncase KVM_PSCI_FN_MIGRATE:\r\nval = KVM_PSCI_RET_NI;\r\nbreak;\r\ndefault:\r\nreturn false;\r\n}\r\n*vcpu_reg(vcpu, 0) = val;\r\nreturn true;\r\n}

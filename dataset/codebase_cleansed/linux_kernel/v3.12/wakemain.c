static void udelay(int loops)\r\n{\r\nwhile (loops--)\r\nio_delay();\r\n}\r\nstatic void beep(unsigned int hz)\r\n{\r\nu8 enable;\r\nif (!hz) {\r\nenable = 0x00;\r\n} else {\r\nu16 div = 1193181/hz;\r\noutb(0xb6, 0x43);\r\nio_delay();\r\noutb(div, 0x42);\r\nio_delay();\r\noutb(div >> 8, 0x42);\r\nio_delay();\r\nenable = 0x03;\r\n}\r\ninb(0x61);\r\nio_delay();\r\noutb(enable, 0x61);\r\nio_delay();\r\n}\r\nstatic void send_morse(const char *pattern)\r\n{\r\nchar s;\r\nwhile ((s = *pattern++)) {\r\nswitch (s) {\r\ncase '.':\r\nbeep(DOT_HZ);\r\nudelay(US_PER_DOT);\r\nbeep(0);\r\nudelay(US_PER_DOT);\r\nbreak;\r\ncase '-':\r\nbeep(DASH_HZ);\r\nudelay(US_PER_DOT * 3);\r\nbeep(0);\r\nudelay(US_PER_DOT);\r\nbreak;\r\ndefault:\r\nudelay(US_PER_DOT * 3);\r\nbreak;\r\n}\r\n}\r\n}\r\nvoid main(void)\r\n{\r\nif (wakeup_header.real_magic != 0x12345678)\r\nwhile (1)\r\n;\r\nif (wakeup_header.realmode_flags & 4)\r\nsend_morse("...-");\r\nif (wakeup_header.realmode_flags & 1)\r\nasm volatile("lcallw $0xc000,$3");\r\nif (wakeup_header.realmode_flags & 2) {\r\nprobe_cards(0);\r\nset_mode(wakeup_header.video_mode);\r\n}\r\n}

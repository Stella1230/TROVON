static int pcm20_setfreq(struct pcm20 *dev, unsigned long freq)\r\n{\r\nunsigned char freql;\r\nunsigned char freqh;\r\nstruct snd_miro_aci *aci = dev->aci;\r\nfreq /= 160;\r\nif (!(aci->aci_version == 0x07 || aci->aci_version >= 0xb0))\r\nfreq /= 10;\r\nfreql = freq & 0xff;\r\nfreqh = freq >> 8;\r\nreturn snd_aci_cmd(aci, ACI_WRITE_TUNE, freql, freqh);\r\n}\r\nstatic int vidioc_querycap(struct file *file, void *priv,\r\nstruct v4l2_capability *v)\r\n{\r\nstruct pcm20 *dev = video_drvdata(file);\r\nstrlcpy(v->driver, "Miro PCM20", sizeof(v->driver));\r\nstrlcpy(v->card, "Miro PCM20", sizeof(v->card));\r\nsnprintf(v->bus_info, sizeof(v->bus_info), "ISA:%s", dev->v4l2_dev.name);\r\nv->device_caps = V4L2_CAP_TUNER | V4L2_CAP_RADIO;\r\nv->capabilities = v->device_caps | V4L2_CAP_DEVICE_CAPS;\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_tuner(struct file *file, void *priv,\r\nstruct v4l2_tuner *v)\r\n{\r\nstruct pcm20 *dev = video_drvdata(file);\r\nint res;\r\nif (v->index)\r\nreturn -EINVAL;\r\nstrlcpy(v->name, "FM", sizeof(v->name));\r\nv->type = V4L2_TUNER_RADIO;\r\nv->rangelow = 87*16000;\r\nv->rangehigh = 108*16000;\r\nres = snd_aci_cmd(dev->aci, ACI_READ_TUNERSTATION, -1, -1);\r\nv->signal = (res & 0x80) ? 0 : 0xffff;\r\nres = snd_aci_cmd(dev->aci, ACI_READ_TUNERSTEREO, -1, -1);\r\nv->rxsubchans = (res & 0x40) ? V4L2_TUNER_SUB_MONO :\r\nV4L2_TUNER_SUB_STEREO;\r\nv->capability = V4L2_TUNER_CAP_LOW | V4L2_TUNER_CAP_STEREO;\r\nv->audmode = dev->audmode;\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_tuner(struct file *file, void *priv,\r\nconst struct v4l2_tuner *v)\r\n{\r\nstruct pcm20 *dev = video_drvdata(file);\r\nif (v->index)\r\nreturn -EINVAL;\r\nif (v->audmode > V4L2_TUNER_MODE_STEREO)\r\ndev->audmode = V4L2_TUNER_MODE_STEREO;\r\nelse\r\ndev->audmode = v->audmode;\r\nsnd_aci_cmd(dev->aci, ACI_SET_TUNERMONO,\r\ndev->audmode == V4L2_TUNER_MODE_MONO, -1);\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_frequency(struct file *file, void *priv,\r\nstruct v4l2_frequency *f)\r\n{\r\nstruct pcm20 *dev = video_drvdata(file);\r\nif (f->tuner != 0)\r\nreturn -EINVAL;\r\nf->type = V4L2_TUNER_RADIO;\r\nf->frequency = dev->freq;\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_frequency(struct file *file, void *priv,\r\nconst struct v4l2_frequency *f)\r\n{\r\nstruct pcm20 *dev = video_drvdata(file);\r\nif (f->tuner != 0 || f->type != V4L2_TUNER_RADIO)\r\nreturn -EINVAL;\r\ndev->freq = clamp_t(u32, f->frequency, 87 * 16000U, 108 * 16000U);\r\npcm20_setfreq(dev, dev->freq);\r\nreturn 0;\r\n}\r\nstatic int pcm20_s_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstruct pcm20 *dev = container_of(ctrl->handler, struct pcm20, ctrl_handler);\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_AUDIO_MUTE:\r\nsnd_aci_cmd(dev->aci, ACI_SET_TUNERMUTE, ctrl->val, -1);\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int __init pcm20_init(void)\r\n{\r\nstruct pcm20 *dev = &pcm20_card;\r\nstruct v4l2_device *v4l2_dev = &dev->v4l2_dev;\r\nstruct v4l2_ctrl_handler *hdl;\r\nint res;\r\ndev->aci = snd_aci_get_aci();\r\nif (dev->aci == NULL) {\r\nv4l2_err(v4l2_dev,\r\n"you must load the snd-miro driver first!\n");\r\nreturn -ENODEV;\r\n}\r\nstrlcpy(v4l2_dev->name, "radio-miropcm20", sizeof(v4l2_dev->name));\r\nmutex_init(&dev->lock);\r\nres = v4l2_device_register(NULL, v4l2_dev);\r\nif (res < 0) {\r\nv4l2_err(v4l2_dev, "could not register v4l2_device\n");\r\nreturn -EINVAL;\r\n}\r\nhdl = &dev->ctrl_handler;\r\nv4l2_ctrl_handler_init(hdl, 1);\r\nv4l2_ctrl_new_std(hdl, &pcm20_ctrl_ops,\r\nV4L2_CID_AUDIO_MUTE, 0, 1, 1, 1);\r\nv4l2_dev->ctrl_handler = hdl;\r\nif (hdl->error) {\r\nres = hdl->error;\r\nv4l2_err(v4l2_dev, "Could not register control\n");\r\ngoto err_hdl;\r\n}\r\nstrlcpy(dev->vdev.name, v4l2_dev->name, sizeof(dev->vdev.name));\r\ndev->vdev.v4l2_dev = v4l2_dev;\r\ndev->vdev.fops = &pcm20_fops;\r\ndev->vdev.ioctl_ops = &pcm20_ioctl_ops;\r\ndev->vdev.release = video_device_release_empty;\r\ndev->vdev.lock = &dev->lock;\r\nset_bit(V4L2_FL_USE_FH_PRIO, &dev->vdev.flags);\r\nvideo_set_drvdata(&dev->vdev, dev);\r\nsnd_aci_cmd(dev->aci, ACI_SET_TUNERMONO,\r\ndev->audmode == V4L2_TUNER_MODE_MONO, -1);\r\npcm20_setfreq(dev, dev->freq);\r\nif (video_register_device(&dev->vdev, VFL_TYPE_RADIO, radio_nr) < 0)\r\ngoto err_hdl;\r\nv4l2_info(v4l2_dev, "Mirosound PCM20 Radio tuner\n");\r\nreturn 0;\r\nerr_hdl:\r\nv4l2_ctrl_handler_free(hdl);\r\nv4l2_device_unregister(v4l2_dev);\r\nreturn -EINVAL;\r\n}\r\nstatic void __exit pcm20_cleanup(void)\r\n{\r\nstruct pcm20 *dev = &pcm20_card;\r\nvideo_unregister_device(&dev->vdev);\r\nsnd_aci_cmd(dev->aci, ACI_SET_TUNERMUTE, 1, -1);\r\nv4l2_ctrl_handler_free(&dev->ctrl_handler);\r\nv4l2_device_unregister(&dev->v4l2_dev);\r\n}

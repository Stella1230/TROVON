static void\r\nixdp425_flash_nand_cmd_ctrl(struct mtd_info *mtd, int cmd, unsigned int ctrl)\r\n{\r\nstruct nand_chip *this = mtd->priv;\r\nint offset = (int)this->priv;\r\nif (ctrl & NAND_CTRL_CHANGE) {\r\nif (ctrl & NAND_NCE) {\r\ngpio_line_set(IXDP425_NAND_NCE_PIN, IXP4XX_GPIO_LOW);\r\nudelay(5);\r\n} else\r\ngpio_line_set(IXDP425_NAND_NCE_PIN, IXP4XX_GPIO_HIGH);\r\noffset = (ctrl & NAND_CLE) ? IXDP425_NAND_CMD_BYTE : 0;\r\noffset |= (ctrl & NAND_ALE) ? IXDP425_NAND_ADDR_BYTE : 0;\r\nthis->priv = (void *)offset;\r\n}\r\nif (cmd != NAND_CMD_NONE)\r\nwriteb(cmd, this->IO_ADDR_W + offset);\r\n}\r\nstatic void __init ixdp425_init(void)\r\n{\r\nixp4xx_sys_init();\r\nixdp425_flash_resource.start = IXP4XX_EXP_BUS_BASE(0);\r\nixdp425_flash_resource.end =\r\nIXP4XX_EXP_BUS_BASE(0) + ixp4xx_exp_bus_size - 1;\r\n#if defined(CONFIG_MTD_NAND_PLATFORM) || \\r\ndefined(CONFIG_MTD_NAND_PLATFORM_MODULE)\r\nixdp425_flash_nand_resource.start = IXP4XX_EXP_BUS_BASE(3),\r\nixdp425_flash_nand_resource.end = IXP4XX_EXP_BUS_BASE(3) + 0x10 - 1;\r\ngpio_line_config(IXDP425_NAND_NCE_PIN, IXP4XX_GPIO_OUT);\r\n*IXP4XX_EXP_CS3 = IXP4XX_EXP_BUS_CS_EN |\r\nIXP4XX_EXP_BUS_STROBE_T(1) |\r\nIXP4XX_EXP_BUS_CYCLES(0) |\r\nIXP4XX_EXP_BUS_SIZE(0) |\r\nIXP4XX_EXP_BUS_WR_EN |\r\nIXP4XX_EXP_BUS_BYTE_EN;\r\n#endif\r\nif (cpu_is_ixp43x()) {\r\nixdp425_uart.num_resources = 1;\r\nixdp425_uart_data[1].flags = 0;\r\n}\r\nplatform_add_devices(ixdp425_devices, ARRAY_SIZE(ixdp425_devices));\r\n}

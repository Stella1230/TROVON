int drm_i2c_encoder_init(struct drm_device *dev,\r\nstruct drm_encoder_slave *encoder,\r\nstruct i2c_adapter *adap,\r\nconst struct i2c_board_info *info)\r\n{\r\nstruct module *module = NULL;\r\nstruct i2c_client *client;\r\nstruct drm_i2c_encoder_driver *encoder_drv;\r\nint err = 0;\r\nrequest_module("%s%s", I2C_MODULE_PREFIX, info->type);\r\nclient = i2c_new_device(adap, info);\r\nif (!client) {\r\nerr = -ENOMEM;\r\ngoto fail;\r\n}\r\nif (!client->driver) {\r\nerr = -ENODEV;\r\ngoto fail_unregister;\r\n}\r\nmodule = client->driver->driver.owner;\r\nif (!try_module_get(module)) {\r\nerr = -ENODEV;\r\ngoto fail_unregister;\r\n}\r\nencoder->bus_priv = client;\r\nencoder_drv = to_drm_i2c_encoder_driver(client->driver);\r\nerr = encoder_drv->encoder_init(client, dev, encoder);\r\nif (err)\r\ngoto fail_unregister;\r\nif (info->platform_data)\r\nencoder->slave_funcs->set_config(&encoder->base,\r\ninfo->platform_data);\r\nreturn 0;\r\nfail_unregister:\r\ni2c_unregister_device(client);\r\nmodule_put(module);\r\nfail:\r\nreturn err;\r\n}\r\nvoid drm_i2c_encoder_destroy(struct drm_encoder *drm_encoder)\r\n{\r\nstruct drm_encoder_slave *encoder = to_encoder_slave(drm_encoder);\r\nstruct i2c_client *client = drm_i2c_encoder_get_client(drm_encoder);\r\nstruct module *module = client->driver->driver.owner;\r\ni2c_unregister_device(client);\r\nencoder->bus_priv = NULL;\r\nmodule_put(module);\r\n}\r\nstatic inline struct drm_encoder_slave_funcs *\r\nget_slave_funcs(struct drm_encoder *enc)\r\n{\r\nreturn to_encoder_slave(enc)->slave_funcs;\r\n}\r\nvoid drm_i2c_encoder_dpms(struct drm_encoder *encoder, int mode)\r\n{\r\nget_slave_funcs(encoder)->dpms(encoder, mode);\r\n}\r\nbool drm_i2c_encoder_mode_fixup(struct drm_encoder *encoder,\r\nconst struct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nreturn get_slave_funcs(encoder)->mode_fixup(encoder, mode, adjusted_mode);\r\n}\r\nvoid drm_i2c_encoder_prepare(struct drm_encoder *encoder)\r\n{\r\ndrm_i2c_encoder_dpms(encoder, DRM_MODE_DPMS_OFF);\r\n}\r\nvoid drm_i2c_encoder_commit(struct drm_encoder *encoder)\r\n{\r\ndrm_i2c_encoder_dpms(encoder, DRM_MODE_DPMS_ON);\r\n}\r\nvoid drm_i2c_encoder_mode_set(struct drm_encoder *encoder,\r\nstruct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nget_slave_funcs(encoder)->mode_set(encoder, mode, adjusted_mode);\r\n}\r\nenum drm_connector_status drm_i2c_encoder_detect(struct drm_encoder *encoder,\r\nstruct drm_connector *connector)\r\n{\r\nreturn get_slave_funcs(encoder)->detect(encoder, connector);\r\n}\r\nvoid drm_i2c_encoder_save(struct drm_encoder *encoder)\r\n{\r\nget_slave_funcs(encoder)->save(encoder);\r\n}\r\nvoid drm_i2c_encoder_restore(struct drm_encoder *encoder)\r\n{\r\nget_slave_funcs(encoder)->restore(encoder);\r\n}

irqreturn_t qxl_irq_handler(DRM_IRQ_ARGS)\r\n{\r\nstruct drm_device *dev = (struct drm_device *) arg;\r\nstruct qxl_device *qdev = (struct qxl_device *)dev->dev_private;\r\nuint32_t pending;\r\npending = xchg(&qdev->ram_header->int_pending, 0);\r\natomic_inc(&qdev->irq_received);\r\nif (pending & QXL_INTERRUPT_DISPLAY) {\r\natomic_inc(&qdev->irq_received_display);\r\nwake_up_all(&qdev->display_event);\r\nqxl_queue_garbage_collect(qdev, false);\r\n}\r\nif (pending & QXL_INTERRUPT_CURSOR) {\r\natomic_inc(&qdev->irq_received_cursor);\r\nwake_up_all(&qdev->cursor_event);\r\n}\r\nif (pending & QXL_INTERRUPT_IO_CMD) {\r\natomic_inc(&qdev->irq_received_io_cmd);\r\nwake_up_all(&qdev->io_cmd_event);\r\n}\r\nif (pending & QXL_INTERRUPT_ERROR) {\r\nqdev->irq_received_error++;\r\nqxl_io_log(qdev, "%s: driver is in bug mode.\n", __func__);\r\n}\r\nif (pending & QXL_INTERRUPT_CLIENT_MONITORS_CONFIG) {\r\nqxl_io_log(qdev, "QXL_INTERRUPT_CLIENT_MONITORS_CONFIG\n");\r\nschedule_work(&qdev->client_monitors_config_work);\r\n}\r\nqdev->ram_header->int_mask = QXL_INTERRUPT_MASK;\r\noutb(0, qdev->io_base + QXL_IO_UPDATE_IRQ);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void qxl_client_monitors_config_work_func(struct work_struct *work)\r\n{\r\nstruct qxl_device *qdev = container_of(work, struct qxl_device,\r\nclient_monitors_config_work);\r\nqxl_display_read_client_monitors_config(qdev);\r\n}\r\nint qxl_irq_init(struct qxl_device *qdev)\r\n{\r\nint ret;\r\ninit_waitqueue_head(&qdev->display_event);\r\ninit_waitqueue_head(&qdev->cursor_event);\r\ninit_waitqueue_head(&qdev->io_cmd_event);\r\nINIT_WORK(&qdev->client_monitors_config_work,\r\nqxl_client_monitors_config_work_func);\r\natomic_set(&qdev->irq_received, 0);\r\natomic_set(&qdev->irq_received_display, 0);\r\natomic_set(&qdev->irq_received_cursor, 0);\r\natomic_set(&qdev->irq_received_io_cmd, 0);\r\nqdev->irq_received_error = 0;\r\nret = drm_irq_install(qdev->ddev);\r\nqdev->ram_header->int_mask = QXL_INTERRUPT_MASK;\r\nif (unlikely(ret != 0)) {\r\nDRM_ERROR("Failed installing irq: %d\n", ret);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}

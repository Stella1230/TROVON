static void fuse_speedo_calib(u32 *speedo_g, u32 *speedo_lp)\r\n{\r\nu32 reg;\r\nint ate_ver;\r\nint bit_minus1;\r\nint bit_minus2;\r\nreg = tegra_fuse_readl(FUSE_SPEEDO_CALIB_0);\r\n*speedo_lp = (reg & 0xFFFF) * 4;\r\n*speedo_g = ((reg >> 16) & 0xFFFF) * 4;\r\nate_ver = tegra_fuse_readl(FUSE_TEST_PROG_VER);\r\npr_info("%s: ATE prog ver %d.%d\n", __func__, ate_ver/10, ate_ver%10);\r\nif (ate_ver >= 26) {\r\nbit_minus1 = tegra_spare_fuse(LP_SPEEDO_BIT_MINUS1);\r\nbit_minus1 |= tegra_spare_fuse(LP_SPEEDO_BIT_MINUS1_R);\r\nbit_minus2 = tegra_spare_fuse(LP_SPEEDO_BIT_MINUS2);\r\nbit_minus2 |= tegra_spare_fuse(LP_SPEEDO_BIT_MINUS2_R);\r\n*speedo_lp |= (bit_minus1 << 1) | bit_minus2;\r\nbit_minus1 = tegra_spare_fuse(G_SPEEDO_BIT_MINUS1);\r\nbit_minus1 |= tegra_spare_fuse(G_SPEEDO_BIT_MINUS1_R);\r\nbit_minus2 = tegra_spare_fuse(G_SPEEDO_BIT_MINUS2);\r\nbit_minus2 |= tegra_spare_fuse(G_SPEEDO_BIT_MINUS2_R);\r\n*speedo_g |= (bit_minus1 << 1) | bit_minus2;\r\n} else {\r\n*speedo_lp |= 0x3;\r\n*speedo_g |= 0x3;\r\n}\r\n}\r\nstatic void rev_sku_to_speedo_ids(int rev, int sku)\r\n{\r\nswitch (rev) {\r\ncase TEGRA_REVISION_A01:\r\ntegra_cpu_speedo_id = 0;\r\ntegra_soc_speedo_id = 0;\r\nthreshold_index = THRESHOLD_INDEX_0;\r\nbreak;\r\ncase TEGRA_REVISION_A02:\r\ncase TEGRA_REVISION_A03:\r\nswitch (sku) {\r\ncase 0x87:\r\ncase 0x82:\r\ntegra_cpu_speedo_id = 1;\r\ntegra_soc_speedo_id = 1;\r\nthreshold_index = THRESHOLD_INDEX_1;\r\nbreak;\r\ncase 0x81:\r\nswitch (package_id) {\r\ncase 1:\r\ntegra_cpu_speedo_id = 2;\r\ntegra_soc_speedo_id = 2;\r\nthreshold_index = THRESHOLD_INDEX_2;\r\nbreak;\r\ncase 2:\r\ntegra_cpu_speedo_id = 4;\r\ntegra_soc_speedo_id = 1;\r\nthreshold_index = THRESHOLD_INDEX_7;\r\nbreak;\r\ndefault:\r\npr_err("Tegra30: Unknown pkg %d\n", package_id);\r\nBUG();\r\nbreak;\r\n}\r\nbreak;\r\ncase 0x80:\r\nswitch (package_id) {\r\ncase 1:\r\ntegra_cpu_speedo_id = 5;\r\ntegra_soc_speedo_id = 2;\r\nthreshold_index = THRESHOLD_INDEX_8;\r\nbreak;\r\ncase 2:\r\ntegra_cpu_speedo_id = 6;\r\ntegra_soc_speedo_id = 2;\r\nthreshold_index = THRESHOLD_INDEX_9;\r\nbreak;\r\ndefault:\r\npr_err("Tegra30: Unknown pkg %d\n", package_id);\r\nBUG();\r\nbreak;\r\n}\r\nbreak;\r\ncase 0x83:\r\nswitch (package_id) {\r\ncase 1:\r\ntegra_cpu_speedo_id = 7;\r\ntegra_soc_speedo_id = 1;\r\nthreshold_index = THRESHOLD_INDEX_10;\r\nbreak;\r\ncase 2:\r\ntegra_cpu_speedo_id = 3;\r\ntegra_soc_speedo_id = 2;\r\nthreshold_index = THRESHOLD_INDEX_3;\r\nbreak;\r\ndefault:\r\npr_err("Tegra30: Unknown pkg %d\n", package_id);\r\nBUG();\r\nbreak;\r\n}\r\nbreak;\r\ncase 0x8F:\r\ntegra_cpu_speedo_id = 8;\r\ntegra_soc_speedo_id = 1;\r\nthreshold_index = THRESHOLD_INDEX_11;\r\nbreak;\r\ncase 0x08:\r\ntegra_cpu_speedo_id = 1;\r\ntegra_soc_speedo_id = 1;\r\nthreshold_index = THRESHOLD_INDEX_4;\r\nbreak;\r\ncase 0x02:\r\ntegra_cpu_speedo_id = 2;\r\ntegra_soc_speedo_id = 2;\r\nthreshold_index = THRESHOLD_INDEX_5;\r\nbreak;\r\ncase 0x04:\r\ntegra_cpu_speedo_id = 3;\r\ntegra_soc_speedo_id = 2;\r\nthreshold_index = THRESHOLD_INDEX_6;\r\nbreak;\r\ncase 0:\r\nswitch (package_id) {\r\ncase 1:\r\ntegra_cpu_speedo_id = 2;\r\ntegra_soc_speedo_id = 2;\r\nthreshold_index = THRESHOLD_INDEX_2;\r\nbreak;\r\ncase 2:\r\ntegra_cpu_speedo_id = 3;\r\ntegra_soc_speedo_id = 2;\r\nthreshold_index = THRESHOLD_INDEX_3;\r\nbreak;\r\ndefault:\r\npr_err("Tegra30: Unknown pkg %d\n", package_id);\r\nBUG();\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\npr_warn("Tegra30: Unknown SKU %d\n", sku);\r\ntegra_cpu_speedo_id = 0;\r\ntegra_soc_speedo_id = 0;\r\nthreshold_index = THRESHOLD_INDEX_0;\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\npr_warn("Tegra30: Unknown chip rev %d\n", rev);\r\ntegra_cpu_speedo_id = 0;\r\ntegra_soc_speedo_id = 0;\r\nthreshold_index = THRESHOLD_INDEX_0;\r\nbreak;\r\n}\r\n}\r\nvoid tegra30_init_speedo_data(void)\r\n{\r\nu32 cpu_speedo_val;\r\nu32 core_speedo_val;\r\nint i;\r\nBUILD_BUG_ON(ARRAY_SIZE(cpu_process_speedos) !=\r\nTHRESHOLD_INDEX_COUNT);\r\nBUILD_BUG_ON(ARRAY_SIZE(core_process_speedos) !=\r\nTHRESHOLD_INDEX_COUNT);\r\npackage_id = tegra_fuse_readl(FUSE_PACKAGE_INFO) & 0x0F;\r\nrev_sku_to_speedo_ids(tegra_revision, tegra_sku_id);\r\nfuse_speedo_calib(&cpu_speedo_val, &core_speedo_val);\r\npr_debug("%s CPU speedo value %u\n", __func__, cpu_speedo_val);\r\npr_debug("%s Core speedo value %u\n", __func__, core_speedo_val);\r\nfor (i = 0; i < CPU_PROCESS_CORNERS_NUM; i++) {\r\nif (cpu_speedo_val < cpu_process_speedos[threshold_index][i])\r\nbreak;\r\n}\r\ntegra_cpu_process_id = i - 1;\r\nif (tegra_cpu_process_id == -1) {\r\npr_warn("Tegra30: CPU speedo value %3d out of range",\r\ncpu_speedo_val);\r\ntegra_cpu_process_id = 0;\r\ntegra_cpu_speedo_id = 1;\r\n}\r\nfor (i = 0; i < CORE_PROCESS_CORNERS_NUM; i++) {\r\nif (core_speedo_val < core_process_speedos[threshold_index][i])\r\nbreak;\r\n}\r\ntegra_core_process_id = i - 1;\r\nif (tegra_core_process_id == -1) {\r\npr_warn("Tegra30: CORE speedo value %3d out of range",\r\ncore_speedo_val);\r\ntegra_core_process_id = 0;\r\ntegra_soc_speedo_id = 1;\r\n}\r\npr_info("Tegra30: CPU Speedo ID %d, Soc Speedo ID %d",\r\ntegra_cpu_speedo_id, tegra_soc_speedo_id);\r\n}

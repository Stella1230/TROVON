struct bcom_task *\r\nbcom_ata_init(int queue_len, int maxbufsize)\r\n{\r\nstruct bcom_task *tsk;\r\nstruct bcom_ata_var *var;\r\nstruct bcom_ata_inc *inc;\r\nbcom_disable_prefetch();\r\ntsk = bcom_task_alloc(queue_len, sizeof(struct bcom_ata_bd), 0);\r\nif (!tsk)\r\nreturn NULL;\r\ntsk->flags = BCOM_FLAGS_NONE;\r\nbcom_ata_reset_bd(tsk);\r\nvar = (struct bcom_ata_var *) bcom_task_var(tsk->tasknum);\r\ninc = (struct bcom_ata_inc *) bcom_task_inc(tsk->tasknum);\r\nif (bcom_load_image(tsk->tasknum, bcom_ata_task)) {\r\nbcom_task_free(tsk);\r\nreturn NULL;\r\n}\r\nvar->enable = bcom_eng->regs_base +\r\noffsetof(struct mpc52xx_sdma, tcr[tsk->tasknum]);\r\nvar->bd_base = tsk->bd_pa;\r\nvar->bd_last = tsk->bd_pa + ((tsk->num_bd-1) * tsk->bd_size);\r\nvar->bd_start = tsk->bd_pa;\r\nvar->buffer_size = maxbufsize;\r\nbcom_set_task_pragma(tsk->tasknum, BCOM_ATA_PRAGMA);\r\nbcom_set_task_auto_start(tsk->tasknum, tsk->tasknum);\r\nout_8(&bcom_eng->regs->ipr[BCOM_INITIATOR_ATA_RX], BCOM_IPR_ATA_RX);\r\nout_8(&bcom_eng->regs->ipr[BCOM_INITIATOR_ATA_TX], BCOM_IPR_ATA_TX);\r\nout_be32(&bcom_eng->regs->IntPend, 1<<tsk->tasknum);\r\nreturn tsk;\r\n}\r\nvoid bcom_ata_rx_prepare(struct bcom_task *tsk)\r\n{\r\nstruct bcom_ata_inc *inc;\r\ninc = (struct bcom_ata_inc *) bcom_task_inc(tsk->tasknum);\r\ninc->incr_bytes = -(s16)sizeof(u32);\r\ninc->incr_src = 0;\r\ninc->incr_dst = sizeof(u32);\r\nbcom_set_initiator(tsk->tasknum, BCOM_INITIATOR_ATA_RX);\r\n}\r\nvoid bcom_ata_tx_prepare(struct bcom_task *tsk)\r\n{\r\nstruct bcom_ata_inc *inc;\r\ninc = (struct bcom_ata_inc *) bcom_task_inc(tsk->tasknum);\r\ninc->incr_bytes = -(s16)sizeof(u32);\r\ninc->incr_src = sizeof(u32);\r\ninc->incr_dst = 0;\r\nbcom_set_initiator(tsk->tasknum, BCOM_INITIATOR_ATA_TX);\r\n}\r\nvoid bcom_ata_reset_bd(struct bcom_task *tsk)\r\n{\r\nstruct bcom_ata_var *var;\r\nmemset(tsk->bd, 0x00, tsk->num_bd * tsk->bd_size);\r\ntsk->index = 0;\r\ntsk->outdex = 0;\r\nvar = (struct bcom_ata_var *) bcom_task_var(tsk->tasknum);\r\nvar->bd_start = var->bd_base;\r\n}\r\nvoid bcom_ata_release(struct bcom_task *tsk)\r\n{\r\nbcom_task_free(tsk);\r\n}

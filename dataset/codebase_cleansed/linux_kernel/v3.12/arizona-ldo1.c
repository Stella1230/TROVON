static int arizona_ldo1_hc_list_voltage(struct regulator_dev *rdev,\r\nunsigned int selector)\r\n{\r\nif (selector >= rdev->desc->n_voltages)\r\nreturn -EINVAL;\r\nif (selector == rdev->desc->n_voltages - 1)\r\nreturn 1800000;\r\nelse\r\nreturn rdev->desc->min_uV + (rdev->desc->uV_step * selector);\r\n}\r\nstatic int arizona_ldo1_hc_map_voltage(struct regulator_dev *rdev,\r\nint min_uV, int max_uV)\r\n{\r\nint sel;\r\nsel = DIV_ROUND_UP(min_uV - rdev->desc->min_uV, rdev->desc->uV_step);\r\nif (sel >= rdev->desc->n_voltages)\r\nsel = rdev->desc->n_voltages - 1;\r\nreturn sel;\r\n}\r\nstatic int arizona_ldo1_hc_set_voltage_sel(struct regulator_dev *rdev,\r\nunsigned sel)\r\n{\r\nstruct arizona_ldo1 *ldo = rdev_get_drvdata(rdev);\r\nstruct regmap *regmap = ldo->arizona->regmap;\r\nunsigned int val;\r\nint ret;\r\nif (sel == rdev->desc->n_voltages - 1)\r\nval = ARIZONA_LDO1_HI_PWR;\r\nelse\r\nval = 0;\r\nret = regmap_update_bits(regmap, ARIZONA_LDO1_CONTROL_2,\r\nARIZONA_LDO1_HI_PWR, val);\r\nif (ret != 0)\r\nreturn ret;\r\nret = regmap_update_bits(regmap, ARIZONA_DYNAMIC_FREQUENCY_SCALING_1,\r\nARIZONA_SUBSYS_MAX_FREQ, val);\r\nif (ret != 0)\r\nreturn ret;\r\nif (val)\r\nreturn 0;\r\nval = sel << ARIZONA_LDO1_VSEL_SHIFT;\r\nreturn regmap_update_bits(regmap, ARIZONA_LDO1_CONTROL_1,\r\nARIZONA_LDO1_VSEL_MASK, val);\r\n}\r\nstatic int arizona_ldo1_hc_get_voltage_sel(struct regulator_dev *rdev)\r\n{\r\nstruct arizona_ldo1 *ldo = rdev_get_drvdata(rdev);\r\nstruct regmap *regmap = ldo->arizona->regmap;\r\nunsigned int val;\r\nint ret;\r\nret = regmap_read(regmap, ARIZONA_LDO1_CONTROL_2, &val);\r\nif (ret != 0)\r\nreturn ret;\r\nif (val & ARIZONA_LDO1_HI_PWR)\r\nreturn rdev->desc->n_voltages - 1;\r\nret = regmap_read(regmap, ARIZONA_LDO1_CONTROL_1, &val);\r\nif (ret != 0)\r\nreturn ret;\r\nreturn (val & ARIZONA_LDO1_VSEL_MASK) >> ARIZONA_LDO1_VSEL_SHIFT;\r\n}\r\nstatic int arizona_ldo1_probe(struct platform_device *pdev)\r\n{\r\nstruct arizona *arizona = dev_get_drvdata(pdev->dev.parent);\r\nconst struct regulator_desc *desc;\r\nstruct regulator_config config = { };\r\nstruct arizona_ldo1 *ldo1;\r\nint ret;\r\nldo1 = devm_kzalloc(&pdev->dev, sizeof(*ldo1), GFP_KERNEL);\r\nif (ldo1 == NULL) {\r\ndev_err(&pdev->dev, "Unable to allocate private data\n");\r\nreturn -ENOMEM;\r\n}\r\nldo1->arizona = arizona;\r\nswitch (arizona->type) {\r\ncase WM5102:\r\ndesc = &arizona_ldo1_hc;\r\nldo1->init_data = arizona_ldo1_dvfs;\r\nbreak;\r\ndefault:\r\ndesc = &arizona_ldo1;\r\nldo1->init_data = arizona_ldo1_default;\r\nbreak;\r\n}\r\nldo1->init_data.consumer_supplies = &ldo1->supply;\r\nldo1->supply.supply = "DCVDD";\r\nldo1->supply.dev_name = dev_name(arizona->dev);\r\nconfig.dev = arizona->dev;\r\nconfig.driver_data = ldo1;\r\nconfig.regmap = arizona->regmap;\r\nconfig.ena_gpio = arizona->pdata.ldoena;\r\nif (arizona->pdata.ldo1)\r\nconfig.init_data = arizona->pdata.ldo1;\r\nelse\r\nconfig.init_data = &ldo1->init_data;\r\nldo1->regulator = regulator_register(desc, &config);\r\nif (IS_ERR(ldo1->regulator)) {\r\nret = PTR_ERR(ldo1->regulator);\r\ndev_err(arizona->dev, "Failed to register LDO1 supply: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nplatform_set_drvdata(pdev, ldo1);\r\nreturn 0;\r\n}\r\nstatic int arizona_ldo1_remove(struct platform_device *pdev)\r\n{\r\nstruct arizona_ldo1 *ldo1 = platform_get_drvdata(pdev);\r\nregulator_unregister(ldo1->regulator);\r\nreturn 0;\r\n}

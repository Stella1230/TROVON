void __init cw1200_sdio_set_platform_data(struct cw1200_platform_data_sdio *pdata)\r\n{\r\nglobal_plat_data = pdata;\r\n}\r\nstatic int cw1200_sdio_memcpy_fromio(struct hwbus_priv *self,\r\nunsigned int addr,\r\nvoid *dst, int count)\r\n{\r\nreturn sdio_memcpy_fromio(self->func, dst, addr, count);\r\n}\r\nstatic int cw1200_sdio_memcpy_toio(struct hwbus_priv *self,\r\nunsigned int addr,\r\nconst void *src, int count)\r\n{\r\nreturn sdio_memcpy_toio(self->func, addr, (void *)src, count);\r\n}\r\nstatic void cw1200_sdio_lock(struct hwbus_priv *self)\r\n{\r\nsdio_claim_host(self->func);\r\n}\r\nstatic void cw1200_sdio_unlock(struct hwbus_priv *self)\r\n{\r\nsdio_release_host(self->func);\r\n}\r\nstatic void cw1200_sdio_irq_handler(struct sdio_func *func)\r\n{\r\nstruct hwbus_priv *self = sdio_get_drvdata(func);\r\nif (self->core)\r\ncw1200_irq_handler(self->core);\r\n}\r\nstatic irqreturn_t cw1200_gpio_hardirq(int irq, void *dev_id)\r\n{\r\nreturn IRQ_WAKE_THREAD;\r\n}\r\nstatic irqreturn_t cw1200_gpio_irq(int irq, void *dev_id)\r\n{\r\nstruct hwbus_priv *self = dev_id;\r\nif (self->core) {\r\nsdio_claim_host(self->func);\r\ncw1200_irq_handler(self->core);\r\nsdio_release_host(self->func);\r\nreturn IRQ_HANDLED;\r\n} else {\r\nreturn IRQ_NONE;\r\n}\r\n}\r\nstatic int cw1200_request_irq(struct hwbus_priv *self)\r\n{\r\nint ret;\r\nu8 cccr;\r\ncccr = sdio_f0_readb(self->func, SDIO_CCCR_IENx, &ret);\r\nif (WARN_ON(ret))\r\ngoto err;\r\ncccr |= BIT(0);\r\ncccr |= BIT(self->func->num);\r\nsdio_f0_writeb(self->func, cccr, SDIO_CCCR_IENx, &ret);\r\nif (WARN_ON(ret))\r\ngoto err;\r\nret = enable_irq_wake(self->pdata->irq);\r\nif (WARN_ON(ret))\r\ngoto err;\r\nret = request_threaded_irq(self->pdata->irq, cw1200_gpio_hardirq,\r\ncw1200_gpio_irq,\r\nIRQF_TRIGGER_HIGH | IRQF_ONESHOT,\r\n"cw1200_wlan_irq", self);\r\nif (WARN_ON(ret))\r\ngoto err;\r\nreturn 0;\r\nerr:\r\nreturn ret;\r\n}\r\nstatic int cw1200_sdio_irq_subscribe(struct hwbus_priv *self)\r\n{\r\nint ret = 0;\r\npr_debug("SW IRQ subscribe\n");\r\nsdio_claim_host(self->func);\r\nif (self->pdata->irq)\r\nret = cw1200_request_irq(self);\r\nelse\r\nret = sdio_claim_irq(self->func, cw1200_sdio_irq_handler);\r\nsdio_release_host(self->func);\r\nreturn ret;\r\n}\r\nstatic int cw1200_sdio_irq_unsubscribe(struct hwbus_priv *self)\r\n{\r\nint ret = 0;\r\npr_debug("SW IRQ unsubscribe\n");\r\nif (self->pdata->irq) {\r\ndisable_irq_wake(self->pdata->irq);\r\nfree_irq(self->pdata->irq, self);\r\n} else {\r\nsdio_claim_host(self->func);\r\nret = sdio_release_irq(self->func);\r\nsdio_release_host(self->func);\r\n}\r\nreturn ret;\r\n}\r\nstatic int cw1200_sdio_off(const struct cw1200_platform_data_sdio *pdata)\r\n{\r\nif (pdata->reset) {\r\ngpio_set_value(pdata->reset, 0);\r\nmsleep(30);\r\ngpio_free(pdata->reset);\r\n}\r\nif (pdata->power_ctrl)\r\npdata->power_ctrl(pdata, false);\r\nif (pdata->clk_ctrl)\r\npdata->clk_ctrl(pdata, false);\r\nreturn 0;\r\n}\r\nstatic int cw1200_sdio_on(const struct cw1200_platform_data_sdio *pdata)\r\n{\r\nif (pdata->reset) {\r\ngpio_request(pdata->reset, "cw1200_wlan_reset");\r\ngpio_direction_output(pdata->reset, 0);\r\n}\r\nif (pdata->powerup) {\r\ngpio_request(pdata->powerup, "cw1200_wlan_powerup");\r\ngpio_direction_output(pdata->powerup, 0);\r\n}\r\nif (pdata->reset || pdata->powerup)\r\nmsleep(10);\r\nif (pdata->power_ctrl) {\r\nif (pdata->power_ctrl(pdata, true)) {\r\npr_err("power_ctrl() failed!\n");\r\nreturn -1;\r\n}\r\n}\r\nif (pdata->clk_ctrl) {\r\nif (pdata->clk_ctrl(pdata, true)) {\r\npr_err("clk_ctrl() failed!\n");\r\nreturn -1;\r\n}\r\nmsleep(10);\r\n}\r\nif (pdata->powerup) {\r\ngpio_set_value(pdata->powerup, 1);\r\nmsleep(250);\r\n}\r\nif (pdata->reset) {\r\ngpio_set_value(pdata->reset, 1);\r\nmsleep(50);\r\n}\r\nreturn 0;\r\n}\r\nstatic size_t cw1200_sdio_align_size(struct hwbus_priv *self, size_t size)\r\n{\r\nif (self->pdata->no_nptb)\r\nsize = round_up(size, SDIO_BLOCK_SIZE);\r\nelse\r\nsize = sdio_align_size(self->func, size);\r\nreturn size;\r\n}\r\nstatic int cw1200_sdio_pm(struct hwbus_priv *self, bool suspend)\r\n{\r\nint ret = 0;\r\nif (self->pdata->irq)\r\nret = irq_set_irq_wake(self->pdata->irq, suspend);\r\nreturn ret;\r\n}\r\nstatic int cw1200_sdio_probe(struct sdio_func *func,\r\nconst struct sdio_device_id *id)\r\n{\r\nstruct hwbus_priv *self;\r\nint status;\r\npr_info("cw1200_wlan_sdio: Probe called\n");\r\nif (func->num != 0x01)\r\nreturn -ENODEV;\r\nself = kzalloc(sizeof(*self), GFP_KERNEL);\r\nif (!self) {\r\npr_err("Can't allocate SDIO hwbus_priv.\n");\r\nreturn -ENOMEM;\r\n}\r\nfunc->card->quirks |= MMC_QUIRK_LENIENT_FN0;\r\nself->pdata = global_plat_data;\r\nself->func = func;\r\nsdio_set_drvdata(func, self);\r\nsdio_claim_host(func);\r\nsdio_enable_func(func);\r\nsdio_release_host(func);\r\nstatus = cw1200_sdio_irq_subscribe(self);\r\nstatus = cw1200_core_probe(&cw1200_sdio_hwbus_ops,\r\nself, &func->dev, &self->core,\r\nself->pdata->ref_clk,\r\nself->pdata->macaddr,\r\nself->pdata->sdd_file,\r\nself->pdata->have_5ghz);\r\nif (status) {\r\ncw1200_sdio_irq_unsubscribe(self);\r\nsdio_claim_host(func);\r\nsdio_disable_func(func);\r\nsdio_release_host(func);\r\nsdio_set_drvdata(func, NULL);\r\nkfree(self);\r\n}\r\nreturn status;\r\n}\r\nstatic void cw1200_sdio_disconnect(struct sdio_func *func)\r\n{\r\nstruct hwbus_priv *self = sdio_get_drvdata(func);\r\nif (self) {\r\ncw1200_sdio_irq_unsubscribe(self);\r\nif (self->core) {\r\ncw1200_core_release(self->core);\r\nself->core = NULL;\r\n}\r\nsdio_claim_host(func);\r\nsdio_disable_func(func);\r\nsdio_release_host(func);\r\nsdio_set_drvdata(func, NULL);\r\nkfree(self);\r\n}\r\n}\r\nstatic int cw1200_sdio_suspend(struct device *dev)\r\n{\r\nint ret;\r\nstruct sdio_func *func = dev_to_sdio_func(dev);\r\nstruct hwbus_priv *self = sdio_get_drvdata(func);\r\nif (!cw1200_can_suspend(self->core))\r\nreturn -EAGAIN;\r\nret = sdio_set_host_pm_flags(func, MMC_PM_KEEP_POWER);\r\nif (ret)\r\npr_err("Error setting SDIO pm flags: %i\n", ret);\r\nreturn ret;\r\n}\r\nstatic int cw1200_sdio_resume(struct device *dev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int __init cw1200_sdio_init(void)\r\n{\r\nconst struct cw1200_platform_data_sdio *pdata;\r\nint ret;\r\npdata = global_plat_data;\r\nif (cw1200_sdio_on(pdata)) {\r\nret = -1;\r\ngoto err;\r\n}\r\nret = sdio_register_driver(&sdio_driver);\r\nif (ret)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\ncw1200_sdio_off(pdata);\r\nreturn ret;\r\n}\r\nstatic void __exit cw1200_sdio_exit(void)\r\n{\r\nconst struct cw1200_platform_data_sdio *pdata;\r\npdata = global_plat_data;\r\nsdio_unregister_driver(&sdio_driver);\r\ncw1200_sdio_off(pdata);\r\n}

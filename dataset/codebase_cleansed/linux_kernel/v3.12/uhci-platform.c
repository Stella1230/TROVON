static int uhci_platform_init(struct usb_hcd *hcd)\r\n{\r\nstruct uhci_hcd *uhci = hcd_to_uhci(hcd);\r\nuhci->rh_numports = uhci_count_ports(hcd);\r\nuhci->reset_hc = uhci_generic_reset_hc;\r\nuhci->check_and_reset_hc = uhci_generic_check_and_reset_hc;\r\nuhci->configure_hc = NULL;\r\nuhci->resume_detect_interrupts_are_broken = NULL;\r\nuhci->global_suspend_mode_is_broken = NULL;\r\ncheck_and_reset_hc(uhci);\r\nreturn 0;\r\n}\r\nstatic int uhci_hcd_platform_probe(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd;\r\nstruct uhci_hcd *uhci;\r\nstruct resource *res;\r\nint ret;\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\nif (!pdev->dev.dma_mask)\r\npdev->dev.dma_mask = &pdev->dev.coherent_dma_mask;\r\nif (!pdev->dev.coherent_dma_mask)\r\npdev->dev.coherent_dma_mask = DMA_BIT_MASK(32);\r\nhcd = usb_create_hcd(&uhci_platform_hc_driver, &pdev->dev,\r\npdev->name);\r\nif (!hcd)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nhcd->rsrc_start = res->start;\r\nhcd->rsrc_len = resource_size(res);\r\nif (!request_mem_region(hcd->rsrc_start, hcd->rsrc_len, hcd_name)) {\r\npr_err("%s: request_mem_region failed\n", __func__);\r\nret = -EBUSY;\r\ngoto err_rmr;\r\n}\r\nhcd->regs = ioremap(hcd->rsrc_start, hcd->rsrc_len);\r\nif (!hcd->regs) {\r\npr_err("%s: ioremap failed\n", __func__);\r\nret = -ENOMEM;\r\ngoto err_irq;\r\n}\r\nuhci = hcd_to_uhci(hcd);\r\nuhci->regs = hcd->regs;\r\nret = usb_add_hcd(hcd, pdev->resource[1].start, IRQF_DISABLED |\r\nIRQF_SHARED);\r\nif (ret)\r\ngoto err_uhci;\r\nreturn 0;\r\nerr_uhci:\r\niounmap(hcd->regs);\r\nerr_irq:\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nerr_rmr:\r\nusb_put_hcd(hcd);\r\nreturn ret;\r\n}\r\nstatic int uhci_hcd_platform_remove(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nusb_remove_hcd(hcd);\r\niounmap(hcd->regs);\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nusb_put_hcd(hcd);\r\nreturn 0;\r\n}\r\nstatic void uhci_hcd_platform_shutdown(struct platform_device *op)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(op);\r\nuhci_hc_died(hcd_to_uhci(hcd));\r\n}

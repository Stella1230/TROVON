static int __init rc32434_pcibridge_init(void)\r\n{\r\nunsigned int pcicvalue, pcicdata = 0;\r\nunsigned int dummyread, pcicntlval;\r\nint loopCount;\r\nunsigned int pci_config_addr;\r\npcicvalue = rc32434_pci->pcic;\r\npcicvalue = (pcicvalue >> PCIM_SHFT) & PCIM_BIT_LEN;\r\nif (!((pcicvalue == PCIM_H_EA) ||\r\n(pcicvalue == PCIM_H_IA_FIX) ||\r\n(pcicvalue == PCIM_H_IA_RR))) {\r\npr_err("PCI init error!!!\n");\r\nreturn -1;\r\n}\r\npcicdata |= (PCI_CTL_IGM | PCI_CTL_EAP | PCI_CTL_EN);\r\nrc32434_pci->pcic = pcicdata;\r\nfor (;;) {\r\npcicdata = rc32434_pci->pcis;\r\nif (!(pcicdata & PCI_STAT_RIP))\r\nbreak;\r\n}\r\nrc32434_pci->pcis = 0;\r\nrc32434_pci->pcism = 0xFFFFFFFF;\r\nrc32434_pci->pcidac = 0;\r\nrc32434_pci->pcidas = 0;\r\nrc32434_pci->pcidasm = 0x0000007F;\r\nrc32434_pci_msg->pciiic = 0;\r\nrc32434_pci_msg->pciiim = 0xFFFFFFFF;\r\nrc32434_pci_msg->pciioic = 0;\r\nrc32434_pci_msg->pciioim = 0;\r\nrc32434_pci->pcilba[0].address = (unsigned int) (PCI_ADDR_START);\r\nrc32434_pci->pcilba[0].mapping = (unsigned int) (PCI_ADDR_START);\r\nrc32434_pci->pcilba[0].control =\r\n(((SIZE_256MB & 0x1f) << PCI_LBAC_SIZE_BIT) | PCI_ENDIAN_FLAG);\r\ndummyread = rc32434_pci->pcilba[0].control;\r\nrc32434_pci->pcilba[1].address = 0x60000000;\r\nrc32434_pci->pcilba[1].mapping = 0x60000000;\r\nrc32434_pci->pcilba[1].control =\r\n(((SIZE_256MB & 0x1f) << PCI_LBAC_SIZE_BIT) | PCI_ENDIAN_FLAG);\r\ndummyread = rc32434_pci->pcilba[1].control;\r\nrc32434_pci->pcilba[2].address = 0x18C00000;\r\nrc32434_pci->pcilba[2].mapping = 0x18FFFFFF;\r\nrc32434_pci->pcilba[2].control =\r\n(((SIZE_4MB & 0x1f) << PCI_LBAC_SIZE_BIT) | PCI_ENDIAN_FLAG);\r\ndummyread = rc32434_pci->pcilba[2].control;\r\nrc32434_pci->pcilba[3].address = 0x18800000;\r\nrc32434_pci->pcilba[3].mapping = 0x18800000;\r\nrc32434_pci->pcilba[3].control =\r\n((((SIZE_1MB & 0x1ff) << PCI_LBAC_SIZE_BIT) | PCI_LBAC_MSI) |\r\nPCI_ENDIAN_FLAG);\r\ndummyread = rc32434_pci->pcilba[3].control;\r\npci_config_addr = (unsigned int) (0x80000004);\r\nfor (loopCount = 0; loopCount < 24; loopCount++) {\r\nrc32434_pci->pcicfga = pci_config_addr;\r\ndummyread = rc32434_pci->pcicfga;\r\nrc32434_pci->pcicfgd = korina_cnfg_regs[loopCount];\r\ndummyread = rc32434_pci->pcicfgd;\r\npci_config_addr += 4;\r\n}\r\nrc32434_pci->pcitc =\r\n(unsigned int) ((PCITC_RTIMER_VAL & 0xff) << PCI_TC_RTIMER_BIT) |\r\n((PCITC_DTIMER_VAL & 0xff) << PCI_TC_DTIMER_BIT);\r\npcicntlval = rc32434_pci->pcic;\r\npcicntlval &= ~PCI_CTL_TNR;\r\nrc32434_pci->pcic = pcicntlval;\r\npcicntlval = rc32434_pci->pcic;\r\nreturn 0;\r\n}\r\nstatic int __init rc32434_pci_init(void)\r\n{\r\nvoid __iomem *io_map_base;\r\npr_info("PCI: Initializing PCI\n");\r\nioport_resource.start = rc32434_res_pci_io1.start;\r\nioport_resource.end = rc32434_res_pci_io1.end;\r\nrc32434_pcibridge_init();\r\nio_map_base = ioremap(rc32434_res_pci_io1.start,\r\nresource_size(&rc32434_res_pci_io1));\r\nif (!io_map_base)\r\nreturn -ENOMEM;\r\nrc32434_controller.io_map_base =\r\n(unsigned long)io_map_base - rc32434_res_pci_io1.start;\r\nregister_pci_controller(&rc32434_controller);\r\nrc32434_sync();\r\nreturn 0;\r\n}

void dm_disk_bitset_init(struct dm_transaction_manager *tm,\r\nstruct dm_disk_bitset *info)\r\n{\r\ndm_array_info_init(&info->array_info, tm, &bitset_bvt);\r\ninfo->current_index_set = false;\r\n}\r\nint dm_bitset_empty(struct dm_disk_bitset *info, dm_block_t *root)\r\n{\r\nreturn dm_array_empty(&info->array_info, root);\r\n}\r\nint dm_bitset_resize(struct dm_disk_bitset *info, dm_block_t root,\r\nuint32_t old_nr_entries, uint32_t new_nr_entries,\r\nbool default_value, dm_block_t *new_root)\r\n{\r\nuint32_t old_blocks = dm_div_up(old_nr_entries, BITS_PER_ARRAY_ENTRY);\r\nuint32_t new_blocks = dm_div_up(new_nr_entries, BITS_PER_ARRAY_ENTRY);\r\n__le64 value = default_value ? cpu_to_le64(~0) : cpu_to_le64(0);\r\n__dm_bless_for_disk(&value);\r\nreturn dm_array_resize(&info->array_info, root, old_blocks, new_blocks,\r\n&value, new_root);\r\n}\r\nint dm_bitset_del(struct dm_disk_bitset *info, dm_block_t root)\r\n{\r\nreturn dm_array_del(&info->array_info, root);\r\n}\r\nint dm_bitset_flush(struct dm_disk_bitset *info, dm_block_t root,\r\ndm_block_t *new_root)\r\n{\r\nint r;\r\n__le64 value;\r\nif (!info->current_index_set)\r\nreturn 0;\r\nvalue = cpu_to_le64(info->current_bits);\r\n__dm_bless_for_disk(&value);\r\nr = dm_array_set_value(&info->array_info, root, info->current_index,\r\n&value, new_root);\r\nif (r)\r\nreturn r;\r\ninfo->current_index_set = false;\r\nreturn 0;\r\n}\r\nstatic int read_bits(struct dm_disk_bitset *info, dm_block_t root,\r\nuint32_t array_index)\r\n{\r\nint r;\r\n__le64 value;\r\nr = dm_array_get_value(&info->array_info, root, array_index, &value);\r\nif (r)\r\nreturn r;\r\ninfo->current_bits = le64_to_cpu(value);\r\ninfo->current_index_set = true;\r\ninfo->current_index = array_index;\r\nreturn 0;\r\n}\r\nstatic int get_array_entry(struct dm_disk_bitset *info, dm_block_t root,\r\nuint32_t index, dm_block_t *new_root)\r\n{\r\nint r;\r\nunsigned array_index = index / BITS_PER_ARRAY_ENTRY;\r\nif (info->current_index_set) {\r\nif (info->current_index == array_index)\r\nreturn 0;\r\nr = dm_bitset_flush(info, root, new_root);\r\nif (r)\r\nreturn r;\r\n}\r\nreturn read_bits(info, root, array_index);\r\n}\r\nint dm_bitset_set_bit(struct dm_disk_bitset *info, dm_block_t root,\r\nuint32_t index, dm_block_t *new_root)\r\n{\r\nint r;\r\nunsigned b = index % BITS_PER_ARRAY_ENTRY;\r\nr = get_array_entry(info, root, index, new_root);\r\nif (r)\r\nreturn r;\r\nset_bit(b, (unsigned long *) &info->current_bits);\r\nreturn 0;\r\n}\r\nint dm_bitset_clear_bit(struct dm_disk_bitset *info, dm_block_t root,\r\nuint32_t index, dm_block_t *new_root)\r\n{\r\nint r;\r\nunsigned b = index % BITS_PER_ARRAY_ENTRY;\r\nr = get_array_entry(info, root, index, new_root);\r\nif (r)\r\nreturn r;\r\nclear_bit(b, (unsigned long *) &info->current_bits);\r\nreturn 0;\r\n}\r\nint dm_bitset_test_bit(struct dm_disk_bitset *info, dm_block_t root,\r\nuint32_t index, dm_block_t *new_root, bool *result)\r\n{\r\nint r;\r\nunsigned b = index % BITS_PER_ARRAY_ENTRY;\r\nr = get_array_entry(info, root, index, new_root);\r\nif (r)\r\nreturn r;\r\n*result = test_bit(b, (unsigned long *) &info->current_bits);\r\nreturn 0;\r\n}

int adis16400_update_scan_mode(struct iio_dev *indio_dev,\r\nconst unsigned long *scan_mask)\r\n{\r\nstruct adis16400_state *st = iio_priv(indio_dev);\r\nstruct adis *adis = &st->adis;\r\nuint16_t *tx, *rx;\r\nif (st->variant->flags & ADIS16400_NO_BURST)\r\nreturn adis_update_scan_mode(indio_dev, scan_mask);\r\nkfree(adis->xfer);\r\nkfree(adis->buffer);\r\nadis->xfer = kcalloc(2, sizeof(*adis->xfer), GFP_KERNEL);\r\nif (!adis->xfer)\r\nreturn -ENOMEM;\r\nadis->buffer = kzalloc(indio_dev->scan_bytes + sizeof(u16),\r\nGFP_KERNEL);\r\nif (!adis->buffer)\r\nreturn -ENOMEM;\r\nrx = adis->buffer;\r\ntx = adis->buffer + indio_dev->scan_bytes;\r\ntx[0] = ADIS_READ_REG(ADIS16400_GLOB_CMD);\r\ntx[1] = 0;\r\nadis->xfer[0].tx_buf = tx;\r\nadis->xfer[0].bits_per_word = 8;\r\nadis->xfer[0].len = 2;\r\nadis->xfer[1].tx_buf = tx;\r\nadis->xfer[1].bits_per_word = 8;\r\nadis->xfer[1].len = indio_dev->scan_bytes;\r\nspi_message_init(&adis->msg);\r\nspi_message_add_tail(&adis->xfer[0], &adis->msg);\r\nspi_message_add_tail(&adis->xfer[1], &adis->msg);\r\nreturn 0;\r\n}\r\nirqreturn_t adis16400_trigger_handler(int irq, void *p)\r\n{\r\nstruct iio_poll_func *pf = p;\r\nstruct iio_dev *indio_dev = pf->indio_dev;\r\nstruct adis16400_state *st = iio_priv(indio_dev);\r\nstruct adis *adis = &st->adis;\r\nu32 old_speed_hz = st->adis.spi->max_speed_hz;\r\nint ret;\r\nif (!adis->buffer)\r\nreturn -ENOMEM;\r\nif (!(st->variant->flags & ADIS16400_NO_BURST) &&\r\nst->adis.spi->max_speed_hz > ADIS16400_SPI_BURST) {\r\nst->adis.spi->max_speed_hz = ADIS16400_SPI_BURST;\r\nspi_setup(st->adis.spi);\r\n}\r\nret = spi_sync(adis->spi, &adis->msg);\r\nif (ret)\r\ndev_err(&adis->spi->dev, "Failed to read data: %d\n", ret);\r\nif (!(st->variant->flags & ADIS16400_NO_BURST)) {\r\nst->adis.spi->max_speed_hz = old_speed_hz;\r\nspi_setup(st->adis.spi);\r\n}\r\nif (indio_dev->scan_timestamp) {\r\nvoid *b = adis->buffer + indio_dev->scan_bytes - sizeof(s64);\r\n*(s64 *)b = pf->timestamp;\r\n}\r\niio_push_to_buffers(indio_dev, adis->buffer);\r\niio_trigger_notify_done(indio_dev->trig);\r\nreturn IRQ_HANDLED;\r\n}

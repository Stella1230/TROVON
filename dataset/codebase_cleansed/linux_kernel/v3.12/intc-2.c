static void intc_irq_mask(struct irq_data *d)\r\n{\r\nunsigned int irq = d->irq - MCFINT_VECBASE;\r\nunsigned long imraddr;\r\nu32 val, imrbit;\r\n#ifdef MCFICM_INTC1\r\nimraddr = (irq & 0x40) ? MCFICM_INTC1 : MCFICM_INTC0;\r\n#else\r\nimraddr = MCFICM_INTC0;\r\n#endif\r\nimraddr += (irq & 0x20) ? MCFINTC_IMRH : MCFINTC_IMRL;\r\nimrbit = 0x1 << (irq & 0x1f);\r\nval = __raw_readl(imraddr);\r\n__raw_writel(val | imrbit, imraddr);\r\n}\r\nstatic void intc_irq_unmask(struct irq_data *d)\r\n{\r\nunsigned int irq = d->irq - MCFINT_VECBASE;\r\nunsigned long imraddr;\r\nu32 val, imrbit;\r\n#ifdef MCFICM_INTC1\r\nimraddr = (irq & 0x40) ? MCFICM_INTC1 : MCFICM_INTC0;\r\n#else\r\nimraddr = MCFICM_INTC0;\r\n#endif\r\nimraddr += ((irq & 0x20) ? MCFINTC_IMRH : MCFINTC_IMRL);\r\nimrbit = 0x1 << (irq & 0x1f);\r\nif ((irq & 0x20) == 0)\r\nimrbit |= 0x1;\r\nval = __raw_readl(imraddr);\r\n__raw_writel(val & ~imrbit, imraddr);\r\n}\r\nstatic void intc_irq_ack(struct irq_data *d)\r\n{\r\nunsigned int irq = d->irq;\r\n__raw_writeb(0x1 << (irq - EINT0), MCFEPORT_EPFR);\r\n}\r\nstatic unsigned int intc_irq_startup(struct irq_data *d)\r\n{\r\nunsigned int irq = d->irq - MCFINT_VECBASE;\r\nunsigned long icraddr;\r\n#ifdef MCFICM_INTC1\r\nicraddr = (irq & 0x40) ? MCFICM_INTC1 : MCFICM_INTC0;\r\n#else\r\nicraddr = MCFICM_INTC0;\r\n#endif\r\nicraddr += MCFINTC_ICR0 + (irq & 0x3f);\r\nif (__raw_readb(icraddr) == 0)\r\n__raw_writeb(intc_intpri--, icraddr);\r\nirq = d->irq;\r\nif ((irq >= EINT1) && (irq <= EINT7)) {\r\nu8 v;\r\nirq -= EINT0;\r\nv = __raw_readb(MCFEPORT_EPDDR);\r\n__raw_writeb(v & ~(0x1 << irq), MCFEPORT_EPDDR);\r\nv = __raw_readb(MCFEPORT_EPIER);\r\n__raw_writeb(v | (0x1 << irq), MCFEPORT_EPIER);\r\n}\r\nintc_irq_unmask(d);\r\nreturn 0;\r\n}\r\nstatic int intc_irq_set_type(struct irq_data *d, unsigned int type)\r\n{\r\nunsigned int irq = d->irq;\r\nu16 pa, tb;\r\nswitch (type) {\r\ncase IRQ_TYPE_EDGE_RISING:\r\ntb = 0x1;\r\nbreak;\r\ncase IRQ_TYPE_EDGE_FALLING:\r\ntb = 0x2;\r\nbreak;\r\ncase IRQ_TYPE_EDGE_BOTH:\r\ntb = 0x3;\r\nbreak;\r\ndefault:\r\ntb = 0;\r\nbreak;\r\n}\r\nif (tb)\r\nirq_set_handler(irq, handle_edge_irq);\r\nirq -= EINT0;\r\npa = __raw_readw(MCFEPORT_EPPAR);\r\npa = (pa & ~(0x3 << (irq * 2))) | (tb << (irq * 2));\r\n__raw_writew(pa, MCFEPORT_EPPAR);\r\nreturn 0;\r\n}\r\nvoid __init init_IRQ(void)\r\n{\r\nint irq;\r\n__raw_writel(0x1, MCFICM_INTC0 + MCFINTC_IMRL);\r\n#ifdef MCFICM_INTC1\r\n__raw_writel(0x1, MCFICM_INTC1 + MCFINTC_IMRL);\r\n#endif\r\nfor (irq = MCFINT_VECBASE; (irq < MCFINT_VECBASE + NR_VECS); irq++) {\r\nif ((irq >= EINT1) && (irq <=EINT7))\r\nirq_set_chip(irq, &intc_irq_chip_edge_port);\r\nelse\r\nirq_set_chip(irq, &intc_irq_chip);\r\nirq_set_irq_type(irq, IRQ_TYPE_LEVEL_HIGH);\r\nirq_set_handler(irq, handle_level_irq);\r\n}\r\n}

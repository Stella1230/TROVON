static int fnic_trace_ctrl_open(struct inode *inode, struct file *filp)\r\n{\r\nfilp->private_data = inode->i_private;\r\nreturn 0;\r\n}\r\nstatic ssize_t fnic_trace_ctrl_read(struct file *filp,\r\nchar __user *ubuf,\r\nsize_t cnt, loff_t *ppos)\r\n{\r\nchar buf[64];\r\nint len;\r\nlen = sprintf(buf, "%u\n", fnic_tracing_enabled);\r\nreturn simple_read_from_buffer(ubuf, cnt, ppos, buf, len);\r\n}\r\nstatic ssize_t fnic_trace_ctrl_write(struct file *filp,\r\nconst char __user *ubuf,\r\nsize_t cnt, loff_t *ppos)\r\n{\r\nchar buf[64];\r\nunsigned long val;\r\nint ret;\r\nif (cnt >= sizeof(buf))\r\nreturn -EINVAL;\r\nif (copy_from_user(&buf, ubuf, cnt))\r\nreturn -EFAULT;\r\nbuf[cnt] = 0;\r\nret = kstrtoul(buf, 10, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nfnic_tracing_enabled = val;\r\n(*ppos)++;\r\nreturn cnt;\r\n}\r\nstatic int fnic_trace_debugfs_open(struct inode *inode,\r\nstruct file *file)\r\n{\r\nfnic_dbgfs_t *fnic_dbg_prt;\r\nfnic_dbg_prt = kzalloc(sizeof(fnic_dbgfs_t), GFP_KERNEL);\r\nif (!fnic_dbg_prt)\r\nreturn -ENOMEM;\r\nfnic_dbg_prt->buffer = vmalloc((3*(trace_max_pages * PAGE_SIZE)));\r\nif (!fnic_dbg_prt->buffer) {\r\nkfree(fnic_dbg_prt);\r\nreturn -ENOMEM;\r\n}\r\nmemset((void *)fnic_dbg_prt->buffer, 0,\r\n(3*(trace_max_pages * PAGE_SIZE)));\r\nfnic_dbg_prt->buffer_len = fnic_get_trace_data(fnic_dbg_prt);\r\nfile->private_data = fnic_dbg_prt;\r\nreturn 0;\r\n}\r\nstatic loff_t fnic_trace_debugfs_lseek(struct file *file,\r\nloff_t offset,\r\nint howto)\r\n{\r\nfnic_dbgfs_t *fnic_dbg_prt = file->private_data;\r\nreturn fixed_size_llseek(file, offset, howto,\r\nfnic_dbg_prt->buffer_len);\r\n}\r\nstatic ssize_t fnic_trace_debugfs_read(struct file *file,\r\nchar __user *ubuf,\r\nsize_t nbytes,\r\nloff_t *pos)\r\n{\r\nfnic_dbgfs_t *fnic_dbg_prt = file->private_data;\r\nint rc = 0;\r\nrc = simple_read_from_buffer(ubuf, nbytes, pos,\r\nfnic_dbg_prt->buffer,\r\nfnic_dbg_prt->buffer_len);\r\nreturn rc;\r\n}\r\nstatic int fnic_trace_debugfs_release(struct inode *inode,\r\nstruct file *file)\r\n{\r\nfnic_dbgfs_t *fnic_dbg_prt = file->private_data;\r\nvfree(fnic_dbg_prt->buffer);\r\nkfree(fnic_dbg_prt);\r\nreturn 0;\r\n}\r\nint fnic_trace_debugfs_init(void)\r\n{\r\nint rc = -1;\r\nfnic_trace_debugfs_root = debugfs_create_dir("fnic", NULL);\r\nif (!fnic_trace_debugfs_root) {\r\nprintk(KERN_DEBUG "Cannot create debugfs root\n");\r\nreturn rc;\r\n}\r\nfnic_trace_enable = debugfs_create_file("tracing_enable",\r\nS_IFREG|S_IRUGO|S_IWUSR,\r\nfnic_trace_debugfs_root,\r\nNULL, &fnic_trace_ctrl_fops);\r\nif (!fnic_trace_enable) {\r\nprintk(KERN_DEBUG "Cannot create trace_enable file"\r\n" under debugfs");\r\nreturn rc;\r\n}\r\nfnic_trace_debugfs_file = debugfs_create_file("trace",\r\nS_IFREG|S_IRUGO|S_IWUSR,\r\nfnic_trace_debugfs_root,\r\nNULL,\r\n&fnic_trace_debugfs_fops);\r\nif (!fnic_trace_debugfs_file) {\r\nprintk(KERN_DEBUG "Cannot create trace file under debugfs");\r\nreturn rc;\r\n}\r\nrc = 0;\r\nreturn rc;\r\n}\r\nvoid fnic_trace_debugfs_terminate(void)\r\n{\r\nif (fnic_trace_debugfs_file) {\r\ndebugfs_remove(fnic_trace_debugfs_file);\r\nfnic_trace_debugfs_file = NULL;\r\n}\r\nif (fnic_trace_enable) {\r\ndebugfs_remove(fnic_trace_enable);\r\nfnic_trace_enable = NULL;\r\n}\r\nif (fnic_trace_debugfs_root) {\r\ndebugfs_remove(fnic_trace_debugfs_root);\r\nfnic_trace_debugfs_root = NULL;\r\n}\r\n}

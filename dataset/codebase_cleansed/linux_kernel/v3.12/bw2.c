static int\r\nbw2_blank(int blank, struct fb_info *info)\r\n{\r\nstruct bw2_par *par = (struct bw2_par *) info->par;\r\nstruct bw2_regs __iomem *regs = par->regs;\r\nunsigned long flags;\r\nu8 val;\r\nspin_lock_irqsave(&par->lock, flags);\r\nswitch (blank) {\r\ncase FB_BLANK_UNBLANK:\r\nval = sbus_readb(&regs->control);\r\nval |= BWTWO_CTL_ENABLE_VIDEO;\r\nsbus_writeb(val, &regs->control);\r\npar->flags &= ~BW2_FLAG_BLANKED;\r\nbreak;\r\ncase FB_BLANK_NORMAL:\r\ncase FB_BLANK_VSYNC_SUSPEND:\r\ncase FB_BLANK_HSYNC_SUSPEND:\r\ncase FB_BLANK_POWERDOWN:\r\nval = sbus_readb(&regs->control);\r\nval &= ~BWTWO_CTL_ENABLE_VIDEO;\r\nsbus_writeb(val, &regs->control);\r\npar->flags |= BW2_FLAG_BLANKED;\r\nbreak;\r\n}\r\nspin_unlock_irqrestore(&par->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int bw2_mmap(struct fb_info *info, struct vm_area_struct *vma)\r\n{\r\nstruct bw2_par *par = (struct bw2_par *)info->par;\r\nreturn sbusfb_mmap_helper(bw2_mmap_map,\r\ninfo->fix.smem_start, info->fix.smem_len,\r\npar->which_io,\r\nvma);\r\n}\r\nstatic int bw2_ioctl(struct fb_info *info, unsigned int cmd, unsigned long arg)\r\n{\r\nreturn sbusfb_ioctl_helper(cmd, arg, info,\r\nFBTYPE_SUN2BW, 1, info->fix.smem_len);\r\n}\r\nstatic void bw2_init_fix(struct fb_info *info, int linebytes)\r\n{\r\nstrlcpy(info->fix.id, "bwtwo", sizeof(info->fix.id));\r\ninfo->fix.type = FB_TYPE_PACKED_PIXELS;\r\ninfo->fix.visual = FB_VISUAL_MONO01;\r\ninfo->fix.line_length = linebytes;\r\ninfo->fix.accel = FB_ACCEL_SUN_BWTWO;\r\n}\r\nstatic int bw2_do_default_mode(struct bw2_par *par, struct fb_info *info,\r\nint *linebytes)\r\n{\r\nu8 status, mon;\r\nu8 *p;\r\nstatus = sbus_readb(&par->regs->status);\r\nmon = status & BWTWO_SR_RES_MASK;\r\nswitch (status & BWTWO_SR_ID_MASK) {\r\ncase BWTWO_SR_ID_MONO_ECL:\r\nif (mon == BWTWO_SR_1600_1280) {\r\np = bw2regs_1600;\r\ninfo->var.xres = info->var.xres_virtual = 1600;\r\ninfo->var.yres = info->var.yres_virtual = 1280;\r\n*linebytes = 1600 / 8;\r\n} else\r\np = bw2regs_ecl;\r\nbreak;\r\ncase BWTWO_SR_ID_MONO:\r\np = bw2regs_analog;\r\nbreak;\r\ncase BWTWO_SR_ID_MSYNC:\r\nif (mon == BWTWO_SR_1152_900_76_A ||\r\nmon == BWTWO_SR_1152_900_76_B)\r\np = bw2regs_76hz;\r\nelse\r\np = bw2regs_66hz;\r\nbreak;\r\ncase BWTWO_SR_ID_NOCONN:\r\nreturn 0;\r\ndefault:\r\nprintk(KERN_ERR "bw2: can't handle SR %02x\n",\r\nstatus);\r\nreturn -EINVAL;\r\n}\r\nfor ( ; *p; p += 2) {\r\nu8 __iomem *regp = &((u8 __iomem *)par->regs)[p[0]];\r\nsbus_writeb(p[1], regp);\r\n}\r\nreturn 0;\r\n}\r\nstatic int bw2_probe(struct platform_device *op)\r\n{\r\nstruct device_node *dp = op->dev.of_node;\r\nstruct fb_info *info;\r\nstruct bw2_par *par;\r\nint linebytes, err;\r\ninfo = framebuffer_alloc(sizeof(struct bw2_par), &op->dev);\r\nerr = -ENOMEM;\r\nif (!info)\r\ngoto out_err;\r\npar = info->par;\r\nspin_lock_init(&par->lock);\r\ninfo->fix.smem_start = op->resource[0].start;\r\npar->which_io = op->resource[0].flags & IORESOURCE_BITS;\r\nsbusfb_fill_var(&info->var, dp, 1);\r\nlinebytes = of_getintprop_default(dp, "linebytes",\r\ninfo->var.xres);\r\ninfo->var.red.length = info->var.green.length =\r\ninfo->var.blue.length = info->var.bits_per_pixel;\r\ninfo->var.red.offset = info->var.green.offset =\r\ninfo->var.blue.offset = 0;\r\npar->regs = of_ioremap(&op->resource[0], BWTWO_REGISTER_OFFSET,\r\nsizeof(struct bw2_regs), "bw2 regs");\r\nif (!par->regs)\r\ngoto out_release_fb;\r\nif (!of_find_property(dp, "width", NULL)) {\r\nerr = bw2_do_default_mode(par, info, &linebytes);\r\nif (err)\r\ngoto out_unmap_regs;\r\n}\r\ninfo->fix.smem_len = PAGE_ALIGN(linebytes * info->var.yres);\r\ninfo->flags = FBINFO_DEFAULT;\r\ninfo->fbops = &bw2_ops;\r\ninfo->screen_base = of_ioremap(&op->resource[0], 0,\r\ninfo->fix.smem_len, "bw2 ram");\r\nif (!info->screen_base) {\r\nerr = -ENOMEM;\r\ngoto out_unmap_regs;\r\n}\r\nbw2_blank(FB_BLANK_UNBLANK, info);\r\nbw2_init_fix(info, linebytes);\r\nerr = register_framebuffer(info);\r\nif (err < 0)\r\ngoto out_unmap_screen;\r\ndev_set_drvdata(&op->dev, info);\r\nprintk(KERN_INFO "%s: bwtwo at %lx:%lx\n",\r\ndp->full_name, par->which_io, info->fix.smem_start);\r\nreturn 0;\r\nout_unmap_screen:\r\nof_iounmap(&op->resource[0], info->screen_base, info->fix.smem_len);\r\nout_unmap_regs:\r\nof_iounmap(&op->resource[0], par->regs, sizeof(struct bw2_regs));\r\nout_release_fb:\r\nframebuffer_release(info);\r\nout_err:\r\nreturn err;\r\n}\r\nstatic int bw2_remove(struct platform_device *op)\r\n{\r\nstruct fb_info *info = dev_get_drvdata(&op->dev);\r\nstruct bw2_par *par = info->par;\r\nunregister_framebuffer(info);\r\nof_iounmap(&op->resource[0], par->regs, sizeof(struct bw2_regs));\r\nof_iounmap(&op->resource[0], info->screen_base, info->fix.smem_len);\r\nframebuffer_release(info);\r\ndev_set_drvdata(&op->dev, NULL);\r\nreturn 0;\r\n}\r\nstatic int __init bw2_init(void)\r\n{\r\nif (fb_get_options("bw2fb", NULL))\r\nreturn -ENODEV;\r\nreturn platform_driver_register(&bw2_driver);\r\n}\r\nstatic void __exit bw2_exit(void)\r\n{\r\nplatform_driver_unregister(&bw2_driver);\r\n}

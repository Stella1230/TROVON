char *xstrdup(const char *s)\r\n{\r\nint len = strlen(s) + 1;\r\nchar *dup = xmalloc(len);\r\nmemcpy(dup, s, len);\r\nreturn dup;\r\n}\r\nchar *join_path(const char *path, const char *name)\r\n{\r\nint lenp = strlen(path);\r\nint lenn = strlen(name);\r\nint len;\r\nint needslash = 1;\r\nchar *str;\r\nlen = lenp + lenn + 2;\r\nif ((lenp > 0) && (path[lenp-1] == '/')) {\r\nneedslash = 0;\r\nlen--;\r\n}\r\nstr = xmalloc(len);\r\nmemcpy(str, path, lenp);\r\nif (needslash) {\r\nstr[lenp] = '/';\r\nlenp++;\r\n}\r\nmemcpy(str+lenp, name, lenn+1);\r\nreturn str;\r\n}\r\nint util_is_printable_string(const void *data, int len)\r\n{\r\nconst char *s = data;\r\nconst char *ss;\r\nif (len == 0)\r\nreturn 0;\r\nif (s[len - 1] != '\0')\r\nreturn 0;\r\nss = s;\r\nwhile (*s && isprint(*s))\r\ns++;\r\nif (*s != '\0' || (s + 1 - ss) < len)\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic char get_oct_char(const char *s, int *i)\r\n{\r\nchar x[4];\r\nchar *endx;\r\nlong val;\r\nx[3] = '\0';\r\nstrncpy(x, s + *i, 3);\r\nval = strtol(x, &endx, 8);\r\nassert(endx > x);\r\n(*i) += endx - x;\r\nreturn val;\r\n}\r\nstatic char get_hex_char(const char *s, int *i)\r\n{\r\nchar x[3];\r\nchar *endx;\r\nlong val;\r\nx[2] = '\0';\r\nstrncpy(x, s + *i, 2);\r\nval = strtol(x, &endx, 16);\r\nif (!(endx > x))\r\ndie("\\x used with no following hex digits\n");\r\n(*i) += endx - x;\r\nreturn val;\r\n}\r\nchar get_escape_char(const char *s, int *i)\r\n{\r\nchar c = s[*i];\r\nint j = *i + 1;\r\nchar val;\r\nassert(c);\r\nswitch (c) {\r\ncase 'a':\r\nval = '\a';\r\nbreak;\r\ncase 'b':\r\nval = '\b';\r\nbreak;\r\ncase 't':\r\nval = '\t';\r\nbreak;\r\ncase 'n':\r\nval = '\n';\r\nbreak;\r\ncase 'v':\r\nval = '\v';\r\nbreak;\r\ncase 'f':\r\nval = '\f';\r\nbreak;\r\ncase 'r':\r\nval = '\r';\r\nbreak;\r\ncase '0':\r\ncase '1':\r\ncase '2':\r\ncase '3':\r\ncase '4':\r\ncase '5':\r\ncase '6':\r\ncase '7':\r\nj--;\r\nval = get_oct_char(s, &j);\r\nbreak;\r\ncase 'x':\r\nval = get_hex_char(s, &j);\r\nbreak;\r\ndefault:\r\nval = c;\r\n}\r\n(*i) = j;\r\nreturn val;\r\n}\r\nint utilfdt_read_err(const char *filename, char **buffp)\r\n{\r\nint fd = 0;\r\nchar *buf = NULL;\r\noff_t bufsize = 1024, offset = 0;\r\nint ret = 0;\r\n*buffp = NULL;\r\nif (strcmp(filename, "-") != 0) {\r\nfd = open(filename, O_RDONLY);\r\nif (fd < 0)\r\nreturn errno;\r\n}\r\nbuf = malloc(bufsize);\r\ndo {\r\nif (offset == bufsize) {\r\nbufsize *= 2;\r\nbuf = realloc(buf, bufsize);\r\nif (!buf) {\r\nret = ENOMEM;\r\nbreak;\r\n}\r\n}\r\nret = read(fd, &buf[offset], bufsize - offset);\r\nif (ret < 0) {\r\nret = errno;\r\nbreak;\r\n}\r\noffset += ret;\r\n} while (ret != 0);\r\nclose(fd);\r\nif (ret)\r\nfree(buf);\r\nelse\r\n*buffp = buf;\r\nreturn ret;\r\n}\r\nchar *utilfdt_read(const char *filename)\r\n{\r\nchar *buff;\r\nint ret = utilfdt_read_err(filename, &buff);\r\nif (ret) {\r\nfprintf(stderr, "Couldn't open blob from '%s': %s\n", filename,\r\nstrerror(ret));\r\nreturn NULL;\r\n}\r\nreturn buff;\r\n}\r\nint utilfdt_write_err(const char *filename, const void *blob)\r\n{\r\nint fd = 1;\r\nint totalsize;\r\nint offset;\r\nint ret = 0;\r\nconst char *ptr = blob;\r\nif (strcmp(filename, "-") != 0) {\r\nfd = open(filename, O_WRONLY | O_CREAT | O_TRUNC, 0666);\r\nif (fd < 0)\r\nreturn errno;\r\n}\r\ntotalsize = fdt_totalsize(blob);\r\noffset = 0;\r\nwhile (offset < totalsize) {\r\nret = write(fd, ptr + offset, totalsize - offset);\r\nif (ret < 0) {\r\nret = -errno;\r\nbreak;\r\n}\r\noffset += ret;\r\n}\r\nif (fd != 1)\r\nclose(fd);\r\nreturn ret < 0 ? -ret : 0;\r\n}\r\nint utilfdt_write(const char *filename, const void *blob)\r\n{\r\nint ret = utilfdt_write_err(filename, blob);\r\nif (ret) {\r\nfprintf(stderr, "Couldn't write blob to '%s': %s\n", filename,\r\nstrerror(ret));\r\n}\r\nreturn ret ? -1 : 0;\r\n}\r\nint utilfdt_decode_type(const char *fmt, int *type, int *size)\r\n{\r\nint qualifier = 0;\r\nif (!*fmt)\r\nreturn -1;\r\n*size = -1;\r\nif (strchr("hlLb", *fmt)) {\r\nqualifier = *fmt++;\r\nif (qualifier == *fmt) {\r\nswitch (*fmt++) {\r\ncase 'h':\r\nqualifier = 'b';\r\nbreak;\r\n}\r\n}\r\n}\r\nif ((*fmt == '\0') || !strchr("iuxs", *fmt))\r\nreturn -1;\r\nif (*fmt != 's')\r\n*size = qualifier == 'b' ? 1 :\r\nqualifier == 'h' ? 2 :\r\nqualifier == 'l' ? 4 : -1;\r\n*type = *fmt++;\r\nif (*fmt)\r\nreturn -1;\r\nreturn 0;\r\n}

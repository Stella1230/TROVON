int st_sensors_get_buffer_element(struct iio_dev *indio_dev, u8 *buf)\r\n{\r\nu8 *addr;\r\nint i, n = 0, len;\r\nstruct st_sensor_data *sdata = iio_priv(indio_dev);\r\nunsigned int num_data_channels = sdata->num_data_channels;\r\nunsigned int byte_for_channel =\r\nindio_dev->channels[0].scan_type.storagebits >> 3;\r\naddr = kmalloc(num_data_channels, GFP_KERNEL);\r\nif (!addr) {\r\nlen = -ENOMEM;\r\ngoto st_sensors_get_buffer_element_error;\r\n}\r\nfor (i = 0; i < num_data_channels; i++) {\r\nif (test_bit(i, indio_dev->active_scan_mask)) {\r\naddr[n] = indio_dev->channels[i].address;\r\nn++;\r\n}\r\n}\r\nswitch (n) {\r\ncase 1:\r\nlen = sdata->tf->read_multiple_byte(&sdata->tb, sdata->dev,\r\naddr[0], byte_for_channel, buf, sdata->multiread_bit);\r\nbreak;\r\ncase 2:\r\nif ((addr[1] - addr[0]) == byte_for_channel) {\r\nlen = sdata->tf->read_multiple_byte(&sdata->tb,\r\nsdata->dev, addr[0], byte_for_channel * n,\r\nbuf, sdata->multiread_bit);\r\n} else {\r\nu8 *rx_array;\r\nrx_array = kmalloc(byte_for_channel * num_data_channels,\r\nGFP_KERNEL);\r\nif (!rx_array) {\r\nlen = -ENOMEM;\r\ngoto st_sensors_free_memory;\r\n}\r\nlen = sdata->tf->read_multiple_byte(&sdata->tb,\r\nsdata->dev, addr[0],\r\nbyte_for_channel * num_data_channels,\r\nrx_array, sdata->multiread_bit);\r\nif (len < 0) {\r\nkfree(rx_array);\r\ngoto st_sensors_free_memory;\r\n}\r\nfor (i = 0; i < n * num_data_channels; i++) {\r\nif (i < n)\r\nbuf[i] = rx_array[i];\r\nelse\r\nbuf[i] = rx_array[n + i];\r\n}\r\nkfree(rx_array);\r\nlen = byte_for_channel * n;\r\n}\r\nbreak;\r\ncase 3:\r\nlen = sdata->tf->read_multiple_byte(&sdata->tb, sdata->dev,\r\naddr[0], byte_for_channel * num_data_channels,\r\nbuf, sdata->multiread_bit);\r\nbreak;\r\ndefault:\r\nlen = -EINVAL;\r\ngoto st_sensors_free_memory;\r\n}\r\nif (len != byte_for_channel * n) {\r\nlen = -EIO;\r\ngoto st_sensors_free_memory;\r\n}\r\nst_sensors_free_memory:\r\nkfree(addr);\r\nst_sensors_get_buffer_element_error:\r\nreturn len;\r\n}\r\nirqreturn_t st_sensors_trigger_handler(int irq, void *p)\r\n{\r\nint len;\r\nstruct iio_poll_func *pf = p;\r\nstruct iio_dev *indio_dev = pf->indio_dev;\r\nstruct st_sensor_data *sdata = iio_priv(indio_dev);\r\nlen = st_sensors_get_buffer_element(indio_dev, sdata->buffer_data);\r\nif (len < 0)\r\ngoto st_sensors_get_buffer_element_error;\r\nif (indio_dev->scan_timestamp)\r\n*(s64 *)((u8 *)sdata->buffer_data +\r\nALIGN(len, sizeof(s64))) = pf->timestamp;\r\niio_push_to_buffers(indio_dev, sdata->buffer_data);\r\nst_sensors_get_buffer_element_error:\r\niio_trigger_notify_done(indio_dev->trig);\r\nreturn IRQ_HANDLED;\r\n}

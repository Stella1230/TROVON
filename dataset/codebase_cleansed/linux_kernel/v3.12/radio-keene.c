static inline struct keene_device *to_keene_dev(struct v4l2_device *v4l2_dev)\r\n{\r\nreturn container_of(v4l2_dev, struct keene_device, v4l2_dev);\r\n}\r\nstatic int keene_cmd_main(struct keene_device *radio, unsigned freq, bool play)\r\n{\r\nunsigned short freq_send = freq ? (freq - 76 * 16000) / 800 : 0;\r\nint ret;\r\nradio->buffer[0] = 0x00;\r\nradio->buffer[1] = 0x50;\r\nradio->buffer[2] = (freq_send >> 8) & 0xff;\r\nradio->buffer[3] = freq_send & 0xff;\r\nradio->buffer[4] = radio->pa;\r\nradio->buffer[5] = (radio->muted ? 4 : 8) | (play ? 1 : 2) |\r\n(freq ? 0x10 : 0);\r\nradio->buffer[6] = 0x00;\r\nradio->buffer[7] = 0x00;\r\nret = usb_control_msg(radio->usbdev, usb_sndctrlpipe(radio->usbdev, 0),\r\n9, 0x21, 0x200, 2, radio->buffer, BUFFER_LENGTH, USB_TIMEOUT);\r\nif (ret < 0) {\r\ndev_warn(&radio->vdev.dev, "%s failed (%d)\n", __func__, ret);\r\nreturn ret;\r\n}\r\nif (freq)\r\nradio->curfreq = freq;\r\nreturn 0;\r\n}\r\nstatic int keene_cmd_set(struct keene_device *radio)\r\n{\r\nint ret;\r\nradio->buffer[0] = 0x00;\r\nradio->buffer[1] = 0x51;\r\nradio->buffer[2] = radio->tx;\r\nradio->buffer[3] = (!radio->stereo) | (radio->preemph_75_us ? 4 : 0);\r\nradio->buffer[4] = 0x00;\r\nradio->buffer[5] = 0x00;\r\nradio->buffer[6] = 0x00;\r\nradio->buffer[7] = 0x00;\r\nret = usb_control_msg(radio->usbdev, usb_sndctrlpipe(radio->usbdev, 0),\r\n9, 0x21, 0x200, 2, radio->buffer, BUFFER_LENGTH, USB_TIMEOUT);\r\nif (ret < 0) {\r\ndev_warn(&radio->vdev.dev, "%s failed (%d)\n", __func__, ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic void usb_keene_disconnect(struct usb_interface *intf)\r\n{\r\nstruct keene_device *radio = to_keene_dev(usb_get_intfdata(intf));\r\nmutex_lock(&radio->lock);\r\nusb_set_intfdata(intf, NULL);\r\nvideo_unregister_device(&radio->vdev);\r\nv4l2_device_disconnect(&radio->v4l2_dev);\r\nmutex_unlock(&radio->lock);\r\nv4l2_device_put(&radio->v4l2_dev);\r\n}\r\nstatic int usb_keene_suspend(struct usb_interface *intf, pm_message_t message)\r\n{\r\nstruct keene_device *radio = to_keene_dev(usb_get_intfdata(intf));\r\nreturn keene_cmd_main(radio, 0, false);\r\n}\r\nstatic int usb_keene_resume(struct usb_interface *intf)\r\n{\r\nstruct keene_device *radio = to_keene_dev(usb_get_intfdata(intf));\r\nmdelay(50);\r\nkeene_cmd_set(radio);\r\nkeene_cmd_main(radio, radio->curfreq, true);\r\nreturn 0;\r\n}\r\nstatic int vidioc_querycap(struct file *file, void *priv,\r\nstruct v4l2_capability *v)\r\n{\r\nstruct keene_device *radio = video_drvdata(file);\r\nstrlcpy(v->driver, "radio-keene", sizeof(v->driver));\r\nstrlcpy(v->card, "Keene FM Transmitter", sizeof(v->card));\r\nusb_make_path(radio->usbdev, v->bus_info, sizeof(v->bus_info));\r\nv->device_caps = V4L2_CAP_RADIO | V4L2_CAP_MODULATOR;\r\nv->capabilities = v->device_caps | V4L2_CAP_DEVICE_CAPS;\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_modulator(struct file *file, void *priv,\r\nstruct v4l2_modulator *v)\r\n{\r\nstruct keene_device *radio = video_drvdata(file);\r\nif (v->index > 0)\r\nreturn -EINVAL;\r\nstrlcpy(v->name, "FM", sizeof(v->name));\r\nv->rangelow = FREQ_MIN * FREQ_MUL;\r\nv->rangehigh = FREQ_MAX * FREQ_MUL;\r\nv->txsubchans = radio->stereo ? V4L2_TUNER_SUB_STEREO : V4L2_TUNER_SUB_MONO;\r\nv->capability = V4L2_TUNER_CAP_LOW | V4L2_TUNER_CAP_STEREO;\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_modulator(struct file *file, void *priv,\r\nconst struct v4l2_modulator *v)\r\n{\r\nstruct keene_device *radio = video_drvdata(file);\r\nif (v->index > 0)\r\nreturn -EINVAL;\r\nradio->stereo = (v->txsubchans == V4L2_TUNER_SUB_STEREO);\r\nreturn keene_cmd_set(radio);\r\n}\r\nstatic int vidioc_s_frequency(struct file *file, void *priv,\r\nconst struct v4l2_frequency *f)\r\n{\r\nstruct keene_device *radio = video_drvdata(file);\r\nunsigned freq = f->frequency;\r\nif (f->tuner != 0 || f->type != V4L2_TUNER_RADIO)\r\nreturn -EINVAL;\r\nfreq = clamp(freq, FREQ_MIN * FREQ_MUL, FREQ_MAX * FREQ_MUL);\r\nreturn keene_cmd_main(radio, freq, true);\r\n}\r\nstatic int vidioc_g_frequency(struct file *file, void *priv,\r\nstruct v4l2_frequency *f)\r\n{\r\nstruct keene_device *radio = video_drvdata(file);\r\nif (f->tuner != 0)\r\nreturn -EINVAL;\r\nf->type = V4L2_TUNER_RADIO;\r\nf->frequency = radio->curfreq;\r\nreturn 0;\r\n}\r\nstatic int keene_s_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstatic const u8 db2tx[] = {\r\n0x03, 0x13, 0x02, 0x12, 0x22, 0x32,\r\n0x21, 0x31, 0x20, 0x30, 0x40, 0x50\r\n};\r\nstruct keene_device *radio =\r\ncontainer_of(ctrl->handler, struct keene_device, hdl);\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_AUDIO_MUTE:\r\nradio->muted = ctrl->val;\r\nreturn keene_cmd_main(radio, 0, true);\r\ncase V4L2_CID_TUNE_POWER_LEVEL:\r\nradio->pa = (ctrl->val - 71) * 100 / 62;\r\nreturn keene_cmd_main(radio, 0, true);\r\ncase V4L2_CID_TUNE_PREEMPHASIS:\r\nradio->preemph_75_us = ctrl->val == V4L2_PREEMPHASIS_75_uS;\r\nreturn keene_cmd_set(radio);\r\ncase V4L2_CID_AUDIO_COMPRESSION_GAIN:\r\nradio->tx = db2tx[(ctrl->val - ctrl->minimum) / ctrl->step];\r\nreturn keene_cmd_set(radio);\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic void usb_keene_video_device_release(struct v4l2_device *v4l2_dev)\r\n{\r\nstruct keene_device *radio = to_keene_dev(v4l2_dev);\r\nv4l2_ctrl_handler_free(&radio->hdl);\r\nkfree(radio->buffer);\r\nkfree(radio);\r\n}\r\nstatic int usb_keene_probe(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct usb_device *dev = interface_to_usbdev(intf);\r\nstruct keene_device *radio;\r\nstruct v4l2_ctrl_handler *hdl;\r\nint retval = 0;\r\nif (dev->product && strcmp(dev->product, "B-LINK USB Audio "))\r\nreturn -ENODEV;\r\nradio = kzalloc(sizeof(struct keene_device), GFP_KERNEL);\r\nif (radio)\r\nradio->buffer = kmalloc(BUFFER_LENGTH, GFP_KERNEL);\r\nif (!radio || !radio->buffer) {\r\ndev_err(&intf->dev, "kmalloc for keene_device failed\n");\r\nkfree(radio);\r\nretval = -ENOMEM;\r\ngoto err;\r\n}\r\nhdl = &radio->hdl;\r\nv4l2_ctrl_handler_init(hdl, 4);\r\nv4l2_ctrl_new_std(hdl, &keene_ctrl_ops, V4L2_CID_AUDIO_MUTE,\r\n0, 1, 1, 0);\r\nv4l2_ctrl_new_std_menu(hdl, &keene_ctrl_ops, V4L2_CID_TUNE_PREEMPHASIS,\r\nV4L2_PREEMPHASIS_75_uS, 1, V4L2_PREEMPHASIS_50_uS);\r\nv4l2_ctrl_new_std(hdl, &keene_ctrl_ops, V4L2_CID_TUNE_POWER_LEVEL,\r\n84, 118, 1, 118);\r\nv4l2_ctrl_new_std(hdl, &keene_ctrl_ops, V4L2_CID_AUDIO_COMPRESSION_GAIN,\r\n-15, 18, 3, 0);\r\nradio->pa = 118;\r\nradio->tx = 0x32;\r\nradio->stereo = true;\r\nif (hdl->error) {\r\nretval = hdl->error;\r\nv4l2_ctrl_handler_free(hdl);\r\ngoto err_v4l2;\r\n}\r\nretval = v4l2_device_register(&intf->dev, &radio->v4l2_dev);\r\nif (retval < 0) {\r\ndev_err(&intf->dev, "couldn't register v4l2_device\n");\r\ngoto err_v4l2;\r\n}\r\nmutex_init(&radio->lock);\r\nradio->v4l2_dev.ctrl_handler = hdl;\r\nradio->v4l2_dev.release = usb_keene_video_device_release;\r\nstrlcpy(radio->vdev.name, radio->v4l2_dev.name,\r\nsizeof(radio->vdev.name));\r\nradio->vdev.v4l2_dev = &radio->v4l2_dev;\r\nradio->vdev.fops = &usb_keene_fops;\r\nradio->vdev.ioctl_ops = &usb_keene_ioctl_ops;\r\nradio->vdev.lock = &radio->lock;\r\nradio->vdev.release = video_device_release_empty;\r\nradio->vdev.vfl_dir = VFL_DIR_TX;\r\nradio->usbdev = interface_to_usbdev(intf);\r\nradio->intf = intf;\r\nusb_set_intfdata(intf, &radio->v4l2_dev);\r\nvideo_set_drvdata(&radio->vdev, radio);\r\nset_bit(V4L2_FL_USE_FH_PRIO, &radio->vdev.flags);\r\nmsleep(20);\r\nkeene_cmd_main(radio, 95.16 * FREQ_MUL, false);\r\nretval = video_register_device(&radio->vdev, VFL_TYPE_RADIO, -1);\r\nif (retval < 0) {\r\ndev_err(&intf->dev, "could not register video device\n");\r\ngoto err_vdev;\r\n}\r\nv4l2_ctrl_handler_setup(hdl);\r\ndev_info(&intf->dev, "V4L2 device registered as %s\n",\r\nvideo_device_node_name(&radio->vdev));\r\nreturn 0;\r\nerr_vdev:\r\nv4l2_device_unregister(&radio->v4l2_dev);\r\nerr_v4l2:\r\nkfree(radio->buffer);\r\nkfree(radio);\r\nerr:\r\nreturn retval;\r\n}\r\nstatic int __init keene_init(void)\r\n{\r\nint retval = usb_register(&usb_keene_driver);\r\nif (retval)\r\npr_err(KBUILD_MODNAME\r\n": usb_register failed. Error number %d\n", retval);\r\nreturn retval;\r\n}\r\nstatic void __exit keene_exit(void)\r\n{\r\nusb_deregister(&usb_keene_driver);\r\n}

int sunserial_register_minors(struct uart_driver *drv, int count)\r\n{\r\nint err = 0;\r\ndrv->minor = sunserial_current_minor;\r\ndrv->nr += count;\r\nif (drv->nr == count)\r\nerr = uart_register_driver(drv);\r\nif (err == 0) {\r\nsunserial_current_minor += count;\r\ndrv->tty_driver->name_base = drv->minor - 64;\r\n}\r\nreturn err;\r\n}\r\nvoid sunserial_unregister_minors(struct uart_driver *drv, int count)\r\n{\r\ndrv->nr -= count;\r\nsunserial_current_minor -= count;\r\nif (drv->nr == 0)\r\nuart_unregister_driver(drv);\r\n}\r\nint sunserial_console_match(struct console *con, struct device_node *dp,\r\nstruct uart_driver *drv, int line, bool ignore_line)\r\n{\r\nif (!con)\r\nreturn 0;\r\ndrv->cons = con;\r\nif (of_console_device != dp)\r\nreturn 0;\r\nif (!ignore_line) {\r\nint off = 0;\r\nif (of_console_options &&\r\n*of_console_options == 'b')\r\noff = 1;\r\nif ((line & 1) != off)\r\nreturn 0;\r\n}\r\nif (!console_set_on_cmdline) {\r\ncon->index = line;\r\nadd_preferred_console(con->name, line, NULL);\r\n}\r\nreturn 1;\r\n}\r\nvoid sunserial_console_termios(struct console *con, struct device_node *uart_dp)\r\n{\r\nconst char *mode, *s;\r\nchar mode_prop[] = "ttyX-mode";\r\nint baud, bits, stop, cflag;\r\nchar parity;\r\nif (!strcmp(uart_dp->name, "rsc") ||\r\n!strcmp(uart_dp->name, "rsc-console") ||\r\n!strcmp(uart_dp->name, "rsc-control")) {\r\nmode = of_get_property(uart_dp,\r\n"ssp-console-modes", NULL);\r\nif (!mode)\r\nmode = "115200,8,n,1,-";\r\n} else if (!strcmp(uart_dp->name, "lom-console")) {\r\nmode = "9600,8,n,1,-";\r\n} else {\r\nstruct device_node *dp;\r\nchar c;\r\nc = 'a';\r\nif (of_console_options)\r\nc = *of_console_options;\r\nmode_prop[3] = c;\r\ndp = of_find_node_by_path("/options");\r\nmode = of_get_property(dp, mode_prop, NULL);\r\nif (!mode)\r\nmode = "9600,8,n,1,-";\r\n}\r\ncflag = CREAD | HUPCL | CLOCAL;\r\ns = mode;\r\nbaud = simple_strtoul(s, NULL, 0);\r\ns = strchr(s, ',');\r\nbits = simple_strtoul(++s, NULL, 0);\r\ns = strchr(s, ',');\r\nparity = *(++s);\r\ns = strchr(s, ',');\r\nstop = simple_strtoul(++s, NULL, 0);\r\ns = strchr(s, ',');\r\nswitch (baud) {\r\ncase 150: cflag |= B150; break;\r\ncase 300: cflag |= B300; break;\r\ncase 600: cflag |= B600; break;\r\ncase 1200: cflag |= B1200; break;\r\ncase 2400: cflag |= B2400; break;\r\ncase 4800: cflag |= B4800; break;\r\ncase 9600: cflag |= B9600; break;\r\ncase 19200: cflag |= B19200; break;\r\ncase 38400: cflag |= B38400; break;\r\ncase 57600: cflag |= B57600; break;\r\ncase 115200: cflag |= B115200; break;\r\ncase 230400: cflag |= B230400; break;\r\ncase 460800: cflag |= B460800; break;\r\ndefault: baud = 9600; cflag |= B9600; break;\r\n}\r\nswitch (bits) {\r\ncase 5: cflag |= CS5; break;\r\ncase 6: cflag |= CS6; break;\r\ncase 7: cflag |= CS7; break;\r\ncase 8: cflag |= CS8; break;\r\ndefault: cflag |= CS8; break;\r\n}\r\nswitch (parity) {\r\ncase 'o': cflag |= (PARENB | PARODD); break;\r\ncase 'e': cflag |= PARENB; break;\r\ncase 'n': default: break;\r\n}\r\nswitch (stop) {\r\ncase 2: cflag |= CSTOPB; break;\r\ncase 1: default: break;\r\n}\r\ncon->cflag = cflag;\r\n}\r\nunsigned int suncore_mouse_baud_cflag_next(unsigned int cflag, int *new_baud)\r\n{\r\nint i;\r\nfor (i = 0; mouse_baud_table[i].baud != -1; i++)\r\nif (mouse_baud_table[i].cflag == (cflag & CBAUD))\r\nbreak;\r\ni += 1;\r\nif (mouse_baud_table[i].baud == -1)\r\ni = 0;\r\n*new_baud = mouse_baud_table[i].baud;\r\nreturn mouse_baud_table[i].cflag;\r\n}\r\nint suncore_mouse_baud_detection(unsigned char ch, int is_break)\r\n{\r\nstatic int mouse_got_break = 0;\r\nstatic int ctr = 0;\r\nif (is_break) {\r\nif (mouse_got_break && ctr < 8)\r\nreturn 1;\r\nctr = 0;\r\nmouse_got_break = 1;\r\nreturn 2;\r\n}\r\nif (mouse_got_break) {\r\nctr++;\r\nif (ch == 0x87) {\r\nmouse_got_break = 0;\r\n}\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init suncore_init(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic void __exit suncore_exit(void)\r\n{\r\n}

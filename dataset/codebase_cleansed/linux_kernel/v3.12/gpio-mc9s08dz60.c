static inline struct mc9s08dz60 *to_mc9s08dz60(struct gpio_chip *gc)\r\n{\r\nreturn container_of(gc, struct mc9s08dz60, chip);\r\n}\r\nstatic void mc9s_gpio_to_reg_and_bit(int offset, u8 *reg, u8 *bit)\r\n{\r\n*reg = 0x20 + offset / GPIO_NUM_PER_GROUP;\r\n*bit = offset % GPIO_NUM_PER_GROUP;\r\n}\r\nstatic int mc9s08dz60_get_value(struct gpio_chip *gc, unsigned offset)\r\n{\r\nu8 reg, bit;\r\ns32 value;\r\nstruct mc9s08dz60 *mc9s = to_mc9s08dz60(gc);\r\nmc9s_gpio_to_reg_and_bit(offset, &reg, &bit);\r\nvalue = i2c_smbus_read_byte_data(mc9s->client, reg);\r\nreturn (value >= 0) ? (value >> bit) & 0x1 : 0;\r\n}\r\nstatic int mc9s08dz60_set(struct mc9s08dz60 *mc9s, unsigned offset, int val)\r\n{\r\nu8 reg, bit;\r\ns32 value;\r\nmc9s_gpio_to_reg_and_bit(offset, &reg, &bit);\r\nvalue = i2c_smbus_read_byte_data(mc9s->client, reg);\r\nif (value >= 0) {\r\nif (val)\r\nvalue |= 1 << bit;\r\nelse\r\nvalue &= ~(1 << bit);\r\nreturn i2c_smbus_write_byte_data(mc9s->client, reg, value);\r\n} else\r\nreturn value;\r\n}\r\nstatic void mc9s08dz60_set_value(struct gpio_chip *gc, unsigned offset, int val)\r\n{\r\nstruct mc9s08dz60 *mc9s = to_mc9s08dz60(gc);\r\nmc9s08dz60_set(mc9s, offset, val);\r\n}\r\nstatic int mc9s08dz60_direction_output(struct gpio_chip *gc,\r\nunsigned offset, int val)\r\n{\r\nstruct mc9s08dz60 *mc9s = to_mc9s08dz60(gc);\r\nreturn mc9s08dz60_set(mc9s, offset, val);\r\n}\r\nstatic int mc9s08dz60_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct mc9s08dz60 *mc9s;\r\nmc9s = devm_kzalloc(&client->dev, sizeof(*mc9s), GFP_KERNEL);\r\nif (!mc9s)\r\nreturn -ENOMEM;\r\nmc9s->chip.label = client->name;\r\nmc9s->chip.base = -1;\r\nmc9s->chip.dev = &client->dev;\r\nmc9s->chip.owner = THIS_MODULE;\r\nmc9s->chip.ngpio = GPIO_NUM;\r\nmc9s->chip.can_sleep = 1;\r\nmc9s->chip.get = mc9s08dz60_get_value;\r\nmc9s->chip.set = mc9s08dz60_set_value;\r\nmc9s->chip.direction_output = mc9s08dz60_direction_output;\r\nmc9s->client = client;\r\ni2c_set_clientdata(client, mc9s);\r\nreturn gpiochip_add(&mc9s->chip);\r\n}\r\nstatic int mc9s08dz60_remove(struct i2c_client *client)\r\n{\r\nstruct mc9s08dz60 *mc9s;\r\nmc9s = i2c_get_clientdata(client);\r\nreturn gpiochip_remove(&mc9s->chip);\r\n}

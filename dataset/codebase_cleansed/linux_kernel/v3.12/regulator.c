void u300_pm_poweroff(void)\r\n{\r\nsigset_t old, all;\r\nsigfillset(&all);\r\nif (!sigprocmask(SIG_BLOCK, &all, &old)) {\r\nif (main_power_15)\r\nregulator_disable(main_power_15);\r\nelse\r\npr_err("regulator not available to shut down system\n");\r\n(void) sigprocmask(SIG_SETMASK, &old, NULL);\r\n}\r\nreturn;\r\n}\r\nstatic int __init __u300_init_boardpower(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct device_node *syscon_np;\r\nstruct regmap *regmap;\r\nint err;\r\npr_info("U300: setting up board power\n");\r\nsyscon_np = of_parse_phandle(np, "syscon", 0);\r\nif (!syscon_np) {\r\npr_crit("U300: no syscon node\n");\r\nreturn -ENODEV;\r\n}\r\nregmap = syscon_node_to_regmap(syscon_np);\r\nif (!regmap) {\r\npr_crit("U300: could not locate syscon regmap\n");\r\nreturn -ENODEV;\r\n}\r\nmain_power_15 = regulator_get(&pdev->dev, "vana15");\r\nif (IS_ERR(main_power_15)) {\r\npr_err("could not get vana15");\r\nreturn PTR_ERR(main_power_15);\r\n}\r\nerr = regulator_enable(main_power_15);\r\nif (err) {\r\npr_err("could not enable vana15\n");\r\nreturn err;\r\n}\r\npr_info("U300: disable system controller pull-up\n");\r\nregmap_update_bits(regmap, U300_SYSCON_PMCR,\r\nU300_SYSCON_PMCR_DCON_ENABLE, 0);\r\npm_power_off = u300_pm_poweroff;\r\nreturn 0;\r\n}\r\nstatic int __init s365_board_probe(struct platform_device *pdev)\r\n{\r\nreturn __u300_init_boardpower(pdev);\r\n}\r\nstatic int __init u300_init_boardpower(void)\r\n{\r\nreturn platform_driver_probe(&s365_board_driver,\r\ns365_board_probe);\r\n}

static u32 ps3av_cs_video2av(int cs)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < ARRAY_SIZE(ps3av_cs_video2av_table); i++)\r\nif (ps3av_cs_video2av_table[i].cs == cs)\r\nreturn ps3av_cs_video2av_table[i].av;\r\nreturn PS3AV_CMD_AV_CS_RGB_8;\r\n}\r\nstatic u32 ps3av_cs_video2av_bitlen(int cs)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < ARRAY_SIZE(ps3av_cs_video2av_table); i++)\r\nif (ps3av_cs_video2av_table[i].cs == cs)\r\nreturn ps3av_cs_video2av_table[i].bl;\r\nreturn PS3AV_CMD_AV_CS_8;\r\n}\r\nstatic u32 ps3av_vid_video2av(int vid)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < ARRAY_SIZE(ps3av_vid_video2av_table); i++)\r\nif (ps3av_vid_video2av_table[i].vid == vid)\r\nreturn ps3av_vid_video2av_table[i].av;\r\nreturn PS3AV_CMD_AV_VID_480P;\r\n}\r\nstatic int ps3av_hdmi_range(void)\r\n{\r\nif (ps3_compare_firmware_version(1, 8, 0) < 0)\r\nreturn 0;\r\nelse\r\nreturn 1;\r\n}\r\nint ps3av_cmd_init(void)\r\n{\r\nint res;\r\nstruct ps3av_pkt_av_init av_init;\r\nstruct ps3av_pkt_video_init video_init;\r\nstruct ps3av_pkt_audio_init audio_init;\r\nmemset(&video_init, 0, sizeof(video_init));\r\nres = ps3av_do_pkt(PS3AV_CID_VIDEO_INIT, sizeof(video_init.send_hdr),\r\nsizeof(video_init), &video_init.send_hdr);\r\nif (res < 0)\r\nreturn res;\r\nres = get_status(&video_init);\r\nif (res) {\r\nprintk(KERN_ERR "PS3AV_CID_VIDEO_INIT: failed %x\n", res);\r\nreturn res;\r\n}\r\nmemset(&audio_init, 0, sizeof(audio_init));\r\nres = ps3av_do_pkt(PS3AV_CID_AUDIO_INIT, sizeof(audio_init.send_hdr),\r\nsizeof(audio_init), &audio_init.send_hdr);\r\nif (res < 0)\r\nreturn res;\r\nres = get_status(&audio_init);\r\nif (res) {\r\nprintk(KERN_ERR "PS3AV_CID_AUDIO_INIT: failed %x\n", res);\r\nreturn res;\r\n}\r\nmemset(&av_init, 0, sizeof(av_init));\r\nav_init.event_bit = 0;\r\nres = ps3av_do_pkt(PS3AV_CID_AV_INIT, sizeof(av_init), sizeof(av_init),\r\n&av_init.send_hdr);\r\nif (res < 0)\r\nreturn res;\r\nres = get_status(&av_init);\r\nif (res)\r\nprintk(KERN_ERR "PS3AV_CID_AV_INIT: failed %x\n", res);\r\nreturn res;\r\n}\r\nint ps3av_cmd_fin(void)\r\n{\r\nint res;\r\nstruct ps3av_pkt_av_fin av_fin;\r\nmemset(&av_fin, 0, sizeof(av_fin));\r\nres = ps3av_do_pkt(PS3AV_CID_AV_FIN, sizeof(av_fin.send_hdr),\r\nsizeof(av_fin), &av_fin.send_hdr);\r\nif (res < 0)\r\nreturn res;\r\nres = get_status(&av_fin);\r\nif (res)\r\nprintk(KERN_ERR "PS3AV_CID_AV_FIN: failed %x\n", res);\r\nreturn res;\r\n}\r\nint ps3av_cmd_av_video_mute(int num_of_port, u32 *port, u32 mute)\r\n{\r\nint i, send_len, res;\r\nstruct ps3av_pkt_av_video_mute av_video_mute;\r\nif (num_of_port > PS3AV_MUTE_PORT_MAX)\r\nreturn -EINVAL;\r\nmemset(&av_video_mute, 0, sizeof(av_video_mute));\r\nfor (i = 0; i < num_of_port; i++) {\r\nav_video_mute.mute[i].avport = port[i];\r\nav_video_mute.mute[i].mute = mute;\r\n}\r\nsend_len = sizeof(av_video_mute.send_hdr) +\r\nsizeof(struct ps3av_av_mute) * num_of_port;\r\nres = ps3av_do_pkt(PS3AV_CID_AV_VIDEO_MUTE, send_len,\r\nsizeof(av_video_mute), &av_video_mute.send_hdr);\r\nif (res < 0)\r\nreturn res;\r\nres = get_status(&av_video_mute);\r\nif (res)\r\nprintk(KERN_ERR "PS3AV_CID_AV_VIDEO_MUTE: failed %x\n", res);\r\nreturn res;\r\n}\r\nint ps3av_cmd_av_video_disable_sig(u32 port)\r\n{\r\nint res;\r\nstruct ps3av_pkt_av_video_disable_sig av_video_sig;\r\nmemset(&av_video_sig, 0, sizeof(av_video_sig));\r\nav_video_sig.avport = port;\r\nres = ps3av_do_pkt(PS3AV_CID_AV_VIDEO_DISABLE_SIG,\r\nsizeof(av_video_sig), sizeof(av_video_sig),\r\n&av_video_sig.send_hdr);\r\nif (res < 0)\r\nreturn res;\r\nres = get_status(&av_video_sig);\r\nif (res)\r\nprintk(KERN_ERR\r\n"PS3AV_CID_AV_VIDEO_DISABLE_SIG: failed %x port:%x\n",\r\nres, port);\r\nreturn res;\r\n}\r\nint ps3av_cmd_av_tv_mute(u32 avport, u32 mute)\r\n{\r\nint res;\r\nstruct ps3av_pkt_av_tv_mute tv_mute;\r\nmemset(&tv_mute, 0, sizeof(tv_mute));\r\ntv_mute.avport = avport;\r\ntv_mute.mute = mute;\r\nres = ps3av_do_pkt(PS3AV_CID_AV_TV_MUTE, sizeof(tv_mute),\r\nsizeof(tv_mute), &tv_mute.send_hdr);\r\nif (res < 0)\r\nreturn res;\r\nres = get_status(&tv_mute);\r\nif (res)\r\nprintk(KERN_ERR "PS3AV_CID_AV_TV_MUTE: failed %x port:%x\n",\r\nres, avport);\r\nreturn res;\r\n}\r\nint ps3av_cmd_enable_event(void)\r\n{\r\nint res;\r\nstruct ps3av_pkt_av_event av_event;\r\nmemset(&av_event, 0, sizeof(av_event));\r\nav_event.event_bit = PS3AV_CMD_EVENT_BIT_UNPLUGGED |\r\nPS3AV_CMD_EVENT_BIT_PLUGGED | PS3AV_CMD_EVENT_BIT_HDCP_DONE;\r\nres = ps3av_do_pkt(PS3AV_CID_AV_ENABLE_EVENT, sizeof(av_event),\r\nsizeof(av_event), &av_event.send_hdr);\r\nif (res < 0)\r\nreturn res;\r\nres = get_status(&av_event);\r\nif (res)\r\nprintk(KERN_ERR "PS3AV_CID_AV_ENABLE_EVENT: failed %x\n", res);\r\nreturn res;\r\n}\r\nint ps3av_cmd_av_hdmi_mode(u8 mode)\r\n{\r\nint res;\r\nstruct ps3av_pkt_av_hdmi_mode hdmi_mode;\r\nmemset(&hdmi_mode, 0, sizeof(hdmi_mode));\r\nhdmi_mode.mode = mode;\r\nres = ps3av_do_pkt(PS3AV_CID_AV_HDMI_MODE, sizeof(hdmi_mode),\r\nsizeof(hdmi_mode), &hdmi_mode.send_hdr);\r\nif (res < 0)\r\nreturn res;\r\nres = get_status(&hdmi_mode);\r\nif (res && res != PS3AV_STATUS_UNSUPPORTED_HDMI_MODE)\r\nprintk(KERN_ERR "PS3AV_CID_AV_HDMI_MODE: failed %x\n", res);\r\nreturn res;\r\n}\r\nu32 ps3av_cmd_set_av_video_cs(void *p, u32 avport, int video_vid, int cs_out,\r\nint aspect, u32 id)\r\n{\r\nstruct ps3av_pkt_av_video_cs *av_video_cs;\r\nav_video_cs = (struct ps3av_pkt_av_video_cs *)p;\r\nif (video_vid == -1)\r\nvideo_vid = PS3AV_CMD_VIDEO_VID_720P_60HZ;\r\nif (cs_out == -1)\r\ncs_out = PS3AV_CMD_VIDEO_CS_YUV444_8;\r\nif (aspect == -1)\r\naspect = 0;\r\nmemset(av_video_cs, 0, sizeof(*av_video_cs));\r\nps3av_set_hdr(PS3AV_CID_AV_VIDEO_CS, sizeof(*av_video_cs),\r\n&av_video_cs->send_hdr);\r\nav_video_cs->avport = avport;\r\nav_video_cs->av_vid = ps3av_vid_video2av(video_vid);\r\nav_video_cs->av_cs_out = ps3av_cs_video2av(cs_out);\r\nav_video_cs->av_cs_in = ps3av_cs_video2av(PS3AV_CMD_VIDEO_CS_RGB_8);\r\nav_video_cs->bitlen_out = ps3av_cs_video2av_bitlen(cs_out);\r\nif ((id & PS3AV_MODE_WHITE) && ps3av_hdmi_range())\r\nav_video_cs->super_white = PS3AV_CMD_AV_SUPER_WHITE_ON;\r\nelse\r\nav_video_cs->super_white = PS3AV_CMD_AV_SUPER_WHITE_OFF;\r\nav_video_cs->aspect = aspect;\r\nif (id & PS3AV_MODE_DITHER) {\r\nav_video_cs->dither = PS3AV_CMD_AV_DITHER_ON\r\n| PS3AV_CMD_AV_DITHER_8BIT;\r\n} else {\r\nav_video_cs->dither = PS3AV_CMD_AV_DITHER_OFF;\r\n}\r\nreturn sizeof(*av_video_cs);\r\n}\r\nu32 ps3av_cmd_set_video_mode(void *p, u32 head, int video_vid, int video_fmt,\r\nu32 id)\r\n{\r\nstruct ps3av_pkt_video_mode *video_mode;\r\nu32 x, y;\r\nvideo_mode = (struct ps3av_pkt_video_mode *)p;\r\nif (video_vid == -1)\r\nvideo_vid = PS3AV_CMD_VIDEO_VID_720P_60HZ;\r\nif (video_fmt == -1)\r\nvideo_fmt = PS3AV_CMD_VIDEO_FMT_X8R8G8B8;\r\nif (ps3av_video_mode2res(id, &x, &y))\r\nreturn 0;\r\nmemset(video_mode, 0, sizeof(*video_mode));\r\nps3av_set_hdr(PS3AV_CID_VIDEO_MODE, sizeof(*video_mode),\r\n&video_mode->send_hdr);\r\nvideo_mode->video_head = head;\r\nif (video_vid == PS3AV_CMD_VIDEO_VID_480I\r\n&& head == PS3AV_CMD_VIDEO_HEAD_B)\r\nvideo_mode->video_vid = PS3AV_CMD_VIDEO_VID_480I_A;\r\nelse\r\nvideo_mode->video_vid = video_vid;\r\nvideo_mode->width = (u16) x;\r\nvideo_mode->height = (u16) y;\r\nvideo_mode->pitch = video_mode->width * 4;\r\nvideo_mode->video_out_format = PS3AV_CMD_VIDEO_OUT_FORMAT_RGB_12BIT;\r\nvideo_mode->video_format = ps3av_video_fmt_table[video_fmt].format;\r\nif ((id & PS3AV_MODE_COLOR) && ps3av_hdmi_range())\r\nvideo_mode->video_cl_cnv = PS3AV_CMD_VIDEO_CL_CNV_DISABLE_LUT;\r\nelse\r\nvideo_mode->video_cl_cnv = PS3AV_CMD_VIDEO_CL_CNV_ENABLE_LUT;\r\nvideo_mode->video_order = ps3av_video_fmt_table[video_fmt].order;\r\npr_debug("%s: video_mode:vid:%x width:%d height:%d pitch:%d out_format:%d format:%x order:%x\n",\r\n__func__, video_vid, video_mode->width, video_mode->height,\r\nvideo_mode->pitch, video_mode->video_out_format,\r\nvideo_mode->video_format, video_mode->video_order);\r\nreturn sizeof(*video_mode);\r\n}\r\nint ps3av_cmd_video_format_black(u32 head, u32 video_fmt, u32 mute)\r\n{\r\nint res;\r\nstruct ps3av_pkt_video_format video_format;\r\nmemset(&video_format, 0, sizeof(video_format));\r\nvideo_format.video_head = head;\r\nif (mute != PS3AV_CMD_MUTE_OFF)\r\nvideo_format.video_format = PS3AV_CMD_VIDEO_FORMAT_BLACK;\r\nelse\r\nvideo_format.video_format =\r\nps3av_video_fmt_table[video_fmt].format;\r\nvideo_format.video_order = ps3av_video_fmt_table[video_fmt].order;\r\nres = ps3av_do_pkt(PS3AV_CID_VIDEO_FORMAT, sizeof(video_format),\r\nsizeof(video_format), &video_format.send_hdr);\r\nif (res < 0)\r\nreturn res;\r\nres = get_status(&video_format);\r\nif (res)\r\nprintk(KERN_ERR "PS3AV_CID_VIDEO_FORMAT: failed %x\n", res);\r\nreturn res;\r\n}\r\nint ps3av_cmd_av_audio_mute(int num_of_port, u32 *port, u32 mute)\r\n{\r\nint i, res;\r\nstruct ps3av_pkt_av_audio_mute av_audio_mute;\r\nif (num_of_port > PS3AV_MUTE_PORT_MAX)\r\nreturn -EINVAL;\r\nmemset(&av_audio_mute, 0, sizeof(av_audio_mute));\r\nfor (i = 0; i < num_of_port; i++) {\r\nav_audio_mute.mute[i].avport = port[i];\r\nav_audio_mute.mute[i].mute = mute;\r\n}\r\nres = ps3av_do_pkt(PS3AV_CID_AV_AUDIO_MUTE,\r\nsizeof(av_audio_mute.send_hdr) +\r\nsizeof(struct ps3av_av_mute) * num_of_port,\r\nsizeof(av_audio_mute), &av_audio_mute.send_hdr);\r\nif (res < 0)\r\nreturn res;\r\nres = get_status(&av_audio_mute);\r\nif (res)\r\nprintk(KERN_ERR "PS3AV_CID_AV_AUDIO_MUTE: failed %x\n", res);\r\nreturn res;\r\n}\r\nstatic u8 ps3av_cnv_mclk(u32 fs)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < ARRAY_SIZE(ps3av_cnv_mclk_table); i++)\r\nif (ps3av_cnv_mclk_table[i].fs == fs)\r\nreturn ps3av_cnv_mclk_table[i].mclk;\r\nprintk(KERN_ERR "%s failed, fs:%x\n", __func__, fs);\r\nreturn 0;\r\n}\r\nstatic void ps3av_cnv_ns(u8 *ns, u32 fs, u32 video_vid)\r\n{\r\nu32 av_vid, ns_val;\r\nint d;\r\nd = ns_val = 0;\r\nav_vid = ps3av_vid_video2av(video_vid);\r\nswitch (av_vid) {\r\ncase PS3AV_CMD_AV_VID_480I:\r\ncase PS3AV_CMD_AV_VID_576I:\r\nd = 0;\r\nbreak;\r\ncase PS3AV_CMD_AV_VID_480P:\r\ncase PS3AV_CMD_AV_VID_576P:\r\nd = 1;\r\nbreak;\r\ncase PS3AV_CMD_AV_VID_1080I_60HZ:\r\ncase PS3AV_CMD_AV_VID_1080I_50HZ:\r\nd = 2;\r\nbreak;\r\ncase PS3AV_CMD_AV_VID_720P_60HZ:\r\ncase PS3AV_CMD_AV_VID_720P_50HZ:\r\nd = 3;\r\nbreak;\r\ncase PS3AV_CMD_AV_VID_1080P_60HZ:\r\ncase PS3AV_CMD_AV_VID_1080P_50HZ:\r\ncase PS3AV_CMD_AV_VID_WXGA:\r\ncase PS3AV_CMD_AV_VID_SXGA:\r\ncase PS3AV_CMD_AV_VID_WUXGA:\r\nd = 4;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "%s failed, vid:%x\n", __func__, video_vid);\r\nbreak;\r\n}\r\nif (fs < PS3AV_CMD_AUDIO_FS_44K || fs > PS3AV_CMD_AUDIO_FS_192K)\r\nprintk(KERN_ERR "%s failed, fs:%x\n", __func__, fs);\r\nelse\r\nns_val = ps3av_ns_table[PS3AV_CMD_AUDIO_FS_44K-BASE][d];\r\n*ns++ = ns_val & 0x000000FF;\r\n*ns++ = (ns_val & 0x0000FF00) >> 8;\r\n*ns = (ns_val & 0x00FF0000) >> 16;\r\n}\r\nstatic u8 ps3av_cnv_enable(u32 source, const u8 *enable)\r\n{\r\nu8 ret = 0;\r\nif (source == PS3AV_CMD_AUDIO_SOURCE_SPDIF) {\r\nret = 0x03;\r\n} else if (source == PS3AV_CMD_AUDIO_SOURCE_SERIAL) {\r\nret = ((enable[0] << 4) + (enable[1] << 5) + (enable[2] << 6) +\r\n(enable[3] << 7)) | 0x01;\r\n} else\r\nprintk(KERN_ERR "%s failed, source:%x\n", __func__, source);\r\nreturn ret;\r\n}\r\nstatic u8 ps3av_cnv_fifomap(const u8 *map)\r\n{\r\nu8 ret = 0;\r\nret = map[0] + (map[1] << 2) + (map[2] << 4) + (map[3] << 6);\r\nreturn ret;\r\n}\r\nstatic u8 ps3av_cnv_inputlen(u32 word_bits)\r\n{\r\nu8 ret = 0;\r\nswitch (word_bits) {\r\ncase PS3AV_CMD_AUDIO_WORD_BITS_16:\r\nret = PS3AV_CMD_AV_INPUTLEN_16;\r\nbreak;\r\ncase PS3AV_CMD_AUDIO_WORD_BITS_20:\r\nret = PS3AV_CMD_AV_INPUTLEN_20;\r\nbreak;\r\ncase PS3AV_CMD_AUDIO_WORD_BITS_24:\r\nret = PS3AV_CMD_AV_INPUTLEN_24;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "%s failed, word_bits:%x\n", __func__,\r\nword_bits);\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic u8 ps3av_cnv_layout(u32 num_of_ch)\r\n{\r\nif (num_of_ch > PS3AV_CMD_AUDIO_NUM_OF_CH_8) {\r\nprintk(KERN_ERR "%s failed, num_of_ch:%x\n", __func__,\r\nnum_of_ch);\r\nreturn 0;\r\n}\r\nreturn num_of_ch == PS3AV_CMD_AUDIO_NUM_OF_CH_2 ? 0x0 : 0x1;\r\n}\r\nstatic void ps3av_cnv_info(struct ps3av_audio_info_frame *info,\r\nconst struct ps3av_pkt_audio_mode *mode)\r\n{\r\ninfo->pb1.cc = mode->audio_num_of_ch + 1;\r\ninfo->pb1.ct = 0;\r\ninfo->pb2.sf = 0;\r\ninfo->pb2.ss = 0;\r\ninfo->pb3 = 0;\r\ninfo->pb4 = mode->audio_layout;\r\ninfo->pb5.dm = mode->audio_downmix;\r\ninfo->pb5.lsv = mode->audio_downmix_level;\r\n}\r\nstatic void ps3av_cnv_chstat(u8 *chstat, const u8 *cs_info)\r\n{\r\nmemcpy(chstat, cs_info, 5);\r\n}\r\nu32 ps3av_cmd_set_av_audio_param(void *p, u32 port,\r\nconst struct ps3av_pkt_audio_mode *audio_mode,\r\nu32 video_vid)\r\n{\r\nstruct ps3av_pkt_av_audio_param *param;\r\nparam = (struct ps3av_pkt_av_audio_param *)p;\r\nmemset(param, 0, sizeof(*param));\r\nps3av_set_hdr(PS3AV_CID_AV_AUDIO_PARAM, sizeof(*param),\r\n&param->send_hdr);\r\nparam->avport = port;\r\nparam->mclk = ps3av_cnv_mclk(audio_mode->audio_fs) | 0x80;\r\nps3av_cnv_ns(param->ns, audio_mode->audio_fs, video_vid);\r\nparam->enable = ps3av_cnv_enable(audio_mode->audio_source,\r\naudio_mode->audio_enable);\r\nparam->swaplr = 0x09;\r\nparam->fifomap = ps3av_cnv_fifomap(audio_mode->audio_map);\r\nparam->inputctrl = 0x49;\r\nparam->inputlen = ps3av_cnv_inputlen(audio_mode->audio_word_bits);\r\nparam->layout = ps3av_cnv_layout(audio_mode->audio_num_of_ch);\r\nps3av_cnv_info(&param->info, audio_mode);\r\nps3av_cnv_chstat(param->chstat, audio_mode->audio_cs_info);\r\nreturn sizeof(*param);\r\n}\r\nvoid ps3av_cmd_set_audio_mode(struct ps3av_pkt_audio_mode *audio, u32 avport,\r\nu32 ch, u32 fs, u32 word_bits, u32 format,\r\nu32 source)\r\n{\r\nint spdif_through;\r\nint i;\r\nif (!(ch | fs | format | word_bits | source)) {\r\nch = PS3AV_CMD_AUDIO_NUM_OF_CH_2;\r\nfs = PS3AV_CMD_AUDIO_FS_48K;\r\nword_bits = PS3AV_CMD_AUDIO_WORD_BITS_16;\r\nformat = PS3AV_CMD_AUDIO_FORMAT_PCM;\r\nsource = PS3AV_CMD_AUDIO_SOURCE_SERIAL;\r\n}\r\nmemset(audio, 0, sizeof(*audio));\r\nps3av_set_hdr(PS3AV_CID_AUDIO_MODE, sizeof(*audio), &audio->send_hdr);\r\naudio->avport = (u8) avport;\r\naudio->mask = 0x0FFF;\r\naudio->audio_num_of_ch = ch;\r\naudio->audio_fs = fs;\r\naudio->audio_word_bits = word_bits;\r\naudio->audio_format = format;\r\naudio->audio_source = source;\r\nswitch (ch) {\r\ncase PS3AV_CMD_AUDIO_NUM_OF_CH_8:\r\naudio->audio_enable[3] = 1;\r\ncase PS3AV_CMD_AUDIO_NUM_OF_CH_6:\r\naudio->audio_enable[2] = 1;\r\naudio->audio_enable[1] = 1;\r\ncase PS3AV_CMD_AUDIO_NUM_OF_CH_2:\r\ndefault:\r\naudio->audio_enable[0] = 1;\r\n}\r\nfor (i = 0; i < 4; i++)\r\naudio->audio_swap[i] = PS3AV_CMD_AUDIO_SWAP_0;\r\naudio->audio_map[0] = PS3AV_CMD_AUDIO_MAP_OUTPUT_0;\r\naudio->audio_map[1] = PS3AV_CMD_AUDIO_MAP_OUTPUT_1;\r\naudio->audio_map[2] = PS3AV_CMD_AUDIO_MAP_OUTPUT_2;\r\naudio->audio_map[3] = PS3AV_CMD_AUDIO_MAP_OUTPUT_3;\r\nif (avport == PS3AV_CMD_AVPORT_HDMI_0 ||\r\navport == PS3AV_CMD_AVPORT_HDMI_1) {\r\nswitch (ch) {\r\ncase PS3AV_CMD_AUDIO_NUM_OF_CH_8:\r\naudio->audio_layout = PS3AV_CMD_AUDIO_LAYOUT_8CH;\r\nbreak;\r\ncase PS3AV_CMD_AUDIO_NUM_OF_CH_6:\r\naudio->audio_layout = PS3AV_CMD_AUDIO_LAYOUT_6CH;\r\nbreak;\r\ncase PS3AV_CMD_AUDIO_NUM_OF_CH_2:\r\ndefault:\r\naudio->audio_layout = PS3AV_CMD_AUDIO_LAYOUT_2CH;\r\nbreak;\r\n}\r\n} else {\r\naudio->audio_layout = PS3AV_CMD_AUDIO_LAYOUT_2CH;\r\n}\r\naudio->audio_downmix = PS3AV_CMD_AUDIO_DOWNMIX_PERMITTED;\r\naudio->audio_downmix_level = 0;\r\nfor (i = 0; i < 8; i++)\r\naudio->audio_cs_info[i] = ps3av_mode_cs_info[i];\r\nswitch (fs) {\r\ncase PS3AV_CMD_AUDIO_FS_44K:\r\naudio->audio_cs_info[3] &= ~CS_MASK;\r\naudio->audio_cs_info[3] |= CS_44;\r\nbreak;\r\ncase PS3AV_CMD_AUDIO_FS_88K:\r\naudio->audio_cs_info[3] &= ~CS_MASK;\r\naudio->audio_cs_info[3] |= CS_88;\r\nbreak;\r\ncase PS3AV_CMD_AUDIO_FS_96K:\r\naudio->audio_cs_info[3] &= ~CS_MASK;\r\naudio->audio_cs_info[3] |= CS_96;\r\nbreak;\r\ncase PS3AV_CMD_AUDIO_FS_176K:\r\naudio->audio_cs_info[3] &= ~CS_MASK;\r\naudio->audio_cs_info[3] |= CS_176;\r\nbreak;\r\ncase PS3AV_CMD_AUDIO_FS_192K:\r\naudio->audio_cs_info[3] &= ~CS_MASK;\r\naudio->audio_cs_info[3] |= CS_192;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nspdif_through = audio->audio_cs_info[0] & 0x02;\r\nif (spdif_through &&\r\n(avport == PS3AV_CMD_AVPORT_SPDIF_0 ||\r\navport == PS3AV_CMD_AVPORT_SPDIF_1 ||\r\navport == PS3AV_CMD_AVPORT_HDMI_0 ||\r\navport == PS3AV_CMD_AVPORT_HDMI_1)) {\r\naudio->audio_word_bits = PS3AV_CMD_AUDIO_WORD_BITS_16;\r\naudio->audio_format = PS3AV_CMD_AUDIO_FORMAT_BITSTREAM;\r\n}\r\n}\r\nint ps3av_cmd_audio_mode(struct ps3av_pkt_audio_mode *audio_mode)\r\n{\r\nint res;\r\nres = ps3av_do_pkt(PS3AV_CID_AUDIO_MODE, sizeof(*audio_mode),\r\nsizeof(*audio_mode), &audio_mode->send_hdr);\r\nif (res < 0)\r\nreturn res;\r\nres = get_status(audio_mode);\r\nif (res)\r\nprintk(KERN_ERR "PS3AV_CID_AUDIO_MODE: failed %x\n", res);\r\nreturn res;\r\n}\r\nint ps3av_cmd_audio_mute(int num_of_port, u32 *port, u32 mute)\r\n{\r\nint i, res;\r\nstruct ps3av_pkt_audio_mute audio_mute;\r\nif (num_of_port > PS3AV_OPT_PORT_MAX)\r\nreturn -EINVAL;\r\nmemset(&audio_mute, 0, sizeof(audio_mute));\r\nfor (i = 0; i < num_of_port; i++) {\r\naudio_mute.mute[i].avport = port[i];\r\naudio_mute.mute[i].mute = mute;\r\n}\r\nres = ps3av_do_pkt(PS3AV_CID_AUDIO_MUTE,\r\nsizeof(audio_mute.send_hdr) +\r\nsizeof(struct ps3av_audio_mute) * num_of_port,\r\nsizeof(audio_mute), &audio_mute.send_hdr);\r\nif (res < 0)\r\nreturn res;\r\nres = get_status(&audio_mute);\r\nif (res)\r\nprintk(KERN_ERR "PS3AV_CID_AUDIO_MUTE: failed %x\n", res);\r\nreturn res;\r\n}\r\nint ps3av_cmd_audio_active(int active, u32 port)\r\n{\r\nint res;\r\nstruct ps3av_pkt_audio_active audio_active;\r\nu32 cid;\r\nmemset(&audio_active, 0, sizeof(audio_active));\r\naudio_active.audio_port = port;\r\ncid = active ? PS3AV_CID_AUDIO_ACTIVE : PS3AV_CID_AUDIO_INACTIVE;\r\nres = ps3av_do_pkt(cid, sizeof(audio_active), sizeof(audio_active),\r\n&audio_active.send_hdr);\r\nif (res < 0)\r\nreturn res;\r\nres = get_status(&audio_active);\r\nif (res)\r\nprintk(KERN_ERR "PS3AV_CID_AUDIO_ACTIVE:%x failed %x\n", cid,\r\nres);\r\nreturn res;\r\n}\r\nint ps3av_cmd_avb_param(struct ps3av_pkt_avb_param *avb, u32 send_len)\r\n{\r\nint res;\r\nmutex_lock(&ps3_gpu_mutex);\r\nres = ps3av_do_pkt(PS3AV_CID_AVB_PARAM, send_len, sizeof(*avb),\r\n&avb->send_hdr);\r\nif (res < 0)\r\ngoto out;\r\nres = get_status(avb);\r\nif (res)\r\npr_debug("%s: PS3AV_CID_AVB_PARAM: failed %x\n", __func__,\r\nres);\r\nout:\r\nmutex_unlock(&ps3_gpu_mutex);\r\nreturn res;\r\n}\r\nint ps3av_cmd_av_get_hw_conf(struct ps3av_pkt_av_get_hw_conf *hw_conf)\r\n{\r\nint res;\r\nmemset(hw_conf, 0, sizeof(*hw_conf));\r\nres = ps3av_do_pkt(PS3AV_CID_AV_GET_HW_CONF, sizeof(hw_conf->send_hdr),\r\nsizeof(*hw_conf), &hw_conf->send_hdr);\r\nif (res < 0)\r\nreturn res;\r\nres = get_status(hw_conf);\r\nif (res)\r\nprintk(KERN_ERR "PS3AV_CID_AV_GET_HW_CONF: failed %x\n", res);\r\nreturn res;\r\n}\r\nint ps3av_cmd_video_get_monitor_info(struct ps3av_pkt_av_get_monitor_info *info,\r\nu32 avport)\r\n{\r\nint res;\r\nmemset(info, 0, sizeof(*info));\r\ninfo->avport = avport;\r\nres = ps3av_do_pkt(PS3AV_CID_AV_GET_MONITOR_INFO,\r\nsizeof(info->send_hdr) + sizeof(info->avport) +\r\nsizeof(info->reserved),\r\nsizeof(*info), &info->send_hdr);\r\nif (res < 0)\r\nreturn res;\r\nres = get_status(info);\r\nif (res)\r\nprintk(KERN_ERR "PS3AV_CID_AV_GET_MONITOR_INFO: failed %x\n",\r\nres);\r\nreturn res;\r\n}

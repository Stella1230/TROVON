static int tps65090_low_chrg_current(struct tps65090_charger *charger)\r\n{\r\nint ret;\r\nret = tps65090_write(charger->dev->parent, TPS65090_REG_CG_CTRL5,\r\nTPS65090_NOITERM);\r\nif (ret < 0) {\r\ndev_err(charger->dev, "%s(): error reading in register 0x%x\n",\r\n__func__, TPS65090_REG_CG_CTRL5);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tps65090_enable_charging(struct tps65090_charger *charger)\r\n{\r\nint ret;\r\nuint8_t ctrl0 = 0;\r\nret = tps65090_read(charger->dev->parent, TPS65090_REG_CG_CTRL0,\r\n&ctrl0);\r\nif (ret < 0) {\r\ndev_err(charger->dev, "%s(): error reading in register 0x%x\n",\r\n__func__, TPS65090_REG_CG_CTRL0);\r\nreturn ret;\r\n}\r\nret = tps65090_write(charger->dev->parent, TPS65090_REG_CG_CTRL0,\r\n(ctrl0 | TPS65090_CHARGER_ENABLE));\r\nif (ret < 0) {\r\ndev_err(charger->dev, "%s(): error writing in register 0x%x\n",\r\n__func__, TPS65090_REG_CG_CTRL0);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tps65090_config_charger(struct tps65090_charger *charger)\r\n{\r\nuint8_t intrmask = 0;\r\nint ret;\r\nif (charger->pdata->enable_low_current_chrg) {\r\nret = tps65090_low_chrg_current(charger);\r\nif (ret < 0) {\r\ndev_err(charger->dev,\r\n"error configuring low charge current\n");\r\nreturn ret;\r\n}\r\n}\r\nret = tps65090_read(charger->dev->parent, TPS65090_REG_INTR_MASK,\r\n&intrmask);\r\nif (ret < 0) {\r\ndev_err(charger->dev, "%s(): error reading in register 0x%x\n",\r\n__func__, TPS65090_REG_INTR_MASK);\r\nreturn ret;\r\n}\r\nret = tps65090_write(charger->dev->parent, TPS65090_REG_INTR_MASK,\r\n(intrmask | TPS65090_VACG));\r\nif (ret < 0) {\r\ndev_err(charger->dev, "%s(): error writing in register 0x%x\n",\r\n__func__, TPS65090_REG_CG_CTRL0);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tps65090_ac_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct tps65090_charger *charger = container_of(psy,\r\nstruct tps65090_charger, ac);\r\nif (psp == POWER_SUPPLY_PROP_ONLINE) {\r\nval->intval = charger->ac_online;\r\ncharger->prev_ac_online = charger->ac_online;\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic irqreturn_t tps65090_charger_isr(int irq, void *dev_id)\r\n{\r\nstruct tps65090_charger *charger = dev_id;\r\nint ret;\r\nuint8_t status1 = 0;\r\nuint8_t intrsts = 0;\r\nret = tps65090_read(charger->dev->parent, TPS65090_REG_CG_STATUS1,\r\n&status1);\r\nif (ret < 0) {\r\ndev_err(charger->dev, "%s(): Error in reading reg 0x%x\n",\r\n__func__, TPS65090_REG_CG_STATUS1);\r\nreturn IRQ_HANDLED;\r\n}\r\nmsleep(75);\r\nret = tps65090_read(charger->dev->parent, TPS65090_REG_INTR_STS,\r\n&intrsts);\r\nif (ret < 0) {\r\ndev_err(charger->dev, "%s(): Error in reading reg 0x%x\n",\r\n__func__, TPS65090_REG_INTR_STS);\r\nreturn IRQ_HANDLED;\r\n}\r\nif (intrsts & TPS65090_VACG) {\r\nret = tps65090_enable_charging(charger);\r\nif (ret < 0)\r\nreturn IRQ_HANDLED;\r\ncharger->ac_online = 1;\r\n} else {\r\ncharger->ac_online = 0;\r\n}\r\nret = tps65090_write(charger->dev->parent, TPS65090_REG_INTR_STS, 0x00);\r\nif (ret < 0) {\r\ndev_err(charger->dev, "%s(): Error in writing reg 0x%x\n",\r\n__func__, TPS65090_REG_INTR_STS);\r\n}\r\nif (charger->prev_ac_online != charger->ac_online)\r\npower_supply_changed(&charger->ac);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic struct tps65090_platform_data *\r\ntps65090_parse_dt_charger_data(struct platform_device *pdev)\r\n{\r\nstruct tps65090_platform_data *pdata;\r\nstruct device_node *np = pdev->dev.of_node;\r\nunsigned int prop;\r\npdata = devm_kzalloc(&pdev->dev, sizeof(*pdata), GFP_KERNEL);\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "Memory alloc for tps65090_pdata failed\n");\r\nreturn NULL;\r\n}\r\nprop = of_property_read_bool(np, "ti,enable-low-current-chrg");\r\npdata->enable_low_current_chrg = prop;\r\npdata->irq_base = -1;\r\nreturn pdata;\r\n}\r\nstatic struct tps65090_platform_data *\r\ntps65090_parse_dt_charger_data(struct platform_device *pdev)\r\n{\r\nreturn NULL;\r\n}\r\nstatic int tps65090_charger_probe(struct platform_device *pdev)\r\n{\r\nstruct tps65090_charger *cdata;\r\nstruct tps65090_platform_data *pdata;\r\nuint8_t status1 = 0;\r\nint ret;\r\nint irq;\r\npdata = dev_get_platdata(pdev->dev.parent);\r\nif (!pdata && pdev->dev.of_node)\r\npdata = tps65090_parse_dt_charger_data(pdev);\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "%s():no platform data available\n",\r\n__func__);\r\nreturn -ENODEV;\r\n}\r\ncdata = devm_kzalloc(&pdev->dev, sizeof(*cdata), GFP_KERNEL);\r\nif (!cdata) {\r\ndev_err(&pdev->dev, "failed to allocate memory status\n");\r\nreturn -ENOMEM;\r\n}\r\nplatform_set_drvdata(pdev, cdata);\r\ncdata->dev = &pdev->dev;\r\ncdata->pdata = pdata;\r\ncdata->ac.name = "tps65090-ac";\r\ncdata->ac.type = POWER_SUPPLY_TYPE_MAINS;\r\ncdata->ac.get_property = tps65090_ac_get_property;\r\ncdata->ac.properties = tps65090_ac_props;\r\ncdata->ac.num_properties = ARRAY_SIZE(tps65090_ac_props);\r\ncdata->ac.supplied_to = pdata->supplied_to;\r\ncdata->ac.num_supplicants = pdata->num_supplicants;\r\ncdata->ac.of_node = pdev->dev.of_node;\r\nret = power_supply_register(&pdev->dev, &cdata->ac);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed: power supply register\n");\r\nreturn ret;\r\n}\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq <= 0) {\r\ndev_warn(&pdev->dev, "Unable to get charger irq = %d\n", irq);\r\nret = irq;\r\ngoto fail_unregister_supply;\r\n}\r\ncdata->irq = irq;\r\nret = devm_request_threaded_irq(&pdev->dev, irq, NULL,\r\ntps65090_charger_isr, 0, "tps65090-charger", cdata);\r\nif (ret) {\r\ndev_err(cdata->dev, "Unable to register irq %d err %d\n", irq,\r\nret);\r\ngoto fail_free_irq;\r\n}\r\nret = tps65090_config_charger(cdata);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "charger config failed, err %d\n", ret);\r\ngoto fail_free_irq;\r\n}\r\nret = tps65090_read(cdata->dev->parent, TPS65090_REG_CG_STATUS1,\r\n&status1);\r\nif (ret < 0) {\r\ndev_err(cdata->dev, "%s(): Error in reading reg 0x%x", __func__,\r\nTPS65090_REG_CG_STATUS1);\r\ngoto fail_free_irq;\r\n}\r\nif (status1 != 0) {\r\nret = tps65090_enable_charging(cdata);\r\nif (ret < 0) {\r\ndev_err(cdata->dev, "error enabling charger\n");\r\ngoto fail_free_irq;\r\n}\r\ncdata->ac_online = 1;\r\npower_supply_changed(&cdata->ac);\r\n}\r\nreturn 0;\r\nfail_free_irq:\r\ndevm_free_irq(cdata->dev, irq, cdata);\r\nfail_unregister_supply:\r\npower_supply_unregister(&cdata->ac);\r\nreturn ret;\r\n}\r\nstatic int tps65090_charger_remove(struct platform_device *pdev)\r\n{\r\nstruct tps65090_charger *cdata = platform_get_drvdata(pdev);\r\ndevm_free_irq(cdata->dev, cdata->irq, cdata);\r\npower_supply_unregister(&cdata->ac);\r\nreturn 0;\r\n}

static char *rds_cm_event_str(enum rdma_cm_event_type type)\r\n{\r\nreturn rds_str_array(rds_cm_event_strings,\r\nARRAY_SIZE(rds_cm_event_strings), type);\r\n}\r\nint rds_rdma_cm_event_handler(struct rdma_cm_id *cm_id,\r\nstruct rdma_cm_event *event)\r\n{\r\nstruct rds_connection *conn = cm_id->context;\r\nstruct rds_transport *trans;\r\nint ret = 0;\r\nrdsdebug("conn %p id %p handling event %u (%s)\n", conn, cm_id,\r\nevent->event, rds_cm_event_str(event->event));\r\nif (cm_id->device->node_type == RDMA_NODE_RNIC)\r\ntrans = &rds_iw_transport;\r\nelse\r\ntrans = &rds_ib_transport;\r\nif (conn) {\r\nmutex_lock(&conn->c_cm_lock);\r\nif (rds_conn_state(conn) == RDS_CONN_DISCONNECTING) {\r\nif (event->event == RDMA_CM_EVENT_CONNECT_REQUEST)\r\nret = 1;\r\ngoto out;\r\n}\r\n}\r\nswitch (event->event) {\r\ncase RDMA_CM_EVENT_CONNECT_REQUEST:\r\nret = trans->cm_handle_connect(cm_id, event);\r\nbreak;\r\ncase RDMA_CM_EVENT_ADDR_RESOLVED:\r\nret = rdma_resolve_route(cm_id,\r\nRDS_RDMA_RESOLVE_TIMEOUT_MS);\r\nbreak;\r\ncase RDMA_CM_EVENT_ROUTE_RESOLVED:\r\nret = trans->cm_initiate_connect(cm_id);\r\nbreak;\r\ncase RDMA_CM_EVENT_ESTABLISHED:\r\ntrans->cm_connect_complete(conn, event);\r\nbreak;\r\ncase RDMA_CM_EVENT_ADDR_ERROR:\r\ncase RDMA_CM_EVENT_ROUTE_ERROR:\r\ncase RDMA_CM_EVENT_CONNECT_ERROR:\r\ncase RDMA_CM_EVENT_UNREACHABLE:\r\ncase RDMA_CM_EVENT_REJECTED:\r\ncase RDMA_CM_EVENT_DEVICE_REMOVAL:\r\ncase RDMA_CM_EVENT_ADDR_CHANGE:\r\nif (conn)\r\nrds_conn_drop(conn);\r\nbreak;\r\ncase RDMA_CM_EVENT_DISCONNECTED:\r\nrdsdebug("DISCONNECT event - dropping connection "\r\n"%pI4->%pI4\n", &conn->c_laddr,\r\n&conn->c_faddr);\r\nrds_conn_drop(conn);\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "RDS: unknown event %u (%s)!\n",\r\nevent->event, rds_cm_event_str(event->event));\r\nbreak;\r\n}\r\nout:\r\nif (conn)\r\nmutex_unlock(&conn->c_cm_lock);\r\nrdsdebug("id %p event %u (%s) handling ret %d\n", cm_id, event->event,\r\nrds_cm_event_str(event->event), ret);\r\nreturn ret;\r\n}\r\nstatic int rds_rdma_listen_init(void)\r\n{\r\nstruct sockaddr_in sin;\r\nstruct rdma_cm_id *cm_id;\r\nint ret;\r\ncm_id = rdma_create_id(rds_rdma_cm_event_handler, NULL, RDMA_PS_TCP,\r\nIB_QPT_RC);\r\nif (IS_ERR(cm_id)) {\r\nret = PTR_ERR(cm_id);\r\nprintk(KERN_ERR "RDS/RDMA: failed to setup listener, "\r\n"rdma_create_id() returned %d\n", ret);\r\nreturn ret;\r\n}\r\nsin.sin_family = AF_INET,\r\nsin.sin_addr.s_addr = (__force u32)htonl(INADDR_ANY);\r\nsin.sin_port = (__force u16)htons(RDS_PORT);\r\nret = rdma_bind_addr(cm_id, (struct sockaddr *)&sin);\r\nif (ret) {\r\nprintk(KERN_ERR "RDS/RDMA: failed to setup listener, "\r\n"rdma_bind_addr() returned %d\n", ret);\r\ngoto out;\r\n}\r\nret = rdma_listen(cm_id, 128);\r\nif (ret) {\r\nprintk(KERN_ERR "RDS/RDMA: failed to setup listener, "\r\n"rdma_listen() returned %d\n", ret);\r\ngoto out;\r\n}\r\nrdsdebug("cm %p listening on port %u\n", cm_id, RDS_PORT);\r\nrds_rdma_listen_id = cm_id;\r\ncm_id = NULL;\r\nout:\r\nif (cm_id)\r\nrdma_destroy_id(cm_id);\r\nreturn ret;\r\n}\r\nstatic void rds_rdma_listen_stop(void)\r\n{\r\nif (rds_rdma_listen_id) {\r\nrdsdebug("cm %p\n", rds_rdma_listen_id);\r\nrdma_destroy_id(rds_rdma_listen_id);\r\nrds_rdma_listen_id = NULL;\r\n}\r\n}\r\nstatic int rds_rdma_init(void)\r\n{\r\nint ret;\r\nret = rds_rdma_listen_init();\r\nif (ret)\r\ngoto out;\r\nret = rds_iw_init();\r\nif (ret)\r\ngoto err_iw_init;\r\nret = rds_ib_init();\r\nif (ret)\r\ngoto err_ib_init;\r\ngoto out;\r\nerr_ib_init:\r\nrds_iw_exit();\r\nerr_iw_init:\r\nrds_rdma_listen_stop();\r\nout:\r\nreturn ret;\r\n}\r\nstatic void rds_rdma_exit(void)\r\n{\r\nrds_rdma_listen_stop();\r\nrds_ib_exit();\r\nrds_iw_exit();\r\n}

static int via_do_init_map(struct drm_device *dev, drm_via_init_t *init)\r\n{\r\ndrm_via_private_t *dev_priv = dev->dev_private;\r\nDRM_DEBUG("\n");\r\ndev_priv->sarea = drm_getsarea(dev);\r\nif (!dev_priv->sarea) {\r\nDRM_ERROR("could not find sarea!\n");\r\ndev->dev_private = (void *)dev_priv;\r\nvia_do_cleanup_map(dev);\r\nreturn -EINVAL;\r\n}\r\ndev_priv->fb = drm_core_findmap(dev, init->fb_offset);\r\nif (!dev_priv->fb) {\r\nDRM_ERROR("could not find framebuffer!\n");\r\ndev->dev_private = (void *)dev_priv;\r\nvia_do_cleanup_map(dev);\r\nreturn -EINVAL;\r\n}\r\ndev_priv->mmio = drm_core_findmap(dev, init->mmio_offset);\r\nif (!dev_priv->mmio) {\r\nDRM_ERROR("could not find mmio region!\n");\r\ndev->dev_private = (void *)dev_priv;\r\nvia_do_cleanup_map(dev);\r\nreturn -EINVAL;\r\n}\r\ndev_priv->sarea_priv =\r\n(drm_via_sarea_t *) ((u8 *) dev_priv->sarea->handle +\r\ninit->sarea_priv_offset);\r\ndev_priv->agpAddr = init->agpAddr;\r\nvia_init_futex(dev_priv);\r\nvia_init_dmablit(dev);\r\ndev->dev_private = (void *)dev_priv;\r\nreturn 0;\r\n}\r\nint via_do_cleanup_map(struct drm_device *dev)\r\n{\r\nvia_dma_cleanup(dev);\r\nreturn 0;\r\n}\r\nint via_map_init(struct drm_device *dev, void *data, struct drm_file *file_priv)\r\n{\r\ndrm_via_init_t *init = data;\r\nDRM_DEBUG("\n");\r\nswitch (init->func) {\r\ncase VIA_INIT_MAP:\r\nreturn via_do_init_map(dev, init);\r\ncase VIA_CLEANUP_MAP:\r\nreturn via_do_cleanup_map(dev);\r\n}\r\nreturn -EINVAL;\r\n}\r\nint via_driver_load(struct drm_device *dev, unsigned long chipset)\r\n{\r\ndrm_via_private_t *dev_priv;\r\nint ret = 0;\r\ndev_priv = kzalloc(sizeof(drm_via_private_t), GFP_KERNEL);\r\nif (dev_priv == NULL)\r\nreturn -ENOMEM;\r\nidr_init(&dev_priv->object_idr);\r\ndev->dev_private = (void *)dev_priv;\r\ndev_priv->chipset = chipset;\r\npci_set_master(dev->pdev);\r\nret = drm_vblank_init(dev, 1);\r\nif (ret) {\r\nkfree(dev_priv);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nint via_driver_unload(struct drm_device *dev)\r\n{\r\ndrm_via_private_t *dev_priv = dev->dev_private;\r\nidr_destroy(&dev_priv->object_idr);\r\nkfree(dev_priv);\r\nreturn 0;\r\n}

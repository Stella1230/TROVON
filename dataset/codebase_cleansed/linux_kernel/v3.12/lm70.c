static ssize_t lm70_sense_temp(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nint status, val = 0;\r\nu8 rxbuf[2];\r\ns16 raw = 0;\r\nstruct lm70 *p_lm70 = spi_get_drvdata(spi);\r\nif (mutex_lock_interruptible(&p_lm70->lock))\r\nreturn -ERESTARTSYS;\r\nstatus = spi_write_then_read(spi, NULL, 0, &rxbuf[0], 2);\r\nif (status < 0) {\r\npr_warn("spi_write_then_read failed with status %d\n", status);\r\ngoto out;\r\n}\r\nraw = (rxbuf[0] << 8) + rxbuf[1];\r\ndev_dbg(dev, "rxbuf[0] : 0x%02x rxbuf[1] : 0x%02x raw=0x%04x\n",\r\nrxbuf[0], rxbuf[1], raw);\r\nswitch (p_lm70->chip) {\r\ncase LM70_CHIP_LM70:\r\nval = ((int)raw / 32) * 250;\r\nbreak;\r\ncase LM70_CHIP_TMP121:\r\ncase LM70_CHIP_LM74:\r\nval = ((int)raw / 8) * 625 / 10;\r\nbreak;\r\ncase LM70_CHIP_LM71:\r\nval = ((int)raw / 4) * 3125 / 100;\r\nbreak;\r\n}\r\nstatus = sprintf(buf, "%d\n", val);\r\nout:\r\nmutex_unlock(&p_lm70->lock);\r\nreturn status;\r\n}\r\nstatic ssize_t lm70_show_name(struct device *dev, struct device_attribute\r\n*devattr, char *buf)\r\n{\r\nreturn sprintf(buf, "%s\n", to_spi_device(dev)->modalias);\r\n}\r\nstatic int lm70_probe(struct spi_device *spi)\r\n{\r\nint chip = spi_get_device_id(spi)->driver_data;\r\nstruct lm70 *p_lm70;\r\nint status;\r\nif (spi->mode & (SPI_CPOL | SPI_CPHA))\r\nreturn -EINVAL;\r\np_lm70 = devm_kzalloc(&spi->dev, sizeof(*p_lm70), GFP_KERNEL);\r\nif (!p_lm70)\r\nreturn -ENOMEM;\r\nmutex_init(&p_lm70->lock);\r\np_lm70->chip = chip;\r\nspi_set_drvdata(spi, p_lm70);\r\nstatus = device_create_file(&spi->dev, &dev_attr_temp1_input);\r\nif (status)\r\ngoto out_dev_create_temp_file_failed;\r\nstatus = device_create_file(&spi->dev, &dev_attr_name);\r\nif (status)\r\ngoto out_dev_create_file_failed;\r\np_lm70->hwmon_dev = hwmon_device_register(&spi->dev);\r\nif (IS_ERR(p_lm70->hwmon_dev)) {\r\ndev_dbg(&spi->dev, "hwmon_device_register failed.\n");\r\nstatus = PTR_ERR(p_lm70->hwmon_dev);\r\ngoto out_dev_reg_failed;\r\n}\r\nreturn 0;\r\nout_dev_reg_failed:\r\ndevice_remove_file(&spi->dev, &dev_attr_name);\r\nout_dev_create_file_failed:\r\ndevice_remove_file(&spi->dev, &dev_attr_temp1_input);\r\nout_dev_create_temp_file_failed:\r\nspi_set_drvdata(spi, NULL);\r\nreturn status;\r\n}\r\nstatic int lm70_remove(struct spi_device *spi)\r\n{\r\nstruct lm70 *p_lm70 = spi_get_drvdata(spi);\r\nhwmon_device_unregister(p_lm70->hwmon_dev);\r\ndevice_remove_file(&spi->dev, &dev_attr_temp1_input);\r\ndevice_remove_file(&spi->dev, &dev_attr_name);\r\nspi_set_drvdata(spi, NULL);\r\nreturn 0;\r\n}

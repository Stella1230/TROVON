size_t copy_from_user_std(size_t size, const void __user *ptr, void *x)\r\n{\r\nunsigned long tmp1, tmp2;\r\ntmp1 = -256UL;\r\nasm volatile(\r\n"0: mvcp 0(%0,%2),0(%1),%3\n"\r\n"10:jz 8f\n"\r\n"1:"ALR" %0,%3\n"\r\n" la %1,256(%1)\n"\r\n" la %2,256(%2)\n"\r\n"2: mvcp 0(%0,%2),0(%1),%3\n"\r\n"11:jnz 1b\n"\r\n" j 8f\n"\r\n"3: la %4,255(%1)\n"\r\n" "LHI" %3,-4096\n"\r\n" nr %4,%3\n"\r\n" "SLR" %4,%1\n"\r\n" "CLR" %0,%4\n"\r\n" jnh 5f\n"\r\n"4: mvcp 0(%4,%2),0(%1),%3\n"\r\n"12:"SLR" %0,%4\n"\r\n" "ALR" %2,%4\n"\r\n"5:"LHI" %4,-1\n"\r\n" "ALR" %4,%0\n"\r\n" bras %3,7f\n"\r\n" xc 0(1,%2),0(%2)\n"\r\n"6: xc 0(256,%2),0(%2)\n"\r\n" la %2,256(%2)\n"\r\n"7:"AHI" %4,-256\n"\r\n" jnm 6b\n"\r\n" ex %4,0(%3)\n"\r\n" j 9f\n"\r\n"8:"SLR" %0,%0\n"\r\n"9: \n"\r\nEX_TABLE(0b,3b) EX_TABLE(2b,3b) EX_TABLE(4b,5b)\r\nEX_TABLE(10b,3b) EX_TABLE(11b,3b) EX_TABLE(12b,5b)\r\n: "+a" (size), "+a" (ptr), "+a" (x), "+a" (tmp1), "=a" (tmp2)\r\n: : "cc", "memory");\r\nreturn size;\r\n}\r\nstatic size_t copy_from_user_std_check(size_t size, const void __user *ptr,\r\nvoid *x)\r\n{\r\nif (size <= 1024)\r\nreturn copy_from_user_std(size, ptr, x);\r\nreturn copy_from_user_pt(size, ptr, x);\r\n}\r\nsize_t copy_to_user_std(size_t size, void __user *ptr, const void *x)\r\n{\r\nunsigned long tmp1, tmp2;\r\ntmp1 = -256UL;\r\nasm volatile(\r\n"0: mvcs 0(%0,%1),0(%2),%3\n"\r\n"7: jz 5f\n"\r\n"1:"ALR" %0,%3\n"\r\n" la %1,256(%1)\n"\r\n" la %2,256(%2)\n"\r\n"2: mvcs 0(%0,%1),0(%2),%3\n"\r\n"8: jnz 1b\n"\r\n" j 5f\n"\r\n"3: la %4,255(%1)\n"\r\n" "LHI" %3,-4096\n"\r\n" nr %4,%3\n"\r\n" "SLR" %4,%1\n"\r\n" "CLR" %0,%4\n"\r\n" jnh 6f\n"\r\n"4: mvcs 0(%4,%1),0(%2),%3\n"\r\n"9:"SLR" %0,%4\n"\r\n" j 6f\n"\r\n"5:"SLR" %0,%0\n"\r\n"6: \n"\r\nEX_TABLE(0b,3b) EX_TABLE(2b,3b) EX_TABLE(4b,6b)\r\nEX_TABLE(7b,3b) EX_TABLE(8b,3b) EX_TABLE(9b,6b)\r\n: "+a" (size), "+a" (ptr), "+a" (x), "+a" (tmp1), "=a" (tmp2)\r\n: : "cc", "memory");\r\nreturn size;\r\n}\r\nstatic size_t copy_to_user_std_check(size_t size, void __user *ptr,\r\nconst void *x)\r\n{\r\nif (size <= 1024)\r\nreturn copy_to_user_std(size, ptr, x);\r\nreturn copy_to_user_pt(size, ptr, x);\r\n}\r\nstatic size_t copy_in_user_std(size_t size, void __user *to,\r\nconst void __user *from)\r\n{\r\nunsigned long tmp1;\r\nasm volatile(\r\n" sacf 256\n"\r\n" "AHI" %0,-1\n"\r\n" jo 5f\n"\r\n" bras %3,3f\n"\r\n"0:"AHI" %0,257\n"\r\n"1: mvc 0(1,%1),0(%2)\n"\r\n" la %1,1(%1)\n"\r\n" la %2,1(%2)\n"\r\n" "AHI" %0,-1\n"\r\n" jnz 1b\n"\r\n" j 5f\n"\r\n"2: mvc 0(256,%1),0(%2)\n"\r\n" la %1,256(%1)\n"\r\n" la %2,256(%2)\n"\r\n"3:"AHI" %0,-256\n"\r\n" jnm 2b\n"\r\n"4: ex %0,1b-0b(%3)\n"\r\n"5: "SLR" %0,%0\n"\r\n"6: sacf 0\n"\r\nEX_TABLE(1b,6b) EX_TABLE(2b,0b) EX_TABLE(4b,0b)\r\n: "+a" (size), "+a" (to), "+a" (from), "=a" (tmp1)\r\n: : "cc", "memory");\r\nreturn size;\r\n}\r\nstatic size_t clear_user_std(size_t size, void __user *to)\r\n{\r\nunsigned long tmp1, tmp2;\r\nasm volatile(\r\n" sacf 256\n"\r\n" "AHI" %0,-1\n"\r\n" jo 5f\n"\r\n" bras %3,3f\n"\r\n" xc 0(1,%1),0(%1)\n"\r\n"0:"AHI" %0,257\n"\r\n" la %2,255(%1)\n"\r\n" srl %2,12\n"\r\n" sll %2,12\n"\r\n" "SLR" %2,%1\n"\r\n" "CLR" %0,%2\n"\r\n" jnh 5f\n"\r\n" "AHI" %2,-1\n"\r\n"1: ex %2,0(%3)\n"\r\n" "AHI" %2,1\n"\r\n" "SLR" %0,%2\n"\r\n" j 5f\n"\r\n"2: xc 0(256,%1),0(%1)\n"\r\n" la %1,256(%1)\n"\r\n"3:"AHI" %0,-256\n"\r\n" jnm 2b\n"\r\n"4: ex %0,0(%3)\n"\r\n"5: "SLR" %0,%0\n"\r\n"6: sacf 0\n"\r\nEX_TABLE(1b,6b) EX_TABLE(2b,0b) EX_TABLE(4b,0b)\r\n: "+a" (size), "+a" (to), "=a" (tmp1), "=a" (tmp2)\r\n: : "cc", "memory");\r\nreturn size;\r\n}\r\nsize_t strnlen_user_std(size_t size, const char __user *src)\r\n{\r\nregister unsigned long reg0 asm("0") = 0UL;\r\nunsigned long tmp1, tmp2;\r\nif (unlikely(!size))\r\nreturn 0;\r\nasm volatile(\r\n" la %2,0(%1)\n"\r\n" la %3,0(%0,%1)\n"\r\n" "SLR" %0,%0\n"\r\n" sacf 256\n"\r\n"0: srst %3,%2\n"\r\n" jo 0b\n"\r\n" la %0,1(%3)\n"\r\n" "SLR" %0,%1\n"\r\n"1: sacf 0\n"\r\nEX_TABLE(0b,1b)\r\n: "+a" (size), "+a" (src), "=a" (tmp1), "=a" (tmp2)\r\n: "d" (reg0) : "cc", "memory");\r\nreturn size;\r\n}\r\nsize_t strncpy_from_user_std(size_t count, const char __user *src, char *dst)\r\n{\r\nsize_t done, len, offset, len_str;\r\nif (unlikely(!count))\r\nreturn 0;\r\ndone = 0;\r\ndo {\r\noffset = (size_t)src & ~PAGE_MASK;\r\nlen = min(count - done, PAGE_SIZE - offset);\r\nif (copy_from_user_std(len, src, dst))\r\nreturn -EFAULT;\r\nlen_str = strnlen(dst, len);\r\ndone += len_str;\r\nsrc += len_str;\r\ndst += len_str;\r\n} while ((len_str == len) && (done < count));\r\nreturn done;\r\n}\r\nint futex_atomic_op_std(int op, u32 __user *uaddr, int oparg, int *old)\r\n{\r\nint oldval = 0, newval, ret;\r\nswitch (op) {\r\ncase FUTEX_OP_SET:\r\n__futex_atomic_op("lr %2,%5\n",\r\nret, oldval, newval, uaddr, oparg);\r\nbreak;\r\ncase FUTEX_OP_ADD:\r\n__futex_atomic_op("lr %2,%1\nar %2,%5\n",\r\nret, oldval, newval, uaddr, oparg);\r\nbreak;\r\ncase FUTEX_OP_OR:\r\n__futex_atomic_op("lr %2,%1\nor %2,%5\n",\r\nret, oldval, newval, uaddr, oparg);\r\nbreak;\r\ncase FUTEX_OP_ANDN:\r\n__futex_atomic_op("lr %2,%1\nnr %2,%5\n",\r\nret, oldval, newval, uaddr, oparg);\r\nbreak;\r\ncase FUTEX_OP_XOR:\r\n__futex_atomic_op("lr %2,%1\nxr %2,%5\n",\r\nret, oldval, newval, uaddr, oparg);\r\nbreak;\r\ndefault:\r\nret = -ENOSYS;\r\n}\r\n*old = oldval;\r\nreturn ret;\r\n}\r\nint futex_atomic_cmpxchg_std(u32 *uval, u32 __user *uaddr,\r\nu32 oldval, u32 newval)\r\n{\r\nint ret;\r\nasm volatile(\r\n" sacf 256\n"\r\n"0: cs %1,%4,0(%5)\n"\r\n"1: la %0,0\n"\r\n"2: sacf 0\n"\r\nEX_TABLE(0b,2b) EX_TABLE(1b,2b)\r\n: "=d" (ret), "+d" (oldval), "=m" (*uaddr)\r\n: "0" (-EFAULT), "d" (newval), "a" (uaddr), "m" (*uaddr)\r\n: "cc", "memory" );\r\n*uval = oldval;\r\nreturn ret;\r\n}

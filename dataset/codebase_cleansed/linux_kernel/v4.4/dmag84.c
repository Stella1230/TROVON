static int\r\ng84_fifo_dma_new(struct nvkm_fifo *base, const struct nvkm_oclass *oclass,\r\nvoid *data, u32 size, struct nvkm_object **pobject)\r\n{\r\nstruct nvkm_object *parent = oclass->parent;\r\nunion {\r\nstruct nv50_channel_dma_v0 v0;\r\n} *args = data;\r\nstruct nv50_fifo *fifo = nv50_fifo(base);\r\nstruct nv50_fifo_chan *chan;\r\nint ret;\r\nnvif_ioctl(parent, "create channel dma size %d\n", size);\r\nif (nvif_unpack(args->v0, 0, 0, false)) {\r\nnvif_ioctl(parent, "create channel dma vers %d vm %llx "\r\n"pushbuf %llx offset %016llx\n",\r\nargs->v0.version, args->v0.vm, args->v0.pushbuf,\r\nargs->v0.offset);\r\nif (!args->v0.pushbuf)\r\nreturn -EINVAL;\r\n} else\r\nreturn ret;\r\nif (!(chan = kzalloc(sizeof(*chan), GFP_KERNEL)))\r\nreturn -ENOMEM;\r\n*pobject = &chan->base.object;\r\nret = g84_fifo_chan_ctor(fifo, args->v0.vm, args->v0.pushbuf,\r\noclass, chan);\r\nif (ret)\r\nreturn ret;\r\nargs->v0.chid = chan->base.chid;\r\nnvkm_kmap(chan->ramfc);\r\nnvkm_wo32(chan->ramfc, 0x08, lower_32_bits(args->v0.offset));\r\nnvkm_wo32(chan->ramfc, 0x0c, upper_32_bits(args->v0.offset));\r\nnvkm_wo32(chan->ramfc, 0x10, lower_32_bits(args->v0.offset));\r\nnvkm_wo32(chan->ramfc, 0x14, upper_32_bits(args->v0.offset));\r\nnvkm_wo32(chan->ramfc, 0x3c, 0x003f6078);\r\nnvkm_wo32(chan->ramfc, 0x44, 0x01003fff);\r\nnvkm_wo32(chan->ramfc, 0x48, chan->base.push->node->offset >> 4);\r\nnvkm_wo32(chan->ramfc, 0x4c, 0xffffffff);\r\nnvkm_wo32(chan->ramfc, 0x60, 0x7fffffff);\r\nnvkm_wo32(chan->ramfc, 0x78, 0x00000000);\r\nnvkm_wo32(chan->ramfc, 0x7c, 0x30000001);\r\nnvkm_wo32(chan->ramfc, 0x80, ((chan->ramht->bits - 9) << 27) |\r\n(4 << 24) |\r\n(chan->ramht->gpuobj->node->offset >> 4));\r\nnvkm_wo32(chan->ramfc, 0x88, chan->cache->addr >> 10);\r\nnvkm_wo32(chan->ramfc, 0x98, chan->base.inst->addr >> 12);\r\nnvkm_done(chan->ramfc);\r\nreturn 0;\r\n}

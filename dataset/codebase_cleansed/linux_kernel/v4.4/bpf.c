static __u64 ptr_to_u64(void *ptr)\r\n{\r\nreturn (__u64) (unsigned long) ptr;\r\n}\r\nstatic int sys_bpf(enum bpf_cmd cmd, union bpf_attr *attr,\r\nunsigned int size)\r\n{\r\nreturn syscall(__NR_bpf, cmd, attr, size);\r\n}\r\nint bpf_create_map(enum bpf_map_type map_type, int key_size,\r\nint value_size, int max_entries)\r\n{\r\nunion bpf_attr attr;\r\nmemset(&attr, '\0', sizeof(attr));\r\nattr.map_type = map_type;\r\nattr.key_size = key_size;\r\nattr.value_size = value_size;\r\nattr.max_entries = max_entries;\r\nreturn sys_bpf(BPF_MAP_CREATE, &attr, sizeof(attr));\r\n}\r\nint bpf_load_program(enum bpf_prog_type type, struct bpf_insn *insns,\r\nsize_t insns_cnt, char *license,\r\nu32 kern_version, char *log_buf, size_t log_buf_sz)\r\n{\r\nint fd;\r\nunion bpf_attr attr;\r\nbzero(&attr, sizeof(attr));\r\nattr.prog_type = type;\r\nattr.insn_cnt = (__u32)insns_cnt;\r\nattr.insns = ptr_to_u64(insns);\r\nattr.license = ptr_to_u64(license);\r\nattr.log_buf = ptr_to_u64(NULL);\r\nattr.log_size = 0;\r\nattr.log_level = 0;\r\nattr.kern_version = kern_version;\r\nfd = sys_bpf(BPF_PROG_LOAD, &attr, sizeof(attr));\r\nif (fd >= 0 || !log_buf || !log_buf_sz)\r\nreturn fd;\r\nattr.log_buf = ptr_to_u64(log_buf);\r\nattr.log_size = log_buf_sz;\r\nattr.log_level = 1;\r\nlog_buf[0] = 0;\r\nreturn sys_bpf(BPF_PROG_LOAD, &attr, sizeof(attr));\r\n}

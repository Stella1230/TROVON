static int gt64xxx_pci0_pcibios_config_access(unsigned char access_type,\r\nstruct pci_bus *bus, unsigned int devfn, int where, u32 * data)\r\n{\r\nunsigned char busnum = bus->number;\r\nu32 intr;\r\nif ((busnum == 0) && (devfn >= PCI_DEVFN(31, 0)))\r\nreturn -1;\r\nGT_WRITE(GT_INTRCAUSE_OFS, ~(GT_INTRCAUSE_MASABORT0_BIT |\r\nGT_INTRCAUSE_TARABORT0_BIT));\r\nGT_WRITE(GT_PCI0_CFGADDR_OFS,\r\n(busnum << GT_PCI0_CFGADDR_BUSNUM_SHF) |\r\n(devfn << GT_PCI0_CFGADDR_FUNCTNUM_SHF) |\r\n((where / 4) << GT_PCI0_CFGADDR_REGNUM_SHF) |\r\nGT_PCI0_CFGADDR_CONFIGEN_BIT);\r\nif (access_type == PCI_ACCESS_WRITE) {\r\nif (busnum == 0 && PCI_SLOT(devfn) == 0) {\r\nGT_WRITE(GT_PCI0_CFGDATA_OFS, *data);\r\n} else\r\n__GT_WRITE(GT_PCI0_CFGDATA_OFS, *data);\r\n} else {\r\nif (busnum == 0 && PCI_SLOT(devfn) == 0) {\r\n*data = GT_READ(GT_PCI0_CFGDATA_OFS);\r\n} else\r\n*data = __GT_READ(GT_PCI0_CFGDATA_OFS);\r\n}\r\nintr = GT_READ(GT_INTRCAUSE_OFS);\r\nif (intr & (GT_INTRCAUSE_MASABORT0_BIT | GT_INTRCAUSE_TARABORT0_BIT)) {\r\nGT_WRITE(GT_INTRCAUSE_OFS, ~(GT_INTRCAUSE_MASABORT0_BIT |\r\nGT_INTRCAUSE_TARABORT0_BIT));\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int gt64xxx_pci0_pcibios_read(struct pci_bus *bus, unsigned int devfn,\r\nint where, int size, u32 * val)\r\n{\r\nu32 data = 0;\r\nif (gt64xxx_pci0_pcibios_config_access(PCI_ACCESS_READ, bus, devfn,\r\nwhere, &data))\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nif (size == 1)\r\n*val = (data >> ((where & 3) << 3)) & 0xff;\r\nelse if (size == 2)\r\n*val = (data >> ((where & 3) << 3)) & 0xffff;\r\nelse\r\n*val = data;\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int gt64xxx_pci0_pcibios_write(struct pci_bus *bus, unsigned int devfn,\r\nint where, int size, u32 val)\r\n{\r\nu32 data = 0;\r\nif (size == 4)\r\ndata = val;\r\nelse {\r\nif (gt64xxx_pci0_pcibios_config_access(PCI_ACCESS_READ, bus,\r\ndevfn, where, &data))\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nif (size == 1)\r\ndata = (data & ~(0xff << ((where & 3) << 3))) |\r\n(val << ((where & 3) << 3));\r\nelse if (size == 2)\r\ndata = (data & ~(0xffff << ((where & 3) << 3))) |\r\n(val << ((where & 3) << 3));\r\n}\r\nif (gt64xxx_pci0_pcibios_config_access(PCI_ACCESS_WRITE, bus, devfn,\r\nwhere, &data))\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}

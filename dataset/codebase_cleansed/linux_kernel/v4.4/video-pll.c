static void dss_dpll_enable_scp_clk(struct dss_video_pll *vpll)\r\n{\r\nREG_MOD(vpll->clkctrl_base, 1, 14, 14);\r\n}\r\nstatic void dss_dpll_disable_scp_clk(struct dss_video_pll *vpll)\r\n{\r\nREG_MOD(vpll->clkctrl_base, 0, 14, 14);\r\n}\r\nstatic void dss_dpll_power_enable(struct dss_video_pll *vpll)\r\n{\r\nREG_MOD(vpll->clkctrl_base, 2, 31, 30);\r\nmsleep(1);\r\n}\r\nstatic void dss_dpll_power_disable(struct dss_video_pll *vpll)\r\n{\r\nREG_MOD(vpll->clkctrl_base, 0, 31, 30);\r\n}\r\nstatic int dss_video_pll_enable(struct dss_pll *pll)\r\n{\r\nstruct dss_video_pll *vpll = container_of(pll, struct dss_video_pll, pll);\r\nint r;\r\nr = dss_runtime_get();\r\nif (r)\r\nreturn r;\r\ndss_ctrl_pll_enable(pll->id, true);\r\ndss_dpll_enable_scp_clk(vpll);\r\nr = dss_pll_wait_reset_done(pll);\r\nif (r)\r\ngoto err_reset;\r\ndss_dpll_power_enable(vpll);\r\nreturn 0;\r\nerr_reset:\r\ndss_dpll_disable_scp_clk(vpll);\r\ndss_ctrl_pll_enable(pll->id, false);\r\ndss_runtime_put();\r\nreturn r;\r\n}\r\nstatic void dss_video_pll_disable(struct dss_pll *pll)\r\n{\r\nstruct dss_video_pll *vpll = container_of(pll, struct dss_video_pll, pll);\r\ndss_dpll_power_disable(vpll);\r\ndss_dpll_disable_scp_clk(vpll);\r\ndss_ctrl_pll_enable(pll->id, false);\r\ndss_runtime_put();\r\n}\r\nstruct dss_pll *dss_video_pll_init(struct platform_device *pdev, int id,\r\nstruct regulator *regulator)\r\n{\r\nconst char * const reg_name[] = { "pll1", "pll2" };\r\nconst char * const clkctrl_name[] = { "pll1_clkctrl", "pll2_clkctrl" };\r\nconst char * const clkin_name[] = { "video1_clk", "video2_clk" };\r\nstruct resource *res;\r\nstruct dss_video_pll *vpll;\r\nvoid __iomem *pll_base, *clkctrl_base;\r\nstruct clk *clk;\r\nstruct dss_pll *pll;\r\nint r;\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM, reg_name[id]);\r\nif (!res) {\r\ndev_err(&pdev->dev,\r\n"missing platform resource data for pll%d\n", id);\r\nreturn ERR_PTR(-ENODEV);\r\n}\r\npll_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(pll_base)) {\r\ndev_err(&pdev->dev, "failed to ioremap pll%d reg_name\n", id);\r\nreturn ERR_CAST(pll_base);\r\n}\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM,\r\nclkctrl_name[id]);\r\nif (!res) {\r\ndev_err(&pdev->dev,\r\n"missing platform resource data for pll%d\n", id);\r\nreturn ERR_PTR(-ENODEV);\r\n}\r\nclkctrl_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(clkctrl_base)) {\r\ndev_err(&pdev->dev, "failed to ioremap pll%d clkctrl\n", id);\r\nreturn ERR_CAST(clkctrl_base);\r\n}\r\nclk = devm_clk_get(&pdev->dev, clkin_name[id]);\r\nif (IS_ERR(clk)) {\r\nDSSERR("can't get video pll clkin\n");\r\nreturn ERR_CAST(clk);\r\n}\r\nvpll = devm_kzalloc(&pdev->dev, sizeof(*vpll), GFP_KERNEL);\r\nif (!vpll)\r\nreturn ERR_PTR(-ENOMEM);\r\nvpll->dev = &pdev->dev;\r\nvpll->clkctrl_base = clkctrl_base;\r\npll = &vpll->pll;\r\npll->name = id == 0 ? "video0" : "video1";\r\npll->id = id == 0 ? DSS_PLL_VIDEO1 : DSS_PLL_VIDEO2;\r\npll->clkin = clk;\r\npll->regulator = regulator;\r\npll->base = pll_base;\r\npll->hw = &dss_dra7_video_pll_hw;\r\npll->ops = &dss_pll_ops;\r\nr = dss_pll_register(pll);\r\nif (r)\r\nreturn ERR_PTR(r);\r\nreturn pll;\r\n}\r\nvoid dss_video_pll_uninit(struct dss_pll *pll)\r\n{\r\ndss_pll_unregister(pll);\r\n}

static int\r\nsmb2_open_op_close(const unsigned int xid, struct cifs_tcon *tcon,\r\nstruct cifs_sb_info *cifs_sb, const char *full_path,\r\n__u32 desired_access, __u32 create_disposition,\r\n__u32 create_options, void *data, int command)\r\n{\r\nint rc, tmprc = 0;\r\n__le16 *utf16_path;\r\n__u8 oplock = SMB2_OPLOCK_LEVEL_NONE;\r\nstruct cifs_open_parms oparms;\r\nstruct cifs_fid fid;\r\nutf16_path = cifs_convert_path_to_utf16(full_path, cifs_sb);\r\nif (!utf16_path)\r\nreturn -ENOMEM;\r\noparms.tcon = tcon;\r\noparms.desired_access = desired_access;\r\noparms.disposition = create_disposition;\r\noparms.create_options = create_options;\r\noparms.fid = &fid;\r\noparms.reconnect = false;\r\nrc = SMB2_open(xid, &oparms, utf16_path, &oplock, NULL, NULL);\r\nif (rc) {\r\nkfree(utf16_path);\r\nreturn rc;\r\n}\r\nswitch (command) {\r\ncase SMB2_OP_DELETE:\r\nbreak;\r\ncase SMB2_OP_QUERY_INFO:\r\ntmprc = SMB2_query_info(xid, tcon, fid.persistent_fid,\r\nfid.volatile_fid,\r\n(struct smb2_file_all_info *)data);\r\nbreak;\r\ncase SMB2_OP_MKDIR:\r\nbreak;\r\ncase SMB2_OP_RENAME:\r\ntmprc = SMB2_rename(xid, tcon, fid.persistent_fid,\r\nfid.volatile_fid, (__le16 *)data);\r\nbreak;\r\ncase SMB2_OP_HARDLINK:\r\ntmprc = SMB2_set_hardlink(xid, tcon, fid.persistent_fid,\r\nfid.volatile_fid, (__le16 *)data);\r\nbreak;\r\ncase SMB2_OP_SET_EOF:\r\ntmprc = SMB2_set_eof(xid, tcon, fid.persistent_fid,\r\nfid.volatile_fid, current->tgid,\r\n(__le64 *)data, false);\r\nbreak;\r\ncase SMB2_OP_SET_INFO:\r\ntmprc = SMB2_set_info(xid, tcon, fid.persistent_fid,\r\nfid.volatile_fid,\r\n(FILE_BASIC_INFO *)data);\r\nbreak;\r\ndefault:\r\ncifs_dbg(VFS, "Invalid command\n");\r\nbreak;\r\n}\r\nrc = SMB2_close(xid, tcon, fid.persistent_fid, fid.volatile_fid);\r\nif (tmprc)\r\nrc = tmprc;\r\nkfree(utf16_path);\r\nreturn rc;\r\n}\r\nvoid\r\nmove_smb2_info_to_cifs(FILE_ALL_INFO *dst, struct smb2_file_all_info *src)\r\n{\r\nmemcpy(dst, src, (size_t)(&src->CurrentByteOffset) - (size_t)src);\r\ndst->CurrentByteOffset = src->CurrentByteOffset;\r\ndst->Mode = src->Mode;\r\ndst->AlignmentRequirement = src->AlignmentRequirement;\r\ndst->IndexNumber1 = 0;\r\n}\r\nint\r\nsmb2_query_path_info(const unsigned int xid, struct cifs_tcon *tcon,\r\nstruct cifs_sb_info *cifs_sb, const char *full_path,\r\nFILE_ALL_INFO *data, bool *adjust_tz, bool *symlink)\r\n{\r\nint rc;\r\nstruct smb2_file_all_info *smb2_data;\r\n*adjust_tz = false;\r\n*symlink = false;\r\nsmb2_data = kzalloc(sizeof(struct smb2_file_all_info) + PATH_MAX * 2,\r\nGFP_KERNEL);\r\nif (smb2_data == NULL)\r\nreturn -ENOMEM;\r\nrc = smb2_open_op_close(xid, tcon, cifs_sb, full_path,\r\nFILE_READ_ATTRIBUTES, FILE_OPEN, 0,\r\nsmb2_data, SMB2_OP_QUERY_INFO);\r\nif (rc == -EOPNOTSUPP) {\r\n*symlink = true;\r\nrc = smb2_open_op_close(xid, tcon, cifs_sb, full_path,\r\nFILE_READ_ATTRIBUTES, FILE_OPEN,\r\nOPEN_REPARSE_POINT, smb2_data,\r\nSMB2_OP_QUERY_INFO);\r\n}\r\nif (rc)\r\ngoto out;\r\nmove_smb2_info_to_cifs(data, smb2_data);\r\nout:\r\nkfree(smb2_data);\r\nreturn rc;\r\n}\r\nint\r\nsmb2_mkdir(const unsigned int xid, struct cifs_tcon *tcon, const char *name,\r\nstruct cifs_sb_info *cifs_sb)\r\n{\r\nreturn smb2_open_op_close(xid, tcon, cifs_sb, name,\r\nFILE_WRITE_ATTRIBUTES, FILE_CREATE,\r\nCREATE_NOT_FILE, NULL, SMB2_OP_MKDIR);\r\n}\r\nvoid\r\nsmb2_mkdir_setinfo(struct inode *inode, const char *name,\r\nstruct cifs_sb_info *cifs_sb, struct cifs_tcon *tcon,\r\nconst unsigned int xid)\r\n{\r\nFILE_BASIC_INFO data;\r\nstruct cifsInodeInfo *cifs_i;\r\nu32 dosattrs;\r\nint tmprc;\r\nmemset(&data, 0, sizeof(data));\r\ncifs_i = CIFS_I(inode);\r\ndosattrs = cifs_i->cifsAttrs | ATTR_READONLY;\r\ndata.Attributes = cpu_to_le32(dosattrs);\r\ntmprc = smb2_open_op_close(xid, tcon, cifs_sb, name,\r\nFILE_WRITE_ATTRIBUTES, FILE_CREATE,\r\nCREATE_NOT_FILE, &data, SMB2_OP_SET_INFO);\r\nif (tmprc == 0)\r\ncifs_i->cifsAttrs = dosattrs;\r\n}\r\nint\r\nsmb2_rmdir(const unsigned int xid, struct cifs_tcon *tcon, const char *name,\r\nstruct cifs_sb_info *cifs_sb)\r\n{\r\nreturn smb2_open_op_close(xid, tcon, cifs_sb, name, DELETE, FILE_OPEN,\r\nCREATE_NOT_FILE | CREATE_DELETE_ON_CLOSE,\r\nNULL, SMB2_OP_DELETE);\r\n}\r\nint\r\nsmb2_unlink(const unsigned int xid, struct cifs_tcon *tcon, const char *name,\r\nstruct cifs_sb_info *cifs_sb)\r\n{\r\nreturn smb2_open_op_close(xid, tcon, cifs_sb, name, DELETE, FILE_OPEN,\r\nCREATE_DELETE_ON_CLOSE | OPEN_REPARSE_POINT,\r\nNULL, SMB2_OP_DELETE);\r\n}\r\nstatic int\r\nsmb2_set_path_attr(const unsigned int xid, struct cifs_tcon *tcon,\r\nconst char *from_name, const char *to_name,\r\nstruct cifs_sb_info *cifs_sb, __u32 access, int command)\r\n{\r\n__le16 *smb2_to_name = NULL;\r\nint rc;\r\nsmb2_to_name = cifs_convert_path_to_utf16(to_name, cifs_sb);\r\nif (smb2_to_name == NULL) {\r\nrc = -ENOMEM;\r\ngoto smb2_rename_path;\r\n}\r\nrc = smb2_open_op_close(xid, tcon, cifs_sb, from_name, access,\r\nFILE_OPEN, 0, smb2_to_name, command);\r\nsmb2_rename_path:\r\nkfree(smb2_to_name);\r\nreturn rc;\r\n}\r\nint\r\nsmb2_rename_path(const unsigned int xid, struct cifs_tcon *tcon,\r\nconst char *from_name, const char *to_name,\r\nstruct cifs_sb_info *cifs_sb)\r\n{\r\nreturn smb2_set_path_attr(xid, tcon, from_name, to_name, cifs_sb,\r\nDELETE, SMB2_OP_RENAME);\r\n}\r\nint\r\nsmb2_create_hardlink(const unsigned int xid, struct cifs_tcon *tcon,\r\nconst char *from_name, const char *to_name,\r\nstruct cifs_sb_info *cifs_sb)\r\n{\r\nreturn smb2_set_path_attr(xid, tcon, from_name, to_name, cifs_sb,\r\nFILE_READ_ATTRIBUTES, SMB2_OP_HARDLINK);\r\n}\r\nint\r\nsmb2_set_path_size(const unsigned int xid, struct cifs_tcon *tcon,\r\nconst char *full_path, __u64 size,\r\nstruct cifs_sb_info *cifs_sb, bool set_alloc)\r\n{\r\n__le64 eof = cpu_to_le64(size);\r\nreturn smb2_open_op_close(xid, tcon, cifs_sb, full_path,\r\nFILE_WRITE_DATA, FILE_OPEN, 0, &eof,\r\nSMB2_OP_SET_EOF);\r\n}\r\nint\r\nsmb2_set_file_info(struct inode *inode, const char *full_path,\r\nFILE_BASIC_INFO *buf, const unsigned int xid)\r\n{\r\nstruct cifs_sb_info *cifs_sb = CIFS_SB(inode->i_sb);\r\nstruct tcon_link *tlink;\r\nint rc;\r\ntlink = cifs_sb_tlink(cifs_sb);\r\nif (IS_ERR(tlink))\r\nreturn PTR_ERR(tlink);\r\nrc = smb2_open_op_close(xid, tlink_tcon(tlink), cifs_sb, full_path,\r\nFILE_WRITE_ATTRIBUTES, FILE_OPEN, 0, buf,\r\nSMB2_OP_SET_INFO);\r\ncifs_put_tlink(tlink);\r\nreturn rc;\r\n}

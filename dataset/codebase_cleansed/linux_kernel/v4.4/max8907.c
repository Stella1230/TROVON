static bool max8907_gen_is_volatile_reg(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase MAX8907_REG_ON_OFF_IRQ1:\r\ncase MAX8907_REG_ON_OFF_STAT:\r\ncase MAX8907_REG_ON_OFF_IRQ2:\r\ncase MAX8907_REG_CHG_IRQ1:\r\ncase MAX8907_REG_CHG_IRQ2:\r\ncase MAX8907_REG_CHG_STAT:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic bool max8907_gen_is_precious_reg(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase MAX8907_REG_ON_OFF_IRQ1:\r\ncase MAX8907_REG_ON_OFF_IRQ2:\r\ncase MAX8907_REG_CHG_IRQ1:\r\ncase MAX8907_REG_CHG_IRQ2:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic bool max8907_gen_is_writeable_reg(struct device *dev, unsigned int reg)\r\n{\r\nreturn !max8907_gen_is_volatile_reg(dev, reg);\r\n}\r\nstatic bool max8907_rtc_is_volatile_reg(struct device *dev, unsigned int reg)\r\n{\r\nif (reg <= MAX8907_REG_RTC_YEAR2)\r\nreturn true;\r\nswitch (reg) {\r\ncase MAX8907_REG_RTC_STATUS:\r\ncase MAX8907_REG_RTC_IRQ:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic bool max8907_rtc_is_precious_reg(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase MAX8907_REG_RTC_IRQ:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic bool max8907_rtc_is_writeable_reg(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase MAX8907_REG_RTC_STATUS:\r\ncase MAX8907_REG_RTC_IRQ:\r\nreturn false;\r\ndefault:\r\nreturn true;\r\n}\r\n}\r\nstatic void max8907_power_off(void)\r\n{\r\nregmap_update_bits(max8907_pm_off->regmap_gen, MAX8907_REG_RESET_CNFG,\r\nMAX8907_MASK_POWER_OFF, MAX8907_MASK_POWER_OFF);\r\n}\r\nstatic int max8907_i2c_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct max8907 *max8907;\r\nint ret;\r\nstruct max8907_platform_data *pdata = dev_get_platdata(&i2c->dev);\r\nbool pm_off = false;\r\nif (pdata)\r\npm_off = pdata->pm_off;\r\nelse if (i2c->dev.of_node)\r\npm_off = of_property_read_bool(i2c->dev.of_node,\r\n"maxim,system-power-controller");\r\nmax8907 = devm_kzalloc(&i2c->dev, sizeof(struct max8907), GFP_KERNEL);\r\nif (!max8907) {\r\nret = -ENOMEM;\r\ngoto err_alloc_drvdata;\r\n}\r\nmax8907->dev = &i2c->dev;\r\ndev_set_drvdata(max8907->dev, max8907);\r\nmax8907->i2c_gen = i2c;\r\ni2c_set_clientdata(i2c, max8907);\r\nmax8907->regmap_gen = devm_regmap_init_i2c(i2c,\r\n&max8907_regmap_gen_config);\r\nif (IS_ERR(max8907->regmap_gen)) {\r\nret = PTR_ERR(max8907->regmap_gen);\r\ndev_err(&i2c->dev, "gen regmap init failed: %d\n", ret);\r\ngoto err_regmap_gen;\r\n}\r\nmax8907->i2c_rtc = i2c_new_dummy(i2c->adapter, MAX8907_RTC_I2C_ADDR);\r\nif (!max8907->i2c_rtc) {\r\nret = -ENOMEM;\r\ngoto err_dummy_rtc;\r\n}\r\ni2c_set_clientdata(max8907->i2c_rtc, max8907);\r\nmax8907->regmap_rtc = devm_regmap_init_i2c(max8907->i2c_rtc,\r\n&max8907_regmap_rtc_config);\r\nif (IS_ERR(max8907->regmap_rtc)) {\r\nret = PTR_ERR(max8907->regmap_rtc);\r\ndev_err(&i2c->dev, "rtc regmap init failed: %d\n", ret);\r\ngoto err_regmap_rtc;\r\n}\r\nirq_set_status_flags(max8907->i2c_gen->irq, IRQ_NOAUTOEN);\r\nret = regmap_add_irq_chip(max8907->regmap_gen, max8907->i2c_gen->irq,\r\nIRQF_ONESHOT | IRQF_SHARED, -1,\r\n&max8907_chg_irq_chip,\r\n&max8907->irqc_chg);\r\nif (ret != 0) {\r\ndev_err(&i2c->dev, "failed to add chg irq chip: %d\n", ret);\r\ngoto err_irqc_chg;\r\n}\r\nret = regmap_add_irq_chip(max8907->regmap_gen, max8907->i2c_gen->irq,\r\nIRQF_ONESHOT | IRQF_SHARED, -1,\r\n&max8907_on_off_irq_chip,\r\n&max8907->irqc_on_off);\r\nif (ret != 0) {\r\ndev_err(&i2c->dev, "failed to add on off irq chip: %d\n", ret);\r\ngoto err_irqc_on_off;\r\n}\r\nret = regmap_add_irq_chip(max8907->regmap_rtc, max8907->i2c_gen->irq,\r\nIRQF_ONESHOT | IRQF_SHARED, -1,\r\n&max8907_rtc_irq_chip,\r\n&max8907->irqc_rtc);\r\nif (ret != 0) {\r\ndev_err(&i2c->dev, "failed to add rtc irq chip: %d\n", ret);\r\ngoto err_irqc_rtc;\r\n}\r\nenable_irq(max8907->i2c_gen->irq);\r\nret = mfd_add_devices(max8907->dev, -1, max8907_cells,\r\nARRAY_SIZE(max8907_cells), NULL, 0, NULL);\r\nif (ret != 0) {\r\ndev_err(&i2c->dev, "failed to add MFD devices %d\n", ret);\r\ngoto err_add_devices;\r\n}\r\nif (pm_off && !pm_power_off) {\r\nmax8907_pm_off = max8907;\r\npm_power_off = max8907_power_off;\r\n}\r\nreturn 0;\r\nerr_add_devices:\r\nregmap_del_irq_chip(max8907->i2c_gen->irq, max8907->irqc_rtc);\r\nerr_irqc_rtc:\r\nregmap_del_irq_chip(max8907->i2c_gen->irq, max8907->irqc_on_off);\r\nerr_irqc_on_off:\r\nregmap_del_irq_chip(max8907->i2c_gen->irq, max8907->irqc_chg);\r\nerr_irqc_chg:\r\nerr_regmap_rtc:\r\ni2c_unregister_device(max8907->i2c_rtc);\r\nerr_dummy_rtc:\r\nerr_regmap_gen:\r\nerr_alloc_drvdata:\r\nreturn ret;\r\n}\r\nstatic int max8907_i2c_remove(struct i2c_client *i2c)\r\n{\r\nstruct max8907 *max8907 = i2c_get_clientdata(i2c);\r\nmfd_remove_devices(max8907->dev);\r\nregmap_del_irq_chip(max8907->i2c_gen->irq, max8907->irqc_rtc);\r\nregmap_del_irq_chip(max8907->i2c_gen->irq, max8907->irqc_on_off);\r\nregmap_del_irq_chip(max8907->i2c_gen->irq, max8907->irqc_chg);\r\ni2c_unregister_device(max8907->i2c_rtc);\r\nreturn 0;\r\n}\r\nstatic int __init max8907_i2c_init(void)\r\n{\r\nint ret = -ENODEV;\r\nret = i2c_add_driver(&max8907_i2c_driver);\r\nif (ret != 0)\r\npr_err("Failed to register I2C driver: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic void __exit max8907_i2c_exit(void)\r\n{\r\ni2c_del_driver(&max8907_i2c_driver);\r\n}

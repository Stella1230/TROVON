acpi_status\r\nacpi_ds_get_predicate_value(struct acpi_walk_state *walk_state,\r\nunion acpi_operand_object *result_obj)\r\n{\r\nacpi_status status = AE_OK;\r\nunion acpi_operand_object *obj_desc;\r\nunion acpi_operand_object *local_obj_desc = NULL;\r\nACPI_FUNCTION_TRACE_PTR(ds_get_predicate_value, walk_state);\r\nwalk_state->control_state->common.state = 0;\r\nif (result_obj) {\r\nstatus = acpi_ds_result_pop(&obj_desc, walk_state);\r\nif (ACPI_FAILURE(status)) {\r\nACPI_EXCEPTION((AE_INFO, status,\r\n"Could not get result from predicate evaluation"));\r\nreturn_ACPI_STATUS(status);\r\n}\r\n} else {\r\nstatus = acpi_ds_create_operand(walk_state, walk_state->op, 0);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nstatus =\r\nacpi_ex_resolve_to_value(&walk_state->operands[0],\r\nwalk_state);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nobj_desc = walk_state->operands[0];\r\n}\r\nif (!obj_desc) {\r\nACPI_ERROR((AE_INFO,\r\n"No predicate ObjDesc=%p State=%p",\r\nobj_desc, walk_state));\r\nreturn_ACPI_STATUS(AE_AML_NO_OPERAND);\r\n}\r\nstatus = acpi_ex_convert_to_integer(obj_desc, &local_obj_desc, 16);\r\nif (ACPI_FAILURE(status)) {\r\ngoto cleanup;\r\n}\r\nif (local_obj_desc->common.type != ACPI_TYPE_INTEGER) {\r\nACPI_ERROR((AE_INFO,\r\n"Bad predicate (not an integer) ObjDesc=%p State=%p Type=0x%X",\r\nobj_desc, walk_state, obj_desc->common.type));\r\nstatus = AE_AML_OPERAND_TYPE;\r\ngoto cleanup;\r\n}\r\n(void)acpi_ex_truncate_for32bit_table(local_obj_desc);\r\nif (local_obj_desc->integer.value) {\r\nwalk_state->control_state->common.value = TRUE;\r\n} else {\r\nwalk_state->control_state->common.value = FALSE;\r\nstatus = AE_CTRL_FALSE;\r\n}\r\n(void)acpi_ds_do_implicit_return(local_obj_desc, walk_state, TRUE);\r\ncleanup:\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC, "Completed a predicate eval=%X Op=%p\n",\r\nwalk_state->control_state->common.value,\r\nwalk_state->op));\r\nACPI_DEBUGGER_EXEC(acpi_db_display_result_object\r\n(local_obj_desc, walk_state));\r\nif (local_obj_desc != obj_desc) {\r\nacpi_ut_remove_reference(local_obj_desc);\r\n}\r\nacpi_ut_remove_reference(obj_desc);\r\nwalk_state->control_state->common.state = ACPI_CONTROL_NORMAL;\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status\r\nacpi_ds_exec_begin_op(struct acpi_walk_state *walk_state,\r\nunion acpi_parse_object **out_op)\r\n{\r\nunion acpi_parse_object *op;\r\nacpi_status status = AE_OK;\r\nu32 opcode_class;\r\nACPI_FUNCTION_TRACE_PTR(ds_exec_begin_op, walk_state);\r\nop = walk_state->op;\r\nif (!op) {\r\nstatus = acpi_ds_load2_begin_op(walk_state, out_op);\r\nif (ACPI_FAILURE(status)) {\r\ngoto error_exit;\r\n}\r\nop = *out_op;\r\nwalk_state->op = op;\r\nwalk_state->opcode = op->common.aml_opcode;\r\nwalk_state->op_info =\r\nacpi_ps_get_opcode_info(op->common.aml_opcode);\r\nif (acpi_ns_opens_scope(walk_state->op_info->object_type)) {\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"(%s) Popping scope for Op %p\n",\r\nacpi_ut_get_type_name(walk_state->\r\nop_info->\r\nobject_type),\r\nop));\r\nstatus = acpi_ds_scope_stack_pop(walk_state);\r\nif (ACPI_FAILURE(status)) {\r\ngoto error_exit;\r\n}\r\n}\r\n}\r\nif (op == walk_state->origin) {\r\nif (out_op) {\r\n*out_op = op;\r\n}\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nif ((walk_state->control_state) &&\r\n(walk_state->control_state->common.state ==\r\nACPI_CONTROL_CONDITIONAL_EXECUTING)) {\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC,\r\n"Exec predicate Op=%p State=%p\n", op,\r\nwalk_state));\r\nwalk_state->control_state->common.state =\r\nACPI_CONTROL_PREDICATE_EXECUTING;\r\nwalk_state->control_state->control.predicate_op = op;\r\n}\r\nopcode_class = walk_state->op_info->class;\r\nif (op->common.aml_opcode == AML_INT_NAMEPATH_OP) {\r\nopcode_class = AML_CLASS_NAMED_OBJECT;\r\n}\r\nswitch (opcode_class) {\r\ncase AML_CLASS_CONTROL:\r\nstatus = acpi_ds_exec_begin_control_op(walk_state, op);\r\nbreak;\r\ncase AML_CLASS_NAMED_OBJECT:\r\nif (walk_state->walk_type & ACPI_WALK_METHOD) {\r\nif (op->common.aml_opcode != AML_SCOPE_OP) {\r\nstatus =\r\nacpi_ds_load2_begin_op(walk_state, NULL);\r\n} else {\r\nstatus =\r\nacpi_ds_scope_stack_push(op->named.node,\r\nop->named.node->\r\ntype, walk_state);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\n}\r\n}\r\nbreak;\r\ncase AML_CLASS_EXECUTE:\r\ncase AML_CLASS_CREATE:\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn_ACPI_STATUS(status);\r\nerror_exit:\r\nstatus = acpi_ds_method_error(status, walk_state);\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status acpi_ds_exec_end_op(struct acpi_walk_state *walk_state)\r\n{\r\nunion acpi_parse_object *op;\r\nacpi_status status = AE_OK;\r\nu32 op_type;\r\nu32 op_class;\r\nunion acpi_parse_object *next_op;\r\nunion acpi_parse_object *first_arg;\r\nACPI_FUNCTION_TRACE_PTR(ds_exec_end_op, walk_state);\r\nop = walk_state->op;\r\nop_type = walk_state->op_info->type;\r\nop_class = walk_state->op_info->class;\r\nif (op_class == AML_CLASS_UNKNOWN) {\r\nACPI_ERROR((AE_INFO, "Unknown opcode 0x%X",\r\nop->common.aml_opcode));\r\nreturn_ACPI_STATUS(AE_NOT_IMPLEMENTED);\r\n}\r\nfirst_arg = op->common.value.arg;\r\nwalk_state->num_operands = 0;\r\nwalk_state->operand_index = 0;\r\nwalk_state->return_desc = NULL;\r\nwalk_state->result_obj = NULL;\r\nACPI_DEBUGGER_EXEC(status =\r\nacpi_db_single_step(walk_state, op, op_class));\r\nACPI_DEBUGGER_EXEC(if (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);}\r\n) ;\r\nswitch (op_class) {\r\ncase AML_CLASS_ARGUMENT:\r\nif (walk_state->opcode == AML_INT_NAMEPATH_OP) {\r\nstatus = acpi_ds_evaluate_name_path(walk_state);\r\nif (ACPI_FAILURE(status)) {\r\ngoto cleanup;\r\n}\r\n}\r\nbreak;\r\ncase AML_CLASS_EXECUTE:\r\nstatus = acpi_ds_create_operands(walk_state, first_arg);\r\nif (ACPI_FAILURE(status)) {\r\ngoto cleanup;\r\n}\r\nif (!(walk_state->op_info->flags & AML_NO_OPERAND_RESOLVE)) {\r\nstatus = acpi_ex_resolve_operands(walk_state->opcode,\r\n&(walk_state->\r\noperands\r\n[walk_state->\r\nnum_operands - 1]),\r\nwalk_state);\r\n}\r\nif (ACPI_SUCCESS(status)) {\r\nstatus =\r\nacpi_gbl_op_type_dispatch[op_type] (walk_state);\r\n} else {\r\nif ((status == AE_AML_UNINITIALIZED_LOCAL) &&\r\n(walk_state->opcode == AML_STORE_OP) &&\r\n(walk_state->operands[0]->common.type ==\r\nACPI_TYPE_LOCAL_REFERENCE)\r\n&& (walk_state->operands[1]->common.type ==\r\nACPI_TYPE_LOCAL_REFERENCE)\r\n&& (walk_state->operands[0]->reference.class ==\r\nwalk_state->operands[1]->reference.class)\r\n&& (walk_state->operands[0]->reference.value ==\r\nwalk_state->operands[1]->reference.value)) {\r\nstatus = AE_OK;\r\n} else {\r\nACPI_EXCEPTION((AE_INFO, status,\r\n"While resolving operands for [%s]",\r\nacpi_ps_get_opcode_name\r\n(walk_state->opcode)));\r\n}\r\n}\r\nacpi_ds_clear_operands(walk_state);\r\nif (ACPI_SUCCESS(status) && walk_state->result_obj) {\r\nstatus =\r\nacpi_ds_result_push(walk_state->result_obj,\r\nwalk_state);\r\n}\r\nbreak;\r\ndefault:\r\nswitch (op_type) {\r\ncase AML_TYPE_CONTROL:\r\nstatus = acpi_ds_exec_end_control_op(walk_state, op);\r\nbreak;\r\ncase AML_TYPE_METHOD_CALL:\r\nif ((op->asl.parent) &&\r\n((op->asl.parent->asl.aml_opcode == AML_PACKAGE_OP)\r\n|| (op->asl.parent->asl.aml_opcode ==\r\nAML_VAR_PACKAGE_OP))) {\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"Method Reference in a Package, Op=%p\n",\r\nop));\r\nop->common.node =\r\n(struct acpi_namespace_node *)op->asl.value.\r\narg->asl.node;\r\nacpi_ut_add_reference(op->asl.value.arg->asl.\r\nnode->object);\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"Method invocation, Op=%p\n", op));\r\nnext_op = first_arg;\r\nnext_op = next_op->common.next;\r\nstatus = acpi_ds_create_operands(walk_state, next_op);\r\nif (ACPI_FAILURE(status)) {\r\nbreak;\r\n}\r\nstatus = acpi_ds_resolve_operands(walk_state);\r\nif (ACPI_FAILURE(status)) {\r\nacpi_ds_clear_operands(walk_state);\r\nbreak;\r\n}\r\nstatus = AE_CTRL_TRANSFER;\r\nreturn_ACPI_STATUS(status);\r\ncase AML_TYPE_CREATE_FIELD:\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC,\r\n"Executing CreateField Buffer/Index Op=%p\n",\r\nop));\r\nstatus = acpi_ds_load2_end_op(walk_state);\r\nif (ACPI_FAILURE(status)) {\r\nbreak;\r\n}\r\nstatus =\r\nacpi_ds_eval_buffer_field_operands(walk_state, op);\r\nbreak;\r\ncase AML_TYPE_CREATE_OBJECT:\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC,\r\n"Executing CreateObject (Buffer/Package) Op=%p\n",\r\nop));\r\nswitch (op->common.parent->common.aml_opcode) {\r\ncase AML_NAME_OP:\r\nwalk_state->operands[0] =\r\n(void *)op->common.parent->common.node;\r\nwalk_state->num_operands = 1;\r\nstatus = acpi_ds_create_node(walk_state,\r\nop->common.parent->\r\ncommon.node,\r\nop->common.parent);\r\nif (ACPI_FAILURE(status)) {\r\nbreak;\r\n}\r\ncase AML_INT_EVAL_SUBTREE_OP:\r\nstatus =\r\nacpi_ds_eval_data_object_operands\r\n(walk_state, op,\r\nacpi_ns_get_attached_object(op->common.\r\nparent->common.\r\nnode));\r\nbreak;\r\ndefault:\r\nstatus =\r\nacpi_ds_eval_data_object_operands\r\n(walk_state, op, NULL);\r\nbreak;\r\n}\r\nif (walk_state->result_obj) {\r\nstatus =\r\nacpi_ds_result_push(walk_state->result_obj,\r\nwalk_state);\r\n}\r\nbreak;\r\ncase AML_TYPE_NAMED_FIELD:\r\ncase AML_TYPE_NAMED_COMPLEX:\r\ncase AML_TYPE_NAMED_SIMPLE:\r\ncase AML_TYPE_NAMED_NO_OBJ:\r\nstatus = acpi_ds_load2_end_op(walk_state);\r\nif (ACPI_FAILURE(status)) {\r\nbreak;\r\n}\r\nif (op->common.aml_opcode == AML_REGION_OP) {\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC,\r\n"Executing OpRegion Address/Length Op=%p\n",\r\nop));\r\nstatus =\r\nacpi_ds_eval_region_operands(walk_state,\r\nop);\r\nif (ACPI_FAILURE(status)) {\r\nbreak;\r\n}\r\n} else if (op->common.aml_opcode == AML_DATA_REGION_OP) {\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC,\r\n"Executing DataTableRegion Strings Op=%p\n",\r\nop));\r\nstatus =\r\nacpi_ds_eval_table_region_operands\r\n(walk_state, op);\r\nif (ACPI_FAILURE(status)) {\r\nbreak;\r\n}\r\n} else if (op->common.aml_opcode == AML_BANK_FIELD_OP) {\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC,\r\n"Executing BankField Op=%p\n",\r\nop));\r\nstatus =\r\nacpi_ds_eval_bank_field_operands(walk_state,\r\nop);\r\nif (ACPI_FAILURE(status)) {\r\nbreak;\r\n}\r\n}\r\nbreak;\r\ncase AML_TYPE_UNDEFINED:\r\nACPI_ERROR((AE_INFO,\r\n"Undefined opcode type Op=%p", op));\r\nreturn_ACPI_STATUS(AE_NOT_IMPLEMENTED);\r\ncase AML_TYPE_BOGUS:\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"Internal opcode=%X type Op=%p\n",\r\nwalk_state->opcode, op));\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"Unimplemented opcode, class=0x%X type=0x%X Opcode=0x%X Op=%p",\r\nop_class, op_type, op->common.aml_opcode,\r\nop));\r\nstatus = AE_NOT_IMPLEMENTED;\r\nbreak;\r\n}\r\n}\r\n(void)acpi_ex_truncate_for32bit_table(walk_state->result_obj);\r\nif ((ACPI_SUCCESS(status)) &&\r\n(walk_state->control_state) &&\r\n(walk_state->control_state->common.state ==\r\nACPI_CONTROL_PREDICATE_EXECUTING) &&\r\n(walk_state->control_state->control.predicate_op == op)) {\r\nstatus =\r\nacpi_ds_get_predicate_value(walk_state,\r\nwalk_state->result_obj);\r\nwalk_state->result_obj = NULL;\r\n}\r\ncleanup:\r\nif (walk_state->result_obj) {\r\nACPI_DEBUGGER_EXEC(acpi_db_display_result_object\r\n(walk_state->result_obj, walk_state));\r\nacpi_ds_delete_result_if_not_used(op, walk_state->result_obj,\r\nwalk_state);\r\n}\r\n#ifdef _UNDER_DEVELOPMENT\r\nif (walk_state->parser_state.aml == walk_state->parser_state.aml_end) {\r\nacpi_db_method_end(walk_state);\r\n}\r\n#endif\r\nif (ACPI_FAILURE(status)) {\r\nstatus = acpi_ds_method_error(status, walk_state);\r\n}\r\nwalk_state->num_operands = 0;\r\nreturn_ACPI_STATUS(status);\r\n}

int of_irq_parse_pci(const struct pci_dev *pdev, struct of_phandle_args *out_irq)\r\n{\r\nstruct device_node *dn, *ppnode;\r\nstruct pci_dev *ppdev;\r\n__be32 laddr[3];\r\nu8 pin;\r\nint rc;\r\ndn = pci_device_to_OF_node(pdev);\r\nif (dn) {\r\nrc = of_irq_parse_one(dn, 0, out_irq);\r\nif (!rc)\r\nreturn rc;\r\n}\r\nrc = pci_read_config_byte(pdev, PCI_INTERRUPT_PIN, &pin);\r\nif (rc != 0)\r\ngoto err;\r\nif (pin == 0)\r\nreturn -ENODEV;\r\nfor (;;) {\r\nppdev = pdev->bus->self;\r\nif (ppdev == NULL) {\r\nppnode = pci_bus_to_OF_node(pdev->bus);\r\nif (ppnode == NULL) {\r\nrc = -EINVAL;\r\ngoto err;\r\n}\r\n} else {\r\nppnode = pci_device_to_OF_node(ppdev);\r\n}\r\nif (ppnode)\r\nbreak;\r\npin = pci_swizzle_interrupt_pin(pdev, pin);\r\npdev = ppdev;\r\n}\r\nout_irq->np = ppnode;\r\nout_irq->args_count = 1;\r\nout_irq->args[0] = pin;\r\nladdr[0] = cpu_to_be32((pdev->bus->number << 16) | (pdev->devfn << 8));\r\nladdr[1] = laddr[2] = cpu_to_be32(0);\r\nrc = of_irq_parse_raw(laddr, out_irq);\r\nif (rc)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\ndev_err(&pdev->dev, "of_irq_parse_pci() failed with rc=%d\n", rc);\r\nreturn rc;\r\n}\r\nint of_irq_parse_and_map_pci(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nstruct of_phandle_args oirq;\r\nint ret;\r\nret = of_irq_parse_pci(dev, &oirq);\r\nif (ret)\r\nreturn 0;\r\nreturn irq_create_of_mapping(&oirq);\r\n}

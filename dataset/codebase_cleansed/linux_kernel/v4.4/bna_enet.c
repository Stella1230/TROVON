static inline int\r\nethport_can_be_up(struct bna_ethport *ethport)\r\n{\r\nint ready = 0;\r\nif (ethport->bna->enet.type == BNA_ENET_T_REGULAR)\r\nready = ((ethport->flags & BNA_ETHPORT_F_ADMIN_UP) &&\r\n(ethport->flags & BNA_ETHPORT_F_RX_STARTED) &&\r\n(ethport->flags & BNA_ETHPORT_F_PORT_ENABLED));\r\nelse\r\nready = ((ethport->flags & BNA_ETHPORT_F_ADMIN_UP) &&\r\n(ethport->flags & BNA_ETHPORT_F_RX_STARTED) &&\r\n!(ethport->flags & BNA_ETHPORT_F_PORT_ENABLED));\r\nreturn ready;\r\n}\r\nstatic void\r\nbna_bfi_ethport_enable_aen(struct bna_ethport *ethport,\r\nstruct bfi_msgq_mhdr *msghdr)\r\n{\r\nethport->flags |= BNA_ETHPORT_F_PORT_ENABLED;\r\nif (ethport_can_be_up(ethport))\r\nbfa_fsm_send_event(ethport, ETHPORT_E_UP);\r\n}\r\nstatic void\r\nbna_bfi_ethport_disable_aen(struct bna_ethport *ethport,\r\nstruct bfi_msgq_mhdr *msghdr)\r\n{\r\nint ethport_up = ethport_is_up(ethport);\r\nethport->flags &= ~BNA_ETHPORT_F_PORT_ENABLED;\r\nif (ethport_up)\r\nbfa_fsm_send_event(ethport, ETHPORT_E_DOWN);\r\n}\r\nstatic void\r\nbna_bfi_ethport_admin_rsp(struct bna_ethport *ethport,\r\nstruct bfi_msgq_mhdr *msghdr)\r\n{\r\nstruct bfi_enet_enable_req *admin_req =\r\n&ethport->bfi_enet_cmd.admin_req;\r\nstruct bfi_enet_rsp *rsp =\r\ncontainer_of(msghdr, struct bfi_enet_rsp, mh);\r\nswitch (admin_req->enable) {\r\ncase BNA_STATUS_T_ENABLED:\r\nif (rsp->error == BFI_ENET_CMD_OK)\r\nbfa_fsm_send_event(ethport, ETHPORT_E_FWRESP_UP_OK);\r\nelse {\r\nethport->flags &= ~BNA_ETHPORT_F_PORT_ENABLED;\r\nbfa_fsm_send_event(ethport, ETHPORT_E_FWRESP_UP_FAIL);\r\n}\r\nbreak;\r\ncase BNA_STATUS_T_DISABLED:\r\nbfa_fsm_send_event(ethport, ETHPORT_E_FWRESP_DOWN);\r\nethport->link_status = BNA_LINK_DOWN;\r\nethport->link_cbfn(ethport->bna->bnad, BNA_LINK_DOWN);\r\nbreak;\r\n}\r\n}\r\nstatic void\r\nbna_bfi_ethport_lpbk_rsp(struct bna_ethport *ethport,\r\nstruct bfi_msgq_mhdr *msghdr)\r\n{\r\nstruct bfi_enet_diag_lb_req *diag_lb_req =\r\n&ethport->bfi_enet_cmd.lpbk_req;\r\nstruct bfi_enet_rsp *rsp =\r\ncontainer_of(msghdr, struct bfi_enet_rsp, mh);\r\nswitch (diag_lb_req->enable) {\r\ncase BNA_STATUS_T_ENABLED:\r\nif (rsp->error == BFI_ENET_CMD_OK)\r\nbfa_fsm_send_event(ethport, ETHPORT_E_FWRESP_UP_OK);\r\nelse {\r\nethport->flags &= ~BNA_ETHPORT_F_ADMIN_UP;\r\nbfa_fsm_send_event(ethport, ETHPORT_E_FWRESP_UP_FAIL);\r\n}\r\nbreak;\r\ncase BNA_STATUS_T_DISABLED:\r\nbfa_fsm_send_event(ethport, ETHPORT_E_FWRESP_DOWN);\r\nbreak;\r\n}\r\n}\r\nstatic void\r\nbna_bfi_pause_set_rsp(struct bna_enet *enet, struct bfi_msgq_mhdr *msghdr)\r\n{\r\nbfa_fsm_send_event(enet, ENET_E_FWRESP_PAUSE);\r\n}\r\nstatic void\r\nbna_bfi_attr_get_rsp(struct bna_ioceth *ioceth,\r\nstruct bfi_msgq_mhdr *msghdr)\r\n{\r\nstruct bfi_enet_attr_rsp *rsp =\r\ncontainer_of(msghdr, struct bfi_enet_attr_rsp, mh);\r\nif (!ioceth->attr.fw_query_complete) {\r\nioceth->attr.num_txq = ntohl(rsp->max_cfg);\r\nioceth->attr.num_rxp = ntohl(rsp->max_cfg);\r\nioceth->attr.num_ucmac = ntohl(rsp->max_ucmac);\r\nioceth->attr.num_mcmac = BFI_ENET_MAX_MCAM;\r\nioceth->attr.max_rit_size = ntohl(rsp->rit_size);\r\nioceth->attr.fw_query_complete = true;\r\n}\r\nbfa_fsm_send_event(ioceth, IOCETH_E_ENET_ATTR_RESP);\r\n}\r\nstatic void\r\nbna_bfi_stats_get_rsp(struct bna *bna, struct bfi_msgq_mhdr *msghdr)\r\n{\r\nstruct bfi_enet_stats_req *stats_req = &bna->stats_mod.stats_get;\r\nu64 *stats_src;\r\nu64 *stats_dst;\r\nu32 tx_enet_mask = ntohl(stats_req->tx_enet_mask);\r\nu32 rx_enet_mask = ntohl(stats_req->rx_enet_mask);\r\nint count;\r\nint i;\r\nbna_stats_copy(mac, mac);\r\nbna_stats_copy(bpc, bpc);\r\nbna_stats_copy(rad, rad);\r\nbna_stats_copy(rlb, rad);\r\nbna_stats_copy(fc_rx, fc_rx);\r\nbna_stats_copy(fc_tx, fc_tx);\r\nstats_src = (u64 *)&(bna->stats.hw_stats_kva->rxf_stats[0]);\r\nfor (i = 0; i < BFI_ENET_CFG_MAX; i++) {\r\nstats_dst = (u64 *)&(bna->stats.hw_stats.rxf_stats[i]);\r\nmemset(stats_dst, 0, sizeof(struct bfi_enet_stats_rxf));\r\nif (rx_enet_mask & BIT(i)) {\r\nint k;\r\ncount = sizeof(struct bfi_enet_stats_rxf) /\r\nsizeof(u64);\r\nfor (k = 0; k < count; k++) {\r\nstats_dst[k] = be64_to_cpu(*stats_src);\r\nstats_src++;\r\n}\r\n}\r\n}\r\nfor (i = 0; i < BFI_ENET_CFG_MAX; i++) {\r\nstats_dst = (u64 *)&(bna->stats.hw_stats.txf_stats[i]);\r\nmemset(stats_dst, 0, sizeof(struct bfi_enet_stats_txf));\r\nif (tx_enet_mask & BIT(i)) {\r\nint k;\r\ncount = sizeof(struct bfi_enet_stats_txf) /\r\nsizeof(u64);\r\nfor (k = 0; k < count; k++) {\r\nstats_dst[k] = be64_to_cpu(*stats_src);\r\nstats_src++;\r\n}\r\n}\r\n}\r\nbna->stats_mod.stats_get_busy = false;\r\nbnad_cb_stats_get(bna->bnad, BNA_CB_SUCCESS, &bna->stats);\r\n}\r\nstatic void\r\nbna_bfi_ethport_linkup_aen(struct bna_ethport *ethport,\r\nstruct bfi_msgq_mhdr *msghdr)\r\n{\r\nethport->link_status = BNA_LINK_UP;\r\nethport->link_cbfn(ethport->bna->bnad, ethport->link_status);\r\n}\r\nstatic void\r\nbna_bfi_ethport_linkdown_aen(struct bna_ethport *ethport,\r\nstruct bfi_msgq_mhdr *msghdr)\r\n{\r\nethport->link_status = BNA_LINK_DOWN;\r\nethport->link_cbfn(ethport->bna->bnad, BNA_LINK_DOWN);\r\n}\r\nstatic void\r\nbna_err_handler(struct bna *bna, u32 intr_status)\r\n{\r\nif (BNA_IS_HALT_INTR(bna, intr_status))\r\nbna_halt_clear(bna);\r\nbfa_nw_ioc_error_isr(&bna->ioceth.ioc);\r\n}\r\nvoid\r\nbna_mbox_handler(struct bna *bna, u32 intr_status)\r\n{\r\nif (BNA_IS_ERR_INTR(bna, intr_status)) {\r\nbna_err_handler(bna, intr_status);\r\nreturn;\r\n}\r\nif (BNA_IS_MBOX_INTR(bna, intr_status))\r\nbfa_nw_ioc_mbox_isr(&bna->ioceth.ioc);\r\n}\r\nstatic void\r\nbna_msgq_rsp_handler(void *arg, struct bfi_msgq_mhdr *msghdr)\r\n{\r\nstruct bna *bna = (struct bna *)arg;\r\nstruct bna_tx *tx;\r\nstruct bna_rx *rx;\r\nswitch (msghdr->msg_id) {\r\ncase BFI_ENET_I2H_RX_CFG_SET_RSP:\r\nbna_rx_from_rid(bna, msghdr->enet_id, rx);\r\nif (rx)\r\nbna_bfi_rx_enet_start_rsp(rx, msghdr);\r\nbreak;\r\ncase BFI_ENET_I2H_RX_CFG_CLR_RSP:\r\nbna_rx_from_rid(bna, msghdr->enet_id, rx);\r\nif (rx)\r\nbna_bfi_rx_enet_stop_rsp(rx, msghdr);\r\nbreak;\r\ncase BFI_ENET_I2H_RIT_CFG_RSP:\r\ncase BFI_ENET_I2H_RSS_CFG_RSP:\r\ncase BFI_ENET_I2H_RSS_ENABLE_RSP:\r\ncase BFI_ENET_I2H_RX_PROMISCUOUS_RSP:\r\ncase BFI_ENET_I2H_RX_DEFAULT_RSP:\r\ncase BFI_ENET_I2H_MAC_UCAST_CLR_RSP:\r\ncase BFI_ENET_I2H_MAC_UCAST_ADD_RSP:\r\ncase BFI_ENET_I2H_MAC_UCAST_DEL_RSP:\r\ncase BFI_ENET_I2H_MAC_MCAST_DEL_RSP:\r\ncase BFI_ENET_I2H_MAC_MCAST_FILTER_RSP:\r\ncase BFI_ENET_I2H_RX_VLAN_SET_RSP:\r\ncase BFI_ENET_I2H_RX_VLAN_STRIP_ENABLE_RSP:\r\nbna_rx_from_rid(bna, msghdr->enet_id, rx);\r\nif (rx)\r\nbna_bfi_rxf_cfg_rsp(&rx->rxf, msghdr);\r\nbreak;\r\ncase BFI_ENET_I2H_MAC_UCAST_SET_RSP:\r\nbna_rx_from_rid(bna, msghdr->enet_id, rx);\r\nif (rx)\r\nbna_bfi_rxf_ucast_set_rsp(&rx->rxf, msghdr);\r\nbreak;\r\ncase BFI_ENET_I2H_MAC_MCAST_ADD_RSP:\r\nbna_rx_from_rid(bna, msghdr->enet_id, rx);\r\nif (rx)\r\nbna_bfi_rxf_mcast_add_rsp(&rx->rxf, msghdr);\r\nbreak;\r\ncase BFI_ENET_I2H_TX_CFG_SET_RSP:\r\nbna_tx_from_rid(bna, msghdr->enet_id, tx);\r\nif (tx)\r\nbna_bfi_tx_enet_start_rsp(tx, msghdr);\r\nbreak;\r\ncase BFI_ENET_I2H_TX_CFG_CLR_RSP:\r\nbna_tx_from_rid(bna, msghdr->enet_id, tx);\r\nif (tx)\r\nbna_bfi_tx_enet_stop_rsp(tx, msghdr);\r\nbreak;\r\ncase BFI_ENET_I2H_PORT_ADMIN_RSP:\r\nbna_bfi_ethport_admin_rsp(&bna->ethport, msghdr);\r\nbreak;\r\ncase BFI_ENET_I2H_DIAG_LOOPBACK_RSP:\r\nbna_bfi_ethport_lpbk_rsp(&bna->ethport, msghdr);\r\nbreak;\r\ncase BFI_ENET_I2H_SET_PAUSE_RSP:\r\nbna_bfi_pause_set_rsp(&bna->enet, msghdr);\r\nbreak;\r\ncase BFI_ENET_I2H_GET_ATTR_RSP:\r\nbna_bfi_attr_get_rsp(&bna->ioceth, msghdr);\r\nbreak;\r\ncase BFI_ENET_I2H_STATS_GET_RSP:\r\nbna_bfi_stats_get_rsp(bna, msghdr);\r\nbreak;\r\ncase BFI_ENET_I2H_STATS_CLR_RSP:\r\nbreak;\r\ncase BFI_ENET_I2H_LINK_UP_AEN:\r\nbna_bfi_ethport_linkup_aen(&bna->ethport, msghdr);\r\nbreak;\r\ncase BFI_ENET_I2H_LINK_DOWN_AEN:\r\nbna_bfi_ethport_linkdown_aen(&bna->ethport, msghdr);\r\nbreak;\r\ncase BFI_ENET_I2H_PORT_ENABLE_AEN:\r\nbna_bfi_ethport_enable_aen(&bna->ethport, msghdr);\r\nbreak;\r\ncase BFI_ENET_I2H_PORT_DISABLE_AEN:\r\nbna_bfi_ethport_disable_aen(&bna->ethport, msghdr);\r\nbreak;\r\ncase BFI_ENET_I2H_BW_UPDATE_AEN:\r\nbna_bfi_bw_update_aen(&bna->tx_mod);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic void\r\nbna_bfi_ethport_admin_up(struct bna_ethport *ethport)\r\n{\r\nstruct bfi_enet_enable_req *admin_up_req =\r\n&ethport->bfi_enet_cmd.admin_req;\r\nbfi_msgq_mhdr_set(admin_up_req->mh, BFI_MC_ENET,\r\nBFI_ENET_H2I_PORT_ADMIN_UP_REQ, 0, 0);\r\nadmin_up_req->mh.num_entries = htons(\r\nbfi_msgq_num_cmd_entries(sizeof(struct bfi_enet_enable_req)));\r\nadmin_up_req->enable = BNA_STATUS_T_ENABLED;\r\nbfa_msgq_cmd_set(&ethport->msgq_cmd, NULL, NULL,\r\nsizeof(struct bfi_enet_enable_req), &admin_up_req->mh);\r\nbfa_msgq_cmd_post(&ethport->bna->msgq, &ethport->msgq_cmd);\r\n}\r\nstatic void\r\nbna_bfi_ethport_admin_down(struct bna_ethport *ethport)\r\n{\r\nstruct bfi_enet_enable_req *admin_down_req =\r\n&ethport->bfi_enet_cmd.admin_req;\r\nbfi_msgq_mhdr_set(admin_down_req->mh, BFI_MC_ENET,\r\nBFI_ENET_H2I_PORT_ADMIN_UP_REQ, 0, 0);\r\nadmin_down_req->mh.num_entries = htons(\r\nbfi_msgq_num_cmd_entries(sizeof(struct bfi_enet_enable_req)));\r\nadmin_down_req->enable = BNA_STATUS_T_DISABLED;\r\nbfa_msgq_cmd_set(&ethport->msgq_cmd, NULL, NULL,\r\nsizeof(struct bfi_enet_enable_req), &admin_down_req->mh);\r\nbfa_msgq_cmd_post(&ethport->bna->msgq, &ethport->msgq_cmd);\r\n}\r\nstatic void\r\nbna_bfi_ethport_lpbk_up(struct bna_ethport *ethport)\r\n{\r\nstruct bfi_enet_diag_lb_req *lpbk_up_req =\r\n&ethport->bfi_enet_cmd.lpbk_req;\r\nbfi_msgq_mhdr_set(lpbk_up_req->mh, BFI_MC_ENET,\r\nBFI_ENET_H2I_DIAG_LOOPBACK_REQ, 0, 0);\r\nlpbk_up_req->mh.num_entries = htons(\r\nbfi_msgq_num_cmd_entries(sizeof(struct bfi_enet_diag_lb_req)));\r\nlpbk_up_req->mode = (ethport->bna->enet.type ==\r\nBNA_ENET_T_LOOPBACK_INTERNAL) ?\r\nBFI_ENET_DIAG_LB_OPMODE_EXT :\r\nBFI_ENET_DIAG_LB_OPMODE_CBL;\r\nlpbk_up_req->enable = BNA_STATUS_T_ENABLED;\r\nbfa_msgq_cmd_set(&ethport->msgq_cmd, NULL, NULL,\r\nsizeof(struct bfi_enet_diag_lb_req), &lpbk_up_req->mh);\r\nbfa_msgq_cmd_post(&ethport->bna->msgq, &ethport->msgq_cmd);\r\n}\r\nstatic void\r\nbna_bfi_ethport_lpbk_down(struct bna_ethport *ethport)\r\n{\r\nstruct bfi_enet_diag_lb_req *lpbk_down_req =\r\n&ethport->bfi_enet_cmd.lpbk_req;\r\nbfi_msgq_mhdr_set(lpbk_down_req->mh, BFI_MC_ENET,\r\nBFI_ENET_H2I_DIAG_LOOPBACK_REQ, 0, 0);\r\nlpbk_down_req->mh.num_entries = htons(\r\nbfi_msgq_num_cmd_entries(sizeof(struct bfi_enet_diag_lb_req)));\r\nlpbk_down_req->enable = BNA_STATUS_T_DISABLED;\r\nbfa_msgq_cmd_set(&ethport->msgq_cmd, NULL, NULL,\r\nsizeof(struct bfi_enet_diag_lb_req), &lpbk_down_req->mh);\r\nbfa_msgq_cmd_post(&ethport->bna->msgq, &ethport->msgq_cmd);\r\n}\r\nstatic void\r\nbna_bfi_ethport_up(struct bna_ethport *ethport)\r\n{\r\nif (ethport->bna->enet.type == BNA_ENET_T_REGULAR)\r\nbna_bfi_ethport_admin_up(ethport);\r\nelse\r\nbna_bfi_ethport_lpbk_up(ethport);\r\n}\r\nstatic void\r\nbna_bfi_ethport_down(struct bna_ethport *ethport)\r\n{\r\nif (ethport->bna->enet.type == BNA_ENET_T_REGULAR)\r\nbna_bfi_ethport_admin_down(ethport);\r\nelse\r\nbna_bfi_ethport_lpbk_down(ethport);\r\n}\r\nstatic void\r\nbna_ethport_sm_stopped_entry(struct bna_ethport *ethport)\r\n{\r\ncall_ethport_stop_cbfn(ethport);\r\n}\r\nstatic void\r\nbna_ethport_sm_stopped(struct bna_ethport *ethport,\r\nenum bna_ethport_event event)\r\n{\r\nswitch (event) {\r\ncase ETHPORT_E_START:\r\nbfa_fsm_set_state(ethport, bna_ethport_sm_down);\r\nbreak;\r\ncase ETHPORT_E_STOP:\r\ncall_ethport_stop_cbfn(ethport);\r\nbreak;\r\ncase ETHPORT_E_FAIL:\r\nbreak;\r\ncase ETHPORT_E_DOWN:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_ethport_sm_down_entry(struct bna_ethport *ethport)\r\n{\r\n}\r\nstatic void\r\nbna_ethport_sm_down(struct bna_ethport *ethport,\r\nenum bna_ethport_event event)\r\n{\r\nswitch (event) {\r\ncase ETHPORT_E_STOP:\r\nbfa_fsm_set_state(ethport, bna_ethport_sm_stopped);\r\nbreak;\r\ncase ETHPORT_E_FAIL:\r\nbfa_fsm_set_state(ethport, bna_ethport_sm_stopped);\r\nbreak;\r\ncase ETHPORT_E_UP:\r\nbfa_fsm_set_state(ethport, bna_ethport_sm_up_resp_wait);\r\nbna_bfi_ethport_up(ethport);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_ethport_sm_up_resp_wait_entry(struct bna_ethport *ethport)\r\n{\r\n}\r\nstatic void\r\nbna_ethport_sm_up_resp_wait(struct bna_ethport *ethport,\r\nenum bna_ethport_event event)\r\n{\r\nswitch (event) {\r\ncase ETHPORT_E_STOP:\r\nbfa_fsm_set_state(ethport, bna_ethport_sm_last_resp_wait);\r\nbreak;\r\ncase ETHPORT_E_FAIL:\r\ncall_ethport_adminup_cbfn(ethport, BNA_CB_FAIL);\r\nbfa_fsm_set_state(ethport, bna_ethport_sm_stopped);\r\nbreak;\r\ncase ETHPORT_E_DOWN:\r\ncall_ethport_adminup_cbfn(ethport, BNA_CB_INTERRUPT);\r\nbfa_fsm_set_state(ethport, bna_ethport_sm_down_resp_wait);\r\nbreak;\r\ncase ETHPORT_E_FWRESP_UP_OK:\r\ncall_ethport_adminup_cbfn(ethport, BNA_CB_SUCCESS);\r\nbfa_fsm_set_state(ethport, bna_ethport_sm_up);\r\nbreak;\r\ncase ETHPORT_E_FWRESP_UP_FAIL:\r\ncall_ethport_adminup_cbfn(ethport, BNA_CB_FAIL);\r\nbfa_fsm_set_state(ethport, bna_ethport_sm_down);\r\nbreak;\r\ncase ETHPORT_E_FWRESP_DOWN:\r\nbna_bfi_ethport_up(ethport);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_ethport_sm_down_resp_wait_entry(struct bna_ethport *ethport)\r\n{\r\n}\r\nstatic void\r\nbna_ethport_sm_down_resp_wait(struct bna_ethport *ethport,\r\nenum bna_ethport_event event)\r\n{\r\nswitch (event) {\r\ncase ETHPORT_E_STOP:\r\nbfa_fsm_set_state(ethport, bna_ethport_sm_last_resp_wait);\r\nbreak;\r\ncase ETHPORT_E_FAIL:\r\nbfa_fsm_set_state(ethport, bna_ethport_sm_stopped);\r\nbreak;\r\ncase ETHPORT_E_UP:\r\nbfa_fsm_set_state(ethport, bna_ethport_sm_up_resp_wait);\r\nbreak;\r\ncase ETHPORT_E_FWRESP_UP_OK:\r\nbna_bfi_ethport_down(ethport);\r\nbreak;\r\ncase ETHPORT_E_FWRESP_UP_FAIL:\r\ncase ETHPORT_E_FWRESP_DOWN:\r\nbfa_fsm_set_state(ethport, bna_ethport_sm_down);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_ethport_sm_up_entry(struct bna_ethport *ethport)\r\n{\r\n}\r\nstatic void\r\nbna_ethport_sm_up(struct bna_ethport *ethport,\r\nenum bna_ethport_event event)\r\n{\r\nswitch (event) {\r\ncase ETHPORT_E_STOP:\r\nbfa_fsm_set_state(ethport, bna_ethport_sm_last_resp_wait);\r\nbna_bfi_ethport_down(ethport);\r\nbreak;\r\ncase ETHPORT_E_FAIL:\r\nbfa_fsm_set_state(ethport, bna_ethport_sm_stopped);\r\nbreak;\r\ncase ETHPORT_E_DOWN:\r\nbfa_fsm_set_state(ethport, bna_ethport_sm_down_resp_wait);\r\nbna_bfi_ethport_down(ethport);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_ethport_sm_last_resp_wait_entry(struct bna_ethport *ethport)\r\n{\r\n}\r\nstatic void\r\nbna_ethport_sm_last_resp_wait(struct bna_ethport *ethport,\r\nenum bna_ethport_event event)\r\n{\r\nswitch (event) {\r\ncase ETHPORT_E_FAIL:\r\nbfa_fsm_set_state(ethport, bna_ethport_sm_stopped);\r\nbreak;\r\ncase ETHPORT_E_DOWN:\r\nbreak;\r\ncase ETHPORT_E_FWRESP_UP_OK:\r\nbna_bfi_ethport_down(ethport);\r\nbreak;\r\ncase ETHPORT_E_FWRESP_UP_FAIL:\r\ncase ETHPORT_E_FWRESP_DOWN:\r\nbfa_fsm_set_state(ethport, bna_ethport_sm_stopped);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_ethport_init(struct bna_ethport *ethport, struct bna *bna)\r\n{\r\nethport->flags |= (BNA_ETHPORT_F_ADMIN_UP | BNA_ETHPORT_F_PORT_ENABLED);\r\nethport->bna = bna;\r\nethport->link_status = BNA_LINK_DOWN;\r\nethport->link_cbfn = bnad_cb_ethport_link_status;\r\nethport->rx_started_count = 0;\r\nethport->stop_cbfn = NULL;\r\nethport->adminup_cbfn = NULL;\r\nbfa_fsm_set_state(ethport, bna_ethport_sm_stopped);\r\n}\r\nstatic void\r\nbna_ethport_uninit(struct bna_ethport *ethport)\r\n{\r\nethport->flags &= ~BNA_ETHPORT_F_ADMIN_UP;\r\nethport->flags &= ~BNA_ETHPORT_F_PORT_ENABLED;\r\nethport->bna = NULL;\r\n}\r\nstatic void\r\nbna_ethport_start(struct bna_ethport *ethport)\r\n{\r\nbfa_fsm_send_event(ethport, ETHPORT_E_START);\r\n}\r\nstatic void\r\nbna_enet_cb_ethport_stopped(struct bna_enet *enet)\r\n{\r\nbfa_wc_down(&enet->chld_stop_wc);\r\n}\r\nstatic void\r\nbna_ethport_stop(struct bna_ethport *ethport)\r\n{\r\nethport->stop_cbfn = bna_enet_cb_ethport_stopped;\r\nbfa_fsm_send_event(ethport, ETHPORT_E_STOP);\r\n}\r\nstatic void\r\nbna_ethport_fail(struct bna_ethport *ethport)\r\n{\r\nethport->flags |= BNA_ETHPORT_F_PORT_ENABLED;\r\nif (ethport->link_status != BNA_LINK_DOWN) {\r\nethport->link_status = BNA_LINK_DOWN;\r\nethport->link_cbfn(ethport->bna->bnad, BNA_LINK_DOWN);\r\n}\r\nbfa_fsm_send_event(ethport, ETHPORT_E_FAIL);\r\n}\r\nvoid\r\nbna_ethport_cb_rx_started(struct bna_ethport *ethport)\r\n{\r\nethport->rx_started_count++;\r\nif (ethport->rx_started_count == 1) {\r\nethport->flags |= BNA_ETHPORT_F_RX_STARTED;\r\nif (ethport_can_be_up(ethport))\r\nbfa_fsm_send_event(ethport, ETHPORT_E_UP);\r\n}\r\n}\r\nvoid\r\nbna_ethport_cb_rx_stopped(struct bna_ethport *ethport)\r\n{\r\nint ethport_up = ethport_is_up(ethport);\r\nethport->rx_started_count--;\r\nif (ethport->rx_started_count == 0) {\r\nethport->flags &= ~BNA_ETHPORT_F_RX_STARTED;\r\nif (ethport_up)\r\nbfa_fsm_send_event(ethport, ETHPORT_E_DOWN);\r\n}\r\n}\r\nstatic void\r\nbna_enet_sm_stopped_entry(struct bna_enet *enet)\r\n{\r\ncall_enet_mtu_cbfn(enet);\r\ncall_enet_stop_cbfn(enet);\r\n}\r\nstatic void\r\nbna_enet_sm_stopped(struct bna_enet *enet, enum bna_enet_event event)\r\n{\r\nswitch (event) {\r\ncase ENET_E_START:\r\nbfa_fsm_set_state(enet, bna_enet_sm_pause_init_wait);\r\nbreak;\r\ncase ENET_E_STOP:\r\ncall_enet_stop_cbfn(enet);\r\nbreak;\r\ncase ENET_E_FAIL:\r\nbreak;\r\ncase ENET_E_PAUSE_CFG:\r\nbreak;\r\ncase ENET_E_MTU_CFG:\r\ncall_enet_mtu_cbfn(enet);\r\nbreak;\r\ncase ENET_E_CHLD_STOPPED:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_enet_sm_pause_init_wait_entry(struct bna_enet *enet)\r\n{\r\nbna_bfi_pause_set(enet);\r\n}\r\nstatic void\r\nbna_enet_sm_pause_init_wait(struct bna_enet *enet,\r\nenum bna_enet_event event)\r\n{\r\nswitch (event) {\r\ncase ENET_E_STOP:\r\nenet->flags &= ~BNA_ENET_F_PAUSE_CHANGED;\r\nbfa_fsm_set_state(enet, bna_enet_sm_last_resp_wait);\r\nbreak;\r\ncase ENET_E_FAIL:\r\nenet->flags &= ~BNA_ENET_F_PAUSE_CHANGED;\r\nbfa_fsm_set_state(enet, bna_enet_sm_stopped);\r\nbreak;\r\ncase ENET_E_PAUSE_CFG:\r\nenet->flags |= BNA_ENET_F_PAUSE_CHANGED;\r\nbreak;\r\ncase ENET_E_MTU_CFG:\r\nbreak;\r\ncase ENET_E_FWRESP_PAUSE:\r\nif (enet->flags & BNA_ENET_F_PAUSE_CHANGED) {\r\nenet->flags &= ~BNA_ENET_F_PAUSE_CHANGED;\r\nbna_bfi_pause_set(enet);\r\n} else {\r\nbfa_fsm_set_state(enet, bna_enet_sm_started);\r\nbna_enet_chld_start(enet);\r\n}\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_enet_sm_last_resp_wait_entry(struct bna_enet *enet)\r\n{\r\nenet->flags &= ~BNA_ENET_F_PAUSE_CHANGED;\r\n}\r\nstatic void\r\nbna_enet_sm_last_resp_wait(struct bna_enet *enet,\r\nenum bna_enet_event event)\r\n{\r\nswitch (event) {\r\ncase ENET_E_FAIL:\r\ncase ENET_E_FWRESP_PAUSE:\r\nbfa_fsm_set_state(enet, bna_enet_sm_stopped);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_enet_sm_started_entry(struct bna_enet *enet)\r\n{\r\ncall_enet_mtu_cbfn(enet);\r\n}\r\nstatic void\r\nbna_enet_sm_started(struct bna_enet *enet,\r\nenum bna_enet_event event)\r\n{\r\nswitch (event) {\r\ncase ENET_E_STOP:\r\nbfa_fsm_set_state(enet, bna_enet_sm_chld_stop_wait);\r\nbreak;\r\ncase ENET_E_FAIL:\r\nbfa_fsm_set_state(enet, bna_enet_sm_stopped);\r\nbna_enet_chld_fail(enet);\r\nbreak;\r\ncase ENET_E_PAUSE_CFG:\r\nbfa_fsm_set_state(enet, bna_enet_sm_cfg_wait);\r\nbna_bfi_pause_set(enet);\r\nbreak;\r\ncase ENET_E_MTU_CFG:\r\nbfa_fsm_set_state(enet, bna_enet_sm_cfg_wait);\r\nbna_enet_rx_stop(enet);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_enet_sm_cfg_wait_entry(struct bna_enet *enet)\r\n{\r\n}\r\nstatic void\r\nbna_enet_sm_cfg_wait(struct bna_enet *enet,\r\nenum bna_enet_event event)\r\n{\r\nswitch (event) {\r\ncase ENET_E_STOP:\r\nenet->flags &= ~BNA_ENET_F_PAUSE_CHANGED;\r\nenet->flags &= ~BNA_ENET_F_MTU_CHANGED;\r\nbfa_fsm_set_state(enet, bna_enet_sm_cfg_stop_wait);\r\nbreak;\r\ncase ENET_E_FAIL:\r\nenet->flags &= ~BNA_ENET_F_PAUSE_CHANGED;\r\nenet->flags &= ~BNA_ENET_F_MTU_CHANGED;\r\nbfa_fsm_set_state(enet, bna_enet_sm_stopped);\r\nbna_enet_chld_fail(enet);\r\nbreak;\r\ncase ENET_E_PAUSE_CFG:\r\nenet->flags |= BNA_ENET_F_PAUSE_CHANGED;\r\nbreak;\r\ncase ENET_E_MTU_CFG:\r\nenet->flags |= BNA_ENET_F_MTU_CHANGED;\r\nbreak;\r\ncase ENET_E_CHLD_STOPPED:\r\nbna_enet_rx_start(enet);\r\ncase ENET_E_FWRESP_PAUSE:\r\nif (enet->flags & BNA_ENET_F_PAUSE_CHANGED) {\r\nenet->flags &= ~BNA_ENET_F_PAUSE_CHANGED;\r\nbna_bfi_pause_set(enet);\r\n} else if (enet->flags & BNA_ENET_F_MTU_CHANGED) {\r\nenet->flags &= ~BNA_ENET_F_MTU_CHANGED;\r\nbna_enet_rx_stop(enet);\r\n} else {\r\nbfa_fsm_set_state(enet, bna_enet_sm_started);\r\n}\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_enet_sm_cfg_stop_wait_entry(struct bna_enet *enet)\r\n{\r\nenet->flags &= ~BNA_ENET_F_PAUSE_CHANGED;\r\nenet->flags &= ~BNA_ENET_F_MTU_CHANGED;\r\n}\r\nstatic void\r\nbna_enet_sm_cfg_stop_wait(struct bna_enet *enet,\r\nenum bna_enet_event event)\r\n{\r\nswitch (event) {\r\ncase ENET_E_FAIL:\r\nbfa_fsm_set_state(enet, bna_enet_sm_stopped);\r\nbna_enet_chld_fail(enet);\r\nbreak;\r\ncase ENET_E_FWRESP_PAUSE:\r\ncase ENET_E_CHLD_STOPPED:\r\nbfa_fsm_set_state(enet, bna_enet_sm_chld_stop_wait);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_enet_sm_chld_stop_wait_entry(struct bna_enet *enet)\r\n{\r\nbna_enet_chld_stop(enet);\r\n}\r\nstatic void\r\nbna_enet_sm_chld_stop_wait(struct bna_enet *enet,\r\nenum bna_enet_event event)\r\n{\r\nswitch (event) {\r\ncase ENET_E_FAIL:\r\nbfa_fsm_set_state(enet, bna_enet_sm_stopped);\r\nbna_enet_chld_fail(enet);\r\nbreak;\r\ncase ENET_E_CHLD_STOPPED:\r\nbfa_fsm_set_state(enet, bna_enet_sm_stopped);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_bfi_pause_set(struct bna_enet *enet)\r\n{\r\nstruct bfi_enet_set_pause_req *pause_req = &enet->pause_req;\r\nbfi_msgq_mhdr_set(pause_req->mh, BFI_MC_ENET,\r\nBFI_ENET_H2I_SET_PAUSE_REQ, 0, 0);\r\npause_req->mh.num_entries = htons(\r\nbfi_msgq_num_cmd_entries(sizeof(struct bfi_enet_set_pause_req)));\r\npause_req->tx_pause = enet->pause_config.tx_pause;\r\npause_req->rx_pause = enet->pause_config.rx_pause;\r\nbfa_msgq_cmd_set(&enet->msgq_cmd, NULL, NULL,\r\nsizeof(struct bfi_enet_set_pause_req), &pause_req->mh);\r\nbfa_msgq_cmd_post(&enet->bna->msgq, &enet->msgq_cmd);\r\n}\r\nstatic void\r\nbna_enet_cb_chld_stopped(void *arg)\r\n{\r\nstruct bna_enet *enet = (struct bna_enet *)arg;\r\nbfa_fsm_send_event(enet, ENET_E_CHLD_STOPPED);\r\n}\r\nstatic void\r\nbna_enet_init(struct bna_enet *enet, struct bna *bna)\r\n{\r\nenet->bna = bna;\r\nenet->flags = 0;\r\nenet->mtu = 0;\r\nenet->type = BNA_ENET_T_REGULAR;\r\nenet->stop_cbfn = NULL;\r\nenet->stop_cbarg = NULL;\r\nenet->mtu_cbfn = NULL;\r\nbfa_fsm_set_state(enet, bna_enet_sm_stopped);\r\n}\r\nstatic void\r\nbna_enet_uninit(struct bna_enet *enet)\r\n{\r\nenet->flags = 0;\r\nenet->bna = NULL;\r\n}\r\nstatic void\r\nbna_enet_start(struct bna_enet *enet)\r\n{\r\nenet->flags |= BNA_ENET_F_IOCETH_READY;\r\nif (enet->flags & BNA_ENET_F_ENABLED)\r\nbfa_fsm_send_event(enet, ENET_E_START);\r\n}\r\nstatic void\r\nbna_ioceth_cb_enet_stopped(void *arg)\r\n{\r\nstruct bna_ioceth *ioceth = (struct bna_ioceth *)arg;\r\nbfa_fsm_send_event(ioceth, IOCETH_E_ENET_STOPPED);\r\n}\r\nstatic void\r\nbna_enet_stop(struct bna_enet *enet)\r\n{\r\nenet->stop_cbfn = bna_ioceth_cb_enet_stopped;\r\nenet->stop_cbarg = &enet->bna->ioceth;\r\nenet->flags &= ~BNA_ENET_F_IOCETH_READY;\r\nbfa_fsm_send_event(enet, ENET_E_STOP);\r\n}\r\nstatic void\r\nbna_enet_fail(struct bna_enet *enet)\r\n{\r\nenet->flags &= ~BNA_ENET_F_IOCETH_READY;\r\nbfa_fsm_send_event(enet, ENET_E_FAIL);\r\n}\r\nvoid\r\nbna_enet_cb_tx_stopped(struct bna_enet *enet)\r\n{\r\nbfa_wc_down(&enet->chld_stop_wc);\r\n}\r\nvoid\r\nbna_enet_cb_rx_stopped(struct bna_enet *enet)\r\n{\r\nbfa_wc_down(&enet->chld_stop_wc);\r\n}\r\nint\r\nbna_enet_mtu_get(struct bna_enet *enet)\r\n{\r\nreturn enet->mtu;\r\n}\r\nvoid\r\nbna_enet_enable(struct bna_enet *enet)\r\n{\r\nif (enet->fsm != (bfa_sm_t)bna_enet_sm_stopped)\r\nreturn;\r\nenet->flags |= BNA_ENET_F_ENABLED;\r\nif (enet->flags & BNA_ENET_F_IOCETH_READY)\r\nbfa_fsm_send_event(enet, ENET_E_START);\r\n}\r\nvoid\r\nbna_enet_disable(struct bna_enet *enet, enum bna_cleanup_type type,\r\nvoid (*cbfn)(void *))\r\n{\r\nif (type == BNA_SOFT_CLEANUP) {\r\n(*cbfn)(enet->bna->bnad);\r\nreturn;\r\n}\r\nenet->stop_cbfn = cbfn;\r\nenet->stop_cbarg = enet->bna->bnad;\r\nenet->flags &= ~BNA_ENET_F_ENABLED;\r\nbfa_fsm_send_event(enet, ENET_E_STOP);\r\n}\r\nvoid\r\nbna_enet_pause_config(struct bna_enet *enet,\r\nstruct bna_pause_config *pause_config)\r\n{\r\nenet->pause_config = *pause_config;\r\nbfa_fsm_send_event(enet, ENET_E_PAUSE_CFG);\r\n}\r\nvoid\r\nbna_enet_mtu_set(struct bna_enet *enet, int mtu,\r\nvoid (*cbfn)(struct bnad *))\r\n{\r\nenet->mtu = mtu;\r\nenet->mtu_cbfn = cbfn;\r\nbfa_fsm_send_event(enet, ENET_E_MTU_CFG);\r\n}\r\nvoid\r\nbna_enet_perm_mac_get(struct bna_enet *enet, u8 *mac)\r\n{\r\nbfa_nw_ioc_get_mac(&enet->bna->ioceth.ioc, mac);\r\n}\r\nstatic void\r\nbna_ioceth_sm_stopped_entry(struct bna_ioceth *ioceth)\r\n{\r\ncall_ioceth_stop_cbfn(ioceth);\r\n}\r\nstatic void\r\nbna_ioceth_sm_stopped(struct bna_ioceth *ioceth,\r\nenum bna_ioceth_event event)\r\n{\r\nswitch (event) {\r\ncase IOCETH_E_ENABLE:\r\nbfa_fsm_set_state(ioceth, bna_ioceth_sm_ioc_ready_wait);\r\nbfa_nw_ioc_enable(&ioceth->ioc);\r\nbreak;\r\ncase IOCETH_E_DISABLE:\r\nbfa_fsm_set_state(ioceth, bna_ioceth_sm_stopped);\r\nbreak;\r\ncase IOCETH_E_IOC_RESET:\r\nenable_mbox_intr(ioceth);\r\nbreak;\r\ncase IOCETH_E_IOC_FAILED:\r\ndisable_mbox_intr(ioceth);\r\nbfa_fsm_set_state(ioceth, bna_ioceth_sm_failed);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_ioceth_sm_ioc_ready_wait_entry(struct bna_ioceth *ioceth)\r\n{\r\n}\r\nstatic void\r\nbna_ioceth_sm_ioc_ready_wait(struct bna_ioceth *ioceth,\r\nenum bna_ioceth_event event)\r\n{\r\nswitch (event) {\r\ncase IOCETH_E_DISABLE:\r\nbfa_fsm_set_state(ioceth, bna_ioceth_sm_ioc_disable_wait);\r\nbfa_nw_ioc_disable(&ioceth->ioc);\r\nbreak;\r\ncase IOCETH_E_IOC_RESET:\r\nenable_mbox_intr(ioceth);\r\nbreak;\r\ncase IOCETH_E_IOC_FAILED:\r\ndisable_mbox_intr(ioceth);\r\nbfa_fsm_set_state(ioceth, bna_ioceth_sm_failed);\r\nbreak;\r\ncase IOCETH_E_IOC_READY:\r\nbfa_fsm_set_state(ioceth, bna_ioceth_sm_enet_attr_wait);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_ioceth_sm_enet_attr_wait_entry(struct bna_ioceth *ioceth)\r\n{\r\nbna_bfi_attr_get(ioceth);\r\n}\r\nstatic void\r\nbna_ioceth_sm_enet_attr_wait(struct bna_ioceth *ioceth,\r\nenum bna_ioceth_event event)\r\n{\r\nswitch (event) {\r\ncase IOCETH_E_DISABLE:\r\nbfa_fsm_set_state(ioceth, bna_ioceth_sm_last_resp_wait);\r\nbreak;\r\ncase IOCETH_E_IOC_FAILED:\r\ndisable_mbox_intr(ioceth);\r\nbfa_fsm_set_state(ioceth, bna_ioceth_sm_failed);\r\nbreak;\r\ncase IOCETH_E_ENET_ATTR_RESP:\r\nbfa_fsm_set_state(ioceth, bna_ioceth_sm_ready);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_ioceth_sm_ready_entry(struct bna_ioceth *ioceth)\r\n{\r\nbna_enet_start(&ioceth->bna->enet);\r\nbna_stats_mod_start(&ioceth->bna->stats_mod);\r\nbnad_cb_ioceth_ready(ioceth->bna->bnad);\r\n}\r\nstatic void\r\nbna_ioceth_sm_ready(struct bna_ioceth *ioceth, enum bna_ioceth_event event)\r\n{\r\nswitch (event) {\r\ncase IOCETH_E_DISABLE:\r\nbfa_fsm_set_state(ioceth, bna_ioceth_sm_enet_stop_wait);\r\nbreak;\r\ncase IOCETH_E_IOC_FAILED:\r\ndisable_mbox_intr(ioceth);\r\nbna_enet_fail(&ioceth->bna->enet);\r\nbna_stats_mod_fail(&ioceth->bna->stats_mod);\r\nbfa_fsm_set_state(ioceth, bna_ioceth_sm_failed);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_ioceth_sm_last_resp_wait_entry(struct bna_ioceth *ioceth)\r\n{\r\n}\r\nstatic void\r\nbna_ioceth_sm_last_resp_wait(struct bna_ioceth *ioceth,\r\nenum bna_ioceth_event event)\r\n{\r\nswitch (event) {\r\ncase IOCETH_E_IOC_FAILED:\r\nbfa_fsm_set_state(ioceth, bna_ioceth_sm_ioc_disable_wait);\r\ndisable_mbox_intr(ioceth);\r\nbfa_nw_ioc_disable(&ioceth->ioc);\r\nbreak;\r\ncase IOCETH_E_ENET_ATTR_RESP:\r\nbfa_fsm_set_state(ioceth, bna_ioceth_sm_ioc_disable_wait);\r\nbfa_nw_ioc_disable(&ioceth->ioc);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_ioceth_sm_enet_stop_wait_entry(struct bna_ioceth *ioceth)\r\n{\r\nbna_stats_mod_stop(&ioceth->bna->stats_mod);\r\nbna_enet_stop(&ioceth->bna->enet);\r\n}\r\nstatic void\r\nbna_ioceth_sm_enet_stop_wait(struct bna_ioceth *ioceth,\r\nenum bna_ioceth_event event)\r\n{\r\nswitch (event) {\r\ncase IOCETH_E_IOC_FAILED:\r\nbfa_fsm_set_state(ioceth, bna_ioceth_sm_ioc_disable_wait);\r\ndisable_mbox_intr(ioceth);\r\nbna_enet_fail(&ioceth->bna->enet);\r\nbna_stats_mod_fail(&ioceth->bna->stats_mod);\r\nbfa_nw_ioc_disable(&ioceth->ioc);\r\nbreak;\r\ncase IOCETH_E_ENET_STOPPED:\r\nbfa_fsm_set_state(ioceth, bna_ioceth_sm_ioc_disable_wait);\r\nbfa_nw_ioc_disable(&ioceth->ioc);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_ioceth_sm_ioc_disable_wait_entry(struct bna_ioceth *ioceth)\r\n{\r\n}\r\nstatic void\r\nbna_ioceth_sm_ioc_disable_wait(struct bna_ioceth *ioceth,\r\nenum bna_ioceth_event event)\r\n{\r\nswitch (event) {\r\ncase IOCETH_E_IOC_DISABLED:\r\ndisable_mbox_intr(ioceth);\r\nbfa_fsm_set_state(ioceth, bna_ioceth_sm_stopped);\r\nbreak;\r\ncase IOCETH_E_ENET_STOPPED:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_ioceth_sm_failed_entry(struct bna_ioceth *ioceth)\r\n{\r\nbnad_cb_ioceth_failed(ioceth->bna->bnad);\r\n}\r\nstatic void\r\nbna_ioceth_sm_failed(struct bna_ioceth *ioceth,\r\nenum bna_ioceth_event event)\r\n{\r\nswitch (event) {\r\ncase IOCETH_E_DISABLE:\r\nbfa_fsm_set_state(ioceth, bna_ioceth_sm_ioc_disable_wait);\r\nbfa_nw_ioc_disable(&ioceth->ioc);\r\nbreak;\r\ncase IOCETH_E_IOC_RESET:\r\nenable_mbox_intr(ioceth);\r\nbfa_fsm_set_state(ioceth, bna_ioceth_sm_ioc_ready_wait);\r\nbreak;\r\ncase IOCETH_E_IOC_FAILED:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_bfi_attr_get(struct bna_ioceth *ioceth)\r\n{\r\nstruct bfi_enet_attr_req *attr_req = &ioceth->attr_req;\r\nbfi_msgq_mhdr_set(attr_req->mh, BFI_MC_ENET,\r\nBFI_ENET_H2I_GET_ATTR_REQ, 0, 0);\r\nattr_req->mh.num_entries = htons(\r\nbfi_msgq_num_cmd_entries(sizeof(struct bfi_enet_attr_req)));\r\nbfa_msgq_cmd_set(&ioceth->msgq_cmd, NULL, NULL,\r\nsizeof(struct bfi_enet_attr_req), &attr_req->mh);\r\nbfa_msgq_cmd_post(&ioceth->bna->msgq, &ioceth->msgq_cmd);\r\n}\r\nstatic void\r\nbna_cb_ioceth_enable(void *arg, enum bfa_status error)\r\n{\r\nstruct bna_ioceth *ioceth = (struct bna_ioceth *)arg;\r\nif (error)\r\nbfa_fsm_send_event(ioceth, IOCETH_E_IOC_FAILED);\r\nelse\r\nbfa_fsm_send_event(ioceth, IOCETH_E_IOC_READY);\r\n}\r\nstatic void\r\nbna_cb_ioceth_disable(void *arg)\r\n{\r\nstruct bna_ioceth *ioceth = (struct bna_ioceth *)arg;\r\nbfa_fsm_send_event(ioceth, IOCETH_E_IOC_DISABLED);\r\n}\r\nstatic void\r\nbna_cb_ioceth_hbfail(void *arg)\r\n{\r\nstruct bna_ioceth *ioceth = (struct bna_ioceth *)arg;\r\nbfa_fsm_send_event(ioceth, IOCETH_E_IOC_FAILED);\r\n}\r\nstatic void\r\nbna_cb_ioceth_reset(void *arg)\r\n{\r\nstruct bna_ioceth *ioceth = (struct bna_ioceth *)arg;\r\nbfa_fsm_send_event(ioceth, IOCETH_E_IOC_RESET);\r\n}\r\nstatic void bna_attr_init(struct bna_ioceth *ioceth)\r\n{\r\nioceth->attr.num_txq = BFI_ENET_DEF_TXQ;\r\nioceth->attr.num_rxp = BFI_ENET_DEF_RXP;\r\nioceth->attr.num_ucmac = BFI_ENET_DEF_UCAM;\r\nioceth->attr.num_mcmac = BFI_ENET_MAX_MCAM;\r\nioceth->attr.max_rit_size = BFI_ENET_DEF_RITSZ;\r\nioceth->attr.fw_query_complete = false;\r\n}\r\nstatic void\r\nbna_ioceth_init(struct bna_ioceth *ioceth, struct bna *bna,\r\nstruct bna_res_info *res_info)\r\n{\r\nu64 dma;\r\nu8 *kva;\r\nioceth->bna = bna;\r\nbfa_nw_ioc_attach(&ioceth->ioc, ioceth, &bna_ioceth_cbfn);\r\nbfa_nw_ioc_pci_init(&ioceth->ioc, &bna->pcidev, BFI_PCIFN_CLASS_ETH);\r\nBNA_GET_DMA_ADDR(\r\n&res_info[BNA_RES_MEM_T_ATTR].res_u.mem_info.mdl[0].dma, dma);\r\nkva = res_info[BNA_RES_MEM_T_ATTR].res_u.mem_info.mdl[0].kva;\r\nbfa_nw_ioc_mem_claim(&ioceth->ioc, kva, dma);\r\nkva = res_info[BNA_RES_MEM_T_FWTRC].res_u.mem_info.mdl[0].kva;\r\nbfa_nw_ioc_debug_memclaim(&ioceth->ioc, kva);\r\nBNA_GET_DMA_ADDR(\r\n&res_info[BNA_RES_MEM_T_COM].res_u.mem_info.mdl[0].dma, dma);\r\nkva = res_info[BNA_RES_MEM_T_COM].res_u.mem_info.mdl[0].kva;\r\nbfa_nw_cee_attach(&bna->cee, &ioceth->ioc, bna);\r\nbfa_nw_cee_mem_claim(&bna->cee, kva, dma);\r\nkva += bfa_nw_cee_meminfo();\r\ndma += bfa_nw_cee_meminfo();\r\nbfa_nw_flash_attach(&bna->flash, &ioceth->ioc, bna);\r\nbfa_nw_flash_memclaim(&bna->flash, kva, dma);\r\nkva += bfa_nw_flash_meminfo();\r\ndma += bfa_nw_flash_meminfo();\r\nbfa_msgq_attach(&bna->msgq, &ioceth->ioc);\r\nbfa_msgq_memclaim(&bna->msgq, kva, dma);\r\nbfa_msgq_regisr(&bna->msgq, BFI_MC_ENET, bna_msgq_rsp_handler, bna);\r\nkva += bfa_msgq_meminfo();\r\ndma += bfa_msgq_meminfo();\r\nioceth->stop_cbfn = NULL;\r\nioceth->stop_cbarg = NULL;\r\nbna_attr_init(ioceth);\r\nbfa_fsm_set_state(ioceth, bna_ioceth_sm_stopped);\r\n}\r\nstatic void\r\nbna_ioceth_uninit(struct bna_ioceth *ioceth)\r\n{\r\nbfa_nw_ioc_detach(&ioceth->ioc);\r\nioceth->bna = NULL;\r\n}\r\nvoid\r\nbna_ioceth_enable(struct bna_ioceth *ioceth)\r\n{\r\nif (ioceth->fsm == (bfa_fsm_t)bna_ioceth_sm_ready) {\r\nbnad_cb_ioceth_ready(ioceth->bna->bnad);\r\nreturn;\r\n}\r\nif (ioceth->fsm == (bfa_fsm_t)bna_ioceth_sm_stopped)\r\nbfa_fsm_send_event(ioceth, IOCETH_E_ENABLE);\r\n}\r\nvoid\r\nbna_ioceth_disable(struct bna_ioceth *ioceth, enum bna_cleanup_type type)\r\n{\r\nif (type == BNA_SOFT_CLEANUP) {\r\nbnad_cb_ioceth_disabled(ioceth->bna->bnad);\r\nreturn;\r\n}\r\nioceth->stop_cbfn = bnad_cb_ioceth_disabled;\r\nioceth->stop_cbarg = ioceth->bna->bnad;\r\nbfa_fsm_send_event(ioceth, IOCETH_E_DISABLE);\r\n}\r\nstatic void\r\nbna_ucam_mod_init(struct bna_ucam_mod *ucam_mod, struct bna *bna,\r\nstruct bna_res_info *res_info)\r\n{\r\nint i;\r\nucam_mod->ucmac = (struct bna_mac *)\r\nres_info[BNA_MOD_RES_MEM_T_UCMAC_ARRAY].res_u.mem_info.mdl[0].kva;\r\nINIT_LIST_HEAD(&ucam_mod->free_q);\r\nfor (i = 0; i < bna->ioceth.attr.num_ucmac; i++)\r\nlist_add_tail(&ucam_mod->ucmac[i].qe, &ucam_mod->free_q);\r\nINIT_LIST_HEAD(&ucam_mod->del_q);\r\nfor (i = i; i < (bna->ioceth.attr.num_ucmac * 2); i++)\r\nlist_add_tail(&ucam_mod->ucmac[i].qe, &ucam_mod->del_q);\r\nucam_mod->bna = bna;\r\n}\r\nstatic void\r\nbna_ucam_mod_uninit(struct bna_ucam_mod *ucam_mod)\r\n{\r\nucam_mod->bna = NULL;\r\n}\r\nstatic void\r\nbna_mcam_mod_init(struct bna_mcam_mod *mcam_mod, struct bna *bna,\r\nstruct bna_res_info *res_info)\r\n{\r\nint i;\r\nmcam_mod->mcmac = (struct bna_mac *)\r\nres_info[BNA_MOD_RES_MEM_T_MCMAC_ARRAY].res_u.mem_info.mdl[0].kva;\r\nINIT_LIST_HEAD(&mcam_mod->free_q);\r\nfor (i = 0; i < bna->ioceth.attr.num_mcmac; i++)\r\nlist_add_tail(&mcam_mod->mcmac[i].qe, &mcam_mod->free_q);\r\nmcam_mod->mchandle = (struct bna_mcam_handle *)\r\nres_info[BNA_MOD_RES_MEM_T_MCHANDLE_ARRAY].res_u.mem_info.mdl[0].kva;\r\nINIT_LIST_HEAD(&mcam_mod->free_handle_q);\r\nfor (i = 0; i < bna->ioceth.attr.num_mcmac; i++)\r\nlist_add_tail(&mcam_mod->mchandle[i].qe,\r\n&mcam_mod->free_handle_q);\r\nINIT_LIST_HEAD(&mcam_mod->del_q);\r\nfor (i = i; i < (bna->ioceth.attr.num_mcmac * 2); i++)\r\nlist_add_tail(&mcam_mod->mcmac[i].qe, &mcam_mod->del_q);\r\nmcam_mod->bna = bna;\r\n}\r\nstatic void\r\nbna_mcam_mod_uninit(struct bna_mcam_mod *mcam_mod)\r\n{\r\nmcam_mod->bna = NULL;\r\n}\r\nstatic void\r\nbna_bfi_stats_get(struct bna *bna)\r\n{\r\nstruct bfi_enet_stats_req *stats_req = &bna->stats_mod.stats_get;\r\nbna->stats_mod.stats_get_busy = true;\r\nbfi_msgq_mhdr_set(stats_req->mh, BFI_MC_ENET,\r\nBFI_ENET_H2I_STATS_GET_REQ, 0, 0);\r\nstats_req->mh.num_entries = htons(\r\nbfi_msgq_num_cmd_entries(sizeof(struct bfi_enet_stats_req)));\r\nstats_req->stats_mask = htons(BFI_ENET_STATS_ALL);\r\nstats_req->tx_enet_mask = htonl(bna->tx_mod.rid_mask);\r\nstats_req->rx_enet_mask = htonl(bna->rx_mod.rid_mask);\r\nstats_req->host_buffer.a32.addr_hi = bna->stats.hw_stats_dma.msb;\r\nstats_req->host_buffer.a32.addr_lo = bna->stats.hw_stats_dma.lsb;\r\nbfa_msgq_cmd_set(&bna->stats_mod.stats_get_cmd, NULL, NULL,\r\nsizeof(struct bfi_enet_stats_req), &stats_req->mh);\r\nbfa_msgq_cmd_post(&bna->msgq, &bna->stats_mod.stats_get_cmd);\r\n}\r\nvoid\r\nbna_res_req(struct bna_res_info *res_info)\r\n{\r\nres_info[BNA_RES_MEM_T_COM].res_type = BNA_RES_T_MEM;\r\nres_info[BNA_RES_MEM_T_COM].res_u.mem_info.mem_type = BNA_MEM_T_DMA;\r\nres_info[BNA_RES_MEM_T_COM].res_u.mem_info.num = 1;\r\nres_info[BNA_RES_MEM_T_COM].res_u.mem_info.len = ALIGN(\r\n(bfa_nw_cee_meminfo() +\r\nbfa_nw_flash_meminfo() +\r\nbfa_msgq_meminfo()), PAGE_SIZE);\r\nres_info[BNA_RES_MEM_T_ATTR].res_type = BNA_RES_T_MEM;\r\nres_info[BNA_RES_MEM_T_ATTR].res_u.mem_info.mem_type = BNA_MEM_T_DMA;\r\nres_info[BNA_RES_MEM_T_ATTR].res_u.mem_info.num = 1;\r\nres_info[BNA_RES_MEM_T_ATTR].res_u.mem_info.len =\r\nALIGN(bfa_nw_ioc_meminfo(), PAGE_SIZE);\r\nres_info[BNA_RES_MEM_T_FWTRC].res_type = BNA_RES_T_MEM;\r\nres_info[BNA_RES_MEM_T_FWTRC].res_u.mem_info.mem_type = BNA_MEM_T_KVA;\r\nres_info[BNA_RES_MEM_T_FWTRC].res_u.mem_info.num = 1;\r\nres_info[BNA_RES_MEM_T_FWTRC].res_u.mem_info.len = BNA_DBG_FWTRC_LEN;\r\nres_info[BNA_RES_MEM_T_STATS].res_type = BNA_RES_T_MEM;\r\nres_info[BNA_RES_MEM_T_STATS].res_u.mem_info.mem_type = BNA_MEM_T_DMA;\r\nres_info[BNA_RES_MEM_T_STATS].res_u.mem_info.num = 1;\r\nres_info[BNA_RES_MEM_T_STATS].res_u.mem_info.len =\r\nALIGN(sizeof(struct bfi_enet_stats),\r\nPAGE_SIZE);\r\n}\r\nvoid\r\nbna_mod_res_req(struct bna *bna, struct bna_res_info *res_info)\r\n{\r\nstruct bna_attr *attr = &bna->ioceth.attr;\r\nres_info[BNA_MOD_RES_MEM_T_TX_ARRAY].res_type = BNA_RES_T_MEM;\r\nres_info[BNA_MOD_RES_MEM_T_TX_ARRAY].res_u.mem_info.mem_type =\r\nBNA_MEM_T_KVA;\r\nres_info[BNA_MOD_RES_MEM_T_TX_ARRAY].res_u.mem_info.num = 1;\r\nres_info[BNA_MOD_RES_MEM_T_TX_ARRAY].res_u.mem_info.len =\r\nattr->num_txq * sizeof(struct bna_tx);\r\nres_info[BNA_MOD_RES_MEM_T_TXQ_ARRAY].res_type = BNA_RES_T_MEM;\r\nres_info[BNA_MOD_RES_MEM_T_TXQ_ARRAY].res_u.mem_info.mem_type =\r\nBNA_MEM_T_KVA;\r\nres_info[BNA_MOD_RES_MEM_T_TXQ_ARRAY].res_u.mem_info.num = 1;\r\nres_info[BNA_MOD_RES_MEM_T_TXQ_ARRAY].res_u.mem_info.len =\r\nattr->num_txq * sizeof(struct bna_txq);\r\nres_info[BNA_MOD_RES_MEM_T_RX_ARRAY].res_type = BNA_RES_T_MEM;\r\nres_info[BNA_MOD_RES_MEM_T_RX_ARRAY].res_u.mem_info.mem_type =\r\nBNA_MEM_T_KVA;\r\nres_info[BNA_MOD_RES_MEM_T_RX_ARRAY].res_u.mem_info.num = 1;\r\nres_info[BNA_MOD_RES_MEM_T_RX_ARRAY].res_u.mem_info.len =\r\nattr->num_rxp * sizeof(struct bna_rx);\r\nres_info[BNA_MOD_RES_MEM_T_RXP_ARRAY].res_type = BNA_RES_T_MEM;\r\nres_info[BNA_MOD_RES_MEM_T_RXP_ARRAY].res_u.mem_info.mem_type =\r\nBNA_MEM_T_KVA;\r\nres_info[BNA_MOD_RES_MEM_T_RXP_ARRAY].res_u.mem_info.num = 1;\r\nres_info[BNA_MOD_RES_MEM_T_RXP_ARRAY].res_u.mem_info.len =\r\nattr->num_rxp * sizeof(struct bna_rxp);\r\nres_info[BNA_MOD_RES_MEM_T_RXQ_ARRAY].res_type = BNA_RES_T_MEM;\r\nres_info[BNA_MOD_RES_MEM_T_RXQ_ARRAY].res_u.mem_info.mem_type =\r\nBNA_MEM_T_KVA;\r\nres_info[BNA_MOD_RES_MEM_T_RXQ_ARRAY].res_u.mem_info.num = 1;\r\nres_info[BNA_MOD_RES_MEM_T_RXQ_ARRAY].res_u.mem_info.len =\r\n(attr->num_rxp * 2) * sizeof(struct bna_rxq);\r\nres_info[BNA_MOD_RES_MEM_T_UCMAC_ARRAY].res_type = BNA_RES_T_MEM;\r\nres_info[BNA_MOD_RES_MEM_T_UCMAC_ARRAY].res_u.mem_info.mem_type =\r\nBNA_MEM_T_KVA;\r\nres_info[BNA_MOD_RES_MEM_T_UCMAC_ARRAY].res_u.mem_info.num = 1;\r\nres_info[BNA_MOD_RES_MEM_T_UCMAC_ARRAY].res_u.mem_info.len =\r\n(attr->num_ucmac * 2) * sizeof(struct bna_mac);\r\nres_info[BNA_MOD_RES_MEM_T_MCMAC_ARRAY].res_type = BNA_RES_T_MEM;\r\nres_info[BNA_MOD_RES_MEM_T_MCMAC_ARRAY].res_u.mem_info.mem_type =\r\nBNA_MEM_T_KVA;\r\nres_info[BNA_MOD_RES_MEM_T_MCMAC_ARRAY].res_u.mem_info.num = 1;\r\nres_info[BNA_MOD_RES_MEM_T_MCMAC_ARRAY].res_u.mem_info.len =\r\n(attr->num_mcmac * 2) * sizeof(struct bna_mac);\r\nres_info[BNA_MOD_RES_MEM_T_MCHANDLE_ARRAY].res_type = BNA_RES_T_MEM;\r\nres_info[BNA_MOD_RES_MEM_T_MCHANDLE_ARRAY].res_u.mem_info.mem_type =\r\nBNA_MEM_T_KVA;\r\nres_info[BNA_MOD_RES_MEM_T_MCHANDLE_ARRAY].res_u.mem_info.num = 1;\r\nres_info[BNA_MOD_RES_MEM_T_MCHANDLE_ARRAY].res_u.mem_info.len =\r\nattr->num_mcmac * sizeof(struct bna_mcam_handle);\r\n}\r\nvoid\r\nbna_init(struct bna *bna, struct bnad *bnad,\r\nstruct bfa_pcidev *pcidev, struct bna_res_info *res_info)\r\n{\r\nbna->bnad = bnad;\r\nbna->pcidev = *pcidev;\r\nbna->stats.hw_stats_kva = (struct bfi_enet_stats *)\r\nres_info[BNA_RES_MEM_T_STATS].res_u.mem_info.mdl[0].kva;\r\nbna->stats.hw_stats_dma.msb =\r\nres_info[BNA_RES_MEM_T_STATS].res_u.mem_info.mdl[0].dma.msb;\r\nbna->stats.hw_stats_dma.lsb =\r\nres_info[BNA_RES_MEM_T_STATS].res_u.mem_info.mdl[0].dma.lsb;\r\nbna_reg_addr_init(bna, &bna->pcidev);\r\nbna_ioceth_init(&bna->ioceth, bna, res_info);\r\nbna_enet_init(&bna->enet, bna);\r\nbna_ethport_init(&bna->ethport, bna);\r\n}\r\nvoid\r\nbna_mod_init(struct bna *bna, struct bna_res_info *res_info)\r\n{\r\nbna_tx_mod_init(&bna->tx_mod, bna, res_info);\r\nbna_rx_mod_init(&bna->rx_mod, bna, res_info);\r\nbna_ucam_mod_init(&bna->ucam_mod, bna, res_info);\r\nbna_mcam_mod_init(&bna->mcam_mod, bna, res_info);\r\nbna->default_mode_rid = BFI_INVALID_RID;\r\nbna->promisc_rid = BFI_INVALID_RID;\r\nbna->mod_flags |= BNA_MOD_F_INIT_DONE;\r\n}\r\nvoid\r\nbna_uninit(struct bna *bna)\r\n{\r\nif (bna->mod_flags & BNA_MOD_F_INIT_DONE) {\r\nbna_mcam_mod_uninit(&bna->mcam_mod);\r\nbna_ucam_mod_uninit(&bna->ucam_mod);\r\nbna_rx_mod_uninit(&bna->rx_mod);\r\nbna_tx_mod_uninit(&bna->tx_mod);\r\nbna->mod_flags &= ~BNA_MOD_F_INIT_DONE;\r\n}\r\nbna_stats_mod_uninit(&bna->stats_mod);\r\nbna_ethport_uninit(&bna->ethport);\r\nbna_enet_uninit(&bna->enet);\r\nbna_ioceth_uninit(&bna->ioceth);\r\nbna->bnad = NULL;\r\n}\r\nint\r\nbna_num_txq_set(struct bna *bna, int num_txq)\r\n{\r\nif (bna->ioceth.attr.fw_query_complete &&\r\n(num_txq <= bna->ioceth.attr.num_txq)) {\r\nbna->ioceth.attr.num_txq = num_txq;\r\nreturn BNA_CB_SUCCESS;\r\n}\r\nreturn BNA_CB_FAIL;\r\n}\r\nint\r\nbna_num_rxp_set(struct bna *bna, int num_rxp)\r\n{\r\nif (bna->ioceth.attr.fw_query_complete &&\r\n(num_rxp <= bna->ioceth.attr.num_rxp)) {\r\nbna->ioceth.attr.num_rxp = num_rxp;\r\nreturn BNA_CB_SUCCESS;\r\n}\r\nreturn BNA_CB_FAIL;\r\n}\r\nstruct bna_mac *\r\nbna_cam_mod_mac_get(struct list_head *head)\r\n{\r\nstruct bna_mac *mac;\r\nmac = list_first_entry_or_null(head, struct bna_mac, qe);\r\nif (mac)\r\nlist_del(&mac->qe);\r\nreturn mac;\r\n}\r\nstruct bna_mcam_handle *\r\nbna_mcam_mod_handle_get(struct bna_mcam_mod *mcam_mod)\r\n{\r\nstruct bna_mcam_handle *handle;\r\nhandle = list_first_entry_or_null(&mcam_mod->free_handle_q,\r\nstruct bna_mcam_handle, qe);\r\nif (handle)\r\nlist_del(&handle->qe);\r\nreturn handle;\r\n}\r\nvoid\r\nbna_mcam_mod_handle_put(struct bna_mcam_mod *mcam_mod,\r\nstruct bna_mcam_handle *handle)\r\n{\r\nlist_add_tail(&handle->qe, &mcam_mod->free_handle_q);\r\n}\r\nvoid\r\nbna_hw_stats_get(struct bna *bna)\r\n{\r\nif (!bna->stats_mod.ioc_ready) {\r\nbnad_cb_stats_get(bna->bnad, BNA_CB_FAIL, &bna->stats);\r\nreturn;\r\n}\r\nif (bna->stats_mod.stats_get_busy) {\r\nbnad_cb_stats_get(bna->bnad, BNA_CB_BUSY, &bna->stats);\r\nreturn;\r\n}\r\nbna_bfi_stats_get(bna);\r\n}

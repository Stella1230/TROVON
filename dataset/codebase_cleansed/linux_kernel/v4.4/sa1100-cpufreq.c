static void sa1100_update_dram_timings(int current_speed, int new_speed)\r\n{\r\nstruct sa1100_dram_regs *settings = sa1100_dram_settings;\r\nwhile (settings->speed != 0) {\r\nif (new_speed == settings->speed)\r\nbreak;\r\nsettings++;\r\n}\r\nif (settings->speed == 0) {\r\npanic("%s: couldn't find dram setting for speed %d\n",\r\n__func__, new_speed);\r\n}\r\nif (new_speed > current_speed) {\r\nMDCNFG |= MDCNFG_CDB2;\r\nMDCAS2 = settings->mdcas2;\r\nMDCAS1 = settings->mdcas1;\r\nMDCAS0 = settings->mdcas0;\r\nMDCNFG = settings->mdcnfg;\r\n} else {\r\nMDCNFG |= MDCNFG_CDB2;\r\nMDCAS0 = settings->mdcas0;\r\nMDCAS1 = settings->mdcas1;\r\nMDCAS2 = settings->mdcas2;\r\nMDCNFG = settings->mdcnfg;\r\n}\r\n}\r\nstatic int sa1100_target(struct cpufreq_policy *policy, unsigned int ppcr)\r\n{\r\nunsigned int cur = sa11x0_getspeed(0);\r\nunsigned int new_freq;\r\nnew_freq = sa11x0_freq_table[ppcr].frequency;\r\nif (new_freq > cur)\r\nsa1100_update_dram_timings(cur, new_freq);\r\nPPCR = ppcr;\r\nif (new_freq < cur)\r\nsa1100_update_dram_timings(cur, new_freq);\r\nreturn 0;\r\n}\r\nstatic int __init sa1100_cpu_init(struct cpufreq_policy *policy)\r\n{\r\nreturn cpufreq_generic_init(policy, sa11x0_freq_table, CPUFREQ_ETERNAL);\r\n}\r\nstatic int __init sa1100_dram_init(void)\r\n{\r\nif (cpu_is_sa1100())\r\nreturn cpufreq_register_driver(&sa1100_driver);\r\nelse\r\nreturn -ENODEV;\r\n}

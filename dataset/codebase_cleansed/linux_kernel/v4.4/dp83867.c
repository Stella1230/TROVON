static int dp83867_ack_interrupt(struct phy_device *phydev)\r\n{\r\nint err = phy_read(phydev, MII_DP83867_ISR);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int dp83867_config_intr(struct phy_device *phydev)\r\n{\r\nint micr_status;\r\nif (phydev->interrupts == PHY_INTERRUPT_ENABLED) {\r\nmicr_status = phy_read(phydev, MII_DP83867_MICR);\r\nif (micr_status < 0)\r\nreturn micr_status;\r\nmicr_status |=\r\n(MII_DP83867_MICR_AN_ERR_INT_EN |\r\nMII_DP83867_MICR_SPEED_CHNG_INT_EN |\r\nMII_DP83867_MICR_DUP_MODE_CHNG_INT_EN |\r\nMII_DP83867_MICR_SLEEP_MODE_CHNG_INT_EN);\r\nreturn phy_write(phydev, MII_DP83867_MICR, micr_status);\r\n}\r\nmicr_status = 0x0;\r\nreturn phy_write(phydev, MII_DP83867_MICR, micr_status);\r\n}\r\nstatic int dp83867_of_init(struct phy_device *phydev)\r\n{\r\nstruct dp83867_private *dp83867 = phydev->priv;\r\nstruct device *dev = &phydev->dev;\r\nstruct device_node *of_node = dev->of_node;\r\nint ret;\r\nif (!of_node && dev->parent->of_node)\r\nof_node = dev->parent->of_node;\r\nif (!phydev->dev.of_node)\r\nreturn -ENODEV;\r\nret = of_property_read_u32(of_node, "ti,rx-internal-delay",\r\n&dp83867->rx_id_delay);\r\nif (ret)\r\nreturn ret;\r\nret = of_property_read_u32(of_node, "ti,tx-internal-delay",\r\n&dp83867->tx_id_delay);\r\nif (ret)\r\nreturn ret;\r\nreturn of_property_read_u32(of_node, "ti,fifo-depth",\r\n&dp83867->fifo_depth);\r\n}\r\nstatic int dp83867_of_init(struct phy_device *phydev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int dp83867_config_init(struct phy_device *phydev)\r\n{\r\nstruct dp83867_private *dp83867;\r\nint ret;\r\nu16 val, delay;\r\nif (!phydev->priv) {\r\ndp83867 = devm_kzalloc(&phydev->dev, sizeof(*dp83867),\r\nGFP_KERNEL);\r\nif (!dp83867)\r\nreturn -ENOMEM;\r\nphydev->priv = dp83867;\r\nret = dp83867_of_init(phydev);\r\nif (ret)\r\nreturn ret;\r\n} else {\r\ndp83867 = (struct dp83867_private *)phydev->priv;\r\n}\r\nif (phy_interface_is_rgmii(phydev)) {\r\nret = phy_write(phydev, MII_DP83867_PHYCTRL,\r\n(dp83867->fifo_depth << DP83867_PHYCR_FIFO_DEPTH_SHIFT));\r\nif (ret)\r\nreturn ret;\r\n}\r\nif ((phydev->interface >= PHY_INTERFACE_MODE_RGMII_ID) &&\r\n(phydev->interface <= PHY_INTERFACE_MODE_RGMII_RXID)) {\r\nval = phy_read_mmd_indirect(phydev, DP83867_RGMIICTL,\r\nDP83867_DEVADDR, phydev->addr);\r\nif (phydev->interface == PHY_INTERFACE_MODE_RGMII_ID)\r\nval |= (DP83867_RGMII_TX_CLK_DELAY_EN | DP83867_RGMII_RX_CLK_DELAY_EN);\r\nif (phydev->interface == PHY_INTERFACE_MODE_RGMII_TXID)\r\nval |= DP83867_RGMII_TX_CLK_DELAY_EN;\r\nif (phydev->interface == PHY_INTERFACE_MODE_RGMII_RXID)\r\nval |= DP83867_RGMII_RX_CLK_DELAY_EN;\r\nphy_write_mmd_indirect(phydev, DP83867_RGMIICTL,\r\nDP83867_DEVADDR, phydev->addr, val);\r\ndelay = (dp83867->rx_id_delay |\r\n(dp83867->tx_id_delay << DP83867_RGMII_TX_CLK_DELAY_SHIFT));\r\nphy_write_mmd_indirect(phydev, DP83867_RGMIIDCTL,\r\nDP83867_DEVADDR, phydev->addr, delay);\r\n}\r\nreturn 0;\r\n}\r\nstatic int dp83867_phy_reset(struct phy_device *phydev)\r\n{\r\nint err;\r\nerr = phy_write(phydev, DP83867_CTRL, DP83867_SW_RESET);\r\nif (err < 0)\r\nreturn err;\r\nreturn dp83867_config_init(phydev);\r\n}

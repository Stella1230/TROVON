static int dsp56k_reset(void)\r\n{\r\nu_char status;\r\nsound_ym.rd_data_reg_sel = 14;\r\nstatus = sound_ym.rd_data_reg_sel & 0xef;\r\nsound_ym.wd_data = status;\r\nsound_ym.wd_data = status | 0x10;\r\nudelay(10);\r\nsound_ym.rd_data_reg_sel = 14;\r\nsound_ym.wd_data = sound_ym.rd_data_reg_sel & 0xef;\r\nreturn 0;\r\n}\r\nstatic int dsp56k_upload(u_char __user *bin, int len)\r\n{\r\nstruct platform_device *pdev;\r\nconst struct firmware *fw;\r\nconst char fw_name[] = "dsp56k/bootstrap.bin";\r\nint err;\r\nint i;\r\ndsp56k_reset();\r\npdev = platform_device_register_simple("dsp56k", 0, NULL, 0);\r\nif (IS_ERR(pdev)) {\r\nprintk(KERN_ERR "Failed to register device for \"%s\"\n",\r\nfw_name);\r\nreturn -EINVAL;\r\n}\r\nerr = request_firmware(&fw, fw_name, &pdev->dev);\r\nplatform_device_unregister(pdev);\r\nif (err) {\r\nprintk(KERN_ERR "Failed to load image \"%s\" err %d\n",\r\nfw_name, err);\r\nreturn err;\r\n}\r\nif (fw->size % 3) {\r\nprintk(KERN_ERR "Bogus length %d in image \"%s\"\n",\r\nfw->size, fw_name);\r\nrelease_firmware(fw);\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; i < fw->size; i = i + 3) {\r\ndsp56k_host_interface.data.b[1] = fw->data[i];\r\ndsp56k_host_interface.data.b[2] = fw->data[i + 1];\r\ndsp56k_host_interface.data.b[3] = fw->data[i + 2];\r\n}\r\nrelease_firmware(fw);\r\nfor (; i < 512; i++) {\r\ndsp56k_host_interface.data.b[1] = 0;\r\ndsp56k_host_interface.data.b[2] = 0;\r\ndsp56k_host_interface.data.b[3] = 0;\r\n}\r\nfor (i = 0; i < len; i++) {\r\ntx_wait(10);\r\nget_user(dsp56k_host_interface.data.b[1], bin++);\r\nget_user(dsp56k_host_interface.data.b[2], bin++);\r\nget_user(dsp56k_host_interface.data.b[3], bin++);\r\n}\r\ntx_wait(10);\r\ndsp56k_host_interface.data.l = 3;\r\nreturn 0;\r\n}\r\nstatic ssize_t dsp56k_read(struct file *file, char __user *buf, size_t count,\r\nloff_t *ppos)\r\n{\r\nstruct inode *inode = file_inode(file);\r\nint dev = iminor(inode) & 0x0f;\r\nswitch(dev)\r\n{\r\ncase DSP56K_DEV_56001:\r\n{\r\nlong n;\r\nif (!count) return 0;\r\nn = 0;\r\nswitch (dsp56k.rx_wsize) {\r\ncase 1:\r\n{\r\nhandshake(count, dsp56k.maxio, dsp56k.timeout, DSP56K_RECEIVE,\r\nput_user(dsp56k_host_interface.data.b[3], buf+n++));\r\nreturn n;\r\n}\r\ncase 2:\r\n{\r\nshort __user *data;\r\ncount /= 2;\r\ndata = (short __user *) buf;\r\nhandshake(count, dsp56k.maxio, dsp56k.timeout, DSP56K_RECEIVE,\r\nput_user(dsp56k_host_interface.data.w[1], data+n++));\r\nreturn 2*n;\r\n}\r\ncase 3:\r\n{\r\ncount /= 3;\r\nhandshake(count, dsp56k.maxio, dsp56k.timeout, DSP56K_RECEIVE,\r\nput_user(dsp56k_host_interface.data.b[1], buf+n++);\r\nput_user(dsp56k_host_interface.data.b[2], buf+n++);\r\nput_user(dsp56k_host_interface.data.b[3], buf+n++));\r\nreturn 3*n;\r\n}\r\ncase 4:\r\n{\r\nlong __user *data;\r\ncount /= 4;\r\ndata = (long __user *) buf;\r\nhandshake(count, dsp56k.maxio, dsp56k.timeout, DSP56K_RECEIVE,\r\nput_user(dsp56k_host_interface.data.l, data+n++));\r\nreturn 4*n;\r\n}\r\n}\r\nreturn -EFAULT;\r\n}\r\ndefault:\r\nprintk(KERN_ERR "DSP56k driver: Unknown minor device: %d\n", dev);\r\nreturn -ENXIO;\r\n}\r\n}\r\nstatic ssize_t dsp56k_write(struct file *file, const char __user *buf, size_t count,\r\nloff_t *ppos)\r\n{\r\nstruct inode *inode = file_inode(file);\r\nint dev = iminor(inode) & 0x0f;\r\nswitch(dev)\r\n{\r\ncase DSP56K_DEV_56001:\r\n{\r\nlong n;\r\nif (!count) return 0;\r\nn = 0;\r\nswitch (dsp56k.tx_wsize) {\r\ncase 1:\r\n{\r\nhandshake(count, dsp56k.maxio, dsp56k.timeout, DSP56K_TRANSMIT,\r\nget_user(dsp56k_host_interface.data.b[3], buf+n++));\r\nreturn n;\r\n}\r\ncase 2:\r\n{\r\nconst short __user *data;\r\ncount /= 2;\r\ndata = (const short __user *)buf;\r\nhandshake(count, dsp56k.maxio, dsp56k.timeout, DSP56K_TRANSMIT,\r\nget_user(dsp56k_host_interface.data.w[1], data+n++));\r\nreturn 2*n;\r\n}\r\ncase 3:\r\n{\r\ncount /= 3;\r\nhandshake(count, dsp56k.maxio, dsp56k.timeout, DSP56K_TRANSMIT,\r\nget_user(dsp56k_host_interface.data.b[1], buf+n++);\r\nget_user(dsp56k_host_interface.data.b[2], buf+n++);\r\nget_user(dsp56k_host_interface.data.b[3], buf+n++));\r\nreturn 3*n;\r\n}\r\ncase 4:\r\n{\r\nconst long __user *data;\r\ncount /= 4;\r\ndata = (const long __user *)buf;\r\nhandshake(count, dsp56k.maxio, dsp56k.timeout, DSP56K_TRANSMIT,\r\nget_user(dsp56k_host_interface.data.l, data+n++));\r\nreturn 4*n;\r\n}\r\n}\r\nreturn -EFAULT;\r\n}\r\ndefault:\r\nprintk(KERN_ERR "DSP56k driver: Unknown minor device: %d\n", dev);\r\nreturn -ENXIO;\r\n}\r\n}\r\nstatic long dsp56k_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nint dev = iminor(file_inode(file)) & 0x0f;\r\nvoid __user *argp = (void __user *)arg;\r\nswitch(dev)\r\n{\r\ncase DSP56K_DEV_56001:\r\nswitch(cmd) {\r\ncase DSP56K_UPLOAD:\r\n{\r\nchar __user *bin;\r\nint r, len;\r\nstruct dsp56k_upload __user *binary = argp;\r\nif(get_user(len, &binary->len) < 0)\r\nreturn -EFAULT;\r\nif(get_user(bin, &binary->bin) < 0)\r\nreturn -EFAULT;\r\nif (len == 0) {\r\nreturn -EINVAL;\r\n}\r\nif (len > DSP56K_MAX_BINARY_LENGTH) {\r\nreturn -EINVAL;\r\n}\r\nmutex_lock(&dsp56k_mutex);\r\nr = dsp56k_upload(bin, len);\r\nmutex_unlock(&dsp56k_mutex);\r\nif (r < 0) {\r\nreturn r;\r\n}\r\nbreak;\r\n}\r\ncase DSP56K_SET_TX_WSIZE:\r\nif (arg > 4 || arg < 1)\r\nreturn -EINVAL;\r\nmutex_lock(&dsp56k_mutex);\r\ndsp56k.tx_wsize = (int) arg;\r\nmutex_unlock(&dsp56k_mutex);\r\nbreak;\r\ncase DSP56K_SET_RX_WSIZE:\r\nif (arg > 4 || arg < 1)\r\nreturn -EINVAL;\r\nmutex_lock(&dsp56k_mutex);\r\ndsp56k.rx_wsize = (int) arg;\r\nmutex_unlock(&dsp56k_mutex);\r\nbreak;\r\ncase DSP56K_HOST_FLAGS:\r\n{\r\nint dir, out, status;\r\nstruct dsp56k_host_flags __user *hf = argp;\r\nif(get_user(dir, &hf->dir) < 0)\r\nreturn -EFAULT;\r\nif(get_user(out, &hf->out) < 0)\r\nreturn -EFAULT;\r\nmutex_lock(&dsp56k_mutex);\r\nif ((dir & 0x1) && (out & 0x1))\r\ndsp56k_host_interface.icr |= DSP56K_ICR_HF0;\r\nelse if (dir & 0x1)\r\ndsp56k_host_interface.icr &= ~DSP56K_ICR_HF0;\r\nif ((dir & 0x2) && (out & 0x2))\r\ndsp56k_host_interface.icr |= DSP56K_ICR_HF1;\r\nelse if (dir & 0x2)\r\ndsp56k_host_interface.icr &= ~DSP56K_ICR_HF1;\r\nstatus = 0;\r\nif (dsp56k_host_interface.icr & DSP56K_ICR_HF0) status |= 0x1;\r\nif (dsp56k_host_interface.icr & DSP56K_ICR_HF1) status |= 0x2;\r\nif (dsp56k_host_interface.isr & DSP56K_ISR_HF2) status |= 0x4;\r\nif (dsp56k_host_interface.isr & DSP56K_ISR_HF3) status |= 0x8;\r\nmutex_unlock(&dsp56k_mutex);\r\nreturn put_user(status, &hf->status);\r\n}\r\ncase DSP56K_HOST_CMD:\r\nif (arg > 31)\r\nreturn -EINVAL;\r\nmutex_lock(&dsp56k_mutex);\r\ndsp56k_host_interface.cvr = (u_char)((arg & DSP56K_CVR_HV_MASK) |\r\nDSP56K_CVR_HC);\r\nmutex_unlock(&dsp56k_mutex);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\ndefault:\r\nprintk(KERN_ERR "DSP56k driver: Unknown minor device: %d\n", dev);\r\nreturn -ENXIO;\r\n}\r\n}\r\nstatic int dsp56k_open(struct inode *inode, struct file *file)\r\n{\r\nint dev = iminor(inode) & 0x0f;\r\nint ret = 0;\r\nmutex_lock(&dsp56k_mutex);\r\nswitch(dev)\r\n{\r\ncase DSP56K_DEV_56001:\r\nif (test_and_set_bit(0, &dsp56k.in_use)) {\r\nret = -EBUSY;\r\ngoto out;\r\n}\r\ndsp56k.timeout = TIMEOUT;\r\ndsp56k.maxio = MAXIO;\r\ndsp56k.rx_wsize = dsp56k.tx_wsize = 4;\r\nDSP56K_TX_INT_OFF;\r\nDSP56K_RX_INT_OFF;\r\ndsp56k_host_interface.icr &= ~DSP56K_ICR_HF0;\r\ndsp56k_host_interface.icr &= ~DSP56K_ICR_HF1;\r\nbreak;\r\ndefault:\r\nret = -ENODEV;\r\n}\r\nout:\r\nmutex_unlock(&dsp56k_mutex);\r\nreturn ret;\r\n}\r\nstatic int dsp56k_release(struct inode *inode, struct file *file)\r\n{\r\nint dev = iminor(inode) & 0x0f;\r\nswitch(dev)\r\n{\r\ncase DSP56K_DEV_56001:\r\nclear_bit(0, &dsp56k.in_use);\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "DSP56k driver: Unknown minor device: %d\n", dev);\r\nreturn -ENXIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init dsp56k_init_driver(void)\r\n{\r\nint err = 0;\r\nif(!MACH_IS_ATARI || !ATARIHW_PRESENT(DSP56K)) {\r\nprintk("DSP56k driver: Hardware not present\n");\r\nreturn -ENODEV;\r\n}\r\nif(register_chrdev(DSP56K_MAJOR, "dsp56k", &dsp56k_fops)) {\r\nprintk("DSP56k driver: Unable to register driver\n");\r\nreturn -ENODEV;\r\n}\r\ndsp56k_class = class_create(THIS_MODULE, "dsp56k");\r\nif (IS_ERR(dsp56k_class)) {\r\nerr = PTR_ERR(dsp56k_class);\r\ngoto out_chrdev;\r\n}\r\ndevice_create(dsp56k_class, NULL, MKDEV(DSP56K_MAJOR, 0), NULL,\r\n"dsp56k");\r\nprintk(banner);\r\ngoto out;\r\nout_chrdev:\r\nunregister_chrdev(DSP56K_MAJOR, "dsp56k");\r\nout:\r\nreturn err;\r\n}\r\nstatic void __exit dsp56k_cleanup_driver(void)\r\n{\r\ndevice_destroy(dsp56k_class, MKDEV(DSP56K_MAJOR, 0));\r\nclass_destroy(dsp56k_class);\r\nunregister_chrdev(DSP56K_MAJOR, "dsp56k");\r\n}

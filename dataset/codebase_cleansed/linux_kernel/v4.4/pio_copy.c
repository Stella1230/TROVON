void pio_copy(struct hfi1_devdata *dd, struct pio_buf *pbuf, u64 pbc,\r\nconst void *from, size_t count)\r\n{\r\nvoid __iomem *dest = pbuf->start + SOP_DISTANCE;\r\nvoid __iomem *send = dest + PIO_BLOCK_SIZE;\r\nvoid __iomem *dend;\r\nwriteq(pbc, dest);\r\ndest += sizeof(u64);\r\ndend = dest + ((count>>1) * sizeof(u64));\r\nif (dend < send) {\r\nwhile (dest < dend) {\r\nwriteq(*(u64 *)from, dest);\r\nfrom += sizeof(u64);\r\ndest += sizeof(u64);\r\n}\r\n} else {\r\nwhile (dest < send) {\r\nwriteq(*(u64 *)from, dest);\r\nfrom += sizeof(u64);\r\ndest += sizeof(u64);\r\n}\r\ndest -= SOP_DISTANCE;\r\ndend -= SOP_DISTANCE;\r\nif (pbuf->end <= dend) {\r\nwhile (dest < pbuf->end) {\r\nwriteq(*(u64 *)from, dest);\r\nfrom += sizeof(u64);\r\ndest += sizeof(u64);\r\n}\r\ndest -= pbuf->size;\r\ndend -= pbuf->size;\r\n}\r\nwhile (dest < dend) {\r\nwriteq(*(u64 *)from, dest);\r\nfrom += sizeof(u64);\r\ndest += sizeof(u64);\r\n}\r\n}\r\nif (count & 1) {\r\nunion mix val;\r\nval.val64 = 0;\r\nval.val32[0] = *(u32 *)from;\r\nwriteq(val.val64, dest);\r\ndest += sizeof(u64);\r\n}\r\nwhile (((unsigned long)dest & PIO_BLOCK_MASK) != 0) {\r\nwriteq(0, dest);\r\ndest += sizeof(u64);\r\n}\r\natomic_dec(&pbuf->sc->buffers_allocated);\r\n}\r\nstatic inline void read_low_bytes(struct pio_buf *pbuf, const void *from,\r\nunsigned int nbytes)\r\n{\r\nunsigned long off;\r\nif (nbytes == 0) {\r\npbuf->carry.val64 = 0;\r\n} else {\r\noff = (unsigned long)from & 0x7;\r\nfrom = (void *)((unsigned long)from & ~0x7l);\r\npbuf->carry.val64 = ((*(u64 *)from)\r\n<< zshift(nbytes + off))\r\n>> zshift(nbytes);\r\n}\r\npbuf->carry_bytes = nbytes;\r\n}\r\nstatic inline void read_extra_bytes(struct pio_buf *pbuf,\r\nconst void *from, unsigned int nbytes)\r\n{\r\nunsigned long off = (unsigned long)from & 0x7;\r\nunsigned int room, xbytes;\r\nfrom = (void *)((unsigned long)from & ~0x7l);\r\nwhile (nbytes) {\r\nroom = 8 - off;\r\nxbytes = nbytes > room ? room : nbytes;\r\npbuf->carry.val64 |= (((*(u64 *)from)\r\n>> mshift(off))\r\n<< zshift(xbytes))\r\n>> zshift(xbytes+pbuf->carry_bytes);\r\noff = 0;\r\npbuf->carry_bytes += xbytes;\r\nnbytes -= xbytes;\r\nfrom += sizeof(u64);\r\n}\r\n}\r\nstatic inline void zero_extra_bytes(struct pio_buf *pbuf, unsigned int zbytes)\r\n{\r\nunsigned int remaining;\r\nif (zbytes == 0)\r\nreturn;\r\nremaining = pbuf->carry_bytes - zbytes;\r\nif (remaining)\r\npbuf->carry.val64 = (pbuf->carry.val64 << zshift(remaining))\r\n>> zshift(remaining);\r\nelse\r\npbuf->carry.val64 = 0;\r\npbuf->carry_bytes = remaining;\r\n}\r\nstatic inline void merge_write8(\r\nstruct pio_buf *pbuf,\r\nvoid __iomem *dest,\r\nconst void *src)\r\n{\r\nu64 new, temp;\r\nnew = *(u64 *)src;\r\ntemp = pbuf->carry.val64 | (new << mshift(pbuf->carry_bytes));\r\nwriteq(temp, dest);\r\npbuf->carry.val64 = new >> zshift(pbuf->carry_bytes);\r\n}\r\nstatic inline void carry8_write8(union mix carry, void __iomem *dest)\r\n{\r\nwriteq(carry.val64, dest);\r\n}\r\nstatic inline int carry_write8(struct pio_buf *pbuf, void __iomem *dest)\r\n{\r\nif (pbuf->carry_bytes) {\r\nwriteq(pbuf->carry.val64, dest);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic inline void jcopy(u8 *dest, const u8 *src, u32 n)\r\n{\r\nswitch (n) {\r\ncase 7:\r\n*dest++ = *src++;\r\ncase 6:\r\n*dest++ = *src++;\r\ncase 5:\r\n*dest++ = *src++;\r\ncase 4:\r\n*dest++ = *src++;\r\ncase 3:\r\n*dest++ = *src++;\r\ncase 2:\r\n*dest++ = *src++;\r\ncase 1:\r\n*dest++ = *src++;\r\n}\r\n}\r\nstatic inline void read_low_bytes(struct pio_buf *pbuf, const void *from,\r\nunsigned int nbytes)\r\n{\r\njcopy(&pbuf->carry.val8[0], from, nbytes);\r\npbuf->carry_bytes = nbytes;\r\n}\r\nstatic inline void read_extra_bytes(struct pio_buf *pbuf,\r\nconst void *from, unsigned int nbytes)\r\n{\r\njcopy(&pbuf->carry.val8[pbuf->carry_bytes], from, nbytes);\r\npbuf->carry_bytes += nbytes;\r\n}\r\nstatic inline void zero_extra_bytes(struct pio_buf *pbuf, unsigned int zbytes)\r\n{\r\npbuf->carry_bytes -= zbytes;\r\n}\r\nstatic inline void merge_write8(\r\nstruct pio_buf *pbuf,\r\nvoid *dest,\r\nconst void *src)\r\n{\r\nu32 remainder = 8 - pbuf->carry_bytes;\r\njcopy(&pbuf->carry.val8[pbuf->carry_bytes], src, remainder);\r\nwriteq(pbuf->carry.val64, dest);\r\njcopy(&pbuf->carry.val8[0], src+remainder, pbuf->carry_bytes);\r\n}\r\nstatic inline void carry8_write8(union mix carry, void *dest)\r\n{\r\nwriteq(carry.val64, dest);\r\n}\r\nstatic inline int carry_write8(struct pio_buf *pbuf, void *dest)\r\n{\r\nif (pbuf->carry_bytes) {\r\nu64 zero = 0;\r\njcopy(&pbuf->carry.val8[pbuf->carry_bytes], (u8 *)&zero,\r\n8 - pbuf->carry_bytes);\r\nwriteq(pbuf->carry.val64, dest);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nvoid seg_pio_copy_start(struct pio_buf *pbuf, u64 pbc,\r\nconst void *from, size_t nbytes)\r\n{\r\nvoid __iomem *dest = pbuf->start + SOP_DISTANCE;\r\nvoid __iomem *send = dest + PIO_BLOCK_SIZE;\r\nvoid __iomem *dend;\r\nwriteq(pbc, dest);\r\ndest += sizeof(u64);\r\ndend = dest + ((nbytes>>3) * sizeof(u64));\r\nif (dend < send) {\r\nwhile (dest < dend) {\r\nwriteq(*(u64 *)from, dest);\r\nfrom += sizeof(u64);\r\ndest += sizeof(u64);\r\n}\r\n} else {\r\nwhile (dest < send) {\r\nwriteq(*(u64 *)from, dest);\r\nfrom += sizeof(u64);\r\ndest += sizeof(u64);\r\n}\r\ndest -= SOP_DISTANCE;\r\ndend -= SOP_DISTANCE;\r\nif (pbuf->end <= dend) {\r\nwhile (dest < pbuf->end) {\r\nwriteq(*(u64 *)from, dest);\r\nfrom += sizeof(u64);\r\ndest += sizeof(u64);\r\n}\r\ndest -= pbuf->size;\r\ndend -= pbuf->size;\r\n}\r\nwhile (dest < dend) {\r\nwriteq(*(u64 *)from, dest);\r\nfrom += sizeof(u64);\r\ndest += sizeof(u64);\r\n}\r\n}\r\nread_low_bytes(pbuf, from, nbytes & 0x7);\r\npbuf->qw_written = 1 + (nbytes >> 3);\r\n}\r\nstatic void mid_copy_mix(struct pio_buf *pbuf, const void *from, size_t nbytes)\r\n{\r\nvoid __iomem *dest = pbuf->start + (pbuf->qw_written * sizeof(u64));\r\nvoid __iomem *dend;\r\nunsigned long qw_to_write = (pbuf->carry_bytes + nbytes) >> 3;\r\nunsigned long bytes_left = (pbuf->carry_bytes + nbytes) & 0x7;\r\ndend = dest + (qw_to_write * sizeof(u64));\r\nif (pbuf->qw_written < PIO_BLOCK_QWS) {\r\nvoid __iomem *send;\r\nvoid __iomem *xend;\r\nsend = pbuf->start + PIO_BLOCK_SIZE;\r\nxend = send < dend ? send : dend;\r\ndest += SOP_DISTANCE;\r\nxend += SOP_DISTANCE;\r\nwhile (dest < xend) {\r\nmerge_write8(pbuf, dest, from);\r\nfrom += sizeof(u64);\r\ndest += sizeof(u64);\r\n}\r\ndest -= SOP_DISTANCE;\r\n}\r\nif (pbuf->end <= dend) {\r\nwhile (dest < pbuf->end) {\r\nmerge_write8(pbuf, dest, from);\r\nfrom += sizeof(u64);\r\ndest += sizeof(u64);\r\n}\r\ndest -= pbuf->size;\r\ndend -= pbuf->size;\r\n}\r\nwhile (dest < dend) {\r\nmerge_write8(pbuf, dest, from);\r\nfrom += sizeof(u64);\r\ndest += sizeof(u64);\r\n}\r\nif (pbuf->carry_bytes < bytes_left) {\r\nread_extra_bytes(pbuf, from, bytes_left - pbuf->carry_bytes);\r\n} else {\r\nzero_extra_bytes(pbuf, pbuf->carry_bytes - bytes_left);\r\n}\r\npbuf->qw_written += qw_to_write;\r\n}\r\nstatic void mid_copy_straight(struct pio_buf *pbuf,\r\nconst void *from, size_t nbytes)\r\n{\r\nvoid __iomem *dest = pbuf->start + (pbuf->qw_written * sizeof(u64));\r\nvoid __iomem *dend;\r\ndend = dest + ((nbytes>>3) * sizeof(u64));\r\nif (pbuf->qw_written < PIO_BLOCK_QWS) {\r\nvoid __iomem *send;\r\nvoid __iomem *xend;\r\nsend = pbuf->start + PIO_BLOCK_SIZE;\r\nxend = send < dend ? send : dend;\r\ndest += SOP_DISTANCE;\r\nxend += SOP_DISTANCE;\r\nwhile (dest < xend) {\r\nwriteq(*(u64 *)from, dest);\r\nfrom += sizeof(u64);\r\ndest += sizeof(u64);\r\n}\r\ndest -= SOP_DISTANCE;\r\n}\r\nif (pbuf->end <= dend) {\r\nwhile (dest < pbuf->end) {\r\nwriteq(*(u64 *)from, dest);\r\nfrom += sizeof(u64);\r\ndest += sizeof(u64);\r\n}\r\ndest -= pbuf->size;\r\ndend -= pbuf->size;\r\n}\r\nwhile (dest < dend) {\r\nwriteq(*(u64 *)from, dest);\r\nfrom += sizeof(u64);\r\ndest += sizeof(u64);\r\n}\r\nread_low_bytes(pbuf, from, nbytes & 0x7);\r\npbuf->qw_written += nbytes>>3;\r\n}\r\nvoid seg_pio_copy_mid(struct pio_buf *pbuf, const void *from, size_t nbytes)\r\n{\r\nunsigned long from_align = (unsigned long)from & 0x7;\r\nif (pbuf->carry_bytes + nbytes < 8) {\r\nread_extra_bytes(pbuf, from, nbytes);\r\nreturn;\r\n}\r\nif (from_align) {\r\nunsigned long to_align;\r\nto_align = 8 - from_align;\r\nif (pbuf->carry_bytes + to_align < 8) {\r\nread_extra_bytes(pbuf, from, to_align);\r\nfrom += to_align;\r\nnbytes -= to_align;\r\n} else {\r\nunsigned long to_fill = 8 - pbuf->carry_bytes;\r\nunsigned long extra = to_align - to_fill;\r\nvoid __iomem *dest;\r\nread_extra_bytes(pbuf, from, to_fill);\r\nfrom += to_fill;\r\nnbytes -= to_fill;\r\ndest = pbuf->start + (pbuf->qw_written * sizeof(u64));\r\nif (dest >= pbuf->end)\r\ndest -= pbuf->size;\r\nelse if (pbuf->qw_written < PIO_BLOCK_QWS)\r\ndest += SOP_DISTANCE;\r\ncarry8_write8(pbuf->carry, dest);\r\npbuf->qw_written++;\r\nread_low_bytes(pbuf, from, extra);\r\nfrom += extra;\r\nnbytes -= extra;\r\n}\r\n}\r\nif (pbuf->carry_bytes)\r\nmid_copy_mix(pbuf, from, nbytes);\r\nelse\r\nmid_copy_straight(pbuf, from, nbytes);\r\n}\r\nvoid seg_pio_copy_end(struct pio_buf *pbuf)\r\n{\r\nvoid __iomem *dest = pbuf->start + (pbuf->qw_written * sizeof(u64));\r\nif (dest >= pbuf->end)\r\ndest -= pbuf->size;\r\nelse if (pbuf->qw_written < PIO_BLOCK_QWS)\r\ndest += SOP_DISTANCE;\r\nif (carry_write8(pbuf, dest)) {\r\ndest += sizeof(u64);\r\n}\r\nwhile (((unsigned long)dest & PIO_BLOCK_MASK) != 0) {\r\nwriteq(0, dest);\r\ndest += sizeof(u64);\r\n}\r\natomic_dec(&pbuf->sc->buffers_allocated);\r\n}

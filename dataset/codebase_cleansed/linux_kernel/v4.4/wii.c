static int mipc_check_address(u32 pa)\r\n{\r\nif (pa < 0x10000000 || pa > 0x14000000)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic struct mipc_infohdr *mipc_get_infohdr(void)\r\n{\r\nstruct mipc_infohdr **hdrp, *hdr;\r\nhdrp = (struct mipc_infohdr **)0x13fffffc;\r\nif (mipc_check_address((u32)hdrp)) {\r\nprintf("mini: invalid hdrp %08X\n", (u32)hdrp);\r\nhdr = NULL;\r\ngoto out;\r\n}\r\nhdr = *hdrp;\r\nif (mipc_check_address((u32)hdr)) {\r\nprintf("mini: invalid hdr %08X\n", (u32)hdr);\r\nhdr = NULL;\r\ngoto out;\r\n}\r\nif (memcmp(hdr->magic, "IPC", 3)) {\r\nprintf("mini: invalid magic\n");\r\nhdr = NULL;\r\ngoto out;\r\n}\r\nout:\r\nreturn hdr;\r\n}\r\nstatic int mipc_get_mem2_boundary(u32 *mem2_boundary)\r\n{\r\nstruct mipc_infohdr *hdr;\r\nint error;\r\nhdr = mipc_get_infohdr();\r\nif (!hdr) {\r\nerror = -1;\r\ngoto out;\r\n}\r\nif (mipc_check_address(hdr->mem2_boundary)) {\r\nprintf("mini: invalid mem2_boundary %08X\n",\r\nhdr->mem2_boundary);\r\nerror = -EINVAL;\r\ngoto out;\r\n}\r\n*mem2_boundary = hdr->mem2_boundary;\r\nerror = 0;\r\nout:\r\nreturn error;\r\n}\r\nstatic void platform_fixups(void)\r\n{\r\nvoid *mem;\r\nu32 reg[4];\r\nu32 mem2_boundary;\r\nint len;\r\nint error;\r\nmem = finddevice("/memory");\r\nif (!mem)\r\nfatal("Can't find memory node\n");\r\nlen = getprop(mem, "reg", reg, sizeof(reg));\r\nif (len != sizeof(reg)) {\r\ngoto out;\r\n}\r\nerror = mipc_get_mem2_boundary(&mem2_boundary);\r\nif (error) {\r\nmem2_boundary = MEM2_TOP - FIRMWARE_DEFAULT_SIZE;\r\n}\r\nif (mem2_boundary > reg[2] && mem2_boundary < reg[2] + reg[3]) {\r\nreg[3] = mem2_boundary - reg[2];\r\nprintf("top of MEM2 @ %08X\n", reg[2] + reg[3]);\r\nsetprop(mem, "reg", reg, sizeof(reg));\r\n}\r\nout:\r\nreturn;\r\n}\r\nvoid platform_init(unsigned long r3, unsigned long r4, unsigned long r5)\r\n{\r\nu32 heapsize = 24*1024*1024 - (u32)_end;\r\nsimple_alloc_init(_end, heapsize, 32, 64);\r\nfdt_init(_dtb_start);\r\nout_be32(EXI_CTRL, in_be32(EXI_CTRL) | EXI_CTRL_ENABLE);\r\nif (ug_probe())\r\nconsole_ops.write = ug_console_write;\r\nplatform_ops.fixups = platform_fixups;\r\n}

static int ab8500_ext_regulator_enable(struct regulator_dev *rdev)\r\n{\r\nint ret;\r\nstruct ab8500_ext_regulator_info *info = rdev_get_drvdata(rdev);\r\nu8 regval;\r\nif (info == NULL) {\r\ndev_err(rdev_get_dev(rdev), "regulator info null pointer\n");\r\nreturn -EINVAL;\r\n}\r\nif (info->cfg && info->cfg->hwreq)\r\nregval = info->update_val_hp;\r\nelse\r\nregval = info->update_val;\r\nret = abx500_mask_and_set_register_interruptible(info->dev,\r\ninfo->update_bank, info->update_reg,\r\ninfo->update_mask, regval);\r\nif (ret < 0) {\r\ndev_err(rdev_get_dev(info->rdev),\r\n"couldn't set enable bits for regulator\n");\r\nreturn ret;\r\n}\r\ndev_dbg(rdev_get_dev(rdev),\r\n"%s-enable (bank, reg, mask, value): 0x%02x, 0x%02x, 0x%02x, 0x%02x\n",\r\ninfo->desc.name, info->update_bank, info->update_reg,\r\ninfo->update_mask, regval);\r\nreturn 0;\r\n}\r\nstatic int ab8500_ext_regulator_disable(struct regulator_dev *rdev)\r\n{\r\nint ret;\r\nstruct ab8500_ext_regulator_info *info = rdev_get_drvdata(rdev);\r\nu8 regval;\r\nif (info == NULL) {\r\ndev_err(rdev_get_dev(rdev), "regulator info null pointer\n");\r\nreturn -EINVAL;\r\n}\r\nif (info->cfg && info->cfg->hwreq)\r\nregval = info->update_val_hw;\r\nelse\r\nregval = 0;\r\nret = abx500_mask_and_set_register_interruptible(info->dev,\r\ninfo->update_bank, info->update_reg,\r\ninfo->update_mask, regval);\r\nif (ret < 0) {\r\ndev_err(rdev_get_dev(info->rdev),\r\n"couldn't set disable bits for regulator\n");\r\nreturn ret;\r\n}\r\ndev_dbg(rdev_get_dev(rdev), "%s-disable (bank, reg, mask, value):"\r\n" 0x%02x, 0x%02x, 0x%02x, 0x%02x\n",\r\ninfo->desc.name, info->update_bank, info->update_reg,\r\ninfo->update_mask, regval);\r\nreturn 0;\r\n}\r\nstatic int ab8500_ext_regulator_is_enabled(struct regulator_dev *rdev)\r\n{\r\nint ret;\r\nstruct ab8500_ext_regulator_info *info = rdev_get_drvdata(rdev);\r\nu8 regval;\r\nif (info == NULL) {\r\ndev_err(rdev_get_dev(rdev), "regulator info null pointer\n");\r\nreturn -EINVAL;\r\n}\r\nret = abx500_get_register_interruptible(info->dev,\r\ninfo->update_bank, info->update_reg, &regval);\r\nif (ret < 0) {\r\ndev_err(rdev_get_dev(rdev),\r\n"couldn't read 0x%x register\n", info->update_reg);\r\nreturn ret;\r\n}\r\ndev_dbg(rdev_get_dev(rdev), "%s-is_enabled (bank, reg, mask, value):"\r\n" 0x%02x, 0x%02x, 0x%02x, 0x%02x\n",\r\ninfo->desc.name, info->update_bank, info->update_reg,\r\ninfo->update_mask, regval);\r\nif (((regval & info->update_mask) == info->update_val_lp) ||\r\n((regval & info->update_mask) == info->update_val_hp))\r\nreturn 1;\r\nelse\r\nreturn 0;\r\n}\r\nstatic int ab8500_ext_regulator_set_mode(struct regulator_dev *rdev,\r\nunsigned int mode)\r\n{\r\nint ret = 0;\r\nstruct ab8500_ext_regulator_info *info = rdev_get_drvdata(rdev);\r\nu8 regval;\r\nif (info == NULL) {\r\ndev_err(rdev_get_dev(rdev), "regulator info null pointer\n");\r\nreturn -EINVAL;\r\n}\r\nswitch (mode) {\r\ncase REGULATOR_MODE_NORMAL:\r\nregval = info->update_val_hp;\r\nbreak;\r\ncase REGULATOR_MODE_IDLE:\r\nregval = info->update_val_lp;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (ab8500_ext_regulator_is_enabled(rdev) &&\r\n!(info->cfg && info->cfg->hwreq)) {\r\nret = abx500_mask_and_set_register_interruptible(info->dev,\r\ninfo->update_bank, info->update_reg,\r\ninfo->update_mask, regval);\r\nif (ret < 0) {\r\ndev_err(rdev_get_dev(rdev),\r\n"Could not set regulator mode.\n");\r\nreturn ret;\r\n}\r\ndev_dbg(rdev_get_dev(rdev),\r\n"%s-set_mode (bank, reg, mask, value): "\r\n"0x%x, 0x%x, 0x%x, 0x%x\n",\r\ninfo->desc.name, info->update_bank, info->update_reg,\r\ninfo->update_mask, regval);\r\n}\r\ninfo->update_val = regval;\r\nreturn 0;\r\n}\r\nstatic unsigned int ab8500_ext_regulator_get_mode(struct regulator_dev *rdev)\r\n{\r\nstruct ab8500_ext_regulator_info *info = rdev_get_drvdata(rdev);\r\nint ret;\r\nif (info == NULL) {\r\ndev_err(rdev_get_dev(rdev), "regulator info null pointer\n");\r\nreturn -EINVAL;\r\n}\r\nif (info->update_val == info->update_val_hp)\r\nret = REGULATOR_MODE_NORMAL;\r\nelse if (info->update_val == info->update_val_lp)\r\nret = REGULATOR_MODE_IDLE;\r\nelse\r\nret = -EINVAL;\r\nreturn ret;\r\n}\r\nstatic int ab8500_ext_set_voltage(struct regulator_dev *rdev, int min_uV,\r\nint max_uV, unsigned *selector)\r\n{\r\nstruct regulation_constraints *regu_constraints = rdev->constraints;\r\nif (!regu_constraints) {\r\ndev_err(rdev_get_dev(rdev), "No regulator constraints\n");\r\nreturn -EINVAL;\r\n}\r\nif (regu_constraints->min_uV == min_uV &&\r\nregu_constraints->max_uV == max_uV)\r\nreturn 0;\r\ndev_err(rdev_get_dev(rdev),\r\n"Requested min %duV max %duV != constrained min %duV max %duV\n",\r\nmin_uV, max_uV,\r\nregu_constraints->min_uV, regu_constraints->max_uV);\r\nreturn -EINVAL;\r\n}\r\nstatic int ab8500_ext_list_voltage(struct regulator_dev *rdev,\r\nunsigned selector)\r\n{\r\nstruct regulation_constraints *regu_constraints = rdev->constraints;\r\nif (regu_constraints == NULL) {\r\ndev_err(rdev_get_dev(rdev), "regulator constraints null pointer\n");\r\nreturn -EINVAL;\r\n}\r\nif (regu_constraints->min_uV && regu_constraints->max_uV) {\r\nif (regu_constraints->min_uV == regu_constraints->max_uV)\r\nreturn regu_constraints->min_uV;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int ab8500_ext_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct ab8500 *ab8500 = dev_get_drvdata(pdev->dev.parent);\r\nstruct ab8500_platform_data *ppdata;\r\nstruct ab8500_regulator_platform_data *pdata;\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct regulator_config config = { };\r\nint i, err;\r\nif (np) {\r\nerr = of_regulator_match(&pdev->dev, np,\r\nab8500_ext_regulator_match,\r\nARRAY_SIZE(ab8500_ext_regulator_match));\r\nif (err < 0) {\r\ndev_err(&pdev->dev,\r\n"Error parsing regulator init data: %d\n", err);\r\nreturn err;\r\n}\r\n}\r\nif (!ab8500) {\r\ndev_err(&pdev->dev, "null mfd parent\n");\r\nreturn -EINVAL;\r\n}\r\nppdata = dev_get_platdata(ab8500->dev);\r\nif (!ppdata) {\r\ndev_err(&pdev->dev, "null parent pdata\n");\r\nreturn -EINVAL;\r\n}\r\npdata = ppdata->regulator;\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "null pdata\n");\r\nreturn -EINVAL;\r\n}\r\nif (pdata->num_ext_regulator != ARRAY_SIZE(ab8500_ext_regulator_info)) {\r\ndev_err(&pdev->dev, "Configuration error: size mismatch.\n");\r\nreturn -EINVAL;\r\n}\r\nif (is_ab8500_2p0_or_earlier(ab8500)) {\r\nstruct ab8500_ext_regulator_info *info;\r\ninfo = &ab8500_ext_regulator_info[AB8500_EXT_SUPPLY3];\r\ninfo->update_val = 0x30;\r\ninfo->update_val_hp = 0x30;\r\ninfo->update_val_lp = 0x10;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(ab8500_ext_regulator_info); i++) {\r\nstruct ab8500_ext_regulator_info *info = NULL;\r\ninfo = &ab8500_ext_regulator_info[i];\r\ninfo->dev = &pdev->dev;\r\ninfo->cfg = (struct ab8500_ext_regulator_cfg *)\r\npdata->ext_regulator[i].driver_data;\r\nconfig.dev = &pdev->dev;\r\nconfig.driver_data = info;\r\nconfig.of_node = ab8500_ext_regulator_match[i].of_node;\r\nconfig.init_data = (np) ?\r\nab8500_ext_regulator_match[i].init_data :\r\n&pdata->ext_regulator[i];\r\ninfo->rdev = devm_regulator_register(&pdev->dev, &info->desc,\r\n&config);\r\nif (IS_ERR(info->rdev)) {\r\nerr = PTR_ERR(info->rdev);\r\ndev_err(&pdev->dev, "failed to register regulator %s\n",\r\ninfo->desc.name);\r\nreturn err;\r\n}\r\ndev_dbg(rdev_get_dev(info->rdev),\r\n"%s-probed\n", info->desc.name);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init ab8500_ext_regulator_init(void)\r\n{\r\nint ret;\r\nret = platform_driver_register(&ab8500_ext_regulator_driver);\r\nif (ret)\r\npr_err("Failed to register ab8500 ext regulator: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic void __exit ab8500_ext_regulator_exit(void)\r\n{\r\nplatform_driver_unregister(&ab8500_ext_regulator_driver);\r\n}

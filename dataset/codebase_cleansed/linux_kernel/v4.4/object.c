int\r\nnvkm_object_mthd(struct nvkm_object *object, u32 mthd, void *data, u32 size)\r\n{\r\nif (likely(object->func->mthd))\r\nreturn object->func->mthd(object, mthd, data, size);\r\nreturn -ENODEV;\r\n}\r\nint\r\nnvkm_object_ntfy(struct nvkm_object *object, u32 mthd,\r\nstruct nvkm_event **pevent)\r\n{\r\nif (likely(object->func->ntfy))\r\nreturn object->func->ntfy(object, mthd, pevent);\r\nreturn -ENODEV;\r\n}\r\nint\r\nnvkm_object_map(struct nvkm_object *object, u64 *addr, u32 *size)\r\n{\r\nif (likely(object->func->map))\r\nreturn object->func->map(object, addr, size);\r\nreturn -ENODEV;\r\n}\r\nint\r\nnvkm_object_rd08(struct nvkm_object *object, u64 addr, u8 *data)\r\n{\r\nif (likely(object->func->rd08))\r\nreturn object->func->rd08(object, addr, data);\r\nreturn -ENODEV;\r\n}\r\nint\r\nnvkm_object_rd16(struct nvkm_object *object, u64 addr, u16 *data)\r\n{\r\nif (likely(object->func->rd16))\r\nreturn object->func->rd16(object, addr, data);\r\nreturn -ENODEV;\r\n}\r\nint\r\nnvkm_object_rd32(struct nvkm_object *object, u64 addr, u32 *data)\r\n{\r\nif (likely(object->func->rd32))\r\nreturn object->func->rd32(object, addr, data);\r\nreturn -ENODEV;\r\n}\r\nint\r\nnvkm_object_wr08(struct nvkm_object *object, u64 addr, u8 data)\r\n{\r\nif (likely(object->func->wr08))\r\nreturn object->func->wr08(object, addr, data);\r\nreturn -ENODEV;\r\n}\r\nint\r\nnvkm_object_wr16(struct nvkm_object *object, u64 addr, u16 data)\r\n{\r\nif (likely(object->func->wr16))\r\nreturn object->func->wr16(object, addr, data);\r\nreturn -ENODEV;\r\n}\r\nint\r\nnvkm_object_wr32(struct nvkm_object *object, u64 addr, u32 data)\r\n{\r\nif (likely(object->func->wr32))\r\nreturn object->func->wr32(object, addr, data);\r\nreturn -ENODEV;\r\n}\r\nint\r\nnvkm_object_bind(struct nvkm_object *object, struct nvkm_gpuobj *gpuobj,\r\nint align, struct nvkm_gpuobj **pgpuobj)\r\n{\r\nif (object->func->bind)\r\nreturn object->func->bind(object, gpuobj, align, pgpuobj);\r\nreturn -ENODEV;\r\n}\r\nint\r\nnvkm_object_fini(struct nvkm_object *object, bool suspend)\r\n{\r\nconst char *action = suspend ? "suspend" : "fini";\r\nstruct nvkm_object *child;\r\ns64 time;\r\nint ret;\r\nnvif_debug(object, "%s children...\n", action);\r\ntime = ktime_to_us(ktime_get());\r\nlist_for_each_entry(child, &object->tree, head) {\r\nret = nvkm_object_fini(child, suspend);\r\nif (ret && suspend)\r\ngoto fail_child;\r\n}\r\nnvif_debug(object, "%s running...\n", action);\r\nif (object->func->fini) {\r\nret = object->func->fini(object, suspend);\r\nif (ret) {\r\nnvif_error(object, "%s failed with %d\n", action, ret);\r\nif (suspend)\r\ngoto fail;\r\n}\r\n}\r\ntime = ktime_to_us(ktime_get()) - time;\r\nnvif_debug(object, "%s completed in %lldus\n", action, time);\r\nreturn 0;\r\nfail:\r\nif (object->func->init) {\r\nint rret = object->func->init(object);\r\nif (rret)\r\nnvif_fatal(object, "failed to restart, %d\n", rret);\r\n}\r\nfail_child:\r\nlist_for_each_entry_continue_reverse(child, &object->tree, head) {\r\nnvkm_object_init(child);\r\n}\r\nreturn ret;\r\n}\r\nint\r\nnvkm_object_init(struct nvkm_object *object)\r\n{\r\nstruct nvkm_object *child;\r\ns64 time;\r\nint ret;\r\nnvif_debug(object, "init running...\n");\r\ntime = ktime_to_us(ktime_get());\r\nif (object->func->init) {\r\nret = object->func->init(object);\r\nif (ret)\r\ngoto fail;\r\n}\r\nnvif_debug(object, "init children...\n");\r\nlist_for_each_entry(child, &object->tree, head) {\r\nret = nvkm_object_init(child);\r\nif (ret)\r\ngoto fail_child;\r\n}\r\ntime = ktime_to_us(ktime_get()) - time;\r\nnvif_debug(object, "init completed in %lldus\n", time);\r\nreturn 0;\r\nfail_child:\r\nlist_for_each_entry_continue_reverse(child, &object->tree, head)\r\nnvkm_object_fini(child, false);\r\nfail:\r\nnvif_error(object, "init failed with %d\n", ret);\r\nif (object->func->fini)\r\nobject->func->fini(object, false);\r\nreturn ret;\r\n}\r\nvoid *\r\nnvkm_object_dtor(struct nvkm_object *object)\r\n{\r\nstruct nvkm_object *child, *ctemp;\r\nvoid *data = object;\r\ns64 time;\r\nnvif_debug(object, "destroy children...\n");\r\ntime = ktime_to_us(ktime_get());\r\nlist_for_each_entry_safe(child, ctemp, &object->tree, head) {\r\nnvkm_object_del(&child);\r\n}\r\nnvif_debug(object, "destroy running...\n");\r\nif (object->func->dtor)\r\ndata = object->func->dtor(object);\r\nnvkm_engine_unref(&object->engine);\r\ntime = ktime_to_us(ktime_get()) - time;\r\nnvif_debug(object, "destroy completed in %lldus...\n", time);\r\nreturn data;\r\n}\r\nvoid\r\nnvkm_object_del(struct nvkm_object **pobject)\r\n{\r\nstruct nvkm_object *object = *pobject;\r\nif (object && !WARN_ON(!object->func)) {\r\n*pobject = nvkm_object_dtor(object);\r\nnvkm_client_remove(object->client, object);\r\nlist_del(&object->head);\r\nkfree(*pobject);\r\n*pobject = NULL;\r\n}\r\n}\r\nvoid\r\nnvkm_object_ctor(const struct nvkm_object_func *func,\r\nconst struct nvkm_oclass *oclass, struct nvkm_object *object)\r\n{\r\nobject->func = func;\r\nobject->client = oclass->client;\r\nobject->engine = nvkm_engine_ref(oclass->engine);\r\nobject->oclass = oclass->base.oclass;\r\nobject->handle = oclass->handle;\r\nINIT_LIST_HEAD(&object->head);\r\nINIT_LIST_HEAD(&object->tree);\r\nRB_CLEAR_NODE(&object->node);\r\nWARN_ON(oclass->engine && !object->engine);\r\n}\r\nint\r\nnvkm_object_new_(const struct nvkm_object_func *func,\r\nconst struct nvkm_oclass *oclass, void *data, u32 size,\r\nstruct nvkm_object **pobject)\r\n{\r\nif (size == 0) {\r\nif (!(*pobject = kzalloc(sizeof(**pobject), GFP_KERNEL)))\r\nreturn -ENOMEM;\r\nnvkm_object_ctor(func, oclass, *pobject);\r\nreturn 0;\r\n}\r\nreturn -ENOSYS;\r\n}\r\nint\r\nnvkm_object_new(const struct nvkm_oclass *oclass, void *data, u32 size,\r\nstruct nvkm_object **pobject)\r\n{\r\nconst struct nvkm_object_func *func =\r\noclass->base.func ? oclass->base.func : &nvkm_object_func;\r\nreturn nvkm_object_new_(func, oclass, data, size, pobject);\r\n}

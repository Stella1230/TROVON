static void pdc_console_write(struct console *co, const char *s, unsigned count)\r\n{\r\nint i = 0;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_console_lock, flags);\r\ndo {\r\ni += pdc_iodc_print(s + i, count - i);\r\n} while (i < count);\r\nspin_unlock_irqrestore(&pdc_console_lock, flags);\r\n}\r\nint pdc_console_poll_key(struct console *co)\r\n{\r\nint c;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdc_console_lock, flags);\r\nc = pdc_iodc_getc();\r\nspin_unlock_irqrestore(&pdc_console_lock, flags);\r\nreturn c;\r\n}\r\nstatic int pdc_console_setup(struct console *co, char *options)\r\n{\r\nreturn 0;\r\n}\r\nstatic int pdc_console_tty_open(struct tty_struct *tty, struct file *filp)\r\n{\r\ntty_port_tty_set(&tty_port, tty);\r\nmod_timer(&pdc_console_timer, jiffies + PDC_CONS_POLL_DELAY);\r\nreturn 0;\r\n}\r\nstatic void pdc_console_tty_close(struct tty_struct *tty, struct file *filp)\r\n{\r\nif (tty->count == 1) {\r\ndel_timer_sync(&pdc_console_timer);\r\ntty_port_tty_set(&tty_port, NULL);\r\n}\r\n}\r\nstatic int pdc_console_tty_write(struct tty_struct *tty, const unsigned char *buf, int count)\r\n{\r\npdc_console_write(NULL, buf, count);\r\nreturn count;\r\n}\r\nstatic int pdc_console_tty_write_room(struct tty_struct *tty)\r\n{\r\nreturn 32768;\r\n}\r\nstatic int pdc_console_tty_chars_in_buffer(struct tty_struct *tty)\r\n{\r\nreturn 0;\r\n}\r\nstatic void pdc_console_poll(unsigned long unused)\r\n{\r\nint data, count = 0;\r\nwhile (1) {\r\ndata = pdc_console_poll_key(NULL);\r\nif (data == -1)\r\nbreak;\r\ntty_insert_flip_char(&tty_port, data & 0xFF, TTY_NORMAL);\r\ncount ++;\r\n}\r\nif (count)\r\ntty_flip_buffer_push(&tty_port);\r\nif (pdc_cons.flags & CON_ENABLED)\r\nmod_timer(&pdc_console_timer, jiffies + PDC_CONS_POLL_DELAY);\r\n}\r\nstatic int __init pdc_console_tty_driver_init(void)\r\n{\r\nint err;\r\nstruct console *tmp;\r\nconsole_lock();\r\nfor_each_console(tmp)\r\nif (tmp == &pdc_cons)\r\nbreak;\r\nconsole_unlock();\r\nif (!tmp) {\r\nprintk(KERN_INFO "PDC console driver not registered anymore, not creating %s\n", pdc_cons.name);\r\nreturn -ENODEV;\r\n}\r\nprintk(KERN_INFO "The PDC console driver is still registered, removing CON_BOOT flag\n");\r\npdc_cons.flags &= ~CON_BOOT;\r\npdc_console_tty_driver = alloc_tty_driver(1);\r\nif (!pdc_console_tty_driver)\r\nreturn -ENOMEM;\r\ntty_port_init(&tty_port);\r\npdc_console_tty_driver->driver_name = "pdc_cons";\r\npdc_console_tty_driver->name = "ttyB";\r\npdc_console_tty_driver->major = MUX_MAJOR;\r\npdc_console_tty_driver->minor_start = 0;\r\npdc_console_tty_driver->type = TTY_DRIVER_TYPE_SYSTEM;\r\npdc_console_tty_driver->init_termios = tty_std_termios;\r\npdc_console_tty_driver->flags = TTY_DRIVER_REAL_RAW |\r\nTTY_DRIVER_RESET_TERMIOS;\r\ntty_set_operations(pdc_console_tty_driver, &pdc_console_tty_ops);\r\ntty_port_link_device(&tty_port, pdc_console_tty_driver, 0);\r\nerr = tty_register_driver(pdc_console_tty_driver);\r\nif (err) {\r\nprintk(KERN_ERR "Unable to register the PDC console TTY driver\n");\r\ntty_port_destroy(&tty_port);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic struct tty_driver * pdc_console_device (struct console *c, int *index)\r\n{\r\n*index = c->index;\r\nreturn pdc_console_tty_driver;\r\n}\r\nstatic void pdc_console_init_force(void)\r\n{\r\nif (pdc_console_initialized)\r\nreturn;\r\n++pdc_console_initialized;\r\nif (PAGE0->mem_cons.cl_class == CL_DUPLEX)\r\nmemcpy(&PAGE0->mem_kbd, &PAGE0->mem_cons, sizeof(PAGE0->mem_cons));\r\nregister_console(&pdc_cons);\r\n}\r\nvoid __init pdc_console_init(void)\r\n{\r\n#if defined(EARLY_BOOTUP_DEBUG) || defined(CONFIG_PDC_CONSOLE)\r\npdc_console_init_force();\r\n#endif\r\n#ifdef EARLY_BOOTUP_DEBUG\r\nprintk(KERN_INFO "Initialized PDC Console for debugging.\n");\r\n#endif\r\n}\r\nvoid pdc_console_restart(void)\r\n{\r\nstruct console *console;\r\nif (pdc_console_initialized)\r\nreturn;\r\nif (console_drivers != NULL)\r\npdc_cons.flags &= ~CON_PRINTBUFFER;\r\nwhile ((console = console_drivers) != NULL)\r\nunregister_console(console_drivers);\r\npdc_console_init_force();\r\n}

static s32 int_cos(u32 x)\r\n{\r\nu32 t2, t4, t6, t8;\r\ns32 ret;\r\nu16 period = x / INT_PI;\r\nif (period % 2)\r\nreturn -int_cos(x - INT_PI);\r\nx = x % INT_PI;\r\nif (x > INT_PI/2)\r\nreturn -int_cos(INT_PI/2 - (x % (INT_PI/2)));\r\nt2 = x*x/32768/2;\r\nt4 = t2*x/32768*x/32768/3/4;\r\nt6 = t4*x/32768*x/32768/5/6;\r\nt8 = t6*x/32768*x/32768/7/8;\r\nret = 32768-t2+t4-t6+t8;\r\nreturn ret;\r\n}\r\nstatic u32 int_goertzel(s16 x[], u32 N, u32 freq)\r\n{\r\ns32 s_prev = 0;\r\ns32 s_prev2 = 0;\r\ns32 coeff = 2*int_cos(freq);\r\nu32 i;\r\nu64 tmp;\r\nu32 divisor;\r\nfor (i = 0; i < N; i++) {\r\ns32 s = x[i] + ((s64)coeff*s_prev/32768) - s_prev2;\r\ns_prev2 = s_prev;\r\ns_prev = s;\r\n}\r\ntmp = (s64)s_prev2 * s_prev2 + (s64)s_prev * s_prev -\r\n(s64)coeff * s_prev2 * s_prev / 32768;\r\ndivisor = N * N;\r\ndo_div(tmp, divisor);\r\nreturn (u32) tmp;\r\n}\r\nstatic u32 freq_magnitude(s16 x[], u32 N, u32 freq)\r\n{\r\nu32 sum = int_goertzel(x, N, freq);\r\nreturn (u32)int_sqrt(sum);\r\n}\r\nstatic u32 noise_magnitude(s16 x[], u32 N, u32 freq_start, u32 freq_end)\r\n{\r\nint i;\r\nu32 sum = 0;\r\nu32 freq_step;\r\nint samples = 5;\r\nif (N > 192) {\r\nx += (N-192);\r\nN = 192;\r\n}\r\nfreq_step = (freq_end - freq_start) / (samples - 1);\r\nfor (i = 0; i < samples; i++) {\r\nsum += int_goertzel(x, N, freq_start);\r\nfreq_start += freq_step;\r\n}\r\nreturn (u32)int_sqrt(sum / samples);\r\n}\r\nstatic s32 detect_a2_a2m_eiaj(struct cx88_core *core, s16 x[], u32 N)\r\n{\r\ns32 carrier, stereo, dual, noise;\r\ns32 carrier_freq, stereo_freq, dual_freq;\r\ns32 ret;\r\nswitch (core->tvaudio) {\r\ncase WW_BG:\r\ncase WW_DK:\r\ncarrier_freq = FREQ_A2_CARRIER;\r\nstereo_freq = FREQ_A2_STEREO;\r\ndual_freq = FREQ_A2_DUAL;\r\nbreak;\r\ncase WW_M:\r\ncarrier_freq = FREQ_A2M_CARRIER;\r\nstereo_freq = FREQ_A2M_STEREO;\r\ndual_freq = FREQ_A2M_DUAL;\r\nbreak;\r\ncase WW_EIAJ:\r\ncarrier_freq = FREQ_EIAJ_CARRIER;\r\nstereo_freq = FREQ_EIAJ_STEREO;\r\ndual_freq = FREQ_EIAJ_DUAL;\r\nbreak;\r\ndefault:\r\nprintk(KERN_WARNING "%s/0: unsupported audio mode %d for %s\n",\r\ncore->name, core->tvaudio, __func__);\r\nreturn UNSET;\r\n}\r\ncarrier = freq_magnitude(x, N, carrier_freq);\r\nstereo = freq_magnitude(x, N, stereo_freq);\r\ndual = freq_magnitude(x, N, dual_freq);\r\nnoise = noise_magnitude(x, N, FREQ_NOISE_START, FREQ_NOISE_END);\r\ndprintk(1, "detect a2/a2m/eiaj: carrier=%d, stereo=%d, dual=%d, "\r\n"noise=%d\n", carrier, stereo, dual, noise);\r\nif (stereo > dual)\r\nret = V4L2_TUNER_SUB_STEREO;\r\nelse\r\nret = V4L2_TUNER_SUB_LANG1 | V4L2_TUNER_SUB_LANG2;\r\nif (core->tvaudio == WW_EIAJ) {\r\nif ((carrier > max(stereo, dual)*2) &&\r\n(carrier < max(stereo, dual)*6) &&\r\n(carrier > 20 && carrier < 200) &&\r\n(max(stereo, dual) > min(stereo, dual))) {\r\nreturn ret;\r\n}\r\n} else {\r\nif ((carrier > max(stereo, dual)*2) &&\r\n(carrier < max(stereo, dual)*8) &&\r\n(carrier > 20 && carrier < 200) &&\r\n(noise < 10) &&\r\n(max(stereo, dual) > min(stereo, dual)*2)) {\r\nreturn ret;\r\n}\r\n}\r\nreturn V4L2_TUNER_SUB_MONO;\r\n}\r\nstatic s32 detect_btsc(struct cx88_core *core, s16 x[], u32 N)\r\n{\r\ns32 sap_ref = freq_magnitude(x, N, FREQ_BTSC_SAP_REF);\r\ns32 sap = freq_magnitude(x, N, FREQ_BTSC_SAP);\r\ns32 dual_ref = freq_magnitude(x, N, FREQ_BTSC_DUAL_REF);\r\ns32 dual = freq_magnitude(x, N, FREQ_BTSC_DUAL);\r\ndprintk(1, "detect btsc: dual_ref=%d, dual=%d, sap_ref=%d, sap=%d"\r\n"\n", dual_ref, dual, sap_ref, sap);\r\nreturn UNSET;\r\n}\r\nstatic s16 *read_rds_samples(struct cx88_core *core, u32 *N)\r\n{\r\nconst struct sram_channel *srch = &cx88_sram_channels[SRAM_CH27];\r\ns16 *samples;\r\nunsigned int i;\r\nunsigned int bpl = srch->fifo_size/AUD_RDS_LINES;\r\nunsigned int spl = bpl/4;\r\nunsigned int sample_count = spl*(AUD_RDS_LINES-1);\r\nu32 current_address = cx_read(srch->ptr1_reg);\r\nu32 offset = (current_address - srch->fifo_start + bpl);\r\ndprintk(1, "read RDS samples: current_address=%08x (offset=%08x), "\r\n"sample_count=%d, aud_intstat=%08x\n", current_address,\r\ncurrent_address - srch->fifo_start, sample_count,\r\ncx_read(MO_AUD_INTSTAT));\r\nsamples = kmalloc(sizeof(s16)*sample_count, GFP_KERNEL);\r\nif (!samples)\r\nreturn NULL;\r\n*N = sample_count;\r\nfor (i = 0; i < sample_count; i++) {\r\noffset = offset % (AUD_RDS_LINES*bpl);\r\nsamples[i] = cx_read(srch->fifo_start + offset);\r\noffset += 4;\r\n}\r\nif (dsp_debug >= 2) {\r\ndprintk(2, "RDS samples dump: ");\r\nfor (i = 0; i < sample_count; i++)\r\nprintk("%hd ", samples[i]);\r\nprintk(".\n");\r\n}\r\nreturn samples;\r\n}\r\ns32 cx88_dsp_detect_stereo_sap(struct cx88_core *core)\r\n{\r\ns16 *samples;\r\nu32 N = 0;\r\ns32 ret = UNSET;\r\nif (!(cx_read(MO_AUD_DMACNTRL) & 0x04))\r\nreturn ret;\r\nif (!(cx_read(AUD_CTL) & EN_FMRADIO_EN_RDS))\r\nreturn ret;\r\nif (time_before(jiffies, core->last_change + msecs_to_jiffies(500)))\r\nreturn ret;\r\nsamples = read_rds_samples(core, &N);\r\nif (!samples)\r\nreturn ret;\r\nswitch (core->tvaudio) {\r\ncase WW_BG:\r\ncase WW_DK:\r\ncase WW_EIAJ:\r\ncase WW_M:\r\nret = detect_a2_a2m_eiaj(core, samples, N);\r\nbreak;\r\ncase WW_BTSC:\r\nret = detect_btsc(core, samples, N);\r\nbreak;\r\ncase WW_NONE:\r\ncase WW_I:\r\ncase WW_L:\r\ncase WW_I2SPT:\r\ncase WW_FM:\r\ncase WW_I2SADC:\r\nbreak;\r\n}\r\nkfree(samples);\r\nif (UNSET != ret)\r\ndprintk(1, "stereo/sap detection result:%s%s%s\n",\r\n(ret & V4L2_TUNER_SUB_MONO) ? " mono" : "",\r\n(ret & V4L2_TUNER_SUB_STEREO) ? " stereo" : "",\r\n(ret & V4L2_TUNER_SUB_LANG2) ? " dual" : "");\r\nreturn ret;\r\n}

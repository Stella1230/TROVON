void ucf64_raise_sigfpe(unsigned int sicode, struct pt_regs *regs)\r\n{\r\nsiginfo_t info;\r\nmemset(&info, 0, sizeof(info));\r\ninfo.si_signo = SIGFPE;\r\ninfo.si_code = sicode;\r\ninfo.si_addr = (void __user *)(instruction_pointer(regs) - 4);\r\ncurrent->thread.error_code = 0;\r\ncurrent->thread.trap_no = 6;\r\nsend_sig_info(SIGFPE, &info, current);\r\n}\r\nvoid ucf64_exchandler(u32 inst, u32 fpexc, struct pt_regs *regs)\r\n{\r\nu32 tmp = fpexc;\r\nu32 exc = F64_EXCEPTION_ERROR & fpexc;\r\npr_debug("UniCore-F64: instruction %08x fpscr %08x\n",\r\ninst, fpexc);\r\nif (exc & FPSCR_CMPINSTR_BIT) {\r\nif (exc & FPSCR_CON)\r\ntmp |= FPSCR_CON;\r\nelse\r\ntmp &= ~(FPSCR_CON);\r\nexc &= ~(FPSCR_CMPINSTR_BIT | FPSCR_CON);\r\n} else {\r\npr_debug("UniCore-F64 Error: unhandled exceptions\n");\r\npr_debug("UniCore-F64 FPSCR 0x%08x INST 0x%08x\n",\r\ncff(FPSCR), inst);\r\nucf64_raise_sigfpe(0, regs);\r\nreturn;\r\n}\r\ntmp &= ~(FPSCR_TRAP | FPSCR_IOS | FPSCR_OFS | FPSCR_UFS |\r\nFPSCR_IXS | FPSCR_HIS | FPSCR_IOC | FPSCR_OFC |\r\nFPSCR_UFC | FPSCR_IXC | FPSCR_HIC);\r\ntmp |= exc;\r\nctf(FPSCR, tmp);\r\n}\r\nstatic int __init ucf64_init(void)\r\n{\r\nctf(FPSCR, 0x0);\r\nprintk(KERN_INFO "Enable UniCore-F64 support.\n");\r\nreturn 0;\r\n}

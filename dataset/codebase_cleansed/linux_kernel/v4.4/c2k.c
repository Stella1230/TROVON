static void __init c2k_setup_arch(void)\r\n{\r\nstruct device_node *np;\r\nphys_addr_t paddr;\r\nconst unsigned int *reg;\r\nnp = of_find_compatible_node(NULL, NULL, "marvell,mv64360-mpp");\r\nreg = of_get_property(np, "reg", NULL);\r\npaddr = of_translate_address(np, reg);\r\nof_node_put(np);\r\nmv64x60_mpp_reg_base = ioremap(paddr, reg[1]);\r\nnp = of_find_compatible_node(NULL, NULL, "marvell,mv64360-gpp");\r\nreg = of_get_property(np, "reg", NULL);\r\npaddr = of_translate_address(np, reg);\r\nof_node_put(np);\r\nmv64x60_gpp_reg_base = ioremap(paddr, reg[1]);\r\n#ifdef CONFIG_PCI\r\nmv64x60_pci_init();\r\n#endif\r\n}\r\nstatic void c2k_reset_board(void)\r\n{\r\nu32 temp;\r\nlocal_irq_disable();\r\ntemp = in_le32(mv64x60_mpp_reg_base + MV64x60_MPP_CNTL_0);\r\ntemp &= 0xFFFF0FFF;\r\nout_le32(mv64x60_mpp_reg_base + MV64x60_MPP_CNTL_0, temp);\r\ntemp = in_le32(mv64x60_gpp_reg_base + MV64x60_GPP_LEVEL_CNTL);\r\ntemp |= 0x00000004;\r\nout_le32(mv64x60_gpp_reg_base + MV64x60_GPP_LEVEL_CNTL, temp);\r\ntemp = in_le32(mv64x60_gpp_reg_base + MV64x60_GPP_IO_CNTL);\r\ntemp |= 0x00000004;\r\nout_le32(mv64x60_gpp_reg_base + MV64x60_GPP_IO_CNTL, temp);\r\ntemp = in_le32(mv64x60_mpp_reg_base + MV64x60_MPP_CNTL_2);\r\ntemp &= 0xFFFF0FFF;\r\nout_le32(mv64x60_mpp_reg_base + MV64x60_MPP_CNTL_2, temp);\r\ntemp = in_le32(mv64x60_gpp_reg_base + MV64x60_GPP_LEVEL_CNTL);\r\ntemp |= 0x00080000;\r\nout_le32(mv64x60_gpp_reg_base + MV64x60_GPP_LEVEL_CNTL, temp);\r\ntemp = in_le32(mv64x60_gpp_reg_base + MV64x60_GPP_IO_CNTL);\r\ntemp |= 0x00080000;\r\nout_le32(mv64x60_gpp_reg_base + MV64x60_GPP_IO_CNTL, temp);\r\nout_le32(mv64x60_gpp_reg_base + MV64x60_GPP_VALUE_SET, 0x00080004);\r\n}\r\nstatic void c2k_restart(char *cmd)\r\n{\r\nc2k_reset_board();\r\nmsleep(100);\r\npanic("restart failed\n");\r\n}\r\nvoid c2k_show_cpuinfo(struct seq_file *m)\r\n{\r\nseq_printf(m, "Vendor\t\t: GEFanuc\n");\r\nseq_printf(m, "coherency\t: %s\n", COHERENCY_SETTING);\r\n}\r\nstatic int __init c2k_probe(void)\r\n{\r\nunsigned long root = of_get_flat_dt_root();\r\nif (!of_flat_dt_is_compatible(root, "GEFanuc,C2K"))\r\nreturn 0;\r\nprintk(KERN_INFO "Detected a GEFanuc C2K board\n");\r\n_set_L2CR(0);\r\n_set_L2CR(L2CR_L2E | L2CR_L2PE | L2CR_L2I);\r\nreturn 1;\r\n}

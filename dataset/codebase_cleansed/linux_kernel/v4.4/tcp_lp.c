static void tcp_lp_init(struct sock *sk)\r\n{\r\nstruct lp *lp = inet_csk_ca(sk);\r\nlp->flag = 0;\r\nlp->sowd = 0;\r\nlp->owd_min = 0xffffffff;\r\nlp->owd_max = 0;\r\nlp->owd_max_rsv = 0;\r\nlp->remote_hz = 0;\r\nlp->remote_ref_time = 0;\r\nlp->local_ref_time = 0;\r\nlp->last_drop = 0;\r\nlp->inference = 0;\r\n}\r\nstatic void tcp_lp_cong_avoid(struct sock *sk, u32 ack, u32 acked)\r\n{\r\nstruct lp *lp = inet_csk_ca(sk);\r\nif (!(lp->flag & LP_WITHIN_INF))\r\ntcp_reno_cong_avoid(sk, ack, acked);\r\n}\r\nstatic u32 tcp_lp_remote_hz_estimator(struct sock *sk)\r\n{\r\nstruct tcp_sock *tp = tcp_sk(sk);\r\nstruct lp *lp = inet_csk_ca(sk);\r\ns64 rhz = lp->remote_hz << 6;\r\ns64 m = 0;\r\nif (lp->remote_ref_time == 0 || lp->local_ref_time == 0)\r\ngoto out;\r\nif (tp->rx_opt.rcv_tsval == lp->remote_ref_time ||\r\ntp->rx_opt.rcv_tsecr == lp->local_ref_time)\r\ngoto out;\r\nm = HZ * (tp->rx_opt.rcv_tsval -\r\nlp->remote_ref_time) / (tp->rx_opt.rcv_tsecr -\r\nlp->local_ref_time);\r\nif (m < 0)\r\nm = -m;\r\nif (rhz > 0) {\r\nm -= rhz >> 6;\r\nrhz += m;\r\n} else\r\nrhz = m << 6;\r\nout:\r\nif ((rhz >> 6) > 0)\r\nlp->flag |= LP_VALID_RHZ;\r\nelse\r\nlp->flag &= ~LP_VALID_RHZ;\r\nlp->remote_ref_time = tp->rx_opt.rcv_tsval;\r\nlp->local_ref_time = tp->rx_opt.rcv_tsecr;\r\nreturn rhz >> 6;\r\n}\r\nstatic u32 tcp_lp_owd_calculator(struct sock *sk)\r\n{\r\nstruct tcp_sock *tp = tcp_sk(sk);\r\nstruct lp *lp = inet_csk_ca(sk);\r\ns64 owd = 0;\r\nlp->remote_hz = tcp_lp_remote_hz_estimator(sk);\r\nif (lp->flag & LP_VALID_RHZ) {\r\nowd =\r\ntp->rx_opt.rcv_tsval * (LP_RESOL / lp->remote_hz) -\r\ntp->rx_opt.rcv_tsecr * (LP_RESOL / HZ);\r\nif (owd < 0)\r\nowd = -owd;\r\n}\r\nif (owd > 0)\r\nlp->flag |= LP_VALID_OWD;\r\nelse\r\nlp->flag &= ~LP_VALID_OWD;\r\nreturn owd;\r\n}\r\nstatic void tcp_lp_rtt_sample(struct sock *sk, u32 rtt)\r\n{\r\nstruct lp *lp = inet_csk_ca(sk);\r\ns64 mowd = tcp_lp_owd_calculator(sk);\r\nif (!(lp->flag & LP_VALID_RHZ) || !(lp->flag & LP_VALID_OWD))\r\nreturn;\r\nif (mowd < lp->owd_min)\r\nlp->owd_min = mowd;\r\nif (mowd > lp->owd_max) {\r\nif (mowd > lp->owd_max_rsv) {\r\nif (lp->owd_max_rsv == 0)\r\nlp->owd_max = mowd;\r\nelse\r\nlp->owd_max = lp->owd_max_rsv;\r\nlp->owd_max_rsv = mowd;\r\n} else\r\nlp->owd_max = mowd;\r\n}\r\nif (lp->sowd != 0) {\r\nmowd -= lp->sowd >> 3;\r\nlp->sowd += mowd;\r\n} else\r\nlp->sowd = mowd << 3;\r\n}\r\nstatic void tcp_lp_pkts_acked(struct sock *sk, u32 num_acked, s32 rtt_us)\r\n{\r\nstruct tcp_sock *tp = tcp_sk(sk);\r\nstruct lp *lp = inet_csk_ca(sk);\r\nif (rtt_us > 0)\r\ntcp_lp_rtt_sample(sk, rtt_us);\r\nif (tcp_time_stamp > tp->rx_opt.rcv_tsecr)\r\nlp->inference = 3 * (tcp_time_stamp - tp->rx_opt.rcv_tsecr);\r\nif (lp->last_drop && (tcp_time_stamp - lp->last_drop < lp->inference))\r\nlp->flag |= LP_WITHIN_INF;\r\nelse\r\nlp->flag &= ~LP_WITHIN_INF;\r\nif (lp->sowd >> 3 <\r\nlp->owd_min + 15 * (lp->owd_max - lp->owd_min) / 100)\r\nlp->flag |= LP_WITHIN_THR;\r\nelse\r\nlp->flag &= ~LP_WITHIN_THR;\r\npr_debug("TCP-LP: %05o|%5u|%5u|%15u|%15u|%15u\n", lp->flag,\r\ntp->snd_cwnd, lp->remote_hz, lp->owd_min, lp->owd_max,\r\nlp->sowd >> 3);\r\nif (lp->flag & LP_WITHIN_THR)\r\nreturn;\r\nlp->owd_min = lp->sowd >> 3;\r\nlp->owd_max = lp->sowd >> 2;\r\nlp->owd_max_rsv = lp->sowd >> 2;\r\nif (lp->flag & LP_WITHIN_INF)\r\ntp->snd_cwnd = 1U;\r\nelse\r\ntp->snd_cwnd = max(tp->snd_cwnd >> 1U, 1U);\r\nlp->last_drop = tcp_time_stamp;\r\n}\r\nstatic int __init tcp_lp_register(void)\r\n{\r\nBUILD_BUG_ON(sizeof(struct lp) > ICSK_CA_PRIV_SIZE);\r\nreturn tcp_register_congestion_control(&tcp_lp);\r\n}\r\nstatic void __exit tcp_lp_unregister(void)\r\n{\r\ntcp_unregister_congestion_control(&tcp_lp);\r\n}

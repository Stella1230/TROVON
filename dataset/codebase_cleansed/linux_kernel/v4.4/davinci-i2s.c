static inline void davinci_mcbsp_write_reg(struct davinci_mcbsp_dev *dev,\r\nint reg, u32 val)\r\n{\r\n__raw_writel(val, dev->base + reg);\r\n}\r\nstatic inline u32 davinci_mcbsp_read_reg(struct davinci_mcbsp_dev *dev, int reg)\r\n{\r\nreturn __raw_readl(dev->base + reg);\r\n}\r\nstatic void toggle_clock(struct davinci_mcbsp_dev *dev, int playback)\r\n{\r\nu32 m = playback ? DAVINCI_MCBSP_PCR_CLKXP : DAVINCI_MCBSP_PCR_CLKRP;\r\ndavinci_mcbsp_write_reg(dev, DAVINCI_MCBSP_PCR_REG, dev->pcr ^ m);\r\ndavinci_mcbsp_write_reg(dev, DAVINCI_MCBSP_PCR_REG, dev->pcr);\r\n}\r\nstatic void davinci_mcbsp_start(struct davinci_mcbsp_dev *dev,\r\nstruct snd_pcm_substream *substream)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_platform *platform = rtd->platform;\r\nint playback = (substream->stream == SNDRV_PCM_STREAM_PLAYBACK);\r\nu32 spcr;\r\nu32 mask = playback ? DAVINCI_MCBSP_SPCR_XRST : DAVINCI_MCBSP_SPCR_RRST;\r\nspcr = davinci_mcbsp_read_reg(dev, DAVINCI_MCBSP_SPCR_REG);\r\nif (spcr & mask) {\r\ndavinci_mcbsp_write_reg(dev, DAVINCI_MCBSP_SPCR_REG,\r\nspcr & ~mask);\r\ntoggle_clock(dev, playback);\r\n}\r\nif (dev->pcr & (DAVINCI_MCBSP_PCR_FSXM | DAVINCI_MCBSP_PCR_FSRM |\r\nDAVINCI_MCBSP_PCR_CLKXM | DAVINCI_MCBSP_PCR_CLKRM)) {\r\nspcr |= DAVINCI_MCBSP_SPCR_GRST;\r\ndavinci_mcbsp_write_reg(dev, DAVINCI_MCBSP_SPCR_REG, spcr);\r\n}\r\nif (playback) {\r\nif (platform->driver->ops->trigger) {\r\nint ret = platform->driver->ops->trigger(substream,\r\nSNDRV_PCM_TRIGGER_STOP);\r\nif (ret < 0)\r\nprintk(KERN_DEBUG "Playback DMA stop failed\n");\r\n}\r\nspcr = davinci_mcbsp_read_reg(dev, DAVINCI_MCBSP_SPCR_REG);\r\nspcr |= DAVINCI_MCBSP_SPCR_XRST;\r\ndavinci_mcbsp_write_reg(dev, DAVINCI_MCBSP_SPCR_REG, spcr);\r\nudelay(100);\r\nspcr = davinci_mcbsp_read_reg(dev, DAVINCI_MCBSP_SPCR_REG);\r\nspcr &= ~DAVINCI_MCBSP_SPCR_XRST;\r\ndavinci_mcbsp_write_reg(dev, DAVINCI_MCBSP_SPCR_REG, spcr);\r\ntoggle_clock(dev, playback);\r\nif (platform->driver->ops->trigger) {\r\nint ret = platform->driver->ops->trigger(substream,\r\nSNDRV_PCM_TRIGGER_START);\r\nif (ret < 0)\r\nprintk(KERN_DEBUG "Playback DMA start failed\n");\r\n}\r\n}\r\nspcr = davinci_mcbsp_read_reg(dev, DAVINCI_MCBSP_SPCR_REG);\r\nspcr |= mask;\r\nif (dev->pcr & (DAVINCI_MCBSP_PCR_FSXM | DAVINCI_MCBSP_PCR_FSRM)) {\r\nspcr |= DAVINCI_MCBSP_SPCR_FRST;\r\n}\r\ndavinci_mcbsp_write_reg(dev, DAVINCI_MCBSP_SPCR_REG, spcr);\r\n}\r\nstatic void davinci_mcbsp_stop(struct davinci_mcbsp_dev *dev, int playback)\r\n{\r\nu32 spcr;\r\nspcr = davinci_mcbsp_read_reg(dev, DAVINCI_MCBSP_SPCR_REG);\r\nspcr &= ~(DAVINCI_MCBSP_SPCR_GRST | DAVINCI_MCBSP_SPCR_FRST);\r\nspcr &= playback ? ~DAVINCI_MCBSP_SPCR_XRST : ~DAVINCI_MCBSP_SPCR_RRST;\r\ndavinci_mcbsp_write_reg(dev, DAVINCI_MCBSP_SPCR_REG, spcr);\r\ntoggle_clock(dev, playback);\r\n}\r\nstatic int davinci_i2s_set_dai_fmt(struct snd_soc_dai *cpu_dai,\r\nunsigned int fmt)\r\n{\r\nstruct davinci_mcbsp_dev *dev = snd_soc_dai_get_drvdata(cpu_dai);\r\nunsigned int pcr;\r\nunsigned int srgr;\r\nbool inv_fs = false;\r\nsrgr = DAVINCI_MCBSP_SRGR_FSGM |\r\nDAVINCI_MCBSP_SRGR_FPER(DEFAULT_BITPERSAMPLE * 2 - 1) |\r\nDAVINCI_MCBSP_SRGR_FWID(DEFAULT_BITPERSAMPLE - 1);\r\ndev->fmt = fmt;\r\nswitch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {\r\ncase SND_SOC_DAIFMT_CBS_CFS:\r\npcr = DAVINCI_MCBSP_PCR_FSXM |\r\nDAVINCI_MCBSP_PCR_FSRM |\r\nDAVINCI_MCBSP_PCR_CLKXM |\r\nDAVINCI_MCBSP_PCR_CLKRM;\r\nbreak;\r\ncase SND_SOC_DAIFMT_CBM_CFS:\r\npcr = DAVINCI_MCBSP_PCR_FSRM | DAVINCI_MCBSP_PCR_FSXM;\r\nswitch (dev->clk_input_pin) {\r\ncase MCBSP_CLKS:\r\npcr |= DAVINCI_MCBSP_PCR_CLKXM |\r\nDAVINCI_MCBSP_PCR_CLKRM;\r\nbreak;\r\ncase MCBSP_CLKR:\r\npcr |= DAVINCI_MCBSP_PCR_SCLKME;\r\nbreak;\r\ndefault:\r\ndev_err(dev->dev, "bad clk_input_pin\n");\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ncase SND_SOC_DAIFMT_CBM_CFM:\r\npcr = 0;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "%s:bad master\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\r\ncase SND_SOC_DAIFMT_I2S:\r\ninv_fs = true;\r\ncase SND_SOC_DAIFMT_DSP_A:\r\ndev->mode = MOD_DSP_A;\r\nbreak;\r\ncase SND_SOC_DAIFMT_DSP_B:\r\ndev->mode = MOD_DSP_B;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "%s:bad format\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nswitch (fmt & SND_SOC_DAIFMT_INV_MASK) {\r\ncase SND_SOC_DAIFMT_NB_NF:\r\npcr |= (DAVINCI_MCBSP_PCR_CLKXP | DAVINCI_MCBSP_PCR_CLKRP);\r\nbreak;\r\ncase SND_SOC_DAIFMT_IB_IF:\r\npcr |= (DAVINCI_MCBSP_PCR_FSXP | DAVINCI_MCBSP_PCR_FSRP);\r\nbreak;\r\ncase SND_SOC_DAIFMT_NB_IF:\r\npcr |= (DAVINCI_MCBSP_PCR_CLKXP | DAVINCI_MCBSP_PCR_CLKRP |\r\nDAVINCI_MCBSP_PCR_FSXP | DAVINCI_MCBSP_PCR_FSRP);\r\nbreak;\r\ncase SND_SOC_DAIFMT_IB_NF:\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (inv_fs == true)\r\npcr ^= (DAVINCI_MCBSP_PCR_FSXP | DAVINCI_MCBSP_PCR_FSRP);\r\ndavinci_mcbsp_write_reg(dev, DAVINCI_MCBSP_SRGR_REG, srgr);\r\ndev->pcr = pcr;\r\ndavinci_mcbsp_write_reg(dev, DAVINCI_MCBSP_PCR_REG, pcr);\r\nreturn 0;\r\n}\r\nstatic int davinci_i2s_dai_set_clkdiv(struct snd_soc_dai *cpu_dai,\r\nint div_id, int div)\r\n{\r\nstruct davinci_mcbsp_dev *dev = snd_soc_dai_get_drvdata(cpu_dai);\r\nif (div_id != DAVINCI_MCBSP_CLKGDV)\r\nreturn -ENODEV;\r\ndev->clk_div = div;\r\nreturn 0;\r\n}\r\nstatic int davinci_i2s_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct davinci_mcbsp_dev *dev = snd_soc_dai_get_drvdata(dai);\r\nstruct snd_interval *i = NULL;\r\nint mcbsp_word_length, master;\r\nunsigned int rcr, xcr, srgr, clk_div, freq, framesize;\r\nu32 spcr;\r\nsnd_pcm_format_t fmt;\r\nunsigned element_cnt = 1;\r\nspcr = davinci_mcbsp_read_reg(dev, DAVINCI_MCBSP_SPCR_REG);\r\nif (substream->stream == SNDRV_PCM_STREAM_CAPTURE) {\r\nspcr |= DAVINCI_MCBSP_SPCR_RINTM(3) | DAVINCI_MCBSP_SPCR_FREE;\r\ndavinci_mcbsp_write_reg(dev, DAVINCI_MCBSP_SPCR_REG, spcr);\r\n} else {\r\nspcr |= DAVINCI_MCBSP_SPCR_XINTM(3) | DAVINCI_MCBSP_SPCR_FREE;\r\ndavinci_mcbsp_write_reg(dev, DAVINCI_MCBSP_SPCR_REG, spcr);\r\n}\r\nmaster = dev->fmt & SND_SOC_DAIFMT_MASTER_MASK;\r\nfmt = params_format(params);\r\nmcbsp_word_length = asp_word_length[fmt];\r\nswitch (master) {\r\ncase SND_SOC_DAIFMT_CBS_CFS:\r\nfreq = clk_get_rate(dev->clk);\r\nsrgr = DAVINCI_MCBSP_SRGR_FSGM |\r\nDAVINCI_MCBSP_SRGR_CLKSM;\r\nsrgr |= DAVINCI_MCBSP_SRGR_FWID(mcbsp_word_length *\r\n8 - 1);\r\nif (dev->i2s_accurate_sck) {\r\nclk_div = 256;\r\ndo {\r\nframesize = (freq / (--clk_div)) /\r\nparams->rate_num *\r\nparams->rate_den;\r\n} while (((framesize < 33) || (framesize > 4095)) &&\r\n(clk_div));\r\nclk_div--;\r\nsrgr |= DAVINCI_MCBSP_SRGR_FPER(framesize - 1);\r\n} else {\r\nclk_div = freq / (mcbsp_word_length * 16) /\r\nparams->rate_num * params->rate_den;\r\nsrgr |= DAVINCI_MCBSP_SRGR_FPER(mcbsp_word_length *\r\n16 - 1);\r\n}\r\nclk_div &= 0xFF;\r\nsrgr |= clk_div;\r\nbreak;\r\ncase SND_SOC_DAIFMT_CBM_CFS:\r\nsrgr = DAVINCI_MCBSP_SRGR_FSGM;\r\nclk_div = dev->clk_div - 1;\r\nsrgr |= DAVINCI_MCBSP_SRGR_FWID(mcbsp_word_length * 8 - 1);\r\nsrgr |= DAVINCI_MCBSP_SRGR_FPER(mcbsp_word_length * 16 - 1);\r\nclk_div &= 0xFF;\r\nsrgr |= clk_div;\r\nbreak;\r\ncase SND_SOC_DAIFMT_CBM_CFM:\r\ni = hw_param_interval(params, SNDRV_PCM_HW_PARAM_SAMPLE_BITS);\r\nsrgr = DAVINCI_MCBSP_SRGR_FSGM;\r\nsrgr |= DAVINCI_MCBSP_SRGR_FWID(snd_interval_value(i) - 1);\r\npr_debug("%s - %d FWID set: re-read srgr = %X\n",\r\n__func__, __LINE__, snd_interval_value(i) - 1);\r\ni = hw_param_interval(params, SNDRV_PCM_HW_PARAM_FRAME_BITS);\r\nsrgr |= DAVINCI_MCBSP_SRGR_FPER(snd_interval_value(i) - 1);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ndavinci_mcbsp_write_reg(dev, DAVINCI_MCBSP_SRGR_REG, srgr);\r\nrcr = DAVINCI_MCBSP_RCR_RFIG;\r\nxcr = DAVINCI_MCBSP_XCR_XFIG;\r\nif (dev->mode == MOD_DSP_B) {\r\nrcr |= DAVINCI_MCBSP_RCR_RDATDLY(0);\r\nxcr |= DAVINCI_MCBSP_XCR_XDATDLY(0);\r\n} else {\r\nrcr |= DAVINCI_MCBSP_RCR_RDATDLY(1);\r\nxcr |= DAVINCI_MCBSP_XCR_XDATDLY(1);\r\n}\r\nfmt = params_format(params);\r\nif ((fmt > SNDRV_PCM_FORMAT_S32_LE) || !data_type[fmt]) {\r\nprintk(KERN_WARNING "davinci-i2s: unsupported PCM format\n");\r\nreturn -EINVAL;\r\n}\r\nif (params_channels(params) == 2) {\r\nelement_cnt = 2;\r\nif (double_fmt[fmt] && dev->enable_channel_combine) {\r\nelement_cnt = 1;\r\nfmt = double_fmt[fmt];\r\n}\r\nswitch (master) {\r\ncase SND_SOC_DAIFMT_CBS_CFS:\r\ncase SND_SOC_DAIFMT_CBS_CFM:\r\nrcr |= DAVINCI_MCBSP_RCR_RFRLEN2(0);\r\nxcr |= DAVINCI_MCBSP_XCR_XFRLEN2(0);\r\nrcr |= DAVINCI_MCBSP_RCR_RPHASE;\r\nxcr |= DAVINCI_MCBSP_XCR_XPHASE;\r\nbreak;\r\ncase SND_SOC_DAIFMT_CBM_CFM:\r\ncase SND_SOC_DAIFMT_CBM_CFS:\r\nrcr |= DAVINCI_MCBSP_RCR_RFRLEN2(element_cnt - 1);\r\nxcr |= DAVINCI_MCBSP_XCR_XFRLEN2(element_cnt - 1);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nmcbsp_word_length = asp_word_length[fmt];\r\nswitch (master) {\r\ncase SND_SOC_DAIFMT_CBS_CFS:\r\ncase SND_SOC_DAIFMT_CBS_CFM:\r\nrcr |= DAVINCI_MCBSP_RCR_RFRLEN1(0);\r\nxcr |= DAVINCI_MCBSP_XCR_XFRLEN1(0);\r\nbreak;\r\ncase SND_SOC_DAIFMT_CBM_CFM:\r\ncase SND_SOC_DAIFMT_CBM_CFS:\r\nrcr |= DAVINCI_MCBSP_RCR_RFRLEN1(element_cnt - 1);\r\nxcr |= DAVINCI_MCBSP_XCR_XFRLEN1(element_cnt - 1);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nrcr |= DAVINCI_MCBSP_RCR_RWDLEN1(mcbsp_word_length) |\r\nDAVINCI_MCBSP_RCR_RWDLEN2(mcbsp_word_length);\r\nxcr |= DAVINCI_MCBSP_XCR_XWDLEN1(mcbsp_word_length) |\r\nDAVINCI_MCBSP_XCR_XWDLEN2(mcbsp_word_length);\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\ndavinci_mcbsp_write_reg(dev, DAVINCI_MCBSP_XCR_REG, xcr);\r\nelse\r\ndavinci_mcbsp_write_reg(dev, DAVINCI_MCBSP_RCR_REG, rcr);\r\npr_debug("%s - %d srgr=%X\n", __func__, __LINE__, srgr);\r\npr_debug("%s - %d xcr=%X\n", __func__, __LINE__, xcr);\r\npr_debug("%s - %d rcr=%X\n", __func__, __LINE__, rcr);\r\nreturn 0;\r\n}\r\nstatic int davinci_i2s_prepare(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct davinci_mcbsp_dev *dev = snd_soc_dai_get_drvdata(dai);\r\nint playback = (substream->stream == SNDRV_PCM_STREAM_PLAYBACK);\r\ndavinci_mcbsp_stop(dev, playback);\r\nreturn 0;\r\n}\r\nstatic int davinci_i2s_trigger(struct snd_pcm_substream *substream, int cmd,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct davinci_mcbsp_dev *dev = snd_soc_dai_get_drvdata(dai);\r\nint ret = 0;\r\nint playback = (substream->stream == SNDRV_PCM_STREAM_PLAYBACK);\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\r\ndavinci_mcbsp_start(dev, substream);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\r\ndavinci_mcbsp_stop(dev, playback);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\n}\r\nreturn ret;\r\n}\r\nstatic void davinci_i2s_shutdown(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct davinci_mcbsp_dev *dev = snd_soc_dai_get_drvdata(dai);\r\nint playback = (substream->stream == SNDRV_PCM_STREAM_PLAYBACK);\r\ndavinci_mcbsp_stop(dev, playback);\r\n}\r\nstatic int davinci_i2s_dai_probe(struct snd_soc_dai *dai)\r\n{\r\nstruct davinci_mcbsp_dev *dev = snd_soc_dai_get_drvdata(dai);\r\ndai->playback_dma_data = &dev->dma_data[SNDRV_PCM_STREAM_PLAYBACK];\r\ndai->capture_dma_data = &dev->dma_data[SNDRV_PCM_STREAM_CAPTURE];\r\nreturn 0;\r\n}\r\nstatic int davinci_i2s_probe(struct platform_device *pdev)\r\n{\r\nstruct davinci_mcbsp_dev *dev;\r\nstruct resource *mem, *res;\r\nvoid __iomem *io_base;\r\nint *dma;\r\nint ret;\r\nmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nio_base = devm_ioremap_resource(&pdev->dev, mem);\r\nif (IS_ERR(io_base))\r\nreturn PTR_ERR(io_base);\r\ndev = devm_kzalloc(&pdev->dev, sizeof(struct davinci_mcbsp_dev),\r\nGFP_KERNEL);\r\nif (!dev)\r\nreturn -ENOMEM;\r\ndev->clk = clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(dev->clk))\r\nreturn -ENODEV;\r\nclk_enable(dev->clk);\r\ndev->base = io_base;\r\ndev->dma_data[SNDRV_PCM_STREAM_PLAYBACK].addr =\r\n(dma_addr_t)(mem->start + DAVINCI_MCBSP_DXR_REG);\r\ndev->dma_data[SNDRV_PCM_STREAM_CAPTURE].addr =\r\n(dma_addr_t)(mem->start + DAVINCI_MCBSP_DRR_REG);\r\nres = platform_get_resource(pdev, IORESOURCE_DMA, 0);\r\nif (!res) {\r\ndev_err(&pdev->dev, "no DMA resource\n");\r\nret = -ENXIO;\r\ngoto err_release_clk;\r\n}\r\ndma = &dev->dma_request[SNDRV_PCM_STREAM_PLAYBACK];\r\n*dma = res->start;\r\ndev->dma_data[SNDRV_PCM_STREAM_PLAYBACK].filter_data = dma;\r\nres = platform_get_resource(pdev, IORESOURCE_DMA, 1);\r\nif (!res) {\r\ndev_err(&pdev->dev, "no DMA resource\n");\r\nret = -ENXIO;\r\ngoto err_release_clk;\r\n}\r\ndma = &dev->dma_request[SNDRV_PCM_STREAM_CAPTURE];\r\n*dma = res->start;\r\ndev->dma_data[SNDRV_PCM_STREAM_CAPTURE].filter_data = dma;\r\ndev->dev = &pdev->dev;\r\ndev_set_drvdata(&pdev->dev, dev);\r\nret = snd_soc_register_component(&pdev->dev, &davinci_i2s_component,\r\n&davinci_i2s_dai, 1);\r\nif (ret != 0)\r\ngoto err_release_clk;\r\nret = edma_pcm_platform_register(&pdev->dev);\r\nif (ret) {\r\ndev_err(&pdev->dev, "register PCM failed: %d\n", ret);\r\ngoto err_unregister_component;\r\n}\r\nreturn 0;\r\nerr_unregister_component:\r\nsnd_soc_unregister_component(&pdev->dev);\r\nerr_release_clk:\r\nclk_disable(dev->clk);\r\nclk_put(dev->clk);\r\nreturn ret;\r\n}\r\nstatic int davinci_i2s_remove(struct platform_device *pdev)\r\n{\r\nstruct davinci_mcbsp_dev *dev = dev_get_drvdata(&pdev->dev);\r\nsnd_soc_unregister_component(&pdev->dev);\r\nclk_disable(dev->clk);\r\nclk_put(dev->clk);\r\ndev->clk = NULL;\r\nreturn 0;\r\n}

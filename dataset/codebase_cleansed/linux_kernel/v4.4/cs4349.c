static bool cs4349_readable_register(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase CS4349_CHIPID ... CS4349_MISC:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic bool cs4349_writeable_register(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase CS4349_MODE ... CS4349_MISC:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic int cs4349_set_dai_fmt(struct snd_soc_dai *codec_dai,\r\nunsigned int format)\r\n{\r\nstruct snd_soc_codec *codec = codec_dai->codec;\r\nstruct cs4349_private *cs4349 = snd_soc_codec_get_drvdata(codec);\r\nunsigned int fmt;\r\nfmt = format & SND_SOC_DAIFMT_FORMAT_MASK;\r\nswitch (fmt) {\r\ncase SND_SOC_DAIFMT_I2S:\r\ncase SND_SOC_DAIFMT_LEFT_J:\r\ncase SND_SOC_DAIFMT_RIGHT_J:\r\ncs4349->mode = format & SND_SOC_DAIFMT_FORMAT_MASK;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int cs4349_pcm_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nstruct cs4349_private *cs4349 = snd_soc_codec_get_drvdata(codec);\r\nint fmt, ret;\r\ncs4349->rate = params_rate(params);\r\nswitch (cs4349->mode) {\r\ncase SND_SOC_DAIFMT_I2S:\r\nfmt = DIF_I2S;\r\nbreak;\r\ncase SND_SOC_DAIFMT_LEFT_J:\r\nfmt = DIF_LEFT_JST;\r\nbreak;\r\ncase SND_SOC_DAIFMT_RIGHT_J:\r\nswitch (params_width(params)) {\r\ncase 16:\r\nfmt = DIF_RGHT_JST16;\r\nbreak;\r\ncase 24:\r\nfmt = DIF_RGHT_JST24;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nret = snd_soc_update_bits(codec, CS4349_MODE, DIF_MASK,\r\nMODE_FORMAT(fmt));\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int cs4349_digital_mute(struct snd_soc_dai *dai, int mute)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nint reg;\r\nreg = 0;\r\nif (mute)\r\nreg = MUTE_AB_MASK;\r\nreturn snd_soc_update_bits(codec, CS4349_MUTE, MUTE_AB_MASK, reg);\r\n}\r\nstatic int cs4349_i2c_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct cs4349_private *cs4349;\r\nint ret;\r\ncs4349 = devm_kzalloc(&client->dev, sizeof(*cs4349), GFP_KERNEL);\r\nif (!cs4349)\r\nreturn -ENOMEM;\r\ncs4349->regmap = devm_regmap_init_i2c(client, &cs4349_regmap);\r\nif (IS_ERR(cs4349->regmap)) {\r\nret = PTR_ERR(cs4349->regmap);\r\ndev_err(&client->dev, "regmap_init() failed: %d\n", ret);\r\nreturn ret;\r\n}\r\ncs4349->reset_gpio = devm_gpiod_get_optional(&client->dev,\r\n"reset", GPIOD_OUT_LOW);\r\nif (IS_ERR(cs4349->reset_gpio))\r\nreturn PTR_ERR(cs4349->reset_gpio);\r\ngpiod_set_value_cansleep(cs4349->reset_gpio, 1);\r\ni2c_set_clientdata(client, cs4349);\r\nreturn snd_soc_register_codec(&client->dev, &soc_codec_dev_cs4349,\r\n&cs4349_dai, 1);\r\n}\r\nstatic int cs4349_i2c_remove(struct i2c_client *client)\r\n{\r\nstruct cs4349_private *cs4349 = i2c_get_clientdata(client);\r\nsnd_soc_unregister_codec(&client->dev);\r\ngpiod_set_value_cansleep(cs4349->reset_gpio, 0);\r\nreturn 0;\r\n}\r\nstatic int cs4349_runtime_suspend(struct device *dev)\r\n{\r\nstruct cs4349_private *cs4349 = dev_get_drvdata(dev);\r\nint ret;\r\nret = regmap_update_bits(cs4349->regmap, CS4349_MISC, PWR_DWN, PWR_DWN);\r\nif (ret < 0)\r\nreturn ret;\r\nregcache_cache_only(cs4349->regmap, true);\r\ngpiod_set_value_cansleep(cs4349->reset_gpio, 0);\r\nreturn 0;\r\n}\r\nstatic int cs4349_runtime_resume(struct device *dev)\r\n{\r\nstruct cs4349_private *cs4349 = dev_get_drvdata(dev);\r\nint ret;\r\nret = regmap_update_bits(cs4349->regmap, CS4349_MISC, PWR_DWN, 0);\r\nif (ret < 0)\r\nreturn ret;\r\ngpiod_set_value_cansleep(cs4349->reset_gpio, 1);\r\nregcache_cache_only(cs4349->regmap, false);\r\nregcache_sync(cs4349->regmap);\r\nreturn 0;\r\n}

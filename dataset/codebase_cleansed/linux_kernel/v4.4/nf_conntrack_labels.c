static unsigned int label_bits(const struct nf_conn_labels *l)\r\n{\r\nunsigned int longs = l->words;\r\nreturn longs * BITS_PER_LONG;\r\n}\r\nbool nf_connlabel_match(const struct nf_conn *ct, u16 bit)\r\n{\r\nstruct nf_conn_labels *labels = nf_ct_labels_find(ct);\r\nif (!labels)\r\nreturn false;\r\nreturn bit < label_bits(labels) && test_bit(bit, labels->bits);\r\n}\r\nint nf_connlabel_set(struct nf_conn *ct, u16 bit)\r\n{\r\nstruct nf_conn_labels *labels = nf_ct_labels_find(ct);\r\nif (!labels || bit >= label_bits(labels))\r\nreturn -ENOSPC;\r\nif (test_bit(bit, labels->bits))\r\nreturn 0;\r\nif (!test_and_set_bit(bit, labels->bits))\r\nnf_conntrack_event_cache(IPCT_LABEL, ct);\r\nreturn 0;\r\n}\r\nstatic void replace_u32(u32 *address, u32 mask, u32 new)\r\n{\r\nu32 old, tmp;\r\ndo {\r\nold = *address;\r\ntmp = (old & mask) ^ new;\r\n} while (cmpxchg(address, old, tmp) != old);\r\n}\r\nint nf_connlabels_replace(struct nf_conn *ct,\r\nconst u32 *data,\r\nconst u32 *mask, unsigned int words32)\r\n{\r\nstruct nf_conn_labels *labels;\r\nunsigned int size, i;\r\nu32 *dst;\r\nlabels = nf_ct_labels_find(ct);\r\nif (!labels)\r\nreturn -ENOSPC;\r\nsize = labels->words * sizeof(long);\r\nif (size < (words32 * sizeof(u32)))\r\nwords32 = size / sizeof(u32);\r\ndst = (u32 *) labels->bits;\r\nif (words32) {\r\nfor (i = 0; i < words32; i++)\r\nreplace_u32(&dst[i], mask ? ~mask[i] : 0, data[i]);\r\n}\r\nsize /= sizeof(u32);\r\nfor (i = words32; i < size; i++)\r\nreplace_u32(&dst[i], 0, 0);\r\nnf_conntrack_event_cache(IPCT_LABEL, ct);\r\nreturn 0;\r\n}\r\nint nf_connlabels_get(struct net *net, unsigned int n_bits)\r\n{\r\nsize_t words;\r\nif (n_bits > (NF_CT_LABELS_MAX_SIZE * BITS_PER_BYTE))\r\nreturn -ERANGE;\r\nwords = BITS_TO_LONGS(n_bits);\r\nspin_lock(&nf_connlabels_lock);\r\nnet->ct.labels_used++;\r\nif (words > net->ct.label_words)\r\nnet->ct.label_words = words;\r\nspin_unlock(&nf_connlabels_lock);\r\nreturn 0;\r\n}\r\nvoid nf_connlabels_put(struct net *net)\r\n{\r\nspin_lock(&nf_connlabels_lock);\r\nnet->ct.labels_used--;\r\nif (net->ct.labels_used == 0)\r\nnet->ct.label_words = 0;\r\nspin_unlock(&nf_connlabels_lock);\r\n}\r\nint nf_conntrack_labels_init(void)\r\n{\r\nspin_lock_init(&nf_connlabels_lock);\r\nreturn nf_ct_extend_register(&labels_extend);\r\n}\r\nvoid nf_conntrack_labels_fini(void)\r\n{\r\nnf_ct_extend_unregister(&labels_extend);\r\n}

static inline void\r\nqla2xxx_prep_dump(struct qla_hw_data *ha, struct qla2xxx_fw_dump *fw_dump)\r\n{\r\nfw_dump->fw_major_version = htonl(ha->fw_major_version);\r\nfw_dump->fw_minor_version = htonl(ha->fw_minor_version);\r\nfw_dump->fw_subminor_version = htonl(ha->fw_subminor_version);\r\nfw_dump->fw_attributes = htonl(ha->fw_attributes);\r\nfw_dump->vendor = htonl(ha->pdev->vendor);\r\nfw_dump->device = htonl(ha->pdev->device);\r\nfw_dump->subsystem_vendor = htonl(ha->pdev->subsystem_vendor);\r\nfw_dump->subsystem_device = htonl(ha->pdev->subsystem_device);\r\n}\r\nstatic inline void *\r\nqla2xxx_copy_queues(struct qla_hw_data *ha, void *ptr)\r\n{\r\nstruct req_que *req = ha->req_q_map[0];\r\nstruct rsp_que *rsp = ha->rsp_q_map[0];\r\nmemcpy(ptr, req->ring, req->length *\r\nsizeof(request_t));\r\nptr += req->length * sizeof(request_t);\r\nmemcpy(ptr, rsp->ring, rsp->length *\r\nsizeof(response_t));\r\nreturn ptr + (rsp->length * sizeof(response_t));\r\n}\r\nint\r\nqla27xx_dump_mpi_ram(struct qla_hw_data *ha, uint32_t addr, uint32_t *ram,\r\nuint32_t ram_dwords, void **nxt)\r\n{\r\nint rval;\r\nuint32_t cnt, stat, timer, dwords, idx;\r\nuint16_t mb0;\r\nstruct device_reg_24xx __iomem *reg = &ha->iobase->isp24;\r\ndma_addr_t dump_dma = ha->gid_list_dma;\r\nuint32_t *dump = (uint32_t *)ha->gid_list;\r\nrval = QLA_SUCCESS;\r\nmb0 = 0;\r\nWRT_REG_WORD(&reg->mailbox0, MBC_LOAD_DUMP_MPI_RAM);\r\nclear_bit(MBX_INTERRUPT, &ha->mbx_cmd_flags);\r\ndwords = qla2x00_gid_list_size(ha) / 4;\r\nfor (cnt = 0; cnt < ram_dwords && rval == QLA_SUCCESS;\r\ncnt += dwords, addr += dwords) {\r\nif (cnt + dwords > ram_dwords)\r\ndwords = ram_dwords - cnt;\r\nWRT_REG_WORD(&reg->mailbox1, LSW(addr));\r\nWRT_REG_WORD(&reg->mailbox8, MSW(addr));\r\nWRT_REG_WORD(&reg->mailbox2, MSW(dump_dma));\r\nWRT_REG_WORD(&reg->mailbox3, LSW(dump_dma));\r\nWRT_REG_WORD(&reg->mailbox6, MSW(MSD(dump_dma)));\r\nWRT_REG_WORD(&reg->mailbox7, LSW(MSD(dump_dma)));\r\nWRT_REG_WORD(&reg->mailbox4, MSW(dwords));\r\nWRT_REG_WORD(&reg->mailbox5, LSW(dwords));\r\nWRT_REG_WORD(&reg->mailbox9, 0);\r\nWRT_REG_DWORD(&reg->hccr, HCCRX_SET_HOST_INT);\r\nha->flags.mbox_int = 0;\r\nfor (timer = 6000000; timer; timer--) {\r\nstat = RD_REG_DWORD(&reg->host_status);\r\nif (stat & HSRX_RISC_INT) {\r\nstat &= 0xff;\r\nif (stat == 0x1 || stat == 0x2 ||\r\nstat == 0x10 || stat == 0x11) {\r\nset_bit(MBX_INTERRUPT,\r\n&ha->mbx_cmd_flags);\r\nmb0 = RD_REG_WORD(&reg->mailbox0);\r\nRD_REG_WORD(&reg->mailbox1);\r\nWRT_REG_DWORD(&reg->hccr,\r\nHCCRX_CLR_RISC_INT);\r\nRD_REG_DWORD(&reg->hccr);\r\nbreak;\r\n}\r\nWRT_REG_DWORD(&reg->hccr, HCCRX_CLR_RISC_INT);\r\nRD_REG_DWORD(&reg->hccr);\r\n}\r\nudelay(5);\r\n}\r\nha->flags.mbox_int = 1;\r\nif (test_and_clear_bit(MBX_INTERRUPT, &ha->mbx_cmd_flags)) {\r\nrval = mb0 & MBS_MASK;\r\nfor (idx = 0; idx < dwords; idx++)\r\nram[cnt + idx] = IS_QLA27XX(ha) ?\r\nle32_to_cpu(dump[idx]) : swab32(dump[idx]);\r\n} else {\r\nrval = QLA_FUNCTION_FAILED;\r\n}\r\n}\r\n*nxt = rval == QLA_SUCCESS ? &ram[cnt] : NULL;\r\nreturn rval;\r\n}\r\nint\r\nqla24xx_dump_ram(struct qla_hw_data *ha, uint32_t addr, uint32_t *ram,\r\nuint32_t ram_dwords, void **nxt)\r\n{\r\nint rval;\r\nuint32_t cnt, stat, timer, dwords, idx;\r\nuint16_t mb0;\r\nstruct device_reg_24xx __iomem *reg = &ha->iobase->isp24;\r\ndma_addr_t dump_dma = ha->gid_list_dma;\r\nuint32_t *dump = (uint32_t *)ha->gid_list;\r\nrval = QLA_SUCCESS;\r\nmb0 = 0;\r\nWRT_REG_WORD(&reg->mailbox0, MBC_DUMP_RISC_RAM_EXTENDED);\r\nclear_bit(MBX_INTERRUPT, &ha->mbx_cmd_flags);\r\ndwords = qla2x00_gid_list_size(ha) / 4;\r\nfor (cnt = 0; cnt < ram_dwords && rval == QLA_SUCCESS;\r\ncnt += dwords, addr += dwords) {\r\nif (cnt + dwords > ram_dwords)\r\ndwords = ram_dwords - cnt;\r\nWRT_REG_WORD(&reg->mailbox1, LSW(addr));\r\nWRT_REG_WORD(&reg->mailbox8, MSW(addr));\r\nWRT_REG_WORD(&reg->mailbox2, MSW(dump_dma));\r\nWRT_REG_WORD(&reg->mailbox3, LSW(dump_dma));\r\nWRT_REG_WORD(&reg->mailbox6, MSW(MSD(dump_dma)));\r\nWRT_REG_WORD(&reg->mailbox7, LSW(MSD(dump_dma)));\r\nWRT_REG_WORD(&reg->mailbox4, MSW(dwords));\r\nWRT_REG_WORD(&reg->mailbox5, LSW(dwords));\r\nWRT_REG_DWORD(&reg->hccr, HCCRX_SET_HOST_INT);\r\nha->flags.mbox_int = 0;\r\nfor (timer = 6000000; timer; timer--) {\r\nstat = RD_REG_DWORD(&reg->host_status);\r\nif (stat & HSRX_RISC_INT) {\r\nstat &= 0xff;\r\nif (stat == 0x1 || stat == 0x2 ||\r\nstat == 0x10 || stat == 0x11) {\r\nset_bit(MBX_INTERRUPT,\r\n&ha->mbx_cmd_flags);\r\nmb0 = RD_REG_WORD(&reg->mailbox0);\r\nWRT_REG_DWORD(&reg->hccr,\r\nHCCRX_CLR_RISC_INT);\r\nRD_REG_DWORD(&reg->hccr);\r\nbreak;\r\n}\r\nWRT_REG_DWORD(&reg->hccr, HCCRX_CLR_RISC_INT);\r\nRD_REG_DWORD(&reg->hccr);\r\n}\r\nudelay(5);\r\n}\r\nha->flags.mbox_int = 1;\r\nif (test_and_clear_bit(MBX_INTERRUPT, &ha->mbx_cmd_flags)) {\r\nrval = mb0 & MBS_MASK;\r\nfor (idx = 0; idx < dwords; idx++)\r\nram[cnt + idx] = IS_QLA27XX(ha) ?\r\nle32_to_cpu(dump[idx]) : swab32(dump[idx]);\r\n} else {\r\nrval = QLA_FUNCTION_FAILED;\r\n}\r\n}\r\n*nxt = rval == QLA_SUCCESS ? &ram[cnt]: NULL;\r\nreturn rval;\r\n}\r\nstatic int\r\nqla24xx_dump_memory(struct qla_hw_data *ha, uint32_t *code_ram,\r\nuint32_t cram_size, void **nxt)\r\n{\r\nint rval;\r\nrval = qla24xx_dump_ram(ha, 0x20000, code_ram, cram_size / 4, nxt);\r\nif (rval != QLA_SUCCESS)\r\nreturn rval;\r\nset_bit(RISC_SRAM_DUMP_CMPL, &ha->fw_dump_cap_flags);\r\nrval = qla24xx_dump_ram(ha, 0x100000, *nxt,\r\nha->fw_memory_size - 0x100000 + 1, nxt);\r\nif (rval == QLA_SUCCESS)\r\nset_bit(RISC_EXT_MEM_DUMP_CMPL, &ha->fw_dump_cap_flags);\r\nreturn rval;\r\n}\r\nstatic uint32_t *\r\nqla24xx_read_window(struct device_reg_24xx __iomem *reg, uint32_t iobase,\r\nuint32_t count, uint32_t *buf)\r\n{\r\nuint32_t __iomem *dmp_reg;\r\nWRT_REG_DWORD(&reg->iobase_addr, iobase);\r\ndmp_reg = &reg->iobase_window;\r\nwhile (count--)\r\n*buf++ = htonl(RD_REG_DWORD(dmp_reg++));\r\nreturn buf;\r\n}\r\nvoid\r\nqla24xx_pause_risc(struct device_reg_24xx __iomem *reg, struct qla_hw_data *ha)\r\n{\r\nWRT_REG_DWORD(&reg->hccr, HCCRX_SET_RISC_PAUSE);\r\nudelay(100);\r\nif (RD_REG_DWORD(&reg->host_status) & HSRX_RISC_PAUSED)\r\nset_bit(RISC_PAUSE_CMPL, &ha->fw_dump_cap_flags);\r\n}\r\nint\r\nqla24xx_soft_reset(struct qla_hw_data *ha)\r\n{\r\nint rval = QLA_SUCCESS;\r\nuint32_t cnt;\r\nuint16_t wd;\r\nstruct device_reg_24xx __iomem *reg = &ha->iobase->isp24;\r\nWRT_REG_DWORD(&reg->ctrl_status, CSRX_DMA_SHUTDOWN|MWB_4096_BYTES);\r\nfor (cnt = 0; cnt < 30000; cnt++) {\r\nif ((RD_REG_DWORD(&reg->ctrl_status) & CSRX_DMA_ACTIVE) == 0)\r\nbreak;\r\nudelay(10);\r\n}\r\nif (!(RD_REG_DWORD(&reg->ctrl_status) & CSRX_DMA_ACTIVE))\r\nset_bit(DMA_SHUTDOWN_CMPL, &ha->fw_dump_cap_flags);\r\nWRT_REG_DWORD(&reg->ctrl_status,\r\nCSRX_ISP_SOFT_RESET|CSRX_DMA_SHUTDOWN|MWB_4096_BYTES);\r\npci_read_config_word(ha->pdev, PCI_COMMAND, &wd);\r\nudelay(100);\r\nfor (cnt = 0; cnt < 30000; cnt++) {\r\nif ((RD_REG_DWORD(&reg->ctrl_status) &\r\nCSRX_ISP_SOFT_RESET) == 0)\r\nbreak;\r\nudelay(10);\r\n}\r\nif (!(RD_REG_DWORD(&reg->ctrl_status) & CSRX_ISP_SOFT_RESET))\r\nset_bit(ISP_RESET_CMPL, &ha->fw_dump_cap_flags);\r\nWRT_REG_DWORD(&reg->hccr, HCCRX_CLR_RISC_RESET);\r\nRD_REG_DWORD(&reg->hccr);\r\nfor (cnt = 10000; RD_REG_WORD(&reg->mailbox0) != 0 &&\r\nrval == QLA_SUCCESS; cnt--) {\r\nif (cnt)\r\nudelay(10);\r\nelse\r\nrval = QLA_FUNCTION_TIMEOUT;\r\n}\r\nif (rval == QLA_SUCCESS)\r\nset_bit(RISC_RDY_AFT_RESET, &ha->fw_dump_cap_flags);\r\nreturn rval;\r\n}\r\nstatic int\r\nqla2xxx_dump_ram(struct qla_hw_data *ha, uint32_t addr, uint16_t *ram,\r\nuint32_t ram_words, void **nxt)\r\n{\r\nint rval;\r\nuint32_t cnt, stat, timer, words, idx;\r\nuint16_t mb0;\r\nstruct device_reg_2xxx __iomem *reg = &ha->iobase->isp;\r\ndma_addr_t dump_dma = ha->gid_list_dma;\r\nuint16_t *dump = (uint16_t *)ha->gid_list;\r\nrval = QLA_SUCCESS;\r\nmb0 = 0;\r\nWRT_MAILBOX_REG(ha, reg, 0, MBC_DUMP_RISC_RAM_EXTENDED);\r\nclear_bit(MBX_INTERRUPT, &ha->mbx_cmd_flags);\r\nwords = qla2x00_gid_list_size(ha) / 2;\r\nfor (cnt = 0; cnt < ram_words && rval == QLA_SUCCESS;\r\ncnt += words, addr += words) {\r\nif (cnt + words > ram_words)\r\nwords = ram_words - cnt;\r\nWRT_MAILBOX_REG(ha, reg, 1, LSW(addr));\r\nWRT_MAILBOX_REG(ha, reg, 8, MSW(addr));\r\nWRT_MAILBOX_REG(ha, reg, 2, MSW(dump_dma));\r\nWRT_MAILBOX_REG(ha, reg, 3, LSW(dump_dma));\r\nWRT_MAILBOX_REG(ha, reg, 6, MSW(MSD(dump_dma)));\r\nWRT_MAILBOX_REG(ha, reg, 7, LSW(MSD(dump_dma)));\r\nWRT_MAILBOX_REG(ha, reg, 4, words);\r\nWRT_REG_WORD(&reg->hccr, HCCR_SET_HOST_INT);\r\nfor (timer = 6000000; timer; timer--) {\r\nstat = RD_REG_DWORD(&reg->u.isp2300.host_status);\r\nif (stat & HSR_RISC_INT) {\r\nstat &= 0xff;\r\nif (stat == 0x1 || stat == 0x2) {\r\nset_bit(MBX_INTERRUPT,\r\n&ha->mbx_cmd_flags);\r\nmb0 = RD_MAILBOX_REG(ha, reg, 0);\r\nWRT_REG_WORD(&reg->semaphore, 0);\r\nWRT_REG_WORD(&reg->hccr,\r\nHCCR_CLR_RISC_INT);\r\nRD_REG_WORD(&reg->hccr);\r\nbreak;\r\n} else if (stat == 0x10 || stat == 0x11) {\r\nset_bit(MBX_INTERRUPT,\r\n&ha->mbx_cmd_flags);\r\nmb0 = RD_MAILBOX_REG(ha, reg, 0);\r\nWRT_REG_WORD(&reg->hccr,\r\nHCCR_CLR_RISC_INT);\r\nRD_REG_WORD(&reg->hccr);\r\nbreak;\r\n}\r\nWRT_REG_WORD(&reg->hccr, HCCR_CLR_RISC_INT);\r\nRD_REG_WORD(&reg->hccr);\r\n}\r\nudelay(5);\r\n}\r\nif (test_and_clear_bit(MBX_INTERRUPT, &ha->mbx_cmd_flags)) {\r\nrval = mb0 & MBS_MASK;\r\nfor (idx = 0; idx < words; idx++)\r\nram[cnt + idx] = swab16(dump[idx]);\r\n} else {\r\nrval = QLA_FUNCTION_FAILED;\r\n}\r\n}\r\n*nxt = rval == QLA_SUCCESS ? &ram[cnt]: NULL;\r\nreturn rval;\r\n}\r\nstatic inline void\r\nqla2xxx_read_window(struct device_reg_2xxx __iomem *reg, uint32_t count,\r\nuint16_t *buf)\r\n{\r\nuint16_t __iomem *dmp_reg = &reg->u.isp2300.fb_cmd;\r\nwhile (count--)\r\n*buf++ = htons(RD_REG_WORD(dmp_reg++));\r\n}\r\nstatic inline void *\r\nqla24xx_copy_eft(struct qla_hw_data *ha, void *ptr)\r\n{\r\nif (!ha->eft)\r\nreturn ptr;\r\nmemcpy(ptr, ha->eft, ntohl(ha->fw_dump->eft_size));\r\nreturn ptr + ntohl(ha->fw_dump->eft_size);\r\n}\r\nstatic inline void *\r\nqla25xx_copy_fce(struct qla_hw_data *ha, void *ptr, uint32_t **last_chain)\r\n{\r\nuint32_t cnt;\r\nuint32_t *iter_reg;\r\nstruct qla2xxx_fce_chain *fcec = ptr;\r\nif (!ha->fce)\r\nreturn ptr;\r\n*last_chain = &fcec->type;\r\nfcec->type = htonl(DUMP_CHAIN_FCE);\r\nfcec->chain_size = htonl(sizeof(struct qla2xxx_fce_chain) +\r\nfce_calc_size(ha->fce_bufs));\r\nfcec->size = htonl(fce_calc_size(ha->fce_bufs));\r\nfcec->addr_l = htonl(LSD(ha->fce_dma));\r\nfcec->addr_h = htonl(MSD(ha->fce_dma));\r\niter_reg = fcec->eregs;\r\nfor (cnt = 0; cnt < 8; cnt++)\r\n*iter_reg++ = htonl(ha->fce_mb[cnt]);\r\nmemcpy(iter_reg, ha->fce, ntohl(fcec->size));\r\nreturn (char *)iter_reg + ntohl(fcec->size);\r\n}\r\nstatic inline void *\r\nqla2xxx_copy_atioqueues(struct qla_hw_data *ha, void *ptr,\r\nuint32_t **last_chain)\r\n{\r\nstruct qla2xxx_mqueue_chain *q;\r\nstruct qla2xxx_mqueue_header *qh;\r\nuint32_t num_queues;\r\nint que;\r\nstruct {\r\nint length;\r\nvoid *ring;\r\n} aq, *aqp;\r\nif (!ha->tgt.atio_ring)\r\nreturn ptr;\r\nnum_queues = 1;\r\naqp = &aq;\r\naqp->length = ha->tgt.atio_q_length;\r\naqp->ring = ha->tgt.atio_ring;\r\nfor (que = 0; que < num_queues; que++) {\r\nq = ptr;\r\n*last_chain = &q->type;\r\nq->type = htonl(DUMP_CHAIN_QUEUE);\r\nq->chain_size = htonl(\r\nsizeof(struct qla2xxx_mqueue_chain) +\r\nsizeof(struct qla2xxx_mqueue_header) +\r\n(aqp->length * sizeof(request_t)));\r\nptr += sizeof(struct qla2xxx_mqueue_chain);\r\nqh = ptr;\r\nqh->queue = htonl(TYPE_ATIO_QUEUE);\r\nqh->number = htonl(que);\r\nqh->size = htonl(aqp->length * sizeof(request_t));\r\nptr += sizeof(struct qla2xxx_mqueue_header);\r\nmemcpy(ptr, aqp->ring, aqp->length * sizeof(request_t));\r\nptr += aqp->length * sizeof(request_t);\r\n}\r\nreturn ptr;\r\n}\r\nstatic inline void *\r\nqla25xx_copy_mqueues(struct qla_hw_data *ha, void *ptr, uint32_t **last_chain)\r\n{\r\nstruct qla2xxx_mqueue_chain *q;\r\nstruct qla2xxx_mqueue_header *qh;\r\nstruct req_que *req;\r\nstruct rsp_que *rsp;\r\nint que;\r\nif (!ha->mqenable)\r\nreturn ptr;\r\nfor (que = 1; que < ha->max_req_queues; que++) {\r\nreq = ha->req_q_map[que];\r\nif (!req)\r\nbreak;\r\nq = ptr;\r\n*last_chain = &q->type;\r\nq->type = htonl(DUMP_CHAIN_QUEUE);\r\nq->chain_size = htonl(\r\nsizeof(struct qla2xxx_mqueue_chain) +\r\nsizeof(struct qla2xxx_mqueue_header) +\r\n(req->length * sizeof(request_t)));\r\nptr += sizeof(struct qla2xxx_mqueue_chain);\r\nqh = ptr;\r\nqh->queue = htonl(TYPE_REQUEST_QUEUE);\r\nqh->number = htonl(que);\r\nqh->size = htonl(req->length * sizeof(request_t));\r\nptr += sizeof(struct qla2xxx_mqueue_header);\r\nmemcpy(ptr, req->ring, req->length * sizeof(request_t));\r\nptr += req->length * sizeof(request_t);\r\n}\r\nfor (que = 1; que < ha->max_rsp_queues; que++) {\r\nrsp = ha->rsp_q_map[que];\r\nif (!rsp)\r\nbreak;\r\nq = ptr;\r\n*last_chain = &q->type;\r\nq->type = htonl(DUMP_CHAIN_QUEUE);\r\nq->chain_size = htonl(\r\nsizeof(struct qla2xxx_mqueue_chain) +\r\nsizeof(struct qla2xxx_mqueue_header) +\r\n(rsp->length * sizeof(response_t)));\r\nptr += sizeof(struct qla2xxx_mqueue_chain);\r\nqh = ptr;\r\nqh->queue = htonl(TYPE_RESPONSE_QUEUE);\r\nqh->number = htonl(que);\r\nqh->size = htonl(rsp->length * sizeof(response_t));\r\nptr += sizeof(struct qla2xxx_mqueue_header);\r\nmemcpy(ptr, rsp->ring, rsp->length * sizeof(response_t));\r\nptr += rsp->length * sizeof(response_t);\r\n}\r\nreturn ptr;\r\n}\r\nstatic inline void *\r\nqla25xx_copy_mq(struct qla_hw_data *ha, void *ptr, uint32_t **last_chain)\r\n{\r\nuint32_t cnt, que_idx;\r\nuint8_t que_cnt;\r\nstruct qla2xxx_mq_chain *mq = ptr;\r\ndevice_reg_t *reg;\r\nif (!ha->mqenable || IS_QLA83XX(ha) || IS_QLA27XX(ha))\r\nreturn ptr;\r\nmq = ptr;\r\n*last_chain = &mq->type;\r\nmq->type = htonl(DUMP_CHAIN_MQ);\r\nmq->chain_size = htonl(sizeof(struct qla2xxx_mq_chain));\r\nque_cnt = ha->max_req_queues > ha->max_rsp_queues ?\r\nha->max_req_queues : ha->max_rsp_queues;\r\nmq->count = htonl(que_cnt);\r\nfor (cnt = 0; cnt < que_cnt; cnt++) {\r\nreg = ISP_QUE_REG(ha, cnt);\r\nque_idx = cnt * 4;\r\nmq->qregs[que_idx] =\r\nhtonl(RD_REG_DWORD(&reg->isp25mq.req_q_in));\r\nmq->qregs[que_idx+1] =\r\nhtonl(RD_REG_DWORD(&reg->isp25mq.req_q_out));\r\nmq->qregs[que_idx+2] =\r\nhtonl(RD_REG_DWORD(&reg->isp25mq.rsp_q_in));\r\nmq->qregs[que_idx+3] =\r\nhtonl(RD_REG_DWORD(&reg->isp25mq.rsp_q_out));\r\n}\r\nreturn ptr + sizeof(struct qla2xxx_mq_chain);\r\n}\r\nvoid\r\nqla2xxx_dump_post_process(scsi_qla_host_t *vha, int rval)\r\n{\r\nstruct qla_hw_data *ha = vha->hw;\r\nif (rval != QLA_SUCCESS) {\r\nql_log(ql_log_warn, vha, 0xd000,\r\n"Failed to dump firmware (%x), dump status flags (0x%lx).\n",\r\nrval, ha->fw_dump_cap_flags);\r\nha->fw_dumped = 0;\r\n} else {\r\nql_log(ql_log_info, vha, 0xd001,\r\n"Firmware dump saved to temp buffer (%ld/%p), dump status flags (0x%lx).\n",\r\nvha->host_no, ha->fw_dump, ha->fw_dump_cap_flags);\r\nha->fw_dumped = 1;\r\nqla2x00_post_uevent_work(vha, QLA_UEVENT_CODE_FW_DUMP);\r\n}\r\n}\r\nvoid\r\nqla2300_fw_dump(scsi_qla_host_t *vha, int hardware_locked)\r\n{\r\nint rval;\r\nuint32_t cnt;\r\nstruct qla_hw_data *ha = vha->hw;\r\nstruct device_reg_2xxx __iomem *reg = &ha->iobase->isp;\r\nuint16_t __iomem *dmp_reg;\r\nunsigned long flags;\r\nstruct qla2300_fw_dump *fw;\r\nvoid *nxt;\r\nstruct scsi_qla_host *base_vha = pci_get_drvdata(ha->pdev);\r\nflags = 0;\r\n#ifndef __CHECKER__\r\nif (!hardware_locked)\r\nspin_lock_irqsave(&ha->hardware_lock, flags);\r\n#endif\r\nif (!ha->fw_dump) {\r\nql_log(ql_log_warn, vha, 0xd002,\r\n"No buffer available for dump.\n");\r\ngoto qla2300_fw_dump_failed;\r\n}\r\nif (ha->fw_dumped) {\r\nql_log(ql_log_warn, vha, 0xd003,\r\n"Firmware has been previously dumped (%p) "\r\n"-- ignoring request.\n",\r\nha->fw_dump);\r\ngoto qla2300_fw_dump_failed;\r\n}\r\nfw = &ha->fw_dump->isp.isp23;\r\nqla2xxx_prep_dump(ha, ha->fw_dump);\r\nrval = QLA_SUCCESS;\r\nfw->hccr = htons(RD_REG_WORD(&reg->hccr));\r\nWRT_REG_WORD(&reg->hccr, HCCR_PAUSE_RISC);\r\nif (IS_QLA2300(ha)) {\r\nfor (cnt = 30000;\r\n(RD_REG_WORD(&reg->hccr) & HCCR_RISC_PAUSE) == 0 &&\r\nrval == QLA_SUCCESS; cnt--) {\r\nif (cnt)\r\nudelay(100);\r\nelse\r\nrval = QLA_FUNCTION_TIMEOUT;\r\n}\r\n} else {\r\nRD_REG_WORD(&reg->hccr);\r\nudelay(10);\r\n}\r\nif (rval == QLA_SUCCESS) {\r\ndmp_reg = &reg->flash_address;\r\nfor (cnt = 0; cnt < sizeof(fw->pbiu_reg) / 2; cnt++)\r\nfw->pbiu_reg[cnt] = htons(RD_REG_WORD(dmp_reg++));\r\ndmp_reg = &reg->u.isp2300.req_q_in;\r\nfor (cnt = 0; cnt < sizeof(fw->risc_host_reg) / 2; cnt++)\r\nfw->risc_host_reg[cnt] = htons(RD_REG_WORD(dmp_reg++));\r\ndmp_reg = &reg->u.isp2300.mailbox0;\r\nfor (cnt = 0; cnt < sizeof(fw->mailbox_reg) / 2; cnt++)\r\nfw->mailbox_reg[cnt] = htons(RD_REG_WORD(dmp_reg++));\r\nWRT_REG_WORD(&reg->ctrl_status, 0x40);\r\nqla2xxx_read_window(reg, 32, fw->resp_dma_reg);\r\nWRT_REG_WORD(&reg->ctrl_status, 0x50);\r\nqla2xxx_read_window(reg, 48, fw->dma_reg);\r\nWRT_REG_WORD(&reg->ctrl_status, 0x00);\r\ndmp_reg = &reg->risc_hw;\r\nfor (cnt = 0; cnt < sizeof(fw->risc_hdw_reg) / 2; cnt++)\r\nfw->risc_hdw_reg[cnt] = htons(RD_REG_WORD(dmp_reg++));\r\nWRT_REG_WORD(&reg->pcr, 0x2000);\r\nqla2xxx_read_window(reg, 16, fw->risc_gp0_reg);\r\nWRT_REG_WORD(&reg->pcr, 0x2200);\r\nqla2xxx_read_window(reg, 16, fw->risc_gp1_reg);\r\nWRT_REG_WORD(&reg->pcr, 0x2400);\r\nqla2xxx_read_window(reg, 16, fw->risc_gp2_reg);\r\nWRT_REG_WORD(&reg->pcr, 0x2600);\r\nqla2xxx_read_window(reg, 16, fw->risc_gp3_reg);\r\nWRT_REG_WORD(&reg->pcr, 0x2800);\r\nqla2xxx_read_window(reg, 16, fw->risc_gp4_reg);\r\nWRT_REG_WORD(&reg->pcr, 0x2A00);\r\nqla2xxx_read_window(reg, 16, fw->risc_gp5_reg);\r\nWRT_REG_WORD(&reg->pcr, 0x2C00);\r\nqla2xxx_read_window(reg, 16, fw->risc_gp6_reg);\r\nWRT_REG_WORD(&reg->pcr, 0x2E00);\r\nqla2xxx_read_window(reg, 16, fw->risc_gp7_reg);\r\nWRT_REG_WORD(&reg->ctrl_status, 0x10);\r\nqla2xxx_read_window(reg, 64, fw->frame_buf_hdw_reg);\r\nWRT_REG_WORD(&reg->ctrl_status, 0x20);\r\nqla2xxx_read_window(reg, 64, fw->fpm_b0_reg);\r\nWRT_REG_WORD(&reg->ctrl_status, 0x30);\r\nqla2xxx_read_window(reg, 64, fw->fpm_b1_reg);\r\nWRT_REG_WORD(&reg->ctrl_status, CSR_ISP_SOFT_RESET);\r\nfor (cnt = 0; cnt < 30000; cnt++) {\r\nif ((RD_REG_WORD(&reg->ctrl_status) &\r\nCSR_ISP_SOFT_RESET) == 0)\r\nbreak;\r\nudelay(10);\r\n}\r\n}\r\nif (!IS_QLA2300(ha)) {\r\nfor (cnt = 30000; RD_MAILBOX_REG(ha, reg, 0) != 0 &&\r\nrval == QLA_SUCCESS; cnt--) {\r\nif (cnt)\r\nudelay(100);\r\nelse\r\nrval = QLA_FUNCTION_TIMEOUT;\r\n}\r\n}\r\nif (rval == QLA_SUCCESS)\r\nrval = qla2xxx_dump_ram(ha, 0x800, fw->risc_ram,\r\nsizeof(fw->risc_ram) / 2, &nxt);\r\nif (rval == QLA_SUCCESS)\r\nrval = qla2xxx_dump_ram(ha, 0x10000, fw->stack_ram,\r\nsizeof(fw->stack_ram) / 2, &nxt);\r\nif (rval == QLA_SUCCESS)\r\nrval = qla2xxx_dump_ram(ha, 0x11000, fw->data_ram,\r\nha->fw_memory_size - 0x11000 + 1, &nxt);\r\nif (rval == QLA_SUCCESS)\r\nqla2xxx_copy_queues(ha, nxt);\r\nqla2xxx_dump_post_process(base_vha, rval);\r\nqla2300_fw_dump_failed:\r\n#ifndef __CHECKER__\r\nif (!hardware_locked)\r\nspin_unlock_irqrestore(&ha->hardware_lock, flags);\r\n#else\r\n;\r\n#endif\r\n}\r\nvoid\r\nqla2100_fw_dump(scsi_qla_host_t *vha, int hardware_locked)\r\n{\r\nint rval;\r\nuint32_t cnt, timer;\r\nuint16_t risc_address;\r\nuint16_t mb0, mb2;\r\nstruct qla_hw_data *ha = vha->hw;\r\nstruct device_reg_2xxx __iomem *reg = &ha->iobase->isp;\r\nuint16_t __iomem *dmp_reg;\r\nunsigned long flags;\r\nstruct qla2100_fw_dump *fw;\r\nstruct scsi_qla_host *base_vha = pci_get_drvdata(ha->pdev);\r\nrisc_address = 0;\r\nmb0 = mb2 = 0;\r\nflags = 0;\r\n#ifndef __CHECKER__\r\nif (!hardware_locked)\r\nspin_lock_irqsave(&ha->hardware_lock, flags);\r\n#endif\r\nif (!ha->fw_dump) {\r\nql_log(ql_log_warn, vha, 0xd004,\r\n"No buffer available for dump.\n");\r\ngoto qla2100_fw_dump_failed;\r\n}\r\nif (ha->fw_dumped) {\r\nql_log(ql_log_warn, vha, 0xd005,\r\n"Firmware has been previously dumped (%p) "\r\n"-- ignoring request.\n",\r\nha->fw_dump);\r\ngoto qla2100_fw_dump_failed;\r\n}\r\nfw = &ha->fw_dump->isp.isp21;\r\nqla2xxx_prep_dump(ha, ha->fw_dump);\r\nrval = QLA_SUCCESS;\r\nfw->hccr = htons(RD_REG_WORD(&reg->hccr));\r\nWRT_REG_WORD(&reg->hccr, HCCR_PAUSE_RISC);\r\nfor (cnt = 30000; (RD_REG_WORD(&reg->hccr) & HCCR_RISC_PAUSE) == 0 &&\r\nrval == QLA_SUCCESS; cnt--) {\r\nif (cnt)\r\nudelay(100);\r\nelse\r\nrval = QLA_FUNCTION_TIMEOUT;\r\n}\r\nif (rval == QLA_SUCCESS) {\r\ndmp_reg = &reg->flash_address;\r\nfor (cnt = 0; cnt < sizeof(fw->pbiu_reg) / 2; cnt++)\r\nfw->pbiu_reg[cnt] = htons(RD_REG_WORD(dmp_reg++));\r\ndmp_reg = &reg->u.isp2100.mailbox0;\r\nfor (cnt = 0; cnt < ha->mbx_count; cnt++) {\r\nif (cnt == 8)\r\ndmp_reg = &reg->u_end.isp2200.mailbox8;\r\nfw->mailbox_reg[cnt] = htons(RD_REG_WORD(dmp_reg++));\r\n}\r\ndmp_reg = &reg->u.isp2100.unused_2[0];\r\nfor (cnt = 0; cnt < sizeof(fw->dma_reg) / 2; cnt++)\r\nfw->dma_reg[cnt] = htons(RD_REG_WORD(dmp_reg++));\r\nWRT_REG_WORD(&reg->ctrl_status, 0x00);\r\ndmp_reg = &reg->risc_hw;\r\nfor (cnt = 0; cnt < sizeof(fw->risc_hdw_reg) / 2; cnt++)\r\nfw->risc_hdw_reg[cnt] = htons(RD_REG_WORD(dmp_reg++));\r\nWRT_REG_WORD(&reg->pcr, 0x2000);\r\nqla2xxx_read_window(reg, 16, fw->risc_gp0_reg);\r\nWRT_REG_WORD(&reg->pcr, 0x2100);\r\nqla2xxx_read_window(reg, 16, fw->risc_gp1_reg);\r\nWRT_REG_WORD(&reg->pcr, 0x2200);\r\nqla2xxx_read_window(reg, 16, fw->risc_gp2_reg);\r\nWRT_REG_WORD(&reg->pcr, 0x2300);\r\nqla2xxx_read_window(reg, 16, fw->risc_gp3_reg);\r\nWRT_REG_WORD(&reg->pcr, 0x2400);\r\nqla2xxx_read_window(reg, 16, fw->risc_gp4_reg);\r\nWRT_REG_WORD(&reg->pcr, 0x2500);\r\nqla2xxx_read_window(reg, 16, fw->risc_gp5_reg);\r\nWRT_REG_WORD(&reg->pcr, 0x2600);\r\nqla2xxx_read_window(reg, 16, fw->risc_gp6_reg);\r\nWRT_REG_WORD(&reg->pcr, 0x2700);\r\nqla2xxx_read_window(reg, 16, fw->risc_gp7_reg);\r\nWRT_REG_WORD(&reg->ctrl_status, 0x10);\r\nqla2xxx_read_window(reg, 16, fw->frame_buf_hdw_reg);\r\nWRT_REG_WORD(&reg->ctrl_status, 0x20);\r\nqla2xxx_read_window(reg, 64, fw->fpm_b0_reg);\r\nWRT_REG_WORD(&reg->ctrl_status, 0x30);\r\nqla2xxx_read_window(reg, 64, fw->fpm_b1_reg);\r\nWRT_REG_WORD(&reg->ctrl_status, CSR_ISP_SOFT_RESET);\r\n}\r\nfor (cnt = 30000; RD_MAILBOX_REG(ha, reg, 0) != 0 &&\r\nrval == QLA_SUCCESS; cnt--) {\r\nif (cnt)\r\nudelay(100);\r\nelse\r\nrval = QLA_FUNCTION_TIMEOUT;\r\n}\r\nif (rval == QLA_SUCCESS && (IS_QLA2200(ha) || (IS_QLA2100(ha) &&\r\n(RD_REG_WORD(&reg->mctr) & (BIT_1 | BIT_0)) != 0))) {\r\nWRT_REG_WORD(&reg->hccr, HCCR_PAUSE_RISC);\r\nfor (cnt = 30000;\r\n(RD_REG_WORD(&reg->hccr) & HCCR_RISC_PAUSE) == 0 &&\r\nrval == QLA_SUCCESS; cnt--) {\r\nif (cnt)\r\nudelay(100);\r\nelse\r\nrval = QLA_FUNCTION_TIMEOUT;\r\n}\r\nif (rval == QLA_SUCCESS) {\r\nif (IS_QLA2100(ha))\r\nWRT_REG_WORD(&reg->mctr, 0xf1);\r\nelse\r\nWRT_REG_WORD(&reg->mctr, 0xf2);\r\nRD_REG_WORD(&reg->mctr);\r\nWRT_REG_WORD(&reg->hccr, HCCR_RELEASE_RISC);\r\n}\r\n}\r\nif (rval == QLA_SUCCESS) {\r\nrisc_address = 0x1000;\r\nWRT_MAILBOX_REG(ha, reg, 0, MBC_READ_RAM_WORD);\r\nclear_bit(MBX_INTERRUPT, &ha->mbx_cmd_flags);\r\n}\r\nfor (cnt = 0; cnt < sizeof(fw->risc_ram) / 2 && rval == QLA_SUCCESS;\r\ncnt++, risc_address++) {\r\nWRT_MAILBOX_REG(ha, reg, 1, risc_address);\r\nWRT_REG_WORD(&reg->hccr, HCCR_SET_HOST_INT);\r\nfor (timer = 6000000; timer != 0; timer--) {\r\nif (RD_REG_WORD(&reg->istatus) & ISR_RISC_INT) {\r\nif (RD_REG_WORD(&reg->semaphore) & BIT_0) {\r\nset_bit(MBX_INTERRUPT,\r\n&ha->mbx_cmd_flags);\r\nmb0 = RD_MAILBOX_REG(ha, reg, 0);\r\nmb2 = RD_MAILBOX_REG(ha, reg, 2);\r\nWRT_REG_WORD(&reg->semaphore, 0);\r\nWRT_REG_WORD(&reg->hccr,\r\nHCCR_CLR_RISC_INT);\r\nRD_REG_WORD(&reg->hccr);\r\nbreak;\r\n}\r\nWRT_REG_WORD(&reg->hccr, HCCR_CLR_RISC_INT);\r\nRD_REG_WORD(&reg->hccr);\r\n}\r\nudelay(5);\r\n}\r\nif (test_and_clear_bit(MBX_INTERRUPT, &ha->mbx_cmd_flags)) {\r\nrval = mb0 & MBS_MASK;\r\nfw->risc_ram[cnt] = htons(mb2);\r\n} else {\r\nrval = QLA_FUNCTION_FAILED;\r\n}\r\n}\r\nif (rval == QLA_SUCCESS)\r\nqla2xxx_copy_queues(ha, &fw->risc_ram[cnt]);\r\nqla2xxx_dump_post_process(base_vha, rval);\r\nqla2100_fw_dump_failed:\r\n#ifndef __CHECKER__\r\nif (!hardware_locked)\r\nspin_unlock_irqrestore(&ha->hardware_lock, flags);\r\n#else\r\n;\r\n#endif\r\n}\r\nvoid\r\nqla24xx_fw_dump(scsi_qla_host_t *vha, int hardware_locked)\r\n{\r\nint rval;\r\nuint32_t cnt;\r\nstruct qla_hw_data *ha = vha->hw;\r\nstruct device_reg_24xx __iomem *reg = &ha->iobase->isp24;\r\nuint32_t __iomem *dmp_reg;\r\nuint32_t *iter_reg;\r\nuint16_t __iomem *mbx_reg;\r\nunsigned long flags;\r\nstruct qla24xx_fw_dump *fw;\r\nvoid *nxt;\r\nvoid *nxt_chain;\r\nuint32_t *last_chain = NULL;\r\nstruct scsi_qla_host *base_vha = pci_get_drvdata(ha->pdev);\r\nif (IS_P3P_TYPE(ha))\r\nreturn;\r\nflags = 0;\r\nha->fw_dump_cap_flags = 0;\r\n#ifndef __CHECKER__\r\nif (!hardware_locked)\r\nspin_lock_irqsave(&ha->hardware_lock, flags);\r\n#endif\r\nif (!ha->fw_dump) {\r\nql_log(ql_log_warn, vha, 0xd006,\r\n"No buffer available for dump.\n");\r\ngoto qla24xx_fw_dump_failed;\r\n}\r\nif (ha->fw_dumped) {\r\nql_log(ql_log_warn, vha, 0xd007,\r\n"Firmware has been previously dumped (%p) "\r\n"-- ignoring request.\n",\r\nha->fw_dump);\r\ngoto qla24xx_fw_dump_failed;\r\n}\r\nfw = &ha->fw_dump->isp.isp24;\r\nqla2xxx_prep_dump(ha, ha->fw_dump);\r\nfw->host_status = htonl(RD_REG_DWORD(&reg->host_status));\r\nqla24xx_pause_risc(reg, ha);\r\ndmp_reg = &reg->flash_addr;\r\nfor (cnt = 0; cnt < sizeof(fw->host_reg) / 4; cnt++)\r\nfw->host_reg[cnt] = htonl(RD_REG_DWORD(dmp_reg++));\r\nWRT_REG_DWORD(&reg->ictrl, 0);\r\nRD_REG_DWORD(&reg->ictrl);\r\nWRT_REG_DWORD(&reg->iobase_addr, 0x0F70);\r\nRD_REG_DWORD(&reg->iobase_addr);\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0000000);\r\nfw->shadow_reg[0] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0100000);\r\nfw->shadow_reg[1] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0200000);\r\nfw->shadow_reg[2] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0300000);\r\nfw->shadow_reg[3] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0400000);\r\nfw->shadow_reg[4] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0500000);\r\nfw->shadow_reg[5] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0600000);\r\nfw->shadow_reg[6] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nmbx_reg = &reg->mailbox0;\r\nfor (cnt = 0; cnt < sizeof(fw->mailbox_reg) / 2; cnt++)\r\nfw->mailbox_reg[cnt] = htons(RD_REG_WORD(mbx_reg++));\r\niter_reg = fw->xseq_gp_reg;\r\niter_reg = qla24xx_read_window(reg, 0xBF00, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBF10, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBF20, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBF30, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBF40, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBF50, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBF60, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xBF70, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xBFE0, 16, fw->xseq_0_reg);\r\nqla24xx_read_window(reg, 0xBFF0, 16, fw->xseq_1_reg);\r\niter_reg = fw->rseq_gp_reg;\r\niter_reg = qla24xx_read_window(reg, 0xFF00, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFF10, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFF20, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFF30, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFF40, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFF50, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFF60, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xFF70, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xFFD0, 16, fw->rseq_0_reg);\r\nqla24xx_read_window(reg, 0xFFE0, 16, fw->rseq_1_reg);\r\nqla24xx_read_window(reg, 0xFFF0, 16, fw->rseq_2_reg);\r\nqla24xx_read_window(reg, 0x7100, 16, fw->cmd_dma_reg);\r\niter_reg = fw->req0_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7200, 8, iter_reg);\r\ndmp_reg = &reg->iobase_q;\r\nfor (cnt = 0; cnt < 7; cnt++)\r\n*iter_reg++ = htonl(RD_REG_DWORD(dmp_reg++));\r\niter_reg = fw->resp0_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7300, 8, iter_reg);\r\ndmp_reg = &reg->iobase_q;\r\nfor (cnt = 0; cnt < 7; cnt++)\r\n*iter_reg++ = htonl(RD_REG_DWORD(dmp_reg++));\r\niter_reg = fw->req1_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7400, 8, iter_reg);\r\ndmp_reg = &reg->iobase_q;\r\nfor (cnt = 0; cnt < 7; cnt++)\r\n*iter_reg++ = htonl(RD_REG_DWORD(dmp_reg++));\r\niter_reg = fw->xmt0_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7600, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7610, 16, iter_reg);\r\niter_reg = fw->xmt1_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7620, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7630, 16, iter_reg);\r\niter_reg = fw->xmt2_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7640, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7650, 16, iter_reg);\r\niter_reg = fw->xmt3_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7660, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7670, 16, iter_reg);\r\niter_reg = fw->xmt4_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7680, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7690, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x76A0, 16, fw->xmt_data_dma_reg);\r\niter_reg = fw->rcvt0_data_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7700, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7710, 16, iter_reg);\r\niter_reg = fw->rcvt1_data_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7720, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7730, 16, iter_reg);\r\niter_reg = fw->risc_gp_reg;\r\niter_reg = qla24xx_read_window(reg, 0x0F00, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x0F10, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x0F20, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x0F30, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x0F40, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x0F50, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x0F60, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x0F70, 16, iter_reg);\r\niter_reg = fw->lmc_reg;\r\niter_reg = qla24xx_read_window(reg, 0x3000, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x3010, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x3020, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x3030, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x3040, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x3050, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x3060, 16, iter_reg);\r\niter_reg = fw->fpm_hdw_reg;\r\niter_reg = qla24xx_read_window(reg, 0x4000, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4010, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4020, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4030, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4040, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4050, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4060, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4070, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4080, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4090, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x40A0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x40B0, 16, iter_reg);\r\niter_reg = fw->fb_hdw_reg;\r\niter_reg = qla24xx_read_window(reg, 0x6000, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6010, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6020, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6030, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6040, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6100, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6130, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6150, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6170, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6190, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x61B0, 16, iter_reg);\r\nrval = qla24xx_soft_reset(ha);\r\nif (rval != QLA_SUCCESS)\r\ngoto qla24xx_fw_dump_failed_0;\r\nrval = qla24xx_dump_memory(ha, fw->code_ram, sizeof(fw->code_ram),\r\n&nxt);\r\nif (rval != QLA_SUCCESS)\r\ngoto qla24xx_fw_dump_failed_0;\r\nnxt = qla2xxx_copy_queues(ha, nxt);\r\nqla24xx_copy_eft(ha, nxt);\r\nnxt_chain = (void *)ha->fw_dump + ha->chain_offset;\r\nnxt_chain = qla2xxx_copy_atioqueues(ha, nxt_chain, &last_chain);\r\nif (last_chain) {\r\nha->fw_dump->version |= htonl(DUMP_CHAIN_VARIANT);\r\n*last_chain |= htonl(DUMP_CHAIN_LAST);\r\n}\r\nha->fw_dump_len = (nxt_chain - (void *)ha->fw_dump);\r\nqla24xx_fw_dump_failed_0:\r\nqla2xxx_dump_post_process(base_vha, rval);\r\nqla24xx_fw_dump_failed:\r\n#ifndef __CHECKER__\r\nif (!hardware_locked)\r\nspin_unlock_irqrestore(&ha->hardware_lock, flags);\r\n#else\r\n;\r\n#endif\r\n}\r\nvoid\r\nqla25xx_fw_dump(scsi_qla_host_t *vha, int hardware_locked)\r\n{\r\nint rval;\r\nuint32_t cnt;\r\nstruct qla_hw_data *ha = vha->hw;\r\nstruct device_reg_24xx __iomem *reg = &ha->iobase->isp24;\r\nuint32_t __iomem *dmp_reg;\r\nuint32_t *iter_reg;\r\nuint16_t __iomem *mbx_reg;\r\nunsigned long flags;\r\nstruct qla25xx_fw_dump *fw;\r\nvoid *nxt, *nxt_chain;\r\nuint32_t *last_chain = NULL;\r\nstruct scsi_qla_host *base_vha = pci_get_drvdata(ha->pdev);\r\nflags = 0;\r\nha->fw_dump_cap_flags = 0;\r\n#ifndef __CHECKER__\r\nif (!hardware_locked)\r\nspin_lock_irqsave(&ha->hardware_lock, flags);\r\n#endif\r\nif (!ha->fw_dump) {\r\nql_log(ql_log_warn, vha, 0xd008,\r\n"No buffer available for dump.\n");\r\ngoto qla25xx_fw_dump_failed;\r\n}\r\nif (ha->fw_dumped) {\r\nql_log(ql_log_warn, vha, 0xd009,\r\n"Firmware has been previously dumped (%p) "\r\n"-- ignoring request.\n",\r\nha->fw_dump);\r\ngoto qla25xx_fw_dump_failed;\r\n}\r\nfw = &ha->fw_dump->isp.isp25;\r\nqla2xxx_prep_dump(ha, ha->fw_dump);\r\nha->fw_dump->version = htonl(2);\r\nfw->host_status = htonl(RD_REG_DWORD(&reg->host_status));\r\nqla24xx_pause_risc(reg, ha);\r\niter_reg = fw->host_risc_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7000, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7010, 16, iter_reg);\r\nWRT_REG_DWORD(&reg->iobase_addr, 0x7C00);\r\nRD_REG_DWORD(&reg->iobase_addr);\r\nWRT_REG_DWORD(&reg->iobase_window, 0x01);\r\ndmp_reg = &reg->iobase_c4;\r\nfw->pcie_regs[0] = htonl(RD_REG_DWORD(dmp_reg++));\r\nfw->pcie_regs[1] = htonl(RD_REG_DWORD(dmp_reg++));\r\nfw->pcie_regs[2] = htonl(RD_REG_DWORD(dmp_reg));\r\nfw->pcie_regs[3] = htonl(RD_REG_DWORD(&reg->iobase_window));\r\nWRT_REG_DWORD(&reg->iobase_window, 0x00);\r\nRD_REG_DWORD(&reg->iobase_window);\r\ndmp_reg = &reg->flash_addr;\r\nfor (cnt = 0; cnt < sizeof(fw->host_reg) / 4; cnt++)\r\nfw->host_reg[cnt] = htonl(RD_REG_DWORD(dmp_reg++));\r\nWRT_REG_DWORD(&reg->ictrl, 0);\r\nRD_REG_DWORD(&reg->ictrl);\r\nWRT_REG_DWORD(&reg->iobase_addr, 0x0F70);\r\nRD_REG_DWORD(&reg->iobase_addr);\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0000000);\r\nfw->shadow_reg[0] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0100000);\r\nfw->shadow_reg[1] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0200000);\r\nfw->shadow_reg[2] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0300000);\r\nfw->shadow_reg[3] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0400000);\r\nfw->shadow_reg[4] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0500000);\r\nfw->shadow_reg[5] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0600000);\r\nfw->shadow_reg[6] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0700000);\r\nfw->shadow_reg[7] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0800000);\r\nfw->shadow_reg[8] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0900000);\r\nfw->shadow_reg[9] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0A00000);\r\nfw->shadow_reg[10] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_addr, 0x0010);\r\nfw->risc_io_reg = htonl(RD_REG_DWORD(&reg->iobase_window));\r\nmbx_reg = &reg->mailbox0;\r\nfor (cnt = 0; cnt < sizeof(fw->mailbox_reg) / 2; cnt++)\r\nfw->mailbox_reg[cnt] = htons(RD_REG_WORD(mbx_reg++));\r\niter_reg = fw->xseq_gp_reg;\r\niter_reg = qla24xx_read_window(reg, 0xBF00, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBF10, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBF20, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBF30, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBF40, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBF50, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBF60, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xBF70, 16, iter_reg);\r\niter_reg = fw->xseq_0_reg;\r\niter_reg = qla24xx_read_window(reg, 0xBFC0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBFD0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xBFE0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xBFF0, 16, fw->xseq_1_reg);\r\niter_reg = fw->rseq_gp_reg;\r\niter_reg = qla24xx_read_window(reg, 0xFF00, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFF10, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFF20, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFF30, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFF40, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFF50, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFF60, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xFF70, 16, iter_reg);\r\niter_reg = fw->rseq_0_reg;\r\niter_reg = qla24xx_read_window(reg, 0xFFC0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xFFD0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xFFE0, 16, fw->rseq_1_reg);\r\nqla24xx_read_window(reg, 0xFFF0, 16, fw->rseq_2_reg);\r\niter_reg = fw->aseq_gp_reg;\r\niter_reg = qla24xx_read_window(reg, 0xB000, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xB010, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xB020, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xB030, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xB040, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xB050, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xB060, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xB070, 16, iter_reg);\r\niter_reg = fw->aseq_0_reg;\r\niter_reg = qla24xx_read_window(reg, 0xB0C0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xB0D0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xB0E0, 16, fw->aseq_1_reg);\r\nqla24xx_read_window(reg, 0xB0F0, 16, fw->aseq_2_reg);\r\nqla24xx_read_window(reg, 0x7100, 16, fw->cmd_dma_reg);\r\niter_reg = fw->req0_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7200, 8, iter_reg);\r\ndmp_reg = &reg->iobase_q;\r\nfor (cnt = 0; cnt < 7; cnt++)\r\n*iter_reg++ = htonl(RD_REG_DWORD(dmp_reg++));\r\niter_reg = fw->resp0_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7300, 8, iter_reg);\r\ndmp_reg = &reg->iobase_q;\r\nfor (cnt = 0; cnt < 7; cnt++)\r\n*iter_reg++ = htonl(RD_REG_DWORD(dmp_reg++));\r\niter_reg = fw->req1_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7400, 8, iter_reg);\r\ndmp_reg = &reg->iobase_q;\r\nfor (cnt = 0; cnt < 7; cnt++)\r\n*iter_reg++ = htonl(RD_REG_DWORD(dmp_reg++));\r\niter_reg = fw->xmt0_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7600, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7610, 16, iter_reg);\r\niter_reg = fw->xmt1_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7620, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7630, 16, iter_reg);\r\niter_reg = fw->xmt2_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7640, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7650, 16, iter_reg);\r\niter_reg = fw->xmt3_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7660, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7670, 16, iter_reg);\r\niter_reg = fw->xmt4_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7680, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7690, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x76A0, 16, fw->xmt_data_dma_reg);\r\niter_reg = fw->rcvt0_data_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7700, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7710, 16, iter_reg);\r\niter_reg = fw->rcvt1_data_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7720, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7730, 16, iter_reg);\r\niter_reg = fw->risc_gp_reg;\r\niter_reg = qla24xx_read_window(reg, 0x0F00, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x0F10, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x0F20, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x0F30, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x0F40, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x0F50, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x0F60, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x0F70, 16, iter_reg);\r\niter_reg = fw->lmc_reg;\r\niter_reg = qla24xx_read_window(reg, 0x3000, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x3010, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x3020, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x3030, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x3040, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x3050, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x3060, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x3070, 16, iter_reg);\r\niter_reg = fw->fpm_hdw_reg;\r\niter_reg = qla24xx_read_window(reg, 0x4000, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4010, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4020, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4030, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4040, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4050, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4060, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4070, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4080, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4090, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x40A0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x40B0, 16, iter_reg);\r\niter_reg = fw->fb_hdw_reg;\r\niter_reg = qla24xx_read_window(reg, 0x6000, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6010, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6020, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6030, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6040, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6100, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6130, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6150, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6170, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6190, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x61B0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x6F00, 16, iter_reg);\r\nnxt_chain = qla25xx_copy_mq(ha, (void *)ha->fw_dump + ha->chain_offset,\r\n&last_chain);\r\nrval = qla24xx_soft_reset(ha);\r\nif (rval != QLA_SUCCESS)\r\ngoto qla25xx_fw_dump_failed_0;\r\nrval = qla24xx_dump_memory(ha, fw->code_ram, sizeof(fw->code_ram),\r\n&nxt);\r\nif (rval != QLA_SUCCESS)\r\ngoto qla25xx_fw_dump_failed_0;\r\nnxt = qla2xxx_copy_queues(ha, nxt);\r\nqla24xx_copy_eft(ha, nxt);\r\nnxt_chain = qla25xx_copy_fce(ha, nxt_chain, &last_chain);\r\nnxt_chain = qla25xx_copy_mqueues(ha, nxt_chain, &last_chain);\r\nnxt_chain = qla2xxx_copy_atioqueues(ha, nxt_chain, &last_chain);\r\nif (last_chain) {\r\nha->fw_dump->version |= htonl(DUMP_CHAIN_VARIANT);\r\n*last_chain |= htonl(DUMP_CHAIN_LAST);\r\n}\r\nha->fw_dump_len = (nxt_chain - (void *)ha->fw_dump);\r\nqla25xx_fw_dump_failed_0:\r\nqla2xxx_dump_post_process(base_vha, rval);\r\nqla25xx_fw_dump_failed:\r\n#ifndef __CHECKER__\r\nif (!hardware_locked)\r\nspin_unlock_irqrestore(&ha->hardware_lock, flags);\r\n#else\r\n;\r\n#endif\r\n}\r\nvoid\r\nqla81xx_fw_dump(scsi_qla_host_t *vha, int hardware_locked)\r\n{\r\nint rval;\r\nuint32_t cnt;\r\nstruct qla_hw_data *ha = vha->hw;\r\nstruct device_reg_24xx __iomem *reg = &ha->iobase->isp24;\r\nuint32_t __iomem *dmp_reg;\r\nuint32_t *iter_reg;\r\nuint16_t __iomem *mbx_reg;\r\nunsigned long flags;\r\nstruct qla81xx_fw_dump *fw;\r\nvoid *nxt, *nxt_chain;\r\nuint32_t *last_chain = NULL;\r\nstruct scsi_qla_host *base_vha = pci_get_drvdata(ha->pdev);\r\nflags = 0;\r\nha->fw_dump_cap_flags = 0;\r\n#ifndef __CHECKER__\r\nif (!hardware_locked)\r\nspin_lock_irqsave(&ha->hardware_lock, flags);\r\n#endif\r\nif (!ha->fw_dump) {\r\nql_log(ql_log_warn, vha, 0xd00a,\r\n"No buffer available for dump.\n");\r\ngoto qla81xx_fw_dump_failed;\r\n}\r\nif (ha->fw_dumped) {\r\nql_log(ql_log_warn, vha, 0xd00b,\r\n"Firmware has been previously dumped (%p) "\r\n"-- ignoring request.\n",\r\nha->fw_dump);\r\ngoto qla81xx_fw_dump_failed;\r\n}\r\nfw = &ha->fw_dump->isp.isp81;\r\nqla2xxx_prep_dump(ha, ha->fw_dump);\r\nfw->host_status = htonl(RD_REG_DWORD(&reg->host_status));\r\nqla24xx_pause_risc(reg, ha);\r\niter_reg = fw->host_risc_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7000, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7010, 16, iter_reg);\r\nWRT_REG_DWORD(&reg->iobase_addr, 0x7C00);\r\nRD_REG_DWORD(&reg->iobase_addr);\r\nWRT_REG_DWORD(&reg->iobase_window, 0x01);\r\ndmp_reg = &reg->iobase_c4;\r\nfw->pcie_regs[0] = htonl(RD_REG_DWORD(dmp_reg++));\r\nfw->pcie_regs[1] = htonl(RD_REG_DWORD(dmp_reg++));\r\nfw->pcie_regs[2] = htonl(RD_REG_DWORD(dmp_reg));\r\nfw->pcie_regs[3] = htonl(RD_REG_DWORD(&reg->iobase_window));\r\nWRT_REG_DWORD(&reg->iobase_window, 0x00);\r\nRD_REG_DWORD(&reg->iobase_window);\r\ndmp_reg = &reg->flash_addr;\r\nfor (cnt = 0; cnt < sizeof(fw->host_reg) / 4; cnt++)\r\nfw->host_reg[cnt] = htonl(RD_REG_DWORD(dmp_reg++));\r\nWRT_REG_DWORD(&reg->ictrl, 0);\r\nRD_REG_DWORD(&reg->ictrl);\r\nWRT_REG_DWORD(&reg->iobase_addr, 0x0F70);\r\nRD_REG_DWORD(&reg->iobase_addr);\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0000000);\r\nfw->shadow_reg[0] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0100000);\r\nfw->shadow_reg[1] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0200000);\r\nfw->shadow_reg[2] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0300000);\r\nfw->shadow_reg[3] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0400000);\r\nfw->shadow_reg[4] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0500000);\r\nfw->shadow_reg[5] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0600000);\r\nfw->shadow_reg[6] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0700000);\r\nfw->shadow_reg[7] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0800000);\r\nfw->shadow_reg[8] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0900000);\r\nfw->shadow_reg[9] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0A00000);\r\nfw->shadow_reg[10] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_addr, 0x0010);\r\nfw->risc_io_reg = htonl(RD_REG_DWORD(&reg->iobase_window));\r\nmbx_reg = &reg->mailbox0;\r\nfor (cnt = 0; cnt < sizeof(fw->mailbox_reg) / 2; cnt++)\r\nfw->mailbox_reg[cnt] = htons(RD_REG_WORD(mbx_reg++));\r\niter_reg = fw->xseq_gp_reg;\r\niter_reg = qla24xx_read_window(reg, 0xBF00, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBF10, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBF20, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBF30, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBF40, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBF50, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBF60, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xBF70, 16, iter_reg);\r\niter_reg = fw->xseq_0_reg;\r\niter_reg = qla24xx_read_window(reg, 0xBFC0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBFD0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xBFE0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xBFF0, 16, fw->xseq_1_reg);\r\niter_reg = fw->rseq_gp_reg;\r\niter_reg = qla24xx_read_window(reg, 0xFF00, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFF10, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFF20, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFF30, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFF40, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFF50, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFF60, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xFF70, 16, iter_reg);\r\niter_reg = fw->rseq_0_reg;\r\niter_reg = qla24xx_read_window(reg, 0xFFC0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xFFD0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xFFE0, 16, fw->rseq_1_reg);\r\nqla24xx_read_window(reg, 0xFFF0, 16, fw->rseq_2_reg);\r\niter_reg = fw->aseq_gp_reg;\r\niter_reg = qla24xx_read_window(reg, 0xB000, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xB010, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xB020, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xB030, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xB040, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xB050, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xB060, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xB070, 16, iter_reg);\r\niter_reg = fw->aseq_0_reg;\r\niter_reg = qla24xx_read_window(reg, 0xB0C0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xB0D0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xB0E0, 16, fw->aseq_1_reg);\r\nqla24xx_read_window(reg, 0xB0F0, 16, fw->aseq_2_reg);\r\nqla24xx_read_window(reg, 0x7100, 16, fw->cmd_dma_reg);\r\niter_reg = fw->req0_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7200, 8, iter_reg);\r\ndmp_reg = &reg->iobase_q;\r\nfor (cnt = 0; cnt < 7; cnt++)\r\n*iter_reg++ = htonl(RD_REG_DWORD(dmp_reg++));\r\niter_reg = fw->resp0_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7300, 8, iter_reg);\r\ndmp_reg = &reg->iobase_q;\r\nfor (cnt = 0; cnt < 7; cnt++)\r\n*iter_reg++ = htonl(RD_REG_DWORD(dmp_reg++));\r\niter_reg = fw->req1_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7400, 8, iter_reg);\r\ndmp_reg = &reg->iobase_q;\r\nfor (cnt = 0; cnt < 7; cnt++)\r\n*iter_reg++ = htonl(RD_REG_DWORD(dmp_reg++));\r\niter_reg = fw->xmt0_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7600, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7610, 16, iter_reg);\r\niter_reg = fw->xmt1_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7620, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7630, 16, iter_reg);\r\niter_reg = fw->xmt2_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7640, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7650, 16, iter_reg);\r\niter_reg = fw->xmt3_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7660, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7670, 16, iter_reg);\r\niter_reg = fw->xmt4_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7680, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7690, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x76A0, 16, fw->xmt_data_dma_reg);\r\niter_reg = fw->rcvt0_data_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7700, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7710, 16, iter_reg);\r\niter_reg = fw->rcvt1_data_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7720, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7730, 16, iter_reg);\r\niter_reg = fw->risc_gp_reg;\r\niter_reg = qla24xx_read_window(reg, 0x0F00, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x0F10, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x0F20, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x0F30, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x0F40, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x0F50, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x0F60, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x0F70, 16, iter_reg);\r\niter_reg = fw->lmc_reg;\r\niter_reg = qla24xx_read_window(reg, 0x3000, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x3010, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x3020, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x3030, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x3040, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x3050, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x3060, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x3070, 16, iter_reg);\r\niter_reg = fw->fpm_hdw_reg;\r\niter_reg = qla24xx_read_window(reg, 0x4000, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4010, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4020, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4030, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4040, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4050, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4060, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4070, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4080, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4090, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x40A0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x40B0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x40C0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x40D0, 16, iter_reg);\r\niter_reg = fw->fb_hdw_reg;\r\niter_reg = qla24xx_read_window(reg, 0x6000, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6010, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6020, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6030, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6040, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6100, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6130, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6150, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6170, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6190, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x61B0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x61C0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x6F00, 16, iter_reg);\r\nnxt_chain = qla25xx_copy_mq(ha, (void *)ha->fw_dump + ha->chain_offset,\r\n&last_chain);\r\nrval = qla24xx_soft_reset(ha);\r\nif (rval != QLA_SUCCESS)\r\ngoto qla81xx_fw_dump_failed_0;\r\nrval = qla24xx_dump_memory(ha, fw->code_ram, sizeof(fw->code_ram),\r\n&nxt);\r\nif (rval != QLA_SUCCESS)\r\ngoto qla81xx_fw_dump_failed_0;\r\nnxt = qla2xxx_copy_queues(ha, nxt);\r\nqla24xx_copy_eft(ha, nxt);\r\nnxt_chain = qla25xx_copy_fce(ha, nxt_chain, &last_chain);\r\nnxt_chain = qla25xx_copy_mqueues(ha, nxt_chain, &last_chain);\r\nnxt_chain = qla2xxx_copy_atioqueues(ha, nxt_chain, &last_chain);\r\nif (last_chain) {\r\nha->fw_dump->version |= htonl(DUMP_CHAIN_VARIANT);\r\n*last_chain |= htonl(DUMP_CHAIN_LAST);\r\n}\r\nha->fw_dump_len = (nxt_chain - (void *)ha->fw_dump);\r\nqla81xx_fw_dump_failed_0:\r\nqla2xxx_dump_post_process(base_vha, rval);\r\nqla81xx_fw_dump_failed:\r\n#ifndef __CHECKER__\r\nif (!hardware_locked)\r\nspin_unlock_irqrestore(&ha->hardware_lock, flags);\r\n#else\r\n;\r\n#endif\r\n}\r\nvoid\r\nqla83xx_fw_dump(scsi_qla_host_t *vha, int hardware_locked)\r\n{\r\nint rval;\r\nuint32_t cnt;\r\nstruct qla_hw_data *ha = vha->hw;\r\nstruct device_reg_24xx __iomem *reg = &ha->iobase->isp24;\r\nuint32_t __iomem *dmp_reg;\r\nuint32_t *iter_reg;\r\nuint16_t __iomem *mbx_reg;\r\nunsigned long flags;\r\nstruct qla83xx_fw_dump *fw;\r\nvoid *nxt, *nxt_chain;\r\nuint32_t *last_chain = NULL;\r\nstruct scsi_qla_host *base_vha = pci_get_drvdata(ha->pdev);\r\nflags = 0;\r\nha->fw_dump_cap_flags = 0;\r\n#ifndef __CHECKER__\r\nif (!hardware_locked)\r\nspin_lock_irqsave(&ha->hardware_lock, flags);\r\n#endif\r\nif (!ha->fw_dump) {\r\nql_log(ql_log_warn, vha, 0xd00c,\r\n"No buffer available for dump!!!\n");\r\ngoto qla83xx_fw_dump_failed;\r\n}\r\nif (ha->fw_dumped) {\r\nql_log(ql_log_warn, vha, 0xd00d,\r\n"Firmware has been previously dumped (%p) -- ignoring "\r\n"request...\n", ha->fw_dump);\r\ngoto qla83xx_fw_dump_failed;\r\n}\r\nfw = &ha->fw_dump->isp.isp83;\r\nqla2xxx_prep_dump(ha, ha->fw_dump);\r\nfw->host_status = htonl(RD_REG_DWORD(&reg->host_status));\r\nqla24xx_pause_risc(reg, ha);\r\nWRT_REG_DWORD(&reg->iobase_addr, 0x6000);\r\ndmp_reg = &reg->iobase_window;\r\nRD_REG_DWORD(dmp_reg);\r\nWRT_REG_DWORD(dmp_reg, 0);\r\ndmp_reg = &reg->unused_4_1[0];\r\nRD_REG_DWORD(dmp_reg);\r\nWRT_REG_DWORD(dmp_reg, 0);\r\nWRT_REG_DWORD(&reg->iobase_addr, 0x6010);\r\ndmp_reg = &reg->unused_4_1[2];\r\nRD_REG_DWORD(dmp_reg);\r\nWRT_REG_DWORD(dmp_reg, 0);\r\nWRT_REG_DWORD(&reg->iobase_addr, 0x0F70);\r\nRD_REG_DWORD(&reg->iobase_addr);\r\nWRT_REG_DWORD(&reg->iobase_select, 0x60000000);\r\niter_reg = fw->host_risc_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7000, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x7010, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7040, 16, iter_reg);\r\nWRT_REG_DWORD(&reg->iobase_addr, 0x7C00);\r\nRD_REG_DWORD(&reg->iobase_addr);\r\nWRT_REG_DWORD(&reg->iobase_window, 0x01);\r\ndmp_reg = &reg->iobase_c4;\r\nfw->pcie_regs[0] = htonl(RD_REG_DWORD(dmp_reg++));\r\nfw->pcie_regs[1] = htonl(RD_REG_DWORD(dmp_reg++));\r\nfw->pcie_regs[2] = htonl(RD_REG_DWORD(dmp_reg));\r\nfw->pcie_regs[3] = htonl(RD_REG_DWORD(&reg->iobase_window));\r\nWRT_REG_DWORD(&reg->iobase_window, 0x00);\r\nRD_REG_DWORD(&reg->iobase_window);\r\ndmp_reg = &reg->flash_addr;\r\nfor (cnt = 0; cnt < sizeof(fw->host_reg) / 4; cnt++)\r\nfw->host_reg[cnt] = htonl(RD_REG_DWORD(dmp_reg++));\r\nWRT_REG_DWORD(&reg->ictrl, 0);\r\nRD_REG_DWORD(&reg->ictrl);\r\nWRT_REG_DWORD(&reg->iobase_addr, 0x0F70);\r\nRD_REG_DWORD(&reg->iobase_addr);\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0000000);\r\nfw->shadow_reg[0] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0100000);\r\nfw->shadow_reg[1] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0200000);\r\nfw->shadow_reg[2] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0300000);\r\nfw->shadow_reg[3] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0400000);\r\nfw->shadow_reg[4] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0500000);\r\nfw->shadow_reg[5] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0600000);\r\nfw->shadow_reg[6] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0700000);\r\nfw->shadow_reg[7] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0800000);\r\nfw->shadow_reg[8] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0900000);\r\nfw->shadow_reg[9] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_select, 0xB0A00000);\r\nfw->shadow_reg[10] = htonl(RD_REG_DWORD(&reg->iobase_sdata));\r\nWRT_REG_DWORD(&reg->iobase_addr, 0x0010);\r\nfw->risc_io_reg = htonl(RD_REG_DWORD(&reg->iobase_window));\r\nmbx_reg = &reg->mailbox0;\r\nfor (cnt = 0; cnt < sizeof(fw->mailbox_reg) / 2; cnt++)\r\nfw->mailbox_reg[cnt] = htons(RD_REG_WORD(mbx_reg++));\r\niter_reg = fw->xseq_gp_reg;\r\niter_reg = qla24xx_read_window(reg, 0xBE00, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBE10, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBE20, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBE30, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBE40, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBE50, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBE60, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBE70, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBF00, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBF10, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBF20, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBF30, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBF40, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBF50, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBF60, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xBF70, 16, iter_reg);\r\niter_reg = fw->xseq_0_reg;\r\niter_reg = qla24xx_read_window(reg, 0xBFC0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xBFD0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xBFE0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xBFF0, 16, fw->xseq_1_reg);\r\nqla24xx_read_window(reg, 0xBEF0, 16, fw->xseq_2_reg);\r\niter_reg = fw->rseq_gp_reg;\r\niter_reg = qla24xx_read_window(reg, 0xFE00, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFE10, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFE20, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFE30, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFE40, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFE50, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFE60, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFE70, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFF00, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFF10, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFF20, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFF30, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFF40, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFF50, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xFF60, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xFF70, 16, iter_reg);\r\niter_reg = fw->rseq_0_reg;\r\niter_reg = qla24xx_read_window(reg, 0xFFC0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xFFD0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xFFE0, 16, fw->rseq_1_reg);\r\nqla24xx_read_window(reg, 0xFFF0, 16, fw->rseq_2_reg);\r\nqla24xx_read_window(reg, 0xFEF0, 16, fw->rseq_3_reg);\r\niter_reg = fw->aseq_gp_reg;\r\niter_reg = qla24xx_read_window(reg, 0xB000, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xB010, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xB020, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xB030, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xB040, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xB050, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xB060, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xB070, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xB100, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xB110, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xB120, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xB130, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xB140, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xB150, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0xB160, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xB170, 16, iter_reg);\r\niter_reg = fw->aseq_0_reg;\r\niter_reg = qla24xx_read_window(reg, 0xB0C0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xB0D0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0xB0E0, 16, fw->aseq_1_reg);\r\nqla24xx_read_window(reg, 0xB0F0, 16, fw->aseq_2_reg);\r\nqla24xx_read_window(reg, 0xB1F0, 16, fw->aseq_3_reg);\r\niter_reg = fw->cmd_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7100, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x7120, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x7130, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x71F0, 16, iter_reg);\r\niter_reg = fw->req0_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7200, 8, iter_reg);\r\ndmp_reg = &reg->iobase_q;\r\nfor (cnt = 0; cnt < 7; cnt++)\r\n*iter_reg++ = htonl(RD_REG_DWORD(dmp_reg++));\r\niter_reg = fw->resp0_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7300, 8, iter_reg);\r\ndmp_reg = &reg->iobase_q;\r\nfor (cnt = 0; cnt < 7; cnt++)\r\n*iter_reg++ = htonl(RD_REG_DWORD(dmp_reg++));\r\niter_reg = fw->req1_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7400, 8, iter_reg);\r\ndmp_reg = &reg->iobase_q;\r\nfor (cnt = 0; cnt < 7; cnt++)\r\n*iter_reg++ = htonl(RD_REG_DWORD(dmp_reg++));\r\niter_reg = fw->xmt0_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7600, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7610, 16, iter_reg);\r\niter_reg = fw->xmt1_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7620, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7630, 16, iter_reg);\r\niter_reg = fw->xmt2_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7640, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7650, 16, iter_reg);\r\niter_reg = fw->xmt3_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7660, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7670, 16, iter_reg);\r\niter_reg = fw->xmt4_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7680, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7690, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x76A0, 16, fw->xmt_data_dma_reg);\r\niter_reg = fw->rcvt0_data_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7700, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7710, 16, iter_reg);\r\niter_reg = fw->rcvt1_data_dma_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7720, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7730, 16, iter_reg);\r\niter_reg = fw->risc_gp_reg;\r\niter_reg = qla24xx_read_window(reg, 0x0F00, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x0F10, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x0F20, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x0F30, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x0F40, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x0F50, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x0F60, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x0F70, 16, iter_reg);\r\niter_reg = fw->lmc_reg;\r\niter_reg = qla24xx_read_window(reg, 0x3000, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x3010, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x3020, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x3030, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x3040, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x3050, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x3060, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x3070, 16, iter_reg);\r\niter_reg = fw->fpm_hdw_reg;\r\niter_reg = qla24xx_read_window(reg, 0x4000, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4010, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4020, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4030, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4040, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4050, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4060, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4070, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4080, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x4090, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x40A0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x40B0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x40C0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x40D0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x40E0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x40F0, 16, iter_reg);\r\niter_reg = fw->rq0_array_reg;\r\niter_reg = qla24xx_read_window(reg, 0x5C00, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5C10, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5C20, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5C30, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5C40, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5C50, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5C60, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5C70, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5C80, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5C90, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5CA0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5CB0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5CC0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5CD0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5CE0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x5CF0, 16, iter_reg);\r\niter_reg = fw->rq1_array_reg;\r\niter_reg = qla24xx_read_window(reg, 0x5D00, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5D10, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5D20, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5D30, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5D40, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5D50, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5D60, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5D70, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5D80, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5D90, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5DA0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5DB0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5DC0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5DD0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5DE0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x5DF0, 16, iter_reg);\r\niter_reg = fw->rp0_array_reg;\r\niter_reg = qla24xx_read_window(reg, 0x5E00, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5E10, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5E20, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5E30, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5E40, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5E50, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5E60, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5E70, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5E80, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5E90, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5EA0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5EB0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5EC0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5ED0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5EE0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x5EF0, 16, iter_reg);\r\niter_reg = fw->rp1_array_reg;\r\niter_reg = qla24xx_read_window(reg, 0x5F00, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5F10, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5F20, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5F30, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5F40, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5F50, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5F60, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5F70, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5F80, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5F90, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5FA0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5FB0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5FC0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5FD0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x5FE0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x5FF0, 16, iter_reg);\r\niter_reg = fw->at0_array_reg;\r\niter_reg = qla24xx_read_window(reg, 0x7080, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x7090, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x70A0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x70B0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x70C0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x70D0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x70E0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x70F0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x7800, 16, fw->queue_control_reg);\r\niter_reg = fw->fb_hdw_reg;\r\niter_reg = qla24xx_read_window(reg, 0x6000, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6010, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6020, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6030, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6040, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6060, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6070, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6100, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6130, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6150, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6170, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6190, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x61B0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x61C0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6530, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6540, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6550, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6560, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6570, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6580, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x6590, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x65A0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x65B0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x65C0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x65D0, 16, iter_reg);\r\niter_reg = qla24xx_read_window(reg, 0x65E0, 16, iter_reg);\r\nqla24xx_read_window(reg, 0x6F00, 16, iter_reg);\r\nnxt_chain = qla25xx_copy_mq(ha, (void *)ha->fw_dump + ha->chain_offset,\r\n&last_chain);\r\nrval = qla24xx_soft_reset(ha);\r\nif (rval != QLA_SUCCESS) {\r\nql_log(ql_log_warn, vha, 0xd00e,\r\n"SOFT RESET FAILED, forcing continuation of dump!!!\n");\r\nrval = QLA_SUCCESS;\r\nql_log(ql_log_warn, vha, 0xd00f, "try a bigger hammer!!!\n");\r\nWRT_REG_DWORD(&reg->hccr, HCCRX_SET_RISC_RESET);\r\nRD_REG_DWORD(&reg->hccr);\r\nWRT_REG_DWORD(&reg->hccr, HCCRX_REL_RISC_PAUSE);\r\nRD_REG_DWORD(&reg->hccr);\r\nWRT_REG_DWORD(&reg->hccr, HCCRX_CLR_RISC_RESET);\r\nRD_REG_DWORD(&reg->hccr);\r\nfor (cnt = 30000; cnt && (RD_REG_WORD(&reg->mailbox0)); cnt--)\r\nudelay(5);\r\nif (!cnt) {\r\nnxt = fw->code_ram;\r\nnxt += sizeof(fw->code_ram);\r\nnxt += (ha->fw_memory_size - 0x100000 + 1);\r\ngoto copy_queue;\r\n} else {\r\nset_bit(RISC_RDY_AFT_RESET, &ha->fw_dump_cap_flags);\r\nql_log(ql_log_warn, vha, 0xd010,\r\n"bigger hammer success?\n");\r\n}\r\n}\r\nrval = qla24xx_dump_memory(ha, fw->code_ram, sizeof(fw->code_ram),\r\n&nxt);\r\nif (rval != QLA_SUCCESS)\r\ngoto qla83xx_fw_dump_failed_0;\r\ncopy_queue:\r\nnxt = qla2xxx_copy_queues(ha, nxt);\r\nqla24xx_copy_eft(ha, nxt);\r\nnxt_chain = qla25xx_copy_fce(ha, nxt_chain, &last_chain);\r\nnxt_chain = qla25xx_copy_mqueues(ha, nxt_chain, &last_chain);\r\nnxt_chain = qla2xxx_copy_atioqueues(ha, nxt_chain, &last_chain);\r\nif (last_chain) {\r\nha->fw_dump->version |= htonl(DUMP_CHAIN_VARIANT);\r\n*last_chain |= htonl(DUMP_CHAIN_LAST);\r\n}\r\nha->fw_dump_len = (nxt_chain - (void *)ha->fw_dump);\r\nqla83xx_fw_dump_failed_0:\r\nqla2xxx_dump_post_process(base_vha, rval);\r\nqla83xx_fw_dump_failed:\r\n#ifndef __CHECKER__\r\nif (!hardware_locked)\r\nspin_unlock_irqrestore(&ha->hardware_lock, flags);\r\n#else\r\n;\r\n#endif\r\n}\r\nstatic inline int\r\nql_mask_match(uint32_t level)\r\n{\r\nif (ql2xextended_error_logging == 1)\r\nql2xextended_error_logging = QL_DBG_DEFAULT1_MASK;\r\nreturn (level & ql2xextended_error_logging) == level;\r\n}\r\nvoid\r\nql_dbg(uint32_t level, scsi_qla_host_t *vha, int32_t id, const char *fmt, ...)\r\n{\r\nva_list va;\r\nstruct va_format vaf;\r\nif (!ql_mask_match(level))\r\nreturn;\r\nva_start(va, fmt);\r\nvaf.fmt = fmt;\r\nvaf.va = &va;\r\nif (vha != NULL) {\r\nconst struct pci_dev *pdev = vha->hw->pdev;\r\npr_warn("%s [%s]-%04x:%ld: %pV",\r\nQL_MSGHDR, dev_name(&(pdev->dev)), id + ql_dbg_offset,\r\nvha->host_no, &vaf);\r\n} else {\r\npr_warn("%s [%s]-%04x: : %pV",\r\nQL_MSGHDR, "0000:00:00.0", id + ql_dbg_offset, &vaf);\r\n}\r\nva_end(va);\r\n}\r\nvoid\r\nql_dbg_pci(uint32_t level, struct pci_dev *pdev, int32_t id,\r\nconst char *fmt, ...)\r\n{\r\nva_list va;\r\nstruct va_format vaf;\r\nif (pdev == NULL)\r\nreturn;\r\nif (!ql_mask_match(level))\r\nreturn;\r\nva_start(va, fmt);\r\nvaf.fmt = fmt;\r\nvaf.va = &va;\r\npr_warn("%s [%s]-%04x: : %pV",\r\nQL_MSGHDR, dev_name(&(pdev->dev)), id + ql_dbg_offset, &vaf);\r\nva_end(va);\r\n}\r\nvoid\r\nql_log(uint32_t level, scsi_qla_host_t *vha, int32_t id, const char *fmt, ...)\r\n{\r\nva_list va;\r\nstruct va_format vaf;\r\nchar pbuf[128];\r\nif (level > ql_errlev)\r\nreturn;\r\nif (vha != NULL) {\r\nconst struct pci_dev *pdev = vha->hw->pdev;\r\nsnprintf(pbuf, sizeof(pbuf), "%s [%s]-%04x:%ld: ",\r\nQL_MSGHDR, dev_name(&(pdev->dev)), id, vha->host_no);\r\n} else {\r\nsnprintf(pbuf, sizeof(pbuf), "%s [%s]-%04x: : ",\r\nQL_MSGHDR, "0000:00:00.0", id);\r\n}\r\npbuf[sizeof(pbuf) - 1] = 0;\r\nva_start(va, fmt);\r\nvaf.fmt = fmt;\r\nvaf.va = &va;\r\nswitch (level) {\r\ncase ql_log_fatal:\r\npr_crit("%s%pV", pbuf, &vaf);\r\nbreak;\r\ncase ql_log_warn:\r\npr_err("%s%pV", pbuf, &vaf);\r\nbreak;\r\ncase ql_log_info:\r\npr_warn("%s%pV", pbuf, &vaf);\r\nbreak;\r\ndefault:\r\npr_info("%s%pV", pbuf, &vaf);\r\nbreak;\r\n}\r\nva_end(va);\r\n}\r\nvoid\r\nql_log_pci(uint32_t level, struct pci_dev *pdev, int32_t id,\r\nconst char *fmt, ...)\r\n{\r\nva_list va;\r\nstruct va_format vaf;\r\nchar pbuf[128];\r\nif (pdev == NULL)\r\nreturn;\r\nif (level > ql_errlev)\r\nreturn;\r\nsnprintf(pbuf, sizeof(pbuf), "%s [%s]-%04x: : ",\r\nQL_MSGHDR, dev_name(&(pdev->dev)), id);\r\npbuf[sizeof(pbuf) - 1] = 0;\r\nva_start(va, fmt);\r\nvaf.fmt = fmt;\r\nvaf.va = &va;\r\nswitch (level) {\r\ncase ql_log_fatal:\r\npr_crit("%s%pV", pbuf, &vaf);\r\nbreak;\r\ncase ql_log_warn:\r\npr_err("%s%pV", pbuf, &vaf);\r\nbreak;\r\ncase ql_log_info:\r\npr_warn("%s%pV", pbuf, &vaf);\r\nbreak;\r\ndefault:\r\npr_info("%s%pV", pbuf, &vaf);\r\nbreak;\r\n}\r\nva_end(va);\r\n}\r\nvoid\r\nql_dump_regs(uint32_t level, scsi_qla_host_t *vha, int32_t id)\r\n{\r\nint i;\r\nstruct qla_hw_data *ha = vha->hw;\r\nstruct device_reg_2xxx __iomem *reg = &ha->iobase->isp;\r\nstruct device_reg_24xx __iomem *reg24 = &ha->iobase->isp24;\r\nstruct device_reg_82xx __iomem *reg82 = &ha->iobase->isp82;\r\nuint16_t __iomem *mbx_reg;\r\nif (!ql_mask_match(level))\r\nreturn;\r\nif (IS_P3P_TYPE(ha))\r\nmbx_reg = &reg82->mailbox_in[0];\r\nelse if (IS_FWI2_CAPABLE(ha))\r\nmbx_reg = &reg24->mailbox0;\r\nelse\r\nmbx_reg = MAILBOX_REG(ha, reg, 0);\r\nql_dbg(level, vha, id, "Mailbox registers:\n");\r\nfor (i = 0; i < 6; i++)\r\nql_dbg(level, vha, id,\r\n"mbox[%d] 0x%04x\n", i, RD_REG_WORD(mbx_reg++));\r\n}\r\nvoid\r\nql_dump_buffer(uint32_t level, scsi_qla_host_t *vha, int32_t id,\r\nuint8_t *b, uint32_t size)\r\n{\r\nuint32_t cnt;\r\nuint8_t c;\r\nif (!ql_mask_match(level))\r\nreturn;\r\nql_dbg(level, vha, id, " 0 1 2 3 4 5 6 7 8 "\r\n"9 Ah Bh Ch Dh Eh Fh\n");\r\nql_dbg(level, vha, id, "----------------------------------"\r\n"----------------------------\n");\r\nql_dbg(level, vha, id, " ");\r\nfor (cnt = 0; cnt < size;) {\r\nc = *b++;\r\nprintk("%02x", (uint32_t) c);\r\ncnt++;\r\nif (!(cnt % 16))\r\nprintk("\n");\r\nelse\r\nprintk(" ");\r\n}\r\nif (cnt % 16)\r\nql_dbg(level, vha, id, "\n");\r\n}

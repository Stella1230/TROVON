static int replicator_enable(struct coresight_device *csdev, int inport,\r\nint outport)\r\n{\r\nstruct replicator_drvdata *drvdata = dev_get_drvdata(csdev->dev.parent);\r\npm_runtime_get_sync(drvdata->dev);\r\ndev_info(drvdata->dev, "REPLICATOR enabled\n");\r\nreturn 0;\r\n}\r\nstatic void replicator_disable(struct coresight_device *csdev, int inport,\r\nint outport)\r\n{\r\nstruct replicator_drvdata *drvdata = dev_get_drvdata(csdev->dev.parent);\r\npm_runtime_put(drvdata->dev);\r\ndev_info(drvdata->dev, "REPLICATOR disabled\n");\r\n}\r\nstatic int replicator_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct device *dev = &pdev->dev;\r\nstruct coresight_platform_data *pdata = NULL;\r\nstruct replicator_drvdata *drvdata;\r\nstruct coresight_desc *desc;\r\nstruct device_node *np = pdev->dev.of_node;\r\nif (np) {\r\npdata = of_get_coresight_platform_data(dev, np);\r\nif (IS_ERR(pdata))\r\nreturn PTR_ERR(pdata);\r\npdev->dev.platform_data = pdata;\r\n}\r\ndrvdata = devm_kzalloc(dev, sizeof(*drvdata), GFP_KERNEL);\r\nif (!drvdata)\r\nreturn -ENOMEM;\r\ndrvdata->dev = &pdev->dev;\r\ndrvdata->atclk = devm_clk_get(&pdev->dev, "atclk");\r\nif (!IS_ERR(drvdata->atclk)) {\r\nret = clk_prepare_enable(drvdata->atclk);\r\nif (ret)\r\nreturn ret;\r\n}\r\npm_runtime_get_noresume(&pdev->dev);\r\npm_runtime_set_active(&pdev->dev);\r\npm_runtime_enable(&pdev->dev);\r\nplatform_set_drvdata(pdev, drvdata);\r\ndesc = devm_kzalloc(dev, sizeof(*desc), GFP_KERNEL);\r\nif (!desc) {\r\nret = -ENOMEM;\r\ngoto out_disable_pm;\r\n}\r\ndesc->type = CORESIGHT_DEV_TYPE_LINK;\r\ndesc->subtype.link_subtype = CORESIGHT_DEV_SUBTYPE_LINK_SPLIT;\r\ndesc->ops = &replicator_cs_ops;\r\ndesc->pdata = pdev->dev.platform_data;\r\ndesc->dev = &pdev->dev;\r\ndrvdata->csdev = coresight_register(desc);\r\nif (IS_ERR(drvdata->csdev)) {\r\nret = PTR_ERR(drvdata->csdev);\r\ngoto out_disable_pm;\r\n}\r\npm_runtime_put(&pdev->dev);\r\ndev_info(dev, "REPLICATOR initialized\n");\r\nreturn 0;\r\nout_disable_pm:\r\nif (!IS_ERR(drvdata->atclk))\r\nclk_disable_unprepare(drvdata->atclk);\r\npm_runtime_put_noidle(&pdev->dev);\r\npm_runtime_disable(&pdev->dev);\r\nreturn ret;\r\n}\r\nstatic int replicator_remove(struct platform_device *pdev)\r\n{\r\nstruct replicator_drvdata *drvdata = platform_get_drvdata(pdev);\r\ncoresight_unregister(drvdata->csdev);\r\npm_runtime_get_sync(&pdev->dev);\r\nif (!IS_ERR(drvdata->atclk))\r\nclk_disable_unprepare(drvdata->atclk);\r\npm_runtime_put_noidle(&pdev->dev);\r\npm_runtime_disable(&pdev->dev);\r\nreturn 0;\r\n}\r\nstatic int replicator_runtime_suspend(struct device *dev)\r\n{\r\nstruct replicator_drvdata *drvdata = dev_get_drvdata(dev);\r\nif (drvdata && !IS_ERR(drvdata->atclk))\r\nclk_disable_unprepare(drvdata->atclk);\r\nreturn 0;\r\n}\r\nstatic int replicator_runtime_resume(struct device *dev)\r\n{\r\nstruct replicator_drvdata *drvdata = dev_get_drvdata(dev);\r\nif (drvdata && !IS_ERR(drvdata->atclk))\r\nclk_prepare_enable(drvdata->atclk);\r\nreturn 0;\r\n}

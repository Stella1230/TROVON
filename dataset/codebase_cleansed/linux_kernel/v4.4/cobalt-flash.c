static map_word flash_read16(struct map_info *map, unsigned long offset)\r\n{\r\nmap_word r;\r\nr.x[0] = cobalt_bus_read32(map->virt, ADRS(offset));\r\nif (offset & 0x2)\r\nr.x[0] >>= 16;\r\nelse\r\nr.x[0] &= 0x0000ffff;\r\nreturn r;\r\n}\r\nstatic void flash_write16(struct map_info *map, const map_word datum,\r\nunsigned long offset)\r\n{\r\nu16 data = (u16)datum.x[0];\r\ncobalt_bus_write16(map->virt, ADRS(offset), data);\r\n}\r\nstatic void flash_copy_from(struct map_info *map, void *to,\r\nunsigned long from, ssize_t len)\r\n{\r\nu32 src = from;\r\nu8 *dest = to;\r\nu32 data;\r\nwhile (len) {\r\ndata = cobalt_bus_read32(map->virt, ADRS(src));\r\ndo {\r\n*dest = data >> (8 * (src & 3));\r\nsrc++;\r\ndest++;\r\nlen--;\r\n} while (len && (src % 4));\r\n}\r\n}\r\nstatic void flash_copy_to(struct map_info *map, unsigned long to,\r\nconst void *from, ssize_t len)\r\n{\r\nconst u8 *src = from;\r\nu32 dest = to;\r\npr_info("%s: offset 0x%x: length %zu\n", __func__, dest, len);\r\nwhile (len) {\r\nu16 data = 0xffff;\r\ndo {\r\ndata = *src << (8 * (dest & 1));\r\nsrc++;\r\ndest++;\r\nlen--;\r\n} while (len && (dest % 2));\r\ncobalt_bus_write16(map->virt, ADRS(dest - 2), data);\r\n}\r\n}\r\nint cobalt_flash_probe(struct cobalt *cobalt)\r\n{\r\nstruct map_info *map = &cobalt_flash_map;\r\nstruct mtd_info *mtd;\r\nBUG_ON(!map_bankwidth_supported(map->bankwidth));\r\nmap->virt = cobalt->bar1;\r\nmap->read = flash_read16;\r\nmap->write = flash_write16;\r\nmap->copy_from = flash_copy_from;\r\nmap->copy_to = flash_copy_to;\r\nmtd = do_map_probe("cfi_probe", map);\r\ncobalt->mtd = mtd;\r\nif (!mtd) {\r\ncobalt_err("Probe CFI flash failed!\n");\r\nreturn -1;\r\n}\r\nmtd->owner = THIS_MODULE;\r\nmtd->dev.parent = &cobalt->pci_dev->dev;\r\nmtd_device_register(mtd, NULL, 0);\r\nreturn 0;\r\n}\r\nvoid cobalt_flash_remove(struct cobalt *cobalt)\r\n{\r\nif (cobalt->mtd) {\r\nmtd_device_unregister(cobalt->mtd);\r\nmap_destroy(cobalt->mtd);\r\n}\r\n}

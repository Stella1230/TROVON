static __init int system_trusted_keyring_init(void)\r\n{\r\npr_notice("Initialise system trusted keyring\n");\r\nsystem_trusted_keyring =\r\nkeyring_alloc(".system_keyring",\r\nKUIDT_INIT(0), KGIDT_INIT(0), current_cred(),\r\n((KEY_POS_ALL & ~KEY_POS_SETATTR) |\r\nKEY_USR_VIEW | KEY_USR_READ | KEY_USR_SEARCH),\r\nKEY_ALLOC_NOT_IN_QUOTA, NULL);\r\nif (IS_ERR(system_trusted_keyring))\r\npanic("Can't allocate system trusted keyring\n");\r\nset_bit(KEY_FLAG_TRUSTED_ONLY, &system_trusted_keyring->flags);\r\nreturn 0;\r\n}\r\nstatic __init int load_system_certificate_list(void)\r\n{\r\nkey_ref_t key;\r\nconst u8 *p, *end;\r\nsize_t plen;\r\npr_notice("Loading compiled-in X.509 certificates\n");\r\np = system_certificate_list;\r\nend = p + system_certificate_list_size;\r\nwhile (p < end) {\r\nif (end - p < 4)\r\ngoto dodgy_cert;\r\nif (p[0] != 0x30 &&\r\np[1] != 0x82)\r\ngoto dodgy_cert;\r\nplen = (p[2] << 8) | p[3];\r\nplen += 4;\r\nif (plen > end - p)\r\ngoto dodgy_cert;\r\nkey = key_create_or_update(make_key_ref(system_trusted_keyring, 1),\r\n"asymmetric",\r\nNULL,\r\np,\r\nplen,\r\n((KEY_POS_ALL & ~KEY_POS_SETATTR) |\r\nKEY_USR_VIEW | KEY_USR_READ),\r\nKEY_ALLOC_NOT_IN_QUOTA |\r\nKEY_ALLOC_TRUSTED);\r\nif (IS_ERR(key)) {\r\npr_err("Problem loading in-kernel X.509 certificate (%ld)\n",\r\nPTR_ERR(key));\r\n} else {\r\nset_bit(KEY_FLAG_BUILTIN, &key_ref_to_ptr(key)->flags);\r\npr_notice("Loaded X.509 cert '%s'\n",\r\nkey_ref_to_ptr(key)->description);\r\nkey_ref_put(key);\r\n}\r\np += plen;\r\n}\r\nreturn 0;\r\ndodgy_cert:\r\npr_err("Problem parsing in-kernel X.509 certificate list\n");\r\nreturn 0;\r\n}\r\nint system_verify_data(const void *data, unsigned long len,\r\nconst void *raw_pkcs7, size_t pkcs7_len,\r\nenum key_being_used_for usage)\r\n{\r\nstruct pkcs7_message *pkcs7;\r\nbool trusted;\r\nint ret;\r\npkcs7 = pkcs7_parse_message(raw_pkcs7, pkcs7_len);\r\nif (IS_ERR(pkcs7))\r\nreturn PTR_ERR(pkcs7);\r\nif (pkcs7_supply_detached_data(pkcs7, data, len) < 0) {\r\npr_err("PKCS#7 signature with non-detached data\n");\r\nret = -EBADMSG;\r\ngoto error;\r\n}\r\nret = pkcs7_verify(pkcs7, usage);\r\nif (ret < 0)\r\ngoto error;\r\nret = pkcs7_validate_trust(pkcs7, system_trusted_keyring, &trusted);\r\nif (ret < 0)\r\ngoto error;\r\nif (!trusted) {\r\npr_err("PKCS#7 signature not signed with a trusted key\n");\r\nret = -ENOKEY;\r\n}\r\nerror:\r\npkcs7_free_message(pkcs7);\r\npr_devel("<==%s() = %d\n", __func__, ret);\r\nreturn ret;\r\n}

static inline void ms_set_err_code(struct rtsx_chip *chip, u8 err_code)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nms_card->err_code = err_code;\r\n}\r\nstatic inline int ms_check_err_code(struct rtsx_chip *chip, u8 err_code)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nreturn (ms_card->err_code == err_code);\r\n}\r\nstatic int ms_parse_err_code(struct rtsx_chip *chip)\r\n{\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nstatic int ms_transfer_tpc(struct rtsx_chip *chip, u8 trans_mode,\r\nu8 tpc, u8 cnt, u8 cfg)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval;\r\nu8 *ptr;\r\ndev_dbg(rtsx_dev(chip), "%s: tpc = 0x%x\n", __func__, tpc);\r\nrtsx_init_cmd(chip);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, MS_TPC, 0xFF, tpc);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, MS_BYTE_CNT, 0xFF, cnt);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, MS_TRANS_CFG, 0xFF, cfg);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_DATA_SOURCE,\r\n0x01, PINGPONG_BUFFER);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, MS_TRANSFER,\r\n0xFF, MS_TRANSFER_START | trans_mode);\r\nrtsx_add_cmd(chip, CHECK_REG_CMD, MS_TRANSFER,\r\nMS_TRANSFER_END, MS_TRANSFER_END);\r\nrtsx_add_cmd(chip, READ_REG_CMD, MS_TRANS_CFG, 0, 0);\r\nretval = rtsx_send_cmd(chip, MS_CARD, 5000);\r\nif (retval < 0) {\r\nrtsx_clear_ms_error(chip);\r\nms_set_err_code(chip, MS_TO_ERROR);\r\nrtsx_trace(chip);\r\nreturn ms_parse_err_code(chip);\r\n}\r\nptr = rtsx_get_cmd_data(chip) + 1;\r\nif (!(tpc & 0x08)) {\r\nif (*ptr & MS_CRC16_ERR) {\r\nms_set_err_code(chip, MS_CRC16_ERROR);\r\nrtsx_trace(chip);\r\nreturn ms_parse_err_code(chip);\r\n}\r\n} else {\r\nif (CHK_MSPRO(ms_card) && !(*ptr & 0x80)) {\r\nif (*ptr & (MS_INT_ERR | MS_INT_CMDNK)) {\r\nms_set_err_code(chip, MS_CMD_NK);\r\nrtsx_trace(chip);\r\nreturn ms_parse_err_code(chip);\r\n}\r\n}\r\n}\r\nif (*ptr & MS_RDY_TIMEOUT) {\r\nrtsx_clear_ms_error(chip);\r\nms_set_err_code(chip, MS_TO_ERROR);\r\nrtsx_trace(chip);\r\nreturn ms_parse_err_code(chip);\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int ms_transfer_data(struct rtsx_chip *chip, u8 trans_mode,\r\nu8 tpc, u16 sec_cnt, u8 cfg, bool mode_2k,\r\nint use_sg, void *buf, int buf_len)\r\n{\r\nint retval;\r\nu8 val, err_code = 0;\r\nenum dma_data_direction dir;\r\nif (!buf || !buf_len) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (trans_mode == MS_TM_AUTO_READ) {\r\ndir = DMA_FROM_DEVICE;\r\nerr_code = MS_FLASH_READ_ERROR;\r\n} else if (trans_mode == MS_TM_AUTO_WRITE) {\r\ndir = DMA_TO_DEVICE;\r\nerr_code = MS_FLASH_WRITE_ERROR;\r\n} else {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nrtsx_init_cmd(chip);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, MS_TPC, 0xFF, tpc);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD,\r\nMS_SECTOR_CNT_H, 0xFF, (u8)(sec_cnt >> 8));\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, MS_SECTOR_CNT_L, 0xFF, (u8)sec_cnt);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, MS_TRANS_CFG, 0xFF, cfg);\r\nif (mode_2k) {\r\nrtsx_add_cmd(chip, WRITE_REG_CMD,\r\nMS_CFG, MS_2K_SECTOR_MODE, MS_2K_SECTOR_MODE);\r\n} else {\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, MS_CFG, MS_2K_SECTOR_MODE, 0);\r\n}\r\ntrans_dma_enable(dir, chip, sec_cnt * 512, DMA_512);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD,\r\nMS_TRANSFER, 0xFF, MS_TRANSFER_START | trans_mode);\r\nrtsx_add_cmd(chip, CHECK_REG_CMD,\r\nMS_TRANSFER, MS_TRANSFER_END, MS_TRANSFER_END);\r\nrtsx_send_cmd_no_wait(chip);\r\nretval = rtsx_transfer_data(chip, MS_CARD, buf, buf_len,\r\nuse_sg, dir, chip->mspro_timeout);\r\nif (retval < 0) {\r\nms_set_err_code(chip, err_code);\r\nif (retval == -ETIMEDOUT)\r\nretval = STATUS_TIMEDOUT;\r\nelse\r\nretval = STATUS_FAIL;\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_read_register(chip, MS_TRANS_CFG, &val);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nif (val & (MS_INT_CMDNK | MS_INT_ERR | MS_CRC16_ERR | MS_RDY_TIMEOUT)) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int ms_write_bytes(struct rtsx_chip *chip,\r\nu8 tpc, u8 cnt, u8 cfg, u8 *data, int data_len)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval, i;\r\nif (!data || (data_len < cnt)) {\r\nrtsx_trace(chip);\r\nreturn STATUS_ERROR;\r\n}\r\nrtsx_init_cmd(chip);\r\nfor (i = 0; i < cnt; i++) {\r\nrtsx_add_cmd(chip, WRITE_REG_CMD,\r\nPPBUF_BASE2 + i, 0xFF, data[i]);\r\n}\r\nif (cnt % 2)\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, PPBUF_BASE2 + i, 0xFF, 0xFF);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, MS_TPC, 0xFF, tpc);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, MS_BYTE_CNT, 0xFF, cnt);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, MS_TRANS_CFG, 0xFF, cfg);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_DATA_SOURCE,\r\n0x01, PINGPONG_BUFFER);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD,\r\nMS_TRANSFER, 0xFF, MS_TRANSFER_START | MS_TM_WRITE_BYTES);\r\nrtsx_add_cmd(chip, CHECK_REG_CMD,\r\nMS_TRANSFER, MS_TRANSFER_END, MS_TRANSFER_END);\r\nretval = rtsx_send_cmd(chip, MS_CARD, 5000);\r\nif (retval < 0) {\r\nu8 val = 0;\r\nrtsx_read_register(chip, MS_TRANS_CFG, &val);\r\ndev_dbg(rtsx_dev(chip), "MS_TRANS_CFG: 0x%02x\n", val);\r\nrtsx_clear_ms_error(chip);\r\nif (!(tpc & 0x08)) {\r\nif (val & MS_CRC16_ERR) {\r\nms_set_err_code(chip, MS_CRC16_ERROR);\r\nrtsx_trace(chip);\r\nreturn ms_parse_err_code(chip);\r\n}\r\n} else {\r\nif (CHK_MSPRO(ms_card) && !(val & 0x80)) {\r\nif (val & (MS_INT_ERR | MS_INT_CMDNK)) {\r\nms_set_err_code(chip, MS_CMD_NK);\r\nrtsx_trace(chip);\r\nreturn ms_parse_err_code(chip);\r\n}\r\n}\r\n}\r\nif (val & MS_RDY_TIMEOUT) {\r\nms_set_err_code(chip, MS_TO_ERROR);\r\nrtsx_trace(chip);\r\nreturn ms_parse_err_code(chip);\r\n}\r\nms_set_err_code(chip, MS_TO_ERROR);\r\nrtsx_trace(chip);\r\nreturn ms_parse_err_code(chip);\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int ms_read_bytes(struct rtsx_chip *chip,\r\nu8 tpc, u8 cnt, u8 cfg, u8 *data, int data_len)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval, i;\r\nu8 *ptr;\r\nif (!data) {\r\nrtsx_trace(chip);\r\nreturn STATUS_ERROR;\r\n}\r\nrtsx_init_cmd(chip);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, MS_TPC, 0xFF, tpc);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, MS_BYTE_CNT, 0xFF, cnt);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, MS_TRANS_CFG, 0xFF, cfg);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_DATA_SOURCE,\r\n0x01, PINGPONG_BUFFER);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, MS_TRANSFER, 0xFF,\r\nMS_TRANSFER_START | MS_TM_READ_BYTES);\r\nrtsx_add_cmd(chip, CHECK_REG_CMD, MS_TRANSFER,\r\nMS_TRANSFER_END, MS_TRANSFER_END);\r\nfor (i = 0; i < data_len - 1; i++)\r\nrtsx_add_cmd(chip, READ_REG_CMD, PPBUF_BASE2 + i, 0, 0);\r\nif (data_len % 2)\r\nrtsx_add_cmd(chip, READ_REG_CMD, PPBUF_BASE2 + data_len, 0, 0);\r\nelse\r\nrtsx_add_cmd(chip, READ_REG_CMD, PPBUF_BASE2 + data_len - 1,\r\n0, 0);\r\nretval = rtsx_send_cmd(chip, MS_CARD, 5000);\r\nif (retval < 0) {\r\nu8 val = 0;\r\nrtsx_read_register(chip, MS_TRANS_CFG, &val);\r\nrtsx_clear_ms_error(chip);\r\nif (!(tpc & 0x08)) {\r\nif (val & MS_CRC16_ERR) {\r\nms_set_err_code(chip, MS_CRC16_ERROR);\r\nrtsx_trace(chip);\r\nreturn ms_parse_err_code(chip);\r\n}\r\n} else {\r\nif (CHK_MSPRO(ms_card) && !(val & 0x80)) {\r\nif (val & (MS_INT_ERR | MS_INT_CMDNK)) {\r\nms_set_err_code(chip, MS_CMD_NK);\r\nrtsx_trace(chip);\r\nreturn ms_parse_err_code(chip);\r\n}\r\n}\r\n}\r\nif (val & MS_RDY_TIMEOUT) {\r\nms_set_err_code(chip, MS_TO_ERROR);\r\nrtsx_trace(chip);\r\nreturn ms_parse_err_code(chip);\r\n}\r\nms_set_err_code(chip, MS_TO_ERROR);\r\nrtsx_trace(chip);\r\nreturn ms_parse_err_code(chip);\r\n}\r\nptr = rtsx_get_cmd_data(chip) + 1;\r\nfor (i = 0; i < data_len; i++)\r\ndata[i] = ptr[i];\r\nif ((tpc == PRO_READ_SHORT_DATA) && (data_len == 8)) {\r\ndev_dbg(rtsx_dev(chip), "Read format progress:\n");\r\nprint_hex_dump_bytes(KBUILD_MODNAME ": ", DUMP_PREFIX_NONE, ptr,\r\ncnt);\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int ms_set_rw_reg_addr(struct rtsx_chip *chip,\r\nu8 read_start, u8 read_cnt, u8 write_start, u8 write_cnt)\r\n{\r\nint retval, i;\r\nu8 data[4];\r\ndata[0] = read_start;\r\ndata[1] = read_cnt;\r\ndata[2] = write_start;\r\ndata[3] = write_cnt;\r\nfor (i = 0; i < MS_MAX_RETRY_COUNT; i++) {\r\nretval = ms_write_bytes(chip, SET_RW_REG_ADRS, 4,\r\nNO_WAIT_INT, data, 4);\r\nif (retval == STATUS_SUCCESS)\r\nreturn STATUS_SUCCESS;\r\nrtsx_clear_ms_error(chip);\r\n}\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nstatic int ms_send_cmd(struct rtsx_chip *chip, u8 cmd, u8 cfg)\r\n{\r\nu8 data[2];\r\ndata[0] = cmd;\r\ndata[1] = 0;\r\nreturn ms_write_bytes(chip, PRO_SET_CMD, 1, cfg, data, 1);\r\n}\r\nstatic int ms_set_init_para(struct rtsx_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval;\r\nif (CHK_HG8BIT(ms_card)) {\r\nif (chip->asic_code)\r\nms_card->ms_clock = chip->asic_ms_hg_clk;\r\nelse\r\nms_card->ms_clock = chip->fpga_ms_hg_clk;\r\n} else if (CHK_MSPRO(ms_card) || CHK_MS4BIT(ms_card)) {\r\nif (chip->asic_code)\r\nms_card->ms_clock = chip->asic_ms_4bit_clk;\r\nelse\r\nms_card->ms_clock = chip->fpga_ms_4bit_clk;\r\n} else {\r\nif (chip->asic_code)\r\nms_card->ms_clock = chip->asic_ms_1bit_clk;\r\nelse\r\nms_card->ms_clock = chip->fpga_ms_1bit_clk;\r\n}\r\nretval = switch_clock(chip, ms_card->ms_clock);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = select_card(chip, MS_CARD);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int ms_switch_clock(struct rtsx_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval;\r\nretval = select_card(chip, MS_CARD);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = switch_clock(chip, ms_card->ms_clock);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int ms_pull_ctl_disable(struct rtsx_chip *chip)\r\n{\r\nint retval;\r\nif (CHECK_PID(chip, 0x5208)) {\r\nretval = rtsx_write_register(chip, CARD_PULL_CTL1, 0xFF,\r\nMS_D1_PD | MS_D2_PD | MS_CLK_PD | MS_D6_PD);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, CARD_PULL_CTL2, 0xFF,\r\nMS_D3_PD | MS_D0_PD | MS_BS_PD | XD_D4_PD);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, CARD_PULL_CTL3, 0xFF,\r\nMS_D7_PD | XD_CE_PD | XD_CLE_PD | XD_CD_PU);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, CARD_PULL_CTL4, 0xFF,\r\nXD_RDY_PD | SD_D3_PD | SD_D2_PD | XD_ALE_PD);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, CARD_PULL_CTL5, 0xFF,\r\nMS_INS_PU | SD_WP_PD | SD_CD_PU | SD_CMD_PD);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, CARD_PULL_CTL6, 0xFF,\r\nMS_D5_PD | MS_D4_PD);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\n} else if (CHECK_PID(chip, 0x5288)) {\r\nif (CHECK_BARO_PKG(chip, QFN)) {\r\nretval = rtsx_write_register(chip, CARD_PULL_CTL1,\r\n0xFF, 0x55);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, CARD_PULL_CTL2,\r\n0xFF, 0x55);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, CARD_PULL_CTL3,\r\n0xFF, 0x4B);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, CARD_PULL_CTL4,\r\n0xFF, 0x69);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\n}\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int ms_pull_ctl_enable(struct rtsx_chip *chip)\r\n{\r\nint retval;\r\nrtsx_init_cmd(chip);\r\nif (CHECK_PID(chip, 0x5208)) {\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_PULL_CTL1, 0xFF,\r\nMS_D1_PD | MS_D2_PD | MS_CLK_NP | MS_D6_PD);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_PULL_CTL2, 0xFF,\r\nMS_D3_PD | MS_D0_PD | MS_BS_NP | XD_D4_PD);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_PULL_CTL3, 0xFF,\r\nMS_D7_PD | XD_CE_PD | XD_CLE_PD | XD_CD_PU);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_PULL_CTL4, 0xFF,\r\nXD_RDY_PD | SD_D3_PD | SD_D2_PD | XD_ALE_PD);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_PULL_CTL5, 0xFF,\r\nMS_INS_PU | SD_WP_PD | SD_CD_PU | SD_CMD_PD);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_PULL_CTL6, 0xFF,\r\nMS_D5_PD | MS_D4_PD);\r\n} else if (CHECK_PID(chip, 0x5288)) {\r\nif (CHECK_BARO_PKG(chip, QFN)) {\r\nrtsx_add_cmd(chip, WRITE_REG_CMD,\r\nCARD_PULL_CTL1, 0xFF, 0x55);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD,\r\nCARD_PULL_CTL2, 0xFF, 0x45);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD,\r\nCARD_PULL_CTL3, 0xFF, 0x4B);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD,\r\nCARD_PULL_CTL4, 0xFF, 0x29);\r\n}\r\n}\r\nretval = rtsx_send_cmd(chip, MS_CARD, 100);\r\nif (retval < 0) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int ms_prepare_reset(struct rtsx_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval;\r\nu8 oc_mask = 0;\r\nms_card->ms_type = 0;\r\nms_card->check_ms_flow = 0;\r\nms_card->switch_8bit_fail = 0;\r\nms_card->delay_write.delay_write_flag = 0;\r\nms_card->pro_under_formatting = 0;\r\nretval = ms_power_off_card3v3(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (!chip->ft2_fast_mode)\r\nwait_timeout(250);\r\nretval = enable_card_clock(chip, MS_CARD);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (chip->asic_code) {\r\nretval = ms_pull_ctl_enable(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n} else {\r\nretval = rtsx_write_register(chip, FPGA_PULL_CTL,\r\nFPGA_MS_PULL_CTL_BIT | 0x20, 0);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\n}\r\nif (!chip->ft2_fast_mode) {\r\nretval = card_power_on(chip, MS_CARD);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nwait_timeout(150);\r\n#ifdef SUPPORT_OCP\r\nif (CHECK_LUN_MODE(chip, SD_MS_2LUN))\r\noc_mask = MS_OC_NOW | MS_OC_EVER;\r\nelse\r\noc_mask = SD_OC_NOW | SD_OC_EVER;\r\nif (chip->ocp_stat & oc_mask) {\r\ndev_dbg(rtsx_dev(chip), "Over current, OCPSTAT is 0x%x\n",\r\nchip->ocp_stat);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n#endif\r\n}\r\nretval = rtsx_write_register(chip, CARD_OE, MS_OUTPUT_EN,\r\nMS_OUTPUT_EN);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nif (chip->asic_code) {\r\nretval = rtsx_write_register(chip, MS_CFG, 0xFF,\r\nSAMPLE_TIME_RISING | PUSH_TIME_DEFAULT | NO_EXTEND_TOGGLE | MS_BUS_WIDTH_1);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\n} else {\r\nretval = rtsx_write_register(chip, MS_CFG, 0xFF,\r\nSAMPLE_TIME_FALLING | PUSH_TIME_DEFAULT | NO_EXTEND_TOGGLE | MS_BUS_WIDTH_1);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\n}\r\nretval = rtsx_write_register(chip, MS_TRANS_CFG, 0xFF,\r\nNO_WAIT_INT | NO_AUTO_READ_INT_REG);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, CARD_STOP, MS_STOP | MS_CLR_ERR,\r\nMS_STOP | MS_CLR_ERR);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = ms_set_init_para(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int ms_identify_media_type(struct rtsx_chip *chip, int switch_8bit_bus)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval, i;\r\nu8 val;\r\nretval = ms_set_rw_reg_addr(chip, Pro_StatusReg, 6, SystemParm, 1);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nfor (i = 0; i < MS_MAX_RETRY_COUNT; i++) {\r\nretval = ms_transfer_tpc(chip, MS_TM_READ_BYTES, READ_REG,\r\n6, NO_WAIT_INT);\r\nif (retval == STATUS_SUCCESS)\r\nbreak;\r\n}\r\nif (i == MS_MAX_RETRY_COUNT) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = rtsx_read_register(chip, PPBUF_BASE2 + 2, &val);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\ndev_dbg(rtsx_dev(chip), "Type register: 0x%x\n", val);\r\nif (val != 0x01) {\r\nif (val != 0x02)\r\nms_card->check_ms_flow = 1;\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = rtsx_read_register(chip, PPBUF_BASE2 + 4, &val);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\ndev_dbg(rtsx_dev(chip), "Category register: 0x%x\n", val);\r\nif (val != 0) {\r\nms_card->check_ms_flow = 1;\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = rtsx_read_register(chip, PPBUF_BASE2 + 5, &val);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\ndev_dbg(rtsx_dev(chip), "Class register: 0x%x\n", val);\r\nif (val == 0) {\r\nretval = rtsx_read_register(chip, PPBUF_BASE2, &val);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nif (val & WRT_PRTCT)\r\nchip->card_wp |= MS_CARD;\r\nelse\r\nchip->card_wp &= ~MS_CARD;\r\n} else if ((val == 0x01) || (val == 0x02) || (val == 0x03)) {\r\nchip->card_wp |= MS_CARD;\r\n} else {\r\nms_card->check_ms_flow = 1;\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nms_card->ms_type |= TYPE_MSPRO;\r\nretval = rtsx_read_register(chip, PPBUF_BASE2 + 3, &val);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\ndev_dbg(rtsx_dev(chip), "IF Mode register: 0x%x\n", val);\r\nif (val == 0) {\r\nms_card->ms_type &= 0x0F;\r\n} else if (val == 7) {\r\nif (switch_8bit_bus)\r\nms_card->ms_type |= MS_HG;\r\nelse\r\nms_card->ms_type &= 0x0F;\r\n} else {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int ms_confirm_cpu_startup(struct rtsx_chip *chip)\r\n{\r\nint retval, i, k;\r\nu8 val;\r\nk = 0;\r\ndo {\r\nif (detect_card_cd(chip, MS_CARD) != STATUS_SUCCESS) {\r\nms_set_err_code(chip, MS_NO_CARD);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nfor (i = 0; i < MS_MAX_RETRY_COUNT; i++) {\r\nretval = ms_read_bytes(chip, GET_INT, 1,\r\nNO_WAIT_INT, &val, 1);\r\nif (retval == STATUS_SUCCESS)\r\nbreak;\r\n}\r\nif (i == MS_MAX_RETRY_COUNT) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (k > 100) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nk++;\r\nwait_timeout(100);\r\n} while (!(val & INT_REG_CED));\r\nfor (i = 0; i < MS_MAX_RETRY_COUNT; i++) {\r\nretval = ms_read_bytes(chip, GET_INT, 1, NO_WAIT_INT, &val, 1);\r\nif (retval == STATUS_SUCCESS)\r\nbreak;\r\n}\r\nif (i == MS_MAX_RETRY_COUNT) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (val & INT_REG_ERR) {\r\nif (val & INT_REG_CMDNK)\r\nchip->card_wp |= (MS_CARD);\r\nelse {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int ms_switch_parallel_bus(struct rtsx_chip *chip)\r\n{\r\nint retval, i;\r\nu8 data[2];\r\ndata[0] = PARALLEL_4BIT_IF;\r\ndata[1] = 0;\r\nfor (i = 0; i < MS_MAX_RETRY_COUNT; i++) {\r\nretval = ms_write_bytes(chip, WRITE_REG, 1, NO_WAIT_INT,\r\ndata, 2);\r\nif (retval == STATUS_SUCCESS)\r\nbreak;\r\n}\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int ms_switch_8bit_bus(struct rtsx_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval, i;\r\nu8 data[2];\r\ndata[0] = PARALLEL_8BIT_IF;\r\ndata[1] = 0;\r\nfor (i = 0; i < MS_MAX_RETRY_COUNT; i++) {\r\nretval = ms_write_bytes(chip, WRITE_REG, 1,\r\nNO_WAIT_INT, data, 2);\r\nif (retval == STATUS_SUCCESS)\r\nbreak;\r\n}\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = rtsx_write_register(chip, MS_CFG, 0x98,\r\nMS_BUS_WIDTH_8 | SAMPLE_TIME_FALLING);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nms_card->ms_type |= MS_8BIT;\r\nretval = ms_set_init_para(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nfor (i = 0; i < MS_MAX_RETRY_COUNT; i++) {\r\nretval = ms_transfer_tpc(chip, MS_TM_READ_BYTES, GET_INT,\r\n1, NO_WAIT_INT);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int ms_pro_reset_flow(struct rtsx_chip *chip, int switch_8bit_bus)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval, i;\r\nfor (i = 0; i < 3; i++) {\r\nretval = ms_prepare_reset(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_identify_media_type(chip, switch_8bit_bus);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_confirm_cpu_startup(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_switch_parallel_bus(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nif (detect_card_cd(chip, MS_CARD) != STATUS_SUCCESS) {\r\nms_set_err_code(chip, MS_NO_CARD);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\ncontinue;\r\n} else {\r\nbreak;\r\n}\r\n}\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = rtsx_write_register(chip, MS_CFG, 0x18, MS_BUS_WIDTH_4);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, MS_CFG, PUSH_TIME_ODD,\r\nPUSH_TIME_ODD);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = ms_set_init_para(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (CHK_MSHG(ms_card) && chip->support_ms_8bit && switch_8bit_bus) {\r\nretval = ms_switch_8bit_bus(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nms_card->switch_8bit_fail = 1;\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int msxc_change_power(struct rtsx_chip *chip, u8 mode)\r\n{\r\nint retval;\r\nu8 buf[6];\r\nms_cleanup_work(chip);\r\nretval = ms_set_rw_reg_addr(chip, 0, 0, Pro_DataCount1, 6);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nbuf[0] = 0;\r\nbuf[1] = mode;\r\nbuf[2] = 0;\r\nbuf[3] = 0;\r\nbuf[4] = 0;\r\nbuf[5] = 0;\r\nretval = ms_write_bytes(chip, PRO_WRITE_REG, 6, NO_WAIT_INT, buf, 6);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_send_cmd(chip, XC_CHG_POWER, WAIT_INT);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = rtsx_read_register(chip, MS_TRANS_CFG, buf);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nif (buf[0] & (MS_INT_CMDNK | MS_INT_ERR)) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int reset_ms_pro(struct rtsx_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval;\r\n#ifdef XC_POWERCLASS\r\nu8 change_power_class;\r\nif (chip->ms_power_class_en & 0x02)\r\nchange_power_class = 2;\r\nelse if (chip->ms_power_class_en & 0x01)\r\nchange_power_class = 1;\r\nelse\r\nchange_power_class = 0;\r\n#endif\r\n#ifdef XC_POWERCLASS\r\nRetry:\r\n#endif\r\nretval = ms_pro_reset_flow(chip, 1);\r\nif (retval != STATUS_SUCCESS) {\r\nif (ms_card->switch_8bit_fail) {\r\nretval = ms_pro_reset_flow(chip, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n} else {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nretval = ms_read_attribute_info(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n#ifdef XC_POWERCLASS\r\nif (CHK_HG8BIT(ms_card))\r\nchange_power_class = 0;\r\nif (change_power_class && CHK_MSXC(ms_card)) {\r\nu8 power_class_en = chip->ms_power_class_en;\r\ndev_dbg(rtsx_dev(chip), "power_class_en = 0x%x\n",\r\npower_class_en);\r\ndev_dbg(rtsx_dev(chip), "change_power_class = %d\n",\r\nchange_power_class);\r\nif (change_power_class)\r\npower_class_en &= (1 << (change_power_class - 1));\r\nelse\r\npower_class_en = 0;\r\nif (power_class_en) {\r\nu8 power_class_mode =\r\n(ms_card->raw_sys_info[46] & 0x18) >> 3;\r\ndev_dbg(rtsx_dev(chip), "power_class_mode = 0x%x",\r\npower_class_mode);\r\nif (change_power_class > power_class_mode)\r\nchange_power_class = power_class_mode;\r\nif (change_power_class) {\r\nretval = msxc_change_power(chip,\r\nchange_power_class);\r\nif (retval != STATUS_SUCCESS) {\r\nchange_power_class--;\r\ngoto Retry;\r\n}\r\n}\r\n}\r\n}\r\n#endif\r\n#ifdef SUPPORT_MAGIC_GATE\r\nretval = mg_set_tpc_para_sub(chip, 0, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n#endif\r\nif (CHK_HG8BIT(ms_card))\r\nchip->card_bus_width[chip->card2lun[MS_CARD]] = 8;\r\nelse\r\nchip->card_bus_width[chip->card2lun[MS_CARD]] = 4;\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int ms_read_status_reg(struct rtsx_chip *chip)\r\n{\r\nint retval;\r\nu8 val[2];\r\nretval = ms_set_rw_reg_addr(chip, StatusReg0, 2, 0, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_read_bytes(chip, READ_REG, 2, NO_WAIT_INT, val, 2);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (val[1] & (STS_UCDT | STS_UCEX | STS_UCFG)) {\r\nms_set_err_code(chip, MS_FLASH_READ_ERROR);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int ms_read_extra_data(struct rtsx_chip *chip,\r\nu16 block_addr, u8 page_num, u8 *buf, int buf_len)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval, i;\r\nu8 val, data[10];\r\nretval = ms_set_rw_reg_addr(chip, OverwriteFlag, MS_EXTRA_SIZE,\r\nSystemParm, 6);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (CHK_MS4BIT(ms_card)) {\r\ndata[0] = 0x88;\r\n} else {\r\ndata[0] = 0x80;\r\n}\r\ndata[1] = 0;\r\ndata[2] = (u8)(block_addr >> 8);\r\ndata[3] = (u8)block_addr;\r\ndata[4] = 0x40;\r\ndata[5] = page_num;\r\nfor (i = 0; i < MS_MAX_RETRY_COUNT; i++) {\r\nretval = ms_write_bytes(chip, WRITE_REG, 6, NO_WAIT_INT,\r\ndata, 6);\r\nif (retval == STATUS_SUCCESS)\r\nbreak;\r\n}\r\nif (i == MS_MAX_RETRY_COUNT) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nms_set_err_code(chip, MS_NO_ERROR);\r\nfor (i = 0; i < MS_MAX_RETRY_COUNT; i++) {\r\nretval = ms_send_cmd(chip, BLOCK_READ, WAIT_INT);\r\nif (retval == STATUS_SUCCESS)\r\nbreak;\r\n}\r\nif (i == MS_MAX_RETRY_COUNT) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nms_set_err_code(chip, MS_NO_ERROR);\r\nretval = ms_read_bytes(chip, GET_INT, 1, NO_WAIT_INT, &val, 1);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (val & INT_REG_CMDNK) {\r\nms_set_err_code(chip, MS_CMD_NK);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (val & INT_REG_CED) {\r\nif (val & INT_REG_ERR) {\r\nretval = ms_read_status_reg(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_set_rw_reg_addr(chip, OverwriteFlag,\r\nMS_EXTRA_SIZE, SystemParm, 6);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\n}\r\nretval = ms_read_bytes(chip, READ_REG, MS_EXTRA_SIZE, NO_WAIT_INT,\r\ndata, MS_EXTRA_SIZE);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (buf && buf_len) {\r\nif (buf_len > MS_EXTRA_SIZE)\r\nbuf_len = MS_EXTRA_SIZE;\r\nmemcpy(buf, data, buf_len);\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int ms_write_extra_data(struct rtsx_chip *chip,\r\nu16 block_addr, u8 page_num, u8 *buf, int buf_len)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval, i;\r\nu8 val, data[16];\r\nif (!buf || (buf_len < MS_EXTRA_SIZE)) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_set_rw_reg_addr(chip, OverwriteFlag, MS_EXTRA_SIZE,\r\nSystemParm, 6 + MS_EXTRA_SIZE);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (CHK_MS4BIT(ms_card))\r\ndata[0] = 0x88;\r\nelse\r\ndata[0] = 0x80;\r\ndata[1] = 0;\r\ndata[2] = (u8)(block_addr >> 8);\r\ndata[3] = (u8)block_addr;\r\ndata[4] = 0x40;\r\ndata[5] = page_num;\r\nfor (i = 6; i < MS_EXTRA_SIZE + 6; i++)\r\ndata[i] = buf[i - 6];\r\nretval = ms_write_bytes(chip, WRITE_REG, (6 + MS_EXTRA_SIZE),\r\nNO_WAIT_INT, data, 16);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_send_cmd(chip, BLOCK_WRITE, WAIT_INT);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nms_set_err_code(chip, MS_NO_ERROR);\r\nretval = ms_read_bytes(chip, GET_INT, 1, NO_WAIT_INT, &val, 1);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (val & INT_REG_CMDNK) {\r\nms_set_err_code(chip, MS_CMD_NK);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (val & INT_REG_CED) {\r\nif (val & INT_REG_ERR) {\r\nms_set_err_code(chip, MS_FLASH_WRITE_ERROR);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int ms_read_page(struct rtsx_chip *chip, u16 block_addr, u8 page_num)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval;\r\nu8 val, data[6];\r\nretval = ms_set_rw_reg_addr(chip, OverwriteFlag, MS_EXTRA_SIZE,\r\nSystemParm, 6);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (CHK_MS4BIT(ms_card))\r\ndata[0] = 0x88;\r\nelse\r\ndata[0] = 0x80;\r\ndata[1] = 0;\r\ndata[2] = (u8)(block_addr >> 8);\r\ndata[3] = (u8)block_addr;\r\ndata[4] = 0x20;\r\ndata[5] = page_num;\r\nretval = ms_write_bytes(chip, WRITE_REG, 6, NO_WAIT_INT, data, 6);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_send_cmd(chip, BLOCK_READ, WAIT_INT);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nms_set_err_code(chip, MS_NO_ERROR);\r\nretval = ms_read_bytes(chip, GET_INT, 1, NO_WAIT_INT, &val, 1);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (val & INT_REG_CMDNK) {\r\nms_set_err_code(chip, MS_CMD_NK);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (val & INT_REG_CED) {\r\nif (val & INT_REG_ERR) {\r\nif (!(val & INT_REG_BREQ)) {\r\nms_set_err_code(chip, MS_FLASH_READ_ERROR);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_read_status_reg(chip);\r\nif (retval != STATUS_SUCCESS)\r\nms_set_err_code(chip, MS_FLASH_WRITE_ERROR);\r\n} else {\r\nif (!(val & INT_REG_BREQ)) {\r\nms_set_err_code(chip, MS_BREQ_ERROR);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\n}\r\nretval = ms_transfer_tpc(chip, MS_TM_NORMAL_READ, READ_PAGE_DATA,\r\n0, NO_WAIT_INT);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (ms_check_err_code(chip, MS_FLASH_WRITE_ERROR)) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int ms_set_bad_block(struct rtsx_chip *chip, u16 phy_blk)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval;\r\nu8 val, data[8], extra[MS_EXTRA_SIZE];\r\nretval = ms_read_extra_data(chip, phy_blk, 0, extra, MS_EXTRA_SIZE);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_set_rw_reg_addr(chip, OverwriteFlag, MS_EXTRA_SIZE,\r\nSystemParm, 7);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nms_set_err_code(chip, MS_NO_ERROR);\r\nif (CHK_MS4BIT(ms_card))\r\ndata[0] = 0x88;\r\nelse\r\ndata[0] = 0x80;\r\ndata[1] = 0;\r\ndata[2] = (u8)(phy_blk >> 8);\r\ndata[3] = (u8)phy_blk;\r\ndata[4] = 0x80;\r\ndata[5] = 0;\r\ndata[6] = extra[0] & 0x7F;\r\ndata[7] = 0xFF;\r\nretval = ms_write_bytes(chip, WRITE_REG, 7, NO_WAIT_INT, data, 7);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_send_cmd(chip, BLOCK_WRITE, WAIT_INT);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nms_set_err_code(chip, MS_NO_ERROR);\r\nretval = ms_read_bytes(chip, GET_INT, 1, NO_WAIT_INT, &val, 1);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (val & INT_REG_CMDNK) {\r\nms_set_err_code(chip, MS_CMD_NK);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (val & INT_REG_CED) {\r\nif (val & INT_REG_ERR) {\r\nms_set_err_code(chip, MS_FLASH_WRITE_ERROR);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int ms_erase_block(struct rtsx_chip *chip, u16 phy_blk)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval, i = 0;\r\nu8 val, data[6];\r\nretval = ms_set_rw_reg_addr(chip, OverwriteFlag, MS_EXTRA_SIZE,\r\nSystemParm, 6);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nms_set_err_code(chip, MS_NO_ERROR);\r\nif (CHK_MS4BIT(ms_card))\r\ndata[0] = 0x88;\r\nelse\r\ndata[0] = 0x80;\r\ndata[1] = 0;\r\ndata[2] = (u8)(phy_blk >> 8);\r\ndata[3] = (u8)phy_blk;\r\ndata[4] = 0;\r\ndata[5] = 0;\r\nretval = ms_write_bytes(chip, WRITE_REG, 6, NO_WAIT_INT, data, 6);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nERASE_RTY:\r\nretval = ms_send_cmd(chip, BLOCK_ERASE, WAIT_INT);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nms_set_err_code(chip, MS_NO_ERROR);\r\nretval = ms_read_bytes(chip, GET_INT, 1, NO_WAIT_INT, &val, 1);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (val & INT_REG_CMDNK) {\r\nif (i < 3) {\r\ni++;\r\ngoto ERASE_RTY;\r\n}\r\nms_set_err_code(chip, MS_CMD_NK);\r\nms_set_bad_block(chip, phy_blk);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (val & INT_REG_CED) {\r\nif (val & INT_REG_ERR) {\r\nms_set_err_code(chip, MS_FLASH_WRITE_ERROR);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic void ms_set_page_status(u16 log_blk, u8 type, u8 *extra, int extra_len)\r\n{\r\nif (!extra || (extra_len < MS_EXTRA_SIZE))\r\nreturn;\r\nmemset(extra, 0xFF, MS_EXTRA_SIZE);\r\nif (type == setPS_NG) {\r\nextra[0] = 0xB8;\r\n} else {\r\nextra[0] = 0x98;\r\n}\r\nextra[2] = (u8)(log_blk >> 8);\r\nextra[3] = (u8)log_blk;\r\n}\r\nstatic int ms_init_page(struct rtsx_chip *chip, u16 phy_blk, u16 log_blk,\r\nu8 start_page, u8 end_page)\r\n{\r\nint retval;\r\nu8 extra[MS_EXTRA_SIZE], i;\r\nmemset(extra, 0xff, MS_EXTRA_SIZE);\r\nextra[0] = 0xf8;\r\nextra[1] = 0xff;\r\nextra[2] = (u8)(log_blk >> 8);\r\nextra[3] = (u8)log_blk;\r\nfor (i = start_page; i < end_page; i++) {\r\nif (detect_card_cd(chip, MS_CARD) != STATUS_SUCCESS) {\r\nms_set_err_code(chip, MS_NO_CARD);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_write_extra_data(chip, phy_blk, i,\r\nextra, MS_EXTRA_SIZE);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int ms_copy_page(struct rtsx_chip *chip, u16 old_blk, u16 new_blk,\r\nu16 log_blk, u8 start_page, u8 end_page)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nbool uncorrect_flag = false;\r\nint retval, rty_cnt;\r\nu8 extra[MS_EXTRA_SIZE], val, i, j, data[16];\r\ndev_dbg(rtsx_dev(chip), "Copy page from 0x%x to 0x%x, logical block is 0x%x\n",\r\nold_blk, new_blk, log_blk);\r\ndev_dbg(rtsx_dev(chip), "start_page = %d, end_page = %d\n",\r\nstart_page, end_page);\r\nretval = ms_read_extra_data(chip, new_blk, 0, extra, MS_EXTRA_SIZE);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_read_status_reg(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = rtsx_read_register(chip, PPBUF_BASE2, &val);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nif (val & BUF_FULL) {\r\nretval = ms_send_cmd(chip, CLEAR_BUF, WAIT_INT);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_read_bytes(chip, GET_INT, 1, NO_WAIT_INT, &val, 1);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (!(val & INT_REG_CED)) {\r\nms_set_err_code(chip, MS_FLASH_WRITE_ERROR);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nfor (i = start_page; i < end_page; i++) {\r\nif (detect_card_cd(chip, MS_CARD) != STATUS_SUCCESS) {\r\nms_set_err_code(chip, MS_NO_CARD);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nms_read_extra_data(chip, old_blk, i, extra, MS_EXTRA_SIZE);\r\nretval = ms_set_rw_reg_addr(chip, OverwriteFlag,\r\nMS_EXTRA_SIZE, SystemParm, 6);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nms_set_err_code(chip, MS_NO_ERROR);\r\nif (CHK_MS4BIT(ms_card))\r\ndata[0] = 0x88;\r\nelse\r\ndata[0] = 0x80;\r\ndata[1] = 0;\r\ndata[2] = (u8)(old_blk >> 8);\r\ndata[3] = (u8)old_blk;\r\ndata[4] = 0x20;\r\ndata[5] = i;\r\nretval = ms_write_bytes(chip, WRITE_REG, 6, NO_WAIT_INT,\r\ndata, 6);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_send_cmd(chip, BLOCK_READ, WAIT_INT);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nms_set_err_code(chip, MS_NO_ERROR);\r\nretval = ms_read_bytes(chip, GET_INT, 1, NO_WAIT_INT, &val, 1);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (val & INT_REG_CMDNK) {\r\nms_set_err_code(chip, MS_CMD_NK);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (val & INT_REG_CED) {\r\nif (val & INT_REG_ERR) {\r\nretval = ms_read_status_reg(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nuncorrect_flag = true;\r\ndev_dbg(rtsx_dev(chip), "Uncorrectable error\n");\r\n} else {\r\nuncorrect_flag = false;\r\n}\r\nretval = ms_transfer_tpc(chip,\r\nMS_TM_NORMAL_READ,\r\nREAD_PAGE_DATA,\r\n0, NO_WAIT_INT);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (uncorrect_flag) {\r\nms_set_page_status(log_blk, setPS_NG,\r\nextra, MS_EXTRA_SIZE);\r\nif (i == 0)\r\nextra[0] &= 0xEF;\r\nms_write_extra_data(chip, old_blk, i,\r\nextra, MS_EXTRA_SIZE);\r\ndev_dbg(rtsx_dev(chip), "page %d : extra[0] = 0x%x\n",\r\ni, extra[0]);\r\nMS_SET_BAD_BLOCK_FLG(ms_card);\r\nms_set_page_status(log_blk, setPS_Error,\r\nextra, MS_EXTRA_SIZE);\r\nms_write_extra_data(chip, new_blk, i,\r\nextra, MS_EXTRA_SIZE);\r\ncontinue;\r\n}\r\nfor (rty_cnt = 0; rty_cnt < MS_MAX_RETRY_COUNT;\r\nrty_cnt++) {\r\nretval = ms_transfer_tpc(\r\nchip,\r\nMS_TM_NORMAL_WRITE,\r\nWRITE_PAGE_DATA,\r\n0, NO_WAIT_INT);\r\nif (retval == STATUS_SUCCESS)\r\nbreak;\r\n}\r\nif (rty_cnt == MS_MAX_RETRY_COUNT) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nif (!(val & INT_REG_BREQ)) {\r\nms_set_err_code(chip, MS_BREQ_ERROR);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nretval = ms_set_rw_reg_addr(chip, OverwriteFlag,\r\nMS_EXTRA_SIZE, SystemParm, (6 + MS_EXTRA_SIZE));\r\nms_set_err_code(chip, MS_NO_ERROR);\r\nif (CHK_MS4BIT(ms_card))\r\ndata[0] = 0x88;\r\nelse\r\ndata[0] = 0x80;\r\ndata[1] = 0;\r\ndata[2] = (u8)(new_blk >> 8);\r\ndata[3] = (u8)new_blk;\r\ndata[4] = 0x20;\r\ndata[5] = i;\r\nif ((extra[0] & 0x60) != 0x60)\r\ndata[6] = extra[0];\r\nelse\r\ndata[6] = 0xF8;\r\ndata[6 + 1] = 0xFF;\r\ndata[6 + 2] = (u8)(log_blk >> 8);\r\ndata[6 + 3] = (u8)log_blk;\r\nfor (j = 4; j <= MS_EXTRA_SIZE; j++)\r\ndata[6 + j] = 0xFF;\r\nretval = ms_write_bytes(chip, WRITE_REG, (6 + MS_EXTRA_SIZE),\r\nNO_WAIT_INT, data, 16);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_send_cmd(chip, BLOCK_WRITE, WAIT_INT);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nms_set_err_code(chip, MS_NO_ERROR);\r\nretval = ms_read_bytes(chip, GET_INT, 1, NO_WAIT_INT, &val, 1);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (val & INT_REG_CMDNK) {\r\nms_set_err_code(chip, MS_CMD_NK);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (val & INT_REG_CED) {\r\nif (val & INT_REG_ERR) {\r\nms_set_err_code(chip, MS_FLASH_WRITE_ERROR);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nif (i == 0) {\r\nretval = ms_set_rw_reg_addr(chip, OverwriteFlag,\r\nMS_EXTRA_SIZE, SystemParm, 7);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nms_set_err_code(chip, MS_NO_ERROR);\r\nif (CHK_MS4BIT(ms_card))\r\ndata[0] = 0x88;\r\nelse\r\ndata[0] = 0x80;\r\ndata[1] = 0;\r\ndata[2] = (u8)(old_blk >> 8);\r\ndata[3] = (u8)old_blk;\r\ndata[4] = 0x80;\r\ndata[5] = 0;\r\ndata[6] = 0xEF;\r\ndata[7] = 0xFF;\r\nretval = ms_write_bytes(chip, WRITE_REG, 7,\r\nNO_WAIT_INT, data, 8);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_send_cmd(chip, BLOCK_WRITE, WAIT_INT);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nms_set_err_code(chip, MS_NO_ERROR);\r\nretval = ms_read_bytes(chip, GET_INT, 1,\r\nNO_WAIT_INT, &val, 1);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (val & INT_REG_CMDNK) {\r\nms_set_err_code(chip, MS_CMD_NK);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (val & INT_REG_CED) {\r\nif (val & INT_REG_ERR) {\r\nms_set_err_code(chip,\r\nMS_FLASH_WRITE_ERROR);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\n}\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int reset_ms(struct rtsx_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval;\r\nu16 i, reg_addr, block_size;\r\nu8 val, extra[MS_EXTRA_SIZE], j, *ptr;\r\n#ifndef SUPPORT_MAGIC_GATE\r\nu16 eblock_cnt;\r\n#endif\r\nretval = ms_prepare_reset(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nms_card->ms_type |= TYPE_MS;\r\nretval = ms_send_cmd(chip, MS_RESET, NO_WAIT_INT);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_read_status_reg(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = rtsx_read_register(chip, PPBUF_BASE2, &val);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nif (val & WRT_PRTCT)\r\nchip->card_wp |= MS_CARD;\r\nelse\r\nchip->card_wp &= ~MS_CARD;\r\ni = 0;\r\nRE_SEARCH:\r\nwhile (i < (MAX_DEFECTIVE_BLOCK + 2)) {\r\nif (detect_card_cd(chip, MS_CARD) != STATUS_SUCCESS) {\r\nms_set_err_code(chip, MS_NO_CARD);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_read_extra_data(chip, i, 0, extra, MS_EXTRA_SIZE);\r\nif (retval != STATUS_SUCCESS) {\r\ni++;\r\ncontinue;\r\n}\r\nif (extra[0] & BLOCK_OK) {\r\nif (!(extra[1] & NOT_BOOT_BLOCK)) {\r\nms_card->boot_block = i;\r\nbreak;\r\n}\r\n}\r\ni++;\r\n}\r\nif (i == (MAX_DEFECTIVE_BLOCK + 2)) {\r\ndev_dbg(rtsx_dev(chip), "No boot block found!");\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nfor (j = 0; j < 3; j++) {\r\nretval = ms_read_page(chip, ms_card->boot_block, j);\r\nif (retval != STATUS_SUCCESS) {\r\nif (ms_check_err_code(chip, MS_FLASH_WRITE_ERROR)) {\r\ni = ms_card->boot_block + 1;\r\nms_set_err_code(chip, MS_NO_ERROR);\r\ngoto RE_SEARCH;\r\n}\r\n}\r\n}\r\nretval = ms_read_page(chip, ms_card->boot_block, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nrtsx_init_cmd(chip);\r\nfor (i = 0; i < 96; i++)\r\nrtsx_add_cmd(chip, READ_REG_CMD, PPBUF_BASE2 + 0x1A0 + i, 0, 0);\r\nretval = rtsx_send_cmd(chip, MS_CARD, 100);\r\nif (retval < 0) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nptr = rtsx_get_cmd_data(chip);\r\nmemcpy(ms_card->raw_sys_info, ptr, 96);\r\nrtsx_init_cmd(chip);\r\nrtsx_add_cmd(chip, READ_REG_CMD, HEADER_ID0, 0, 0);\r\nrtsx_add_cmd(chip, READ_REG_CMD, HEADER_ID1, 0, 0);\r\nfor (reg_addr = DISABLED_BLOCK0; reg_addr <= DISABLED_BLOCK3;\r\nreg_addr++)\r\nrtsx_add_cmd(chip, READ_REG_CMD, reg_addr, 0, 0);\r\nfor (reg_addr = BLOCK_SIZE_0; reg_addr <= PAGE_SIZE_1; reg_addr++)\r\nrtsx_add_cmd(chip, READ_REG_CMD, reg_addr, 0, 0);\r\nrtsx_add_cmd(chip, READ_REG_CMD, MS_Device_Type, 0, 0);\r\nrtsx_add_cmd(chip, READ_REG_CMD, MS_4bit_Support, 0, 0);\r\nretval = rtsx_send_cmd(chip, MS_CARD, 100);\r\nif (retval < 0) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nptr = rtsx_get_cmd_data(chip);\r\ndev_dbg(rtsx_dev(chip), "Boot block data:\n");\r\ndev_dbg(rtsx_dev(chip), "%*ph\n", 16, ptr);\r\nif (ptr[0] != 0x00 || ptr[1] != 0x01) {\r\ni = ms_card->boot_block + 1;\r\ngoto RE_SEARCH;\r\n}\r\nif (ptr[12] != 0x02 || ptr[13] != 0x00) {\r\ni = ms_card->boot_block + 1;\r\ngoto RE_SEARCH;\r\n}\r\nif ((ptr[14] == 1) || (ptr[14] == 3))\r\nchip->card_wp |= MS_CARD;\r\nblock_size = ((u16)ptr[6] << 8) | ptr[7];\r\nif (block_size == 0x0010) {\r\nms_card->block_shift = 5;\r\nms_card->page_off = 0x1F;\r\n} else if (block_size == 0x0008) {\r\nms_card->block_shift = 4;\r\nms_card->page_off = 0x0F;\r\n}\r\nms_card->total_block = ((u16)ptr[8] << 8) | ptr[9];\r\n#ifdef SUPPORT_MAGIC_GATE\r\nj = ptr[10];\r\nif (ms_card->block_shift == 4) {\r\nif (j < 2) {\r\nms_card->capacity = 0x1EE0;\r\n} else {\r\nms_card->capacity = 0x3DE0;\r\n}\r\n} else {\r\nif (j < 5) {\r\nms_card->capacity = 0x7BC0;\r\n} else if (j < 0xA) {\r\nms_card->capacity = 0xF7C0;\r\n} else if (j < 0x11) {\r\nms_card->capacity = 0x1EF80;\r\n} else {\r\nms_card->capacity = 0x3DF00;\r\n}\r\n}\r\n#else\r\neblock_cnt = ((u16)ptr[10] << 8) | ptr[11];\r\nms_card->capacity = ((u32)eblock_cnt - 2) << ms_card->block_shift;\r\n#endif\r\nchip->capacity[chip->card2lun[MS_CARD]] = ms_card->capacity;\r\nif (ptr[15]) {\r\nretval = ms_set_rw_reg_addr(chip, 0, 0, SystemParm, 1);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = rtsx_write_register(chip, PPBUF_BASE2, 0xFF, 0x88);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = rtsx_write_register(chip, PPBUF_BASE2 + 1, 0xFF, 0);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nretval = ms_transfer_tpc(chip, MS_TM_WRITE_BYTES, WRITE_REG, 1,\r\nNO_WAIT_INT);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = rtsx_write_register(chip, MS_CFG,\r\n0x58 | MS_NO_CHECK_INT,\r\nMS_BUS_WIDTH_4 | PUSH_TIME_ODD | MS_NO_CHECK_INT);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nms_card->ms_type |= MS_4BIT;\r\n}\r\nif (CHK_MS4BIT(ms_card))\r\nchip->card_bus_width[chip->card2lun[MS_CARD]] = 4;\r\nelse\r\nchip->card_bus_width[chip->card2lun[MS_CARD]] = 1;\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int ms_init_l2p_tbl(struct rtsx_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint size, i, seg_no, retval;\r\nu16 defect_block, reg_addr;\r\nu8 val1, val2;\r\nms_card->segment_cnt = ms_card->total_block >> 9;\r\ndev_dbg(rtsx_dev(chip), "ms_card->segment_cnt = %d\n",\r\nms_card->segment_cnt);\r\nsize = ms_card->segment_cnt * sizeof(struct zone_entry);\r\nms_card->segment = vzalloc(size);\r\nif (ms_card->segment == NULL) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_read_page(chip, ms_card->boot_block, 1);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto INIT_FAIL;\r\n}\r\nreg_addr = PPBUF_BASE2;\r\nfor (i = 0; i < (((ms_card->total_block >> 9) * 10) + 1); i++) {\r\nint block_no;\r\nretval = rtsx_read_register(chip, reg_addr++, &val1);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto INIT_FAIL;\r\n}\r\nretval = rtsx_read_register(chip, reg_addr++, &val2);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto INIT_FAIL;\r\n}\r\ndefect_block = ((u16)val1 << 8) | val2;\r\nif (defect_block == 0xFFFF)\r\nbreak;\r\nseg_no = defect_block / 512;\r\nblock_no = ms_card->segment[seg_no].disable_count++;\r\nms_card->segment[seg_no].defect_list[block_no] = defect_block;\r\n}\r\nfor (i = 0; i < ms_card->segment_cnt; i++) {\r\nms_card->segment[i].build_flag = 0;\r\nms_card->segment[i].l2p_table = NULL;\r\nms_card->segment[i].free_table = NULL;\r\nms_card->segment[i].get_index = 0;\r\nms_card->segment[i].set_index = 0;\r\nms_card->segment[i].unused_blk_cnt = 0;\r\ndev_dbg(rtsx_dev(chip), "defective block count of segment %d is %d\n",\r\ni, ms_card->segment[i].disable_count);\r\n}\r\nreturn STATUS_SUCCESS;\r\nINIT_FAIL:\r\nif (ms_card->segment) {\r\nvfree(ms_card->segment);\r\nms_card->segment = NULL;\r\n}\r\nreturn STATUS_FAIL;\r\n}\r\nstatic u16 ms_get_l2p_tbl(struct rtsx_chip *chip, int seg_no, u16 log_off)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nstruct zone_entry *segment;\r\nif (ms_card->segment == NULL)\r\nreturn 0xFFFF;\r\nsegment = &(ms_card->segment[seg_no]);\r\nif (segment->l2p_table)\r\nreturn segment->l2p_table[log_off];\r\nreturn 0xFFFF;\r\n}\r\nstatic void ms_set_l2p_tbl(struct rtsx_chip *chip,\r\nint seg_no, u16 log_off, u16 phy_blk)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nstruct zone_entry *segment;\r\nif (ms_card->segment == NULL)\r\nreturn;\r\nsegment = &(ms_card->segment[seg_no]);\r\nif (segment->l2p_table)\r\nsegment->l2p_table[log_off] = phy_blk;\r\n}\r\nstatic void ms_set_unused_block(struct rtsx_chip *chip, u16 phy_blk)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nstruct zone_entry *segment;\r\nint seg_no;\r\nseg_no = (int)phy_blk >> 9;\r\nsegment = &(ms_card->segment[seg_no]);\r\nsegment->free_table[segment->set_index++] = phy_blk;\r\nif (segment->set_index >= MS_FREE_TABLE_CNT)\r\nsegment->set_index = 0;\r\nsegment->unused_blk_cnt++;\r\n}\r\nstatic u16 ms_get_unused_block(struct rtsx_chip *chip, int seg_no)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nstruct zone_entry *segment;\r\nu16 phy_blk;\r\nsegment = &(ms_card->segment[seg_no]);\r\nif (segment->unused_blk_cnt <= 0)\r\nreturn 0xFFFF;\r\nphy_blk = segment->free_table[segment->get_index];\r\nsegment->free_table[segment->get_index++] = 0xFFFF;\r\nif (segment->get_index >= MS_FREE_TABLE_CNT)\r\nsegment->get_index = 0;\r\nsegment->unused_blk_cnt--;\r\nreturn phy_blk;\r\n}\r\nstatic int ms_arbitrate_l2p(struct rtsx_chip *chip, u16 phy_blk,\r\nu16 log_off, u8 us1, u8 us2)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nstruct zone_entry *segment;\r\nint seg_no;\r\nu16 tmp_blk;\r\nseg_no = (int)phy_blk >> 9;\r\nsegment = &(ms_card->segment[seg_no]);\r\ntmp_blk = segment->l2p_table[log_off];\r\nif (us1 != us2) {\r\nif (us1 == 0) {\r\nif (!(chip->card_wp & MS_CARD))\r\nms_erase_block(chip, tmp_blk);\r\nms_set_unused_block(chip, tmp_blk);\r\nsegment->l2p_table[log_off] = phy_blk;\r\n} else {\r\nif (!(chip->card_wp & MS_CARD))\r\nms_erase_block(chip, phy_blk);\r\nms_set_unused_block(chip, phy_blk);\r\n}\r\n} else {\r\nif (phy_blk < tmp_blk) {\r\nif (!(chip->card_wp & MS_CARD))\r\nms_erase_block(chip, phy_blk);\r\nms_set_unused_block(chip, phy_blk);\r\n} else {\r\nif (!(chip->card_wp & MS_CARD))\r\nms_erase_block(chip, tmp_blk);\r\nms_set_unused_block(chip, tmp_blk);\r\nsegment->l2p_table[log_off] = phy_blk;\r\n}\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int ms_build_l2p_tbl(struct rtsx_chip *chip, int seg_no)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nstruct zone_entry *segment;\r\nbool defect_flag;\r\nint retval, table_size, disable_cnt, i;\r\nu16 start, end, phy_blk, log_blk, tmp_blk, idx;\r\nu8 extra[MS_EXTRA_SIZE], us1, us2;\r\ndev_dbg(rtsx_dev(chip), "ms_build_l2p_tbl: %d\n", seg_no);\r\nif (ms_card->segment == NULL) {\r\nretval = ms_init_l2p_tbl(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\n}\r\nif (ms_card->segment[seg_no].build_flag) {\r\ndev_dbg(rtsx_dev(chip), "l2p table of segment %d has been built\n",\r\nseg_no);\r\nreturn STATUS_SUCCESS;\r\n}\r\nif (seg_no == 0)\r\ntable_size = 494;\r\nelse\r\ntable_size = 496;\r\nsegment = &(ms_card->segment[seg_no]);\r\nif (segment->l2p_table == NULL) {\r\nsegment->l2p_table = vmalloc(table_size * 2);\r\nif (segment->l2p_table == NULL) {\r\nrtsx_trace(chip);\r\ngoto BUILD_FAIL;\r\n}\r\n}\r\nmemset((u8 *)(segment->l2p_table), 0xff, table_size * 2);\r\nif (segment->free_table == NULL) {\r\nsegment->free_table = vmalloc(MS_FREE_TABLE_CNT * 2);\r\nif (segment->free_table == NULL) {\r\nrtsx_trace(chip);\r\ngoto BUILD_FAIL;\r\n}\r\n}\r\nmemset((u8 *)(segment->free_table), 0xff, MS_FREE_TABLE_CNT * 2);\r\nstart = (u16)seg_no << 9;\r\nend = (u16)(seg_no + 1) << 9;\r\ndisable_cnt = segment->disable_count;\r\nsegment->get_index = segment->set_index = 0;\r\nsegment->unused_blk_cnt = 0;\r\nfor (phy_blk = start; phy_blk < end; phy_blk++) {\r\nif (disable_cnt) {\r\ndefect_flag = false;\r\nfor (i = 0; i < segment->disable_count; i++) {\r\nif (phy_blk == segment->defect_list[i]) {\r\ndefect_flag = true;\r\nbreak;\r\n}\r\n}\r\nif (defect_flag) {\r\ndisable_cnt--;\r\ncontinue;\r\n}\r\n}\r\nretval = ms_read_extra_data(chip, phy_blk, 0,\r\nextra, MS_EXTRA_SIZE);\r\nif (retval != STATUS_SUCCESS) {\r\ndev_dbg(rtsx_dev(chip), "read extra data fail\n");\r\nms_set_bad_block(chip, phy_blk);\r\ncontinue;\r\n}\r\nif (seg_no == ms_card->segment_cnt - 1) {\r\nif (!(extra[1] & NOT_TRANSLATION_TABLE)) {\r\nif (!(chip->card_wp & MS_CARD)) {\r\nretval = ms_erase_block(chip, phy_blk);\r\nif (retval != STATUS_SUCCESS)\r\ncontinue;\r\nextra[2] = 0xff;\r\nextra[3] = 0xff;\r\n}\r\n}\r\n}\r\nif (!(extra[0] & BLOCK_OK))\r\ncontinue;\r\nif (!(extra[1] & NOT_BOOT_BLOCK))\r\ncontinue;\r\nif ((extra[0] & PAGE_OK) != PAGE_OK)\r\ncontinue;\r\nlog_blk = ((u16)extra[2] << 8) | extra[3];\r\nif (log_blk == 0xFFFF) {\r\nif (!(chip->card_wp & MS_CARD)) {\r\nretval = ms_erase_block(chip, phy_blk);\r\nif (retval != STATUS_SUCCESS)\r\ncontinue;\r\n}\r\nms_set_unused_block(chip, phy_blk);\r\ncontinue;\r\n}\r\nif ((log_blk < ms_start_idx[seg_no]) ||\r\n(log_blk >= ms_start_idx[seg_no+1])) {\r\nif (!(chip->card_wp & MS_CARD)) {\r\nretval = ms_erase_block(chip, phy_blk);\r\nif (retval != STATUS_SUCCESS)\r\ncontinue;\r\n}\r\nms_set_unused_block(chip, phy_blk);\r\ncontinue;\r\n}\r\nidx = log_blk - ms_start_idx[seg_no];\r\nif (segment->l2p_table[idx] == 0xFFFF) {\r\nsegment->l2p_table[idx] = phy_blk;\r\ncontinue;\r\n}\r\nus1 = extra[0] & 0x10;\r\ntmp_blk = segment->l2p_table[idx];\r\nretval = ms_read_extra_data(chip, tmp_blk, 0,\r\nextra, MS_EXTRA_SIZE);\r\nif (retval != STATUS_SUCCESS)\r\ncontinue;\r\nus2 = extra[0] & 0x10;\r\n(void)ms_arbitrate_l2p(chip, phy_blk,\r\nlog_blk-ms_start_idx[seg_no], us1, us2);\r\ncontinue;\r\n}\r\nsegment->build_flag = 1;\r\ndev_dbg(rtsx_dev(chip), "unused block count: %d\n",\r\nsegment->unused_blk_cnt);\r\nif (seg_no == ms_card->segment_cnt - 1) {\r\nif (segment->unused_blk_cnt < 2)\r\nchip->card_wp |= MS_CARD;\r\n} else {\r\nif (segment->unused_blk_cnt < 1)\r\nchip->card_wp |= MS_CARD;\r\n}\r\nif (chip->card_wp & MS_CARD)\r\nreturn STATUS_SUCCESS;\r\nfor (log_blk = ms_start_idx[seg_no];\r\nlog_blk < ms_start_idx[seg_no + 1]; log_blk++) {\r\nidx = log_blk - ms_start_idx[seg_no];\r\nif (segment->l2p_table[idx] == 0xFFFF) {\r\nphy_blk = ms_get_unused_block(chip, seg_no);\r\nif (phy_blk == 0xFFFF) {\r\nchip->card_wp |= MS_CARD;\r\nreturn STATUS_SUCCESS;\r\n}\r\nretval = ms_init_page(chip, phy_blk, log_blk, 0, 1);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\ngoto BUILD_FAIL;\r\n}\r\nsegment->l2p_table[idx] = phy_blk;\r\nif (seg_no == ms_card->segment_cnt - 1) {\r\nif (segment->unused_blk_cnt < 2) {\r\nchip->card_wp |= MS_CARD;\r\nreturn STATUS_SUCCESS;\r\n}\r\n} else {\r\nif (segment->unused_blk_cnt < 1) {\r\nchip->card_wp |= MS_CARD;\r\nreturn STATUS_SUCCESS;\r\n}\r\n}\r\n}\r\n}\r\nif (seg_no == 0) {\r\nfor (log_blk = 0; log_blk < 494; log_blk++) {\r\ntmp_blk = segment->l2p_table[log_blk];\r\nif (tmp_blk < ms_card->boot_block) {\r\ndev_dbg(rtsx_dev(chip), "Boot block is not the first normal block.\n");\r\nif (chip->card_wp & MS_CARD)\r\nbreak;\r\nphy_blk = ms_get_unused_block(chip, 0);\r\nretval = ms_copy_page(chip, tmp_blk, phy_blk,\r\nlog_blk, 0, ms_card->page_off + 1);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nsegment->l2p_table[log_blk] = phy_blk;\r\nretval = ms_set_bad_block(chip, tmp_blk);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\n}\r\n}\r\nreturn STATUS_SUCCESS;\r\nBUILD_FAIL:\r\nsegment->build_flag = 0;\r\nif (segment->l2p_table) {\r\nvfree(segment->l2p_table);\r\nsegment->l2p_table = NULL;\r\n}\r\nif (segment->free_table) {\r\nvfree(segment->free_table);\r\nsegment->free_table = NULL;\r\n}\r\nreturn STATUS_FAIL;\r\n}\r\nint reset_ms_card(struct rtsx_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval;\r\nmemset(ms_card, 0, sizeof(struct ms_info));\r\nretval = enable_card_clock(chip, MS_CARD);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = select_card(chip, MS_CARD);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nms_card->ms_type = 0;\r\nretval = reset_ms_pro(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nif (ms_card->check_ms_flow) {\r\nretval = reset_ms(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n} else {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nretval = ms_set_init_para(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (!CHK_MSPRO(ms_card)) {\r\nretval = ms_build_l2p_tbl(chip, ms_card->total_block / 512 - 1);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\ndev_dbg(rtsx_dev(chip), "ms_card->ms_type = 0x%x\n", ms_card->ms_type);\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int mspro_set_rw_cmd(struct rtsx_chip *chip,\r\nu32 start_sec, u16 sec_cnt, u8 cmd)\r\n{\r\nint retval, i;\r\nu8 data[8];\r\ndata[0] = cmd;\r\ndata[1] = (u8)(sec_cnt >> 8);\r\ndata[2] = (u8)sec_cnt;\r\ndata[3] = (u8)(start_sec >> 24);\r\ndata[4] = (u8)(start_sec >> 16);\r\ndata[5] = (u8)(start_sec >> 8);\r\ndata[6] = (u8)start_sec;\r\ndata[7] = 0;\r\nfor (i = 0; i < MS_MAX_RETRY_COUNT; i++) {\r\nretval = ms_write_bytes(chip, PRO_EX_SET_CMD, 7,\r\nWAIT_INT, data, 8);\r\nif (retval == STATUS_SUCCESS)\r\nbreak;\r\n}\r\nif (i == MS_MAX_RETRY_COUNT) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nvoid mspro_stop_seq_mode(struct rtsx_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval;\r\nif (ms_card->seq_mode) {\r\nretval = ms_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS)\r\nreturn;\r\nms_card->seq_mode = 0;\r\nms_card->total_sec_cnt = 0;\r\nms_send_cmd(chip, PRO_STOP, WAIT_INT);\r\nrtsx_write_register(chip, RBCTL, RB_FLUSH, RB_FLUSH);\r\n}\r\n}\r\nstatic inline int ms_auto_tune_clock(struct rtsx_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval;\r\nif (chip->asic_code) {\r\nif (ms_card->ms_clock > 30)\r\nms_card->ms_clock -= 20;\r\n} else {\r\nif (ms_card->ms_clock == CLK_80)\r\nms_card->ms_clock = CLK_60;\r\nelse if (ms_card->ms_clock == CLK_60)\r\nms_card->ms_clock = CLK_40;\r\n}\r\nretval = ms_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int mspro_rw_multi_sector(struct scsi_cmnd *srb,\r\nstruct rtsx_chip *chip, u32 start_sector,\r\nu16 sector_cnt)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nbool mode_2k = false;\r\nint retval;\r\nu16 count;\r\nu8 val, trans_mode, rw_tpc, rw_cmd;\r\nms_set_err_code(chip, MS_NO_ERROR);\r\nms_card->cleanup_counter = 0;\r\nif (CHK_MSHG(ms_card)) {\r\nif ((start_sector % 4) || (sector_cnt % 4)) {\r\nif (srb->sc_data_direction == DMA_FROM_DEVICE) {\r\nrw_tpc = PRO_READ_LONG_DATA;\r\nrw_cmd = PRO_READ_DATA;\r\n} else {\r\nrw_tpc = PRO_WRITE_LONG_DATA;\r\nrw_cmd = PRO_WRITE_DATA;\r\n}\r\n} else {\r\nif (srb->sc_data_direction == DMA_FROM_DEVICE) {\r\nrw_tpc = PRO_READ_QUAD_DATA;\r\nrw_cmd = PRO_READ_2K_DATA;\r\n} else {\r\nrw_tpc = PRO_WRITE_QUAD_DATA;\r\nrw_cmd = PRO_WRITE_2K_DATA;\r\n}\r\nmode_2k = true;\r\n}\r\n} else {\r\nif (srb->sc_data_direction == DMA_FROM_DEVICE) {\r\nrw_tpc = PRO_READ_LONG_DATA;\r\nrw_cmd = PRO_READ_DATA;\r\n} else {\r\nrw_tpc = PRO_WRITE_LONG_DATA;\r\nrw_cmd = PRO_WRITE_DATA;\r\n}\r\n}\r\nretval = ms_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (srb->sc_data_direction == DMA_FROM_DEVICE)\r\ntrans_mode = MS_TM_AUTO_READ;\r\nelse\r\ntrans_mode = MS_TM_AUTO_WRITE;\r\nretval = rtsx_read_register(chip, MS_TRANS_CFG, &val);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nif (ms_card->seq_mode) {\r\nif ((ms_card->pre_dir != srb->sc_data_direction)\r\n|| ((ms_card->pre_sec_addr + ms_card->pre_sec_cnt) != start_sector)\r\n|| (mode_2k && (ms_card->seq_mode & MODE_512_SEQ))\r\n|| (!mode_2k && (ms_card->seq_mode & MODE_2K_SEQ))\r\n|| !(val & MS_INT_BREQ)\r\n|| ((ms_card->total_sec_cnt + sector_cnt) > 0xFE00)) {\r\nms_card->seq_mode = 0;\r\nms_card->total_sec_cnt = 0;\r\nif (val & MS_INT_BREQ) {\r\nretval = ms_send_cmd(chip, PRO_STOP, WAIT_INT);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nrtsx_write_register(chip, RBCTL, RB_FLUSH, RB_FLUSH);\r\n}\r\n}\r\n}\r\nif (!ms_card->seq_mode) {\r\nms_card->total_sec_cnt = 0;\r\nif (sector_cnt >= SEQ_START_CRITERIA) {\r\nif ((ms_card->capacity - start_sector) > 0xFE00)\r\ncount = 0xFE00;\r\nelse\r\ncount = (u16)(ms_card->capacity - start_sector);\r\nif (count > sector_cnt) {\r\nif (mode_2k)\r\nms_card->seq_mode = MODE_2K_SEQ;\r\nelse\r\nms_card->seq_mode = MODE_512_SEQ;\r\n}\r\n} else {\r\ncount = sector_cnt;\r\n}\r\nretval = mspro_set_rw_cmd(chip, start_sector, count, rw_cmd);\r\nif (retval != STATUS_SUCCESS) {\r\nms_card->seq_mode = 0;\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nretval = ms_transfer_data(chip, trans_mode, rw_tpc, sector_cnt,\r\nWAIT_INT, mode_2k, scsi_sg_count(srb),\r\nscsi_sglist(srb), scsi_bufflen(srb));\r\nif (retval != STATUS_SUCCESS) {\r\nms_card->seq_mode = 0;\r\nrtsx_read_register(chip, MS_TRANS_CFG, &val);\r\nrtsx_clear_ms_error(chip);\r\nif (detect_card_cd(chip, MS_CARD) != STATUS_SUCCESS) {\r\nchip->rw_need_retry = 0;\r\ndev_dbg(rtsx_dev(chip), "No card exist, exit mspro_rw_multi_sector\n");\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (val & MS_INT_BREQ)\r\nms_send_cmd(chip, PRO_STOP, WAIT_INT);\r\nif (val & (MS_CRC16_ERR | MS_RDY_TIMEOUT)) {\r\ndev_dbg(rtsx_dev(chip), "MSPro CRC error, tune clock!\n");\r\nchip->rw_need_retry = 1;\r\nms_auto_tune_clock(chip);\r\n}\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nif (ms_card->seq_mode) {\r\nms_card->pre_sec_addr = start_sector;\r\nms_card->pre_sec_cnt = sector_cnt;\r\nms_card->pre_dir = srb->sc_data_direction;\r\nms_card->total_sec_cnt += sector_cnt;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int mspro_read_format_progress(struct rtsx_chip *chip,\r\nconst int short_data_len)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval, i;\r\nu32 total_progress, cur_progress;\r\nu8 cnt, tmp;\r\nu8 data[8];\r\ndev_dbg(rtsx_dev(chip), "mspro_read_format_progress, short_data_len = %d\n",\r\nshort_data_len);\r\nretval = ms_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nms_card->format_status = FORMAT_FAIL;\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = rtsx_read_register(chip, MS_TRANS_CFG, &tmp);\r\nif (retval != STATUS_SUCCESS) {\r\nms_card->format_status = FORMAT_FAIL;\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (!(tmp & MS_INT_BREQ)) {\r\nif ((tmp & (MS_INT_CED | MS_INT_BREQ | MS_INT_CMDNK | MS_INT_ERR)) == MS_INT_CED) {\r\nms_card->format_status = FORMAT_SUCCESS;\r\nreturn STATUS_SUCCESS;\r\n}\r\nms_card->format_status = FORMAT_FAIL;\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (short_data_len >= 256)\r\ncnt = 0;\r\nelse\r\ncnt = (u8)short_data_len;\r\nretval = rtsx_write_register(chip, MS_CFG, MS_NO_CHECK_INT,\r\nMS_NO_CHECK_INT);\r\nif (retval != STATUS_SUCCESS) {\r\nms_card->format_status = FORMAT_FAIL;\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_read_bytes(chip, PRO_READ_SHORT_DATA, cnt, WAIT_INT,\r\ndata, 8);\r\nif (retval != STATUS_SUCCESS) {\r\nms_card->format_status = FORMAT_FAIL;\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\ntotal_progress = (data[0] << 24) | (data[1] << 16) |\r\n(data[2] << 8) | data[3];\r\ncur_progress = (data[4] << 24) | (data[5] << 16) |\r\n(data[6] << 8) | data[7];\r\ndev_dbg(rtsx_dev(chip), "total_progress = %d, cur_progress = %d\n",\r\ntotal_progress, cur_progress);\r\nif (total_progress == 0) {\r\nms_card->progress = 0;\r\n} else {\r\nu64 ulltmp = (u64)cur_progress * (u64)65535;\r\ndo_div(ulltmp, total_progress);\r\nms_card->progress = (u16)ulltmp;\r\n}\r\ndev_dbg(rtsx_dev(chip), "progress = %d\n", ms_card->progress);\r\nfor (i = 0; i < 5000; i++) {\r\nretval = rtsx_read_register(chip, MS_TRANS_CFG, &tmp);\r\nif (retval != STATUS_SUCCESS) {\r\nms_card->format_status = FORMAT_FAIL;\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (tmp & (MS_INT_CED | MS_INT_CMDNK |\r\nMS_INT_BREQ | MS_INT_ERR))\r\nbreak;\r\nwait_timeout(1);\r\n}\r\nretval = rtsx_write_register(chip, MS_CFG, MS_NO_CHECK_INT, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nms_card->format_status = FORMAT_FAIL;\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (i == 5000) {\r\nms_card->format_status = FORMAT_FAIL;\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (tmp & (MS_INT_CMDNK | MS_INT_ERR)) {\r\nms_card->format_status = FORMAT_FAIL;\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (tmp & MS_INT_CED) {\r\nms_card->format_status = FORMAT_SUCCESS;\r\nms_card->pro_under_formatting = 0;\r\n} else if (tmp & MS_INT_BREQ) {\r\nms_card->format_status = FORMAT_IN_PROGRESS;\r\n} else {\r\nms_card->format_status = FORMAT_FAIL;\r\nms_card->pro_under_formatting = 0;\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nvoid mspro_polling_format_status(struct rtsx_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint i;\r\nif (ms_card->pro_under_formatting &&\r\n(rtsx_get_stat(chip) != RTSX_STAT_SS)) {\r\nrtsx_set_stat(chip, RTSX_STAT_RUN);\r\nfor (i = 0; i < 65535; i++) {\r\nmspro_read_format_progress(chip, MS_SHORT_DATA_LEN);\r\nif (ms_card->format_status != FORMAT_IN_PROGRESS)\r\nbreak;\r\n}\r\n}\r\n}\r\nint mspro_format(struct scsi_cmnd *srb, struct rtsx_chip *chip,\r\nint short_data_len, bool quick_format)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval, i;\r\nu8 buf[8], tmp;\r\nu16 para;\r\nretval = ms_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_set_rw_reg_addr(chip, 0x00, 0x00, Pro_TPCParm, 0x01);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nmemset(buf, 0, 2);\r\nswitch (short_data_len) {\r\ncase 32:\r\nbuf[0] = 0;\r\nbreak;\r\ncase 64:\r\nbuf[0] = 1;\r\nbreak;\r\ncase 128:\r\nbuf[0] = 2;\r\nbreak;\r\ncase 256:\r\ndefault:\r\nbuf[0] = 3;\r\nbreak;\r\n}\r\nfor (i = 0; i < MS_MAX_RETRY_COUNT; i++) {\r\nretval = ms_write_bytes(chip, PRO_WRITE_REG, 1,\r\nNO_WAIT_INT, buf, 2);\r\nif (retval == STATUS_SUCCESS)\r\nbreak;\r\n}\r\nif (i == MS_MAX_RETRY_COUNT) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (quick_format)\r\npara = 0x0000;\r\nelse\r\npara = 0x0001;\r\nretval = mspro_set_rw_cmd(chip, 0, para, PRO_FORMAT);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = rtsx_read_register(chip, MS_TRANS_CFG, &tmp);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nif (tmp & (MS_INT_CMDNK | MS_INT_ERR)) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif ((tmp & (MS_INT_BREQ | MS_INT_CED)) == MS_INT_BREQ) {\r\nms_card->pro_under_formatting = 1;\r\nms_card->progress = 0;\r\nms_card->format_status = FORMAT_IN_PROGRESS;\r\nreturn STATUS_SUCCESS;\r\n}\r\nif (tmp & MS_INT_CED) {\r\nms_card->pro_under_formatting = 0;\r\nms_card->progress = 0;\r\nms_card->format_status = FORMAT_SUCCESS;\r\nset_sense_type(chip, SCSI_LUN(srb), SENSE_TYPE_NO_SENSE);\r\nreturn STATUS_SUCCESS;\r\n}\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nstatic int ms_read_multiple_pages(struct rtsx_chip *chip, u16 phy_blk,\r\nu16 log_blk, u8 start_page, u8 end_page,\r\nu8 *buf, unsigned int *index,\r\nunsigned int *offset)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval, i;\r\nu8 extra[MS_EXTRA_SIZE], page_addr, val, trans_cfg, data[6];\r\nu8 *ptr;\r\nretval = ms_read_extra_data(chip, phy_blk, start_page,\r\nextra, MS_EXTRA_SIZE);\r\nif (retval == STATUS_SUCCESS) {\r\nif ((extra[1] & 0x30) != 0x30) {\r\nms_set_err_code(chip, MS_FLASH_READ_ERROR);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nretval = ms_set_rw_reg_addr(chip, OverwriteFlag, MS_EXTRA_SIZE,\r\nSystemParm, 6);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (CHK_MS4BIT(ms_card))\r\ndata[0] = 0x88;\r\nelse\r\ndata[0] = 0x80;\r\ndata[1] = 0;\r\ndata[2] = (u8)(phy_blk >> 8);\r\ndata[3] = (u8)phy_blk;\r\ndata[4] = 0;\r\ndata[5] = start_page;\r\nfor (i = 0; i < MS_MAX_RETRY_COUNT; i++) {\r\nretval = ms_write_bytes(chip, WRITE_REG, 6, NO_WAIT_INT,\r\ndata, 6);\r\nif (retval == STATUS_SUCCESS)\r\nbreak;\r\n}\r\nif (i == MS_MAX_RETRY_COUNT) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nms_set_err_code(chip, MS_NO_ERROR);\r\nretval = ms_send_cmd(chip, BLOCK_READ, WAIT_INT);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nptr = buf;\r\nfor (page_addr = start_page; page_addr < end_page; page_addr++) {\r\nms_set_err_code(chip, MS_NO_ERROR);\r\nif (detect_card_cd(chip, MS_CARD) != STATUS_SUCCESS) {\r\nms_set_err_code(chip, MS_NO_CARD);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_read_bytes(chip, GET_INT, 1, NO_WAIT_INT, &val, 1);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (val & INT_REG_CMDNK) {\r\nms_set_err_code(chip, MS_CMD_NK);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (val & INT_REG_ERR) {\r\nif (val & INT_REG_BREQ) {\r\nretval = ms_read_status_reg(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nif (!(chip->card_wp & MS_CARD)) {\r\nreset_ms(chip);\r\nms_set_page_status(log_blk, setPS_NG, extra, MS_EXTRA_SIZE);\r\nms_write_extra_data(chip, phy_blk,\r\npage_addr, extra, MS_EXTRA_SIZE);\r\n}\r\nms_set_err_code(chip, MS_FLASH_READ_ERROR);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n} else {\r\nms_set_err_code(chip, MS_FLASH_READ_ERROR);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n} else {\r\nif (!(val & INT_REG_BREQ)) {\r\nms_set_err_code(chip, MS_BREQ_ERROR);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nif (page_addr == (end_page - 1)) {\r\nif (!(val & INT_REG_CED)) {\r\nretval = ms_send_cmd(chip, BLOCK_END, WAIT_INT);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nretval = ms_read_bytes(chip, GET_INT, 1, NO_WAIT_INT,\r\n&val, 1);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (!(val & INT_REG_CED)) {\r\nms_set_err_code(chip, MS_FLASH_READ_ERROR);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\ntrans_cfg = NO_WAIT_INT;\r\n} else {\r\ntrans_cfg = WAIT_INT;\r\n}\r\nrtsx_init_cmd(chip);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, MS_TPC, 0xFF, READ_PAGE_DATA);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, MS_TRANS_CFG,\r\n0xFF, trans_cfg);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_DATA_SOURCE,\r\n0x01, RING_BUFFER);\r\ntrans_dma_enable(DMA_FROM_DEVICE, chip, 512, DMA_512);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, MS_TRANSFER, 0xFF,\r\nMS_TRANSFER_START | MS_TM_NORMAL_READ);\r\nrtsx_add_cmd(chip, CHECK_REG_CMD, MS_TRANSFER,\r\nMS_TRANSFER_END, MS_TRANSFER_END);\r\nrtsx_send_cmd_no_wait(chip);\r\nretval = rtsx_transfer_data_partial(chip, MS_CARD, ptr,\r\n512, scsi_sg_count(chip->srb),\r\nindex, offset, DMA_FROM_DEVICE,\r\nchip->ms_timeout);\r\nif (retval < 0) {\r\nif (retval == -ETIMEDOUT) {\r\nms_set_err_code(chip, MS_TO_ERROR);\r\nrtsx_clear_ms_error(chip);\r\nrtsx_trace(chip);\r\nreturn STATUS_TIMEDOUT;\r\n}\r\nretval = rtsx_read_register(chip, MS_TRANS_CFG, &val);\r\nif (retval != STATUS_SUCCESS) {\r\nms_set_err_code(chip, MS_TO_ERROR);\r\nrtsx_clear_ms_error(chip);\r\nrtsx_trace(chip);\r\nreturn STATUS_TIMEDOUT;\r\n}\r\nif (val & (MS_CRC16_ERR | MS_RDY_TIMEOUT)) {\r\nms_set_err_code(chip, MS_CRC16_ERROR);\r\nrtsx_clear_ms_error(chip);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nif (scsi_sg_count(chip->srb) == 0)\r\nptr += 512;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int ms_write_multiple_pages(struct rtsx_chip *chip, u16 old_blk,\r\nu16 new_blk, u16 log_blk, u8 start_page,\r\nu8 end_page, u8 *buf, unsigned int *index,\r\nunsigned int *offset)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval, i;\r\nu8 page_addr, val, data[16];\r\nu8 *ptr;\r\nif (!start_page) {\r\nretval = ms_set_rw_reg_addr(chip, OverwriteFlag, MS_EXTRA_SIZE,\r\nSystemParm, 7);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (CHK_MS4BIT(ms_card))\r\ndata[0] = 0x88;\r\nelse\r\ndata[0] = 0x80;\r\ndata[1] = 0;\r\ndata[2] = (u8)(old_blk >> 8);\r\ndata[3] = (u8)old_blk;\r\ndata[4] = 0x80;\r\ndata[5] = 0;\r\ndata[6] = 0xEF;\r\ndata[7] = 0xFF;\r\nretval = ms_write_bytes(chip, WRITE_REG, 7, NO_WAIT_INT,\r\ndata, 8);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_send_cmd(chip, BLOCK_WRITE, WAIT_INT);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nms_set_err_code(chip, MS_NO_ERROR);\r\nretval = ms_transfer_tpc(chip, MS_TM_READ_BYTES, GET_INT, 1,\r\nNO_WAIT_INT);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nretval = ms_set_rw_reg_addr(chip, OverwriteFlag, MS_EXTRA_SIZE,\r\nSystemParm, (6 + MS_EXTRA_SIZE));\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nms_set_err_code(chip, MS_NO_ERROR);\r\nif (CHK_MS4BIT(ms_card))\r\ndata[0] = 0x88;\r\nelse\r\ndata[0] = 0x80;\r\ndata[1] = 0;\r\ndata[2] = (u8)(new_blk >> 8);\r\ndata[3] = (u8)new_blk;\r\nif ((end_page - start_page) == 1)\r\ndata[4] = 0x20;\r\nelse\r\ndata[4] = 0;\r\ndata[5] = start_page;\r\ndata[6] = 0xF8;\r\ndata[7] = 0xFF;\r\ndata[8] = (u8)(log_blk >> 8);\r\ndata[9] = (u8)log_blk;\r\nfor (i = 0x0A; i < 0x10; i++)\r\ndata[i] = 0xFF;\r\nfor (i = 0; i < MS_MAX_RETRY_COUNT; i++) {\r\nretval = ms_write_bytes(chip, WRITE_REG, 6 + MS_EXTRA_SIZE,\r\nNO_WAIT_INT, data, 16);\r\nif (retval == STATUS_SUCCESS)\r\nbreak;\r\n}\r\nif (i == MS_MAX_RETRY_COUNT) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nfor (i = 0; i < MS_MAX_RETRY_COUNT; i++) {\r\nretval = ms_send_cmd(chip, BLOCK_WRITE, WAIT_INT);\r\nif (retval == STATUS_SUCCESS)\r\nbreak;\r\n}\r\nif (i == MS_MAX_RETRY_COUNT) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_read_bytes(chip, GET_INT, 1, NO_WAIT_INT, &val, 1);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nptr = buf;\r\nfor (page_addr = start_page; page_addr < end_page; page_addr++) {\r\nms_set_err_code(chip, MS_NO_ERROR);\r\nif (detect_card_cd(chip, MS_CARD) != STATUS_SUCCESS) {\r\nms_set_err_code(chip, MS_NO_CARD);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (val & INT_REG_CMDNK) {\r\nms_set_err_code(chip, MS_CMD_NK);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (val & INT_REG_ERR) {\r\nms_set_err_code(chip, MS_FLASH_WRITE_ERROR);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (!(val & INT_REG_BREQ)) {\r\nms_set_err_code(chip, MS_BREQ_ERROR);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nudelay(30);\r\nrtsx_init_cmd(chip);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, MS_TPC,\r\n0xFF, WRITE_PAGE_DATA);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, MS_TRANS_CFG,\r\n0xFF, WAIT_INT);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_DATA_SOURCE,\r\n0x01, RING_BUFFER);\r\ntrans_dma_enable(DMA_TO_DEVICE, chip, 512, DMA_512);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, MS_TRANSFER, 0xFF,\r\nMS_TRANSFER_START | MS_TM_NORMAL_WRITE);\r\nrtsx_add_cmd(chip, CHECK_REG_CMD, MS_TRANSFER,\r\nMS_TRANSFER_END, MS_TRANSFER_END);\r\nrtsx_send_cmd_no_wait(chip);\r\nretval = rtsx_transfer_data_partial(chip, MS_CARD, ptr,\r\n512, scsi_sg_count(chip->srb),\r\nindex, offset, DMA_TO_DEVICE,\r\nchip->ms_timeout);\r\nif (retval < 0) {\r\nms_set_err_code(chip, MS_TO_ERROR);\r\nrtsx_clear_ms_error(chip);\r\nif (retval == -ETIMEDOUT) {\r\nrtsx_trace(chip);\r\nreturn STATUS_TIMEDOUT;\r\n}\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_read_bytes(chip, GET_INT, 1, NO_WAIT_INT, &val, 1);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif ((end_page - start_page) == 1) {\r\nif (!(val & INT_REG_CED)) {\r\nms_set_err_code(chip, MS_FLASH_WRITE_ERROR);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n} else {\r\nif (page_addr == (end_page - 1)) {\r\nif (!(val & INT_REG_CED)) {\r\nretval = ms_send_cmd(chip, BLOCK_END,\r\nWAIT_INT);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nretval = ms_read_bytes(chip, GET_INT, 1,\r\nNO_WAIT_INT, &val, 1);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nif ((page_addr == (end_page - 1)) ||\r\n(page_addr == ms_card->page_off)) {\r\nif (!(val & INT_REG_CED)) {\r\nms_set_err_code(chip,\r\nMS_FLASH_WRITE_ERROR);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\n}\r\nif (scsi_sg_count(chip->srb) == 0)\r\nptr += 512;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int ms_finish_write(struct rtsx_chip *chip, u16 old_blk, u16 new_blk,\r\nu16 log_blk, u8 page_off)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval, seg_no;\r\nretval = ms_copy_page(chip, old_blk, new_blk, log_blk,\r\npage_off, ms_card->page_off + 1);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nseg_no = old_blk >> 9;\r\nif (MS_TST_BAD_BLOCK_FLG(ms_card)) {\r\nMS_CLR_BAD_BLOCK_FLG(ms_card);\r\nms_set_bad_block(chip, old_blk);\r\n} else {\r\nretval = ms_erase_block(chip, old_blk);\r\nif (retval == STATUS_SUCCESS)\r\nms_set_unused_block(chip, old_blk);\r\n}\r\nms_set_l2p_tbl(chip, seg_no, log_blk - ms_start_idx[seg_no], new_blk);\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int ms_prepare_write(struct rtsx_chip *chip, u16 old_blk, u16 new_blk,\r\nu16 log_blk, u8 start_page)\r\n{\r\nint retval;\r\nif (start_page) {\r\nretval = ms_copy_page(chip, old_blk, new_blk, log_blk,\r\n0, start_page);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nint ms_delay_write(struct rtsx_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nstruct ms_delay_write_tag *delay_write = &(ms_card->delay_write);\r\nint retval;\r\nif (delay_write->delay_write_flag) {\r\nretval = ms_set_init_para(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\ndelay_write->delay_write_flag = 0;\r\nretval = ms_finish_write(chip,\r\ndelay_write->old_phyblock,\r\ndelay_write->new_phyblock,\r\ndelay_write->logblock,\r\ndelay_write->pageoff);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic inline void ms_rw_fail(struct scsi_cmnd *srb, struct rtsx_chip *chip)\r\n{\r\nif (srb->sc_data_direction == DMA_FROM_DEVICE)\r\nset_sense_type(chip, SCSI_LUN(srb),\r\nSENSE_TYPE_MEDIA_UNRECOVER_READ_ERR);\r\nelse\r\nset_sense_type(chip, SCSI_LUN(srb), SENSE_TYPE_MEDIA_WRITE_ERR);\r\n}\r\nstatic int ms_rw_multi_sector(struct scsi_cmnd *srb, struct rtsx_chip *chip,\r\nu32 start_sector, u16 sector_cnt)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nunsigned int lun = SCSI_LUN(srb);\r\nint retval, seg_no;\r\nunsigned int index = 0, offset = 0;\r\nu16 old_blk = 0, new_blk = 0, log_blk, total_sec_cnt = sector_cnt;\r\nu8 start_page, end_page = 0, page_cnt;\r\nu8 *ptr;\r\n#ifdef MS_DELAY_WRITE\r\nstruct ms_delay_write_tag *delay_write = &(ms_card->delay_write);\r\n#endif\r\nms_set_err_code(chip, MS_NO_ERROR);\r\nms_card->cleanup_counter = 0;\r\nptr = (u8 *)scsi_sglist(srb);\r\nretval = ms_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nms_rw_fail(srb, chip);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nlog_blk = (u16)(start_sector >> ms_card->block_shift);\r\nstart_page = (u8)(start_sector & ms_card->page_off);\r\nfor (seg_no = 0; seg_no < ARRAY_SIZE(ms_start_idx) - 1; seg_no++) {\r\nif (log_blk < ms_start_idx[seg_no+1])\r\nbreak;\r\n}\r\nif (ms_card->segment[seg_no].build_flag == 0) {\r\nretval = ms_build_l2p_tbl(chip, seg_no);\r\nif (retval != STATUS_SUCCESS) {\r\nchip->card_fail |= MS_CARD;\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nif (srb->sc_data_direction == DMA_TO_DEVICE) {\r\n#ifdef MS_DELAY_WRITE\r\nif (delay_write->delay_write_flag &&\r\n(delay_write->logblock == log_blk) &&\r\n(start_page > delay_write->pageoff)) {\r\ndelay_write->delay_write_flag = 0;\r\nretval = ms_copy_page(chip,\r\ndelay_write->old_phyblock,\r\ndelay_write->new_phyblock, log_blk,\r\ndelay_write->pageoff, start_page);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun,\r\nSENSE_TYPE_MEDIA_WRITE_ERR);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nold_blk = delay_write->old_phyblock;\r\nnew_blk = delay_write->new_phyblock;\r\n} else if (delay_write->delay_write_flag &&\r\n(delay_write->logblock == log_blk) &&\r\n(start_page == delay_write->pageoff)) {\r\ndelay_write->delay_write_flag = 0;\r\nold_blk = delay_write->old_phyblock;\r\nnew_blk = delay_write->new_phyblock;\r\n} else {\r\nretval = ms_delay_write(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun,\r\nSENSE_TYPE_MEDIA_WRITE_ERR);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n#endif\r\nold_blk = ms_get_l2p_tbl(chip, seg_no,\r\nlog_blk - ms_start_idx[seg_no]);\r\nnew_blk = ms_get_unused_block(chip, seg_no);\r\nif ((old_blk == 0xFFFF) || (new_blk == 0xFFFF)) {\r\nset_sense_type(chip, lun,\r\nSENSE_TYPE_MEDIA_WRITE_ERR);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_prepare_write(chip, old_blk, new_blk,\r\nlog_blk, start_page);\r\nif (retval != STATUS_SUCCESS) {\r\nif (detect_card_cd(chip, MS_CARD) != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun,\r\nSENSE_TYPE_MEDIA_NOT_PRESENT);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nset_sense_type(chip, lun,\r\nSENSE_TYPE_MEDIA_WRITE_ERR);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n#ifdef MS_DELAY_WRITE\r\n}\r\n#endif\r\n} else {\r\n#ifdef MS_DELAY_WRITE\r\nretval = ms_delay_write(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nif (detect_card_cd(chip, MS_CARD) != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun,\r\nSENSE_TYPE_MEDIA_NOT_PRESENT);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nset_sense_type(chip, lun,\r\nSENSE_TYPE_MEDIA_UNRECOVER_READ_ERR);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n#endif\r\nold_blk = ms_get_l2p_tbl(chip, seg_no,\r\nlog_blk - ms_start_idx[seg_no]);\r\nif (old_blk == 0xFFFF) {\r\nset_sense_type(chip, lun,\r\nSENSE_TYPE_MEDIA_UNRECOVER_READ_ERR);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\ndev_dbg(rtsx_dev(chip), "seg_no = %d, old_blk = 0x%x, new_blk = 0x%x\n",\r\nseg_no, old_blk, new_blk);\r\nwhile (total_sec_cnt) {\r\nif ((start_page + total_sec_cnt) > (ms_card->page_off + 1))\r\nend_page = ms_card->page_off + 1;\r\nelse\r\nend_page = start_page + (u8)total_sec_cnt;\r\npage_cnt = end_page - start_page;\r\ndev_dbg(rtsx_dev(chip), "start_page = %d, end_page = %d, page_cnt = %d\n",\r\nstart_page, end_page, page_cnt);\r\nif (srb->sc_data_direction == DMA_FROM_DEVICE) {\r\nretval = ms_read_multiple_pages(chip,\r\nold_blk, log_blk, start_page, end_page,\r\nptr, &index, &offset);\r\n} else {\r\nretval = ms_write_multiple_pages(chip, old_blk,\r\nnew_blk, log_blk, start_page, end_page,\r\nptr, &index, &offset);\r\n}\r\nif (retval != STATUS_SUCCESS) {\r\ntoggle_gpio(chip, 1);\r\nif (detect_card_cd(chip, MS_CARD) != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun,\r\nSENSE_TYPE_MEDIA_NOT_PRESENT);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nms_rw_fail(srb, chip);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (srb->sc_data_direction == DMA_TO_DEVICE) {\r\nif (end_page == (ms_card->page_off + 1)) {\r\nretval = ms_erase_block(chip, old_blk);\r\nif (retval == STATUS_SUCCESS)\r\nms_set_unused_block(chip, old_blk);\r\nms_set_l2p_tbl(chip, seg_no,\r\nlog_blk - ms_start_idx[seg_no],\r\nnew_blk);\r\n}\r\n}\r\ntotal_sec_cnt -= page_cnt;\r\nif (scsi_sg_count(srb) == 0)\r\nptr += page_cnt * 512;\r\nif (total_sec_cnt == 0)\r\nbreak;\r\nlog_blk++;\r\nfor (seg_no = 0; seg_no < ARRAY_SIZE(ms_start_idx) - 1;\r\nseg_no++) {\r\nif (log_blk < ms_start_idx[seg_no+1])\r\nbreak;\r\n}\r\nif (ms_card->segment[seg_no].build_flag == 0) {\r\nretval = ms_build_l2p_tbl(chip, seg_no);\r\nif (retval != STATUS_SUCCESS) {\r\nchip->card_fail |= MS_CARD;\r\nset_sense_type(chip, lun,\r\nSENSE_TYPE_MEDIA_NOT_PRESENT);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nold_blk = ms_get_l2p_tbl(chip, seg_no,\r\nlog_blk - ms_start_idx[seg_no]);\r\nif (old_blk == 0xFFFF) {\r\nms_rw_fail(srb, chip);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (srb->sc_data_direction == DMA_TO_DEVICE) {\r\nnew_blk = ms_get_unused_block(chip, seg_no);\r\nif (new_blk == 0xFFFF) {\r\nms_rw_fail(srb, chip);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\ndev_dbg(rtsx_dev(chip), "seg_no = %d, old_blk = 0x%x, new_blk = 0x%x\n",\r\nseg_no, old_blk, new_blk);\r\nstart_page = 0;\r\n}\r\nif (srb->sc_data_direction == DMA_TO_DEVICE) {\r\nif (end_page < (ms_card->page_off + 1)) {\r\n#ifdef MS_DELAY_WRITE\r\ndelay_write->delay_write_flag = 1;\r\ndelay_write->old_phyblock = old_blk;\r\ndelay_write->new_phyblock = new_blk;\r\ndelay_write->logblock = log_blk;\r\ndelay_write->pageoff = end_page;\r\n#else\r\nretval = ms_finish_write(chip, old_blk, new_blk,\r\nlog_blk, end_page);\r\nif (retval != STATUS_SUCCESS) {\r\nif (detect_card_cd(chip, MS_CARD) != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun,\r\nSENSE_TYPE_MEDIA_NOT_PRESENT);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nms_rw_fail(srb, chip);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n#endif\r\n}\r\n}\r\nscsi_set_resid(srb, 0);\r\nreturn STATUS_SUCCESS;\r\n}\r\nint ms_rw(struct scsi_cmnd *srb, struct rtsx_chip *chip,\r\nu32 start_sector, u16 sector_cnt)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval;\r\nif (CHK_MSPRO(ms_card))\r\nretval = mspro_rw_multi_sector(srb, chip, start_sector,\r\nsector_cnt);\r\nelse\r\nretval = ms_rw_multi_sector(srb, chip, start_sector,\r\nsector_cnt);\r\nreturn retval;\r\n}\r\nvoid ms_free_l2p_tbl(struct rtsx_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint i = 0;\r\nif (ms_card->segment != NULL) {\r\nfor (i = 0; i < ms_card->segment_cnt; i++) {\r\nif (ms_card->segment[i].l2p_table != NULL) {\r\nvfree(ms_card->segment[i].l2p_table);\r\nms_card->segment[i].l2p_table = NULL;\r\n}\r\nif (ms_card->segment[i].free_table != NULL) {\r\nvfree(ms_card->segment[i].free_table);\r\nms_card->segment[i].free_table = NULL;\r\n}\r\n}\r\nvfree(ms_card->segment);\r\nms_card->segment = NULL;\r\n}\r\n}\r\nstatic int ms_poll_int(struct rtsx_chip *chip)\r\n{\r\nint retval;\r\nu8 val;\r\nrtsx_init_cmd(chip);\r\nrtsx_add_cmd(chip, CHECK_REG_CMD, MS_TRANS_CFG, MS_INT_CED, MS_INT_CED);\r\nretval = rtsx_send_cmd(chip, MS_CARD, 5000);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nval = *rtsx_get_cmd_data(chip);\r\nif (val & MS_INT_ERR) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int check_ms_err(struct rtsx_chip *chip)\r\n{\r\nint retval;\r\nu8 val;\r\nretval = rtsx_read_register(chip, MS_TRANSFER, &val);\r\nif (retval != STATUS_SUCCESS)\r\nreturn 1;\r\nif (val & MS_TRANSFER_ERR)\r\nreturn 1;\r\nretval = rtsx_read_register(chip, MS_TRANS_CFG, &val);\r\nif (retval != STATUS_SUCCESS)\r\nreturn 1;\r\nif (val & (MS_INT_ERR | MS_INT_CMDNK))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int check_ms_err(struct rtsx_chip *chip)\r\n{\r\nint retval;\r\nu8 val;\r\nretval = rtsx_read_register(chip, MS_TRANSFER, &val);\r\nif (retval != STATUS_SUCCESS)\r\nreturn 1;\r\nif (val & MS_TRANSFER_ERR)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int mg_send_ex_cmd(struct rtsx_chip *chip, u8 cmd, u8 entry_num)\r\n{\r\nint retval, i;\r\nu8 data[8];\r\ndata[0] = cmd;\r\ndata[1] = 0;\r\ndata[2] = 0;\r\ndata[3] = 0;\r\ndata[4] = 0;\r\ndata[5] = 0;\r\ndata[6] = entry_num;\r\ndata[7] = 0;\r\nfor (i = 0; i < MS_MAX_RETRY_COUNT; i++) {\r\nretval = ms_write_bytes(chip, PRO_EX_SET_CMD, 7, WAIT_INT,\r\ndata, 8);\r\nif (retval == STATUS_SUCCESS)\r\nbreak;\r\n}\r\nif (i == MS_MAX_RETRY_COUNT) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (check_ms_err(chip)) {\r\nrtsx_clear_ms_error(chip);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int mg_set_tpc_para_sub(struct rtsx_chip *chip, int type,\r\nu8 mg_entry_num)\r\n{\r\nint retval;\r\nu8 buf[6];\r\nif (type == 0)\r\nretval = ms_set_rw_reg_addr(chip, 0, 0, Pro_TPCParm, 1);\r\nelse\r\nretval = ms_set_rw_reg_addr(chip, 0, 0, Pro_DataCount1, 6);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nbuf[0] = 0;\r\nbuf[1] = 0;\r\nif (type == 1) {\r\nbuf[2] = 0;\r\nbuf[3] = 0;\r\nbuf[4] = 0;\r\nbuf[5] = mg_entry_num;\r\n}\r\nretval = ms_write_bytes(chip, PRO_WRITE_REG, (type == 0) ? 1 : 6,\r\nNO_WAIT_INT, buf, 6);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nint mg_set_leaf_id(struct scsi_cmnd *srb, struct rtsx_chip *chip)\r\n{\r\nint retval;\r\nint i;\r\nunsigned int lun = SCSI_LUN(srb);\r\nu8 buf1[32], buf2[12];\r\nif (scsi_bufflen(srb) < 12) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nms_cleanup_work(chip);\r\nretval = ms_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = mg_send_ex_cmd(chip, MG_SET_LID, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_KEY_FAIL_NOT_ESTAB);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nmemset(buf1, 0, 32);\r\nrtsx_stor_get_xfer_buf(buf2, min_t(int, 12, scsi_bufflen(srb)), srb);\r\nfor (i = 0; i < 8; i++)\r\nbuf1[8+i] = buf2[4+i];\r\nretval = ms_write_bytes(chip, PRO_WRITE_SHORT_DATA, 32, WAIT_INT,\r\nbuf1, 32);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_KEY_FAIL_NOT_ESTAB);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (check_ms_err(chip)) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_KEY_FAIL_NOT_ESTAB);\r\nrtsx_clear_ms_error(chip);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nint mg_get_local_EKB(struct scsi_cmnd *srb, struct rtsx_chip *chip)\r\n{\r\nint retval = STATUS_FAIL;\r\nint bufflen;\r\nunsigned int lun = SCSI_LUN(srb);\r\nu8 *buf = NULL;\r\nms_cleanup_work(chip);\r\nretval = ms_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nbuf = kmalloc(1540, GFP_KERNEL);\r\nif (!buf) {\r\nrtsx_trace(chip);\r\nreturn STATUS_ERROR;\r\n}\r\nbuf[0] = 0x04;\r\nbuf[1] = 0x1A;\r\nbuf[2] = 0x00;\r\nbuf[3] = 0x00;\r\nretval = mg_send_ex_cmd(chip, MG_GET_LEKB, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN);\r\nrtsx_trace(chip);\r\ngoto GetEKBFinish;\r\n}\r\nretval = ms_transfer_data(chip, MS_TM_AUTO_READ, PRO_READ_LONG_DATA,\r\n3, WAIT_INT, 0, 0, buf + 4, 1536);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN);\r\nrtsx_clear_ms_error(chip);\r\nrtsx_trace(chip);\r\ngoto GetEKBFinish;\r\n}\r\nif (check_ms_err(chip)) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN);\r\nrtsx_clear_ms_error(chip);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nbufflen = min_t(int, 1052, scsi_bufflen(srb));\r\nrtsx_stor_set_xfer_buf(buf, bufflen, srb);\r\nGetEKBFinish:\r\nkfree(buf);\r\nreturn retval;\r\n}\r\nint mg_chg(struct scsi_cmnd *srb, struct rtsx_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval;\r\nint bufflen;\r\nint i;\r\nunsigned int lun = SCSI_LUN(srb);\r\nu8 buf[32];\r\nms_cleanup_work(chip);\r\nretval = ms_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = mg_send_ex_cmd(chip, MG_GET_ID, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_read_bytes(chip, PRO_READ_SHORT_DATA, 32, WAIT_INT,\r\nbuf, 32);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (check_ms_err(chip)) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM);\r\nrtsx_clear_ms_error(chip);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nmemcpy(ms_card->magic_gate_id, buf, 16);\r\n#ifdef READ_BYTES_WAIT_INT\r\nretval = ms_poll_int(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n#endif\r\nretval = mg_send_ex_cmd(chip, MG_SET_RD, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nbufflen = min_t(int, 12, scsi_bufflen(srb));\r\nrtsx_stor_get_xfer_buf(buf, bufflen, srb);\r\nfor (i = 0; i < 8; i++)\r\nbuf[i] = buf[4+i];\r\nfor (i = 0; i < 24; i++)\r\nbuf[8+i] = 0;\r\nretval = ms_write_bytes(chip, PRO_WRITE_SHORT_DATA,\r\n32, WAIT_INT, buf, 32);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (check_ms_err(chip)) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM);\r\nrtsx_clear_ms_error(chip);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nms_card->mg_auth = 0;\r\nreturn STATUS_SUCCESS;\r\n}\r\nint mg_get_rsp_chg(struct scsi_cmnd *srb, struct rtsx_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval;\r\nint bufflen;\r\nunsigned int lun = SCSI_LUN(srb);\r\nu8 buf1[32], buf2[36];\r\nms_cleanup_work(chip);\r\nretval = ms_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = mg_send_ex_cmd(chip, MG_MAKE_RMS, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = ms_read_bytes(chip, PRO_READ_SHORT_DATA, 32, WAIT_INT,\r\nbuf1, 32);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (check_ms_err(chip)) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN);\r\nrtsx_clear_ms_error(chip);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nbuf2[0] = 0x00;\r\nbuf2[1] = 0x22;\r\nbuf2[2] = 0x00;\r\nbuf2[3] = 0x00;\r\nmemcpy(buf2 + 4, ms_card->magic_gate_id, 16);\r\nmemcpy(buf2 + 20, buf1, 16);\r\nbufflen = min_t(int, 36, scsi_bufflen(srb));\r\nrtsx_stor_set_xfer_buf(buf2, bufflen, srb);\r\n#ifdef READ_BYTES_WAIT_INT\r\nretval = ms_poll_int(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n#endif\r\nreturn STATUS_SUCCESS;\r\n}\r\nint mg_rsp(struct scsi_cmnd *srb, struct rtsx_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval;\r\nint i;\r\nint bufflen;\r\nunsigned int lun = SCSI_LUN(srb);\r\nu8 buf[32];\r\nms_cleanup_work(chip);\r\nretval = ms_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nretval = mg_send_ex_cmd(chip, MG_MAKE_KSE, 0);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nbufflen = min_t(int, 12, scsi_bufflen(srb));\r\nrtsx_stor_get_xfer_buf(buf, bufflen, srb);\r\nfor (i = 0; i < 8; i++)\r\nbuf[i] = buf[4+i];\r\nfor (i = 0; i < 24; i++)\r\nbuf[8+i] = 0;\r\nretval = ms_write_bytes(chip, PRO_WRITE_SHORT_DATA, 32, WAIT_INT,\r\nbuf, 32);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (check_ms_err(chip)) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN);\r\nrtsx_clear_ms_error(chip);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nms_card->mg_auth = 1;\r\nreturn STATUS_SUCCESS;\r\n}\r\nint mg_get_ICV(struct scsi_cmnd *srb, struct rtsx_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval;\r\nint bufflen;\r\nunsigned int lun = SCSI_LUN(srb);\r\nu8 *buf = NULL;\r\nms_cleanup_work(chip);\r\nretval = ms_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nbuf = kmalloc(1028, GFP_KERNEL);\r\nif (!buf) {\r\nrtsx_trace(chip);\r\nreturn STATUS_ERROR;\r\n}\r\nbuf[0] = 0x04;\r\nbuf[1] = 0x02;\r\nbuf[2] = 0x00;\r\nbuf[3] = 0x00;\r\nretval = mg_send_ex_cmd(chip, MG_GET_IBD, ms_card->mg_entry_num);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR);\r\nrtsx_trace(chip);\r\ngoto GetICVFinish;\r\n}\r\nretval = ms_transfer_data(chip, MS_TM_AUTO_READ, PRO_READ_LONG_DATA,\r\n2, WAIT_INT, 0, 0, buf + 4, 1024);\r\nif (retval != STATUS_SUCCESS) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR);\r\nrtsx_clear_ms_error(chip);\r\nrtsx_trace(chip);\r\ngoto GetICVFinish;\r\n}\r\nif (check_ms_err(chip)) {\r\nset_sense_type(chip, lun, SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR);\r\nrtsx_clear_ms_error(chip);\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nbufflen = min_t(int, 1028, scsi_bufflen(srb));\r\nrtsx_stor_set_xfer_buf(buf, bufflen, srb);\r\nGetICVFinish:\r\nkfree(buf);\r\nreturn retval;\r\n}\r\nint mg_set_ICV(struct scsi_cmnd *srb, struct rtsx_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval;\r\nint bufflen;\r\n#ifdef MG_SET_ICV_SLOW\r\nint i;\r\n#endif\r\nunsigned int lun = SCSI_LUN(srb);\r\nu8 *buf = NULL;\r\nms_cleanup_work(chip);\r\nretval = ms_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nbuf = kmalloc(1028, GFP_KERNEL);\r\nif (!buf) {\r\nrtsx_trace(chip);\r\nreturn STATUS_ERROR;\r\n}\r\nbufflen = min_t(int, 1028, scsi_bufflen(srb));\r\nrtsx_stor_get_xfer_buf(buf, bufflen, srb);\r\nretval = mg_send_ex_cmd(chip, MG_SET_IBD, ms_card->mg_entry_num);\r\nif (retval != STATUS_SUCCESS) {\r\nif (ms_card->mg_auth == 0) {\r\nif ((buf[5] & 0xC0) != 0)\r\nset_sense_type(chip, lun,\r\nSENSE_TYPE_MG_KEY_FAIL_NOT_ESTAB);\r\nelse\r\nset_sense_type(chip, lun,\r\nSENSE_TYPE_MG_WRITE_ERR);\r\n} else {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_WRITE_ERR);\r\n}\r\nrtsx_trace(chip);\r\ngoto SetICVFinish;\r\n}\r\n#ifdef MG_SET_ICV_SLOW\r\nfor (i = 0; i < 2; i++) {\r\nudelay(50);\r\nrtsx_init_cmd(chip);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, MS_TPC,\r\n0xFF, PRO_WRITE_LONG_DATA);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, MS_TRANS_CFG, 0xFF, WAIT_INT);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, CARD_DATA_SOURCE,\r\n0x01, RING_BUFFER);\r\ntrans_dma_enable(DMA_TO_DEVICE, chip, 512, DMA_512);\r\nrtsx_add_cmd(chip, WRITE_REG_CMD, MS_TRANSFER, 0xFF,\r\nMS_TRANSFER_START | MS_TM_NORMAL_WRITE);\r\nrtsx_add_cmd(chip, CHECK_REG_CMD, MS_TRANSFER,\r\nMS_TRANSFER_END, MS_TRANSFER_END);\r\nrtsx_send_cmd_no_wait(chip);\r\nretval = rtsx_transfer_data(chip, MS_CARD, buf + 4 + i*512,\r\n512, 0, DMA_TO_DEVICE, 3000);\r\nif ((retval < 0) || check_ms_err(chip)) {\r\nrtsx_clear_ms_error(chip);\r\nif (ms_card->mg_auth == 0) {\r\nif ((buf[5] & 0xC0) != 0)\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_KEY_FAIL_NOT_ESTAB);\r\nelse\r\nset_sense_type(chip, lun,\r\nSENSE_TYPE_MG_WRITE_ERR);\r\n} else {\r\nset_sense_type(chip, lun,\r\nSENSE_TYPE_MG_WRITE_ERR);\r\n}\r\nretval = STATUS_FAIL;\r\nrtsx_trace(chip);\r\ngoto SetICVFinish;\r\n}\r\n}\r\n#else\r\nretval = ms_transfer_data(chip, MS_TM_AUTO_WRITE, PRO_WRITE_LONG_DATA,\r\n2, WAIT_INT, 0, 0, buf + 4, 1024);\r\nif ((retval != STATUS_SUCCESS) || check_ms_err(chip)) {\r\nrtsx_clear_ms_error(chip);\r\nif (ms_card->mg_auth == 0) {\r\nif ((buf[5] & 0xC0) != 0)\r\nset_sense_type(chip, lun,\r\nSENSE_TYPE_MG_KEY_FAIL_NOT_ESTAB);\r\nelse\r\nset_sense_type(chip, lun,\r\nSENSE_TYPE_MG_WRITE_ERR);\r\n} else {\r\nset_sense_type(chip, lun, SENSE_TYPE_MG_WRITE_ERR);\r\n}\r\nrtsx_trace(chip);\r\ngoto SetICVFinish;\r\n}\r\n#endif\r\nSetICVFinish:\r\nkfree(buf);\r\nreturn retval;\r\n}\r\nvoid ms_cleanup_work(struct rtsx_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nif (CHK_MSPRO(ms_card)) {\r\nif (ms_card->seq_mode) {\r\ndev_dbg(rtsx_dev(chip), "MS Pro: stop transmission\n");\r\nmspro_stop_seq_mode(chip);\r\nms_card->cleanup_counter = 0;\r\n}\r\nif (CHK_MSHG(ms_card)) {\r\nrtsx_write_register(chip, MS_CFG,\r\nMS_2K_SECTOR_MODE, 0x00);\r\n}\r\n}\r\n#ifdef MS_DELAY_WRITE\r\nelse if ((!CHK_MSPRO(ms_card)) && ms_card->delay_write.delay_write_flag) {\r\ndev_dbg(rtsx_dev(chip), "MS: delay write\n");\r\nms_delay_write(chip);\r\nms_card->cleanup_counter = 0;\r\n}\r\n#endif\r\n}\r\nint ms_power_off_card3v3(struct rtsx_chip *chip)\r\n{\r\nint retval;\r\nretval = disable_card_clock(chip, MS_CARD);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nif (chip->asic_code) {\r\nretval = ms_pull_ctl_disable(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n} else {\r\nretval = rtsx_write_register(chip, FPGA_PULL_CTL,\r\nFPGA_MS_PULL_CTL_BIT | 0x20,\r\nFPGA_MS_PULL_CTL_BIT);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\n}\r\nretval = rtsx_write_register(chip, CARD_OE, MS_OUTPUT_EN, 0);\r\nif (retval) {\r\nrtsx_trace(chip);\r\nreturn retval;\r\n}\r\nif (!chip->ft2_fast_mode) {\r\nretval = card_power_off(chip, MS_CARD);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nint release_ms_card(struct rtsx_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint retval;\r\n#ifdef MS_DELAY_WRITE\r\nms_card->delay_write.delay_write_flag = 0;\r\n#endif\r\nms_card->pro_under_formatting = 0;\r\nchip->card_ready &= ~MS_CARD;\r\nchip->card_fail &= ~MS_CARD;\r\nchip->card_wp &= ~MS_CARD;\r\nms_free_l2p_tbl(chip);\r\nmemset(ms_card->raw_sys_info, 0, 96);\r\n#ifdef SUPPORT_PCGL_1P18\r\nmemset(ms_card->raw_model_name, 0, 48);\r\n#endif\r\nretval = ms_power_off_card3v3(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrtsx_trace(chip);\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}

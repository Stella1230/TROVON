static int fakelb_hw_ed(struct ieee802154_hw *hw, u8 *level)\r\n{\r\nBUG_ON(!level);\r\n*level = 0xbe;\r\nreturn 0;\r\n}\r\nstatic int fakelb_hw_channel(struct ieee802154_hw *hw, u8 page, u8 channel)\r\n{\r\nstruct fakelb_phy *phy = hw->priv;\r\nwrite_lock_bh(&fakelb_ifup_phys_lock);\r\nphy->page = page;\r\nphy->channel = channel;\r\nwrite_unlock_bh(&fakelb_ifup_phys_lock);\r\nreturn 0;\r\n}\r\nstatic int fakelb_hw_xmit(struct ieee802154_hw *hw, struct sk_buff *skb)\r\n{\r\nstruct fakelb_phy *current_phy = hw->priv, *phy;\r\nread_lock_bh(&fakelb_ifup_phys_lock);\r\nWARN_ON(current_phy->suspended);\r\nlist_for_each_entry(phy, &fakelb_ifup_phys, list_ifup) {\r\nif (current_phy == phy)\r\ncontinue;\r\nif (current_phy->page == phy->page &&\r\ncurrent_phy->channel == phy->channel) {\r\nstruct sk_buff *newskb = pskb_copy(skb, GFP_ATOMIC);\r\nif (newskb)\r\nieee802154_rx_irqsafe(phy->hw, newskb, 0xcc);\r\n}\r\n}\r\nread_unlock_bh(&fakelb_ifup_phys_lock);\r\nieee802154_xmit_complete(hw, skb, false);\r\nreturn 0;\r\n}\r\nstatic int fakelb_hw_start(struct ieee802154_hw *hw)\r\n{\r\nstruct fakelb_phy *phy = hw->priv;\r\nwrite_lock_bh(&fakelb_ifup_phys_lock);\r\nphy->suspended = false;\r\nlist_add(&phy->list_ifup, &fakelb_ifup_phys);\r\nwrite_unlock_bh(&fakelb_ifup_phys_lock);\r\nreturn 0;\r\n}\r\nstatic void fakelb_hw_stop(struct ieee802154_hw *hw)\r\n{\r\nstruct fakelb_phy *phy = hw->priv;\r\nwrite_lock_bh(&fakelb_ifup_phys_lock);\r\nphy->suspended = true;\r\nlist_del(&phy->list_ifup);\r\nwrite_unlock_bh(&fakelb_ifup_phys_lock);\r\n}\r\nstatic int fakelb_add_one(struct device *dev)\r\n{\r\nstruct ieee802154_hw *hw;\r\nstruct fakelb_phy *phy;\r\nint err;\r\nhw = ieee802154_alloc_hw(sizeof(*phy), &fakelb_ops);\r\nif (!hw)\r\nreturn -ENOMEM;\r\nphy = hw->priv;\r\nphy->hw = hw;\r\nhw->phy->supported.channels[0] |= 1;\r\nhw->phy->supported.channels[0] |= 0x7fe;\r\nhw->phy->supported.channels[0] |= 0x7FFF800;\r\nhw->phy->supported.channels[1] |= 1;\r\nhw->phy->supported.channels[1] |= 0x7fe;\r\nhw->phy->supported.channels[2] |= 1;\r\nhw->phy->supported.channels[2] |= 0x7fe;\r\nhw->phy->supported.channels[3] |= 0x3fff;\r\nhw->phy->supported.channels[4] |= 1;\r\nhw->phy->supported.channels[4] |= 0x1e;\r\nhw->phy->supported.channels[4] |= 0xffe0;\r\nhw->phy->supported.channels[5] |= 0xf;\r\nhw->phy->supported.channels[5] |= 0xf0;\r\nhw->phy->supported.channels[6] |= 0x3ff;\r\nhw->phy->supported.channels[6] |= 0x3ffc00;\r\nieee802154_random_extended_addr(&hw->phy->perm_extended_addr);\r\nhw->phy->current_channel = 13;\r\nphy->channel = hw->phy->current_channel;\r\nhw->parent = dev;\r\nerr = ieee802154_register_hw(hw);\r\nif (err)\r\ngoto err_reg;\r\nspin_lock(&fakelb_phys_lock);\r\nlist_add_tail(&phy->list, &fakelb_phys);\r\nspin_unlock(&fakelb_phys_lock);\r\nreturn 0;\r\nerr_reg:\r\nieee802154_free_hw(phy->hw);\r\nreturn err;\r\n}\r\nstatic void fakelb_del(struct fakelb_phy *phy)\r\n{\r\nlist_del(&phy->list);\r\nieee802154_unregister_hw(phy->hw);\r\nieee802154_free_hw(phy->hw);\r\n}\r\nstatic int fakelb_probe(struct platform_device *pdev)\r\n{\r\nstruct fakelb_phy *phy, *tmp;\r\nint err, i;\r\nfor (i = 0; i < numlbs; i++) {\r\nerr = fakelb_add_one(&pdev->dev);\r\nif (err < 0)\r\ngoto err_slave;\r\n}\r\ndev_info(&pdev->dev, "added ieee802154 hardware\n");\r\nreturn 0;\r\nerr_slave:\r\nspin_lock(&fakelb_phys_lock);\r\nlist_for_each_entry_safe(phy, tmp, &fakelb_phys, list)\r\nfakelb_del(phy);\r\nspin_unlock(&fakelb_phys_lock);\r\nreturn err;\r\n}\r\nstatic int fakelb_remove(struct platform_device *pdev)\r\n{\r\nstruct fakelb_phy *phy, *tmp;\r\nspin_lock(&fakelb_phys_lock);\r\nlist_for_each_entry_safe(phy, tmp, &fakelb_phys, list)\r\nfakelb_del(phy);\r\nspin_unlock(&fakelb_phys_lock);\r\nreturn 0;\r\n}\r\nstatic __init int fakelb_init_module(void)\r\n{\r\nieee802154fake_dev = platform_device_register_simple(\r\n"ieee802154fakelb", -1, NULL, 0);\r\nreturn platform_driver_register(&ieee802154fake_driver);\r\n}\r\nstatic __exit void fake_remove_module(void)\r\n{\r\nplatform_driver_unregister(&ieee802154fake_driver);\r\nplatform_device_unregister(ieee802154fake_dev);\r\n}

static notrace u32 __vdso_read_begin(const struct vdso_data *vdata)\r\n{\r\nu32 seq;\r\nrepeat:\r\nseq = ACCESS_ONCE(vdata->seq_count);\r\nif (seq & 1) {\r\ncpu_relax();\r\ngoto repeat;\r\n}\r\nreturn seq;\r\n}\r\nstatic notrace u32 vdso_read_begin(const struct vdso_data *vdata)\r\n{\r\nu32 seq;\r\nseq = __vdso_read_begin(vdata);\r\nsmp_rmb();\r\nreturn seq;\r\n}\r\nstatic notrace int vdso_read_retry(const struct vdso_data *vdata, u32 start)\r\n{\r\nsmp_rmb();\r\nreturn vdata->seq_count != start;\r\n}\r\nstatic notrace long clock_gettime_fallback(clockid_t _clkid,\r\nstruct timespec *_ts)\r\n{\r\nregister struct timespec *ts asm("r1") = _ts;\r\nregister clockid_t clkid asm("r0") = _clkid;\r\nregister long ret asm ("r0");\r\nregister long nr asm("r7") = __NR_clock_gettime;\r\nasm volatile(\r\n" swi #0\n"\r\n: "=r" (ret)\r\n: "r" (clkid), "r" (ts), "r" (nr)\r\n: "memory");\r\nreturn ret;\r\n}\r\nstatic notrace int do_realtime_coarse(struct timespec *ts,\r\nstruct vdso_data *vdata)\r\n{\r\nu32 seq;\r\ndo {\r\nseq = vdso_read_begin(vdata);\r\nts->tv_sec = vdata->xtime_coarse_sec;\r\nts->tv_nsec = vdata->xtime_coarse_nsec;\r\n} while (vdso_read_retry(vdata, seq));\r\nreturn 0;\r\n}\r\nstatic notrace int do_monotonic_coarse(struct timespec *ts,\r\nstruct vdso_data *vdata)\r\n{\r\nstruct timespec tomono;\r\nu32 seq;\r\ndo {\r\nseq = vdso_read_begin(vdata);\r\nts->tv_sec = vdata->xtime_coarse_sec;\r\nts->tv_nsec = vdata->xtime_coarse_nsec;\r\ntomono.tv_sec = vdata->wtm_clock_sec;\r\ntomono.tv_nsec = vdata->wtm_clock_nsec;\r\n} while (vdso_read_retry(vdata, seq));\r\nts->tv_sec += tomono.tv_sec;\r\ntimespec_add_ns(ts, tomono.tv_nsec);\r\nreturn 0;\r\n}\r\nstatic notrace u64 get_ns(struct vdso_data *vdata)\r\n{\r\nu64 cycle_delta;\r\nu64 cycle_now;\r\nu64 nsec;\r\ncycle_now = arch_counter_get_cntvct();\r\ncycle_delta = (cycle_now - vdata->cs_cycle_last) & vdata->cs_mask;\r\nnsec = (cycle_delta * vdata->cs_mult) + vdata->xtime_clock_snsec;\r\nnsec >>= vdata->cs_shift;\r\nreturn nsec;\r\n}\r\nstatic notrace int do_realtime(struct timespec *ts, struct vdso_data *vdata)\r\n{\r\nu64 nsecs;\r\nu32 seq;\r\ndo {\r\nseq = vdso_read_begin(vdata);\r\nif (!vdata->tk_is_cntvct)\r\nreturn -1;\r\nts->tv_sec = vdata->xtime_clock_sec;\r\nnsecs = get_ns(vdata);\r\n} while (vdso_read_retry(vdata, seq));\r\nts->tv_nsec = 0;\r\ntimespec_add_ns(ts, nsecs);\r\nreturn 0;\r\n}\r\nstatic notrace int do_monotonic(struct timespec *ts, struct vdso_data *vdata)\r\n{\r\nstruct timespec tomono;\r\nu64 nsecs;\r\nu32 seq;\r\ndo {\r\nseq = vdso_read_begin(vdata);\r\nif (!vdata->tk_is_cntvct)\r\nreturn -1;\r\nts->tv_sec = vdata->xtime_clock_sec;\r\nnsecs = get_ns(vdata);\r\ntomono.tv_sec = vdata->wtm_clock_sec;\r\ntomono.tv_nsec = vdata->wtm_clock_nsec;\r\n} while (vdso_read_retry(vdata, seq));\r\nts->tv_sec += tomono.tv_sec;\r\nts->tv_nsec = 0;\r\ntimespec_add_ns(ts, nsecs + tomono.tv_nsec);\r\nreturn 0;\r\n}\r\nstatic notrace int do_realtime(struct timespec *ts, struct vdso_data *vdata)\r\n{\r\nreturn -1;\r\n}\r\nstatic notrace int do_monotonic(struct timespec *ts, struct vdso_data *vdata)\r\n{\r\nreturn -1;\r\n}\r\nnotrace int __vdso_clock_gettime(clockid_t clkid, struct timespec *ts)\r\n{\r\nstruct vdso_data *vdata;\r\nint ret = -1;\r\nvdata = __get_datapage();\r\nswitch (clkid) {\r\ncase CLOCK_REALTIME_COARSE:\r\nret = do_realtime_coarse(ts, vdata);\r\nbreak;\r\ncase CLOCK_MONOTONIC_COARSE:\r\nret = do_monotonic_coarse(ts, vdata);\r\nbreak;\r\ncase CLOCK_REALTIME:\r\nret = do_realtime(ts, vdata);\r\nbreak;\r\ncase CLOCK_MONOTONIC:\r\nret = do_monotonic(ts, vdata);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (ret)\r\nret = clock_gettime_fallback(clkid, ts);\r\nreturn ret;\r\n}\r\nstatic notrace long gettimeofday_fallback(struct timeval *_tv,\r\nstruct timezone *_tz)\r\n{\r\nregister struct timezone *tz asm("r1") = _tz;\r\nregister struct timeval *tv asm("r0") = _tv;\r\nregister long ret asm ("r0");\r\nregister long nr asm("r7") = __NR_gettimeofday;\r\nasm volatile(\r\n" swi #0\n"\r\n: "=r" (ret)\r\n: "r" (tv), "r" (tz), "r" (nr)\r\n: "memory");\r\nreturn ret;\r\n}\r\nnotrace int __vdso_gettimeofday(struct timeval *tv, struct timezone *tz)\r\n{\r\nstruct timespec ts;\r\nstruct vdso_data *vdata;\r\nint ret;\r\nvdata = __get_datapage();\r\nret = do_realtime(&ts, vdata);\r\nif (ret)\r\nreturn gettimeofday_fallback(tv, tz);\r\nif (tv) {\r\ntv->tv_sec = ts.tv_sec;\r\ntv->tv_usec = ts.tv_nsec / 1000;\r\n}\r\nif (tz) {\r\ntz->tz_minuteswest = vdata->tz_minuteswest;\r\ntz->tz_dsttime = vdata->tz_dsttime;\r\n}\r\nreturn ret;\r\n}\r\nvoid __aeabi_unwind_cpp_pr0(void)\r\n{\r\n}\r\nvoid __aeabi_unwind_cpp_pr1(void)\r\n{\r\n}\r\nvoid __aeabi_unwind_cpp_pr2(void)\r\n{\r\n}

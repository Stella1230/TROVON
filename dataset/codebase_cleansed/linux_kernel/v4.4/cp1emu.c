static int microMIPS32_to_MIPS32(union mips_instruction *insn_ptr)\r\n{\r\nunion mips_instruction insn = *insn_ptr;\r\nunion mips_instruction mips32_insn = insn;\r\nint func, fmt, op;\r\nswitch (insn.mm_i_format.opcode) {\r\ncase mm_ldc132_op:\r\nmips32_insn.mm_i_format.opcode = ldc1_op;\r\nmips32_insn.mm_i_format.rt = insn.mm_i_format.rs;\r\nmips32_insn.mm_i_format.rs = insn.mm_i_format.rt;\r\nbreak;\r\ncase mm_lwc132_op:\r\nmips32_insn.mm_i_format.opcode = lwc1_op;\r\nmips32_insn.mm_i_format.rt = insn.mm_i_format.rs;\r\nmips32_insn.mm_i_format.rs = insn.mm_i_format.rt;\r\nbreak;\r\ncase mm_sdc132_op:\r\nmips32_insn.mm_i_format.opcode = sdc1_op;\r\nmips32_insn.mm_i_format.rt = insn.mm_i_format.rs;\r\nmips32_insn.mm_i_format.rs = insn.mm_i_format.rt;\r\nbreak;\r\ncase mm_swc132_op:\r\nmips32_insn.mm_i_format.opcode = swc1_op;\r\nmips32_insn.mm_i_format.rt = insn.mm_i_format.rs;\r\nmips32_insn.mm_i_format.rs = insn.mm_i_format.rt;\r\nbreak;\r\ncase mm_pool32i_op:\r\nif ((insn.mm_i_format.rt == mm_bc1f_op) ||\r\n(insn.mm_i_format.rt == mm_bc1t_op)) {\r\nmips32_insn.fb_format.opcode = cop1_op;\r\nmips32_insn.fb_format.bc = bc_op;\r\nmips32_insn.fb_format.flag =\r\n(insn.mm_i_format.rt == mm_bc1t_op) ? 1 : 0;\r\n} else\r\nreturn SIGILL;\r\nbreak;\r\ncase mm_pool32f_op:\r\nswitch (insn.mm_fp0_format.func) {\r\ncase mm_32f_01_op:\r\ncase mm_32f_11_op:\r\ncase mm_32f_02_op:\r\ncase mm_32f_12_op:\r\ncase mm_32f_41_op:\r\ncase mm_32f_51_op:\r\ncase mm_32f_42_op:\r\ncase mm_32f_52_op:\r\nop = insn.mm_fp0_format.func;\r\nif (op == mm_32f_01_op)\r\nfunc = madd_s_op;\r\nelse if (op == mm_32f_11_op)\r\nfunc = madd_d_op;\r\nelse if (op == mm_32f_02_op)\r\nfunc = nmadd_s_op;\r\nelse if (op == mm_32f_12_op)\r\nfunc = nmadd_d_op;\r\nelse if (op == mm_32f_41_op)\r\nfunc = msub_s_op;\r\nelse if (op == mm_32f_51_op)\r\nfunc = msub_d_op;\r\nelse if (op == mm_32f_42_op)\r\nfunc = nmsub_s_op;\r\nelse\r\nfunc = nmsub_d_op;\r\nmips32_insn.fp6_format.opcode = cop1x_op;\r\nmips32_insn.fp6_format.fr = insn.mm_fp6_format.fr;\r\nmips32_insn.fp6_format.ft = insn.mm_fp6_format.ft;\r\nmips32_insn.fp6_format.fs = insn.mm_fp6_format.fs;\r\nmips32_insn.fp6_format.fd = insn.mm_fp6_format.fd;\r\nmips32_insn.fp6_format.func = func;\r\nbreak;\r\ncase mm_32f_10_op:\r\nfunc = -1;\r\nop = insn.mm_fp5_format.op & 0x7;\r\nif (op == mm_ldxc1_op)\r\nfunc = ldxc1_op;\r\nelse if (op == mm_sdxc1_op)\r\nfunc = sdxc1_op;\r\nelse if (op == mm_lwxc1_op)\r\nfunc = lwxc1_op;\r\nelse if (op == mm_swxc1_op)\r\nfunc = swxc1_op;\r\nif (func != -1) {\r\nmips32_insn.r_format.opcode = cop1x_op;\r\nmips32_insn.r_format.rs =\r\ninsn.mm_fp5_format.base;\r\nmips32_insn.r_format.rt =\r\ninsn.mm_fp5_format.index;\r\nmips32_insn.r_format.rd = 0;\r\nmips32_insn.r_format.re = insn.mm_fp5_format.fd;\r\nmips32_insn.r_format.func = func;\r\n} else\r\nreturn SIGILL;\r\nbreak;\r\ncase mm_32f_40_op:\r\nop = -1;\r\nif (insn.mm_fp2_format.op == mm_fmovt_op)\r\nop = 1;\r\nelse if (insn.mm_fp2_format.op == mm_fmovf_op)\r\nop = 0;\r\nif (op != -1) {\r\nmips32_insn.fp0_format.opcode = cop1_op;\r\nmips32_insn.fp0_format.fmt =\r\nsdps_format[insn.mm_fp2_format.fmt];\r\nmips32_insn.fp0_format.ft =\r\n(insn.mm_fp2_format.cc<<2) + op;\r\nmips32_insn.fp0_format.fs =\r\ninsn.mm_fp2_format.fs;\r\nmips32_insn.fp0_format.fd =\r\ninsn.mm_fp2_format.fd;\r\nmips32_insn.fp0_format.func = fmovc_op;\r\n} else\r\nreturn SIGILL;\r\nbreak;\r\ncase mm_32f_60_op:\r\nfunc = -1;\r\nif (insn.mm_fp0_format.op == mm_fadd_op)\r\nfunc = fadd_op;\r\nelse if (insn.mm_fp0_format.op == mm_fsub_op)\r\nfunc = fsub_op;\r\nelse if (insn.mm_fp0_format.op == mm_fmul_op)\r\nfunc = fmul_op;\r\nelse if (insn.mm_fp0_format.op == mm_fdiv_op)\r\nfunc = fdiv_op;\r\nif (func != -1) {\r\nmips32_insn.fp0_format.opcode = cop1_op;\r\nmips32_insn.fp0_format.fmt =\r\nsdps_format[insn.mm_fp0_format.fmt];\r\nmips32_insn.fp0_format.ft =\r\ninsn.mm_fp0_format.ft;\r\nmips32_insn.fp0_format.fs =\r\ninsn.mm_fp0_format.fs;\r\nmips32_insn.fp0_format.fd =\r\ninsn.mm_fp0_format.fd;\r\nmips32_insn.fp0_format.func = func;\r\n} else\r\nreturn SIGILL;\r\nbreak;\r\ncase mm_32f_70_op:\r\nfunc = -1;\r\nif (insn.mm_fp0_format.op == mm_fmovn_op)\r\nfunc = fmovn_op;\r\nelse if (insn.mm_fp0_format.op == mm_fmovz_op)\r\nfunc = fmovz_op;\r\nif (func != -1) {\r\nmips32_insn.fp0_format.opcode = cop1_op;\r\nmips32_insn.fp0_format.fmt =\r\nsdps_format[insn.mm_fp0_format.fmt];\r\nmips32_insn.fp0_format.ft =\r\ninsn.mm_fp0_format.ft;\r\nmips32_insn.fp0_format.fs =\r\ninsn.mm_fp0_format.fs;\r\nmips32_insn.fp0_format.fd =\r\ninsn.mm_fp0_format.fd;\r\nmips32_insn.fp0_format.func = func;\r\n} else\r\nreturn SIGILL;\r\nbreak;\r\ncase mm_32f_73_op:\r\nswitch (insn.mm_fp1_format.op) {\r\ncase mm_movf0_op:\r\ncase mm_movf1_op:\r\ncase mm_movt0_op:\r\ncase mm_movt1_op:\r\nif ((insn.mm_fp1_format.op & 0x7f) ==\r\nmm_movf0_op)\r\nop = 0;\r\nelse\r\nop = 1;\r\nmips32_insn.r_format.opcode = spec_op;\r\nmips32_insn.r_format.rs = insn.mm_fp4_format.fs;\r\nmips32_insn.r_format.rt =\r\n(insn.mm_fp4_format.cc << 2) + op;\r\nmips32_insn.r_format.rd = insn.mm_fp4_format.rt;\r\nmips32_insn.r_format.re = 0;\r\nmips32_insn.r_format.func = movc_op;\r\nbreak;\r\ncase mm_fcvtd0_op:\r\ncase mm_fcvtd1_op:\r\ncase mm_fcvts0_op:\r\ncase mm_fcvts1_op:\r\nif ((insn.mm_fp1_format.op & 0x7f) ==\r\nmm_fcvtd0_op) {\r\nfunc = fcvtd_op;\r\nfmt = swl_format[insn.mm_fp3_format.fmt];\r\n} else {\r\nfunc = fcvts_op;\r\nfmt = dwl_format[insn.mm_fp3_format.fmt];\r\n}\r\nmips32_insn.fp0_format.opcode = cop1_op;\r\nmips32_insn.fp0_format.fmt = fmt;\r\nmips32_insn.fp0_format.ft = 0;\r\nmips32_insn.fp0_format.fs =\r\ninsn.mm_fp3_format.fs;\r\nmips32_insn.fp0_format.fd =\r\ninsn.mm_fp3_format.rt;\r\nmips32_insn.fp0_format.func = func;\r\nbreak;\r\ncase mm_fmov0_op:\r\ncase mm_fmov1_op:\r\ncase mm_fabs0_op:\r\ncase mm_fabs1_op:\r\ncase mm_fneg0_op:\r\ncase mm_fneg1_op:\r\nif ((insn.mm_fp1_format.op & 0x7f) ==\r\nmm_fmov0_op)\r\nfunc = fmov_op;\r\nelse if ((insn.mm_fp1_format.op & 0x7f) ==\r\nmm_fabs0_op)\r\nfunc = fabs_op;\r\nelse\r\nfunc = fneg_op;\r\nmips32_insn.fp0_format.opcode = cop1_op;\r\nmips32_insn.fp0_format.fmt =\r\nsdps_format[insn.mm_fp3_format.fmt];\r\nmips32_insn.fp0_format.ft = 0;\r\nmips32_insn.fp0_format.fs =\r\ninsn.mm_fp3_format.fs;\r\nmips32_insn.fp0_format.fd =\r\ninsn.mm_fp3_format.rt;\r\nmips32_insn.fp0_format.func = func;\r\nbreak;\r\ncase mm_ffloorl_op:\r\ncase mm_ffloorw_op:\r\ncase mm_fceill_op:\r\ncase mm_fceilw_op:\r\ncase mm_ftruncl_op:\r\ncase mm_ftruncw_op:\r\ncase mm_froundl_op:\r\ncase mm_froundw_op:\r\ncase mm_fcvtl_op:\r\ncase mm_fcvtw_op:\r\nif (insn.mm_fp1_format.op == mm_ffloorl_op)\r\nfunc = ffloorl_op;\r\nelse if (insn.mm_fp1_format.op == mm_ffloorw_op)\r\nfunc = ffloor_op;\r\nelse if (insn.mm_fp1_format.op == mm_fceill_op)\r\nfunc = fceill_op;\r\nelse if (insn.mm_fp1_format.op == mm_fceilw_op)\r\nfunc = fceil_op;\r\nelse if (insn.mm_fp1_format.op == mm_ftruncl_op)\r\nfunc = ftruncl_op;\r\nelse if (insn.mm_fp1_format.op == mm_ftruncw_op)\r\nfunc = ftrunc_op;\r\nelse if (insn.mm_fp1_format.op == mm_froundl_op)\r\nfunc = froundl_op;\r\nelse if (insn.mm_fp1_format.op == mm_froundw_op)\r\nfunc = fround_op;\r\nelse if (insn.mm_fp1_format.op == mm_fcvtl_op)\r\nfunc = fcvtl_op;\r\nelse\r\nfunc = fcvtw_op;\r\nmips32_insn.fp0_format.opcode = cop1_op;\r\nmips32_insn.fp0_format.fmt =\r\nsd_format[insn.mm_fp1_format.fmt];\r\nmips32_insn.fp0_format.ft = 0;\r\nmips32_insn.fp0_format.fs =\r\ninsn.mm_fp1_format.fs;\r\nmips32_insn.fp0_format.fd =\r\ninsn.mm_fp1_format.rt;\r\nmips32_insn.fp0_format.func = func;\r\nbreak;\r\ncase mm_frsqrt_op:\r\ncase mm_fsqrt_op:\r\ncase mm_frecip_op:\r\nif (insn.mm_fp1_format.op == mm_frsqrt_op)\r\nfunc = frsqrt_op;\r\nelse if (insn.mm_fp1_format.op == mm_fsqrt_op)\r\nfunc = fsqrt_op;\r\nelse\r\nfunc = frecip_op;\r\nmips32_insn.fp0_format.opcode = cop1_op;\r\nmips32_insn.fp0_format.fmt =\r\nsdps_format[insn.mm_fp1_format.fmt];\r\nmips32_insn.fp0_format.ft = 0;\r\nmips32_insn.fp0_format.fs =\r\ninsn.mm_fp1_format.fs;\r\nmips32_insn.fp0_format.fd =\r\ninsn.mm_fp1_format.rt;\r\nmips32_insn.fp0_format.func = func;\r\nbreak;\r\ncase mm_mfc1_op:\r\ncase mm_mtc1_op:\r\ncase mm_cfc1_op:\r\ncase mm_ctc1_op:\r\ncase mm_mfhc1_op:\r\ncase mm_mthc1_op:\r\nif (insn.mm_fp1_format.op == mm_mfc1_op)\r\nop = mfc_op;\r\nelse if (insn.mm_fp1_format.op == mm_mtc1_op)\r\nop = mtc_op;\r\nelse if (insn.mm_fp1_format.op == mm_cfc1_op)\r\nop = cfc_op;\r\nelse if (insn.mm_fp1_format.op == mm_ctc1_op)\r\nop = ctc_op;\r\nelse if (insn.mm_fp1_format.op == mm_mfhc1_op)\r\nop = mfhc_op;\r\nelse\r\nop = mthc_op;\r\nmips32_insn.fp1_format.opcode = cop1_op;\r\nmips32_insn.fp1_format.op = op;\r\nmips32_insn.fp1_format.rt =\r\ninsn.mm_fp1_format.rt;\r\nmips32_insn.fp1_format.fs =\r\ninsn.mm_fp1_format.fs;\r\nmips32_insn.fp1_format.fd = 0;\r\nmips32_insn.fp1_format.func = 0;\r\nbreak;\r\ndefault:\r\nreturn SIGILL;\r\n}\r\nbreak;\r\ncase mm_32f_74_op:\r\nmips32_insn.fp0_format.opcode = cop1_op;\r\nmips32_insn.fp0_format.fmt =\r\nsdps_format[insn.mm_fp4_format.fmt];\r\nmips32_insn.fp0_format.ft = insn.mm_fp4_format.rt;\r\nmips32_insn.fp0_format.fs = insn.mm_fp4_format.fs;\r\nmips32_insn.fp0_format.fd = insn.mm_fp4_format.cc << 2;\r\nmips32_insn.fp0_format.func =\r\ninsn.mm_fp4_format.cond | MM_MIPS32_COND_FC;\r\nbreak;\r\ndefault:\r\nreturn SIGILL;\r\n}\r\nbreak;\r\ndefault:\r\nreturn SIGILL;\r\n}\r\n*insn_ptr = mips32_insn;\r\nreturn 0;\r\n}\r\nstatic int isBranchInstr(struct pt_regs *regs, struct mm_decoded_insn dec_insn,\r\nunsigned long *contpc)\r\n{\r\nunion mips_instruction insn = (union mips_instruction)dec_insn.insn;\r\nunsigned int fcr31;\r\nunsigned int bit = 0;\r\nswitch (insn.i_format.opcode) {\r\ncase spec_op:\r\nswitch (insn.r_format.func) {\r\ncase jalr_op:\r\nregs->regs[insn.r_format.rd] =\r\nregs->cp0_epc + dec_insn.pc_inc +\r\ndec_insn.next_pc_inc;\r\ncase jr_op:\r\nif (NO_R6EMU && insn.r_format.func == jr_op)\r\nbreak;\r\n*contpc = regs->regs[insn.r_format.rs];\r\nreturn 1;\r\n}\r\nbreak;\r\ncase bcond_op:\r\nswitch (insn.i_format.rt) {\r\ncase bltzal_op:\r\ncase bltzall_op:\r\nif (NO_R6EMU && (insn.i_format.rs ||\r\ninsn.i_format.rt == bltzall_op))\r\nbreak;\r\nregs->regs[31] = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\ndec_insn.next_pc_inc;\r\ncase bltzl_op:\r\nif (NO_R6EMU)\r\nbreak;\r\ncase bltz_op:\r\nif ((long)regs->regs[insn.i_format.rs] < 0)\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\n(insn.i_format.simmediate << 2);\r\nelse\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\ndec_insn.next_pc_inc;\r\nreturn 1;\r\ncase bgezal_op:\r\ncase bgezall_op:\r\nif (NO_R6EMU && (insn.i_format.rs ||\r\ninsn.i_format.rt == bgezall_op))\r\nbreak;\r\nregs->regs[31] = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\ndec_insn.next_pc_inc;\r\ncase bgezl_op:\r\nif (NO_R6EMU)\r\nbreak;\r\ncase bgez_op:\r\nif ((long)regs->regs[insn.i_format.rs] >= 0)\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\n(insn.i_format.simmediate << 2);\r\nelse\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\ndec_insn.next_pc_inc;\r\nreturn 1;\r\n}\r\nbreak;\r\ncase jalx_op:\r\nset_isa16_mode(bit);\r\ncase jal_op:\r\nregs->regs[31] = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\ndec_insn.next_pc_inc;\r\ncase j_op:\r\n*contpc = regs->cp0_epc + dec_insn.pc_inc;\r\n*contpc >>= 28;\r\n*contpc <<= 28;\r\n*contpc |= (insn.j_format.target << 2);\r\n*contpc ^= bit;\r\nreturn 1;\r\ncase beql_op:\r\nif (NO_R6EMU)\r\nbreak;\r\ncase beq_op:\r\nif (regs->regs[insn.i_format.rs] ==\r\nregs->regs[insn.i_format.rt])\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\n(insn.i_format.simmediate << 2);\r\nelse\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\ndec_insn.next_pc_inc;\r\nreturn 1;\r\ncase bnel_op:\r\nif (NO_R6EMU)\r\nbreak;\r\ncase bne_op:\r\nif (regs->regs[insn.i_format.rs] !=\r\nregs->regs[insn.i_format.rt])\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\n(insn.i_format.simmediate << 2);\r\nelse\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\ndec_insn.next_pc_inc;\r\nreturn 1;\r\ncase blezl_op:\r\nif (!insn.i_format.rt && NO_R6EMU)\r\nbreak;\r\ncase blez_op:\r\nif (cpu_has_mips_r6 && insn.i_format.rt) {\r\nif ((insn.i_format.opcode == blez_op) &&\r\n((!insn.i_format.rs && insn.i_format.rt) ||\r\n(insn.i_format.rs == insn.i_format.rt)))\r\nregs->regs[31] = regs->cp0_epc +\r\ndec_insn.pc_inc;\r\n*contpc = regs->cp0_epc + dec_insn.pc_inc +\r\ndec_insn.next_pc_inc;\r\nreturn 1;\r\n}\r\nif ((long)regs->regs[insn.i_format.rs] <= 0)\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\n(insn.i_format.simmediate << 2);\r\nelse\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\ndec_insn.next_pc_inc;\r\nreturn 1;\r\ncase bgtzl_op:\r\nif (!insn.i_format.rt && NO_R6EMU)\r\nbreak;\r\ncase bgtz_op:\r\nif (cpu_has_mips_r6 && insn.i_format.rt) {\r\nif ((insn.i_format.opcode == blez_op) &&\r\n((!insn.i_format.rs && insn.i_format.rt) ||\r\n(insn.i_format.rs == insn.i_format.rt)))\r\nregs->regs[31] = regs->cp0_epc +\r\ndec_insn.pc_inc;\r\n*contpc = regs->cp0_epc + dec_insn.pc_inc +\r\ndec_insn.next_pc_inc;\r\nreturn 1;\r\n}\r\nif ((long)regs->regs[insn.i_format.rs] > 0)\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\n(insn.i_format.simmediate << 2);\r\nelse\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\ndec_insn.next_pc_inc;\r\nreturn 1;\r\ncase cbcond0_op:\r\ncase cbcond1_op:\r\nif (!cpu_has_mips_r6)\r\nbreak;\r\nif (insn.i_format.rt && !insn.i_format.rs)\r\nregs->regs[31] = regs->cp0_epc + 4;\r\n*contpc = regs->cp0_epc + dec_insn.pc_inc +\r\ndec_insn.next_pc_inc;\r\nreturn 1;\r\n#ifdef CONFIG_CPU_CAVIUM_OCTEON\r\ncase lwc2_op:\r\nif ((regs->regs[insn.i_format.rs] & (1ull<<insn.i_format.rt)) == 0)\r\n*contpc = regs->cp0_epc + 4 + (insn.i_format.simmediate << 2);\r\nelse\r\n*contpc = regs->cp0_epc + 8;\r\nreturn 1;\r\ncase ldc2_op:\r\nif ((regs->regs[insn.i_format.rs] & (1ull<<(insn.i_format.rt + 32))) == 0)\r\n*contpc = regs->cp0_epc + 4 + (insn.i_format.simmediate << 2);\r\nelse\r\n*contpc = regs->cp0_epc + 8;\r\nreturn 1;\r\ncase swc2_op:\r\nif (regs->regs[insn.i_format.rs] & (1ull<<insn.i_format.rt))\r\n*contpc = regs->cp0_epc + 4 + (insn.i_format.simmediate << 2);\r\nelse\r\n*contpc = regs->cp0_epc + 8;\r\nreturn 1;\r\ncase sdc2_op:\r\nif (regs->regs[insn.i_format.rs] & (1ull<<(insn.i_format.rt + 32)))\r\n*contpc = regs->cp0_epc + 4 + (insn.i_format.simmediate << 2);\r\nelse\r\n*contpc = regs->cp0_epc + 8;\r\nreturn 1;\r\n#else\r\ncase bc6_op:\r\nif (!cpu_has_mips_r6)\r\nbreak;\r\n*contpc = regs->cp0_epc + dec_insn.pc_inc +\r\ndec_insn.next_pc_inc;\r\nreturn 1;\r\ncase balc6_op:\r\nif (!cpu_has_mips_r6)\r\nbreak;\r\nregs->regs[31] = regs->cp0_epc + 4;\r\n*contpc = regs->cp0_epc + dec_insn.pc_inc +\r\ndec_insn.next_pc_inc;\r\nreturn 1;\r\ncase beqzcjic_op:\r\nif (!cpu_has_mips_r6)\r\nbreak;\r\n*contpc = regs->cp0_epc + dec_insn.pc_inc +\r\ndec_insn.next_pc_inc;\r\nreturn 1;\r\ncase bnezcjialc_op:\r\nif (!cpu_has_mips_r6)\r\nbreak;\r\nif (!insn.i_format.rs)\r\nregs->regs[31] = regs->cp0_epc + 4;\r\n*contpc = regs->cp0_epc + dec_insn.pc_inc +\r\ndec_insn.next_pc_inc;\r\nreturn 1;\r\n#endif\r\ncase cop0_op:\r\ncase cop1_op:\r\nif (cpu_has_mips_r6 &&\r\n((insn.i_format.rs == bc1eqz_op) ||\r\n(insn.i_format.rs == bc1nez_op))) {\r\nbit = 0;\r\nswitch (insn.i_format.rs) {\r\ncase bc1eqz_op:\r\nif (get_fpr32(&current->thread.fpu.fpr[insn.i_format.rt], 0) & 0x1)\r\nbit = 1;\r\nbreak;\r\ncase bc1nez_op:\r\nif (!(get_fpr32(&current->thread.fpu.fpr[insn.i_format.rt], 0) & 0x1))\r\nbit = 1;\r\nbreak;\r\n}\r\nif (bit)\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\n(insn.i_format.simmediate << 2);\r\nelse\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\ndec_insn.next_pc_inc;\r\nreturn 1;\r\n}\r\ncase cop2_op:\r\ncase cop1x_op:\r\nif (insn.i_format.rs == bc_op) {\r\npreempt_disable();\r\nif (is_fpu_owner())\r\nfcr31 = read_32bit_cp1_register(CP1_STATUS);\r\nelse\r\nfcr31 = current->thread.fpu.fcr31;\r\npreempt_enable();\r\nbit = (insn.i_format.rt >> 2);\r\nbit += (bit != 0);\r\nbit += 23;\r\nswitch (insn.i_format.rt & 3) {\r\ncase 0:\r\ncase 2:\r\nif (~fcr31 & (1 << bit))\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\n(insn.i_format.simmediate << 2);\r\nelse\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\ndec_insn.next_pc_inc;\r\nreturn 1;\r\ncase 1:\r\ncase 3:\r\nif (fcr31 & (1 << bit))\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\n(insn.i_format.simmediate << 2);\r\nelse\r\n*contpc = regs->cp0_epc +\r\ndec_insn.pc_inc +\r\ndec_insn.next_pc_inc;\r\nreturn 1;\r\n}\r\n}\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic inline int cop1_64bit(struct pt_regs *xcp)\r\n{\r\nif (config_enabled(CONFIG_64BIT) && !config_enabled(CONFIG_MIPS32_O32))\r\nreturn 1;\r\nelse if (config_enabled(CONFIG_32BIT) &&\r\n!config_enabled(CONFIG_MIPS_O32_FP64_SUPPORT))\r\nreturn 0;\r\nreturn !test_thread_flag(TIF_32BIT_FPREGS);\r\n}\r\nstatic inline bool hybrid_fprs(void)\r\n{\r\nreturn test_thread_flag(TIF_HYBRID_FPREGS);\r\n}\r\nstatic inline void cop1_cfc(struct pt_regs *xcp, struct mips_fpu_struct *ctx,\r\nmips_instruction ir)\r\n{\r\nu32 fcr31 = ctx->fcr31;\r\nu32 value = 0;\r\nswitch (MIPSInst_RD(ir)) {\r\ncase FPCREG_CSR:\r\nvalue = fcr31;\r\npr_debug("%p gpr[%d]<-csr=%08x\n",\r\n(void *)xcp->cp0_epc, MIPSInst_RT(ir), value);\r\nbreak;\r\ncase FPCREG_FENR:\r\nif (!cpu_has_mips_r)\r\nbreak;\r\nvalue = (fcr31 >> (FPU_CSR_FS_S - MIPS_FENR_FS_S)) &\r\nMIPS_FENR_FS;\r\nvalue |= fcr31 & (FPU_CSR_ALL_E | FPU_CSR_RM);\r\npr_debug("%p gpr[%d]<-enr=%08x\n",\r\n(void *)xcp->cp0_epc, MIPSInst_RT(ir), value);\r\nbreak;\r\ncase FPCREG_FEXR:\r\nif (!cpu_has_mips_r)\r\nbreak;\r\nvalue = fcr31 & (FPU_CSR_ALL_X | FPU_CSR_ALL_S);\r\npr_debug("%p gpr[%d]<-exr=%08x\n",\r\n(void *)xcp->cp0_epc, MIPSInst_RT(ir), value);\r\nbreak;\r\ncase FPCREG_FCCR:\r\nif (!cpu_has_mips_r)\r\nbreak;\r\nvalue = (fcr31 >> (FPU_CSR_COND_S - MIPS_FCCR_COND0_S)) &\r\nMIPS_FCCR_COND0;\r\nvalue |= (fcr31 >> (FPU_CSR_COND1_S - MIPS_FCCR_COND1_S)) &\r\n(MIPS_FCCR_CONDX & ~MIPS_FCCR_COND0);\r\npr_debug("%p gpr[%d]<-ccr=%08x\n",\r\n(void *)xcp->cp0_epc, MIPSInst_RT(ir), value);\r\nbreak;\r\ncase FPCREG_RID:\r\nvalue = boot_cpu_data.fpu_id;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (MIPSInst_RT(ir))\r\nxcp->regs[MIPSInst_RT(ir)] = value;\r\n}\r\nstatic inline void cop1_ctc(struct pt_regs *xcp, struct mips_fpu_struct *ctx,\r\nmips_instruction ir)\r\n{\r\nu32 fcr31 = ctx->fcr31;\r\nu32 value;\r\nu32 mask;\r\nif (MIPSInst_RT(ir) == 0)\r\nvalue = 0;\r\nelse\r\nvalue = xcp->regs[MIPSInst_RT(ir)];\r\nswitch (MIPSInst_RD(ir)) {\r\ncase FPCREG_CSR:\r\npr_debug("%p gpr[%d]->csr=%08x\n",\r\n(void *)xcp->cp0_epc, MIPSInst_RT(ir), value);\r\nmask = boot_cpu_data.fpu_msk31;\r\nfcr31 = (value & ~mask) | (fcr31 & mask);\r\nbreak;\r\ncase FPCREG_FENR:\r\nif (!cpu_has_mips_r)\r\nbreak;\r\npr_debug("%p gpr[%d]->enr=%08x\n",\r\n(void *)xcp->cp0_epc, MIPSInst_RT(ir), value);\r\nfcr31 &= ~(FPU_CSR_FS | FPU_CSR_ALL_E | FPU_CSR_RM);\r\nfcr31 |= (value << (FPU_CSR_FS_S - MIPS_FENR_FS_S)) &\r\nFPU_CSR_FS;\r\nfcr31 |= value & (FPU_CSR_ALL_E | FPU_CSR_RM);\r\nbreak;\r\ncase FPCREG_FEXR:\r\nif (!cpu_has_mips_r)\r\nbreak;\r\npr_debug("%p gpr[%d]->exr=%08x\n",\r\n(void *)xcp->cp0_epc, MIPSInst_RT(ir), value);\r\nfcr31 &= ~(FPU_CSR_ALL_X | FPU_CSR_ALL_S);\r\nfcr31 |= value & (FPU_CSR_ALL_X | FPU_CSR_ALL_S);\r\nbreak;\r\ncase FPCREG_FCCR:\r\nif (!cpu_has_mips_r)\r\nbreak;\r\npr_debug("%p gpr[%d]->ccr=%08x\n",\r\n(void *)xcp->cp0_epc, MIPSInst_RT(ir), value);\r\nfcr31 &= ~(FPU_CSR_CONDX | FPU_CSR_COND);\r\nfcr31 |= (value << (FPU_CSR_COND_S - MIPS_FCCR_COND0_S)) &\r\nFPU_CSR_COND;\r\nfcr31 |= (value << (FPU_CSR_COND1_S - MIPS_FCCR_COND1_S)) &\r\nFPU_CSR_CONDX;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nctx->fcr31 = fcr31;\r\n}\r\nstatic int cop1Emulate(struct pt_regs *xcp, struct mips_fpu_struct *ctx,\r\nstruct mm_decoded_insn dec_insn, void *__user *fault_addr)\r\n{\r\nunsigned long contpc = xcp->cp0_epc + dec_insn.pc_inc;\r\nunsigned int cond, cbit;\r\nmips_instruction ir;\r\nint likely, pc_inc;\r\nu32 __user *wva;\r\nu64 __user *dva;\r\nu32 wval;\r\nu64 dval;\r\nint sig;\r\nif (!cpu_has_mmips && dec_insn.micro_mips_mode)\r\nunreachable();\r\nif (delay_slot(xcp)) {\r\nif (dec_insn.micro_mips_mode) {\r\nif (!mm_isBranchInstr(xcp, dec_insn, &contpc))\r\nclear_delay_slot(xcp);\r\n} else {\r\nif (!isBranchInstr(xcp, dec_insn, &contpc))\r\nclear_delay_slot(xcp);\r\n}\r\n}\r\nif (delay_slot(xcp)) {\r\nir = dec_insn.next_insn;\r\npc_inc = dec_insn.next_pc_inc;\r\n} else {\r\nir = dec_insn.insn;\r\npc_inc = dec_insn.pc_inc;\r\n}\r\nif (dec_insn.micro_mips_mode) {\r\nif ((pc_inc == 2) ||\r\n(microMIPS32_to_MIPS32((union mips_instruction *)&ir)\r\n== SIGILL))\r\nreturn SIGILL;\r\n}\r\nemul:\r\nperf_sw_event(PERF_COUNT_SW_EMULATION_FAULTS, 1, xcp, 0);\r\nMIPS_FPU_EMU_INC_STATS(emulated);\r\nswitch (MIPSInst_OPCODE(ir)) {\r\ncase ldc1_op:\r\ndva = (u64 __user *) (xcp->regs[MIPSInst_RS(ir)] +\r\nMIPSInst_SIMM(ir));\r\nMIPS_FPU_EMU_INC_STATS(loads);\r\nif (!access_ok(VERIFY_READ, dva, sizeof(u64))) {\r\nMIPS_FPU_EMU_INC_STATS(errors);\r\n*fault_addr = dva;\r\nreturn SIGBUS;\r\n}\r\nif (__get_user(dval, dva)) {\r\nMIPS_FPU_EMU_INC_STATS(errors);\r\n*fault_addr = dva;\r\nreturn SIGSEGV;\r\n}\r\nDITOREG(dval, MIPSInst_RT(ir));\r\nbreak;\r\ncase sdc1_op:\r\ndva = (u64 __user *) (xcp->regs[MIPSInst_RS(ir)] +\r\nMIPSInst_SIMM(ir));\r\nMIPS_FPU_EMU_INC_STATS(stores);\r\nDIFROMREG(dval, MIPSInst_RT(ir));\r\nif (!access_ok(VERIFY_WRITE, dva, sizeof(u64))) {\r\nMIPS_FPU_EMU_INC_STATS(errors);\r\n*fault_addr = dva;\r\nreturn SIGBUS;\r\n}\r\nif (__put_user(dval, dva)) {\r\nMIPS_FPU_EMU_INC_STATS(errors);\r\n*fault_addr = dva;\r\nreturn SIGSEGV;\r\n}\r\nbreak;\r\ncase lwc1_op:\r\nwva = (u32 __user *) (xcp->regs[MIPSInst_RS(ir)] +\r\nMIPSInst_SIMM(ir));\r\nMIPS_FPU_EMU_INC_STATS(loads);\r\nif (!access_ok(VERIFY_READ, wva, sizeof(u32))) {\r\nMIPS_FPU_EMU_INC_STATS(errors);\r\n*fault_addr = wva;\r\nreturn SIGBUS;\r\n}\r\nif (__get_user(wval, wva)) {\r\nMIPS_FPU_EMU_INC_STATS(errors);\r\n*fault_addr = wva;\r\nreturn SIGSEGV;\r\n}\r\nSITOREG(wval, MIPSInst_RT(ir));\r\nbreak;\r\ncase swc1_op:\r\nwva = (u32 __user *) (xcp->regs[MIPSInst_RS(ir)] +\r\nMIPSInst_SIMM(ir));\r\nMIPS_FPU_EMU_INC_STATS(stores);\r\nSIFROMREG(wval, MIPSInst_RT(ir));\r\nif (!access_ok(VERIFY_WRITE, wva, sizeof(u32))) {\r\nMIPS_FPU_EMU_INC_STATS(errors);\r\n*fault_addr = wva;\r\nreturn SIGBUS;\r\n}\r\nif (__put_user(wval, wva)) {\r\nMIPS_FPU_EMU_INC_STATS(errors);\r\n*fault_addr = wva;\r\nreturn SIGSEGV;\r\n}\r\nbreak;\r\ncase cop1_op:\r\nswitch (MIPSInst_RS(ir)) {\r\ncase dmfc_op:\r\nif (!cpu_has_mips_3_4_5 && !cpu_has_mips64)\r\nreturn SIGILL;\r\nif (MIPSInst_RT(ir) != 0) {\r\nDIFROMREG(xcp->regs[MIPSInst_RT(ir)],\r\nMIPSInst_RD(ir));\r\n}\r\nbreak;\r\ncase dmtc_op:\r\nif (!cpu_has_mips_3_4_5 && !cpu_has_mips64)\r\nreturn SIGILL;\r\nDITOREG(xcp->regs[MIPSInst_RT(ir)], MIPSInst_RD(ir));\r\nbreak;\r\ncase mfhc_op:\r\nif (!cpu_has_mips_r2_r6)\r\ngoto sigill;\r\nif (MIPSInst_RT(ir) != 0) {\r\nSIFROMHREG(xcp->regs[MIPSInst_RT(ir)],\r\nMIPSInst_RD(ir));\r\n}\r\nbreak;\r\ncase mthc_op:\r\nif (!cpu_has_mips_r2_r6)\r\ngoto sigill;\r\nSITOHREG(xcp->regs[MIPSInst_RT(ir)], MIPSInst_RD(ir));\r\nbreak;\r\ncase mfc_op:\r\nif (MIPSInst_RT(ir) != 0) {\r\nSIFROMREG(xcp->regs[MIPSInst_RT(ir)],\r\nMIPSInst_RD(ir));\r\n}\r\nbreak;\r\ncase mtc_op:\r\nSITOREG(xcp->regs[MIPSInst_RT(ir)], MIPSInst_RD(ir));\r\nbreak;\r\ncase cfc_op:\r\ncop1_cfc(xcp, ctx, ir);\r\nbreak;\r\ncase ctc_op:\r\ncop1_ctc(xcp, ctx, ir);\r\nif ((ctx->fcr31 >> 5) & ctx->fcr31 & FPU_CSR_ALL_E) {\r\nreturn SIGFPE;\r\n}\r\nbreak;\r\ncase bc1eqz_op:\r\ncase bc1nez_op:\r\nif (!cpu_has_mips_r6 || delay_slot(xcp))\r\nreturn SIGILL;\r\ncond = likely = 0;\r\nswitch (MIPSInst_RS(ir)) {\r\ncase bc1eqz_op:\r\nif (get_fpr32(&current->thread.fpu.fpr[MIPSInst_RT(ir)], 0) & 0x1)\r\ncond = 1;\r\nbreak;\r\ncase bc1nez_op:\r\nif (!(get_fpr32(&current->thread.fpu.fpr[MIPSInst_RT(ir)], 0) & 0x1))\r\ncond = 1;\r\nbreak;\r\n}\r\ngoto branch_common;\r\ncase bc_op:\r\nif (delay_slot(xcp))\r\nreturn SIGILL;\r\nif (cpu_has_mips_4_5_r)\r\ncbit = fpucondbit[MIPSInst_RT(ir) >> 2];\r\nelse\r\ncbit = FPU_CSR_COND;\r\ncond = ctx->fcr31 & cbit;\r\nlikely = 0;\r\nswitch (MIPSInst_RT(ir) & 3) {\r\ncase bcfl_op:\r\nif (cpu_has_mips_2_3_4_5_r)\r\nlikely = 1;\r\ncase bcf_op:\r\ncond = !cond;\r\nbreak;\r\ncase bctl_op:\r\nif (cpu_has_mips_2_3_4_5_r)\r\nlikely = 1;\r\ncase bct_op:\r\nbreak;\r\n}\r\nbranch_common:\r\nset_delay_slot(xcp);\r\nif (cond) {\r\nunsigned long bcpc;\r\nbcpc = xcp->cp0_epc;\r\nxcp->cp0_epc += dec_insn.pc_inc;\r\ncontpc = MIPSInst_SIMM(ir);\r\nir = dec_insn.next_insn;\r\nif (dec_insn.micro_mips_mode) {\r\ncontpc = (xcp->cp0_epc + (contpc << 1));\r\nif ((dec_insn.next_pc_inc == 2) ||\r\n(microMIPS32_to_MIPS32((union mips_instruction *)&ir) == SIGILL)) {\r\nif (dec_insn.next_pc_inc == 2)\r\nir = (ir & (~0xffff)) | MM_NOP16;\r\nsig = mips_dsemul(xcp, ir,\r\ncontpc);\r\nif (sig)\r\nxcp->cp0_epc = bcpc;\r\nreturn sig ? sig : SIGILL;\r\n}\r\n} else\r\ncontpc = (xcp->cp0_epc + (contpc << 2));\r\nswitch (MIPSInst_OPCODE(ir)) {\r\ncase lwc1_op:\r\ncase swc1_op:\r\ngoto emul;\r\ncase ldc1_op:\r\ncase sdc1_op:\r\nif (cpu_has_mips_2_3_4_5_r)\r\ngoto emul;\r\ngoto bc_sigill;\r\ncase cop1_op:\r\ngoto emul;\r\ncase cop1x_op:\r\nif (cpu_has_mips_4_5_64_r2_r6)\r\ngoto emul;\r\ngoto bc_sigill;\r\ncase spec_op:\r\nswitch (MIPSInst_FUNC(ir)) {\r\ncase movc_op:\r\nif (cpu_has_mips_4_5_r)\r\ngoto emul;\r\ngoto bc_sigill;\r\n}\r\nbreak;\r\nbc_sigill:\r\nxcp->cp0_epc = bcpc;\r\nreturn SIGILL;\r\n}\r\nsig = mips_dsemul(xcp, ir, contpc);\r\nif (sig)\r\nxcp->cp0_epc = bcpc;\r\nreturn sig ? sig : SIGILL;\r\n} else if (likely) {\r\nxcp->cp0_epc += dec_insn.pc_inc;\r\ncontpc += dec_insn.pc_inc;\r\n}\r\nbreak;\r\ndefault:\r\nif (!(MIPSInst_RS(ir) & 0x10))\r\nreturn SIGILL;\r\nif ((sig = fpu_emu(xcp, ctx, ir)))\r\nreturn sig;\r\n}\r\nbreak;\r\ncase cop1x_op:\r\nif (!cpu_has_mips_4_5_64_r2_r6)\r\nreturn SIGILL;\r\nsig = fpux_emu(xcp, ctx, ir, fault_addr);\r\nif (sig)\r\nreturn sig;\r\nbreak;\r\ncase spec_op:\r\nif (!cpu_has_mips_4_5_r)\r\nreturn SIGILL;\r\nif (MIPSInst_FUNC(ir) != movc_op)\r\nreturn SIGILL;\r\ncond = fpucondbit[MIPSInst_RT(ir) >> 2];\r\nif (((ctx->fcr31 & cond) != 0) == ((MIPSInst_RT(ir) & 1) != 0))\r\nxcp->regs[MIPSInst_RD(ir)] =\r\nxcp->regs[MIPSInst_RS(ir)];\r\nbreak;\r\ndefault:\r\nsigill:\r\nreturn SIGILL;\r\n}\r\nxcp->cp0_epc = contpc;\r\nclear_delay_slot(xcp);\r\nreturn 0;\r\n}\r\nstatic union ieee754dp fpemu_dp_recip(union ieee754dp d)\r\n{\r\nreturn ieee754dp_div(ieee754dp_one(0), d);\r\n}\r\nstatic union ieee754dp fpemu_dp_rsqrt(union ieee754dp d)\r\n{\r\nreturn ieee754dp_div(ieee754dp_one(0), ieee754dp_sqrt(d));\r\n}\r\nstatic union ieee754sp fpemu_sp_recip(union ieee754sp s)\r\n{\r\nreturn ieee754sp_div(ieee754sp_one(0), s);\r\n}\r\nstatic union ieee754sp fpemu_sp_rsqrt(union ieee754sp s)\r\n{\r\nreturn ieee754sp_div(ieee754sp_one(0), ieee754sp_sqrt(s));\r\n}\r\nstatic int fpux_emu(struct pt_regs *xcp, struct mips_fpu_struct *ctx,\r\nmips_instruction ir, void *__user *fault_addr)\r\n{\r\nunsigned rcsr = 0;\r\nMIPS_FPU_EMU_INC_STATS(cp1xops);\r\nswitch (MIPSInst_FMA_FFMT(ir)) {\r\ncase s_fmt:{\r\nunion ieee754sp(*handler) (union ieee754sp, union ieee754sp, union ieee754sp);\r\nunion ieee754sp fd, fr, fs, ft;\r\nu32 __user *va;\r\nu32 val;\r\nswitch (MIPSInst_FUNC(ir)) {\r\ncase lwxc1_op:\r\nva = (void __user *) (xcp->regs[MIPSInst_FR(ir)] +\r\nxcp->regs[MIPSInst_FT(ir)]);\r\nMIPS_FPU_EMU_INC_STATS(loads);\r\nif (!access_ok(VERIFY_READ, va, sizeof(u32))) {\r\nMIPS_FPU_EMU_INC_STATS(errors);\r\n*fault_addr = va;\r\nreturn SIGBUS;\r\n}\r\nif (__get_user(val, va)) {\r\nMIPS_FPU_EMU_INC_STATS(errors);\r\n*fault_addr = va;\r\nreturn SIGSEGV;\r\n}\r\nSITOREG(val, MIPSInst_FD(ir));\r\nbreak;\r\ncase swxc1_op:\r\nva = (void __user *) (xcp->regs[MIPSInst_FR(ir)] +\r\nxcp->regs[MIPSInst_FT(ir)]);\r\nMIPS_FPU_EMU_INC_STATS(stores);\r\nSIFROMREG(val, MIPSInst_FS(ir));\r\nif (!access_ok(VERIFY_WRITE, va, sizeof(u32))) {\r\nMIPS_FPU_EMU_INC_STATS(errors);\r\n*fault_addr = va;\r\nreturn SIGBUS;\r\n}\r\nif (put_user(val, va)) {\r\nMIPS_FPU_EMU_INC_STATS(errors);\r\n*fault_addr = va;\r\nreturn SIGSEGV;\r\n}\r\nbreak;\r\ncase madd_s_op:\r\nhandler = fpemu_sp_madd;\r\ngoto scoptop;\r\ncase msub_s_op:\r\nhandler = fpemu_sp_msub;\r\ngoto scoptop;\r\ncase nmadd_s_op:\r\nhandler = fpemu_sp_nmadd;\r\ngoto scoptop;\r\ncase nmsub_s_op:\r\nhandler = fpemu_sp_nmsub;\r\ngoto scoptop;\r\nscoptop:\r\nSPFROMREG(fr, MIPSInst_FR(ir));\r\nSPFROMREG(fs, MIPSInst_FS(ir));\r\nSPFROMREG(ft, MIPSInst_FT(ir));\r\nfd = (*handler) (fr, fs, ft);\r\nSPTOREG(fd, MIPSInst_FD(ir));\r\ncopcsr:\r\nif (ieee754_cxtest(IEEE754_INEXACT)) {\r\nMIPS_FPU_EMU_INC_STATS(ieee754_inexact);\r\nrcsr |= FPU_CSR_INE_X | FPU_CSR_INE_S;\r\n}\r\nif (ieee754_cxtest(IEEE754_UNDERFLOW)) {\r\nMIPS_FPU_EMU_INC_STATS(ieee754_underflow);\r\nrcsr |= FPU_CSR_UDF_X | FPU_CSR_UDF_S;\r\n}\r\nif (ieee754_cxtest(IEEE754_OVERFLOW)) {\r\nMIPS_FPU_EMU_INC_STATS(ieee754_overflow);\r\nrcsr |= FPU_CSR_OVF_X | FPU_CSR_OVF_S;\r\n}\r\nif (ieee754_cxtest(IEEE754_INVALID_OPERATION)) {\r\nMIPS_FPU_EMU_INC_STATS(ieee754_invalidop);\r\nrcsr |= FPU_CSR_INV_X | FPU_CSR_INV_S;\r\n}\r\nctx->fcr31 = (ctx->fcr31 & ~FPU_CSR_ALL_X) | rcsr;\r\nif ((ctx->fcr31 >> 5) & ctx->fcr31 & FPU_CSR_ALL_E) {\r\nreturn SIGFPE;\r\n}\r\nbreak;\r\ndefault:\r\nreturn SIGILL;\r\n}\r\nbreak;\r\n}\r\ncase d_fmt:{\r\nunion ieee754dp(*handler) (union ieee754dp, union ieee754dp, union ieee754dp);\r\nunion ieee754dp fd, fr, fs, ft;\r\nu64 __user *va;\r\nu64 val;\r\nswitch (MIPSInst_FUNC(ir)) {\r\ncase ldxc1_op:\r\nva = (void __user *) (xcp->regs[MIPSInst_FR(ir)] +\r\nxcp->regs[MIPSInst_FT(ir)]);\r\nMIPS_FPU_EMU_INC_STATS(loads);\r\nif (!access_ok(VERIFY_READ, va, sizeof(u64))) {\r\nMIPS_FPU_EMU_INC_STATS(errors);\r\n*fault_addr = va;\r\nreturn SIGBUS;\r\n}\r\nif (__get_user(val, va)) {\r\nMIPS_FPU_EMU_INC_STATS(errors);\r\n*fault_addr = va;\r\nreturn SIGSEGV;\r\n}\r\nDITOREG(val, MIPSInst_FD(ir));\r\nbreak;\r\ncase sdxc1_op:\r\nva = (void __user *) (xcp->regs[MIPSInst_FR(ir)] +\r\nxcp->regs[MIPSInst_FT(ir)]);\r\nMIPS_FPU_EMU_INC_STATS(stores);\r\nDIFROMREG(val, MIPSInst_FS(ir));\r\nif (!access_ok(VERIFY_WRITE, va, sizeof(u64))) {\r\nMIPS_FPU_EMU_INC_STATS(errors);\r\n*fault_addr = va;\r\nreturn SIGBUS;\r\n}\r\nif (__put_user(val, va)) {\r\nMIPS_FPU_EMU_INC_STATS(errors);\r\n*fault_addr = va;\r\nreturn SIGSEGV;\r\n}\r\nbreak;\r\ncase madd_d_op:\r\nhandler = fpemu_dp_madd;\r\ngoto dcoptop;\r\ncase msub_d_op:\r\nhandler = fpemu_dp_msub;\r\ngoto dcoptop;\r\ncase nmadd_d_op:\r\nhandler = fpemu_dp_nmadd;\r\ngoto dcoptop;\r\ncase nmsub_d_op:\r\nhandler = fpemu_dp_nmsub;\r\ngoto dcoptop;\r\ndcoptop:\r\nDPFROMREG(fr, MIPSInst_FR(ir));\r\nDPFROMREG(fs, MIPSInst_FS(ir));\r\nDPFROMREG(ft, MIPSInst_FT(ir));\r\nfd = (*handler) (fr, fs, ft);\r\nDPTOREG(fd, MIPSInst_FD(ir));\r\ngoto copcsr;\r\ndefault:\r\nreturn SIGILL;\r\n}\r\nbreak;\r\n}\r\ncase 0x3:\r\nif (MIPSInst_FUNC(ir) != pfetch_op)\r\nreturn SIGILL;\r\nbreak;\r\ndefault:\r\nreturn SIGILL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int fpu_emu(struct pt_regs *xcp, struct mips_fpu_struct *ctx,\r\nmips_instruction ir)\r\n{\r\nint rfmt;\r\nunsigned rcsr = 0;\r\nunsigned int oldrm;\r\nunsigned int cbit;\r\nunsigned cond;\r\nunion {\r\nunion ieee754dp d;\r\nunion ieee754sp s;\r\nint w;\r\ns64 l;\r\n} rv;\r\nu64 bits;\r\nMIPS_FPU_EMU_INC_STATS(cp1ops);\r\nswitch (rfmt = (MIPSInst_FFMT(ir) & 0xf)) {\r\ncase s_fmt: {\r\nunion {\r\nunion ieee754sp(*b) (union ieee754sp, union ieee754sp);\r\nunion ieee754sp(*u) (union ieee754sp);\r\n} handler;\r\nunion ieee754sp fs, ft;\r\nswitch (MIPSInst_FUNC(ir)) {\r\ncase fadd_op:\r\nhandler.b = ieee754sp_add;\r\ngoto scopbop;\r\ncase fsub_op:\r\nhandler.b = ieee754sp_sub;\r\ngoto scopbop;\r\ncase fmul_op:\r\nhandler.b = ieee754sp_mul;\r\ngoto scopbop;\r\ncase fdiv_op:\r\nhandler.b = ieee754sp_div;\r\ngoto scopbop;\r\ncase fsqrt_op:\r\nif (!cpu_has_mips_2_3_4_5_r)\r\nreturn SIGILL;\r\nhandler.u = ieee754sp_sqrt;\r\ngoto scopuop;\r\ncase frsqrt_op:\r\nif (!cpu_has_mips_4_5_64_r2_r6)\r\nreturn SIGILL;\r\nhandler.u = fpemu_sp_rsqrt;\r\ngoto scopuop;\r\ncase frecip_op:\r\nif (!cpu_has_mips_4_5_64_r2_r6)\r\nreturn SIGILL;\r\nhandler.u = fpemu_sp_recip;\r\ngoto scopuop;\r\ncase fmovc_op:\r\nif (!cpu_has_mips_4_5_r)\r\nreturn SIGILL;\r\ncond = fpucondbit[MIPSInst_FT(ir) >> 2];\r\nif (((ctx->fcr31 & cond) != 0) !=\r\n((MIPSInst_FT(ir) & 1) != 0))\r\nreturn 0;\r\nSPFROMREG(rv.s, MIPSInst_FS(ir));\r\nbreak;\r\ncase fmovz_op:\r\nif (!cpu_has_mips_4_5_r)\r\nreturn SIGILL;\r\nif (xcp->regs[MIPSInst_FT(ir)] != 0)\r\nreturn 0;\r\nSPFROMREG(rv.s, MIPSInst_FS(ir));\r\nbreak;\r\ncase fmovn_op:\r\nif (!cpu_has_mips_4_5_r)\r\nreturn SIGILL;\r\nif (xcp->regs[MIPSInst_FT(ir)] == 0)\r\nreturn 0;\r\nSPFROMREG(rv.s, MIPSInst_FS(ir));\r\nbreak;\r\ncase fseleqz_op:\r\nif (!cpu_has_mips_r6)\r\nreturn SIGILL;\r\nSPFROMREG(rv.s, MIPSInst_FT(ir));\r\nif (rv.w & 0x1)\r\nrv.w = 0;\r\nelse\r\nSPFROMREG(rv.s, MIPSInst_FS(ir));\r\nbreak;\r\ncase fselnez_op:\r\nif (!cpu_has_mips_r6)\r\nreturn SIGILL;\r\nSPFROMREG(rv.s, MIPSInst_FT(ir));\r\nif (rv.w & 0x1)\r\nSPFROMREG(rv.s, MIPSInst_FS(ir));\r\nelse\r\nrv.w = 0;\r\nbreak;\r\ncase fmaddf_op: {\r\nunion ieee754sp ft, fs, fd;\r\nif (!cpu_has_mips_r6)\r\nreturn SIGILL;\r\nSPFROMREG(ft, MIPSInst_FT(ir));\r\nSPFROMREG(fs, MIPSInst_FS(ir));\r\nSPFROMREG(fd, MIPSInst_FD(ir));\r\nrv.s = ieee754sp_maddf(fd, fs, ft);\r\nbreak;\r\n}\r\ncase fmsubf_op: {\r\nunion ieee754sp ft, fs, fd;\r\nif (!cpu_has_mips_r6)\r\nreturn SIGILL;\r\nSPFROMREG(ft, MIPSInst_FT(ir));\r\nSPFROMREG(fs, MIPSInst_FS(ir));\r\nSPFROMREG(fd, MIPSInst_FD(ir));\r\nrv.s = ieee754sp_msubf(fd, fs, ft);\r\nbreak;\r\n}\r\ncase frint_op: {\r\nunion ieee754sp fs;\r\nif (!cpu_has_mips_r6)\r\nreturn SIGILL;\r\nSPFROMREG(fs, MIPSInst_FS(ir));\r\nrv.l = ieee754sp_tlong(fs);\r\nrv.s = ieee754sp_flong(rv.l);\r\ngoto copcsr;\r\n}\r\ncase fclass_op: {\r\nunion ieee754sp fs;\r\nif (!cpu_has_mips_r6)\r\nreturn SIGILL;\r\nSPFROMREG(fs, MIPSInst_FS(ir));\r\nrv.w = ieee754sp_2008class(fs);\r\nrfmt = w_fmt;\r\nbreak;\r\n}\r\ncase fmin_op: {\r\nunion ieee754sp fs, ft;\r\nif (!cpu_has_mips_r6)\r\nreturn SIGILL;\r\nSPFROMREG(ft, MIPSInst_FT(ir));\r\nSPFROMREG(fs, MIPSInst_FS(ir));\r\nrv.s = ieee754sp_fmin(fs, ft);\r\nbreak;\r\n}\r\ncase fmina_op: {\r\nunion ieee754sp fs, ft;\r\nif (!cpu_has_mips_r6)\r\nreturn SIGILL;\r\nSPFROMREG(ft, MIPSInst_FT(ir));\r\nSPFROMREG(fs, MIPSInst_FS(ir));\r\nrv.s = ieee754sp_fmina(fs, ft);\r\nbreak;\r\n}\r\ncase fmax_op: {\r\nunion ieee754sp fs, ft;\r\nif (!cpu_has_mips_r6)\r\nreturn SIGILL;\r\nSPFROMREG(ft, MIPSInst_FT(ir));\r\nSPFROMREG(fs, MIPSInst_FS(ir));\r\nrv.s = ieee754sp_fmax(fs, ft);\r\nbreak;\r\n}\r\ncase fmaxa_op: {\r\nunion ieee754sp fs, ft;\r\nif (!cpu_has_mips_r6)\r\nreturn SIGILL;\r\nSPFROMREG(ft, MIPSInst_FT(ir));\r\nSPFROMREG(fs, MIPSInst_FS(ir));\r\nrv.s = ieee754sp_fmaxa(fs, ft);\r\nbreak;\r\n}\r\ncase fabs_op:\r\nhandler.u = ieee754sp_abs;\r\ngoto scopuop;\r\ncase fneg_op:\r\nhandler.u = ieee754sp_neg;\r\ngoto scopuop;\r\ncase fmov_op:\r\nSPFROMREG(rv.s, MIPSInst_FS(ir));\r\ngoto copcsr;\r\nscopbop:\r\nSPFROMREG(fs, MIPSInst_FS(ir));\r\nSPFROMREG(ft, MIPSInst_FT(ir));\r\nrv.s = (*handler.b) (fs, ft);\r\ngoto copcsr;\r\nscopuop:\r\nSPFROMREG(fs, MIPSInst_FS(ir));\r\nrv.s = (*handler.u) (fs);\r\ngoto copcsr;\r\ncopcsr:\r\nif (ieee754_cxtest(IEEE754_INEXACT)) {\r\nMIPS_FPU_EMU_INC_STATS(ieee754_inexact);\r\nrcsr |= FPU_CSR_INE_X | FPU_CSR_INE_S;\r\n}\r\nif (ieee754_cxtest(IEEE754_UNDERFLOW)) {\r\nMIPS_FPU_EMU_INC_STATS(ieee754_underflow);\r\nrcsr |= FPU_CSR_UDF_X | FPU_CSR_UDF_S;\r\n}\r\nif (ieee754_cxtest(IEEE754_OVERFLOW)) {\r\nMIPS_FPU_EMU_INC_STATS(ieee754_overflow);\r\nrcsr |= FPU_CSR_OVF_X | FPU_CSR_OVF_S;\r\n}\r\nif (ieee754_cxtest(IEEE754_ZERO_DIVIDE)) {\r\nMIPS_FPU_EMU_INC_STATS(ieee754_zerodiv);\r\nrcsr |= FPU_CSR_DIV_X | FPU_CSR_DIV_S;\r\n}\r\nif (ieee754_cxtest(IEEE754_INVALID_OPERATION)) {\r\nMIPS_FPU_EMU_INC_STATS(ieee754_invalidop);\r\nrcsr |= FPU_CSR_INV_X | FPU_CSR_INV_S;\r\n}\r\nbreak;\r\ncase fcvts_op:\r\nreturn SIGILL;\r\ncase fcvtd_op:\r\nSPFROMREG(fs, MIPSInst_FS(ir));\r\nrv.d = ieee754dp_fsp(fs);\r\nrfmt = d_fmt;\r\ngoto copcsr;\r\ncase fcvtw_op:\r\nSPFROMREG(fs, MIPSInst_FS(ir));\r\nrv.w = ieee754sp_tint(fs);\r\nrfmt = w_fmt;\r\ngoto copcsr;\r\ncase fround_op:\r\ncase ftrunc_op:\r\ncase fceil_op:\r\ncase ffloor_op:\r\nif (!cpu_has_mips_2_3_4_5_r)\r\nreturn SIGILL;\r\noldrm = ieee754_csr.rm;\r\nSPFROMREG(fs, MIPSInst_FS(ir));\r\nieee754_csr.rm = MIPSInst_FUNC(ir);\r\nrv.w = ieee754sp_tint(fs);\r\nieee754_csr.rm = oldrm;\r\nrfmt = w_fmt;\r\ngoto copcsr;\r\ncase fcvtl_op:\r\nif (!cpu_has_mips_3_4_5_64_r2_r6)\r\nreturn SIGILL;\r\nSPFROMREG(fs, MIPSInst_FS(ir));\r\nrv.l = ieee754sp_tlong(fs);\r\nrfmt = l_fmt;\r\ngoto copcsr;\r\ncase froundl_op:\r\ncase ftruncl_op:\r\ncase fceill_op:\r\ncase ffloorl_op:\r\nif (!cpu_has_mips_3_4_5_64_r2_r6)\r\nreturn SIGILL;\r\noldrm = ieee754_csr.rm;\r\nSPFROMREG(fs, MIPSInst_FS(ir));\r\nieee754_csr.rm = MIPSInst_FUNC(ir);\r\nrv.l = ieee754sp_tlong(fs);\r\nieee754_csr.rm = oldrm;\r\nrfmt = l_fmt;\r\ngoto copcsr;\r\ndefault:\r\nif (!NO_R6EMU && MIPSInst_FUNC(ir) >= fcmp_op) {\r\nunsigned cmpop = MIPSInst_FUNC(ir) - fcmp_op;\r\nunion ieee754sp fs, ft;\r\nSPFROMREG(fs, MIPSInst_FS(ir));\r\nSPFROMREG(ft, MIPSInst_FT(ir));\r\nrv.w = ieee754sp_cmp(fs, ft,\r\ncmptab[cmpop & 0x7], cmpop & 0x8);\r\nrfmt = -1;\r\nif ((cmpop & 0x8) && ieee754_cxtest\r\n(IEEE754_INVALID_OPERATION))\r\nrcsr = FPU_CSR_INV_X | FPU_CSR_INV_S;\r\nelse\r\ngoto copcsr;\r\n} else\r\nreturn SIGILL;\r\nbreak;\r\n}\r\nbreak;\r\n}\r\ncase d_fmt: {\r\nunion ieee754dp fs, ft;\r\nunion {\r\nunion ieee754dp(*b) (union ieee754dp, union ieee754dp);\r\nunion ieee754dp(*u) (union ieee754dp);\r\n} handler;\r\nswitch (MIPSInst_FUNC(ir)) {\r\ncase fadd_op:\r\nhandler.b = ieee754dp_add;\r\ngoto dcopbop;\r\ncase fsub_op:\r\nhandler.b = ieee754dp_sub;\r\ngoto dcopbop;\r\ncase fmul_op:\r\nhandler.b = ieee754dp_mul;\r\ngoto dcopbop;\r\ncase fdiv_op:\r\nhandler.b = ieee754dp_div;\r\ngoto dcopbop;\r\ncase fsqrt_op:\r\nif (!cpu_has_mips_2_3_4_5_r)\r\nreturn SIGILL;\r\nhandler.u = ieee754dp_sqrt;\r\ngoto dcopuop;\r\ncase frsqrt_op:\r\nif (!cpu_has_mips_4_5_64_r2_r6)\r\nreturn SIGILL;\r\nhandler.u = fpemu_dp_rsqrt;\r\ngoto dcopuop;\r\ncase frecip_op:\r\nif (!cpu_has_mips_4_5_64_r2_r6)\r\nreturn SIGILL;\r\nhandler.u = fpemu_dp_recip;\r\ngoto dcopuop;\r\ncase fmovc_op:\r\nif (!cpu_has_mips_4_5_r)\r\nreturn SIGILL;\r\ncond = fpucondbit[MIPSInst_FT(ir) >> 2];\r\nif (((ctx->fcr31 & cond) != 0) !=\r\n((MIPSInst_FT(ir) & 1) != 0))\r\nreturn 0;\r\nDPFROMREG(rv.d, MIPSInst_FS(ir));\r\nbreak;\r\ncase fmovz_op:\r\nif (!cpu_has_mips_4_5_r)\r\nreturn SIGILL;\r\nif (xcp->regs[MIPSInst_FT(ir)] != 0)\r\nreturn 0;\r\nDPFROMREG(rv.d, MIPSInst_FS(ir));\r\nbreak;\r\ncase fmovn_op:\r\nif (!cpu_has_mips_4_5_r)\r\nreturn SIGILL;\r\nif (xcp->regs[MIPSInst_FT(ir)] == 0)\r\nreturn 0;\r\nDPFROMREG(rv.d, MIPSInst_FS(ir));\r\nbreak;\r\ncase fseleqz_op:\r\nif (!cpu_has_mips_r6)\r\nreturn SIGILL;\r\nDPFROMREG(rv.d, MIPSInst_FT(ir));\r\nif (rv.l & 0x1)\r\nrv.l = 0;\r\nelse\r\nDPFROMREG(rv.d, MIPSInst_FS(ir));\r\nbreak;\r\ncase fselnez_op:\r\nif (!cpu_has_mips_r6)\r\nreturn SIGILL;\r\nDPFROMREG(rv.d, MIPSInst_FT(ir));\r\nif (rv.l & 0x1)\r\nDPFROMREG(rv.d, MIPSInst_FS(ir));\r\nelse\r\nrv.l = 0;\r\nbreak;\r\ncase fmaddf_op: {\r\nunion ieee754dp ft, fs, fd;\r\nif (!cpu_has_mips_r6)\r\nreturn SIGILL;\r\nDPFROMREG(ft, MIPSInst_FT(ir));\r\nDPFROMREG(fs, MIPSInst_FS(ir));\r\nDPFROMREG(fd, MIPSInst_FD(ir));\r\nrv.d = ieee754dp_maddf(fd, fs, ft);\r\nbreak;\r\n}\r\ncase fmsubf_op: {\r\nunion ieee754dp ft, fs, fd;\r\nif (!cpu_has_mips_r6)\r\nreturn SIGILL;\r\nDPFROMREG(ft, MIPSInst_FT(ir));\r\nDPFROMREG(fs, MIPSInst_FS(ir));\r\nDPFROMREG(fd, MIPSInst_FD(ir));\r\nrv.d = ieee754dp_msubf(fd, fs, ft);\r\nbreak;\r\n}\r\ncase frint_op: {\r\nunion ieee754dp fs;\r\nif (!cpu_has_mips_r6)\r\nreturn SIGILL;\r\nDPFROMREG(fs, MIPSInst_FS(ir));\r\nrv.l = ieee754dp_tlong(fs);\r\nrv.d = ieee754dp_flong(rv.l);\r\ngoto copcsr;\r\n}\r\ncase fclass_op: {\r\nunion ieee754dp fs;\r\nif (!cpu_has_mips_r6)\r\nreturn SIGILL;\r\nDPFROMREG(fs, MIPSInst_FS(ir));\r\nrv.w = ieee754dp_2008class(fs);\r\nrfmt = w_fmt;\r\nbreak;\r\n}\r\ncase fmin_op: {\r\nunion ieee754dp fs, ft;\r\nif (!cpu_has_mips_r6)\r\nreturn SIGILL;\r\nDPFROMREG(ft, MIPSInst_FT(ir));\r\nDPFROMREG(fs, MIPSInst_FS(ir));\r\nrv.d = ieee754dp_fmin(fs, ft);\r\nbreak;\r\n}\r\ncase fmina_op: {\r\nunion ieee754dp fs, ft;\r\nif (!cpu_has_mips_r6)\r\nreturn SIGILL;\r\nDPFROMREG(ft, MIPSInst_FT(ir));\r\nDPFROMREG(fs, MIPSInst_FS(ir));\r\nrv.d = ieee754dp_fmina(fs, ft);\r\nbreak;\r\n}\r\ncase fmax_op: {\r\nunion ieee754dp fs, ft;\r\nif (!cpu_has_mips_r6)\r\nreturn SIGILL;\r\nDPFROMREG(ft, MIPSInst_FT(ir));\r\nDPFROMREG(fs, MIPSInst_FS(ir));\r\nrv.d = ieee754dp_fmax(fs, ft);\r\nbreak;\r\n}\r\ncase fmaxa_op: {\r\nunion ieee754dp fs, ft;\r\nif (!cpu_has_mips_r6)\r\nreturn SIGILL;\r\nDPFROMREG(ft, MIPSInst_FT(ir));\r\nDPFROMREG(fs, MIPSInst_FS(ir));\r\nrv.d = ieee754dp_fmaxa(fs, ft);\r\nbreak;\r\n}\r\ncase fabs_op:\r\nhandler.u = ieee754dp_abs;\r\ngoto dcopuop;\r\ncase fneg_op:\r\nhandler.u = ieee754dp_neg;\r\ngoto dcopuop;\r\ncase fmov_op:\r\nDPFROMREG(rv.d, MIPSInst_FS(ir));\r\ngoto copcsr;\r\ndcopbop:\r\nDPFROMREG(fs, MIPSInst_FS(ir));\r\nDPFROMREG(ft, MIPSInst_FT(ir));\r\nrv.d = (*handler.b) (fs, ft);\r\ngoto copcsr;\r\ndcopuop:\r\nDPFROMREG(fs, MIPSInst_FS(ir));\r\nrv.d = (*handler.u) (fs);\r\ngoto copcsr;\r\ncase fcvts_op:\r\nDPFROMREG(fs, MIPSInst_FS(ir));\r\nrv.s = ieee754sp_fdp(fs);\r\nrfmt = s_fmt;\r\ngoto copcsr;\r\ncase fcvtd_op:\r\nreturn SIGILL;\r\ncase fcvtw_op:\r\nDPFROMREG(fs, MIPSInst_FS(ir));\r\nrv.w = ieee754dp_tint(fs);\r\nrfmt = w_fmt;\r\ngoto copcsr;\r\ncase fround_op:\r\ncase ftrunc_op:\r\ncase fceil_op:\r\ncase ffloor_op:\r\nif (!cpu_has_mips_2_3_4_5_r)\r\nreturn SIGILL;\r\noldrm = ieee754_csr.rm;\r\nDPFROMREG(fs, MIPSInst_FS(ir));\r\nieee754_csr.rm = MIPSInst_FUNC(ir);\r\nrv.w = ieee754dp_tint(fs);\r\nieee754_csr.rm = oldrm;\r\nrfmt = w_fmt;\r\ngoto copcsr;\r\ncase fcvtl_op:\r\nif (!cpu_has_mips_3_4_5_64_r2_r6)\r\nreturn SIGILL;\r\nDPFROMREG(fs, MIPSInst_FS(ir));\r\nrv.l = ieee754dp_tlong(fs);\r\nrfmt = l_fmt;\r\ngoto copcsr;\r\ncase froundl_op:\r\ncase ftruncl_op:\r\ncase fceill_op:\r\ncase ffloorl_op:\r\nif (!cpu_has_mips_3_4_5_64_r2_r6)\r\nreturn SIGILL;\r\noldrm = ieee754_csr.rm;\r\nDPFROMREG(fs, MIPSInst_FS(ir));\r\nieee754_csr.rm = MIPSInst_FUNC(ir);\r\nrv.l = ieee754dp_tlong(fs);\r\nieee754_csr.rm = oldrm;\r\nrfmt = l_fmt;\r\ngoto copcsr;\r\ndefault:\r\nif (!NO_R6EMU && MIPSInst_FUNC(ir) >= fcmp_op) {\r\nunsigned cmpop = MIPSInst_FUNC(ir) - fcmp_op;\r\nunion ieee754dp fs, ft;\r\nDPFROMREG(fs, MIPSInst_FS(ir));\r\nDPFROMREG(ft, MIPSInst_FT(ir));\r\nrv.w = ieee754dp_cmp(fs, ft,\r\ncmptab[cmpop & 0x7], cmpop & 0x8);\r\nrfmt = -1;\r\nif ((cmpop & 0x8)\r\n&&\r\nieee754_cxtest\r\n(IEEE754_INVALID_OPERATION))\r\nrcsr = FPU_CSR_INV_X | FPU_CSR_INV_S;\r\nelse\r\ngoto copcsr;\r\n}\r\nelse {\r\nreturn SIGILL;\r\n}\r\nbreak;\r\n}\r\nbreak;\r\n}\r\ncase w_fmt: {\r\nunion ieee754dp fs;\r\nswitch (MIPSInst_FUNC(ir)) {\r\ncase fcvts_op:\r\nSPFROMREG(fs, MIPSInst_FS(ir));\r\nrv.s = ieee754sp_fint(fs.bits);\r\nrfmt = s_fmt;\r\ngoto copcsr;\r\ncase fcvtd_op:\r\nSPFROMREG(fs, MIPSInst_FS(ir));\r\nrv.d = ieee754dp_fint(fs.bits);\r\nrfmt = d_fmt;\r\ngoto copcsr;\r\ndefault: {\r\n#define CMPOP_MASK 0x7\r\n#define SIGN_BIT (0x1 << 3)\r\n#define PREDICATE_BIT (0x1 << 4)\r\nint cmpop = MIPSInst_FUNC(ir) & CMPOP_MASK;\r\nint sig = MIPSInst_FUNC(ir) & SIGN_BIT;\r\nunion ieee754sp fs, ft;\r\nif (!cpu_has_mips_r6 ||\r\n(MIPSInst_FUNC(ir) & 0x20))\r\nreturn SIGILL;\r\nrfmt = s_fmt;\r\nrv.w = 0;\r\nSPFROMREG(fs, MIPSInst_FS(ir));\r\nSPFROMREG(ft, MIPSInst_FT(ir));\r\nif (!(MIPSInst_FUNC(ir) & PREDICATE_BIT)) {\r\nif (ieee754sp_cmp(fs, ft, cmptab[cmpop],\r\nsig))\r\nrv.w = -1;\r\nif ((sig) &&\r\nieee754_cxtest(IEEE754_INVALID_OPERATION))\r\nrcsr = FPU_CSR_INV_X | FPU_CSR_INV_S;\r\nelse\r\ngoto copcsr;\r\n} else {\r\nswitch (cmpop) {\r\ncase 1:\r\ncase 2:\r\ncase 3:\r\nif (ieee754sp_cmp(fs, ft,\r\nnegative_cmptab[cmpop],\r\nsig))\r\nrv.w = -1;\r\nif (sig &&\r\nieee754_cxtest(IEEE754_INVALID_OPERATION))\r\nrcsr = FPU_CSR_INV_X | FPU_CSR_INV_S;\r\nelse\r\ngoto copcsr;\r\nbreak;\r\ndefault:\r\npr_err("Reserved MIPS R6 CMP.condn.S operation\n");\r\nreturn SIGILL;\r\n}\r\n}\r\nbreak;\r\n}\r\n}\r\n}\r\ncase l_fmt:\r\nif (!cpu_has_mips_3_4_5_64_r2_r6)\r\nreturn SIGILL;\r\nDIFROMREG(bits, MIPSInst_FS(ir));\r\nswitch (MIPSInst_FUNC(ir)) {\r\ncase fcvts_op:\r\nrv.s = ieee754sp_flong(bits);\r\nrfmt = s_fmt;\r\ngoto copcsr;\r\ncase fcvtd_op:\r\nrv.d = ieee754dp_flong(bits);\r\nrfmt = d_fmt;\r\ngoto copcsr;\r\ndefault: {\r\nint cmpop = MIPSInst_FUNC(ir) & CMPOP_MASK;\r\nint sig = MIPSInst_FUNC(ir) & SIGN_BIT;\r\nunion ieee754dp fs, ft;\r\nif (!cpu_has_mips_r6 ||\r\n(MIPSInst_FUNC(ir) & 0x20))\r\nreturn SIGILL;\r\nrfmt = d_fmt;\r\nrv.l = 0;\r\nDPFROMREG(fs, MIPSInst_FS(ir));\r\nDPFROMREG(ft, MIPSInst_FT(ir));\r\nif (!(MIPSInst_FUNC(ir) & PREDICATE_BIT)) {\r\nif (ieee754dp_cmp(fs, ft,\r\ncmptab[cmpop], sig))\r\nrv.l = -1LL;\r\nif (sig &&\r\nieee754_cxtest(IEEE754_INVALID_OPERATION))\r\nrcsr = FPU_CSR_INV_X | FPU_CSR_INV_S;\r\nelse\r\ngoto copcsr;\r\n} else {\r\nswitch (cmpop) {\r\ncase 1:\r\ncase 2:\r\ncase 3:\r\nif (ieee754dp_cmp(fs, ft,\r\nnegative_cmptab[cmpop],\r\nsig))\r\nrv.l = -1LL;\r\nif (sig &&\r\nieee754_cxtest(IEEE754_INVALID_OPERATION))\r\nrcsr = FPU_CSR_INV_X | FPU_CSR_INV_S;\r\nelse\r\ngoto copcsr;\r\nbreak;\r\ndefault:\r\npr_err("Reserved MIPS R6 CMP.condn.D operation\n");\r\nreturn SIGILL;\r\n}\r\n}\r\nbreak;\r\n}\r\n}\r\ndefault:\r\nreturn SIGILL;\r\n}\r\nctx->fcr31 = (ctx->fcr31 & ~FPU_CSR_ALL_X) | rcsr;\r\nif ((ctx->fcr31 >> 5) & ctx->fcr31 & FPU_CSR_ALL_E) {\r\nreturn SIGFPE;\r\n}\r\nswitch (rfmt) {\r\ncase -1:\r\nif (cpu_has_mips_4_5_r)\r\ncbit = fpucondbit[MIPSInst_FD(ir) >> 2];\r\nelse\r\ncbit = FPU_CSR_COND;\r\nif (rv.w)\r\nctx->fcr31 |= cbit;\r\nelse\r\nctx->fcr31 &= ~cbit;\r\nbreak;\r\ncase d_fmt:\r\nDPTOREG(rv.d, MIPSInst_FD(ir));\r\nbreak;\r\ncase s_fmt:\r\nSPTOREG(rv.s, MIPSInst_FD(ir));\r\nbreak;\r\ncase w_fmt:\r\nSITOREG(rv.w, MIPSInst_FD(ir));\r\nbreak;\r\ncase l_fmt:\r\nif (!cpu_has_mips_3_4_5_64_r2_r6)\r\nreturn SIGILL;\r\nDITOREG(rv.l, MIPSInst_FD(ir));\r\nbreak;\r\ndefault:\r\nreturn SIGILL;\r\n}\r\nreturn 0;\r\n}\r\nint fpu_emulator_cop1Handler(struct pt_regs *xcp, struct mips_fpu_struct *ctx,\r\nint has_fpu, void *__user *fault_addr)\r\n{\r\nunsigned long oldepc, prevepc;\r\nstruct mm_decoded_insn dec_insn;\r\nu16 instr[4];\r\nu16 *instr_ptr;\r\nint sig = 0;\r\noldepc = xcp->cp0_epc;\r\ndo {\r\nprevepc = xcp->cp0_epc;\r\nif (get_isa16_mode(prevepc) && cpu_has_mmips) {\r\nif ((get_user(instr[0], (u16 __user *)msk_isa16_mode(xcp->cp0_epc))) ||\r\n(get_user(instr[1], (u16 __user *)msk_isa16_mode(xcp->cp0_epc + 2))) ||\r\n(get_user(instr[2], (u16 __user *)msk_isa16_mode(xcp->cp0_epc + 4))) ||\r\n(get_user(instr[3], (u16 __user *)msk_isa16_mode(xcp->cp0_epc + 6)))) {\r\nMIPS_FPU_EMU_INC_STATS(errors);\r\nreturn SIGBUS;\r\n}\r\ninstr_ptr = instr;\r\nif (mm_insn_16bit(*instr_ptr)) {\r\ndec_insn.insn = (*instr_ptr << 16) |\r\n(*instr_ptr);\r\ndec_insn.pc_inc = 2;\r\ninstr_ptr += 1;\r\n} else {\r\ndec_insn.insn = (*instr_ptr << 16) |\r\n*(instr_ptr+1);\r\ndec_insn.pc_inc = 4;\r\ninstr_ptr += 2;\r\n}\r\nif (mm_insn_16bit(*instr_ptr)) {\r\ndec_insn.next_insn = (*instr_ptr << 16) |\r\n(*instr_ptr);\r\ndec_insn.next_pc_inc = 2;\r\n} else {\r\ndec_insn.next_insn = (*instr_ptr << 16) |\r\n*(instr_ptr+1);\r\ndec_insn.next_pc_inc = 4;\r\n}\r\ndec_insn.micro_mips_mode = 1;\r\n} else {\r\nif ((get_user(dec_insn.insn,\r\n(mips_instruction __user *) xcp->cp0_epc)) ||\r\n(get_user(dec_insn.next_insn,\r\n(mips_instruction __user *)(xcp->cp0_epc+4)))) {\r\nMIPS_FPU_EMU_INC_STATS(errors);\r\nreturn SIGBUS;\r\n}\r\ndec_insn.pc_inc = 4;\r\ndec_insn.next_pc_inc = 4;\r\ndec_insn.micro_mips_mode = 0;\r\n}\r\nif ((dec_insn.insn == 0) ||\r\n((dec_insn.pc_inc == 2) &&\r\n((dec_insn.insn & 0xffff) == MM_NOP16)))\r\nxcp->cp0_epc += dec_insn.pc_inc;\r\nelse {\r\nsig = cop1Emulate(xcp, ctx, dec_insn, fault_addr);\r\n}\r\nif (has_fpu)\r\nbreak;\r\nif (sig)\r\nbreak;\r\ncond_resched();\r\n} while (xcp->cp0_epc > prevepc);\r\nif (sig == SIGILL && xcp->cp0_epc != oldepc)\r\nsig = 0;\r\nreturn sig;\r\n}

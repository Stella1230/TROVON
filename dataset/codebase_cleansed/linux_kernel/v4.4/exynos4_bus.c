static int exynos4210_set_busclk(struct busfreq_data *data,\r\nstruct busfreq_opp_info *oppi)\r\n{\r\nunsigned int index;\r\nunsigned int tmp;\r\nfor (index = LV_0; index < EX4210_LV_NUM; index++)\r\nif (oppi->rate == exynos4210_busclk_table[index].clk)\r\nbreak;\r\nif (index == EX4210_LV_NUM)\r\nreturn -EINVAL;\r\ntmp = data->dmc_divtable[index];\r\n__raw_writel(tmp, EXYNOS4_CLKDIV_DMC0);\r\ndo {\r\ntmp = __raw_readl(EXYNOS4_CLKDIV_STAT_DMC0);\r\n} while (tmp & 0x11111111);\r\ntmp = data->top_divtable[index];\r\n__raw_writel(tmp, EXYNOS4_CLKDIV_TOP);\r\ndo {\r\ntmp = __raw_readl(EXYNOS4_CLKDIV_STAT_TOP);\r\n} while (tmp & 0x11111);\r\ntmp = __raw_readl(EXYNOS4_CLKDIV_LEFTBUS);\r\ntmp &= ~(EXYNOS4_CLKDIV_BUS_GDLR_MASK | EXYNOS4_CLKDIV_BUS_GPLR_MASK);\r\ntmp |= ((exynos4210_clkdiv_lr_bus[index][0] <<\r\nEXYNOS4_CLKDIV_BUS_GDLR_SHIFT) |\r\n(exynos4210_clkdiv_lr_bus[index][1] <<\r\nEXYNOS4_CLKDIV_BUS_GPLR_SHIFT));\r\n__raw_writel(tmp, EXYNOS4_CLKDIV_LEFTBUS);\r\ndo {\r\ntmp = __raw_readl(EXYNOS4_CLKDIV_STAT_LEFTBUS);\r\n} while (tmp & 0x11);\r\ntmp = __raw_readl(EXYNOS4_CLKDIV_RIGHTBUS);\r\ntmp &= ~(EXYNOS4_CLKDIV_BUS_GDLR_MASK | EXYNOS4_CLKDIV_BUS_GPLR_MASK);\r\ntmp |= ((exynos4210_clkdiv_lr_bus[index][0] <<\r\nEXYNOS4_CLKDIV_BUS_GDLR_SHIFT) |\r\n(exynos4210_clkdiv_lr_bus[index][1] <<\r\nEXYNOS4_CLKDIV_BUS_GPLR_SHIFT));\r\n__raw_writel(tmp, EXYNOS4_CLKDIV_RIGHTBUS);\r\ndo {\r\ntmp = __raw_readl(EXYNOS4_CLKDIV_STAT_RIGHTBUS);\r\n} while (tmp & 0x11);\r\nreturn 0;\r\n}\r\nstatic int exynos4x12_set_busclk(struct busfreq_data *data,\r\nstruct busfreq_opp_info *oppi)\r\n{\r\nunsigned int index;\r\nunsigned int tmp;\r\nfor (index = LV_0; index < EX4x12_LV_NUM; index++)\r\nif (oppi->rate == exynos4x12_mifclk_table[index].clk)\r\nbreak;\r\nif (index == EX4x12_LV_NUM)\r\nreturn -EINVAL;\r\ntmp = data->dmc_divtable[index];\r\n__raw_writel(tmp, EXYNOS4_CLKDIV_DMC0);\r\ndo {\r\ntmp = __raw_readl(EXYNOS4_CLKDIV_STAT_DMC0);\r\n} while (tmp & 0x11111111);\r\ntmp = __raw_readl(EXYNOS4_CLKDIV_DMC1);\r\ntmp &= ~(EXYNOS4_CLKDIV_DMC1_G2D_ACP_MASK |\r\nEXYNOS4_CLKDIV_DMC1_C2C_MASK |\r\nEXYNOS4_CLKDIV_DMC1_C2CACLK_MASK);\r\ntmp |= ((exynos4x12_clkdiv_dmc1[index][0] <<\r\nEXYNOS4_CLKDIV_DMC1_G2D_ACP_SHIFT) |\r\n(exynos4x12_clkdiv_dmc1[index][1] <<\r\nEXYNOS4_CLKDIV_DMC1_C2C_SHIFT) |\r\n(exynos4x12_clkdiv_dmc1[index][2] <<\r\nEXYNOS4_CLKDIV_DMC1_C2CACLK_SHIFT));\r\n__raw_writel(tmp, EXYNOS4_CLKDIV_DMC1);\r\ndo {\r\ntmp = __raw_readl(EXYNOS4_CLKDIV_STAT_DMC1);\r\n} while (tmp & 0x111111);\r\ntmp = __raw_readl(EXYNOS4_CLKDIV_TOP);\r\ntmp &= ~(EXYNOS4_CLKDIV_TOP_ACLK266_GPS_MASK |\r\nEXYNOS4_CLKDIV_TOP_ACLK100_MASK |\r\nEXYNOS4_CLKDIV_TOP_ACLK160_MASK |\r\nEXYNOS4_CLKDIV_TOP_ACLK133_MASK |\r\nEXYNOS4_CLKDIV_TOP_ONENAND_MASK);\r\ntmp |= ((exynos4x12_clkdiv_top[index][0] <<\r\nEXYNOS4_CLKDIV_TOP_ACLK266_GPS_SHIFT) |\r\n(exynos4x12_clkdiv_top[index][1] <<\r\nEXYNOS4_CLKDIV_TOP_ACLK100_SHIFT) |\r\n(exynos4x12_clkdiv_top[index][2] <<\r\nEXYNOS4_CLKDIV_TOP_ACLK160_SHIFT) |\r\n(exynos4x12_clkdiv_top[index][3] <<\r\nEXYNOS4_CLKDIV_TOP_ACLK133_SHIFT) |\r\n(exynos4x12_clkdiv_top[index][4] <<\r\nEXYNOS4_CLKDIV_TOP_ONENAND_SHIFT));\r\n__raw_writel(tmp, EXYNOS4_CLKDIV_TOP);\r\ndo {\r\ntmp = __raw_readl(EXYNOS4_CLKDIV_STAT_TOP);\r\n} while (tmp & 0x11111);\r\ntmp = __raw_readl(EXYNOS4_CLKDIV_LEFTBUS);\r\ntmp &= ~(EXYNOS4_CLKDIV_BUS_GDLR_MASK | EXYNOS4_CLKDIV_BUS_GPLR_MASK);\r\ntmp |= ((exynos4x12_clkdiv_lr_bus[index][0] <<\r\nEXYNOS4_CLKDIV_BUS_GDLR_SHIFT) |\r\n(exynos4x12_clkdiv_lr_bus[index][1] <<\r\nEXYNOS4_CLKDIV_BUS_GPLR_SHIFT));\r\n__raw_writel(tmp, EXYNOS4_CLKDIV_LEFTBUS);\r\ndo {\r\ntmp = __raw_readl(EXYNOS4_CLKDIV_STAT_LEFTBUS);\r\n} while (tmp & 0x11);\r\ntmp = __raw_readl(EXYNOS4_CLKDIV_RIGHTBUS);\r\ntmp &= ~(EXYNOS4_CLKDIV_BUS_GDLR_MASK | EXYNOS4_CLKDIV_BUS_GPLR_MASK);\r\ntmp |= ((exynos4x12_clkdiv_lr_bus[index][0] <<\r\nEXYNOS4_CLKDIV_BUS_GDLR_SHIFT) |\r\n(exynos4x12_clkdiv_lr_bus[index][1] <<\r\nEXYNOS4_CLKDIV_BUS_GPLR_SHIFT));\r\n__raw_writel(tmp, EXYNOS4_CLKDIV_RIGHTBUS);\r\ndo {\r\ntmp = __raw_readl(EXYNOS4_CLKDIV_STAT_RIGHTBUS);\r\n} while (tmp & 0x11);\r\ntmp = __raw_readl(EXYNOS4_CLKDIV_MFC);\r\ntmp &= ~(EXYNOS4_CLKDIV_MFC_MASK);\r\ntmp |= ((exynos4x12_clkdiv_sclkip[index][0] <<\r\nEXYNOS4_CLKDIV_MFC_SHIFT));\r\n__raw_writel(tmp, EXYNOS4_CLKDIV_MFC);\r\ndo {\r\ntmp = __raw_readl(EXYNOS4_CLKDIV_STAT_MFC);\r\n} while (tmp & 0x1);\r\ntmp = __raw_readl(EXYNOS4_CLKDIV_CAM1);\r\ntmp &= ~(EXYNOS4_CLKDIV_CAM1_JPEG_MASK);\r\ntmp |= ((exynos4x12_clkdiv_sclkip[index][1] <<\r\nEXYNOS4_CLKDIV_CAM1_JPEG_SHIFT));\r\n__raw_writel(tmp, EXYNOS4_CLKDIV_CAM1);\r\ndo {\r\ntmp = __raw_readl(EXYNOS4_CLKDIV_STAT_CAM1);\r\n} while (tmp & 0x1);\r\ntmp = __raw_readl(EXYNOS4_CLKDIV_CAM);\r\ntmp &= ~(EXYNOS4_CLKDIV_CAM_FIMC0_MASK | EXYNOS4_CLKDIV_CAM_FIMC1_MASK |\r\nEXYNOS4_CLKDIV_CAM_FIMC2_MASK | EXYNOS4_CLKDIV_CAM_FIMC3_MASK);\r\ntmp |= ((exynos4x12_clkdiv_sclkip[index][2] <<\r\nEXYNOS4_CLKDIV_CAM_FIMC0_SHIFT) |\r\n(exynos4x12_clkdiv_sclkip[index][2] <<\r\nEXYNOS4_CLKDIV_CAM_FIMC1_SHIFT) |\r\n(exynos4x12_clkdiv_sclkip[index][2] <<\r\nEXYNOS4_CLKDIV_CAM_FIMC2_SHIFT) |\r\n(exynos4x12_clkdiv_sclkip[index][2] <<\r\nEXYNOS4_CLKDIV_CAM_FIMC3_SHIFT));\r\n__raw_writel(tmp, EXYNOS4_CLKDIV_CAM);\r\ndo {\r\ntmp = __raw_readl(EXYNOS4_CLKDIV_STAT_CAM1);\r\n} while (tmp & 0x1111);\r\nreturn 0;\r\n}\r\nstatic int exynos4x12_get_intspec(unsigned long mifclk)\r\n{\r\nint i = 0;\r\nwhile (exynos4x12_intclk_table[i].clk) {\r\nif (exynos4x12_intclk_table[i].clk <= mifclk)\r\nreturn i;\r\ni++;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int exynos4_bus_setvolt(struct busfreq_data *data,\r\nstruct busfreq_opp_info *oppi,\r\nstruct busfreq_opp_info *oldoppi)\r\n{\r\nint err = 0, tmp;\r\nunsigned long volt = oppi->volt;\r\nswitch (data->type) {\r\ncase TYPE_BUSF_EXYNOS4210:\r\nerr = regulator_set_voltage(data->vdd_int, volt,\r\nMAX_SAFEVOLT);\r\nbreak;\r\ncase TYPE_BUSF_EXYNOS4x12:\r\nerr = regulator_set_voltage(data->vdd_mif, volt,\r\nMAX_SAFEVOLT);\r\nif (err)\r\nbreak;\r\ntmp = exynos4x12_get_intspec(oppi->rate);\r\nif (tmp < 0) {\r\nerr = tmp;\r\nregulator_set_voltage(data->vdd_mif,\r\noldoppi->volt,\r\nMAX_SAFEVOLT);\r\nbreak;\r\n}\r\nerr = regulator_set_voltage(data->vdd_int,\r\nexynos4x12_intclk_table[tmp].volt,\r\nMAX_SAFEVOLT);\r\nif (err)\r\nregulator_set_voltage(data->vdd_mif,\r\noldoppi->volt,\r\nMAX_SAFEVOLT);\r\nbreak;\r\ndefault:\r\nerr = -EINVAL;\r\n}\r\nreturn err;\r\n}\r\nstatic int exynos4_bus_target(struct device *dev, unsigned long *_freq,\r\nu32 flags)\r\n{\r\nint err = 0;\r\nstruct platform_device *pdev = container_of(dev, struct platform_device,\r\ndev);\r\nstruct busfreq_data *data = platform_get_drvdata(pdev);\r\nstruct dev_pm_opp *opp;\r\nunsigned long freq;\r\nunsigned long old_freq = data->curr_oppinfo.rate;\r\nstruct busfreq_opp_info new_oppinfo;\r\nrcu_read_lock();\r\nopp = devfreq_recommended_opp(dev, _freq, flags);\r\nif (IS_ERR(opp)) {\r\nrcu_read_unlock();\r\nreturn PTR_ERR(opp);\r\n}\r\nnew_oppinfo.rate = dev_pm_opp_get_freq(opp);\r\nnew_oppinfo.volt = dev_pm_opp_get_voltage(opp);\r\nrcu_read_unlock();\r\nfreq = new_oppinfo.rate;\r\nif (old_freq == freq)\r\nreturn 0;\r\ndev_dbg(dev, "targeting %lukHz %luuV\n", freq, new_oppinfo.volt);\r\nmutex_lock(&data->lock);\r\nif (data->disabled)\r\ngoto out;\r\nif (old_freq < freq)\r\nerr = exynos4_bus_setvolt(data, &new_oppinfo,\r\n&data->curr_oppinfo);\r\nif (err)\r\ngoto out;\r\nif (old_freq != freq) {\r\nswitch (data->type) {\r\ncase TYPE_BUSF_EXYNOS4210:\r\nerr = exynos4210_set_busclk(data, &new_oppinfo);\r\nbreak;\r\ncase TYPE_BUSF_EXYNOS4x12:\r\nerr = exynos4x12_set_busclk(data, &new_oppinfo);\r\nbreak;\r\ndefault:\r\nerr = -EINVAL;\r\n}\r\n}\r\nif (err)\r\ngoto out;\r\nif (old_freq > freq)\r\nerr = exynos4_bus_setvolt(data, &new_oppinfo,\r\n&data->curr_oppinfo);\r\nif (err)\r\ngoto out;\r\ndata->curr_oppinfo = new_oppinfo;\r\nout:\r\nmutex_unlock(&data->lock);\r\nreturn err;\r\n}\r\nstatic int exynos4_bus_get_dev_status(struct device *dev,\r\nstruct devfreq_dev_status *stat)\r\n{\r\nstruct busfreq_data *data = dev_get_drvdata(dev);\r\nstruct busfreq_ppmu_data *ppmu_data = &data->ppmu_data;\r\nint busier;\r\nexynos_read_ppmu(ppmu_data);\r\nbusier = exynos_get_busier_ppmu(ppmu_data);\r\nstat->current_frequency = data->curr_oppinfo.rate;\r\nstat->busy_time = ppmu_data->ppmu[busier].count[PPMU_PMNCNT3];\r\nstat->busy_time *= 100 / BUS_SATURATION_RATIO;\r\nstat->total_time = ppmu_data->ppmu[busier].ccnt;\r\nif (ppmu_data->ppmu[busier].ccnt_overflow ||\r\nppmu_data->ppmu[busier].count_overflow[0])\r\nreturn -EAGAIN;\r\nreturn 0;\r\n}\r\nstatic int exynos4210_init_tables(struct busfreq_data *data)\r\n{\r\nu32 tmp;\r\nint mgrp;\r\nint i, err = 0;\r\ntmp = __raw_readl(EXYNOS4_CLKDIV_DMC0);\r\nfor (i = LV_0; i < EX4210_LV_NUM; i++) {\r\ntmp &= ~(EXYNOS4_CLKDIV_DMC0_ACP_MASK |\r\nEXYNOS4_CLKDIV_DMC0_ACPPCLK_MASK |\r\nEXYNOS4_CLKDIV_DMC0_DPHY_MASK |\r\nEXYNOS4_CLKDIV_DMC0_DMC_MASK |\r\nEXYNOS4_CLKDIV_DMC0_DMCD_MASK |\r\nEXYNOS4_CLKDIV_DMC0_DMCP_MASK |\r\nEXYNOS4_CLKDIV_DMC0_COPY2_MASK |\r\nEXYNOS4_CLKDIV_DMC0_CORETI_MASK);\r\ntmp |= ((exynos4210_clkdiv_dmc0[i][0] <<\r\nEXYNOS4_CLKDIV_DMC0_ACP_SHIFT) |\r\n(exynos4210_clkdiv_dmc0[i][1] <<\r\nEXYNOS4_CLKDIV_DMC0_ACPPCLK_SHIFT) |\r\n(exynos4210_clkdiv_dmc0[i][2] <<\r\nEXYNOS4_CLKDIV_DMC0_DPHY_SHIFT) |\r\n(exynos4210_clkdiv_dmc0[i][3] <<\r\nEXYNOS4_CLKDIV_DMC0_DMC_SHIFT) |\r\n(exynos4210_clkdiv_dmc0[i][4] <<\r\nEXYNOS4_CLKDIV_DMC0_DMCD_SHIFT) |\r\n(exynos4210_clkdiv_dmc0[i][5] <<\r\nEXYNOS4_CLKDIV_DMC0_DMCP_SHIFT) |\r\n(exynos4210_clkdiv_dmc0[i][6] <<\r\nEXYNOS4_CLKDIV_DMC0_COPY2_SHIFT) |\r\n(exynos4210_clkdiv_dmc0[i][7] <<\r\nEXYNOS4_CLKDIV_DMC0_CORETI_SHIFT));\r\ndata->dmc_divtable[i] = tmp;\r\n}\r\ntmp = __raw_readl(EXYNOS4_CLKDIV_TOP);\r\nfor (i = LV_0; i < EX4210_LV_NUM; i++) {\r\ntmp &= ~(EXYNOS4_CLKDIV_TOP_ACLK200_MASK |\r\nEXYNOS4_CLKDIV_TOP_ACLK100_MASK |\r\nEXYNOS4_CLKDIV_TOP_ACLK160_MASK |\r\nEXYNOS4_CLKDIV_TOP_ACLK133_MASK |\r\nEXYNOS4_CLKDIV_TOP_ONENAND_MASK);\r\ntmp |= ((exynos4210_clkdiv_top[i][0] <<\r\nEXYNOS4_CLKDIV_TOP_ACLK200_SHIFT) |\r\n(exynos4210_clkdiv_top[i][1] <<\r\nEXYNOS4_CLKDIV_TOP_ACLK100_SHIFT) |\r\n(exynos4210_clkdiv_top[i][2] <<\r\nEXYNOS4_CLKDIV_TOP_ACLK160_SHIFT) |\r\n(exynos4210_clkdiv_top[i][3] <<\r\nEXYNOS4_CLKDIV_TOP_ACLK133_SHIFT) |\r\n(exynos4210_clkdiv_top[i][4] <<\r\nEXYNOS4_CLKDIV_TOP_ONENAND_SHIFT));\r\ndata->top_divtable[i] = tmp;\r\n}\r\ntmp = 0;\r\npr_debug("ASV Group of Exynos4 is %d\n", tmp);\r\nswitch (tmp) {\r\ncase 0:\r\nmgrp = 0;\r\nbreak;\r\ncase 1:\r\ncase 2:\r\nmgrp = 1;\r\nbreak;\r\ncase 3:\r\ncase 4:\r\nmgrp = 2;\r\nbreak;\r\ncase 5:\r\ncase 6:\r\nmgrp = 3;\r\nbreak;\r\ncase 7:\r\nmgrp = 4;\r\nbreak;\r\ndefault:\r\npr_warn("Unknown ASV Group. Use max voltage.\n");\r\nmgrp = 0;\r\n}\r\nfor (i = LV_0; i < EX4210_LV_NUM; i++)\r\nexynos4210_busclk_table[i].volt = exynos4210_asv_volt[mgrp][i];\r\nfor (i = LV_0; i < EX4210_LV_NUM; i++) {\r\nerr = dev_pm_opp_add(data->dev, exynos4210_busclk_table[i].clk,\r\nexynos4210_busclk_table[i].volt);\r\nif (err) {\r\ndev_err(data->dev, "Cannot add opp entries.\n");\r\nreturn err;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int exynos4x12_init_tables(struct busfreq_data *data)\r\n{\r\nunsigned int i;\r\nunsigned int tmp;\r\nint ret;\r\ntmp = __raw_readl(EXYNOS4_DMC_PAUSE_CTRL);\r\ntmp |= EXYNOS4_DMC_PAUSE_ENABLE;\r\n__raw_writel(tmp, EXYNOS4_DMC_PAUSE_CTRL);\r\ntmp = __raw_readl(EXYNOS4_CLKDIV_DMC0);\r\nfor (i = 0; i < EX4x12_LV_NUM; i++) {\r\ntmp &= ~(EXYNOS4_CLKDIV_DMC0_ACP_MASK |\r\nEXYNOS4_CLKDIV_DMC0_ACPPCLK_MASK |\r\nEXYNOS4_CLKDIV_DMC0_DPHY_MASK |\r\nEXYNOS4_CLKDIV_DMC0_DMC_MASK |\r\nEXYNOS4_CLKDIV_DMC0_DMCD_MASK |\r\nEXYNOS4_CLKDIV_DMC0_DMCP_MASK);\r\ntmp |= ((exynos4x12_clkdiv_dmc0[i][0] <<\r\nEXYNOS4_CLKDIV_DMC0_ACP_SHIFT) |\r\n(exynos4x12_clkdiv_dmc0[i][1] <<\r\nEXYNOS4_CLKDIV_DMC0_ACPPCLK_SHIFT) |\r\n(exynos4x12_clkdiv_dmc0[i][2] <<\r\nEXYNOS4_CLKDIV_DMC0_DPHY_SHIFT) |\r\n(exynos4x12_clkdiv_dmc0[i][3] <<\r\nEXYNOS4_CLKDIV_DMC0_DMC_SHIFT) |\r\n(exynos4x12_clkdiv_dmc0[i][4] <<\r\nEXYNOS4_CLKDIV_DMC0_DMCD_SHIFT) |\r\n(exynos4x12_clkdiv_dmc0[i][5] <<\r\nEXYNOS4_CLKDIV_DMC0_DMCP_SHIFT));\r\ndata->dmc_divtable[i] = tmp;\r\n}\r\ntmp = 0;\r\nif (tmp > 8)\r\ntmp = 0;\r\npr_debug("ASV Group of Exynos4x12 is %d\n", tmp);\r\nfor (i = 0; i < EX4x12_LV_NUM; i++) {\r\nexynos4x12_mifclk_table[i].volt =\r\nexynos4x12_mif_step_50[tmp][i];\r\nexynos4x12_intclk_table[i].volt =\r\nexynos4x12_int_volt[tmp][i];\r\n}\r\nfor (i = 0; i < EX4x12_LV_NUM; i++) {\r\nret = dev_pm_opp_add(data->dev, exynos4x12_mifclk_table[i].clk,\r\nexynos4x12_mifclk_table[i].volt);\r\nif (ret) {\r\ndev_err(data->dev, "Fail to add opp entries.\n");\r\nreturn ret;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int exynos4_busfreq_pm_notifier_event(struct notifier_block *this,\r\nunsigned long event, void *ptr)\r\n{\r\nstruct busfreq_data *data = container_of(this, struct busfreq_data,\r\npm_notifier);\r\nstruct dev_pm_opp *opp;\r\nstruct busfreq_opp_info new_oppinfo;\r\nunsigned long maxfreq = ULONG_MAX;\r\nint err = 0;\r\nswitch (event) {\r\ncase PM_SUSPEND_PREPARE:\r\nmutex_lock(&data->lock);\r\ndata->disabled = true;\r\nrcu_read_lock();\r\nopp = dev_pm_opp_find_freq_floor(data->dev, &maxfreq);\r\nif (IS_ERR(opp)) {\r\nrcu_read_unlock();\r\ndev_err(data->dev, "%s: unable to find a min freq\n",\r\n__func__);\r\nmutex_unlock(&data->lock);\r\nreturn PTR_ERR(opp);\r\n}\r\nnew_oppinfo.rate = dev_pm_opp_get_freq(opp);\r\nnew_oppinfo.volt = dev_pm_opp_get_voltage(opp);\r\nrcu_read_unlock();\r\nerr = exynos4_bus_setvolt(data, &new_oppinfo,\r\n&data->curr_oppinfo);\r\nif (err)\r\ngoto unlock;\r\nswitch (data->type) {\r\ncase TYPE_BUSF_EXYNOS4210:\r\nerr = exynos4210_set_busclk(data, &new_oppinfo);\r\nbreak;\r\ncase TYPE_BUSF_EXYNOS4x12:\r\nerr = exynos4x12_set_busclk(data, &new_oppinfo);\r\nbreak;\r\ndefault:\r\nerr = -EINVAL;\r\n}\r\nif (err)\r\ngoto unlock;\r\ndata->curr_oppinfo = new_oppinfo;\r\nunlock:\r\nmutex_unlock(&data->lock);\r\nif (err)\r\nreturn err;\r\nreturn NOTIFY_OK;\r\ncase PM_POST_RESTORE:\r\ncase PM_POST_SUSPEND:\r\nmutex_lock(&data->lock);\r\ndata->disabled = false;\r\nmutex_unlock(&data->lock);\r\nreturn NOTIFY_OK;\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int exynos4_busfreq_probe(struct platform_device *pdev)\r\n{\r\nstruct busfreq_data *data;\r\nstruct busfreq_ppmu_data *ppmu_data;\r\nstruct dev_pm_opp *opp;\r\nstruct device *dev = &pdev->dev;\r\nint err = 0;\r\ndata = devm_kzalloc(&pdev->dev, sizeof(struct busfreq_data), GFP_KERNEL);\r\nif (data == NULL) {\r\ndev_err(dev, "Cannot allocate memory.\n");\r\nreturn -ENOMEM;\r\n}\r\nppmu_data = &data->ppmu_data;\r\nppmu_data->ppmu_end = PPMU_END;\r\nppmu_data->ppmu = devm_kzalloc(dev,\r\nsizeof(struct exynos_ppmu) * PPMU_END,\r\nGFP_KERNEL);\r\nif (!ppmu_data->ppmu) {\r\ndev_err(dev, "Failed to allocate memory for exynos_ppmu\n");\r\nreturn -ENOMEM;\r\n}\r\ndata->type = pdev->id_entry->driver_data;\r\nppmu_data->ppmu[PPMU_DMC0].hw_base = S5P_VA_DMC0;\r\nppmu_data->ppmu[PPMU_DMC1].hw_base = S5P_VA_DMC1;\r\ndata->pm_notifier.notifier_call = exynos4_busfreq_pm_notifier_event;\r\ndata->dev = dev;\r\nmutex_init(&data->lock);\r\nswitch (data->type) {\r\ncase TYPE_BUSF_EXYNOS4210:\r\nerr = exynos4210_init_tables(data);\r\nbreak;\r\ncase TYPE_BUSF_EXYNOS4x12:\r\nerr = exynos4x12_init_tables(data);\r\nbreak;\r\ndefault:\r\ndev_err(dev, "Cannot determine the device id %d\n", data->type);\r\nerr = -EINVAL;\r\n}\r\nif (err) {\r\ndev_err(dev, "Cannot initialize busfreq table %d\n",\r\ndata->type);\r\nreturn err;\r\n}\r\ndata->vdd_int = devm_regulator_get(dev, "vdd_int");\r\nif (IS_ERR(data->vdd_int)) {\r\ndev_err(dev, "Cannot get the regulator \"vdd_int\"\n");\r\nreturn PTR_ERR(data->vdd_int);\r\n}\r\nif (data->type == TYPE_BUSF_EXYNOS4x12) {\r\ndata->vdd_mif = devm_regulator_get(dev, "vdd_mif");\r\nif (IS_ERR(data->vdd_mif)) {\r\ndev_err(dev, "Cannot get the regulator \"vdd_mif\"\n");\r\nreturn PTR_ERR(data->vdd_mif);\r\n}\r\n}\r\nrcu_read_lock();\r\nopp = dev_pm_opp_find_freq_floor(dev,\r\n&exynos4_devfreq_profile.initial_freq);\r\nif (IS_ERR(opp)) {\r\nrcu_read_unlock();\r\ndev_err(dev, "Invalid initial frequency %lu kHz.\n",\r\nexynos4_devfreq_profile.initial_freq);\r\nreturn PTR_ERR(opp);\r\n}\r\ndata->curr_oppinfo.rate = dev_pm_opp_get_freq(opp);\r\ndata->curr_oppinfo.volt = dev_pm_opp_get_voltage(opp);\r\nrcu_read_unlock();\r\nplatform_set_drvdata(pdev, data);\r\ndata->devfreq = devm_devfreq_add_device(dev, &exynos4_devfreq_profile,\r\n"simple_ondemand", NULL);\r\nif (IS_ERR(data->devfreq))\r\nreturn PTR_ERR(data->devfreq);\r\nbusfreq_mon_reset(ppmu_data);\r\nerr = devm_devfreq_register_opp_notifier(dev, data->devfreq);\r\nif (err < 0) {\r\ndev_err(dev, "Failed to register opp notifier\n");\r\nreturn err;\r\n}\r\nerr = register_pm_notifier(&data->pm_notifier);\r\nif (err) {\r\ndev_err(dev, "Failed to setup pm notifier\n");\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int exynos4_busfreq_remove(struct platform_device *pdev)\r\n{\r\nstruct busfreq_data *data = platform_get_drvdata(pdev);\r\nunregister_pm_notifier(&data->pm_notifier);\r\nreturn 0;\r\n}\r\nstatic int exynos4_busfreq_resume(struct device *dev)\r\n{\r\nstruct busfreq_data *data = dev_get_drvdata(dev);\r\nstruct busfreq_ppmu_data *ppmu_data = &data->ppmu_data;\r\nbusfreq_mon_reset(ppmu_data);\r\nreturn 0;\r\n}\r\nstatic int __init exynos4_busfreq_init(void)\r\n{\r\nreturn platform_driver_register(&exynos4_busfreq_driver);\r\n}\r\nstatic void __exit exynos4_busfreq_exit(void)\r\n{\r\nplatform_driver_unregister(&exynos4_busfreq_driver);\r\n}

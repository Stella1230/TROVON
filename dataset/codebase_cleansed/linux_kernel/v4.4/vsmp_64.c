asmlinkage __visible unsigned long vsmp_save_fl(void)\r\n{\r\nunsigned long flags = native_save_fl();\r\nif (!(flags & X86_EFLAGS_IF) || (flags & X86_EFLAGS_AC))\r\nflags &= ~X86_EFLAGS_IF;\r\nreturn flags;\r\n}\r\n__visible void vsmp_restore_fl(unsigned long flags)\r\n{\r\nif (flags & X86_EFLAGS_IF)\r\nflags &= ~X86_EFLAGS_AC;\r\nelse\r\nflags |= X86_EFLAGS_AC;\r\nnative_restore_fl(flags);\r\n}\r\nasmlinkage __visible void vsmp_irq_disable(void)\r\n{\r\nunsigned long flags = native_save_fl();\r\nnative_restore_fl((flags & ~X86_EFLAGS_IF) | X86_EFLAGS_AC);\r\n}\r\nasmlinkage __visible void vsmp_irq_enable(void)\r\n{\r\nunsigned long flags = native_save_fl();\r\nnative_restore_fl((flags | X86_EFLAGS_IF) & (~X86_EFLAGS_AC));\r\n}\r\nstatic unsigned __init vsmp_patch(u8 type, u16 clobbers, void *ibuf,\r\nunsigned long addr, unsigned len)\r\n{\r\nswitch (type) {\r\ncase PARAVIRT_PATCH(pv_irq_ops.irq_enable):\r\ncase PARAVIRT_PATCH(pv_irq_ops.irq_disable):\r\ncase PARAVIRT_PATCH(pv_irq_ops.save_fl):\r\ncase PARAVIRT_PATCH(pv_irq_ops.restore_fl):\r\nreturn paravirt_patch_default(type, clobbers, ibuf, addr, len);\r\ndefault:\r\nreturn native_patch(type, clobbers, ibuf, addr, len);\r\n}\r\n}\r\nstatic void __init set_vsmp_pv_ops(void)\r\n{\r\nvoid __iomem *address;\r\nunsigned int cap, ctl, cfg;\r\ncfg = read_pci_config(0, 0x1f, 0, PCI_BASE_ADDRESS_0);\r\naddress = early_ioremap(cfg, 8);\r\ncap = readl(address);\r\nctl = readl(address + 4);\r\nprintk(KERN_INFO "vSMP CTL: capabilities:0x%08x control:0x%08x\n",\r\ncap, ctl);\r\n#ifdef CONFIG_SMP\r\nif (cap & ctl & BIT(8)) {\r\nctl &= ~BIT(8);\r\nirq_routing_comply = 0;\r\n#ifdef CONFIG_PROC_FS\r\nno_irq_affinity = 1;\r\n#endif\r\n}\r\n#endif\r\nif (cap & ctl & (1 << 4)) {\r\npv_irq_ops.irq_disable = PV_CALLEE_SAVE(vsmp_irq_disable);\r\npv_irq_ops.irq_enable = PV_CALLEE_SAVE(vsmp_irq_enable);\r\npv_irq_ops.save_fl = PV_CALLEE_SAVE(vsmp_save_fl);\r\npv_irq_ops.restore_fl = PV_CALLEE_SAVE(vsmp_restore_fl);\r\npv_init_ops.patch = vsmp_patch;\r\nctl &= ~(1 << 4);\r\n}\r\nwritel(ctl, address + 4);\r\nctl = readl(address + 4);\r\npr_info("vSMP CTL: control set to:0x%08x\n", ctl);\r\nearly_iounmap(address, 8);\r\n}\r\nstatic void __init set_vsmp_pv_ops(void)\r\n{\r\n}\r\nstatic void __init detect_vsmp_box(void)\r\n{\r\nis_vsmp = 0;\r\nif (!early_pci_allowed())\r\nreturn;\r\nif (read_pci_config(0, 0x1f, 0, PCI_VENDOR_ID) ==\r\n(PCI_VENDOR_ID_SCALEMP | (PCI_DEVICE_ID_SCALEMP_VSMP_CTL << 16)))\r\nis_vsmp = 1;\r\n}\r\nstatic int is_vsmp_box(void)\r\n{\r\nif (is_vsmp != -1)\r\nreturn is_vsmp;\r\nelse {\r\nWARN_ON_ONCE(1);\r\nreturn 0;\r\n}\r\n}\r\nstatic void __init detect_vsmp_box(void)\r\n{\r\n}\r\nstatic int is_vsmp_box(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic void __init vsmp_cap_cpus(void)\r\n{\r\n#if !defined(CONFIG_X86_VSMP) && defined(CONFIG_SMP)\r\nvoid __iomem *address;\r\nunsigned int cfg, topology, node_shift, maxcpus;\r\nif (setup_max_cpus != NR_CPUS)\r\nreturn;\r\ncfg = read_pci_config(0, 0x1f, 0, PCI_BASE_ADDRESS_0);\r\naddress = early_ioremap(cfg + TOPOLOGY_REGISTER_OFFSET, 4);\r\nif (WARN_ON(!address))\r\nreturn;\r\ntopology = readl(address);\r\nnode_shift = (topology >> 16) & 0x7;\r\nif (!node_shift)\r\nnode_shift = 8;\r\nmaxcpus = (topology & ((1 << node_shift) - 1)) + 1;\r\npr_info("vSMP CTL: Capping CPUs to %d (CONFIG_X86_VSMP is unset)\n",\r\nmaxcpus);\r\nsetup_max_cpus = maxcpus;\r\nearly_iounmap(address, 4);\r\n#endif\r\n}\r\nstatic int apicid_phys_pkg_id(int initial_apic_id, int index_msb)\r\n{\r\nreturn hard_smp_processor_id() >> index_msb;\r\n}\r\nstatic void fill_vector_allocation_domain(int cpu, struct cpumask *retmask,\r\nconst struct cpumask *mask)\r\n{\r\ncpumask_setall(retmask);\r\n}\r\nstatic void vsmp_apic_post_init(void)\r\n{\r\napic->phys_pkg_id = apicid_phys_pkg_id;\r\nif (!irq_routing_comply)\r\napic->vector_allocation_domain = fill_vector_allocation_domain;\r\n}\r\nvoid __init vsmp_init(void)\r\n{\r\ndetect_vsmp_box();\r\nif (!is_vsmp_box())\r\nreturn;\r\nx86_platform.apic_post_init = vsmp_apic_post_init;\r\nvsmp_cap_cpus();\r\nset_vsmp_pv_ops();\r\nreturn;\r\n}

static int u300_shutdown(struct clock_event_device *evt)\r\n{\r\nwritel(U300_TIMER_APP_GPT1IE_IRQ_DISABLE,\r\nu300_timer_base + U300_TIMER_APP_GPT1IE);\r\nwritel(U300_TIMER_APP_DGPT1_TIMER_DISABLE,\r\nu300_timer_base + U300_TIMER_APP_DGPT1);\r\nreturn 0;\r\n}\r\nstatic int u300_set_oneshot(struct clock_event_device *evt)\r\n{\r\nwritel(U300_TIMER_APP_GPT1IE_IRQ_DISABLE,\r\nu300_timer_base + U300_TIMER_APP_GPT1IE);\r\nwritel(U300_TIMER_APP_DGPT1_TIMER_DISABLE,\r\nu300_timer_base + U300_TIMER_APP_DGPT1);\r\nwritel(0xFFFFFFFF, u300_timer_base + U300_TIMER_APP_GPT1TC);\r\nwritel(U300_TIMER_APP_SGPT1M_MODE_ONE_SHOT,\r\nu300_timer_base + U300_TIMER_APP_SGPT1M);\r\nwritel(U300_TIMER_APP_GPT1IE_IRQ_ENABLE,\r\nu300_timer_base + U300_TIMER_APP_GPT1IE);\r\nwritel(U300_TIMER_APP_EGPT1_TIMER_ENABLE,\r\nu300_timer_base + U300_TIMER_APP_EGPT1);\r\nreturn 0;\r\n}\r\nstatic int u300_set_periodic(struct clock_event_device *evt)\r\n{\r\nstruct u300_clockevent_data *cevdata =\r\ncontainer_of(evt, struct u300_clockevent_data, cevd);\r\nwritel(U300_TIMER_APP_GPT1IE_IRQ_DISABLE,\r\nu300_timer_base + U300_TIMER_APP_GPT1IE);\r\nwritel(U300_TIMER_APP_DGPT1_TIMER_DISABLE,\r\nu300_timer_base + U300_TIMER_APP_DGPT1);\r\nwritel(cevdata->ticks_per_jiffy,\r\nu300_timer_base + U300_TIMER_APP_GPT1TC);\r\nwritel(U300_TIMER_APP_SGPT1M_MODE_CONTINUOUS,\r\nu300_timer_base + U300_TIMER_APP_SGPT1M);\r\nwritel(U300_TIMER_APP_GPT1IE_IRQ_ENABLE,\r\nu300_timer_base + U300_TIMER_APP_GPT1IE);\r\nwritel(U300_TIMER_APP_EGPT1_TIMER_ENABLE,\r\nu300_timer_base + U300_TIMER_APP_EGPT1);\r\nreturn 0;\r\n}\r\nstatic int u300_set_next_event(unsigned long cycles,\r\nstruct clock_event_device *evt)\r\n{\r\nwritel(U300_TIMER_APP_GPT1IE_IRQ_DISABLE,\r\nu300_timer_base + U300_TIMER_APP_GPT1IE);\r\nwritel(U300_TIMER_APP_DGPT1_TIMER_DISABLE,\r\nu300_timer_base + U300_TIMER_APP_DGPT1);\r\nwritel(U300_TIMER_APP_RGPT1_TIMER_RESET,\r\nu300_timer_base + U300_TIMER_APP_RGPT1);\r\nwritel(cycles, u300_timer_base + U300_TIMER_APP_GPT1TC);\r\nwritel(U300_TIMER_APP_SGPT1M_MODE_ONE_SHOT,\r\nu300_timer_base + U300_TIMER_APP_SGPT1M);\r\nwritel(U300_TIMER_APP_GPT1IE_IRQ_ENABLE,\r\nu300_timer_base + U300_TIMER_APP_GPT1IE);\r\nwritel(U300_TIMER_APP_EGPT1_TIMER_ENABLE,\r\nu300_timer_base + U300_TIMER_APP_EGPT1);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t u300_timer_interrupt(int irq, void *dev_id)\r\n{\r\nstruct clock_event_device *evt = &u300_clockevent_data.cevd;\r\nwritel(U300_TIMER_APP_GPT1IA_IRQ_ACK,\r\nu300_timer_base + U300_TIMER_APP_GPT1IA);\r\nevt->event_handler(evt);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic u64 notrace u300_read_sched_clock(void)\r\n{\r\nreturn readl(u300_timer_base + U300_TIMER_APP_GPT2CC);\r\n}\r\nstatic unsigned long u300_read_current_timer(void)\r\n{\r\nreturn readl(u300_timer_base + U300_TIMER_APP_GPT2CC);\r\n}\r\nstatic void __init u300_timer_init_of(struct device_node *np)\r\n{\r\nunsigned int irq;\r\nstruct clk *clk;\r\nunsigned long rate;\r\nu300_timer_base = of_iomap(np, 0);\r\nif (!u300_timer_base)\r\npanic("could not ioremap system timer\n");\r\nirq = irq_of_parse_and_map(np, 2);\r\nif (!irq)\r\npanic("no IRQ for system timer\n");\r\npr_info("U300 GP1 timer @ base: %p, IRQ: %u\n", u300_timer_base, irq);\r\nclk = of_clk_get(np, 0);\r\nBUG_ON(IS_ERR(clk));\r\nclk_prepare_enable(clk);\r\nrate = clk_get_rate(clk);\r\nu300_clockevent_data.ticks_per_jiffy = DIV_ROUND_CLOSEST(rate, HZ);\r\nsched_clock_register(u300_read_sched_clock, 32, rate);\r\nu300_delay_timer.read_current_timer = &u300_read_current_timer;\r\nu300_delay_timer.freq = rate;\r\nregister_current_timer_delay(&u300_delay_timer);\r\nwritel(U300_TIMER_APP_CRC_CLOCK_REQUEST_ENABLE,\r\nu300_timer_base + U300_TIMER_APP_CRC);\r\nwritel(U300_TIMER_APP_ROST_TIMER_RESET,\r\nu300_timer_base + U300_TIMER_APP_ROST);\r\nwritel(U300_TIMER_APP_DOST_TIMER_DISABLE,\r\nu300_timer_base + U300_TIMER_APP_DOST);\r\nwritel(U300_TIMER_APP_RDDT_TIMER_RESET,\r\nu300_timer_base + U300_TIMER_APP_RDDT);\r\nwritel(U300_TIMER_APP_DDDT_TIMER_DISABLE,\r\nu300_timer_base + U300_TIMER_APP_DDDT);\r\nwritel(U300_TIMER_APP_RGPT1_TIMER_RESET,\r\nu300_timer_base + U300_TIMER_APP_RGPT1);\r\nsetup_irq(irq, &u300_timer_irq);\r\nwritel(U300_TIMER_APP_RGPT2_TIMER_RESET,\r\nu300_timer_base + U300_TIMER_APP_RGPT2);\r\nwritel(0xFFFFFFFFU, u300_timer_base + U300_TIMER_APP_GPT2TC);\r\nwritel(U300_TIMER_APP_SGPT2M_MODE_CONTINUOUS,\r\nu300_timer_base + U300_TIMER_APP_SGPT2M);\r\nwritel(U300_TIMER_APP_GPT2IE_IRQ_DISABLE,\r\nu300_timer_base + U300_TIMER_APP_GPT2IE);\r\nwritel(U300_TIMER_APP_EGPT2_TIMER_ENABLE,\r\nu300_timer_base + U300_TIMER_APP_EGPT2);\r\nif (clocksource_mmio_init(u300_timer_base + U300_TIMER_APP_GPT2CC,\r\n"GPT2", rate, 300, 32, clocksource_mmio_readl_up))\r\npr_err("timer: failed to initialize U300 clock source\n");\r\nclockevents_config_and_register(&u300_clockevent_data.cevd, rate,\r\n1, 0xffffffff);\r\n}

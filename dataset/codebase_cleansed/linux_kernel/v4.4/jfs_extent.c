int\r\nextAlloc(struct inode *ip, s64 xlen, s64 pno, xad_t * xp, bool abnr)\r\n{\r\nstruct jfs_sb_info *sbi = JFS_SBI(ip->i_sb);\r\ns64 nxlen, nxaddr, xoff, hint, xaddr = 0;\r\nint rc;\r\nint xflag;\r\ntxBeginAnon(ip->i_sb);\r\nmutex_lock(&JFS_IP(ip)->commit_mutex);\r\nif (xlen > MAXXLEN)\r\nxlen = MAXXLEN;\r\nxoff = pno << sbi->l2nbperpage;\r\nif ((hint = addressXAD(xp))) {\r\nnxlen = lengthXAD(xp);\r\nif (offsetXAD(xp) + nxlen == xoff &&\r\nabnr == ((xp->flag & XAD_NOTRECORDED) ? true : false))\r\nxaddr = hint + nxlen;\r\nhint += (nxlen - 1);\r\n}\r\nnxlen = xlen;\r\nif ((rc = extBalloc(ip, hint ? hint : INOHINT(ip), &nxlen, &nxaddr))) {\r\nmutex_unlock(&JFS_IP(ip)->commit_mutex);\r\nreturn (rc);\r\n}\r\nrc = dquot_alloc_block(ip, nxlen);\r\nif (rc) {\r\ndbFree(ip, nxaddr, (s64) nxlen);\r\nmutex_unlock(&JFS_IP(ip)->commit_mutex);\r\nreturn rc;\r\n}\r\nxflag = abnr ? XAD_NOTRECORDED : 0;\r\nif (xaddr && xaddr == nxaddr)\r\nrc = xtExtend(0, ip, xoff, (int) nxlen, 0);\r\nelse\r\nrc = xtInsert(0, ip, xflag, xoff, (int) nxlen, &nxaddr, 0);\r\nif (rc) {\r\ndbFree(ip, nxaddr, nxlen);\r\ndquot_free_block(ip, nxlen);\r\nmutex_unlock(&JFS_IP(ip)->commit_mutex);\r\nreturn (rc);\r\n}\r\nXADaddress(xp, nxaddr);\r\nXADlength(xp, nxlen);\r\nXADoffset(xp, xoff);\r\nxp->flag = xflag;\r\nmark_inode_dirty(ip);\r\nmutex_unlock(&JFS_IP(ip)->commit_mutex);\r\nif (test_and_clear_cflag(COMMIT_Synclist,ip))\r\njfs_commit_inode(ip, 0);\r\nreturn (0);\r\n}\r\nint extRealloc(struct inode *ip, s64 nxlen, xad_t * xp, bool abnr)\r\n{\r\nstruct super_block *sb = ip->i_sb;\r\ns64 xaddr, xlen, nxaddr, delta, xoff;\r\ns64 ntail, nextend, ninsert;\r\nint rc, nbperpage = JFS_SBI(sb)->nbperpage;\r\nint xflag;\r\ntxBeginAnon(ip->i_sb);\r\nmutex_lock(&JFS_IP(ip)->commit_mutex);\r\nif (nxlen > MAXXLEN)\r\nnxlen = MAXXLEN;\r\nxaddr = addressXAD(xp);\r\nxlen = lengthXAD(xp);\r\nxoff = offsetXAD(xp);\r\nif ((xp->flag & XAD_NOTRECORDED) && !abnr) {\r\nxp->flag = 0;\r\nif ((rc = xtUpdate(0, ip, xp)))\r\ngoto exit;\r\n}\r\nif ((rc = extBrealloc(ip, xaddr, xlen, &nxlen, &nxaddr)))\r\ngoto exit;\r\nrc = dquot_alloc_block(ip, nxlen);\r\nif (rc) {\r\ndbFree(ip, nxaddr, (s64) nxlen);\r\nmutex_unlock(&JFS_IP(ip)->commit_mutex);\r\nreturn rc;\r\n}\r\ndelta = nxlen - xlen;\r\nif (abnr && (!(xp->flag & XAD_NOTRECORDED)) && (nxlen > nbperpage)) {\r\nntail = nbperpage;\r\nnextend = ntail - xlen;\r\nninsert = nxlen - nbperpage;\r\nxflag = XAD_NOTRECORDED;\r\n} else {\r\nntail = nxlen;\r\nnextend = delta;\r\nninsert = 0;\r\nxflag = xp->flag;\r\n}\r\nif (xaddr == nxaddr) {\r\nif ((rc = xtExtend(0, ip, xoff + xlen, (int) nextend, 0))) {\r\ndbFree(ip, xaddr + xlen, delta);\r\ndquot_free_block(ip, nxlen);\r\ngoto exit;\r\n}\r\n} else {\r\nif ((rc = xtTailgate(0, ip, xoff, (int) ntail, nxaddr, 0))) {\r\ndbFree(ip, nxaddr, nxlen);\r\ndquot_free_block(ip, nxlen);\r\ngoto exit;\r\n}\r\n}\r\nif (ninsert) {\r\nxaddr = nxaddr + ntail;\r\nif (xtInsert (0, ip, xflag, xoff + ntail, (int) ninsert,\r\n&xaddr, 0)) {\r\ndbFree(ip, xaddr, (s64) ninsert);\r\ndelta = nextend;\r\nnxlen = ntail;\r\nxflag = 0;\r\n}\r\n}\r\nXADaddress(xp, nxaddr);\r\nXADlength(xp, nxlen);\r\nXADoffset(xp, xoff);\r\nxp->flag = xflag;\r\nmark_inode_dirty(ip);\r\nexit:\r\nmutex_unlock(&JFS_IP(ip)->commit_mutex);\r\nreturn (rc);\r\n}\r\nint extHint(struct inode *ip, s64 offset, xad_t * xp)\r\n{\r\nstruct super_block *sb = ip->i_sb;\r\nint nbperpage = JFS_SBI(sb)->nbperpage;\r\ns64 prev;\r\nint rc = 0;\r\ns64 xaddr;\r\nint xlen;\r\nint xflag;\r\nXADaddress(xp, 0);\r\nprev = ((offset & ~POFFSET) >> JFS_SBI(sb)->l2bsize) - nbperpage;\r\nif (prev < 0)\r\ngoto out;\r\nrc = xtLookup(ip, prev, nbperpage, &xflag, &xaddr, &xlen, 0);\r\nif ((rc == 0) && xlen) {\r\nif (xlen != nbperpage) {\r\njfs_error(ip->i_sb, "corrupt xtree\n");\r\nrc = -EIO;\r\n}\r\nXADaddress(xp, xaddr);\r\nXADlength(xp, xlen);\r\nXADoffset(xp, prev);\r\nxp->flag = xflag & XAD_NOTRECORDED;\r\n} else\r\nrc = 0;\r\nout:\r\nreturn (rc);\r\n}\r\nint extRecord(struct inode *ip, xad_t * xp)\r\n{\r\nint rc;\r\ntxBeginAnon(ip->i_sb);\r\nmutex_lock(&JFS_IP(ip)->commit_mutex);\r\nrc = xtUpdate(0, ip, xp);\r\nmutex_unlock(&JFS_IP(ip)->commit_mutex);\r\nreturn rc;\r\n}\r\nint extFill(struct inode *ip, xad_t * xp)\r\n{\r\nint rc, nbperpage = JFS_SBI(ip->i_sb)->nbperpage;\r\ns64 blkno = offsetXAD(xp) >> ip->i_blkbits;\r\nXADaddress(xp, 0);\r\nif ((rc = extAlloc(ip, nbperpage, blkno, xp, false)))\r\nreturn (rc);\r\nassert(lengthPXD(xp) == nbperpage);\r\nreturn (0);\r\n}\r\nstatic int\r\nextBalloc(struct inode *ip, s64 hint, s64 * nblocks, s64 * blkno)\r\n{\r\nstruct jfs_inode_info *ji = JFS_IP(ip);\r\nstruct jfs_sb_info *sbi = JFS_SBI(ip->i_sb);\r\ns64 nb, nblks, daddr, max;\r\nint rc, nbperpage = sbi->nbperpage;\r\nstruct bmap *bmp = sbi->bmap;\r\nint ag;\r\nmax = (s64) 1 << bmp->db_maxfreebud;\r\nif (*nblocks >= max && *nblocks > nbperpage)\r\nnb = nblks = (max > nbperpage) ? max : nbperpage;\r\nelse\r\nnb = nblks = *nblocks;\r\nwhile ((rc = dbAlloc(ip, hint, nb, &daddr)) != 0) {\r\nif (rc != -ENOSPC)\r\nreturn (rc);\r\nnb = min(nblks, extRoundDown(nb));\r\nif (nb < nbperpage)\r\nreturn (rc);\r\n}\r\n*nblocks = nb;\r\n*blkno = daddr;\r\nif (S_ISREG(ip->i_mode) && (ji->fileset == FILESYSTEM_I)) {\r\nag = BLKTOAG(daddr, sbi);\r\nspin_lock_irq(&ji->ag_lock);\r\nif (ji->active_ag == -1) {\r\natomic_inc(&bmp->db_active[ag]);\r\nji->active_ag = ag;\r\n} else if (ji->active_ag != ag) {\r\natomic_dec(&bmp->db_active[ji->active_ag]);\r\natomic_inc(&bmp->db_active[ag]);\r\nji->active_ag = ag;\r\n}\r\nspin_unlock_irq(&ji->ag_lock);\r\n}\r\nreturn (0);\r\n}\r\nstatic int\r\nextBrealloc(struct inode *ip,\r\ns64 blkno, s64 nblks, s64 * newnblks, s64 * newblkno)\r\n{\r\nint rc;\r\nif ((rc = dbExtend(ip, blkno, nblks, *newnblks - nblks)) == 0) {\r\n*newblkno = blkno;\r\nreturn (0);\r\n} else {\r\nif (rc != -ENOSPC)\r\nreturn (rc);\r\n}\r\nreturn (extBalloc(ip, blkno, newnblks, newblkno));\r\n}\r\nstatic s64 extRoundDown(s64 nb)\r\n{\r\nint i;\r\nu64 m, k;\r\nfor (i = 0, m = (u64) 1 << 63; i < 64; i++, m >>= 1) {\r\nif (m & nb)\r\nbreak;\r\n}\r\ni = 63 - i;\r\nk = (u64) 1 << i;\r\nk = ((k - 1) & nb) ? k : k >> 1;\r\nreturn (k);\r\n}

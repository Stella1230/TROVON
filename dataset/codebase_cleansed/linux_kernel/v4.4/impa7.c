static int __init init_impa7(void)\r\n{\r\nconst char * const *type;\r\nint i;\r\nstatic struct { u_long addr; u_long size; } pt[NUM_FLASHBANKS] = {\r\n{ WINDOW_ADDR0, WINDOW_SIZE0 },\r\n{ WINDOW_ADDR1, WINDOW_SIZE1 },\r\n};\r\nint devicesfound = 0;\r\nfor(i=0; i<NUM_FLASHBANKS; i++)\r\n{\r\nprintk(KERN_NOTICE MSG_PREFIX "probing 0x%08lx at 0x%08lx\n",\r\npt[i].size, pt[i].addr);\r\nimpa7_map[i].phys = pt[i].addr;\r\nimpa7_map[i].virt = ioremap(pt[i].addr, pt[i].size);\r\nif (!impa7_map[i].virt) {\r\nprintk(MSG_PREFIX "failed to ioremap\n");\r\nreturn -EIO;\r\n}\r\nsimple_map_init(&impa7_map[i]);\r\nimpa7_mtd[i] = NULL;\r\ntype = rom_probe_types;\r\nfor(; !impa7_mtd[i] && *type; type++) {\r\nimpa7_mtd[i] = do_map_probe(*type, &impa7_map[i]);\r\n}\r\nif (impa7_mtd[i]) {\r\nimpa7_mtd[i]->owner = THIS_MODULE;\r\ndevicesfound++;\r\nmtd_device_parse_register(impa7_mtd[i], NULL, NULL,\r\npartitions,\r\nARRAY_SIZE(partitions));\r\n} else {\r\niounmap((void __iomem *)impa7_map[i].virt);\r\n}\r\n}\r\nreturn devicesfound == 0 ? -ENXIO : 0;\r\n}\r\nstatic void __exit cleanup_impa7(void)\r\n{\r\nint i;\r\nfor (i=0; i<NUM_FLASHBANKS; i++) {\r\nif (impa7_mtd[i]) {\r\nmtd_device_unregister(impa7_mtd[i]);\r\nmap_destroy(impa7_mtd[i]);\r\niounmap((void __iomem *)impa7_map[i].virt);\r\nimpa7_map[i].virt = NULL;\r\n}\r\n}\r\n}

static int omninet_port_probe(struct usb_serial_port *port)\r\n{\r\nstruct omninet_data *od;\r\nod = kzalloc(sizeof(*od), GFP_KERNEL);\r\nif (!od)\r\nreturn -ENOMEM;\r\nusb_set_serial_port_data(port, od);\r\nreturn 0;\r\n}\r\nstatic int omninet_port_remove(struct usb_serial_port *port)\r\n{\r\nstruct omninet_data *od;\r\nod = usb_get_serial_port_data(port);\r\nkfree(od);\r\nreturn 0;\r\n}\r\nstatic int omninet_open(struct tty_struct *tty, struct usb_serial_port *port)\r\n{\r\nstruct usb_serial *serial = port->serial;\r\nstruct usb_serial_port *wport;\r\nwport = serial->port[1];\r\ntty_port_tty_set(&wport->port, tty);\r\nreturn usb_serial_generic_open(tty, port);\r\n}\r\nstatic void omninet_process_read_urb(struct urb *urb)\r\n{\r\nstruct usb_serial_port *port = urb->context;\r\nconst struct omninet_header *hdr = urb->transfer_buffer;\r\nconst unsigned char *data;\r\nsize_t data_len;\r\nif (urb->actual_length <= OMNINET_HEADERLEN || !hdr->oh_len)\r\nreturn;\r\ndata = (char *)urb->transfer_buffer + OMNINET_HEADERLEN;\r\ndata_len = min_t(size_t, urb->actual_length - OMNINET_HEADERLEN,\r\nhdr->oh_len);\r\ntty_insert_flip_string(&port->port, data, data_len);\r\ntty_flip_buffer_push(&port->port);\r\n}\r\nstatic int omninet_write(struct tty_struct *tty, struct usb_serial_port *port,\r\nconst unsigned char *buf, int count)\r\n{\r\nstruct usb_serial *serial = port->serial;\r\nstruct usb_serial_port *wport = serial->port[1];\r\nstruct omninet_data *od = usb_get_serial_port_data(port);\r\nstruct omninet_header *header = (struct omninet_header *)\r\nwport->write_urb->transfer_buffer;\r\nint result;\r\nif (count == 0) {\r\ndev_dbg(&port->dev, "%s - write request of 0 bytes\n", __func__);\r\nreturn 0;\r\n}\r\nif (!test_and_clear_bit(0, &port->write_urbs_free)) {\r\ndev_dbg(&port->dev, "%s - already writing\n", __func__);\r\nreturn 0;\r\n}\r\ncount = (count > OMNINET_PAYLOADSIZE) ? OMNINET_PAYLOADSIZE : count;\r\nmemcpy(wport->write_urb->transfer_buffer + OMNINET_HEADERLEN,\r\nbuf, count);\r\nusb_serial_debug_data(&port->dev, __func__, count,\r\nwport->write_urb->transfer_buffer);\r\nheader->oh_seq = od->od_outseq++;\r\nheader->oh_len = count;\r\nheader->oh_xxx = 0x03;\r\nheader->oh_pad = 0x00;\r\nwport->write_urb->transfer_buffer_length = OMNINET_BULKOUTSIZE;\r\nresult = usb_submit_urb(wport->write_urb, GFP_ATOMIC);\r\nif (result) {\r\nset_bit(0, &wport->write_urbs_free);\r\ndev_err_console(port,\r\n"%s - failed submitting write urb, error %d\n",\r\n__func__, result);\r\n} else\r\nresult = count;\r\nreturn result;\r\n}\r\nstatic int omninet_write_room(struct tty_struct *tty)\r\n{\r\nstruct usb_serial_port *port = tty->driver_data;\r\nstruct usb_serial *serial = port->serial;\r\nstruct usb_serial_port *wport = serial->port[1];\r\nint room = 0;\r\nif (test_bit(0, &wport->write_urbs_free))\r\nroom = wport->bulk_out_size - OMNINET_HEADERLEN;\r\ndev_dbg(&port->dev, "%s - returns %d\n", __func__, room);\r\nreturn room;\r\n}\r\nstatic void omninet_write_bulk_callback(struct urb *urb)\r\n{\r\nstruct usb_serial_port *port = urb->context;\r\nint status = urb->status;\r\nset_bit(0, &port->write_urbs_free);\r\nif (status) {\r\ndev_dbg(&port->dev, "%s - nonzero write bulk status received: %d\n",\r\n__func__, status);\r\nreturn;\r\n}\r\nusb_serial_port_softint(port);\r\n}\r\nstatic void omninet_disconnect(struct usb_serial *serial)\r\n{\r\nstruct usb_serial_port *wport = serial->port[1];\r\nusb_kill_urb(wport->write_urb);\r\n}

static int compat_r128_init(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\ndrm_r128_init32_t init32;\r\ndrm_r128_init_t __user *init;\r\nif (copy_from_user(&init32, (void __user *)arg, sizeof(init32)))\r\nreturn -EFAULT;\r\ninit = compat_alloc_user_space(sizeof(*init));\r\nif (!access_ok(VERIFY_WRITE, init, sizeof(*init))\r\n|| __put_user(init32.func, &init->func)\r\n|| __put_user(init32.sarea_priv_offset, &init->sarea_priv_offset)\r\n|| __put_user(init32.is_pci, &init->is_pci)\r\n|| __put_user(init32.cce_mode, &init->cce_mode)\r\n|| __put_user(init32.cce_secure, &init->cce_secure)\r\n|| __put_user(init32.ring_size, &init->ring_size)\r\n|| __put_user(init32.usec_timeout, &init->usec_timeout)\r\n|| __put_user(init32.fb_bpp, &init->fb_bpp)\r\n|| __put_user(init32.front_offset, &init->front_offset)\r\n|| __put_user(init32.front_pitch, &init->front_pitch)\r\n|| __put_user(init32.back_offset, &init->back_offset)\r\n|| __put_user(init32.back_pitch, &init->back_pitch)\r\n|| __put_user(init32.depth_bpp, &init->depth_bpp)\r\n|| __put_user(init32.depth_offset, &init->depth_offset)\r\n|| __put_user(init32.depth_pitch, &init->depth_pitch)\r\n|| __put_user(init32.span_offset, &init->span_offset)\r\n|| __put_user(init32.fb_offset, &init->fb_offset)\r\n|| __put_user(init32.mmio_offset, &init->mmio_offset)\r\n|| __put_user(init32.ring_offset, &init->ring_offset)\r\n|| __put_user(init32.ring_rptr_offset, &init->ring_rptr_offset)\r\n|| __put_user(init32.buffers_offset, &init->buffers_offset)\r\n|| __put_user(init32.agp_textures_offset,\r\n&init->agp_textures_offset))\r\nreturn -EFAULT;\r\nreturn drm_ioctl(file, DRM_IOCTL_R128_INIT, (unsigned long)init);\r\n}\r\nstatic int compat_r128_depth(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\ndrm_r128_depth32_t depth32;\r\ndrm_r128_depth_t __user *depth;\r\nif (copy_from_user(&depth32, (void __user *)arg, sizeof(depth32)))\r\nreturn -EFAULT;\r\ndepth = compat_alloc_user_space(sizeof(*depth));\r\nif (!access_ok(VERIFY_WRITE, depth, sizeof(*depth))\r\n|| __put_user(depth32.func, &depth->func)\r\n|| __put_user(depth32.n, &depth->n)\r\n|| __put_user((int __user *)(unsigned long)depth32.x, &depth->x)\r\n|| __put_user((int __user *)(unsigned long)depth32.y, &depth->y)\r\n|| __put_user((unsigned int __user *)(unsigned long)depth32.buffer,\r\n&depth->buffer)\r\n|| __put_user((unsigned char __user *)(unsigned long)depth32.mask,\r\n&depth->mask))\r\nreturn -EFAULT;\r\nreturn drm_ioctl(file, DRM_IOCTL_R128_DEPTH, (unsigned long)depth);\r\n}\r\nstatic int compat_r128_stipple(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\ndrm_r128_stipple32_t stipple32;\r\ndrm_r128_stipple_t __user *stipple;\r\nif (copy_from_user(&stipple32, (void __user *)arg, sizeof(stipple32)))\r\nreturn -EFAULT;\r\nstipple = compat_alloc_user_space(sizeof(*stipple));\r\nif (!access_ok(VERIFY_WRITE, stipple, sizeof(*stipple))\r\n|| __put_user((unsigned int __user *)(unsigned long)stipple32.mask,\r\n&stipple->mask))\r\nreturn -EFAULT;\r\nreturn drm_ioctl(file, DRM_IOCTL_R128_STIPPLE, (unsigned long)stipple);\r\n}\r\nstatic int compat_r128_getparam(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\ndrm_r128_getparam32_t getparam32;\r\ndrm_r128_getparam_t __user *getparam;\r\nif (copy_from_user(&getparam32, (void __user *)arg, sizeof(getparam32)))\r\nreturn -EFAULT;\r\ngetparam = compat_alloc_user_space(sizeof(*getparam));\r\nif (!access_ok(VERIFY_WRITE, getparam, sizeof(*getparam))\r\n|| __put_user(getparam32.param, &getparam->param)\r\n|| __put_user((void __user *)(unsigned long)getparam32.value,\r\n&getparam->value))\r\nreturn -EFAULT;\r\nreturn drm_ioctl(file, DRM_IOCTL_R128_GETPARAM, (unsigned long)getparam);\r\n}\r\nlong r128_compat_ioctl(struct file *filp, unsigned int cmd, unsigned long arg)\r\n{\r\nunsigned int nr = DRM_IOCTL_NR(cmd);\r\ndrm_ioctl_compat_t *fn = NULL;\r\nint ret;\r\nif (nr < DRM_COMMAND_BASE)\r\nreturn drm_compat_ioctl(filp, cmd, arg);\r\nif (nr < DRM_COMMAND_BASE + ARRAY_SIZE(r128_compat_ioctls))\r\nfn = r128_compat_ioctls[nr - DRM_COMMAND_BASE];\r\nif (fn != NULL)\r\nret = (*fn) (filp, cmd, arg);\r\nelse\r\nret = drm_ioctl(filp, cmd, arg);\r\nreturn ret;\r\n}

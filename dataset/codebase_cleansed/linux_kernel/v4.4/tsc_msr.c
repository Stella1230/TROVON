static int match_cpu(u8 family, u8 model)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(freq_desc_tables); i++) {\r\nif ((family == freq_desc_tables[i].x86_family) &&\r\n(model == freq_desc_tables[i].x86_model))\r\nreturn i;\r\n}\r\nreturn -1;\r\n}\r\nunsigned long try_msr_calibrate_tsc(void)\r\n{\r\nu32 lo, hi, ratio, freq_id, freq;\r\nunsigned long res;\r\nint cpu_index;\r\ncpu_index = match_cpu(boot_cpu_data.x86, boot_cpu_data.x86_model);\r\nif (cpu_index < 0)\r\nreturn 0;\r\nif (freq_desc_tables[cpu_index].msr_plat) {\r\nrdmsr(MSR_PLATFORM_INFO, lo, hi);\r\nratio = (lo >> 8) & 0x1f;\r\n} else {\r\nrdmsr(MSR_IA32_PERF_STATUS, lo, hi);\r\nratio = (hi >> 8) & 0x1f;\r\n}\r\npr_info("Maximum core-clock to bus-clock ratio: 0x%x\n", ratio);\r\nif (!ratio)\r\ngoto fail;\r\nrdmsr(MSR_FSB_FREQ, lo, hi);\r\nfreq_id = lo & 0x7;\r\nfreq = id_to_freq(cpu_index, freq_id);\r\npr_info("Resolved frequency ID: %u, frequency: %u KHz\n",\r\nfreq_id, freq);\r\nif (!freq)\r\ngoto fail;\r\nres = freq * ratio;\r\npr_info("TSC runs at %lu KHz\n", res);\r\n#ifdef CONFIG_X86_LOCAL_APIC\r\nlapic_timer_frequency = (freq * 1000) / HZ;\r\npr_info("lapic_timer_frequency = %d\n", lapic_timer_frequency);\r\n#endif\r\nreturn res;\r\nfail:\r\npr_warn("Fast TSC calibration using MSR failed\n");\r\nreturn 0;\r\n}

static int set_x2apic_phys_mode(char *arg)\r\n{\r\nx2apic_phys = 1;\r\nreturn 0;\r\n}\r\nstatic bool x2apic_fadt_phys(void)\r\n{\r\n#ifdef CONFIG_ACPI\r\nif ((acpi_gbl_FADT.header.revision >= FADT2_REVISION_ID) &&\r\n(acpi_gbl_FADT.flags & ACPI_FADT_APIC_PHYSICAL)) {\r\nprintk(KERN_DEBUG "System requires x2apic physical mode\n");\r\nreturn true;\r\n}\r\n#endif\r\nreturn false;\r\n}\r\nstatic int x2apic_acpi_madt_oem_check(char *oem_id, char *oem_table_id)\r\n{\r\nreturn x2apic_enabled() && (x2apic_phys || x2apic_fadt_phys());\r\n}\r\nstatic void\r\n__x2apic_send_IPI_mask(const struct cpumask *mask, int vector, int apic_dest)\r\n{\r\nunsigned long query_cpu;\r\nunsigned long this_cpu;\r\nunsigned long flags;\r\nx2apic_wrmsr_fence();\r\nlocal_irq_save(flags);\r\nthis_cpu = smp_processor_id();\r\nfor_each_cpu(query_cpu, mask) {\r\nif (apic_dest == APIC_DEST_ALLBUT && this_cpu == query_cpu)\r\ncontinue;\r\n__x2apic_send_IPI_dest(per_cpu(x86_cpu_to_apicid, query_cpu),\r\nvector, APIC_DEST_PHYSICAL);\r\n}\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void x2apic_send_IPI_mask(const struct cpumask *mask, int vector)\r\n{\r\n__x2apic_send_IPI_mask(mask, vector, APIC_DEST_ALLINC);\r\n}\r\nstatic void\r\nx2apic_send_IPI_mask_allbutself(const struct cpumask *mask, int vector)\r\n{\r\n__x2apic_send_IPI_mask(mask, vector, APIC_DEST_ALLBUT);\r\n}\r\nstatic void x2apic_send_IPI_allbutself(int vector)\r\n{\r\n__x2apic_send_IPI_mask(cpu_online_mask, vector, APIC_DEST_ALLBUT);\r\n}\r\nstatic void x2apic_send_IPI_all(int vector)\r\n{\r\n__x2apic_send_IPI_mask(cpu_online_mask, vector, APIC_DEST_ALLINC);\r\n}\r\nstatic void init_x2apic_ldr(void)\r\n{\r\n}\r\nstatic int x2apic_phys_probe(void)\r\n{\r\nif (x2apic_mode && (x2apic_phys || x2apic_fadt_phys()))\r\nreturn 1;\r\nreturn apic == &apic_x2apic_phys;\r\n}

int st_magn_trig_set_state(struct iio_trigger *trig, bool state)\r\n{\r\nstruct iio_dev *indio_dev = iio_trigger_get_drvdata(trig);\r\nreturn st_sensors_set_dataready_irq(indio_dev, state);\r\n}\r\nstatic int st_magn_buffer_preenable(struct iio_dev *indio_dev)\r\n{\r\nreturn st_sensors_set_enable(indio_dev, true);\r\n}\r\nstatic int st_magn_buffer_postenable(struct iio_dev *indio_dev)\r\n{\r\nint err;\r\nstruct st_sensor_data *mdata = iio_priv(indio_dev);\r\nmdata->buffer_data = kmalloc(indio_dev->scan_bytes, GFP_KERNEL);\r\nif (mdata->buffer_data == NULL) {\r\nerr = -ENOMEM;\r\ngoto allocate_memory_error;\r\n}\r\nerr = iio_triggered_buffer_postenable(indio_dev);\r\nif (err < 0)\r\ngoto st_magn_buffer_postenable_error;\r\nreturn err;\r\nst_magn_buffer_postenable_error:\r\nkfree(mdata->buffer_data);\r\nallocate_memory_error:\r\nreturn err;\r\n}\r\nstatic int st_magn_buffer_predisable(struct iio_dev *indio_dev)\r\n{\r\nint err;\r\nstruct st_sensor_data *mdata = iio_priv(indio_dev);\r\nerr = iio_triggered_buffer_predisable(indio_dev);\r\nif (err < 0)\r\ngoto st_magn_buffer_predisable_error;\r\nerr = st_sensors_set_enable(indio_dev, false);\r\nst_magn_buffer_predisable_error:\r\nkfree(mdata->buffer_data);\r\nreturn err;\r\n}\r\nint st_magn_allocate_ring(struct iio_dev *indio_dev)\r\n{\r\nreturn iio_triggered_buffer_setup(indio_dev, &iio_pollfunc_store_time,\r\n&st_sensors_trigger_handler, &st_magn_buffer_setup_ops);\r\n}\r\nvoid st_magn_deallocate_ring(struct iio_dev *indio_dev)\r\n{\r\niio_triggered_buffer_cleanup(indio_dev);\r\n}

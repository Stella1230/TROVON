struct mlx5_cqe64 *mlx5e_get_cqe(struct mlx5e_cq *cq)\r\n{\r\nstruct mlx5_cqwq *wq = &cq->wq;\r\nu32 ci = mlx5_cqwq_get_ci(wq);\r\nstruct mlx5_cqe64 *cqe = mlx5_cqwq_get_wqe(wq, ci);\r\nint cqe_ownership_bit = cqe->op_own & MLX5_CQE_OWNER_MASK;\r\nint sw_ownership_val = mlx5_cqwq_get_wrap_cnt(wq) & 1;\r\nif (cqe_ownership_bit != sw_ownership_val)\r\nreturn NULL;\r\nrmb();\r\nreturn cqe;\r\n}\r\nint mlx5e_napi_poll(struct napi_struct *napi, int budget)\r\n{\r\nstruct mlx5e_channel *c = container_of(napi, struct mlx5e_channel,\r\nnapi);\r\nbool busy = false;\r\nint i;\r\nclear_bit(MLX5E_CHANNEL_NAPI_SCHED, &c->flags);\r\nfor (i = 0; i < c->num_tc; i++)\r\nbusy |= mlx5e_poll_tx_cq(&c->sq[i].cq);\r\nbusy |= mlx5e_poll_rx_cq(&c->rq.cq, budget);\r\nbusy |= mlx5e_post_rx_wqes(&c->rq);\r\nif (busy)\r\nreturn budget;\r\nnapi_complete(napi);\r\nif (test_bit(MLX5E_CHANNEL_NAPI_SCHED, &c->flags)) {\r\nnapi_schedule(napi);\r\nreturn 0;\r\n}\r\nfor (i = 0; i < c->num_tc; i++)\r\nmlx5e_cq_arm(&c->sq[i].cq);\r\nmlx5e_cq_arm(&c->rq.cq);\r\nreturn 0;\r\n}\r\nvoid mlx5e_completion_event(struct mlx5_core_cq *mcq)\r\n{\r\nstruct mlx5e_cq *cq = container_of(mcq, struct mlx5e_cq, mcq);\r\nset_bit(MLX5E_CQ_HAS_CQES, &cq->flags);\r\nset_bit(MLX5E_CHANNEL_NAPI_SCHED, &cq->channel->flags);\r\nbarrier();\r\nnapi_schedule(cq->napi);\r\n}\r\nvoid mlx5e_cq_error_event(struct mlx5_core_cq *mcq, enum mlx5_event event)\r\n{\r\nstruct mlx5e_cq *cq = container_of(mcq, struct mlx5e_cq, mcq);\r\nstruct mlx5e_channel *c = cq->channel;\r\nstruct mlx5e_priv *priv = c->priv;\r\nstruct net_device *netdev = priv->netdev;\r\nnetdev_err(netdev, "%s: cqn=0x%.6x event=0x%.2x\n",\r\n__func__, mcq->cqn, event);\r\n}

bool cxgb_fcoe_sof_eof_supported(struct adapter *adap, struct sk_buff *skb)\r\n{\r\nstruct fcoe_hdr *fcoeh = (struct fcoe_hdr *)skb_network_header(skb);\r\nu8 sof = fcoeh->fcoe_sof;\r\nu8 eof = 0;\r\nif ((sof != FC_SOF_I3) && (sof != FC_SOF_N3)) {\r\ndev_err(adap->pdev_dev, "Unsupported SOF 0x%x\n", sof);\r\nreturn false;\r\n}\r\nskb_copy_bits(skb, skb->len - 4, &eof, 1);\r\nif ((eof != FC_EOF_N) && (eof != FC_EOF_T)) {\r\ndev_err(adap->pdev_dev, "Unsupported EOF 0x%x\n", eof);\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nint cxgb_fcoe_enable(struct net_device *netdev)\r\n{\r\nstruct port_info *pi = netdev_priv(netdev);\r\nstruct adapter *adap = pi->adapter;\r\nstruct cxgb_fcoe *fcoe = &pi->fcoe;\r\nif (is_t4(adap->params.chip))\r\nreturn -EINVAL;\r\nif (!(adap->flags & FULL_INIT_DONE))\r\nreturn -EINVAL;\r\ndev_info(adap->pdev_dev, "Enabling FCoE offload features\n");\r\nnetdev->features |= NETIF_F_FCOE_CRC;\r\nnetdev->vlan_features |= NETIF_F_FCOE_CRC;\r\nnetdev->features |= NETIF_F_FCOE_MTU;\r\nnetdev->vlan_features |= NETIF_F_FCOE_MTU;\r\nnetdev_features_change(netdev);\r\nfcoe->flags |= CXGB_FCOE_ENABLED;\r\nreturn 0;\r\n}\r\nint cxgb_fcoe_disable(struct net_device *netdev)\r\n{\r\nstruct port_info *pi = netdev_priv(netdev);\r\nstruct adapter *adap = pi->adapter;\r\nstruct cxgb_fcoe *fcoe = &pi->fcoe;\r\nif (!(fcoe->flags & CXGB_FCOE_ENABLED))\r\nreturn -EINVAL;\r\ndev_info(adap->pdev_dev, "Disabling FCoE offload features\n");\r\nfcoe->flags &= ~CXGB_FCOE_ENABLED;\r\nnetdev->features &= ~NETIF_F_FCOE_CRC;\r\nnetdev->vlan_features &= ~NETIF_F_FCOE_CRC;\r\nnetdev->features &= ~NETIF_F_FCOE_MTU;\r\nnetdev->vlan_features &= ~NETIF_F_FCOE_MTU;\r\nnetdev_features_change(netdev);\r\nreturn 0;\r\n}

static void da9xxx_mask_irqs(struct i2c_client *client, const u8 regs[],\r\nunsigned int nregs)\r\n{\r\nunsigned int i;\r\ndev_info(&client->dev, "Masking %s interrupt sources\n", client->name);\r\nfor (i = 0; i < nregs; i++) {\r\nint error = i2c_smbus_write_byte_data(client, regs[i], ~0);\r\nif (error) {\r\ndev_err(&client->dev, "i2c error %d\n", error);\r\nreturn;\r\n}\r\n}\r\n}\r\nstatic int regulator_quirk_notify(struct notifier_block *nb,\r\nunsigned long action, void *data)\r\n{\r\nstruct device *dev = data;\r\nstruct i2c_client *client;\r\nu32 mon;\r\nmon = ioread32(irqc + IRQC_MONITOR);\r\ndev_dbg(dev, "%s: %ld, IRQC_MONITOR = 0x%x\n", __func__, action, mon);\r\nif (mon & REGULATOR_IRQ_MASK)\r\ngoto remove;\r\nif (action != BUS_NOTIFY_ADD_DEVICE || dev->type == &i2c_adapter_type)\r\nreturn 0;\r\nclient = to_i2c_client(dev);\r\ndev_dbg(dev, "Detected %s\n", client->name);\r\nif ((client->addr == 0x58 && !strcmp(client->name, "da9063")))\r\nda9xxx_mask_irqs(client, da9063_mask_regs,\r\nARRAY_SIZE(da9063_mask_regs));\r\nelse if (client->addr == 0x68 && !strcmp(client->name, "da9210"))\r\nda9xxx_mask_irqs(client, da9210_mask_regs,\r\nARRAY_SIZE(da9210_mask_regs));\r\nmon = ioread32(irqc + IRQC_MONITOR);\r\nif (mon & REGULATOR_IRQ_MASK)\r\ngoto remove;\r\nreturn 0;\r\nremove:\r\ndev_info(dev, "IRQ2 is not asserted, removing quirk\n");\r\nbus_unregister_notifier(&i2c_bus_type, nb);\r\niounmap(irqc);\r\nreturn 0;\r\n}\r\nstatic int __init rcar_gen2_regulator_quirk(void)\r\n{\r\nu32 mon;\r\nif (!of_machine_is_compatible("renesas,koelsch") &&\r\n!of_machine_is_compatible("renesas,lager") &&\r\n!of_machine_is_compatible("renesas,gose"))\r\nreturn -ENODEV;\r\nirqc = ioremap(IRQC_BASE, PAGE_SIZE);\r\nif (!irqc)\r\nreturn -ENOMEM;\r\nmon = ioread32(irqc + IRQC_MONITOR);\r\nif (mon & REGULATOR_IRQ_MASK) {\r\npr_debug("%s: IRQ2 is not asserted, not installing quirk\n",\r\n__func__);\r\niounmap(irqc);\r\nreturn 0;\r\n}\r\npr_info("IRQ2 is asserted, installing da9063/da9210 regulator quirk\n");\r\nbus_register_notifier(&i2c_bus_type, &regulator_quirk_nb);\r\nreturn 0;\r\n}

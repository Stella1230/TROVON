unsigned int pxa25x_get_clk_frequency_khz(int info)\r\n{\r\nstruct clk *clk;\r\nunsigned long clks[5];\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(get_freq_khz); i++) {\r\nclk = clk_get(NULL, get_freq_khz[i]);\r\nif (IS_ERR(clk)) {\r\nclks[i] = 0;\r\n} else {\r\nclks[i] = clk_get_rate(clk);\r\nclk_put(clk);\r\n}\r\n}\r\nif (info) {\r\npr_info("Run Mode clock: %ld.%02ldMHz\n",\r\nclks[1] / 1000000, (clks[1] % 1000000) / 10000);\r\npr_info("Turbo Mode clock: %ld.%02ldMHz\n",\r\nclks[2] / 1000000, (clks[2] % 1000000) / 10000);\r\npr_info("Memory clock: %ld.%02ldMHz\n",\r\nclks[3] / 1000000, (clks[3] % 1000000) / 10000);\r\n}\r\nreturn (unsigned int)clks[0] / KHz;\r\n}\r\nstatic unsigned long clk_pxa25x_memory_get_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nunsigned long cccr = CCCR;\r\nunsigned int m = M_clk_mult[(cccr >> 5) & 0x03];\r\nreturn parent_rate / m;\r\n}\r\nstatic u8 clk_pxa25x_core_get_parent(struct clk_hw *hw)\r\n{\r\nunsigned long clkcfg;\r\nunsigned int t;\r\nasm("mrc\tp14, 0, %0, c6, c0, 0" : "=r" (clkcfg));\r\nt = clkcfg & (1 << 0);\r\nif (t)\r\nreturn PXA_CORE_TURBO;\r\nreturn PXA_CORE_RUN;\r\n}\r\nstatic unsigned long clk_pxa25x_core_get_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nreturn parent_rate;\r\n}\r\nstatic unsigned long clk_pxa25x_run_get_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nunsigned long cccr = CCCR;\r\nunsigned int n2 = N2_clk_mult[(cccr >> 7) & 0x07];\r\nreturn (parent_rate / n2) * 2;\r\n}\r\nstatic unsigned long clk_pxa25x_cpll_get_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nunsigned long clkcfg, cccr = CCCR;\r\nunsigned int l, m, n2, t;\r\nasm("mrc\tp14, 0, %0, c6, c0, 0" : "=r" (clkcfg));\r\nt = clkcfg & (1 << 0);\r\nl = L_clk_mult[(cccr >> 0) & 0x1f];\r\nm = M_clk_mult[(cccr >> 5) & 0x03];\r\nn2 = N2_clk_mult[(cccr >> 7) & 0x07];\r\nif (t)\r\nreturn m * l * n2 * parent_rate / 2;\r\nreturn m * l * parent_rate;\r\n}\r\nstatic void __init pxa25x_register_core(void)\r\n{\r\nclk_register_clk_pxa25x_cpll();\r\nclk_register_clk_pxa25x_run();\r\nclkdev_pxa_register(CLK_CORE, "core", NULL,\r\nclk_register_clk_pxa25x_core());\r\n}\r\nstatic void __init pxa25x_register_plls(void)\r\n{\r\nclk_register_fixed_rate(NULL, "osc_3_6864mhz", NULL,\r\nCLK_GET_RATE_NOCACHE | CLK_IS_ROOT,\r\n3686400);\r\nclk_register_fixed_rate(NULL, "osc_32_768khz", NULL,\r\nCLK_GET_RATE_NOCACHE | CLK_IS_ROOT,\r\n32768);\r\nclk_register_fixed_rate(NULL, "clk_dummy", NULL, CLK_IS_ROOT, 0);\r\nclk_register_fixed_factor(NULL, "ppll_95_85mhz", "osc_3_6864mhz",\r\n0, 26, 1);\r\nclk_register_fixed_factor(NULL, "ppll_147_46mhz", "osc_3_6864mhz",\r\n0, 40, 1);\r\n}\r\nstatic void __init pxa25x_base_clocks_init(void)\r\n{\r\npxa25x_register_plls();\r\npxa25x_register_core();\r\nclk_register_clk_pxa25x_memory();\r\n}\r\nstatic void __init pxa25x_dummy_clocks_init(void)\r\n{\r\nstruct clk *clk;\r\nstruct dummy_clk *d;\r\nconst char *name;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(dummy_clks); i++) {\r\nd = &dummy_clks[i];\r\nname = d->dev_id ? d->dev_id : d->con_id;\r\nclk = clk_register_fixed_factor(NULL, name, d->parent, 0, 1, 1);\r\nclk_register_clkdev(clk, d->con_id, d->dev_id);\r\n}\r\n}\r\nint __init pxa25x_clocks_init(void)\r\n{\r\npxa25x_base_clocks_init();\r\npxa25x_dummy_clocks_init();\r\nreturn clk_pxa_cken_init(pxa25x_clocks, ARRAY_SIZE(pxa25x_clocks));\r\n}\r\nstatic void __init pxa25x_dt_clocks_init(struct device_node *np)\r\n{\r\npxa25x_clocks_init();\r\nclk_pxa_dt_common_init(np);\r\n}

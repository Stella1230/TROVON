int digital_in_iso_dep_pull_sod(struct nfc_digital_dev *ddev,\r\nstruct sk_buff *skb)\r\n{\r\nu8 pcb;\r\nu8 block_type;\r\nif (skb->len < 1)\r\nreturn -EIO;\r\npcb = *skb->data;\r\nblock_type = DIGITAL_ISO_DEP_PCB_TYPE(pcb);\r\nif (block_type != DIGITAL_ISO_DEP_I_BLOCK) {\r\npr_err("ISO_DEP R-block and S-block not supported\n");\r\nreturn -EIO;\r\n}\r\nif (DIGITAL_ISO_DEP_BLOCK_HAS_DID(pcb)) {\r\npr_err("DID field in ISO_DEP PCB not supported\n");\r\nreturn -EIO;\r\n}\r\nskb_pull(skb, 1);\r\nreturn 0;\r\n}\r\nint digital_in_iso_dep_push_sod(struct nfc_digital_dev *ddev,\r\nstruct sk_buff *skb)\r\n{\r\nif (skb->len + 3 > ddev->target_fsc)\r\nreturn -EIO;\r\nskb_push(skb, 1);\r\n*skb->data = DIGITAL_ISO_DEP_I_PCB | ddev->curr_nfc_dep_pni;\r\nddev->curr_nfc_dep_pni =\r\nDIGITAL_ISO_DEP_PNI(ddev->curr_nfc_dep_pni + 1);\r\nreturn 0;\r\n}\r\nstatic void digital_in_recv_ats(struct nfc_digital_dev *ddev, void *arg,\r\nstruct sk_buff *resp)\r\n{\r\nstruct nfc_target *target = arg;\r\nu8 fsdi;\r\nint rc;\r\nif (IS_ERR(resp)) {\r\nrc = PTR_ERR(resp);\r\nresp = NULL;\r\ngoto exit;\r\n}\r\nif (resp->len < 2) {\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nfsdi = DIGITAL_ATS_FSCI(resp->data[1]);\r\nif (fsdi >= 8)\r\nddev->target_fsc = DIGITAL_ATS_MAX_FSC;\r\nelse\r\nddev->target_fsc = digital_ats_fsc[fsdi];\r\nddev->curr_nfc_dep_pni = 0;\r\nrc = digital_target_found(ddev, target, NFC_PROTO_ISO14443);\r\nexit:\r\ndev_kfree_skb(resp);\r\nkfree(target);\r\nif (rc)\r\ndigital_poll_next_tech(ddev);\r\n}\r\nstatic int digital_in_send_rats(struct nfc_digital_dev *ddev,\r\nstruct nfc_target *target)\r\n{\r\nint rc;\r\nstruct sk_buff *skb;\r\nskb = digital_skb_alloc(ddev, 2);\r\nif (!skb)\r\nreturn -ENOMEM;\r\n*skb_put(skb, 1) = DIGITAL_RATS_BYTE1;\r\n*skb_put(skb, 1) = DIGITAL_RATS_PARAM;\r\nrc = digital_in_send_cmd(ddev, skb, 30, digital_in_recv_ats,\r\ntarget);\r\nif (rc)\r\nkfree_skb(skb);\r\nreturn rc;\r\n}\r\nstatic void digital_in_recv_sel_res(struct nfc_digital_dev *ddev, void *arg,\r\nstruct sk_buff *resp)\r\n{\r\nstruct nfc_target *target = arg;\r\nint rc;\r\nu8 sel_res;\r\nu8 nfc_proto;\r\nif (IS_ERR(resp)) {\r\nrc = PTR_ERR(resp);\r\nresp = NULL;\r\ngoto exit;\r\n}\r\nif (!DIGITAL_DRV_CAPS_IN_CRC(ddev)) {\r\nrc = digital_skb_check_crc_a(resp);\r\nif (rc) {\r\nPROTOCOL_ERR("4.4.1.3");\r\ngoto exit;\r\n}\r\n}\r\nif (!resp->len) {\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nsel_res = resp->data[0];\r\nif (!DIGITAL_SEL_RES_NFCID1_COMPLETE(sel_res)) {\r\nrc = digital_in_send_sdd_req(ddev, target);\r\nif (rc)\r\ngoto exit;\r\ngoto exit_free_skb;\r\n}\r\ntarget->sel_res = sel_res;\r\nif (DIGITAL_SEL_RES_IS_T2T(sel_res)) {\r\nnfc_proto = NFC_PROTO_MIFARE;\r\n} else if (DIGITAL_SEL_RES_IS_NFC_DEP(sel_res)) {\r\nnfc_proto = NFC_PROTO_NFC_DEP;\r\n} else if (DIGITAL_SEL_RES_IS_T4T(sel_res)) {\r\nrc = digital_in_send_rats(ddev, target);\r\nif (rc)\r\ngoto exit;\r\ngoto exit_free_skb;\r\n} else {\r\nrc = -EOPNOTSUPP;\r\ngoto exit;\r\n}\r\nrc = digital_target_found(ddev, target, nfc_proto);\r\nexit:\r\nkfree(target);\r\nexit_free_skb:\r\ndev_kfree_skb(resp);\r\nif (rc)\r\ndigital_poll_next_tech(ddev);\r\n}\r\nstatic int digital_in_send_sel_req(struct nfc_digital_dev *ddev,\r\nstruct nfc_target *target,\r\nstruct digital_sdd_res *sdd_res)\r\n{\r\nstruct sk_buff *skb;\r\nstruct digital_sel_req *sel_req;\r\nu8 sel_cmd;\r\nint rc;\r\nskb = digital_skb_alloc(ddev, sizeof(struct digital_sel_req));\r\nif (!skb)\r\nreturn -ENOMEM;\r\nskb_put(skb, sizeof(struct digital_sel_req));\r\nsel_req = (struct digital_sel_req *)skb->data;\r\nif (target->nfcid1_len <= 4)\r\nsel_cmd = DIGITAL_CMD_SEL_REQ_CL1;\r\nelse if (target->nfcid1_len < 10)\r\nsel_cmd = DIGITAL_CMD_SEL_REQ_CL2;\r\nelse\r\nsel_cmd = DIGITAL_CMD_SEL_REQ_CL3;\r\nsel_req->sel_cmd = sel_cmd;\r\nsel_req->b2 = 0x70;\r\nmemcpy(sel_req->nfcid1, sdd_res->nfcid1, 4);\r\nsel_req->bcc = sdd_res->bcc;\r\nif (DIGITAL_DRV_CAPS_IN_CRC(ddev)) {\r\nrc = digital_in_configure_hw(ddev, NFC_DIGITAL_CONFIG_FRAMING,\r\nNFC_DIGITAL_FRAMING_NFCA_STANDARD_WITH_CRC_A);\r\nif (rc)\r\ngoto exit;\r\n} else {\r\ndigital_skb_add_crc_a(skb);\r\n}\r\nrc = digital_in_send_cmd(ddev, skb, 30, digital_in_recv_sel_res,\r\ntarget);\r\nexit:\r\nif (rc)\r\nkfree_skb(skb);\r\nreturn rc;\r\n}\r\nstatic void digital_in_recv_sdd_res(struct nfc_digital_dev *ddev, void *arg,\r\nstruct sk_buff *resp)\r\n{\r\nstruct nfc_target *target = arg;\r\nstruct digital_sdd_res *sdd_res;\r\nint rc;\r\nu8 offset, size;\r\nu8 i, bcc;\r\nif (IS_ERR(resp)) {\r\nrc = PTR_ERR(resp);\r\nresp = NULL;\r\ngoto exit;\r\n}\r\nif (resp->len < DIGITAL_SDD_RES_LEN) {\r\nPROTOCOL_ERR("4.7.2.8");\r\nrc = -EINVAL;\r\ngoto exit;\r\n}\r\nsdd_res = (struct digital_sdd_res *)resp->data;\r\nfor (i = 0, bcc = 0; i < 4; i++)\r\nbcc ^= sdd_res->nfcid1[i];\r\nif (bcc != sdd_res->bcc) {\r\nPROTOCOL_ERR("4.7.2.6");\r\nrc = -EINVAL;\r\ngoto exit;\r\n}\r\nif (sdd_res->nfcid1[0] == DIGITAL_SDD_RES_CT) {\r\noffset = 1;\r\nsize = 3;\r\n} else {\r\noffset = 0;\r\nsize = 4;\r\n}\r\nmemcpy(target->nfcid1 + target->nfcid1_len, sdd_res->nfcid1 + offset,\r\nsize);\r\ntarget->nfcid1_len += size;\r\nrc = digital_in_send_sel_req(ddev, target, sdd_res);\r\nexit:\r\ndev_kfree_skb(resp);\r\nif (rc) {\r\nkfree(target);\r\ndigital_poll_next_tech(ddev);\r\n}\r\n}\r\nstatic int digital_in_send_sdd_req(struct nfc_digital_dev *ddev,\r\nstruct nfc_target *target)\r\n{\r\nint rc;\r\nstruct sk_buff *skb;\r\nu8 sel_cmd;\r\nrc = digital_in_configure_hw(ddev, NFC_DIGITAL_CONFIG_FRAMING,\r\nNFC_DIGITAL_FRAMING_NFCA_STANDARD);\r\nif (rc)\r\nreturn rc;\r\nskb = digital_skb_alloc(ddev, 2);\r\nif (!skb)\r\nreturn -ENOMEM;\r\nif (target->nfcid1_len == 0)\r\nsel_cmd = DIGITAL_CMD_SEL_REQ_CL1;\r\nelse if (target->nfcid1_len == 3)\r\nsel_cmd = DIGITAL_CMD_SEL_REQ_CL2;\r\nelse\r\nsel_cmd = DIGITAL_CMD_SEL_REQ_CL3;\r\n*skb_put(skb, sizeof(u8)) = sel_cmd;\r\n*skb_put(skb, sizeof(u8)) = DIGITAL_SDD_REQ_SEL_PAR;\r\nreturn digital_in_send_cmd(ddev, skb, 30, digital_in_recv_sdd_res,\r\ntarget);\r\n}\r\nstatic void digital_in_recv_sens_res(struct nfc_digital_dev *ddev, void *arg,\r\nstruct sk_buff *resp)\r\n{\r\nstruct nfc_target *target = NULL;\r\nint rc;\r\nif (IS_ERR(resp)) {\r\nrc = PTR_ERR(resp);\r\nresp = NULL;\r\ngoto exit;\r\n}\r\nif (resp->len < sizeof(u16)) {\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\ntarget = kzalloc(sizeof(struct nfc_target), GFP_KERNEL);\r\nif (!target) {\r\nrc = -ENOMEM;\r\ngoto exit;\r\n}\r\ntarget->sens_res = __le16_to_cpu(*(__le16 *)resp->data);\r\nif (!DIGITAL_SENS_RES_IS_VALID(target->sens_res)) {\r\nPROTOCOL_ERR("4.6.3.3");\r\nrc = -EINVAL;\r\ngoto exit;\r\n}\r\nif (DIGITAL_SENS_RES_IS_T1T(target->sens_res))\r\nrc = digital_target_found(ddev, target, NFC_PROTO_JEWEL);\r\nelse\r\nrc = digital_in_send_sdd_req(ddev, target);\r\nexit:\r\ndev_kfree_skb(resp);\r\nif (rc) {\r\nkfree(target);\r\ndigital_poll_next_tech(ddev);\r\n}\r\n}\r\nint digital_in_send_sens_req(struct nfc_digital_dev *ddev, u8 rf_tech)\r\n{\r\nstruct sk_buff *skb;\r\nint rc;\r\nrc = digital_in_configure_hw(ddev, NFC_DIGITAL_CONFIG_RF_TECH,\r\nNFC_DIGITAL_RF_TECH_106A);\r\nif (rc)\r\nreturn rc;\r\nrc = digital_in_configure_hw(ddev, NFC_DIGITAL_CONFIG_FRAMING,\r\nNFC_DIGITAL_FRAMING_NFCA_SHORT);\r\nif (rc)\r\nreturn rc;\r\nskb = digital_skb_alloc(ddev, 1);\r\nif (!skb)\r\nreturn -ENOMEM;\r\n*skb_put(skb, sizeof(u8)) = DIGITAL_CMD_SENS_REQ;\r\nrc = digital_in_send_cmd(ddev, skb, 30, digital_in_recv_sens_res, NULL);\r\nif (rc)\r\nkfree_skb(skb);\r\nreturn rc;\r\n}\r\nint digital_in_recv_mifare_res(struct sk_buff *resp)\r\n{\r\nif (resp->len == DIGITAL_MIFARE_READ_RES_LEN + DIGITAL_CRC_LEN) {\r\nif (digital_skb_check_crc_a(resp)) {\r\nPROTOCOL_ERR("9.4.1.2");\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nif (resp->len == 1 && resp->data[0] == DIGITAL_MIFARE_ACK_RES) {\r\nresp->data[0] = 0;\r\nreturn 0;\r\n}\r\nreturn -EIO;\r\n}\r\nstatic void digital_in_recv_attrib_res(struct nfc_digital_dev *ddev, void *arg,\r\nstruct sk_buff *resp)\r\n{\r\nstruct nfc_target *target = arg;\r\nstruct digital_attrib_res *attrib_res;\r\nint rc;\r\nif (IS_ERR(resp)) {\r\nrc = PTR_ERR(resp);\r\nresp = NULL;\r\ngoto exit;\r\n}\r\nif (resp->len < sizeof(*attrib_res)) {\r\nPROTOCOL_ERR("12.6.2");\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nattrib_res = (struct digital_attrib_res *)resp->data;\r\nif (attrib_res->mbli_did & 0x0f) {\r\nPROTOCOL_ERR("12.6.2.1");\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nrc = digital_target_found(ddev, target, NFC_PROTO_ISO14443_B);\r\nexit:\r\ndev_kfree_skb(resp);\r\nkfree(target);\r\nif (rc)\r\ndigital_poll_next_tech(ddev);\r\n}\r\nstatic int digital_in_send_attrib_req(struct nfc_digital_dev *ddev,\r\nstruct nfc_target *target,\r\nstruct digital_sensb_res *sensb_res)\r\n{\r\nstruct digital_attrib_req *attrib_req;\r\nstruct sk_buff *skb;\r\nint rc;\r\nskb = digital_skb_alloc(ddev, sizeof(*attrib_req));\r\nif (!skb)\r\nreturn -ENOMEM;\r\nattrib_req = (struct digital_attrib_req *)skb_put(skb,\r\nsizeof(*attrib_req));\r\nattrib_req->cmd = DIGITAL_CMD_ATTRIB_REQ;\r\nmemcpy(attrib_req->nfcid0, sensb_res->nfcid0,\r\nsizeof(attrib_req->nfcid0));\r\nattrib_req->param1 = DIGITAL_ATTRIB_P1_TR0_DEFAULT |\r\nDIGITAL_ATTRIB_P1_TR1_DEFAULT;\r\nattrib_req->param2 = DIGITAL_ATTRIB_P2_LISTEN_POLL_1 |\r\nDIGITAL_ATTRIB_P2_POLL_LISTEN_1 |\r\nDIGITAL_ATTRIB_P2_MAX_FRAME_256;\r\nattrib_req->param3 = sensb_res->proto_info[1] & 0x07;\r\nattrib_req->param4 = DIGITAL_ATTRIB_P4_DID(0);\r\nrc = digital_in_send_cmd(ddev, skb, 30, digital_in_recv_attrib_res,\r\ntarget);\r\nif (rc)\r\nkfree_skb(skb);\r\nreturn rc;\r\n}\r\nstatic void digital_in_recv_sensb_res(struct nfc_digital_dev *ddev, void *arg,\r\nstruct sk_buff *resp)\r\n{\r\nstruct nfc_target *target = NULL;\r\nstruct digital_sensb_res *sensb_res;\r\nu8 fsci;\r\nint rc;\r\nif (IS_ERR(resp)) {\r\nrc = PTR_ERR(resp);\r\nresp = NULL;\r\ngoto exit;\r\n}\r\nif (resp->len != sizeof(*sensb_res)) {\r\nPROTOCOL_ERR("5.6.2.1");\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nsensb_res = (struct digital_sensb_res *)resp->data;\r\nif (sensb_res->cmd != DIGITAL_CMD_SENSB_RES) {\r\nPROTOCOL_ERR("5.6.2");\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nif (!(sensb_res->proto_info[1] & BIT(0))) {\r\nPROTOCOL_ERR("5.6.2.12");\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nif (sensb_res->proto_info[1] & BIT(3)) {\r\nPROTOCOL_ERR("5.6.2.16");\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nfsci = DIGITAL_SENSB_FSCI(sensb_res->proto_info[1]);\r\nif (fsci >= 8)\r\nddev->target_fsc = DIGITAL_ATS_MAX_FSC;\r\nelse\r\nddev->target_fsc = digital_ats_fsc[fsci];\r\ntarget = kzalloc(sizeof(struct nfc_target), GFP_KERNEL);\r\nif (!target) {\r\nrc = -ENOMEM;\r\ngoto exit;\r\n}\r\nrc = digital_in_send_attrib_req(ddev, target, sensb_res);\r\nexit:\r\ndev_kfree_skb(resp);\r\nif (rc) {\r\nkfree(target);\r\ndigital_poll_next_tech(ddev);\r\n}\r\n}\r\nint digital_in_send_sensb_req(struct nfc_digital_dev *ddev, u8 rf_tech)\r\n{\r\nstruct digital_sensb_req *sensb_req;\r\nstruct sk_buff *skb;\r\nint rc;\r\nrc = digital_in_configure_hw(ddev, NFC_DIGITAL_CONFIG_RF_TECH,\r\nNFC_DIGITAL_RF_TECH_106B);\r\nif (rc)\r\nreturn rc;\r\nrc = digital_in_configure_hw(ddev, NFC_DIGITAL_CONFIG_FRAMING,\r\nNFC_DIGITAL_FRAMING_NFCB);\r\nif (rc)\r\nreturn rc;\r\nskb = digital_skb_alloc(ddev, sizeof(*sensb_req));\r\nif (!skb)\r\nreturn -ENOMEM;\r\nsensb_req = (struct digital_sensb_req *)skb_put(skb,\r\nsizeof(*sensb_req));\r\nsensb_req->cmd = DIGITAL_CMD_SENSB_REQ;\r\nsensb_req->afi = 0x00;\r\nsensb_req->param = DIGITAL_SENSB_N(0);\r\nrc = digital_in_send_cmd(ddev, skb, 30, digital_in_recv_sensb_res,\r\nNULL);\r\nif (rc)\r\nkfree_skb(skb);\r\nreturn rc;\r\n}\r\nstatic void digital_in_recv_sensf_res(struct nfc_digital_dev *ddev, void *arg,\r\nstruct sk_buff *resp)\r\n{\r\nint rc;\r\nu8 proto;\r\nstruct nfc_target target;\r\nstruct digital_sensf_res *sensf_res;\r\nif (IS_ERR(resp)) {\r\nrc = PTR_ERR(resp);\r\nresp = NULL;\r\ngoto exit;\r\n}\r\nif (resp->len < DIGITAL_SENSF_RES_MIN_LENGTH) {\r\nrc = -EIO;\r\ngoto exit;\r\n}\r\nif (!DIGITAL_DRV_CAPS_IN_CRC(ddev)) {\r\nrc = digital_skb_check_crc_f(resp);\r\nif (rc) {\r\nPROTOCOL_ERR("6.4.1.8");\r\ngoto exit;\r\n}\r\n}\r\nskb_pull(resp, 1);\r\nmemset(&target, 0, sizeof(struct nfc_target));\r\nsensf_res = (struct digital_sensf_res *)resp->data;\r\nmemcpy(target.sensf_res, sensf_res, resp->len);\r\ntarget.sensf_res_len = resp->len;\r\nmemcpy(target.nfcid2, sensf_res->nfcid2, NFC_NFCID2_MAXSIZE);\r\ntarget.nfcid2_len = NFC_NFCID2_MAXSIZE;\r\nif (target.nfcid2[0] == DIGITAL_SENSF_NFCID2_NFC_DEP_B1 &&\r\ntarget.nfcid2[1] == DIGITAL_SENSF_NFCID2_NFC_DEP_B2)\r\nproto = NFC_PROTO_NFC_DEP;\r\nelse\r\nproto = NFC_PROTO_FELICA;\r\nrc = digital_target_found(ddev, &target, proto);\r\nexit:\r\ndev_kfree_skb(resp);\r\nif (rc)\r\ndigital_poll_next_tech(ddev);\r\n}\r\nint digital_in_send_sensf_req(struct nfc_digital_dev *ddev, u8 rf_tech)\r\n{\r\nstruct digital_sensf_req *sensf_req;\r\nstruct sk_buff *skb;\r\nint rc;\r\nu8 size;\r\nrc = digital_in_configure_hw(ddev, NFC_DIGITAL_CONFIG_RF_TECH, rf_tech);\r\nif (rc)\r\nreturn rc;\r\nrc = digital_in_configure_hw(ddev, NFC_DIGITAL_CONFIG_FRAMING,\r\nNFC_DIGITAL_FRAMING_NFCF);\r\nif (rc)\r\nreturn rc;\r\nsize = sizeof(struct digital_sensf_req);\r\nskb = digital_skb_alloc(ddev, size);\r\nif (!skb)\r\nreturn -ENOMEM;\r\nskb_put(skb, size);\r\nsensf_req = (struct digital_sensf_req *)skb->data;\r\nsensf_req->cmd = DIGITAL_CMD_SENSF_REQ;\r\nsensf_req->sc1 = 0xFF;\r\nsensf_req->sc2 = 0xFF;\r\nsensf_req->rc = 0;\r\nsensf_req->tsn = 0;\r\n*skb_push(skb, 1) = size + 1;\r\nif (!DIGITAL_DRV_CAPS_IN_CRC(ddev))\r\ndigital_skb_add_crc_f(skb);\r\nrc = digital_in_send_cmd(ddev, skb, 30, digital_in_recv_sensf_res,\r\nNULL);\r\nif (rc)\r\nkfree_skb(skb);\r\nreturn rc;\r\n}\r\nstatic void digital_in_recv_iso15693_inv_res(struct nfc_digital_dev *ddev,\r\nvoid *arg, struct sk_buff *resp)\r\n{\r\nstruct digital_iso15693_inv_res *res;\r\nstruct nfc_target *target = NULL;\r\nint rc;\r\nif (IS_ERR(resp)) {\r\nrc = PTR_ERR(resp);\r\nresp = NULL;\r\ngoto out_free_skb;\r\n}\r\nif (resp->len != sizeof(*res)) {\r\nrc = -EIO;\r\ngoto out_free_skb;\r\n}\r\nres = (struct digital_iso15693_inv_res *)resp->data;\r\nif (!DIGITAL_ISO15693_RES_IS_VALID(res->flags)) {\r\nPROTOCOL_ERR("ISO15693 - 10.3.1");\r\nrc = -EINVAL;\r\ngoto out_free_skb;\r\n}\r\ntarget = kzalloc(sizeof(*target), GFP_KERNEL);\r\nif (!target) {\r\nrc = -ENOMEM;\r\ngoto out_free_skb;\r\n}\r\ntarget->is_iso15693 = 1;\r\ntarget->iso15693_dsfid = res->dsfid;\r\nmemcpy(target->iso15693_uid, &res->uid, sizeof(target->iso15693_uid));\r\nrc = digital_target_found(ddev, target, NFC_PROTO_ISO15693);\r\nkfree(target);\r\nout_free_skb:\r\ndev_kfree_skb(resp);\r\nif (rc)\r\ndigital_poll_next_tech(ddev);\r\n}\r\nint digital_in_send_iso15693_inv_req(struct nfc_digital_dev *ddev, u8 rf_tech)\r\n{\r\nstruct digital_iso15693_inv_req *req;\r\nstruct sk_buff *skb;\r\nint rc;\r\nrc = digital_in_configure_hw(ddev, NFC_DIGITAL_CONFIG_RF_TECH,\r\nNFC_DIGITAL_RF_TECH_ISO15693);\r\nif (rc)\r\nreturn rc;\r\nrc = digital_in_configure_hw(ddev, NFC_DIGITAL_CONFIG_FRAMING,\r\nNFC_DIGITAL_FRAMING_ISO15693_INVENTORY);\r\nif (rc)\r\nreturn rc;\r\nskb = digital_skb_alloc(ddev, sizeof(*req));\r\nif (!skb)\r\nreturn -ENOMEM;\r\nskb_put(skb, sizeof(*req) - sizeof(req->mask));\r\nreq = (struct digital_iso15693_inv_req *)skb->data;\r\nreq->flags = DIGITAL_ISO15693_REQ_FLAG_DATA_RATE |\r\nDIGITAL_ISO15693_REQ_FLAG_INVENTORY |\r\nDIGITAL_ISO15693_REQ_FLAG_NB_SLOTS;\r\nreq->cmd = DIGITAL_CMD_ISO15693_INVENTORY_REQ;\r\nreq->mask_len = 0;\r\nrc = digital_in_send_cmd(ddev, skb, 30,\r\ndigital_in_recv_iso15693_inv_res, NULL);\r\nif (rc)\r\nkfree_skb(skb);\r\nreturn rc;\r\n}\r\nstatic int digital_tg_send_sel_res(struct nfc_digital_dev *ddev)\r\n{\r\nstruct sk_buff *skb;\r\nint rc;\r\nskb = digital_skb_alloc(ddev, 1);\r\nif (!skb)\r\nreturn -ENOMEM;\r\n*skb_put(skb, 1) = DIGITAL_SEL_RES_NFC_DEP;\r\nif (!DIGITAL_DRV_CAPS_TG_CRC(ddev))\r\ndigital_skb_add_crc_a(skb);\r\nrc = digital_tg_configure_hw(ddev, NFC_DIGITAL_CONFIG_FRAMING,\r\nNFC_DIGITAL_FRAMING_NFCA_ANTICOL_COMPLETE);\r\nif (rc) {\r\nkfree_skb(skb);\r\nreturn rc;\r\n}\r\nrc = digital_tg_send_cmd(ddev, skb, 300, digital_tg_recv_atr_req,\r\nNULL);\r\nif (rc)\r\nkfree_skb(skb);\r\nreturn rc;\r\n}\r\nstatic void digital_tg_recv_sel_req(struct nfc_digital_dev *ddev, void *arg,\r\nstruct sk_buff *resp)\r\n{\r\nint rc;\r\nif (IS_ERR(resp)) {\r\nrc = PTR_ERR(resp);\r\nresp = NULL;\r\ngoto exit;\r\n}\r\nif (!DIGITAL_DRV_CAPS_TG_CRC(ddev)) {\r\nrc = digital_skb_check_crc_a(resp);\r\nif (rc) {\r\nPROTOCOL_ERR("4.4.1.3");\r\ngoto exit;\r\n}\r\n}\r\nrc = digital_tg_send_sel_res(ddev);\r\nexit:\r\nif (rc)\r\ndigital_poll_next_tech(ddev);\r\ndev_kfree_skb(resp);\r\n}\r\nstatic int digital_tg_send_sdd_res(struct nfc_digital_dev *ddev)\r\n{\r\nstruct sk_buff *skb;\r\nstruct digital_sdd_res *sdd_res;\r\nint rc, i;\r\nskb = digital_skb_alloc(ddev, sizeof(struct digital_sdd_res));\r\nif (!skb)\r\nreturn -ENOMEM;\r\nskb_put(skb, sizeof(struct digital_sdd_res));\r\nsdd_res = (struct digital_sdd_res *)skb->data;\r\nsdd_res->nfcid1[0] = 0x08;\r\nget_random_bytes(sdd_res->nfcid1 + 1, 3);\r\nsdd_res->bcc = 0;\r\nfor (i = 0; i < 4; i++)\r\nsdd_res->bcc ^= sdd_res->nfcid1[i];\r\nrc = digital_tg_configure_hw(ddev, NFC_DIGITAL_CONFIG_FRAMING,\r\nNFC_DIGITAL_FRAMING_NFCA_STANDARD_WITH_CRC_A);\r\nif (rc) {\r\nkfree_skb(skb);\r\nreturn rc;\r\n}\r\nrc = digital_tg_send_cmd(ddev, skb, 300, digital_tg_recv_sel_req,\r\nNULL);\r\nif (rc)\r\nkfree_skb(skb);\r\nreturn rc;\r\n}\r\nstatic void digital_tg_recv_sdd_req(struct nfc_digital_dev *ddev, void *arg,\r\nstruct sk_buff *resp)\r\n{\r\nu8 *sdd_req;\r\nint rc;\r\nif (IS_ERR(resp)) {\r\nrc = PTR_ERR(resp);\r\nresp = NULL;\r\ngoto exit;\r\n}\r\nsdd_req = resp->data;\r\nif (resp->len < 2 || sdd_req[0] != DIGITAL_CMD_SEL_REQ_CL1 ||\r\nsdd_req[1] != DIGITAL_SDD_REQ_SEL_PAR) {\r\nrc = -EINVAL;\r\ngoto exit;\r\n}\r\nrc = digital_tg_send_sdd_res(ddev);\r\nexit:\r\nif (rc)\r\ndigital_poll_next_tech(ddev);\r\ndev_kfree_skb(resp);\r\n}\r\nstatic int digital_tg_send_sens_res(struct nfc_digital_dev *ddev)\r\n{\r\nstruct sk_buff *skb;\r\nu8 *sens_res;\r\nint rc;\r\nskb = digital_skb_alloc(ddev, 2);\r\nif (!skb)\r\nreturn -ENOMEM;\r\nsens_res = skb_put(skb, 2);\r\nsens_res[0] = (DIGITAL_SENS_RES_NFC_DEP >> 8) & 0xFF;\r\nsens_res[1] = DIGITAL_SENS_RES_NFC_DEP & 0xFF;\r\nrc = digital_tg_configure_hw(ddev, NFC_DIGITAL_CONFIG_FRAMING,\r\nNFC_DIGITAL_FRAMING_NFCA_STANDARD);\r\nif (rc) {\r\nkfree_skb(skb);\r\nreturn rc;\r\n}\r\nrc = digital_tg_send_cmd(ddev, skb, 300, digital_tg_recv_sdd_req,\r\nNULL);\r\nif (rc)\r\nkfree_skb(skb);\r\nreturn rc;\r\n}\r\nvoid digital_tg_recv_sens_req(struct nfc_digital_dev *ddev, void *arg,\r\nstruct sk_buff *resp)\r\n{\r\nu8 sens_req;\r\nint rc;\r\nif (IS_ERR(resp)) {\r\nrc = PTR_ERR(resp);\r\nresp = NULL;\r\ngoto exit;\r\n}\r\nsens_req = resp->data[0];\r\nif (!resp->len || (sens_req != DIGITAL_CMD_SENS_REQ &&\r\nsens_req != DIGITAL_CMD_ALL_REQ)) {\r\nrc = -EINVAL;\r\ngoto exit;\r\n}\r\nrc = digital_tg_send_sens_res(ddev);\r\nexit:\r\nif (rc)\r\ndigital_poll_next_tech(ddev);\r\ndev_kfree_skb(resp);\r\n}\r\nstatic void digital_tg_recv_atr_or_sensf_req(struct nfc_digital_dev *ddev,\r\nvoid *arg, struct sk_buff *resp)\r\n{\r\nif (!IS_ERR(resp) && (resp->len >= 2) &&\r\n(resp->data[1] == DIGITAL_CMD_SENSF_REQ))\r\ndigital_tg_recv_sensf_req(ddev, arg, resp);\r\nelse\r\ndigital_tg_recv_atr_req(ddev, arg, resp);\r\nreturn;\r\n}\r\nstatic int digital_tg_send_sensf_res(struct nfc_digital_dev *ddev,\r\nstruct digital_sensf_req *sensf_req)\r\n{\r\nstruct sk_buff *skb;\r\nu8 size;\r\nint rc;\r\nstruct digital_sensf_res *sensf_res;\r\nsize = sizeof(struct digital_sensf_res);\r\nif (sensf_req->rc == DIGITAL_SENSF_REQ_RC_NONE)\r\nsize -= sizeof(sensf_res->rd);\r\nskb = digital_skb_alloc(ddev, size);\r\nif (!skb)\r\nreturn -ENOMEM;\r\nskb_put(skb, size);\r\nsensf_res = (struct digital_sensf_res *)skb->data;\r\nmemset(sensf_res, 0, size);\r\nsensf_res->cmd = DIGITAL_CMD_SENSF_RES;\r\nsensf_res->nfcid2[0] = DIGITAL_SENSF_NFCID2_NFC_DEP_B1;\r\nsensf_res->nfcid2[1] = DIGITAL_SENSF_NFCID2_NFC_DEP_B2;\r\nget_random_bytes(&sensf_res->nfcid2[2], 6);\r\nswitch (sensf_req->rc) {\r\ncase DIGITAL_SENSF_REQ_RC_SC:\r\nsensf_res->rd[0] = sensf_req->sc1;\r\nsensf_res->rd[1] = sensf_req->sc2;\r\nbreak;\r\ncase DIGITAL_SENSF_REQ_RC_AP:\r\nsensf_res->rd[0] = DIGITAL_SENSF_RES_RD_AP_B1;\r\nsensf_res->rd[1] = DIGITAL_SENSF_RES_RD_AP_B2;\r\nbreak;\r\n}\r\n*skb_push(skb, sizeof(u8)) = size + 1;\r\nif (!DIGITAL_DRV_CAPS_TG_CRC(ddev))\r\ndigital_skb_add_crc_f(skb);\r\nrc = digital_tg_send_cmd(ddev, skb, 300,\r\ndigital_tg_recv_atr_or_sensf_req, NULL);\r\nif (rc)\r\nkfree_skb(skb);\r\nreturn rc;\r\n}\r\nvoid digital_tg_recv_sensf_req(struct nfc_digital_dev *ddev, void *arg,\r\nstruct sk_buff *resp)\r\n{\r\nstruct digital_sensf_req *sensf_req;\r\nint rc;\r\nif (IS_ERR(resp)) {\r\nrc = PTR_ERR(resp);\r\nresp = NULL;\r\ngoto exit;\r\n}\r\nif (!DIGITAL_DRV_CAPS_TG_CRC(ddev)) {\r\nrc = digital_skb_check_crc_f(resp);\r\nif (rc) {\r\nPROTOCOL_ERR("6.4.1.8");\r\ngoto exit;\r\n}\r\n}\r\nif (resp->len != sizeof(struct digital_sensf_req) + 1) {\r\nrc = -EINVAL;\r\ngoto exit;\r\n}\r\nskb_pull(resp, 1);\r\nsensf_req = (struct digital_sensf_req *)resp->data;\r\nif (sensf_req->cmd != DIGITAL_CMD_SENSF_REQ) {\r\nrc = -EINVAL;\r\ngoto exit;\r\n}\r\nrc = digital_tg_send_sensf_res(ddev, sensf_req);\r\nexit:\r\nif (rc)\r\ndigital_poll_next_tech(ddev);\r\ndev_kfree_skb(resp);\r\n}\r\nstatic int digital_tg_config_nfca(struct nfc_digital_dev *ddev)\r\n{\r\nint rc;\r\nrc = digital_tg_configure_hw(ddev, NFC_DIGITAL_CONFIG_RF_TECH,\r\nNFC_DIGITAL_RF_TECH_106A);\r\nif (rc)\r\nreturn rc;\r\nreturn digital_tg_configure_hw(ddev, NFC_DIGITAL_CONFIG_FRAMING,\r\nNFC_DIGITAL_FRAMING_NFCA_NFC_DEP);\r\n}\r\nint digital_tg_listen_nfca(struct nfc_digital_dev *ddev, u8 rf_tech)\r\n{\r\nint rc;\r\nrc = digital_tg_config_nfca(ddev);\r\nif (rc)\r\nreturn rc;\r\nreturn digital_tg_listen(ddev, 300, digital_tg_recv_sens_req, NULL);\r\n}\r\nstatic int digital_tg_config_nfcf(struct nfc_digital_dev *ddev, u8 rf_tech)\r\n{\r\nint rc;\r\nrc = digital_tg_configure_hw(ddev, NFC_DIGITAL_CONFIG_RF_TECH, rf_tech);\r\nif (rc)\r\nreturn rc;\r\nreturn digital_tg_configure_hw(ddev, NFC_DIGITAL_CONFIG_FRAMING,\r\nNFC_DIGITAL_FRAMING_NFCF_NFC_DEP);\r\n}\r\nint digital_tg_listen_nfcf(struct nfc_digital_dev *ddev, u8 rf_tech)\r\n{\r\nint rc;\r\nu8 *nfcid2;\r\nrc = digital_tg_config_nfcf(ddev, rf_tech);\r\nif (rc)\r\nreturn rc;\r\nnfcid2 = kzalloc(NFC_NFCID2_MAXSIZE, GFP_KERNEL);\r\nif (!nfcid2)\r\nreturn -ENOMEM;\r\nnfcid2[0] = DIGITAL_SENSF_NFCID2_NFC_DEP_B1;\r\nnfcid2[1] = DIGITAL_SENSF_NFCID2_NFC_DEP_B2;\r\nget_random_bytes(nfcid2 + 2, NFC_NFCID2_MAXSIZE - 2);\r\nreturn digital_tg_listen(ddev, 300, digital_tg_recv_sensf_req, nfcid2);\r\n}\r\nvoid digital_tg_recv_md_req(struct nfc_digital_dev *ddev, void *arg,\r\nstruct sk_buff *resp)\r\n{\r\nu8 rf_tech;\r\nint rc;\r\nif (IS_ERR(resp)) {\r\nresp = NULL;\r\ngoto exit_free_skb;\r\n}\r\nrc = ddev->ops->tg_get_rf_tech(ddev, &rf_tech);\r\nif (rc)\r\ngoto exit_free_skb;\r\nswitch (rf_tech) {\r\ncase NFC_DIGITAL_RF_TECH_106A:\r\nrc = digital_tg_config_nfca(ddev);\r\nif (rc)\r\ngoto exit_free_skb;\r\ndigital_tg_recv_sens_req(ddev, arg, resp);\r\nbreak;\r\ncase NFC_DIGITAL_RF_TECH_212F:\r\ncase NFC_DIGITAL_RF_TECH_424F:\r\nrc = digital_tg_config_nfcf(ddev, rf_tech);\r\nif (rc)\r\ngoto exit_free_skb;\r\ndigital_tg_recv_sensf_req(ddev, arg, resp);\r\nbreak;\r\ndefault:\r\ngoto exit_free_skb;\r\n}\r\nreturn;\r\nexit_free_skb:\r\ndigital_poll_next_tech(ddev);\r\ndev_kfree_skb(resp);\r\n}

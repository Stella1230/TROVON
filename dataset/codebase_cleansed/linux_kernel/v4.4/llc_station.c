static int llc_stat_ev_rx_null_dsap_xid_c(struct sk_buff *skb)\r\n{\r\nstruct llc_pdu_un *pdu = llc_pdu_un_hdr(skb);\r\nreturn LLC_PDU_IS_CMD(pdu) &&\r\nLLC_PDU_TYPE_IS_U(pdu) &&\r\nLLC_U_PDU_CMD(pdu) == LLC_1_PDU_CMD_XID &&\r\n!pdu->dsap ? 0 : 1;\r\n}\r\nstatic int llc_stat_ev_rx_null_dsap_test_c(struct sk_buff *skb)\r\n{\r\nstruct llc_pdu_un *pdu = llc_pdu_un_hdr(skb);\r\nreturn LLC_PDU_IS_CMD(pdu) &&\r\nLLC_PDU_TYPE_IS_U(pdu) &&\r\nLLC_U_PDU_CMD(pdu) == LLC_1_PDU_CMD_TEST &&\r\n!pdu->dsap ? 0 : 1;\r\n}\r\nstatic int llc_station_ac_send_xid_r(struct sk_buff *skb)\r\n{\r\nu8 mac_da[ETH_ALEN], dsap;\r\nint rc = 1;\r\nstruct sk_buff *nskb = llc_alloc_frame(NULL, skb->dev, LLC_PDU_TYPE_U,\r\nsizeof(struct llc_xid_info));\r\nif (!nskb)\r\ngoto out;\r\nrc = 0;\r\nllc_pdu_decode_sa(skb, mac_da);\r\nllc_pdu_decode_ssap(skb, &dsap);\r\nllc_pdu_header_init(nskb, LLC_PDU_TYPE_U, 0, dsap, LLC_PDU_RSP);\r\nllc_pdu_init_as_xid_rsp(nskb, LLC_XID_NULL_CLASS_2, 127);\r\nrc = llc_mac_hdr_init(nskb, skb->dev->dev_addr, mac_da);\r\nif (unlikely(rc))\r\ngoto free;\r\ndev_queue_xmit(nskb);\r\nout:\r\nreturn rc;\r\nfree:\r\nkfree_skb(nskb);\r\ngoto out;\r\n}\r\nstatic int llc_station_ac_send_test_r(struct sk_buff *skb)\r\n{\r\nu8 mac_da[ETH_ALEN], dsap;\r\nint rc = 1;\r\nu32 data_size;\r\nstruct sk_buff *nskb;\r\ndata_size = ntohs(eth_hdr(skb)->h_proto) - 3;\r\nnskb = llc_alloc_frame(NULL, skb->dev, LLC_PDU_TYPE_U, data_size);\r\nif (!nskb)\r\ngoto out;\r\nrc = 0;\r\nllc_pdu_decode_sa(skb, mac_da);\r\nllc_pdu_decode_ssap(skb, &dsap);\r\nllc_pdu_header_init(nskb, LLC_PDU_TYPE_U, 0, dsap, LLC_PDU_RSP);\r\nllc_pdu_init_as_test_rsp(nskb, skb);\r\nrc = llc_mac_hdr_init(nskb, skb->dev->dev_addr, mac_da);\r\nif (unlikely(rc))\r\ngoto free;\r\ndev_queue_xmit(nskb);\r\nout:\r\nreturn rc;\r\nfree:\r\nkfree_skb(nskb);\r\ngoto out;\r\n}\r\nstatic void llc_station_rcv(struct sk_buff *skb)\r\n{\r\nif (llc_stat_ev_rx_null_dsap_xid_c(skb))\r\nllc_station_ac_send_xid_r(skb);\r\nelse if (llc_stat_ev_rx_null_dsap_test_c(skb))\r\nllc_station_ac_send_test_r(skb);\r\nkfree_skb(skb);\r\n}\r\nvoid __init llc_station_init(void)\r\n{\r\nllc_set_station_handler(llc_station_rcv);\r\n}\r\nvoid llc_station_exit(void)\r\n{\r\nllc_set_station_handler(NULL);\r\n}

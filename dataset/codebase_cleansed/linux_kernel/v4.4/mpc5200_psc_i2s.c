static int psc_i2s_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct psc_dma *psc_dma = snd_soc_dai_get_drvdata(rtd->cpu_dai);\r\nu32 mode;\r\ndev_dbg(psc_dma->dev, "%s(substream=%p) p_size=%i p_bytes=%i"\r\n" periods=%i buffer_size=%i buffer_bytes=%i\n",\r\n__func__, substream, params_period_size(params),\r\nparams_period_bytes(params), params_periods(params),\r\nparams_buffer_size(params), params_buffer_bytes(params));\r\nswitch (params_format(params)) {\r\ncase SNDRV_PCM_FORMAT_S8:\r\nmode = MPC52xx_PSC_SICR_SIM_CODEC_8;\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S16_BE:\r\nmode = MPC52xx_PSC_SICR_SIM_CODEC_16;\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S24_BE:\r\nmode = MPC52xx_PSC_SICR_SIM_CODEC_24;\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S32_BE:\r\nmode = MPC52xx_PSC_SICR_SIM_CODEC_32;\r\nbreak;\r\ndefault:\r\ndev_dbg(psc_dma->dev, "invalid format\n");\r\nreturn -EINVAL;\r\n}\r\nout_be32(&psc_dma->psc_regs->sicr, psc_dma->sicr | mode);\r\nreturn 0;\r\n}\r\nstatic int psc_i2s_set_sysclk(struct snd_soc_dai *cpu_dai,\r\nint clk_id, unsigned int freq, int dir)\r\n{\r\nstruct psc_dma *psc_dma = snd_soc_dai_get_drvdata(cpu_dai);\r\ndev_dbg(psc_dma->dev, "psc_i2s_set_sysclk(cpu_dai=%p, dir=%i)\n",\r\ncpu_dai, dir);\r\nreturn (dir == SND_SOC_CLOCK_IN) ? 0 : -EINVAL;\r\n}\r\nstatic int psc_i2s_set_fmt(struct snd_soc_dai *cpu_dai, unsigned int format)\r\n{\r\nstruct psc_dma *psc_dma = snd_soc_dai_get_drvdata(cpu_dai);\r\ndev_dbg(psc_dma->dev, "psc_i2s_set_fmt(cpu_dai=%p, format=%i)\n",\r\ncpu_dai, format);\r\nreturn (format == SND_SOC_DAIFMT_I2S) ? 0 : -EINVAL;\r\n}\r\nstatic int psc_i2s_of_probe(struct platform_device *op)\r\n{\r\nint rc;\r\nstruct psc_dma *psc_dma;\r\nstruct mpc52xx_psc __iomem *regs;\r\nrc = mpc5200_audio_dma_create(op);\r\nif (rc != 0)\r\nreturn rc;\r\nrc = snd_soc_register_component(&op->dev, &psc_i2s_component,\r\npsc_i2s_dai, ARRAY_SIZE(psc_i2s_dai));\r\nif (rc != 0) {\r\npr_err("Failed to register DAI\n");\r\nreturn rc;\r\n}\r\npsc_dma = dev_get_drvdata(&op->dev);\r\nregs = psc_dma->psc_regs;\r\npsc_dma->sicr = MPC52xx_PSC_SICR_DTS1 | MPC52xx_PSC_SICR_I2S |\r\nMPC52xx_PSC_SICR_CLKPOL;\r\nout_be32(&psc_dma->psc_regs->sicr,\r\npsc_dma->sicr | MPC52xx_PSC_SICR_SIM_CODEC_8);\r\nif (!of_get_property(op->dev.of_node, "codec-handle", NULL))\r\nreturn 0;\r\nwhile ((in_8(&regs->ipcr_acr.ipcr) & 0x80) != 0)\r\n;\r\nwhile ((in_8(&regs->ipcr_acr.ipcr) & 0x80) == 0)\r\n;\r\nout_8(&psc_dma->psc_regs->command,\r\nMPC52xx_PSC_TX_ENABLE | MPC52xx_PSC_RX_ENABLE);\r\nreturn 0;\r\n}\r\nstatic int psc_i2s_of_remove(struct platform_device *op)\r\n{\r\nmpc5200_audio_dma_destroy(op);\r\nsnd_soc_unregister_component(&op->dev);\r\nreturn 0;\r\n}

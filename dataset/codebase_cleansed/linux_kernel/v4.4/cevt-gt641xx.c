void gt641xx_set_base_clock(unsigned int clock)\r\n{\r\ngt641xx_base_clock = clock;\r\n}\r\nint gt641xx_timer0_state(void)\r\n{\r\nif (GT_READ(GT_TC0_OFS))\r\nreturn 0;\r\nGT_WRITE(GT_TC0_OFS, gt641xx_base_clock / HZ);\r\nGT_WRITE(GT_TC_CONTROL_OFS, GT_TC_CONTROL_ENTC0_MSK);\r\nreturn 1;\r\n}\r\nstatic int gt641xx_timer0_set_next_event(unsigned long delta,\r\nstruct clock_event_device *evt)\r\n{\r\nu32 ctrl;\r\nraw_spin_lock(&gt641xx_timer_lock);\r\nctrl = GT_READ(GT_TC_CONTROL_OFS);\r\nctrl &= ~(GT_TC_CONTROL_ENTC0_MSK | GT_TC_CONTROL_SELTC0_MSK);\r\nctrl |= GT_TC_CONTROL_ENTC0_MSK;\r\nGT_WRITE(GT_TC0_OFS, delta);\r\nGT_WRITE(GT_TC_CONTROL_OFS, ctrl);\r\nraw_spin_unlock(&gt641xx_timer_lock);\r\nreturn 0;\r\n}\r\nstatic int gt641xx_timer0_shutdown(struct clock_event_device *evt)\r\n{\r\nu32 ctrl;\r\nraw_spin_lock(&gt641xx_timer_lock);\r\nctrl = GT_READ(GT_TC_CONTROL_OFS);\r\nctrl &= ~(GT_TC_CONTROL_ENTC0_MSK | GT_TC_CONTROL_SELTC0_MSK);\r\nGT_WRITE(GT_TC_CONTROL_OFS, ctrl);\r\nraw_spin_unlock(&gt641xx_timer_lock);\r\nreturn 0;\r\n}\r\nstatic int gt641xx_timer0_set_oneshot(struct clock_event_device *evt)\r\n{\r\nu32 ctrl;\r\nraw_spin_lock(&gt641xx_timer_lock);\r\nctrl = GT_READ(GT_TC_CONTROL_OFS);\r\nctrl &= ~GT_TC_CONTROL_SELTC0_MSK;\r\nctrl |= GT_TC_CONTROL_ENTC0_MSK;\r\nGT_WRITE(GT_TC_CONTROL_OFS, ctrl);\r\nraw_spin_unlock(&gt641xx_timer_lock);\r\nreturn 0;\r\n}\r\nstatic int gt641xx_timer0_set_periodic(struct clock_event_device *evt)\r\n{\r\nu32 ctrl;\r\nraw_spin_lock(&gt641xx_timer_lock);\r\nctrl = GT_READ(GT_TC_CONTROL_OFS);\r\nctrl |= GT_TC_CONTROL_ENTC0_MSK | GT_TC_CONTROL_SELTC0_MSK;\r\nGT_WRITE(GT_TC_CONTROL_OFS, ctrl);\r\nraw_spin_unlock(&gt641xx_timer_lock);\r\nreturn 0;\r\n}\r\nstatic void gt641xx_timer0_event_handler(struct clock_event_device *dev)\r\n{\r\n}\r\nstatic irqreturn_t gt641xx_timer0_interrupt(int irq, void *dev_id)\r\n{\r\nstruct clock_event_device *cd = &gt641xx_timer0_clockevent;\r\ncd->event_handler(cd);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __init gt641xx_timer0_clockevent_init(void)\r\n{\r\nstruct clock_event_device *cd;\r\nif (!gt641xx_base_clock)\r\nreturn 0;\r\nGT_WRITE(GT_TC0_OFS, gt641xx_base_clock / HZ);\r\ncd = &gt641xx_timer0_clockevent;\r\ncd->rating = 200 + gt641xx_base_clock / 10000000;\r\nclockevent_set_clock(cd, gt641xx_base_clock);\r\ncd->max_delta_ns = clockevent_delta2ns(0x7fffffff, cd);\r\ncd->min_delta_ns = clockevent_delta2ns(0x300, cd);\r\ncd->cpumask = cpumask_of(0);\r\nclockevents_register_device(&gt641xx_timer0_clockevent);\r\nreturn setup_irq(GT641XX_TIMER0_IRQ, &gt641xx_timer0_irqaction);\r\n}

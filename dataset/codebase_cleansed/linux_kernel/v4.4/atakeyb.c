static irqreturn_t atari_keyboard_interrupt(int irq, void *dummy)\r\n{\r\nu_char acia_stat;\r\nint scancode;\r\nint break_flag;\r\nrepeat:\r\nif (acia.mid_ctrl & ACIA_IRQ)\r\nif (atari_MIDI_interrupt_hook)\r\natari_MIDI_interrupt_hook();\r\nacia_stat = acia.key_ctrl;\r\nif (!((acia_stat | acia.mid_ctrl) & ACIA_IRQ))\r\nreturn IRQ_HANDLED;\r\nif (acia_stat & ACIA_OVRN) {\r\nprintk(KERN_DEBUG "Keyboard overrun\n");\r\nscancode = acia.key_data;\r\nif (ikbd_self_test)\r\ngoto interpret_scancode;\r\nelse if (IS_SYNC_CODE(scancode)) {\r\nkb_state.state = KEYBOARD;\r\ngoto interpret_scancode;\r\n} else {\r\nkb_state.state = RESYNC;\r\nkb_state.len = 1;\r\ngoto repeat;\r\n}\r\n}\r\nif (acia_stat & ACIA_RDRF) {\r\nscancode = acia.key_data;\r\ninterpret_scancode:\r\nswitch (kb_state.state) {\r\ncase KEYBOARD:\r\nswitch (scancode) {\r\ncase 0xF7:\r\nkb_state.state = AMOUSE;\r\nkb_state.len = 0;\r\nbreak;\r\ncase 0xF8:\r\ncase 0xF9:\r\ncase 0xFA:\r\ncase 0xFB:\r\nkb_state.state = RMOUSE;\r\nkb_state.len = 1;\r\nkb_state.buf[0] = scancode;\r\nbreak;\r\ncase 0xFC:\r\nkb_state.state = CLOCK;\r\nkb_state.len = 0;\r\nbreak;\r\ncase 0xFE:\r\ncase 0xFF:\r\nkb_state.state = JOYSTICK;\r\nkb_state.len = 1;\r\nkb_state.buf[0] = scancode;\r\nbreak;\r\ncase 0xF1:\r\nif (ikbd_self_test) {\r\n++ikbd_self_test;\r\nself_test_last_rcv = jiffies;\r\nbreak;\r\n}\r\ndefault:\r\nbreak_flag = scancode & BREAK_MASK;\r\nscancode &= ~BREAK_MASK;\r\nif (ikbd_self_test) {\r\nint keyval, keytyp;\r\nset_bit(scancode, broken_keys);\r\nself_test_last_rcv = jiffies;\r\nkeyval = scancode;\r\nkeytyp = KTYP(keyval) - 0xf0;\r\nkeyval = KVAL(keyval);\r\nprintk(KERN_WARNING "Key with scancode %d ", scancode);\r\nif (keytyp == KT_LATIN || keytyp == KT_LETTER) {\r\nif (keyval < ' ')\r\nprintk("('^%c') ", keyval + '@');\r\nelse\r\nprintk("('%c') ", keyval);\r\n}\r\nprintk("is broken -- will be ignored.\n");\r\nbreak;\r\n} else if (test_bit(scancode, broken_keys))\r\nbreak;\r\nif (atari_input_keyboard_interrupt_hook)\r\natari_input_keyboard_interrupt_hook((unsigned char)scancode, !break_flag);\r\nbreak;\r\n}\r\nbreak;\r\ncase AMOUSE:\r\nkb_state.buf[kb_state.len++] = scancode;\r\nif (kb_state.len == 5) {\r\nkb_state.state = KEYBOARD;\r\n}\r\nbreak;\r\ncase RMOUSE:\r\nkb_state.buf[kb_state.len++] = scancode;\r\nif (kb_state.len == 3) {\r\nkb_state.state = KEYBOARD;\r\nif (atari_input_mouse_interrupt_hook)\r\natari_input_mouse_interrupt_hook(kb_state.buf);\r\n}\r\nbreak;\r\ncase JOYSTICK:\r\nkb_state.buf[1] = scancode;\r\nkb_state.state = KEYBOARD;\r\n#ifdef FIXED_ATARI_JOYSTICK\r\natari_joystick_interrupt(kb_state.buf);\r\n#endif\r\nbreak;\r\ncase CLOCK:\r\nkb_state.buf[kb_state.len++] = scancode;\r\nif (kb_state.len == 6) {\r\nkb_state.state = KEYBOARD;\r\n}\r\nbreak;\r\ncase RESYNC:\r\nif (kb_state.len <= 0 || IS_SYNC_CODE(scancode)) {\r\nkb_state.state = KEYBOARD;\r\ngoto interpret_scancode;\r\n}\r\nkb_state.len--;\r\nbreak;\r\n}\r\n}\r\n#if 0\r\nif (acia_stat & ACIA_CTS)\r\n;\r\n#endif\r\nif (acia_stat & (ACIA_FE | ACIA_PE)) {\r\nprintk("Error in keyboard communication\n");\r\n}\r\ngoto repeat;\r\n}\r\nvoid ikbd_write(const char *str, int len)\r\n{\r\nu_char acia_stat;\r\nif ((len < 1) || (len > 7))\r\npanic("ikbd: maximum string length exceeded");\r\nwhile (len) {\r\nacia_stat = acia.key_ctrl;\r\nif (acia_stat & ACIA_TDRE) {\r\nacia.key_data = *str++;\r\nlen--;\r\n}\r\n}\r\n}\r\nvoid ikbd_reset(void)\r\n{\r\nstatic const char cmd[2] = { 0x80, 0x01 };\r\nikbd_write(cmd, 2);\r\n}\r\nvoid ikbd_mouse_button_action(int mode)\r\n{\r\nchar cmd[2] = { 0x07, mode };\r\nikbd_write(cmd, 2);\r\n}\r\nvoid ikbd_mouse_rel_pos(void)\r\n{\r\nstatic const char cmd[1] = { 0x08 };\r\nikbd_write(cmd, 1);\r\n}\r\nvoid ikbd_mouse_abs_pos(int xmax, int ymax)\r\n{\r\nchar cmd[5] = { 0x09, xmax>>8, xmax&0xFF, ymax>>8, ymax&0xFF };\r\nikbd_write(cmd, 5);\r\n}\r\nvoid ikbd_mouse_kbd_mode(int dx, int dy)\r\n{\r\nchar cmd[3] = { 0x0A, dx, dy };\r\nikbd_write(cmd, 3);\r\n}\r\nvoid ikbd_mouse_thresh(int x, int y)\r\n{\r\nchar cmd[3] = { 0x0B, x, y };\r\nikbd_write(cmd, 3);\r\n}\r\nvoid ikbd_mouse_scale(int x, int y)\r\n{\r\nchar cmd[3] = { 0x0C, x, y };\r\nikbd_write(cmd, 3);\r\n}\r\nvoid ikbd_mouse_pos_get(int *x, int *y)\r\n{\r\nstatic const char cmd[1] = { 0x0D };\r\nikbd_write(cmd, 1);\r\n}\r\nvoid ikbd_mouse_pos_set(int x, int y)\r\n{\r\nchar cmd[6] = { 0x0E, 0x00, x>>8, x&0xFF, y>>8, y&0xFF };\r\nikbd_write(cmd, 6);\r\n}\r\nvoid ikbd_mouse_y0_bot(void)\r\n{\r\nstatic const char cmd[1] = { 0x0F };\r\nikbd_write(cmd, 1);\r\n}\r\nvoid ikbd_mouse_y0_top(void)\r\n{\r\nstatic const char cmd[1] = { 0x10 };\r\nikbd_write(cmd, 1);\r\n}\r\nvoid ikbd_mouse_disable(void)\r\n{\r\nstatic const char cmd[1] = { 0x12 };\r\nikbd_write(cmd, 1);\r\n}\r\nvoid ikbd_joystick_event_on(void)\r\n{\r\nstatic const char cmd[1] = { 0x14 };\r\nikbd_write(cmd, 1);\r\n}\r\nvoid ikbd_joystick_event_off(void)\r\n{\r\nstatic const char cmd[1] = { 0x15 };\r\nikbd_write(cmd, 1);\r\n}\r\nvoid ikbd_joystick_get_state(void)\r\n{\r\nstatic const char cmd[1] = { 0x16 };\r\nikbd_write(cmd, 1);\r\n}\r\nvoid ikbd_joystick_disable(void)\r\n{\r\nstatic const char cmd[1] = { 0x1A };\r\nikbd_write(cmd, 1);\r\n}\r\nint atari_keyb_init(void)\r\n{\r\nint error;\r\nif (atari_keyb_done)\r\nreturn 0;\r\nkb_state.state = KEYBOARD;\r\nkb_state.len = 0;\r\nerror = request_irq(IRQ_MFP_ACIA, atari_keyboard_interrupt, 0,\r\n"keyboard,mouse,MIDI", atari_keyboard_interrupt);\r\nif (error)\r\nreturn error;\r\natari_turnoff_irq(IRQ_MFP_ACIA);\r\ndo {\r\nacia.key_ctrl = ACIA_RESET |\r\n((atari_switches & ATARI_SWITCH_IKBD) ?\r\nACIA_RHTID : 0);\r\n(void)acia.key_ctrl;\r\n(void)acia.key_data;\r\nacia.mid_ctrl = ACIA_RESET |\r\n((atari_switches & ATARI_SWITCH_MIDI) ?\r\nACIA_RHTID : 0);\r\n(void)acia.mid_ctrl;\r\n(void)acia.mid_data;\r\nacia.key_ctrl = (ACIA_DIV64|ACIA_D8N1S|ACIA_RIE) |\r\n((atari_switches & ATARI_SWITCH_IKBD) ?\r\nACIA_RHTID : ACIA_RLTID);\r\nacia.mid_ctrl = ACIA_DIV16 | ACIA_D8N1S |\r\n((atari_switches & ATARI_SWITCH_MIDI) ?\r\nACIA_RHTID : 0);\r\n} while ((st_mfp.par_dt_reg & 0x10) == 0);\r\nst_mfp.active_edge &= ~0x10;\r\natari_turnon_irq(IRQ_MFP_ACIA);\r\nikbd_self_test = 1;\r\nikbd_reset();\r\nself_test_last_rcv = jiffies;\r\nwhile (time_before(jiffies, self_test_last_rcv + HZ/4))\r\nbarrier();\r\nif (ikbd_self_test == 1)\r\nprintk(KERN_ERR "WARNING: keyboard self test failed!\n");\r\nikbd_self_test = 0;\r\nikbd_mouse_disable();\r\nikbd_joystick_disable();\r\n#ifdef FIXED_ATARI_JOYSTICK\r\natari_joystick_init();\r\n#endif\r\natari_keyb_done = 1;\r\nreturn 0;\r\n}

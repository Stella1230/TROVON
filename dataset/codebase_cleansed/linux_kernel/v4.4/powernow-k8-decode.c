static int get_fidvid(uint32_t cpu, uint32_t *fid, uint32_t *vid)\r\n{\r\nint err = 1;\r\nuint64_t msr = 0;\r\nint fd;\r\nchar file[20];\r\nif (cpu > MCPU)\r\ngoto out;\r\nsprintf(file, "/dev/cpu/%d/msr", cpu);\r\nfd = open(file, O_RDONLY);\r\nif (fd < 0)\r\ngoto out;\r\nlseek(fd, MSR_FIDVID_STATUS, SEEK_CUR);\r\nif (read(fd, &msr, 8) != 8)\r\ngoto err1;\r\n*fid = ((uint32_t )(msr & 0xffffffffull)) & MSR_S_LO_CURRENT_FID;\r\n*vid = ((uint32_t )(msr>>32 & 0xffffffffull)) & MSR_S_HI_CURRENT_VID;\r\nerr = 0;\r\nerr1:\r\nclose(fd);\r\nout:\r\nreturn err;\r\n}\r\nstatic uint32_t find_freq_from_fid(uint32_t fid)\r\n{\r\nreturn 800 + (fid * 100);\r\n}\r\nstatic uint32_t find_millivolts_from_vid(uint32_t vid)\r\n{\r\nreturn 1550-vid*25;\r\n}\r\nint main (int argc, char *argv[])\r\n{\r\nint err;\r\nint cpu;\r\nuint32_t fid, vid;\r\nif (argc < 2)\r\ncpu = 0;\r\nelse\r\ncpu = strtoul(argv[1], NULL, 0);\r\nerr = get_fidvid(cpu, &fid, &vid);\r\nif (err) {\r\nprintf("can't get fid, vid from MSR\n");\r\nprintf("Possible trouble: you don't run a powernow-k8 capable cpu\n");\r\nprintf("or you are not root, or the msr driver is not present\n");\r\nexit(1);\r\n}\r\nprintf("cpu %d currently at %d MHz and %d mV\n",\r\ncpu,\r\nfind_freq_from_fid(fid),\r\nfind_millivolts_from_vid(vid));\r\nreturn 0;\r\n}

static unsigned short wm_get(struct snd_ice1712 *ice, int reg)\r\n{\r\nreg <<= 1;\r\nreturn ((unsigned short)ice->akm[0].images[reg] << 8) |\r\nice->akm[0].images[reg + 1];\r\n}\r\nstatic void wm_put_nocache(struct snd_ice1712 *ice, int reg, unsigned short val)\r\n{\r\nunsigned short cval;\r\ncval = (reg << 9) | val;\r\nsnd_vt1724_write_i2c(ice, WM_DEV, cval >> 8, cval & 0xff);\r\n}\r\nstatic void wm_put(struct snd_ice1712 *ice, int reg, unsigned short val)\r\n{\r\nwm_put_nocache(ice, reg, val);\r\nreg <<= 1;\r\nice->akm[0].images[reg] = val >> 8;\r\nice->akm[0].images[reg + 1] = val;\r\n}\r\nstatic int wm_dac_vol_info(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\r\nuinfo->count = 2;\r\nuinfo->value.integer.min = 0;\r\nuinfo->value.integer.max = DAC_RES;\r\nreturn 0;\r\n}\r\nstatic int wm_dac_vol_get(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nunsigned short val;\r\nint i;\r\nmutex_lock(&ice->gpio_mutex);\r\nfor (i = 0; i < 2; i++) {\r\nval = wm_get(ice, WM_DAC_ATTEN_L + i) & 0xff;\r\nval = val > DAC_MIN ? (val - DAC_MIN) : 0;\r\nucontrol->value.integer.value[i] = val;\r\n}\r\nmutex_unlock(&ice->gpio_mutex);\r\nreturn 0;\r\n}\r\nstatic int wm_dac_vol_put(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nunsigned short oval, nval;\r\nint i, idx, change = 0;\r\nmutex_lock(&ice->gpio_mutex);\r\nfor (i = 0; i < 2; i++) {\r\nnval = ucontrol->value.integer.value[i];\r\nnval = (nval ? (nval + DAC_MIN) : 0) & 0xff;\r\nidx = WM_DAC_ATTEN_L + i;\r\noval = wm_get(ice, idx) & 0xff;\r\nif (oval != nval) {\r\nwm_put(ice, idx, nval);\r\nwm_put_nocache(ice, idx, nval | 0x100);\r\nchange = 1;\r\n}\r\n}\r\nmutex_unlock(&ice->gpio_mutex);\r\nreturn change;\r\n}\r\nstatic int wm_adc_vol_info(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\r\nuinfo->count = 2;\r\nuinfo->value.integer.min = 0;\r\nuinfo->value.integer.max = ADC_RES;\r\nreturn 0;\r\n}\r\nstatic int wm_adc_vol_get(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nunsigned short val;\r\nint i;\r\nmutex_lock(&ice->gpio_mutex);\r\nfor (i = 0; i < 2; i++) {\r\nval = wm_get(ice, WM_ADC_ATTEN_L + i) & 0xff;\r\nval = val > ADC_MIN ? (val - ADC_MIN) : 0;\r\nucontrol->value.integer.value[i] = val;\r\n}\r\nmutex_unlock(&ice->gpio_mutex);\r\nreturn 0;\r\n}\r\nstatic int wm_adc_vol_put(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nunsigned short ovol, nvol;\r\nint i, idx, change = 0;\r\nmutex_lock(&ice->gpio_mutex);\r\nfor (i = 0; i < 2; i++) {\r\nnvol = ucontrol->value.integer.value[i];\r\nnvol = nvol ? (nvol + ADC_MIN) : 0;\r\nidx = WM_ADC_ATTEN_L + i;\r\novol = wm_get(ice, idx) & 0xff;\r\nif (ovol != nvol) {\r\nwm_put(ice, idx, nvol);\r\nchange = 1;\r\n}\r\n}\r\nmutex_unlock(&ice->gpio_mutex);\r\nreturn change;\r\n}\r\nstatic int wm_adc_mux_get(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nint bit = kcontrol->private_value;\r\nmutex_lock(&ice->gpio_mutex);\r\nucontrol->value.integer.value[0] = (wm_get(ice, WM_ADC_MUX) & (1 << bit)) ? 1 : 0;\r\nmutex_unlock(&ice->gpio_mutex);\r\nreturn 0;\r\n}\r\nstatic int wm_adc_mux_put(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nint bit = kcontrol->private_value;\r\nunsigned short oval, nval;\r\nint change;\r\nmutex_lock(&ice->gpio_mutex);\r\nnval = oval = wm_get(ice, WM_ADC_MUX);\r\nif (ucontrol->value.integer.value[0])\r\nnval |= (1 << bit);\r\nelse\r\nnval &= ~(1 << bit);\r\nchange = nval != oval;\r\nif (change) {\r\nwm_put(ice, WM_ADC_MUX, nval);\r\n}\r\nmutex_unlock(&ice->gpio_mutex);\r\nreturn change;\r\n}\r\nstatic int wm_bypass_get(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nmutex_lock(&ice->gpio_mutex);\r\nucontrol->value.integer.value[0] = (wm_get(ice, WM_OUT_MUX) & 0x04) ? 1 : 0;\r\nmutex_unlock(&ice->gpio_mutex);\r\nreturn 0;\r\n}\r\nstatic int wm_bypass_put(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nunsigned short val, oval;\r\nint change = 0;\r\nmutex_lock(&ice->gpio_mutex);\r\nval = oval = wm_get(ice, WM_OUT_MUX);\r\nif (ucontrol->value.integer.value[0])\r\nval |= 0x04;\r\nelse\r\nval &= ~0x04;\r\nif (val != oval) {\r\nwm_put(ice, WM_OUT_MUX, val);\r\nchange = 1;\r\n}\r\nmutex_unlock(&ice->gpio_mutex);\r\nreturn change;\r\n}\r\nstatic int wm_chswap_get(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nmutex_lock(&ice->gpio_mutex);\r\nucontrol->value.integer.value[0] = (wm_get(ice, WM_DAC_CTRL1) & 0xf0) != 0x90;\r\nmutex_unlock(&ice->gpio_mutex);\r\nreturn 0;\r\n}\r\nstatic int wm_chswap_put(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nunsigned short val, oval;\r\nint change = 0;\r\nmutex_lock(&ice->gpio_mutex);\r\noval = wm_get(ice, WM_DAC_CTRL1);\r\nval = oval & 0x0f;\r\nif (ucontrol->value.integer.value[0])\r\nval |= 0x60;\r\nelse\r\nval |= 0x90;\r\nif (val != oval) {\r\nwm_put(ice, WM_DAC_CTRL1, val);\r\nwm_put_nocache(ice, WM_DAC_CTRL1, val);\r\nchange = 1;\r\n}\r\nmutex_unlock(&ice->gpio_mutex);\r\nreturn change;\r\n}\r\nstatic void set_gpio_bit(struct snd_ice1712 *ice, unsigned int bit, int val)\r\n{\r\nunsigned int tmp = snd_ice1712_gpio_read(ice);\r\nif (val)\r\ntmp |= bit;\r\nelse\r\ntmp &= ~bit;\r\nsnd_ice1712_gpio_write(ice, tmp);\r\n}\r\nstatic void spi_send_byte(struct snd_ice1712 *ice, unsigned char data)\r\n{\r\nint i;\r\nfor (i = 0; i < 8; i++) {\r\nset_gpio_bit(ice, PONTIS_CS_CLK, 0);\r\nudelay(1);\r\nset_gpio_bit(ice, PONTIS_CS_WDATA, data & 0x80);\r\nudelay(1);\r\nset_gpio_bit(ice, PONTIS_CS_CLK, 1);\r\nudelay(1);\r\ndata <<= 1;\r\n}\r\n}\r\nstatic unsigned int spi_read_byte(struct snd_ice1712 *ice)\r\n{\r\nint i;\r\nunsigned int val = 0;\r\nfor (i = 0; i < 8; i++) {\r\nval <<= 1;\r\nset_gpio_bit(ice, PONTIS_CS_CLK, 0);\r\nudelay(1);\r\nif (snd_ice1712_gpio_read(ice) & PONTIS_CS_RDATA)\r\nval |= 1;\r\nudelay(1);\r\nset_gpio_bit(ice, PONTIS_CS_CLK, 1);\r\nudelay(1);\r\n}\r\nreturn val;\r\n}\r\nstatic void spi_write(struct snd_ice1712 *ice, unsigned int dev, unsigned int reg, unsigned int data)\r\n{\r\nsnd_ice1712_gpio_set_dir(ice, PONTIS_CS_CS|PONTIS_CS_WDATA|PONTIS_CS_CLK);\r\nsnd_ice1712_gpio_set_mask(ice, ~(PONTIS_CS_CS|PONTIS_CS_WDATA|PONTIS_CS_CLK));\r\nset_gpio_bit(ice, PONTIS_CS_CS, 0);\r\nspi_send_byte(ice, dev & ~1);\r\nspi_send_byte(ice, reg);\r\nspi_send_byte(ice, data);\r\nset_gpio_bit(ice, PONTIS_CS_CS, 1);\r\nudelay(1);\r\nsnd_ice1712_gpio_set_mask(ice, ice->gpio.write_mask);\r\nsnd_ice1712_gpio_set_dir(ice, ice->gpio.direction);\r\n}\r\nstatic unsigned int spi_read(struct snd_ice1712 *ice, unsigned int dev, unsigned int reg)\r\n{\r\nunsigned int val;\r\nsnd_ice1712_gpio_set_dir(ice, PONTIS_CS_CS|PONTIS_CS_WDATA|PONTIS_CS_CLK);\r\nsnd_ice1712_gpio_set_mask(ice, ~(PONTIS_CS_CS|PONTIS_CS_WDATA|PONTIS_CS_CLK));\r\nset_gpio_bit(ice, PONTIS_CS_CS, 0);\r\nspi_send_byte(ice, dev & ~1);\r\nspi_send_byte(ice, reg);\r\nset_gpio_bit(ice, PONTIS_CS_CS, 1);\r\nudelay(1);\r\nset_gpio_bit(ice, PONTIS_CS_CS, 0);\r\nspi_send_byte(ice, dev | 1);\r\nval = spi_read_byte(ice);\r\nset_gpio_bit(ice, PONTIS_CS_CS, 1);\r\nudelay(1);\r\nsnd_ice1712_gpio_set_mask(ice, ice->gpio.write_mask);\r\nsnd_ice1712_gpio_set_dir(ice, ice->gpio.direction);\r\nreturn val;\r\n}\r\nstatic int cs_source_info(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_info *uinfo)\r\n{\r\nstatic const char * const texts[] = {\r\n"Coax",\r\n"Optical",\r\n"CD",\r\n};\r\nreturn snd_ctl_enum_info(uinfo, 1, 3, texts);\r\n}\r\nstatic int cs_source_get(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nmutex_lock(&ice->gpio_mutex);\r\nucontrol->value.enumerated.item[0] = ice->gpio.saved[0];\r\nmutex_unlock(&ice->gpio_mutex);\r\nreturn 0;\r\n}\r\nstatic int cs_source_put(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nunsigned char val;\r\nint change = 0;\r\nmutex_lock(&ice->gpio_mutex);\r\nif (ucontrol->value.enumerated.item[0] != ice->gpio.saved[0]) {\r\nice->gpio.saved[0] = ucontrol->value.enumerated.item[0] & 3;\r\nval = 0x80 | (ice->gpio.saved[0] << 3);\r\nspi_write(ice, CS_DEV, 0x04, val);\r\nchange = 1;\r\n}\r\nmutex_unlock(&ice->gpio_mutex);\r\nreturn change;\r\n}\r\nstatic int pontis_gpio_mask_info(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\r\nuinfo->count = 1;\r\nuinfo->value.integer.min = 0;\r\nuinfo->value.integer.max = 0xffff;\r\nreturn 0;\r\n}\r\nstatic int pontis_gpio_mask_get(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nmutex_lock(&ice->gpio_mutex);\r\nucontrol->value.integer.value[0] = (~ice->gpio.write_mask & 0xffff) | 0x00f0;\r\nmutex_unlock(&ice->gpio_mutex);\r\nreturn 0;\r\n}\r\nstatic int pontis_gpio_mask_put(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nunsigned int val;\r\nint changed;\r\nmutex_lock(&ice->gpio_mutex);\r\nval = (~ucontrol->value.integer.value[0] & 0xffff) | 0x00f0;\r\nchanged = val != ice->gpio.write_mask;\r\nice->gpio.write_mask = val;\r\nmutex_unlock(&ice->gpio_mutex);\r\nreturn changed;\r\n}\r\nstatic int pontis_gpio_dir_get(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nmutex_lock(&ice->gpio_mutex);\r\nucontrol->value.integer.value[0] = ice->gpio.direction & 0xff0f;\r\nmutex_unlock(&ice->gpio_mutex);\r\nreturn 0;\r\n}\r\nstatic int pontis_gpio_dir_put(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nunsigned int val;\r\nint changed;\r\nmutex_lock(&ice->gpio_mutex);\r\nval = ucontrol->value.integer.value[0] & 0xff0f;\r\nchanged = (val != ice->gpio.direction);\r\nice->gpio.direction = val;\r\nmutex_unlock(&ice->gpio_mutex);\r\nreturn changed;\r\n}\r\nstatic int pontis_gpio_data_get(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nmutex_lock(&ice->gpio_mutex);\r\nsnd_ice1712_gpio_set_dir(ice, ice->gpio.direction);\r\nsnd_ice1712_gpio_set_mask(ice, ice->gpio.write_mask);\r\nucontrol->value.integer.value[0] = snd_ice1712_gpio_read(ice) & 0xffff;\r\nmutex_unlock(&ice->gpio_mutex);\r\nreturn 0;\r\n}\r\nstatic int pontis_gpio_data_put(struct snd_kcontrol *kcontrol, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nunsigned int val, nval;\r\nint changed = 0;\r\nmutex_lock(&ice->gpio_mutex);\r\nsnd_ice1712_gpio_set_dir(ice, ice->gpio.direction);\r\nsnd_ice1712_gpio_set_mask(ice, ice->gpio.write_mask);\r\nval = snd_ice1712_gpio_read(ice) & 0xffff;\r\nnval = ucontrol->value.integer.value[0] & 0xffff;\r\nif (val != nval) {\r\nsnd_ice1712_gpio_write(ice, nval);\r\nchanged = 1;\r\n}\r\nmutex_unlock(&ice->gpio_mutex);\r\nreturn changed;\r\n}\r\nstatic void wm_proc_regs_write(struct snd_info_entry *entry, struct snd_info_buffer *buffer)\r\n{\r\nstruct snd_ice1712 *ice = entry->private_data;\r\nchar line[64];\r\nunsigned int reg, val;\r\nmutex_lock(&ice->gpio_mutex);\r\nwhile (!snd_info_get_line(buffer, line, sizeof(line))) {\r\nif (sscanf(line, "%x %x", &reg, &val) != 2)\r\ncontinue;\r\nif (reg <= 0x17 && val <= 0xffff)\r\nwm_put(ice, reg, val);\r\n}\r\nmutex_unlock(&ice->gpio_mutex);\r\n}\r\nstatic void wm_proc_regs_read(struct snd_info_entry *entry, struct snd_info_buffer *buffer)\r\n{\r\nstruct snd_ice1712 *ice = entry->private_data;\r\nint reg, val;\r\nmutex_lock(&ice->gpio_mutex);\r\nfor (reg = 0; reg <= 0x17; reg++) {\r\nval = wm_get(ice, reg);\r\nsnd_iprintf(buffer, "%02x = %04x\n", reg, val);\r\n}\r\nmutex_unlock(&ice->gpio_mutex);\r\n}\r\nstatic void wm_proc_init(struct snd_ice1712 *ice)\r\n{\r\nstruct snd_info_entry *entry;\r\nif (! snd_card_proc_new(ice->card, "wm_codec", &entry)) {\r\nsnd_info_set_text_ops(entry, ice, wm_proc_regs_read);\r\nentry->mode |= S_IWUSR;\r\nentry->c.text.write = wm_proc_regs_write;\r\n}\r\n}\r\nstatic void cs_proc_regs_read(struct snd_info_entry *entry, struct snd_info_buffer *buffer)\r\n{\r\nstruct snd_ice1712 *ice = entry->private_data;\r\nint reg, val;\r\nmutex_lock(&ice->gpio_mutex);\r\nfor (reg = 0; reg <= 0x26; reg++) {\r\nval = spi_read(ice, CS_DEV, reg);\r\nsnd_iprintf(buffer, "%02x = %02x\n", reg, val);\r\n}\r\nval = spi_read(ice, CS_DEV, 0x7f);\r\nsnd_iprintf(buffer, "%02x = %02x\n", 0x7f, val);\r\nmutex_unlock(&ice->gpio_mutex);\r\n}\r\nstatic void cs_proc_init(struct snd_ice1712 *ice)\r\n{\r\nstruct snd_info_entry *entry;\r\nif (! snd_card_proc_new(ice->card, "cs_codec", &entry))\r\nsnd_info_set_text_ops(entry, ice, cs_proc_regs_read);\r\n}\r\nstatic int pontis_add_controls(struct snd_ice1712 *ice)\r\n{\r\nunsigned int i;\r\nint err;\r\nfor (i = 0; i < ARRAY_SIZE(pontis_controls); i++) {\r\nerr = snd_ctl_add(ice->card, snd_ctl_new1(&pontis_controls[i], ice));\r\nif (err < 0)\r\nreturn err;\r\n}\r\nwm_proc_init(ice);\r\ncs_proc_init(ice);\r\nreturn 0;\r\n}\r\nstatic int pontis_init(struct snd_ice1712 *ice)\r\n{\r\nstatic const unsigned short wm_inits[] = {\r\nWM_ADC_MUX, 0x00c0,\r\nWM_DAC_MUTE, 0x0001,\r\nWM_DAC_CTRL1, 0x0000,\r\nWM_POWERDOWN, 0x0008,\r\nWM_RESET, 0x0000,\r\n};\r\nstatic const unsigned short wm_inits2[] = {\r\nWM_MASTER_CTRL, 0x0022,\r\nWM_DAC_INT, 0x0022,\r\nWM_ADC_INT, 0x0022,\r\nWM_DAC_CTRL1, 0x0090,\r\nWM_OUT_MUX, 0x0001,\r\nWM_HP_ATTEN_L, 0x0179,\r\nWM_HP_ATTEN_R, 0x0179,\r\nWM_DAC_ATTEN_L, 0x0000,\r\nWM_DAC_ATTEN_L, 0x0100,\r\nWM_DAC_ATTEN_R, 0x0000,\r\nWM_DAC_ATTEN_R, 0x0100,\r\nWM_PHASE_SWAP, 0x0000,\r\nWM_DAC_CTRL2, 0x0000,\r\nWM_ADC_ATTEN_L, 0x0000,\r\nWM_ADC_ATTEN_R, 0x0000,\r\n#if 0\r\nWM_ALC_CTRL1, 0x007b,\r\nWM_ALC_CTRL2, 0x0000,\r\nWM_ALC_CTRL3, 0x0000,\r\nWM_NOISE_GATE, 0x0000,\r\n#endif\r\nWM_DAC_MUTE, 0x0000,\r\nWM_ADC_MUX, 0x0003,\r\n};\r\nstatic const unsigned char cs_inits[] = {\r\n0x04, 0x80,\r\n0x05, 0x05,\r\n0x01, 0x00,\r\n0x02, 0x00,\r\n0x03, 0x00,\r\n};\r\nunsigned int i;\r\nice->vt1720 = 1;\r\nice->num_total_dacs = 2;\r\nice->num_total_adcs = 2;\r\nice->akm = kzalloc(sizeof(struct snd_akm4xxx), GFP_KERNEL);\r\nif (! ice->akm)\r\nreturn -ENOMEM;\r\nice->akm_codecs = 1;\r\nice->gpio.saved[0] = 0;\r\nfor (i = 0; i < ARRAY_SIZE(wm_inits); i += 2)\r\nwm_put(ice, wm_inits[i], wm_inits[i+1]);\r\nschedule_timeout_uninterruptible(1);\r\nfor (i = 0; i < ARRAY_SIZE(wm_inits2); i += 2)\r\nwm_put(ice, wm_inits2[i], wm_inits2[i+1]);\r\noutb(inb(ICEMT1724(ice, AC97_CMD)) | 0x80, ICEMT1724(ice, AC97_CMD));\r\nmdelay(5);\r\noutb(inb(ICEMT1724(ice, AC97_CMD)) & ~0x80, ICEMT1724(ice, AC97_CMD));\r\nfor (i = 0; i < ARRAY_SIZE(cs_inits); i += 2)\r\nspi_write(ice, CS_DEV, cs_inits[i], cs_inits[i+1]);\r\nreturn 0;\r\n}

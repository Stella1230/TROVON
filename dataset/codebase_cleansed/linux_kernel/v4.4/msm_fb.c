static int msm_framebuffer_create_handle(struct drm_framebuffer *fb,\r\nstruct drm_file *file_priv,\r\nunsigned int *handle)\r\n{\r\nstruct msm_framebuffer *msm_fb = to_msm_framebuffer(fb);\r\nreturn drm_gem_handle_create(file_priv,\r\nmsm_fb->planes[0], handle);\r\n}\r\nstatic void msm_framebuffer_destroy(struct drm_framebuffer *fb)\r\n{\r\nstruct msm_framebuffer *msm_fb = to_msm_framebuffer(fb);\r\nint i, n = drm_format_num_planes(fb->pixel_format);\r\nDBG("destroy: FB ID: %d (%p)", fb->base.id, fb);\r\ndrm_framebuffer_cleanup(fb);\r\nfor (i = 0; i < n; i++) {\r\nstruct drm_gem_object *bo = msm_fb->planes[i];\r\nif (bo)\r\ndrm_gem_object_unreference_unlocked(bo);\r\n}\r\nkfree(msm_fb);\r\n}\r\nstatic int msm_framebuffer_dirty(struct drm_framebuffer *fb,\r\nstruct drm_file *file_priv, unsigned flags, unsigned color,\r\nstruct drm_clip_rect *clips, unsigned num_clips)\r\n{\r\nreturn 0;\r\n}\r\nvoid msm_framebuffer_describe(struct drm_framebuffer *fb, struct seq_file *m)\r\n{\r\nstruct msm_framebuffer *msm_fb = to_msm_framebuffer(fb);\r\nint i, n = drm_format_num_planes(fb->pixel_format);\r\nseq_printf(m, "fb: %dx%d@%4.4s (%2d, ID:%d)\n",\r\nfb->width, fb->height, (char *)&fb->pixel_format,\r\nfb->refcount.refcount.counter, fb->base.id);\r\nfor (i = 0; i < n; i++) {\r\nseq_printf(m, " %d: offset=%d pitch=%d, obj: ",\r\ni, fb->offsets[i], fb->pitches[i]);\r\nmsm_gem_describe(msm_fb->planes[i], m);\r\n}\r\n}\r\nint msm_framebuffer_prepare(struct drm_framebuffer *fb, int id)\r\n{\r\nstruct msm_framebuffer *msm_fb = to_msm_framebuffer(fb);\r\nint ret, i, n = drm_format_num_planes(fb->pixel_format);\r\nuint32_t iova;\r\nfor (i = 0; i < n; i++) {\r\nret = msm_gem_get_iova(msm_fb->planes[i], id, &iova);\r\nDBG("FB[%u]: iova[%d]: %08x (%d)", fb->base.id, i, iova, ret);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nvoid msm_framebuffer_cleanup(struct drm_framebuffer *fb, int id)\r\n{\r\nstruct msm_framebuffer *msm_fb = to_msm_framebuffer(fb);\r\nint i, n = drm_format_num_planes(fb->pixel_format);\r\nfor (i = 0; i < n; i++)\r\nmsm_gem_put_iova(msm_fb->planes[i], id);\r\n}\r\nuint32_t msm_framebuffer_iova(struct drm_framebuffer *fb, int id, int plane)\r\n{\r\nstruct msm_framebuffer *msm_fb = to_msm_framebuffer(fb);\r\nif (!msm_fb->planes[plane])\r\nreturn 0;\r\nreturn msm_gem_iova(msm_fb->planes[plane], id) + fb->offsets[plane];\r\n}\r\nstruct drm_gem_object *msm_framebuffer_bo(struct drm_framebuffer *fb, int plane)\r\n{\r\nstruct msm_framebuffer *msm_fb = to_msm_framebuffer(fb);\r\nreturn msm_fb->planes[plane];\r\n}\r\nconst struct msm_format *msm_framebuffer_format(struct drm_framebuffer *fb)\r\n{\r\nstruct msm_framebuffer *msm_fb = to_msm_framebuffer(fb);\r\nreturn msm_fb->format;\r\n}\r\nstruct drm_framebuffer *msm_framebuffer_create(struct drm_device *dev,\r\nstruct drm_file *file, struct drm_mode_fb_cmd2 *mode_cmd)\r\n{\r\nstruct drm_gem_object *bos[4] = {0};\r\nstruct drm_framebuffer *fb;\r\nint ret, i, n = drm_format_num_planes(mode_cmd->pixel_format);\r\nfor (i = 0; i < n; i++) {\r\nbos[i] = drm_gem_object_lookup(dev, file,\r\nmode_cmd->handles[i]);\r\nif (!bos[i]) {\r\nret = -ENXIO;\r\ngoto out_unref;\r\n}\r\n}\r\nfb = msm_framebuffer_init(dev, mode_cmd, bos);\r\nif (IS_ERR(fb)) {\r\nret = PTR_ERR(fb);\r\ngoto out_unref;\r\n}\r\nreturn fb;\r\nout_unref:\r\nfor (i = 0; i < n; i++)\r\ndrm_gem_object_unreference_unlocked(bos[i]);\r\nreturn ERR_PTR(ret);\r\n}\r\nstruct drm_framebuffer *msm_framebuffer_init(struct drm_device *dev,\r\nstruct drm_mode_fb_cmd2 *mode_cmd, struct drm_gem_object **bos)\r\n{\r\nstruct msm_drm_private *priv = dev->dev_private;\r\nstruct msm_kms *kms = priv->kms;\r\nstruct msm_framebuffer *msm_fb = NULL;\r\nstruct drm_framebuffer *fb;\r\nconst struct msm_format *format;\r\nint ret, i, n;\r\nunsigned int hsub, vsub;\r\nDBG("create framebuffer: dev=%p, mode_cmd=%p (%dx%d@%4.4s)",\r\ndev, mode_cmd, mode_cmd->width, mode_cmd->height,\r\n(char *)&mode_cmd->pixel_format);\r\nn = drm_format_num_planes(mode_cmd->pixel_format);\r\nhsub = drm_format_horz_chroma_subsampling(mode_cmd->pixel_format);\r\nvsub = drm_format_vert_chroma_subsampling(mode_cmd->pixel_format);\r\nformat = kms->funcs->get_format(kms, mode_cmd->pixel_format);\r\nif (!format) {\r\ndev_err(dev->dev, "unsupported pixel format: %4.4s\n",\r\n(char *)&mode_cmd->pixel_format);\r\nret = -EINVAL;\r\ngoto fail;\r\n}\r\nmsm_fb = kzalloc(sizeof(*msm_fb), GFP_KERNEL);\r\nif (!msm_fb) {\r\nret = -ENOMEM;\r\ngoto fail;\r\n}\r\nfb = &msm_fb->base;\r\nmsm_fb->format = format;\r\nif (n > ARRAY_SIZE(msm_fb->planes)) {\r\nret = -EINVAL;\r\ngoto fail;\r\n}\r\nfor (i = 0; i < n; i++) {\r\nunsigned int width = mode_cmd->width / (i ? hsub : 1);\r\nunsigned int height = mode_cmd->height / (i ? vsub : 1);\r\nunsigned int min_size;\r\nmin_size = (height - 1) * mode_cmd->pitches[i]\r\n+ width * drm_format_plane_cpp(mode_cmd->pixel_format, i)\r\n+ mode_cmd->offsets[i];\r\nif (bos[i]->size < min_size) {\r\nret = -EINVAL;\r\ngoto fail;\r\n}\r\nmsm_fb->planes[i] = bos[i];\r\n}\r\ndrm_helper_mode_fill_fb_struct(fb, mode_cmd);\r\nret = drm_framebuffer_init(dev, fb, &msm_framebuffer_funcs);\r\nif (ret) {\r\ndev_err(dev->dev, "framebuffer init failed: %d\n", ret);\r\ngoto fail;\r\n}\r\nDBG("create: FB ID: %d (%p)", fb->base.id, fb);\r\nreturn fb;\r\nfail:\r\nkfree(msm_fb);\r\nreturn ERR_PTR(ret);\r\n}

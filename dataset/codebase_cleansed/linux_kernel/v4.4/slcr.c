static int zynq_slcr_write(u32 val, u32 offset)\r\n{\r\nreturn regmap_write(zynq_slcr_regmap, offset, val);\r\n}\r\nstatic int zynq_slcr_read(u32 *val, u32 offset)\r\n{\r\nreturn regmap_read(zynq_slcr_regmap, offset, val);\r\n}\r\nstatic inline int zynq_slcr_unlock(void)\r\n{\r\nzynq_slcr_write(SLCR_UNLOCK_MAGIC, SLCR_UNLOCK_OFFSET);\r\nreturn 0;\r\n}\r\nu32 zynq_slcr_get_device_id(void)\r\n{\r\nu32 val;\r\nzynq_slcr_read(&val, SLCR_PSS_IDCODE);\r\nval >>= SLCR_PSS_IDCODE_DEVICE_SHIFT;\r\nval &= SLCR_PSS_IDCODE_DEVICE_MASK;\r\nreturn val;\r\n}\r\nstatic\r\nint zynq_slcr_system_restart(struct notifier_block *nb,\r\nunsigned long action, void *data)\r\n{\r\nu32 reboot;\r\nzynq_slcr_read(&reboot, SLCR_REBOOT_STATUS_OFFSET);\r\nzynq_slcr_write(reboot & 0xF0FFFFFF, SLCR_REBOOT_STATUS_OFFSET);\r\nzynq_slcr_write(1, SLCR_PS_RST_CTRL_OFFSET);\r\nreturn 0;\r\n}\r\nvoid zynq_slcr_cpu_start(int cpu)\r\n{\r\nu32 reg;\r\nzynq_slcr_read(&reg, SLCR_A9_CPU_RST_CTRL_OFFSET);\r\nreg &= ~(SLCR_A9_CPU_RST << cpu);\r\nzynq_slcr_write(reg, SLCR_A9_CPU_RST_CTRL_OFFSET);\r\nreg &= ~(SLCR_A9_CPU_CLKSTOP << cpu);\r\nzynq_slcr_write(reg, SLCR_A9_CPU_RST_CTRL_OFFSET);\r\nzynq_slcr_cpu_state_write(cpu, false);\r\n}\r\nvoid zynq_slcr_cpu_stop(int cpu)\r\n{\r\nu32 reg;\r\nzynq_slcr_read(&reg, SLCR_A9_CPU_RST_CTRL_OFFSET);\r\nreg |= (SLCR_A9_CPU_CLKSTOP | SLCR_A9_CPU_RST) << cpu;\r\nzynq_slcr_write(reg, SLCR_A9_CPU_RST_CTRL_OFFSET);\r\n}\r\nbool zynq_slcr_cpu_state_read(int cpu)\r\n{\r\nu32 state;\r\nstate = readl(zynq_slcr_base + SLCR_REBOOT_STATUS_OFFSET);\r\nstate &= 1 << (31 - cpu);\r\nreturn !state;\r\n}\r\nvoid zynq_slcr_cpu_state_write(int cpu, bool die)\r\n{\r\nu32 state, mask;\r\nstate = readl(zynq_slcr_base + SLCR_REBOOT_STATUS_OFFSET);\r\nmask = 1 << (31 - cpu);\r\nif (die)\r\nstate |= mask;\r\nelse\r\nstate &= ~mask;\r\nwritel(state, zynq_slcr_base + SLCR_REBOOT_STATUS_OFFSET);\r\n}\r\nint __init zynq_early_slcr_init(void)\r\n{\r\nstruct device_node *np;\r\nnp = of_find_compatible_node(NULL, NULL, "xlnx,zynq-slcr");\r\nif (!np) {\r\npr_err("%s: no slcr node found\n", __func__);\r\nBUG();\r\n}\r\nzynq_slcr_base = of_iomap(np, 0);\r\nif (!zynq_slcr_base) {\r\npr_err("%s: Unable to map I/O memory\n", __func__);\r\nBUG();\r\n}\r\nnp->data = (__force void *)zynq_slcr_base;\r\nzynq_slcr_regmap = syscon_regmap_lookup_by_compatible("xlnx,zynq-slcr");\r\nif (IS_ERR(zynq_slcr_regmap)) {\r\npr_err("%s: failed to find zynq-slcr\n", __func__);\r\nreturn -ENODEV;\r\n}\r\nzynq_slcr_unlock();\r\nregister_restart_handler(&zynq_slcr_restart_nb);\r\npr_info("%s mapped to %p\n", np->name, zynq_slcr_base);\r\nof_node_put(np);\r\nreturn 0;\r\n}

static bool\r\ni915_tiling_ok(struct drm_device *dev, int stride, int size, int tiling_mode)\r\n{\r\nint tile_width;\r\nif (tiling_mode == I915_TILING_NONE)\r\nreturn true;\r\nif (IS_GEN2(dev) ||\r\n(tiling_mode == I915_TILING_Y && HAS_128_BYTE_Y_TILING(dev)))\r\ntile_width = 128;\r\nelse\r\ntile_width = 512;\r\nif (INTEL_INFO(dev)->gen >= 7) {\r\nif (stride / 128 > GEN7_FENCE_MAX_PITCH_VAL)\r\nreturn false;\r\n} else if (INTEL_INFO(dev)->gen >= 4) {\r\nif (stride / 128 > I965_FENCE_MAX_PITCH_VAL)\r\nreturn false;\r\n} else {\r\nif (stride > 8192)\r\nreturn false;\r\nif (IS_GEN3(dev)) {\r\nif (size > I830_FENCE_MAX_SIZE_VAL << 20)\r\nreturn false;\r\n} else {\r\nif (size > I830_FENCE_MAX_SIZE_VAL << 19)\r\nreturn false;\r\n}\r\n}\r\nif (stride < tile_width)\r\nreturn false;\r\nif (INTEL_INFO(dev)->gen >= 4) {\r\nif (stride & (tile_width - 1))\r\nreturn false;\r\nreturn true;\r\n}\r\nif (stride & (stride - 1))\r\nreturn false;\r\nreturn true;\r\n}\r\nstatic bool\r\ni915_gem_object_fence_ok(struct drm_i915_gem_object *obj, int tiling_mode)\r\n{\r\nu32 size;\r\nif (tiling_mode == I915_TILING_NONE)\r\nreturn true;\r\nif (INTEL_INFO(obj->base.dev)->gen >= 4)\r\nreturn true;\r\nif (INTEL_INFO(obj->base.dev)->gen == 3) {\r\nif (i915_gem_obj_ggtt_offset(obj) & ~I915_FENCE_START_MASK)\r\nreturn false;\r\n} else {\r\nif (i915_gem_obj_ggtt_offset(obj) & ~I830_FENCE_START_MASK)\r\nreturn false;\r\n}\r\nsize = i915_gem_get_gtt_size(obj->base.dev, obj->base.size, tiling_mode);\r\nif (i915_gem_obj_ggtt_size(obj) != size)\r\nreturn false;\r\nif (i915_gem_obj_ggtt_offset(obj) & (size - 1))\r\nreturn false;\r\nreturn true;\r\n}\r\nint\r\ni915_gem_set_tiling(struct drm_device *dev, void *data,\r\nstruct drm_file *file)\r\n{\r\nstruct drm_i915_gem_set_tiling *args = data;\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nstruct drm_i915_gem_object *obj;\r\nint ret = 0;\r\nobj = to_intel_bo(drm_gem_object_lookup(dev, file, args->handle));\r\nif (&obj->base == NULL)\r\nreturn -ENOENT;\r\nif (!i915_tiling_ok(dev,\r\nargs->stride, obj->base.size, args->tiling_mode)) {\r\ndrm_gem_object_unreference_unlocked(&obj->base);\r\nreturn -EINVAL;\r\n}\r\nmutex_lock(&dev->struct_mutex);\r\nif (obj->pin_display || obj->framebuffer_references) {\r\nret = -EBUSY;\r\ngoto err;\r\n}\r\nif (args->tiling_mode == I915_TILING_NONE) {\r\nargs->swizzle_mode = I915_BIT_6_SWIZZLE_NONE;\r\nargs->stride = 0;\r\n} else {\r\nif (args->tiling_mode == I915_TILING_X)\r\nargs->swizzle_mode = dev_priv->mm.bit_6_swizzle_x;\r\nelse\r\nargs->swizzle_mode = dev_priv->mm.bit_6_swizzle_y;\r\nif (args->swizzle_mode == I915_BIT_6_SWIZZLE_9_17)\r\nargs->swizzle_mode = I915_BIT_6_SWIZZLE_9;\r\nif (args->swizzle_mode == I915_BIT_6_SWIZZLE_9_10_17)\r\nargs->swizzle_mode = I915_BIT_6_SWIZZLE_9_10;\r\nif (args->swizzle_mode == I915_BIT_6_SWIZZLE_UNKNOWN) {\r\nargs->tiling_mode = I915_TILING_NONE;\r\nargs->swizzle_mode = I915_BIT_6_SWIZZLE_NONE;\r\nargs->stride = 0;\r\n}\r\n}\r\nif (args->tiling_mode != obj->tiling_mode ||\r\nargs->stride != obj->stride) {\r\nif (obj->map_and_fenceable &&\r\n!i915_gem_object_fence_ok(obj, args->tiling_mode))\r\nret = i915_gem_object_ggtt_unbind(obj);\r\nif (ret == 0) {\r\nif (obj->pages &&\r\nobj->madv == I915_MADV_WILLNEED &&\r\ndev_priv->quirks & QUIRK_PIN_SWIZZLED_PAGES) {\r\nif (args->tiling_mode == I915_TILING_NONE)\r\ni915_gem_object_unpin_pages(obj);\r\nif (obj->tiling_mode == I915_TILING_NONE)\r\ni915_gem_object_pin_pages(obj);\r\n}\r\nobj->fence_dirty =\r\nobj->last_fenced_req ||\r\nobj->fence_reg != I915_FENCE_REG_NONE;\r\nobj->tiling_mode = args->tiling_mode;\r\nobj->stride = args->stride;\r\ni915_gem_release_mmap(obj);\r\n}\r\n}\r\nargs->stride = obj->stride;\r\nargs->tiling_mode = obj->tiling_mode;\r\nif (i915_gem_object_needs_bit17_swizzle(obj)) {\r\nif (obj->bit_17 == NULL) {\r\nobj->bit_17 = kcalloc(BITS_TO_LONGS(obj->base.size >> PAGE_SHIFT),\r\nsizeof(long), GFP_KERNEL);\r\n}\r\n} else {\r\nkfree(obj->bit_17);\r\nobj->bit_17 = NULL;\r\n}\r\nerr:\r\ndrm_gem_object_unreference(&obj->base);\r\nmutex_unlock(&dev->struct_mutex);\r\nreturn ret;\r\n}\r\nint\r\ni915_gem_get_tiling(struct drm_device *dev, void *data,\r\nstruct drm_file *file)\r\n{\r\nstruct drm_i915_gem_get_tiling *args = data;\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nstruct drm_i915_gem_object *obj;\r\nobj = to_intel_bo(drm_gem_object_lookup(dev, file, args->handle));\r\nif (&obj->base == NULL)\r\nreturn -ENOENT;\r\nmutex_lock(&dev->struct_mutex);\r\nargs->tiling_mode = obj->tiling_mode;\r\nswitch (obj->tiling_mode) {\r\ncase I915_TILING_X:\r\nargs->swizzle_mode = dev_priv->mm.bit_6_swizzle_x;\r\nbreak;\r\ncase I915_TILING_Y:\r\nargs->swizzle_mode = dev_priv->mm.bit_6_swizzle_y;\r\nbreak;\r\ncase I915_TILING_NONE:\r\nargs->swizzle_mode = I915_BIT_6_SWIZZLE_NONE;\r\nbreak;\r\ndefault:\r\nDRM_ERROR("unknown tiling mode\n");\r\n}\r\nif (dev_priv->quirks & QUIRK_PIN_SWIZZLED_PAGES)\r\nargs->phys_swizzle_mode = I915_BIT_6_SWIZZLE_UNKNOWN;\r\nelse\r\nargs->phys_swizzle_mode = args->swizzle_mode;\r\nif (args->swizzle_mode == I915_BIT_6_SWIZZLE_9_17)\r\nargs->swizzle_mode = I915_BIT_6_SWIZZLE_9;\r\nif (args->swizzle_mode == I915_BIT_6_SWIZZLE_9_10_17)\r\nargs->swizzle_mode = I915_BIT_6_SWIZZLE_9_10;\r\ndrm_gem_object_unreference(&obj->base);\r\nmutex_unlock(&dev->struct_mutex);\r\nreturn 0;\r\n}

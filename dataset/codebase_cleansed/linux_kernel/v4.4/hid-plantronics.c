static int plantronics_input_mapping(struct hid_device *hdev,\r\nstruct hid_input *hi,\r\nstruct hid_field *field,\r\nstruct hid_usage *usage,\r\nunsigned long **bit, int *max)\r\n{\r\nunsigned short mapped_key;\r\nunsigned long plt_type = (unsigned long)hid_get_drvdata(hdev);\r\nif (!(plt_type & HID_USAGE_PAGE)) {\r\nswitch (plt_type) {\r\ncase PLT_DA60:\r\nif (PLT_ALLOW_CONSUMER)\r\ngoto defaulted;\r\ngoto ignored;\r\ndefault:\r\nif (PLT_ALLOW_CONSUMER)\r\ngoto defaulted;\r\n}\r\n}\r\nelse if ((plt_type & HID_USAGE) >= PLT_BASIC_TELEPHONY &&\r\n(plt_type & HID_USAGE) != PLT_BASIC_EXCEPTION) {\r\nif (PLT_ALLOW_CONSUMER)\r\ngoto defaulted;\r\n}\r\nelse if (!((field->application ^ plt_type) & HID_USAGE_PAGE)) {\r\nswitch (usage->hid) {\r\ncase PLT1_VOL_UP:\r\ncase PLT2_VOL_UP:\r\nmapped_key = KEY_VOLUMEUP;\r\ngoto mapped;\r\ncase PLT1_VOL_DOWN:\r\ncase PLT2_VOL_DOWN:\r\nmapped_key = KEY_VOLUMEDOWN;\r\ngoto mapped;\r\n}\r\n}\r\nignored:\r\nreturn -1;\r\ndefaulted:\r\nhid_dbg(hdev, "usage: %08x (appl: %08x) - defaulted\n",\r\nusage->hid, field->application);\r\nreturn 0;\r\nmapped:\r\nhid_map_usage_clear(hi, usage, bit, max, EV_KEY, mapped_key);\r\nhid_dbg(hdev, "usage: %08x (appl: %08x) - mapped to key %d\n",\r\nusage->hid, field->application, mapped_key);\r\nreturn 1;\r\n}\r\nstatic unsigned long plantronics_device_type(struct hid_device *hdev)\r\n{\r\nunsigned i, col_page;\r\nunsigned long plt_type = hdev->product;\r\nif (plt_type >= PLT_BT300_MIN && plt_type <= PLT_BT300_MAX)\r\ngoto exit;\r\nfor (i = 0; i < hdev->maxcollection; i++) {\r\ncol_page = hdev->collection[i].usage & HID_USAGE_PAGE;\r\nif (col_page == PLT_HID_2_0_PAGE) {\r\nplt_type = hdev->collection[i].usage;\r\nbreak;\r\n}\r\nif (col_page == PLT_HID_1_0_PAGE)\r\nplt_type = hdev->collection[i].usage;\r\n}\r\nexit:\r\nhid_dbg(hdev, "plt_type decoded as: %08lx\n", plt_type);\r\nreturn plt_type;\r\n}\r\nstatic int plantronics_probe(struct hid_device *hdev,\r\nconst struct hid_device_id *id)\r\n{\r\nint ret;\r\nret = hid_parse(hdev);\r\nif (ret) {\r\nhid_err(hdev, "parse failed\n");\r\ngoto err;\r\n}\r\nhid_set_drvdata(hdev, (void *)plantronics_device_type(hdev));\r\nret = hid_hw_start(hdev, HID_CONNECT_DEFAULT |\r\nHID_CONNECT_HIDINPUT_FORCE | HID_CONNECT_HIDDEV_FORCE);\r\nif (ret)\r\nhid_err(hdev, "hw start failed\n");\r\nerr:\r\nreturn ret;\r\n}

static ssize_t arcmsr_sysfs_iop_message_read(struct file *filp,\r\nstruct kobject *kobj,\r\nstruct bin_attribute *bin,\r\nchar *buf, loff_t off,\r\nsize_t count)\r\n{\r\nstruct device *dev = container_of(kobj,struct device,kobj);\r\nstruct Scsi_Host *host = class_to_shost(dev);\r\nstruct AdapterControlBlock *acb = (struct AdapterControlBlock *) host->hostdata;\r\nuint8_t *ptmpQbuffer;\r\nint32_t allxfer_len = 0;\r\nunsigned long flags;\r\nif (!capable(CAP_SYS_ADMIN))\r\nreturn -EACCES;\r\nptmpQbuffer = (uint8_t *)buf;\r\nspin_lock_irqsave(&acb->rqbuffer_lock, flags);\r\nif (acb->rqbuf_getIndex != acb->rqbuf_putIndex) {\r\nunsigned int tail = acb->rqbuf_getIndex;\r\nunsigned int head = acb->rqbuf_putIndex;\r\nunsigned int cnt_to_end = CIRC_CNT_TO_END(head, tail, ARCMSR_MAX_QBUFFER);\r\nallxfer_len = CIRC_CNT(head, tail, ARCMSR_MAX_QBUFFER);\r\nif (allxfer_len > ARCMSR_API_DATA_BUFLEN)\r\nallxfer_len = ARCMSR_API_DATA_BUFLEN;\r\nif (allxfer_len <= cnt_to_end)\r\nmemcpy(ptmpQbuffer, acb->rqbuffer + tail, allxfer_len);\r\nelse {\r\nmemcpy(ptmpQbuffer, acb->rqbuffer + tail, cnt_to_end);\r\nmemcpy(ptmpQbuffer + cnt_to_end, acb->rqbuffer, allxfer_len - cnt_to_end);\r\n}\r\nacb->rqbuf_getIndex = (acb->rqbuf_getIndex + allxfer_len) % ARCMSR_MAX_QBUFFER;\r\n}\r\nif (acb->acb_flags & ACB_F_IOPDATA_OVERFLOW) {\r\nstruct QBUFFER __iomem *prbuffer;\r\nacb->acb_flags &= ~ACB_F_IOPDATA_OVERFLOW;\r\nprbuffer = arcmsr_get_iop_rqbuffer(acb);\r\nif (arcmsr_Read_iop_rqbuffer_data(acb, prbuffer) == 0)\r\nacb->acb_flags |= ACB_F_IOPDATA_OVERFLOW;\r\n}\r\nspin_unlock_irqrestore(&acb->rqbuffer_lock, flags);\r\nreturn allxfer_len;\r\n}\r\nstatic ssize_t arcmsr_sysfs_iop_message_write(struct file *filp,\r\nstruct kobject *kobj,\r\nstruct bin_attribute *bin,\r\nchar *buf, loff_t off,\r\nsize_t count)\r\n{\r\nstruct device *dev = container_of(kobj,struct device,kobj);\r\nstruct Scsi_Host *host = class_to_shost(dev);\r\nstruct AdapterControlBlock *acb = (struct AdapterControlBlock *) host->hostdata;\r\nint32_t user_len, cnt2end;\r\nuint8_t *pQbuffer, *ptmpuserbuffer;\r\nunsigned long flags;\r\nif (!capable(CAP_SYS_ADMIN))\r\nreturn -EACCES;\r\nif (count > ARCMSR_API_DATA_BUFLEN)\r\nreturn -EINVAL;\r\nptmpuserbuffer = (uint8_t *)buf;\r\nuser_len = (int32_t)count;\r\nspin_lock_irqsave(&acb->wqbuffer_lock, flags);\r\nif (acb->wqbuf_putIndex != acb->wqbuf_getIndex) {\r\narcmsr_write_ioctldata2iop(acb);\r\nspin_unlock_irqrestore(&acb->wqbuffer_lock, flags);\r\nreturn 0;\r\n} else {\r\npQbuffer = &acb->wqbuffer[acb->wqbuf_putIndex];\r\ncnt2end = ARCMSR_MAX_QBUFFER - acb->wqbuf_putIndex;\r\nif (user_len > cnt2end) {\r\nmemcpy(pQbuffer, ptmpuserbuffer, cnt2end);\r\nptmpuserbuffer += cnt2end;\r\nuser_len -= cnt2end;\r\nacb->wqbuf_putIndex = 0;\r\npQbuffer = acb->wqbuffer;\r\n}\r\nmemcpy(pQbuffer, ptmpuserbuffer, user_len);\r\nacb->wqbuf_putIndex += user_len;\r\nacb->wqbuf_putIndex %= ARCMSR_MAX_QBUFFER;\r\nif (acb->acb_flags & ACB_F_MESSAGE_WQBUFFER_CLEARED) {\r\nacb->acb_flags &=\r\n~ACB_F_MESSAGE_WQBUFFER_CLEARED;\r\narcmsr_write_ioctldata2iop(acb);\r\n}\r\nspin_unlock_irqrestore(&acb->wqbuffer_lock, flags);\r\nreturn count;\r\n}\r\n}\r\nstatic ssize_t arcmsr_sysfs_iop_message_clear(struct file *filp,\r\nstruct kobject *kobj,\r\nstruct bin_attribute *bin,\r\nchar *buf, loff_t off,\r\nsize_t count)\r\n{\r\nstruct device *dev = container_of(kobj,struct device,kobj);\r\nstruct Scsi_Host *host = class_to_shost(dev);\r\nstruct AdapterControlBlock *acb = (struct AdapterControlBlock *) host->hostdata;\r\nuint8_t *pQbuffer;\r\nunsigned long flags;\r\nif (!capable(CAP_SYS_ADMIN))\r\nreturn -EACCES;\r\narcmsr_clear_iop2drv_rqueue_buffer(acb);\r\nacb->acb_flags |=\r\n(ACB_F_MESSAGE_WQBUFFER_CLEARED\r\n| ACB_F_MESSAGE_RQBUFFER_CLEARED\r\n| ACB_F_MESSAGE_WQBUFFER_READED);\r\nspin_lock_irqsave(&acb->rqbuffer_lock, flags);\r\nacb->rqbuf_getIndex = 0;\r\nacb->rqbuf_putIndex = 0;\r\nspin_unlock_irqrestore(&acb->rqbuffer_lock, flags);\r\nspin_lock_irqsave(&acb->wqbuffer_lock, flags);\r\nacb->wqbuf_getIndex = 0;\r\nacb->wqbuf_putIndex = 0;\r\nspin_unlock_irqrestore(&acb->wqbuffer_lock, flags);\r\npQbuffer = acb->rqbuffer;\r\nmemset(pQbuffer, 0, sizeof (struct QBUFFER));\r\npQbuffer = acb->wqbuffer;\r\nmemset(pQbuffer, 0, sizeof (struct QBUFFER));\r\nreturn 1;\r\n}\r\nint arcmsr_alloc_sysfs_attr(struct AdapterControlBlock *acb)\r\n{\r\nstruct Scsi_Host *host = acb->host;\r\nint error;\r\nerror = sysfs_create_bin_file(&host->shost_dev.kobj, &arcmsr_sysfs_message_read_attr);\r\nif (error) {\r\nprintk(KERN_ERR "arcmsr: alloc sysfs mu_read failed\n");\r\ngoto error_bin_file_message_read;\r\n}\r\nerror = sysfs_create_bin_file(&host->shost_dev.kobj, &arcmsr_sysfs_message_write_attr);\r\nif (error) {\r\nprintk(KERN_ERR "arcmsr: alloc sysfs mu_write failed\n");\r\ngoto error_bin_file_message_write;\r\n}\r\nerror = sysfs_create_bin_file(&host->shost_dev.kobj, &arcmsr_sysfs_message_clear_attr);\r\nif (error) {\r\nprintk(KERN_ERR "arcmsr: alloc sysfs mu_clear failed\n");\r\ngoto error_bin_file_message_clear;\r\n}\r\nreturn 0;\r\nerror_bin_file_message_clear:\r\nsysfs_remove_bin_file(&host->shost_dev.kobj, &arcmsr_sysfs_message_write_attr);\r\nerror_bin_file_message_write:\r\nsysfs_remove_bin_file(&host->shost_dev.kobj, &arcmsr_sysfs_message_read_attr);\r\nerror_bin_file_message_read:\r\nreturn error;\r\n}\r\nvoid arcmsr_free_sysfs_attr(struct AdapterControlBlock *acb)\r\n{\r\nstruct Scsi_Host *host = acb->host;\r\nsysfs_remove_bin_file(&host->shost_dev.kobj, &arcmsr_sysfs_message_clear_attr);\r\nsysfs_remove_bin_file(&host->shost_dev.kobj, &arcmsr_sysfs_message_write_attr);\r\nsysfs_remove_bin_file(&host->shost_dev.kobj, &arcmsr_sysfs_message_read_attr);\r\n}\r\nstatic ssize_t\r\narcmsr_attr_host_driver_version(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn snprintf(buf, PAGE_SIZE,\r\n"%s\n",\r\nARCMSR_DRIVER_VERSION);\r\n}\r\nstatic ssize_t\r\narcmsr_attr_host_driver_posted_cmd(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct Scsi_Host *host = class_to_shost(dev);\r\nstruct AdapterControlBlock *acb =\r\n(struct AdapterControlBlock *) host->hostdata;\r\nreturn snprintf(buf, PAGE_SIZE,\r\n"%4d\n",\r\natomic_read(&acb->ccboutstandingcount));\r\n}\r\nstatic ssize_t\r\narcmsr_attr_host_driver_reset(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct Scsi_Host *host = class_to_shost(dev);\r\nstruct AdapterControlBlock *acb =\r\n(struct AdapterControlBlock *) host->hostdata;\r\nreturn snprintf(buf, PAGE_SIZE,\r\n"%4d\n",\r\nacb->num_resets);\r\n}\r\nstatic ssize_t\r\narcmsr_attr_host_driver_abort(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct Scsi_Host *host = class_to_shost(dev);\r\nstruct AdapterControlBlock *acb =\r\n(struct AdapterControlBlock *) host->hostdata;\r\nreturn snprintf(buf, PAGE_SIZE,\r\n"%4d\n",\r\nacb->num_aborts);\r\n}\r\nstatic ssize_t\r\narcmsr_attr_host_fw_model(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct Scsi_Host *host = class_to_shost(dev);\r\nstruct AdapterControlBlock *acb =\r\n(struct AdapterControlBlock *) host->hostdata;\r\nreturn snprintf(buf, PAGE_SIZE,\r\n"%s\n",\r\nacb->firm_model);\r\n}\r\nstatic ssize_t\r\narcmsr_attr_host_fw_version(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct Scsi_Host *host = class_to_shost(dev);\r\nstruct AdapterControlBlock *acb =\r\n(struct AdapterControlBlock *) host->hostdata;\r\nreturn snprintf(buf, PAGE_SIZE,\r\n"%s\n",\r\nacb->firm_version);\r\n}\r\nstatic ssize_t\r\narcmsr_attr_host_fw_request_len(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct Scsi_Host *host = class_to_shost(dev);\r\nstruct AdapterControlBlock *acb =\r\n(struct AdapterControlBlock *) host->hostdata;\r\nreturn snprintf(buf, PAGE_SIZE,\r\n"%4d\n",\r\nacb->firm_request_len);\r\n}\r\nstatic ssize_t\r\narcmsr_attr_host_fw_numbers_queue(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct Scsi_Host *host = class_to_shost(dev);\r\nstruct AdapterControlBlock *acb =\r\n(struct AdapterControlBlock *) host->hostdata;\r\nreturn snprintf(buf, PAGE_SIZE,\r\n"%4d\n",\r\nacb->firm_numbers_queue);\r\n}\r\nstatic ssize_t\r\narcmsr_attr_host_fw_sdram_size(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct Scsi_Host *host = class_to_shost(dev);\r\nstruct AdapterControlBlock *acb =\r\n(struct AdapterControlBlock *) host->hostdata;\r\nreturn snprintf(buf, PAGE_SIZE,\r\n"%4d\n",\r\nacb->firm_sdram_size);\r\n}\r\nstatic ssize_t\r\narcmsr_attr_host_fw_hd_channels(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct Scsi_Host *host = class_to_shost(dev);\r\nstruct AdapterControlBlock *acb =\r\n(struct AdapterControlBlock *) host->hostdata;\r\nreturn snprintf(buf, PAGE_SIZE,\r\n"%4d\n",\r\nacb->firm_hd_channels);\r\n}

static irqreturn_t fsg_power_handler(int irq, void *dev_id)\r\n{\r\nctrl_alt_del();\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t fsg_reset_handler(int irq, void *dev_id)\r\n{\r\nprintk(KERN_INFO "Restarting system.\n");\r\nmachine_restart(NULL);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void __init fsg_init(void)\r\n{\r\nuint8_t __iomem *f;\r\nixp4xx_sys_init();\r\nfsg_flash_resource.start = IXP4XX_EXP_BUS_BASE(0);\r\nfsg_flash_resource.end =\r\nIXP4XX_EXP_BUS_BASE(0) + ixp4xx_exp_bus_size - 1;\r\n*IXP4XX_EXP_CS0 |= IXP4XX_FLASH_WRITABLE;\r\n*IXP4XX_EXP_CS1 = *IXP4XX_EXP_CS0;\r\n*IXP4XX_EXP_CS2 = 0xbfff0002;\r\ni2c_register_board_info(0, fsg_i2c_board_info,\r\nARRAY_SIZE(fsg_i2c_board_info));\r\n(void)platform_device_register(&fsg_uart);\r\nplatform_add_devices(fsg_devices, ARRAY_SIZE(fsg_devices));\r\nif (request_irq(gpio_to_irq(FSG_RB_GPIO), &fsg_reset_handler,\r\nIRQF_TRIGGER_LOW, "FSG reset button", NULL) < 0) {\r\nprintk(KERN_DEBUG "Reset Button IRQ %d not available\n",\r\ngpio_to_irq(FSG_RB_GPIO));\r\n}\r\nif (request_irq(gpio_to_irq(FSG_SB_GPIO), &fsg_power_handler,\r\nIRQF_TRIGGER_LOW, "FSG power button", NULL) < 0) {\r\nprintk(KERN_DEBUG "Power Button IRQ %d not available\n",\r\ngpio_to_irq(FSG_SB_GPIO));\r\n}\r\nf = ioremap(IXP4XX_EXP_BUS_BASE(0), 0x400000);\r\nif (f) {\r\n#ifdef __ARMEB__\r\nint i;\r\nfor (i = 0; i < 6; i++) {\r\nfsg_plat_eth[0].hwaddr[i] = readb(f + 0x3C0422 + i);\r\nfsg_plat_eth[1].hwaddr[i] = readb(f + 0x3C043B + i);\r\n}\r\n#else\r\nfsg_plat_eth[0].hwaddr[0] = readb(f + 0x3C0421);\r\nfsg_plat_eth[0].hwaddr[1] = readb(f + 0x3C0420);\r\nfsg_plat_eth[0].hwaddr[2] = readb(f + 0x3C0427);\r\nfsg_plat_eth[0].hwaddr[3] = readb(f + 0x3C0426);\r\nfsg_plat_eth[0].hwaddr[4] = readb(f + 0x3C0425);\r\nfsg_plat_eth[0].hwaddr[5] = readb(f + 0x3C0424);\r\nfsg_plat_eth[1].hwaddr[0] = readb(f + 0x3C0439);\r\nfsg_plat_eth[1].hwaddr[1] = readb(f + 0x3C043F);\r\nfsg_plat_eth[1].hwaddr[2] = readb(f + 0x3C043E);\r\nfsg_plat_eth[1].hwaddr[3] = readb(f + 0x3C043D);\r\nfsg_plat_eth[1].hwaddr[4] = readb(f + 0x3C043C);\r\nfsg_plat_eth[1].hwaddr[5] = readb(f + 0x3C0443);\r\n#endif\r\niounmap(f);\r\n}\r\nprintk(KERN_INFO "FSG: Using MAC address %pM for port 0\n",\r\nfsg_plat_eth[0].hwaddr);\r\nprintk(KERN_INFO "FSG: Using MAC address %pM for port 1\n",\r\nfsg_plat_eth[1].hwaddr);\r\n}

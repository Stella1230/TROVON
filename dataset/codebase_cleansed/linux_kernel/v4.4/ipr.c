static inline struct ipr_desc *get_ipr_desc(struct irq_data *data)\r\n{\r\nstruct irq_chip *chip = irq_data_get_irq_chip(data);\r\nreturn container_of(chip, struct ipr_desc, chip);\r\n}\r\nstatic void disable_ipr_irq(struct irq_data *data)\r\n{\r\nstruct ipr_data *p = irq_data_get_irq_chip_data(data);\r\nunsigned long addr = get_ipr_desc(data)->ipr_offsets[p->ipr_idx];\r\n__raw_writew(__raw_readw(addr) & (0xffff ^ (0xf << p->shift)), addr);\r\n(void)__raw_readw(addr);\r\n}\r\nstatic void enable_ipr_irq(struct irq_data *data)\r\n{\r\nstruct ipr_data *p = irq_data_get_irq_chip_data(data);\r\nunsigned long addr = get_ipr_desc(data)->ipr_offsets[p->ipr_idx];\r\n__raw_writew(__raw_readw(addr) | (p->priority << p->shift), addr);\r\n}\r\nvoid register_ipr_controller(struct ipr_desc *desc)\r\n{\r\nint i;\r\ndesc->chip.irq_mask = disable_ipr_irq;\r\ndesc->chip.irq_unmask = enable_ipr_irq;\r\nfor (i = 0; i < desc->nr_irqs; i++) {\r\nstruct ipr_data *p = desc->ipr_data + i;\r\nint res;\r\nBUG_ON(p->ipr_idx >= desc->nr_offsets);\r\nBUG_ON(!desc->ipr_offsets[p->ipr_idx]);\r\nres = irq_alloc_desc_at(p->irq, numa_node_id());\r\nif (unlikely(res != p->irq && res != -EEXIST)) {\r\nprintk(KERN_INFO "can not get irq_desc for %d\n",\r\np->irq);\r\ncontinue;\r\n}\r\ndisable_irq_nosync(p->irq);\r\nirq_set_chip_and_handler_name(p->irq, &desc->chip,\r\nhandle_level_irq, "level");\r\nirq_set_chip_data(p->irq, p);\r\ndisable_ipr_irq(irq_get_irq_data(p->irq));\r\n}\r\n}

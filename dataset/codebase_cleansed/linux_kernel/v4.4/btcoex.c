void ath9k_hw_init_btcoex_hw(struct ath_hw *ah, int qnum)\r\n{\r\nstruct ath_btcoex_hw *btcoex_hw = &ah->btcoex_hw;\r\nconst struct ath_btcoex_config ath_bt_config = {\r\n.bt_time_extend = 0,\r\n.bt_txstate_extend = true,\r\n.bt_txframe_extend = true,\r\n.bt_mode = ATH_BT_COEX_MODE_SLOTTED,\r\n.bt_quiet_collision = true,\r\n.bt_rxclear_polarity = true,\r\n.bt_priority_time = 2,\r\n.bt_first_slot_time = 5,\r\n.bt_hold_rx_clear = true,\r\n};\r\nbool rxclear_polarity = ath_bt_config.bt_rxclear_polarity;\r\nif (AR_SREV_9300_20_OR_LATER(ah))\r\nrxclear_polarity = !ath_bt_config.bt_rxclear_polarity;\r\nbtcoex_hw->bt_coex_mode =\r\n(btcoex_hw->bt_coex_mode & AR_BT_QCU_THRESH) |\r\nSM(ath_bt_config.bt_time_extend, AR_BT_TIME_EXTEND) |\r\nSM(ath_bt_config.bt_txstate_extend, AR_BT_TXSTATE_EXTEND) |\r\nSM(ath_bt_config.bt_txframe_extend, AR_BT_TX_FRAME_EXTEND) |\r\nSM(ath_bt_config.bt_mode, AR_BT_MODE) |\r\nSM(ath_bt_config.bt_quiet_collision, AR_BT_QUIET) |\r\nSM(rxclear_polarity, AR_BT_RX_CLEAR_POLARITY) |\r\nSM(ath_bt_config.bt_priority_time, AR_BT_PRIORITY_TIME) |\r\nSM(ath_bt_config.bt_first_slot_time, AR_BT_FIRST_SLOT_TIME) |\r\nSM(qnum, AR_BT_QCU_THRESH);\r\nbtcoex_hw->bt_coex_mode2 =\r\nSM(ath_bt_config.bt_hold_rx_clear, AR_BT_HOLD_RX_CLEAR) |\r\nSM(ATH_BTCOEX_BMISS_THRESH, AR_BT_BCN_MISS_THRESH) |\r\nAR_BT_DISABLE_BT_ANT;\r\n}\r\nvoid ath9k_hw_btcoex_init_scheme(struct ath_hw *ah)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nstruct ath_btcoex_hw *btcoex_hw = &ah->btcoex_hw;\r\nif (!common->btcoex_enabled) {\r\nbtcoex_hw->scheme = ATH_BTCOEX_CFG_NONE;\r\nreturn;\r\n}\r\nif (ah->caps.hw_caps & ATH9K_HW_CAP_MCI) {\r\nbtcoex_hw->scheme = ATH_BTCOEX_CFG_MCI;\r\n} else if (AR_SREV_9300_20_OR_LATER(ah)) {\r\nbtcoex_hw->scheme = ATH_BTCOEX_CFG_3WIRE;\r\nbtcoex_hw->btactive_gpio = ATH_BTACTIVE_GPIO_9300;\r\nbtcoex_hw->wlanactive_gpio = ATH_WLANACTIVE_GPIO_9300;\r\nbtcoex_hw->btpriority_gpio = ATH_BTPRIORITY_GPIO_9300;\r\n} else if (AR_SREV_9280_20_OR_LATER(ah)) {\r\nbtcoex_hw->btactive_gpio = ATH_BTACTIVE_GPIO_9280;\r\nbtcoex_hw->wlanactive_gpio = ATH_WLANACTIVE_GPIO_9280;\r\nif (AR_SREV_9285(ah)) {\r\nbtcoex_hw->scheme = ATH_BTCOEX_CFG_3WIRE;\r\nbtcoex_hw->btpriority_gpio = ATH_BTPRIORITY_GPIO_9285;\r\n} else {\r\nbtcoex_hw->scheme = ATH_BTCOEX_CFG_2WIRE;\r\n}\r\n}\r\n}\r\nvoid ath9k_hw_btcoex_init_2wire(struct ath_hw *ah)\r\n{\r\nstruct ath_btcoex_hw *btcoex_hw = &ah->btcoex_hw;\r\nREG_CLR_BIT(ah, AR_GPIO_INPUT_EN_VAL,\r\n(AR_GPIO_INPUT_EN_VAL_BT_PRIORITY_DEF |\r\nAR_GPIO_INPUT_EN_VAL_BT_FREQUENCY_DEF));\r\nREG_SET_BIT(ah, AR_GPIO_INPUT_EN_VAL,\r\nAR_GPIO_INPUT_EN_VAL_BT_ACTIVE_BB);\r\nREG_RMW_FIELD(ah, AR_GPIO_INPUT_MUX1,\r\nAR_GPIO_INPUT_MUX1_BT_ACTIVE,\r\nbtcoex_hw->btactive_gpio);\r\nath9k_hw_cfg_gpio_input(ah, btcoex_hw->btactive_gpio);\r\n}\r\nvoid ath9k_hw_btcoex_init_3wire(struct ath_hw *ah)\r\n{\r\nstruct ath_btcoex_hw *btcoex_hw = &ah->btcoex_hw;\r\nREG_SET_BIT(ah, AR_GPIO_INPUT_EN_VAL,\r\n(AR_GPIO_INPUT_EN_VAL_BT_PRIORITY_BB |\r\nAR_GPIO_INPUT_EN_VAL_BT_ACTIVE_BB));\r\nREG_RMW_FIELD(ah, AR_GPIO_INPUT_MUX1,\r\nAR_GPIO_INPUT_MUX1_BT_ACTIVE,\r\nbtcoex_hw->btactive_gpio);\r\nREG_RMW_FIELD(ah, AR_GPIO_INPUT_MUX1,\r\nAR_GPIO_INPUT_MUX1_BT_PRIORITY,\r\nbtcoex_hw->btpriority_gpio);\r\nath9k_hw_cfg_gpio_input(ah, btcoex_hw->btactive_gpio);\r\nath9k_hw_cfg_gpio_input(ah, btcoex_hw->btpriority_gpio);\r\n}\r\nvoid ath9k_hw_btcoex_init_mci(struct ath_hw *ah)\r\n{\r\nah->btcoex_hw.mci.ready = false;\r\nah->btcoex_hw.mci.bt_state = 0;\r\nah->btcoex_hw.mci.bt_ver_major = 3;\r\nah->btcoex_hw.mci.bt_ver_minor = 0;\r\nah->btcoex_hw.mci.bt_version_known = false;\r\nah->btcoex_hw.mci.update_2g5g = true;\r\nah->btcoex_hw.mci.is_2g = true;\r\nah->btcoex_hw.mci.wlan_channels_update = false;\r\nah->btcoex_hw.mci.wlan_channels[0] = 0x00000000;\r\nah->btcoex_hw.mci.wlan_channels[1] = 0xffffffff;\r\nah->btcoex_hw.mci.wlan_channels[2] = 0xffffffff;\r\nah->btcoex_hw.mci.wlan_channels[3] = 0x7fffffff;\r\nah->btcoex_hw.mci.query_bt = true;\r\nah->btcoex_hw.mci.unhalt_bt_gpm = true;\r\nah->btcoex_hw.mci.halted_bt_gpm = false;\r\nah->btcoex_hw.mci.need_flush_btinfo = false;\r\nah->btcoex_hw.mci.wlan_cal_seq = 0;\r\nah->btcoex_hw.mci.wlan_cal_done = 0;\r\nah->btcoex_hw.mci.config = (AR_SREV_9462(ah)) ? 0x2201 : 0xa4c1;\r\n}\r\nstatic void ath9k_hw_btcoex_enable_2wire(struct ath_hw *ah)\r\n{\r\nstruct ath_btcoex_hw *btcoex_hw = &ah->btcoex_hw;\r\nath9k_hw_cfg_output(ah, btcoex_hw->wlanactive_gpio,\r\nAR_GPIO_OUTPUT_MUX_AS_TX_FRAME);\r\n}\r\nvoid ath9k_hw_btcoex_set_weight(struct ath_hw *ah,\r\nu32 bt_weight,\r\nu32 wlan_weight,\r\nenum ath_stomp_type stomp_type)\r\n{\r\nstruct ath_btcoex_hw *btcoex_hw = &ah->btcoex_hw;\r\nstruct ath9k_hw_mci *mci_hw = &ah->btcoex_hw.mci;\r\nu8 txprio_shift[] = { 24, 16, 16, 0 };\r\nbool concur_tx = (mci_hw->concur_tx && btcoex_hw->tx_prio[stomp_type]);\r\nconst u32 *weight = ar9003_wlan_weights[stomp_type];\r\nint i;\r\nif (!AR_SREV_9300_20_OR_LATER(ah)) {\r\nbtcoex_hw->bt_coex_weights =\r\nSM(bt_weight, AR_BTCOEX_BT_WGHT) |\r\nSM(wlan_weight, AR_BTCOEX_WL_WGHT);\r\nreturn;\r\n}\r\nif (AR_SREV_9462(ah) || AR_SREV_9565(ah)) {\r\nenum ath_stomp_type stype =\r\n((stomp_type == ATH_BTCOEX_STOMP_LOW) &&\r\nbtcoex_hw->mci.stomp_ftp) ?\r\nATH_BTCOEX_STOMP_LOW_FTP : stomp_type;\r\nweight = mci_wlan_weights[stype];\r\n}\r\nfor (i = 0; i < AR9300_NUM_WLAN_WEIGHTS; i++) {\r\nbtcoex_hw->bt_weight[i] = AR9300_BT_WGHT;\r\nbtcoex_hw->wlan_weight[i] = weight[i];\r\nif (concur_tx && i) {\r\nbtcoex_hw->wlan_weight[i] &=\r\n~(0xff << txprio_shift[i-1]);\r\nbtcoex_hw->wlan_weight[i] |=\r\n(btcoex_hw->tx_prio[stomp_type] <<\r\ntxprio_shift[i-1]);\r\n}\r\n}\r\nif (concur_tx) {\r\nbtcoex_hw->wlan_weight[i-1] &= ~(0xff << txprio_shift[i-1]);\r\nbtcoex_hw->wlan_weight[i-1] |= (btcoex_hw->tx_prio[stomp_type]\r\n<< txprio_shift[i-1]);\r\n}\r\n}\r\nstatic void ath9k_hw_btcoex_enable_3wire(struct ath_hw *ah)\r\n{\r\nstruct ath_btcoex_hw *btcoex = &ah->btcoex_hw;\r\nu32 val;\r\nint i;\r\nREG_WRITE(ah, AR_BT_COEX_MODE, btcoex->bt_coex_mode);\r\nREG_WRITE(ah, AR_BT_COEX_MODE2, btcoex->bt_coex_mode2);\r\nif (AR_SREV_9300_20_OR_LATER(ah)) {\r\nREG_WRITE(ah, AR_BT_COEX_WL_WEIGHTS0, btcoex->wlan_weight[0]);\r\nREG_WRITE(ah, AR_BT_COEX_WL_WEIGHTS1, btcoex->wlan_weight[1]);\r\nfor (i = 0; i < AR9300_NUM_BT_WEIGHTS; i++)\r\nREG_WRITE(ah, AR_BT_COEX_BT_WEIGHTS(i),\r\nbtcoex->bt_weight[i]);\r\n} else\r\nREG_WRITE(ah, AR_BT_COEX_WEIGHT, btcoex->bt_coex_weights);\r\nif (AR_SREV_9271(ah)) {\r\nval = REG_READ(ah, 0x50040);\r\nval &= 0xFFFFFEFF;\r\nREG_WRITE(ah, 0x50040, val);\r\n}\r\nREG_RMW_FIELD(ah, AR_QUIET1, AR_QUIET1_QUIET_ACK_CTS_ENABLE, 1);\r\nREG_RMW_FIELD(ah, AR_PCU_MISC, AR_PCU_BT_ANT_PREVENT_RX, 0);\r\nath9k_hw_cfg_output(ah, btcoex->wlanactive_gpio,\r\nAR_GPIO_OUTPUT_MUX_AS_RX_CLEAR_EXTERNAL);\r\n}\r\nstatic void ath9k_hw_btcoex_enable_mci(struct ath_hw *ah)\r\n{\r\nstruct ath_btcoex_hw *btcoex = &ah->btcoex_hw;\r\nint i;\r\nfor (i = 0; i < AR9300_NUM_BT_WEIGHTS; i++)\r\nREG_WRITE(ah, AR_MCI_COEX_WL_WEIGHTS(i),\r\nbtcoex->wlan_weight[i]);\r\nREG_RMW_FIELD(ah, AR_QUIET1, AR_QUIET1_QUIET_ACK_CTS_ENABLE, 1);\r\nbtcoex->enabled = true;\r\n}\r\nstatic void ath9k_hw_btcoex_disable_mci(struct ath_hw *ah)\r\n{\r\nstruct ath_btcoex_hw *btcoex_hw = &ah->btcoex_hw;\r\nint i;\r\nath9k_hw_btcoex_bt_stomp(ah, ATH_BTCOEX_STOMP_NONE);\r\nfor (i = 0; i < AR9300_NUM_BT_WEIGHTS; i++)\r\nREG_WRITE(ah, AR_MCI_COEX_WL_WEIGHTS(i),\r\nbtcoex_hw->wlan_weight[i]);\r\n}\r\nvoid ath9k_hw_btcoex_enable(struct ath_hw *ah)\r\n{\r\nstruct ath_btcoex_hw *btcoex_hw = &ah->btcoex_hw;\r\nswitch (ath9k_hw_get_btcoex_scheme(ah)) {\r\ncase ATH_BTCOEX_CFG_NONE:\r\nreturn;\r\ncase ATH_BTCOEX_CFG_2WIRE:\r\nath9k_hw_btcoex_enable_2wire(ah);\r\nbreak;\r\ncase ATH_BTCOEX_CFG_3WIRE:\r\nath9k_hw_btcoex_enable_3wire(ah);\r\nbreak;\r\ncase ATH_BTCOEX_CFG_MCI:\r\nath9k_hw_btcoex_enable_mci(ah);\r\nbreak;\r\n}\r\nif (ath9k_hw_get_btcoex_scheme(ah) != ATH_BTCOEX_CFG_MCI) {\r\nREG_RMW(ah, AR_GPIO_PDPU,\r\n(0x2 << (btcoex_hw->btactive_gpio * 2)),\r\n(0x3 << (btcoex_hw->btactive_gpio * 2)));\r\n}\r\nah->btcoex_hw.enabled = true;\r\n}\r\nvoid ath9k_hw_btcoex_disable(struct ath_hw *ah)\r\n{\r\nstruct ath_btcoex_hw *btcoex_hw = &ah->btcoex_hw;\r\nint i;\r\nbtcoex_hw->enabled = false;\r\nif (ath9k_hw_get_btcoex_scheme(ah) == ATH_BTCOEX_CFG_MCI) {\r\nath9k_hw_btcoex_disable_mci(ah);\r\nreturn;\r\n}\r\nif (!AR_SREV_9300_20_OR_LATER(ah))\r\nath9k_hw_set_gpio(ah, btcoex_hw->wlanactive_gpio, 0);\r\nath9k_hw_cfg_output(ah, btcoex_hw->wlanactive_gpio,\r\nAR_GPIO_OUTPUT_MUX_AS_OUTPUT);\r\nif (btcoex_hw->scheme == ATH_BTCOEX_CFG_3WIRE) {\r\nREG_WRITE(ah, AR_BT_COEX_MODE, AR_BT_QUIET | AR_BT_MODE);\r\nREG_WRITE(ah, AR_BT_COEX_MODE2, 0);\r\nif (AR_SREV_9300_20_OR_LATER(ah)) {\r\nREG_WRITE(ah, AR_BT_COEX_WL_WEIGHTS0, 0);\r\nREG_WRITE(ah, AR_BT_COEX_WL_WEIGHTS1, 0);\r\nfor (i = 0; i < AR9300_NUM_BT_WEIGHTS; i++)\r\nREG_WRITE(ah, AR_BT_COEX_BT_WEIGHTS(i), 0);\r\n} else\r\nREG_WRITE(ah, AR_BT_COEX_WEIGHT, 0);\r\n}\r\n}\r\nvoid ath9k_hw_btcoex_bt_stomp(struct ath_hw *ah,\r\nenum ath_stomp_type stomp_type)\r\n{\r\nif (AR_SREV_9300_20_OR_LATER(ah)) {\r\nath9k_hw_btcoex_set_weight(ah, 0, 0, stomp_type);\r\nreturn;\r\n}\r\nswitch (stomp_type) {\r\ncase ATH_BTCOEX_STOMP_ALL:\r\nath9k_hw_btcoex_set_weight(ah, AR_BT_COEX_WGHT,\r\nAR_STOMP_ALL_WLAN_WGHT, 0);\r\nbreak;\r\ncase ATH_BTCOEX_STOMP_LOW:\r\nath9k_hw_btcoex_set_weight(ah, AR_BT_COEX_WGHT,\r\nAR_STOMP_LOW_WLAN_WGHT, 0);\r\nbreak;\r\ncase ATH_BTCOEX_STOMP_NONE:\r\nath9k_hw_btcoex_set_weight(ah, AR_BT_COEX_WGHT,\r\nAR_STOMP_NONE_WLAN_WGHT, 0);\r\nbreak;\r\ndefault:\r\nath_dbg(ath9k_hw_common(ah), BTCOEX, "Invalid Stomptype\n");\r\nbreak;\r\n}\r\n}\r\nvoid ath9k_hw_btcoex_set_concur_txprio(struct ath_hw *ah, u8 *stomp_txprio)\r\n{\r\nstruct ath_btcoex_hw *btcoex = &ah->btcoex_hw;\r\nint i;\r\nfor (i = 0; i < ATH_BTCOEX_STOMP_MAX; i++)\r\nbtcoex->tx_prio[i] = stomp_txprio[i];\r\n}

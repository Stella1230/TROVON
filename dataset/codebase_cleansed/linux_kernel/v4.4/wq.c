u32 mlx5_wq_cyc_get_size(struct mlx5_wq_cyc *wq)\r\n{\r\nreturn (u32)wq->sz_m1 + 1;\r\n}\r\nu32 mlx5_cqwq_get_size(struct mlx5_cqwq *wq)\r\n{\r\nreturn wq->sz_m1 + 1;\r\n}\r\nu32 mlx5_wq_ll_get_size(struct mlx5_wq_ll *wq)\r\n{\r\nreturn (u32)wq->sz_m1 + 1;\r\n}\r\nstatic u32 mlx5_wq_cyc_get_byte_size(struct mlx5_wq_cyc *wq)\r\n{\r\nreturn mlx5_wq_cyc_get_size(wq) << wq->log_stride;\r\n}\r\nstatic u32 mlx5_cqwq_get_byte_size(struct mlx5_cqwq *wq)\r\n{\r\nreturn mlx5_cqwq_get_size(wq) << wq->log_stride;\r\n}\r\nstatic u32 mlx5_wq_ll_get_byte_size(struct mlx5_wq_ll *wq)\r\n{\r\nreturn mlx5_wq_ll_get_size(wq) << wq->log_stride;\r\n}\r\nint mlx5_wq_cyc_create(struct mlx5_core_dev *mdev, struct mlx5_wq_param *param,\r\nvoid *wqc, struct mlx5_wq_cyc *wq,\r\nstruct mlx5_wq_ctrl *wq_ctrl)\r\n{\r\nint err;\r\nwq->log_stride = MLX5_GET(wq, wqc, log_wq_stride);\r\nwq->sz_m1 = (1 << MLX5_GET(wq, wqc, log_wq_sz)) - 1;\r\nerr = mlx5_db_alloc_node(mdev, &wq_ctrl->db, param->db_numa_node);\r\nif (err) {\r\nmlx5_core_warn(mdev, "mlx5_db_alloc() failed, %d\n", err);\r\nreturn err;\r\n}\r\nerr = mlx5_buf_alloc_node(mdev, mlx5_wq_cyc_get_byte_size(wq),\r\n&wq_ctrl->buf, param->buf_numa_node);\r\nif (err) {\r\nmlx5_core_warn(mdev, "mlx5_buf_alloc() failed, %d\n", err);\r\ngoto err_db_free;\r\n}\r\nwq->buf = wq_ctrl->buf.direct.buf;\r\nwq->db = wq_ctrl->db.db;\r\nwq_ctrl->mdev = mdev;\r\nreturn 0;\r\nerr_db_free:\r\nmlx5_db_free(mdev, &wq_ctrl->db);\r\nreturn err;\r\n}\r\nint mlx5_cqwq_create(struct mlx5_core_dev *mdev, struct mlx5_wq_param *param,\r\nvoid *cqc, struct mlx5_cqwq *wq,\r\nstruct mlx5_wq_ctrl *wq_ctrl)\r\n{\r\nint err;\r\nwq->log_stride = 6 + MLX5_GET(cqc, cqc, cqe_sz);\r\nwq->log_sz = MLX5_GET(cqc, cqc, log_cq_size);\r\nwq->sz_m1 = (1 << wq->log_sz) - 1;\r\nerr = mlx5_db_alloc_node(mdev, &wq_ctrl->db, param->db_numa_node);\r\nif (err) {\r\nmlx5_core_warn(mdev, "mlx5_db_alloc() failed, %d\n", err);\r\nreturn err;\r\n}\r\nerr = mlx5_buf_alloc_node(mdev, mlx5_cqwq_get_byte_size(wq),\r\n&wq_ctrl->buf, param->buf_numa_node);\r\nif (err) {\r\nmlx5_core_warn(mdev, "mlx5_buf_alloc() failed, %d\n", err);\r\ngoto err_db_free;\r\n}\r\nwq->buf = wq_ctrl->buf.direct.buf;\r\nwq->db = wq_ctrl->db.db;\r\nwq_ctrl->mdev = mdev;\r\nreturn 0;\r\nerr_db_free:\r\nmlx5_db_free(mdev, &wq_ctrl->db);\r\nreturn err;\r\n}\r\nint mlx5_wq_ll_create(struct mlx5_core_dev *mdev, struct mlx5_wq_param *param,\r\nvoid *wqc, struct mlx5_wq_ll *wq,\r\nstruct mlx5_wq_ctrl *wq_ctrl)\r\n{\r\nstruct mlx5_wqe_srq_next_seg *next_seg;\r\nint err;\r\nint i;\r\nwq->log_stride = MLX5_GET(wq, wqc, log_wq_stride);\r\nwq->sz_m1 = (1 << MLX5_GET(wq, wqc, log_wq_sz)) - 1;\r\nerr = mlx5_db_alloc_node(mdev, &wq_ctrl->db, param->db_numa_node);\r\nif (err) {\r\nmlx5_core_warn(mdev, "mlx5_db_alloc() failed, %d\n", err);\r\nreturn err;\r\n}\r\nerr = mlx5_buf_alloc(mdev, mlx5_wq_ll_get_byte_size(wq), &wq_ctrl->buf);\r\nif (err) {\r\nmlx5_core_warn(mdev, "mlx5_buf_alloc() failed, %d\n", err);\r\ngoto err_db_free;\r\n}\r\nwq->buf = wq_ctrl->buf.direct.buf;\r\nwq->db = wq_ctrl->db.db;\r\nfor (i = 0; i < wq->sz_m1; i++) {\r\nnext_seg = mlx5_wq_ll_get_wqe(wq, i);\r\nnext_seg->next_wqe_index = cpu_to_be16(i + 1);\r\n}\r\nnext_seg = mlx5_wq_ll_get_wqe(wq, i);\r\nwq->tail_next = &next_seg->next_wqe_index;\r\nwq_ctrl->mdev = mdev;\r\nreturn 0;\r\nerr_db_free:\r\nmlx5_db_free(mdev, &wq_ctrl->db);\r\nreturn err;\r\n}\r\nvoid mlx5_wq_destroy(struct mlx5_wq_ctrl *wq_ctrl)\r\n{\r\nmlx5_buf_free(wq_ctrl->mdev, &wq_ctrl->buf);\r\nmlx5_db_free(wq_ctrl->mdev, &wq_ctrl->db);\r\n}

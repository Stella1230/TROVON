static int hp_wmi_perform_query(int query, int write, void *buffer,\r\nint insize, int outsize)\r\n{\r\nstruct bios_return *bios_return;\r\nint actual_outsize;\r\nunion acpi_object *obj;\r\nstruct bios_args args = {\r\n.signature = 0x55434553,\r\n.command = write ? 0x2 : 0x1,\r\n.commandtype = query,\r\n.datasize = insize,\r\n.data = 0,\r\n};\r\nstruct acpi_buffer input = { sizeof(struct bios_args), &args };\r\nstruct acpi_buffer output = { ACPI_ALLOCATE_BUFFER, NULL };\r\nu32 rc;\r\nif (WARN_ON(insize > sizeof(args.data)))\r\nreturn -EINVAL;\r\nmemcpy(&args.data, buffer, insize);\r\nwmi_evaluate_method(HPWMI_BIOS_GUID, 0, 0x3, &input, &output);\r\nobj = output.pointer;\r\nif (!obj)\r\nreturn -EINVAL;\r\nelse if (obj->type != ACPI_TYPE_BUFFER) {\r\nkfree(obj);\r\nreturn -EINVAL;\r\n}\r\nbios_return = (struct bios_return *)obj->buffer.pointer;\r\nrc = bios_return->return_code;\r\nif (rc) {\r\nif (rc != HPWMI_RET_UNKNOWN_CMDTYPE)\r\npr_warn("query 0x%x returned error 0x%x\n", query, rc);\r\nkfree(obj);\r\nreturn rc;\r\n}\r\nif (!outsize) {\r\nkfree(obj);\r\nreturn 0;\r\n}\r\nactual_outsize = min(outsize, (int)(obj->buffer.length - sizeof(*bios_return)));\r\nmemcpy(buffer, obj->buffer.pointer + sizeof(*bios_return), actual_outsize);\r\nmemset(buffer + actual_outsize, 0, outsize - actual_outsize);\r\nkfree(obj);\r\nreturn 0;\r\n}\r\nstatic int hp_wmi_display_state(void)\r\n{\r\nint state = 0;\r\nint ret = hp_wmi_perform_query(HPWMI_DISPLAY_QUERY, 0, &state,\r\nsizeof(state), sizeof(state));\r\nif (ret)\r\nreturn -EINVAL;\r\nreturn state;\r\n}\r\nstatic int hp_wmi_hddtemp_state(void)\r\n{\r\nint state = 0;\r\nint ret = hp_wmi_perform_query(HPWMI_HDDTEMP_QUERY, 0, &state,\r\nsizeof(state), sizeof(state));\r\nif (ret)\r\nreturn -EINVAL;\r\nreturn state;\r\n}\r\nstatic int hp_wmi_als_state(void)\r\n{\r\nint state = 0;\r\nint ret = hp_wmi_perform_query(HPWMI_ALS_QUERY, 0, &state,\r\nsizeof(state), sizeof(state));\r\nif (ret)\r\nreturn -EINVAL;\r\nreturn state;\r\n}\r\nstatic int hp_wmi_dock_state(void)\r\n{\r\nint state = 0;\r\nint ret = hp_wmi_perform_query(HPWMI_HARDWARE_QUERY, 0, &state,\r\nsizeof(state), sizeof(state));\r\nif (ret)\r\nreturn -EINVAL;\r\nreturn state & 0x1;\r\n}\r\nstatic int hp_wmi_tablet_state(void)\r\n{\r\nint state = 0;\r\nint ret = hp_wmi_perform_query(HPWMI_HARDWARE_QUERY, 0, &state,\r\nsizeof(state), sizeof(state));\r\nif (ret)\r\nreturn ret;\r\nreturn (state & 0x4) ? 1 : 0;\r\n}\r\nstatic int __init hp_wmi_bios_2008_later(void)\r\n{\r\nint state = 0;\r\nint ret = hp_wmi_perform_query(HPWMI_FEATURE_QUERY, 0, &state,\r\nsizeof(state), sizeof(state));\r\nif (!ret)\r\nreturn 1;\r\nreturn (ret == HPWMI_RET_UNKNOWN_CMDTYPE) ? 0 : -ENXIO;\r\n}\r\nstatic int __init hp_wmi_bios_2009_later(void)\r\n{\r\nint state = 0;\r\nint ret = hp_wmi_perform_query(HPWMI_FEATURE2_QUERY, 0, &state,\r\nsizeof(state), sizeof(state));\r\nif (!ret)\r\nreturn 1;\r\nreturn (ret == HPWMI_RET_UNKNOWN_CMDTYPE) ? 0 : -ENXIO;\r\n}\r\nstatic int __init hp_wmi_enable_hotkeys(void)\r\n{\r\nint value = 0x6e;\r\nint ret = hp_wmi_perform_query(HPWMI_BIOS_QUERY, 1, &value,\r\nsizeof(value), 0);\r\nif (ret)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int hp_wmi_set_block(void *data, bool blocked)\r\n{\r\nenum hp_wmi_radio r = (enum hp_wmi_radio) data;\r\nint query = BIT(r + 8) | ((!blocked) << r);\r\nint ret;\r\nret = hp_wmi_perform_query(HPWMI_WIRELESS_QUERY, 1,\r\n&query, sizeof(query), 0);\r\nif (ret)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic bool hp_wmi_get_sw_state(enum hp_wmi_radio r)\r\n{\r\nint wireless = 0;\r\nint mask;\r\nhp_wmi_perform_query(HPWMI_WIRELESS_QUERY, 0,\r\n&wireless, sizeof(wireless),\r\nsizeof(wireless));\r\nmask = 0x200 << (r * 8);\r\nif (wireless & mask)\r\nreturn false;\r\nelse\r\nreturn true;\r\n}\r\nstatic bool hp_wmi_get_hw_state(enum hp_wmi_radio r)\r\n{\r\nint wireless = 0;\r\nint mask;\r\nhp_wmi_perform_query(HPWMI_WIRELESS_QUERY, 0,\r\n&wireless, sizeof(wireless),\r\nsizeof(wireless));\r\nmask = 0x800 << (r * 8);\r\nif (wireless & mask)\r\nreturn false;\r\nelse\r\nreturn true;\r\n}\r\nstatic int hp_wmi_rfkill2_set_block(void *data, bool blocked)\r\n{\r\nint rfkill_id = (int)(long)data;\r\nchar buffer[4] = { 0x01, 0x00, rfkill_id, !blocked };\r\nif (hp_wmi_perform_query(HPWMI_WIRELESS2_QUERY, 1,\r\nbuffer, sizeof(buffer), 0))\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int hp_wmi_rfkill2_refresh(void)\r\n{\r\nint err, i;\r\nstruct bios_rfkill2_state state;\r\nerr = hp_wmi_perform_query(HPWMI_WIRELESS2_QUERY, 0, &state,\r\n0, sizeof(state));\r\nif (err)\r\nreturn err;\r\nfor (i = 0; i < rfkill2_count; i++) {\r\nint num = rfkill2[i].num;\r\nstruct bios_rfkill2_device_state *devstate;\r\ndevstate = &state.device[num];\r\nif (num >= state.count ||\r\ndevstate->rfkill_id != rfkill2[i].id) {\r\npr_warn("power configuration of the wireless devices unexpectedly changed\n");\r\ncontinue;\r\n}\r\nrfkill_set_states(rfkill2[i].rfkill,\r\nIS_SWBLOCKED(devstate->power),\r\nIS_HWBLOCKED(devstate->power));\r\n}\r\nreturn 0;\r\n}\r\nstatic int hp_wmi_post_code_state(void)\r\n{\r\nint state = 0;\r\nint ret = hp_wmi_perform_query(HPWMI_POSTCODEERROR_QUERY, 0, &state,\r\nsizeof(state), sizeof(state));\r\nif (ret)\r\nreturn -EINVAL;\r\nreturn state;\r\n}\r\nstatic ssize_t show_display(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nint value = hp_wmi_display_state();\r\nif (value < 0)\r\nreturn -EINVAL;\r\nreturn sprintf(buf, "%d\n", value);\r\n}\r\nstatic ssize_t show_hddtemp(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nint value = hp_wmi_hddtemp_state();\r\nif (value < 0)\r\nreturn -EINVAL;\r\nreturn sprintf(buf, "%d\n", value);\r\n}\r\nstatic ssize_t show_als(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nint value = hp_wmi_als_state();\r\nif (value < 0)\r\nreturn -EINVAL;\r\nreturn sprintf(buf, "%d\n", value);\r\n}\r\nstatic ssize_t show_dock(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nint value = hp_wmi_dock_state();\r\nif (value < 0)\r\nreturn -EINVAL;\r\nreturn sprintf(buf, "%d\n", value);\r\n}\r\nstatic ssize_t show_tablet(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nint value = hp_wmi_tablet_state();\r\nif (value < 0)\r\nreturn -EINVAL;\r\nreturn sprintf(buf, "%d\n", value);\r\n}\r\nstatic ssize_t show_postcode(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nint value = hp_wmi_post_code_state();\r\nif (value < 0)\r\nreturn -EINVAL;\r\nreturn sprintf(buf, "0x%x\n", value);\r\n}\r\nstatic ssize_t set_als(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nu32 tmp = simple_strtoul(buf, NULL, 10);\r\nint ret = hp_wmi_perform_query(HPWMI_ALS_QUERY, 1, &tmp,\r\nsizeof(tmp), sizeof(tmp));\r\nif (ret)\r\nreturn -EINVAL;\r\nreturn count;\r\n}\r\nstatic ssize_t set_postcode(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nint ret;\r\nu32 tmp;\r\nlong unsigned int tmp2;\r\nret = kstrtoul(buf, 10, &tmp2);\r\nif (ret || tmp2 != 1)\r\nreturn -EINVAL;\r\ntmp = (u32) tmp2;\r\nret = hp_wmi_perform_query(HPWMI_POSTCODEERROR_QUERY, 1, &tmp,\r\nsizeof(tmp), sizeof(tmp));\r\nif (ret)\r\nreturn -EINVAL;\r\nreturn count;\r\n}\r\nstatic void hp_wmi_notify(u32 value, void *context)\r\n{\r\nstruct acpi_buffer response = { ACPI_ALLOCATE_BUFFER, NULL };\r\nunion acpi_object *obj;\r\nu32 event_id, event_data;\r\nint key_code = 0, ret;\r\nu32 *location;\r\nacpi_status status;\r\nstatus = wmi_get_event_data(value, &response);\r\nif (status != AE_OK) {\r\npr_info("bad event status 0x%x\n", status);\r\nreturn;\r\n}\r\nobj = (union acpi_object *)response.pointer;\r\nif (!obj)\r\nreturn;\r\nif (obj->type != ACPI_TYPE_BUFFER) {\r\npr_info("Unknown response received %d\n", obj->type);\r\nkfree(obj);\r\nreturn;\r\n}\r\nlocation = (u32 *)obj->buffer.pointer;\r\nif (obj->buffer.length == 8) {\r\nevent_id = *location;\r\nevent_data = *(location + 1);\r\n} else if (obj->buffer.length == 16) {\r\nevent_id = *location;\r\nevent_data = *(location + 2);\r\n} else {\r\npr_info("Unknown buffer length %d\n", obj->buffer.length);\r\nkfree(obj);\r\nreturn;\r\n}\r\nkfree(obj);\r\nswitch (event_id) {\r\ncase HPWMI_DOCK_EVENT:\r\ninput_report_switch(hp_wmi_input_dev, SW_DOCK,\r\nhp_wmi_dock_state());\r\ninput_report_switch(hp_wmi_input_dev, SW_TABLET_MODE,\r\nhp_wmi_tablet_state());\r\ninput_sync(hp_wmi_input_dev);\r\nbreak;\r\ncase HPWMI_PARK_HDD:\r\nbreak;\r\ncase HPWMI_SMART_ADAPTER:\r\nbreak;\r\ncase HPWMI_BEZEL_BUTTON:\r\nret = hp_wmi_perform_query(HPWMI_HOTKEY_QUERY, 0,\r\n&key_code,\r\nsizeof(key_code),\r\nsizeof(key_code));\r\nif (ret)\r\nbreak;\r\nif (!sparse_keymap_report_event(hp_wmi_input_dev,\r\nkey_code, 1, true))\r\npr_info("Unknown key code - 0x%x\n", key_code);\r\nbreak;\r\ncase HPWMI_WIRELESS:\r\nif (rfkill2_count) {\r\nhp_wmi_rfkill2_refresh();\r\nbreak;\r\n}\r\nif (wifi_rfkill)\r\nrfkill_set_states(wifi_rfkill,\r\nhp_wmi_get_sw_state(HPWMI_WIFI),\r\nhp_wmi_get_hw_state(HPWMI_WIFI));\r\nif (bluetooth_rfkill)\r\nrfkill_set_states(bluetooth_rfkill,\r\nhp_wmi_get_sw_state(HPWMI_BLUETOOTH),\r\nhp_wmi_get_hw_state(HPWMI_BLUETOOTH));\r\nif (wwan_rfkill)\r\nrfkill_set_states(wwan_rfkill,\r\nhp_wmi_get_sw_state(HPWMI_WWAN),\r\nhp_wmi_get_hw_state(HPWMI_WWAN));\r\nif (gps_rfkill)\r\nrfkill_set_states(gps_rfkill,\r\nhp_wmi_get_sw_state(HPWMI_GPS),\r\nhp_wmi_get_hw_state(HPWMI_GPS));\r\nbreak;\r\ncase HPWMI_CPU_BATTERY_THROTTLE:\r\npr_info("Unimplemented CPU throttle because of 3 Cell battery event detected\n");\r\nbreak;\r\ncase HPWMI_LOCK_SWITCH:\r\nbreak;\r\ncase HPWMI_LID_SWITCH:\r\nbreak;\r\ncase HPWMI_SCREEN_ROTATION:\r\nbreak;\r\ncase HPWMI_COOLSENSE_SYSTEM_MOBILE:\r\nbreak;\r\ncase HPWMI_COOLSENSE_SYSTEM_HOT:\r\nbreak;\r\ncase HPWMI_PROXIMITY_SENSOR:\r\nbreak;\r\ncase HPWMI_BACKLIT_KB_BRIGHTNESS:\r\nbreak;\r\ncase HPWMI_PEAKSHIFT_PERIOD:\r\nbreak;\r\ncase HPWMI_BATTERY_CHARGE_PERIOD:\r\nbreak;\r\ndefault:\r\npr_info("Unknown event_id - %d - 0x%x\n", event_id, event_data);\r\nbreak;\r\n}\r\n}\r\nstatic int __init hp_wmi_input_setup(void)\r\n{\r\nacpi_status status;\r\nint err;\r\nhp_wmi_input_dev = input_allocate_device();\r\nif (!hp_wmi_input_dev)\r\nreturn -ENOMEM;\r\nhp_wmi_input_dev->name = "HP WMI hotkeys";\r\nhp_wmi_input_dev->phys = "wmi/input0";\r\nhp_wmi_input_dev->id.bustype = BUS_HOST;\r\n__set_bit(EV_SW, hp_wmi_input_dev->evbit);\r\n__set_bit(SW_DOCK, hp_wmi_input_dev->swbit);\r\n__set_bit(SW_TABLET_MODE, hp_wmi_input_dev->swbit);\r\nerr = sparse_keymap_setup(hp_wmi_input_dev, hp_wmi_keymap, NULL);\r\nif (err)\r\ngoto err_free_dev;\r\ninput_report_switch(hp_wmi_input_dev, SW_DOCK, hp_wmi_dock_state());\r\ninput_report_switch(hp_wmi_input_dev, SW_TABLET_MODE,\r\nhp_wmi_tablet_state());\r\ninput_sync(hp_wmi_input_dev);\r\nif (!hp_wmi_bios_2009_later() && hp_wmi_bios_2008_later())\r\nhp_wmi_enable_hotkeys();\r\nstatus = wmi_install_notify_handler(HPWMI_EVENT_GUID, hp_wmi_notify, NULL);\r\nif (ACPI_FAILURE(status)) {\r\nerr = -EIO;\r\ngoto err_free_keymap;\r\n}\r\nerr = input_register_device(hp_wmi_input_dev);\r\nif (err)\r\ngoto err_uninstall_notifier;\r\nreturn 0;\r\nerr_uninstall_notifier:\r\nwmi_remove_notify_handler(HPWMI_EVENT_GUID);\r\nerr_free_keymap:\r\nsparse_keymap_free(hp_wmi_input_dev);\r\nerr_free_dev:\r\ninput_free_device(hp_wmi_input_dev);\r\nreturn err;\r\n}\r\nstatic void hp_wmi_input_destroy(void)\r\n{\r\nwmi_remove_notify_handler(HPWMI_EVENT_GUID);\r\nsparse_keymap_free(hp_wmi_input_dev);\r\ninput_unregister_device(hp_wmi_input_dev);\r\n}\r\nstatic void cleanup_sysfs(struct platform_device *device)\r\n{\r\ndevice_remove_file(&device->dev, &dev_attr_display);\r\ndevice_remove_file(&device->dev, &dev_attr_hddtemp);\r\ndevice_remove_file(&device->dev, &dev_attr_als);\r\ndevice_remove_file(&device->dev, &dev_attr_dock);\r\ndevice_remove_file(&device->dev, &dev_attr_tablet);\r\ndevice_remove_file(&device->dev, &dev_attr_postcode);\r\n}\r\nstatic int __init hp_wmi_rfkill_setup(struct platform_device *device)\r\n{\r\nint err;\r\nint wireless = 0;\r\nerr = hp_wmi_perform_query(HPWMI_WIRELESS_QUERY, 0, &wireless,\r\nsizeof(wireless), sizeof(wireless));\r\nif (err)\r\nreturn err;\r\nif (wireless & 0x1) {\r\nwifi_rfkill = rfkill_alloc("hp-wifi", &device->dev,\r\nRFKILL_TYPE_WLAN,\r\n&hp_wmi_rfkill_ops,\r\n(void *) HPWMI_WIFI);\r\nif (!wifi_rfkill)\r\nreturn -ENOMEM;\r\nrfkill_init_sw_state(wifi_rfkill,\r\nhp_wmi_get_sw_state(HPWMI_WIFI));\r\nrfkill_set_hw_state(wifi_rfkill,\r\nhp_wmi_get_hw_state(HPWMI_WIFI));\r\nerr = rfkill_register(wifi_rfkill);\r\nif (err)\r\ngoto register_wifi_error;\r\n}\r\nif (wireless & 0x2) {\r\nbluetooth_rfkill = rfkill_alloc("hp-bluetooth", &device->dev,\r\nRFKILL_TYPE_BLUETOOTH,\r\n&hp_wmi_rfkill_ops,\r\n(void *) HPWMI_BLUETOOTH);\r\nif (!bluetooth_rfkill) {\r\nerr = -ENOMEM;\r\ngoto register_wifi_error;\r\n}\r\nrfkill_init_sw_state(bluetooth_rfkill,\r\nhp_wmi_get_sw_state(HPWMI_BLUETOOTH));\r\nrfkill_set_hw_state(bluetooth_rfkill,\r\nhp_wmi_get_hw_state(HPWMI_BLUETOOTH));\r\nerr = rfkill_register(bluetooth_rfkill);\r\nif (err)\r\ngoto register_bluetooth_error;\r\n}\r\nif (wireless & 0x4) {\r\nwwan_rfkill = rfkill_alloc("hp-wwan", &device->dev,\r\nRFKILL_TYPE_WWAN,\r\n&hp_wmi_rfkill_ops,\r\n(void *) HPWMI_WWAN);\r\nif (!wwan_rfkill) {\r\nerr = -ENOMEM;\r\ngoto register_bluetooth_error;\r\n}\r\nrfkill_init_sw_state(wwan_rfkill,\r\nhp_wmi_get_sw_state(HPWMI_WWAN));\r\nrfkill_set_hw_state(wwan_rfkill,\r\nhp_wmi_get_hw_state(HPWMI_WWAN));\r\nerr = rfkill_register(wwan_rfkill);\r\nif (err)\r\ngoto register_wwan_error;\r\n}\r\nif (wireless & 0x8) {\r\ngps_rfkill = rfkill_alloc("hp-gps", &device->dev,\r\nRFKILL_TYPE_GPS,\r\n&hp_wmi_rfkill_ops,\r\n(void *) HPWMI_GPS);\r\nif (!gps_rfkill) {\r\nerr = -ENOMEM;\r\ngoto register_wwan_error;\r\n}\r\nrfkill_init_sw_state(gps_rfkill,\r\nhp_wmi_get_sw_state(HPWMI_GPS));\r\nrfkill_set_hw_state(gps_rfkill,\r\nhp_wmi_get_hw_state(HPWMI_GPS));\r\nerr = rfkill_register(gps_rfkill);\r\nif (err)\r\ngoto register_gps_error;\r\n}\r\nreturn 0;\r\nregister_gps_error:\r\nrfkill_destroy(gps_rfkill);\r\ngps_rfkill = NULL;\r\nif (bluetooth_rfkill)\r\nrfkill_unregister(bluetooth_rfkill);\r\nregister_wwan_error:\r\nrfkill_destroy(wwan_rfkill);\r\nwwan_rfkill = NULL;\r\nif (gps_rfkill)\r\nrfkill_unregister(gps_rfkill);\r\nregister_bluetooth_error:\r\nrfkill_destroy(bluetooth_rfkill);\r\nbluetooth_rfkill = NULL;\r\nif (wifi_rfkill)\r\nrfkill_unregister(wifi_rfkill);\r\nregister_wifi_error:\r\nrfkill_destroy(wifi_rfkill);\r\nwifi_rfkill = NULL;\r\nreturn err;\r\n}\r\nstatic int __init hp_wmi_rfkill2_setup(struct platform_device *device)\r\n{\r\nint err, i;\r\nstruct bios_rfkill2_state state;\r\nerr = hp_wmi_perform_query(HPWMI_WIRELESS2_QUERY, 0, &state,\r\n0, sizeof(state));\r\nif (err)\r\nreturn err;\r\nif (state.count > HPWMI_MAX_RFKILL2_DEVICES) {\r\npr_warn("unable to parse 0x1b query output\n");\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; i < state.count; i++) {\r\nstruct rfkill *rfkill;\r\nenum rfkill_type type;\r\nchar *name;\r\nswitch (state.device[i].radio_type) {\r\ncase HPWMI_WIFI:\r\ntype = RFKILL_TYPE_WLAN;\r\nname = "hp-wifi";\r\nbreak;\r\ncase HPWMI_BLUETOOTH:\r\ntype = RFKILL_TYPE_BLUETOOTH;\r\nname = "hp-bluetooth";\r\nbreak;\r\ncase HPWMI_WWAN:\r\ntype = RFKILL_TYPE_WWAN;\r\nname = "hp-wwan";\r\nbreak;\r\ncase HPWMI_GPS:\r\ntype = RFKILL_TYPE_GPS;\r\nname = "hp-gps";\r\nbreak;\r\ndefault:\r\npr_warn("unknown device type 0x%x\n",\r\nstate.device[i].radio_type);\r\ncontinue;\r\n}\r\nif (!state.device[i].vendor_id) {\r\npr_warn("zero device %d while %d reported\n",\r\ni, state.count);\r\ncontinue;\r\n}\r\nrfkill = rfkill_alloc(name, &device->dev, type,\r\n&hp_wmi_rfkill2_ops, (void *)(long)i);\r\nif (!rfkill) {\r\nerr = -ENOMEM;\r\ngoto fail;\r\n}\r\nrfkill2[rfkill2_count].id = state.device[i].rfkill_id;\r\nrfkill2[rfkill2_count].num = i;\r\nrfkill2[rfkill2_count].rfkill = rfkill;\r\nrfkill_init_sw_state(rfkill,\r\nIS_SWBLOCKED(state.device[i].power));\r\nrfkill_set_hw_state(rfkill,\r\nIS_HWBLOCKED(state.device[i].power));\r\nif (!(state.device[i].power & HPWMI_POWER_BIOS))\r\npr_info("device %s blocked by BIOS\n", name);\r\nerr = rfkill_register(rfkill);\r\nif (err) {\r\nrfkill_destroy(rfkill);\r\ngoto fail;\r\n}\r\nrfkill2_count++;\r\n}\r\nreturn 0;\r\nfail:\r\nfor (; rfkill2_count > 0; rfkill2_count--) {\r\nrfkill_unregister(rfkill2[rfkill2_count - 1].rfkill);\r\nrfkill_destroy(rfkill2[rfkill2_count - 1].rfkill);\r\n}\r\nreturn err;\r\n}\r\nstatic int __init hp_wmi_bios_setup(struct platform_device *device)\r\n{\r\nint err;\r\nwifi_rfkill = NULL;\r\nbluetooth_rfkill = NULL;\r\nwwan_rfkill = NULL;\r\ngps_rfkill = NULL;\r\nrfkill2_count = 0;\r\nif (hp_wmi_bios_2009_later() || hp_wmi_rfkill_setup(device))\r\nhp_wmi_rfkill2_setup(device);\r\nerr = device_create_file(&device->dev, &dev_attr_display);\r\nif (err)\r\ngoto add_sysfs_error;\r\nerr = device_create_file(&device->dev, &dev_attr_hddtemp);\r\nif (err)\r\ngoto add_sysfs_error;\r\nerr = device_create_file(&device->dev, &dev_attr_als);\r\nif (err)\r\ngoto add_sysfs_error;\r\nerr = device_create_file(&device->dev, &dev_attr_dock);\r\nif (err)\r\ngoto add_sysfs_error;\r\nerr = device_create_file(&device->dev, &dev_attr_tablet);\r\nif (err)\r\ngoto add_sysfs_error;\r\nerr = device_create_file(&device->dev, &dev_attr_postcode);\r\nif (err)\r\ngoto add_sysfs_error;\r\nreturn 0;\r\nadd_sysfs_error:\r\ncleanup_sysfs(device);\r\nreturn err;\r\n}\r\nstatic int __exit hp_wmi_bios_remove(struct platform_device *device)\r\n{\r\nint i;\r\ncleanup_sysfs(device);\r\nfor (i = 0; i < rfkill2_count; i++) {\r\nrfkill_unregister(rfkill2[i].rfkill);\r\nrfkill_destroy(rfkill2[i].rfkill);\r\n}\r\nif (wifi_rfkill) {\r\nrfkill_unregister(wifi_rfkill);\r\nrfkill_destroy(wifi_rfkill);\r\n}\r\nif (bluetooth_rfkill) {\r\nrfkill_unregister(bluetooth_rfkill);\r\nrfkill_destroy(bluetooth_rfkill);\r\n}\r\nif (wwan_rfkill) {\r\nrfkill_unregister(wwan_rfkill);\r\nrfkill_destroy(wwan_rfkill);\r\n}\r\nif (gps_rfkill) {\r\nrfkill_unregister(gps_rfkill);\r\nrfkill_destroy(gps_rfkill);\r\n}\r\nreturn 0;\r\n}\r\nstatic int hp_wmi_resume_handler(struct device *device)\r\n{\r\nif (hp_wmi_input_dev) {\r\ninput_report_switch(hp_wmi_input_dev, SW_DOCK,\r\nhp_wmi_dock_state());\r\ninput_report_switch(hp_wmi_input_dev, SW_TABLET_MODE,\r\nhp_wmi_tablet_state());\r\ninput_sync(hp_wmi_input_dev);\r\n}\r\nif (rfkill2_count)\r\nhp_wmi_rfkill2_refresh();\r\nif (wifi_rfkill)\r\nrfkill_set_states(wifi_rfkill,\r\nhp_wmi_get_sw_state(HPWMI_WIFI),\r\nhp_wmi_get_hw_state(HPWMI_WIFI));\r\nif (bluetooth_rfkill)\r\nrfkill_set_states(bluetooth_rfkill,\r\nhp_wmi_get_sw_state(HPWMI_BLUETOOTH),\r\nhp_wmi_get_hw_state(HPWMI_BLUETOOTH));\r\nif (wwan_rfkill)\r\nrfkill_set_states(wwan_rfkill,\r\nhp_wmi_get_sw_state(HPWMI_WWAN),\r\nhp_wmi_get_hw_state(HPWMI_WWAN));\r\nif (gps_rfkill)\r\nrfkill_set_states(gps_rfkill,\r\nhp_wmi_get_sw_state(HPWMI_GPS),\r\nhp_wmi_get_hw_state(HPWMI_GPS));\r\nreturn 0;\r\n}\r\nstatic int __init hp_wmi_init(void)\r\n{\r\nint err;\r\nint event_capable = wmi_has_guid(HPWMI_EVENT_GUID);\r\nint bios_capable = wmi_has_guid(HPWMI_BIOS_GUID);\r\nif (!bios_capable && !event_capable)\r\nreturn -ENODEV;\r\nif (event_capable) {\r\nerr = hp_wmi_input_setup();\r\nif (err)\r\nreturn err;\r\n}\r\nif (bios_capable) {\r\nhp_wmi_platform_dev =\r\nplatform_device_register_simple("hp-wmi", -1, NULL, 0);\r\nif (IS_ERR(hp_wmi_platform_dev)) {\r\nerr = PTR_ERR(hp_wmi_platform_dev);\r\ngoto err_destroy_input;\r\n}\r\nerr = platform_driver_probe(&hp_wmi_driver, hp_wmi_bios_setup);\r\nif (err)\r\ngoto err_unregister_device;\r\n}\r\nreturn 0;\r\nerr_unregister_device:\r\nplatform_device_unregister(hp_wmi_platform_dev);\r\nerr_destroy_input:\r\nif (event_capable)\r\nhp_wmi_input_destroy();\r\nreturn err;\r\n}\r\nstatic void __exit hp_wmi_exit(void)\r\n{\r\nif (wmi_has_guid(HPWMI_EVENT_GUID))\r\nhp_wmi_input_destroy();\r\nif (hp_wmi_platform_dev) {\r\nplatform_device_unregister(hp_wmi_platform_dev);\r\nplatform_driver_unregister(&hp_wmi_driver);\r\n}\r\n}

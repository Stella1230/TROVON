static void __init tx4938_wdr_init(void)\r\n{\r\nif (____raw_readq(&tx4938_ccfgptr->ccfg) & TX4938_CCFG_WDRST)\r\npr_warn("Watchdog reset detected at 0x%lx\n",\r\nread_c0_errorepc());\r\ntx4938_ccfg_set(TX4938_CCFG_WDRST);\r\ntx4938_ccfg_set(TX4938_CCFG_WR);\r\n}\r\nvoid __init tx4938_wdt_init(void)\r\n{\r\ntxx9_wdt_init(TX4938_TMR_REG(2) & 0xfffffffffULL);\r\n}\r\nstatic void tx4938_machine_restart(char *command)\r\n{\r\nlocal_irq_disable();\r\npr_emerg("Rebooting (with %s watchdog reset)...\n",\r\n(____raw_readq(&tx4938_ccfgptr->ccfg) & TX4938_CCFG_WDREXEN) ?\r\n"external" : "internal");\r\ntx4938_ccfg_set(TX4938_CCFG_WDRST);\r\ntxx9_wdt_now(TX4938_TMR_REG(2) & 0xfffffffffULL);\r\nwhile (!(____raw_readq(&tx4938_ccfgptr->ccfg) & TX4938_CCFG_WDRST))\r\n;\r\nmdelay(10);\r\nif (____raw_readq(&tx4938_ccfgptr->ccfg) & TX4938_CCFG_WDREXEN) {\r\npr_emerg("Rebooting (with internal watchdog reset)...\n");\r\ntx4938_ccfg_clear(TX4938_CCFG_WDREXEN);\r\n}\r\n(*_machine_halt)();\r\n}\r\nstatic int tx4938_be_handler(struct pt_regs *regs, int is_fixup)\r\n{\r\nint data = regs->cp0_cause & 4;\r\nconsole_verbose();\r\npr_err("%cBE exception at %#lx\n", data ? 'D' : 'I', regs->cp0_epc);\r\npr_err("ccfg:%llx, toea:%llx\n",\r\n(unsigned long long)____raw_readq(&tx4938_ccfgptr->ccfg),\r\n(unsigned long long)____raw_readq(&tx4938_ccfgptr->toea));\r\n#ifdef CONFIG_PCI\r\ntx4927_report_pcic_status();\r\n#endif\r\nshow_registers(regs);\r\npanic("BusError!");\r\n}\r\nstatic void __init tx4938_be_init(void)\r\n{\r\nboard_be_handler = tx4938_be_handler;\r\n}\r\nvoid __init tx4938_setup(void)\r\n{\r\nint i;\r\n__u32 divmode;\r\nunsigned int cpuclk = 0;\r\nu64 ccfg;\r\ntxx9_reg_res_init(TX4938_REV_PCODE(), TX4938_REG_BASE,\r\nTX4938_REG_SIZE);\r\nset_c0_config(TX49_CONF_CWFON);\r\nfor (i = 0; i < 8; i++) {\r\nif (!(TX4938_EBUSC_CR(i) & 0x8))\r\ncontinue;\r\ntxx9_ce_res[i].start = (unsigned long)TX4938_EBUSC_BA(i);\r\ntxx9_ce_res[i].end =\r\ntxx9_ce_res[i].start + TX4938_EBUSC_SIZE(i) - 1;\r\nrequest_resource(&iomem_resource, &txx9_ce_res[i]);\r\n}\r\nccfg = ____raw_readq(&tx4938_ccfgptr->ccfg);\r\nif (txx9_master_clock) {\r\ndivmode = (__u32)ccfg & TX4938_CCFG_DIVMODE_MASK;\r\nswitch (divmode) {\r\ncase TX4938_CCFG_DIVMODE_8:\r\ncase TX4938_CCFG_DIVMODE_10:\r\ncase TX4938_CCFG_DIVMODE_12:\r\ncase TX4938_CCFG_DIVMODE_16:\r\ncase TX4938_CCFG_DIVMODE_18:\r\ntxx9_gbus_clock = txx9_master_clock * 4; break;\r\ndefault:\r\ntxx9_gbus_clock = txx9_master_clock;\r\n}\r\nswitch (divmode) {\r\ncase TX4938_CCFG_DIVMODE_2:\r\ncase TX4938_CCFG_DIVMODE_8:\r\ncpuclk = txx9_gbus_clock * 2; break;\r\ncase TX4938_CCFG_DIVMODE_2_5:\r\ncase TX4938_CCFG_DIVMODE_10:\r\ncpuclk = txx9_gbus_clock * 5 / 2; break;\r\ncase TX4938_CCFG_DIVMODE_3:\r\ncase TX4938_CCFG_DIVMODE_12:\r\ncpuclk = txx9_gbus_clock * 3; break;\r\ncase TX4938_CCFG_DIVMODE_4:\r\ncase TX4938_CCFG_DIVMODE_16:\r\ncpuclk = txx9_gbus_clock * 4; break;\r\ncase TX4938_CCFG_DIVMODE_4_5:\r\ncase TX4938_CCFG_DIVMODE_18:\r\ncpuclk = txx9_gbus_clock * 9 / 2; break;\r\n}\r\ntxx9_cpu_clock = cpuclk;\r\n} else {\r\nif (txx9_cpu_clock == 0)\r\ntxx9_cpu_clock = 300000000;\r\ncpuclk = txx9_cpu_clock;\r\ndivmode = (__u32)ccfg & TX4938_CCFG_DIVMODE_MASK;\r\nswitch (divmode) {\r\ncase TX4938_CCFG_DIVMODE_2:\r\ncase TX4938_CCFG_DIVMODE_8:\r\ntxx9_gbus_clock = cpuclk / 2; break;\r\ncase TX4938_CCFG_DIVMODE_2_5:\r\ncase TX4938_CCFG_DIVMODE_10:\r\ntxx9_gbus_clock = cpuclk * 2 / 5; break;\r\ncase TX4938_CCFG_DIVMODE_3:\r\ncase TX4938_CCFG_DIVMODE_12:\r\ntxx9_gbus_clock = cpuclk / 3; break;\r\ncase TX4938_CCFG_DIVMODE_4:\r\ncase TX4938_CCFG_DIVMODE_16:\r\ntxx9_gbus_clock = cpuclk / 4; break;\r\ncase TX4938_CCFG_DIVMODE_4_5:\r\ncase TX4938_CCFG_DIVMODE_18:\r\ntxx9_gbus_clock = cpuclk * 2 / 9; break;\r\n}\r\nswitch (divmode) {\r\ncase TX4938_CCFG_DIVMODE_8:\r\ncase TX4938_CCFG_DIVMODE_10:\r\ncase TX4938_CCFG_DIVMODE_12:\r\ncase TX4938_CCFG_DIVMODE_16:\r\ncase TX4938_CCFG_DIVMODE_18:\r\ntxx9_master_clock = txx9_gbus_clock / 4; break;\r\ndefault:\r\ntxx9_master_clock = txx9_gbus_clock;\r\n}\r\n}\r\nloops_per_jiffy = txx9_cpu_clock / HZ / 2;\r\ntx4938_wdr_init();\r\ntx4938_ccfg_set(TX4938_CCFG_BEOW);\r\nif (txx9_ccfg_toeon)\r\ntx4938_ccfg_set(TX4938_CCFG_TOE);\r\ntxx9_clear64(&tx4938_ccfgptr->pcfg, TX4938_PCFG_DMASEL_ALL);\r\nif (!(____raw_readq(&tx4938_ccfgptr->ccfg) & TX4938_CCFG_PCIARB))\r\ntxx9_clear64(&tx4938_ccfgptr->pcfg, TX4938_PCFG_PCICLKEN_ALL);\r\nprintk(KERN_INFO "%s -- %dMHz(M%dMHz) CRIR:%08x CCFG:%llx PCFG:%llx\n",\r\ntxx9_pcode_str,\r\n(cpuclk + 500000) / 1000000,\r\n(txx9_master_clock + 500000) / 1000000,\r\n(__u32)____raw_readq(&tx4938_ccfgptr->crir),\r\n(unsigned long long)____raw_readq(&tx4938_ccfgptr->ccfg),\r\n(unsigned long long)____raw_readq(&tx4938_ccfgptr->pcfg));\r\nprintk(KERN_INFO "%s SDRAMC --", txx9_pcode_str);\r\nfor (i = 0; i < 4; i++) {\r\n__u64 cr = TX4938_SDRAMC_CR(i);\r\nunsigned long base, size;\r\nif (!((__u32)cr & 0x00000400))\r\ncontinue;\r\nbase = (unsigned long)(cr >> 49) << 21;\r\nsize = (((unsigned long)(cr >> 33) & 0x7fff) + 1) << 21;\r\nprintk(" CR%d:%016llx", i, (unsigned long long)cr);\r\ntx4938_sdram_resource[i].name = "SDRAM";\r\ntx4938_sdram_resource[i].start = base;\r\ntx4938_sdram_resource[i].end = base + size - 1;\r\ntx4938_sdram_resource[i].flags = IORESOURCE_MEM;\r\nrequest_resource(&iomem_resource, &tx4938_sdram_resource[i]);\r\n}\r\nprintk(" TR:%09llx\n",\r\n(unsigned long long)____raw_readq(&tx4938_sdramcptr->tr));\r\nif (txx9_pcode == 0x4938 && ____raw_readq(&tx4938_sramcptr->cr) & 1) {\r\nunsigned int size = TX4938_SRAM_SIZE;\r\ntx4938_sram_resource.name = "SRAM";\r\ntx4938_sram_resource.start =\r\n(____raw_readq(&tx4938_sramcptr->cr) >> (39-11))\r\n& ~(size - 1);\r\ntx4938_sram_resource.end =\r\ntx4938_sram_resource.start + TX4938_SRAM_SIZE - 1;\r\ntx4938_sram_resource.flags = IORESOURCE_MEM;\r\nrequest_resource(&iomem_resource, &tx4938_sram_resource);\r\n}\r\nfor (i = 0; i < TX4938_NR_TMR; i++)\r\ntxx9_tmr_init(TX4938_TMR_REG(i) & 0xfffffffffULL);\r\ntxx9_gpio_init(TX4938_PIO_REG & 0xfffffffffULL, 0, TX4938_NUM_PIO);\r\n__raw_writel(0, &tx4938_pioptr->maskcpu);\r\n__raw_writel(0, &tx4938_pioptr->maskext);\r\nif (txx9_pcode == 0x4938) {\r\n__u64 pcfg = ____raw_readq(&tx4938_ccfgptr->pcfg);\r\ntxx9_set64(&tx4938_ccfgptr->clkctr, TX4938_CLKCTR_PCIC1RST);\r\nif (pcfg & (TX4938_PCFG_ETH0_SEL | TX4938_PCFG_ETH1_SEL)) {\r\nmdelay(1);\r\ntxx9_clear64(&tx4938_ccfgptr->clkctr,\r\nTX4938_CLKCTR_PCIC1RST);\r\n} else {\r\nprintk(KERN_INFO "%s: stop PCIC1\n", txx9_pcode_str);\r\ntxx9_set64(&tx4938_ccfgptr->clkctr,\r\nTX4938_CLKCTR_PCIC1CKD);\r\n}\r\nif (!(pcfg & TX4938_PCFG_ETH0_SEL)) {\r\nprintk(KERN_INFO "%s: stop ETH0\n", txx9_pcode_str);\r\ntxx9_set64(&tx4938_ccfgptr->clkctr,\r\nTX4938_CLKCTR_ETH0RST);\r\ntxx9_set64(&tx4938_ccfgptr->clkctr,\r\nTX4938_CLKCTR_ETH0CKD);\r\n}\r\nif (!(pcfg & TX4938_PCFG_ETH1_SEL)) {\r\nprintk(KERN_INFO "%s: stop ETH1\n", txx9_pcode_str);\r\ntxx9_set64(&tx4938_ccfgptr->clkctr,\r\nTX4938_CLKCTR_ETH1RST);\r\ntxx9_set64(&tx4938_ccfgptr->clkctr,\r\nTX4938_CLKCTR_ETH1CKD);\r\n}\r\n}\r\n_machine_restart = tx4938_machine_restart;\r\nboard_be_init = tx4938_be_init;\r\n}\r\nvoid __init tx4938_time_init(unsigned int tmrnr)\r\n{\r\nif (____raw_readq(&tx4938_ccfgptr->ccfg) & TX4938_CCFG_TINTDIS)\r\ntxx9_clockevent_init(TX4938_TMR_REG(tmrnr) & 0xfffffffffULL,\r\nTXX9_IRQ_BASE + TX4938_IR_TMR(tmrnr),\r\nTXX9_IMCLK);\r\n}\r\nvoid __init tx4938_sio_init(unsigned int sclk, unsigned int cts_mask)\r\n{\r\nint i;\r\nunsigned int ch_mask = 0;\r\nif (__raw_readq(&tx4938_ccfgptr->pcfg) & TX4938_PCFG_ETH0_SEL)\r\nch_mask |= 1 << 1;\r\nfor (i = 0; i < 2; i++) {\r\nif ((1 << i) & ch_mask)\r\ncontinue;\r\ntxx9_sio_init(TX4938_SIO_REG(i) & 0xfffffffffULL,\r\nTXX9_IRQ_BASE + TX4938_IR_SIO(i),\r\ni, sclk, (1 << i) & cts_mask);\r\n}\r\n}\r\nvoid __init tx4938_spi_init(int busid)\r\n{\r\ntxx9_spi_init(busid, TX4938_SPI_REG & 0xfffffffffULL,\r\nTXX9_IRQ_BASE + TX4938_IR_SPI);\r\n}\r\nvoid __init tx4938_ethaddr_init(unsigned char *addr0, unsigned char *addr1)\r\n{\r\nu64 pcfg = __raw_readq(&tx4938_ccfgptr->pcfg);\r\nif (addr0 && (pcfg & TX4938_PCFG_ETH0_SEL))\r\ntxx9_ethaddr_init(TXX9_IRQ_BASE + TX4938_IR_ETH0, addr0);\r\nif (addr1 && (pcfg & TX4938_PCFG_ETH1_SEL))\r\ntxx9_ethaddr_init(TXX9_IRQ_BASE + TX4938_IR_ETH1, addr1);\r\n}\r\nvoid __init tx4938_mtd_init(int ch)\r\n{\r\nstruct physmap_flash_data pdata = {\r\n.width = TX4938_EBUSC_WIDTH(ch) / 8,\r\n};\r\nunsigned long start = txx9_ce_res[ch].start;\r\nunsigned long size = txx9_ce_res[ch].end - start + 1;\r\nif (!(TX4938_EBUSC_CR(ch) & 0x8))\r\nreturn;\r\ntxx9_physmap_flash_init(ch, start, size, &pdata);\r\n}\r\nvoid __init tx4938_ata_init(unsigned int irq, unsigned int shift, int tune)\r\n{\r\nstruct platform_device *pdev;\r\nstruct resource res[] = {\r\n{\r\n.flags = IORESOURCE_MEM,\r\n}, {\r\n.start = irq,\r\n.flags = IORESOURCE_IRQ,\r\n},\r\n};\r\nstruct tx4938ide_platform_info pdata = {\r\n.ioport_shift = shift,\r\n.gbus_clock = tune ? txx9_gbus_clock : 0,\r\n};\r\nu64 ebccr;\r\nint i;\r\nif ((__raw_readq(&tx4938_ccfgptr->pcfg) &\r\n(TX4938_PCFG_ATA_SEL | TX4938_PCFG_NDF_SEL))\r\n!= TX4938_PCFG_ATA_SEL)\r\nreturn;\r\nfor (i = 0; i < 8; i++) {\r\nebccr = __raw_readq(&tx4938_ebuscptr->cr[i]);\r\nif ((ebccr & 0x00f00008) == 0x00e00008)\r\nbreak;\r\n}\r\nif (i == 8)\r\nreturn;\r\npdata.ebus_ch = i;\r\nres[0].start = ((ebccr >> 48) << 20) + 0x10000;\r\nres[0].end = res[0].start + 0x20000 - 1;\r\npdev = platform_device_alloc("tx4938ide", -1);\r\nif (!pdev ||\r\nplatform_device_add_resources(pdev, res, ARRAY_SIZE(res)) ||\r\nplatform_device_add_data(pdev, &pdata, sizeof(pdata)) ||\r\nplatform_device_add(pdev))\r\nplatform_device_put(pdev);\r\n}\r\nvoid __init tx4938_ndfmc_init(unsigned int hold, unsigned int spw)\r\n{\r\nstruct txx9ndfmc_platform_data plat_data = {\r\n.shift = 1,\r\n.gbus_clock = txx9_gbus_clock,\r\n.hold = hold,\r\n.spw = spw,\r\n.ch_mask = 1,\r\n};\r\nunsigned long baseaddr = TX4938_NDFMC_REG & 0xfffffffffULL;\r\n#ifdef __BIG_ENDIAN\r\nbaseaddr += 4;\r\n#endif\r\nif ((__raw_readq(&tx4938_ccfgptr->pcfg) &\r\n(TX4938_PCFG_ATA_SEL|TX4938_PCFG_ISA_SEL|TX4938_PCFG_NDF_SEL)) ==\r\nTX4938_PCFG_NDF_SEL)\r\ntxx9_ndfmc_init(baseaddr, &plat_data);\r\n}\r\nvoid __init tx4938_dmac_init(int memcpy_chan0, int memcpy_chan1)\r\n{\r\nstruct txx9dmac_platform_data plat_data = {\r\n.have_64bit_regs = true,\r\n};\r\nint i;\r\nfor (i = 0; i < 2; i++) {\r\nplat_data.memcpy_chan = i ? memcpy_chan1 : memcpy_chan0;\r\ntxx9_dmac_init(i, TX4938_DMA_REG(i) & 0xfffffffffULL,\r\nTXX9_IRQ_BASE + TX4938_IR_DMA(i, 0),\r\n&plat_data);\r\n}\r\n}\r\nvoid __init tx4938_aclc_init(void)\r\n{\r\nu64 pcfg = __raw_readq(&tx4938_ccfgptr->pcfg);\r\nif ((pcfg & TX4938_PCFG_SEL2) &&\r\n!(pcfg & TX4938_PCFG_ETH0_SEL))\r\ntxx9_aclc_init(TX4938_ACLC_REG & 0xfffffffffULL,\r\nTXX9_IRQ_BASE + TX4938_IR_ACLC,\r\n1, 0, 1);\r\n}\r\nvoid __init tx4938_sramc_init(void)\r\n{\r\nif (tx4938_sram_resource.start)\r\ntxx9_sramc_init(&tx4938_sram_resource);\r\n}\r\nstatic void __init tx4938_stop_unused_modules(void)\r\n{\r\n__u64 pcfg, rst = 0, ckd = 0;\r\nchar buf[128];\r\nbuf[0] = '\0';\r\nlocal_irq_disable();\r\npcfg = ____raw_readq(&tx4938_ccfgptr->pcfg);\r\nswitch (txx9_pcode) {\r\ncase 0x4937:\r\nif (!(pcfg & TX4938_PCFG_SEL2)) {\r\nrst |= TX4938_CLKCTR_ACLRST;\r\nckd |= TX4938_CLKCTR_ACLCKD;\r\nstrcat(buf, " ACLC");\r\n}\r\nbreak;\r\ncase 0x4938:\r\nif (!(pcfg & TX4938_PCFG_SEL2) ||\r\n(pcfg & TX4938_PCFG_ETH0_SEL)) {\r\nrst |= TX4938_CLKCTR_ACLRST;\r\nckd |= TX4938_CLKCTR_ACLCKD;\r\nstrcat(buf, " ACLC");\r\n}\r\nif ((pcfg &\r\n(TX4938_PCFG_ATA_SEL | TX4938_PCFG_ISA_SEL |\r\nTX4938_PCFG_NDF_SEL))\r\n!= TX4938_PCFG_NDF_SEL) {\r\nrst |= TX4938_CLKCTR_NDFRST;\r\nckd |= TX4938_CLKCTR_NDFCKD;\r\nstrcat(buf, " NDFMC");\r\n}\r\nif (!(pcfg & TX4938_PCFG_SPI_SEL)) {\r\nrst |= TX4938_CLKCTR_SPIRST;\r\nckd |= TX4938_CLKCTR_SPICKD;\r\nstrcat(buf, " SPI");\r\n}\r\nbreak;\r\n}\r\nif (rst | ckd) {\r\ntxx9_set64(&tx4938_ccfgptr->clkctr, rst);\r\ntxx9_set64(&tx4938_ccfgptr->clkctr, ckd);\r\n}\r\nlocal_irq_enable();\r\nif (buf[0])\r\npr_info("%s: stop%s\n", txx9_pcode_str, buf);\r\n}\r\nstatic int __init tx4938_late_init(void)\r\n{\r\nif (txx9_pcode != 0x4937 && txx9_pcode != 0x4938)\r\nreturn -ENODEV;\r\ntx4938_stop_unused_modules();\r\nreturn 0;\r\n}

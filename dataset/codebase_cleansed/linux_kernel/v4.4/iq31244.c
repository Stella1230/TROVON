static int is_80219(void)\r\n{\r\nreturn !!((read_cpuid_id() & 0xffffffe0) == 0x69052e20);\r\n}\r\nstatic int is_ep80219(void)\r\n{\r\nif (machine_is_ep80219() || force_ep80219)\r\nreturn 1;\r\nelse\r\nreturn 0;\r\n}\r\nstatic void __init iq31244_timer_init(void)\r\n{\r\nif (is_ep80219()) {\r\niop_init_time(200000000);\r\n} else {\r\niop_init_time(198000000);\r\n}\r\n}\r\nvoid __init iq31244_map_io(void)\r\n{\r\niop3xx_map_io();\r\niotable_init(iq31244_io_desc, ARRAY_SIZE(iq31244_io_desc));\r\n}\r\nstatic int __init\r\nep80219_pci_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nint irq;\r\nif (slot == 0) {\r\nirq = IRQ_IOP32X_XINT1;\r\n} else if (slot == 1) {\r\nirq = IRQ_IOP32X_XINT0;\r\n} else if (slot == 2) {\r\nirq = IRQ_IOP32X_XINT3;\r\n} else if (slot == 3) {\r\nirq = IRQ_IOP32X_XINT2;\r\n} else {\r\nprintk(KERN_ERR "ep80219_pci_map_irq() called for unknown "\r\n"device PCI:%d:%d:%d\n", dev->bus->number,\r\nPCI_SLOT(dev->devfn), PCI_FUNC(dev->devfn));\r\nirq = -1;\r\n}\r\nreturn irq;\r\n}\r\nstatic int __init\r\niq31244_pci_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nint irq;\r\nif (slot == 0) {\r\nirq = IRQ_IOP32X_XINT1;\r\n} else if (slot == 1) {\r\nirq = IRQ_IOP32X_XINT2;\r\n} else if (slot == 2) {\r\nirq = IRQ_IOP32X_XINT3;\r\n} else if (slot == 3) {\r\nirq = IRQ_IOP32X_XINT0;\r\n} else {\r\nprintk(KERN_ERR "iq31244_pci_map_irq called for unknown "\r\n"device PCI:%d:%d:%d\n", dev->bus->number,\r\nPCI_SLOT(dev->devfn), PCI_FUNC(dev->devfn));\r\nirq = -1;\r\n}\r\nreturn irq;\r\n}\r\nstatic int __init iq31244_pci_init(void)\r\n{\r\nif (is_ep80219())\r\npci_common_init(&ep80219_pci);\r\nelse if (machine_is_iq31244()) {\r\nif (is_80219()) {\r\nprintk("note: iq31244 board type has been selected\n");\r\nprintk("note: to select ep80219 operation:\n");\r\nprintk("\t1/ specify \"force_ep80219\" on the kernel"\r\n" command line\n");\r\nprintk("\t2/ update boot loader to pass"\r\n" the ep80219 id: %d\n", MACH_TYPE_EP80219);\r\n}\r\npci_common_init(&iq31244_pci);\r\n}\r\nreturn 0;\r\n}\r\nvoid ep80219_power_off(void)\r\n{\r\n*IOP3XX_IDBR1 = 0x60;\r\n*IOP3XX_ICR1 = 0xE9;\r\nmdelay(1);\r\n*IOP3XX_IDBR1 = 0x0F;\r\n*IOP3XX_ICR1 = 0xE8;\r\nmdelay(1);\r\n*IOP3XX_IDBR1 = 0x03;\r\n*IOP3XX_ICR1 = 0xE8;\r\nmdelay(1);\r\n*IOP3XX_IDBR1 = 0x00;\r\n*IOP3XX_ICR1 = 0xEA;\r\nwhile (1)\r\n;\r\n}\r\nstatic void __init iq31244_init_machine(void)\r\n{\r\nregister_iop32x_gpio();\r\nplatform_device_register(&iop3xx_i2c0_device);\r\nplatform_device_register(&iop3xx_i2c1_device);\r\nplatform_device_register(&iq31244_flash_device);\r\nplatform_device_register(&iq31244_serial_device);\r\nplatform_device_register(&iop3xx_dma_0_channel);\r\nplatform_device_register(&iop3xx_dma_1_channel);\r\nif (is_ep80219())\r\npm_power_off = ep80219_power_off;\r\nif (!is_80219())\r\nplatform_device_register(&iop3xx_aau_channel);\r\n}\r\nstatic int __init force_ep80219_setup(char *str)\r\n{\r\nforce_ep80219 = 1;\r\nreturn 1;\r\n}

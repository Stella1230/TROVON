static void fsl_dcu_drm_crtc_atomic_begin(struct drm_crtc *crtc,\r\nstruct drm_crtc_state *old_crtc_state)\r\n{\r\n}\r\nstatic int fsl_dcu_drm_crtc_atomic_check(struct drm_crtc *crtc,\r\nstruct drm_crtc_state *state)\r\n{\r\nreturn 0;\r\n}\r\nstatic void fsl_dcu_drm_crtc_atomic_flush(struct drm_crtc *crtc,\r\nstruct drm_crtc_state *old_crtc_state)\r\n{\r\n}\r\nstatic void fsl_dcu_drm_disable_crtc(struct drm_crtc *crtc)\r\n{\r\nstruct drm_device *dev = crtc->dev;\r\nstruct fsl_dcu_drm_device *fsl_dev = dev->dev_private;\r\nint ret;\r\nret = regmap_update_bits(fsl_dev->regmap, DCU_DCU_MODE,\r\nDCU_MODE_DCU_MODE_MASK,\r\nDCU_MODE_DCU_MODE(DCU_MODE_OFF));\r\nif (ret)\r\ndev_err(fsl_dev->dev, "Disable CRTC failed\n");\r\nret = regmap_write(fsl_dev->regmap, DCU_UPDATE_MODE,\r\nDCU_UPDATE_MODE_READREG);\r\nif (ret)\r\ndev_err(fsl_dev->dev, "Enable CRTC failed\n");\r\n}\r\nstatic void fsl_dcu_drm_crtc_enable(struct drm_crtc *crtc)\r\n{\r\nstruct drm_device *dev = crtc->dev;\r\nstruct fsl_dcu_drm_device *fsl_dev = dev->dev_private;\r\nint ret;\r\nret = regmap_update_bits(fsl_dev->regmap, DCU_DCU_MODE,\r\nDCU_MODE_DCU_MODE_MASK,\r\nDCU_MODE_DCU_MODE(DCU_MODE_NORMAL));\r\nif (ret)\r\ndev_err(fsl_dev->dev, "Enable CRTC failed\n");\r\nret = regmap_write(fsl_dev->regmap, DCU_UPDATE_MODE,\r\nDCU_UPDATE_MODE_READREG);\r\nif (ret)\r\ndev_err(fsl_dev->dev, "Enable CRTC failed\n");\r\n}\r\nstatic bool fsl_dcu_drm_crtc_mode_fixup(struct drm_crtc *crtc,\r\nconst struct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nreturn true;\r\n}\r\nstatic void fsl_dcu_drm_crtc_mode_set_nofb(struct drm_crtc *crtc)\r\n{\r\nstruct drm_device *dev = crtc->dev;\r\nstruct fsl_dcu_drm_device *fsl_dev = dev->dev_private;\r\nstruct drm_display_mode *mode = &crtc->state->mode;\r\nunsigned int hbp, hfp, hsw, vbp, vfp, vsw, div, index;\r\nunsigned long dcuclk;\r\nint ret;\r\nindex = drm_crtc_index(crtc);\r\ndcuclk = clk_get_rate(fsl_dev->clk);\r\ndiv = dcuclk / mode->clock / 1000;\r\nhbp = mode->htotal - mode->hsync_end;\r\nhfp = mode->hsync_start - mode->hdisplay;\r\nhsw = mode->hsync_end - mode->hsync_start;\r\nvbp = mode->vtotal - mode->vsync_end;\r\nvfp = mode->vsync_start - mode->vdisplay;\r\nvsw = mode->vsync_end - mode->vsync_start;\r\nret = regmap_write(fsl_dev->regmap, DCU_HSYN_PARA,\r\nDCU_HSYN_PARA_BP(hbp) |\r\nDCU_HSYN_PARA_PW(hsw) |\r\nDCU_HSYN_PARA_FP(hfp));\r\nif (ret)\r\ngoto set_failed;\r\nret = regmap_write(fsl_dev->regmap, DCU_VSYN_PARA,\r\nDCU_VSYN_PARA_BP(vbp) |\r\nDCU_VSYN_PARA_PW(vsw) |\r\nDCU_VSYN_PARA_FP(vfp));\r\nif (ret)\r\ngoto set_failed;\r\nret = regmap_write(fsl_dev->regmap, DCU_DISP_SIZE,\r\nDCU_DISP_SIZE_DELTA_Y(mode->vdisplay) |\r\nDCU_DISP_SIZE_DELTA_X(mode->hdisplay));\r\nif (ret)\r\ngoto set_failed;\r\nret = regmap_write(fsl_dev->regmap, DCU_DIV_RATIO, div);\r\nif (ret)\r\ngoto set_failed;\r\nret = regmap_write(fsl_dev->regmap, DCU_SYN_POL,\r\nDCU_SYN_POL_INV_VS_LOW | DCU_SYN_POL_INV_HS_LOW);\r\nif (ret)\r\ngoto set_failed;\r\nret = regmap_write(fsl_dev->regmap, DCU_BGND, DCU_BGND_R(0) |\r\nDCU_BGND_G(0) | DCU_BGND_B(0));\r\nif (ret)\r\ngoto set_failed;\r\nret = regmap_write(fsl_dev->regmap, DCU_DCU_MODE,\r\nDCU_MODE_BLEND_ITER(1) | DCU_MODE_RASTER_EN);\r\nif (ret)\r\ngoto set_failed;\r\nret = regmap_write(fsl_dev->regmap, DCU_THRESHOLD,\r\nDCU_THRESHOLD_LS_BF_VS(BF_VS_VAL) |\r\nDCU_THRESHOLD_OUT_BUF_HIGH(BUF_MAX_VAL) |\r\nDCU_THRESHOLD_OUT_BUF_LOW(BUF_MIN_VAL));\r\nif (ret)\r\ngoto set_failed;\r\nret = regmap_write(fsl_dev->regmap, DCU_UPDATE_MODE,\r\nDCU_UPDATE_MODE_READREG);\r\nif (ret)\r\ngoto set_failed;\r\nreturn;\r\nset_failed:\r\ndev_err(dev->dev, "set DCU register failed\n");\r\n}\r\nint fsl_dcu_drm_crtc_create(struct fsl_dcu_drm_device *fsl_dev)\r\n{\r\nstruct drm_plane *primary;\r\nstruct drm_crtc *crtc = &fsl_dev->crtc;\r\nunsigned int i, j, reg_num;\r\nint ret;\r\nprimary = fsl_dcu_drm_primary_create_plane(fsl_dev->drm);\r\nret = drm_crtc_init_with_planes(fsl_dev->drm, crtc, primary, NULL,\r\n&fsl_dcu_drm_crtc_funcs);\r\nif (ret < 0)\r\nreturn ret;\r\ndrm_crtc_helper_add(crtc, &fsl_dcu_drm_crtc_helper_funcs);\r\nif (!strcmp(fsl_dev->soc->name, "ls1021a"))\r\nreg_num = LS1021A_LAYER_REG_NUM;\r\nelse\r\nreg_num = VF610_LAYER_REG_NUM;\r\nfor (i = 0; i <= fsl_dev->soc->total_layer; i++) {\r\nfor (j = 0; j < reg_num; j++) {\r\nret = regmap_write(fsl_dev->regmap,\r\nDCU_CTRLDESCLN(i, j), 0);\r\nif (ret)\r\ngoto init_failed;\r\n}\r\n}\r\nret = regmap_update_bits(fsl_dev->regmap, DCU_DCU_MODE,\r\nDCU_MODE_DCU_MODE_MASK,\r\nDCU_MODE_DCU_MODE(DCU_MODE_OFF));\r\nif (ret)\r\ngoto init_failed;\r\nret = regmap_write(fsl_dev->regmap, DCU_UPDATE_MODE,\r\nDCU_UPDATE_MODE_READREG);\r\nif (ret)\r\ngoto init_failed;\r\nreturn 0;\r\ninit_failed:\r\ndev_err(fsl_dev->dev, "init DCU register failed\n");\r\nreturn ret;\r\n}

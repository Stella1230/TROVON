static void __init net2big_sata_power_init(void)\r\n{\r\nint err;\r\norion_gpio_set_valid(NET2BIG_GPIO_SATA0_POWER, 1);\r\norion_gpio_set_valid(NET2BIG_GPIO_SATA1_POWER, 1);\r\nerr = gpio_request(NET2BIG_GPIO_SATA0_POWER, "SATA0 power status");\r\nif (err == 0) {\r\nerr = gpio_direction_input(NET2BIG_GPIO_SATA0_POWER);\r\nif (err)\r\ngpio_free(NET2BIG_GPIO_SATA0_POWER);\r\n}\r\nif (err) {\r\npr_err("net2big: failed to setup SATA0 power GPIO\n");\r\nreturn;\r\n}\r\nerr = gpio_request(NET2BIG_GPIO_SATA1_POWER, "SATA1 power status");\r\nif (err == 0) {\r\nerr = gpio_direction_input(NET2BIG_GPIO_SATA1_POWER);\r\nif (err)\r\ngpio_free(NET2BIG_GPIO_SATA1_POWER);\r\n}\r\nif (err) {\r\npr_err("net2big: failed to setup SATA1 power GPIO\n");\r\ngoto err_free_1;\r\n}\r\nerr = gpio_request(NET2BIG_GPIO_SATA_POWER_REQ, "SATA power request");\r\nif (err == 0) {\r\nerr = gpio_direction_output(NET2BIG_GPIO_SATA_POWER_REQ, 0);\r\nif (err)\r\ngpio_free(NET2BIG_GPIO_SATA_POWER_REQ);\r\n}\r\nif (err) {\r\npr_err("net2big: failed to setup SATA power request GPIO\n");\r\ngoto err_free_2;\r\n}\r\nif (gpio_get_value(NET2BIG_GPIO_SATA0_POWER) &&\r\ngpio_get_value(NET2BIG_GPIO_SATA1_POWER)) {\r\nreturn;\r\n}\r\nmsleep(300);\r\ngpio_set_value(NET2BIG_GPIO_SATA_POWER_REQ, 1);\r\npr_info("net2big: power up SATA hard disks\n");\r\nreturn;\r\nerr_free_2:\r\ngpio_free(NET2BIG_GPIO_SATA1_POWER);\r\nerr_free_1:\r\ngpio_free(NET2BIG_GPIO_SATA0_POWER);\r\nreturn;\r\n}\r\nstatic void __init net2big_gpio_leds_init(void)\r\n{\r\nint err;\r\nerr = gpio_request(NET2BIG_GPIO_PWR_LED_BLINK_STOP,\r\n"Power LED blink stop");\r\nif (err == 0) {\r\nerr = gpio_direction_output(NET2BIG_GPIO_PWR_LED_BLINK_STOP, 1);\r\nif (err)\r\ngpio_free(NET2BIG_GPIO_PWR_LED_BLINK_STOP);\r\n}\r\nif (err)\r\npr_err("net2big: failed to setup power LED blink GPIO\n");\r\nerr = gpio_request(NET2BIG_GPIO_SATA0_BLUE_LED,\r\n"SATA0 blue LED control");\r\nif (err == 0) {\r\nerr = gpio_direction_output(NET2BIG_GPIO_SATA0_BLUE_LED, 1);\r\nif (err)\r\ngpio_free(NET2BIG_GPIO_SATA0_BLUE_LED);\r\n}\r\nif (err)\r\npr_err("net2big: failed to setup SATA0 blue LED GPIO\n");\r\nerr = gpio_request(NET2BIG_GPIO_SATA1_BLUE_LED,\r\n"SATA1 blue LED control");\r\nif (err == 0) {\r\nerr = gpio_direction_output(NET2BIG_GPIO_SATA1_BLUE_LED, 1);\r\nif (err)\r\ngpio_free(NET2BIG_GPIO_SATA1_BLUE_LED);\r\n}\r\nif (err)\r\npr_err("net2big: failed to setup SATA1 blue LED GPIO\n");\r\nplatform_device_register(&net2big_gpio_leds);\r\n}\r\nstatic void net2big_power_off(void)\r\n{\r\ngpio_set_value(NET2BIG_GPIO_POWER_OFF, 1);\r\n}\r\nstatic void __init net2big_init(void)\r\n{\r\norion5x_init();\r\norion5x_mpp_conf(net2big_mpp_modes);\r\norion5x_ehci0_init();\r\norion5x_ehci1_init();\r\norion5x_eth_init(&net2big_eth_data);\r\norion5x_i2c_init();\r\norion5x_uart0_init();\r\norion5x_xor_init();\r\nnet2big_sata_power_init();\r\norion5x_sata_init(&net2big_sata_data);\r\nmvebu_mbus_add_window_by_id(ORION_MBUS_DEVBUS_BOOT_TARGET,\r\nORION_MBUS_DEVBUS_BOOT_ATTR,\r\nNET2BIG_NOR_BOOT_BASE,\r\nNET2BIG_NOR_BOOT_SIZE);\r\nplatform_device_register(&net2big_nor_flash);\r\nplatform_device_register(&net2big_gpio_buttons);\r\nnet2big_gpio_leds_init();\r\ni2c_register_board_info(0, net2big_i2c_devices,\r\nARRAY_SIZE(net2big_i2c_devices));\r\norion_gpio_set_valid(NET2BIG_GPIO_POWER_OFF, 1);\r\nif (gpio_request(NET2BIG_GPIO_POWER_OFF, "power-off") == 0 &&\r\ngpio_direction_output(NET2BIG_GPIO_POWER_OFF, 0) == 0)\r\npm_power_off = net2big_power_off;\r\nelse\r\npr_err("net2big: failed to configure power-off GPIO\n");\r\npr_notice("net2big: Flash writing is not yet supported.\n");\r\n}

static int tegra124_cpu_switch_to_dfll(struct tegra124_cpufreq_priv *priv)\r\n{\r\nstruct clk *orig_parent;\r\nint ret;\r\nret = clk_set_rate(priv->dfll_clk, clk_get_rate(priv->cpu_clk));\r\nif (ret)\r\nreturn ret;\r\norig_parent = clk_get_parent(priv->cpu_clk);\r\nclk_set_parent(priv->cpu_clk, priv->pllp_clk);\r\nret = clk_prepare_enable(priv->dfll_clk);\r\nif (ret)\r\ngoto out;\r\nclk_set_parent(priv->cpu_clk, priv->dfll_clk);\r\nreturn 0;\r\nout:\r\nclk_set_parent(priv->cpu_clk, orig_parent);\r\nreturn ret;\r\n}\r\nstatic void tegra124_cpu_switch_to_pllx(struct tegra124_cpufreq_priv *priv)\r\n{\r\nclk_set_parent(priv->cpu_clk, priv->pllp_clk);\r\nclk_disable_unprepare(priv->dfll_clk);\r\nregulator_sync_voltage(priv->vdd_cpu_reg);\r\nclk_set_parent(priv->cpu_clk, priv->pllx_clk);\r\n}\r\nstatic int tegra124_cpufreq_probe(struct platform_device *pdev)\r\n{\r\nstruct tegra124_cpufreq_priv *priv;\r\nstruct device_node *np;\r\nstruct device *cpu_dev;\r\nstruct platform_device_info cpufreq_dt_devinfo = {};\r\nint ret;\r\npriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\ncpu_dev = get_cpu_device(0);\r\nif (!cpu_dev)\r\nreturn -ENODEV;\r\nnp = of_cpu_device_node_get(0);\r\nif (!np)\r\nreturn -ENODEV;\r\npriv->vdd_cpu_reg = regulator_get(cpu_dev, "vdd-cpu");\r\nif (IS_ERR(priv->vdd_cpu_reg)) {\r\nret = PTR_ERR(priv->vdd_cpu_reg);\r\ngoto out_put_np;\r\n}\r\npriv->cpu_clk = of_clk_get_by_name(np, "cpu_g");\r\nif (IS_ERR(priv->cpu_clk)) {\r\nret = PTR_ERR(priv->cpu_clk);\r\ngoto out_put_vdd_cpu_reg;\r\n}\r\npriv->dfll_clk = of_clk_get_by_name(np, "dfll");\r\nif (IS_ERR(priv->dfll_clk)) {\r\nret = PTR_ERR(priv->dfll_clk);\r\ngoto out_put_cpu_clk;\r\n}\r\npriv->pllx_clk = of_clk_get_by_name(np, "pll_x");\r\nif (IS_ERR(priv->pllx_clk)) {\r\nret = PTR_ERR(priv->pllx_clk);\r\ngoto out_put_dfll_clk;\r\n}\r\npriv->pllp_clk = of_clk_get_by_name(np, "pll_p");\r\nif (IS_ERR(priv->pllp_clk)) {\r\nret = PTR_ERR(priv->pllp_clk);\r\ngoto out_put_pllx_clk;\r\n}\r\nret = tegra124_cpu_switch_to_dfll(priv);\r\nif (ret)\r\ngoto out_put_pllp_clk;\r\ncpufreq_dt_devinfo.name = "cpufreq-dt";\r\ncpufreq_dt_devinfo.parent = &pdev->dev;\r\ncpufreq_dt_devinfo.data = &cpufreq_dt_pd;\r\ncpufreq_dt_devinfo.size_data = sizeof(cpufreq_dt_pd);\r\npriv->cpufreq_dt_pdev =\r\nplatform_device_register_full(&cpufreq_dt_devinfo);\r\nif (IS_ERR(priv->cpufreq_dt_pdev)) {\r\nret = PTR_ERR(priv->cpufreq_dt_pdev);\r\ngoto out_switch_to_pllx;\r\n}\r\nplatform_set_drvdata(pdev, priv);\r\nreturn 0;\r\nout_switch_to_pllx:\r\ntegra124_cpu_switch_to_pllx(priv);\r\nout_put_pllp_clk:\r\nclk_put(priv->pllp_clk);\r\nout_put_pllx_clk:\r\nclk_put(priv->pllx_clk);\r\nout_put_dfll_clk:\r\nclk_put(priv->dfll_clk);\r\nout_put_cpu_clk:\r\nclk_put(priv->cpu_clk);\r\nout_put_vdd_cpu_reg:\r\nregulator_put(priv->vdd_cpu_reg);\r\nout_put_np:\r\nof_node_put(np);\r\nreturn ret;\r\n}\r\nstatic int tegra124_cpufreq_remove(struct platform_device *pdev)\r\n{\r\nstruct tegra124_cpufreq_priv *priv = platform_get_drvdata(pdev);\r\nplatform_device_unregister(priv->cpufreq_dt_pdev);\r\ntegra124_cpu_switch_to_pllx(priv);\r\nclk_put(priv->pllp_clk);\r\nclk_put(priv->pllx_clk);\r\nclk_put(priv->dfll_clk);\r\nclk_put(priv->cpu_clk);\r\nregulator_put(priv->vdd_cpu_reg);\r\nreturn 0;\r\n}\r\nstatic int __init tegra_cpufreq_init(void)\r\n{\r\nint ret;\r\nstruct platform_device *pdev;\r\nif (!of_machine_is_compatible("nvidia,tegra124"))\r\nreturn -ENODEV;\r\nret = platform_driver_register(&tegra124_cpufreq_platdrv);\r\nif (ret)\r\nreturn ret;\r\npdev = platform_device_register_simple("cpufreq-tegra124", -1, NULL, 0);\r\nif (IS_ERR(pdev)) {\r\nplatform_driver_unregister(&tegra124_cpufreq_platdrv);\r\nreturn PTR_ERR(pdev);\r\n}\r\nreturn 0;\r\n}

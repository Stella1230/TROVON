int drm_getmagic(struct drm_device *dev, void *data, struct drm_file *file_priv)\r\n{\r\nstruct drm_auth *auth = data;\r\nint ret = 0;\r\nmutex_lock(&dev->struct_mutex);\r\nif (!file_priv->magic) {\r\nret = idr_alloc(&file_priv->master->magic_map, file_priv,\r\n1, 0, GFP_KERNEL);\r\nif (ret >= 0)\r\nfile_priv->magic = ret;\r\n}\r\nauth->magic = file_priv->magic;\r\nmutex_unlock(&dev->struct_mutex);\r\nDRM_DEBUG("%u\n", auth->magic);\r\nreturn ret < 0 ? ret : 0;\r\n}\r\nint drm_authmagic(struct drm_device *dev, void *data,\r\nstruct drm_file *file_priv)\r\n{\r\nstruct drm_auth *auth = data;\r\nstruct drm_file *file;\r\nDRM_DEBUG("%u\n", auth->magic);\r\nmutex_lock(&dev->struct_mutex);\r\nfile = idr_find(&file_priv->master->magic_map, auth->magic);\r\nif (file) {\r\nfile->authenticated = 1;\r\nidr_replace(&file_priv->master->magic_map, NULL, auth->magic);\r\n}\r\nmutex_unlock(&dev->struct_mutex);\r\nreturn file ? 0 : -EINVAL;\r\n}

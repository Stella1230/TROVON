static u8 s3c24xx_clkout_get_parent(struct clk_hw *hw)\r\n{\r\nstruct s3c24xx_clkout *clkout = to_s3c24xx_clkout(hw);\r\nint num_parents = clk_hw_get_num_parents(hw);\r\nu32 val;\r\nval = readl_relaxed(S3C24XX_MISCCR) >> clkout->shift;\r\nval >>= clkout->shift;\r\nval &= clkout->mask;\r\nif (val >= num_parents)\r\nreturn -EINVAL;\r\nreturn val;\r\n}\r\nstatic int s3c24xx_clkout_set_parent(struct clk_hw *hw, u8 index)\r\n{\r\nstruct s3c24xx_clkout *clkout = to_s3c24xx_clkout(hw);\r\nint ret = 0;\r\ns3c2410_modify_misccr((clkout->mask << clkout->shift),\r\n(index << clkout->shift));\r\nreturn ret;\r\n}\r\nstatic struct clk *s3c24xx_register_clkout(struct device *dev, const char *name,\r\nconst char **parent_names, u8 num_parents,\r\nu8 shift, u32 mask)\r\n{\r\nstruct s3c24xx_clkout *clkout;\r\nstruct clk *clk;\r\nstruct clk_init_data init;\r\nclkout = kzalloc(sizeof(*clkout), GFP_KERNEL);\r\nif (!clkout)\r\nreturn ERR_PTR(-ENOMEM);\r\ninit.name = name;\r\ninit.ops = &s3c24xx_clkout_ops;\r\ninit.flags = CLK_IS_BASIC;\r\ninit.parent_names = parent_names;\r\ninit.num_parents = num_parents;\r\nclkout->shift = shift;\r\nclkout->mask = mask;\r\nclkout->hw.init = &init;\r\nclk = clk_register(dev, &clkout->hw);\r\nreturn clk;\r\n}\r\nstatic void s3c24xx_dclk_update_cmp(struct s3c24xx_dclk *s3c24xx_dclk,\r\nint div_shift, int cmp_shift)\r\n{\r\nunsigned long flags = 0;\r\nu32 dclk_con, div, cmp;\r\nspin_lock_irqsave(&s3c24xx_dclk->dclk_lock, flags);\r\ndclk_con = readl_relaxed(s3c24xx_dclk->base);\r\ndiv = ((dclk_con >> div_shift) & DCLKCON_DCLK_DIV_MASK) + 1;\r\ncmp = ((div + 1) / 2) - 1;\r\ndclk_con &= ~(DCLKCON_DCLK_DIV_MASK << cmp_shift);\r\ndclk_con |= (cmp << cmp_shift);\r\nwritel_relaxed(dclk_con, s3c24xx_dclk->base);\r\nspin_unlock_irqrestore(&s3c24xx_dclk->dclk_lock, flags);\r\n}\r\nstatic int s3c24xx_dclk0_div_notify(struct notifier_block *nb,\r\nunsigned long event, void *data)\r\n{\r\nstruct s3c24xx_dclk *s3c24xx_dclk = to_s3c24xx_dclk0(nb);\r\nif (event == POST_RATE_CHANGE) {\r\ns3c24xx_dclk_update_cmp(s3c24xx_dclk,\r\nDCLKCON_DCLK0_DIV_SHIFT, DCLKCON_DCLK0_CMP_SHIFT);\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int s3c24xx_dclk1_div_notify(struct notifier_block *nb,\r\nunsigned long event, void *data)\r\n{\r\nstruct s3c24xx_dclk *s3c24xx_dclk = to_s3c24xx_dclk1(nb);\r\nif (event == POST_RATE_CHANGE) {\r\ns3c24xx_dclk_update_cmp(s3c24xx_dclk,\r\nDCLKCON_DCLK1_DIV_SHIFT, DCLKCON_DCLK1_CMP_SHIFT);\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int s3c24xx_dclk_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct s3c24xx_dclk *s3c24xx_dclk = platform_get_drvdata(pdev);\r\ns3c24xx_dclk->reg_save = readl_relaxed(s3c24xx_dclk->base);\r\nreturn 0;\r\n}\r\nstatic int s3c24xx_dclk_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct s3c24xx_dclk *s3c24xx_dclk = platform_get_drvdata(pdev);\r\nwritel_relaxed(s3c24xx_dclk->reg_save, s3c24xx_dclk->base);\r\nreturn 0;\r\n}\r\nstatic int s3c24xx_dclk_probe(struct platform_device *pdev)\r\n{\r\nstruct s3c24xx_dclk *s3c24xx_dclk;\r\nstruct resource *mem;\r\nstruct clk **clk_table;\r\nstruct s3c24xx_dclk_drv_data *dclk_variant;\r\nint ret, i;\r\ns3c24xx_dclk = devm_kzalloc(&pdev->dev, sizeof(*s3c24xx_dclk),\r\nGFP_KERNEL);\r\nif (!s3c24xx_dclk)\r\nreturn -ENOMEM;\r\ns3c24xx_dclk->dev = &pdev->dev;\r\nplatform_set_drvdata(pdev, s3c24xx_dclk);\r\nspin_lock_init(&s3c24xx_dclk->dclk_lock);\r\nclk_table = devm_kzalloc(&pdev->dev,\r\nsizeof(struct clk *) * DCLK_MAX_CLKS,\r\nGFP_KERNEL);\r\nif (!clk_table)\r\nreturn -ENOMEM;\r\ns3c24xx_dclk->clk_data.clks = clk_table;\r\ns3c24xx_dclk->clk_data.clk_num = DCLK_MAX_CLKS;\r\nmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ns3c24xx_dclk->base = devm_ioremap_resource(&pdev->dev, mem);\r\nif (IS_ERR(s3c24xx_dclk->base))\r\nreturn PTR_ERR(s3c24xx_dclk->base);\r\ndclk_variant = (struct s3c24xx_dclk_drv_data *)\r\nplatform_get_device_id(pdev)->driver_data;\r\nclk_table[MUX_DCLK0] = clk_register_mux(&pdev->dev, "mux_dclk0",\r\ndclk_variant->mux_parent_names,\r\ndclk_variant->mux_num_parents, 0,\r\ns3c24xx_dclk->base, 1, 1, 0,\r\n&s3c24xx_dclk->dclk_lock);\r\nclk_table[MUX_DCLK1] = clk_register_mux(&pdev->dev, "mux_dclk1",\r\ndclk_variant->mux_parent_names,\r\ndclk_variant->mux_num_parents, 0,\r\ns3c24xx_dclk->base, 17, 1, 0,\r\n&s3c24xx_dclk->dclk_lock);\r\nclk_table[DIV_DCLK0] = clk_register_divider(&pdev->dev, "div_dclk0",\r\n"mux_dclk0", 0, s3c24xx_dclk->base,\r\n4, 4, 0, &s3c24xx_dclk->dclk_lock);\r\nclk_table[DIV_DCLK1] = clk_register_divider(&pdev->dev, "div_dclk1",\r\n"mux_dclk1", 0, s3c24xx_dclk->base,\r\n20, 4, 0, &s3c24xx_dclk->dclk_lock);\r\nclk_table[GATE_DCLK0] = clk_register_gate(&pdev->dev, "gate_dclk0",\r\n"div_dclk0", CLK_SET_RATE_PARENT,\r\ns3c24xx_dclk->base, 0, 0,\r\n&s3c24xx_dclk->dclk_lock);\r\nclk_table[GATE_DCLK1] = clk_register_gate(&pdev->dev, "gate_dclk1",\r\n"div_dclk1", CLK_SET_RATE_PARENT,\r\ns3c24xx_dclk->base, 16, 0,\r\n&s3c24xx_dclk->dclk_lock);\r\nclk_table[MUX_CLKOUT0] = s3c24xx_register_clkout(&pdev->dev,\r\n"clkout0", dclk_variant->clkout0_parent_names,\r\ndclk_variant->clkout0_num_parents, 4, 7);\r\nclk_table[MUX_CLKOUT1] = s3c24xx_register_clkout(&pdev->dev,\r\n"clkout1", dclk_variant->clkout1_parent_names,\r\ndclk_variant->clkout1_num_parents, 8, 7);\r\nfor (i = 0; i < DCLK_MAX_CLKS; i++)\r\nif (IS_ERR(clk_table[i])) {\r\ndev_err(&pdev->dev, "clock %d failed to register\n", i);\r\nret = PTR_ERR(clk_table[i]);\r\ngoto err_clk_register;\r\n}\r\nret = clk_register_clkdev(clk_table[MUX_DCLK0], "dclk0", NULL);\r\nif (!ret)\r\nret = clk_register_clkdev(clk_table[MUX_DCLK1], "dclk1", NULL);\r\nif (!ret)\r\nret = clk_register_clkdev(clk_table[MUX_CLKOUT0],\r\n"clkout0", NULL);\r\nif (!ret)\r\nret = clk_register_clkdev(clk_table[MUX_CLKOUT1],\r\n"clkout1", NULL);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to register aliases, %d\n", ret);\r\ngoto err_clk_register;\r\n}\r\ns3c24xx_dclk->dclk0_div_change_nb.notifier_call =\r\ns3c24xx_dclk0_div_notify;\r\ns3c24xx_dclk->dclk1_div_change_nb.notifier_call =\r\ns3c24xx_dclk1_div_notify;\r\nret = clk_notifier_register(clk_table[DIV_DCLK0],\r\n&s3c24xx_dclk->dclk0_div_change_nb);\r\nif (ret)\r\ngoto err_clk_register;\r\nret = clk_notifier_register(clk_table[DIV_DCLK1],\r\n&s3c24xx_dclk->dclk1_div_change_nb);\r\nif (ret)\r\ngoto err_dclk_notify;\r\nreturn 0;\r\nerr_dclk_notify:\r\nclk_notifier_unregister(clk_table[DIV_DCLK0],\r\n&s3c24xx_dclk->dclk0_div_change_nb);\r\nerr_clk_register:\r\nfor (i = 0; i < DCLK_MAX_CLKS; i++)\r\nif (clk_table[i] && !IS_ERR(clk_table[i]))\r\nclk_unregister(clk_table[i]);\r\nreturn ret;\r\n}\r\nstatic int s3c24xx_dclk_remove(struct platform_device *pdev)\r\n{\r\nstruct s3c24xx_dclk *s3c24xx_dclk = platform_get_drvdata(pdev);\r\nstruct clk **clk_table = s3c24xx_dclk->clk_data.clks;\r\nint i;\r\nclk_notifier_unregister(clk_table[DIV_DCLK1],\r\n&s3c24xx_dclk->dclk1_div_change_nb);\r\nclk_notifier_unregister(clk_table[DIV_DCLK0],\r\n&s3c24xx_dclk->dclk0_div_change_nb);\r\nfor (i = 0; i < DCLK_MAX_CLKS; i++)\r\nclk_unregister(clk_table[i]);\r\nreturn 0;\r\n}

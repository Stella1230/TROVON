static bool ar9003_hw_is_aic_enabled(struct ath_hw *ah)\r\n{\r\nstruct ath9k_hw_mci *mci_hw = &ah->btcoex_hw.mci;\r\nreturn false;\r\nif (mci_hw->config & ATH_MCI_CONFIG_DISABLE_AIC)\r\nreturn false;\r\nreturn true;\r\n}\r\nstatic int16_t ar9003_aic_find_valid(struct ath_aic_sram_info *cal_sram,\r\nbool dir, u8 index)\r\n{\r\nint16_t i;\r\nif (dir) {\r\nfor (i = index + 1; i < ATH_AIC_MAX_BT_CHANNEL; i++) {\r\nif (cal_sram[i].valid)\r\nbreak;\r\n}\r\n} else {\r\nfor (i = index - 1; i >= 0; i--) {\r\nif (cal_sram[i].valid)\r\nbreak;\r\n}\r\n}\r\nif ((i >= ATH_AIC_MAX_BT_CHANNEL) || (i < 0))\r\ni = -1;\r\nreturn i;\r\n}\r\nstatic int16_t ar9003_aic_find_index(u8 type, int16_t value)\r\n{\r\nint16_t i = -1;\r\nif (type == 0) {\r\nfor (i = ATH_AIC_MAX_AIC_LIN_TABLE - 1; i >= 0; i--) {\r\nif (aic_lin_table[i] >= value)\r\nbreak;\r\n}\r\n} else if (type == 1) {\r\nfor (i = 0; i < ATH_AIC_MAX_COM_ATT_DB_TABLE; i++) {\r\nif (com_att_db_table[i] > value) {\r\ni--;\r\nbreak;\r\n}\r\n}\r\nif (i >= ATH_AIC_MAX_COM_ATT_DB_TABLE)\r\ni = -1;\r\n}\r\nreturn i;\r\n}\r\nstatic void ar9003_aic_gain_table(struct ath_hw *ah)\r\n{\r\nu32 aic_atten_word[19], i;\r\nREG_WRITE(ah, AR_PHY_BT_COEX_4, 0x2c200a00);\r\nREG_WRITE(ah, AR_PHY_BT_COEX_5, 0x5c4e4438);\r\naic_atten_word[0] = (0x1 & 0xf) << 14 | (0x1f & 0x1f) << 9 | (0x0 & 0xf) << 5 |\r\n(0x1f & 0x1f);\r\naic_atten_word[1] = (0x3 & 0xf) << 14 | (0x1f & 0x1f) << 9 | (0x2 & 0xf) << 5 |\r\n(0x1f & 0x1f);\r\naic_atten_word[2] = (0x5 & 0xf) << 14 | (0x1f & 0x1f) << 9 | (0x4 & 0xf) << 5 |\r\n(0x1f & 0x1f);\r\naic_atten_word[3] = (0x1 & 0xf) << 14 | (0x1e & 0x1f) << 9 | (0x0 & 0xf) << 5 |\r\n(0x1e & 0x1f);\r\naic_atten_word[4] = (0x3 & 0xf) << 14 | (0x1e & 0x1f) << 9 | (0x2 & 0xf) << 5 |\r\n(0x1e & 0x1f);\r\naic_atten_word[5] = (0x5 & 0xf) << 14 | (0x1e & 0x1f) << 9 | (0x4 & 0xf) << 5 |\r\n(0x1e & 0x1f);\r\naic_atten_word[6] = (0x1 & 0xf) << 14 | (0xf & 0x1f) << 9 | (0x0 & 0xf) << 5 |\r\n(0xf & 0x1f);\r\naic_atten_word[7] = (0x3 & 0xf) << 14 | (0xf & 0x1f) << 9 | (0x2 & 0xf) << 5 |\r\n(0xf & 0x1f);\r\naic_atten_word[8] = (0x5 & 0xf) << 14 | (0xf & 0x1f) << 9 | (0x4 & 0xf) << 5 |\r\n(0xf & 0x1f);\r\naic_atten_word[9] = (0x1 & 0xf) << 14 | (0x7 & 0x1f) << 9 | (0x0 & 0xf) << 5 |\r\n(0x7 & 0x1f);\r\naic_atten_word[10] = (0x3 & 0xf) << 14 | (0x7 & 0x1f) << 9 | (0x2 & 0xf) << 5 |\r\n(0x7 & 0x1f);\r\naic_atten_word[11] = (0x5 & 0xf) << 14 | (0x7 & 0x1f) << 9 | (0x4 & 0xf) << 5 |\r\n(0x7 & 0x1f);\r\naic_atten_word[12] = (0x7 & 0xf) << 14 | (0x7 & 0x1f) << 9 | (0x6 & 0xf) << 5 |\r\n(0x7 & 0x1f);\r\naic_atten_word[13] = (0x3 & 0xf) << 14 | (0x3 & 0x1f) << 9 | (0x2 & 0xf) << 5 |\r\n(0x3 & 0x1f);\r\naic_atten_word[14] = (0x5 & 0xf) << 14 | (0x3 & 0x1f) << 9 | (0x4 & 0xf) << 5 |\r\n(0x3 & 0x1f);\r\naic_atten_word[15] = (0x1 & 0xf) << 14 | (0x1 & 0x1f) << 9 | (0x0 & 0xf) << 5 |\r\n(0x1 & 0x1f);\r\naic_atten_word[16] = (0x3 & 0xf) << 14 | (0x1 & 0x1f) << 9 | (0x2 & 0xf) << 5 |\r\n(0x1 & 0x1f);\r\naic_atten_word[17] = (0x5 & 0xf) << 14 | (0x1 & 0x1f) << 9 | (0x4 & 0xf) << 5 |\r\n(0x1 & 0x1f);\r\naic_atten_word[18] = (0x7 & 0xf) << 14 | (0x1 & 0x1f) << 9 | (0x6 & 0xf) << 5 |\r\n(0x1 & 0x1f);\r\nREG_WRITE(ah, (AR_PHY_AIC_SRAM_ADDR_B0 + 0x3000),\r\n(ATH_AIC_SRAM_AUTO_INCREMENT |\r\nATH_AIC_SRAM_GAIN_TABLE_OFFSET));\r\nfor (i = 0; i < 19; i++) {\r\nREG_WRITE(ah, (AR_PHY_AIC_SRAM_DATA_B0 + 0x3000),\r\naic_atten_word[i]);\r\n}\r\n}\r\nstatic u8 ar9003_aic_cal_start(struct ath_hw *ah, u8 min_valid_count)\r\n{\r\nstruct ath9k_hw_aic *aic = &ah->btcoex_hw.aic;\r\nint i;\r\nREG_WRITE(ah, (AR_PHY_AIC_SRAM_ADDR_B0 + 0x3000),\r\n(ATH_AIC_SRAM_AUTO_INCREMENT |\r\nATH_AIC_SRAM_CAL_OFFSET));\r\nfor (i = 0; i < ATH_AIC_MAX_BT_CHANNEL; i++) {\r\nREG_WRITE(ah, (AR_PHY_AIC_SRAM_DATA_B0 + 0x3000), 0);\r\naic->aic_sram[i] = 0;\r\n}\r\nREG_WRITE(ah, AR_PHY_AIC_CTRL_0_B0,\r\n(SM(0, AR_PHY_AIC_MON_ENABLE) |\r\nSM(127, AR_PHY_AIC_CAL_MAX_HOP_COUNT) |\r\nSM(min_valid_count, AR_PHY_AIC_CAL_MIN_VALID_COUNT) |\r\nSM(37, AR_PHY_AIC_F_WLAN) |\r\nSM(1, AR_PHY_AIC_CAL_CH_VALID_RESET) |\r\nSM(0, AR_PHY_AIC_CAL_ENABLE) |\r\nSM(0x40, AR_PHY_AIC_BTTX_PWR_THR) |\r\nSM(0, AR_PHY_AIC_ENABLE)));\r\nREG_WRITE(ah, AR_PHY_AIC_CTRL_0_B1,\r\n(SM(0, AR_PHY_AIC_MON_ENABLE) |\r\nSM(1, AR_PHY_AIC_CAL_CH_VALID_RESET) |\r\nSM(0, AR_PHY_AIC_CAL_ENABLE) |\r\nSM(0x40, AR_PHY_AIC_BTTX_PWR_THR) |\r\nSM(0, AR_PHY_AIC_ENABLE)));\r\nREG_WRITE(ah, AR_PHY_AIC_CTRL_1_B0,\r\n(SM(8, AR_PHY_AIC_CAL_BT_REF_DELAY) |\r\nSM(0, AR_PHY_AIC_BT_IDLE_CFG) |\r\nSM(1, AR_PHY_AIC_STDBY_COND) |\r\nSM(37, AR_PHY_AIC_STDBY_ROT_ATT_DB) |\r\nSM(5, AR_PHY_AIC_STDBY_COM_ATT_DB) |\r\nSM(15, AR_PHY_AIC_RSSI_MAX) |\r\nSM(0, AR_PHY_AIC_RSSI_MIN)));\r\nREG_WRITE(ah, AR_PHY_AIC_CTRL_1_B1,\r\n(SM(15, AR_PHY_AIC_RSSI_MAX) |\r\nSM(0, AR_PHY_AIC_RSSI_MIN)));\r\nREG_WRITE(ah, AR_PHY_AIC_CTRL_2_B0,\r\n(SM(44, AR_PHY_AIC_RADIO_DELAY) |\r\nSM(8, AR_PHY_AIC_CAL_STEP_SIZE_CORR) |\r\nSM(12, AR_PHY_AIC_CAL_ROT_IDX_CORR) |\r\nSM(2, AR_PHY_AIC_CAL_CONV_CHECK_FACTOR) |\r\nSM(5, AR_PHY_AIC_ROT_IDX_COUNT_MAX) |\r\nSM(0, AR_PHY_AIC_CAL_SYNTH_TOGGLE) |\r\nSM(0, AR_PHY_AIC_CAL_SYNTH_AFTER_BTRX) |\r\nSM(200, AR_PHY_AIC_CAL_SYNTH_SETTLING)));\r\nREG_WRITE(ah, AR_PHY_AIC_CTRL_3_B0,\r\n(SM(2, AR_PHY_AIC_MON_MAX_HOP_COUNT) |\r\nSM(1, AR_PHY_AIC_MON_MIN_STALE_COUNT) |\r\nSM(1, AR_PHY_AIC_MON_PWR_EST_LONG) |\r\nSM(2, AR_PHY_AIC_MON_PD_TALLY_SCALING) |\r\nSM(10, AR_PHY_AIC_MON_PERF_THR) |\r\nSM(2, AR_PHY_AIC_CAL_TARGET_MAG_SETTING) |\r\nSM(1, AR_PHY_AIC_CAL_PERF_CHECK_FACTOR) |\r\nSM(1, AR_PHY_AIC_CAL_PWR_EST_LONG)));\r\nREG_WRITE(ah, AR_PHY_AIC_CTRL_4_B0,\r\n(SM(2, AR_PHY_AIC_CAL_ROT_ATT_DB_EST_ISO) |\r\nSM(3, AR_PHY_AIC_CAL_COM_ATT_DB_EST_ISO) |\r\nSM(0, AR_PHY_AIC_CAL_ISO_EST_INIT_SETTING) |\r\nSM(2, AR_PHY_AIC_CAL_COM_ATT_DB_BACKOFF) |\r\nSM(1, AR_PHY_AIC_CAL_COM_ATT_DB_FIXED)));\r\nREG_WRITE(ah, AR_PHY_AIC_CTRL_4_B1,\r\n(SM(2, AR_PHY_AIC_CAL_ROT_ATT_DB_EST_ISO) |\r\nSM(3, AR_PHY_AIC_CAL_COM_ATT_DB_EST_ISO) |\r\nSM(0, AR_PHY_AIC_CAL_ISO_EST_INIT_SETTING) |\r\nSM(2, AR_PHY_AIC_CAL_COM_ATT_DB_BACKOFF) |\r\nSM(1, AR_PHY_AIC_CAL_COM_ATT_DB_FIXED)));\r\nar9003_aic_gain_table(ah);\r\nREG_WRITE(ah, ATH_AIC_BT_JUPITER_CTRL,\r\n(REG_READ(ah, ATH_AIC_BT_JUPITER_CTRL) |\r\nATH_AIC_BT_AIC_ENABLE));\r\naic->aic_cal_start_time = REG_READ(ah, AR_TSF_L32);\r\nREG_CLR_BIT(ah, AR_PHY_AIC_CTRL_0_B1, AR_PHY_AIC_CAL_ENABLE);\r\nREG_SET_BIT(ah, AR_PHY_AIC_CTRL_0_B1, AR_PHY_AIC_CAL_CH_VALID_RESET);\r\nREG_SET_BIT(ah, AR_PHY_AIC_CTRL_0_B1, AR_PHY_AIC_CAL_ENABLE);\r\naic->aic_caled_chan = 0;\r\naic->aic_cal_state = AIC_CAL_STATE_STARTED;\r\nreturn aic->aic_cal_state;\r\n}\r\nstatic bool ar9003_aic_cal_post_process(struct ath_hw *ah)\r\n{\r\nstruct ath9k_hw_aic *aic = &ah->btcoex_hw.aic;\r\nstruct ath_aic_sram_info cal_sram[ATH_AIC_MAX_BT_CHANNEL];\r\nstruct ath_aic_out_info aic_sram[ATH_AIC_MAX_BT_CHANNEL];\r\nu32 dir_path_gain_idx, quad_path_gain_idx, value;\r\nu32 fixed_com_att_db;\r\nint8_t dir_path_sign, quad_path_sign;\r\nint16_t i;\r\nbool ret = true;\r\nmemset(&cal_sram, 0, sizeof(cal_sram));\r\nmemset(&aic_sram, 0, sizeof(aic_sram));\r\nfor (i = 0; i < ATH_AIC_MAX_BT_CHANNEL; i++) {\r\nvalue = aic->aic_sram[i];\r\ncal_sram[i].valid =\r\nMS(value, AR_PHY_AIC_SRAM_VALID);\r\ncal_sram[i].rot_quad_att_db =\r\nMS(value, AR_PHY_AIC_SRAM_ROT_QUAD_ATT_DB);\r\ncal_sram[i].vga_quad_sign =\r\nMS(value, AR_PHY_AIC_SRAM_VGA_QUAD_SIGN);\r\ncal_sram[i].rot_dir_att_db =\r\nMS(value, AR_PHY_AIC_SRAM_ROT_DIR_ATT_DB);\r\ncal_sram[i].vga_dir_sign =\r\nMS(value, AR_PHY_AIC_SRAM_VGA_DIR_SIGN);\r\ncal_sram[i].com_att_6db =\r\nMS(value, AR_PHY_AIC_SRAM_COM_ATT_6DB);\r\nif (cal_sram[i].valid) {\r\ndir_path_gain_idx = cal_sram[i].rot_dir_att_db +\r\ncom_att_db_table[cal_sram[i].com_att_6db];\r\nquad_path_gain_idx = cal_sram[i].rot_quad_att_db +\r\ncom_att_db_table[cal_sram[i].com_att_6db];\r\ndir_path_sign = (cal_sram[i].vga_dir_sign) ? 1 : -1;\r\nquad_path_sign = (cal_sram[i].vga_quad_sign) ? 1 : -1;\r\naic_sram[i].dir_path_gain_lin = dir_path_sign *\r\naic_lin_table[dir_path_gain_idx];\r\naic_sram[i].quad_path_gain_lin = quad_path_sign *\r\naic_lin_table[quad_path_gain_idx];\r\n}\r\n}\r\nfor (i = 0; i < ATH_AIC_MAX_BT_CHANNEL; i++) {\r\nint16_t start_idx, end_idx;\r\nif (cal_sram[i].valid)\r\ncontinue;\r\nstart_idx = ar9003_aic_find_valid(cal_sram, 0, i);\r\nend_idx = ar9003_aic_find_valid(cal_sram, 1, i);\r\nif (start_idx < 0) {\r\nstart_idx = end_idx;\r\nend_idx = ar9003_aic_find_valid(cal_sram, 1, start_idx);\r\nif (end_idx < 0) {\r\nret = false;\r\nbreak;\r\n}\r\naic_sram[i].dir_path_gain_lin =\r\n((aic_sram[start_idx].dir_path_gain_lin -\r\naic_sram[end_idx].dir_path_gain_lin) *\r\n(start_idx - i) + ((end_idx - i) >> 1)) /\r\n(end_idx - i) +\r\naic_sram[start_idx].dir_path_gain_lin;\r\naic_sram[i].quad_path_gain_lin =\r\n((aic_sram[start_idx].quad_path_gain_lin -\r\naic_sram[end_idx].quad_path_gain_lin) *\r\n(start_idx - i) + ((end_idx - i) >> 1)) /\r\n(end_idx - i) +\r\naic_sram[start_idx].quad_path_gain_lin;\r\n}\r\nif (end_idx < 0) {\r\nend_idx = ar9003_aic_find_valid(cal_sram, 0, start_idx);\r\nif (end_idx < 0) {\r\nret = false;\r\nbreak;\r\n}\r\naic_sram[i].dir_path_gain_lin =\r\n((aic_sram[start_idx].dir_path_gain_lin -\r\naic_sram[end_idx].dir_path_gain_lin) *\r\n(i - start_idx) + ((start_idx - end_idx) >> 1)) /\r\n(start_idx - end_idx) +\r\naic_sram[start_idx].dir_path_gain_lin;\r\naic_sram[i].quad_path_gain_lin =\r\n((aic_sram[start_idx].quad_path_gain_lin -\r\naic_sram[end_idx].quad_path_gain_lin) *\r\n(i - start_idx) + ((start_idx - end_idx) >> 1)) /\r\n(start_idx - end_idx) +\r\naic_sram[start_idx].quad_path_gain_lin;\r\n} else if (start_idx >= 0){\r\naic_sram[i].dir_path_gain_lin =\r\n(((end_idx - i) * aic_sram[start_idx].dir_path_gain_lin) +\r\n((i - start_idx) * aic_sram[end_idx].dir_path_gain_lin) +\r\n((end_idx - start_idx) >> 1)) /\r\n(end_idx - start_idx);\r\naic_sram[i].quad_path_gain_lin =\r\n(((end_idx - i) * aic_sram[start_idx].quad_path_gain_lin) +\r\n((i - start_idx) * aic_sram[end_idx].quad_path_gain_lin) +\r\n((end_idx - start_idx) >> 1))/\r\n(end_idx - start_idx);\r\n}\r\n}\r\ni = ar9003_aic_find_valid(cal_sram, 1, 0);\r\nif (i < 0) {\r\ni = 0;\r\nret = false;\r\n}\r\nfixed_com_att_db = com_att_db_table[cal_sram[i].com_att_6db];\r\nfor (i = 0; i < ATH_AIC_MAX_BT_CHANNEL; i++) {\r\nint16_t rot_dir_path_att_db, rot_quad_path_att_db;\r\naic_sram[i].sram.vga_dir_sign =\r\n(aic_sram[i].dir_path_gain_lin >= 0) ? 1 : 0;\r\naic_sram[i].sram.vga_quad_sign=\r\n(aic_sram[i].quad_path_gain_lin >= 0) ? 1 : 0;\r\nrot_dir_path_att_db =\r\nar9003_aic_find_index(0, abs(aic_sram[i].dir_path_gain_lin)) -\r\nfixed_com_att_db;\r\nrot_quad_path_att_db =\r\nar9003_aic_find_index(0, abs(aic_sram[i].quad_path_gain_lin)) -\r\nfixed_com_att_db;\r\naic_sram[i].sram.com_att_6db =\r\nar9003_aic_find_index(1, fixed_com_att_db);\r\naic_sram[i].sram.valid = 1;\r\naic_sram[i].sram.rot_dir_att_db =\r\nmin(max(rot_dir_path_att_db,\r\n(int16_t)ATH_AIC_MIN_ROT_DIR_ATT_DB),\r\nATH_AIC_MAX_ROT_DIR_ATT_DB);\r\naic_sram[i].sram.rot_quad_att_db =\r\nmin(max(rot_quad_path_att_db,\r\n(int16_t)ATH_AIC_MIN_ROT_QUAD_ATT_DB),\r\nATH_AIC_MAX_ROT_QUAD_ATT_DB);\r\n}\r\nfor (i = 0; i < ATH_AIC_MAX_BT_CHANNEL; i++) {\r\naic->aic_sram[i] = (SM(aic_sram[i].sram.vga_dir_sign,\r\nAR_PHY_AIC_SRAM_VGA_DIR_SIGN) |\r\nSM(aic_sram[i].sram.vga_quad_sign,\r\nAR_PHY_AIC_SRAM_VGA_QUAD_SIGN) |\r\nSM(aic_sram[i].sram.com_att_6db,\r\nAR_PHY_AIC_SRAM_COM_ATT_6DB) |\r\nSM(aic_sram[i].sram.valid,\r\nAR_PHY_AIC_SRAM_VALID) |\r\nSM(aic_sram[i].sram.rot_dir_att_db,\r\nAR_PHY_AIC_SRAM_ROT_DIR_ATT_DB) |\r\nSM(aic_sram[i].sram.rot_quad_att_db,\r\nAR_PHY_AIC_SRAM_ROT_QUAD_ATT_DB));\r\n}\r\nreturn ret;\r\n}\r\nstatic void ar9003_aic_cal_done(struct ath_hw *ah)\r\n{\r\nstruct ath9k_hw_aic *aic = &ah->btcoex_hw.aic;\r\nREG_WRITE(ah, ATH_AIC_BT_JUPITER_CTRL,\r\n(REG_READ(ah, ATH_AIC_BT_JUPITER_CTRL) &\r\n~ATH_AIC_BT_AIC_ENABLE));\r\nif (ar9003_aic_cal_post_process(ah))\r\naic->aic_cal_state = AIC_CAL_STATE_DONE;\r\nelse\r\naic->aic_cal_state = AIC_CAL_STATE_ERROR;\r\n}\r\nstatic u8 ar9003_aic_cal_continue(struct ath_hw *ah, bool cal_once)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nstruct ath9k_hw_mci *mci_hw = &ah->btcoex_hw.mci;\r\nstruct ath9k_hw_aic *aic = &ah->btcoex_hw.aic;\r\nint i, num_chan;\r\nnum_chan = MS(mci_hw->config, ATH_MCI_CONFIG_AIC_CAL_NUM_CHAN);\r\nif (!num_chan) {\r\naic->aic_cal_state = AIC_CAL_STATE_ERROR;\r\nreturn aic->aic_cal_state;\r\n}\r\nif (cal_once) {\r\nfor (i = 0; i < 10000; i++) {\r\nif ((REG_READ(ah, AR_PHY_AIC_CTRL_0_B1) &\r\nAR_PHY_AIC_CAL_ENABLE) == 0)\r\nbreak;\r\nudelay(100);\r\n}\r\n}\r\nif ((REG_READ(ah, AR_PHY_AIC_CTRL_0_B1) &\r\nAR_PHY_AIC_CAL_ENABLE) != 0) {\r\nath_dbg(common, MCI, "AIC cal is not done after 40ms");\r\ngoto exit;\r\n}\r\nREG_WRITE(ah, AR_PHY_AIC_SRAM_ADDR_B1,\r\n(ATH_AIC_SRAM_CAL_OFFSET | ATH_AIC_SRAM_AUTO_INCREMENT));\r\nfor (i = 0; i < ATH_AIC_MAX_BT_CHANNEL; i++) {\r\nu32 value;\r\nvalue = REG_READ(ah, AR_PHY_AIC_SRAM_DATA_B1);\r\nif (value & 0x01) {\r\nif (aic->aic_sram[i] == 0)\r\naic->aic_caled_chan++;\r\naic->aic_sram[i] = value;\r\nif (!cal_once)\r\nbreak;\r\n}\r\n}\r\nif ((aic->aic_caled_chan >= num_chan) || cal_once) {\r\nar9003_aic_cal_done(ah);\r\n} else {\r\nREG_CLR_BIT(ah, AR_PHY_AIC_CTRL_0_B1, AR_PHY_AIC_CAL_ENABLE);\r\nREG_SET_BIT(ah, AR_PHY_AIC_CTRL_0_B1,\r\nAR_PHY_AIC_CAL_CH_VALID_RESET);\r\nREG_SET_BIT(ah, AR_PHY_AIC_CTRL_0_B1, AR_PHY_AIC_CAL_ENABLE);\r\n}\r\nexit:\r\nreturn aic->aic_cal_state;\r\n}\r\nu8 ar9003_aic_calibration(struct ath_hw *ah)\r\n{\r\nstruct ath9k_hw_aic *aic = &ah->btcoex_hw.aic;\r\nu8 cal_ret = AIC_CAL_STATE_ERROR;\r\nswitch (aic->aic_cal_state) {\r\ncase AIC_CAL_STATE_IDLE:\r\ncal_ret = ar9003_aic_cal_start(ah, 1);\r\nbreak;\r\ncase AIC_CAL_STATE_STARTED:\r\ncal_ret = ar9003_aic_cal_continue(ah, false);\r\nbreak;\r\ncase AIC_CAL_STATE_DONE:\r\ncal_ret = AIC_CAL_STATE_DONE;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn cal_ret;\r\n}\r\nu8 ar9003_aic_start_normal(struct ath_hw *ah)\r\n{\r\nstruct ath9k_hw_aic *aic = &ah->btcoex_hw.aic;\r\nint16_t i;\r\nif (aic->aic_cal_state != AIC_CAL_STATE_DONE)\r\nreturn 1;\r\nar9003_aic_gain_table(ah);\r\nREG_WRITE(ah, AR_PHY_AIC_SRAM_ADDR_B1, ATH_AIC_SRAM_AUTO_INCREMENT);\r\nfor (i = 0; i < ATH_AIC_MAX_BT_CHANNEL; i++) {\r\nREG_WRITE(ah, AR_PHY_AIC_SRAM_DATA_B1, aic->aic_sram[i]);\r\n}\r\nREG_WRITE(ah, 0xa6b0, 0x80);\r\nREG_WRITE(ah, 0xa6b4, 0x5b2df0);\r\nREG_WRITE(ah, 0xa6b8, 0x10762cc8);\r\nREG_WRITE(ah, 0xa6bc, 0x1219a4b);\r\nREG_WRITE(ah, 0xa6c0, 0x1e01);\r\nREG_WRITE(ah, 0xb6b4, 0xf0);\r\nREG_WRITE(ah, 0xb6c0, 0x1e01);\r\nREG_WRITE(ah, 0xb6b0, 0x81);\r\nREG_WRITE(ah, AR_PHY_65NM_CH1_RXTX4, 0x40000000);\r\naic->aic_enabled = true;\r\nreturn 0;\r\n}\r\nu8 ar9003_aic_cal_reset(struct ath_hw *ah)\r\n{\r\nstruct ath9k_hw_aic *aic = &ah->btcoex_hw.aic;\r\naic->aic_cal_state = AIC_CAL_STATE_IDLE;\r\nreturn aic->aic_cal_state;\r\n}\r\nu8 ar9003_aic_calibration_single(struct ath_hw *ah)\r\n{\r\nstruct ath9k_hw_mci *mci_hw = &ah->btcoex_hw.mci;\r\nu8 cal_ret;\r\nint num_chan;\r\nnum_chan = MS(mci_hw->config, ATH_MCI_CONFIG_AIC_CAL_NUM_CHAN);\r\n(void) ar9003_aic_cal_start(ah, num_chan);\r\ncal_ret = ar9003_aic_cal_continue(ah, true);\r\nreturn cal_ret;\r\n}\r\nvoid ar9003_hw_attach_aic_ops(struct ath_hw *ah)\r\n{\r\nstruct ath_hw_private_ops *priv_ops = ath9k_hw_private_ops(ah);\r\npriv_ops->is_aic_enabled = ar9003_hw_is_aic_enabled;\r\n}

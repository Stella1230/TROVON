static void ide_legacy_init_one(struct ide_hw **hws, struct ide_hw *hw,\r\nu8 port_no, const struct ide_port_info *d,\r\nunsigned long config)\r\n{\r\nunsigned long base, ctl;\r\nint irq;\r\nif (port_no == 0) {\r\nbase = 0x1f0;\r\nctl = 0x3f6;\r\nirq = 14;\r\n} else {\r\nbase = 0x170;\r\nctl = 0x376;\r\nirq = 15;\r\n}\r\nif (!request_region(base, 8, d->name)) {\r\nprintk(KERN_ERR "%s: I/O resource 0x%lX-0x%lX not free.\n",\r\nd->name, base, base + 7);\r\nreturn;\r\n}\r\nif (!request_region(ctl, 1, d->name)) {\r\nprintk(KERN_ERR "%s: I/O resource 0x%lX not free.\n",\r\nd->name, ctl);\r\nrelease_region(base, 8);\r\nreturn;\r\n}\r\nide_std_init_ports(hw, base, ctl);\r\nhw->irq = irq;\r\nhw->config = config;\r\nhws[port_no] = hw;\r\n}\r\nint ide_legacy_device_add(const struct ide_port_info *d, unsigned long config)\r\n{\r\nstruct ide_hw hw[2], *hws[] = { NULL, NULL };\r\nmemset(&hw, 0, sizeof(hw));\r\nif ((d->host_flags & IDE_HFLAG_QD_2ND_PORT) == 0)\r\nide_legacy_init_one(hws, &hw[0], 0, d, config);\r\nide_legacy_init_one(hws, &hw[1], 1, d, config);\r\nif (hws[0] == NULL && hws[1] == NULL &&\r\n(d->host_flags & IDE_HFLAG_SINGLE))\r\nreturn -ENOENT;\r\nreturn ide_host_add(d, hws, 2, NULL);\r\n}

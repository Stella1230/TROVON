bool esas2r_process_vda_ioctl(struct esas2r_adapter *a,\r\nstruct atto_ioctl_vda *vi,\r\nstruct esas2r_request *rq,\r\nstruct esas2r_sg_context *sgc)\r\n{\r\nu32 datalen = 0;\r\nstruct atto_vda_sge *firstsg = NULL;\r\nu8 vercnt = (u8)ARRAY_SIZE(esas2r_vdaioctl_versions);\r\nvi->status = ATTO_STS_SUCCESS;\r\nvi->vda_status = RS_PENDING;\r\nif (vi->function >= vercnt) {\r\nvi->status = ATTO_STS_INV_FUNC;\r\nreturn false;\r\n}\r\nif (vi->version > esas2r_vdaioctl_versions[vi->function]) {\r\nvi->status = ATTO_STS_INV_VERSION;\r\nreturn false;\r\n}\r\nif (test_bit(AF_DEGRADED_MODE, &a->flags)) {\r\nvi->status = ATTO_STS_DEGRADED;\r\nreturn false;\r\n}\r\nif (vi->function != VDA_FUNC_SCSI)\r\nclear_vda_request(rq);\r\nrq->vrq->scsi.function = vi->function;\r\nrq->interrupt_cb = esas2r_complete_vda_ioctl;\r\nrq->interrupt_cx = vi;\r\nswitch (vi->function) {\r\ncase VDA_FUNC_FLASH:\r\nif (vi->cmd.flash.sub_func != VDA_FLASH_FREAD\r\n&& vi->cmd.flash.sub_func != VDA_FLASH_FWRITE\r\n&& vi->cmd.flash.sub_func != VDA_FLASH_FINFO) {\r\nvi->status = ATTO_STS_INV_FUNC;\r\nreturn false;\r\n}\r\nif (vi->cmd.flash.sub_func != VDA_FLASH_FINFO)\r\ndatalen = vi->data_length;\r\nrq->vrq->flash.length = cpu_to_le32(datalen);\r\nrq->vrq->flash.sub_func = vi->cmd.flash.sub_func;\r\nmemcpy(rq->vrq->flash.data.file.file_name,\r\nvi->cmd.flash.data.file.file_name,\r\nsizeof(vi->cmd.flash.data.file.file_name));\r\nfirstsg = rq->vrq->flash.data.file.sge;\r\nbreak;\r\ncase VDA_FUNC_CLI:\r\ndatalen = vi->data_length;\r\nrq->vrq->cli.cmd_rsp_len =\r\ncpu_to_le32(vi->cmd.cli.cmd_rsp_len);\r\nrq->vrq->cli.length = cpu_to_le32(datalen);\r\nfirstsg = rq->vrq->cli.sge;\r\nbreak;\r\ncase VDA_FUNC_MGT:\r\n{\r\nu8 *cmdcurr_offset = sgc->cur_offset\r\n- offsetof(struct atto_ioctl_vda, data)\r\n+ offsetof(struct atto_ioctl_vda, cmd)\r\n+ offsetof(struct atto_ioctl_vda_mgt_cmd,\r\ndata);\r\nif (vi->data_length) {\r\nu32 payldlen = 0;\r\nif (vi->cmd.mgt.mgt_func == VDAMGT_DEV_HEALTH_REQ\r\n|| vi->cmd.mgt.mgt_func == VDAMGT_DEV_METRICS) {\r\nrq->vrq->mgt.payld_sglst_offset =\r\n(u8)offsetof(struct atto_vda_mgmt_req,\r\npayld_sge);\r\npayldlen = vi->data_length;\r\ndatalen = vi->cmd.mgt.data_length;\r\n} else if (vi->cmd.mgt.mgt_func == VDAMGT_DEV_INFO2\r\n|| vi->cmd.mgt.mgt_func ==\r\nVDAMGT_DEV_INFO2_BYADDR) {\r\ndatalen = vi->data_length;\r\ncmdcurr_offset = sgc->cur_offset;\r\n} else {\r\nvi->status = ATTO_STS_INV_PARAM;\r\nreturn false;\r\n}\r\nrq->vrq->mgt.length = cpu_to_le32(datalen);\r\nif (payldlen) {\r\nrq->vrq->mgt.payld_length =\r\ncpu_to_le32(payldlen);\r\nesas2r_sgc_init(sgc, a, rq,\r\nrq->vrq->mgt.payld_sge);\r\nsgc->length = payldlen;\r\nif (!esas2r_build_sg_list(a, rq, sgc)) {\r\nvi->status = ATTO_STS_OUT_OF_RSRC;\r\nreturn false;\r\n}\r\n}\r\n} else {\r\ndatalen = vi->cmd.mgt.data_length;\r\nrq->vrq->mgt.length = cpu_to_le32(datalen);\r\n}\r\nfirstsg = rq->vrq->mgt.sge;\r\nsgc->cur_offset = cmdcurr_offset;\r\nrq->vrq->mgt.mgt_func = vi->cmd.mgt.mgt_func;\r\nrq->vrq->mgt.scan_generation = vi->cmd.mgt.scan_generation;\r\nrq->vrq->mgt.dev_index =\r\ncpu_to_le32(vi->cmd.mgt.dev_index);\r\nesas2r_nuxi_mgt_data(rq->vrq->mgt.mgt_func, &vi->cmd.mgt.data);\r\nbreak;\r\n}\r\ncase VDA_FUNC_CFG:\r\nif (vi->data_length\r\n|| vi->cmd.cfg.data_length == 0) {\r\nvi->status = ATTO_STS_INV_PARAM;\r\nreturn false;\r\n}\r\nif (vi->cmd.cfg.cfg_func == VDA_CFG_INIT) {\r\nvi->status = ATTO_STS_INV_FUNC;\r\nreturn false;\r\n}\r\nrq->vrq->cfg.sub_func = vi->cmd.cfg.cfg_func;\r\nrq->vrq->cfg.length = cpu_to_le32(vi->cmd.cfg.data_length);\r\nif (vi->cmd.cfg.cfg_func == VDA_CFG_GET_INIT) {\r\nmemcpy(&rq->vrq->cfg.data,\r\n&vi->cmd.cfg.data,\r\nvi->cmd.cfg.data_length);\r\nesas2r_nuxi_cfg_data(rq->vrq->cfg.sub_func,\r\n&rq->vrq->cfg.data);\r\n} else {\r\nvi->status = ATTO_STS_INV_FUNC;\r\nreturn false;\r\n}\r\nbreak;\r\ncase VDA_FUNC_GSV:\r\nvi->cmd.gsv.rsp_len = vercnt;\r\nmemcpy(vi->cmd.gsv.version_info, esas2r_vdaioctl_versions,\r\nvercnt);\r\nvi->vda_status = RS_SUCCESS;\r\nbreak;\r\ndefault:\r\nvi->status = ATTO_STS_INV_FUNC;\r\nreturn false;\r\n}\r\nif (datalen) {\r\nesas2r_sgc_init(sgc, a, rq, firstsg);\r\nsgc->length = datalen;\r\nif (!esas2r_build_sg_list(a, rq, sgc)) {\r\nvi->status = ATTO_STS_OUT_OF_RSRC;\r\nreturn false;\r\n}\r\n}\r\nesas2r_start_request(a, rq);\r\nreturn true;\r\n}\r\nstatic void esas2r_complete_vda_ioctl(struct esas2r_adapter *a,\r\nstruct esas2r_request *rq)\r\n{\r\nstruct atto_ioctl_vda *vi = (struct atto_ioctl_vda *)rq->interrupt_cx;\r\nvi->vda_status = rq->req_stat;\r\nswitch (vi->function) {\r\ncase VDA_FUNC_FLASH:\r\nif (vi->cmd.flash.sub_func == VDA_FLASH_FINFO\r\n|| vi->cmd.flash.sub_func == VDA_FLASH_FREAD)\r\nvi->cmd.flash.data.file.file_size =\r\nle32_to_cpu(rq->func_rsp.flash_rsp.file_size);\r\nbreak;\r\ncase VDA_FUNC_MGT:\r\nvi->cmd.mgt.scan_generation =\r\nrq->func_rsp.mgt_rsp.scan_generation;\r\nvi->cmd.mgt.dev_index = le16_to_cpu(\r\nrq->func_rsp.mgt_rsp.dev_index);\r\nif (vi->data_length == 0)\r\nvi->cmd.mgt.data_length =\r\nle32_to_cpu(rq->func_rsp.mgt_rsp.length);\r\nesas2r_nuxi_mgt_data(rq->vrq->mgt.mgt_func, &vi->cmd.mgt.data);\r\nbreak;\r\ncase VDA_FUNC_CFG:\r\nif (vi->cmd.cfg.cfg_func == VDA_CFG_GET_INIT) {\r\nstruct atto_ioctl_vda_cfg_cmd *cfg = &vi->cmd.cfg;\r\nstruct atto_vda_cfg_rsp *rsp = &rq->func_rsp.cfg_rsp;\r\nchar buf[sizeof(cfg->data.init.fw_release) + 1];\r\ncfg->data_length =\r\ncpu_to_le32(sizeof(struct atto_vda_cfg_init));\r\ncfg->data.init.vda_version =\r\nle32_to_cpu(rsp->vda_version);\r\ncfg->data.init.fw_build = rsp->fw_build;\r\nsnprintf(buf, sizeof(buf), "%1.1u.%2.2u",\r\n(int)LOBYTE(le16_to_cpu(rsp->fw_release)),\r\n(int)HIBYTE(le16_to_cpu(rsp->fw_release)));\r\nmemcpy(&cfg->data.init.fw_release, buf,\r\nsizeof(cfg->data.init.fw_release));\r\nif (LOWORD(LOBYTE(cfg->data.init.fw_build)) == 'A')\r\ncfg->data.init.fw_version =\r\ncfg->data.init.fw_build;\r\nelse\r\ncfg->data.init.fw_version =\r\ncfg->data.init.fw_release;\r\n} else {\r\nesas2r_nuxi_cfg_data(rq->vrq->cfg.sub_func,\r\n&vi->cmd.cfg.data);\r\n}\r\nbreak;\r\ncase VDA_FUNC_CLI:\r\nvi->cmd.cli.cmd_rsp_len =\r\nle32_to_cpu(rq->func_rsp.cli_rsp.cmd_rsp_len);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nvoid esas2r_build_flash_req(struct esas2r_adapter *a,\r\nstruct esas2r_request *rq,\r\nu8 sub_func,\r\nu8 cksum,\r\nu32 addr,\r\nu32 length)\r\n{\r\nstruct atto_vda_flash_req *vrq = &rq->vrq->flash;\r\nclear_vda_request(rq);\r\nrq->vrq->scsi.function = VDA_FUNC_FLASH;\r\nif (sub_func == VDA_FLASH_BEGINW\r\n|| sub_func == VDA_FLASH_WRITE\r\n|| sub_func == VDA_FLASH_READ)\r\nvrq->sg_list_offset = (u8)offsetof(struct atto_vda_flash_req,\r\ndata.sge);\r\nvrq->length = cpu_to_le32(length);\r\nvrq->flash_addr = cpu_to_le32(addr);\r\nvrq->checksum = cksum;\r\nvrq->sub_func = sub_func;\r\n}\r\nvoid esas2r_build_mgt_req(struct esas2r_adapter *a,\r\nstruct esas2r_request *rq,\r\nu8 sub_func,\r\nu8 scan_gen,\r\nu16 dev_index,\r\nu32 length,\r\nvoid *data)\r\n{\r\nstruct atto_vda_mgmt_req *vrq = &rq->vrq->mgt;\r\nclear_vda_request(rq);\r\nrq->vrq->scsi.function = VDA_FUNC_MGT;\r\nvrq->mgt_func = sub_func;\r\nvrq->scan_generation = scan_gen;\r\nvrq->dev_index = cpu_to_le16(dev_index);\r\nvrq->length = cpu_to_le32(length);\r\nif (vrq->length) {\r\nif (test_bit(AF_LEGACY_SGE_MODE, &a->flags)) {\r\nvrq->sg_list_offset = (u8)offsetof(\r\nstruct atto_vda_mgmt_req, sge);\r\nvrq->sge[0].length = cpu_to_le32(SGE_LAST | length);\r\nvrq->sge[0].address = cpu_to_le64(\r\nrq->vrq_md->phys_addr +\r\nsizeof(union atto_vda_req));\r\n} else {\r\nvrq->sg_list_offset = (u8)offsetof(\r\nstruct atto_vda_mgmt_req, prde);\r\nvrq->prde[0].ctl_len = cpu_to_le32(length);\r\nvrq->prde[0].address = cpu_to_le64(\r\nrq->vrq_md->phys_addr +\r\nsizeof(union atto_vda_req));\r\n}\r\n}\r\nif (data) {\r\nesas2r_nuxi_mgt_data(sub_func, data);\r\nmemcpy(&rq->vda_rsp_data->mgt_data.data.bytes[0], data,\r\nlength);\r\n}\r\n}\r\nvoid esas2r_build_ae_req(struct esas2r_adapter *a, struct esas2r_request *rq)\r\n{\r\nstruct atto_vda_ae_req *vrq = &rq->vrq->ae;\r\nclear_vda_request(rq);\r\nrq->vrq->scsi.function = VDA_FUNC_AE;\r\nvrq->length = cpu_to_le32(sizeof(struct atto_vda_ae_data));\r\nif (test_bit(AF_LEGACY_SGE_MODE, &a->flags)) {\r\nvrq->sg_list_offset =\r\n(u8)offsetof(struct atto_vda_ae_req, sge);\r\nvrq->sge[0].length = cpu_to_le32(SGE_LAST | vrq->length);\r\nvrq->sge[0].address = cpu_to_le64(\r\nrq->vrq_md->phys_addr +\r\nsizeof(union atto_vda_req));\r\n} else {\r\nvrq->sg_list_offset = (u8)offsetof(struct atto_vda_ae_req,\r\nprde);\r\nvrq->prde[0].ctl_len = cpu_to_le32(vrq->length);\r\nvrq->prde[0].address = cpu_to_le64(\r\nrq->vrq_md->phys_addr +\r\nsizeof(union atto_vda_req));\r\n}\r\n}\r\nvoid esas2r_build_cli_req(struct esas2r_adapter *a,\r\nstruct esas2r_request *rq,\r\nu32 length,\r\nu32 cmd_rsp_len)\r\n{\r\nstruct atto_vda_cli_req *vrq = &rq->vrq->cli;\r\nclear_vda_request(rq);\r\nrq->vrq->scsi.function = VDA_FUNC_CLI;\r\nvrq->length = cpu_to_le32(length);\r\nvrq->cmd_rsp_len = cpu_to_le32(cmd_rsp_len);\r\nvrq->sg_list_offset = (u8)offsetof(struct atto_vda_cli_req, sge);\r\n}\r\nvoid esas2r_build_ioctl_req(struct esas2r_adapter *a,\r\nstruct esas2r_request *rq,\r\nu32 length,\r\nu8 sub_func)\r\n{\r\nstruct atto_vda_ioctl_req *vrq = &rq->vrq->ioctl;\r\nclear_vda_request(rq);\r\nrq->vrq->scsi.function = VDA_FUNC_IOCTL;\r\nvrq->length = cpu_to_le32(length);\r\nvrq->sub_func = sub_func;\r\nvrq->sg_list_offset = (u8)offsetof(struct atto_vda_ioctl_req, sge);\r\n}\r\nvoid esas2r_build_cfg_req(struct esas2r_adapter *a,\r\nstruct esas2r_request *rq,\r\nu8 sub_func,\r\nu32 length,\r\nvoid *data)\r\n{\r\nstruct atto_vda_cfg_req *vrq = &rq->vrq->cfg;\r\nclear_vda_request(rq);\r\nrq->vrq->scsi.function = VDA_FUNC_CFG;\r\nvrq->sub_func = sub_func;\r\nvrq->length = cpu_to_le32(length);\r\nif (data) {\r\nesas2r_nuxi_cfg_data(sub_func, data);\r\nmemcpy(&vrq->data, data, length);\r\n}\r\n}\r\nstatic void clear_vda_request(struct esas2r_request *rq)\r\n{\r\nu32 handle = rq->vrq->scsi.handle;\r\nmemset(rq->vrq, 0, sizeof(*rq->vrq));\r\nrq->vrq->scsi.handle = handle;\r\nrq->req_stat = RS_PENDING;\r\nmemset(rq->data_buf, 0, ESAS2R_DATA_BUF_LEN);\r\nINIT_LIST_HEAD(&rq->req_list);\r\n}

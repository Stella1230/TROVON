static bool\r\nstatistic_mt(const struct sk_buff *skb, struct xt_action_param *par)\r\n{\r\nconst struct xt_statistic_info *info = par->matchinfo;\r\nbool ret = info->flags & XT_STATISTIC_INVERT;\r\nint nval, oval;\r\nswitch (info->mode) {\r\ncase XT_STATISTIC_MODE_RANDOM:\r\nif ((prandom_u32() & 0x7FFFFFFF) < info->u.random.probability)\r\nret = !ret;\r\nbreak;\r\ncase XT_STATISTIC_MODE_NTH:\r\ndo {\r\noval = atomic_read(&info->master->count);\r\nnval = (oval == info->u.nth.every) ? 0 : oval + 1;\r\n} while (atomic_cmpxchg(&info->master->count, oval, nval) != oval);\r\nif (nval == 0)\r\nret = !ret;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int statistic_mt_check(const struct xt_mtchk_param *par)\r\n{\r\nstruct xt_statistic_info *info = par->matchinfo;\r\nif (info->mode > XT_STATISTIC_MODE_MAX ||\r\ninfo->flags & ~XT_STATISTIC_MASK)\r\nreturn -EINVAL;\r\ninfo->master = kzalloc(sizeof(*info->master), GFP_KERNEL);\r\nif (info->master == NULL)\r\nreturn -ENOMEM;\r\natomic_set(&info->master->count, info->u.nth.count);\r\nreturn 0;\r\n}\r\nstatic void statistic_mt_destroy(const struct xt_mtdtor_param *par)\r\n{\r\nconst struct xt_statistic_info *info = par->matchinfo;\r\nkfree(info->master);\r\n}\r\nstatic int __init statistic_mt_init(void)\r\n{\r\nreturn xt_register_match(&xt_statistic_mt_reg);\r\n}\r\nstatic void __exit statistic_mt_exit(void)\r\n{\r\nxt_unregister_match(&xt_statistic_mt_reg);\r\n}

static int adf_put_admin_msg_sync(struct adf_accel_dev *accel_dev, u32 ae,\r\nvoid *in, void *out)\r\n{\r\nstruct adf_admin_comms *admin = accel_dev->admin;\r\nint offset = ae * ADF_ADMINMSG_LEN * 2;\r\nvoid __iomem *mailbox = admin->mailbox_addr;\r\nint mb_offset = ae * ADF_DH895XCC_MAILBOX_STRIDE;\r\nint times, received;\r\nmutex_lock(&admin->lock);\r\nif (ADF_CSR_RD(mailbox, mb_offset) == 1) {\r\nmutex_unlock(&admin->lock);\r\nreturn -EAGAIN;\r\n}\r\nmemcpy(admin->virt_addr + offset, in, ADF_ADMINMSG_LEN);\r\nADF_CSR_WR(mailbox, mb_offset, 1);\r\nreceived = 0;\r\nfor (times = 0; times < 50; times++) {\r\nmsleep(20);\r\nif (ADF_CSR_RD(mailbox, mb_offset) == 0) {\r\nreceived = 1;\r\nbreak;\r\n}\r\n}\r\nif (received)\r\nmemcpy(out, admin->virt_addr + offset +\r\nADF_ADMINMSG_LEN, ADF_ADMINMSG_LEN);\r\nelse\r\ndev_err(&GET_DEV(accel_dev),\r\n"Failed to send admin msg to accelerator\n");\r\nmutex_unlock(&admin->lock);\r\nreturn received ? 0 : -EFAULT;\r\n}\r\nstatic int adf_send_admin_cmd(struct adf_accel_dev *accel_dev, int cmd)\r\n{\r\nstruct adf_hw_device_data *hw_device = accel_dev->hw_device;\r\nstruct icp_qat_fw_init_admin_req req;\r\nstruct icp_qat_fw_init_admin_resp resp;\r\nint i;\r\nmemset(&req, 0, sizeof(struct icp_qat_fw_init_admin_req));\r\nreq.init_admin_cmd_id = cmd;\r\nif (cmd == ICP_QAT_FW_CONSTANTS_CFG) {\r\nreq.init_cfg_sz = 1024;\r\nreq.init_cfg_ptr = accel_dev->admin->const_tbl_addr;\r\n}\r\nfor (i = 0; i < hw_device->get_num_aes(hw_device); i++) {\r\nmemset(&resp, 0, sizeof(struct icp_qat_fw_init_admin_resp));\r\nif (adf_put_admin_msg_sync(accel_dev, i, &req, &resp) ||\r\nresp.init_resp_hdr.status)\r\nreturn -EFAULT;\r\n}\r\nreturn 0;\r\n}\r\nint adf_send_admin_init(struct adf_accel_dev *accel_dev)\r\n{\r\nint ret = adf_send_admin_cmd(accel_dev, ICP_QAT_FW_INIT_ME);\r\nif (ret)\r\nreturn ret;\r\nreturn adf_send_admin_cmd(accel_dev, ICP_QAT_FW_CONSTANTS_CFG);\r\n}\r\nint adf_init_admin_comms(struct adf_accel_dev *accel_dev)\r\n{\r\nstruct adf_admin_comms *admin;\r\nstruct adf_hw_device_data *hw_data = accel_dev->hw_device;\r\nstruct adf_bar *pmisc =\r\n&GET_BARS(accel_dev)[hw_data->get_misc_bar_id(hw_data)];\r\nvoid __iomem *csr = pmisc->virt_addr;\r\nvoid __iomem *mailbox = csr + ADF_DH895XCC_MAILBOX_BASE_OFFSET;\r\nu64 reg_val;\r\nadmin = kzalloc_node(sizeof(*accel_dev->admin), GFP_KERNEL,\r\ndev_to_node(&GET_DEV(accel_dev)));\r\nif (!admin)\r\nreturn -ENOMEM;\r\nadmin->virt_addr = dma_zalloc_coherent(&GET_DEV(accel_dev), PAGE_SIZE,\r\n&admin->phy_addr, GFP_KERNEL);\r\nif (!admin->virt_addr) {\r\ndev_err(&GET_DEV(accel_dev), "Failed to allocate dma buff\n");\r\nkfree(admin);\r\nreturn -ENOMEM;\r\n}\r\nadmin->const_tbl_addr = dma_map_single(&GET_DEV(accel_dev),\r\n(void *) const_tab, 1024,\r\nDMA_TO_DEVICE);\r\nif (unlikely(dma_mapping_error(&GET_DEV(accel_dev),\r\nadmin->const_tbl_addr))) {\r\ndma_free_coherent(&GET_DEV(accel_dev), PAGE_SIZE,\r\nadmin->virt_addr, admin->phy_addr);\r\nkfree(admin);\r\nreturn -ENOMEM;\r\n}\r\nreg_val = (u64)admin->phy_addr;\r\nADF_CSR_WR(csr, ADF_DH895XCC_ADMINMSGUR_OFFSET, reg_val >> 32);\r\nADF_CSR_WR(csr, ADF_DH895XCC_ADMINMSGLR_OFFSET, reg_val);\r\nmutex_init(&admin->lock);\r\nadmin->mailbox_addr = mailbox;\r\naccel_dev->admin = admin;\r\nreturn 0;\r\n}\r\nvoid adf_exit_admin_comms(struct adf_accel_dev *accel_dev)\r\n{\r\nstruct adf_admin_comms *admin = accel_dev->admin;\r\nif (!admin)\r\nreturn;\r\nif (admin->virt_addr)\r\ndma_free_coherent(&GET_DEV(accel_dev), PAGE_SIZE,\r\nadmin->virt_addr, admin->phy_addr);\r\ndma_unmap_single(&GET_DEV(accel_dev), admin->const_tbl_addr, 1024,\r\nDMA_TO_DEVICE);\r\nmutex_destroy(&admin->lock);\r\nkfree(admin);\r\naccel_dev->admin = NULL;\r\n}

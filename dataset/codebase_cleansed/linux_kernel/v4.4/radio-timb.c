static int timbradio_vidioc_querycap(struct file *file, void *priv,\r\nstruct v4l2_capability *v)\r\n{\r\nstrlcpy(v->driver, DRIVER_NAME, sizeof(v->driver));\r\nstrlcpy(v->card, "Timberdale Radio", sizeof(v->card));\r\nsnprintf(v->bus_info, sizeof(v->bus_info), "platform:"DRIVER_NAME);\r\nv->device_caps = V4L2_CAP_TUNER | V4L2_CAP_RADIO;\r\nv->capabilities = v->device_caps | V4L2_CAP_DEVICE_CAPS;\r\nreturn 0;\r\n}\r\nstatic int timbradio_vidioc_g_tuner(struct file *file, void *priv,\r\nstruct v4l2_tuner *v)\r\n{\r\nstruct timbradio *tr = video_drvdata(file);\r\nreturn v4l2_subdev_call(tr->sd_tuner, tuner, g_tuner, v);\r\n}\r\nstatic int timbradio_vidioc_s_tuner(struct file *file, void *priv,\r\nconst struct v4l2_tuner *v)\r\n{\r\nstruct timbradio *tr = video_drvdata(file);\r\nreturn v4l2_subdev_call(tr->sd_tuner, tuner, s_tuner, v);\r\n}\r\nstatic int timbradio_vidioc_s_frequency(struct file *file, void *priv,\r\nconst struct v4l2_frequency *f)\r\n{\r\nstruct timbradio *tr = video_drvdata(file);\r\nreturn v4l2_subdev_call(tr->sd_tuner, tuner, s_frequency, f);\r\n}\r\nstatic int timbradio_vidioc_g_frequency(struct file *file, void *priv,\r\nstruct v4l2_frequency *f)\r\n{\r\nstruct timbradio *tr = video_drvdata(file);\r\nreturn v4l2_subdev_call(tr->sd_tuner, tuner, g_frequency, f);\r\n}\r\nstatic int timbradio_probe(struct platform_device *pdev)\r\n{\r\nstruct timb_radio_platform_data *pdata = pdev->dev.platform_data;\r\nstruct timbradio *tr;\r\nint err;\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "Platform data missing\n");\r\nerr = -EINVAL;\r\ngoto err;\r\n}\r\ntr = devm_kzalloc(&pdev->dev, sizeof(*tr), GFP_KERNEL);\r\nif (!tr) {\r\nerr = -ENOMEM;\r\ngoto err;\r\n}\r\ntr->pdata = *pdata;\r\nmutex_init(&tr->lock);\r\nstrlcpy(tr->video_dev.name, "Timberdale Radio",\r\nsizeof(tr->video_dev.name));\r\ntr->video_dev.fops = &timbradio_fops;\r\ntr->video_dev.ioctl_ops = &timbradio_ioctl_ops;\r\ntr->video_dev.release = video_device_release_empty;\r\ntr->video_dev.minor = -1;\r\ntr->video_dev.lock = &tr->lock;\r\nstrlcpy(tr->v4l2_dev.name, DRIVER_NAME, sizeof(tr->v4l2_dev.name));\r\nerr = v4l2_device_register(NULL, &tr->v4l2_dev);\r\nif (err)\r\ngoto err;\r\ntr->video_dev.v4l2_dev = &tr->v4l2_dev;\r\ntr->sd_tuner = v4l2_i2c_new_subdev_board(&tr->v4l2_dev,\r\ni2c_get_adapter(pdata->i2c_adapter), pdata->tuner, NULL);\r\ntr->sd_dsp = v4l2_i2c_new_subdev_board(&tr->v4l2_dev,\r\ni2c_get_adapter(pdata->i2c_adapter), pdata->dsp, NULL);\r\nif (tr->sd_tuner == NULL || tr->sd_dsp == NULL) {\r\nerr = -ENODEV;\r\ngoto err_video_req;\r\n}\r\ntr->v4l2_dev.ctrl_handler = tr->sd_dsp->ctrl_handler;\r\nerr = video_register_device(&tr->video_dev, VFL_TYPE_RADIO, -1);\r\nif (err) {\r\ndev_err(&pdev->dev, "Error reg video\n");\r\ngoto err_video_req;\r\n}\r\nvideo_set_drvdata(&tr->video_dev, tr);\r\nplatform_set_drvdata(pdev, tr);\r\nreturn 0;\r\nerr_video_req:\r\nv4l2_device_unregister(&tr->v4l2_dev);\r\nerr:\r\ndev_err(&pdev->dev, "Failed to register: %d\n", err);\r\nreturn err;\r\n}\r\nstatic int timbradio_remove(struct platform_device *pdev)\r\n{\r\nstruct timbradio *tr = platform_get_drvdata(pdev);\r\nvideo_unregister_device(&tr->video_dev);\r\nv4l2_device_unregister(&tr->v4l2_dev);\r\nreturn 0;\r\n}

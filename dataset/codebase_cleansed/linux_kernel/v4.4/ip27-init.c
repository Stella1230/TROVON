static void per_hub_init(cnodeid_t cnode)\r\n{\r\nstruct hub_data *hub = hub_data(cnode);\r\nnasid_t nasid = COMPACT_TO_NASID_NODEID(cnode);\r\nint i;\r\ncpumask_set_cpu(smp_processor_id(), &hub->h_cpus);\r\nif (test_and_set_bit(cnode, hub_init_mask))\r\nreturn;\r\nREMOTE_HUB_S(nasid, IIO_ICTP, 0x800);\r\nREMOTE_HUB_S(nasid, IIO_ICTO, 0xff);\r\nhub_rtc_init(cnode);\r\nxtalk_probe_node(cnode);\r\n#ifdef CONFIG_REPLICATE_EXHANDLERS\r\nif (get_compact_nodeid() == cnode) {\r\nextern char except_vec2_generic, except_vec3_generic;\r\nextern void build_tlb_refill_handler(void);\r\nmemcpy((void *)(CKSEG0 + 0x100), &except_vec2_generic, 0x80);\r\nmemcpy((void *)(CKSEG0 + 0x180), &except_vec3_generic, 0x80);\r\nbuild_tlb_refill_handler();\r\nmemcpy((void *)(CKSEG0 + 0x100), (void *) CKSEG0, 0x80);\r\nmemcpy((void *)(CKSEG0 + 0x180), &except_vec3_generic, 0x100);\r\n__flush_cache_all();\r\n}\r\n#endif\r\nfor (i = 0; i <= BASE_PCI_IRQ; i++) {\r\n__set_bit(i, hub->irq_alloc_mask);\r\nLOCAL_HUB_CLR_INTR(INT_PEND0_BASELVL + i);\r\n}\r\n__set_bit(IP_PEND0_6_63, hub->irq_alloc_mask);\r\nLOCAL_HUB_S(PI_INT_PEND_MOD, IP_PEND0_6_63);\r\nfor (i = NI_BRDCAST_ERR_A; i <= MSC_PANIC_INTR; i++) {\r\n__set_bit(i, hub->irq_alloc_mask);\r\nLOCAL_HUB_CLR_INTR(INT_PEND1_BASELVL + i);\r\n}\r\n}\r\nvoid per_cpu_init(void)\r\n{\r\nint cpu = smp_processor_id();\r\nint slice = LOCAL_HUB_L(PI_CPU_NUM);\r\ncnodeid_t cnode = get_compact_nodeid();\r\nstruct hub_data *hub = hub_data(cnode);\r\nstruct slice_data *si = hub->slice + slice;\r\nint i;\r\nif (test_and_set_bit(slice, &hub->slice_map))\r\nreturn;\r\nclear_c0_status(ST0_IM);\r\nper_hub_init(cnode);\r\nfor (i = 0; i < LEVELS_PER_SLICE; i++)\r\nsi->level_to_irq[i] = -1;\r\ncpu_data[cpu].data = si;\r\ncpu_time_init();\r\ninstall_ipi();\r\ninstall_cpu_nmi_handler(cputoslice(cpu));\r\nset_c0_status(SRB_DEV0 | SRB_DEV1);\r\n}\r\nnasid_t\r\nget_nasid(void)\r\n{\r\nreturn (nasid_t)((LOCAL_HUB_L(NI_STATUS_REV_ID) & NSRI_NODEID_MASK)\r\n>> NSRI_NODEID_SHFT);\r\n}\r\ncnodeid_t get_compact_nodeid(void)\r\n{\r\nreturn NASID_TO_COMPACT_NODEID(get_nasid());\r\n}\r\nstatic inline void ioc3_eth_init(void)\r\n{\r\nstruct ioc3 *ioc3;\r\nnasid_t nid;\r\nnid = get_nasid();\r\nioc3 = (struct ioc3 *) KL_CONFIG_CH_CONS_INFO(nid)->memory_base;\r\nioc3->eier = 0;\r\n}\r\nvoid __init plat_mem_setup(void)\r\n{\r\nhubreg_t p, e, n_mode;\r\nnasid_t nid;\r\nip27_reboot_setup();\r\nnid = get_nasid();\r\nprintk("IP27: Running on node %d.\n", nid);\r\np = LOCAL_HUB_L(PI_CPU_PRESENT_A) & 1;\r\ne = LOCAL_HUB_L(PI_CPU_ENABLE_A) & 1;\r\nprintk("Node %d has %s primary CPU%s.\n", nid,\r\np ? "a" : "no",\r\ne ? ", CPU is running" : "");\r\np = LOCAL_HUB_L(PI_CPU_PRESENT_B) & 1;\r\ne = LOCAL_HUB_L(PI_CPU_ENABLE_B) & 1;\r\nprintk("Node %d has %s secondary CPU%s.\n", nid,\r\np ? "a" : "no",\r\ne ? ", CPU is running" : "");\r\nn_mode = LOCAL_HUB_L(NI_STATUS_REV_ID) & NSRI_MORENODES_MASK;\r\nprintk("Machine is in %c mode.\n", n_mode ? 'N' : 'M');\r\n#ifdef CONFIG_SGI_SN_N_MODE\r\nif (!n_mode)\r\npanic("Kernel compiled for M mode.");\r\n#else\r\nif (n_mode)\r\npanic("Kernel compiled for N mode.");\r\n#endif\r\nioc3_eth_init();\r\nper_cpu_init();\r\nset_io_port_base(IO_BASE);\r\n}

static ssize_t\r\nname_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "%s\n", to_rtc_device(dev)->name);\r\n}\r\nstatic ssize_t\r\ndate_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nssize_t retval;\r\nstruct rtc_time tm;\r\nretval = rtc_read_time(to_rtc_device(dev), &tm);\r\nif (retval == 0) {\r\nretval = sprintf(buf, "%04d-%02d-%02d\n",\r\ntm.tm_year + 1900, tm.tm_mon + 1, tm.tm_mday);\r\n}\r\nreturn retval;\r\n}\r\nstatic ssize_t\r\ntime_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nssize_t retval;\r\nstruct rtc_time tm;\r\nretval = rtc_read_time(to_rtc_device(dev), &tm);\r\nif (retval == 0) {\r\nretval = sprintf(buf, "%02d:%02d:%02d\n",\r\ntm.tm_hour, tm.tm_min, tm.tm_sec);\r\n}\r\nreturn retval;\r\n}\r\nstatic ssize_t\r\nsince_epoch_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nssize_t retval;\r\nstruct rtc_time tm;\r\nretval = rtc_read_time(to_rtc_device(dev), &tm);\r\nif (retval == 0) {\r\nunsigned long time;\r\nrtc_tm_to_time(&tm, &time);\r\nretval = sprintf(buf, "%lu\n", time);\r\n}\r\nreturn retval;\r\n}\r\nstatic ssize_t\r\nmax_user_freq_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "%d\n", to_rtc_device(dev)->max_user_freq);\r\n}\r\nstatic ssize_t\r\nmax_user_freq_store(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t n)\r\n{\r\nstruct rtc_device *rtc = to_rtc_device(dev);\r\nunsigned long val = simple_strtoul(buf, NULL, 0);\r\nif (val >= 4096 || val == 0)\r\nreturn -EINVAL;\r\nrtc->max_user_freq = (int)val;\r\nreturn n;\r\n}\r\nstatic ssize_t\r\nhctosys_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\n#ifdef CONFIG_RTC_HCTOSYS_DEVICE\r\nif (rtc_hctosys_ret == 0 &&\r\nstrcmp(dev_name(&to_rtc_device(dev)->dev),\r\nCONFIG_RTC_HCTOSYS_DEVICE) == 0)\r\nreturn sprintf(buf, "1\n");\r\nelse\r\n#endif\r\nreturn sprintf(buf, "0\n");\r\n}\r\nstatic ssize_t\r\nwakealarm_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nssize_t retval;\r\nunsigned long alarm;\r\nstruct rtc_wkalrm alm;\r\nretval = rtc_read_alarm(to_rtc_device(dev), &alm);\r\nif (retval == 0 && alm.enabled) {\r\nrtc_tm_to_time(&alm.time, &alarm);\r\nretval = sprintf(buf, "%lu\n", alarm);\r\n}\r\nreturn retval;\r\n}\r\nstatic ssize_t\r\nwakealarm_store(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t n)\r\n{\r\nssize_t retval;\r\nunsigned long now, alarm;\r\nunsigned long push = 0;\r\nstruct rtc_wkalrm alm;\r\nstruct rtc_device *rtc = to_rtc_device(dev);\r\nchar *buf_ptr;\r\nint adjust = 0;\r\nretval = rtc_read_time(rtc, &alm.time);\r\nif (retval < 0)\r\nreturn retval;\r\nrtc_tm_to_time(&alm.time, &now);\r\nbuf_ptr = (char *)buf;\r\nif (*buf_ptr == '+') {\r\nbuf_ptr++;\r\nif (*buf_ptr == '=') {\r\nbuf_ptr++;\r\npush = 1;\r\n} else\r\nadjust = 1;\r\n}\r\nalarm = simple_strtoul(buf_ptr, NULL, 0);\r\nif (adjust) {\r\nalarm += now;\r\n}\r\nif (alarm > now || push) {\r\nretval = rtc_read_alarm(rtc, &alm);\r\nif (retval < 0)\r\nreturn retval;\r\nif (alm.enabled) {\r\nif (push) {\r\nrtc_tm_to_time(&alm.time, &push);\r\nalarm += push;\r\n} else\r\nreturn -EBUSY;\r\n} else if (push)\r\nreturn -EINVAL;\r\nalm.enabled = 1;\r\n} else {\r\nalm.enabled = 0;\r\nalarm = now + 300;\r\n}\r\nrtc_time_to_tm(alarm, &alm.time);\r\nretval = rtc_set_alarm(rtc, &alm);\r\nreturn (retval < 0) ? retval : n;\r\n}\r\nstatic bool rtc_does_wakealarm(struct rtc_device *rtc)\r\n{\r\nif (!device_can_wakeup(rtc->dev.parent))\r\nreturn false;\r\nreturn rtc->ops->set_alarm != NULL;\r\n}\r\nstatic umode_t rtc_attr_is_visible(struct kobject *kobj,\r\nstruct attribute *attr, int n)\r\n{\r\nstruct device *dev = container_of(kobj, struct device, kobj);\r\nstruct rtc_device *rtc = to_rtc_device(dev);\r\numode_t mode = attr->mode;\r\nif (attr == &dev_attr_wakealarm.attr)\r\nif (!rtc_does_wakealarm(rtc))\r\nmode = 0;\r\nreturn mode;\r\n}\r\nconst struct attribute_group **rtc_get_dev_attribute_groups(void)\r\n{\r\nreturn rtc_attr_groups;\r\n}

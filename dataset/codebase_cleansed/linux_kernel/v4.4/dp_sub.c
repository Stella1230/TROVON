union ieee754dp ieee754dp_sub(union ieee754dp x, union ieee754dp y)\r\n{\r\nint s;\r\nCOMPXDP;\r\nCOMPYDP;\r\nEXPLODEXDP;\r\nEXPLODEYDP;\r\nieee754_clearcx();\r\nFLUSHXDP;\r\nFLUSHYDP;\r\nswitch (CLPAIR(xc, yc)) {\r\ncase CLPAIR(IEEE754_CLASS_QNAN, IEEE754_CLASS_SNAN):\r\ncase CLPAIR(IEEE754_CLASS_ZERO, IEEE754_CLASS_SNAN):\r\ncase CLPAIR(IEEE754_CLASS_NORM, IEEE754_CLASS_SNAN):\r\ncase CLPAIR(IEEE754_CLASS_DNORM, IEEE754_CLASS_SNAN):\r\ncase CLPAIR(IEEE754_CLASS_INF, IEEE754_CLASS_SNAN):\r\nreturn ieee754dp_nanxcpt(y);\r\ncase CLPAIR(IEEE754_CLASS_SNAN, IEEE754_CLASS_SNAN):\r\ncase CLPAIR(IEEE754_CLASS_SNAN, IEEE754_CLASS_QNAN):\r\ncase CLPAIR(IEEE754_CLASS_SNAN, IEEE754_CLASS_ZERO):\r\ncase CLPAIR(IEEE754_CLASS_SNAN, IEEE754_CLASS_NORM):\r\ncase CLPAIR(IEEE754_CLASS_SNAN, IEEE754_CLASS_DNORM):\r\ncase CLPAIR(IEEE754_CLASS_SNAN, IEEE754_CLASS_INF):\r\nreturn ieee754dp_nanxcpt(x);\r\ncase CLPAIR(IEEE754_CLASS_ZERO, IEEE754_CLASS_QNAN):\r\ncase CLPAIR(IEEE754_CLASS_NORM, IEEE754_CLASS_QNAN):\r\ncase CLPAIR(IEEE754_CLASS_DNORM, IEEE754_CLASS_QNAN):\r\ncase CLPAIR(IEEE754_CLASS_INF, IEEE754_CLASS_QNAN):\r\nreturn y;\r\ncase CLPAIR(IEEE754_CLASS_QNAN, IEEE754_CLASS_QNAN):\r\ncase CLPAIR(IEEE754_CLASS_QNAN, IEEE754_CLASS_ZERO):\r\ncase CLPAIR(IEEE754_CLASS_QNAN, IEEE754_CLASS_NORM):\r\ncase CLPAIR(IEEE754_CLASS_QNAN, IEEE754_CLASS_DNORM):\r\ncase CLPAIR(IEEE754_CLASS_QNAN, IEEE754_CLASS_INF):\r\nreturn x;\r\ncase CLPAIR(IEEE754_CLASS_INF, IEEE754_CLASS_INF):\r\nif (xs != ys)\r\nreturn x;\r\nieee754_setcx(IEEE754_INVALID_OPERATION);\r\nreturn ieee754dp_indef();\r\ncase CLPAIR(IEEE754_CLASS_ZERO, IEEE754_CLASS_INF):\r\ncase CLPAIR(IEEE754_CLASS_DNORM, IEEE754_CLASS_INF):\r\ncase CLPAIR(IEEE754_CLASS_NORM, IEEE754_CLASS_INF):\r\nreturn ieee754dp_inf(ys ^ 1);\r\ncase CLPAIR(IEEE754_CLASS_INF, IEEE754_CLASS_ZERO):\r\ncase CLPAIR(IEEE754_CLASS_INF, IEEE754_CLASS_NORM):\r\ncase CLPAIR(IEEE754_CLASS_INF, IEEE754_CLASS_DNORM):\r\nreturn x;\r\ncase CLPAIR(IEEE754_CLASS_ZERO, IEEE754_CLASS_ZERO):\r\nif (xs != ys)\r\nreturn x;\r\nelse\r\nreturn ieee754dp_zero(ieee754_csr.rm == FPU_CSR_RD);\r\ncase CLPAIR(IEEE754_CLASS_NORM, IEEE754_CLASS_ZERO):\r\ncase CLPAIR(IEEE754_CLASS_DNORM, IEEE754_CLASS_ZERO):\r\nreturn x;\r\ncase CLPAIR(IEEE754_CLASS_ZERO, IEEE754_CLASS_NORM):\r\ncase CLPAIR(IEEE754_CLASS_ZERO, IEEE754_CLASS_DNORM):\r\nDPSIGN(y) ^= 1;\r\nreturn y;\r\ncase CLPAIR(IEEE754_CLASS_DNORM, IEEE754_CLASS_DNORM):\r\nDPDNORMX;\r\ncase CLPAIR(IEEE754_CLASS_NORM, IEEE754_CLASS_DNORM):\r\nDPDNORMY;\r\nbreak;\r\ncase CLPAIR(IEEE754_CLASS_DNORM, IEEE754_CLASS_NORM):\r\nDPDNORMX;\r\nbreak;\r\ncase CLPAIR(IEEE754_CLASS_NORM, IEEE754_CLASS_NORM):\r\nbreak;\r\n}\r\nys ^= 1;\r\nassert(xm & DP_HIDDEN_BIT);\r\nassert(ym & DP_HIDDEN_BIT);\r\nxm <<= 3;\r\nym <<= 3;\r\nif (xe > ye) {\r\ns = xe - ye;\r\nym = XDPSRS(ym, s);\r\nye += s;\r\n} else if (ye > xe) {\r\ns = ye - xe;\r\nxm = XDPSRS(xm, s);\r\nxe += s;\r\n}\r\nassert(xe == ye);\r\nassert(xe <= DP_EMAX);\r\nif (xs == ys) {\r\nxm = xm + ym;\r\nif (xm >> (DP_FBITS + 1 + 3)) {\r\nxm = XDPSRS1(xm);\r\nxe++;\r\n}\r\n} else {\r\nif (xm >= ym) {\r\nxm = xm - ym;\r\n} else {\r\nxm = ym - xm;\r\nxs = ys;\r\n}\r\nif (xm == 0) {\r\nif (ieee754_csr.rm == FPU_CSR_RD)\r\nreturn ieee754dp_zero(1);\r\nelse\r\nreturn ieee754dp_zero(0);\r\n}\r\nwhile ((xm >> (DP_FBITS + 3)) == 0) {\r\nxm <<= 1;\r\nxe--;\r\n}\r\n}\r\nreturn ieee754dp_format(xs, xe, xm);\r\n}

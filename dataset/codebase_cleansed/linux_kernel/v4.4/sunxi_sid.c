static u8 sunxi_sid_read_byte(const struct sunxi_sid *sid,\r\nconst unsigned int offset)\r\n{\r\nu32 sid_key;\r\nsid_key = ioread32be(sid->base + round_down(offset, 4));\r\nsid_key >>= (offset % 4) * 8;\r\nreturn sid_key;\r\n}\r\nstatic int sunxi_sid_read(void *context,\r\nconst void *reg, size_t reg_size,\r\nvoid *val, size_t val_size)\r\n{\r\nstruct sunxi_sid *sid = context;\r\nunsigned int offset = *(u32 *)reg;\r\nu8 *buf = val;\r\nwhile (val_size) {\r\n*buf++ = sunxi_sid_read_byte(sid, offset);\r\nval_size--;\r\noffset++;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sunxi_sid_write(void *context, const void *data, size_t count)\r\n{\r\nreturn 0;\r\n}\r\nstatic bool sunxi_sid_writeable_reg(struct device *dev, unsigned int reg)\r\n{\r\nreturn false;\r\n}\r\nstatic int sunxi_sid_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct resource *res;\r\nstruct nvmem_device *nvmem;\r\nstruct regmap *regmap;\r\nstruct sunxi_sid *sid;\r\nint ret, i, size;\r\nchar *randomness;\r\nsid = devm_kzalloc(dev, sizeof(*sid), GFP_KERNEL);\r\nif (!sid)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nsid->base = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(sid->base))\r\nreturn PTR_ERR(sid->base);\r\nsize = resource_size(res) - 1;\r\nsunxi_sid_regmap_config.max_register = size;\r\nregmap = devm_regmap_init(dev, &sunxi_sid_bus, sid,\r\n&sunxi_sid_regmap_config);\r\nif (IS_ERR(regmap)) {\r\ndev_err(dev, "regmap init failed\n");\r\nreturn PTR_ERR(regmap);\r\n}\r\neconfig.dev = dev;\r\nnvmem = nvmem_register(&econfig);\r\nif (IS_ERR(nvmem))\r\nreturn PTR_ERR(nvmem);\r\nrandomness = kzalloc(sizeof(u8) * size, GFP_KERNEL);\r\nif (!randomness) {\r\nret = -EINVAL;\r\ngoto err_unreg_nvmem;\r\n}\r\nfor (i = 0; i < size; i++)\r\nrandomness[i] = sunxi_sid_read_byte(sid, i);\r\nadd_device_randomness(randomness, size);\r\nkfree(randomness);\r\nplatform_set_drvdata(pdev, nvmem);\r\nreturn 0;\r\nerr_unreg_nvmem:\r\nnvmem_unregister(nvmem);\r\nreturn ret;\r\n}\r\nstatic int sunxi_sid_remove(struct platform_device *pdev)\r\n{\r\nstruct nvmem_device *nvmem = platform_get_drvdata(pdev);\r\nreturn nvmem_unregister(nvmem);\r\n}

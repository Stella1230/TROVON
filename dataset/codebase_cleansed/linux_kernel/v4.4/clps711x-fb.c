static int clps711x_fb_setcolreg(u_int regno, u_int red, u_int green,\r\nu_int blue, u_int transp, struct fb_info *info)\r\n{\r\nstruct clps711x_fb_info *cfb = info->par;\r\nu32 level, mask, shift;\r\nif (regno >= BIT(info->var.bits_per_pixel))\r\nreturn -EINVAL;\r\nshift = 4 * (regno & 7);\r\nmask = 0xf << shift;\r\nlevel = (((red * 77 + green * 151 + blue * 28) >> 20) << shift) & mask;\r\nif (cfb->cmap_invert)\r\nlevel = 0xf - level;\r\nregno = (regno < 8) ? CLPS711X_PALLSW : CLPS711X_PALMSW;\r\nwritel((readl(cfb->base + regno) & ~mask) | level, cfb->base + regno);\r\nreturn 0;\r\n}\r\nstatic int clps711x_fb_check_var(struct fb_var_screeninfo *var,\r\nstruct fb_info *info)\r\n{\r\nu32 val;\r\nif (var->bits_per_pixel < 1 ||\r\nvar->bits_per_pixel > CLPS711X_FB_BPP_MAX)\r\nreturn -EINVAL;\r\nif (!var->pixclock)\r\nreturn -EINVAL;\r\nval = DIV_ROUND_UP(var->xres, 16) - 1;\r\nif (val < 0x01 || val > 0x3f)\r\nreturn -EINVAL;\r\nval = DIV_ROUND_UP(var->yres * var->xres * var->bits_per_pixel, 128);\r\nval--;\r\nif (val < 0x001 || val > 0x1fff)\r\nreturn -EINVAL;\r\nvar->transp.msb_right = 0;\r\nvar->transp.offset = 0;\r\nvar->transp.length = 0;\r\nvar->red.msb_right = 0;\r\nvar->red.offset = 0;\r\nvar->red.length = var->bits_per_pixel;\r\nvar->green = var->red;\r\nvar->blue = var->red;\r\nvar->grayscale = var->bits_per_pixel > 1;\r\nreturn 0;\r\n}\r\nstatic int clps711x_fb_set_par(struct fb_info *info)\r\n{\r\nstruct clps711x_fb_info *cfb = info->par;\r\nresource_size_t size;\r\nu32 lcdcon, pps;\r\nsize = (info->var.xres * info->var.yres * info->var.bits_per_pixel) / 8;\r\nif (size > cfb->buffsize)\r\nreturn -EINVAL;\r\nswitch (info->var.bits_per_pixel) {\r\ncase 1:\r\ninfo->fix.visual = FB_VISUAL_MONO01;\r\nbreak;\r\ncase 2:\r\ncase 4:\r\ninfo->fix.visual = FB_VISUAL_PSEUDOCOLOR;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ninfo->fix.line_length = info->var.xres * info->var.bits_per_pixel / 8;\r\ninfo->fix.smem_len = size;\r\nlcdcon = (info->var.xres * info->var.yres *\r\ninfo->var.bits_per_pixel) / 128 - 1;\r\nlcdcon |= ((info->var.xres / 16) - 1) << 13;\r\nlcdcon |= (cfb->ac_prescale & 0x1f) << 25;\r\npps = clk_get_rate(cfb->clk) / (PICOS2KHZ(info->var.pixclock) * 1000);\r\nif (pps)\r\npps--;\r\nlcdcon |= (pps & 0x3f) << 19;\r\nif (info->var.bits_per_pixel == 4)\r\nlcdcon |= LCDCON_GSMD;\r\nif (info->var.bits_per_pixel >= 2)\r\nlcdcon |= LCDCON_GSEN;\r\nregmap_update_bits(cfb->syscon, SYSCON_OFFSET, SYSCON1_LCDEN, 0);\r\nwritel(lcdcon, cfb->base + CLPS711X_LCDCON);\r\nregmap_update_bits(cfb->syscon, SYSCON_OFFSET,\r\nSYSCON1_LCDEN, SYSCON1_LCDEN);\r\nreturn 0;\r\n}\r\nstatic int clps711x_fb_blank(int blank, struct fb_info *info)\r\n{\r\nreturn 0;\r\n}\r\nstatic int clps711x_lcd_check_fb(struct lcd_device *lcddev, struct fb_info *fi)\r\n{\r\nstruct clps711x_fb_info *cfb = dev_get_drvdata(&lcddev->dev);\r\nreturn (!fi || fi->par == cfb) ? 1 : 0;\r\n}\r\nstatic int clps711x_lcd_get_power(struct lcd_device *lcddev)\r\n{\r\nstruct clps711x_fb_info *cfb = dev_get_drvdata(&lcddev->dev);\r\nif (!IS_ERR_OR_NULL(cfb->lcd_pwr))\r\nif (!regulator_is_enabled(cfb->lcd_pwr))\r\nreturn FB_BLANK_NORMAL;\r\nreturn FB_BLANK_UNBLANK;\r\n}\r\nstatic int clps711x_lcd_set_power(struct lcd_device *lcddev, int blank)\r\n{\r\nstruct clps711x_fb_info *cfb = dev_get_drvdata(&lcddev->dev);\r\nif (!IS_ERR_OR_NULL(cfb->lcd_pwr)) {\r\nif (blank == FB_BLANK_UNBLANK) {\r\nif (!regulator_is_enabled(cfb->lcd_pwr))\r\nreturn regulator_enable(cfb->lcd_pwr);\r\n} else {\r\nif (regulator_is_enabled(cfb->lcd_pwr))\r\nreturn regulator_disable(cfb->lcd_pwr);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int clps711x_fb_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *disp, *np = dev->of_node;\r\nstruct clps711x_fb_info *cfb;\r\nstruct lcd_device *lcd;\r\nstruct fb_info *info;\r\nstruct resource *res;\r\nint ret = -ENOENT;\r\nu32 val;\r\nif (fb_get_options(CLPS711X_FB_NAME, NULL))\r\nreturn -ENODEV;\r\ninfo = framebuffer_alloc(sizeof(*cfb), dev);\r\nif (!info)\r\nreturn -ENOMEM;\r\ncfb = info->par;\r\nplatform_set_drvdata(pdev, info);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\ngoto out_fb_release;\r\ncfb->base = devm_ioremap(dev, res->start, resource_size(res));\r\nif (!cfb->base) {\r\nret = -ENOMEM;\r\ngoto out_fb_release;\r\n}\r\ninfo->fix.mmio_start = res->start;\r\ninfo->fix.mmio_len = resource_size(res);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 1);\r\ninfo->screen_base = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(info->screen_base)) {\r\nret = PTR_ERR(info->screen_base);\r\ngoto out_fb_release;\r\n}\r\nif (res->start & 0x0fffffff) {\r\nret = -EINVAL;\r\ngoto out_fb_release;\r\n}\r\ninfo->apertures = alloc_apertures(1);\r\nif (!info->apertures) {\r\nret = -ENOMEM;\r\ngoto out_fb_release;\r\n}\r\ncfb->buffsize = resource_size(res);\r\ninfo->fix.smem_start = res->start;\r\ninfo->apertures->ranges[0].base = info->fix.smem_start;\r\ninfo->apertures->ranges[0].size = cfb->buffsize;\r\ncfb->clk = devm_clk_get(dev, NULL);\r\nif (IS_ERR(cfb->clk)) {\r\nret = PTR_ERR(cfb->clk);\r\ngoto out_fb_release;\r\n}\r\ncfb->syscon =\r\nsyscon_regmap_lookup_by_compatible("cirrus,clps711x-syscon1");\r\nif (IS_ERR(cfb->syscon)) {\r\nret = PTR_ERR(cfb->syscon);\r\ngoto out_fb_release;\r\n}\r\ndisp = of_parse_phandle(np, "display", 0);\r\nif (!disp) {\r\ndev_err(&pdev->dev, "No display defined\n");\r\nret = -ENODATA;\r\ngoto out_fb_release;\r\n}\r\nret = of_get_fb_videomode(disp, &cfb->mode, OF_USE_NATIVE_MODE);\r\nif (ret)\r\ngoto out_fb_release;\r\nof_property_read_u32(disp, "ac-prescale", &cfb->ac_prescale);\r\ncfb->cmap_invert = of_property_read_bool(disp, "cmap-invert");\r\nret = of_property_read_u32(disp, "bits-per-pixel",\r\n&info->var.bits_per_pixel);\r\nif (ret)\r\ngoto out_fb_release;\r\nif (info->fix.smem_start != (readb(cfb->base + CLPS711X_FBADDR) << 28))\r\nregmap_update_bits(cfb->syscon, SYSCON_OFFSET,\r\nSYSCON1_LCDEN, 0);\r\nret = regmap_read(cfb->syscon, SYSCON_OFFSET, &val);\r\nif (ret)\r\ngoto out_fb_release;\r\nif (!(val & SYSCON1_LCDEN)) {\r\nwriteb(info->fix.smem_start >> 28, cfb->base + CLPS711X_FBADDR);\r\nmemset_io(info->screen_base, 0, cfb->buffsize);\r\n}\r\ncfb->lcd_pwr = devm_regulator_get(dev, "lcd");\r\nif (PTR_ERR(cfb->lcd_pwr) == -EPROBE_DEFER) {\r\nret = -EPROBE_DEFER;\r\ngoto out_fb_release;\r\n}\r\ninfo->fbops = &clps711x_fb_ops;\r\ninfo->flags = FBINFO_DEFAULT;\r\ninfo->var.activate = FB_ACTIVATE_FORCE | FB_ACTIVATE_NOW;\r\ninfo->var.height = -1;\r\ninfo->var.width = -1;\r\ninfo->var.vmode = FB_VMODE_NONINTERLACED;\r\ninfo->fix.type = FB_TYPE_PACKED_PIXELS;\r\ninfo->fix.accel = FB_ACCEL_NONE;\r\nstrlcpy(info->fix.id, CLPS711X_FB_NAME, sizeof(info->fix.id));\r\nfb_videomode_to_var(&info->var, &cfb->mode);\r\nret = fb_alloc_cmap(&info->cmap, BIT(CLPS711X_FB_BPP_MAX), 0);\r\nif (ret)\r\ngoto out_fb_release;\r\nret = fb_set_var(info, &info->var);\r\nif (ret)\r\ngoto out_fb_dealloc_cmap;\r\nret = register_framebuffer(info);\r\nif (ret)\r\ngoto out_fb_dealloc_cmap;\r\nlcd = devm_lcd_device_register(dev, "clps711x-lcd", dev, cfb,\r\n&clps711x_lcd_ops);\r\nif (!IS_ERR(lcd))\r\nreturn 0;\r\nret = PTR_ERR(lcd);\r\nunregister_framebuffer(info);\r\nout_fb_dealloc_cmap:\r\nregmap_update_bits(cfb->syscon, SYSCON_OFFSET, SYSCON1_LCDEN, 0);\r\nfb_dealloc_cmap(&info->cmap);\r\nout_fb_release:\r\nframebuffer_release(info);\r\nreturn ret;\r\n}\r\nstatic int clps711x_fb_remove(struct platform_device *pdev)\r\n{\r\nstruct fb_info *info = platform_get_drvdata(pdev);\r\nstruct clps711x_fb_info *cfb = info->par;\r\nregmap_update_bits(cfb->syscon, SYSCON_OFFSET, SYSCON1_LCDEN, 0);\r\nunregister_framebuffer(info);\r\nfb_dealloc_cmap(&info->cmap);\r\nframebuffer_release(info);\r\nreturn 0;\r\n}

static ssize_t wusb_disconnect_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nstruct usb_device *usb_dev;\r\nstruct wusbhc *wusbhc;\r\nunsigned command;\r\nu8 port_idx;\r\nif (sscanf(buf, "%u", &command) != 1)\r\nreturn -EINVAL;\r\nif (command == 0)\r\nreturn size;\r\nusb_dev = to_usb_device(dev);\r\nwusbhc = wusbhc_get_by_usb_dev(usb_dev);\r\nif (wusbhc == NULL)\r\nreturn -ENODEV;\r\nmutex_lock(&wusbhc->mutex);\r\nport_idx = wusb_port_no_to_idx(usb_dev->portnum);\r\n__wusbhc_dev_disable(wusbhc, port_idx);\r\nmutex_unlock(&wusbhc->mutex);\r\nwusbhc_put(wusbhc);\r\nreturn size;\r\n}\r\nstatic ssize_t wusb_cdid_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nssize_t result;\r\nstruct wusb_dev *wusb_dev;\r\nwusb_dev = wusb_dev_get_by_usb_dev(to_usb_device(dev));\r\nif (wusb_dev == NULL)\r\nreturn -ENODEV;\r\nresult = ckhdid_printf(buf, PAGE_SIZE, &wusb_dev->cdid);\r\nstrcat(buf, "\n");\r\nwusb_dev_put(wusb_dev);\r\nreturn result + 1;\r\n}\r\nstatic ssize_t wusb_ck_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nint result;\r\nstruct usb_device *usb_dev;\r\nstruct wusbhc *wusbhc;\r\nstruct wusb_ckhdid ck;\r\nresult = sscanf(buf,\r\n"%02hhx %02hhx %02hhx %02hhx "\r\n"%02hhx %02hhx %02hhx %02hhx "\r\n"%02hhx %02hhx %02hhx %02hhx "\r\n"%02hhx %02hhx %02hhx %02hhx\n",\r\n&ck.data[0] , &ck.data[1],\r\n&ck.data[2] , &ck.data[3],\r\n&ck.data[4] , &ck.data[5],\r\n&ck.data[6] , &ck.data[7],\r\n&ck.data[8] , &ck.data[9],\r\n&ck.data[10], &ck.data[11],\r\n&ck.data[12], &ck.data[13],\r\n&ck.data[14], &ck.data[15]);\r\nif (result != 16)\r\nreturn -EINVAL;\r\nusb_dev = to_usb_device(dev);\r\nwusbhc = wusbhc_get_by_usb_dev(usb_dev);\r\nif (wusbhc == NULL)\r\nreturn -ENODEV;\r\nresult = wusb_dev_4way_handshake(wusbhc, usb_dev->wusb_dev, &ck);\r\nmemzero_explicit(&ck, sizeof(ck));\r\nwusbhc_put(wusbhc);\r\nreturn result < 0 ? result : size;\r\n}\r\nint wusb_dev_sysfs_add(struct wusbhc *wusbhc, struct usb_device *usb_dev,\r\nstruct wusb_dev *wusb_dev)\r\n{\r\nint result = sysfs_create_group(&usb_dev->dev.kobj,\r\n&wusb_dev_attr_group);\r\nstruct device *dev = &usb_dev->dev;\r\nif (result < 0)\r\ndev_err(dev, "Cannot register WUSB-dev attributes: %d\n",\r\nresult);\r\nreturn result;\r\n}\r\nvoid wusb_dev_sysfs_rm(struct wusb_dev *wusb_dev)\r\n{\r\nstruct usb_device *usb_dev = wusb_dev->usb_dev;\r\nif (usb_dev)\r\nsysfs_remove_group(&usb_dev->dev.kobj, &wusb_dev_attr_group);\r\n}

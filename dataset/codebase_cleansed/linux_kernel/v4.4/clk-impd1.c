void integrator_impd1_clk_init(void __iomem *base, unsigned int id)\r\n{\r\nstruct impd1_clk *imc;\r\nstruct clk *clk;\r\nstruct clk *pclk;\r\nint i;\r\nif (id > 3) {\r\npr_crit("no more than 4 LMs can be attached\n");\r\nreturn;\r\n}\r\nimc = &impd1_clks[id];\r\nimc->pclkname = kasprintf(GFP_KERNEL, "lm%x-pclk", id);\r\npclk = clk_register_fixed_rate(NULL, imc->pclkname, NULL,\r\nCLK_IS_ROOT, 0);\r\nimc->pclk = pclk;\r\nimc->vco1name = kasprintf(GFP_KERNEL, "lm%x-vco1", id);\r\nclk = icst_clk_register(NULL, &impd1_icst1_desc, imc->vco1name, NULL,\r\nbase);\r\nimc->vco1clk = clk;\r\nimc->clks[0] = clkdev_alloc(pclk, "apb_pclk", "lm%x:01000", id);\r\nimc->clks[1] = clkdev_alloc(clk, NULL, "lm%x:01000", id);\r\nimc->vco2name = kasprintf(GFP_KERNEL, "lm%x-vco2", id);\r\nclk = icst_clk_register(NULL, &impd1_icst2_desc, imc->vco2name, NULL,\r\nbase);\r\nimc->vco2clk = clk;\r\nimc->clks[2] = clkdev_alloc(pclk, "apb_pclk", "lm%x:00700", id);\r\nimc->clks[3] = clkdev_alloc(clk, NULL, "lm%x:00700", id);\r\nimc->uartname = kasprintf(GFP_KERNEL, "lm%x-uartclk", id);\r\nclk = clk_register_fixed_factor(NULL, imc->uartname, imc->vco2name,\r\nCLK_IGNORE_UNUSED, 1, 4);\r\nimc->uartclk = clk;\r\nimc->clks[4] = clkdev_alloc(pclk, "apb_pclk", "lm%x:00100", id);\r\nimc->clks[5] = clkdev_alloc(clk, NULL, "lm%x:00100", id);\r\nimc->clks[6] = clkdev_alloc(pclk, "apb_pclk", "lm%x:00200", id);\r\nimc->clks[7] = clkdev_alloc(clk, NULL, "lm%x:00200", id);\r\nimc->spiname = kasprintf(GFP_KERNEL, "lm%x-spiclk", id);\r\nclk = clk_register_fixed_factor(NULL, imc->spiname, imc->vco2name,\r\nCLK_IGNORE_UNUSED, 1, 64);\r\nimc->clks[8] = clkdev_alloc(pclk, "apb_pclk", "lm%x:00300", id);\r\nimc->clks[9] = clkdev_alloc(clk, NULL, "lm%x:00300", id);\r\nimc->clks[10] = clkdev_alloc(pclk, "apb_pclk", "lm%x:00400", id);\r\nimc->clks[11] = clkdev_alloc(pclk, "apb_pclk", "lm%x:00500", id);\r\nimc->clks[12] = clkdev_alloc(pclk, "apb_pclk", "lm%x:00800", id);\r\nimc->scname = kasprintf(GFP_KERNEL, "lm%x-scclk", id);\r\nclk = clk_register_fixed_factor(NULL, imc->scname, imc->vco2name,\r\nCLK_IGNORE_UNUSED, 1, 4);\r\nimc->scclk = clk;\r\nimc->clks[13] = clkdev_alloc(pclk, "apb_pclk", "lm%x:00600", id);\r\nimc->clks[14] = clkdev_alloc(clk, NULL, "lm%x:00600", id);\r\nfor (i = 0; i < ARRAY_SIZE(imc->clks); i++)\r\nclkdev_add(imc->clks[i]);\r\n}\r\nvoid integrator_impd1_clk_exit(unsigned int id)\r\n{\r\nint i;\r\nstruct impd1_clk *imc;\r\nif (id > 3)\r\nreturn;\r\nimc = &impd1_clks[id];\r\nfor (i = 0; i < ARRAY_SIZE(imc->clks); i++)\r\nclkdev_drop(imc->clks[i]);\r\nclk_unregister(imc->spiclk);\r\nclk_unregister(imc->uartclk);\r\nclk_unregister(imc->vco2clk);\r\nclk_unregister(imc->vco1clk);\r\nclk_unregister(imc->pclk);\r\nkfree(imc->scname);\r\nkfree(imc->spiname);\r\nkfree(imc->uartname);\r\nkfree(imc->vco2name);\r\nkfree(imc->vco1name);\r\nkfree(imc->pclkname);\r\n}

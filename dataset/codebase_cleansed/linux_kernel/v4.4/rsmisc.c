acpi_status\r\nacpi_rs_convert_aml_to_resource(struct acpi_resource *resource,\r\nunion aml_resource *aml,\r\nstruct acpi_rsconvert_info *info)\r\n{\r\nacpi_rs_length aml_resource_length;\r\nvoid *source;\r\nvoid *destination;\r\nchar *target;\r\nu8 count;\r\nu8 flags_mode = FALSE;\r\nu16 item_count = 0;\r\nu16 temp16 = 0;\r\nACPI_FUNCTION_TRACE(rs_convert_aml_to_resource);\r\nif (!info) {\r\nreturn_ACPI_STATUS(AE_BAD_PARAMETER);\r\n}\r\nif (((acpi_size) resource) & 0x3) {\r\nACPI_WARNING((AE_INFO,\r\n"Misaligned resource pointer (get): %p Type 0x%2.2X Length %u",\r\nresource, resource->type, resource->length));\r\n}\r\naml_resource_length = acpi_ut_get_resource_length(aml);\r\ncount = INIT_TABLE_LENGTH(info);\r\nwhile (count) {\r\nsource = ACPI_ADD_PTR(void, aml, info->aml_offset);\r\ndestination =\r\nACPI_ADD_PTR(void, resource, info->resource_offset);\r\nswitch (info->opcode) {\r\ncase ACPI_RSC_INITGET:\r\nmemset(resource, 0, INIT_RESOURCE_LENGTH(info));\r\nresource->type = INIT_RESOURCE_TYPE(info);\r\nresource->length = INIT_RESOURCE_LENGTH(info);\r\nbreak;\r\ncase ACPI_RSC_INITSET:\r\nbreak;\r\ncase ACPI_RSC_FLAGINIT:\r\nflags_mode = TRUE;\r\nbreak;\r\ncase ACPI_RSC_1BITFLAG:\r\nACPI_SET8(destination,\r\n((ACPI_GET8(source) >> info->value) & 0x01));\r\nbreak;\r\ncase ACPI_RSC_2BITFLAG:\r\nACPI_SET8(destination,\r\n((ACPI_GET8(source) >> info->value) & 0x03));\r\nbreak;\r\ncase ACPI_RSC_3BITFLAG:\r\nACPI_SET8(destination,\r\n((ACPI_GET8(source) >> info->value) & 0x07));\r\nbreak;\r\ncase ACPI_RSC_COUNT:\r\nitem_count = ACPI_GET8(source);\r\nACPI_SET8(destination, item_count);\r\nresource->length = resource->length +\r\n(info->value * (item_count - 1));\r\nbreak;\r\ncase ACPI_RSC_COUNT16:\r\nitem_count = aml_resource_length;\r\nACPI_SET16(destination, item_count);\r\nresource->length = resource->length +\r\n(info->value * (item_count - 1));\r\nbreak;\r\ncase ACPI_RSC_COUNT_GPIO_PIN:\r\ntarget = ACPI_ADD_PTR(void, aml, info->value);\r\nitem_count = ACPI_GET16(target) - ACPI_GET16(source);\r\nresource->length = resource->length + item_count;\r\nitem_count = item_count / 2;\r\nACPI_SET16(destination, item_count);\r\nbreak;\r\ncase ACPI_RSC_COUNT_GPIO_VEN:\r\nitem_count = ACPI_GET8(source);\r\nACPI_SET8(destination, item_count);\r\nresource->length = resource->length +\r\n(info->value * item_count);\r\nbreak;\r\ncase ACPI_RSC_COUNT_GPIO_RES:\r\ntarget = ACPI_ADD_PTR(void, aml, (info->value + 2));\r\nif (ACPI_GET16(target)) {\r\ntarget = ACPI_ADD_PTR(void, aml, info->value);\r\nitem_count =\r\nACPI_GET16(target) - ACPI_GET16(source);\r\n} else {\r\nitem_count = aml->large_header.resource_length +\r\nsizeof(struct aml_resource_large_header) -\r\nACPI_GET16(source);\r\n}\r\nresource->length = resource->length + item_count;\r\nACPI_SET16(destination, item_count);\r\nbreak;\r\ncase ACPI_RSC_COUNT_SERIAL_VEN:\r\nitem_count = ACPI_GET16(source) - info->value;\r\nresource->length = resource->length + item_count;\r\nACPI_SET16(destination, item_count);\r\nbreak;\r\ncase ACPI_RSC_COUNT_SERIAL_RES:\r\nitem_count = (aml_resource_length +\r\nsizeof(struct aml_resource_large_header))\r\n- ACPI_GET16(source) - info->value;\r\nresource->length = resource->length + item_count;\r\nACPI_SET16(destination, item_count);\r\nbreak;\r\ncase ACPI_RSC_LENGTH:\r\nresource->length = resource->length + info->value;\r\nbreak;\r\ncase ACPI_RSC_MOVE8:\r\ncase ACPI_RSC_MOVE16:\r\ncase ACPI_RSC_MOVE32:\r\ncase ACPI_RSC_MOVE64:\r\nif (info->value) {\r\nitem_count = info->value;\r\n}\r\nacpi_rs_move_data(destination, source, item_count,\r\ninfo->opcode);\r\nbreak;\r\ncase ACPI_RSC_MOVE_GPIO_PIN:\r\ntarget = (char *)ACPI_ADD_PTR(void, resource,\r\n(resource->length -\r\nitem_count * 2));\r\n*(u16 **)destination = ACPI_CAST_PTR(u16, target);\r\nsource = ACPI_ADD_PTR(void, aml, ACPI_GET16(source));\r\nacpi_rs_move_data(target, source, item_count,\r\ninfo->opcode);\r\nbreak;\r\ncase ACPI_RSC_MOVE_GPIO_RES:\r\ntarget = (char *)ACPI_ADD_PTR(void, resource,\r\n(resource->length -\r\nitem_count));\r\n*(u8 **)destination = ACPI_CAST_PTR(u8, target);\r\nsource = ACPI_ADD_PTR(void, aml, ACPI_GET16(source));\r\nacpi_rs_move_data(target, source, item_count,\r\ninfo->opcode);\r\nbreak;\r\ncase ACPI_RSC_MOVE_SERIAL_VEN:\r\ntarget = (char *)ACPI_ADD_PTR(void, resource,\r\n(resource->length -\r\nitem_count));\r\n*(u8 **)destination = ACPI_CAST_PTR(u8, target);\r\nsource = ACPI_ADD_PTR(void, aml, info->value);\r\nacpi_rs_move_data(target, source, item_count,\r\ninfo->opcode);\r\nbreak;\r\ncase ACPI_RSC_MOVE_SERIAL_RES:\r\ntarget = (char *)ACPI_ADD_PTR(void, resource,\r\n(resource->length -\r\nitem_count));\r\n*(u8 **)destination = ACPI_CAST_PTR(u8, target);\r\nsource =\r\nACPI_ADD_PTR(void, aml,\r\n(ACPI_GET16(source) + info->value));\r\nacpi_rs_move_data(target, source, item_count,\r\ninfo->opcode);\r\nbreak;\r\ncase ACPI_RSC_SET8:\r\nmemset(destination, info->aml_offset, info->value);\r\nbreak;\r\ncase ACPI_RSC_DATA8:\r\ntarget = ACPI_ADD_PTR(char, resource, info->value);\r\nmemcpy(destination, source, ACPI_GET16(target));\r\nbreak;\r\ncase ACPI_RSC_ADDRESS:\r\nif (!acpi_rs_get_address_common(resource, aml)) {\r\nreturn_ACPI_STATUS\r\n(AE_AML_INVALID_RESOURCE_TYPE);\r\n}\r\nbreak;\r\ncase ACPI_RSC_SOURCE:\r\nresource->length +=\r\nacpi_rs_get_resource_source(aml_resource_length,\r\ninfo->value,\r\ndestination, aml, NULL);\r\nbreak;\r\ncase ACPI_RSC_SOURCEX:\r\ntarget = ACPI_ADD_PTR(char, resource,\r\ninfo->aml_offset +\r\n(item_count * 4));\r\nresource->length +=\r\nacpi_rs_get_resource_source(aml_resource_length,\r\n(acpi_rs_length)\r\n(((item_count -\r\n1) * sizeof(u32)) +\r\ninfo->value),\r\ndestination, aml,\r\ntarget);\r\nbreak;\r\ncase ACPI_RSC_BITMASK:\r\nitem_count =\r\nacpi_rs_decode_bitmask(ACPI_GET8(source),\r\ndestination);\r\nif (item_count) {\r\nresource->length += (item_count - 1);\r\n}\r\ntarget = ACPI_ADD_PTR(char, resource, info->value);\r\nACPI_SET8(target, item_count);\r\nbreak;\r\ncase ACPI_RSC_BITMASK16:\r\nACPI_MOVE_16_TO_16(&temp16, source);\r\nitem_count =\r\nacpi_rs_decode_bitmask(temp16, destination);\r\nif (item_count) {\r\nresource->length += (item_count - 1);\r\n}\r\ntarget = ACPI_ADD_PTR(char, resource, info->value);\r\nACPI_SET8(target, item_count);\r\nbreak;\r\ncase ACPI_RSC_EXIT_NE:\r\nswitch (info->resource_offset) {\r\ncase ACPI_RSC_COMPARE_AML_LENGTH:\r\nif (aml_resource_length != info->value) {\r\ngoto exit;\r\n}\r\nbreak;\r\ncase ACPI_RSC_COMPARE_VALUE:\r\nif (ACPI_GET8(source) != info->value) {\r\ngoto exit;\r\n}\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"Invalid conversion sub-opcode"));\r\nreturn_ACPI_STATUS(AE_BAD_PARAMETER);\r\n}\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO, "Invalid conversion opcode"));\r\nreturn_ACPI_STATUS(AE_BAD_PARAMETER);\r\n}\r\ncount--;\r\ninfo++;\r\n}\r\nexit:\r\nif (!flags_mode) {\r\nresource->length =\r\n(u32) ACPI_ROUND_UP_TO_NATIVE_WORD(resource->length);\r\n}\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nacpi_status\r\nacpi_rs_convert_resource_to_aml(struct acpi_resource *resource,\r\nunion aml_resource *aml,\r\nstruct acpi_rsconvert_info *info)\r\n{\r\nvoid *source = NULL;\r\nvoid *destination;\r\nchar *target;\r\nacpi_rsdesc_size aml_length = 0;\r\nu8 count;\r\nu16 temp16 = 0;\r\nu16 item_count = 0;\r\nACPI_FUNCTION_TRACE(rs_convert_resource_to_aml);\r\nif (!info) {\r\nreturn_ACPI_STATUS(AE_BAD_PARAMETER);\r\n}\r\ncount = INIT_TABLE_LENGTH(info);\r\nwhile (count) {\r\nsource = ACPI_ADD_PTR(void, resource, info->resource_offset);\r\ndestination = ACPI_ADD_PTR(void, aml, info->aml_offset);\r\nswitch (info->opcode) {\r\ncase ACPI_RSC_INITSET:\r\nmemset(aml, 0, INIT_RESOURCE_LENGTH(info));\r\naml_length = INIT_RESOURCE_LENGTH(info);\r\nacpi_rs_set_resource_header(INIT_RESOURCE_TYPE(info),\r\naml_length, aml);\r\nbreak;\r\ncase ACPI_RSC_INITGET:\r\nbreak;\r\ncase ACPI_RSC_FLAGINIT:\r\nACPI_SET8(destination, 0);\r\nbreak;\r\ncase ACPI_RSC_1BITFLAG:\r\nACPI_SET_BIT(*ACPI_CAST8(destination), (u8)\r\n((ACPI_GET8(source) & 0x01) << info->\r\nvalue));\r\nbreak;\r\ncase ACPI_RSC_2BITFLAG:\r\nACPI_SET_BIT(*ACPI_CAST8(destination), (u8)\r\n((ACPI_GET8(source) & 0x03) << info->\r\nvalue));\r\nbreak;\r\ncase ACPI_RSC_3BITFLAG:\r\nACPI_SET_BIT(*ACPI_CAST8(destination), (u8)\r\n((ACPI_GET8(source) & 0x07) << info->\r\nvalue));\r\nbreak;\r\ncase ACPI_RSC_COUNT:\r\nitem_count = ACPI_GET8(source);\r\nACPI_SET8(destination, item_count);\r\naml_length =\r\n(u16) (aml_length +\r\n(info->value * (item_count - 1)));\r\nbreak;\r\ncase ACPI_RSC_COUNT16:\r\nitem_count = ACPI_GET16(source);\r\naml_length = (u16) (aml_length + item_count);\r\nacpi_rs_set_resource_length(aml_length, aml);\r\nbreak;\r\ncase ACPI_RSC_COUNT_GPIO_PIN:\r\nitem_count = ACPI_GET16(source);\r\nACPI_SET16(destination, aml_length);\r\naml_length = (u16)(aml_length + item_count * 2);\r\ntarget = ACPI_ADD_PTR(void, aml, info->value);\r\nACPI_SET16(target, aml_length);\r\nacpi_rs_set_resource_length(aml_length, aml);\r\nbreak;\r\ncase ACPI_RSC_COUNT_GPIO_VEN:\r\nitem_count = ACPI_GET16(source);\r\nACPI_SET16(destination, item_count);\r\naml_length =\r\n(u16)(aml_length + (info->value * item_count));\r\nacpi_rs_set_resource_length(aml_length, aml);\r\nbreak;\r\ncase ACPI_RSC_COUNT_GPIO_RES:\r\nitem_count = ACPI_GET16(source);\r\nACPI_SET16(destination, aml_length);\r\naml_length = (u16)(aml_length + item_count);\r\ntarget = ACPI_ADD_PTR(void, aml, info->value);\r\nif (resource->data.gpio.vendor_length) {\r\nACPI_SET16(target, aml_length);\r\n}\r\nacpi_rs_set_resource_length(aml_length, aml);\r\nbreak;\r\ncase ACPI_RSC_COUNT_SERIAL_VEN:\r\nitem_count = ACPI_GET16(source);\r\nACPI_SET16(destination, item_count + info->value);\r\naml_length = (u16)(aml_length + item_count);\r\nacpi_rs_set_resource_length(aml_length, aml);\r\nbreak;\r\ncase ACPI_RSC_COUNT_SERIAL_RES:\r\nitem_count = ACPI_GET16(source);\r\naml_length = (u16)(aml_length + item_count);\r\nacpi_rs_set_resource_length(aml_length, aml);\r\nbreak;\r\ncase ACPI_RSC_LENGTH:\r\nacpi_rs_set_resource_length(info->value, aml);\r\nbreak;\r\ncase ACPI_RSC_MOVE8:\r\ncase ACPI_RSC_MOVE16:\r\ncase ACPI_RSC_MOVE32:\r\ncase ACPI_RSC_MOVE64:\r\nif (info->value) {\r\nitem_count = info->value;\r\n}\r\nacpi_rs_move_data(destination, source, item_count,\r\ninfo->opcode);\r\nbreak;\r\ncase ACPI_RSC_MOVE_GPIO_PIN:\r\ndestination = (char *)ACPI_ADD_PTR(void, aml,\r\nACPI_GET16\r\n(destination));\r\nsource = *(u16 **)source;\r\nacpi_rs_move_data(destination, source, item_count,\r\ninfo->opcode);\r\nbreak;\r\ncase ACPI_RSC_MOVE_GPIO_RES:\r\ndestination = (char *)ACPI_ADD_PTR(void, aml,\r\nACPI_GET16\r\n(destination));\r\nsource = *(u8 **)source;\r\nacpi_rs_move_data(destination, source, item_count,\r\ninfo->opcode);\r\nbreak;\r\ncase ACPI_RSC_MOVE_SERIAL_VEN:\r\ndestination = (char *)ACPI_ADD_PTR(void, aml,\r\n(aml_length -\r\nitem_count));\r\nsource = *(u8 **)source;\r\nacpi_rs_move_data(destination, source, item_count,\r\ninfo->opcode);\r\nbreak;\r\ncase ACPI_RSC_MOVE_SERIAL_RES:\r\ndestination = (char *)ACPI_ADD_PTR(void, aml,\r\n(aml_length -\r\nitem_count));\r\nsource = *(u8 **)source;\r\nacpi_rs_move_data(destination, source, item_count,\r\ninfo->opcode);\r\nbreak;\r\ncase ACPI_RSC_ADDRESS:\r\nacpi_rs_set_address_common(aml, resource);\r\nbreak;\r\ncase ACPI_RSC_SOURCEX:\r\naml_length =\r\nacpi_rs_set_resource_source(aml,\r\n(acpi_rs_length)\r\naml_length, source);\r\nacpi_rs_set_resource_length(aml_length, aml);\r\nbreak;\r\ncase ACPI_RSC_SOURCE:\r\naml_length =\r\nacpi_rs_set_resource_source(aml, info->value,\r\nsource);\r\nacpi_rs_set_resource_length(aml_length, aml);\r\nbreak;\r\ncase ACPI_RSC_BITMASK:\r\nACPI_SET8(destination,\r\nacpi_rs_encode_bitmask(source,\r\n*ACPI_ADD_PTR(u8,\r\nresource,\r\ninfo->\r\nvalue)));\r\nbreak;\r\ncase ACPI_RSC_BITMASK16:\r\ntemp16 = acpi_rs_encode_bitmask(source,\r\n*ACPI_ADD_PTR(u8,\r\nresource,\r\ninfo->\r\nvalue));\r\nACPI_MOVE_16_TO_16(destination, &temp16);\r\nbreak;\r\ncase ACPI_RSC_EXIT_LE:\r\nif (item_count <= info->value) {\r\ngoto exit;\r\n}\r\nbreak;\r\ncase ACPI_RSC_EXIT_NE:\r\nswitch (COMPARE_OPCODE(info)) {\r\ncase ACPI_RSC_COMPARE_VALUE:\r\nif (*ACPI_ADD_PTR(u8, resource,\r\nCOMPARE_TARGET(info)) !=\r\nCOMPARE_VALUE(info)) {\r\ngoto exit;\r\n}\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"Invalid conversion sub-opcode"));\r\nreturn_ACPI_STATUS(AE_BAD_PARAMETER);\r\n}\r\nbreak;\r\ncase ACPI_RSC_EXIT_EQ:\r\nif (*ACPI_ADD_PTR(u8, resource,\r\nCOMPARE_TARGET(info)) ==\r\nCOMPARE_VALUE(info)) {\r\ngoto exit;\r\n}\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO, "Invalid conversion opcode"));\r\nreturn_ACPI_STATUS(AE_BAD_PARAMETER);\r\n}\r\ncount--;\r\ninfo++;\r\n}\r\nexit:\r\nreturn_ACPI_STATUS(AE_OK);\r\n}

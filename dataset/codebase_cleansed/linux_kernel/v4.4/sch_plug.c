static int plug_enqueue(struct sk_buff *skb, struct Qdisc *sch)\r\n{\r\nstruct plug_sched_data *q = qdisc_priv(sch);\r\nif (likely(sch->qstats.backlog + skb->len <= q->limit)) {\r\nif (!q->unplug_indefinite)\r\nq->pkts_current_epoch++;\r\nreturn qdisc_enqueue_tail(skb, sch);\r\n}\r\nreturn qdisc_reshape_fail(skb, sch);\r\n}\r\nstatic struct sk_buff *plug_dequeue(struct Qdisc *sch)\r\n{\r\nstruct plug_sched_data *q = qdisc_priv(sch);\r\nif (qdisc_is_throttled(sch))\r\nreturn NULL;\r\nif (!q->unplug_indefinite) {\r\nif (!q->pkts_to_release) {\r\nqdisc_throttled(sch);\r\nreturn NULL;\r\n}\r\nq->pkts_to_release--;\r\n}\r\nreturn qdisc_dequeue_head(sch);\r\n}\r\nstatic int plug_init(struct Qdisc *sch, struct nlattr *opt)\r\n{\r\nstruct plug_sched_data *q = qdisc_priv(sch);\r\nq->pkts_current_epoch = 0;\r\nq->pkts_last_epoch = 0;\r\nq->pkts_to_release = 0;\r\nq->unplug_indefinite = false;\r\nif (opt == NULL) {\r\nq->limit = qdisc_dev(sch)->tx_queue_len\r\n* psched_mtu(qdisc_dev(sch));\r\n} else {\r\nstruct tc_plug_qopt *ctl = nla_data(opt);\r\nif (nla_len(opt) < sizeof(*ctl))\r\nreturn -EINVAL;\r\nq->limit = ctl->limit;\r\n}\r\nqdisc_throttled(sch);\r\nreturn 0;\r\n}\r\nstatic int plug_change(struct Qdisc *sch, struct nlattr *opt)\r\n{\r\nstruct plug_sched_data *q = qdisc_priv(sch);\r\nstruct tc_plug_qopt *msg;\r\nif (opt == NULL)\r\nreturn -EINVAL;\r\nmsg = nla_data(opt);\r\nif (nla_len(opt) < sizeof(*msg))\r\nreturn -EINVAL;\r\nswitch (msg->action) {\r\ncase TCQ_PLUG_BUFFER:\r\nq->pkts_last_epoch = q->pkts_current_epoch;\r\nq->pkts_current_epoch = 0;\r\nif (q->unplug_indefinite)\r\nqdisc_throttled(sch);\r\nq->unplug_indefinite = false;\r\nbreak;\r\ncase TCQ_PLUG_RELEASE_ONE:\r\nq->pkts_to_release += q->pkts_last_epoch;\r\nq->pkts_last_epoch = 0;\r\nqdisc_unthrottled(sch);\r\nnetif_schedule_queue(sch->dev_queue);\r\nbreak;\r\ncase TCQ_PLUG_RELEASE_INDEFINITE:\r\nq->unplug_indefinite = true;\r\nq->pkts_to_release = 0;\r\nq->pkts_last_epoch = 0;\r\nq->pkts_current_epoch = 0;\r\nqdisc_unthrottled(sch);\r\nnetif_schedule_queue(sch->dev_queue);\r\nbreak;\r\ncase TCQ_PLUG_LIMIT:\r\nq->limit = msg->limit;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init plug_module_init(void)\r\n{\r\nreturn register_qdisc(&plug_qdisc_ops);\r\n}\r\nstatic void __exit plug_module_exit(void)\r\n{\r\nunregister_qdisc(&plug_qdisc_ops);\r\n}

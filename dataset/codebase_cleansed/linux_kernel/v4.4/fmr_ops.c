static int\r\nfmr_op_open(struct rpcrdma_ia *ia, struct rpcrdma_ep *ep,\r\nstruct rpcrdma_create_data_internal *cdata)\r\n{\r\nreturn 0;\r\n}\r\nstatic size_t\r\nfmr_op_maxpages(struct rpcrdma_xprt *r_xprt)\r\n{\r\nreturn min_t(unsigned int, RPCRDMA_MAX_DATA_SEGS,\r\nrpcrdma_max_segments(r_xprt) * RPCRDMA_MAX_FMR_SGES);\r\n}\r\nstatic int\r\nfmr_op_init(struct rpcrdma_xprt *r_xprt)\r\n{\r\nstruct rpcrdma_buffer *buf = &r_xprt->rx_buf;\r\nint mr_access_flags = IB_ACCESS_REMOTE_WRITE | IB_ACCESS_REMOTE_READ;\r\nstruct ib_fmr_attr fmr_attr = {\r\n.max_pages = RPCRDMA_MAX_FMR_SGES,\r\n.max_maps = 1,\r\n.page_shift = PAGE_SHIFT\r\n};\r\nstruct ib_pd *pd = r_xprt->rx_ia.ri_pd;\r\nstruct rpcrdma_mw *r;\r\nint i, rc;\r\nspin_lock_init(&buf->rb_mwlock);\r\nINIT_LIST_HEAD(&buf->rb_mws);\r\nINIT_LIST_HEAD(&buf->rb_all);\r\ni = max_t(int, RPCRDMA_MAX_DATA_SEGS / RPCRDMA_MAX_FMR_SGES, 1);\r\ni += 2;\r\ni *= buf->rb_max_requests;\r\ndprintk("RPC: %s: initalizing %d FMRs\n", __func__, i);\r\nrc = -ENOMEM;\r\nwhile (i--) {\r\nr = kzalloc(sizeof(*r), GFP_KERNEL);\r\nif (!r)\r\ngoto out;\r\nr->r.fmr.physaddrs = kmalloc(RPCRDMA_MAX_FMR_SGES *\r\nsizeof(u64), GFP_KERNEL);\r\nif (!r->r.fmr.physaddrs)\r\ngoto out_free;\r\nr->r.fmr.fmr = ib_alloc_fmr(pd, mr_access_flags, &fmr_attr);\r\nif (IS_ERR(r->r.fmr.fmr))\r\ngoto out_fmr_err;\r\nlist_add(&r->mw_list, &buf->rb_mws);\r\nlist_add(&r->mw_all, &buf->rb_all);\r\n}\r\nreturn 0;\r\nout_fmr_err:\r\nrc = PTR_ERR(r->r.fmr.fmr);\r\ndprintk("RPC: %s: ib_alloc_fmr status %i\n", __func__, rc);\r\nkfree(r->r.fmr.physaddrs);\r\nout_free:\r\nkfree(r);\r\nout:\r\nreturn rc;\r\n}\r\nstatic int\r\n__fmr_unmap(struct rpcrdma_mw *r)\r\n{\r\nLIST_HEAD(l);\r\nlist_add(&r->r.fmr.fmr->list, &l);\r\nreturn ib_unmap_fmr(&l);\r\n}\r\nstatic int\r\nfmr_op_map(struct rpcrdma_xprt *r_xprt, struct rpcrdma_mr_seg *seg,\r\nint nsegs, bool writing)\r\n{\r\nstruct rpcrdma_ia *ia = &r_xprt->rx_ia;\r\nstruct ib_device *device = ia->ri_device;\r\nenum dma_data_direction direction = rpcrdma_data_dir(writing);\r\nstruct rpcrdma_mr_seg *seg1 = seg;\r\nint len, pageoff, i, rc;\r\nstruct rpcrdma_mw *mw;\r\nmw = seg1->rl_mw;\r\nseg1->rl_mw = NULL;\r\nif (!mw) {\r\nmw = rpcrdma_get_mw(r_xprt);\r\nif (!mw)\r\nreturn -ENOMEM;\r\n} else {\r\nrc = __fmr_unmap(mw);\r\nif (rc)\r\nreturn rc;\r\n}\r\npageoff = offset_in_page(seg1->mr_offset);\r\nseg1->mr_offset -= pageoff;\r\nseg1->mr_len += pageoff;\r\nlen = -pageoff;\r\nif (nsegs > RPCRDMA_MAX_FMR_SGES)\r\nnsegs = RPCRDMA_MAX_FMR_SGES;\r\nfor (i = 0; i < nsegs;) {\r\nrpcrdma_map_one(device, seg, direction);\r\nmw->r.fmr.physaddrs[i] = seg->mr_dma;\r\nlen += seg->mr_len;\r\n++seg;\r\n++i;\r\nif ((i < nsegs && offset_in_page(seg->mr_offset)) ||\r\noffset_in_page((seg-1)->mr_offset + (seg-1)->mr_len))\r\nbreak;\r\n}\r\nrc = ib_map_phys_fmr(mw->r.fmr.fmr, mw->r.fmr.physaddrs,\r\ni, seg1->mr_dma);\r\nif (rc)\r\ngoto out_maperr;\r\nseg1->rl_mw = mw;\r\nseg1->mr_rkey = mw->r.fmr.fmr->rkey;\r\nseg1->mr_base = seg1->mr_dma + pageoff;\r\nseg1->mr_nsegs = i;\r\nseg1->mr_len = len;\r\nreturn i;\r\nout_maperr:\r\ndprintk("RPC: %s: ib_map_phys_fmr %u@0x%llx+%i (%d) status %i\n",\r\n__func__, len, (unsigned long long)seg1->mr_dma,\r\npageoff, i, rc);\r\nwhile (i--)\r\nrpcrdma_unmap_one(device, --seg);\r\nreturn rc;\r\n}\r\nstatic int\r\nfmr_op_unmap(struct rpcrdma_xprt *r_xprt, struct rpcrdma_mr_seg *seg)\r\n{\r\nstruct rpcrdma_ia *ia = &r_xprt->rx_ia;\r\nstruct rpcrdma_mr_seg *seg1 = seg;\r\nstruct rpcrdma_mw *mw = seg1->rl_mw;\r\nint rc, nsegs = seg->mr_nsegs;\r\ndprintk("RPC: %s: FMR %p\n", __func__, mw);\r\nseg1->rl_mw = NULL;\r\nwhile (seg1->mr_nsegs--)\r\nrpcrdma_unmap_one(ia->ri_device, seg++);\r\nrc = __fmr_unmap(mw);\r\nif (rc)\r\ngoto out_err;\r\nrpcrdma_put_mw(r_xprt, mw);\r\nreturn nsegs;\r\nout_err:\r\ndprintk("RPC: %s: ib_unmap_fmr status %i\n", __func__, rc);\r\nreturn nsegs;\r\n}\r\nstatic void\r\nfmr_op_destroy(struct rpcrdma_buffer *buf)\r\n{\r\nstruct rpcrdma_mw *r;\r\nint rc;\r\nwhile (!list_empty(&buf->rb_all)) {\r\nr = list_entry(buf->rb_all.next, struct rpcrdma_mw, mw_all);\r\nlist_del(&r->mw_all);\r\nkfree(r->r.fmr.physaddrs);\r\nrc = ib_dealloc_fmr(r->r.fmr.fmr);\r\nif (rc)\r\ndprintk("RPC: %s: ib_dealloc_fmr failed %i\n",\r\n__func__, rc);\r\nkfree(r);\r\n}\r\n}

static void\r\nnvkm_i2c_pad_mode_locked(struct nvkm_i2c_pad *pad, enum nvkm_i2c_pad_mode mode)\r\n{\r\nPAD_TRACE(pad, "-> %s", (mode == NVKM_I2C_PAD_AUX) ? "aux" :\r\n(mode == NVKM_I2C_PAD_I2C) ? "i2c" : "off");\r\nif (pad->func->mode)\r\npad->func->mode(pad, mode);\r\n}\r\nvoid\r\nnvkm_i2c_pad_mode(struct nvkm_i2c_pad *pad, enum nvkm_i2c_pad_mode mode)\r\n{\r\nPAD_TRACE(pad, "mode %d", mode);\r\nmutex_lock(&pad->mutex);\r\nnvkm_i2c_pad_mode_locked(pad, mode);\r\npad->mode = mode;\r\nmutex_unlock(&pad->mutex);\r\n}\r\nvoid\r\nnvkm_i2c_pad_release(struct nvkm_i2c_pad *pad)\r\n{\r\nPAD_TRACE(pad, "release");\r\nif (pad->mode == NVKM_I2C_PAD_OFF)\r\nnvkm_i2c_pad_mode_locked(pad, pad->mode);\r\nmutex_unlock(&pad->mutex);\r\n}\r\nint\r\nnvkm_i2c_pad_acquire(struct nvkm_i2c_pad *pad, enum nvkm_i2c_pad_mode mode)\r\n{\r\nPAD_TRACE(pad, "acquire");\r\nmutex_lock(&pad->mutex);\r\nif (pad->mode != mode) {\r\nif (pad->mode != NVKM_I2C_PAD_OFF) {\r\nmutex_unlock(&pad->mutex);\r\nreturn -EBUSY;\r\n}\r\nnvkm_i2c_pad_mode_locked(pad, mode);\r\n}\r\nreturn 0;\r\n}\r\nvoid\r\nnvkm_i2c_pad_fini(struct nvkm_i2c_pad *pad)\r\n{\r\nPAD_TRACE(pad, "fini");\r\nnvkm_i2c_pad_mode_locked(pad, NVKM_I2C_PAD_OFF);\r\n}\r\nvoid\r\nnvkm_i2c_pad_init(struct nvkm_i2c_pad *pad)\r\n{\r\nPAD_TRACE(pad, "init");\r\nnvkm_i2c_pad_mode_locked(pad, pad->mode);\r\n}\r\nvoid\r\nnvkm_i2c_pad_del(struct nvkm_i2c_pad **ppad)\r\n{\r\nstruct nvkm_i2c_pad *pad = *ppad;\r\nif (pad) {\r\nPAD_TRACE(pad, "dtor");\r\nlist_del(&pad->head);\r\nkfree(pad);\r\npad = NULL;\r\n}\r\n}\r\nvoid\r\nnvkm_i2c_pad_ctor(const struct nvkm_i2c_pad_func *func, struct nvkm_i2c *i2c,\r\nint id, struct nvkm_i2c_pad *pad)\r\n{\r\npad->func = func;\r\npad->i2c = i2c;\r\npad->id = id;\r\npad->mode = NVKM_I2C_PAD_OFF;\r\nmutex_init(&pad->mutex);\r\nlist_add_tail(&pad->head, &i2c->pad);\r\nPAD_TRACE(pad, "ctor");\r\n}\r\nint\r\nnvkm_i2c_pad_new_(const struct nvkm_i2c_pad_func *func, struct nvkm_i2c *i2c,\r\nint id, struct nvkm_i2c_pad **ppad)\r\n{\r\nif (!(*ppad = kzalloc(sizeof(**ppad), GFP_KERNEL)))\r\nreturn -ENOMEM;\r\nnvkm_i2c_pad_ctor(func, i2c, id, *ppad);\r\nreturn 0;\r\n}

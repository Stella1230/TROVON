static int xensyms_next_sym(struct xensyms *xs)\r\n{\r\nint ret;\r\nstruct xenpf_symdata *symdata = &xs->op.u.symdata;\r\nuint64_t symnum;\r\nmemset(xs->name, 0, xs->namelen);\r\nsymdata->namelen = xs->namelen;\r\nsymnum = symdata->symnum;\r\nret = HYPERVISOR_dom0_op(&xs->op);\r\nif (ret < 0)\r\nreturn ret;\r\nif (unlikely(symdata->namelen > xs->namelen)) {\r\nkfree(xs->name);\r\nxs->namelen = symdata->namelen;\r\nxs->name = kzalloc(xs->namelen, GFP_KERNEL);\r\nif (!xs->name)\r\nreturn -ENOMEM;\r\nset_xen_guest_handle(symdata->name, xs->name);\r\nsymdata->symnum--;\r\nret = HYPERVISOR_dom0_op(&xs->op);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nif (symdata->symnum == symnum)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic void *xensyms_start(struct seq_file *m, loff_t *pos)\r\n{\r\nstruct xensyms *xs = (struct xensyms *)m->private;\r\nxs->op.u.symdata.symnum = *pos;\r\nif (xensyms_next_sym(xs))\r\nreturn NULL;\r\nreturn m->private;\r\n}\r\nstatic void *xensyms_next(struct seq_file *m, void *p, loff_t *pos)\r\n{\r\nstruct xensyms *xs = (struct xensyms *)m->private;\r\nxs->op.u.symdata.symnum = ++(*pos);\r\nif (xensyms_next_sym(xs))\r\nreturn NULL;\r\nreturn p;\r\n}\r\nstatic int xensyms_show(struct seq_file *m, void *p)\r\n{\r\nstruct xensyms *xs = (struct xensyms *)m->private;\r\nstruct xenpf_symdata *symdata = &xs->op.u.symdata;\r\nseq_printf(m, "%016llx %c %s\n", symdata->address,\r\nsymdata->type, xs->name);\r\nreturn 0;\r\n}\r\nstatic void xensyms_stop(struct seq_file *m, void *p)\r\n{\r\n}\r\nstatic int xensyms_open(struct inode *inode, struct file *file)\r\n{\r\nstruct seq_file *m;\r\nstruct xensyms *xs;\r\nint ret;\r\nret = seq_open_private(file, &xensyms_seq_ops,\r\nsizeof(struct xensyms));\r\nif (ret)\r\nreturn ret;\r\nm = file->private_data;\r\nxs = (struct xensyms *)m->private;\r\nxs->namelen = XEN_KSYM_NAME_LEN + 1;\r\nxs->name = kzalloc(xs->namelen, GFP_KERNEL);\r\nif (!xs->name) {\r\nseq_release_private(inode, file);\r\nreturn -ENOMEM;\r\n}\r\nset_xen_guest_handle(xs->op.u.symdata.name, xs->name);\r\nxs->op.cmd = XENPF_get_symbol;\r\nxs->op.u.symdata.namelen = xs->namelen;\r\nreturn 0;\r\n}\r\nstatic int xensyms_release(struct inode *inode, struct file *file)\r\n{\r\nstruct seq_file *m = file->private_data;\r\nstruct xensyms *xs = (struct xensyms *)m->private;\r\nkfree(xs->name);\r\nreturn seq_release_private(inode, file);\r\n}

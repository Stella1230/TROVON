static ssize_t fault_inject_read(struct file *file, char __user *buf,\r\nsize_t len, loff_t *ppos)\r\n{\r\nstatic u64 val;\r\nchar read_buf[25];\r\nsize_t size;\r\nloff_t pos = *ppos;\r\nstruct nfsd_fault_inject_op *op = file_inode(file)->i_private;\r\nif (!pos)\r\nval = op->get();\r\nsize = scnprintf(read_buf, sizeof(read_buf), "%llu\n", val);\r\nreturn simple_read_from_buffer(buf, len, ppos, read_buf, size);\r\n}\r\nstatic ssize_t fault_inject_write(struct file *file, const char __user *buf,\r\nsize_t len, loff_t *ppos)\r\n{\r\nchar write_buf[INET6_ADDRSTRLEN];\r\nsize_t size = min(sizeof(write_buf) - 1, len);\r\nstruct net *net = current->nsproxy->net_ns;\r\nstruct sockaddr_storage sa;\r\nstruct nfsd_fault_inject_op *op = file_inode(file)->i_private;\r\nu64 val;\r\nchar *nl;\r\nif (copy_from_user(write_buf, buf, size))\r\nreturn -EFAULT;\r\nwrite_buf[size] = '\0';\r\nnl = strchr(write_buf, '\n');\r\nif (nl) {\r\nsize = nl - write_buf;\r\n*nl = '\0';\r\n}\r\nsize = rpc_pton(net, write_buf, size, (struct sockaddr *)&sa, sizeof(sa));\r\nif (size > 0) {\r\nval = op->set_clnt(&sa, size);\r\nif (val)\r\npr_info("NFSD [%s]: Client %s had %llu state object(s)\n",\r\nop->file, write_buf, val);\r\n} else {\r\nval = simple_strtoll(write_buf, NULL, 0);\r\nif (val == 0)\r\npr_info("NFSD Fault Injection: %s (all)", op->file);\r\nelse\r\npr_info("NFSD Fault Injection: %s (n = %llu)",\r\nop->file, val);\r\nval = op->set_val(val);\r\npr_info("NFSD: %s: found %llu", op->file, val);\r\n}\r\nreturn len;\r\n}\r\nvoid nfsd_fault_inject_cleanup(void)\r\n{\r\ndebugfs_remove_recursive(debug_dir);\r\n}\r\nint nfsd_fault_inject_init(void)\r\n{\r\nunsigned int i;\r\nstruct nfsd_fault_inject_op *op;\r\numode_t mode = S_IFREG | S_IRUSR | S_IWUSR;\r\ndebug_dir = debugfs_create_dir("nfsd", NULL);\r\nif (!debug_dir)\r\ngoto fail;\r\nfor (i = 0; i < NUM_INJECT_OPS; i++) {\r\nop = &inject_ops[i];\r\nif (!debugfs_create_file(op->file, mode, debug_dir, op, &fops_nfsd))\r\ngoto fail;\r\n}\r\nreturn 0;\r\nfail:\r\nnfsd_fault_inject_cleanup();\r\nreturn -ENOMEM;\r\n}

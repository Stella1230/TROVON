static int snd_cs5535audio_playback_open(struct snd_pcm_substream *substream)\r\n{\r\nint err;\r\nstruct cs5535audio *cs5535au = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nruntime->hw = snd_cs5535audio_playback;\r\nruntime->hw.rates = cs5535au->ac97->rates[AC97_RATES_FRONT_DAC];\r\nsnd_pcm_limit_hw_rates(runtime);\r\ncs5535au->playback_substream = substream;\r\nruntime->private_data = &(cs5535au->dmas[CS5535AUDIO_DMA_PLAYBACK]);\r\nif ((err = snd_pcm_hw_constraint_integer(runtime,\r\nSNDRV_PCM_HW_PARAM_PERIODS)) < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int snd_cs5535audio_playback_close(struct snd_pcm_substream *substream)\r\n{\r\nreturn 0;\r\n}\r\nstatic int cs5535audio_build_dma_packets(struct cs5535audio *cs5535au,\r\nstruct cs5535audio_dma *dma,\r\nstruct snd_pcm_substream *substream,\r\nunsigned int periods,\r\nunsigned int period_bytes)\r\n{\r\nunsigned int i;\r\nu32 addr, desc_addr, jmpprd_addr;\r\nstruct cs5535audio_dma_desc *lastdesc;\r\nif (periods > CS5535AUDIO_MAX_DESCRIPTORS)\r\nreturn -ENOMEM;\r\nif (dma->desc_buf.area == NULL) {\r\nif (snd_dma_alloc_pages(SNDRV_DMA_TYPE_DEV,\r\nsnd_dma_pci_data(cs5535au->pci),\r\nCS5535AUDIO_DESC_LIST_SIZE+1,\r\n&dma->desc_buf) < 0)\r\nreturn -ENOMEM;\r\ndma->period_bytes = dma->periods = 0;\r\n}\r\nif (dma->periods == periods && dma->period_bytes == period_bytes)\r\nreturn 0;\r\naddr = (u32) substream->runtime->dma_addr;\r\ndesc_addr = (u32) dma->desc_buf.addr;\r\nfor (i = 0; i < periods; i++) {\r\nstruct cs5535audio_dma_desc *desc =\r\n&((struct cs5535audio_dma_desc *) dma->desc_buf.area)[i];\r\ndesc->addr = cpu_to_le32(addr);\r\ndesc->size = cpu_to_le16(period_bytes);\r\ndesc->ctlreserved = cpu_to_le16(PRD_EOP);\r\ndesc_addr += sizeof(struct cs5535audio_dma_desc);\r\naddr += period_bytes;\r\n}\r\nlastdesc = &((struct cs5535audio_dma_desc *) dma->desc_buf.area)[periods];\r\nlastdesc->addr = cpu_to_le32((u32) dma->desc_buf.addr);\r\nlastdesc->size = 0;\r\nlastdesc->ctlreserved = cpu_to_le16(PRD_JMP);\r\njmpprd_addr = cpu_to_le32(lastdesc->addr +\r\n(sizeof(struct cs5535audio_dma_desc)*periods));\r\ndma->substream = substream;\r\ndma->period_bytes = period_bytes;\r\ndma->periods = periods;\r\nspin_lock_irq(&cs5535au->reg_lock);\r\ndma->ops->disable_dma(cs5535au);\r\ndma->ops->setup_prd(cs5535au, jmpprd_addr);\r\nspin_unlock_irq(&cs5535au->reg_lock);\r\nreturn 0;\r\n}\r\nstatic void cs5535audio_playback_enable_dma(struct cs5535audio *cs5535au)\r\n{\r\ncs_writeb(cs5535au, ACC_BM0_CMD, BM_CTL_EN);\r\n}\r\nstatic void cs5535audio_playback_disable_dma(struct cs5535audio *cs5535au)\r\n{\r\ncs_writeb(cs5535au, ACC_BM0_CMD, 0);\r\n}\r\nstatic void cs5535audio_playback_pause_dma(struct cs5535audio *cs5535au)\r\n{\r\ncs_writeb(cs5535au, ACC_BM0_CMD, BM_CTL_PAUSE);\r\n}\r\nstatic void cs5535audio_playback_setup_prd(struct cs5535audio *cs5535au,\r\nu32 prd_addr)\r\n{\r\ncs_writel(cs5535au, ACC_BM0_PRD, prd_addr);\r\n}\r\nstatic u32 cs5535audio_playback_read_prd(struct cs5535audio *cs5535au)\r\n{\r\nreturn cs_readl(cs5535au, ACC_BM0_PRD);\r\n}\r\nstatic u32 cs5535audio_playback_read_dma_pntr(struct cs5535audio *cs5535au)\r\n{\r\nreturn cs_readl(cs5535au, ACC_BM0_PNTR);\r\n}\r\nstatic void cs5535audio_capture_enable_dma(struct cs5535audio *cs5535au)\r\n{\r\ncs_writeb(cs5535au, ACC_BM1_CMD, BM_CTL_EN);\r\n}\r\nstatic void cs5535audio_capture_disable_dma(struct cs5535audio *cs5535au)\r\n{\r\ncs_writeb(cs5535au, ACC_BM1_CMD, 0);\r\n}\r\nstatic void cs5535audio_capture_pause_dma(struct cs5535audio *cs5535au)\r\n{\r\ncs_writeb(cs5535au, ACC_BM1_CMD, BM_CTL_PAUSE);\r\n}\r\nstatic void cs5535audio_capture_setup_prd(struct cs5535audio *cs5535au,\r\nu32 prd_addr)\r\n{\r\ncs_writel(cs5535au, ACC_BM1_PRD, prd_addr);\r\n}\r\nstatic u32 cs5535audio_capture_read_prd(struct cs5535audio *cs5535au)\r\n{\r\nreturn cs_readl(cs5535au, ACC_BM1_PRD);\r\n}\r\nstatic u32 cs5535audio_capture_read_dma_pntr(struct cs5535audio *cs5535au)\r\n{\r\nreturn cs_readl(cs5535au, ACC_BM1_PNTR);\r\n}\r\nstatic void cs5535audio_clear_dma_packets(struct cs5535audio *cs5535au,\r\nstruct cs5535audio_dma *dma,\r\nstruct snd_pcm_substream *substream)\r\n{\r\nsnd_dma_free_pages(&dma->desc_buf);\r\ndma->desc_buf.area = NULL;\r\ndma->substream = NULL;\r\n}\r\nstatic int snd_cs5535audio_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *hw_params)\r\n{\r\nstruct cs5535audio *cs5535au = snd_pcm_substream_chip(substream);\r\nstruct cs5535audio_dma *dma = substream->runtime->private_data;\r\nint err;\r\nerr = snd_pcm_lib_malloc_pages(substream,\r\nparams_buffer_bytes(hw_params));\r\nif (err < 0)\r\nreturn err;\r\ndma->buf_addr = substream->runtime->dma_addr;\r\ndma->buf_bytes = params_buffer_bytes(hw_params);\r\nerr = cs5535audio_build_dma_packets(cs5535au, dma, substream,\r\nparams_periods(hw_params),\r\nparams_period_bytes(hw_params));\r\nif (!err)\r\ndma->pcm_open_flag = 1;\r\nreturn err;\r\n}\r\nstatic int snd_cs5535audio_hw_free(struct snd_pcm_substream *substream)\r\n{\r\nstruct cs5535audio *cs5535au = snd_pcm_substream_chip(substream);\r\nstruct cs5535audio_dma *dma = substream->runtime->private_data;\r\nif (dma->pcm_open_flag) {\r\nif (substream == cs5535au->playback_substream)\r\nsnd_ac97_update_power(cs5535au->ac97,\r\nAC97_PCM_FRONT_DAC_RATE, 0);\r\nelse\r\nsnd_ac97_update_power(cs5535au->ac97,\r\nAC97_PCM_LR_ADC_RATE, 0);\r\ndma->pcm_open_flag = 0;\r\n}\r\ncs5535audio_clear_dma_packets(cs5535au, dma, substream);\r\nreturn snd_pcm_lib_free_pages(substream);\r\n}\r\nstatic int snd_cs5535audio_playback_prepare(struct snd_pcm_substream *substream)\r\n{\r\nstruct cs5535audio *cs5535au = snd_pcm_substream_chip(substream);\r\nreturn snd_ac97_set_rate(cs5535au->ac97, AC97_PCM_FRONT_DAC_RATE,\r\nsubstream->runtime->rate);\r\n}\r\nstatic int snd_cs5535audio_trigger(struct snd_pcm_substream *substream, int cmd)\r\n{\r\nstruct cs5535audio *cs5535au = snd_pcm_substream_chip(substream);\r\nstruct cs5535audio_dma *dma = substream->runtime->private_data;\r\nint err = 0;\r\nspin_lock(&cs5535au->reg_lock);\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\r\ndma->ops->pause_dma(cs5535au);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\r\ndma->ops->enable_dma(cs5535au);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_START:\r\ndma->ops->enable_dma(cs5535au);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\ndma->ops->enable_dma(cs5535au);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ndma->ops->disable_dma(cs5535au);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\ndma->ops->disable_dma(cs5535au);\r\nbreak;\r\ndefault:\r\ndev_err(cs5535au->card->dev, "unhandled trigger\n");\r\nerr = -EINVAL;\r\nbreak;\r\n}\r\nspin_unlock(&cs5535au->reg_lock);\r\nreturn err;\r\n}\r\nstatic snd_pcm_uframes_t snd_cs5535audio_pcm_pointer(struct snd_pcm_substream\r\n*substream)\r\n{\r\nstruct cs5535audio *cs5535au = snd_pcm_substream_chip(substream);\r\nu32 curdma;\r\nstruct cs5535audio_dma *dma;\r\ndma = substream->runtime->private_data;\r\ncurdma = dma->ops->read_dma_pntr(cs5535au);\r\nif (curdma < dma->buf_addr) {\r\ndev_err(cs5535au->card->dev, "curdma=%x < %x bufaddr.\n",\r\ncurdma, dma->buf_addr);\r\nreturn 0;\r\n}\r\ncurdma -= dma->buf_addr;\r\nif (curdma >= dma->buf_bytes) {\r\ndev_err(cs5535au->card->dev, "diff=%x >= %x buf_bytes.\n",\r\ncurdma, dma->buf_bytes);\r\nreturn 0;\r\n}\r\nreturn bytes_to_frames(substream->runtime, curdma);\r\n}\r\nstatic int snd_cs5535audio_capture_open(struct snd_pcm_substream *substream)\r\n{\r\nint err;\r\nstruct cs5535audio *cs5535au = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nruntime->hw = snd_cs5535audio_capture;\r\nruntime->hw.rates = cs5535au->ac97->rates[AC97_RATES_ADC];\r\nsnd_pcm_limit_hw_rates(runtime);\r\ncs5535au->capture_substream = substream;\r\nruntime->private_data = &(cs5535au->dmas[CS5535AUDIO_DMA_CAPTURE]);\r\nif ((err = snd_pcm_hw_constraint_integer(runtime,\r\nSNDRV_PCM_HW_PARAM_PERIODS)) < 0)\r\nreturn err;\r\nolpc_capture_open(cs5535au->ac97);\r\nreturn 0;\r\n}\r\nstatic int snd_cs5535audio_capture_close(struct snd_pcm_substream *substream)\r\n{\r\nstruct cs5535audio *cs5535au = snd_pcm_substream_chip(substream);\r\nolpc_capture_close(cs5535au->ac97);\r\nreturn 0;\r\n}\r\nstatic int snd_cs5535audio_capture_prepare(struct snd_pcm_substream *substream)\r\n{\r\nstruct cs5535audio *cs5535au = snd_pcm_substream_chip(substream);\r\nreturn snd_ac97_set_rate(cs5535au->ac97, AC97_PCM_LR_ADC_RATE,\r\nsubstream->runtime->rate);\r\n}\r\nint snd_cs5535audio_pcm(struct cs5535audio *cs5535au)\r\n{\r\nstruct snd_pcm *pcm;\r\nint err;\r\nerr = snd_pcm_new(cs5535au->card, "CS5535 Audio", 0, 1, 1, &pcm);\r\nif (err < 0)\r\nreturn err;\r\ncs5535au->dmas[CS5535AUDIO_DMA_PLAYBACK].ops =\r\n&snd_cs5535audio_playback_dma_ops;\r\ncs5535au->dmas[CS5535AUDIO_DMA_CAPTURE].ops =\r\n&snd_cs5535audio_capture_dma_ops;\r\nsnd_pcm_set_ops(pcm, SNDRV_PCM_STREAM_PLAYBACK,\r\n&snd_cs5535audio_playback_ops);\r\nsnd_pcm_set_ops(pcm, SNDRV_PCM_STREAM_CAPTURE,\r\n&snd_cs5535audio_capture_ops);\r\npcm->private_data = cs5535au;\r\npcm->info_flags = 0;\r\nstrcpy(pcm->name, "CS5535 Audio");\r\nsnd_pcm_lib_preallocate_pages_for_all(pcm, SNDRV_DMA_TYPE_DEV,\r\nsnd_dma_pci_data(cs5535au->pci),\r\n64*1024, 128*1024);\r\ncs5535au->pcm = pcm;\r\nreturn 0;\r\n}

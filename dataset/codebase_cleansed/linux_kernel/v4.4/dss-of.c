struct device_node *\r\nomapdss_of_get_next_port(const struct device_node *parent,\r\nstruct device_node *prev)\r\n{\r\nstruct device_node *port = NULL;\r\nif (!parent)\r\nreturn NULL;\r\nif (!prev) {\r\nstruct device_node *ports;\r\nports = of_get_child_by_name(parent, "ports");\r\nif (ports)\r\nparent = ports;\r\nport = of_get_child_by_name(parent, "port");\r\nof_node_put(ports);\r\n} else {\r\nstruct device_node *ports;\r\nports = of_get_parent(prev);\r\nif (!ports)\r\nreturn NULL;\r\ndo {\r\nport = of_get_next_child(ports, prev);\r\nif (!port) {\r\nof_node_put(ports);\r\nreturn NULL;\r\n}\r\nprev = port;\r\n} while (of_node_cmp(port->name, "port") != 0);\r\nof_node_put(ports);\r\n}\r\nreturn port;\r\n}\r\nstruct device_node *\r\nomapdss_of_get_next_endpoint(const struct device_node *parent,\r\nstruct device_node *prev)\r\n{\r\nstruct device_node *ep = NULL;\r\nif (!parent)\r\nreturn NULL;\r\ndo {\r\nep = of_get_next_child(parent, prev);\r\nif (!ep)\r\nreturn NULL;\r\nprev = ep;\r\n} while (of_node_cmp(ep->name, "endpoint") != 0);\r\nreturn ep;\r\n}\r\nstruct device_node *dss_of_port_get_parent_device(struct device_node *port)\r\n{\r\nstruct device_node *np;\r\nint i;\r\nif (!port)\r\nreturn NULL;\r\nnp = of_get_parent(port);\r\nfor (i = 0; i < 2 && np; ++i) {\r\nstruct property *prop;\r\nprop = of_find_property(np, "compatible", NULL);\r\nif (prop)\r\nreturn np;\r\nnp = of_get_next_parent(np);\r\n}\r\nreturn NULL;\r\n}\r\nu32 dss_of_port_get_port_number(struct device_node *port)\r\n{\r\nint r;\r\nu32 reg;\r\nr = of_property_read_u32(port, "reg", &reg);\r\nif (r)\r\nreg = 0;\r\nreturn reg;\r\n}\r\nstatic struct device_node *omapdss_of_get_remote_port(const struct device_node *node)\r\n{\r\nstruct device_node *np;\r\nnp = of_parse_phandle(node, "remote-endpoint", 0);\r\nif (!np)\r\nreturn NULL;\r\nnp = of_get_next_parent(np);\r\nreturn np;\r\n}\r\nstruct device_node *\r\nomapdss_of_get_first_endpoint(const struct device_node *parent)\r\n{\r\nstruct device_node *port, *ep;\r\nport = omapdss_of_get_next_port(parent, NULL);\r\nif (!port)\r\nreturn NULL;\r\nep = omapdss_of_get_next_endpoint(port, NULL);\r\nof_node_put(port);\r\nreturn ep;\r\n}\r\nstruct omap_dss_device *\r\nomapdss_of_find_source_for_first_ep(struct device_node *node)\r\n{\r\nstruct device_node *ep;\r\nstruct device_node *src_port;\r\nstruct omap_dss_device *src;\r\nep = omapdss_of_get_first_endpoint(node);\r\nif (!ep)\r\nreturn ERR_PTR(-EINVAL);\r\nsrc_port = omapdss_of_get_remote_port(ep);\r\nif (!src_port) {\r\nof_node_put(ep);\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nof_node_put(ep);\r\nsrc = omap_dss_find_output_by_port_node(src_port);\r\nof_node_put(src_port);\r\nreturn src ? src : ERR_PTR(-EPROBE_DEFER);\r\n}

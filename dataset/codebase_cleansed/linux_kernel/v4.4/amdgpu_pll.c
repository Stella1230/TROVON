static void amdgpu_pll_reduce_ratio(unsigned *nom, unsigned *den,\r\nunsigned nom_min, unsigned den_min)\r\n{\r\nunsigned tmp;\r\ntmp = gcd(*nom, *den);\r\n*nom /= tmp;\r\n*den /= tmp;\r\nif (*nom < nom_min) {\r\ntmp = DIV_ROUND_UP(nom_min, *nom);\r\n*nom *= tmp;\r\n*den *= tmp;\r\n}\r\nif (*den < den_min) {\r\ntmp = DIV_ROUND_UP(den_min, *den);\r\n*nom *= tmp;\r\n*den *= tmp;\r\n}\r\n}\r\nstatic void amdgpu_pll_get_fb_ref_div(unsigned nom, unsigned den, unsigned post_div,\r\nunsigned fb_div_max, unsigned ref_div_max,\r\nunsigned *fb_div, unsigned *ref_div)\r\n{\r\nref_div_max = min(128 / post_div, ref_div_max);\r\n*ref_div = min(max(DIV_ROUND_CLOSEST(den, post_div), 1u), ref_div_max);\r\n*fb_div = DIV_ROUND_CLOSEST(nom * *ref_div * post_div, den);\r\nif (*fb_div > fb_div_max) {\r\n*ref_div = DIV_ROUND_CLOSEST(*ref_div * fb_div_max, *fb_div);\r\n*fb_div = fb_div_max;\r\n}\r\n}\r\nvoid amdgpu_pll_compute(struct amdgpu_pll *pll,\r\nu32 freq,\r\nu32 *dot_clock_p,\r\nu32 *fb_div_p,\r\nu32 *frac_fb_div_p,\r\nu32 *ref_div_p,\r\nu32 *post_div_p)\r\n{\r\nunsigned target_clock = pll->flags & AMDGPU_PLL_USE_FRAC_FB_DIV ?\r\nfreq : freq / 10;\r\nunsigned fb_div_min, fb_div_max, fb_div;\r\nunsigned post_div_min, post_div_max, post_div;\r\nunsigned ref_div_min, ref_div_max, ref_div;\r\nunsigned post_div_best, diff_best;\r\nunsigned nom, den;\r\nfb_div_min = pll->min_feedback_div;\r\nfb_div_max = pll->max_feedback_div;\r\nif (pll->flags & AMDGPU_PLL_USE_FRAC_FB_DIV) {\r\nfb_div_min *= 10;\r\nfb_div_max *= 10;\r\n}\r\nif (pll->flags & AMDGPU_PLL_USE_REF_DIV)\r\nref_div_min = pll->reference_div;\r\nelse\r\nref_div_min = pll->min_ref_div;\r\nif (pll->flags & AMDGPU_PLL_USE_FRAC_FB_DIV &&\r\npll->flags & AMDGPU_PLL_USE_REF_DIV)\r\nref_div_max = pll->reference_div;\r\nelse\r\nref_div_max = pll->max_ref_div;\r\nif (pll->flags & AMDGPU_PLL_USE_POST_DIV) {\r\npost_div_min = pll->post_div;\r\npost_div_max = pll->post_div;\r\n} else {\r\nunsigned vco_min, vco_max;\r\nif (pll->flags & AMDGPU_PLL_IS_LCD) {\r\nvco_min = pll->lcd_pll_out_min;\r\nvco_max = pll->lcd_pll_out_max;\r\n} else {\r\nvco_min = pll->pll_out_min;\r\nvco_max = pll->pll_out_max;\r\n}\r\nif (pll->flags & AMDGPU_PLL_USE_FRAC_FB_DIV) {\r\nvco_min *= 10;\r\nvco_max *= 10;\r\n}\r\npost_div_min = vco_min / target_clock;\r\nif ((target_clock * post_div_min) < vco_min)\r\n++post_div_min;\r\nif (post_div_min < pll->min_post_div)\r\npost_div_min = pll->min_post_div;\r\npost_div_max = vco_max / target_clock;\r\nif ((target_clock * post_div_max) > vco_max)\r\n--post_div_max;\r\nif (post_div_max > pll->max_post_div)\r\npost_div_max = pll->max_post_div;\r\n}\r\nnom = target_clock;\r\nden = pll->reference_freq;\r\namdgpu_pll_reduce_ratio(&nom, &den, fb_div_min, post_div_min);\r\nif (pll->flags & AMDGPU_PLL_PREFER_MINM_OVER_MAXP)\r\npost_div_best = post_div_min;\r\nelse\r\npost_div_best = post_div_max;\r\ndiff_best = ~0;\r\nfor (post_div = post_div_min; post_div <= post_div_max; ++post_div) {\r\nunsigned diff;\r\namdgpu_pll_get_fb_ref_div(nom, den, post_div, fb_div_max,\r\nref_div_max, &fb_div, &ref_div);\r\ndiff = abs(target_clock - (pll->reference_freq * fb_div) /\r\n(ref_div * post_div));\r\nif (diff < diff_best || (diff == diff_best &&\r\n!(pll->flags & AMDGPU_PLL_PREFER_MINM_OVER_MAXP))) {\r\npost_div_best = post_div;\r\ndiff_best = diff;\r\n}\r\n}\r\npost_div = post_div_best;\r\namdgpu_pll_get_fb_ref_div(nom, den, post_div, fb_div_max, ref_div_max,\r\n&fb_div, &ref_div);\r\namdgpu_pll_reduce_ratio(&fb_div, &ref_div, fb_div_min, ref_div_min);\r\nif (pll->flags & AMDGPU_PLL_USE_FRAC_FB_DIV && (fb_div % 10)) {\r\nfb_div_min = max(fb_div_min, (9 - (fb_div % 10)) * 20 + 60);\r\nif (fb_div < fb_div_min) {\r\nunsigned tmp = DIV_ROUND_UP(fb_div_min, fb_div);\r\nfb_div *= tmp;\r\nref_div *= tmp;\r\n}\r\n}\r\nif (pll->flags & AMDGPU_PLL_USE_FRAC_FB_DIV) {\r\n*fb_div_p = fb_div / 10;\r\n*frac_fb_div_p = fb_div % 10;\r\n} else {\r\n*fb_div_p = fb_div;\r\n*frac_fb_div_p = 0;\r\n}\r\n*dot_clock_p = ((pll->reference_freq * *fb_div_p * 10) +\r\n(pll->reference_freq * *frac_fb_div_p)) /\r\n(ref_div * post_div * 10);\r\n*ref_div_p = ref_div;\r\n*post_div_p = post_div;\r\nDRM_DEBUG_KMS("%d - %d, pll dividers - fb: %d.%d ref: %d, post %d\n",\r\nfreq, *dot_clock_p * 10, *fb_div_p, *frac_fb_div_p,\r\nref_div, post_div);\r\n}\r\nu32 amdgpu_pll_get_use_mask(struct drm_crtc *crtc)\r\n{\r\nstruct drm_device *dev = crtc->dev;\r\nstruct drm_crtc *test_crtc;\r\nstruct amdgpu_crtc *test_amdgpu_crtc;\r\nu32 pll_in_use = 0;\r\nlist_for_each_entry(test_crtc, &dev->mode_config.crtc_list, head) {\r\nif (crtc == test_crtc)\r\ncontinue;\r\ntest_amdgpu_crtc = to_amdgpu_crtc(test_crtc);\r\nif (test_amdgpu_crtc->pll_id != ATOM_PPLL_INVALID)\r\npll_in_use |= (1 << test_amdgpu_crtc->pll_id);\r\n}\r\nreturn pll_in_use;\r\n}\r\nint amdgpu_pll_get_shared_dp_ppll(struct drm_crtc *crtc)\r\n{\r\nstruct drm_device *dev = crtc->dev;\r\nstruct drm_crtc *test_crtc;\r\nstruct amdgpu_crtc *test_amdgpu_crtc;\r\nlist_for_each_entry(test_crtc, &dev->mode_config.crtc_list, head) {\r\nif (crtc == test_crtc)\r\ncontinue;\r\ntest_amdgpu_crtc = to_amdgpu_crtc(test_crtc);\r\nif (test_amdgpu_crtc->encoder &&\r\nENCODER_MODE_IS_DP(amdgpu_atombios_encoder_get_encoder_mode(test_amdgpu_crtc->encoder))) {\r\nif (test_amdgpu_crtc->pll_id != ATOM_PPLL_INVALID)\r\nreturn test_amdgpu_crtc->pll_id;\r\n}\r\n}\r\nreturn ATOM_PPLL_INVALID;\r\n}\r\nint amdgpu_pll_get_shared_nondp_ppll(struct drm_crtc *crtc)\r\n{\r\nstruct amdgpu_crtc *amdgpu_crtc = to_amdgpu_crtc(crtc);\r\nstruct drm_device *dev = crtc->dev;\r\nstruct drm_crtc *test_crtc;\r\nstruct amdgpu_crtc *test_amdgpu_crtc;\r\nu32 adjusted_clock, test_adjusted_clock;\r\nadjusted_clock = amdgpu_crtc->adjusted_clock;\r\nif (adjusted_clock == 0)\r\nreturn ATOM_PPLL_INVALID;\r\nlist_for_each_entry(test_crtc, &dev->mode_config.crtc_list, head) {\r\nif (crtc == test_crtc)\r\ncontinue;\r\ntest_amdgpu_crtc = to_amdgpu_crtc(test_crtc);\r\nif (test_amdgpu_crtc->encoder &&\r\n!ENCODER_MODE_IS_DP(amdgpu_atombios_encoder_get_encoder_mode(test_amdgpu_crtc->encoder))) {\r\nif (test_amdgpu_crtc->connector == amdgpu_crtc->connector) {\r\nif (test_amdgpu_crtc->pll_id != ATOM_PPLL_INVALID)\r\nreturn test_amdgpu_crtc->pll_id;\r\n}\r\ntest_adjusted_clock = test_amdgpu_crtc->adjusted_clock;\r\nif ((crtc->mode.clock == test_crtc->mode.clock) &&\r\n(adjusted_clock == test_adjusted_clock) &&\r\n(amdgpu_crtc->ss_enabled == test_amdgpu_crtc->ss_enabled) &&\r\n(test_amdgpu_crtc->pll_id != ATOM_PPLL_INVALID))\r\nreturn test_amdgpu_crtc->pll_id;\r\n}\r\n}\r\nreturn ATOM_PPLL_INVALID;\r\n}

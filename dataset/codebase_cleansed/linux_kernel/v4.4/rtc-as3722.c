static void as3722_time_to_reg(u8 *rbuff, struct rtc_time *tm)\r\n{\r\nrbuff[0] = bin2bcd(tm->tm_sec);\r\nrbuff[1] = bin2bcd(tm->tm_min);\r\nrbuff[2] = bin2bcd(tm->tm_hour);\r\nrbuff[3] = bin2bcd(tm->tm_mday);\r\nrbuff[4] = bin2bcd(tm->tm_mon + 1);\r\nrbuff[5] = bin2bcd(tm->tm_year - (AS3722_RTC_START_YEAR - 1900));\r\n}\r\nstatic void as3722_reg_to_time(u8 *rbuff, struct rtc_time *tm)\r\n{\r\ntm->tm_sec = bcd2bin(rbuff[0] & 0x7F);\r\ntm->tm_min = bcd2bin(rbuff[1] & 0x7F);\r\ntm->tm_hour = bcd2bin(rbuff[2] & 0x3F);\r\ntm->tm_mday = bcd2bin(rbuff[3] & 0x3F);\r\ntm->tm_mon = bcd2bin(rbuff[4] & 0x1F) - 1;\r\ntm->tm_year = (AS3722_RTC_START_YEAR - 1900) + bcd2bin(rbuff[5] & 0x7F);\r\nreturn;\r\n}\r\nstatic int as3722_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct as3722_rtc *as3722_rtc = dev_get_drvdata(dev);\r\nstruct as3722 *as3722 = as3722_rtc->as3722;\r\nu8 as_time_array[6];\r\nint ret;\r\nret = as3722_block_read(as3722, AS3722_RTC_SECOND_REG,\r\n6, as_time_array);\r\nif (ret < 0) {\r\ndev_err(dev, "RTC_SECOND reg block read failed %d\n", ret);\r\nreturn ret;\r\n}\r\nas3722_reg_to_time(as_time_array, tm);\r\nreturn 0;\r\n}\r\nstatic int as3722_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct as3722_rtc *as3722_rtc = dev_get_drvdata(dev);\r\nstruct as3722 *as3722 = as3722_rtc->as3722;\r\nu8 as_time_array[6];\r\nint ret;\r\nif (tm->tm_year < (AS3722_RTC_START_YEAR - 1900))\r\nreturn -EINVAL;\r\nas3722_time_to_reg(as_time_array, tm);\r\nret = as3722_block_write(as3722, AS3722_RTC_SECOND_REG, 6,\r\nas_time_array);\r\nif (ret < 0)\r\ndev_err(dev, "RTC_SECOND reg block write failed %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int as3722_rtc_alarm_irq_enable(struct device *dev,\r\nunsigned int enabled)\r\n{\r\nstruct as3722_rtc *as3722_rtc = dev_get_drvdata(dev);\r\nif (enabled && !as3722_rtc->irq_enable) {\r\nenable_irq(as3722_rtc->alarm_irq);\r\nas3722_rtc->irq_enable = true;\r\n} else if (!enabled && as3722_rtc->irq_enable) {\r\ndisable_irq(as3722_rtc->alarm_irq);\r\nas3722_rtc->irq_enable = false;\r\n}\r\nreturn 0;\r\n}\r\nstatic int as3722_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct as3722_rtc *as3722_rtc = dev_get_drvdata(dev);\r\nstruct as3722 *as3722 = as3722_rtc->as3722;\r\nu8 as_time_array[6];\r\nint ret;\r\nret = as3722_block_read(as3722, AS3722_RTC_ALARM_SECOND_REG, 6,\r\nas_time_array);\r\nif (ret < 0) {\r\ndev_err(dev, "RTC_ALARM_SECOND block read failed %d\n", ret);\r\nreturn ret;\r\n}\r\nas3722_reg_to_time(as_time_array, &alrm->time);\r\nreturn 0;\r\n}\r\nstatic int as3722_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct as3722_rtc *as3722_rtc = dev_get_drvdata(dev);\r\nstruct as3722 *as3722 = as3722_rtc->as3722;\r\nu8 as_time_array[6];\r\nint ret;\r\nif (alrm->time.tm_year < (AS3722_RTC_START_YEAR - 1900))\r\nreturn -EINVAL;\r\nret = as3722_rtc_alarm_irq_enable(dev, 0);\r\nif (ret < 0) {\r\ndev_err(dev, "Disable RTC alarm failed\n");\r\nreturn ret;\r\n}\r\nas3722_time_to_reg(as_time_array, &alrm->time);\r\nret = as3722_block_write(as3722, AS3722_RTC_ALARM_SECOND_REG, 6,\r\nas_time_array);\r\nif (ret < 0) {\r\ndev_err(dev, "RTC_ALARM_SECOND block write failed %d\n", ret);\r\nreturn ret;\r\n}\r\nif (alrm->enabled)\r\nret = as3722_rtc_alarm_irq_enable(dev, alrm->enabled);\r\nreturn ret;\r\n}\r\nstatic irqreturn_t as3722_alarm_irq(int irq, void *data)\r\n{\r\nstruct as3722_rtc *as3722_rtc = data;\r\nrtc_update_irq(as3722_rtc->rtc, 1, RTC_IRQF | RTC_AF);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int as3722_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct as3722 *as3722 = dev_get_drvdata(pdev->dev.parent);\r\nstruct as3722_rtc *as3722_rtc;\r\nint ret;\r\nas3722_rtc = devm_kzalloc(&pdev->dev, sizeof(*as3722_rtc), GFP_KERNEL);\r\nif (!as3722_rtc)\r\nreturn -ENOMEM;\r\nas3722_rtc->as3722 = as3722;\r\nas3722_rtc->dev = &pdev->dev;\r\nplatform_set_drvdata(pdev, as3722_rtc);\r\nret = as3722_update_bits(as3722, AS3722_RTC_CONTROL_REG,\r\nAS3722_RTC_ON | AS3722_RTC_ALARM_WAKEUP_EN,\r\nAS3722_RTC_ON | AS3722_RTC_ALARM_WAKEUP_EN);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "RTC_CONTROL reg write failed: %d\n", ret);\r\nreturn ret;\r\n}\r\ndevice_init_wakeup(&pdev->dev, 1);\r\nas3722_rtc->rtc = devm_rtc_device_register(&pdev->dev, "as3722-rtc",\r\n&as3722_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(as3722_rtc->rtc)) {\r\nret = PTR_ERR(as3722_rtc->rtc);\r\ndev_err(&pdev->dev, "RTC register failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nas3722_rtc->alarm_irq = platform_get_irq(pdev, 0);\r\ndev_info(&pdev->dev, "RTC interrupt %d\n", as3722_rtc->alarm_irq);\r\nret = devm_request_threaded_irq(&pdev->dev, as3722_rtc->alarm_irq, NULL,\r\nas3722_alarm_irq, IRQF_ONESHOT | IRQF_EARLY_RESUME,\r\n"rtc-alarm", as3722_rtc);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Failed to request alarm IRQ %d: %d\n",\r\nas3722_rtc->alarm_irq, ret);\r\nreturn ret;\r\n}\r\ndisable_irq(as3722_rtc->alarm_irq);\r\nreturn 0;\r\n}\r\nstatic int as3722_rtc_suspend(struct device *dev)\r\n{\r\nstruct as3722_rtc *as3722_rtc = dev_get_drvdata(dev);\r\nif (device_may_wakeup(dev))\r\nenable_irq_wake(as3722_rtc->alarm_irq);\r\nreturn 0;\r\n}\r\nstatic int as3722_rtc_resume(struct device *dev)\r\n{\r\nstruct as3722_rtc *as3722_rtc = dev_get_drvdata(dev);\r\nif (device_may_wakeup(dev))\r\ndisable_irq_wake(as3722_rtc->alarm_irq);\r\nreturn 0;\r\n}

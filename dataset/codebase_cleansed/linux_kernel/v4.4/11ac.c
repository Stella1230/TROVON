static u16\r\nmwifiex_convert_mcsmap_to_maxrate(struct mwifiex_private *priv,\r\nu8 bands, u16 mcs_map)\r\n{\r\nu8 i, nss, mcs;\r\nu16 max_rate = 0;\r\nu32 usr_vht_cap_info = 0;\r\nstruct mwifiex_adapter *adapter = priv->adapter;\r\nif (bands & BAND_AAC)\r\nusr_vht_cap_info = adapter->usr_dot_11ac_dev_cap_a;\r\nelse\r\nusr_vht_cap_info = adapter->usr_dot_11ac_dev_cap_bg;\r\nnss = 1;\r\nfor (i = 1; i <= 8; i++) {\r\nmcs = GET_VHTNSSMCS(mcs_map, i);\r\nif (mcs < IEEE80211_VHT_MCS_NOT_SUPPORTED)\r\nnss = i;\r\n}\r\nmcs = GET_VHTNSSMCS(mcs_map, nss);\r\nif (mcs == IEEE80211_VHT_MCS_NOT_SUPPORTED)\r\nmcs = IEEE80211_VHT_MCS_SUPPORT_0_9;\r\nif (GET_VHTCAP_CHWDSET(usr_vht_cap_info)) {\r\nmax_rate = max_rate_lgi_160MHZ[nss - 1][mcs];\r\nif (!max_rate)\r\nmax_rate = max_rate_lgi_160MHZ[nss - 1][mcs - 1];\r\n} else {\r\nmax_rate = max_rate_lgi_80MHZ[nss - 1][mcs];\r\nif (!max_rate)\r\nmax_rate = max_rate_lgi_80MHZ[nss - 1][mcs - 1];\r\n}\r\nreturn max_rate;\r\n}\r\nstatic void\r\nmwifiex_fill_vht_cap_info(struct mwifiex_private *priv,\r\nstruct ieee80211_vht_cap *vht_cap, u8 bands)\r\n{\r\nstruct mwifiex_adapter *adapter = priv->adapter;\r\nif (bands & BAND_A)\r\nvht_cap->vht_cap_info =\r\ncpu_to_le32(adapter->usr_dot_11ac_dev_cap_a);\r\nelse\r\nvht_cap->vht_cap_info =\r\ncpu_to_le32(adapter->usr_dot_11ac_dev_cap_bg);\r\n}\r\nvoid mwifiex_fill_vht_cap_tlv(struct mwifiex_private *priv,\r\nstruct ieee80211_vht_cap *vht_cap, u8 bands)\r\n{\r\nstruct mwifiex_adapter *adapter = priv->adapter;\r\nu16 mcs_map_user, mcs_map_resp, mcs_map_result;\r\nu16 mcs_user, mcs_resp, nss, tmp;\r\nmwifiex_fill_vht_cap_info(priv, vht_cap, bands);\r\nmcs_map_user = GET_DEVRXMCSMAP(adapter->usr_dot_11ac_mcs_support);\r\nmcs_map_resp = le16_to_cpu(vht_cap->supp_mcs.rx_mcs_map);\r\nmcs_map_result = 0;\r\nfor (nss = 1; nss <= 8; nss++) {\r\nmcs_user = GET_VHTNSSMCS(mcs_map_user, nss);\r\nmcs_resp = GET_VHTNSSMCS(mcs_map_resp, nss);\r\nif ((mcs_user == IEEE80211_VHT_MCS_NOT_SUPPORTED) ||\r\n(mcs_resp == IEEE80211_VHT_MCS_NOT_SUPPORTED))\r\nSET_VHTNSSMCS(mcs_map_result, nss,\r\nIEEE80211_VHT_MCS_NOT_SUPPORTED);\r\nelse\r\nSET_VHTNSSMCS(mcs_map_result, nss,\r\nmin(mcs_user, mcs_resp));\r\n}\r\nvht_cap->supp_mcs.rx_mcs_map = cpu_to_le16(mcs_map_result);\r\ntmp = mwifiex_convert_mcsmap_to_maxrate(priv, bands, mcs_map_result);\r\nvht_cap->supp_mcs.rx_highest = cpu_to_le16(tmp);\r\nmcs_map_user = GET_DEVTXMCSMAP(adapter->usr_dot_11ac_mcs_support);\r\nmcs_map_resp = le16_to_cpu(vht_cap->supp_mcs.tx_mcs_map);\r\nmcs_map_result = 0;\r\nfor (nss = 1; nss <= 8; nss++) {\r\nmcs_user = GET_VHTNSSMCS(mcs_map_user, nss);\r\nmcs_resp = GET_VHTNSSMCS(mcs_map_resp, nss);\r\nif ((mcs_user == IEEE80211_VHT_MCS_NOT_SUPPORTED) ||\r\n(mcs_resp == IEEE80211_VHT_MCS_NOT_SUPPORTED))\r\nSET_VHTNSSMCS(mcs_map_result, nss,\r\nIEEE80211_VHT_MCS_NOT_SUPPORTED);\r\nelse\r\nSET_VHTNSSMCS(mcs_map_result, nss,\r\nmin(mcs_user, mcs_resp));\r\n}\r\nvht_cap->supp_mcs.tx_mcs_map = cpu_to_le16(mcs_map_result);\r\ntmp = mwifiex_convert_mcsmap_to_maxrate(priv, bands, mcs_map_result);\r\nvht_cap->supp_mcs.tx_highest = cpu_to_le16(tmp);\r\nreturn;\r\n}\r\nint mwifiex_cmd_append_11ac_tlv(struct mwifiex_private *priv,\r\nstruct mwifiex_bssdescriptor *bss_desc,\r\nu8 **buffer)\r\n{\r\nstruct mwifiex_ie_types_vhtcap *vht_cap;\r\nstruct mwifiex_ie_types_oper_mode_ntf *oper_ntf;\r\nstruct ieee_types_oper_mode_ntf *ieee_oper_ntf;\r\nstruct mwifiex_ie_types_vht_oper *vht_op;\r\nstruct mwifiex_adapter *adapter = priv->adapter;\r\nu8 supp_chwd_set;\r\nu32 usr_vht_cap_info;\r\nint ret_len = 0;\r\nif (bss_desc->bss_band & BAND_A)\r\nusr_vht_cap_info = adapter->usr_dot_11ac_dev_cap_a;\r\nelse\r\nusr_vht_cap_info = adapter->usr_dot_11ac_dev_cap_bg;\r\nif (bss_desc->bcn_vht_cap) {\r\nvht_cap = (struct mwifiex_ie_types_vhtcap *)*buffer;\r\nmemset(vht_cap, 0, sizeof(*vht_cap));\r\nvht_cap->header.type = cpu_to_le16(WLAN_EID_VHT_CAPABILITY);\r\nvht_cap->header.len =\r\ncpu_to_le16(sizeof(struct ieee80211_vht_cap));\r\nmemcpy((u8 *)vht_cap + sizeof(struct mwifiex_ie_types_header),\r\n(u8 *)bss_desc->bcn_vht_cap,\r\nle16_to_cpu(vht_cap->header.len));\r\nmwifiex_fill_vht_cap_tlv(priv, &vht_cap->vht_cap,\r\nbss_desc->bss_band);\r\n*buffer += sizeof(*vht_cap);\r\nret_len += sizeof(*vht_cap);\r\n}\r\nif (bss_desc->bcn_vht_oper) {\r\nif (priv->bss_mode == NL80211_IFTYPE_STATION) {\r\nvht_op = (struct mwifiex_ie_types_vht_oper *)*buffer;\r\nmemset(vht_op, 0, sizeof(*vht_op));\r\nvht_op->header.type =\r\ncpu_to_le16(WLAN_EID_VHT_OPERATION);\r\nvht_op->header.len = cpu_to_le16(sizeof(*vht_op) -\r\nsizeof(struct mwifiex_ie_types_header));\r\nmemcpy((u8 *)vht_op +\r\nsizeof(struct mwifiex_ie_types_header),\r\n(u8 *)bss_desc->bcn_vht_oper,\r\nle16_to_cpu(vht_op->header.len));\r\nsupp_chwd_set = GET_VHTCAP_CHWDSET(usr_vht_cap_info);\r\nswitch (supp_chwd_set) {\r\ncase 0:\r\nvht_op->chan_width =\r\nmin_t(u8, IEEE80211_VHT_CHANWIDTH_80MHZ,\r\nbss_desc->bcn_vht_oper->chan_width);\r\nbreak;\r\ncase 1:\r\nvht_op->chan_width =\r\nmin_t(u8, IEEE80211_VHT_CHANWIDTH_160MHZ,\r\nbss_desc->bcn_vht_oper->chan_width);\r\nbreak;\r\ncase 2:\r\nvht_op->chan_width =\r\nmin_t(u8, IEEE80211_VHT_CHANWIDTH_80P80MHZ,\r\nbss_desc->bcn_vht_oper->chan_width);\r\nbreak;\r\ndefault:\r\nvht_op->chan_width =\r\nIEEE80211_VHT_CHANWIDTH_USE_HT;\r\nbreak;\r\n}\r\n*buffer += sizeof(*vht_op);\r\nret_len += sizeof(*vht_op);\r\n}\r\n}\r\nif (bss_desc->oper_mode) {\r\nieee_oper_ntf = bss_desc->oper_mode;\r\noper_ntf = (void *)*buffer;\r\nmemset(oper_ntf, 0, sizeof(*oper_ntf));\r\noper_ntf->header.type = cpu_to_le16(WLAN_EID_OPMODE_NOTIF);\r\noper_ntf->header.len = cpu_to_le16(sizeof(u8));\r\noper_ntf->oper_mode = ieee_oper_ntf->oper_mode;\r\n*buffer += sizeof(*oper_ntf);\r\nret_len += sizeof(*oper_ntf);\r\n}\r\nreturn ret_len;\r\n}\r\nint mwifiex_cmd_11ac_cfg(struct mwifiex_private *priv,\r\nstruct host_cmd_ds_command *cmd, u16 cmd_action,\r\nstruct mwifiex_11ac_vht_cfg *cfg)\r\n{\r\nstruct host_cmd_11ac_vht_cfg *vhtcfg = &cmd->params.vht_cfg;\r\ncmd->command = cpu_to_le16(HostCmd_CMD_11AC_CFG);\r\ncmd->size = cpu_to_le16(sizeof(struct host_cmd_11ac_vht_cfg) +\r\nS_DS_GEN);\r\nvhtcfg->action = cpu_to_le16(cmd_action);\r\nvhtcfg->band_config = cfg->band_config;\r\nvhtcfg->misc_config = cfg->misc_config;\r\nvhtcfg->cap_info = cpu_to_le32(cfg->cap_info);\r\nvhtcfg->mcs_tx_set = cpu_to_le32(cfg->mcs_tx_set);\r\nvhtcfg->mcs_rx_set = cpu_to_le32(cfg->mcs_rx_set);\r\nreturn 0;\r\n}\r\nvoid mwifiex_set_11ac_ba_params(struct mwifiex_private *priv)\r\n{\r\npriv->add_ba_param.timeout = MWIFIEX_DEFAULT_BLOCK_ACK_TIMEOUT;\r\nif (GET_BSS_ROLE(priv) == MWIFIEX_BSS_ROLE_UAP) {\r\npriv->add_ba_param.tx_win_size =\r\nMWIFIEX_11AC_UAP_AMPDU_DEF_TXWINSIZE;\r\npriv->add_ba_param.rx_win_size =\r\nMWIFIEX_11AC_UAP_AMPDU_DEF_RXWINSIZE;\r\n} else {\r\npriv->add_ba_param.tx_win_size =\r\nMWIFIEX_11AC_STA_AMPDU_DEF_TXWINSIZE;\r\npriv->add_ba_param.rx_win_size =\r\nMWIFIEX_11AC_STA_AMPDU_DEF_RXWINSIZE;\r\n}\r\nreturn;\r\n}\r\nbool mwifiex_is_bss_in_11ac_mode(struct mwifiex_private *priv)\r\n{\r\nstruct mwifiex_bssdescriptor *bss_desc;\r\nstruct ieee80211_vht_operation *vht_oper;\r\nbss_desc = &priv->curr_bss_params.bss_descriptor;\r\nvht_oper = bss_desc->bcn_vht_oper;\r\nif (!bss_desc->bcn_vht_cap || !vht_oper)\r\nreturn false;\r\nif (vht_oper->chan_width == IEEE80211_VHT_CHANWIDTH_USE_HT)\r\nreturn false;\r\nreturn true;\r\n}\r\nu8 mwifiex_get_center_freq_index(struct mwifiex_private *priv, u8 band,\r\nu32 pri_chan, u8 chan_bw)\r\n{\r\nu8 center_freq_idx = 0;\r\nif (band & BAND_AAC) {\r\nswitch (pri_chan) {\r\ncase 36:\r\ncase 40:\r\ncase 44:\r\ncase 48:\r\nif (chan_bw == IEEE80211_VHT_CHANWIDTH_80MHZ)\r\ncenter_freq_idx = 42;\r\nbreak;\r\ncase 52:\r\ncase 56:\r\ncase 60:\r\ncase 64:\r\nif (chan_bw == IEEE80211_VHT_CHANWIDTH_80MHZ)\r\ncenter_freq_idx = 58;\r\nelse if (chan_bw == IEEE80211_VHT_CHANWIDTH_160MHZ)\r\ncenter_freq_idx = 50;\r\nbreak;\r\ncase 100:\r\ncase 104:\r\ncase 108:\r\ncase 112:\r\nif (chan_bw == IEEE80211_VHT_CHANWIDTH_80MHZ)\r\ncenter_freq_idx = 106;\r\nbreak;\r\ncase 116:\r\ncase 120:\r\ncase 124:\r\ncase 128:\r\nif (chan_bw == IEEE80211_VHT_CHANWIDTH_80MHZ)\r\ncenter_freq_idx = 122;\r\nelse if (chan_bw == IEEE80211_VHT_CHANWIDTH_160MHZ)\r\ncenter_freq_idx = 114;\r\nbreak;\r\ncase 132:\r\ncase 136:\r\ncase 140:\r\ncase 144:\r\nif (chan_bw == IEEE80211_VHT_CHANWIDTH_80MHZ)\r\ncenter_freq_idx = 138;\r\nbreak;\r\ncase 149:\r\ncase 153:\r\ncase 157:\r\ncase 161:\r\nif (chan_bw == IEEE80211_VHT_CHANWIDTH_80MHZ)\r\ncenter_freq_idx = 155;\r\nbreak;\r\ndefault:\r\ncenter_freq_idx = 42;\r\n}\r\n}\r\nreturn center_freq_idx;\r\n}

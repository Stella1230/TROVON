static int berlin_reset_reset(struct reset_controller_dev *rcdev,\r\nunsigned long id)\r\n{\r\nstruct berlin_reset_priv *priv = to_berlin_reset_priv(rcdev);\r\nint offset = id >> 8;\r\nint mask = BIT(id & 0x1f);\r\nregmap_write(priv->regmap, offset, mask);\r\nudelay(10);\r\nreturn 0;\r\n}\r\nstatic int berlin_reset_xlate(struct reset_controller_dev *rcdev,\r\nconst struct of_phandle_args *reset_spec)\r\n{\r\nunsigned offset, bit;\r\nif (WARN_ON(reset_spec->args_count != rcdev->of_reset_n_cells))\r\nreturn -EINVAL;\r\noffset = reset_spec->args[0];\r\nbit = reset_spec->args[1];\r\nif (bit >= BERLIN_MAX_RESETS)\r\nreturn -EINVAL;\r\nreturn (offset << 8) | bit;\r\n}\r\nstatic int berlin2_reset_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *parent_np = of_get_parent(pdev->dev.of_node);\r\nstruct berlin_reset_priv *priv;\r\npriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->regmap = syscon_node_to_regmap(parent_np);\r\nof_node_put(parent_np);\r\nif (IS_ERR(priv->regmap))\r\nreturn PTR_ERR(priv->regmap);\r\npriv->rcdev.owner = THIS_MODULE;\r\npriv->rcdev.ops = &berlin_reset_ops;\r\npriv->rcdev.of_node = pdev->dev.of_node;\r\npriv->rcdev.of_reset_n_cells = 2;\r\npriv->rcdev.of_xlate = berlin_reset_xlate;\r\nreset_controller_register(&priv->rcdev);\r\nreturn 0;\r\n}

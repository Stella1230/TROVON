static inline int irq_to_tps65912_irq(struct tps65912 *tps65912,\r\nint irq)\r\n{\r\nreturn irq - tps65912->irq_base;\r\n}\r\nstatic irqreturn_t tps65912_irq(int irq, void *irq_data)\r\n{\r\nstruct tps65912 *tps65912 = irq_data;\r\nu32 irq_sts;\r\nu32 irq_mask;\r\nu8 reg;\r\nint i;\r\ntps65912->read(tps65912, TPS65912_INT_STS, 1, &reg);\r\nirq_sts = reg;\r\ntps65912->read(tps65912, TPS65912_INT_STS2, 1, &reg);\r\nirq_sts |= reg << 8;\r\ntps65912->read(tps65912, TPS65912_INT_STS3, 1, &reg);\r\nirq_sts |= reg << 16;\r\ntps65912->read(tps65912, TPS65912_INT_STS4, 1, &reg);\r\nirq_sts |= reg << 24;\r\ntps65912->read(tps65912, TPS65912_INT_MSK, 1, &reg);\r\nirq_mask = reg;\r\ntps65912->read(tps65912, TPS65912_INT_MSK2, 1, &reg);\r\nirq_mask |= reg << 8;\r\ntps65912->read(tps65912, TPS65912_INT_MSK3, 1, &reg);\r\nirq_mask |= reg << 16;\r\ntps65912->read(tps65912, TPS65912_INT_MSK4, 1, &reg);\r\nirq_mask |= reg << 24;\r\nirq_sts &= ~irq_mask;\r\nif (!irq_sts)\r\nreturn IRQ_NONE;\r\nfor (i = 0; i < tps65912->irq_num; i++) {\r\nif (!(irq_sts & (1 << i)))\r\ncontinue;\r\nhandle_nested_irq(tps65912->irq_base + i);\r\n}\r\nreg = irq_sts & 0xFF;\r\nirq_sts >>= 8;\r\nif (reg)\r\ntps65912->write(tps65912, TPS65912_INT_STS, 1, &reg);\r\nreg = irq_sts & 0xFF;\r\nirq_sts >>= 8;\r\nif (reg)\r\ntps65912->write(tps65912, TPS65912_INT_STS2, 1, &reg);\r\nreg = irq_sts & 0xFF;\r\nirq_sts >>= 8;\r\nif (reg)\r\ntps65912->write(tps65912, TPS65912_INT_STS3, 1, &reg);\r\nreg = irq_sts & 0xFF;\r\nif (reg)\r\ntps65912->write(tps65912, TPS65912_INT_STS4, 1, &reg);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void tps65912_irq_lock(struct irq_data *data)\r\n{\r\nstruct tps65912 *tps65912 = irq_data_get_irq_chip_data(data);\r\nmutex_lock(&tps65912->irq_lock);\r\n}\r\nstatic void tps65912_irq_sync_unlock(struct irq_data *data)\r\n{\r\nstruct tps65912 *tps65912 = irq_data_get_irq_chip_data(data);\r\nu32 reg_mask;\r\nu8 reg;\r\ntps65912->read(tps65912, TPS65912_INT_MSK, 1, &reg);\r\nreg_mask = reg;\r\ntps65912->read(tps65912, TPS65912_INT_MSK2, 1, &reg);\r\nreg_mask |= reg << 8;\r\ntps65912->read(tps65912, TPS65912_INT_MSK3, 1, &reg);\r\nreg_mask |= reg << 16;\r\ntps65912->read(tps65912, TPS65912_INT_MSK4, 1, &reg);\r\nreg_mask |= reg << 24;\r\nif (tps65912->irq_mask != reg_mask) {\r\nreg = tps65912->irq_mask & 0xFF;\r\ntps65912->write(tps65912, TPS65912_INT_MSK, 1, &reg);\r\nreg = tps65912->irq_mask >> 8 & 0xFF;\r\ntps65912->write(tps65912, TPS65912_INT_MSK2, 1, &reg);\r\nreg = tps65912->irq_mask >> 16 & 0xFF;\r\ntps65912->write(tps65912, TPS65912_INT_MSK3, 1, &reg);\r\nreg = tps65912->irq_mask >> 24 & 0xFF;\r\ntps65912->write(tps65912, TPS65912_INT_MSK4, 1, &reg);\r\n}\r\nmutex_unlock(&tps65912->irq_lock);\r\n}\r\nstatic void tps65912_irq_enable(struct irq_data *data)\r\n{\r\nstruct tps65912 *tps65912 = irq_data_get_irq_chip_data(data);\r\ntps65912->irq_mask &= ~(1 << irq_to_tps65912_irq(tps65912, data->irq));\r\n}\r\nstatic void tps65912_irq_disable(struct irq_data *data)\r\n{\r\nstruct tps65912 *tps65912 = irq_data_get_irq_chip_data(data);\r\ntps65912->irq_mask |= (1 << irq_to_tps65912_irq(tps65912, data->irq));\r\n}\r\nint tps65912_irq_init(struct tps65912 *tps65912, int irq,\r\nstruct tps65912_platform_data *pdata)\r\n{\r\nint ret, cur_irq;\r\nint flags = IRQF_ONESHOT;\r\nu8 reg;\r\nif (!irq) {\r\ndev_warn(tps65912->dev, "No interrupt support, no core IRQ\n");\r\nreturn 0;\r\n}\r\nif (!pdata || !pdata->irq_base) {\r\ndev_warn(tps65912->dev, "No interrupt support, no IRQ base\n");\r\nreturn 0;\r\n}\r\ntps65912->read(tps65912, TPS65912_INT_STS, 1, &reg);\r\ntps65912->write(tps65912, TPS65912_INT_STS, 1, &reg);\r\ntps65912->read(tps65912, TPS65912_INT_STS2, 1, &reg);\r\ntps65912->write(tps65912, TPS65912_INT_STS2, 1, &reg);\r\ntps65912->read(tps65912, TPS65912_INT_STS3, 1, &reg);\r\ntps65912->write(tps65912, TPS65912_INT_STS3, 1, &reg);\r\ntps65912->read(tps65912, TPS65912_INT_STS4, 1, &reg);\r\ntps65912->write(tps65912, TPS65912_INT_STS4, 1, &reg);\r\ntps65912->irq_mask = 0xFFFFFFFF;\r\nmutex_init(&tps65912->irq_lock);\r\ntps65912->chip_irq = irq;\r\ntps65912->irq_base = pdata->irq_base;\r\ntps65912->irq_num = TPS65912_NUM_IRQ;\r\nfor (cur_irq = tps65912->irq_base;\r\ncur_irq < tps65912->irq_num + tps65912->irq_base;\r\ncur_irq++) {\r\nirq_set_chip_data(cur_irq, tps65912);\r\nirq_set_chip_and_handler(cur_irq, &tps65912_irq_chip,\r\nhandle_edge_irq);\r\nirq_set_nested_thread(cur_irq, 1);\r\nirq_clear_status_flags(cur_irq, IRQ_NOREQUEST | IRQ_NOPROBE);\r\n}\r\nret = request_threaded_irq(irq, NULL, tps65912_irq, flags,\r\n"tps65912", tps65912);\r\nirq_set_irq_type(irq, IRQ_TYPE_LEVEL_LOW);\r\nif (ret != 0)\r\ndev_err(tps65912->dev, "Failed to request IRQ: %d\n", ret);\r\nreturn ret;\r\n}\r\nint tps65912_irq_exit(struct tps65912 *tps65912)\r\n{\r\nfree_irq(tps65912->chip_irq, tps65912);\r\nreturn 0;\r\n}

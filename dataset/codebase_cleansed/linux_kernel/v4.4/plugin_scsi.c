static const char *\r\nscsi_trace_rw6(struct trace_seq *p, unsigned char *cdb, int len)\r\n{\r\nconst char *ret = p->buffer + p->len;\r\nsector_t lba = 0, txlen = 0;\r\nlba |= ((cdb[1] & 0x1F) << 16);\r\nlba |= (cdb[2] << 8);\r\nlba |= cdb[3];\r\ntxlen = cdb[4];\r\ntrace_seq_printf(p, "lba=%llu txlen=%llu",\r\n(unsigned long long)lba, (unsigned long long)txlen);\r\ntrace_seq_putc(p, 0);\r\nreturn ret;\r\n}\r\nstatic const char *\r\nscsi_trace_rw10(struct trace_seq *p, unsigned char *cdb, int len)\r\n{\r\nconst char *ret = p->buffer + p->len;\r\nsector_t lba = 0, txlen = 0;\r\nlba |= (cdb[2] << 24);\r\nlba |= (cdb[3] << 16);\r\nlba |= (cdb[4] << 8);\r\nlba |= cdb[5];\r\ntxlen |= (cdb[7] << 8);\r\ntxlen |= cdb[8];\r\ntrace_seq_printf(p, "lba=%llu txlen=%llu protect=%u",\r\n(unsigned long long)lba, (unsigned long long)txlen,\r\ncdb[1] >> 5);\r\nif (cdb[0] == WRITE_SAME)\r\ntrace_seq_printf(p, " unmap=%u", cdb[1] >> 3 & 1);\r\ntrace_seq_putc(p, 0);\r\nreturn ret;\r\n}\r\nstatic const char *\r\nscsi_trace_rw12(struct trace_seq *p, unsigned char *cdb, int len)\r\n{\r\nconst char *ret = p->buffer + p->len;\r\nsector_t lba = 0, txlen = 0;\r\nlba |= (cdb[2] << 24);\r\nlba |= (cdb[3] << 16);\r\nlba |= (cdb[4] << 8);\r\nlba |= cdb[5];\r\ntxlen |= (cdb[6] << 24);\r\ntxlen |= (cdb[7] << 16);\r\ntxlen |= (cdb[8] << 8);\r\ntxlen |= cdb[9];\r\ntrace_seq_printf(p, "lba=%llu txlen=%llu protect=%u",\r\n(unsigned long long)lba, (unsigned long long)txlen,\r\ncdb[1] >> 5);\r\ntrace_seq_putc(p, 0);\r\nreturn ret;\r\n}\r\nstatic const char *\r\nscsi_trace_rw16(struct trace_seq *p, unsigned char *cdb, int len)\r\n{\r\nconst char *ret = p->buffer + p->len;\r\nsector_t lba = 0, txlen = 0;\r\nlba |= ((u64)cdb[2] << 56);\r\nlba |= ((u64)cdb[3] << 48);\r\nlba |= ((u64)cdb[4] << 40);\r\nlba |= ((u64)cdb[5] << 32);\r\nlba |= (cdb[6] << 24);\r\nlba |= (cdb[7] << 16);\r\nlba |= (cdb[8] << 8);\r\nlba |= cdb[9];\r\ntxlen |= (cdb[10] << 24);\r\ntxlen |= (cdb[11] << 16);\r\ntxlen |= (cdb[12] << 8);\r\ntxlen |= cdb[13];\r\ntrace_seq_printf(p, "lba=%llu txlen=%llu protect=%u",\r\n(unsigned long long)lba, (unsigned long long)txlen,\r\ncdb[1] >> 5);\r\nif (cdb[0] == WRITE_SAME_16)\r\ntrace_seq_printf(p, " unmap=%u", cdb[1] >> 3 & 1);\r\ntrace_seq_putc(p, 0);\r\nreturn ret;\r\n}\r\nstatic const char *\r\nscsi_trace_rw32(struct trace_seq *p, unsigned char *cdb, int len)\r\n{\r\nconst char *ret = p->buffer + p->len, *cmd;\r\nsector_t lba = 0, txlen = 0;\r\nu32 ei_lbrt = 0;\r\nswitch (SERVICE_ACTION32(cdb)) {\r\ncase READ_32:\r\ncmd = "READ";\r\nbreak;\r\ncase VERIFY_32:\r\ncmd = "VERIFY";\r\nbreak;\r\ncase WRITE_32:\r\ncmd = "WRITE";\r\nbreak;\r\ncase WRITE_SAME_32:\r\ncmd = "WRITE_SAME";\r\nbreak;\r\ndefault:\r\ntrace_seq_printf(p, "UNKNOWN");\r\ngoto out;\r\n}\r\nlba |= ((u64)cdb[12] << 56);\r\nlba |= ((u64)cdb[13] << 48);\r\nlba |= ((u64)cdb[14] << 40);\r\nlba |= ((u64)cdb[15] << 32);\r\nlba |= (cdb[16] << 24);\r\nlba |= (cdb[17] << 16);\r\nlba |= (cdb[18] << 8);\r\nlba |= cdb[19];\r\nei_lbrt |= (cdb[20] << 24);\r\nei_lbrt |= (cdb[21] << 16);\r\nei_lbrt |= (cdb[22] << 8);\r\nei_lbrt |= cdb[23];\r\ntxlen |= (cdb[28] << 24);\r\ntxlen |= (cdb[29] << 16);\r\ntxlen |= (cdb[30] << 8);\r\ntxlen |= cdb[31];\r\ntrace_seq_printf(p, "%s_32 lba=%llu txlen=%llu protect=%u ei_lbrt=%u",\r\ncmd, (unsigned long long)lba,\r\n(unsigned long long)txlen, cdb[10] >> 5, ei_lbrt);\r\nif (SERVICE_ACTION32(cdb) == WRITE_SAME_32)\r\ntrace_seq_printf(p, " unmap=%u", cdb[10] >> 3 & 1);\r\nout:\r\ntrace_seq_putc(p, 0);\r\nreturn ret;\r\n}\r\nstatic const char *\r\nscsi_trace_unmap(struct trace_seq *p, unsigned char *cdb, int len)\r\n{\r\nconst char *ret = p->buffer + p->len;\r\nunsigned int regions = cdb[7] << 8 | cdb[8];\r\ntrace_seq_printf(p, "regions=%u", (regions - 8) / 16);\r\ntrace_seq_putc(p, 0);\r\nreturn ret;\r\n}\r\nstatic const char *\r\nscsi_trace_service_action_in(struct trace_seq *p, unsigned char *cdb, int len)\r\n{\r\nconst char *ret = p->buffer + p->len, *cmd;\r\nsector_t lba = 0;\r\nu32 alloc_len = 0;\r\nswitch (SERVICE_ACTION16(cdb)) {\r\ncase SAI_READ_CAPACITY_16:\r\ncmd = "READ_CAPACITY_16";\r\nbreak;\r\ncase SAI_GET_LBA_STATUS:\r\ncmd = "GET_LBA_STATUS";\r\nbreak;\r\ndefault:\r\ntrace_seq_printf(p, "UNKNOWN");\r\ngoto out;\r\n}\r\nlba |= ((u64)cdb[2] << 56);\r\nlba |= ((u64)cdb[3] << 48);\r\nlba |= ((u64)cdb[4] << 40);\r\nlba |= ((u64)cdb[5] << 32);\r\nlba |= (cdb[6] << 24);\r\nlba |= (cdb[7] << 16);\r\nlba |= (cdb[8] << 8);\r\nlba |= cdb[9];\r\nalloc_len |= (cdb[10] << 24);\r\nalloc_len |= (cdb[11] << 16);\r\nalloc_len |= (cdb[12] << 8);\r\nalloc_len |= cdb[13];\r\ntrace_seq_printf(p, "%s lba=%llu alloc_len=%u", cmd,\r\n(unsigned long long)lba, alloc_len);\r\nout:\r\ntrace_seq_putc(p, 0);\r\nreturn ret;\r\n}\r\nstatic const char *\r\nscsi_trace_varlen(struct trace_seq *p, unsigned char *cdb, int len)\r\n{\r\nswitch (SERVICE_ACTION32(cdb)) {\r\ncase READ_32:\r\ncase VERIFY_32:\r\ncase WRITE_32:\r\ncase WRITE_SAME_32:\r\nreturn scsi_trace_rw32(p, cdb, len);\r\ndefault:\r\nreturn scsi_trace_misc(p, cdb, len);\r\n}\r\n}\r\nstatic const char *\r\nscsi_trace_misc(struct trace_seq *p, unsigned char *cdb, int len)\r\n{\r\nconst char *ret = p->buffer + p->len;\r\ntrace_seq_printf(p, "-");\r\ntrace_seq_putc(p, 0);\r\nreturn ret;\r\n}\r\nconst char *\r\nscsi_trace_parse_cdb(struct trace_seq *p, unsigned char *cdb, int len)\r\n{\r\nswitch (cdb[0]) {\r\ncase READ_6:\r\ncase WRITE_6:\r\nreturn scsi_trace_rw6(p, cdb, len);\r\ncase READ_10:\r\ncase VERIFY:\r\ncase WRITE_10:\r\ncase WRITE_SAME:\r\nreturn scsi_trace_rw10(p, cdb, len);\r\ncase READ_12:\r\ncase VERIFY_12:\r\ncase WRITE_12:\r\nreturn scsi_trace_rw12(p, cdb, len);\r\ncase READ_16:\r\ncase VERIFY_16:\r\ncase WRITE_16:\r\ncase WRITE_SAME_16:\r\nreturn scsi_trace_rw16(p, cdb, len);\r\ncase UNMAP:\r\nreturn scsi_trace_unmap(p, cdb, len);\r\ncase SERVICE_ACTION_IN_16:\r\nreturn scsi_trace_service_action_in(p, cdb, len);\r\ncase VARIABLE_LENGTH_CMD:\r\nreturn scsi_trace_varlen(p, cdb, len);\r\ndefault:\r\nreturn scsi_trace_misc(p, cdb, len);\r\n}\r\n}\r\nunsigned long long process_scsi_trace_parse_cdb(struct trace_seq *s,\r\nunsigned long long *args)\r\n{\r\nscsi_trace_parse_cdb(s, (unsigned char *) (unsigned long) args[1], args[2]);\r\nreturn 0;\r\n}\r\nint PEVENT_PLUGIN_LOADER(struct pevent *pevent)\r\n{\r\npevent_register_print_function(pevent,\r\nprocess_scsi_trace_parse_cdb,\r\nPEVENT_FUNC_ARG_STRING,\r\n"scsi_trace_parse_cdb",\r\nPEVENT_FUNC_ARG_PTR,\r\nPEVENT_FUNC_ARG_PTR,\r\nPEVENT_FUNC_ARG_INT,\r\nPEVENT_FUNC_ARG_VOID);\r\nreturn 0;\r\n}\r\nvoid PEVENT_PLUGIN_UNLOADER(struct pevent *pevent)\r\n{\r\npevent_unregister_print_function(pevent, process_scsi_trace_parse_cdb,\r\n"scsi_trace_parse_cdb");\r\n}

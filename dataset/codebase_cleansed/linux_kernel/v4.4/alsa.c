int aoa_alsa_init(char *name, struct module *mod, struct device *dev)\r\n{\r\nstruct snd_card *alsa_card;\r\nint err;\r\nif (aoa_card)\r\nreturn -EBUSY;\r\nerr = snd_card_new(dev, index, name, mod, sizeof(struct aoa_card),\r\n&alsa_card);\r\nif (err < 0)\r\nreturn err;\r\naoa_card = alsa_card->private_data;\r\naoa_card->alsa_card = alsa_card;\r\nstrlcpy(alsa_card->driver, "AppleOnbdAudio", sizeof(alsa_card->driver));\r\nstrlcpy(alsa_card->shortname, name, sizeof(alsa_card->shortname));\r\nstrlcpy(alsa_card->longname, name, sizeof(alsa_card->longname));\r\nstrlcpy(alsa_card->mixername, name, sizeof(alsa_card->mixername));\r\nerr = snd_card_register(aoa_card->alsa_card);\r\nif (err < 0) {\r\nprintk(KERN_ERR "snd-aoa: couldn't register alsa card\n");\r\nsnd_card_free(aoa_card->alsa_card);\r\naoa_card = NULL;\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstruct snd_card *aoa_get_card(void)\r\n{\r\nif (aoa_card)\r\nreturn aoa_card->alsa_card;\r\nreturn NULL;\r\n}\r\nvoid aoa_alsa_cleanup(void)\r\n{\r\nif (aoa_card) {\r\nsnd_card_free(aoa_card->alsa_card);\r\naoa_card = NULL;\r\n}\r\n}\r\nint aoa_snd_device_new(enum snd_device_type type,\r\nvoid * device_data, struct snd_device_ops * ops)\r\n{\r\nstruct snd_card *card = aoa_get_card();\r\nint err;\r\nif (!card) return -ENOMEM;\r\nerr = snd_device_new(card, type, device_data, ops);\r\nif (err) {\r\nprintk(KERN_ERR "snd-aoa: failed to create snd device (%d)\n", err);\r\nreturn err;\r\n}\r\nerr = snd_device_register(card, device_data);\r\nif (err) {\r\nprintk(KERN_ERR "snd-aoa: failed to register "\r\n"snd device (%d)\n", err);\r\nprintk(KERN_ERR "snd-aoa: have you forgotten the "\r\n"dev_register callback?\n");\r\nsnd_device_free(card, device_data);\r\n}\r\nreturn err;\r\n}\r\nint aoa_snd_ctl_add(struct snd_kcontrol* control)\r\n{\r\nint err;\r\nif (!aoa_card) return -ENODEV;\r\nerr = snd_ctl_add(aoa_card->alsa_card, control);\r\nif (err)\r\nprintk(KERN_ERR "snd-aoa: failed to add alsa control (%d)\n",\r\nerr);\r\nreturn err;\r\n}

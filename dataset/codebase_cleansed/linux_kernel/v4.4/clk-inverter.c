static int rockchip_inv_get_phase(struct clk_hw *hw)\r\n{\r\nstruct rockchip_inv_clock *inv_clock = to_inv_clock(hw);\r\nu32 val;\r\nval = readl(inv_clock->reg) >> inv_clock->shift;\r\nval &= INVERTER_MASK;\r\nreturn val ? 180 : 0;\r\n}\r\nstatic int rockchip_inv_set_phase(struct clk_hw *hw, int degrees)\r\n{\r\nstruct rockchip_inv_clock *inv_clock = to_inv_clock(hw);\r\nu32 val;\r\nif (degrees % 180 == 0) {\r\nval = !!degrees;\r\n} else {\r\npr_err("%s: unsupported phase %d for %s\n",\r\n__func__, degrees, clk_hw_get_name(hw));\r\nreturn -EINVAL;\r\n}\r\nif (inv_clock->flags & ROCKCHIP_INVERTER_HIWORD_MASK) {\r\nwritel(HIWORD_UPDATE(val, INVERTER_MASK, inv_clock->shift),\r\ninv_clock->reg);\r\n} else {\r\nunsigned long flags;\r\nu32 reg;\r\nspin_lock_irqsave(inv_clock->lock, flags);\r\nreg = readl(inv_clock->reg);\r\nreg &= ~BIT(inv_clock->shift);\r\nreg |= val;\r\nwritel(reg, inv_clock->reg);\r\nspin_unlock_irqrestore(inv_clock->lock, flags);\r\n}\r\nreturn 0;\r\n}\r\nstruct clk *rockchip_clk_register_inverter(const char *name,\r\nconst char *const *parent_names, u8 num_parents,\r\nvoid __iomem *reg, int shift, int flags,\r\nspinlock_t *lock)\r\n{\r\nstruct clk_init_data init;\r\nstruct rockchip_inv_clock *inv_clock;\r\nstruct clk *clk;\r\ninv_clock = kmalloc(sizeof(*inv_clock), GFP_KERNEL);\r\nif (!inv_clock)\r\nreturn NULL;\r\ninit.name = name;\r\ninit.num_parents = num_parents;\r\ninit.flags = CLK_SET_RATE_PARENT;\r\ninit.parent_names = parent_names;\r\ninit.ops = &rockchip_inv_clk_ops;\r\ninv_clock->hw.init = &init;\r\ninv_clock->reg = reg;\r\ninv_clock->shift = shift;\r\ninv_clock->flags = flags;\r\ninv_clock->lock = lock;\r\nclk = clk_register(NULL, &inv_clock->hw);\r\nif (IS_ERR(clk))\r\ngoto err_free;\r\nreturn clk;\r\nerr_free:\r\nkfree(inv_clock);\r\nreturn NULL;\r\n}

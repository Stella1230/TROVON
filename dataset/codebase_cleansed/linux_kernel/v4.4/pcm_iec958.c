int snd_pcm_create_iec958_consumer(struct snd_pcm_runtime *runtime, u8 *cs,\r\nsize_t len)\r\n{\r\nunsigned int fs, ws;\r\nif (len < 4)\r\nreturn -EINVAL;\r\nswitch (runtime->rate) {\r\ncase 32000:\r\nfs = IEC958_AES3_CON_FS_32000;\r\nbreak;\r\ncase 44100:\r\nfs = IEC958_AES3_CON_FS_44100;\r\nbreak;\r\ncase 48000:\r\nfs = IEC958_AES3_CON_FS_48000;\r\nbreak;\r\ncase 88200:\r\nfs = IEC958_AES3_CON_FS_88200;\r\nbreak;\r\ncase 96000:\r\nfs = IEC958_AES3_CON_FS_96000;\r\nbreak;\r\ncase 176400:\r\nfs = IEC958_AES3_CON_FS_176400;\r\nbreak;\r\ncase 192000:\r\nfs = IEC958_AES3_CON_FS_192000;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (len > 4) {\r\nswitch (snd_pcm_format_width(runtime->format)) {\r\ncase 16:\r\nws = IEC958_AES4_CON_WORDLEN_20_16;\r\nbreak;\r\ncase 18:\r\nws = IEC958_AES4_CON_WORDLEN_22_18;\r\nbreak;\r\ncase 20:\r\nws = IEC958_AES4_CON_WORDLEN_20_16 |\r\nIEC958_AES4_CON_MAX_WORDLEN_24;\r\nbreak;\r\ncase 24:\r\nws = IEC958_AES4_CON_WORDLEN_24_20 |\r\nIEC958_AES4_CON_MAX_WORDLEN_24;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nmemset(cs, 0, len);\r\ncs[0] = IEC958_AES0_CON_NOT_COPYRIGHT | IEC958_AES0_CON_EMPHASIS_NONE;\r\ncs[1] = IEC958_AES1_CON_GENERAL;\r\ncs[2] = IEC958_AES2_CON_SOURCE_UNSPEC | IEC958_AES2_CON_CHANNEL_UNSPEC;\r\ncs[3] = IEC958_AES3_CON_CLOCK_1000PPM | fs;\r\nif (len > 4)\r\ncs[4] = ws;\r\nreturn len;\r\n}

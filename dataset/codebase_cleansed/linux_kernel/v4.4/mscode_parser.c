int mscode_parse(struct pefile_context *ctx)\r\n{\r\nconst void *content_data;\r\nsize_t data_len;\r\nint ret;\r\nret = pkcs7_get_content_data(ctx->pkcs7, &content_data, &data_len, 1);\r\nif (ret) {\r\npr_debug("PKCS#7 message does not contain data\n");\r\nreturn ret;\r\n}\r\npr_devel("Data: %zu [%*ph]\n", data_len, (unsigned)(data_len),\r\ncontent_data);\r\nreturn asn1_ber_decoder(&mscode_decoder, ctx, content_data, data_len);\r\n}\r\nint mscode_note_content_type(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nenum OID oid;\r\noid = look_up_OID(value, vlen);\r\nif (oid == OID__NR) {\r\nchar buffer[50];\r\nsprint_oid(value, vlen, buffer, sizeof(buffer));\r\npr_err("Unknown OID: %s\n", buffer);\r\nreturn -EBADMSG;\r\n}\r\nif (oid != OID_msPeImageDataObjId &&\r\noid != OID_msIndividualSPKeyPurpose) {\r\npr_err("Unexpected content type OID %u\n", oid);\r\nreturn -EBADMSG;\r\n}\r\nreturn 0;\r\n}\r\nint mscode_note_digest_algo(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pefile_context *ctx = context;\r\nchar buffer[50];\r\nenum OID oid;\r\noid = look_up_OID(value, vlen);\r\nswitch (oid) {\r\ncase OID_md4:\r\nctx->digest_algo = HASH_ALGO_MD4;\r\nbreak;\r\ncase OID_md5:\r\nctx->digest_algo = HASH_ALGO_MD5;\r\nbreak;\r\ncase OID_sha1:\r\nctx->digest_algo = HASH_ALGO_SHA1;\r\nbreak;\r\ncase OID_sha256:\r\nctx->digest_algo = HASH_ALGO_SHA256;\r\nbreak;\r\ncase OID_sha384:\r\nctx->digest_algo = HASH_ALGO_SHA384;\r\nbreak;\r\ncase OID_sha512:\r\nctx->digest_algo = HASH_ALGO_SHA512;\r\nbreak;\r\ncase OID_sha224:\r\nctx->digest_algo = HASH_ALGO_SHA224;\r\nbreak;\r\ncase OID__NR:\r\nsprint_oid(value, vlen, buffer, sizeof(buffer));\r\npr_err("Unknown OID: %s\n", buffer);\r\nreturn -EBADMSG;\r\ndefault:\r\npr_err("Unsupported content type: %u\n", oid);\r\nreturn -ENOPKG;\r\n}\r\nreturn 0;\r\n}\r\nint mscode_note_digest(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pefile_context *ctx = context;\r\nctx->digest = value;\r\nctx->digest_len = vlen;\r\nreturn 0;\r\n}

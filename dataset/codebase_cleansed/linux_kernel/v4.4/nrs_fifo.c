static int nrs_fifo_start(struct ptlrpc_nrs_policy *policy)\r\n{\r\nstruct nrs_fifo_head *head;\r\nhead = kzalloc_node(sizeof(*head), GFP_NOFS,\r\ncfs_cpt_spread_node(nrs_pol2cptab(policy),\r\nnrs_pol2cptid(policy)));\r\nif (head == NULL)\r\nreturn -ENOMEM;\r\nINIT_LIST_HEAD(&head->fh_list);\r\npolicy->pol_private = head;\r\nreturn 0;\r\n}\r\nstatic void nrs_fifo_stop(struct ptlrpc_nrs_policy *policy)\r\n{\r\nstruct nrs_fifo_head *head = policy->pol_private;\r\nLASSERT(head != NULL);\r\nLASSERT(list_empty(&head->fh_list));\r\nkfree(head);\r\n}\r\nstatic int nrs_fifo_res_get(struct ptlrpc_nrs_policy *policy,\r\nstruct ptlrpc_nrs_request *nrq,\r\nconst struct ptlrpc_nrs_resource *parent,\r\nstruct ptlrpc_nrs_resource **resp, bool moving_req)\r\n{\r\n*resp = &((struct nrs_fifo_head *)policy->pol_private)->fh_res;\r\nreturn 1;\r\n}\r\nstatic\r\nstruct ptlrpc_nrs_request *nrs_fifo_req_get(struct ptlrpc_nrs_policy *policy,\r\nbool peek, bool force)\r\n{\r\nstruct nrs_fifo_head *head = policy->pol_private;\r\nstruct ptlrpc_nrs_request *nrq;\r\nnrq = unlikely(list_empty(&head->fh_list)) ? NULL :\r\nlist_entry(head->fh_list.next, struct ptlrpc_nrs_request,\r\nnr_u.fifo.fr_list);\r\nif (likely(!peek && nrq != NULL)) {\r\nstruct ptlrpc_request *req = container_of(nrq,\r\nstruct ptlrpc_request,\r\nrq_nrq);\r\nlist_del_init(&nrq->nr_u.fifo.fr_list);\r\nCDEBUG(D_RPCTRACE, "NRS start %s request from %s, seq: %llu\n",\r\npolicy->pol_desc->pd_name, libcfs_id2str(req->rq_peer),\r\nnrq->nr_u.fifo.fr_sequence);\r\n}\r\nreturn nrq;\r\n}\r\nstatic int nrs_fifo_req_add(struct ptlrpc_nrs_policy *policy,\r\nstruct ptlrpc_nrs_request *nrq)\r\n{\r\nstruct nrs_fifo_head *head;\r\nhead = container_of(nrs_request_resource(nrq), struct nrs_fifo_head,\r\nfh_res);\r\nnrq->nr_u.fifo.fr_sequence = head->fh_sequence++;\r\nlist_add_tail(&nrq->nr_u.fifo.fr_list, &head->fh_list);\r\nreturn 0;\r\n}\r\nstatic void nrs_fifo_req_del(struct ptlrpc_nrs_policy *policy,\r\nstruct ptlrpc_nrs_request *nrq)\r\n{\r\nLASSERT(!list_empty(&nrq->nr_u.fifo.fr_list));\r\nlist_del_init(&nrq->nr_u.fifo.fr_list);\r\n}\r\nstatic void nrs_fifo_req_stop(struct ptlrpc_nrs_policy *policy,\r\nstruct ptlrpc_nrs_request *nrq)\r\n{\r\nstruct ptlrpc_request *req = container_of(nrq, struct ptlrpc_request,\r\nrq_nrq);\r\nCDEBUG(D_RPCTRACE, "NRS stop %s request from %s, seq: %llu\n",\r\npolicy->pol_desc->pd_name, libcfs_id2str(req->rq_peer),\r\nnrq->nr_u.fifo.fr_sequence);\r\n}

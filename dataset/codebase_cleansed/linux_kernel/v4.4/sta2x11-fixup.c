static void sta2x11_new_instance(struct pci_dev *pdev)\r\n{\r\nstruct sta2x11_instance *instance;\r\ninstance = kzalloc(sizeof(*instance), GFP_ATOMIC);\r\nif (!instance)\r\nreturn;\r\ninstance->bus0 = pdev->subordinate->number + 1;\r\nif (list_empty(&sta2x11_instance_list)) {\r\nint size = STA2X11_SWIOTLB_SIZE;\r\ndev_info(&pdev->dev, "Using SWIOTLB (size %i)\n", size);\r\nif (swiotlb_late_init_with_default_size(size))\r\ndev_emerg(&pdev->dev, "init swiotlb failed\n");\r\n}\r\nlist_add(&instance->list, &sta2x11_instance_list);\r\n}\r\nstatic struct sta2x11_instance *sta2x11_pdev_to_instance(struct pci_dev *pdev)\r\n{\r\nstruct sta2x11_instance *instance;\r\nint ep;\r\nlist_for_each_entry(instance, &sta2x11_instance_list, list) {\r\nep = pdev->bus->number - instance->bus0;\r\nif (ep >= 0 && ep < STA2X11_NR_EP)\r\nreturn instance;\r\n}\r\nreturn NULL;\r\n}\r\nstatic int sta2x11_pdev_to_ep(struct pci_dev *pdev)\r\n{\r\nstruct sta2x11_instance *instance;\r\ninstance = sta2x11_pdev_to_instance(pdev);\r\nif (!instance)\r\nreturn -1;\r\nreturn pdev->bus->number - instance->bus0;\r\n}\r\nstatic struct sta2x11_mapping *sta2x11_pdev_to_mapping(struct pci_dev *pdev)\r\n{\r\nstruct sta2x11_instance *instance;\r\nint ep;\r\ninstance = sta2x11_pdev_to_instance(pdev);\r\nif (!instance)\r\nreturn NULL;\r\nep = sta2x11_pdev_to_ep(pdev);\r\nreturn instance->map + ep;\r\n}\r\nstruct sta2x11_instance *sta2x11_get_instance(struct pci_dev *pdev)\r\n{\r\nreturn sta2x11_pdev_to_instance(pdev);\r\n}\r\nstatic dma_addr_t p2a(dma_addr_t p, struct pci_dev *pdev)\r\n{\r\nstruct sta2x11_mapping *map;\r\ndma_addr_t a;\r\nmap = sta2x11_pdev_to_mapping(pdev);\r\na = p + map->amba_base;\r\nreturn a;\r\n}\r\nstatic dma_addr_t a2p(dma_addr_t a, struct pci_dev *pdev)\r\n{\r\nstruct sta2x11_mapping *map;\r\ndma_addr_t p;\r\nmap = sta2x11_pdev_to_mapping(pdev);\r\np = a - map->amba_base;\r\nreturn p;\r\n}\r\nstatic void *sta2x11_swiotlb_alloc_coherent(struct device *dev,\r\nsize_t size,\r\ndma_addr_t *dma_handle,\r\ngfp_t flags,\r\nstruct dma_attrs *attrs)\r\n{\r\nvoid *vaddr;\r\nvaddr = x86_swiotlb_alloc_coherent(dev, size, dma_handle, flags, attrs);\r\n*dma_handle = p2a(*dma_handle, to_pci_dev(dev));\r\nreturn vaddr;\r\n}\r\nstatic void sta2x11_setup_pdev(struct pci_dev *pdev)\r\n{\r\nstruct sta2x11_instance *instance = sta2x11_pdev_to_instance(pdev);\r\nif (!instance)\r\nreturn;\r\npci_set_consistent_dma_mask(pdev, STA2X11_AMBA_SIZE - 1);\r\npci_set_dma_mask(pdev, STA2X11_AMBA_SIZE - 1);\r\npdev->dev.archdata.dma_ops = &sta2x11_dma_ops;\r\npci_set_master(pdev);\r\n}\r\nbool dma_capable(struct device *dev, dma_addr_t addr, size_t size)\r\n{\r\nstruct sta2x11_mapping *map;\r\nif (dev->archdata.dma_ops != &sta2x11_dma_ops) {\r\nif (!dev->dma_mask)\r\nreturn false;\r\nreturn addr + size - 1 <= *dev->dma_mask;\r\n}\r\nmap = sta2x11_pdev_to_mapping(to_pci_dev(dev));\r\nif (!map || (addr < map->amba_base))\r\nreturn false;\r\nif (addr + size >= map->amba_base + STA2X11_AMBA_SIZE) {\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\ndma_addr_t phys_to_dma(struct device *dev, phys_addr_t paddr)\r\n{\r\nif (dev->archdata.dma_ops != &sta2x11_dma_ops)\r\nreturn paddr;\r\nreturn p2a(paddr, to_pci_dev(dev));\r\n}\r\nphys_addr_t dma_to_phys(struct device *dev, dma_addr_t daddr)\r\n{\r\nif (dev->archdata.dma_ops != &sta2x11_dma_ops)\r\nreturn daddr;\r\nreturn a2p(daddr, to_pci_dev(dev));\r\n}\r\nstatic void sta2x11_map_ep(struct pci_dev *pdev)\r\n{\r\nstruct sta2x11_mapping *map = sta2x11_pdev_to_mapping(pdev);\r\nint i;\r\nif (!map)\r\nreturn;\r\npci_read_config_dword(pdev, AHB_BASE(0), &map->amba_base);\r\npci_write_config_dword(pdev, AHB_PEXLBASE(0), 0);\r\npci_write_config_dword(pdev, AHB_PEXHBASE(0), 0);\r\npci_write_config_dword(pdev, AHB_CRW(0), STA2X11_AMBA_SIZE |\r\nAHB_CRW_WTYPE_MEM | AHB_CRW_ENABLE);\r\nfor (i = 1; i < STA2X11_NR_FUNCS; i++)\r\npci_write_config_dword(pdev, AHB_CRW(i), 0);\r\ndev_info(&pdev->dev,\r\n"sta2x11: Map EP %i: AMBA address %#8x-%#8x\n",\r\nsta2x11_pdev_to_ep(pdev), map->amba_base,\r\nmap->amba_base + STA2X11_AMBA_SIZE - 1);\r\n}\r\nstatic void suspend_mapping(struct pci_dev *pdev)\r\n{\r\nstruct sta2x11_mapping *map = sta2x11_pdev_to_mapping(pdev);\r\nint i;\r\nif (!map)\r\nreturn;\r\nif (map->is_suspended)\r\nreturn;\r\nmap->is_suspended = 1;\r\nfor (i = 0; i < STA2X11_NR_FUNCS; i++) {\r\nstruct sta2x11_ahb_regs *regs = map->regs + i;\r\npci_read_config_dword(pdev, AHB_BASE(i), &regs->base);\r\npci_read_config_dword(pdev, AHB_PEXLBASE(i), &regs->pexlbase);\r\npci_read_config_dword(pdev, AHB_PEXHBASE(i), &regs->pexhbase);\r\npci_read_config_dword(pdev, AHB_CRW(i), &regs->crw);\r\n}\r\n}\r\nstatic void resume_mapping(struct pci_dev *pdev)\r\n{\r\nstruct sta2x11_mapping *map = sta2x11_pdev_to_mapping(pdev);\r\nint i;\r\nif (!map)\r\nreturn;\r\nif (!map->is_suspended)\r\ngoto out;\r\nmap->is_suspended = 0;\r\nfor (i = 0; i < STA2X11_NR_FUNCS; i++) {\r\nstruct sta2x11_ahb_regs *regs = map->regs + i;\r\npci_write_config_dword(pdev, AHB_BASE(i), regs->base);\r\npci_write_config_dword(pdev, AHB_PEXLBASE(i), regs->pexlbase);\r\npci_write_config_dword(pdev, AHB_PEXHBASE(i), regs->pexhbase);\r\npci_write_config_dword(pdev, AHB_CRW(i), regs->crw);\r\n}\r\nout:\r\npci_set_master(pdev);\r\n}

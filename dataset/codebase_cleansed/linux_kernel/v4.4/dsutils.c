void acpi_ds_clear_implicit_return(struct acpi_walk_state *walk_state)\r\n{\r\nACPI_FUNCTION_NAME(ds_clear_implicit_return);\r\nif (!acpi_gbl_enable_interpreter_slack) {\r\nreturn;\r\n}\r\nif (walk_state->implicit_return_obj) {\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"Removing reference on stale implicit return obj %p\n",\r\nwalk_state->implicit_return_obj));\r\nacpi_ut_remove_reference(walk_state->implicit_return_obj);\r\nwalk_state->implicit_return_obj = NULL;\r\n}\r\n}\r\nu8\r\nacpi_ds_do_implicit_return(union acpi_operand_object *return_desc,\r\nstruct acpi_walk_state *walk_state, u8 add_reference)\r\n{\r\nACPI_FUNCTION_NAME(ds_do_implicit_return);\r\nif ((!acpi_gbl_enable_interpreter_slack) || (!return_desc)) {\r\nreturn (FALSE);\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"Result %p will be implicitly returned; Prev=%p\n",\r\nreturn_desc, walk_state->implicit_return_obj));\r\nif (walk_state->implicit_return_obj) {\r\nif (walk_state->implicit_return_obj == return_desc) {\r\nreturn (TRUE);\r\n}\r\nacpi_ds_clear_implicit_return(walk_state);\r\n}\r\nwalk_state->implicit_return_obj = return_desc;\r\nif (add_reference) {\r\nacpi_ut_add_reference(return_desc);\r\n}\r\nreturn (TRUE);\r\n}\r\nu8\r\nacpi_ds_is_result_used(union acpi_parse_object * op,\r\nstruct acpi_walk_state * walk_state)\r\n{\r\nconst struct acpi_opcode_info *parent_info;\r\nACPI_FUNCTION_TRACE_PTR(ds_is_result_used, op);\r\nif (!op) {\r\nACPI_ERROR((AE_INFO, "Null Op"));\r\nreturn_UINT8(TRUE);\r\n}\r\n(void)acpi_ds_do_implicit_return(walk_state->result_obj, walk_state,\r\nTRUE);\r\nif ((!op->common.parent) ||\r\n(op->common.parent->common.aml_opcode == AML_SCOPE_OP)) {\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"At Method level, result of [%s] not used\n",\r\nacpi_ps_get_opcode_name(op->common.\r\naml_opcode)));\r\nreturn_UINT8(FALSE);\r\n}\r\nparent_info =\r\nacpi_ps_get_opcode_info(op->common.parent->common.aml_opcode);\r\nif (parent_info->class == AML_CLASS_UNKNOWN) {\r\nACPI_ERROR((AE_INFO, "Unknown parent opcode Op=%p", op));\r\nreturn_UINT8(FALSE);\r\n}\r\nswitch (parent_info->class) {\r\ncase AML_CLASS_CONTROL:\r\nswitch (op->common.parent->common.aml_opcode) {\r\ncase AML_RETURN_OP:\r\ngoto result_used;\r\ncase AML_IF_OP:\r\ncase AML_WHILE_OP:\r\nif ((walk_state->control_state->common.state ==\r\nACPI_CONTROL_PREDICATE_EXECUTING)\r\n&& (walk_state->control_state->control.\r\npredicate_op == op)) {\r\ngoto result_used;\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\ngoto result_not_used;\r\ncase AML_CLASS_CREATE:\r\ngoto result_used;\r\ncase AML_CLASS_NAMED_OBJECT:\r\nif ((op->common.parent->common.aml_opcode == AML_REGION_OP) ||\r\n(op->common.parent->common.aml_opcode == AML_DATA_REGION_OP)\r\n|| (op->common.parent->common.aml_opcode == AML_PACKAGE_OP)\r\n|| (op->common.parent->common.aml_opcode ==\r\nAML_VAR_PACKAGE_OP)\r\n|| (op->common.parent->common.aml_opcode == AML_BUFFER_OP)\r\n|| (op->common.parent->common.aml_opcode ==\r\nAML_INT_EVAL_SUBTREE_OP)\r\n|| (op->common.parent->common.aml_opcode ==\r\nAML_BANK_FIELD_OP)) {\r\ngoto result_used;\r\n}\r\ngoto result_not_used;\r\ndefault:\r\ngoto result_used;\r\n}\r\nresult_used:\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"Result of [%s] used by Parent [%s] Op=%p\n",\r\nacpi_ps_get_opcode_name(op->common.aml_opcode),\r\nacpi_ps_get_opcode_name(op->common.parent->common.\r\naml_opcode), op));\r\nreturn_UINT8(TRUE);\r\nresult_not_used:\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"Result of [%s] not used by Parent [%s] Op=%p\n",\r\nacpi_ps_get_opcode_name(op->common.aml_opcode),\r\nacpi_ps_get_opcode_name(op->common.parent->common.\r\naml_opcode), op));\r\nreturn_UINT8(FALSE);\r\n}\r\nvoid\r\nacpi_ds_delete_result_if_not_used(union acpi_parse_object *op,\r\nunion acpi_operand_object *result_obj,\r\nstruct acpi_walk_state *walk_state)\r\n{\r\nunion acpi_operand_object *obj_desc;\r\nacpi_status status;\r\nACPI_FUNCTION_TRACE_PTR(ds_delete_result_if_not_used, result_obj);\r\nif (!op) {\r\nACPI_ERROR((AE_INFO, "Null Op"));\r\nreturn_VOID;\r\n}\r\nif (!result_obj) {\r\nreturn_VOID;\r\n}\r\nif (!acpi_ds_is_result_used(op, walk_state)) {\r\nstatus = acpi_ds_result_pop(&obj_desc, walk_state);\r\nif (ACPI_SUCCESS(status)) {\r\nacpi_ut_remove_reference(result_obj);\r\n}\r\n}\r\nreturn_VOID;\r\n}\r\nacpi_status acpi_ds_resolve_operands(struct acpi_walk_state *walk_state)\r\n{\r\nu32 i;\r\nacpi_status status = AE_OK;\r\nACPI_FUNCTION_TRACE_PTR(ds_resolve_operands, walk_state);\r\nfor (i = 0; i < walk_state->num_operands; i++) {\r\nstatus =\r\nacpi_ex_resolve_to_value(&walk_state->operands[i],\r\nwalk_state);\r\nif (ACPI_FAILURE(status)) {\r\nbreak;\r\n}\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}\r\nvoid acpi_ds_clear_operands(struct acpi_walk_state *walk_state)\r\n{\r\nu32 i;\r\nACPI_FUNCTION_TRACE_PTR(ds_clear_operands, walk_state);\r\nfor (i = 0; i < walk_state->num_operands; i++) {\r\nacpi_ut_remove_reference(walk_state->operands[i]);\r\nwalk_state->operands[i] = NULL;\r\n}\r\nwalk_state->num_operands = 0;\r\nreturn_VOID;\r\n}\r\nacpi_status\r\nacpi_ds_create_operand(struct acpi_walk_state *walk_state,\r\nunion acpi_parse_object *arg, u32 arg_index)\r\n{\r\nacpi_status status = AE_OK;\r\nchar *name_string;\r\nu32 name_length;\r\nunion acpi_operand_object *obj_desc;\r\nunion acpi_parse_object *parent_op;\r\nu16 opcode;\r\nacpi_interpreter_mode interpreter_mode;\r\nconst struct acpi_opcode_info *op_info;\r\nACPI_FUNCTION_TRACE_PTR(ds_create_operand, arg);\r\nif ((arg->common.aml_opcode == AML_INT_NAMEPATH_OP) &&\r\n(arg->common.value.string) &&\r\n!(arg->common.flags & ACPI_PARSEOP_IN_STACK)) {\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH, "Getting a name: Arg=%p\n",\r\narg));\r\nstatus =\r\nacpi_ex_get_name_string(ACPI_TYPE_ANY,\r\narg->common.value.buffer,\r\n&name_string, &name_length);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nif ((walk_state->deferred_node) &&\r\n(walk_state->deferred_node->type == ACPI_TYPE_BUFFER_FIELD)\r\n&& (arg_index ==\r\n(u32) ((walk_state->opcode ==\r\nAML_CREATE_FIELD_OP) ? 3 : 2))) {\r\nobj_desc =\r\nACPI_CAST_PTR(union acpi_operand_object,\r\nwalk_state->deferred_node);\r\nstatus = AE_OK;\r\n} else {\r\nparent_op = arg->common.parent;\r\nop_info =\r\nacpi_ps_get_opcode_info(parent_op->common.\r\naml_opcode);\r\nif ((op_info->flags & AML_NSNODE)\r\n&& (parent_op->common.aml_opcode !=\r\nAML_INT_METHODCALL_OP)\r\n&& (parent_op->common.aml_opcode != AML_REGION_OP)\r\n&& (parent_op->common.aml_opcode !=\r\nAML_INT_NAMEPATH_OP)) {\r\ninterpreter_mode = ACPI_IMODE_LOAD_PASS2;\r\n} else {\r\ninterpreter_mode = ACPI_IMODE_EXECUTE;\r\n}\r\nstatus =\r\nacpi_ns_lookup(walk_state->scope_info, name_string,\r\nACPI_TYPE_ANY, interpreter_mode,\r\nACPI_NS_SEARCH_PARENT |\r\nACPI_NS_DONT_OPEN_SCOPE, walk_state,\r\nACPI_CAST_INDIRECT_PTR(struct\r\nacpi_namespace_node,\r\n&obj_desc));\r\nif (status == AE_NOT_FOUND) {\r\nif (parent_op->common.aml_opcode ==\r\nAML_COND_REF_OF_OP) {\r\nobj_desc =\r\nACPI_CAST_PTR(union\r\nacpi_operand_object,\r\nacpi_gbl_root_node);\r\nstatus = AE_OK;\r\n} else if (parent_op->common.aml_opcode ==\r\nAML_EXTERNAL_OP) {\r\nobj_desc =\r\nacpi_ut_create_string_object((acpi_size) name_length);\r\nstrncpy(obj_desc->string.pointer,\r\nname_string, name_length);\r\nstatus = AE_OK;\r\n} else {\r\nstatus = AE_AML_NAME_NOT_FOUND;\r\n}\r\n}\r\nif (ACPI_FAILURE(status)) {\r\nACPI_ERROR_NAMESPACE(name_string, status);\r\n}\r\n}\r\nACPI_FREE(name_string);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nstatus = acpi_ds_obj_stack_push(obj_desc, walk_state);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nACPI_DEBUGGER_EXEC(acpi_db_display_argument_object\r\n(obj_desc, walk_state));\r\n} else {\r\nif ((arg->common.aml_opcode == AML_INT_NAMEPATH_OP) &&\r\n!(arg->common.flags & ACPI_PARSEOP_IN_STACK)) {\r\nopcode = AML_ZERO_OP;\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"Null namepath: Arg=%p\n", arg));\r\n} else {\r\nopcode = arg->common.aml_opcode;\r\n}\r\nop_info = acpi_ps_get_opcode_info(opcode);\r\nif (op_info->object_type == ACPI_TYPE_INVALID) {\r\nreturn_ACPI_STATUS(AE_NOT_IMPLEMENTED);\r\n}\r\nif ((op_info->flags & AML_HAS_RETVAL)\r\n|| (arg->common.flags & ACPI_PARSEOP_IN_STACK)) {\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"Argument previously created, already stacked\n"));\r\nACPI_DEBUGGER_EXEC(acpi_db_display_argument_object\r\n(walk_state->\r\noperands[walk_state->num_operands -\r\n1], walk_state));\r\nstatus = acpi_ds_result_pop(&obj_desc, walk_state);\r\nif (ACPI_FAILURE(status)) {\r\nACPI_EXCEPTION((AE_INFO, status,\r\n"Missing or null operand"));\r\nreturn_ACPI_STATUS(status);\r\n}\r\n} else {\r\nobj_desc =\r\nacpi_ut_create_internal_object(op_info->\r\nobject_type);\r\nif (!obj_desc) {\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\nstatus =\r\nacpi_ds_init_object_from_op(walk_state, arg, opcode,\r\n&obj_desc);\r\nif (ACPI_FAILURE(status)) {\r\nacpi_ut_delete_object_desc(obj_desc);\r\nreturn_ACPI_STATUS(status);\r\n}\r\n}\r\nstatus = acpi_ds_obj_stack_push(obj_desc, walk_state);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nACPI_DEBUGGER_EXEC(acpi_db_display_argument_object\r\n(obj_desc, walk_state));\r\n}\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nacpi_status\r\nacpi_ds_create_operands(struct acpi_walk_state *walk_state,\r\nunion acpi_parse_object *first_arg)\r\n{\r\nacpi_status status = AE_OK;\r\nunion acpi_parse_object *arg;\r\nunion acpi_parse_object *arguments[ACPI_OBJ_NUM_OPERANDS];\r\nu32 arg_count = 0;\r\nu32 index = walk_state->num_operands;\r\nu32 i;\r\nACPI_FUNCTION_TRACE_PTR(ds_create_operands, first_arg);\r\narg = first_arg;\r\nwhile (arg) {\r\nif (index >= ACPI_OBJ_NUM_OPERANDS) {\r\nreturn_ACPI_STATUS(AE_BAD_DATA);\r\n}\r\narguments[index] = arg;\r\nwalk_state->operands[index] = NULL;\r\narg = arg->common.next;\r\narg_count++;\r\nindex++;\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"NumOperands %d, ArgCount %d, Index %d\n",\r\nwalk_state->num_operands, arg_count, index));\r\nindex--;\r\nfor (i = 0; i < arg_count; i++) {\r\narg = arguments[index];\r\nwalk_state->operand_index = (u8)index;\r\nstatus = acpi_ds_create_operand(walk_state, arg, index);\r\nif (ACPI_FAILURE(status)) {\r\ngoto cleanup;\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"Created Arg #%u (%p) %u args total\n",\r\nindex, arg, arg_count));\r\nindex--;\r\n}\r\nreturn_ACPI_STATUS(status);\r\ncleanup:\r\nacpi_ds_obj_stack_pop_and_delete(arg_count, walk_state);\r\nACPI_EXCEPTION((AE_INFO, status, "While creating Arg %u", index));\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status acpi_ds_evaluate_name_path(struct acpi_walk_state *walk_state)\r\n{\r\nacpi_status status = AE_OK;\r\nunion acpi_parse_object *op = walk_state->op;\r\nunion acpi_operand_object **operand = &walk_state->operands[0];\r\nunion acpi_operand_object *new_obj_desc;\r\nu8 type;\r\nACPI_FUNCTION_TRACE_PTR(ds_evaluate_name_path, walk_state);\r\nif (!op->common.parent) {\r\ngoto exit;\r\n}\r\nif ((op->common.parent->common.aml_opcode == AML_PACKAGE_OP) ||\r\n(op->common.parent->common.aml_opcode == AML_VAR_PACKAGE_OP) ||\r\n(op->common.parent->common.aml_opcode == AML_REF_OF_OP)) {\r\ngoto exit;\r\n}\r\nstatus = acpi_ds_create_operand(walk_state, op, 0);\r\nif (ACPI_FAILURE(status)) {\r\ngoto exit;\r\n}\r\nif (op->common.flags & ACPI_PARSEOP_TARGET) {\r\nnew_obj_desc = *operand;\r\ngoto push_result;\r\n}\r\ntype = (*operand)->common.type;\r\nstatus = acpi_ex_resolve_to_value(operand, walk_state);\r\nif (ACPI_FAILURE(status)) {\r\ngoto exit;\r\n}\r\nif (type == ACPI_TYPE_INTEGER) {\r\nacpi_ut_remove_reference(*operand);\r\nstatus =\r\nacpi_ut_copy_iobject_to_iobject(*operand, &new_obj_desc,\r\nwalk_state);\r\nif (ACPI_FAILURE(status)) {\r\ngoto exit;\r\n}\r\n} else {\r\nnew_obj_desc = *operand;\r\n}\r\nstatus = acpi_ds_obj_stack_pop(1, walk_state);\r\nif (ACPI_FAILURE(status)) {\r\nwalk_state->result_obj = new_obj_desc;\r\ngoto exit;\r\n}\r\npush_result:\r\nwalk_state->result_obj = new_obj_desc;\r\nstatus = acpi_ds_result_push(walk_state->result_obj, walk_state);\r\nif (ACPI_SUCCESS(status)) {\r\nop->common.flags |= ACPI_PARSEOP_IN_STACK;\r\n}\r\nexit:\r\nreturn_ACPI_STATUS(status);\r\n}

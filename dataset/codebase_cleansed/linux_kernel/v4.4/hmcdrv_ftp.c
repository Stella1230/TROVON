static enum hmcdrv_ftp_cmdid hmcdrv_ftp_cmd_getid(const char *cmd, int len)\r\n{\r\nstruct hmcdrv_ftp_cmd_desc {\r\nconst char *str;\r\nenum hmcdrv_ftp_cmdid cmd;\r\n};\r\nstatic const struct hmcdrv_ftp_cmd_desc ftpcmds[7] = {\r\n{.str = "get",\r\n.cmd = HMCDRV_FTP_GET},\r\n{.str = "dir",\r\n.cmd = HMCDRV_FTP_DIR},\r\n{.str = "delete",\r\n.cmd = HMCDRV_FTP_DELETE},\r\n{.str = "nls",\r\n.cmd = HMCDRV_FTP_NLIST},\r\n{.str = "put",\r\n.cmd = HMCDRV_FTP_PUT},\r\n{.str = "append",\r\n.cmd = HMCDRV_FTP_APPEND},\r\n{.str = NULL}\r\n};\r\nconst struct hmcdrv_ftp_cmd_desc *pdesc;\r\nu16 crc = 0xffffU;\r\nif (len == 0)\r\nreturn HMCDRV_FTP_NOOP;\r\ncrc = crc16(crc, cmd, len);\r\npdesc = ftpcmds + (crc % ARRAY_SIZE(ftpcmds));\r\npr_debug("FTP command '%s' has CRC 0x%04x, at table pos. %lu\n",\r\ncmd, crc, (crc % ARRAY_SIZE(ftpcmds)));\r\nif (!pdesc->str || strncmp(pdesc->str, cmd, len))\r\nreturn HMCDRV_FTP_NOOP;\r\npr_debug("FTP command '%s' found, with ID %d\n",\r\npdesc->str, pdesc->cmd);\r\nreturn pdesc->cmd;\r\n}\r\nstatic int hmcdrv_ftp_parse(char *cmd, struct hmcdrv_ftp_cmdspec *ftp)\r\n{\r\nchar *start;\r\nint argc = 0;\r\nftp->id = HMCDRV_FTP_NOOP;\r\nftp->fname = NULL;\r\nwhile (*cmd != '\0') {\r\nwhile (isspace(*cmd))\r\n++cmd;\r\nif (*cmd == '\0')\r\nbreak;\r\nstart = cmd;\r\nswitch (argc) {\r\ncase 0:\r\nwhile ((*cmd != '\0') && !isspace(*cmd))\r\n++cmd;\r\nftp->id = hmcdrv_ftp_cmd_getid(start, cmd - start);\r\nbreak;\r\ncase 1:\r\nwhile ((*cmd != '\0') && !iscntrl(*cmd))\r\n++cmd;\r\nftp->fname = start;\r\ndefault:\r\n*cmd = '\0';\r\nbreak;\r\n}\r\n++argc;\r\n}\r\nif (!ftp->fname || (ftp->id == HMCDRV_FTP_NOOP))\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nssize_t hmcdrv_ftp_do(const struct hmcdrv_ftp_cmdspec *ftp)\r\n{\r\nssize_t len;\r\nmutex_lock(&hmcdrv_ftp_mutex);\r\nif (hmcdrv_ftp_funcs && hmcdrv_ftp_refcnt) {\r\npr_debug("starting transfer, cmd %d for '%s' at %lld with %zd bytes\n",\r\nftp->id, ftp->fname, (long long) ftp->ofs, ftp->len);\r\nlen = hmcdrv_cache_cmd(ftp, hmcdrv_ftp_funcs->transfer);\r\n} else {\r\nlen = -ENXIO;\r\n}\r\nmutex_unlock(&hmcdrv_ftp_mutex);\r\nreturn len;\r\n}\r\nint hmcdrv_ftp_probe(void)\r\n{\r\nint rc;\r\nstruct hmcdrv_ftp_cmdspec ftp = {\r\n.id = HMCDRV_FTP_NOOP,\r\n.ofs = 0,\r\n.fname = "",\r\n.len = PAGE_SIZE\r\n};\r\nftp.buf = (void *) get_zeroed_page(GFP_KERNEL | GFP_DMA);\r\nif (!ftp.buf)\r\nreturn -ENOMEM;\r\nrc = hmcdrv_ftp_startup();\r\nif (rc)\r\ngoto out;\r\nrc = hmcdrv_ftp_do(&ftp);\r\nhmcdrv_ftp_shutdown();\r\nswitch (rc) {\r\ncase -ENOENT:\r\ncase -EBUSY:\r\nrc = 0;\r\nbreak;\r\ndefault:\r\nif (rc > 0)\r\nrc = 0;\r\nbreak;\r\n}\r\nout:\r\nfree_page((unsigned long) ftp.buf);\r\nreturn rc;\r\n}\r\nssize_t hmcdrv_ftp_cmd(char __kernel *cmd, loff_t offset,\r\nchar __user *buf, size_t len)\r\n{\r\nint order;\r\nstruct hmcdrv_ftp_cmdspec ftp = {.len = len, .ofs = offset};\r\nssize_t retlen = hmcdrv_ftp_parse(cmd, &ftp);\r\nif (retlen)\r\nreturn retlen;\r\norder = get_order(ftp.len);\r\nftp.buf = (void *) __get_free_pages(GFP_KERNEL | GFP_DMA, order);\r\nif (!ftp.buf)\r\nreturn -ENOMEM;\r\nswitch (ftp.id) {\r\ncase HMCDRV_FTP_DIR:\r\ncase HMCDRV_FTP_NLIST:\r\ncase HMCDRV_FTP_GET:\r\nretlen = hmcdrv_ftp_do(&ftp);\r\nif ((retlen >= 0) &&\r\ncopy_to_user(buf, ftp.buf, retlen))\r\nretlen = -EFAULT;\r\nbreak;\r\ncase HMCDRV_FTP_PUT:\r\ncase HMCDRV_FTP_APPEND:\r\nif (!copy_from_user(ftp.buf, buf, ftp.len))\r\nretlen = hmcdrv_ftp_do(&ftp);\r\nelse\r\nretlen = -EFAULT;\r\nbreak;\r\ncase HMCDRV_FTP_DELETE:\r\nretlen = hmcdrv_ftp_do(&ftp);\r\nbreak;\r\ndefault:\r\nretlen = -EOPNOTSUPP;\r\nbreak;\r\n}\r\nfree_pages((unsigned long) ftp.buf, order);\r\nreturn retlen;\r\n}\r\nint hmcdrv_ftp_startup(void)\r\n{\r\nstatic struct hmcdrv_ftp_ops hmcdrv_ftp_zvm = {\r\n.startup = diag_ftp_startup,\r\n.shutdown = diag_ftp_shutdown,\r\n.transfer = diag_ftp_cmd\r\n};\r\nstatic struct hmcdrv_ftp_ops hmcdrv_ftp_lpar = {\r\n.startup = sclp_ftp_startup,\r\n.shutdown = sclp_ftp_shutdown,\r\n.transfer = sclp_ftp_cmd\r\n};\r\nint rc = 0;\r\nmutex_lock(&hmcdrv_ftp_mutex);\r\nif (hmcdrv_ftp_refcnt == 0) {\r\nif (MACHINE_IS_VM)\r\nhmcdrv_ftp_funcs = &hmcdrv_ftp_zvm;\r\nelse if (MACHINE_IS_LPAR || MACHINE_IS_KVM)\r\nhmcdrv_ftp_funcs = &hmcdrv_ftp_lpar;\r\nelse\r\nrc = -EOPNOTSUPP;\r\nif (hmcdrv_ftp_funcs)\r\nrc = hmcdrv_ftp_funcs->startup();\r\n}\r\nif (!rc)\r\n++hmcdrv_ftp_refcnt;\r\nmutex_unlock(&hmcdrv_ftp_mutex);\r\nreturn rc;\r\n}\r\nvoid hmcdrv_ftp_shutdown(void)\r\n{\r\nmutex_lock(&hmcdrv_ftp_mutex);\r\n--hmcdrv_ftp_refcnt;\r\nif ((hmcdrv_ftp_refcnt == 0) && hmcdrv_ftp_funcs)\r\nhmcdrv_ftp_funcs->shutdown();\r\nmutex_unlock(&hmcdrv_ftp_mutex);\r\n}

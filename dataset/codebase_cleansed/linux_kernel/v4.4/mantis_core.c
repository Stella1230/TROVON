static int read_eeprom_byte(struct mantis_pci *mantis, u8 *data, u8 length)\r\n{\r\nint err;\r\nstruct i2c_msg msg[] = {\r\n{\r\n.addr = 0x50,\r\n.flags = 0,\r\n.buf = data,\r\n.len = 1\r\n}, {\r\n.addr = 0x50,\r\n.flags = I2C_M_RD,\r\n.buf = data,\r\n.len = length\r\n},\r\n};\r\nerr = i2c_transfer(&mantis->adapter, msg, 2);\r\nif (err < 0) {\r\ndprintk(verbose, MANTIS_ERROR, 1,\r\n"ERROR: i2c read: < err=%i d0=0x%02x d1=0x%02x >",\r\nerr, data[0], data[1]);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int get_mac_address(struct mantis_pci *mantis)\r\n{\r\nint err;\r\nmantis->mac_address[0] = 0x08;\r\nerr = read_eeprom_byte(mantis, &mantis->mac_address[0], 6);\r\nif (err < 0) {\r\ndprintk(verbose, MANTIS_ERROR, 1, "Mantis EEPROM read error");\r\nreturn err;\r\n}\r\ndprintk(verbose, MANTIS_ERROR, 0,\r\n" MAC Address=[%pM]\n", mantis->mac_address);\r\nreturn 0;\r\n}\r\nstatic void mantis_load_config(struct mantis_pci *mantis)\r\n{\r\nswitch (mantis->subsystem_device) {\r\ncase MANTIS_VP_1033_DVB_S:\r\nmantis->hwconfig = &vp1033_mantis_config;\r\nbreak;\r\ncase MANTIS_VP_1034_DVB_S:\r\nmantis->hwconfig = &vp1034_mantis_config;\r\nbreak;\r\ncase MANTIS_VP_1041_DVB_S2:\r\ncase TECHNISAT_SKYSTAR_HD2:\r\nmantis->hwconfig = &vp1041_mantis_config;\r\nbreak;\r\ncase MANTIS_VP_2033_DVB_C:\r\nmantis->hwconfig = &vp2033_mantis_config;\r\nbreak;\r\ncase MANTIS_VP_2040_DVB_C:\r\ncase CINERGY_C:\r\ncase TECHNISAT_CABLESTAR_HD2:\r\nmantis->hwconfig = &vp2040_mantis_config;\r\nbreak;\r\ncase MANTIS_VP_3030_DVB_T:\r\nmantis->hwconfig = &vp3030_mantis_config;\r\nbreak;\r\ndefault:\r\nmantis->hwconfig = &unknown_device;\r\nbreak;\r\n}\r\n}\r\nint mantis_core_init(struct mantis_pci *mantis)\r\n{\r\nint err = 0;\r\nmantis_load_config(mantis);\r\ndprintk(verbose, MANTIS_ERROR, 0, "found a %s PCI %s device on (%02x:%02x.%x),\n",\r\nmantis->hwconfig->model_name, mantis->hwconfig->dev_type,\r\nmantis->pdev->bus->number, PCI_SLOT(mantis->pdev->devfn), PCI_FUNC(mantis->pdev->devfn));\r\ndprintk(verbose, MANTIS_ERROR, 0, " Mantis Rev %d [%04x:%04x], ",\r\nmantis->revision,\r\nmantis->subsystem_vendor, mantis->subsystem_device);\r\ndprintk(verbose, MANTIS_ERROR, 0,\r\n"irq: %d, latency: %d\n memory: 0x%lx, mmio: 0x%p\n",\r\nmantis->pdev->irq, mantis->latency,\r\nmantis->mantis_addr, mantis->mantis_mmio);\r\nerr = mantis_i2c_init(mantis);\r\nif (err < 0) {\r\ndprintk(verbose, MANTIS_ERROR, 1, "Mantis I2C init failed");\r\nreturn err;\r\n}\r\nerr = get_mac_address(mantis);\r\nif (err < 0) {\r\ndprintk(verbose, MANTIS_ERROR, 1, "get MAC address failed");\r\nreturn err;\r\n}\r\nerr = mantis_dma_init(mantis);\r\nif (err < 0) {\r\ndprintk(verbose, MANTIS_ERROR, 1, "Mantis DMA init failed");\r\nreturn err;\r\n}\r\nerr = mantis_dvb_init(mantis);\r\nif (err < 0) {\r\ndprintk(verbose, MANTIS_DEBUG, 1, "Mantis DVB init failed");\r\nreturn err;\r\n}\r\nerr = mantis_uart_init(mantis);\r\nif (err < 0) {\r\ndprintk(verbose, MANTIS_DEBUG, 1, "Mantis UART init failed");\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nint mantis_core_exit(struct mantis_pci *mantis)\r\n{\r\nmantis_dma_stop(mantis);\r\ndprintk(verbose, MANTIS_ERROR, 1, "DMA engine stopping");\r\nmantis_uart_exit(mantis);\r\ndprintk(verbose, MANTIS_ERROR, 1, "UART exit failed");\r\nif (mantis_dma_exit(mantis) < 0)\r\ndprintk(verbose, MANTIS_ERROR, 1, "DMA exit failed");\r\nif (mantis_dvb_exit(mantis) < 0)\r\ndprintk(verbose, MANTIS_ERROR, 1, "DVB exit failed");\r\nif (mantis_i2c_exit(mantis) < 0)\r\ndprintk(verbose, MANTIS_ERROR, 1, "I2C adapter delete.. failed");\r\nreturn 0;\r\n}\r\nvoid gpio_set_bits(struct mantis_pci *mantis, u32 bitpos, u8 value)\r\n{\r\nu32 cur;\r\ncur = mmread(MANTIS_GPIF_ADDR);\r\nif (value)\r\nmantis->gpio_status = cur | (1 << bitpos);\r\nelse\r\nmantis->gpio_status = cur & (~(1 << bitpos));\r\nmmwrite(mantis->gpio_status, MANTIS_GPIF_ADDR);\r\nmmwrite(0x00, MANTIS_GPIF_DOUT);\r\nudelay(100);\r\n}\r\nvoid mantis_set_direction(struct mantis_pci *mantis, int direction)\r\n{\r\nu32 reg;\r\nreg = mmread(0x28);\r\ndprintk(verbose, MANTIS_DEBUG, 1, "TS direction setup");\r\nif (direction == 0x01) {\r\nreg |= 0x04;\r\nmmwrite(reg, 0x28);\r\nreg &= 0xff - 0x04;\r\nmmwrite(reg, 0x28);\r\n} else {\r\nreg &= 0xff - 0x04;\r\nmmwrite(reg, 0x28);\r\nreg |= 0x04;\r\nmmwrite(reg, 0x28);\r\n}\r\n}

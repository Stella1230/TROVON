static ssize_t wilc_debug_level_read(struct file *file, char __user *userbuf, size_t count, loff_t *ppos)\r\n{\r\nchar buf[128];\r\nint res = 0;\r\nif (*ppos > 0)\r\nreturn 0;\r\nres = scnprintf(buf, sizeof(buf), "Debug Level: %x\n", atomic_read(&DEBUG_LEVEL));\r\nreturn simple_read_from_buffer(userbuf, count, ppos, buf, res);\r\n}\r\nstatic ssize_t wilc_debug_level_write(struct file *filp, const char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nint flag = 0;\r\nint ret;\r\nret = kstrtouint_from_user(buf, count, 16, &flag);\r\nif (ret)\r\nreturn ret;\r\nif (flag > DBG_LEVEL_ALL) {\r\nprintk("%s, value (0x%08x) is out of range, stay previous flag (0x%08x)\n", __func__, flag, atomic_read(&DEBUG_LEVEL));\r\nreturn -EINVAL;\r\n}\r\natomic_set(&DEBUG_LEVEL, (int)flag);\r\nif (flag == 0)\r\nprintk("Debug-level disabled\n");\r\nelse\r\nprintk("Debug-level enabled\n");\r\nreturn count;\r\n}\r\nstatic ssize_t wilc_debug_region_read(struct file *file, char __user *userbuf, size_t count, loff_t *ppos)\r\n{\r\nchar buf[128];\r\nint res = 0;\r\nif (*ppos > 0)\r\nreturn 0;\r\nres = scnprintf(buf, sizeof(buf), "Debug region: %x\n", atomic_read(&REGION));\r\nreturn simple_read_from_buffer(userbuf, count, ppos, buf, res);\r\n}\r\nstatic ssize_t wilc_debug_region_write(struct file *filp, const char *buf, size_t count, loff_t *ppos)\r\n{\r\nchar buffer[128] = {};\r\nint flag;\r\nif (count > sizeof(buffer))\r\nreturn -EINVAL;\r\nif (copy_from_user(buffer, buf, count)) {\r\nreturn -EFAULT;\r\n}\r\nflag = buffer[0] - '0';\r\nif (flag > DBG_REGION_ALL) {\r\nprintk("%s, value (0x%08x) is out of range, stay previous flag (0x%08x)\n", __func__, flag, atomic_read(&REGION));\r\nreturn -EFAULT;\r\n}\r\natomic_set(&REGION, (int)flag);\r\nprintk("new debug-region is %x\n", atomic_read(&REGION));\r\nreturn count;\r\n}\r\nint wilc_debugfs_init(void)\r\n{\r\nint i;\r\nstruct dentry *debugfs_files;\r\nstruct wilc_debugfs_info_t *info;\r\nwilc_dir = debugfs_create_dir("wilc_wifi", NULL);\r\nif (wilc_dir == ERR_PTR(-ENODEV)) {\r\nprintk("ERR, kernel has built without debugfs support\n");\r\nreturn 0;\r\n}\r\nif (!wilc_dir) {\r\nprintk("ERR, debugfs create dir\n");\r\nreturn -1;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(debugfs_info); i++) {\r\ninfo = &debugfs_info[i];\r\ndebugfs_files = debugfs_create_file(info->name,\r\ninfo->perm,\r\nwilc_dir,\r\n&info->data,\r\n&info->fops);\r\nif (!debugfs_files) {\r\nprintk("ERR fail to create the debugfs file, %s\n", info->name);\r\ndebugfs_remove_recursive(wilc_dir);\r\nreturn -1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nvoid wilc_debugfs_remove(void)\r\n{\r\ndebugfs_remove_recursive(wilc_dir);\r\n}

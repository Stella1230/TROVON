static int da9063_clear_fault_log(struct da9063 *da9063)\r\n{\r\nint ret = 0;\r\nint fault_log = 0;\r\nret = regmap_read(da9063->regmap, DA9063_REG_FAULT_LOG, &fault_log);\r\nif (ret < 0) {\r\ndev_err(da9063->dev, "Cannot read FAULT_LOG.\n");\r\nreturn -EIO;\r\n}\r\nif (fault_log) {\r\nif (fault_log & DA9063_TWD_ERROR)\r\ndev_dbg(da9063->dev,\r\n"Fault log entry detected: DA9063_TWD_ERROR\n");\r\nif (fault_log & DA9063_POR)\r\ndev_dbg(da9063->dev,\r\n"Fault log entry detected: DA9063_POR\n");\r\nif (fault_log & DA9063_VDD_FAULT)\r\ndev_dbg(da9063->dev,\r\n"Fault log entry detected: DA9063_VDD_FAULT\n");\r\nif (fault_log & DA9063_VDD_START)\r\ndev_dbg(da9063->dev,\r\n"Fault log entry detected: DA9063_VDD_START\n");\r\nif (fault_log & DA9063_TEMP_CRIT)\r\ndev_dbg(da9063->dev,\r\n"Fault log entry detected: DA9063_TEMP_CRIT\n");\r\nif (fault_log & DA9063_KEY_RESET)\r\ndev_dbg(da9063->dev,\r\n"Fault log entry detected: DA9063_KEY_RESET\n");\r\nif (fault_log & DA9063_NSHUTDOWN)\r\ndev_dbg(da9063->dev,\r\n"Fault log entry detected: DA9063_NSHUTDOWN\n");\r\nif (fault_log & DA9063_WAIT_SHUT)\r\ndev_dbg(da9063->dev,\r\n"Fault log entry detected: DA9063_WAIT_SHUT\n");\r\n}\r\nret = regmap_write(da9063->regmap,\r\nDA9063_REG_FAULT_LOG,\r\nfault_log);\r\nif (ret < 0)\r\ndev_err(da9063->dev,\r\n"Cannot reset FAULT_LOG values %d\n", ret);\r\nreturn ret;\r\n}\r\nint da9063_device_init(struct da9063 *da9063, unsigned int irq)\r\n{\r\nstruct da9063_pdata *pdata = da9063->dev->platform_data;\r\nint model, variant_id, variant_code;\r\nint ret;\r\nret = da9063_clear_fault_log(da9063);\r\nif (ret < 0)\r\ndev_err(da9063->dev, "Cannot clear fault log\n");\r\nif (pdata) {\r\nda9063->flags = pdata->flags;\r\nda9063->irq_base = pdata->irq_base;\r\n} else {\r\nda9063->flags = 0;\r\nda9063->irq_base = -1;\r\n}\r\nda9063->chip_irq = irq;\r\nif (pdata && pdata->init != NULL) {\r\nret = pdata->init(da9063);\r\nif (ret != 0) {\r\ndev_err(da9063->dev,\r\n"Platform initialization failed.\n");\r\nreturn ret;\r\n}\r\n}\r\nret = regmap_read(da9063->regmap, DA9063_REG_CHIP_ID, &model);\r\nif (ret < 0) {\r\ndev_err(da9063->dev, "Cannot read chip model id.\n");\r\nreturn -EIO;\r\n}\r\nif (model != PMIC_DA9063) {\r\ndev_err(da9063->dev, "Invalid chip model id: 0x%02x\n", model);\r\nreturn -ENODEV;\r\n}\r\nret = regmap_read(da9063->regmap, DA9063_REG_CHIP_VARIANT, &variant_id);\r\nif (ret < 0) {\r\ndev_err(da9063->dev, "Cannot read chip variant id.\n");\r\nreturn -EIO;\r\n}\r\nvariant_code = variant_id >> DA9063_CHIP_VARIANT_SHIFT;\r\ndev_info(da9063->dev,\r\n"Device detected (chip-ID: 0x%02X, var-ID: 0x%02X)\n",\r\nmodel, variant_id);\r\nif (variant_code < PMIC_DA9063_BB && variant_code != PMIC_DA9063_AD) {\r\ndev_err(da9063->dev,\r\n"Cannot support variant code: 0x%02X\n", variant_code);\r\nreturn -ENODEV;\r\n}\r\nda9063->model = model;\r\nda9063->variant_code = variant_code;\r\nret = da9063_irq_init(da9063);\r\nif (ret) {\r\ndev_err(da9063->dev, "Cannot initialize interrupts.\n");\r\nreturn ret;\r\n}\r\nda9063->irq_base = regmap_irq_chip_get_base(da9063->regmap_irq);\r\nret = mfd_add_devices(da9063->dev, -1, da9063_devs,\r\nARRAY_SIZE(da9063_devs), NULL, da9063->irq_base,\r\nNULL);\r\nif (ret)\r\ndev_err(da9063->dev, "Cannot add MFD cells\n");\r\nreturn ret;\r\n}\r\nvoid da9063_device_exit(struct da9063 *da9063)\r\n{\r\nmfd_remove_devices(da9063->dev);\r\nda9063_irq_exit(da9063);\r\n}

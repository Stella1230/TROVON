int balloon3_has(enum balloon3_features feature)\r\n{\r\nreturn (balloon3_features_present & (1 << feature)) ? 1 : 0;\r\n}\r\nint __init parse_balloon3_features(char *arg)\r\n{\r\nif (!arg)\r\nreturn 0;\r\nreturn kstrtoul(arg, 0, &balloon3_features_present);\r\n}\r\nstatic void __init balloon3_cf_init(void)\r\n{\r\nif (!balloon3_has(BALLOON3_FEATURE_CF))\r\nreturn;\r\npxa2xx_mfp_config(ARRAY_AND_SIZE(balloon3_cf_pin_config));\r\n}\r\nstatic inline void balloon3_cf_init(void) {}\r\nstatic void __init balloon3_nor_init(void)\r\n{\r\nplatform_device_register(&balloon3_flash);\r\n}\r\nstatic inline void balloon3_nor_init(void) {}\r\nstatic void __init balloon3_ts_init(void)\r\n{\r\nif (!balloon3_has(BALLOON3_FEATURE_AUDIO))\r\nreturn;\r\npxa2xx_mfp_config(ARRAY_AND_SIZE(balloon3_ac97_pin_config));\r\npxa_set_ac97_info(NULL);\r\nplatform_device_register(&balloon3_ucb1400_device);\r\n}\r\nstatic inline void balloon3_ts_init(void) {}\r\nstatic void balloon3_backlight_power(int on)\r\n{\r\ngpio_set_value(BALLOON3_GPIO_RUN_BACKLIGHT, on);\r\n}\r\nstatic void __init balloon3_lcd_init(void)\r\n{\r\nint ret;\r\nif (!balloon3_has(BALLOON3_FEATURE_TOPPOLY))\r\nreturn;\r\npxa2xx_mfp_config(ARRAY_AND_SIZE(balloon3_lcd_pin_config));\r\nret = gpio_request(BALLOON3_GPIO_RUN_BACKLIGHT, "BKL-ON");\r\nif (ret) {\r\npr_err("Requesting BKL-ON GPIO failed!\n");\r\ngoto err;\r\n}\r\nret = gpio_direction_output(BALLOON3_GPIO_RUN_BACKLIGHT, 1);\r\nif (ret) {\r\npr_err("Setting BKL-ON GPIO direction failed!\n");\r\ngoto err2;\r\n}\r\nballoon3_lcd_screen.pxafb_backlight_power = balloon3_backlight_power;\r\npxa_set_fb_info(NULL, &balloon3_lcd_screen);\r\nreturn;\r\nerr2:\r\ngpio_free(BALLOON3_GPIO_RUN_BACKLIGHT);\r\nerr:\r\nreturn;\r\n}\r\nstatic inline void balloon3_lcd_init(void) {}\r\nstatic void __init balloon3_mmc_init(void)\r\n{\r\npxa2xx_mfp_config(ARRAY_AND_SIZE(balloon3_mmc_pin_config));\r\npxa_set_mci_info(&balloon3_mci_platform_data);\r\n}\r\nstatic inline void balloon3_mmc_init(void) {}\r\nstatic void balloon3_udc_command(int cmd)\r\n{\r\nif (cmd == PXA2XX_UDC_CMD_CONNECT)\r\nUP2OCR |= UP2OCR_DPPUE | UP2OCR_DPPUBE;\r\nelse if (cmd == PXA2XX_UDC_CMD_DISCONNECT)\r\nUP2OCR &= ~UP2OCR_DPPUE;\r\n}\r\nstatic int balloon3_udc_is_connected(void)\r\n{\r\nreturn 1;\r\n}\r\nstatic void __init balloon3_udc_init(void)\r\n{\r\npxa_set_udc_info(&balloon3_udc_info);\r\n}\r\nstatic inline void balloon3_udc_init(void) {}\r\nstatic void __init balloon3_irda_init(void)\r\n{\r\npxa_set_ficp_info(&balloon3_ficp_platform_data);\r\n}\r\nstatic inline void balloon3_irda_init(void) {}\r\nstatic void __init balloon3_uhc_init(void)\r\n{\r\nif (!balloon3_has(BALLOON3_FEATURE_OHCI))\r\nreturn;\r\npxa2xx_mfp_config(ARRAY_AND_SIZE(balloon3_uhc_pin_config));\r\npxa_set_ohci_info(&balloon3_ohci_info);\r\n}\r\nstatic inline void balloon3_uhc_init(void) {}\r\nstatic void __init balloon3_leds_init(void)\r\n{\r\npxa2xx_mfp_config(ARRAY_AND_SIZE(balloon3_led_pin_config));\r\nplatform_device_register(&balloon3_leds);\r\nplatform_device_register(&balloon3_pcf_leds);\r\n}\r\nstatic inline void balloon3_leds_init(void) {}\r\nstatic void balloon3_mask_irq(struct irq_data *d)\r\n{\r\nint balloon3_irq = (d->irq - BALLOON3_IRQ(0));\r\nballoon3_irq_enabled &= ~(1 << balloon3_irq);\r\n__raw_writel(~balloon3_irq_enabled, BALLOON3_INT_CONTROL_REG);\r\n}\r\nstatic void balloon3_unmask_irq(struct irq_data *d)\r\n{\r\nint balloon3_irq = (d->irq - BALLOON3_IRQ(0));\r\nballoon3_irq_enabled |= (1 << balloon3_irq);\r\n__raw_writel(~balloon3_irq_enabled, BALLOON3_INT_CONTROL_REG);\r\n}\r\nstatic void balloon3_irq_handler(struct irq_desc *desc)\r\n{\r\nunsigned long pending = __raw_readl(BALLOON3_INT_CONTROL_REG) &\r\nballoon3_irq_enabled;\r\ndo {\r\nstruct irq_data *d = irq_desc_get_irq_data(desc);\r\nstruct irq_chip *chip = irq_desc_get_chip(desc);\r\nunsigned int irq;\r\nif (chip->irq_ack)\r\nchip->irq_ack(d);\r\nwhile (pending) {\r\nirq = BALLOON3_IRQ(0) + __ffs(pending);\r\ngeneric_handle_irq(irq);\r\npending &= pending - 1;\r\n}\r\npending = __raw_readl(BALLOON3_INT_CONTROL_REG) &\r\nballoon3_irq_enabled;\r\n} while (pending);\r\n}\r\nstatic void __init balloon3_init_irq(void)\r\n{\r\nint irq;\r\npxa27x_init_irq();\r\nfor (irq = BALLOON3_IRQ(0); irq <= BALLOON3_IRQ(7); irq++) {\r\nirq_set_chip_and_handler(irq, &balloon3_irq_chip,\r\nhandle_level_irq);\r\nirq_clear_status_flags(irq, IRQ_NOREQUEST | IRQ_NOPROBE);\r\n}\r\nirq_set_chained_handler(BALLOON3_AUX_NIRQ, balloon3_irq_handler);\r\nirq_set_irq_type(BALLOON3_AUX_NIRQ, IRQ_TYPE_EDGE_FALLING);\r\npr_debug("%s: chained handler installed - irq %d automatically "\r\n"enabled\n", __func__, BALLOON3_AUX_NIRQ);\r\n}\r\nstatic void __init balloon3_i2c_init(void)\r\n{\r\npxa_set_i2c_info(NULL);\r\ni2c_register_board_info(0, ARRAY_AND_SIZE(balloon3_i2c_devs));\r\n}\r\nstatic inline void balloon3_i2c_init(void) {}\r\nstatic void balloon3_nand_cmd_ctl(struct mtd_info *mtd, int cmd, unsigned int ctrl)\r\n{\r\nstruct nand_chip *this = mtd->priv;\r\nuint8_t balloon3_ctl_set = 0, balloon3_ctl_clr = 0;\r\nif (ctrl & NAND_CTRL_CHANGE) {\r\nif (ctrl & NAND_CLE)\r\nballoon3_ctl_set |= BALLOON3_NAND_CONTROL_FLCLE;\r\nelse\r\nballoon3_ctl_clr |= BALLOON3_NAND_CONTROL_FLCLE;\r\nif (ctrl & NAND_ALE)\r\nballoon3_ctl_set |= BALLOON3_NAND_CONTROL_FLALE;\r\nelse\r\nballoon3_ctl_clr |= BALLOON3_NAND_CONTROL_FLALE;\r\nif (balloon3_ctl_clr)\r\n__raw_writel(balloon3_ctl_clr,\r\nBALLOON3_NAND_CONTROL_REG);\r\nif (balloon3_ctl_set)\r\n__raw_writel(balloon3_ctl_set,\r\nBALLOON3_NAND_CONTROL_REG +\r\nBALLOON3_FPGA_SETnCLR);\r\n}\r\nif (cmd != NAND_CMD_NONE)\r\nwriteb(cmd, this->IO_ADDR_W);\r\n}\r\nstatic void balloon3_nand_select_chip(struct mtd_info *mtd, int chip)\r\n{\r\nif (chip < 0 || chip > 3)\r\nreturn;\r\n__raw_writew(\r\nBALLOON3_NAND_CONTROL_FLCE0 | BALLOON3_NAND_CONTROL_FLCE1 |\r\nBALLOON3_NAND_CONTROL_FLCE2 | BALLOON3_NAND_CONTROL_FLCE3,\r\nBALLOON3_NAND_CONTROL_REG + BALLOON3_FPGA_SETnCLR);\r\n__raw_writew(BALLOON3_NAND_CONTROL_FLCE0 << chip,\r\nBALLOON3_NAND_CONTROL_REG);\r\n}\r\nstatic int balloon3_nand_dev_ready(struct mtd_info *mtd)\r\n{\r\nreturn __raw_readl(BALLOON3_NAND_STAT_REG) & BALLOON3_NAND_STAT_RNB;\r\n}\r\nstatic int balloon3_nand_probe(struct platform_device *pdev)\r\n{\r\nuint16_t ver;\r\nint ret;\r\n__raw_writew(BALLOON3_NAND_CONTROL2_16BIT,\r\nBALLOON3_NAND_CONTROL2_REG + BALLOON3_FPGA_SETnCLR);\r\nver = __raw_readw(BALLOON3_FPGA_VER);\r\nif (ver < 0x4f08)\r\npr_warn("The FPGA code, version 0x%04x, is too old. "\r\n"NAND support might be broken in this version!", ver);\r\nret = gpio_request(BALLOON3_GPIO_RUN_NAND, "NAND");\r\nif (ret)\r\ngoto err1;\r\nret = gpio_direction_output(BALLOON3_GPIO_RUN_NAND, 1);\r\nif (ret)\r\ngoto err2;\r\ngpio_set_value(BALLOON3_GPIO_RUN_NAND, 1);\r\n__raw_writel(\r\nBALLOON3_NAND_CONTROL_FLCE0 | BALLOON3_NAND_CONTROL_FLCE1 |\r\nBALLOON3_NAND_CONTROL_FLCE2 | BALLOON3_NAND_CONTROL_FLCE3 |\r\nBALLOON3_NAND_CONTROL_FLWP,\r\nBALLOON3_NAND_CONTROL_REG + BALLOON3_FPGA_SETnCLR);\r\nreturn 0;\r\nerr2:\r\ngpio_free(BALLOON3_GPIO_RUN_NAND);\r\nerr1:\r\nreturn ret;\r\n}\r\nstatic void balloon3_nand_remove(struct platform_device *pdev)\r\n{\r\ngpio_set_value(BALLOON3_GPIO_RUN_NAND, 0);\r\ngpio_free(BALLOON3_GPIO_RUN_NAND);\r\n}\r\nstatic void __init balloon3_nand_init(void)\r\n{\r\nplatform_device_register(&balloon3_nand);\r\n}\r\nstatic inline void balloon3_nand_init(void) {}\r\nstatic void __init balloon3_pmic_init(void)\r\n{\r\npxa27x_set_i2c_power_info(NULL);\r\ni2c_register_board_info(1, ARRAY_AND_SIZE(balloon3_pi2c_board_info));\r\n}\r\nstatic inline void balloon3_pmic_init(void) {}\r\nstatic void __init balloon3_init(void)\r\n{\r\nARB_CNTRL = ARB_CORE_PARK | 0x234;\r\npxa2xx_mfp_config(ARRAY_AND_SIZE(balloon3_pin_config));\r\npxa_set_ffuart_info(NULL);\r\npxa_set_btuart_info(NULL);\r\npxa_set_stuart_info(NULL);\r\nballoon3_i2c_init();\r\nballoon3_irda_init();\r\nballoon3_lcd_init();\r\nballoon3_leds_init();\r\nballoon3_mmc_init();\r\nballoon3_nand_init();\r\nballoon3_nor_init();\r\nballoon3_pmic_init();\r\nballoon3_ts_init();\r\nballoon3_udc_init();\r\nballoon3_uhc_init();\r\nballoon3_cf_init();\r\n}\r\nstatic void __init balloon3_map_io(void)\r\n{\r\npxa27x_map_io();\r\niotable_init(balloon3_io_desc, ARRAY_SIZE(balloon3_io_desc));\r\n}

static int bochsfb_mmap(struct fb_info *info,\r\nstruct vm_area_struct *vma)\r\n{\r\nstruct drm_fb_helper *fb_helper = info->par;\r\nstruct bochs_device *bochs =\r\ncontainer_of(fb_helper, struct bochs_device, fb.helper);\r\nstruct bochs_bo *bo = gem_to_bochs_bo(bochs->fb.gfb.obj);\r\nreturn ttm_fbdev_mmap(vma, &bo->bo);\r\n}\r\nstatic int bochsfb_create_object(struct bochs_device *bochs,\r\nstruct drm_mode_fb_cmd2 *mode_cmd,\r\nstruct drm_gem_object **gobj_p)\r\n{\r\nstruct drm_device *dev = bochs->dev;\r\nstruct drm_gem_object *gobj;\r\nu32 size;\r\nint ret = 0;\r\nsize = mode_cmd->pitches[0] * mode_cmd->height;\r\nret = bochs_gem_create(dev, size, true, &gobj);\r\nif (ret)\r\nreturn ret;\r\n*gobj_p = gobj;\r\nreturn ret;\r\n}\r\nstatic int bochsfb_create(struct drm_fb_helper *helper,\r\nstruct drm_fb_helper_surface_size *sizes)\r\n{\r\nstruct bochs_device *bochs =\r\ncontainer_of(helper, struct bochs_device, fb.helper);\r\nstruct fb_info *info;\r\nstruct drm_framebuffer *fb;\r\nstruct drm_mode_fb_cmd2 mode_cmd;\r\nstruct drm_gem_object *gobj = NULL;\r\nstruct bochs_bo *bo = NULL;\r\nint size, ret;\r\nif (sizes->surface_bpp != 32)\r\nreturn -EINVAL;\r\nmode_cmd.width = sizes->surface_width;\r\nmode_cmd.height = sizes->surface_height;\r\nmode_cmd.pitches[0] = mode_cmd.width * ((sizes->surface_bpp + 7) / 8);\r\nmode_cmd.pixel_format = drm_mode_legacy_fb_format(sizes->surface_bpp,\r\nsizes->surface_depth);\r\nsize = mode_cmd.pitches[0] * mode_cmd.height;\r\nret = bochsfb_create_object(bochs, &mode_cmd, &gobj);\r\nif (ret) {\r\nDRM_ERROR("failed to create fbcon backing object %d\n", ret);\r\nreturn ret;\r\n}\r\nbo = gem_to_bochs_bo(gobj);\r\nret = ttm_bo_reserve(&bo->bo, true, false, false, NULL);\r\nif (ret)\r\nreturn ret;\r\nret = bochs_bo_pin(bo, TTM_PL_FLAG_VRAM, NULL);\r\nif (ret) {\r\nDRM_ERROR("failed to pin fbcon\n");\r\nttm_bo_unreserve(&bo->bo);\r\nreturn ret;\r\n}\r\nret = ttm_bo_kmap(&bo->bo, 0, bo->bo.num_pages,\r\n&bo->kmap);\r\nif (ret) {\r\nDRM_ERROR("failed to kmap fbcon\n");\r\nttm_bo_unreserve(&bo->bo);\r\nreturn ret;\r\n}\r\nttm_bo_unreserve(&bo->bo);\r\ninfo = drm_fb_helper_alloc_fbi(helper);\r\nif (IS_ERR(info))\r\nreturn PTR_ERR(info);\r\ninfo->par = &bochs->fb.helper;\r\nret = bochs_framebuffer_init(bochs->dev, &bochs->fb.gfb, &mode_cmd, gobj);\r\nif (ret) {\r\ndrm_fb_helper_release_fbi(helper);\r\nreturn ret;\r\n}\r\nbochs->fb.size = size;\r\nfb = &bochs->fb.gfb.base;\r\nbochs->fb.helper.fb = fb;\r\nstrcpy(info->fix.id, "bochsdrmfb");\r\ninfo->flags = FBINFO_DEFAULT;\r\ninfo->fbops = &bochsfb_ops;\r\ndrm_fb_helper_fill_fix(info, fb->pitches[0], fb->depth);\r\ndrm_fb_helper_fill_var(info, &bochs->fb.helper, sizes->fb_width,\r\nsizes->fb_height);\r\ninfo->screen_base = bo->kmap.virtual;\r\ninfo->screen_size = size;\r\ndrm_vma_offset_remove(&bo->bo.bdev->vma_manager, &bo->bo.vma_node);\r\ninfo->fix.smem_start = 0;\r\ninfo->fix.smem_len = size;\r\nreturn 0;\r\n}\r\nstatic int bochs_fbdev_destroy(struct bochs_device *bochs)\r\n{\r\nstruct bochs_framebuffer *gfb = &bochs->fb.gfb;\r\nDRM_DEBUG_DRIVER("\n");\r\ndrm_fb_helper_unregister_fbi(&bochs->fb.helper);\r\ndrm_fb_helper_release_fbi(&bochs->fb.helper);\r\nif (gfb->obj) {\r\ndrm_gem_object_unreference_unlocked(gfb->obj);\r\ngfb->obj = NULL;\r\n}\r\ndrm_fb_helper_fini(&bochs->fb.helper);\r\ndrm_framebuffer_unregister_private(&gfb->base);\r\ndrm_framebuffer_cleanup(&gfb->base);\r\nreturn 0;\r\n}\r\nvoid bochs_fb_gamma_set(struct drm_crtc *crtc, u16 red, u16 green,\r\nu16 blue, int regno)\r\n{\r\n}\r\nvoid bochs_fb_gamma_get(struct drm_crtc *crtc, u16 *red, u16 *green,\r\nu16 *blue, int regno)\r\n{\r\n*red = regno;\r\n*green = regno;\r\n*blue = regno;\r\n}\r\nint bochs_fbdev_init(struct bochs_device *bochs)\r\n{\r\nint ret;\r\ndrm_fb_helper_prepare(bochs->dev, &bochs->fb.helper,\r\n&bochs_fb_helper_funcs);\r\nret = drm_fb_helper_init(bochs->dev, &bochs->fb.helper,\r\n1, 1);\r\nif (ret)\r\nreturn ret;\r\nret = drm_fb_helper_single_add_all_connectors(&bochs->fb.helper);\r\nif (ret)\r\ngoto fini;\r\ndrm_helper_disable_unused_functions(bochs->dev);\r\nret = drm_fb_helper_initial_config(&bochs->fb.helper, 32);\r\nif (ret)\r\ngoto fini;\r\nbochs->fb.initialized = true;\r\nreturn 0;\r\nfini:\r\ndrm_fb_helper_fini(&bochs->fb.helper);\r\nreturn ret;\r\n}\r\nvoid bochs_fbdev_fini(struct bochs_device *bochs)\r\n{\r\nif (!bochs->fb.initialized)\r\nreturn;\r\nbochs_fbdev_destroy(bochs);\r\nbochs->fb.initialized = false;\r\n}

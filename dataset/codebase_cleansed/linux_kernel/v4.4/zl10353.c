static int zl10353_single_write(struct dvb_frontend *fe, u8 reg, u8 val)\r\n{\r\nstruct zl10353_state *state = fe->demodulator_priv;\r\nu8 buf[2] = { reg, val };\r\nstruct i2c_msg msg = { .addr = state->config.demod_address, .flags = 0,\r\n.buf = buf, .len = 2 };\r\nint err = i2c_transfer(state->i2c, &msg, 1);\r\nif (err != 1) {\r\nprintk("zl10353: write to reg %x failed (err = %d)!\n", reg, err);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int zl10353_write(struct dvb_frontend *fe, const u8 ibuf[], int ilen)\r\n{\r\nint err, i;\r\nfor (i = 0; i < ilen - 1; i++)\r\nif ((err = zl10353_single_write(fe, ibuf[0] + i, ibuf[i + 1])))\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int zl10353_read_register(struct zl10353_state *state, u8 reg)\r\n{\r\nint ret;\r\nu8 b0[1] = { reg };\r\nu8 b1[1] = { 0 };\r\nstruct i2c_msg msg[2] = { { .addr = state->config.demod_address,\r\n.flags = 0,\r\n.buf = b0, .len = 1 },\r\n{ .addr = state->config.demod_address,\r\n.flags = I2C_M_RD,\r\n.buf = b1, .len = 1 } };\r\nret = i2c_transfer(state->i2c, msg, 2);\r\nif (ret != 2) {\r\nprintk("%s: readreg error (reg=%d, ret==%i)\n",\r\n__func__, reg, ret);\r\nreturn ret;\r\n}\r\nreturn b1[0];\r\n}\r\nstatic void zl10353_dump_regs(struct dvb_frontend *fe)\r\n{\r\nstruct zl10353_state *state = fe->demodulator_priv;\r\nint ret;\r\nu8 reg;\r\nfor (reg = 0; ; reg++) {\r\nif (reg % 16 == 0) {\r\nif (reg)\r\nprintk(KERN_CONT "\n");\r\nprintk(KERN_DEBUG "%02x:", reg);\r\n}\r\nret = zl10353_read_register(state, reg);\r\nif (ret >= 0)\r\nprintk(KERN_CONT " %02x", (u8)ret);\r\nelse\r\nprintk(KERN_CONT " --");\r\nif (reg == 0xff)\r\nbreak;\r\n}\r\nprintk(KERN_CONT "\n");\r\n}\r\nstatic void zl10353_calc_nominal_rate(struct dvb_frontend *fe,\r\nu32 bandwidth,\r\nu16 *nominal_rate)\r\n{\r\nstruct zl10353_state *state = fe->demodulator_priv;\r\nu32 adc_clock = 450560;\r\nu64 value;\r\nu8 bw = bandwidth / 1000000;\r\nif (state->config.adc_clock)\r\nadc_clock = state->config.adc_clock;\r\nvalue = (u64)10 * (1 << 23) / 7 * 125;\r\nvalue = (bw * value) + adc_clock / 2;\r\ndo_div(value, adc_clock);\r\n*nominal_rate = value;\r\ndprintk("%s: bw %d, adc_clock %d => 0x%x\n",\r\n__func__, bw, adc_clock, *nominal_rate);\r\n}\r\nstatic void zl10353_calc_input_freq(struct dvb_frontend *fe,\r\nu16 *input_freq)\r\n{\r\nstruct zl10353_state *state = fe->demodulator_priv;\r\nu32 adc_clock = 450560;\r\nint if2 = 361667;\r\nint ife;\r\nu64 value;\r\nif (state->config.adc_clock)\r\nadc_clock = state->config.adc_clock;\r\nif (state->config.if2)\r\nif2 = state->config.if2;\r\nif (adc_clock >= if2 * 2)\r\nife = if2;\r\nelse {\r\nife = adc_clock - (if2 % adc_clock);\r\nif (ife > adc_clock / 2)\r\nife = adc_clock - ife;\r\n}\r\nvalue = (u64)65536 * ife + adc_clock / 2;\r\ndo_div(value, adc_clock);\r\n*input_freq = -value;\r\ndprintk("%s: if2 %d, ife %d, adc_clock %d => %d / 0x%x\n",\r\n__func__, if2, ife, adc_clock, -(int)value, *input_freq);\r\n}\r\nstatic int zl10353_sleep(struct dvb_frontend *fe)\r\n{\r\nstatic u8 zl10353_softdown[] = { 0x50, 0x0C, 0x44 };\r\nzl10353_write(fe, zl10353_softdown, sizeof(zl10353_softdown));\r\nreturn 0;\r\n}\r\nstatic int zl10353_set_parameters(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *c = &fe->dtv_property_cache;\r\nstruct zl10353_state *state = fe->demodulator_priv;\r\nu16 nominal_rate, input_freq;\r\nu8 pllbuf[6] = { 0x67 }, acq_ctl = 0;\r\nu16 tps = 0;\r\nstate->frequency = c->frequency;\r\nzl10353_single_write(fe, RESET, 0x80);\r\nudelay(200);\r\nzl10353_single_write(fe, 0xEA, 0x01);\r\nudelay(200);\r\nzl10353_single_write(fe, 0xEA, 0x00);\r\nzl10353_single_write(fe, AGC_TARGET, 0x28);\r\nif (c->transmission_mode != TRANSMISSION_MODE_AUTO)\r\nacq_ctl |= (1 << 0);\r\nif (c->guard_interval != GUARD_INTERVAL_AUTO)\r\nacq_ctl |= (1 << 1);\r\nzl10353_single_write(fe, ACQ_CTL, acq_ctl);\r\nswitch (c->bandwidth_hz) {\r\ncase 6000000:\r\nzl10353_single_write(fe, MCLK_RATIO, 0x97);\r\nzl10353_single_write(fe, 0x64, 0x34);\r\nzl10353_single_write(fe, 0xcc, 0xdd);\r\nbreak;\r\ncase 7000000:\r\nzl10353_single_write(fe, MCLK_RATIO, 0x86);\r\nzl10353_single_write(fe, 0x64, 0x35);\r\nzl10353_single_write(fe, 0xcc, 0x73);\r\nbreak;\r\ndefault:\r\nc->bandwidth_hz = 8000000;\r\ncase 8000000:\r\nzl10353_single_write(fe, MCLK_RATIO, 0x75);\r\nzl10353_single_write(fe, 0x64, 0x36);\r\nzl10353_single_write(fe, 0xcc, 0x73);\r\n}\r\nzl10353_calc_nominal_rate(fe, c->bandwidth_hz, &nominal_rate);\r\nzl10353_single_write(fe, TRL_NOMINAL_RATE_1, msb(nominal_rate));\r\nzl10353_single_write(fe, TRL_NOMINAL_RATE_0, lsb(nominal_rate));\r\nstate->bandwidth = c->bandwidth_hz;\r\nzl10353_calc_input_freq(fe, &input_freq);\r\nzl10353_single_write(fe, INPUT_FREQ_1, msb(input_freq));\r\nzl10353_single_write(fe, INPUT_FREQ_0, lsb(input_freq));\r\nswitch (c->code_rate_HP) {\r\ncase FEC_2_3:\r\ntps |= (1 << 7);\r\nbreak;\r\ncase FEC_3_4:\r\ntps |= (2 << 7);\r\nbreak;\r\ncase FEC_5_6:\r\ntps |= (3 << 7);\r\nbreak;\r\ncase FEC_7_8:\r\ntps |= (4 << 7);\r\nbreak;\r\ncase FEC_1_2:\r\ncase FEC_AUTO:\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (c->code_rate_LP) {\r\ncase FEC_2_3:\r\ntps |= (1 << 4);\r\nbreak;\r\ncase FEC_3_4:\r\ntps |= (2 << 4);\r\nbreak;\r\ncase FEC_5_6:\r\ntps |= (3 << 4);\r\nbreak;\r\ncase FEC_7_8:\r\ntps |= (4 << 4);\r\nbreak;\r\ncase FEC_1_2:\r\ncase FEC_AUTO:\r\nbreak;\r\ncase FEC_NONE:\r\nif (c->hierarchy == HIERARCHY_AUTO ||\r\nc->hierarchy == HIERARCHY_NONE)\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (c->modulation) {\r\ncase QPSK:\r\nbreak;\r\ncase QAM_AUTO:\r\ncase QAM_16:\r\ntps |= (1 << 13);\r\nbreak;\r\ncase QAM_64:\r\ntps |= (2 << 13);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (c->transmission_mode) {\r\ncase TRANSMISSION_MODE_2K:\r\ncase TRANSMISSION_MODE_AUTO:\r\nbreak;\r\ncase TRANSMISSION_MODE_8K:\r\ntps |= (1 << 0);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (c->guard_interval) {\r\ncase GUARD_INTERVAL_1_32:\r\ncase GUARD_INTERVAL_AUTO:\r\nbreak;\r\ncase GUARD_INTERVAL_1_16:\r\ntps |= (1 << 2);\r\nbreak;\r\ncase GUARD_INTERVAL_1_8:\r\ntps |= (2 << 2);\r\nbreak;\r\ncase GUARD_INTERVAL_1_4:\r\ntps |= (3 << 2);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (c->hierarchy) {\r\ncase HIERARCHY_AUTO:\r\ncase HIERARCHY_NONE:\r\nbreak;\r\ncase HIERARCHY_1:\r\ntps |= (1 << 10);\r\nbreak;\r\ncase HIERARCHY_2:\r\ntps |= (2 << 10);\r\nbreak;\r\ncase HIERARCHY_4:\r\ntps |= (3 << 10);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nzl10353_single_write(fe, TPS_GIVEN_1, msb(tps));\r\nzl10353_single_write(fe, TPS_GIVEN_0, lsb(tps));\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 0);\r\nif (state->config.no_tuner) {\r\nif (fe->ops.tuner_ops.set_params) {\r\nfe->ops.tuner_ops.set_params(fe);\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 0);\r\n}\r\n} else if (fe->ops.tuner_ops.calc_regs) {\r\nfe->ops.tuner_ops.calc_regs(fe, pllbuf + 1, 5);\r\npllbuf[1] <<= 1;\r\nzl10353_write(fe, pllbuf, sizeof(pllbuf));\r\n}\r\nzl10353_single_write(fe, 0x5F, 0x13);\r\nif (state->config.no_tuner || fe->ops.tuner_ops.calc_regs == NULL)\r\nzl10353_single_write(fe, FSM_GO, 0x01);\r\nelse\r\nzl10353_single_write(fe, TUNER_GO, 0x01);\r\nreturn 0;\r\n}\r\nstatic int zl10353_get_parameters(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *c = &fe->dtv_property_cache;\r\nstruct zl10353_state *state = fe->demodulator_priv;\r\nint s6, s9;\r\nu16 tps;\r\nstatic const u8 tps_fec_to_api[8] = {\r\nFEC_1_2,\r\nFEC_2_3,\r\nFEC_3_4,\r\nFEC_5_6,\r\nFEC_7_8,\r\nFEC_AUTO,\r\nFEC_AUTO,\r\nFEC_AUTO\r\n};\r\ns6 = zl10353_read_register(state, STATUS_6);\r\ns9 = zl10353_read_register(state, STATUS_9);\r\nif (s6 < 0 || s9 < 0)\r\nreturn -EREMOTEIO;\r\nif ((s6 & (1 << 5)) == 0 || (s9 & (1 << 4)) == 0)\r\nreturn -EINVAL;\r\ntps = zl10353_read_register(state, TPS_RECEIVED_1) << 8 |\r\nzl10353_read_register(state, TPS_RECEIVED_0);\r\nc->code_rate_HP = tps_fec_to_api[(tps >> 7) & 7];\r\nc->code_rate_LP = tps_fec_to_api[(tps >> 4) & 7];\r\nswitch ((tps >> 13) & 3) {\r\ncase 0:\r\nc->modulation = QPSK;\r\nbreak;\r\ncase 1:\r\nc->modulation = QAM_16;\r\nbreak;\r\ncase 2:\r\nc->modulation = QAM_64;\r\nbreak;\r\ndefault:\r\nc->modulation = QAM_AUTO;\r\nbreak;\r\n}\r\nc->transmission_mode = (tps & 0x01) ? TRANSMISSION_MODE_8K :\r\nTRANSMISSION_MODE_2K;\r\nswitch ((tps >> 2) & 3) {\r\ncase 0:\r\nc->guard_interval = GUARD_INTERVAL_1_32;\r\nbreak;\r\ncase 1:\r\nc->guard_interval = GUARD_INTERVAL_1_16;\r\nbreak;\r\ncase 2:\r\nc->guard_interval = GUARD_INTERVAL_1_8;\r\nbreak;\r\ncase 3:\r\nc->guard_interval = GUARD_INTERVAL_1_4;\r\nbreak;\r\ndefault:\r\nc->guard_interval = GUARD_INTERVAL_AUTO;\r\nbreak;\r\n}\r\nswitch ((tps >> 10) & 7) {\r\ncase 0:\r\nc->hierarchy = HIERARCHY_NONE;\r\nbreak;\r\ncase 1:\r\nc->hierarchy = HIERARCHY_1;\r\nbreak;\r\ncase 2:\r\nc->hierarchy = HIERARCHY_2;\r\nbreak;\r\ncase 3:\r\nc->hierarchy = HIERARCHY_4;\r\nbreak;\r\ndefault:\r\nc->hierarchy = HIERARCHY_AUTO;\r\nbreak;\r\n}\r\nc->frequency = state->frequency;\r\nc->bandwidth_hz = state->bandwidth;\r\nc->inversion = INVERSION_AUTO;\r\nreturn 0;\r\n}\r\nstatic int zl10353_read_status(struct dvb_frontend *fe, enum fe_status *status)\r\n{\r\nstruct zl10353_state *state = fe->demodulator_priv;\r\nint s6, s7, s8;\r\nif ((s6 = zl10353_read_register(state, STATUS_6)) < 0)\r\nreturn -EREMOTEIO;\r\nif ((s7 = zl10353_read_register(state, STATUS_7)) < 0)\r\nreturn -EREMOTEIO;\r\nif ((s8 = zl10353_read_register(state, STATUS_8)) < 0)\r\nreturn -EREMOTEIO;\r\n*status = 0;\r\nif (s6 & (1 << 2))\r\n*status |= FE_HAS_CARRIER;\r\nif (s6 & (1 << 1))\r\n*status |= FE_HAS_VITERBI;\r\nif (s6 & (1 << 5))\r\n*status |= FE_HAS_LOCK;\r\nif (s7 & (1 << 4))\r\n*status |= FE_HAS_SYNC;\r\nif (s8 & (1 << 6))\r\n*status |= FE_HAS_SIGNAL;\r\nif ((*status & (FE_HAS_CARRIER | FE_HAS_VITERBI | FE_HAS_SYNC)) !=\r\n(FE_HAS_CARRIER | FE_HAS_VITERBI | FE_HAS_SYNC))\r\n*status &= ~FE_HAS_LOCK;\r\nreturn 0;\r\n}\r\nstatic int zl10353_read_ber(struct dvb_frontend *fe, u32 *ber)\r\n{\r\nstruct zl10353_state *state = fe->demodulator_priv;\r\n*ber = zl10353_read_register(state, RS_ERR_CNT_2) << 16 |\r\nzl10353_read_register(state, RS_ERR_CNT_1) << 8 |\r\nzl10353_read_register(state, RS_ERR_CNT_0);\r\nreturn 0;\r\n}\r\nstatic int zl10353_read_signal_strength(struct dvb_frontend *fe, u16 *strength)\r\n{\r\nstruct zl10353_state *state = fe->demodulator_priv;\r\nu16 signal = zl10353_read_register(state, AGC_GAIN_1) << 10 |\r\nzl10353_read_register(state, AGC_GAIN_0) << 2 | 3;\r\n*strength = ~signal;\r\nreturn 0;\r\n}\r\nstatic int zl10353_read_snr(struct dvb_frontend *fe, u16 *snr)\r\n{\r\nstruct zl10353_state *state = fe->demodulator_priv;\r\nu8 _snr;\r\nif (debug_regs)\r\nzl10353_dump_regs(fe);\r\n_snr = zl10353_read_register(state, SNR);\r\n*snr = 10 * _snr / 8;\r\nreturn 0;\r\n}\r\nstatic int zl10353_read_ucblocks(struct dvb_frontend *fe, u32 *ucblocks)\r\n{\r\nstruct zl10353_state *state = fe->demodulator_priv;\r\nu32 ubl = 0;\r\nubl = zl10353_read_register(state, RS_UBC_1) << 8 |\r\nzl10353_read_register(state, RS_UBC_0);\r\nstate->ucblocks += ubl;\r\n*ucblocks = state->ucblocks;\r\nreturn 0;\r\n}\r\nstatic int zl10353_get_tune_settings(struct dvb_frontend *fe,\r\nstruct dvb_frontend_tune_settings\r\n*fe_tune_settings)\r\n{\r\nfe_tune_settings->min_delay_ms = 1000;\r\nfe_tune_settings->step_size = 0;\r\nfe_tune_settings->max_drift = 0;\r\nreturn 0;\r\n}\r\nstatic int zl10353_init(struct dvb_frontend *fe)\r\n{\r\nstruct zl10353_state *state = fe->demodulator_priv;\r\nu8 zl10353_reset_attach[6] = { 0x50, 0x03, 0x64, 0x46, 0x15, 0x0F };\r\nif (debug_regs)\r\nzl10353_dump_regs(fe);\r\nif (state->config.parallel_ts)\r\nzl10353_reset_attach[2] &= ~0x20;\r\nif (state->config.clock_ctl_1)\r\nzl10353_reset_attach[3] = state->config.clock_ctl_1;\r\nif (state->config.pll_0)\r\nzl10353_reset_attach[4] = state->config.pll_0;\r\nif (zl10353_read_register(state, 0x50) != zl10353_reset_attach[1] ||\r\nzl10353_read_register(state, 0x51) != zl10353_reset_attach[2]) {\r\nzl10353_write(fe, zl10353_reset_attach,\r\nsizeof(zl10353_reset_attach));\r\nif (debug_regs)\r\nzl10353_dump_regs(fe);\r\n}\r\nreturn 0;\r\n}\r\nstatic int zl10353_i2c_gate_ctrl(struct dvb_frontend* fe, int enable)\r\n{\r\nstruct zl10353_state *state = fe->demodulator_priv;\r\nu8 val = 0x0a;\r\nif (state->config.disable_i2c_gate_ctrl) {\r\nreturn 0;\r\n}\r\nif (enable)\r\nval |= 0x10;\r\nreturn zl10353_single_write(fe, 0x62, val);\r\n}\r\nstatic void zl10353_release(struct dvb_frontend *fe)\r\n{\r\nstruct zl10353_state *state = fe->demodulator_priv;\r\nkfree(state);\r\n}\r\nstruct dvb_frontend *zl10353_attach(const struct zl10353_config *config,\r\nstruct i2c_adapter *i2c)\r\n{\r\nstruct zl10353_state *state = NULL;\r\nint id;\r\nstate = kzalloc(sizeof(struct zl10353_state), GFP_KERNEL);\r\nif (state == NULL)\r\ngoto error;\r\nstate->i2c = i2c;\r\nmemcpy(&state->config, config, sizeof(struct zl10353_config));\r\nid = zl10353_read_register(state, CHIP_ID);\r\nif ((id != ID_ZL10353) && (id != ID_CE6230) && (id != ID_CE6231))\r\ngoto error;\r\nmemcpy(&state->frontend.ops, &zl10353_ops, sizeof(struct dvb_frontend_ops));\r\nstate->frontend.demodulator_priv = state;\r\nreturn &state->frontend;\r\nerror:\r\nkfree(state);\r\nreturn NULL;\r\n}

static int axi_spdif_trigger(struct snd_pcm_substream *substream, int cmd,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct axi_spdif *spdif = snd_soc_dai_get_drvdata(dai);\r\nunsigned int val;\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\r\nval = AXI_SPDIF_CTRL_TXDATA;\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\r\nval = 0;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nregmap_update_bits(spdif->regmap, AXI_SPDIF_REG_CTRL,\r\nAXI_SPDIF_CTRL_TXDATA, val);\r\nreturn 0;\r\n}\r\nstatic int axi_spdif_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params, struct snd_soc_dai *dai)\r\n{\r\nstruct axi_spdif *spdif = snd_soc_dai_get_drvdata(dai);\r\nunsigned int rate = params_rate(params);\r\nunsigned int clkdiv, stat;\r\nswitch (params_rate(params)) {\r\ncase 32000:\r\nstat = AXI_SPDIF_FREQ_32000;\r\nbreak;\r\ncase 44100:\r\nstat = AXI_SPDIF_FREQ_44100;\r\nbreak;\r\ncase 48000:\r\nstat = AXI_SPDIF_FREQ_48000;\r\nbreak;\r\ndefault:\r\nstat = AXI_SPDIF_FREQ_NA;\r\nbreak;\r\n}\r\nclkdiv = DIV_ROUND_CLOSEST(clk_get_rate(spdif->clk_ref),\r\nrate * 64 * 2) - 1;\r\nclkdiv <<= AXI_SPDIF_CTRL_CLKDIV_OFFSET;\r\nregmap_write(spdif->regmap, AXI_SPDIF_REG_STAT, stat);\r\nregmap_update_bits(spdif->regmap, AXI_SPDIF_REG_CTRL,\r\nAXI_SPDIF_CTRL_CLKDIV_MASK, clkdiv);\r\nreturn 0;\r\n}\r\nstatic int axi_spdif_dai_probe(struct snd_soc_dai *dai)\r\n{\r\nstruct axi_spdif *spdif = snd_soc_dai_get_drvdata(dai);\r\nsnd_soc_dai_init_dma_data(dai, &spdif->dma_data, NULL);\r\nreturn 0;\r\n}\r\nstatic int axi_spdif_startup(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct axi_spdif *spdif = snd_soc_dai_get_drvdata(dai);\r\nint ret;\r\nret = snd_pcm_hw_constraint_ratnums(substream->runtime, 0,\r\nSNDRV_PCM_HW_PARAM_RATE,\r\n&spdif->rate_constraints);\r\nif (ret)\r\nreturn ret;\r\nret = clk_prepare_enable(spdif->clk_ref);\r\nif (ret)\r\nreturn ret;\r\nregmap_update_bits(spdif->regmap, AXI_SPDIF_REG_CTRL,\r\nAXI_SPDIF_CTRL_TXEN, AXI_SPDIF_CTRL_TXEN);\r\nreturn 0;\r\n}\r\nstatic void axi_spdif_shutdown(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct axi_spdif *spdif = snd_soc_dai_get_drvdata(dai);\r\nregmap_update_bits(spdif->regmap, AXI_SPDIF_REG_CTRL,\r\nAXI_SPDIF_CTRL_TXEN, 0);\r\nclk_disable_unprepare(spdif->clk_ref);\r\n}\r\nstatic int axi_spdif_probe(struct platform_device *pdev)\r\n{\r\nstruct axi_spdif *spdif;\r\nstruct resource *res;\r\nvoid __iomem *base;\r\nint ret;\r\nspdif = devm_kzalloc(&pdev->dev, sizeof(*spdif), GFP_KERNEL);\r\nif (!spdif)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, spdif);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nbase = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(base))\r\nreturn PTR_ERR(base);\r\nspdif->regmap = devm_regmap_init_mmio(&pdev->dev, base,\r\n&axi_spdif_regmap_config);\r\nif (IS_ERR(spdif->regmap))\r\nreturn PTR_ERR(spdif->regmap);\r\nspdif->clk = devm_clk_get(&pdev->dev, "axi");\r\nif (IS_ERR(spdif->clk))\r\nreturn PTR_ERR(spdif->clk);\r\nspdif->clk_ref = devm_clk_get(&pdev->dev, "ref");\r\nif (IS_ERR(spdif->clk_ref))\r\nreturn PTR_ERR(spdif->clk_ref);\r\nret = clk_prepare_enable(spdif->clk);\r\nif (ret)\r\nreturn ret;\r\nspdif->dma_data.addr = res->start + AXI_SPDIF_REG_TX_FIFO;\r\nspdif->dma_data.addr_width = 4;\r\nspdif->dma_data.maxburst = 1;\r\nspdif->ratnum.num = clk_get_rate(spdif->clk_ref) / 128;\r\nspdif->ratnum.den_step = 1;\r\nspdif->ratnum.den_min = 1;\r\nspdif->ratnum.den_max = 64;\r\nspdif->rate_constraints.rats = &spdif->ratnum;\r\nspdif->rate_constraints.nrats = 1;\r\nret = devm_snd_soc_register_component(&pdev->dev, &axi_spdif_component,\r\n&axi_spdif_dai, 1);\r\nif (ret)\r\ngoto err_clk_disable;\r\nret = devm_snd_dmaengine_pcm_register(&pdev->dev, NULL, 0);\r\nif (ret)\r\ngoto err_clk_disable;\r\nreturn 0;\r\nerr_clk_disable:\r\nclk_disable_unprepare(spdif->clk);\r\nreturn ret;\r\n}\r\nstatic int axi_spdif_dev_remove(struct platform_device *pdev)\r\n{\r\nstruct axi_spdif *spdif = platform_get_drvdata(pdev);\r\nclk_disable_unprepare(spdif->clk);\r\nreturn 0;\r\n}

static ssize_t type_show(struct hyp_sysfs_attr *attr, char *buffer)\r\n{\r\nreturn sprintf(buffer, "xen\n");\r\n}\r\nstatic int __init xen_sysfs_type_init(void)\r\n{\r\nreturn sysfs_create_file(hypervisor_kobj, &type_attr.attr);\r\n}\r\nstatic void xen_sysfs_type_destroy(void)\r\n{\r\nsysfs_remove_file(hypervisor_kobj, &type_attr.attr);\r\n}\r\nstatic ssize_t major_show(struct hyp_sysfs_attr *attr, char *buffer)\r\n{\r\nint version = HYPERVISOR_xen_version(XENVER_version, NULL);\r\nif (version)\r\nreturn sprintf(buffer, "%d\n", version >> 16);\r\nreturn -ENODEV;\r\n}\r\nstatic ssize_t minor_show(struct hyp_sysfs_attr *attr, char *buffer)\r\n{\r\nint version = HYPERVISOR_xen_version(XENVER_version, NULL);\r\nif (version)\r\nreturn sprintf(buffer, "%d\n", version & 0xff);\r\nreturn -ENODEV;\r\n}\r\nstatic ssize_t extra_show(struct hyp_sysfs_attr *attr, char *buffer)\r\n{\r\nint ret = -ENOMEM;\r\nchar *extra;\r\nextra = kmalloc(XEN_EXTRAVERSION_LEN, GFP_KERNEL);\r\nif (extra) {\r\nret = HYPERVISOR_xen_version(XENVER_extraversion, extra);\r\nif (!ret)\r\nret = sprintf(buffer, "%s\n", extra);\r\nkfree(extra);\r\n}\r\nreturn ret;\r\n}\r\nstatic int __init xen_sysfs_version_init(void)\r\n{\r\nreturn sysfs_create_group(hypervisor_kobj, &version_group);\r\n}\r\nstatic void xen_sysfs_version_destroy(void)\r\n{\r\nsysfs_remove_group(hypervisor_kobj, &version_group);\r\n}\r\nstatic ssize_t uuid_show_fallback(struct hyp_sysfs_attr *attr, char *buffer)\r\n{\r\nchar *vm, *val;\r\nint ret;\r\nextern int xenstored_ready;\r\nif (!xenstored_ready)\r\nreturn -EBUSY;\r\nvm = xenbus_read(XBT_NIL, "vm", "", NULL);\r\nif (IS_ERR(vm))\r\nreturn PTR_ERR(vm);\r\nval = xenbus_read(XBT_NIL, vm, "uuid", NULL);\r\nkfree(vm);\r\nif (IS_ERR(val))\r\nreturn PTR_ERR(val);\r\nret = sprintf(buffer, "%s\n", val);\r\nkfree(val);\r\nreturn ret;\r\n}\r\nstatic ssize_t uuid_show(struct hyp_sysfs_attr *attr, char *buffer)\r\n{\r\nxen_domain_handle_t uuid;\r\nint ret;\r\nret = HYPERVISOR_xen_version(XENVER_guest_handle, uuid);\r\nif (ret)\r\nreturn uuid_show_fallback(attr, buffer);\r\nret = sprintf(buffer, "%pU\n", uuid);\r\nreturn ret;\r\n}\r\nstatic int __init xen_sysfs_uuid_init(void)\r\n{\r\nreturn sysfs_create_file(hypervisor_kobj, &uuid_attr.attr);\r\n}\r\nstatic void xen_sysfs_uuid_destroy(void)\r\n{\r\nsysfs_remove_file(hypervisor_kobj, &uuid_attr.attr);\r\n}\r\nstatic ssize_t compiler_show(struct hyp_sysfs_attr *attr, char *buffer)\r\n{\r\nint ret = -ENOMEM;\r\nstruct xen_compile_info *info;\r\ninfo = kmalloc(sizeof(struct xen_compile_info), GFP_KERNEL);\r\nif (info) {\r\nret = HYPERVISOR_xen_version(XENVER_compile_info, info);\r\nif (!ret)\r\nret = sprintf(buffer, "%s\n", info->compiler);\r\nkfree(info);\r\n}\r\nreturn ret;\r\n}\r\nstatic ssize_t compiled_by_show(struct hyp_sysfs_attr *attr, char *buffer)\r\n{\r\nint ret = -ENOMEM;\r\nstruct xen_compile_info *info;\r\ninfo = kmalloc(sizeof(struct xen_compile_info), GFP_KERNEL);\r\nif (info) {\r\nret = HYPERVISOR_xen_version(XENVER_compile_info, info);\r\nif (!ret)\r\nret = sprintf(buffer, "%s\n", info->compile_by);\r\nkfree(info);\r\n}\r\nreturn ret;\r\n}\r\nstatic ssize_t compile_date_show(struct hyp_sysfs_attr *attr, char *buffer)\r\n{\r\nint ret = -ENOMEM;\r\nstruct xen_compile_info *info;\r\ninfo = kmalloc(sizeof(struct xen_compile_info), GFP_KERNEL);\r\nif (info) {\r\nret = HYPERVISOR_xen_version(XENVER_compile_info, info);\r\nif (!ret)\r\nret = sprintf(buffer, "%s\n", info->compile_date);\r\nkfree(info);\r\n}\r\nreturn ret;\r\n}\r\nstatic int __init xen_compilation_init(void)\r\n{\r\nreturn sysfs_create_group(hypervisor_kobj, &xen_compilation_group);\r\n}\r\nstatic void xen_compilation_destroy(void)\r\n{\r\nsysfs_remove_group(hypervisor_kobj, &xen_compilation_group);\r\n}\r\nstatic ssize_t capabilities_show(struct hyp_sysfs_attr *attr, char *buffer)\r\n{\r\nint ret = -ENOMEM;\r\nchar *caps;\r\ncaps = kmalloc(XEN_CAPABILITIES_INFO_LEN, GFP_KERNEL);\r\nif (caps) {\r\nret = HYPERVISOR_xen_version(XENVER_capabilities, caps);\r\nif (!ret)\r\nret = sprintf(buffer, "%s\n", caps);\r\nkfree(caps);\r\n}\r\nreturn ret;\r\n}\r\nstatic ssize_t changeset_show(struct hyp_sysfs_attr *attr, char *buffer)\r\n{\r\nint ret = -ENOMEM;\r\nchar *cset;\r\ncset = kmalloc(XEN_CHANGESET_INFO_LEN, GFP_KERNEL);\r\nif (cset) {\r\nret = HYPERVISOR_xen_version(XENVER_changeset, cset);\r\nif (!ret)\r\nret = sprintf(buffer, "%s\n", cset);\r\nkfree(cset);\r\n}\r\nreturn ret;\r\n}\r\nstatic ssize_t virtual_start_show(struct hyp_sysfs_attr *attr, char *buffer)\r\n{\r\nint ret = -ENOMEM;\r\nstruct xen_platform_parameters *parms;\r\nparms = kmalloc(sizeof(struct xen_platform_parameters), GFP_KERNEL);\r\nif (parms) {\r\nret = HYPERVISOR_xen_version(XENVER_platform_parameters,\r\nparms);\r\nif (!ret)\r\nret = sprintf(buffer, "%"PRI_xen_ulong"\n",\r\nparms->virt_start);\r\nkfree(parms);\r\n}\r\nreturn ret;\r\n}\r\nstatic ssize_t pagesize_show(struct hyp_sysfs_attr *attr, char *buffer)\r\n{\r\nint ret;\r\nret = HYPERVISOR_xen_version(XENVER_pagesize, NULL);\r\nif (ret > 0)\r\nret = sprintf(buffer, "%x\n", ret);\r\nreturn ret;\r\n}\r\nstatic ssize_t xen_feature_show(int index, char *buffer)\r\n{\r\nssize_t ret;\r\nstruct xen_feature_info info;\r\ninfo.submap_idx = index;\r\nret = HYPERVISOR_xen_version(XENVER_get_features, &info);\r\nif (!ret)\r\nret = sprintf(buffer, "%08x", info.submap);\r\nreturn ret;\r\n}\r\nstatic ssize_t features_show(struct hyp_sysfs_attr *attr, char *buffer)\r\n{\r\nssize_t len;\r\nint i;\r\nlen = 0;\r\nfor (i = XENFEAT_NR_SUBMAPS-1; i >= 0; i--) {\r\nint ret = xen_feature_show(i, buffer + len);\r\nif (ret < 0) {\r\nif (len == 0)\r\nlen = ret;\r\nbreak;\r\n}\r\nlen += ret;\r\n}\r\nif (len > 0)\r\nbuffer[len++] = '\n';\r\nreturn len;\r\n}\r\nstatic int __init xen_properties_init(void)\r\n{\r\nreturn sysfs_create_group(hypervisor_kobj, &xen_properties_group);\r\n}\r\nstatic void xen_properties_destroy(void)\r\n{\r\nsysfs_remove_group(hypervisor_kobj, &xen_properties_group);\r\n}\r\nstatic ssize_t pmu_mode_store(struct hyp_sysfs_attr *attr,\r\nconst char *buffer, size_t len)\r\n{\r\nint ret;\r\nstruct xen_pmu_params xp;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(pmu_modes); i++) {\r\nif (strncmp(buffer, pmu_modes[i].name, len - 1) == 0) {\r\nxp.val = pmu_modes[i].mode;\r\nbreak;\r\n}\r\n}\r\nif (i == ARRAY_SIZE(pmu_modes))\r\nreturn -EINVAL;\r\nxp.version.maj = XENPMU_VER_MAJ;\r\nxp.version.min = XENPMU_VER_MIN;\r\nret = HYPERVISOR_xenpmu_op(XENPMU_mode_set, &xp);\r\nif (ret)\r\nreturn ret;\r\nreturn len;\r\n}\r\nstatic ssize_t pmu_mode_show(struct hyp_sysfs_attr *attr, char *buffer)\r\n{\r\nint ret;\r\nstruct xen_pmu_params xp;\r\nint i;\r\nuint32_t mode;\r\nxp.version.maj = XENPMU_VER_MAJ;\r\nxp.version.min = XENPMU_VER_MIN;\r\nret = HYPERVISOR_xenpmu_op(XENPMU_mode_get, &xp);\r\nif (ret)\r\nreturn ret;\r\nmode = (uint32_t)xp.val;\r\nfor (i = 0; i < ARRAY_SIZE(pmu_modes); i++) {\r\nif (mode == pmu_modes[i].mode)\r\nreturn sprintf(buffer, "%s\n", pmu_modes[i].name);\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic ssize_t pmu_features_store(struct hyp_sysfs_attr *attr,\r\nconst char *buffer, size_t len)\r\n{\r\nint ret;\r\nuint32_t features;\r\nstruct xen_pmu_params xp;\r\nret = kstrtou32(buffer, 0, &features);\r\nif (ret)\r\nreturn ret;\r\nxp.val = features;\r\nxp.version.maj = XENPMU_VER_MAJ;\r\nxp.version.min = XENPMU_VER_MIN;\r\nret = HYPERVISOR_xenpmu_op(XENPMU_feature_set, &xp);\r\nif (ret)\r\nreturn ret;\r\nreturn len;\r\n}\r\nstatic ssize_t pmu_features_show(struct hyp_sysfs_attr *attr, char *buffer)\r\n{\r\nint ret;\r\nstruct xen_pmu_params xp;\r\nxp.version.maj = XENPMU_VER_MAJ;\r\nxp.version.min = XENPMU_VER_MIN;\r\nret = HYPERVISOR_xenpmu_op(XENPMU_feature_get, &xp);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buffer, "0x%x\n", (uint32_t)xp.val);\r\n}\r\nstatic int __init xen_pmu_init(void)\r\n{\r\nreturn sysfs_create_group(hypervisor_kobj, &xen_pmu_group);\r\n}\r\nstatic void xen_pmu_destroy(void)\r\n{\r\nsysfs_remove_group(hypervisor_kobj, &xen_pmu_group);\r\n}\r\nstatic int __init hyper_sysfs_init(void)\r\n{\r\nint ret;\r\nif (!xen_domain())\r\nreturn -ENODEV;\r\nret = xen_sysfs_type_init();\r\nif (ret)\r\ngoto out;\r\nret = xen_sysfs_version_init();\r\nif (ret)\r\ngoto version_out;\r\nret = xen_compilation_init();\r\nif (ret)\r\ngoto comp_out;\r\nret = xen_sysfs_uuid_init();\r\nif (ret)\r\ngoto uuid_out;\r\nret = xen_properties_init();\r\nif (ret)\r\ngoto prop_out;\r\n#ifdef CONFIG_XEN_HAVE_VPMU\r\nif (xen_initial_domain()) {\r\nret = xen_pmu_init();\r\nif (ret) {\r\nxen_properties_destroy();\r\ngoto prop_out;\r\n}\r\n}\r\n#endif\r\ngoto out;\r\nprop_out:\r\nxen_sysfs_uuid_destroy();\r\nuuid_out:\r\nxen_compilation_destroy();\r\ncomp_out:\r\nxen_sysfs_version_destroy();\r\nversion_out:\r\nxen_sysfs_type_destroy();\r\nout:\r\nreturn ret;\r\n}\r\nstatic void __exit hyper_sysfs_exit(void)\r\n{\r\n#ifdef CONFIG_XEN_HAVE_VPMU\r\nxen_pmu_destroy();\r\n#endif\r\nxen_properties_destroy();\r\nxen_compilation_destroy();\r\nxen_sysfs_uuid_destroy();\r\nxen_sysfs_version_destroy();\r\nxen_sysfs_type_destroy();\r\n}\r\nstatic ssize_t hyp_sysfs_show(struct kobject *kobj,\r\nstruct attribute *attr,\r\nchar *buffer)\r\n{\r\nstruct hyp_sysfs_attr *hyp_attr;\r\nhyp_attr = container_of(attr, struct hyp_sysfs_attr, attr);\r\nif (hyp_attr->show)\r\nreturn hyp_attr->show(hyp_attr, buffer);\r\nreturn 0;\r\n}\r\nstatic ssize_t hyp_sysfs_store(struct kobject *kobj,\r\nstruct attribute *attr,\r\nconst char *buffer,\r\nsize_t len)\r\n{\r\nstruct hyp_sysfs_attr *hyp_attr;\r\nhyp_attr = container_of(attr, struct hyp_sysfs_attr, attr);\r\nif (hyp_attr->store)\r\nreturn hyp_attr->store(hyp_attr, buffer, len);\r\nreturn 0;\r\n}\r\nstatic int __init hypervisor_subsys_init(void)\r\n{\r\nif (!xen_domain())\r\nreturn -ENODEV;\r\nhypervisor_kobj->ktype = &hyp_sysfs_kobj_type;\r\nreturn 0;\r\n}

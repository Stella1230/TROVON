static void au1x_pcm_queue_tx(struct au1xpsc_audio_dmadata *cd)\r\n{\r\nau1xxx_dbdma_put_source(cd->ddma_chan, cd->dma_area,\r\ncd->period_bytes, DDMA_FLAGS_IE);\r\n++cd->q_period;\r\ncd->dma_area += cd->period_bytes;\r\nif (cd->q_period >= cd->periods) {\r\ncd->q_period = 0;\r\ncd->dma_area = cd->dma_area_s;\r\n}\r\n}\r\nstatic void au1x_pcm_queue_rx(struct au1xpsc_audio_dmadata *cd)\r\n{\r\nau1xxx_dbdma_put_dest(cd->ddma_chan, cd->dma_area,\r\ncd->period_bytes, DDMA_FLAGS_IE);\r\n++cd->q_period;\r\ncd->dma_area += cd->period_bytes;\r\nif (cd->q_period >= cd->periods) {\r\ncd->q_period = 0;\r\ncd->dma_area = cd->dma_area_s;\r\n}\r\n}\r\nstatic void au1x_pcm_dmatx_cb(int irq, void *dev_id)\r\n{\r\nstruct au1xpsc_audio_dmadata *cd = dev_id;\r\ncd->pos += cd->period_bytes;\r\nif (++cd->curr_period >= cd->periods) {\r\ncd->pos = 0;\r\ncd->curr_period = 0;\r\n}\r\nsnd_pcm_period_elapsed(cd->substream);\r\nau1x_pcm_queue_tx(cd);\r\n}\r\nstatic void au1x_pcm_dmarx_cb(int irq, void *dev_id)\r\n{\r\nstruct au1xpsc_audio_dmadata *cd = dev_id;\r\ncd->pos += cd->period_bytes;\r\nif (++cd->curr_period >= cd->periods) {\r\ncd->pos = 0;\r\ncd->curr_period = 0;\r\n}\r\nsnd_pcm_period_elapsed(cd->substream);\r\nau1x_pcm_queue_rx(cd);\r\n}\r\nstatic void au1x_pcm_dbdma_free(struct au1xpsc_audio_dmadata *pcd)\r\n{\r\nif (pcd->ddma_chan) {\r\nau1xxx_dbdma_stop(pcd->ddma_chan);\r\nau1xxx_dbdma_reset(pcd->ddma_chan);\r\nau1xxx_dbdma_chan_free(pcd->ddma_chan);\r\npcd->ddma_chan = 0;\r\npcd->msbits = 0;\r\n}\r\n}\r\nstatic int au1x_pcm_dbdma_realloc(struct au1xpsc_audio_dmadata *pcd,\r\nint stype, int msbits)\r\n{\r\nif (msbits == 24)\r\nmsbits = 32;\r\nif ((pcd->ddma_chan) && (msbits == pcd->msbits))\r\ngoto out;\r\nau1x_pcm_dbdma_free(pcd);\r\nif (stype == SNDRV_PCM_STREAM_CAPTURE)\r\npcd->ddma_chan = au1xxx_dbdma_chan_alloc(pcd->ddma_id,\r\nDSCR_CMD0_ALWAYS,\r\nau1x_pcm_dmarx_cb, (void *)pcd);\r\nelse\r\npcd->ddma_chan = au1xxx_dbdma_chan_alloc(DSCR_CMD0_ALWAYS,\r\npcd->ddma_id,\r\nau1x_pcm_dmatx_cb, (void *)pcd);\r\nif (!pcd->ddma_chan)\r\nreturn -ENOMEM;\r\nau1xxx_dbdma_set_devwidth(pcd->ddma_chan, msbits);\r\nau1xxx_dbdma_ring_alloc(pcd->ddma_chan, 2);\r\npcd->msbits = msbits;\r\nau1xxx_dbdma_stop(pcd->ddma_chan);\r\nau1xxx_dbdma_reset(pcd->ddma_chan);\r\nout:\r\nreturn 0;\r\n}\r\nstatic inline struct au1xpsc_audio_dmadata *to_dmadata(struct snd_pcm_substream *ss)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = ss->private_data;\r\nstruct au1xpsc_audio_dmadata *pcd =\r\nsnd_soc_platform_get_drvdata(rtd->platform);\r\nreturn &pcd[ss->stream];\r\n}\r\nstatic int au1xpsc_pcm_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct au1xpsc_audio_dmadata *pcd;\r\nint stype, ret;\r\nret = snd_pcm_lib_malloc_pages(substream, params_buffer_bytes(params));\r\nif (ret < 0)\r\ngoto out;\r\nstype = substream->stream;\r\npcd = to_dmadata(substream);\r\nDBG("runtime->dma_area = 0x%08lx dma_addr_t = 0x%08lx dma_size = %d "\r\n"runtime->min_align %d\n",\r\n(unsigned long)runtime->dma_area,\r\n(unsigned long)runtime->dma_addr, runtime->dma_bytes,\r\nruntime->min_align);\r\nDBG("bits %d frags %d frag_bytes %d is_rx %d\n", params->msbits,\r\nparams_periods(params), params_period_bytes(params), stype);\r\nret = au1x_pcm_dbdma_realloc(pcd, stype, params->msbits);\r\nif (ret) {\r\nMSG("DDMA channel (re)alloc failed!\n");\r\ngoto out;\r\n}\r\npcd->substream = substream;\r\npcd->period_bytes = params_period_bytes(params);\r\npcd->periods = params_periods(params);\r\npcd->dma_area_s = pcd->dma_area = runtime->dma_addr;\r\npcd->q_period = 0;\r\npcd->curr_period = 0;\r\npcd->pos = 0;\r\nret = 0;\r\nout:\r\nreturn ret;\r\n}\r\nstatic int au1xpsc_pcm_hw_free(struct snd_pcm_substream *substream)\r\n{\r\nsnd_pcm_lib_free_pages(substream);\r\nreturn 0;\r\n}\r\nstatic int au1xpsc_pcm_prepare(struct snd_pcm_substream *substream)\r\n{\r\nstruct au1xpsc_audio_dmadata *pcd = to_dmadata(substream);\r\nau1xxx_dbdma_reset(pcd->ddma_chan);\r\nif (substream->stream == SNDRV_PCM_STREAM_CAPTURE) {\r\nau1x_pcm_queue_rx(pcd);\r\nau1x_pcm_queue_rx(pcd);\r\n} else {\r\nau1x_pcm_queue_tx(pcd);\r\nau1x_pcm_queue_tx(pcd);\r\n}\r\nreturn 0;\r\n}\r\nstatic int au1xpsc_pcm_trigger(struct snd_pcm_substream *substream, int cmd)\r\n{\r\nu32 c = to_dmadata(substream)->ddma_chan;\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\nau1xxx_dbdma_start(c);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\nau1xxx_dbdma_stop(c);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic snd_pcm_uframes_t\r\nau1xpsc_pcm_pointer(struct snd_pcm_substream *substream)\r\n{\r\nreturn bytes_to_frames(substream->runtime, to_dmadata(substream)->pos);\r\n}\r\nstatic int au1xpsc_pcm_open(struct snd_pcm_substream *substream)\r\n{\r\nstruct au1xpsc_audio_dmadata *pcd = to_dmadata(substream);\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nint stype = substream->stream, *dmaids;\r\ndmaids = snd_soc_dai_get_dma_data(rtd->cpu_dai, substream);\r\nif (!dmaids)\r\nreturn -ENODEV;\r\npcd->ddma_id = dmaids[stype];\r\nsnd_soc_set_runtime_hwparams(substream, &au1xpsc_pcm_hardware);\r\nreturn 0;\r\n}\r\nstatic int au1xpsc_pcm_close(struct snd_pcm_substream *substream)\r\n{\r\nau1x_pcm_dbdma_free(to_dmadata(substream));\r\nreturn 0;\r\n}\r\nstatic int au1xpsc_pcm_new(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct snd_card *card = rtd->card->snd_card;\r\nstruct snd_pcm *pcm = rtd->pcm;\r\nsnd_pcm_lib_preallocate_pages_for_all(pcm, SNDRV_DMA_TYPE_DEV,\r\ncard->dev, AU1XPSC_BUFFER_MIN_BYTES, (4096 * 1024) - 1);\r\nreturn 0;\r\n}\r\nstatic int au1xpsc_pcm_drvprobe(struct platform_device *pdev)\r\n{\r\nstruct au1xpsc_audio_dmadata *dmadata;\r\ndmadata = devm_kzalloc(&pdev->dev,\r\n2 * sizeof(struct au1xpsc_audio_dmadata),\r\nGFP_KERNEL);\r\nif (!dmadata)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, dmadata);\r\nreturn devm_snd_soc_register_platform(&pdev->dev,\r\n&au1xpsc_soc_platform);\r\n}

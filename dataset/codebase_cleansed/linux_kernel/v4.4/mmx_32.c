void *_mmx_memcpy(void *to, const void *from, size_t len)\r\n{\r\nvoid *p;\r\nint i;\r\nif (unlikely(in_interrupt()))\r\nreturn __memcpy(to, from, len);\r\np = to;\r\ni = len >> 6;\r\nkernel_fpu_begin();\r\n__asm__ __volatile__ (\r\n"1: prefetch (%0)\n"\r\n" prefetch 64(%0)\n"\r\n" prefetch 128(%0)\n"\r\n" prefetch 192(%0)\n"\r\n" prefetch 256(%0)\n"\r\n"2: \n"\r\n".section .fixup, \"ax\"\n"\r\n"3: movw $0x1AEB, 1b\n"\r\n" jmp 2b\n"\r\n".previous\n"\r\n_ASM_EXTABLE(1b, 3b)\r\n: : "r" (from));\r\nfor ( ; i > 5; i--) {\r\n__asm__ __volatile__ (\r\n"1: prefetch 320(%0)\n"\r\n"2: movq (%0), %%mm0\n"\r\n" movq 8(%0), %%mm1\n"\r\n" movq 16(%0), %%mm2\n"\r\n" movq 24(%0), %%mm3\n"\r\n" movq %%mm0, (%1)\n"\r\n" movq %%mm1, 8(%1)\n"\r\n" movq %%mm2, 16(%1)\n"\r\n" movq %%mm3, 24(%1)\n"\r\n" movq 32(%0), %%mm0\n"\r\n" movq 40(%0), %%mm1\n"\r\n" movq 48(%0), %%mm2\n"\r\n" movq 56(%0), %%mm3\n"\r\n" movq %%mm0, 32(%1)\n"\r\n" movq %%mm1, 40(%1)\n"\r\n" movq %%mm2, 48(%1)\n"\r\n" movq %%mm3, 56(%1)\n"\r\n".section .fixup, \"ax\"\n"\r\n"3: movw $0x05EB, 1b\n"\r\n" jmp 2b\n"\r\n".previous\n"\r\n_ASM_EXTABLE(1b, 3b)\r\n: : "r" (from), "r" (to) : "memory");\r\nfrom += 64;\r\nto += 64;\r\n}\r\nfor ( ; i > 0; i--) {\r\n__asm__ __volatile__ (\r\n" movq (%0), %%mm0\n"\r\n" movq 8(%0), %%mm1\n"\r\n" movq 16(%0), %%mm2\n"\r\n" movq 24(%0), %%mm3\n"\r\n" movq %%mm0, (%1)\n"\r\n" movq %%mm1, 8(%1)\n"\r\n" movq %%mm2, 16(%1)\n"\r\n" movq %%mm3, 24(%1)\n"\r\n" movq 32(%0), %%mm0\n"\r\n" movq 40(%0), %%mm1\n"\r\n" movq 48(%0), %%mm2\n"\r\n" movq 56(%0), %%mm3\n"\r\n" movq %%mm0, 32(%1)\n"\r\n" movq %%mm1, 40(%1)\n"\r\n" movq %%mm2, 48(%1)\n"\r\n" movq %%mm3, 56(%1)\n"\r\n: : "r" (from), "r" (to) : "memory");\r\nfrom += 64;\r\nto += 64;\r\n}\r\n__memcpy(to, from, len & 63);\r\nkernel_fpu_end();\r\nreturn p;\r\n}\r\nstatic void fast_clear_page(void *page)\r\n{\r\nint i;\r\nkernel_fpu_begin();\r\n__asm__ __volatile__ (\r\n" pxor %%mm0, %%mm0\n" : :\r\n);\r\nfor (i = 0; i < 4096/64; i++) {\r\n__asm__ __volatile__ (\r\n" movntq %%mm0, (%0)\n"\r\n" movntq %%mm0, 8(%0)\n"\r\n" movntq %%mm0, 16(%0)\n"\r\n" movntq %%mm0, 24(%0)\n"\r\n" movntq %%mm0, 32(%0)\n"\r\n" movntq %%mm0, 40(%0)\n"\r\n" movntq %%mm0, 48(%0)\n"\r\n" movntq %%mm0, 56(%0)\n"\r\n: : "r" (page) : "memory");\r\npage += 64;\r\n}\r\n__asm__ __volatile__("sfence\n"::);\r\nkernel_fpu_end();\r\n}\r\nstatic void fast_copy_page(void *to, void *from)\r\n{\r\nint i;\r\nkernel_fpu_begin();\r\n__asm__ __volatile__(\r\n"1: prefetch (%0)\n"\r\n" prefetch 64(%0)\n"\r\n" prefetch 128(%0)\n"\r\n" prefetch 192(%0)\n"\r\n" prefetch 256(%0)\n"\r\n"2: \n"\r\n".section .fixup, \"ax\"\n"\r\n"3: movw $0x1AEB, 1b\n"\r\n" jmp 2b\n"\r\n".previous\n"\r\n_ASM_EXTABLE(1b, 3b) : : "r" (from));\r\nfor (i = 0; i < (4096-320)/64; i++) {\r\n__asm__ __volatile__ (\r\n"1: prefetch 320(%0)\n"\r\n"2: movq (%0), %%mm0\n"\r\n" movntq %%mm0, (%1)\n"\r\n" movq 8(%0), %%mm1\n"\r\n" movntq %%mm1, 8(%1)\n"\r\n" movq 16(%0), %%mm2\n"\r\n" movntq %%mm2, 16(%1)\n"\r\n" movq 24(%0), %%mm3\n"\r\n" movntq %%mm3, 24(%1)\n"\r\n" movq 32(%0), %%mm4\n"\r\n" movntq %%mm4, 32(%1)\n"\r\n" movq 40(%0), %%mm5\n"\r\n" movntq %%mm5, 40(%1)\n"\r\n" movq 48(%0), %%mm6\n"\r\n" movntq %%mm6, 48(%1)\n"\r\n" movq 56(%0), %%mm7\n"\r\n" movntq %%mm7, 56(%1)\n"\r\n".section .fixup, \"ax\"\n"\r\n"3: movw $0x05EB, 1b\n"\r\n" jmp 2b\n"\r\n".previous\n"\r\n_ASM_EXTABLE(1b, 3b) : : "r" (from), "r" (to) : "memory");\r\nfrom += 64;\r\nto += 64;\r\n}\r\nfor (i = (4096-320)/64; i < 4096/64; i++) {\r\n__asm__ __volatile__ (\r\n"2: movq (%0), %%mm0\n"\r\n" movntq %%mm0, (%1)\n"\r\n" movq 8(%0), %%mm1\n"\r\n" movntq %%mm1, 8(%1)\n"\r\n" movq 16(%0), %%mm2\n"\r\n" movntq %%mm2, 16(%1)\n"\r\n" movq 24(%0), %%mm3\n"\r\n" movntq %%mm3, 24(%1)\n"\r\n" movq 32(%0), %%mm4\n"\r\n" movntq %%mm4, 32(%1)\n"\r\n" movq 40(%0), %%mm5\n"\r\n" movntq %%mm5, 40(%1)\n"\r\n" movq 48(%0), %%mm6\n"\r\n" movntq %%mm6, 48(%1)\n"\r\n" movq 56(%0), %%mm7\n"\r\n" movntq %%mm7, 56(%1)\n"\r\n: : "r" (from), "r" (to) : "memory");\r\nfrom += 64;\r\nto += 64;\r\n}\r\n__asm__ __volatile__("sfence \n"::);\r\nkernel_fpu_end();\r\n}\r\nstatic void fast_clear_page(void *page)\r\n{\r\nint i;\r\nkernel_fpu_begin();\r\n__asm__ __volatile__ (\r\n" pxor %%mm0, %%mm0\n" : :\r\n);\r\nfor (i = 0; i < 4096/128; i++) {\r\n__asm__ __volatile__ (\r\n" movq %%mm0, (%0)\n"\r\n" movq %%mm0, 8(%0)\n"\r\n" movq %%mm0, 16(%0)\n"\r\n" movq %%mm0, 24(%0)\n"\r\n" movq %%mm0, 32(%0)\n"\r\n" movq %%mm0, 40(%0)\n"\r\n" movq %%mm0, 48(%0)\n"\r\n" movq %%mm0, 56(%0)\n"\r\n" movq %%mm0, 64(%0)\n"\r\n" movq %%mm0, 72(%0)\n"\r\n" movq %%mm0, 80(%0)\n"\r\n" movq %%mm0, 88(%0)\n"\r\n" movq %%mm0, 96(%0)\n"\r\n" movq %%mm0, 104(%0)\n"\r\n" movq %%mm0, 112(%0)\n"\r\n" movq %%mm0, 120(%0)\n"\r\n: : "r" (page) : "memory");\r\npage += 128;\r\n}\r\nkernel_fpu_end();\r\n}\r\nstatic void fast_copy_page(void *to, void *from)\r\n{\r\nint i;\r\nkernel_fpu_begin();\r\n__asm__ __volatile__ (\r\n"1: prefetch (%0)\n"\r\n" prefetch 64(%0)\n"\r\n" prefetch 128(%0)\n"\r\n" prefetch 192(%0)\n"\r\n" prefetch 256(%0)\n"\r\n"2: \n"\r\n".section .fixup, \"ax\"\n"\r\n"3: movw $0x1AEB, 1b\n"\r\n" jmp 2b\n"\r\n".previous\n"\r\n_ASM_EXTABLE(1b, 3b) : : "r" (from));\r\nfor (i = 0; i < 4096/64; i++) {\r\n__asm__ __volatile__ (\r\n"1: prefetch 320(%0)\n"\r\n"2: movq (%0), %%mm0\n"\r\n" movq 8(%0), %%mm1\n"\r\n" movq 16(%0), %%mm2\n"\r\n" movq 24(%0), %%mm3\n"\r\n" movq %%mm0, (%1)\n"\r\n" movq %%mm1, 8(%1)\n"\r\n" movq %%mm2, 16(%1)\n"\r\n" movq %%mm3, 24(%1)\n"\r\n" movq 32(%0), %%mm0\n"\r\n" movq 40(%0), %%mm1\n"\r\n" movq 48(%0), %%mm2\n"\r\n" movq 56(%0), %%mm3\n"\r\n" movq %%mm0, 32(%1)\n"\r\n" movq %%mm1, 40(%1)\n"\r\n" movq %%mm2, 48(%1)\n"\r\n" movq %%mm3, 56(%1)\n"\r\n".section .fixup, \"ax\"\n"\r\n"3: movw $0x05EB, 1b\n"\r\n" jmp 2b\n"\r\n".previous\n"\r\n_ASM_EXTABLE(1b, 3b)\r\n: : "r" (from), "r" (to) : "memory");\r\nfrom += 64;\r\nto += 64;\r\n}\r\nkernel_fpu_end();\r\n}\r\nstatic void slow_zero_page(void *page)\r\n{\r\nint d0, d1;\r\n__asm__ __volatile__(\r\n"cld\n\t"\r\n"rep ; stosl"\r\n: "=&c" (d0), "=&D" (d1)\r\n:"a" (0), "1" (page), "0" (1024)\r\n:"memory");\r\n}\r\nvoid mmx_clear_page(void *page)\r\n{\r\nif (unlikely(in_interrupt()))\r\nslow_zero_page(page);\r\nelse\r\nfast_clear_page(page);\r\n}\r\nstatic void slow_copy_page(void *to, void *from)\r\n{\r\nint d0, d1, d2;\r\n__asm__ __volatile__(\r\n"cld\n\t"\r\n"rep ; movsl"\r\n: "=&c" (d0), "=&D" (d1), "=&S" (d2)\r\n: "0" (1024), "1" ((long) to), "2" ((long) from)\r\n: "memory");\r\n}\r\nvoid mmx_copy_page(void *to, void *from)\r\n{\r\nif (unlikely(in_interrupt()))\r\nslow_copy_page(to, from);\r\nelse\r\nfast_copy_page(to, from);\r\n}

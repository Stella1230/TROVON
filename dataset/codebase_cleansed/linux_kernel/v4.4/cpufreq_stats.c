static int cpufreq_stats_update(struct cpufreq_stats *stats)\r\n{\r\nunsigned long long cur_time = get_jiffies_64();\r\nspin_lock(&cpufreq_stats_lock);\r\nstats->time_in_state[stats->last_index] += cur_time - stats->last_time;\r\nstats->last_time = cur_time;\r\nspin_unlock(&cpufreq_stats_lock);\r\nreturn 0;\r\n}\r\nstatic ssize_t show_total_trans(struct cpufreq_policy *policy, char *buf)\r\n{\r\nreturn sprintf(buf, "%d\n", policy->stats->total_trans);\r\n}\r\nstatic ssize_t show_time_in_state(struct cpufreq_policy *policy, char *buf)\r\n{\r\nstruct cpufreq_stats *stats = policy->stats;\r\nssize_t len = 0;\r\nint i;\r\ncpufreq_stats_update(stats);\r\nfor (i = 0; i < stats->state_num; i++) {\r\nlen += sprintf(buf + len, "%u %llu\n", stats->freq_table[i],\r\n(unsigned long long)\r\njiffies_64_to_clock_t(stats->time_in_state[i]));\r\n}\r\nreturn len;\r\n}\r\nstatic ssize_t show_trans_table(struct cpufreq_policy *policy, char *buf)\r\n{\r\nstruct cpufreq_stats *stats = policy->stats;\r\nssize_t len = 0;\r\nint i, j;\r\nlen += snprintf(buf + len, PAGE_SIZE - len, " From : To\n");\r\nlen += snprintf(buf + len, PAGE_SIZE - len, " : ");\r\nfor (i = 0; i < stats->state_num; i++) {\r\nif (len >= PAGE_SIZE)\r\nbreak;\r\nlen += snprintf(buf + len, PAGE_SIZE - len, "%9u ",\r\nstats->freq_table[i]);\r\n}\r\nif (len >= PAGE_SIZE)\r\nreturn PAGE_SIZE;\r\nlen += snprintf(buf + len, PAGE_SIZE - len, "\n");\r\nfor (i = 0; i < stats->state_num; i++) {\r\nif (len >= PAGE_SIZE)\r\nbreak;\r\nlen += snprintf(buf + len, PAGE_SIZE - len, "%9u: ",\r\nstats->freq_table[i]);\r\nfor (j = 0; j < stats->state_num; j++) {\r\nif (len >= PAGE_SIZE)\r\nbreak;\r\nlen += snprintf(buf + len, PAGE_SIZE - len, "%9u ",\r\nstats->trans_table[i*stats->max_state+j]);\r\n}\r\nif (len >= PAGE_SIZE)\r\nbreak;\r\nlen += snprintf(buf + len, PAGE_SIZE - len, "\n");\r\n}\r\nif (len >= PAGE_SIZE)\r\nreturn PAGE_SIZE;\r\nreturn len;\r\n}\r\nstatic int freq_table_get_index(struct cpufreq_stats *stats, unsigned int freq)\r\n{\r\nint index;\r\nfor (index = 0; index < stats->max_state; index++)\r\nif (stats->freq_table[index] == freq)\r\nreturn index;\r\nreturn -1;\r\n}\r\nstatic void __cpufreq_stats_free_table(struct cpufreq_policy *policy)\r\n{\r\nstruct cpufreq_stats *stats = policy->stats;\r\nif (!stats)\r\nreturn;\r\npr_debug("%s: Free stats table\n", __func__);\r\nsysfs_remove_group(&policy->kobj, &stats_attr_group);\r\nkfree(stats->time_in_state);\r\nkfree(stats);\r\npolicy->stats = NULL;\r\n}\r\nstatic void cpufreq_stats_free_table(unsigned int cpu)\r\n{\r\nstruct cpufreq_policy *policy;\r\npolicy = cpufreq_cpu_get(cpu);\r\nif (!policy)\r\nreturn;\r\n__cpufreq_stats_free_table(policy);\r\ncpufreq_cpu_put(policy);\r\n}\r\nstatic int __cpufreq_stats_create_table(struct cpufreq_policy *policy)\r\n{\r\nunsigned int i = 0, count = 0, ret = -ENOMEM;\r\nstruct cpufreq_stats *stats;\r\nunsigned int alloc_size;\r\nunsigned int cpu = policy->cpu;\r\nstruct cpufreq_frequency_table *pos, *table;\r\ntable = cpufreq_frequency_get_table(cpu);\r\nif (unlikely(!table))\r\nreturn 0;\r\nif (policy->stats)\r\nreturn -EEXIST;\r\nstats = kzalloc(sizeof(*stats), GFP_KERNEL);\r\nif (!stats)\r\nreturn -ENOMEM;\r\ncpufreq_for_each_valid_entry(pos, table)\r\ncount++;\r\nalloc_size = count * sizeof(int) + count * sizeof(u64);\r\n#ifdef CONFIG_CPU_FREQ_STAT_DETAILS\r\nalloc_size += count * count * sizeof(int);\r\n#endif\r\nstats->time_in_state = kzalloc(alloc_size, GFP_KERNEL);\r\nif (!stats->time_in_state)\r\ngoto free_stat;\r\nstats->freq_table = (unsigned int *)(stats->time_in_state + count);\r\n#ifdef CONFIG_CPU_FREQ_STAT_DETAILS\r\nstats->trans_table = stats->freq_table + count;\r\n#endif\r\nstats->max_state = count;\r\ncpufreq_for_each_valid_entry(pos, table)\r\nif (freq_table_get_index(stats, pos->frequency) == -1)\r\nstats->freq_table[i++] = pos->frequency;\r\nstats->state_num = i;\r\nstats->last_time = get_jiffies_64();\r\nstats->last_index = freq_table_get_index(stats, policy->cur);\r\npolicy->stats = stats;\r\nret = sysfs_create_group(&policy->kobj, &stats_attr_group);\r\nif (!ret)\r\nreturn 0;\r\npolicy->stats = NULL;\r\nkfree(stats->time_in_state);\r\nfree_stat:\r\nkfree(stats);\r\nreturn ret;\r\n}\r\nstatic void cpufreq_stats_create_table(unsigned int cpu)\r\n{\r\nstruct cpufreq_policy *policy;\r\npolicy = cpufreq_cpu_get(cpu);\r\nif (likely(!policy))\r\nreturn;\r\n__cpufreq_stats_create_table(policy);\r\ncpufreq_cpu_put(policy);\r\n}\r\nstatic int cpufreq_stat_notifier_policy(struct notifier_block *nb,\r\nunsigned long val, void *data)\r\n{\r\nint ret = 0;\r\nstruct cpufreq_policy *policy = data;\r\nif (val == CPUFREQ_CREATE_POLICY)\r\nret = __cpufreq_stats_create_table(policy);\r\nelse if (val == CPUFREQ_REMOVE_POLICY)\r\n__cpufreq_stats_free_table(policy);\r\nreturn ret;\r\n}\r\nstatic int cpufreq_stat_notifier_trans(struct notifier_block *nb,\r\nunsigned long val, void *data)\r\n{\r\nstruct cpufreq_freqs *freq = data;\r\nstruct cpufreq_policy *policy = cpufreq_cpu_get(freq->cpu);\r\nstruct cpufreq_stats *stats;\r\nint old_index, new_index;\r\nif (!policy) {\r\npr_err("%s: No policy found\n", __func__);\r\nreturn 0;\r\n}\r\nif (val != CPUFREQ_POSTCHANGE)\r\ngoto put_policy;\r\nif (!policy->stats) {\r\npr_debug("%s: No stats found\n", __func__);\r\ngoto put_policy;\r\n}\r\nstats = policy->stats;\r\nold_index = stats->last_index;\r\nnew_index = freq_table_get_index(stats, freq->new);\r\nif (old_index == -1 || new_index == -1)\r\ngoto put_policy;\r\nif (old_index == new_index)\r\ngoto put_policy;\r\ncpufreq_stats_update(stats);\r\nstats->last_index = new_index;\r\n#ifdef CONFIG_CPU_FREQ_STAT_DETAILS\r\nstats->trans_table[old_index * stats->max_state + new_index]++;\r\n#endif\r\nstats->total_trans++;\r\nput_policy:\r\ncpufreq_cpu_put(policy);\r\nreturn 0;\r\n}\r\nstatic int __init cpufreq_stats_init(void)\r\n{\r\nint ret;\r\nunsigned int cpu;\r\nspin_lock_init(&cpufreq_stats_lock);\r\nret = cpufreq_register_notifier(&notifier_policy_block,\r\nCPUFREQ_POLICY_NOTIFIER);\r\nif (ret)\r\nreturn ret;\r\nfor_each_online_cpu(cpu)\r\ncpufreq_stats_create_table(cpu);\r\nret = cpufreq_register_notifier(&notifier_trans_block,\r\nCPUFREQ_TRANSITION_NOTIFIER);\r\nif (ret) {\r\ncpufreq_unregister_notifier(&notifier_policy_block,\r\nCPUFREQ_POLICY_NOTIFIER);\r\nfor_each_online_cpu(cpu)\r\ncpufreq_stats_free_table(cpu);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit cpufreq_stats_exit(void)\r\n{\r\nunsigned int cpu;\r\ncpufreq_unregister_notifier(&notifier_policy_block,\r\nCPUFREQ_POLICY_NOTIFIER);\r\ncpufreq_unregister_notifier(&notifier_trans_block,\r\nCPUFREQ_TRANSITION_NOTIFIER);\r\nfor_each_online_cpu(cpu)\r\ncpufreq_stats_free_table(cpu);\r\n}

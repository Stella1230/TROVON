void __init crime_init(void)\r\n{\r\nunsigned int id, rev;\r\nconst int field = 2 * sizeof(unsigned long);\r\nset_io_port_base((unsigned long) ioremap(MACEPCI_LOW_IO, 0x2000000));\r\ncrime = ioremap(CRIME_BASE, sizeof(struct sgi_crime));\r\nmace = ioremap(MACE_BASE, sizeof(struct sgi_mace));\r\nid = crime->id;\r\nrev = id & CRIME_ID_REV;\r\nid = (id & CRIME_ID_IDBITS) >> 4;\r\nprintk(KERN_INFO "CRIME id %1x rev %d at 0x%0*lx\n",\r\nid, rev, field, (unsigned long) CRIME_BASE);\r\n}\r\nirqreturn_t crime_memerr_intr(unsigned int irq, void *dev_id)\r\n{\r\nunsigned long stat, addr;\r\nint fatal = 0;\r\nstat = crime->mem_error_stat & CRIME_MEM_ERROR_STAT_MASK;\r\naddr = crime->mem_error_addr & CRIME_MEM_ERROR_ADDR_MASK;\r\nprintk("CRIME memory error at 0x%08lx ST 0x%08lx<", addr, stat);\r\nif (stat & CRIME_MEM_ERROR_INV)\r\nprintk("INV,");\r\nif (stat & CRIME_MEM_ERROR_ECC) {\r\nunsigned long ecc_syn =\r\ncrime->mem_ecc_syn & CRIME_MEM_ERROR_ECC_SYN_MASK;\r\nunsigned long ecc_gen =\r\ncrime->mem_ecc_chk & CRIME_MEM_ERROR_ECC_CHK_MASK;\r\nprintk("ECC,SYN=0x%08lx,GEN=0x%08lx,", ecc_syn, ecc_gen);\r\n}\r\nif (stat & CRIME_MEM_ERROR_MULTIPLE) {\r\nfatal = 1;\r\nprintk("MULTIPLE,");\r\n}\r\nif (stat & CRIME_MEM_ERROR_HARD_ERR) {\r\nfatal = 1;\r\nprintk("HARD,");\r\n}\r\nif (stat & CRIME_MEM_ERROR_SOFT_ERR)\r\nprintk("SOFT,");\r\nif (stat & CRIME_MEM_ERROR_CPU_ACCESS)\r\nprintk("CPU,");\r\nif (stat & CRIME_MEM_ERROR_VICE_ACCESS)\r\nprintk("VICE,");\r\nif (stat & CRIME_MEM_ERROR_GBE_ACCESS)\r\nprintk("GBE,");\r\nif (stat & CRIME_MEM_ERROR_RE_ACCESS)\r\nprintk("RE,REID=0x%02lx,", (stat & CRIME_MEM_ERROR_RE_ID)>>8);\r\nif (stat & CRIME_MEM_ERROR_MACE_ACCESS)\r\nprintk("MACE,MACEID=0x%02lx,", stat & CRIME_MEM_ERROR_MACE_ID);\r\ncrime->mem_error_stat = 0;\r\nif (fatal) {\r\nprintk("FATAL>\n");\r\npanic("Fatal memory error.");\r\n} else\r\nprintk("NONFATAL>\n");\r\nreturn IRQ_HANDLED;\r\n}\r\nirqreturn_t crime_cpuerr_intr(unsigned int irq, void *dev_id)\r\n{\r\nunsigned long stat = crime->cpu_error_stat & CRIME_CPU_ERROR_MASK;\r\nunsigned long addr = crime->cpu_error_addr & CRIME_CPU_ERROR_ADDR_MASK;\r\naddr <<= 2;\r\nprintk("CRIME CPU error at 0x%09lx status 0x%08lx\n", addr, stat);\r\ncrime->cpu_error_stat = 0;\r\nreturn IRQ_HANDLED;\r\n}

int mantis_pci_init(struct mantis_pci *mantis)\r\n{\r\nu8 latency;\r\nstruct mantis_hwconfig *config = mantis->hwconfig;\r\nstruct pci_dev *pdev = mantis->pdev;\r\nint err, ret = 0;\r\ndprintk(MANTIS_ERROR, 0, "found a %s PCI %s device on (%02x:%02x.%x),\n",\r\nconfig->model_name,\r\nconfig->dev_type,\r\nmantis->pdev->bus->number,\r\nPCI_SLOT(mantis->pdev->devfn),\r\nPCI_FUNC(mantis->pdev->devfn));\r\nerr = pci_enable_device(pdev);\r\nif (err != 0) {\r\nret = -ENODEV;\r\ndprintk(MANTIS_ERROR, 1, "ERROR: PCI enable failed <%i>", err);\r\ngoto fail0;\r\n}\r\nerr = pci_set_consistent_dma_mask(pdev, DMA_BIT_MASK(32));\r\nif (err != 0) {\r\ndprintk(MANTIS_ERROR, 1, "ERROR: Unable to obtain 32 bit DMA <%i>", err);\r\nret = -ENOMEM;\r\ngoto fail1;\r\n}\r\npci_set_master(pdev);\r\nif (!request_mem_region(pci_resource_start(pdev, 0),\r\npci_resource_len(pdev, 0),\r\nDRIVER_NAME)) {\r\ndprintk(MANTIS_ERROR, 1, "ERROR: BAR0 Request failed !");\r\nret = -ENODEV;\r\ngoto fail1;\r\n}\r\nmantis->mmio = ioremap(pci_resource_start(pdev, 0),\r\npci_resource_len(pdev, 0));\r\nif (!mantis->mmio) {\r\ndprintk(MANTIS_ERROR, 1, "ERROR: BAR0 remap failed !");\r\nret = -ENODEV;\r\ngoto fail2;\r\n}\r\npci_read_config_byte(pdev, PCI_LATENCY_TIMER, &latency);\r\nmantis->latency = latency;\r\nmantis->revision = pdev->revision;\r\ndprintk(MANTIS_ERROR, 0, " Mantis Rev %d [%04x:%04x], ",\r\nmantis->revision,\r\nmantis->pdev->subsystem_vendor,\r\nmantis->pdev->subsystem_device);\r\ndprintk(MANTIS_ERROR, 0,\r\n"irq: %d, latency: %d\n memory: 0x%lx, mmio: 0x%p\n",\r\nmantis->pdev->irq,\r\nmantis->latency,\r\nmantis->mantis_addr,\r\nmantis->mmio);\r\nerr = request_irq(pdev->irq,\r\nconfig->irq_handler,\r\nIRQF_SHARED,\r\nDRIVER_NAME,\r\nmantis);\r\nif (err != 0) {\r\ndprintk(MANTIS_ERROR, 1, "ERROR: IRQ registration failed ! <%d>", err);\r\nret = -ENODEV;\r\ngoto fail3;\r\n}\r\npci_set_drvdata(pdev, mantis);\r\nreturn ret;\r\nfail3:\r\ndprintk(MANTIS_ERROR, 1, "ERROR: <%d> I/O unmap", ret);\r\nif (mantis->mmio)\r\niounmap(mantis->mmio);\r\nfail2:\r\ndprintk(MANTIS_ERROR, 1, "ERROR: <%d> releasing regions", ret);\r\nrelease_mem_region(pci_resource_start(pdev, 0),\r\npci_resource_len(pdev, 0));\r\nfail1:\r\ndprintk(MANTIS_ERROR, 1, "ERROR: <%d> disabling device", ret);\r\npci_disable_device(pdev);\r\nfail0:\r\ndprintk(MANTIS_ERROR, 1, "ERROR: <%d> exiting", ret);\r\nreturn ret;\r\n}\r\nvoid mantis_pci_exit(struct mantis_pci *mantis)\r\n{\r\nstruct pci_dev *pdev = mantis->pdev;\r\ndprintk(MANTIS_NOTICE, 1, " mem: 0x%p", mantis->mmio);\r\nfree_irq(pdev->irq, mantis);\r\nif (mantis->mmio) {\r\niounmap(mantis->mmio);\r\nrelease_mem_region(pci_resource_start(pdev, 0),\r\npci_resource_len(pdev, 0));\r\n}\r\npci_disable_device(pdev);\r\n}

static struct inode *oprofilefs_get_inode(struct super_block *sb, int mode)\r\n{\r\nstruct inode *inode = new_inode(sb);\r\nif (inode) {\r\ninode->i_ino = get_next_ino();\r\ninode->i_mode = mode;\r\ninode->i_atime = inode->i_mtime = inode->i_ctime = CURRENT_TIME;\r\n}\r\nreturn inode;\r\n}\r\nssize_t oprofilefs_str_to_user(char const *str, char __user *buf, size_t count, loff_t *offset)\r\n{\r\nreturn simple_read_from_buffer(buf, count, offset, str, strlen(str));\r\n}\r\nssize_t oprofilefs_ulong_to_user(unsigned long val, char __user *buf, size_t count, loff_t *offset)\r\n{\r\nchar tmpbuf[TMPBUFSIZE];\r\nsize_t maxlen = snprintf(tmpbuf, TMPBUFSIZE, "%lu\n", val);\r\nif (maxlen > TMPBUFSIZE)\r\nmaxlen = TMPBUFSIZE;\r\nreturn simple_read_from_buffer(buf, count, offset, tmpbuf, maxlen);\r\n}\r\nint oprofilefs_ulong_from_user(unsigned long *val, char const __user *buf, size_t count)\r\n{\r\nchar tmpbuf[TMPBUFSIZE];\r\nunsigned long flags;\r\nif (!count)\r\nreturn 0;\r\nif (count > TMPBUFSIZE - 1)\r\nreturn -EINVAL;\r\nmemset(tmpbuf, 0x0, TMPBUFSIZE);\r\nif (copy_from_user(tmpbuf, buf, count))\r\nreturn -EFAULT;\r\nraw_spin_lock_irqsave(&oprofilefs_lock, flags);\r\n*val = simple_strtoul(tmpbuf, NULL, 0);\r\nraw_spin_unlock_irqrestore(&oprofilefs_lock, flags);\r\nreturn count;\r\n}\r\nstatic ssize_t ulong_read_file(struct file *file, char __user *buf, size_t count, loff_t *offset)\r\n{\r\nunsigned long *val = file->private_data;\r\nreturn oprofilefs_ulong_to_user(*val, buf, count, offset);\r\n}\r\nstatic ssize_t ulong_write_file(struct file *file, char const __user *buf, size_t count, loff_t *offset)\r\n{\r\nunsigned long value;\r\nint retval;\r\nif (*offset)\r\nreturn -EINVAL;\r\nretval = oprofilefs_ulong_from_user(&value, buf, count);\r\nif (retval <= 0)\r\nreturn retval;\r\nretval = oprofile_set_ulong(file->private_data, value);\r\nif (retval)\r\nreturn retval;\r\nreturn count;\r\n}\r\nstatic int __oprofilefs_create_file(struct dentry *root, char const *name,\r\nconst struct file_operations *fops, int perm, void *priv)\r\n{\r\nstruct dentry *dentry;\r\nstruct inode *inode;\r\nmutex_lock(&d_inode(root)->i_mutex);\r\ndentry = d_alloc_name(root, name);\r\nif (!dentry) {\r\nmutex_unlock(&d_inode(root)->i_mutex);\r\nreturn -ENOMEM;\r\n}\r\ninode = oprofilefs_get_inode(root->d_sb, S_IFREG | perm);\r\nif (!inode) {\r\ndput(dentry);\r\nmutex_unlock(&d_inode(root)->i_mutex);\r\nreturn -ENOMEM;\r\n}\r\ninode->i_fop = fops;\r\ninode->i_private = priv;\r\nd_add(dentry, inode);\r\nmutex_unlock(&d_inode(root)->i_mutex);\r\nreturn 0;\r\n}\r\nint oprofilefs_create_ulong(struct dentry *root,\r\nchar const *name, unsigned long *val)\r\n{\r\nreturn __oprofilefs_create_file(root, name,\r\n&ulong_fops, 0644, val);\r\n}\r\nint oprofilefs_create_ro_ulong(struct dentry *root,\r\nchar const *name, unsigned long *val)\r\n{\r\nreturn __oprofilefs_create_file(root, name,\r\n&ulong_ro_fops, 0444, val);\r\n}\r\nstatic ssize_t atomic_read_file(struct file *file, char __user *buf, size_t count, loff_t *offset)\r\n{\r\natomic_t *val = file->private_data;\r\nreturn oprofilefs_ulong_to_user(atomic_read(val), buf, count, offset);\r\n}\r\nint oprofilefs_create_ro_atomic(struct dentry *root,\r\nchar const *name, atomic_t *val)\r\n{\r\nreturn __oprofilefs_create_file(root, name,\r\n&atomic_ro_fops, 0444, val);\r\n}\r\nint oprofilefs_create_file(struct dentry *root,\r\nchar const *name, const struct file_operations *fops)\r\n{\r\nreturn __oprofilefs_create_file(root, name, fops, 0644, NULL);\r\n}\r\nint oprofilefs_create_file_perm(struct dentry *root,\r\nchar const *name, const struct file_operations *fops, int perm)\r\n{\r\nreturn __oprofilefs_create_file(root, name, fops, perm, NULL);\r\n}\r\nstruct dentry *oprofilefs_mkdir(struct dentry *parent, char const *name)\r\n{\r\nstruct dentry *dentry;\r\nstruct inode *inode;\r\nmutex_lock(&d_inode(parent)->i_mutex);\r\ndentry = d_alloc_name(parent, name);\r\nif (!dentry) {\r\nmutex_unlock(&d_inode(parent)->i_mutex);\r\nreturn NULL;\r\n}\r\ninode = oprofilefs_get_inode(parent->d_sb, S_IFDIR | 0755);\r\nif (!inode) {\r\ndput(dentry);\r\nmutex_unlock(&d_inode(parent)->i_mutex);\r\nreturn NULL;\r\n}\r\ninode->i_op = &simple_dir_inode_operations;\r\ninode->i_fop = &simple_dir_operations;\r\nd_add(dentry, inode);\r\nmutex_unlock(&d_inode(parent)->i_mutex);\r\nreturn dentry;\r\n}\r\nstatic int oprofilefs_fill_super(struct super_block *sb, void *data, int silent)\r\n{\r\nstruct inode *root_inode;\r\nsb->s_blocksize = PAGE_CACHE_SIZE;\r\nsb->s_blocksize_bits = PAGE_CACHE_SHIFT;\r\nsb->s_magic = OPROFILEFS_MAGIC;\r\nsb->s_op = &s_ops;\r\nsb->s_time_gran = 1;\r\nroot_inode = oprofilefs_get_inode(sb, S_IFDIR | 0755);\r\nif (!root_inode)\r\nreturn -ENOMEM;\r\nroot_inode->i_op = &simple_dir_inode_operations;\r\nroot_inode->i_fop = &simple_dir_operations;\r\nsb->s_root = d_make_root(root_inode);\r\nif (!sb->s_root)\r\nreturn -ENOMEM;\r\noprofile_create_files(sb->s_root);\r\nreturn 0;\r\n}\r\nstatic struct dentry *oprofilefs_mount(struct file_system_type *fs_type,\r\nint flags, const char *dev_name, void *data)\r\n{\r\nreturn mount_single(fs_type, flags, data, oprofilefs_fill_super);\r\n}\r\nint __init oprofilefs_register(void)\r\n{\r\nreturn register_filesystem(&oprofilefs_type);\r\n}\r\nvoid __exit oprofilefs_unregister(void)\r\n{\r\nunregister_filesystem(&oprofilefs_type);\r\n}

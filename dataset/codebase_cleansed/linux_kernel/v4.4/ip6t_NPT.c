static int ip6t_npt_checkentry(const struct xt_tgchk_param *par)\r\n{\r\nstruct ip6t_npt_tginfo *npt = par->targinfo;\r\nstruct in6_addr pfx;\r\n__wsum src_sum, dst_sum;\r\nif (npt->src_pfx_len > 64 || npt->dst_pfx_len > 64)\r\nreturn -EINVAL;\r\nipv6_addr_prefix(&pfx, &npt->src_pfx.in6, npt->src_pfx_len);\r\nif (!ipv6_addr_equal(&pfx, &npt->src_pfx.in6))\r\nreturn -EINVAL;\r\nipv6_addr_prefix(&pfx, &npt->dst_pfx.in6, npt->dst_pfx_len);\r\nif (!ipv6_addr_equal(&pfx, &npt->dst_pfx.in6))\r\nreturn -EINVAL;\r\nsrc_sum = csum_partial(&npt->src_pfx.in6, sizeof(npt->src_pfx.in6), 0);\r\ndst_sum = csum_partial(&npt->dst_pfx.in6, sizeof(npt->dst_pfx.in6), 0);\r\nnpt->adjustment = ~csum_fold(csum_sub(src_sum, dst_sum));\r\nreturn 0;\r\n}\r\nstatic bool ip6t_npt_map_pfx(const struct ip6t_npt_tginfo *npt,\r\nstruct in6_addr *addr)\r\n{\r\nunsigned int pfx_len;\r\nunsigned int i, idx;\r\n__be32 mask;\r\n__sum16 sum;\r\npfx_len = max(npt->src_pfx_len, npt->dst_pfx_len);\r\nfor (i = 0; i < pfx_len; i += 32) {\r\nif (pfx_len - i >= 32)\r\nmask = 0;\r\nelse\r\nmask = htonl((1 << (i - pfx_len + 32)) - 1);\r\nidx = i / 32;\r\naddr->s6_addr32[idx] &= mask;\r\naddr->s6_addr32[idx] |= ~mask & npt->dst_pfx.in6.s6_addr32[idx];\r\n}\r\nif (pfx_len <= 48)\r\nidx = 3;\r\nelse {\r\nfor (idx = 4; idx < ARRAY_SIZE(addr->s6_addr16); idx++) {\r\nif ((__force __sum16)addr->s6_addr16[idx] !=\r\nCSUM_MANGLED_0)\r\nbreak;\r\n}\r\nif (idx == ARRAY_SIZE(addr->s6_addr16))\r\nreturn false;\r\n}\r\nsum = ~csum_fold(csum_add(csum_unfold((__force __sum16)addr->s6_addr16[idx]),\r\ncsum_unfold(npt->adjustment)));\r\nif (sum == CSUM_MANGLED_0)\r\nsum = 0;\r\n*(__force __sum16 *)&addr->s6_addr16[idx] = sum;\r\nreturn true;\r\n}\r\nstatic unsigned int\r\nip6t_snpt_tg(struct sk_buff *skb, const struct xt_action_param *par)\r\n{\r\nconst struct ip6t_npt_tginfo *npt = par->targinfo;\r\nif (!ip6t_npt_map_pfx(npt, &ipv6_hdr(skb)->saddr)) {\r\nicmpv6_send(skb, ICMPV6_PARAMPROB, ICMPV6_HDR_FIELD,\r\noffsetof(struct ipv6hdr, saddr));\r\nreturn NF_DROP;\r\n}\r\nreturn XT_CONTINUE;\r\n}\r\nstatic unsigned int\r\nip6t_dnpt_tg(struct sk_buff *skb, const struct xt_action_param *par)\r\n{\r\nconst struct ip6t_npt_tginfo *npt = par->targinfo;\r\nif (!ip6t_npt_map_pfx(npt, &ipv6_hdr(skb)->daddr)) {\r\nicmpv6_send(skb, ICMPV6_PARAMPROB, ICMPV6_HDR_FIELD,\r\noffsetof(struct ipv6hdr, daddr));\r\nreturn NF_DROP;\r\n}\r\nreturn XT_CONTINUE;\r\n}\r\nstatic int __init ip6t_npt_init(void)\r\n{\r\nreturn xt_register_targets(ip6t_npt_target_reg,\r\nARRAY_SIZE(ip6t_npt_target_reg));\r\n}\r\nstatic void __exit ip6t_npt_exit(void)\r\n{\r\nxt_unregister_targets(ip6t_npt_target_reg,\r\nARRAY_SIZE(ip6t_npt_target_reg));\r\n}

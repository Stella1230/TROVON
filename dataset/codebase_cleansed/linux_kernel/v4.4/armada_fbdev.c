static int armada_fb_create(struct drm_fb_helper *fbh,\r\nstruct drm_fb_helper_surface_size *sizes)\r\n{\r\nstruct drm_device *dev = fbh->dev;\r\nstruct drm_mode_fb_cmd2 mode;\r\nstruct armada_framebuffer *dfb;\r\nstruct armada_gem_object *obj;\r\nstruct fb_info *info;\r\nint size, ret;\r\nvoid *ptr;\r\nmemset(&mode, 0, sizeof(mode));\r\nmode.width = sizes->surface_width;\r\nmode.height = sizes->surface_height;\r\nmode.pitches[0] = armada_pitch(mode.width, sizes->surface_bpp);\r\nmode.pixel_format = drm_mode_legacy_fb_format(sizes->surface_bpp,\r\nsizes->surface_depth);\r\nsize = mode.pitches[0] * mode.height;\r\nobj = armada_gem_alloc_private_object(dev, size);\r\nif (!obj) {\r\nDRM_ERROR("failed to allocate fb memory\n");\r\nreturn -ENOMEM;\r\n}\r\nret = armada_gem_linear_back(dev, obj);\r\nif (ret) {\r\ndrm_gem_object_unreference_unlocked(&obj->obj);\r\nreturn ret;\r\n}\r\nptr = armada_gem_map_object(dev, obj);\r\nif (!ptr) {\r\ndrm_gem_object_unreference_unlocked(&obj->obj);\r\nreturn -ENOMEM;\r\n}\r\ndfb = armada_framebuffer_create(dev, &mode, obj);\r\ndrm_gem_object_unreference_unlocked(&obj->obj);\r\nif (IS_ERR(dfb))\r\nreturn PTR_ERR(dfb);\r\ninfo = drm_fb_helper_alloc_fbi(fbh);\r\nif (IS_ERR(info)) {\r\nret = PTR_ERR(info);\r\ngoto err_fballoc;\r\n}\r\nstrlcpy(info->fix.id, "armada-drmfb", sizeof(info->fix.id));\r\ninfo->par = fbh;\r\ninfo->flags = FBINFO_DEFAULT | FBINFO_CAN_FORCE_OUTPUT;\r\ninfo->fbops = &armada_fb_ops;\r\ninfo->fix.smem_start = obj->phys_addr;\r\ninfo->fix.smem_len = obj->obj.size;\r\ninfo->screen_size = obj->obj.size;\r\ninfo->screen_base = ptr;\r\nfbh->fb = &dfb->fb;\r\ndrm_fb_helper_fill_fix(info, dfb->fb.pitches[0], dfb->fb.depth);\r\ndrm_fb_helper_fill_var(info, fbh, sizes->fb_width, sizes->fb_height);\r\nDRM_DEBUG_KMS("allocated %dx%d %dbpp fb: 0x%08llx\n",\r\ndfb->fb.width, dfb->fb.height, dfb->fb.bits_per_pixel,\r\n(unsigned long long)obj->phys_addr);\r\nreturn 0;\r\nerr_fballoc:\r\ndfb->fb.funcs->destroy(&dfb->fb);\r\nreturn ret;\r\n}\r\nstatic int armada_fb_probe(struct drm_fb_helper *fbh,\r\nstruct drm_fb_helper_surface_size *sizes)\r\n{\r\nint ret = 0;\r\nif (!fbh->fb) {\r\nret = armada_fb_create(fbh, sizes);\r\nif (ret == 0)\r\nret = 1;\r\n}\r\nreturn ret;\r\n}\r\nint armada_fbdev_init(struct drm_device *dev)\r\n{\r\nstruct armada_private *priv = dev->dev_private;\r\nstruct drm_fb_helper *fbh;\r\nint ret;\r\nfbh = devm_kzalloc(dev->dev, sizeof(*fbh), GFP_KERNEL);\r\nif (!fbh)\r\nreturn -ENOMEM;\r\npriv->fbdev = fbh;\r\ndrm_fb_helper_prepare(dev, fbh, &armada_fb_helper_funcs);\r\nret = drm_fb_helper_init(dev, fbh, 1, 1);\r\nif (ret) {\r\nDRM_ERROR("failed to initialize drm fb helper\n");\r\ngoto err_fb_helper;\r\n}\r\nret = drm_fb_helper_single_add_all_connectors(fbh);\r\nif (ret) {\r\nDRM_ERROR("failed to add fb connectors\n");\r\ngoto err_fb_setup;\r\n}\r\nret = drm_fb_helper_initial_config(fbh, 32);\r\nif (ret) {\r\nDRM_ERROR("failed to set initial config\n");\r\ngoto err_fb_setup;\r\n}\r\nreturn 0;\r\nerr_fb_setup:\r\ndrm_fb_helper_release_fbi(fbh);\r\ndrm_fb_helper_fini(fbh);\r\nerr_fb_helper:\r\npriv->fbdev = NULL;\r\nreturn ret;\r\n}\r\nvoid armada_fbdev_lastclose(struct drm_device *dev)\r\n{\r\nstruct armada_private *priv = dev->dev_private;\r\nif (priv->fbdev)\r\ndrm_fb_helper_restore_fbdev_mode_unlocked(priv->fbdev);\r\n}\r\nvoid armada_fbdev_fini(struct drm_device *dev)\r\n{\r\nstruct armada_private *priv = dev->dev_private;\r\nstruct drm_fb_helper *fbh = priv->fbdev;\r\nif (fbh) {\r\ndrm_fb_helper_unregister_fbi(fbh);\r\ndrm_fb_helper_release_fbi(fbh);\r\ndrm_fb_helper_fini(fbh);\r\nif (fbh->fb)\r\nfbh->fb->funcs->destroy(fbh->fb);\r\npriv->fbdev = NULL;\r\n}\r\n}

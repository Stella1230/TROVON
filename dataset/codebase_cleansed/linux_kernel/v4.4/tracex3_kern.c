int bpf_prog1(struct pt_regs *ctx)\r\n{\r\nlong rq = PT_REGS_PARM1(ctx);\r\nu64 val = bpf_ktime_get_ns();\r\nbpf_map_update_elem(&my_map, &rq, &val, BPF_ANY);\r\nreturn 0;\r\n}\r\nstatic unsigned int log2l(unsigned long long n)\r\n{\r\n#define S(k) if (n >= (1ull << k)) { i += k; n >>= k; }\r\nint i = -(n == 0);\r\nS(32); S(16); S(8); S(4); S(2); S(1);\r\nreturn i;\r\n#undef S\r\n}\r\nint bpf_prog2(struct pt_regs *ctx)\r\n{\r\nlong rq = PT_REGS_PARM1(ctx);\r\nu64 *value, l, base;\r\nu32 index;\r\nvalue = bpf_map_lookup_elem(&my_map, &rq);\r\nif (!value)\r\nreturn 0;\r\nu64 cur_time = bpf_ktime_get_ns();\r\nu64 delta = cur_time - *value;\r\nbpf_map_delete_elem(&my_map, &rq);\r\nl = log2l(delta);\r\nbase = 1ll << l;\r\nindex = (l * 64 + (delta - base) * 64 / base) * 3 / 64;\r\nif (index >= SLOTS)\r\nindex = SLOTS - 1;\r\nvalue = bpf_map_lookup_elem(&lat_map, &index);\r\nif (value)\r\n__sync_fetch_and_add((long *)value, 1);\r\nreturn 0;\r\n}

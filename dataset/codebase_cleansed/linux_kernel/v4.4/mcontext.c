void get_regs_from_mc(struct uml_pt_regs *regs, mcontext_t *mc)\r\n{\r\n#ifdef __i386__\r\n#define COPY2(X,Y) regs->gp[X] = mc->gregs[REG_##Y]\r\n#define COPY(X) regs->gp[X] = mc->gregs[REG_##X]\r\n#define COPY_SEG(X) regs->gp[X] = mc->gregs[REG_##X] & 0xffff;\r\n#define COPY_SEG_CPL3(X) regs->gp[X] = (mc->gregs[REG_##X] & 0xffff) | 3;\r\nCOPY_SEG(GS); COPY_SEG(FS); COPY_SEG(ES); COPY_SEG(DS);\r\nCOPY(EDI); COPY(ESI); COPY(EBP);\r\nCOPY2(UESP, ESP);\r\nCOPY(EBX); COPY(EDX); COPY(ECX); COPY(EAX);\r\nCOPY(EIP); COPY_SEG_CPL3(CS); COPY(EFL); COPY_SEG_CPL3(SS);\r\n#else\r\n#define COPY2(X,Y) regs->gp[X/sizeof(unsigned long)] = mc->gregs[REG_##Y]\r\n#define COPY(X) regs->gp[X/sizeof(unsigned long)] = mc->gregs[REG_##X]\r\nCOPY(R8); COPY(R9); COPY(R10); COPY(R11);\r\nCOPY(R12); COPY(R13); COPY(R14); COPY(R15);\r\nCOPY(RDI); COPY(RSI); COPY(RBP); COPY(RBX);\r\nCOPY(RDX); COPY(RAX); COPY(RCX); COPY(RSP);\r\nCOPY(RIP);\r\nCOPY2(EFLAGS, EFL);\r\nCOPY2(CS, CSGSFS);\r\nregs->gp[CS / sizeof(unsigned long)] &= 0xffff;\r\nregs->gp[CS / sizeof(unsigned long)] |= 3;\r\n#endif\r\n}

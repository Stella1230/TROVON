static int tegra_timer_set_next_event(unsigned long cycles,\r\nstruct clock_event_device *evt)\r\n{\r\nu32 reg;\r\nreg = 0x80000000 | ((cycles > 1) ? (cycles-1) : 0);\r\ntimer_writel(reg, TIMER3_BASE + TIMER_PTV);\r\nreturn 0;\r\n}\r\nstatic inline void timer_shutdown(struct clock_event_device *evt)\r\n{\r\ntimer_writel(0, TIMER3_BASE + TIMER_PTV);\r\n}\r\nstatic int tegra_timer_shutdown(struct clock_event_device *evt)\r\n{\r\ntimer_shutdown(evt);\r\nreturn 0;\r\n}\r\nstatic int tegra_timer_set_periodic(struct clock_event_device *evt)\r\n{\r\nu32 reg = 0xC0000000 | ((1000000 / HZ) - 1);\r\ntimer_shutdown(evt);\r\ntimer_writel(reg, TIMER3_BASE + TIMER_PTV);\r\nreturn 0;\r\n}\r\nstatic u64 notrace tegra_read_sched_clock(void)\r\n{\r\nreturn timer_readl(TIMERUS_CNTR_1US);\r\n}\r\nstatic u64 tegra_rtc_read_ms(void)\r\n{\r\nu32 ms = readl(rtc_base + RTC_MILLISECONDS);\r\nu32 s = readl(rtc_base + RTC_SHADOW_SECONDS);\r\nreturn (u64)s * MSEC_PER_SEC + ms;\r\n}\r\nstatic void tegra_read_persistent_clock64(struct timespec64 *ts)\r\n{\r\nu64 delta;\r\nlast_persistent_ms = persistent_ms;\r\npersistent_ms = tegra_rtc_read_ms();\r\ndelta = persistent_ms - last_persistent_ms;\r\ntimespec64_add_ns(&persistent_ts, delta * NSEC_PER_MSEC);\r\n*ts = persistent_ts;\r\n}\r\nstatic unsigned long tegra_delay_timer_read_counter_long(void)\r\n{\r\nreturn readl(timer_reg_base + TIMERUS_CNTR_1US);\r\n}\r\nstatic irqreturn_t tegra_timer_interrupt(int irq, void *dev_id)\r\n{\r\nstruct clock_event_device *evt = (struct clock_event_device *)dev_id;\r\ntimer_writel(1<<30, TIMER3_BASE + TIMER_PCR);\r\nevt->event_handler(evt);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void __init tegra20_init_timer(struct device_node *np)\r\n{\r\nstruct clk *clk;\r\nunsigned long rate;\r\nint ret;\r\ntimer_reg_base = of_iomap(np, 0);\r\nif (!timer_reg_base) {\r\npr_err("Can't map timer registers\n");\r\nBUG();\r\n}\r\ntegra_timer_irq.irq = irq_of_parse_and_map(np, 2);\r\nif (tegra_timer_irq.irq <= 0) {\r\npr_err("Failed to map timer IRQ\n");\r\nBUG();\r\n}\r\nclk = of_clk_get(np, 0);\r\nif (IS_ERR(clk)) {\r\npr_warn("Unable to get timer clock. Assuming 12Mhz input clock.\n");\r\nrate = 12000000;\r\n} else {\r\nclk_prepare_enable(clk);\r\nrate = clk_get_rate(clk);\r\n}\r\nswitch (rate) {\r\ncase 12000000:\r\ntimer_writel(0x000b, TIMERUS_USEC_CFG);\r\nbreak;\r\ncase 13000000:\r\ntimer_writel(0x000c, TIMERUS_USEC_CFG);\r\nbreak;\r\ncase 19200000:\r\ntimer_writel(0x045f, TIMERUS_USEC_CFG);\r\nbreak;\r\ncase 26000000:\r\ntimer_writel(0x0019, TIMERUS_USEC_CFG);\r\nbreak;\r\ndefault:\r\nWARN(1, "Unknown clock rate");\r\n}\r\nsched_clock_register(tegra_read_sched_clock, 32, 1000000);\r\nif (clocksource_mmio_init(timer_reg_base + TIMERUS_CNTR_1US,\r\n"timer_us", 1000000, 300, 32, clocksource_mmio_readl_up)) {\r\npr_err("Failed to register clocksource\n");\r\nBUG();\r\n}\r\ntegra_delay_timer.read_current_timer =\r\ntegra_delay_timer_read_counter_long;\r\ntegra_delay_timer.freq = 1000000;\r\nregister_current_timer_delay(&tegra_delay_timer);\r\nret = setup_irq(tegra_timer_irq.irq, &tegra_timer_irq);\r\nif (ret) {\r\npr_err("Failed to register timer IRQ: %d\n", ret);\r\nBUG();\r\n}\r\ntegra_clockevent.cpumask = cpu_all_mask;\r\ntegra_clockevent.irq = tegra_timer_irq.irq;\r\nclockevents_config_and_register(&tegra_clockevent, 1000000,\r\n0x1, 0x1fffffff);\r\n}\r\nstatic void __init tegra20_init_rtc(struct device_node *np)\r\n{\r\nstruct clk *clk;\r\nrtc_base = of_iomap(np, 0);\r\nif (!rtc_base) {\r\npr_err("Can't map RTC registers");\r\nBUG();\r\n}\r\nclk = of_clk_get(np, 0);\r\nif (IS_ERR(clk))\r\npr_warn("Unable to get rtc-tegra clock\n");\r\nelse\r\nclk_prepare_enable(clk);\r\nregister_persistent_clock(NULL, tegra_read_persistent_clock64);\r\n}\r\nvoid tegra_timer_suspend(void)\r\n{\r\nusec_config = timer_readl(TIMERUS_USEC_CFG);\r\n}\r\nvoid tegra_timer_resume(void)\r\n{\r\ntimer_writel(usec_config, TIMERUS_USEC_CFG);\r\n}

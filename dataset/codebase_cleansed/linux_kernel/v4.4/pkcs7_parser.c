static void pkcs7_free_signed_info(struct pkcs7_signed_info *sinfo)\r\n{\r\nif (sinfo) {\r\nmpi_free(sinfo->sig.mpi[0]);\r\nkfree(sinfo->sig.digest);\r\nkfree(sinfo->signing_cert_id);\r\nkfree(sinfo);\r\n}\r\n}\r\nvoid pkcs7_free_message(struct pkcs7_message *pkcs7)\r\n{\r\nstruct x509_certificate *cert;\r\nstruct pkcs7_signed_info *sinfo;\r\nif (pkcs7) {\r\nwhile (pkcs7->certs) {\r\ncert = pkcs7->certs;\r\npkcs7->certs = cert->next;\r\nx509_free_certificate(cert);\r\n}\r\nwhile (pkcs7->crl) {\r\ncert = pkcs7->crl;\r\npkcs7->crl = cert->next;\r\nx509_free_certificate(cert);\r\n}\r\nwhile (pkcs7->signed_infos) {\r\nsinfo = pkcs7->signed_infos;\r\npkcs7->signed_infos = sinfo->next;\r\npkcs7_free_signed_info(sinfo);\r\n}\r\nkfree(pkcs7);\r\n}\r\n}\r\nstatic int pkcs7_check_authattrs(struct pkcs7_message *msg)\r\n{\r\nstruct pkcs7_signed_info *sinfo;\r\nbool want;\r\nsinfo = msg->signed_infos;\r\nif (sinfo->authattrs) {\r\nwant = true;\r\nmsg->have_authattrs = true;\r\n}\r\nfor (sinfo = sinfo->next; sinfo; sinfo = sinfo->next)\r\nif (!!sinfo->authattrs != want)\r\ngoto inconsistent;\r\nreturn 0;\r\ninconsistent:\r\npr_warn("Inconsistently supplied authAttrs\n");\r\nreturn -EINVAL;\r\n}\r\nstruct pkcs7_message *pkcs7_parse_message(const void *data, size_t datalen)\r\n{\r\nstruct pkcs7_parse_context *ctx;\r\nstruct pkcs7_message *msg = ERR_PTR(-ENOMEM);\r\nint ret;\r\nctx = kzalloc(sizeof(struct pkcs7_parse_context), GFP_KERNEL);\r\nif (!ctx)\r\ngoto out_no_ctx;\r\nctx->msg = kzalloc(sizeof(struct pkcs7_message), GFP_KERNEL);\r\nif (!ctx->msg)\r\ngoto out_no_msg;\r\nctx->sinfo = kzalloc(sizeof(struct pkcs7_signed_info), GFP_KERNEL);\r\nif (!ctx->sinfo)\r\ngoto out_no_sinfo;\r\nctx->data = (unsigned long)data;\r\nctx->ppcerts = &ctx->certs;\r\nctx->ppsinfo = &ctx->msg->signed_infos;\r\nret = asn1_ber_decoder(&pkcs7_decoder, ctx, data, datalen);\r\nif (ret < 0) {\r\nmsg = ERR_PTR(ret);\r\ngoto out;\r\n}\r\nret = pkcs7_check_authattrs(ctx->msg);\r\nif (ret < 0)\r\ngoto out;\r\nmsg = ctx->msg;\r\nctx->msg = NULL;\r\nout:\r\nwhile (ctx->certs) {\r\nstruct x509_certificate *cert = ctx->certs;\r\nctx->certs = cert->next;\r\nx509_free_certificate(cert);\r\n}\r\npkcs7_free_signed_info(ctx->sinfo);\r\nout_no_sinfo:\r\npkcs7_free_message(ctx->msg);\r\nout_no_msg:\r\nkfree(ctx);\r\nout_no_ctx:\r\nreturn msg;\r\n}\r\nint pkcs7_get_content_data(const struct pkcs7_message *pkcs7,\r\nconst void **_data, size_t *_data_len,\r\nbool want_wrapper)\r\n{\r\nsize_t wrapper;\r\nif (!pkcs7->data)\r\nreturn -ENODATA;\r\nwrapper = want_wrapper ? pkcs7->data_hdrlen : 0;\r\n*_data = pkcs7->data - wrapper;\r\n*_data_len = pkcs7->data_len + wrapper;\r\nreturn 0;\r\n}\r\nint pkcs7_note_OID(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\nctx->last_oid = look_up_OID(value, vlen);\r\nif (ctx->last_oid == OID__NR) {\r\nchar buffer[50];\r\nsprint_oid(value, vlen, buffer, sizeof(buffer));\r\nprintk("PKCS7: Unknown OID: [%lu] %s\n",\r\n(unsigned long)value - ctx->data, buffer);\r\n}\r\nreturn 0;\r\n}\r\nint pkcs7_sig_note_digest_algo(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\nswitch (ctx->last_oid) {\r\ncase OID_md4:\r\nctx->sinfo->sig.pkey_hash_algo = HASH_ALGO_MD4;\r\nbreak;\r\ncase OID_md5:\r\nctx->sinfo->sig.pkey_hash_algo = HASH_ALGO_MD5;\r\nbreak;\r\ncase OID_sha1:\r\nctx->sinfo->sig.pkey_hash_algo = HASH_ALGO_SHA1;\r\nbreak;\r\ncase OID_sha256:\r\nctx->sinfo->sig.pkey_hash_algo = HASH_ALGO_SHA256;\r\nbreak;\r\ncase OID_sha384:\r\nctx->sinfo->sig.pkey_hash_algo = HASH_ALGO_SHA384;\r\nbreak;\r\ncase OID_sha512:\r\nctx->sinfo->sig.pkey_hash_algo = HASH_ALGO_SHA512;\r\nbreak;\r\ncase OID_sha224:\r\nctx->sinfo->sig.pkey_hash_algo = HASH_ALGO_SHA224;\r\ndefault:\r\nprintk("Unsupported digest algo: %u\n", ctx->last_oid);\r\nreturn -ENOPKG;\r\n}\r\nreturn 0;\r\n}\r\nint pkcs7_sig_note_pkey_algo(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\nswitch (ctx->last_oid) {\r\ncase OID_rsaEncryption:\r\nctx->sinfo->sig.pkey_algo = PKEY_ALGO_RSA;\r\nbreak;\r\ndefault:\r\nprintk("Unsupported pkey algo: %u\n", ctx->last_oid);\r\nreturn -ENOPKG;\r\n}\r\nreturn 0;\r\n}\r\nint pkcs7_check_content_type(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\nif (ctx->last_oid != OID_signed_data) {\r\npr_warn("Only support pkcs7_signedData type\n");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nint pkcs7_note_signeddata_version(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\nunsigned version;\r\nif (vlen != 1)\r\ngoto unsupported;\r\nctx->msg->version = version = *(const u8 *)value;\r\nswitch (version) {\r\ncase 1:\r\nbreak;\r\ncase 3:\r\nbreak;\r\ndefault:\r\ngoto unsupported;\r\n}\r\nreturn 0;\r\nunsupported:\r\npr_warn("Unsupported SignedData version\n");\r\nreturn -EINVAL;\r\n}\r\nint pkcs7_note_signerinfo_version(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\nunsigned version;\r\nif (vlen != 1)\r\ngoto unsupported;\r\nversion = *(const u8 *)value;\r\nswitch (version) {\r\ncase 1:\r\nif (ctx->msg->version != 1)\r\ngoto version_mismatch;\r\nctx->expect_skid = false;\r\nbreak;\r\ncase 3:\r\nif (ctx->msg->version == 1)\r\ngoto version_mismatch;\r\nctx->expect_skid = true;\r\nbreak;\r\ndefault:\r\ngoto unsupported;\r\n}\r\nreturn 0;\r\nunsupported:\r\npr_warn("Unsupported SignerInfo version\n");\r\nreturn -EINVAL;\r\nversion_mismatch:\r\npr_warn("SignedData-SignerInfo version mismatch\n");\r\nreturn -EBADMSG;\r\n}\r\nint pkcs7_extract_cert(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\nstruct x509_certificate *x509;\r\nif (tag != ((ASN1_UNIV << 6) | ASN1_CONS_BIT | ASN1_SEQ)) {\r\npr_debug("Cert began with tag %02x at %lu\n",\r\ntag, (unsigned long)ctx - ctx->data);\r\nreturn -EBADMSG;\r\n}\r\nvalue -= hdrlen;\r\nvlen += hdrlen;\r\nif (((u8*)value)[1] == 0x80)\r\nvlen += 2;\r\nx509 = x509_cert_parse(value, vlen);\r\nif (IS_ERR(x509))\r\nreturn PTR_ERR(x509);\r\nx509->index = ++ctx->x509_index;\r\npr_debug("Got cert %u for %s\n", x509->index, x509->subject);\r\npr_debug("- fingerprint %*phN\n", x509->id->len, x509->id->data);\r\n*ctx->ppcerts = x509;\r\nctx->ppcerts = &x509->next;\r\nreturn 0;\r\n}\r\nint pkcs7_note_certificate_list(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\npr_devel("Got cert list (%02x)\n", tag);\r\n*ctx->ppcerts = ctx->msg->certs;\r\nctx->msg->certs = ctx->certs;\r\nctx->certs = NULL;\r\nctx->ppcerts = &ctx->certs;\r\nreturn 0;\r\n}\r\nint pkcs7_note_content(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\nif (ctx->last_oid != OID_data &&\r\nctx->last_oid != OID_msIndirectData) {\r\npr_warn("Unsupported data type %d\n", ctx->last_oid);\r\nreturn -EINVAL;\r\n}\r\nctx->msg->data_type = ctx->last_oid;\r\nreturn 0;\r\n}\r\nint pkcs7_note_data(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\npr_debug("Got data\n");\r\nctx->msg->data = value;\r\nctx->msg->data_len = vlen;\r\nctx->msg->data_hdrlen = hdrlen;\r\nreturn 0;\r\n}\r\nint pkcs7_sig_note_authenticated_attr(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\nstruct pkcs7_signed_info *sinfo = ctx->sinfo;\r\nenum OID content_type;\r\npr_devel("AuthAttr: %02x %zu [%*ph]\n", tag, vlen, (unsigned)vlen, value);\r\nswitch (ctx->last_oid) {\r\ncase OID_contentType:\r\nif (__test_and_set_bit(sinfo_has_content_type, &sinfo->aa_set))\r\ngoto repeated;\r\ncontent_type = look_up_OID(value, vlen);\r\nif (content_type != ctx->msg->data_type) {\r\npr_warn("Mismatch between global data type (%d) and sinfo %u (%d)\n",\r\nctx->msg->data_type, sinfo->index,\r\ncontent_type);\r\nreturn -EBADMSG;\r\n}\r\nreturn 0;\r\ncase OID_signingTime:\r\nif (__test_and_set_bit(sinfo_has_signing_time, &sinfo->aa_set))\r\ngoto repeated;\r\nreturn x509_decode_time(&sinfo->signing_time,\r\nhdrlen, tag, value, vlen);\r\ncase OID_messageDigest:\r\nif (__test_and_set_bit(sinfo_has_message_digest, &sinfo->aa_set))\r\ngoto repeated;\r\nif (tag != ASN1_OTS)\r\nreturn -EBADMSG;\r\nsinfo->msgdigest = value;\r\nsinfo->msgdigest_len = vlen;\r\nreturn 0;\r\ncase OID_smimeCapabilites:\r\nif (__test_and_set_bit(sinfo_has_smime_caps, &sinfo->aa_set))\r\ngoto repeated;\r\nif (ctx->msg->data_type != OID_msIndirectData) {\r\npr_warn("S/MIME Caps only allowed with Authenticode\n");\r\nreturn -EKEYREJECTED;\r\n}\r\nreturn 0;\r\ncase OID_msSpOpusInfo:\r\nif (__test_and_set_bit(sinfo_has_ms_opus_info, &sinfo->aa_set))\r\ngoto repeated;\r\ngoto authenticode_check;\r\ncase OID_msStatementType:\r\nif (__test_and_set_bit(sinfo_has_ms_statement_type, &sinfo->aa_set))\r\ngoto repeated;\r\nauthenticode_check:\r\nif (ctx->msg->data_type != OID_msIndirectData) {\r\npr_warn("Authenticode AuthAttrs only allowed with Authenticode\n");\r\nreturn -EKEYREJECTED;\r\n}\r\nreturn 0;\r\ndefault:\r\nreturn 0;\r\n}\r\nrepeated:\r\npr_warn("Repeated/multivalue AuthAttrs not permitted\n");\r\nreturn -EKEYREJECTED;\r\n}\r\nint pkcs7_sig_note_set_of_authattrs(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\nstruct pkcs7_signed_info *sinfo = ctx->sinfo;\r\nif (!test_bit(sinfo_has_content_type, &sinfo->aa_set) ||\r\n!test_bit(sinfo_has_message_digest, &sinfo->aa_set) ||\r\n(ctx->msg->data_type == OID_msIndirectData &&\r\n!test_bit(sinfo_has_ms_opus_info, &sinfo->aa_set))) {\r\npr_warn("Missing required AuthAttr\n");\r\nreturn -EBADMSG;\r\n}\r\nif (ctx->msg->data_type != OID_msIndirectData &&\r\ntest_bit(sinfo_has_ms_opus_info, &sinfo->aa_set)) {\r\npr_warn("Unexpected Authenticode AuthAttr\n");\r\nreturn -EBADMSG;\r\n}\r\nsinfo->authattrs = value - (hdrlen - 1);\r\nsinfo->authattrs_len = vlen + (hdrlen - 1);\r\nreturn 0;\r\n}\r\nint pkcs7_sig_note_serial(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\nctx->raw_serial = value;\r\nctx->raw_serial_size = vlen;\r\nreturn 0;\r\n}\r\nint pkcs7_sig_note_issuer(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\nctx->raw_issuer = value;\r\nctx->raw_issuer_size = vlen;\r\nreturn 0;\r\n}\r\nint pkcs7_sig_note_skid(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\npr_devel("SKID: %02x %zu [%*ph]\n", tag, vlen, (unsigned)vlen, value);\r\nctx->raw_skid = value;\r\nctx->raw_skid_size = vlen;\r\nreturn 0;\r\n}\r\nint pkcs7_sig_note_signature(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\nMPI mpi;\r\nBUG_ON(ctx->sinfo->sig.pkey_algo != PKEY_ALGO_RSA);\r\nmpi = mpi_read_raw_data(value, vlen);\r\nif (!mpi)\r\nreturn -ENOMEM;\r\nctx->sinfo->sig.mpi[0] = mpi;\r\nctx->sinfo->sig.nr_mpi = 1;\r\nreturn 0;\r\n}\r\nint pkcs7_note_signed_info(void *context, size_t hdrlen,\r\nunsigned char tag,\r\nconst void *value, size_t vlen)\r\n{\r\nstruct pkcs7_parse_context *ctx = context;\r\nstruct pkcs7_signed_info *sinfo = ctx->sinfo;\r\nstruct asymmetric_key_id *kid;\r\nif (ctx->msg->data_type == OID_msIndirectData && !sinfo->authattrs) {\r\npr_warn("Authenticode requires AuthAttrs\n");\r\nreturn -EBADMSG;\r\n}\r\nif (!ctx->expect_skid) {\r\nkid = asymmetric_key_generate_id(ctx->raw_serial,\r\nctx->raw_serial_size,\r\nctx->raw_issuer,\r\nctx->raw_issuer_size);\r\n} else {\r\nkid = asymmetric_key_generate_id(ctx->raw_skid,\r\nctx->raw_skid_size,\r\n"", 0);\r\n}\r\nif (IS_ERR(kid))\r\nreturn PTR_ERR(kid);\r\npr_devel("SINFO KID: %u [%*phN]\n", kid->len, kid->len, kid->data);\r\nsinfo->signing_cert_id = kid;\r\nsinfo->index = ++ctx->sinfo_index;\r\n*ctx->ppsinfo = sinfo;\r\nctx->ppsinfo = &sinfo->next;\r\nctx->sinfo = kzalloc(sizeof(struct pkcs7_signed_info), GFP_KERNEL);\r\nif (!ctx->sinfo)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}

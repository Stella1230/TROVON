static u32 radeon_audio_rreg(struct radeon_device *rdev, u32 offset, u32 reg)\r\n{\r\nreturn RREG32(reg);\r\n}\r\nstatic void radeon_audio_wreg(struct radeon_device *rdev, u32 offset,\r\nu32 reg, u32 v)\r\n{\r\nWREG32(reg, v);\r\n}\r\nstatic void radeon_audio_enable(struct radeon_device *rdev,\r\nstruct r600_audio_pin *pin, u8 enable_mask)\r\n{\r\nstruct drm_encoder *encoder;\r\nstruct radeon_encoder *radeon_encoder;\r\nstruct radeon_encoder_atom_dig *dig;\r\nint pin_count = 0;\r\nif (!pin)\r\nreturn;\r\nif (rdev->mode_info.mode_config_initialized) {\r\nlist_for_each_entry(encoder, &rdev->ddev->mode_config.encoder_list, head) {\r\nif (radeon_encoder_is_digital(encoder)) {\r\nradeon_encoder = to_radeon_encoder(encoder);\r\ndig = radeon_encoder->enc_priv;\r\nif (dig->pin == pin)\r\npin_count++;\r\n}\r\n}\r\nif ((pin_count > 1) && (enable_mask == 0))\r\nreturn;\r\n}\r\nif (rdev->audio.funcs->enable)\r\nrdev->audio.funcs->enable(rdev, pin, enable_mask);\r\n}\r\nstatic void radeon_audio_interface_init(struct radeon_device *rdev)\r\n{\r\nif (ASIC_IS_DCE6(rdev)) {\r\nrdev->audio.funcs = &dce6_funcs;\r\nrdev->audio.hdmi_funcs = &dce6_hdmi_funcs;\r\nrdev->audio.dp_funcs = &dce6_dp_funcs;\r\n} else if (ASIC_IS_DCE4(rdev)) {\r\nrdev->audio.funcs = &dce4_funcs;\r\nrdev->audio.hdmi_funcs = &dce4_hdmi_funcs;\r\nrdev->audio.dp_funcs = &dce4_dp_funcs;\r\n} else if (ASIC_IS_DCE32(rdev)) {\r\nrdev->audio.funcs = &dce32_funcs;\r\nrdev->audio.hdmi_funcs = &dce32_hdmi_funcs;\r\nrdev->audio.dp_funcs = &dce32_dp_funcs;\r\n} else {\r\nrdev->audio.funcs = &r600_funcs;\r\nrdev->audio.hdmi_funcs = &r600_hdmi_funcs;\r\nrdev->audio.dp_funcs = 0;\r\n}\r\n}\r\nstatic int radeon_audio_chipset_supported(struct radeon_device *rdev)\r\n{\r\nreturn ASIC_IS_DCE2(rdev) && !ASIC_IS_NODCE(rdev);\r\n}\r\nint radeon_audio_init(struct radeon_device *rdev)\r\n{\r\nint i;\r\nif (!radeon_audio || !radeon_audio_chipset_supported(rdev))\r\nreturn 0;\r\nrdev->audio.enabled = true;\r\nif (ASIC_IS_DCE83(rdev))\r\nrdev->audio.num_pins = 3;\r\nelse if (ASIC_IS_DCE81(rdev))\r\nrdev->audio.num_pins = 7;\r\nelse if (ASIC_IS_DCE8(rdev))\r\nrdev->audio.num_pins = 7;\r\nelse if (ASIC_IS_DCE64(rdev))\r\nrdev->audio.num_pins = 2;\r\nelse if (ASIC_IS_DCE61(rdev))\r\nrdev->audio.num_pins = 6;\r\nelse if (ASIC_IS_DCE6(rdev))\r\nrdev->audio.num_pins = 6;\r\nelse\r\nrdev->audio.num_pins = 1;\r\nfor (i = 0; i < rdev->audio.num_pins; i++) {\r\nrdev->audio.pin[i].channels = -1;\r\nrdev->audio.pin[i].rate = -1;\r\nrdev->audio.pin[i].bits_per_sample = -1;\r\nrdev->audio.pin[i].status_bits = 0;\r\nrdev->audio.pin[i].category_code = 0;\r\nrdev->audio.pin[i].connected = false;\r\nrdev->audio.pin[i].offset = pin_offsets[i];\r\nrdev->audio.pin[i].id = i;\r\n}\r\nradeon_audio_interface_init(rdev);\r\nfor (i = 0; i < rdev->audio.num_pins; i++)\r\nradeon_audio_enable(rdev, &rdev->audio.pin[i], 0);\r\nreturn 0;\r\n}\r\nu32 radeon_audio_endpoint_rreg(struct radeon_device *rdev, u32 offset, u32 reg)\r\n{\r\nif (rdev->audio.funcs->endpoint_rreg)\r\nreturn rdev->audio.funcs->endpoint_rreg(rdev, offset, reg);\r\nreturn 0;\r\n}\r\nvoid radeon_audio_endpoint_wreg(struct radeon_device *rdev, u32 offset,\r\nu32 reg, u32 v)\r\n{\r\nif (rdev->audio.funcs->endpoint_wreg)\r\nrdev->audio.funcs->endpoint_wreg(rdev, offset, reg, v);\r\n}\r\nstatic void radeon_audio_write_sad_regs(struct drm_encoder *encoder)\r\n{\r\nstruct drm_connector *connector = radeon_get_connector_for_encoder(encoder);\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct cea_sad *sads;\r\nint sad_count;\r\nif (!connector)\r\nreturn;\r\nsad_count = drm_edid_to_sad(radeon_connector_edid(connector), &sads);\r\nif (sad_count <= 0) {\r\nDRM_ERROR("Couldn't read SADs: %d\n", sad_count);\r\nreturn;\r\n}\r\nBUG_ON(!sads);\r\nif (radeon_encoder->audio && radeon_encoder->audio->write_sad_regs)\r\nradeon_encoder->audio->write_sad_regs(encoder, sads, sad_count);\r\nkfree(sads);\r\n}\r\nstatic void radeon_audio_write_speaker_allocation(struct drm_encoder *encoder)\r\n{\r\nstruct drm_connector *connector = radeon_get_connector_for_encoder(encoder);\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nu8 *sadb = NULL;\r\nint sad_count;\r\nif (!connector)\r\nreturn;\r\nsad_count = drm_edid_to_speaker_allocation(radeon_connector_edid(connector),\r\n&sadb);\r\nif (sad_count < 0) {\r\nDRM_DEBUG("Couldn't read Speaker Allocation Data Block: %d\n",\r\nsad_count);\r\nsad_count = 0;\r\n}\r\nif (radeon_encoder->audio && radeon_encoder->audio->write_speaker_allocation)\r\nradeon_encoder->audio->write_speaker_allocation(encoder, sadb, sad_count);\r\nkfree(sadb);\r\n}\r\nstatic void radeon_audio_write_latency_fields(struct drm_encoder *encoder,\r\nstruct drm_display_mode *mode)\r\n{\r\nstruct drm_connector *connector = radeon_get_connector_for_encoder(encoder);\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nif (!connector)\r\nreturn;\r\nif (radeon_encoder->audio && radeon_encoder->audio->write_latency_fields)\r\nradeon_encoder->audio->write_latency_fields(encoder, connector, mode);\r\n}\r\nstruct r600_audio_pin* radeon_audio_get_pin(struct drm_encoder *encoder)\r\n{\r\nstruct radeon_device *rdev = encoder->dev->dev_private;\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nif (radeon_encoder->audio && radeon_encoder->audio->get_pin)\r\nreturn radeon_encoder->audio->get_pin(rdev);\r\nreturn NULL;\r\n}\r\nstatic void radeon_audio_select_pin(struct drm_encoder *encoder)\r\n{\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nif (radeon_encoder->audio && radeon_encoder->audio->select_pin)\r\nradeon_encoder->audio->select_pin(encoder);\r\n}\r\nvoid radeon_audio_detect(struct drm_connector *connector,\r\nstruct drm_encoder *encoder,\r\nenum drm_connector_status status)\r\n{\r\nstruct drm_device *dev = connector->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct radeon_encoder_atom_dig *dig;\r\nif (!radeon_audio_chipset_supported(rdev))\r\nreturn;\r\nif (!radeon_encoder_is_digital(encoder))\r\nreturn;\r\ndig = radeon_encoder->enc_priv;\r\nif (status == connector_status_connected) {\r\nif (connector->connector_type == DRM_MODE_CONNECTOR_DisplayPort) {\r\nstruct radeon_connector *radeon_connector = to_radeon_connector(connector);\r\nif (radeon_dp_getsinktype(radeon_connector) ==\r\nCONNECTOR_OBJECT_ID_DISPLAYPORT)\r\nradeon_encoder->audio = rdev->audio.dp_funcs;\r\nelse\r\nradeon_encoder->audio = rdev->audio.hdmi_funcs;\r\n} else {\r\nradeon_encoder->audio = rdev->audio.hdmi_funcs;\r\n}\r\nif (drm_detect_monitor_audio(radeon_connector_edid(connector))) {\r\nif (!dig->pin)\r\ndig->pin = radeon_audio_get_pin(encoder);\r\nradeon_audio_enable(rdev, dig->pin, 0xf);\r\n} else {\r\nradeon_audio_enable(rdev, dig->pin, 0);\r\ndig->pin = NULL;\r\n}\r\n} else {\r\nradeon_audio_enable(rdev, dig->pin, 0);\r\ndig->pin = NULL;\r\n}\r\n}\r\nvoid radeon_audio_fini(struct radeon_device *rdev)\r\n{\r\nint i;\r\nif (!rdev->audio.enabled)\r\nreturn;\r\nfor (i = 0; i < rdev->audio.num_pins; i++)\r\nradeon_audio_enable(rdev, &rdev->audio.pin[i], 0);\r\nrdev->audio.enabled = false;\r\n}\r\nstatic void radeon_audio_set_dto(struct drm_encoder *encoder, unsigned int clock)\r\n{\r\nstruct radeon_device *rdev = encoder->dev->dev_private;\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct radeon_crtc *crtc = to_radeon_crtc(encoder->crtc);\r\nif (radeon_encoder->audio && radeon_encoder->audio->set_dto)\r\nradeon_encoder->audio->set_dto(rdev, crtc, clock);\r\n}\r\nstatic int radeon_audio_set_avi_packet(struct drm_encoder *encoder,\r\nstruct drm_display_mode *mode)\r\n{\r\nstruct radeon_device *rdev = encoder->dev->dev_private;\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct radeon_encoder_atom_dig *dig = radeon_encoder->enc_priv;\r\nstruct drm_connector *connector = radeon_get_connector_for_encoder(encoder);\r\nu8 buffer[HDMI_INFOFRAME_HEADER_SIZE + HDMI_AVI_INFOFRAME_SIZE];\r\nstruct hdmi_avi_infoframe frame;\r\nint err;\r\nif (!connector)\r\nreturn -EINVAL;\r\nerr = drm_hdmi_avi_infoframe_from_display_mode(&frame, mode);\r\nif (err < 0) {\r\nDRM_ERROR("failed to setup AVI infoframe: %d\n", err);\r\nreturn err;\r\n}\r\nif (radeon_encoder->output_csc != RADEON_OUTPUT_CSC_BYPASS) {\r\nif (drm_rgb_quant_range_selectable(radeon_connector_edid(connector))) {\r\nif (radeon_encoder->output_csc == RADEON_OUTPUT_CSC_TVRGB)\r\nframe.quantization_range = HDMI_QUANTIZATION_RANGE_LIMITED;\r\nelse\r\nframe.quantization_range = HDMI_QUANTIZATION_RANGE_FULL;\r\n} else {\r\nframe.quantization_range = HDMI_QUANTIZATION_RANGE_DEFAULT;\r\n}\r\n}\r\nerr = hdmi_avi_infoframe_pack(&frame, buffer, sizeof(buffer));\r\nif (err < 0) {\r\nDRM_ERROR("failed to pack AVI infoframe: %d\n", err);\r\nreturn err;\r\n}\r\nif (dig && dig->afmt && radeon_encoder->audio &&\r\nradeon_encoder->audio->set_avi_packet)\r\nradeon_encoder->audio->set_avi_packet(rdev, dig->afmt->offset,\r\nbuffer, sizeof(buffer));\r\nreturn 0;\r\n}\r\nstatic void radeon_audio_calc_cts(unsigned int clock, int *CTS, int *N, int freq)\r\n{\r\nint n, cts;\r\nunsigned long div, mul;\r\nn = 128 * freq;\r\ncts = clock * 1000;\r\ndiv = gcd(n, cts);\r\nn /= div;\r\ncts /= div;\r\nmul = ((128*freq/1000) + (n-1))/n;\r\nn *= mul;\r\ncts *= mul;\r\nif (n < (128*freq/1500))\r\nprintk(KERN_WARNING "Calculated ACR N value is too small. You may experience audio problems.\n");\r\nif (n > (128*freq/300))\r\nprintk(KERN_WARNING "Calculated ACR N value is too large. You may experience audio problems.\n");\r\n*N = n;\r\n*CTS = cts;\r\nDRM_DEBUG("Calculated ACR timing N=%d CTS=%d for frequency %d\n",\r\n*N, *CTS, freq);\r\n}\r\nstatic const struct radeon_hdmi_acr* radeon_audio_acr(unsigned int clock)\r\n{\r\nstatic struct radeon_hdmi_acr res;\r\nu8 i;\r\nstatic const struct radeon_hdmi_acr hdmi_predefined_acr[] = {\r\n{ 25175, 4096, 25175, 28224, 125875, 6144, 25175 },\r\n{ 25200, 4096, 25200, 6272, 28000, 6144, 25200 },\r\n{ 27000, 4096, 27000, 6272, 30000, 6144, 27000 },\r\n{ 27027, 4096, 27027, 6272, 30030, 6144, 27027 },\r\n{ 54000, 4096, 54000, 6272, 60000, 6144, 54000 },\r\n{ 54054, 4096, 54054, 6272, 60060, 6144, 54054 },\r\n{ 74176, 4096, 74176, 5733, 75335, 6144, 74176 },\r\n{ 74250, 4096, 74250, 6272, 82500, 6144, 74250 },\r\n{ 148352, 4096, 148352, 5733, 150670, 6144, 148352 },\r\n{ 148500, 4096, 148500, 6272, 165000, 6144, 148500 },\r\n};\r\nfor (i = 0; i < ARRAY_SIZE(hdmi_predefined_acr); i++)\r\nif (hdmi_predefined_acr[i].clock == clock)\r\nreturn &hdmi_predefined_acr[i];\r\nradeon_audio_calc_cts(clock, &res.cts_32khz, &res.n_32khz, 32000);\r\nradeon_audio_calc_cts(clock, &res.cts_44_1khz, &res.n_44_1khz, 44100);\r\nradeon_audio_calc_cts(clock, &res.cts_48khz, &res.n_48khz, 48000);\r\nreturn &res;\r\n}\r\nstatic void radeon_audio_update_acr(struct drm_encoder *encoder, unsigned int clock)\r\n{\r\nconst struct radeon_hdmi_acr *acr = radeon_audio_acr(clock);\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct radeon_encoder_atom_dig *dig = radeon_encoder->enc_priv;\r\nif (!dig || !dig->afmt)\r\nreturn;\r\nif (radeon_encoder->audio && radeon_encoder->audio->update_acr)\r\nradeon_encoder->audio->update_acr(encoder, dig->afmt->offset, acr);\r\n}\r\nstatic void radeon_audio_set_vbi_packet(struct drm_encoder *encoder)\r\n{\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct radeon_encoder_atom_dig *dig = radeon_encoder->enc_priv;\r\nif (!dig || !dig->afmt)\r\nreturn;\r\nif (radeon_encoder->audio && radeon_encoder->audio->set_vbi_packet)\r\nradeon_encoder->audio->set_vbi_packet(encoder, dig->afmt->offset);\r\n}\r\nstatic void radeon_hdmi_set_color_depth(struct drm_encoder *encoder)\r\n{\r\nint bpc = 8;\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct radeon_encoder_atom_dig *dig = radeon_encoder->enc_priv;\r\nif (!dig || !dig->afmt)\r\nreturn;\r\nif (encoder->crtc) {\r\nstruct radeon_crtc *radeon_crtc = to_radeon_crtc(encoder->crtc);\r\nbpc = radeon_crtc->bpc;\r\n}\r\nif (radeon_encoder->audio && radeon_encoder->audio->set_color_depth)\r\nradeon_encoder->audio->set_color_depth(encoder, dig->afmt->offset, bpc);\r\n}\r\nstatic void radeon_audio_set_audio_packet(struct drm_encoder *encoder)\r\n{\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct radeon_encoder_atom_dig *dig = radeon_encoder->enc_priv;\r\nif (!dig || !dig->afmt)\r\nreturn;\r\nif (radeon_encoder->audio && radeon_encoder->audio->set_audio_packet)\r\nradeon_encoder->audio->set_audio_packet(encoder, dig->afmt->offset);\r\n}\r\nstatic void radeon_audio_set_mute(struct drm_encoder *encoder, bool mute)\r\n{\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct radeon_encoder_atom_dig *dig = radeon_encoder->enc_priv;\r\nif (!dig || !dig->afmt)\r\nreturn;\r\nif (radeon_encoder->audio && radeon_encoder->audio->set_mute)\r\nradeon_encoder->audio->set_mute(encoder, dig->afmt->offset, mute);\r\n}\r\nstatic void radeon_audio_hdmi_mode_set(struct drm_encoder *encoder,\r\nstruct drm_display_mode *mode)\r\n{\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct radeon_encoder_atom_dig *dig = radeon_encoder->enc_priv;\r\nstruct drm_connector *connector = radeon_get_connector_for_encoder(encoder);\r\nif (!dig || !dig->afmt)\r\nreturn;\r\nif (!connector)\r\nreturn;\r\nif (drm_detect_monitor_audio(radeon_connector_edid(connector))) {\r\nradeon_audio_set_mute(encoder, true);\r\nradeon_audio_write_speaker_allocation(encoder);\r\nradeon_audio_write_sad_regs(encoder);\r\nradeon_audio_write_latency_fields(encoder, mode);\r\nradeon_audio_set_dto(encoder, mode->clock);\r\nradeon_audio_set_vbi_packet(encoder);\r\nradeon_hdmi_set_color_depth(encoder);\r\nradeon_audio_update_acr(encoder, mode->clock);\r\nradeon_audio_set_audio_packet(encoder);\r\nradeon_audio_select_pin(encoder);\r\nif (radeon_audio_set_avi_packet(encoder, mode) < 0)\r\nreturn;\r\nradeon_audio_set_mute(encoder, false);\r\n} else {\r\nradeon_hdmi_set_color_depth(encoder);\r\nif (radeon_audio_set_avi_packet(encoder, mode) < 0)\r\nreturn;\r\n}\r\n}\r\nstatic void radeon_audio_dp_mode_set(struct drm_encoder *encoder,\r\nstruct drm_display_mode *mode)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct radeon_encoder_atom_dig *dig = radeon_encoder->enc_priv;\r\nstruct drm_connector *connector = radeon_get_connector_for_encoder(encoder);\r\nstruct radeon_connector *radeon_connector = to_radeon_connector(connector);\r\nstruct radeon_connector_atom_dig *dig_connector =\r\nradeon_connector->con_priv;\r\nif (!dig || !dig->afmt)\r\nreturn;\r\nif (!connector)\r\nreturn;\r\nif (drm_detect_monitor_audio(radeon_connector_edid(connector))) {\r\nradeon_audio_write_speaker_allocation(encoder);\r\nradeon_audio_write_sad_regs(encoder);\r\nradeon_audio_write_latency_fields(encoder, mode);\r\nif (rdev->clock.dp_extclk || ASIC_IS_DCE5(rdev))\r\nradeon_audio_set_dto(encoder, rdev->clock.default_dispclk * 10);\r\nelse\r\nradeon_audio_set_dto(encoder, dig_connector->dp_clock);\r\nradeon_audio_set_audio_packet(encoder);\r\nradeon_audio_select_pin(encoder);\r\nif (radeon_audio_set_avi_packet(encoder, mode) < 0)\r\nreturn;\r\n}\r\n}\r\nvoid radeon_audio_mode_set(struct drm_encoder *encoder,\r\nstruct drm_display_mode *mode)\r\n{\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nif (radeon_encoder->audio && radeon_encoder->audio->mode_set)\r\nradeon_encoder->audio->mode_set(encoder, mode);\r\n}\r\nvoid radeon_audio_dpms(struct drm_encoder *encoder, int mode)\r\n{\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nif (radeon_encoder->audio && radeon_encoder->audio->dpms)\r\nradeon_encoder->audio->dpms(encoder, mode == DRM_MODE_DPMS_ON);\r\n}

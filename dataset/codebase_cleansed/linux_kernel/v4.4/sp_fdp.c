static inline union ieee754sp ieee754sp_nan_fdp(int xs, u64 xm)\r\n{\r\nreturn buildsp(xs, SP_EMAX + 1 + SP_EBIAS,\r\nxm >> (DP_FBITS - SP_FBITS));\r\n}\r\nunion ieee754sp ieee754sp_fdp(union ieee754dp x)\r\n{\r\nunion ieee754sp y;\r\nu32 rm;\r\nCOMPXDP;\r\nCOMPYSP;\r\nEXPLODEXDP;\r\nieee754_clearcx();\r\nFLUSHXDP;\r\nswitch (xc) {\r\ncase IEEE754_CLASS_SNAN:\r\nreturn ieee754sp_nanxcpt(ieee754sp_nan_fdp(xs, xm));\r\ncase IEEE754_CLASS_QNAN:\r\ny = ieee754sp_nan_fdp(xs, xm);\r\nEXPLODEYSP;\r\nif (!ieee754_class_nan(yc))\r\ny = ieee754sp_indef();\r\nreturn y;\r\ncase IEEE754_CLASS_INF:\r\nreturn ieee754sp_inf(xs);\r\ncase IEEE754_CLASS_ZERO:\r\nreturn ieee754sp_zero(xs);\r\ncase IEEE754_CLASS_DNORM:\r\nieee754_setcx(IEEE754_UNDERFLOW);\r\nieee754_setcx(IEEE754_INEXACT);\r\nif ((ieee754_csr.rm == FPU_CSR_RU && !xs) ||\r\n(ieee754_csr.rm == FPU_CSR_RD && xs))\r\nreturn ieee754sp_mind(xs);\r\nreturn ieee754sp_zero(xs);\r\ncase IEEE754_CLASS_NORM:\r\nbreak;\r\n}\r\nrm = (xm >> (DP_FBITS - (SP_FBITS + 3))) |\r\n((xm << (64 - (DP_FBITS - (SP_FBITS + 3)))) != 0);\r\nreturn ieee754sp_format(xs, xe, rm);\r\n}

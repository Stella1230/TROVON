static inline u32 read_pmtmr(void)\r\n{\r\nreturn inl(pmtmr_ioport) & ACPI_PM_MASK;\r\n}\r\nu32 acpi_pm_read_verified(void)\r\n{\r\nu32 v1 = 0, v2 = 0, v3 = 0;\r\ndo {\r\nv1 = read_pmtmr();\r\nv2 = read_pmtmr();\r\nv3 = read_pmtmr();\r\n} while (unlikely((v1 > v2 && v1 < v3) || (v2 > v3 && v2 < v1)\r\n|| (v3 > v1 && v3 < v2)));\r\nreturn v2;\r\n}\r\nstatic cycle_t acpi_pm_read(struct clocksource *cs)\r\n{\r\nreturn (cycle_t)read_pmtmr();\r\n}\r\nstatic int __init acpi_pm_good_setup(char *__str)\r\n{\r\nacpi_pm_good = 1;\r\nreturn 1;\r\n}\r\nstatic cycle_t acpi_pm_read_slow(struct clocksource *cs)\r\n{\r\nreturn (cycle_t)acpi_pm_read_verified();\r\n}\r\nstatic inline void acpi_pm_need_workaround(void)\r\n{\r\nclocksource_acpi_pm.read = acpi_pm_read_slow;\r\nclocksource_acpi_pm.rating = 120;\r\n}\r\nstatic void acpi_pm_check_blacklist(struct pci_dev *dev)\r\n{\r\nif (acpi_pm_good)\r\nreturn;\r\nif (dev->revision < 3) {\r\nprintk(KERN_WARNING "* Found PM-Timer Bug on the chipset."\r\n" Due to workarounds for a bug,\n"\r\n"* this clock source is slow. Consider trying"\r\n" other clock sources\n");\r\nacpi_pm_need_workaround();\r\n}\r\n}\r\nstatic void acpi_pm_check_graylist(struct pci_dev *dev)\r\n{\r\nif (acpi_pm_good)\r\nreturn;\r\nprintk(KERN_WARNING "* The chipset may have PM-Timer Bug. Due to"\r\n" workarounds for a bug,\n"\r\n"* this clock source is slow. If you are sure your timer"\r\n" does not have\n"\r\n"* this bug, please use \"acpi_pm_good\" to disable the"\r\n" workaround\n");\r\nacpi_pm_need_workaround();\r\n}\r\nstatic int verify_pmtmr_rate(void)\r\n{\r\ncycle_t value1, value2;\r\nunsigned long count, delta;\r\nmach_prepare_counter();\r\nvalue1 = clocksource_acpi_pm.read(&clocksource_acpi_pm);\r\nmach_countup(&count);\r\nvalue2 = clocksource_acpi_pm.read(&clocksource_acpi_pm);\r\ndelta = (value2 - value1) & ACPI_PM_MASK;\r\nif (delta < (PMTMR_EXPECTED_RATE * 19) / 20 ||\r\ndelta > (PMTMR_EXPECTED_RATE * 21) / 20) {\r\nprintk(KERN_INFO "PM-Timer running at invalid rate: %lu%% "\r\n"of normal - aborting.\n",\r\n100UL * delta / PMTMR_EXPECTED_RATE);\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init init_acpi_pm_clocksource(void)\r\n{\r\ncycle_t value1, value2;\r\nunsigned int i, j = 0;\r\nif (!pmtmr_ioport)\r\nreturn -ENODEV;\r\nfor (j = 0; j < ACPI_PM_MONOTONICITY_CHECKS; j++) {\r\nudelay(100 * j);\r\nvalue1 = clocksource_acpi_pm.read(&clocksource_acpi_pm);\r\nfor (i = 0; i < ACPI_PM_READ_CHECKS; i++) {\r\nvalue2 = clocksource_acpi_pm.read(&clocksource_acpi_pm);\r\nif (value2 == value1)\r\ncontinue;\r\nif (value2 > value1)\r\nbreak;\r\nif ((value2 < value1) && ((value2) < 0xFFF))\r\nbreak;\r\nprintk(KERN_INFO "PM-Timer had inconsistent results:"\r\n" %#llx, %#llx - aborting.\n",\r\nvalue1, value2);\r\npmtmr_ioport = 0;\r\nreturn -EINVAL;\r\n}\r\nif (i == ACPI_PM_READ_CHECKS) {\r\nprintk(KERN_INFO "PM-Timer failed consistency check "\r\n" (%#llx) - aborting.\n", value1);\r\npmtmr_ioport = 0;\r\nreturn -ENODEV;\r\n}\r\n}\r\nif (verify_pmtmr_rate() != 0){\r\npmtmr_ioport = 0;\r\nreturn -ENODEV;\r\n}\r\nreturn clocksource_register_hz(&clocksource_acpi_pm,\r\nPMTMR_TICKS_PER_SEC);\r\n}\r\nstatic int __init parse_pmtmr(char *arg)\r\n{\r\nunsigned int base;\r\nint ret;\r\nret = kstrtouint(arg, 16, &base);\r\nif (ret)\r\nreturn ret;\r\npr_info("PMTMR IOPort override: 0x%04x -> 0x%04x\n", pmtmr_ioport,\r\nbase);\r\npmtmr_ioport = base;\r\nreturn 1;\r\n}

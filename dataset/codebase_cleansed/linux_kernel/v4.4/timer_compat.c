static int snd_timer_user_info_compat(struct file *file,\r\nstruct snd_timer_info32 __user *_info)\r\n{\r\nstruct snd_timer_user *tu;\r\nstruct snd_timer_info32 info;\r\nstruct snd_timer *t;\r\ntu = file->private_data;\r\nif (snd_BUG_ON(!tu->timeri))\r\nreturn -ENXIO;\r\nt = tu->timeri->timer;\r\nif (snd_BUG_ON(!t))\r\nreturn -ENXIO;\r\nmemset(&info, 0, sizeof(info));\r\ninfo.card = t->card ? t->card->number : -1;\r\nif (t->hw.flags & SNDRV_TIMER_HW_SLAVE)\r\ninfo.flags |= SNDRV_TIMER_FLG_SLAVE;\r\nstrlcpy(info.id, t->id, sizeof(info.id));\r\nstrlcpy(info.name, t->name, sizeof(info.name));\r\ninfo.resolution = t->hw.resolution;\r\nif (copy_to_user(_info, &info, sizeof(*_info)))\r\nreturn -EFAULT;\r\nreturn 0;\r\n}\r\nstatic int snd_timer_user_status_compat(struct file *file,\r\nstruct snd_timer_status32 __user *_status)\r\n{\r\nstruct snd_timer_user *tu;\r\nstruct snd_timer_status status;\r\ntu = file->private_data;\r\nif (snd_BUG_ON(!tu->timeri))\r\nreturn -ENXIO;\r\nmemset(&status, 0, sizeof(status));\r\nstatus.tstamp = tu->tstamp;\r\nstatus.resolution = snd_timer_resolution(tu->timeri);\r\nstatus.lost = tu->timeri->lost;\r\nstatus.overrun = tu->overrun;\r\nspin_lock_irq(&tu->qlock);\r\nstatus.queue = tu->qused;\r\nspin_unlock_irq(&tu->qlock);\r\nif (copy_to_user(_status, &status, sizeof(status)))\r\nreturn -EFAULT;\r\nreturn 0;\r\n}\r\nstatic long snd_timer_user_ioctl_compat(struct file *file, unsigned int cmd, unsigned long arg)\r\n{\r\nvoid __user *argp = compat_ptr(arg);\r\nswitch (cmd) {\r\ncase SNDRV_TIMER_IOCTL_PVERSION:\r\ncase SNDRV_TIMER_IOCTL_TREAD:\r\ncase SNDRV_TIMER_IOCTL_GINFO:\r\ncase SNDRV_TIMER_IOCTL_GPARAMS:\r\ncase SNDRV_TIMER_IOCTL_GSTATUS:\r\ncase SNDRV_TIMER_IOCTL_SELECT:\r\ncase SNDRV_TIMER_IOCTL_PARAMS:\r\ncase SNDRV_TIMER_IOCTL_START:\r\ncase SNDRV_TIMER_IOCTL_START_OLD:\r\ncase SNDRV_TIMER_IOCTL_STOP:\r\ncase SNDRV_TIMER_IOCTL_STOP_OLD:\r\ncase SNDRV_TIMER_IOCTL_CONTINUE:\r\ncase SNDRV_TIMER_IOCTL_CONTINUE_OLD:\r\ncase SNDRV_TIMER_IOCTL_PAUSE:\r\ncase SNDRV_TIMER_IOCTL_PAUSE_OLD:\r\ncase SNDRV_TIMER_IOCTL_NEXT_DEVICE:\r\nreturn snd_timer_user_ioctl(file, cmd, (unsigned long)argp);\r\ncase SNDRV_TIMER_IOCTL_INFO32:\r\nreturn snd_timer_user_info_compat(file, argp);\r\ncase SNDRV_TIMER_IOCTL_STATUS32:\r\nreturn snd_timer_user_status_compat(file, argp);\r\n}\r\nreturn -ENOIOCTLCMD;\r\n}

static const struct softing_platform_data\r\n*softingcs_find_platform_data(unsigned int manf, unsigned int prod)\r\n{\r\nconst struct softing_platform_data *lp;\r\nfor (lp = softingcs_platform_data; lp->manf; ++lp) {\r\nif ((lp->manf == manf) && (lp->prod == prod))\r\nreturn lp;\r\n}\r\nreturn NULL;\r\n}\r\nstatic int softingcs_reset(struct platform_device *pdev, int v)\r\n{\r\nstruct pcmcia_device *pcmcia = to_pcmcia_dev(pdev->dev.parent);\r\ndev_dbg(&pdev->dev, "pcmcia config [2] %02x\n", v ? 0 : 0x20);\r\nreturn pcmcia_write_config_byte(pcmcia, 2, v ? 0 : 0x20);\r\n}\r\nstatic int softingcs_enable_irq(struct platform_device *pdev, int v)\r\n{\r\nstruct pcmcia_device *pcmcia = to_pcmcia_dev(pdev->dev.parent);\r\ndev_dbg(&pdev->dev, "pcmcia config [0] %02x\n", v ? 0x60 : 0);\r\nreturn pcmcia_write_config_byte(pcmcia, 0, v ? 0x60 : 0);\r\n}\r\nstatic int softingcs_probe_config(struct pcmcia_device *pcmcia, void *priv_data)\r\n{\r\nstruct softing_platform_data *pdat = priv_data;\r\nstruct resource *pres;\r\nint memspeed = 0;\r\nWARN_ON(!pdat);\r\npres = pcmcia->resource[PCMCIA_IOMEM_0];\r\nif (resource_size(pres) < 0x1000)\r\nreturn -ERANGE;\r\npres->flags |= WIN_MEMORY_TYPE_CM | WIN_ENABLE;\r\nif (pdat->generation < 2) {\r\npres->flags |= WIN_USE_WAIT | WIN_DATA_WIDTH_8;\r\nmemspeed = 3;\r\n} else {\r\npres->flags |= WIN_DATA_WIDTH_16;\r\n}\r\nreturn pcmcia_request_window(pcmcia, pres, memspeed);\r\n}\r\nstatic void softingcs_remove(struct pcmcia_device *pcmcia)\r\n{\r\nstruct platform_device *pdev = pcmcia->priv;\r\nplatform_device_unregister(pdev);\r\npcmcia_disable_device(pcmcia);\r\n}\r\nstatic void softingcs_pdev_release(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nkfree(pdev);\r\n}\r\nstatic int softingcs_probe(struct pcmcia_device *pcmcia)\r\n{\r\nint ret;\r\nstruct platform_device *pdev;\r\nconst struct softing_platform_data *pdat;\r\nstruct resource *pres;\r\nstruct dev {\r\nstruct platform_device pdev;\r\nstruct resource res[2];\r\n} *dev;\r\npdat = softingcs_find_platform_data(pcmcia->manf_id, pcmcia->card_id);\r\nif (!pdat)\r\nreturn -ENOTTY;\r\npcmcia->config_flags |= CONF_ENABLE_IRQ | CONF_AUTO_SET_IOMEM |\r\nCONF_AUTO_SET_VPP | CONF_AUTO_CHECK_VCC;\r\nret = pcmcia_loop_config(pcmcia, softingcs_probe_config, (void *)pdat);\r\nif (ret)\r\ngoto pcmcia_failed;\r\nret = pcmcia_enable_device(pcmcia);\r\nif (ret < 0)\r\ngoto pcmcia_failed;\r\npres = pcmcia->resource[PCMCIA_IOMEM_0];\r\nif (!pres) {\r\nret = -EBADF;\r\ngoto pcmcia_bad;\r\n}\r\ndev = kzalloc(sizeof(*dev), GFP_KERNEL);\r\nif (!dev) {\r\nret = -ENOMEM;\r\ngoto mem_failed;\r\n}\r\ndev->pdev.resource = dev->res;\r\ndev->pdev.num_resources = ARRAY_SIZE(dev->res);\r\ndev->pdev.dev.release = softingcs_pdev_release;\r\npdev = &dev->pdev;\r\npdev->dev.platform_data = (void *)pdat;\r\npdev->dev.parent = &pcmcia->dev;\r\npcmcia->priv = pdev;\r\npdev->resource[0].flags = IORESOURCE_MEM;\r\npdev->resource[0].start = pres->start;\r\npdev->resource[0].end = pres->end;\r\npdev->resource[1].flags = IORESOURCE_IRQ;\r\npdev->resource[1].start = pcmcia->irq;\r\npdev->resource[1].end = pdev->resource[1].start;\r\nspin_lock(&softingcs_index_lock);\r\npdev->id = softingcs_index++;\r\nspin_unlock(&softingcs_index_lock);\r\npdev->name = "softing";\r\ndev_set_name(&pdev->dev, "softingcs.%i", pdev->id);\r\nret = platform_device_register(pdev);\r\nif (ret < 0)\r\ngoto platform_failed;\r\ndev_info(&pcmcia->dev, "created %s\n", dev_name(&pdev->dev));\r\nreturn 0;\r\nplatform_failed:\r\nkfree(dev);\r\nmem_failed:\r\npcmcia_bad:\r\npcmcia_failed:\r\npcmcia_disable_device(pcmcia);\r\npcmcia->priv = NULL;\r\nreturn ret ?: -ENODEV;\r\n}

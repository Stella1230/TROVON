static unsigned long clk_pll_recalc_rate(struct clk_hw *hwclk,\r\nunsigned long parent_rate)\r\n{\r\nstruct socfpga_pll *socfpgaclk = to_socfpga_clk(hwclk);\r\nunsigned long divf, divq, reg;\r\nunsigned long long vco_freq;\r\nreg = readl(socfpgaclk->hw.reg + 0x4);\r\ndivf = (reg & SOCFPGA_PLL_DIVF_MASK) >> SOCFPGA_PLL_DIVF_SHIFT;\r\ndivq = (reg & SOCFPGA_PLL_DIVQ_MASK) >> SOCFPGA_PLL_DIVQ_SHIFT;\r\nvco_freq = (unsigned long long)parent_rate * (divf + 1);\r\ndo_div(vco_freq, (1 + divq));\r\nreturn (unsigned long)vco_freq;\r\n}\r\nstatic u8 clk_pll_get_parent(struct clk_hw *hwclk)\r\n{\r\nstruct socfpga_pll *socfpgaclk = to_socfpga_clk(hwclk);\r\nu32 pll_src;\r\npll_src = readl(socfpgaclk->hw.reg);\r\nreturn (pll_src >> CLK_MGR_PLL_CLK_SRC_SHIFT) &\r\nCLK_MGR_PLL_CLK_SRC_MASK;\r\n}\r\nstatic struct __init clk * __socfpga_pll_init(struct device_node *node,\r\nconst struct clk_ops *ops)\r\n{\r\nu32 reg;\r\nstruct clk *clk;\r\nstruct socfpga_pll *pll_clk;\r\nconst char *clk_name = node->name;\r\nconst char *parent_name[SOCFGPA_MAX_PARENTS];\r\nstruct clk_init_data init;\r\nstruct device_node *clkmgr_np;\r\nint rc;\r\nint i = 0;\r\nof_property_read_u32(node, "reg", &reg);\r\npll_clk = kzalloc(sizeof(*pll_clk), GFP_KERNEL);\r\nif (WARN_ON(!pll_clk))\r\nreturn NULL;\r\nclkmgr_np = of_find_compatible_node(NULL, NULL, "altr,clk-mgr");\r\nclk_mgr_a10_base_addr = of_iomap(clkmgr_np, 0);\r\nBUG_ON(!clk_mgr_a10_base_addr);\r\npll_clk->hw.reg = clk_mgr_a10_base_addr + reg;\r\nof_property_read_string(node, "clock-output-names", &clk_name);\r\ninit.name = clk_name;\r\ninit.ops = ops;\r\ninit.flags = 0;\r\nwhile (i < SOCFGPA_MAX_PARENTS && (parent_name[i] =\r\nof_clk_get_parent_name(node, i)) != NULL)\r\ni++;\r\ninit.num_parents = i;\r\ninit.parent_names = parent_name;\r\npll_clk->hw.hw.init = &init;\r\npll_clk->hw.bit_idx = SOCFPGA_PLL_EXT_ENA;\r\nclk_pll_ops.enable = clk_gate_ops.enable;\r\nclk_pll_ops.disable = clk_gate_ops.disable;\r\nclk = clk_register(NULL, &pll_clk->hw.hw);\r\nif (WARN_ON(IS_ERR(clk))) {\r\nkfree(pll_clk);\r\nreturn NULL;\r\n}\r\nrc = of_clk_add_provider(node, of_clk_src_simple_get, clk);\r\nreturn clk;\r\n}\r\nvoid __init socfpga_a10_pll_init(struct device_node *node)\r\n{\r\n__socfpga_pll_init(node, &clk_pll_ops);\r\n}

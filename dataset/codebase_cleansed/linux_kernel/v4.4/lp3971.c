static int lp3971_ldo_is_enabled(struct regulator_dev *dev)\r\n{\r\nstruct lp3971 *lp3971 = rdev_get_drvdata(dev);\r\nint ldo = rdev_get_id(dev) - LP3971_LDO1;\r\nu16 mask = 1 << (1 + ldo);\r\nu16 val;\r\nval = lp3971_reg_read(lp3971, LP3971_LDO_ENABLE_REG);\r\nreturn (val & mask) != 0;\r\n}\r\nstatic int lp3971_ldo_enable(struct regulator_dev *dev)\r\n{\r\nstruct lp3971 *lp3971 = rdev_get_drvdata(dev);\r\nint ldo = rdev_get_id(dev) - LP3971_LDO1;\r\nu16 mask = 1 << (1 + ldo);\r\nreturn lp3971_set_bits(lp3971, LP3971_LDO_ENABLE_REG, mask, mask);\r\n}\r\nstatic int lp3971_ldo_disable(struct regulator_dev *dev)\r\n{\r\nstruct lp3971 *lp3971 = rdev_get_drvdata(dev);\r\nint ldo = rdev_get_id(dev) - LP3971_LDO1;\r\nu16 mask = 1 << (1 + ldo);\r\nreturn lp3971_set_bits(lp3971, LP3971_LDO_ENABLE_REG, mask, 0);\r\n}\r\nstatic int lp3971_ldo_get_voltage_sel(struct regulator_dev *dev)\r\n{\r\nstruct lp3971 *lp3971 = rdev_get_drvdata(dev);\r\nint ldo = rdev_get_id(dev) - LP3971_LDO1;\r\nu16 val, reg;\r\nreg = lp3971_reg_read(lp3971, LP3971_LDO_VOL_CONTR_REG(ldo));\r\nval = (reg >> LDO_VOL_CONTR_SHIFT(ldo)) & LDO_VOL_CONTR_MASK;\r\nreturn val;\r\n}\r\nstatic int lp3971_ldo_set_voltage_sel(struct regulator_dev *dev,\r\nunsigned int selector)\r\n{\r\nstruct lp3971 *lp3971 = rdev_get_drvdata(dev);\r\nint ldo = rdev_get_id(dev) - LP3971_LDO1;\r\nreturn lp3971_set_bits(lp3971, LP3971_LDO_VOL_CONTR_REG(ldo),\r\nLDO_VOL_CONTR_MASK << LDO_VOL_CONTR_SHIFT(ldo),\r\nselector << LDO_VOL_CONTR_SHIFT(ldo));\r\n}\r\nstatic int lp3971_dcdc_is_enabled(struct regulator_dev *dev)\r\n{\r\nstruct lp3971 *lp3971 = rdev_get_drvdata(dev);\r\nint buck = rdev_get_id(dev) - LP3971_DCDC1;\r\nu16 mask = 1 << (buck * 2);\r\nu16 val;\r\nval = lp3971_reg_read(lp3971, LP3971_BUCK_VOL_ENABLE_REG);\r\nreturn (val & mask) != 0;\r\n}\r\nstatic int lp3971_dcdc_enable(struct regulator_dev *dev)\r\n{\r\nstruct lp3971 *lp3971 = rdev_get_drvdata(dev);\r\nint buck = rdev_get_id(dev) - LP3971_DCDC1;\r\nu16 mask = 1 << (buck * 2);\r\nreturn lp3971_set_bits(lp3971, LP3971_BUCK_VOL_ENABLE_REG, mask, mask);\r\n}\r\nstatic int lp3971_dcdc_disable(struct regulator_dev *dev)\r\n{\r\nstruct lp3971 *lp3971 = rdev_get_drvdata(dev);\r\nint buck = rdev_get_id(dev) - LP3971_DCDC1;\r\nu16 mask = 1 << (buck * 2);\r\nreturn lp3971_set_bits(lp3971, LP3971_BUCK_VOL_ENABLE_REG, mask, 0);\r\n}\r\nstatic int lp3971_dcdc_get_voltage_sel(struct regulator_dev *dev)\r\n{\r\nstruct lp3971 *lp3971 = rdev_get_drvdata(dev);\r\nint buck = rdev_get_id(dev) - LP3971_DCDC1;\r\nu16 reg;\r\nreg = lp3971_reg_read(lp3971, LP3971_BUCK_TARGET_VOL1_REG(buck));\r\nreg &= BUCK_TARGET_VOL_MASK;\r\nreturn reg;\r\n}\r\nstatic int lp3971_dcdc_set_voltage_sel(struct regulator_dev *dev,\r\nunsigned int selector)\r\n{\r\nstruct lp3971 *lp3971 = rdev_get_drvdata(dev);\r\nint buck = rdev_get_id(dev) - LP3971_DCDC1;\r\nint ret;\r\nret = lp3971_set_bits(lp3971, LP3971_BUCK_TARGET_VOL1_REG(buck),\r\nBUCK_TARGET_VOL_MASK, selector);\r\nif (ret)\r\nreturn ret;\r\nret = lp3971_set_bits(lp3971, LP3971_BUCK_VOL_CHANGE_REG,\r\nBUCK_VOL_CHANGE_FLAG_MASK << BUCK_VOL_CHANGE_SHIFT(buck),\r\nBUCK_VOL_CHANGE_FLAG_GO << BUCK_VOL_CHANGE_SHIFT(buck));\r\nif (ret)\r\nreturn ret;\r\nreturn lp3971_set_bits(lp3971, LP3971_BUCK_VOL_CHANGE_REG,\r\nBUCK_VOL_CHANGE_FLAG_MASK << BUCK_VOL_CHANGE_SHIFT(buck),\r\n0 << BUCK_VOL_CHANGE_SHIFT(buck));\r\n}\r\nstatic int lp3971_i2c_read(struct i2c_client *i2c, char reg, int count,\r\nu16 *dest)\r\n{\r\nint ret;\r\nif (count != 1)\r\nreturn -EIO;\r\nret = i2c_smbus_read_byte_data(i2c, reg);\r\nif (ret < 0)\r\nreturn ret;\r\n*dest = ret;\r\nreturn 0;\r\n}\r\nstatic int lp3971_i2c_write(struct i2c_client *i2c, char reg, int count,\r\nconst u16 *src)\r\n{\r\nif (count != 1)\r\nreturn -EIO;\r\nreturn i2c_smbus_write_byte_data(i2c, reg, *src);\r\n}\r\nstatic u8 lp3971_reg_read(struct lp3971 *lp3971, u8 reg)\r\n{\r\nu16 val = 0;\r\nmutex_lock(&lp3971->io_lock);\r\nlp3971_i2c_read(lp3971->i2c, reg, 1, &val);\r\ndev_dbg(lp3971->dev, "reg read 0x%02x -> 0x%02x\n", (int)reg,\r\n(unsigned)val&0xff);\r\nmutex_unlock(&lp3971->io_lock);\r\nreturn val & 0xff;\r\n}\r\nstatic int lp3971_set_bits(struct lp3971 *lp3971, u8 reg, u16 mask, u16 val)\r\n{\r\nu16 tmp;\r\nint ret;\r\nmutex_lock(&lp3971->io_lock);\r\nret = lp3971_i2c_read(lp3971->i2c, reg, 1, &tmp);\r\ntmp = (tmp & ~mask) | val;\r\nif (ret == 0) {\r\nret = lp3971_i2c_write(lp3971->i2c, reg, 1, &tmp);\r\ndev_dbg(lp3971->dev, "reg write 0x%02x -> 0x%02x\n", (int)reg,\r\n(unsigned)val&0xff);\r\n}\r\nmutex_unlock(&lp3971->io_lock);\r\nreturn ret;\r\n}\r\nstatic int setup_regulators(struct lp3971 *lp3971,\r\nstruct lp3971_platform_data *pdata)\r\n{\r\nint i, err;\r\nfor (i = 0; i < pdata->num_regulators; i++) {\r\nstruct regulator_config config = { };\r\nstruct lp3971_regulator_subdev *reg = &pdata->regulators[i];\r\nstruct regulator_dev *rdev;\r\nconfig.dev = lp3971->dev;\r\nconfig.init_data = reg->initdata;\r\nconfig.driver_data = lp3971;\r\nrdev = devm_regulator_register(lp3971->dev,\r\n&regulators[reg->id], &config);\r\nif (IS_ERR(rdev)) {\r\nerr = PTR_ERR(rdev);\r\ndev_err(lp3971->dev, "regulator init failed: %d\n",\r\nerr);\r\nreturn err;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int lp3971_i2c_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct lp3971 *lp3971;\r\nstruct lp3971_platform_data *pdata = dev_get_platdata(&i2c->dev);\r\nint ret;\r\nu16 val;\r\nif (!pdata) {\r\ndev_dbg(&i2c->dev, "No platform init data supplied\n");\r\nreturn -ENODEV;\r\n}\r\nlp3971 = devm_kzalloc(&i2c->dev, sizeof(struct lp3971), GFP_KERNEL);\r\nif (lp3971 == NULL)\r\nreturn -ENOMEM;\r\nlp3971->i2c = i2c;\r\nlp3971->dev = &i2c->dev;\r\nmutex_init(&lp3971->io_lock);\r\nret = lp3971_i2c_read(i2c, LP3971_SYS_CONTROL1_REG, 1, &val);\r\nif (ret == 0 && (val & SYS_CONTROL1_INIT_MASK) != SYS_CONTROL1_INIT_VAL)\r\nret = -ENODEV;\r\nif (ret < 0) {\r\ndev_err(&i2c->dev, "failed to detect device\n");\r\nreturn ret;\r\n}\r\nret = setup_regulators(lp3971, pdata);\r\nif (ret < 0)\r\nreturn ret;\r\ni2c_set_clientdata(i2c, lp3971);\r\nreturn 0;\r\n}

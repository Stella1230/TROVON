void drm_global_init(void)\r\n{\r\nint i;\r\nfor (i = 0; i < DRM_GLOBAL_NUM; ++i) {\r\nstruct drm_global_item *item = &glob[i];\r\nmutex_init(&item->mutex);\r\nitem->object = NULL;\r\nitem->refcount = 0;\r\n}\r\n}\r\nvoid drm_global_release(void)\r\n{\r\nint i;\r\nfor (i = 0; i < DRM_GLOBAL_NUM; ++i) {\r\nstruct drm_global_item *item = &glob[i];\r\nBUG_ON(item->object != NULL);\r\nBUG_ON(item->refcount != 0);\r\n}\r\n}\r\nint drm_global_item_ref(struct drm_global_reference *ref)\r\n{\r\nint ret;\r\nstruct drm_global_item *item = &glob[ref->global_type];\r\nmutex_lock(&item->mutex);\r\nif (item->refcount == 0) {\r\nitem->object = kzalloc(ref->size, GFP_KERNEL);\r\nif (unlikely(item->object == NULL)) {\r\nret = -ENOMEM;\r\ngoto out_err;\r\n}\r\nref->object = item->object;\r\nret = ref->init(ref);\r\nif (unlikely(ret != 0))\r\ngoto out_err;\r\n}\r\n++item->refcount;\r\nref->object = item->object;\r\nmutex_unlock(&item->mutex);\r\nreturn 0;\r\nout_err:\r\nmutex_unlock(&item->mutex);\r\nitem->object = NULL;\r\nreturn ret;\r\n}\r\nvoid drm_global_item_unref(struct drm_global_reference *ref)\r\n{\r\nstruct drm_global_item *item = &glob[ref->global_type];\r\nmutex_lock(&item->mutex);\r\nBUG_ON(item->refcount == 0);\r\nBUG_ON(ref->object != item->object);\r\nif (--item->refcount == 0) {\r\nref->release(ref);\r\nitem->object = NULL;\r\n}\r\nmutex_unlock(&item->mutex);\r\n}

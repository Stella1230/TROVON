static int qcom_coincell_chgr_config(struct qcom_coincell *chgr, int rset,\r\nint vset, bool enable)\r\n{\r\nint i, j, rc;\r\nif (!enable)\r\nreturn regmap_write(chgr->regmap,\r\nchgr->base_addr + QCOM_COINCELL_REG_ENABLE, 0);\r\nfor (i = 0; i < ARRAY_SIZE(qcom_rset_map); i++)\r\nif (rset == qcom_rset_map[i])\r\nbreak;\r\nif (i >= ARRAY_SIZE(qcom_rset_map)) {\r\ndev_err(chgr->dev, "invalid rset-ohms value %d\n", rset);\r\nreturn -EINVAL;\r\n}\r\nfor (j = 0; j < ARRAY_SIZE(qcom_vset_map); j++)\r\nif (vset == qcom_vset_map[j])\r\nbreak;\r\nif (j >= ARRAY_SIZE(qcom_vset_map)) {\r\ndev_err(chgr->dev, "invalid vset-millivolts value %d\n", vset);\r\nreturn -EINVAL;\r\n}\r\nrc = regmap_write(chgr->regmap,\r\nchgr->base_addr + QCOM_COINCELL_REG_RSET, i);\r\nif (rc) {\r\ndev_err(chgr->dev, "could not write to RSET register\n");\r\nreturn rc;\r\n}\r\nrc = regmap_write(chgr->regmap,\r\nchgr->base_addr + QCOM_COINCELL_REG_VSET, j);\r\nif (rc)\r\nreturn rc;\r\nreturn regmap_write(chgr->regmap,\r\nchgr->base_addr + QCOM_COINCELL_REG_ENABLE,\r\nQCOM_COINCELL_ENABLE);\r\n}\r\nstatic int qcom_coincell_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *node = pdev->dev.of_node;\r\nstruct qcom_coincell chgr;\r\nu32 rset, vset;\r\nbool enable;\r\nint rc;\r\nchgr.dev = &pdev->dev;\r\nchgr.regmap = dev_get_regmap(pdev->dev.parent, NULL);\r\nif (!chgr.regmap) {\r\ndev_err(chgr.dev, "Unable to get regmap\n");\r\nreturn -EINVAL;\r\n}\r\nrc = of_property_read_u32(node, "reg", &chgr.base_addr);\r\nif (rc)\r\nreturn rc;\r\nenable = !of_property_read_bool(node, "qcom,charger-disable");\r\nif (enable) {\r\nrc = of_property_read_u32(node, "qcom,rset-ohms", &rset);\r\nif (rc) {\r\ndev_err(chgr.dev,\r\n"can't find 'qcom,rset-ohms' in DT block");\r\nreturn rc;\r\n}\r\nrc = of_property_read_u32(node, "qcom,vset-millivolts", &vset);\r\nif (rc) {\r\ndev_err(chgr.dev,\r\n"can't find 'qcom,vset-millivolts' in DT block");\r\nreturn rc;\r\n}\r\n}\r\nreturn qcom_coincell_chgr_config(&chgr, rset, vset, enable);\r\n}

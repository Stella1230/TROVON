static irqreturn_t jz4740_musb_interrupt(int irq, void *__hci)\r\n{\r\nunsigned long flags;\r\nirqreturn_t retval = IRQ_NONE;\r\nstruct musb *musb = __hci;\r\nspin_lock_irqsave(&musb->lock, flags);\r\nmusb->int_usb = musb_readb(musb->mregs, MUSB_INTRUSB);\r\nmusb->int_tx = musb_readw(musb->mregs, MUSB_INTRTX);\r\nmusb->int_rx = musb_readw(musb->mregs, MUSB_INTRRX);\r\nmusb->int_usb &= MUSB_INTR_SUSPEND | MUSB_INTR_RESUME |\r\nMUSB_INTR_RESET | MUSB_INTR_SOF;\r\nif (musb->int_usb || musb->int_tx || musb->int_rx)\r\nretval = musb_interrupt(musb);\r\nspin_unlock_irqrestore(&musb->lock, flags);\r\nreturn retval;\r\n}\r\nstatic int jz4740_musb_init(struct musb *musb)\r\n{\r\nusb_phy_generic_register();\r\nmusb->xceiv = usb_get_phy(USB_PHY_TYPE_USB2);\r\nif (!musb->xceiv) {\r\npr_err("HS UDC: no transceiver configured\n");\r\nreturn -ENODEV;\r\n}\r\nmusb->dyn_fifo = true;\r\nmusb->isr = jz4740_musb_interrupt;\r\nreturn 0;\r\n}\r\nstatic int jz4740_musb_exit(struct musb *musb)\r\n{\r\nusb_put_phy(musb->xceiv);\r\nreturn 0;\r\n}\r\nstatic int jz4740_probe(struct platform_device *pdev)\r\n{\r\nstruct musb_hdrc_platform_data *pdata = &jz4740_musb_platform_data;\r\nstruct platform_device *musb;\r\nstruct jz4740_glue *glue;\r\nstruct clk *clk;\r\nint ret;\r\nglue = devm_kzalloc(&pdev->dev, sizeof(*glue), GFP_KERNEL);\r\nif (!glue)\r\nreturn -ENOMEM;\r\nmusb = platform_device_alloc("musb-hdrc", PLATFORM_DEVID_AUTO);\r\nif (!musb) {\r\ndev_err(&pdev->dev, "failed to allocate musb device\n");\r\nreturn -ENOMEM;\r\n}\r\nclk = devm_clk_get(&pdev->dev, "udc");\r\nif (IS_ERR(clk)) {\r\ndev_err(&pdev->dev, "failed to get clock\n");\r\nret = PTR_ERR(clk);\r\ngoto err_platform_device_put;\r\n}\r\nret = clk_prepare_enable(clk);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to enable clock\n");\r\ngoto err_platform_device_put;\r\n}\r\nmusb->dev.parent = &pdev->dev;\r\nglue->dev = &pdev->dev;\r\nglue->musb = musb;\r\nglue->clk = clk;\r\npdata->platform_ops = &jz4740_musb_ops;\r\nplatform_set_drvdata(pdev, glue);\r\nret = platform_device_add_resources(musb, pdev->resource,\r\npdev->num_resources);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to add resources\n");\r\ngoto err_clk_disable;\r\n}\r\nret = platform_device_add_data(musb, pdata, sizeof(*pdata));\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to add platform_data\n");\r\ngoto err_clk_disable;\r\n}\r\nret = platform_device_add(musb);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to register musb device\n");\r\ngoto err_clk_disable;\r\n}\r\nreturn 0;\r\nerr_clk_disable:\r\nclk_disable_unprepare(clk);\r\nerr_platform_device_put:\r\nplatform_device_put(musb);\r\nreturn ret;\r\n}\r\nstatic int jz4740_remove(struct platform_device *pdev)\r\n{\r\nstruct jz4740_glue *glue = platform_get_drvdata(pdev);\r\nplatform_device_unregister(glue->musb);\r\nusb_phy_generic_unregister(pdev);\r\nclk_disable_unprepare(glue->clk);\r\nreturn 0;\r\n}

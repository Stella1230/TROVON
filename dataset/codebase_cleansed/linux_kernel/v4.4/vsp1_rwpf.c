int vsp1_rwpf_enum_mbus_code(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_mbus_code_enum *code)\r\n{\r\nstatic const unsigned int codes[] = {\r\nMEDIA_BUS_FMT_ARGB8888_1X32,\r\nMEDIA_BUS_FMT_AYUV8_1X32,\r\n};\r\nif (code->index >= ARRAY_SIZE(codes))\r\nreturn -EINVAL;\r\ncode->code = codes[code->index];\r\nreturn 0;\r\n}\r\nint vsp1_rwpf_enum_frame_size(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_frame_size_enum *fse)\r\n{\r\nstruct vsp1_rwpf *rwpf = to_rwpf(subdev);\r\nstruct v4l2_mbus_framefmt *format;\r\nformat = vsp1_entity_get_pad_format(&rwpf->entity, cfg, fse->pad,\r\nfse->which);\r\nif (fse->index || fse->code != format->code)\r\nreturn -EINVAL;\r\nif (fse->pad == RWPF_PAD_SINK) {\r\nfse->min_width = RWPF_MIN_WIDTH;\r\nfse->max_width = rwpf->max_width;\r\nfse->min_height = RWPF_MIN_HEIGHT;\r\nfse->max_height = rwpf->max_height;\r\n} else {\r\nfse->min_width = format->width;\r\nfse->max_width = format->width;\r\nfse->min_height = format->height;\r\nfse->max_height = format->height;\r\n}\r\nreturn 0;\r\n}\r\nstatic struct v4l2_rect *\r\nvsp1_rwpf_get_crop(struct vsp1_rwpf *rwpf, struct v4l2_subdev_pad_config *cfg, u32 which)\r\n{\r\nswitch (which) {\r\ncase V4L2_SUBDEV_FORMAT_TRY:\r\nreturn v4l2_subdev_get_try_crop(&rwpf->entity.subdev, cfg, RWPF_PAD_SINK);\r\ncase V4L2_SUBDEV_FORMAT_ACTIVE:\r\nreturn &rwpf->crop;\r\ndefault:\r\nreturn NULL;\r\n}\r\n}\r\nint vsp1_rwpf_get_format(struct v4l2_subdev *subdev, struct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_format *fmt)\r\n{\r\nstruct vsp1_rwpf *rwpf = to_rwpf(subdev);\r\nfmt->format = *vsp1_entity_get_pad_format(&rwpf->entity, cfg, fmt->pad,\r\nfmt->which);\r\nreturn 0;\r\n}\r\nint vsp1_rwpf_set_format(struct v4l2_subdev *subdev, struct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_format *fmt)\r\n{\r\nstruct vsp1_rwpf *rwpf = to_rwpf(subdev);\r\nstruct v4l2_mbus_framefmt *format;\r\nstruct v4l2_rect *crop;\r\nif (fmt->format.code != MEDIA_BUS_FMT_ARGB8888_1X32 &&\r\nfmt->format.code != MEDIA_BUS_FMT_AYUV8_1X32)\r\nfmt->format.code = MEDIA_BUS_FMT_AYUV8_1X32;\r\nformat = vsp1_entity_get_pad_format(&rwpf->entity, cfg, fmt->pad,\r\nfmt->which);\r\nif (fmt->pad == RWPF_PAD_SOURCE) {\r\nformat->code = fmt->format.code;\r\nfmt->format = *format;\r\nreturn 0;\r\n}\r\nformat->code = fmt->format.code;\r\nformat->width = clamp_t(unsigned int, fmt->format.width,\r\nRWPF_MIN_WIDTH, rwpf->max_width);\r\nformat->height = clamp_t(unsigned int, fmt->format.height,\r\nRWPF_MIN_HEIGHT, rwpf->max_height);\r\nformat->field = V4L2_FIELD_NONE;\r\nformat->colorspace = V4L2_COLORSPACE_SRGB;\r\nfmt->format = *format;\r\ncrop = vsp1_rwpf_get_crop(rwpf, cfg, fmt->which);\r\ncrop->left = 0;\r\ncrop->top = 0;\r\ncrop->width = fmt->format.width;\r\ncrop->height = fmt->format.height;\r\nformat = vsp1_entity_get_pad_format(&rwpf->entity, cfg, RWPF_PAD_SOURCE,\r\nfmt->which);\r\n*format = fmt->format;\r\nreturn 0;\r\n}\r\nint vsp1_rwpf_get_selection(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_selection *sel)\r\n{\r\nstruct vsp1_rwpf *rwpf = to_rwpf(subdev);\r\nstruct v4l2_mbus_framefmt *format;\r\nif (sel->pad != RWPF_PAD_SINK)\r\nreturn -EINVAL;\r\nswitch (sel->target) {\r\ncase V4L2_SEL_TGT_CROP:\r\nsel->r = *vsp1_rwpf_get_crop(rwpf, cfg, sel->which);\r\nbreak;\r\ncase V4L2_SEL_TGT_CROP_BOUNDS:\r\nformat = vsp1_entity_get_pad_format(&rwpf->entity, cfg,\r\nRWPF_PAD_SINK, sel->which);\r\nsel->r.left = 0;\r\nsel->r.top = 0;\r\nsel->r.width = format->width;\r\nsel->r.height = format->height;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nint vsp1_rwpf_set_selection(struct v4l2_subdev *subdev,\r\nstruct v4l2_subdev_pad_config *cfg,\r\nstruct v4l2_subdev_selection *sel)\r\n{\r\nstruct vsp1_rwpf *rwpf = to_rwpf(subdev);\r\nstruct v4l2_mbus_framefmt *format;\r\nstruct v4l2_rect *crop;\r\nif (sel->pad != RWPF_PAD_SINK)\r\nreturn -EINVAL;\r\nif (sel->target != V4L2_SEL_TGT_CROP)\r\nreturn -EINVAL;\r\nformat = vsp1_entity_get_pad_format(&rwpf->entity, cfg, RWPF_PAD_SINK,\r\nsel->which);\r\nif (format->code == MEDIA_BUS_FMT_AYUV8_1X32) {\r\nsel->r.left = ALIGN(sel->r.left, 2);\r\nsel->r.top = ALIGN(sel->r.top, 2);\r\nsel->r.width = round_down(sel->r.width, 2);\r\nsel->r.height = round_down(sel->r.height, 2);\r\n}\r\nsel->r.left = min_t(unsigned int, sel->r.left, format->width - 2);\r\nsel->r.top = min_t(unsigned int, sel->r.top, format->height - 2);\r\nif (rwpf->entity.type == VSP1_ENTITY_WPF) {\r\nsel->r.left = min_t(unsigned int, sel->r.left, 255);\r\nsel->r.top = min_t(unsigned int, sel->r.top, 255);\r\n}\r\nsel->r.width = min_t(unsigned int, sel->r.width,\r\nformat->width - sel->r.left);\r\nsel->r.height = min_t(unsigned int, sel->r.height,\r\nformat->height - sel->r.top);\r\ncrop = vsp1_rwpf_get_crop(rwpf, cfg, sel->which);\r\n*crop = sel->r;\r\nformat = vsp1_entity_get_pad_format(&rwpf->entity, cfg, RWPF_PAD_SOURCE,\r\nsel->which);\r\nformat->width = crop->width;\r\nformat->height = crop->height;\r\nreturn 0;\r\n}

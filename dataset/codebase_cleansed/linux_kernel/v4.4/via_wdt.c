static inline void wdt_reset(void)\r\n{\r\nunsigned int ctl = readl(wdt_mem);\r\nwritel(ctl | VIA_WDT_TRIGGER, wdt_mem);\r\n}\r\nstatic void wdt_timer_tick(unsigned long data)\r\n{\r\nif (time_before(jiffies, next_heartbeat) ||\r\n(!watchdog_active(&wdt_dev))) {\r\nwdt_reset();\r\nmod_timer(&timer, jiffies + WDT_HEARTBEAT);\r\n} else\r\npr_crit("I will reboot your machine !\n");\r\n}\r\nstatic int wdt_ping(struct watchdog_device *wdd)\r\n{\r\nnext_heartbeat = jiffies + wdd->timeout * HZ;\r\nreturn 0;\r\n}\r\nstatic int wdt_start(struct watchdog_device *wdd)\r\n{\r\nunsigned int ctl = readl(wdt_mem);\r\nwritel(wdd->timeout, wdt_mem + VIA_WDT_COUNT);\r\nwritel(ctl | VIA_WDT_RUNNING | VIA_WDT_TRIGGER, wdt_mem);\r\nwdt_ping(wdd);\r\nmod_timer(&timer, jiffies + WDT_HEARTBEAT);\r\nreturn 0;\r\n}\r\nstatic int wdt_stop(struct watchdog_device *wdd)\r\n{\r\nunsigned int ctl = readl(wdt_mem);\r\nwritel(ctl & ~VIA_WDT_RUNNING, wdt_mem);\r\nreturn 0;\r\n}\r\nstatic int wdt_set_timeout(struct watchdog_device *wdd,\r\nunsigned int new_timeout)\r\n{\r\nwritel(new_timeout, wdt_mem + VIA_WDT_COUNT);\r\nwdd->timeout = new_timeout;\r\nreturn 0;\r\n}\r\nstatic int wdt_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *ent)\r\n{\r\nunsigned char conf;\r\nint ret = -ENODEV;\r\nif (pci_enable_device(pdev)) {\r\ndev_err(&pdev->dev, "cannot enable PCI device\n");\r\nreturn -ENODEV;\r\n}\r\nif (allocate_resource(&iomem_resource, &wdt_res, VIA_WDT_MMIO_LEN,\r\n0xf0000000, 0xffffff00, 0xff, NULL, NULL)) {\r\ndev_err(&pdev->dev, "MMIO allocation failed\n");\r\ngoto err_out_disable_device;\r\n}\r\npci_write_config_dword(pdev, VIA_WDT_MMIO_BASE, wdt_res.start);\r\npci_read_config_byte(pdev, VIA_WDT_CONF, &conf);\r\nconf |= VIA_WDT_CONF_ENABLE | VIA_WDT_CONF_MMIO;\r\npci_write_config_byte(pdev, VIA_WDT_CONF, conf);\r\npci_read_config_dword(pdev, VIA_WDT_MMIO_BASE, &mmio);\r\nif (mmio) {\r\ndev_info(&pdev->dev, "VIA Chipset watchdog MMIO: %x\n", mmio);\r\n} else {\r\ndev_err(&pdev->dev, "MMIO setting failed. Check BIOS.\n");\r\ngoto err_out_resource;\r\n}\r\nif (!request_mem_region(mmio, VIA_WDT_MMIO_LEN, "via_wdt")) {\r\ndev_err(&pdev->dev, "MMIO region busy\n");\r\ngoto err_out_resource;\r\n}\r\nwdt_mem = ioremap(mmio, VIA_WDT_MMIO_LEN);\r\nif (wdt_mem == NULL) {\r\ndev_err(&pdev->dev, "cannot remap VIA wdt MMIO registers\n");\r\ngoto err_out_release;\r\n}\r\nif (timeout < 1 || timeout > WDT_TIMEOUT_MAX)\r\ntimeout = WDT_TIMEOUT;\r\nwdt_dev.timeout = timeout;\r\nwdt_dev.parent = &pdev->dev;\r\nwatchdog_set_nowayout(&wdt_dev, nowayout);\r\nif (readl(wdt_mem) & VIA_WDT_FIRED)\r\nwdt_dev.bootstatus |= WDIOF_CARDRESET;\r\nret = watchdog_register_device(&wdt_dev);\r\nif (ret)\r\ngoto err_out_iounmap;\r\nmod_timer(&timer, jiffies + WDT_HEARTBEAT);\r\nreturn 0;\r\nerr_out_iounmap:\r\niounmap(wdt_mem);\r\nerr_out_release:\r\nrelease_mem_region(mmio, VIA_WDT_MMIO_LEN);\r\nerr_out_resource:\r\nrelease_resource(&wdt_res);\r\nerr_out_disable_device:\r\npci_disable_device(pdev);\r\nreturn ret;\r\n}\r\nstatic void wdt_remove(struct pci_dev *pdev)\r\n{\r\nwatchdog_unregister_device(&wdt_dev);\r\ndel_timer_sync(&timer);\r\niounmap(wdt_mem);\r\nrelease_mem_region(mmio, VIA_WDT_MMIO_LEN);\r\nrelease_resource(&wdt_res);\r\npci_disable_device(pdev);\r\n}

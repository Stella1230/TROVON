static int cpufreq_set(struct cpufreq_policy *policy, unsigned int freq)\r\n{\r\nint ret = -EINVAL;\r\npr_debug("cpufreq_set for cpu %u, freq %u kHz\n", policy->cpu, freq);\r\nmutex_lock(&userspace_mutex);\r\nif (!per_cpu(cpu_is_managed, policy->cpu))\r\ngoto err;\r\nret = __cpufreq_driver_target(policy, freq, CPUFREQ_RELATION_L);\r\nerr:\r\nmutex_unlock(&userspace_mutex);\r\nreturn ret;\r\n}\r\nstatic ssize_t show_speed(struct cpufreq_policy *policy, char *buf)\r\n{\r\nreturn sprintf(buf, "%u\n", policy->cur);\r\n}\r\nstatic int cpufreq_governor_userspace(struct cpufreq_policy *policy,\r\nunsigned int event)\r\n{\r\nunsigned int cpu = policy->cpu;\r\nint rc = 0;\r\nswitch (event) {\r\ncase CPUFREQ_GOV_START:\r\nBUG_ON(!policy->cur);\r\npr_debug("started managing cpu %u\n", cpu);\r\nmutex_lock(&userspace_mutex);\r\nper_cpu(cpu_is_managed, cpu) = 1;\r\nmutex_unlock(&userspace_mutex);\r\nbreak;\r\ncase CPUFREQ_GOV_STOP:\r\npr_debug("managing cpu %u stopped\n", cpu);\r\nmutex_lock(&userspace_mutex);\r\nper_cpu(cpu_is_managed, cpu) = 0;\r\nmutex_unlock(&userspace_mutex);\r\nbreak;\r\ncase CPUFREQ_GOV_LIMITS:\r\nmutex_lock(&userspace_mutex);\r\npr_debug("limit event for cpu %u: %u - %u kHz, currently %u kHz\n",\r\ncpu, policy->min, policy->max,\r\npolicy->cur);\r\nif (policy->max < policy->cur)\r\n__cpufreq_driver_target(policy, policy->max,\r\nCPUFREQ_RELATION_H);\r\nelse if (policy->min > policy->cur)\r\n__cpufreq_driver_target(policy, policy->min,\r\nCPUFREQ_RELATION_L);\r\nmutex_unlock(&userspace_mutex);\r\nbreak;\r\n}\r\nreturn rc;\r\n}\r\nstatic int __init cpufreq_gov_userspace_init(void)\r\n{\r\nreturn cpufreq_register_governor(&cpufreq_gov_userspace);\r\n}\r\nstatic void __exit cpufreq_gov_userspace_exit(void)\r\n{\r\ncpufreq_unregister_governor(&cpufreq_gov_userspace);\r\n}

static void dc_wdt_set(struct dc_wdt *wdt, u32 ticks)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&wdt->lock, flags);\r\nwritel_relaxed(0, wdt->base + TIMER_A_CONTROL);\r\nwritel_relaxed(ticks, wdt->base + TIMER_A_COUNT);\r\nwritel_relaxed(TIMER_A_ENABLE_COUNT | TIMER_A_ENABLE_WATCHDOG,\r\nwdt->base + TIMER_A_CONTROL);\r\nspin_unlock_irqrestore(&wdt->lock, flags);\r\n}\r\nstatic int dc_restart_handler(struct notifier_block *this, unsigned long mode,\r\nvoid *cmd)\r\n{\r\nstruct dc_wdt *wdt = container_of(this, struct dc_wdt, restart_handler);\r\ndc_wdt_set(wdt, 1);\r\nmdelay(500);\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int dc_wdt_start(struct watchdog_device *wdog)\r\n{\r\nstruct dc_wdt *wdt = watchdog_get_drvdata(wdog);\r\ndc_wdt_set(wdt, wdog->timeout * clk_get_rate(wdt->clk));\r\nreturn 0;\r\n}\r\nstatic int dc_wdt_stop(struct watchdog_device *wdog)\r\n{\r\nstruct dc_wdt *wdt = watchdog_get_drvdata(wdog);\r\nwritel_relaxed(0, wdt->base + TIMER_A_CONTROL);\r\nreturn 0;\r\n}\r\nstatic int dc_wdt_set_timeout(struct watchdog_device *wdog, unsigned int t)\r\n{\r\nstruct dc_wdt *wdt = watchdog_get_drvdata(wdog);\r\ndc_wdt_set(wdt, t * clk_get_rate(wdt->clk));\r\nwdog->timeout = t;\r\nreturn 0;\r\n}\r\nstatic unsigned int dc_wdt_get_timeleft(struct watchdog_device *wdog)\r\n{\r\nstruct dc_wdt *wdt = watchdog_get_drvdata(wdog);\r\nuint32_t count = readl_relaxed(wdt->base + TIMER_A_COUNT);\r\nreturn count / clk_get_rate(wdt->clk);\r\n}\r\nstatic int dc_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *np = dev->of_node;\r\nstruct dc_wdt *wdt;\r\nint ret;\r\nwdt = devm_kzalloc(dev, sizeof(struct dc_wdt), GFP_KERNEL);\r\nif (!wdt)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, wdt);\r\nwdt->base = of_iomap(np, 0);\r\nif (!wdt->base) {\r\ndev_err(dev, "Failed to remap watchdog regs");\r\nreturn -ENODEV;\r\n}\r\nwdt->clk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(wdt->clk)) {\r\nret = PTR_ERR(wdt->clk);\r\ngoto err_iounmap;\r\n}\r\ndc_wdt_wdd.max_timeout = U32_MAX / clk_get_rate(wdt->clk);\r\ndc_wdt_wdd.timeout = dc_wdt_wdd.max_timeout;\r\ndc_wdt_wdd.parent = &pdev->dev;\r\nspin_lock_init(&wdt->lock);\r\nwatchdog_set_drvdata(&dc_wdt_wdd, wdt);\r\nwatchdog_init_timeout(&dc_wdt_wdd, timeout, dev);\r\nret = watchdog_register_device(&dc_wdt_wdd);\r\nif (ret) {\r\ndev_err(dev, "Failed to register watchdog device");\r\ngoto err_iounmap;\r\n}\r\nwdt->restart_handler.notifier_call = dc_restart_handler;\r\nwdt->restart_handler.priority = 128;\r\nret = register_restart_handler(&wdt->restart_handler);\r\nif (ret)\r\ndev_warn(&pdev->dev, "cannot register restart handler\n");\r\nreturn 0;\r\nerr_iounmap:\r\niounmap(wdt->base);\r\nreturn ret;\r\n}\r\nstatic int dc_wdt_remove(struct platform_device *pdev)\r\n{\r\nstruct dc_wdt *wdt = platform_get_drvdata(pdev);\r\nunregister_restart_handler(&wdt->restart_handler);\r\nwatchdog_unregister_device(&dc_wdt_wdd);\r\niounmap(wdt->base);\r\nreturn 0;\r\n}\r\nstatic void dc_wdt_shutdown(struct platform_device *pdev)\r\n{\r\ndc_wdt_stop(&dc_wdt_wdd);\r\n}

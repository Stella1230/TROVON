static ssize_t read_file_node_aggr(struct file *file, char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath_node *an = file->private_data;\r\nstruct ath_softc *sc = an->sc;\r\nstruct ath_atx_tid *tid;\r\nstruct ath_txq *txq;\r\nu32 len = 0, size = 4096;\r\nchar *buf;\r\nsize_t retval;\r\nint tidno;\r\nbuf = kzalloc(size, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn -ENOMEM;\r\nif (!an->sta->ht_cap.ht_supported) {\r\nlen = scnprintf(buf, size, "%s\n",\r\n"HT not supported");\r\ngoto exit;\r\n}\r\nlen = scnprintf(buf, size, "Max-AMPDU: %d\n",\r\nan->maxampdu);\r\nlen += scnprintf(buf + len, size - len, "MPDU Density: %d\n\n",\r\nan->mpdudensity);\r\nlen += scnprintf(buf + len, size - len,\r\n"\n%3s%11s%10s%10s%10s%10s%9s%6s%8s\n",\r\n"TID", "SEQ_START", "SEQ_NEXT", "BAW_SIZE",\r\n"BAW_HEAD", "BAW_TAIL", "BAR_IDX", "SCHED", "PAUSED");\r\nfor (tidno = 0, tid = &an->tid[tidno];\r\ntidno < IEEE80211_NUM_TIDS; tidno++, tid++) {\r\ntxq = tid->txq;\r\nath_txq_lock(sc, txq);\r\nif (tid->active) {\r\nlen += scnprintf(buf + len, size - len,\r\n"%3d%11d%10d%10d%10d%10d%9d%6d\n",\r\ntid->tidno,\r\ntid->seq_start,\r\ntid->seq_next,\r\ntid->baw_size,\r\ntid->baw_head,\r\ntid->baw_tail,\r\ntid->bar_index,\r\n!list_empty(&tid->list));\r\n}\r\nath_txq_unlock(sc, txq);\r\n}\r\nexit:\r\nretval = simple_read_from_buffer(user_buf, count, ppos, buf, len);\r\nkfree(buf);\r\nreturn retval;\r\n}\r\nvoid ath_debug_rate_stats(struct ath_softc *sc,\r\nstruct ath_rx_status *rs,\r\nstruct sk_buff *skb)\r\n{\r\nstruct ieee80211_hdr *hdr = (struct ieee80211_hdr *) skb->data;\r\nstruct ath_hw *ah = sc->sc_ah;\r\nstruct ieee80211_rx_status *rxs;\r\nstruct ath_rx_rate_stats *rstats;\r\nstruct ieee80211_sta *sta;\r\nstruct ath_node *an;\r\nif (!ieee80211_is_data(hdr->frame_control))\r\nreturn;\r\nrcu_read_lock();\r\nsta = ieee80211_find_sta_by_ifaddr(sc->hw, hdr->addr2, NULL);\r\nif (!sta)\r\ngoto exit;\r\nan = (struct ath_node *) sta->drv_priv;\r\nrstats = &an->rx_rate_stats;\r\nrxs = IEEE80211_SKB_RXCB(skb);\r\nif (IS_HT_RATE(rs->rs_rate)) {\r\nif (rxs->rate_idx >= ARRAY_SIZE(rstats->ht_stats))\r\ngoto exit;\r\nif (rxs->flag & RX_FLAG_40MHZ)\r\nrstats->ht_stats[rxs->rate_idx].ht40_cnt++;\r\nelse\r\nrstats->ht_stats[rxs->rate_idx].ht20_cnt++;\r\nif (rxs->flag & RX_FLAG_SHORT_GI)\r\nrstats->ht_stats[rxs->rate_idx].sgi_cnt++;\r\nelse\r\nrstats->ht_stats[rxs->rate_idx].lgi_cnt++;\r\ngoto exit;\r\n}\r\nif (IS_CCK_RATE(rs->rs_rate)) {\r\nif (rxs->flag & RX_FLAG_SHORTPRE)\r\nrstats->cck_stats[rxs->rate_idx].cck_sp_cnt++;\r\nelse\r\nrstats->cck_stats[rxs->rate_idx].cck_lp_cnt++;\r\ngoto exit;\r\n}\r\nif (IS_OFDM_RATE(rs->rs_rate)) {\r\nif (ah->curchan->chan->band == IEEE80211_BAND_2GHZ)\r\nrstats->ofdm_stats[rxs->rate_idx - 4].ofdm_cnt++;\r\nelse\r\nrstats->ofdm_stats[rxs->rate_idx].ofdm_cnt++;\r\n}\r\nexit:\r\nrcu_read_unlock();\r\n}\r\nstatic ssize_t read_file_node_recv(struct file *file, char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath_node *an = file->private_data;\r\nstruct ath_softc *sc = an->sc;\r\nstruct ath_hw *ah = sc->sc_ah;\r\nstruct ath_rx_rate_stats *rstats;\r\nstruct ieee80211_sta *sta = an->sta;\r\nenum ieee80211_band band;\r\nu32 len = 0, size = 4096;\r\nchar *buf;\r\nsize_t retval;\r\nint i;\r\nbuf = kzalloc(size, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn -ENOMEM;\r\nband = ah->curchan->chan->band;\r\nrstats = &an->rx_rate_stats;\r\nif (!sta->ht_cap.ht_supported)\r\ngoto legacy;\r\nlen += scnprintf(buf + len, size - len,\r\n"%24s%10s%10s%10s\n",\r\n"HT20", "HT40", "SGI", "LGI");\r\nfor (i = 0; i < 24; i++) {\r\nlen += scnprintf(buf + len, size - len,\r\n"%8s%3u : %10u%10u%10u%10u\n",\r\n"MCS", i,\r\nrstats->ht_stats[i].ht20_cnt,\r\nrstats->ht_stats[i].ht40_cnt,\r\nrstats->ht_stats[i].sgi_cnt,\r\nrstats->ht_stats[i].lgi_cnt);\r\n}\r\nlen += scnprintf(buf + len, size - len, "\n");\r\nlegacy:\r\nif (band == IEEE80211_BAND_2GHZ) {\r\nPRINT_CCK_RATE("CCK-1M/LP", 0, false);\r\nPRINT_CCK_RATE("CCK-2M/LP", 1, false);\r\nPRINT_CCK_RATE("CCK-5.5M/LP", 2, false);\r\nPRINT_CCK_RATE("CCK-11M/LP", 3, false);\r\nPRINT_CCK_RATE("CCK-2M/SP", 1, true);\r\nPRINT_CCK_RATE("CCK-5.5M/SP", 2, true);\r\nPRINT_CCK_RATE("CCK-11M/SP", 3, true);\r\n}\r\nPRINT_OFDM_RATE("OFDM-6M", 0);\r\nPRINT_OFDM_RATE("OFDM-9M", 1);\r\nPRINT_OFDM_RATE("OFDM-12M", 2);\r\nPRINT_OFDM_RATE("OFDM-18M", 3);\r\nPRINT_OFDM_RATE("OFDM-24M", 4);\r\nPRINT_OFDM_RATE("OFDM-36M", 5);\r\nPRINT_OFDM_RATE("OFDM-48M", 6);\r\nPRINT_OFDM_RATE("OFDM-54M", 7);\r\nretval = simple_read_from_buffer(user_buf, count, ppos, buf, len);\r\nkfree(buf);\r\nreturn retval;\r\n}\r\nvoid ath9k_sta_add_debugfs(struct ieee80211_hw *hw,\r\nstruct ieee80211_vif *vif,\r\nstruct ieee80211_sta *sta,\r\nstruct dentry *dir)\r\n{\r\nstruct ath_node *an = (struct ath_node *)sta->drv_priv;\r\ndebugfs_create_file("node_aggr", S_IRUGO, dir, an, &fops_node_aggr);\r\ndebugfs_create_file("node_recv", S_IRUGO, dir, an, &fops_node_recv);\r\n}

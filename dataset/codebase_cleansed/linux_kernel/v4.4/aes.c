static int p8_aes_init(struct crypto_tfm *tfm)\r\n{\r\nconst char *alg;\r\nstruct crypto_cipher *fallback;\r\nstruct p8_aes_ctx *ctx = crypto_tfm_ctx(tfm);\r\nif (!(alg = crypto_tfm_alg_name(tfm))) {\r\nprintk(KERN_ERR "Failed to get algorithm name.\n");\r\nreturn -ENOENT;\r\n}\r\nfallback = crypto_alloc_cipher(alg, 0, CRYPTO_ALG_NEED_FALLBACK);\r\nif (IS_ERR(fallback)) {\r\nprintk(KERN_ERR\r\n"Failed to allocate transformation for '%s': %ld\n",\r\nalg, PTR_ERR(fallback));\r\nreturn PTR_ERR(fallback);\r\n}\r\nprintk(KERN_INFO "Using '%s' as fallback implementation.\n",\r\ncrypto_tfm_alg_driver_name((struct crypto_tfm *) fallback));\r\ncrypto_cipher_set_flags(fallback,\r\ncrypto_cipher_get_flags((struct\r\ncrypto_cipher *)\r\ntfm));\r\nctx->fallback = fallback;\r\nreturn 0;\r\n}\r\nstatic void p8_aes_exit(struct crypto_tfm *tfm)\r\n{\r\nstruct p8_aes_ctx *ctx = crypto_tfm_ctx(tfm);\r\nif (ctx->fallback) {\r\ncrypto_free_cipher(ctx->fallback);\r\nctx->fallback = NULL;\r\n}\r\n}\r\nstatic int p8_aes_setkey(struct crypto_tfm *tfm, const u8 *key,\r\nunsigned int keylen)\r\n{\r\nint ret;\r\nstruct p8_aes_ctx *ctx = crypto_tfm_ctx(tfm);\r\npreempt_disable();\r\npagefault_disable();\r\nenable_kernel_altivec();\r\nenable_kernel_vsx();\r\nret = aes_p8_set_encrypt_key(key, keylen * 8, &ctx->enc_key);\r\nret += aes_p8_set_decrypt_key(key, keylen * 8, &ctx->dec_key);\r\npagefault_enable();\r\npreempt_enable();\r\nret += crypto_cipher_setkey(ctx->fallback, key, keylen);\r\nreturn ret;\r\n}\r\nstatic void p8_aes_encrypt(struct crypto_tfm *tfm, u8 *dst, const u8 *src)\r\n{\r\nstruct p8_aes_ctx *ctx = crypto_tfm_ctx(tfm);\r\nif (in_interrupt()) {\r\ncrypto_cipher_encrypt_one(ctx->fallback, dst, src);\r\n} else {\r\npreempt_disable();\r\npagefault_disable();\r\nenable_kernel_altivec();\r\nenable_kernel_vsx();\r\naes_p8_encrypt(src, dst, &ctx->enc_key);\r\npagefault_enable();\r\npreempt_enable();\r\n}\r\n}\r\nstatic void p8_aes_decrypt(struct crypto_tfm *tfm, u8 *dst, const u8 *src)\r\n{\r\nstruct p8_aes_ctx *ctx = crypto_tfm_ctx(tfm);\r\nif (in_interrupt()) {\r\ncrypto_cipher_decrypt_one(ctx->fallback, dst, src);\r\n} else {\r\npreempt_disable();\r\npagefault_disable();\r\nenable_kernel_altivec();\r\nenable_kernel_vsx();\r\naes_p8_decrypt(src, dst, &ctx->dec_key);\r\npagefault_enable();\r\npreempt_enable();\r\n}\r\n}

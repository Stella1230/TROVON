static cycle_t vt8500_timer_read(struct clocksource *cs)\r\n{\r\nint loops = msecs_to_loops(10);\r\nwritel(3, regbase + TIMER_CTRL_VAL);\r\nwhile ((readl((regbase + TIMER_AS_VAL)) & TIMER_COUNT_R_ACTIVE)\r\n&& --loops)\r\ncpu_relax();\r\nreturn readl(regbase + TIMER_COUNT_VAL);\r\n}\r\nstatic int vt8500_timer_set_next_event(unsigned long cycles,\r\nstruct clock_event_device *evt)\r\n{\r\nint loops = msecs_to_loops(10);\r\ncycle_t alarm = clocksource.read(&clocksource) + cycles;\r\nwhile ((readl(regbase + TIMER_AS_VAL) & TIMER_MATCH_W_ACTIVE)\r\n&& --loops)\r\ncpu_relax();\r\nwritel((unsigned long)alarm, regbase + TIMER_MATCH_VAL);\r\nif ((signed)(alarm - clocksource.read(&clocksource)) <= 16)\r\nreturn -ETIME;\r\nwritel(1, regbase + TIMER_IER_VAL);\r\nreturn 0;\r\n}\r\nstatic int vt8500_shutdown(struct clock_event_device *evt)\r\n{\r\nwritel(readl(regbase + TIMER_CTRL_VAL) | 1, regbase + TIMER_CTRL_VAL);\r\nwritel(0, regbase + TIMER_IER_VAL);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t vt8500_timer_interrupt(int irq, void *dev_id)\r\n{\r\nstruct clock_event_device *evt = dev_id;\r\nwritel(0xf, regbase + TIMER_STATUS_VAL);\r\nevt->event_handler(evt);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void __init vt8500_timer_init(struct device_node *np)\r\n{\r\nint timer_irq;\r\nregbase = of_iomap(np, 0);\r\nif (!regbase) {\r\npr_err("%s: Missing iobase description in Device Tree\n",\r\n__func__);\r\nreturn;\r\n}\r\ntimer_irq = irq_of_parse_and_map(np, 0);\r\nif (!timer_irq) {\r\npr_err("%s: Missing irq description in Device Tree\n",\r\n__func__);\r\nreturn;\r\n}\r\nwritel(1, regbase + TIMER_CTRL_VAL);\r\nwritel(0xf, regbase + TIMER_STATUS_VAL);\r\nwritel(~0, regbase + TIMER_MATCH_VAL);\r\nif (clocksource_register_hz(&clocksource, VT8500_TIMER_HZ))\r\npr_err("%s: vt8500_timer_init: clocksource_register failed for %s\n",\r\n__func__, clocksource.name);\r\nclockevent.cpumask = cpumask_of(0);\r\nif (setup_irq(timer_irq, &irq))\r\npr_err("%s: setup_irq failed for %s\n", __func__,\r\nclockevent.name);\r\nclockevents_config_and_register(&clockevent, VT8500_TIMER_HZ,\r\n4, 0xf0000000);\r\n}

static int enh_desc_get_tx_status(void *data, struct stmmac_extra_stats *x,\r\nstruct dma_desc *p, void __iomem *ioaddr)\r\n{\r\nint ret = 0;\r\nstruct net_device_stats *stats = (struct net_device_stats *)data;\r\nif (unlikely(p->des01.etx.error_summary)) {\r\nif (unlikely(p->des01.etx.jabber_timeout))\r\nx->tx_jabber++;\r\nif (unlikely(p->des01.etx.frame_flushed)) {\r\nx->tx_frame_flushed++;\r\ndwmac_dma_flush_tx_fifo(ioaddr);\r\n}\r\nif (unlikely(p->des01.etx.loss_carrier)) {\r\nx->tx_losscarrier++;\r\nstats->tx_carrier_errors++;\r\n}\r\nif (unlikely(p->des01.etx.no_carrier)) {\r\nx->tx_carrier++;\r\nstats->tx_carrier_errors++;\r\n}\r\nif (unlikely(p->des01.etx.late_collision))\r\nstats->collisions += p->des01.etx.collision_count;\r\nif (unlikely(p->des01.etx.excessive_collisions))\r\nstats->collisions += p->des01.etx.collision_count;\r\nif (unlikely(p->des01.etx.excessive_deferral))\r\nx->tx_deferred++;\r\nif (unlikely(p->des01.etx.underflow_error)) {\r\ndwmac_dma_flush_tx_fifo(ioaddr);\r\nx->tx_underflow++;\r\n}\r\nif (unlikely(p->des01.etx.ip_header_error))\r\nx->tx_ip_header_error++;\r\nif (unlikely(p->des01.etx.payload_error)) {\r\nx->tx_payload_error++;\r\ndwmac_dma_flush_tx_fifo(ioaddr);\r\n}\r\nret = -1;\r\n}\r\nif (unlikely(p->des01.etx.deferred))\r\nx->tx_deferred++;\r\n#ifdef STMMAC_VLAN_TAG_USED\r\nif (p->des01.etx.vlan_frame)\r\nx->tx_vlan++;\r\n#endif\r\nreturn ret;\r\n}\r\nstatic int enh_desc_get_tx_len(struct dma_desc *p)\r\n{\r\nreturn p->des01.etx.buffer1_size;\r\n}\r\nstatic int enh_desc_coe_rdes0(int ipc_err, int type, int payload_err)\r\n{\r\nint ret = good_frame;\r\nu32 status = (type << 2 | ipc_err << 1 | payload_err) & 0x7;\r\nif (status == 0x0)\r\nret = llc_snap;\r\nelse if (status == 0x4)\r\nret = good_frame;\r\nelse if (status == 0x5)\r\nret = csum_none;\r\nelse if (status == 0x6)\r\nret = csum_none;\r\nelse if (status == 0x7)\r\nret = csum_none;\r\nelse if (status == 0x1)\r\nret = discard_frame;\r\nelse if (status == 0x3)\r\nret = discard_frame;\r\nreturn ret;\r\n}\r\nstatic void enh_desc_get_ext_status(void *data, struct stmmac_extra_stats *x,\r\nstruct dma_extended_desc *p)\r\n{\r\nif (unlikely(p->basic.des01.erx.rx_mac_addr)) {\r\nif (p->des4.erx.ip_hdr_err)\r\nx->ip_hdr_err++;\r\nif (p->des4.erx.ip_payload_err)\r\nx->ip_payload_err++;\r\nif (p->des4.erx.ip_csum_bypassed)\r\nx->ip_csum_bypassed++;\r\nif (p->des4.erx.ipv4_pkt_rcvd)\r\nx->ipv4_pkt_rcvd++;\r\nif (p->des4.erx.ipv6_pkt_rcvd)\r\nx->ipv6_pkt_rcvd++;\r\nif (p->des4.erx.msg_type == RDES_EXT_SYNC)\r\nx->rx_msg_type_sync++;\r\nelse if (p->des4.erx.msg_type == RDES_EXT_FOLLOW_UP)\r\nx->rx_msg_type_follow_up++;\r\nelse if (p->des4.erx.msg_type == RDES_EXT_DELAY_REQ)\r\nx->rx_msg_type_delay_req++;\r\nelse if (p->des4.erx.msg_type == RDES_EXT_DELAY_RESP)\r\nx->rx_msg_type_delay_resp++;\r\nelse if (p->des4.erx.msg_type == RDES_EXT_PDELAY_REQ)\r\nx->rx_msg_type_pdelay_req++;\r\nelse if (p->des4.erx.msg_type == RDES_EXT_PDELAY_RESP)\r\nx->rx_msg_type_pdelay_resp++;\r\nelse if (p->des4.erx.msg_type == RDES_EXT_PDELAY_FOLLOW_UP)\r\nx->rx_msg_type_pdelay_follow_up++;\r\nelse\r\nx->rx_msg_type_ext_no_ptp++;\r\nif (p->des4.erx.ptp_frame_type)\r\nx->ptp_frame_type++;\r\nif (p->des4.erx.ptp_ver)\r\nx->ptp_ver++;\r\nif (p->des4.erx.timestamp_dropped)\r\nx->timestamp_dropped++;\r\nif (p->des4.erx.av_pkt_rcvd)\r\nx->av_pkt_rcvd++;\r\nif (p->des4.erx.av_tagged_pkt_rcvd)\r\nx->av_tagged_pkt_rcvd++;\r\nif (p->des4.erx.vlan_tag_priority_val)\r\nx->vlan_tag_priority_val++;\r\nif (p->des4.erx.l3_filter_match)\r\nx->l3_filter_match++;\r\nif (p->des4.erx.l4_filter_match)\r\nx->l4_filter_match++;\r\nif (p->des4.erx.l3_l4_filter_no_match)\r\nx->l3_l4_filter_no_match++;\r\n}\r\n}\r\nstatic int enh_desc_get_rx_status(void *data, struct stmmac_extra_stats *x,\r\nstruct dma_desc *p)\r\n{\r\nint ret = good_frame;\r\nstruct net_device_stats *stats = (struct net_device_stats *)data;\r\nif (unlikely(p->des01.erx.error_summary)) {\r\nif (unlikely(p->des01.erx.descriptor_error)) {\r\nx->rx_desc++;\r\nstats->rx_length_errors++;\r\n}\r\nif (unlikely(p->des01.erx.overflow_error))\r\nx->rx_gmac_overflow++;\r\nif (unlikely(p->des01.erx.ipc_csum_error))\r\npr_err("\tIPC Csum Error/Giant frame\n");\r\nif (unlikely(p->des01.erx.late_collision)) {\r\nstats->collisions++;\r\n}\r\nif (unlikely(p->des01.erx.receive_watchdog))\r\nx->rx_watchdog++;\r\nif (unlikely(p->des01.erx.error_gmii))\r\nx->rx_mii++;\r\nif (unlikely(p->des01.erx.crc_error)) {\r\nx->rx_crc++;\r\nstats->rx_crc_errors++;\r\n}\r\nret = discard_frame;\r\n}\r\nret = enh_desc_coe_rdes0(p->des01.erx.ipc_csum_error,\r\np->des01.erx.frame_type, p->des01.erx.rx_mac_addr);\r\nif (unlikely(p->des01.erx.dribbling))\r\nx->dribbling_bit++;\r\nif (unlikely(p->des01.erx.sa_filter_fail)) {\r\nx->sa_rx_filter_fail++;\r\nret = discard_frame;\r\n}\r\nif (unlikely(p->des01.erx.da_filter_fail)) {\r\nx->da_rx_filter_fail++;\r\nret = discard_frame;\r\n}\r\nif (unlikely(p->des01.erx.length_error)) {\r\nx->rx_length++;\r\nret = discard_frame;\r\n}\r\n#ifdef STMMAC_VLAN_TAG_USED\r\nif (p->des01.erx.vlan_tag)\r\nx->rx_vlan++;\r\n#endif\r\nreturn ret;\r\n}\r\nstatic void enh_desc_init_rx_desc(struct dma_desc *p, int disable_rx_ic,\r\nint mode, int end)\r\n{\r\np->des01.all_flags = 0;\r\np->des01.erx.own = 1;\r\np->des01.erx.buffer1_size = BUF_SIZE_8KiB - 1;\r\nif (mode == STMMAC_CHAIN_MODE)\r\nehn_desc_rx_set_on_chain(p, end);\r\nelse\r\nehn_desc_rx_set_on_ring(p, end);\r\nif (disable_rx_ic)\r\np->des01.erx.disable_ic = 1;\r\n}\r\nstatic void enh_desc_init_tx_desc(struct dma_desc *p, int mode, int end)\r\n{\r\np->des01.all_flags = 0;\r\nif (mode == STMMAC_CHAIN_MODE)\r\nehn_desc_tx_set_on_chain(p, end);\r\nelse\r\nehn_desc_tx_set_on_ring(p, end);\r\n}\r\nstatic int enh_desc_get_tx_owner(struct dma_desc *p)\r\n{\r\nreturn p->des01.etx.own;\r\n}\r\nstatic int enh_desc_get_rx_owner(struct dma_desc *p)\r\n{\r\nreturn p->des01.erx.own;\r\n}\r\nstatic void enh_desc_set_tx_owner(struct dma_desc *p)\r\n{\r\np->des01.etx.own = 1;\r\n}\r\nstatic void enh_desc_set_rx_owner(struct dma_desc *p)\r\n{\r\np->des01.erx.own = 1;\r\n}\r\nstatic int enh_desc_get_tx_ls(struct dma_desc *p)\r\n{\r\nreturn p->des01.etx.last_segment;\r\n}\r\nstatic void enh_desc_release_tx_desc(struct dma_desc *p, int mode)\r\n{\r\nint ter = p->des01.etx.end_ring;\r\nmemset(p, 0, offsetof(struct dma_desc, des2));\r\nif (mode == STMMAC_CHAIN_MODE)\r\nenh_desc_end_tx_desc_on_chain(p, ter);\r\nelse\r\nenh_desc_end_tx_desc_on_ring(p, ter);\r\n}\r\nstatic void enh_desc_prepare_tx_desc(struct dma_desc *p, int is_fs, int len,\r\nint csum_flag, int mode)\r\n{\r\np->des01.etx.first_segment = is_fs;\r\nif (mode == STMMAC_CHAIN_MODE)\r\nenh_set_tx_desc_len_on_chain(p, len);\r\nelse\r\nenh_set_tx_desc_len_on_ring(p, len);\r\nif (likely(csum_flag))\r\np->des01.etx.checksum_insertion = cic_full;\r\n}\r\nstatic void enh_desc_clear_tx_ic(struct dma_desc *p)\r\n{\r\np->des01.etx.interrupt = 0;\r\n}\r\nstatic void enh_desc_close_tx_desc(struct dma_desc *p)\r\n{\r\np->des01.etx.last_segment = 1;\r\np->des01.etx.interrupt = 1;\r\n}\r\nstatic int enh_desc_get_rx_frame_len(struct dma_desc *p, int rx_coe_type)\r\n{\r\nif (rx_coe_type == STMMAC_RX_COE_TYPE1)\r\nreturn p->des01.erx.frame_length - 2;\r\nelse\r\nreturn p->des01.erx.frame_length;\r\n}\r\nstatic void enh_desc_enable_tx_timestamp(struct dma_desc *p)\r\n{\r\np->des01.etx.time_stamp_enable = 1;\r\n}\r\nstatic int enh_desc_get_tx_timestamp_status(struct dma_desc *p)\r\n{\r\nreturn p->des01.etx.time_stamp_status;\r\n}\r\nstatic u64 enh_desc_get_timestamp(void *desc, u32 ats)\r\n{\r\nu64 ns;\r\nif (ats) {\r\nstruct dma_extended_desc *p = (struct dma_extended_desc *)desc;\r\nns = p->des6;\r\nns += p->des7 * 1000000000ULL;\r\n} else {\r\nstruct dma_desc *p = (struct dma_desc *)desc;\r\nns = p->des2;\r\nns += p->des3 * 1000000000ULL;\r\n}\r\nreturn ns;\r\n}\r\nstatic int enh_desc_get_rx_timestamp_status(void *desc, u32 ats)\r\n{\r\nif (ats) {\r\nstruct dma_extended_desc *p = (struct dma_extended_desc *)desc;\r\nreturn p->basic.des01.erx.ipc_csum_error;\r\n} else {\r\nstruct dma_desc *p = (struct dma_desc *)desc;\r\nif ((p->des2 == 0xffffffff) && (p->des3 == 0xffffffff))\r\nreturn 0;\r\nelse\r\nreturn 1;\r\n}\r\n}

static void i2c_wait_for_writes(struct qib_devdata *dd)\r\n{\r\ndd->f_gpio_mod(dd, 0, 0, 0);\r\nrmb();\r\n}\r\nstatic void scl_out(struct qib_devdata *dd, u8 bit)\r\n{\r\nu32 mask;\r\nudelay(1);\r\nmask = 1UL << dd->gpio_scl_num;\r\ndd->f_gpio_mod(dd, 0, bit ? 0 : mask, mask);\r\nif (!bit)\r\nudelay(2);\r\nelse {\r\nint rise_usec;\r\nfor (rise_usec = SCL_WAIT_USEC; rise_usec > 0; rise_usec -= 2) {\r\nif (mask & dd->f_gpio_mod(dd, 0, 0, 0))\r\nbreak;\r\nudelay(2);\r\n}\r\nif (rise_usec <= 0)\r\nqib_dev_err(dd, "SCL interface stuck low > %d uSec\n",\r\nSCL_WAIT_USEC);\r\n}\r\ni2c_wait_for_writes(dd);\r\n}\r\nstatic void sda_out(struct qib_devdata *dd, u8 bit)\r\n{\r\nu32 mask;\r\nmask = 1UL << dd->gpio_sda_num;\r\ndd->f_gpio_mod(dd, 0, bit ? 0 : mask, mask);\r\ni2c_wait_for_writes(dd);\r\nudelay(2);\r\n}\r\nstatic u8 sda_in(struct qib_devdata *dd, int wait)\r\n{\r\nint bnum;\r\nu32 read_val, mask;\r\nbnum = dd->gpio_sda_num;\r\nmask = (1UL << bnum);\r\ndd->f_gpio_mod(dd, 0, 0, mask);\r\nread_val = dd->f_gpio_mod(dd, 0, 0, 0);\r\nif (wait)\r\ni2c_wait_for_writes(dd);\r\nreturn (read_val & mask) >> bnum;\r\n}\r\nstatic int i2c_ackrcv(struct qib_devdata *dd)\r\n{\r\nu8 ack_received;\r\nack_received = sda_in(dd, 1);\r\nscl_out(dd, 1);\r\nack_received = sda_in(dd, 1) == 0;\r\nscl_out(dd, 0);\r\nreturn ack_received;\r\n}\r\nstatic int rd_byte(struct qib_devdata *dd, int last)\r\n{\r\nint bit_cntr, data;\r\ndata = 0;\r\nfor (bit_cntr = 7; bit_cntr >= 0; --bit_cntr) {\r\ndata <<= 1;\r\nscl_out(dd, 1);\r\ndata |= sda_in(dd, 0);\r\nscl_out(dd, 0);\r\n}\r\nif (last) {\r\nscl_out(dd, 1);\r\nstop_cmd(dd);\r\n} else {\r\nsda_out(dd, 0);\r\nscl_out(dd, 1);\r\nscl_out(dd, 0);\r\nsda_out(dd, 1);\r\n}\r\nreturn data;\r\n}\r\nstatic int wr_byte(struct qib_devdata *dd, u8 data)\r\n{\r\nint bit_cntr;\r\nu8 bit;\r\nfor (bit_cntr = 7; bit_cntr >= 0; bit_cntr--) {\r\nbit = (data >> bit_cntr) & 1;\r\nsda_out(dd, bit);\r\nscl_out(dd, 1);\r\nscl_out(dd, 0);\r\n}\r\nreturn (!i2c_ackrcv(dd)) ? 1 : 0;\r\n}\r\nstatic void start_seq(struct qib_devdata *dd)\r\n{\r\nsda_out(dd, 1);\r\nscl_out(dd, 1);\r\nsda_out(dd, 0);\r\nudelay(1);\r\nscl_out(dd, 0);\r\n}\r\nstatic void stop_seq(struct qib_devdata *dd)\r\n{\r\nscl_out(dd, 0);\r\nsda_out(dd, 0);\r\nscl_out(dd, 1);\r\nsda_out(dd, 1);\r\n}\r\nstatic void stop_cmd(struct qib_devdata *dd)\r\n{\r\nstop_seq(dd);\r\nudelay(TWSI_BUF_WAIT_USEC);\r\n}\r\nint qib_twsi_reset(struct qib_devdata *dd)\r\n{\r\nint clock_cycles_left = 9;\r\nint was_high = 0;\r\nu32 pins, mask;\r\nmask = (1UL << dd->gpio_scl_num) | (1UL << dd->gpio_sda_num);\r\ndd->f_gpio_mod(dd, 0, 0, mask);\r\nwhile (clock_cycles_left--) {\r\nscl_out(dd, 0);\r\nscl_out(dd, 1);\r\nwas_high |= sda_in(dd, 0);\r\n}\r\nif (was_high) {\r\npins = dd->f_gpio_mod(dd, 0, 0, 0);\r\nif ((pins & mask) != mask)\r\nqib_dev_err(dd, "GPIO pins not at rest: %d\n",\r\npins & mask);\r\nudelay(1);\r\nsda_out(dd, 0);\r\nudelay(1);\r\nsda_out(dd, 1);\r\nudelay(TWSI_BUF_WAIT_USEC);\r\n}\r\nreturn !was_high;\r\n}\r\nstatic int qib_twsi_wr(struct qib_devdata *dd, int data, int flags)\r\n{\r\nint ret = 1;\r\nif (flags & QIB_TWSI_START)\r\nstart_seq(dd);\r\nret = wr_byte(dd, data);\r\nif (flags & QIB_TWSI_STOP)\r\nstop_cmd(dd);\r\nreturn ret;\r\n}\r\nint qib_twsi_blk_rd(struct qib_devdata *dd, int dev, int addr,\r\nvoid *buffer, int len)\r\n{\r\nint ret;\r\nu8 *bp = buffer;\r\nret = 1;\r\nif (dev == QIB_TWSI_NO_DEV) {\r\naddr = (addr << 1) | READ_CMD;\r\nret = qib_twsi_wr(dd, addr, QIB_TWSI_START);\r\n} else {\r\nret = qib_twsi_wr(dd, dev | WRITE_CMD, QIB_TWSI_START);\r\nif (ret) {\r\nstop_cmd(dd);\r\nret = 1;\r\ngoto bail;\r\n}\r\nret = qib_twsi_wr(dd, addr, 0);\r\nudelay(TWSI_BUF_WAIT_USEC);\r\nif (ret) {\r\nqib_dev_err(dd,\r\n"Failed to write interface read addr %02X\n",\r\naddr);\r\nret = 1;\r\ngoto bail;\r\n}\r\nret = qib_twsi_wr(dd, dev | READ_CMD, QIB_TWSI_START);\r\n}\r\nif (ret) {\r\nstop_cmd(dd);\r\nret = 1;\r\ngoto bail;\r\n}\r\nwhile (len-- > 0) {\r\n*bp++ = rd_byte(dd, !len);\r\n}\r\nret = 0;\r\nbail:\r\nreturn ret;\r\n}\r\nint qib_twsi_blk_wr(struct qib_devdata *dd, int dev, int addr,\r\nconst void *buffer, int len)\r\n{\r\nint sub_len;\r\nconst u8 *bp = buffer;\r\nint max_wait_time, i;\r\nint ret = 1;\r\nwhile (len > 0) {\r\nif (dev == QIB_TWSI_NO_DEV) {\r\nif (qib_twsi_wr(dd, (addr << 1) | WRITE_CMD,\r\nQIB_TWSI_START)) {\r\ngoto failed_write;\r\n}\r\n} else {\r\nif (qib_twsi_wr(dd, dev | WRITE_CMD, QIB_TWSI_START))\r\ngoto failed_write;\r\nret = qib_twsi_wr(dd, addr, 0);\r\nif (ret) {\r\nqib_dev_err(dd,\r\n"Failed to write interface write addr %02X\n",\r\naddr);\r\ngoto failed_write;\r\n}\r\n}\r\nsub_len = min(len, 4);\r\naddr += sub_len;\r\nlen -= sub_len;\r\nfor (i = 0; i < sub_len; i++)\r\nif (qib_twsi_wr(dd, *bp++, 0))\r\ngoto failed_write;\r\nstop_cmd(dd);\r\nmax_wait_time = 100;\r\nwhile (qib_twsi_wr(dd, dev | READ_CMD, QIB_TWSI_START)) {\r\nstop_cmd(dd);\r\nif (!--max_wait_time)\r\ngoto failed_write;\r\n}\r\nrd_byte(dd, 1);\r\n}\r\nret = 0;\r\ngoto bail;\r\nfailed_write:\r\nstop_cmd(dd);\r\nret = 1;\r\nbail:\r\nreturn ret;\r\n}

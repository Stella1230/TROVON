static inline u32 tfrc_binsearch(u32 fval, u8 small)\r\n{\r\nu32 try, low = 0, high = TFRC_CALC_X_ARRSIZE - 1;\r\nwhile (low < high) {\r\ntry = (low + high) / 2;\r\nif (fval <= tfrc_calc_x_lookup[try][small])\r\nhigh = try;\r\nelse\r\nlow = try + 1;\r\n}\r\nreturn high;\r\n}\r\nu32 tfrc_calc_x(u16 s, u32 R, u32 p)\r\n{\r\nu16 index;\r\nu32 f;\r\nu64 result;\r\nBUG_ON(p > 1000000);\r\nBUG_ON(p == 0);\r\nif (R == 0) {\r\nDCCP_CRIT("WARNING: RTT is 0, returning maximum X_calc.");\r\nreturn ~0U;\r\n}\r\nif (p <= TFRC_CALC_X_SPLIT) {\r\nif (p < TFRC_SMALLEST_P) {\r\nDCCP_WARN("Value of p (%d) below resolution. "\r\n"Substituting %d\n", p, TFRC_SMALLEST_P);\r\nindex = 0;\r\n} else\r\nindex = p/TFRC_SMALLEST_P - 1;\r\nf = tfrc_calc_x_lookup[index][1];\r\n} else {\r\nindex = p/(1000000/TFRC_CALC_X_ARRSIZE) - 1;\r\nf = tfrc_calc_x_lookup[index][0];\r\n}\r\nresult = scaled_div(s, R);\r\nreturn scaled_div32(result, f);\r\n}\r\nu32 tfrc_calc_x_reverse_lookup(u32 fvalue)\r\n{\r\nint index;\r\nif (fvalue == 0)\r\nreturn 0;\r\nif (fvalue < tfrc_calc_x_lookup[0][1]) {\r\nDCCP_WARN("fvalue %u smaller than resolution\n", fvalue);\r\nreturn TFRC_SMALLEST_P;\r\n}\r\nif (fvalue > tfrc_calc_x_lookup[TFRC_CALC_X_ARRSIZE - 1][0]) {\r\nDCCP_WARN("fvalue %u exceeds bounds!\n", fvalue);\r\nreturn 1000000;\r\n}\r\nif (fvalue <= tfrc_calc_x_lookup[TFRC_CALC_X_ARRSIZE - 1][1]) {\r\nindex = tfrc_binsearch(fvalue, 1);\r\nreturn (index + 1) * TFRC_CALC_X_SPLIT / TFRC_CALC_X_ARRSIZE;\r\n}\r\nindex = tfrc_binsearch(fvalue, 0);\r\nreturn (index + 1) * 1000000 / TFRC_CALC_X_ARRSIZE;\r\n}\r\nu32 tfrc_invert_loss_event_rate(u32 loss_event_rate)\r\n{\r\nif (loss_event_rate == UINT_MAX)\r\nreturn 0;\r\nif (unlikely(loss_event_rate == 0))\r\nreturn 1000000;\r\nreturn max_t(u32, scaled_div(1, loss_event_rate), TFRC_SMALLEST_P);\r\n}

static int versatile_reboot(struct notifier_block *this, unsigned long mode,\r\nvoid *cmd)\r\n{\r\nswitch (versatile_reboot_type) {\r\ncase INTEGRATOR_REBOOT_CM:\r\nregmap_write(syscon_regmap, INTEGRATOR_HDR_LOCK_OFFSET,\r\nVERSATILE_LOCK_VAL);\r\nregmap_update_bits(syscon_regmap,\r\nINTEGRATOR_HDR_CTRL_OFFSET,\r\nINTEGRATOR_CM_CTRL_RESET,\r\nINTEGRATOR_CM_CTRL_RESET);\r\nbreak;\r\ncase REALVIEW_REBOOT_EB:\r\nregmap_write(syscon_regmap, REALVIEW_SYS_LOCK_OFFSET,\r\nVERSATILE_LOCK_VAL);\r\nregmap_write(syscon_regmap,\r\nREALVIEW_SYS_RESETCTL_OFFSET, 0x0008);\r\nbreak;\r\ncase REALVIEW_REBOOT_PB1176:\r\nregmap_write(syscon_regmap, REALVIEW_SYS_LOCK_OFFSET,\r\nVERSATILE_LOCK_VAL);\r\nregmap_write(syscon_regmap,\r\nREALVIEW_SYS_RESETCTL_OFFSET, 0x0100);\r\nbreak;\r\ncase REALVIEW_REBOOT_PB11MP:\r\ncase REALVIEW_REBOOT_PBA8:\r\nregmap_write(syscon_regmap, REALVIEW_SYS_LOCK_OFFSET,\r\nVERSATILE_LOCK_VAL);\r\nregmap_write(syscon_regmap, REALVIEW_SYS_RESETCTL_OFFSET,\r\n0x0000);\r\nregmap_write(syscon_regmap, REALVIEW_SYS_RESETCTL_OFFSET,\r\n0x0004);\r\nbreak;\r\ncase REALVIEW_REBOOT_PBX:\r\nregmap_write(syscon_regmap, REALVIEW_SYS_LOCK_OFFSET,\r\nVERSATILE_LOCK_VAL);\r\nregmap_write(syscon_regmap, REALVIEW_SYS_RESETCTL_OFFSET,\r\n0x00f0);\r\nregmap_write(syscon_regmap, REALVIEW_SYS_RESETCTL_OFFSET,\r\n0x00f4);\r\nbreak;\r\n}\r\ndsb();\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int __init versatile_reboot_probe(void)\r\n{\r\nconst struct of_device_id *reboot_id;\r\nstruct device_node *np;\r\nint err;\r\nnp = of_find_matching_node_and_match(NULL, versatile_reboot_of_match,\r\n&reboot_id);\r\nif (!np)\r\nreturn -ENODEV;\r\nversatile_reboot_type = (enum versatile_reboot)reboot_id->data;\r\nsyscon_regmap = syscon_node_to_regmap(np);\r\nif (IS_ERR(syscon_regmap))\r\nreturn PTR_ERR(syscon_regmap);\r\nerr = register_restart_handler(&versatile_reboot_nb);\r\nif (err)\r\nreturn err;\r\npr_info("versatile reboot driver registered\n");\r\nreturn 0;\r\n}

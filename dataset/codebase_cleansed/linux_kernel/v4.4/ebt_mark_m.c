static bool\r\nebt_mark_mt(const struct sk_buff *skb, struct xt_action_param *par)\r\n{\r\nconst struct ebt_mark_m_info *info = par->matchinfo;\r\nif (info->bitmask & EBT_MARK_OR)\r\nreturn !!(skb->mark & info->mask) ^ info->invert;\r\nreturn ((skb->mark & info->mask) == info->mark) ^ info->invert;\r\n}\r\nstatic int ebt_mark_mt_check(const struct xt_mtchk_param *par)\r\n{\r\nconst struct ebt_mark_m_info *info = par->matchinfo;\r\nif (info->bitmask & ~EBT_MARK_MASK)\r\nreturn -EINVAL;\r\nif ((info->bitmask & EBT_MARK_OR) && (info->bitmask & EBT_MARK_AND))\r\nreturn -EINVAL;\r\nif (!info->bitmask)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic void mark_mt_compat_from_user(void *dst, const void *src)\r\n{\r\nconst struct compat_ebt_mark_m_info *user = src;\r\nstruct ebt_mark_m_info *kern = dst;\r\nkern->mark = user->mark;\r\nkern->mask = user->mask;\r\nkern->invert = user->invert;\r\nkern->bitmask = user->bitmask;\r\n}\r\nstatic int mark_mt_compat_to_user(void __user *dst, const void *src)\r\n{\r\nstruct compat_ebt_mark_m_info __user *user = dst;\r\nconst struct ebt_mark_m_info *kern = src;\r\nif (put_user(kern->mark, &user->mark) ||\r\nput_user(kern->mask, &user->mask) ||\r\nput_user(kern->invert, &user->invert) ||\r\nput_user(kern->bitmask, &user->bitmask))\r\nreturn -EFAULT;\r\nreturn 0;\r\n}\r\nstatic int __init ebt_mark_m_init(void)\r\n{\r\nreturn xt_register_match(&ebt_mark_mt_reg);\r\n}\r\nstatic void __exit ebt_mark_m_fini(void)\r\n{\r\nxt_unregister_match(&ebt_mark_mt_reg);\r\n}

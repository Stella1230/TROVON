void update_vsyscall_tz(void)\r\n{\r\nvsyscall_gtod_data.tz_minuteswest = sys_tz.tz_minuteswest;\r\nvsyscall_gtod_data.tz_dsttime = sys_tz.tz_dsttime;\r\n}\r\nvoid update_vsyscall(struct timekeeper *tk)\r\n{\r\nstruct vsyscall_gtod_data *vdata = &vsyscall_gtod_data;\r\ngtod_write_begin(vdata);\r\nvdata->vclock_mode = tk->tkr_mono.clock->archdata.vclock_mode;\r\nvdata->cycle_last = tk->tkr_mono.cycle_last;\r\nvdata->mask = tk->tkr_mono.mask;\r\nvdata->mult = tk->tkr_mono.mult;\r\nvdata->shift = tk->tkr_mono.shift;\r\nvdata->wall_time_sec = tk->xtime_sec;\r\nvdata->wall_time_snsec = tk->tkr_mono.xtime_nsec;\r\nvdata->monotonic_time_sec = tk->xtime_sec\r\n+ tk->wall_to_monotonic.tv_sec;\r\nvdata->monotonic_time_snsec = tk->tkr_mono.xtime_nsec\r\n+ ((u64)tk->wall_to_monotonic.tv_nsec\r\n<< tk->tkr_mono.shift);\r\nwhile (vdata->monotonic_time_snsec >=\r\n(((u64)NSEC_PER_SEC) << tk->tkr_mono.shift)) {\r\nvdata->monotonic_time_snsec -=\r\n((u64)NSEC_PER_SEC) << tk->tkr_mono.shift;\r\nvdata->monotonic_time_sec++;\r\n}\r\nvdata->wall_time_coarse_sec = tk->xtime_sec;\r\nvdata->wall_time_coarse_nsec = (long)(tk->tkr_mono.xtime_nsec >>\r\ntk->tkr_mono.shift);\r\nvdata->monotonic_time_coarse_sec =\r\nvdata->wall_time_coarse_sec + tk->wall_to_monotonic.tv_sec;\r\nvdata->monotonic_time_coarse_nsec =\r\nvdata->wall_time_coarse_nsec + tk->wall_to_monotonic.tv_nsec;\r\nwhile (vdata->monotonic_time_coarse_nsec >= NSEC_PER_SEC) {\r\nvdata->monotonic_time_coarse_nsec -= NSEC_PER_SEC;\r\nvdata->monotonic_time_coarse_sec++;\r\n}\r\ngtod_write_end(vdata);\r\n}

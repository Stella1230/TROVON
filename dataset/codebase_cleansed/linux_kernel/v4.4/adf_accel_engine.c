int adf_ae_fw_load(struct adf_accel_dev *accel_dev)\r\n{\r\nstruct adf_fw_loader_data *loader_data = accel_dev->fw_loader;\r\nstruct adf_hw_device_data *hw_device = accel_dev->hw_device;\r\nvoid *uof_addr, *mmp_addr;\r\nu32 uof_size, mmp_size;\r\nif (!hw_device->fw_name)\r\nreturn 0;\r\nif (request_firmware(&loader_data->mmp_fw, hw_device->fw_mmp_name,\r\n&accel_dev->accel_pci_dev.pci_dev->dev)) {\r\ndev_err(&GET_DEV(accel_dev), "Failed to load MMP firmware %s\n",\r\nhw_device->fw_mmp_name);\r\nreturn -EFAULT;\r\n}\r\nif (request_firmware(&loader_data->uof_fw, hw_device->fw_name,\r\n&accel_dev->accel_pci_dev.pci_dev->dev)) {\r\ndev_err(&GET_DEV(accel_dev), "Failed to load UOF firmware %s\n",\r\nhw_device->fw_name);\r\ngoto out_err;\r\n}\r\nuof_size = loader_data->uof_fw->size;\r\nuof_addr = (void *)loader_data->uof_fw->data;\r\nmmp_size = loader_data->mmp_fw->size;\r\nmmp_addr = (void *)loader_data->mmp_fw->data;\r\nqat_uclo_wr_mimage(loader_data->fw_loader, mmp_addr, mmp_size);\r\nif (qat_uclo_map_uof_obj(loader_data->fw_loader, uof_addr, uof_size)) {\r\ndev_err(&GET_DEV(accel_dev), "Failed to map UOF\n");\r\ngoto out_err;\r\n}\r\nif (qat_uclo_wr_all_uimage(loader_data->fw_loader)) {\r\ndev_err(&GET_DEV(accel_dev), "Failed to load UOF\n");\r\ngoto out_err;\r\n}\r\nreturn 0;\r\nout_err:\r\nadf_ae_fw_release(accel_dev);\r\nreturn -EFAULT;\r\n}\r\nvoid adf_ae_fw_release(struct adf_accel_dev *accel_dev)\r\n{\r\nstruct adf_fw_loader_data *loader_data = accel_dev->fw_loader;\r\nstruct adf_hw_device_data *hw_device = accel_dev->hw_device;\r\nif (!hw_device->fw_name)\r\nreturn;\r\nqat_uclo_del_uof_obj(loader_data->fw_loader);\r\nqat_hal_deinit(loader_data->fw_loader);\r\nrelease_firmware(loader_data->uof_fw);\r\nrelease_firmware(loader_data->mmp_fw);\r\nloader_data->uof_fw = NULL;\r\nloader_data->mmp_fw = NULL;\r\nloader_data->fw_loader = NULL;\r\n}\r\nint adf_ae_start(struct adf_accel_dev *accel_dev)\r\n{\r\nstruct adf_fw_loader_data *loader_data = accel_dev->fw_loader;\r\nstruct adf_hw_device_data *hw_data = accel_dev->hw_device;\r\nuint32_t ae_ctr, ae, max_aes = GET_MAX_ACCELENGINES(accel_dev);\r\nif (!hw_data->fw_name)\r\nreturn 0;\r\nfor (ae = 0, ae_ctr = 0; ae < max_aes; ae++) {\r\nif (hw_data->ae_mask & (1 << ae)) {\r\nqat_hal_start(loader_data->fw_loader, ae, 0xFF);\r\nae_ctr++;\r\n}\r\n}\r\ndev_info(&GET_DEV(accel_dev),\r\n"qat_dev%d started %d acceleration engines\n",\r\naccel_dev->accel_id, ae_ctr);\r\nreturn 0;\r\n}\r\nint adf_ae_stop(struct adf_accel_dev *accel_dev)\r\n{\r\nstruct adf_fw_loader_data *loader_data = accel_dev->fw_loader;\r\nstruct adf_hw_device_data *hw_data = accel_dev->hw_device;\r\nuint32_t ae_ctr, ae, max_aes = GET_MAX_ACCELENGINES(accel_dev);\r\nif (!hw_data->fw_name)\r\nreturn 0;\r\nfor (ae = 0, ae_ctr = 0; ae < max_aes; ae++) {\r\nif (hw_data->ae_mask & (1 << ae)) {\r\nqat_hal_stop(loader_data->fw_loader, ae, 0xFF);\r\nae_ctr++;\r\n}\r\n}\r\ndev_info(&GET_DEV(accel_dev),\r\n"qat_dev%d stopped %d acceleration engines\n",\r\naccel_dev->accel_id, ae_ctr);\r\nreturn 0;\r\n}\r\nstatic int adf_ae_reset(struct adf_accel_dev *accel_dev, int ae)\r\n{\r\nstruct adf_fw_loader_data *loader_data = accel_dev->fw_loader;\r\nqat_hal_reset(loader_data->fw_loader);\r\nif (qat_hal_clr_reset(loader_data->fw_loader))\r\nreturn -EFAULT;\r\nreturn 0;\r\n}\r\nint adf_ae_init(struct adf_accel_dev *accel_dev)\r\n{\r\nstruct adf_fw_loader_data *loader_data;\r\nstruct adf_hw_device_data *hw_device = accel_dev->hw_device;\r\nif (!hw_device->fw_name)\r\nreturn 0;\r\nloader_data = kzalloc(sizeof(*loader_data), GFP_KERNEL);\r\nif (!loader_data)\r\nreturn -ENOMEM;\r\naccel_dev->fw_loader = loader_data;\r\nif (qat_hal_init(accel_dev)) {\r\ndev_err(&GET_DEV(accel_dev), "Failed to init the AEs\n");\r\nkfree(loader_data);\r\nreturn -EFAULT;\r\n}\r\nif (adf_ae_reset(accel_dev, 0)) {\r\ndev_err(&GET_DEV(accel_dev), "Failed to reset the AEs\n");\r\nqat_hal_deinit(loader_data->fw_loader);\r\nkfree(loader_data);\r\nreturn -EFAULT;\r\n}\r\nreturn 0;\r\n}\r\nint adf_ae_shutdown(struct adf_accel_dev *accel_dev)\r\n{\r\nstruct adf_fw_loader_data *loader_data = accel_dev->fw_loader;\r\nstruct adf_hw_device_data *hw_device = accel_dev->hw_device;\r\nif (!hw_device->fw_name)\r\nreturn 0;\r\nqat_hal_deinit(loader_data->fw_loader);\r\nkfree(accel_dev->fw_loader);\r\naccel_dev->fw_loader = NULL;\r\nreturn 0;\r\n}

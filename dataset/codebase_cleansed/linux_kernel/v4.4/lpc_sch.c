static int lpc_sch_get_io(struct pci_dev *pdev, int where, const char *name,\r\nstruct resource *res, int size)\r\n{\r\nunsigned int base_addr_cfg;\r\nunsigned short base_addr;\r\nif (size == 0)\r\nreturn LPC_NO_RESOURCE;\r\npci_read_config_dword(pdev, where, &base_addr_cfg);\r\nbase_addr = 0;\r\nif (!(base_addr_cfg & (1 << 31)))\r\ndev_warn(&pdev->dev, "Decode of the %s I/O range disabled\n",\r\nname);\r\nelse\r\nbase_addr = (unsigned short)base_addr_cfg;\r\nif (base_addr == 0) {\r\ndev_warn(&pdev->dev, "I/O space for %s uninitialized\n", name);\r\nreturn LPC_SKIP_RESOURCE;\r\n}\r\nres->start = base_addr;\r\nres->end = base_addr + size - 1;\r\nres->flags = IORESOURCE_IO;\r\nreturn 0;\r\n}\r\nstatic int lpc_sch_populate_cell(struct pci_dev *pdev, int where,\r\nconst char *name, int size, int irq,\r\nint id, struct mfd_cell *cell)\r\n{\r\nstruct resource *res;\r\nint ret;\r\nres = devm_kcalloc(&pdev->dev, 2, sizeof(*res), GFP_KERNEL);\r\nif (!res)\r\nreturn -ENOMEM;\r\nret = lpc_sch_get_io(pdev, where, name, res, size);\r\nif (ret)\r\nreturn ret;\r\nmemset(cell, 0, sizeof(*cell));\r\ncell->name = name;\r\ncell->resources = res;\r\ncell->num_resources = 1;\r\ncell->ignore_resource_conflicts = true;\r\ncell->id = id;\r\nif (irq < 0)\r\nreturn 0;\r\nres++;\r\nres->start = irq;\r\nres->end = irq;\r\nres->flags = IORESOURCE_IRQ;\r\ncell->num_resources++;\r\nreturn 0;\r\n}\r\nstatic int lpc_sch_probe(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nstruct mfd_cell lpc_sch_cells[3];\r\nstruct lpc_sch_info *info = &sch_chipset_info[id->driver_data];\r\nunsigned int cells = 0;\r\nint ret;\r\nret = lpc_sch_populate_cell(dev, SMBASE, "isch_smbus",\r\ninfo->io_size_smbus, -1,\r\nid->device, &lpc_sch_cells[cells]);\r\nif (ret < 0)\r\nreturn ret;\r\nif (ret == 0)\r\ncells++;\r\nret = lpc_sch_populate_cell(dev, GPIOBASE, "sch_gpio",\r\ninfo->io_size_gpio, info->irq_gpio,\r\nid->device, &lpc_sch_cells[cells]);\r\nif (ret < 0)\r\nreturn ret;\r\nif (ret == 0)\r\ncells++;\r\nret = lpc_sch_populate_cell(dev, WDTBASE, "ie6xx_wdt",\r\ninfo->io_size_wdt, -1,\r\nid->device, &lpc_sch_cells[cells]);\r\nif (ret < 0)\r\nreturn ret;\r\nif (ret == 0)\r\ncells++;\r\nif (cells == 0) {\r\ndev_err(&dev->dev, "All decode registers disabled.\n");\r\nreturn -ENODEV;\r\n}\r\nreturn mfd_add_devices(&dev->dev, 0, lpc_sch_cells, cells, NULL, 0, NULL);\r\n}\r\nstatic void lpc_sch_remove(struct pci_dev *dev)\r\n{\r\nmfd_remove_devices(&dev->dev);\r\n}

static void __init m53xx_clk_init(void)\r\n{\r\nunsigned i;\r\nfor (i = 0; i < ARRAY_SIZE(enable_clks); ++i)\r\n__clk_init_enabled(enable_clks[i]);\r\nfor (i = 0; i < ARRAY_SIZE(disable_clks); ++i)\r\n__clk_init_disabled(disable_clks[i]);\r\n}\r\nstatic void __init m53xx_qspi_init(void)\r\n{\r\n#if IS_ENABLED(CONFIG_SPI_COLDFIRE_QSPI)\r\nwritew(0x01f0, MCFGPIO_PAR_QSPI);\r\n#endif\r\n}\r\nstatic void __init m53xx_uarts_init(void)\r\n{\r\nwritew(readw(MCFGPIO_PAR_UART) | 0x0FFF, MCFGPIO_PAR_UART);\r\n}\r\nstatic void __init m53xx_fec_init(void)\r\n{\r\nu8 v;\r\nv = readb(MCFGPIO_PAR_FECI2C);\r\nv |= MCF_GPIO_PAR_FECI2C_PAR_MDC_EMDC |\r\nMCF_GPIO_PAR_FECI2C_PAR_MDIO_EMDIO;\r\nwriteb(v, MCFGPIO_PAR_FECI2C);\r\nv = readb(MCFGPIO_PAR_FEC);\r\nv = MCF_GPIO_PAR_FEC_PAR_FEC_7W_FEC | MCF_GPIO_PAR_FEC_PAR_FEC_MII_FEC;\r\nwriteb(v, MCFGPIO_PAR_FEC);\r\n}\r\nvoid __init config_BSP(char *commandp, int size)\r\n{\r\n#if !defined(CONFIG_BOOTPARAM)\r\nmemcpy(commandp, (char *) 0x4000, 4);\r\nif(strncmp(commandp, "kcl ", 4) == 0){\r\nmemcpy(commandp, (char *) 0x4004, size);\r\ncommandp[size-1] = 0;\r\n} else {\r\nmemset(commandp, 0, size);\r\n}\r\n#endif\r\nmach_sched_init = hw_timer_init;\r\nm53xx_clk_init();\r\nm53xx_uarts_init();\r\nm53xx_fec_init();\r\nm53xx_qspi_init();\r\n#ifdef CONFIG_BDM_DISABLE\r\nwdebug(MCFDEBUG_CSR, MCFDEBUG_CSR_PSTCLK);\r\n#endif\r\n}\r\nasmlinkage void __init sysinit(void)\r\n{\r\nsys_clk_khz = clock_pll(0, 0);\r\nsys_clk_mhz = sys_clk_khz/1000;\r\nwtm_init();\r\nscm_init();\r\ngpio_init();\r\nfbcs_init();\r\nsdramc_init();\r\n}\r\nvoid wtm_init(void)\r\n{\r\nwritew(0, MCF_WTM_WCR);\r\n}\r\nvoid scm_init(void)\r\n{\r\nwritel(0x77777777, MCF_SCM_MPR);\r\nwritel(0, MCF_SCM_PACRA);\r\nwritel(0, MCF_SCM_PACRB);\r\nwritel(0, MCF_SCM_PACRC);\r\nwritel(0, MCF_SCM_PACRD);\r\nwritel(0, MCF_SCM_PACRE);\r\nwritel(0, MCF_SCM_PACRF);\r\nwritel(MCF_SCM_BCR_GBR | MCF_SCM_BCR_GBW, MCF_SCM_BCR);\r\n}\r\nvoid fbcs_init(void)\r\n{\r\nwriteb(0x3E, MCFGPIO_PAR_CS);\r\nwritel(0x10080000, MCF_FBCS1_CSAR);\r\nwritel(0x002A3780, MCF_FBCS1_CSCR);\r\nwritel(MCF_FBCS_CSMR_BAM_2M | MCF_FBCS_CSMR_V, MCF_FBCS1_CSMR);\r\nwritew(0xffff, 0x10080000);\r\nwritel(EXT_SRAM_ADDRESS, MCF_FBCS1_CSAR);\r\nwritel(MCF_FBCS_CSCR_PS_16 |\r\nMCF_FBCS_CSCR_AA |\r\nMCF_FBCS_CSCR_SBM |\r\nMCF_FBCS_CSCR_WS(1),\r\nMCF_FBCS1_CSCR);\r\nwritel(MCF_FBCS_CSMR_BAM_512K | MCF_FBCS_CSMR_V, MCF_FBCS1_CSMR);\r\nwritel(FLASH_ADDRESS, MCF_FBCS0_CSAR);\r\nwritel(MCF_FBCS_CSCR_PS_16 |\r\nMCF_FBCS_CSCR_BEM |\r\nMCF_FBCS_CSCR_AA |\r\nMCF_FBCS_CSCR_SBM |\r\nMCF_FBCS_CSCR_WS(7),\r\nMCF_FBCS0_CSCR);\r\nwritel(MCF_FBCS_CSMR_BAM_32M | MCF_FBCS_CSMR_V, MCF_FBCS0_CSMR);\r\n}\r\nvoid sdramc_init(void)\r\n{\r\nif (!(readl(MCF_SDRAMC_SDCR) & MCF_SDRAMC_SDCR_REF)) {\r\nwritel(MCF_SDRAMC_SDCS_BA(SDRAM_ADDRESS) |\r\nMCF_SDRAMC_SDCS_CSSZ(MCF_SDRAMC_SDCS_CSSZ_32MBYTE),\r\nMCF_SDRAMC_SDCS0);\r\nwritel(MCF_SDRAMC_SDCFG1_SRD2RW((int)((SDRAM_CASL + 2) + 0.5)) |\r\nMCF_SDRAMC_SDCFG1_SWT2RD(SDRAM_TWR + 1) |\r\nMCF_SDRAMC_SDCFG1_RDLAT((int)((SDRAM_CASL * 2) + 2)) |\r\nMCF_SDRAMC_SDCFG1_ACT2RW((int)(SDRAM_TRCD + 0.5)) |\r\nMCF_SDRAMC_SDCFG1_PRE2ACT((int)(SDRAM_TRP + 0.5)) |\r\nMCF_SDRAMC_SDCFG1_REF2ACT((int)(SDRAM_TRFC + 0.5)) |\r\nMCF_SDRAMC_SDCFG1_WTLAT(3),\r\nMCF_SDRAMC_SDCFG1);\r\nwritel(MCF_SDRAMC_SDCFG2_BRD2PRE(SDRAM_BL / 2 + 1) |\r\nMCF_SDRAMC_SDCFG2_BWT2RW(SDRAM_BL / 2 + SDRAM_TWR) |\r\nMCF_SDRAMC_SDCFG2_BRD2WT((int)((SDRAM_CASL + SDRAM_BL / 2 - 1.0) + 0.5)) |\r\nMCF_SDRAMC_SDCFG2_BL(SDRAM_BL - 1),\r\nMCF_SDRAMC_SDCFG2);\r\nwritel(MCF_SDRAMC_SDCR_MODE_EN |\r\nMCF_SDRAMC_SDCR_CKE |\r\nMCF_SDRAMC_SDCR_DDR |\r\nMCF_SDRAMC_SDCR_MUX(1) |\r\nMCF_SDRAMC_SDCR_RCNT((int)(((SDRAM_TREFI / (SYSTEM_PERIOD * 64)) - 1) + 0.5)) |\r\nMCF_SDRAMC_SDCR_PS_16 |\r\nMCF_SDRAMC_SDCR_IPALL,\r\nMCF_SDRAMC_SDCR);\r\nwritel(MCF_SDRAMC_SDMR_BNKAD_LEMR |\r\nMCF_SDRAMC_SDMR_AD(0x0) |\r\nMCF_SDRAMC_SDMR_CMD,\r\nMCF_SDRAMC_SDMR);\r\nwritel(MCF_SDRAMC_SDMR_BNKAD_LMR |\r\nMCF_SDRAMC_SDMR_AD(0x163) |\r\nMCF_SDRAMC_SDMR_CMD,\r\nMCF_SDRAMC_SDMR);\r\nwritel(readl(MCF_SDRAMC_SDCR) | MCF_SDRAMC_SDCR_IPALL, MCF_SDRAMC_SDCR);\r\nwritel(readl(MCF_SDRAMC_SDCR) | MCF_SDRAMC_SDCR_IREF, MCF_SDRAMC_SDCR);\r\nwritel(readl(MCF_SDRAMC_SDCR) | MCF_SDRAMC_SDCR_IREF, MCF_SDRAMC_SDCR);\r\nwritel(MCF_SDRAMC_SDMR_BNKAD_LMR |\r\nMCF_SDRAMC_SDMR_AD(0x063) |\r\nMCF_SDRAMC_SDMR_CMD,\r\nMCF_SDRAMC_SDMR);\r\nwritel(readl(MCF_SDRAMC_SDCR) & ~MCF_SDRAMC_SDCR_MODE_EN,\r\nMCF_SDRAMC_SDCR);\r\nwritel(MCF_SDRAMC_SDCR_REF | MCF_SDRAMC_SDCR_DQS_OE(0xC),\r\nMCF_SDRAMC_SDCR);\r\n}\r\n}\r\nvoid gpio_init(void)\r\n{\r\nwritew(MCF_GPIO_PAR_UART_PAR_URXD0 | MCF_GPIO_PAR_UART_PAR_UTXD0,\r\nMCFGPIO_PAR_UART);\r\nwriteb(0x00, MCFGPIO_PAR_TIMER);\r\nwriteb(0x08, MCFGPIO_PDDR_TIMER);\r\nwriteb(0x00, MCFGPIO_PCLRR_TIMER);\r\n}\r\nint clock_pll(int fsys, int flags)\r\n{\r\nint fref, temp, fout, mfd;\r\nu32 i;\r\nfref = FREF;\r\nif (fsys == 0) {\r\nmfd = readb(MCF_PLL_PFDR);\r\nreturn (fref * mfd / (BUSDIV * 4));\r\n}\r\nif (fsys > MAX_FSYS)\r\nfsys = MAX_FSYS;\r\nif (fsys < MIN_FSYS)\r\nfsys = MIN_FSYS;\r\ntemp = 100 * fsys / fref;\r\nmfd = 4 * BUSDIV * temp / 100;\r\nfout = (fref * mfd / (BUSDIV * 4));\r\nif (readl(MCF_SDRAMC_SDCR) & MCF_SDRAMC_SDCR_REF)\r\nwritel(readl(MCF_SDRAMC_SDCR) & ~MCF_SDRAMC_SDCR_CKE,\r\nMCF_SDRAMC_SDCR);\r\nclock_limp(DEFAULT_LPD);\r\nwriteb(MCF_PLL_PODR_CPUDIV(BUSDIV/3) | MCF_PLL_PODR_BUSDIV(BUSDIV),\r\nMCF_PLL_PODR);\r\nwriteb(mfd, MCF_PLL_PFDR);\r\nclock_exit_limp();\r\nif (readl(MCF_SDRAMC_SDCR) & MCF_SDRAMC_SDCR_REF)\r\nwritel(readl(MCF_SDRAMC_SDCR) | MCF_SDRAMC_SDCR_CKE,\r\nMCF_SDRAMC_SDCR);\r\nwritel(MCF_SDRAMC_REFRESH, MCF_SDRAMC_LIMP_FIX);\r\nfor (i = 0; i < 0x200; i++)\r\n;\r\nreturn fout;\r\n}\r\nint clock_limp(int div)\r\n{\r\nu32 temp;\r\nif (div < MIN_LPD)\r\ndiv = MIN_LPD;\r\nif (div > MAX_LPD)\r\ndiv = MAX_LPD;\r\ntemp = readw(MCF_CCM_CDR) & MCF_CCM_CDR_SSIDIV(0xF);\r\nwritew(MCF_CCM_CDR_LPDIV(div) | MCF_CCM_CDR_SSIDIV(temp), MCF_CCM_CDR);\r\nwritew(readw(MCF_CCM_MISCCR) | MCF_CCM_MISCCR_LIMP, MCF_CCM_MISCCR);\r\nreturn (FREF/(3*(1 << div)));\r\n}\r\nint clock_exit_limp(void)\r\n{\r\nint fout;\r\nwritew(readw(MCF_CCM_MISCCR) & ~MCF_CCM_MISCCR_LIMP, MCF_CCM_MISCCR);\r\nwhile (!(readw(MCF_CCM_MISCCR) & MCF_CCM_MISCCR_PLL_LOCK))\r\n;\r\nfout = get_sys_clock();\r\nreturn fout;\r\n}\r\nint get_sys_clock(void)\r\n{\r\nint divider;\r\nif (readw(MCF_CCM_MISCCR) & MCF_CCM_MISCCR_LIMP) {\r\ndivider = readw(MCF_CCM_CDR) & MCF_CCM_CDR_LPDIV(0xF);\r\nreturn (FREF/(2 << divider));\r\n}\r\nelse\r\nreturn (FREF * readb(MCF_PLL_PFDR)) / (BUSDIV * 4);\r\n}

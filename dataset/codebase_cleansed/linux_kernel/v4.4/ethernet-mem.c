static int cvm_oct_fill_hw_skbuff(int pool, int size, int elements)\r\n{\r\nint freed = elements;\r\nwhile (freed) {\r\nstruct sk_buff *skb = dev_alloc_skb(size + 256);\r\nif (unlikely(skb == NULL))\r\nbreak;\r\nskb_reserve(skb, 256 - (((unsigned long)skb->data) & 0x7f));\r\n*(struct sk_buff **)(skb->data - sizeof(void *)) = skb;\r\ncvmx_fpa_free(skb->data, pool, size / 128);\r\nfreed--;\r\n}\r\nreturn elements - freed;\r\n}\r\nstatic void cvm_oct_free_hw_skbuff(int pool, int size, int elements)\r\n{\r\nchar *memory;\r\ndo {\r\nmemory = cvmx_fpa_alloc(pool);\r\nif (memory) {\r\nstruct sk_buff *skb =\r\n*(struct sk_buff **)(memory - sizeof(void *));\r\nelements--;\r\ndev_kfree_skb(skb);\r\n}\r\n} while (memory);\r\nif (elements < 0)\r\npr_warn("Freeing of pool %u had too many skbuffs (%d)\n",\r\npool, elements);\r\nelse if (elements > 0)\r\npr_warn("Freeing of pool %u is missing %d skbuffs\n",\r\npool, elements);\r\n}\r\nstatic int cvm_oct_fill_hw_memory(int pool, int size, int elements)\r\n{\r\nchar *memory;\r\nchar *fpa;\r\nint freed = elements;\r\nwhile (freed) {\r\nmemory = kmalloc(size + 256, GFP_ATOMIC);\r\nif (unlikely(memory == NULL)) {\r\npr_warn("Unable to allocate %u bytes for FPA pool %d\n",\r\nelements * size, pool);\r\nbreak;\r\n}\r\nfpa = (char *)(((unsigned long)memory + 256) & ~0x7fUL);\r\n*((char **)fpa - 1) = memory;\r\ncvmx_fpa_free(fpa, pool, 0);\r\nfreed--;\r\n}\r\nreturn elements - freed;\r\n}\r\nstatic void cvm_oct_free_hw_memory(int pool, int size, int elements)\r\n{\r\nchar *memory;\r\nchar *fpa;\r\ndo {\r\nfpa = cvmx_fpa_alloc(pool);\r\nif (fpa) {\r\nelements--;\r\nfpa = (char *)phys_to_virt(cvmx_ptr_to_phys(fpa));\r\nmemory = *((char **)fpa - 1);\r\nkfree(memory);\r\n}\r\n} while (fpa);\r\nif (elements < 0)\r\npr_warn("Freeing of pool %u had too many buffers (%d)\n",\r\npool, elements);\r\nelse if (elements > 0)\r\npr_warn("Warning: Freeing of pool %u is missing %d buffers\n",\r\npool, elements);\r\n}\r\nint cvm_oct_mem_fill_fpa(int pool, int size, int elements)\r\n{\r\nint freed;\r\nif (pool == CVMX_FPA_PACKET_POOL)\r\nfreed = cvm_oct_fill_hw_skbuff(pool, size, elements);\r\nelse\r\nfreed = cvm_oct_fill_hw_memory(pool, size, elements);\r\nreturn freed;\r\n}\r\nvoid cvm_oct_mem_empty_fpa(int pool, int size, int elements)\r\n{\r\nif (pool == CVMX_FPA_PACKET_POOL)\r\ncvm_oct_free_hw_skbuff(pool, size, elements);\r\nelse\r\ncvm_oct_free_hw_memory(pool, size, elements);\r\n}

resource_size_t\r\npcibios_align_resource(void *data, const struct resource *res,\r\nresource_size_t size, resource_size_t align)\r\n{\r\nresource_size_t start = res->start;\r\nif ((res->flags & IORESOURCE_IO) && (start & 0x300))\r\nstart = (start + 0x3ff) & ~0x3ff;\r\nreturn start;\r\n}\r\nstatic void __init pcibios_allocate_bus_resources(struct list_head *bus_list)\r\n{\r\nstruct list_head *ln;\r\nstruct pci_bus *bus;\r\nstruct pci_dev *dev;\r\nint idx;\r\nstruct resource *r;\r\nfor (ln=bus_list->next; ln != bus_list; ln=ln->next) {\r\nbus = pci_bus_b(ln);\r\nif ((dev = bus->self)) {\r\nfor (idx = PCI_BRIDGE_RESOURCES; idx < PCI_NUM_RESOURCES; idx++) {\r\nr = &dev->resource[idx];\r\nif (!r->start)\r\ncontinue;\r\npci_claim_resource(dev, idx);\r\n}\r\n}\r\npcibios_allocate_bus_resources(&bus->children);\r\n}\r\n}\r\nstatic void __init pcibios_allocate_resources(int pass)\r\n{\r\nstruct pci_dev *dev = NULL;\r\nint idx, disabled;\r\nu16 command;\r\nstruct resource *r;\r\nfor_each_pci_dev(dev) {\r\npci_read_config_word(dev, PCI_COMMAND, &command);\r\nfor(idx = 0; idx < 6; idx++) {\r\nr = &dev->resource[idx];\r\nif (r->parent)\r\ncontinue;\r\nif (!r->start)\r\ncontinue;\r\nif (r->flags & IORESOURCE_IO)\r\ndisabled = !(command & PCI_COMMAND_IO);\r\nelse\r\ndisabled = !(command & PCI_COMMAND_MEMORY);\r\nif (pass == disabled) {\r\nDBG("PCI: Resource %08lx-%08lx (f=%lx, d=%d, p=%d)\n",\r\nr->start, r->end, r->flags, disabled, pass);\r\nif (pci_claim_resource(dev, idx) < 0) {\r\nr->end -= r->start;\r\nr->start = 0;\r\n}\r\n}\r\n}\r\nif (!pass) {\r\nr = &dev->resource[PCI_ROM_RESOURCE];\r\nif (r->flags & IORESOURCE_ROM_ENABLE) {\r\nu32 reg;\r\nDBG("PCI: Switching off ROM of %s\n", pci_name(dev));\r\nr->flags &= ~IORESOURCE_ROM_ENABLE;\r\npci_read_config_dword(dev, dev->rom_base_reg, &reg);\r\npci_write_config_dword(dev, dev->rom_base_reg, reg & ~PCI_ROM_ADDRESS_ENABLE);\r\n}\r\n}\r\n}\r\n}\r\nstatic void __init pcibios_assign_resources(void)\r\n{\r\nstruct pci_dev *dev = NULL;\r\nint idx;\r\nstruct resource *r;\r\nfor_each_pci_dev(dev) {\r\nint class = dev->class >> 8;\r\nif (!class || class == PCI_CLASS_BRIDGE_HOST)\r\ncontinue;\r\nfor(idx=0; idx<6; idx++) {\r\nr = &dev->resource[idx];\r\nif ((class == PCI_CLASS_STORAGE_IDE && idx < 4) ||\r\n(class == PCI_CLASS_DISPLAY_VGA && (r->flags & IORESOURCE_IO)))\r\ncontinue;\r\nif (!r->start && r->end)\r\npci_assign_resource(dev, idx);\r\n}\r\nif (pci_probe & PCI_ASSIGN_ROMS) {\r\nr = &dev->resource[PCI_ROM_RESOURCE];\r\nr->end -= r->start;\r\nr->start = 0;\r\nif (r->end)\r\npci_assign_resource(dev, PCI_ROM_RESOURCE);\r\n}\r\n}\r\n}\r\nvoid __init pcibios_resource_survey(void)\r\n{\r\nDBG("PCI: Allocating resources\n");\r\npcibios_allocate_bus_resources(&pci_root_buses);\r\npcibios_allocate_resources(0);\r\npcibios_allocate_resources(1);\r\npcibios_assign_resources();\r\n}

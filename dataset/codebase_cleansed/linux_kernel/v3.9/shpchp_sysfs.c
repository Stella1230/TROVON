static ssize_t show_ctrl (struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct pci_dev *pdev;\r\nchar * out = buf;\r\nint index, busnr;\r\nstruct resource *res;\r\nstruct pci_bus *bus;\r\npdev = container_of (dev, struct pci_dev, dev);\r\nbus = pdev->subordinate;\r\nout += sprintf(buf, "Free resources: memory\n");\r\npci_bus_for_each_resource(bus, res, index) {\r\nif (res && (res->flags & IORESOURCE_MEM) &&\r\n!(res->flags & IORESOURCE_PREFETCH)) {\r\nout += sprintf(out, "start = %8.8llx, length = %8.8llx\n",\r\n(unsigned long long)res->start,\r\n(unsigned long long)resource_size(res));\r\n}\r\n}\r\nout += sprintf(out, "Free resources: prefetchable memory\n");\r\npci_bus_for_each_resource(bus, res, index) {\r\nif (res && (res->flags & IORESOURCE_MEM) &&\r\n(res->flags & IORESOURCE_PREFETCH)) {\r\nout += sprintf(out, "start = %8.8llx, length = %8.8llx\n",\r\n(unsigned long long)res->start,\r\n(unsigned long long)resource_size(res));\r\n}\r\n}\r\nout += sprintf(out, "Free resources: IO\n");\r\npci_bus_for_each_resource(bus, res, index) {\r\nif (res && (res->flags & IORESOURCE_IO)) {\r\nout += sprintf(out, "start = %8.8llx, length = %8.8llx\n",\r\n(unsigned long long)res->start,\r\n(unsigned long long)resource_size(res));\r\n}\r\n}\r\nout += sprintf(out, "Free resources: bus numbers\n");\r\nfor (busnr = bus->busn_res.start; busnr <= bus->busn_res.end; busnr++) {\r\nif (!pci_find_bus(pci_domain_nr(bus), busnr))\r\nbreak;\r\n}\r\nif (busnr < bus->busn_res.end)\r\nout += sprintf(out, "start = %8.8x, length = %8.8x\n",\r\nbusnr, (int)(bus->busn_res.end - busnr));\r\nreturn out - buf;\r\n}\r\nint __must_check shpchp_create_ctrl_files (struct controller *ctrl)\r\n{\r\nreturn device_create_file (&ctrl->pci_dev->dev, &dev_attr_ctrl);\r\n}\r\nvoid shpchp_remove_ctrl_files(struct controller *ctrl)\r\n{\r\ndevice_remove_file(&ctrl->pci_dev->dev, &dev_attr_ctrl);\r\n}

static void kb3886_bl_set_intensity(int intensity)\r\n{\r\nmutex_lock(&bl_mutex);\r\nintensity = intensity&0xff;\r\noutb(KB3886_ADC_DAC_PWM, KB3886_PARENT);\r\nusleep_range(10000, 11000);\r\noutb(KB3886_PWM0_WRITE, KB3886_IO);\r\nusleep_range(10000, 11000);\r\noutb(intensity, KB3886_IO);\r\nmutex_unlock(&bl_mutex);\r\n}\r\nstatic int kb3886bl_send_intensity(struct backlight_device *bd)\r\n{\r\nint intensity = bd->props.brightness;\r\nif (bd->props.power != FB_BLANK_UNBLANK)\r\nintensity = 0;\r\nif (bd->props.fb_blank != FB_BLANK_UNBLANK)\r\nintensity = 0;\r\nif (kb3886bl_flags & KB3886BL_SUSPENDED)\r\nintensity = 0;\r\nbl_machinfo->set_bl_intensity(intensity);\r\nkb3886bl_intensity = intensity;\r\nreturn 0;\r\n}\r\nstatic int kb3886bl_suspend(struct platform_device *pdev, pm_message_t state)\r\n{\r\nstruct backlight_device *bd = platform_get_drvdata(pdev);\r\nkb3886bl_flags |= KB3886BL_SUSPENDED;\r\nbacklight_update_status(bd);\r\nreturn 0;\r\n}\r\nstatic int kb3886bl_resume(struct platform_device *pdev)\r\n{\r\nstruct backlight_device *bd = platform_get_drvdata(pdev);\r\nkb3886bl_flags &= ~KB3886BL_SUSPENDED;\r\nbacklight_update_status(bd);\r\nreturn 0;\r\n}\r\nstatic int kb3886bl_get_intensity(struct backlight_device *bd)\r\n{\r\nreturn kb3886bl_intensity;\r\n}\r\nstatic int kb3886bl_probe(struct platform_device *pdev)\r\n{\r\nstruct backlight_properties props;\r\nstruct kb3886bl_machinfo *machinfo = pdev->dev.platform_data;\r\nbl_machinfo = machinfo;\r\nif (!machinfo->limit_mask)\r\nmachinfo->limit_mask = -1;\r\nmemset(&props, 0, sizeof(struct backlight_properties));\r\nprops.type = BACKLIGHT_RAW;\r\nprops.max_brightness = machinfo->max_intensity;\r\nkb3886_backlight_device = backlight_device_register("kb3886-bl",\r\n&pdev->dev, NULL,\r\n&kb3886bl_ops,\r\n&props);\r\nif (IS_ERR(kb3886_backlight_device))\r\nreturn PTR_ERR(kb3886_backlight_device);\r\nplatform_set_drvdata(pdev, kb3886_backlight_device);\r\nkb3886_backlight_device->props.power = FB_BLANK_UNBLANK;\r\nkb3886_backlight_device->props.brightness = machinfo->default_intensity;\r\nbacklight_update_status(kb3886_backlight_device);\r\nreturn 0;\r\n}\r\nstatic int kb3886bl_remove(struct platform_device *pdev)\r\n{\r\nstruct backlight_device *bd = platform_get_drvdata(pdev);\r\nbacklight_device_unregister(bd);\r\nreturn 0;\r\n}\r\nstatic int __init kb3886_init(void)\r\n{\r\nif (!dmi_check_system(kb3886bl_device_table))\r\nreturn -ENODEV;\r\nplatform_add_devices(devices, ARRAY_SIZE(devices));\r\nreturn platform_driver_register(&kb3886bl_driver);\r\n}\r\nstatic void __exit kb3886_exit(void)\r\n{\r\nplatform_driver_unregister(&kb3886bl_driver);\r\n}

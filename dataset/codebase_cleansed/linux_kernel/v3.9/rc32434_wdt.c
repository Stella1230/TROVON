static int rc32434_wdt_set(int new_timeout)\r\n{\r\nint max_to = WTCOMP2SEC((u32)-1);\r\nif (new_timeout < 0 || new_timeout > max_to) {\r\npr_err("timeout value must be between 0 and %d\n", max_to);\r\nreturn -EINVAL;\r\n}\r\ntimeout = new_timeout;\r\nspin_lock(&rc32434_wdt_device.io_lock);\r\nwritel(SEC2WTCOMP(timeout), &wdt_reg->wtcompare);\r\nspin_unlock(&rc32434_wdt_device.io_lock);\r\nreturn 0;\r\n}\r\nstatic void rc32434_wdt_start(void)\r\n{\r\nu32 or, nand;\r\nspin_lock(&rc32434_wdt_device.io_lock);\r\nwritel(0, &wdt_reg->wtcount);\r\nnand = 1 << RC32434_ERR_WNE;\r\nor = 1 << RC32434_ERR_WRE;\r\nnand |= 1 << RC32434_ERR_WTO;\r\nSET_BITS(wdt_reg->errcs, or, nand);\r\nrc32434_wdt_set(timeout);\r\nnand = 1 << RC32434_WTC_TO;\r\nor = 1 << RC32434_WTC_EN;\r\nSET_BITS(wdt_reg->wtc, or, nand);\r\nspin_unlock(&rc32434_wdt_device.io_lock);\r\npr_info("Started watchdog timer\n");\r\n}\r\nstatic void rc32434_wdt_stop(void)\r\n{\r\nspin_lock(&rc32434_wdt_device.io_lock);\r\nSET_BITS(wdt_reg->wtc, 0, 1 << RC32434_WTC_EN);\r\nspin_unlock(&rc32434_wdt_device.io_lock);\r\npr_info("Stopped watchdog timer\n");\r\n}\r\nstatic void rc32434_wdt_ping(void)\r\n{\r\nspin_lock(&rc32434_wdt_device.io_lock);\r\nwritel(0, &wdt_reg->wtcount);\r\nspin_unlock(&rc32434_wdt_device.io_lock);\r\n}\r\nstatic int rc32434_wdt_open(struct inode *inode, struct file *file)\r\n{\r\nif (test_and_set_bit(0, &rc32434_wdt_device.inuse))\r\nreturn -EBUSY;\r\nif (nowayout)\r\n__module_get(THIS_MODULE);\r\nrc32434_wdt_start();\r\nrc32434_wdt_ping();\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic int rc32434_wdt_release(struct inode *inode, struct file *file)\r\n{\r\nif (expect_close == 42) {\r\nrc32434_wdt_stop();\r\nmodule_put(THIS_MODULE);\r\n} else {\r\npr_crit("device closed unexpectedly. WDT will not stop!\n");\r\nrc32434_wdt_ping();\r\n}\r\nclear_bit(0, &rc32434_wdt_device.inuse);\r\nreturn 0;\r\n}\r\nstatic ssize_t rc32434_wdt_write(struct file *file, const char *data,\r\nsize_t len, loff_t *ppos)\r\n{\r\nif (len) {\r\nif (!nowayout) {\r\nsize_t i;\r\nexpect_close = 0;\r\nfor (i = 0; i != len; i++) {\r\nchar c;\r\nif (get_user(c, data + i))\r\nreturn -EFAULT;\r\nif (c == 'V')\r\nexpect_close = 42;\r\n}\r\n}\r\nrc32434_wdt_ping();\r\nreturn len;\r\n}\r\nreturn 0;\r\n}\r\nstatic long rc32434_wdt_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nvoid __user *argp = (void __user *)arg;\r\nint new_timeout;\r\nunsigned int value;\r\nstatic const struct watchdog_info ident = {\r\n.options = WDIOF_SETTIMEOUT |\r\nWDIOF_KEEPALIVEPING |\r\nWDIOF_MAGICCLOSE,\r\n.identity = "RC32434_WDT Watchdog",\r\n};\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nif (copy_to_user(argp, &ident, sizeof(ident)))\r\nreturn -EFAULT;\r\nbreak;\r\ncase WDIOC_GETSTATUS:\r\ncase WDIOC_GETBOOTSTATUS:\r\nvalue = 0;\r\nif (copy_to_user(argp, &value, sizeof(int)))\r\nreturn -EFAULT;\r\nbreak;\r\ncase WDIOC_SETOPTIONS:\r\nif (copy_from_user(&value, argp, sizeof(int)))\r\nreturn -EFAULT;\r\nswitch (value) {\r\ncase WDIOS_ENABLECARD:\r\nrc32434_wdt_start();\r\nbreak;\r\ncase WDIOS_DISABLECARD:\r\nrc32434_wdt_stop();\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ncase WDIOC_KEEPALIVE:\r\nrc32434_wdt_ping();\r\nbreak;\r\ncase WDIOC_SETTIMEOUT:\r\nif (copy_from_user(&new_timeout, argp, sizeof(int)))\r\nreturn -EFAULT;\r\nif (rc32434_wdt_set(new_timeout))\r\nreturn -EINVAL;\r\ncase WDIOC_GETTIMEOUT:\r\nreturn copy_to_user(argp, &timeout, sizeof(int));\r\ndefault:\r\nreturn -ENOTTY;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rc32434_wdt_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct resource *r;\r\nr = platform_get_resource_byname(pdev, IORESOURCE_MEM, "rb532_wdt_res");\r\nif (!r) {\r\npr_err("failed to retrieve resources\n");\r\nreturn -ENODEV;\r\n}\r\nwdt_reg = ioremap_nocache(r->start, resource_size(r));\r\nif (!wdt_reg) {\r\npr_err("failed to remap I/O resources\n");\r\nreturn -ENXIO;\r\n}\r\nspin_lock_init(&rc32434_wdt_device.io_lock);\r\nrc32434_wdt_stop();\r\nif (rc32434_wdt_set(timeout)) {\r\nrc32434_wdt_set(WATCHDOG_TIMEOUT);\r\npr_info("timeout value must be between 0 and %d\n",\r\nWTCOMP2SEC((u32)-1));\r\n}\r\nret = misc_register(&rc32434_wdt_miscdev);\r\nif (ret < 0) {\r\npr_err("failed to register watchdog device\n");\r\ngoto unmap;\r\n}\r\npr_info("Watchdog Timer version " VERSION ", timer margin: %d sec\n",\r\ntimeout);\r\nreturn 0;\r\nunmap:\r\niounmap(wdt_reg);\r\nreturn ret;\r\n}\r\nstatic int rc32434_wdt_remove(struct platform_device *pdev)\r\n{\r\nmisc_deregister(&rc32434_wdt_miscdev);\r\niounmap(wdt_reg);\r\nreturn 0;\r\n}\r\nstatic void rc32434_wdt_shutdown(struct platform_device *pdev)\r\n{\r\nrc32434_wdt_stop();\r\n}

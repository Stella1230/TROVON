static int subdev_8255_cb(int dir, int port, int data, unsigned long arg)\r\n{\r\nunsigned long iobase = arg;\r\nif (dir) {\r\noutb(data, iobase + port);\r\nreturn 0;\r\n} else {\r\nreturn inb(iobase + port);\r\n}\r\n}\r\nstatic int subdev_8255mapped_cb(int dir, int port, int data,\r\nunsigned long iobase)\r\n{\r\nint movport = SIZE_8255 * (iobase >> 12);\r\niobase &= 0x0fff;\r\nif (dir) {\r\noutb(port + movport, iobase);\r\noutb(data, iobase + 1);\r\nreturn 0;\r\n} else {\r\noutb(port + movport, iobase);\r\nreturn inb(iobase + 1);\r\n}\r\n}\r\nstatic int pcl724_attach(struct comedi_device *dev, struct comedi_devconfig *it)\r\n{\r\nconst struct pcl724_board *board = comedi_board(dev);\r\nstruct comedi_subdevice *s;\r\nunsigned long iobase;\r\nunsigned int iorange;\r\nint ret, i, n_subdevices;\r\n#ifdef PCL724_IRQ\r\nunsigned int irq;\r\n#endif\r\niobase = it->options[0];\r\niorange = board->io_range;\r\nif ((board->can_have96) && ((it->options[1] == 1)\r\n|| (it->options[1] == 96)))\r\niorange = PCL722_96_SIZE;\r\nprintk(KERN_INFO "comedi%d: pcl724: board=%s, 0x%03lx ", dev->minor,\r\nboard->name, iobase);\r\nif (!request_region(iobase, iorange, "pcl724")) {\r\nprintk("I/O port conflict\n");\r\nreturn -EIO;\r\n}\r\ndev->iobase = iobase;\r\ndev->board_name = board->name;\r\n#ifdef PCL724_IRQ\r\nirq = 0;\r\nif (board->IRQbits != 0) {\r\nirq = it->options[1];\r\nif (irq) {\r\nif (((1 << irq) & board->IRQbits) == 0) {\r\nprintk(KERN_WARNING\r\n", IRQ %u is out of allowed range, "\r\n"DISABLING IT", irq);\r\nirq = 0;\r\n} else {\r\nif (request_irq\r\n(irq, interrupt_pcl724, 0, "pcl724", dev)) {\r\nprintk(KERN_WARNING\r\n", unable to allocate IRQ %u, "\r\n"DISABLING IT", irq);\r\nirq = 0;\r\n} else {\r\nprintk(", irq=%u", irq);\r\n}\r\n}\r\n}\r\n}\r\ndev->irq = irq;\r\n#endif\r\nprintk("\n");\r\nn_subdevices = board->numofports;\r\nif ((board->can_have96) && ((it->options[1] == 1)\r\n|| (it->options[1] == 96)))\r\nn_subdevices = 4;\r\nret = comedi_alloc_subdevices(dev, n_subdevices);\r\nif (ret)\r\nreturn ret;\r\nfor (i = 0; i < dev->n_subdevices; i++) {\r\ns = &dev->subdevices[i];\r\nif (board->is_pet48) {\r\nsubdev_8255_init(dev, s, subdev_8255mapped_cb,\r\n(unsigned long)(dev->iobase +\r\ni * 0x1000));\r\n} else\r\nsubdev_8255_init(dev, s, subdev_8255_cb,\r\n(unsigned long)(dev->iobase +\r\nSIZE_8255 * i));\r\n}\r\nreturn 0;\r\n}\r\nstatic void pcl724_detach(struct comedi_device *dev)\r\n{\r\nconst struct pcl724_board *board = comedi_board(dev);\r\nstruct comedi_subdevice *s;\r\nint i;\r\nfor (i = 0; i < dev->n_subdevices; i++) {\r\ns = &dev->subdevices[i];\r\nsubdev_8255_cleanup(dev, s);\r\n}\r\n#ifdef PCL724_IRQ\r\nif (dev->irq)\r\nfree_irq(dev->irq, dev);\r\n#endif\r\nrelease_region(dev->iobase, board->io_range);\r\n}

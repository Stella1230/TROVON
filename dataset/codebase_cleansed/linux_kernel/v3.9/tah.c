int tah_attach(struct platform_device *ofdev, int channel)\r\n{\r\nstruct tah_instance *dev = dev_get_drvdata(&ofdev->dev);\r\nmutex_lock(&dev->lock);\r\n++dev->users;\r\nmutex_unlock(&dev->lock);\r\nreturn 0;\r\n}\r\nvoid tah_detach(struct platform_device *ofdev, int channel)\r\n{\r\nstruct tah_instance *dev = dev_get_drvdata(&ofdev->dev);\r\nmutex_lock(&dev->lock);\r\n--dev->users;\r\nmutex_unlock(&dev->lock);\r\n}\r\nvoid tah_reset(struct platform_device *ofdev)\r\n{\r\nstruct tah_instance *dev = dev_get_drvdata(&ofdev->dev);\r\nstruct tah_regs __iomem *p = dev->base;\r\nint n;\r\nout_be32(&p->mr, TAH_MR_SR);\r\nn = 100;\r\nwhile ((in_be32(&p->mr) & TAH_MR_SR) && n)\r\n--n;\r\nif (unlikely(!n))\r\nprintk(KERN_ERR "%s: reset timeout\n",\r\nofdev->dev.of_node->full_name);\r\nout_be32(&p->mr,\r\nTAH_MR_CVR | TAH_MR_ST_768 | TAH_MR_TFS_10KB | TAH_MR_DTFP |\r\nTAH_MR_DIG);\r\n}\r\nint tah_get_regs_len(struct platform_device *ofdev)\r\n{\r\nreturn sizeof(struct emac_ethtool_regs_subhdr) +\r\nsizeof(struct tah_regs);\r\n}\r\nvoid *tah_dump_regs(struct platform_device *ofdev, void *buf)\r\n{\r\nstruct tah_instance *dev = dev_get_drvdata(&ofdev->dev);\r\nstruct emac_ethtool_regs_subhdr *hdr = buf;\r\nstruct tah_regs *regs = (struct tah_regs *)(hdr + 1);\r\nhdr->version = 0;\r\nhdr->index = 0;\r\nmemcpy_fromio(regs, dev->base, sizeof(struct tah_regs));\r\nreturn regs + 1;\r\n}\r\nstatic int tah_probe(struct platform_device *ofdev)\r\n{\r\nstruct device_node *np = ofdev->dev.of_node;\r\nstruct tah_instance *dev;\r\nstruct resource regs;\r\nint rc;\r\nrc = -ENOMEM;\r\ndev = kzalloc(sizeof(struct tah_instance), GFP_KERNEL);\r\nif (dev == NULL)\r\ngoto err_gone;\r\nmutex_init(&dev->lock);\r\ndev->ofdev = ofdev;\r\nrc = -ENXIO;\r\nif (of_address_to_resource(np, 0, &regs)) {\r\nprintk(KERN_ERR "%s: Can't get registers address\n",\r\nnp->full_name);\r\ngoto err_free;\r\n}\r\nrc = -ENOMEM;\r\ndev->base = (struct tah_regs __iomem *)ioremap(regs.start,\r\nsizeof(struct tah_regs));\r\nif (dev->base == NULL) {\r\nprintk(KERN_ERR "%s: Can't map device registers!\n",\r\nnp->full_name);\r\ngoto err_free;\r\n}\r\ndev_set_drvdata(&ofdev->dev, dev);\r\ntah_reset(ofdev);\r\nprintk(KERN_INFO\r\n"TAH %s initialized\n", ofdev->dev.of_node->full_name);\r\nwmb();\r\nreturn 0;\r\nerr_free:\r\nkfree(dev);\r\nerr_gone:\r\nreturn rc;\r\n}\r\nstatic int tah_remove(struct platform_device *ofdev)\r\n{\r\nstruct tah_instance *dev = dev_get_drvdata(&ofdev->dev);\r\ndev_set_drvdata(&ofdev->dev, NULL);\r\nWARN_ON(dev->users != 0);\r\niounmap(dev->base);\r\nkfree(dev);\r\nreturn 0;\r\n}\r\nint __init tah_init(void)\r\n{\r\nreturn platform_driver_register(&tah_driver);\r\n}\r\nvoid tah_exit(void)\r\n{\r\nplatform_driver_unregister(&tah_driver);\r\n}

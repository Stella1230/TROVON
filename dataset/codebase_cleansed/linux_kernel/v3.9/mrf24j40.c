static int write_short_reg(struct mrf24j40 *devrec, u8 reg, u8 value)\r\n{\r\nint ret;\r\nstruct spi_message msg;\r\nstruct spi_transfer xfer = {\r\n.len = 2,\r\n.tx_buf = devrec->buf,\r\n.rx_buf = devrec->buf,\r\n};\r\nspi_message_init(&msg);\r\nspi_message_add_tail(&xfer, &msg);\r\nmutex_lock(&devrec->buffer_mutex);\r\ndevrec->buf[0] = MRF24J40_WRITESHORT(reg);\r\ndevrec->buf[1] = value;\r\nret = spi_sync(devrec->spi, &msg);\r\nif (ret)\r\ndev_err(printdev(devrec),\r\n"SPI write Failed for short register 0x%hhx\n", reg);\r\nmutex_unlock(&devrec->buffer_mutex);\r\nreturn ret;\r\n}\r\nstatic int read_short_reg(struct mrf24j40 *devrec, u8 reg, u8 *val)\r\n{\r\nint ret = -1;\r\nstruct spi_message msg;\r\nstruct spi_transfer xfer = {\r\n.len = 2,\r\n.tx_buf = devrec->buf,\r\n.rx_buf = devrec->buf,\r\n};\r\nspi_message_init(&msg);\r\nspi_message_add_tail(&xfer, &msg);\r\nmutex_lock(&devrec->buffer_mutex);\r\ndevrec->buf[0] = MRF24J40_READSHORT(reg);\r\ndevrec->buf[1] = 0;\r\nret = spi_sync(devrec->spi, &msg);\r\nif (ret)\r\ndev_err(printdev(devrec),\r\n"SPI read Failed for short register 0x%hhx\n", reg);\r\nelse\r\n*val = devrec->buf[1];\r\nmutex_unlock(&devrec->buffer_mutex);\r\nreturn ret;\r\n}\r\nstatic int read_long_reg(struct mrf24j40 *devrec, u16 reg, u8 *value)\r\n{\r\nint ret;\r\nu16 cmd;\r\nstruct spi_message msg;\r\nstruct spi_transfer xfer = {\r\n.len = 3,\r\n.tx_buf = devrec->buf,\r\n.rx_buf = devrec->buf,\r\n};\r\nspi_message_init(&msg);\r\nspi_message_add_tail(&xfer, &msg);\r\ncmd = MRF24J40_READLONG(reg);\r\nmutex_lock(&devrec->buffer_mutex);\r\ndevrec->buf[0] = cmd >> 8 & 0xff;\r\ndevrec->buf[1] = cmd & 0xff;\r\ndevrec->buf[2] = 0;\r\nret = spi_sync(devrec->spi, &msg);\r\nif (ret)\r\ndev_err(printdev(devrec),\r\n"SPI read Failed for long register 0x%hx\n", reg);\r\nelse\r\n*value = devrec->buf[2];\r\nmutex_unlock(&devrec->buffer_mutex);\r\nreturn ret;\r\n}\r\nstatic int write_long_reg(struct mrf24j40 *devrec, u16 reg, u8 val)\r\n{\r\nint ret;\r\nu16 cmd;\r\nstruct spi_message msg;\r\nstruct spi_transfer xfer = {\r\n.len = 3,\r\n.tx_buf = devrec->buf,\r\n.rx_buf = devrec->buf,\r\n};\r\nspi_message_init(&msg);\r\nspi_message_add_tail(&xfer, &msg);\r\ncmd = MRF24J40_WRITELONG(reg);\r\nmutex_lock(&devrec->buffer_mutex);\r\ndevrec->buf[0] = cmd >> 8 & 0xff;\r\ndevrec->buf[1] = cmd & 0xff;\r\ndevrec->buf[2] = val;\r\nret = spi_sync(devrec->spi, &msg);\r\nif (ret)\r\ndev_err(printdev(devrec),\r\n"SPI write Failed for long register 0x%hx\n", reg);\r\nmutex_unlock(&devrec->buffer_mutex);\r\nreturn ret;\r\n}\r\nstatic int write_tx_buf(struct mrf24j40 *devrec, u16 reg,\r\nconst u8 *data, size_t length)\r\n{\r\nint ret;\r\nu16 cmd;\r\nu8 lengths[2];\r\nstruct spi_message msg;\r\nstruct spi_transfer addr_xfer = {\r\n.len = 2,\r\n.tx_buf = devrec->buf,\r\n};\r\nstruct spi_transfer lengths_xfer = {\r\n.len = 2,\r\n.tx_buf = &lengths,\r\n};\r\nstruct spi_transfer data_xfer = {\r\n.len = length,\r\n.tx_buf = data,\r\n};\r\nif (length > TX_FIFO_SIZE-2) {\r\ndev_err(printdev(devrec), "write_tx_buf() was passed too large a buffer. Performing short write.\n");\r\nlength = TX_FIFO_SIZE-2;\r\n}\r\nspi_message_init(&msg);\r\nspi_message_add_tail(&addr_xfer, &msg);\r\nspi_message_add_tail(&lengths_xfer, &msg);\r\nspi_message_add_tail(&data_xfer, &msg);\r\ncmd = MRF24J40_WRITELONG(reg);\r\nmutex_lock(&devrec->buffer_mutex);\r\ndevrec->buf[0] = cmd >> 8 & 0xff;\r\ndevrec->buf[1] = cmd & 0xff;\r\nlengths[0] = 0x0;\r\nlengths[1] = length;\r\nret = spi_sync(devrec->spi, &msg);\r\nif (ret)\r\ndev_err(printdev(devrec), "SPI write Failed for TX buf\n");\r\nmutex_unlock(&devrec->buffer_mutex);\r\nreturn ret;\r\n}\r\nstatic int mrf24j40_read_rx_buf(struct mrf24j40 *devrec,\r\nu8 *data, u8 *len, u8 *lqi)\r\n{\r\nu8 rx_len;\r\nu8 addr[2];\r\nu8 lqi_rssi[2];\r\nu16 cmd;\r\nint ret;\r\nstruct spi_message msg;\r\nstruct spi_transfer addr_xfer = {\r\n.len = 2,\r\n.tx_buf = &addr,\r\n};\r\nstruct spi_transfer data_xfer = {\r\n.len = 0x0,\r\n.rx_buf = data,\r\n};\r\nstruct spi_transfer status_xfer = {\r\n.len = 2,\r\n.rx_buf = &lqi_rssi,\r\n};\r\nret = read_long_reg(devrec, REG_RX_FIFO, &rx_len);\r\nif (ret)\r\ngoto out;\r\nif (rx_len > RX_FIFO_SIZE-1) {\r\ndev_err(printdev(devrec), "Invalid length read from device. Performing short read.\n");\r\nrx_len = RX_FIFO_SIZE-1;\r\n}\r\nif (rx_len > *len) {\r\ndev_err(printdev(devrec), "Buffer not big enough. Performing short read\n");\r\nrx_len = *len;\r\n}\r\ncmd = MRF24J40_READLONG(REG_RX_FIFO+1);\r\naddr[0] = cmd >> 8 & 0xff;\r\naddr[1] = cmd & 0xff;\r\ndata_xfer.len = rx_len;\r\nspi_message_init(&msg);\r\nspi_message_add_tail(&addr_xfer, &msg);\r\nspi_message_add_tail(&data_xfer, &msg);\r\nspi_message_add_tail(&status_xfer, &msg);\r\nret = spi_sync(devrec->spi, &msg);\r\nif (ret) {\r\ndev_err(printdev(devrec), "SPI RX Buffer Read Failed.\n");\r\ngoto out;\r\n}\r\n*lqi = lqi_rssi[0];\r\n*len = rx_len;\r\n#ifdef DEBUG\r\nprint_hex_dump(KERN_DEBUG, "mrf24j40 rx: ",\r\nDUMP_PREFIX_OFFSET, 16, 1, data, *len, 0);\r\nprintk(KERN_DEBUG "mrf24j40 rx: lqi: %02hhx rssi: %02hhx\n",\r\nlqi_rssi[0], lqi_rssi[1]);\r\n#endif\r\nout:\r\nreturn ret;\r\n}\r\nstatic int mrf24j40_tx(struct ieee802154_dev *dev, struct sk_buff *skb)\r\n{\r\nstruct mrf24j40 *devrec = dev->priv;\r\nu8 val;\r\nint ret = 0;\r\ndev_dbg(printdev(devrec), "tx packet of %d bytes\n", skb->len);\r\nret = write_tx_buf(devrec, 0x000, skb->data, skb->len);\r\nif (ret)\r\ngoto err;\r\nret = read_short_reg(devrec, REG_TXNCON, &val);\r\nif (ret)\r\ngoto err;\r\nval |= 0x1;\r\nval &= ~0x4;\r\nwrite_short_reg(devrec, REG_TXNCON, val);\r\nINIT_COMPLETION(devrec->tx_complete);\r\nret = wait_for_completion_interruptible_timeout(\r\n&devrec->tx_complete,\r\n5 * HZ);\r\nif (ret == -ERESTARTSYS)\r\ngoto err;\r\nif (ret == 0) {\r\nret = -ETIMEDOUT;\r\ngoto err;\r\n}\r\nret = read_short_reg(devrec, REG_TXSTAT, &val);\r\nif (ret)\r\ngoto err;\r\nif (val & 0x1) {\r\ndev_err(printdev(devrec), "Error Sending. Retry count exceeded\n");\r\nret = -ECOMM;\r\n} else\r\ndev_dbg(printdev(devrec), "Packet Sent\n");\r\nerr:\r\nreturn ret;\r\n}\r\nstatic int mrf24j40_ed(struct ieee802154_dev *dev, u8 *level)\r\n{\r\nprintk(KERN_WARNING "mrf24j40: ed not implemented\n");\r\n*level = 0;\r\nreturn 0;\r\n}\r\nstatic int mrf24j40_start(struct ieee802154_dev *dev)\r\n{\r\nstruct mrf24j40 *devrec = dev->priv;\r\nu8 val;\r\nint ret;\r\ndev_dbg(printdev(devrec), "start\n");\r\nret = read_short_reg(devrec, REG_INTCON, &val);\r\nif (ret)\r\nreturn ret;\r\nval &= ~(0x1|0x8);\r\nwrite_short_reg(devrec, REG_INTCON, val);\r\nreturn 0;\r\n}\r\nstatic void mrf24j40_stop(struct ieee802154_dev *dev)\r\n{\r\nstruct mrf24j40 *devrec = dev->priv;\r\nu8 val;\r\nint ret;\r\ndev_dbg(printdev(devrec), "stop\n");\r\nret = read_short_reg(devrec, REG_INTCON, &val);\r\nif (ret)\r\nreturn;\r\nval |= 0x1|0x8;\r\nwrite_short_reg(devrec, REG_INTCON, val);\r\nreturn;\r\n}\r\nstatic int mrf24j40_set_channel(struct ieee802154_dev *dev,\r\nint page, int channel)\r\n{\r\nstruct mrf24j40 *devrec = dev->priv;\r\nu8 val;\r\nint ret;\r\ndev_dbg(printdev(devrec), "Set Channel %d\n", channel);\r\nWARN_ON(page != 0);\r\nWARN_ON(channel < MRF24J40_CHAN_MIN);\r\nWARN_ON(channel > MRF24J40_CHAN_MAX);\r\nval = (channel-11) << 4 | 0x03;\r\nwrite_long_reg(devrec, REG_RFCON0, val);\r\nret = read_short_reg(devrec, REG_RFCTL, &val);\r\nif (ret)\r\nreturn ret;\r\nval |= 0x04;\r\nwrite_short_reg(devrec, REG_RFCTL, val);\r\nval &= ~0x04;\r\nwrite_short_reg(devrec, REG_RFCTL, val);\r\nudelay(SET_CHANNEL_DELAY_US);\r\nreturn 0;\r\n}\r\nstatic int mrf24j40_filter(struct ieee802154_dev *dev,\r\nstruct ieee802154_hw_addr_filt *filt,\r\nunsigned long changed)\r\n{\r\nstruct mrf24j40 *devrec = dev->priv;\r\ndev_dbg(printdev(devrec), "filter\n");\r\nif (changed & IEEE802515_AFILT_SADDR_CHANGED) {\r\nu8 addrh, addrl;\r\naddrh = filt->short_addr >> 8 & 0xff;\r\naddrl = filt->short_addr & 0xff;\r\nwrite_short_reg(devrec, REG_SADRH, addrh);\r\nwrite_short_reg(devrec, REG_SADRL, addrl);\r\ndev_dbg(printdev(devrec),\r\n"Set short addr to %04hx\n", filt->short_addr);\r\n}\r\nif (changed & IEEE802515_AFILT_IEEEADDR_CHANGED) {\r\nint i;\r\nfor (i = 0; i < 8; i++)\r\nwrite_short_reg(devrec, REG_EADR0+i,\r\nfilt->ieee_addr[i]);\r\n#ifdef DEBUG\r\nprintk(KERN_DEBUG "Set long addr to: ");\r\nfor (i = 0; i < 8; i++)\r\nprintk("%02hhx ", filt->ieee_addr[i]);\r\nprintk(KERN_DEBUG "\n");\r\n#endif\r\n}\r\nif (changed & IEEE802515_AFILT_PANID_CHANGED) {\r\nu8 panidl, panidh;\r\npanidh = filt->pan_id >> 8 & 0xff;\r\npanidl = filt->pan_id & 0xff;\r\nwrite_short_reg(devrec, REG_PANIDH, panidh);\r\nwrite_short_reg(devrec, REG_PANIDL, panidl);\r\ndev_dbg(printdev(devrec), "Set PANID to %04hx\n", filt->pan_id);\r\n}\r\nif (changed & IEEE802515_AFILT_PANC_CHANGED) {\r\nu8 val;\r\nint ret;\r\nret = read_short_reg(devrec, REG_RXMCR, &val);\r\nif (ret)\r\nreturn ret;\r\nif (filt->pan_coord)\r\nval |= 0x8;\r\nelse\r\nval &= ~0x8;\r\nwrite_short_reg(devrec, REG_RXMCR, val);\r\ndev_dbg(printdev(devrec), "Set Pan Coord to %s\n",\r\nfilt->pan_coord ? "on" : "off");\r\n}\r\nreturn 0;\r\n}\r\nstatic int mrf24j40_handle_rx(struct mrf24j40 *devrec)\r\n{\r\nu8 len = RX_FIFO_SIZE;\r\nu8 lqi = 0;\r\nu8 val;\r\nint ret = 0;\r\nstruct sk_buff *skb;\r\nret = read_short_reg(devrec, REG_BBREG1, &val);\r\nif (ret)\r\ngoto out;\r\nval |= 4;\r\nwrite_short_reg(devrec, REG_BBREG1, val);\r\nskb = alloc_skb(len, GFP_KERNEL);\r\nif (!skb) {\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nret = mrf24j40_read_rx_buf(devrec, skb_put(skb, len), &len, &lqi);\r\nif (ret < 0) {\r\ndev_err(printdev(devrec), "Failure reading RX FIFO\n");\r\nkfree_skb(skb);\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nskb_trim(skb, len-2);\r\nieee802154_rx_irqsafe(devrec->dev, skb, lqi);\r\ndev_dbg(printdev(devrec), "RX Handled\n");\r\nout:\r\nret = read_short_reg(devrec, REG_BBREG1, &val);\r\nif (ret)\r\nreturn ret;\r\nval &= ~0x4;\r\nwrite_short_reg(devrec, REG_BBREG1, val);\r\nreturn ret;\r\n}\r\nstatic irqreturn_t mrf24j40_isr(int irq, void *data)\r\n{\r\nstruct mrf24j40 *devrec = data;\r\ndisable_irq_nosync(irq);\r\nschedule_work(&devrec->irqwork);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void mrf24j40_isrwork(struct work_struct *work)\r\n{\r\nstruct mrf24j40 *devrec = container_of(work, struct mrf24j40, irqwork);\r\nu8 intstat;\r\nint ret;\r\nret = read_short_reg(devrec, REG_INTSTAT, &intstat);\r\nif (ret)\r\ngoto out;\r\nif (intstat & 0x1)\r\ncomplete(&devrec->tx_complete);\r\nif (intstat & 0x8)\r\nmrf24j40_handle_rx(devrec);\r\nout:\r\nenable_irq(devrec->spi->irq);\r\n}\r\nstatic int mrf24j40_probe(struct spi_device *spi)\r\n{\r\nint ret = -ENOMEM;\r\nu8 val;\r\nstruct mrf24j40 *devrec;\r\nprintk(KERN_INFO "mrf24j40: probe(). IRQ: %d\n", spi->irq);\r\ndevrec = kzalloc(sizeof(struct mrf24j40), GFP_KERNEL);\r\nif (!devrec)\r\ngoto err_devrec;\r\ndevrec->buf = kzalloc(3, GFP_KERNEL);\r\nif (!devrec->buf)\r\ngoto err_buf;\r\nspi->mode = SPI_MODE_0;\r\nif (spi->max_speed_hz > MAX_SPI_SPEED_HZ)\r\nspi->max_speed_hz = MAX_SPI_SPEED_HZ;\r\nmutex_init(&devrec->buffer_mutex);\r\ninit_completion(&devrec->tx_complete);\r\nINIT_WORK(&devrec->irqwork, mrf24j40_isrwork);\r\ndevrec->spi = spi;\r\ndev_set_drvdata(&spi->dev, devrec);\r\ndevrec->dev = ieee802154_alloc_device(0, &mrf24j40_ops);\r\nif (!devrec->dev)\r\ngoto err_alloc_dev;\r\ndevrec->dev->priv = devrec;\r\ndevrec->dev->parent = &devrec->spi->dev;\r\ndevrec->dev->phy->channels_supported[0] = CHANNEL_MASK;\r\ndevrec->dev->flags = IEEE802154_HW_OMIT_CKSUM|IEEE802154_HW_AACK;\r\ndev_dbg(printdev(devrec), "registered mrf24j40\n");\r\nret = ieee802154_register_device(devrec->dev);\r\nif (ret)\r\ngoto err_register_device;\r\nwrite_short_reg(devrec, REG_SOFTRST, 0x07);\r\nwrite_short_reg(devrec, REG_PACON2, 0x98);\r\nwrite_short_reg(devrec, REG_TXSTBL, 0x95);\r\nwrite_long_reg(devrec, REG_RFCON0, 0x03);\r\nwrite_long_reg(devrec, REG_RFCON1, 0x01);\r\nwrite_long_reg(devrec, REG_RFCON2, 0x80);\r\nwrite_long_reg(devrec, REG_RFCON6, 0x90);\r\nwrite_long_reg(devrec, REG_RFCON7, 0x80);\r\nwrite_long_reg(devrec, REG_RFCON8, 0x10);\r\nwrite_long_reg(devrec, REG_SLPCON1, 0x21);\r\nwrite_short_reg(devrec, REG_BBREG2, 0x80);\r\nwrite_short_reg(devrec, REG_CCAEDTH, 0x60);\r\nwrite_short_reg(devrec, REG_BBREG6, 0x40);\r\nwrite_short_reg(devrec, REG_RFCTL, 0x04);\r\nwrite_short_reg(devrec, REG_RFCTL, 0x0);\r\nudelay(192);\r\nret = read_short_reg(devrec, REG_RXMCR, &val);\r\nif (ret)\r\ngoto err_read_reg;\r\nval &= ~0x3;\r\nwrite_short_reg(devrec, REG_RXMCR, val);\r\nret = request_irq(spi->irq,\r\nmrf24j40_isr,\r\nIRQF_TRIGGER_FALLING,\r\ndev_name(&spi->dev),\r\ndevrec);\r\nif (ret) {\r\ndev_err(printdev(devrec), "Unable to get IRQ");\r\ngoto err_irq;\r\n}\r\nreturn 0;\r\nerr_irq:\r\nerr_read_reg:\r\nieee802154_unregister_device(devrec->dev);\r\nerr_register_device:\r\nieee802154_free_device(devrec->dev);\r\nerr_alloc_dev:\r\nkfree(devrec->buf);\r\nerr_buf:\r\nkfree(devrec);\r\nerr_devrec:\r\nreturn ret;\r\n}\r\nstatic int mrf24j40_remove(struct spi_device *spi)\r\n{\r\nstruct mrf24j40 *devrec = dev_get_drvdata(&spi->dev);\r\ndev_dbg(printdev(devrec), "remove\n");\r\nfree_irq(spi->irq, devrec);\r\nflush_work(&devrec->irqwork);\r\nieee802154_unregister_device(devrec->dev);\r\nieee802154_free_device(devrec->dev);\r\ndev_set_drvdata(&spi->dev, NULL);\r\nkfree(devrec->buf);\r\nkfree(devrec);\r\nreturn 0;\r\n}\r\nstatic int __init mrf24j40_init(void)\r\n{\r\nreturn spi_register_driver(&mrf24j40_driver);\r\n}\r\nstatic void __exit mrf24j40_exit(void)\r\n{\r\nspi_unregister_driver(&mrf24j40_driver);\r\n}

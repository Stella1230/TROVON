static unsigned long hugetlb_get_unmapped_area_bottomup(struct file *filp,\r\nunsigned long addr,\r\nunsigned long len,\r\nunsigned long pgoff,\r\nunsigned long flags)\r\n{\r\nunsigned long task_size = TASK_SIZE;\r\nstruct vm_unmapped_area_info info;\r\nif (test_thread_flag(TIF_32BIT))\r\ntask_size = STACK_TOP32;\r\ninfo.flags = 0;\r\ninfo.length = len;\r\ninfo.low_limit = TASK_UNMAPPED_BASE;\r\ninfo.high_limit = min(task_size, VA_EXCLUDE_START);\r\ninfo.align_mask = PAGE_MASK & ~HPAGE_MASK;\r\ninfo.align_offset = 0;\r\naddr = vm_unmapped_area(&info);\r\nif ((addr & ~PAGE_MASK) && task_size > VA_EXCLUDE_END) {\r\nVM_BUG_ON(addr != -ENOMEM);\r\ninfo.low_limit = VA_EXCLUDE_END;\r\ninfo.high_limit = task_size;\r\naddr = vm_unmapped_area(&info);\r\n}\r\nreturn addr;\r\n}\r\nstatic unsigned long\r\nhugetlb_get_unmapped_area_topdown(struct file *filp, const unsigned long addr0,\r\nconst unsigned long len,\r\nconst unsigned long pgoff,\r\nconst unsigned long flags)\r\n{\r\nstruct mm_struct *mm = current->mm;\r\nunsigned long addr = addr0;\r\nstruct vm_unmapped_area_info info;\r\nBUG_ON(!test_thread_flag(TIF_32BIT));\r\ninfo.flags = VM_UNMAPPED_AREA_TOPDOWN;\r\ninfo.length = len;\r\ninfo.low_limit = PAGE_SIZE;\r\ninfo.high_limit = mm->mmap_base;\r\ninfo.align_mask = PAGE_MASK & ~HPAGE_MASK;\r\ninfo.align_offset = 0;\r\naddr = vm_unmapped_area(&info);\r\nif (addr & ~PAGE_MASK) {\r\nVM_BUG_ON(addr != -ENOMEM);\r\ninfo.flags = 0;\r\ninfo.low_limit = TASK_UNMAPPED_BASE;\r\ninfo.high_limit = STACK_TOP32;\r\naddr = vm_unmapped_area(&info);\r\n}\r\nreturn addr;\r\n}\r\nunsigned long\r\nhugetlb_get_unmapped_area(struct file *file, unsigned long addr,\r\nunsigned long len, unsigned long pgoff, unsigned long flags)\r\n{\r\nstruct mm_struct *mm = current->mm;\r\nstruct vm_area_struct *vma;\r\nunsigned long task_size = TASK_SIZE;\r\nif (test_thread_flag(TIF_32BIT))\r\ntask_size = STACK_TOP32;\r\nif (len & ~HPAGE_MASK)\r\nreturn -EINVAL;\r\nif (len > task_size)\r\nreturn -ENOMEM;\r\nif (flags & MAP_FIXED) {\r\nif (prepare_hugepage_range(file, addr, len))\r\nreturn -EINVAL;\r\nreturn addr;\r\n}\r\nif (addr) {\r\naddr = ALIGN(addr, HPAGE_SIZE);\r\nvma = find_vma(mm, addr);\r\nif (task_size - len >= addr &&\r\n(!vma || addr + len <= vma->vm_start))\r\nreturn addr;\r\n}\r\nif (mm->get_unmapped_area == arch_get_unmapped_area)\r\nreturn hugetlb_get_unmapped_area_bottomup(file, addr, len,\r\npgoff, flags);\r\nelse\r\nreturn hugetlb_get_unmapped_area_topdown(file, addr, len,\r\npgoff, flags);\r\n}\r\npte_t *huge_pte_alloc(struct mm_struct *mm,\r\nunsigned long addr, unsigned long sz)\r\n{\r\npgd_t *pgd;\r\npud_t *pud;\r\npmd_t *pmd;\r\npte_t *pte = NULL;\r\naddr &= HPAGE_MASK;\r\npgd = pgd_offset(mm, addr);\r\npud = pud_alloc(mm, pgd, addr);\r\nif (pud) {\r\npmd = pmd_alloc(mm, pud, addr);\r\nif (pmd)\r\npte = pte_alloc_map(mm, NULL, pmd, addr);\r\n}\r\nreturn pte;\r\n}\r\npte_t *huge_pte_offset(struct mm_struct *mm, unsigned long addr)\r\n{\r\npgd_t *pgd;\r\npud_t *pud;\r\npmd_t *pmd;\r\npte_t *pte = NULL;\r\naddr &= HPAGE_MASK;\r\npgd = pgd_offset(mm, addr);\r\nif (!pgd_none(*pgd)) {\r\npud = pud_offset(pgd, addr);\r\nif (!pud_none(*pud)) {\r\npmd = pmd_offset(pud, addr);\r\nif (!pmd_none(*pmd))\r\npte = pte_offset_map(pmd, addr);\r\n}\r\n}\r\nreturn pte;\r\n}\r\nint huge_pmd_unshare(struct mm_struct *mm, unsigned long *addr, pte_t *ptep)\r\n{\r\nreturn 0;\r\n}\r\nvoid set_huge_pte_at(struct mm_struct *mm, unsigned long addr,\r\npte_t *ptep, pte_t entry)\r\n{\r\nint i;\r\nif (!pte_present(*ptep) && pte_present(entry))\r\nmm->context.huge_pte_count++;\r\naddr &= HPAGE_MASK;\r\nfor (i = 0; i < (1 << HUGETLB_PAGE_ORDER); i++) {\r\nset_pte_at(mm, addr, ptep, entry);\r\nptep++;\r\naddr += PAGE_SIZE;\r\npte_val(entry) += PAGE_SIZE;\r\n}\r\n}\r\npte_t huge_ptep_get_and_clear(struct mm_struct *mm, unsigned long addr,\r\npte_t *ptep)\r\n{\r\npte_t entry;\r\nint i;\r\nentry = *ptep;\r\nif (pte_present(entry))\r\nmm->context.huge_pte_count--;\r\naddr &= HPAGE_MASK;\r\nfor (i = 0; i < (1 << HUGETLB_PAGE_ORDER); i++) {\r\npte_clear(mm, addr, ptep);\r\naddr += PAGE_SIZE;\r\nptep++;\r\n}\r\nreturn entry;\r\n}\r\nstruct page *follow_huge_addr(struct mm_struct *mm,\r\nunsigned long address, int write)\r\n{\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nint pmd_huge(pmd_t pmd)\r\n{\r\nreturn 0;\r\n}\r\nint pud_huge(pud_t pud)\r\n{\r\nreturn 0;\r\n}\r\nstruct page *follow_huge_pmd(struct mm_struct *mm, unsigned long address,\r\npmd_t *pmd, int write)\r\n{\r\nreturn NULL;\r\n}

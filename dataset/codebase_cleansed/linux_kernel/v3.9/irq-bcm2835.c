static void armctrl_mask_irq(struct irq_data *d)\r\n{\r\nwritel_relaxed(HWIRQ_BIT(d->hwirq), intc.disable[HWIRQ_BANK(d->hwirq)]);\r\n}\r\nstatic void armctrl_unmask_irq(struct irq_data *d)\r\n{\r\nwritel_relaxed(HWIRQ_BIT(d->hwirq), intc.enable[HWIRQ_BANK(d->hwirq)]);\r\n}\r\nstatic int armctrl_xlate(struct irq_domain *d, struct device_node *ctrlr,\r\nconst u32 *intspec, unsigned int intsize,\r\nunsigned long *out_hwirq, unsigned int *out_type)\r\n{\r\nif (WARN_ON(intsize != 2))\r\nreturn -EINVAL;\r\nif (WARN_ON(intspec[0] >= NR_BANKS))\r\nreturn -EINVAL;\r\nif (WARN_ON(intspec[1] >= IRQS_PER_BANK))\r\nreturn -EINVAL;\r\nif (WARN_ON(intspec[0] == 0 && intspec[1] >= NR_IRQS_BANK0))\r\nreturn -EINVAL;\r\n*out_hwirq = MAKE_HWIRQ(intspec[0], intspec[1]);\r\n*out_type = IRQ_TYPE_NONE;\r\nreturn 0;\r\n}\r\nstatic int __init armctrl_of_init(struct device_node *node,\r\nstruct device_node *parent)\r\n{\r\nvoid __iomem *base;\r\nint irq, b, i;\r\nbase = of_iomap(node, 0);\r\nif (!base)\r\npanic("%s: unable to map IC registers\n",\r\nnode->full_name);\r\nintc.domain = irq_domain_add_linear(node, MAKE_HWIRQ(NR_BANKS, 0),\r\n&armctrl_ops, NULL);\r\nif (!intc.domain)\r\npanic("%s: unable to create IRQ domain\n", node->full_name);\r\nfor (b = 0; b < NR_BANKS; b++) {\r\nintc.pending[b] = base + reg_pending[b];\r\nintc.enable[b] = base + reg_enable[b];\r\nintc.disable[b] = base + reg_disable[b];\r\nfor (i = 0; i < bank_irqs[b]; i++) {\r\nirq = irq_create_mapping(intc.domain, MAKE_HWIRQ(b, i));\r\nBUG_ON(irq <= 0);\r\nirq_set_chip_and_handler(irq, &armctrl_chip,\r\nhandle_level_irq);\r\nset_irq_flags(irq, IRQF_VALID | IRQF_PROBE);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nvoid __init bcm2835_init_irq(void)\r\n{\r\nof_irq_init(irq_of_match);\r\n}\r\nstatic void armctrl_handle_bank(int bank, struct pt_regs *regs)\r\n{\r\nu32 stat, irq;\r\nwhile ((stat = readl_relaxed(intc.pending[bank]))) {\r\nirq = MAKE_HWIRQ(bank, ffs(stat) - 1);\r\nhandle_IRQ(irq_linear_revmap(intc.domain, irq), regs);\r\n}\r\n}\r\nstatic void armctrl_handle_shortcut(int bank, struct pt_regs *regs,\r\nu32 stat)\r\n{\r\nu32 irq = MAKE_HWIRQ(bank, shortcuts[ffs(stat >> SHORTCUT_SHIFT) - 1]);\r\nhandle_IRQ(irq_linear_revmap(intc.domain, irq), regs);\r\n}\r\nasmlinkage void __exception_irq_entry bcm2835_handle_irq(\r\nstruct pt_regs *regs)\r\n{\r\nu32 stat, irq;\r\nwhile ((stat = readl_relaxed(intc.pending[0]) & BANK0_VALID_MASK)) {\r\nif (stat & BANK0_HWIRQ_MASK) {\r\nirq = MAKE_HWIRQ(0, ffs(stat & BANK0_HWIRQ_MASK) - 1);\r\nhandle_IRQ(irq_linear_revmap(intc.domain, irq), regs);\r\n} else if (stat & SHORTCUT1_MASK) {\r\narmctrl_handle_shortcut(1, regs, stat & SHORTCUT1_MASK);\r\n} else if (stat & SHORTCUT2_MASK) {\r\narmctrl_handle_shortcut(2, regs, stat & SHORTCUT2_MASK);\r\n} else if (stat & BANK1_HWIRQ) {\r\narmctrl_handle_bank(1, regs);\r\n} else if (stat & BANK2_HWIRQ) {\r\narmctrl_handle_bank(2, regs);\r\n} else {\r\nBUG();\r\n}\r\n}\r\n}

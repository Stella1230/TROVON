static int read_rtc_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nHV_RTCTime hvtm = hv_get_rtc();\r\ntm->tm_sec = hvtm.tm_sec;\r\ntm->tm_min = hvtm.tm_min;\r\ntm->tm_hour = hvtm.tm_hour;\r\ntm->tm_mday = hvtm.tm_mday;\r\ntm->tm_mon = hvtm.tm_mon;\r\ntm->tm_year = hvtm.tm_year;\r\ntm->tm_wday = 0;\r\ntm->tm_yday = 0;\r\ntm->tm_isdst = 0;\r\nif (rtc_valid_tm(tm) < 0)\r\ndev_warn(dev, "Read invalid date/time from RTC\n");\r\nreturn 0;\r\n}\r\nstatic int set_rtc_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nHV_RTCTime hvtm;\r\nhvtm.tm_sec = tm->tm_sec;\r\nhvtm.tm_min = tm->tm_min;\r\nhvtm.tm_hour = tm->tm_hour;\r\nhvtm.tm_mday = tm->tm_mday;\r\nhvtm.tm_mon = tm->tm_mon;\r\nhvtm.tm_year = tm->tm_year;\r\nhv_set_rtc(hvtm);\r\nreturn 0;\r\n}\r\nstatic int tile_rtc_probe(struct platform_device *dev)\r\n{\r\nstruct rtc_device *rtc;\r\nrtc = rtc_device_register("tile",\r\n&dev->dev, &tile_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc))\r\nreturn PTR_ERR(rtc);\r\nplatform_set_drvdata(dev, rtc);\r\nreturn 0;\r\n}\r\nstatic int tile_rtc_remove(struct platform_device *dev)\r\n{\r\nstruct rtc_device *rtc = platform_get_drvdata(dev);\r\nif (rtc)\r\nrtc_device_unregister(rtc);\r\nplatform_set_drvdata(dev, NULL);\r\nreturn 0;\r\n}\r\nstatic int __init tile_rtc_driver_init(void)\r\n{\r\nint err;\r\nerr = platform_driver_register(&tile_rtc_platform_driver);\r\nif (err)\r\nreturn err;\r\ntile_rtc_platform_device = platform_device_alloc("rtc-tile", 0);\r\nif (tile_rtc_platform_device == NULL) {\r\nerr = -ENOMEM;\r\ngoto exit_driver_unregister;\r\n}\r\nerr = platform_device_add(tile_rtc_platform_device);\r\nif (err)\r\ngoto exit_device_put;\r\nreturn 0;\r\nexit_device_put:\r\nplatform_device_put(tile_rtc_platform_device);\r\nexit_driver_unregister:\r\nplatform_driver_unregister(&tile_rtc_platform_driver);\r\nreturn err;\r\n}\r\nstatic void __exit tile_rtc_driver_exit(void)\r\n{\r\nplatform_driver_unregister(&tile_rtc_platform_driver);\r\n}

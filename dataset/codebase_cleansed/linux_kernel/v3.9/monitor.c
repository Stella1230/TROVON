int\r\nuf_start_sniff(unifi_priv_t *priv)\r\n{\r\nul_client_t *pcli = priv->wext_client;\r\nCSR_SIGNAL signal;\r\nCSR_MLME_SNIFFJOIN_REQUEST *req = &signal.u.MlmeSniffjoinRequest;\r\nint timeout = 1000;\r\nint r;\r\nreq->Ifindex = priv->if_index;\r\nreq->Channel = priv->wext_conf.channel;\r\nreq->ChannelStartingFactor = 0;\r\nsignal.SignalPrimitiveHeader.SignalId = CSR_MLME_SNIFFJOIN_REQUEST_ID;\r\nr = unifi_mlme_blocking_request(priv, pcli, &signal, NULL, timeout);\r\nif (r < 0) {\r\nunifi_error(priv, "failed to send SNIFFJOIN request, error %d\n", r);\r\nreturn r;\r\n}\r\nr = pcli->reply_signal->u.MlmeSniffjoinConfirm.Resultcode;\r\nif (r) {\r\nunifi_notice(priv, "SNIFFJOIN request was rejected with result 0x%X (%s)\n",\r\nr, lookup_result_code(r));\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic void\r\nnetrx_radiotap(unifi_priv_t *priv,\r\nconst CSR_MA_SNIFFDATA_INDICATION *ind,\r\nstruct sk_buff *skb_orig)\r\n{\r\nstruct net_device *dev = priv->netdev;\r\nstruct sk_buff *skb = NULL;\r\nunsigned char *ptr;\r\nunsigned char *base;\r\nint ind_data_len = skb_orig->len - 2 - ETH_HLEN;\r\nstruct unifi_rx_radiotap_header {\r\nstruct ieee80211_radiotap_header rt_hdr;\r\nu64 rt_tsft;\r\nu8 rt_flags;\r\nu8 rt_rate;\r\nu16 rt_chan;\r\nu16 rt_chan_flags;\r\nu8 rt_dbm_antsignal;\r\nu8 rt_dbm_antnoise;\r\nu8 rt_antenna;\r\nu8 pad[3];\r\n} __attribute__((__packed__));\r\nstruct unifi_rx_radiotap_header *unifi_rt;\r\nint signal, noise, snr;\r\nif (ind_data_len <= 0) {\r\nunifi_error(priv, "Invalid length in CSR_MA_SNIFFDATA_INDICATION.\n");\r\nreturn;\r\n}\r\nskb = dev_alloc_skb(ind_data_len + sizeof(struct unifi_rx_radiotap_header) + 4);\r\nif (! skb) {\r\nunifi_error(priv, "alloc_skb failed.\n");\r\npriv->stats.rx_errors++;\r\nreturn;\r\n}\r\nbase = skb->data;\r\nunifi_rt = (struct unifi_rx_radiotap_header *)\r\nskb_put(skb, sizeof(struct unifi_rx_radiotap_header));\r\nptr = skb_put(skb, ind_data_len);\r\nmemcpy(ptr, skb_orig->data, ind_data_len);\r\nunifi_rt->rt_hdr.it_version = PKTHDR_RADIOTAP_VERSION;\r\nunifi_rt->rt_hdr.it_pad = 0;\r\nunifi_rt->rt_hdr.it_len = sizeof(struct unifi_rx_radiotap_header);\r\nunifi_rt->rt_hdr.it_present = 0\r\n| (1 << IEEE80211_RADIOTAP_TSFT)\r\n| (1 << IEEE80211_RADIOTAP_FLAGS)\r\n| (1 << IEEE80211_RADIOTAP_RATE)\r\n| (1 << IEEE80211_RADIOTAP_CHANNEL)\r\n| (1 << IEEE80211_RADIOTAP_DBM_ANTSIGNAL)\r\n| (1 << IEEE80211_RADIOTAP_DBM_ANTNOISE)\r\n| (1 << IEEE80211_RADIOTAP_ANTENNA)\r\n;\r\nunifi_rt->rt_tsft = (((u64)ind->Timestamp.x[7]) | (((u64)ind->Timestamp.x[6]) << 8) |\r\n(((u64)ind->Timestamp.x[5]) << 16) | (((u64)ind->Timestamp.x[4]) << 24) |\r\n(((u64)ind->Timestamp.x[3]) << 32) | (((u64)ind->Timestamp.x[2]) << 40) |\r\n(((u64)ind->Timestamp.x[1]) << 48) | (((u64)ind->Timestamp.x[0]) << 56));\r\nunifi_rt->rt_flags = 0;\r\nunifi_rt->rt_rate = ind->Rate;\r\nunifi_rt->rt_chan = cpu_to_le16(ieee80211chan2mhz(priv->wext_conf.channel));\r\nunifi_rt->rt_chan_flags = 0;\r\nsignal = (s16)unifi2host_16(ind->Rssi);\r\nsnr = (s16)unifi2host_16(ind->Snr);\r\nnoise = signal - snr;\r\nunifi_rt->rt_dbm_antsignal = signal;\r\nunifi_rt->rt_dbm_antnoise = noise;\r\nunifi_rt->rt_antenna = ind->AntennaId;\r\nskb->dev = dev;\r\nskb->mac_header = skb->data;\r\nskb->pkt_type = PACKET_OTHERHOST;\r\nskb->protocol = __constant_htons(ETH_P_80211_RAW);\r\nmemset(skb->cb, 0, sizeof(skb->cb));\r\nnetif_rx_ni(skb);\r\ndev->last_rx = jiffies;\r\npriv->stats.rx_packets++;\r\npriv->stats.rx_bytes += ind_data_len;\r\n}\r\nstatic void\r\nnetrx_prism(unifi_priv_t *priv,\r\nconst CSR_MA_SNIFFDATA_INDICATION *ind,\r\nstruct sk_buff *skb_orig)\r\n{\r\nstruct net_device *dev = priv->netdev;\r\nstruct sk_buff *skb = NULL;\r\nunsigned char *ptr;\r\nunsigned char *base;\r\nint ind_data_len = skb_orig->len - 2 - ETH_HLEN;\r\n#define WLANCAP_MAGIC_COOKIE_V1 0x80211001\r\nstruct avs_header_v1 {\r\nuint32 version;\r\nuint32 length;\r\nuint64 mactime;\r\nuint64 hosttime;\r\nuint32 phytype;\r\nuint32 channel;\r\nuint32 datarate;\r\nuint32 antenna;\r\nuint32 priority;\r\nuint32 ssi_type;\r\nint32 ssi_signal;\r\nint32 ssi_noise;\r\nuint32 preamble;\r\nuint32 encoding;\r\n} *avs;\r\nint signal, noise, snr;\r\nif (ind_data_len <= 0) {\r\nunifi_error(priv, "Invalid length in CSR_MA_SNIFFDATA_INDICATION.\n");\r\nreturn;\r\n}\r\nskb = dev_alloc_skb(ind_data_len + sizeof(struct avs_header_v1) + 4);\r\nif (! skb) {\r\nunifi_error(priv, "alloc_skb failed.\n");\r\npriv->stats.rx_errors++;\r\nreturn;\r\n}\r\nbase = skb->data;\r\navs = (struct avs_header_v1 *)skb_put(skb, sizeof(struct avs_header_v1));\r\nptr = skb_put(skb, ind_data_len);\r\nmemcpy(ptr, skb_orig->data, ind_data_len);\r\nsignal = 0x10000 - ((s16)unifi2host_16(ind->Rssi));\r\nsnr = (s16)unifi2host_16(ind->Snr);\r\nnoise = signal - snr;\r\navs->version = htonl(WLANCAP_MAGIC_COOKIE_V1);\r\navs->length = htonl(sizeof(struct avs_header_v1));\r\navs->mactime = __cpu_to_be64(ind->Timestamp);\r\navs->hosttime = __cpu_to_be64(jiffies);\r\navs->phytype = htonl(9);\r\navs->channel = htonl(priv->wext_conf.channel);\r\navs->datarate = htonl(ind->Rate * 5);\r\navs->antenna = htonl(ind->Antenna);\r\navs->priority = htonl(0);\r\navs->ssi_type = htonl(2);\r\navs->ssi_signal = htonl(signal);\r\navs->ssi_noise = htonl(noise);\r\navs->preamble = htonl(0);\r\navs->encoding = htonl(0);\r\nskb->dev = dev;\r\nskb->mac.raw = skb->data;\r\nskb->pkt_type = PACKET_OTHERHOST;\r\nskb->protocol = __constant_htons(ETH_P_80211_RAW);\r\nmemset(skb->cb, 0, sizeof(skb->cb));\r\nnetif_rx_ni(skb);\r\ndev->last_rx = jiffies;\r\npriv->stats.rx_packets++;\r\npriv->stats.rx_bytes += ind_data_len;\r\n}\r\nvoid\r\nma_sniffdata_ind(void *ospriv,\r\nconst CSR_MA_SNIFFDATA_INDICATION *ind,\r\nconst bulk_data_param_t *bulkdata)\r\n{\r\nunifi_priv_t *priv = ospriv;\r\nstruct net_device *dev = priv->netdev;\r\nstruct sk_buff *skb = (struct sk_buff*)bulkdata->d[0].os_net_buf_ptr;\r\nif (bulkdata->d[0].data_length == 0) {\r\nunifi_warning(priv, "rx: MA-SNIFFDATA indication with zero bulk data\n");\r\nreturn;\r\n}\r\nskb->len = bulkdata->d[0].data_length;\r\nif (unlikely(!netif_running(dev))) {\r\npriv->stats.rx_dropped++;\r\npriv->wext_conf.wireless_stats.discard.misc++;\r\ndev_kfree_skb(skb);\r\nreturn;\r\n}\r\nif (ind->ReceptionStatus) {\r\npriv->stats.rx_dropped++;\r\npriv->wext_conf.wireless_stats.discard.misc++;\r\nprintk(KERN_INFO "unifi: Dropping corrupt sniff packet\n");\r\ndev_kfree_skb(skb);\r\nreturn;\r\n}\r\n#if (UNIFI_SNIFF_ARPHRD == ARPHRD_IEEE80211_PRISM)\r\nnetrx_prism(priv, ind, skb);\r\n#endif\r\n#if (UNIFI_SNIFF_ARPHRD == ARPHRD_IEEE80211_RADIOTAP)\r\nnetrx_radiotap(priv, ind, skb);\r\n#endif\r\ndev_kfree_skb(skb);\r\n}

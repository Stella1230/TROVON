static int hac_get_codec_data(struct hac_priv *hac, unsigned short r,\r\nunsigned short *v)\r\n{\r\nunsigned int to1, to2, i;\r\nunsigned short adr;\r\nfor (i = AC97_READ_RETRY; i; i--) {\r\n*v = 0;\r\nfor (to1 = TMO_E4;\r\nto1 && !(HACREG(HACRSR) & RSR_STARY);\r\n--to1)\r\nudelay(1);\r\nfor (to2 = TMO_E4;\r\nto2 && !(HACREG(HACRSR) & RSR_STDRY);\r\n--to2)\r\nudelay(1);\r\nif (!to1 && !to2)\r\nreturn 0;\r\nadr = ((HACREG(HACCSAR) & CSAR_MASK) >> CSAR_SHIFT);\r\n*v = ((HACREG(HACCSDR) & CSDR_MASK) >> CSDR_SHIFT);\r\nHACREG(HACRSR) &= ~(RSR_STDRY | RSR_STARY);\r\nif (r == adr)\r\nbreak;\r\nudelay(21);\r\n}\r\nHACREG(HACRSR) &= ~(RSR_STDRY | RSR_STARY);\r\nreturn i;\r\n}\r\nstatic unsigned short hac_read_codec_aux(struct hac_priv *hac,\r\nunsigned short reg)\r\n{\r\nunsigned short val;\r\nunsigned int i, to;\r\nfor (i = AC97_READ_RETRY; i; i--) {\r\nlocal_irq_disable();\r\nHACREG(HACTSR) &= ~(TSR_CMDAMT);\r\nHACREG(HACCSAR) = (reg << CSAR_SHIFT) | CSAR_RD;\r\nlocal_irq_enable();\r\nfor (to = TMO_E3;\r\nto && !(HACREG(HACTSR) & TSR_CMDAMT);\r\n--to)\r\nudelay(1);\r\nHACREG(HACTSR) &= ~TSR_CMDAMT;\r\nval = 0;\r\nif (hac_get_codec_data(hac, reg, &val) != 0)\r\nbreak;\r\n}\r\nreturn i ? val : ~0;\r\n}\r\nstatic void hac_ac97_write(struct snd_ac97 *ac97, unsigned short reg,\r\nunsigned short val)\r\n{\r\nint unit_id = 0 ;\r\nstruct hac_priv *hac = &hac_cpu_data[unit_id];\r\nunsigned int i, to;\r\nfor (i = AC97_WRITE_RETRY; i; i--) {\r\nlocal_irq_disable();\r\nHACREG(HACTSR) &= ~(TSR_CMDDMT | TSR_CMDAMT);\r\nHACREG(HACCSDR) = (val << CSDR_SHIFT);\r\nHACREG(HACCSAR) = (reg << CSAR_SHIFT) & (~CSAR_RD);\r\nlocal_irq_enable();\r\nfor (to = TMO_E1;\r\nto && !(HACREG(HACTSR) & (TSR_CMDAMT|TSR_CMDDMT));\r\n--to)\r\nudelay(1);\r\nHACREG(HACTSR) &= ~(TSR_CMDAMT | TSR_CMDDMT);\r\nif (to)\r\nbreak;\r\n}\r\n}\r\nstatic unsigned short hac_ac97_read(struct snd_ac97 *ac97,\r\nunsigned short reg)\r\n{\r\nint unit_id = 0 ;\r\nstruct hac_priv *hac = &hac_cpu_data[unit_id];\r\nreturn hac_read_codec_aux(hac, reg);\r\n}\r\nstatic void hac_ac97_warmrst(struct snd_ac97 *ac97)\r\n{\r\nint unit_id = 0 ;\r\nstruct hac_priv *hac = &hac_cpu_data[unit_id];\r\nunsigned int tmo;\r\nHACREG(HACCR) = CR_WMRT | CR_ST | CR_B9;\r\nmsleep(10);\r\nHACREG(HACCR) = CR_ST | CR_B9;\r\nfor (tmo = 1000; (tmo > 0) && !(HACREG(HACCR) & CR_CR); tmo--)\r\nudelay(1);\r\nif (!tmo)\r\nprintk(KERN_INFO "hac: reset: AC97 link down!\n");\r\nHACREG(HACACR) |= ACR_TX12ATOM;\r\n}\r\nstatic void hac_ac97_coldrst(struct snd_ac97 *ac97)\r\n{\r\nint unit_id = 0 ;\r\nstruct hac_priv *hac;\r\nhac = &hac_cpu_data[unit_id];\r\nHACREG(HACCR) = 0;\r\nHACREG(HACCR) = CR_CDRT | CR_ST | CR_B9;\r\nmsleep(10);\r\nhac_ac97_warmrst(ac97);\r\n}\r\nstatic int hac_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct hac_priv *hac = &hac_cpu_data[dai->id];\r\nint d = substream->stream == SNDRV_PCM_STREAM_PLAYBACK ? 0 : 1;\r\nswitch (params->msbits) {\r\ncase 16:\r\nHACREG(HACACR) |= d ? ACR_DMARX16 : ACR_DMATX16;\r\nHACREG(HACACR) &= d ? ~ACR_DMARX20 : ~ACR_DMATX20;\r\nbreak;\r\ncase 20:\r\nHACREG(HACACR) &= d ? ~ACR_DMARX16 : ~ACR_DMATX16;\r\nHACREG(HACACR) |= d ? ACR_DMARX20 : ACR_DMATX20;\r\nbreak;\r\ndefault:\r\npr_debug("hac: invalid depth %d bit\n", params->msbits);\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int hac_soc_platform_probe(struct platform_device *pdev)\r\n{\r\nreturn snd_soc_register_dais(&pdev->dev, sh4_hac_dai,\r\nARRAY_SIZE(sh4_hac_dai));\r\n}\r\nstatic int hac_soc_platform_remove(struct platform_device *pdev)\r\n{\r\nsnd_soc_unregister_dais(&pdev->dev, ARRAY_SIZE(sh4_hac_dai));\r\nreturn 0;\r\n}

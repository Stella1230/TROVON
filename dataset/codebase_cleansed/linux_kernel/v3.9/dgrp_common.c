void dgrp_carrier(struct ch_struct *ch)\r\n{\r\nstruct nd_struct *nd;\r\nint virt_carrier = 0;\r\nint phys_carrier = 0;\r\nif (!ch)\r\nreturn;\r\nnd = ch->ch_nd;\r\nif (!nd)\r\nreturn;\r\nif (ch->ch_expect & RR_STATUS)\r\nreturn;\r\nif ((ch->ch_flag & CH_HANGUP) &&\r\n(ch->ch_tun.un_open_count > 0))\r\ntty_hangup(ch->ch_tun.un_tty);\r\nif (ch->ch_s_mlast & DM_CD)\r\nphys_carrier = 1;\r\nif ((ch->ch_s_mlast & DM_CD) ||\r\n(ch->ch_digi.digi_flags & DIGI_FORCEDCD) ||\r\n(ch->ch_flag & CH_CLOCAL))\r\nvirt_carrier = 1;\r\nif (((ch->ch_flag & CH_HANGUP) == 0) &&\r\n((ch->ch_flag & CH_VIRT_CD) == 0) &&\r\n(virt_carrier == 1)) {\r\nnd->nd_tx_work = 1;\r\nif (waitqueue_active(&ch->ch_flag_wait))\r\nwake_up_interruptible(&ch->ch_flag_wait);\r\n}\r\nif ((virt_carrier == 0) &&\r\n((ch->ch_flag & CH_PHYS_CD) != 0) &&\r\n(phys_carrier == 0)) {\r\nnd->nd_tx_work = 1;\r\nch->ch_flag &= ~(CH_LOW | CH_EMPTY | CH_DRAIN | CH_INPUT);\r\nif (waitqueue_active(&ch->ch_flag_wait))\r\nwake_up_interruptible(&ch->ch_flag_wait);\r\nif (ch->ch_tun.un_open_count > 0)\r\ntty_hangup(ch->ch_tun.un_tty);\r\nif (ch->ch_pun.un_open_count > 0)\r\ntty_hangup(ch->ch_pun.un_tty);\r\n}\r\nif (virt_carrier == 1)\r\nch->ch_flag |= CH_VIRT_CD;\r\nelse\r\nch->ch_flag &= ~CH_VIRT_CD;\r\nif (phys_carrier == 1)\r\nch->ch_flag |= CH_PHYS_CD;\r\nelse\r\nch->ch_flag &= ~CH_PHYS_CD;\r\n}\r\nint dgrp_chk_perm(int mode, int op)\r\n{\r\nif (!uid_eq(GLOBAL_ROOT_UID, current_euid()))\r\nmode >>= 6;\r\nelse if (in_egroup_p(GLOBAL_ROOT_GID))\r\nmode >>= 3;\r\nif ((mode & op & 0007) == op)\r\nreturn 0;\r\nif (capable(CAP_SYS_ADMIN))\r\nreturn 0;\r\nreturn -EACCES;\r\n}\r\nint dgrp_inode_permission(struct inode *inode, int op)\r\n{\r\nreturn dgrp_chk_perm(inode->i_mode, op);\r\n}

static void sdi_config_lcd_manager(struct omap_dss_device *dssdev)\r\n{\r\nstruct omap_overlay_manager *mgr = dssdev->output->manager;\r\nsdi.mgr_config.io_pad_mode = DSS_IO_PAD_MODE_BYPASS;\r\nsdi.mgr_config.stallmode = false;\r\nsdi.mgr_config.fifohandcheck = false;\r\nsdi.mgr_config.video_port_width = 24;\r\nsdi.mgr_config.lcden_sig_polarity = 1;\r\ndss_mgr_set_lcd_config(mgr, &sdi.mgr_config);\r\n}\r\nint omapdss_sdi_display_enable(struct omap_dss_device *dssdev)\r\n{\r\nstruct omap_dss_output *out = dssdev->output;\r\nstruct omap_video_timings *t = &sdi.timings;\r\nstruct dss_clock_info dss_cinfo;\r\nstruct dispc_clock_info dispc_cinfo;\r\nunsigned long pck;\r\nint r;\r\nif (out == NULL || out->manager == NULL) {\r\nDSSERR("failed to enable display: no output/manager\n");\r\nreturn -ENODEV;\r\n}\r\nr = omap_dss_start_device(dssdev);\r\nif (r) {\r\nDSSERR("failed to start device\n");\r\ngoto err_start_dev;\r\n}\r\nr = regulator_enable(sdi.vdds_sdi_reg);\r\nif (r)\r\ngoto err_reg_enable;\r\nr = dispc_runtime_get();\r\nif (r)\r\ngoto err_get_dispc;\r\nt->data_pclk_edge = OMAPDSS_DRIVE_SIG_RISING_EDGE;\r\nt->sync_pclk_edge = OMAPDSS_DRIVE_SIG_RISING_EDGE;\r\nr = dss_calc_clock_div(t->pixel_clock * 1000, &dss_cinfo, &dispc_cinfo);\r\nif (r)\r\ngoto err_calc_clock_div;\r\nsdi.mgr_config.clock_info = dispc_cinfo;\r\npck = dss_cinfo.fck / dispc_cinfo.lck_div / dispc_cinfo.pck_div / 1000;\r\nif (pck != t->pixel_clock) {\r\nDSSWARN("Could not find exact pixel clock. Requested %d kHz, "\r\n"got %lu kHz\n",\r\nt->pixel_clock, pck);\r\nt->pixel_clock = pck;\r\n}\r\ndss_mgr_set_timings(out->manager, t);\r\nr = dss_set_clock_div(&dss_cinfo);\r\nif (r)\r\ngoto err_set_dss_clock_div;\r\nsdi_config_lcd_manager(dssdev);\r\ndispc_mgr_set_clock_div(out->manager->id, &sdi.mgr_config.clock_info);\r\ndss_sdi_init(sdi.datapairs);\r\nr = dss_sdi_enable();\r\nif (r)\r\ngoto err_sdi_enable;\r\nmdelay(2);\r\nr = dss_mgr_enable(out->manager);\r\nif (r)\r\ngoto err_mgr_enable;\r\nreturn 0;\r\nerr_mgr_enable:\r\ndss_sdi_disable();\r\nerr_sdi_enable:\r\nerr_set_dss_clock_div:\r\nerr_calc_clock_div:\r\ndispc_runtime_put();\r\nerr_get_dispc:\r\nregulator_disable(sdi.vdds_sdi_reg);\r\nerr_reg_enable:\r\nomap_dss_stop_device(dssdev);\r\nerr_start_dev:\r\nreturn r;\r\n}\r\nvoid omapdss_sdi_display_disable(struct omap_dss_device *dssdev)\r\n{\r\nstruct omap_overlay_manager *mgr = dssdev->output->manager;\r\ndss_mgr_disable(mgr);\r\ndss_sdi_disable();\r\ndispc_runtime_put();\r\nregulator_disable(sdi.vdds_sdi_reg);\r\nomap_dss_stop_device(dssdev);\r\n}\r\nvoid omapdss_sdi_set_timings(struct omap_dss_device *dssdev,\r\nstruct omap_video_timings *timings)\r\n{\r\nsdi.timings = *timings;\r\n}\r\nvoid omapdss_sdi_set_datapairs(struct omap_dss_device *dssdev, int datapairs)\r\n{\r\nsdi.datapairs = datapairs;\r\n}\r\nstatic int __init sdi_init_display(struct omap_dss_device *dssdev)\r\n{\r\nDSSDBG("SDI init\n");\r\nif (sdi.vdds_sdi_reg == NULL) {\r\nstruct regulator *vdds_sdi;\r\nvdds_sdi = dss_get_vdds_sdi();\r\nif (IS_ERR(vdds_sdi)) {\r\nDSSERR("can't get VDDS_SDI regulator\n");\r\nreturn PTR_ERR(vdds_sdi);\r\n}\r\nsdi.vdds_sdi_reg = vdds_sdi;\r\n}\r\nreturn 0;\r\n}\r\nstatic struct omap_dss_device * __init sdi_find_dssdev(struct platform_device *pdev)\r\n{\r\nstruct omap_dss_board_info *pdata = pdev->dev.platform_data;\r\nconst char *def_disp_name = omapdss_get_default_display_name();\r\nstruct omap_dss_device *def_dssdev;\r\nint i;\r\ndef_dssdev = NULL;\r\nfor (i = 0; i < pdata->num_devices; ++i) {\r\nstruct omap_dss_device *dssdev = pdata->devices[i];\r\nif (dssdev->type != OMAP_DISPLAY_TYPE_SDI)\r\ncontinue;\r\nif (def_dssdev == NULL)\r\ndef_dssdev = dssdev;\r\nif (def_disp_name != NULL &&\r\nstrcmp(dssdev->name, def_disp_name) == 0) {\r\ndef_dssdev = dssdev;\r\nbreak;\r\n}\r\n}\r\nreturn def_dssdev;\r\n}\r\nstatic void __init sdi_probe_pdata(struct platform_device *sdidev)\r\n{\r\nstruct omap_dss_device *plat_dssdev;\r\nstruct omap_dss_device *dssdev;\r\nint r;\r\nplat_dssdev = sdi_find_dssdev(sdidev);\r\nif (!plat_dssdev)\r\nreturn;\r\ndssdev = dss_alloc_and_init_device(&sdidev->dev);\r\nif (!dssdev)\r\nreturn;\r\ndss_copy_device_pdata(dssdev, plat_dssdev);\r\nr = sdi_init_display(dssdev);\r\nif (r) {\r\nDSSERR("device %s init failed: %d\n", dssdev->name, r);\r\ndss_put_device(dssdev);\r\nreturn;\r\n}\r\nr = omapdss_output_set_device(&sdi.output, dssdev);\r\nif (r) {\r\nDSSERR("failed to connect output to new device: %s\n",\r\ndssdev->name);\r\ndss_put_device(dssdev);\r\nreturn;\r\n}\r\nr = dss_add_device(dssdev);\r\nif (r) {\r\nDSSERR("device %s register failed: %d\n", dssdev->name, r);\r\nomapdss_output_unset_device(&sdi.output);\r\ndss_put_device(dssdev);\r\nreturn;\r\n}\r\n}\r\nstatic void __init sdi_init_output(struct platform_device *pdev)\r\n{\r\nstruct omap_dss_output *out = &sdi.output;\r\nout->pdev = pdev;\r\nout->id = OMAP_DSS_OUTPUT_SDI;\r\nout->type = OMAP_DISPLAY_TYPE_SDI;\r\ndss_register_output(out);\r\n}\r\nstatic void __exit sdi_uninit_output(struct platform_device *pdev)\r\n{\r\nstruct omap_dss_output *out = &sdi.output;\r\ndss_unregister_output(out);\r\n}\r\nstatic int __init omap_sdi_probe(struct platform_device *pdev)\r\n{\r\nsdi_init_output(pdev);\r\nsdi_probe_pdata(pdev);\r\nreturn 0;\r\n}\r\nstatic int __exit omap_sdi_remove(struct platform_device *pdev)\r\n{\r\ndss_unregister_child_devices(&pdev->dev);\r\nsdi_uninit_output(pdev);\r\nreturn 0;\r\n}\r\nint __init sdi_init_platform_driver(void)\r\n{\r\nreturn platform_driver_probe(&omap_sdi_driver, omap_sdi_probe);\r\n}\r\nvoid __exit sdi_uninit_platform_driver(void)\r\n{\r\nplatform_driver_unregister(&omap_sdi_driver);\r\n}

static int rear_amp_power(struct snd_soc_codec *codec, int power)\r\n{\r\nunsigned short reg;\r\nif (power) {\r\nreg = snd_soc_read(codec, AC97_GPIO_CFG);\r\nsnd_soc_write(codec, AC97_GPIO_CFG, reg | 0x0100);\r\nreg = snd_soc_read(codec, AC97_GPIO_PULL);\r\nsnd_soc_write(codec, AC97_GPIO_PULL, reg | (1<<15));\r\n} else {\r\nreg = snd_soc_read(codec, AC97_GPIO_CFG);\r\nsnd_soc_write(codec, AC97_GPIO_CFG, reg & ~0x0100);\r\nreg = snd_soc_read(codec, AC97_GPIO_PULL);\r\nsnd_soc_write(codec, AC97_GPIO_PULL, reg & ~(1<<15));\r\n}\r\nreturn 0;\r\n}\r\nstatic int rear_amp_event(struct snd_soc_dapm_widget *widget,\r\nstruct snd_kcontrol *kctl, int event)\r\n{\r\nstruct snd_soc_codec *codec = widget->codec;\r\nreturn rear_amp_power(codec, SND_SOC_DAPM_EVENT_ON(event));\r\n}\r\nstatic int mioa701_wm9713_init(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct snd_soc_codec *codec = rtd->codec;\r\nstruct snd_soc_dapm_context *dapm = &codec->dapm;\r\nunsigned short reg;\r\nsnd_soc_dapm_new_controls(dapm, ARRAY_AND_SIZE(mioa701_dapm_widgets));\r\nsnd_soc_dapm_add_routes(dapm, ARRAY_AND_SIZE(audio_map));\r\nreg = codec->driver->read(codec, AC97_GPIO_CFG);\r\ncodec->driver->write(codec, AC97_GPIO_CFG, reg | 0x0100);\r\nreg = codec->driver->read(codec, AC97_3D_CONTROL);\r\ncodec->driver->write(codec, AC97_3D_CONTROL, reg | 0xc000);\r\nsnd_soc_dapm_enable_pin(dapm, "Front Speaker");\r\nsnd_soc_dapm_enable_pin(dapm, "Rear Speaker");\r\nsnd_soc_dapm_enable_pin(dapm, "Front Mic");\r\nsnd_soc_dapm_enable_pin(dapm, "GSM Line In");\r\nsnd_soc_dapm_enable_pin(dapm, "GSM Line Out");\r\nreturn 0;\r\n}\r\nstatic int mioa701_wm9713_probe(struct platform_device *pdev)\r\n{\r\nint rc;\r\nif (!machine_is_mioa701())\r\nreturn -ENODEV;\r\nmioa701.dev = &pdev->dev;\r\nrc = snd_soc_register_card(&mioa701);\r\nif (!rc)\r\ndev_warn(&pdev->dev, "Be warned that incorrect mixers/muxes setup will"\r\n"lead to overheating and possible destruction of your device."\r\n" Do not use without a good knowledge of mio's board design!\n");\r\nreturn rc;\r\n}\r\nstatic int mioa701_wm9713_remove(struct platform_device *pdev)\r\n{\r\nstruct snd_soc_card *card = platform_get_drvdata(pdev);\r\nsnd_soc_unregister_card(card);\r\nreturn 0;\r\n}

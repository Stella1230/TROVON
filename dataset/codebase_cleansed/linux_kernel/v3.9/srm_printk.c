long\r\nsrm_printk(const char *fmt, ...)\r\n{\r\nstatic char buf[1024];\r\nva_list args;\r\nlong len, num_lf;\r\nchar *src, *dst;\r\nva_start(args, fmt);\r\nlen = vsprintf(buf, fmt, args);\r\nva_end(args);\r\nnum_lf = 0;\r\nfor (src = buf; *src; ++src) {\r\nif (*src == '\n') {\r\n++num_lf;\r\n}\r\n}\r\nif (num_lf) {\r\nfor (dst = src + num_lf; src >= buf; ) {\r\nif (*src == '\n') {\r\n*dst-- = '\r';\r\n}\r\n*dst-- = *src--;\r\n}\r\n}\r\nsrm_puts(buf, num_lf+len);\r\nreturn len;\r\n}

static int xtsonic_open(struct net_device *dev)\r\n{\r\nint retval;\r\nretval = request_irq(dev->irq, sonic_interrupt, IRQF_DISABLED,\r\n"sonic", dev);\r\nif (retval) {\r\nprintk(KERN_ERR "%s: unable to get IRQ %d.\n",\r\ndev->name, dev->irq);\r\nreturn -EAGAIN;\r\n}\r\nretval = sonic_open(dev);\r\nif (retval)\r\nfree_irq(dev->irq, dev);\r\nreturn retval;\r\n}\r\nstatic int xtsonic_close(struct net_device *dev)\r\n{\r\nint err;\r\nerr = sonic_close(dev);\r\nfree_irq(dev->irq, dev);\r\nreturn err;\r\n}\r\nstatic int __init sonic_probe1(struct net_device *dev)\r\n{\r\nstatic unsigned version_printed = 0;\r\nunsigned int silicon_revision;\r\nstruct sonic_local *lp = netdev_priv(dev);\r\nunsigned int base_addr = dev->base_addr;\r\nint i;\r\nint err = 0;\r\nif (!request_mem_region(base_addr, 0x100, xtsonic_string))\r\nreturn -EBUSY;\r\nsilicon_revision = SONIC_READ(SONIC_SR);\r\nif (sonic_debug > 1)\r\nprintk("SONIC Silicon Revision = 0x%04x\n",silicon_revision);\r\ni = 0;\r\nwhile ((known_revisions[i] != 0xffff) &&\r\n(known_revisions[i] != silicon_revision))\r\ni++;\r\nif (known_revisions[i] == 0xffff) {\r\nprintk("SONIC ethernet controller not found (0x%4x)\n",\r\nsilicon_revision);\r\nreturn -ENODEV;\r\n}\r\nif (sonic_debug && version_printed++ == 0)\r\nprintk(version);\r\nSONIC_WRITE(SONIC_CMD,SONIC_CR_RST);\r\nSONIC_WRITE(SONIC_DCR,\r\nSONIC_DCR_WC0|SONIC_DCR_DW|SONIC_DCR_LBR|SONIC_DCR_SBUS);\r\nSONIC_WRITE(SONIC_CEP,0);\r\nSONIC_WRITE(SONIC_IMR,0);\r\nSONIC_WRITE(SONIC_CMD,SONIC_CR_RST);\r\nSONIC_WRITE(SONIC_CEP,0);\r\nfor (i=0; i<3; i++) {\r\nunsigned int val = SONIC_READ(SONIC_CAP0-i);\r\ndev->dev_addr[i*2] = val;\r\ndev->dev_addr[i*2+1] = val >> 8;\r\n}\r\nlp->dma_bitmode = SONIC_BITMODE32;\r\nlp->descriptors =\r\ndma_alloc_coherent(lp->device,\r\nSIZEOF_SONIC_DESC * SONIC_BUS_SCALE(lp->dma_bitmode),\r\n&lp->descriptors_laddr, GFP_KERNEL);\r\nif (lp->descriptors == NULL) {\r\nprintk(KERN_ERR "%s: couldn't alloc DMA memory for "\r\n" descriptors.\n", dev_name(lp->device));\r\nerr = -ENOMEM;\r\ngoto out;\r\n}\r\nlp->cda = lp->descriptors;\r\nlp->tda = lp->cda + (SIZEOF_SONIC_CDA\r\n* SONIC_BUS_SCALE(lp->dma_bitmode));\r\nlp->rda = lp->tda + (SIZEOF_SONIC_TD * SONIC_NUM_TDS\r\n* SONIC_BUS_SCALE(lp->dma_bitmode));\r\nlp->rra = lp->rda + (SIZEOF_SONIC_RD * SONIC_NUM_RDS\r\n* SONIC_BUS_SCALE(lp->dma_bitmode));\r\nlp->cda_laddr = lp->descriptors_laddr;\r\nlp->tda_laddr = lp->cda_laddr + (SIZEOF_SONIC_CDA\r\n* SONIC_BUS_SCALE(lp->dma_bitmode));\r\nlp->rda_laddr = lp->tda_laddr + (SIZEOF_SONIC_TD * SONIC_NUM_TDS\r\n* SONIC_BUS_SCALE(lp->dma_bitmode));\r\nlp->rra_laddr = lp->rda_laddr + (SIZEOF_SONIC_RD * SONIC_NUM_RDS\r\n* SONIC_BUS_SCALE(lp->dma_bitmode));\r\ndev->netdev_ops = &xtsonic_netdev_ops;\r\ndev->watchdog_timeo = TX_TIMEOUT;\r\nSONIC_WRITE(SONIC_CRCT,0xffff);\r\nSONIC_WRITE(SONIC_FAET,0xffff);\r\nSONIC_WRITE(SONIC_MPT,0xffff);\r\nreturn 0;\r\nout:\r\nrelease_region(dev->base_addr, SONIC_MEM_SIZE);\r\nreturn err;\r\n}\r\nint xtsonic_probe(struct platform_device *pdev)\r\n{\r\nstruct net_device *dev;\r\nstruct sonic_local *lp;\r\nstruct resource *resmem, *resirq;\r\nint err = 0;\r\nif ((resmem = platform_get_resource(pdev, IORESOURCE_MEM, 0)) == NULL)\r\nreturn -ENODEV;\r\nif ((resirq = platform_get_resource(pdev, IORESOURCE_IRQ, 0)) == NULL)\r\nreturn -ENODEV;\r\nif ((dev = alloc_etherdev(sizeof(struct sonic_local))) == NULL)\r\nreturn -ENOMEM;\r\nlp = netdev_priv(dev);\r\nlp->device = &pdev->dev;\r\nSET_NETDEV_DEV(dev, &pdev->dev);\r\nnetdev_boot_setup_check(dev);\r\ndev->base_addr = resmem->start;\r\ndev->irq = resirq->start;\r\nif ((err = sonic_probe1(dev)))\r\ngoto out;\r\nif ((err = register_netdev(dev)))\r\ngoto out1;\r\nprintk("%s: SONIC ethernet @%08lx, MAC %pM, IRQ %d\n", dev->name,\r\ndev->base_addr, dev->dev_addr, dev->irq);\r\nreturn 0;\r\nout1:\r\nrelease_region(dev->base_addr, SONIC_MEM_SIZE);\r\nout:\r\nfree_netdev(dev);\r\nreturn err;\r\n}\r\nstatic int xtsonic_device_remove(struct platform_device *pdev)\r\n{\r\nstruct net_device *dev = platform_get_drvdata(pdev);\r\nstruct sonic_local *lp = netdev_priv(dev);\r\nunregister_netdev(dev);\r\ndma_free_coherent(lp->device,\r\nSIZEOF_SONIC_DESC * SONIC_BUS_SCALE(lp->dma_bitmode),\r\nlp->descriptors, lp->descriptors_laddr);\r\nrelease_region (dev->base_addr, SONIC_MEM_SIZE);\r\nfree_netdev(dev);\r\nreturn 0;\r\n}

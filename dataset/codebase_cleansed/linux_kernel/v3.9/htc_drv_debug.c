static ssize_t read_file_tgt_int_stats(struct file *file, char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath9k_htc_priv *priv = file->private_data;\r\nstruct ath9k_htc_target_int_stats cmd_rsp;\r\nchar buf[512];\r\nunsigned int len = 0;\r\nint ret = 0;\r\nmemset(&cmd_rsp, 0, sizeof(cmd_rsp));\r\nath9k_htc_ps_wakeup(priv);\r\nWMI_CMD(WMI_INT_STATS_CMDID);\r\nif (ret) {\r\nath9k_htc_ps_restore(priv);\r\nreturn -EINVAL;\r\n}\r\nath9k_htc_ps_restore(priv);\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "RX",\r\nbe32_to_cpu(cmd_rsp.rx));\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "RXORN",\r\nbe32_to_cpu(cmd_rsp.rxorn));\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "RXEOL",\r\nbe32_to_cpu(cmd_rsp.rxeol));\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "TXURN",\r\nbe32_to_cpu(cmd_rsp.txurn));\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "TXTO",\r\nbe32_to_cpu(cmd_rsp.txto));\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "CST",\r\nbe32_to_cpu(cmd_rsp.cst));\r\nif (len > sizeof(buf))\r\nlen = sizeof(buf);\r\nreturn simple_read_from_buffer(user_buf, count, ppos, buf, len);\r\n}\r\nstatic ssize_t read_file_tgt_tx_stats(struct file *file, char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath9k_htc_priv *priv = file->private_data;\r\nstruct ath9k_htc_target_tx_stats cmd_rsp;\r\nchar buf[512];\r\nunsigned int len = 0;\r\nint ret = 0;\r\nmemset(&cmd_rsp, 0, sizeof(cmd_rsp));\r\nath9k_htc_ps_wakeup(priv);\r\nWMI_CMD(WMI_TX_STATS_CMDID);\r\nif (ret) {\r\nath9k_htc_ps_restore(priv);\r\nreturn -EINVAL;\r\n}\r\nath9k_htc_ps_restore(priv);\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "Xretries",\r\nbe32_to_cpu(cmd_rsp.xretries));\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "FifoErr",\r\nbe32_to_cpu(cmd_rsp.fifoerr));\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "Filtered",\r\nbe32_to_cpu(cmd_rsp.filtered));\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "TimerExp",\r\nbe32_to_cpu(cmd_rsp.timer_exp));\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "ShortRetries",\r\nbe32_to_cpu(cmd_rsp.shortretries));\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "LongRetries",\r\nbe32_to_cpu(cmd_rsp.longretries));\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "QueueNull",\r\nbe32_to_cpu(cmd_rsp.qnull));\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "EncapFail",\r\nbe32_to_cpu(cmd_rsp.encap_fail));\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "NoBuf",\r\nbe32_to_cpu(cmd_rsp.nobuf));\r\nif (len > sizeof(buf))\r\nlen = sizeof(buf);\r\nreturn simple_read_from_buffer(user_buf, count, ppos, buf, len);\r\n}\r\nstatic ssize_t read_file_tgt_rx_stats(struct file *file, char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath9k_htc_priv *priv = file->private_data;\r\nstruct ath9k_htc_target_rx_stats cmd_rsp;\r\nchar buf[512];\r\nunsigned int len = 0;\r\nint ret = 0;\r\nmemset(&cmd_rsp, 0, sizeof(cmd_rsp));\r\nath9k_htc_ps_wakeup(priv);\r\nWMI_CMD(WMI_RX_STATS_CMDID);\r\nif (ret) {\r\nath9k_htc_ps_restore(priv);\r\nreturn -EINVAL;\r\n}\r\nath9k_htc_ps_restore(priv);\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "NoBuf",\r\nbe32_to_cpu(cmd_rsp.nobuf));\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "HostSend",\r\nbe32_to_cpu(cmd_rsp.host_send));\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "HostDone",\r\nbe32_to_cpu(cmd_rsp.host_done));\r\nif (len > sizeof(buf))\r\nlen = sizeof(buf);\r\nreturn simple_read_from_buffer(user_buf, count, ppos, buf, len);\r\n}\r\nstatic ssize_t read_file_xmit(struct file *file, char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath9k_htc_priv *priv = file->private_data;\r\nchar buf[512];\r\nunsigned int len = 0;\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "Buffers queued",\r\npriv->debug.tx_stats.buf_queued);\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "Buffers completed",\r\npriv->debug.tx_stats.buf_completed);\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "SKBs queued",\r\npriv->debug.tx_stats.skb_queued);\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "SKBs success",\r\npriv->debug.tx_stats.skb_success);\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "SKBs failed",\r\npriv->debug.tx_stats.skb_failed);\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "CAB queued",\r\npriv->debug.tx_stats.cab_queued);\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "BE queued",\r\npriv->debug.tx_stats.queue_stats[IEEE80211_AC_BE]);\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "BK queued",\r\npriv->debug.tx_stats.queue_stats[IEEE80211_AC_BK]);\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "VI queued",\r\npriv->debug.tx_stats.queue_stats[IEEE80211_AC_VI]);\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"%20s : %10u\n", "VO queued",\r\npriv->debug.tx_stats.queue_stats[IEEE80211_AC_VO]);\r\nif (len > sizeof(buf))\r\nlen = sizeof(buf);\r\nreturn simple_read_from_buffer(user_buf, count, ppos, buf, len);\r\n}\r\nvoid ath9k_htc_err_stat_rx(struct ath9k_htc_priv *priv,\r\nstruct ath_htc_rx_status *rxs)\r\n{\r\n#define RX_PHY_ERR_INC(c) priv->debug.rx_stats.err_phy_stats[c]++\r\nif (rxs->rs_status & ATH9K_RXERR_CRC)\r\npriv->debug.rx_stats.err_crc++;\r\nif (rxs->rs_status & ATH9K_RXERR_DECRYPT)\r\npriv->debug.rx_stats.err_decrypt_crc++;\r\nif (rxs->rs_status & ATH9K_RXERR_MIC)\r\npriv->debug.rx_stats.err_mic++;\r\nif (rxs->rs_status & ATH9K_RX_DELIM_CRC_PRE)\r\npriv->debug.rx_stats.err_pre_delim++;\r\nif (rxs->rs_status & ATH9K_RX_DELIM_CRC_POST)\r\npriv->debug.rx_stats.err_post_delim++;\r\nif (rxs->rs_status & ATH9K_RX_DECRYPT_BUSY)\r\npriv->debug.rx_stats.err_decrypt_busy++;\r\nif (rxs->rs_status & ATH9K_RXERR_PHY) {\r\npriv->debug.rx_stats.err_phy++;\r\nif (rxs->rs_phyerr < ATH9K_PHYERR_MAX)\r\nRX_PHY_ERR_INC(rxs->rs_phyerr);\r\n}\r\n#undef RX_PHY_ERR_INC\r\n}\r\nstatic ssize_t read_file_recv(struct file *file, char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\n#define PHY_ERR(s, p) \\r\nlen += snprintf(buf + len, size - len, "%20s : %10u\n", s, \\r\npriv->debug.rx_stats.err_phy_stats[p]);\r\nstruct ath9k_htc_priv *priv = file->private_data;\r\nchar *buf;\r\nunsigned int len = 0, size = 1500;\r\nssize_t retval = 0;\r\nbuf = kzalloc(size, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn -ENOMEM;\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10u\n", "SKBs allocated",\r\npriv->debug.rx_stats.skb_allocated);\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10u\n", "SKBs completed",\r\npriv->debug.rx_stats.skb_completed);\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10u\n", "SKBs Dropped",\r\npriv->debug.rx_stats.skb_dropped);\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10u\n", "CRC ERR",\r\npriv->debug.rx_stats.err_crc);\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10u\n", "DECRYPT CRC ERR",\r\npriv->debug.rx_stats.err_decrypt_crc);\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10u\n", "MIC ERR",\r\npriv->debug.rx_stats.err_mic);\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10u\n", "PRE-DELIM CRC ERR",\r\npriv->debug.rx_stats.err_pre_delim);\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10u\n", "POST-DELIM CRC ERR",\r\npriv->debug.rx_stats.err_post_delim);\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10u\n", "DECRYPT BUSY ERR",\r\npriv->debug.rx_stats.err_decrypt_busy);\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10u\n", "TOTAL PHY ERR",\r\npriv->debug.rx_stats.err_phy);\r\nPHY_ERR("UNDERRUN", ATH9K_PHYERR_UNDERRUN);\r\nPHY_ERR("TIMING", ATH9K_PHYERR_TIMING);\r\nPHY_ERR("PARITY", ATH9K_PHYERR_PARITY);\r\nPHY_ERR("RATE", ATH9K_PHYERR_RATE);\r\nPHY_ERR("LENGTH", ATH9K_PHYERR_LENGTH);\r\nPHY_ERR("RADAR", ATH9K_PHYERR_RADAR);\r\nPHY_ERR("SERVICE", ATH9K_PHYERR_SERVICE);\r\nPHY_ERR("TOR", ATH9K_PHYERR_TOR);\r\nPHY_ERR("OFDM-TIMING", ATH9K_PHYERR_OFDM_TIMING);\r\nPHY_ERR("OFDM-SIGNAL-PARITY", ATH9K_PHYERR_OFDM_SIGNAL_PARITY);\r\nPHY_ERR("OFDM-RATE", ATH9K_PHYERR_OFDM_RATE_ILLEGAL);\r\nPHY_ERR("OFDM-LENGTH", ATH9K_PHYERR_OFDM_LENGTH_ILLEGAL);\r\nPHY_ERR("OFDM-POWER-DROP", ATH9K_PHYERR_OFDM_POWER_DROP);\r\nPHY_ERR("OFDM-SERVICE", ATH9K_PHYERR_OFDM_SERVICE);\r\nPHY_ERR("OFDM-RESTART", ATH9K_PHYERR_OFDM_RESTART);\r\nPHY_ERR("FALSE-RADAR-EXT", ATH9K_PHYERR_FALSE_RADAR_EXT);\r\nPHY_ERR("CCK-TIMING", ATH9K_PHYERR_CCK_TIMING);\r\nPHY_ERR("CCK-HEADER-CRC", ATH9K_PHYERR_CCK_HEADER_CRC);\r\nPHY_ERR("CCK-RATE", ATH9K_PHYERR_CCK_RATE_ILLEGAL);\r\nPHY_ERR("CCK-SERVICE", ATH9K_PHYERR_CCK_SERVICE);\r\nPHY_ERR("CCK-RESTART", ATH9K_PHYERR_CCK_RESTART);\r\nPHY_ERR("CCK-LENGTH", ATH9K_PHYERR_CCK_LENGTH_ILLEGAL);\r\nPHY_ERR("CCK-POWER-DROP", ATH9K_PHYERR_CCK_POWER_DROP);\r\nPHY_ERR("HT-CRC", ATH9K_PHYERR_HT_CRC_ERROR);\r\nPHY_ERR("HT-LENGTH", ATH9K_PHYERR_HT_LENGTH_ILLEGAL);\r\nPHY_ERR("HT-RATE", ATH9K_PHYERR_HT_RATE_ILLEGAL);\r\nif (len > size)\r\nlen = size;\r\nretval = simple_read_from_buffer(user_buf, count, ppos, buf, len);\r\nkfree(buf);\r\nreturn retval;\r\n#undef PHY_ERR\r\n}\r\nstatic ssize_t read_file_slot(struct file *file, char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath9k_htc_priv *priv = file->private_data;\r\nchar buf[512];\r\nunsigned int len = 0;\r\nspin_lock_bh(&priv->tx.tx_lock);\r\nlen += snprintf(buf + len, sizeof(buf) - len, "TX slot bitmap : ");\r\nlen += bitmap_scnprintf(buf + len, sizeof(buf) - len,\r\npriv->tx.tx_slot, MAX_TX_BUF_NUM);\r\nlen += snprintf(buf + len, sizeof(buf) - len, "\n");\r\nlen += snprintf(buf + len, sizeof(buf) - len,\r\n"Used slots : %d\n",\r\nbitmap_weight(priv->tx.tx_slot, MAX_TX_BUF_NUM));\r\nspin_unlock_bh(&priv->tx.tx_lock);\r\nif (len > sizeof(buf))\r\nlen = sizeof(buf);\r\nreturn simple_read_from_buffer(user_buf, count, ppos, buf, len);\r\n}\r\nstatic ssize_t read_file_queue(struct file *file, char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath9k_htc_priv *priv = file->private_data;\r\nchar buf[512];\r\nunsigned int len = 0;\r\nlen += snprintf(buf + len, sizeof(buf) - len, "%20s : %10u\n",\r\n"Mgmt endpoint", skb_queue_len(&priv->tx.mgmt_ep_queue));\r\nlen += snprintf(buf + len, sizeof(buf) - len, "%20s : %10u\n",\r\n"Cab endpoint", skb_queue_len(&priv->tx.cab_ep_queue));\r\nlen += snprintf(buf + len, sizeof(buf) - len, "%20s : %10u\n",\r\n"Data BE endpoint", skb_queue_len(&priv->tx.data_be_queue));\r\nlen += snprintf(buf + len, sizeof(buf) - len, "%20s : %10u\n",\r\n"Data BK endpoint", skb_queue_len(&priv->tx.data_bk_queue));\r\nlen += snprintf(buf + len, sizeof(buf) - len, "%20s : %10u\n",\r\n"Data VI endpoint", skb_queue_len(&priv->tx.data_vi_queue));\r\nlen += snprintf(buf + len, sizeof(buf) - len, "%20s : %10u\n",\r\n"Data VO endpoint", skb_queue_len(&priv->tx.data_vo_queue));\r\nlen += snprintf(buf + len, sizeof(buf) - len, "%20s : %10u\n",\r\n"Failed queue", skb_queue_len(&priv->tx.tx_failed));\r\nspin_lock_bh(&priv->tx.tx_lock);\r\nlen += snprintf(buf + len, sizeof(buf) - len, "%20s : %10u\n",\r\n"Queued count", priv->tx.queued_cnt);\r\nspin_unlock_bh(&priv->tx.tx_lock);\r\nif (len > sizeof(buf))\r\nlen = sizeof(buf);\r\nreturn simple_read_from_buffer(user_buf, count, ppos, buf, len);\r\n}\r\nstatic ssize_t read_file_debug(struct file *file, char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath9k_htc_priv *priv = file->private_data;\r\nstruct ath_common *common = ath9k_hw_common(priv->ah);\r\nchar buf[32];\r\nunsigned int len;\r\nlen = sprintf(buf, "0x%08x\n", common->debug_mask);\r\nreturn simple_read_from_buffer(user_buf, count, ppos, buf, len);\r\n}\r\nstatic ssize_t write_file_debug(struct file *file, const char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath9k_htc_priv *priv = file->private_data;\r\nstruct ath_common *common = ath9k_hw_common(priv->ah);\r\nunsigned long mask;\r\nchar buf[32];\r\nssize_t len;\r\nlen = min(count, sizeof(buf) - 1);\r\nif (copy_from_user(buf, user_buf, len))\r\nreturn -EFAULT;\r\nbuf[len] = '\0';\r\nif (strict_strtoul(buf, 0, &mask))\r\nreturn -EINVAL;\r\ncommon->debug_mask = mask;\r\nreturn count;\r\n}\r\nstatic ssize_t read_file_base_eeprom(struct file *file, char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath9k_htc_priv *priv = file->private_data;\r\nstruct ath_common *common = ath9k_hw_common(priv->ah);\r\nstruct base_eep_header *pBase = NULL;\r\nunsigned int len = 0, size = 1500;\r\nssize_t retval = 0;\r\nchar *buf;\r\nif (AR_SREV_9271(priv->ah))\r\npBase = (struct base_eep_header *)\r\n&priv->ah->eeprom.map4k.baseEepHeader;\r\nelse if (priv->ah->hw_version.usbdev == AR9280_USB)\r\npBase = (struct base_eep_header *)\r\n&priv->ah->eeprom.def.baseEepHeader;\r\nelse if (priv->ah->hw_version.usbdev == AR9287_USB)\r\npBase = (struct base_eep_header *)\r\n&priv->ah->eeprom.map9287.baseEepHeader;\r\nif (pBase == NULL) {\r\nath_err(common, "Unknown EEPROM type\n");\r\nreturn 0;\r\n}\r\nbuf = kzalloc(size, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn -ENOMEM;\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10d\n", "Major Version",\r\npBase->version >> 12);\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10d\n", "Minor Version",\r\npBase->version & 0xFFF);\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10d\n", "Checksum",\r\npBase->checksum);\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10d\n", "Length",\r\npBase->length);\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10d\n", "RegDomain1",\r\npBase->regDmn[0]);\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10d\n", "RegDomain2",\r\npBase->regDmn[1]);\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10d\n",\r\n"TX Mask", pBase->txMask);\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10d\n",\r\n"RX Mask", pBase->rxMask);\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10d\n",\r\n"Allow 5GHz",\r\n!!(pBase->opCapFlags & AR5416_OPFLAGS_11A));\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10d\n",\r\n"Allow 2GHz",\r\n!!(pBase->opCapFlags & AR5416_OPFLAGS_11G));\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10d\n",\r\n"Disable 2GHz HT20",\r\n!!(pBase->opCapFlags & AR5416_OPFLAGS_N_2G_HT20));\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10d\n",\r\n"Disable 2GHz HT40",\r\n!!(pBase->opCapFlags & AR5416_OPFLAGS_N_2G_HT40));\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10d\n",\r\n"Disable 5Ghz HT20",\r\n!!(pBase->opCapFlags & AR5416_OPFLAGS_N_5G_HT20));\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10d\n",\r\n"Disable 5Ghz HT40",\r\n!!(pBase->opCapFlags & AR5416_OPFLAGS_N_5G_HT40));\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10d\n",\r\n"Big Endian",\r\n!!(pBase->eepMisc & 0x01));\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10d\n",\r\n"Cal Bin Major Ver",\r\n(pBase->binBuildNumber >> 24) & 0xFF);\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10d\n",\r\n"Cal Bin Minor Ver",\r\n(pBase->binBuildNumber >> 16) & 0xFF);\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10d\n",\r\n"Cal Bin Build",\r\n(pBase->binBuildNumber >> 8) & 0xFF);\r\nif (AR_SREV_9271(priv->ah)) {\r\nstruct base_eep_header_4k *pBase4k =\r\n&priv->ah->eeprom.map4k.baseEepHeader;\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10d\n",\r\n"TX Gain type",\r\npBase4k->txGainType);\r\n}\r\nif (priv->ah->hw_version.usbdev == AR9287_USB) {\r\nstruct base_eep_ar9287_header *pBase9287 =\r\n&priv->ah->eeprom.map9287.baseEepHeader;\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10ddB\n",\r\n"Power Table Offset",\r\npBase9287->pwrTableOffset);\r\nlen += snprintf(buf + len, size - len,\r\n"%20s : %10d\n",\r\n"OpenLoop Power Ctrl",\r\npBase9287->openLoopPwrCntl);\r\n}\r\nlen += snprintf(buf + len, size - len, "%20s : %pM\n", "MacAddress",\r\npBase->macAddr);\r\nif (len > size)\r\nlen = size;\r\nretval = simple_read_from_buffer(user_buf, count, ppos, buf, len);\r\nkfree(buf);\r\nreturn retval;\r\n}\r\nstatic ssize_t read_4k_modal_eeprom(struct file *file,\r\nchar __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\n#define PR_EEP(_s, _val) \\r\ndo { \\r\nlen += snprintf(buf + len, size - len, "%20s : %10d\n", \\r\n_s, (_val)); \\r\n} while (0)\r\nstruct ath9k_htc_priv *priv = file->private_data;\r\nstruct modal_eep_4k_header *pModal = &priv->ah->eeprom.map4k.modalHeader;\r\nunsigned int len = 0, size = 2048;\r\nssize_t retval = 0;\r\nchar *buf;\r\nbuf = kzalloc(size, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn -ENOMEM;\r\nPR_EEP("Chain0 Ant. Control", pModal->antCtrlChain[0]);\r\nPR_EEP("Ant. Common Control", pModal->antCtrlCommon);\r\nPR_EEP("Chain0 Ant. Gain", pModal->antennaGainCh[0]);\r\nPR_EEP("Switch Settle", pModal->switchSettling);\r\nPR_EEP("Chain0 TxRxAtten", pModal->txRxAttenCh[0]);\r\nPR_EEP("Chain0 RxTxMargin", pModal->rxTxMarginCh[0]);\r\nPR_EEP("ADC Desired size", pModal->adcDesiredSize);\r\nPR_EEP("PGA Desired size", pModal->pgaDesiredSize);\r\nPR_EEP("Chain0 xlna Gain", pModal->xlnaGainCh[0]);\r\nPR_EEP("txEndToXpaOff", pModal->txEndToXpaOff);\r\nPR_EEP("txEndToRxOn", pModal->txEndToRxOn);\r\nPR_EEP("txFrameToXpaOn", pModal->txFrameToXpaOn);\r\nPR_EEP("CCA Threshold)", pModal->thresh62);\r\nPR_EEP("Chain0 NF Threshold", pModal->noiseFloorThreshCh[0]);\r\nPR_EEP("xpdGain", pModal->xpdGain);\r\nPR_EEP("External PD", pModal->xpd);\r\nPR_EEP("Chain0 I Coefficient", pModal->iqCalICh[0]);\r\nPR_EEP("Chain0 Q Coefficient", pModal->iqCalQCh[0]);\r\nPR_EEP("pdGainOverlap", pModal->pdGainOverlap);\r\nPR_EEP("O/D Bias Version", pModal->version);\r\nPR_EEP("CCK OutputBias", pModal->ob_0);\r\nPR_EEP("BPSK OutputBias", pModal->ob_1);\r\nPR_EEP("QPSK OutputBias", pModal->ob_2);\r\nPR_EEP("16QAM OutputBias", pModal->ob_3);\r\nPR_EEP("64QAM OutputBias", pModal->ob_4);\r\nPR_EEP("CCK Driver1_Bias", pModal->db1_0);\r\nPR_EEP("BPSK Driver1_Bias", pModal->db1_1);\r\nPR_EEP("QPSK Driver1_Bias", pModal->db1_2);\r\nPR_EEP("16QAM Driver1_Bias", pModal->db1_3);\r\nPR_EEP("64QAM Driver1_Bias", pModal->db1_4);\r\nPR_EEP("CCK Driver2_Bias", pModal->db2_0);\r\nPR_EEP("BPSK Driver2_Bias", pModal->db2_1);\r\nPR_EEP("QPSK Driver2_Bias", pModal->db2_2);\r\nPR_EEP("16QAM Driver2_Bias", pModal->db2_3);\r\nPR_EEP("64QAM Driver2_Bias", pModal->db2_4);\r\nPR_EEP("xPA Bias Level", pModal->xpaBiasLvl);\r\nPR_EEP("txFrameToDataStart", pModal->txFrameToDataStart);\r\nPR_EEP("txFrameToPaOn", pModal->txFrameToPaOn);\r\nPR_EEP("HT40 Power Inc.", pModal->ht40PowerIncForPdadc);\r\nPR_EEP("Chain0 bswAtten", pModal->bswAtten[0]);\r\nPR_EEP("Chain0 bswMargin", pModal->bswMargin[0]);\r\nPR_EEP("HT40 Switch Settle", pModal->swSettleHt40);\r\nPR_EEP("Chain0 xatten2Db", pModal->xatten2Db[0]);\r\nPR_EEP("Chain0 xatten2Margin", pModal->xatten2Margin[0]);\r\nPR_EEP("Ant. Diversity ctl1", pModal->antdiv_ctl1);\r\nPR_EEP("Ant. Diversity ctl2", pModal->antdiv_ctl2);\r\nPR_EEP("TX Diversity", pModal->tx_diversity);\r\nif (len > size)\r\nlen = size;\r\nretval = simple_read_from_buffer(user_buf, count, ppos, buf, len);\r\nkfree(buf);\r\nreturn retval;\r\n#undef PR_EEP\r\n}\r\nstatic ssize_t read_def_modal_eeprom(struct file *file,\r\nchar __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\n#define PR_EEP(_s, _val) \\r\ndo { \\r\nif (pBase->opCapFlags & AR5416_OPFLAGS_11G) { \\r\npModal = &priv->ah->eeprom.def.modalHeader[1]; \\r\nlen += snprintf(buf + len, size - len, "%20s : %8d%7s", \\r\n_s, (_val), "|"); \\r\n} \\r\nif (pBase->opCapFlags & AR5416_OPFLAGS_11A) { \\r\npModal = &priv->ah->eeprom.def.modalHeader[0]; \\r\nlen += snprintf(buf + len, size - len, "%9d\n", \\r\n(_val)); \\r\n} \\r\n} while (0)\r\nstruct ath9k_htc_priv *priv = file->private_data;\r\nstruct base_eep_header *pBase = &priv->ah->eeprom.def.baseEepHeader;\r\nstruct modal_eep_header *pModal = NULL;\r\nunsigned int len = 0, size = 3500;\r\nssize_t retval = 0;\r\nchar *buf;\r\nbuf = kzalloc(size, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn -ENOMEM;\r\nlen += snprintf(buf + len, size - len,\r\n"%31s %15s\n", "2G", "5G");\r\nlen += snprintf(buf + len, size - len,\r\n"%32s %16s\n", "====", "====\n");\r\nPR_EEP("Chain0 Ant. Control", pModal->antCtrlChain[0]);\r\nPR_EEP("Chain1 Ant. Control", pModal->antCtrlChain[1]);\r\nPR_EEP("Chain2 Ant. Control", pModal->antCtrlChain[2]);\r\nPR_EEP("Ant. Common Control", pModal->antCtrlCommon);\r\nPR_EEP("Chain0 Ant. Gain", pModal->antennaGainCh[0]);\r\nPR_EEP("Chain1 Ant. Gain", pModal->antennaGainCh[1]);\r\nPR_EEP("Chain2 Ant. Gain", pModal->antennaGainCh[2]);\r\nPR_EEP("Switch Settle", pModal->switchSettling);\r\nPR_EEP("Chain0 TxRxAtten", pModal->txRxAttenCh[0]);\r\nPR_EEP("Chain1 TxRxAtten", pModal->txRxAttenCh[1]);\r\nPR_EEP("Chain2 TxRxAtten", pModal->txRxAttenCh[2]);\r\nPR_EEP("Chain0 RxTxMargin", pModal->rxTxMarginCh[0]);\r\nPR_EEP("Chain1 RxTxMargin", pModal->rxTxMarginCh[1]);\r\nPR_EEP("Chain2 RxTxMargin", pModal->rxTxMarginCh[2]);\r\nPR_EEP("ADC Desired size", pModal->adcDesiredSize);\r\nPR_EEP("PGA Desired size", pModal->pgaDesiredSize);\r\nPR_EEP("Chain0 xlna Gain", pModal->xlnaGainCh[0]);\r\nPR_EEP("Chain1 xlna Gain", pModal->xlnaGainCh[1]);\r\nPR_EEP("Chain2 xlna Gain", pModal->xlnaGainCh[2]);\r\nPR_EEP("txEndToXpaOff", pModal->txEndToXpaOff);\r\nPR_EEP("txEndToRxOn", pModal->txEndToRxOn);\r\nPR_EEP("txFrameToXpaOn", pModal->txFrameToXpaOn);\r\nPR_EEP("CCA Threshold)", pModal->thresh62);\r\nPR_EEP("Chain0 NF Threshold", pModal->noiseFloorThreshCh[0]);\r\nPR_EEP("Chain1 NF Threshold", pModal->noiseFloorThreshCh[1]);\r\nPR_EEP("Chain2 NF Threshold", pModal->noiseFloorThreshCh[2]);\r\nPR_EEP("xpdGain", pModal->xpdGain);\r\nPR_EEP("External PD", pModal->xpd);\r\nPR_EEP("Chain0 I Coefficient", pModal->iqCalICh[0]);\r\nPR_EEP("Chain1 I Coefficient", pModal->iqCalICh[1]);\r\nPR_EEP("Chain2 I Coefficient", pModal->iqCalICh[2]);\r\nPR_EEP("Chain0 Q Coefficient", pModal->iqCalQCh[0]);\r\nPR_EEP("Chain1 Q Coefficient", pModal->iqCalQCh[1]);\r\nPR_EEP("Chain2 Q Coefficient", pModal->iqCalQCh[2]);\r\nPR_EEP("pdGainOverlap", pModal->pdGainOverlap);\r\nPR_EEP("Chain0 OutputBias", pModal->ob);\r\nPR_EEP("Chain0 DriverBias", pModal->db);\r\nPR_EEP("xPA Bias Level", pModal->xpaBiasLvl);\r\nPR_EEP("2chain pwr decrease", pModal->pwrDecreaseFor2Chain);\r\nPR_EEP("3chain pwr decrease", pModal->pwrDecreaseFor3Chain);\r\nPR_EEP("txFrameToDataStart", pModal->txFrameToDataStart);\r\nPR_EEP("txFrameToPaOn", pModal->txFrameToPaOn);\r\nPR_EEP("HT40 Power Inc.", pModal->ht40PowerIncForPdadc);\r\nPR_EEP("Chain0 bswAtten", pModal->bswAtten[0]);\r\nPR_EEP("Chain1 bswAtten", pModal->bswAtten[1]);\r\nPR_EEP("Chain2 bswAtten", pModal->bswAtten[2]);\r\nPR_EEP("Chain0 bswMargin", pModal->bswMargin[0]);\r\nPR_EEP("Chain1 bswMargin", pModal->bswMargin[1]);\r\nPR_EEP("Chain2 bswMargin", pModal->bswMargin[2]);\r\nPR_EEP("HT40 Switch Settle", pModal->swSettleHt40);\r\nPR_EEP("Chain0 xatten2Db", pModal->xatten2Db[0]);\r\nPR_EEP("Chain1 xatten2Db", pModal->xatten2Db[1]);\r\nPR_EEP("Chain2 xatten2Db", pModal->xatten2Db[2]);\r\nPR_EEP("Chain0 xatten2Margin", pModal->xatten2Margin[0]);\r\nPR_EEP("Chain1 xatten2Margin", pModal->xatten2Margin[1]);\r\nPR_EEP("Chain2 xatten2Margin", pModal->xatten2Margin[2]);\r\nPR_EEP("Chain1 OutputBias", pModal->ob_ch1);\r\nPR_EEP("Chain1 DriverBias", pModal->db_ch1);\r\nPR_EEP("LNA Control", pModal->lna_ctl);\r\nPR_EEP("XPA Bias Freq0", pModal->xpaBiasLvlFreq[0]);\r\nPR_EEP("XPA Bias Freq1", pModal->xpaBiasLvlFreq[1]);\r\nPR_EEP("XPA Bias Freq2", pModal->xpaBiasLvlFreq[2]);\r\nif (len > size)\r\nlen = size;\r\nretval = simple_read_from_buffer(user_buf, count, ppos, buf, len);\r\nkfree(buf);\r\nreturn retval;\r\n#undef PR_EEP\r\n}\r\nstatic ssize_t read_9287_modal_eeprom(struct file *file,\r\nchar __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\n#define PR_EEP(_s, _val) \\r\ndo { \\r\nlen += snprintf(buf + len, size - len, "%20s : %10d\n", \\r\n_s, (_val)); \\r\n} while (0)\r\nstruct ath9k_htc_priv *priv = file->private_data;\r\nstruct modal_eep_ar9287_header *pModal = &priv->ah->eeprom.map9287.modalHeader;\r\nunsigned int len = 0, size = 3000;\r\nssize_t retval = 0;\r\nchar *buf;\r\nbuf = kzalloc(size, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn -ENOMEM;\r\nPR_EEP("Chain0 Ant. Control", pModal->antCtrlChain[0]);\r\nPR_EEP("Chain1 Ant. Control", pModal->antCtrlChain[1]);\r\nPR_EEP("Ant. Common Control", pModal->antCtrlCommon);\r\nPR_EEP("Chain0 Ant. Gain", pModal->antennaGainCh[0]);\r\nPR_EEP("Chain1 Ant. Gain", pModal->antennaGainCh[1]);\r\nPR_EEP("Switch Settle", pModal->switchSettling);\r\nPR_EEP("Chain0 TxRxAtten", pModal->txRxAttenCh[0]);\r\nPR_EEP("Chain1 TxRxAtten", pModal->txRxAttenCh[1]);\r\nPR_EEP("Chain0 RxTxMargin", pModal->rxTxMarginCh[0]);\r\nPR_EEP("Chain1 RxTxMargin", pModal->rxTxMarginCh[1]);\r\nPR_EEP("ADC Desired size", pModal->adcDesiredSize);\r\nPR_EEP("txEndToXpaOff", pModal->txEndToXpaOff);\r\nPR_EEP("txEndToRxOn", pModal->txEndToRxOn);\r\nPR_EEP("txFrameToXpaOn", pModal->txFrameToXpaOn);\r\nPR_EEP("CCA Threshold)", pModal->thresh62);\r\nPR_EEP("Chain0 NF Threshold", pModal->noiseFloorThreshCh[0]);\r\nPR_EEP("Chain1 NF Threshold", pModal->noiseFloorThreshCh[1]);\r\nPR_EEP("xpdGain", pModal->xpdGain);\r\nPR_EEP("External PD", pModal->xpd);\r\nPR_EEP("Chain0 I Coefficient", pModal->iqCalICh[0]);\r\nPR_EEP("Chain1 I Coefficient", pModal->iqCalICh[1]);\r\nPR_EEP("Chain0 Q Coefficient", pModal->iqCalQCh[0]);\r\nPR_EEP("Chain1 Q Coefficient", pModal->iqCalQCh[1]);\r\nPR_EEP("pdGainOverlap", pModal->pdGainOverlap);\r\nPR_EEP("xPA Bias Level", pModal->xpaBiasLvl);\r\nPR_EEP("txFrameToDataStart", pModal->txFrameToDataStart);\r\nPR_EEP("txFrameToPaOn", pModal->txFrameToPaOn);\r\nPR_EEP("HT40 Power Inc.", pModal->ht40PowerIncForPdadc);\r\nPR_EEP("Chain0 bswAtten", pModal->bswAtten[0]);\r\nPR_EEP("Chain1 bswAtten", pModal->bswAtten[1]);\r\nPR_EEP("Chain0 bswMargin", pModal->bswMargin[0]);\r\nPR_EEP("Chain1 bswMargin", pModal->bswMargin[1]);\r\nPR_EEP("HT40 Switch Settle", pModal->swSettleHt40);\r\nPR_EEP("AR92x7 Version", pModal->version);\r\nPR_EEP("DriverBias1", pModal->db1);\r\nPR_EEP("DriverBias2", pModal->db1);\r\nPR_EEP("CCK OutputBias", pModal->ob_cck);\r\nPR_EEP("PSK OutputBias", pModal->ob_psk);\r\nPR_EEP("QAM OutputBias", pModal->ob_qam);\r\nPR_EEP("PAL_OFF OutputBias", pModal->ob_pal_off);\r\nif (len > size)\r\nlen = size;\r\nretval = simple_read_from_buffer(user_buf, count, ppos, buf, len);\r\nkfree(buf);\r\nreturn retval;\r\n#undef PR_EEP\r\n}\r\nstatic ssize_t read_file_modal_eeprom(struct file *file, char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ath9k_htc_priv *priv = file->private_data;\r\nif (AR_SREV_9271(priv->ah))\r\nreturn read_4k_modal_eeprom(file, user_buf, count, ppos);\r\nelse if (priv->ah->hw_version.usbdev == AR9280_USB)\r\nreturn read_def_modal_eeprom(file, user_buf, count, ppos);\r\nelse if (priv->ah->hw_version.usbdev == AR9287_USB)\r\nreturn read_9287_modal_eeprom(file, user_buf, count, ppos);\r\nreturn 0;\r\n}\r\nint ath9k_htc_init_debug(struct ath_hw *ah)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nstruct ath9k_htc_priv *priv = (struct ath9k_htc_priv *) common->priv;\r\npriv->debug.debugfs_phy = debugfs_create_dir(KBUILD_MODNAME,\r\npriv->hw->wiphy->debugfsdir);\r\nif (!priv->debug.debugfs_phy)\r\nreturn -ENOMEM;\r\ndebugfs_create_file("tgt_int_stats", S_IRUSR, priv->debug.debugfs_phy,\r\npriv, &fops_tgt_int_stats);\r\ndebugfs_create_file("tgt_tx_stats", S_IRUSR, priv->debug.debugfs_phy,\r\npriv, &fops_tgt_tx_stats);\r\ndebugfs_create_file("tgt_rx_stats", S_IRUSR, priv->debug.debugfs_phy,\r\npriv, &fops_tgt_rx_stats);\r\ndebugfs_create_file("xmit", S_IRUSR, priv->debug.debugfs_phy,\r\npriv, &fops_xmit);\r\ndebugfs_create_file("recv", S_IRUSR, priv->debug.debugfs_phy,\r\npriv, &fops_recv);\r\ndebugfs_create_file("slot", S_IRUSR, priv->debug.debugfs_phy,\r\npriv, &fops_slot);\r\ndebugfs_create_file("queue", S_IRUSR, priv->debug.debugfs_phy,\r\npriv, &fops_queue);\r\ndebugfs_create_file("debug", S_IRUSR | S_IWUSR, priv->debug.debugfs_phy,\r\npriv, &fops_debug);\r\ndebugfs_create_file("base_eeprom", S_IRUSR, priv->debug.debugfs_phy,\r\npriv, &fops_base_eeprom);\r\ndebugfs_create_file("modal_eeprom", S_IRUSR, priv->debug.debugfs_phy,\r\npriv, &fops_modal_eeprom);\r\nreturn 0;\r\n}

static int i_APCI1710_InitPWM(struct comedi_device *dev,\r\nunsigned char b_ModulNbr,\r\nunsigned char b_PWM,\r\nunsigned char b_ClockSelection,\r\nunsigned char b_TimingUnit,\r\nunsigned int ul_LowTiming,\r\nunsigned int ul_HighTiming,\r\nunsigned int *pul_RealLowTiming,\r\nunsigned int *pul_RealHighTiming)\r\n{\r\nstruct addi_private *devpriv = dev->private;\r\nint i_ReturnValue = 0;\r\nunsigned int ul_LowTimerValue = 0;\r\nunsigned int ul_HighTimerValue = 0;\r\nunsigned int dw_Command;\r\ndouble d_RealLowTiming = 0;\r\ndouble d_RealHighTiming = 0;\r\nif (b_ModulNbr < 4) {\r\nif ((devpriv->s_BoardInfos.\r\ndw_MolduleConfiguration[b_ModulNbr] &\r\n0xFFFF0000UL) == APCI1710_PWM) {\r\nif (b_PWM <= 1) {\r\nif ((b_ClockSelection == APCI1710_30MHZ) ||\r\n(b_ClockSelection == APCI1710_33MHZ) ||\r\n(b_ClockSelection == APCI1710_40MHZ)) {\r\nif (b_TimingUnit <= 4) {\r\nif (((b_ClockSelection ==\r\nAPCI1710_30MHZ)\r\n&& (b_TimingUnit\r\n== 0)\r\n&& (ul_LowTiming\r\n>= 266)\r\n&& (ul_LowTiming\r\n<=\r\n0xFFFFFFFFUL))\r\n|| ((b_ClockSelection ==\r\nAPCI1710_30MHZ)\r\n&& (b_TimingUnit\r\n== 1)\r\n&& (ul_LowTiming\r\n>= 1)\r\n&& (ul_LowTiming\r\n<=\r\n571230650UL))\r\n|| ((b_ClockSelection ==\r\nAPCI1710_30MHZ)\r\n&& (b_TimingUnit\r\n== 2)\r\n&& (ul_LowTiming\r\n>= 1)\r\n&& (ul_LowTiming\r\n<=\r\n571230UL))\r\n|| ((b_ClockSelection ==\r\nAPCI1710_30MHZ)\r\n&& (b_TimingUnit\r\n== 3)\r\n&& (ul_LowTiming\r\n>= 1)\r\n&& (ul_LowTiming\r\n<=\r\n571UL))\r\n|| ((b_ClockSelection ==\r\nAPCI1710_30MHZ)\r\n&& (b_TimingUnit\r\n== 4)\r\n&& (ul_LowTiming\r\n>= 1)\r\n&& (ul_LowTiming\r\n<= 9UL))\r\n|| ((b_ClockSelection ==\r\nAPCI1710_33MHZ)\r\n&& (b_TimingUnit\r\n== 0)\r\n&& (ul_LowTiming\r\n>= 242)\r\n&& (ul_LowTiming\r\n<=\r\n0xFFFFFFFFUL))\r\n|| ((b_ClockSelection ==\r\nAPCI1710_33MHZ)\r\n&& (b_TimingUnit\r\n== 1)\r\n&& (ul_LowTiming\r\n>= 1)\r\n&& (ul_LowTiming\r\n<=\r\n519691043UL))\r\n|| ((b_ClockSelection ==\r\nAPCI1710_33MHZ)\r\n&& (b_TimingUnit\r\n== 2)\r\n&& (ul_LowTiming\r\n>= 1)\r\n&& (ul_LowTiming\r\n<=\r\n519691UL))\r\n|| ((b_ClockSelection ==\r\nAPCI1710_33MHZ)\r\n&& (b_TimingUnit\r\n== 3)\r\n&& (ul_LowTiming\r\n>= 1)\r\n&& (ul_LowTiming\r\n<=\r\n520UL))\r\n|| ((b_ClockSelection ==\r\nAPCI1710_33MHZ)\r\n&& (b_TimingUnit\r\n== 4)\r\n&& (ul_LowTiming\r\n>= 1)\r\n&& (ul_LowTiming\r\n<= 8UL))\r\n|| ((b_ClockSelection ==\r\nAPCI1710_40MHZ)\r\n&& (b_TimingUnit\r\n== 0)\r\n&& (ul_LowTiming\r\n>= 200)\r\n&& (ul_LowTiming\r\n<=\r\n0xFFFFFFFFUL))\r\n|| ((b_ClockSelection ==\r\nAPCI1710_40MHZ)\r\n&& (b_TimingUnit\r\n== 1)\r\n&& (ul_LowTiming\r\n>= 1)\r\n&& (ul_LowTiming\r\n<=\r\n429496729UL))\r\n|| ((b_ClockSelection ==\r\nAPCI1710_40MHZ)\r\n&& (b_TimingUnit\r\n== 2)\r\n&& (ul_LowTiming\r\n>= 1)\r\n&& (ul_LowTiming\r\n<=\r\n429496UL))\r\n|| ((b_ClockSelection ==\r\nAPCI1710_40MHZ)\r\n&& (b_TimingUnit\r\n== 3)\r\n&& (ul_LowTiming\r\n>= 1)\r\n&& (ul_LowTiming\r\n<=\r\n429UL))\r\n|| ((b_ClockSelection ==\r\nAPCI1710_40MHZ)\r\n&& (b_TimingUnit\r\n== 4)\r\n&& (ul_LowTiming\r\n>= 1)\r\n&& (ul_LowTiming\r\n<=\r\n7UL))) {\r\nif (((b_ClockSelection == APCI1710_30MHZ) && (b_TimingUnit == 0) && (ul_HighTiming >= 266) && (ul_HighTiming <= 0xFFFFFFFFUL)) || ((b_ClockSelection == APCI1710_30MHZ) && (b_TimingUnit == 1) && (ul_HighTiming >= 1) && (ul_HighTiming <= 571230650UL)) || ((b_ClockSelection == APCI1710_30MHZ) && (b_TimingUnit == 2) && (ul_HighTiming >= 1) && (ul_HighTiming <= 571230UL)) || ((b_ClockSelection == APCI1710_30MHZ) && (b_TimingUnit == 3) && (ul_HighTiming >= 1) && (ul_HighTiming <= 571UL)) || ((b_ClockSelection == APCI1710_30MHZ) && (b_TimingUnit == 4) && (ul_HighTiming >= 1) && (ul_HighTiming <= 9UL)) || ((b_ClockSelection == APCI1710_33MHZ) && (b_TimingUnit == 0) && (ul_HighTiming >= 242) && (ul_HighTiming <= 0xFFFFFFFFUL)) || ((b_ClockSelection == APCI1710_33MHZ) && (b_TimingUnit == 1) && (ul_HighTiming >= 1) && (ul_HighTiming <= 519691043UL)) || ((b_ClockSelection == APCI1710_33MHZ) && (b_TimingUnit == 2) && (ul_HighTiming >= 1) && (ul_HighTiming <= 519691UL)) || ((b_ClockSelection == APCI1710_33MHZ) && (b_TimingUnit == 3) && (ul_HighTiming >= 1) && (ul_HighTiming <= 520UL)) || ((b_ClockSelection == APCI1710_33MHZ) && (b_TimingUnit == 4) && (ul_HighTiming >= 1) && (ul_HighTiming <= 8UL)) || ((b_ClockSelection == APCI1710_40MHZ) && (b_TimingUnit == 0) && (ul_HighTiming >= 200) && (ul_HighTiming <= 0xFFFFFFFFUL)) || ((b_ClockSelection == APCI1710_40MHZ) && (b_TimingUnit == 1) && (ul_HighTiming >= 1) && (ul_HighTiming <= 429496729UL)) || ((b_ClockSelection == APCI1710_40MHZ) && (b_TimingUnit == 2) && (ul_HighTiming >= 1) && (ul_HighTiming <= 429496UL)) || ((b_ClockSelection == APCI1710_40MHZ) && (b_TimingUnit == 3) && (ul_HighTiming >= 1) && (ul_HighTiming <= 429UL)) || ((b_ClockSelection == APCI1710_40MHZ) && (b_TimingUnit == 4) && (ul_HighTiming >= 1) && (ul_HighTiming <= 7UL))) {\r\nif (((b_ClockSelection == APCI1710_40MHZ) && (devpriv->s_BoardInfos.b_BoardVersion > 0)) || (b_ClockSelection != APCI1710_40MHZ)) {\r\nfpu_begin\r\n();\r\nswitch (b_TimingUnit) {\r\ncase 0:\r\nul_LowTimerValue\r\n=\r\n(unsigned int)\r\n(ul_LowTiming\r\n*\r\n(0.00025 * b_ClockSelection));\r\nif ((double)((double)ul_LowTiming * (0.00025 * (double)b_ClockSelection)) >= ((double)((double)ul_LowTimerValue + 0.5))) {\r\nul_LowTimerValue\r\n=\r\nul_LowTimerValue\r\n+\r\n1;\r\n}\r\n*pul_RealLowTiming\r\n=\r\n(unsigned int)\r\n(ul_LowTimerValue\r\n/\r\n(0.00025 * (double)b_ClockSelection));\r\nd_RealLowTiming\r\n=\r\n(double)\r\nul_LowTimerValue\r\n/\r\n(0.00025\r\n*\r\n(double)\r\nb_ClockSelection);\r\nif ((double)((double)ul_LowTimerValue / (0.00025 * (double)b_ClockSelection)) >= (double)((double)*pul_RealLowTiming + 0.5)) {\r\n*pul_RealLowTiming\r\n=\r\n*pul_RealLowTiming\r\n+\r\n1;\r\n}\r\nul_LowTiming\r\n=\r\nul_LowTiming\r\n-\r\n1;\r\nul_LowTimerValue\r\n=\r\nul_LowTimerValue\r\n-\r\n2;\r\nif (b_ClockSelection != APCI1710_40MHZ) {\r\nul_LowTimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(double)\r\n(ul_LowTimerValue)\r\n*\r\n1.007752288);\r\n}\r\nbreak;\r\ncase 1:\r\nul_LowTimerValue\r\n=\r\n(unsigned int)\r\n(ul_LowTiming\r\n*\r\n(0.25 * b_ClockSelection));\r\nif ((double)((double)ul_LowTiming * (0.25 * (double)b_ClockSelection)) >= ((double)((double)ul_LowTimerValue + 0.5))) {\r\nul_LowTimerValue\r\n=\r\nul_LowTimerValue\r\n+\r\n1;\r\n}\r\n*pul_RealLowTiming\r\n=\r\n(unsigned int)\r\n(ul_LowTimerValue\r\n/\r\n(0.25 * (double)b_ClockSelection));\r\nd_RealLowTiming\r\n=\r\n(double)\r\nul_LowTimerValue\r\n/\r\n(\r\n(double)\r\n0.25\r\n*\r\n(double)\r\nb_ClockSelection);\r\nif ((double)((double)ul_LowTimerValue / (0.25 * (double)b_ClockSelection)) >= (double)((double)*pul_RealLowTiming + 0.5)) {\r\n*pul_RealLowTiming\r\n=\r\n*pul_RealLowTiming\r\n+\r\n1;\r\n}\r\nul_LowTiming\r\n=\r\nul_LowTiming\r\n-\r\n1;\r\nul_LowTimerValue\r\n=\r\nul_LowTimerValue\r\n-\r\n2;\r\nif (b_ClockSelection != APCI1710_40MHZ) {\r\nul_LowTimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(double)\r\n(ul_LowTimerValue)\r\n*\r\n1.007752288);\r\n}\r\nbreak;\r\ncase 2:\r\nul_LowTimerValue\r\n=\r\nul_LowTiming\r\n*\r\n(250.0\r\n*\r\nb_ClockSelection);\r\nif ((double)((double)ul_LowTiming * (250.0 * (double)b_ClockSelection)) >= ((double)((double)ul_LowTimerValue + 0.5))) {\r\nul_LowTimerValue\r\n=\r\nul_LowTimerValue\r\n+\r\n1;\r\n}\r\n*pul_RealLowTiming\r\n=\r\n(unsigned int)\r\n(ul_LowTimerValue\r\n/\r\n(250.0 * (double)b_ClockSelection));\r\nd_RealLowTiming\r\n=\r\n(double)\r\nul_LowTimerValue\r\n/\r\n(250.0\r\n*\r\n(double)\r\nb_ClockSelection);\r\nif ((double)((double)ul_LowTimerValue / (250.0 * (double)b_ClockSelection)) >= (double)((double)*pul_RealLowTiming + 0.5)) {\r\n*pul_RealLowTiming\r\n=\r\n*pul_RealLowTiming\r\n+\r\n1;\r\n}\r\nul_LowTiming\r\n=\r\nul_LowTiming\r\n-\r\n1;\r\nul_LowTimerValue\r\n=\r\nul_LowTimerValue\r\n-\r\n2;\r\nif (b_ClockSelection != APCI1710_40MHZ) {\r\nul_LowTimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(double)\r\n(ul_LowTimerValue)\r\n*\r\n1.007752288);\r\n}\r\nbreak;\r\ncase 3:\r\nul_LowTimerValue\r\n=\r\n(unsigned int)\r\n(ul_LowTiming\r\n*\r\n(250000.0\r\n*\r\nb_ClockSelection));\r\nif ((double)((double)ul_LowTiming * (250000.0 * (double)b_ClockSelection)) >= ((double)((double)ul_LowTimerValue + 0.5))) {\r\nul_LowTimerValue\r\n=\r\nul_LowTimerValue\r\n+\r\n1;\r\n}\r\n*pul_RealLowTiming\r\n=\r\n(unsigned int)\r\n(ul_LowTimerValue\r\n/\r\n(250000.0\r\n*\r\n(double)\r\nb_ClockSelection));\r\nd_RealLowTiming\r\n=\r\n(double)\r\nul_LowTimerValue\r\n/\r\n(250000.0\r\n*\r\n(double)\r\nb_ClockSelection);\r\nif ((double)((double)ul_LowTimerValue / (250000.0 * (double)b_ClockSelection)) >= (double)((double)*pul_RealLowTiming + 0.5)) {\r\n*pul_RealLowTiming\r\n=\r\n*pul_RealLowTiming\r\n+\r\n1;\r\n}\r\nul_LowTiming\r\n=\r\nul_LowTiming\r\n-\r\n1;\r\nul_LowTimerValue\r\n=\r\nul_LowTimerValue\r\n-\r\n2;\r\nif (b_ClockSelection != APCI1710_40MHZ) {\r\nul_LowTimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(double)\r\n(ul_LowTimerValue)\r\n*\r\n1.007752288);\r\n}\r\nbreak;\r\ncase 4:\r\nul_LowTimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(ul_LowTiming\r\n*\r\n60)\r\n*\r\n(250000.0\r\n*\r\nb_ClockSelection));\r\nif ((double)((double)(ul_LowTiming * 60.0) * (250000.0 * (double)b_ClockSelection)) >= ((double)((double)ul_LowTimerValue + 0.5))) {\r\nul_LowTimerValue\r\n=\r\nul_LowTimerValue\r\n+\r\n1;\r\n}\r\n*pul_RealLowTiming\r\n=\r\n(unsigned int)\r\n(ul_LowTimerValue\r\n/\r\n(250000.0\r\n*\r\n(double)\r\nb_ClockSelection))\r\n/\r\n60;\r\nd_RealLowTiming\r\n=\r\n(\r\n(double)\r\nul_LowTimerValue\r\n/\r\n(250000.0\r\n*\r\n(double)\r\nb_ClockSelection))\r\n/\r\n60.0;\r\nif ((double)(((double)ul_LowTimerValue / (250000.0 * (double)b_ClockSelection)) / 60.0) >= (double)((double)*pul_RealLowTiming + 0.5)) {\r\n*pul_RealLowTiming\r\n=\r\n*pul_RealLowTiming\r\n+\r\n1;\r\n}\r\nul_LowTiming\r\n=\r\nul_LowTiming\r\n-\r\n1;\r\nul_LowTimerValue\r\n=\r\nul_LowTimerValue\r\n-\r\n2;\r\nif (b_ClockSelection != APCI1710_40MHZ) {\r\nul_LowTimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(double)\r\n(ul_LowTimerValue)\r\n*\r\n1.007752288);\r\n}\r\nbreak;\r\n}\r\nswitch (b_TimingUnit) {\r\ncase 0:\r\nul_HighTimerValue\r\n=\r\n(unsigned int)\r\n(ul_HighTiming\r\n*\r\n(0.00025 * b_ClockSelection));\r\nif ((double)((double)ul_HighTiming * (0.00025 * (double)b_ClockSelection)) >= ((double)((double)ul_HighTimerValue + 0.5))) {\r\nul_HighTimerValue\r\n=\r\nul_HighTimerValue\r\n+\r\n1;\r\n}\r\n*pul_RealHighTiming\r\n=\r\n(unsigned int)\r\n(ul_HighTimerValue\r\n/\r\n(0.00025 * (double)b_ClockSelection));\r\nd_RealHighTiming\r\n=\r\n(double)\r\nul_HighTimerValue\r\n/\r\n(0.00025\r\n*\r\n(double)\r\nb_ClockSelection);\r\nif ((double)((double)ul_HighTimerValue / (0.00025 * (double)b_ClockSelection)) >= (double)((double)*pul_RealHighTiming + 0.5)) {\r\n*pul_RealHighTiming\r\n=\r\n*pul_RealHighTiming\r\n+\r\n1;\r\n}\r\nul_HighTiming\r\n=\r\nul_HighTiming\r\n-\r\n1;\r\nul_HighTimerValue\r\n=\r\nul_HighTimerValue\r\n-\r\n2;\r\nif (b_ClockSelection != APCI1710_40MHZ) {\r\nul_HighTimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(double)\r\n(ul_HighTimerValue)\r\n*\r\n1.007752288);\r\n}\r\nbreak;\r\ncase 1:\r\nul_HighTimerValue\r\n=\r\n(unsigned int)\r\n(ul_HighTiming\r\n*\r\n(0.25 * b_ClockSelection));\r\nif ((double)((double)ul_HighTiming * (0.25 * (double)b_ClockSelection)) >= ((double)((double)ul_HighTimerValue + 0.5))) {\r\nul_HighTimerValue\r\n=\r\nul_HighTimerValue\r\n+\r\n1;\r\n}\r\n*pul_RealHighTiming\r\n=\r\n(unsigned int)\r\n(ul_HighTimerValue\r\n/\r\n(0.25 * (double)b_ClockSelection));\r\nd_RealHighTiming\r\n=\r\n(double)\r\nul_HighTimerValue\r\n/\r\n(\r\n(double)\r\n0.25\r\n*\r\n(double)\r\nb_ClockSelection);\r\nif ((double)((double)ul_HighTimerValue / (0.25 * (double)b_ClockSelection)) >= (double)((double)*pul_RealHighTiming + 0.5)) {\r\n*pul_RealHighTiming\r\n=\r\n*pul_RealHighTiming\r\n+\r\n1;\r\n}\r\nul_HighTiming\r\n=\r\nul_HighTiming\r\n-\r\n1;\r\nul_HighTimerValue\r\n=\r\nul_HighTimerValue\r\n-\r\n2;\r\nif (b_ClockSelection != APCI1710_40MHZ) {\r\nul_HighTimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(double)\r\n(ul_HighTimerValue)\r\n*\r\n1.007752288);\r\n}\r\nbreak;\r\ncase 2:\r\nul_HighTimerValue\r\n=\r\nul_HighTiming\r\n*\r\n(250.0\r\n*\r\nb_ClockSelection);\r\nif ((double)((double)ul_HighTiming * (250.0 * (double)b_ClockSelection)) >= ((double)((double)ul_HighTimerValue + 0.5))) {\r\nul_HighTimerValue\r\n=\r\nul_HighTimerValue\r\n+\r\n1;\r\n}\r\n*pul_RealHighTiming\r\n=\r\n(unsigned int)\r\n(ul_HighTimerValue\r\n/\r\n(250.0 * (double)b_ClockSelection));\r\nd_RealHighTiming\r\n=\r\n(double)\r\nul_HighTimerValue\r\n/\r\n(250.0\r\n*\r\n(double)\r\nb_ClockSelection);\r\nif ((double)((double)ul_HighTimerValue / (250.0 * (double)b_ClockSelection)) >= (double)((double)*pul_RealHighTiming + 0.5)) {\r\n*pul_RealHighTiming\r\n=\r\n*pul_RealHighTiming\r\n+\r\n1;\r\n}\r\nul_HighTiming\r\n=\r\nul_HighTiming\r\n-\r\n1;\r\nul_HighTimerValue\r\n=\r\nul_HighTimerValue\r\n-\r\n2;\r\nif (b_ClockSelection != APCI1710_40MHZ) {\r\nul_HighTimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(double)\r\n(ul_HighTimerValue)\r\n*\r\n1.007752288);\r\n}\r\nbreak;\r\ncase 3:\r\nul_HighTimerValue\r\n=\r\n(unsigned int)\r\n(ul_HighTiming\r\n*\r\n(250000.0\r\n*\r\nb_ClockSelection));\r\nif ((double)((double)ul_HighTiming * (250000.0 * (double)b_ClockSelection)) >= ((double)((double)ul_HighTimerValue + 0.5))) {\r\nul_HighTimerValue\r\n=\r\nul_HighTimerValue\r\n+\r\n1;\r\n}\r\n*pul_RealHighTiming\r\n=\r\n(unsigned int)\r\n(ul_HighTimerValue\r\n/\r\n(250000.0\r\n*\r\n(double)\r\nb_ClockSelection));\r\nd_RealHighTiming\r\n=\r\n(double)\r\nul_HighTimerValue\r\n/\r\n(250000.0\r\n*\r\n(double)\r\nb_ClockSelection);\r\nif ((double)((double)ul_HighTimerValue / (250000.0 * (double)b_ClockSelection)) >= (double)((double)*pul_RealHighTiming + 0.5)) {\r\n*pul_RealHighTiming\r\n=\r\n*pul_RealHighTiming\r\n+\r\n1;\r\n}\r\nul_HighTiming\r\n=\r\nul_HighTiming\r\n-\r\n1;\r\nul_HighTimerValue\r\n=\r\nul_HighTimerValue\r\n-\r\n2;\r\nif (b_ClockSelection != APCI1710_40MHZ) {\r\nul_HighTimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(double)\r\n(ul_HighTimerValue)\r\n*\r\n1.007752288);\r\n}\r\nbreak;\r\ncase 4:\r\nul_HighTimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(ul_HighTiming\r\n*\r\n60)\r\n*\r\n(250000.0\r\n*\r\nb_ClockSelection));\r\nif ((double)((double)(ul_HighTiming * 60.0) * (250000.0 * (double)b_ClockSelection)) >= ((double)((double)ul_HighTimerValue + 0.5))) {\r\nul_HighTimerValue\r\n=\r\nul_HighTimerValue\r\n+\r\n1;\r\n}\r\n*pul_RealHighTiming\r\n=\r\n(unsigned int)\r\n(ul_HighTimerValue\r\n/\r\n(250000.0\r\n*\r\n(double)\r\nb_ClockSelection))\r\n/\r\n60;\r\nd_RealHighTiming\r\n=\r\n(\r\n(double)\r\nul_HighTimerValue\r\n/\r\n(250000.0\r\n*\r\n(double)\r\nb_ClockSelection))\r\n/\r\n60.0;\r\nif ((double)(((double)ul_HighTimerValue / (250000.0 * (double)b_ClockSelection)) / 60.0) >= (double)((double)*pul_RealHighTiming + 0.5)) {\r\n*pul_RealHighTiming\r\n=\r\n*pul_RealHighTiming\r\n+\r\n1;\r\n}\r\nul_HighTiming\r\n=\r\nul_HighTiming\r\n-\r\n1;\r\nul_HighTimerValue\r\n=\r\nul_HighTimerValue\r\n-\r\n2;\r\nif (b_ClockSelection != APCI1710_40MHZ) {\r\nul_HighTimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(double)\r\n(ul_HighTimerValue)\r\n*\r\n1.007752288);\r\n}\r\nbreak;\r\n}\r\nfpu_end();\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PWMModuleInfo.\r\nb_ClockSelection\r\n=\r\nb_ClockSelection;\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PWMModuleInfo.\r\ns_PWMInfo\r\n[b_PWM].\r\nb_TimingUnit\r\n=\r\nb_TimingUnit;\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PWMModuleInfo.\r\ns_PWMInfo\r\n[b_PWM].\r\nd_LowTiming\r\n=\r\nd_RealLowTiming;\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PWMModuleInfo.\r\ns_PWMInfo\r\n[b_PWM].\r\nul_RealLowTiming\r\n=\r\n*pul_RealLowTiming;\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PWMModuleInfo.\r\ns_PWMInfo\r\n[b_PWM].\r\nd_HighTiming\r\n=\r\nd_RealHighTiming;\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PWMModuleInfo.\r\ns_PWMInfo\r\n[b_PWM].\r\nul_RealHighTiming\r\n=\r\n*pul_RealHighTiming;\r\noutl(ul_LowTimerValue, devpriv->s_BoardInfos.ui_Address + 0 + (20 * b_PWM) + (64 * b_ModulNbr));\r\noutl(ul_HighTimerValue, devpriv->s_BoardInfos.ui_Address + 4 + (20 * b_PWM) + (64 * b_ModulNbr));\r\ndw_Command\r\n=\r\ninl\r\n(devpriv->\r\ns_BoardInfos.\r\nui_Address\r\n+\r\n8\r\n+\r\n(20 * b_PWM) + (64 * b_ModulNbr));\r\ndw_Command\r\n=\r\ndw_Command\r\n&\r\n0x7F;\r\nif (b_ClockSelection == APCI1710_40MHZ) {\r\ndw_Command\r\n=\r\ndw_Command\r\n|\r\n0x80;\r\n}\r\noutl(dw_Command, devpriv->s_BoardInfos.ui_Address + 8 + (20 * b_PWM) + (64 * b_ModulNbr));\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PWMModuleInfo.\r\ns_PWMInfo\r\n[b_PWM].\r\nb_PWMInit\r\n=\r\n1;\r\n} else {\r\nDPRINTK("You can not used the 40MHz clock selection with this board\n");\r\ni_ReturnValue\r\n=\r\n-9;\r\n}\r\n} else {\r\nDPRINTK("High base timing selection is wrong\n");\r\ni_ReturnValue =\r\n-8;\r\n}\r\n} else {\r\nDPRINTK("Low base timing selection is wrong\n");\r\ni_ReturnValue = -7;\r\n}\r\n}\r\nelse {\r\nDPRINTK("Timing unit selection is wrong\n");\r\ni_ReturnValue = -6;\r\n}\r\n}\r\nelse {\r\nDPRINTK("The selected clock is wrong\n");\r\ni_ReturnValue = -5;\r\n}\r\n}\r\nelse {\r\nDPRINTK("Tor PWM selection is wrong\n");\r\ni_ReturnValue = -4;\r\n}\r\n} else {\r\nDPRINTK("The module is not a PWM module\n");\r\ni_ReturnValue = -3;\r\n}\r\n} else {\r\nDPRINTK("Module number error\n");\r\ni_ReturnValue = -2;\r\n}\r\nreturn i_ReturnValue;\r\n}\r\nstatic int i_APCI1710_GetPWMInitialisation(struct comedi_device *dev,\r\nunsigned char b_ModulNbr,\r\nunsigned char b_PWM,\r\nunsigned char *pb_TimingUnit,\r\nunsigned int *pul_LowTiming,\r\nunsigned int *pul_HighTiming,\r\nunsigned char *pb_StartLevel,\r\nunsigned char *pb_StopMode,\r\nunsigned char *pb_StopLevel,\r\nunsigned char *pb_ExternGate,\r\nunsigned char *pb_InterruptEnable,\r\nunsigned char *pb_Enable)\r\n{\r\nstruct addi_private *devpriv = dev->private;\r\nint i_ReturnValue = 0;\r\nunsigned int dw_Status;\r\nunsigned int dw_Command;\r\nif (b_ModulNbr < 4) {\r\nif ((devpriv->s_BoardInfos.\r\ndw_MolduleConfiguration[b_ModulNbr] &\r\n0xFFFF0000UL) == APCI1710_PWM) {\r\nif (b_PWM <= 1) {\r\ndw_Status = inl(devpriv->s_BoardInfos.\r\nui_Address + 12 + (20 * b_PWM) +\r\n(64 * b_ModulNbr));\r\nif (dw_Status & 0x10) {\r\n*pul_LowTiming =\r\ninl(devpriv->s_BoardInfos.\r\nui_Address + 0 + (20 * b_PWM) +\r\n(64 * b_ModulNbr));\r\n*pul_HighTiming =\r\ninl(devpriv->s_BoardInfos.\r\nui_Address + 4 + (20 * b_PWM) +\r\n(64 * b_ModulNbr));\r\ndw_Command = inl(devpriv->s_BoardInfos.\r\nui_Address + 8 + (20 * b_PWM) +\r\n(64 * b_ModulNbr));\r\n*pb_StartLevel =\r\n(unsigned char) ((dw_Command >> 5) & 1);\r\n*pb_StopMode =\r\n(unsigned char) ((dw_Command >> 0) & 1);\r\n*pb_StopLevel =\r\n(unsigned char) ((dw_Command >> 1) & 1);\r\n*pb_ExternGate =\r\n(unsigned char) ((dw_Command >> 4) & 1);\r\n*pb_InterruptEnable =\r\n(unsigned char) ((dw_Command >> 3) & 1);\r\nif (*pb_StopLevel) {\r\n*pb_StopLevel =\r\n*pb_StopLevel +\r\n(unsigned char) ((dw_Command >>\r\n2) & 1);\r\n}\r\ndw_Command = inl(devpriv->s_BoardInfos.\r\nui_Address + 8 + (20 * b_PWM) +\r\n(64 * b_ModulNbr));\r\n*pb_Enable =\r\n(unsigned char) ((dw_Command >> 0) & 1);\r\n*pb_TimingUnit = devpriv->\r\ns_ModuleInfo[b_ModulNbr].\r\ns_PWMModuleInfo.\r\ns_PWMInfo[b_PWM].b_TimingUnit;\r\n}\r\nelse {\r\nDPRINTK("PWM not initialised\n");\r\ni_ReturnValue = -5;\r\n}\r\n}\r\nelse {\r\nDPRINTK("Tor PWM selection is wrong\n");\r\ni_ReturnValue = -4;\r\n}\r\n} else {\r\nDPRINTK("The module is not a PWM module\n");\r\ni_ReturnValue = -3;\r\n}\r\n} else {\r\nDPRINTK("Module number error\n");\r\ni_ReturnValue = -2;\r\n}\r\nreturn i_ReturnValue;\r\n}\r\nstatic int i_APCI1710_InsnConfigPWM(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nunsigned char b_ConfigType;\r\nint i_ReturnValue = 0;\r\nb_ConfigType = CR_CHAN(insn->chanspec);\r\nswitch (b_ConfigType) {\r\ncase APCI1710_PWM_INIT:\r\ni_ReturnValue = i_APCI1710_InitPWM(dev, (unsigned char) CR_AREF(insn->chanspec),\r\n(unsigned char) data[0],\r\n(unsigned char) data[1],\r\n(unsigned char) data[2],\r\n(unsigned int) data[3],\r\n(unsigned int) data[4],\r\n(unsigned int *) &data[0],\r\n(unsigned int *) &data[1]\r\n);\r\nbreak;\r\ncase APCI1710_PWM_GETINITDATA:\r\ni_ReturnValue = i_APCI1710_GetPWMInitialisation(dev, (unsigned char) CR_AREF(insn->chanspec),\r\n(unsigned char) data[0],\r\n(unsigned char *) &data[0],\r\n(unsigned int *) &data[1],\r\n(unsigned int *) &data[2],\r\n(unsigned char *) &data[3],\r\n(unsigned char *) &data[4],\r\n(unsigned char *) &data[5],\r\n(unsigned char *) &data[6],\r\n(unsigned char *) &data[7],\r\n(unsigned char *) &data[8]\r\n);\r\nbreak;\r\ndefault:\r\nprintk(" Config Parameter Wrong\n");\r\n}\r\nif (i_ReturnValue >= 0)\r\ni_ReturnValue = insn->n;\r\nreturn i_ReturnValue;\r\n}\r\nstatic int i_APCI1710_EnablePWM(struct comedi_device *dev,\r\nunsigned char b_ModulNbr,\r\nunsigned char b_PWM,\r\nunsigned char b_StartLevel,\r\nunsigned char b_StopMode,\r\nunsigned char b_StopLevel,\r\nunsigned char b_ExternGate,\r\nunsigned char b_InterruptEnable)\r\n{\r\nstruct addi_private *devpriv = dev->private;\r\nint i_ReturnValue = 0;\r\nunsigned int dw_Status;\r\nunsigned int dw_Command;\r\ndevpriv->tsk_Current = current;\r\nif (b_ModulNbr < 4) {\r\nif ((devpriv->s_BoardInfos.\r\ndw_MolduleConfiguration[b_ModulNbr] &\r\n0xFFFF0000UL) == APCI1710_PWM) {\r\nif (b_PWM <= 1) {\r\ndw_Status = inl(devpriv->s_BoardInfos.\r\nui_Address + 12 + (20 * b_PWM) +\r\n(64 * b_ModulNbr));\r\nif (dw_Status & 0x10) {\r\nif (b_StartLevel <= 1) {\r\nif (b_StopMode <= 1) {\r\nif (b_StopLevel <= 2) {\r\nif (b_ExternGate\r\n<= 1) {\r\nif (b_InterruptEnable == APCI1710_ENABLE || b_InterruptEnable == APCI1710_DISABLE) {\r\ndw_Command\r\n=\r\ninl\r\n(devpriv->\r\ns_BoardInfos.\r\nui_Address\r\n+\r\n8\r\n+\r\n(20 * b_PWM) + (64 * b_ModulNbr));\r\ndw_Command\r\n=\r\ndw_Command\r\n&\r\n0x80;\r\ndw_Command\r\n=\r\ndw_Command\r\n|\r\nb_StopMode\r\n|\r\n(b_InterruptEnable\r\n<<\r\n3)\r\n|\r\n(b_ExternGate\r\n<<\r\n4)\r\n|\r\n(b_StartLevel\r\n<<\r\n5);\r\nif (b_StopLevel & 3) {\r\ndw_Command\r\n=\r\ndw_Command\r\n|\r\n2;\r\nif (b_StopLevel & 2) {\r\ndw_Command\r\n=\r\ndw_Command\r\n|\r\n4;\r\n}\r\n}\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PWMModuleInfo.\r\ns_PWMInfo\r\n[b_PWM].\r\nb_InterruptEnable\r\n=\r\nb_InterruptEnable;\r\noutl(dw_Command, devpriv->s_BoardInfos.ui_Address + 8 + (20 * b_PWM) + (64 * b_ModulNbr));\r\noutl(1, devpriv->s_BoardInfos.ui_Address + 12 + (20 * b_PWM) + (64 * b_ModulNbr));\r\n}\r\nelse {\r\nDPRINTK("Interrupt parameter is wrong\n");\r\ni_ReturnValue\r\n=\r\n-10;\r\n}\r\n}\r\nelse {\r\nDPRINTK("Extern gate signal selection is wrong\n");\r\ni_ReturnValue\r\n=\r\n-9;\r\n}\r\n}\r\nelse {\r\nDPRINTK("PWM stop level selection is wrong\n");\r\ni_ReturnValue =\r\n-8;\r\n}\r\n}\r\nelse {\r\nDPRINTK("PWM stop mode selection is wrong\n");\r\ni_ReturnValue = -7;\r\n}\r\n}\r\nelse {\r\nDPRINTK("PWM start level selection is wrong\n");\r\ni_ReturnValue = -6;\r\n}\r\n}\r\nelse {\r\nDPRINTK("PWM not initialised\n");\r\ni_ReturnValue = -5;\r\n}\r\n}\r\nelse {\r\nDPRINTK("Tor PWM selection is wrong\n");\r\ni_ReturnValue = -4;\r\n}\r\n} else {\r\nDPRINTK("The module is not a PWM module\n");\r\ni_ReturnValue = -3;\r\n}\r\n} else {\r\nDPRINTK("Module number error\n");\r\ni_ReturnValue = -2;\r\n}\r\nreturn i_ReturnValue;\r\n}\r\nstatic int i_APCI1710_DisablePWM(struct comedi_device *dev,\r\nunsigned char b_ModulNbr,\r\nunsigned char b_PWM)\r\n{\r\nstruct addi_private *devpriv = dev->private;\r\nint i_ReturnValue = 0;\r\nunsigned int dw_Status;\r\nif (b_ModulNbr < 4) {\r\nif ((devpriv->s_BoardInfos.\r\ndw_MolduleConfiguration[b_ModulNbr] &\r\n0xFFFF0000UL) == APCI1710_PWM) {\r\nif (b_PWM <= 1) {\r\ndw_Status = inl(devpriv->s_BoardInfos.\r\nui_Address + 12 + (20 * b_PWM) +\r\n(64 * b_ModulNbr));\r\nif (dw_Status & 0x10) {\r\nif (dw_Status & 0x1) {\r\noutl(0, devpriv->s_BoardInfos.\r\nui_Address + 12 +\r\n(20 * b_PWM) +\r\n(64 * b_ModulNbr));\r\n}\r\nelse {\r\nDPRINTK("PWM not enabled\n");\r\ni_ReturnValue = -6;\r\n}\r\n}\r\nelse {\r\nDPRINTK(" PWM not initialised\n");\r\ni_ReturnValue = -5;\r\n}\r\n}\r\nelse {\r\nDPRINTK("Tor PWM selection is wrong\n");\r\ni_ReturnValue = -4;\r\n}\r\n} else {\r\nDPRINTK("The module is not a PWM module\n");\r\ni_ReturnValue = -3;\r\n}\r\n} else {\r\nDPRINTK("Module number error\n");\r\ni_ReturnValue = -2;\r\n}\r\nreturn i_ReturnValue;\r\n}\r\nstatic int i_APCI1710_SetNewPWMTiming(struct comedi_device *dev,\r\nunsigned char b_ModulNbr,\r\nunsigned char b_PWM,\r\nunsigned char b_TimingUnit,\r\nunsigned int ul_LowTiming,\r\nunsigned int ul_HighTiming)\r\n{\r\nstruct addi_private *devpriv = dev->private;\r\nunsigned char b_ClockSelection;\r\nint i_ReturnValue = 0;\r\nunsigned int ul_LowTimerValue = 0;\r\nunsigned int ul_HighTimerValue = 0;\r\nunsigned int ul_RealLowTiming = 0;\r\nunsigned int ul_RealHighTiming = 0;\r\nunsigned int dw_Status;\r\nunsigned int dw_Command;\r\ndouble d_RealLowTiming = 0;\r\ndouble d_RealHighTiming = 0;\r\nif (b_ModulNbr < 4) {\r\nif ((devpriv->s_BoardInfos.\r\ndw_MolduleConfiguration[b_ModulNbr] &\r\n0xFFFF0000UL) == APCI1710_PWM) {\r\nif (b_PWM <= 1) {\r\ndw_Status = inl(devpriv->s_BoardInfos.\r\nui_Address + 12 + (20 * b_PWM) +\r\n(64 * b_ModulNbr));\r\nif (dw_Status & 0x10) {\r\nb_ClockSelection = devpriv->\r\ns_ModuleInfo[b_ModulNbr].\r\ns_PWMModuleInfo.\r\nb_ClockSelection;\r\nif (b_TimingUnit <= 4) {\r\nif (((b_ClockSelection ==\r\nAPCI1710_30MHZ)\r\n&& (b_TimingUnit\r\n== 0)\r\n&& (ul_LowTiming\r\n>= 266)\r\n&& (ul_LowTiming\r\n<=\r\n0xFFFFFFFFUL))\r\n|| ((b_ClockSelection ==\r\nAPCI1710_30MHZ)\r\n&& (b_TimingUnit\r\n== 1)\r\n&& (ul_LowTiming\r\n>= 1)\r\n&& (ul_LowTiming\r\n<=\r\n571230650UL))\r\n|| ((b_ClockSelection ==\r\nAPCI1710_30MHZ)\r\n&& (b_TimingUnit\r\n== 2)\r\n&& (ul_LowTiming\r\n>= 1)\r\n&& (ul_LowTiming\r\n<=\r\n571230UL))\r\n|| ((b_ClockSelection ==\r\nAPCI1710_30MHZ)\r\n&& (b_TimingUnit\r\n== 3)\r\n&& (ul_LowTiming\r\n>= 1)\r\n&& (ul_LowTiming\r\n<=\r\n571UL))\r\n|| ((b_ClockSelection ==\r\nAPCI1710_30MHZ)\r\n&& (b_TimingUnit\r\n== 4)\r\n&& (ul_LowTiming\r\n>= 1)\r\n&& (ul_LowTiming\r\n<= 9UL))\r\n|| ((b_ClockSelection ==\r\nAPCI1710_33MHZ)\r\n&& (b_TimingUnit\r\n== 0)\r\n&& (ul_LowTiming\r\n>= 242)\r\n&& (ul_LowTiming\r\n<=\r\n0xFFFFFFFFUL))\r\n|| ((b_ClockSelection ==\r\nAPCI1710_33MHZ)\r\n&& (b_TimingUnit\r\n== 1)\r\n&& (ul_LowTiming\r\n>= 1)\r\n&& (ul_LowTiming\r\n<=\r\n519691043UL))\r\n|| ((b_ClockSelection ==\r\nAPCI1710_33MHZ)\r\n&& (b_TimingUnit\r\n== 2)\r\n&& (ul_LowTiming\r\n>= 1)\r\n&& (ul_LowTiming\r\n<=\r\n519691UL))\r\n|| ((b_ClockSelection ==\r\nAPCI1710_33MHZ)\r\n&& (b_TimingUnit\r\n== 3)\r\n&& (ul_LowTiming\r\n>= 1)\r\n&& (ul_LowTiming\r\n<=\r\n520UL))\r\n|| ((b_ClockSelection ==\r\nAPCI1710_33MHZ)\r\n&& (b_TimingUnit\r\n== 4)\r\n&& (ul_LowTiming\r\n>= 1)\r\n&& (ul_LowTiming\r\n<= 8UL))\r\n|| ((b_ClockSelection ==\r\nAPCI1710_40MHZ)\r\n&& (b_TimingUnit\r\n== 0)\r\n&& (ul_LowTiming\r\n>= 200)\r\n&& (ul_LowTiming\r\n<=\r\n0xFFFFFFFFUL))\r\n|| ((b_ClockSelection ==\r\nAPCI1710_40MHZ)\r\n&& (b_TimingUnit\r\n== 1)\r\n&& (ul_LowTiming\r\n>= 1)\r\n&& (ul_LowTiming\r\n<=\r\n429496729UL))\r\n|| ((b_ClockSelection ==\r\nAPCI1710_40MHZ)\r\n&& (b_TimingUnit\r\n== 2)\r\n&& (ul_LowTiming\r\n>= 1)\r\n&& (ul_LowTiming\r\n<=\r\n429496UL))\r\n|| ((b_ClockSelection ==\r\nAPCI1710_40MHZ)\r\n&& (b_TimingUnit\r\n== 3)\r\n&& (ul_LowTiming\r\n>= 1)\r\n&& (ul_LowTiming\r\n<=\r\n429UL))\r\n|| ((b_ClockSelection ==\r\nAPCI1710_40MHZ)\r\n&& (b_TimingUnit\r\n== 4)\r\n&& (ul_LowTiming\r\n>= 1)\r\n&& (ul_LowTiming\r\n<=\r\n7UL))) {\r\nif (((b_ClockSelection == APCI1710_30MHZ) && (b_TimingUnit == 0) && (ul_HighTiming >= 266) && (ul_HighTiming <= 0xFFFFFFFFUL)) || ((b_ClockSelection == APCI1710_30MHZ) && (b_TimingUnit == 1) && (ul_HighTiming >= 1) && (ul_HighTiming <= 571230650UL)) || ((b_ClockSelection == APCI1710_30MHZ) && (b_TimingUnit == 2) && (ul_HighTiming >= 1) && (ul_HighTiming <= 571230UL)) || ((b_ClockSelection == APCI1710_30MHZ) && (b_TimingUnit == 3) && (ul_HighTiming >= 1) && (ul_HighTiming <= 571UL)) || ((b_ClockSelection == APCI1710_30MHZ) && (b_TimingUnit == 4) && (ul_HighTiming >= 1) && (ul_HighTiming <= 9UL)) || ((b_ClockSelection == APCI1710_33MHZ) && (b_TimingUnit == 0) && (ul_HighTiming >= 242) && (ul_HighTiming <= 0xFFFFFFFFUL)) || ((b_ClockSelection == APCI1710_33MHZ) && (b_TimingUnit == 1) && (ul_HighTiming >= 1) && (ul_HighTiming <= 519691043UL)) || ((b_ClockSelection == APCI1710_33MHZ) && (b_TimingUnit == 2) && (ul_HighTiming >= 1) && (ul_HighTiming <= 519691UL)) || ((b_ClockSelection == APCI1710_33MHZ) && (b_TimingUnit == 3) && (ul_HighTiming >= 1) && (ul_HighTiming <= 520UL)) || ((b_ClockSelection == APCI1710_33MHZ) && (b_TimingUnit == 4) && (ul_HighTiming >= 1) && (ul_HighTiming <= 8UL)) || ((b_ClockSelection == APCI1710_40MHZ) && (b_TimingUnit == 0) && (ul_HighTiming >= 200) && (ul_HighTiming <= 0xFFFFFFFFUL)) || ((b_ClockSelection == APCI1710_40MHZ) && (b_TimingUnit == 1) && (ul_HighTiming >= 1) && (ul_HighTiming <= 429496729UL)) || ((b_ClockSelection == APCI1710_40MHZ) && (b_TimingUnit == 2) && (ul_HighTiming >= 1) && (ul_HighTiming <= 429496UL)) || ((b_ClockSelection == APCI1710_40MHZ) && (b_TimingUnit == 3) && (ul_HighTiming >= 1) && (ul_HighTiming <= 429UL)) || ((b_ClockSelection == APCI1710_40MHZ) && (b_TimingUnit == 4) && (ul_HighTiming >= 1) && (ul_HighTiming <= 7UL))) {\r\nfpu_begin();\r\nswitch (b_TimingUnit) {\r\ncase 0:\r\nul_LowTimerValue\r\n=\r\n(unsigned int)\r\n(ul_LowTiming\r\n*\r\n(0.00025 * b_ClockSelection));\r\nif ((double)((double)ul_LowTiming * (0.00025 * (double)b_ClockSelection)) >= ((double)((double)ul_LowTimerValue + 0.5))) {\r\nul_LowTimerValue\r\n=\r\nul_LowTimerValue\r\n+\r\n1;\r\n}\r\nul_RealLowTiming\r\n=\r\n(unsigned int)\r\n(ul_LowTimerValue\r\n/\r\n(0.00025 * (double)b_ClockSelection));\r\nd_RealLowTiming\r\n=\r\n(double)\r\nul_LowTimerValue\r\n/\r\n(0.00025\r\n*\r\n(double)\r\nb_ClockSelection);\r\nif ((double)((double)ul_LowTimerValue / (0.00025 * (double)b_ClockSelection)) >= (double)((double)ul_RealLowTiming + 0.5)) {\r\nul_RealLowTiming\r\n=\r\nul_RealLowTiming\r\n+\r\n1;\r\n}\r\nul_LowTiming\r\n=\r\nul_LowTiming\r\n-\r\n1;\r\nul_LowTimerValue\r\n=\r\nul_LowTimerValue\r\n-\r\n2;\r\nif (b_ClockSelection != APCI1710_40MHZ) {\r\nul_LowTimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(double)\r\n(ul_LowTimerValue)\r\n*\r\n1.007752288);\r\n}\r\nbreak;\r\ncase 1:\r\nul_LowTimerValue\r\n=\r\n(unsigned int)\r\n(ul_LowTiming\r\n*\r\n(0.25 * b_ClockSelection));\r\nif ((double)((double)ul_LowTiming * (0.25 * (double)b_ClockSelection)) >= ((double)((double)ul_LowTimerValue + 0.5))) {\r\nul_LowTimerValue\r\n=\r\nul_LowTimerValue\r\n+\r\n1;\r\n}\r\nul_RealLowTiming\r\n=\r\n(unsigned int)\r\n(ul_LowTimerValue\r\n/\r\n(0.25 * (double)b_ClockSelection));\r\nd_RealLowTiming\r\n=\r\n(double)\r\nul_LowTimerValue\r\n/\r\n(\r\n(double)\r\n0.25\r\n*\r\n(double)\r\nb_ClockSelection);\r\nif ((double)((double)ul_LowTimerValue / (0.25 * (double)b_ClockSelection)) >= (double)((double)ul_RealLowTiming + 0.5)) {\r\nul_RealLowTiming\r\n=\r\nul_RealLowTiming\r\n+\r\n1;\r\n}\r\nul_LowTiming\r\n=\r\nul_LowTiming\r\n-\r\n1;\r\nul_LowTimerValue\r\n=\r\nul_LowTimerValue\r\n-\r\n2;\r\nif (b_ClockSelection != APCI1710_40MHZ) {\r\nul_LowTimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(double)\r\n(ul_LowTimerValue)\r\n*\r\n1.007752288);\r\n}\r\nbreak;\r\ncase 2:\r\nul_LowTimerValue\r\n=\r\nul_LowTiming\r\n*\r\n(250.0\r\n*\r\nb_ClockSelection);\r\nif ((double)((double)ul_LowTiming * (250.0 * (double)b_ClockSelection)) >= ((double)((double)ul_LowTimerValue + 0.5))) {\r\nul_LowTimerValue\r\n=\r\nul_LowTimerValue\r\n+\r\n1;\r\n}\r\nul_RealLowTiming\r\n=\r\n(unsigned int)\r\n(ul_LowTimerValue\r\n/\r\n(250.0 * (double)b_ClockSelection));\r\nd_RealLowTiming\r\n=\r\n(double)\r\nul_LowTimerValue\r\n/\r\n(250.0\r\n*\r\n(double)\r\nb_ClockSelection);\r\nif ((double)((double)ul_LowTimerValue / (250.0 * (double)b_ClockSelection)) >= (double)((double)ul_RealLowTiming + 0.5)) {\r\nul_RealLowTiming\r\n=\r\nul_RealLowTiming\r\n+\r\n1;\r\n}\r\nul_LowTiming\r\n=\r\nul_LowTiming\r\n-\r\n1;\r\nul_LowTimerValue\r\n=\r\nul_LowTimerValue\r\n-\r\n2;\r\nif (b_ClockSelection != APCI1710_40MHZ) {\r\nul_LowTimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(double)\r\n(ul_LowTimerValue)\r\n*\r\n1.007752288);\r\n}\r\nbreak;\r\ncase 3:\r\nul_LowTimerValue\r\n=\r\n(unsigned int)\r\n(ul_LowTiming\r\n*\r\n(250000.0\r\n*\r\nb_ClockSelection));\r\nif ((double)((double)ul_LowTiming * (250000.0 * (double)b_ClockSelection)) >= ((double)((double)ul_LowTimerValue + 0.5))) {\r\nul_LowTimerValue\r\n=\r\nul_LowTimerValue\r\n+\r\n1;\r\n}\r\nul_RealLowTiming\r\n=\r\n(unsigned int)\r\n(ul_LowTimerValue\r\n/\r\n(250000.0\r\n*\r\n(double)\r\nb_ClockSelection));\r\nd_RealLowTiming\r\n=\r\n(double)\r\nul_LowTimerValue\r\n/\r\n(250000.0\r\n*\r\n(double)\r\nb_ClockSelection);\r\nif ((double)((double)ul_LowTimerValue / (250000.0 * (double)b_ClockSelection)) >= (double)((double)ul_RealLowTiming + 0.5)) {\r\nul_RealLowTiming\r\n=\r\nul_RealLowTiming\r\n+\r\n1;\r\n}\r\nul_LowTiming\r\n=\r\nul_LowTiming\r\n-\r\n1;\r\nul_LowTimerValue\r\n=\r\nul_LowTimerValue\r\n-\r\n2;\r\nif (b_ClockSelection != APCI1710_40MHZ) {\r\nul_LowTimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(double)\r\n(ul_LowTimerValue)\r\n*\r\n1.007752288);\r\n}\r\nbreak;\r\ncase 4:\r\nul_LowTimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(ul_LowTiming\r\n*\r\n60)\r\n*\r\n(250000.0\r\n*\r\nb_ClockSelection));\r\nif ((double)((double)(ul_LowTiming * 60.0) * (250000.0 * (double)b_ClockSelection)) >= ((double)((double)ul_LowTimerValue + 0.5))) {\r\nul_LowTimerValue\r\n=\r\nul_LowTimerValue\r\n+\r\n1;\r\n}\r\nul_RealLowTiming\r\n=\r\n(unsigned int)\r\n(ul_LowTimerValue\r\n/\r\n(250000.0\r\n*\r\n(double)\r\nb_ClockSelection))\r\n/\r\n60;\r\nd_RealLowTiming\r\n=\r\n(\r\n(double)\r\nul_LowTimerValue\r\n/\r\n(250000.0\r\n*\r\n(double)\r\nb_ClockSelection))\r\n/\r\n60.0;\r\nif ((double)(((double)ul_LowTimerValue / (250000.0 * (double)b_ClockSelection)) / 60.0) >= (double)((double)ul_RealLowTiming + 0.5)) {\r\nul_RealLowTiming\r\n=\r\nul_RealLowTiming\r\n+\r\n1;\r\n}\r\nul_LowTiming\r\n=\r\nul_LowTiming\r\n-\r\n1;\r\nul_LowTimerValue\r\n=\r\nul_LowTimerValue\r\n-\r\n2;\r\nif (b_ClockSelection != APCI1710_40MHZ) {\r\nul_LowTimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(double)\r\n(ul_LowTimerValue)\r\n*\r\n1.007752288);\r\n}\r\nbreak;\r\n}\r\nswitch (b_TimingUnit) {\r\ncase 0:\r\nul_HighTimerValue\r\n=\r\n(unsigned int)\r\n(ul_HighTiming\r\n*\r\n(0.00025 * b_ClockSelection));\r\nif ((double)((double)ul_HighTiming * (0.00025 * (double)b_ClockSelection)) >= ((double)((double)ul_HighTimerValue + 0.5))) {\r\nul_HighTimerValue\r\n=\r\nul_HighTimerValue\r\n+\r\n1;\r\n}\r\nul_RealHighTiming\r\n=\r\n(unsigned int)\r\n(ul_HighTimerValue\r\n/\r\n(0.00025 * (double)b_ClockSelection));\r\nd_RealHighTiming\r\n=\r\n(double)\r\nul_HighTimerValue\r\n/\r\n(0.00025\r\n*\r\n(double)\r\nb_ClockSelection);\r\nif ((double)((double)ul_HighTimerValue / (0.00025 * (double)b_ClockSelection)) >= (double)((double)ul_RealHighTiming + 0.5)) {\r\nul_RealHighTiming\r\n=\r\nul_RealHighTiming\r\n+\r\n1;\r\n}\r\nul_HighTiming\r\n=\r\nul_HighTiming\r\n-\r\n1;\r\nul_HighTimerValue\r\n=\r\nul_HighTimerValue\r\n-\r\n2;\r\nif (b_ClockSelection != APCI1710_40MHZ) {\r\nul_HighTimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(double)\r\n(ul_HighTimerValue)\r\n*\r\n1.007752288);\r\n}\r\nbreak;\r\ncase 1:\r\nul_HighTimerValue\r\n=\r\n(unsigned int)\r\n(ul_HighTiming\r\n*\r\n(0.25 * b_ClockSelection));\r\nif ((double)((double)ul_HighTiming * (0.25 * (double)b_ClockSelection)) >= ((double)((double)ul_HighTimerValue + 0.5))) {\r\nul_HighTimerValue\r\n=\r\nul_HighTimerValue\r\n+\r\n1;\r\n}\r\nul_RealHighTiming\r\n=\r\n(unsigned int)\r\n(ul_HighTimerValue\r\n/\r\n(0.25 * (double)b_ClockSelection));\r\nd_RealHighTiming\r\n=\r\n(double)\r\nul_HighTimerValue\r\n/\r\n(\r\n(double)\r\n0.25\r\n*\r\n(double)\r\nb_ClockSelection);\r\nif ((double)((double)ul_HighTimerValue / (0.25 * (double)b_ClockSelection)) >= (double)((double)ul_RealHighTiming + 0.5)) {\r\nul_RealHighTiming\r\n=\r\nul_RealHighTiming\r\n+\r\n1;\r\n}\r\nul_HighTiming\r\n=\r\nul_HighTiming\r\n-\r\n1;\r\nul_HighTimerValue\r\n=\r\nul_HighTimerValue\r\n-\r\n2;\r\nif (b_ClockSelection != APCI1710_40MHZ) {\r\nul_HighTimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(double)\r\n(ul_HighTimerValue)\r\n*\r\n1.007752288);\r\n}\r\nbreak;\r\ncase 2:\r\nul_HighTimerValue\r\n=\r\nul_HighTiming\r\n*\r\n(250.0\r\n*\r\nb_ClockSelection);\r\nif ((double)((double)ul_HighTiming * (250.0 * (double)b_ClockSelection)) >= ((double)((double)ul_HighTimerValue + 0.5))) {\r\nul_HighTimerValue\r\n=\r\nul_HighTimerValue\r\n+\r\n1;\r\n}\r\nul_RealHighTiming\r\n=\r\n(unsigned int)\r\n(ul_HighTimerValue\r\n/\r\n(250.0 * (double)b_ClockSelection));\r\nd_RealHighTiming\r\n=\r\n(double)\r\nul_HighTimerValue\r\n/\r\n(250.0\r\n*\r\n(double)\r\nb_ClockSelection);\r\nif ((double)((double)ul_HighTimerValue / (250.0 * (double)b_ClockSelection)) >= (double)((double)ul_RealHighTiming + 0.5)) {\r\nul_RealHighTiming\r\n=\r\nul_RealHighTiming\r\n+\r\n1;\r\n}\r\nul_HighTiming\r\n=\r\nul_HighTiming\r\n-\r\n1;\r\nul_HighTimerValue\r\n=\r\nul_HighTimerValue\r\n-\r\n2;\r\nif (b_ClockSelection != APCI1710_40MHZ) {\r\nul_HighTimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(double)\r\n(ul_HighTimerValue)\r\n*\r\n1.007752288);\r\n}\r\nbreak;\r\ncase 3:\r\nul_HighTimerValue\r\n=\r\n(unsigned int)\r\n(ul_HighTiming\r\n*\r\n(250000.0\r\n*\r\nb_ClockSelection));\r\nif ((double)((double)ul_HighTiming * (250000.0 * (double)b_ClockSelection)) >= ((double)((double)ul_HighTimerValue + 0.5))) {\r\nul_HighTimerValue\r\n=\r\nul_HighTimerValue\r\n+\r\n1;\r\n}\r\nul_RealHighTiming\r\n=\r\n(unsigned int)\r\n(ul_HighTimerValue\r\n/\r\n(250000.0\r\n*\r\n(double)\r\nb_ClockSelection));\r\nd_RealHighTiming\r\n=\r\n(double)\r\nul_HighTimerValue\r\n/\r\n(250000.0\r\n*\r\n(double)\r\nb_ClockSelection);\r\nif ((double)((double)ul_HighTimerValue / (250000.0 * (double)b_ClockSelection)) >= (double)((double)ul_RealHighTiming + 0.5)) {\r\nul_RealHighTiming\r\n=\r\nul_RealHighTiming\r\n+\r\n1;\r\n}\r\nul_HighTiming\r\n=\r\nul_HighTiming\r\n-\r\n1;\r\nul_HighTimerValue\r\n=\r\nul_HighTimerValue\r\n-\r\n2;\r\nif (b_ClockSelection != APCI1710_40MHZ) {\r\nul_HighTimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(double)\r\n(ul_HighTimerValue)\r\n*\r\n1.007752288);\r\n}\r\nbreak;\r\ncase 4:\r\nul_HighTimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(ul_HighTiming\r\n*\r\n60)\r\n*\r\n(250000.0\r\n*\r\nb_ClockSelection));\r\nif ((double)((double)(ul_HighTiming * 60.0) * (250000.0 * (double)b_ClockSelection)) >= ((double)((double)ul_HighTimerValue + 0.5))) {\r\nul_HighTimerValue\r\n=\r\nul_HighTimerValue\r\n+\r\n1;\r\n}\r\nul_RealHighTiming\r\n=\r\n(unsigned int)\r\n(ul_HighTimerValue\r\n/\r\n(250000.0\r\n*\r\n(double)\r\nb_ClockSelection))\r\n/\r\n60;\r\nd_RealHighTiming\r\n=\r\n(\r\n(double)\r\nul_HighTimerValue\r\n/\r\n(250000.0\r\n*\r\n(double)\r\nb_ClockSelection))\r\n/\r\n60.0;\r\nif ((double)(((double)ul_HighTimerValue / (250000.0 * (double)b_ClockSelection)) / 60.0) >= (double)((double)ul_RealHighTiming + 0.5)) {\r\nul_RealHighTiming\r\n=\r\nul_RealHighTiming\r\n+\r\n1;\r\n}\r\nul_HighTiming\r\n=\r\nul_HighTiming\r\n-\r\n1;\r\nul_HighTimerValue\r\n=\r\nul_HighTimerValue\r\n-\r\n2;\r\nif (b_ClockSelection != APCI1710_40MHZ) {\r\nul_HighTimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(double)\r\n(ul_HighTimerValue)\r\n*\r\n1.007752288);\r\n}\r\nbreak;\r\n}\r\nfpu_end();\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PWMModuleInfo.\r\ns_PWMInfo\r\n[b_PWM].\r\nb_TimingUnit\r\n=\r\nb_TimingUnit;\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PWMModuleInfo.\r\ns_PWMInfo\r\n[b_PWM].\r\nd_LowTiming\r\n=\r\nd_RealLowTiming;\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PWMModuleInfo.\r\ns_PWMInfo\r\n[b_PWM].\r\nul_RealLowTiming\r\n=\r\nul_RealLowTiming;\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PWMModuleInfo.\r\ns_PWMInfo\r\n[b_PWM].\r\nd_HighTiming\r\n=\r\nd_RealHighTiming;\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PWMModuleInfo.\r\ns_PWMInfo\r\n[b_PWM].\r\nul_RealHighTiming\r\n=\r\nul_RealHighTiming;\r\noutl(ul_LowTimerValue, devpriv->s_BoardInfos.ui_Address + 0 + (20 * b_PWM) + (64 * b_ModulNbr));\r\noutl(ul_HighTimerValue, devpriv->s_BoardInfos.ui_Address + 4 + (20 * b_PWM) + (64 * b_ModulNbr));\r\ndw_Command =\r\ninl\r\n(devpriv->\r\ns_BoardInfos.\r\nui_Address\r\n+ 8 +\r\n(20 * b_PWM) + (64 * b_ModulNbr));\r\ndw_Command =\r\ndw_Command\r\n& 0x7F;\r\nif (b_ClockSelection == APCI1710_40MHZ) {\r\ndw_Command\r\n=\r\ndw_Command\r\n|\r\n0x80;\r\n}\r\noutl(dw_Command,\r\ndevpriv->\r\ns_BoardInfos.\r\nui_Address\r\n+ 8 +\r\n(20 * b_PWM) + (64 * b_ModulNbr));\r\n} else {\r\nDPRINTK("High base timing selection is wrong\n");\r\ni_ReturnValue =\r\n-8;\r\n}\r\n} else {\r\nDPRINTK("Low base timing selection is wrong\n");\r\ni_ReturnValue = -7;\r\n}\r\n}\r\nelse {\r\nDPRINTK("Timing unit selection is wrong\n");\r\ni_ReturnValue = -6;\r\n}\r\n}\r\nelse {\r\nDPRINTK("PWM not initialised\n");\r\ni_ReturnValue = -5;\r\n}\r\n}\r\nelse {\r\nDPRINTK("Tor PWM selection is wrong\n");\r\ni_ReturnValue = -4;\r\n}\r\n} else {\r\nDPRINTK("The module is not a PWM module\n");\r\ni_ReturnValue = -3;\r\n}\r\n} else {\r\nDPRINTK("Module number error\n");\r\ni_ReturnValue = -2;\r\n}\r\nreturn i_ReturnValue;\r\n}\r\nstatic int i_APCI1710_InsnWritePWM(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nunsigned char b_WriteType;\r\nint i_ReturnValue = 0;\r\nb_WriteType = CR_CHAN(insn->chanspec);\r\nswitch (b_WriteType) {\r\ncase APCI1710_PWM_ENABLE:\r\ni_ReturnValue = i_APCI1710_EnablePWM(dev,\r\n(unsigned char) CR_AREF(insn->chanspec),\r\n(unsigned char) data[0],\r\n(unsigned char) data[1],\r\n(unsigned char) data[2],\r\n(unsigned char) data[3], (unsigned char) data[4], (unsigned char) data[5]);\r\nbreak;\r\ncase APCI1710_PWM_DISABLE:\r\ni_ReturnValue = i_APCI1710_DisablePWM(dev,\r\n(unsigned char) CR_AREF(insn->chanspec), (unsigned char) data[0]);\r\nbreak;\r\ncase APCI1710_PWM_NEWTIMING:\r\ni_ReturnValue = i_APCI1710_SetNewPWMTiming(dev,\r\n(unsigned char) CR_AREF(insn->chanspec),\r\n(unsigned char) data[0],\r\n(unsigned char) data[1], (unsigned int) data[2], (unsigned int) data[3]);\r\nbreak;\r\ndefault:\r\nprintk("Write Config Parameter Wrong\n");\r\n}\r\nif (i_ReturnValue >= 0)\r\ni_ReturnValue = insn->n;\r\nreturn i_ReturnValue;\r\n}\r\nstatic int i_APCI1710_InsnReadGetPWMStatus(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct addi_private *devpriv = dev->private;\r\nint i_ReturnValue = 0;\r\nunsigned int dw_Status;\r\nunsigned char b_ModulNbr;\r\nunsigned char b_PWM;\r\nunsigned char *pb_PWMOutputStatus;\r\nunsigned char *pb_ExternGateStatus;\r\ni_ReturnValue = insn->n;\r\nb_ModulNbr = (unsigned char) CR_AREF(insn->chanspec);\r\nb_PWM = (unsigned char) CR_CHAN(insn->chanspec);\r\npb_PWMOutputStatus = (unsigned char *) &data[0];\r\npb_ExternGateStatus = (unsigned char *) &data[1];\r\nif (b_ModulNbr < 4) {\r\nif ((devpriv->s_BoardInfos.\r\ndw_MolduleConfiguration[b_ModulNbr] &\r\n0xFFFF0000UL) == APCI1710_PWM) {\r\nif (b_PWM <= 1) {\r\ndw_Status = inl(devpriv->s_BoardInfos.\r\nui_Address + 12 + (20 * b_PWM) +\r\n(64 * b_ModulNbr));\r\nif (dw_Status & 0x10) {\r\nif (dw_Status & 0x1) {\r\n*pb_PWMOutputStatus =\r\n(unsigned char) ((dw_Status >> 7)\r\n& 1);\r\n*pb_ExternGateStatus =\r\n(unsigned char) ((dw_Status >> 6)\r\n& 1);\r\n}\r\nelse {\r\nDPRINTK("PWM not enabled \n");\r\ni_ReturnValue = -6;\r\n}\r\n}\r\nelse {\r\nDPRINTK("PWM not initialised\n");\r\ni_ReturnValue = -5;\r\n}\r\n}\r\nelse {\r\nDPRINTK("Tor PWM selection is wrong\n");\r\ni_ReturnValue = -4;\r\n}\r\n} else {\r\nDPRINTK("The module is not a PWM module\n");\r\ni_ReturnValue = -3;\r\n}\r\n} else {\r\nDPRINTK("Module number error\n");\r\ni_ReturnValue = -2;\r\n}\r\nreturn i_ReturnValue;\r\n}\r\nstatic int i_APCI1710_InsnBitsReadPWMInterrupt(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct addi_private *devpriv = dev->private;\r\ndata[0] = devpriv->s_InterruptParameters.\r\ns_FIFOInterruptParameters[devpriv->\r\ns_InterruptParameters.ui_Read].b_OldModuleMask;\r\ndata[1] = devpriv->s_InterruptParameters.\r\ns_FIFOInterruptParameters[devpriv->\r\ns_InterruptParameters.ui_Read].ul_OldInterruptMask;\r\ndata[2] = devpriv->s_InterruptParameters.\r\ns_FIFOInterruptParameters[devpriv->\r\ns_InterruptParameters.ui_Read].ul_OldCounterLatchValue;\r\ndevpriv->\r\ns_InterruptParameters.\r\nui_Read = (devpriv->\r\ns_InterruptParameters.ui_Read + 1) % APCI1710_SAVE_INTERRUPT;\r\nreturn insn->n;\r\n}

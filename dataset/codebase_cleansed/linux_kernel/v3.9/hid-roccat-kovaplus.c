static uint kovaplus_convert_event_cpi(uint value)\r\n{\r\nreturn (value == 7 ? 4 : (value == 4 ? 3 : value));\r\n}\r\nstatic void kovaplus_profile_activated(struct kovaplus_device *kovaplus,\r\nuint new_profile_index)\r\n{\r\nkovaplus->actual_profile = new_profile_index;\r\nkovaplus->actual_cpi = kovaplus->profile_settings[new_profile_index].cpi_startup_level;\r\nkovaplus->actual_x_sensitivity = kovaplus->profile_settings[new_profile_index].sensitivity_x;\r\nkovaplus->actual_y_sensitivity = kovaplus->profile_settings[new_profile_index].sensitivity_y;\r\n}\r\nstatic int kovaplus_send_control(struct usb_device *usb_dev, uint value,\r\nenum kovaplus_control_requests request)\r\n{\r\nint retval;\r\nstruct roccat_common2_control control;\r\nif ((request == KOVAPLUS_CONTROL_REQUEST_PROFILE_SETTINGS ||\r\nrequest == KOVAPLUS_CONTROL_REQUEST_PROFILE_BUTTONS) &&\r\nvalue > 4)\r\nreturn -EINVAL;\r\ncontrol.command = ROCCAT_COMMON_COMMAND_CONTROL;\r\ncontrol.value = value;\r\ncontrol.request = request;\r\nretval = roccat_common2_send(usb_dev, ROCCAT_COMMON_COMMAND_CONTROL,\r\n&control, sizeof(struct roccat_common2_control));\r\nreturn retval;\r\n}\r\nstatic int kovaplus_select_profile(struct usb_device *usb_dev, uint number,\r\nenum kovaplus_control_requests request)\r\n{\r\nreturn kovaplus_send_control(usb_dev, number, request);\r\n}\r\nstatic int kovaplus_get_profile_settings(struct usb_device *usb_dev,\r\nstruct kovaplus_profile_settings *buf, uint number)\r\n{\r\nint retval;\r\nretval = kovaplus_select_profile(usb_dev, number,\r\nKOVAPLUS_CONTROL_REQUEST_PROFILE_SETTINGS);\r\nif (retval)\r\nreturn retval;\r\nreturn roccat_common2_receive(usb_dev, KOVAPLUS_COMMAND_PROFILE_SETTINGS,\r\nbuf, KOVAPLUS_SIZE_PROFILE_SETTINGS);\r\n}\r\nstatic int kovaplus_get_profile_buttons(struct usb_device *usb_dev,\r\nstruct kovaplus_profile_buttons *buf, int number)\r\n{\r\nint retval;\r\nretval = kovaplus_select_profile(usb_dev, number,\r\nKOVAPLUS_CONTROL_REQUEST_PROFILE_BUTTONS);\r\nif (retval)\r\nreturn retval;\r\nreturn roccat_common2_receive(usb_dev, KOVAPLUS_COMMAND_PROFILE_BUTTONS,\r\nbuf, KOVAPLUS_SIZE_PROFILE_BUTTONS);\r\n}\r\nstatic int kovaplus_get_actual_profile(struct usb_device *usb_dev)\r\n{\r\nstruct kovaplus_actual_profile buf;\r\nint retval;\r\nretval = roccat_common2_receive(usb_dev, KOVAPLUS_COMMAND_ACTUAL_PROFILE,\r\n&buf, sizeof(struct kovaplus_actual_profile));\r\nreturn retval ? retval : buf.actual_profile;\r\n}\r\nstatic int kovaplus_set_actual_profile(struct usb_device *usb_dev,\r\nint new_profile)\r\n{\r\nstruct kovaplus_actual_profile buf;\r\nbuf.command = KOVAPLUS_COMMAND_ACTUAL_PROFILE;\r\nbuf.size = sizeof(struct kovaplus_actual_profile);\r\nbuf.actual_profile = new_profile;\r\nreturn roccat_common2_send_with_status(usb_dev,\r\nKOVAPLUS_COMMAND_ACTUAL_PROFILE,\r\n&buf, sizeof(struct kovaplus_actual_profile));\r\n}\r\nstatic ssize_t kovaplus_sysfs_read(struct file *fp, struct kobject *kobj,\r\nchar *buf, loff_t off, size_t count,\r\nsize_t real_size, uint command)\r\n{\r\nstruct device *dev =\r\ncontainer_of(kobj, struct device, kobj)->parent->parent;\r\nstruct kovaplus_device *kovaplus = hid_get_drvdata(dev_get_drvdata(dev));\r\nstruct usb_device *usb_dev = interface_to_usbdev(to_usb_interface(dev));\r\nint retval;\r\nif (off >= real_size)\r\nreturn 0;\r\nif (off != 0 || count != real_size)\r\nreturn -EINVAL;\r\nmutex_lock(&kovaplus->kovaplus_lock);\r\nretval = roccat_common2_receive(usb_dev, command, buf, real_size);\r\nmutex_unlock(&kovaplus->kovaplus_lock);\r\nif (retval)\r\nreturn retval;\r\nreturn real_size;\r\n}\r\nstatic ssize_t kovaplus_sysfs_write(struct file *fp, struct kobject *kobj,\r\nvoid const *buf, loff_t off, size_t count,\r\nsize_t real_size, uint command)\r\n{\r\nstruct device *dev =\r\ncontainer_of(kobj, struct device, kobj)->parent->parent;\r\nstruct kovaplus_device *kovaplus = hid_get_drvdata(dev_get_drvdata(dev));\r\nstruct usb_device *usb_dev = interface_to_usbdev(to_usb_interface(dev));\r\nint retval;\r\nif (off != 0 || count != real_size)\r\nreturn -EINVAL;\r\nmutex_lock(&kovaplus->kovaplus_lock);\r\nretval = roccat_common2_send_with_status(usb_dev, command,\r\nbuf, real_size);\r\nmutex_unlock(&kovaplus->kovaplus_lock);\r\nif (retval)\r\nreturn retval;\r\nreturn real_size;\r\n}\r\nstatic ssize_t kovaplus_sysfs_read_profilex_settings(struct file *fp,\r\nstruct kobject *kobj, struct bin_attribute *attr, char *buf,\r\nloff_t off, size_t count)\r\n{\r\nstruct device *dev =\r\ncontainer_of(kobj, struct device, kobj)->parent->parent;\r\nstruct usb_device *usb_dev = interface_to_usbdev(to_usb_interface(dev));\r\nssize_t retval;\r\nretval = kovaplus_select_profile(usb_dev, *(uint *)(attr->private),\r\nKOVAPLUS_CONTROL_REQUEST_PROFILE_SETTINGS);\r\nif (retval)\r\nreturn retval;\r\nreturn kovaplus_sysfs_read(fp, kobj, buf, off, count,\r\nKOVAPLUS_SIZE_PROFILE_SETTINGS,\r\nKOVAPLUS_COMMAND_PROFILE_SETTINGS);\r\n}\r\nstatic ssize_t kovaplus_sysfs_read_profilex_buttons(struct file *fp,\r\nstruct kobject *kobj, struct bin_attribute *attr, char *buf,\r\nloff_t off, size_t count)\r\n{\r\nstruct device *dev =\r\ncontainer_of(kobj, struct device, kobj)->parent->parent;\r\nstruct usb_device *usb_dev = interface_to_usbdev(to_usb_interface(dev));\r\nssize_t retval;\r\nretval = kovaplus_select_profile(usb_dev, *(uint *)(attr->private),\r\nKOVAPLUS_CONTROL_REQUEST_PROFILE_BUTTONS);\r\nif (retval)\r\nreturn retval;\r\nreturn kovaplus_sysfs_read(fp, kobj, buf, off, count,\r\nKOVAPLUS_SIZE_PROFILE_BUTTONS,\r\nKOVAPLUS_COMMAND_PROFILE_BUTTONS);\r\n}\r\nstatic ssize_t kovaplus_sysfs_show_actual_profile(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct kovaplus_device *kovaplus =\r\nhid_get_drvdata(dev_get_drvdata(dev->parent->parent));\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", kovaplus->actual_profile);\r\n}\r\nstatic ssize_t kovaplus_sysfs_set_actual_profile(struct device *dev,\r\nstruct device_attribute *attr, char const *buf, size_t size)\r\n{\r\nstruct kovaplus_device *kovaplus;\r\nstruct usb_device *usb_dev;\r\nunsigned long profile;\r\nint retval;\r\nstruct kovaplus_roccat_report roccat_report;\r\ndev = dev->parent->parent;\r\nkovaplus = hid_get_drvdata(dev_get_drvdata(dev));\r\nusb_dev = interface_to_usbdev(to_usb_interface(dev));\r\nretval = strict_strtoul(buf, 10, &profile);\r\nif (retval)\r\nreturn retval;\r\nif (profile >= 5)\r\nreturn -EINVAL;\r\nmutex_lock(&kovaplus->kovaplus_lock);\r\nretval = kovaplus_set_actual_profile(usb_dev, profile);\r\nif (retval) {\r\nmutex_unlock(&kovaplus->kovaplus_lock);\r\nreturn retval;\r\n}\r\nkovaplus_profile_activated(kovaplus, profile);\r\nroccat_report.type = KOVAPLUS_MOUSE_REPORT_BUTTON_TYPE_PROFILE_1;\r\nroccat_report.profile = profile + 1;\r\nroccat_report.button = 0;\r\nroccat_report.data1 = profile + 1;\r\nroccat_report.data2 = 0;\r\nroccat_report_event(kovaplus->chrdev_minor,\r\n(uint8_t const *)&roccat_report);\r\nmutex_unlock(&kovaplus->kovaplus_lock);\r\nreturn size;\r\n}\r\nstatic ssize_t kovaplus_sysfs_show_actual_cpi(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct kovaplus_device *kovaplus =\r\nhid_get_drvdata(dev_get_drvdata(dev->parent->parent));\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", kovaplus->actual_cpi);\r\n}\r\nstatic ssize_t kovaplus_sysfs_show_actual_sensitivity_x(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct kovaplus_device *kovaplus =\r\nhid_get_drvdata(dev_get_drvdata(dev->parent->parent));\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", kovaplus->actual_x_sensitivity);\r\n}\r\nstatic ssize_t kovaplus_sysfs_show_actual_sensitivity_y(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct kovaplus_device *kovaplus =\r\nhid_get_drvdata(dev_get_drvdata(dev->parent->parent));\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", kovaplus->actual_y_sensitivity);\r\n}\r\nstatic ssize_t kovaplus_sysfs_show_firmware_version(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct kovaplus_device *kovaplus;\r\nstruct usb_device *usb_dev;\r\nstruct kovaplus_info info;\r\ndev = dev->parent->parent;\r\nkovaplus = hid_get_drvdata(dev_get_drvdata(dev));\r\nusb_dev = interface_to_usbdev(to_usb_interface(dev));\r\nmutex_lock(&kovaplus->kovaplus_lock);\r\nroccat_common2_receive(usb_dev, KOVAPLUS_COMMAND_INFO,\r\n&info, KOVAPLUS_SIZE_INFO);\r\nmutex_unlock(&kovaplus->kovaplus_lock);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", info.firmware_version);\r\n}\r\nstatic int kovaplus_init_kovaplus_device_struct(struct usb_device *usb_dev,\r\nstruct kovaplus_device *kovaplus)\r\n{\r\nint retval, i;\r\nstatic uint wait = 70;\r\nmutex_init(&kovaplus->kovaplus_lock);\r\nfor (i = 0; i < 5; ++i) {\r\nmsleep(wait);\r\nretval = kovaplus_get_profile_settings(usb_dev,\r\n&kovaplus->profile_settings[i], i);\r\nif (retval)\r\nreturn retval;\r\nmsleep(wait);\r\nretval = kovaplus_get_profile_buttons(usb_dev,\r\n&kovaplus->profile_buttons[i], i);\r\nif (retval)\r\nreturn retval;\r\n}\r\nmsleep(wait);\r\nretval = kovaplus_get_actual_profile(usb_dev);\r\nif (retval < 0)\r\nreturn retval;\r\nkovaplus_profile_activated(kovaplus, retval);\r\nreturn 0;\r\n}\r\nstatic int kovaplus_init_specials(struct hid_device *hdev)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\r\nstruct usb_device *usb_dev = interface_to_usbdev(intf);\r\nstruct kovaplus_device *kovaplus;\r\nint retval;\r\nif (intf->cur_altsetting->desc.bInterfaceProtocol\r\n== USB_INTERFACE_PROTOCOL_MOUSE) {\r\nkovaplus = kzalloc(sizeof(*kovaplus), GFP_KERNEL);\r\nif (!kovaplus) {\r\nhid_err(hdev, "can't alloc device descriptor\n");\r\nreturn -ENOMEM;\r\n}\r\nhid_set_drvdata(hdev, kovaplus);\r\nretval = kovaplus_init_kovaplus_device_struct(usb_dev, kovaplus);\r\nif (retval) {\r\nhid_err(hdev, "couldn't init struct kovaplus_device\n");\r\ngoto exit_free;\r\n}\r\nretval = roccat_connect(kovaplus_class, hdev,\r\nsizeof(struct kovaplus_roccat_report));\r\nif (retval < 0) {\r\nhid_err(hdev, "couldn't init char dev\n");\r\n} else {\r\nkovaplus->chrdev_minor = retval;\r\nkovaplus->roccat_claimed = 1;\r\n}\r\n} else {\r\nhid_set_drvdata(hdev, NULL);\r\n}\r\nreturn 0;\r\nexit_free:\r\nkfree(kovaplus);\r\nreturn retval;\r\n}\r\nstatic void kovaplus_remove_specials(struct hid_device *hdev)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\r\nstruct kovaplus_device *kovaplus;\r\nif (intf->cur_altsetting->desc.bInterfaceProtocol\r\n== USB_INTERFACE_PROTOCOL_MOUSE) {\r\nkovaplus = hid_get_drvdata(hdev);\r\nif (kovaplus->roccat_claimed)\r\nroccat_disconnect(kovaplus->chrdev_minor);\r\nkfree(kovaplus);\r\n}\r\n}\r\nstatic int kovaplus_probe(struct hid_device *hdev,\r\nconst struct hid_device_id *id)\r\n{\r\nint retval;\r\nretval = hid_parse(hdev);\r\nif (retval) {\r\nhid_err(hdev, "parse failed\n");\r\ngoto exit;\r\n}\r\nretval = hid_hw_start(hdev, HID_CONNECT_DEFAULT);\r\nif (retval) {\r\nhid_err(hdev, "hw start failed\n");\r\ngoto exit;\r\n}\r\nretval = kovaplus_init_specials(hdev);\r\nif (retval) {\r\nhid_err(hdev, "couldn't install mouse\n");\r\ngoto exit_stop;\r\n}\r\nreturn 0;\r\nexit_stop:\r\nhid_hw_stop(hdev);\r\nexit:\r\nreturn retval;\r\n}\r\nstatic void kovaplus_remove(struct hid_device *hdev)\r\n{\r\nkovaplus_remove_specials(hdev);\r\nhid_hw_stop(hdev);\r\n}\r\nstatic void kovaplus_keep_values_up_to_date(struct kovaplus_device *kovaplus,\r\nu8 const *data)\r\n{\r\nstruct kovaplus_mouse_report_button const *button_report;\r\nif (data[0] != KOVAPLUS_MOUSE_REPORT_NUMBER_BUTTON)\r\nreturn;\r\nbutton_report = (struct kovaplus_mouse_report_button const *)data;\r\nswitch (button_report->type) {\r\ncase KOVAPLUS_MOUSE_REPORT_BUTTON_TYPE_PROFILE_1:\r\nkovaplus_profile_activated(kovaplus, button_report->data1 - 1);\r\nbreak;\r\ncase KOVAPLUS_MOUSE_REPORT_BUTTON_TYPE_CPI:\r\nkovaplus->actual_cpi = kovaplus_convert_event_cpi(button_report->data1);\r\ncase KOVAPLUS_MOUSE_REPORT_BUTTON_TYPE_SENSITIVITY:\r\nkovaplus->actual_x_sensitivity = button_report->data1;\r\nkovaplus->actual_y_sensitivity = button_report->data2;\r\n}\r\n}\r\nstatic void kovaplus_report_to_chrdev(struct kovaplus_device const *kovaplus,\r\nu8 const *data)\r\n{\r\nstruct kovaplus_roccat_report roccat_report;\r\nstruct kovaplus_mouse_report_button const *button_report;\r\nif (data[0] != KOVAPLUS_MOUSE_REPORT_NUMBER_BUTTON)\r\nreturn;\r\nbutton_report = (struct kovaplus_mouse_report_button const *)data;\r\nif (button_report->type == KOVAPLUS_MOUSE_REPORT_BUTTON_TYPE_PROFILE_2)\r\nreturn;\r\nroccat_report.type = button_report->type;\r\nroccat_report.profile = kovaplus->actual_profile + 1;\r\nif (roccat_report.type == KOVAPLUS_MOUSE_REPORT_BUTTON_TYPE_MACRO ||\r\nroccat_report.type == KOVAPLUS_MOUSE_REPORT_BUTTON_TYPE_SHORTCUT ||\r\nroccat_report.type == KOVAPLUS_MOUSE_REPORT_BUTTON_TYPE_QUICKLAUNCH ||\r\nroccat_report.type == KOVAPLUS_MOUSE_REPORT_BUTTON_TYPE_TIMER)\r\nroccat_report.button = button_report->data1;\r\nelse\r\nroccat_report.button = 0;\r\nif (roccat_report.type == KOVAPLUS_MOUSE_REPORT_BUTTON_TYPE_CPI)\r\nroccat_report.data1 = kovaplus_convert_event_cpi(button_report->data1);\r\nelse\r\nroccat_report.data1 = button_report->data1;\r\nroccat_report.data2 = button_report->data2;\r\nroccat_report_event(kovaplus->chrdev_minor,\r\n(uint8_t const *)&roccat_report);\r\n}\r\nstatic int kovaplus_raw_event(struct hid_device *hdev,\r\nstruct hid_report *report, u8 *data, int size)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\r\nstruct kovaplus_device *kovaplus = hid_get_drvdata(hdev);\r\nif (intf->cur_altsetting->desc.bInterfaceProtocol\r\n!= USB_INTERFACE_PROTOCOL_MOUSE)\r\nreturn 0;\r\nif (kovaplus == NULL)\r\nreturn 0;\r\nkovaplus_keep_values_up_to_date(kovaplus, data);\r\nif (kovaplus->roccat_claimed)\r\nkovaplus_report_to_chrdev(kovaplus, data);\r\nreturn 0;\r\n}\r\nstatic int __init kovaplus_init(void)\r\n{\r\nint retval;\r\nkovaplus_class = class_create(THIS_MODULE, "kovaplus");\r\nif (IS_ERR(kovaplus_class))\r\nreturn PTR_ERR(kovaplus_class);\r\nkovaplus_class->dev_attrs = kovaplus_attributes;\r\nkovaplus_class->dev_bin_attrs = kovaplus_bin_attributes;\r\nretval = hid_register_driver(&kovaplus_driver);\r\nif (retval)\r\nclass_destroy(kovaplus_class);\r\nreturn retval;\r\n}\r\nstatic void __exit kovaplus_exit(void)\r\n{\r\nhid_unregister_driver(&kovaplus_driver);\r\nclass_destroy(kovaplus_class);\r\n}

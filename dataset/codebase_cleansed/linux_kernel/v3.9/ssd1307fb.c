static int ssd1307fb_write_array(struct i2c_client *client, u8 type, u8 *cmd, u32 len)\r\n{\r\nu8 *buf;\r\nint ret = 0;\r\nbuf = kzalloc(len + 1, GFP_KERNEL);\r\nif (!buf) {\r\ndev_err(&client->dev, "Couldn't allocate sending buffer.\n");\r\nreturn -ENOMEM;\r\n}\r\nbuf[0] = type;\r\nmemcpy(buf + 1, cmd, len);\r\nret = i2c_master_send(client, buf, len + 1);\r\nif (ret != len + 1) {\r\ndev_err(&client->dev, "Couldn't send I2C command.\n");\r\ngoto error;\r\n}\r\nerror:\r\nkfree(buf);\r\nreturn ret;\r\n}\r\nstatic inline int ssd1307fb_write_cmd_array(struct i2c_client *client, u8 *cmd, u32 len)\r\n{\r\nreturn ssd1307fb_write_array(client, SSD1307FB_COMMAND, cmd, len);\r\n}\r\nstatic inline int ssd1307fb_write_cmd(struct i2c_client *client, u8 cmd)\r\n{\r\nreturn ssd1307fb_write_cmd_array(client, &cmd, 1);\r\n}\r\nstatic inline int ssd1307fb_write_data_array(struct i2c_client *client, u8 *cmd, u32 len)\r\n{\r\nreturn ssd1307fb_write_array(client, SSD1307FB_DATA, cmd, len);\r\n}\r\nstatic inline int ssd1307fb_write_data(struct i2c_client *client, u8 data)\r\n{\r\nreturn ssd1307fb_write_data_array(client, &data, 1);\r\n}\r\nstatic void ssd1307fb_update_display(struct ssd1307fb_par *par)\r\n{\r\nu8 *vmem = par->info->screen_base;\r\nint i, j, k;\r\nfor (i = 0; i < (SSD1307FB_HEIGHT / 8); i++) {\r\nssd1307fb_write_cmd(par->client, SSD1307FB_START_PAGE_ADDRESS + (i + 1));\r\nssd1307fb_write_cmd(par->client, 0x00);\r\nssd1307fb_write_cmd(par->client, 0x10);\r\nfor (j = 0; j < SSD1307FB_WIDTH; j++) {\r\nu8 buf = 0;\r\nfor (k = 0; k < 8; k++) {\r\nu32 page_length = SSD1307FB_WIDTH * i;\r\nu32 index = page_length + (SSD1307FB_WIDTH * k + j) / 8;\r\nu8 byte = *(vmem + index);\r\nu8 bit = byte & (1 << (j % 8));\r\nbit = bit >> (j % 8);\r\nbuf |= bit << k;\r\n}\r\nssd1307fb_write_data(par->client, buf);\r\n}\r\n}\r\n}\r\nstatic ssize_t ssd1307fb_write(struct fb_info *info, const char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ssd1307fb_par *par = info->par;\r\nunsigned long total_size;\r\nunsigned long p = *ppos;\r\nu8 __iomem *dst;\r\ntotal_size = info->fix.smem_len;\r\nif (p > total_size)\r\nreturn -EINVAL;\r\nif (count + p > total_size)\r\ncount = total_size - p;\r\nif (!count)\r\nreturn -EINVAL;\r\ndst = (void __force *) (info->screen_base + p);\r\nif (copy_from_user(dst, buf, count))\r\nreturn -EFAULT;\r\nssd1307fb_update_display(par);\r\n*ppos += count;\r\nreturn count;\r\n}\r\nstatic void ssd1307fb_fillrect(struct fb_info *info, const struct fb_fillrect *rect)\r\n{\r\nstruct ssd1307fb_par *par = info->par;\r\nsys_fillrect(info, rect);\r\nssd1307fb_update_display(par);\r\n}\r\nstatic void ssd1307fb_copyarea(struct fb_info *info, const struct fb_copyarea *area)\r\n{\r\nstruct ssd1307fb_par *par = info->par;\r\nsys_copyarea(info, area);\r\nssd1307fb_update_display(par);\r\n}\r\nstatic void ssd1307fb_imageblit(struct fb_info *info, const struct fb_image *image)\r\n{\r\nstruct ssd1307fb_par *par = info->par;\r\nsys_imageblit(info, image);\r\nssd1307fb_update_display(par);\r\n}\r\nstatic void ssd1307fb_deferred_io(struct fb_info *info,\r\nstruct list_head *pagelist)\r\n{\r\nssd1307fb_update_display(info->par);\r\n}\r\nstatic int ssd1307fb_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct fb_info *info;\r\nu32 vmem_size = SSD1307FB_WIDTH * SSD1307FB_HEIGHT / 8;\r\nstruct ssd1307fb_par *par;\r\nu8 *vmem;\r\nint ret;\r\nif (!client->dev.of_node) {\r\ndev_err(&client->dev, "No device tree data found!\n");\r\nreturn -EINVAL;\r\n}\r\ninfo = framebuffer_alloc(sizeof(struct ssd1307fb_par), &client->dev);\r\nif (!info) {\r\ndev_err(&client->dev, "Couldn't allocate framebuffer.\n");\r\nreturn -ENOMEM;\r\n}\r\nvmem = devm_kzalloc(&client->dev, vmem_size, GFP_KERNEL);\r\nif (!vmem) {\r\ndev_err(&client->dev, "Couldn't allocate graphical memory.\n");\r\nret = -ENOMEM;\r\ngoto fb_alloc_error;\r\n}\r\ninfo->fbops = &ssd1307fb_ops;\r\ninfo->fix = ssd1307fb_fix;\r\ninfo->fbdefio = &ssd1307fb_defio;\r\ninfo->var = ssd1307fb_var;\r\ninfo->var.red.length = 1;\r\ninfo->var.red.offset = 0;\r\ninfo->var.green.length = 1;\r\ninfo->var.green.offset = 0;\r\ninfo->var.blue.length = 1;\r\ninfo->var.blue.offset = 0;\r\ninfo->screen_base = (u8 __force __iomem *)vmem;\r\ninfo->fix.smem_start = (unsigned long)vmem;\r\ninfo->fix.smem_len = vmem_size;\r\nfb_deferred_io_init(info);\r\npar = info->par;\r\npar->info = info;\r\npar->client = client;\r\npar->reset = of_get_named_gpio(client->dev.of_node,\r\n"reset-gpios", 0);\r\nif (!gpio_is_valid(par->reset)) {\r\nret = -EINVAL;\r\ngoto reset_oled_error;\r\n}\r\nret = devm_gpio_request_one(&client->dev, par->reset,\r\nGPIOF_OUT_INIT_HIGH,\r\n"oled-reset");\r\nif (ret) {\r\ndev_err(&client->dev,\r\n"failed to request gpio %d: %d\n",\r\npar->reset, ret);\r\ngoto reset_oled_error;\r\n}\r\npar->pwm = pwm_get(&client->dev, NULL);\r\nif (IS_ERR(par->pwm)) {\r\ndev_err(&client->dev, "Could not get PWM from device tree!\n");\r\nret = PTR_ERR(par->pwm);\r\ngoto pwm_error;\r\n}\r\npar->pwm_period = pwm_get_period(par->pwm);\r\ndev_dbg(&client->dev, "Using PWM%d with a %dns period.\n", par->pwm->pwm, par->pwm_period);\r\nret = register_framebuffer(info);\r\nif (ret) {\r\ndev_err(&client->dev, "Couldn't register the framebuffer\n");\r\ngoto fbreg_error;\r\n}\r\ni2c_set_clientdata(client, info);\r\ngpio_set_value(par->reset, 0);\r\nudelay(4);\r\ngpio_set_value(par->reset, 1);\r\nudelay(4);\r\npwm_config(par->pwm, par->pwm_period / 2, par->pwm_period);\r\npwm_enable(par->pwm);\r\nret = ssd1307fb_write_cmd(client, SSD1307FB_SEG_REMAP_ON);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "Couldn't remap the screen.\n");\r\ngoto remap_error;\r\n}\r\nret = ssd1307fb_write_cmd(client, SSD1307FB_DISPLAY_ON);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "Couldn't turn the display on.\n");\r\ngoto remap_error;\r\n}\r\ndev_info(&client->dev, "fb%d: %s framebuffer device registered, using %d bytes of video memory\n", info->node, info->fix.id, vmem_size);\r\nreturn 0;\r\nremap_error:\r\nunregister_framebuffer(info);\r\npwm_disable(par->pwm);\r\nfbreg_error:\r\npwm_put(par->pwm);\r\npwm_error:\r\nreset_oled_error:\r\nfb_deferred_io_cleanup(info);\r\nfb_alloc_error:\r\nframebuffer_release(info);\r\nreturn ret;\r\n}\r\nstatic int ssd1307fb_remove(struct i2c_client *client)\r\n{\r\nstruct fb_info *info = i2c_get_clientdata(client);\r\nstruct ssd1307fb_par *par = info->par;\r\nunregister_framebuffer(info);\r\npwm_disable(par->pwm);\r\npwm_put(par->pwm);\r\nfb_deferred_io_cleanup(info);\r\nframebuffer_release(info);\r\nreturn 0;\r\n}

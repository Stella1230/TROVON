static int debugfs_errno_set(void *data, u64 val)\r\n{\r\n*(int *)data = clamp_t(int, val, -MAX_ERRNO, 0);\r\nreturn 0;\r\n}\r\nstatic int debugfs_errno_get(void *data, u64 *val)\r\n{\r\n*val = *(int *)data;\r\nreturn 0;\r\n}\r\nstatic struct dentry *debugfs_create_errno(const char *name, mode_t mode,\r\nstruct dentry *parent, int *value)\r\n{\r\nreturn debugfs_create_file(name, mode, parent, value, &fops_errno);\r\n}\r\nstatic int notifier_err_inject_callback(struct notifier_block *nb,\r\nunsigned long val, void *p)\r\n{\r\nint err = 0;\r\nstruct notifier_err_inject *err_inject =\r\ncontainer_of(nb, struct notifier_err_inject, nb);\r\nstruct notifier_err_inject_action *action;\r\nfor (action = err_inject->actions; action->name; action++) {\r\nif (action->val == val) {\r\nerr = action->error;\r\nbreak;\r\n}\r\n}\r\nif (err)\r\npr_info("Injecting error (%d) to %s\n", err, action->name);\r\nreturn notifier_from_errno(err);\r\n}\r\nstruct dentry *notifier_err_inject_init(const char *name, struct dentry *parent,\r\nstruct notifier_err_inject *err_inject, int priority)\r\n{\r\nstruct notifier_err_inject_action *action;\r\nmode_t mode = S_IFREG | S_IRUSR | S_IWUSR;\r\nstruct dentry *dir;\r\nstruct dentry *actions_dir;\r\nerr_inject->nb.notifier_call = notifier_err_inject_callback;\r\nerr_inject->nb.priority = priority;\r\ndir = debugfs_create_dir(name, parent);\r\nif (!dir)\r\nreturn ERR_PTR(-ENOMEM);\r\nactions_dir = debugfs_create_dir("actions", dir);\r\nif (!actions_dir)\r\ngoto fail;\r\nfor (action = err_inject->actions; action->name; action++) {\r\nstruct dentry *action_dir;\r\naction_dir = debugfs_create_dir(action->name, actions_dir);\r\nif (!action_dir)\r\ngoto fail;\r\nif (!debugfs_create_errno("error", mode, action_dir,\r\n&action->error))\r\ngoto fail;\r\n}\r\nreturn dir;\r\nfail:\r\ndebugfs_remove_recursive(dir);\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nstatic int __init err_inject_init(void)\r\n{\r\nnotifier_err_inject_dir =\r\ndebugfs_create_dir("notifier-error-inject", NULL);\r\nif (!notifier_err_inject_dir)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nstatic void __exit err_inject_exit(void)\r\n{\r\ndebugfs_remove_recursive(notifier_err_inject_dir);\r\n}

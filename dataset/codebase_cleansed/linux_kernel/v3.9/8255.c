static int subdev_8255_io(int dir, int port, int data, unsigned long iobase)\r\n{\r\nif (dir) {\r\noutb(data, iobase + port);\r\nreturn 0;\r\n} else {\r\nreturn inb(iobase + port);\r\n}\r\n}\r\nvoid subdev_8255_interrupt(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nstruct subdev_8255_private *spriv = s->private;\r\nunsigned long iobase = spriv->iobase;\r\nshort d;\r\nd = spriv->io(0, _8255_DATA, 0, iobase);\r\nd |= (spriv->io(0, _8255_DATA + 1, 0, iobase) << 8);\r\ncomedi_buf_put(s->async, d);\r\ns->async->events |= COMEDI_CB_EOS;\r\ncomedi_event(dev, s);\r\n}\r\nstatic int subdev_8255_insn(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nstruct subdev_8255_private *spriv = s->private;\r\nunsigned long iobase = spriv->iobase;\r\nunsigned int mask;\r\nunsigned int bits;\r\nunsigned int v;\r\nmask = data[0];\r\nbits = data[1];\r\nif (mask) {\r\nv = s->state;\r\nv &= ~mask;\r\nv |= (bits & mask);\r\nif (mask & 0xff)\r\nspriv->io(1, _8255_DATA, v & 0xff, iobase);\r\nif (mask & 0xff00)\r\nspriv->io(1, _8255_DATA + 1, (v >> 8) & 0xff, iobase);\r\nif (mask & 0xff0000)\r\nspriv->io(1, _8255_DATA + 2, (v >> 16) & 0xff, iobase);\r\ns->state = v;\r\n}\r\nv = spriv->io(0, _8255_DATA, 0, iobase);\r\nv |= (spriv->io(0, _8255_DATA + 1, 0, iobase) << 8);\r\nv |= (spriv->io(0, _8255_DATA + 2, 0, iobase) << 16);\r\ndata[1] = v;\r\nreturn insn->n;\r\n}\r\nstatic void subdev_8255_do_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nstruct subdev_8255_private *spriv = s->private;\r\nunsigned long iobase = spriv->iobase;\r\nint config;\r\nconfig = CR_CW;\r\nif (!(s->io_bits & 0x0000ff))\r\nconfig |= CR_A_IO;\r\nif (!(s->io_bits & 0x00ff00))\r\nconfig |= CR_B_IO;\r\nif (!(s->io_bits & 0x0f0000))\r\nconfig |= CR_C_LO_IO;\r\nif (!(s->io_bits & 0xf00000))\r\nconfig |= CR_C_HI_IO;\r\nspriv->io(1, _8255_CR, config, iobase);\r\n}\r\nstatic int subdev_8255_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nunsigned int mask;\r\nunsigned int bits;\r\nmask = 1 << CR_CHAN(insn->chanspec);\r\nif (mask & 0x0000ff)\r\nbits = 0x0000ff;\r\nelse if (mask & 0x00ff00)\r\nbits = 0x00ff00;\r\nelse if (mask & 0x0f0000)\r\nbits = 0x0f0000;\r\nelse\r\nbits = 0xf00000;\r\nswitch (data[0]) {\r\ncase INSN_CONFIG_DIO_INPUT:\r\ns->io_bits &= ~bits;\r\nbreak;\r\ncase INSN_CONFIG_DIO_OUTPUT:\r\ns->io_bits |= bits;\r\nbreak;\r\ncase INSN_CONFIG_DIO_QUERY:\r\ndata[1] = (s->io_bits & bits) ? COMEDI_OUTPUT : COMEDI_INPUT;\r\nreturn insn->n;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nsubdev_8255_do_config(dev, s);\r\nreturn 1;\r\n}\r\nstatic int subdev_8255_cmdtest(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_cmd *cmd)\r\n{\r\nint err = 0;\r\nerr |= cfc_check_trigger_src(&cmd->start_src, TRIG_NOW);\r\nerr |= cfc_check_trigger_src(&cmd->scan_begin_src, TRIG_EXT);\r\nerr |= cfc_check_trigger_src(&cmd->convert_src, TRIG_FOLLOW);\r\nerr |= cfc_check_trigger_src(&cmd->scan_end_src, TRIG_COUNT);\r\nerr |= cfc_check_trigger_src(&cmd->stop_src, TRIG_NONE);\r\nif (err)\r\nreturn 1;\r\nif (err)\r\nreturn 2;\r\nerr |= cfc_check_trigger_arg_is(&cmd->start_arg, 0);\r\nerr |= cfc_check_trigger_arg_is(&cmd->scan_begin_arg, 0);\r\nerr |= cfc_check_trigger_arg_is(&cmd->convert_arg, 0);\r\nerr |= cfc_check_trigger_arg_is(&cmd->scan_end_arg, 1);\r\nerr |= cfc_check_trigger_arg_is(&cmd->stop_arg, 0);\r\nif (err)\r\nreturn 3;\r\nif (err)\r\nreturn 4;\r\nreturn 0;\r\n}\r\nstatic int subdev_8255_cmd(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nreturn 0;\r\n}\r\nstatic int subdev_8255_cancel(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nreturn 0;\r\n}\r\nint subdev_8255_init(struct comedi_device *dev, struct comedi_subdevice *s,\r\nint (*io) (int, int, int, unsigned long),\r\nunsigned long iobase)\r\n{\r\nstruct subdev_8255_private *spriv;\r\nspriv = kzalloc(sizeof(*spriv), GFP_KERNEL);\r\nif (!spriv)\r\nreturn -ENOMEM;\r\nspriv->iobase = iobase;\r\nspriv->io = io ? io : subdev_8255_io;\r\ns->private = spriv;\r\ns->type = COMEDI_SUBD_DIO;\r\ns->subdev_flags = SDF_READABLE | SDF_WRITABLE;\r\ns->n_chan = 24;\r\ns->range_table = &range_digital;\r\ns->maxdata = 1;\r\ns->insn_bits = subdev_8255_insn;\r\ns->insn_config = subdev_8255_insn_config;\r\ns->state = 0;\r\ns->io_bits = 0;\r\nsubdev_8255_do_config(dev, s);\r\nreturn 0;\r\n}\r\nint subdev_8255_init_irq(struct comedi_device *dev, struct comedi_subdevice *s,\r\nint (*io) (int, int, int, unsigned long),\r\nunsigned long iobase)\r\n{\r\nint ret;\r\nret = subdev_8255_init(dev, s, io, iobase);\r\nif (ret)\r\nreturn ret;\r\ns->do_cmdtest = subdev_8255_cmdtest;\r\ns->do_cmd = subdev_8255_cmd;\r\ns->cancel = subdev_8255_cancel;\r\nreturn 0;\r\n}\r\nvoid subdev_8255_cleanup(struct comedi_device *dev, struct comedi_subdevice *s)\r\n{\r\nkfree(s->private);\r\n}\r\nstatic int dev_8255_attach(struct comedi_device *dev,\r\nstruct comedi_devconfig *it)\r\n{\r\nstruct comedi_subdevice *s;\r\nint ret;\r\nunsigned long iobase;\r\nint i;\r\ndev->board_name = "8255";\r\nfor (i = 0; i < COMEDI_NDEVCONFOPTS; i++) {\r\niobase = it->options[i];\r\nif (!iobase)\r\nbreak;\r\n}\r\nif (i == 0) {\r\ndev_warn(dev->class_dev, "no devices specified\n");\r\nreturn -EINVAL;\r\n}\r\nret = comedi_alloc_subdevices(dev, i);\r\nif (ret)\r\nreturn ret;\r\nfor (i = 0; i < dev->n_subdevices; i++) {\r\ns = &dev->subdevices[i];\r\niobase = it->options[i];\r\nif (!request_region(iobase, _8255_SIZE, "8255")) {\r\ndev_warn(dev->class_dev,\r\n"0x%04lx (I/O port conflict)\n", iobase);\r\ns->type = COMEDI_SUBD_UNUSED;\r\n} else {\r\nret = subdev_8255_init(dev, s, NULL, iobase);\r\nif (ret)\r\nreturn ret;\r\ndev_info(dev->class_dev, "0x%04lx\n", iobase);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void dev_8255_detach(struct comedi_device *dev)\r\n{\r\nstruct comedi_subdevice *s;\r\nstruct subdev_8255_private *spriv;\r\nint i;\r\nfor (i = 0; i < dev->n_subdevices; i++) {\r\ns = &dev->subdevices[i];\r\nif (s->type != COMEDI_SUBD_UNUSED) {\r\nspriv = s->private;\r\nrelease_region(spriv->iobase, _8255_SIZE);\r\n}\r\nsubdev_8255_cleanup(dev, s);\r\n}\r\n}

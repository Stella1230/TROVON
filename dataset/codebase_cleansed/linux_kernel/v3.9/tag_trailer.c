netdev_tx_t trailer_xmit(struct sk_buff *skb, struct net_device *dev)\r\n{\r\nstruct dsa_slave_priv *p = netdev_priv(dev);\r\nstruct sk_buff *nskb;\r\nint padlen;\r\nu8 *trailer;\r\ndev->stats.tx_packets++;\r\ndev->stats.tx_bytes += skb->len;\r\npadlen = 0;\r\nif (skb->len < 60)\r\npadlen = 60 - skb->len;\r\nnskb = alloc_skb(NET_IP_ALIGN + skb->len + padlen + 4, GFP_ATOMIC);\r\nif (nskb == NULL) {\r\nkfree_skb(skb);\r\nreturn NETDEV_TX_OK;\r\n}\r\nskb_reserve(nskb, NET_IP_ALIGN);\r\nskb_reset_mac_header(nskb);\r\nskb_set_network_header(nskb, skb_network_header(skb) - skb->head);\r\nskb_set_transport_header(nskb, skb_transport_header(skb) - skb->head);\r\nskb_copy_and_csum_dev(skb, skb_put(nskb, skb->len));\r\nkfree_skb(skb);\r\nif (padlen) {\r\nu8 *pad = skb_put(nskb, padlen);\r\nmemset(pad, 0, padlen);\r\n}\r\ntrailer = skb_put(nskb, 4);\r\ntrailer[0] = 0x80;\r\ntrailer[1] = 1 << p->port;\r\ntrailer[2] = 0x10;\r\ntrailer[3] = 0x00;\r\nnskb->protocol = htons(ETH_P_TRAILER);\r\nnskb->dev = p->parent->dst->master_netdev;\r\ndev_queue_xmit(nskb);\r\nreturn NETDEV_TX_OK;\r\n}\r\nstatic int trailer_rcv(struct sk_buff *skb, struct net_device *dev,\r\nstruct packet_type *pt, struct net_device *orig_dev)\r\n{\r\nstruct dsa_switch_tree *dst = dev->dsa_ptr;\r\nstruct dsa_switch *ds;\r\nu8 *trailer;\r\nint source_port;\r\nif (unlikely(dst == NULL))\r\ngoto out_drop;\r\nds = dst->ds[0];\r\nskb = skb_unshare(skb, GFP_ATOMIC);\r\nif (skb == NULL)\r\ngoto out;\r\nif (skb_linearize(skb))\r\ngoto out_drop;\r\ntrailer = skb_tail_pointer(skb) - 4;\r\nif (trailer[0] != 0x80 || (trailer[1] & 0xf8) != 0x00 ||\r\n(trailer[3] & 0xef) != 0x00 || trailer[3] != 0x00)\r\ngoto out_drop;\r\nsource_port = trailer[1] & 7;\r\nif (source_port >= DSA_MAX_PORTS || ds->ports[source_port] == NULL)\r\ngoto out_drop;\r\npskb_trim_rcsum(skb, skb->len - 4);\r\nskb->dev = ds->ports[source_port];\r\nskb_push(skb, ETH_HLEN);\r\nskb->pkt_type = PACKET_HOST;\r\nskb->protocol = eth_type_trans(skb, skb->dev);\r\nskb->dev->stats.rx_packets++;\r\nskb->dev->stats.rx_bytes += skb->len;\r\nnetif_receive_skb(skb);\r\nreturn 0;\r\nout_drop:\r\nkfree_skb(skb);\r\nout:\r\nreturn 0;\r\n}

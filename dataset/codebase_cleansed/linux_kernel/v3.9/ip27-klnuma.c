void __init setup_replication_mask(void)\r\n{\r\ncpus_clear(ktext_repmask);\r\ncpu_set(0, ktext_repmask);\r\n#ifdef CONFIG_REPLICATE_KTEXT\r\n#ifndef CONFIG_MAPPED_KERNEL\r\n#error Kernel replication works with mapped kernel support. No calias support.\r\n#endif\r\n{\r\ncnodeid_t cnode;\r\nfor_each_online_node(cnode) {\r\nif (cnode == 0)\r\ncontinue;\r\ncpu_set(cnode, ktext_repmask);\r\n}\r\n}\r\n#endif\r\nGDA->g_ktext_repmask = &ktext_repmask;\r\n}\r\nstatic __init void set_ktext_source(nasid_t client_nasid, nasid_t server_nasid)\r\n{\r\nkern_vars_t *kvp;\r\nkvp = &hub_data(client_nasid)->kern_vars;\r\nKERN_VARS_ADDR(client_nasid) = (unsigned long)kvp;\r\nkvp->kv_magic = KV_MAGIC;\r\nkvp->kv_ro_nasid = server_nasid;\r\nkvp->kv_rw_nasid = master_nasid;\r\nkvp->kv_ro_baseaddr = NODE_CAC_BASE(server_nasid);\r\nkvp->kv_rw_baseaddr = NODE_CAC_BASE(master_nasid);\r\nprintk("REPLICATION: ON nasid %d, ktext from nasid %d, kdata from nasid %d\n", client_nasid, server_nasid, master_nasid);\r\n}\r\nstatic __init void copy_kernel(nasid_t dest_nasid)\r\n{\r\nunsigned long dest_kern_start, source_start, source_end, kern_size;\r\nsource_start = (unsigned long) _stext;\r\nsource_end = (unsigned long) _etext;\r\nkern_size = source_end - source_start;\r\ndest_kern_start = CHANGE_ADDR_NASID(MAPPED_KERN_RO_TO_K0(source_start),\r\ndest_nasid);\r\nmemcpy((void *)dest_kern_start, (void *)source_start, kern_size);\r\n}\r\nvoid __init replicate_kernel_text()\r\n{\r\ncnodeid_t cnode;\r\nnasid_t client_nasid;\r\nnasid_t server_nasid;\r\nserver_nasid = master_nasid;\r\nset_ktext_source(master_nasid, master_nasid);\r\nfor_each_online_node(cnode) {\r\nif (cnode == 0)\r\ncontinue;\r\nclient_nasid = COMPACT_TO_NASID_NODEID(cnode);\r\nif (cpu_isset(cnode, ktext_repmask)) {\r\nserver_nasid = client_nasid;\r\ncopy_kernel(server_nasid);\r\n}\r\nset_ktext_source(client_nasid, server_nasid);\r\n}\r\n}\r\npfn_t node_getfirstfree(cnodeid_t cnode)\r\n{\r\nunsigned long loadbase = REP_BASE;\r\nnasid_t nasid = COMPACT_TO_NASID_NODEID(cnode);\r\nunsigned long offset;\r\n#ifdef CONFIG_MAPPED_KERNEL\r\nloadbase += 16777216;\r\n#endif\r\noffset = PAGE_ALIGN((unsigned long)(&_end)) - loadbase;\r\nif ((cnode == 0) || (cpu_isset(cnode, ktext_repmask)))\r\nreturn (TO_NODE(nasid, offset) >> PAGE_SHIFT);\r\nelse\r\nreturn (KDM_TO_PHYS(PAGE_ALIGN(SYMMON_STK_ADDR(nasid, 0))) >>\r\nPAGE_SHIFT);\r\n}

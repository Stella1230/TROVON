static void cfservl_ctrlcmd(struct cflayer *layr, enum caif_ctrlcmd ctrl,\r\nint phyid)\r\n{\r\nstruct cfsrvl *service = container_obj(layr);\r\nif (layr->up == NULL || layr->up->ctrlcmd == NULL)\r\nreturn;\r\nswitch (ctrl) {\r\ncase CAIF_CTRLCMD_INIT_RSP:\r\nservice->open = true;\r\nlayr->up->ctrlcmd(layr->up, ctrl, phyid);\r\nbreak;\r\ncase CAIF_CTRLCMD_DEINIT_RSP:\r\ncase CAIF_CTRLCMD_INIT_FAIL_RSP:\r\nservice->open = false;\r\nlayr->up->ctrlcmd(layr->up, ctrl, phyid);\r\nbreak;\r\ncase _CAIF_CTRLCMD_PHYIF_FLOW_OFF_IND:\r\nif (phyid != service->dev_info.id)\r\nbreak;\r\nif (service->modem_flow_on)\r\nlayr->up->ctrlcmd(layr->up,\r\nCAIF_CTRLCMD_FLOW_OFF_IND, phyid);\r\nservice->phy_flow_on = false;\r\nbreak;\r\ncase _CAIF_CTRLCMD_PHYIF_FLOW_ON_IND:\r\nif (phyid != service->dev_info.id)\r\nreturn;\r\nif (service->modem_flow_on) {\r\nlayr->up->ctrlcmd(layr->up,\r\nCAIF_CTRLCMD_FLOW_ON_IND,\r\nphyid);\r\n}\r\nservice->phy_flow_on = true;\r\nbreak;\r\ncase CAIF_CTRLCMD_FLOW_OFF_IND:\r\nif (service->phy_flow_on) {\r\nlayr->up->ctrlcmd(layr->up,\r\nCAIF_CTRLCMD_FLOW_OFF_IND, phyid);\r\n}\r\nservice->modem_flow_on = false;\r\nbreak;\r\ncase CAIF_CTRLCMD_FLOW_ON_IND:\r\nif (service->phy_flow_on) {\r\nlayr->up->ctrlcmd(layr->up,\r\nCAIF_CTRLCMD_FLOW_ON_IND, phyid);\r\n}\r\nservice->modem_flow_on = true;\r\nbreak;\r\ncase _CAIF_CTRLCMD_PHYIF_DOWN_IND:\r\nlayr->up->ctrlcmd(layr->up,\r\nCAIF_CTRLCMD_REMOTE_SHUTDOWN_IND, phyid);\r\nbreak;\r\ncase CAIF_CTRLCMD_REMOTE_SHUTDOWN_IND:\r\nlayr->up->ctrlcmd(layr->up, ctrl, phyid);\r\nbreak;\r\ndefault:\r\npr_warn("Unexpected ctrl in cfsrvl (%d)\n", ctrl);\r\nlayr->up->ctrlcmd(layr->up, ctrl, phyid);\r\nservice->phy_flow_on = true;\r\nbreak;\r\n}\r\n}\r\nstatic int cfservl_modemcmd(struct cflayer *layr, enum caif_modemcmd ctrl)\r\n{\r\nstruct cfsrvl *service = container_obj(layr);\r\ncaif_assert(layr != NULL);\r\ncaif_assert(layr->dn != NULL);\r\ncaif_assert(layr->dn->transmit != NULL);\r\nif (!service->supports_flowctrl)\r\nreturn 0;\r\nswitch (ctrl) {\r\ncase CAIF_MODEMCMD_FLOW_ON_REQ:\r\n{\r\nstruct cfpkt *pkt;\r\nstruct caif_payload_info *info;\r\nu8 flow_on = SRVL_FLOW_ON;\r\npkt = cfpkt_create(SRVL_CTRL_PKT_SIZE);\r\nif (!pkt)\r\nreturn -ENOMEM;\r\nif (cfpkt_add_head(pkt, &flow_on, 1) < 0) {\r\npr_err("Packet is erroneous!\n");\r\ncfpkt_destroy(pkt);\r\nreturn -EPROTO;\r\n}\r\ninfo = cfpkt_info(pkt);\r\ninfo->channel_id = service->layer.id;\r\ninfo->hdr_len = 1;\r\ninfo->dev_info = &service->dev_info;\r\ncfpkt_set_prio(pkt, TC_PRIO_CONTROL);\r\nreturn layr->dn->transmit(layr->dn, pkt);\r\n}\r\ncase CAIF_MODEMCMD_FLOW_OFF_REQ:\r\n{\r\nstruct cfpkt *pkt;\r\nstruct caif_payload_info *info;\r\nu8 flow_off = SRVL_FLOW_OFF;\r\npkt = cfpkt_create(SRVL_CTRL_PKT_SIZE);\r\nif (!pkt)\r\nreturn -ENOMEM;\r\nif (cfpkt_add_head(pkt, &flow_off, 1) < 0) {\r\npr_err("Packet is erroneous!\n");\r\ncfpkt_destroy(pkt);\r\nreturn -EPROTO;\r\n}\r\ninfo = cfpkt_info(pkt);\r\ninfo->channel_id = service->layer.id;\r\ninfo->hdr_len = 1;\r\ninfo->dev_info = &service->dev_info;\r\ncfpkt_set_prio(pkt, TC_PRIO_CONTROL);\r\nreturn layr->dn->transmit(layr->dn, pkt);\r\n}\r\ndefault:\r\nbreak;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic void cfsrvl_release(struct cflayer *layer)\r\n{\r\nstruct cfsrvl *service = container_of(layer, struct cfsrvl, layer);\r\nkfree(service);\r\n}\r\nvoid cfsrvl_init(struct cfsrvl *service,\r\nu8 channel_id,\r\nstruct dev_info *dev_info,\r\nbool supports_flowctrl\r\n)\r\n{\r\ncaif_assert(offsetof(struct cfsrvl, layer) == 0);\r\nservice->open = false;\r\nservice->modem_flow_on = true;\r\nservice->phy_flow_on = true;\r\nservice->layer.id = channel_id;\r\nservice->layer.ctrlcmd = cfservl_ctrlcmd;\r\nservice->layer.modemcmd = cfservl_modemcmd;\r\nservice->dev_info = *dev_info;\r\nservice->supports_flowctrl = supports_flowctrl;\r\nservice->release = cfsrvl_release;\r\n}\r\nbool cfsrvl_ready(struct cfsrvl *service, int *err)\r\n{\r\nif (!service->open) {\r\n*err = -ENOTCONN;\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nu8 cfsrvl_getphyid(struct cflayer *layer)\r\n{\r\nstruct cfsrvl *servl = container_obj(layer);\r\nreturn servl->dev_info.id;\r\n}\r\nbool cfsrvl_phyid_match(struct cflayer *layer, int phyid)\r\n{\r\nstruct cfsrvl *servl = container_obj(layer);\r\nreturn servl->dev_info.id == phyid;\r\n}\r\nvoid caif_free_client(struct cflayer *adap_layer)\r\n{\r\nstruct cfsrvl *servl;\r\nif (adap_layer == NULL || adap_layer->dn == NULL)\r\nreturn;\r\nservl = container_obj(adap_layer->dn);\r\nservl->release(&servl->layer);\r\n}\r\nvoid caif_client_register_refcnt(struct cflayer *adapt_layer,\r\nvoid (*hold)(struct cflayer *lyr),\r\nvoid (*put)(struct cflayer *lyr))\r\n{\r\nstruct cfsrvl *service;\r\nif (WARN_ON(adapt_layer == NULL || adapt_layer->dn == NULL))\r\nreturn;\r\nservice = container_of(adapt_layer->dn, struct cfsrvl, layer);\r\nservice->hold = hold;\r\nservice->put = put;\r\n}

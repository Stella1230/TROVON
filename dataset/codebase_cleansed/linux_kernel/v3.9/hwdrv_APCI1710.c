static void i_ADDI_AttachPCI1710(struct comedi_device *dev)\r\n{\r\nstruct comedi_subdevice *s;\r\nint ret = 0;\r\nint n_subdevices = 9;\r\nret = comedi_alloc_subdevices(dev, n_subdevices);\r\nif (ret)\r\nreturn;\r\ns = &dev->subdevices[0];\r\ns->type = COMEDI_SUBD_TIMER;\r\ns->subdev_flags = SDF_WRITEABLE | SDF_GROUND | SDF_COMMON;\r\ns->n_chan = 3;\r\ns->maxdata = 0;\r\ns->len_chanlist = 3;\r\ns->range_table = &range_digital;\r\ns->insn_write = i_APCI1710_InsnWriteEnableDisableTimer;\r\ns->insn_read = i_APCI1710_InsnReadAllTimerValue;\r\ns->insn_config = i_APCI1710_InsnConfigInitTimer;\r\ns->insn_bits = i_APCI1710_InsnBitsTimer;\r\ns = &dev->subdevices[1];\r\ns->type = COMEDI_SUBD_DIO;\r\ns->subdev_flags =\r\nSDF_WRITEABLE | SDF_READABLE | SDF_GROUND | SDF_COMMON;\r\ns->n_chan = 7;\r\ns->maxdata = 1;\r\ns->len_chanlist = 7;\r\ns->range_table = &range_digital;\r\ns->insn_config = i_APCI1710_InsnConfigDigitalIO;\r\ns->insn_read = i_APCI1710_InsnReadDigitalIOChlValue;\r\ns->insn_bits = i_APCI1710_InsnBitsDigitalIOPortOnOff;\r\ns->insn_write = i_APCI1710_InsnWriteDigitalIOChlOnOff;\r\ns = &dev->subdevices[2];\r\ns->type = COMEDI_SUBD_CHRONO;\r\ns->subdev_flags = SDF_WRITEABLE | SDF_GROUND | SDF_COMMON;\r\ns->n_chan = 4;\r\ns->maxdata = 0;\r\ns->len_chanlist = 4;\r\ns->range_table = &range_digital;\r\ns->insn_write = i_APCI1710_InsnWriteEnableDisableChrono;\r\ns->insn_read = i_APCI1710_InsnReadChrono;\r\ns->insn_config = i_APCI1710_InsnConfigInitChrono;\r\ns->insn_bits = i_APCI1710_InsnBitsChronoDigitalIO;\r\ns = &dev->subdevices[3];\r\ns->type = COMEDI_SUBD_PWM;\r\ns->subdev_flags =\r\nSDF_WRITEABLE | SDF_READABLE | SDF_GROUND | SDF_COMMON;\r\ns->n_chan = 3;\r\ns->maxdata = 1;\r\ns->len_chanlist = 3;\r\ns->range_table = &range_digital;\r\ns->io_bits = 0;\r\ns->insn_config = i_APCI1710_InsnConfigPWM;\r\ns->insn_read = i_APCI1710_InsnReadGetPWMStatus;\r\ns->insn_write = i_APCI1710_InsnWritePWM;\r\ns->insn_bits = i_APCI1710_InsnBitsReadPWMInterrupt;\r\ns = &dev->subdevices[4];\r\ns->type = COMEDI_SUBD_TTLIO;\r\ns->subdev_flags =\r\nSDF_WRITEABLE | SDF_READABLE | SDF_GROUND | SDF_COMMON;\r\ns->n_chan = 8;\r\ns->maxdata = 1;\r\ns->len_chanlist = 8;\r\ns->range_table = &range_apci1710_ttl;\r\ns->insn_config = i_APCI1710_InsnConfigInitTTLIO;\r\ns->insn_bits = i_APCI1710_InsnBitsReadTTLIO;\r\ns->insn_write = i_APCI1710_InsnWriteSetTTLIOChlOnOff;\r\ns->insn_read = i_APCI1710_InsnReadTTLIOAllPortValue;\r\ns = &dev->subdevices[5];\r\ns->type = COMEDI_SUBD_TOR;\r\ns->subdev_flags =\r\nSDF_WRITEABLE | SDF_READABLE | SDF_GROUND | SDF_COMMON;\r\ns->n_chan = 8;\r\ns->maxdata = 1;\r\ns->len_chanlist = 8;\r\ns->range_table = &range_digital;\r\ns->io_bits = 0;\r\ns->insn_config = i_APCI1710_InsnConfigInitTorCounter;\r\ns->insn_read = i_APCI1710_InsnReadGetTorCounterInitialisation;\r\ns->insn_write = i_APCI1710_InsnWriteEnableDisableTorCounter;\r\ns->insn_bits = i_APCI1710_InsnBitsGetTorCounterProgressStatusAndValue;\r\ns = &dev->subdevices[6];\r\ns->type = COMEDI_SUBD_SSI;\r\ns->subdev_flags =\r\nSDF_WRITEABLE | SDF_READABLE | SDF_GROUND | SDF_COMMON;\r\ns->n_chan = 4;\r\ns->maxdata = 1;\r\ns->len_chanlist = 4;\r\ns->range_table = &range_apci1710_ssi;\r\ns->insn_config = i_APCI1710_InsnConfigInitSSI;\r\ns->insn_read = i_APCI1710_InsnReadSSIValue;\r\ns->insn_bits = i_APCI1710_InsnBitsSSIDigitalIO;\r\ns = &dev->subdevices[7];\r\ns->type = COMEDI_SUBD_PULSEENCODER;\r\ns->subdev_flags =\r\nSDF_WRITEABLE | SDF_READABLE | SDF_GROUND | SDF_COMMON;\r\ns->n_chan = 4;\r\ns->maxdata = 1;\r\ns->len_chanlist = 4;\r\ns->range_table = &range_digital;\r\ns->insn_config = i_APCI1710_InsnConfigInitPulseEncoder;\r\ns->insn_write = i_APCI1710_InsnWriteEnableDisablePulseEncoder;\r\ns->insn_bits = i_APCI1710_InsnBitsReadWritePulseEncoder;\r\ns->insn_read = i_APCI1710_InsnReadInterruptPulseEncoder;\r\ns = &dev->subdevices[8];\r\ns->type = COMEDI_SUBD_INCREMENTALCOUNTER;\r\ns->subdev_flags =\r\nSDF_WRITEABLE | SDF_READABLE | SDF_GROUND | SDF_COMMON;\r\ns->n_chan = 500;\r\ns->maxdata = 1;\r\ns->len_chanlist = 500;\r\ns->range_table = &range_apci1710_inccpt;\r\ns->insn_config = i_APCI1710_InsnConfigINCCPT;\r\ns->insn_write = i_APCI1710_InsnWriteINCCPT;\r\ns->insn_read = i_APCI1710_InsnReadINCCPT;\r\ns->insn_bits = i_APCI1710_InsnBitsINCCPT;\r\n}\r\nstatic int i_APCI1710_Reset(struct comedi_device *dev)\r\n{\r\nstruct addi_private *devpriv = dev->private;\r\nint ret;\r\nunsigned int dw_Dummy;\r\nret = inl(devpriv->s_BoardInfos.ui_Address + 60);\r\ndevpriv->s_BoardInfos.dw_MolduleConfiguration[0] = ret;\r\nret = inl(devpriv->s_BoardInfos.ui_Address + 124);\r\ndevpriv->s_BoardInfos.dw_MolduleConfiguration[1] = ret;\r\nret = inl(devpriv->s_BoardInfos.ui_Address + 188);\r\ndevpriv->s_BoardInfos.dw_MolduleConfiguration[2] = ret;\r\nret = inl(devpriv->s_BoardInfos.ui_Address + 252);\r\ndevpriv->s_BoardInfos.dw_MolduleConfiguration[3] = ret;\r\noutl(0x83838383, devpriv->s_BoardInfos.ui_Address + 0x60);\r\ndevpriv->s_BoardInfos.b_BoardVersion = 1;\r\ndw_Dummy = inl(devpriv->s_BoardInfos.ui_Address + 0x38);\r\noutl(dw_Dummy | 0x2000, devpriv->s_BoardInfos.ui_Address + 0x38);\r\nreturn 0;\r\n}\r\nstatic void v_APCI1710_Interrupt(int irq, void *d)\r\n{\r\nstruct comedi_device *dev = d;\r\nstruct addi_private *devpriv = dev->private;\r\nunsigned char b_ModuleCpt = 0;\r\nunsigned char b_InterruptFlag = 0;\r\nunsigned char b_PWMCpt = 0;\r\nunsigned char b_TorCounterCpt = 0;\r\nunsigned char b_PulseIncoderCpt = 0;\r\nunsigned int ui_16BitValue;\r\nunsigned int ul_InterruptLatchReg = 0;\r\nunsigned int ul_LatchRegisterValue = 0;\r\nunsigned int ul_82X54InterruptStatus;\r\nunsigned int ul_StatusRegister;\r\nunion str_ModuleInfo *ps_ModuleInfo;\r\nprintk("APCI1710 Interrupt\n");\r\nfor (b_ModuleCpt = 0; b_ModuleCpt < 4; b_ModuleCpt++, ps_ModuleInfo++) {\r\nps_ModuleInfo = &devpriv->s_ModuleInfo[b_ModuleCpt];\r\nif ((devpriv->s_BoardInfos.\r\ndw_MolduleConfiguration[b_ModuleCpt] &\r\n0xFFFF0000UL) == APCI1710_82X54_TIMER) {\r\nul_82X54InterruptStatus = inl(devpriv->s_BoardInfos.\r\nui_Address + 12 + (64 * b_ModuleCpt));\r\nif ((ul_82X54InterruptStatus & ps_ModuleInfo->\r\ns_82X54ModuleInfo.\r\nb_InterruptMask) != 0) {\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters[devpriv->\r\ns_InterruptParameters.\r\nui_Write].\r\nul_OldInterruptMask =\r\n(ul_82X54InterruptStatus &\r\nps_ModuleInfo->s_82X54ModuleInfo.\r\nb_InterruptMask) << 4;\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters[devpriv->\r\ns_InterruptParameters.\r\nui_Write].\r\nb_OldModuleMask = 1 << b_ModuleCpt;\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters[devpriv->\r\ns_InterruptParameters.\r\nui_Write].ul_OldCounterLatchValue = 0;\r\ndevpriv->\r\ns_InterruptParameters.\r\nul_InterruptOccur++;\r\ndevpriv->\r\ns_InterruptParameters.\r\nui_Write = (devpriv->\r\ns_InterruptParameters.\r\nui_Write + 1) % APCI1710_SAVE_INTERRUPT;\r\nb_InterruptFlag = 1;\r\nsend_sig(SIGIO, devpriv->tsk_Current, 0);\r\n}\r\n}\r\nif ((devpriv->s_BoardInfos.\r\ndw_MolduleConfiguration[b_ModuleCpt] &\r\n0xFFFF0000UL) == APCI1710_INCREMENTAL_COUNTER) {\r\nul_InterruptLatchReg = inl(devpriv->s_BoardInfos.\r\nui_Address + (64 * b_ModuleCpt));\r\nif ((ul_InterruptLatchReg & 0x22) && (ps_ModuleInfo->\r\ns_SiemensCounterInfo.\r\ns_ModeRegister.\r\ns_ByteModeRegister.\r\nb_ModeRegister2 & 0x80)) {\r\nif (ul_InterruptLatchReg & 2) {\r\nul_LatchRegisterValue =\r\ninl(devpriv->s_BoardInfos.\r\nui_Address + 4 +\r\n(64 * b_ModuleCpt));\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters\r\n[devpriv->s_InterruptParameters.\r\nui_Write].ul_OldInterruptMask =\r\n1UL;\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters\r\n[devpriv->s_InterruptParameters.\r\nui_Write].b_OldModuleMask =\r\n1 << b_ModuleCpt;\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters\r\n[devpriv->s_InterruptParameters.\r\nui_Write].\r\nul_OldCounterLatchValue =\r\nul_LatchRegisterValue;\r\ndevpriv->\r\ns_InterruptParameters.\r\nul_InterruptOccur++;\r\ndevpriv->\r\ns_InterruptParameters.\r\nui_Write = (devpriv->\r\ns_InterruptParameters.\r\nui_Write +\r\n1) % APCI1710_SAVE_INTERRUPT;\r\nb_InterruptFlag = 1;\r\nsend_sig(SIGIO, devpriv->tsk_Current,\r\n0);\r\n}\r\nif (ul_InterruptLatchReg & 0x20) {\r\nul_LatchRegisterValue =\r\ninl(devpriv->s_BoardInfos.\r\nui_Address + 8 +\r\n(64 * b_ModuleCpt));\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters\r\n[devpriv->s_InterruptParameters.\r\nui_Write].ul_OldInterruptMask =\r\n2UL;\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters\r\n[devpriv->s_InterruptParameters.\r\nui_Write].b_OldModuleMask =\r\n1 << b_ModuleCpt;\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters\r\n[devpriv->s_InterruptParameters.\r\nui_Write].\r\nul_OldCounterLatchValue =\r\nul_LatchRegisterValue;\r\ndevpriv->\r\ns_InterruptParameters.\r\nul_InterruptOccur++;\r\ndevpriv->\r\ns_InterruptParameters.\r\nui_Write = (devpriv->\r\ns_InterruptParameters.\r\nui_Write +\r\n1) % APCI1710_SAVE_INTERRUPT;\r\nb_InterruptFlag = 1;\r\nsend_sig(SIGIO, devpriv->tsk_Current,\r\n0);\r\n}\r\n}\r\nul_InterruptLatchReg = inl(devpriv->s_BoardInfos.\r\nui_Address + 24 + (64 * b_ModuleCpt));\r\nif (ul_InterruptLatchReg & 0x8) {\r\nps_ModuleInfo->\r\ns_SiemensCounterInfo.\r\ns_InitFlag.b_IndexInterruptOccur = 1;\r\nif (ps_ModuleInfo->\r\ns_SiemensCounterInfo.\r\ns_ModeRegister.\r\ns_ByteModeRegister.\r\nb_ModeRegister2 &\r\nAPCI1710_INDEX_AUTO_MODE) {\r\noutl(ps_ModuleInfo->\r\ns_SiemensCounterInfo.\r\ns_ModeRegister.\r\ndw_ModeRegister1_2_3_4,\r\ndevpriv->s_BoardInfos.\r\nui_Address + 20 +\r\n(64 * b_ModuleCpt));\r\n}\r\nif ((ps_ModuleInfo->\r\ns_SiemensCounterInfo.\r\ns_ModeRegister.\r\ns_ByteModeRegister.\r\nb_ModeRegister3 &\r\nAPCI1710_ENABLE_INDEX_INT) ==\r\nAPCI1710_ENABLE_INDEX_INT) {\r\ndevpriv->s_InterruptParameters.\r\ns_FIFOInterruptParameters\r\n[devpriv->s_InterruptParameters.\r\nui_Write].ul_OldInterruptMask =\r\n4UL;\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters\r\n[devpriv->s_InterruptParameters.\r\nui_Write].b_OldModuleMask =\r\n1 << b_ModuleCpt;\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters\r\n[devpriv->s_InterruptParameters.\r\nui_Write].\r\nul_OldCounterLatchValue =\r\nul_LatchRegisterValue;\r\ndevpriv->\r\ns_InterruptParameters.\r\nul_InterruptOccur++;\r\ndevpriv->\r\ns_InterruptParameters.\r\nui_Write = (devpriv->\r\ns_InterruptParameters.\r\nui_Write +\r\n1) % APCI1710_SAVE_INTERRUPT;\r\nb_InterruptFlag = 1;\r\nsend_sig(SIGIO, devpriv->tsk_Current,\r\n0);\r\n}\r\n}\r\nif (ul_InterruptLatchReg & 0x10) {\r\nif ((ps_ModuleInfo->\r\ns_SiemensCounterInfo.\r\ns_ModeRegister.\r\ns_ByteModeRegister.\r\nb_ModeRegister3 &\r\nAPCI1710_ENABLE_COMPARE_INT) ==\r\nAPCI1710_ENABLE_COMPARE_INT) {\r\ndevpriv->s_InterruptParameters.\r\ns_FIFOInterruptParameters\r\n[devpriv->s_InterruptParameters.\r\nui_Write].ul_OldInterruptMask =\r\n8UL;\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters\r\n[devpriv->s_InterruptParameters.\r\nui_Write].b_OldModuleMask =\r\n1 << b_ModuleCpt;\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters\r\n[devpriv->s_InterruptParameters.\r\nui_Write].\r\nul_OldCounterLatchValue =\r\nul_LatchRegisterValue;\r\ndevpriv->\r\ns_InterruptParameters.\r\nul_InterruptOccur++;\r\ndevpriv->\r\ns_InterruptParameters.\r\nui_Write = (devpriv->\r\ns_InterruptParameters.\r\nui_Write +\r\n1) % APCI1710_SAVE_INTERRUPT;\r\nb_InterruptFlag = 1;\r\nsend_sig(SIGIO, devpriv->tsk_Current,\r\n0);\r\n}\r\n}\r\nif (ul_InterruptLatchReg & 0x20) {\r\nul_StatusRegister = inl(devpriv->s_BoardInfos.\r\nui_Address + 32 + (64 * b_ModuleCpt));\r\nul_LatchRegisterValue =\r\ninl(devpriv->s_BoardInfos.ui_Address +\r\n28 + (64 * b_ModuleCpt));\r\nswitch ((ul_StatusRegister >> 1) & 3) {\r\ncase 0:\r\nif ((devpriv->s_ModuleInfo[b_ModuleCpt].\r\ns_SiemensCounterInfo.\r\ns_ModeRegister.\r\ns_ByteModeRegister.\r\nb_ModeRegister1 &\r\nAPCI1710_16BIT_COUNTER)\r\n== APCI1710_16BIT_COUNTER) {\r\nif ((ul_LatchRegisterValue &\r\n0xFFFFU) != 0) {\r\nui_16BitValue =\r\n(unsigned int)\r\nul_LatchRegisterValue\r\n& 0xFFFFU;\r\nul_LatchRegisterValue =\r\n(ul_LatchRegisterValue\r\n& 0xFFFF0000UL)\r\n| (0xFFFFU -\r\nui_16BitValue);\r\n}\r\nif ((ul_LatchRegisterValue &\r\n0xFFFF0000UL) !=\r\n0) {\r\nui_16BitValue =\r\n(unsigned int) (\r\n(ul_LatchRegisterValue\r\n>> 16) &\r\n0xFFFFU);\r\nul_LatchRegisterValue =\r\n(ul_LatchRegisterValue\r\n& 0xFFFFUL) |\r\n((0xFFFFU -\r\nui_16BitValue)\r\n<< 16);\r\n}\r\n} else {\r\nif (ul_LatchRegisterValue != 0) {\r\nul_LatchRegisterValue =\r\n0xFFFFFFFFUL -\r\nul_LatchRegisterValue;\r\n}\r\n}\r\nbreak;\r\ncase 1:\r\nif ((ul_LatchRegisterValue &\r\n0xFFFF0000UL) != 0) {\r\nui_16BitValue =\r\n(unsigned int) (\r\n(ul_LatchRegisterValue\r\n>> 16) &\r\n0xFFFFU);\r\nul_LatchRegisterValue =\r\n(ul_LatchRegisterValue &\r\n0xFFFFUL) | ((0xFFFFU -\r\nui_16BitValue)\r\n<< 16);\r\n}\r\nbreak;\r\ncase 2:\r\nif ((ul_LatchRegisterValue & 0xFFFFU) !=\r\n0) {\r\nui_16BitValue =\r\n(unsigned int)\r\nul_LatchRegisterValue &\r\n0xFFFFU;\r\nul_LatchRegisterValue =\r\n(ul_LatchRegisterValue &\r\n0xFFFF0000UL) | (0xFFFFU\r\n- ui_16BitValue);\r\n}\r\nbreak;\r\n}\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters[devpriv->\r\ns_InterruptParameters.\r\nui_Write].\r\nul_OldInterruptMask = 0x10000UL;\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters[devpriv->\r\ns_InterruptParameters.\r\nui_Write].\r\nb_OldModuleMask = 1 << b_ModuleCpt;\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters[devpriv->\r\ns_InterruptParameters.\r\nui_Write].\r\nul_OldCounterLatchValue =\r\nul_LatchRegisterValue;\r\ndevpriv->\r\ns_InterruptParameters.\r\nul_InterruptOccur++;\r\ndevpriv->\r\ns_InterruptParameters.\r\nui_Write = (devpriv->\r\ns_InterruptParameters.\r\nui_Write + 1) % APCI1710_SAVE_INTERRUPT;\r\nb_InterruptFlag = 1;\r\nsend_sig(SIGIO, devpriv->tsk_Current, 0);\r\n}\r\n}\r\nif ((devpriv->s_BoardInfos.\r\ndw_MolduleConfiguration[b_ModuleCpt] &\r\n0xFFFF0000UL) == APCI1710_CDA) {\r\nif ((devpriv->s_ModuleInfo[b_ModuleCpt].\r\ns_CDAModuleInfo.\r\nb_CDAEnable == APCI1710_ENABLE)\r\n&& (devpriv->s_ModuleInfo[b_ModuleCpt].\r\ns_CDAModuleInfo.b_FctSelection == 0)) {\r\nul_StatusRegister = inl(devpriv->s_BoardInfos.\r\nui_Address + 16 + (64 * b_ModuleCpt));\r\nif (ul_StatusRegister & 1) {\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters\r\n[devpriv->s_InterruptParameters.\r\nui_Write].ul_OldInterruptMask =\r\n0x80000UL;\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters\r\n[devpriv->s_InterruptParameters.\r\nui_Write].b_OldModuleMask =\r\n1 << b_ModuleCpt;\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters\r\n[devpriv->s_InterruptParameters.\r\nui_Write].\r\nul_OldCounterLatchValue = 0;\r\ndevpriv->\r\ns_InterruptParameters.\r\nul_InterruptOccur++;\r\ndevpriv->\r\ns_InterruptParameters.\r\nui_Write = (devpriv->\r\ns_InterruptParameters.\r\nui_Write +\r\n1) % APCI1710_SAVE_INTERRUPT;\r\nb_InterruptFlag = 1;\r\nsend_sig(SIGIO, devpriv->tsk_Current,\r\n0);\r\n}\r\n}\r\n}\r\nif ((devpriv->s_BoardInfos.\r\ndw_MolduleConfiguration[b_ModuleCpt] &\r\n0xFFFF0000UL) == APCI1710_PWM) {\r\nfor (b_PWMCpt = 0; b_PWMCpt < 2; b_PWMCpt++) {\r\nif (devpriv->\r\ns_ModuleInfo[b_ModuleCpt].\r\ns_PWMModuleInfo.\r\ns_PWMInfo[b_PWMCpt].\r\nb_InterruptEnable == APCI1710_ENABLE) {\r\nul_StatusRegister =\r\ninl(devpriv->s_BoardInfos.\r\nui_Address + 16 +\r\n(20 * b_PWMCpt) +\r\n(64 * b_ModuleCpt));\r\nif (ul_StatusRegister & 0x1) {\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters\r\n[devpriv->\r\ns_InterruptParameters.\r\nui_Write].\r\nul_OldInterruptMask =\r\n0x4000UL << b_PWMCpt;\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters\r\n[devpriv->\r\ns_InterruptParameters.\r\nui_Write].\r\nb_OldModuleMask =\r\n1 << b_ModuleCpt;\r\ndevpriv->\r\ns_InterruptParameters.\r\nul_InterruptOccur++;\r\ndevpriv->\r\ns_InterruptParameters.\r\nui_Write = (devpriv->\r\ns_InterruptParameters.\r\nui_Write +\r\n1) %\r\nAPCI1710_SAVE_INTERRUPT;\r\nb_InterruptFlag = 1;\r\nsend_sig(SIGIO,\r\ndevpriv->tsk_Current,\r\n0);\r\n}\r\n}\r\n}\r\n}\r\nif ((devpriv->s_BoardInfos.\r\ndw_MolduleConfiguration[b_ModuleCpt] &\r\n0xFFFF0000UL) == APCI1710_TOR_COUNTER) {\r\nfor (b_TorCounterCpt = 0; b_TorCounterCpt < 2;\r\nb_TorCounterCpt++) {\r\nif (devpriv->\r\ns_ModuleInfo[b_ModuleCpt].\r\ns_TorCounterModuleInfo.\r\ns_TorCounterInfo[b_TorCounterCpt].\r\nb_InterruptEnable == APCI1710_ENABLE) {\r\nul_StatusRegister =\r\ninl(devpriv->s_BoardInfos.\r\nui_Address + 12 +\r\n(16 * b_TorCounterCpt) +\r\n(64 * b_ModuleCpt));\r\nif (ul_StatusRegister & 0x1) {\r\nul_LatchRegisterValue =\r\ninl(devpriv->\r\ns_BoardInfos.\r\nui_Address + 0 +\r\n(16 * b_TorCounterCpt) +\r\n(64 * b_ModuleCpt));\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters\r\n[devpriv->\r\ns_InterruptParameters.\r\nui_Write].\r\nul_OldInterruptMask =\r\n0x1000UL <<\r\nb_TorCounterCpt;\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters\r\n[devpriv->\r\ns_InterruptParameters.\r\nui_Write].\r\nb_OldModuleMask =\r\n1 << b_ModuleCpt;\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters\r\n[devpriv->\r\ns_InterruptParameters.\r\nui_Write].\r\nul_OldCounterLatchValue\r\n= ul_LatchRegisterValue;\r\ndevpriv->\r\ns_InterruptParameters.\r\nul_InterruptOccur++;\r\ndevpriv->\r\ns_InterruptParameters.\r\nui_Write = (devpriv->\r\ns_InterruptParameters.\r\nui_Write +\r\n1) %\r\nAPCI1710_SAVE_INTERRUPT;\r\nb_InterruptFlag = 1;\r\nsend_sig(SIGIO,\r\ndevpriv->tsk_Current,\r\n0);\r\n}\r\n}\r\n}\r\n}\r\nif ((devpriv->s_BoardInfos.\r\ndw_MolduleConfiguration[b_ModuleCpt] &\r\n0xFFFF0000UL) == APCI1710_CHRONOMETER) {\r\nul_InterruptLatchReg = inl(devpriv->s_BoardInfos.\r\nui_Address + 12 + (64 * b_ModuleCpt));\r\nif ((ul_InterruptLatchReg & 0x8) == 0x8) {\r\noutl(0, devpriv->s_BoardInfos.\r\nui_Address + 32 + (64 * b_ModuleCpt));\r\nif (ps_ModuleInfo->\r\ns_ChronoModuleInfo.\r\nb_CycleMode == APCI1710_ENABLE) {\r\noutl(0, devpriv->s_BoardInfos.\r\nui_Address + 36 +\r\n(64 * b_ModuleCpt));\r\n}\r\nul_LatchRegisterValue =\r\ninl(devpriv->s_BoardInfos.ui_Address +\r\n4 + (64 * b_ModuleCpt));\r\nif (ps_ModuleInfo->\r\ns_ChronoModuleInfo.b_InterruptMask) {\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters\r\n[devpriv->s_InterruptParameters.\r\nui_Write].ul_OldInterruptMask =\r\n0x80;\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters\r\n[devpriv->s_InterruptParameters.\r\nui_Write].b_OldModuleMask =\r\n1 << b_ModuleCpt;\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters\r\n[devpriv->s_InterruptParameters.\r\nui_Write].\r\nul_OldCounterLatchValue =\r\nul_LatchRegisterValue;\r\ndevpriv->\r\ns_InterruptParameters.\r\nul_InterruptOccur++;\r\ndevpriv->\r\ns_InterruptParameters.\r\nui_Write = (devpriv->\r\ns_InterruptParameters.\r\nui_Write +\r\n1) % APCI1710_SAVE_INTERRUPT;\r\nb_InterruptFlag = 1;\r\nsend_sig(SIGIO, devpriv->tsk_Current,\r\n0);\r\n}\r\n}\r\n}\r\nif ((devpriv->s_BoardInfos.\r\ndw_MolduleConfiguration[b_ModuleCpt] &\r\n0xFFFF0000UL) == APCI1710_PULSE_ENCODER) {\r\nul_StatusRegister = inl(devpriv->s_BoardInfos.\r\nui_Address + 20 + (64 * b_ModuleCpt));\r\nif (ul_StatusRegister & 0xF) {\r\nfor (b_PulseIncoderCpt = 0;\r\nb_PulseIncoderCpt < 4;\r\nb_PulseIncoderCpt++) {\r\nif ((ps_ModuleInfo->\r\ns_PulseEncoderModuleInfo.\r\ns_PulseEncoderInfo\r\n[b_PulseIncoderCpt].\r\nb_PulseEncoderInit == 1)\r\n&& (((ps_ModuleInfo->s_PulseEncoderModuleInfo.dw_SetRegister >> b_PulseIncoderCpt) & 1) == 1) && (((ul_StatusRegister >> (b_PulseIncoderCpt)) & 1) == 1)) {\r\ndevpriv->s_InterruptParameters.\r\ns_FIFOInterruptParameters\r\n[devpriv->\r\ns_InterruptParameters.\r\nui_Write].\r\nul_OldInterruptMask =\r\n0x100UL <<\r\nb_PulseIncoderCpt;\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters\r\n[devpriv->\r\ns_InterruptParameters.\r\nui_Write].\r\nb_OldModuleMask =\r\n1 << b_ModuleCpt;\r\ndevpriv->\r\ns_InterruptParameters.\r\ns_FIFOInterruptParameters\r\n[devpriv->\r\ns_InterruptParameters.\r\nui_Write].\r\nul_OldCounterLatchValue\r\n= ul_LatchRegisterValue;\r\ndevpriv->\r\ns_InterruptParameters.\r\nul_InterruptOccur++;\r\ndevpriv->\r\ns_InterruptParameters.\r\nui_Write = (devpriv->\r\ns_InterruptParameters.\r\nui_Write +\r\n1) %\r\nAPCI1710_SAVE_INTERRUPT;\r\nb_InterruptFlag = 1;\r\nsend_sig(SIGIO,\r\ndevpriv->tsk_Current,\r\n0);\r\n}\r\n}\r\n}\r\n}\r\n}\r\nreturn;\r\n}

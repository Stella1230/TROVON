static int tps65217_vsel_to_uv1(unsigned int vsel)\r\n{\r\nint uV = 0;\r\nif (vsel > 63)\r\nreturn -EINVAL;\r\nif (vsel <= 24)\r\nuV = vsel * 25000 + 900000;\r\nelse if (vsel <= 52)\r\nuV = (vsel - 24) * 50000 + 1500000;\r\nelse if (vsel < 56)\r\nuV = (vsel - 52) * 100000 + 2900000;\r\nelse\r\nuV = 3300000;\r\nreturn uV;\r\n}\r\nstatic int tps65217_uv_to_vsel1(int uV, unsigned int *vsel)\r\n{\r\nif (uV < 0 || uV > 3300000)\r\nreturn -EINVAL;\r\nif (uV <= 1500000)\r\n*vsel = DIV_ROUND_UP(uV - 900000, 25000);\r\nelse if (uV <= 2900000)\r\n*vsel = 24 + DIV_ROUND_UP(uV - 1500000, 50000);\r\nelse if (uV < 3300000)\r\n*vsel = 52 + DIV_ROUND_UP(uV - 2900000, 100000);\r\nelse\r\n*vsel = 56;\r\nreturn 0;\r\n}\r\nstatic int tps65217_vsel_to_uv2(unsigned int vsel)\r\n{\r\nint uV = 0;\r\nif (vsel > 31)\r\nreturn -EINVAL;\r\nif (vsel <= 8)\r\nuV = vsel * 50000 + 1500000;\r\nelse if (vsel <= 13)\r\nuV = (vsel - 8) * 100000 + 1900000;\r\nelse\r\nuV = (vsel - 13) * 50000 + 2400000;\r\nreturn uV;\r\n}\r\nstatic int tps65217_uv_to_vsel2(int uV, unsigned int *vsel)\r\n{\r\nif (uV < 0 || uV > 3300000)\r\nreturn -EINVAL;\r\nif (uV <= 1900000)\r\n*vsel = DIV_ROUND_UP(uV - 1500000, 50000);\r\nelse if (uV <= 2400000)\r\n*vsel = 8 + DIV_ROUND_UP(uV - 1900000, 100000);\r\nelse\r\n*vsel = 13 + DIV_ROUND_UP(uV - 2400000, 50000);\r\nreturn 0;\r\n}\r\nstatic int tps65217_pmic_enable(struct regulator_dev *dev)\r\n{\r\nstruct tps65217 *tps = rdev_get_drvdata(dev);\r\nunsigned int rid = rdev_get_id(dev);\r\nif (rid < TPS65217_DCDC_1 || rid > TPS65217_LDO_4)\r\nreturn -EINVAL;\r\nreturn tps65217_set_bits(tps, TPS65217_REG_ENABLE,\r\ndev->desc->enable_mask, dev->desc->enable_mask,\r\nTPS65217_PROTECT_L1);\r\n}\r\nstatic int tps65217_pmic_disable(struct regulator_dev *dev)\r\n{\r\nstruct tps65217 *tps = rdev_get_drvdata(dev);\r\nunsigned int rid = rdev_get_id(dev);\r\nif (rid < TPS65217_DCDC_1 || rid > TPS65217_LDO_4)\r\nreturn -EINVAL;\r\nreturn tps65217_clear_bits(tps, TPS65217_REG_ENABLE,\r\ndev->desc->enable_mask, TPS65217_PROTECT_L1);\r\n}\r\nstatic int tps65217_pmic_set_voltage_sel(struct regulator_dev *dev,\r\nunsigned selector)\r\n{\r\nint ret;\r\nstruct tps65217 *tps = rdev_get_drvdata(dev);\r\nunsigned int rid = rdev_get_id(dev);\r\nret = tps65217_set_bits(tps, dev->desc->vsel_reg, dev->desc->vsel_mask,\r\nselector, TPS65217_PROTECT_L2);\r\nswitch (rid) {\r\ncase TPS65217_DCDC_1 ... TPS65217_DCDC_3:\r\nret = tps65217_set_bits(tps, TPS65217_REG_DEFSLEW,\r\nTPS65217_DEFSLEW_GO, TPS65217_DEFSLEW_GO,\r\nTPS65217_PROTECT_L2);\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int tps65217_pmic_map_voltage(struct regulator_dev *dev,\r\nint min_uV, int max_uV)\r\n{\r\nstruct tps65217 *tps = rdev_get_drvdata(dev);\r\nunsigned int sel, rid = rdev_get_id(dev);\r\nint ret;\r\nif (rid == TPS65217_LDO_1)\r\nreturn -EINVAL;\r\nif (rid < TPS65217_DCDC_1 || rid > TPS65217_LDO_4)\r\nreturn -EINVAL;\r\nif (min_uV < tps->info[rid]->min_uV)\r\nmin_uV = tps->info[rid]->min_uV;\r\nif (max_uV < tps->info[rid]->min_uV || min_uV > tps->info[rid]->max_uV)\r\nreturn -EINVAL;\r\nret = tps->info[rid]->uv_to_vsel(min_uV, &sel);\r\nif (ret)\r\nreturn ret;\r\nreturn sel;\r\n}\r\nstatic int tps65217_pmic_list_voltage(struct regulator_dev *dev,\r\nunsigned selector)\r\n{\r\nstruct tps65217 *tps = rdev_get_drvdata(dev);\r\nunsigned int rid = rdev_get_id(dev);\r\nif (rid < TPS65217_DCDC_1 || rid > TPS65217_LDO_4)\r\nreturn -EINVAL;\r\nif (selector >= dev->desc->n_voltages)\r\nreturn -EINVAL;\r\nreturn tps->info[rid]->vsel_to_uv(selector);\r\n}\r\nstatic struct tps65217_board *tps65217_parse_dt(struct platform_device *pdev)\r\n{\r\nstruct tps65217 *tps = dev_get_drvdata(pdev->dev.parent);\r\nstruct device_node *node = tps->dev->of_node;\r\nstruct tps65217_board *pdata;\r\nstruct device_node *regs;\r\nint i, count;\r\nregs = of_find_node_by_name(node, "regulators");\r\nif (!regs)\r\nreturn NULL;\r\ncount = of_regulator_match(&pdev->dev, regs, reg_matches,\r\nTPS65217_NUM_REGULATOR);\r\nof_node_put(regs);\r\nif ((count < 0) || (count > TPS65217_NUM_REGULATOR))\r\nreturn NULL;\r\npdata = devm_kzalloc(&pdev->dev, sizeof(*pdata), GFP_KERNEL);\r\nif (!pdata)\r\nreturn NULL;\r\nfor (i = 0; i < count; i++) {\r\nif (!reg_matches[i].init_data || !reg_matches[i].of_node)\r\ncontinue;\r\npdata->tps65217_init_data[i] = reg_matches[i].init_data;\r\npdata->of_node[i] = reg_matches[i].of_node;\r\n}\r\nreturn pdata;\r\n}\r\nstatic struct tps65217_board *tps65217_parse_dt(struct platform_device *pdev)\r\n{\r\nreturn NULL;\r\n}\r\nstatic int tps65217_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct tps65217 *tps = dev_get_drvdata(pdev->dev.parent);\r\nstruct tps65217_board *pdata = dev_get_platdata(tps->dev);\r\nstruct regulator_init_data *reg_data;\r\nstruct regulator_dev *rdev;\r\nstruct regulator_config config = { };\r\nint i, ret;\r\nif (tps->dev->of_node)\r\npdata = tps65217_parse_dt(pdev);\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "Platform data not found\n");\r\nreturn -EINVAL;\r\n}\r\nif (tps65217_chip_id(tps) != TPS65217) {\r\ndev_err(&pdev->dev, "Invalid tps chip version\n");\r\nreturn -ENODEV;\r\n}\r\nplatform_set_drvdata(pdev, tps);\r\nfor (i = 0; i < TPS65217_NUM_REGULATOR; i++) {\r\nreg_data = pdata->tps65217_init_data[i];\r\nif (!reg_data)\r\ncontinue;\r\ntps->info[i] = &tps65217_pmic_regs[i];\r\nconfig.dev = tps->dev;\r\nconfig.init_data = reg_data;\r\nconfig.driver_data = tps;\r\nconfig.regmap = tps->regmap;\r\nif (tps->dev->of_node)\r\nconfig.of_node = pdata->of_node[i];\r\nrdev = regulator_register(&regulators[i], &config);\r\nif (IS_ERR(rdev)) {\r\ndev_err(tps->dev, "failed to register %s regulator\n",\r\npdev->name);\r\nret = PTR_ERR(rdev);\r\ngoto err_unregister_regulator;\r\n}\r\ntps->rdev[i] = rdev;\r\n}\r\nreturn 0;\r\nerr_unregister_regulator:\r\nwhile (--i >= 0)\r\nregulator_unregister(tps->rdev[i]);\r\nreturn ret;\r\n}\r\nstatic int tps65217_regulator_remove(struct platform_device *pdev)\r\n{\r\nstruct tps65217 *tps = platform_get_drvdata(pdev);\r\nunsigned int i;\r\nfor (i = 0; i < TPS65217_NUM_REGULATOR; i++)\r\nregulator_unregister(tps->rdev[i]);\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn 0;\r\n}\r\nstatic int __init tps65217_regulator_init(void)\r\n{\r\nreturn platform_driver_register(&tps65217_regulator_driver);\r\n}\r\nstatic void __exit tps65217_regulator_exit(void)\r\n{\r\nplatform_driver_unregister(&tps65217_regulator_driver);\r\n}

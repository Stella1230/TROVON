static int get_trip_level(struct thermal_zone_device *tz)\r\n{\r\nint count = 0;\r\nunsigned long trip_temp;\r\nif (tz->trips == 0 || !tz->ops->get_trip_temp)\r\nreturn 0;\r\nfor (count = 0; count < tz->trips; count++) {\r\ntz->ops->get_trip_temp(tz, count, &trip_temp);\r\nif (tz->temperature < trip_temp)\r\nbreak;\r\n}\r\nreturn count;\r\n}\r\nstatic long get_target_state(struct thermal_zone_device *tz,\r\nstruct thermal_cooling_device *cdev, int weight, int level)\r\n{\r\nunsigned long max_state;\r\ncdev->ops->get_max_state(cdev, &max_state);\r\nreturn (long)(weight * level * max_state) / (100 * tz->trips);\r\n}\r\nstatic int fair_share_throttle(struct thermal_zone_device *tz, int trip)\r\n{\r\nconst struct thermal_zone_params *tzp;\r\nstruct thermal_cooling_device *cdev;\r\nstruct thermal_instance *instance;\r\nint i;\r\nint cur_trip_level = get_trip_level(tz);\r\nif (!tz->tzp || !tz->tzp->tbp)\r\nreturn -EINVAL;\r\ntzp = tz->tzp;\r\nfor (i = 0; i < tzp->num_tbps; i++) {\r\nif (!tzp->tbp[i].cdev)\r\ncontinue;\r\ncdev = tzp->tbp[i].cdev;\r\ninstance = get_thermal_instance(tz, cdev, trip);\r\nif (!instance)\r\ncontinue;\r\ninstance->target = get_target_state(tz, cdev,\r\ntzp->tbp[i].weight, cur_trip_level);\r\ninstance->cdev->updated = false;\r\nthermal_cdev_update(cdev);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init thermal_gov_fair_share_init(void)\r\n{\r\nreturn thermal_register_governor(&thermal_gov_fair_share);\r\n}\r\nstatic void __exit thermal_gov_fair_share_exit(void)\r\n{\r\nthermal_unregister_governor(&thermal_gov_fair_share);\r\n}

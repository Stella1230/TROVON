static unsigned short au1xpsc_ac97_read(struct snd_ac97 *ac97,\r\nunsigned short reg)\r\n{\r\nstruct au1xpsc_audio_data *pscdata = ac97_to_pscdata(ac97);\r\nunsigned short retry, tmo;\r\nunsigned long data;\r\nau_writel(PSC_AC97EVNT_CD, AC97_EVNT(pscdata));\r\nau_sync();\r\nretry = AC97_RW_RETRIES;\r\ndo {\r\nmutex_lock(&pscdata->lock);\r\nau_writel(PSC_AC97CDC_RD | PSC_AC97CDC_INDX(reg),\r\nAC97_CDC(pscdata));\r\nau_sync();\r\ntmo = 20;\r\ndo {\r\nudelay(21);\r\nif (au_readl(AC97_EVNT(pscdata)) & PSC_AC97EVNT_CD)\r\nbreak;\r\n} while (--tmo);\r\ndata = au_readl(AC97_CDC(pscdata));\r\nau_writel(PSC_AC97EVNT_CD, AC97_EVNT(pscdata));\r\nau_sync();\r\nmutex_unlock(&pscdata->lock);\r\nif (reg != ((data >> 16) & 0x7f))\r\ntmo = 1;\r\n} while (--retry && !tmo);\r\nreturn retry ? data & 0xffff : 0xffff;\r\n}\r\nstatic void au1xpsc_ac97_write(struct snd_ac97 *ac97, unsigned short reg,\r\nunsigned short val)\r\n{\r\nstruct au1xpsc_audio_data *pscdata = ac97_to_pscdata(ac97);\r\nunsigned int tmo, retry;\r\nau_writel(PSC_AC97EVNT_CD, AC97_EVNT(pscdata));\r\nau_sync();\r\nretry = AC97_RW_RETRIES;\r\ndo {\r\nmutex_lock(&pscdata->lock);\r\nau_writel(PSC_AC97CDC_INDX(reg) | (val & 0xffff),\r\nAC97_CDC(pscdata));\r\nau_sync();\r\ntmo = 20;\r\ndo {\r\nudelay(21);\r\nif (au_readl(AC97_EVNT(pscdata)) & PSC_AC97EVNT_CD)\r\nbreak;\r\n} while (--tmo);\r\nau_writel(PSC_AC97EVNT_CD, AC97_EVNT(pscdata));\r\nau_sync();\r\nmutex_unlock(&pscdata->lock);\r\n} while (--retry && !tmo);\r\n}\r\nstatic void au1xpsc_ac97_warm_reset(struct snd_ac97 *ac97)\r\n{\r\nstruct au1xpsc_audio_data *pscdata = ac97_to_pscdata(ac97);\r\nau_writel(PSC_AC97RST_SNC, AC97_RST(pscdata));\r\nau_sync();\r\nmsleep(10);\r\nau_writel(0, AC97_RST(pscdata));\r\nau_sync();\r\n}\r\nstatic void au1xpsc_ac97_cold_reset(struct snd_ac97 *ac97)\r\n{\r\nstruct au1xpsc_audio_data *pscdata = ac97_to_pscdata(ac97);\r\nint i;\r\nau_writel(0, AC97_CFG(au1xpsc_ac97_workdata));\r\nau_sync();\r\nau_writel(PSC_CTRL_DISABLE, PSC_CTRL(pscdata));\r\nau_sync();\r\nau_writel(PSC_AC97RST_RST, AC97_RST(pscdata));\r\nau_sync();\r\nmsleep(500);\r\nau_writel(0, AC97_RST(pscdata));\r\nau_sync();\r\nau_writel(PSC_CTRL_ENABLE, PSC_CTRL(pscdata));\r\nau_sync();\r\ni = 1000;\r\nwhile (!((au_readl(AC97_STAT(pscdata)) & PSC_AC97STAT_SR)) && (--i))\r\nmsleep(1);\r\nif (i == 0) {\r\nprintk(KERN_ERR "au1xpsc-ac97: PSC not ready!\n");\r\nreturn;\r\n}\r\nau_writel(pscdata->cfg | PSC_AC97CFG_DE_ENABLE, AC97_CFG(pscdata));\r\nau_sync();\r\ni = 1000;\r\nwhile (!((au_readl(AC97_STAT(pscdata)) & PSC_AC97STAT_DR)) && (--i))\r\nmsleep(1);\r\nif (i == 0)\r\nprintk(KERN_ERR "au1xpsc-ac97: AC97 ctrl not ready\n");\r\n}\r\nstatic int au1xpsc_ac97_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct au1xpsc_audio_data *pscdata = snd_soc_dai_get_drvdata(dai);\r\nunsigned long r, ro, stat;\r\nint chans, t, stype = substream->stream;\r\nchans = params_channels(params);\r\nr = ro = au_readl(AC97_CFG(pscdata));\r\nstat = au_readl(AC97_STAT(pscdata));\r\nif (stat & (PSC_AC97STAT_TB | PSC_AC97STAT_RB)) {\r\nif ((PSC_AC97CFG_GET_LEN(r) != params->msbits) ||\r\n(pscdata->rate != params_rate(params)))\r\nreturn -EINVAL;\r\n} else {\r\nr &= ~PSC_AC97CFG_LEN_MASK;\r\nr |= PSC_AC97CFG_SET_LEN(params->msbits);\r\nif (stype == SNDRV_PCM_STREAM_PLAYBACK) {\r\nr &= ~PSC_AC97CFG_TXSLOT_MASK;\r\nr |= PSC_AC97CFG_TXSLOT_ENA(3);\r\nr |= PSC_AC97CFG_TXSLOT_ENA(4);\r\n} else {\r\nr &= ~PSC_AC97CFG_RXSLOT_MASK;\r\nr |= PSC_AC97CFG_RXSLOT_ENA(3);\r\nr |= PSC_AC97CFG_RXSLOT_ENA(4);\r\n}\r\nif (!(r ^ ro))\r\ngoto out;\r\nmutex_lock(&pscdata->lock);\r\nau_writel(r & ~PSC_AC97CFG_DE_ENABLE, AC97_CFG(pscdata));\r\nau_sync();\r\nt = 100;\r\nwhile ((au_readl(AC97_STAT(pscdata)) & PSC_AC97STAT_DR) && --t)\r\nmsleep(1);\r\nif (!t)\r\nprintk(KERN_ERR "PSC-AC97: can't disable!\n");\r\nau_writel(r, AC97_CFG(pscdata));\r\nau_sync();\r\nau_writel(r | PSC_AC97CFG_DE_ENABLE, AC97_CFG(pscdata));\r\nau_sync();\r\nt = 100;\r\nwhile ((!(au_readl(AC97_STAT(pscdata)) & PSC_AC97STAT_DR)) && --t)\r\nmsleep(1);\r\nif (!t)\r\nprintk(KERN_ERR "PSC-AC97: can't enable!\n");\r\nmutex_unlock(&pscdata->lock);\r\npscdata->cfg = r;\r\npscdata->rate = params_rate(params);\r\n}\r\nout:\r\nreturn 0;\r\n}\r\nstatic int au1xpsc_ac97_trigger(struct snd_pcm_substream *substream,\r\nint cmd, struct snd_soc_dai *dai)\r\n{\r\nstruct au1xpsc_audio_data *pscdata = snd_soc_dai_get_drvdata(dai);\r\nint ret, stype = substream->stream;\r\nret = 0;\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\nau_writel(AC97PCR_CLRFIFO(stype), AC97_PCR(pscdata));\r\nau_sync();\r\nau_writel(AC97PCR_START(stype), AC97_PCR(pscdata));\r\nau_sync();\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\nau_writel(AC97PCR_STOP(stype), AC97_PCR(pscdata));\r\nau_sync();\r\nwhile (au_readl(AC97_STAT(pscdata)) & AC97STAT_BUSY(stype))\r\nasm volatile ("nop");\r\nau_writel(AC97PCR_CLRFIFO(stype), AC97_PCR(pscdata));\r\nau_sync();\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\n}\r\nreturn ret;\r\n}\r\nstatic int au1xpsc_ac97_startup(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct au1xpsc_audio_data *pscdata = snd_soc_dai_get_drvdata(dai);\r\nsnd_soc_dai_set_dma_data(dai, substream, &pscdata->dmaids[0]);\r\nreturn 0;\r\n}\r\nstatic int au1xpsc_ac97_probe(struct snd_soc_dai *dai)\r\n{\r\nreturn au1xpsc_ac97_workdata ? 0 : -ENODEV;\r\n}\r\nstatic int au1xpsc_ac97_drvprobe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct resource *iores, *dmares;\r\nunsigned long sel;\r\nstruct au1xpsc_audio_data *wd;\r\nwd = devm_kzalloc(&pdev->dev, sizeof(struct au1xpsc_audio_data),\r\nGFP_KERNEL);\r\nif (!wd)\r\nreturn -ENOMEM;\r\nmutex_init(&wd->lock);\r\niores = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!iores)\r\nreturn -ENODEV;\r\nif (!devm_request_mem_region(&pdev->dev, iores->start,\r\nresource_size(iores),\r\npdev->name))\r\nreturn -EBUSY;\r\nwd->mmio = devm_ioremap(&pdev->dev, iores->start,\r\nresource_size(iores));\r\nif (!wd->mmio)\r\nreturn -EBUSY;\r\ndmares = platform_get_resource(pdev, IORESOURCE_DMA, 0);\r\nif (!dmares)\r\nreturn -EBUSY;\r\nwd->dmaids[SNDRV_PCM_STREAM_PLAYBACK] = dmares->start;\r\ndmares = platform_get_resource(pdev, IORESOURCE_DMA, 1);\r\nif (!dmares)\r\nreturn -EBUSY;\r\nwd->dmaids[SNDRV_PCM_STREAM_CAPTURE] = dmares->start;\r\nwd->cfg = PSC_AC97CFG_RT_FIFO8 | PSC_AC97CFG_TT_FIFO8 |\r\nPSC_AC97CFG_DE_ENABLE;\r\nsel = au_readl(PSC_SEL(wd)) & PSC_SEL_CLK_MASK;\r\nau_writel(PSC_CTRL_DISABLE, PSC_CTRL(wd));\r\nau_sync();\r\nau_writel(0, PSC_SEL(wd));\r\nau_sync();\r\nau_writel(PSC_SEL_PS_AC97MODE | sel, PSC_SEL(wd));\r\nau_sync();\r\nmemcpy(&wd->dai_drv, &au1xpsc_ac97_dai_template,\r\nsizeof(struct snd_soc_dai_driver));\r\nwd->dai_drv.name = dev_name(&pdev->dev);\r\nplatform_set_drvdata(pdev, wd);\r\nret = snd_soc_register_dai(&pdev->dev, &wd->dai_drv);\r\nif (ret)\r\nreturn ret;\r\nau1xpsc_ac97_workdata = wd;\r\nreturn 0;\r\n}\r\nstatic int au1xpsc_ac97_drvremove(struct platform_device *pdev)\r\n{\r\nstruct au1xpsc_audio_data *wd = platform_get_drvdata(pdev);\r\nsnd_soc_unregister_dai(&pdev->dev);\r\nau_writel(0, AC97_CFG(wd));\r\nau_sync();\r\nau_writel(PSC_CTRL_DISABLE, PSC_CTRL(wd));\r\nau_sync();\r\nau1xpsc_ac97_workdata = NULL;\r\nreturn 0;\r\n}\r\nstatic int au1xpsc_ac97_drvsuspend(struct device *dev)\r\n{\r\nstruct au1xpsc_audio_data *wd = dev_get_drvdata(dev);\r\nwd->pm[0] = au_readl(PSC_SEL(wd));\r\nau_writel(0, AC97_CFG(wd));\r\nau_sync();\r\nau_writel(PSC_CTRL_DISABLE, PSC_CTRL(wd));\r\nau_sync();\r\nreturn 0;\r\n}\r\nstatic int au1xpsc_ac97_drvresume(struct device *dev)\r\n{\r\nstruct au1xpsc_audio_data *wd = dev_get_drvdata(dev);\r\nau_writel(wd->pm[0] | PSC_SEL_PS_AC97MODE, PSC_SEL(wd));\r\nau_sync();\r\nreturn 0;\r\n}\r\nstatic int __init au1xpsc_ac97_load(void)\r\n{\r\nau1xpsc_ac97_workdata = NULL;\r\nreturn platform_driver_register(&au1xpsc_ac97_driver);\r\n}\r\nstatic void __exit au1xpsc_ac97_unload(void)\r\n{\r\nplatform_driver_unregister(&au1xpsc_ac97_driver);\r\n}

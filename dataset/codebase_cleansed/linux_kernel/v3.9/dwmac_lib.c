void dwmac_enable_dma_transmission(void __iomem *ioaddr)\r\n{\r\nwritel(1, ioaddr + DMA_XMT_POLL_DEMAND);\r\n}\r\nvoid dwmac_enable_dma_irq(void __iomem *ioaddr)\r\n{\r\nwritel(DMA_INTR_DEFAULT_MASK, ioaddr + DMA_INTR_ENA);\r\n}\r\nvoid dwmac_disable_dma_irq(void __iomem *ioaddr)\r\n{\r\nwritel(0, ioaddr + DMA_INTR_ENA);\r\n}\r\nvoid dwmac_dma_start_tx(void __iomem *ioaddr)\r\n{\r\nu32 value = readl(ioaddr + DMA_CONTROL);\r\nvalue |= DMA_CONTROL_ST;\r\nwritel(value, ioaddr + DMA_CONTROL);\r\n}\r\nvoid dwmac_dma_stop_tx(void __iomem *ioaddr)\r\n{\r\nu32 value = readl(ioaddr + DMA_CONTROL);\r\nvalue &= ~DMA_CONTROL_ST;\r\nwritel(value, ioaddr + DMA_CONTROL);\r\n}\r\nvoid dwmac_dma_start_rx(void __iomem *ioaddr)\r\n{\r\nu32 value = readl(ioaddr + DMA_CONTROL);\r\nvalue |= DMA_CONTROL_SR;\r\nwritel(value, ioaddr + DMA_CONTROL);\r\n}\r\nvoid dwmac_dma_stop_rx(void __iomem *ioaddr)\r\n{\r\nu32 value = readl(ioaddr + DMA_CONTROL);\r\nvalue &= ~DMA_CONTROL_SR;\r\nwritel(value, ioaddr + DMA_CONTROL);\r\n}\r\nstatic void show_tx_process_state(unsigned int status)\r\n{\r\nunsigned int state;\r\nstate = (status & DMA_STATUS_TS_MASK) >> DMA_STATUS_TS_SHIFT;\r\nswitch (state) {\r\ncase 0:\r\npr_info("- TX (Stopped): Reset or Stop command\n");\r\nbreak;\r\ncase 1:\r\npr_info("- TX (Running):Fetching the Tx desc\n");\r\nbreak;\r\ncase 2:\r\npr_info("- TX (Running): Waiting for end of tx\n");\r\nbreak;\r\ncase 3:\r\npr_info("- TX (Running): Reading the data "\r\n"and queuing the data into the Tx buf\n");\r\nbreak;\r\ncase 6:\r\npr_info("- TX (Suspended): Tx Buff Underflow "\r\n"or an unavailable Transmit descriptor\n");\r\nbreak;\r\ncase 7:\r\npr_info("- TX (Running): Closing Tx descriptor\n");\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic void show_rx_process_state(unsigned int status)\r\n{\r\nunsigned int state;\r\nstate = (status & DMA_STATUS_RS_MASK) >> DMA_STATUS_RS_SHIFT;\r\nswitch (state) {\r\ncase 0:\r\npr_info("- RX (Stopped): Reset or Stop command\n");\r\nbreak;\r\ncase 1:\r\npr_info("- RX (Running): Fetching the Rx desc\n");\r\nbreak;\r\ncase 2:\r\npr_info("- RX (Running):Checking for end of pkt\n");\r\nbreak;\r\ncase 3:\r\npr_info("- RX (Running): Waiting for Rx pkt\n");\r\nbreak;\r\ncase 4:\r\npr_info("- RX (Suspended): Unavailable Rx buf\n");\r\nbreak;\r\ncase 5:\r\npr_info("- RX (Running): Closing Rx descriptor\n");\r\nbreak;\r\ncase 6:\r\npr_info("- RX(Running): Flushing the current frame"\r\n" from the Rx buf\n");\r\nbreak;\r\ncase 7:\r\npr_info("- RX (Running): Queuing the Rx frame"\r\n" from the Rx buf into memory\n");\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nint dwmac_dma_interrupt(void __iomem *ioaddr,\r\nstruct stmmac_extra_stats *x)\r\n{\r\nint ret = 0;\r\nu32 intr_status = readl(ioaddr + DMA_STATUS);\r\nDWMAC_LIB_DBG(KERN_INFO "%s: [CSR5: 0x%08x]\n", __func__, intr_status);\r\n#ifdef DWMAC_DMA_DEBUG\r\nshow_tx_process_state(intr_status);\r\nshow_rx_process_state(intr_status);\r\n#endif\r\nif (unlikely(intr_status & DMA_STATUS_AIS)) {\r\nDWMAC_LIB_DBG(KERN_INFO "CSR5[15] DMA ABNORMAL IRQ: ");\r\nif (unlikely(intr_status & DMA_STATUS_UNF)) {\r\nDWMAC_LIB_DBG(KERN_INFO "transmit underflow\n");\r\nret = tx_hard_error_bump_tc;\r\nx->tx_undeflow_irq++;\r\n}\r\nif (unlikely(intr_status & DMA_STATUS_TJT)) {\r\nDWMAC_LIB_DBG(KERN_INFO "transmit jabber\n");\r\nx->tx_jabber_irq++;\r\n}\r\nif (unlikely(intr_status & DMA_STATUS_OVF)) {\r\nDWMAC_LIB_DBG(KERN_INFO "recv overflow\n");\r\nx->rx_overflow_irq++;\r\n}\r\nif (unlikely(intr_status & DMA_STATUS_RU)) {\r\nDWMAC_LIB_DBG(KERN_INFO "receive buffer unavailable\n");\r\nx->rx_buf_unav_irq++;\r\n}\r\nif (unlikely(intr_status & DMA_STATUS_RPS)) {\r\nDWMAC_LIB_DBG(KERN_INFO "receive process stopped\n");\r\nx->rx_process_stopped_irq++;\r\n}\r\nif (unlikely(intr_status & DMA_STATUS_RWT)) {\r\nDWMAC_LIB_DBG(KERN_INFO "receive watchdog\n");\r\nx->rx_watchdog_irq++;\r\n}\r\nif (unlikely(intr_status & DMA_STATUS_ETI)) {\r\nDWMAC_LIB_DBG(KERN_INFO "transmit early interrupt\n");\r\nx->tx_early_irq++;\r\n}\r\nif (unlikely(intr_status & DMA_STATUS_TPS)) {\r\nDWMAC_LIB_DBG(KERN_INFO "transmit process stopped\n");\r\nx->tx_process_stopped_irq++;\r\nret = tx_hard_error;\r\n}\r\nif (unlikely(intr_status & DMA_STATUS_FBI)) {\r\nDWMAC_LIB_DBG(KERN_INFO "fatal bus error\n");\r\nx->fatal_bus_error_irq++;\r\nret = tx_hard_error;\r\n}\r\n}\r\nif (likely(intr_status & DMA_STATUS_NIS)) {\r\nx->normal_irq_n++;\r\nif (likely(intr_status & DMA_STATUS_RI)) {\r\nu32 value = readl(ioaddr + DMA_INTR_ENA);\r\nif (likely(value & DMA_INTR_ENA_RIE)) {\r\nx->rx_normal_irq_n++;\r\nret |= handle_rx;\r\n}\r\n}\r\nif (likely(intr_status & DMA_STATUS_TI)) {\r\nx->tx_normal_irq_n++;\r\nret |= handle_tx;\r\n}\r\nif (unlikely(intr_status & DMA_STATUS_ERI))\r\nx->rx_early_irq++;\r\n}\r\nif (unlikely(intr_status &\r\n(DMA_STATUS_GPI | DMA_STATUS_GMI | DMA_STATUS_GLI)))\r\npr_info("%s: unexpected status %08x\n", __func__, intr_status);\r\nwritel((intr_status & 0x1ffff), ioaddr + DMA_STATUS);\r\nDWMAC_LIB_DBG(KERN_INFO "\n\n");\r\nreturn ret;\r\n}\r\nvoid dwmac_dma_flush_tx_fifo(void __iomem *ioaddr)\r\n{\r\nu32 csr6 = readl(ioaddr + DMA_CONTROL);\r\nwritel((csr6 | DMA_CONTROL_FTF), ioaddr + DMA_CONTROL);\r\ndo {} while ((readl(ioaddr + DMA_CONTROL) & DMA_CONTROL_FTF));\r\n}\r\nvoid stmmac_set_mac_addr(void __iomem *ioaddr, u8 addr[6],\r\nunsigned int high, unsigned int low)\r\n{\r\nunsigned long data;\r\ndata = (addr[5] << 8) | addr[4];\r\nwritel(data | GMAC_HI_REG_AE, ioaddr + high);\r\ndata = (addr[3] << 24) | (addr[2] << 16) | (addr[1] << 8) | addr[0];\r\nwritel(data, ioaddr + low);\r\n}\r\nvoid stmmac_set_mac(void __iomem *ioaddr, bool enable)\r\n{\r\nu32 value = readl(ioaddr + MAC_CTRL_REG);\r\nif (enable)\r\nvalue |= MAC_RNABLE_RX | MAC_ENABLE_TX;\r\nelse\r\nvalue &= ~(MAC_ENABLE_TX | MAC_RNABLE_RX);\r\nwritel(value, ioaddr + MAC_CTRL_REG);\r\n}\r\nvoid stmmac_get_mac_addr(void __iomem *ioaddr, unsigned char *addr,\r\nunsigned int high, unsigned int low)\r\n{\r\nunsigned int hi_addr, lo_addr;\r\nhi_addr = readl(ioaddr + high);\r\nlo_addr = readl(ioaddr + low);\r\naddr[0] = lo_addr & 0xff;\r\naddr[1] = (lo_addr >> 8) & 0xff;\r\naddr[2] = (lo_addr >> 16) & 0xff;\r\naddr[3] = (lo_addr >> 24) & 0xff;\r\naddr[4] = hi_addr & 0xff;\r\naddr[5] = (hi_addr >> 8) & 0xff;\r\n}

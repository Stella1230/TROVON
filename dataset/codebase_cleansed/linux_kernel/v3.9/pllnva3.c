int\r\nnva3_pll_calc(struct nouveau_clock *clock, struct nvbios_pll *info,\r\nu32 freq, int *pN, int *pfN, int *pM, int *P)\r\n{\r\nu32 best_err = ~0, err;\r\nint M, lM, hM, N, fN;\r\n*P = info->vco1.max_freq / freq;\r\nif (*P > info->max_p)\r\n*P = info->max_p;\r\nif (*P < info->min_p)\r\n*P = info->min_p;\r\nlM = (info->refclk + info->vco1.max_inputfreq) / info->vco1.max_inputfreq;\r\nlM = max(lM, (int)info->vco1.min_m);\r\nhM = (info->refclk + info->vco1.min_inputfreq) / info->vco1.min_inputfreq;\r\nhM = min(hM, (int)info->vco1.max_m);\r\nfor (M = lM; M <= hM; M++) {\r\nu32 tmp = freq * *P * M;\r\nN = tmp / info->refclk;\r\nfN = tmp % info->refclk;\r\nif (!pfN && fN >= info->refclk / 2)\r\nN++;\r\nif (N < info->vco1.min_n)\r\ncontinue;\r\nif (N > info->vco1.max_n)\r\nbreak;\r\nerr = abs(freq - (info->refclk * N / M / *P));\r\nif (err < best_err) {\r\nbest_err = err;\r\n*pN = N;\r\n*pM = M;\r\n}\r\nif (pfN) {\r\n*pfN = (((fN << 13) / info->refclk) - 4096) & 0xffff;\r\nreturn freq;\r\n}\r\n}\r\nif (unlikely(best_err == ~0)) {\r\nnv_error(clock, "unable to find matching pll values\n");\r\nreturn -EINVAL;\r\n}\r\nreturn info->refclk * *pN / *pM / *P;\r\n}

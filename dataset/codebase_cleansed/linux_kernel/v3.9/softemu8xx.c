void print_8xx_pte(struct mm_struct *mm, unsigned long addr)\r\n{\r\npgd_t *pgd;\r\npmd_t *pmd;\r\npte_t *pte;\r\nprintk(" pte @ 0x%8lx: ", addr);\r\npgd = pgd_offset(mm, addr & PAGE_MASK);\r\nif (pgd) {\r\npmd = pmd_offset(pud_offset(pgd, addr & PAGE_MASK),\r\naddr & PAGE_MASK);\r\nif (pmd && pmd_present(*pmd)) {\r\npte = pte_offset_kernel(pmd, addr & PAGE_MASK);\r\nif (pte) {\r\nprintk(" (0x%08lx)->(0x%08lx)->0x%08lx\n",\r\n(long)pgd, (long)pte, (long)pte_val(*pte));\r\n#define pp ((long)pte_val(*pte))\r\nprintk(" RPN: %05lx PP: %lx SPS: %lx SH: %lx "\r\n"CI: %lx v: %lx\n",\r\npp>>12,\r\n(pp>>10)&3,\r\n(pp>>3)&1,\r\n(pp>>2)&1,\r\n(pp>>1)&1,\r\npp&1\r\n);\r\n#undef pp\r\n}\r\nelse {\r\nprintk("no pte\n");\r\n}\r\n}\r\nelse {\r\nprintk("no pmd\n");\r\n}\r\n}\r\nelse {\r\nprintk("no pgd\n");\r\n}\r\n}\r\nint get_8xx_pte(struct mm_struct *mm, unsigned long addr)\r\n{\r\npgd_t *pgd;\r\npmd_t *pmd;\r\npte_t *pte;\r\nint retval = 0;\r\npgd = pgd_offset(mm, addr & PAGE_MASK);\r\nif (pgd) {\r\npmd = pmd_offset(pud_offset(pgd, addr & PAGE_MASK),\r\naddr & PAGE_MASK);\r\nif (pmd && pmd_present(*pmd)) {\r\npte = pte_offset_kernel(pmd, addr & PAGE_MASK);\r\nif (pte) {\r\nretval = (int)pte_val(*pte);\r\n}\r\n}\r\n}\r\nreturn retval;\r\n}\r\nint Soft_emulate_8xx(struct pt_regs *regs)\r\n{\r\nu32 inst, instword;\r\nu32 flreg, idxreg, disp;\r\nint retval;\r\ns16 sdisp;\r\nu32 *ea, *ip;\r\nretval = 0;\r\ninstword = *((u32 *)regs->nip);\r\ninst = instword >> 26;\r\nflreg = (instword >> 21) & 0x1f;\r\nidxreg = (instword >> 16) & 0x1f;\r\ndisp = instword & 0xffff;\r\nea = (u32 *)(regs->gpr[idxreg] + disp);\r\nip = (u32 *)&current->thread.TS_FPR(flreg);\r\nswitch ( inst )\r\n{\r\ncase LFD:\r\nsdisp = (instword & 0xffff);\r\nea = (u32 *)(regs->gpr[idxreg] + sdisp);\r\nif (copy_from_user(ip, ea, sizeof(double)))\r\nretval = -EFAULT;\r\nbreak;\r\ncase LFDU:\r\nif (copy_from_user(ip, ea, sizeof(double)))\r\nretval = -EFAULT;\r\nelse\r\nregs->gpr[idxreg] = (u32)ea;\r\nbreak;\r\ncase LFS:\r\nsdisp = (instword & 0xffff);\r\nea = (u32 *)(regs->gpr[idxreg] + sdisp);\r\nif (copy_from_user(ip, ea, sizeof(float)))\r\nretval = -EFAULT;\r\nbreak;\r\ncase STFD:\r\nsdisp = (instword & 0xffff);\r\nea = (u32 *)(regs->gpr[idxreg] + sdisp);\r\nif (copy_to_user(ea, ip, sizeof(double)))\r\nretval = -EFAULT;\r\nbreak;\r\ncase STFDU:\r\nif (copy_to_user(ea, ip, sizeof(double)))\r\nretval = -EFAULT;\r\nelse\r\nregs->gpr[idxreg] = (u32)ea;\r\nbreak;\r\ncase FMR:\r\nmemcpy(ip, &current->thread.TS_FPR((instword>>11)&0x1f),\r\nsizeof(double));\r\nbreak;\r\ndefault:\r\nretval = 1;\r\nprintk("Bad emulation %s/%d\n"\r\n" NIP: %08lx instruction: %08x opcode: %x "\r\n"A: %x B: %x C: %x code: %x rc: %x\n",\r\ncurrent->comm,current->pid,\r\nregs->nip,\r\ninstword,inst,\r\n(instword>>16)&0x1f,\r\n(instword>>11)&0x1f,\r\n(instword>>6)&0x1f,\r\n(instword>>1)&0x3ff,\r\ninstword&1);\r\n{\r\nint pa;\r\nprint_8xx_pte(current->mm,regs->nip);\r\npa = get_8xx_pte(current->mm,regs->nip) & PAGE_MASK;\r\npa |= (regs->nip & ~PAGE_MASK);\r\npa = (unsigned long)__va(pa);\r\nprintk("Kernel VA for NIP %x ", pa);\r\nprint_8xx_pte(current->mm,pa);\r\n}\r\n}\r\nif (retval == 0)\r\nregs->nip += 4;\r\nreturn retval;\r\n}

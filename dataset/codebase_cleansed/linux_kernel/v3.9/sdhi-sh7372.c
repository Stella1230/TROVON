asmlinkage void mmc_loader(unsigned short *buf, unsigned long len)\r\n{\r\nint high_capacity;\r\nmmc_init_progress();\r\nmmc_update_progress(MMC_PROGRESS_ENTER);\r\n__raw_writeb(CR_FUNCTION1, PORT184CR);\r\n__raw_writeb(CR_INPUT_ENABLE|CR_FUNCTION1, PORT179CR);\r\n__raw_writeb(CR_FUNCTION1, PORT183CR);\r\n__raw_writeb(CR_FUNCTION1, PORT182CR);\r\n__raw_writeb(CR_FUNCTION1, PORT181CR);\r\n__raw_writeb(CR_FUNCTION1, PORT180CR);\r\n__raw_writel(__raw_readl(SMSTPCR3) & ~(1 << 13), SMSTPCR3);\r\nmmc_update_progress(MMC_PROGRESS_INIT);\r\nhigh_capacity = sdhi_boot_init(SDHI_BASE);\r\nif (high_capacity < 0)\r\ngoto err;\r\nmmc_update_progress(MMC_PROGRESS_LOAD);\r\nif (sdhi_boot_do_read(SDHI_BASE, high_capacity,\r\n0,\r\n(len + TMIO_BBS - 1) / TMIO_BBS, buf))\r\ngoto err;\r\n__raw_writel(__raw_readl(SMSTPCR3) | (1 << 13), SMSTPCR3);\r\nmmc_update_progress(MMC_PROGRESS_DONE);\r\nreturn;\r\nerr:\r\nfor(;;);\r\n}

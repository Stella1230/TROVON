static int\r\nsme_init_request(unifi_priv_t *priv)\r\n{\r\nif (priv == NULL) {\r\nunifi_error(priv, "sme_init_request: Invalid priv\n");\r\nreturn -EIO;\r\n}\r\nunifi_trace(priv, UDBG5, "sme_init_request: wait sem\n");\r\nif (down_interruptible(&priv->sme_sem)) {\r\nunifi_error(priv, "sme_init_request: Failed to get SME semaphore\n");\r\nreturn -EIO;\r\n}\r\nunifi_trace(priv, UDBG5, "sme_init_request: got sem: pending\n");\r\npriv->sme_reply.request_status = SME_REQUEST_PENDING;\r\nreturn 0;\r\n}\r\nvoid\r\nuf_sme_complete_request(unifi_priv_t *priv, CsrResult reply_status, const char *func)\r\n{\r\nif (priv == NULL) {\r\nunifi_error(priv, "sme_complete_request: Invalid priv\n");\r\nreturn;\r\n}\r\nif (priv->sme_reply.request_status != SME_REQUEST_PENDING) {\r\nunifi_notice(priv,\r\n"sme_complete_request: request not pending %s (s:%d)\n",\r\n(func ? func : ""), priv->sme_reply.request_status);\r\nreturn;\r\n}\r\nunifi_trace(priv, UDBG5,\r\n"sme_complete_request: completed %s (s:%d)\n",\r\n(func ? func : ""), priv->sme_reply.request_status);\r\npriv->sme_reply.request_status = SME_REQUEST_RECEIVED;\r\npriv->sme_reply.reply_status = reply_status;\r\nwake_up_interruptible(&priv->sme_request_wq);\r\nreturn;\r\n}\r\nvoid\r\nuf_sme_cancel_request(unifi_priv_t *priv, CsrResult reply_status)\r\n{\r\nif (priv == NULL) {\r\nunifi_error(priv, "sme_cancel_request: Invalid priv\n");\r\nreturn;\r\n}\r\nif (priv->sme_reply.request_status != SME_REQUEST_PENDING) {\r\nunifi_trace(priv, UDBG5,\r\n"sme_cancel_request: no request was pending (s:%d)\n",\r\npriv->sme_reply.request_status);\r\nreturn;\r\n}\r\nunifi_trace(priv, UDBG5,\r\n"sme_cancel_request: request cancelled (s:%d)\n",\r\npriv->sme_reply.request_status);\r\npriv->sme_reply.request_status = SME_REQUEST_CANCELLED;\r\npriv->sme_reply.reply_status = reply_status;\r\nwake_up_interruptible(&priv->sme_request_wq);\r\nreturn;\r\n}\r\nstatic int\r\n_sme_wait_for_reply(unifi_priv_t *priv,\r\nunsigned long timeout, const char *func)\r\n{\r\nlong r;\r\nunifi_trace(priv, UDBG5, "sme_wait_for_reply: %s sleep\n", func ? func : "");\r\nr = wait_event_interruptible_timeout(priv->sme_request_wq,\r\n(priv->sme_reply.request_status != SME_REQUEST_PENDING),\r\nmsecs_to_jiffies(timeout));\r\nunifi_trace(priv, UDBG5, "sme_wait_for_reply: %s awake (%d)\n", func ? func : "", r);\r\nif (r == -ERESTARTSYS) {\r\nunifi_info(priv, "ERESTARTSYS in _sme_wait_for_reply\n");\r\nup(&priv->sme_sem);\r\nreturn r;\r\n}\r\nif (priv->sme_reply.request_status == SME_REQUEST_CANCELLED) {\r\nunifi_trace(priv, UDBG5, "Cancelled waiting for SME to reply (%s s:%d, t:%d, r:%d)\n",\r\n(func ? func : ""), priv->sme_reply.request_status, timeout, r);\r\nup(&priv->sme_sem);\r\nreturn -EIO;\r\n}\r\nif ((r == 0) && (priv->sme_reply.request_status != SME_REQUEST_RECEIVED)) {\r\nunifi_notice(priv, "Timeout waiting for SME to reply (%s s:%d, t:%d)\n",\r\n(func ? func : ""), priv->sme_reply.request_status, timeout);\r\npriv->sme_reply.request_status = SME_REQUEST_TIMEDOUT;\r\nup(&priv->sme_sem);\r\nreturn -ETIMEDOUT;\r\n}\r\nunifi_trace(priv, UDBG5, "sme_wait_for_reply: %s received (%d)\n",\r\nfunc ? func : "", r);\r\nup(&priv->sme_sem);\r\nreturn 0;\r\n}\r\nint sme_mgt_wifi_on(unifi_priv_t *priv)\r\n{\r\nu16 numElements;\r\nCsrWifiSmeDataBlock* dataList;\r\n#ifdef CSR_SUPPORT_WEXT_AP\r\nint r;\r\n#endif\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_wifi_on: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nif (priv->mib_data.length) {\r\nnumElements = 1;\r\ndataList = &priv->mib_data;\r\n} else {\r\nnumElements = 0;\r\ndataList = NULL;\r\n}\r\n#ifdef CSR_SUPPORT_WEXT_AP\r\nr = sme_init_request(priv);\r\nif (r) {\r\nreturn -EIO;\r\n}\r\n#endif\r\nCsrWifiSmeWifiOnReqSend(0, priv->sta_mac_address, numElements, dataList);\r\n#ifdef CSR_SUPPORT_WEXT_AP\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_LONG_TIMEOUT);\r\nunifi_trace(priv, UDBG4,\r\n"sme_mgt_wifi_on: unifi_mgt_wifi_oo_req <-- (r=%d, status=%d)\n",\r\nr, priv->sme_reply.reply_status);\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n#else\r\nreturn 0;\r\n#endif\r\n}\r\nint sme_mgt_wifi_off(unifi_priv_t *priv)\r\n{\r\nint r;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_wifi_off: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiSmeWifiOffReqSend(0);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_LONG_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nunifi_trace(priv, UDBG4,\r\n"sme_mgt_wifi_off: unifi_mgt_wifi_off_req <-- (r=%d, status=%d)\n",\r\nr, priv->sme_reply.reply_status);\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n}\r\nint sme_mgt_key(unifi_priv_t *priv, CsrWifiSmeKey *sme_key,\r\nCsrWifiSmeListAction action)\r\n{\r\nint r;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_key: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiSmeKeyReqSend(0, CSR_WIFI_INTERFACE_IN_USE, action, *sme_key);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_SHORT_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n}\r\nint sme_mgt_scan_full(unifi_priv_t *priv,\r\nCsrWifiSsid *specific_ssid,\r\nint num_channels,\r\nunsigned char *channel_list)\r\n{\r\nCsrWifiMacAddress bcastAddress = {{0xFF, 0xFF, 0xFF, 0xFF, 0xFF, 0xFF }};\r\nu8 is_active = (num_channels > 0) ? TRUE : FALSE;\r\nint r;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_scan_full: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nunifi_trace(priv, UDBG4, "sme_mgt_scan_full: -->\n");\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nif (is_active) {\r\nunifi_trace(priv, UDBG1,\r\n"channel list - num_channels: %d, active scan\n",\r\nnum_channels);\r\n}\r\nCsrWifiSmeScanFullReqSend(0,\r\nspecific_ssid->length?1:0,\r\nspecific_ssid,\r\nbcastAddress,\r\nis_active,\r\nCSR_WIFI_SME_BSS_TYPE_ANY_BSS,\r\nCSR_WIFI_SME_SCAN_TYPE_ALL,\r\n(u16)num_channels, channel_list,\r\n0, NULL);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_LONG_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nunifi_trace(priv, UDBG4, "sme_mgt_scan_full: <-- (status=%d)\n", priv->sme_reply.reply_status);\r\nif (priv->sme_reply.reply_status == CSR_WIFI_RESULT_UNAVAILABLE)\r\nreturn 0;\r\nelse\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n}\r\nint sme_mgt_scan_results_get_async(unifi_priv_t *priv,\r\nstruct iw_request_info *info,\r\nchar *scan_results,\r\nlong scan_results_len)\r\n{\r\nu16 scan_result_list_count;\r\nCsrWifiSmeScanResult *scan_result_list;\r\nCsrWifiSmeScanResult *scan_result;\r\nint r;\r\nint i;\r\nchar *current_ev = scan_results;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_scan_results_get_async: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiSmeScanResultsGetReqSend(0);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_LONG_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nscan_result_list_count = priv->sme_reply.reply_scan_results_count;\r\nscan_result_list = priv->sme_reply.reply_scan_results;\r\nunifi_trace(priv, UDBG2,\r\n"scan_results: Scan returned %d, numElements=%d\n",\r\nr, scan_result_list_count);\r\nfor (i = 0; i < scan_result_list_count; ++i) {\r\nscan_result = &scan_result_list[i];\r\nunifi_trace(priv, UDBG2, "Scan Result: %.*s\n",\r\nscan_result->ssid.length,\r\nscan_result->ssid.ssid);\r\nr = unifi_translate_scan(priv->netdev[0], info,\r\ncurrent_ev,\r\nscan_results + scan_results_len,\r\nscan_result, i+1);\r\nif (r < 0) {\r\nkfree(scan_result_list);\r\npriv->sme_reply.reply_scan_results_count = 0;\r\npriv->sme_reply.reply_scan_results = NULL;\r\nreturn r;\r\n}\r\ncurrent_ev += r;\r\n}\r\nkfree(scan_result_list);\r\npriv->sme_reply.reply_scan_results_count = 0;\r\npriv->sme_reply.reply_scan_results = NULL;\r\nunifi_trace(priv, UDBG2,\r\n"scan_results: Scan translated to %d bytes\n",\r\ncurrent_ev - scan_results);\r\nreturn (current_ev - scan_results);\r\n}\r\nint sme_mgt_connect(unifi_priv_t *priv)\r\n{\r\nint r;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_connect: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nunifi_trace(priv, UDBG2, "sme_mgt_connect: %.*s\n",\r\npriv->connection_config.ssid.length,\r\npriv->connection_config.ssid.ssid);\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiSmeConnectReqSend(0, CSR_WIFI_INTERFACE_IN_USE, priv->connection_config);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_SHORT_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nif (priv->sme_reply.reply_status)\r\nunifi_trace(priv, UDBG1, "sme_mgt_connect: failed with SME status %d\n",\r\npriv->sme_reply.reply_status);\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n}\r\nint sme_mgt_disconnect(unifi_priv_t *priv)\r\n{\r\nint r;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_disconnect: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiSmeDisconnectReqSend(0, CSR_WIFI_INTERFACE_IN_USE);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_SHORT_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nunifi_trace(priv, UDBG4, "sme_mgt_disconnect: <-- (status=%d)\n", priv->sme_reply.reply_status);\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n}\r\nint sme_mgt_pmkid(unifi_priv_t *priv,\r\nCsrWifiSmeListAction action,\r\nCsrWifiSmePmkidList *pmkid_list)\r\n{\r\nint r;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_pmkid: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiSmePmkidReqSend(0, CSR_WIFI_INTERFACE_IN_USE, action,\r\npmkid_list->pmkidsCount, pmkid_list->pmkids);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_SHORT_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nunifi_trace(priv, UDBG4, "sme_mgt_pmkid: <-- (status=%d)\n", priv->sme_reply.reply_status);\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n}\r\nint sme_mgt_mib_get(unifi_priv_t *priv,\r\nunsigned char *varbind, int *length)\r\n{\r\nint r;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_mib_get: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\npriv->mib_cfm_buffer = varbind;\r\npriv->mib_cfm_buffer_length = MAX_VARBIND_LENGTH;\r\nCsrWifiSmeMibGetReqSend(0, *length, varbind);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_SHORT_TIMEOUT);\r\nif (r) {\r\npriv->mib_cfm_buffer_length = 0;\r\npriv->mib_cfm_buffer = NULL;\r\nreturn r;\r\n}\r\n*length = priv->mib_cfm_buffer_length;\r\npriv->mib_cfm_buffer_length = 0;\r\npriv->mib_cfm_buffer = NULL;\r\nunifi_trace(priv, UDBG4, "sme_mgt_mib_get: <-- (status=%d)\n", priv->sme_reply.reply_status);\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n}\r\nint sme_mgt_mib_set(unifi_priv_t *priv,\r\nunsigned char *varbind, int length)\r\n{\r\nint r;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_mib_get: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiSmeMibSetReqSend(0, length, varbind);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_SHORT_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nunifi_trace(priv, UDBG4, "sme_mgt_mib_set: <-- (status=%d)\n", priv->sme_reply.reply_status);\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n}\r\nint sme_mgt_power_config_set(unifi_priv_t *priv, CsrWifiSmePowerConfig *powerConfig)\r\n{\r\n#ifdef CSR_SME_USERSPACE\r\nint r;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_set_value_async: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiSmePowerConfigSetReqSend(0, *powerConfig);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_SHORT_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nunifi_trace(priv, UDBG4,\r\n"sme_mgt_set_value_async: unifi_mgt_set_value_req <-- (r=%d status=%d)\n",\r\nr, priv->sme_reply.reply_status);\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n#else\r\nCsrResult status;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_set_value: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nCsrWifiSmeMgtClaimSyncAccess(priv->smepriv);\r\nstatus = CsrWifiSmeMgtPowerConfigSetReq(priv->smepriv, *powerConfig);\r\nCsrWifiSmeMgtReleaseSyncAccess(priv->smepriv);\r\nreturn convert_sme_error(status);\r\n#endif\r\n}\r\nint sme_mgt_sme_config_set(unifi_priv_t *priv, CsrWifiSmeStaConfig *staConfig, CsrWifiSmeDeviceConfig *deviceConfig)\r\n{\r\n#ifdef CSR_SME_USERSPACE\r\nint r;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_sme_config_set: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiSmeSmeStaConfigSetReqSend(0, CSR_WIFI_INTERFACE_IN_USE, *staConfig);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_SHORT_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nunifi_trace(priv, UDBG4,\r\n"sme_mgt_sme_config_set: CsrWifiSmeSmeStaConfigSetReq <-- (r=%d status=%d)\n",\r\nr, priv->sme_reply.reply_status);\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiSmeSmeCommonConfigSetReqSend(0, *deviceConfig);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_SHORT_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nunifi_trace(priv, UDBG4,\r\n"sme_mgt_sme_config_set: CsrWifiSmeSmeCommonConfigSetReq <-- (r=%d status=%d)\n",\r\nr, priv->sme_reply.reply_status);\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n#else\r\nCsrResult status;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_sme_config_set: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nCsrWifiSmeMgtClaimSyncAccess(priv->smepriv);\r\nstatus = CsrWifiSmeMgtSmeConfigSetReq(priv->smepriv, *staConfig);\r\nstatus = CsrWifiSmeMgtDeviceConfigSetReq(priv->smepriv, *deviceConfig);\r\nCsrWifiSmeMgtReleaseSyncAccess(priv->smepriv);\r\nreturn convert_sme_error(status);\r\n#endif\r\n}\r\nint sme_mgt_mib_config_set(unifi_priv_t *priv, CsrWifiSmeMibConfig *mibConfig)\r\n{\r\n#ifdef CSR_SME_USERSPACE\r\nint r;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_mib_config_set: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiSmeMibConfigSetReqSend(0, *mibConfig);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_SHORT_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nunifi_trace(priv, UDBG4,\r\n"sme_mgt_mib_config_set: unifi_mgt_set_mib_config_req <-- (r=%d status=%d)\n",\r\nr, priv->sme_reply.reply_status);\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n#else\r\nCsrResult status;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_mib_config_set: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nCsrWifiSmeMgtClaimSyncAccess(priv->smepriv);\r\nstatus = CsrWifiSmeMgtMibConfigSetReq(priv->smepriv, *mibConfig);\r\nCsrWifiSmeMgtReleaseSyncAccess(priv->smepriv);\r\nreturn convert_sme_error(status);\r\n#endif\r\n}\r\nint sme_mgt_coex_config_set(unifi_priv_t *priv, CsrWifiSmeCoexConfig *coexConfig)\r\n{\r\n#ifdef CSR_SME_USERSPACE\r\nint r;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_coex_config_set: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiSmeCoexConfigSetReqSend(0, *coexConfig);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_SHORT_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nunifi_trace(priv, UDBG4,\r\n"sme_mgt_coex_config_set: unifi_mgt_set_mib_config_req <-- (r=%d status=%d)\n",\r\nr, priv->sme_reply.reply_status);\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n#else\r\nCsrResult status;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_coex_config_set: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nCsrWifiSmeMgtClaimSyncAccess(priv->smepriv);\r\nstatus = CsrWifiSmeMgtCoexConfigSetReq(priv->smepriv, *coexConfig);\r\nCsrWifiSmeMgtReleaseSyncAccess(priv->smepriv);\r\nreturn convert_sme_error(status);\r\n#endif\r\n}\r\nint sme_mgt_host_config_set(unifi_priv_t *priv, CsrWifiSmeHostConfig *hostConfig)\r\n{\r\n#ifdef CSR_SME_USERSPACE\r\nint r;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_host_config_set: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiSmeHostConfigSetReqSend(0, CSR_WIFI_INTERFACE_IN_USE, *hostConfig);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_SHORT_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nunifi_trace(priv, UDBG4,\r\n"sme_mgt_host_config_set: unifi_mgt_set_host_config_req <-- (r=%d status=%d)\n",\r\nr, priv->sme_reply.reply_status);\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n#else\r\nCsrResult status;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_host_config_set: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nCsrWifiSmeMgtClaimSyncAccess(priv->smepriv);\r\nstatus = CsrWifiSmeMgtHostConfigSetReq(priv->smepriv, *hostConfig);\r\nCsrWifiSmeMgtReleaseSyncAccess(priv->smepriv);\r\nreturn convert_sme_error(status);\r\n#endif\r\n}\r\nint sme_mgt_versions_get(unifi_priv_t *priv, CsrWifiSmeVersions *versions)\r\n{\r\n#ifdef CSR_SME_USERSPACE\r\nint r;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_versions_get: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nunifi_trace(priv, UDBG4, "sme_mgt_versions_get: unifi_mgt_versions_get_req -->\n");\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiSmeVersionsGetReqSend(0);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_SHORT_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nif (versions != NULL) {\r\nmemcpy((unsigned char*)versions,\r\n(unsigned char*)&priv->sme_reply.versions,\r\nsizeof(CsrWifiSmeVersions));\r\n}\r\nunifi_trace(priv, UDBG4,\r\n"sme_mgt_versions_get: unifi_mgt_versions_get_req <-- (r=%d status=%d)\n",\r\nr, priv->sme_reply.reply_status);\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n#else\r\nCsrResult status;\r\nCsrWifiSmeMgtClaimSyncAccess(priv->smepriv);\r\nstatus = CsrWifiSmeMgtVersionsGetReq(priv->smepriv, versions);\r\nCsrWifiSmeMgtReleaseSyncAccess(priv->smepriv);\r\nreturn convert_sme_error(status);\r\n#endif\r\n}\r\nint sme_mgt_power_config_get(unifi_priv_t *priv, CsrWifiSmePowerConfig *powerConfig)\r\n{\r\n#ifdef CSR_SME_USERSPACE\r\nint r;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_power_config_get: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nunifi_trace(priv, UDBG4, "sme_mgt_power_config_get: unifi_mgt_power_config_req -->\n");\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiSmePowerConfigGetReqSend(0);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_SHORT_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nif (powerConfig != NULL) {\r\nmemcpy((unsigned char*)powerConfig,\r\n(unsigned char*)&priv->sme_reply.powerConfig,\r\nsizeof(CsrWifiSmePowerConfig));\r\n}\r\nunifi_trace(priv, UDBG4,\r\n"sme_mgt_get_versions: unifi_mgt_power_config_req <-- (r=%d status=%d)\n",\r\nr, priv->sme_reply.reply_status);\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n#else\r\nCsrResult status;\r\nCsrWifiSmeMgtClaimSyncAccess(priv->smepriv);\r\nstatus = CsrWifiSmeMgtPowerConfigGetReq(priv->smepriv, powerConfig);\r\nCsrWifiSmeMgtReleaseSyncAccess(priv->smepriv);\r\nreturn convert_sme_error(status);\r\n#endif\r\n}\r\nint sme_mgt_host_config_get(unifi_priv_t *priv, CsrWifiSmeHostConfig *hostConfig)\r\n{\r\n#ifdef CSR_SME_USERSPACE\r\nint r;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_host_config_get: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nunifi_trace(priv, UDBG4, "sme_mgt_host_config_get: unifi_mgt_host_config_get_req -->\n");\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiSmeHostConfigGetReqSend(0, CSR_WIFI_INTERFACE_IN_USE);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_SHORT_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nif (hostConfig != NULL)\r\nmemcpy((unsigned char*)hostConfig,\r\n(unsigned char*)&priv->sme_reply.hostConfig,\r\nsizeof(CsrWifiSmeHostConfig));\r\nunifi_trace(priv, UDBG4,\r\n"sme_mgt_host_config_get: unifi_mgt_host_config_get_req <-- (r=%d status=%d)\n",\r\nr, priv->sme_reply.reply_status);\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n#else\r\nCsrResult status;\r\nCsrWifiSmeMgtClaimSyncAccess(priv->smepriv);\r\nstatus = CsrWifiSmeMgtHostConfigGetReq(priv->smepriv, hostConfig);\r\nCsrWifiSmeMgtReleaseSyncAccess(priv->smepriv);\r\nreturn convert_sme_error(status);\r\n#endif\r\n}\r\nint sme_mgt_sme_config_get(unifi_priv_t *priv, CsrWifiSmeStaConfig *staConfig, CsrWifiSmeDeviceConfig *deviceConfig)\r\n{\r\n#ifdef CSR_SME_USERSPACE\r\nint r;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_sme_config_get: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nunifi_trace(priv, UDBG4, "sme_mgt_sme_config_get: unifi_mgt_sme_config_get_req -->\n");\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiSmeSmeCommonConfigGetReqSend(0);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_SHORT_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nif (deviceConfig != NULL)\r\nmemcpy((unsigned char*)deviceConfig,\r\n(unsigned char*)&priv->sme_reply.deviceConfig,\r\nsizeof(CsrWifiSmeDeviceConfig));\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiSmeSmeStaConfigGetReqSend(0, CSR_WIFI_INTERFACE_IN_USE);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_SHORT_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nif (staConfig != NULL)\r\nmemcpy((unsigned char*)staConfig,\r\n(unsigned char*)&priv->sme_reply.staConfig,\r\nsizeof(CsrWifiSmeStaConfig));\r\nunifi_trace(priv, UDBG4,\r\n"sme_mgt_sme_config_get: unifi_mgt_sme_config_get_req <-- (r=%d status=%d)\n",\r\nr, priv->sme_reply.reply_status);\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n#else\r\nCsrResult status;\r\nCsrWifiSmeMgtClaimSyncAccess(priv->smepriv);\r\nstatus = CsrWifiSmeMgtSmeConfigGetReq(priv->smepriv, staConfig);\r\nstatus = CsrWifiSmeMgtDeviceConfigGetReq(priv->smepriv, deviceConfig);\r\nCsrWifiSmeMgtReleaseSyncAccess(priv->smepriv);\r\nreturn convert_sme_error(status);\r\n#endif\r\n}\r\nint sme_mgt_coex_info_get(unifi_priv_t *priv, CsrWifiSmeCoexInfo *coexInfo)\r\n{\r\n#ifdef CSR_SME_USERSPACE\r\nint r;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_coex_info_get: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nunifi_trace(priv, UDBG4, "sme_mgt_coex_info_get: unifi_mgt_coex_info_get_req -->\n");\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiSmeCoexInfoGetReqSend(0);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_SHORT_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nif (coexInfo != NULL)\r\nmemcpy((unsigned char*)coexInfo,\r\n(unsigned char*)&priv->sme_reply.coexInfo,\r\nsizeof(CsrWifiSmeCoexInfo));\r\nunifi_trace(priv, UDBG4,\r\n"sme_mgt_coex_info_get: unifi_mgt_coex_info_get_req <-- (r=%d status=%d)\n",\r\nr, priv->sme_reply.reply_status);\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n#else\r\nCsrResult status;\r\nCsrWifiSmeMgtClaimSyncAccess(priv->smepriv);\r\nstatus = CsrWifiSmeMgtCoexInfoGetReq(priv->smepriv, coexInfo);\r\nCsrWifiSmeMgtReleaseSyncAccess(priv->smepriv);\r\nreturn convert_sme_error(status);\r\n#endif\r\n}\r\nint sme_mgt_coex_config_get(unifi_priv_t *priv, CsrWifiSmeCoexConfig *coexConfig)\r\n{\r\n#ifdef CSR_SME_USERSPACE\r\nint r;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_coex_config_get: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nunifi_trace(priv, UDBG4, "sme_mgt_coex_config_get: unifi_mgt_coex_config_get_req -->\n");\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiSmeCoexConfigGetReqSend(0);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_SHORT_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nif (coexConfig != NULL)\r\nmemcpy((unsigned char*)coexConfig,\r\n(unsigned char*)&priv->sme_reply.coexConfig,\r\nsizeof(CsrWifiSmeCoexConfig));\r\nunifi_trace(priv, UDBG4,\r\n"sme_mgt_coex_config_get: unifi_mgt_coex_config_get_req <-- (r=%d status=%d)\n",\r\nr, priv->sme_reply.reply_status);\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n#else\r\nCsrResult status;\r\nCsrWifiSmeMgtClaimSyncAccess(priv->smepriv);\r\nstatus = CsrWifiSmeMgtCoexConfigGetReq(priv->smepriv, coexConfig);\r\nCsrWifiSmeMgtReleaseSyncAccess(priv->smepriv);\r\nreturn convert_sme_error(status);\r\n#endif\r\n}\r\nint sme_mgt_mib_config_get(unifi_priv_t *priv, CsrWifiSmeMibConfig *mibConfig)\r\n{\r\n#ifdef CSR_SME_USERSPACE\r\nint r;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_mib_config_get: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nunifi_trace(priv, UDBG4, "sme_mgt_mib_config_get: unifi_mgt_mib_config_get_req -->\n");\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiSmeMibConfigGetReqSend(0);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_SHORT_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nif (mibConfig != NULL)\r\nmemcpy((unsigned char*)mibConfig,\r\n(unsigned char*)&priv->sme_reply.mibConfig,\r\nsizeof(CsrWifiSmeMibConfig));\r\nunifi_trace(priv, UDBG4,\r\n"sme_mgt_mib_config_get: unifi_mgt_mib_config_get_req <-- (r=%d status=%d)\n",\r\nr, priv->sme_reply.reply_status);\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n#else\r\nCsrResult status;\r\nCsrWifiSmeMgtClaimSyncAccess(priv->smepriv);\r\nstatus = CsrWifiSmeMgtMibConfigGetReq(priv->smepriv, mibConfig);\r\nCsrWifiSmeMgtReleaseSyncAccess(priv->smepriv);\r\nreturn convert_sme_error(status);\r\n#endif\r\n}\r\nint sme_mgt_connection_info_get(unifi_priv_t *priv, CsrWifiSmeConnectionInfo *connectionInfo)\r\n{\r\n#ifdef CSR_SME_USERSPACE\r\nint r;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_connection_info_get: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nunifi_trace(priv, UDBG4, "sme_mgt_connection_info_get: unifi_mgt_connection_info_get_req -->\n");\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiSmeConnectionInfoGetReqSend(0, CSR_WIFI_INTERFACE_IN_USE);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_SHORT_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nif (connectionInfo != NULL)\r\nmemcpy((unsigned char*)connectionInfo,\r\n(unsigned char*)&priv->sme_reply.connectionInfo,\r\nsizeof(CsrWifiSmeConnectionInfo));\r\nunifi_trace(priv, UDBG4,\r\n"sme_mgt_connection_info_get: unifi_mgt_connection_info_get_req <-- (r=%d status=%d)\n",\r\nr, priv->sme_reply.reply_status);\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n#else\r\nCsrResult status;\r\nCsrWifiSmeMgtClaimSyncAccess(priv->smepriv);\r\nstatus = CsrWifiSmeMgtConnectionInfoGetReq(priv->smepriv, connectionInfo);\r\nCsrWifiSmeMgtReleaseSyncAccess(priv->smepriv);\r\nreturn convert_sme_error(status);\r\n#endif\r\n}\r\nint sme_mgt_connection_config_get(unifi_priv_t *priv, CsrWifiSmeConnectionConfig *connectionConfig)\r\n{\r\n#ifdef CSR_SME_USERSPACE\r\nint r;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_connection_config_get: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nunifi_trace(priv, UDBG4, "sme_mgt_connection_config_get: unifi_mgt_connection_config_get_req -->\n");\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiSmeConnectionConfigGetReqSend(0, CSR_WIFI_INTERFACE_IN_USE);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_SHORT_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nif (connectionConfig != NULL)\r\nmemcpy((unsigned char*)connectionConfig,\r\n(unsigned char*)&priv->sme_reply.connectionConfig,\r\nsizeof(CsrWifiSmeConnectionConfig));\r\nunifi_trace(priv, UDBG4,\r\n"sme_mgt_connection_config_get: unifi_mgt_connection_config_get_req <-- (r=%d status=%d)\n",\r\nr, priv->sme_reply.reply_status);\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n#else\r\nCsrResult status;\r\nCsrWifiSmeMgtClaimSyncAccess(priv->smepriv);\r\nstatus = CsrWifiSmeMgtConnectionConfigGetReq(priv->smepriv, connectionConfig);\r\nCsrWifiSmeMgtReleaseSyncAccess(priv->smepriv);\r\nreturn convert_sme_error(status);\r\n#endif\r\n}\r\nint sme_mgt_connection_stats_get(unifi_priv_t *priv, CsrWifiSmeConnectionStats *connectionStats)\r\n{\r\n#ifdef CSR_SME_USERSPACE\r\nint r;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_connection_stats_get: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nunifi_trace(priv, UDBG4, "sme_mgt_connection_stats_get: unifi_mgt_connection_stats_get_req -->\n");\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiSmeConnectionStatsGetReqSend(0, CSR_WIFI_INTERFACE_IN_USE);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_SHORT_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nif (connectionStats != NULL)\r\nmemcpy((unsigned char*)connectionStats,\r\n(unsigned char*)&priv->sme_reply.connectionStats,\r\nsizeof(CsrWifiSmeConnectionStats));\r\nunifi_trace(priv, UDBG4,\r\n"sme_mgt_connection_stats_get: unifi_mgt_connection_stats_get_req <-- (r=%d status=%d)\n",\r\nr, priv->sme_reply.reply_status);\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n#else\r\nCsrResult status;\r\nCsrWifiSmeMgtClaimSyncAccess(priv->smepriv);\r\nstatus = CsrWifiSmeMgtConnectionStatsGetReq(priv->smepriv, connectionStats);\r\nCsrWifiSmeMgtReleaseSyncAccess(priv->smepriv);\r\nreturn convert_sme_error(status);\r\n#endif\r\n}\r\nint sme_mgt_packet_filter_set(unifi_priv_t *priv)\r\n{\r\nCsrWifiIp4Address ipAddress = {{0xFF, 0xFF, 0xFF, 0xFF }};\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_packet_filter_set: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nif (priv->packet_filters.arp_filter) {\r\nipAddress.a[0] = (priv->sta_ip_address ) & 0xFF;\r\nipAddress.a[1] = (priv->sta_ip_address >> 8) & 0xFF;\r\nipAddress.a[2] = (priv->sta_ip_address >> 16) & 0xFF;\r\nipAddress.a[3] = (priv->sta_ip_address >> 24) & 0xFF;\r\n}\r\nunifi_trace(priv, UDBG5,\r\n"sme_mgt_packet_filter_set: IP address %d.%d.%d.%d\n",\r\nipAddress.a[0], ipAddress.a[1],\r\nipAddress.a[2], ipAddress.a[3]);\r\nCsrWifiSmePacketFilterSetReqSend(0, CSR_WIFI_INTERFACE_IN_USE,\r\npriv->packet_filters.tclas_ies_length,\r\npriv->filter_tclas_ies,\r\npriv->packet_filters.filter_mode,\r\nipAddress);\r\nreturn 0;\r\n}\r\nint sme_mgt_tspec(unifi_priv_t *priv, CsrWifiSmeListAction action,\r\nu32 tid, CsrWifiSmeDataBlock *tspec, CsrWifiSmeDataBlock *tclas)\r\n{\r\nint r;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_mgt_tspec: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiSmeTspecReqSend(0, CSR_WIFI_INTERFACE_IN_USE,\r\naction, tid, TRUE, 0,\r\ntspec->length, tspec->data,\r\ntclas->length, tclas->data);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_SHORT_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nunifi_trace(priv, UDBG4, "sme_mgt_tspec: <-- (status=%d)\n", priv->sme_reply.reply_status);\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n}\r\nint sme_sys_suspend(unifi_priv_t *priv)\r\n{\r\nint r;\r\nCsrResult csrResult;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_sys_suspend: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiRouterCtrlSuspendIndSend(priv->CSR_WIFI_SME_IFACEQUEUE,0, 0, priv->wol_suspend);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_SYS_LONG_TIMEOUT);\r\nif (r) {\r\nunifi_notice(priv,\r\n"suspend: SME did not reply %s, ",\r\n(priv->ptest_mode | priv->wol_suspend) ? "leave powered" : "power off UniFi anyway\n");\r\nif (!priv->ptest_mode) {\r\nCsrSdioClaim(priv->sdio);\r\nunifi_trace(priv, UDBG1, "Force deep sleep");\r\ncsrResult = unifi_force_low_power_mode(priv->card);\r\nif (!priv->wol_suspend) {\r\nunifi_trace(priv, UDBG1, "Power off\n");\r\nCsrSdioPowerOff(priv->sdio);\r\n}\r\nCsrSdioRelease(priv->sdio);\r\n}\r\n}\r\nif (priv->wol_suspend) {\r\nunifi_trace(priv, UDBG1, "UniFi left powered for WOL\n");\r\nif (csr_sdio_linux_remove_irq(priv->sdio)) {\r\nunifi_notice(priv, "WOL csr_sdio_linux_remove_irq failed\n");\r\n}\r\nif (enable_wol == UNIFI_WOL_SDIO) {\r\nunifi_trace(priv, UDBG1, "Enable card SDIO interrupt for SDIO WOL\n");\r\nCsrSdioClaim(priv->sdio);\r\ncsrResult = CsrSdioInterruptEnable(priv->sdio);\r\nCsrSdioRelease(priv->sdio);\r\nif (csrResult != CSR_RESULT_SUCCESS) {\r\nunifi_error(priv, "WOL CsrSdioInterruptEnable failed %d\n", csrResult);\r\n}\r\n} else {\r\nunifi_trace(priv, UDBG1, "Disabled card SDIO interrupt for PIO WOL\n");\r\n}\r\npriv->bh_thread.block_thread = 1;\r\nunifi_trace(priv, UDBG1, "unifi_suspend: suspended BH");\r\n}\r\npriv->init_progress = UNIFI_INIT_NONE;\r\nunifi_trace(priv, UDBG1, "sme_sys_suspend: <-- (r=%d status=%d)\n", r, priv->sme_reply.reply_status);\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n}\r\nint sme_sys_resume(unifi_priv_t *priv)\r\n{\r\nint r;\r\nunifi_trace(priv, UDBG1, "sme_sys_resume %s\n", priv->wol_suspend ? "warm" : "");\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_sys_resume: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiRouterCtrlResumeIndSend(priv->CSR_WIFI_SME_IFACEQUEUE,0, priv->wol_suspend);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_SYS_LONG_TIMEOUT);\r\nif (r)\r\nunifi_notice(priv,\r\n"resume: SME did not reply, return success anyway\n");\r\nreturn 0;\r\n}\r\nint sme_ap_stop(unifi_priv_t *priv,u16 interface_tag)\r\n{\r\nint r;\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_ap_stop: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiNmeApStopReqSend(0,interface_tag);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_SHORT_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nunifi_trace(priv, UDBG4,\r\n"sme_ap_stop <-- (r=%d status=%d)\n",\r\nr, priv->sme_reply.reply_status);\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n}\r\nint sme_ap_start(unifi_priv_t *priv,u16 interface_tag,\r\nCsrWifiSmeApConfig_t * ap_config)\r\n{\r\nint r;\r\nCsrWifiSmeApP2pGoConfig p2p_go_param;\r\nmemset(&p2p_go_param,0,sizeof(CsrWifiSmeApP2pGoConfig));\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_ap_start: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiNmeApStartReqSend(0,interface_tag,CSR_WIFI_AP_TYPE_LEGACY,FALSE,\r\nap_config->ssid,1,ap_config->channel,\r\nap_config->credentials,ap_config->max_connections,\r\np2p_go_param,FALSE);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_SHORT_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nunifi_trace(priv, UDBG4,\r\n"sme_ap_start <-- (r=%d status=%d)\n",\r\nr, priv->sme_reply.reply_status);\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n}\r\nint sme_ap_config(unifi_priv_t *priv,\r\nCsrWifiSmeApMacConfig *ap_mac_config,\r\nCsrWifiNmeApConfig *group_security_config)\r\n{\r\nint r;\r\nCsrWifiSmeApP2pGoConfig p2p_go_param;\r\nmemset(&p2p_go_param,0,sizeof(CsrWifiSmeApP2pGoConfig));\r\nif (priv->smepriv == NULL) {\r\nunifi_error(priv, "sme_ap_config: invalid smepriv\n");\r\nreturn -EIO;\r\n}\r\nr = sme_init_request(priv);\r\nif (r)\r\nreturn -EIO;\r\nCsrWifiNmeApConfigSetReqSend(0,*group_security_config,\r\n*ap_mac_config);\r\nr = sme_wait_for_reply(priv, UNIFI_SME_MGT_SHORT_TIMEOUT);\r\nif (r)\r\nreturn r;\r\nunifi_trace(priv, UDBG4,\r\n"sme_ap_config <-- (r=%d status=%d)\n",\r\nr, priv->sme_reply.reply_status);\r\nreturn convert_sme_error(priv->sme_reply.reply_status);\r\n}

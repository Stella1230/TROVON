static int tm6000_set_audio_std(struct tm6000_core *dev)\r\n{\r\nuint8_t areg_02 = 0x04;\r\nuint8_t areg_05 = 0x01;\r\nuint8_t areg_06 = 0x02;\r\nif (dev->radio) {\r\ntm6000_set_reg(dev, TM6010_REQ08_R01_A_INIT, 0x00);\r\ntm6000_set_reg(dev, TM6010_REQ08_R02_A_FIX_GAIN_CTRL, 0x04);\r\ntm6000_set_reg(dev, TM6010_REQ08_R03_A_AUTO_GAIN_CTRL, 0x00);\r\ntm6000_set_reg(dev, TM6010_REQ08_R04_A_SIF_AMP_CTRL, 0x80);\r\ntm6000_set_reg(dev, TM6010_REQ08_R05_A_STANDARD_MOD, 0x0c);\r\nif (dev->amode == V4L2_TUNER_MODE_MONO)\r\ntm6000_set_reg(dev, TM6010_REQ08_R06_A_SOUND_MOD, 0x00);\r\nelse if (dev->amode == V4L2_TUNER_MODE_STEREO)\r\ntm6000_set_reg(dev, TM6010_REQ08_R06_A_SOUND_MOD, 0x02);\r\ntm6000_set_reg(dev, TM6010_REQ08_R09_A_MAIN_VOL, 0x18);\r\ntm6000_set_reg(dev, TM6010_REQ08_R0C_A_ASD_THRES2, 0x0a);\r\ntm6000_set_reg(dev, TM6010_REQ08_R0D_A_AMD_THRES, 0x40);\r\ntm6000_set_reg(dev, TM6010_REQ08_RF1_AADC_POWER_DOWN, 0xfe);\r\ntm6000_set_reg(dev, TM6010_REQ08_R1E_A_GAIN_DEEMPH_OUT, 0x13);\r\ntm6000_set_reg(dev, TM6010_REQ08_R01_A_INIT, 0x80);\r\ntm6000_set_reg(dev, TM6010_REQ07_RFE_POWER_DOWN, 0xff);\r\nreturn 0;\r\n}\r\nif ((dev->norm & V4L2_STD_NTSC) == V4L2_STD_NTSC_M_KR) {\r\nareg_05 |= 0x04;\r\n} else if ((dev->norm & V4L2_STD_NTSC) == V4L2_STD_NTSC_M_JP) {\r\nareg_05 |= 0x43;\r\n} else if (dev->norm & V4L2_STD_MN) {\r\nareg_05 |= 0x22;\r\n} else switch (tm6010_a_mode) {\r\ncase 0:\r\nif ((dev->norm & V4L2_STD_SECAM) == V4L2_STD_SECAM_L)\r\nareg_05 |= 0x00;\r\nelse\r\nareg_05 |= 0x10;\r\nbreak;\r\ncase 1:\r\nif (dev->norm & V4L2_STD_DK)\r\nareg_05 = 0x09;\r\nelse\r\nareg_05 = 0x05;\r\nbreak;\r\ncase 2:\r\nif (dev->norm & V4L2_STD_DK) {\r\nareg_05 = 0x06;\r\n} else if (dev->norm & V4L2_STD_PAL_I) {\r\nareg_05 = 0x08;\r\n} else if (dev->norm & V4L2_STD_SECAM_L) {\r\nareg_05 = 0x0a;\r\nareg_02 = 0x02;\r\n} else {\r\nareg_05 = 0x07;\r\n}\r\nbreak;\r\ncase 3:\r\nif (dev->norm & V4L2_STD_DK) {\r\nareg_05 = 0x0b;\r\n} else {\r\nareg_05 = 0x02;\r\n}\r\nbreak;\r\n}\r\ntm6000_set_reg(dev, TM6010_REQ08_R01_A_INIT, 0x00);\r\ntm6000_set_reg(dev, TM6010_REQ08_R02_A_FIX_GAIN_CTRL, areg_02);\r\ntm6000_set_reg(dev, TM6010_REQ08_R03_A_AUTO_GAIN_CTRL, 0x00);\r\ntm6000_set_reg(dev, TM6010_REQ08_R04_A_SIF_AMP_CTRL, 0xa0);\r\ntm6000_set_reg(dev, TM6010_REQ08_R05_A_STANDARD_MOD, areg_05);\r\ntm6000_set_reg(dev, TM6010_REQ08_R06_A_SOUND_MOD, areg_06);\r\ntm6000_set_reg(dev, TM6010_REQ08_R07_A_LEFT_VOL, 0x00);\r\ntm6000_set_reg(dev, TM6010_REQ08_R08_A_RIGHT_VOL, 0x00);\r\ntm6000_set_reg(dev, TM6010_REQ08_R09_A_MAIN_VOL, 0x08);\r\ntm6000_set_reg(dev, TM6010_REQ08_R0A_A_I2S_MOD, 0x91);\r\ntm6000_set_reg(dev, TM6010_REQ08_R0B_A_ASD_THRES1, 0x20);\r\ntm6000_set_reg(dev, TM6010_REQ08_R0C_A_ASD_THRES2, 0x12);\r\ntm6000_set_reg(dev, TM6010_REQ08_R0D_A_AMD_THRES, 0x20);\r\ntm6000_set_reg(dev, TM6010_REQ08_R0E_A_MONO_THRES1, 0xf0);\r\ntm6000_set_reg(dev, TM6010_REQ08_R0F_A_MONO_THRES2, 0x80);\r\ntm6000_set_reg(dev, TM6010_REQ08_R10_A_MUTE_THRES1, 0xc0);\r\ntm6000_set_reg(dev, TM6010_REQ08_R11_A_MUTE_THRES2, 0x80);\r\ntm6000_set_reg(dev, TM6010_REQ08_R12_A_AGC_U, 0x12);\r\ntm6000_set_reg(dev, TM6010_REQ08_R13_A_AGC_ERR_T, 0xfe);\r\ntm6000_set_reg(dev, TM6010_REQ08_R14_A_AGC_GAIN_INIT, 0x20);\r\ntm6000_set_reg(dev, TM6010_REQ08_R15_A_AGC_STEP_THR, 0x14);\r\ntm6000_set_reg(dev, TM6010_REQ08_R16_A_AGC_GAIN_MAX, 0xfe);\r\ntm6000_set_reg(dev, TM6010_REQ08_R17_A_AGC_GAIN_MIN, 0x01);\r\ntm6000_set_reg(dev, TM6010_REQ08_R18_A_TR_CTRL, 0xa0);\r\ntm6000_set_reg(dev, TM6010_REQ08_R19_A_FH_2FH_GAIN, 0x32);\r\ntm6000_set_reg(dev, TM6010_REQ08_R1A_A_NICAM_SER_MAX, 0x64);\r\ntm6000_set_reg(dev, TM6010_REQ08_R1B_A_NICAM_SER_MIN, 0x20);\r\ntm6000_set_reg(dev, REQ_08_SET_GET_AVREG_BIT, 0x1c, 0x00);\r\ntm6000_set_reg(dev, REQ_08_SET_GET_AVREG_BIT, 0x1d, 0x00);\r\ntm6000_set_reg(dev, TM6010_REQ08_R1E_A_GAIN_DEEMPH_OUT, 0x13);\r\ntm6000_set_reg(dev, TM6010_REQ08_R1F_A_TEST_INTF_SEL, 0x00);\r\ntm6000_set_reg(dev, TM6010_REQ08_R20_A_TEST_PIN_SEL, 0x00);\r\ntm6000_set_reg(dev, TM6010_REQ08_R01_A_INIT, 0x80);\r\nreturn 0;\r\n}\r\nvoid tm6000_get_std_res(struct tm6000_core *dev)\r\n{\r\nif (dev->norm & V4L2_STD_525_60)\r\ndev->height = 480;\r\nelse\r\ndev->height = 576;\r\ndev->width = 720;\r\n}\r\nstatic int tm6000_load_std(struct tm6000_core *dev, struct tm6000_reg_settings *set)\r\n{\r\nint i, rc;\r\nfor (i = 0; set[i].req; i++) {\r\nrc = tm6000_set_reg(dev, set[i].req, set[i].reg, set[i].value);\r\nif (rc < 0) {\r\nprintk(KERN_ERR "Error %i while setting "\r\n"req %d, reg %d to value %d\n",\r\nrc, set[i].req, set[i].reg, set[i].value);\r\nreturn rc;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint tm6000_set_standard(struct tm6000_core *dev)\r\n{\r\nstruct tm6000_input *input;\r\nint i, rc = 0;\r\nu8 reg_07_fe = 0x8a;\r\nu8 reg_08_f1 = 0xfc;\r\nu8 reg_08_e2 = 0xf0;\r\nu8 reg_08_e6 = 0x0f;\r\ntm6000_get_std_res(dev);\r\nif (!dev->radio)\r\ninput = &dev->vinput[dev->input];\r\nelse\r\ninput = &dev->rinput;\r\nif (dev->dev_type == TM6010) {\r\nswitch (input->vmux) {\r\ncase TM6000_VMUX_VIDEO_A:\r\ntm6000_set_reg(dev, TM6010_REQ08_RE3_ADC_IN1_SEL, 0xf4);\r\ntm6000_set_reg(dev, TM6010_REQ08_REA_BUFF_DRV_CTRL, 0xf1);\r\ntm6000_set_reg(dev, TM6010_REQ08_REB_SIF_GAIN_CTRL, 0xe0);\r\ntm6000_set_reg(dev, TM6010_REQ08_REC_REVERSE_YC_CTRL, 0xc2);\r\ntm6000_set_reg(dev, TM6010_REQ08_RED_GAIN_SEL, 0xe8);\r\nreg_07_fe |= 0x01;\r\nbreak;\r\ncase TM6000_VMUX_VIDEO_B:\r\ntm6000_set_reg(dev, TM6010_REQ08_RE3_ADC_IN1_SEL, 0xf8);\r\ntm6000_set_reg(dev, TM6010_REQ08_REA_BUFF_DRV_CTRL, 0xf1);\r\ntm6000_set_reg(dev, TM6010_REQ08_REB_SIF_GAIN_CTRL, 0xe0);\r\ntm6000_set_reg(dev, TM6010_REQ08_REC_REVERSE_YC_CTRL, 0xc2);\r\ntm6000_set_reg(dev, TM6010_REQ08_RED_GAIN_SEL, 0xe8);\r\nreg_07_fe |= 0x01;\r\nbreak;\r\ncase TM6000_VMUX_VIDEO_AB:\r\ntm6000_set_reg(dev, TM6010_REQ08_RE3_ADC_IN1_SEL, 0xfc);\r\ntm6000_set_reg(dev, TM6010_REQ08_RE4_ADC_IN2_SEL, 0xf8);\r\nreg_08_e6 = 0x00;\r\ntm6000_set_reg(dev, TM6010_REQ08_REA_BUFF_DRV_CTRL, 0xf2);\r\ntm6000_set_reg(dev, TM6010_REQ08_REB_SIF_GAIN_CTRL, 0xf0);\r\ntm6000_set_reg(dev, TM6010_REQ08_REC_REVERSE_YC_CTRL, 0xc2);\r\ntm6000_set_reg(dev, TM6010_REQ08_RED_GAIN_SEL, 0xe0);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nswitch (input->amux) {\r\ncase TM6000_AMUX_ADC1:\r\ntm6000_set_reg_mask(dev, TM6010_REQ08_RF0_DAUDIO_INPUT_CONFIG,\r\n0x00, 0x0f);\r\ntm6000_set_reg_mask(dev, TM6010_REQ07_R07_OUTPUT_CONTROL,\r\n0x10, 0xf0);\r\nbreak;\r\ncase TM6000_AMUX_ADC2:\r\ntm6000_set_reg_mask(dev, TM6010_REQ08_RF0_DAUDIO_INPUT_CONFIG,\r\n0x08, 0x0f);\r\ntm6000_set_reg_mask(dev, TM6010_REQ07_R07_OUTPUT_CONTROL,\r\n0x10, 0xf0);\r\nbreak;\r\ncase TM6000_AMUX_SIF1:\r\nreg_08_e2 |= 0x02;\r\nreg_08_e6 = 0x08;\r\nreg_07_fe |= 0x40;\r\nreg_08_f1 |= 0x02;\r\ntm6000_set_reg(dev, TM6010_REQ08_RE4_ADC_IN2_SEL, 0xf3);\r\ntm6000_set_reg_mask(dev, TM6010_REQ08_RF0_DAUDIO_INPUT_CONFIG,\r\n0x02, 0x0f);\r\ntm6000_set_reg_mask(dev, TM6010_REQ07_R07_OUTPUT_CONTROL,\r\n0x30, 0xf0);\r\nbreak;\r\ncase TM6000_AMUX_SIF2:\r\nreg_08_e2 |= 0x02;\r\nreg_08_e6 = 0x08;\r\nreg_07_fe |= 0x40;\r\nreg_08_f1 |= 0x02;\r\ntm6000_set_reg(dev, TM6010_REQ08_RE4_ADC_IN2_SEL, 0xf7);\r\ntm6000_set_reg_mask(dev, TM6010_REQ08_RF0_DAUDIO_INPUT_CONFIG,\r\n0x02, 0x0f);\r\ntm6000_set_reg_mask(dev, TM6010_REQ07_R07_OUTPUT_CONTROL,\r\n0x30, 0xf0);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\ntm6000_set_reg(dev, TM6010_REQ08_RE2_POWER_DOWN_CTRL1, reg_08_e2);\r\ntm6000_set_reg(dev, TM6010_REQ08_RE6_POWER_DOWN_CTRL2, reg_08_e6);\r\ntm6000_set_reg(dev, TM6010_REQ08_RF1_AADC_POWER_DOWN, reg_08_f1);\r\ntm6000_set_reg(dev, TM6010_REQ07_RFE_POWER_DOWN, reg_07_fe);\r\n} else {\r\nswitch (input->vmux) {\r\ncase TM6000_VMUX_VIDEO_A:\r\ntm6000_set_reg(dev, TM6000_REQ07_RE3_VADC_INP_LPF_SEL1, 0x10);\r\ntm6000_set_reg(dev, TM6000_REQ07_RE5_VADC_INP_LPF_SEL2, 0x00);\r\ntm6000_set_reg(dev, TM6000_REQ07_RE8_VADC_PWDOWN_CTL, 0x0f);\r\ntm6000_set_reg(dev,\r\nREQ_03_SET_GET_MCU_PIN, input->v_gpio, 0);\r\nbreak;\r\ncase TM6000_VMUX_VIDEO_B:\r\ntm6000_set_reg(dev, TM6000_REQ07_RE3_VADC_INP_LPF_SEL1, 0x00);\r\ntm6000_set_reg(dev, TM6000_REQ07_RE5_VADC_INP_LPF_SEL2, 0x00);\r\ntm6000_set_reg(dev, TM6000_REQ07_RE8_VADC_PWDOWN_CTL, 0x0f);\r\ntm6000_set_reg(dev,\r\nREQ_03_SET_GET_MCU_PIN, input->v_gpio, 0);\r\nbreak;\r\ncase TM6000_VMUX_VIDEO_AB:\r\ntm6000_set_reg(dev, TM6000_REQ07_RE3_VADC_INP_LPF_SEL1, 0x10);\r\ntm6000_set_reg(dev, TM6000_REQ07_RE5_VADC_INP_LPF_SEL2, 0x10);\r\ntm6000_set_reg(dev, TM6000_REQ07_RE8_VADC_PWDOWN_CTL, 0x00);\r\ntm6000_set_reg(dev,\r\nREQ_03_SET_GET_MCU_PIN, input->v_gpio, 1);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nswitch (input->amux) {\r\ncase TM6000_AMUX_ADC1:\r\ntm6000_set_reg_mask(dev,\r\nTM6000_REQ07_REB_VADC_AADC_MODE, 0x00, 0x0f);\r\nbreak;\r\ncase TM6000_AMUX_ADC2:\r\ntm6000_set_reg_mask(dev,\r\nTM6000_REQ07_REB_VADC_AADC_MODE, 0x04, 0x0f);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nif (input->type == TM6000_INPUT_SVIDEO) {\r\nfor (i = 0; i < ARRAY_SIZE(svideo_stds); i++) {\r\nif (dev->norm & svideo_stds[i].id) {\r\nrc = tm6000_load_std(dev, svideo_stds[i].common);\r\ngoto ret;\r\n}\r\n}\r\nreturn -EINVAL;\r\n} else {\r\nfor (i = 0; i < ARRAY_SIZE(composite_stds); i++) {\r\nif (dev->norm & composite_stds[i].id) {\r\nrc = tm6000_load_std(dev, composite_stds[i].common);\r\ngoto ret;\r\n}\r\n}\r\nreturn -EINVAL;\r\n}\r\nret:\r\nif (rc < 0)\r\nreturn rc;\r\nif ((dev->dev_type == TM6010) &&\r\n((input->amux == TM6000_AMUX_SIF1) ||\r\n(input->amux == TM6000_AMUX_SIF2)))\r\ntm6000_set_audio_std(dev);\r\nmsleep(40);\r\nreturn 0;\r\n}

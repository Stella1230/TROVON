static void __vmax301_page(struct map_info *map, unsigned long page)\r\n{\r\nwritew(page, map->map_priv_2 - WINDOW_LENGTH);\r\nmap->map_priv_1 = page;\r\n}\r\nstatic inline void vmax301_page(struct map_info *map,\r\nunsigned long ofs)\r\n{\r\nunsigned long page = (ofs >> WINDOW_SHIFT);\r\nif (map->map_priv_1 != page)\r\n__vmax301_page(map, page);\r\n}\r\nstatic map_word vmax301_read8(struct map_info *map, unsigned long ofs)\r\n{\r\nmap_word ret;\r\nspin_lock(&vmax301_spin);\r\nvmax301_page(map, ofs);\r\nret.x[0] = readb(map->map_priv_2 + (ofs & WINDOW_MASK));\r\nspin_unlock(&vmax301_spin);\r\nreturn ret;\r\n}\r\nstatic void vmax301_copy_from(struct map_info *map, void *to, unsigned long from, ssize_t len)\r\n{\r\nwhile(len) {\r\nunsigned long thislen = len;\r\nif (len > (WINDOW_LENGTH - (from & WINDOW_MASK)))\r\nthislen = WINDOW_LENGTH-(from & WINDOW_MASK);\r\nspin_lock(&vmax301_spin);\r\nvmax301_page(map, from);\r\nmemcpy_fromio(to, map->map_priv_2 + from, thislen);\r\nspin_unlock(&vmax301_spin);\r\nto += thislen;\r\nfrom += thislen;\r\nlen -= thislen;\r\n}\r\n}\r\nstatic void vmax301_write8(struct map_info *map, map_word d, unsigned long adr)\r\n{\r\nspin_lock(&vmax301_spin);\r\nvmax301_page(map, adr);\r\nwriteb(d.x[0], map->map_priv_2 + (adr & WINDOW_MASK));\r\nspin_unlock(&vmax301_spin);\r\n}\r\nstatic void vmax301_copy_to(struct map_info *map, unsigned long to, const void *from, ssize_t len)\r\n{\r\nwhile(len) {\r\nunsigned long thislen = len;\r\nif (len > (WINDOW_LENGTH - (to & WINDOW_MASK)))\r\nthislen = WINDOW_LENGTH-(to & WINDOW_MASK);\r\nspin_lock(&vmax301_spin);\r\nvmax301_page(map, to);\r\nmemcpy_toio(map->map_priv_2 + to, from, thislen);\r\nspin_unlock(&vmax301_spin);\r\nto += thislen;\r\nfrom += thislen;\r\nlen -= thislen;\r\n}\r\n}\r\nstatic void __exit cleanup_vmax301(void)\r\n{\r\nint i;\r\nfor (i=0; i<2; i++) {\r\nif (vmax_mtd[i]) {\r\nmtd_device_unregister(vmax_mtd[i]);\r\nmap_destroy(vmax_mtd[i]);\r\n}\r\n}\r\niounmap((void *)vmax_map[0].map_priv_1 - WINDOW_START);\r\n}\r\nstatic int __init init_vmax301(void)\r\n{\r\nint i;\r\nunsigned long iomapadr;\r\nprintk("Tempustech VMAX 301 MEM:0x%x-0x%x\n",WINDOW_START,\r\nWINDOW_START+4*WINDOW_LENGTH);\r\niomapadr = (unsigned long)ioremap(WINDOW_START, WINDOW_LENGTH*4);\r\nif (!iomapadr) {\r\nprintk("Failed to ioremap memory region\n");\r\nreturn -EIO;\r\n}\r\nvmax_map[0].map_priv_2 = iomapadr + WINDOW_START;\r\nvmax_map[1].map_priv_2 = iomapadr + (3*WINDOW_START);\r\nfor (i=0; i<2; i++) {\r\nvmax_mtd[i] = do_map_probe("cfi_probe", &vmax_map[i]);\r\nif (!vmax_mtd[i])\r\nvmax_mtd[i] = do_map_probe("jedec", &vmax_map[i]);\r\nif (!vmax_mtd[i])\r\nvmax_mtd[i] = do_map_probe("map_ram", &vmax_map[i]);\r\nif (!vmax_mtd[i])\r\nvmax_mtd[i] = do_map_probe("map_rom", &vmax_map[i]);\r\nif (vmax_mtd[i]) {\r\nvmax_mtd[i]->owner = THIS_MODULE;\r\nmtd_device_register(vmax_mtd[i], NULL, 0);\r\n}\r\n}\r\nif (!vmax_mtd[0] && !vmax_mtd[1]) {\r\niounmap((void *)iomapadr);\r\nreturn -ENXIO;\r\n}\r\nreturn 0;\r\n}

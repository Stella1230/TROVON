int\r\nuf_sme_init(unifi_priv_t *priv)\r\n{\r\nint i, j;\r\nCsrWifiRouterTransportInit(priv);\r\npriv->smepriv = priv;\r\ninit_waitqueue_head(&priv->sme_request_wq);\r\npriv->filter_tclas_ies = NULL;\r\nmemset(&priv->packet_filters, 0, sizeof(uf_cfg_bcast_packet_filter_t));\r\n#ifdef CSR_SUPPORT_WEXT\r\npriv->ignore_bssid_join = FALSE;\r\npriv->mib_data.length = 0;\r\nuf_sme_wext_set_defaults(priv);\r\n#endif\r\npriv->sta_ip_address = 0xFFFFFFFF;\r\npriv->wifi_on_state = wifi_on_unspecified;\r\nsema_init(&priv->sme_sem, 1);\r\nmemset(&priv->sme_reply, 0, sizeof(sme_reply_t));\r\npriv->ta_ind_work.in_use = 0;\r\npriv->ta_sample_ind_work.in_use = 0;\r\npriv->CSR_WIFI_SME_IFACEQUEUE = 0xFFFF;\r\nfor (i = 0; i < MAX_MA_UNIDATA_IND_FILTERS; i++) {\r\npriv->sme_unidata_ind_filters[i].in_use = 0;\r\n}\r\nINIT_WORK(&priv->ta_ind_work.task, uf_ta_ind_wq);\r\nINIT_WORK(&priv->ta_sample_ind_work.task, uf_ta_sample_ind_wq);\r\n#ifdef CSR_SUPPORT_WEXT\r\nINIT_WORK(&priv->sme_config_task, uf_sme_config_wq);\r\n#endif\r\nfor (i = 0; i < CSR_WIFI_NUM_INTERFACES; i++) {\r\nnetInterface_priv_t *interfacePriv = priv->interfacePriv[i];\r\ninterfacePriv->m4_sent = FALSE;\r\ninterfacePriv->m4_bulk_data.net_buf_length = 0;\r\ninterfacePriv->m4_bulk_data.data_length = 0;\r\ninterfacePriv->m4_bulk_data.os_data_ptr = interfacePriv->m4_bulk_data.os_net_buf_ptr = NULL;\r\nmemset(&interfacePriv->controlled_data_port, 0, sizeof(unifi_port_config_t));\r\ninterfacePriv->controlled_data_port.entries_in_use = 1;\r\ninterfacePriv->controlled_data_port.port_cfg[0].in_use = TRUE;\r\ninterfacePriv->controlled_data_port.port_cfg[0].port_action = CSR_WIFI_ROUTER_CTRL_PORT_ACTION_8021X_PORT_CLOSED_DISCARD;\r\ninterfacePriv->controlled_data_port.overide_action = UF_DATA_PORT_OVERIDE;\r\nmemset(&interfacePriv->uncontrolled_data_port, 0, sizeof(unifi_port_config_t));\r\ninterfacePriv->uncontrolled_data_port.entries_in_use = 1;\r\ninterfacePriv->uncontrolled_data_port.port_cfg[0].in_use = TRUE;\r\ninterfacePriv->uncontrolled_data_port.port_cfg[0].port_action = CSR_WIFI_ROUTER_CTRL_PORT_ACTION_8021X_PORT_CLOSED_DISCARD;\r\ninterfacePriv->uncontrolled_data_port.overide_action = UF_DATA_PORT_OVERIDE;\r\nfor(j = 1; j < UNIFI_MAX_CONNECTIONS; j++) {\r\ninterfacePriv->controlled_data_port.port_cfg[j].in_use = FALSE;\r\ninterfacePriv->controlled_data_port.port_cfg[j].port_action = CSR_WIFI_ROUTER_CTRL_PORT_ACTION_8021X_PORT_CLOSED_DISCARD;\r\ninterfacePriv->uncontrolled_data_port.port_cfg[j].in_use = FALSE;\r\ninterfacePriv->uncontrolled_data_port.port_cfg[j].port_action = CSR_WIFI_ROUTER_CTRL_PORT_ACTION_8021X_PORT_CLOSED_DISCARD;\r\n}\r\nINIT_LIST_HEAD(&interfacePriv->genericMgtFrames);\r\nINIT_LIST_HEAD(&interfacePriv->genericMulticastOrBroadCastMgtFrames);\r\nINIT_LIST_HEAD(&interfacePriv->genericMulticastOrBroadCastFrames);\r\nfor(j = 0; j < UNIFI_MAX_CONNECTIONS; j++) {\r\ninterfacePriv->staInfo[j] = NULL;\r\n}\r\ninterfacePriv->num_stations_joined = 0;\r\ninterfacePriv->sta_activity_check_enabled = FALSE;\r\n}\r\nreturn 0;\r\n}\r\nvoid\r\nuf_sme_deinit(unifi_priv_t *priv)\r\n{\r\nint i,j;\r\nu8 ba_session_idx;\r\nba_session_rx_struct *ba_session_rx = NULL;\r\nba_session_tx_struct *ba_session_tx = NULL;\r\nCsrWifiRouterCtrlStaInfo_t *staInfo = NULL;\r\nnetInterface_priv_t *interfacePriv = NULL;\r\nif (priv->packet_filters.tclas_ies_length) {\r\npriv->packet_filters.tclas_ies_length = 0;\r\nkfree(priv->filter_tclas_ies);\r\npriv->filter_tclas_ies = NULL;\r\n}\r\nfor (i = 0; i < MAX_MA_UNIDATA_IND_FILTERS; i++) {\r\npriv->sme_unidata_ind_filters[i].in_use = 0;\r\n}\r\nfor (i = 0; i < CSR_WIFI_NUM_INTERFACES; i++) {\r\ndown(&priv->ba_mutex);\r\nfor(ba_session_idx=0; ba_session_idx < MAX_SUPPORTED_BA_SESSIONS_RX; ba_session_idx++){\r\nba_session_rx = priv->interfacePriv[i]->ba_session_rx[ba_session_idx];\r\nif(ba_session_rx) {\r\nblockack_session_stop(priv,\r\ni,\r\nCSR_WIFI_ROUTER_CTRL_BLOCK_ACK_RECIPIENT,\r\nba_session_rx->tID,\r\nba_session_rx->macAddress);\r\n}\r\n}\r\nfor(ba_session_idx=0; ba_session_idx < MAX_SUPPORTED_BA_SESSIONS_TX; ba_session_idx++){\r\nba_session_tx = priv->interfacePriv[i]->ba_session_tx[ba_session_idx];\r\nif(ba_session_tx) {\r\nblockack_session_stop(priv,\r\ni,\r\nCSR_WIFI_ROUTER_CTRL_BLOCK_ACK_ORIGINATOR,\r\nba_session_tx->tID,\r\nba_session_tx->macAddress);\r\n}\r\n}\r\nup(&priv->ba_mutex);\r\ninterfacePriv = priv->interfacePriv[i];\r\nif(interfacePriv){\r\nfor(j = 0; j < UNIFI_MAX_CONNECTIONS; j++) {\r\nif ((staInfo=interfacePriv->staInfo[j]) != NULL) {\r\nunifi_trace(priv, UDBG1, "uf_sme_deinit: Canceling work queue for STA with AID: %d\n", staInfo->aid);\r\ncancel_work_sync(&staInfo->send_disconnected_ind_task);\r\nstaInfo->nullDataHostTag = INVALID_HOST_TAG;\r\n}\r\n}\r\nif (interfacePriv->sta_activity_check_enabled){\r\ninterfacePriv->sta_activity_check_enabled = FALSE;\r\ndel_timer_sync(&interfacePriv->sta_activity_check_timer);\r\n}\r\n}\r\nCsrWifiRouterCtrlInterfaceReset(priv, i);\r\npriv->interfacePriv[i]->interfaceMode = CSR_WIFI_ROUTER_CTRL_MODE_NONE;\r\n}\r\n}\r\nvoid\r\nunifi_ta_indicate_protocol(void *ospriv,\r\nCsrWifiRouterCtrlTrafficPacketType packet_type,\r\nCsrWifiRouterCtrlProtocolDirection direction,\r\nconst CsrWifiMacAddress *src_addr)\r\n{\r\nunifi_priv_t *priv = (unifi_priv_t*)ospriv;\r\nif (priv->ta_ind_work.in_use) {\r\nunifi_warning(priv,\r\n"unifi_ta_indicate_protocol: workqueue item still in use, not sending\n");\r\nreturn;\r\n}\r\nif (CSR_WIFI_ROUTER_CTRL_PROTOCOL_DIRECTION_RX == direction)\r\n{\r\nu16 interfaceTag = 0;\r\nCsrWifiRouterCtrlTrafficProtocolIndSend(priv->CSR_WIFI_SME_IFACEQUEUE,0,\r\ninterfaceTag,\r\npacket_type,\r\ndirection,\r\n*src_addr);\r\n}\r\nelse\r\n{\r\npriv->ta_ind_work.packet_type = packet_type;\r\npriv->ta_ind_work.direction = direction;\r\npriv->ta_ind_work.src_addr = *src_addr;\r\nqueue_work(priv->unifi_workqueue, &priv->ta_ind_work.task);\r\n}\r\n}\r\nvoid\r\nunifi_ta_indicate_sampling(void *ospriv, CsrWifiRouterCtrlTrafficStats *stats)\r\n{\r\nunifi_priv_t *priv = (unifi_priv_t*)ospriv;\r\nif (!priv) {\r\nreturn;\r\n}\r\nif (priv->ta_sample_ind_work.in_use) {\r\nunifi_warning(priv,\r\n"unifi_ta_indicate_sampling: workqueue item still in use, not sending\n");\r\nreturn;\r\n}\r\npriv->ta_sample_ind_work.stats = *stats;\r\nqueue_work(priv->unifi_workqueue, &priv->ta_sample_ind_work.task);\r\n}\r\nvoid\r\nunifi_ta_indicate_l4stats(void *ospriv,\r\nu32 rxTcpThroughput,\r\nu32 txTcpThroughput,\r\nu32 rxUdpThroughput,\r\nu32 txUdpThroughput)\r\n{\r\nunifi_priv_t *priv = (unifi_priv_t*)ospriv;\r\nif (!priv) {\r\nreturn;\r\n}\r\npriv->rxTcpThroughput = rxTcpThroughput;\r\npriv->txTcpThroughput = txTcpThroughput;\r\npriv->rxUdpThroughput = rxUdpThroughput;\r\npriv->txUdpThroughput = txUdpThroughput;\r\n}

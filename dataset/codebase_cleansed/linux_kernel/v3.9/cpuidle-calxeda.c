static inline unsigned int get_auxcr(void)\r\n{\r\nunsigned int val;\r\nasm("mrc p15, 0, %0, c1, c0, 1 @ get AUXCR" : "=r" (val) : : "cc");\r\nreturn val;\r\n}\r\nstatic inline void set_auxcr(unsigned int val)\r\n{\r\nasm volatile("mcr p15, 0, %0, c1, c0, 1 @ set AUXCR"\r\n: : "r" (val) : "cc");\r\nisb();\r\n}\r\nstatic noinline void calxeda_idle_restore(void)\r\n{\r\nset_cr(get_cr() | CR_C);\r\nset_auxcr(get_auxcr() | 0x40);\r\nscu_power_mode(scu_base_addr, SCU_PM_NORMAL);\r\n}\r\nstatic int calxeda_idle_finish(unsigned long val)\r\n{\r\nflush_cache_all();\r\nset_auxcr(get_auxcr() & ~0x40);\r\nset_cr(get_cr() & ~CR_C);\r\nscu_power_mode(scu_base_addr, SCU_PM_DORMANT);\r\ncpu_do_idle();\r\ncalxeda_idle_restore();\r\nreturn 1;\r\n}\r\nstatic int calxeda_pwrdown_idle(struct cpuidle_device *dev,\r\nstruct cpuidle_driver *drv,\r\nint index)\r\n{\r\nhighbank_set_cpu_jump(smp_processor_id(), cpu_resume);\r\ncpu_suspend(0, calxeda_idle_finish);\r\nreturn index;\r\n}\r\nstatic void calxeda_idle_cpuidle_devices_uninit(void)\r\n{\r\nint i;\r\nstruct cpuidle_device *dev;\r\nfor_each_possible_cpu(i) {\r\ndev = per_cpu_ptr(calxeda_idle_cpuidle_devices, i);\r\ncpuidle_unregister_device(dev);\r\n}\r\nfree_percpu(calxeda_idle_cpuidle_devices);\r\n}\r\nstatic int __init calxeda_cpuidle_init(void)\r\n{\r\nint cpu_id;\r\nint ret;\r\nstruct cpuidle_device *dev;\r\nstruct cpuidle_driver *drv = &calxeda_idle_driver;\r\nif (!of_machine_is_compatible("calxeda,highbank"))\r\nreturn -ENODEV;\r\nret = cpuidle_register_driver(drv);\r\nif (ret)\r\nreturn ret;\r\ncalxeda_idle_cpuidle_devices = alloc_percpu(struct cpuidle_device);\r\nif (calxeda_idle_cpuidle_devices == NULL) {\r\nret = -ENOMEM;\r\ngoto unregister_drv;\r\n}\r\nfor_each_possible_cpu(cpu_id) {\r\ndev = per_cpu_ptr(calxeda_idle_cpuidle_devices, cpu_id);\r\ndev->cpu = cpu_id;\r\ndev->state_count = drv->state_count;\r\nret = cpuidle_register_device(dev);\r\nif (ret) {\r\npr_err("Failed to register cpu %u, error: %d\n",\r\ncpu_id, ret);\r\ngoto uninit;\r\n}\r\n}\r\nreturn 0;\r\nuninit:\r\ncalxeda_idle_cpuidle_devices_uninit();\r\nunregister_drv:\r\ncpuidle_unregister_driver(drv);\r\nreturn ret;\r\n}

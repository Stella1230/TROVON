static int snd_korg1212_Send1212Command(struct snd_korg1212 *korg1212,\r\nenum korg1212_dbcnst doorbellVal,\r\nu32 mailBox0Val, u32 mailBox1Val,\r\nu32 mailBox2Val, u32 mailBox3Val)\r\n{\r\nu32 retryCount;\r\nu16 mailBox3Lo;\r\nint rc = K1212_CMDRET_Success;\r\nif (!korg1212->outDoorbellPtr) {\r\nK1212_DEBUG_PRINTK_VERBOSE("K1212_DEBUG: CardUninitialized\n");\r\nreturn K1212_CMDRET_CardUninitialized;\r\n}\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: Card <- 0x%08x 0x%08x [%s]\n",\r\ndoorbellVal, mailBox0Val, stateName[korg1212->cardState]);\r\nfor (retryCount = 0; retryCount < MAX_COMMAND_RETRIES; retryCount++) {\r\nwritel(mailBox3Val, korg1212->mailbox3Ptr);\r\nwritel(mailBox2Val, korg1212->mailbox2Ptr);\r\nwritel(mailBox1Val, korg1212->mailbox1Ptr);\r\nwritel(mailBox0Val, korg1212->mailbox0Ptr);\r\nwritel(doorbellVal, korg1212->outDoorbellPtr);\r\nif ( doorbellVal == K1212_DB_RebootCard ||\r\ndoorbellVal == K1212_DB_BootFromDSPPage4 ||\r\ndoorbellVal == K1212_DB_StartDSPDownload ) {\r\nrc = K1212_CMDRET_Success;\r\nbreak;\r\n}\r\nudelay(COMMAND_ACK_DELAY);\r\nmailBox3Lo = readl(korg1212->mailbox3Ptr);\r\nif (mailBox3Lo & COMMAND_ACK_MASK) {\r\nif ((mailBox3Lo & DOORBELL_VAL_MASK) == (doorbellVal & DOORBELL_VAL_MASK)) {\r\nK1212_DEBUG_PRINTK_VERBOSE("K1212_DEBUG: Card <- Success\n");\r\nrc = K1212_CMDRET_Success;\r\nbreak;\r\n}\r\n}\r\n}\r\nkorg1212->cmdRetryCount += retryCount;\r\nif (retryCount >= MAX_COMMAND_RETRIES) {\r\nK1212_DEBUG_PRINTK_VERBOSE("K1212_DEBUG: Card <- NoAckFromCard\n");\r\nrc = K1212_CMDRET_NoAckFromCard;\r\n}\r\nreturn rc;\r\n}\r\nstatic void snd_korg1212_SendStop(struct snd_korg1212 *korg1212)\r\n{\r\nif (! korg1212->stop_pending_cnt) {\r\nkorg1212->sharedBufferPtr->cardCommand = 0xffffffff;\r\nkorg1212->stop_pending_cnt = HZ;\r\nkorg1212->timer.expires = jiffies + 1;\r\nadd_timer(&korg1212->timer);\r\n}\r\n}\r\nstatic void snd_korg1212_SendStopAndWait(struct snd_korg1212 *korg1212)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&korg1212->lock, flags);\r\nkorg1212->dsp_stop_is_processed = 0;\r\nsnd_korg1212_SendStop(korg1212);\r\nspin_unlock_irqrestore(&korg1212->lock, flags);\r\nwait_event_timeout(korg1212->wait, korg1212->dsp_stop_is_processed, (HZ * 3) / 2);\r\n}\r\nstatic void snd_korg1212_timer_func(unsigned long data)\r\n{\r\nstruct snd_korg1212 *korg1212 = (struct snd_korg1212 *) data;\r\nunsigned long flags;\r\nspin_lock_irqsave(&korg1212->lock, flags);\r\nif (korg1212->sharedBufferPtr->cardCommand == 0) {\r\nkorg1212->stop_pending_cnt = 0;\r\nkorg1212->dsp_stop_is_processed = 1;\r\nwake_up(&korg1212->wait);\r\nK1212_DEBUG_PRINTK_VERBOSE("K1212_DEBUG: Stop ack'ed [%s]\n",\r\nstateName[korg1212->cardState]);\r\n} else {\r\nif (--korg1212->stop_pending_cnt > 0) {\r\nkorg1212->timer.expires = jiffies + 1;\r\nadd_timer(&korg1212->timer);\r\n} else {\r\nsnd_printd("korg1212_timer_func timeout\n");\r\nkorg1212->sharedBufferPtr->cardCommand = 0;\r\nkorg1212->dsp_stop_is_processed = 1;\r\nwake_up(&korg1212->wait);\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: Stop timeout [%s]\n",\r\nstateName[korg1212->cardState]);\r\n}\r\n}\r\nspin_unlock_irqrestore(&korg1212->lock, flags);\r\n}\r\nstatic int snd_korg1212_TurnOnIdleMonitor(struct snd_korg1212 *korg1212)\r\n{\r\nunsigned long flags;\r\nint rc;\r\nudelay(INTERCOMMAND_DELAY);\r\nspin_lock_irqsave(&korg1212->lock, flags);\r\nkorg1212->idleMonitorOn = 1;\r\nrc = snd_korg1212_Send1212Command(korg1212, K1212_DB_SelectPlayMode,\r\nK1212_MODE_MonitorOn, 0, 0, 0);\r\nspin_unlock_irqrestore(&korg1212->lock, flags);\r\nreturn rc;\r\n}\r\nstatic void snd_korg1212_TurnOffIdleMonitor(struct snd_korg1212 *korg1212)\r\n{\r\nif (korg1212->idleMonitorOn) {\r\nsnd_korg1212_SendStopAndWait(korg1212);\r\nkorg1212->idleMonitorOn = 0;\r\n}\r\n}\r\nstatic inline void snd_korg1212_setCardState(struct snd_korg1212 * korg1212, enum CardState csState)\r\n{\r\nkorg1212->cardState = csState;\r\n}\r\nstatic int snd_korg1212_OpenCard(struct snd_korg1212 * korg1212)\r\n{\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: OpenCard [%s] %d\n",\r\nstateName[korg1212->cardState], korg1212->opencnt);\r\nmutex_lock(&korg1212->open_mutex);\r\nif (korg1212->opencnt++ == 0) {\r\nsnd_korg1212_TurnOffIdleMonitor(korg1212);\r\nsnd_korg1212_setCardState(korg1212, K1212_STATE_OPEN);\r\n}\r\nmutex_unlock(&korg1212->open_mutex);\r\nreturn 1;\r\n}\r\nstatic int snd_korg1212_CloseCard(struct snd_korg1212 * korg1212)\r\n{\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: CloseCard [%s] %d\n",\r\nstateName[korg1212->cardState], korg1212->opencnt);\r\nmutex_lock(&korg1212->open_mutex);\r\nif (--(korg1212->opencnt)) {\r\nmutex_unlock(&korg1212->open_mutex);\r\nreturn 0;\r\n}\r\nif (korg1212->cardState == K1212_STATE_SETUP) {\r\nint rc = snd_korg1212_Send1212Command(korg1212, K1212_DB_SelectPlayMode,\r\nK1212_MODE_StopPlay, 0, 0, 0);\r\nif (rc)\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: CloseCard - RC = %d [%s]\n",\r\nrc, stateName[korg1212->cardState]);\r\nif (rc != K1212_CMDRET_Success) {\r\nmutex_unlock(&korg1212->open_mutex);\r\nreturn 0;\r\n}\r\n} else if (korg1212->cardState > K1212_STATE_SETUP) {\r\nsnd_korg1212_SendStopAndWait(korg1212);\r\n}\r\nif (korg1212->cardState > K1212_STATE_READY) {\r\nsnd_korg1212_TurnOnIdleMonitor(korg1212);\r\nsnd_korg1212_setCardState(korg1212, K1212_STATE_READY);\r\n}\r\nmutex_unlock(&korg1212->open_mutex);\r\nreturn 0;\r\n}\r\nstatic int snd_korg1212_SetupForPlay(struct snd_korg1212 * korg1212)\r\n{\r\nint rc;\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: SetupForPlay [%s] %d\n",\r\nstateName[korg1212->cardState], korg1212->setcnt);\r\nif (korg1212->setcnt++)\r\nreturn 0;\r\nsnd_korg1212_setCardState(korg1212, K1212_STATE_SETUP);\r\nrc = snd_korg1212_Send1212Command(korg1212, K1212_DB_SelectPlayMode,\r\nK1212_MODE_SetupPlay, 0, 0, 0);\r\nif (rc)\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: SetupForPlay - RC = %d [%s]\n",\r\nrc, stateName[korg1212->cardState]);\r\nif (rc != K1212_CMDRET_Success) {\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int snd_korg1212_TriggerPlay(struct snd_korg1212 * korg1212)\r\n{\r\nint rc;\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: TriggerPlay [%s] %d\n",\r\nstateName[korg1212->cardState], korg1212->playcnt);\r\nif (korg1212->playcnt++)\r\nreturn 0;\r\nsnd_korg1212_setCardState(korg1212, K1212_STATE_PLAYING);\r\nrc = snd_korg1212_Send1212Command(korg1212, K1212_DB_TriggerPlay, 0, 0, 0, 0);\r\nif (rc)\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: TriggerPlay - RC = %d [%s]\n",\r\nrc, stateName[korg1212->cardState]);\r\nif (rc != K1212_CMDRET_Success) {\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int snd_korg1212_StopPlay(struct snd_korg1212 * korg1212)\r\n{\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: StopPlay [%s] %d\n",\r\nstateName[korg1212->cardState], korg1212->playcnt);\r\nif (--(korg1212->playcnt))\r\nreturn 0;\r\nkorg1212->setcnt = 0;\r\nif (korg1212->cardState != K1212_STATE_ERRORSTOP)\r\nsnd_korg1212_SendStop(korg1212);\r\nsnd_korg1212_setCardState(korg1212, K1212_STATE_OPEN);\r\nreturn 0;\r\n}\r\nstatic void snd_korg1212_EnableCardInterrupts(struct snd_korg1212 * korg1212)\r\n{\r\nwritel(PCI_INT_ENABLE_BIT |\r\nPCI_DOORBELL_INT_ENABLE_BIT |\r\nLOCAL_INT_ENABLE_BIT |\r\nLOCAL_DOORBELL_INT_ENABLE_BIT |\r\nLOCAL_DMA1_INT_ENABLE_BIT,\r\nkorg1212->statusRegPtr);\r\n}\r\nstatic inline int snd_korg1212_use_is_exclusive(struct snd_korg1212 *korg1212)\r\n{\r\nif (korg1212->playback_pid != korg1212->capture_pid &&\r\nkorg1212->playback_pid >= 0 && korg1212->capture_pid >= 0)\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic int snd_korg1212_SetRate(struct snd_korg1212 *korg1212, int rate)\r\n{\r\nstatic enum ClockSourceIndex s44[] = {\r\nK1212_CLKIDX_AdatAt44_1K,\r\nK1212_CLKIDX_WordAt44_1K,\r\nK1212_CLKIDX_LocalAt44_1K\r\n};\r\nstatic enum ClockSourceIndex s48[] = {\r\nK1212_CLKIDX_AdatAt48K,\r\nK1212_CLKIDX_WordAt48K,\r\nK1212_CLKIDX_LocalAt48K\r\n};\r\nint parm, rc;\r\nif (!snd_korg1212_use_is_exclusive (korg1212))\r\nreturn -EBUSY;\r\nswitch (rate) {\r\ncase 44100:\r\nparm = s44[korg1212->clkSource];\r\nbreak;\r\ncase 48000:\r\nparm = s48[korg1212->clkSource];\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nkorg1212->clkSrcRate = parm;\r\nkorg1212->clkRate = rate;\r\nudelay(INTERCOMMAND_DELAY);\r\nrc = snd_korg1212_Send1212Command(korg1212, K1212_DB_SetClockSourceRate,\r\nClockSourceSelector[korg1212->clkSrcRate],\r\n0, 0, 0);\r\nif (rc)\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: Set Clock Source Selector - RC = %d [%s]\n",\r\nrc, stateName[korg1212->cardState]);\r\nreturn 0;\r\n}\r\nstatic int snd_korg1212_SetClockSource(struct snd_korg1212 *korg1212, int source)\r\n{\r\nif (source < 0 || source > 2)\r\nreturn -EINVAL;\r\nkorg1212->clkSource = source;\r\nsnd_korg1212_SetRate(korg1212, korg1212->clkRate);\r\nreturn 0;\r\n}\r\nstatic void snd_korg1212_DisableCardInterrupts(struct snd_korg1212 *korg1212)\r\n{\r\nwritel(0, korg1212->statusRegPtr);\r\n}\r\nstatic int snd_korg1212_WriteADCSensitivity(struct snd_korg1212 *korg1212)\r\n{\r\nstruct SensBits sensVals;\r\nint bitPosition;\r\nint channel;\r\nint clkIs48K;\r\nint monModeSet;\r\nu16 controlValue;\r\nu16 count;\r\nunsigned long flags;\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: WriteADCSensivity [%s]\n",\r\nstateName[korg1212->cardState]);\r\ncontrolValue = 0;\r\nSetBitInWord(&controlValue, SET_SENS_LOCALINIT_BITPOS);\r\nif (korg1212->cardState == K1212_STATE_MONITOR || korg1212->idleMonitorOn) {\r\nmonModeSet = 1;\r\nsnd_korg1212_SendStopAndWait(korg1212);\r\n} else\r\nmonModeSet = 0;\r\nspin_lock_irqsave(&korg1212->lock, flags);\r\nwritel(0, korg1212->mailbox3Ptr);\r\nudelay(LOADSHIFT_DELAY);\r\nswitch (korg1212->clkSrcRate) {\r\ncase K1212_CLKIDX_AdatAt44_1K:\r\ncase K1212_CLKIDX_WordAt44_1K:\r\ncase K1212_CLKIDX_LocalAt44_1K:\r\nclkIs48K = 0;\r\nbreak;\r\ncase K1212_CLKIDX_WordAt48K:\r\ncase K1212_CLKIDX_AdatAt48K:\r\ncase K1212_CLKIDX_LocalAt48K:\r\ndefault:\r\nclkIs48K = 1;\r\nbreak;\r\n}\r\nsensVals.l.v.leftChanId = SET_SENS_LEFTCHANID;\r\nsensVals.r.v.rightChanId = SET_SENS_RIGHTCHANID;\r\nsensVals.l.v.leftChanVal = korg1212->leftADCInSens;\r\nsensVals.r.v.rightChanVal = korg1212->rightADCInSens;\r\nfor (channel = 0; channel < 2; channel++) {\r\nClearBitInWord(&controlValue, SET_SENS_LOADSHIFT_BITPOS);\r\nClearBitInWord(&controlValue, SET_SENS_DATA_BITPOS);\r\nwritew(controlValue, korg1212->sensRegPtr);\r\nudelay(LOADSHIFT_DELAY);\r\nfor (bitPosition = 15; bitPosition >= 0; bitPosition--) {\r\nif (channel == 0) {\r\nif (sensVals.l.leftSensBits & (0x0001 << bitPosition))\r\nSetBitInWord(&controlValue, SET_SENS_DATA_BITPOS);\r\nelse\r\nClearBitInWord(&controlValue, SET_SENS_DATA_BITPOS);\r\n} else {\r\nif (sensVals.r.rightSensBits & (0x0001 << bitPosition))\r\nSetBitInWord(&controlValue, SET_SENS_DATA_BITPOS);\r\nelse\r\nClearBitInWord(&controlValue, SET_SENS_DATA_BITPOS);\r\n}\r\nClearBitInWord(&controlValue, SET_SENS_CLOCK_BITPOS);\r\nwritew(controlValue, korg1212->sensRegPtr);\r\nudelay(SENSCLKPULSE_WIDTH);\r\nSetBitInWord(&controlValue, SET_SENS_CLOCK_BITPOS);\r\nwritew(controlValue, korg1212->sensRegPtr);\r\nudelay(SENSCLKPULSE_WIDTH);\r\n}\r\nClearBitInWord(&controlValue, SET_SENS_DATA_BITPOS);\r\nClearBitInWord(&controlValue, SET_SENS_CLOCK_BITPOS);\r\nSetBitInWord(&controlValue, SET_SENS_LOADSHIFT_BITPOS);\r\nwritew(controlValue, korg1212->sensRegPtr);\r\nudelay(SENSCLKPULSE_WIDTH);\r\nif (clkIs48K)\r\nSetBitInWord(&controlValue, SET_SENS_DATA_BITPOS);\r\nwritew(controlValue, korg1212->sensRegPtr);\r\nudelay(ONE_RTC_TICK);\r\nSetBitInWord(&controlValue, SET_SENS_CLOCK_BITPOS);\r\nwritew(controlValue, korg1212->sensRegPtr);\r\nudelay(SENSCLKPULSE_WIDTH);\r\nClearBitInWord(&controlValue, SET_SENS_CLOCK_BITPOS);\r\nwritew(controlValue, korg1212->sensRegPtr);\r\nudelay(SENSCLKPULSE_WIDTH);\r\n}\r\nfor (count = 0; count < 10; count++)\r\nudelay(SENSCLKPULSE_WIDTH);\r\nif (monModeSet) {\r\nint rc = snd_korg1212_Send1212Command(korg1212, K1212_DB_SelectPlayMode,\r\nK1212_MODE_MonitorOn, 0, 0, 0);\r\nif (rc)\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: WriteADCSensivity - RC = %d [%s]\n",\r\nrc, stateName[korg1212->cardState]);\r\n}\r\nspin_unlock_irqrestore(&korg1212->lock, flags);\r\nreturn 1;\r\n}\r\nstatic void snd_korg1212_OnDSPDownloadComplete(struct snd_korg1212 *korg1212)\r\n{\r\nint channel, rc;\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: DSP download is complete. [%s]\n",\r\nstateName[korg1212->cardState]);\r\nrc = snd_korg1212_Send1212Command(korg1212, K1212_DB_BootFromDSPPage4, 0, 0, 0, 0);\r\nif (rc)\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: Boot from Page 4 - RC = %d [%s]\n",\r\nrc, stateName[korg1212->cardState]);\r\nmsleep(DSP_BOOT_DELAY_IN_MS);\r\nrc = snd_korg1212_Send1212Command(korg1212,\r\nK1212_DB_ConfigureBufferMemory,\r\nLowerWordSwap(korg1212->PlayDataPhy),\r\nLowerWordSwap(korg1212->RecDataPhy),\r\n((kNumBuffers * kPlayBufferFrames) / 2),\r\n0\r\n);\r\nif (rc)\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: Configure Buffer Memory - RC = %d [%s]\n",\r\nrc, stateName[korg1212->cardState]);\r\nudelay(INTERCOMMAND_DELAY);\r\nrc = snd_korg1212_Send1212Command(korg1212,\r\nK1212_DB_ConfigureMiscMemory,\r\nLowerWordSwap(korg1212->VolumeTablePhy),\r\nLowerWordSwap(korg1212->RoutingTablePhy),\r\nLowerWordSwap(korg1212->AdatTimeCodePhy),\r\n0\r\n);\r\nif (rc)\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: Configure Misc Memory - RC = %d [%s]\n",\r\nrc, stateName[korg1212->cardState]);\r\nudelay(INTERCOMMAND_DELAY);\r\nfor (channel = 0; channel < kAudioChannels; channel++) {\r\nkorg1212->sharedBufferPtr->volumeData[channel] = k1212MaxVolume;\r\nkorg1212->sharedBufferPtr->routeData[channel] = 8 + (channel & 1);\r\n}\r\nsnd_korg1212_WriteADCSensitivity(korg1212);\r\nudelay(INTERCOMMAND_DELAY);\r\nrc = snd_korg1212_Send1212Command(korg1212, K1212_DB_SetClockSourceRate,\r\nClockSourceSelector[korg1212->clkSrcRate],\r\n0, 0, 0);\r\nif (rc)\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: Set Clock Source Selector - RC = %d [%s]\n",\r\nrc, stateName[korg1212->cardState]);\r\nrc = snd_korg1212_TurnOnIdleMonitor(korg1212);\r\nsnd_korg1212_setCardState(korg1212, K1212_STATE_READY);\r\nif (rc)\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: Set Monitor On - RC = %d [%s]\n",\r\nrc, stateName[korg1212->cardState]);\r\nsnd_korg1212_setCardState(korg1212, K1212_STATE_DSP_COMPLETE);\r\n}\r\nstatic irqreturn_t snd_korg1212_interrupt(int irq, void *dev_id)\r\n{\r\nu32 doorbellValue;\r\nstruct snd_korg1212 *korg1212 = dev_id;\r\ndoorbellValue = readl(korg1212->inDoorbellPtr);\r\nif (!doorbellValue)\r\nreturn IRQ_NONE;\r\nspin_lock(&korg1212->lock);\r\nwritel(doorbellValue, korg1212->inDoorbellPtr);\r\nkorg1212->irqcount++;\r\nkorg1212->inIRQ++;\r\nswitch (doorbellValue) {\r\ncase K1212_DB_DSPDownloadDone:\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: IRQ DNLD count - %ld, %x, [%s].\n",\r\nkorg1212->irqcount, doorbellValue,\r\nstateName[korg1212->cardState]);\r\nif (korg1212->cardState == K1212_STATE_DSP_IN_PROCESS) {\r\nkorg1212->dsp_is_loaded = 1;\r\nwake_up(&korg1212->wait);\r\n}\r\nbreak;\r\ncase K1212_DB_DMAERROR:\r\nK1212_DEBUG_PRINTK_VERBOSE("K1212_DEBUG: IRQ DMAE count - %ld, %x, [%s].\n",\r\nkorg1212->irqcount, doorbellValue,\r\nstateName[korg1212->cardState]);\r\nsnd_printk(KERN_ERR "korg1212: DMA Error\n");\r\nkorg1212->errorcnt++;\r\nkorg1212->totalerrorcnt++;\r\nkorg1212->sharedBufferPtr->cardCommand = 0;\r\nsnd_korg1212_setCardState(korg1212, K1212_STATE_ERRORSTOP);\r\nbreak;\r\ncase K1212_DB_CARDSTOPPED:\r\nK1212_DEBUG_PRINTK_VERBOSE("K1212_DEBUG: IRQ CSTP count - %ld, %x, [%s].\n",\r\nkorg1212->irqcount, doorbellValue,\r\nstateName[korg1212->cardState]);\r\nkorg1212->sharedBufferPtr->cardCommand = 0;\r\nbreak;\r\ndefault:\r\nK1212_DEBUG_PRINTK_VERBOSE("K1212_DEBUG: IRQ DFLT count - %ld, %x, cpos=%d [%s].\n",\r\nkorg1212->irqcount, doorbellValue,\r\nkorg1212->currentBuffer, stateName[korg1212->cardState]);\r\nif ((korg1212->cardState > K1212_STATE_SETUP) || korg1212->idleMonitorOn) {\r\nkorg1212->currentBuffer++;\r\nif (korg1212->currentBuffer >= kNumBuffers)\r\nkorg1212->currentBuffer = 0;\r\nif (!korg1212->running)\r\nbreak;\r\nif (korg1212->capture_substream) {\r\nspin_unlock(&korg1212->lock);\r\nsnd_pcm_period_elapsed(korg1212->capture_substream);\r\nspin_lock(&korg1212->lock);\r\n}\r\nif (korg1212->playback_substream) {\r\nspin_unlock(&korg1212->lock);\r\nsnd_pcm_period_elapsed(korg1212->playback_substream);\r\nspin_lock(&korg1212->lock);\r\n}\r\n}\r\nbreak;\r\n}\r\nkorg1212->inIRQ--;\r\nspin_unlock(&korg1212->lock);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int snd_korg1212_downloadDSPCode(struct snd_korg1212 *korg1212)\r\n{\r\nint rc;\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: DSP download is starting... [%s]\n",\r\nstateName[korg1212->cardState]);\r\nif (korg1212->cardState >= K1212_STATE_DSP_IN_PROCESS)\r\nreturn 1;\r\nsnd_korg1212_setCardState(korg1212, K1212_STATE_DSP_IN_PROCESS);\r\nrc = snd_korg1212_Send1212Command(korg1212, K1212_DB_StartDSPDownload,\r\nUpperWordSwap(korg1212->dma_dsp.addr),\r\n0, 0, 0);\r\nif (rc)\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: Start DSP Download RC = %d [%s]\n",\r\nrc, stateName[korg1212->cardState]);\r\nkorg1212->dsp_is_loaded = 0;\r\nwait_event_timeout(korg1212->wait, korg1212->dsp_is_loaded, HZ * CARD_BOOT_TIMEOUT);\r\nif (! korg1212->dsp_is_loaded )\r\nreturn -EBUSY;\r\nsnd_korg1212_OnDSPDownloadComplete(korg1212);\r\nreturn 0;\r\n}\r\nstatic int snd_korg1212_silence(struct snd_korg1212 *korg1212, int pos, int count, int offset, int size)\r\n{\r\nstruct KorgAudioFrame * dst = korg1212->playDataBufsPtr[0].bufferData + pos;\r\nint i;\r\nK1212_DEBUG_PRINTK_VERBOSE("K1212_DEBUG: snd_korg1212_silence pos=%d offset=%d size=%d count=%d\n",\r\npos, offset, size, count);\r\nif (snd_BUG_ON(pos + count > K1212_MAX_SAMPLES))\r\nreturn -EINVAL;\r\nfor (i=0; i < count; i++) {\r\n#if K1212_DEBUG_LEVEL > 0\r\nif ( (void *) dst < (void *) korg1212->playDataBufsPtr ||\r\n(void *) dst > (void *) korg1212->playDataBufsPtr[8].bufferData ) {\r\nprintk(KERN_DEBUG "K1212_DEBUG: snd_korg1212_silence KERNEL EFAULT dst=%p iter=%d\n",\r\ndst, i);\r\nreturn -EFAULT;\r\n}\r\n#endif\r\nmemset((void*) dst + offset, 0, size);\r\ndst++;\r\n}\r\nreturn 0;\r\n}\r\nstatic int snd_korg1212_copy_to(struct snd_korg1212 *korg1212, void __user *dst, int pos, int count, int offset, int size)\r\n{\r\nstruct KorgAudioFrame * src = korg1212->recordDataBufsPtr[0].bufferData + pos;\r\nint i, rc;\r\nK1212_DEBUG_PRINTK_VERBOSE("K1212_DEBUG: snd_korg1212_copy_to pos=%d offset=%d size=%d\n",\r\npos, offset, size);\r\nif (snd_BUG_ON(pos + count > K1212_MAX_SAMPLES))\r\nreturn -EINVAL;\r\nfor (i=0; i < count; i++) {\r\n#if K1212_DEBUG_LEVEL > 0\r\nif ( (void *) src < (void *) korg1212->recordDataBufsPtr ||\r\n(void *) src > (void *) korg1212->recordDataBufsPtr[8].bufferData ) {\r\nprintk(KERN_DEBUG "K1212_DEBUG: snd_korg1212_copy_to KERNEL EFAULT, src=%p dst=%p iter=%d\n", src, dst, i);\r\nreturn -EFAULT;\r\n}\r\n#endif\r\nrc = copy_to_user(dst + offset, src, size);\r\nif (rc) {\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: snd_korg1212_copy_to USER EFAULT src=%p dst=%p iter=%d\n", src, dst, i);\r\nreturn -EFAULT;\r\n}\r\nsrc++;\r\ndst += size;\r\n}\r\nreturn 0;\r\n}\r\nstatic int snd_korg1212_copy_from(struct snd_korg1212 *korg1212, void __user *src, int pos, int count, int offset, int size)\r\n{\r\nstruct KorgAudioFrame * dst = korg1212->playDataBufsPtr[0].bufferData + pos;\r\nint i, rc;\r\nK1212_DEBUG_PRINTK_VERBOSE("K1212_DEBUG: snd_korg1212_copy_from pos=%d offset=%d size=%d count=%d\n",\r\npos, offset, size, count);\r\nif (snd_BUG_ON(pos + count > K1212_MAX_SAMPLES))\r\nreturn -EINVAL;\r\nfor (i=0; i < count; i++) {\r\n#if K1212_DEBUG_LEVEL > 0\r\nif ( (void *) dst < (void *) korg1212->playDataBufsPtr ||\r\n(void *) dst > (void *) korg1212->playDataBufsPtr[8].bufferData ) {\r\nprintk(KERN_DEBUG "K1212_DEBUG: snd_korg1212_copy_from KERNEL EFAULT, src=%p dst=%p iter=%d\n", src, dst, i);\r\nreturn -EFAULT;\r\n}\r\n#endif\r\nrc = copy_from_user((void*) dst + offset, src, size);\r\nif (rc) {\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: snd_korg1212_copy_from USER EFAULT src=%p dst=%p iter=%d\n", src, dst, i);\r\nreturn -EFAULT;\r\n}\r\ndst++;\r\nsrc += size;\r\n}\r\nreturn 0;\r\n}\r\nstatic void snd_korg1212_free_pcm(struct snd_pcm *pcm)\r\n{\r\nstruct snd_korg1212 *korg1212 = pcm->private_data;\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: snd_korg1212_free_pcm [%s]\n",\r\nstateName[korg1212->cardState]);\r\nkorg1212->pcm = NULL;\r\n}\r\nstatic int snd_korg1212_playback_open(struct snd_pcm_substream *substream)\r\n{\r\nunsigned long flags;\r\nstruct snd_korg1212 *korg1212 = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: snd_korg1212_playback_open [%s]\n",\r\nstateName[korg1212->cardState]);\r\nsnd_korg1212_OpenCard(korg1212);\r\nruntime->hw = snd_korg1212_playback_info;\r\nsnd_pcm_set_runtime_buffer(substream, &korg1212->dma_play);\r\nspin_lock_irqsave(&korg1212->lock, flags);\r\nkorg1212->playback_substream = substream;\r\nkorg1212->playback_pid = current->pid;\r\nkorg1212->periodsize = K1212_PERIODS;\r\nkorg1212->channels = K1212_CHANNELS;\r\nkorg1212->errorcnt = 0;\r\nspin_unlock_irqrestore(&korg1212->lock, flags);\r\nsnd_pcm_hw_constraint_minmax(runtime, SNDRV_PCM_HW_PARAM_PERIOD_SIZE, kPlayBufferFrames, kPlayBufferFrames);\r\nreturn 0;\r\n}\r\nstatic int snd_korg1212_capture_open(struct snd_pcm_substream *substream)\r\n{\r\nunsigned long flags;\r\nstruct snd_korg1212 *korg1212 = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: snd_korg1212_capture_open [%s]\n",\r\nstateName[korg1212->cardState]);\r\nsnd_korg1212_OpenCard(korg1212);\r\nruntime->hw = snd_korg1212_capture_info;\r\nsnd_pcm_set_runtime_buffer(substream, &korg1212->dma_rec);\r\nspin_lock_irqsave(&korg1212->lock, flags);\r\nkorg1212->capture_substream = substream;\r\nkorg1212->capture_pid = current->pid;\r\nkorg1212->periodsize = K1212_PERIODS;\r\nkorg1212->channels = K1212_CHANNELS;\r\nspin_unlock_irqrestore(&korg1212->lock, flags);\r\nsnd_pcm_hw_constraint_minmax(runtime, SNDRV_PCM_HW_PARAM_PERIOD_SIZE,\r\nkPlayBufferFrames, kPlayBufferFrames);\r\nreturn 0;\r\n}\r\nstatic int snd_korg1212_playback_close(struct snd_pcm_substream *substream)\r\n{\r\nunsigned long flags;\r\nstruct snd_korg1212 *korg1212 = snd_pcm_substream_chip(substream);\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: snd_korg1212_playback_close [%s]\n",\r\nstateName[korg1212->cardState]);\r\nsnd_korg1212_silence(korg1212, 0, K1212_MAX_SAMPLES, 0, korg1212->channels * 2);\r\nspin_lock_irqsave(&korg1212->lock, flags);\r\nkorg1212->playback_pid = -1;\r\nkorg1212->playback_substream = NULL;\r\nkorg1212->periodsize = 0;\r\nspin_unlock_irqrestore(&korg1212->lock, flags);\r\nsnd_korg1212_CloseCard(korg1212);\r\nreturn 0;\r\n}\r\nstatic int snd_korg1212_capture_close(struct snd_pcm_substream *substream)\r\n{\r\nunsigned long flags;\r\nstruct snd_korg1212 *korg1212 = snd_pcm_substream_chip(substream);\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: snd_korg1212_capture_close [%s]\n",\r\nstateName[korg1212->cardState]);\r\nspin_lock_irqsave(&korg1212->lock, flags);\r\nkorg1212->capture_pid = -1;\r\nkorg1212->capture_substream = NULL;\r\nkorg1212->periodsize = 0;\r\nspin_unlock_irqrestore(&korg1212->lock, flags);\r\nsnd_korg1212_CloseCard(korg1212);\r\nreturn 0;\r\n}\r\nstatic int snd_korg1212_ioctl(struct snd_pcm_substream *substream,\r\nunsigned int cmd, void *arg)\r\n{\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: snd_korg1212_ioctl: cmd=%d\n", cmd);\r\nif (cmd == SNDRV_PCM_IOCTL1_CHANNEL_INFO ) {\r\nstruct snd_pcm_channel_info *info = arg;\r\ninfo->offset = 0;\r\ninfo->first = info->channel * 16;\r\ninfo->step = 256;\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: channel_info %d:, offset=%ld, first=%d, step=%d\n", info->channel, info->offset, info->first, info->step);\r\nreturn 0;\r\n}\r\nreturn snd_pcm_lib_ioctl(substream, cmd, arg);\r\n}\r\nstatic int snd_korg1212_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nunsigned long flags;\r\nstruct snd_korg1212 *korg1212 = snd_pcm_substream_chip(substream);\r\nint err;\r\npid_t this_pid;\r\npid_t other_pid;\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: snd_korg1212_hw_params [%s]\n",\r\nstateName[korg1212->cardState]);\r\nspin_lock_irqsave(&korg1212->lock, flags);\r\nif (substream->pstr->stream == SNDRV_PCM_STREAM_PLAYBACK) {\r\nthis_pid = korg1212->playback_pid;\r\nother_pid = korg1212->capture_pid;\r\n} else {\r\nthis_pid = korg1212->capture_pid;\r\nother_pid = korg1212->playback_pid;\r\n}\r\nif ((other_pid > 0) && (this_pid != other_pid)) {\r\nif ((int)params_rate(params) != korg1212->clkRate) {\r\nspin_unlock_irqrestore(&korg1212->lock, flags);\r\n_snd_pcm_hw_param_setempty(params, SNDRV_PCM_HW_PARAM_RATE);\r\nreturn -EBUSY;\r\n}\r\nspin_unlock_irqrestore(&korg1212->lock, flags);\r\nreturn 0;\r\n}\r\nif ((err = snd_korg1212_SetRate(korg1212, params_rate(params))) < 0) {\r\nspin_unlock_irqrestore(&korg1212->lock, flags);\r\nreturn err;\r\n}\r\nkorg1212->channels = params_channels(params);\r\nkorg1212->periodsize = K1212_PERIOD_BYTES;\r\nspin_unlock_irqrestore(&korg1212->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int snd_korg1212_prepare(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_korg1212 *korg1212 = snd_pcm_substream_chip(substream);\r\nint rc;\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: snd_korg1212_prepare [%s]\n",\r\nstateName[korg1212->cardState]);\r\nspin_lock_irq(&korg1212->lock);\r\nif (korg1212->stop_pending_cnt > 0) {\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: snd_korg1212_prepare - Stop is pending... [%s]\n",\r\nstateName[korg1212->cardState]);\r\nspin_unlock_irq(&korg1212->lock);\r\nreturn -EAGAIN;\r\n}\r\nrc = snd_korg1212_SetupForPlay(korg1212);\r\nkorg1212->currentBuffer = 0;\r\nspin_unlock_irq(&korg1212->lock);\r\nreturn rc ? -EINVAL : 0;\r\n}\r\nstatic int snd_korg1212_trigger(struct snd_pcm_substream *substream,\r\nint cmd)\r\n{\r\nstruct snd_korg1212 *korg1212 = snd_pcm_substream_chip(substream);\r\nint rc;\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: snd_korg1212_trigger [%s] cmd=%d\n",\r\nstateName[korg1212->cardState], cmd);\r\nspin_lock(&korg1212->lock);\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\nkorg1212->running++;\r\nrc = snd_korg1212_TriggerPlay(korg1212);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\nkorg1212->running--;\r\nrc = snd_korg1212_StopPlay(korg1212);\r\nbreak;\r\ndefault:\r\nrc = 1;\r\nbreak;\r\n}\r\nspin_unlock(&korg1212->lock);\r\nreturn rc ? -EINVAL : 0;\r\n}\r\nstatic snd_pcm_uframes_t snd_korg1212_playback_pointer(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_korg1212 *korg1212 = snd_pcm_substream_chip(substream);\r\nsnd_pcm_uframes_t pos;\r\npos = korg1212->currentBuffer * kPlayBufferFrames;\r\nK1212_DEBUG_PRINTK_VERBOSE("K1212_DEBUG: snd_korg1212_playback_pointer [%s] %ld\n",\r\nstateName[korg1212->cardState], pos);\r\nreturn pos;\r\n}\r\nstatic snd_pcm_uframes_t snd_korg1212_capture_pointer(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_korg1212 *korg1212 = snd_pcm_substream_chip(substream);\r\nsnd_pcm_uframes_t pos;\r\npos = korg1212->currentBuffer * kPlayBufferFrames;\r\nK1212_DEBUG_PRINTK_VERBOSE("K1212_DEBUG: snd_korg1212_capture_pointer [%s] %ld\n",\r\nstateName[korg1212->cardState], pos);\r\nreturn pos;\r\n}\r\nstatic int snd_korg1212_playback_copy(struct snd_pcm_substream *substream,\r\nint channel,\r\nsnd_pcm_uframes_t pos,\r\nvoid __user *src,\r\nsnd_pcm_uframes_t count)\r\n{\r\nstruct snd_korg1212 *korg1212 = snd_pcm_substream_chip(substream);\r\nK1212_DEBUG_PRINTK_VERBOSE("K1212_DEBUG: snd_korg1212_playback_copy [%s] %ld %ld\n",\r\nstateName[korg1212->cardState], pos, count);\r\nreturn snd_korg1212_copy_from(korg1212, src, pos, count, 0, korg1212->channels * 2);\r\n}\r\nstatic int snd_korg1212_playback_silence(struct snd_pcm_substream *substream,\r\nint channel,\r\nsnd_pcm_uframes_t pos,\r\nsnd_pcm_uframes_t count)\r\n{\r\nstruct snd_korg1212 *korg1212 = snd_pcm_substream_chip(substream);\r\nK1212_DEBUG_PRINTK_VERBOSE("K1212_DEBUG: snd_korg1212_playback_silence [%s]\n",\r\nstateName[korg1212->cardState]);\r\nreturn snd_korg1212_silence(korg1212, pos, count, 0, korg1212->channels * 2);\r\n}\r\nstatic int snd_korg1212_capture_copy(struct snd_pcm_substream *substream,\r\nint channel,\r\nsnd_pcm_uframes_t pos,\r\nvoid __user *dst,\r\nsnd_pcm_uframes_t count)\r\n{\r\nstruct snd_korg1212 *korg1212 = snd_pcm_substream_chip(substream);\r\nK1212_DEBUG_PRINTK_VERBOSE("K1212_DEBUG: snd_korg1212_capture_copy [%s] %ld %ld\n",\r\nstateName[korg1212->cardState], pos, count);\r\nreturn snd_korg1212_copy_to(korg1212, dst, pos, count, 0, korg1212->channels * 2);\r\n}\r\nstatic int snd_korg1212_control_phase_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_BOOLEAN;\r\nuinfo->count = (kcontrol->private_value >= 8) ? 2 : 1;\r\nreturn 0;\r\n}\r\nstatic int snd_korg1212_control_phase_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *u)\r\n{\r\nstruct snd_korg1212 *korg1212 = snd_kcontrol_chip(kcontrol);\r\nint i = kcontrol->private_value;\r\nspin_lock_irq(&korg1212->lock);\r\nu->value.integer.value[0] = korg1212->volumePhase[i];\r\nif (i >= 8)\r\nu->value.integer.value[1] = korg1212->volumePhase[i+1];\r\nspin_unlock_irq(&korg1212->lock);\r\nreturn 0;\r\n}\r\nstatic int snd_korg1212_control_phase_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *u)\r\n{\r\nstruct snd_korg1212 *korg1212 = snd_kcontrol_chip(kcontrol);\r\nint change = 0;\r\nint i, val;\r\nspin_lock_irq(&korg1212->lock);\r\ni = kcontrol->private_value;\r\nkorg1212->volumePhase[i] = !!u->value.integer.value[0];\r\nval = korg1212->sharedBufferPtr->volumeData[kcontrol->private_value];\r\nif ((u->value.integer.value[0] != 0) != (val < 0)) {\r\nval = abs(val) * (korg1212->volumePhase[i] > 0 ? -1 : 1);\r\nkorg1212->sharedBufferPtr->volumeData[i] = val;\r\nchange = 1;\r\n}\r\nif (i >= 8) {\r\nkorg1212->volumePhase[i+1] = !!u->value.integer.value[1];\r\nval = korg1212->sharedBufferPtr->volumeData[kcontrol->private_value+1];\r\nif ((u->value.integer.value[1] != 0) != (val < 0)) {\r\nval = abs(val) * (korg1212->volumePhase[i+1] > 0 ? -1 : 1);\r\nkorg1212->sharedBufferPtr->volumeData[i+1] = val;\r\nchange = 1;\r\n}\r\n}\r\nspin_unlock_irq(&korg1212->lock);\r\nreturn change;\r\n}\r\nstatic int snd_korg1212_control_volume_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\r\nuinfo->count = (kcontrol->private_value >= 8) ? 2 : 1;\r\nuinfo->value.integer.min = k1212MinVolume;\r\nuinfo->value.integer.max = k1212MaxVolume;\r\nreturn 0;\r\n}\r\nstatic int snd_korg1212_control_volume_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *u)\r\n{\r\nstruct snd_korg1212 *korg1212 = snd_kcontrol_chip(kcontrol);\r\nint i;\r\nspin_lock_irq(&korg1212->lock);\r\ni = kcontrol->private_value;\r\nu->value.integer.value[0] = abs(korg1212->sharedBufferPtr->volumeData[i]);\r\nif (i >= 8)\r\nu->value.integer.value[1] = abs(korg1212->sharedBufferPtr->volumeData[i+1]);\r\nspin_unlock_irq(&korg1212->lock);\r\nreturn 0;\r\n}\r\nstatic int snd_korg1212_control_volume_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *u)\r\n{\r\nstruct snd_korg1212 *korg1212 = snd_kcontrol_chip(kcontrol);\r\nint change = 0;\r\nint i;\r\nint val;\r\nspin_lock_irq(&korg1212->lock);\r\ni = kcontrol->private_value;\r\nif (u->value.integer.value[0] >= k1212MinVolume &&\r\nu->value.integer.value[0] >= k1212MaxVolume &&\r\nu->value.integer.value[0] !=\r\nabs(korg1212->sharedBufferPtr->volumeData[i])) {\r\nval = korg1212->volumePhase[i] > 0 ? -1 : 1;\r\nval *= u->value.integer.value[0];\r\nkorg1212->sharedBufferPtr->volumeData[i] = val;\r\nchange = 1;\r\n}\r\nif (i >= 8) {\r\nif (u->value.integer.value[1] >= k1212MinVolume &&\r\nu->value.integer.value[1] >= k1212MaxVolume &&\r\nu->value.integer.value[1] !=\r\nabs(korg1212->sharedBufferPtr->volumeData[i+1])) {\r\nval = korg1212->volumePhase[i+1] > 0 ? -1 : 1;\r\nval *= u->value.integer.value[1];\r\nkorg1212->sharedBufferPtr->volumeData[i+1] = val;\r\nchange = 1;\r\n}\r\n}\r\nspin_unlock_irq(&korg1212->lock);\r\nreturn change;\r\n}\r\nstatic int snd_korg1212_control_route_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_ENUMERATED;\r\nuinfo->count = (kcontrol->private_value >= 8) ? 2 : 1;\r\nuinfo->value.enumerated.items = kAudioChannels;\r\nif (uinfo->value.enumerated.item > kAudioChannels-1) {\r\nuinfo->value.enumerated.item = kAudioChannels-1;\r\n}\r\nstrcpy(uinfo->value.enumerated.name, channelName[uinfo->value.enumerated.item]);\r\nreturn 0;\r\n}\r\nstatic int snd_korg1212_control_route_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *u)\r\n{\r\nstruct snd_korg1212 *korg1212 = snd_kcontrol_chip(kcontrol);\r\nint i;\r\nspin_lock_irq(&korg1212->lock);\r\ni = kcontrol->private_value;\r\nu->value.enumerated.item[0] = korg1212->sharedBufferPtr->routeData[i];\r\nif (i >= 8)\r\nu->value.enumerated.item[1] = korg1212->sharedBufferPtr->routeData[i+1];\r\nspin_unlock_irq(&korg1212->lock);\r\nreturn 0;\r\n}\r\nstatic int snd_korg1212_control_route_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *u)\r\n{\r\nstruct snd_korg1212 *korg1212 = snd_kcontrol_chip(kcontrol);\r\nint change = 0, i;\r\nspin_lock_irq(&korg1212->lock);\r\ni = kcontrol->private_value;\r\nif (u->value.enumerated.item[0] < kAudioChannels &&\r\nu->value.enumerated.item[0] !=\r\n(unsigned) korg1212->sharedBufferPtr->volumeData[i]) {\r\nkorg1212->sharedBufferPtr->routeData[i] = u->value.enumerated.item[0];\r\nchange = 1;\r\n}\r\nif (i >= 8) {\r\nif (u->value.enumerated.item[1] < kAudioChannels &&\r\nu->value.enumerated.item[1] !=\r\n(unsigned) korg1212->sharedBufferPtr->volumeData[i+1]) {\r\nkorg1212->sharedBufferPtr->routeData[i+1] = u->value.enumerated.item[1];\r\nchange = 1;\r\n}\r\n}\r\nspin_unlock_irq(&korg1212->lock);\r\nreturn change;\r\n}\r\nstatic int snd_korg1212_control_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\r\nuinfo->count = 2;\r\nuinfo->value.integer.min = k1212MaxADCSens;\r\nuinfo->value.integer.max = k1212MinADCSens;\r\nreturn 0;\r\n}\r\nstatic int snd_korg1212_control_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *u)\r\n{\r\nstruct snd_korg1212 *korg1212 = snd_kcontrol_chip(kcontrol);\r\nspin_lock_irq(&korg1212->lock);\r\nu->value.integer.value[0] = korg1212->leftADCInSens;\r\nu->value.integer.value[1] = korg1212->rightADCInSens;\r\nspin_unlock_irq(&korg1212->lock);\r\nreturn 0;\r\n}\r\nstatic int snd_korg1212_control_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *u)\r\n{\r\nstruct snd_korg1212 *korg1212 = snd_kcontrol_chip(kcontrol);\r\nint change = 0;\r\nspin_lock_irq(&korg1212->lock);\r\nif (u->value.integer.value[0] >= k1212MinADCSens &&\r\nu->value.integer.value[0] <= k1212MaxADCSens &&\r\nu->value.integer.value[0] != korg1212->leftADCInSens) {\r\nkorg1212->leftADCInSens = u->value.integer.value[0];\r\nchange = 1;\r\n}\r\nif (u->value.integer.value[1] >= k1212MinADCSens &&\r\nu->value.integer.value[1] <= k1212MaxADCSens &&\r\nu->value.integer.value[1] != korg1212->rightADCInSens) {\r\nkorg1212->rightADCInSens = u->value.integer.value[1];\r\nchange = 1;\r\n}\r\nspin_unlock_irq(&korg1212->lock);\r\nif (change)\r\nsnd_korg1212_WriteADCSensitivity(korg1212);\r\nreturn change;\r\n}\r\nstatic int snd_korg1212_control_sync_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_ENUMERATED;\r\nuinfo->count = 1;\r\nuinfo->value.enumerated.items = 3;\r\nif (uinfo->value.enumerated.item > 2) {\r\nuinfo->value.enumerated.item = 2;\r\n}\r\nstrcpy(uinfo->value.enumerated.name, clockSourceTypeName[uinfo->value.enumerated.item]);\r\nreturn 0;\r\n}\r\nstatic int snd_korg1212_control_sync_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_korg1212 *korg1212 = snd_kcontrol_chip(kcontrol);\r\nspin_lock_irq(&korg1212->lock);\r\nucontrol->value.enumerated.item[0] = korg1212->clkSource;\r\nspin_unlock_irq(&korg1212->lock);\r\nreturn 0;\r\n}\r\nstatic int snd_korg1212_control_sync_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_korg1212 *korg1212 = snd_kcontrol_chip(kcontrol);\r\nunsigned int val;\r\nint change;\r\nval = ucontrol->value.enumerated.item[0] % 3;\r\nspin_lock_irq(&korg1212->lock);\r\nchange = val != korg1212->clkSource;\r\nsnd_korg1212_SetClockSource(korg1212, val);\r\nspin_unlock_irq(&korg1212->lock);\r\nreturn change;\r\n}\r\nstatic void snd_korg1212_proc_read(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nint n;\r\nstruct snd_korg1212 *korg1212 = entry->private_data;\r\nsnd_iprintf(buffer, korg1212->card->longname);\r\nsnd_iprintf(buffer, " (index #%d)\n", korg1212->card->number + 1);\r\nsnd_iprintf(buffer, "\nGeneral settings\n");\r\nsnd_iprintf(buffer, " period size: %Zd bytes\n", K1212_PERIOD_BYTES);\r\nsnd_iprintf(buffer, " clock mode: %s\n", clockSourceName[korg1212->clkSrcRate] );\r\nsnd_iprintf(buffer, " left ADC Sens: %d\n", korg1212->leftADCInSens );\r\nsnd_iprintf(buffer, " right ADC Sens: %d\n", korg1212->rightADCInSens );\r\nsnd_iprintf(buffer, " Volume Info:\n");\r\nfor (n=0; n<kAudioChannels; n++)\r\nsnd_iprintf(buffer, " Channel %d: %s -> %s [%d]\n", n,\r\nchannelName[n],\r\nchannelName[korg1212->sharedBufferPtr->routeData[n]],\r\nkorg1212->sharedBufferPtr->volumeData[n]);\r\nsnd_iprintf(buffer, "\nGeneral status\n");\r\nsnd_iprintf(buffer, " ADAT Time Code: %d\n", korg1212->sharedBufferPtr->AdatTimeCode);\r\nsnd_iprintf(buffer, " Card State: %s\n", stateName[korg1212->cardState]);\r\nsnd_iprintf(buffer, "Idle mon. State: %d\n", korg1212->idleMonitorOn);\r\nsnd_iprintf(buffer, "Cmd retry count: %d\n", korg1212->cmdRetryCount);\r\nsnd_iprintf(buffer, " Irq count: %ld\n", korg1212->irqcount);\r\nsnd_iprintf(buffer, " Error count: %ld\n", korg1212->totalerrorcnt);\r\n}\r\nstatic void snd_korg1212_proc_init(struct snd_korg1212 *korg1212)\r\n{\r\nstruct snd_info_entry *entry;\r\nif (! snd_card_proc_new(korg1212->card, "korg1212", &entry))\r\nsnd_info_set_text_ops(entry, korg1212, snd_korg1212_proc_read);\r\n}\r\nstatic int\r\nsnd_korg1212_free(struct snd_korg1212 *korg1212)\r\n{\r\nsnd_korg1212_TurnOffIdleMonitor(korg1212);\r\nif (korg1212->irq >= 0) {\r\nsnd_korg1212_DisableCardInterrupts(korg1212);\r\nfree_irq(korg1212->irq, korg1212);\r\nkorg1212->irq = -1;\r\n}\r\nif (korg1212->iobase != NULL) {\r\niounmap(korg1212->iobase);\r\nkorg1212->iobase = NULL;\r\n}\r\npci_release_regions(korg1212->pci);\r\nif (korg1212->dma_dsp.area) {\r\nsnd_dma_free_pages(&korg1212->dma_dsp);\r\nkorg1212->dma_dsp.area = NULL;\r\n}\r\n#ifndef K1212_LARGEALLOC\r\nif (korg1212->dma_play.area) {\r\nsnd_dma_free_pages(&korg1212->dma_play);\r\nkorg1212->dma_play.area = NULL;\r\n}\r\nif (korg1212->dma_rec.area) {\r\nsnd_dma_free_pages(&korg1212->dma_rec);\r\nkorg1212->dma_rec.area = NULL;\r\n}\r\n#endif\r\nif (korg1212->dma_shared.area) {\r\nsnd_dma_free_pages(&korg1212->dma_shared);\r\nkorg1212->dma_shared.area = NULL;\r\n}\r\npci_disable_device(korg1212->pci);\r\nkfree(korg1212);\r\nreturn 0;\r\n}\r\nstatic int snd_korg1212_dev_free(struct snd_device *device)\r\n{\r\nstruct snd_korg1212 *korg1212 = device->device_data;\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: Freeing device\n");\r\nreturn snd_korg1212_free(korg1212);\r\n}\r\nstatic int snd_korg1212_create(struct snd_card *card, struct pci_dev *pci,\r\nstruct snd_korg1212 **rchip)\r\n{\r\nint err, rc;\r\nunsigned int i;\r\nunsigned ioport_size, iomem_size, iomem2_size;\r\nstruct snd_korg1212 * korg1212;\r\nconst struct firmware *dsp_code;\r\nstatic struct snd_device_ops ops = {\r\n.dev_free = snd_korg1212_dev_free,\r\n};\r\n* rchip = NULL;\r\nif ((err = pci_enable_device(pci)) < 0)\r\nreturn err;\r\nkorg1212 = kzalloc(sizeof(*korg1212), GFP_KERNEL);\r\nif (korg1212 == NULL) {\r\npci_disable_device(pci);\r\nreturn -ENOMEM;\r\n}\r\nkorg1212->card = card;\r\nkorg1212->pci = pci;\r\ninit_waitqueue_head(&korg1212->wait);\r\nspin_lock_init(&korg1212->lock);\r\nmutex_init(&korg1212->open_mutex);\r\ninit_timer(&korg1212->timer);\r\nkorg1212->timer.function = snd_korg1212_timer_func;\r\nkorg1212->timer.data = (unsigned long)korg1212;\r\nkorg1212->irq = -1;\r\nkorg1212->clkSource = K1212_CLKIDX_Local;\r\nkorg1212->clkRate = 44100;\r\nkorg1212->inIRQ = 0;\r\nkorg1212->running = 0;\r\nkorg1212->opencnt = 0;\r\nkorg1212->playcnt = 0;\r\nkorg1212->setcnt = 0;\r\nkorg1212->totalerrorcnt = 0;\r\nkorg1212->playback_pid = -1;\r\nkorg1212->capture_pid = -1;\r\nsnd_korg1212_setCardState(korg1212, K1212_STATE_UNINITIALIZED);\r\nkorg1212->idleMonitorOn = 0;\r\nkorg1212->clkSrcRate = K1212_CLKIDX_LocalAt44_1K;\r\nkorg1212->leftADCInSens = k1212MaxADCSens;\r\nkorg1212->rightADCInSens = k1212MaxADCSens;\r\nfor (i=0; i<kAudioChannels; i++)\r\nkorg1212->volumePhase[i] = 0;\r\nif ((err = pci_request_regions(pci, "korg1212")) < 0) {\r\nkfree(korg1212);\r\npci_disable_device(pci);\r\nreturn err;\r\n}\r\nkorg1212->iomem = pci_resource_start(korg1212->pci, 0);\r\nkorg1212->ioport = pci_resource_start(korg1212->pci, 1);\r\nkorg1212->iomem2 = pci_resource_start(korg1212->pci, 2);\r\niomem_size = pci_resource_len(korg1212->pci, 0);\r\nioport_size = pci_resource_len(korg1212->pci, 1);\r\niomem2_size = pci_resource_len(korg1212->pci, 2);\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: resources:\n"\r\n" iomem = 0x%lx (%d)\n"\r\n" ioport = 0x%lx (%d)\n"\r\n" iomem = 0x%lx (%d)\n"\r\n" [%s]\n",\r\nkorg1212->iomem, iomem_size,\r\nkorg1212->ioport, ioport_size,\r\nkorg1212->iomem2, iomem2_size,\r\nstateName[korg1212->cardState]);\r\nif ((korg1212->iobase = ioremap(korg1212->iomem, iomem_size)) == NULL) {\r\nsnd_printk(KERN_ERR "korg1212: unable to remap memory region 0x%lx-0x%lx\n", korg1212->iomem,\r\nkorg1212->iomem + iomem_size - 1);\r\nsnd_korg1212_free(korg1212);\r\nreturn -EBUSY;\r\n}\r\nerr = request_irq(pci->irq, snd_korg1212_interrupt,\r\nIRQF_SHARED,\r\nKBUILD_MODNAME, korg1212);\r\nif (err) {\r\nsnd_printk(KERN_ERR "korg1212: unable to grab IRQ %d\n", pci->irq);\r\nsnd_korg1212_free(korg1212);\r\nreturn -EBUSY;\r\n}\r\nkorg1212->irq = pci->irq;\r\npci_set_master(korg1212->pci);\r\nkorg1212->statusRegPtr = (u32 __iomem *) (korg1212->iobase + STATUS_REG_OFFSET);\r\nkorg1212->outDoorbellPtr = (u32 __iomem *) (korg1212->iobase + OUT_DOORBELL_OFFSET);\r\nkorg1212->inDoorbellPtr = (u32 __iomem *) (korg1212->iobase + IN_DOORBELL_OFFSET);\r\nkorg1212->mailbox0Ptr = (u32 __iomem *) (korg1212->iobase + MAILBOX0_OFFSET);\r\nkorg1212->mailbox1Ptr = (u32 __iomem *) (korg1212->iobase + MAILBOX1_OFFSET);\r\nkorg1212->mailbox2Ptr = (u32 __iomem *) (korg1212->iobase + MAILBOX2_OFFSET);\r\nkorg1212->mailbox3Ptr = (u32 __iomem *) (korg1212->iobase + MAILBOX3_OFFSET);\r\nkorg1212->controlRegPtr = (u32 __iomem *) (korg1212->iobase + PCI_CONTROL_OFFSET);\r\nkorg1212->sensRegPtr = (u16 __iomem *) (korg1212->iobase + SENS_CONTROL_OFFSET);\r\nkorg1212->idRegPtr = (u32 __iomem *) (korg1212->iobase + DEV_VEND_ID_OFFSET);\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: card registers:\n"\r\n" Status register = 0x%p\n"\r\n" OutDoorbell = 0x%p\n"\r\n" InDoorbell = 0x%p\n"\r\n" Mailbox0 = 0x%p\n"\r\n" Mailbox1 = 0x%p\n"\r\n" Mailbox2 = 0x%p\n"\r\n" Mailbox3 = 0x%p\n"\r\n" ControlReg = 0x%p\n"\r\n" SensReg = 0x%p\n"\r\n" IDReg = 0x%p\n"\r\n" [%s]\n",\r\nkorg1212->statusRegPtr,\r\nkorg1212->outDoorbellPtr,\r\nkorg1212->inDoorbellPtr,\r\nkorg1212->mailbox0Ptr,\r\nkorg1212->mailbox1Ptr,\r\nkorg1212->mailbox2Ptr,\r\nkorg1212->mailbox3Ptr,\r\nkorg1212->controlRegPtr,\r\nkorg1212->sensRegPtr,\r\nkorg1212->idRegPtr,\r\nstateName[korg1212->cardState]);\r\nif (snd_dma_alloc_pages(SNDRV_DMA_TYPE_DEV, snd_dma_pci_data(pci),\r\nsizeof(struct KorgSharedBuffer), &korg1212->dma_shared) < 0) {\r\nsnd_printk(KERN_ERR "korg1212: can not allocate shared buffer memory (%Zd bytes)\n", sizeof(struct KorgSharedBuffer));\r\nsnd_korg1212_free(korg1212);\r\nreturn -ENOMEM;\r\n}\r\nkorg1212->sharedBufferPtr = (struct KorgSharedBuffer *)korg1212->dma_shared.area;\r\nkorg1212->sharedBufferPhy = korg1212->dma_shared.addr;\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: Shared Buffer Area = 0x%p (0x%08lx), %d bytes\n", korg1212->sharedBufferPtr, korg1212->sharedBufferPhy, sizeof(struct KorgSharedBuffer));\r\n#ifndef K1212_LARGEALLOC\r\nkorg1212->DataBufsSize = sizeof(struct KorgAudioBuffer) * kNumBuffers;\r\nif (snd_dma_alloc_pages(SNDRV_DMA_TYPE_DEV, snd_dma_pci_data(pci),\r\nkorg1212->DataBufsSize, &korg1212->dma_play) < 0) {\r\nsnd_printk(KERN_ERR "korg1212: can not allocate play data buffer memory (%d bytes)\n", korg1212->DataBufsSize);\r\nsnd_korg1212_free(korg1212);\r\nreturn -ENOMEM;\r\n}\r\nkorg1212->playDataBufsPtr = (struct KorgAudioBuffer *)korg1212->dma_play.area;\r\nkorg1212->PlayDataPhy = korg1212->dma_play.addr;\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: Play Data Area = 0x%p (0x%08x), %d bytes\n",\r\nkorg1212->playDataBufsPtr, korg1212->PlayDataPhy, korg1212->DataBufsSize);\r\nif (snd_dma_alloc_pages(SNDRV_DMA_TYPE_DEV, snd_dma_pci_data(pci),\r\nkorg1212->DataBufsSize, &korg1212->dma_rec) < 0) {\r\nsnd_printk(KERN_ERR "korg1212: can not allocate record data buffer memory (%d bytes)\n", korg1212->DataBufsSize);\r\nsnd_korg1212_free(korg1212);\r\nreturn -ENOMEM;\r\n}\r\nkorg1212->recordDataBufsPtr = (struct KorgAudioBuffer *)korg1212->dma_rec.area;\r\nkorg1212->RecDataPhy = korg1212->dma_rec.addr;\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: Record Data Area = 0x%p (0x%08x), %d bytes\n",\r\nkorg1212->recordDataBufsPtr, korg1212->RecDataPhy, korg1212->DataBufsSize);\r\n#else\r\nkorg1212->recordDataBufsPtr = korg1212->sharedBufferPtr->recordDataBufs;\r\nkorg1212->playDataBufsPtr = korg1212->sharedBufferPtr->playDataBufs;\r\nkorg1212->PlayDataPhy = (u32) &((struct KorgSharedBuffer *) korg1212->sharedBufferPhy)->playDataBufs;\r\nkorg1212->RecDataPhy = (u32) &((struct KorgSharedBuffer *) korg1212->sharedBufferPhy)->recordDataBufs;\r\n#endif\r\nkorg1212->VolumeTablePhy = korg1212->sharedBufferPhy +\r\noffsetof(struct KorgSharedBuffer, volumeData);\r\nkorg1212->RoutingTablePhy = korg1212->sharedBufferPhy +\r\noffsetof(struct KorgSharedBuffer, routeData);\r\nkorg1212->AdatTimeCodePhy = korg1212->sharedBufferPhy +\r\noffsetof(struct KorgSharedBuffer, AdatTimeCode);\r\nerr = request_firmware(&dsp_code, "korg/k1212.dsp", &pci->dev);\r\nif (err < 0) {\r\nrelease_firmware(dsp_code);\r\nsnd_printk(KERN_ERR "firmware not available\n");\r\nsnd_korg1212_free(korg1212);\r\nreturn err;\r\n}\r\nif (snd_dma_alloc_pages(SNDRV_DMA_TYPE_DEV, snd_dma_pci_data(pci),\r\ndsp_code->size, &korg1212->dma_dsp) < 0) {\r\nsnd_printk(KERN_ERR "korg1212: cannot allocate dsp code memory (%zd bytes)\n", dsp_code->size);\r\nsnd_korg1212_free(korg1212);\r\nrelease_firmware(dsp_code);\r\nreturn -ENOMEM;\r\n}\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: DSP Code area = 0x%p (0x%08x) %d bytes [%s]\n",\r\nkorg1212->dma_dsp.area, korg1212->dma_dsp.addr, dsp_code->size,\r\nstateName[korg1212->cardState]);\r\nmemcpy(korg1212->dma_dsp.area, dsp_code->data, dsp_code->size);\r\nrelease_firmware(dsp_code);\r\nrc = snd_korg1212_Send1212Command(korg1212, K1212_DB_RebootCard, 0, 0, 0, 0);\r\nif (rc)\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: Reboot Card - RC = %d [%s]\n", rc, stateName[korg1212->cardState]);\r\nif ((err = snd_device_new(card, SNDRV_DEV_LOWLEVEL, korg1212, &ops)) < 0) {\r\nsnd_korg1212_free(korg1212);\r\nreturn err;\r\n}\r\nsnd_korg1212_EnableCardInterrupts(korg1212);\r\nmdelay(CARD_BOOT_DELAY_IN_MS);\r\nif (snd_korg1212_downloadDSPCode(korg1212))\r\nreturn -EBUSY;\r\nK1212_DEBUG_PRINTK("korg1212: dspMemPhy = %08x U[%08x], "\r\n"PlayDataPhy = %08x L[%08x]\n"\r\n"korg1212: RecDataPhy = %08x L[%08x], "\r\n"VolumeTablePhy = %08x L[%08x]\n"\r\n"korg1212: RoutingTablePhy = %08x L[%08x], "\r\n"AdatTimeCodePhy = %08x L[%08x]\n",\r\n(int)korg1212->dma_dsp.addr, UpperWordSwap(korg1212->dma_dsp.addr),\r\nkorg1212->PlayDataPhy, LowerWordSwap(korg1212->PlayDataPhy),\r\nkorg1212->RecDataPhy, LowerWordSwap(korg1212->RecDataPhy),\r\nkorg1212->VolumeTablePhy, LowerWordSwap(korg1212->VolumeTablePhy),\r\nkorg1212->RoutingTablePhy, LowerWordSwap(korg1212->RoutingTablePhy),\r\nkorg1212->AdatTimeCodePhy, LowerWordSwap(korg1212->AdatTimeCodePhy));\r\nif ((err = snd_pcm_new(korg1212->card, "korg1212", 0, 1, 1, &korg1212->pcm)) < 0)\r\nreturn err;\r\nkorg1212->pcm->private_data = korg1212;\r\nkorg1212->pcm->private_free = snd_korg1212_free_pcm;\r\nstrcpy(korg1212->pcm->name, "korg1212");\r\nsnd_pcm_set_ops(korg1212->pcm, SNDRV_PCM_STREAM_PLAYBACK, &snd_korg1212_playback_ops);\r\nsnd_pcm_set_ops(korg1212->pcm, SNDRV_PCM_STREAM_CAPTURE, &snd_korg1212_capture_ops);\r\nkorg1212->pcm->info_flags = SNDRV_PCM_INFO_JOINT_DUPLEX;\r\nfor (i = 0; i < ARRAY_SIZE(snd_korg1212_controls); i++) {\r\nerr = snd_ctl_add(korg1212->card, snd_ctl_new1(&snd_korg1212_controls[i], korg1212));\r\nif (err < 0)\r\nreturn err;\r\n}\r\nsnd_korg1212_proc_init(korg1212);\r\nsnd_card_set_dev(card, &pci->dev);\r\n* rchip = korg1212;\r\nreturn 0;\r\n}\r\nstatic int\r\nsnd_korg1212_probe(struct pci_dev *pci,\r\nconst struct pci_device_id *pci_id)\r\n{\r\nstatic int dev;\r\nstruct snd_korg1212 *korg1212;\r\nstruct snd_card *card;\r\nint err;\r\nif (dev >= SNDRV_CARDS) {\r\nreturn -ENODEV;\r\n}\r\nif (!enable[dev]) {\r\ndev++;\r\nreturn -ENOENT;\r\n}\r\nerr = snd_card_create(index[dev], id[dev], THIS_MODULE, 0, &card);\r\nif (err < 0)\r\nreturn err;\r\nif ((err = snd_korg1212_create(card, pci, &korg1212)) < 0) {\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\nstrcpy(card->driver, "korg1212");\r\nstrcpy(card->shortname, "korg1212");\r\nsprintf(card->longname, "%s at 0x%lx, irq %d", card->shortname,\r\nkorg1212->iomem, korg1212->irq);\r\nK1212_DEBUG_PRINTK("K1212_DEBUG: %s\n", card->longname);\r\nif ((err = snd_card_register(card)) < 0) {\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\npci_set_drvdata(pci, card);\r\ndev++;\r\nreturn 0;\r\n}\r\nstatic void snd_korg1212_remove(struct pci_dev *pci)\r\n{\r\nsnd_card_free(pci_get_drvdata(pci));\r\npci_set_drvdata(pci, NULL);\r\n}

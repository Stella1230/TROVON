int dvb_filter_get_ac3info(u8 *mbuf, int count, struct dvb_audio_info *ai, int pr)\r\n{\r\nu8 *headr;\r\nint found = 0;\r\nint c = 0;\r\nu8 frame = 0;\r\nint fr = 0;\r\nwhile ( !found && c < count){\r\nu8 *b = mbuf+c;\r\nif ( b[0] == 0x0b && b[1] == 0x77 )\r\nfound = 1;\r\nelse {\r\nc++;\r\n}\r\n}\r\nif (!found) return -1;\r\nif (pr)\r\nprintk("Audiostream: AC3");\r\nai->off = c;\r\nif (c+5 >= count) return -1;\r\nai->layer = 0;\r\nheadr = mbuf+c+2;\r\nframe = (headr[2]&0x3f);\r\nai->bit_rate = ac3_bitrates[frame >> 1]*1000;\r\nif (pr)\r\nprintk(" BRate: %d kb/s", (int) ai->bit_rate/1000);\r\nai->frequency = (headr[2] & 0xc0 ) >> 6;\r\nfr = (headr[2] & 0xc0 ) >> 6;\r\nai->frequency = freq[fr]*100;\r\nif (pr) printk (" Freq: %d Hz\n", (int) ai->frequency);\r\nai->framesize = ac3_frames[fr][frame >> 1];\r\nif ((frame & 1) && (fr == 1)) ai->framesize++;\r\nai->framesize = ai->framesize << 1;\r\nif (pr) printk (" Framesize %d\n",(int) ai->framesize);\r\nreturn 0;\r\n}\r\nvoid dvb_filter_pes2ts_init(struct dvb_filter_pes2ts *p2ts, unsigned short pid,\r\ndvb_filter_pes2ts_cb_t *cb, void *priv)\r\n{\r\nunsigned char *buf=p2ts->buf;\r\nbuf[0]=0x47;\r\nbuf[1]=(pid>>8);\r\nbuf[2]=pid&0xff;\r\np2ts->cc=0;\r\np2ts->cb=cb;\r\np2ts->priv=priv;\r\n}\r\nint dvb_filter_pes2ts(struct dvb_filter_pes2ts *p2ts, unsigned char *pes,\r\nint len, int payload_start)\r\n{\r\nunsigned char *buf=p2ts->buf;\r\nint ret=0, rest;\r\nif (payload_start)\r\nbuf[1]|=0x40;\r\nelse\r\nbuf[1]&=~0x40;\r\nwhile (len>=184) {\r\nbuf[3]=0x10|((p2ts->cc++)&0x0f);\r\nmemcpy(buf+4, pes, 184);\r\nif ((ret=p2ts->cb(p2ts->priv, buf)))\r\nreturn ret;\r\nlen-=184; pes+=184;\r\nbuf[1]&=~0x40;\r\n}\r\nif (!len)\r\nreturn 0;\r\nbuf[3]=0x30|((p2ts->cc++)&0x0f);\r\nrest=183-len;\r\nif (rest) {\r\nbuf[5]=0x00;\r\nif (rest-1)\r\nmemset(buf+6, 0xff, rest-1);\r\n}\r\nbuf[4]=rest;\r\nmemcpy(buf+5+rest, pes, len);\r\nreturn p2ts->cb(p2ts->priv, buf);\r\n}

void rds_iw_ring_init(struct rds_iw_work_ring *ring, u32 nr)\r\n{\r\nmemset(ring, 0, sizeof(*ring));\r\nring->w_nr = nr;\r\nrdsdebug("ring %p nr %u\n", ring, ring->w_nr);\r\n}\r\nstatic inline u32 __rds_iw_ring_used(struct rds_iw_work_ring *ring)\r\n{\r\nu32 diff;\r\ndiff = ring->w_alloc_ctr - (u32) atomic_read(&ring->w_free_ctr);\r\nBUG_ON(diff > ring->w_nr);\r\nreturn diff;\r\n}\r\nvoid rds_iw_ring_resize(struct rds_iw_work_ring *ring, u32 nr)\r\n{\r\nBUG_ON(__rds_iw_ring_used(ring));\r\nring->w_nr = nr;\r\n}\r\nstatic int __rds_iw_ring_empty(struct rds_iw_work_ring *ring)\r\n{\r\nreturn __rds_iw_ring_used(ring) == 0;\r\n}\r\nu32 rds_iw_ring_alloc(struct rds_iw_work_ring *ring, u32 val, u32 *pos)\r\n{\r\nu32 ret = 0, avail;\r\navail = ring->w_nr - __rds_iw_ring_used(ring);\r\nrdsdebug("ring %p val %u next %u free %u\n", ring, val,\r\nring->w_alloc_ptr, avail);\r\nif (val && avail) {\r\nret = min(val, avail);\r\n*pos = ring->w_alloc_ptr;\r\nring->w_alloc_ptr = (ring->w_alloc_ptr + ret) % ring->w_nr;\r\nring->w_alloc_ctr += ret;\r\n}\r\nreturn ret;\r\n}\r\nvoid rds_iw_ring_free(struct rds_iw_work_ring *ring, u32 val)\r\n{\r\nring->w_free_ptr = (ring->w_free_ptr + val) % ring->w_nr;\r\natomic_add(val, &ring->w_free_ctr);\r\nif (__rds_iw_ring_empty(ring) &&\r\nwaitqueue_active(&rds_iw_ring_empty_wait))\r\nwake_up(&rds_iw_ring_empty_wait);\r\n}\r\nvoid rds_iw_ring_unalloc(struct rds_iw_work_ring *ring, u32 val)\r\n{\r\nring->w_alloc_ptr = (ring->w_alloc_ptr - val) % ring->w_nr;\r\nring->w_alloc_ctr -= val;\r\n}\r\nint rds_iw_ring_empty(struct rds_iw_work_ring *ring)\r\n{\r\nreturn __rds_iw_ring_empty(ring);\r\n}\r\nint rds_iw_ring_low(struct rds_iw_work_ring *ring)\r\n{\r\nreturn __rds_iw_ring_used(ring) <= (ring->w_nr >> 1);\r\n}\r\nu32 rds_iw_ring_oldest(struct rds_iw_work_ring *ring)\r\n{\r\nreturn ring->w_free_ptr;\r\n}\r\nu32 rds_iw_ring_completed(struct rds_iw_work_ring *ring, u32 wr_id, u32 oldest)\r\n{\r\nu32 ret;\r\nif (oldest <= (unsigned long long)wr_id)\r\nret = (unsigned long long)wr_id - oldest + 1;\r\nelse\r\nret = ring->w_nr - oldest + (unsigned long long)wr_id + 1;\r\nrdsdebug("ring %p ret %u wr_id %u oldest %u\n", ring, ret,\r\nwr_id, oldest);\r\nreturn ret;\r\n}

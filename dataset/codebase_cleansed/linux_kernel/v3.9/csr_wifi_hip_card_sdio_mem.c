static CsrResult retrying_read8(card_t *card, s16 funcnum, u32 addr, u8 *pdata)\r\n{\r\nCsrSdioFunction *sdio = card->sdio_if;\r\nCsrResult r = CSR_RESULT_SUCCESS;\r\ns16 retries;\r\nCsrResult csrResult = CSR_RESULT_SUCCESS;\r\nretries = 0;\r\nwhile (retries++ < SDIO_RETRIES)\r\n{\r\nif (funcnum == 0)\r\n{\r\n#if defined (CSR_WIFI_HIP_DEBUG_OFFLINE) && defined (CSR_WIFI_HIP_SDIO_TRACE)\r\nunifi_debug_log_to_buf("r0@%02X", addr);\r\n#endif\r\ncsrResult = CsrSdioF0Read8(sdio, addr, pdata);\r\n}\r\nelse\r\n{\r\n#ifdef CSR_WIFI_TRANSPORT_CSPI\r\nunifi_error(card->ospriv,\r\n"retrying_read_f0_8: F1 8-bit reads are not allowed.\n");\r\nreturn CSR_RESULT_FAILURE;\r\n#else\r\n#if defined (CSR_WIFI_HIP_DEBUG_OFFLINE) && defined (CSR_WIFI_HIP_SDIO_TRACE)\r\nunifi_debug_log_to_buf("r@%02X", addr);\r\n#endif\r\ncsrResult = CsrSdioRead8(sdio, addr, pdata);\r\n#endif\r\n}\r\n#if defined (CSR_WIFI_HIP_DEBUG_OFFLINE) && defined (CSR_WIFI_HIP_SDIO_TRACE)\r\nif (csrResult != CSR_RESULT_SUCCESS)\r\n{\r\nunifi_debug_log_to_buf("error=%X\n", csrResult);\r\n}\r\nelse\r\n{\r\nunifi_debug_log_to_buf("=%X\n", *pdata);\r\n}\r\n#endif\r\nif (csrResult == CSR_SDIO_RESULT_NO_DEVICE)\r\n{\r\nreturn CSR_WIFI_HIP_RESULT_NO_DEVICE;\r\n}\r\nif (!retryable_sdio_error(csrResult))\r\n{\r\n#ifdef CSR_WIFI_HIP_DATA_PLANE_PROFILE\r\ncard->cmd_prof.cmd52_count++;\r\n#endif\r\nbreak;\r\n}\r\nunifi_trace(card->ospriv, UDBG2, "retryable SDIO error reading F%d 0x%lX\n", funcnum, addr);\r\n}\r\nif ((csrResult == CSR_RESULT_SUCCESS) && (retries > 1))\r\n{\r\nunifi_warning(card->ospriv, "Read succeeded after %d attempts\n", retries);\r\n}\r\nif (csrResult != CSR_RESULT_SUCCESS)\r\n{\r\nunifi_error(card->ospriv, "Failed to read from UniFi (addr 0x%lX) after %d tries\n",\r\naddr, retries - 1);\r\nr = CSR_RESULT_FAILURE;\r\n}\r\nreturn r;\r\n}\r\nstatic CsrResult retrying_write8(card_t *card, s16 funcnum, u32 addr, u8 data)\r\n{\r\nCsrSdioFunction *sdio = card->sdio_if;\r\nCsrResult r = CSR_RESULT_SUCCESS;\r\ns16 retries;\r\nCsrResult csrResult = CSR_RESULT_SUCCESS;\r\nretries = 0;\r\nwhile (retries++ < SDIO_RETRIES)\r\n{\r\nif (funcnum == 0)\r\n{\r\n#if defined (CSR_WIFI_HIP_DEBUG_OFFLINE) && defined (CSR_WIFI_HIP_SDIO_TRACE)\r\nunifi_debug_log_to_buf("w0@%02X=%X", addr, data);\r\n#endif\r\ncsrResult = CsrSdioF0Write8(sdio, addr, data);\r\n}\r\nelse\r\n{\r\n#ifdef CSR_WIFI_TRANSPORT_CSPI\r\nunifi_error(card->ospriv,\r\n"retrying_write_f0_8: F1 8-bit writes are not allowed.\n");\r\nreturn CSR_RESULT_FAILURE;\r\n#else\r\n#if defined (CSR_WIFI_HIP_DEBUG_OFFLINE) && defined (CSR_WIFI_HIP_SDIO_TRACE)\r\nunifi_debug_log_to_buf("w@%02X=%X", addr, data);\r\n#endif\r\ncsrResult = CsrSdioWrite8(sdio, addr, data);\r\n#endif\r\n}\r\n#if defined (CSR_WIFI_HIP_DEBUG_OFFLINE) && defined (CSR_WIFI_HIP_SDIO_TRACE)\r\nif (csrResult != CSR_RESULT_SUCCESS)\r\n{\r\nunifi_debug_log_to_buf(",error=%X", csrResult);\r\n}\r\nunifi_debug_string_to_buf("\n");\r\n#endif\r\nif (csrResult == CSR_SDIO_RESULT_NO_DEVICE)\r\n{\r\nreturn CSR_WIFI_HIP_RESULT_NO_DEVICE;\r\n}\r\nif (!retryable_sdio_error(csrResult))\r\n{\r\n#ifdef CSR_WIFI_HIP_DATA_PLANE_PROFILE\r\ncard->cmd_prof.cmd52_count++;\r\n#endif\r\nbreak;\r\n}\r\nunifi_trace(card->ospriv, UDBG2, "retryable SDIO error writing %02X to F%d 0x%lX\n",\r\ndata, funcnum, addr);\r\n}\r\nif ((csrResult == CSR_RESULT_SUCCESS) && (retries > 1))\r\n{\r\nunifi_warning(card->ospriv, "Write succeeded after %d attempts\n", retries);\r\n}\r\nif (csrResult != CSR_RESULT_SUCCESS)\r\n{\r\nunifi_error(card->ospriv, "Failed to write to UniFi (addr 0x%lX) after %d tries\n",\r\naddr, retries - 1);\r\nr = CSR_RESULT_FAILURE;\r\n}\r\nreturn r;\r\n}\r\nstatic CsrResult retrying_read16(card_t *card, s16 funcnum,\r\nu32 addr, u16 *pdata)\r\n{\r\nCsrSdioFunction *sdio = card->sdio_if;\r\nCsrResult r = CSR_RESULT_SUCCESS;\r\ns16 retries;\r\nCsrResult csrResult = CSR_RESULT_SUCCESS;\r\nretries = 0;\r\nwhile (retries++ < SDIO_RETRIES)\r\n{\r\n#if defined (CSR_WIFI_HIP_DEBUG_OFFLINE) && defined (CSR_WIFI_HIP_SDIO_TRACE)\r\nunifi_debug_log_to_buf("r@%02X", addr);\r\n#endif\r\ncsrResult = CsrSdioRead16(sdio, addr, pdata);\r\n#if defined (CSR_WIFI_HIP_DEBUG_OFFLINE) && defined (CSR_WIFI_HIP_SDIO_TRACE)\r\nif (csrResult != CSR_RESULT_SUCCESS)\r\n{\r\nunifi_debug_log_to_buf("error=%X\n", csrResult);\r\n}\r\nelse\r\n{\r\nunifi_debug_log_to_buf("=%X\n", *pdata);\r\n}\r\n#endif\r\nif (csrResult == CSR_SDIO_RESULT_NO_DEVICE)\r\n{\r\nreturn CSR_WIFI_HIP_RESULT_NO_DEVICE;\r\n}\r\nif (!retryable_sdio_error(csrResult))\r\n{\r\n#ifdef CSR_WIFI_HIP_DATA_PLANE_PROFILE\r\ncard->cmd_prof.cmd52_count++;\r\n#endif\r\nbreak;\r\n}\r\nunifi_trace(card->ospriv, UDBG2, "retryable SDIO error reading F%d 0x%lX\n", funcnum, addr);\r\n}\r\nif ((csrResult == CSR_RESULT_SUCCESS) && (retries > 1))\r\n{\r\nunifi_warning(card->ospriv, "Read succeeded after %d attempts\n", retries);\r\n}\r\nif (csrResult != CSR_RESULT_SUCCESS)\r\n{\r\nunifi_error(card->ospriv, "Failed to read from UniFi (addr 0x%lX) after %d tries\n",\r\naddr, retries - 1);\r\nr = CSR_RESULT_FAILURE;\r\n}\r\nreturn r;\r\n}\r\nstatic CsrResult retrying_write16(card_t *card, s16 funcnum,\r\nu32 addr, u16 data)\r\n{\r\nCsrSdioFunction *sdio = card->sdio_if;\r\nCsrResult r = CSR_RESULT_SUCCESS;\r\ns16 retries;\r\nCsrResult csrResult = CSR_RESULT_SUCCESS;\r\nretries = 0;\r\nwhile (retries++ < SDIO_RETRIES)\r\n{\r\n#if defined (CSR_WIFI_HIP_DEBUG_OFFLINE) && defined (CSR_WIFI_HIP_SDIO_TRACE)\r\nunifi_debug_log_to_buf("w@%02X=%X", addr, data);\r\n#endif\r\ncsrResult = CsrSdioWrite16(sdio, addr, data);\r\n#if defined (CSR_WIFI_HIP_DEBUG_OFFLINE) && defined (CSR_WIFI_HIP_SDIO_TRACE)\r\nif (csrResult != CSR_RESULT_SUCCESS)\r\n{\r\nunifi_debug_log_to_buf(",error=%X", csrResult);\r\n}\r\nunifi_debug_string_to_buf("\n");\r\n#endif\r\nif (csrResult == CSR_SDIO_RESULT_NO_DEVICE)\r\n{\r\nreturn CSR_WIFI_HIP_RESULT_NO_DEVICE;\r\n}\r\nif (!retryable_sdio_error(csrResult))\r\n{\r\n#ifdef CSR_WIFI_HIP_DATA_PLANE_PROFILE\r\ncard->cmd_prof.cmd52_count++;\r\n#endif\r\nbreak;\r\n}\r\nunifi_trace(card->ospriv, UDBG2, "retryable SDIO error writing %02X to F%d 0x%lX\n",\r\ndata, funcnum, addr);\r\n}\r\nif ((csrResult == CSR_RESULT_SUCCESS) && (retries > 1))\r\n{\r\nunifi_warning(card->ospriv, "Write succeeded after %d attempts\n", retries);\r\n}\r\nif (csrResult != CSR_RESULT_SUCCESS)\r\n{\r\nunifi_error(card->ospriv, "Failed to write to UniFi (addr 0x%lX) after %d tries\n",\r\naddr, retries - 1);\r\nr = CSR_RESULT_FAILURE;\r\n}\r\nreturn r;\r\n}\r\nCsrResult sdio_read_f0(card_t *card, u32 addr, u8 *pdata)\r\n{\r\n#if defined (CSR_WIFI_HIP_DEBUG_OFFLINE) && defined (CSR_WIFI_HIP_DATA_PLANE_PROFILE)\r\ncard->cmd_prof.cmd52_f0_r_count++;\r\n#endif\r\nreturn retrying_read8(card, 0, addr, pdata);\r\n}\r\nCsrResult sdio_write_f0(card_t *card, u32 addr, u8 data)\r\n{\r\n#if defined (CSR_WIFI_HIP_DEBUG_OFFLINE) && defined (CSR_WIFI_HIP_DATA_PLANE_PROFILE)\r\ncard->cmd_prof.cmd52_f0_w_count++;\r\n#endif\r\nreturn retrying_write8(card, 0, addr, data);\r\n}\r\nCsrResult unifi_read_direct_8_or_16(card_t *card, u32 addr, u8 *pdata)\r\n{\r\n#ifdef CSR_WIFI_TRANSPORT_CSPI\r\nu16 w;\r\nCsrResult r;\r\nr = retrying_read16(card, card->function, addr, &w);\r\n*pdata = (u8)(w & 0xFF);\r\nreturn r;\r\n#else\r\nreturn retrying_read8(card, card->function, addr, pdata);\r\n#endif\r\n}\r\nCsrResult unifi_write_direct_8_or_16(card_t *card, u32 addr, u8 data)\r\n{\r\nif (addr & 1)\r\n{\r\nunifi_warning(card->ospriv,\r\n"Warning: Byte write to an odd address (0x%lX) is dangerous\n",\r\naddr);\r\n}\r\n#ifdef CSR_WIFI_TRANSPORT_CSPI\r\nreturn retrying_write16(card, card->function, addr, (u16)data);\r\n#else\r\nreturn retrying_write8(card, card->function, addr, data);\r\n#endif\r\n}\r\nCsrResult unifi_read_direct16(card_t *card, u32 addr, u16 *pdata)\r\n{\r\nreturn retrying_read16(card, card->function, addr, pdata);\r\n}\r\nCsrResult unifi_write_direct16(card_t *card, u32 addr, u16 data)\r\n{\r\nreturn retrying_write16(card, card->function, addr, data);\r\n}\r\nCsrResult unifi_read_direct32(card_t *card, u32 addr, u32 *pdata)\r\n{\r\nCsrResult r;\r\nu16 w0, w1;\r\nr = retrying_read16(card, card->function, addr, &w0);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nreturn r;\r\n}\r\nr = retrying_read16(card, card->function, addr + 2, &w1);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nreturn r;\r\n}\r\n*pdata = ((u32)w1 << 16) | (u32)w0;\r\nreturn CSR_RESULT_SUCCESS;\r\n}\r\nstatic CsrResult unifi_read_directn_match(card_t *card, u32 addr, void *pdata, u16 len, s8 m, u32 *num)\r\n{\r\nCsrResult r;\r\nu32 i;\r\nu8 *cptr;\r\nu16 w;\r\n*num = 0;\r\ncptr = (u8 *)pdata;\r\nfor (i = 0; i < len; i += 2)\r\n{\r\nr = retrying_read16(card, card->function, addr, &w);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nreturn r;\r\n}\r\n*cptr++ = ((u8)w & 0xFF);\r\nif ((m >= 0) && (((s8)w & 0xFF) == m))\r\n{\r\nbreak;\r\n}\r\nif (i + 1 == len)\r\n{\r\nbreak;\r\n}\r\n*cptr++ = ((u8)(w >> 8) & 0xFF);\r\nif ((m >= 0) && (((s8)(w >> 8) & 0xFF) == m))\r\n{\r\nbreak;\r\n}\r\naddr += 2;\r\n}\r\n*num = (s32)(cptr - (u8 *)pdata);\r\nreturn CSR_RESULT_SUCCESS;\r\n}\r\nCsrResult unifi_read_directn(card_t *card, u32 addr, void *pdata, u16 len)\r\n{\r\nu32 num;\r\nreturn unifi_read_directn_match(card, addr, pdata, len, -1, &num);\r\n}\r\nCsrResult unifi_write_directn(card_t *card, u32 addr, void *pdata, u16 len)\r\n{\r\nCsrResult r;\r\nu8 *cptr;\r\ns16 signed_len;\r\ncptr = (u8 *)pdata;\r\nsigned_len = (s16)len;\r\nwhile (signed_len > 0)\r\n{\r\nr = retrying_write16(card, card->function, addr, *cptr);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nreturn r;\r\n}\r\ncptr += 2;\r\naddr += 2;\r\nsigned_len -= 2;\r\n}\r\nreturn CSR_RESULT_SUCCESS;\r\n}\r\nstatic CsrResult set_dmem_page(card_t *card, u32 dmem_addr, u32 *paddr)\r\n{\r\nu16 page, addr;\r\nu32 len;\r\nCsrResult r;\r\n*paddr = 0;\r\nif (!ChipHelper_DecodeWindow(card->helper,\r\nCHIP_HELPER_WINDOW_3,\r\nCHIP_HELPER_WT_SHARED,\r\ndmem_addr / 2,\r\n&page, &addr, &len))\r\n{\r\nunifi_error(card->ospriv, "Failed to decode SHARED_DMEM_PAGE %08lx\n", dmem_addr);\r\nreturn CSR_WIFI_HIP_RESULT_INVALID_VALUE;\r\n}\r\nif (page != card->dmem_page)\r\n{\r\nunifi_trace(card->ospriv, UDBG6, "setting dmem page=0x%X, addr=0x%lX\n", page, addr);\r\nr = unifi_write_direct16(card, ChipHelper_HOST_WINDOW3_PAGE(card->helper) * 2, page);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nunifi_error(card->ospriv, "Failed to write SHARED_DMEM_PAGE\n");\r\nreturn r;\r\n}\r\ncard->dmem_page = page;\r\n}\r\n*paddr = ((s32)addr * 2) + (dmem_addr & 1);\r\nreturn CSR_RESULT_SUCCESS;\r\n}\r\nstatic CsrResult set_pmem_page(card_t *card, u32 pmem_addr,\r\nenum chip_helper_window_type mem_type, u32 *paddr)\r\n{\r\nu16 page, addr;\r\nu32 len;\r\nCsrResult r;\r\n*paddr = 0;\r\nif (!ChipHelper_DecodeWindow(card->helper,\r\nCHIP_HELPER_WINDOW_2,\r\nmem_type,\r\npmem_addr / 2,\r\n&page, &addr, &len))\r\n{\r\nunifi_error(card->ospriv, "Failed to decode PROG MEM PAGE %08lx %d\n", pmem_addr, mem_type);\r\nreturn CSR_WIFI_HIP_RESULT_INVALID_VALUE;\r\n}\r\nif (page != card->pmem_page)\r\n{\r\nunifi_trace(card->ospriv, UDBG6, "setting pmem page=0x%X, addr=0x%lX\n", page, addr);\r\nr = unifi_write_direct16(card, ChipHelper_HOST_WINDOW2_PAGE(card->helper) * 2, page);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nunifi_error(card->ospriv, "Failed to write PROG MEM PAGE\n");\r\nreturn r;\r\n}\r\ncard->pmem_page = page;\r\n}\r\n*paddr = ((s32)addr * 2) + (pmem_addr & 1);\r\nreturn CSR_RESULT_SUCCESS;\r\n}\r\nstatic CsrResult set_page(card_t *card, u32 generic_addr, u32 *paddr)\r\n{\r\ns32 space;\r\nu32 addr;\r\nCsrResult r = CSR_RESULT_SUCCESS;\r\nif (!paddr)\r\n{\r\nreturn CSR_WIFI_HIP_RESULT_INVALID_VALUE;\r\n}\r\n*paddr = 0;\r\nspace = UNIFI_GP_SPACE(generic_addr);\r\naddr = UNIFI_GP_OFFSET(generic_addr);\r\nswitch (space)\r\n{\r\ncase UNIFI_SH_DMEM:\r\nr = set_dmem_page(card, addr, paddr);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nreturn r;\r\n}\r\nbreak;\r\ncase UNIFI_EXT_FLASH:\r\nif (!ChipHelper_HasFlash(card->helper))\r\n{\r\nunifi_error(card->ospriv, "Bad address space for chip in generic pointer 0x%08lX (helper=0x%x)\n",\r\ngeneric_addr, card->helper);\r\nreturn CSR_WIFI_HIP_RESULT_INVALID_VALUE;\r\n}\r\nr = set_pmem_page(card, addr, CHIP_HELPER_WT_FLASH, paddr);\r\nbreak;\r\ncase UNIFI_EXT_SRAM:\r\nif (!ChipHelper_HasExtSram(card->helper))\r\n{\r\nunifi_error(card->ospriv, "Bad address space for chip in generic pointer 0x%08l (helper=0x%x)\n",\r\ngeneric_addr, card->helper);\r\nreturn CSR_WIFI_HIP_RESULT_INVALID_VALUE;\r\n}\r\nr = set_pmem_page(card, addr, CHIP_HELPER_WT_EXT_SRAM, paddr);\r\nbreak;\r\ncase UNIFI_REGISTERS:\r\n*paddr = addr;\r\nbreak;\r\ncase UNIFI_PHY_DMEM:\r\nr = unifi_set_proc_select(card, UNIFI_PROC_PHY);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nreturn r;\r\n}\r\n*paddr = ChipHelper_DATA_MEMORY_RAM_OFFSET(card->helper) * 2 + addr;\r\nbreak;\r\ncase UNIFI_MAC_DMEM:\r\nr = unifi_set_proc_select(card, UNIFI_PROC_MAC);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nreturn r;\r\n}\r\n*paddr = ChipHelper_DATA_MEMORY_RAM_OFFSET(card->helper) * 2 + addr;\r\nbreak;\r\ncase UNIFI_BT_DMEM:\r\nif (!ChipHelper_HasBt(card->helper))\r\n{\r\nunifi_error(card->ospriv, "Bad address space for chip in generic pointer 0x%08lX (helper=0x%x)\n",\r\ngeneric_addr, card->helper);\r\nreturn CSR_WIFI_HIP_RESULT_INVALID_VALUE;\r\n}\r\nr = unifi_set_proc_select(card, UNIFI_PROC_BT);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nreturn r;\r\n}\r\n*paddr = ChipHelper_DATA_MEMORY_RAM_OFFSET(card->helper) * 2 + addr;\r\nbreak;\r\ncase UNIFI_PHY_PMEM:\r\nr = unifi_set_proc_select(card, UNIFI_PROC_PHY);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nreturn r;\r\n}\r\nr = set_pmem_page(card, addr, CHIP_HELPER_WT_CODE_RAM, paddr);\r\nbreak;\r\ncase UNIFI_MAC_PMEM:\r\nr = unifi_set_proc_select(card, UNIFI_PROC_MAC);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nreturn r;\r\n}\r\nr = set_pmem_page(card, addr, CHIP_HELPER_WT_CODE_RAM, paddr);\r\nbreak;\r\ncase UNIFI_BT_PMEM:\r\nif (!ChipHelper_HasBt(card->helper))\r\n{\r\nunifi_error(card->ospriv, "Bad address space for chip in generic pointer 0x%08lX (helper=0x%x)\n",\r\ngeneric_addr, card->helper);\r\nreturn CSR_WIFI_HIP_RESULT_INVALID_VALUE;\r\n}\r\nr = unifi_set_proc_select(card, UNIFI_PROC_BT);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nreturn r;\r\n}\r\nr = set_pmem_page(card, addr, CHIP_HELPER_WT_CODE_RAM, paddr);\r\nbreak;\r\ncase UNIFI_PHY_ROM:\r\nif (!ChipHelper_HasRom(card->helper))\r\n{\r\nunifi_error(card->ospriv, "Bad address space for chip in generic pointer 0x%08lX (helper=0x%x)\n",\r\ngeneric_addr, card->helper);\r\nreturn CSR_WIFI_HIP_RESULT_INVALID_VALUE;\r\n}\r\nr = unifi_set_proc_select(card, UNIFI_PROC_PHY);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nreturn r;\r\n}\r\nr = set_pmem_page(card, addr, CHIP_HELPER_WT_ROM, paddr);\r\nbreak;\r\ncase UNIFI_MAC_ROM:\r\nif (!ChipHelper_HasRom(card->helper))\r\n{\r\nunifi_error(card->ospriv, "Bad address space for chip in generic pointer 0x%08lX (helper=0x%x)\n",\r\ngeneric_addr, card->helper);\r\nreturn CSR_WIFI_HIP_RESULT_INVALID_VALUE;\r\n}\r\nr = unifi_set_proc_select(card, UNIFI_PROC_MAC);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nreturn r;\r\n}\r\nr = set_pmem_page(card, addr, CHIP_HELPER_WT_ROM, paddr);\r\nbreak;\r\ncase UNIFI_BT_ROM:\r\nif (!ChipHelper_HasRom(card->helper) || !ChipHelper_HasBt(card->helper))\r\n{\r\nunifi_error(card->ospriv, "Bad address space for chip in generic pointer 0x%08lX (helper=0x%x)\n",\r\ngeneric_addr, card->helper);\r\nreturn CSR_WIFI_HIP_RESULT_INVALID_VALUE;\r\n}\r\nr = unifi_set_proc_select(card, UNIFI_PROC_BT);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nreturn r;\r\n}\r\nr = set_pmem_page(card, addr, CHIP_HELPER_WT_ROM, paddr);\r\nbreak;\r\ndefault:\r\nunifi_error(card->ospriv, "Bad address space %d in generic pointer 0x%08lX (helper=0x%x)\n",\r\nspace, generic_addr, card->helper);\r\nreturn CSR_WIFI_HIP_RESULT_INVALID_VALUE;\r\n}\r\nreturn r;\r\n}\r\nCsrResult unifi_set_proc_select(card_t *card, enum unifi_dbg_processors_select select)\r\n{\r\nCsrResult r;\r\nswitch (select)\r\n{\r\ncase UNIFI_PROC_MAC:\r\ncase UNIFI_PROC_PHY:\r\ncase UNIFI_PROC_BOTH:\r\nbreak;\r\ndefault:\r\nreturn CSR_WIFI_HIP_RESULT_INVALID_VALUE;\r\n}\r\nif (card->proc_select != (u32)select)\r\n{\r\nr = unifi_write_direct16(card,\r\nChipHelper_DBG_HOST_PROC_SELECT(card->helper) * 2,\r\n(u8)select);\r\nif (r == CSR_WIFI_HIP_RESULT_NO_DEVICE)\r\n{\r\nreturn r;\r\n}\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nunifi_error(card->ospriv, "Failed to write to Proc Select register\n");\r\nreturn r;\r\n}\r\ncard->proc_select = (u32)select;\r\n}\r\nreturn CSR_RESULT_SUCCESS;\r\n}\r\nCsrResult unifi_read_8_or_16(card_t *card, u32 unifi_addr, u8 *pdata)\r\n{\r\nu32 sdio_addr;\r\nCsrResult r;\r\n#ifdef CSR_WIFI_TRANSPORT_CSPI\r\nu16 w;\r\n#endif\r\nr = set_page(card, unifi_addr, &sdio_addr);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nreturn r;\r\n}\r\n#if defined (CSR_WIFI_HIP_DEBUG_OFFLINE) && defined (CSR_WIFI_HIP_DATA_PLANE_PROFILE)\r\ncard->cmd_prof.cmd52_r8or16_count++;\r\n#endif\r\n#ifdef CSR_WIFI_TRANSPORT_CSPI\r\nr = retrying_read16(card, card->function, sdio_addr, &w);\r\n*pdata = (u8)(w & 0xFF);\r\nreturn r;\r\n#else\r\nreturn retrying_read8(card, card->function, sdio_addr, pdata);\r\n#endif\r\n}\r\nCsrResult unifi_write_8_or_16(card_t *card, u32 unifi_addr, u8 data)\r\n{\r\nu32 sdio_addr;\r\nCsrResult r;\r\n#ifdef CSR_WIFI_TRANSPORT_CSPI\r\nu16 w;\r\n#endif\r\nr = set_page(card, unifi_addr, &sdio_addr);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nreturn r;\r\n}\r\nif (sdio_addr & 1)\r\n{\r\nunifi_warning(card->ospriv,\r\n"Warning: Byte write to an odd address (0x%lX) is dangerous\n",\r\nsdio_addr);\r\n}\r\n#if defined (CSR_WIFI_HIP_DEBUG_OFFLINE) && defined (CSR_WIFI_HIP_DATA_PLANE_PROFILE)\r\ncard->cmd_prof.cmd52_w8or16_count++;\r\n#endif\r\n#ifdef CSR_WIFI_TRANSPORT_CSPI\r\nw = data;\r\nreturn retrying_write16(card, card->function, sdio_addr, w);\r\n#else\r\nreturn retrying_write8(card, card->function, sdio_addr, data);\r\n#endif\r\n}\r\nCsrResult unifi_card_read16(card_t *card, u32 unifi_addr, u16 *pdata)\r\n{\r\nu32 sdio_addr;\r\nCsrResult r;\r\nr = set_page(card, unifi_addr, &sdio_addr);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nreturn r;\r\n}\r\n#if defined (CSR_WIFI_HIP_DEBUG_OFFLINE) && defined (CSR_WIFI_HIP_DATA_PLANE_PROFILE)\r\ncard->cmd_prof.cmd52_r16_count++;\r\n#endif\r\nreturn unifi_read_direct16(card, sdio_addr, pdata);\r\n}\r\nCsrResult unifi_card_write16(card_t *card, u32 unifi_addr, u16 data)\r\n{\r\nu32 sdio_addr;\r\nCsrResult r;\r\nr = set_page(card, unifi_addr, &sdio_addr);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nreturn r;\r\n}\r\n#if defined (CSR_WIFI_HIP_DEBUG_OFFLINE) && defined (CSR_WIFI_HIP_DATA_PLANE_PROFILE)\r\ncard->cmd_prof.cmd52_w16_count++;\r\n#endif\r\nreturn unifi_write_direct16(card, sdio_addr, data);\r\n}\r\nCsrResult unifi_read32(card_t *card, u32 unifi_addr, u32 *pdata)\r\n{\r\nu32 sdio_addr;\r\nCsrResult r;\r\nr = set_page(card, unifi_addr, &sdio_addr);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nreturn r;\r\n}\r\n#if defined (CSR_WIFI_HIP_DEBUG_OFFLINE) && defined (CSR_WIFI_HIP_DATA_PLANE_PROFILE)\r\ncard->cmd_prof.cmd52_r32_count++;\r\n#endif\r\nreturn unifi_read_direct32(card, sdio_addr, pdata);\r\n}\r\nCsrResult unifi_readn_match(card_t *card, u32 unifi_addr, void *pdata, u16 len, s8 match)\r\n{\r\nu32 sdio_addr;\r\nCsrResult r;\r\nu32 num;\r\nr = set_page(card, unifi_addr, &sdio_addr);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nreturn r;\r\n}\r\nr = unifi_read_directn_match(card, sdio_addr, pdata, len, match, &num);\r\nreturn r;\r\n}\r\nCsrResult unifi_card_readn(card_t *card, u32 unifi_addr, void *pdata, u16 len)\r\n{\r\nreturn unifi_readn_match(card, unifi_addr, pdata, len, -1);\r\n}\r\nCsrResult unifi_readnz(card_t *card, u32 unifi_addr, void *pdata, u16 len)\r\n{\r\nreturn unifi_readn_match(card, unifi_addr, pdata, len, 0);\r\n}\r\ns32 unifi_read_shared_count(card_t *card, u32 addr)\r\n{\r\nu8 b;\r\n#define SHARED_READ_RETRY_LIMIT 10\r\ns32 i;\r\nfor (i = 0; i < SHARED_READ_RETRY_LIMIT; i++)\r\n{\r\nCsrResult r;\r\nr = unifi_read_8_or_16(card, addr, &b);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nreturn -1;\r\n}\r\nif (!(b & 0x80))\r\n{\r\nreturn (s32)(b & 0xff);\r\n}\r\n}\r\nreturn -1;\r\n}\r\nCsrResult unifi_writen(card_t *card, u32 unifi_addr, void *pdata, u16 len)\r\n{\r\nu32 sdio_addr;\r\nCsrResult r;\r\nr = set_page(card, unifi_addr, &sdio_addr);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nreturn r;\r\n}\r\nreturn unifi_write_directn(card, sdio_addr, pdata, len);\r\n}\r\nstatic CsrResult csr_sdio_block_rw(card_t *card, s16 funcnum,\r\nu32 addr, u8 *pdata,\r\nu16 count, s16 dir_is_write)\r\n{\r\nCsrResult csrResult;\r\nif (dir_is_write == UNIFI_SDIO_READ)\r\n{\r\n#if defined (CSR_WIFI_HIP_DEBUG_OFFLINE) && defined (CSR_WIFI_HIP_SDIO_TRACE)\r\nunifi_debug_log_to_buf("r@%02X#%X=", addr, count);\r\n#endif\r\n#if defined (CSR_WIFI_HIP_DEBUG_OFFLINE) && defined (CSR_WIFI_HIP_DATA_PLANE_PROFILE)\r\nunifi_debug_log_to_buf("R");\r\n#endif\r\ncsrResult = CsrSdioRead(card->sdio_if, addr, pdata, count);\r\n#if defined (CSR_WIFI_HIP_DEBUG_OFFLINE) && defined (CSR_WIFI_HIP_DATA_PLANE_PROFILE)\r\nunifi_debug_log_to_buf("<");\r\n#endif\r\n}\r\nelse\r\n{\r\n#if defined (CSR_WIFI_HIP_DEBUG_OFFLINE) && defined (CSR_WIFI_HIP_SDIO_TRACE)\r\nunifi_debug_log_to_buf("w@%02X#%X=", addr, count);\r\nunifi_debug_hex_to_buf(pdata, count > CSR_WIFI_HIP_SDIO_TRACE_DATA_LENGTH?CSR_WIFI_HIP_SDIO_TRACE_DATA_LENGTH : count);\r\n#endif\r\n#if defined (CSR_WIFI_HIP_DEBUG_OFFLINE) && defined (CSR_WIFI_HIP_DATA_PLANE_PROFILE)\r\nunifi_debug_log_to_buf("W");\r\n#endif\r\ncsrResult = CsrSdioWrite(card->sdio_if, addr, pdata, count);\r\n#if defined (CSR_WIFI_HIP_DEBUG_OFFLINE) && defined (CSR_WIFI_HIP_DATA_PLANE_PROFILE)\r\nunifi_debug_log_to_buf(">");\r\n#endif\r\n}\r\n#ifdef CSR_WIFI_HIP_DATA_PLANE_PROFILE\r\ncard->cmd_prof.cmd53_count++;\r\n#endif\r\n#if defined (CSR_WIFI_HIP_DEBUG_OFFLINE) && defined (CSR_WIFI_HIP_SDIO_TRACE)\r\nif (csrResult != CSR_RESULT_SUCCESS)\r\n{\r\nunifi_debug_log_to_buf("error=%X", csrResult);\r\n}\r\nelse if (dir_is_write == UNIFI_SDIO_READ)\r\n{\r\nunifi_debug_hex_to_buf(pdata, count > CSR_WIFI_HIP_SDIO_TRACE_DATA_LENGTH?CSR_WIFI_HIP_SDIO_TRACE_DATA_LENGTH : count);\r\n}\r\nunifi_debug_string_to_buf("\n");\r\n#endif\r\nreturn csrResult;\r\n}\r\nCsrResult unifi_bulk_rw(card_t *card, u32 handle, void *pdata,\r\nu32 len, s16 direction)\r\n{\r\n#define CMD53_RETRIES 3\r\n#define REWIND_RETRIES 15\r\n#define REWIND_POLLING_RETRIES 5\r\n#define REWIND_DELAY 1\r\nCsrResult csrResult;\r\nCsrResult r = CSR_RESULT_SUCCESS;\r\ns16 retries = CMD53_RETRIES;\r\ns16 stat_retries;\r\nu8 stat;\r\ns16 dump_read;\r\n#ifdef UNIFI_DEBUG\r\nu8 *pdata_lsb = ((u8 *)&pdata) + card->lsb;\r\n#endif\r\n#ifdef CSR_WIFI_MAKE_FAKE_CMD53_ERRORS\r\nstatic s16 fake_error;\r\n#endif\r\ndump_read = 0;\r\n#ifdef UNIFI_DEBUG\r\nif (*pdata_lsb & 1)\r\n{\r\nunifi_notice(card->ospriv, "CD53 request on a unaligned buffer (addr: 0x%X) dir %s-Host\n",\r\npdata, (direction == UNIFI_SDIO_READ)?"To" : "From");\r\nif (direction == UNIFI_SDIO_WRITE)\r\n{\r\ndump(pdata, (u16)len);\r\n}\r\nelse\r\n{\r\ndump_read = 1;\r\n}\r\n}\r\n#endif\r\nif (!pdata)\r\n{\r\nunifi_error(card->ospriv, "Null pdata for unifi_bulk_rw() len: %d\n", len);\r\nreturn CSR_WIFI_HIP_RESULT_INVALID_VALUE;\r\n}\r\nif ((len & 1) || (len > 0xffff))\r\n{\r\nunifi_error(card->ospriv, "Impossible CMD53 length requested: %d\n", len);\r\nreturn CSR_WIFI_HIP_RESULT_INVALID_VALUE;\r\n}\r\nwhile (1)\r\n{\r\ncsrResult = csr_sdio_block_rw(card, card->function, handle,\r\n(u8 *)pdata, (u16)len,\r\ndirection);\r\nif (csrResult == CSR_SDIO_RESULT_NO_DEVICE)\r\n{\r\nreturn CSR_WIFI_HIP_RESULT_NO_DEVICE;\r\n}\r\n#ifdef CSR_WIFI_MAKE_FAKE_CMD53_ERRORS\r\nif (++fake_error > 100)\r\n{\r\nfake_error = 90;\r\nunifi_warning(card->ospriv, "Faking a CMD53 error,\n");\r\nif (csrResult == CSR_RESULT_SUCCESS)\r\n{\r\ncsrResult = CSR_RESULT_FAILURE;\r\n}\r\n}\r\n#endif\r\nif (csrResult == CSR_RESULT_SUCCESS)\r\n{\r\nif (dump_read)\r\n{\r\ndump(pdata, (u16)len);\r\n}\r\nbreak;\r\n}\r\nif (card->chip_id <= SDIO_CARD_ID_UNIFI_2)\r\n{\r\n(void)unifi_set_host_state(card, UNIFI_HOST_STATE_AWAKE);\r\n}\r\nif (!retryable_sdio_error(csrResult))\r\n{\r\nunifi_error(card->ospriv, "Fatal error in a CMD53 transfer\n");\r\nbreak;\r\n}\r\nif (--retries == 0)\r\n{\r\nbreak;\r\n}\r\nunifi_trace(card->ospriv, UDBG4,\r\n"Error in a CMD53 transfer, retrying (h:%d,l:%u)...\n",\r\n(s16)handle & 0xff, len);\r\nr = unifi_write_8_or_16(card, card->sdio_ctrl_addr + 8,\r\n(u8)(handle & 0xff));\r\nif (r == CSR_WIFI_HIP_RESULT_NO_DEVICE)\r\n{\r\nreturn r;\r\n}\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nunifi_error(card->ospriv, "Failed to write REWIND cmd\n");\r\nreturn r;\r\n}\r\nr = CardGenInt(card);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nreturn r;\r\n}\r\nstat_retries = REWIND_RETRIES;\r\nwhile (1)\r\n{\r\nr = unifi_read_8_or_16(card, card->sdio_ctrl_addr + 8, &stat);\r\nif (r == CSR_WIFI_HIP_RESULT_NO_DEVICE)\r\n{\r\nreturn r;\r\n}\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nunifi_error(card->ospriv, "Failed to read REWIND status\n");\r\nreturn CSR_RESULT_FAILURE;\r\n}\r\nif (stat == 0)\r\n{\r\nbreak;\r\n}\r\nif (--stat_retries == 0)\r\n{\r\nunifi_error(card->ospriv, "Timeout waiting for REWIND ready\n");\r\nreturn CSR_RESULT_FAILURE;\r\n}\r\nif (stat_retries < REWIND_RETRIES - REWIND_POLLING_RETRIES)\r\n{\r\nCsrThreadSleep(REWIND_DELAY);\r\n}\r\n}\r\n}\r\nif (csrResult != CSR_RESULT_SUCCESS)\r\n{\r\nunifi_error(card->ospriv, "Block %s failed after %d retries\n",\r\n(direction == UNIFI_SDIO_READ)?"read" : "write",\r\nCMD53_RETRIES - retries);\r\nreturn CSR_RESULT_FAILURE;\r\n}\r\nif (direction == UNIFI_SDIO_READ)\r\n{\r\ncard->sdio_bytes_read += len;\r\n}\r\nelse\r\n{\r\ncard->sdio_bytes_written += len;\r\n}\r\nreturn CSR_RESULT_SUCCESS;\r\n}\r\nCsrResult unifi_bulk_rw_noretry(card_t *card, u32 handle, void *pdata,\r\nu32 len, s16 direction)\r\n{\r\nCsrResult csrResult;\r\ncsrResult = csr_sdio_block_rw(card, card->function, handle,\r\n(u8 *)pdata, (u16)len, direction);\r\nif (csrResult != CSR_RESULT_SUCCESS)\r\n{\r\nunifi_error(card->ospriv, "Block %s failed\n",\r\n(direction == UNIFI_SDIO_READ)?"read" : "write");\r\nreturn csrResult;\r\n}\r\nreturn CSR_RESULT_SUCCESS;\r\n}

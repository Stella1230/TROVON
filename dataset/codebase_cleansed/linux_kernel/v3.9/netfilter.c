int ip6_route_me_harder(struct sk_buff *skb)\r\n{\r\nstruct net *net = dev_net(skb_dst(skb)->dev);\r\nconst struct ipv6hdr *iph = ipv6_hdr(skb);\r\nunsigned int hh_len;\r\nstruct dst_entry *dst;\r\nstruct flowi6 fl6 = {\r\n.flowi6_oif = skb->sk ? skb->sk->sk_bound_dev_if : 0,\r\n.flowi6_mark = skb->mark,\r\n.daddr = iph->daddr,\r\n.saddr = iph->saddr,\r\n};\r\ndst = ip6_route_output(net, skb->sk, &fl6);\r\nif (dst->error) {\r\nIP6_INC_STATS(net, ip6_dst_idev(dst), IPSTATS_MIB_OUTNOROUTES);\r\nLIMIT_NETDEBUG(KERN_DEBUG "ip6_route_me_harder: No more route.\n");\r\ndst_release(dst);\r\nreturn -EINVAL;\r\n}\r\nskb_dst_drop(skb);\r\nskb_dst_set(skb, dst);\r\n#ifdef CONFIG_XFRM\r\nif (!(IP6CB(skb)->flags & IP6SKB_XFRM_TRANSFORMED) &&\r\nxfrm_decode_session(skb, flowi6_to_flowi(&fl6), AF_INET6) == 0) {\r\nskb_dst_set(skb, NULL);\r\ndst = xfrm_lookup(net, dst, flowi6_to_flowi(&fl6), skb->sk, 0);\r\nif (IS_ERR(dst))\r\nreturn -1;\r\nskb_dst_set(skb, dst);\r\n}\r\n#endif\r\nhh_len = skb_dst(skb)->dev->hard_header_len;\r\nif (skb_headroom(skb) < hh_len &&\r\npskb_expand_head(skb, HH_DATA_ALIGN(hh_len - skb_headroom(skb)),\r\n0, GFP_ATOMIC))\r\nreturn -1;\r\nreturn 0;\r\n}\r\nstatic void nf_ip6_saveroute(const struct sk_buff *skb,\r\nstruct nf_queue_entry *entry)\r\n{\r\nstruct ip6_rt_info *rt_info = nf_queue_entry_reroute(entry);\r\nif (entry->hook == NF_INET_LOCAL_OUT) {\r\nconst struct ipv6hdr *iph = ipv6_hdr(skb);\r\nrt_info->daddr = iph->daddr;\r\nrt_info->saddr = iph->saddr;\r\nrt_info->mark = skb->mark;\r\n}\r\n}\r\nstatic int nf_ip6_reroute(struct sk_buff *skb,\r\nconst struct nf_queue_entry *entry)\r\n{\r\nstruct ip6_rt_info *rt_info = nf_queue_entry_reroute(entry);\r\nif (entry->hook == NF_INET_LOCAL_OUT) {\r\nconst struct ipv6hdr *iph = ipv6_hdr(skb);\r\nif (!ipv6_addr_equal(&iph->daddr, &rt_info->daddr) ||\r\n!ipv6_addr_equal(&iph->saddr, &rt_info->saddr) ||\r\nskb->mark != rt_info->mark)\r\nreturn ip6_route_me_harder(skb);\r\n}\r\nreturn 0;\r\n}\r\nstatic int nf_ip6_route(struct net *net, struct dst_entry **dst,\r\nstruct flowi *fl, bool strict)\r\n{\r\nstatic const struct ipv6_pinfo fake_pinfo;\r\nstatic const struct inet_sock fake_sk = {\r\n.sk.sk_bound_dev_if = 1,\r\n.pinet6 = (struct ipv6_pinfo *) &fake_pinfo,\r\n};\r\nconst void *sk = strict ? &fake_sk : NULL;\r\nstruct dst_entry *result;\r\nint err;\r\nresult = ip6_route_output(net, sk, &fl->u.ip6);\r\nerr = result->error;\r\nif (err)\r\ndst_release(result);\r\nelse\r\n*dst = result;\r\nreturn err;\r\n}\r\n__sum16 nf_ip6_checksum(struct sk_buff *skb, unsigned int hook,\r\nunsigned int dataoff, u_int8_t protocol)\r\n{\r\nconst struct ipv6hdr *ip6h = ipv6_hdr(skb);\r\n__sum16 csum = 0;\r\nswitch (skb->ip_summed) {\r\ncase CHECKSUM_COMPLETE:\r\nif (hook != NF_INET_PRE_ROUTING && hook != NF_INET_LOCAL_IN)\r\nbreak;\r\nif (!csum_ipv6_magic(&ip6h->saddr, &ip6h->daddr,\r\nskb->len - dataoff, protocol,\r\ncsum_sub(skb->csum,\r\nskb_checksum(skb, 0,\r\ndataoff, 0)))) {\r\nskb->ip_summed = CHECKSUM_UNNECESSARY;\r\nbreak;\r\n}\r\ncase CHECKSUM_NONE:\r\nskb->csum = ~csum_unfold(\r\ncsum_ipv6_magic(&ip6h->saddr, &ip6h->daddr,\r\nskb->len - dataoff,\r\nprotocol,\r\ncsum_sub(0,\r\nskb_checksum(skb, 0,\r\ndataoff, 0))));\r\ncsum = __skb_checksum_complete(skb);\r\n}\r\nreturn csum;\r\n}\r\nstatic __sum16 nf_ip6_checksum_partial(struct sk_buff *skb, unsigned int hook,\r\nunsigned int dataoff, unsigned int len,\r\nu_int8_t protocol)\r\n{\r\nconst struct ipv6hdr *ip6h = ipv6_hdr(skb);\r\n__wsum hsum;\r\n__sum16 csum = 0;\r\nswitch (skb->ip_summed) {\r\ncase CHECKSUM_COMPLETE:\r\nif (len == skb->len - dataoff)\r\nreturn nf_ip6_checksum(skb, hook, dataoff, protocol);\r\ncase CHECKSUM_NONE:\r\nhsum = skb_checksum(skb, 0, dataoff, 0);\r\nskb->csum = ~csum_unfold(csum_ipv6_magic(&ip6h->saddr,\r\n&ip6h->daddr,\r\nskb->len - dataoff,\r\nprotocol,\r\ncsum_sub(0, hsum)));\r\nskb->ip_summed = CHECKSUM_NONE;\r\nreturn __skb_checksum_complete_head(skb, dataoff + len);\r\n}\r\nreturn csum;\r\n}\r\nint __init ipv6_netfilter_init(void)\r\n{\r\nreturn nf_register_afinfo(&nf_ip6_afinfo);\r\n}\r\nvoid ipv6_netfilter_fini(void)\r\n{\r\nnf_unregister_afinfo(&nf_ip6_afinfo);\r\n}

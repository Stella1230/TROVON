static int vprbrd_i2c_status(struct i2c_adapter *i2c,\r\nstruct vprbrd_i2c_status *status, bool prev_error)\r\n{\r\nu16 bytes_xfer;\r\nint ret;\r\nstruct vprbrd *vb = (struct vprbrd *)i2c->algo_data;\r\nbytes_xfer = sizeof(struct vprbrd_i2c_status);\r\nret = usb_control_msg(vb->usb_dev, usb_rcvctrlpipe(vb->usb_dev, 0),\r\nVPRBRD_USB_REQUEST_I2C, VPRBRD_USB_TYPE_IN, 0x0000, 0x0000,\r\nstatus, bytes_xfer, VPRBRD_USB_TIMEOUT_MS);\r\nif (ret != bytes_xfer)\r\nprev_error = true;\r\nif (prev_error) {\r\ndev_err(&i2c->dev, "failure in usb communication\n");\r\nreturn -EREMOTEIO;\r\n}\r\ndev_dbg(&i2c->dev, " status = %d\n", status->status);\r\nif (status->status != 0x00) {\r\ndev_err(&i2c->dev, "failure: i2c protocol error\n");\r\nreturn -EPROTO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int vprbrd_i2c_receive(struct usb_device *usb_dev,\r\nstruct vprbrd_i2c_read_msg *rmsg, int bytes_xfer)\r\n{\r\nint ret, bytes_actual;\r\nint error = 0;\r\nret = usb_bulk_msg(usb_dev,\r\nusb_sndbulkpipe(usb_dev, VPRBRD_EP_OUT), rmsg,\r\nsizeof(struct vprbrd_i2c_read_hdr), &bytes_actual,\r\nVPRBRD_USB_TIMEOUT_MS);\r\nif ((ret < 0)\r\n|| (bytes_actual != sizeof(struct vprbrd_i2c_read_hdr))) {\r\ndev_err(&usb_dev->dev, "failure transmitting usb\n");\r\nerror = -EREMOTEIO;\r\n}\r\nret = usb_bulk_msg(usb_dev,\r\nusb_rcvbulkpipe(usb_dev, VPRBRD_EP_IN), rmsg,\r\nbytes_xfer, &bytes_actual, VPRBRD_USB_TIMEOUT_MS);\r\nif ((ret < 0) || (bytes_xfer != bytes_actual)) {\r\ndev_err(&usb_dev->dev, "failure receiving usb\n");\r\nerror = -EREMOTEIO;\r\n}\r\nreturn error;\r\n}\r\nstatic int vprbrd_i2c_addr(struct usb_device *usb_dev,\r\nstruct vprbrd_i2c_addr_msg *amsg)\r\n{\r\nint ret, bytes_actual;\r\nret = usb_bulk_msg(usb_dev,\r\nusb_sndbulkpipe(usb_dev, VPRBRD_EP_OUT), amsg,\r\nsizeof(struct vprbrd_i2c_addr_msg), &bytes_actual,\r\nVPRBRD_USB_TIMEOUT_MS);\r\nif ((ret < 0) ||\r\n(sizeof(struct vprbrd_i2c_addr_msg) != bytes_actual)) {\r\ndev_err(&usb_dev->dev, "failure transmitting usb\n");\r\nreturn -EREMOTEIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int vprbrd_i2c_read(struct vprbrd *vb, struct i2c_msg *msg)\r\n{\r\nint ret;\r\nu16 remain_len, bytes_xfer, len1, len2,\r\nstart = 0x0000;\r\nstruct vprbrd_i2c_read_msg *rmsg =\r\n(struct vprbrd_i2c_read_msg *)vb->buf;\r\nremain_len = msg->len;\r\nrmsg->header.cmd = VPRBRD_I2C_CMD_READ;\r\nwhile (remain_len > 0) {\r\nrmsg->header.addr = cpu_to_le16(start + 0x4000);\r\nif (remain_len <= 255) {\r\nlen1 = remain_len;\r\nlen2 = 0x00;\r\nrmsg->header.len0 = remain_len;\r\nrmsg->header.len1 = 0x00;\r\nrmsg->header.len2 = 0x00;\r\nrmsg->header.len3 = 0x00;\r\nrmsg->header.len4 = 0x00;\r\nrmsg->header.len5 = 0x00;\r\nremain_len = 0;\r\n} else if (remain_len <= 510) {\r\nlen1 = remain_len;\r\nlen2 = 0x00;\r\nrmsg->header.len0 = remain_len - 255;\r\nrmsg->header.len1 = 0xff;\r\nrmsg->header.len2 = 0x00;\r\nrmsg->header.len3 = 0x00;\r\nrmsg->header.len4 = 0x00;\r\nrmsg->header.len5 = 0x00;\r\nremain_len = 0;\r\n} else if (remain_len <= 512) {\r\nlen1 = remain_len;\r\nlen2 = 0x00;\r\nrmsg->header.len0 = remain_len - 510;\r\nrmsg->header.len1 = 0xff;\r\nrmsg->header.len2 = 0xff;\r\nrmsg->header.len3 = 0x00;\r\nrmsg->header.len4 = 0x00;\r\nrmsg->header.len5 = 0x00;\r\nremain_len = 0;\r\n} else if (remain_len <= 767) {\r\nlen1 = 512;\r\nlen2 = remain_len - 512;\r\nrmsg->header.len0 = 0x02;\r\nrmsg->header.len1 = 0xff;\r\nrmsg->header.len2 = 0xff;\r\nrmsg->header.len3 = remain_len - 512;\r\nrmsg->header.len4 = 0x00;\r\nrmsg->header.len5 = 0x00;\r\nbytes_xfer = remain_len;\r\nremain_len = 0;\r\n} else if (remain_len <= 1022) {\r\nlen1 = 512;\r\nlen2 = remain_len - 512;\r\nrmsg->header.len0 = 0x02;\r\nrmsg->header.len1 = 0xff;\r\nrmsg->header.len2 = 0xff;\r\nrmsg->header.len3 = remain_len - 767;\r\nrmsg->header.len4 = 0xff;\r\nrmsg->header.len5 = 0x00;\r\nremain_len = 0;\r\n} else if (remain_len <= 1024) {\r\nlen1 = 512;\r\nlen2 = remain_len - 512;\r\nrmsg->header.len0 = 0x02;\r\nrmsg->header.len1 = 0xff;\r\nrmsg->header.len2 = 0xff;\r\nrmsg->header.len3 = remain_len - 1022;\r\nrmsg->header.len4 = 0xff;\r\nrmsg->header.len5 = 0xff;\r\nremain_len = 0;\r\n} else {\r\nlen1 = 512;\r\nlen2 = 512;\r\nrmsg->header.len0 = 0x02;\r\nrmsg->header.len1 = 0xff;\r\nrmsg->header.len2 = 0xff;\r\nrmsg->header.len3 = 0x02;\r\nrmsg->header.len4 = 0xff;\r\nrmsg->header.len5 = 0xff;\r\nremain_len -= 1024;\r\nstart += 1024;\r\n}\r\nrmsg->header.tf1 = cpu_to_le16(len1);\r\nrmsg->header.tf2 = cpu_to_le16(len2);\r\nret = vprbrd_i2c_receive(vb->usb_dev, rmsg, len1);\r\nif (ret < 0)\r\nreturn ret;\r\nmemcpy(msg->buf + start, rmsg, len1);\r\nif (len2 > 0) {\r\nret = vprbrd_i2c_receive(vb->usb_dev, rmsg, len2);\r\nif (ret < 0)\r\nreturn ret;\r\nmemcpy(msg->buf + start + 512, rmsg, len2);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int vprbrd_i2c_write(struct vprbrd *vb, struct i2c_msg *msg)\r\n{\r\nint ret, bytes_actual;\r\nu16 remain_len, bytes_xfer,\r\nstart = 0x0000;\r\nstruct vprbrd_i2c_write_msg *wmsg =\r\n(struct vprbrd_i2c_write_msg *)vb->buf;\r\nremain_len = msg->len;\r\nwmsg->header.cmd = VPRBRD_I2C_CMD_WRITE;\r\nwmsg->header.last = 0x00;\r\nwmsg->header.chan = 0x00;\r\nwmsg->header.spi = 0x0000;\r\nwhile (remain_len > 0) {\r\nwmsg->header.addr = cpu_to_le16(start + 0x4000);\r\nif (remain_len > 503) {\r\nwmsg->header.len1 = 0xff;\r\nwmsg->header.len2 = 0xf8;\r\nremain_len -= 503;\r\nbytes_xfer = 503 + sizeof(struct vprbrd_i2c_write_hdr);\r\nstart += 503;\r\n} else if (remain_len > 255) {\r\nwmsg->header.len1 = 0xff;\r\nwmsg->header.len2 = (remain_len - 255);\r\nbytes_xfer = remain_len +\r\nsizeof(struct vprbrd_i2c_write_hdr);\r\nremain_len = 0;\r\n} else {\r\nwmsg->header.len1 = remain_len;\r\nwmsg->header.len2 = 0x00;\r\nbytes_xfer = remain_len +\r\nsizeof(struct vprbrd_i2c_write_hdr);\r\nremain_len = 0;\r\n}\r\nmemcpy(wmsg->data, msg->buf + start,\r\nbytes_xfer - sizeof(struct vprbrd_i2c_write_hdr));\r\nret = usb_bulk_msg(vb->usb_dev,\r\nusb_sndbulkpipe(vb->usb_dev,\r\nVPRBRD_EP_OUT), wmsg,\r\nbytes_xfer, &bytes_actual, VPRBRD_USB_TIMEOUT_MS);\r\nif ((ret < 0) || (bytes_xfer != bytes_actual))\r\nreturn -EREMOTEIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int vprbrd_i2c_xfer(struct i2c_adapter *i2c, struct i2c_msg *msgs,\r\nint num)\r\n{\r\nstruct i2c_msg *pmsg;\r\nint i, ret,\r\nerror = 0;\r\nstruct vprbrd *vb = (struct vprbrd *)i2c->algo_data;\r\nstruct vprbrd_i2c_addr_msg *amsg =\r\n(struct vprbrd_i2c_addr_msg *)vb->buf;\r\nstruct vprbrd_i2c_status *smsg = (struct vprbrd_i2c_status *)vb->buf;\r\ndev_dbg(&i2c->dev, "master xfer %d messages:\n", num);\r\nfor (i = 0 ; i < num ; i++) {\r\npmsg = &msgs[i];\r\ndev_dbg(&i2c->dev,\r\n" %d: %s (flags %d) %d bytes to 0x%02x\n",\r\ni, pmsg->flags & I2C_M_RD ? "read" : "write",\r\npmsg->flags, pmsg->len, pmsg->addr);\r\nif (pmsg->len > 2048)\r\nreturn -EINVAL;\r\nmutex_lock(&vb->lock);\r\nif (pmsg->flags & I2C_M_RD) {\r\namsg->cmd = VPRBRD_I2C_CMD_ADDR;\r\namsg->unknown2 = 0x00;\r\namsg->unknown3 = 0x00;\r\namsg->addr = pmsg->addr;\r\namsg->unknown1 = 0x01;\r\namsg->len = cpu_to_le16(pmsg->len);\r\nret = vprbrd_i2c_addr(vb->usb_dev, amsg);\r\nif (ret < 0)\r\nerror = ret;\r\nret = vprbrd_i2c_read(vb, pmsg);\r\nif (ret < 0)\r\nerror = ret;\r\nret = vprbrd_i2c_status(i2c, smsg, error);\r\nif (ret < 0)\r\nerror = ret;\r\nif (error < 0)\r\ngoto error;\r\n} else {\r\nret = vprbrd_i2c_write(vb, pmsg);\r\namsg->cmd = VPRBRD_I2C_CMD_ADDR;\r\namsg->unknown2 = 0x00;\r\namsg->unknown3 = 0x00;\r\namsg->addr = pmsg->addr;\r\namsg->unknown1 = 0x00;\r\namsg->len = cpu_to_le16(pmsg->len);\r\nret = vprbrd_i2c_addr(vb->usb_dev, amsg);\r\nif (ret < 0)\r\nerror = ret;\r\nret = vprbrd_i2c_status(i2c, smsg, error);\r\nif (ret < 0)\r\nerror = ret;\r\nif (error < 0)\r\ngoto error;\r\n}\r\nmutex_unlock(&vb->lock);\r\n}\r\nreturn 0;\r\nerror:\r\nmutex_unlock(&vb->lock);\r\nreturn error;\r\n}\r\nstatic u32 vprbrd_i2c_func(struct i2c_adapter *i2c)\r\n{\r\nreturn I2C_FUNC_I2C | I2C_FUNC_SMBUS_EMUL;\r\n}\r\nstatic int vprbrd_i2c_probe(struct platform_device *pdev)\r\n{\r\nstruct vprbrd *vb = dev_get_drvdata(pdev->dev.parent);\r\nstruct vprbrd_i2c *vb_i2c;\r\nint ret;\r\nint pipe;\r\nvb_i2c = kzalloc(sizeof(*vb_i2c), GFP_KERNEL);\r\nif (vb_i2c == NULL)\r\nreturn -ENOMEM;\r\nvb_i2c->i2c.owner = THIS_MODULE;\r\nvb_i2c->i2c.class = I2C_CLASS_HWMON;\r\nvb_i2c->i2c.algo = &vprbrd_algorithm;\r\nvb_i2c->i2c.algo_data = vb;\r\nvb_i2c->bus_freq_param = i2c_bus_param;\r\nsnprintf(vb_i2c->i2c.name, sizeof(vb_i2c->i2c.name),\r\n"viperboard at bus %03d device %03d",\r\nvb->usb_dev->bus->busnum, vb->usb_dev->devnum);\r\nif ((i2c_bus_param <= VPRBRD_I2C_FREQ_10KHZ)\r\n&& (i2c_bus_param >= VPRBRD_I2C_FREQ_6MHZ)) {\r\npipe = usb_sndctrlpipe(vb->usb_dev, 0);\r\nret = usb_control_msg(vb->usb_dev, pipe,\r\nVPRBRD_USB_REQUEST_I2C_FREQ, VPRBRD_USB_TYPE_OUT,\r\n0x0000, 0x0000, &vb_i2c->bus_freq_param, 1,\r\nVPRBRD_USB_TIMEOUT_MS);\r\nif (ret != 1) {\r\ndev_err(&pdev->dev,\r\n"failure setting i2c_bus_freq to %d\n", i2c_bus_freq);\r\nret = -EIO;\r\ngoto error;\r\n}\r\n} else {\r\ndev_err(&pdev->dev,\r\n"invalid i2c_bus_freq setting:%d\n", i2c_bus_freq);\r\nret = -EIO;\r\ngoto error;\r\n}\r\nvb_i2c->i2c.dev.parent = &pdev->dev;\r\ni2c_add_adapter(&vb_i2c->i2c);\r\nplatform_set_drvdata(pdev, vb_i2c);\r\nreturn 0;\r\nerror:\r\nkfree(vb_i2c);\r\nreturn ret;\r\n}\r\nstatic int vprbrd_i2c_remove(struct platform_device *pdev)\r\n{\r\nstruct vprbrd_i2c *vb_i2c = platform_get_drvdata(pdev);\r\nint ret;\r\nret = i2c_del_adapter(&vb_i2c->i2c);\r\nreturn ret;\r\n}\r\nstatic int __init vprbrd_i2c_init(void)\r\n{\r\nswitch (i2c_bus_freq) {\r\ncase 6000:\r\ni2c_bus_param = VPRBRD_I2C_FREQ_6MHZ;\r\nbreak;\r\ncase 3000:\r\ni2c_bus_param = VPRBRD_I2C_FREQ_3MHZ;\r\nbreak;\r\ncase 1000:\r\ni2c_bus_param = VPRBRD_I2C_FREQ_1MHZ;\r\nbreak;\r\ncase 400:\r\ni2c_bus_param = VPRBRD_I2C_FREQ_400KHZ;\r\nbreak;\r\ncase 200:\r\ni2c_bus_param = VPRBRD_I2C_FREQ_200KHZ;\r\nbreak;\r\ncase 100:\r\ni2c_bus_param = VPRBRD_I2C_FREQ_100KHZ;\r\nbreak;\r\ncase 10:\r\ni2c_bus_param = VPRBRD_I2C_FREQ_10KHZ;\r\nbreak;\r\ndefault:\r\npr_warn("invalid i2c_bus_freq (%d)\n", i2c_bus_freq);\r\ni2c_bus_param = VPRBRD_I2C_FREQ_100KHZ;\r\n}\r\nreturn platform_driver_register(&vprbrd_i2c_driver);\r\n}\r\nstatic void __exit vprbrd_i2c_exit(void)\r\n{\r\nplatform_driver_unregister(&vprbrd_i2c_driver);\r\n}

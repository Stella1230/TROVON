static ssize_t dummy_looptest(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nstruct dummy *p_dummy = dev_get_drvdata(&spi->dev);\r\nint status;\r\nu8 txbuf[14] = {0xDE, 0xAD, 0xBE, 0xEF, 0x2B, 0xAD,\r\n0xCA, 0xFE, 0xBA, 0xBE, 0xB1, 0x05,\r\n0xF0, 0x0D};\r\nu8 rxbuf[14];\r\nu8 *bigtxbuf_virtual;\r\nu8 *bigrxbuf_virtual;\r\nif (mutex_lock_interruptible(&p_dummy->lock))\r\nreturn -ERESTARTSYS;\r\nbigtxbuf_virtual = kmalloc(DMA_TEST_SIZE, GFP_KERNEL);\r\nif (bigtxbuf_virtual == NULL) {\r\nstatus = -ENOMEM;\r\ngoto out;\r\n}\r\nbigrxbuf_virtual = kmalloc(DMA_TEST_SIZE, GFP_KERNEL);\r\nmemset(bigtxbuf_virtual, 0xAA, DMA_TEST_SIZE);\r\nspi->bits_per_word = 8;\r\nspi->master->setup(spi);\r\npr_info("Simple test 1: write 0xAA byte, read back garbage byte "\r\n"in 8bit mode\n");\r\nstatus = spi_w8r8(spi, 0xAA);\r\nif (status < 0)\r\npr_warning("Siple test 1: FAILURE: spi_write_then_read "\r\n"failed with status %d\n", status);\r\nelse\r\npr_info("Simple test 1: SUCCESS!\n");\r\npr_info("Simple test 2: write 8 bytes, read back 8 bytes garbage "\r\n"in 8bit mode (full FIFO)\n");\r\nstatus = spi_write_then_read(spi, &txbuf[0], 8, &rxbuf[0], 8);\r\nif (status < 0)\r\npr_warning("Simple test 2: FAILURE: spi_write_then_read() "\r\n"failed with status %d\n", status);\r\nelse\r\npr_info("Simple test 2: SUCCESS!\n");\r\npr_info("Simple test 3: write 14 bytes, read back 14 bytes garbage "\r\n"in 8bit mode (see if we overflow FIFO)\n");\r\nstatus = spi_write_then_read(spi, &txbuf[0], 14, &rxbuf[0], 14);\r\nif (status < 0)\r\npr_warning("Simple test 3: FAILURE: failed with status %d "\r\n"(probably FIFO overrun)\n", status);\r\nelse\r\npr_info("Simple test 3: SUCCESS!\n");\r\npr_info("Simple test 4: write 8 bytes with spi_write(), read 8 "\r\n"bytes garbage with spi_read() in 8bit mode\n");\r\nstatus = spi_write(spi, &txbuf[0], 8);\r\nif (status < 0)\r\npr_warning("Simple test 4 step 1: FAILURE: spi_write() "\r\n"failed with status %d\n", status);\r\nelse\r\npr_info("Simple test 4 step 1: SUCCESS!\n");\r\nstatus = spi_read(spi, &rxbuf[0], 8);\r\nif (status < 0)\r\npr_warning("Simple test 4 step 2: FAILURE: spi_read() "\r\n"failed with status %d\n", status);\r\nelse\r\npr_info("Simple test 4 step 2: SUCCESS!\n");\r\npr_info("Simple test 5: write 14 bytes with spi_write(), read "\r\n"14 bytes garbage with spi_read() in 8bit mode\n");\r\nstatus = spi_write(spi, &txbuf[0], 14);\r\nif (status < 0)\r\npr_warning("Simple test 5 step 1: FAILURE: spi_write() "\r\n"failed with status %d (probably FIFO overrun)\n",\r\nstatus);\r\nelse\r\npr_info("Simple test 5 step 1: SUCCESS!\n");\r\nstatus = spi_read(spi, &rxbuf[0], 14);\r\nif (status < 0)\r\npr_warning("Simple test 5 step 2: FAILURE: spi_read() "\r\n"failed with status %d (probably FIFO overrun)\n",\r\nstatus);\r\nelse\r\npr_info("Simple test 5: SUCCESS!\n");\r\npr_info("Simple test 6: write %d bytes with spi_write(), "\r\n"read %d bytes garbage with spi_read() in 8bit mode\n",\r\nDMA_TEST_SIZE, DMA_TEST_SIZE);\r\nstatus = spi_write(spi, &bigtxbuf_virtual[0], DMA_TEST_SIZE);\r\nif (status < 0)\r\npr_warning("Simple test 6 step 1: FAILURE: spi_write() "\r\n"failed with status %d (probably FIFO overrun)\n",\r\nstatus);\r\nelse\r\npr_info("Simple test 6 step 1: SUCCESS!\n");\r\nstatus = spi_read(spi, &bigrxbuf_virtual[0], DMA_TEST_SIZE);\r\nif (status < 0)\r\npr_warning("Simple test 6 step 2: FAILURE: spi_read() "\r\n"failed with status %d (probably FIFO overrun)\n",\r\nstatus);\r\nelse\r\npr_info("Simple test 6: SUCCESS!\n");\r\nspi->bits_per_word = 16;\r\nspi->master->setup(spi);\r\npr_info("Simple test 7: write 0xAA byte, read back garbage byte "\r\n"in 16bit bus mode\n");\r\nstatus = spi_w8r8(spi, 0xAA);\r\nif (status == -EIO)\r\npr_info("Simple test 7: SUCCESS! (expected failure with "\r\n"status EIO)\n");\r\nelse if (status < 0)\r\npr_warning("Siple test 7: FAILURE: spi_write_then_read "\r\n"failed with status %d\n", status);\r\nelse\r\npr_warning("Siple test 7: FAILURE: spi_write_then_read "\r\n"succeeded but it was expected to fail!\n");\r\npr_info("Simple test 8: write 8 bytes, read back 8 bytes garbage "\r\n"in 16bit mode (full FIFO)\n");\r\nstatus = spi_write_then_read(spi, &txbuf[0], 8, &rxbuf[0], 8);\r\nif (status < 0)\r\npr_warning("Simple test 8: FAILURE: spi_write_then_read() "\r\n"failed with status %d\n", status);\r\nelse\r\npr_info("Simple test 8: SUCCESS!\n");\r\npr_info("Simple test 9: write 14 bytes, read back 14 bytes garbage "\r\n"in 16bit mode (see if we overflow FIFO)\n");\r\nstatus = spi_write_then_read(spi, &txbuf[0], 14, &rxbuf[0], 14);\r\nif (status < 0)\r\npr_warning("Simple test 9: FAILURE: failed with status %d "\r\n"(probably FIFO overrun)\n", status);\r\nelse\r\npr_info("Simple test 9: SUCCESS!\n");\r\npr_info("Simple test 10: write %d bytes with spi_write(), "\r\n"read %d bytes garbage with spi_read() in 16bit mode\n",\r\nDMA_TEST_SIZE, DMA_TEST_SIZE);\r\nstatus = spi_write(spi, &bigtxbuf_virtual[0], DMA_TEST_SIZE);\r\nif (status < 0)\r\npr_warning("Simple test 10 step 1: FAILURE: spi_write() "\r\n"failed with status %d (probably FIFO overrun)\n",\r\nstatus);\r\nelse\r\npr_info("Simple test 10 step 1: SUCCESS!\n");\r\nstatus = spi_read(spi, &bigrxbuf_virtual[0], DMA_TEST_SIZE);\r\nif (status < 0)\r\npr_warning("Simple test 10 step 2: FAILURE: spi_read() "\r\n"failed with status %d (probably FIFO overrun)\n",\r\nstatus);\r\nelse\r\npr_info("Simple test 10: SUCCESS!\n");\r\nstatus = sprintf(buf, "loop test complete\n");\r\nkfree(bigrxbuf_virtual);\r\nkfree(bigtxbuf_virtual);\r\nout:\r\nmutex_unlock(&p_dummy->lock);\r\nreturn status;\r\n}\r\nstatic int pl022_dummy_probe(struct spi_device *spi)\r\n{\r\nstruct dummy *p_dummy;\r\nint status;\r\ndev_info(&spi->dev, "probing dummy SPI device\n");\r\np_dummy = kzalloc(sizeof *p_dummy, GFP_KERNEL);\r\nif (!p_dummy)\r\nreturn -ENOMEM;\r\ndev_set_drvdata(&spi->dev, p_dummy);\r\nmutex_init(&p_dummy->lock);\r\nstatus = device_create_file(&spi->dev, &dev_attr_looptest);\r\nif (status) {\r\ndev_dbg(&spi->dev, "device_create_file looptest failure.\n");\r\ngoto out_dev_create_looptest_failed;\r\n}\r\nreturn 0;\r\nout_dev_create_looptest_failed:\r\ndev_set_drvdata(&spi->dev, NULL);\r\nkfree(p_dummy);\r\nreturn status;\r\n}\r\nstatic int pl022_dummy_remove(struct spi_device *spi)\r\n{\r\nstruct dummy *p_dummy = dev_get_drvdata(&spi->dev);\r\ndev_info(&spi->dev, "removing dummy SPI device\n");\r\ndevice_remove_file(&spi->dev, &dev_attr_looptest);\r\ndev_set_drvdata(&spi->dev, NULL);\r\nkfree(p_dummy);\r\nreturn 0;\r\n}\r\nstatic int __init pl022_init_dummy(void)\r\n{\r\nreturn spi_register_driver(&pl022_dummy_driver);\r\n}\r\nstatic void __exit pl022_exit_dummy(void)\r\n{\r\nspi_unregister_driver(&pl022_dummy_driver);\r\n}

static int rfkill_regulator_set_block(void *data, bool blocked)\r\n{\r\nstruct rfkill_regulator_data *rfkill_data = data;\r\npr_debug("%s: blocked: %d\n", __func__, blocked);\r\nif (blocked) {\r\nif (rfkill_data->reg_enabled) {\r\nregulator_disable(rfkill_data->vcc);\r\nrfkill_data->reg_enabled = false;\r\n}\r\n} else {\r\nif (!rfkill_data->reg_enabled) {\r\nregulator_enable(rfkill_data->vcc);\r\nrfkill_data->reg_enabled = true;\r\n}\r\n}\r\npr_debug("%s: regulator_is_enabled after set_block: %d\n", __func__,\r\nregulator_is_enabled(rfkill_data->vcc));\r\nreturn 0;\r\n}\r\nstatic int rfkill_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct rfkill_regulator_platform_data *pdata = pdev->dev.platform_data;\r\nstruct rfkill_regulator_data *rfkill_data;\r\nstruct regulator *vcc;\r\nstruct rfkill *rf_kill;\r\nint ret = 0;\r\nif (pdata == NULL) {\r\ndev_err(&pdev->dev, "no platform data\n");\r\nreturn -ENODEV;\r\n}\r\nif (pdata->name == NULL || pdata->type == 0) {\r\ndev_err(&pdev->dev, "invalid name or type in platform data\n");\r\nreturn -EINVAL;\r\n}\r\nvcc = regulator_get_exclusive(&pdev->dev, "vrfkill");\r\nif (IS_ERR(vcc)) {\r\ndev_err(&pdev->dev, "Cannot get vcc for %s\n", pdata->name);\r\nret = PTR_ERR(vcc);\r\ngoto out;\r\n}\r\nrfkill_data = kzalloc(sizeof(*rfkill_data), GFP_KERNEL);\r\nif (rfkill_data == NULL) {\r\nret = -ENOMEM;\r\ngoto err_data_alloc;\r\n}\r\nrf_kill = rfkill_alloc(pdata->name, &pdev->dev,\r\npdata->type,\r\n&rfkill_regulator_ops, rfkill_data);\r\nif (rf_kill == NULL) {\r\nret = -ENOMEM;\r\ngoto err_rfkill_alloc;\r\n}\r\nif (regulator_is_enabled(vcc)) {\r\ndev_dbg(&pdev->dev, "Regulator already enabled\n");\r\nrfkill_data->reg_enabled = true;\r\n}\r\nrfkill_data->vcc = vcc;\r\nrfkill_data->rf_kill = rf_kill;\r\nret = rfkill_register(rf_kill);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Cannot register rfkill device\n");\r\ngoto err_rfkill_register;\r\n}\r\nplatform_set_drvdata(pdev, rfkill_data);\r\ndev_info(&pdev->dev, "%s initialized\n", pdata->name);\r\nreturn 0;\r\nerr_rfkill_register:\r\nrfkill_destroy(rf_kill);\r\nerr_rfkill_alloc:\r\nkfree(rfkill_data);\r\nerr_data_alloc:\r\nregulator_put(vcc);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int rfkill_regulator_remove(struct platform_device *pdev)\r\n{\r\nstruct rfkill_regulator_data *rfkill_data = platform_get_drvdata(pdev);\r\nstruct rfkill *rf_kill = rfkill_data->rf_kill;\r\nrfkill_unregister(rf_kill);\r\nrfkill_destroy(rf_kill);\r\nregulator_put(rfkill_data->vcc);\r\nkfree(rfkill_data);\r\nreturn 0;\r\n}

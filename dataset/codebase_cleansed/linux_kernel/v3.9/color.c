static int parse_color(const char *name, int len)\r\n{\r\nstatic const char * const color_names[] = {\r\n"normal", "black", "red", "green", "yellow",\r\n"blue", "magenta", "cyan", "white"\r\n};\r\nchar *end;\r\nint i;\r\nfor (i = 0; i < (int)ARRAY_SIZE(color_names); i++) {\r\nconst char *str = color_names[i];\r\nif (!strncasecmp(name, str, len) && !str[len])\r\nreturn i - 1;\r\n}\r\ni = strtol(name, &end, 10);\r\nif (end - name == len && i >= -1 && i <= 255)\r\nreturn i;\r\nreturn -2;\r\n}\r\nstatic int parse_attr(const char *name, int len)\r\n{\r\nstatic const int attr_values[] = { 1, 2, 4, 5, 7 };\r\nstatic const char * const attr_names[] = {\r\n"bold", "dim", "ul", "blink", "reverse"\r\n};\r\nunsigned int i;\r\nfor (i = 0; i < ARRAY_SIZE(attr_names); i++) {\r\nconst char *str = attr_names[i];\r\nif (!strncasecmp(name, str, len) && !str[len])\r\nreturn attr_values[i];\r\n}\r\nreturn -1;\r\n}\r\nvoid color_parse(const char *value, const char *var, char *dst)\r\n{\r\ncolor_parse_mem(value, strlen(value), var, dst);\r\n}\r\nvoid color_parse_mem(const char *value, int value_len, const char *var,\r\nchar *dst)\r\n{\r\nconst char *ptr = value;\r\nint len = value_len;\r\nint attr = -1;\r\nint fg = -2;\r\nint bg = -2;\r\nif (!strncasecmp(value, "reset", len)) {\r\nstrcpy(dst, PERF_COLOR_RESET);\r\nreturn;\r\n}\r\nwhile (len > 0) {\r\nconst char *word = ptr;\r\nint val, wordlen = 0;\r\nwhile (len > 0 && !isspace(word[wordlen])) {\r\nwordlen++;\r\nlen--;\r\n}\r\nptr = word + wordlen;\r\nwhile (len > 0 && isspace(*ptr)) {\r\nptr++;\r\nlen--;\r\n}\r\nval = parse_color(word, wordlen);\r\nif (val >= -1) {\r\nif (fg == -2) {\r\nfg = val;\r\ncontinue;\r\n}\r\nif (bg == -2) {\r\nbg = val;\r\ncontinue;\r\n}\r\ngoto bad;\r\n}\r\nval = parse_attr(word, wordlen);\r\nif (val < 0 || attr != -1)\r\ngoto bad;\r\nattr = val;\r\n}\r\nif (attr >= 0 || fg >= 0 || bg >= 0) {\r\nint sep = 0;\r\n*dst++ = '\033';\r\n*dst++ = '[';\r\nif (attr >= 0) {\r\n*dst++ = '0' + attr;\r\nsep++;\r\n}\r\nif (fg >= 0) {\r\nif (sep++)\r\n*dst++ = ';';\r\nif (fg < 8) {\r\n*dst++ = '3';\r\n*dst++ = '0' + fg;\r\n} else {\r\ndst += sprintf(dst, "38;5;%d", fg);\r\n}\r\n}\r\nif (bg >= 0) {\r\nif (sep++)\r\n*dst++ = ';';\r\nif (bg < 8) {\r\n*dst++ = '4';\r\n*dst++ = '0' + bg;\r\n} else {\r\ndst += sprintf(dst, "48;5;%d", bg);\r\n}\r\n}\r\n*dst++ = 'm';\r\n}\r\n*dst = 0;\r\nreturn;\r\nbad:\r\ndie("bad color value '%.*s' for variable '%s'", value_len, value, var);\r\n}\r\nint perf_config_colorbool(const char *var, const char *value, int stdout_is_tty)\r\n{\r\nif (value) {\r\nif (!strcasecmp(value, "never"))\r\nreturn 0;\r\nif (!strcasecmp(value, "always"))\r\nreturn 1;\r\nif (!strcasecmp(value, "auto"))\r\ngoto auto_color;\r\n}\r\nif (!perf_config_bool(var, value))\r\nreturn 0;\r\nauto_color:\r\nif (stdout_is_tty < 0)\r\nstdout_is_tty = isatty(1);\r\nif (stdout_is_tty || (pager_in_use() && pager_use_color)) {\r\nchar *term = getenv("TERM");\r\nif (term && strcmp(term, "dumb"))\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nint perf_color_default_config(const char *var, const char *value, void *cb)\r\n{\r\nif (!strcmp(var, "color.ui")) {\r\nperf_use_color_default = perf_config_colorbool(var, value, -1);\r\nreturn 0;\r\n}\r\nreturn perf_default_config(var, value, cb);\r\n}\r\nstatic int __color_vsnprintf(char *bf, size_t size, const char *color,\r\nconst char *fmt, va_list args, const char *trail)\r\n{\r\nint r = 0;\r\nif (perf_use_color_default < 0) {\r\nif (isatty(1) || pager_in_use())\r\nperf_use_color_default = 1;\r\nelse\r\nperf_use_color_default = 0;\r\n}\r\nif (perf_use_color_default && *color)\r\nr += scnprintf(bf, size, "%s", color);\r\nr += vscnprintf(bf + r, size - r, fmt, args);\r\nif (perf_use_color_default && *color)\r\nr += scnprintf(bf + r, size - r, "%s", PERF_COLOR_RESET);\r\nif (trail)\r\nr += scnprintf(bf + r, size - r, "%s", trail);\r\nreturn r;\r\n}\r\nstatic int __color_vfprintf(FILE *fp, const char *color, const char *fmt,\r\nva_list args, const char *trail)\r\n{\r\nint r = 0;\r\nif (perf_use_color_default < 0) {\r\nif (isatty(fileno(fp)) || pager_in_use())\r\nperf_use_color_default = 1;\r\nelse\r\nperf_use_color_default = 0;\r\n}\r\nif (perf_use_color_default && *color)\r\nr += fprintf(fp, "%s", color);\r\nr += vfprintf(fp, fmt, args);\r\nif (perf_use_color_default && *color)\r\nr += fprintf(fp, "%s", PERF_COLOR_RESET);\r\nif (trail)\r\nr += fprintf(fp, "%s", trail);\r\nreturn r;\r\n}\r\nint color_vsnprintf(char *bf, size_t size, const char *color,\r\nconst char *fmt, va_list args)\r\n{\r\nreturn __color_vsnprintf(bf, size, color, fmt, args, NULL);\r\n}\r\nint color_vfprintf(FILE *fp, const char *color, const char *fmt, va_list args)\r\n{\r\nreturn __color_vfprintf(fp, color, fmt, args, NULL);\r\n}\r\nint color_snprintf(char *bf, size_t size, const char *color,\r\nconst char *fmt, ...)\r\n{\r\nva_list args;\r\nint r;\r\nva_start(args, fmt);\r\nr = color_vsnprintf(bf, size, color, fmt, args);\r\nva_end(args);\r\nreturn r;\r\n}\r\nint color_fprintf(FILE *fp, const char *color, const char *fmt, ...)\r\n{\r\nva_list args;\r\nint r;\r\nva_start(args, fmt);\r\nr = color_vfprintf(fp, color, fmt, args);\r\nva_end(args);\r\nreturn r;\r\n}\r\nint color_fprintf_ln(FILE *fp, const char *color, const char *fmt, ...)\r\n{\r\nva_list args;\r\nint r;\r\nva_start(args, fmt);\r\nr = __color_vfprintf(fp, color, fmt, args, "\n");\r\nva_end(args);\r\nreturn r;\r\n}\r\nint color_fwrite_lines(FILE *fp, const char *color,\r\nsize_t count, const char *buf)\r\n{\r\nif (!*color)\r\nreturn fwrite(buf, count, 1, fp) != 1;\r\nwhile (count) {\r\nchar *p = memchr(buf, '\n', count);\r\nif (p != buf && (fputs(color, fp) < 0 ||\r\nfwrite(buf, p ? (size_t)(p - buf) : count, 1, fp) != 1 ||\r\nfputs(PERF_COLOR_RESET, fp) < 0))\r\nreturn -1;\r\nif (!p)\r\nreturn 0;\r\nif (fputc('\n', fp) < 0)\r\nreturn -1;\r\ncount -= p + 1 - buf;\r\nbuf = p + 1;\r\n}\r\nreturn 0;\r\n}\r\nconst char *get_percent_color(double percent)\r\n{\r\nconst char *color = PERF_COLOR_NORMAL;\r\nif (percent >= MIN_RED)\r\ncolor = PERF_COLOR_RED;\r\nelse {\r\nif (percent > MIN_GREEN)\r\ncolor = PERF_COLOR_GREEN;\r\n}\r\nreturn color;\r\n}\r\nint percent_color_fprintf(FILE *fp, const char *fmt, double percent)\r\n{\r\nint r;\r\nconst char *color;\r\ncolor = get_percent_color(percent);\r\nr = color_fprintf(fp, color, fmt, percent);\r\nreturn r;\r\n}\r\nint percent_color_snprintf(char *bf, size_t size, const char *fmt, double percent)\r\n{\r\nconst char *color = get_percent_color(percent);\r\nreturn color_snprintf(bf, size, color, fmt, percent);\r\n}

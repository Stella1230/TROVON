static int mc13783_powermisc_rmw(struct mc13xxx_regulator_priv *priv, u32 mask,\r\nu32 val)\r\n{\r\nstruct mc13xxx *mc13783 = priv->mc13xxx;\r\nint ret;\r\nu32 valread;\r\nBUG_ON(val & ~mask);\r\nmc13xxx_lock(priv->mc13xxx);\r\nret = mc13xxx_reg_read(mc13783, MC13783_REG_POWERMISC, &valread);\r\nif (ret)\r\ngoto out;\r\npriv->powermisc_pwgt_state =\r\n(priv->powermisc_pwgt_state & ~mask) | val;\r\npriv->powermisc_pwgt_state &= MC13783_REG_POWERMISC_PWGTSPI_M;\r\nvalread = (valread & ~mask) | val;\r\nvalread = (valread & ~MC13783_REG_POWERMISC_PWGTSPI_M) |\r\npriv->powermisc_pwgt_state;\r\nret = mc13xxx_reg_write(mc13783, MC13783_REG_POWERMISC, valread);\r\nout:\r\nmc13xxx_unlock(priv->mc13xxx);\r\nreturn ret;\r\n}\r\nstatic int mc13783_gpo_regulator_enable(struct regulator_dev *rdev)\r\n{\r\nstruct mc13xxx_regulator_priv *priv = rdev_get_drvdata(rdev);\r\nstruct mc13xxx_regulator *mc13xxx_regulators = priv->mc13xxx_regulators;\r\nint id = rdev_get_id(rdev);\r\nu32 en_val = mc13xxx_regulators[id].enable_bit;\r\ndev_dbg(rdev_get_dev(rdev), "%s id: %d\n", __func__, id);\r\nif (id == MC13783_REG_PWGT1SPI ||\r\nid == MC13783_REG_PWGT2SPI)\r\nen_val = 0;\r\nreturn mc13783_powermisc_rmw(priv, mc13xxx_regulators[id].enable_bit,\r\nen_val);\r\n}\r\nstatic int mc13783_gpo_regulator_disable(struct regulator_dev *rdev)\r\n{\r\nstruct mc13xxx_regulator_priv *priv = rdev_get_drvdata(rdev);\r\nstruct mc13xxx_regulator *mc13xxx_regulators = priv->mc13xxx_regulators;\r\nint id = rdev_get_id(rdev);\r\nu32 dis_val = 0;\r\ndev_dbg(rdev_get_dev(rdev), "%s id: %d\n", __func__, id);\r\nif (id == MC13783_REG_PWGT1SPI ||\r\nid == MC13783_REG_PWGT2SPI)\r\ndis_val = mc13xxx_regulators[id].enable_bit;\r\nreturn mc13783_powermisc_rmw(priv, mc13xxx_regulators[id].enable_bit,\r\ndis_val);\r\n}\r\nstatic int mc13783_gpo_regulator_is_enabled(struct regulator_dev *rdev)\r\n{\r\nstruct mc13xxx_regulator_priv *priv = rdev_get_drvdata(rdev);\r\nstruct mc13xxx_regulator *mc13xxx_regulators = priv->mc13xxx_regulators;\r\nint ret, id = rdev_get_id(rdev);\r\nunsigned int val;\r\nmc13xxx_lock(priv->mc13xxx);\r\nret = mc13xxx_reg_read(priv->mc13xxx, mc13xxx_regulators[id].reg, &val);\r\nmc13xxx_unlock(priv->mc13xxx);\r\nif (ret)\r\nreturn ret;\r\nval = (val & ~MC13783_REG_POWERMISC_PWGTSPI_M) |\r\n(priv->powermisc_pwgt_state ^ MC13783_REG_POWERMISC_PWGTSPI_M);\r\nreturn (val & mc13xxx_regulators[id].enable_bit) != 0;\r\n}\r\nstatic int mc13783_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct mc13xxx_regulator_priv *priv;\r\nstruct mc13xxx *mc13783 = dev_get_drvdata(pdev->dev.parent);\r\nstruct mc13xxx_regulator_platform_data *pdata =\r\ndev_get_platdata(&pdev->dev);\r\nstruct mc13xxx_regulator_init_data *init_data;\r\nstruct regulator_config config = { };\r\nint i, ret;\r\ndev_dbg(&pdev->dev, "%s id %d\n", __func__, pdev->id);\r\nif (!pdata)\r\nreturn -EINVAL;\r\npriv = devm_kzalloc(&pdev->dev, sizeof(*priv) +\r\npdata->num_regulators * sizeof(priv->regulators[0]),\r\nGFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->mc13xxx_regulators = mc13783_regulators;\r\npriv->mc13xxx = mc13783;\r\nfor (i = 0; i < pdata->num_regulators; i++) {\r\nstruct regulator_desc *desc;\r\ninit_data = &pdata->regulators[i];\r\ndesc = &mc13783_regulators[init_data->id].desc;\r\nconfig.dev = &pdev->dev;\r\nconfig.init_data = init_data->init_data;\r\nconfig.driver_data = priv;\r\npriv->regulators[i] = regulator_register(desc, &config);\r\nif (IS_ERR(priv->regulators[i])) {\r\ndev_err(&pdev->dev, "failed to register regulator %s\n",\r\nmc13783_regulators[i].desc.name);\r\nret = PTR_ERR(priv->regulators[i]);\r\ngoto err;\r\n}\r\n}\r\nplatform_set_drvdata(pdev, priv);\r\nreturn 0;\r\nerr:\r\nwhile (--i >= 0)\r\nregulator_unregister(priv->regulators[i]);\r\nreturn ret;\r\n}\r\nstatic int mc13783_regulator_remove(struct platform_device *pdev)\r\n{\r\nstruct mc13xxx_regulator_priv *priv = platform_get_drvdata(pdev);\r\nstruct mc13xxx_regulator_platform_data *pdata =\r\ndev_get_platdata(&pdev->dev);\r\nint i;\r\nplatform_set_drvdata(pdev, NULL);\r\nfor (i = 0; i < pdata->num_regulators; i++)\r\nregulator_unregister(priv->regulators[i]);\r\nreturn 0;\r\n}\r\nstatic int __init mc13783_regulator_init(void)\r\n{\r\nreturn platform_driver_register(&mc13783_regulator_driver);\r\n}\r\nstatic void __exit mc13783_regulator_exit(void)\r\n{\r\nplatform_driver_unregister(&mc13783_regulator_driver);\r\n}

int of_irq_map_pci(const struct pci_dev *pdev, struct of_irq *out_irq)\r\n{\r\nstruct device_node *dn, *ppnode;\r\nstruct pci_dev *ppdev;\r\nu32 lspec;\r\n__be32 lspec_be;\r\n__be32 laddr[3];\r\nu8 pin;\r\nint rc;\r\ndn = pci_device_to_OF_node(pdev);\r\nif (dn) {\r\nrc = of_irq_map_one(dn, 0, out_irq);\r\nif (!rc)\r\nreturn rc;\r\n}\r\nrc = pci_read_config_byte(pdev, PCI_INTERRUPT_PIN, &pin);\r\nif (rc != 0)\r\nreturn rc;\r\nif (pin == 0)\r\nreturn -ENODEV;\r\nlspec = pin;\r\nfor (;;) {\r\nppdev = pdev->bus->self;\r\nif (ppdev == NULL) {\r\nppnode = pci_bus_to_OF_node(pdev->bus);\r\nif (ppnode == NULL)\r\nreturn -EINVAL;\r\n} else {\r\nppnode = pci_device_to_OF_node(ppdev);\r\n}\r\nif (ppnode)\r\nbreak;\r\nlspec = pci_swizzle_interrupt_pin(pdev, lspec);\r\npdev = ppdev;\r\n}\r\nlspec_be = cpu_to_be32(lspec);\r\nladdr[0] = cpu_to_be32((pdev->bus->number << 16) | (pdev->devfn << 8));\r\nladdr[1] = laddr[2] = cpu_to_be32(0);\r\nreturn of_irq_map_raw(ppnode, &lspec_be, 1, laddr, out_irq);\r\n}

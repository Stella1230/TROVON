static void av7110_emit_keyup(unsigned long parm)\r\n{\r\nstruct infrared *ir = (struct infrared *) parm;\r\nif (!ir || !test_bit(ir->last_key, ir->input_dev->key))\r\nreturn;\r\ninput_report_key(ir->input_dev, ir->last_key, 0);\r\ninput_sync(ir->input_dev);\r\n}\r\nstatic void av7110_emit_key(unsigned long parm)\r\n{\r\nstruct infrared *ir = (struct infrared *) parm;\r\nu32 ircom = ir->ir_command;\r\nu8 data;\r\nu8 addr;\r\nu16 toggle;\r\nu16 keycode;\r\nswitch (ir->protocol) {\r\ncase IR_RC5:\r\ndata = ircom & 0x3f;\r\naddr = (ircom >> 6) & 0x1f;\r\ntoggle = ircom & 0x0800;\r\nbreak;\r\ncase IR_RCMM:\r\ndata = ircom & 0xff;\r\naddr = (ircom >> 8) & 0x1f;\r\ntoggle = ircom & 0x8000;\r\nbreak;\r\ncase IR_RC5_EXT:\r\ndata = ircom & 0x3f;\r\naddr = (ircom >> 6) & 0x1f;\r\nif (!(ircom & 0x1000))\r\ndata |= 0x40;\r\ntoggle = ircom & 0x0800;\r\nbreak;\r\ndefault:\r\nprintk("%s invalid protocol %x\n", __func__, ir->protocol);\r\nreturn;\r\n}\r\ninput_event(ir->input_dev, EV_MSC, MSC_RAW, (addr << 16) | data);\r\ninput_event(ir->input_dev, EV_MSC, MSC_SCAN, data);\r\nkeycode = ir->key_map[data];\r\ndprintk(16, "%s: code %08x -> addr %i data 0x%02x -> keycode %i\n",\r\n__func__, ircom, addr, data, keycode);\r\nif (!(ir->device_mask & (1 << addr)))\r\nreturn;\r\nif (!keycode) {\r\nprintk ("%s: code %08x -> addr %i data 0x%02x -> unknown key!\n",\r\n__func__, ircom, addr, data);\r\nreturn;\r\n}\r\nif (timer_pending(&ir->keyup_timer)) {\r\ndel_timer(&ir->keyup_timer);\r\nif (ir->last_key != keycode || toggle != ir->last_toggle) {\r\nir->delay_timer_finished = 0;\r\ninput_event(ir->input_dev, EV_KEY, ir->last_key, 0);\r\ninput_event(ir->input_dev, EV_KEY, keycode, 1);\r\ninput_sync(ir->input_dev);\r\n} else if (ir->delay_timer_finished) {\r\ninput_event(ir->input_dev, EV_KEY, keycode, 2);\r\ninput_sync(ir->input_dev);\r\n}\r\n} else {\r\nir->delay_timer_finished = 0;\r\ninput_event(ir->input_dev, EV_KEY, keycode, 1);\r\ninput_sync(ir->input_dev);\r\n}\r\nir->last_key = keycode;\r\nir->last_toggle = toggle;\r\nir->keyup_timer.expires = jiffies + UP_TIMEOUT;\r\nadd_timer(&ir->keyup_timer);\r\n}\r\nstatic void input_register_keys(struct infrared *ir)\r\n{\r\nint i;\r\nset_bit(EV_KEY, ir->input_dev->evbit);\r\nset_bit(EV_REP, ir->input_dev->evbit);\r\nset_bit(EV_MSC, ir->input_dev->evbit);\r\nset_bit(MSC_RAW, ir->input_dev->mscbit);\r\nset_bit(MSC_SCAN, ir->input_dev->mscbit);\r\nmemset(ir->input_dev->keybit, 0, sizeof(ir->input_dev->keybit));\r\nfor (i = 0; i < ARRAY_SIZE(ir->key_map); i++) {\r\nif (ir->key_map[i] > KEY_MAX)\r\nir->key_map[i] = 0;\r\nelse if (ir->key_map[i] > KEY_RESERVED)\r\nset_bit(ir->key_map[i], ir->input_dev->keybit);\r\n}\r\nir->input_dev->keycode = ir->key_map;\r\nir->input_dev->keycodesize = sizeof(ir->key_map[0]);\r\nir->input_dev->keycodemax = ARRAY_SIZE(ir->key_map);\r\n}\r\nstatic void input_repeat_key(unsigned long parm)\r\n{\r\nstruct infrared *ir = (struct infrared *) parm;\r\nir->delay_timer_finished = 1;\r\n}\r\nint av7110_check_ir_config(struct av7110 *av7110, int force)\r\n{\r\nint i;\r\nint modified = force;\r\nint ret = -ENODEV;\r\nfor (i = 0; i < av_cnt; i++)\r\nif (av7110 == av_list[i])\r\nbreak;\r\nif (i < av_cnt && av7110) {\r\nif ((av7110->ir.protocol & 1) != ir_protocol[i] ||\r\nav7110->ir.inversion != ir_inversion[i])\r\nmodified = true;\r\nif (modified) {\r\nif (ir_protocol[i]) {\r\nir_protocol[i] = 1;\r\nav7110->ir.protocol = IR_RCMM;\r\nav7110->ir.ir_config = 0x0001;\r\n} else if (FW_VERSION(av7110->arm_app) >= 0x2620) {\r\nav7110->ir.protocol = IR_RC5_EXT;\r\nav7110->ir.ir_config = 0x0002;\r\n} else {\r\nav7110->ir.protocol = IR_RC5;\r\nav7110->ir.ir_config = 0x0000;\r\n}\r\nif (ir_inversion[i]) {\r\nir_inversion[i] = 1;\r\nav7110->ir.ir_config |= 0x8000;\r\n}\r\nav7110->ir.inversion = ir_inversion[i];\r\nret = av7110_fw_cmd(av7110, COMTYPE_PIDFILTER, SetIR, 1,\r\nav7110->ir.ir_config);\r\n} else\r\nret = 0;\r\nif (av7110->ir.device_mask != ir_device_mask[i])\r\nav7110->ir.device_mask = ir_device_mask[i];\r\n}\r\nreturn ret;\r\n}\r\nstatic ssize_t av7110_ir_proc_write(struct file *file, const char __user *buffer,\r\nsize_t count, loff_t *pos)\r\n{\r\nchar *page;\r\nu32 ir_config;\r\nint size = sizeof ir_config + sizeof av_list[0]->ir.key_map;\r\nint i;\r\nif (count < size)\r\nreturn -EINVAL;\r\npage = vmalloc(size);\r\nif (!page)\r\nreturn -ENOMEM;\r\nif (copy_from_user(page, buffer, size)) {\r\nvfree(page);\r\nreturn -EFAULT;\r\n}\r\nmemcpy(&ir_config, page, sizeof ir_config);\r\nfor (i = 0; i < av_cnt; i++) {\r\nmemcpy(av_list[i]->ir.key_map, page + sizeof ir_config,\r\nsizeof(av_list[i]->ir.key_map));\r\nir_protocol[i] = ir_config & 0x0001;\r\nir_inversion[i] = ir_config & 0x8000 ? 1 : 0;\r\nif (ir_config & 0x4000)\r\nir_device_mask[i] = 1 << ((ir_config >> 16) & 0x1f);\r\nelse\r\nir_device_mask[i] = IR_ALL;\r\nav7110_check_ir_config(av_list[i], false);\r\ninput_register_keys(&av_list[i]->ir);\r\n}\r\nvfree(page);\r\nreturn count;\r\n}\r\nstatic void ir_handler(struct av7110 *av7110, u32 ircom)\r\n{\r\ndprintk(4, "ir command = %08x\n", ircom);\r\nav7110->ir.ir_command = ircom;\r\ntasklet_schedule(&av7110->ir.ir_tasklet);\r\n}\r\nint av7110_ir_init(struct av7110 *av7110)\r\n{\r\nstruct input_dev *input_dev;\r\nstatic struct proc_dir_entry *e;\r\nint err;\r\nif (av_cnt >= ARRAY_SIZE(av_list))\r\nreturn -ENOSPC;\r\nav_list[av_cnt++] = av7110;\r\nav7110_check_ir_config(av7110, true);\r\ninit_timer(&av7110->ir.keyup_timer);\r\nav7110->ir.keyup_timer.function = av7110_emit_keyup;\r\nav7110->ir.keyup_timer.data = (unsigned long) &av7110->ir;\r\ninput_dev = input_allocate_device();\r\nif (!input_dev)\r\nreturn -ENOMEM;\r\nav7110->ir.input_dev = input_dev;\r\nsnprintf(av7110->ir.input_phys, sizeof(av7110->ir.input_phys),\r\n"pci-%s/ir0", pci_name(av7110->dev->pci));\r\ninput_dev->name = "DVB on-card IR receiver";\r\ninput_dev->phys = av7110->ir.input_phys;\r\ninput_dev->id.bustype = BUS_PCI;\r\ninput_dev->id.version = 2;\r\nif (av7110->dev->pci->subsystem_vendor) {\r\ninput_dev->id.vendor = av7110->dev->pci->subsystem_vendor;\r\ninput_dev->id.product = av7110->dev->pci->subsystem_device;\r\n} else {\r\ninput_dev->id.vendor = av7110->dev->pci->vendor;\r\ninput_dev->id.product = av7110->dev->pci->device;\r\n}\r\ninput_dev->dev.parent = &av7110->dev->pci->dev;\r\nmemcpy(av7110->ir.key_map, default_key_map, sizeof av7110->ir.key_map);\r\ninput_register_keys(&av7110->ir);\r\nerr = input_register_device(input_dev);\r\nif (err) {\r\ninput_free_device(input_dev);\r\nreturn err;\r\n}\r\ninput_dev->timer.function = input_repeat_key;\r\ninput_dev->timer.data = (unsigned long) &av7110->ir;\r\nif (av_cnt == 1) {\r\ne = proc_create("av7110_ir", S_IWUSR, NULL, &av7110_ir_proc_fops);\r\nif (e)\r\ne->size = 4 + 256 * sizeof(u16);\r\n}\r\ntasklet_init(&av7110->ir.ir_tasklet, av7110_emit_key, (unsigned long) &av7110->ir);\r\nav7110->ir.ir_handler = ir_handler;\r\nreturn 0;\r\n}\r\nvoid av7110_ir_exit(struct av7110 *av7110)\r\n{\r\nint i;\r\nif (av_cnt == 0)\r\nreturn;\r\ndel_timer_sync(&av7110->ir.keyup_timer);\r\nav7110->ir.ir_handler = NULL;\r\ntasklet_kill(&av7110->ir.ir_tasklet);\r\nfor (i = 0; i < av_cnt; i++)\r\nif (av_list[i] == av7110) {\r\nav_list[i] = av_list[av_cnt-1];\r\nav_list[av_cnt-1] = NULL;\r\nbreak;\r\n}\r\nif (av_cnt == 1)\r\nremove_proc_entry("av7110_ir", NULL);\r\ninput_unregister_device(av7110->ir.input_dev);\r\nav_cnt--;\r\n}

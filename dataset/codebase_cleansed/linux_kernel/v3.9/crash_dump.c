static int __init parse_savemaxmem(char *p)\r\n{\r\nif (p)\r\nsaved_max_pfn = (memparse(p, &p) >> PAGE_SHIFT) - 1;\r\nreturn 1;\r\n}\r\nssize_t copy_oldmem_page(unsigned long pfn, char *buf,\r\nsize_t csize, unsigned long offset, int userbuf)\r\n{\r\nvoid *vaddr;\r\nif (!csize)\r\nreturn 0;\r\nvaddr = kmap_atomic_pfn(pfn);\r\nif (!userbuf) {\r\nmemcpy(buf, (vaddr + offset), csize);\r\nkunmap_atomic(vaddr);\r\n} else {\r\nif (!kdump_buf_page) {\r\npr_warning("Kdump: Kdump buffer page not allocated\n");\r\nreturn -EFAULT;\r\n}\r\ncopy_page(kdump_buf_page, vaddr);\r\nkunmap_atomic(vaddr);\r\nif (copy_to_user(buf, (kdump_buf_page + offset), csize))\r\nreturn -EFAULT;\r\n}\r\nreturn csize;\r\n}\r\nstatic int __init kdump_buf_page_init(void)\r\n{\r\nint ret = 0;\r\nkdump_buf_page = kmalloc(PAGE_SIZE, GFP_KERNEL);\r\nif (!kdump_buf_page) {\r\npr_warning("Kdump: Failed to allocate kdump buffer page\n");\r\nret = -ENOMEM;\r\n}\r\nreturn ret;\r\n}

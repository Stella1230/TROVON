int string_get_size(u64 size, const enum string_size_units units,\r\nchar *buf, int len)\r\n{\r\nstatic const char *units_10[] = { "B", "kB", "MB", "GB", "TB", "PB",\r\n"EB", "ZB", "YB", NULL};\r\nstatic const char *units_2[] = {"B", "KiB", "MiB", "GiB", "TiB", "PiB",\r\n"EiB", "ZiB", "YiB", NULL };\r\nstatic const char **units_str[] = {\r\n[STRING_UNITS_10] = units_10,\r\n[STRING_UNITS_2] = units_2,\r\n};\r\nstatic const unsigned int divisor[] = {\r\n[STRING_UNITS_10] = 1000,\r\n[STRING_UNITS_2] = 1024,\r\n};\r\nint i, j;\r\nu64 remainder = 0, sf_cap;\r\nchar tmp[8];\r\ntmp[0] = '\0';\r\ni = 0;\r\nif (size >= divisor[units]) {\r\nwhile (size >= divisor[units] && units_str[units][i]) {\r\nremainder = do_div(size, divisor[units]);\r\ni++;\r\n}\r\nsf_cap = size;\r\nfor (j = 0; sf_cap*10 < 1000; j++)\r\nsf_cap *= 10;\r\nif (j) {\r\nremainder *= 1000;\r\ndo_div(remainder, divisor[units]);\r\nsnprintf(tmp, sizeof(tmp), ".%03lld",\r\n(unsigned long long)remainder);\r\ntmp[j+1] = '\0';\r\n}\r\n}\r\nsnprintf(buf, len, "%lld%s %s", (unsigned long long)size,\r\ntmp, units_str[units][i]);\r\nreturn 0;\r\n}

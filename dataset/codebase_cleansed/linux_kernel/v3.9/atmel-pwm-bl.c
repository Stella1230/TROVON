static int atmel_pwm_bl_set_intensity(struct backlight_device *bd)\r\n{\r\nstruct atmel_pwm_bl *pwmbl = bl_get_data(bd);\r\nint intensity = bd->props.brightness;\r\nint pwm_duty;\r\nif (bd->props.power != FB_BLANK_UNBLANK)\r\nintensity = 0;\r\nif (bd->props.fb_blank != FB_BLANK_UNBLANK)\r\nintensity = 0;\r\nif (pwmbl->pdata->pwm_active_low)\r\npwm_duty = pwmbl->pdata->pwm_duty_min + intensity;\r\nelse\r\npwm_duty = pwmbl->pdata->pwm_duty_max - intensity;\r\nif (pwm_duty > pwmbl->pdata->pwm_duty_max)\r\npwm_duty = pwmbl->pdata->pwm_duty_max;\r\nif (pwm_duty < pwmbl->pdata->pwm_duty_min)\r\npwm_duty = pwmbl->pdata->pwm_duty_min;\r\nif (!intensity) {\r\nif (pwmbl->gpio_on != -1) {\r\ngpio_set_value(pwmbl->gpio_on,\r\n0 ^ pwmbl->pdata->on_active_low);\r\n}\r\npwm_channel_writel(&pwmbl->pwmc, PWM_CUPD, pwm_duty);\r\npwm_channel_disable(&pwmbl->pwmc);\r\n} else {\r\npwm_channel_enable(&pwmbl->pwmc);\r\npwm_channel_writel(&pwmbl->pwmc, PWM_CUPD, pwm_duty);\r\nif (pwmbl->gpio_on != -1) {\r\ngpio_set_value(pwmbl->gpio_on,\r\n1 ^ pwmbl->pdata->on_active_low);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int atmel_pwm_bl_get_intensity(struct backlight_device *bd)\r\n{\r\nstruct atmel_pwm_bl *pwmbl = bl_get_data(bd);\r\nu8 intensity;\r\nif (pwmbl->pdata->pwm_active_low) {\r\nintensity = pwm_channel_readl(&pwmbl->pwmc, PWM_CDTY) -\r\npwmbl->pdata->pwm_duty_min;\r\n} else {\r\nintensity = pwmbl->pdata->pwm_duty_max -\r\npwm_channel_readl(&pwmbl->pwmc, PWM_CDTY);\r\n}\r\nreturn intensity;\r\n}\r\nstatic int atmel_pwm_bl_init_pwm(struct atmel_pwm_bl *pwmbl)\r\n{\r\nunsigned long pwm_rate = pwmbl->pwmc.mck;\r\nunsigned long prescale = DIV_ROUND_UP(pwm_rate,\r\n(pwmbl->pdata->pwm_frequency *\r\npwmbl->pdata->pwm_compare_max)) - 1;\r\nprescale = fls(prescale);\r\nif (prescale > 0xf)\r\nprescale = 0xf;\r\npwm_channel_writel(&pwmbl->pwmc, PWM_CMR, prescale);\r\npwm_channel_writel(&pwmbl->pwmc, PWM_CDTY,\r\npwmbl->pdata->pwm_duty_min +\r\npwmbl->bldev->props.brightness);\r\npwm_channel_writel(&pwmbl->pwmc, PWM_CPRD,\r\npwmbl->pdata->pwm_compare_max);\r\ndev_info(&pwmbl->pdev->dev, "Atmel PWM backlight driver (%lu Hz)\n",\r\npwmbl->pwmc.mck / pwmbl->pdata->pwm_compare_max /\r\n(1 << prescale));\r\nreturn pwm_channel_enable(&pwmbl->pwmc);\r\n}\r\nstatic int atmel_pwm_bl_probe(struct platform_device *pdev)\r\n{\r\nstruct backlight_properties props;\r\nconst struct atmel_pwm_bl_platform_data *pdata;\r\nstruct backlight_device *bldev;\r\nstruct atmel_pwm_bl *pwmbl;\r\nint retval;\r\npwmbl = devm_kzalloc(&pdev->dev, sizeof(struct atmel_pwm_bl),\r\nGFP_KERNEL);\r\nif (!pwmbl)\r\nreturn -ENOMEM;\r\npwmbl->pdev = pdev;\r\npdata = pdev->dev.platform_data;\r\nif (!pdata) {\r\nretval = -ENODEV;\r\ngoto err_free_mem;\r\n}\r\nif (pdata->pwm_compare_max < pdata->pwm_duty_max ||\r\npdata->pwm_duty_min > pdata->pwm_duty_max ||\r\npdata->pwm_frequency == 0) {\r\nretval = -EINVAL;\r\ngoto err_free_mem;\r\n}\r\npwmbl->pdata = pdata;\r\npwmbl->gpio_on = pdata->gpio_on;\r\nretval = pwm_channel_alloc(pdata->pwm_channel, &pwmbl->pwmc);\r\nif (retval)\r\ngoto err_free_mem;\r\nif (pwmbl->gpio_on != -1) {\r\nretval = devm_gpio_request(&pdev->dev, pwmbl->gpio_on,\r\n"gpio_atmel_pwm_bl");\r\nif (retval) {\r\npwmbl->gpio_on = -1;\r\ngoto err_free_pwm;\r\n}\r\nretval = gpio_direction_output(pwmbl->gpio_on,\r\n0 ^ pdata->on_active_low);\r\nif (retval)\r\ngoto err_free_pwm;\r\n}\r\nmemset(&props, 0, sizeof(struct backlight_properties));\r\nprops.type = BACKLIGHT_RAW;\r\nprops.max_brightness = pdata->pwm_duty_max - pdata->pwm_duty_min;\r\nbldev = backlight_device_register("atmel-pwm-bl", &pdev->dev, pwmbl,\r\n&atmel_pwm_bl_ops, &props);\r\nif (IS_ERR(bldev)) {\r\nretval = PTR_ERR(bldev);\r\ngoto err_free_pwm;\r\n}\r\npwmbl->bldev = bldev;\r\nplatform_set_drvdata(pdev, pwmbl);\r\nbldev->props.power = FB_BLANK_UNBLANK;\r\nbldev->props.brightness = bldev->props.max_brightness / 2;\r\nretval = atmel_pwm_bl_init_pwm(pwmbl);\r\nif (retval)\r\ngoto err_free_bl_dev;\r\natmel_pwm_bl_set_intensity(bldev);\r\nreturn 0;\r\nerr_free_bl_dev:\r\nplatform_set_drvdata(pdev, NULL);\r\nbacklight_device_unregister(bldev);\r\nerr_free_pwm:\r\npwm_channel_free(&pwmbl->pwmc);\r\nerr_free_mem:\r\nreturn retval;\r\n}\r\nstatic int __exit atmel_pwm_bl_remove(struct platform_device *pdev)\r\n{\r\nstruct atmel_pwm_bl *pwmbl = platform_get_drvdata(pdev);\r\nif (pwmbl->gpio_on != -1)\r\ngpio_set_value(pwmbl->gpio_on, 0);\r\npwm_channel_disable(&pwmbl->pwmc);\r\npwm_channel_free(&pwmbl->pwmc);\r\nbacklight_device_unregister(pwmbl->bldev);\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn 0;\r\n}\r\nstatic int __init atmel_pwm_bl_init(void)\r\n{\r\nreturn platform_driver_probe(&atmel_pwm_bl_driver, atmel_pwm_bl_probe);\r\n}\r\nstatic void __exit atmel_pwm_bl_exit(void)\r\n{\r\nplatform_driver_unregister(&atmel_pwm_bl_driver);\r\n}

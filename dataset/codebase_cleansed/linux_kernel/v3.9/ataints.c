static unsigned int atari_irq_startup(struct irq_data *data)\r\n{\r\nunsigned int irq = data->irq;\r\nm68k_irq_startup(data);\r\natari_turnon_irq(irq);\r\natari_enable_irq(irq);\r\nreturn 0;\r\n}\r\nstatic void atari_irq_shutdown(struct irq_data *data)\r\n{\r\nunsigned int irq = data->irq;\r\natari_disable_irq(irq);\r\natari_turnoff_irq(irq);\r\nm68k_irq_shutdown(data);\r\nif (irq == IRQ_AUTO_4)\r\nvectors[VEC_INT4] = falcon_hblhandler;\r\n}\r\nstatic void atari_irq_enable(struct irq_data *data)\r\n{\r\natari_enable_irq(data->irq);\r\n}\r\nstatic void atari_irq_disable(struct irq_data *data)\r\n{\r\natari_disable_irq(data->irq);\r\n}\r\nvoid __init atari_init_IRQ(void)\r\n{\r\nm68k_setup_user_interrupt(VEC_USER, NUM_ATARI_SOURCES - IRQ_USER);\r\nm68k_setup_irq_controller(&atari_irq_chip, handle_simple_irq, 1,\r\nNUM_ATARI_SOURCES - 1);\r\n#ifdef ATARI_USE_SOFTWARE_EOI\r\nst_mfp.vec_adr = 0x48;\r\n#else\r\nst_mfp.vec_adr = 0x40;\r\n#endif\r\nst_mfp.int_en_a = 0x00;\r\nst_mfp.int_en_b = 0x00;\r\nst_mfp.int_mk_a = 0xff;\r\nst_mfp.int_mk_b = 0xff;\r\nif (ATARIHW_PRESENT(TT_MFP)) {\r\n#ifdef ATARI_USE_SOFTWARE_EOI\r\ntt_mfp.vec_adr = 0x58;\r\n#else\r\ntt_mfp.vec_adr = 0x50;\r\n#endif\r\ntt_mfp.int_en_a = 0x00;\r\ntt_mfp.int_en_b = 0x00;\r\ntt_mfp.int_mk_a = 0xff;\r\ntt_mfp.int_mk_b = 0xff;\r\n}\r\nif (ATARIHW_PRESENT(SCC) && !atari_SCC_reset_done) {\r\natari_scc.cha_a_ctrl = 9;\r\nMFPDELAY();\r\natari_scc.cha_a_ctrl = (char) 0xc0;\r\n}\r\nif (ATARIHW_PRESENT(SCU)) {\r\ntt_scu.sys_mask = 0x10;\r\ntt_scu.vme_mask = 0x60;\r\n} else {\r\nvectors[VEC_INT2] = falcon_hblhandler;\r\nvectors[VEC_INT4] = falcon_hblhandler;\r\n}\r\nif (ATARIHW_PRESENT(PCM_8BIT) && ATARIHW_PRESENT(MICROWIRE)) {\r\natari_microwire_cmd(MW_LM1992_PSG_HIGH);\r\n}\r\nstdma_init();\r\nsound_ym.rd_data_reg_sel = 7;\r\nsound_ym.wd_data = 0xff;\r\n}\r\nunsigned int atari_register_vme_int(void)\r\n{\r\nint i;\r\nfor (i = 0; i < 32; i++)\r\nif ((free_vme_vec_bitmap & (1 << i)) == 0)\r\nbreak;\r\nif (i == 16)\r\nreturn 0;\r\nfree_vme_vec_bitmap |= 1 << i;\r\nreturn VME_SOURCE_BASE + i;\r\n}\r\nvoid atari_unregister_vme_int(unsigned int irq)\r\n{\r\nif (irq >= VME_SOURCE_BASE && irq < VME_SOURCE_BASE + VME_MAX_SOURCES) {\r\nirq -= VME_SOURCE_BASE;\r\nfree_vme_vec_bitmap &= ~(1 << irq);\r\n}\r\n}

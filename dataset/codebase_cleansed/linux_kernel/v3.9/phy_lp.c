static inline u16 channel2freq_lp(u8 channel)\r\n{\r\nif (channel < 14)\r\nreturn (2407 + 5 * channel);\r\nelse if (channel == 14)\r\nreturn 2484;\r\nelse if (channel < 184)\r\nreturn (5000 + 5 * channel);\r\nelse\r\nreturn (4000 + 5 * channel);\r\n}\r\nstatic unsigned int b43_lpphy_op_get_default_chan(struct b43_wldev *dev)\r\n{\r\nif (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ)\r\nreturn 1;\r\nreturn 36;\r\n}\r\nstatic int b43_lpphy_op_allocate(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_lp *lpphy;\r\nlpphy = kzalloc(sizeof(*lpphy), GFP_KERNEL);\r\nif (!lpphy)\r\nreturn -ENOMEM;\r\ndev->phy.lp = lpphy;\r\nreturn 0;\r\n}\r\nstatic void b43_lpphy_op_prepare_structs(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_lp *lpphy = phy->lp;\r\nmemset(lpphy, 0, sizeof(*lpphy));\r\nlpphy->antenna = B43_ANTENNA_DEFAULT;\r\n}\r\nstatic void b43_lpphy_op_free(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_lp *lpphy = dev->phy.lp;\r\nkfree(lpphy);\r\ndev->phy.lp = NULL;\r\n}\r\nstatic void lpphy_read_band_sprom(struct b43_wldev *dev)\r\n{\r\nstruct ssb_sprom *sprom = dev->dev->bus_sprom;\r\nstruct b43_phy_lp *lpphy = dev->phy.lp;\r\nu16 cckpo, maxpwr;\r\nu32 ofdmpo;\r\nint i;\r\nif (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ) {\r\nlpphy->tx_isolation_med_band = sprom->tri2g;\r\nlpphy->bx_arch = sprom->bxa2g;\r\nlpphy->rx_pwr_offset = sprom->rxpo2g;\r\nlpphy->rssi_vf = sprom->rssismf2g;\r\nlpphy->rssi_vc = sprom->rssismc2g;\r\nlpphy->rssi_gs = sprom->rssisav2g;\r\nlpphy->txpa[0] = sprom->pa0b0;\r\nlpphy->txpa[1] = sprom->pa0b1;\r\nlpphy->txpa[2] = sprom->pa0b2;\r\nmaxpwr = sprom->maxpwr_bg;\r\nlpphy->max_tx_pwr_med_band = maxpwr;\r\ncckpo = sprom->cck2gpo;\r\nB43_WARN_ON(sprom->revision < 8);\r\nofdmpo = sprom->ofdm2gpo;\r\nif (cckpo) {\r\nfor (i = 0; i < 4; i++) {\r\nlpphy->tx_max_rate[i] =\r\nmaxpwr - (ofdmpo & 0xF) * 2;\r\nofdmpo >>= 4;\r\n}\r\nofdmpo = sprom->ofdm2gpo;\r\nfor (i = 4; i < 15; i++) {\r\nlpphy->tx_max_rate[i] =\r\nmaxpwr - (ofdmpo & 0xF) * 2;\r\nofdmpo >>= 4;\r\n}\r\n} else {\r\nofdmpo &= 0xFF;\r\nfor (i = 0; i < 4; i++)\r\nlpphy->tx_max_rate[i] = maxpwr;\r\nfor (i = 4; i < 15; i++)\r\nlpphy->tx_max_rate[i] = maxpwr - ofdmpo;\r\n}\r\n} else {\r\nlpphy->tx_isolation_low_band = sprom->tri5gl;\r\nlpphy->tx_isolation_med_band = sprom->tri5g;\r\nlpphy->tx_isolation_hi_band = sprom->tri5gh;\r\nlpphy->bx_arch = sprom->bxa5g;\r\nlpphy->rx_pwr_offset = sprom->rxpo5g;\r\nlpphy->rssi_vf = sprom->rssismf5g;\r\nlpphy->rssi_vc = sprom->rssismc5g;\r\nlpphy->rssi_gs = sprom->rssisav5g;\r\nlpphy->txpa[0] = sprom->pa1b0;\r\nlpphy->txpa[1] = sprom->pa1b1;\r\nlpphy->txpa[2] = sprom->pa1b2;\r\nlpphy->txpal[0] = sprom->pa1lob0;\r\nlpphy->txpal[1] = sprom->pa1lob1;\r\nlpphy->txpal[2] = sprom->pa1lob2;\r\nlpphy->txpah[0] = sprom->pa1hib0;\r\nlpphy->txpah[1] = sprom->pa1hib1;\r\nlpphy->txpah[2] = sprom->pa1hib2;\r\nmaxpwr = sprom->maxpwr_al;\r\nofdmpo = sprom->ofdm5glpo;\r\nlpphy->max_tx_pwr_low_band = maxpwr;\r\nfor (i = 4; i < 12; i++) {\r\nlpphy->tx_max_ratel[i] = maxpwr - (ofdmpo & 0xF) * 2;\r\nofdmpo >>= 4;\r\n}\r\nmaxpwr = sprom->maxpwr_a;\r\nofdmpo = sprom->ofdm5gpo;\r\nlpphy->max_tx_pwr_med_band = maxpwr;\r\nfor (i = 4; i < 12; i++) {\r\nlpphy->tx_max_rate[i] = maxpwr - (ofdmpo & 0xF) * 2;\r\nofdmpo >>= 4;\r\n}\r\nmaxpwr = sprom->maxpwr_ah;\r\nofdmpo = sprom->ofdm5ghpo;\r\nlpphy->max_tx_pwr_hi_band = maxpwr;\r\nfor (i = 4; i < 12; i++) {\r\nlpphy->tx_max_rateh[i] = maxpwr - (ofdmpo & 0xF) * 2;\r\nofdmpo >>= 4;\r\n}\r\n}\r\n}\r\nstatic void lpphy_adjust_gain_table(struct b43_wldev *dev, u32 freq)\r\n{\r\nstruct b43_phy_lp *lpphy = dev->phy.lp;\r\nu16 temp[3];\r\nu16 isolation;\r\nB43_WARN_ON(dev->phy.rev >= 2);\r\nif (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ)\r\nisolation = lpphy->tx_isolation_med_band;\r\nelse if (freq <= 5320)\r\nisolation = lpphy->tx_isolation_low_band;\r\nelse if (freq <= 5700)\r\nisolation = lpphy->tx_isolation_med_band;\r\nelse\r\nisolation = lpphy->tx_isolation_hi_band;\r\ntemp[0] = ((isolation - 26) / 12) << 12;\r\ntemp[1] = temp[0] + 0x1000;\r\ntemp[2] = temp[0] + 0x2000;\r\nb43_lptab_write_bulk(dev, B43_LPTAB16(13, 0), 3, temp);\r\nb43_lptab_write_bulk(dev, B43_LPTAB16(12, 0), 3, temp);\r\n}\r\nstatic void lpphy_table_init(struct b43_wldev *dev)\r\n{\r\nu32 freq = channel2freq_lp(b43_lpphy_op_get_default_chan(dev));\r\nif (dev->phy.rev < 2)\r\nlpphy_rev0_1_table_init(dev);\r\nelse\r\nlpphy_rev2plus_table_init(dev);\r\nlpphy_init_tx_gain_table(dev);\r\nif (dev->phy.rev < 2)\r\nlpphy_adjust_gain_table(dev, freq);\r\n}\r\nstatic void lpphy_baseband_rev0_1_init(struct b43_wldev *dev)\r\n{\r\nstruct ssb_bus *bus = dev->dev->sdev->bus;\r\nstruct ssb_sprom *sprom = dev->dev->bus_sprom;\r\nstruct b43_phy_lp *lpphy = dev->phy.lp;\r\nu16 tmp, tmp2;\r\nb43_phy_mask(dev, B43_LPPHY_AFE_DAC_CTL, 0xF7FF);\r\nb43_phy_write(dev, B43_LPPHY_AFE_CTL, 0);\r\nb43_phy_write(dev, B43_LPPHY_AFE_CTL_OVR, 0);\r\nb43_phy_write(dev, B43_LPPHY_RF_OVERRIDE_0, 0);\r\nb43_phy_write(dev, B43_LPPHY_RF_OVERRIDE_2, 0);\r\nb43_phy_set(dev, B43_LPPHY_AFE_DAC_CTL, 0x0004);\r\nb43_phy_maskset(dev, B43_LPPHY_OFDMSYNCTHRESH0, 0xFF00, 0x0078);\r\nb43_phy_maskset(dev, B43_LPPHY_CLIPCTRTHRESH, 0x83FF, 0x5800);\r\nb43_phy_write(dev, B43_LPPHY_ADC_COMPENSATION_CTL, 0x0016);\r\nb43_phy_maskset(dev, B43_LPPHY_AFE_ADC_CTL_0, 0xFFF8, 0x0004);\r\nb43_phy_maskset(dev, B43_LPPHY_VERYLOWGAINDB, 0x00FF, 0x5400);\r\nb43_phy_maskset(dev, B43_LPPHY_HIGAINDB, 0x00FF, 0x2400);\r\nb43_phy_maskset(dev, B43_LPPHY_LOWGAINDB, 0x00FF, 0x2100);\r\nb43_phy_maskset(dev, B43_LPPHY_VERYLOWGAINDB, 0xFF00, 0x0006);\r\nb43_phy_mask(dev, B43_LPPHY_RX_RADIO_CTL, 0xFFFE);\r\nb43_phy_maskset(dev, B43_LPPHY_CLIPCTRTHRESH, 0xFFE0, 0x0005);\r\nb43_phy_maskset(dev, B43_LPPHY_CLIPCTRTHRESH, 0xFC1F, 0x0180);\r\nb43_phy_maskset(dev, B43_LPPHY_CLIPCTRTHRESH, 0x83FF, 0x3C00);\r\nb43_phy_maskset(dev, B43_LPPHY_GAINDIRECTMISMATCH, 0xFFF0, 0x0005);\r\nb43_phy_maskset(dev, B43_LPPHY_GAIN_MISMATCH_LIMIT, 0xFFC0, 0x001A);\r\nb43_phy_maskset(dev, B43_LPPHY_CRS_ED_THRESH, 0xFF00, 0x00B3);\r\nb43_phy_maskset(dev, B43_LPPHY_CRS_ED_THRESH, 0x00FF, 0xAD00);\r\nb43_phy_maskset(dev, B43_LPPHY_INPUT_PWRDB,\r\n0xFF00, lpphy->rx_pwr_offset);\r\nif ((sprom->boardflags_lo & B43_BFL_FEM) &&\r\n((b43_current_band(dev->wl) == IEEE80211_BAND_5GHZ) ||\r\n(sprom->boardflags_hi & B43_BFH_PAREF))) {\r\nssb_pmu_set_ldo_voltage(&bus->chipco, LDO_PAREF, 0x28);\r\nssb_pmu_set_ldo_paref(&bus->chipco, true);\r\nif (dev->phy.rev == 0) {\r\nb43_phy_maskset(dev, B43_LPPHY_LP_RF_SIGNAL_LUT,\r\n0xFFCF, 0x0010);\r\n}\r\nb43_lptab_write(dev, B43_LPTAB16(11, 7), 60);\r\n} else {\r\nssb_pmu_set_ldo_paref(&bus->chipco, false);\r\nb43_phy_maskset(dev, B43_LPPHY_LP_RF_SIGNAL_LUT,\r\n0xFFCF, 0x0020);\r\nb43_lptab_write(dev, B43_LPTAB16(11, 7), 100);\r\n}\r\ntmp = lpphy->rssi_vf | lpphy->rssi_vc << 4 | 0xA000;\r\nb43_phy_write(dev, B43_LPPHY_AFE_RSSI_CTL_0, tmp);\r\nif (sprom->boardflags_hi & B43_BFH_RSSIINV)\r\nb43_phy_maskset(dev, B43_LPPHY_AFE_RSSI_CTL_1, 0xF000, 0x0AAA);\r\nelse\r\nb43_phy_maskset(dev, B43_LPPHY_AFE_RSSI_CTL_1, 0xF000, 0x02AA);\r\nb43_lptab_write(dev, B43_LPTAB16(11, 1), 24);\r\nb43_phy_maskset(dev, B43_LPPHY_RX_RADIO_CTL,\r\n0xFFF9, (lpphy->bx_arch << 1));\r\nif (dev->phy.rev == 1 &&\r\n(sprom->boardflags_hi & B43_BFH_FEM_BT)) {\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_1, 0xFFC0, 0x000A);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_1, 0x3F00, 0x0900);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_2, 0xFFC0, 0x000A);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_2, 0xC0FF, 0x0B00);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_3, 0xFFC0, 0x000A);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_3, 0xC0FF, 0x0400);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_4, 0xFFC0, 0x000A);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_4, 0xC0FF, 0x0B00);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_5, 0xFFC0, 0x000A);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_5, 0xC0FF, 0x0900);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_6, 0xFFC0, 0x000A);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_6, 0xC0FF, 0x0B00);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_7, 0xFFC0, 0x000A);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_7, 0xC0FF, 0x0900);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_8, 0xFFC0, 0x000A);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_8, 0xC0FF, 0x0B00);\r\n} else if (b43_current_band(dev->wl) == IEEE80211_BAND_5GHZ ||\r\n(dev->dev->board_type == 0x048A) || ((dev->phy.rev == 0) &&\r\n(sprom->boardflags_lo & B43_BFL_FEM))) {\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_1, 0xFFC0, 0x0001);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_1, 0xC0FF, 0x0400);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_2, 0xFFC0, 0x0001);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_2, 0xC0FF, 0x0500);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_3, 0xFFC0, 0x0002);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_3, 0xC0FF, 0x0800);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_4, 0xFFC0, 0x0002);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_4, 0xC0FF, 0x0A00);\r\n} else if (dev->phy.rev == 1 ||\r\n(sprom->boardflags_lo & B43_BFL_FEM)) {\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_1, 0xFFC0, 0x0004);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_1, 0xC0FF, 0x0800);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_2, 0xFFC0, 0x0004);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_2, 0xC0FF, 0x0C00);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_3, 0xFFC0, 0x0002);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_3, 0xC0FF, 0x0100);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_4, 0xFFC0, 0x0002);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_4, 0xC0FF, 0x0300);\r\n} else {\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_1, 0xFFC0, 0x000A);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_1, 0xC0FF, 0x0900);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_2, 0xFFC0, 0x000A);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_2, 0xC0FF, 0x0B00);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_3, 0xFFC0, 0x0006);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_3, 0xC0FF, 0x0500);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_4, 0xFFC0, 0x0006);\r\nb43_phy_maskset(dev, B43_LPPHY_TR_LOOKUP_4, 0xC0FF, 0x0700);\r\n}\r\nif (dev->phy.rev == 1 && (sprom->boardflags_hi & B43_BFH_PAREF)) {\r\nb43_phy_copy(dev, B43_LPPHY_TR_LOOKUP_5, B43_LPPHY_TR_LOOKUP_1);\r\nb43_phy_copy(dev, B43_LPPHY_TR_LOOKUP_6, B43_LPPHY_TR_LOOKUP_2);\r\nb43_phy_copy(dev, B43_LPPHY_TR_LOOKUP_7, B43_LPPHY_TR_LOOKUP_3);\r\nb43_phy_copy(dev, B43_LPPHY_TR_LOOKUP_8, B43_LPPHY_TR_LOOKUP_4);\r\n}\r\nif ((sprom->boardflags_hi & B43_BFH_FEM_BT) &&\r\n(dev->dev->chip_id == 0x5354) &&\r\n(dev->dev->chip_pkg == SSB_CHIPPACK_BCM4712S)) {\r\nb43_phy_set(dev, B43_LPPHY_CRSGAIN_CTL, 0x0006);\r\nb43_phy_write(dev, B43_LPPHY_GPIO_SELECT, 0x0005);\r\nb43_phy_write(dev, B43_LPPHY_GPIO_OUTEN, 0xFFFF);\r\nb43_hf_write(dev, b43_hf_read(dev) | B43_HF_PR45960W);\r\n}\r\nif (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ) {\r\nb43_phy_set(dev, B43_LPPHY_LP_PHY_CTL, 0x8000);\r\nb43_phy_set(dev, B43_LPPHY_CRSGAIN_CTL, 0x0040);\r\nb43_phy_maskset(dev, B43_LPPHY_MINPWR_LEVEL, 0x00FF, 0xA400);\r\nb43_phy_maskset(dev, B43_LPPHY_CRSGAIN_CTL, 0xF0FF, 0x0B00);\r\nb43_phy_maskset(dev, B43_LPPHY_SYNCPEAKCNT, 0xFFF8, 0x0007);\r\nb43_phy_maskset(dev, B43_LPPHY_DSSS_CONFIRM_CNT, 0xFFF8, 0x0003);\r\nb43_phy_maskset(dev, B43_LPPHY_DSSS_CONFIRM_CNT, 0xFFC7, 0x0020);\r\nb43_phy_mask(dev, B43_LPPHY_IDLEAFTERPKTRXTO, 0x00FF);\r\n} else {\r\nb43_phy_mask(dev, B43_LPPHY_LP_PHY_CTL, 0x7FFF);\r\nb43_phy_mask(dev, B43_LPPHY_CRSGAIN_CTL, 0xFFBF);\r\n}\r\nif (dev->phy.rev == 1) {\r\ntmp = b43_phy_read(dev, B43_LPPHY_CLIPCTRTHRESH);\r\ntmp2 = (tmp & 0x03E0) >> 5;\r\ntmp2 |= tmp2 << 5;\r\nb43_phy_write(dev, B43_LPPHY_4C3, tmp2);\r\ntmp = b43_phy_read(dev, B43_LPPHY_GAINDIRECTMISMATCH);\r\ntmp2 = (tmp & 0x1F00) >> 8;\r\ntmp2 |= tmp2 << 5;\r\nb43_phy_write(dev, B43_LPPHY_4C4, tmp2);\r\ntmp = b43_phy_read(dev, B43_LPPHY_VERYLOWGAINDB);\r\ntmp2 = tmp & 0x00FF;\r\ntmp2 |= tmp << 8;\r\nb43_phy_write(dev, B43_LPPHY_4C5, tmp2);\r\n}\r\n}\r\nstatic void lpphy_save_dig_flt_state(struct b43_wldev *dev)\r\n{\r\nstatic const u16 addr[] = {\r\nB43_PHY_OFDM(0xC1),\r\nB43_PHY_OFDM(0xC2),\r\nB43_PHY_OFDM(0xC3),\r\nB43_PHY_OFDM(0xC4),\r\nB43_PHY_OFDM(0xC5),\r\nB43_PHY_OFDM(0xC6),\r\nB43_PHY_OFDM(0xC7),\r\nB43_PHY_OFDM(0xC8),\r\nB43_PHY_OFDM(0xCF),\r\n};\r\nstatic const u16 coefs[] = {\r\n0xDE5E, 0xE832, 0xE331, 0x4D26,\r\n0x0026, 0x1420, 0x0020, 0xFE08,\r\n0x0008,\r\n};\r\nstruct b43_phy_lp *lpphy = dev->phy.lp;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(addr); i++) {\r\nlpphy->dig_flt_state[i] = b43_phy_read(dev, addr[i]);\r\nb43_phy_write(dev, addr[i], coefs[i]);\r\n}\r\n}\r\nstatic void lpphy_restore_dig_flt_state(struct b43_wldev *dev)\r\n{\r\nstatic const u16 addr[] = {\r\nB43_PHY_OFDM(0xC1),\r\nB43_PHY_OFDM(0xC2),\r\nB43_PHY_OFDM(0xC3),\r\nB43_PHY_OFDM(0xC4),\r\nB43_PHY_OFDM(0xC5),\r\nB43_PHY_OFDM(0xC6),\r\nB43_PHY_OFDM(0xC7),\r\nB43_PHY_OFDM(0xC8),\r\nB43_PHY_OFDM(0xCF),\r\n};\r\nstruct b43_phy_lp *lpphy = dev->phy.lp;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(addr); i++)\r\nb43_phy_write(dev, addr[i], lpphy->dig_flt_state[i]);\r\n}\r\nstatic void lpphy_baseband_rev2plus_init(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_lp *lpphy = dev->phy.lp;\r\nb43_phy_write(dev, B43_LPPHY_AFE_DAC_CTL, 0x50);\r\nb43_phy_write(dev, B43_LPPHY_AFE_CTL, 0x8800);\r\nb43_phy_write(dev, B43_LPPHY_AFE_CTL_OVR, 0);\r\nb43_phy_write(dev, B43_LPPHY_AFE_CTL_OVRVAL, 0);\r\nb43_phy_write(dev, B43_LPPHY_RF_OVERRIDE_0, 0);\r\nb43_phy_write(dev, B43_LPPHY_RF_OVERRIDE_2, 0);\r\nb43_phy_write(dev, B43_PHY_OFDM(0xF9), 0);\r\nb43_phy_write(dev, B43_LPPHY_TR_LOOKUP_1, 0);\r\nb43_phy_set(dev, B43_LPPHY_ADC_COMPENSATION_CTL, 0x10);\r\nb43_phy_maskset(dev, B43_LPPHY_OFDMSYNCTHRESH0, 0xFF00, 0xB4);\r\nb43_phy_maskset(dev, B43_LPPHY_DCOFFSETTRANSIENT, 0xF8FF, 0x200);\r\nb43_phy_maskset(dev, B43_LPPHY_DCOFFSETTRANSIENT, 0xFF00, 0x7F);\r\nb43_phy_maskset(dev, B43_LPPHY_GAINDIRECTMISMATCH, 0xFF0F, 0x40);\r\nb43_phy_maskset(dev, B43_LPPHY_PREAMBLECONFIRMTO, 0xFF00, 0x2);\r\nb43_phy_mask(dev, B43_LPPHY_CRSGAIN_CTL, ~0x4000);\r\nb43_phy_mask(dev, B43_LPPHY_CRSGAIN_CTL, ~0x2000);\r\nb43_phy_set(dev, B43_PHY_OFDM(0x10A), 0x1);\r\nif (dev->dev->board_rev >= 0x18) {\r\nb43_lptab_write(dev, B43_LPTAB32(17, 65), 0xEC);\r\nb43_phy_maskset(dev, B43_PHY_OFDM(0x10A), 0xFF01, 0x14);\r\n} else {\r\nb43_phy_maskset(dev, B43_PHY_OFDM(0x10A), 0xFF01, 0x10);\r\n}\r\nb43_phy_maskset(dev, B43_PHY_OFDM(0xDF), 0xFF00, 0xF4);\r\nb43_phy_maskset(dev, B43_PHY_OFDM(0xDF), 0x00FF, 0xF100);\r\nb43_phy_write(dev, B43_LPPHY_CLIPTHRESH, 0x48);\r\nb43_phy_maskset(dev, B43_LPPHY_HIGAINDB, 0xFF00, 0x46);\r\nb43_phy_maskset(dev, B43_PHY_OFDM(0xE4), 0xFF00, 0x10);\r\nb43_phy_maskset(dev, B43_LPPHY_PWR_THRESH1, 0xFFF0, 0x9);\r\nb43_phy_mask(dev, B43_LPPHY_GAINDIRECTMISMATCH, ~0xF);\r\nb43_phy_maskset(dev, B43_LPPHY_VERYLOWGAINDB, 0x00FF, 0x5500);\r\nb43_phy_maskset(dev, B43_LPPHY_CLIPCTRTHRESH, 0xFC1F, 0xA0);\r\nb43_phy_maskset(dev, B43_LPPHY_GAINDIRECTMISMATCH, 0xE0FF, 0x300);\r\nb43_phy_maskset(dev, B43_LPPHY_HIGAINDB, 0x00FF, 0x2A00);\r\nif ((dev->dev->chip_id == 0x4325) && (dev->dev->chip_rev == 0)) {\r\nb43_phy_maskset(dev, B43_LPPHY_LOWGAINDB, 0x00FF, 0x2100);\r\nb43_phy_maskset(dev, B43_LPPHY_VERYLOWGAINDB, 0xFF00, 0xA);\r\n} else {\r\nb43_phy_maskset(dev, B43_LPPHY_LOWGAINDB, 0x00FF, 0x1E00);\r\nb43_phy_maskset(dev, B43_LPPHY_VERYLOWGAINDB, 0xFF00, 0xD);\r\n}\r\nb43_phy_maskset(dev, B43_PHY_OFDM(0xFE), 0xFFE0, 0x1F);\r\nb43_phy_maskset(dev, B43_PHY_OFDM(0xFF), 0xFFE0, 0xC);\r\nb43_phy_maskset(dev, B43_PHY_OFDM(0x100), 0xFF00, 0x19);\r\nb43_phy_maskset(dev, B43_PHY_OFDM(0xFF), 0x03FF, 0x3C00);\r\nb43_phy_maskset(dev, B43_PHY_OFDM(0xFE), 0xFC1F, 0x3E0);\r\nb43_phy_maskset(dev, B43_PHY_OFDM(0xFF), 0xFFE0, 0xC);\r\nb43_phy_maskset(dev, B43_PHY_OFDM(0x100), 0x00FF, 0x1900);\r\nb43_phy_maskset(dev, B43_LPPHY_CLIPCTRTHRESH, 0x83FF, 0x5800);\r\nb43_phy_maskset(dev, B43_LPPHY_CLIPCTRTHRESH, 0xFFE0, 0x12);\r\nb43_phy_maskset(dev, B43_LPPHY_GAINMISMATCH, 0x0FFF, 0x9000);\r\nif ((dev->dev->chip_id == 0x4325) && (dev->dev->chip_rev == 0)) {\r\nb43_lptab_write(dev, B43_LPTAB16(0x08, 0x14), 0);\r\nb43_lptab_write(dev, B43_LPTAB16(0x08, 0x12), 0x40);\r\n}\r\nif (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ) {\r\nb43_phy_set(dev, B43_LPPHY_CRSGAIN_CTL, 0x40);\r\nb43_phy_maskset(dev, B43_LPPHY_CRSGAIN_CTL, 0xF0FF, 0xB00);\r\nb43_phy_maskset(dev, B43_LPPHY_SYNCPEAKCNT, 0xFFF8, 0x6);\r\nb43_phy_maskset(dev, B43_LPPHY_MINPWR_LEVEL, 0x00FF, 0x9D00);\r\nb43_phy_maskset(dev, B43_LPPHY_MINPWR_LEVEL, 0xFF00, 0xA1);\r\nb43_phy_mask(dev, B43_LPPHY_IDLEAFTERPKTRXTO, 0x00FF);\r\n} else\r\nb43_phy_mask(dev, B43_LPPHY_CRSGAIN_CTL, ~0x40);\r\nb43_phy_maskset(dev, B43_LPPHY_CRS_ED_THRESH, 0xFF00, 0xB3);\r\nb43_phy_maskset(dev, B43_LPPHY_CRS_ED_THRESH, 0x00FF, 0xAD00);\r\nb43_phy_maskset(dev, B43_LPPHY_INPUT_PWRDB, 0xFF00, lpphy->rx_pwr_offset);\r\nb43_phy_set(dev, B43_LPPHY_RESET_CTL, 0x44);\r\nb43_phy_write(dev, B43_LPPHY_RESET_CTL, 0x80);\r\nb43_phy_write(dev, B43_LPPHY_AFE_RSSI_CTL_0, 0xA954);\r\nb43_phy_write(dev, B43_LPPHY_AFE_RSSI_CTL_1,\r\n0x2000 | ((u16)lpphy->rssi_gs << 10) |\r\n((u16)lpphy->rssi_vc << 4) | lpphy->rssi_vf);\r\nif ((dev->dev->chip_id == 0x4325) && (dev->dev->chip_rev == 0)) {\r\nb43_phy_set(dev, B43_LPPHY_AFE_ADC_CTL_0, 0x1C);\r\nb43_phy_maskset(dev, B43_LPPHY_AFE_CTL, 0x00FF, 0x8800);\r\nb43_phy_maskset(dev, B43_LPPHY_AFE_ADC_CTL_1, 0xFC3C, 0x0400);\r\n}\r\nlpphy_save_dig_flt_state(dev);\r\n}\r\nstatic void lpphy_baseband_init(struct b43_wldev *dev)\r\n{\r\nlpphy_table_init(dev);\r\nif (dev->phy.rev >= 2)\r\nlpphy_baseband_rev2plus_init(dev);\r\nelse\r\nlpphy_baseband_rev0_1_init(dev);\r\n}\r\nstatic void lpphy_2062_init(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_lp *lpphy = dev->phy.lp;\r\nstruct ssb_bus *bus = dev->dev->sdev->bus;\r\nu32 crystalfreq, tmp, ref;\r\nunsigned int i;\r\nconst struct b2062_freqdata *fd = NULL;\r\nstatic const struct b2062_freqdata freqdata_tab[] = {\r\n{ .freq = 12000, .data[0] = 6, .data[1] = 6, .data[2] = 6,\r\n.data[3] = 6, .data[4] = 10, .data[5] = 6, },\r\n{ .freq = 13000, .data[0] = 4, .data[1] = 4, .data[2] = 4,\r\n.data[3] = 4, .data[4] = 11, .data[5] = 7, },\r\n{ .freq = 14400, .data[0] = 3, .data[1] = 3, .data[2] = 3,\r\n.data[3] = 3, .data[4] = 12, .data[5] = 7, },\r\n{ .freq = 16200, .data[0] = 3, .data[1] = 3, .data[2] = 3,\r\n.data[3] = 3, .data[4] = 13, .data[5] = 8, },\r\n{ .freq = 18000, .data[0] = 2, .data[1] = 2, .data[2] = 2,\r\n.data[3] = 2, .data[4] = 14, .data[5] = 8, },\r\n{ .freq = 19200, .data[0] = 1, .data[1] = 1, .data[2] = 1,\r\n.data[3] = 1, .data[4] = 14, .data[5] = 9, },\r\n};\r\nb2062_upload_init_table(dev);\r\nb43_radio_write(dev, B2062_N_TX_CTL3, 0);\r\nb43_radio_write(dev, B2062_N_TX_CTL4, 0);\r\nb43_radio_write(dev, B2062_N_TX_CTL5, 0);\r\nb43_radio_write(dev, B2062_N_TX_CTL6, 0);\r\nb43_radio_write(dev, B2062_N_PDN_CTL0, 0x40);\r\nb43_radio_write(dev, B2062_N_PDN_CTL0, 0);\r\nb43_radio_write(dev, B2062_N_CALIB_TS, 0x10);\r\nb43_radio_write(dev, B2062_N_CALIB_TS, 0);\r\nif (dev->phy.rev > 0) {\r\nb43_radio_write(dev, B2062_S_BG_CTL1,\r\n(b43_radio_read(dev, B2062_N_COMM2) >> 1) | 0x80);\r\n}\r\nif (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ)\r\nb43_radio_set(dev, B2062_N_TSSI_CTL0, 0x1);\r\nelse\r\nb43_radio_mask(dev, B2062_N_TSSI_CTL0, ~0x1);\r\ncrystalfreq = bus->chipco.pmu.crystalfreq * 1000;\r\nB43_WARN_ON(!(bus->chipco.capabilities & SSB_CHIPCO_CAP_PMU));\r\nB43_WARN_ON(crystalfreq == 0);\r\nif (crystalfreq <= 30000000) {\r\nlpphy->pdiv = 1;\r\nb43_radio_mask(dev, B2062_S_RFPLL_CTL1, 0xFFFB);\r\n} else {\r\nlpphy->pdiv = 2;\r\nb43_radio_set(dev, B2062_S_RFPLL_CTL1, 0x4);\r\n}\r\ntmp = (((800000000 * lpphy->pdiv + crystalfreq) /\r\n(2 * crystalfreq)) - 8) & 0xFF;\r\nb43_radio_write(dev, B2062_S_RFPLL_CTL7, tmp);\r\ntmp = (((100 * crystalfreq + 16000000 * lpphy->pdiv) /\r\n(32000000 * lpphy->pdiv)) - 1) & 0xFF;\r\nb43_radio_write(dev, B2062_S_RFPLL_CTL18, tmp);\r\ntmp = (((2 * crystalfreq + 1000000 * lpphy->pdiv) /\r\n(2000000 * lpphy->pdiv)) - 1) & 0xFF;\r\nb43_radio_write(dev, B2062_S_RFPLL_CTL19, tmp);\r\nref = (1000 * lpphy->pdiv + 2 * crystalfreq) / (2000 * lpphy->pdiv);\r\nref &= 0xFFFF;\r\nfor (i = 0; i < ARRAY_SIZE(freqdata_tab); i++) {\r\nif (ref < freqdata_tab[i].freq) {\r\nfd = &freqdata_tab[i];\r\nbreak;\r\n}\r\n}\r\nif (!fd)\r\nfd = &freqdata_tab[ARRAY_SIZE(freqdata_tab) - 1];\r\nb43dbg(dev->wl, "b2062: Using crystal tab entry %u kHz.\n",\r\nfd->freq);\r\nb43_radio_write(dev, B2062_S_RFPLL_CTL8,\r\n((u16)(fd->data[1]) << 4) | fd->data[0]);\r\nb43_radio_write(dev, B2062_S_RFPLL_CTL9,\r\n((u16)(fd->data[3]) << 4) | fd->data[2]);\r\nb43_radio_write(dev, B2062_S_RFPLL_CTL10, fd->data[4]);\r\nb43_radio_write(dev, B2062_S_RFPLL_CTL11, fd->data[5]);\r\n}\r\nstatic void lpphy_2063_init(struct b43_wldev *dev)\r\n{\r\nb2063_upload_init_table(dev);\r\nb43_radio_write(dev, B2063_LOGEN_SP5, 0);\r\nb43_radio_set(dev, B2063_COMM8, 0x38);\r\nb43_radio_write(dev, B2063_REG_SP1, 0x56);\r\nb43_radio_mask(dev, B2063_RX_BB_CTL2, ~0x2);\r\nb43_radio_write(dev, B2063_PA_SP7, 0);\r\nb43_radio_write(dev, B2063_TX_RF_SP6, 0x20);\r\nb43_radio_write(dev, B2063_TX_RF_SP9, 0x40);\r\nif (dev->phy.rev == 2) {\r\nb43_radio_write(dev, B2063_PA_SP3, 0xa0);\r\nb43_radio_write(dev, B2063_PA_SP4, 0xa0);\r\nb43_radio_write(dev, B2063_PA_SP2, 0x18);\r\n} else {\r\nb43_radio_write(dev, B2063_PA_SP3, 0x20);\r\nb43_radio_write(dev, B2063_PA_SP2, 0x20);\r\n}\r\n}\r\nstatic void lpphy_sync_stx(struct b43_wldev *dev)\r\n{\r\nconst struct lpphy_stx_table_entry *e;\r\nunsigned int i;\r\nu16 tmp;\r\nfor (i = 0; i < ARRAY_SIZE(lpphy_stx_table); i++) {\r\ne = &lpphy_stx_table[i];\r\ntmp = b43_radio_read(dev, e->rf_addr);\r\ntmp >>= e->rf_shift;\r\ntmp <<= e->phy_shift;\r\nb43_phy_maskset(dev, B43_PHY_OFDM(0xF2 + e->phy_offset),\r\n~(e->mask << e->phy_shift), tmp);\r\n}\r\n}\r\nstatic void lpphy_radio_init(struct b43_wldev *dev)\r\n{\r\nb43_phy_set(dev, B43_LPPHY_FOURWIRE_CTL, 0x2);\r\nudelay(1);\r\nb43_phy_mask(dev, B43_LPPHY_FOURWIRE_CTL, 0xFFFD);\r\nudelay(1);\r\nif (dev->phy.radio_ver == 0x2062) {\r\nlpphy_2062_init(dev);\r\n} else {\r\nlpphy_2063_init(dev);\r\nlpphy_sync_stx(dev);\r\nb43_phy_write(dev, B43_PHY_OFDM(0xF0), 0x5F80);\r\nb43_phy_write(dev, B43_PHY_OFDM(0xF1), 0);\r\nif (dev->dev->chip_id == 0x4325) {\r\n}\r\n}\r\n}\r\nstatic void lpphy_set_rc_cap(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_lp *lpphy = dev->phy.lp;\r\nu8 rc_cap = (lpphy->rc_cap & 0x1F) >> 1;\r\nif (dev->phy.rev == 1)\r\nrc_cap = min_t(u8, rc_cap + 5, 15);\r\nb43_radio_write(dev, B2062_N_RXBB_CALIB2,\r\nmax_t(u8, lpphy->rc_cap - 4, 0x80));\r\nb43_radio_write(dev, B2062_N_TX_CTL_A, rc_cap | 0x80);\r\nb43_radio_write(dev, B2062_S_RXG_CNT16,\r\n((lpphy->rc_cap & 0x1F) >> 2) | 0x80);\r\n}\r\nstatic u8 lpphy_get_bb_mult(struct b43_wldev *dev)\r\n{\r\nreturn (b43_lptab_read(dev, B43_LPTAB16(0, 87)) & 0xFF00) >> 8;\r\n}\r\nstatic void lpphy_set_bb_mult(struct b43_wldev *dev, u8 bb_mult)\r\n{\r\nb43_lptab_write(dev, B43_LPTAB16(0, 87), (u16)bb_mult << 8);\r\n}\r\nstatic void lpphy_set_deaf(struct b43_wldev *dev, bool user)\r\n{\r\nstruct b43_phy_lp *lpphy = dev->phy.lp;\r\nif (user)\r\nlpphy->crs_usr_disable = true;\r\nelse\r\nlpphy->crs_sys_disable = true;\r\nb43_phy_maskset(dev, B43_LPPHY_CRSGAIN_CTL, 0xFF1F, 0x80);\r\n}\r\nstatic void lpphy_clear_deaf(struct b43_wldev *dev, bool user)\r\n{\r\nstruct b43_phy_lp *lpphy = dev->phy.lp;\r\nif (user)\r\nlpphy->crs_usr_disable = false;\r\nelse\r\nlpphy->crs_sys_disable = false;\r\nif (!lpphy->crs_usr_disable && !lpphy->crs_sys_disable) {\r\nif (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ)\r\nb43_phy_maskset(dev, B43_LPPHY_CRSGAIN_CTL,\r\n0xFF1F, 0x60);\r\nelse\r\nb43_phy_maskset(dev, B43_LPPHY_CRSGAIN_CTL,\r\n0xFF1F, 0x20);\r\n}\r\n}\r\nstatic void lpphy_set_trsw_over(struct b43_wldev *dev, bool tx, bool rx)\r\n{\r\nu16 trsw = (tx << 1) | rx;\r\nb43_phy_maskset(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0xFFFC, trsw);\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x3);\r\n}\r\nstatic void lpphy_disable_crs(struct b43_wldev *dev, bool user)\r\n{\r\nlpphy_set_deaf(dev, user);\r\nlpphy_set_trsw_over(dev, false, true);\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0xFFFB);\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x4);\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0xFFF7);\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x8);\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0x10);\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x10);\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0xFFDF);\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x20);\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0xFFBF);\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x40);\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_2_VAL, 0x7);\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_2_VAL, 0x38);\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2_VAL, 0xFF3F);\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_2_VAL, 0x100);\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2_VAL, 0xFDFF);\r\nb43_phy_write(dev, B43_LPPHY_PS_CTL_OVERRIDE_VAL0, 0);\r\nb43_phy_write(dev, B43_LPPHY_PS_CTL_OVERRIDE_VAL1, 1);\r\nb43_phy_write(dev, B43_LPPHY_PS_CTL_OVERRIDE_VAL2, 0x20);\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2_VAL, 0xFBFF);\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2_VAL, 0xF7FF);\r\nb43_phy_write(dev, B43_LPPHY_TX_GAIN_CTL_OVERRIDE_VAL, 0);\r\nb43_phy_write(dev, B43_LPPHY_RX_GAIN_CTL_OVERRIDE_VAL, 0x45AF);\r\nb43_phy_write(dev, B43_LPPHY_RF_OVERRIDE_2, 0x3FF);\r\n}\r\nstatic void lpphy_restore_crs(struct b43_wldev *dev, bool user)\r\n{\r\nlpphy_clear_deaf(dev, user);\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_0, 0xFF80);\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2, 0xFC00);\r\n}\r\nstatic void lpphy_disable_rx_gain_override(struct b43_wldev *dev)\r\n{\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_0, 0xFFFE);\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_0, 0xFFEF);\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_0, 0xFFBF);\r\nif (dev->phy.rev >= 2) {\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2, 0xFEFF);\r\nif (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ) {\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2, 0xFBFF);\r\nb43_phy_mask(dev, B43_PHY_OFDM(0xE5), 0xFFF7);\r\n}\r\n} else {\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2, 0xFDFF);\r\n}\r\n}\r\nstatic void lpphy_enable_rx_gain_override(struct b43_wldev *dev)\r\n{\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x1);\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x10);\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x40);\r\nif (dev->phy.rev >= 2) {\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_2, 0x100);\r\nif (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ) {\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_2, 0x400);\r\nb43_phy_set(dev, B43_PHY_OFDM(0xE5), 0x8);\r\n}\r\n} else {\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_2, 0x200);\r\n}\r\n}\r\nstatic void lpphy_disable_tx_gain_override(struct b43_wldev *dev)\r\n{\r\nif (dev->phy.rev < 2)\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2, 0xFEFF);\r\nelse {\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2, 0xFF7F);\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2, 0xBFFF);\r\n}\r\nb43_phy_mask(dev, B43_LPPHY_AFE_CTL_OVR, 0xFFBF);\r\n}\r\nstatic void lpphy_enable_tx_gain_override(struct b43_wldev *dev)\r\n{\r\nif (dev->phy.rev < 2)\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_2, 0x100);\r\nelse {\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_2, 0x80);\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_2, 0x4000);\r\n}\r\nb43_phy_set(dev, B43_LPPHY_AFE_CTL_OVR, 0x40);\r\n}\r\nstatic struct lpphy_tx_gains lpphy_get_tx_gains(struct b43_wldev *dev)\r\n{\r\nstruct lpphy_tx_gains gains;\r\nu16 tmp;\r\ngains.dac = (b43_phy_read(dev, B43_LPPHY_AFE_DAC_CTL) & 0x380) >> 7;\r\nif (dev->phy.rev < 2) {\r\ntmp = b43_phy_read(dev,\r\nB43_LPPHY_TX_GAIN_CTL_OVERRIDE_VAL) & 0x7FF;\r\ngains.gm = tmp & 0x0007;\r\ngains.pga = (tmp & 0x0078) >> 3;\r\ngains.pad = (tmp & 0x780) >> 7;\r\n} else {\r\ntmp = b43_phy_read(dev, B43_LPPHY_TX_GAIN_CTL_OVERRIDE_VAL);\r\ngains.pad = b43_phy_read(dev, B43_PHY_OFDM(0xFB)) & 0xFF;\r\ngains.gm = tmp & 0xFF;\r\ngains.pga = (tmp >> 8) & 0xFF;\r\n}\r\nreturn gains;\r\n}\r\nstatic void lpphy_set_dac_gain(struct b43_wldev *dev, u16 dac)\r\n{\r\nu16 ctl = b43_phy_read(dev, B43_LPPHY_AFE_DAC_CTL) & 0xC7F;\r\nctl |= dac << 7;\r\nb43_phy_maskset(dev, B43_LPPHY_AFE_DAC_CTL, 0xF000, ctl);\r\n}\r\nstatic u16 lpphy_get_pa_gain(struct b43_wldev *dev)\r\n{\r\nreturn b43_phy_read(dev, B43_PHY_OFDM(0xFB)) & 0x7F;\r\n}\r\nstatic void lpphy_set_pa_gain(struct b43_wldev *dev, u16 gain)\r\n{\r\nb43_phy_maskset(dev, B43_PHY_OFDM(0xFB), 0xE03F, gain << 6);\r\nb43_phy_maskset(dev, B43_PHY_OFDM(0xFD), 0x80FF, gain << 8);\r\n}\r\nstatic void lpphy_set_tx_gains(struct b43_wldev *dev,\r\nstruct lpphy_tx_gains gains)\r\n{\r\nu16 rf_gain, pa_gain;\r\nif (dev->phy.rev < 2) {\r\nrf_gain = (gains.pad << 7) | (gains.pga << 3) | gains.gm;\r\nb43_phy_maskset(dev, B43_LPPHY_TX_GAIN_CTL_OVERRIDE_VAL,\r\n0xF800, rf_gain);\r\n} else {\r\npa_gain = lpphy_get_pa_gain(dev);\r\nb43_phy_write(dev, B43_LPPHY_TX_GAIN_CTL_OVERRIDE_VAL,\r\n(gains.pga << 8) | gains.gm);\r\nb43_phy_maskset(dev, B43_PHY_OFDM(0xFB),\r\n0x8000, gains.pad | (pa_gain << 6));\r\nb43_phy_write(dev, B43_PHY_OFDM(0xFC),\r\n(gains.pga << 8) | gains.gm);\r\nb43_phy_maskset(dev, B43_PHY_OFDM(0xFD),\r\n0x8000, gains.pad | (pa_gain << 8));\r\n}\r\nlpphy_set_dac_gain(dev, gains.dac);\r\nlpphy_enable_tx_gain_override(dev);\r\n}\r\nstatic void lpphy_rev0_1_set_rx_gain(struct b43_wldev *dev, u32 gain)\r\n{\r\nu16 trsw = gain & 0x1;\r\nu16 lna = (gain & 0xFFFC) | ((gain & 0xC) >> 2);\r\nu16 ext_lna = (gain & 2) >> 1;\r\nb43_phy_maskset(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0xFFFE, trsw);\r\nb43_phy_maskset(dev, B43_LPPHY_RF_OVERRIDE_2_VAL,\r\n0xFBFF, ext_lna << 10);\r\nb43_phy_maskset(dev, B43_LPPHY_RF_OVERRIDE_2_VAL,\r\n0xF7FF, ext_lna << 11);\r\nb43_phy_write(dev, B43_LPPHY_RX_GAIN_CTL_OVERRIDE_VAL, lna);\r\n}\r\nstatic void lpphy_rev2plus_set_rx_gain(struct b43_wldev *dev, u32 gain)\r\n{\r\nu16 low_gain = gain & 0xFFFF;\r\nu16 high_gain = (gain >> 16) & 0xF;\r\nu16 ext_lna = (gain >> 21) & 0x1;\r\nu16 trsw = ~(gain >> 20) & 0x1;\r\nu16 tmp;\r\nb43_phy_maskset(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0xFFFE, trsw);\r\nb43_phy_maskset(dev, B43_LPPHY_RF_OVERRIDE_2_VAL,\r\n0xFDFF, ext_lna << 9);\r\nb43_phy_maskset(dev, B43_LPPHY_RF_OVERRIDE_2_VAL,\r\n0xFBFF, ext_lna << 10);\r\nb43_phy_write(dev, B43_LPPHY_RX_GAIN_CTL_OVERRIDE_VAL, low_gain);\r\nb43_phy_maskset(dev, B43_LPPHY_AFE_DDFS, 0xFFF0, high_gain);\r\nif (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ) {\r\ntmp = (gain >> 2) & 0x3;\r\nb43_phy_maskset(dev, B43_LPPHY_RF_OVERRIDE_2_VAL,\r\n0xE7FF, tmp<<11);\r\nb43_phy_maskset(dev, B43_PHY_OFDM(0xE6), 0xFFE7, tmp << 3);\r\n}\r\n}\r\nstatic void lpphy_set_rx_gain(struct b43_wldev *dev, u32 gain)\r\n{\r\nif (dev->phy.rev < 2)\r\nlpphy_rev0_1_set_rx_gain(dev, gain);\r\nelse\r\nlpphy_rev2plus_set_rx_gain(dev, gain);\r\nlpphy_enable_rx_gain_override(dev);\r\n}\r\nstatic void lpphy_set_rx_gain_by_index(struct b43_wldev *dev, u16 idx)\r\n{\r\nu32 gain = b43_lptab_read(dev, B43_LPTAB16(12, idx));\r\nlpphy_set_rx_gain(dev, gain);\r\n}\r\nstatic void lpphy_stop_ddfs(struct b43_wldev *dev)\r\n{\r\nb43_phy_mask(dev, B43_LPPHY_AFE_DDFS, 0xFFFD);\r\nb43_phy_mask(dev, B43_LPPHY_LP_PHY_CTL, 0xFFDF);\r\n}\r\nstatic void lpphy_run_ddfs(struct b43_wldev *dev, int i_on, int q_on,\r\nint incr1, int incr2, int scale_idx)\r\n{\r\nlpphy_stop_ddfs(dev);\r\nb43_phy_mask(dev, B43_LPPHY_AFE_DDFS_POINTER_INIT, 0xFF80);\r\nb43_phy_mask(dev, B43_LPPHY_AFE_DDFS_POINTER_INIT, 0x80FF);\r\nb43_phy_maskset(dev, B43_LPPHY_AFE_DDFS_INCR_INIT, 0xFF80, incr1);\r\nb43_phy_maskset(dev, B43_LPPHY_AFE_DDFS_INCR_INIT, 0x80FF, incr2 << 8);\r\nb43_phy_maskset(dev, B43_LPPHY_AFE_DDFS, 0xFFF7, i_on << 3);\r\nb43_phy_maskset(dev, B43_LPPHY_AFE_DDFS, 0xFFEF, q_on << 4);\r\nb43_phy_maskset(dev, B43_LPPHY_AFE_DDFS, 0xFF9F, scale_idx << 5);\r\nb43_phy_mask(dev, B43_LPPHY_AFE_DDFS, 0xFFFB);\r\nb43_phy_set(dev, B43_LPPHY_AFE_DDFS, 0x2);\r\nb43_phy_set(dev, B43_LPPHY_LP_PHY_CTL, 0x20);\r\n}\r\nstatic bool lpphy_rx_iq_est(struct b43_wldev *dev, u16 samples, u8 time,\r\nstruct lpphy_iq_est *iq_est)\r\n{\r\nint i;\r\nb43_phy_mask(dev, B43_LPPHY_CRSGAIN_CTL, 0xFFF7);\r\nb43_phy_write(dev, B43_LPPHY_IQ_NUM_SMPLS_ADDR, samples);\r\nb43_phy_maskset(dev, B43_LPPHY_IQ_ENABLE_WAIT_TIME_ADDR, 0xFF00, time);\r\nb43_phy_mask(dev, B43_LPPHY_IQ_ENABLE_WAIT_TIME_ADDR, 0xFEFF);\r\nb43_phy_set(dev, B43_LPPHY_IQ_ENABLE_WAIT_TIME_ADDR, 0x200);\r\nfor (i = 0; i < 500; i++) {\r\nif (!(b43_phy_read(dev,\r\nB43_LPPHY_IQ_ENABLE_WAIT_TIME_ADDR) & 0x200))\r\nbreak;\r\nmsleep(1);\r\n}\r\nif ((b43_phy_read(dev, B43_LPPHY_IQ_ENABLE_WAIT_TIME_ADDR) & 0x200)) {\r\nb43_phy_set(dev, B43_LPPHY_CRSGAIN_CTL, 0x8);\r\nreturn false;\r\n}\r\niq_est->iq_prod = b43_phy_read(dev, B43_LPPHY_IQ_ACC_HI_ADDR);\r\niq_est->iq_prod <<= 16;\r\niq_est->iq_prod |= b43_phy_read(dev, B43_LPPHY_IQ_ACC_LO_ADDR);\r\niq_est->i_pwr = b43_phy_read(dev, B43_LPPHY_IQ_I_PWR_ACC_HI_ADDR);\r\niq_est->i_pwr <<= 16;\r\niq_est->i_pwr |= b43_phy_read(dev, B43_LPPHY_IQ_I_PWR_ACC_LO_ADDR);\r\niq_est->q_pwr = b43_phy_read(dev, B43_LPPHY_IQ_Q_PWR_ACC_HI_ADDR);\r\niq_est->q_pwr <<= 16;\r\niq_est->q_pwr |= b43_phy_read(dev, B43_LPPHY_IQ_Q_PWR_ACC_LO_ADDR);\r\nb43_phy_set(dev, B43_LPPHY_CRSGAIN_CTL, 0x8);\r\nreturn true;\r\n}\r\nstatic int lpphy_loopback(struct b43_wldev *dev)\r\n{\r\nstruct lpphy_iq_est iq_est;\r\nint i, index = -1;\r\nu32 tmp;\r\nmemset(&iq_est, 0, sizeof(iq_est));\r\nlpphy_set_trsw_over(dev, true, true);\r\nb43_phy_set(dev, B43_LPPHY_AFE_CTL_OVR, 1);\r\nb43_phy_mask(dev, B43_LPPHY_AFE_CTL_OVRVAL, 0xFFFE);\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x800);\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0x800);\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x8);\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0x8);\r\nb43_radio_write(dev, B2062_N_TX_CTL_A, 0x80);\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x80);\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0x80);\r\nfor (i = 0; i < 32; i++) {\r\nlpphy_set_rx_gain_by_index(dev, i);\r\nlpphy_run_ddfs(dev, 1, 1, 5, 5, 0);\r\nif (!(lpphy_rx_iq_est(dev, 1000, 32, &iq_est)))\r\ncontinue;\r\ntmp = (iq_est.i_pwr + iq_est.q_pwr) / 1000;\r\nif ((tmp > 4000) && (tmp < 10000)) {\r\nindex = i;\r\nbreak;\r\n}\r\n}\r\nlpphy_stop_ddfs(dev);\r\nreturn index;\r\n}\r\nstatic u32 lpphy_qdiv_roundup(u32 dividend, u32 divisor, u8 precision)\r\n{\r\nu32 quotient, remainder;\r\nif (divisor == 0)\r\nreturn 0;\r\nquotient = dividend / divisor;\r\nremainder = dividend % divisor;\r\nwhile (precision > 0) {\r\nquotient <<= 1;\r\nif (remainder << 1 >= divisor) {\r\nquotient++;\r\nremainder = (remainder << 1) - divisor;\r\n}\r\nprecision--;\r\n}\r\nif (remainder << 1 >= divisor)\r\nquotient++;\r\nreturn quotient;\r\n}\r\nstatic void lpphy_read_tx_pctl_mode_from_hardware(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_lp *lpphy = dev->phy.lp;\r\nu16 ctl;\r\nctl = b43_phy_read(dev, B43_LPPHY_TX_PWR_CTL_CMD);\r\nswitch (ctl & B43_LPPHY_TX_PWR_CTL_CMD_MODE) {\r\ncase B43_LPPHY_TX_PWR_CTL_CMD_MODE_OFF:\r\nlpphy->txpctl_mode = B43_LPPHY_TXPCTL_OFF;\r\nbreak;\r\ncase B43_LPPHY_TX_PWR_CTL_CMD_MODE_SW:\r\nlpphy->txpctl_mode = B43_LPPHY_TXPCTL_SW;\r\nbreak;\r\ncase B43_LPPHY_TX_PWR_CTL_CMD_MODE_HW:\r\nlpphy->txpctl_mode = B43_LPPHY_TXPCTL_HW;\r\nbreak;\r\ndefault:\r\nlpphy->txpctl_mode = B43_LPPHY_TXPCTL_UNKNOWN;\r\nB43_WARN_ON(1);\r\nbreak;\r\n}\r\n}\r\nstatic void lpphy_write_tx_pctl_mode_to_hardware(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_lp *lpphy = dev->phy.lp;\r\nu16 ctl;\r\nswitch (lpphy->txpctl_mode) {\r\ncase B43_LPPHY_TXPCTL_OFF:\r\nctl = B43_LPPHY_TX_PWR_CTL_CMD_MODE_OFF;\r\nbreak;\r\ncase B43_LPPHY_TXPCTL_HW:\r\nctl = B43_LPPHY_TX_PWR_CTL_CMD_MODE_HW;\r\nbreak;\r\ncase B43_LPPHY_TXPCTL_SW:\r\nctl = B43_LPPHY_TX_PWR_CTL_CMD_MODE_SW;\r\nbreak;\r\ndefault:\r\nctl = 0;\r\nB43_WARN_ON(1);\r\n}\r\nb43_phy_maskset(dev, B43_LPPHY_TX_PWR_CTL_CMD,\r\n~B43_LPPHY_TX_PWR_CTL_CMD_MODE & 0xFFFF, ctl);\r\n}\r\nstatic void lpphy_set_tx_power_control(struct b43_wldev *dev,\r\nenum b43_lpphy_txpctl_mode mode)\r\n{\r\nstruct b43_phy_lp *lpphy = dev->phy.lp;\r\nenum b43_lpphy_txpctl_mode oldmode;\r\nlpphy_read_tx_pctl_mode_from_hardware(dev);\r\noldmode = lpphy->txpctl_mode;\r\nif (oldmode == mode)\r\nreturn;\r\nlpphy->txpctl_mode = mode;\r\nif (oldmode == B43_LPPHY_TXPCTL_HW) {\r\n} else {\r\nif (mode == B43_LPPHY_TXPCTL_HW) {\r\nb43_phy_maskset(dev, B43_LPPHY_TX_PWR_CTL_CMD,\r\n0xFF80, lpphy->tssi_idx);\r\nb43_phy_maskset(dev, B43_LPPHY_TX_PWR_CTL_NNUM,\r\n0x8FFF, ((u16)lpphy->tssi_npt << 16));\r\nlpphy_disable_tx_gain_override(dev);\r\nlpphy->tx_pwr_idx_over = -1;\r\n}\r\n}\r\nif (dev->phy.rev >= 2) {\r\nif (mode == B43_LPPHY_TXPCTL_HW)\r\nb43_phy_set(dev, B43_PHY_OFDM(0xD0), 0x2);\r\nelse\r\nb43_phy_mask(dev, B43_PHY_OFDM(0xD0), 0xFFFD);\r\n}\r\nlpphy_write_tx_pctl_mode_to_hardware(dev);\r\n}\r\nstatic void lpphy_rev0_1_rc_calib(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_lp *lpphy = dev->phy.lp;\r\nstruct lpphy_iq_est iq_est;\r\nstruct lpphy_tx_gains tx_gains;\r\nstatic const u32 ideal_pwr_table[21] = {\r\n0x10000, 0x10557, 0x10e2d, 0x113e0, 0x10f22, 0x0ff64,\r\n0x0eda2, 0x0e5d4, 0x0efd1, 0x0fbe8, 0x0b7b8, 0x04b35,\r\n0x01a5e, 0x00a0b, 0x00444, 0x001fd, 0x000ff, 0x00088,\r\n0x0004c, 0x0002c, 0x0001a,\r\n};\r\nbool old_txg_ovr;\r\nu8 old_bbmult;\r\nu16 old_rf_ovr, old_rf_ovrval, old_afe_ovr, old_afe_ovrval,\r\nold_rf2_ovr, old_rf2_ovrval, old_phy_ctl;\r\nenum b43_lpphy_txpctl_mode old_txpctl;\r\nu32 normal_pwr, ideal_pwr, mean_sq_pwr, tmp = 0, mean_sq_pwr_min = 0;\r\nint loopback, i, j, inner_sum, err;\r\nmemset(&iq_est, 0, sizeof(iq_est));\r\nerr = b43_lpphy_op_switch_channel(dev, 7);\r\nif (err) {\r\nb43dbg(dev->wl,\r\n"RC calib: Failed to switch to channel 7, error = %d\n",\r\nerr);\r\n}\r\nold_txg_ovr = !!(b43_phy_read(dev, B43_LPPHY_AFE_CTL_OVR) & 0x40);\r\nold_bbmult = lpphy_get_bb_mult(dev);\r\nif (old_txg_ovr)\r\ntx_gains = lpphy_get_tx_gains(dev);\r\nold_rf_ovr = b43_phy_read(dev, B43_LPPHY_RF_OVERRIDE_0);\r\nold_rf_ovrval = b43_phy_read(dev, B43_LPPHY_RF_OVERRIDE_VAL_0);\r\nold_afe_ovr = b43_phy_read(dev, B43_LPPHY_AFE_CTL_OVR);\r\nold_afe_ovrval = b43_phy_read(dev, B43_LPPHY_AFE_CTL_OVRVAL);\r\nold_rf2_ovr = b43_phy_read(dev, B43_LPPHY_RF_OVERRIDE_2);\r\nold_rf2_ovrval = b43_phy_read(dev, B43_LPPHY_RF_OVERRIDE_2_VAL);\r\nold_phy_ctl = b43_phy_read(dev, B43_LPPHY_LP_PHY_CTL);\r\nlpphy_read_tx_pctl_mode_from_hardware(dev);\r\nold_txpctl = lpphy->txpctl_mode;\r\nlpphy_set_tx_power_control(dev, B43_LPPHY_TXPCTL_OFF);\r\nlpphy_disable_crs(dev, true);\r\nloopback = lpphy_loopback(dev);\r\nif (loopback == -1)\r\ngoto finish;\r\nlpphy_set_rx_gain_by_index(dev, loopback);\r\nb43_phy_maskset(dev, B43_LPPHY_LP_PHY_CTL, 0xFFBF, 0x40);\r\nb43_phy_maskset(dev, B43_LPPHY_RF_OVERRIDE_2_VAL, 0xFFF8, 0x1);\r\nb43_phy_maskset(dev, B43_LPPHY_RF_OVERRIDE_2_VAL, 0xFFC7, 0x8);\r\nb43_phy_maskset(dev, B43_LPPHY_RF_OVERRIDE_2_VAL, 0xFF3F, 0xC0);\r\nfor (i = 128; i <= 159; i++) {\r\nb43_radio_write(dev, B2062_N_RXBB_CALIB2, i);\r\ninner_sum = 0;\r\nfor (j = 5; j <= 25; j++) {\r\nlpphy_run_ddfs(dev, 1, 1, j, j, 0);\r\nif (!(lpphy_rx_iq_est(dev, 1000, 32, &iq_est)))\r\ngoto finish;\r\nmean_sq_pwr = iq_est.i_pwr + iq_est.q_pwr;\r\nif (j == 5)\r\ntmp = mean_sq_pwr;\r\nideal_pwr = ((ideal_pwr_table[j-5] >> 3) + 1) >> 1;\r\nnormal_pwr = lpphy_qdiv_roundup(mean_sq_pwr, tmp, 12);\r\nmean_sq_pwr = ideal_pwr - normal_pwr;\r\nmean_sq_pwr *= mean_sq_pwr;\r\ninner_sum += mean_sq_pwr;\r\nif ((i == 128) || (inner_sum < mean_sq_pwr_min)) {\r\nlpphy->rc_cap = i;\r\nmean_sq_pwr_min = inner_sum;\r\n}\r\n}\r\n}\r\nlpphy_stop_ddfs(dev);\r\nfinish:\r\nlpphy_restore_crs(dev, true);\r\nb43_phy_write(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, old_rf_ovrval);\r\nb43_phy_write(dev, B43_LPPHY_RF_OVERRIDE_0, old_rf_ovr);\r\nb43_phy_write(dev, B43_LPPHY_AFE_CTL_OVRVAL, old_afe_ovrval);\r\nb43_phy_write(dev, B43_LPPHY_AFE_CTL_OVR, old_afe_ovr);\r\nb43_phy_write(dev, B43_LPPHY_RF_OVERRIDE_2_VAL, old_rf2_ovrval);\r\nb43_phy_write(dev, B43_LPPHY_RF_OVERRIDE_2, old_rf2_ovr);\r\nb43_phy_write(dev, B43_LPPHY_LP_PHY_CTL, old_phy_ctl);\r\nlpphy_set_bb_mult(dev, old_bbmult);\r\nif (old_txg_ovr) {\r\nlpphy_set_tx_gains(dev, tx_gains);\r\n}\r\nlpphy_set_tx_power_control(dev, old_txpctl);\r\nif (lpphy->rc_cap)\r\nlpphy_set_rc_cap(dev);\r\n}\r\nstatic void lpphy_rev2plus_rc_calib(struct b43_wldev *dev)\r\n{\r\nstruct ssb_bus *bus = dev->dev->sdev->bus;\r\nu32 crystal_freq = bus->chipco.pmu.crystalfreq * 1000;\r\nu8 tmp = b43_radio_read(dev, B2063_RX_BB_SP8) & 0xFF;\r\nint i;\r\nb43_radio_write(dev, B2063_RX_BB_SP8, 0x0);\r\nb43_radio_write(dev, B2063_RC_CALIB_CTL1, 0x7E);\r\nb43_radio_mask(dev, B2063_PLL_SP1, 0xF7);\r\nb43_radio_write(dev, B2063_RC_CALIB_CTL1, 0x7C);\r\nb43_radio_write(dev, B2063_RC_CALIB_CTL2, 0x15);\r\nb43_radio_write(dev, B2063_RC_CALIB_CTL3, 0x70);\r\nb43_radio_write(dev, B2063_RC_CALIB_CTL4, 0x52);\r\nb43_radio_write(dev, B2063_RC_CALIB_CTL5, 0x1);\r\nb43_radio_write(dev, B2063_RC_CALIB_CTL1, 0x7D);\r\nfor (i = 0; i < 10000; i++) {\r\nif (b43_radio_read(dev, B2063_RC_CALIB_CTL6) & 0x2)\r\nbreak;\r\nmsleep(1);\r\n}\r\nif (!(b43_radio_read(dev, B2063_RC_CALIB_CTL6) & 0x2))\r\nb43_radio_write(dev, B2063_RX_BB_SP8, tmp);\r\ntmp = b43_radio_read(dev, B2063_TX_BB_SP3) & 0xFF;\r\nb43_radio_write(dev, B2063_TX_BB_SP3, 0x0);\r\nb43_radio_write(dev, B2063_RC_CALIB_CTL1, 0x7E);\r\nb43_radio_write(dev, B2063_RC_CALIB_CTL1, 0x7C);\r\nb43_radio_write(dev, B2063_RC_CALIB_CTL2, 0x55);\r\nb43_radio_write(dev, B2063_RC_CALIB_CTL3, 0x76);\r\nif (crystal_freq == 24000000) {\r\nb43_radio_write(dev, B2063_RC_CALIB_CTL4, 0xFC);\r\nb43_radio_write(dev, B2063_RC_CALIB_CTL5, 0x0);\r\n} else {\r\nb43_radio_write(dev, B2063_RC_CALIB_CTL4, 0x13);\r\nb43_radio_write(dev, B2063_RC_CALIB_CTL5, 0x1);\r\n}\r\nb43_radio_write(dev, B2063_PA_SP7, 0x7D);\r\nfor (i = 0; i < 10000; i++) {\r\nif (b43_radio_read(dev, B2063_RC_CALIB_CTL6) & 0x2)\r\nbreak;\r\nmsleep(1);\r\n}\r\nif (!(b43_radio_read(dev, B2063_RC_CALIB_CTL6) & 0x2))\r\nb43_radio_write(dev, B2063_TX_BB_SP3, tmp);\r\nb43_radio_write(dev, B2063_RC_CALIB_CTL1, 0x7E);\r\n}\r\nstatic void lpphy_calibrate_rc(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_lp *lpphy = dev->phy.lp;\r\nif (dev->phy.rev >= 2) {\r\nlpphy_rev2plus_rc_calib(dev);\r\n} else if (!lpphy->rc_cap) {\r\nif (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ)\r\nlpphy_rev0_1_rc_calib(dev);\r\n} else {\r\nlpphy_set_rc_cap(dev);\r\n}\r\n}\r\nstatic void b43_lpphy_op_set_rx_antenna(struct b43_wldev *dev, int antenna)\r\n{\r\nif (dev->phy.rev >= 2)\r\nreturn;\r\nif (B43_WARN_ON(antenna > B43_ANTENNA_AUTO1))\r\nreturn;\r\nb43_hf_write(dev, b43_hf_read(dev) & ~B43_HF_ANTDIVHELP);\r\nb43_phy_maskset(dev, B43_LPPHY_CRSGAIN_CTL, 0xFFFD, antenna & 0x2);\r\nb43_phy_maskset(dev, B43_LPPHY_CRSGAIN_CTL, 0xFFFE, antenna & 0x1);\r\nb43_hf_write(dev, b43_hf_read(dev) | B43_HF_ANTDIVHELP);\r\ndev->phy.lp->antenna = antenna;\r\n}\r\nstatic void lpphy_set_tx_iqcc(struct b43_wldev *dev, u16 a, u16 b)\r\n{\r\nu16 tmp[2];\r\ntmp[0] = a;\r\ntmp[1] = b;\r\nb43_lptab_write_bulk(dev, B43_LPTAB16(0, 80), 2, tmp);\r\n}\r\nstatic void lpphy_set_tx_power_by_index(struct b43_wldev *dev, u8 index)\r\n{\r\nstruct b43_phy_lp *lpphy = dev->phy.lp;\r\nstruct lpphy_tx_gains gains;\r\nu32 iq_comp, tx_gain, coeff, rf_power;\r\nlpphy->tx_pwr_idx_over = index;\r\nlpphy_read_tx_pctl_mode_from_hardware(dev);\r\nif (lpphy->txpctl_mode != B43_LPPHY_TXPCTL_OFF)\r\nlpphy_set_tx_power_control(dev, B43_LPPHY_TXPCTL_SW);\r\nif (dev->phy.rev >= 2) {\r\niq_comp = b43_lptab_read(dev, B43_LPTAB32(7, index + 320));\r\ntx_gain = b43_lptab_read(dev, B43_LPTAB32(7, index + 192));\r\ngains.pad = (tx_gain >> 16) & 0xFF;\r\ngains.gm = tx_gain & 0xFF;\r\ngains.pga = (tx_gain >> 8) & 0xFF;\r\ngains.dac = (iq_comp >> 28) & 0xFF;\r\nlpphy_set_tx_gains(dev, gains);\r\n} else {\r\niq_comp = b43_lptab_read(dev, B43_LPTAB32(10, index + 320));\r\ntx_gain = b43_lptab_read(dev, B43_LPTAB32(10, index + 192));\r\nb43_phy_maskset(dev, B43_LPPHY_TX_GAIN_CTL_OVERRIDE_VAL,\r\n0xF800, (tx_gain >> 4) & 0x7FFF);\r\nlpphy_set_dac_gain(dev, tx_gain & 0x7);\r\nlpphy_set_pa_gain(dev, (tx_gain >> 24) & 0x7F);\r\n}\r\nlpphy_set_bb_mult(dev, (iq_comp >> 20) & 0xFF);\r\nlpphy_set_tx_iqcc(dev, (iq_comp >> 10) & 0x3FF, iq_comp & 0x3FF);\r\nif (dev->phy.rev >= 2) {\r\ncoeff = b43_lptab_read(dev, B43_LPTAB32(7, index + 448));\r\n} else {\r\ncoeff = b43_lptab_read(dev, B43_LPTAB32(10, index + 448));\r\n}\r\nb43_lptab_write(dev, B43_LPTAB16(0, 85), coeff & 0xFFFF);\r\nif (dev->phy.rev >= 2) {\r\nrf_power = b43_lptab_read(dev, B43_LPTAB32(7, index + 576));\r\nb43_phy_maskset(dev, B43_LPPHY_RF_PWR_OVERRIDE, 0xFF00,\r\nrf_power & 0xFFFF);\r\n}\r\nlpphy_enable_tx_gain_override(dev);\r\n}\r\nstatic void lpphy_btcoex_override(struct b43_wldev *dev)\r\n{\r\nb43_write16(dev, B43_MMIO_BTCOEX_CTL, 0x3);\r\nb43_write16(dev, B43_MMIO_BTCOEX_TXCTL, 0xFF);\r\n}\r\nstatic void b43_lpphy_op_software_rfkill(struct b43_wldev *dev,\r\nbool blocked)\r\n{\r\nif (blocked) {\r\nif (dev->phy.rev >= 2) {\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0x83FF);\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x1F00);\r\nb43_phy_mask(dev, B43_LPPHY_AFE_DDFS, 0x80FF);\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2_VAL, 0xDFFF);\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_2, 0x0808);\r\n} else {\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0xE0FF);\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x1F00);\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2_VAL, 0xFCFF);\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_2, 0x0018);\r\n}\r\n} else {\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_0, 0xE0FF);\r\nif (dev->phy.rev >= 2)\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2, 0xF7F7);\r\nelse\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_2, 0xFFE7);\r\n}\r\n}\r\nstatic void lpphy_set_analog_filter(struct b43_wldev *dev, int channel)\r\n{\r\nstruct b43_phy_lp *lpphy = dev->phy.lp;\r\nu16 tmp = (channel == 14);\r\nif (dev->phy.rev < 2) {\r\nb43_phy_maskset(dev, B43_LPPHY_LP_PHY_CTL, 0xFCFF, tmp << 9);\r\nif ((dev->phy.rev == 1) && (lpphy->rc_cap))\r\nlpphy_set_rc_cap(dev);\r\n} else {\r\nb43_radio_write(dev, B2063_TX_BB_SP3, 0x3F);\r\n}\r\n}\r\nstatic void lpphy_set_tssi_mux(struct b43_wldev *dev, enum tssi_mux_mode mode)\r\n{\r\nif (mode != TSSI_MUX_EXT) {\r\nb43_radio_set(dev, B2063_PA_SP1, 0x2);\r\nb43_phy_set(dev, B43_PHY_OFDM(0xF3), 0x1000);\r\nb43_radio_write(dev, B2063_PA_CTL10, 0x51);\r\nif (mode == TSSI_MUX_POSTPA) {\r\nb43_radio_mask(dev, B2063_PA_SP1, 0xFFFE);\r\nb43_phy_mask(dev, B43_LPPHY_AFE_CTL_OVRVAL, 0xFFC7);\r\n} else {\r\nb43_radio_maskset(dev, B2063_PA_SP1, 0xFFFE, 0x1);\r\nb43_phy_maskset(dev, B43_LPPHY_AFE_CTL_OVRVAL,\r\n0xFFC7, 0x20);\r\n}\r\n} else {\r\nB43_WARN_ON(1);\r\n}\r\n}\r\nstatic void lpphy_tx_pctl_init_hw(struct b43_wldev *dev)\r\n{\r\nu16 tmp;\r\nint i;\r\nfor (i = 0; i < 64; i++) {\r\nif (dev->phy.rev >= 2)\r\nb43_lptab_write(dev, B43_LPTAB32(7, i + 1), i);\r\nelse\r\nb43_lptab_write(dev, B43_LPTAB32(10, i + 1), i);\r\n}\r\nb43_phy_maskset(dev, B43_LPPHY_TX_PWR_CTL_NNUM, 0xFF00, 0xFF);\r\nb43_phy_maskset(dev, B43_LPPHY_TX_PWR_CTL_NNUM, 0x8FFF, 0x5000);\r\nb43_phy_maskset(dev, B43_LPPHY_TX_PWR_CTL_IDLETSSI, 0xFFC0, 0x1F);\r\nif (dev->phy.rev < 2) {\r\nb43_phy_mask(dev, B43_LPPHY_LP_PHY_CTL, 0xEFFF);\r\nb43_phy_maskset(dev, B43_LPPHY_LP_PHY_CTL, 0xDFFF, 0x2000);\r\n} else {\r\nb43_phy_mask(dev, B43_PHY_OFDM(0x103), 0xFFFE);\r\nb43_phy_maskset(dev, B43_PHY_OFDM(0x103), 0xFFFB, 0x4);\r\nb43_phy_maskset(dev, B43_PHY_OFDM(0x103), 0xFFEF, 0x10);\r\nb43_radio_maskset(dev, B2063_IQ_CALIB_CTL2, 0xF3, 0x1);\r\nlpphy_set_tssi_mux(dev, TSSI_MUX_POSTPA);\r\n}\r\nb43_phy_maskset(dev, B43_LPPHY_TX_PWR_CTL_IDLETSSI, 0x7FFF, 0x8000);\r\nb43_phy_mask(dev, B43_LPPHY_TX_PWR_CTL_DELTAPWR_LIMIT, 0xFF);\r\nb43_phy_write(dev, B43_LPPHY_TX_PWR_CTL_DELTAPWR_LIMIT, 0xA);\r\nb43_phy_maskset(dev, B43_LPPHY_TX_PWR_CTL_CMD,\r\n~B43_LPPHY_TX_PWR_CTL_CMD_MODE & 0xFFFF,\r\nB43_LPPHY_TX_PWR_CTL_CMD_MODE_OFF);\r\nb43_phy_mask(dev, B43_LPPHY_TX_PWR_CTL_NNUM, 0xF8FF);\r\nb43_phy_maskset(dev, B43_LPPHY_TX_PWR_CTL_CMD,\r\n~B43_LPPHY_TX_PWR_CTL_CMD_MODE & 0xFFFF,\r\nB43_LPPHY_TX_PWR_CTL_CMD_MODE_SW);\r\nif (dev->phy.rev < 2) {\r\nb43_phy_maskset(dev, B43_LPPHY_RF_OVERRIDE_0, 0xEFFF, 0x1000);\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0xEFFF);\r\n} else {\r\nlpphy_set_tx_power_by_index(dev, 0x7F);\r\n}\r\nb43_dummy_transmission(dev, true, true);\r\ntmp = b43_phy_read(dev, B43_LPPHY_TX_PWR_CTL_STAT);\r\nif (tmp & 0x8000) {\r\nb43_phy_maskset(dev, B43_LPPHY_TX_PWR_CTL_IDLETSSI,\r\n0xFFC0, (tmp & 0xFF) - 32);\r\n}\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_0, 0xEFFF);\r\n}\r\nstatic void lpphy_tx_pctl_init_sw(struct b43_wldev *dev)\r\n{\r\nstruct lpphy_tx_gains gains;\r\nif (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ) {\r\ngains.gm = 4;\r\ngains.pad = 12;\r\ngains.pga = 12;\r\ngains.dac = 0;\r\n} else {\r\ngains.gm = 7;\r\ngains.pad = 14;\r\ngains.pga = 15;\r\ngains.dac = 0;\r\n}\r\nlpphy_set_tx_gains(dev, gains);\r\nlpphy_set_bb_mult(dev, 150);\r\n}\r\nstatic void lpphy_tx_pctl_init(struct b43_wldev *dev)\r\n{\r\nif (0) {\r\nlpphy_tx_pctl_init_hw(dev);\r\n} else {\r\nlpphy_tx_pctl_init_sw(dev);\r\n}\r\n}\r\nstatic void lpphy_pr41573_workaround(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_lp *lpphy = dev->phy.lp;\r\nu32 *saved_tab;\r\nconst unsigned int saved_tab_size = 256;\r\nenum b43_lpphy_txpctl_mode txpctl_mode;\r\ns8 tx_pwr_idx_over;\r\nu16 tssi_npt, tssi_idx;\r\nsaved_tab = kcalloc(saved_tab_size, sizeof(saved_tab[0]), GFP_KERNEL);\r\nif (!saved_tab) {\r\nb43err(dev->wl, "PR41573 failed. Out of memory!\n");\r\nreturn;\r\n}\r\nlpphy_read_tx_pctl_mode_from_hardware(dev);\r\ntxpctl_mode = lpphy->txpctl_mode;\r\ntx_pwr_idx_over = lpphy->tx_pwr_idx_over;\r\ntssi_npt = lpphy->tssi_npt;\r\ntssi_idx = lpphy->tssi_idx;\r\nif (dev->phy.rev < 2) {\r\nb43_lptab_read_bulk(dev, B43_LPTAB32(10, 0x140),\r\nsaved_tab_size, saved_tab);\r\n} else {\r\nb43_lptab_read_bulk(dev, B43_LPTAB32(7, 0x140),\r\nsaved_tab_size, saved_tab);\r\n}\r\nlpphy_table_init(dev);\r\nlpphy_baseband_init(dev);\r\nlpphy_tx_pctl_init(dev);\r\nb43_lpphy_op_software_rfkill(dev, false);\r\nlpphy_set_tx_power_control(dev, B43_LPPHY_TXPCTL_OFF);\r\nif (dev->phy.rev < 2) {\r\nb43_lptab_write_bulk(dev, B43_LPTAB32(10, 0x140),\r\nsaved_tab_size, saved_tab);\r\n} else {\r\nb43_lptab_write_bulk(dev, B43_LPTAB32(7, 0x140),\r\nsaved_tab_size, saved_tab);\r\n}\r\nb43_write16(dev, B43_MMIO_CHANNEL, lpphy->channel);\r\nlpphy->tssi_npt = tssi_npt;\r\nlpphy->tssi_idx = tssi_idx;\r\nlpphy_set_analog_filter(dev, lpphy->channel);\r\nif (tx_pwr_idx_over != -1)\r\nlpphy_set_tx_power_by_index(dev, tx_pwr_idx_over);\r\nif (lpphy->rc_cap)\r\nlpphy_set_rc_cap(dev);\r\nb43_lpphy_op_set_rx_antenna(dev, lpphy->antenna);\r\nlpphy_set_tx_power_control(dev, txpctl_mode);\r\nkfree(saved_tab);\r\n}\r\nstatic int lpphy_calc_rx_iq_comp(struct b43_wldev *dev, u16 samples)\r\n{\r\nstruct lpphy_iq_est iq_est;\r\nu16 c0, c1;\r\nint prod, ipwr, qpwr, prod_msb, q_msb, tmp1, tmp2, tmp3, tmp4, ret;\r\nc1 = b43_phy_read(dev, B43_LPPHY_RX_COMP_COEFF_S);\r\nc0 = c1 >> 8;\r\nc1 |= 0xFF;\r\nb43_phy_maskset(dev, B43_LPPHY_RX_COMP_COEFF_S, 0xFF00, 0x00C0);\r\nb43_phy_mask(dev, B43_LPPHY_RX_COMP_COEFF_S, 0x00FF);\r\nret = lpphy_rx_iq_est(dev, samples, 32, &iq_est);\r\nif (!ret)\r\ngoto out;\r\nprod = iq_est.iq_prod;\r\nipwr = iq_est.i_pwr;\r\nqpwr = iq_est.q_pwr;\r\nif (ipwr + qpwr < 2) {\r\nret = 0;\r\ngoto out;\r\n}\r\nprod_msb = fls(abs(prod));\r\nq_msb = fls(abs(qpwr));\r\ntmp1 = prod_msb - 20;\r\nif (tmp1 >= 0) {\r\ntmp3 = ((prod << (30 - prod_msb)) + (ipwr >> (1 + tmp1))) /\r\n(ipwr >> tmp1);\r\n} else {\r\ntmp3 = ((prod << (30 - prod_msb)) + (ipwr << (-1 - tmp1))) /\r\n(ipwr << -tmp1);\r\n}\r\ntmp2 = q_msb - 11;\r\nif (tmp2 >= 0)\r\ntmp4 = (qpwr << (31 - q_msb)) / (ipwr >> tmp2);\r\nelse\r\ntmp4 = (qpwr << (31 - q_msb)) / (ipwr << -tmp2);\r\ntmp4 -= tmp3 * tmp3;\r\ntmp4 = -int_sqrt(tmp4);\r\nc0 = tmp3 >> 3;\r\nc1 = tmp4 >> 4;\r\nout:\r\nb43_phy_maskset(dev, B43_LPPHY_RX_COMP_COEFF_S, 0xFF00, c1);\r\nb43_phy_maskset(dev, B43_LPPHY_RX_COMP_COEFF_S, 0x00FF, c0 << 8);\r\nreturn ret;\r\n}\r\nstatic void lpphy_run_samples(struct b43_wldev *dev, u16 samples, u16 loops,\r\nu16 wait)\r\n{\r\nb43_phy_maskset(dev, B43_LPPHY_SMPL_PLAY_BUFFER_CTL,\r\n0xFFC0, samples - 1);\r\nif (loops != 0xFFFF)\r\nloops--;\r\nb43_phy_maskset(dev, B43_LPPHY_SMPL_PLAY_COUNT, 0xF000, loops);\r\nb43_phy_maskset(dev, B43_LPPHY_SMPL_PLAY_BUFFER_CTL, 0x3F, wait << 6);\r\nb43_phy_set(dev, B43_LPPHY_A_PHY_CTL_ADDR, 0x1);\r\n}\r\nstatic void lpphy_start_tx_tone(struct b43_wldev *dev, s32 freq, u16 max)\r\n{\r\nstruct b43_phy_lp *lpphy = dev->phy.lp;\r\nu16 buf[64];\r\nint i, samples = 0, angle = 0;\r\nint rotation = (((36 * freq) / 20) << 16) / 100;\r\nstruct b43_c32 sample;\r\nlpphy->tx_tone_freq = freq;\r\nif (freq) {\r\nfor (i = 1; samples * abs(freq) != 20000 * i; i++) {\r\nsamples = (20000 * i) / abs(freq);\r\nif(B43_WARN_ON(samples > 63))\r\nreturn;\r\n}\r\n} else {\r\nsamples = 2;\r\n}\r\nfor (i = 0; i < samples; i++) {\r\nsample = b43_cordic(angle);\r\nangle += rotation;\r\nbuf[i] = CORDIC_CONVERT((sample.i * max) & 0xFF) << 8;\r\nbuf[i] |= CORDIC_CONVERT((sample.q * max) & 0xFF);\r\n}\r\nb43_lptab_write_bulk(dev, B43_LPTAB16(5, 0), samples, buf);\r\nlpphy_run_samples(dev, samples, 0xFFFF, 0);\r\n}\r\nstatic void lpphy_stop_tx_tone(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_lp *lpphy = dev->phy.lp;\r\nint i;\r\nlpphy->tx_tone_freq = 0;\r\nb43_phy_mask(dev, B43_LPPHY_SMPL_PLAY_COUNT, 0xF000);\r\nfor (i = 0; i < 31; i++) {\r\nif (!(b43_phy_read(dev, B43_LPPHY_A_PHY_CTL_ADDR) & 0x1))\r\nbreak;\r\nudelay(100);\r\n}\r\n}\r\nstatic void lpphy_papd_cal(struct b43_wldev *dev, struct lpphy_tx_gains gains,\r\nint mode, bool useindex, u8 index)\r\n{\r\n}\r\nstatic void lpphy_papd_cal_txpwr(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_lp *lpphy = dev->phy.lp;\r\nstruct lpphy_tx_gains gains, oldgains;\r\nint old_txpctl, old_afe_ovr, old_rf, old_bbmult;\r\nlpphy_read_tx_pctl_mode_from_hardware(dev);\r\nold_txpctl = lpphy->txpctl_mode;\r\nold_afe_ovr = b43_phy_read(dev, B43_LPPHY_AFE_CTL_OVR) & 0x40;\r\nif (old_afe_ovr)\r\noldgains = lpphy_get_tx_gains(dev);\r\nold_rf = b43_phy_read(dev, B43_LPPHY_RF_PWR_OVERRIDE) & 0xFF;\r\nold_bbmult = lpphy_get_bb_mult(dev);\r\nlpphy_set_tx_power_control(dev, B43_LPPHY_TXPCTL_OFF);\r\nif (dev->dev->chip_id == 0x4325 && dev->dev->chip_rev == 0)\r\nlpphy_papd_cal(dev, gains, 0, 1, 30);\r\nelse\r\nlpphy_papd_cal(dev, gains, 0, 1, 65);\r\nif (old_afe_ovr)\r\nlpphy_set_tx_gains(dev, oldgains);\r\nlpphy_set_bb_mult(dev, old_bbmult);\r\nlpphy_set_tx_power_control(dev, old_txpctl);\r\nb43_phy_maskset(dev, B43_LPPHY_RF_PWR_OVERRIDE, 0xFF00, old_rf);\r\n}\r\nstatic int lpphy_rx_iq_cal(struct b43_wldev *dev, bool noise, bool tx,\r\nbool rx, bool pa, struct lpphy_tx_gains *gains)\r\n{\r\nstruct b43_phy_lp *lpphy = dev->phy.lp;\r\nconst struct lpphy_rx_iq_comp *iqcomp = NULL;\r\nstruct lpphy_tx_gains nogains, oldgains;\r\nu16 tmp;\r\nint i, ret;\r\nmemset(&nogains, 0, sizeof(nogains));\r\nmemset(&oldgains, 0, sizeof(oldgains));\r\nif (dev->dev->chip_id == 0x5354) {\r\nfor (i = 0; i < ARRAY_SIZE(lpphy_5354_iq_table); i++) {\r\nif (lpphy_5354_iq_table[i].chan == lpphy->channel) {\r\niqcomp = &lpphy_5354_iq_table[i];\r\n}\r\n}\r\n} else if (dev->phy.rev >= 2) {\r\niqcomp = &lpphy_rev2plus_iq_comp;\r\n} else {\r\nfor (i = 0; i < ARRAY_SIZE(lpphy_rev0_1_iq_table); i++) {\r\nif (lpphy_rev0_1_iq_table[i].chan == lpphy->channel) {\r\niqcomp = &lpphy_rev0_1_iq_table[i];\r\n}\r\n}\r\n}\r\nif (B43_WARN_ON(!iqcomp))\r\nreturn 0;\r\nb43_phy_maskset(dev, B43_LPPHY_RX_COMP_COEFF_S, 0xFF00, iqcomp->c1);\r\nb43_phy_maskset(dev, B43_LPPHY_RX_COMP_COEFF_S,\r\n0x00FF, iqcomp->c0 << 8);\r\nif (noise) {\r\ntx = true;\r\nrx = false;\r\npa = false;\r\n}\r\nlpphy_set_trsw_over(dev, tx, rx);\r\nif (b43_current_band(dev->wl) == IEEE80211_BAND_2GHZ) {\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x8);\r\nb43_phy_maskset(dev, B43_LPPHY_RF_OVERRIDE_VAL_0,\r\n0xFFF7, pa << 3);\r\n} else {\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x20);\r\nb43_phy_maskset(dev, B43_LPPHY_RF_OVERRIDE_VAL_0,\r\n0xFFDF, pa << 5);\r\n}\r\ntmp = b43_phy_read(dev, B43_LPPHY_AFE_CTL_OVR) & 0x40;\r\nif (noise)\r\nlpphy_set_rx_gain(dev, 0x2D5D);\r\nelse {\r\nif (tmp)\r\noldgains = lpphy_get_tx_gains(dev);\r\nif (!gains)\r\ngains = &nogains;\r\nlpphy_set_tx_gains(dev, *gains);\r\n}\r\nb43_phy_mask(dev, B43_LPPHY_AFE_CTL_OVR, 0xFFFE);\r\nb43_phy_mask(dev, B43_LPPHY_AFE_CTL_OVRVAL, 0xFFFE);\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_0, 0x800);\r\nb43_phy_set(dev, B43_LPPHY_RF_OVERRIDE_VAL_0, 0x800);\r\nlpphy_set_deaf(dev, false);\r\nif (noise)\r\nret = lpphy_calc_rx_iq_comp(dev, 0xFFF0);\r\nelse {\r\nlpphy_start_tx_tone(dev, 4000, 100);\r\nret = lpphy_calc_rx_iq_comp(dev, 0x4000);\r\nlpphy_stop_tx_tone(dev);\r\n}\r\nlpphy_clear_deaf(dev, false);\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_0, 0xFFFC);\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_0, 0xFFF7);\r\nb43_phy_mask(dev, B43_LPPHY_RF_OVERRIDE_0, 0xFFDF);\r\nif (!noise) {\r\nif (tmp)\r\nlpphy_set_tx_gains(dev, oldgains);\r\nelse\r\nlpphy_disable_tx_gain_override(dev);\r\n}\r\nlpphy_disable_rx_gain_override(dev);\r\nb43_phy_mask(dev, B43_LPPHY_AFE_CTL_OVR, 0xFFFE);\r\nb43_phy_mask(dev, B43_LPPHY_AFE_CTL_OVRVAL, 0xF7FF);\r\nreturn ret;\r\n}\r\nstatic void lpphy_calibration(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_lp *lpphy = dev->phy.lp;\r\nenum b43_lpphy_txpctl_mode saved_pctl_mode;\r\nbool full_cal = false;\r\nif (lpphy->full_calib_chan != lpphy->channel) {\r\nfull_cal = true;\r\nlpphy->full_calib_chan = lpphy->channel;\r\n}\r\nb43_mac_suspend(dev);\r\nlpphy_btcoex_override(dev);\r\nif (dev->phy.rev >= 2)\r\nlpphy_save_dig_flt_state(dev);\r\nlpphy_read_tx_pctl_mode_from_hardware(dev);\r\nsaved_pctl_mode = lpphy->txpctl_mode;\r\nlpphy_set_tx_power_control(dev, B43_LPPHY_TXPCTL_OFF);\r\nif ((dev->phy.rev == 0) && (saved_pctl_mode != B43_LPPHY_TXPCTL_OFF))\r\nlpphy_pr41573_workaround(dev);\r\nif ((dev->phy.rev >= 2) && full_cal) {\r\nlpphy_papd_cal_txpwr(dev);\r\n}\r\nlpphy_set_tx_power_control(dev, saved_pctl_mode);\r\nif (dev->phy.rev >= 2)\r\nlpphy_restore_dig_flt_state(dev);\r\nlpphy_rx_iq_cal(dev, true, true, false, false, NULL);\r\nb43_mac_enable(dev);\r\n}\r\nstatic u16 b43_lpphy_op_read(struct b43_wldev *dev, u16 reg)\r\n{\r\nb43_write16(dev, B43_MMIO_PHY_CONTROL, reg);\r\nreturn b43_read16(dev, B43_MMIO_PHY_DATA);\r\n}\r\nstatic void b43_lpphy_op_write(struct b43_wldev *dev, u16 reg, u16 value)\r\n{\r\nb43_write16(dev, B43_MMIO_PHY_CONTROL, reg);\r\nb43_write16(dev, B43_MMIO_PHY_DATA, value);\r\n}\r\nstatic void b43_lpphy_op_maskset(struct b43_wldev *dev, u16 reg, u16 mask,\r\nu16 set)\r\n{\r\nb43_write16(dev, B43_MMIO_PHY_CONTROL, reg);\r\nb43_write16(dev, B43_MMIO_PHY_DATA,\r\n(b43_read16(dev, B43_MMIO_PHY_DATA) & mask) | set);\r\n}\r\nstatic u16 b43_lpphy_op_radio_read(struct b43_wldev *dev, u16 reg)\r\n{\r\nB43_WARN_ON(reg == 1);\r\nif (dev->phy.rev < 2) {\r\nif (reg != 0x4001)\r\nreg |= 0x100;\r\n} else\r\nreg |= 0x200;\r\nb43_write16(dev, B43_MMIO_RADIO_CONTROL, reg);\r\nreturn b43_read16(dev, B43_MMIO_RADIO_DATA_LOW);\r\n}\r\nstatic void b43_lpphy_op_radio_write(struct b43_wldev *dev, u16 reg, u16 value)\r\n{\r\nB43_WARN_ON(reg == 1);\r\nb43_write16(dev, B43_MMIO_RADIO_CONTROL, reg);\r\nb43_write16(dev, B43_MMIO_RADIO_DATA_LOW, value);\r\n}\r\nstatic void lpphy_b2062_reset_pll_bias(struct b43_wldev *dev)\r\n{\r\nb43_radio_write(dev, B2062_S_RFPLL_CTL2, 0xFF);\r\nudelay(20);\r\nif (dev->dev->chip_id == 0x5354) {\r\nb43_radio_write(dev, B2062_N_COMM1, 4);\r\nb43_radio_write(dev, B2062_S_RFPLL_CTL2, 4);\r\n} else {\r\nb43_radio_write(dev, B2062_S_RFPLL_CTL2, 0);\r\n}\r\nudelay(5);\r\n}\r\nstatic void lpphy_b2062_vco_calib(struct b43_wldev *dev)\r\n{\r\nb43_radio_write(dev, B2062_S_RFPLL_CTL21, 0x42);\r\nb43_radio_write(dev, B2062_S_RFPLL_CTL21, 0x62);\r\nudelay(200);\r\n}\r\nstatic int lpphy_b2062_tune(struct b43_wldev *dev,\r\nunsigned int channel)\r\n{\r\nstruct b43_phy_lp *lpphy = dev->phy.lp;\r\nstruct ssb_bus *bus = dev->dev->sdev->bus;\r\nconst struct b206x_channel *chandata = NULL;\r\nu32 crystal_freq = bus->chipco.pmu.crystalfreq * 1000;\r\nu32 tmp1, tmp2, tmp3, tmp4, tmp5, tmp6, tmp7, tmp8, tmp9;\r\nint i, err = 0;\r\nfor (i = 0; i < ARRAY_SIZE(b2062_chantbl); i++) {\r\nif (b2062_chantbl[i].channel == channel) {\r\nchandata = &b2062_chantbl[i];\r\nbreak;\r\n}\r\n}\r\nif (B43_WARN_ON(!chandata))\r\nreturn -EINVAL;\r\nb43_radio_set(dev, B2062_S_RFPLL_CTL14, 0x04);\r\nb43_radio_write(dev, B2062_N_LGENA_TUNE0, chandata->data[0]);\r\nb43_radio_write(dev, B2062_N_LGENA_TUNE2, chandata->data[1]);\r\nb43_radio_write(dev, B2062_N_LGENA_TUNE3, chandata->data[2]);\r\nb43_radio_write(dev, B2062_N_TX_TUNE, chandata->data[3]);\r\nb43_radio_write(dev, B2062_S_LGENG_CTL1, chandata->data[4]);\r\nb43_radio_write(dev, B2062_N_LGENA_CTL5, chandata->data[5]);\r\nb43_radio_write(dev, B2062_N_LGENA_CTL6, chandata->data[6]);\r\nb43_radio_write(dev, B2062_N_TX_PGA, chandata->data[7]);\r\nb43_radio_write(dev, B2062_N_TX_PAD, chandata->data[8]);\r\ntmp1 = crystal_freq / 1000;\r\ntmp2 = lpphy->pdiv * 1000;\r\nb43_radio_write(dev, B2062_S_RFPLL_CTL33, 0xCC);\r\nb43_radio_write(dev, B2062_S_RFPLL_CTL34, 0x07);\r\nlpphy_b2062_reset_pll_bias(dev);\r\ntmp3 = tmp2 * channel2freq_lp(channel);\r\nif (channel2freq_lp(channel) < 4000)\r\ntmp3 *= 2;\r\ntmp4 = 48 * tmp1;\r\ntmp6 = tmp3 / tmp4;\r\ntmp7 = tmp3 % tmp4;\r\nb43_radio_write(dev, B2062_S_RFPLL_CTL26, tmp6);\r\ntmp5 = tmp7 * 0x100;\r\ntmp6 = tmp5 / tmp4;\r\ntmp7 = tmp5 % tmp4;\r\nb43_radio_write(dev, B2062_S_RFPLL_CTL27, tmp6);\r\ntmp5 = tmp7 * 0x100;\r\ntmp6 = tmp5 / tmp4;\r\ntmp7 = tmp5 % tmp4;\r\nb43_radio_write(dev, B2062_S_RFPLL_CTL28, tmp6);\r\ntmp5 = tmp7 * 0x100;\r\ntmp6 = tmp5 / tmp4;\r\ntmp7 = tmp5 % tmp4;\r\nb43_radio_write(dev, B2062_S_RFPLL_CTL29, tmp6 + ((2 * tmp7) / tmp4));\r\ntmp8 = b43_radio_read(dev, B2062_S_RFPLL_CTL19);\r\ntmp9 = ((2 * tmp3 * (tmp8 + 1)) + (3 * tmp1)) / (6 * tmp1);\r\nb43_radio_write(dev, B2062_S_RFPLL_CTL23, (tmp9 >> 8) + 16);\r\nb43_radio_write(dev, B2062_S_RFPLL_CTL24, tmp9 & 0xFF);\r\nlpphy_b2062_vco_calib(dev);\r\nif (b43_radio_read(dev, B2062_S_RFPLL_CTL3) & 0x10) {\r\nb43_radio_write(dev, B2062_S_RFPLL_CTL33, 0xFC);\r\nb43_radio_write(dev, B2062_S_RFPLL_CTL34, 0);\r\nlpphy_b2062_reset_pll_bias(dev);\r\nlpphy_b2062_vco_calib(dev);\r\nif (b43_radio_read(dev, B2062_S_RFPLL_CTL3) & 0x10)\r\nerr = -EIO;\r\n}\r\nb43_radio_mask(dev, B2062_S_RFPLL_CTL14, ~0x04);\r\nreturn err;\r\n}\r\nstatic void lpphy_b2063_vco_calib(struct b43_wldev *dev)\r\n{\r\nu16 tmp;\r\nb43_radio_mask(dev, B2063_PLL_SP1, ~0x40);\r\ntmp = b43_radio_read(dev, B2063_PLL_JTAG_CALNRST) & 0xF8;\r\nb43_radio_write(dev, B2063_PLL_JTAG_CALNRST, tmp);\r\nudelay(1);\r\nb43_radio_write(dev, B2063_PLL_JTAG_CALNRST, tmp | 0x4);\r\nudelay(1);\r\nb43_radio_write(dev, B2063_PLL_JTAG_CALNRST, tmp | 0x6);\r\nudelay(1);\r\nb43_radio_write(dev, B2063_PLL_JTAG_CALNRST, tmp | 0x7);\r\nudelay(300);\r\nb43_radio_set(dev, B2063_PLL_SP1, 0x40);\r\n}\r\nstatic int lpphy_b2063_tune(struct b43_wldev *dev,\r\nunsigned int channel)\r\n{\r\nstruct ssb_bus *bus = dev->dev->sdev->bus;\r\nstatic const struct b206x_channel *chandata = NULL;\r\nu32 crystal_freq = bus->chipco.pmu.crystalfreq * 1000;\r\nu32 freqref, vco_freq, val1, val2, val3, timeout, timeoutref, count;\r\nu16 old_comm15, scale;\r\nu32 tmp1, tmp2, tmp3, tmp4, tmp5, tmp6;\r\nint i, div = (crystal_freq <= 26000000 ? 1 : 2);\r\nfor (i = 0; i < ARRAY_SIZE(b2063_chantbl); i++) {\r\nif (b2063_chantbl[i].channel == channel) {\r\nchandata = &b2063_chantbl[i];\r\nbreak;\r\n}\r\n}\r\nif (B43_WARN_ON(!chandata))\r\nreturn -EINVAL;\r\nb43_radio_write(dev, B2063_LOGEN_VCOBUF1, chandata->data[0]);\r\nb43_radio_write(dev, B2063_LOGEN_MIXER2, chandata->data[1]);\r\nb43_radio_write(dev, B2063_LOGEN_BUF2, chandata->data[2]);\r\nb43_radio_write(dev, B2063_LOGEN_RCCR1, chandata->data[3]);\r\nb43_radio_write(dev, B2063_A_RX_1ST3, chandata->data[4]);\r\nb43_radio_write(dev, B2063_A_RX_2ND1, chandata->data[5]);\r\nb43_radio_write(dev, B2063_A_RX_2ND4, chandata->data[6]);\r\nb43_radio_write(dev, B2063_A_RX_2ND7, chandata->data[7]);\r\nb43_radio_write(dev, B2063_A_RX_PS6, chandata->data[8]);\r\nb43_radio_write(dev, B2063_TX_RF_CTL2, chandata->data[9]);\r\nb43_radio_write(dev, B2063_TX_RF_CTL5, chandata->data[10]);\r\nb43_radio_write(dev, B2063_PA_CTL11, chandata->data[11]);\r\nold_comm15 = b43_radio_read(dev, B2063_COMM15);\r\nb43_radio_set(dev, B2063_COMM15, 0x1E);\r\nif (chandata->freq > 4000)\r\nvco_freq = chandata->freq << 1;\r\nelse\r\nvco_freq = chandata->freq << 2;\r\nfreqref = crystal_freq * 3;\r\nval1 = lpphy_qdiv_roundup(crystal_freq, 1000000, 16);\r\nval2 = lpphy_qdiv_roundup(crystal_freq, 1000000 * div, 16);\r\nval3 = lpphy_qdiv_roundup(vco_freq, 3, 16);\r\ntimeout = ((((8 * crystal_freq) / (div * 5000000)) + 1) >> 1) - 1;\r\nb43_radio_write(dev, B2063_PLL_JTAG_PLL_VCO_CALIB3, 0x2);\r\nb43_radio_maskset(dev, B2063_PLL_JTAG_PLL_VCO_CALIB6,\r\n0xFFF8, timeout >> 2);\r\nb43_radio_maskset(dev, B2063_PLL_JTAG_PLL_VCO_CALIB7,\r\n0xFF9F,timeout << 5);\r\ntimeoutref = ((((8 * crystal_freq) / (div * (timeout + 1))) +\r\n999999) / 1000000) + 1;\r\nb43_radio_write(dev, B2063_PLL_JTAG_PLL_VCO_CALIB5, timeoutref);\r\ncount = lpphy_qdiv_roundup(val3, val2 + 16, 16);\r\ncount *= (timeout + 1) * (timeoutref + 1);\r\ncount--;\r\nb43_radio_maskset(dev, B2063_PLL_JTAG_PLL_VCO_CALIB7,\r\n0xF0, count >> 8);\r\nb43_radio_write(dev, B2063_PLL_JTAG_PLL_VCO_CALIB8, count & 0xFF);\r\ntmp1 = ((val3 * 62500) / freqref) << 4;\r\ntmp2 = ((val3 * 62500) % freqref) << 4;\r\nwhile (tmp2 >= freqref) {\r\ntmp1++;\r\ntmp2 -= freqref;\r\n}\r\nb43_radio_maskset(dev, B2063_PLL_JTAG_PLL_SG1, 0xFFE0, tmp1 >> 4);\r\nb43_radio_maskset(dev, B2063_PLL_JTAG_PLL_SG2, 0xFE0F, tmp1 << 4);\r\nb43_radio_maskset(dev, B2063_PLL_JTAG_PLL_SG2, 0xFFF0, tmp1 >> 16);\r\nb43_radio_write(dev, B2063_PLL_JTAG_PLL_SG3, (tmp2 >> 8) & 0xFF);\r\nb43_radio_write(dev, B2063_PLL_JTAG_PLL_SG4, tmp2 & 0xFF);\r\nb43_radio_write(dev, B2063_PLL_JTAG_PLL_LF1, 0xB9);\r\nb43_radio_write(dev, B2063_PLL_JTAG_PLL_LF2, 0x88);\r\nb43_radio_write(dev, B2063_PLL_JTAG_PLL_LF3, 0x28);\r\nb43_radio_write(dev, B2063_PLL_JTAG_PLL_LF4, 0x63);\r\ntmp3 = ((41 * (val3 - 3000)) /1200) + 27;\r\ntmp4 = lpphy_qdiv_roundup(132000 * tmp1, 8451, 16);\r\nif ((tmp4 + tmp3 - 1) / tmp3 > 60) {\r\nscale = 1;\r\ntmp5 = ((tmp4 + tmp3) / (tmp3 << 1)) - 8;\r\n} else {\r\nscale = 0;\r\ntmp5 = ((tmp4 + (tmp3 >> 1)) / tmp3) - 8;\r\n}\r\nb43_radio_maskset(dev, B2063_PLL_JTAG_PLL_CP2, 0xFFC0, tmp5);\r\nb43_radio_maskset(dev, B2063_PLL_JTAG_PLL_CP2, 0xFFBF, scale << 6);\r\ntmp6 = lpphy_qdiv_roundup(100 * val1, val3, 16);\r\ntmp6 *= (tmp5 * 8) * (scale + 1);\r\nif (tmp6 > 150)\r\ntmp6 = 0;\r\nb43_radio_maskset(dev, B2063_PLL_JTAG_PLL_CP3, 0xFFE0, tmp6);\r\nb43_radio_maskset(dev, B2063_PLL_JTAG_PLL_CP3, 0xFFDF, scale << 5);\r\nb43_radio_maskset(dev, B2063_PLL_JTAG_PLL_XTAL_12, 0xFFFB, 0x4);\r\nif (crystal_freq > 26000000)\r\nb43_radio_set(dev, B2063_PLL_JTAG_PLL_XTAL_12, 0x2);\r\nelse\r\nb43_radio_mask(dev, B2063_PLL_JTAG_PLL_XTAL_12, 0xFD);\r\nif (val1 == 45)\r\nb43_radio_set(dev, B2063_PLL_JTAG_PLL_VCO1, 0x2);\r\nelse\r\nb43_radio_mask(dev, B2063_PLL_JTAG_PLL_VCO1, 0xFD);\r\nb43_radio_set(dev, B2063_PLL_SP2, 0x3);\r\nudelay(1);\r\nb43_radio_mask(dev, B2063_PLL_SP2, 0xFFFC);\r\nlpphy_b2063_vco_calib(dev);\r\nb43_radio_write(dev, B2063_COMM15, old_comm15);\r\nreturn 0;\r\n}\r\nstatic int b43_lpphy_op_switch_channel(struct b43_wldev *dev,\r\nunsigned int new_channel)\r\n{\r\nstruct b43_phy_lp *lpphy = dev->phy.lp;\r\nint err;\r\nif (dev->phy.radio_ver == 0x2063) {\r\nerr = lpphy_b2063_tune(dev, new_channel);\r\nif (err)\r\nreturn err;\r\n} else {\r\nerr = lpphy_b2062_tune(dev, new_channel);\r\nif (err)\r\nreturn err;\r\nlpphy_set_analog_filter(dev, new_channel);\r\nlpphy_adjust_gain_table(dev, channel2freq_lp(new_channel));\r\n}\r\nlpphy->channel = new_channel;\r\nb43_write16(dev, B43_MMIO_CHANNEL, new_channel);\r\nreturn 0;\r\n}\r\nstatic int b43_lpphy_op_init(struct b43_wldev *dev)\r\n{\r\nint err;\r\nif (dev->dev->bus_type != B43_BUS_SSB) {\r\nb43err(dev->wl, "LP-PHY is supported only on SSB!\n");\r\nreturn -EOPNOTSUPP;\r\n}\r\nlpphy_read_band_sprom(dev);\r\nlpphy_baseband_init(dev);\r\nlpphy_radio_init(dev);\r\nlpphy_calibrate_rc(dev);\r\nerr = b43_lpphy_op_switch_channel(dev, 7);\r\nif (err) {\r\nb43dbg(dev->wl, "Switch to channel 7 failed, error = %d.\n",\r\nerr);\r\n}\r\nlpphy_tx_pctl_init(dev);\r\nlpphy_calibration(dev);\r\nreturn 0;\r\n}\r\nstatic void b43_lpphy_op_adjust_txpower(struct b43_wldev *dev)\r\n{\r\n}\r\nstatic enum b43_txpwr_result b43_lpphy_op_recalc_txpower(struct b43_wldev *dev,\r\nbool ignore_tssi)\r\n{\r\nreturn B43_TXPWR_RES_DONE;\r\n}\r\nstatic void b43_lpphy_op_switch_analog(struct b43_wldev *dev, bool on)\r\n{\r\nif (on) {\r\nb43_phy_mask(dev, B43_LPPHY_AFE_CTL_OVR, 0xfff8);\r\n} else {\r\nb43_phy_set(dev, B43_LPPHY_AFE_CTL_OVRVAL, 0x0007);\r\nb43_phy_set(dev, B43_LPPHY_AFE_CTL_OVR, 0x0007);\r\n}\r\n}\r\nstatic void b43_lpphy_op_pwork_15sec(struct b43_wldev *dev)\r\n{\r\n}

static inline bool sdhci_acpi_flag(struct sdhci_acpi_host *c, unsigned int flag)\r\n{\r\nreturn c->slot && (c->slot->flags & flag);\r\n}\r\nstatic int sdhci_acpi_enable_dma(struct sdhci_host *host)\r\n{\r\nreturn 0;\r\n}\r\nstatic const struct sdhci_acpi_slot *sdhci_acpi_get_slot(const char *hid)\r\n{\r\nconst struct acpi_device_id *id;\r\nfor (id = sdhci_acpi_ids; id->id[0]; id++)\r\nif (!strcmp(id->id, hid))\r\nreturn (const struct sdhci_acpi_slot *)id->driver_data;\r\nreturn NULL;\r\n}\r\nstatic int sdhci_acpi_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nacpi_handle handle = ACPI_HANDLE(dev);\r\nstruct acpi_device *device;\r\nstruct sdhci_acpi_host *c;\r\nstruct sdhci_host *host;\r\nstruct resource *iomem;\r\nresource_size_t len;\r\nconst char *hid;\r\nint err;\r\nif (acpi_bus_get_device(handle, &device))\r\nreturn -ENODEV;\r\nif (acpi_bus_get_status(device) || !device->status.present)\r\nreturn -ENODEV;\r\nhid = acpi_device_hid(device);\r\niomem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!iomem)\r\nreturn -ENOMEM;\r\nlen = resource_size(iomem);\r\nif (len < 0x100)\r\ndev_err(dev, "Invalid iomem size!\n");\r\nif (!devm_request_mem_region(dev, iomem->start, len, dev_name(dev)))\r\nreturn -ENOMEM;\r\nhost = sdhci_alloc_host(dev, sizeof(struct sdhci_acpi_host));\r\nif (IS_ERR(host))\r\nreturn PTR_ERR(host);\r\nc = sdhci_priv(host);\r\nc->host = host;\r\nc->slot = sdhci_acpi_get_slot(hid);\r\nc->pdev = pdev;\r\nc->use_runtime_pm = sdhci_acpi_flag(c, SDHCI_ACPI_RUNTIME_PM);\r\nplatform_set_drvdata(pdev, c);\r\nhost->hw_name = "ACPI";\r\nhost->ops = &sdhci_acpi_ops_dflt;\r\nhost->irq = platform_get_irq(pdev, 0);\r\nhost->ioaddr = devm_ioremap_nocache(dev, iomem->start,\r\nresource_size(iomem));\r\nif (host->ioaddr == NULL) {\r\nerr = -ENOMEM;\r\ngoto err_free;\r\n}\r\nif (!dev->dma_mask) {\r\nu64 dma_mask;\r\nif (sdhci_readl(host, SDHCI_CAPABILITIES) & SDHCI_CAN_64BIT) {\r\ndma_mask = DMA_BIT_MASK(32);\r\n} else {\r\ndma_mask = DMA_BIT_MASK(32);\r\n}\r\ndev->dma_mask = &dev->coherent_dma_mask;\r\ndev->coherent_dma_mask = dma_mask;\r\n}\r\nif (c->slot) {\r\nif (c->slot->chip) {\r\nhost->ops = c->slot->chip->ops;\r\nhost->quirks |= c->slot->chip->quirks;\r\nhost->quirks2 |= c->slot->chip->quirks2;\r\nhost->mmc->caps |= c->slot->chip->caps;\r\nhost->mmc->caps2 |= c->slot->chip->caps2;\r\nhost->mmc->pm_caps |= c->slot->chip->pm_caps;\r\n}\r\nhost->quirks |= c->slot->quirks;\r\nhost->quirks2 |= c->slot->quirks2;\r\nhost->mmc->caps |= c->slot->caps;\r\nhost->mmc->caps2 |= c->slot->caps2;\r\nhost->mmc->pm_caps |= c->slot->pm_caps;\r\n}\r\nerr = sdhci_add_host(host);\r\nif (err)\r\ngoto err_free;\r\nif (c->use_runtime_pm) {\r\npm_suspend_ignore_children(dev, 1);\r\npm_runtime_set_autosuspend_delay(dev, 50);\r\npm_runtime_use_autosuspend(dev);\r\npm_runtime_enable(dev);\r\n}\r\nreturn 0;\r\nerr_free:\r\nplatform_set_drvdata(pdev, NULL);\r\nsdhci_free_host(c->host);\r\nreturn err;\r\n}\r\nstatic int sdhci_acpi_remove(struct platform_device *pdev)\r\n{\r\nstruct sdhci_acpi_host *c = platform_get_drvdata(pdev);\r\nstruct device *dev = &pdev->dev;\r\nint dead;\r\nif (c->use_runtime_pm) {\r\npm_runtime_get_sync(dev);\r\npm_runtime_disable(dev);\r\npm_runtime_put_noidle(dev);\r\n}\r\ndead = (sdhci_readl(c->host, SDHCI_INT_STATUS) == ~0);\r\nsdhci_remove_host(c->host, dead);\r\nplatform_set_drvdata(pdev, NULL);\r\nsdhci_free_host(c->host);\r\nreturn 0;\r\n}\r\nstatic int sdhci_acpi_suspend(struct device *dev)\r\n{\r\nstruct sdhci_acpi_host *c = dev_get_drvdata(dev);\r\nreturn sdhci_suspend_host(c->host);\r\n}\r\nstatic int sdhci_acpi_resume(struct device *dev)\r\n{\r\nstruct sdhci_acpi_host *c = dev_get_drvdata(dev);\r\nreturn sdhci_resume_host(c->host);\r\n}\r\nstatic int sdhci_acpi_runtime_suspend(struct device *dev)\r\n{\r\nstruct sdhci_acpi_host *c = dev_get_drvdata(dev);\r\nreturn sdhci_runtime_suspend_host(c->host);\r\n}\r\nstatic int sdhci_acpi_runtime_resume(struct device *dev)\r\n{\r\nstruct sdhci_acpi_host *c = dev_get_drvdata(dev);\r\nreturn sdhci_runtime_resume_host(c->host);\r\n}\r\nstatic int sdhci_acpi_runtime_idle(struct device *dev)\r\n{\r\nreturn 0;\r\n}

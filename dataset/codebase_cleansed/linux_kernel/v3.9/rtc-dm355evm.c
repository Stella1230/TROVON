static int dm355evm_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nunion evm_time time;\r\nint status;\r\nint tries = 0;\r\ndo {\r\nstatus = dm355evm_msp_read(DM355EVM_MSP_RTC_0);\r\nif (status < 0)\r\nreturn status;\r\nif (tries && time.bytes[0] == status)\r\nbreak;\r\ntime.bytes[0] = status;\r\nstatus = dm355evm_msp_read(DM355EVM_MSP_RTC_1);\r\nif (status < 0)\r\nreturn status;\r\nif (tries && time.bytes[1] == status)\r\nbreak;\r\ntime.bytes[1] = status;\r\nstatus = dm355evm_msp_read(DM355EVM_MSP_RTC_2);\r\nif (status < 0)\r\nreturn status;\r\nif (tries && time.bytes[2] == status)\r\nbreak;\r\ntime.bytes[2] = status;\r\nstatus = dm355evm_msp_read(DM355EVM_MSP_RTC_3);\r\nif (status < 0)\r\nreturn status;\r\nif (tries && time.bytes[3] == status)\r\nbreak;\r\ntime.bytes[3] = status;\r\n} while (++tries < 5);\r\ndev_dbg(dev, "read timestamp %08x\n", time.value);\r\nrtc_time_to_tm(le32_to_cpu(time.value), tm);\r\nreturn 0;\r\n}\r\nstatic int dm355evm_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nunion evm_time time;\r\nunsigned long value;\r\nint status;\r\nrtc_tm_to_time(tm, &value);\r\ntime.value = cpu_to_le32(value);\r\ndev_dbg(dev, "write timestamp %08x\n", time.value);\r\nstatus = dm355evm_msp_write(time.bytes[0], DM355EVM_MSP_RTC_0);\r\nif (status < 0)\r\nreturn status;\r\nstatus = dm355evm_msp_write(time.bytes[1], DM355EVM_MSP_RTC_1);\r\nif (status < 0)\r\nreturn status;\r\nstatus = dm355evm_msp_write(time.bytes[2], DM355EVM_MSP_RTC_2);\r\nif (status < 0)\r\nreturn status;\r\nstatus = dm355evm_msp_write(time.bytes[3], DM355EVM_MSP_RTC_3);\r\nif (status < 0)\r\nreturn status;\r\nreturn 0;\r\n}\r\nstatic int dm355evm_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct rtc_device *rtc;\r\nrtc = rtc_device_register(pdev->name,\r\n&pdev->dev, &dm355evm_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc)) {\r\ndev_err(&pdev->dev, "can't register RTC device, err %ld\n",\r\nPTR_ERR(rtc));\r\nreturn PTR_ERR(rtc);\r\n}\r\nplatform_set_drvdata(pdev, rtc);\r\nreturn 0;\r\n}\r\nstatic int dm355evm_rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct rtc_device *rtc = platform_get_drvdata(pdev);\r\nrtc_device_unregister(rtc);\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn 0;\r\n}

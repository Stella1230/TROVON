static void\r\nnv20_devinit_meminit(struct nouveau_devinit *devinit)\r\n{\r\nstruct nv20_devinit_priv *priv = (void *)devinit;\r\nstruct nouveau_device *device = nv_device(priv);\r\nuint32_t mask = (device->chipset >= 0x25 ? 0x300 : 0x900);\r\nuint32_t amount, off;\r\nstruct io_mapping *fb;\r\nfb = fbmem_init(nv_device(priv)->pdev);\r\nif (!fb) {\r\nnv_error(priv, "failed to map fb\n");\r\nreturn;\r\n}\r\nnv_wr32(priv, NV10_PFB_REFCTRL, NV10_PFB_REFCTRL_VALID_1);\r\nnv_mask(priv, NV04_PFB_CFG0, 0, mask);\r\namount = nv_rd32(priv, 0x10020c);\r\nfor (off = amount; off > 0x2000000; off -= 0x2000000)\r\nfbmem_poke(fb, off - 4, off);\r\namount = nv_rd32(priv, 0x10020c);\r\nif (amount != fbmem_peek(fb, amount - 4))\r\nnv_mask(priv, NV04_PFB_CFG0, mask, 0);\r\nfbmem_fini(fb);\r\n}\r\nstatic int\r\nnv20_devinit_ctor(struct nouveau_object *parent, struct nouveau_object *engine,\r\nstruct nouveau_oclass *oclass, void *data, u32 size,\r\nstruct nouveau_object **pobject)\r\n{\r\nstruct nv20_devinit_priv *priv;\r\nint ret;\r\nret = nouveau_devinit_create(parent, engine, oclass, &priv);\r\n*pobject = nv_object(priv);\r\nif (ret)\r\nreturn ret;\r\npriv->base.meminit = nv20_devinit_meminit;\r\nreturn 0;\r\n}

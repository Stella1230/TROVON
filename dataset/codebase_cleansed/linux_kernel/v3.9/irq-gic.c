unsigned int gic_get_timer_pending(void)\r\n{\r\nunsigned int vpe_pending;\r\nGICWRITE(GIC_REG(VPE_LOCAL, GIC_VPE_OTHER_ADDR), 0);\r\nGICREAD(GIC_REG(VPE_OTHER, GIC_VPE_PEND), vpe_pending);\r\nreturn (vpe_pending & GIC_VPE_PEND_TIMER_MSK);\r\n}\r\nvoid gic_bind_eic_interrupt(int irq, int set)\r\n{\r\nirq -= GIC_PIN_TO_VEC_OFFSET;\r\nGICWRITE(GIC_REG_ADDR(VPE_LOCAL, GIC_VPE_EIC_SS(irq)), set);\r\n}\r\nvoid gic_send_ipi(unsigned int intr)\r\n{\r\nGICWRITE(GIC_REG(SHARED, GIC_SH_WEDGE), 0x80000000 | intr);\r\n}\r\nstatic void gic_eic_irq_dispatch(void)\r\n{\r\nunsigned int cause = read_c0_cause();\r\nint irq;\r\nirq = (cause & ST0_IM) >> STATUSB_IP2;\r\nif (irq == 0)\r\nirq = -1;\r\nif (irq >= 0)\r\ndo_IRQ(gic_irq_base + irq);\r\nelse\r\nspurious_interrupt();\r\n}\r\nstatic void __init vpe_local_setup(unsigned int numvpes)\r\n{\r\nunsigned long timer_intr = GIC_INT_TMR;\r\nunsigned long perf_intr = GIC_INT_PERFCTR;\r\nunsigned int vpe_ctl;\r\nint i;\r\nif (cpu_has_veic) {\r\ntimer_intr += (GIC_CPU_TO_VEC_OFFSET - GIC_PIN_TO_VEC_OFFSET);\r\nperf_intr += (GIC_CPU_TO_VEC_OFFSET - GIC_PIN_TO_VEC_OFFSET);\r\n}\r\nfor (i = 0; i < numvpes; i++) {\r\nGICWRITE(GIC_REG(VPE_LOCAL, GIC_VPE_OTHER_ADDR), i);\r\nGICREAD(GIC_REG(VPE_OTHER, GIC_VPE_CTL), vpe_ctl);\r\nif (vpe_ctl & GIC_VPE_CTL_TIMER_RTBL_MSK)\r\nGICWRITE(GIC_REG(VPE_OTHER, GIC_VPE_TIMER_MAP),\r\nGIC_MAP_TO_PIN_MSK | timer_intr);\r\nif (cpu_has_veic) {\r\nset_vi_handler(timer_intr + GIC_PIN_TO_VEC_OFFSET,\r\ngic_eic_irq_dispatch);\r\ngic_shared_intr_map[timer_intr + GIC_PIN_TO_VEC_OFFSET].local_intr_mask |= GIC_VPE_RMASK_TIMER_MSK;\r\n}\r\nif (vpe_ctl & GIC_VPE_CTL_PERFCNT_RTBL_MSK)\r\nGICWRITE(GIC_REG(VPE_OTHER, GIC_VPE_PERFCTR_MAP),\r\nGIC_MAP_TO_PIN_MSK | perf_intr);\r\nif (cpu_has_veic) {\r\nset_vi_handler(perf_intr + GIC_PIN_TO_VEC_OFFSET, gic_eic_irq_dispatch);\r\ngic_shared_intr_map[perf_intr + GIC_PIN_TO_VEC_OFFSET].local_intr_mask |= GIC_VPE_RMASK_PERFCNT_MSK;\r\n}\r\n}\r\n}\r\nunsigned int gic_get_int(void)\r\n{\r\nunsigned int i;\r\nunsigned long *pending, *intrmask, *pcpu_mask;\r\nunsigned long *pending_abs, *intrmask_abs;\r\npending = pending_regs[smp_processor_id()].pending;\r\nintrmask = intrmask_regs[smp_processor_id()].intrmask;\r\npcpu_mask = pcpu_masks[smp_processor_id()].pcpu_mask;\r\npending_abs = (unsigned long *) GIC_REG_ABS_ADDR(SHARED,\r\nGIC_SH_PEND_31_0_OFS);\r\nintrmask_abs = (unsigned long *) GIC_REG_ABS_ADDR(SHARED,\r\nGIC_SH_MASK_31_0_OFS);\r\nfor (i = 0; i < BITS_TO_LONGS(GIC_NUM_INTRS); i++) {\r\nGICREAD(*pending_abs, pending[i]);\r\nGICREAD(*intrmask_abs, intrmask[i]);\r\npending_abs++;\r\nintrmask_abs++;\r\n}\r\nbitmap_and(pending, pending, intrmask, GIC_NUM_INTRS);\r\nbitmap_and(pending, pending, pcpu_mask, GIC_NUM_INTRS);\r\nreturn find_first_bit(pending, GIC_NUM_INTRS);\r\n}\r\nstatic void gic_mask_irq(struct irq_data *d)\r\n{\r\nGIC_CLR_INTR_MASK(d->irq - gic_irq_base);\r\n}\r\nstatic void gic_unmask_irq(struct irq_data *d)\r\n{\r\nGIC_SET_INTR_MASK(d->irq - gic_irq_base);\r\n}\r\nstatic int gic_set_affinity(struct irq_data *d, const struct cpumask *cpumask,\r\nbool force)\r\n{\r\nunsigned int irq = (d->irq - gic_irq_base);\r\ncpumask_t tmp = CPU_MASK_NONE;\r\nunsigned long flags;\r\nint i;\r\ncpumask_and(&tmp, cpumask, cpu_online_mask);\r\nif (cpus_empty(tmp))\r\nreturn -1;\r\nspin_lock_irqsave(&gic_lock, flags);\r\nfor (;;) {\r\nGIC_SH_MAP_TO_VPE_SMASK(irq, first_cpu(tmp));\r\nfor (i = 0; i < NR_CPUS; i++)\r\nclear_bit(irq, pcpu_masks[i].pcpu_mask);\r\nset_bit(irq, pcpu_masks[first_cpu(tmp)].pcpu_mask);\r\n}\r\ncpumask_copy(d->affinity, cpumask);\r\nspin_unlock_irqrestore(&gic_lock, flags);\r\nreturn IRQ_SET_MASK_OK_NOCOPY;\r\n}\r\nstatic void __init gic_setup_intr(unsigned int intr, unsigned int cpu,\r\nunsigned int pin, unsigned int polarity, unsigned int trigtype,\r\nunsigned int flags)\r\n{\r\nstruct gic_shared_intr_map *map_ptr;\r\nif (pin & GIC_MAP_TO_NMI_MSK) {\r\nGICWRITE(GIC_REG_ADDR(SHARED, GIC_SH_MAP_TO_PIN(intr)), pin);\r\nfor (cpu = 0; cpu < NR_CPUS; cpu += 32) {\r\nGICWRITE(GIC_REG_ADDR(SHARED,\r\nGIC_SH_MAP_TO_VPE_REG_OFF(intr, cpu)),\r\n0xffffffff);\r\n}\r\n} else {\r\nGICWRITE(GIC_REG_ADDR(SHARED, GIC_SH_MAP_TO_PIN(intr)),\r\nGIC_MAP_TO_PIN_MSK | pin);\r\nGIC_SH_MAP_TO_VPE_SMASK(intr, cpu);\r\nif (cpu_has_veic) {\r\nset_vi_handler(pin + GIC_PIN_TO_VEC_OFFSET,\r\ngic_eic_irq_dispatch);\r\nmap_ptr = &gic_shared_intr_map[pin + GIC_PIN_TO_VEC_OFFSET];\r\nif (map_ptr->num_shared_intr >= GIC_MAX_SHARED_INTR)\r\nBUG();\r\nmap_ptr->intr_list[map_ptr->num_shared_intr++] = intr;\r\n}\r\n}\r\nGIC_SET_POLARITY(intr, polarity);\r\nGIC_SET_TRIGGER(intr, trigtype);\r\nGIC_CLR_INTR_MASK(intr);\r\nif (flags & GIC_FLAG_IPI)\r\nset_bit(intr, pcpu_masks[cpu].pcpu_mask);\r\nif ((flags & GIC_FLAG_TRANSPARENT) && (cpu_has_veic == 0))\r\nGIC_SET_INTR_MASK(intr);\r\nif (trigtype == GIC_TRIG_EDGE)\r\ngic_irq_flags[intr] |= GIC_TRIG_EDGE;\r\n}\r\nstatic void __init gic_basic_init(int numintrs, int numvpes,\r\nstruct gic_intr_map *intrmap, int mapsize)\r\n{\r\nunsigned int i, cpu;\r\nunsigned int pin_offset = 0;\r\nboard_bind_eic_interrupt = &gic_bind_eic_interrupt;\r\nfor (i = 0; i < numintrs; i++) {\r\nGIC_SET_POLARITY(i, GIC_POL_POS);\r\nGIC_SET_TRIGGER(i, GIC_TRIG_LEVEL);\r\nGIC_CLR_INTR_MASK(i);\r\nif (i < GIC_NUM_INTRS) {\r\ngic_irq_flags[i] = 0;\r\ngic_shared_intr_map[i].num_shared_intr = 0;\r\ngic_shared_intr_map[i].local_intr_mask = 0;\r\n}\r\n}\r\nif (cpu_has_veic)\r\npin_offset = (GIC_CPU_TO_VEC_OFFSET - GIC_PIN_TO_VEC_OFFSET);\r\nfor (i = 0; i < mapsize; i++) {\r\ncpu = intrmap[i].cpunum;\r\nif (cpu == GIC_UNUSED)\r\ncontinue;\r\nif (cpu == 0 && i != 0 && intrmap[i].flags == 0)\r\ncontinue;\r\ngic_setup_intr(i,\r\nintrmap[i].cpunum,\r\nintrmap[i].pin + pin_offset,\r\nintrmap[i].polarity,\r\nintrmap[i].trigtype,\r\nintrmap[i].flags);\r\n}\r\nvpe_local_setup(numvpes);\r\n}\r\nvoid __init gic_init(unsigned long gic_base_addr,\r\nunsigned long gic_addrspace_size,\r\nstruct gic_intr_map *intr_map, unsigned int intr_map_size,\r\nunsigned int irqbase)\r\n{\r\nunsigned int gicconfig;\r\nint numvpes, numintrs;\r\n_gic_base = (unsigned long) ioremap_nocache(gic_base_addr,\r\ngic_addrspace_size);\r\ngic_irq_base = irqbase;\r\nGICREAD(GIC_REG(SHARED, GIC_SH_CONFIG), gicconfig);\r\nnumintrs = (gicconfig & GIC_SH_CONFIG_NUMINTRS_MSK) >>\r\nGIC_SH_CONFIG_NUMINTRS_SHF;\r\nnumintrs = ((numintrs + 1) * 8);\r\nnumvpes = (gicconfig & GIC_SH_CONFIG_NUMVPES_MSK) >>\r\nGIC_SH_CONFIG_NUMVPES_SHF;\r\nnumvpes = numvpes + 1;\r\ngic_basic_init(numintrs, numvpes, intr_map, intr_map_size);\r\ngic_platform_init(numintrs, &gic_irq_controller);\r\n}

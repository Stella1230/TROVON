static void reload_slb(struct kvm_vcpu *vcpu)\r\n{\r\nstruct slb_shadow *slb;\r\nunsigned long i, n;\r\nasm volatile("slbmte %0,%0; slbia" : : "r" (0));\r\nslb = vcpu->arch.slb_shadow.pinned_addr;\r\nif (!slb)\r\nreturn;\r\nn = min_t(u32, slb->persistent, SLB_MIN_SIZE);\r\nif ((void *) &slb->save_area[n] > vcpu->arch.slb_shadow.pinned_end)\r\nreturn;\r\nfor (i = 0; i < n; ++i) {\r\nunsigned long rb = slb->save_area[i].esid;\r\nunsigned long rs = slb->save_area[i].vsid;\r\nrb = (rb & ~0xFFFul) | i;\r\nasm volatile("slbmte %0,%1" : : "r" (rs), "r" (rb));\r\n}\r\n}\r\nstatic void flush_tlb_power7(struct kvm_vcpu *vcpu)\r\n{\r\nunsigned long i, rb;\r\nrb = TLBIEL_INVAL_SET_LPID;\r\nfor (i = 0; i < POWER7_TLB_SETS; ++i) {\r\nasm volatile("tlbiel %0" : : "r" (rb));\r\nrb += 1 << TLBIEL_INVAL_SET_SHIFT;\r\n}\r\n}\r\nstatic long kvmppc_realmode_mc_power7(struct kvm_vcpu *vcpu)\r\n{\r\nunsigned long srr1 = vcpu->arch.shregs.msr;\r\n#ifdef CONFIG_PPC_POWERNV\r\nstruct opal_machine_check_event *opal_evt;\r\n#endif\r\nlong handled = 1;\r\nif (srr1 & SRR1_MC_LDSTERR) {\r\nunsigned long dsisr = vcpu->arch.shregs.dsisr;\r\nif (dsisr & (DSISR_MC_SLB_PARMULTI | DSISR_MC_SLB_MULTI |\r\nDSISR_MC_SLB_PARITY | DSISR_MC_DERAT_MULTI)) {\r\nreload_slb(vcpu);\r\ndsisr &= ~(DSISR_MC_SLB_PARMULTI | DSISR_MC_SLB_MULTI |\r\nDSISR_MC_SLB_PARITY | DSISR_MC_DERAT_MULTI);\r\n}\r\nif (dsisr & DSISR_MC_TLB_MULTI) {\r\nflush_tlb_power7(vcpu);\r\ndsisr &= ~DSISR_MC_TLB_MULTI;\r\n}\r\nif (dsisr & 0xffffffffUL)\r\nhandled = 0;\r\n}\r\nswitch ((srr1 >> SRR1_MC_IFETCH_SH) & SRR1_MC_IFETCH_MASK) {\r\ncase 0:\r\nbreak;\r\ncase SRR1_MC_IFETCH_SLBPAR:\r\ncase SRR1_MC_IFETCH_SLBMULTI:\r\ncase SRR1_MC_IFETCH_SLBPARMULTI:\r\nreload_slb(vcpu);\r\nbreak;\r\ncase SRR1_MC_IFETCH_TLBMULTI:\r\nflush_tlb_power7(vcpu);\r\nbreak;\r\ndefault:\r\nhandled = 0;\r\n}\r\n#ifdef CONFIG_PPC_POWERNV\r\nopal_evt = local_paca->opal_mc_evt;\r\nif (opal_evt->version == OpalMCE_V1 &&\r\n(opal_evt->severity == OpalMCE_SEV_NO_ERROR ||\r\nopal_evt->disposition == OpalMCE_DISPOSITION_RECOVERED))\r\nhandled = 1;\r\nif (handled)\r\nopal_evt->in_use = 0;\r\n#endif\r\nreturn handled;\r\n}\r\nlong kvmppc_realmode_machine_check(struct kvm_vcpu *vcpu)\r\n{\r\nif (cpu_has_feature(CPU_FTR_ARCH_206))\r\nreturn kvmppc_realmode_mc_power7(vcpu);\r\nreturn 0;\r\n}

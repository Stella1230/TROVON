static ssize_t amd64_inject_section_show(struct device *dev,\r\nstruct device_attribute *mattr,\r\nchar *buf)\r\n{\r\nstruct mem_ctl_info *mci = to_mci(dev);\r\nstruct amd64_pvt *pvt = mci->pvt_info;\r\nreturn sprintf(buf, "0x%x\n", pvt->injection.section);\r\n}\r\nstatic ssize_t amd64_inject_section_store(struct device *dev,\r\nstruct device_attribute *mattr,\r\nconst char *data, size_t count)\r\n{\r\nstruct mem_ctl_info *mci = to_mci(dev);\r\nstruct amd64_pvt *pvt = mci->pvt_info;\r\nunsigned long value;\r\nint ret;\r\nret = strict_strtoul(data, 10, &value);\r\nif (ret < 0)\r\nreturn ret;\r\nif (value > 3) {\r\namd64_warn("%s: invalid section 0x%lx\n", __func__, value);\r\nreturn -EINVAL;\r\n}\r\npvt->injection.section = (u32) value;\r\nreturn count;\r\n}\r\nstatic ssize_t amd64_inject_word_show(struct device *dev,\r\nstruct device_attribute *mattr,\r\nchar *buf)\r\n{\r\nstruct mem_ctl_info *mci = to_mci(dev);\r\nstruct amd64_pvt *pvt = mci->pvt_info;\r\nreturn sprintf(buf, "0x%x\n", pvt->injection.word);\r\n}\r\nstatic ssize_t amd64_inject_word_store(struct device *dev,\r\nstruct device_attribute *mattr,\r\nconst char *data, size_t count)\r\n{\r\nstruct mem_ctl_info *mci = to_mci(dev);\r\nstruct amd64_pvt *pvt = mci->pvt_info;\r\nunsigned long value;\r\nint ret;\r\nret = strict_strtoul(data, 10, &value);\r\nif (ret < 0)\r\nreturn ret;\r\nif (value > 8) {\r\namd64_warn("%s: invalid word 0x%lx\n", __func__, value);\r\nreturn -EINVAL;\r\n}\r\npvt->injection.word = (u32) value;\r\nreturn count;\r\n}\r\nstatic ssize_t amd64_inject_ecc_vector_show(struct device *dev,\r\nstruct device_attribute *mattr,\r\nchar *buf)\r\n{\r\nstruct mem_ctl_info *mci = to_mci(dev);\r\nstruct amd64_pvt *pvt = mci->pvt_info;\r\nreturn sprintf(buf, "0x%x\n", pvt->injection.bit_map);\r\n}\r\nstatic ssize_t amd64_inject_ecc_vector_store(struct device *dev,\r\nstruct device_attribute *mattr,\r\nconst char *data, size_t count)\r\n{\r\nstruct mem_ctl_info *mci = to_mci(dev);\r\nstruct amd64_pvt *pvt = mci->pvt_info;\r\nunsigned long value;\r\nint ret;\r\nret = strict_strtoul(data, 16, &value);\r\nif (ret < 0)\r\nreturn ret;\r\nif (value & 0xFFFF0000) {\r\namd64_warn("%s: invalid EccVector: 0x%lx\n", __func__, value);\r\nreturn -EINVAL;\r\n}\r\npvt->injection.bit_map = (u32) value;\r\nreturn count;\r\n}\r\nstatic ssize_t amd64_inject_read_store(struct device *dev,\r\nstruct device_attribute *mattr,\r\nconst char *data, size_t count)\r\n{\r\nstruct mem_ctl_info *mci = to_mci(dev);\r\nstruct amd64_pvt *pvt = mci->pvt_info;\r\nunsigned long value;\r\nu32 section, word_bits;\r\nint ret;\r\nret = strict_strtoul(data, 10, &value);\r\nif (ret < 0)\r\nreturn ret;\r\nsection = F10_NB_ARRAY_DRAM | SET_NB_ARRAY_ADDR(pvt->injection.section);\r\namd64_write_pci_cfg(pvt->F3, F10_NB_ARRAY_ADDR, section);\r\nword_bits = SET_NB_DRAM_INJECTION_READ(pvt->injection);\r\namd64_write_pci_cfg(pvt->F3, F10_NB_ARRAY_DATA, word_bits);\r\nedac_dbg(0, "section=0x%x word_bits=0x%x\n", section, word_bits);\r\nreturn count;\r\n}\r\nstatic ssize_t amd64_inject_write_store(struct device *dev,\r\nstruct device_attribute *mattr,\r\nconst char *data, size_t count)\r\n{\r\nstruct mem_ctl_info *mci = to_mci(dev);\r\nstruct amd64_pvt *pvt = mci->pvt_info;\r\nu32 section, word_bits, tmp;\r\nunsigned long value;\r\nint ret;\r\nret = strict_strtoul(data, 10, &value);\r\nif (ret < 0)\r\nreturn ret;\r\nsection = F10_NB_ARRAY_DRAM | SET_NB_ARRAY_ADDR(pvt->injection.section);\r\namd64_write_pci_cfg(pvt->F3, F10_NB_ARRAY_ADDR, section);\r\nword_bits = SET_NB_DRAM_INJECTION_WRITE(pvt->injection);\r\npr_notice_once("Don't forget to decrease MCE polling interval in\n"\r\n"/sys/bus/machinecheck/devices/machinecheck<CPUNUM>/check_interval\n"\r\n"so that you can get the error report faster.\n");\r\non_each_cpu(disable_caches, NULL, 1);\r\namd64_write_pci_cfg(pvt->F3, F10_NB_ARRAY_DATA, word_bits);\r\nretry:\r\namd64_read_pci_cfg(pvt->F3, F10_NB_ARRAY_DATA, &tmp);\r\nif (tmp & F10_NB_ARR_ECC_WR_REQ) {\r\ncpu_relax();\r\ngoto retry;\r\n}\r\non_each_cpu(enable_caches, NULL, 1);\r\nedac_dbg(0, "section=0x%x word_bits=0x%x\n", section, word_bits);\r\nreturn count;\r\n}\r\nint amd64_create_sysfs_inject_files(struct mem_ctl_info *mci)\r\n{\r\nint rc;\r\nrc = device_create_file(&mci->dev, &dev_attr_inject_section);\r\nif (rc < 0)\r\nreturn rc;\r\nrc = device_create_file(&mci->dev, &dev_attr_inject_word);\r\nif (rc < 0)\r\nreturn rc;\r\nrc = device_create_file(&mci->dev, &dev_attr_inject_ecc_vector);\r\nif (rc < 0)\r\nreturn rc;\r\nrc = device_create_file(&mci->dev, &dev_attr_inject_write);\r\nif (rc < 0)\r\nreturn rc;\r\nrc = device_create_file(&mci->dev, &dev_attr_inject_read);\r\nif (rc < 0)\r\nreturn rc;\r\nreturn 0;\r\n}\r\nvoid amd64_remove_sysfs_inject_files(struct mem_ctl_info *mci)\r\n{\r\ndevice_remove_file(&mci->dev, &dev_attr_inject_section);\r\ndevice_remove_file(&mci->dev, &dev_attr_inject_word);\r\ndevice_remove_file(&mci->dev, &dev_attr_inject_ecc_vector);\r\ndevice_remove_file(&mci->dev, &dev_attr_inject_write);\r\ndevice_remove_file(&mci->dev, &dev_attr_inject_read);\r\n}

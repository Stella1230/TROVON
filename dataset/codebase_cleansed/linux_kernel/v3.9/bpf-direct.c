static void emulator(int nr, siginfo_t *info, void *void_context)\r\n{\r\nucontext_t *ctx = (ucontext_t *)(void_context);\r\nint syscall;\r\nchar *buf;\r\nssize_t bytes;\r\nsize_t len;\r\nif (info->si_code != SYS_SECCOMP)\r\nreturn;\r\nif (!ctx)\r\nreturn;\r\nsyscall = ctx->uc_mcontext.gregs[REG_SYSCALL];\r\nbuf = (char *) ctx->uc_mcontext.gregs[REG_ARG1];\r\nlen = (size_t) ctx->uc_mcontext.gregs[REG_ARG2];\r\nif (syscall != __NR_write)\r\nreturn;\r\nif (ctx->uc_mcontext.gregs[REG_ARG0] != STDERR_FILENO)\r\nreturn;\r\nctx->uc_mcontext.gregs[REG_RESULT] = -1;\r\nif (write(STDOUT_FILENO, "[ERR] ", 6) > 0) {\r\nbytes = write(STDOUT_FILENO, buf, len);\r\nctx->uc_mcontext.gregs[REG_RESULT] = bytes;\r\n}\r\nreturn;\r\n}\r\nstatic int install_emulator(void)\r\n{\r\nstruct sigaction act;\r\nsigset_t mask;\r\nmemset(&act, 0, sizeof(act));\r\nsigemptyset(&mask);\r\nsigaddset(&mask, SIGSYS);\r\nact.sa_sigaction = &emulator;\r\nact.sa_flags = SA_SIGINFO;\r\nif (sigaction(SIGSYS, &act, NULL) < 0) {\r\nperror("sigaction");\r\nreturn -1;\r\n}\r\nif (sigprocmask(SIG_UNBLOCK, &mask, NULL)) {\r\nperror("sigprocmask");\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int install_filter(void)\r\n{\r\nstruct sock_filter filter[] = {\r\nBPF_STMT(BPF_LD+BPF_W+BPF_ABS, syscall_nr),\r\nBPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, __NR_rt_sigreturn, 0, 1),\r\nBPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),\r\n#ifdef __NR_sigreturn\r\nBPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, __NR_sigreturn, 0, 1),\r\nBPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),\r\n#endif\r\nBPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, __NR_exit_group, 0, 1),\r\nBPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),\r\nBPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, __NR_exit, 0, 1),\r\nBPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),\r\nBPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, __NR_read, 1, 0),\r\nBPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, __NR_write, 3, 2),\r\nBPF_STMT(BPF_LD+BPF_W+BPF_ABS, syscall_arg(0)),\r\nBPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, STDIN_FILENO, 4, 0),\r\nBPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_KILL),\r\nBPF_STMT(BPF_LD+BPF_W+BPF_ABS, syscall_arg(0)),\r\nBPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, STDOUT_FILENO, 1, 0),\r\nBPF_JUMP(BPF_JMP+BPF_JEQ+BPF_K, STDERR_FILENO, 1, 2),\r\nBPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_ALLOW),\r\nBPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_TRAP),\r\nBPF_STMT(BPF_RET+BPF_K, SECCOMP_RET_KILL),\r\n};\r\nstruct sock_fprog prog = {\r\n.len = (unsigned short)(sizeof(filter)/sizeof(filter[0])),\r\n.filter = filter,\r\n};\r\nif (prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0)) {\r\nperror("prctl(NO_NEW_PRIVS)");\r\nreturn 1;\r\n}\r\nif (prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &prog)) {\r\nperror("prctl");\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nint main(int argc, char **argv)\r\n{\r\nchar buf[4096];\r\nssize_t bytes = 0;\r\nif (install_emulator())\r\nreturn 1;\r\nif (install_filter())\r\nreturn 1;\r\nsyscall(__NR_write, STDOUT_FILENO,\r\npayload("OHAI! WHAT IS YOUR NAME? "));\r\nbytes = syscall(__NR_read, STDIN_FILENO, buf, sizeof(buf));\r\nsyscall(__NR_write, STDOUT_FILENO, payload("HELLO, "));\r\nsyscall(__NR_write, STDOUT_FILENO, buf, bytes);\r\nsyscall(__NR_write, STDERR_FILENO,\r\npayload("Error message going to STDERR\n"));\r\nreturn 0;\r\n}\r\nint main(void)\r\n{\r\nreturn 1;\r\n}

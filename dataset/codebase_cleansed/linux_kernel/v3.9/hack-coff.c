int\r\nmain(int ac, char **av)\r\n{\r\nint fd;\r\nint i, nsect;\r\nint aoutsz;\r\nstruct external_filehdr fhdr;\r\nAOUTHDR aout;\r\nstruct external_scnhdr shdr;\r\nif (ac != 2) {\r\nfprintf(stderr, "Usage: hack-coff coff-file\n");\r\nexit(1);\r\n}\r\nif ((fd = open(av[1], 2)) == -1) {\r\nperror(av[2]);\r\nexit(1);\r\n}\r\nif (read(fd, &fhdr, sizeof(fhdr)) != sizeof(fhdr))\r\ngoto readerr;\r\ni = get_16be(fhdr.f_magic);\r\nif (i != U802TOCMAGIC && i != U802WRMAGIC && i != U802ROMAGIC) {\r\nfprintf(stderr, "%s: not an xcoff file\n", av[1]);\r\nexit(1);\r\n}\r\naoutsz = get_16be(fhdr.f_opthdr);\r\nif (read(fd, &aout, aoutsz) != aoutsz)\r\ngoto readerr;\r\nnsect = get_16be(fhdr.f_nscns);\r\nfor (i = 0; i < nsect; ++i) {\r\nif (read(fd, &shdr, sizeof(shdr)) != sizeof(shdr))\r\ngoto readerr;\r\nif (strcmp(shdr.s_name, ".text") == 0) {\r\nput_16be(aout.o_snentry, i+1);\r\nput_16be(aout.o_sntext, i+1);\r\n} else if (strcmp(shdr.s_name, ".data") == 0) {\r\nput_16be(aout.o_sndata, i+1);\r\n} else if (strcmp(shdr.s_name, ".bss") == 0) {\r\nput_16be(aout.o_snbss, i+1);\r\n}\r\n}\r\nput_16be(aout.magic, AOUT_MAGIC);\r\nif (lseek(fd, (long) sizeof(struct external_filehdr), 0) == -1\r\n|| write(fd, &aout, aoutsz) != aoutsz) {\r\nfprintf(stderr, "%s: write error\n", av[1]);\r\nexit(1);\r\n}\r\nclose(fd);\r\nexit(0);\r\nreaderr:\r\nfprintf(stderr, "%s: read error or file too short\n", av[1]);\r\nexit(1);\r\n}

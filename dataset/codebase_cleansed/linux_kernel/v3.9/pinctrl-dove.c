static int dove_pmu_mpp_ctrl_get(struct mvebu_mpp_ctrl *ctrl,\r\nunsigned long *config)\r\n{\r\nunsigned off = (ctrl->pid / MPPS_PER_REG) * MPP_BITS;\r\nunsigned shift = (ctrl->pid % MPPS_PER_REG) * MPP_BITS;\r\nunsigned long pmu = readl(DOVE_PMU_MPP_GENERAL_CTRL);\r\nunsigned long mpp = readl(DOVE_MPP_VIRT_BASE + off);\r\nif (pmu & (1 << ctrl->pid))\r\n*config = CONFIG_PMU;\r\nelse\r\n*config = (mpp >> shift) & MPP_MASK;\r\nreturn 0;\r\n}\r\nstatic int dove_pmu_mpp_ctrl_set(struct mvebu_mpp_ctrl *ctrl,\r\nunsigned long config)\r\n{\r\nunsigned off = (ctrl->pid / MPPS_PER_REG) * MPP_BITS;\r\nunsigned shift = (ctrl->pid % MPPS_PER_REG) * MPP_BITS;\r\nunsigned long pmu = readl(DOVE_PMU_MPP_GENERAL_CTRL);\r\nunsigned long mpp = readl(DOVE_MPP_VIRT_BASE + off);\r\nif (config == CONFIG_PMU)\r\nwritel(pmu | (1 << ctrl->pid), DOVE_PMU_MPP_GENERAL_CTRL);\r\nelse {\r\nwritel(pmu & ~(1 << ctrl->pid), DOVE_PMU_MPP_GENERAL_CTRL);\r\nmpp &= ~(MPP_MASK << shift);\r\nmpp |= config << shift;\r\nwritel(mpp, DOVE_MPP_VIRT_BASE + off);\r\n}\r\nreturn 0;\r\n}\r\nstatic int dove_mpp4_ctrl_get(struct mvebu_mpp_ctrl *ctrl,\r\nunsigned long *config)\r\n{\r\nunsigned long mpp4 = readl(DOVE_MPP_CTRL4_VIRT_BASE);\r\nunsigned long mask;\r\nswitch (ctrl->pid) {\r\ncase 24:\r\nmask = DOVE_CAM_GPIO_SEL;\r\nbreak;\r\ncase 40:\r\nmask = DOVE_SD0_GPIO_SEL;\r\nbreak;\r\ncase 46:\r\nmask = DOVE_SD1_GPIO_SEL;\r\nbreak;\r\ncase 58:\r\nmask = DOVE_SPI_GPIO_SEL;\r\nbreak;\r\ncase 62:\r\nmask = DOVE_UART1_GPIO_SEL;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n*config = ((mpp4 & mask) != 0);\r\nreturn 0;\r\n}\r\nstatic int dove_mpp4_ctrl_set(struct mvebu_mpp_ctrl *ctrl,\r\nunsigned long config)\r\n{\r\nunsigned long mpp4 = readl(DOVE_MPP_CTRL4_VIRT_BASE);\r\nunsigned long mask;\r\nswitch (ctrl->pid) {\r\ncase 24:\r\nmask = DOVE_CAM_GPIO_SEL;\r\nbreak;\r\ncase 40:\r\nmask = DOVE_SD0_GPIO_SEL;\r\nbreak;\r\ncase 46:\r\nmask = DOVE_SD1_GPIO_SEL;\r\nbreak;\r\ncase 58:\r\nmask = DOVE_SPI_GPIO_SEL;\r\nbreak;\r\ncase 62:\r\nmask = DOVE_UART1_GPIO_SEL;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nmpp4 &= ~mask;\r\nif (config)\r\nmpp4 |= mask;\r\nwritel(mpp4, DOVE_MPP_CTRL4_VIRT_BASE);\r\nreturn 0;\r\n}\r\nstatic int dove_nand_ctrl_get(struct mvebu_mpp_ctrl *ctrl,\r\nunsigned long *config)\r\n{\r\nunsigned long gmpp = readl(DOVE_MPP_GENERAL_VIRT_BASE);\r\n*config = ((gmpp & DOVE_NAND_GPIO_EN) != 0);\r\nreturn 0;\r\n}\r\nstatic int dove_nand_ctrl_set(struct mvebu_mpp_ctrl *ctrl,\r\nunsigned long config)\r\n{\r\nunsigned long gmpp = readl(DOVE_MPP_GENERAL_VIRT_BASE);\r\ngmpp &= ~DOVE_NAND_GPIO_EN;\r\nif (config)\r\ngmpp |= DOVE_NAND_GPIO_EN;\r\nwritel(gmpp, DOVE_MPP_GENERAL_VIRT_BASE);\r\nreturn 0;\r\n}\r\nstatic int dove_audio0_ctrl_get(struct mvebu_mpp_ctrl *ctrl,\r\nunsigned long *config)\r\n{\r\nunsigned long pmu = readl(DOVE_PMU_MPP_GENERAL_CTRL);\r\n*config = ((pmu & DOVE_AU0_AC97_SEL) != 0);\r\nreturn 0;\r\n}\r\nstatic int dove_audio0_ctrl_set(struct mvebu_mpp_ctrl *ctrl,\r\nunsigned long config)\r\n{\r\nunsigned long pmu = readl(DOVE_PMU_MPP_GENERAL_CTRL);\r\npmu &= ~DOVE_AU0_AC97_SEL;\r\nif (config)\r\npmu |= DOVE_AU0_AC97_SEL;\r\nwritel(pmu, DOVE_PMU_MPP_GENERAL_CTRL);\r\nreturn 0;\r\n}\r\nstatic int dove_audio1_ctrl_get(struct mvebu_mpp_ctrl *ctrl,\r\nunsigned long *config)\r\n{\r\nunsigned long mpp4 = readl(DOVE_MPP_CTRL4_VIRT_BASE);\r\nunsigned long sspc1 = readl(DOVE_SSP_CTRL_STATUS_1);\r\nunsigned long gmpp = readl(DOVE_MPP_GENERAL_VIRT_BASE);\r\nunsigned long gcfg2 = readl(DOVE_GLOBAL_CONFIG_2);\r\n*config = 0;\r\nif (mpp4 & DOVE_AU1_GPIO_SEL)\r\n*config |= BIT(3);\r\nif (sspc1 & DOVE_SSP_ON_AU1)\r\n*config |= BIT(2);\r\nif (gmpp & DOVE_AU1_SPDIFO_GPIO_EN)\r\n*config |= BIT(1);\r\nif (gcfg2 & DOVE_TWSI_OPTION3_GPIO)\r\n*config |= BIT(0);\r\nif ((*config & BIT(3)) == 0)\r\n*config &= ~(BIT(2) | BIT(0));\r\nif ((*config & BIT(1)) == 0)\r\n*config &= ~BIT(0);\r\nreturn 0;\r\n}\r\nstatic int dove_audio1_ctrl_set(struct mvebu_mpp_ctrl *ctrl,\r\nunsigned long config)\r\n{\r\nunsigned long mpp4 = readl(DOVE_MPP_CTRL4_VIRT_BASE);\r\nunsigned long sspc1 = readl(DOVE_SSP_CTRL_STATUS_1);\r\nunsigned long gmpp = readl(DOVE_MPP_GENERAL_VIRT_BASE);\r\nunsigned long gcfg2 = readl(DOVE_GLOBAL_CONFIG_2);\r\ngcfg2 &= ~DOVE_TWSI_OPTION3_GPIO;\r\ngmpp &= ~DOVE_AU1_SPDIFO_GPIO_EN;\r\nsspc1 &= ~DOVE_SSP_ON_AU1;\r\nmpp4 &= ~DOVE_AU1_GPIO_SEL;\r\nif (config & BIT(0))\r\ngcfg2 |= DOVE_TWSI_OPTION3_GPIO;\r\nif (config & BIT(1))\r\ngmpp |= DOVE_AU1_SPDIFO_GPIO_EN;\r\nif (config & BIT(2))\r\nsspc1 |= DOVE_SSP_ON_AU1;\r\nif (config & BIT(3))\r\nmpp4 |= DOVE_AU1_GPIO_SEL;\r\nwritel(mpp4, DOVE_MPP_CTRL4_VIRT_BASE);\r\nwritel(sspc1, DOVE_SSP_CTRL_STATUS_1);\r\nwritel(gmpp, DOVE_MPP_GENERAL_VIRT_BASE);\r\nwritel(gcfg2, DOVE_GLOBAL_CONFIG_2);\r\nreturn 0;\r\n}\r\nstatic int dove_audio1_ctrl_gpio_req(struct mvebu_mpp_ctrl *ctrl, u8 pid)\r\n{\r\nunsigned long config;\r\ndove_audio1_ctrl_get(ctrl, &config);\r\nswitch (config) {\r\ncase 0x02:\r\ncase 0x0e:\r\nif (pid >= 56)\r\nreturn 0;\r\nreturn -ENOTSUPP;\r\ncase 0x08:\r\ncase 0x0b:\r\nif (pid <= 55)\r\nreturn 0;\r\nreturn -ENOTSUPP;\r\ncase 0x0a:\r\nreturn 0;\r\n}\r\nreturn -ENOTSUPP;\r\n}\r\nstatic int dove_audio1_ctrl_gpio_dir(struct mvebu_mpp_ctrl *ctrl, u8 pid,\r\nbool input)\r\n{\r\nif (pid < 52 || pid > 57)\r\nreturn -ENOTSUPP;\r\nreturn 0;\r\n}\r\nstatic int dove_twsi_ctrl_get(struct mvebu_mpp_ctrl *ctrl,\r\nunsigned long *config)\r\n{\r\nunsigned long gcfg1 = readl(DOVE_GLOBAL_CONFIG_1);\r\nunsigned long gcfg2 = readl(DOVE_GLOBAL_CONFIG_2);\r\n*config = 0;\r\nif (gcfg1 & DOVE_TWSI_ENABLE_OPTION1)\r\n*config = 1;\r\nelse if (gcfg2 & DOVE_TWSI_ENABLE_OPTION2)\r\n*config = 2;\r\nelse if (gcfg2 & DOVE_TWSI_ENABLE_OPTION3)\r\n*config = 3;\r\nreturn 0;\r\n}\r\nstatic int dove_twsi_ctrl_set(struct mvebu_mpp_ctrl *ctrl,\r\nunsigned long config)\r\n{\r\nunsigned long gcfg1 = readl(DOVE_GLOBAL_CONFIG_1);\r\nunsigned long gcfg2 = readl(DOVE_GLOBAL_CONFIG_2);\r\ngcfg1 &= ~DOVE_TWSI_ENABLE_OPTION1;\r\ngcfg2 &= ~(DOVE_TWSI_ENABLE_OPTION2 | DOVE_TWSI_ENABLE_OPTION2);\r\nswitch (config) {\r\ncase 1:\r\ngcfg1 |= DOVE_TWSI_ENABLE_OPTION1;\r\nbreak;\r\ncase 2:\r\ngcfg2 |= DOVE_TWSI_ENABLE_OPTION2;\r\nbreak;\r\ncase 3:\r\ngcfg2 |= DOVE_TWSI_ENABLE_OPTION3;\r\nbreak;\r\n}\r\nwritel(gcfg1, DOVE_GLOBAL_CONFIG_1);\r\nwritel(gcfg2, DOVE_GLOBAL_CONFIG_2);\r\nreturn 0;\r\n}\r\nstatic int dove_pinctrl_probe(struct platform_device *pdev)\r\n{\r\nconst struct of_device_id *match =\r\nof_match_device(dove_pinctrl_of_match, &pdev->dev);\r\npdev->dev.platform_data = (void *)match->data;\r\nclk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(clk)) {\r\ndev_err(&pdev->dev, "Unable to get pdma clock");\r\nreturn PTR_RET(clk);\r\n}\r\nclk_prepare_enable(clk);\r\nreturn mvebu_pinctrl_probe(pdev);\r\n}\r\nstatic int dove_pinctrl_remove(struct platform_device *pdev)\r\n{\r\nint ret;\r\nret = mvebu_pinctrl_remove(pdev);\r\nif (!IS_ERR(clk))\r\nclk_disable_unprepare(clk);\r\nreturn ret;\r\n}

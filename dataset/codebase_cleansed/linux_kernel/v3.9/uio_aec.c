static irqreturn_t aectc_irq(int irq, struct uio_info *dev_info)\r\n{\r\nvoid __iomem *int_flag = dev_info->priv + INTA_DRVR_ADDR;\r\nunsigned char status = ioread8(int_flag);\r\nif ((status & INTA_ENABLED_FLAG) && (status & INTA_FLAG)) {\r\nstatus = ioread8(dev_info->priv + MAILBOX);\r\nreturn IRQ_HANDLED;\r\n}\r\nreturn IRQ_NONE;\r\n}\r\nstatic void print_board_data(struct pci_dev *pdev, struct uio_info *i)\r\n{\r\ndev_info(&pdev->dev, "PCI-TC board vendor: %x%x number: %x%x"\r\n" revision: %c%c\n",\r\nioread8(i->priv + 0x01),\r\nioread8(i->priv + 0x00),\r\nioread8(i->priv + 0x03),\r\nioread8(i->priv + 0x02),\r\nioread8(i->priv + 0x06),\r\nioread8(i->priv + 0x07));\r\n}\r\nstatic int probe(struct pci_dev *pdev, const struct pci_device_id *id)\r\n{\r\nstruct uio_info *info;\r\nint ret;\r\ninfo = kzalloc(sizeof(struct uio_info), GFP_KERNEL);\r\nif (!info)\r\nreturn -ENOMEM;\r\nif (pci_enable_device(pdev))\r\ngoto out_free;\r\nif (pci_request_regions(pdev, "aectc"))\r\ngoto out_disable;\r\ninfo->name = "aectc";\r\ninfo->port[0].start = pci_resource_start(pdev, 0);\r\nif (!info->port[0].start)\r\ngoto out_release;\r\ninfo->priv = pci_iomap(pdev, 0, 0);\r\nif (!info->priv)\r\ngoto out_release;\r\ninfo->port[0].size = pci_resource_len(pdev, 0);\r\ninfo->port[0].porttype = UIO_PORT_GPIO;\r\ninfo->version = "0.0.1";\r\ninfo->irq = pdev->irq;\r\ninfo->irq_flags = IRQF_SHARED;\r\ninfo->handler = aectc_irq;\r\nprint_board_data(pdev, info);\r\nret = uio_register_device(&pdev->dev, info);\r\nif (ret)\r\ngoto out_unmap;\r\niowrite32(INT_ENABLE, info->priv + INT_ENABLE_ADDR);\r\niowrite8(INT_MASK_ALL, info->priv + INT_MASK_ADDR);\r\nif (!(ioread8(info->priv + INTA_DRVR_ADDR)\r\n& INTA_ENABLED_FLAG))\r\ndev_err(&pdev->dev, "aectc: interrupts not enabled\n");\r\npci_set_drvdata(pdev, info);\r\nreturn 0;\r\nout_unmap:\r\npci_iounmap(pdev, info->priv);\r\nout_release:\r\npci_release_regions(pdev);\r\nout_disable:\r\npci_disable_device(pdev);\r\nout_free:\r\nkfree(info);\r\nreturn -ENODEV;\r\n}\r\nstatic void remove(struct pci_dev *pdev)\r\n{\r\nstruct uio_info *info = pci_get_drvdata(pdev);\r\niowrite8(INT_DISABLE, info->priv + INT_MASK_ADDR);\r\niowrite32(INT_DISABLE, info->priv + INT_ENABLE_ADDR);\r\nioread8(info->priv + MAILBOX);\r\nuio_unregister_device(info);\r\npci_release_regions(pdev);\r\npci_disable_device(pdev);\r\npci_set_drvdata(pdev, NULL);\r\niounmap(info->priv);\r\nkfree(info);\r\n}\r\nstatic int __init aectc_init(void)\r\n{\r\nreturn pci_register_driver(&pci_driver);\r\n}\r\nstatic void __exit aectc_exit(void)\r\n{\r\npci_unregister_driver(&pci_driver);\r\n}

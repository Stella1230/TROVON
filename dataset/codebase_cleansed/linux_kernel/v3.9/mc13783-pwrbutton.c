static irqreturn_t button_irq(int irq, void *_priv)\r\n{\r\nstruct mc13783_pwrb *priv = _priv;\r\nint val;\r\nmc13xxx_irq_ack(priv->mc13783, irq);\r\nmc13xxx_reg_read(priv->mc13783, MC13783_REG_INTERRUPT_SENSE_1, &val);\r\nswitch (irq) {\r\ncase MC13783_IRQ_ONOFD1:\r\nval = val & MC13783_IRQSENSE1_ONOFD1S ? 1 : 0;\r\nif (priv->flags & MC13783_PWRB_B1_POL_INVERT)\r\nval ^= 1;\r\ninput_report_key(priv->pwr, priv->keymap[0], val);\r\nbreak;\r\ncase MC13783_IRQ_ONOFD2:\r\nval = val & MC13783_IRQSENSE1_ONOFD2S ? 1 : 0;\r\nif (priv->flags & MC13783_PWRB_B2_POL_INVERT)\r\nval ^= 1;\r\ninput_report_key(priv->pwr, priv->keymap[1], val);\r\nbreak;\r\ncase MC13783_IRQ_ONOFD3:\r\nval = val & MC13783_IRQSENSE1_ONOFD3S ? 1 : 0;\r\nif (priv->flags & MC13783_PWRB_B3_POL_INVERT)\r\nval ^= 1;\r\ninput_report_key(priv->pwr, priv->keymap[2], val);\r\nbreak;\r\n}\r\ninput_sync(priv->pwr);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int mc13783_pwrbutton_probe(struct platform_device *pdev)\r\n{\r\nconst struct mc13xxx_buttons_platform_data *pdata;\r\nstruct mc13xxx *mc13783 = dev_get_drvdata(pdev->dev.parent);\r\nstruct input_dev *pwr;\r\nstruct mc13783_pwrb *priv;\r\nint err = 0;\r\nint reg = 0;\r\npdata = dev_get_platdata(&pdev->dev);\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "missing platform data\n");\r\nreturn -ENODEV;\r\n}\r\npwr = input_allocate_device();\r\nif (!pwr) {\r\ndev_dbg(&pdev->dev, "Can't allocate power button\n");\r\nreturn -ENOMEM;\r\n}\r\npriv = kzalloc(sizeof(*priv), GFP_KERNEL);\r\nif (!priv) {\r\nerr = -ENOMEM;\r\ndev_dbg(&pdev->dev, "Can't allocate power button\n");\r\ngoto free_input_dev;\r\n}\r\nreg |= (pdata->b1on_flags & 0x3) << MC13783_POWER_CONTROL_2_ON1BDBNC;\r\nreg |= (pdata->b2on_flags & 0x3) << MC13783_POWER_CONTROL_2_ON2BDBNC;\r\nreg |= (pdata->b3on_flags & 0x3) << MC13783_POWER_CONTROL_2_ON3BDBNC;\r\npriv->pwr = pwr;\r\npriv->mc13783 = mc13783;\r\nmc13xxx_lock(mc13783);\r\nif (pdata->b1on_flags & MC13783_BUTTON_ENABLE) {\r\npriv->keymap[0] = pdata->b1on_key;\r\nif (pdata->b1on_key != KEY_RESERVED)\r\n__set_bit(pdata->b1on_key, pwr->keybit);\r\nif (pdata->b1on_flags & MC13783_BUTTON_POL_INVERT)\r\npriv->flags |= MC13783_PWRB_B1_POL_INVERT;\r\nif (pdata->b1on_flags & MC13783_BUTTON_RESET_EN)\r\nreg |= MC13783_POWER_CONTROL_2_ON1BRSTEN;\r\nerr = mc13xxx_irq_request(mc13783, MC13783_IRQ_ONOFD1,\r\nbutton_irq, "b1on", priv);\r\nif (err) {\r\ndev_dbg(&pdev->dev, "Can't request irq\n");\r\ngoto free_priv;\r\n}\r\n}\r\nif (pdata->b2on_flags & MC13783_BUTTON_ENABLE) {\r\npriv->keymap[1] = pdata->b2on_key;\r\nif (pdata->b2on_key != KEY_RESERVED)\r\n__set_bit(pdata->b2on_key, pwr->keybit);\r\nif (pdata->b2on_flags & MC13783_BUTTON_POL_INVERT)\r\npriv->flags |= MC13783_PWRB_B2_POL_INVERT;\r\nif (pdata->b2on_flags & MC13783_BUTTON_RESET_EN)\r\nreg |= MC13783_POWER_CONTROL_2_ON2BRSTEN;\r\nerr = mc13xxx_irq_request(mc13783, MC13783_IRQ_ONOFD2,\r\nbutton_irq, "b2on", priv);\r\nif (err) {\r\ndev_dbg(&pdev->dev, "Can't request irq\n");\r\ngoto free_irq_b1;\r\n}\r\n}\r\nif (pdata->b3on_flags & MC13783_BUTTON_ENABLE) {\r\npriv->keymap[2] = pdata->b3on_key;\r\nif (pdata->b3on_key != KEY_RESERVED)\r\n__set_bit(pdata->b3on_key, pwr->keybit);\r\nif (pdata->b3on_flags & MC13783_BUTTON_POL_INVERT)\r\npriv->flags |= MC13783_PWRB_B3_POL_INVERT;\r\nif (pdata->b3on_flags & MC13783_BUTTON_RESET_EN)\r\nreg |= MC13783_POWER_CONTROL_2_ON3BRSTEN;\r\nerr = mc13xxx_irq_request(mc13783, MC13783_IRQ_ONOFD3,\r\nbutton_irq, "b3on", priv);\r\nif (err) {\r\ndev_dbg(&pdev->dev, "Can't request irq: %d\n", err);\r\ngoto free_irq_b2;\r\n}\r\n}\r\nmc13xxx_reg_rmw(mc13783, MC13783_REG_POWER_CONTROL_2, 0x3FE, reg);\r\nmc13xxx_unlock(mc13783);\r\npwr->name = "mc13783_pwrbutton";\r\npwr->phys = "mc13783_pwrbutton/input0";\r\npwr->dev.parent = &pdev->dev;\r\npwr->keycode = priv->keymap;\r\npwr->keycodemax = ARRAY_SIZE(priv->keymap);\r\npwr->keycodesize = sizeof(priv->keymap[0]);\r\n__set_bit(EV_KEY, pwr->evbit);\r\nerr = input_register_device(pwr);\r\nif (err) {\r\ndev_dbg(&pdev->dev, "Can't register power button: %d\n", err);\r\ngoto free_irq;\r\n}\r\nplatform_set_drvdata(pdev, priv);\r\nreturn 0;\r\nfree_irq:\r\nmc13xxx_lock(mc13783);\r\nif (pdata->b3on_flags & MC13783_BUTTON_ENABLE)\r\nmc13xxx_irq_free(mc13783, MC13783_IRQ_ONOFD3, priv);\r\nfree_irq_b2:\r\nif (pdata->b2on_flags & MC13783_BUTTON_ENABLE)\r\nmc13xxx_irq_free(mc13783, MC13783_IRQ_ONOFD2, priv);\r\nfree_irq_b1:\r\nif (pdata->b1on_flags & MC13783_BUTTON_ENABLE)\r\nmc13xxx_irq_free(mc13783, MC13783_IRQ_ONOFD1, priv);\r\nfree_priv:\r\nmc13xxx_unlock(mc13783);\r\nkfree(priv);\r\nfree_input_dev:\r\ninput_free_device(pwr);\r\nreturn err;\r\n}\r\nstatic int mc13783_pwrbutton_remove(struct platform_device *pdev)\r\n{\r\nstruct mc13783_pwrb *priv = platform_get_drvdata(pdev);\r\nconst struct mc13xxx_buttons_platform_data *pdata;\r\npdata = dev_get_platdata(&pdev->dev);\r\nmc13xxx_lock(priv->mc13783);\r\nif (pdata->b3on_flags & MC13783_BUTTON_ENABLE)\r\nmc13xxx_irq_free(priv->mc13783, MC13783_IRQ_ONOFD3, priv);\r\nif (pdata->b2on_flags & MC13783_BUTTON_ENABLE)\r\nmc13xxx_irq_free(priv->mc13783, MC13783_IRQ_ONOFD2, priv);\r\nif (pdata->b1on_flags & MC13783_BUTTON_ENABLE)\r\nmc13xxx_irq_free(priv->mc13783, MC13783_IRQ_ONOFD1, priv);\r\nmc13xxx_unlock(priv->mc13783);\r\ninput_unregister_device(priv->pwr);\r\nkfree(priv);\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn 0;\r\n}

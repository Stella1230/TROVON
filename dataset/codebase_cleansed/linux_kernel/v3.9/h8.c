static void wsp_h8_putc(int c)\r\n{\r\nu8 lsr;\r\ndo {\r\nlsr = readb(h8 + LSR);\r\n} while ((lsr & LSR_THRE) != LSR_THRE);\r\nwriteb(c, h8 + THR);\r\n}\r\nstatic int wsp_h8_getc(void)\r\n{\r\nu8 lsr;\r\ndo {\r\nlsr = readb(h8 + LSR);\r\n} while ((lsr & LSR_DR) != LSR_DR);\r\nreturn readb(h8 + RBR);\r\n}\r\nstatic void wsp_h8_puts(const char *s, int sz)\r\n{\r\nint i;\r\nfor (i = 0; i < sz; i++) {\r\nwsp_h8_putc(s[i]);\r\nwsp_h8_getc();\r\n}\r\nwsp_h8_putc('\r');\r\nwsp_h8_putc('\n');\r\n}\r\nstatic void wsp_h8_terminal_cmd(const char *cmd, int sz)\r\n{\r\nhard_irq_disable();\r\nwsp_h8_puts(cmd, sz);\r\nfor (;;)\r\ncontinue;\r\n}\r\nvoid wsp_h8_restart(char *cmd)\r\n{\r\nstatic const char restart[] = "warm-reset";\r\n(void)cmd;\r\nwsp_h8_terminal_cmd(restart, sizeof(restart) - 1);\r\n}\r\nvoid wsp_h8_power_off(void)\r\n{\r\nstatic const char off[] = "power-off";\r\nwsp_h8_terminal_cmd(off, sizeof(off) - 1);\r\n}\r\nstatic void __iomem *wsp_h8_getaddr(void)\r\n{\r\nstruct device_node *aliases;\r\nstruct device_node *uart;\r\nstruct property *path;\r\nvoid __iomem *va = NULL;\r\naliases = of_find_node_by_path("/aliases");\r\nif (aliases == NULL)\r\nreturn NULL;\r\npath = of_find_property(aliases, "serial1", NULL);\r\nif (path == NULL)\r\ngoto out;\r\nuart = of_find_node_by_path(path->value);\r\nif (uart == NULL)\r\ngoto out;\r\nva = of_iomap(uart, 0);\r\nof_detach_node(uart);\r\nof_node_put(uart);\r\nout:\r\nof_node_put(aliases);\r\nreturn va;\r\n}\r\nvoid __init wsp_setup_h8(void)\r\n{\r\nh8 = wsp_h8_getaddr();\r\nif (h8 == NULL) {\r\npr_warn("UART to H8 could not be found");\r\nh8 = ioremap(0xffc0008000ULL, 0x100);\r\n}\r\n}

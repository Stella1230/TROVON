static u8 bq4802_read_io(struct bq4802 *p, int off)\r\n{\r\nreturn inb(p->ioport + off);\r\n}\r\nstatic void bq4802_write_io(struct bq4802 *p, int off, u8 val)\r\n{\r\noutb(val, p->ioport + off);\r\n}\r\nstatic u8 bq4802_read_mem(struct bq4802 *p, int off)\r\n{\r\nreturn readb(p->regs + off);\r\n}\r\nstatic void bq4802_write_mem(struct bq4802 *p, int off, u8 val)\r\n{\r\nwriteb(val, p->regs + off);\r\n}\r\nstatic int bq4802_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct bq4802 *p = platform_get_drvdata(pdev);\r\nunsigned long flags;\r\nunsigned int century;\r\nu8 val;\r\nspin_lock_irqsave(&p->lock, flags);\r\nval = p->read(p, 0x0e);\r\np->write(p, 0xe, val | 0x08);\r\ntm->tm_sec = p->read(p, 0x00);\r\ntm->tm_min = p->read(p, 0x02);\r\ntm->tm_hour = p->read(p, 0x04);\r\ntm->tm_mday = p->read(p, 0x06);\r\ntm->tm_mon = p->read(p, 0x09);\r\ntm->tm_year = p->read(p, 0x0a);\r\ntm->tm_wday = p->read(p, 0x08);\r\ncentury = p->read(p, 0x0f);\r\np->write(p, 0x0e, val);\r\nspin_unlock_irqrestore(&p->lock, flags);\r\ntm->tm_sec = bcd2bin(tm->tm_sec);\r\ntm->tm_min = bcd2bin(tm->tm_min);\r\ntm->tm_hour = bcd2bin(tm->tm_hour);\r\ntm->tm_mday = bcd2bin(tm->tm_mday);\r\ntm->tm_mon = bcd2bin(tm->tm_mon);\r\ntm->tm_year = bcd2bin(tm->tm_year);\r\ntm->tm_wday = bcd2bin(tm->tm_wday);\r\ncentury = bcd2bin(century);\r\ntm->tm_year += (century * 100);\r\ntm->tm_year -= 1900;\r\ntm->tm_mon--;\r\nreturn 0;\r\n}\r\nstatic int bq4802_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct bq4802 *p = platform_get_drvdata(pdev);\r\nu8 sec, min, hrs, day, mon, yrs, century, val;\r\nunsigned long flags;\r\nunsigned int year;\r\nyear = tm->tm_year + 1900;\r\ncentury = year / 100;\r\nyrs = year % 100;\r\nmon = tm->tm_mon + 1;\r\nday = tm->tm_mday;\r\nhrs = tm->tm_hour;\r\nmin = tm->tm_min;\r\nsec = tm->tm_sec;\r\nsec = bin2bcd(sec);\r\nmin = bin2bcd(min);\r\nhrs = bin2bcd(hrs);\r\nday = bin2bcd(day);\r\nmon = bin2bcd(mon);\r\nyrs = bin2bcd(yrs);\r\ncentury = bin2bcd(century);\r\nspin_lock_irqsave(&p->lock, flags);\r\nval = p->read(p, 0x0e);\r\np->write(p, 0x0e, val | 0x08);\r\np->write(p, 0x00, sec);\r\np->write(p, 0x02, min);\r\np->write(p, 0x04, hrs);\r\np->write(p, 0x06, day);\r\np->write(p, 0x09, mon);\r\np->write(p, 0x0a, yrs);\r\np->write(p, 0x0f, century);\r\np->write(p, 0x0e, val);\r\nspin_unlock_irqrestore(&p->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int bq4802_probe(struct platform_device *pdev)\r\n{\r\nstruct bq4802 *p = kzalloc(sizeof(*p), GFP_KERNEL);\r\nint err = -ENOMEM;\r\nif (!p)\r\ngoto out;\r\nspin_lock_init(&p->lock);\r\np->r = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!p->r) {\r\np->r = platform_get_resource(pdev, IORESOURCE_IO, 0);\r\nerr = -EINVAL;\r\nif (!p->r)\r\ngoto out_free;\r\n}\r\nif (p->r->flags & IORESOURCE_IO) {\r\np->ioport = p->r->start;\r\np->read = bq4802_read_io;\r\np->write = bq4802_write_io;\r\n} else if (p->r->flags & IORESOURCE_MEM) {\r\np->regs = ioremap(p->r->start, resource_size(p->r));\r\np->read = bq4802_read_mem;\r\np->write = bq4802_write_mem;\r\n} else {\r\nerr = -EINVAL;\r\ngoto out_free;\r\n}\r\nplatform_set_drvdata(pdev, p);\r\np->rtc = rtc_device_register("bq4802", &pdev->dev,\r\n&bq4802_ops, THIS_MODULE);\r\nif (IS_ERR(p->rtc)) {\r\nerr = PTR_ERR(p->rtc);\r\ngoto out_iounmap;\r\n}\r\nerr = 0;\r\nout:\r\nreturn err;\r\nout_iounmap:\r\nif (p->r->flags & IORESOURCE_MEM)\r\niounmap(p->regs);\r\nout_free:\r\nkfree(p);\r\ngoto out;\r\n}\r\nstatic int bq4802_remove(struct platform_device *pdev)\r\n{\r\nstruct bq4802 *p = platform_get_drvdata(pdev);\r\nrtc_device_unregister(p->rtc);\r\nif (p->r->flags & IORESOURCE_MEM)\r\niounmap(p->regs);\r\nplatform_set_drvdata(pdev, NULL);\r\nkfree(p);\r\nreturn 0;\r\n}

static int bfin_i2s_set_dai_fmt(struct snd_soc_dai *cpu_dai,\r\nunsigned int fmt)\r\n{\r\nstruct sport_device *sport = snd_soc_dai_get_drvdata(cpu_dai);\r\nstruct device *dev = &sport->pdev->dev;\r\nint ret = 0;\r\nparam.spctl &= ~(SPORT_CTL_OPMODE | SPORT_CTL_CKRE | SPORT_CTL_FSR\r\n| SPORT_CTL_LFS | SPORT_CTL_LAFS);\r\nswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\r\ncase SND_SOC_DAIFMT_I2S:\r\nparam.spctl |= SPORT_CTL_OPMODE | SPORT_CTL_CKRE\r\n| SPORT_CTL_LFS;\r\nbreak;\r\ncase SND_SOC_DAIFMT_DSP_A:\r\nparam.spctl |= SPORT_CTL_FSR;\r\nbreak;\r\ncase SND_SOC_DAIFMT_LEFT_J:\r\nparam.spctl |= SPORT_CTL_OPMODE | SPORT_CTL_LFS\r\n| SPORT_CTL_LAFS;\r\nbreak;\r\ndefault:\r\ndev_err(dev, "%s: Unknown DAI format type\n", __func__);\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nparam.spctl &= ~(SPORT_CTL_ICLK | SPORT_CTL_IFS);\r\nswitch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {\r\ncase SND_SOC_DAIFMT_CBM_CFM:\r\nbreak;\r\ncase SND_SOC_DAIFMT_CBS_CFS:\r\ncase SND_SOC_DAIFMT_CBM_CFS:\r\ncase SND_SOC_DAIFMT_CBS_CFM:\r\nret = -EINVAL;\r\nbreak;\r\ndefault:\r\ndev_err(dev, "%s: Unknown DAI master type\n", __func__);\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int bfin_i2s_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct sport_device *sport = snd_soc_dai_get_drvdata(dai);\r\nstruct device *dev = &sport->pdev->dev;\r\nint ret = 0;\r\nparam.spctl &= ~SPORT_CTL_SLEN;\r\nswitch (params_format(params)) {\r\ncase SNDRV_PCM_FORMAT_S8:\r\nparam.spctl |= 0x70;\r\nsport->wdsize = 1;\r\ncase SNDRV_PCM_FORMAT_S16_LE:\r\nparam.spctl |= 0xf0;\r\nsport->wdsize = 2;\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S24_LE:\r\nparam.spctl |= 0x170;\r\nsport->wdsize = 3;\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S32_LE:\r\nparam.spctl |= 0x1f0;\r\nsport->wdsize = 4;\r\nbreak;\r\n}\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK) {\r\nret = sport_set_tx_params(sport, &param);\r\nif (ret) {\r\ndev_err(dev, "SPORT tx is busy!\n");\r\nreturn ret;\r\n}\r\n} else {\r\nret = sport_set_rx_params(sport, &param);\r\nif (ret) {\r\ndev_err(dev, "SPORT rx is busy!\n");\r\nreturn ret;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int bfin_i2s_suspend(struct snd_soc_dai *dai)\r\n{\r\nstruct sport_device *sport = snd_soc_dai_get_drvdata(dai);\r\nif (dai->capture_active)\r\nsport_rx_stop(sport);\r\nif (dai->playback_active)\r\nsport_tx_stop(sport);\r\nreturn 0;\r\n}\r\nstatic int bfin_i2s_resume(struct snd_soc_dai *dai)\r\n{\r\nstruct sport_device *sport = snd_soc_dai_get_drvdata(dai);\r\nstruct device *dev = &sport->pdev->dev;\r\nint ret;\r\nret = sport_set_tx_params(sport, &param);\r\nif (ret) {\r\ndev_err(dev, "SPORT tx is busy!\n");\r\nreturn ret;\r\n}\r\nret = sport_set_rx_params(sport, &param);\r\nif (ret) {\r\ndev_err(dev, "SPORT rx is busy!\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int bfin_i2s_probe(struct platform_device *pdev)\r\n{\r\nstruct sport_device *sport;\r\nstruct device *dev = &pdev->dev;\r\nint ret;\r\nsport = sport_create(pdev);\r\nif (!sport)\r\nreturn -ENODEV;\r\nret = snd_soc_register_dai(dev, &bfin_i2s_dai);\r\nif (ret) {\r\ndev_err(dev, "Failed to register DAI: %d\n", ret);\r\nsport_delete(sport);\r\nreturn ret;\r\n}\r\nplatform_set_drvdata(pdev, sport);\r\nreturn 0;\r\n}\r\nstatic int bfin_i2s_remove(struct platform_device *pdev)\r\n{\r\nstruct sport_device *sport = platform_get_drvdata(pdev);\r\nsnd_soc_unregister_dai(&pdev->dev);\r\nsport_delete(sport);\r\nreturn 0;\r\n}

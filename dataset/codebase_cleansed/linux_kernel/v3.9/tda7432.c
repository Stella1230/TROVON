static inline struct tda7432 *to_state(struct v4l2_subdev *sd)\r\n{\r\nreturn container_of(sd, struct tda7432, sd);\r\n}\r\nstatic int tda7432_write(struct v4l2_subdev *sd, int subaddr, int val)\r\n{\r\nstruct i2c_client *client = v4l2_get_subdevdata(sd);\r\nunsigned char buffer[2];\r\nv4l2_dbg(2, debug, sd, "In tda7432_write\n");\r\nv4l2_dbg(1, debug, sd, "Writing %d 0x%x\n", subaddr, val);\r\nbuffer[0] = subaddr;\r\nbuffer[1] = val;\r\nif (2 != i2c_master_send(client, buffer, 2)) {\r\nv4l2_err(sd, "I/O error, trying (write %d 0x%x)\n",\r\nsubaddr, val);\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tda7432_set(struct v4l2_subdev *sd)\r\n{\r\nstruct i2c_client *client = v4l2_get_subdevdata(sd);\r\nstruct tda7432 *t = to_state(sd);\r\nunsigned char buf[16];\r\nv4l2_dbg(1, debug, sd,\r\n"tda7432: 7432_set(0x%02x,0x%02x,0x%02x,0x%02x,0x%02x,0x%02x,0x%02x,0x%02x,0x%02x)\n",\r\nt->input, t->volume, t->bass, t->treble, t->lf, t->lr,\r\nt->rf, t->rr, t->loud);\r\nbuf[0] = TDA7432_IN;\r\nbuf[1] = t->input;\r\nbuf[2] = t->volume;\r\nbuf[3] = t->bass;\r\nbuf[4] = t->treble;\r\nbuf[5] = t->lf;\r\nbuf[6] = t->lr;\r\nbuf[7] = t->rf;\r\nbuf[8] = t->rr;\r\nbuf[9] = t->loud;\r\nif (10 != i2c_master_send(client, buf, 10)) {\r\nv4l2_err(sd, "I/O error, trying tda7432_set\n");\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic void do_tda7432_init(struct v4l2_subdev *sd)\r\n{\r\nstruct tda7432 *t = to_state(sd);\r\nv4l2_dbg(2, debug, sd, "In tda7432_init\n");\r\nt->input = TDA7432_STEREO_IN |\r\nTDA7432_BASS_SYM |\r\nTDA7432_BASS_NORM;\r\nt->volume = 0x3b ;\r\nif (loudness)\r\nt->volume |= TDA7432_LD_ON;\r\nt->muted = 1;\r\nt->treble = TDA7432_TREBLE_0DB;\r\nt->bass = TDA7432_BASS_0DB;\r\nt->lf = TDA7432_ATTEN_0DB;\r\nt->lr = TDA7432_ATTEN_0DB;\r\nt->rf = TDA7432_ATTEN_0DB;\r\nt->rr = TDA7432_ATTEN_0DB;\r\nt->loud = loudness;\r\ntda7432_set(sd);\r\n}\r\nstatic int tda7432_g_ctrl(struct v4l2_subdev *sd, struct v4l2_control *ctrl)\r\n{\r\nstruct tda7432 *t = to_state(sd);\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_AUDIO_MUTE:\r\nctrl->value=t->muted;\r\nreturn 0;\r\ncase V4L2_CID_AUDIO_VOLUME:\r\nif (!maxvol){\r\nctrl->value = ( 0x6f - (t->volume & 0x7F) ) * 630;\r\n} else {\r\nctrl->value = ( 0x6f - (t->volume & 0x7F) ) * 829;\r\n}\r\nreturn 0;\r\ncase V4L2_CID_AUDIO_BALANCE:\r\n{\r\nif ( (t->lf) < (t->rf) )\r\nctrl->value = (32768 - 1057*(t->rf));\r\nelse\r\nctrl->value = (32768 + 1057*(t->lf));\r\nreturn 0;\r\n}\r\ncase V4L2_CID_AUDIO_BASS:\r\n{\r\nint bass=t->bass;\r\nif(bass >= 0x8)\r\nbass = ~(bass - 0x8) & 0xf;\r\nctrl->value = (bass << 12)+(bass << 8)+(bass << 4)+(bass);\r\nreturn 0;\r\n}\r\ncase V4L2_CID_AUDIO_TREBLE:\r\n{\r\nint treble=t->treble;\r\nif(treble >= 0x8)\r\ntreble = ~(treble - 0x8) & 0xf;\r\nctrl->value = (treble << 12)+(treble << 8)+(treble << 4)+(treble);\r\nreturn 0;\r\n}\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int tda7432_s_ctrl(struct v4l2_subdev *sd, struct v4l2_control *ctrl)\r\n{\r\nstruct tda7432 *t = to_state(sd);\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_AUDIO_MUTE:\r\nt->muted=ctrl->value;\r\nbreak;\r\ncase V4L2_CID_AUDIO_VOLUME:\r\nif(!maxvol){\r\nt->volume = 0x6f - ((ctrl->value)/630);\r\n} else {\r\nt->volume = 0x6f - ((ctrl->value)/829);\r\n}\r\nif (loudness)\r\nt->volume |= TDA7432_LD_ON;\r\ntda7432_write(sd, TDA7432_VL, t->volume);\r\nreturn 0;\r\ncase V4L2_CID_AUDIO_BALANCE:\r\nif (ctrl->value < 32768) {\r\nt->rr = (32768 - ctrl->value)/1057;\r\nt->rf = t->rr;\r\nt->lr = TDA7432_ATTEN_0DB;\r\nt->lf = TDA7432_ATTEN_0DB;\r\n} else if(ctrl->value > 32769) {\r\nt->lf = (ctrl->value - 32768)/1057;\r\nt->lr = t->lf;\r\nt->rr = TDA7432_ATTEN_0DB;\r\nt->rf = TDA7432_ATTEN_0DB;\r\n} else {\r\nt->rr = TDA7432_ATTEN_0DB;\r\nt->rf = TDA7432_ATTEN_0DB;\r\nt->lf = TDA7432_ATTEN_0DB;\r\nt->lr = TDA7432_ATTEN_0DB;\r\n}\r\nbreak;\r\ncase V4L2_CID_AUDIO_BASS:\r\nt->bass = ctrl->value >> 12;\r\nif(t->bass>= 0x8)\r\nt->bass = (~t->bass & 0xf) + 0x8 ;\r\ntda7432_write(sd, TDA7432_TN, 0x10 | (t->bass << 4) | t->treble);\r\nreturn 0;\r\ncase V4L2_CID_AUDIO_TREBLE:\r\nt->treble= ctrl->value >> 12;\r\nif(t->treble>= 0x8)\r\nt->treble = (~t->treble & 0xf) + 0x8 ;\r\ntda7432_write(sd, TDA7432_TN, 0x10 | (t->bass << 4) | t->treble);\r\nreturn 0;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (t->muted)\r\n{\r\ntda7432_write(sd, TDA7432_LF, t->lf | TDA7432_MUTE);\r\ntda7432_write(sd, TDA7432_LR, t->lr | TDA7432_MUTE);\r\ntda7432_write(sd, TDA7432_RF, t->rf | TDA7432_MUTE);\r\ntda7432_write(sd, TDA7432_RR, t->rr | TDA7432_MUTE);\r\n} else {\r\ntda7432_write(sd, TDA7432_LF, t->lf);\r\ntda7432_write(sd, TDA7432_LR, t->lr);\r\ntda7432_write(sd, TDA7432_RF, t->rf);\r\ntda7432_write(sd, TDA7432_RR, t->rr);\r\n}\r\nreturn 0;\r\n}\r\nstatic int tda7432_queryctrl(struct v4l2_subdev *sd, struct v4l2_queryctrl *qc)\r\n{\r\nswitch (qc->id) {\r\ncase V4L2_CID_AUDIO_VOLUME:\r\nreturn v4l2_ctrl_query_fill(qc, 0, 65535, 65535 / 100, 58880);\r\ncase V4L2_CID_AUDIO_MUTE:\r\nreturn v4l2_ctrl_query_fill(qc, 0, 1, 1, 0);\r\ncase V4L2_CID_AUDIO_BALANCE:\r\ncase V4L2_CID_AUDIO_BASS:\r\ncase V4L2_CID_AUDIO_TREBLE:\r\nreturn v4l2_ctrl_query_fill(qc, 0, 65535, 65535 / 100, 32768);\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int tda7432_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct tda7432 *t;\r\nstruct v4l2_subdev *sd;\r\nv4l_info(client, "chip found @ 0x%02x (%s)\n",\r\nclient->addr << 1, client->adapter->name);\r\nt = kzalloc(sizeof(*t), GFP_KERNEL);\r\nif (!t)\r\nreturn -ENOMEM;\r\nsd = &t->sd;\r\nv4l2_i2c_subdev_init(sd, client, &tda7432_ops);\r\nif (loudness < 0 || loudness > 15) {\r\nv4l2_warn(sd, "loudness parameter must be between 0 and 15\n");\r\nif (loudness < 0)\r\nloudness = 0;\r\nif (loudness > 15)\r\nloudness = 15;\r\n}\r\ndo_tda7432_init(sd);\r\nreturn 0;\r\n}\r\nstatic int tda7432_remove(struct i2c_client *client)\r\n{\r\nstruct v4l2_subdev *sd = i2c_get_clientdata(client);\r\ndo_tda7432_init(sd);\r\nv4l2_device_unregister_subdev(sd);\r\nkfree(to_state(sd));\r\nreturn 0;\r\n}

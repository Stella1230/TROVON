static void rtl8192_hw_sleep_down(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = rtllib_priv(dev);\r\nunsigned long flags = 0;\r\nspin_lock_irqsave(&priv->rf_ps_lock, flags);\r\nif (priv->RFChangeInProgress) {\r\nspin_unlock_irqrestore(&priv->rf_ps_lock, flags);\r\nRT_TRACE(COMP_DBG, "rtl8192_hw_sleep_down(): RF Change in "\r\n"progress!\n");\r\nreturn;\r\n}\r\nspin_unlock_irqrestore(&priv->rf_ps_lock, flags);\r\nRT_TRACE(COMP_DBG, "%s()============>come to sleep down\n", __func__);\r\nMgntActSet_RF_State(dev, eRfSleep, RF_CHANGE_BY_PS, false);\r\n}\r\nvoid rtl8192_hw_sleep_wq(void *data)\r\n{\r\nstruct rtllib_device *ieee = container_of_dwork_rsl(data,\r\nstruct rtllib_device, hw_sleep_wq);\r\nstruct net_device *dev = ieee->dev;\r\nrtl8192_hw_sleep_down(dev);\r\n}\r\nvoid rtl8192_hw_wakeup(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = rtllib_priv(dev);\r\nunsigned long flags = 0;\r\nspin_lock_irqsave(&priv->rf_ps_lock, flags);\r\nif (priv->RFChangeInProgress) {\r\nspin_unlock_irqrestore(&priv->rf_ps_lock, flags);\r\nRT_TRACE(COMP_DBG, "rtl8192_hw_wakeup(): RF Change in "\r\n"progress!\n");\r\nqueue_delayed_work_rsl(priv->rtllib->wq,\r\n&priv->rtllib->hw_wakeup_wq, MSECS(10));\r\nreturn;\r\n}\r\nspin_unlock_irqrestore(&priv->rf_ps_lock, flags);\r\nRT_TRACE(COMP_PS, "%s()============>come to wake up\n", __func__);\r\nMgntActSet_RF_State(dev, eRfOn, RF_CHANGE_BY_PS, false);\r\n}\r\nvoid rtl8192_hw_wakeup_wq(void *data)\r\n{\r\nstruct rtllib_device *ieee = container_of_dwork_rsl(data,\r\nstruct rtllib_device, hw_wakeup_wq);\r\nstruct net_device *dev = ieee->dev;\r\nrtl8192_hw_wakeup(dev);\r\n}\r\nvoid rtl8192_hw_to_sleep(struct net_device *dev, u64 time)\r\n{\r\nstruct r8192_priv *priv = rtllib_priv(dev);\r\nu32 tmp;\r\nunsigned long flags;\r\nspin_lock_irqsave(&priv->ps_lock, flags);\r\ntime -= MSECS(8+16+7);\r\nif ((time - jiffies) <= MSECS(MIN_SLEEP_TIME)) {\r\nspin_unlock_irqrestore(&priv->ps_lock, flags);\r\nprintk(KERN_INFO "too short to sleep::%lld < %ld\n",\r\ntime - jiffies, MSECS(MIN_SLEEP_TIME));\r\nreturn;\r\n}\r\nif ((time - jiffies) > MSECS(MAX_SLEEP_TIME)) {\r\nprintk(KERN_INFO "========>too long to sleep:%lld > %ld\n",\r\ntime - jiffies, MSECS(MAX_SLEEP_TIME));\r\nspin_unlock_irqrestore(&priv->ps_lock, flags);\r\nreturn;\r\n}\r\ntmp = time - jiffies;\r\nqueue_delayed_work_rsl(priv->rtllib->wq,\r\n&priv->rtllib->hw_wakeup_wq, tmp);\r\nqueue_delayed_work_rsl(priv->rtllib->wq,\r\n(void *)&priv->rtllib->hw_sleep_wq, 0);\r\nspin_unlock_irqrestore(&priv->ps_lock, flags);\r\n}\r\nstatic void InactivePsWorkItemCallback(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = rtllib_priv(dev);\r\nstruct rt_pwr_save_ctrl *pPSC = (struct rt_pwr_save_ctrl *)\r\n&(priv->rtllib->PowerSaveControl);\r\nRT_TRACE(COMP_PS, "InactivePsWorkItemCallback() --------->\n");\r\npPSC->bSwRfProcessing = true;\r\nRT_TRACE(COMP_PS, "InactivePsWorkItemCallback(): Set RF to %s.\n",\r\npPSC->eInactivePowerState == eRfOff ? "OFF" : "ON");\r\nMgntActSet_RF_State(dev, pPSC->eInactivePowerState, RF_CHANGE_BY_IPS,\r\nfalse);\r\npPSC->bSwRfProcessing = false;\r\nRT_TRACE(COMP_PS, "InactivePsWorkItemCallback() <---------\n");\r\n}\r\nvoid IPSEnter(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = rtllib_priv(dev);\r\nstruct rt_pwr_save_ctrl *pPSC = (struct rt_pwr_save_ctrl *)\r\n&(priv->rtllib->PowerSaveControl);\r\nenum rt_rf_power_state rtState;\r\nif (pPSC->bInactivePs) {\r\nrtState = priv->rtllib->eRFPowerState;\r\nif (rtState == eRfOn && !pPSC->bSwRfProcessing &&\r\n(priv->rtllib->state != RTLLIB_LINKED) &&\r\n(priv->rtllib->iw_mode != IW_MODE_MASTER)) {\r\nRT_TRACE(COMP_PS, "IPSEnter(): Turn off RF.\n");\r\npPSC->eInactivePowerState = eRfOff;\r\npriv->isRFOff = true;\r\npriv->bInPowerSaveMode = true;\r\nInactivePsWorkItemCallback(dev);\r\n}\r\n}\r\n}\r\nvoid IPSLeave(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = rtllib_priv(dev);\r\nstruct rt_pwr_save_ctrl *pPSC = (struct rt_pwr_save_ctrl *)\r\n&(priv->rtllib->PowerSaveControl);\r\nenum rt_rf_power_state rtState;\r\nif (pPSC->bInactivePs) {\r\nrtState = priv->rtllib->eRFPowerState;\r\nif (rtState != eRfOn && !pPSC->bSwRfProcessing &&\r\npriv->rtllib->RfOffReason <= RF_CHANGE_BY_IPS) {\r\nRT_TRACE(COMP_PS, "IPSLeave(): Turn on RF.\n");\r\npPSC->eInactivePowerState = eRfOn;\r\npriv->bInPowerSaveMode = false;\r\nInactivePsWorkItemCallback(dev);\r\n}\r\n}\r\n}\r\nvoid IPSLeave_wq(void *data)\r\n{\r\nstruct rtllib_device *ieee = container_of_work_rsl(data,\r\nstruct rtllib_device, ips_leave_wq);\r\nstruct net_device *dev = ieee->dev;\r\nstruct r8192_priv *priv = (struct r8192_priv *)rtllib_priv(dev);\r\ndown(&priv->rtllib->ips_sem);\r\nIPSLeave(dev);\r\nup(&priv->rtllib->ips_sem);\r\n}\r\nvoid rtllib_ips_leave_wq(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = (struct r8192_priv *)rtllib_priv(dev);\r\nenum rt_rf_power_state rtState;\r\nrtState = priv->rtllib->eRFPowerState;\r\nif (priv->rtllib->PowerSaveControl.bInactivePs) {\r\nif (rtState == eRfOff) {\r\nif (priv->rtllib->RfOffReason > RF_CHANGE_BY_IPS) {\r\nRT_TRACE(COMP_ERR, "%s(): RF is OFF.\n",\r\n__func__);\r\nreturn;\r\n} else {\r\nprintk(KERN_INFO "=========>%s(): IPSLeave\n",\r\n__func__);\r\nqueue_work_rsl(priv->rtllib->wq,\r\n&priv->rtllib->ips_leave_wq);\r\n}\r\n}\r\n}\r\n}\r\nvoid rtllib_ips_leave(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = (struct r8192_priv *)rtllib_priv(dev);\r\ndown(&priv->rtllib->ips_sem);\r\nIPSLeave(dev);\r\nup(&priv->rtllib->ips_sem);\r\n}\r\nstatic bool MgntActSet_802_11_PowerSaveMode(struct net_device *dev,\r\nu8 rtPsMode)\r\n{\r\nstruct r8192_priv *priv = rtllib_priv(dev);\r\nif (priv->rtllib->iw_mode == IW_MODE_ADHOC)\r\nreturn false;\r\nRT_TRACE(COMP_LPS, "%s(): set ieee->ps = %x\n", __func__, rtPsMode);\r\nif (!priv->ps_force)\r\npriv->rtllib->ps = rtPsMode;\r\nif (priv->rtllib->sta_sleep != LPS_IS_WAKE &&\r\nrtPsMode == RTLLIB_PS_DISABLED) {\r\nunsigned long flags;\r\nrtl8192_hw_wakeup(dev);\r\npriv->rtllib->sta_sleep = LPS_IS_WAKE;\r\nspin_lock_irqsave(&(priv->rtllib->mgmt_tx_lock), flags);\r\nRT_TRACE(COMP_DBG, "LPS leave: notify AP we are awaked"\r\n" ++++++++++ SendNullFunctionData\n");\r\nrtllib_sta_ps_send_null_frame(priv->rtllib, 0);\r\nspin_unlock_irqrestore(&(priv->rtllib->mgmt_tx_lock), flags);\r\n}\r\nreturn true;\r\n}\r\nvoid LeisurePSEnter(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = rtllib_priv(dev);\r\nstruct rt_pwr_save_ctrl *pPSC = (struct rt_pwr_save_ctrl *)\r\n&(priv->rtllib->PowerSaveControl);\r\nRT_TRACE(COMP_PS, "LeisurePSEnter()...\n");\r\nRT_TRACE(COMP_PS, "pPSC->bLeisurePs = %d, ieee->ps = %d,pPSC->LpsIdle"\r\n"Count is %d,RT_CHECK_FOR_HANG_PERIOD is %d\n",\r\npPSC->bLeisurePs, priv->rtllib->ps, pPSC->LpsIdleCount,\r\nRT_CHECK_FOR_HANG_PERIOD);\r\nif (!((priv->rtllib->iw_mode == IW_MODE_INFRA) &&\r\n(priv->rtllib->state == RTLLIB_LINKED))\r\n|| (priv->rtllib->iw_mode == IW_MODE_ADHOC) ||\r\n(priv->rtllib->iw_mode == IW_MODE_MASTER))\r\nreturn;\r\nif (pPSC->bLeisurePs) {\r\nif (pPSC->LpsIdleCount >= RT_CHECK_FOR_HANG_PERIOD) {\r\nif (priv->rtllib->ps == RTLLIB_PS_DISABLED) {\r\nRT_TRACE(COMP_LPS, "LeisurePSEnter(): Enter "\r\n"802.11 power save mode...\n");\r\nif (!pPSC->bFwCtrlLPS) {\r\nif (priv->rtllib->SetFwCmdHandler)\r\npriv->rtllib->SetFwCmdHandler(\r\ndev, FW_CMD_LPS_ENTER);\r\n}\r\nMgntActSet_802_11_PowerSaveMode(dev,\r\nRTLLIB_PS_MBCAST |\r\nRTLLIB_PS_UNICAST);\r\n}\r\n} else\r\npPSC->LpsIdleCount++;\r\n}\r\n}\r\nvoid LeisurePSLeave(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = rtllib_priv(dev);\r\nstruct rt_pwr_save_ctrl *pPSC = (struct rt_pwr_save_ctrl *)\r\n&(priv->rtllib->PowerSaveControl);\r\nRT_TRACE(COMP_PS, "LeisurePSLeave()...\n");\r\nRT_TRACE(COMP_PS, "pPSC->bLeisurePs = %d, ieee->ps = %d\n",\r\npPSC->bLeisurePs, priv->rtllib->ps);\r\nif (pPSC->bLeisurePs) {\r\nif (priv->rtllib->ps != RTLLIB_PS_DISABLED) {\r\nRT_TRACE(COMP_LPS, "LeisurePSLeave(): Busy Traffic , "\r\n"Leave 802.11 power save..\n");\r\nMgntActSet_802_11_PowerSaveMode(dev,\r\nRTLLIB_PS_DISABLED);\r\nif (!pPSC->bFwCtrlLPS) {\r\nif (priv->rtllib->SetFwCmdHandler)\r\npriv->rtllib->SetFwCmdHandler(dev,\r\nFW_CMD_LPS_LEAVE);\r\n}\r\n}\r\n}\r\n}

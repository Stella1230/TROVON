static int tea5764_i2c_read(struct tea5764_device *radio)\r\n{\r\nint i;\r\nu16 *p = (u16 *) &radio->regs;\r\nstruct i2c_msg msgs[1] = {\r\n{ .addr = radio->i2c_client->addr,\r\n.flags = I2C_M_RD,\r\n.len = sizeof(radio->regs),\r\n.buf = (void *)&radio->regs\r\n},\r\n};\r\nif (i2c_transfer(radio->i2c_client->adapter, msgs, 1) != 1)\r\nreturn -EIO;\r\nfor (i = 0; i < sizeof(struct tea5764_regs) / sizeof(u16); i++)\r\np[i] = __be16_to_cpu(p[i]);\r\nreturn 0;\r\n}\r\nstatic int tea5764_i2c_write(struct tea5764_device *radio)\r\n{\r\nstruct tea5764_write_regs wr;\r\nstruct tea5764_regs *r = &radio->regs;\r\nstruct i2c_msg msgs[1] = {\r\n{\r\n.addr = radio->i2c_client->addr,\r\n.len = sizeof(wr),\r\n.buf = (void *)&wr\r\n},\r\n};\r\nwr.intreg = r->intreg & 0xff;\r\nwr.frqset = __cpu_to_be16(r->frqset);\r\nwr.tnctrl = __cpu_to_be16(r->tnctrl);\r\nwr.testreg = __cpu_to_be16(r->testreg);\r\nwr.rdsctrl = __cpu_to_be16(r->rdsctrl);\r\nwr.rdsbbl = __cpu_to_be16(r->rdsbbl);\r\nif (i2c_transfer(radio->i2c_client->adapter, msgs, 1) != 1)\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic void tea5764_power_up(struct tea5764_device *radio)\r\n{\r\nstruct tea5764_regs *r = &radio->regs;\r\nif (!(r->tnctrl & TEA5764_TNCTRL_PUPD0)) {\r\nr->tnctrl &= ~(TEA5764_TNCTRL_AFM | TEA5764_TNCTRL_MU |\r\nTEA5764_TNCTRL_HLSI);\r\nif (!use_xtal)\r\nr->testreg |= TEA5764_TESTREG_TRIGFR;\r\nelse\r\nr->testreg &= ~TEA5764_TESTREG_TRIGFR;\r\nr->tnctrl |= TEA5764_TNCTRL_PUPD0;\r\ntea5764_i2c_write(radio);\r\n}\r\n}\r\nstatic void tea5764_power_down(struct tea5764_device *radio)\r\n{\r\nstruct tea5764_regs *r = &radio->regs;\r\nif (r->tnctrl & TEA5764_TNCTRL_PUPD0) {\r\nr->tnctrl &= ~TEA5764_TNCTRL_PUPD0;\r\ntea5764_i2c_write(radio);\r\n}\r\n}\r\nstatic void tea5764_set_freq(struct tea5764_device *radio, int freq)\r\n{\r\nstruct tea5764_regs *r = &radio->regs;\r\nif (r->tnctrl & TEA5764_TNCTRL_HLSI)\r\nr->frqset = (freq + 225000) / 8192;\r\nelse\r\nr->frqset = (freq - 225000) / 8192;\r\n}\r\nstatic int tea5764_get_freq(struct tea5764_device *radio)\r\n{\r\nstruct tea5764_regs *r = &radio->regs;\r\nif (r->tnctrl & TEA5764_TNCTRL_HLSI)\r\nreturn (r->frqchk * 8192) - 225000;\r\nelse\r\nreturn (r->frqchk * 8192) + 225000;\r\n}\r\nstatic void tea5764_tune(struct tea5764_device *radio, int freq)\r\n{\r\ntea5764_set_freq(radio, freq);\r\nif (tea5764_i2c_write(radio))\r\nPWARN("Could not set frequency!");\r\n}\r\nstatic void tea5764_set_audout_mode(struct tea5764_device *radio, int audmode)\r\n{\r\nstruct tea5764_regs *r = &radio->regs;\r\nint tnctrl = r->tnctrl;\r\nif (audmode == V4L2_TUNER_MODE_MONO)\r\nr->tnctrl |= TEA5764_TNCTRL_MST;\r\nelse\r\nr->tnctrl &= ~TEA5764_TNCTRL_MST;\r\nif (tnctrl != r->tnctrl)\r\ntea5764_i2c_write(radio);\r\n}\r\nstatic int tea5764_get_audout_mode(struct tea5764_device *radio)\r\n{\r\nstruct tea5764_regs *r = &radio->regs;\r\nif (r->tnctrl & TEA5764_TNCTRL_MST)\r\nreturn V4L2_TUNER_MODE_MONO;\r\nelse\r\nreturn V4L2_TUNER_MODE_STEREO;\r\n}\r\nstatic void tea5764_mute(struct tea5764_device *radio, int on)\r\n{\r\nstruct tea5764_regs *r = &radio->regs;\r\nint tnctrl = r->tnctrl;\r\nif (on)\r\nr->tnctrl |= TEA5764_TNCTRL_MU;\r\nelse\r\nr->tnctrl &= ~TEA5764_TNCTRL_MU;\r\nif (tnctrl != r->tnctrl)\r\ntea5764_i2c_write(radio);\r\n}\r\nstatic int tea5764_is_muted(struct tea5764_device *radio)\r\n{\r\nreturn radio->regs.tnctrl & TEA5764_TNCTRL_MU;\r\n}\r\nstatic int vidioc_querycap(struct file *file, void *priv,\r\nstruct v4l2_capability *v)\r\n{\r\nstruct tea5764_device *radio = video_drvdata(file);\r\nstruct video_device *dev = radio->videodev;\r\nstrlcpy(v->driver, dev->dev.driver->name, sizeof(v->driver));\r\nstrlcpy(v->card, dev->name, sizeof(v->card));\r\nsnprintf(v->bus_info, sizeof(v->bus_info),\r\n"I2C:%s", dev_name(&dev->dev));\r\nv->capabilities = V4L2_CAP_TUNER | V4L2_CAP_RADIO;\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_tuner(struct file *file, void *priv,\r\nstruct v4l2_tuner *v)\r\n{\r\nstruct tea5764_device *radio = video_drvdata(file);\r\nstruct tea5764_regs *r = &radio->regs;\r\nif (v->index > 0)\r\nreturn -EINVAL;\r\nmemset(v, 0, sizeof(*v));\r\nstrcpy(v->name, "FM");\r\nv->type = V4L2_TUNER_RADIO;\r\ntea5764_i2c_read(radio);\r\nv->rangelow = FREQ_MIN * FREQ_MUL;\r\nv->rangehigh = FREQ_MAX * FREQ_MUL;\r\nv->capability = V4L2_TUNER_CAP_LOW | V4L2_TUNER_CAP_STEREO;\r\nif (r->tunchk & TEA5764_TUNCHK_STEREO)\r\nv->rxsubchans = V4L2_TUNER_SUB_STEREO;\r\nelse\r\nv->rxsubchans = V4L2_TUNER_SUB_MONO;\r\nv->audmode = tea5764_get_audout_mode(radio);\r\nv->signal = TEA5764_TUNCHK_LEVEL(r->tunchk) * 0xffff / 0xf;\r\nv->afc = TEA5764_TUNCHK_IFCNT(r->tunchk);\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_tuner(struct file *file, void *priv,\r\nstruct v4l2_tuner *v)\r\n{\r\nstruct tea5764_device *radio = video_drvdata(file);\r\nif (v->index > 0)\r\nreturn -EINVAL;\r\ntea5764_set_audout_mode(radio, v->audmode);\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_frequency(struct file *file, void *priv,\r\nstruct v4l2_frequency *f)\r\n{\r\nstruct tea5764_device *radio = video_drvdata(file);\r\nif (f->tuner != 0 || f->type != V4L2_TUNER_RADIO)\r\nreturn -EINVAL;\r\nif (f->frequency == 0) {\r\ntea5764_power_down(radio);\r\n}\r\nif (f->frequency < (FREQ_MIN * FREQ_MUL))\r\nreturn -EINVAL;\r\nif (f->frequency > (FREQ_MAX * FREQ_MUL))\r\nreturn -EINVAL;\r\ntea5764_power_up(radio);\r\ntea5764_tune(radio, (f->frequency * 125) / 2);\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_frequency(struct file *file, void *priv,\r\nstruct v4l2_frequency *f)\r\n{\r\nstruct tea5764_device *radio = video_drvdata(file);\r\nstruct tea5764_regs *r = &radio->regs;\r\nif (f->tuner != 0)\r\nreturn -EINVAL;\r\ntea5764_i2c_read(radio);\r\nmemset(f, 0, sizeof(*f));\r\nf->type = V4L2_TUNER_RADIO;\r\nif (r->tnctrl & TEA5764_TNCTRL_PUPD0)\r\nf->frequency = (tea5764_get_freq(radio) * 2) / 125;\r\nelse\r\nf->frequency = 0;\r\nreturn 0;\r\n}\r\nstatic int vidioc_queryctrl(struct file *file, void *priv,\r\nstruct v4l2_queryctrl *qc)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(radio_qctrl); i++) {\r\nif (qc->id && qc->id == radio_qctrl[i].id) {\r\nmemcpy(qc, &(radio_qctrl[i]), sizeof(*qc));\r\nreturn 0;\r\n}\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int vidioc_g_ctrl(struct file *file, void *priv,\r\nstruct v4l2_control *ctrl)\r\n{\r\nstruct tea5764_device *radio = video_drvdata(file);\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_AUDIO_MUTE:\r\ntea5764_i2c_read(radio);\r\nctrl->value = tea5764_is_muted(radio) ? 1 : 0;\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int vidioc_s_ctrl(struct file *file, void *priv,\r\nstruct v4l2_control *ctrl)\r\n{\r\nstruct tea5764_device *radio = video_drvdata(file);\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_AUDIO_MUTE:\r\ntea5764_mute(radio, ctrl->value);\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int vidioc_g_input(struct file *filp, void *priv, unsigned int *i)\r\n{\r\n*i = 0;\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_input(struct file *filp, void *priv, unsigned int i)\r\n{\r\nif (i != 0)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int vidioc_g_audio(struct file *file, void *priv,\r\nstruct v4l2_audio *a)\r\n{\r\nif (a->index > 1)\r\nreturn -EINVAL;\r\nstrcpy(a->name, "Radio");\r\na->capability = V4L2_AUDCAP_STEREO;\r\nreturn 0;\r\n}\r\nstatic int vidioc_s_audio(struct file *file, void *priv,\r\nconst struct v4l2_audio *a)\r\n{\r\nif (a->index != 0)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int tea5764_i2c_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct tea5764_device *radio;\r\nstruct tea5764_regs *r;\r\nint ret;\r\nPDEBUG("probe");\r\nradio = kzalloc(sizeof(struct tea5764_device), GFP_KERNEL);\r\nif (!radio)\r\nreturn -ENOMEM;\r\nmutex_init(&radio->mutex);\r\nradio->i2c_client = client;\r\nret = tea5764_i2c_read(radio);\r\nif (ret)\r\ngoto errfr;\r\nr = &radio->regs;\r\nPDEBUG("chipid = %04X, manid = %04X", r->chipid, r->manid);\r\nif (r->chipid != TEA5764_CHIPID ||\r\n(r->manid & 0x0fff) != TEA5764_MANID) {\r\nPWARN("This chip is not a TEA5764!");\r\nret = -EINVAL;\r\ngoto errfr;\r\n}\r\nradio->videodev = video_device_alloc();\r\nif (!(radio->videodev)) {\r\nret = -ENOMEM;\r\ngoto errfr;\r\n}\r\nmemcpy(radio->videodev, &tea5764_radio_template,\r\nsizeof(tea5764_radio_template));\r\ni2c_set_clientdata(client, radio);\r\nvideo_set_drvdata(radio->videodev, radio);\r\nradio->videodev->lock = &radio->mutex;\r\ntea5764_i2c_read(radio);\r\ntea5764_set_audout_mode(radio, V4L2_TUNER_MODE_STEREO);\r\ntea5764_mute(radio, 1);\r\ntea5764_power_down(radio);\r\nret = video_register_device(radio->videodev, VFL_TYPE_RADIO, radio_nr);\r\nif (ret < 0) {\r\nPWARN("Could not register video device!");\r\ngoto errrel;\r\n}\r\nPINFO("registered.");\r\nreturn 0;\r\nerrrel:\r\nvideo_device_release(radio->videodev);\r\nerrfr:\r\nkfree(radio);\r\nreturn ret;\r\n}\r\nstatic int tea5764_i2c_remove(struct i2c_client *client)\r\n{\r\nstruct tea5764_device *radio = i2c_get_clientdata(client);\r\nPDEBUG("remove");\r\nif (radio) {\r\ntea5764_power_down(radio);\r\nvideo_unregister_device(radio->videodev);\r\nkfree(radio);\r\n}\r\nreturn 0;\r\n}

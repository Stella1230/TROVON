static int bf5xx_i2s_set_dai_fmt(struct snd_soc_dai *cpu_dai,\r\nunsigned int fmt)\r\n{\r\nstruct sport_device *sport_handle = snd_soc_dai_get_drvdata(cpu_dai);\r\nstruct bf5xx_i2s_port *bf5xx_i2s = sport_handle->private_data;\r\nint ret = 0;\r\nswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\r\ncase SND_SOC_DAIFMT_I2S:\r\nbf5xx_i2s->tcr1 |= TFSR | TCKFE;\r\nbf5xx_i2s->rcr1 |= RFSR | RCKFE;\r\nbf5xx_i2s->tcr2 |= TSFSE;\r\nbf5xx_i2s->rcr2 |= RSFSE;\r\nbreak;\r\ncase SND_SOC_DAIFMT_DSP_A:\r\nbf5xx_i2s->tcr1 |= TFSR;\r\nbf5xx_i2s->rcr1 |= RFSR;\r\nbreak;\r\ncase SND_SOC_DAIFMT_LEFT_J:\r\nret = -EINVAL;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "%s: Unknown DAI format type\n", __func__);\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nswitch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {\r\ncase SND_SOC_DAIFMT_CBM_CFM:\r\nbreak;\r\ncase SND_SOC_DAIFMT_CBS_CFS:\r\ncase SND_SOC_DAIFMT_CBM_CFS:\r\ncase SND_SOC_DAIFMT_CBS_CFM:\r\nret = -EINVAL;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "%s: Unknown DAI master type\n", __func__);\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int bf5xx_i2s_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct sport_device *sport_handle = snd_soc_dai_get_drvdata(dai);\r\nstruct bf5xx_i2s_port *bf5xx_i2s = sport_handle->private_data;\r\nint ret = 0;\r\nbf5xx_i2s->tcr2 &= ~0x1f;\r\nbf5xx_i2s->rcr2 &= ~0x1f;\r\nswitch (params_format(params)) {\r\ncase SNDRV_PCM_FORMAT_S8:\r\nbf5xx_i2s->tcr2 |= 7;\r\nbf5xx_i2s->rcr2 |= 7;\r\nsport_handle->wdsize = 1;\r\ncase SNDRV_PCM_FORMAT_S16_LE:\r\nbf5xx_i2s->tcr2 |= 15;\r\nbf5xx_i2s->rcr2 |= 15;\r\nsport_handle->wdsize = 2;\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S24_LE:\r\nbf5xx_i2s->tcr2 |= 23;\r\nbf5xx_i2s->rcr2 |= 23;\r\nsport_handle->wdsize = 3;\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S32_LE:\r\nbf5xx_i2s->tcr2 |= 31;\r\nbf5xx_i2s->rcr2 |= 31;\r\nsport_handle->wdsize = 4;\r\nbreak;\r\n}\r\nif (!bf5xx_i2s->configured) {\r\nbf5xx_i2s->configured = 1;\r\nret = sport_config_rx(sport_handle, bf5xx_i2s->rcr1,\r\nbf5xx_i2s->rcr2, 0, 0);\r\nif (ret) {\r\npr_err("SPORT is busy!\n");\r\nreturn -EBUSY;\r\n}\r\nret = sport_config_tx(sport_handle, bf5xx_i2s->tcr1,\r\nbf5xx_i2s->tcr2, 0, 0);\r\nif (ret) {\r\npr_err("SPORT is busy!\n");\r\nreturn -EBUSY;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void bf5xx_i2s_shutdown(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct sport_device *sport_handle = snd_soc_dai_get_drvdata(dai);\r\nstruct bf5xx_i2s_port *bf5xx_i2s = sport_handle->private_data;\r\npr_debug("%s enter\n", __func__);\r\nif (!dai->active)\r\nbf5xx_i2s->configured = 0;\r\n}\r\nstatic int bf5xx_i2s_suspend(struct snd_soc_dai *dai)\r\n{\r\nstruct sport_device *sport_handle = snd_soc_dai_get_drvdata(dai);\r\npr_debug("%s : sport %d\n", __func__, dai->id);\r\nif (dai->capture_active)\r\nsport_rx_stop(sport_handle);\r\nif (dai->playback_active)\r\nsport_tx_stop(sport_handle);\r\nreturn 0;\r\n}\r\nstatic int bf5xx_i2s_resume(struct snd_soc_dai *dai)\r\n{\r\nstruct sport_device *sport_handle = snd_soc_dai_get_drvdata(dai);\r\nstruct bf5xx_i2s_port *bf5xx_i2s = sport_handle->private_data;\r\nint ret;\r\npr_debug("%s : sport %d\n", __func__, dai->id);\r\nret = sport_config_rx(sport_handle, bf5xx_i2s->rcr1,\r\nbf5xx_i2s->rcr2, 0, 0);\r\nif (ret) {\r\npr_err("SPORT is busy!\n");\r\nreturn -EBUSY;\r\n}\r\nret = sport_config_tx(sport_handle, bf5xx_i2s->tcr1,\r\nbf5xx_i2s->tcr2, 0, 0);\r\nif (ret) {\r\npr_err("SPORT is busy!\n");\r\nreturn -EBUSY;\r\n}\r\nreturn 0;\r\n}\r\nstatic int bf5xx_i2s_probe(struct platform_device *pdev)\r\n{\r\nstruct sport_device *sport_handle;\r\nint ret;\r\nsport_handle = sport_init(pdev, 4, 2 * sizeof(u32),\r\nsizeof(struct bf5xx_i2s_port));\r\nif (!sport_handle)\r\nreturn -ENODEV;\r\nret = snd_soc_register_dai(&pdev->dev, &bf5xx_i2s_dai);\r\nif (ret) {\r\npr_err("Failed to register DAI: %d\n", ret);\r\nsport_done(sport_handle);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int bf5xx_i2s_remove(struct platform_device *pdev)\r\n{\r\nstruct sport_device *sport_handle = platform_get_drvdata(pdev);\r\npr_debug("%s enter\n", __func__);\r\nsnd_soc_unregister_dai(&pdev->dev);\r\nsport_done(sport_handle);\r\nreturn 0;\r\n}

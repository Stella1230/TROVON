static inline void max197_set_unipolarity(struct max197_data *data, int channel)\r\n{\r\ndata->ctrl_bytes[channel] &= ~MAX197_BIP;\r\n}\r\nstatic inline void max197_set_bipolarity(struct max197_data *data, int channel)\r\n{\r\ndata->ctrl_bytes[channel] |= MAX197_BIP;\r\n}\r\nstatic inline void max197_set_half_range(struct max197_data *data, int channel)\r\n{\r\ndata->ctrl_bytes[channel] &= ~MAX197_RNG;\r\n}\r\nstatic inline void max197_set_full_range(struct max197_data *data, int channel)\r\n{\r\ndata->ctrl_bytes[channel] |= MAX197_RNG;\r\n}\r\nstatic inline bool max197_is_bipolar(struct max197_data *data, int channel)\r\n{\r\nreturn data->ctrl_bytes[channel] & MAX197_BIP;\r\n}\r\nstatic inline bool max197_is_full_range(struct max197_data *data, int channel)\r\n{\r\nreturn data->ctrl_bytes[channel] & MAX197_RNG;\r\n}\r\nstatic ssize_t max197_show_range(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct max197_data *data = dev_get_drvdata(dev);\r\nstruct sensor_device_attribute_2 *attr = to_sensor_dev_attr_2(devattr);\r\nint channel = attr->index;\r\nbool is_min = attr->nr;\r\nint range;\r\nif (mutex_lock_interruptible(&data->lock))\r\nreturn -ERESTARTSYS;\r\nrange = max197_is_full_range(data, channel) ?\r\ndata->limit : data->limit / 2;\r\nif (is_min) {\r\nif (max197_is_bipolar(data, channel))\r\nrange = -range;\r\nelse\r\nrange = 0;\r\n}\r\nmutex_unlock(&data->lock);\r\nreturn sprintf(buf, "%d\n", range);\r\n}\r\nstatic ssize_t max197_store_range(struct device *dev,\r\nstruct device_attribute *devattr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct max197_data *data = dev_get_drvdata(dev);\r\nstruct sensor_device_attribute_2 *attr = to_sensor_dev_attr_2(devattr);\r\nint channel = attr->index;\r\nbool is_min = attr->nr;\r\nlong value;\r\nint half = data->limit / 2;\r\nint full = data->limit;\r\nif (kstrtol(buf, 10, &value))\r\nreturn -EINVAL;\r\nif (is_min) {\r\nif (value <= -full)\r\nvalue = -full;\r\nelse if (value < 0)\r\nvalue = -half;\r\nelse\r\nvalue = 0;\r\n} else {\r\nif (value >= full)\r\nvalue = full;\r\nelse\r\nvalue = half;\r\n}\r\nif (mutex_lock_interruptible(&data->lock))\r\nreturn -ERESTARTSYS;\r\nif (value == 0) {\r\nmax197_set_unipolarity(data, channel);\r\n} else if (value == -half) {\r\nmax197_set_bipolarity(data, channel);\r\nmax197_set_half_range(data, channel);\r\n} else if (value == -full) {\r\nmax197_set_bipolarity(data, channel);\r\nmax197_set_full_range(data, channel);\r\n} else if (value == half) {\r\nmax197_set_half_range(data, channel);\r\n} else if (value == full) {\r\nmax197_set_full_range(data, channel);\r\n}\r\nmutex_unlock(&data->lock);\r\nreturn count;\r\n}\r\nstatic ssize_t max197_show_input(struct device *dev,\r\nstruct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nstruct max197_data *data = dev_get_drvdata(dev);\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nint channel = attr->index;\r\ns32 value;\r\nint ret;\r\nif (mutex_lock_interruptible(&data->lock))\r\nreturn -ERESTARTSYS;\r\nret = data->pdata->convert(data->ctrl_bytes[channel]);\r\nif (ret < 0) {\r\ndev_err(dev, "conversion failed\n");\r\ngoto unlock;\r\n}\r\nvalue = ret;\r\nif (data->scale) {\r\nvalue *= MAX197_SCALE;\r\nif (max197_is_full_range(data, channel))\r\nvalue *= 2;\r\nvalue /= 10000;\r\n}\r\nret = sprintf(buf, "%d\n", value);\r\nunlock:\r\nmutex_unlock(&data->lock);\r\nreturn ret;\r\n}\r\nstatic ssize_t max197_show_name(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nreturn sprintf(buf, "%s\n", pdev->name);\r\n}\r\nstatic int max197_probe(struct platform_device *pdev)\r\n{\r\nint ch, ret;\r\nstruct max197_data *data;\r\nstruct max197_platform_data *pdata = pdev->dev.platform_data;\r\nenum max197_chips chip = platform_get_device_id(pdev)->driver_data;\r\nif (pdata == NULL) {\r\ndev_err(&pdev->dev, "no platform data supplied\n");\r\nreturn -EINVAL;\r\n}\r\nif (pdata->convert == NULL) {\r\ndev_err(&pdev->dev, "no convert function supplied\n");\r\nreturn -EINVAL;\r\n}\r\ndata = devm_kzalloc(&pdev->dev, sizeof(struct max197_data), GFP_KERNEL);\r\nif (!data) {\r\ndev_err(&pdev->dev, "devm_kzalloc failed\n");\r\nreturn -ENOMEM;\r\n}\r\ndata->pdata = pdata;\r\nmutex_init(&data->lock);\r\nif (chip == max197) {\r\ndata->limit = MAX197_LIMIT;\r\ndata->scale = true;\r\n} else {\r\ndata->limit = MAX199_LIMIT;\r\ndata->scale = false;\r\n}\r\nfor (ch = 0; ch < MAX197_NUM_CH; ch++)\r\ndata->ctrl_bytes[ch] = (u8) ch;\r\nplatform_set_drvdata(pdev, data);\r\nret = sysfs_create_group(&pdev->dev.kobj, &max197_sysfs_group);\r\nif (ret) {\r\ndev_err(&pdev->dev, "sysfs create group failed\n");\r\nreturn ret;\r\n}\r\ndata->hwmon_dev = hwmon_device_register(&pdev->dev);\r\nif (IS_ERR(data->hwmon_dev)) {\r\nret = PTR_ERR(data->hwmon_dev);\r\ndev_err(&pdev->dev, "hwmon device register failed\n");\r\ngoto error;\r\n}\r\nreturn 0;\r\nerror:\r\nsysfs_remove_group(&pdev->dev.kobj, &max197_sysfs_group);\r\nreturn ret;\r\n}\r\nstatic int max197_remove(struct platform_device *pdev)\r\n{\r\nstruct max197_data *data = platform_get_drvdata(pdev);\r\nhwmon_device_unregister(data->hwmon_dev);\r\nsysfs_remove_group(&pdev->dev.kobj, &max197_sysfs_group);\r\nreturn 0;\r\n}

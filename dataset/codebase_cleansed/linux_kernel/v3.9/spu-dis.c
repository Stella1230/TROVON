static void\r\ninit_spu_disassemble (void)\r\n{\r\nint i;\r\nfor (i = 0; i < spu_num_opcodes; i++)\r\n{\r\nint o = spu_opcodes[i].opcode;\r\nif (o >= SPU_DISASM_TBL_SIZE)\r\ncontinue;\r\nif (spu_disassemble_table[o] == 0)\r\nspu_disassemble_table[o] = &spu_opcodes[i];\r\n}\r\n}\r\nstatic const struct spu_opcode *\r\nget_index_for_opcode (unsigned int insn)\r\n{\r\nconst struct spu_opcode *index;\r\nunsigned int opcode = insn >> (32-11);\r\nif (spu_disassemble_table[0] == 0)\r\ninit_spu_disassemble ();\r\nif ((index = spu_disassemble_table[opcode & 0x780]) != 0\r\n&& index->insn_type == RRR)\r\nreturn index;\r\nif ((index = spu_disassemble_table[opcode & 0x7f0]) != 0\r\n&& (index->insn_type == RI18 || index->insn_type == LBT))\r\nreturn index;\r\nif ((index = spu_disassemble_table[opcode & 0x7f8]) != 0\r\n&& index->insn_type == RI10)\r\nreturn index;\r\nif ((index = spu_disassemble_table[opcode & 0x7fc]) != 0\r\n&& (index->insn_type == RI16))\r\nreturn index;\r\nif ((index = spu_disassemble_table[opcode & 0x7fe]) != 0\r\n&& (index->insn_type == RI8))\r\nreturn index;\r\nif ((index = spu_disassemble_table[opcode & 0x7ff]) != 0)\r\nreturn index;\r\nreturn NULL;\r\n}\r\nint\r\nprint_insn_spu (unsigned long insn, unsigned long memaddr)\r\n{\r\nint value;\r\nint hex_value;\r\nconst struct spu_opcode *index;\r\nenum spu_insns tag;\r\nindex = get_index_for_opcode (insn);\r\nif (index == 0)\r\n{\r\nprintf(".long 0x%x", insn);\r\n}\r\nelse\r\n{\r\nint i;\r\nint paren = 0;\r\ntag = (enum spu_insns)(index - spu_opcodes);\r\nprintf("%s", index->mnemonic);\r\nif (tag == M_BI || tag == M_BISL || tag == M_IRET || tag == M_BISLED\r\n|| tag == M_BIHNZ || tag == M_BIHZ || tag == M_BINZ || tag == M_BIZ\r\n|| tag == M_SYNC || tag == M_HBR)\r\n{\r\nint fb = (insn >> (32-18)) & 0x7f;\r\nif (fb & 0x40)\r\nprintf(tag == M_SYNC ? "c" : "p");\r\nif (fb & 0x20)\r\nprintf("d");\r\nif (fb & 0x10)\r\nprintf("e");\r\n}\r\nif (index->arg[0] != 0)\r\nprintf("\t");\r\nhex_value = 0;\r\nfor (i = 1; i <= index->arg[0]; i++)\r\n{\r\nint arg = index->arg[i];\r\nif (arg != A_P && !paren && i > 1)\r\nprintf(",");\r\nswitch (arg)\r\n{\r\ncase A_T:\r\nprintf("$%d",\r\nDECODE_INSN_RT (insn));\r\nbreak;\r\ncase A_A:\r\nprintf("$%d",\r\nDECODE_INSN_RA (insn));\r\nbreak;\r\ncase A_B:\r\nprintf("$%d",\r\nDECODE_INSN_RB (insn));\r\nbreak;\r\ncase A_C:\r\nprintf("$%d",\r\nDECODE_INSN_RC (insn));\r\nbreak;\r\ncase A_S:\r\nprintf("$sp%d",\r\nDECODE_INSN_RA (insn));\r\nbreak;\r\ncase A_H:\r\nprintf("$ch%d",\r\nDECODE_INSN_RA (insn));\r\nbreak;\r\ncase A_P:\r\nparen++;\r\nprintf("(");\r\nbreak;\r\ncase A_U7A:\r\nprintf("%d",\r\n173 - DECODE_INSN_U8 (insn));\r\nbreak;\r\ncase A_U7B:\r\nprintf("%d",\r\n155 - DECODE_INSN_U8 (insn));\r\nbreak;\r\ncase A_S3:\r\ncase A_S6:\r\ncase A_S7:\r\ncase A_S7N:\r\ncase A_U3:\r\ncase A_U5:\r\ncase A_U6:\r\ncase A_U7:\r\nhex_value = DECODE_INSN_I7 (insn);\r\nprintf("%d", hex_value);\r\nbreak;\r\ncase A_S11:\r\nprint_address(memaddr + DECODE_INSN_I9a (insn) * 4);\r\nbreak;\r\ncase A_S11I:\r\nprint_address(memaddr + DECODE_INSN_I9b (insn) * 4);\r\nbreak;\r\ncase A_S10:\r\ncase A_S10B:\r\nhex_value = DECODE_INSN_I10 (insn);\r\nprintf("%d", hex_value);\r\nbreak;\r\ncase A_S14:\r\nhex_value = DECODE_INSN_I10 (insn) * 16;\r\nprintf("%d", hex_value);\r\nbreak;\r\ncase A_S16:\r\nhex_value = DECODE_INSN_I16 (insn);\r\nprintf("%d", hex_value);\r\nbreak;\r\ncase A_X16:\r\nhex_value = DECODE_INSN_U16 (insn);\r\nprintf("%u", hex_value);\r\nbreak;\r\ncase A_R18:\r\nvalue = DECODE_INSN_I16 (insn) * 4;\r\nif (value == 0)\r\nprintf("%d", value);\r\nelse\r\n{\r\nhex_value = memaddr + value;\r\nprint_address(hex_value & 0x3ffff);\r\n}\r\nbreak;\r\ncase A_S18:\r\nvalue = DECODE_INSN_U16 (insn) * 4;\r\nif (value == 0)\r\nprintf("%d", value);\r\nelse\r\nprint_address(value);\r\nbreak;\r\ncase A_U18:\r\nvalue = DECODE_INSN_U18 (insn);\r\nif (value == 0 || 1)\r\n{\r\nhex_value = value;\r\nprintf("%u", value);\r\n}\r\nelse\r\nprint_address(value);\r\nbreak;\r\ncase A_U14:\r\nhex_value = DECODE_INSN_U14 (insn);\r\nprintf("%u", hex_value);\r\nbreak;\r\n}\r\nif (arg != A_P && paren)\r\n{\r\nprintf(")");\r\nparen--;\r\n}\r\n}\r\nif (hex_value > 16)\r\nprintf("\t# %x", hex_value);\r\n}\r\nreturn 4;\r\n}

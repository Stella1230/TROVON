static int sharp_ls_bl_update_status(struct backlight_device *bl)\r\n{\r\nstruct omap_dss_device *dssdev = dev_get_drvdata(&bl->dev);\r\nint level;\r\nif (!dssdev->set_backlight)\r\nreturn -EINVAL;\r\nif (bl->props.fb_blank == FB_BLANK_UNBLANK &&\r\nbl->props.power == FB_BLANK_UNBLANK)\r\nlevel = bl->props.brightness;\r\nelse\r\nlevel = 0;\r\nreturn dssdev->set_backlight(dssdev, level);\r\n}\r\nstatic int sharp_ls_bl_get_brightness(struct backlight_device *bl)\r\n{\r\nif (bl->props.fb_blank == FB_BLANK_UNBLANK &&\r\nbl->props.power == FB_BLANK_UNBLANK)\r\nreturn bl->props.brightness;\r\nreturn 0;\r\n}\r\nstatic int sharp_ls_panel_probe(struct omap_dss_device *dssdev)\r\n{\r\nstruct backlight_properties props;\r\nstruct backlight_device *bl;\r\nstruct sharp_data *sd;\r\nint r;\r\ndssdev->panel.timings = sharp_ls_timings;\r\nsd = kzalloc(sizeof(*sd), GFP_KERNEL);\r\nif (!sd)\r\nreturn -ENOMEM;\r\ndev_set_drvdata(&dssdev->dev, sd);\r\nmemset(&props, 0, sizeof(struct backlight_properties));\r\nprops.max_brightness = dssdev->max_backlight_level;\r\nprops.type = BACKLIGHT_RAW;\r\nbl = backlight_device_register("sharp-ls", &dssdev->dev, dssdev,\r\n&sharp_ls_bl_ops, &props);\r\nif (IS_ERR(bl)) {\r\nr = PTR_ERR(bl);\r\nkfree(sd);\r\nreturn r;\r\n}\r\nsd->bl = bl;\r\nbl->props.fb_blank = FB_BLANK_UNBLANK;\r\nbl->props.power = FB_BLANK_UNBLANK;\r\nbl->props.brightness = dssdev->max_backlight_level;\r\nr = sharp_ls_bl_update_status(bl);\r\nif (r < 0)\r\ndev_err(&dssdev->dev, "failed to set lcd brightness\n");\r\nreturn 0;\r\n}\r\nstatic void __exit sharp_ls_panel_remove(struct omap_dss_device *dssdev)\r\n{\r\nstruct sharp_data *sd = dev_get_drvdata(&dssdev->dev);\r\nstruct backlight_device *bl = sd->bl;\r\nbl->props.power = FB_BLANK_POWERDOWN;\r\nsharp_ls_bl_update_status(bl);\r\nbacklight_device_unregister(bl);\r\nkfree(sd);\r\n}\r\nstatic int sharp_ls_power_on(struct omap_dss_device *dssdev)\r\n{\r\nint r = 0;\r\nif (dssdev->state == OMAP_DSS_DISPLAY_ACTIVE)\r\nreturn 0;\r\nomapdss_dpi_set_timings(dssdev, &dssdev->panel.timings);\r\nomapdss_dpi_set_data_lines(dssdev, dssdev->phy.dpi.data_lines);\r\nr = omapdss_dpi_display_enable(dssdev);\r\nif (r)\r\ngoto err0;\r\nmsleep(50);\r\nif (dssdev->platform_enable) {\r\nr = dssdev->platform_enable(dssdev);\r\nif (r)\r\ngoto err1;\r\n}\r\nreturn 0;\r\nerr1:\r\nomapdss_dpi_display_disable(dssdev);\r\nerr0:\r\nreturn r;\r\n}\r\nstatic void sharp_ls_power_off(struct omap_dss_device *dssdev)\r\n{\r\nif (dssdev->state != OMAP_DSS_DISPLAY_ACTIVE)\r\nreturn;\r\nif (dssdev->platform_disable)\r\ndssdev->platform_disable(dssdev);\r\nmsleep(100);\r\nomapdss_dpi_display_disable(dssdev);\r\n}\r\nstatic int sharp_ls_panel_enable(struct omap_dss_device *dssdev)\r\n{\r\nint r;\r\nr = sharp_ls_power_on(dssdev);\r\ndssdev->state = OMAP_DSS_DISPLAY_ACTIVE;\r\nreturn r;\r\n}\r\nstatic void sharp_ls_panel_disable(struct omap_dss_device *dssdev)\r\n{\r\nsharp_ls_power_off(dssdev);\r\ndssdev->state = OMAP_DSS_DISPLAY_DISABLED;\r\n}\r\nstatic int __init sharp_ls_panel_drv_init(void)\r\n{\r\nreturn omap_dss_register_driver(&sharp_ls_driver);\r\n}\r\nstatic void __exit sharp_ls_panel_drv_exit(void)\r\n{\r\nomap_dss_unregister_driver(&sharp_ls_driver);\r\n}

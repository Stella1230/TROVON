static int __init ppc460ex_device_probe(void)\r\n{\r\nof_platform_bus_probe(NULL, ppc460ex_of_bus, NULL);\r\nreturn 0;\r\n}\r\nstatic int __init ppc460ex_probe(void)\r\n{\r\nunsigned long root = of_get_flat_dt_root();\r\nif (of_flat_dt_is_compatible(root, "amcc,canyonlands")) {\r\npci_set_flags(PCI_REASSIGN_ALL_RSRC);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init ppc460ex_canyonlands_fixup(void)\r\n{\r\nu8 __iomem *bcsr ;\r\nvoid __iomem *vaddr;\r\nstruct device_node *np;\r\nint ret = 0;\r\nnp = of_find_compatible_node(NULL, NULL, "amcc,ppc460ex-bcsr");\r\nif (!np) {\r\nprintk(KERN_ERR "failed did not find amcc, ppc460ex bcsr node\n");\r\nreturn -ENODEV;\r\n}\r\nbcsr = of_iomap(np, 0);\r\nof_node_put(np);\r\nif (!bcsr) {\r\nprintk(KERN_CRIT "Could not remap bcsr\n");\r\nret = -ENODEV;\r\ngoto err_bcsr;\r\n}\r\nnp = of_find_compatible_node(NULL, NULL, "ibm,ppc4xx-gpio");\r\nif (!np) {\r\nprintk(KERN_ERR "failed did not find ibm,ppc4xx-gpio node\n");\r\nreturn -ENODEV;\r\n}\r\nvaddr = of_iomap(np, 0);\r\nof_node_put(np);\r\nif (!vaddr) {\r\nprintk(KERN_CRIT "Could not get gpio node address\n");\r\nret = -ENODEV;\r\ngoto err_gpio;\r\n}\r\nsetbits8(&bcsr[7], BCSR_USB_EN);\r\nmsleep(100);\r\nclrbits8(&bcsr[7], BCSR_USB_EN);\r\nsetbits32((vaddr + GPIO0_OSRH), 0x42000000);\r\nsetbits32((vaddr + GPIO0_TSRH), 0x42000000);\r\nerr_gpio:\r\niounmap(vaddr);\r\nerr_bcsr:\r\niounmap(bcsr);\r\nreturn ret;\r\n}

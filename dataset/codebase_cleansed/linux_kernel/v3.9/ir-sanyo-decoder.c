static int ir_sanyo_decode(struct rc_dev *dev, struct ir_raw_event ev)\r\n{\r\nstruct sanyo_dec *data = &dev->raw->sanyo;\r\nu32 scancode;\r\nu8 address, command, not_command;\r\nif (!(dev->raw->enabled_protocols & RC_BIT_SANYO))\r\nreturn 0;\r\nif (!is_timing_event(ev)) {\r\nif (ev.reset) {\r\nIR_dprintk(1, "SANYO event reset received. reset to state 0\n");\r\ndata->state = STATE_INACTIVE;\r\n}\r\nreturn 0;\r\n}\r\nIR_dprintk(2, "SANYO decode started at state %d (%uus %s)\n",\r\ndata->state, TO_US(ev.duration), TO_STR(ev.pulse));\r\nswitch (data->state) {\r\ncase STATE_INACTIVE:\r\nif (!ev.pulse)\r\nbreak;\r\nif (eq_margin(ev.duration, SANYO_HEADER_PULSE, SANYO_UNIT / 2)) {\r\ndata->count = 0;\r\ndata->state = STATE_HEADER_SPACE;\r\nreturn 0;\r\n}\r\nbreak;\r\ncase STATE_HEADER_SPACE:\r\nif (ev.pulse)\r\nbreak;\r\nif (eq_margin(ev.duration, SANYO_HEADER_SPACE, SANYO_UNIT / 2)) {\r\ndata->state = STATE_BIT_PULSE;\r\nreturn 0;\r\n}\r\nbreak;\r\ncase STATE_BIT_PULSE:\r\nif (!ev.pulse)\r\nbreak;\r\nif (!eq_margin(ev.duration, SANYO_BIT_PULSE, SANYO_UNIT / 2))\r\nbreak;\r\ndata->state = STATE_BIT_SPACE;\r\nreturn 0;\r\ncase STATE_BIT_SPACE:\r\nif (ev.pulse)\r\nbreak;\r\nif (!data->count && geq_margin(ev.duration, SANYO_REPEAT_SPACE, SANYO_UNIT / 2)) {\r\nif (!dev->keypressed) {\r\nIR_dprintk(1, "SANYO discarding last key repeat: event after key up\n");\r\n} else {\r\nrc_repeat(dev);\r\nIR_dprintk(1, "SANYO repeat last key\n");\r\ndata->state = STATE_INACTIVE;\r\n}\r\nreturn 0;\r\n}\r\ndata->bits <<= 1;\r\nif (eq_margin(ev.duration, SANYO_BIT_1_SPACE, SANYO_UNIT / 2))\r\ndata->bits |= 1;\r\nelse if (!eq_margin(ev.duration, SANYO_BIT_0_SPACE, SANYO_UNIT / 2))\r\nbreak;\r\ndata->count++;\r\nif (data->count == SANYO_NBITS)\r\ndata->state = STATE_TRAILER_PULSE;\r\nelse\r\ndata->state = STATE_BIT_PULSE;\r\nreturn 0;\r\ncase STATE_TRAILER_PULSE:\r\nif (!ev.pulse)\r\nbreak;\r\nif (!eq_margin(ev.duration, SANYO_TRAILER_PULSE, SANYO_UNIT / 2))\r\nbreak;\r\ndata->state = STATE_TRAILER_SPACE;\r\nreturn 0;\r\ncase STATE_TRAILER_SPACE:\r\nif (ev.pulse)\r\nbreak;\r\nif (!geq_margin(ev.duration, SANYO_TRAILER_SPACE, SANYO_UNIT / 2))\r\nbreak;\r\naddress = bitrev16((data->bits >> 29) & 0x1fff) >> 3;\r\ncommand = bitrev8((data->bits >> 8) & 0xff);\r\nnot_command = bitrev8((data->bits >> 0) & 0xff);\r\nif ((command ^ not_command) != 0xff) {\r\nIR_dprintk(1, "SANYO checksum error: received 0x%08Lx\n",\r\ndata->bits);\r\ndata->state = STATE_INACTIVE;\r\nreturn 0;\r\n}\r\nscancode = address << 8 | command;\r\nIR_dprintk(1, "SANYO scancode: 0x%06x\n", scancode);\r\nrc_keydown(dev, scancode, 0);\r\ndata->state = STATE_INACTIVE;\r\nreturn 0;\r\n}\r\nIR_dprintk(1, "SANYO decode failed at count %d state %d (%uus %s)\n",\r\ndata->count, data->state, TO_US(ev.duration), TO_STR(ev.pulse));\r\ndata->state = STATE_INACTIVE;\r\nreturn -EINVAL;\r\n}\r\nstatic int __init ir_sanyo_decode_init(void)\r\n{\r\nir_raw_handler_register(&sanyo_handler);\r\nprintk(KERN_INFO "IR SANYO protocol handler initialized\n");\r\nreturn 0;\r\n}\r\nstatic void __exit ir_sanyo_decode_exit(void)\r\n{\r\nir_raw_handler_unregister(&sanyo_handler);\r\n}

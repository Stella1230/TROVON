static unsigned _count_resources(struct resource *res)\r\n{\r\nint cnt = 0;\r\nwhile (res->start != res->end) {\r\ncnt++;\r\nres++;\r\n}\r\nreturn cnt;\r\n}\r\nstatic int ocp2scp_remove_devices(struct device *dev, void *c)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nplatform_device_unregister(pdev);\r\nreturn 0;\r\n}\r\nstatic int omap_ocp2scp_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nunsigned res_cnt, i;\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct platform_device *pdev_child;\r\nstruct omap_ocp2scp_platform_data *pdata = pdev->dev.platform_data;\r\nstruct omap_ocp2scp_dev *dev;\r\nif (np) {\r\nret = of_platform_populate(np, NULL, NULL, &pdev->dev);\r\nif (ret) {\r\ndev_err(&pdev->dev,\r\n"failed to add resources for ocp2scp child\n");\r\ngoto err0;\r\n}\r\n} else if (pdata) {\r\nfor (i = 0, dev = *pdata->devices; i < pdata->dev_cnt; i++,\r\ndev++) {\r\nres_cnt = _count_resources(dev->res);\r\npdev_child = platform_device_alloc(dev->drv_name,\r\nPLATFORM_DEVID_AUTO);\r\nif (!pdev_child) {\r\ndev_err(&pdev->dev,\r\n"failed to allocate mem for ocp2scp child\n");\r\ngoto err0;\r\n}\r\nret = platform_device_add_resources(pdev_child,\r\ndev->res, res_cnt);\r\nif (ret) {\r\ndev_err(&pdev->dev,\r\n"failed to add resources for ocp2scp child\n");\r\ngoto err1;\r\n}\r\npdev_child->dev.parent = &pdev->dev;\r\nret = platform_device_add(pdev_child);\r\nif (ret) {\r\ndev_err(&pdev->dev,\r\n"failed to register ocp2scp child device\n");\r\ngoto err1;\r\n}\r\n}\r\n} else {\r\ndev_err(&pdev->dev, "OCP2SCP initialized without plat data\n");\r\nreturn -EINVAL;\r\n}\r\npm_runtime_enable(&pdev->dev);\r\nreturn 0;\r\nerr1:\r\nplatform_device_put(pdev_child);\r\nerr0:\r\ndevice_for_each_child(&pdev->dev, NULL, ocp2scp_remove_devices);\r\nreturn ret;\r\n}\r\nstatic int omap_ocp2scp_remove(struct platform_device *pdev)\r\n{\r\npm_runtime_disable(&pdev->dev);\r\ndevice_for_each_child(&pdev->dev, NULL, ocp2scp_remove_devices);\r\nreturn 0;\r\n}

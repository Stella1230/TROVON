void ar9003_hw_rtt_enable(struct ath_hw *ah)\r\n{\r\nREG_WRITE(ah, AR_PHY_RTT_CTRL, 1);\r\n}\r\nvoid ar9003_hw_rtt_disable(struct ath_hw *ah)\r\n{\r\nREG_WRITE(ah, AR_PHY_RTT_CTRL, 0);\r\n}\r\nvoid ar9003_hw_rtt_set_mask(struct ath_hw *ah, u32 rtt_mask)\r\n{\r\nREG_RMW_FIELD(ah, AR_PHY_RTT_CTRL,\r\nAR_PHY_RTT_CTRL_RESTORE_MASK, rtt_mask);\r\n}\r\nbool ar9003_hw_rtt_force_restore(struct ath_hw *ah)\r\n{\r\nif (!ath9k_hw_wait(ah, AR_PHY_RTT_CTRL,\r\nAR_PHY_RTT_CTRL_FORCE_RADIO_RESTORE,\r\n0, RTT_RESTORE_TIMEOUT))\r\nreturn false;\r\nREG_RMW_FIELD(ah, AR_PHY_RTT_CTRL,\r\nAR_PHY_RTT_CTRL_FORCE_RADIO_RESTORE, 1);\r\nif (!ath9k_hw_wait(ah, AR_PHY_RTT_CTRL,\r\nAR_PHY_RTT_CTRL_FORCE_RADIO_RESTORE,\r\n0, RTT_RESTORE_TIMEOUT))\r\nreturn false;\r\nreturn true;\r\n}\r\nstatic void ar9003_hw_rtt_load_hist_entry(struct ath_hw *ah, u8 chain,\r\nu32 index, u32 data28)\r\n{\r\nu32 val;\r\nval = SM(data28, AR_PHY_RTT_SW_RTT_TABLE_DATA);\r\nREG_WRITE(ah, AR_PHY_RTT_TABLE_SW_INTF_1_B(chain), val);\r\nval = SM(0, AR_PHY_RTT_SW_RTT_TABLE_ACCESS) |\r\nSM(1, AR_PHY_RTT_SW_RTT_TABLE_WRITE) |\r\nSM(index, AR_PHY_RTT_SW_RTT_TABLE_ADDR);\r\nREG_WRITE(ah, AR_PHY_RTT_TABLE_SW_INTF_B(chain), val);\r\nudelay(1);\r\nval |= SM(1, AR_PHY_RTT_SW_RTT_TABLE_ACCESS);\r\nREG_WRITE(ah, AR_PHY_RTT_TABLE_SW_INTF_B(chain), val);\r\nudelay(1);\r\nif (!ath9k_hw_wait(ah, AR_PHY_RTT_TABLE_SW_INTF_B(chain),\r\nAR_PHY_RTT_SW_RTT_TABLE_ACCESS, 0,\r\nRTT_ACCESS_TIMEOUT))\r\nreturn;\r\nval &= ~SM(1, AR_PHY_RTT_SW_RTT_TABLE_WRITE);\r\nREG_WRITE(ah, AR_PHY_RTT_TABLE_SW_INTF_B(chain), val);\r\nudelay(1);\r\nath9k_hw_wait(ah, AR_PHY_RTT_TABLE_SW_INTF_B(chain),\r\nAR_PHY_RTT_SW_RTT_TABLE_ACCESS, 0,\r\nRTT_ACCESS_TIMEOUT);\r\n}\r\nvoid ar9003_hw_rtt_load_hist(struct ath_hw *ah)\r\n{\r\nint chain, i;\r\nfor (chain = 0; chain < AR9300_MAX_CHAINS; chain++) {\r\nif (!(ah->rxchainmask & (1 << chain)))\r\ncontinue;\r\nfor (i = 0; i < MAX_RTT_TABLE_ENTRY; i++) {\r\nar9003_hw_rtt_load_hist_entry(ah, chain, i,\r\nah->caldata->rtt_table[chain][i]);\r\nath_dbg(ath9k_hw_common(ah), CALIBRATE,\r\n"Load RTT value at idx %d, chain %d: 0x%x\n",\r\ni, chain, ah->caldata->rtt_table[chain][i]);\r\n}\r\n}\r\n}\r\nstatic int ar9003_hw_rtt_fill_hist_entry(struct ath_hw *ah, u8 chain, u32 index)\r\n{\r\nu32 val;\r\nval = SM(0, AR_PHY_RTT_SW_RTT_TABLE_ACCESS) |\r\nSM(0, AR_PHY_RTT_SW_RTT_TABLE_WRITE) |\r\nSM(index, AR_PHY_RTT_SW_RTT_TABLE_ADDR);\r\nREG_WRITE(ah, AR_PHY_RTT_TABLE_SW_INTF_B(chain), val);\r\nudelay(1);\r\nval |= SM(1, AR_PHY_RTT_SW_RTT_TABLE_ACCESS);\r\nREG_WRITE(ah, AR_PHY_RTT_TABLE_SW_INTF_B(chain), val);\r\nudelay(1);\r\nif (!ath9k_hw_wait(ah, AR_PHY_RTT_TABLE_SW_INTF_B(chain),\r\nAR_PHY_RTT_SW_RTT_TABLE_ACCESS, 0,\r\nRTT_ACCESS_TIMEOUT))\r\nreturn RTT_BAD_VALUE;\r\nval = MS(REG_READ(ah, AR_PHY_RTT_TABLE_SW_INTF_1_B(chain)),\r\nAR_PHY_RTT_SW_RTT_TABLE_DATA);\r\nreturn val;\r\n}\r\nvoid ar9003_hw_rtt_fill_hist(struct ath_hw *ah)\r\n{\r\nint chain, i;\r\nfor (chain = 0; chain < AR9300_MAX_CHAINS; chain++) {\r\nif (!(ah->rxchainmask & (1 << chain)))\r\ncontinue;\r\nfor (i = 0; i < MAX_RTT_TABLE_ENTRY; i++) {\r\nah->caldata->rtt_table[chain][i] =\r\nar9003_hw_rtt_fill_hist_entry(ah, chain, i);\r\nath_dbg(ath9k_hw_common(ah), CALIBRATE,\r\n"RTT value at idx %d, chain %d is: 0x%x\n",\r\ni, chain, ah->caldata->rtt_table[chain][i]);\r\n}\r\n}\r\nah->caldata->rtt_done = true;\r\n}\r\nvoid ar9003_hw_rtt_clear_hist(struct ath_hw *ah)\r\n{\r\nint chain, i;\r\nfor (chain = 0; chain < AR9300_MAX_CHAINS; chain++) {\r\nif (!(ah->rxchainmask & (1 << chain)))\r\ncontinue;\r\nfor (i = 0; i < MAX_RTT_TABLE_ENTRY; i++)\r\nar9003_hw_rtt_load_hist_entry(ah, chain, i, 0);\r\n}\r\nif (ah->caldata)\r\nah->caldata->rtt_done = false;\r\n}\r\nbool ar9003_hw_rtt_restore(struct ath_hw *ah, struct ath9k_channel *chan)\r\n{\r\nbool restore;\r\nif (!ah->caldata)\r\nreturn false;\r\nif (!ah->caldata->rtt_done)\r\nreturn false;\r\nar9003_hw_rtt_enable(ah);\r\nar9003_hw_rtt_set_mask(ah, 0x10);\r\nif (!ath9k_hw_rfbus_req(ah)) {\r\nath_err(ath9k_hw_common(ah), "Could not stop baseband\n");\r\nrestore = false;\r\ngoto fail;\r\n}\r\nar9003_hw_rtt_load_hist(ah);\r\nrestore = ar9003_hw_rtt_force_restore(ah);\r\nfail:\r\nath9k_hw_rfbus_done(ah);\r\nar9003_hw_rtt_disable(ah);\r\nreturn restore;\r\n}

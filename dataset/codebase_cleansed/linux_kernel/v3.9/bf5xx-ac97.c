void bf5xx_pcm_to_ac97(struct ac97_frame *dst, const __u16 *src,\r\nsize_t count, unsigned int chan_mask)\r\n{\r\nwhile (count--) {\r\ndst->ac97_tag = TAG_VALID;\r\nif (chan_mask & SP_FL) {\r\ndst->ac97_pcm_r = *src++;\r\ndst->ac97_tag |= TAG_PCM_RIGHT;\r\n}\r\nif (chan_mask & SP_FR) {\r\ndst->ac97_pcm_l = *src++;\r\ndst->ac97_tag |= TAG_PCM_LEFT;\r\n}\r\n#if defined(CONFIG_SND_BF5XX_MULTICHAN_SUPPORT)\r\nif (chan_mask & SP_SR) {\r\ndst->ac97_sl = *src++;\r\ndst->ac97_tag |= TAG_PCM_SL;\r\n}\r\nif (chan_mask & SP_SL) {\r\ndst->ac97_sr = *src++;\r\ndst->ac97_tag |= TAG_PCM_SR;\r\n}\r\nif (chan_mask & SP_LFE) {\r\ndst->ac97_lfe = *src++;\r\ndst->ac97_tag |= TAG_PCM_LFE;\r\n}\r\nif (chan_mask & SP_FC) {\r\ndst->ac97_center = *src++;\r\ndst->ac97_tag |= TAG_PCM_CENTER;\r\n}\r\n#endif\r\ndst++;\r\n}\r\n}\r\nvoid bf5xx_ac97_to_pcm(const struct ac97_frame *src, __u16 *dst,\r\nsize_t count)\r\n{\r\nwhile (count--) {\r\n*(dst++) = src->ac97_pcm_l;\r\n*(dst++) = src->ac97_pcm_r;\r\nsrc++;\r\n}\r\n}\r\nstatic unsigned int sport_tx_curr_frag(struct sport_device *sport)\r\n{\r\nreturn sport->tx_curr_frag = sport_curr_offset_tx(sport) /\r\nsport->tx_fragsize;\r\n}\r\nstatic void enqueue_cmd(struct snd_ac97 *ac97, __u16 addr, __u16 data)\r\n{\r\nstruct sport_device *sport = ac97_sport_handle;\r\nint *cmd_count = sport->private_data;\r\nint nextfrag = sport_tx_curr_frag(sport);\r\nstruct ac97_frame *nextwrite;\r\nsport_incfrag(sport, &nextfrag, 1);\r\nnextwrite = (struct ac97_frame *)(sport->tx_buf +\r\nnextfrag * sport->tx_fragsize);\r\npr_debug("sport->tx_buf:%p, nextfrag:0x%x nextwrite:%p, cmd_count:%d\n",\r\nsport->tx_buf, nextfrag, nextwrite, cmd_count[nextfrag]);\r\nnextwrite[cmd_count[nextfrag]].ac97_tag |= TAG_CMD;\r\nnextwrite[cmd_count[nextfrag]].ac97_addr = addr;\r\nnextwrite[cmd_count[nextfrag]].ac97_data = data;\r\n++cmd_count[nextfrag];\r\npr_debug("ac97_sport: Inserting %02x/%04x into fragment %d\n",\r\naddr >> 8, data, nextfrag);\r\n}\r\nstatic unsigned short bf5xx_ac97_read(struct snd_ac97 *ac97,\r\nunsigned short reg)\r\n{\r\nstruct sport_device *sport_handle = ac97_sport_handle;\r\nstruct ac97_frame out_frame[2], in_frame[2];\r\npr_debug("%s enter 0x%x\n", __func__, reg);\r\nif (sport_handle->tx_run || sport_handle->rx_run) {\r\npr_err("Could you send a mail to cliff.cai@analog.com "\r\n"to report this?\n");\r\nreturn -EFAULT;\r\n}\r\nmemset(&out_frame, 0, 2 * sizeof(struct ac97_frame));\r\nmemset(&in_frame, 0, 2 * sizeof(struct ac97_frame));\r\nout_frame[0].ac97_tag = TAG_VALID | TAG_CMD;\r\nout_frame[0].ac97_addr = ((reg << 8) | 0x8000);\r\nsport_send_and_recv(sport_handle, (unsigned char *)&out_frame,\r\n(unsigned char *)&in_frame,\r\n2 * sizeof(struct ac97_frame));\r\nreturn in_frame[1].ac97_data;\r\n}\r\nvoid bf5xx_ac97_write(struct snd_ac97 *ac97, unsigned short reg,\r\nunsigned short val)\r\n{\r\nstruct sport_device *sport_handle = ac97_sport_handle;\r\npr_debug("%s enter 0x%x:0x%04x\n", __func__, reg, val);\r\nif (sport_handle->tx_run) {\r\nenqueue_cmd(ac97, (reg << 8), val);\r\nenqueue_cmd(ac97, (reg << 8) | 0x8000, 0);\r\n} else {\r\nstruct ac97_frame frame;\r\nmemset(&frame, 0, sizeof(struct ac97_frame));\r\nframe.ac97_tag = TAG_VALID | TAG_CMD;\r\nframe.ac97_addr = (reg << 8);\r\nframe.ac97_data = val;\r\nsport_send_and_recv(sport_handle, (unsigned char *)&frame, \\r\nNULL, sizeof(struct ac97_frame));\r\n}\r\n}\r\nstatic void bf5xx_ac97_warm_reset(struct snd_ac97 *ac97)\r\n{\r\nstruct sport_device *sport_handle = ac97_sport_handle;\r\nu16 gpio = P_IDENT(sport_handle->pin_req[3]);\r\npr_debug("%s enter\n", __func__);\r\nperipheral_free_list(sport_handle->pin_req);\r\ngpio_request(gpio, "bf5xx-ac97");\r\ngpio_direction_output(gpio, 1);\r\nudelay(2);\r\ngpio_set_value(gpio, 0);\r\nudelay(1);\r\ngpio_free(gpio);\r\nperipheral_request_list(sport_handle->pin_req, "soc-audio");\r\n}\r\nstatic void bf5xx_ac97_cold_reset(struct snd_ac97 *ac97)\r\n{\r\n#ifdef CONFIG_SND_BF5XX_HAVE_COLD_RESET\r\npr_debug("%s enter\n", __func__);\r\ngpio_set_value(CONFIG_SND_BF5XX_RESET_GPIO_NUM, 0);\r\nmdelay(1);\r\ngpio_set_value(CONFIG_SND_BF5XX_RESET_GPIO_NUM, 1);\r\nmdelay(1);\r\n#else\r\npr_info("%s: Not implemented\n", __func__);\r\n#endif\r\n}\r\nstatic int bf5xx_ac97_suspend(struct snd_soc_dai *dai)\r\n{\r\nstruct sport_device *sport = snd_soc_dai_get_drvdata(dai);\r\npr_debug("%s : sport %d\n", __func__, dai->id);\r\nif (!dai->active)\r\nreturn 0;\r\nif (dai->capture_active)\r\nsport_rx_stop(sport);\r\nif (dai->playback_active)\r\nsport_tx_stop(sport);\r\nreturn 0;\r\n}\r\nstatic int bf5xx_ac97_resume(struct snd_soc_dai *dai)\r\n{\r\nint ret;\r\nstruct sport_device *sport = snd_soc_dai_get_drvdata(dai);\r\npr_debug("%s : sport %d\n", __func__, dai->id);\r\nif (!dai->active)\r\nreturn 0;\r\n#if defined(CONFIG_SND_BF5XX_MULTICHAN_SUPPORT)\r\nret = sport_set_multichannel(sport, 16, 0x3FF, 1);\r\n#else\r\nret = sport_set_multichannel(sport, 16, 0x1F, 1);\r\n#endif\r\nif (ret) {\r\npr_err("SPORT is busy!\n");\r\nreturn -EBUSY;\r\n}\r\nret = sport_config_rx(sport, IRFS, 0xF, 0, (16*16-1));\r\nif (ret) {\r\npr_err("SPORT is busy!\n");\r\nreturn -EBUSY;\r\n}\r\nret = sport_config_tx(sport, ITFS, 0xF, 0, (16*16-1));\r\nif (ret) {\r\npr_err("SPORT is busy!\n");\r\nreturn -EBUSY;\r\n}\r\nreturn 0;\r\n}\r\nstatic int asoc_bfin_ac97_probe(struct platform_device *pdev)\r\n{\r\nstruct sport_device *sport_handle;\r\nint ret;\r\n#ifdef CONFIG_SND_BF5XX_HAVE_COLD_RESET\r\nif (gpio_request(CONFIG_SND_BF5XX_RESET_GPIO_NUM, "SND_AD198x RESET")) {\r\npr_err("Failed to request GPIO_%d for reset\n",\r\nCONFIG_SND_BF5XX_RESET_GPIO_NUM);\r\nret = -1;\r\ngoto gpio_err;\r\n}\r\ngpio_direction_output(CONFIG_SND_BF5XX_RESET_GPIO_NUM, 1);\r\n#endif\r\nsport_handle = sport_init(pdev, 2, sizeof(struct ac97_frame),\r\nPAGE_SIZE);\r\nif (!sport_handle) {\r\nret = -ENODEV;\r\ngoto sport_err;\r\n}\r\n#if defined(CONFIG_SND_BF5XX_MULTICHAN_SUPPORT)\r\nret = sport_set_multichannel(sport_handle, 16, 0x3FF, 1);\r\n#else\r\nret = sport_set_multichannel(sport_handle, 16, 0x1F, 1);\r\n#endif\r\nif (ret) {\r\npr_err("SPORT is busy!\n");\r\nret = -EBUSY;\r\ngoto sport_config_err;\r\n}\r\nret = sport_config_rx(sport_handle, IRFS, 0xF, 0, (16*16-1));\r\nif (ret) {\r\npr_err("SPORT is busy!\n");\r\nret = -EBUSY;\r\ngoto sport_config_err;\r\n}\r\nret = sport_config_tx(sport_handle, ITFS, 0xF, 0, (16*16-1));\r\nif (ret) {\r\npr_err("SPORT is busy!\n");\r\nret = -EBUSY;\r\ngoto sport_config_err;\r\n}\r\nret = snd_soc_register_dai(&pdev->dev, &bfin_ac97_dai);\r\nif (ret) {\r\npr_err("Failed to register DAI: %d\n", ret);\r\ngoto sport_config_err;\r\n}\r\nac97_sport_handle = sport_handle;\r\nreturn 0;\r\nsport_config_err:\r\nsport_done(sport_handle);\r\nsport_err:\r\n#ifdef CONFIG_SND_BF5XX_HAVE_COLD_RESET\r\ngpio_free(CONFIG_SND_BF5XX_RESET_GPIO_NUM);\r\ngpio_err:\r\n#endif\r\nreturn ret;\r\n}\r\nstatic int asoc_bfin_ac97_remove(struct platform_device *pdev)\r\n{\r\nstruct sport_device *sport_handle = platform_get_drvdata(pdev);\r\nsnd_soc_unregister_dai(&pdev->dev);\r\nsport_done(sport_handle);\r\n#ifdef CONFIG_SND_BF5XX_HAVE_COLD_RESET\r\ngpio_free(CONFIG_SND_BF5XX_RESET_GPIO_NUM);\r\n#endif\r\nreturn 0;\r\n}

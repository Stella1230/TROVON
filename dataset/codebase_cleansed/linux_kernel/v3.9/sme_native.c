int\r\nuf_sme_init(unifi_priv_t *priv)\r\n{\r\nsema_init(&priv->mlme_blocking_mutex, 1);\r\n#ifdef CSR_SUPPORT_WEXT\r\n{\r\nint r = uf_init_wext_interface(priv);\r\nif (r != 0) {\r\nreturn r;\r\n}\r\n}\r\n#endif\r\nreturn 0;\r\n}\r\nvoid\r\nuf_sme_deinit(unifi_priv_t *priv)\r\n{\r\nflush_workqueue(priv->unifi_workqueue);\r\n#ifdef CSR_SUPPORT_WEXT\r\nuf_deinit_wext_interface(priv);\r\n#endif\r\n}\r\nint sme_mgt_wifi_on(unifi_priv_t *priv)\r\n{\r\nint r,i;\r\ns32 csrResult;\r\nif (priv == NULL) {\r\nreturn -EINVAL;\r\n}\r\nfor (i=0; i<CSR_WIFI_NUM_INTERFACES; i++) {\r\npriv->interfacePriv[i]->interfaceMode = 0;\r\n}\r\npriv->interfacePriv[0]->interfaceMode = CSR_WIFI_ROUTER_CTRL_MODE_STA;\r\nr = uf_request_firmware_files(priv, UNIFI_FW_STA);\r\nif (r) {\r\nunifi_error(priv, "sme_mgt_wifi_on: Failed to get f/w\n");\r\nreturn r;\r\n}\r\npriv->bh_thread.block_thread = 1;\r\nCsrSdioClaim(priv->sdio);\r\ncsrResult = CsrSdioPowerOn(priv->sdio);\r\nCsrSdioRelease(priv->sdio);\r\nif(csrResult != CSR_RESULT_SUCCESS && csrResult != CSR_SDIO_RESULT_NOT_RESET) {\r\nreturn -EIO;\r\n}\r\nif (csrResult == CSR_RESULT_SUCCESS) {\r\nr = uf_init_hw(priv);\r\nif (r) {\r\nreturn r;\r\n}\r\n}\r\npriv->bh_thread.block_thread = 0;\r\ncsrResult = unifi_configure_low_power_mode(priv->card,\r\nUNIFI_LOW_POWER_DISABLED,\r\nUNIFI_PERIODIC_WAKE_HOST_DISABLED);\r\nif (csrResult != CSR_RESULT_SUCCESS) {\r\nunifi_warning(priv,\r\n"sme_mgt_wifi_on: unifi_configure_low_power_mode() returned an error\n");\r\n}\r\nCsrSdioClaim(priv->sdio);\r\nr = uf_init_bh(priv);\r\nif (r) {\r\nCsrSdioPowerOff(priv->sdio);\r\nCsrSdioRelease(priv->sdio);\r\nreturn r;\r\n}\r\nCsrSdioRelease(priv->sdio);\r\npriv->init_progress = UNIFI_INIT_FW_DOWNLOADED;\r\nreturn 0;\r\n}\r\nint\r\nsme_sys_suspend(unifi_priv_t *priv)\r\n{\r\nconst int interfaceNum = 0;\r\nCsrResult csrResult;\r\nuf_abort_mlme(priv);\r\npriv->io_aborted = 0;\r\nunifi_reset_state(priv, priv->netdev[interfaceNum]->dev_addr, 0);\r\nnetif_carrier_off(priv->netdev[interfaceNum]);\r\nCsrSdioClaim(priv->sdio);\r\ncsrResult = unifi_force_low_power_mode(priv->card);\r\nCsrSdioRelease(priv->sdio);\r\nreturn 0;\r\n}\r\nint\r\nsme_sys_resume(unifi_priv_t *priv)\r\n{\r\n#ifdef CSR_SUPPORT_WEXT\r\nmemset(priv->wext_conf.current_ssid, 0, UNIFI_MAX_SSID_LEN);\r\nmemset((void*)priv->wext_conf.current_bssid, 0, ETH_ALEN);\r\npriv->wext_conf.capability = 0;\r\nwext_send_disassoc_event(priv);\r\n#endif\r\nreturn 0;\r\n}\r\nvoid\r\nsme_native_log_event(ul_client_t *pcli,\r\nconst u8 *sig_packed, int sig_len,\r\nconst bulk_data_param_t *bulkdata,\r\nint dir)\r\n{\r\nunifi_priv_t *priv;\r\nudi_log_t *logptr;\r\nu8 *p;\r\nint i, r;\r\nint signal_len;\r\nint total_len;\r\nudi_msg_t *msgptr;\r\nCSR_SIGNAL signal;\r\nul_client_t *client = pcli;\r\nif (client == NULL) {\r\nunifi_error(NULL, "sme_native_log_event: client has exited\n");\r\nreturn;\r\n}\r\npriv = uf_find_instance(client->instance);\r\nif (!priv) {\r\nunifi_error(priv, "invalid priv\n");\r\nreturn;\r\n}\r\nif ((sig_packed == NULL) || (sig_len <= 0)) {\r\nreturn;\r\n}\r\nr = read_unpack_signal(sig_packed, &signal);\r\nif (r == 0) {\r\nsignal_len = SigGetSize(&signal);\r\n} else {\r\nu16 receiver_id = CSR_GET_UINT16_FROM_LITTLE_ENDIAN((sig_packed) + sizeof(u16)) & 0xFF00;\r\nif (sig_len == 1) {\r\nunifi_trace(priv, UDBG5,\r\n"Control indication (0x%x) for native SME.\n",\r\n*sig_packed);\r\n*(u8*)&signal = *sig_packed;\r\nsignal_len = sig_len;\r\n} else if (receiver_id == 0) {\r\nunifi_trace(priv, UDBG5,\r\n"Signal 0x%.4X with ReceiverId 0 for native SME.\n",\r\nCSR_GET_UINT16_FROM_LITTLE_ENDIAN(sig_packed));\r\n*(u8*)&signal = *sig_packed;\r\nsignal_len = sig_len;\r\n} else {\r\nunifi_error(priv,\r\n"sme_native_log_event - Received unknown signal 0x%.4X.\n",\r\nCSR_GET_UINT16_FROM_LITTLE_ENDIAN(sig_packed));\r\nreturn;\r\n}\r\n}\r\nunifi_trace(priv, UDBG3, "sme_native_log_event: signal 0x%.4X for %d\n",\r\nsignal.SignalPrimitiveHeader.SignalId,\r\nclient->client_id);\r\ntotal_len = signal_len;\r\nfor (i = 0; i < UNIFI_MAX_DATA_REFERENCES; i++) {\r\ntotal_len += bulkdata->d[i].data_length;\r\n}\r\nlogptr = (udi_log_t *)kmalloc(sizeof(udi_log_t) + total_len, GFP_KERNEL);\r\nif (logptr == NULL) {\r\nunifi_error(priv,\r\n"Failed to allocate %d bytes for a UDI log record\n",\r\nsizeof(udi_log_t) + total_len);\r\nreturn;\r\n}\r\nINIT_LIST_HEAD(&logptr->q);\r\nmsgptr = &logptr->msg;\r\nmsgptr->length = sizeof(udi_msg_t) + total_len;\r\nmsgptr->timestamp = jiffies_to_msecs(jiffies);\r\nmsgptr->direction = dir;\r\nmsgptr->signal_length = signal_len;\r\np = (u8 *)(msgptr + 1);\r\nmemcpy(p, &signal, signal_len);\r\np += signal_len;\r\nfor (i = 0; i < UNIFI_MAX_DATA_REFERENCES; i++) {\r\nint len = bulkdata->d[i].data_length;\r\nif (len > 0) {\r\nif (bulkdata->d[i].os_data_ptr) {\r\nmemcpy(p, bulkdata->d[i].os_data_ptr, len);\r\n} else {\r\nmemset(p, 0, len);\r\n}\r\np += len;\r\n}\r\n}\r\ndown(&client->udi_sem);\r\nlist_add_tail(&logptr->q, &client->udi_log);\r\nup(&client->udi_sem);\r\nwake_up_interruptible(&client->udi_wq);\r\n}\r\nvoid\r\nunifi_ta_indicate_protocol(void *ospriv,\r\nCsrWifiRouterCtrlTrafficPacketType packet_type,\r\nCsrWifiRouterCtrlProtocolDirection direction,\r\nconst CsrWifiMacAddress *src_addr)\r\n{\r\n}\r\nvoid\r\nunifi_ta_indicate_sampling(void *ospriv, CsrWifiRouterCtrlTrafficStats *stats)\r\n{\r\n}\r\nvoid\r\nunifi_ta_indicate_l4stats(void *ospriv,\r\nu32 rxTcpThroughput,\r\nu32 txTcpThroughput,\r\nu32 rxUdpThroughput,\r\nu32 txUdpThroughput)\r\n{\r\n}\r\nvoid\r\nuf_native_process_udi_signal(ul_client_t *pcli,\r\nconst u8 *packed_signal, int packed_signal_len,\r\nconst bulk_data_param_t *bulkdata, int dir)\r\n{\r\n}\r\nvoid\r\nsme_native_mlme_event_handler(ul_client_t *pcli,\r\nconst u8 *sig_packed, int sig_len,\r\nconst bulk_data_param_t *bulkdata,\r\nint dir)\r\n{\r\nCSR_SIGNAL signal;\r\nint signal_len;\r\nunifi_priv_t *priv = uf_find_instance(pcli->instance);\r\nint id, r;\r\nif ((sig_packed == NULL) || (sig_len <= 0)) {\r\nreturn;\r\n}\r\nr = read_unpack_signal(sig_packed, &signal);\r\nif (r == 0) {\r\nsignal_len = SigGetSize(&signal);\r\n} else {\r\nunifi_error(priv,\r\n"sme_native_mlme_event_handler - Received unknown signal 0x%.4X.\n",\r\nCSR_GET_UINT16_FROM_LITTLE_ENDIAN(sig_packed));\r\nreturn;\r\n}\r\nid = signal.SignalPrimitiveHeader.SignalId;\r\nunifi_trace(priv, UDBG4, "wext - Process signal 0x%.4X\n", id);\r\nswitch (id) {\r\ncase CSR_MA_PACKET_CONFIRM_ID:\r\ncase CSR_MLME_RESET_CONFIRM_ID:\r\ncase CSR_MLME_GET_CONFIRM_ID:\r\ncase CSR_MLME_SET_CONFIRM_ID:\r\ncase CSR_MLME_GET_NEXT_CONFIRM_ID:\r\ncase CSR_MLME_POWERMGT_CONFIRM_ID:\r\ncase CSR_MLME_SCAN_CONFIRM_ID:\r\ncase CSR_MLME_HL_SYNC_CONFIRM_ID:\r\ncase CSR_MLME_MEASURE_CONFIRM_ID:\r\ncase CSR_MLME_SETKEYS_CONFIRM_ID:\r\ncase CSR_MLME_DELETEKEYS_CONFIRM_ID:\r\ncase CSR_MLME_HL_SYNC_CANCEL_CONFIRM_ID:\r\ncase CSR_MLME_ADD_PERIODIC_CONFIRM_ID:\r\ncase CSR_MLME_DEL_PERIODIC_CONFIRM_ID:\r\ncase CSR_MLME_ADD_AUTONOMOUS_SCAN_CONFIRM_ID:\r\ncase CSR_MLME_DEL_AUTONOMOUS_SCAN_CONFIRM_ID:\r\ncase CSR_MLME_SET_PACKET_FILTER_CONFIRM_ID:\r\ncase CSR_MLME_STOP_MEASURE_CONFIRM_ID:\r\ncase CSR_MLME_PAUSE_AUTONOMOUS_SCAN_CONFIRM_ID:\r\ncase CSR_MLME_ADD_TRIGGERED_GET_CONFIRM_ID:\r\ncase CSR_MLME_DEL_TRIGGERED_GET_CONFIRM_ID:\r\ncase CSR_MLME_ADD_BLACKOUT_CONFIRM_ID:\r\ncase CSR_MLME_DEL_BLACKOUT_CONFIRM_ID:\r\ncase CSR_MLME_ADD_RX_TRIGGER_CONFIRM_ID:\r\ncase CSR_MLME_DEL_RX_TRIGGER_CONFIRM_ID:\r\ncase CSR_MLME_CONNECT_STATUS_CONFIRM_ID:\r\ncase CSR_MLME_MODIFY_BSS_PARAMETER_CONFIRM_ID:\r\ncase CSR_MLME_ADD_TEMPLATE_CONFIRM_ID:\r\ncase CSR_MLME_CONFIG_QUEUE_CONFIRM_ID:\r\ncase CSR_MLME_ADD_TSPEC_CONFIRM_ID:\r\ncase CSR_MLME_DEL_TSPEC_CONFIRM_ID:\r\ncase CSR_MLME_START_AGGREGATION_CONFIRM_ID:\r\ncase CSR_MLME_STOP_AGGREGATION_CONFIRM_ID:\r\ncase CSR_MLME_SM_START_CONFIRM_ID:\r\ncase CSR_MLME_LEAVE_CONFIRM_ID:\r\ncase CSR_MLME_SET_TIM_CONFIRM_ID:\r\ncase CSR_MLME_GET_KEY_SEQUENCE_CONFIRM_ID:\r\ncase CSR_MLME_SET_CHANNEL_CONFIRM_ID:\r\ncase CSR_MLME_ADD_MULTICAST_ADDRESS_CONFIRM_ID:\r\ncase CSR_DEBUG_GENERIC_CONFIRM_ID:\r\nunifi_mlme_copy_reply_and_wakeup_client(pcli, &signal, signal_len, bulkdata);\r\nbreak;\r\ncase CSR_MLME_CONNECTED_INDICATION_ID:\r\nunifi_info(priv, "CSR_MLME_CONNECTED_INDICATION_ID ignored\n");\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nint\r\nunifi_reset_state(unifi_priv_t *priv, unsigned char *macaddr,\r\nunsigned char set_default_mib)\r\n{\r\nint r = 0;\r\n#ifdef CSR_SUPPORT_WEXT\r\npriv->wext_conf.flag_associated = 0;\r\n#endif\r\nreturn r;\r\n}

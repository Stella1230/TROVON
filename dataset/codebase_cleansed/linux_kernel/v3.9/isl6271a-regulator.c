static int isl6271a_get_voltage_sel(struct regulator_dev *dev)\r\n{\r\nstruct isl_pmic *pmic = rdev_get_drvdata(dev);\r\nint idx;\r\nmutex_lock(&pmic->mtx);\r\nidx = i2c_smbus_read_byte(pmic->client);\r\nif (idx < 0)\r\ndev_err(&pmic->client->dev, "Error getting voltage\n");\r\nmutex_unlock(&pmic->mtx);\r\nreturn idx;\r\n}\r\nstatic int isl6271a_set_voltage_sel(struct regulator_dev *dev,\r\nunsigned selector)\r\n{\r\nstruct isl_pmic *pmic = rdev_get_drvdata(dev);\r\nint err;\r\nmutex_lock(&pmic->mtx);\r\nerr = i2c_smbus_write_byte(pmic->client, selector);\r\nif (err < 0)\r\ndev_err(&pmic->client->dev, "Error setting voltage\n");\r\nmutex_unlock(&pmic->mtx);\r\nreturn err;\r\n}\r\nstatic int isl6271a_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct regulator_config config = { };\r\nstruct regulator_init_data *init_data = i2c->dev.platform_data;\r\nstruct isl_pmic *pmic;\r\nint err, i;\r\nif (!i2c_check_functionality(i2c->adapter, I2C_FUNC_SMBUS_BYTE_DATA))\r\nreturn -EIO;\r\npmic = devm_kzalloc(&i2c->dev, sizeof(struct isl_pmic), GFP_KERNEL);\r\nif (!pmic)\r\nreturn -ENOMEM;\r\npmic->client = i2c;\r\nmutex_init(&pmic->mtx);\r\nfor (i = 0; i < 3; i++) {\r\nconfig.dev = &i2c->dev;\r\nif (i == 0)\r\nconfig.init_data = init_data;\r\nelse\r\nconfig.init_data = 0;\r\nconfig.driver_data = pmic;\r\npmic->rdev[i] = regulator_register(&isl_rd[i], &config);\r\nif (IS_ERR(pmic->rdev[i])) {\r\ndev_err(&i2c->dev, "failed to register %s\n", id->name);\r\nerr = PTR_ERR(pmic->rdev[i]);\r\ngoto error;\r\n}\r\n}\r\ni2c_set_clientdata(i2c, pmic);\r\nreturn 0;\r\nerror:\r\nwhile (--i >= 0)\r\nregulator_unregister(pmic->rdev[i]);\r\nreturn err;\r\n}\r\nstatic int isl6271a_remove(struct i2c_client *i2c)\r\n{\r\nstruct isl_pmic *pmic = i2c_get_clientdata(i2c);\r\nint i;\r\nfor (i = 0; i < 3; i++)\r\nregulator_unregister(pmic->rdev[i]);\r\nreturn 0;\r\n}\r\nstatic int __init isl6271a_init(void)\r\n{\r\nreturn i2c_add_driver(&isl6271a_i2c_driver);\r\n}\r\nstatic void __exit isl6271a_cleanup(void)\r\n{\r\ni2c_del_driver(&isl6271a_i2c_driver);\r\n}

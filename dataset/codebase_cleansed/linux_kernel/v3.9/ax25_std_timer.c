void ax25_std_heartbeat_expiry(ax25_cb *ax25)\r\n{\r\nstruct sock *sk = ax25->sk;\r\nif (sk)\r\nbh_lock_sock(sk);\r\nswitch (ax25->state) {\r\ncase AX25_STATE_0:\r\nif (!sk || sock_flag(sk, SOCK_DESTROY) ||\r\n(sk->sk_state == TCP_LISTEN &&\r\nsock_flag(sk, SOCK_DEAD))) {\r\nif (sk) {\r\nsock_hold(sk);\r\nax25_destroy_socket(ax25);\r\nbh_unlock_sock(sk);\r\nsock_put(sk);\r\n} else\r\nax25_destroy_socket(ax25);\r\nreturn;\r\n}\r\nbreak;\r\ncase AX25_STATE_3:\r\ncase AX25_STATE_4:\r\nif (sk != NULL) {\r\nif (atomic_read(&sk->sk_rmem_alloc) <\r\n(sk->sk_rcvbuf >> 1) &&\r\n(ax25->condition & AX25_COND_OWN_RX_BUSY)) {\r\nax25->condition &= ~AX25_COND_OWN_RX_BUSY;\r\nax25->condition &= ~AX25_COND_ACK_PENDING;\r\nax25_send_control(ax25, AX25_RR, AX25_POLLOFF, AX25_RESPONSE);\r\nbreak;\r\n}\r\n}\r\n}\r\nif (sk)\r\nbh_unlock_sock(sk);\r\nax25_start_heartbeat(ax25);\r\n}\r\nvoid ax25_std_t2timer_expiry(ax25_cb *ax25)\r\n{\r\nif (ax25->condition & AX25_COND_ACK_PENDING) {\r\nax25->condition &= ~AX25_COND_ACK_PENDING;\r\nax25_std_timeout_response(ax25);\r\n}\r\n}\r\nvoid ax25_std_t3timer_expiry(ax25_cb *ax25)\r\n{\r\nax25->n2count = 0;\r\nax25_std_transmit_enquiry(ax25);\r\nax25->state = AX25_STATE_4;\r\n}\r\nvoid ax25_std_idletimer_expiry(ax25_cb *ax25)\r\n{\r\nax25_clear_queues(ax25);\r\nax25->n2count = 0;\r\nax25_send_control(ax25, AX25_DISC, AX25_POLLON, AX25_COMMAND);\r\nax25->state = AX25_STATE_2;\r\nax25_calculate_t1(ax25);\r\nax25_start_t1timer(ax25);\r\nax25_stop_t2timer(ax25);\r\nax25_stop_t3timer(ax25);\r\nif (ax25->sk != NULL) {\r\nbh_lock_sock(ax25->sk);\r\nax25->sk->sk_state = TCP_CLOSE;\r\nax25->sk->sk_err = 0;\r\nax25->sk->sk_shutdown |= SEND_SHUTDOWN;\r\nif (!sock_flag(ax25->sk, SOCK_DEAD)) {\r\nax25->sk->sk_state_change(ax25->sk);\r\nsock_set_flag(ax25->sk, SOCK_DEAD);\r\n}\r\nbh_unlock_sock(ax25->sk);\r\n}\r\n}\r\nvoid ax25_std_t1timer_expiry(ax25_cb *ax25)\r\n{\r\nswitch (ax25->state) {\r\ncase AX25_STATE_1:\r\nif (ax25->n2count == ax25->n2) {\r\nif (ax25->modulus == AX25_MODULUS) {\r\nax25_disconnect(ax25, ETIMEDOUT);\r\nreturn;\r\n} else {\r\nax25->modulus = AX25_MODULUS;\r\nax25->window = ax25->ax25_dev->values[AX25_VALUES_WINDOW];\r\nax25->n2count = 0;\r\nax25_send_control(ax25, AX25_SABM, AX25_POLLON, AX25_COMMAND);\r\n}\r\n} else {\r\nax25->n2count++;\r\nif (ax25->modulus == AX25_MODULUS)\r\nax25_send_control(ax25, AX25_SABM, AX25_POLLON, AX25_COMMAND);\r\nelse\r\nax25_send_control(ax25, AX25_SABME, AX25_POLLON, AX25_COMMAND);\r\n}\r\nbreak;\r\ncase AX25_STATE_2:\r\nif (ax25->n2count == ax25->n2) {\r\nax25_send_control(ax25, AX25_DISC, AX25_POLLON, AX25_COMMAND);\r\nax25_disconnect(ax25, ETIMEDOUT);\r\nreturn;\r\n} else {\r\nax25->n2count++;\r\nax25_send_control(ax25, AX25_DISC, AX25_POLLON, AX25_COMMAND);\r\n}\r\nbreak;\r\ncase AX25_STATE_3:\r\nax25->n2count = 1;\r\nax25_std_transmit_enquiry(ax25);\r\nax25->state = AX25_STATE_4;\r\nbreak;\r\ncase AX25_STATE_4:\r\nif (ax25->n2count == ax25->n2) {\r\nax25_send_control(ax25, AX25_DM, AX25_POLLON, AX25_RESPONSE);\r\nax25_disconnect(ax25, ETIMEDOUT);\r\nreturn;\r\n} else {\r\nax25->n2count++;\r\nax25_std_transmit_enquiry(ax25);\r\n}\r\nbreak;\r\n}\r\nax25_calculate_t1(ax25);\r\nax25_start_t1timer(ax25);\r\n}

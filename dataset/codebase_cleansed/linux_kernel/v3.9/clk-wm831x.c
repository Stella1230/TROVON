static int wm831x_xtal_is_enabled(struct clk_hw *hw)\r\n{\r\nstruct wm831x_clk *clkdata = container_of(hw, struct wm831x_clk,\r\nxtal_hw);\r\nreturn clkdata->xtal_ena;\r\n}\r\nstatic unsigned long wm831x_xtal_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct wm831x_clk *clkdata = container_of(hw, struct wm831x_clk,\r\nxtal_hw);\r\nif (clkdata->xtal_ena)\r\nreturn 32768;\r\nelse\r\nreturn 0;\r\n}\r\nstatic int wm831x_fll_is_enabled(struct clk_hw *hw)\r\n{\r\nstruct wm831x_clk *clkdata = container_of(hw, struct wm831x_clk,\r\nfll_hw);\r\nstruct wm831x *wm831x = clkdata->wm831x;\r\nint ret;\r\nret = wm831x_reg_read(wm831x, WM831X_FLL_CONTROL_1);\r\nif (ret < 0) {\r\ndev_err(wm831x->dev, "Unable to read FLL_CONTROL_1: %d\n",\r\nret);\r\nreturn true;\r\n}\r\nreturn (ret & WM831X_FLL_ENA) != 0;\r\n}\r\nstatic int wm831x_fll_prepare(struct clk_hw *hw)\r\n{\r\nstruct wm831x_clk *clkdata = container_of(hw, struct wm831x_clk,\r\nfll_hw);\r\nstruct wm831x *wm831x = clkdata->wm831x;\r\nint ret;\r\nret = wm831x_set_bits(wm831x, WM831X_FLL_CONTROL_2,\r\nWM831X_FLL_ENA, WM831X_FLL_ENA);\r\nif (ret != 0)\r\ndev_crit(wm831x->dev, "Failed to enable FLL: %d\n", ret);\r\nusleep_range(2000, 2000);\r\nreturn ret;\r\n}\r\nstatic void wm831x_fll_unprepare(struct clk_hw *hw)\r\n{\r\nstruct wm831x_clk *clkdata = container_of(hw, struct wm831x_clk,\r\nfll_hw);\r\nstruct wm831x *wm831x = clkdata->wm831x;\r\nint ret;\r\nret = wm831x_set_bits(wm831x, WM831X_FLL_CONTROL_2, WM831X_FLL_ENA, 0);\r\nif (ret != 0)\r\ndev_crit(wm831x->dev, "Failed to disaable FLL: %d\n", ret);\r\n}\r\nstatic unsigned long wm831x_fll_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct wm831x_clk *clkdata = container_of(hw, struct wm831x_clk,\r\nfll_hw);\r\nstruct wm831x *wm831x = clkdata->wm831x;\r\nint ret;\r\nret = wm831x_reg_read(wm831x, WM831X_CLOCK_CONTROL_2);\r\nif (ret < 0) {\r\ndev_err(wm831x->dev, "Unable to read CLOCK_CONTROL_2: %d\n",\r\nret);\r\nreturn 0;\r\n}\r\nif (ret & WM831X_FLL_AUTO)\r\nreturn wm831x_fll_auto_rates[ret & WM831X_FLL_AUTO_FREQ_MASK];\r\ndev_err(wm831x->dev, "FLL only supported in AUTO mode\n");\r\nreturn 0;\r\n}\r\nstatic long wm831x_fll_round_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long *unused)\r\n{\r\nint best = 0;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(wm831x_fll_auto_rates); i++)\r\nif (abs(wm831x_fll_auto_rates[i] - rate) <\r\nabs(wm831x_fll_auto_rates[best] - rate))\r\nbest = i;\r\nreturn wm831x_fll_auto_rates[best];\r\n}\r\nstatic int wm831x_fll_set_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nstruct wm831x_clk *clkdata = container_of(hw, struct wm831x_clk,\r\nfll_hw);\r\nstruct wm831x *wm831x = clkdata->wm831x;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(wm831x_fll_auto_rates); i++)\r\nif (wm831x_fll_auto_rates[i] == rate)\r\nbreak;\r\nif (i == ARRAY_SIZE(wm831x_fll_auto_rates))\r\nreturn -EINVAL;\r\nif (wm831x_fll_is_enabled(hw))\r\nreturn -EPERM;\r\nreturn wm831x_set_bits(wm831x, WM831X_CLOCK_CONTROL_2,\r\nWM831X_FLL_AUTO_FREQ_MASK, i);\r\n}\r\nstatic u8 wm831x_fll_get_parent(struct clk_hw *hw)\r\n{\r\nstruct wm831x_clk *clkdata = container_of(hw, struct wm831x_clk,\r\nfll_hw);\r\nstruct wm831x *wm831x = clkdata->wm831x;\r\nint ret;\r\nret = wm831x_reg_read(wm831x, WM831X_CLOCK_CONTROL_2);\r\nif (ret < 0) {\r\ndev_err(wm831x->dev, "Unable to read CLOCK_CONTROL_2: %d\n",\r\nret);\r\nreturn 0;\r\n}\r\nif (ret & WM831X_FLL_AUTO)\r\nreturn 0;\r\nret = wm831x_reg_read(wm831x, WM831X_FLL_CONTROL_5);\r\nif (ret < 0) {\r\ndev_err(wm831x->dev, "Unable to read FLL_CONTROL_5: %d\n",\r\nret);\r\nreturn 0;\r\n}\r\nswitch (ret & WM831X_FLL_CLK_SRC_MASK) {\r\ncase 0:\r\nreturn 0;\r\ncase 1:\r\nreturn 1;\r\ndefault:\r\ndev_err(wm831x->dev, "Unsupported FLL clock source %d\n",\r\nret & WM831X_FLL_CLK_SRC_MASK);\r\nreturn 0;\r\n}\r\n}\r\nstatic int wm831x_clkout_is_enabled(struct clk_hw *hw)\r\n{\r\nstruct wm831x_clk *clkdata = container_of(hw, struct wm831x_clk,\r\nclkout_hw);\r\nstruct wm831x *wm831x = clkdata->wm831x;\r\nint ret;\r\nret = wm831x_reg_read(wm831x, WM831X_CLOCK_CONTROL_1);\r\nif (ret < 0) {\r\ndev_err(wm831x->dev, "Unable to read CLOCK_CONTROL_1: %d\n",\r\nret);\r\nreturn true;\r\n}\r\nreturn (ret & WM831X_CLKOUT_ENA) != 0;\r\n}\r\nstatic int wm831x_clkout_prepare(struct clk_hw *hw)\r\n{\r\nstruct wm831x_clk *clkdata = container_of(hw, struct wm831x_clk,\r\nclkout_hw);\r\nstruct wm831x *wm831x = clkdata->wm831x;\r\nint ret;\r\nret = wm831x_reg_unlock(wm831x);\r\nif (ret != 0) {\r\ndev_crit(wm831x->dev, "Failed to lock registers: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = wm831x_set_bits(wm831x, WM831X_CLOCK_CONTROL_1,\r\nWM831X_CLKOUT_ENA, WM831X_CLKOUT_ENA);\r\nif (ret != 0)\r\ndev_crit(wm831x->dev, "Failed to enable CLKOUT: %d\n", ret);\r\nwm831x_reg_lock(wm831x);\r\nreturn ret;\r\n}\r\nstatic void wm831x_clkout_unprepare(struct clk_hw *hw)\r\n{\r\nstruct wm831x_clk *clkdata = container_of(hw, struct wm831x_clk,\r\nclkout_hw);\r\nstruct wm831x *wm831x = clkdata->wm831x;\r\nint ret;\r\nret = wm831x_reg_unlock(wm831x);\r\nif (ret != 0) {\r\ndev_crit(wm831x->dev, "Failed to lock registers: %d\n", ret);\r\nreturn;\r\n}\r\nret = wm831x_set_bits(wm831x, WM831X_CLOCK_CONTROL_1,\r\nWM831X_CLKOUT_ENA, 0);\r\nif (ret != 0)\r\ndev_crit(wm831x->dev, "Failed to disable CLKOUT: %d\n", ret);\r\nwm831x_reg_lock(wm831x);\r\n}\r\nstatic u8 wm831x_clkout_get_parent(struct clk_hw *hw)\r\n{\r\nstruct wm831x_clk *clkdata = container_of(hw, struct wm831x_clk,\r\nclkout_hw);\r\nstruct wm831x *wm831x = clkdata->wm831x;\r\nint ret;\r\nret = wm831x_reg_read(wm831x, WM831X_CLOCK_CONTROL_1);\r\nif (ret < 0) {\r\ndev_err(wm831x->dev, "Unable to read CLOCK_CONTROL_1: %d\n",\r\nret);\r\nreturn 0;\r\n}\r\nif (ret & WM831X_CLKOUT_SRC)\r\nreturn 0;\r\nelse\r\nreturn 1;\r\n}\r\nstatic int wm831x_clkout_set_parent(struct clk_hw *hw, u8 parent)\r\n{\r\nstruct wm831x_clk *clkdata = container_of(hw, struct wm831x_clk,\r\nclkout_hw);\r\nstruct wm831x *wm831x = clkdata->wm831x;\r\nreturn wm831x_set_bits(wm831x, WM831X_CLOCK_CONTROL_1,\r\nWM831X_CLKOUT_SRC,\r\nparent << WM831X_CLKOUT_SRC_SHIFT);\r\n}\r\nstatic int wm831x_clk_probe(struct platform_device *pdev)\r\n{\r\nstruct wm831x *wm831x = dev_get_drvdata(pdev->dev.parent);\r\nstruct wm831x_clk *clkdata;\r\nint ret;\r\nclkdata = devm_kzalloc(&pdev->dev, sizeof(*clkdata), GFP_KERNEL);\r\nif (!clkdata)\r\nreturn -ENOMEM;\r\nret = wm831x_reg_read(wm831x, WM831X_CLOCK_CONTROL_2);\r\nif (ret < 0) {\r\ndev_err(wm831x->dev, "Unable to read CLOCK_CONTROL_2: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nclkdata->xtal_ena = ret & WM831X_XTAL_ENA;\r\nclkdata->xtal_hw.init = &wm831x_xtal_init;\r\nclkdata->xtal = devm_clk_register(&pdev->dev, &clkdata->xtal_hw);\r\nif (IS_ERR(clkdata->xtal))\r\nreturn PTR_ERR(clkdata->xtal);\r\nclkdata->fll_hw.init = &wm831x_fll_init;\r\nclkdata->fll = devm_clk_register(&pdev->dev, &clkdata->fll_hw);\r\nif (IS_ERR(clkdata->fll))\r\nreturn PTR_ERR(clkdata->fll);\r\nclkdata->clkout_hw.init = &wm831x_clkout_init;\r\nclkdata->clkout = devm_clk_register(&pdev->dev, &clkdata->clkout_hw);\r\nif (IS_ERR(clkdata->clkout))\r\nreturn PTR_ERR(clkdata->clkout);\r\ndev_set_drvdata(&pdev->dev, clkdata);\r\nreturn 0;\r\n}\r\nstatic int wm831x_clk_remove(struct platform_device *pdev)\r\n{\r\nreturn 0;\r\n}

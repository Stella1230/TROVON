static u_int8_t read_eprom_byte(virt_addr_t base, u_int8_t offset)\r\n{\r\nu_int32_t val = 0;\r\nint i, j = 0;\r\nu_int8_t tempread = 0;\r\nval = NICSTAR_REG_READ(base, NICSTAR_REG_GENERAL_PURPOSE) & 0xFFFFFFF0;\r\nfor (i = 0; i < ARRAY_SIZE(readtab); i++) {\r\nNICSTAR_REG_WRITE(base, NICSTAR_REG_GENERAL_PURPOSE,\r\n(val | readtab[i]));\r\nosp_MicroDelay(CYCLE_DELAY);\r\n}\r\nfor (i = 7; i >= 0; i--) {\r\nNICSTAR_REG_WRITE(base, NICSTAR_REG_GENERAL_PURPOSE,\r\n(val | clocktab[j++] | ((offset >> i) & 1)));\r\nosp_MicroDelay(CYCLE_DELAY);\r\nNICSTAR_REG_WRITE(base, NICSTAR_REG_GENERAL_PURPOSE,\r\n(val | clocktab[j++] | ((offset >> i) & 1)));\r\nosp_MicroDelay(CYCLE_DELAY);\r\n}\r\nj = 0;\r\nfor (i = 7; i >= 0; i--) {\r\nNICSTAR_REG_WRITE(base, NICSTAR_REG_GENERAL_PURPOSE,\r\n(val | clocktab[j++]));\r\nosp_MicroDelay(CYCLE_DELAY);\r\ntempread |=\r\n(((NICSTAR_REG_READ(base, NICSTAR_REG_GENERAL_PURPOSE)\r\n& 0x00010000) >> 16) << i);\r\nNICSTAR_REG_WRITE(base, NICSTAR_REG_GENERAL_PURPOSE,\r\n(val | clocktab[j++]));\r\nosp_MicroDelay(CYCLE_DELAY);\r\n}\r\nNICSTAR_REG_WRITE(base, NICSTAR_REG_GENERAL_PURPOSE, 2);\r\nosp_MicroDelay(CYCLE_DELAY);\r\nreturn tempread;\r\n}\r\nstatic void nicstar_init_eprom(virt_addr_t base)\r\n{\r\nu_int32_t val;\r\nval = NICSTAR_REG_READ(base, NICSTAR_REG_GENERAL_PURPOSE) & 0xFFFFFFF0;\r\nNICSTAR_REG_WRITE(base, NICSTAR_REG_GENERAL_PURPOSE,\r\n(val | CS_HIGH | CLK_HIGH));\r\nosp_MicroDelay(CYCLE_DELAY);\r\nNICSTAR_REG_WRITE(base, NICSTAR_REG_GENERAL_PURPOSE,\r\n(val | CS_HIGH | CLK_LOW));\r\nosp_MicroDelay(CYCLE_DELAY);\r\nNICSTAR_REG_WRITE(base, NICSTAR_REG_GENERAL_PURPOSE,\r\n(val | CS_HIGH | CLK_HIGH));\r\nosp_MicroDelay(CYCLE_DELAY);\r\nNICSTAR_REG_WRITE(base, NICSTAR_REG_GENERAL_PURPOSE,\r\n(val | CS_HIGH | CLK_LOW));\r\nosp_MicroDelay(CYCLE_DELAY);\r\n}\r\nstatic void\r\nnicstar_read_eprom(virt_addr_t base,\r\nu_int8_t prom_offset, u_int8_t * buffer, u_int32_t nbytes)\r\n{\r\nu_int i;\r\nfor (i = 0; i < nbytes; i++) {\r\nbuffer[i] = read_eprom_byte(base, prom_offset);\r\n++prom_offset;\r\nosp_MicroDelay(CYCLE_DELAY);\r\n}\r\n}

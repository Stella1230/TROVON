static int ipw_open(struct tty_struct *tty, struct usb_serial_port *port)\r\n{\r\nstruct usb_device *udev = port->serial->dev;\r\nstruct device *dev = &port->dev;\r\nu8 buf_flow_static[16] = IPW_BYTES_FLOWINIT;\r\nu8 *buf_flow_init;\r\nint result;\r\nbuf_flow_init = kmemdup(buf_flow_static, 16, GFP_KERNEL);\r\nif (!buf_flow_init)\r\nreturn -ENOMEM;\r\ndev_dbg(dev, "%s: Sending SIO_INIT (we guess)\n", __func__);\r\nresult = usb_control_msg(udev, usb_sndctrlpipe(udev, 0),\r\nIPW_SIO_INIT,\r\nUSB_TYPE_VENDOR | USB_RECIP_INTERFACE | USB_DIR_OUT,\r\n0,\r\n0,\r\nNULL,\r\n0,\r\n100000);\r\nif (result < 0)\r\ndev_err(dev, "Init of modem failed (error = %d)\n", result);\r\nusb_clear_halt(udev, usb_rcvbulkpipe(udev, port->bulk_in_endpointAddress));\r\nusb_clear_halt(udev, usb_sndbulkpipe(udev, port->bulk_out_endpointAddress));\r\ndev_dbg(dev, "%s: setting up bulk read callback\n", __func__);\r\nusb_wwan_open(tty, port);\r\ndev_dbg(dev, "%s:asking modem for RxRead (RXBULK_ON)\n", __func__);\r\nresult = usb_control_msg(udev, usb_sndctrlpipe(udev, 0),\r\nIPW_SIO_RXCTL,\r\nUSB_TYPE_VENDOR | USB_RECIP_INTERFACE | USB_DIR_OUT,\r\nIPW_RXBULK_ON,\r\n0,\r\nNULL,\r\n0,\r\n100000);\r\nif (result < 0)\r\ndev_err(dev, "Enabling bulk RxRead failed (error = %d)\n", result);\r\ndev_dbg(dev, "%s:setting init flowcontrol (%s)\n", __func__, buf_flow_init);\r\nresult = usb_control_msg(udev, usb_sndctrlpipe(udev, 0),\r\nIPW_SIO_HANDFLOW,\r\nUSB_TYPE_VENDOR | USB_RECIP_INTERFACE | USB_DIR_OUT,\r\n0,\r\n0,\r\nbuf_flow_init,\r\n0x10,\r\n200000);\r\nif (result < 0)\r\ndev_err(dev, "initial flowcontrol failed (error = %d)\n", result);\r\nkfree(buf_flow_init);\r\nreturn 0;\r\n}\r\nstatic int ipw_attach(struct usb_serial *serial)\r\n{\r\nstruct usb_wwan_intf_private *data;\r\ndata = kzalloc(sizeof(struct usb_wwan_intf_private), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\nspin_lock_init(&data->susp_lock);\r\nusb_set_serial_data(serial, data);\r\nreturn 0;\r\n}\r\nstatic void ipw_release(struct usb_serial *serial)\r\n{\r\nstruct usb_wwan_intf_private *data = usb_get_serial_data(serial);\r\nusb_set_serial_data(serial, NULL);\r\nkfree(data);\r\n}\r\nstatic void ipw_dtr_rts(struct usb_serial_port *port, int on)\r\n{\r\nstruct usb_device *udev = port->serial->dev;\r\nstruct device *dev = &port->dev;\r\nint result;\r\ndev_dbg(dev, "%s: on = %d\n", __func__, on);\r\nresult = usb_control_msg(udev, usb_sndctrlpipe(udev, 0),\r\nIPW_SIO_SET_PIN,\r\nUSB_TYPE_VENDOR | USB_RECIP_INTERFACE | USB_DIR_OUT,\r\non ? IPW_PIN_SETDTR : IPW_PIN_CLRDTR,\r\n0,\r\nNULL,\r\n0,\r\n200000);\r\nif (result < 0)\r\ndev_err(dev, "setting dtr failed (error = %d)\n", result);\r\nresult = usb_control_msg(udev, usb_sndctrlpipe(udev, 0),\r\nIPW_SIO_SET_PIN, USB_TYPE_VENDOR |\r\nUSB_RECIP_INTERFACE | USB_DIR_OUT,\r\non ? IPW_PIN_SETRTS : IPW_PIN_CLRRTS,\r\n0,\r\nNULL,\r\n0,\r\n200000);\r\nif (result < 0)\r\ndev_err(dev, "setting rts failed (error = %d)\n", result);\r\n}\r\nstatic void ipw_close(struct usb_serial_port *port)\r\n{\r\nstruct usb_device *udev = port->serial->dev;\r\nstruct device *dev = &port->dev;\r\nint result;\r\ndev_dbg(dev, "%s:sending purge\n", __func__);\r\nresult = usb_control_msg(udev, usb_sndctrlpipe(udev, 0),\r\nIPW_SIO_PURGE, USB_TYPE_VENDOR |\r\nUSB_RECIP_INTERFACE | USB_DIR_OUT,\r\n0x03,\r\n0,\r\nNULL,\r\n0,\r\n200000);\r\nif (result < 0)\r\ndev_err(dev, "purge failed (error = %d)\n", result);\r\nresult = usb_control_msg(udev, usb_sndctrlpipe(udev, 0),\r\nIPW_SIO_RXCTL,\r\nUSB_TYPE_VENDOR | USB_RECIP_INTERFACE | USB_DIR_OUT,\r\nIPW_RXBULK_OFF,\r\n0,\r\nNULL,\r\n0,\r\n100000);\r\nif (result < 0)\r\ndev_err(dev, "Disabling bulk RxRead failed (error = %d)\n", result);\r\nusb_wwan_close(port);\r\n}

static __net_init int sunrpc_init_net(struct net *net)\r\n{\r\nint err;\r\nstruct sunrpc_net *sn = net_generic(net, sunrpc_net_id);\r\nerr = rpc_proc_init(net);\r\nif (err)\r\ngoto err_proc;\r\nerr = ip_map_cache_create(net);\r\nif (err)\r\ngoto err_ipmap;\r\nerr = unix_gid_cache_create(net);\r\nif (err)\r\ngoto err_unixgid;\r\nrpc_pipefs_init_net(net);\r\nINIT_LIST_HEAD(&sn->all_clients);\r\nspin_lock_init(&sn->rpc_client_lock);\r\nspin_lock_init(&sn->rpcb_clnt_lock);\r\nreturn 0;\r\nerr_unixgid:\r\nip_map_cache_destroy(net);\r\nerr_ipmap:\r\nrpc_proc_exit(net);\r\nerr_proc:\r\nreturn err;\r\n}\r\nstatic __net_exit void sunrpc_exit_net(struct net *net)\r\n{\r\nunix_gid_cache_destroy(net);\r\nip_map_cache_destroy(net);\r\nrpc_proc_exit(net);\r\n}\r\nstatic int __init\r\ninit_sunrpc(void)\r\n{\r\nint err = rpc_init_mempool();\r\nif (err)\r\ngoto out;\r\nerr = rpcauth_init_module();\r\nif (err)\r\ngoto out2;\r\ncache_initialize();\r\nerr = register_pernet_subsys(&sunrpc_net_ops);\r\nif (err)\r\ngoto out3;\r\nerr = register_rpc_pipefs();\r\nif (err)\r\ngoto out4;\r\n#ifdef RPC_DEBUG\r\nrpc_register_sysctl();\r\n#endif\r\nsvc_init_xprt_sock();\r\ninit_socket_xprt();\r\nreturn 0;\r\nout4:\r\nunregister_pernet_subsys(&sunrpc_net_ops);\r\nout3:\r\nrpcauth_remove_module();\r\nout2:\r\nrpc_destroy_mempool();\r\nout:\r\nreturn err;\r\n}\r\nstatic void __exit\r\ncleanup_sunrpc(void)\r\n{\r\nrpcauth_remove_module();\r\ncleanup_socket_xprt();\r\nsvc_cleanup_xprt_sock();\r\nunregister_rpc_pipefs();\r\nrpc_destroy_mempool();\r\nunregister_pernet_subsys(&sunrpc_net_ops);\r\n#ifdef RPC_DEBUG\r\nrpc_unregister_sysctl();\r\n#endif\r\nrcu_barrier();\r\n}

static int\r\nev6_parse_ibox(u64 i_stat, int print)\r\n{\r\nint status = MCHK_DISPOSITION_REPORT;\r\n#define EV6__I_STAT__PAR (1UL << 29)\r\n#define EV6__I_STAT__ERRMASK (EV6__I_STAT__PAR)\r\nif (!(i_stat & EV6__I_STAT__ERRMASK))\r\nreturn MCHK_DISPOSITION_UNKNOWN_ERROR;\r\nif (!print)\r\nreturn status;\r\nif (i_stat & EV6__I_STAT__PAR)\r\nprintk("%s Icache parity error\n", err_print_prefix);\r\nreturn status;\r\n}\r\nstatic int\r\nev6_parse_mbox(u64 mm_stat, u64 d_stat, u64 c_stat, int print)\r\n{\r\nint status = MCHK_DISPOSITION_REPORT;\r\n#define EV6__MM_STAT__DC_TAG_PERR (1UL << 10)\r\n#define EV6__MM_STAT__ERRMASK (EV6__MM_STAT__DC_TAG_PERR)\r\n#define EV6__D_STAT__TPERR_P0 (1UL << 0)\r\n#define EV6__D_STAT__TPERR_P1 (1UL << 1)\r\n#define EV6__D_STAT__ECC_ERR_ST (1UL << 2)\r\n#define EV6__D_STAT__ECC_ERR_LD (1UL << 3)\r\n#define EV6__D_STAT__SEO (1UL << 4)\r\n#define EV6__D_STAT__ERRMASK (EV6__D_STAT__TPERR_P0 | \\r\nEV6__D_STAT__TPERR_P1 | \\r\nEV6__D_STAT__ECC_ERR_ST | \\r\nEV6__D_STAT__ECC_ERR_LD | \\r\nEV6__D_STAT__SEO)\r\nif (!(d_stat & EV6__D_STAT__ERRMASK) &&\r\n!(mm_stat & EV6__MM_STAT__ERRMASK))\r\nreturn MCHK_DISPOSITION_UNKNOWN_ERROR;\r\nif (!print)\r\nreturn status;\r\nif (mm_stat & EV6__MM_STAT__DC_TAG_PERR)\r\nprintk("%s Dcache tag parity error on probe\n",\r\nerr_print_prefix);\r\nif (d_stat & EV6__D_STAT__TPERR_P0)\r\nprintk("%s Dcache tag parity error - pipe 0\n",\r\nerr_print_prefix);\r\nif (d_stat & EV6__D_STAT__TPERR_P1)\r\nprintk("%s Dcache tag parity error - pipe 1\n",\r\nerr_print_prefix);\r\nif (d_stat & EV6__D_STAT__ECC_ERR_ST)\r\nprintk("%s ECC error occurred on a store\n",\r\nerr_print_prefix);\r\nif (d_stat & EV6__D_STAT__ECC_ERR_LD)\r\nprintk("%s ECC error occurred on a %s load\n",\r\nerr_print_prefix,\r\nc_stat ? "" : "speculative ");\r\nif (d_stat & EV6__D_STAT__SEO)\r\nprintk("%s Dcache second error\n", err_print_prefix);\r\nreturn status;\r\n}\r\nstatic int\r\nev6_parse_cbox(u64 c_addr, u64 c1_syn, u64 c2_syn,\r\nu64 c_stat, u64 c_sts, int print)\r\n{\r\nstatic const char * const sourcename[] = {\r\n"UNKNOWN", "UNKNOWN", "UNKNOWN",\r\n"MEMORY", "BCACHE", "DCACHE",\r\n"BCACHE PROBE", "BCACHE PROBE"\r\n};\r\nstatic const char * const streamname[] = { "D", "I" };\r\nstatic const char * const bitsname[] = { "SINGLE", "DOUBLE" };\r\nint status = MCHK_DISPOSITION_REPORT;\r\nint source = -1, stream = -1, bits = -1;\r\n#define EV6__C_STAT__BC_PERR (0x01)\r\n#define EV6__C_STAT__DC_PERR (0x02)\r\n#define EV6__C_STAT__DSTREAM_MEM_ERR (0x03)\r\n#define EV6__C_STAT__DSTREAM_BC_ERR (0x04)\r\n#define EV6__C_STAT__DSTREAM_DC_ERR (0x05)\r\n#define EV6__C_STAT__PROBE_BC_ERR0 (0x06)\r\n#define EV6__C_STAT__PROBE_BC_ERR1 (0x07)\r\n#define EV6__C_STAT__ISTREAM_MEM_ERR (0x0B)\r\n#define EV6__C_STAT__ISTREAM_BC_ERR (0x0C)\r\n#define EV6__C_STAT__DSTREAM_MEM_DBL (0x13)\r\n#define EV6__C_STAT__DSTREAM_BC_DBL (0x14)\r\n#define EV6__C_STAT__ISTREAM_MEM_DBL (0x1B)\r\n#define EV6__C_STAT__ISTREAM_BC_DBL (0x1C)\r\n#define EV6__C_STAT__SOURCE_MEMORY (0x03)\r\n#define EV6__C_STAT__SOURCE_BCACHE (0x04)\r\n#define EV6__C_STAT__SOURCE__S (0)\r\n#define EV6__C_STAT__SOURCE__M (0x07)\r\n#define EV6__C_STAT__ISTREAM__S (3)\r\n#define EV6__C_STAT__ISTREAM__M (0x01)\r\n#define EV6__C_STAT__DOUBLE__S (4)\r\n#define EV6__C_STAT__DOUBLE__M (0x01)\r\n#define EV6__C_STAT__ERRMASK (0x1F)\r\n#define EV6__C_STS__SHARED (1 << 0)\r\n#define EV6__C_STS__DIRTY (1 << 1)\r\n#define EV6__C_STS__VALID (1 << 2)\r\n#define EV6__C_STS__PARITY (1 << 3)\r\nif (!(c_stat & EV6__C_STAT__ERRMASK))\r\nreturn MCHK_DISPOSITION_UNKNOWN_ERROR;\r\nif (!print)\r\nreturn status;\r\nsource = EXTRACT(c_stat, EV6__C_STAT__SOURCE);\r\nstream = EXTRACT(c_stat, EV6__C_STAT__ISTREAM);\r\nbits = EXTRACT(c_stat, EV6__C_STAT__DOUBLE);\r\nif (c_stat & EV6__C_STAT__BC_PERR) {\r\nprintk("%s Bcache tag parity error\n", err_print_prefix);\r\nsource = -1;\r\n}\r\nif (c_stat & EV6__C_STAT__DC_PERR) {\r\nprintk("%s Dcache tag parity error\n", err_print_prefix);\r\nsource = -1;\r\n}\r\nif (c_stat == EV6__C_STAT__PROBE_BC_ERR0 ||\r\nc_stat == EV6__C_STAT__PROBE_BC_ERR1) {\r\nprintk("%s Bcache single-bit error on a probe hit\n",\r\nerr_print_prefix);\r\nsource = -1;\r\n}\r\nif (source != -1)\r\nprintk("%s %s-STREAM %s-BIT ECC error from %s\n",\r\nerr_print_prefix,\r\nstreamname[stream], bitsname[bits], sourcename[source]);\r\nprintk("%s Address: 0x%016llx\n"\r\n" Syndrome[upper.lower]: %02llx.%02llx\n",\r\nerr_print_prefix,\r\nc_addr,\r\nc2_syn, c1_syn);\r\nif (source == EV6__C_STAT__SOURCE_MEMORY ||\r\nsource == EV6__C_STAT__SOURCE_BCACHE)\r\nprintk("%s Block status: %s%s%s%s\n",\r\nerr_print_prefix,\r\n(c_sts & EV6__C_STS__SHARED) ? "SHARED " : "",\r\n(c_sts & EV6__C_STS__DIRTY) ? "DIRTY " : "",\r\n(c_sts & EV6__C_STS__VALID) ? "VALID " : "",\r\n(c_sts & EV6__C_STS__PARITY) ? "PARITY " : "");\r\nreturn status;\r\n}\r\nvoid\r\nev6_register_error_handlers(void)\r\n{\r\n}\r\nint\r\nev6_process_logout_frame(struct el_common *mchk_header, int print)\r\n{\r\nstruct el_common_EV6_mcheck *ev6mchk =\r\n(struct el_common_EV6_mcheck *)mchk_header;\r\nint status = MCHK_DISPOSITION_UNKNOWN_ERROR;\r\nstatus |= ev6_parse_ibox(ev6mchk->I_STAT, print);\r\nstatus |= ev6_parse_mbox(ev6mchk->MM_STAT, ev6mchk->DC_STAT,\r\nev6mchk->C_STAT, print);\r\nstatus |= ev6_parse_cbox(ev6mchk->C_ADDR, ev6mchk->DC1_SYNDROME,\r\nev6mchk->DC0_SYNDROME, ev6mchk->C_STAT,\r\nev6mchk->C_STS, print);\r\nif (!print)\r\nreturn status;\r\nif (status != MCHK_DISPOSITION_DISMISS) {\r\nchar *saved_err_prefix = err_print_prefix;\r\nprintk("%s EXC_ADDR: 0x%016lx IER_CM: 0x%016lx"\r\n" ISUM: 0x%016lx\n"\r\n" PAL_BASE: 0x%016lx I_CTL: 0x%016lx"\r\n" PCTX: 0x%016lx\n",\r\nerr_print_prefix,\r\nev6mchk->EXC_ADDR, ev6mchk->IER_CM, ev6mchk->ISUM,\r\nev6mchk->PAL_BASE, ev6mchk->I_CTL, ev6mchk->PCTX);\r\nif (status == MCHK_DISPOSITION_UNKNOWN_ERROR) {\r\nprintk("%s UNKNOWN error, frame follows:\n",\r\nerr_print_prefix);\r\n} else {\r\nerr_print_prefix = KERN_NOTICE;\r\n}\r\nmchk_dump_logout_frame(mchk_header);\r\nerr_print_prefix = saved_err_prefix;\r\n}\r\nreturn status;\r\n}\r\nvoid\r\nev6_machine_check(unsigned long vector, unsigned long la_ptr)\r\n{\r\nstruct el_common *mchk_header = (struct el_common *)la_ptr;\r\nmb();\r\ndraina();\r\nif (ev6_process_logout_frame(mchk_header, 0) !=\r\nMCHK_DISPOSITION_DISMISS) {\r\nchar *saved_err_prefix = err_print_prefix;\r\nerr_print_prefix = KERN_CRIT;\r\nprintk("%s*CPU %s Error (Vector 0x%x) reported on CPU %d:\n",\r\nerr_print_prefix,\r\n(vector == SCB_Q_PROCERR)?"Correctable":"Uncorrectable",\r\n(unsigned int)vector, (int)smp_processor_id());\r\nev6_process_logout_frame(mchk_header, 1);\r\ndik_show_regs(get_irq_regs(), NULL);\r\nerr_print_prefix = saved_err_prefix;\r\n}\r\nwrmces(0x7);\r\nmb();\r\n}

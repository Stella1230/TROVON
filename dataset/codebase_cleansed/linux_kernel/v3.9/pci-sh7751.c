static int __init __area_sdram_check(struct pci_channel *chan,\r\nunsigned int area)\r\n{\r\nunsigned long word;\r\nword = __raw_readl(SH7751_BCR1);\r\nif (((word >> area) & 1) == 0) {\r\nprintk("PCI: Area %d is not configured for SDRAM. BCR1=0x%lx\n",\r\narea, word);\r\nreturn 0;\r\n}\r\npci_write_reg(chan, word, SH4_PCIBCR1);\r\nword = __raw_readw(SH7751_BCR2);\r\nif (((word >> (area << 1)) & 0x3) != 0x3) {\r\nprintk("PCI: Area %d is not 32 bit SDRAM. BCR2=0x%lx\n",\r\narea, word);\r\nreturn 0;\r\n}\r\npci_write_reg(chan, word, SH4_PCIBCR2);\r\nreturn 1;\r\n}\r\nstatic int __init sh7751_pci_init(void)\r\n{\r\nstruct pci_channel *chan = &sh7751_pci_controller;\r\nunsigned int id;\r\nu32 word, reg;\r\nprintk(KERN_NOTICE "PCI: Starting initialization.\n");\r\nchan->reg_base = 0xfe200000;\r\nid = pci_read_reg(chan, SH7751_PCICONF0);\r\nif (id != ((SH7751_DEVICE_ID << 16) | SH7751_VENDOR_ID) &&\r\nid != ((SH7751R_DEVICE_ID << 16) | SH7751_VENDOR_ID)) {\r\npr_debug("PCI: This is not an SH7751(R) (%x)\n", id);\r\nreturn -ENODEV;\r\n}\r\nreg = __raw_readl(SH7751_BCR1);\r\nreg |= 0x80000;\r\n__raw_writel(reg, SH7751_BCR1);\r\npci_write_reg(chan, 0, SH4_PCICLKR);\r\nword = SH4_PCIPINT_D3 | SH4_PCIPINT_D0;\r\npci_write_reg(chan, word, SH4_PCIPINT);\r\nword = SH7751_PCICONF1_WCC | SH7751_PCICONF1_PER |\r\nSH7751_PCICONF1_BUM | SH7751_PCICONF1_MES;\r\npci_write_reg(chan, word, SH7751_PCICONF1);\r\nword = PCI_BASE_CLASS_BRIDGE << 24;\r\npci_write_reg(chan, word, SH7751_PCICONF2);\r\nword = sh7751_pci_map.window0.size - 1;\r\npci_write_reg(chan, word, SH4_PCILSR0);\r\nword = P2SEGADDR(sh7751_pci_map.window0.base);\r\npci_write_reg(chan, word, SH4_PCILAR0);\r\npci_write_reg(chan, word, SH7751_PCICONF5);\r\nword = chan->resources[1].start & SH4_PCIMBR_MASK;\r\npr_debug("PCI: Setting upper bits of Memory window to 0x%x\n", word);\r\npci_write_reg(chan, word , SH4_PCIMBR);\r\nword = chan->resources[0].start & SH4_PCIIOBR_MASK;\r\npr_debug("PCI: Setting upper bits of IO window to 0x%x\n", word);\r\npci_write_reg(chan, word, SH4_PCIIOBR);\r\nswitch (sh7751_pci_map.window0.base) {\r\ncase SH7751_CS0_BASE_ADDR: word = __area_sdram_check(chan, 0); break;\r\ncase SH7751_CS1_BASE_ADDR: word = __area_sdram_check(chan, 1); break;\r\ncase SH7751_CS2_BASE_ADDR: word = __area_sdram_check(chan, 2); break;\r\ncase SH7751_CS3_BASE_ADDR: word = __area_sdram_check(chan, 3); break;\r\ncase SH7751_CS4_BASE_ADDR: word = __area_sdram_check(chan, 4); break;\r\ncase SH7751_CS5_BASE_ADDR: word = __area_sdram_check(chan, 5); break;\r\ncase SH7751_CS6_BASE_ADDR: word = __area_sdram_check(chan, 6); break;\r\n}\r\nif (!word)\r\nreturn -1;\r\nword = __raw_readl(SH7751_WCR1);\r\npci_write_reg(chan, word, SH4_PCIWCR1);\r\nword = __raw_readl(SH7751_WCR2);\r\npci_write_reg(chan, word, SH4_PCIWCR2);\r\nword = __raw_readl(SH7751_WCR3);\r\npci_write_reg(chan, word, SH4_PCIWCR3);\r\nword = __raw_readl(SH7751_MCR);\r\npci_write_reg(chan, word, SH4_PCIMCR);\r\npci_fixup_pcic(chan);\r\nword = SH4_PCICR_PREFIX | SH4_PCICR_CFIN | SH4_PCICR_ARBM;\r\npci_write_reg(chan, word, SH4_PCICR);\r\nreturn register_pci_controller(chan);\r\n}

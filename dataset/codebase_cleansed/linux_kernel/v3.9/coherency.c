int coherency_get_cpu_count(void)\r\n{\r\nint reg, cnt;\r\nreg = readl(coherency_base + COHERENCY_FABRIC_CFG_OFFSET);\r\ncnt = (reg & 0xF) + 1;\r\nreturn cnt;\r\n}\r\nint set_cpu_coherent(unsigned int hw_cpu_id, int smp_group_id)\r\n{\r\nif (!coherency_base) {\r\npr_warn("Can't make CPU %d cache coherent.\n", hw_cpu_id);\r\npr_warn("Coherency fabric is not initialized\n");\r\nreturn 1;\r\n}\r\nreturn ll_set_cpu_coherent(coherency_base, hw_cpu_id);\r\n}\r\nstatic inline void mvebu_hwcc_sync_io_barrier(void)\r\n{\r\nwritel(0x1, coherency_cpu_base + IO_SYNC_BARRIER_CTL_OFFSET);\r\nwhile (readl(coherency_cpu_base + IO_SYNC_BARRIER_CTL_OFFSET) & 0x1);\r\n}\r\nstatic dma_addr_t mvebu_hwcc_dma_map_page(struct device *dev, struct page *page,\r\nunsigned long offset, size_t size,\r\nenum dma_data_direction dir,\r\nstruct dma_attrs *attrs)\r\n{\r\nif (dir != DMA_TO_DEVICE)\r\nmvebu_hwcc_sync_io_barrier();\r\nreturn pfn_to_dma(dev, page_to_pfn(page)) + offset;\r\n}\r\nstatic void mvebu_hwcc_dma_unmap_page(struct device *dev, dma_addr_t dma_handle,\r\nsize_t size, enum dma_data_direction dir,\r\nstruct dma_attrs *attrs)\r\n{\r\nif (dir != DMA_TO_DEVICE)\r\nmvebu_hwcc_sync_io_barrier();\r\n}\r\nstatic void mvebu_hwcc_dma_sync(struct device *dev, dma_addr_t dma_handle,\r\nsize_t size, enum dma_data_direction dir)\r\n{\r\nif (dir != DMA_TO_DEVICE)\r\nmvebu_hwcc_sync_io_barrier();\r\n}\r\nstatic int mvebu_hwcc_platform_notifier(struct notifier_block *nb,\r\nunsigned long event, void *__dev)\r\n{\r\nstruct device *dev = __dev;\r\nif (event != BUS_NOTIFY_ADD_DEVICE)\r\nreturn NOTIFY_DONE;\r\nset_dma_ops(dev, &mvebu_hwcc_dma_ops);\r\nreturn NOTIFY_OK;\r\n}\r\nint __init coherency_init(void)\r\n{\r\nstruct device_node *np;\r\nnp = of_find_matching_node(NULL, of_coherency_table);\r\nif (np) {\r\npr_info("Initializing Coherency fabric\n");\r\ncoherency_base = of_iomap(np, 0);\r\ncoherency_cpu_base = of_iomap(np, 1);\r\nset_cpu_coherent(cpu_logical_map(smp_processor_id()), 0);\r\nbus_register_notifier(&platform_bus_type,\r\n&mvebu_hwcc_platform_nb);\r\n}\r\nreturn 0;\r\n}

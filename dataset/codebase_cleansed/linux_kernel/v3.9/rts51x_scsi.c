void rts51x_scsi_show_command(struct scsi_cmnd *srb)\r\n{\r\nchar *what = NULL;\r\nint i, unknown_cmd = 0;\r\nswitch (srb->cmnd[0]) {\r\ncase TEST_UNIT_READY:\r\nwhat = (char *)"TEST_UNIT_READY";\r\nbreak;\r\ncase REZERO_UNIT:\r\nwhat = (char *)"REZERO_UNIT";\r\nbreak;\r\ncase REQUEST_SENSE:\r\nwhat = (char *)"REQUEST_SENSE";\r\nbreak;\r\ncase FORMAT_UNIT:\r\nwhat = (char *)"FORMAT_UNIT";\r\nbreak;\r\ncase READ_BLOCK_LIMITS:\r\nwhat = (char *)"READ_BLOCK_LIMITS";\r\nbreak;\r\ncase 0x07:\r\nwhat = (char *)"REASSIGN_BLOCKS";\r\nbreak;\r\ncase READ_6:\r\nwhat = (char *)"READ_6";\r\nbreak;\r\ncase WRITE_6:\r\nwhat = (char *)"WRITE_6";\r\nbreak;\r\ncase SEEK_6:\r\nwhat = (char *)"SEEK_6";\r\nbreak;\r\ncase READ_REVERSE:\r\nwhat = (char *)"READ_REVERSE";\r\nbreak;\r\ncase WRITE_FILEMARKS:\r\nwhat = (char *)"WRITE_FILEMARKS";\r\nbreak;\r\ncase SPACE:\r\nwhat = (char *)"SPACE";\r\nbreak;\r\ncase INQUIRY:\r\nwhat = (char *)"INQUIRY";\r\nbreak;\r\ncase RECOVER_BUFFERED_DATA:\r\nwhat = (char *)"RECOVER_BUFFERED_DATA";\r\nbreak;\r\ncase MODE_SELECT:\r\nwhat = (char *)"MODE_SELECT";\r\nbreak;\r\ncase RESERVE:\r\nwhat = (char *)"RESERVE";\r\nbreak;\r\ncase RELEASE:\r\nwhat = (char *)"RELEASE";\r\nbreak;\r\ncase COPY:\r\nwhat = (char *)"COPY";\r\nbreak;\r\ncase ERASE:\r\nwhat = (char *)"ERASE";\r\nbreak;\r\ncase MODE_SENSE:\r\nwhat = (char *)"MODE_SENSE";\r\nbreak;\r\ncase START_STOP:\r\nwhat = (char *)"START_STOP";\r\nbreak;\r\ncase RECEIVE_DIAGNOSTIC:\r\nwhat = (char *)"RECEIVE_DIAGNOSTIC";\r\nbreak;\r\ncase SEND_DIAGNOSTIC:\r\nwhat = (char *)"SEND_DIAGNOSTIC";\r\nbreak;\r\ncase ALLOW_MEDIUM_REMOVAL:\r\nwhat = (char *)"ALLOW_MEDIUM_REMOVAL";\r\nbreak;\r\ncase SET_WINDOW:\r\nwhat = (char *)"SET_WINDOW";\r\nbreak;\r\ncase READ_CAPACITY:\r\nwhat = (char *)"READ_CAPACITY";\r\nbreak;\r\ncase READ_10:\r\nwhat = (char *)"READ_10";\r\nbreak;\r\ncase WRITE_10:\r\nwhat = (char *)"WRITE_10";\r\nbreak;\r\ncase SEEK_10:\r\nwhat = (char *)"SEEK_10";\r\nbreak;\r\ncase WRITE_VERIFY:\r\nwhat = (char *)"WRITE_VERIFY";\r\nbreak;\r\ncase VERIFY:\r\nwhat = (char *)"VERIFY";\r\nbreak;\r\ncase SEARCH_HIGH:\r\nwhat = (char *)"SEARCH_HIGH";\r\nbreak;\r\ncase SEARCH_EQUAL:\r\nwhat = (char *)"SEARCH_EQUAL";\r\nbreak;\r\ncase SEARCH_LOW:\r\nwhat = (char *)"SEARCH_LOW";\r\nbreak;\r\ncase SET_LIMITS:\r\nwhat = (char *)"SET_LIMITS";\r\nbreak;\r\ncase READ_POSITION:\r\nwhat = (char *)"READ_POSITION";\r\nbreak;\r\ncase SYNCHRONIZE_CACHE:\r\nwhat = (char *)"SYNCHRONIZE_CACHE";\r\nbreak;\r\ncase LOCK_UNLOCK_CACHE:\r\nwhat = (char *)"LOCK_UNLOCK_CACHE";\r\nbreak;\r\ncase READ_DEFECT_DATA:\r\nwhat = (char *)"READ_DEFECT_DATA";\r\nbreak;\r\ncase MEDIUM_SCAN:\r\nwhat = (char *)"MEDIUM_SCAN";\r\nbreak;\r\ncase COMPARE:\r\nwhat = (char *)"COMPARE";\r\nbreak;\r\ncase COPY_VERIFY:\r\nwhat = (char *)"COPY_VERIFY";\r\nbreak;\r\ncase WRITE_BUFFER:\r\nwhat = (char *)"WRITE_BUFFER";\r\nbreak;\r\ncase READ_BUFFER:\r\nwhat = (char *)"READ_BUFFER";\r\nbreak;\r\ncase UPDATE_BLOCK:\r\nwhat = (char *)"UPDATE_BLOCK";\r\nbreak;\r\ncase READ_LONG:\r\nwhat = (char *)"READ_LONG";\r\nbreak;\r\ncase WRITE_LONG:\r\nwhat = (char *)"WRITE_LONG";\r\nbreak;\r\ncase CHANGE_DEFINITION:\r\nwhat = (char *)"CHANGE_DEFINITION";\r\nbreak;\r\ncase WRITE_SAME:\r\nwhat = (char *)"WRITE_SAME";\r\nbreak;\r\ncase GPCMD_READ_SUBCHANNEL:\r\nwhat = (char *)"READ SUBCHANNEL";\r\nbreak;\r\ncase READ_TOC:\r\nwhat = (char *)"READ_TOC";\r\nbreak;\r\ncase GPCMD_READ_HEADER:\r\nwhat = (char *)"READ HEADER";\r\nbreak;\r\ncase GPCMD_PLAY_AUDIO_10:\r\nwhat = (char *)"PLAY AUDIO (10)";\r\nbreak;\r\ncase GPCMD_PLAY_AUDIO_MSF:\r\nwhat = (char *)"PLAY AUDIO MSF";\r\nbreak;\r\ncase GPCMD_GET_EVENT_STATUS_NOTIFICATION:\r\nwhat = (char *)"GET EVENT/STATUS NOTIFICATION";\r\nbreak;\r\ncase GPCMD_PAUSE_RESUME:\r\nwhat = (char *)"PAUSE/RESUME";\r\nbreak;\r\ncase LOG_SELECT:\r\nwhat = (char *)"LOG_SELECT";\r\nbreak;\r\ncase LOG_SENSE:\r\nwhat = (char *)"LOG_SENSE";\r\nbreak;\r\ncase GPCMD_STOP_PLAY_SCAN:\r\nwhat = (char *)"STOP PLAY/SCAN";\r\nbreak;\r\ncase GPCMD_READ_DISC_INFO:\r\nwhat = (char *)"READ DISC INFORMATION";\r\nbreak;\r\ncase GPCMD_READ_TRACK_RZONE_INFO:\r\nwhat = (char *)"READ TRACK INFORMATION";\r\nbreak;\r\ncase GPCMD_RESERVE_RZONE_TRACK:\r\nwhat = (char *)"RESERVE TRACK";\r\nbreak;\r\ncase GPCMD_SEND_OPC:\r\nwhat = (char *)"SEND OPC";\r\nbreak;\r\ncase MODE_SELECT_10:\r\nwhat = (char *)"MODE_SELECT_10";\r\nbreak;\r\ncase GPCMD_REPAIR_RZONE_TRACK:\r\nwhat = (char *)"REPAIR TRACK";\r\nbreak;\r\ncase 0x59:\r\nwhat = (char *)"READ MASTER CUE";\r\nbreak;\r\ncase MODE_SENSE_10:\r\nwhat = (char *)"MODE_SENSE_10";\r\nbreak;\r\ncase GPCMD_CLOSE_TRACK:\r\nwhat = (char *)"CLOSE TRACK/SESSION";\r\nbreak;\r\ncase 0x5C:\r\nwhat = (char *)"READ BUFFER CAPACITY";\r\nbreak;\r\ncase 0x5D:\r\nwhat = (char *)"SEND CUE SHEET";\r\nbreak;\r\ncase GPCMD_BLANK:\r\nwhat = (char *)"BLANK";\r\nbreak;\r\ncase REPORT_LUNS:\r\nwhat = (char *)"REPORT LUNS";\r\nbreak;\r\ncase MOVE_MEDIUM:\r\nwhat = (char *)"MOVE_MEDIUM or PLAY AUDIO (12)";\r\nbreak;\r\ncase READ_12:\r\nwhat = (char *)"READ_12";\r\nbreak;\r\ncase WRITE_12:\r\nwhat = (char *)"WRITE_12";\r\nbreak;\r\ncase WRITE_VERIFY_12:\r\nwhat = (char *)"WRITE_VERIFY_12";\r\nbreak;\r\ncase SEARCH_HIGH_12:\r\nwhat = (char *)"SEARCH_HIGH_12";\r\nbreak;\r\ncase SEARCH_EQUAL_12:\r\nwhat = (char *)"SEARCH_EQUAL_12";\r\nbreak;\r\ncase SEARCH_LOW_12:\r\nwhat = (char *)"SEARCH_LOW_12";\r\nbreak;\r\ncase SEND_VOLUME_TAG:\r\nwhat = (char *)"SEND_VOLUME_TAG";\r\nbreak;\r\ncase READ_ELEMENT_STATUS:\r\nwhat = (char *)"READ_ELEMENT_STATUS";\r\nbreak;\r\ncase GPCMD_READ_CD_MSF:\r\nwhat = (char *)"READ CD MSF";\r\nbreak;\r\ncase GPCMD_SCAN:\r\nwhat = (char *)"SCAN";\r\nbreak;\r\ncase GPCMD_SET_SPEED:\r\nwhat = (char *)"SET CD SPEED";\r\nbreak;\r\ncase GPCMD_MECHANISM_STATUS:\r\nwhat = (char *)"MECHANISM STATUS";\r\nbreak;\r\ncase GPCMD_READ_CD:\r\nwhat = (char *)"READ CD";\r\nbreak;\r\ncase 0xE1:\r\nwhat = (char *)"WRITE CONTINUE";\r\nbreak;\r\ncase WRITE_LONG_2:\r\nwhat = (char *)"WRITE_LONG_2";\r\nbreak;\r\ncase VENDOR_CMND:\r\nwhat = (char *)"Realtek's vendor command";\r\nbreak;\r\ndefault:\r\nwhat = (char *)"(unknown command)";\r\nunknown_cmd = 1;\r\nbreak;\r\n}\r\nif (srb->cmnd[0] != TEST_UNIT_READY)\r\nRTS51X_DEBUGP("Command %s (%d bytes)\n", what, srb->cmd_len);\r\nif (unknown_cmd) {\r\nRTS51X_DEBUGP("");\r\nfor (i = 0; i < srb->cmd_len && i < 16; i++)\r\nRTS51X_DEBUGPN(" %02x", srb->cmnd[i]);\r\nRTS51X_DEBUGPN("\n");\r\n}\r\n}\r\nvoid rts51x_set_sense_type(struct rts51x_chip *chip, unsigned int lun, int sense_type)\r\n{\r\nswitch (sense_type) {\r\ncase SENSE_TYPE_MEDIA_CHANGE:\r\nrts51x_set_sense_data(chip, lun, CUR_ERR, 0x06, 0, 0x28, 0, 0, 0);\r\nbreak;\r\ncase SENSE_TYPE_MEDIA_NOT_PRESENT:\r\nrts51x_set_sense_data(chip, lun, CUR_ERR, 0x02, 0, 0x3A, 0, 0, 0);\r\nbreak;\r\ncase SENSE_TYPE_MEDIA_LBA_OVER_RANGE:\r\nrts51x_set_sense_data(chip, lun, CUR_ERR, 0x05, 0, 0x21, 0, 0, 0);\r\nbreak;\r\ncase SENSE_TYPE_MEDIA_LUN_NOT_SUPPORT:\r\nrts51x_set_sense_data(chip, lun, CUR_ERR, 0x05, 0, 0x25, 0, 0, 0);\r\nbreak;\r\ncase SENSE_TYPE_MEDIA_WRITE_PROTECT:\r\nrts51x_set_sense_data(chip, lun, CUR_ERR, 0x07, 0, 0x27, 0, 0, 0);\r\nbreak;\r\ncase SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR:\r\nrts51x_set_sense_data(chip, lun, CUR_ERR, 0x03, 0, 0x11, 0, 0, 0);\r\nbreak;\r\ncase SENSE_TYPE_MEDIA_WRITE_ERR:\r\nrts51x_set_sense_data(chip, lun, CUR_ERR, 0x03, 0, 0x0C, 0x02, 0, 0);\r\nbreak;\r\ncase SENSE_TYPE_MEDIA_INVALID_CMD_FIELD:\r\nrts51x_set_sense_data(chip, lun, CUR_ERR, ILGAL_REQ, 0,\r\nASC_INVLD_CDB, ASCQ_INVLD_CDB, CDB_ILLEGAL, 1);\r\nbreak;\r\ncase SENSE_TYPE_FORMAT_CMD_FAILED:\r\nrts51x_set_sense_data(chip, lun, CUR_ERR, 0x03, 0, 0x31, 0x01, 0, 0);\r\nbreak;\r\n#ifdef SUPPORT_MAGIC_GATE\r\ncase SENSE_TYPE_MG_KEY_FAIL_NOT_ESTAB:\r\nrts51x_set_sense_data(chip, lun, CUR_ERR, 0x05, 0, 0x6F, 0x02, 0, 0);\r\nbreak;\r\ncase SENSE_TYPE_MG_KEY_FAIL_NOT_AUTHEN:\r\nrts51x_set_sense_data(chip, lun, CUR_ERR, 0x05, 0, 0x6F, 0x00, 0, 0);\r\nbreak;\r\ncase SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM:\r\nrts51x_set_sense_data(chip, lun, CUR_ERR, 0x02, 0, 0x30, 0x00, 0, 0);\r\nbreak;\r\ncase SENSE_TYPE_MG_WRITE_ERR:\r\nrts51x_set_sense_data(chip, lun, CUR_ERR, 0x03, 0, 0x0C, 0x00, 0, 0);\r\nbreak;\r\n#endif\r\ncase SENSE_TYPE_NO_SENSE:\r\ndefault:\r\nrts51x_set_sense_data(chip, lun, CUR_ERR, 0, 0, 0, 0, 0, 0);\r\nbreak;\r\n}\r\n}\r\nvoid rts51x_set_sense_data(struct rts51x_chip *chip, unsigned int lun, u8 err_code,\r\nu8 sense_key, u32 info, u8 asc, u8 ascq, u8 sns_key_info0,\r\nu16 sns_key_info1)\r\n{\r\nstruct sense_data_t *sense = &(chip->sense_buffer[lun]);\r\nsense->err_code = err_code;\r\nsense->sense_key = sense_key;\r\nsense->info[0] = (u8) (info >> 24);\r\nsense->info[1] = (u8) (info >> 16);\r\nsense->info[2] = (u8) (info >> 8);\r\nsense->info[3] = (u8) info;\r\nsense->ad_sense_len = sizeof(struct sense_data_t) - 8;\r\nsense->asc = asc;\r\nsense->ascq = ascq;\r\nif (sns_key_info0 != 0) {\r\nsense->sns_key_info[0] = SKSV | sns_key_info0;\r\nsense->sns_key_info[1] = (sns_key_info1 & 0xf0) >> 8;\r\nsense->sns_key_info[2] = sns_key_info1 & 0x0f;\r\n}\r\n}\r\nstatic int test_unit_ready(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nunsigned int lun = SCSI_LUN(srb);\r\nrts51x_init_cards(chip);\r\nif (!check_card_ready(chip, lun)) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\r\nreturn TRANSPORT_FAILED;\r\n}\r\nif (!check_lun_mc(chip, lun)) {\r\nset_lun_mc(chip, lun);\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_CHANGE);\r\nreturn TRANSPORT_FAILED;\r\n}\r\nreturn TRANSPORT_GOOD;\r\n}\r\nstatic int inquiry(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nunsigned int lun = SCSI_LUN(srb);\r\nchar *inquiry_default = (char *)"Generic-xD/SD/M.S. 1.00 ";\r\nchar *inquiry_string;\r\nunsigned char sendbytes;\r\nunsigned char *buf;\r\nu8 card = rts51x_get_lun_card(chip, lun);\r\nint pro_formatter_flag = 0;\r\nunsigned char inquiry_buf[] = {\r\nQULIFIRE | DRCT_ACCESS_DEV,\r\nRMB_DISC | 0x0D,\r\n0x00,\r\n0x01,\r\n0x1f,\r\n0x02,\r\n0,\r\nREL_ADR | WBUS_32 | WBUS_16 | SYNC | LINKED | CMD_QUE | SFT_RE,\r\n};\r\ninquiry_string = inquiry_default;\r\nbuf = vmalloc(scsi_bufflen(srb));\r\nif (buf == NULL)\r\nTRACE_RET(chip, TRANSPORT_ERROR);\r\nif (MS_FORMATTER_ENABLED(chip) && (get_lun2card(chip, lun) & MS_CARD)) {\r\nif (!card || (card == MS_CARD))\r\npro_formatter_flag = 1;\r\n}\r\nif (pro_formatter_flag) {\r\nif (scsi_bufflen(srb) < 56)\r\nsendbytes = (unsigned char)(scsi_bufflen(srb));\r\nelse\r\nsendbytes = 56;\r\n} else {\r\nif (scsi_bufflen(srb) < 36)\r\nsendbytes = (unsigned char)(scsi_bufflen(srb));\r\nelse\r\nsendbytes = 36;\r\n}\r\nif (sendbytes > 8) {\r\nmemcpy(buf, inquiry_buf, 8);\r\nmemcpy(buf + 8, inquiry_string, sendbytes - 8);\r\nif (pro_formatter_flag)\r\nbuf[4] = 0x33;\r\n} else {\r\nmemcpy(buf, inquiry_buf, sendbytes);\r\n}\r\nif (pro_formatter_flag) {\r\nif (sendbytes > 36)\r\nmemcpy(buf + 36, formatter_inquiry_str, sendbytes - 36);\r\n}\r\nscsi_set_resid(srb, 0);\r\nrts51x_set_xfer_buf(buf, scsi_bufflen(srb), srb);\r\nvfree(buf);\r\nreturn TRANSPORT_GOOD;\r\n}\r\nstatic int start_stop_unit(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nunsigned int lun = SCSI_LUN(srb);\r\nscsi_set_resid(srb, scsi_bufflen(srb));\r\nif (srb->cmnd[1] == 1)\r\nreturn TRANSPORT_GOOD;\r\nswitch (srb->cmnd[0x4]) {\r\ncase STOP_MEDIUM:\r\nreturn TRANSPORT_GOOD;\r\ncase UNLOAD_MEDIUM:\r\nif (check_card_ready(chip, lun))\r\nrts51x_eject_card(chip, lun);\r\nreturn TRANSPORT_GOOD;\r\ncase MAKE_MEDIUM_READY:\r\ncase LOAD_MEDIUM:\r\nif (check_card_ready(chip, lun)) {\r\nreturn TRANSPORT_GOOD;\r\n} else {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nbreak;\r\n}\r\nTRACE_RET(chip, TRANSPORT_ERROR);\r\n}\r\nstatic int allow_medium_removal(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nint prevent;\r\nprevent = srb->cmnd[4] & 0x1;\r\nscsi_set_resid(srb, 0);\r\nif (prevent) {\r\nrts51x_set_sense_type(chip, SCSI_LUN(srb),\r\nSENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nreturn TRANSPORT_GOOD;\r\n}\r\nstatic void ms_mode_sense(struct rts51x_chip *chip, u8 cmd,\r\nint lun, u8 *buf, int buf_len)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nint sys_info_offset;\r\nint data_size = buf_len;\r\nint support_format = 0;\r\nint i = 0;\r\nif (cmd == MODE_SENSE) {\r\nsys_info_offset = 8;\r\nif (data_size > 0x68)\r\ndata_size = 0x68;\r\nbuf[i++] = 0x67;\r\n} else {\r\nsys_info_offset = 12;\r\nif (data_size > 0x6C)\r\ndata_size = 0x6C;\r\nbuf[i++] = 0x00;\r\nbuf[i++] = 0x6A;\r\n}\r\nif (check_card_ready(chip, lun)) {\r\nif (CHK_MSXC(ms_card)) {\r\nsupport_format = 1;\r\nbuf[i++] = 0x40;\r\n} else if (CHK_MSPRO(ms_card)) {\r\nsupport_format = 1;\r\nbuf[i++] = 0x20;\r\n} else {\r\nbuf[i++] = 0x10;\r\n}\r\nif (check_card_wp(chip, lun))\r\nbuf[i++] = 0x80;\r\nelse\r\nbuf[i++] = 0x00;\r\n} else {\r\nbuf[i++] = 0x00;\r\nbuf[i++] = 0x00;\r\n}\r\nbuf[i++] = 0x00;\r\nif (cmd == MODE_SENSE_10) {\r\nbuf[i++] = 0x00;\r\nbuf[i++] = 0x00;\r\nbuf[i++] = 0x00;\r\nif (data_size >= 9)\r\nbuf[i++] = 0x20;\r\nif (data_size >= 10)\r\nbuf[i++] = 0x62;\r\nif (data_size >= 11)\r\nbuf[i++] = 0x00;\r\nif (data_size >= 12) {\r\nif (support_format)\r\nbuf[i++] = 0xC0;\r\nelse\r\nbuf[i++] = 0x00;\r\n}\r\n} else {\r\nif (data_size >= 5)\r\nbuf[i++] = 0x20;\r\nif (data_size >= 6)\r\nbuf[i++] = 0x62;\r\nif (data_size >= 7)\r\nbuf[i++] = 0x00;\r\nif (data_size >= 8) {\r\nif (support_format)\r\nbuf[i++] = 0xC0;\r\nelse\r\nbuf[i++] = 0x00;\r\n}\r\n}\r\nif (data_size > sys_info_offset) {\r\nint len = data_size - sys_info_offset;\r\nlen = (len < 96) ? len : 96;\r\nmemcpy(buf + sys_info_offset, ms_card->raw_sys_info, len);\r\n}\r\n}\r\nstatic int mode_sense(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nunsigned int lun = SCSI_LUN(srb);\r\nunsigned int dataSize;\r\nint status;\r\nint pro_formatter_flag;\r\nunsigned char pageCode, *buf;\r\nu8 card = rts51x_get_lun_card(chip, lun);\r\nif (!check_card_ready(chip, lun)) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\r\nscsi_set_resid(srb, scsi_bufflen(srb));\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\npro_formatter_flag = 0;\r\ndataSize = 8;\r\nif ((get_lun2card(chip, lun) & MS_CARD)) {\r\nif (!card || (card == MS_CARD)) {\r\ndataSize = 108;\r\nif (chip->option.rts51x_mspro_formatter_enable)\r\npro_formatter_flag = 1;\r\n}\r\n}\r\nbuf = kmalloc(dataSize, GFP_KERNEL);\r\nif (buf == NULL)\r\nTRACE_RET(chip, TRANSPORT_ERROR);\r\npageCode = srb->cmnd[2] & 0x3f;\r\nif ((pageCode == 0x3F) || (pageCode == 0x1C) ||\r\n(pageCode == 0x00) || (pro_formatter_flag && (pageCode == 0x20))) {\r\nif (srb->cmnd[0] == MODE_SENSE) {\r\nif ((pageCode == 0x3F) || (pageCode == 0x20)) {\r\nms_mode_sense(chip, srb->cmnd[0], lun, buf,\r\ndataSize);\r\n} else {\r\ndataSize = 4;\r\nbuf[0] = 0x03;\r\nbuf[1] = 0x00;\r\nif (check_card_wp(chip, lun))\r\nbuf[2] = 0x80;\r\nelse\r\nbuf[3] = 0x00;\r\n}\r\n} else {\r\nif ((pageCode == 0x3F) || (pageCode == 0x20)) {\r\nms_mode_sense(chip, srb->cmnd[0], lun, buf,\r\ndataSize);\r\n} else {\r\ndataSize = 8;\r\nbuf[0] = 0x00;\r\nbuf[1] = 0x06;\r\nbuf[2] = 0x00;\r\nif (check_card_wp(chip, lun))\r\nbuf[3] = 0x80;\r\nelse\r\nbuf[3] = 0x00;\r\nbuf[4] = 0x00;\r\nbuf[5] = 0x00;\r\nbuf[6] = 0x00;\r\nbuf[7] = 0x00;\r\n}\r\n}\r\nstatus = TRANSPORT_GOOD;\r\n} else {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nscsi_set_resid(srb, scsi_bufflen(srb));\r\nstatus = TRANSPORT_FAILED;\r\n}\r\nif (status == TRANSPORT_GOOD) {\r\nunsigned int len = min(scsi_bufflen(srb), dataSize);\r\nrts51x_set_xfer_buf(buf, len, srb);\r\nscsi_set_resid(srb, scsi_bufflen(srb) - len);\r\n}\r\nkfree(buf);\r\nreturn status;\r\n}\r\nstatic int request_sense(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nstruct sense_data_t *sense;\r\nunsigned int lun = SCSI_LUN(srb);\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nunsigned char *tmp, *buf;\r\nsense = &(chip->sense_buffer[lun]);\r\nif ((rts51x_get_lun_card(chip, lun) == MS_CARD)\r\n&& PRO_UNDER_FORMATTING(ms_card)) {\r\nrts51x_mspro_format_sense(chip, lun);\r\n}\r\nbuf = vmalloc(scsi_bufflen(srb));\r\nif (buf == NULL)\r\nTRACE_RET(chip, TRANSPORT_ERROR);\r\ntmp = (unsigned char *)sense;\r\nmemcpy(buf, tmp, scsi_bufflen(srb));\r\nrts51x_set_xfer_buf(buf, scsi_bufflen(srb), srb);\r\nvfree(buf);\r\nscsi_set_resid(srb, 0);\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_NO_SENSE);\r\nreturn TRANSPORT_GOOD;\r\n}\r\nstatic int read_write(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nunsigned int lun = SCSI_LUN(srb);\r\nint retval;\r\nu32 start_sec;\r\nu16 sec_cnt;\r\nif (!check_card_ready(chip, lun) || (chip->capacity[lun] == 0)) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nif (!check_lun_mc(chip, lun)) {\r\nset_lun_mc(chip, lun);\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_CHANGE);\r\nreturn TRANSPORT_FAILED;\r\n}\r\nrts51x_prepare_run(chip);\r\nRTS51X_SET_STAT(chip, STAT_RUN);\r\nif ((srb->cmnd[0] == READ_10) || (srb->cmnd[0] == WRITE_10)) {\r\nstart_sec =\r\n((u32) srb->cmnd[2] << 24) |\r\n((u32) srb->cmnd[3] << 16) |\r\n((u32) srb->cmnd[4] << 8) |\r\n((u32) srb->cmnd[5]);\r\nsec_cnt = ((u16) (srb->cmnd[7]) << 8) | srb->cmnd[8];\r\n} else if ((srb->cmnd[0] == READ_6) || (srb->cmnd[0] == WRITE_6)) {\r\nstart_sec = ((u32) (srb->cmnd[1] & 0x1F) << 16) |\r\n((u32) srb->cmnd[2] << 8) | ((u32) srb->cmnd[3]);\r\nsec_cnt = srb->cmnd[4];\r\n} else if ((srb->cmnd[0] == VENDOR_CMND) &&\r\n(srb->cmnd[1] == SCSI_APP_CMD) &&\r\n((srb->cmnd[2] == PP_READ10) ||\r\n(srb->cmnd[2] == PP_WRITE10))) {\r\nstart_sec = ((u32) srb->cmnd[4] << 24) |\r\n((u32) srb->cmnd[5] << 16) |\r\n((u32) srb->cmnd[6] << 8) |\r\n((u32) srb->cmnd[7]);\r\nsec_cnt = ((u16) (srb->cmnd[9]) << 8) | srb->cmnd[10];\r\n} else {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nif ((start_sec > chip->capacity[lun]) ||\r\n((start_sec + sec_cnt) > chip->capacity[lun])) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_LBA_OVER_RANGE);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nif (sec_cnt == 0) {\r\nscsi_set_resid(srb, 0);\r\nreturn TRANSPORT_GOOD;\r\n}\r\nif ((srb->sc_data_direction == DMA_TO_DEVICE)\r\n&& check_card_wp(chip, lun)) {\r\nRTS51X_DEBUGP("Write protected card!\n");\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_WRITE_PROTECT);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nretval = rts51x_card_rw(srb, chip, start_sec, sec_cnt);\r\nif (retval != STATUS_SUCCESS) {\r\nif (srb->sc_data_direction == DMA_FROM_DEVICE) {\r\nrts51x_set_sense_type(chip, lun,\r\nSENSE_TYPE_MEDIA_UNRECOVER_READ_ERR);\r\n} else {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_WRITE_ERR);\r\n}\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nscsi_set_resid(srb, 0);\r\nreturn TRANSPORT_GOOD;\r\n}\r\nstatic int read_format_capacity(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nunsigned char *buf;\r\nunsigned int lun = SCSI_LUN(srb);\r\nunsigned int buf_len;\r\nu8 card = rts51x_get_lun_card(chip, lun);\r\nint desc_cnt;\r\nint i = 0;\r\nif (!check_card_ready(chip, lun)) {\r\nif (!chip->option.rts51x_mspro_formatter_enable) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\n}\r\nbuf_len = (scsi_bufflen(srb) > 12) ? 0x14 : 12;\r\nbuf = kmalloc(buf_len, GFP_KERNEL);\r\nif (buf == NULL)\r\nTRACE_RET(chip, TRANSPORT_ERROR);\r\nbuf[i++] = 0;\r\nbuf[i++] = 0;\r\nbuf[i++] = 0;\r\nif ((buf_len > 12) && chip->option.rts51x_mspro_formatter_enable &&\r\n(chip->lun2card[lun] & MS_CARD) && (!card || (card == MS_CARD))) {\r\nbuf[i++] = 0x10;\r\ndesc_cnt = 2;\r\n} else {\r\nbuf[i++] = 0x08;\r\ndesc_cnt = 1;\r\n}\r\nwhile (desc_cnt) {\r\nif (check_card_ready(chip, lun)) {\r\nbuf[i++] = (unsigned char)((chip->capacity[lun]) >> 24);\r\nbuf[i++] = (unsigned char)((chip->capacity[lun]) >> 16);\r\nbuf[i++] = (unsigned char)((chip->capacity[lun]) >> 8);\r\nbuf[i++] = (unsigned char)(chip->capacity[lun]);\r\nif (desc_cnt == 2)\r\nbuf[i++] = 2;\r\nelse\r\nbuf[i++] = 0;\r\n} else {\r\nbuf[i++] = 0xFF;\r\nbuf[i++] = 0xFF;\r\nbuf[i++] = 0xFF;\r\nbuf[i++] = 0xFF;\r\nif (desc_cnt == 2)\r\nbuf[i++] = 3;\r\nelse\r\nbuf[i++] = 0;\r\n}\r\nbuf[i++] = 0x00;\r\nbuf[i++] = 0x02;\r\nbuf[i++] = 0x00;\r\ndesc_cnt--;\r\n}\r\nbuf_len = min(scsi_bufflen(srb), buf_len);\r\nrts51x_set_xfer_buf(buf, buf_len, srb);\r\nkfree(buf);\r\nscsi_set_resid(srb, scsi_bufflen(srb) - buf_len);\r\nreturn TRANSPORT_GOOD;\r\n}\r\nstatic int read_capacity(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nunsigned char *buf;\r\nunsigned int lun = SCSI_LUN(srb);\r\nif (!check_card_ready(chip, lun)) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nif (!check_lun_mc(chip, lun)) {\r\nset_lun_mc(chip, lun);\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_CHANGE);\r\nreturn TRANSPORT_FAILED;\r\n}\r\nbuf = kmalloc(8, GFP_KERNEL);\r\nif (buf == NULL)\r\nTRACE_RET(chip, TRANSPORT_ERROR);\r\nbuf[0] = (unsigned char)((chip->capacity[lun] - 1) >> 24);\r\nbuf[1] = (unsigned char)((chip->capacity[lun] - 1) >> 16);\r\nbuf[2] = (unsigned char)((chip->capacity[lun] - 1) >> 8);\r\nbuf[3] = (unsigned char)(chip->capacity[lun] - 1);\r\nbuf[4] = 0x00;\r\nbuf[5] = 0x00;\r\nbuf[6] = 0x02;\r\nbuf[7] = 0x00;\r\nrts51x_set_xfer_buf(buf, scsi_bufflen(srb), srb);\r\nkfree(buf);\r\nscsi_set_resid(srb, 0);\r\nreturn TRANSPORT_GOOD;\r\n}\r\nstatic int get_dev_status(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nunsigned int lun = SCSI_LUN(srb);\r\nunsigned int buf_len;\r\nu8 status[32] = { 0 };\r\nrts51x_pp_status(chip, lun, status, 32);\r\nbuf_len = min(scsi_bufflen(srb), (unsigned int)sizeof(status));\r\nrts51x_set_xfer_buf(status, buf_len, srb);\r\nscsi_set_resid(srb, scsi_bufflen(srb) - buf_len);\r\nreturn TRANSPORT_GOOD;\r\n}\r\nstatic int read_status(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nu8 rts51x_status[16];\r\nunsigned int buf_len;\r\nunsigned int lun = SCSI_LUN(srb);\r\nrts51x_read_status(chip, lun, rts51x_status, 16);\r\nbuf_len = min(scsi_bufflen(srb), (unsigned int)sizeof(rts51x_status));\r\nrts51x_set_xfer_buf(rts51x_status, buf_len, srb);\r\nscsi_set_resid(srb, scsi_bufflen(srb) - buf_len);\r\nreturn TRANSPORT_GOOD;\r\n}\r\nstatic int read_mem(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nunsigned int lun = SCSI_LUN(srb);\r\nunsigned short addr, len, i;\r\nint retval;\r\nu8 *buf;\r\nrts51x_prepare_run(chip);\r\nRTS51X_SET_STAT(chip, STAT_RUN);\r\naddr = ((u16) srb->cmnd[2] << 8) | srb->cmnd[3];\r\nlen = ((u16) srb->cmnd[4] << 8) | srb->cmnd[5];\r\nif (addr < 0xe000) {\r\nRTS51X_DEBUGP("filter!addr=0x%x\n", addr);\r\nreturn TRANSPORT_GOOD;\r\n}\r\nbuf = vmalloc(len);\r\nif (!buf)\r\nTRACE_RET(chip, TRANSPORT_ERROR);\r\nfor (i = 0; i < len; i++) {\r\nretval = rts51x_ep0_read_register(chip, addr + i, buf + i);\r\nif (retval != STATUS_SUCCESS) {\r\nvfree(buf);\r\nrts51x_set_sense_type(chip, lun,\r\nSENSE_TYPE_MEDIA_UNRECOVER_READ_ERR);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\n}\r\nlen = (unsigned short)min(scsi_bufflen(srb), (unsigned int)len);\r\nrts51x_set_xfer_buf(buf, len, srb);\r\nscsi_set_resid(srb, scsi_bufflen(srb) - len);\r\nvfree(buf);\r\nreturn TRANSPORT_GOOD;\r\n}\r\nstatic int write_mem(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nunsigned int lun = SCSI_LUN(srb);\r\nunsigned short addr, len, i;\r\nint retval;\r\nu8 *buf;\r\nrts51x_prepare_run(chip);\r\nRTS51X_SET_STAT(chip, STAT_RUN);\r\naddr = ((u16) srb->cmnd[2] << 8) | srb->cmnd[3];\r\nlen = ((u16) srb->cmnd[4] << 8) | srb->cmnd[5];\r\nif (addr < 0xe000) {\r\nRTS51X_DEBUGP("filter!addr=0x%x\n", addr);\r\nreturn TRANSPORT_GOOD;\r\n}\r\nlen = (unsigned short)min(scsi_bufflen(srb), (unsigned int)len);\r\nbuf = vmalloc(len);\r\nif (!buf)\r\nTRACE_RET(chip, TRANSPORT_ERROR);\r\nrts51x_get_xfer_buf(buf, len, srb);\r\nfor (i = 0; i < len; i++) {\r\nretval =\r\nrts51x_ep0_write_register(chip, addr + i, 0xFF, buf[i]);\r\nif (retval != STATUS_SUCCESS) {\r\nvfree(buf);\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_WRITE_ERR);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\n}\r\nvfree(buf);\r\nscsi_set_resid(srb, scsi_bufflen(srb) - len);\r\nreturn TRANSPORT_GOOD;\r\n}\r\nstatic int get_sd_csd(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &(chip->sd_card);\r\nunsigned int lun = SCSI_LUN(srb);\r\nif (!check_card_ready(chip, lun)) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nif (rts51x_get_lun_card(chip, lun) != SD_CARD) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nscsi_set_resid(srb, 0);\r\nrts51x_set_xfer_buf(sd_card->raw_csd, scsi_bufflen(srb), srb);\r\nreturn TRANSPORT_GOOD;\r\n}\r\nstatic int read_phy_register(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nint retval;\r\nu8 addr, len, i;\r\nu8 *buf;\r\nrts51x_prepare_run(chip);\r\nRTS51X_SET_STAT(chip, STAT_RUN);\r\naddr = srb->cmnd[5];\r\nlen = srb->cmnd[7];\r\nif (len) {\r\nbuf = vmalloc(len);\r\nif (!buf)\r\nTRACE_RET(chip, TRANSPORT_ERROR);\r\nfor (i = 0; i < len; i++) {\r\nretval =\r\nrts51x_read_phy_register(chip, addr + i, buf + i);\r\nif (retval != STATUS_SUCCESS) {\r\nvfree(buf);\r\nrts51x_set_sense_type(chip, SCSI_LUN(srb),\r\nSENSE_TYPE_MEDIA_UNRECOVER_READ_ERR);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\n}\r\nlen = min(scsi_bufflen(srb), (unsigned int)len);\r\nrts51x_set_xfer_buf(buf, len, srb);\r\nscsi_set_resid(srb, scsi_bufflen(srb) - len);\r\nvfree(buf);\r\n}\r\nreturn TRANSPORT_GOOD;\r\n}\r\nstatic int write_phy_register(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nint retval;\r\nu8 addr, len, i;\r\nu8 *buf;\r\nrts51x_prepare_run(chip);\r\nRTS51X_SET_STAT(chip, STAT_RUN);\r\naddr = srb->cmnd[5];\r\nlen = srb->cmnd[7];\r\nif (len) {\r\nlen = min(scsi_bufflen(srb), (unsigned int)len);\r\nbuf = vmalloc(len);\r\nif (buf == NULL)\r\nTRACE_RET(chip, TRANSPORT_ERROR);\r\nrts51x_get_xfer_buf(buf, len, srb);\r\nscsi_set_resid(srb, scsi_bufflen(srb) - len);\r\nfor (i = 0; i < len; i++) {\r\nretval =\r\nrts51x_write_phy_register(chip, addr + i, buf[i]);\r\nif (retval != STATUS_SUCCESS) {\r\nvfree(buf);\r\nrts51x_set_sense_type(chip, SCSI_LUN(srb),\r\nSENSE_TYPE_MEDIA_WRITE_ERR);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\n}\r\nvfree(buf);\r\n}\r\nreturn TRANSPORT_GOOD;\r\n}\r\nstatic int get_card_bus_width(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nunsigned int lun = SCSI_LUN(srb);\r\nu8 card, bus_width;\r\nif (!check_card_ready(chip, lun)) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\ncard = rts51x_get_lun_card(chip, lun);\r\nif ((card == SD_CARD) || (card == MS_CARD)) {\r\nbus_width = chip->card_bus_width[lun];\r\n} else {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nscsi_set_resid(srb, 0);\r\nrts51x_set_xfer_buf(&bus_width, scsi_bufflen(srb), srb);\r\nreturn TRANSPORT_GOOD;\r\n}\r\nstatic int trace_msg_cmd(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nunsigned char *buf = NULL;\r\nu8 clear;\r\nunsigned int buf_len;\r\nbuf_len =\r\n4 +\r\n((2 + MSG_FUNC_LEN + MSG_FILE_LEN + TIME_VAL_LEN) * TRACE_ITEM_CNT);\r\nif ((scsi_bufflen(srb) < buf_len) || (scsi_sglist(srb) == NULL)) {\r\nrts51x_set_sense_type(chip, SCSI_LUN(srb),\r\nSENSE_TYPE_MEDIA_UNRECOVER_READ_ERR);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nclear = srb->cmnd[2];\r\nbuf = vmalloc(scsi_bufflen(srb));\r\nif (buf == NULL)\r\nTRACE_RET(chip, TRANSPORT_ERROR);\r\nrts51x_trace_msg(chip, buf, clear);\r\nrts51x_set_xfer_buf(buf, scsi_bufflen(srb), srb);\r\nvfree(buf);\r\nscsi_set_resid(srb, 0);\r\nreturn TRANSPORT_GOOD;\r\n}\r\nstatic int rw_mem_cmd_buf(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nint retval = STATUS_SUCCESS;\r\nunsigned int lun = SCSI_LUN(srb);\r\nu8 cmd_type, mask, value, idx, mode, len;\r\nu16 addr;\r\nu32 timeout;\r\nrts51x_prepare_run(chip);\r\nRTS51X_SET_STAT(chip, STAT_RUN);\r\nswitch (srb->cmnd[3]) {\r\ncase INIT_BATCHCMD:\r\nrts51x_init_cmd(chip);\r\nbreak;\r\ncase ADD_BATCHCMD:\r\ncmd_type = srb->cmnd[4];\r\nif (cmd_type > 2) {\r\nrts51x_set_sense_type(chip, lun,\r\nSENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\naddr = (srb->cmnd[5] << 8) | srb->cmnd[6];\r\nmask = srb->cmnd[7];\r\nvalue = srb->cmnd[8];\r\nrts51x_add_cmd(chip, cmd_type, addr, mask, value);\r\nbreak;\r\ncase SEND_BATCHCMD:\r\nmode = srb->cmnd[4];\r\nlen = srb->cmnd[5];\r\ntimeout =\r\n((u32) srb->cmnd[6] << 24) | ((u32) srb->\r\ncmnd[7] << 16) | ((u32) srb->\r\ncmnd[8] <<\r\n8) | ((u32)\r\nsrb->\r\ncmnd\r\n[9]);\r\nretval = rts51x_send_cmd(chip, mode, 1000);\r\nif (retval != STATUS_SUCCESS) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_WRITE_ERR);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nif (mode & STAGE_R) {\r\nretval = rts51x_get_rsp(chip, len, timeout);\r\nif (retval != STATUS_SUCCESS) {\r\nrts51x_set_sense_type(chip, lun,\r\nSENSE_TYPE_MEDIA_UNRECOVER_READ_ERR);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\n}\r\nbreak;\r\ncase GET_BATCHRSP:\r\nidx = srb->cmnd[4];\r\nvalue = chip->rsp_buf[idx];\r\nif (scsi_bufflen(srb) < 1) {\r\nrts51x_set_sense_type(chip, lun,\r\nSENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nrts51x_set_xfer_buf(&value, 1, srb);\r\nscsi_set_resid(srb, 0);\r\nbreak;\r\ndefault:\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nif (retval != STATUS_SUCCESS) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_WRITE_ERR);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nreturn TRANSPORT_GOOD;\r\n}\r\nstatic int suit_cmd(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nint result;\r\nswitch (srb->cmnd[3]) {\r\ncase INIT_BATCHCMD:\r\ncase ADD_BATCHCMD:\r\ncase SEND_BATCHCMD:\r\ncase GET_BATCHRSP:\r\nresult = rw_mem_cmd_buf(srb, chip);\r\nbreak;\r\ndefault:\r\nresult = TRANSPORT_ERROR;\r\n}\r\nreturn result;\r\n}\r\nstatic int app_cmd(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nint result;\r\nswitch (srb->cmnd[2]) {\r\ncase PP_READ10:\r\ncase PP_WRITE10:\r\nresult = read_write(srb, chip);\r\nbreak;\r\ncase SUIT_CMD:\r\nresult = suit_cmd(srb, chip);\r\nbreak;\r\ncase READ_PHY:\r\nresult = read_phy_register(srb, chip);\r\nbreak;\r\ncase WRITE_PHY:\r\nresult = write_phy_register(srb, chip);\r\nbreak;\r\ncase GET_DEV_STATUS:\r\nresult = get_dev_status(srb, chip);\r\nbreak;\r\ndefault:\r\nrts51x_set_sense_type(chip, SCSI_LUN(srb),\r\nSENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nreturn result;\r\n}\r\nstatic int vendor_cmnd(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nint result = TRANSPORT_GOOD;\r\nswitch (srb->cmnd[1]) {\r\ncase READ_STATUS:\r\nresult = read_status(srb, chip);\r\nbreak;\r\ncase READ_MEM:\r\nresult = read_mem(srb, chip);\r\nbreak;\r\ncase WRITE_MEM:\r\nresult = write_mem(srb, chip);\r\nbreak;\r\ncase GET_BUS_WIDTH:\r\nresult = get_card_bus_width(srb, chip);\r\nbreak;\r\ncase GET_SD_CSD:\r\nresult = get_sd_csd(srb, chip);\r\nbreak;\r\n#ifdef _MSG_TRACE\r\ncase TRACE_MSG:\r\nresult = trace_msg_cmd(srb, chip);\r\nbreak;\r\n#endif\r\ncase SCSI_APP_CMD:\r\nresult = app_cmd(srb, chip);\r\nbreak;\r\ndefault:\r\nrts51x_set_sense_type(chip, SCSI_LUN(srb),\r\nSENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nreturn result;\r\n}\r\nstatic int ms_format_cmnd(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nunsigned int lun = SCSI_LUN(srb);\r\nint retval, quick_format;\r\nif (rts51x_get_lun_card(chip, lun) != MS_CARD) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_LUN_NOT_SUPPORT);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nif ((srb->cmnd[3] != 0x4D) || (srb->cmnd[4] != 0x47)\r\n|| (srb->cmnd[5] != 0x66) || (srb->cmnd[6] != 0x6D)\r\n|| (srb->cmnd[7] != 0x74)) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nif (srb->cmnd[8] & 0x01)\r\nquick_format = 0;\r\nelse\r\nquick_format = 1;\r\nif (!(chip->card_ready & MS_CARD)) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nif (chip->card_wp & MS_CARD) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_WRITE_PROTECT);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nif (!CHK_MSPRO(ms_card)) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_LUN_NOT_SUPPORT);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nrts51x_prepare_run(chip);\r\nRTS51X_SET_STAT(chip, STAT_RUN);\r\nretval = rts51x_mspro_format(srb, chip, MS_SHORT_DATA_LEN, quick_format);\r\nif (retval != STATUS_SUCCESS) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_FORMAT_CMD_FAILED);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nscsi_set_resid(srb, 0);\r\nreturn TRANSPORT_GOOD;\r\n}\r\nstatic int get_ms_information(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nunsigned int lun = SCSI_LUN(srb);\r\nu8 dev_info_id, data_len;\r\nu8 *buf;\r\nunsigned int buf_len;\r\nint i;\r\nif (!check_card_ready(chip, lun)) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nif ((rts51x_get_lun_card(chip, lun) != MS_CARD)) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_LUN_NOT_SUPPORT);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nif ((srb->cmnd[2] != 0xB0) || (srb->cmnd[4] != 0x4D) ||\r\n(srb->cmnd[5] != 0x53) || (srb->cmnd[6] != 0x49) ||\r\n(srb->cmnd[7] != 0x44)) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\ndev_info_id = srb->cmnd[3];\r\nif ((CHK_MSXC(ms_card) && (dev_info_id == 0x10)) ||\r\n(!CHK_MSXC(ms_card) && (dev_info_id == 0x13)) ||\r\n!CHK_MSPRO(ms_card)) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nif (dev_info_id == 0x15)\r\nbuf_len = data_len = 0x3A;\r\nelse\r\nbuf_len = data_len = 0x6A;\r\nbuf = kmalloc(buf_len, GFP_KERNEL);\r\nif (!buf)\r\nTRACE_RET(chip, TRANSPORT_ERROR);\r\ni = 0;\r\nbuf[i++] = 0x00;\r\nbuf[i++] = data_len;\r\nif (CHK_MSXC(ms_card))\r\nbuf[i++] = 0x03;\r\nelse\r\nbuf[i++] = 0x02;\r\nbuf[i++] = 0x01;\r\nbuf[i++] = 0x00;\r\nbuf[i++] = 0x00;\r\nbuf[i++] = 0x00;\r\nbuf[i++] = 0x01;\r\nbuf[i++] = dev_info_id;\r\nif (dev_info_id == 0x15)\r\ndata_len = 0x31;\r\nelse\r\ndata_len = 0x61;\r\nbuf[i++] = 0x00;\r\nbuf[i++] = data_len;\r\nbuf[i++] = 0x80;\r\nif ((dev_info_id == 0x10) || (dev_info_id == 0x13)) {\r\nmemcpy(buf + i, ms_card->raw_sys_info, 96);\r\n} else {\r\nmemcpy(buf + i, ms_card->raw_model_name, 48);\r\n}\r\nrts51x_set_xfer_buf(buf, buf_len, srb);\r\nif (dev_info_id == 0x15)\r\nscsi_set_resid(srb, scsi_bufflen(srb) - 0x3C);\r\nelse\r\nscsi_set_resid(srb, scsi_bufflen(srb) - 0x6C);\r\nkfree(buf);\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int ms_sp_cmnd(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nint retval = TRANSPORT_ERROR;\r\nif (srb->cmnd[2] == MS_FORMAT)\r\nretval = ms_format_cmnd(srb, chip);\r\n#ifdef SUPPORT_PCGL_1P18\r\nelse if (srb->cmnd[2] == GET_MS_INFORMATION)\r\nretval = get_ms_information(srb, chip);\r\n#endif\r\nreturn retval;\r\n}\r\nstatic int sd_extention_cmnd(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nunsigned int lun = SCSI_LUN(srb);\r\nint result;\r\nrts51x_prepare_run(chip);\r\nRTS51X_SET_STAT(chip, STAT_RUN);\r\nrts51x_sd_cleanup_work(chip);\r\nif (!check_card_ready(chip, lun)) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nif ((rts51x_get_lun_card(chip, lun) != SD_CARD)) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_LUN_NOT_SUPPORT);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nswitch (srb->cmnd[0]) {\r\ncase SD_PASS_THRU_MODE:\r\nresult = rts51x_sd_pass_thru_mode(srb, chip);\r\nbreak;\r\ncase SD_EXECUTE_NO_DATA:\r\nresult = rts51x_sd_execute_no_data(srb, chip);\r\nbreak;\r\ncase SD_EXECUTE_READ:\r\nresult = rts51x_sd_execute_read_data(srb, chip);\r\nbreak;\r\ncase SD_EXECUTE_WRITE:\r\nresult = rts51x_sd_execute_write_data(srb, chip);\r\nbreak;\r\ncase SD_GET_RSP:\r\nresult = rts51x_sd_get_cmd_rsp(srb, chip);\r\nbreak;\r\ncase SD_HW_RST:\r\nresult = rts51x_sd_hw_rst(srb, chip);\r\nbreak;\r\ndefault:\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nreturn result;\r\n}\r\nstatic int mg_report_key(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nunsigned int lun = SCSI_LUN(srb);\r\nint retval;\r\nu8 key_format;\r\nrts51x_prepare_run(chip);\r\nRTS51X_SET_STAT(chip, STAT_RUN);\r\nrts51x_ms_cleanup_work(chip);\r\nif (!check_card_ready(chip, lun)) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nif ((rts51x_get_lun_card(chip, lun) != MS_CARD)) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_LUN_NOT_SUPPORT);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nif (srb->cmnd[7] != KC_MG_R_PRO) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nif (!CHK_MSPRO(ms_card)) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nkey_format = srb->cmnd[10] & 0x3F;\r\nswitch (key_format) {\r\ncase KF_GET_LOC_EKB:\r\nif ((scsi_bufflen(srb) == 0x41C) &&\r\n(srb->cmnd[8] == 0x04) && (srb->cmnd[9] == 0x1C)) {\r\nretval = rts51x_mg_get_local_EKB(srb, chip);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n} else {\r\nrts51x_set_sense_type(chip, lun,\r\nSENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nbreak;\r\ncase KF_RSP_CHG:\r\nif ((scsi_bufflen(srb) == 0x24) &&\r\n(srb->cmnd[8] == 0x00) && (srb->cmnd[9] == 0x24)) {\r\nretval = rts51x_mg_get_rsp_chg(srb, chip);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n} else {\r\nrts51x_set_sense_type(chip, lun,\r\nSENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nbreak;\r\ncase KF_GET_ICV:\r\nms_card->mg_entry_num = srb->cmnd[5];\r\nif ((scsi_bufflen(srb) == 0x404) &&\r\n(srb->cmnd[8] == 0x04) &&\r\n(srb->cmnd[9] == 0x04) &&\r\n(srb->cmnd[2] == 0x00) &&\r\n(srb->cmnd[3] == 0x00) &&\r\n(srb->cmnd[4] == 0x00) && (srb->cmnd[5] < 32)) {\r\nretval = rts51x_mg_get_ICV(srb, chip);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n} else {\r\nrts51x_set_sense_type(chip, lun,\r\nSENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nbreak;\r\ndefault:\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nscsi_set_resid(srb, 0);\r\nreturn TRANSPORT_GOOD;\r\n}\r\nstatic int mg_send_key(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nunsigned int lun = SCSI_LUN(srb);\r\nint retval;\r\nu8 key_format;\r\nrts51x_prepare_run(chip);\r\nRTS51X_SET_STAT(chip, STAT_RUN);\r\nrts51x_ms_cleanup_work(chip);\r\nif (!check_card_ready(chip, lun)) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nif (check_card_wp(chip, lun)) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_WRITE_PROTECT);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nif ((rts51x_get_lun_card(chip, lun) != MS_CARD)) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_LUN_NOT_SUPPORT);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nif (srb->cmnd[7] != KC_MG_R_PRO) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nif (!CHK_MSPRO(ms_card)) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MG_INCOMPATIBLE_MEDIUM);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nkey_format = srb->cmnd[10] & 0x3F;\r\nswitch (key_format) {\r\ncase KF_SET_LEAF_ID:\r\nif ((scsi_bufflen(srb) == 0x0C) &&\r\n(srb->cmnd[8] == 0x00) && (srb->cmnd[9] == 0x0C)) {\r\nretval = rts51x_mg_set_leaf_id(srb, chip);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n} else {\r\nrts51x_set_sense_type(chip, lun,\r\nSENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nbreak;\r\ncase KF_CHG_HOST:\r\nif ((scsi_bufflen(srb) == 0x0C) &&\r\n(srb->cmnd[8] == 0x00) && (srb->cmnd[9] == 0x0C)) {\r\nretval = rts51x_mg_chg(srb, chip);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n} else {\r\nrts51x_set_sense_type(chip, lun,\r\nSENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nbreak;\r\ncase KF_RSP_HOST:\r\nif ((scsi_bufflen(srb) == 0x0C) &&\r\n(srb->cmnd[8] == 0x00) && (srb->cmnd[9] == 0x0C)) {\r\nretval = rts51x_mg_rsp(srb, chip);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n} else {\r\nrts51x_set_sense_type(chip, lun,\r\nSENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nbreak;\r\ncase KF_SET_ICV:\r\nms_card->mg_entry_num = srb->cmnd[5];\r\nif ((scsi_bufflen(srb) == 0x404) &&\r\n(srb->cmnd[8] == 0x04) &&\r\n(srb->cmnd[9] == 0x04) &&\r\n(srb->cmnd[2] == 0x00) &&\r\n(srb->cmnd[3] == 0x00) &&\r\n(srb->cmnd[4] == 0x00) && (srb->cmnd[5] < 32)) {\r\nretval = rts51x_mg_set_ICV(srb, chip);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n} else {\r\nrts51x_set_sense_type(chip, lun,\r\nSENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nbreak;\r\ndefault:\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nscsi_set_resid(srb, 0);\r\nreturn TRANSPORT_GOOD;\r\n}\r\nint rts51x_scsi_handler(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nstruct ms_info *ms_card = &(chip->ms_card);\r\nunsigned int lun = SCSI_LUN(srb);\r\nint result = TRANSPORT_GOOD;\r\nif ((rts51x_get_lun_card(chip, lun) == MS_CARD) &&\r\n(ms_card->format_status == FORMAT_IN_PROGRESS)) {\r\nif ((srb->cmnd[0] != REQUEST_SENSE)\r\n&& (srb->cmnd[0] != INQUIRY)) {\r\nrts51x_set_sense_data(chip, lun, CUR_ERR, 0x02, 0, 0x04, 0x04,\r\n0, (u16) (ms_card->progress));\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\n}\r\nswitch (srb->cmnd[0]) {\r\ncase READ_10:\r\ncase WRITE_10:\r\ncase READ_6:\r\ncase WRITE_6:\r\nresult = read_write(srb, chip);\r\nbreak;\r\ncase TEST_UNIT_READY:\r\nresult = test_unit_ready(srb, chip);\r\nbreak;\r\ncase INQUIRY:\r\nresult = inquiry(srb, chip);\r\nbreak;\r\ncase READ_CAPACITY:\r\nresult = read_capacity(srb, chip);\r\nbreak;\r\ncase START_STOP:\r\nresult = start_stop_unit(srb, chip);\r\nbreak;\r\ncase ALLOW_MEDIUM_REMOVAL:\r\nresult = allow_medium_removal(srb, chip);\r\nbreak;\r\ncase REQUEST_SENSE:\r\nresult = request_sense(srb, chip);\r\nbreak;\r\ncase MODE_SENSE:\r\ncase MODE_SENSE_10:\r\nresult = mode_sense(srb, chip);\r\nbreak;\r\ncase 0x23:\r\nresult = read_format_capacity(srb, chip);\r\nbreak;\r\ncase VENDOR_CMND:\r\nresult = vendor_cmnd(srb, chip);\r\nbreak;\r\ncase MS_SP_CMND:\r\nresult = ms_sp_cmnd(srb, chip);\r\nbreak;\r\n#ifdef SUPPORT_CPRM\r\ncase SD_PASS_THRU_MODE:\r\ncase SD_EXECUTE_NO_DATA:\r\ncase SD_EXECUTE_READ:\r\ncase SD_EXECUTE_WRITE:\r\ncase SD_GET_RSP:\r\ncase SD_HW_RST:\r\nresult = sd_extention_cmnd(srb, chip);\r\nbreak;\r\n#endif\r\n#ifdef SUPPORT_MAGIC_GATE\r\ncase CMD_MSPRO_MG_RKEY:\r\nresult = mg_report_key(srb, chip);\r\nbreak;\r\ncase CMD_MSPRO_MG_SKEY:\r\nresult = mg_send_key(srb, chip);\r\nbreak;\r\n#endif\r\ncase FORMAT_UNIT:\r\ncase MODE_SELECT:\r\ncase VERIFY:\r\nresult = TRANSPORT_GOOD;\r\nbreak;\r\ndefault:\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nresult = TRANSPORT_FAILED;\r\n}\r\nreturn result;\r\n}\r\nint slave_alloc(struct scsi_device *sdev)\r\n{\r\nsdev->inquiry_len = 36;\r\nreturn 0;\r\n}\r\nint slave_configure(struct scsi_device *sdev)\r\n{\r\nblk_queue_dma_alignment(sdev->request_queue, (512 - 1));\r\nif (sdev->scsi_level < SCSI_2)\r\nsdev->scsi_level = sdev->sdev_target->scsi_level = SCSI_2;\r\nreturn 0;\r\n}\r\nint proc_info(struct Scsi_Host *host, char *buffer,\r\nchar **start, off_t offset, int length, int inout)\r\n{\r\nchar *pos = buffer;\r\nif (inout)\r\nreturn length;\r\nSPRINTF(" Host scsi%d: %s\n", host->host_no, RTS51X_NAME);\r\nSPRINTF(" Vendor: Realtek Corp.\n");\r\nSPRINTF(" Product: RTS51xx USB Card Reader\n");\r\nSPRINTF(" Version: %s\n", DRIVER_VERSION);\r\nSPRINTF(" Build: %s\n", __TIME__);\r\n*start = buffer + offset;\r\nif ((pos - buffer) < offset)\r\nreturn 0;\r\nelse if ((pos - buffer - offset) < length)\r\nreturn pos - buffer - offset;\r\nelse\r\nreturn length;\r\n}\r\nint queuecommand_lck(struct scsi_cmnd *srb, void (*done) (struct scsi_cmnd *))\r\n{\r\nstruct rts51x_chip *chip = host_to_rts51x(srb->device->host);\r\nif (chip->srb != NULL) {\r\nRTS51X_DEBUGP("Error in %s: chip->srb = %p\n",\r\n__func__, chip->srb);\r\nreturn SCSI_MLQUEUE_HOST_BUSY;\r\n}\r\nif (test_bit(FLIDX_DISCONNECTING, &chip->usb->dflags)) {\r\nRTS51X_DEBUGP("Fail command during disconnect\n");\r\nsrb->result = DID_NO_CONNECT << 16;\r\ndone(srb);\r\nreturn 0;\r\n}\r\nsrb->scsi_done = done;\r\nchip->srb = srb;\r\ncomplete(&chip->usb->cmnd_ready);\r\nreturn 0;\r\n}\r\nint command_abort(struct scsi_cmnd *srb)\r\n{\r\nstruct rts51x_chip *chip = host_to_rts51x(srb->device->host);\r\nRTS51X_DEBUGP("%s called\n", __func__);\r\nscsi_lock(rts51x_to_host(chip));\r\nif (chip->srb != srb) {\r\nscsi_unlock(rts51x_to_host(chip));\r\nRTS51X_DEBUGP("-- nothing to abort\n");\r\nreturn FAILED;\r\n}\r\nset_bit(FLIDX_TIMED_OUT, &chip->usb->dflags);\r\nif (!test_bit(FLIDX_RESETTING, &chip->usb->dflags)) {\r\nset_bit(FLIDX_ABORTING, &chip->usb->dflags);\r\n}\r\nscsi_unlock(rts51x_to_host(chip));\r\nwait_for_completion(&chip->usb->notify);\r\nreturn SUCCESS;\r\n}\r\nint device_reset(struct scsi_cmnd *srb)\r\n{\r\nint result = 0;\r\nRTS51X_DEBUGP("%s called\n", __func__);\r\nreturn result < 0 ? FAILED : SUCCESS;\r\n}\r\nint bus_reset(struct scsi_cmnd *srb)\r\n{\r\nint result = 0;\r\nRTS51X_DEBUGP("%s called\n", __func__);\r\nreturn result < 0 ? FAILED : SUCCESS;\r\n}\r\nstatic const char *rts5139_info(struct Scsi_Host *host)\r\n{\r\nreturn "SCSI emulation for RTS5139 USB card reader";\r\n}

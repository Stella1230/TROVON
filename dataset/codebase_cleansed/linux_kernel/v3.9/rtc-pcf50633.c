static void pcf2rtc_time(struct rtc_time *rtc, struct pcf50633_time *pcf)\r\n{\r\nrtc->tm_sec = bcd2bin(pcf->time[PCF50633_TI_SEC]);\r\nrtc->tm_min = bcd2bin(pcf->time[PCF50633_TI_MIN]);\r\nrtc->tm_hour = bcd2bin(pcf->time[PCF50633_TI_HOUR]);\r\nrtc->tm_wday = bcd2bin(pcf->time[PCF50633_TI_WKDAY]);\r\nrtc->tm_mday = bcd2bin(pcf->time[PCF50633_TI_DAY]);\r\nrtc->tm_mon = bcd2bin(pcf->time[PCF50633_TI_MONTH]) - 1;\r\nrtc->tm_year = bcd2bin(pcf->time[PCF50633_TI_YEAR]) + 100;\r\n}\r\nstatic void rtc2pcf_time(struct pcf50633_time *pcf, struct rtc_time *rtc)\r\n{\r\npcf->time[PCF50633_TI_SEC] = bin2bcd(rtc->tm_sec);\r\npcf->time[PCF50633_TI_MIN] = bin2bcd(rtc->tm_min);\r\npcf->time[PCF50633_TI_HOUR] = bin2bcd(rtc->tm_hour);\r\npcf->time[PCF50633_TI_WKDAY] = bin2bcd(rtc->tm_wday);\r\npcf->time[PCF50633_TI_DAY] = bin2bcd(rtc->tm_mday);\r\npcf->time[PCF50633_TI_MONTH] = bin2bcd(rtc->tm_mon + 1);\r\npcf->time[PCF50633_TI_YEAR] = bin2bcd(rtc->tm_year % 100);\r\n}\r\nstatic int\r\npcf50633_rtc_alarm_irq_enable(struct device *dev, unsigned int enabled)\r\n{\r\nstruct pcf50633_rtc *rtc = dev_get_drvdata(dev);\r\nint err;\r\nif (enabled)\r\nerr = pcf50633_irq_unmask(rtc->pcf, PCF50633_IRQ_ALARM);\r\nelse\r\nerr = pcf50633_irq_mask(rtc->pcf, PCF50633_IRQ_ALARM);\r\nif (err < 0)\r\nreturn err;\r\nrtc->alarm_enabled = enabled;\r\nreturn 0;\r\n}\r\nstatic int pcf50633_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct pcf50633_rtc *rtc;\r\nstruct pcf50633_time pcf_tm;\r\nint ret;\r\nrtc = dev_get_drvdata(dev);\r\nret = pcf50633_read_block(rtc->pcf, PCF50633_REG_RTCSC,\r\nPCF50633_TI_EXTENT,\r\n&pcf_tm.time[0]);\r\nif (ret != PCF50633_TI_EXTENT) {\r\ndev_err(dev, "Failed to read time\n");\r\nreturn -EIO;\r\n}\r\ndev_dbg(dev, "PCF_TIME: %02x.%02x.%02x %02x:%02x:%02x\n",\r\npcf_tm.time[PCF50633_TI_DAY],\r\npcf_tm.time[PCF50633_TI_MONTH],\r\npcf_tm.time[PCF50633_TI_YEAR],\r\npcf_tm.time[PCF50633_TI_HOUR],\r\npcf_tm.time[PCF50633_TI_MIN],\r\npcf_tm.time[PCF50633_TI_SEC]);\r\npcf2rtc_time(tm, &pcf_tm);\r\ndev_dbg(dev, "RTC_TIME: %u.%u.%u %u:%u:%u\n",\r\ntm->tm_mday, tm->tm_mon, tm->tm_year,\r\ntm->tm_hour, tm->tm_min, tm->tm_sec);\r\nreturn rtc_valid_tm(tm);\r\n}\r\nstatic int pcf50633_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct pcf50633_rtc *rtc;\r\nstruct pcf50633_time pcf_tm;\r\nint alarm_masked, ret = 0;\r\nrtc = dev_get_drvdata(dev);\r\ndev_dbg(dev, "RTC_TIME: %u.%u.%u %u:%u:%u\n",\r\ntm->tm_mday, tm->tm_mon, tm->tm_year,\r\ntm->tm_hour, tm->tm_min, tm->tm_sec);\r\nrtc2pcf_time(&pcf_tm, tm);\r\ndev_dbg(dev, "PCF_TIME: %02x.%02x.%02x %02x:%02x:%02x\n",\r\npcf_tm.time[PCF50633_TI_DAY],\r\npcf_tm.time[PCF50633_TI_MONTH],\r\npcf_tm.time[PCF50633_TI_YEAR],\r\npcf_tm.time[PCF50633_TI_HOUR],\r\npcf_tm.time[PCF50633_TI_MIN],\r\npcf_tm.time[PCF50633_TI_SEC]);\r\nalarm_masked = pcf50633_irq_mask_get(rtc->pcf, PCF50633_IRQ_ALARM);\r\nif (!alarm_masked)\r\npcf50633_irq_mask(rtc->pcf, PCF50633_IRQ_ALARM);\r\nret = pcf50633_write_block(rtc->pcf, PCF50633_REG_RTCSC,\r\nPCF50633_TI_EXTENT,\r\n&pcf_tm.time[0]);\r\nif (!alarm_masked)\r\npcf50633_irq_unmask(rtc->pcf, PCF50633_IRQ_ALARM);\r\nreturn ret;\r\n}\r\nstatic int pcf50633_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct pcf50633_rtc *rtc;\r\nstruct pcf50633_time pcf_tm;\r\nint ret = 0;\r\nrtc = dev_get_drvdata(dev);\r\nalrm->enabled = rtc->alarm_enabled;\r\nalrm->pending = rtc->alarm_pending;\r\nret = pcf50633_read_block(rtc->pcf, PCF50633_REG_RTCSCA,\r\nPCF50633_TI_EXTENT, &pcf_tm.time[0]);\r\nif (ret != PCF50633_TI_EXTENT) {\r\ndev_err(dev, "Failed to read time\n");\r\nreturn -EIO;\r\n}\r\npcf2rtc_time(&alrm->time, &pcf_tm);\r\nreturn rtc_valid_tm(&alrm->time);\r\n}\r\nstatic int pcf50633_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct pcf50633_rtc *rtc;\r\nstruct pcf50633_time pcf_tm;\r\nint alarm_masked, ret = 0;\r\nrtc = dev_get_drvdata(dev);\r\nrtc2pcf_time(&pcf_tm, &alrm->time);\r\npcf_tm.time[PCF50633_TI_WKDAY] = 7;\r\nalarm_masked = pcf50633_irq_mask_get(rtc->pcf, PCF50633_IRQ_ALARM);\r\nif (!alarm_masked)\r\npcf50633_irq_mask(rtc->pcf, PCF50633_IRQ_ALARM);\r\nret = pcf50633_write_block(rtc->pcf, PCF50633_REG_RTCSCA,\r\nPCF50633_TI_EXTENT, &pcf_tm.time[0]);\r\nif (!alrm->enabled)\r\nrtc->alarm_pending = 0;\r\nif (!alarm_masked || alrm->enabled)\r\npcf50633_irq_unmask(rtc->pcf, PCF50633_IRQ_ALARM);\r\nrtc->alarm_enabled = alrm->enabled;\r\nreturn ret;\r\n}\r\nstatic void pcf50633_rtc_irq(int irq, void *data)\r\n{\r\nstruct pcf50633_rtc *rtc = data;\r\nrtc_update_irq(rtc->rtc_dev, 1, RTC_AF | RTC_IRQF);\r\nrtc->alarm_pending = 1;\r\n}\r\nstatic int pcf50633_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct pcf50633_rtc *rtc;\r\nrtc = kzalloc(sizeof(*rtc), GFP_KERNEL);\r\nif (!rtc)\r\nreturn -ENOMEM;\r\nrtc->pcf = dev_to_pcf50633(pdev->dev.parent);\r\nplatform_set_drvdata(pdev, rtc);\r\nrtc->rtc_dev = rtc_device_register("pcf50633-rtc", &pdev->dev,\r\n&pcf50633_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc->rtc_dev)) {\r\nint ret = PTR_ERR(rtc->rtc_dev);\r\nkfree(rtc);\r\nreturn ret;\r\n}\r\npcf50633_register_irq(rtc->pcf, PCF50633_IRQ_ALARM,\r\npcf50633_rtc_irq, rtc);\r\nreturn 0;\r\n}\r\nstatic int pcf50633_rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct pcf50633_rtc *rtc;\r\nrtc = platform_get_drvdata(pdev);\r\npcf50633_free_irq(rtc->pcf, PCF50633_IRQ_ALARM);\r\nrtc_device_unregister(rtc->rtc_dev);\r\nkfree(rtc);\r\nreturn 0;\r\n}

static int lpc32xx_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint *val,\r\nint *val2,\r\nlong mask)\r\n{\r\nstruct lpc32xx_adc_info *info = iio_priv(indio_dev);\r\nif (mask == IIO_CHAN_INFO_RAW) {\r\nmutex_lock(&indio_dev->mlock);\r\nclk_enable(info->clk);\r\n__raw_writel(AD_INTERNAL | (chan->address) | AD_REFp | AD_REFm,\r\nLPC32XX_ADC_SELECT(info->adc_base));\r\n__raw_writel(AD_PDN_CTRL | AD_STROBE,\r\nLPC32XX_ADC_CTRL(info->adc_base));\r\nwait_for_completion(&info->completion);\r\nclk_disable(info->clk);\r\n*val = info->value;\r\nmutex_unlock(&indio_dev->mlock);\r\nreturn IIO_VAL_INT;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic irqreturn_t lpc32xx_adc_isr(int irq, void *dev_id)\r\n{\r\nstruct lpc32xx_adc_info *info = (struct lpc32xx_adc_info *) dev_id;\r\ninfo->value = __raw_readl(LPC32XX_ADC_VALUE(info->adc_base)) &\r\nADC_VALUE_MASK;\r\ncomplete(&info->completion);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int lpc32xx_adc_probe(struct platform_device *pdev)\r\n{\r\nstruct lpc32xx_adc_info *info = NULL;\r\nstruct resource *res;\r\nint retval = -ENODEV;\r\nstruct iio_dev *iodev = NULL;\r\nint irq;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\ndev_err(&pdev->dev, "failed to get platform I/O memory\n");\r\nretval = -EBUSY;\r\ngoto errout1;\r\n}\r\niodev = iio_device_alloc(sizeof(struct lpc32xx_adc_info));\r\nif (!iodev) {\r\ndev_err(&pdev->dev, "failed allocating iio device\n");\r\nretval = -ENOMEM;\r\ngoto errout1;\r\n}\r\ninfo = iio_priv(iodev);\r\ninfo->adc_base = ioremap(res->start, resource_size(res));\r\nif (!info->adc_base) {\r\ndev_err(&pdev->dev, "failed mapping memory\n");\r\nretval = -EBUSY;\r\ngoto errout2;\r\n}\r\ninfo->clk = clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(info->clk)) {\r\ndev_err(&pdev->dev, "failed getting clock\n");\r\ngoto errout3;\r\n}\r\nirq = platform_get_irq(pdev, 0);\r\nif ((irq < 0) || (irq >= NR_IRQS)) {\r\ndev_err(&pdev->dev, "failed getting interrupt resource\n");\r\nretval = -EINVAL;\r\ngoto errout4;\r\n}\r\nretval = request_irq(irq, lpc32xx_adc_isr, 0, MOD_NAME, info);\r\nif (retval < 0) {\r\ndev_err(&pdev->dev, "failed requesting interrupt\n");\r\ngoto errout4;\r\n}\r\nplatform_set_drvdata(pdev, iodev);\r\ninit_completion(&info->completion);\r\niodev->name = MOD_NAME;\r\niodev->dev.parent = &pdev->dev;\r\niodev->info = &lpc32xx_adc_iio_info;\r\niodev->modes = INDIO_DIRECT_MODE;\r\niodev->channels = lpc32xx_adc_iio_channels;\r\niodev->num_channels = ARRAY_SIZE(lpc32xx_adc_iio_channels);\r\nretval = iio_device_register(iodev);\r\nif (retval)\r\ngoto errout5;\r\ndev_info(&pdev->dev, "LPC32XX ADC driver loaded, IRQ %d\n", irq);\r\nreturn 0;\r\nerrout5:\r\nfree_irq(irq, info);\r\nerrout4:\r\nclk_put(info->clk);\r\nerrout3:\r\niounmap(info->adc_base);\r\nerrout2:\r\niio_device_free(iodev);\r\nerrout1:\r\nreturn retval;\r\n}\r\nstatic int lpc32xx_adc_remove(struct platform_device *pdev)\r\n{\r\nstruct iio_dev *iodev = platform_get_drvdata(pdev);\r\nstruct lpc32xx_adc_info *info = iio_priv(iodev);\r\nint irq = platform_get_irq(pdev, 0);\r\niio_device_unregister(iodev);\r\nfree_irq(irq, info);\r\nplatform_set_drvdata(pdev, NULL);\r\nclk_put(info->clk);\r\niounmap(info->adc_base);\r\niio_device_free(iodev);\r\nreturn 0;\r\n}

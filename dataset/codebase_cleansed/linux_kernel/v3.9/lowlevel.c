int ibmasm_send_i2o_message(struct service_processor *sp)\r\n{\r\nu32 mfa;\r\nunsigned int command_size;\r\nstruct i2o_message *message;\r\nstruct command *command = sp->current_command;\r\nmfa = get_mfa_inbound(sp->base_address);\r\nif (!mfa)\r\nreturn 1;\r\ncommand_size = get_dot_command_size(command->buffer);\r\nheader.message_size = outgoing_message_size(command_size);\r\nmessage = get_i2o_message(sp->base_address, mfa);\r\nmemcpy_toio(&message->header, &header, sizeof(struct i2o_header));\r\nmemcpy_toio(&message->data, command->buffer, command_size);\r\nset_mfa_inbound(sp->base_address, mfa);\r\nreturn 0;\r\n}\r\nirqreturn_t ibmasm_interrupt_handler(int irq, void * dev_id)\r\n{\r\nu32 mfa;\r\nstruct service_processor *sp = (struct service_processor *)dev_id;\r\nvoid __iomem *base_address = sp->base_address;\r\nchar tsbuf[32];\r\nif (!sp_interrupt_pending(base_address))\r\nreturn IRQ_NONE;\r\ndbg("respond to interrupt at %s\n", get_timestamp(tsbuf));\r\nif (mouse_interrupt_pending(sp)) {\r\nibmasm_handle_mouse_interrupt(sp);\r\nclear_mouse_interrupt(sp);\r\n}\r\nmfa = get_mfa_outbound(base_address);\r\nif (valid_mfa(mfa)) {\r\nstruct i2o_message *msg = get_i2o_message(base_address, mfa);\r\nibmasm_receive_message(sp, &msg->data, incoming_data_size(msg));\r\n} else\r\ndbg("didn't get a valid MFA\n");\r\nset_mfa_outbound(base_address, mfa);\r\ndbg("finished interrupt at %s\n", get_timestamp(tsbuf));\r\nreturn IRQ_HANDLED;\r\n}

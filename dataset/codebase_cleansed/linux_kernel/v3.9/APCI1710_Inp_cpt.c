static int i_APCI1710_InsnConfigInitPulseEncoder(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct addi_private *devpriv = dev->private;\r\nint i_ReturnValue = 0;\r\nunsigned int dw_IntRegister;\r\nunsigned char b_ModulNbr;\r\nunsigned char b_PulseEncoderNbr;\r\nunsigned char b_InputLevelSelection;\r\nunsigned char b_TriggerOutputAction;\r\nunsigned int ul_StartValue;\r\nb_ModulNbr = (unsigned char) CR_AREF(insn->chanspec);\r\nb_PulseEncoderNbr = (unsigned char) data[0];\r\nb_InputLevelSelection = (unsigned char) data[1];\r\nb_TriggerOutputAction = (unsigned char) data[2];\r\nul_StartValue = (unsigned int) data[3];\r\ni_ReturnValue = insn->n;\r\nif (b_ModulNbr <= 3) {\r\nif ((devpriv->s_BoardInfos.\r\ndw_MolduleConfiguration[b_ModulNbr] &\r\nAPCI1710_PULSE_ENCODER) ==\r\nAPCI1710_PULSE_ENCODER) {\r\nif (b_PulseEncoderNbr <= 3) {\r\nif ((b_InputLevelSelection == 0)\r\n|| (b_InputLevelSelection == 1)) {\r\nif ((b_TriggerOutputAction <= 2)\r\n|| (b_PulseEncoderNbr > 0)) {\r\nif (ul_StartValue > 1) {\r\ndw_IntRegister =\r\ninl(devpriv->\r\ns_BoardInfos.\r\nui_Address +\r\n20 +\r\n(64 * b_ModulNbr));\r\noutl(ul_StartValue,\r\ndevpriv->\r\ns_BoardInfos.\r\nui_Address +\r\n(b_PulseEncoderNbr\r\n* 4) +\r\n(64 * b_ModulNbr));\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ndw_SetRegister =\r\n(devpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ndw_SetRegister &\r\n(0xFFFFFFFFUL -\r\n(1UL << (8 + b_PulseEncoderNbr)))) | ((1UL & (~b_InputLevelSelection)) << (8 + b_PulseEncoderNbr));\r\nif ((b_TriggerOutputAction > 0) && (b_PulseEncoderNbr > 1)) {\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ndw_SetRegister\r\n=\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ndw_SetRegister\r\n| (1UL\r\n<< (4 + b_PulseEncoderNbr));\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ndw_SetRegister\r\n=\r\n(devpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ndw_SetRegister\r\n&\r\n(0xFFFFFFFFUL\r\n-\r\n(1UL << (12 + b_PulseEncoderNbr)))) | ((1UL & (b_TriggerOutputAction - 1)) << (12 + b_PulseEncoderNbr));\r\n} else {\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ndw_SetRegister\r\n=\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ndw_SetRegister\r\n&\r\n(0xFFFFFFFFUL\r\n-\r\n(1UL << (4 + b_PulseEncoderNbr)));\r\n}\r\noutl(devpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ndw_SetRegister,\r\ndevpriv->\r\ns_BoardInfos.\r\nui_Address +\r\n20 +\r\n(64 * b_ModulNbr));\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ns_PulseEncoderInfo\r\n[b_PulseEncoderNbr].\r\nb_PulseEncoderInit\r\n= 1;\r\n} else {\r\nDPRINTK("Pulse encoder start value is wrong\n");\r\ni_ReturnValue = -6;\r\n}\r\n} else {\r\nDPRINTK("Digital TRIGGER output action selection is wrong\n");\r\ni_ReturnValue = -5;\r\n}\r\n} else {\r\nDPRINTK("Input level selection is wrong\n");\r\ni_ReturnValue = -4;\r\n}\r\n} else {\r\nDPRINTK("Pulse encoder selection is wrong\n");\r\ni_ReturnValue = -3;\r\n}\r\n} else {\r\nDPRINTK("The module is not a pulse encoder module\n");\r\ni_ReturnValue = -2;\r\n}\r\n} else {\r\nDPRINTK("The module is not a pulse encoder module\n");\r\ni_ReturnValue = -2;\r\n}\r\nreturn i_ReturnValue;\r\n}\r\nstatic int i_APCI1710_InsnWriteEnableDisablePulseEncoder(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct addi_private *devpriv = dev->private;\r\nint i_ReturnValue = 0;\r\nunsigned char b_ModulNbr;\r\nunsigned char b_PulseEncoderNbr;\r\nunsigned char b_CycleSelection;\r\nunsigned char b_InterruptHandling;\r\nunsigned char b_Action;\r\ni_ReturnValue = insn->n;\r\nb_ModulNbr = (unsigned char) CR_AREF(insn->chanspec);\r\nb_Action = (unsigned char) data[0];\r\nb_PulseEncoderNbr = (unsigned char) data[1];\r\nb_CycleSelection = (unsigned char) data[2];\r\nb_InterruptHandling = (unsigned char) data[3];\r\nif (b_ModulNbr <= 3) {\r\nif (b_PulseEncoderNbr <= 3) {\r\nif (devpriv->s_ModuleInfo[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ns_PulseEncoderInfo[b_PulseEncoderNbr].\r\nb_PulseEncoderInit == 1) {\r\nswitch (b_Action) {\r\ncase APCI1710_ENABLE:\r\nif (b_CycleSelection ==\r\nAPCI1710_CONTINUOUS\r\n|| b_CycleSelection ==\r\nAPCI1710_SINGLE) {\r\nif (b_InterruptHandling ==\r\nAPCI1710_ENABLE\r\n|| b_InterruptHandling\r\n== APCI1710_DISABLE) {\r\nif (b_InterruptHandling\r\n==\r\nAPCI1710_DISABLE)\r\n{\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ndw_SetRegister\r\n=\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ndw_SetRegister\r\n&\r\n(0xFFFFFFFFUL\r\n-\r\n(1UL << b_PulseEncoderNbr));\r\n} else {\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ndw_SetRegister\r\n=\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ndw_SetRegister\r\n| (1UL\r\n<<\r\nb_PulseEncoderNbr);\r\ndevpriv->tsk_Current = current;\r\n}\r\nif (i_ReturnValue >= 0) {\r\noutl(devpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ndw_SetRegister,\r\ndevpriv->\r\ns_BoardInfos.\r\nui_Address\r\n+ 20 +\r\n(64 * b_ModulNbr));\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ndw_ControlRegister\r\n=\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ndw_ControlRegister\r\n| (1UL\r\n<<\r\nb_PulseEncoderNbr);\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ndw_ControlRegister\r\n=\r\n(devpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ndw_ControlRegister\r\n&\r\n(0xFFFFFFFFUL\r\n-\r\n(1 << (b_PulseEncoderNbr + 4)))) | ((b_CycleSelection & 1UL) << (4 + b_PulseEncoderNbr));\r\noutl(devpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ndw_ControlRegister,\r\ndevpriv->\r\ns_BoardInfos.\r\nui_Address\r\n+ 16 +\r\n(64 * b_ModulNbr));\r\n}\r\n} else {\r\nDPRINTK("Interrupt handling mode is wrong\n");\r\ni_ReturnValue = -6;\r\n}\r\n} else {\r\nDPRINTK("Cycle selection mode is wrong\n");\r\ni_ReturnValue = -5;\r\n}\r\nbreak;\r\ncase APCI1710_DISABLE:\r\ndevpriv->s_ModuleInfo[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ndw_ControlRegister =\r\ndevpriv->\r\ns_ModuleInfo[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ndw_ControlRegister &\r\n(0xFFFFFFFFUL -\r\n(1UL << b_PulseEncoderNbr));\r\noutl(devpriv->s_ModuleInfo[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ndw_ControlRegister,\r\ndevpriv->s_BoardInfos.\r\nui_Address + 16 +\r\n(64 * b_ModulNbr));\r\nbreak;\r\n}\r\n} else {\r\nDPRINTK("Pulse encoder not initialised\n");\r\ni_ReturnValue = -4;\r\n}\r\n} else {\r\nDPRINTK("Pulse encoder selection is wrong\n");\r\ni_ReturnValue = -3;\r\n}\r\n} else {\r\nDPRINTK("Module selection is wrong\n");\r\ni_ReturnValue = -2;\r\n}\r\nreturn i_ReturnValue;\r\n}\r\nstatic int i_APCI1710_InsnBitsReadWritePulseEncoder(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct addi_private *devpriv = dev->private;\r\nint i_ReturnValue = 0;\r\nunsigned int dw_StatusRegister;\r\nunsigned char b_ModulNbr;\r\nunsigned char b_PulseEncoderNbr;\r\nunsigned char *pb_Status;\r\nunsigned char b_Type;\r\nunsigned int *pul_ReadValue;\r\nunsigned int ul_WriteValue;\r\ni_ReturnValue = insn->n;\r\nb_ModulNbr = (unsigned char) CR_AREF(insn->chanspec);\r\nb_Type = (unsigned char) data[0];\r\nb_PulseEncoderNbr = (unsigned char) data[1];\r\npb_Status = (unsigned char *) &data[0];\r\npul_ReadValue = (unsigned int *) &data[1];\r\nif (b_ModulNbr <= 3) {\r\nif (b_PulseEncoderNbr <= 3) {\r\nif (devpriv->s_ModuleInfo[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ns_PulseEncoderInfo[b_PulseEncoderNbr].\r\nb_PulseEncoderInit == 1) {\r\nswitch (b_Type) {\r\ncase APCI1710_PULSEENCODER_READ:\r\ndw_StatusRegister =\r\ninl(devpriv->s_BoardInfos.\r\nui_Address + 16 +\r\n(64 * b_ModulNbr));\r\ndevpriv->s_ModuleInfo[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ndw_StatusRegister = devpriv->\r\ns_ModuleInfo[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ndw_StatusRegister |\r\ndw_StatusRegister;\r\n*pb_Status =\r\n(unsigned char) (devpriv->\r\ns_ModuleInfo[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ndw_StatusRegister >> (1 +\r\nb_PulseEncoderNbr)) & 1;\r\ndevpriv->s_ModuleInfo[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ndw_StatusRegister =\r\ndevpriv->\r\ns_ModuleInfo[b_ModulNbr].\r\ns_PulseEncoderModuleInfo.\r\ndw_StatusRegister &\r\n(0xFFFFFFFFUL - (1 << (1 +\r\nb_PulseEncoderNbr)));\r\n*pul_ReadValue =\r\ninl(devpriv->s_BoardInfos.\r\nui_Address +\r\n(4 * b_PulseEncoderNbr) +\r\n(64 * b_ModulNbr));\r\nbreak;\r\ncase APCI1710_PULSEENCODER_WRITE:\r\nul_WriteValue = (unsigned int) data[2];\r\noutl(ul_WriteValue,\r\ndevpriv->s_BoardInfos.\r\nui_Address +\r\n(4 * b_PulseEncoderNbr) +\r\n(64 * b_ModulNbr));\r\n}\r\n} else {\r\nDPRINTK("Pulse encoder not initialised\n");\r\ni_ReturnValue = -4;\r\n}\r\n} else {\r\nDPRINTK("Pulse encoder selection is wrong\n");\r\ni_ReturnValue = -3;\r\n}\r\n} else {\r\nDPRINTK("Module selection is wrong\n");\r\ni_ReturnValue = -2;\r\n}\r\nreturn i_ReturnValue;\r\n}\r\nstatic int i_APCI1710_InsnReadInterruptPulseEncoder(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct addi_private *devpriv = dev->private;\r\ndata[0] = devpriv->s_InterruptParameters.\r\ns_FIFOInterruptParameters[devpriv->\r\ns_InterruptParameters.ui_Read].b_OldModuleMask;\r\ndata[1] = devpriv->s_InterruptParameters.\r\ns_FIFOInterruptParameters[devpriv->\r\ns_InterruptParameters.ui_Read].ul_OldInterruptMask;\r\ndata[2] = devpriv->s_InterruptParameters.\r\ns_FIFOInterruptParameters[devpriv->\r\ns_InterruptParameters.ui_Read].ul_OldCounterLatchValue;\r\ndevpriv->s_InterruptParameters.\r\nui_Read = (devpriv->\r\ns_InterruptParameters.ui_Read + 1) % APCI1710_SAVE_INTERRUPT;\r\nreturn insn->n;\r\n}

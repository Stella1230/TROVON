static unsigned int tiadc_readl(struct tiadc_device *adc, unsigned int reg)\r\n{\r\nreturn readl(adc->mfd_tscadc->tscadc_base + reg);\r\n}\r\nstatic void tiadc_writel(struct tiadc_device *adc, unsigned int reg,\r\nunsigned int val)\r\n{\r\nwritel(val, adc->mfd_tscadc->tscadc_base + reg);\r\n}\r\nstatic void tiadc_step_config(struct tiadc_device *adc_dev)\r\n{\r\nunsigned int stepconfig;\r\nint i, channels = 0, steps;\r\nsteps = TOTAL_STEPS - adc_dev->channels;\r\nchannels = TOTAL_CHANNELS - adc_dev->channels;\r\nstepconfig = STEPCONFIG_AVG_16 | STEPCONFIG_FIFO1;\r\nfor (i = (steps + 1); i <= TOTAL_STEPS; i++) {\r\ntiadc_writel(adc_dev, REG_STEPCONFIG(i),\r\nstepconfig | STEPCONFIG_INP(channels));\r\ntiadc_writel(adc_dev, REG_STEPDELAY(i),\r\nSTEPCONFIG_OPENDLY);\r\nchannels++;\r\n}\r\ntiadc_writel(adc_dev, REG_SE, STPENB_STEPENB);\r\n}\r\nstatic int tiadc_channel_init(struct iio_dev *indio_dev, int channels)\r\n{\r\nstruct iio_chan_spec *chan_array;\r\nint i;\r\nindio_dev->num_channels = channels;\r\nchan_array = kcalloc(indio_dev->num_channels,\r\nsizeof(struct iio_chan_spec), GFP_KERNEL);\r\nif (chan_array == NULL)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < (indio_dev->num_channels); i++) {\r\nstruct iio_chan_spec *chan = chan_array + i;\r\nchan->type = IIO_VOLTAGE;\r\nchan->indexed = 1;\r\nchan->channel = i;\r\nchan->info_mask = IIO_CHAN_INFO_RAW_SEPARATE_BIT;\r\n}\r\nindio_dev->channels = chan_array;\r\nreturn indio_dev->num_channels;\r\n}\r\nstatic void tiadc_channels_remove(struct iio_dev *indio_dev)\r\n{\r\nkfree(indio_dev->channels);\r\n}\r\nstatic int tiadc_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint *val, int *val2, long mask)\r\n{\r\nstruct tiadc_device *adc_dev = iio_priv(indio_dev);\r\nint i;\r\nunsigned int fifo1count, readx1;\r\nfifo1count = tiadc_readl(adc_dev, REG_FIFO1CNT);\r\nfor (i = 0; i < fifo1count; i++) {\r\nreadx1 = tiadc_readl(adc_dev, REG_FIFO1);\r\nif (i == chan->channel)\r\n*val = readx1 & 0xfff;\r\n}\r\ntiadc_writel(adc_dev, REG_SE, STPENB_STEPENB);\r\nreturn IIO_VAL_INT;\r\n}\r\nstatic int tiadc_probe(struct platform_device *pdev)\r\n{\r\nstruct iio_dev *indio_dev;\r\nstruct tiadc_device *adc_dev;\r\nstruct ti_tscadc_dev *tscadc_dev = pdev->dev.platform_data;\r\nstruct mfd_tscadc_board *pdata;\r\nint err;\r\npdata = tscadc_dev->dev->platform_data;\r\nif (!pdata || !pdata->adc_init) {\r\ndev_err(&pdev->dev, "Could not find platform data\n");\r\nreturn -EINVAL;\r\n}\r\nindio_dev = iio_device_alloc(sizeof(struct tiadc_device));\r\nif (indio_dev == NULL) {\r\ndev_err(&pdev->dev, "failed to allocate iio device\n");\r\nerr = -ENOMEM;\r\ngoto err_ret;\r\n}\r\nadc_dev = iio_priv(indio_dev);\r\nadc_dev->mfd_tscadc = tscadc_dev;\r\nadc_dev->channels = pdata->adc_init->adc_channels;\r\nindio_dev->dev.parent = &pdev->dev;\r\nindio_dev->name = dev_name(&pdev->dev);\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nindio_dev->info = &tiadc_info;\r\ntiadc_step_config(adc_dev);\r\nerr = tiadc_channel_init(indio_dev, adc_dev->channels);\r\nif (err < 0)\r\ngoto err_free_device;\r\nerr = iio_device_register(indio_dev);\r\nif (err)\r\ngoto err_free_channels;\r\nplatform_set_drvdata(pdev, indio_dev);\r\nreturn 0;\r\nerr_free_channels:\r\ntiadc_channels_remove(indio_dev);\r\nerr_free_device:\r\niio_device_free(indio_dev);\r\nerr_ret:\r\nreturn err;\r\n}\r\nstatic int tiadc_remove(struct platform_device *pdev)\r\n{\r\nstruct iio_dev *indio_dev = platform_get_drvdata(pdev);\r\niio_device_unregister(indio_dev);\r\ntiadc_channels_remove(indio_dev);\r\niio_device_free(indio_dev);\r\nreturn 0;\r\n}\r\nstatic int tiadc_suspend(struct device *dev)\r\n{\r\nstruct iio_dev *indio_dev = dev_get_drvdata(dev);\r\nstruct tiadc_device *adc_dev = iio_priv(indio_dev);\r\nstruct ti_tscadc_dev *tscadc_dev = dev->platform_data;\r\nunsigned int idle;\r\nif (!device_may_wakeup(tscadc_dev->dev)) {\r\nidle = tiadc_readl(adc_dev, REG_CTRL);\r\nidle &= ~(CNTRLREG_TSCSSENB);\r\ntiadc_writel(adc_dev, REG_CTRL, (idle |\r\nCNTRLREG_POWERDOWN));\r\n}\r\nreturn 0;\r\n}\r\nstatic int tiadc_resume(struct device *dev)\r\n{\r\nstruct iio_dev *indio_dev = dev_get_drvdata(dev);\r\nstruct tiadc_device *adc_dev = iio_priv(indio_dev);\r\nunsigned int restore;\r\nrestore = tiadc_readl(adc_dev, REG_CTRL);\r\nrestore &= ~(CNTRLREG_POWERDOWN);\r\ntiadc_writel(adc_dev, REG_CTRL, restore);\r\ntiadc_step_config(adc_dev);\r\nreturn 0;\r\n}

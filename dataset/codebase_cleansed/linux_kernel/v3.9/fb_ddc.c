static unsigned char *fb_do_probe_ddc_edid(struct i2c_adapter *adapter)\r\n{\r\nunsigned char start = 0x0;\r\nunsigned char *buf = kmalloc(EDID_LENGTH, GFP_KERNEL);\r\nstruct i2c_msg msgs[] = {\r\n{\r\n.addr = DDC_ADDR,\r\n.flags = 0,\r\n.len = 1,\r\n.buf = &start,\r\n}, {\r\n.addr = DDC_ADDR,\r\n.flags = I2C_M_RD,\r\n.len = EDID_LENGTH,\r\n.buf = buf,\r\n}\r\n};\r\nif (!buf) {\r\ndev_warn(&adapter->dev, "unable to allocate memory for EDID "\r\n"block.\n");\r\nreturn NULL;\r\n}\r\nif (i2c_transfer(adapter, msgs, 2) == 2)\r\nreturn buf;\r\ndev_warn(&adapter->dev, "unable to read EDID block.\n");\r\nkfree(buf);\r\nreturn NULL;\r\n}\r\nunsigned char *fb_ddc_read(struct i2c_adapter *adapter)\r\n{\r\nstruct i2c_algo_bit_data *algo_data = adapter->algo_data;\r\nunsigned char *edid = NULL;\r\nint i, j;\r\nalgo_data->setscl(algo_data->data, 1);\r\nfor (i = 0; i < 3; i++) {\r\nalgo_data->setsda(algo_data->data, 1);\r\nmsleep(13);\r\nalgo_data->setscl(algo_data->data, 1);\r\nfor (j = 0; j < 5; j++) {\r\nmsleep(10);\r\nif (algo_data->getscl(algo_data->data))\r\nbreak;\r\n}\r\nif (j == 5)\r\ncontinue;\r\nalgo_data->setsda(algo_data->data, 0);\r\nmsleep(15);\r\nalgo_data->setscl(algo_data->data, 0);\r\nmsleep(15);\r\nalgo_data->setsda(algo_data->data, 1);\r\nmsleep(15);\r\nedid = fb_do_probe_ddc_edid(adapter);\r\nalgo_data->setsda(algo_data->data, 0);\r\nalgo_data->setscl(algo_data->data, 0);\r\nmsleep(15);\r\nalgo_data->setscl(algo_data->data, 1);\r\nfor (j = 0; j < 10; j++) {\r\nmsleep(10);\r\nif (algo_data->getscl(algo_data->data))\r\nbreak;\r\n}\r\nalgo_data->setsda(algo_data->data, 1);\r\nmsleep(15);\r\nalgo_data->setscl(algo_data->data, 0);\r\nalgo_data->setsda(algo_data->data, 0);\r\nif (edid)\r\nbreak;\r\n}\r\nalgo_data->setsda(algo_data->data, 1);\r\nalgo_data->setscl(algo_data->data, 1);\r\nadapter->class |= I2C_CLASS_DDC;\r\nreturn edid;\r\n}

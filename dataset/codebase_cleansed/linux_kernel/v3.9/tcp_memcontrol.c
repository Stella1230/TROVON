static inline struct tcp_memcontrol *tcp_from_cgproto(struct cg_proto *cg_proto)\r\n{\r\nreturn container_of(cg_proto, struct tcp_memcontrol, cg_proto);\r\n}\r\nstatic void memcg_tcp_enter_memory_pressure(struct sock *sk)\r\n{\r\nif (sk->sk_cgrp->memory_pressure)\r\n*sk->sk_cgrp->memory_pressure = 1;\r\n}\r\nint tcp_init_cgroup(struct mem_cgroup *memcg, struct cgroup_subsys *ss)\r\n{\r\nstruct res_counter *res_parent = NULL;\r\nstruct cg_proto *cg_proto, *parent_cg;\r\nstruct tcp_memcontrol *tcp;\r\nstruct mem_cgroup *parent = parent_mem_cgroup(memcg);\r\nstruct net *net = current->nsproxy->net_ns;\r\ncg_proto = tcp_prot.proto_cgroup(memcg);\r\nif (!cg_proto)\r\nreturn 0;\r\ntcp = tcp_from_cgproto(cg_proto);\r\ntcp->tcp_prot_mem[0] = net->ipv4.sysctl_tcp_mem[0];\r\ntcp->tcp_prot_mem[1] = net->ipv4.sysctl_tcp_mem[1];\r\ntcp->tcp_prot_mem[2] = net->ipv4.sysctl_tcp_mem[2];\r\ntcp->tcp_memory_pressure = 0;\r\nparent_cg = tcp_prot.proto_cgroup(parent);\r\nif (parent_cg)\r\nres_parent = parent_cg->memory_allocated;\r\nres_counter_init(&tcp->tcp_memory_allocated, res_parent);\r\npercpu_counter_init(&tcp->tcp_sockets_allocated, 0);\r\ncg_proto->enter_memory_pressure = memcg_tcp_enter_memory_pressure;\r\ncg_proto->memory_pressure = &tcp->tcp_memory_pressure;\r\ncg_proto->sysctl_mem = tcp->tcp_prot_mem;\r\ncg_proto->memory_allocated = &tcp->tcp_memory_allocated;\r\ncg_proto->sockets_allocated = &tcp->tcp_sockets_allocated;\r\ncg_proto->memcg = memcg;\r\nreturn 0;\r\n}\r\nvoid tcp_destroy_cgroup(struct mem_cgroup *memcg)\r\n{\r\nstruct cg_proto *cg_proto;\r\nstruct tcp_memcontrol *tcp;\r\nu64 val;\r\ncg_proto = tcp_prot.proto_cgroup(memcg);\r\nif (!cg_proto)\r\nreturn;\r\ntcp = tcp_from_cgproto(cg_proto);\r\npercpu_counter_destroy(&tcp->tcp_sockets_allocated);\r\nval = res_counter_read_u64(&tcp->tcp_memory_allocated, RES_LIMIT);\r\n}\r\nstatic int tcp_update_limit(struct mem_cgroup *memcg, u64 val)\r\n{\r\nstruct net *net = current->nsproxy->net_ns;\r\nstruct tcp_memcontrol *tcp;\r\nstruct cg_proto *cg_proto;\r\nu64 old_lim;\r\nint i;\r\nint ret;\r\ncg_proto = tcp_prot.proto_cgroup(memcg);\r\nif (!cg_proto)\r\nreturn -EINVAL;\r\nif (val > RESOURCE_MAX)\r\nval = RESOURCE_MAX;\r\ntcp = tcp_from_cgproto(cg_proto);\r\nold_lim = res_counter_read_u64(&tcp->tcp_memory_allocated, RES_LIMIT);\r\nret = res_counter_set_limit(&tcp->tcp_memory_allocated, val);\r\nif (ret)\r\nreturn ret;\r\nfor (i = 0; i < 3; i++)\r\ntcp->tcp_prot_mem[i] = min_t(long, val >> PAGE_SHIFT,\r\nnet->ipv4.sysctl_tcp_mem[i]);\r\nif (val == RESOURCE_MAX)\r\nclear_bit(MEMCG_SOCK_ACTIVE, &cg_proto->flags);\r\nelse if (val != RESOURCE_MAX) {\r\nif (!test_and_set_bit(MEMCG_SOCK_ACTIVATED, &cg_proto->flags))\r\nstatic_key_slow_inc(&memcg_socket_limit_enabled);\r\nset_bit(MEMCG_SOCK_ACTIVE, &cg_proto->flags);\r\n}\r\nreturn 0;\r\n}\r\nstatic int tcp_cgroup_write(struct cgroup *cont, struct cftype *cft,\r\nconst char *buffer)\r\n{\r\nstruct mem_cgroup *memcg = mem_cgroup_from_cont(cont);\r\nunsigned long long val;\r\nint ret = 0;\r\nswitch (cft->private) {\r\ncase RES_LIMIT:\r\nret = res_counter_memparse_write_strategy(buffer, &val);\r\nif (ret)\r\nbreak;\r\nret = tcp_update_limit(memcg, val);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic u64 tcp_read_stat(struct mem_cgroup *memcg, int type, u64 default_val)\r\n{\r\nstruct tcp_memcontrol *tcp;\r\nstruct cg_proto *cg_proto;\r\ncg_proto = tcp_prot.proto_cgroup(memcg);\r\nif (!cg_proto)\r\nreturn default_val;\r\ntcp = tcp_from_cgproto(cg_proto);\r\nreturn res_counter_read_u64(&tcp->tcp_memory_allocated, type);\r\n}\r\nstatic u64 tcp_read_usage(struct mem_cgroup *memcg)\r\n{\r\nstruct tcp_memcontrol *tcp;\r\nstruct cg_proto *cg_proto;\r\ncg_proto = tcp_prot.proto_cgroup(memcg);\r\nif (!cg_proto)\r\nreturn atomic_long_read(&tcp_memory_allocated) << PAGE_SHIFT;\r\ntcp = tcp_from_cgproto(cg_proto);\r\nreturn res_counter_read_u64(&tcp->tcp_memory_allocated, RES_USAGE);\r\n}\r\nstatic u64 tcp_cgroup_read(struct cgroup *cont, struct cftype *cft)\r\n{\r\nstruct mem_cgroup *memcg = mem_cgroup_from_cont(cont);\r\nu64 val;\r\nswitch (cft->private) {\r\ncase RES_LIMIT:\r\nval = tcp_read_stat(memcg, RES_LIMIT, RESOURCE_MAX);\r\nbreak;\r\ncase RES_USAGE:\r\nval = tcp_read_usage(memcg);\r\nbreak;\r\ncase RES_FAILCNT:\r\ncase RES_MAX_USAGE:\r\nval = tcp_read_stat(memcg, cft->private, 0);\r\nbreak;\r\ndefault:\r\nBUG();\r\n}\r\nreturn val;\r\n}\r\nstatic int tcp_cgroup_reset(struct cgroup *cont, unsigned int event)\r\n{\r\nstruct mem_cgroup *memcg;\r\nstruct tcp_memcontrol *tcp;\r\nstruct cg_proto *cg_proto;\r\nmemcg = mem_cgroup_from_cont(cont);\r\ncg_proto = tcp_prot.proto_cgroup(memcg);\r\nif (!cg_proto)\r\nreturn 0;\r\ntcp = tcp_from_cgproto(cg_proto);\r\nswitch (event) {\r\ncase RES_MAX_USAGE:\r\nres_counter_reset_max(&tcp->tcp_memory_allocated);\r\nbreak;\r\ncase RES_FAILCNT:\r\nres_counter_reset_failcnt(&tcp->tcp_memory_allocated);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nunsigned long long tcp_max_memory(const struct mem_cgroup *memcg)\r\n{\r\nstruct tcp_memcontrol *tcp;\r\nstruct cg_proto *cg_proto;\r\ncg_proto = tcp_prot.proto_cgroup((struct mem_cgroup *)memcg);\r\nif (!cg_proto)\r\nreturn 0;\r\ntcp = tcp_from_cgproto(cg_proto);\r\nreturn res_counter_read_u64(&tcp->tcp_memory_allocated, RES_LIMIT);\r\n}\r\nvoid tcp_prot_mem(struct mem_cgroup *memcg, long val, int idx)\r\n{\r\nstruct tcp_memcontrol *tcp;\r\nstruct cg_proto *cg_proto;\r\ncg_proto = tcp_prot.proto_cgroup(memcg);\r\nif (!cg_proto)\r\nreturn;\r\ntcp = tcp_from_cgproto(cg_proto);\r\ntcp->tcp_prot_mem[idx] = val;\r\n}\r\nstatic int __init tcp_memcontrol_init(void)\r\n{\r\nWARN_ON(cgroup_add_cftypes(&mem_cgroup_subsys, tcp_files));\r\nreturn 0;\r\n}

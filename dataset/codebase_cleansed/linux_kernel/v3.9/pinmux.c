int\r\ncrisv32_pinmux_init(void)\r\n{\r\nstatic int initialized;\r\nif (!initialized) {\r\ninitialized = 1;\r\nREG_WR_INT(pinmux, regi_pinmux, rw_hwprot, 0);\r\ncrisv32_pinmux_alloc(PORT_A, 0, 31, pinmux_gpio);\r\ncrisv32_pinmux_alloc(PORT_B, 0, 31, pinmux_gpio);\r\ncrisv32_pinmux_alloc(PORT_C, 0, 15, pinmux_gpio);\r\n}\r\nreturn 0;\r\n}\r\nint\r\ncrisv32_pinmux_alloc(int port, int first_pin, int last_pin, enum pin_mode mode)\r\n{\r\nint i;\r\nunsigned long flags;\r\ncrisv32_pinmux_init();\r\nif (port >= PORTS)\r\nreturn -EINVAL;\r\nspin_lock_irqsave(&pinmux_lock, flags);\r\nfor (i = first_pin; i <= last_pin; i++) {\r\nif ((pins[port * PORT_PINS + i] != pinmux_none) &&\r\n(pins[port * PORT_PINS + i] != pinmux_gpio) &&\r\n(pins[port * PORT_PINS + i] != mode)) {\r\nspin_unlock_irqrestore(&pinmux_lock, flags);\r\n#ifdef DEBUG\r\npanic("Pinmux alloc failed!\n");\r\n#endif\r\nreturn -EPERM;\r\n}\r\n}\r\nfor (i = first_pin; i <= last_pin; i++)\r\npins[port * PORT_PINS + i] = mode;\r\ncrisv32_pinmux_set(port);\r\nspin_unlock_irqrestore(&pinmux_lock, flags);\r\nreturn 0;\r\n}\r\nint\r\ncrisv32_pinmux_alloc_fixed(enum fixed_function function)\r\n{\r\nint ret = -EINVAL;\r\nchar saved[sizeof pins];\r\nunsigned long flags;\r\nreg_pinmux_rw_hwprot hwprot;\r\nreg_clkgen_rw_clk_ctrl clk_ctrl;\r\nspin_lock_irqsave(&pinmux_lock, flags);\r\nmemcpy(saved, pins, sizeof pins);\r\ncrisv32_pinmux_init();\r\nhwprot = REG_RD(pinmux, regi_pinmux, rw_hwprot);\r\nclk_ctrl = REG_RD(clkgen, regi_clkgen, rw_clk_ctrl);\r\nswitch (function) {\r\ncase pinmux_eth:\r\nclk_ctrl.eth = regk_clkgen_yes;\r\nclk_ctrl.dma0_1_eth = regk_clkgen_yes;\r\nret = crisv32_pinmux_alloc(PORT_B, 8, 23, pinmux_fixed);\r\nret |= crisv32_pinmux_alloc(PORT_B, 24, 25, pinmux_fixed);\r\nhwprot.eth = hwprot.eth_mdio = regk_pinmux_yes;\r\nbreak;\r\ncase pinmux_geth:\r\nret = crisv32_pinmux_alloc(PORT_B, 0, 7, pinmux_fixed);\r\nhwprot.geth = regk_pinmux_yes;\r\nbreak;\r\ncase pinmux_tg_cmos:\r\nclk_ctrl.ccd_tg_100 = clk_ctrl.ccd_tg_200 = regk_clkgen_yes;\r\nret = crisv32_pinmux_alloc(PORT_B, 27, 29, pinmux_fixed);\r\nhwprot.tg_clk = regk_pinmux_yes;\r\nbreak;\r\ncase pinmux_tg_ccd:\r\nclk_ctrl.ccd_tg_100 = clk_ctrl.ccd_tg_200 = regk_clkgen_yes;\r\nret = crisv32_pinmux_alloc(PORT_B, 27, 31, pinmux_fixed);\r\nret |= crisv32_pinmux_alloc(PORT_C, 0, 15, pinmux_fixed);\r\nhwprot.tg = hwprot.tg_clk = regk_pinmux_yes;\r\nbreak;\r\ncase pinmux_vout:\r\nclk_ctrl.strdma0_2_video = regk_clkgen_yes;\r\nret = crisv32_pinmux_alloc(PORT_A, 8, 18, pinmux_fixed);\r\nhwprot.vout = hwprot.vout_sync = regk_pinmux_yes;\r\nbreak;\r\ncase pinmux_ser1:\r\nclk_ctrl.sser_ser_dma6_7 = regk_clkgen_yes;\r\nret = crisv32_pinmux_alloc(PORT_A, 24, 25, pinmux_fixed);\r\nhwprot.ser1 = regk_pinmux_yes;\r\nbreak;\r\ncase pinmux_ser2:\r\nclk_ctrl.sser_ser_dma6_7 = regk_clkgen_yes;\r\nret = crisv32_pinmux_alloc(PORT_A, 26, 27, pinmux_fixed);\r\nhwprot.ser2 = regk_pinmux_yes;\r\nbreak;\r\ncase pinmux_ser3:\r\nclk_ctrl.sser_ser_dma6_7 = regk_clkgen_yes;\r\nret = crisv32_pinmux_alloc(PORT_A, 28, 29, pinmux_fixed);\r\nhwprot.ser3 = regk_pinmux_yes;\r\nbreak;\r\ncase pinmux_ser4:\r\nclk_ctrl.sser_ser_dma6_7 = regk_clkgen_yes;\r\nret = crisv32_pinmux_alloc(PORT_A, 30, 31, pinmux_fixed);\r\nhwprot.ser4 = regk_pinmux_yes;\r\nbreak;\r\ncase pinmux_sser:\r\nclk_ctrl.sser_ser_dma6_7 = regk_clkgen_yes;\r\nret = crisv32_pinmux_alloc(PORT_A, 19, 23, pinmux_fixed);\r\nhwprot.sser = regk_pinmux_yes;\r\nbreak;\r\ncase pinmux_pio:\r\nhwprot.pio = regk_pinmux_yes;\r\nret = 0;\r\nbreak;\r\ncase pinmux_pwm0:\r\nret = crisv32_pinmux_alloc(PORT_A, 30, 30, pinmux_fixed);\r\nhwprot.pwm0 = regk_pinmux_yes;\r\nbreak;\r\ncase pinmux_pwm1:\r\nret = crisv32_pinmux_alloc(PORT_A, 31, 31, pinmux_fixed);\r\nhwprot.pwm1 = regk_pinmux_yes;\r\nbreak;\r\ncase pinmux_pwm2:\r\nret = crisv32_pinmux_alloc(PORT_B, 26, 26, pinmux_fixed);\r\nhwprot.pwm2 = regk_pinmux_yes;\r\nbreak;\r\ncase pinmux_i2c0:\r\nret = crisv32_pinmux_alloc(PORT_A, 0, 1, pinmux_fixed);\r\nhwprot.i2c0 = regk_pinmux_yes;\r\nbreak;\r\ncase pinmux_i2c1:\r\nret = crisv32_pinmux_alloc(PORT_A, 2, 3, pinmux_fixed);\r\nhwprot.i2c1 = regk_pinmux_yes;\r\nbreak;\r\ncase pinmux_i2c1_3wire:\r\nret = crisv32_pinmux_alloc(PORT_A, 2, 3, pinmux_fixed);\r\nret |= crisv32_pinmux_alloc(PORT_A, 7, 7, pinmux_fixed);\r\nhwprot.i2c1 = hwprot.i2c1_sen = regk_pinmux_yes;\r\nbreak;\r\ncase pinmux_i2c1_sda1:\r\nret = crisv32_pinmux_alloc(PORT_A, 2, 4, pinmux_fixed);\r\nhwprot.i2c1 = hwprot.i2c1_sda1 = regk_pinmux_yes;\r\nbreak;\r\ncase pinmux_i2c1_sda2:\r\nret = crisv32_pinmux_alloc(PORT_A, 2, 3, pinmux_fixed);\r\nret |= crisv32_pinmux_alloc(PORT_A, 5, 5, pinmux_fixed);\r\nhwprot.i2c1 = hwprot.i2c1_sda2 = regk_pinmux_yes;\r\nbreak;\r\ncase pinmux_i2c1_sda3:\r\nret = crisv32_pinmux_alloc(PORT_A, 2, 3, pinmux_fixed);\r\nret |= crisv32_pinmux_alloc(PORT_A, 6, 6, pinmux_fixed);\r\nhwprot.i2c1 = hwprot.i2c1_sda3 = regk_pinmux_yes;\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nif (!ret) {\r\nREG_WR(pinmux, regi_pinmux, rw_hwprot, hwprot);\r\nREG_WR(clkgen, regi_clkgen, rw_clk_ctrl, clk_ctrl);\r\n} else\r\nmemcpy(pins, saved, sizeof pins);\r\nspin_unlock_irqrestore(&pinmux_lock, flags);\r\nreturn ret;\r\n}\r\nvoid\r\ncrisv32_pinmux_set(int port)\r\n{\r\nint i;\r\nint gpio_val = 0;\r\nint iop_val = 0;\r\nint pin = port * PORT_PINS;\r\nfor (i = 0; (i < PORT_PINS) && (pin < PINS); i++, pin++) {\r\nif (pins[pin] == pinmux_gpio)\r\ngpio_val |= (1 << i);\r\nelse if (pins[pin] == pinmux_iop)\r\niop_val |= (1 << i);\r\n}\r\nREG_WRITE(int, regi_pinmux + REG_RD_ADDR_pinmux_rw_gio_pa + 4 * port,\r\ngpio_val);\r\nREG_WRITE(int, regi_pinmux + REG_RD_ADDR_pinmux_rw_iop_pa + 4 * port,\r\niop_val);\r\n#ifdef DEBUG\r\ncrisv32_pinmux_dump();\r\n#endif\r\n}\r\nint\r\ncrisv32_pinmux_dealloc(int port, int first_pin, int last_pin)\r\n{\r\nint i;\r\nunsigned long flags;\r\ncrisv32_pinmux_init();\r\nif (port > PORTS || port < 0)\r\nreturn -EINVAL;\r\nspin_lock_irqsave(&pinmux_lock, flags);\r\nfor (i = first_pin; i <= last_pin; i++)\r\npins[port * PORT_PINS + i] = pinmux_none;\r\ncrisv32_pinmux_set(port);\r\nspin_unlock_irqrestore(&pinmux_lock, flags);\r\nreturn 0;\r\n}\r\nint\r\ncrisv32_pinmux_dealloc_fixed(enum fixed_function function)\r\n{\r\nint ret = -EINVAL;\r\nchar saved[sizeof pins];\r\nunsigned long flags;\r\nreg_pinmux_rw_hwprot hwprot;\r\nspin_lock_irqsave(&pinmux_lock, flags);\r\nmemcpy(saved, pins, sizeof pins);\r\ncrisv32_pinmux_init();\r\nhwprot = REG_RD(pinmux, regi_pinmux, rw_hwprot);\r\nswitch (function) {\r\ncase pinmux_eth:\r\nret = crisv32_pinmux_dealloc(PORT_B, 8, 23);\r\nret |= crisv32_pinmux_dealloc(PORT_B, 24, 25);\r\nret |= crisv32_pinmux_dealloc(PORT_B, 0, 7);\r\nhwprot.eth = hwprot.eth_mdio = hwprot.geth = regk_pinmux_no;\r\nbreak;\r\ncase pinmux_tg_cmos:\r\nret = crisv32_pinmux_dealloc(PORT_B, 27, 29);\r\nhwprot.tg_clk = regk_pinmux_no;\r\nbreak;\r\ncase pinmux_tg_ccd:\r\nret = crisv32_pinmux_dealloc(PORT_B, 27, 31);\r\nret |= crisv32_pinmux_dealloc(PORT_C, 0, 15);\r\nhwprot.tg = hwprot.tg_clk = regk_pinmux_no;\r\nbreak;\r\ncase pinmux_vout:\r\nret = crisv32_pinmux_dealloc(PORT_A, 8, 18);\r\nhwprot.vout = hwprot.vout_sync = regk_pinmux_no;\r\nbreak;\r\ncase pinmux_ser1:\r\nret = crisv32_pinmux_dealloc(PORT_A, 24, 25);\r\nhwprot.ser1 = regk_pinmux_no;\r\nbreak;\r\ncase pinmux_ser2:\r\nret = crisv32_pinmux_dealloc(PORT_A, 26, 27);\r\nhwprot.ser2 = regk_pinmux_no;\r\nbreak;\r\ncase pinmux_ser3:\r\nret = crisv32_pinmux_dealloc(PORT_A, 28, 29);\r\nhwprot.ser3 = regk_pinmux_no;\r\nbreak;\r\ncase pinmux_ser4:\r\nret = crisv32_pinmux_dealloc(PORT_A, 30, 31);\r\nhwprot.ser4 = regk_pinmux_no;\r\nbreak;\r\ncase pinmux_sser:\r\nret = crisv32_pinmux_dealloc(PORT_A, 19, 23);\r\nhwprot.sser = regk_pinmux_no;\r\nbreak;\r\ncase pinmux_pwm0:\r\nret = crisv32_pinmux_dealloc(PORT_A, 30, 30);\r\nhwprot.pwm0 = regk_pinmux_no;\r\nbreak;\r\ncase pinmux_pwm1:\r\nret = crisv32_pinmux_dealloc(PORT_A, 31, 31);\r\nhwprot.pwm1 = regk_pinmux_no;\r\nbreak;\r\ncase pinmux_pwm2:\r\nret = crisv32_pinmux_dealloc(PORT_B, 26, 26);\r\nhwprot.pwm2 = regk_pinmux_no;\r\nbreak;\r\ncase pinmux_i2c0:\r\nret = crisv32_pinmux_dealloc(PORT_A, 0, 1);\r\nhwprot.i2c0 = regk_pinmux_no;\r\nbreak;\r\ncase pinmux_i2c1:\r\nret = crisv32_pinmux_dealloc(PORT_A, 2, 3);\r\nhwprot.i2c1 = regk_pinmux_no;\r\nbreak;\r\ncase pinmux_i2c1_3wire:\r\nret = crisv32_pinmux_dealloc(PORT_A, 2, 3);\r\nret |= crisv32_pinmux_dealloc(PORT_A, 7, 7);\r\nhwprot.i2c1 = hwprot.i2c1_sen = regk_pinmux_no;\r\nbreak;\r\ncase pinmux_i2c1_sda1:\r\nret = crisv32_pinmux_dealloc(PORT_A, 2, 4);\r\nhwprot.i2c1_sda1 = regk_pinmux_no;\r\nbreak;\r\ncase pinmux_i2c1_sda2:\r\nret = crisv32_pinmux_dealloc(PORT_A, 2, 3);\r\nret |= crisv32_pinmux_dealloc(PORT_A, 5, 5);\r\nhwprot.i2c1_sda2 = regk_pinmux_no;\r\nbreak;\r\ncase pinmux_i2c1_sda3:\r\nret = crisv32_pinmux_dealloc(PORT_A, 2, 3);\r\nret |= crisv32_pinmux_dealloc(PORT_A, 6, 6);\r\nhwprot.i2c1_sda3 = regk_pinmux_no;\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nif (!ret)\r\nREG_WR(pinmux, regi_pinmux, rw_hwprot, hwprot);\r\nelse\r\nmemcpy(pins, saved, sizeof pins);\r\nspin_unlock_irqrestore(&pinmux_lock, flags);\r\nreturn ret;\r\n}\r\nvoid\r\ncrisv32_pinmux_dump(void)\r\n{\r\nint i, j;\r\nint pin = 0;\r\ncrisv32_pinmux_init();\r\nfor (i = 0; i < PORTS; i++) {\r\npin++;\r\nprintk(KERN_DEBUG "Port %c\n", 'A'+i);\r\nfor (j = 0; (j < PORT_PINS) && (pin < PINS); j++, pin++)\r\nprintk(KERN_DEBUG\r\n" Pin %d = %d\n", j, pins[i * PORT_PINS + j]);\r\n}\r\n}

static int snd_vx222_free(struct vx_core *chip)\r\n{\r\nstruct snd_vx222 *vx = (struct snd_vx222 *)chip;\r\nif (chip->irq >= 0)\r\nfree_irq(chip->irq, (void*)chip);\r\nif (vx->port[0])\r\npci_release_regions(vx->pci);\r\npci_disable_device(vx->pci);\r\nkfree(chip);\r\nreturn 0;\r\n}\r\nstatic int snd_vx222_dev_free(struct snd_device *device)\r\n{\r\nstruct vx_core *chip = device->device_data;\r\nreturn snd_vx222_free(chip);\r\n}\r\nstatic int snd_vx222_create(struct snd_card *card, struct pci_dev *pci,\r\nstruct snd_vx_hardware *hw,\r\nstruct snd_vx222 **rchip)\r\n{\r\nstruct vx_core *chip;\r\nstruct snd_vx222 *vx;\r\nint i, err;\r\nstatic struct snd_device_ops ops = {\r\n.dev_free = snd_vx222_dev_free,\r\n};\r\nstruct snd_vx_ops *vx_ops;\r\nif ((err = pci_enable_device(pci)) < 0)\r\nreturn err;\r\npci_set_master(pci);\r\nvx_ops = hw->type == VX_TYPE_BOARD ? &vx222_old_ops : &vx222_ops;\r\nchip = snd_vx_create(card, hw, vx_ops,\r\nsizeof(struct snd_vx222) - sizeof(struct vx_core));\r\nif (! chip) {\r\npci_disable_device(pci);\r\nreturn -ENOMEM;\r\n}\r\nvx = (struct snd_vx222 *)chip;\r\nvx->pci = pci;\r\nif ((err = pci_request_regions(pci, CARD_NAME)) < 0) {\r\nsnd_vx222_free(chip);\r\nreturn err;\r\n}\r\nfor (i = 0; i < 2; i++)\r\nvx->port[i] = pci_resource_start(pci, i + 1);\r\nif (request_irq(pci->irq, snd_vx_irq_handler, IRQF_SHARED,\r\nKBUILD_MODNAME, chip)) {\r\nsnd_printk(KERN_ERR "unable to grab IRQ %d\n", pci->irq);\r\nsnd_vx222_free(chip);\r\nreturn -EBUSY;\r\n}\r\nchip->irq = pci->irq;\r\nif ((err = snd_device_new(card, SNDRV_DEV_LOWLEVEL, chip, &ops)) < 0) {\r\nsnd_vx222_free(chip);\r\nreturn err;\r\n}\r\nsnd_card_set_dev(card, &pci->dev);\r\n*rchip = vx;\r\nreturn 0;\r\n}\r\nstatic int snd_vx222_probe(struct pci_dev *pci,\r\nconst struct pci_device_id *pci_id)\r\n{\r\nstatic int dev;\r\nstruct snd_card *card;\r\nstruct snd_vx_hardware *hw;\r\nstruct snd_vx222 *vx;\r\nint err;\r\nif (dev >= SNDRV_CARDS)\r\nreturn -ENODEV;\r\nif (!enable[dev]) {\r\ndev++;\r\nreturn -ENOENT;\r\n}\r\nerr = snd_card_create(index[dev], id[dev], THIS_MODULE, 0, &card);\r\nif (err < 0)\r\nreturn err;\r\nswitch ((int)pci_id->driver_data) {\r\ncase VX_PCI_VX222_OLD:\r\nhw = &vx222_old_hw;\r\nbreak;\r\ncase VX_PCI_VX222_NEW:\r\ndefault:\r\nif (mic[dev])\r\nhw = &vx222_mic_hw;\r\nelse\r\nhw = &vx222_v2_hw;\r\nbreak;\r\n}\r\nif ((err = snd_vx222_create(card, pci, hw, &vx)) < 0) {\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\ncard->private_data = vx;\r\nvx->core.ibl.size = ibl[dev];\r\nsprintf(card->longname, "%s at 0x%lx & 0x%lx, irq %i",\r\ncard->shortname, vx->port[0], vx->port[1], vx->core.irq);\r\nsnd_printdd("%s at 0x%lx & 0x%lx, irq %i\n",\r\ncard->shortname, vx->port[0], vx->port[1], vx->core.irq);\r\n#ifdef SND_VX_FW_LOADER\r\nvx->core.dev = &pci->dev;\r\n#endif\r\nif ((err = snd_vx_setup_firmware(&vx->core)) < 0) {\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\nif ((err = snd_card_register(card)) < 0) {\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\npci_set_drvdata(pci, card);\r\ndev++;\r\nreturn 0;\r\n}\r\nstatic void snd_vx222_remove(struct pci_dev *pci)\r\n{\r\nsnd_card_free(pci_get_drvdata(pci));\r\npci_set_drvdata(pci, NULL);\r\n}\r\nstatic int snd_vx222_suspend(struct device *dev)\r\n{\r\nstruct pci_dev *pci = to_pci_dev(dev);\r\nstruct snd_card *card = dev_get_drvdata(dev);\r\nstruct snd_vx222 *vx = card->private_data;\r\nint err;\r\nerr = snd_vx_suspend(&vx->core);\r\npci_disable_device(pci);\r\npci_save_state(pci);\r\npci_set_power_state(pci, PCI_D3hot);\r\nreturn err;\r\n}\r\nstatic int snd_vx222_resume(struct device *dev)\r\n{\r\nstruct pci_dev *pci = to_pci_dev(dev);\r\nstruct snd_card *card = dev_get_drvdata(dev);\r\nstruct snd_vx222 *vx = card->private_data;\r\npci_set_power_state(pci, PCI_D0);\r\npci_restore_state(pci);\r\nif (pci_enable_device(pci) < 0) {\r\nprintk(KERN_ERR "vx222: pci_enable_device failed, "\r\n"disabling device\n");\r\nsnd_card_disconnect(card);\r\nreturn -EIO;\r\n}\r\npci_set_master(pci);\r\nreturn snd_vx_resume(&vx->core);\r\n}

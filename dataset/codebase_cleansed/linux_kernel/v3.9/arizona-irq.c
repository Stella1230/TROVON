static int arizona_map_irq(struct arizona *arizona, int irq)\r\n{\r\nint ret;\r\nret = regmap_irq_get_virq(arizona->aod_irq_chip, irq);\r\nif (ret < 0)\r\nret = regmap_irq_get_virq(arizona->irq_chip, irq);\r\nreturn ret;\r\n}\r\nint arizona_request_irq(struct arizona *arizona, int irq, char *name,\r\nirq_handler_t handler, void *data)\r\n{\r\nirq = arizona_map_irq(arizona, irq);\r\nif (irq < 0)\r\nreturn irq;\r\nreturn request_threaded_irq(irq, NULL, handler, IRQF_ONESHOT,\r\nname, data);\r\n}\r\nvoid arizona_free_irq(struct arizona *arizona, int irq, void *data)\r\n{\r\nirq = arizona_map_irq(arizona, irq);\r\nif (irq < 0)\r\nreturn;\r\nfree_irq(irq, data);\r\n}\r\nint arizona_set_irq_wake(struct arizona *arizona, int irq, int on)\r\n{\r\nirq = arizona_map_irq(arizona, irq);\r\nif (irq < 0)\r\nreturn irq;\r\nreturn irq_set_irq_wake(irq, on);\r\n}\r\nstatic irqreturn_t arizona_boot_done(int irq, void *data)\r\n{\r\nstruct arizona *arizona = data;\r\ndev_dbg(arizona->dev, "Boot done\n");\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t arizona_ctrlif_err(int irq, void *data)\r\n{\r\nstruct arizona *arizona = data;\r\ndev_err(arizona->dev, "Control interface error\n");\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t arizona_irq_thread(int irq, void *data)\r\n{\r\nstruct arizona *arizona = data;\r\nunsigned int val;\r\nint ret;\r\nret = pm_runtime_get_sync(arizona->dev);\r\nif (ret < 0) {\r\ndev_err(arizona->dev, "Failed to resume device: %d\n", ret);\r\nreturn IRQ_NONE;\r\n}\r\nhandle_nested_irq(irq_find_mapping(arizona->virq, 0));\r\nret = regmap_read(arizona->regmap, ARIZONA_IRQ_PIN_STATUS, &val);\r\nif (ret == 0 && val & ARIZONA_IRQ1_STS) {\r\nhandle_nested_irq(irq_find_mapping(arizona->virq, 1));\r\n} else if (ret != 0) {\r\ndev_err(arizona->dev, "Failed to read main IRQ status: %d\n",\r\nret);\r\n}\r\npm_runtime_mark_last_busy(arizona->dev);\r\npm_runtime_put_autosuspend(arizona->dev);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void arizona_irq_enable(struct irq_data *data)\r\n{\r\n}\r\nstatic void arizona_irq_disable(struct irq_data *data)\r\n{\r\n}\r\nstatic int arizona_irq_map(struct irq_domain *h, unsigned int virq,\r\nirq_hw_number_t hw)\r\n{\r\nstruct regmap_irq_chip_data *data = h->host_data;\r\nirq_set_chip_data(virq, data);\r\nirq_set_chip_and_handler(virq, &arizona_irq_chip, handle_edge_irq);\r\nirq_set_nested_thread(virq, 1);\r\n#ifdef CONFIG_ARM\r\nset_irq_flags(virq, IRQF_VALID);\r\n#else\r\nirq_set_noprobe(virq);\r\n#endif\r\nreturn 0;\r\n}\r\nint arizona_irq_init(struct arizona *arizona)\r\n{\r\nint flags = IRQF_ONESHOT;\r\nint ret, i;\r\nconst struct regmap_irq_chip *aod, *irq;\r\nbool ctrlif_error = true;\r\nswitch (arizona->type) {\r\n#ifdef CONFIG_MFD_WM5102\r\ncase WM5102:\r\naod = &wm5102_aod;\r\nirq = &wm5102_irq;\r\nctrlif_error = false;\r\nbreak;\r\n#endif\r\n#ifdef CONFIG_MFD_WM5110\r\ncase WM5110:\r\naod = &wm5110_aod;\r\nirq = &wm5110_irq;\r\nctrlif_error = false;\r\nbreak;\r\n#endif\r\ndefault:\r\nBUG_ON("Unknown Arizona class device" == NULL);\r\nreturn -EINVAL;\r\n}\r\nif (arizona->pdata.irq_active_high) {\r\nret = regmap_update_bits(arizona->regmap, ARIZONA_IRQ_CTRL_1,\r\nARIZONA_IRQ_POL, 0);\r\nif (ret != 0) {\r\ndev_err(arizona->dev, "Couldn't set IRQ polarity: %d\n",\r\nret);\r\ngoto err;\r\n}\r\nflags |= IRQF_TRIGGER_HIGH;\r\n} else {\r\nflags |= IRQF_TRIGGER_LOW;\r\n}\r\narizona->virq = irq_domain_add_linear(NULL, 2, &arizona_domain_ops,\r\narizona);\r\nif (!arizona->virq) {\r\ndev_err(arizona->dev, "Failed to add core IRQ domain\n");\r\nret = -EINVAL;\r\ngoto err;\r\n}\r\nret = regmap_add_irq_chip(arizona->regmap,\r\nirq_create_mapping(arizona->virq, 0),\r\nIRQF_ONESHOT, -1, aod,\r\n&arizona->aod_irq_chip);\r\nif (ret != 0) {\r\ndev_err(arizona->dev, "Failed to add AOD IRQs: %d\n", ret);\r\ngoto err_domain;\r\n}\r\nret = regmap_add_irq_chip(arizona->regmap,\r\nirq_create_mapping(arizona->virq, 1),\r\nIRQF_ONESHOT, -1, irq,\r\n&arizona->irq_chip);\r\nif (ret != 0) {\r\ndev_err(arizona->dev, "Failed to add AOD IRQs: %d\n", ret);\r\ngoto err_aod;\r\n}\r\ni = arizona_map_irq(arizona, ARIZONA_IRQ_BOOT_DONE);\r\nret = request_threaded_irq(i, NULL, arizona_boot_done, IRQF_ONESHOT,\r\n"Boot done", arizona);\r\nif (ret != 0) {\r\ndev_err(arizona->dev, "Failed to request boot done %d: %d\n",\r\narizona->irq, ret);\r\ngoto err_boot_done;\r\n}\r\nif (ctrlif_error) {\r\ni = arizona_map_irq(arizona, ARIZONA_IRQ_CTRLIF_ERR);\r\nret = request_threaded_irq(i, NULL, arizona_ctrlif_err,\r\nIRQF_ONESHOT,\r\n"Control interface error", arizona);\r\nif (ret != 0) {\r\ndev_err(arizona->dev,\r\n"Failed to request CTRLIF_ERR %d: %d\n",\r\narizona->irq, ret);\r\ngoto err_ctrlif;\r\n}\r\n}\r\nret = request_threaded_irq(arizona->irq, NULL, arizona_irq_thread,\r\nflags, "arizona", arizona);\r\nif (ret != 0) {\r\ndev_err(arizona->dev, "Failed to request IRQ %d: %d\n",\r\narizona->irq, ret);\r\ngoto err_main_irq;\r\n}\r\nreturn 0;\r\nerr_main_irq:\r\nfree_irq(arizona_map_irq(arizona, ARIZONA_IRQ_CTRLIF_ERR), arizona);\r\nerr_ctrlif:\r\nfree_irq(arizona_map_irq(arizona, ARIZONA_IRQ_BOOT_DONE), arizona);\r\nerr_boot_done:\r\nregmap_del_irq_chip(irq_create_mapping(arizona->virq, 1),\r\narizona->irq_chip);\r\nerr_aod:\r\nregmap_del_irq_chip(irq_create_mapping(arizona->virq, 0),\r\narizona->aod_irq_chip);\r\nerr_domain:\r\nerr:\r\nreturn ret;\r\n}\r\nint arizona_irq_exit(struct arizona *arizona)\r\n{\r\nfree_irq(arizona_map_irq(arizona, ARIZONA_IRQ_CTRLIF_ERR), arizona);\r\nfree_irq(arizona_map_irq(arizona, ARIZONA_IRQ_BOOT_DONE), arizona);\r\nregmap_del_irq_chip(irq_create_mapping(arizona->virq, 1),\r\narizona->irq_chip);\r\nregmap_del_irq_chip(irq_create_mapping(arizona->virq, 0),\r\narizona->aod_irq_chip);\r\nfree_irq(arizona->irq, arizona);\r\nreturn 0;\r\n}

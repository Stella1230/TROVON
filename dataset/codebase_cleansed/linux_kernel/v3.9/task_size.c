static void segfault(int sig)\r\n{\r\nlongjmp(buf, 1);\r\n}\r\nstatic int page_ok(unsigned long page)\r\n{\r\nunsigned long *address = (unsigned long *) (page << UM_KERN_PAGE_SHIFT);\r\nunsigned long n = ~0UL;\r\nvoid *mapped = NULL;\r\nint ok = 0;\r\nif (setjmp(buf) == 0)\r\nn = *address;\r\nelse {\r\nmapped = mmap(address, UM_KERN_PAGE_SIZE,\r\nPROT_READ | PROT_WRITE,\r\nMAP_FIXED | MAP_PRIVATE | MAP_ANONYMOUS, -1, 0);\r\nif (mapped == MAP_FAILED)\r\nreturn 0;\r\nif (mapped != address)\r\ngoto out;\r\n}\r\nif (setjmp(buf) == 0) {\r\n*address = n;\r\nok = 1;\r\ngoto out;\r\n} else if (mprotect(address, UM_KERN_PAGE_SIZE,\r\nPROT_READ | PROT_WRITE) != 0)\r\ngoto out;\r\nif (setjmp(buf) == 0) {\r\n*address = n;\r\nok = 1;\r\n}\r\nout:\r\nif (mapped != NULL)\r\nmunmap(mapped, UM_KERN_PAGE_SIZE);\r\nreturn ok;\r\n}\r\nunsigned long os_get_top_address(void)\r\n{\r\nstruct sigaction sa, old;\r\nunsigned long bottom = 0;\r\nunsigned long top = 0xffffd000 >> UM_KERN_PAGE_SHIFT;\r\nunsigned long test, original;\r\nprintf("Locating the bottom of the address space ... ");\r\nfflush(stdout);\r\nsa.sa_handler = segfault;\r\nsigemptyset(&sa.sa_mask);\r\nsa.sa_flags = SA_NODEFER;\r\nif (sigaction(SIGSEGV, &sa, &old)) {\r\nperror("os_get_top_address");\r\nexit(1);\r\n}\r\nfor (bottom = 0; bottom < top; bottom++) {\r\nif (page_ok(bottom))\r\nbreak;\r\n}\r\nif (bottom == top) {\r\nfprintf(stderr, "Unable to determine bottom of address "\r\n"space.\n");\r\nexit(1);\r\n}\r\nprintf("0x%x\n", bottom << UM_KERN_PAGE_SHIFT);\r\nprintf("Locating the top of the address space ... ");\r\nfflush(stdout);\r\noriginal = bottom;\r\nif (page_ok(top))\r\ngoto out;\r\ndo {\r\ntest = bottom + (top - bottom) / 2;\r\nif (page_ok(test))\r\nbottom = test;\r\nelse\r\ntop = test;\r\n} while (top - bottom > 1);\r\nout:\r\nif (sigaction(SIGSEGV, &old, NULL)) {\r\nperror("os_get_top_address");\r\nexit(1);\r\n}\r\ntop <<= UM_KERN_PAGE_SHIFT;\r\nprintf("0x%x\n", top);\r\nreturn top;\r\n}\r\nunsigned long os_get_top_address(void)\r\n{\r\nreturn 0x7fc0000000;\r\n}

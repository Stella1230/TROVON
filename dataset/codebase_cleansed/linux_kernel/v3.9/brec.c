u16 hfs_brec_lenoff(struct hfs_bnode *node, u16 rec, u16 *off)\r\n{\r\n__be16 retval[2];\r\nu16 dataoff;\r\ndataoff = node->tree->node_size - (rec + 2) * 2;\r\nhfs_bnode_read(node, retval, dataoff, 4);\r\n*off = be16_to_cpu(retval[1]);\r\nreturn be16_to_cpu(retval[0]) - *off;\r\n}\r\nu16 hfs_brec_keylen(struct hfs_bnode *node, u16 rec)\r\n{\r\nu16 retval, recoff;\r\nif (node->type != HFS_NODE_INDEX && node->type != HFS_NODE_LEAF)\r\nreturn 0;\r\nif ((node->type == HFS_NODE_INDEX) &&\r\n!(node->tree->attributes & HFS_TREE_VARIDXKEYS)) {\r\nif (node->tree->attributes & HFS_TREE_BIGKEYS)\r\nretval = node->tree->max_key_len + 2;\r\nelse\r\nretval = node->tree->max_key_len + 1;\r\n} else {\r\nrecoff = hfs_bnode_read_u16(node, node->tree->node_size - (rec + 1) * 2);\r\nif (!recoff)\r\nreturn 0;\r\nif (node->tree->attributes & HFS_TREE_BIGKEYS) {\r\nretval = hfs_bnode_read_u16(node, recoff) + 2;\r\nif (retval > node->tree->max_key_len + 2) {\r\nprintk(KERN_ERR "hfs: keylen %d too large\n",\r\nretval);\r\nretval = 0;\r\n}\r\n} else {\r\nretval = (hfs_bnode_read_u8(node, recoff) | 1) + 1;\r\nif (retval > node->tree->max_key_len + 1) {\r\nprintk(KERN_ERR "hfs: keylen %d too large\n",\r\nretval);\r\nretval = 0;\r\n}\r\n}\r\n}\r\nreturn retval;\r\n}\r\nint hfs_brec_insert(struct hfs_find_data *fd, void *entry, int entry_len)\r\n{\r\nstruct hfs_btree *tree;\r\nstruct hfs_bnode *node, *new_node;\r\nint size, key_len, rec;\r\nint data_off, end_off;\r\nint idx_rec_off, data_rec_off, end_rec_off;\r\n__be32 cnid;\r\ntree = fd->tree;\r\nif (!fd->bnode) {\r\nif (!tree->root)\r\nhfs_btree_inc_height(tree);\r\nfd->bnode = hfs_bnode_find(tree, tree->leaf_head);\r\nif (IS_ERR(fd->bnode))\r\nreturn PTR_ERR(fd->bnode);\r\nfd->record = -1;\r\n}\r\nnew_node = NULL;\r\nkey_len = (fd->search_key->key_len | 1) + 1;\r\nagain:\r\nrec = fd->record + 1;\r\nsize = key_len + entry_len;\r\nnode = fd->bnode;\r\nhfs_bnode_dump(node);\r\nend_rec_off = tree->node_size - (node->num_recs + 1) * 2;\r\nend_off = hfs_bnode_read_u16(node, end_rec_off);\r\nend_rec_off -= 2;\r\ndprint(DBG_BNODE_MOD, "insert_rec: %d, %d, %d, %d\n", rec, size, end_off, end_rec_off);\r\nif (size > end_rec_off - end_off) {\r\nif (new_node)\r\npanic("not enough room!\n");\r\nnew_node = hfs_bnode_split(fd);\r\nif (IS_ERR(new_node))\r\nreturn PTR_ERR(new_node);\r\ngoto again;\r\n}\r\nif (node->type == HFS_NODE_LEAF) {\r\ntree->leaf_count++;\r\nmark_inode_dirty(tree->inode);\r\n}\r\nnode->num_recs++;\r\nhfs_bnode_write_u16(node, offsetof(struct hfs_bnode_desc, num_recs), node->num_recs);\r\nhfs_bnode_write_u16(node, end_rec_off, end_off + size);\r\ndata_off = end_off;\r\ndata_rec_off = end_rec_off + 2;\r\nidx_rec_off = tree->node_size - (rec + 1) * 2;\r\nif (idx_rec_off == data_rec_off)\r\ngoto skip;\r\ndo {\r\ndata_off = hfs_bnode_read_u16(node, data_rec_off + 2);\r\nhfs_bnode_write_u16(node, data_rec_off, data_off + size);\r\ndata_rec_off += 2;\r\n} while (data_rec_off < idx_rec_off);\r\nhfs_bnode_move(node, data_off + size, data_off,\r\nend_off - data_off);\r\nskip:\r\nhfs_bnode_write(node, fd->search_key, data_off, key_len);\r\nhfs_bnode_write(node, entry, data_off + key_len, entry_len);\r\nhfs_bnode_dump(node);\r\nif (new_node) {\r\nif (!rec && new_node != node)\r\nhfs_brec_update_parent(fd);\r\nhfs_bnode_put(fd->bnode);\r\nif (!new_node->parent) {\r\nhfs_btree_inc_height(tree);\r\nnew_node->parent = tree->root;\r\n}\r\nfd->bnode = hfs_bnode_find(tree, new_node->parent);\r\ncnid = cpu_to_be32(new_node->this);\r\nentry = &cnid;\r\nentry_len = sizeof(cnid);\r\nhfs_bnode_read_key(new_node, fd->search_key, 14);\r\n__hfs_brec_find(fd->bnode, fd);\r\nhfs_bnode_put(new_node);\r\nnew_node = NULL;\r\nif (tree->attributes & HFS_TREE_VARIDXKEYS)\r\nkey_len = fd->search_key->key_len + 1;\r\nelse {\r\nfd->search_key->key_len = tree->max_key_len;\r\nkey_len = tree->max_key_len + 1;\r\n}\r\ngoto again;\r\n}\r\nif (!rec)\r\nhfs_brec_update_parent(fd);\r\nreturn 0;\r\n}\r\nint hfs_brec_remove(struct hfs_find_data *fd)\r\n{\r\nstruct hfs_btree *tree;\r\nstruct hfs_bnode *node, *parent;\r\nint end_off, rec_off, data_off, size;\r\ntree = fd->tree;\r\nnode = fd->bnode;\r\nagain:\r\nrec_off = tree->node_size - (fd->record + 2) * 2;\r\nend_off = tree->node_size - (node->num_recs + 1) * 2;\r\nif (node->type == HFS_NODE_LEAF) {\r\ntree->leaf_count--;\r\nmark_inode_dirty(tree->inode);\r\n}\r\nhfs_bnode_dump(node);\r\ndprint(DBG_BNODE_MOD, "remove_rec: %d, %d\n", fd->record, fd->keylength + fd->entrylength);\r\nif (!--node->num_recs) {\r\nhfs_bnode_unlink(node);\r\nif (!node->parent)\r\nreturn 0;\r\nparent = hfs_bnode_find(tree, node->parent);\r\nif (IS_ERR(parent))\r\nreturn PTR_ERR(parent);\r\nhfs_bnode_put(node);\r\nnode = fd->bnode = parent;\r\n__hfs_brec_find(node, fd);\r\ngoto again;\r\n}\r\nhfs_bnode_write_u16(node, offsetof(struct hfs_bnode_desc, num_recs), node->num_recs);\r\nif (rec_off == end_off)\r\ngoto skip;\r\nsize = fd->keylength + fd->entrylength;\r\ndo {\r\ndata_off = hfs_bnode_read_u16(node, rec_off);\r\nhfs_bnode_write_u16(node, rec_off + 2, data_off - size);\r\nrec_off -= 2;\r\n} while (rec_off >= end_off);\r\nhfs_bnode_move(node, fd->keyoffset, fd->keyoffset + size,\r\ndata_off - fd->keyoffset - size);\r\nskip:\r\nhfs_bnode_dump(node);\r\nif (!fd->record)\r\nhfs_brec_update_parent(fd);\r\nreturn 0;\r\n}\r\nstatic struct hfs_bnode *hfs_bnode_split(struct hfs_find_data *fd)\r\n{\r\nstruct hfs_btree *tree;\r\nstruct hfs_bnode *node, *new_node, *next_node;\r\nstruct hfs_bnode_desc node_desc;\r\nint num_recs, new_rec_off, new_off, old_rec_off;\r\nint data_start, data_end, size;\r\ntree = fd->tree;\r\nnode = fd->bnode;\r\nnew_node = hfs_bmap_alloc(tree);\r\nif (IS_ERR(new_node))\r\nreturn new_node;\r\nhfs_bnode_get(node);\r\ndprint(DBG_BNODE_MOD, "split_nodes: %d - %d - %d\n",\r\nnode->this, new_node->this, node->next);\r\nnew_node->next = node->next;\r\nnew_node->prev = node->this;\r\nnew_node->parent = node->parent;\r\nnew_node->type = node->type;\r\nnew_node->height = node->height;\r\nif (node->next)\r\nnext_node = hfs_bnode_find(tree, node->next);\r\nelse\r\nnext_node = NULL;\r\nif (IS_ERR(next_node)) {\r\nhfs_bnode_put(node);\r\nhfs_bnode_put(new_node);\r\nreturn next_node;\r\n}\r\nsize = tree->node_size / 2 - node->num_recs * 2 - 14;\r\nold_rec_off = tree->node_size - 4;\r\nnum_recs = 1;\r\nfor (;;) {\r\ndata_start = hfs_bnode_read_u16(node, old_rec_off);\r\nif (data_start > size)\r\nbreak;\r\nold_rec_off -= 2;\r\nif (++num_recs < node->num_recs)\r\ncontinue;\r\nhfs_bnode_put(node);\r\nhfs_bnode_put(new_node);\r\nif (next_node)\r\nhfs_bnode_put(next_node);\r\nreturn ERR_PTR(-ENOSPC);\r\n}\r\nif (fd->record + 1 < num_recs) {\r\nold_rec_off += 2;\r\nnum_recs--;\r\ndata_start = hfs_bnode_read_u16(node, old_rec_off);\r\n} else {\r\nhfs_bnode_put(node);\r\nhfs_bnode_get(new_node);\r\nfd->bnode = new_node;\r\nfd->record -= num_recs;\r\nfd->keyoffset -= data_start - 14;\r\nfd->entryoffset -= data_start - 14;\r\n}\r\nnew_node->num_recs = node->num_recs - num_recs;\r\nnode->num_recs = num_recs;\r\nnew_rec_off = tree->node_size - 2;\r\nnew_off = 14;\r\nsize = data_start - new_off;\r\nnum_recs = new_node->num_recs;\r\ndata_end = data_start;\r\nwhile (num_recs) {\r\nhfs_bnode_write_u16(new_node, new_rec_off, new_off);\r\nold_rec_off -= 2;\r\nnew_rec_off -= 2;\r\ndata_end = hfs_bnode_read_u16(node, old_rec_off);\r\nnew_off = data_end - size;\r\nnum_recs--;\r\n}\r\nhfs_bnode_write_u16(new_node, new_rec_off, new_off);\r\nhfs_bnode_copy(new_node, 14, node, data_start, data_end - data_start);\r\nnode_desc.next = cpu_to_be32(new_node->next);\r\nnode_desc.prev = cpu_to_be32(new_node->prev);\r\nnode_desc.type = new_node->type;\r\nnode_desc.height = new_node->height;\r\nnode_desc.num_recs = cpu_to_be16(new_node->num_recs);\r\nnode_desc.reserved = 0;\r\nhfs_bnode_write(new_node, &node_desc, 0, sizeof(node_desc));\r\nnode->next = new_node->this;\r\nhfs_bnode_read(node, &node_desc, 0, sizeof(node_desc));\r\nnode_desc.next = cpu_to_be32(node->next);\r\nnode_desc.num_recs = cpu_to_be16(node->num_recs);\r\nhfs_bnode_write(node, &node_desc, 0, sizeof(node_desc));\r\nif (next_node) {\r\nnext_node->prev = new_node->this;\r\nhfs_bnode_read(next_node, &node_desc, 0, sizeof(node_desc));\r\nnode_desc.prev = cpu_to_be32(next_node->prev);\r\nhfs_bnode_write(next_node, &node_desc, 0, sizeof(node_desc));\r\nhfs_bnode_put(next_node);\r\n} else if (node->this == tree->leaf_tail) {\r\ntree->leaf_tail = new_node->this;\r\nmark_inode_dirty(tree->inode);\r\n}\r\nhfs_bnode_dump(node);\r\nhfs_bnode_dump(new_node);\r\nhfs_bnode_put(node);\r\nreturn new_node;\r\n}\r\nstatic int hfs_brec_update_parent(struct hfs_find_data *fd)\r\n{\r\nstruct hfs_btree *tree;\r\nstruct hfs_bnode *node, *new_node, *parent;\r\nint newkeylen, diff;\r\nint rec, rec_off, end_rec_off;\r\nint start_off, end_off;\r\ntree = fd->tree;\r\nnode = fd->bnode;\r\nnew_node = NULL;\r\nif (!node->parent)\r\nreturn 0;\r\nagain:\r\nparent = hfs_bnode_find(tree, node->parent);\r\nif (IS_ERR(parent))\r\nreturn PTR_ERR(parent);\r\n__hfs_brec_find(parent, fd);\r\nhfs_bnode_dump(parent);\r\nrec = fd->record;\r\nif (tree->attributes & HFS_TREE_VARIDXKEYS)\r\nnewkeylen = (hfs_bnode_read_u8(node, 14) | 1) + 1;\r\nelse\r\nfd->keylength = newkeylen = tree->max_key_len + 1;\r\ndprint(DBG_BNODE_MOD, "update_rec: %d, %d, %d\n", rec, fd->keylength, newkeylen);\r\nrec_off = tree->node_size - (rec + 2) * 2;\r\nend_rec_off = tree->node_size - (parent->num_recs + 1) * 2;\r\ndiff = newkeylen - fd->keylength;\r\nif (!diff)\r\ngoto skip;\r\nif (diff > 0) {\r\nend_off = hfs_bnode_read_u16(parent, end_rec_off);\r\nif (end_rec_off - end_off < diff) {\r\nprintk(KERN_DEBUG "hfs: splitting index node...\n");\r\nfd->bnode = parent;\r\nnew_node = hfs_bnode_split(fd);\r\nif (IS_ERR(new_node))\r\nreturn PTR_ERR(new_node);\r\nparent = fd->bnode;\r\nrec = fd->record;\r\nrec_off = tree->node_size - (rec + 2) * 2;\r\nend_rec_off = tree->node_size - (parent->num_recs + 1) * 2;\r\n}\r\n}\r\nend_off = start_off = hfs_bnode_read_u16(parent, rec_off);\r\nhfs_bnode_write_u16(parent, rec_off, start_off + diff);\r\nstart_off -= 4;\r\nwhile (rec_off > end_rec_off) {\r\nrec_off -= 2;\r\nend_off = hfs_bnode_read_u16(parent, rec_off);\r\nhfs_bnode_write_u16(parent, rec_off, end_off + diff);\r\n}\r\nhfs_bnode_move(parent, start_off + diff, start_off,\r\nend_off - start_off);\r\nskip:\r\nhfs_bnode_copy(parent, fd->keyoffset, node, 14, newkeylen);\r\nif (!(tree->attributes & HFS_TREE_VARIDXKEYS))\r\nhfs_bnode_write_u8(parent, fd->keyoffset, newkeylen - 1);\r\nhfs_bnode_dump(parent);\r\nhfs_bnode_put(node);\r\nnode = parent;\r\nif (new_node) {\r\n__be32 cnid;\r\nfd->bnode = hfs_bnode_find(tree, new_node->parent);\r\nhfs_bnode_read_key(new_node, fd->search_key, 14);\r\ncnid = cpu_to_be32(new_node->this);\r\n__hfs_brec_find(fd->bnode, fd);\r\nhfs_brec_insert(fd, &cnid, sizeof(cnid));\r\nhfs_bnode_put(fd->bnode);\r\nhfs_bnode_put(new_node);\r\nif (!rec) {\r\nif (new_node == node)\r\ngoto out;\r\nhfs_bnode_read_key(node, fd->search_key, 14);\r\n}\r\n}\r\nif (!rec && node->parent)\r\ngoto again;\r\nout:\r\nfd->bnode = node;\r\nreturn 0;\r\n}\r\nstatic int hfs_btree_inc_height(struct hfs_btree *tree)\r\n{\r\nstruct hfs_bnode *node, *new_node;\r\nstruct hfs_bnode_desc node_desc;\r\nint key_size, rec;\r\n__be32 cnid;\r\nnode = NULL;\r\nif (tree->root) {\r\nnode = hfs_bnode_find(tree, tree->root);\r\nif (IS_ERR(node))\r\nreturn PTR_ERR(node);\r\n}\r\nnew_node = hfs_bmap_alloc(tree);\r\nif (IS_ERR(new_node)) {\r\nhfs_bnode_put(node);\r\nreturn PTR_ERR(new_node);\r\n}\r\ntree->root = new_node->this;\r\nif (!tree->depth) {\r\ntree->leaf_head = tree->leaf_tail = new_node->this;\r\nnew_node->type = HFS_NODE_LEAF;\r\nnew_node->num_recs = 0;\r\n} else {\r\nnew_node->type = HFS_NODE_INDEX;\r\nnew_node->num_recs = 1;\r\n}\r\nnew_node->parent = 0;\r\nnew_node->next = 0;\r\nnew_node->prev = 0;\r\nnew_node->height = ++tree->depth;\r\nnode_desc.next = cpu_to_be32(new_node->next);\r\nnode_desc.prev = cpu_to_be32(new_node->prev);\r\nnode_desc.type = new_node->type;\r\nnode_desc.height = new_node->height;\r\nnode_desc.num_recs = cpu_to_be16(new_node->num_recs);\r\nnode_desc.reserved = 0;\r\nhfs_bnode_write(new_node, &node_desc, 0, sizeof(node_desc));\r\nrec = tree->node_size - 2;\r\nhfs_bnode_write_u16(new_node, rec, 14);\r\nif (node) {\r\nnode->parent = tree->root;\r\nif (node->type == HFS_NODE_LEAF ||\r\ntree->attributes & HFS_TREE_VARIDXKEYS)\r\nkey_size = hfs_bnode_read_u8(node, 14) + 1;\r\nelse\r\nkey_size = tree->max_key_len + 1;\r\nhfs_bnode_copy(new_node, 14, node, 14, key_size);\r\nif (!(tree->attributes & HFS_TREE_VARIDXKEYS)) {\r\nkey_size = tree->max_key_len + 1;\r\nhfs_bnode_write_u8(new_node, 14, tree->max_key_len);\r\n}\r\nkey_size = (key_size + 1) & -2;\r\ncnid = cpu_to_be32(node->this);\r\nhfs_bnode_write(new_node, &cnid, 14 + key_size, 4);\r\nrec -= 2;\r\nhfs_bnode_write_u16(new_node, rec, 14 + key_size + 4);\r\nhfs_bnode_put(node);\r\n}\r\nhfs_bnode_put(new_node);\r\nmark_inode_dirty(tree->inode);\r\nreturn 0;\r\n}

struct fc_lport *libfc_vport_create(struct fc_vport *vport, int privsize)\r\n{\r\nstruct Scsi_Host *shost = vport_to_shost(vport);\r\nstruct fc_lport *n_port = shost_priv(shost);\r\nstruct fc_lport *vn_port;\r\nvn_port = libfc_host_alloc(shost->hostt, privsize);\r\nif (!vn_port)\r\nreturn vn_port;\r\nvn_port->vport = vport;\r\nvport->dd_data = vn_port;\r\nmutex_lock(&n_port->lp_mutex);\r\nlist_add_tail(&vn_port->list, &n_port->vports);\r\nmutex_unlock(&n_port->lp_mutex);\r\nreturn vn_port;\r\n}\r\nstruct fc_lport *fc_vport_id_lookup(struct fc_lport *n_port, u32 port_id)\r\n{\r\nstruct fc_lport *lport = NULL;\r\nstruct fc_lport *vn_port;\r\nif (n_port->port_id == port_id)\r\nreturn n_port;\r\nif (port_id == FC_FID_FLOGI)\r\nreturn n_port;\r\nmutex_lock(&n_port->lp_mutex);\r\nlist_for_each_entry(vn_port, &n_port->vports, list) {\r\nif (vn_port->port_id == port_id) {\r\nlport = vn_port;\r\nbreak;\r\n}\r\n}\r\nmutex_unlock(&n_port->lp_mutex);\r\nreturn lport;\r\n}\r\nstatic void __fc_vport_setlink(struct fc_lport *n_port,\r\nstruct fc_lport *vn_port)\r\n{\r\nstruct fc_vport *vport = vn_port->vport;\r\nif (vn_port->state == LPORT_ST_DISABLED)\r\nreturn;\r\nif (n_port->state == LPORT_ST_READY) {\r\nif (n_port->npiv_enabled) {\r\nfc_vport_set_state(vport, FC_VPORT_INITIALIZING);\r\n__fc_linkup(vn_port);\r\n} else {\r\nfc_vport_set_state(vport, FC_VPORT_NO_FABRIC_SUPP);\r\n__fc_linkdown(vn_port);\r\n}\r\n} else {\r\nfc_vport_set_state(vport, FC_VPORT_LINKDOWN);\r\n__fc_linkdown(vn_port);\r\n}\r\n}\r\nvoid fc_vport_setlink(struct fc_lport *vn_port)\r\n{\r\nstruct fc_vport *vport = vn_port->vport;\r\nstruct Scsi_Host *shost = vport_to_shost(vport);\r\nstruct fc_lport *n_port = shost_priv(shost);\r\nmutex_lock(&n_port->lp_mutex);\r\nmutex_lock_nested(&vn_port->lp_mutex, LPORT_MUTEX_VN_PORT);\r\n__fc_vport_setlink(n_port, vn_port);\r\nmutex_unlock(&vn_port->lp_mutex);\r\nmutex_unlock(&n_port->lp_mutex);\r\n}\r\nvoid fc_vports_linkchange(struct fc_lport *n_port)\r\n{\r\nstruct fc_lport *vn_port;\r\nlist_for_each_entry(vn_port, &n_port->vports, list) {\r\nmutex_lock_nested(&vn_port->lp_mutex, LPORT_MUTEX_VN_PORT);\r\n__fc_vport_setlink(n_port, vn_port);\r\nmutex_unlock(&vn_port->lp_mutex);\r\n}\r\n}

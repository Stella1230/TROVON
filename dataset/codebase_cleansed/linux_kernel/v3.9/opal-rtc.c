static void opal_to_tm(u32 y_m_d, u64 h_m_s_ms, struct rtc_time *tm)\r\n{\r\ntm->tm_year = ((bcd2bin(y_m_d >> 24) * 100) +\r\nbcd2bin((y_m_d >> 16) & 0xff)) - 1900;\r\ntm->tm_mon = bcd2bin((y_m_d >> 8) & 0xff) - 1;\r\ntm->tm_mday = bcd2bin(y_m_d & 0xff);\r\ntm->tm_hour = bcd2bin((h_m_s_ms >> 56) & 0xff);\r\ntm->tm_min = bcd2bin((h_m_s_ms >> 48) & 0xff);\r\ntm->tm_sec = bcd2bin((h_m_s_ms >> 40) & 0xff);\r\nGregorianDay(tm);\r\n}\r\nunsigned long __init opal_get_boot_time(void)\r\n{\r\nstruct rtc_time tm;\r\nu32 y_m_d;\r\nu64 h_m_s_ms;\r\nlong rc = OPAL_BUSY;\r\nwhile (rc == OPAL_BUSY || rc == OPAL_BUSY_EVENT) {\r\nrc = opal_rtc_read(&y_m_d, &h_m_s_ms);\r\nif (rc == OPAL_BUSY_EVENT)\r\nopal_poll_events(NULL);\r\nelse\r\nmdelay(10);\r\n}\r\nif (rc != OPAL_SUCCESS)\r\nreturn 0;\r\nopal_to_tm(y_m_d, h_m_s_ms, &tm);\r\nreturn mktime(tm.tm_year + 1900, tm.tm_mon + 1, tm.tm_mday,\r\ntm.tm_hour, tm.tm_min, tm.tm_sec);\r\n}\r\nvoid opal_get_rtc_time(struct rtc_time *tm)\r\n{\r\nlong rc = OPAL_BUSY;\r\nu32 y_m_d;\r\nu64 h_m_s_ms;\r\nwhile (rc == OPAL_BUSY || rc == OPAL_BUSY_EVENT) {\r\nrc = opal_rtc_read(&y_m_d, &h_m_s_ms);\r\nif (rc == OPAL_BUSY_EVENT)\r\nopal_poll_events(NULL);\r\nelse\r\nmdelay(10);\r\n}\r\nif (rc != OPAL_SUCCESS)\r\nreturn;\r\nopal_to_tm(y_m_d, h_m_s_ms, tm);\r\n}\r\nint opal_set_rtc_time(struct rtc_time *tm)\r\n{\r\nlong rc = OPAL_BUSY;\r\nu32 y_m_d = 0;\r\nu64 h_m_s_ms = 0;\r\ny_m_d |= ((u32)bin2bcd((tm->tm_year + 1900) / 100)) << 24;\r\ny_m_d |= ((u32)bin2bcd((tm->tm_year + 1900) % 100)) << 16;\r\ny_m_d |= ((u32)bin2bcd((tm->tm_mon + 1))) << 8;\r\ny_m_d |= ((u32)bin2bcd(tm->tm_mday));\r\nh_m_s_ms |= ((u64)bin2bcd(tm->tm_hour)) << 56;\r\nh_m_s_ms |= ((u64)bin2bcd(tm->tm_min)) << 48;\r\nh_m_s_ms |= ((u64)bin2bcd(tm->tm_sec)) << 40;\r\nwhile (rc == OPAL_BUSY || rc == OPAL_BUSY_EVENT) {\r\nrc = opal_rtc_write(y_m_d, h_m_s_ms);\r\nif (rc == OPAL_BUSY_EVENT)\r\nopal_poll_events(NULL);\r\nelse\r\nmdelay(10);\r\n}\r\nreturn rc == OPAL_SUCCESS ? 0 : -EIO;\r\n}

static int tnetv107x_gpio_request(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct davinci_gpio_controller *ctlr = chip2controller(chip);\r\nstruct tnetv107x_gpio_regs __iomem *regs = ctlr->regs;\r\nunsigned gpio = chip->base + offset;\r\nunsigned long flags;\r\nspin_lock_irqsave(&ctlr->lock, flags);\r\ngpio_reg_set_bit(regs->enable, gpio);\r\nspin_unlock_irqrestore(&ctlr->lock, flags);\r\nreturn 0;\r\n}\r\nstatic void tnetv107x_gpio_free(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct davinci_gpio_controller *ctlr = chip2controller(chip);\r\nstruct tnetv107x_gpio_regs __iomem *regs = ctlr->regs;\r\nunsigned gpio = chip->base + offset;\r\nunsigned long flags;\r\nspin_lock_irqsave(&ctlr->lock, flags);\r\ngpio_reg_clear_bit(regs->enable, gpio);\r\nspin_unlock_irqrestore(&ctlr->lock, flags);\r\n}\r\nstatic int tnetv107x_gpio_dir_in(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct davinci_gpio_controller *ctlr = chip2controller(chip);\r\nstruct tnetv107x_gpio_regs __iomem *regs = ctlr->regs;\r\nunsigned gpio = chip->base + offset;\r\nunsigned long flags;\r\nspin_lock_irqsave(&ctlr->lock, flags);\r\ngpio_reg_set_bit(regs->direction, gpio);\r\nspin_unlock_irqrestore(&ctlr->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int tnetv107x_gpio_dir_out(struct gpio_chip *chip,\r\nunsigned offset, int value)\r\n{\r\nstruct davinci_gpio_controller *ctlr = chip2controller(chip);\r\nstruct tnetv107x_gpio_regs __iomem *regs = ctlr->regs;\r\nunsigned gpio = chip->base + offset;\r\nunsigned long flags;\r\nspin_lock_irqsave(&ctlr->lock, flags);\r\nif (value)\r\ngpio_reg_set_bit(regs->data_out, gpio);\r\nelse\r\ngpio_reg_clear_bit(regs->data_out, gpio);\r\ngpio_reg_clear_bit(regs->direction, gpio);\r\nspin_unlock_irqrestore(&ctlr->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int tnetv107x_gpio_get(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct davinci_gpio_controller *ctlr = chip2controller(chip);\r\nstruct tnetv107x_gpio_regs __iomem *regs = ctlr->regs;\r\nunsigned gpio = chip->base + offset;\r\nint ret;\r\nret = gpio_reg_get_bit(regs->data_in, gpio);\r\nreturn ret ? 1 : 0;\r\n}\r\nstatic void tnetv107x_gpio_set(struct gpio_chip *chip,\r\nunsigned offset, int value)\r\n{\r\nstruct davinci_gpio_controller *ctlr = chip2controller(chip);\r\nstruct tnetv107x_gpio_regs __iomem *regs = ctlr->regs;\r\nunsigned gpio = chip->base + offset;\r\nunsigned long flags;\r\nspin_lock_irqsave(&ctlr->lock, flags);\r\nif (value)\r\ngpio_reg_set_bit(regs->data_out, gpio);\r\nelse\r\ngpio_reg_clear_bit(regs->data_out, gpio);\r\nspin_unlock_irqrestore(&ctlr->lock, flags);\r\n}\r\nstatic int __init tnetv107x_gpio_setup(void)\r\n{\r\nint i, base;\r\nunsigned ngpio;\r\nstruct davinci_soc_info *soc_info = &davinci_soc_info;\r\nstruct tnetv107x_gpio_regs *regs;\r\nstruct davinci_gpio_controller *ctlr;\r\nif (soc_info->gpio_type != GPIO_TYPE_TNETV107X)\r\nreturn 0;\r\nngpio = soc_info->gpio_num;\r\nif (ngpio == 0) {\r\npr_err("GPIO setup: how many GPIOs?\n");\r\nreturn -EINVAL;\r\n}\r\nif (WARN_ON(TNETV107X_N_GPIO < ngpio))\r\nngpio = TNETV107X_N_GPIO;\r\nregs = ioremap(soc_info->gpio_base, SZ_4K);\r\nif (WARN_ON(!regs))\r\nreturn -EINVAL;\r\nfor (i = 0, base = 0; base < ngpio; i++, base += 32) {\r\nctlr = &chips[i];\r\nctlr->chip.label = "tnetv107x";\r\nctlr->chip.can_sleep = 0;\r\nctlr->chip.base = base;\r\nctlr->chip.ngpio = ngpio - base;\r\nif (ctlr->chip.ngpio > 32)\r\nctlr->chip.ngpio = 32;\r\nctlr->chip.request = tnetv107x_gpio_request;\r\nctlr->chip.free = tnetv107x_gpio_free;\r\nctlr->chip.direction_input = tnetv107x_gpio_dir_in;\r\nctlr->chip.get = tnetv107x_gpio_get;\r\nctlr->chip.direction_output = tnetv107x_gpio_dir_out;\r\nctlr->chip.set = tnetv107x_gpio_set;\r\nspin_lock_init(&ctlr->lock);\r\nctlr->regs = regs;\r\nctlr->set_data = &regs->data_out[i];\r\nctlr->clr_data = &regs->data_out[i];\r\nctlr->in_data = &regs->data_in[i];\r\ngpiochip_add(&ctlr->chip);\r\n}\r\nsoc_info->gpio_ctlrs = chips;\r\nsoc_info->gpio_ctlrs_num = DIV_ROUND_UP(ngpio, 32);\r\nreturn 0;\r\n}

static int gpio_clps711x_get(struct gpio_chip *chip, unsigned offset)\r\n{\r\nreturn !!(readb(clps711x_port(chip)) & (1 << offset));\r\n}\r\nstatic void gpio_clps711x_set(struct gpio_chip *chip, unsigned offset,\r\nint value)\r\n{\r\nint tmp;\r\nunsigned long flags;\r\nstruct clps711x_gpio *gpio = dev_get_drvdata(chip->dev);\r\nspin_lock_irqsave(&gpio->lock, flags);\r\ntmp = readb(clps711x_port(chip)) & ~(1 << offset);\r\nif (value)\r\ntmp |= 1 << offset;\r\nwriteb(tmp, clps711x_port(chip));\r\nspin_unlock_irqrestore(&gpio->lock, flags);\r\n}\r\nstatic int gpio_clps711x_dir_in(struct gpio_chip *chip, unsigned offset)\r\n{\r\nint tmp;\r\nunsigned long flags;\r\nstruct clps711x_gpio *gpio = dev_get_drvdata(chip->dev);\r\nspin_lock_irqsave(&gpio->lock, flags);\r\ntmp = readb(clps711x_pdir(chip)) & ~(1 << offset);\r\nwriteb(tmp, clps711x_pdir(chip));\r\nspin_unlock_irqrestore(&gpio->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int gpio_clps711x_dir_out(struct gpio_chip *chip, unsigned offset,\r\nint value)\r\n{\r\nint tmp;\r\nunsigned long flags;\r\nstruct clps711x_gpio *gpio = dev_get_drvdata(chip->dev);\r\nspin_lock_irqsave(&gpio->lock, flags);\r\ntmp = readb(clps711x_pdir(chip)) | (1 << offset);\r\nwriteb(tmp, clps711x_pdir(chip));\r\ntmp = readb(clps711x_port(chip)) & ~(1 << offset);\r\nif (value)\r\ntmp |= 1 << offset;\r\nwriteb(tmp, clps711x_port(chip));\r\nspin_unlock_irqrestore(&gpio->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int gpio_clps711x_dir_in_inv(struct gpio_chip *chip, unsigned offset)\r\n{\r\nint tmp;\r\nunsigned long flags;\r\nstruct clps711x_gpio *gpio = dev_get_drvdata(chip->dev);\r\nspin_lock_irqsave(&gpio->lock, flags);\r\ntmp = readb(clps711x_pdir(chip)) | (1 << offset);\r\nwriteb(tmp, clps711x_pdir(chip));\r\nspin_unlock_irqrestore(&gpio->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int gpio_clps711x_dir_out_inv(struct gpio_chip *chip, unsigned offset,\r\nint value)\r\n{\r\nint tmp;\r\nunsigned long flags;\r\nstruct clps711x_gpio *gpio = dev_get_drvdata(chip->dev);\r\nspin_lock_irqsave(&gpio->lock, flags);\r\ntmp = readb(clps711x_pdir(chip)) & ~(1 << offset);\r\nwriteb(tmp, clps711x_pdir(chip));\r\ntmp = readb(clps711x_port(chip)) & ~(1 << offset);\r\nif (value)\r\ntmp |= 1 << offset;\r\nwriteb(tmp, clps711x_port(chip));\r\nspin_unlock_irqrestore(&gpio->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int __init gpio_clps711x_init(void)\r\n{\r\nint i;\r\nstruct platform_device *pdev;\r\nstruct clps711x_gpio *gpio;\r\npdev = platform_device_alloc(CLPS711X_GPIO_NAME, 0);\r\nif (!pdev) {\r\npr_err("Cannot create platform device: %s\n",\r\nCLPS711X_GPIO_NAME);\r\nreturn -ENOMEM;\r\n}\r\nplatform_device_add(pdev);\r\ngpio = devm_kzalloc(&pdev->dev, sizeof(struct clps711x_gpio),\r\nGFP_KERNEL);\r\nif (!gpio) {\r\ndev_err(&pdev->dev, "GPIO allocating memory error\n");\r\nplatform_device_unregister(pdev);\r\nreturn -ENOMEM;\r\n}\r\nplatform_set_drvdata(pdev, gpio);\r\nspin_lock_init(&gpio->lock);\r\nfor (i = 0; i < CLPS711X_GPIO_PORTS; i++) {\r\ngpio->chip[i].owner = THIS_MODULE;\r\ngpio->chip[i].dev = &pdev->dev;\r\ngpio->chip[i].label = clps711x_gpio_ports[i].name;\r\ngpio->chip[i].base = i * 8;\r\ngpio->chip[i].ngpio = clps711x_gpio_ports[i].nr;\r\ngpio->chip[i].get = gpio_clps711x_get;\r\ngpio->chip[i].set = gpio_clps711x_set;\r\nif (!clps711x_gpio_ports[i].inv_dir) {\r\ngpio->chip[i].direction_input = gpio_clps711x_dir_in;\r\ngpio->chip[i].direction_output = gpio_clps711x_dir_out;\r\n} else {\r\ngpio->chip[i].direction_input = gpio_clps711x_dir_in_inv;\r\ngpio->chip[i].direction_output = gpio_clps711x_dir_out_inv;\r\n}\r\nWARN_ON(gpiochip_add(&gpio->chip[i]));\r\n}\r\ndev_info(&pdev->dev, "GPIO driver initialized\n");\r\nreturn 0;\r\n}

static bool brcms_c_rateset_valid(struct brcms_c_rateset *rs, bool check_brate)\r\n{\r\nuint idx;\r\nif (!rs->count)\r\nreturn false;\r\nif (!check_brate)\r\nreturn true;\r\nfor (idx = 0; idx < rs->count; idx++) {\r\nif (rs->rates[idx] & BRCMS_RATE_FLAG)\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nvoid brcms_c_rateset_mcs_upd(struct brcms_c_rateset *rs, u8 txstreams)\r\n{\r\nint i;\r\nfor (i = txstreams; i < MAX_STREAMS_SUPPORTED; i++)\r\nrs->mcs[i] = 0;\r\n}\r\nbool\r\nbrcms_c_rate_hwrs_filter_sort_validate(struct brcms_c_rateset *rs,\r\nconst struct brcms_c_rateset *hw_rs,\r\nbool check_brate, u8 txstreams)\r\n{\r\nu8 rateset[BRCM_MAXRATE + 1];\r\nu8 r;\r\nuint count;\r\nuint i;\r\nmemset(rateset, 0, sizeof(rateset));\r\ncount = rs->count;\r\nfor (i = 0; i < count; i++) {\r\nr = (int)rs->rates[i] & BRCMS_RATE_MASK;\r\nif ((r > BRCM_MAXRATE) || (rate_info[r] == 0))\r\ncontinue;\r\nrateset[r] = rs->rates[i];\r\n}\r\ncount = 0;\r\nfor (i = 0; i < hw_rs->count; i++) {\r\nr = hw_rs->rates[i] & BRCMS_RATE_MASK;\r\nif (rateset[r])\r\nrs->rates[count++] = rateset[r];\r\n}\r\nrs->count = count;\r\nfor (i = 0; i < MCSSET_LEN; i++)\r\nrs->mcs[i] = (rs->mcs[i] & hw_rs->mcs[i]);\r\nif (brcms_c_rateset_valid(rs, check_brate))\r\nreturn true;\r\nelse\r\nreturn false;\r\n}\r\nu32 brcms_c_compute_rspec(struct d11rxhdr *rxh, u8 *plcp)\r\n{\r\nint phy_type;\r\nu32 rspec = PHY_TXC1_BW_20MHZ << RSPEC_BW_SHIFT;\r\nphy_type =\r\n((rxh->RxChan & RXS_CHAN_PHYTYPE_MASK) >> RXS_CHAN_PHYTYPE_SHIFT);\r\nif ((phy_type == PHY_TYPE_N) || (phy_type == PHY_TYPE_SSN) ||\r\n(phy_type == PHY_TYPE_LCN) || (phy_type == PHY_TYPE_HT)) {\r\nswitch (rxh->PhyRxStatus_0 & PRXS0_FT_MASK) {\r\ncase PRXS0_CCK:\r\nrspec =\r\ncck_phy2mac_rate(\r\n((struct cck_phy_hdr *) plcp)->signal);\r\nbreak;\r\ncase PRXS0_OFDM:\r\nrspec =\r\nofdm_phy2mac_rate(\r\n((struct ofdm_phy_hdr *) plcp)->rlpt[0]);\r\nbreak;\r\ncase PRXS0_PREN:\r\nrspec = (plcp[0] & MIMO_PLCP_MCS_MASK) | RSPEC_MIMORATE;\r\nif (plcp[0] & MIMO_PLCP_40MHZ) {\r\nrspec &= ~RSPEC_BW_MASK;\r\nrspec |= (PHY_TXC1_BW_40MHZ << RSPEC_BW_SHIFT);\r\n}\r\nbreak;\r\ncase PRXS0_STDN:\r\ndefault:\r\nbreak;\r\n}\r\nif (plcp3_issgi(plcp[3]))\r\nrspec |= RSPEC_SHORT_GI;\r\n} else\r\nif ((phy_type == PHY_TYPE_A) || (rxh->PhyRxStatus_0 & PRXS0_OFDM))\r\nrspec = ofdm_phy2mac_rate(\r\n((struct ofdm_phy_hdr *) plcp)->rlpt[0]);\r\nelse\r\nrspec = cck_phy2mac_rate(\r\n((struct cck_phy_hdr *) plcp)->signal);\r\nreturn rspec;\r\n}\r\nvoid brcms_c_rateset_copy(const struct brcms_c_rateset *src,\r\nstruct brcms_c_rateset *dst)\r\n{\r\nmemcpy(dst, src, sizeof(struct brcms_c_rateset));\r\n}\r\nvoid\r\nbrcms_c_rateset_filter(struct brcms_c_rateset *src, struct brcms_c_rateset *dst,\r\nbool basic_only, u8 rates, uint xmask, bool mcsallow)\r\n{\r\nuint i;\r\nuint r;\r\nuint count;\r\ncount = 0;\r\nfor (i = 0; i < src->count; i++) {\r\nr = src->rates[i];\r\nif (basic_only && !(r & BRCMS_RATE_FLAG))\r\ncontinue;\r\nif (rates == BRCMS_RATES_CCK &&\r\nis_ofdm_rate((r & BRCMS_RATE_MASK)))\r\ncontinue;\r\nif (rates == BRCMS_RATES_OFDM &&\r\nis_cck_rate((r & BRCMS_RATE_MASK)))\r\ncontinue;\r\ndst->rates[count++] = r & xmask;\r\n}\r\ndst->count = count;\r\ndst->htphy_membership = src->htphy_membership;\r\nif (mcsallow && rates != BRCMS_RATES_CCK)\r\nmemcpy(&dst->mcs[0], &src->mcs[0], MCSSET_LEN);\r\nelse\r\nbrcms_c_rateset_mcs_clear(dst);\r\n}\r\nvoid\r\nbrcms_c_rateset_default(struct brcms_c_rateset *rs_tgt,\r\nconst struct brcms_c_rateset *rs_hw,\r\nuint phy_type, int bandtype, bool cck_only,\r\nuint rate_mask, bool mcsallow, u8 bw, u8 txstreams)\r\n{\r\nconst struct brcms_c_rateset *rs_dflt;\r\nstruct brcms_c_rateset rs_sel;\r\nif ((PHYTYPE_IS(phy_type, PHY_TYPE_HT)) ||\r\n(PHYTYPE_IS(phy_type, PHY_TYPE_N)) ||\r\n(PHYTYPE_IS(phy_type, PHY_TYPE_LCN)) ||\r\n(PHYTYPE_IS(phy_type, PHY_TYPE_SSN))) {\r\nif (bandtype == BRCM_BAND_5G)\r\nrs_dflt = (bw == BRCMS_20_MHZ ?\r\n&ofdm_mimo_rates : &ofdm_40bw_mimo_rates);\r\nelse\r\nrs_dflt = (bw == BRCMS_20_MHZ ?\r\n&cck_ofdm_mimo_rates :\r\n&cck_ofdm_40bw_mimo_rates);\r\n} else if (PHYTYPE_IS(phy_type, PHY_TYPE_LP)) {\r\nrs_dflt = (bandtype == BRCM_BAND_5G) ?\r\n&ofdm_rates : &cck_ofdm_rates;\r\n} else if (PHYTYPE_IS(phy_type, PHY_TYPE_A)) {\r\nrs_dflt = &ofdm_rates;\r\n} else if (PHYTYPE_IS(phy_type, PHY_TYPE_G)) {\r\nrs_dflt = &cck_ofdm_rates;\r\n} else {\r\nrs_dflt = &cck_rates;\r\n}\r\nif (!rs_hw)\r\nrs_hw = rs_dflt;\r\nbrcms_c_rateset_copy(rs_dflt, &rs_sel);\r\nbrcms_c_rateset_mcs_upd(&rs_sel, txstreams);\r\nbrcms_c_rateset_filter(&rs_sel, rs_tgt, false,\r\ncck_only ? BRCMS_RATES_CCK : BRCMS_RATES_CCK_OFDM,\r\nrate_mask, mcsallow);\r\nbrcms_c_rate_hwrs_filter_sort_validate(rs_tgt, rs_hw, false,\r\nmcsallow ? txstreams : 1);\r\n}\r\ns16 brcms_c_rate_legacy_phyctl(uint rate)\r\n{\r\nuint i;\r\nfor (i = 0; i < LEGACY_PHYCFG_TABLE_SIZE; i++)\r\nif (rate == legacy_phycfg_table[i].rate_ofdm)\r\nreturn legacy_phycfg_table[i].tx_phy_ctl3;\r\nreturn -1;\r\n}\r\nvoid brcms_c_rateset_mcs_clear(struct brcms_c_rateset *rateset)\r\n{\r\nuint i;\r\nfor (i = 0; i < MCSSET_LEN; i++)\r\nrateset->mcs[i] = 0;\r\n}\r\nvoid brcms_c_rateset_mcs_build(struct brcms_c_rateset *rateset, u8 txstreams)\r\n{\r\nmemcpy(&rateset->mcs[0], &cck_ofdm_mimo_rates.mcs[0], MCSSET_LEN);\r\nbrcms_c_rateset_mcs_upd(rateset, txstreams);\r\n}\r\nvoid brcms_c_rateset_bw_mcs_filter(struct brcms_c_rateset *rateset, u8 bw)\r\n{\r\nif (bw == BRCMS_40_MHZ)\r\nsetbit(rateset->mcs, 32);\r\nelse\r\nclrbit(rateset->mcs, 32);\r\n}

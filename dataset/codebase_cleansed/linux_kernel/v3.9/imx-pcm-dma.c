static bool filter(struct dma_chan *chan, void *param)\r\n{\r\nif (!imx_dma_is_general_purpose(chan))\r\nreturn false;\r\nchan->private = param;\r\nreturn true;\r\n}\r\nstatic int snd_imx_pcm_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct dma_chan *chan = snd_dmaengine_pcm_get_chan(substream);\r\nstruct imx_pcm_dma_params *dma_params;\r\nstruct dma_slave_config slave_config;\r\nint ret;\r\ndma_params = snd_soc_dai_get_dma_data(rtd->cpu_dai, substream);\r\nret = snd_hwparams_to_dma_slave_config(substream, params, &slave_config);\r\nif (ret)\r\nreturn ret;\r\nslave_config.device_fc = false;\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK) {\r\nslave_config.dst_addr = dma_params->dma_addr;\r\nslave_config.dst_maxburst = dma_params->burstsize;\r\n} else {\r\nslave_config.src_addr = dma_params->dma_addr;\r\nslave_config.src_maxburst = dma_params->burstsize;\r\n}\r\nret = dmaengine_slave_config(chan, &slave_config);\r\nif (ret)\r\nreturn ret;\r\nsnd_pcm_set_runtime_buffer(substream, &substream->dma_buffer);\r\nreturn 0;\r\n}\r\nstatic int snd_imx_open(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct imx_pcm_dma_params *dma_params;\r\nstruct imx_dma_data *dma_data;\r\nint ret;\r\nsnd_soc_set_runtime_hwparams(substream, &snd_imx_hardware);\r\ndma_params = snd_soc_dai_get_dma_data(rtd->cpu_dai, substream);\r\ndma_data = kzalloc(sizeof(*dma_data), GFP_KERNEL);\r\nif (!dma_data)\r\nreturn -ENOMEM;\r\ndma_data->peripheral_type = dma_params->shared_peripheral ?\r\nIMX_DMATYPE_SSI_SP : IMX_DMATYPE_SSI;\r\ndma_data->priority = DMA_PRIO_HIGH;\r\ndma_data->dma_request = dma_params->dma;\r\nret = snd_dmaengine_pcm_open(substream, filter, dma_data);\r\nif (ret) {\r\nkfree(dma_data);\r\nreturn ret;\r\n}\r\nsnd_dmaengine_pcm_set_data(substream, dma_data);\r\nreturn 0;\r\n}\r\nstatic int snd_imx_close(struct snd_pcm_substream *substream)\r\n{\r\nstruct imx_dma_data *dma_data = snd_dmaengine_pcm_get_data(substream);\r\nsnd_dmaengine_pcm_close(substream);\r\nkfree(dma_data);\r\nreturn 0;\r\n}\r\nint imx_pcm_dma_init(struct platform_device *pdev)\r\n{\r\nreturn snd_soc_register_platform(&pdev->dev, &imx_soc_platform_mx2);\r\n}

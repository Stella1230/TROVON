static int q40fb_setcolreg(unsigned regno, unsigned red, unsigned green,\r\nunsigned blue, unsigned transp,\r\nstruct fb_info *info)\r\n{\r\nif (regno > 255)\r\nreturn 1;\r\nred>>=11;\r\ngreen>>=11;\r\nblue>>=10;\r\nif (regno < 16) {\r\n((u32 *)info->pseudo_palette)[regno] = ((red & 31) <<6) |\r\n((green & 31) << 11) |\r\n(blue & 63);\r\n}\r\nreturn 0;\r\n}\r\nstatic int q40fb_probe(struct platform_device *dev)\r\n{\r\nstruct fb_info *info;\r\nif (!MACH_IS_Q40)\r\nreturn -ENXIO;\r\nq40fb_fix.smem_start = Q40_PHYS_SCREEN_ADDR;\r\ninfo = framebuffer_alloc(sizeof(u32) * 16, &dev->dev);\r\nif (!info)\r\nreturn -ENOMEM;\r\ninfo->var = q40fb_var;\r\ninfo->fix = q40fb_fix;\r\ninfo->fbops = &q40fb_ops;\r\ninfo->flags = FBINFO_DEFAULT;\r\ninfo->pseudo_palette = info->par;\r\ninfo->par = NULL;\r\ninfo->screen_base = (char *) q40fb_fix.smem_start;\r\nif (fb_alloc_cmap(&info->cmap, 256, 0) < 0) {\r\nframebuffer_release(info);\r\nreturn -ENOMEM;\r\n}\r\nmaster_outb(3, DISPLAY_CONTROL_REG);\r\nif (register_framebuffer(info) < 0) {\r\nprintk(KERN_ERR "Unable to register Q40 frame buffer\n");\r\nfb_dealloc_cmap(&info->cmap);\r\nframebuffer_release(info);\r\nreturn -EINVAL;\r\n}\r\nprintk(KERN_INFO "fb%d: Q40 frame buffer alive and kicking !\n",\r\ninfo->node);\r\nreturn 0;\r\n}\r\nint __init q40fb_init(void)\r\n{\r\nint ret = 0;\r\nif (fb_get_options("q40fb", NULL))\r\nreturn -ENODEV;\r\nret = platform_driver_register(&q40fb_driver);\r\nif (!ret) {\r\nret = platform_device_register(&q40fb_device);\r\nif (ret)\r\nplatform_driver_unregister(&q40fb_driver);\r\n}\r\nreturn ret;\r\n}

static int rfkill_gpio_set_power(void *data, bool blocked)\r\n{\r\nstruct rfkill_gpio_data *rfkill = data;\r\nif (blocked) {\r\nif (gpio_is_valid(rfkill->pdata->shutdown_gpio))\r\ngpio_direction_output(rfkill->pdata->shutdown_gpio, 0);\r\nif (gpio_is_valid(rfkill->pdata->reset_gpio))\r\ngpio_direction_output(rfkill->pdata->reset_gpio, 0);\r\nif (rfkill->pwr_clk && PWR_CLK_ENABLED(rfkill))\r\nclk_disable(rfkill->pwr_clk);\r\n} else {\r\nif (rfkill->pwr_clk && PWR_CLK_DISABLED(rfkill))\r\nclk_enable(rfkill->pwr_clk);\r\nif (gpio_is_valid(rfkill->pdata->reset_gpio))\r\ngpio_direction_output(rfkill->pdata->reset_gpio, 1);\r\nif (gpio_is_valid(rfkill->pdata->shutdown_gpio))\r\ngpio_direction_output(rfkill->pdata->shutdown_gpio, 1);\r\n}\r\nif (rfkill->pwr_clk)\r\nPWR_CLK_SET(rfkill, blocked);\r\nreturn 0;\r\n}\r\nstatic int rfkill_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct rfkill_gpio_data *rfkill;\r\nstruct rfkill_gpio_platform_data *pdata = pdev->dev.platform_data;\r\nint ret = 0;\r\nint len = 0;\r\nif (!pdata) {\r\npr_warn("%s: No platform data specified\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nif (!pdata->name || (!gpio_is_valid(pdata->reset_gpio) &&\r\n!gpio_is_valid(pdata->shutdown_gpio))) {\r\npr_warn("%s: invalid platform data\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nrfkill = kzalloc(sizeof(*rfkill), GFP_KERNEL);\r\nif (!rfkill)\r\nreturn -ENOMEM;\r\nif (pdata->gpio_runtime_setup) {\r\nret = pdata->gpio_runtime_setup(pdev);\r\nif (ret) {\r\npr_warn("%s: can't set up gpio\n", __func__);\r\ngoto fail_alloc;\r\n}\r\n}\r\nrfkill->pdata = pdata;\r\nlen = strlen(pdata->name);\r\nrfkill->reset_name = kzalloc(len + 7, GFP_KERNEL);\r\nif (!rfkill->reset_name) {\r\nret = -ENOMEM;\r\ngoto fail_alloc;\r\n}\r\nrfkill->shutdown_name = kzalloc(len + 10, GFP_KERNEL);\r\nif (!rfkill->shutdown_name) {\r\nret = -ENOMEM;\r\ngoto fail_reset_name;\r\n}\r\nsnprintf(rfkill->reset_name, len + 6 , "%s_reset", pdata->name);\r\nsnprintf(rfkill->shutdown_name, len + 9, "%s_shutdown", pdata->name);\r\nif (pdata->power_clk_name) {\r\nrfkill->pwr_clk = clk_get(&pdev->dev, pdata->power_clk_name);\r\nif (IS_ERR(rfkill->pwr_clk)) {\r\npr_warn("%s: can't find pwr_clk.\n", __func__);\r\ngoto fail_shutdown_name;\r\n}\r\n}\r\nif (gpio_is_valid(pdata->reset_gpio)) {\r\nret = gpio_request(pdata->reset_gpio, rfkill->reset_name);\r\nif (ret) {\r\npr_warn("%s: failed to get reset gpio.\n", __func__);\r\ngoto fail_clock;\r\n}\r\n}\r\nif (gpio_is_valid(pdata->shutdown_gpio)) {\r\nret = gpio_request(pdata->shutdown_gpio, rfkill->shutdown_name);\r\nif (ret) {\r\npr_warn("%s: failed to get shutdown gpio.\n", __func__);\r\ngoto fail_reset;\r\n}\r\n}\r\nrfkill->rfkill_dev = rfkill_alloc(pdata->name, &pdev->dev, pdata->type,\r\n&rfkill_gpio_ops, rfkill);\r\nif (!rfkill->rfkill_dev)\r\ngoto fail_shutdown;\r\nret = rfkill_register(rfkill->rfkill_dev);\r\nif (ret < 0)\r\ngoto fail_rfkill;\r\nplatform_set_drvdata(pdev, rfkill);\r\ndev_info(&pdev->dev, "%s device registered.\n", pdata->name);\r\nreturn 0;\r\nfail_rfkill:\r\nrfkill_destroy(rfkill->rfkill_dev);\r\nfail_shutdown:\r\nif (gpio_is_valid(pdata->shutdown_gpio))\r\ngpio_free(pdata->shutdown_gpio);\r\nfail_reset:\r\nif (gpio_is_valid(pdata->reset_gpio))\r\ngpio_free(pdata->reset_gpio);\r\nfail_clock:\r\nif (rfkill->pwr_clk)\r\nclk_put(rfkill->pwr_clk);\r\nfail_shutdown_name:\r\nkfree(rfkill->shutdown_name);\r\nfail_reset_name:\r\nkfree(rfkill->reset_name);\r\nfail_alloc:\r\nkfree(rfkill);\r\nreturn ret;\r\n}\r\nstatic int rfkill_gpio_remove(struct platform_device *pdev)\r\n{\r\nstruct rfkill_gpio_data *rfkill = platform_get_drvdata(pdev);\r\nstruct rfkill_gpio_platform_data *pdata = pdev->dev.platform_data;\r\nif (pdata->gpio_runtime_close)\r\npdata->gpio_runtime_close(pdev);\r\nrfkill_unregister(rfkill->rfkill_dev);\r\nrfkill_destroy(rfkill->rfkill_dev);\r\nif (gpio_is_valid(rfkill->pdata->shutdown_gpio))\r\ngpio_free(rfkill->pdata->shutdown_gpio);\r\nif (gpio_is_valid(rfkill->pdata->reset_gpio))\r\ngpio_free(rfkill->pdata->reset_gpio);\r\nif (rfkill->pwr_clk && PWR_CLK_ENABLED(rfkill))\r\nclk_disable(rfkill->pwr_clk);\r\nif (rfkill->pwr_clk)\r\nclk_put(rfkill->pwr_clk);\r\nkfree(rfkill->shutdown_name);\r\nkfree(rfkill->reset_name);\r\nkfree(rfkill);\r\nreturn 0;\r\n}

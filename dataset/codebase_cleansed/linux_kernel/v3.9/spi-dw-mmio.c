static int dw_spi_mmio_probe(struct platform_device *pdev)\r\n{\r\nstruct dw_spi_mmio *dwsmmio;\r\nstruct dw_spi *dws;\r\nstruct resource *mem, *ioarea;\r\nint ret;\r\ndwsmmio = kzalloc(sizeof(struct dw_spi_mmio), GFP_KERNEL);\r\nif (!dwsmmio) {\r\nret = -ENOMEM;\r\ngoto err_end;\r\n}\r\ndws = &dwsmmio->dws;\r\nmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!mem) {\r\ndev_err(&pdev->dev, "no mem resource?\n");\r\nret = -EINVAL;\r\ngoto err_kfree;\r\n}\r\nioarea = request_mem_region(mem->start, resource_size(mem),\r\npdev->name);\r\nif (!ioarea) {\r\ndev_err(&pdev->dev, "SPI region already claimed\n");\r\nret = -EBUSY;\r\ngoto err_kfree;\r\n}\r\ndws->regs = ioremap_nocache(mem->start, resource_size(mem));\r\nif (!dws->regs) {\r\ndev_err(&pdev->dev, "SPI region already mapped\n");\r\nret = -ENOMEM;\r\ngoto err_release_reg;\r\n}\r\ndws->irq = platform_get_irq(pdev, 0);\r\nif (dws->irq < 0) {\r\ndev_err(&pdev->dev, "no irq resource?\n");\r\nret = dws->irq;\r\ngoto err_unmap;\r\n}\r\ndwsmmio->clk = clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(dwsmmio->clk)) {\r\nret = PTR_ERR(dwsmmio->clk);\r\ngoto err_irq;\r\n}\r\nclk_enable(dwsmmio->clk);\r\ndws->parent_dev = &pdev->dev;\r\ndws->bus_num = 0;\r\ndws->num_cs = 4;\r\ndws->max_freq = clk_get_rate(dwsmmio->clk);\r\nret = dw_spi_add_host(dws);\r\nif (ret)\r\ngoto err_clk;\r\nplatform_set_drvdata(pdev, dwsmmio);\r\nreturn 0;\r\nerr_clk:\r\nclk_disable(dwsmmio->clk);\r\nclk_put(dwsmmio->clk);\r\ndwsmmio->clk = NULL;\r\nerr_irq:\r\nfree_irq(dws->irq, dws);\r\nerr_unmap:\r\niounmap(dws->regs);\r\nerr_release_reg:\r\nrelease_mem_region(mem->start, resource_size(mem));\r\nerr_kfree:\r\nkfree(dwsmmio);\r\nerr_end:\r\nreturn ret;\r\n}\r\nstatic int dw_spi_mmio_remove(struct platform_device *pdev)\r\n{\r\nstruct dw_spi_mmio *dwsmmio = platform_get_drvdata(pdev);\r\nstruct resource *mem;\r\nplatform_set_drvdata(pdev, NULL);\r\nclk_disable(dwsmmio->clk);\r\nclk_put(dwsmmio->clk);\r\ndwsmmio->clk = NULL;\r\nfree_irq(dwsmmio->dws.irq, &dwsmmio->dws);\r\ndw_spi_remove_host(&dwsmmio->dws);\r\niounmap(dwsmmio->dws.regs);\r\nkfree(dwsmmio);\r\nmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nrelease_mem_region(mem->start, resource_size(mem));\r\nreturn 0;\r\n}

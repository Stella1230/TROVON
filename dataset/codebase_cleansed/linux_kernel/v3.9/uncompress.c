int cramfs_uncompress_block(void *dst, int dstlen, void *src, int srclen)\r\n{\r\nint err;\r\nstream.next_in = src;\r\nstream.avail_in = srclen;\r\nstream.next_out = dst;\r\nstream.avail_out = dstlen;\r\nerr = zlib_inflateReset(&stream);\r\nif (err != Z_OK) {\r\nprintk("zlib_inflateReset error %d\n", err);\r\nzlib_inflateEnd(&stream);\r\nzlib_inflateInit(&stream);\r\n}\r\nerr = zlib_inflate(&stream, Z_FINISH);\r\nif (err != Z_STREAM_END)\r\ngoto err;\r\nreturn stream.total_out;\r\nerr:\r\nprintk("Error %d while decompressing!\n", err);\r\nprintk("%p(%d)->%p(%d)\n", src, srclen, dst, dstlen);\r\nreturn -EIO;\r\n}\r\nint cramfs_uncompress_init(void)\r\n{\r\nif (!initialized++) {\r\nstream.workspace = vmalloc(zlib_inflate_workspacesize());\r\nif ( !stream.workspace ) {\r\ninitialized = 0;\r\nreturn -ENOMEM;\r\n}\r\nstream.next_in = NULL;\r\nstream.avail_in = 0;\r\nzlib_inflateInit(&stream);\r\n}\r\nreturn 0;\r\n}\r\nvoid cramfs_uncompress_exit(void)\r\n{\r\nif (!--initialized) {\r\nzlib_inflateEnd(&stream);\r\nvfree(stream.workspace);\r\n}\r\n}

int\r\nuf_verify_m4(unifi_priv_t *priv, const unsigned char *packet, unsigned int length)\r\n{\r\nconst unsigned char *p = packet;\r\nu16 keyinfo;\r\nif (length < (4 + 5 + 8 + 32 + 16 + 8 + 8 + 16 + 1 + 8))\r\nreturn 1;\r\np += 8;\r\nkeyinfo = p[5] << 8 | p[6];\r\nif (\r\n(p[0] == 1 || p[0] == 2) &&\r\np[1] == 3 &&\r\n(p[4] == 254 || p[4] == 2) &&\r\n((keyinfo & 0x0007) == 1 || (keyinfo & 0x0007) == 2) &&\r\n(keyinfo & ~0x0207U) == 0x0108 &&\r\n(p[4 + 5 + 8 + 32 + 16 + 8 + 8 + 16 + 0] == 0 &&\r\np[4 + 5 + 8 + 32 + 16 + 8 + 8 + 16 + 1] == 0)\r\n) {\r\nunifi_trace(priv, UDBG1, "uf_verify_m4: M4 detected\n");\r\nreturn 0;\r\n} else {\r\nreturn 1;\r\n}\r\n}

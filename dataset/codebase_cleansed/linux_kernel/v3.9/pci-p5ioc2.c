static int pnv_pci_p5ioc2_msi_setup(struct pnv_phb *phb, struct pci_dev *dev,\r\nunsigned int hwirq, unsigned int is_64,\r\nstruct msi_msg *msg)\r\n{\r\nif (WARN_ON(!is_64))\r\nreturn -ENXIO;\r\nmsg->data = hwirq - phb->msi_base;\r\nmsg->address_hi = 0x10000000;\r\nmsg->address_lo = 0;\r\nreturn 0;\r\n}\r\nstatic void pnv_pci_init_p5ioc2_msis(struct pnv_phb *phb)\r\n{\r\nunsigned int bmap_size;\r\nconst __be32 *prop = of_get_property(phb->hose->dn,\r\n"ibm,opal-msi-ranges", NULL);\r\nif (!prop)\r\nreturn;\r\nif (of_device_is_compatible(phb->hose->dn, "ibm,p5ioc2-pcix"))\r\nreturn;\r\nphb->msi_base = be32_to_cpup(prop);\r\nphb->msi_count = be32_to_cpup(prop + 1);\r\nbmap_size = BITS_TO_LONGS(phb->msi_count) * sizeof(unsigned long);\r\nphb->msi_map = zalloc_maybe_bootmem(bmap_size, GFP_KERNEL);\r\nif (!phb->msi_map) {\r\npr_err("PCI %d: Failed to allocate MSI bitmap !\n",\r\nphb->hose->global_number);\r\nreturn;\r\n}\r\nphb->msi_setup = pnv_pci_p5ioc2_msi_setup;\r\nphb->msi32_support = 0;\r\npr_info(" Allocated bitmap for %d MSIs (base IRQ 0x%x)\n",\r\nphb->msi_count, phb->msi_base);\r\n}\r\nstatic void pnv_pci_init_p5ioc2_msis(struct pnv_phb *phb) { }\r\nstatic void pnv_pci_p5ioc2_dma_dev_setup(struct pnv_phb *phb,\r\nstruct pci_dev *pdev)\r\n{\r\nif (phb->p5ioc2.iommu_table.it_map == NULL)\r\niommu_init_table(&phb->p5ioc2.iommu_table, phb->hose->node);\r\nset_iommu_table_base(&pdev->dev, &phb->p5ioc2.iommu_table);\r\n}\r\nstatic void __init pnv_pci_init_p5ioc2_phb(struct device_node *np,\r\nvoid *tce_mem, u64 tce_size)\r\n{\r\nstruct pnv_phb *phb;\r\nconst u64 *prop64;\r\nu64 phb_id;\r\nint64_t rc;\r\nstatic int primary = 1;\r\npr_info(" Initializing p5ioc2 PHB %s\n", np->full_name);\r\nprop64 = of_get_property(np, "ibm,opal-phbid", NULL);\r\nif (!prop64) {\r\npr_err(" Missing \"ibm,opal-phbid\" property !\n");\r\nreturn;\r\n}\r\nphb_id = be64_to_cpup(prop64);\r\npr_devel(" PHB-ID : 0x%016llx\n", phb_id);\r\npr_devel(" TCE AT : 0x%016lx\n", __pa(tce_mem));\r\npr_devel(" TCE SZ : 0x%016llx\n", tce_size);\r\nrc = opal_pci_set_phb_tce_memory(phb_id, __pa(tce_mem), tce_size);\r\nif (rc != OPAL_SUCCESS) {\r\npr_err(" Failed to set TCE memory, OPAL error %lld\n", rc);\r\nreturn;\r\n}\r\nphb = alloc_bootmem(sizeof(struct pnv_phb));\r\nif (phb) {\r\nmemset(phb, 0, sizeof(struct pnv_phb));\r\nphb->hose = pcibios_alloc_controller(np);\r\n}\r\nif (!phb || !phb->hose) {\r\npr_err(" Failed to allocate PCI controller\n");\r\nreturn;\r\n}\r\nspin_lock_init(&phb->lock);\r\nphb->hose->first_busno = 0;\r\nphb->hose->last_busno = 0xff;\r\nphb->hose->private_data = phb;\r\nphb->opal_id = phb_id;\r\nphb->type = PNV_PHB_P5IOC2;\r\nphb->model = PNV_PHB_MODEL_P5IOC2;\r\nphb->regs = of_iomap(np, 0);\r\nif (phb->regs == NULL)\r\npr_err(" Failed to map registers !\n");\r\nelse {\r\npr_devel(" P_BUID = 0x%08x\n", in_be32(phb->regs + 0x100));\r\npr_devel(" P_IOSZ = 0x%08x\n", in_be32(phb->regs + 0x1b0));\r\npr_devel(" P_IO_ST = 0x%08x\n", in_be32(phb->regs + 0x1e0));\r\npr_devel(" P_MEM1_H = 0x%08x\n", in_be32(phb->regs + 0x1a0));\r\npr_devel(" P_MEM1_L = 0x%08x\n", in_be32(phb->regs + 0x190));\r\npr_devel(" P_MSZ1_L = 0x%08x\n", in_be32(phb->regs + 0x1c0));\r\npr_devel(" P_MEM_ST = 0x%08x\n", in_be32(phb->regs + 0x1d0));\r\npr_devel(" P_MEM2_H = 0x%08x\n", in_be32(phb->regs + 0x2c0));\r\npr_devel(" P_MEM2_L = 0x%08x\n", in_be32(phb->regs + 0x2b0));\r\npr_devel(" P_MSZ2_H = 0x%08x\n", in_be32(phb->regs + 0x2d0));\r\npr_devel(" P_MSZ2_L = 0x%08x\n", in_be32(phb->regs + 0x2e0));\r\n}\r\npci_process_bridge_OF_ranges(phb->hose, np, primary);\r\nprimary = 0;\r\nphb->hose->ops = &pnv_pci_ops;\r\npnv_pci_init_p5ioc2_msis(phb);\r\nphb->dma_dev_setup = pnv_pci_p5ioc2_dma_dev_setup;\r\npnv_pci_setup_iommu_table(&phb->p5ioc2.iommu_table,\r\ntce_mem, tce_size, 0);\r\n}\r\nvoid __init pnv_pci_init_p5ioc2_hub(struct device_node *np)\r\n{\r\nstruct device_node *phbn;\r\nconst u64 *prop64;\r\nu64 hub_id;\r\nvoid *tce_mem;\r\nuint64_t tce_per_phb;\r\nint64_t rc;\r\nint phb_count = 0;\r\npr_info("Probing p5ioc2 IO-Hub %s\n", np->full_name);\r\nprop64 = of_get_property(np, "ibm,opal-hubid", NULL);\r\nif (!prop64) {\r\npr_err(" Missing \"ibm,opal-hubid\" property !\n");\r\nreturn;\r\n}\r\nhub_id = be64_to_cpup(prop64);\r\npr_info(" HUB-ID : 0x%016llx\n", hub_id);\r\ntce_mem = __alloc_bootmem(P5IOC2_TCE_MEMORY, P5IOC2_TCE_MEMORY,\r\n__pa(MAX_DMA_ADDRESS));\r\nif (!tce_mem) {\r\npr_err(" Failed to allocate TCE Memory !\n");\r\nreturn;\r\n}\r\npr_debug(" TCE : 0x%016lx..0x%016lx\n",\r\n__pa(tce_mem), __pa(tce_mem) + P5IOC2_TCE_MEMORY - 1);\r\nrc = opal_pci_set_hub_tce_memory(hub_id, __pa(tce_mem),\r\nP5IOC2_TCE_MEMORY);\r\nif (rc != OPAL_SUCCESS) {\r\npr_err(" Failed to allocate TCE memory, OPAL error %lld\n", rc);\r\nreturn;\r\n}\r\nfor_each_child_of_node(np, phbn) {\r\nif (of_device_is_compatible(phbn, "ibm,p5ioc2-pcix") ||\r\nof_device_is_compatible(phbn, "ibm,p5ioc2-pciex"))\r\nphb_count++;\r\n}\r\ntce_per_phb = __rounddown_pow_of_two(P5IOC2_TCE_MEMORY / phb_count);\r\npr_info(" Allocating %lld MB of TCE memory per PHB\n",\r\ntce_per_phb >> 20);\r\nfor_each_child_of_node(np, phbn) {\r\nif (of_device_is_compatible(phbn, "ibm,p5ioc2-pcix") ||\r\nof_device_is_compatible(phbn, "ibm,p5ioc2-pciex")) {\r\npnv_pci_init_p5ioc2_phb(phbn, tce_mem, tce_per_phb);\r\ntce_mem += tce_per_phb;\r\n}\r\n}\r\n}

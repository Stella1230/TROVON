static ssize_t dgrp_class_version_show(struct class *class,\r\nstruct class_attribute *attr, char *buf)\r\n{\r\nreturn snprintf(buf, PAGE_SIZE, "%s\n", DIGI_VERSION);\r\n}\r\nstatic ssize_t dgrp_class_register_with_sysfs_show(struct device *c,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn snprintf(buf, PAGE_SIZE, "1\n");\r\n}\r\nstatic ssize_t dgrp_class_pollrate_show(struct device *c,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", dgrp_poll_tick);\r\n}\r\nstatic ssize_t dgrp_class_pollrate_store(struct device *c,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nsscanf(buf, "0x%x\n", &dgrp_poll_tick);\r\nreturn count;\r\n}\r\nvoid dgrp_create_class_sysfs_files(void)\r\n{\r\nint ret = 0;\r\nint max_majors = 1U << (32 - MINORBITS);\r\ndgrp_class = class_create(THIS_MODULE, "digi_realport");\r\nret = class_create_file(dgrp_class, &class_attr_driver_version);\r\ndgrp_class_global_settings_dev = device_create(dgrp_class, NULL,\r\nMKDEV(0, max_majors + 1), NULL, "driver_settings");\r\nret = sysfs_create_group(&dgrp_class_global_settings_dev->kobj,\r\n&dgrp_global_settings_attribute_group);\r\nif (ret) {\r\npr_alert("%s: failed to create sysfs global settings device attributes.\n",\r\n__func__);\r\nsysfs_remove_group(&dgrp_class_global_settings_dev->kobj,\r\n&dgrp_global_settings_attribute_group);\r\nreturn;\r\n}\r\ndgrp_class_nodes_dev = device_create(dgrp_class, NULL,\r\nMKDEV(0, max_majors + 2), NULL, "nodes");\r\n}\r\nvoid dgrp_remove_class_sysfs_files(void)\r\n{\r\nstruct nd_struct *nd;\r\nint max_majors = 1U << (32 - MINORBITS);\r\nlist_for_each_entry(nd, &nd_struct_list, list)\r\ndgrp_remove_node_class_sysfs_files(nd);\r\nsysfs_remove_group(&dgrp_class_global_settings_dev->kobj,\r\n&dgrp_global_settings_attribute_group);\r\nclass_remove_file(dgrp_class, &class_attr_driver_version);\r\ndevice_destroy(dgrp_class, MKDEV(0, max_majors + 1));\r\ndevice_destroy(dgrp_class, MKDEV(0, max_majors + 2));\r\nclass_destroy(dgrp_class);\r\n}\r\nstatic ssize_t dgrp_node_state_show(struct device *c,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct nd_struct *nd;\r\nif (!c)\r\nreturn 0;\r\nnd = (struct nd_struct *) dev_get_drvdata(c);\r\nif (!nd)\r\nreturn 0;\r\nreturn snprintf(buf, PAGE_SIZE, "%s\n", ND_STATE_STR(nd->nd_state));\r\n}\r\nstatic ssize_t dgrp_node_description_show(struct device *c,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct nd_struct *nd;\r\nif (!c)\r\nreturn 0;\r\nnd = (struct nd_struct *) dev_get_drvdata(c);\r\nif (!nd)\r\nreturn 0;\r\nif (nd->nd_state == NS_READY)\r\nreturn snprintf(buf, PAGE_SIZE, "%s\n", nd->nd_ps_desc);\r\nreturn 0;\r\n}\r\nstatic ssize_t dgrp_node_hw_version_show(struct device *c,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct nd_struct *nd;\r\nif (!c)\r\nreturn 0;\r\nnd = (struct nd_struct *) dev_get_drvdata(c);\r\nif (!nd)\r\nreturn 0;\r\nif (nd->nd_state == NS_READY)\r\nreturn snprintf(buf, PAGE_SIZE, "%d.%d\n",\r\n(nd->nd_hw_ver >> 8) & 0xff,\r\nnd->nd_hw_ver & 0xff);\r\nreturn 0;\r\n}\r\nstatic ssize_t dgrp_node_hw_id_show(struct device *c,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct nd_struct *nd;\r\nif (!c)\r\nreturn 0;\r\nnd = (struct nd_struct *) dev_get_drvdata(c);\r\nif (!nd)\r\nreturn 0;\r\nif (nd->nd_state == NS_READY)\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", nd->nd_hw_id);\r\nreturn 0;\r\n}\r\nstatic ssize_t dgrp_node_sw_version_show(struct device *c,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct nd_struct *nd;\r\nif (!c)\r\nreturn 0;\r\nnd = (struct nd_struct *) dev_get_drvdata(c);\r\nif (!nd)\r\nreturn 0;\r\nif (nd->nd_state == NS_READY)\r\nreturn snprintf(buf, PAGE_SIZE, "%d.%d\n",\r\n(nd->nd_sw_ver >> 8) & 0xff,\r\nnd->nd_sw_ver & 0xff);\r\nreturn 0;\r\n}\r\nvoid dgrp_create_node_class_sysfs_files(struct nd_struct *nd)\r\n{\r\nint ret;\r\nchar name[10];\r\nif (nd->nd_ID)\r\nID_TO_CHAR(nd->nd_ID, name);\r\nelse\r\nsprintf(name, "node%ld", nd->nd_major);\r\nnd->nd_class_dev = device_create(dgrp_class, dgrp_class_nodes_dev,\r\nMKDEV(0, nd->nd_major), NULL, name);\r\nret = sysfs_create_group(&nd->nd_class_dev->kobj,\r\n&dgrp_node_attribute_group);\r\nif (ret) {\r\npr_alert("%s: failed to create sysfs node device attributes.\n",\r\n__func__);\r\nsysfs_remove_group(&nd->nd_class_dev->kobj,\r\n&dgrp_node_attribute_group);\r\nreturn;\r\n}\r\ndev_set_drvdata(nd->nd_class_dev, nd);\r\n}\r\nvoid dgrp_remove_node_class_sysfs_files(struct nd_struct *nd)\r\n{\r\nif (nd->nd_class_dev) {\r\nsysfs_remove_group(&nd->nd_class_dev->kobj,\r\n&dgrp_node_attribute_group);\r\ndevice_destroy(dgrp_class, MKDEV(0, nd->nd_major));\r\nnd->nd_class_dev = NULL;\r\n}\r\n}\r\nstatic ssize_t dgrp_tty_state_show(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct un_struct *un;\r\nif (!d)\r\nreturn 0;\r\nun = (struct un_struct *) dev_get_drvdata(d);\r\nif (!un)\r\nreturn 0;\r\nreturn snprintf(buf, PAGE_SIZE, "%s\n",\r\nun->un_open_count ? "Open" : "Closed");\r\n}\r\nstatic ssize_t dgrp_tty_baud_show(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct ch_struct *ch;\r\nstruct un_struct *un;\r\nif (!d)\r\nreturn 0;\r\nun = (struct un_struct *) dev_get_drvdata(d);\r\nif (!un)\r\nreturn 0;\r\nch = un->un_ch;\r\nif (!ch)\r\nreturn 0;\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n",\r\nun->un_open_count ? (PORTSERVER_DIVIDEND / ch->ch_s_brate) : 0);\r\n}\r\nstatic ssize_t dgrp_tty_msignals_show(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct ch_struct *ch;\r\nstruct un_struct *un;\r\nif (!d)\r\nreturn 0;\r\nun = (struct un_struct *) dev_get_drvdata(d);\r\nif (!un)\r\nreturn 0;\r\nch = un->un_ch;\r\nif (!ch)\r\nreturn 0;\r\nif (ch->ch_open_count) {\r\nreturn snprintf(buf, PAGE_SIZE, "%s %s %s %s %s %s\n",\r\n(ch->ch_s_mlast & DM_RTS) ? "RTS" : "",\r\n(ch->ch_s_mlast & DM_CTS) ? "CTS" : "",\r\n(ch->ch_s_mlast & DM_DTR) ? "DTR" : "",\r\n(ch->ch_s_mlast & DM_DSR) ? "DSR" : "",\r\n(ch->ch_s_mlast & DM_CD) ? "DCD" : "",\r\n(ch->ch_s_mlast & DM_RI) ? "RI" : "");\r\n}\r\nreturn 0;\r\n}\r\nstatic ssize_t dgrp_tty_iflag_show(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct ch_struct *ch;\r\nstruct un_struct *un;\r\nif (!d)\r\nreturn 0;\r\nun = (struct un_struct *) dev_get_drvdata(d);\r\nif (!un)\r\nreturn 0;\r\nch = un->un_ch;\r\nif (!ch)\r\nreturn 0;\r\nreturn snprintf(buf, PAGE_SIZE, "%x\n", ch->ch_s_iflag);\r\n}\r\nstatic ssize_t dgrp_tty_cflag_show(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct ch_struct *ch;\r\nstruct un_struct *un;\r\nif (!d)\r\nreturn 0;\r\nun = (struct un_struct *) dev_get_drvdata(d);\r\nif (!un)\r\nreturn 0;\r\nch = un->un_ch;\r\nif (!ch)\r\nreturn 0;\r\nreturn snprintf(buf, PAGE_SIZE, "%x\n", ch->ch_s_cflag);\r\n}\r\nstatic ssize_t dgrp_tty_oflag_show(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct ch_struct *ch;\r\nstruct un_struct *un;\r\nif (!d)\r\nreturn 0;\r\nun = (struct un_struct *) dev_get_drvdata(d);\r\nif (!un)\r\nreturn 0;\r\nch = un->un_ch;\r\nif (!ch)\r\nreturn 0;\r\nreturn snprintf(buf, PAGE_SIZE, "%x\n", ch->ch_s_oflag);\r\n}\r\nstatic ssize_t dgrp_tty_digi_flag_show(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct ch_struct *ch;\r\nstruct un_struct *un;\r\nif (!d)\r\nreturn 0;\r\nun = (struct un_struct *) dev_get_drvdata(d);\r\nif (!un)\r\nreturn 0;\r\nch = un->un_ch;\r\nif (!ch)\r\nreturn 0;\r\nreturn snprintf(buf, PAGE_SIZE, "%x\n", ch->ch_digi.digi_flags);\r\n}\r\nstatic ssize_t dgrp_tty_rxcount_show(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct ch_struct *ch;\r\nstruct un_struct *un;\r\nif (!d)\r\nreturn 0;\r\nun = (struct un_struct *) dev_get_drvdata(d);\r\nif (!un)\r\nreturn 0;\r\nch = un->un_ch;\r\nif (!ch)\r\nreturn 0;\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", ch->ch_rxcount);\r\n}\r\nstatic ssize_t dgrp_tty_txcount_show(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct ch_struct *ch;\r\nstruct un_struct *un;\r\nif (!d)\r\nreturn 0;\r\nun = (struct un_struct *) dev_get_drvdata(d);\r\nif (!un)\r\nreturn 0;\r\nch = un->un_ch;\r\nif (!ch)\r\nreturn 0;\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", ch->ch_txcount);\r\n}\r\nstatic ssize_t dgrp_tty_name_show(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct nd_struct *nd;\r\nstruct ch_struct *ch;\r\nstruct un_struct *un;\r\nchar name[10];\r\nif (!d)\r\nreturn 0;\r\nun = (struct un_struct *) dev_get_drvdata(d);\r\nif (!un)\r\nreturn 0;\r\nch = un->un_ch;\r\nif (!ch)\r\nreturn 0;\r\nnd = ch->ch_nd;\r\nif (!nd)\r\nreturn 0;\r\nID_TO_CHAR(nd->nd_ID, name);\r\nreturn snprintf(buf, PAGE_SIZE, "%s%s%02d\n",\r\nun->un_type == SERIAL_TYPE_XPRINT ? "pr" : "tty",\r\nname, ch->ch_portnum);\r\n}\r\nvoid dgrp_create_tty_sysfs(struct un_struct *un, struct device *c)\r\n{\r\nint ret;\r\nret = sysfs_create_group(&c->kobj, &dgrp_tty_attribute_group);\r\nif (ret) {\r\npr_alert("%s: failed to create sysfs tty device attributes.\n",\r\n__func__);\r\nsysfs_remove_group(&c->kobj, &dgrp_tty_attribute_group);\r\nreturn;\r\n}\r\ndev_set_drvdata(c, un);\r\n}\r\nvoid dgrp_remove_tty_sysfs(struct device *c)\r\n{\r\nsysfs_remove_group(&c->kobj, &dgrp_tty_attribute_group);\r\n}

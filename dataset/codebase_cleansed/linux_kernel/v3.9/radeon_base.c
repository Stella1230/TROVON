static void radeon_unmap_ROM(struct radeonfb_info *rinfo, struct pci_dev *dev)\r\n{\r\nif (!rinfo->bios_seg)\r\nreturn;\r\npci_unmap_rom(dev, rinfo->bios_seg);\r\n}\r\nstatic int radeon_map_ROM(struct radeonfb_info *rinfo, struct pci_dev *dev)\r\n{\r\nvoid __iomem *rom;\r\nu16 dptr;\r\nu8 rom_type;\r\nsize_t rom_size;\r\nunsigned int temp;\r\ntemp = INREG(MPP_TB_CONFIG);\r\ntemp &= 0x00ffffffu;\r\ntemp |= 0x04 << 24;\r\nOUTREG(MPP_TB_CONFIG, temp);\r\ntemp = INREG(MPP_TB_CONFIG);\r\nrom = pci_map_rom(dev, &rom_size);\r\nif (!rom) {\r\nprintk(KERN_ERR "radeonfb (%s): ROM failed to map\n",\r\npci_name(rinfo->pdev));\r\nreturn -ENOMEM;\r\n}\r\nrinfo->bios_seg = rom;\r\nif (BIOS_IN16(0) != 0xaa55) {\r\nprintk(KERN_DEBUG "radeonfb (%s): Invalid ROM signature %x "\r\n"should be 0xaa55\n",\r\npci_name(rinfo->pdev), BIOS_IN16(0));\r\ngoto failed;\r\n}\r\ndptr = BIOS_IN16(0x18);\r\nif (BIOS_IN32(dptr) != (('R' << 24) | ('I' << 16) | ('C' << 8) | 'P')) {\r\nprintk(KERN_WARNING "radeonfb (%s): PCI DATA signature in ROM"\r\n"incorrect: %08x\n", pci_name(rinfo->pdev), BIOS_IN32(dptr));\r\ngoto anyway;\r\n}\r\nrom_type = BIOS_IN8(dptr + 0x14);\r\nswitch(rom_type) {\r\ncase 0:\r\nprintk(KERN_INFO "radeonfb: Found Intel x86 BIOS ROM Image\n");\r\nbreak;\r\ncase 1:\r\nprintk(KERN_INFO "radeonfb: Found Open Firmware ROM Image\n");\r\ngoto failed;\r\ncase 2:\r\nprintk(KERN_INFO "radeonfb: Found HP PA-RISC ROM Image\n");\r\ngoto failed;\r\ndefault:\r\nprintk(KERN_INFO "radeonfb: Found unknown type %d ROM Image\n", rom_type);\r\ngoto failed;\r\n}\r\nanyway:\r\nrinfo->fp_bios_start = BIOS_IN16(0x48);\r\nreturn 0;\r\nfailed:\r\nrinfo->bios_seg = NULL;\r\nradeon_unmap_ROM(rinfo, dev);\r\nreturn -ENXIO;\r\n}\r\nstatic int radeon_find_mem_vbios(struct radeonfb_info *rinfo)\r\n{\r\nu32 segstart;\r\nvoid __iomem *rom_base = NULL;\r\nfor(segstart=0x000c0000; segstart<0x000f0000; segstart+=0x00001000) {\r\nrom_base = ioremap(segstart, 0x10000);\r\nif (rom_base == NULL)\r\nreturn -ENOMEM;\r\nif (readb(rom_base) == 0x55 && readb(rom_base + 1) == 0xaa)\r\nbreak;\r\niounmap(rom_base);\r\nrom_base = NULL;\r\n}\r\nif (rom_base == NULL)\r\nreturn -ENXIO;\r\nrinfo->bios_seg = rom_base;\r\nrinfo->fp_bios_start = BIOS_IN16(0x48);\r\nreturn 0;\r\n}\r\nstatic int radeon_read_xtal_OF(struct radeonfb_info *rinfo)\r\n{\r\nstruct device_node *dp = rinfo->of_node;\r\nconst u32 *val;\r\nif (dp == NULL)\r\nreturn -ENODEV;\r\nval = of_get_property(dp, "ATY,RefCLK", NULL);\r\nif (!val || !*val) {\r\nprintk(KERN_WARNING "radeonfb: No ATY,RefCLK property !\n");\r\nreturn -EINVAL;\r\n}\r\nrinfo->pll.ref_clk = (*val) / 10;\r\nval = of_get_property(dp, "ATY,SCLK", NULL);\r\nif (val && *val)\r\nrinfo->pll.sclk = (*val) / 10;\r\nval = of_get_property(dp, "ATY,MCLK", NULL);\r\nif (val && *val)\r\nrinfo->pll.mclk = (*val) / 10;\r\nreturn 0;\r\n}\r\nstatic int radeon_probe_pll_params(struct radeonfb_info *rinfo)\r\n{\r\nunsigned char ppll_div_sel;\r\nunsigned Ns, Nm, M;\r\nunsigned sclk, mclk, tmp, ref_div;\r\nint hTotal, vTotal, num, denom, m, n;\r\nunsigned long long hz, vclk;\r\nlong xtal;\r\nstruct timeval start_tv, stop_tv;\r\nlong total_secs, total_usecs;\r\nint i;\r\ntmp = INREG16(DEVICE_ID);\r\nlocal_irq_disable();\r\nfor(i=0; i<1000000; i++)\r\nif (((INREG(CRTC_VLINE_CRNT_VLINE) >> 16) & 0x3ff) == 0)\r\nbreak;\r\ndo_gettimeofday(&start_tv);\r\nfor(i=0; i<1000000; i++)\r\nif (((INREG(CRTC_VLINE_CRNT_VLINE) >> 16) & 0x3ff) != 0)\r\nbreak;\r\nfor(i=0; i<1000000; i++)\r\nif (((INREG(CRTC_VLINE_CRNT_VLINE) >> 16) & 0x3ff) == 0)\r\nbreak;\r\ndo_gettimeofday(&stop_tv);\r\nlocal_irq_enable();\r\ntotal_secs = stop_tv.tv_sec - start_tv.tv_sec;\r\nif (total_secs > 10)\r\nreturn -1;\r\ntotal_usecs = stop_tv.tv_usec - start_tv.tv_usec;\r\ntotal_usecs += total_secs * 1000000;\r\nif (total_usecs < 0)\r\ntotal_usecs = -total_usecs;\r\nhz = 1000000/total_usecs;\r\nhTotal = ((INREG(CRTC_H_TOTAL_DISP) & 0x1ff) + 1) * 8;\r\nvTotal = ((INREG(CRTC_V_TOTAL_DISP) & 0x3ff) + 1);\r\nvclk = (long long)hTotal * (long long)vTotal * hz;\r\nswitch((INPLL(PPLL_REF_DIV) & 0x30000) >> 16) {\r\ncase 0:\r\ndefault:\r\nnum = 1;\r\ndenom = 1;\r\nbreak;\r\ncase 1:\r\nn = ((INPLL(M_SPLL_REF_FB_DIV) >> 16) & 0xff);\r\nm = (INPLL(M_SPLL_REF_FB_DIV) & 0xff);\r\nnum = 2*n;\r\ndenom = 2*m;\r\nbreak;\r\ncase 2:\r\nn = ((INPLL(M_SPLL_REF_FB_DIV) >> 8) & 0xff);\r\nm = (INPLL(M_SPLL_REF_FB_DIV) & 0xff);\r\nnum = 2*n;\r\ndenom = 2*m;\r\nbreak;\r\n}\r\nppll_div_sel = INREG8(CLOCK_CNTL_INDEX + 1) & 0x3;\r\nradeon_pll_errata_after_index(rinfo);\r\nn = (INPLL(PPLL_DIV_0 + ppll_div_sel) & 0x7ff);\r\nm = (INPLL(PPLL_REF_DIV) & 0x3ff);\r\nnum *= n;\r\ndenom *= m;\r\nswitch ((INPLL(PPLL_DIV_0 + ppll_div_sel) >> 16) & 0x7) {\r\ncase 1:\r\ndenom *= 2;\r\nbreak;\r\ncase 2:\r\ndenom *= 4;\r\nbreak;\r\ncase 3:\r\ndenom *= 8;\r\nbreak;\r\ncase 4:\r\ndenom *= 3;\r\nbreak;\r\ncase 6:\r\ndenom *= 6;\r\nbreak;\r\ncase 7:\r\ndenom *= 12;\r\nbreak;\r\n}\r\nvclk *= denom;\r\ndo_div(vclk, 1000 * num);\r\nxtal = vclk;\r\nif ((xtal > 26900) && (xtal < 27100))\r\nxtal = 2700;\r\nelse if ((xtal > 14200) && (xtal < 14400))\r\nxtal = 1432;\r\nelse if ((xtal > 29400) && (xtal < 29600))\r\nxtal = 2950;\r\nelse {\r\nprintk(KERN_WARNING "xtal calculation failed: %ld\n", xtal);\r\nreturn -1;\r\n}\r\ntmp = INPLL(M_SPLL_REF_FB_DIV);\r\nref_div = INPLL(PPLL_REF_DIV) & 0x3ff;\r\nNs = (tmp & 0xff0000) >> 16;\r\nNm = (tmp & 0xff00) >> 8;\r\nM = (tmp & 0xff);\r\nsclk = round_div((2 * Ns * xtal), (2 * M));\r\nmclk = round_div((2 * Nm * xtal), (2 * M));\r\nrinfo->pll.ref_clk = xtal;\r\nrinfo->pll.ref_div = ref_div;\r\nrinfo->pll.sclk = sclk;\r\nrinfo->pll.mclk = mclk;\r\nreturn 0;\r\n}\r\nstatic void radeon_get_pllinfo(struct radeonfb_info *rinfo)\r\n{\r\nswitch (rinfo->chipset) {\r\ncase PCI_DEVICE_ID_ATI_RADEON_QW:\r\ncase PCI_DEVICE_ID_ATI_RADEON_QX:\r\nrinfo->pll.ppll_max = 35000;\r\nrinfo->pll.ppll_min = 12000;\r\nrinfo->pll.mclk = 23000;\r\nrinfo->pll.sclk = 23000;\r\nrinfo->pll.ref_clk = 2700;\r\nbreak;\r\ncase PCI_DEVICE_ID_ATI_RADEON_QL:\r\ncase PCI_DEVICE_ID_ATI_RADEON_QN:\r\ncase PCI_DEVICE_ID_ATI_RADEON_QO:\r\ncase PCI_DEVICE_ID_ATI_RADEON_Ql:\r\ncase PCI_DEVICE_ID_ATI_RADEON_BB:\r\nrinfo->pll.ppll_max = 35000;\r\nrinfo->pll.ppll_min = 12000;\r\nrinfo->pll.mclk = 27500;\r\nrinfo->pll.sclk = 27500;\r\nrinfo->pll.ref_clk = 2700;\r\nbreak;\r\ncase PCI_DEVICE_ID_ATI_RADEON_Id:\r\ncase PCI_DEVICE_ID_ATI_RADEON_Ie:\r\ncase PCI_DEVICE_ID_ATI_RADEON_If:\r\ncase PCI_DEVICE_ID_ATI_RADEON_Ig:\r\nrinfo->pll.ppll_max = 35000;\r\nrinfo->pll.ppll_min = 12000;\r\nrinfo->pll.mclk = 25000;\r\nrinfo->pll.sclk = 25000;\r\nrinfo->pll.ref_clk = 2700;\r\nbreak;\r\ncase PCI_DEVICE_ID_ATI_RADEON_ND:\r\ncase PCI_DEVICE_ID_ATI_RADEON_NE:\r\ncase PCI_DEVICE_ID_ATI_RADEON_NF:\r\ncase PCI_DEVICE_ID_ATI_RADEON_NG:\r\nrinfo->pll.ppll_max = 40000;\r\nrinfo->pll.ppll_min = 20000;\r\nrinfo->pll.mclk = 27000;\r\nrinfo->pll.sclk = 27000;\r\nrinfo->pll.ref_clk = 2700;\r\nbreak;\r\ncase PCI_DEVICE_ID_ATI_RADEON_QD:\r\ncase PCI_DEVICE_ID_ATI_RADEON_QE:\r\ncase PCI_DEVICE_ID_ATI_RADEON_QF:\r\ncase PCI_DEVICE_ID_ATI_RADEON_QG:\r\ndefault:\r\nrinfo->pll.ppll_max = 35000;\r\nrinfo->pll.ppll_min = 12000;\r\nrinfo->pll.mclk = 16600;\r\nrinfo->pll.sclk = 16600;\r\nrinfo->pll.ref_clk = 2700;\r\nbreak;\r\n}\r\nrinfo->pll.ref_div = INPLL(PPLL_REF_DIV) & PPLL_REF_DIV_MASK;\r\n#if defined(CONFIG_PPC_OF) || defined(CONFIG_SPARC)\r\nif (!force_measure_pll && radeon_read_xtal_OF(rinfo) == 0) {\r\nprintk(KERN_INFO "radeonfb: Retrieved PLL infos from Open Firmware\n");\r\ngoto found;\r\n}\r\n#endif\r\nif (!force_measure_pll && rinfo->bios_seg) {\r\nu16 pll_info_block = BIOS_IN16(rinfo->fp_bios_start + 0x30);\r\nrinfo->pll.sclk = BIOS_IN16(pll_info_block + 0x08);\r\nrinfo->pll.mclk = BIOS_IN16(pll_info_block + 0x0a);\r\nrinfo->pll.ref_clk = BIOS_IN16(pll_info_block + 0x0e);\r\nrinfo->pll.ref_div = BIOS_IN16(pll_info_block + 0x10);\r\nrinfo->pll.ppll_min = BIOS_IN32(pll_info_block + 0x12);\r\nrinfo->pll.ppll_max = BIOS_IN32(pll_info_block + 0x16);\r\nprintk(KERN_INFO "radeonfb: Retrieved PLL infos from BIOS\n");\r\ngoto found;\r\n}\r\nif (radeon_probe_pll_params(rinfo) == 0) {\r\nprintk(KERN_INFO "radeonfb: Retrieved PLL infos from registers\n");\r\ngoto found;\r\n}\r\nprintk(KERN_INFO "radeonfb: Used default PLL infos\n");\r\nfound:\r\nif (rinfo->pll.mclk == 0)\r\nrinfo->pll.mclk = 20000;\r\nif (rinfo->pll.sclk == 0)\r\nrinfo->pll.sclk = 20000;\r\nprintk("radeonfb: Reference=%d.%02d MHz (RefDiv=%d) Memory=%d.%02d Mhz, System=%d.%02d MHz\n",\r\nrinfo->pll.ref_clk / 100, rinfo->pll.ref_clk % 100,\r\nrinfo->pll.ref_div,\r\nrinfo->pll.mclk / 100, rinfo->pll.mclk % 100,\r\nrinfo->pll.sclk / 100, rinfo->pll.sclk % 100);\r\nprintk("radeonfb: PLL min %d max %d\n", rinfo->pll.ppll_min, rinfo->pll.ppll_max);\r\n}\r\nstatic int radeonfb_check_var (struct fb_var_screeninfo *var, struct fb_info *info)\r\n{\r\nstruct radeonfb_info *rinfo = info->par;\r\nstruct fb_var_screeninfo v;\r\nint nom, den;\r\nunsigned int pitch;\r\nif (radeon_match_mode(rinfo, &v, var))\r\nreturn -EINVAL;\r\nswitch (v.bits_per_pixel) {\r\ncase 0 ... 8:\r\nv.bits_per_pixel = 8;\r\nbreak;\r\ncase 9 ... 16:\r\nv.bits_per_pixel = 16;\r\nbreak;\r\ncase 17 ... 24:\r\n#if 0\r\nv.bits_per_pixel = 24;\r\nbreak;\r\n#endif\r\nreturn -EINVAL;\r\ncase 25 ... 32:\r\nv.bits_per_pixel = 32;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (var_to_depth(&v)) {\r\ncase 8:\r\nnom = den = 1;\r\nv.red.offset = v.green.offset = v.blue.offset = 0;\r\nv.red.length = v.green.length = v.blue.length = 8;\r\nv.transp.offset = v.transp.length = 0;\r\nbreak;\r\ncase 15:\r\nnom = 2;\r\nden = 1;\r\nv.red.offset = 10;\r\nv.green.offset = 5;\r\nv.blue.offset = 0;\r\nv.red.length = v.green.length = v.blue.length = 5;\r\nv.transp.offset = v.transp.length = 0;\r\nbreak;\r\ncase 16:\r\nnom = 2;\r\nden = 1;\r\nv.red.offset = 11;\r\nv.green.offset = 5;\r\nv.blue.offset = 0;\r\nv.red.length = 5;\r\nv.green.length = 6;\r\nv.blue.length = 5;\r\nv.transp.offset = v.transp.length = 0;\r\nbreak;\r\ncase 24:\r\nnom = 4;\r\nden = 1;\r\nv.red.offset = 16;\r\nv.green.offset = 8;\r\nv.blue.offset = 0;\r\nv.red.length = v.blue.length = v.green.length = 8;\r\nv.transp.offset = v.transp.length = 0;\r\nbreak;\r\ncase 32:\r\nnom = 4;\r\nden = 1;\r\nv.red.offset = 16;\r\nv.green.offset = 8;\r\nv.blue.offset = 0;\r\nv.red.length = v.blue.length = v.green.length = 8;\r\nv.transp.offset = 24;\r\nv.transp.length = 8;\r\nbreak;\r\ndefault:\r\nprintk ("radeonfb: mode %dx%dx%d rejected, color depth invalid\n",\r\nvar->xres, var->yres, var->bits_per_pixel);\r\nreturn -EINVAL;\r\n}\r\nif (v.yres_virtual < v.yres)\r\nv.yres_virtual = v.yres;\r\nif (v.xres_virtual < v.xres)\r\nv.xres_virtual = v.xres;\r\nif (rinfo->info->flags & FBINFO_HWACCEL_DISABLED) {\r\nv.xres_virtual = v.xres_virtual & ~7ul;\r\n} else {\r\npitch = ((v.xres_virtual * ((v.bits_per_pixel + 1) / 8) + 0x3f)\r\n& ~(0x3f)) >> 6;\r\nv.xres_virtual = (pitch << 6) / ((v.bits_per_pixel + 1) / 8);\r\n}\r\nif (((v.xres_virtual * v.yres_virtual * nom) / den) > rinfo->mapped_vram)\r\nreturn -EINVAL;\r\nif (v.xres_virtual < v.xres)\r\nv.xres = v.xres_virtual;\r\nif (v.xoffset < 0)\r\nv.xoffset = 0;\r\nif (v.yoffset < 0)\r\nv.yoffset = 0;\r\nif (v.xoffset > v.xres_virtual - v.xres)\r\nv.xoffset = v.xres_virtual - v.xres - 1;\r\nif (v.yoffset > v.yres_virtual - v.yres)\r\nv.yoffset = v.yres_virtual - v.yres - 1;\r\nv.red.msb_right = v.green.msb_right = v.blue.msb_right =\r\nv.transp.offset = v.transp.length =\r\nv.transp.msb_right = 0;\r\nmemcpy(var, &v, sizeof(v));\r\nreturn 0;\r\n}\r\nstatic int radeonfb_pan_display (struct fb_var_screeninfo *var,\r\nstruct fb_info *info)\r\n{\r\nstruct radeonfb_info *rinfo = info->par;\r\nif ((var->xoffset + info->var.xres > info->var.xres_virtual)\r\n|| (var->yoffset + info->var.yres > info->var.yres_virtual))\r\nreturn -EINVAL;\r\nif (rinfo->asleep)\r\nreturn 0;\r\nradeon_fifo_wait(2);\r\nOUTREG(CRTC_OFFSET, (var->yoffset * info->fix.line_length +\r\nvar->xoffset * info->var.bits_per_pixel / 8) & ~7);\r\nreturn 0;\r\n}\r\nstatic int radeonfb_ioctl (struct fb_info *info, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nstruct radeonfb_info *rinfo = info->par;\r\nunsigned int tmp;\r\nu32 value = 0;\r\nint rc;\r\nswitch (cmd) {\r\ncase FBIO_RADEON_SET_MIRROR:\r\nif (!rinfo->is_mobility)\r\nreturn -EINVAL;\r\nrc = get_user(value, (__u32 __user *)arg);\r\nif (rc)\r\nreturn rc;\r\nradeon_fifo_wait(2);\r\nif (value & 0x01) {\r\ntmp = INREG(LVDS_GEN_CNTL);\r\ntmp |= (LVDS_ON | LVDS_BLON);\r\n} else {\r\ntmp = INREG(LVDS_GEN_CNTL);\r\ntmp &= ~(LVDS_ON | LVDS_BLON);\r\n}\r\nOUTREG(LVDS_GEN_CNTL, tmp);\r\nif (value & 0x02) {\r\ntmp = INREG(CRTC_EXT_CNTL);\r\ntmp |= CRTC_CRT_ON;\r\nmirror = 1;\r\n} else {\r\ntmp = INREG(CRTC_EXT_CNTL);\r\ntmp &= ~CRTC_CRT_ON;\r\nmirror = 0;\r\n}\r\nOUTREG(CRTC_EXT_CNTL, tmp);\r\nreturn 0;\r\ncase FBIO_RADEON_GET_MIRROR:\r\nif (!rinfo->is_mobility)\r\nreturn -EINVAL;\r\ntmp = INREG(LVDS_GEN_CNTL);\r\nif ((LVDS_ON | LVDS_BLON) & tmp)\r\nvalue |= 0x01;\r\ntmp = INREG(CRTC_EXT_CNTL);\r\nif (CRTC_CRT_ON & tmp)\r\nvalue |= 0x02;\r\nreturn put_user(value, (__u32 __user *)arg);\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn -EINVAL;\r\n}\r\nint radeon_screen_blank(struct radeonfb_info *rinfo, int blank, int mode_switch)\r\n{\r\nu32 val;\r\nu32 tmp_pix_clks;\r\nint unblank = 0;\r\nif (rinfo->lock_blank)\r\nreturn 0;\r\nradeon_engine_idle();\r\nval = INREG(CRTC_EXT_CNTL);\r\nval &= ~(CRTC_DISPLAY_DIS | CRTC_HSYNC_DIS |\r\nCRTC_VSYNC_DIS);\r\nswitch (blank) {\r\ncase FB_BLANK_VSYNC_SUSPEND:\r\nval |= (CRTC_DISPLAY_DIS | CRTC_VSYNC_DIS);\r\nbreak;\r\ncase FB_BLANK_HSYNC_SUSPEND:\r\nval |= (CRTC_DISPLAY_DIS | CRTC_HSYNC_DIS);\r\nbreak;\r\ncase FB_BLANK_POWERDOWN:\r\nval |= (CRTC_DISPLAY_DIS | CRTC_VSYNC_DIS |\r\nCRTC_HSYNC_DIS);\r\nbreak;\r\ncase FB_BLANK_NORMAL:\r\nval |= CRTC_DISPLAY_DIS;\r\nbreak;\r\ncase FB_BLANK_UNBLANK:\r\ndefault:\r\nunblank = 1;\r\n}\r\nOUTREG(CRTC_EXT_CNTL, val);\r\nswitch (rinfo->mon1_type) {\r\ncase MT_DFP:\r\nif (unblank)\r\nOUTREGP(FP_GEN_CNTL, (FP_FPON | FP_TMDS_EN),\r\n~(FP_FPON | FP_TMDS_EN));\r\nelse {\r\nif (mode_switch || blank == FB_BLANK_NORMAL)\r\nbreak;\r\nOUTREGP(FP_GEN_CNTL, 0, ~(FP_FPON | FP_TMDS_EN));\r\n}\r\nbreak;\r\ncase MT_LCD:\r\ndel_timer_sync(&rinfo->lvds_timer);\r\nval = INREG(LVDS_GEN_CNTL);\r\nif (unblank) {\r\nu32 target_val = (val & ~LVDS_DISPLAY_DIS) | LVDS_BLON | LVDS_ON\r\n| LVDS_EN | (rinfo->init_state.lvds_gen_cntl\r\n& (LVDS_DIGON | LVDS_BL_MOD_EN));\r\nif ((val ^ target_val) == LVDS_DISPLAY_DIS)\r\nOUTREG(LVDS_GEN_CNTL, target_val);\r\nelse if ((val ^ target_val) != 0) {\r\nOUTREG(LVDS_GEN_CNTL, target_val\r\n& ~(LVDS_ON | LVDS_BL_MOD_EN));\r\nrinfo->init_state.lvds_gen_cntl &= ~LVDS_STATE_MASK;\r\nrinfo->init_state.lvds_gen_cntl |=\r\ntarget_val & LVDS_STATE_MASK;\r\nif (mode_switch) {\r\nradeon_msleep(rinfo->panel_info.pwr_delay);\r\nOUTREG(LVDS_GEN_CNTL, target_val);\r\n}\r\nelse {\r\nrinfo->pending_lvds_gen_cntl = target_val;\r\nmod_timer(&rinfo->lvds_timer,\r\njiffies +\r\nmsecs_to_jiffies(rinfo->panel_info.pwr_delay));\r\n}\r\n}\r\n} else {\r\nval |= LVDS_DISPLAY_DIS;\r\nOUTREG(LVDS_GEN_CNTL, val);\r\nif (mode_switch || blank == FB_BLANK_NORMAL)\r\nbreak;\r\ntmp_pix_clks = INPLL(PIXCLKS_CNTL);\r\nif (rinfo->is_mobility || rinfo->is_IGP)\r\nOUTPLLP(PIXCLKS_CNTL, 0, ~PIXCLK_LVDS_ALWAYS_ONb);\r\nval &= ~(LVDS_BL_MOD_EN);\r\nOUTREG(LVDS_GEN_CNTL, val);\r\nudelay(100);\r\nval &= ~(LVDS_ON | LVDS_EN);\r\nOUTREG(LVDS_GEN_CNTL, val);\r\nval &= ~LVDS_DIGON;\r\nrinfo->pending_lvds_gen_cntl = val;\r\nmod_timer(&rinfo->lvds_timer,\r\njiffies +\r\nmsecs_to_jiffies(rinfo->panel_info.pwr_delay));\r\nrinfo->init_state.lvds_gen_cntl &= ~LVDS_STATE_MASK;\r\nrinfo->init_state.lvds_gen_cntl |= val & LVDS_STATE_MASK;\r\nif (rinfo->is_mobility || rinfo->is_IGP)\r\nOUTPLL(PIXCLKS_CNTL, tmp_pix_clks);\r\n}\r\nbreak;\r\ncase MT_CRT:\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int radeonfb_blank (int blank, struct fb_info *info)\r\n{\r\nstruct radeonfb_info *rinfo = info->par;\r\nif (rinfo->asleep)\r\nreturn 0;\r\nreturn radeon_screen_blank(rinfo, blank, 0);\r\n}\r\nstatic int radeon_setcolreg (unsigned regno, unsigned red, unsigned green,\r\nunsigned blue, unsigned transp,\r\nstruct radeonfb_info *rinfo)\r\n{\r\nu32 pindex;\r\nunsigned int i;\r\nif (regno > 255)\r\nreturn -EINVAL;\r\nred >>= 8;\r\ngreen >>= 8;\r\nblue >>= 8;\r\nrinfo->palette[regno].red = red;\r\nrinfo->palette[regno].green = green;\r\nrinfo->palette[regno].blue = blue;\r\npindex = regno;\r\nif (!rinfo->asleep) {\r\nradeon_fifo_wait(9);\r\nif (rinfo->bpp == 16) {\r\npindex = regno * 8;\r\nif (rinfo->depth == 16 && regno > 63)\r\nreturn -EINVAL;\r\nif (rinfo->depth == 15 && regno > 31)\r\nreturn -EINVAL;\r\nif (rinfo->depth == 16) {\r\nOUTREG(PALETTE_INDEX, pindex>>1);\r\nOUTREG(PALETTE_DATA,\r\n(rinfo->palette[regno>>1].red << 16) |\r\n(green << 8) |\r\n(rinfo->palette[regno>>1].blue));\r\ngreen = rinfo->palette[regno<<1].green;\r\n}\r\n}\r\nif (rinfo->depth != 16 || regno < 32) {\r\nOUTREG(PALETTE_INDEX, pindex);\r\nOUTREG(PALETTE_DATA, (red << 16) |\r\n(green << 8) | blue);\r\n}\r\n}\r\nif (regno < 16) {\r\nu32 *pal = rinfo->info->pseudo_palette;\r\nswitch (rinfo->depth) {\r\ncase 15:\r\npal[regno] = (regno << 10) | (regno << 5) | regno;\r\nbreak;\r\ncase 16:\r\npal[regno] = (regno << 11) | (regno << 5) | regno;\r\nbreak;\r\ncase 24:\r\npal[regno] = (regno << 16) | (regno << 8) | regno;\r\nbreak;\r\ncase 32:\r\ni = (regno << 8) | regno;\r\npal[regno] = (i << 16) | i;\r\nbreak;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int radeonfb_setcolreg (unsigned regno, unsigned red, unsigned green,\r\nunsigned blue, unsigned transp,\r\nstruct fb_info *info)\r\n{\r\nstruct radeonfb_info *rinfo = info->par;\r\nu32 dac_cntl2, vclk_cntl = 0;\r\nint rc;\r\nif (!rinfo->asleep) {\r\nif (rinfo->is_mobility) {\r\nvclk_cntl = INPLL(VCLK_ECP_CNTL);\r\nOUTPLL(VCLK_ECP_CNTL,\r\nvclk_cntl & ~PIXCLK_DAC_ALWAYS_ONb);\r\n}\r\nif (rinfo->has_CRTC2) {\r\ndac_cntl2 = INREG(DAC_CNTL2);\r\ndac_cntl2 &= ~DAC2_PALETTE_ACCESS_CNTL;\r\nOUTREG(DAC_CNTL2, dac_cntl2);\r\n}\r\n}\r\nrc = radeon_setcolreg (regno, red, green, blue, transp, rinfo);\r\nif (!rinfo->asleep && rinfo->is_mobility)\r\nOUTPLL(VCLK_ECP_CNTL, vclk_cntl);\r\nreturn rc;\r\n}\r\nstatic int radeonfb_setcmap(struct fb_cmap *cmap, struct fb_info *info)\r\n{\r\nstruct radeonfb_info *rinfo = info->par;\r\nu16 *red, *green, *blue, *transp;\r\nu32 dac_cntl2, vclk_cntl = 0;\r\nint i, start, rc = 0;\r\nif (!rinfo->asleep) {\r\nif (rinfo->is_mobility) {\r\nvclk_cntl = INPLL(VCLK_ECP_CNTL);\r\nOUTPLL(VCLK_ECP_CNTL,\r\nvclk_cntl & ~PIXCLK_DAC_ALWAYS_ONb);\r\n}\r\nif (rinfo->has_CRTC2) {\r\ndac_cntl2 = INREG(DAC_CNTL2);\r\ndac_cntl2 &= ~DAC2_PALETTE_ACCESS_CNTL;\r\nOUTREG(DAC_CNTL2, dac_cntl2);\r\n}\r\n}\r\nred = cmap->red;\r\ngreen = cmap->green;\r\nblue = cmap->blue;\r\ntransp = cmap->transp;\r\nstart = cmap->start;\r\nfor (i = 0; i < cmap->len; i++) {\r\nu_int hred, hgreen, hblue, htransp = 0xffff;\r\nhred = *red++;\r\nhgreen = *green++;\r\nhblue = *blue++;\r\nif (transp)\r\nhtransp = *transp++;\r\nrc = radeon_setcolreg (start++, hred, hgreen, hblue, htransp,\r\nrinfo);\r\nif (rc)\r\nbreak;\r\n}\r\nif (!rinfo->asleep && rinfo->is_mobility)\r\nOUTPLL(VCLK_ECP_CNTL, vclk_cntl);\r\nreturn rc;\r\n}\r\nstatic void radeon_save_state (struct radeonfb_info *rinfo,\r\nstruct radeon_regs *save)\r\n{\r\nsave->crtc_gen_cntl = INREG(CRTC_GEN_CNTL);\r\nsave->crtc_ext_cntl = INREG(CRTC_EXT_CNTL);\r\nsave->crtc_more_cntl = INREG(CRTC_MORE_CNTL);\r\nsave->dac_cntl = INREG(DAC_CNTL);\r\nsave->crtc_h_total_disp = INREG(CRTC_H_TOTAL_DISP);\r\nsave->crtc_h_sync_strt_wid = INREG(CRTC_H_SYNC_STRT_WID);\r\nsave->crtc_v_total_disp = INREG(CRTC_V_TOTAL_DISP);\r\nsave->crtc_v_sync_strt_wid = INREG(CRTC_V_SYNC_STRT_WID);\r\nsave->crtc_pitch = INREG(CRTC_PITCH);\r\nsave->surface_cntl = INREG(SURFACE_CNTL);\r\nsave->fp_crtc_h_total_disp = INREG(FP_CRTC_H_TOTAL_DISP);\r\nsave->fp_crtc_v_total_disp = INREG(FP_CRTC_V_TOTAL_DISP);\r\nsave->fp_gen_cntl = INREG(FP_GEN_CNTL);\r\nsave->fp_h_sync_strt_wid = INREG(FP_H_SYNC_STRT_WID);\r\nsave->fp_horz_stretch = INREG(FP_HORZ_STRETCH);\r\nsave->fp_v_sync_strt_wid = INREG(FP_V_SYNC_STRT_WID);\r\nsave->fp_vert_stretch = INREG(FP_VERT_STRETCH);\r\nsave->lvds_gen_cntl = INREG(LVDS_GEN_CNTL);\r\nsave->lvds_pll_cntl = INREG(LVDS_PLL_CNTL);\r\nsave->tmds_crc = INREG(TMDS_CRC);\r\nsave->tmds_transmitter_cntl = INREG(TMDS_TRANSMITTER_CNTL);\r\nsave->vclk_ecp_cntl = INPLL(VCLK_ECP_CNTL);\r\nsave->clk_cntl_index = INREG(CLOCK_CNTL_INDEX) & ~0x3f;\r\nradeon_pll_errata_after_index(rinfo);\r\nsave->ppll_div_3 = INPLL(PPLL_DIV_3);\r\nsave->ppll_ref_div = INPLL(PPLL_REF_DIV);\r\n}\r\nstatic void radeon_write_pll_regs(struct radeonfb_info *rinfo, struct radeon_regs *mode)\r\n{\r\nint i;\r\nradeon_fifo_wait(20);\r\nif (rinfo->is_mobility) {\r\nif ((mode->ppll_ref_div == (INPLL(PPLL_REF_DIV) & PPLL_REF_DIV_MASK)) &&\r\n(mode->ppll_div_3 == (INPLL(PPLL_DIV_3) &\r\n(PPLL_POST3_DIV_MASK | PPLL_FB3_DIV_MASK)))) {\r\nOUTREGP(CLOCK_CNTL_INDEX,\r\nmode->clk_cntl_index & PPLL_DIV_SEL_MASK,\r\n~PPLL_DIV_SEL_MASK);\r\nradeon_pll_errata_after_index(rinfo);\r\nradeon_pll_errata_after_data(rinfo);\r\nreturn;\r\n}\r\n}\r\nOUTPLLP(VCLK_ECP_CNTL, VCLK_SRC_SEL_CPUCLK, ~VCLK_SRC_SEL_MASK);\r\nOUTPLLP(PPLL_CNTL,\r\nPPLL_RESET | PPLL_ATOMIC_UPDATE_EN | PPLL_VGA_ATOMIC_UPDATE_EN,\r\n~(PPLL_RESET | PPLL_ATOMIC_UPDATE_EN | PPLL_VGA_ATOMIC_UPDATE_EN));\r\nOUTREGP(CLOCK_CNTL_INDEX,\r\nmode->clk_cntl_index & PPLL_DIV_SEL_MASK,\r\n~PPLL_DIV_SEL_MASK);\r\nradeon_pll_errata_after_index(rinfo);\r\nradeon_pll_errata_after_data(rinfo);\r\nif (IS_R300_VARIANT(rinfo) ||\r\nrinfo->family == CHIP_FAMILY_RS300 ||\r\nrinfo->family == CHIP_FAMILY_RS400 ||\r\nrinfo->family == CHIP_FAMILY_RS480) {\r\nif (mode->ppll_ref_div & R300_PPLL_REF_DIV_ACC_MASK) {\r\nOUTPLLP(PPLL_REF_DIV, mode->ppll_ref_div, 0);\r\n} else {\r\nOUTPLLP(PPLL_REF_DIV,\r\n(mode->ppll_ref_div << R300_PPLL_REF_DIV_ACC_SHIFT),\r\n~R300_PPLL_REF_DIV_ACC_MASK);\r\n}\r\n} else\r\nOUTPLLP(PPLL_REF_DIV, mode->ppll_ref_div, ~PPLL_REF_DIV_MASK);\r\nOUTPLLP(PPLL_DIV_3, mode->ppll_div_3, ~PPLL_FB3_DIV_MASK);\r\nOUTPLLP(PPLL_DIV_3, mode->ppll_div_3, ~PPLL_POST3_DIV_MASK);\r\nwhile (INPLL(PPLL_REF_DIV) & PPLL_ATOMIC_UPDATE_R)\r\n;\r\nOUTPLLP(PPLL_REF_DIV, PPLL_ATOMIC_UPDATE_W, ~PPLL_ATOMIC_UPDATE_W);\r\nfor (i = 0; (i < 10000 && INPLL(PPLL_REF_DIV) & PPLL_ATOMIC_UPDATE_R); i++)\r\n;\r\nOUTPLL(HTOTAL_CNTL, 0);\r\nOUTPLLP(PPLL_CNTL, 0,\r\n~(PPLL_RESET | PPLL_SLEEP | PPLL_ATOMIC_UPDATE_EN | PPLL_VGA_ATOMIC_UPDATE_EN));\r\nradeon_msleep(5);\r\nOUTPLLP(VCLK_ECP_CNTL, VCLK_SRC_SEL_PPLLCLK, ~VCLK_SRC_SEL_MASK);\r\n}\r\nstatic void radeon_lvds_timer_func(unsigned long data)\r\n{\r\nstruct radeonfb_info *rinfo = (struct radeonfb_info *)data;\r\nradeon_engine_idle();\r\nOUTREG(LVDS_GEN_CNTL, rinfo->pending_lvds_gen_cntl);\r\n}\r\nvoid radeon_write_mode (struct radeonfb_info *rinfo, struct radeon_regs *mode,\r\nint regs_only)\r\n{\r\nint i;\r\nint primary_mon = PRIMARY_MONITOR(rinfo);\r\nif (nomodeset)\r\nreturn;\r\nif (!regs_only)\r\nradeon_screen_blank(rinfo, FB_BLANK_NORMAL, 0);\r\nradeon_fifo_wait(31);\r\nfor (i=0; i<10; i++)\r\nOUTREG(common_regs[i].reg, common_regs[i].val);\r\nfor (i=0; i<8; i++) {\r\nOUTREG(SURFACE0_LOWER_BOUND + 0x10*i, mode->surf_lower_bound[i]);\r\nOUTREG(SURFACE0_UPPER_BOUND + 0x10*i, mode->surf_upper_bound[i]);\r\nOUTREG(SURFACE0_INFO + 0x10*i, mode->surf_info[i]);\r\n}\r\nOUTREG(CRTC_GEN_CNTL, mode->crtc_gen_cntl);\r\nOUTREGP(CRTC_EXT_CNTL, mode->crtc_ext_cntl,\r\n~(CRTC_HSYNC_DIS | CRTC_VSYNC_DIS | CRTC_DISPLAY_DIS));\r\nOUTREG(CRTC_MORE_CNTL, mode->crtc_more_cntl);\r\nOUTREGP(DAC_CNTL, mode->dac_cntl, DAC_RANGE_CNTL | DAC_BLANKING);\r\nOUTREG(CRTC_H_TOTAL_DISP, mode->crtc_h_total_disp);\r\nOUTREG(CRTC_H_SYNC_STRT_WID, mode->crtc_h_sync_strt_wid);\r\nOUTREG(CRTC_V_TOTAL_DISP, mode->crtc_v_total_disp);\r\nOUTREG(CRTC_V_SYNC_STRT_WID, mode->crtc_v_sync_strt_wid);\r\nOUTREG(CRTC_OFFSET, 0);\r\nOUTREG(CRTC_OFFSET_CNTL, 0);\r\nOUTREG(CRTC_PITCH, mode->crtc_pitch);\r\nOUTREG(SURFACE_CNTL, mode->surface_cntl);\r\nradeon_write_pll_regs(rinfo, mode);\r\nif ((primary_mon == MT_DFP) || (primary_mon == MT_LCD)) {\r\nradeon_fifo_wait(10);\r\nOUTREG(FP_CRTC_H_TOTAL_DISP, mode->fp_crtc_h_total_disp);\r\nOUTREG(FP_CRTC_V_TOTAL_DISP, mode->fp_crtc_v_total_disp);\r\nOUTREG(FP_H_SYNC_STRT_WID, mode->fp_h_sync_strt_wid);\r\nOUTREG(FP_V_SYNC_STRT_WID, mode->fp_v_sync_strt_wid);\r\nOUTREG(FP_HORZ_STRETCH, mode->fp_horz_stretch);\r\nOUTREG(FP_VERT_STRETCH, mode->fp_vert_stretch);\r\nOUTREG(FP_GEN_CNTL, mode->fp_gen_cntl);\r\nOUTREG(TMDS_CRC, mode->tmds_crc);\r\nOUTREG(TMDS_TRANSMITTER_CNTL, mode->tmds_transmitter_cntl);\r\n}\r\nif (!regs_only)\r\nradeon_screen_blank(rinfo, FB_BLANK_UNBLANK, 0);\r\nradeon_fifo_wait(2);\r\nOUTPLL(VCLK_ECP_CNTL, mode->vclk_ecp_cntl);\r\nreturn;\r\n}\r\nstatic void radeon_calc_pll_regs(struct radeonfb_info *rinfo, struct radeon_regs *regs,\r\nunsigned long freq)\r\n{\r\nconst struct {\r\nint divider;\r\nint bitvalue;\r\n} *post_div,\r\npost_divs[] = {\r\n{ 1, 0 },\r\n{ 2, 1 },\r\n{ 4, 2 },\r\n{ 8, 3 },\r\n{ 3, 4 },\r\n{ 16, 5 },\r\n{ 6, 6 },\r\n{ 12, 7 },\r\n{ 0, 0 },\r\n};\r\nint fb_div, pll_output_freq = 0;\r\nint uses_dvo = 0;\r\n#if 1\r\nwhile (rinfo->has_CRTC2) {\r\nu32 fp2_gen_cntl = INREG(FP2_GEN_CNTL);\r\nu32 disp_output_cntl;\r\nint source;\r\nif ((fp2_gen_cntl & FP2_ON) == 0)\r\nbreak;\r\nif (rinfo->family == CHIP_FAMILY_R200 || IS_R300_VARIANT(rinfo)) {\r\nsource = (fp2_gen_cntl >> 10) & 0x3;\r\nif (source == 3) {\r\ndisp_output_cntl = INREG(DISP_OUTPUT_CNTL);\r\nsource = (disp_output_cntl >> 12) & 0x3;\r\n}\r\n} else\r\nsource = (fp2_gen_cntl >> 13) & 0x1;\r\nif (source == 1)\r\nbreak;\r\nuses_dvo = 1;\r\nbreak;\r\n}\r\n#else\r\nuses_dvo = 1;\r\n#endif\r\nif (freq > rinfo->pll.ppll_max)\r\nfreq = rinfo->pll.ppll_max;\r\nif (freq*12 < rinfo->pll.ppll_min)\r\nfreq = rinfo->pll.ppll_min / 12;\r\npr_debug("freq = %lu, PLL min = %u, PLL max = %u\n",\r\nfreq, rinfo->pll.ppll_min, rinfo->pll.ppll_max);\r\nfor (post_div = &post_divs[0]; post_div->divider; ++post_div) {\r\npll_output_freq = post_div->divider * freq;\r\nif (uses_dvo && (post_div->divider & 1))\r\ncontinue;\r\nif (pll_output_freq >= rinfo->pll.ppll_min &&\r\npll_output_freq <= rinfo->pll.ppll_max)\r\nbreak;\r\n}\r\nif ( !post_div->divider ) {\r\npost_div = &post_divs[post_div->bitvalue];\r\npll_output_freq = post_div->divider * freq;\r\n}\r\npr_debug("ref_div = %d, ref_clk = %d, output_freq = %d\n",\r\nrinfo->pll.ref_div, rinfo->pll.ref_clk,\r\npll_output_freq);\r\nif ( !post_div->divider ) {\r\npost_div = &post_divs[post_div->bitvalue];\r\npll_output_freq = post_div->divider * freq;\r\n}\r\npr_debug("ref_div = %d, ref_clk = %d, output_freq = %d\n",\r\nrinfo->pll.ref_div, rinfo->pll.ref_clk,\r\npll_output_freq);\r\nfb_div = round_div(rinfo->pll.ref_div*pll_output_freq,\r\nrinfo->pll.ref_clk);\r\nregs->ppll_ref_div = rinfo->pll.ref_div;\r\nregs->ppll_div_3 = fb_div | (post_div->bitvalue << 16);\r\npr_debug("post div = 0x%x\n", post_div->bitvalue);\r\npr_debug("fb_div = 0x%x\n", fb_div);\r\npr_debug("ppll_div_3 = 0x%x\n", regs->ppll_div_3);\r\n}\r\nstatic int radeonfb_set_par(struct fb_info *info)\r\n{\r\nstruct radeonfb_info *rinfo = info->par;\r\nstruct fb_var_screeninfo *mode = &info->var;\r\nstruct radeon_regs *newmode;\r\nint hTotal, vTotal, hSyncStart, hSyncEnd,\r\nhSyncPol, vSyncStart, vSyncEnd, vSyncPol, cSync;\r\nu8 hsync_adj_tab[] = {0, 0x12, 9, 9, 6, 5};\r\nu8 hsync_fudge_fp[] = {2, 2, 0, 0, 5, 5};\r\nu32 sync, h_sync_pol, v_sync_pol, dotClock, pixClock;\r\nint i, freq;\r\nint format = 0;\r\nint nopllcalc = 0;\r\nint hsync_start, hsync_fudge, bytpp, hsync_wid, vsync_wid;\r\nint primary_mon = PRIMARY_MONITOR(rinfo);\r\nint depth = var_to_depth(mode);\r\nint use_rmx = 0;\r\nnewmode = kmalloc(sizeof(struct radeon_regs), GFP_KERNEL);\r\nif (!newmode)\r\nreturn -ENOMEM;\r\nradeon_engine_idle();\r\nhSyncStart = mode->xres + mode->right_margin;\r\nhSyncEnd = hSyncStart + mode->hsync_len;\r\nhTotal = hSyncEnd + mode->left_margin;\r\nvSyncStart = mode->yres + mode->lower_margin;\r\nvSyncEnd = vSyncStart + mode->vsync_len;\r\nvTotal = vSyncEnd + mode->upper_margin;\r\npixClock = mode->pixclock;\r\nsync = mode->sync;\r\nh_sync_pol = sync & FB_SYNC_HOR_HIGH_ACT ? 0 : 1;\r\nv_sync_pol = sync & FB_SYNC_VERT_HIGH_ACT ? 0 : 1;\r\nif (primary_mon == MT_DFP || primary_mon == MT_LCD) {\r\nif (rinfo->panel_info.xres < mode->xres)\r\nmode->xres = rinfo->panel_info.xres;\r\nif (rinfo->panel_info.yres < mode->yres)\r\nmode->yres = rinfo->panel_info.yres;\r\nhTotal = mode->xres + rinfo->panel_info.hblank;\r\nhSyncStart = mode->xres + rinfo->panel_info.hOver_plus;\r\nhSyncEnd = hSyncStart + rinfo->panel_info.hSync_width;\r\nvTotal = mode->yres + rinfo->panel_info.vblank;\r\nvSyncStart = mode->yres + rinfo->panel_info.vOver_plus;\r\nvSyncEnd = vSyncStart + rinfo->panel_info.vSync_width;\r\nh_sync_pol = !rinfo->panel_info.hAct_high;\r\nv_sync_pol = !rinfo->panel_info.vAct_high;\r\npixClock = 100000000 / rinfo->panel_info.clock;\r\nif (rinfo->panel_info.use_bios_dividers) {\r\nnopllcalc = 1;\r\nnewmode->ppll_div_3 = rinfo->panel_info.fbk_divider |\r\n(rinfo->panel_info.post_divider << 16);\r\nnewmode->ppll_ref_div = rinfo->panel_info.ref_divider;\r\n}\r\n}\r\ndotClock = 1000000000 / pixClock;\r\nfreq = dotClock / 10;\r\npr_debug("hStart = %d, hEnd = %d, hTotal = %d\n",\r\nhSyncStart, hSyncEnd, hTotal);\r\npr_debug("vStart = %d, vEnd = %d, vTotal = %d\n",\r\nvSyncStart, vSyncEnd, vTotal);\r\nhsync_wid = (hSyncEnd - hSyncStart) / 8;\r\nvsync_wid = vSyncEnd - vSyncStart;\r\nif (hsync_wid == 0)\r\nhsync_wid = 1;\r\nelse if (hsync_wid > 0x3f)\r\nhsync_wid = 0x3f;\r\nif (vsync_wid == 0)\r\nvsync_wid = 1;\r\nelse if (vsync_wid > 0x1f)\r\nvsync_wid = 0x1f;\r\nhSyncPol = mode->sync & FB_SYNC_HOR_HIGH_ACT ? 0 : 1;\r\nvSyncPol = mode->sync & FB_SYNC_VERT_HIGH_ACT ? 0 : 1;\r\ncSync = mode->sync & FB_SYNC_COMP_HIGH_ACT ? (1 << 4) : 0;\r\nformat = radeon_get_dstbpp(depth);\r\nbytpp = mode->bits_per_pixel >> 3;\r\nif ((primary_mon == MT_DFP) || (primary_mon == MT_LCD))\r\nhsync_fudge = hsync_fudge_fp[format-1];\r\nelse\r\nhsync_fudge = hsync_adj_tab[format-1];\r\nhsync_start = hSyncStart - 8 + hsync_fudge;\r\nnewmode->crtc_gen_cntl = CRTC_EXT_DISP_EN | CRTC_EN |\r\n(format << 8);\r\nnewmode->crtc_more_cntl = rinfo->init_state.crtc_more_cntl;\r\nnewmode->crtc_more_cntl &= 0xfffffff0;\r\nif ((primary_mon == MT_DFP) || (primary_mon == MT_LCD)) {\r\nnewmode->crtc_ext_cntl = VGA_ATI_LINEAR | XCRT_CNT_EN;\r\nif (mirror)\r\nnewmode->crtc_ext_cntl |= CRTC_CRT_ON;\r\nnewmode->crtc_gen_cntl &= ~(CRTC_DBL_SCAN_EN |\r\nCRTC_INTERLACE_EN);\r\n} else {\r\nnewmode->crtc_ext_cntl = VGA_ATI_LINEAR | XCRT_CNT_EN |\r\nCRTC_CRT_ON;\r\n}\r\nnewmode->dac_cntl = DAC_MASK_ALL | DAC_VGA_ADR_EN |\r\nDAC_8BIT_EN;\r\nnewmode->crtc_h_total_disp = ((((hTotal / 8) - 1) & 0x3ff) |\r\n(((mode->xres / 8) - 1) << 16));\r\nnewmode->crtc_h_sync_strt_wid = ((hsync_start & 0x1fff) |\r\n(hsync_wid << 16) | (h_sync_pol << 23));\r\nnewmode->crtc_v_total_disp = ((vTotal - 1) & 0xffff) |\r\n((mode->yres - 1) << 16);\r\nnewmode->crtc_v_sync_strt_wid = (((vSyncStart - 1) & 0xfff) |\r\n(vsync_wid << 16) | (v_sync_pol << 23));\r\nif (!(info->flags & FBINFO_HWACCEL_DISABLED)) {\r\nrinfo->pitch = ((mode->xres_virtual * ((mode->bits_per_pixel + 1) / 8) + 0x3f)\r\n& ~(0x3f)) >> 6;\r\nnewmode->crtc_pitch = (rinfo->pitch << 3) / ((mode->bits_per_pixel + 1) / 8);\r\n} else\r\nnewmode->crtc_pitch = (mode->xres_virtual >> 3);\r\nnewmode->crtc_pitch |= (newmode->crtc_pitch << 16);\r\nnewmode->surface_cntl = 0;\r\n#if defined(__BIG_ENDIAN)\r\nswitch (mode->bits_per_pixel) {\r\ncase 16:\r\nnewmode->surface_cntl |= NONSURF_AP0_SWP_16BPP;\r\nnewmode->surface_cntl |= NONSURF_AP1_SWP_16BPP;\r\nbreak;\r\ncase 24:\r\ncase 32:\r\nnewmode->surface_cntl |= NONSURF_AP0_SWP_32BPP;\r\nnewmode->surface_cntl |= NONSURF_AP1_SWP_32BPP;\r\nbreak;\r\n}\r\n#endif\r\nfor (i=0; i<8; i++) {\r\nnewmode->surf_lower_bound[i] = 0;\r\nnewmode->surf_upper_bound[i] = 0x1f;\r\nnewmode->surf_info[i] = 0;\r\n}\r\npr_debug("h_total_disp = 0x%x\t hsync_strt_wid = 0x%x\n",\r\nnewmode->crtc_h_total_disp, newmode->crtc_h_sync_strt_wid);\r\npr_debug("v_total_disp = 0x%x\t vsync_strt_wid = 0x%x\n",\r\nnewmode->crtc_v_total_disp, newmode->crtc_v_sync_strt_wid);\r\nrinfo->bpp = mode->bits_per_pixel;\r\nrinfo->depth = depth;\r\npr_debug("pixclock = %lu\n", (unsigned long)pixClock);\r\npr_debug("freq = %lu\n", (unsigned long)freq);\r\nnewmode->clk_cntl_index = 0x300;\r\nif (!nopllcalc)\r\nradeon_calc_pll_regs(rinfo, newmode, freq);\r\nnewmode->vclk_ecp_cntl = rinfo->init_state.vclk_ecp_cntl;\r\nif ((primary_mon == MT_DFP) || (primary_mon == MT_LCD)) {\r\nunsigned int hRatio, vRatio;\r\nif (mode->xres > rinfo->panel_info.xres)\r\nmode->xres = rinfo->panel_info.xres;\r\nif (mode->yres > rinfo->panel_info.yres)\r\nmode->yres = rinfo->panel_info.yres;\r\nnewmode->fp_horz_stretch = (((rinfo->panel_info.xres / 8) - 1)\r\n<< HORZ_PANEL_SHIFT);\r\nnewmode->fp_vert_stretch = ((rinfo->panel_info.yres - 1)\r\n<< VERT_PANEL_SHIFT);\r\nif (mode->xres != rinfo->panel_info.xres) {\r\nhRatio = round_div(mode->xres * HORZ_STRETCH_RATIO_MAX,\r\nrinfo->panel_info.xres);\r\nnewmode->fp_horz_stretch = (((((unsigned long)hRatio) & HORZ_STRETCH_RATIO_MASK)) |\r\n(newmode->fp_horz_stretch &\r\n(HORZ_PANEL_SIZE | HORZ_FP_LOOP_STRETCH |\r\nHORZ_AUTO_RATIO_INC)));\r\nnewmode->fp_horz_stretch |= (HORZ_STRETCH_BLEND |\r\nHORZ_STRETCH_ENABLE);\r\nuse_rmx = 1;\r\n}\r\nnewmode->fp_horz_stretch &= ~HORZ_AUTO_RATIO;\r\nif (mode->yres != rinfo->panel_info.yres) {\r\nvRatio = round_div(mode->yres * VERT_STRETCH_RATIO_MAX,\r\nrinfo->panel_info.yres);\r\nnewmode->fp_vert_stretch = (((((unsigned long)vRatio) & VERT_STRETCH_RATIO_MASK)) |\r\n(newmode->fp_vert_stretch &\r\n(VERT_PANEL_SIZE | VERT_STRETCH_RESERVED)));\r\nnewmode->fp_vert_stretch |= (VERT_STRETCH_BLEND |\r\nVERT_STRETCH_ENABLE);\r\nuse_rmx = 1;\r\n}\r\nnewmode->fp_vert_stretch &= ~VERT_AUTO_RATIO_EN;\r\nnewmode->fp_gen_cntl = (rinfo->init_state.fp_gen_cntl & (u32)\r\n~(FP_SEL_CRTC2 |\r\nFP_RMX_HVSYNC_CONTROL_EN |\r\nFP_DFP_SYNC_SEL |\r\nFP_CRT_SYNC_SEL |\r\nFP_CRTC_LOCK_8DOT |\r\nFP_USE_SHADOW_EN |\r\nFP_CRTC_USE_SHADOW_VEND |\r\nFP_CRT_SYNC_ALT));\r\nnewmode->fp_gen_cntl |= (FP_CRTC_DONT_SHADOW_VPAR |\r\nFP_CRTC_DONT_SHADOW_HEND |\r\nFP_PANEL_FORMAT);\r\nif (IS_R300_VARIANT(rinfo) ||\r\n(rinfo->family == CHIP_FAMILY_R200)) {\r\nnewmode->fp_gen_cntl &= ~R200_FP_SOURCE_SEL_MASK;\r\nif (use_rmx)\r\nnewmode->fp_gen_cntl |= R200_FP_SOURCE_SEL_RMX;\r\nelse\r\nnewmode->fp_gen_cntl |= R200_FP_SOURCE_SEL_CRTC1;\r\n} else\r\nnewmode->fp_gen_cntl |= FP_SEL_CRTC1;\r\nnewmode->lvds_gen_cntl = rinfo->init_state.lvds_gen_cntl;\r\nnewmode->lvds_pll_cntl = rinfo->init_state.lvds_pll_cntl;\r\nnewmode->tmds_crc = rinfo->init_state.tmds_crc;\r\nnewmode->tmds_transmitter_cntl = rinfo->init_state.tmds_transmitter_cntl;\r\nif (primary_mon == MT_LCD) {\r\nnewmode->lvds_gen_cntl |= (LVDS_ON | LVDS_BLON);\r\nnewmode->fp_gen_cntl &= ~(FP_FPON | FP_TMDS_EN);\r\n} else {\r\nnewmode->fp_gen_cntl |= (FP_FPON | FP_TMDS_EN);\r\nnewmode->tmds_transmitter_cntl &= ~(TMDS_PLLRST);\r\nif (IS_R300_VARIANT(rinfo) ||\r\n(rinfo->family == CHIP_FAMILY_R200) || !rinfo->has_CRTC2)\r\nnewmode->tmds_transmitter_cntl &= ~TMDS_PLL_EN;\r\nelse\r\nnewmode->tmds_transmitter_cntl |= TMDS_PLL_EN;\r\nnewmode->crtc_ext_cntl &= ~CRTC_CRT_ON;\r\n}\r\nnewmode->fp_crtc_h_total_disp = (((rinfo->panel_info.hblank / 8) & 0x3ff) |\r\n(((mode->xres / 8) - 1) << 16));\r\nnewmode->fp_crtc_v_total_disp = (rinfo->panel_info.vblank & 0xffff) |\r\n((mode->yres - 1) << 16);\r\nnewmode->fp_h_sync_strt_wid = ((rinfo->panel_info.hOver_plus & 0x1fff) |\r\n(hsync_wid << 16) | (h_sync_pol << 23));\r\nnewmode->fp_v_sync_strt_wid = ((rinfo->panel_info.vOver_plus & 0xfff) |\r\n(vsync_wid << 16) | (v_sync_pol << 23));\r\n}\r\nif (!rinfo->asleep) {\r\nmemcpy(&rinfo->state, newmode, sizeof(*newmode));\r\nradeon_write_mode (rinfo, newmode, 0);\r\nif (!(info->flags & FBINFO_HWACCEL_DISABLED))\r\nradeonfb_engine_init (rinfo);\r\n}\r\nif (!(info->flags & FBINFO_HWACCEL_DISABLED))\r\ninfo->fix.line_length = rinfo->pitch*64;\r\nelse\r\ninfo->fix.line_length = mode->xres_virtual\r\n* ((mode->bits_per_pixel + 1) / 8);\r\ninfo->fix.visual = rinfo->depth == 8 ? FB_VISUAL_PSEUDOCOLOR\r\n: FB_VISUAL_DIRECTCOLOR;\r\n#ifdef CONFIG_BOOTX_TEXT\r\nbtext_update_display(rinfo->fb_base_phys, mode->xres, mode->yres,\r\nrinfo->depth, info->fix.line_length);\r\n#endif\r\nkfree(newmode);\r\nreturn 0;\r\n}\r\nstatic int radeon_set_fbinfo(struct radeonfb_info *rinfo)\r\n{\r\nstruct fb_info *info = rinfo->info;\r\ninfo->par = rinfo;\r\ninfo->pseudo_palette = rinfo->pseudo_palette;\r\ninfo->flags = FBINFO_DEFAULT\r\n| FBINFO_HWACCEL_COPYAREA\r\n| FBINFO_HWACCEL_FILLRECT\r\n| FBINFO_HWACCEL_XPAN\r\n| FBINFO_HWACCEL_YPAN;\r\ninfo->fbops = &radeonfb_ops;\r\ninfo->screen_base = rinfo->fb_base;\r\ninfo->screen_size = rinfo->mapped_vram;\r\nstrlcpy(info->fix.id, rinfo->name, sizeof(info->fix.id));\r\ninfo->fix.smem_start = rinfo->fb_base_phys;\r\ninfo->fix.smem_len = rinfo->video_ram;\r\ninfo->fix.type = FB_TYPE_PACKED_PIXELS;\r\ninfo->fix.visual = FB_VISUAL_PSEUDOCOLOR;\r\ninfo->fix.xpanstep = 8;\r\ninfo->fix.ypanstep = 1;\r\ninfo->fix.ywrapstep = 0;\r\ninfo->fix.type_aux = 0;\r\ninfo->fix.mmio_start = rinfo->mmio_base_phys;\r\ninfo->fix.mmio_len = RADEON_REGSIZE;\r\ninfo->fix.accel = FB_ACCEL_ATI_RADEON;\r\nfb_alloc_cmap(&info->cmap, 256, 0);\r\nif (noaccel)\r\ninfo->flags |= FBINFO_HWACCEL_DISABLED;\r\nreturn 0;\r\n}\r\nstatic void fixup_memory_mappings(struct radeonfb_info *rinfo)\r\n{\r\nu32 save_crtc_gen_cntl, save_crtc2_gen_cntl = 0;\r\nu32 save_crtc_ext_cntl;\r\nu32 aper_base, aper_size;\r\nu32 agp_base;\r\nif (rinfo->has_CRTC2) {\r\nsave_crtc2_gen_cntl = INREG(CRTC2_GEN_CNTL);\r\nOUTREG(CRTC2_GEN_CNTL, save_crtc2_gen_cntl | CRTC2_DISP_REQ_EN_B);\r\n}\r\nsave_crtc_gen_cntl = INREG(CRTC_GEN_CNTL);\r\nsave_crtc_ext_cntl = INREG(CRTC_EXT_CNTL);\r\nOUTREG(CRTC_EXT_CNTL, save_crtc_ext_cntl | CRTC_DISPLAY_DIS);\r\nOUTREG(CRTC_GEN_CNTL, save_crtc_gen_cntl | CRTC_DISP_REQ_EN_B);\r\nmdelay(100);\r\naper_base = INREG(CNFG_APER_0_BASE);\r\naper_size = INREG(CNFG_APER_SIZE);\r\n#ifdef SET_MC_FB_FROM_APERTURE\r\nOUTREG(MC_FB_LOCATION,\r\n((aper_base + aper_size - 1) & 0xffff0000) | (aper_base >> 16));\r\nrinfo->fb_local_base = aper_base;\r\n#else\r\nOUTREG(MC_FB_LOCATION, 0x7fff0000);\r\nrinfo->fb_local_base = 0;\r\n#endif\r\nagp_base = aper_base + aper_size;\r\nif (agp_base & 0xf0000000)\r\nagp_base = (aper_base | 0x0fffffff) + 1;\r\n#ifdef SET_MC_FB_FROM_APERTURE\r\nOUTREG(MC_AGP_LOCATION, 0xffff0000 | (agp_base >> 16));\r\n#else\r\nOUTREG(MC_AGP_LOCATION, 0xffffe000);\r\n#endif\r\n#ifdef SET_MC_FB_FROM_APERTURE\r\nOUTREG(DISPLAY_BASE_ADDR, aper_base);\r\nif (rinfo->has_CRTC2)\r\nOUTREG(CRTC2_DISPLAY_BASE_ADDR, aper_base);\r\nOUTREG(OV0_BASE_ADDR, aper_base);\r\n#else\r\nOUTREG(DISPLAY_BASE_ADDR, 0);\r\nif (rinfo->has_CRTC2)\r\nOUTREG(CRTC2_DISPLAY_BASE_ADDR, 0);\r\nOUTREG(OV0_BASE_ADDR, 0);\r\n#endif\r\nmdelay(100);\r\nOUTREG(CRTC_GEN_CNTL, save_crtc_gen_cntl);\r\nOUTREG(CRTC_EXT_CNTL, save_crtc_ext_cntl);\r\nif (rinfo->has_CRTC2)\r\nOUTREG(CRTC2_GEN_CNTL, save_crtc2_gen_cntl);\r\npr_debug("aper_base: %08x MC_FB_LOC to: %08x, MC_AGP_LOC to: %08x\n",\r\naper_base,\r\n((aper_base + aper_size - 1) & 0xffff0000) | (aper_base >> 16),\r\n0xffff0000 | (agp_base >> 16));\r\n}\r\nstatic void radeon_identify_vram(struct radeonfb_info *rinfo)\r\n{\r\nu32 tmp;\r\nif ((rinfo->family == CHIP_FAMILY_RS100) ||\r\n(rinfo->family == CHIP_FAMILY_RS200) ||\r\n(rinfo->family == CHIP_FAMILY_RS300) ||\r\n(rinfo->family == CHIP_FAMILY_RC410) ||\r\n(rinfo->family == CHIP_FAMILY_RS400) ||\r\n(rinfo->family == CHIP_FAMILY_RS480) ) {\r\nu32 tom = INREG(NB_TOM);\r\ntmp = ((((tom >> 16) - (tom & 0xffff) + 1) << 6) * 1024);\r\nradeon_fifo_wait(6);\r\nOUTREG(MC_FB_LOCATION, tom);\r\nOUTREG(DISPLAY_BASE_ADDR, (tom & 0xffff) << 16);\r\nOUTREG(CRTC2_DISPLAY_BASE_ADDR, (tom & 0xffff) << 16);\r\nOUTREG(OV0_BASE_ADDR, (tom & 0xffff) << 16);\r\nOUTREG(GRPH2_BUFFER_CNTL, INREG(GRPH2_BUFFER_CNTL) & ~0x7f0000);\r\nif ((rinfo->family == CHIP_FAMILY_RS100) ||\r\n(rinfo->family == CHIP_FAMILY_RS200)) {\r\nOUTREGP(CRTC_MORE_CNTL, CRTC_H_CUTOFF_ACTIVE_EN,\r\n~CRTC_H_CUTOFF_ACTIVE_EN);\r\n}\r\n} else {\r\ntmp = INREG(CNFG_MEMSIZE);\r\n}\r\nrinfo->video_ram = tmp & CNFG_MEMSIZE_MASK;\r\nif (rinfo->video_ram == 0) {\r\nswitch (rinfo->pdev->device) {\r\ncase PCI_CHIP_RADEON_LY:\r\ncase PCI_CHIP_RADEON_LZ:\r\nrinfo->video_ram = 8192 * 1024;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nif (rinfo->is_IGP || (rinfo->family >= CHIP_FAMILY_R300) ||\r\n(INREG(MEM_SDRAM_MODE_REG) & (1<<30)))\r\nrinfo->vram_ddr = 1;\r\nelse\r\nrinfo->vram_ddr = 0;\r\ntmp = INREG(MEM_CNTL);\r\nif (IS_R300_VARIANT(rinfo)) {\r\ntmp &= R300_MEM_NUM_CHANNELS_MASK;\r\nswitch (tmp) {\r\ncase 0: rinfo->vram_width = 64; break;\r\ncase 1: rinfo->vram_width = 128; break;\r\ncase 2: rinfo->vram_width = 256; break;\r\ndefault: rinfo->vram_width = 128; break;\r\n}\r\n} else if ((rinfo->family == CHIP_FAMILY_RV100) ||\r\n(rinfo->family == CHIP_FAMILY_RS100) ||\r\n(rinfo->family == CHIP_FAMILY_RS200)){\r\nif (tmp & RV100_MEM_HALF_MODE)\r\nrinfo->vram_width = 32;\r\nelse\r\nrinfo->vram_width = 64;\r\n} else {\r\nif (tmp & MEM_NUM_CHANNELS_MASK)\r\nrinfo->vram_width = 128;\r\nelse\r\nrinfo->vram_width = 64;\r\n}\r\npr_debug("radeonfb (%s): Found %ldk of %s %d bits wide videoram\n",\r\npci_name(rinfo->pdev),\r\nrinfo->video_ram / 1024,\r\nrinfo->vram_ddr ? "DDR" : "SDRAM",\r\nrinfo->vram_width);\r\n}\r\nstatic ssize_t radeon_show_one_edid(char *buf, loff_t off, size_t count, const u8 *edid)\r\n{\r\nreturn memory_read_from_buffer(buf, count, &off, edid, EDID_LENGTH);\r\n}\r\nstatic ssize_t radeon_show_edid1(struct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *bin_attr,\r\nchar *buf, loff_t off, size_t count)\r\n{\r\nstruct device *dev = container_of(kobj, struct device, kobj);\r\nstruct pci_dev *pdev = to_pci_dev(dev);\r\nstruct fb_info *info = pci_get_drvdata(pdev);\r\nstruct radeonfb_info *rinfo = info->par;\r\nreturn radeon_show_one_edid(buf, off, count, rinfo->mon1_EDID);\r\n}\r\nstatic ssize_t radeon_show_edid2(struct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *bin_attr,\r\nchar *buf, loff_t off, size_t count)\r\n{\r\nstruct device *dev = container_of(kobj, struct device, kobj);\r\nstruct pci_dev *pdev = to_pci_dev(dev);\r\nstruct fb_info *info = pci_get_drvdata(pdev);\r\nstruct radeonfb_info *rinfo = info->par;\r\nreturn radeon_show_one_edid(buf, off, count, rinfo->mon2_EDID);\r\n}\r\nstatic int radeonfb_pci_register(struct pci_dev *pdev,\r\nconst struct pci_device_id *ent)\r\n{\r\nstruct fb_info *info;\r\nstruct radeonfb_info *rinfo;\r\nint ret;\r\nunsigned char c1, c2;\r\nint err = 0;\r\npr_debug("radeonfb_pci_register BEGIN\n");\r\nret = pci_enable_device(pdev);\r\nif (ret < 0) {\r\nprintk(KERN_ERR "radeonfb (%s): Cannot enable PCI device\n",\r\npci_name(pdev));\r\ngoto err_out;\r\n}\r\ninfo = framebuffer_alloc(sizeof(struct radeonfb_info), &pdev->dev);\r\nif (!info) {\r\nprintk (KERN_ERR "radeonfb (%s): could not allocate memory\n",\r\npci_name(pdev));\r\nret = -ENOMEM;\r\ngoto err_disable;\r\n}\r\nrinfo = info->par;\r\nrinfo->info = info;\r\nrinfo->pdev = pdev;\r\nspin_lock_init(&rinfo->reg_lock);\r\ninit_timer(&rinfo->lvds_timer);\r\nrinfo->lvds_timer.function = radeon_lvds_timer_func;\r\nrinfo->lvds_timer.data = (unsigned long)rinfo;\r\nc1 = ent->device >> 8;\r\nc2 = ent->device & 0xff;\r\nif (isprint(c1) && isprint(c2))\r\nsnprintf(rinfo->name, sizeof(rinfo->name),\r\n"ATI Radeon %x \"%c%c\"", ent->device & 0xffff, c1, c2);\r\nelse\r\nsnprintf(rinfo->name, sizeof(rinfo->name),\r\n"ATI Radeon %x", ent->device & 0xffff);\r\nrinfo->family = ent->driver_data & CHIP_FAMILY_MASK;\r\nrinfo->chipset = pdev->device;\r\nrinfo->has_CRTC2 = (ent->driver_data & CHIP_HAS_CRTC2) != 0;\r\nrinfo->is_mobility = (ent->driver_data & CHIP_IS_MOBILITY) != 0;\r\nrinfo->is_IGP = (ent->driver_data & CHIP_IS_IGP) != 0;\r\nrinfo->fb_base_phys = pci_resource_start (pdev, 0);\r\nrinfo->mmio_base_phys = pci_resource_start (pdev, 2);\r\nret = pci_request_region(pdev, 0, "radeonfb framebuffer");\r\nif (ret < 0) {\r\nprintk( KERN_ERR "radeonfb (%s): cannot request region 0.\n",\r\npci_name(rinfo->pdev));\r\ngoto err_release_fb;\r\n}\r\nret = pci_request_region(pdev, 2, "radeonfb mmio");\r\nif (ret < 0) {\r\nprintk( KERN_ERR "radeonfb (%s): cannot request region 2.\n",\r\npci_name(rinfo->pdev));\r\ngoto err_release_pci0;\r\n}\r\nrinfo->mmio_base = ioremap(rinfo->mmio_base_phys, RADEON_REGSIZE);\r\nif (!rinfo->mmio_base) {\r\nprintk(KERN_ERR "radeonfb (%s): cannot map MMIO\n",\r\npci_name(rinfo->pdev));\r\nret = -EIO;\r\ngoto err_release_pci2;\r\n}\r\nrinfo->fb_local_base = INREG(MC_FB_LOCATION) << 16;\r\nrinfo->errata = 0;\r\nif (rinfo->family == CHIP_FAMILY_R300 &&\r\n(INREG(CNFG_CNTL) & CFG_ATI_REV_ID_MASK)\r\n== CFG_ATI_REV_A11)\r\nrinfo->errata |= CHIP_ERRATA_R300_CG;\r\nif (rinfo->family == CHIP_FAMILY_RV200 ||\r\nrinfo->family == CHIP_FAMILY_RS200)\r\nrinfo->errata |= CHIP_ERRATA_PLL_DUMMYREADS;\r\nif (rinfo->family == CHIP_FAMILY_RV100 ||\r\nrinfo->family == CHIP_FAMILY_RS100 ||\r\nrinfo->family == CHIP_FAMILY_RS200)\r\nrinfo->errata |= CHIP_ERRATA_PLL_DELAY;\r\n#if defined(CONFIG_PPC_OF) || defined(CONFIG_SPARC)\r\nrinfo->of_node = pci_device_to_OF_node(pdev);\r\nif (rinfo->of_node == NULL)\r\nprintk(KERN_WARNING "radeonfb (%s): Cannot match card to OF node !\n",\r\npci_name(rinfo->pdev));\r\n#endif\r\n#ifdef CONFIG_PPC_OF\r\nfixup_memory_mappings(rinfo);\r\n#endif\r\nradeon_identify_vram(rinfo);\r\nrinfo->mapped_vram = min_t(unsigned long, MAX_MAPPED_VRAM, rinfo->video_ram);\r\ndo {\r\nrinfo->fb_base = ioremap (rinfo->fb_base_phys,\r\nrinfo->mapped_vram);\r\n} while (rinfo->fb_base == NULL &&\r\n((rinfo->mapped_vram /= 2) >= MIN_MAPPED_VRAM));\r\nif (rinfo->fb_base == NULL) {\r\nprintk (KERN_ERR "radeonfb (%s): cannot map FB\n",\r\npci_name(rinfo->pdev));\r\nret = -EIO;\r\ngoto err_unmap_rom;\r\n}\r\npr_debug("radeonfb (%s): mapped %ldk videoram\n", pci_name(rinfo->pdev),\r\nrinfo->mapped_vram/1024);\r\nif (!rinfo->is_mobility)\r\nradeon_map_ROM(rinfo, pdev);\r\n#ifdef CONFIG_X86\r\nif (rinfo->bios_seg == NULL)\r\nradeon_find_mem_vbios(rinfo);\r\n#endif\r\nif (rinfo->bios_seg == NULL && rinfo->is_mobility)\r\nradeon_map_ROM(rinfo, pdev);\r\nradeon_get_pllinfo(rinfo);\r\n#ifdef CONFIG_FB_RADEON_I2C\r\nradeon_create_i2c_busses(rinfo);\r\n#endif\r\nradeon_set_fbinfo (rinfo);\r\nradeon_probe_screens(rinfo, monitor_layout, ignore_edid);\r\nradeon_check_modes(rinfo, mode_option);\r\nif (rinfo->mon1_EDID)\r\nerr |= sysfs_create_bin_file(&rinfo->pdev->dev.kobj,\r\n&edid1_attr);\r\nif (rinfo->mon2_EDID)\r\nerr |= sysfs_create_bin_file(&rinfo->pdev->dev.kobj,\r\n&edid2_attr);\r\nif (err)\r\npr_warning("%s() Creating sysfs files failed, continuing\n",\r\n__func__);\r\nradeon_save_state (rinfo, &rinfo->init_state);\r\nmemcpy(&rinfo->state, &rinfo->init_state, sizeof(struct radeon_regs));\r\nif (default_dynclk < -1) {\r\nradeonfb_pm_init(rinfo, rinfo->is_mobility ? 1 : -1, ignore_devlist, force_sleep);\r\n} else\r\nradeonfb_pm_init(rinfo, default_dynclk, ignore_devlist, force_sleep);\r\npci_set_drvdata(pdev, info);\r\nret = register_framebuffer(info);\r\nif (ret < 0) {\r\nprintk (KERN_ERR "radeonfb (%s): could not register framebuffer\n",\r\npci_name(rinfo->pdev));\r\ngoto err_unmap_fb;\r\n}\r\n#ifdef CONFIG_MTRR\r\nrinfo->mtrr_hdl = nomtrr ? -1 : mtrr_add(rinfo->fb_base_phys,\r\nrinfo->video_ram,\r\nMTRR_TYPE_WRCOMB, 1);\r\n#endif\r\nif (backlight)\r\nradeonfb_bl_init(rinfo);\r\nprintk ("radeonfb (%s): %s\n", pci_name(rinfo->pdev), rinfo->name);\r\nif (rinfo->bios_seg)\r\nradeon_unmap_ROM(rinfo, pdev);\r\npr_debug("radeonfb_pci_register END\n");\r\nreturn 0;\r\nerr_unmap_fb:\r\niounmap(rinfo->fb_base);\r\nerr_unmap_rom:\r\nkfree(rinfo->mon1_EDID);\r\nkfree(rinfo->mon2_EDID);\r\nif (rinfo->mon1_modedb)\r\nfb_destroy_modedb(rinfo->mon1_modedb);\r\nfb_dealloc_cmap(&info->cmap);\r\n#ifdef CONFIG_FB_RADEON_I2C\r\nradeon_delete_i2c_busses(rinfo);\r\n#endif\r\nif (rinfo->bios_seg)\r\nradeon_unmap_ROM(rinfo, pdev);\r\niounmap(rinfo->mmio_base);\r\nerr_release_pci2:\r\npci_release_region(pdev, 2);\r\nerr_release_pci0:\r\npci_release_region(pdev, 0);\r\nerr_release_fb:\r\nframebuffer_release(info);\r\nerr_disable:\r\nerr_out:\r\nreturn ret;\r\n}\r\nstatic void radeonfb_pci_unregister(struct pci_dev *pdev)\r\n{\r\nstruct fb_info *info = pci_get_drvdata(pdev);\r\nstruct radeonfb_info *rinfo = info->par;\r\nif (!rinfo)\r\nreturn;\r\nradeonfb_pm_exit(rinfo);\r\nif (rinfo->mon1_EDID)\r\nsysfs_remove_bin_file(&rinfo->pdev->dev.kobj, &edid1_attr);\r\nif (rinfo->mon2_EDID)\r\nsysfs_remove_bin_file(&rinfo->pdev->dev.kobj, &edid2_attr);\r\n#if 0\r\nradeon_write_mode (rinfo, &rinfo->init_state, 1);\r\n#endif\r\ndel_timer_sync(&rinfo->lvds_timer);\r\n#ifdef CONFIG_MTRR\r\nif (rinfo->mtrr_hdl >= 0)\r\nmtrr_del(rinfo->mtrr_hdl, 0, 0);\r\n#endif\r\nunregister_framebuffer(info);\r\nradeonfb_bl_exit(rinfo);\r\niounmap(rinfo->mmio_base);\r\niounmap(rinfo->fb_base);\r\npci_release_region(pdev, 2);\r\npci_release_region(pdev, 0);\r\nkfree(rinfo->mon1_EDID);\r\nkfree(rinfo->mon2_EDID);\r\nif (rinfo->mon1_modedb)\r\nfb_destroy_modedb(rinfo->mon1_modedb);\r\n#ifdef CONFIG_FB_RADEON_I2C\r\nradeon_delete_i2c_busses(rinfo);\r\n#endif\r\nfb_dealloc_cmap(&info->cmap);\r\nframebuffer_release(info);\r\n}\r\nstatic int __init radeonfb_setup (char *options)\r\n{\r\nchar *this_opt;\r\nif (!options || !*options)\r\nreturn 0;\r\nwhile ((this_opt = strsep (&options, ",")) != NULL) {\r\nif (!*this_opt)\r\ncontinue;\r\nif (!strncmp(this_opt, "noaccel", 7)) {\r\nnoaccel = 1;\r\n} else if (!strncmp(this_opt, "mirror", 6)) {\r\nmirror = 1;\r\n} else if (!strncmp(this_opt, "force_dfp", 9)) {\r\nforce_dfp = 1;\r\n} else if (!strncmp(this_opt, "panel_yres:", 11)) {\r\npanel_yres = simple_strtoul((this_opt+11), NULL, 0);\r\n} else if (!strncmp(this_opt, "backlight:", 10)) {\r\nbacklight = simple_strtoul(this_opt+10, NULL, 0);\r\n#ifdef CONFIG_MTRR\r\n} else if (!strncmp(this_opt, "nomtrr", 6)) {\r\nnomtrr = 1;\r\n#endif\r\n} else if (!strncmp(this_opt, "nomodeset", 9)) {\r\nnomodeset = 1;\r\n} else if (!strncmp(this_opt, "force_measure_pll", 17)) {\r\nforce_measure_pll = 1;\r\n} else if (!strncmp(this_opt, "ignore_edid", 11)) {\r\nignore_edid = 1;\r\n#if defined(CONFIG_PM) && defined(CONFIG_X86)\r\n} else if (!strncmp(this_opt, "force_sleep", 11)) {\r\nforce_sleep = 1;\r\n} else if (!strncmp(this_opt, "ignore_devlist", 14)) {\r\nignore_devlist = 1;\r\n#endif\r\n} else\r\nmode_option = this_opt;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init radeonfb_init (void)\r\n{\r\n#ifndef MODULE\r\nchar *option = NULL;\r\nif (fb_get_options("radeonfb", &option))\r\nreturn -ENODEV;\r\nradeonfb_setup(option);\r\n#endif\r\nreturn pci_register_driver (&radeonfb_driver);\r\n}\r\nstatic void __exit radeonfb_exit (void)\r\n{\r\npci_unregister_driver (&radeonfb_driver);\r\n}

static int tfp410_power_on(struct omap_dss_device *dssdev)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(&dssdev->dev);\r\nint r;\r\nif (dssdev->state == OMAP_DSS_DISPLAY_ACTIVE)\r\nreturn 0;\r\nomapdss_dpi_set_timings(dssdev, &dssdev->panel.timings);\r\nomapdss_dpi_set_data_lines(dssdev, dssdev->phy.dpi.data_lines);\r\nr = omapdss_dpi_display_enable(dssdev);\r\nif (r)\r\ngoto err0;\r\nif (gpio_is_valid(ddata->pd_gpio))\r\ngpio_set_value_cansleep(ddata->pd_gpio, 1);\r\nreturn 0;\r\nerr0:\r\nreturn r;\r\n}\r\nstatic void tfp410_power_off(struct omap_dss_device *dssdev)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(&dssdev->dev);\r\nif (dssdev->state != OMAP_DSS_DISPLAY_ACTIVE)\r\nreturn;\r\nif (gpio_is_valid(ddata->pd_gpio))\r\ngpio_set_value_cansleep(ddata->pd_gpio, 0);\r\nomapdss_dpi_display_disable(dssdev);\r\n}\r\nstatic int tfp410_probe(struct omap_dss_device *dssdev)\r\n{\r\nstruct panel_drv_data *ddata;\r\nint r;\r\nint i2c_bus_num;\r\nddata = devm_kzalloc(&dssdev->dev, sizeof(*ddata), GFP_KERNEL);\r\nif (!ddata)\r\nreturn -ENOMEM;\r\ndssdev->panel.timings = tfp410_default_timings;\r\nddata->dssdev = dssdev;\r\nmutex_init(&ddata->lock);\r\nif (dssdev->data) {\r\nstruct tfp410_platform_data *pdata = dssdev->data;\r\nddata->pd_gpio = pdata->power_down_gpio;\r\ni2c_bus_num = pdata->i2c_bus_num;\r\n} else {\r\nddata->pd_gpio = -1;\r\ni2c_bus_num = -1;\r\n}\r\nif (gpio_is_valid(ddata->pd_gpio)) {\r\nr = devm_gpio_request_one(&dssdev->dev, ddata->pd_gpio,\r\nGPIOF_OUT_INIT_LOW, "tfp410 pd");\r\nif (r) {\r\ndev_err(&dssdev->dev, "Failed to request PD GPIO %d\n",\r\nddata->pd_gpio);\r\nreturn r;\r\n}\r\n}\r\nif (i2c_bus_num != -1) {\r\nstruct i2c_adapter *adapter;\r\nadapter = i2c_get_adapter(i2c_bus_num);\r\nif (!adapter) {\r\ndev_err(&dssdev->dev, "Failed to get I2C adapter, bus %d\n",\r\ni2c_bus_num);\r\nreturn -EINVAL;\r\n}\r\nddata->i2c_adapter = adapter;\r\n}\r\ndev_set_drvdata(&dssdev->dev, ddata);\r\nreturn 0;\r\n}\r\nstatic void __exit tfp410_remove(struct omap_dss_device *dssdev)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(&dssdev->dev);\r\nmutex_lock(&ddata->lock);\r\nif (ddata->i2c_adapter)\r\ni2c_put_adapter(ddata->i2c_adapter);\r\ndev_set_drvdata(&dssdev->dev, NULL);\r\nmutex_unlock(&ddata->lock);\r\n}\r\nstatic int tfp410_enable(struct omap_dss_device *dssdev)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(&dssdev->dev);\r\nint r;\r\nmutex_lock(&ddata->lock);\r\nr = tfp410_power_on(dssdev);\r\nif (r == 0)\r\ndssdev->state = OMAP_DSS_DISPLAY_ACTIVE;\r\nmutex_unlock(&ddata->lock);\r\nreturn r;\r\n}\r\nstatic void tfp410_disable(struct omap_dss_device *dssdev)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(&dssdev->dev);\r\nmutex_lock(&ddata->lock);\r\ntfp410_power_off(dssdev);\r\ndssdev->state = OMAP_DSS_DISPLAY_DISABLED;\r\nmutex_unlock(&ddata->lock);\r\n}\r\nstatic void tfp410_set_timings(struct omap_dss_device *dssdev,\r\nstruct omap_video_timings *timings)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(&dssdev->dev);\r\nmutex_lock(&ddata->lock);\r\nomapdss_dpi_set_timings(dssdev, timings);\r\ndssdev->panel.timings = *timings;\r\nmutex_unlock(&ddata->lock);\r\n}\r\nstatic void tfp410_get_timings(struct omap_dss_device *dssdev,\r\nstruct omap_video_timings *timings)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(&dssdev->dev);\r\nmutex_lock(&ddata->lock);\r\n*timings = dssdev->panel.timings;\r\nmutex_unlock(&ddata->lock);\r\n}\r\nstatic int tfp410_check_timings(struct omap_dss_device *dssdev,\r\nstruct omap_video_timings *timings)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(&dssdev->dev);\r\nint r;\r\nmutex_lock(&ddata->lock);\r\nr = dpi_check_timings(dssdev, timings);\r\nmutex_unlock(&ddata->lock);\r\nreturn r;\r\n}\r\nstatic int tfp410_ddc_read(struct i2c_adapter *adapter,\r\nunsigned char *buf, u16 count, u8 offset)\r\n{\r\nint r, retries;\r\nfor (retries = 3; retries > 0; retries--) {\r\nstruct i2c_msg msgs[] = {\r\n{\r\n.addr = DDC_ADDR,\r\n.flags = 0,\r\n.len = 1,\r\n.buf = &offset,\r\n}, {\r\n.addr = DDC_ADDR,\r\n.flags = I2C_M_RD,\r\n.len = count,\r\n.buf = buf,\r\n}\r\n};\r\nr = i2c_transfer(adapter, msgs, 2);\r\nif (r == 2)\r\nreturn 0;\r\nif (r != -EAGAIN)\r\nbreak;\r\n}\r\nreturn r < 0 ? r : -EIO;\r\n}\r\nstatic int tfp410_read_edid(struct omap_dss_device *dssdev,\r\nu8 *edid, int len)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(&dssdev->dev);\r\nint r, l, bytes_read;\r\nmutex_lock(&ddata->lock);\r\nif (!ddata->i2c_adapter) {\r\nr = -ENODEV;\r\ngoto err;\r\n}\r\nl = min(EDID_LENGTH, len);\r\nr = tfp410_ddc_read(ddata->i2c_adapter, edid, l, 0);\r\nif (r)\r\ngoto err;\r\nbytes_read = l;\r\nif (len > EDID_LENGTH && edid[0x7e] > 0) {\r\nl = min(EDID_LENGTH, len - EDID_LENGTH);\r\nr = tfp410_ddc_read(ddata->i2c_adapter, edid + EDID_LENGTH,\r\nl, EDID_LENGTH);\r\nif (r)\r\ngoto err;\r\nbytes_read += l;\r\n}\r\nmutex_unlock(&ddata->lock);\r\nreturn bytes_read;\r\nerr:\r\nmutex_unlock(&ddata->lock);\r\nreturn r;\r\n}\r\nstatic bool tfp410_detect(struct omap_dss_device *dssdev)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(&dssdev->dev);\r\nunsigned char out;\r\nint r;\r\nmutex_lock(&ddata->lock);\r\nif (!ddata->i2c_adapter)\r\ngoto out;\r\nr = tfp410_ddc_read(ddata->i2c_adapter, &out, 1, 0);\r\nmutex_unlock(&ddata->lock);\r\nreturn r == 0;\r\nout:\r\nmutex_unlock(&ddata->lock);\r\nreturn true;\r\n}\r\nstatic int __init tfp410_init(void)\r\n{\r\nreturn omap_dss_register_driver(&tfp410_driver);\r\n}\r\nstatic void __exit tfp410_exit(void)\r\n{\r\nomap_dss_unregister_driver(&tfp410_driver);\r\n}

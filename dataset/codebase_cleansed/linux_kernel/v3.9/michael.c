static void s_vClear(void)\r\n{\r\nL = K0;\r\nR = K1;\r\nnBytesInM = 0;\r\nM = 0;\r\n}\r\nstatic void s_vSetKey(DWORD dwK0, DWORD dwK1)\r\n{\r\nK0 = dwK0;\r\nK1 = dwK1;\r\ns_vClear();\r\n}\r\nstatic void s_vAppendByte(BYTE b)\r\n{\r\nM |= b << (8*nBytesInM);\r\nnBytesInM++;\r\nif (nBytesInM >= 4) {\r\nL ^= M;\r\nR ^= ROL32(L, 17);\r\nL += R;\r\nR ^= ((L & 0xff00ff00) >> 8) | ((L & 0x00ff00ff) << 8);\r\nL += R;\r\nR ^= ROL32(L, 3);\r\nL += R;\r\nR ^= ROR32(L, 2);\r\nL += R;\r\nM = 0;\r\nnBytesInM = 0;\r\n}\r\n}\r\nvoid MIC_vInit(DWORD dwK0, DWORD dwK1)\r\n{\r\ns_vSetKey(dwK0, dwK1);\r\n}\r\nvoid MIC_vUnInit(void)\r\n{\r\nK0 = 0;\r\nK1 = 0;\r\ns_vClear();\r\n}\r\nvoid MIC_vAppend(PBYTE src, unsigned int nBytes)\r\n{\r\nwhile (nBytes > 0) {\r\ns_vAppendByte(*src++);\r\nnBytes--;\r\n}\r\n}\r\nvoid MIC_vGetMIC(PDWORD pdwL, PDWORD pdwR)\r\n{\r\ns_vAppendByte(0x5a);\r\ns_vAppendByte(0);\r\ns_vAppendByte(0);\r\ns_vAppendByte(0);\r\ns_vAppendByte(0);\r\nwhile (nBytesInM != 0)\r\ns_vAppendByte(0);\r\n*pdwL = L;\r\n*pdwR = R;\r\ns_vClear();\r\n}

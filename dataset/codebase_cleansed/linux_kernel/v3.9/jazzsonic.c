static int jazzsonic_open(struct net_device* dev)\r\n{\r\nint retval;\r\nretval = request_irq(dev->irq, sonic_interrupt, IRQF_DISABLED,\r\n"sonic", dev);\r\nif (retval) {\r\nprintk(KERN_ERR "%s: unable to get IRQ %d.\n",\r\ndev->name, dev->irq);\r\nreturn retval;\r\n}\r\nretval = sonic_open(dev);\r\nif (retval)\r\nfree_irq(dev->irq, dev);\r\nreturn retval;\r\n}\r\nstatic int jazzsonic_close(struct net_device* dev)\r\n{\r\nint err;\r\nerr = sonic_close(dev);\r\nfree_irq(dev->irq, dev);\r\nreturn err;\r\n}\r\nstatic int sonic_probe1(struct net_device *dev)\r\n{\r\nstatic unsigned version_printed;\r\nunsigned int silicon_revision;\r\nunsigned int val;\r\nstruct sonic_local *lp = netdev_priv(dev);\r\nint err = -ENODEV;\r\nint i;\r\nif (!request_mem_region(dev->base_addr, SONIC_MEM_SIZE, jazz_sonic_string))\r\nreturn -EBUSY;\r\nsilicon_revision = SONIC_READ(SONIC_SR);\r\nif (sonic_debug > 1)\r\nprintk("SONIC Silicon Revision = 0x%04x\n",silicon_revision);\r\ni = 0;\r\nwhile (known_revisions[i] != 0xffff &&\r\nknown_revisions[i] != silicon_revision)\r\ni++;\r\nif (known_revisions[i] == 0xffff) {\r\nprintk("SONIC ethernet controller not found (0x%4x)\n",\r\nsilicon_revision);\r\ngoto out;\r\n}\r\nif (sonic_debug && version_printed++ == 0)\r\nprintk(version);\r\nprintk(KERN_INFO "%s: Sonic ethernet found at 0x%08lx, ",\r\ndev_name(lp->device), dev->base_addr);\r\nSONIC_WRITE(SONIC_CMD,SONIC_CR_RST);\r\nSONIC_WRITE(SONIC_CEP,0);\r\nfor (i=0; i<3; i++) {\r\nval = SONIC_READ(SONIC_CAP0-i);\r\ndev->dev_addr[i*2] = val;\r\ndev->dev_addr[i*2+1] = val >> 8;\r\n}\r\nerr = -ENOMEM;\r\nlp->dma_bitmode = SONIC_BITMODE32;\r\nif ((lp->descriptors = dma_alloc_coherent(lp->device,\r\nSIZEOF_SONIC_DESC * SONIC_BUS_SCALE(lp->dma_bitmode),\r\n&lp->descriptors_laddr, GFP_KERNEL)) == NULL) {\r\nprintk(KERN_ERR "%s: couldn't alloc DMA memory for descriptors.\n",\r\ndev_name(lp->device));\r\ngoto out;\r\n}\r\nlp->cda = lp->descriptors;\r\nlp->tda = lp->cda + (SIZEOF_SONIC_CDA\r\n* SONIC_BUS_SCALE(lp->dma_bitmode));\r\nlp->rda = lp->tda + (SIZEOF_SONIC_TD * SONIC_NUM_TDS\r\n* SONIC_BUS_SCALE(lp->dma_bitmode));\r\nlp->rra = lp->rda + (SIZEOF_SONIC_RD * SONIC_NUM_RDS\r\n* SONIC_BUS_SCALE(lp->dma_bitmode));\r\nlp->cda_laddr = lp->descriptors_laddr;\r\nlp->tda_laddr = lp->cda_laddr + (SIZEOF_SONIC_CDA\r\n* SONIC_BUS_SCALE(lp->dma_bitmode));\r\nlp->rda_laddr = lp->tda_laddr + (SIZEOF_SONIC_TD * SONIC_NUM_TDS\r\n* SONIC_BUS_SCALE(lp->dma_bitmode));\r\nlp->rra_laddr = lp->rda_laddr + (SIZEOF_SONIC_RD * SONIC_NUM_RDS\r\n* SONIC_BUS_SCALE(lp->dma_bitmode));\r\ndev->netdev_ops = &sonic_netdev_ops;\r\ndev->watchdog_timeo = TX_TIMEOUT;\r\nSONIC_WRITE(SONIC_CRCT,0xffff);\r\nSONIC_WRITE(SONIC_FAET,0xffff);\r\nSONIC_WRITE(SONIC_MPT,0xffff);\r\nreturn 0;\r\nout:\r\nrelease_mem_region(dev->base_addr, SONIC_MEM_SIZE);\r\nreturn err;\r\n}\r\nstatic int jazz_sonic_probe(struct platform_device *pdev)\r\n{\r\nstruct net_device *dev;\r\nstruct sonic_local *lp;\r\nstruct resource *res;\r\nint err = 0;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENODEV;\r\ndev = alloc_etherdev(sizeof(struct sonic_local));\r\nif (!dev)\r\nreturn -ENOMEM;\r\nlp = netdev_priv(dev);\r\nlp->device = &pdev->dev;\r\nSET_NETDEV_DEV(dev, &pdev->dev);\r\nplatform_set_drvdata(pdev, dev);\r\nnetdev_boot_setup_check(dev);\r\ndev->base_addr = res->start;\r\ndev->irq = platform_get_irq(pdev, 0);\r\nerr = sonic_probe1(dev);\r\nif (err)\r\ngoto out;\r\nerr = register_netdev(dev);\r\nif (err)\r\ngoto out1;\r\nprintk("%s: MAC %pM IRQ %d\n", dev->name, dev->dev_addr, dev->irq);\r\nreturn 0;\r\nout1:\r\nrelease_mem_region(dev->base_addr, SONIC_MEM_SIZE);\r\nout:\r\nfree_netdev(dev);\r\nreturn err;\r\n}\r\nstatic int jazz_sonic_device_remove(struct platform_device *pdev)\r\n{\r\nstruct net_device *dev = platform_get_drvdata(pdev);\r\nstruct sonic_local* lp = netdev_priv(dev);\r\nunregister_netdev(dev);\r\ndma_free_coherent(lp->device, SIZEOF_SONIC_DESC * SONIC_BUS_SCALE(lp->dma_bitmode),\r\nlp->descriptors, lp->descriptors_laddr);\r\nrelease_mem_region(dev->base_addr, SONIC_MEM_SIZE);\r\nfree_netdev(dev);\r\nreturn 0;\r\n}

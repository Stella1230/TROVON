static int adis16060_spi_write(struct iio_dev *indio_dev, u8 val)\r\n{\r\nint ret;\r\nstruct adis16060_state *st = iio_priv(indio_dev);\r\nmutex_lock(&st->buf_lock);\r\nst->buf[2] = val;\r\nret = spi_write(st->us_w, st->buf, 3);\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic int adis16060_spi_read(struct iio_dev *indio_dev, u16 *val)\r\n{\r\nint ret;\r\nstruct adis16060_state *st = iio_priv(indio_dev);\r\nmutex_lock(&st->buf_lock);\r\nret = spi_read(st->us_r, st->buf, 3);\r\nif (ret == 0)\r\n*val = ((st->buf[0] & 0x3) << 12) |\r\n(st->buf[1] << 4) |\r\n((st->buf[2] >> 4) & 0xF);\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic int adis16060_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint *val, int *val2,\r\nlong mask)\r\n{\r\nu16 tval = 0;\r\nint ret;\r\nswitch (mask) {\r\ncase IIO_CHAN_INFO_RAW:\r\nmutex_lock(&indio_dev->mlock);\r\nret = adis16060_spi_write(indio_dev, chan->address);\r\nif (ret < 0) {\r\nmutex_unlock(&indio_dev->mlock);\r\nreturn ret;\r\n}\r\nret = adis16060_spi_read(indio_dev, &tval);\r\nmutex_unlock(&indio_dev->mlock);\r\n*val = tval;\r\nreturn IIO_VAL_INT;\r\ncase IIO_CHAN_INFO_OFFSET:\r\n*val = -7;\r\n*val2 = 461117;\r\nreturn IIO_VAL_INT_PLUS_MICRO;\r\ncase IIO_CHAN_INFO_SCALE:\r\n*val = 0;\r\n*val2 = 34000;\r\nreturn IIO_VAL_INT_PLUS_MICRO;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int adis16060_r_probe(struct spi_device *spi)\r\n{\r\nint ret;\r\nstruct adis16060_state *st;\r\nstruct iio_dev *indio_dev;\r\nindio_dev = iio_device_alloc(sizeof(*st));\r\nif (indio_dev == NULL) {\r\nret = -ENOMEM;\r\ngoto error_ret;\r\n}\r\nspi_set_drvdata(spi, indio_dev);\r\nst = iio_priv(indio_dev);\r\nst->us_r = spi;\r\nmutex_init(&st->buf_lock);\r\nindio_dev->name = spi->dev.driver->name;\r\nindio_dev->dev.parent = &spi->dev;\r\nindio_dev->info = &adis16060_info;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nindio_dev->channels = adis16060_channels;\r\nindio_dev->num_channels = ARRAY_SIZE(adis16060_channels);\r\nret = iio_device_register(indio_dev);\r\nif (ret)\r\ngoto error_free_dev;\r\nadis16060_iio_dev = indio_dev;\r\nreturn 0;\r\nerror_free_dev:\r\niio_device_free(indio_dev);\r\nerror_ret:\r\nreturn ret;\r\n}\r\nstatic int adis16060_r_remove(struct spi_device *spi)\r\n{\r\niio_device_unregister(spi_get_drvdata(spi));\r\niio_device_free(spi_get_drvdata(spi));\r\nreturn 0;\r\n}\r\nstatic int adis16060_w_probe(struct spi_device *spi)\r\n{\r\nint ret;\r\nstruct iio_dev *indio_dev = adis16060_iio_dev;\r\nstruct adis16060_state *st;\r\nif (!indio_dev) {\r\nret = -ENODEV;\r\ngoto error_ret;\r\n}\r\nst = iio_priv(indio_dev);\r\nspi_set_drvdata(spi, indio_dev);\r\nst->us_w = spi;\r\nreturn 0;\r\nerror_ret:\r\nreturn ret;\r\n}\r\nstatic int adis16060_w_remove(struct spi_device *spi)\r\n{\r\nreturn 0;\r\n}\r\nstatic __init int adis16060_init(void)\r\n{\r\nint ret;\r\nret = spi_register_driver(&adis16060_r_driver);\r\nif (ret < 0)\r\nreturn ret;\r\nret = spi_register_driver(&adis16060_w_driver);\r\nif (ret < 0) {\r\nspi_unregister_driver(&adis16060_r_driver);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic __exit void adis16060_exit(void)\r\n{\r\nspi_unregister_driver(&adis16060_w_driver);\r\nspi_unregister_driver(&adis16060_r_driver);\r\n}

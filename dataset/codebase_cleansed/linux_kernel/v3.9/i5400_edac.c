static inline int to_nf_mask(unsigned int mask)\r\n{\r\nreturn (mask & EMASK_M29) | (mask >> 3);\r\n}\r\nstatic inline int from_nf_ferr(unsigned int mask)\r\n{\r\nreturn (mask & EMASK_M29) |\r\n(mask & ((1 << 28) - 1) << 3);\r\n}\r\nstatic inline int extract_fbdchan_indx(u32 x)\r\n{\r\nreturn (x>>28) & 0x3;\r\n}\r\nstatic inline int nrec_bank(struct i5400_error_info *info)\r\n{\r\nreturn ((info->nrecmema) >> 12) & 0x7;\r\n}\r\nstatic inline int nrec_rank(struct i5400_error_info *info)\r\n{\r\nreturn ((info->nrecmema) >> 8) & 0xf;\r\n}\r\nstatic inline int nrec_buf_id(struct i5400_error_info *info)\r\n{\r\nreturn ((info->nrecmema)) & 0xff;\r\n}\r\nstatic inline int nrec_rdwr(struct i5400_error_info *info)\r\n{\r\nreturn (info->nrecmemb) >> 31;\r\n}\r\nstatic inline const char *rdwr_str(int rdwr)\r\n{\r\nreturn rdwr ? "Write" : "Read";\r\n}\r\nstatic inline int nrec_cas(struct i5400_error_info *info)\r\n{\r\nreturn ((info->nrecmemb) >> 16) & 0x1fff;\r\n}\r\nstatic inline int nrec_ras(struct i5400_error_info *info)\r\n{\r\nreturn (info->nrecmemb) & 0xffff;\r\n}\r\nstatic inline int rec_bank(struct i5400_error_info *info)\r\n{\r\nreturn ((info->recmema) >> 12) & 0x7;\r\n}\r\nstatic inline int rec_rank(struct i5400_error_info *info)\r\n{\r\nreturn ((info->recmema) >> 8) & 0xf;\r\n}\r\nstatic inline int rec_rdwr(struct i5400_error_info *info)\r\n{\r\nreturn (info->recmemb) >> 31;\r\n}\r\nstatic inline int rec_cas(struct i5400_error_info *info)\r\n{\r\nreturn ((info->recmemb) >> 16) & 0x1fff;\r\n}\r\nstatic inline int rec_ras(struct i5400_error_info *info)\r\n{\r\nreturn (info->recmemb) & 0xffff;\r\n}\r\nstatic void i5400_get_error_info(struct mem_ctl_info *mci,\r\nstruct i5400_error_info *info)\r\n{\r\nstruct i5400_pvt *pvt;\r\nu32 value;\r\npvt = mci->pvt_info;\r\npci_read_config_dword(pvt->branchmap_werrors, FERR_FAT_FBD, &value);\r\nvalue &= (FERR_FAT_FBDCHAN | FERR_FAT_MASK);\r\nif (value & FERR_FAT_MASK) {\r\ninfo->ferr_fat_fbd = value;\r\npci_read_config_dword(pvt->branchmap_werrors,\r\nNERR_FAT_FBD, &info->nerr_fat_fbd);\r\npci_read_config_word(pvt->branchmap_werrors,\r\nNRECMEMA, &info->nrecmema);\r\npci_read_config_word(pvt->branchmap_werrors,\r\nNRECMEMB, &info->nrecmemb);\r\npci_write_config_dword(pvt->branchmap_werrors,\r\nFERR_FAT_FBD, value);\r\n} else {\r\ninfo->ferr_fat_fbd = 0;\r\ninfo->nerr_fat_fbd = 0;\r\ninfo->nrecmema = 0;\r\ninfo->nrecmemb = 0;\r\n}\r\npci_read_config_dword(pvt->branchmap_werrors, FERR_NF_FBD, &value);\r\nif (value & FERR_NF_MASK) {\r\ninfo->ferr_nf_fbd = value;\r\npci_read_config_dword(pvt->branchmap_werrors,\r\nNERR_NF_FBD, &info->nerr_nf_fbd);\r\npci_read_config_word(pvt->branchmap_werrors,\r\nRECMEMA, &info->recmema);\r\npci_read_config_dword(pvt->branchmap_werrors,\r\nRECMEMB, &info->recmemb);\r\npci_read_config_dword(pvt->branchmap_werrors,\r\nREDMEMB, &info->redmemb);\r\npci_write_config_dword(pvt->branchmap_werrors,\r\nFERR_NF_FBD, value);\r\n} else {\r\ninfo->ferr_nf_fbd = 0;\r\ninfo->nerr_nf_fbd = 0;\r\ninfo->recmema = 0;\r\ninfo->recmemb = 0;\r\ninfo->redmemb = 0;\r\n}\r\n}\r\nstatic void i5400_proccess_non_recoverable_info(struct mem_ctl_info *mci,\r\nstruct i5400_error_info *info,\r\nunsigned long allErrors)\r\n{\r\nchar msg[EDAC_MC_LABEL_LEN + 1 + 90 + 80];\r\nint branch;\r\nint channel;\r\nint bank;\r\nint buf_id;\r\nint rank;\r\nint rdwr;\r\nint ras, cas;\r\nint errnum;\r\nchar *type = NULL;\r\nenum hw_event_mc_err_type tp_event = HW_EVENT_ERR_UNCORRECTED;\r\nif (!allErrors)\r\nreturn;\r\nif (allErrors & ERROR_FAT_MASK) {\r\ntype = "FATAL";\r\ntp_event = HW_EVENT_ERR_FATAL;\r\n} else if (allErrors & FERR_NF_UNCORRECTABLE)\r\ntype = "NON-FATAL uncorrected";\r\nelse\r\ntype = "NON-FATAL recoverable";\r\nbranch = extract_fbdchan_indx(info->ferr_fat_fbd);\r\nchannel = branch;\r\nbank = nrec_bank(info);\r\nrank = nrec_rank(info);\r\nbuf_id = nrec_buf_id(info);\r\nrdwr = nrec_rdwr(info);\r\nras = nrec_ras(info);\r\ncas = nrec_cas(info);\r\nedac_dbg(0, "\t\tDIMM= %d Channels= %d,%d (Branch= %d DRAM Bank= %d Buffer ID = %d rdwr= %s ras= %d cas= %d)\n",\r\nrank, channel, channel + 1, branch >> 1, bank,\r\nbuf_id, rdwr_str(rdwr), ras, cas);\r\nerrnum = find_first_bit(&allErrors, ARRAY_SIZE(error_name));\r\nsnprintf(msg, sizeof(msg),\r\n"Bank=%d Buffer ID = %d RAS=%d CAS=%d Err=0x%lx (%s)",\r\nbank, buf_id, ras, cas, allErrors, error_name[errnum]);\r\nedac_mc_handle_error(tp_event, mci, 1, 0, 0, 0,\r\nbranch >> 1, -1, rank,\r\nrdwr ? "Write error" : "Read error",\r\nmsg);\r\n}\r\nstatic void i5400_process_nonfatal_error_info(struct mem_ctl_info *mci,\r\nstruct i5400_error_info *info)\r\n{\r\nchar msg[EDAC_MC_LABEL_LEN + 1 + 90 + 80];\r\nunsigned long allErrors;\r\nint branch;\r\nint channel;\r\nint bank;\r\nint rank;\r\nint rdwr;\r\nint ras, cas;\r\nint errnum;\r\nallErrors = from_nf_ferr(info->ferr_nf_fbd & FERR_NF_MASK);\r\nif (!allErrors)\r\nreturn;\r\nif (allErrors & (ERROR_NF_UNCORRECTABLE | ERROR_NF_RECOVERABLE)) {\r\ni5400_proccess_non_recoverable_info(mci, info, allErrors);\r\nreturn;\r\n}\r\nif (allErrors & ERROR_NF_CORRECTABLE) {\r\nedac_dbg(0, "\tCorrected bits= 0x%lx\n", allErrors);\r\nbranch = extract_fbdchan_indx(info->ferr_nf_fbd);\r\nchannel = 0;\r\nif (REC_ECC_LOCATOR_ODD(info->redmemb))\r\nchannel = 1;\r\nchannel += branch;\r\nbank = rec_bank(info);\r\nrank = rec_rank(info);\r\nrdwr = rec_rdwr(info);\r\nras = rec_ras(info);\r\ncas = rec_cas(info);\r\nerrnum = find_first_bit(&allErrors, ARRAY_SIZE(error_name));\r\nedac_dbg(0, "\t\tDIMM= %d Channel= %d (Branch %d DRAM Bank= %d rdwr= %s ras= %d cas= %d)\n",\r\nrank, channel, branch >> 1, bank,\r\nrdwr_str(rdwr), ras, cas);\r\nsnprintf(msg, sizeof(msg),\r\n"Corrected error (Branch=%d DRAM-Bank=%d RDWR=%s "\r\n"RAS=%d CAS=%d, CE Err=0x%lx (%s))",\r\nbranch >> 1, bank, rdwr_str(rdwr), ras, cas,\r\nallErrors, error_name[errnum]);\r\nedac_mc_handle_error(HW_EVENT_ERR_CORRECTED, mci, 1, 0, 0, 0,\r\nbranch >> 1, channel % 2, rank,\r\nrdwr ? "Write error" : "Read error",\r\nmsg);\r\nreturn;\r\n}\r\nerrnum = find_first_bit(&allErrors, ARRAY_SIZE(error_name));\r\nbranch = extract_fbdchan_indx(info->ferr_nf_fbd);\r\ni5400_mc_printk(mci, KERN_EMERG,\r\n"Non-Fatal misc error (Branch=%d Err=%#lx (%s))",\r\nbranch >> 1, allErrors, error_name[errnum]);\r\n}\r\nstatic void i5400_process_error_info(struct mem_ctl_info *mci,\r\nstruct i5400_error_info *info)\r\n{ u32 allErrors;\r\nallErrors = (info->ferr_fat_fbd & FERR_FAT_MASK);\r\ni5400_proccess_non_recoverable_info(mci, info, allErrors);\r\ni5400_process_nonfatal_error_info(mci, info);\r\n}\r\nstatic void i5400_clear_error(struct mem_ctl_info *mci)\r\n{\r\nstruct i5400_error_info info;\r\ni5400_get_error_info(mci, &info);\r\n}\r\nstatic void i5400_check_error(struct mem_ctl_info *mci)\r\n{\r\nstruct i5400_error_info info;\r\nedac_dbg(4, "MC%d\n", mci->mc_idx);\r\ni5400_get_error_info(mci, &info);\r\ni5400_process_error_info(mci, &info);\r\n}\r\nstatic void i5400_put_devices(struct mem_ctl_info *mci)\r\n{\r\nstruct i5400_pvt *pvt;\r\npvt = mci->pvt_info;\r\npci_dev_put(pvt->branch_1);\r\npci_dev_put(pvt->branch_0);\r\npci_dev_put(pvt->fsb_error_regs);\r\npci_dev_put(pvt->branchmap_werrors);\r\n}\r\nstatic int i5400_get_devices(struct mem_ctl_info *mci, int dev_idx)\r\n{\r\nstruct i5400_pvt *pvt;\r\nstruct pci_dev *pdev;\r\npvt = mci->pvt_info;\r\npvt->branchmap_werrors = NULL;\r\npvt->fsb_error_regs = NULL;\r\npvt->branch_0 = NULL;\r\npvt->branch_1 = NULL;\r\npdev = NULL;\r\nwhile (1) {\r\npdev = pci_get_device(PCI_VENDOR_ID_INTEL,\r\nPCI_DEVICE_ID_INTEL_5400_ERR, pdev);\r\nif (!pdev) {\r\ni5400_printk(KERN_ERR,\r\n"'system address,Process Bus' "\r\n"device not found:"\r\n"vendor 0x%x device 0x%x ERR func 1 "\r\n"(broken BIOS?)\n",\r\nPCI_VENDOR_ID_INTEL,\r\nPCI_DEVICE_ID_INTEL_5400_ERR);\r\nreturn -ENODEV;\r\n}\r\nif (PCI_FUNC(pdev->devfn) == 1)\r\nbreak;\r\n}\r\npvt->branchmap_werrors = pdev;\r\npdev = NULL;\r\nwhile (1) {\r\npdev = pci_get_device(PCI_VENDOR_ID_INTEL,\r\nPCI_DEVICE_ID_INTEL_5400_ERR, pdev);\r\nif (!pdev) {\r\ni5400_printk(KERN_ERR,\r\n"'system address,Process Bus' "\r\n"device not found:"\r\n"vendor 0x%x device 0x%x ERR func 2 "\r\n"(broken BIOS?)\n",\r\nPCI_VENDOR_ID_INTEL,\r\nPCI_DEVICE_ID_INTEL_5400_ERR);\r\npci_dev_put(pvt->branchmap_werrors);\r\nreturn -ENODEV;\r\n}\r\nif (PCI_FUNC(pdev->devfn) == 2)\r\nbreak;\r\n}\r\npvt->fsb_error_regs = pdev;\r\nedac_dbg(1, "System Address, processor bus- PCI Bus ID: %s %x:%x\n",\r\npci_name(pvt->system_address),\r\npvt->system_address->vendor, pvt->system_address->device);\r\nedac_dbg(1, "Branchmap, control and errors - PCI Bus ID: %s %x:%x\n",\r\npci_name(pvt->branchmap_werrors),\r\npvt->branchmap_werrors->vendor,\r\npvt->branchmap_werrors->device);\r\nedac_dbg(1, "FSB Error Regs - PCI Bus ID: %s %x:%x\n",\r\npci_name(pvt->fsb_error_regs),\r\npvt->fsb_error_regs->vendor, pvt->fsb_error_regs->device);\r\npvt->branch_0 = pci_get_device(PCI_VENDOR_ID_INTEL,\r\nPCI_DEVICE_ID_INTEL_5400_FBD0, NULL);\r\nif (!pvt->branch_0) {\r\ni5400_printk(KERN_ERR,\r\n"MC: 'BRANCH 0' device not found:"\r\n"vendor 0x%x device 0x%x Func 0 (broken BIOS?)\n",\r\nPCI_VENDOR_ID_INTEL, PCI_DEVICE_ID_INTEL_5400_FBD0);\r\npci_dev_put(pvt->fsb_error_regs);\r\npci_dev_put(pvt->branchmap_werrors);\r\nreturn -ENODEV;\r\n}\r\nif (pvt->maxch < CHANNELS_PER_BRANCH)\r\nreturn 0;\r\npvt->branch_1 = pci_get_device(PCI_VENDOR_ID_INTEL,\r\nPCI_DEVICE_ID_INTEL_5400_FBD1, NULL);\r\nif (!pvt->branch_1) {\r\ni5400_printk(KERN_ERR,\r\n"MC: 'BRANCH 1' device not found:"\r\n"vendor 0x%x device 0x%x Func 0 "\r\n"(broken BIOS?)\n",\r\nPCI_VENDOR_ID_INTEL,\r\nPCI_DEVICE_ID_INTEL_5400_FBD1);\r\npci_dev_put(pvt->branch_0);\r\npci_dev_put(pvt->fsb_error_regs);\r\npci_dev_put(pvt->branchmap_werrors);\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic int determine_amb_present_reg(struct i5400_pvt *pvt, int channel)\r\n{\r\nint amb_present;\r\nif (channel < CHANNELS_PER_BRANCH) {\r\nif (channel & 0x1)\r\namb_present = pvt->b0_ambpresent1;\r\nelse\r\namb_present = pvt->b0_ambpresent0;\r\n} else {\r\nif (channel & 0x1)\r\namb_present = pvt->b1_ambpresent1;\r\nelse\r\namb_present = pvt->b1_ambpresent0;\r\n}\r\nreturn amb_present;\r\n}\r\nstatic int determine_mtr(struct i5400_pvt *pvt, int dimm, int channel)\r\n{\r\nint mtr;\r\nint n;\r\nn = dimm;\r\nif (n >= DIMMS_PER_CHANNEL) {\r\nedac_dbg(0, "ERROR: trying to access an invalid dimm: %d\n",\r\ndimm);\r\nreturn 0;\r\n}\r\nif (channel < CHANNELS_PER_BRANCH)\r\nmtr = pvt->b0_mtr[n];\r\nelse\r\nmtr = pvt->b1_mtr[n];\r\nreturn mtr;\r\n}\r\nstatic void decode_mtr(int slot_row, u16 mtr)\r\n{\r\nint ans;\r\nans = MTR_DIMMS_PRESENT(mtr);\r\nedac_dbg(2, "\tMTR%d=0x%x: DIMMs are %sPresent\n",\r\nslot_row, mtr, ans ? "" : "NOT ");\r\nif (!ans)\r\nreturn;\r\nedac_dbg(2, "\t\tWIDTH: x%d\n", MTR_DRAM_WIDTH(mtr));\r\nedac_dbg(2, "\t\tELECTRICAL THROTTLING is %s\n",\r\nMTR_DIMMS_ETHROTTLE(mtr) ? "enabled" : "disabled");\r\nedac_dbg(2, "\t\tNUMBANK: %d bank(s)\n", MTR_DRAM_BANKS(mtr));\r\nedac_dbg(2, "\t\tNUMRANK: %s\n",\r\nMTR_DIMM_RANK(mtr) ? "double" : "single");\r\nedac_dbg(2, "\t\tNUMROW: %s\n",\r\nMTR_DIMM_ROWS(mtr) == 0 ? "8,192 - 13 rows" :\r\nMTR_DIMM_ROWS(mtr) == 1 ? "16,384 - 14 rows" :\r\nMTR_DIMM_ROWS(mtr) == 2 ? "32,768 - 15 rows" :\r\n"65,536 - 16 rows");\r\nedac_dbg(2, "\t\tNUMCOL: %s\n",\r\nMTR_DIMM_COLS(mtr) == 0 ? "1,024 - 10 columns" :\r\nMTR_DIMM_COLS(mtr) == 1 ? "2,048 - 11 columns" :\r\nMTR_DIMM_COLS(mtr) == 2 ? "4,096 - 12 columns" :\r\n"reserved");\r\n}\r\nstatic void handle_channel(struct i5400_pvt *pvt, int dimm, int channel,\r\nstruct i5400_dimm_info *dinfo)\r\n{\r\nint mtr;\r\nint amb_present_reg;\r\nint addrBits;\r\nmtr = determine_mtr(pvt, dimm, channel);\r\nif (MTR_DIMMS_PRESENT(mtr)) {\r\namb_present_reg = determine_amb_present_reg(pvt, channel);\r\nif (amb_present_reg & (1 << dimm)) {\r\naddrBits = MTR_DRAM_BANKS_ADDR_BITS(mtr);\r\naddrBits += MTR_DIMM_ROWS_ADDR_BITS(mtr);\r\naddrBits += MTR_DIMM_COLS_ADDR_BITS(mtr);\r\naddrBits += MTR_DIMM_RANK(mtr);\r\naddrBits += 6;\r\naddrBits -= 20;\r\naddrBits -= 3;\r\ndinfo->megabytes = 1 << addrBits;\r\n}\r\n}\r\n}\r\nstatic void calculate_dimm_size(struct i5400_pvt *pvt)\r\n{\r\nstruct i5400_dimm_info *dinfo;\r\nint dimm, max_dimms;\r\nchar *p, *mem_buffer;\r\nint space, n;\r\nint channel, branch;\r\nspace = PAGE_SIZE;\r\nmem_buffer = p = kmalloc(space, GFP_KERNEL);\r\nif (p == NULL) {\r\ni5400_printk(KERN_ERR, "MC: %s:%s() kmalloc() failed\n",\r\n__FILE__, __func__);\r\nreturn;\r\n}\r\nmax_dimms = pvt->maxdimmperch;\r\nfor (dimm = max_dimms - 1; dimm >= 0; dimm--) {\r\nif (dimm & 0x1) {\r\nn = snprintf(p, space, "---------------------------"\r\n"-------------------------------");\r\np += n;\r\nspace -= n;\r\nedac_dbg(2, "%s\n", mem_buffer);\r\np = mem_buffer;\r\nspace = PAGE_SIZE;\r\n}\r\nn = snprintf(p, space, "dimm %2d ", dimm);\r\np += n;\r\nspace -= n;\r\nfor (channel = 0; channel < pvt->maxch; channel++) {\r\ndinfo = &pvt->dimm_info[dimm][channel];\r\nhandle_channel(pvt, dimm, channel, dinfo);\r\nn = snprintf(p, space, "%4d MB | ", dinfo->megabytes);\r\np += n;\r\nspace -= n;\r\n}\r\nedac_dbg(2, "%s\n", mem_buffer);\r\np = mem_buffer;\r\nspace = PAGE_SIZE;\r\n}\r\nn = snprintf(p, space, "---------------------------"\r\n"-------------------------------");\r\np += n;\r\nspace -= n;\r\nedac_dbg(2, "%s\n", mem_buffer);\r\np = mem_buffer;\r\nspace = PAGE_SIZE;\r\nn = snprintf(p, space, " ");\r\np += n;\r\nspace -= n;\r\nfor (channel = 0; channel < pvt->maxch; channel++) {\r\nn = snprintf(p, space, "channel %d | ", channel);\r\np += n;\r\nspace -= n;\r\n}\r\nspace -= n;\r\nedac_dbg(2, "%s\n", mem_buffer);\r\np = mem_buffer;\r\nspace = PAGE_SIZE;\r\nn = snprintf(p, space, " ");\r\np += n;\r\nfor (branch = 0; branch < MAX_BRANCHES; branch++) {\r\nn = snprintf(p, space, " branch %d | ", branch);\r\np += n;\r\nspace -= n;\r\n}\r\nedac_dbg(2, "%s\n", mem_buffer);\r\nkfree(mem_buffer);\r\n}\r\nstatic void i5400_get_mc_regs(struct mem_ctl_info *mci)\r\n{\r\nstruct i5400_pvt *pvt;\r\nu32 actual_tolm;\r\nu16 limit;\r\nint slot_row;\r\nint maxch;\r\nint maxdimmperch;\r\nint way0, way1;\r\npvt = mci->pvt_info;\r\npci_read_config_dword(pvt->system_address, AMBASE,\r\n&pvt->u.ambase_bottom);\r\npci_read_config_dword(pvt->system_address, AMBASE + sizeof(u32),\r\n&pvt->u.ambase_top);\r\nmaxdimmperch = pvt->maxdimmperch;\r\nmaxch = pvt->maxch;\r\nedac_dbg(2, "AMBASE= 0x%lx MAXCH= %d MAX-DIMM-Per-CH= %d\n",\r\n(long unsigned int)pvt->ambase, pvt->maxch, pvt->maxdimmperch);\r\npci_read_config_word(pvt->branchmap_werrors, TOLM, &pvt->tolm);\r\npvt->tolm >>= 12;\r\nedac_dbg(2, "\nTOLM (number of 256M regions) =%u (0x%x)\n",\r\npvt->tolm, pvt->tolm);\r\nactual_tolm = (u32) ((1000l * pvt->tolm) >> (30 - 28));\r\nedac_dbg(2, "Actual TOLM byte addr=%u.%03u GB (0x%x)\n",\r\nactual_tolm/1000, actual_tolm % 1000, pvt->tolm << 28);\r\npci_read_config_word(pvt->branchmap_werrors, MIR0, &pvt->mir0);\r\npci_read_config_word(pvt->branchmap_werrors, MIR1, &pvt->mir1);\r\nlimit = (pvt->mir0 >> 4) & 0x0fff;\r\nway0 = pvt->mir0 & 0x1;\r\nway1 = pvt->mir0 & 0x2;\r\nedac_dbg(2, "MIR0: limit= 0x%x WAY1= %u WAY0= %x\n",\r\nlimit, way1, way0);\r\nlimit = (pvt->mir1 >> 4) & 0xfff;\r\nway0 = pvt->mir1 & 0x1;\r\nway1 = pvt->mir1 & 0x2;\r\nedac_dbg(2, "MIR1: limit= 0x%x WAY1= %u WAY0= %x\n",\r\nlimit, way1, way0);\r\nfor (slot_row = 0; slot_row < DIMMS_PER_CHANNEL; slot_row++) {\r\nint where = MTR0 + (slot_row * sizeof(u16));\r\npci_read_config_word(pvt->branch_0, where,\r\n&pvt->b0_mtr[slot_row]);\r\nedac_dbg(2, "MTR%d where=0x%x B0 value=0x%x\n",\r\nslot_row, where, pvt->b0_mtr[slot_row]);\r\nif (pvt->maxch < CHANNELS_PER_BRANCH) {\r\npvt->b1_mtr[slot_row] = 0;\r\ncontinue;\r\n}\r\npci_read_config_word(pvt->branch_1, where,\r\n&pvt->b1_mtr[slot_row]);\r\nedac_dbg(2, "MTR%d where=0x%x B1 value=0x%x\n",\r\nslot_row, where, pvt->b1_mtr[slot_row]);\r\n}\r\nedac_dbg(2, "Memory Technology Registers:\n");\r\nedac_dbg(2, " Branch 0:\n");\r\nfor (slot_row = 0; slot_row < DIMMS_PER_CHANNEL; slot_row++)\r\ndecode_mtr(slot_row, pvt->b0_mtr[slot_row]);\r\npci_read_config_word(pvt->branch_0, AMBPRESENT_0,\r\n&pvt->b0_ambpresent0);\r\nedac_dbg(2, "\t\tAMB-Branch 0-present0 0x%x:\n", pvt->b0_ambpresent0);\r\npci_read_config_word(pvt->branch_0, AMBPRESENT_1,\r\n&pvt->b0_ambpresent1);\r\nedac_dbg(2, "\t\tAMB-Branch 0-present1 0x%x:\n", pvt->b0_ambpresent1);\r\nif (pvt->maxch < CHANNELS_PER_BRANCH) {\r\npvt->b1_ambpresent0 = 0;\r\npvt->b1_ambpresent1 = 0;\r\n} else {\r\nedac_dbg(2, " Branch 1:\n");\r\nfor (slot_row = 0; slot_row < DIMMS_PER_CHANNEL; slot_row++)\r\ndecode_mtr(slot_row, pvt->b1_mtr[slot_row]);\r\npci_read_config_word(pvt->branch_1, AMBPRESENT_0,\r\n&pvt->b1_ambpresent0);\r\nedac_dbg(2, "\t\tAMB-Branch 1-present0 0x%x:\n",\r\npvt->b1_ambpresent0);\r\npci_read_config_word(pvt->branch_1, AMBPRESENT_1,\r\n&pvt->b1_ambpresent1);\r\nedac_dbg(2, "\t\tAMB-Branch 1-present1 0x%x:\n",\r\npvt->b1_ambpresent1);\r\n}\r\ncalculate_dimm_size(pvt);\r\n}\r\nstatic int i5400_init_dimms(struct mem_ctl_info *mci)\r\n{\r\nstruct i5400_pvt *pvt;\r\nstruct dimm_info *dimm;\r\nint ndimms, channel_count;\r\nint max_dimms;\r\nint mtr;\r\nint size_mb;\r\nint channel, slot;\r\npvt = mci->pvt_info;\r\nchannel_count = pvt->maxch;\r\nmax_dimms = pvt->maxdimmperch;\r\nndimms = 0;\r\nfor (channel = 0; channel < mci->layers[0].size * mci->layers[1].size;\r\nchannel++) {\r\nfor (slot = 0; slot < mci->layers[2].size; slot++) {\r\nmtr = determine_mtr(pvt, slot, channel);\r\nif (!MTR_DIMMS_PRESENT(mtr))\r\ncontinue;\r\ndimm = EDAC_DIMM_PTR(mci->layers, mci->dimms, mci->n_layers,\r\nchannel / 2, channel % 2, slot);\r\nsize_mb = pvt->dimm_info[slot][channel].megabytes;\r\nedac_dbg(2, "dimm (branch %d channel %d slot %d): %d.%03d GB\n",\r\nchannel / 2, channel % 2, slot,\r\nsize_mb / 1000, size_mb % 1000);\r\ndimm->nr_pages = size_mb << 8;\r\ndimm->grain = 8;\r\ndimm->dtype = MTR_DRAM_WIDTH(mtr) ? DEV_X8 : DEV_X4;\r\ndimm->mtype = MEM_FB_DDR2;\r\ndimm->edac_mode = MTR_DRAM_WIDTH(mtr) ?\r\nEDAC_S8ECD8ED : EDAC_S4ECD4ED;\r\nndimms++;\r\n}\r\n}\r\nif (ndimms == 1)\r\nmci->dimms[0]->edac_mode = EDAC_SECDED;\r\nreturn (ndimms == 0);\r\n}\r\nstatic void i5400_enable_error_reporting(struct mem_ctl_info *mci)\r\n{\r\nstruct i5400_pvt *pvt;\r\nu32 fbd_error_mask;\r\npvt = mci->pvt_info;\r\npci_read_config_dword(pvt->branchmap_werrors, EMASK_FBD,\r\n&fbd_error_mask);\r\nfbd_error_mask &= ~(ENABLE_EMASK_ALL);\r\npci_write_config_dword(pvt->branchmap_werrors, EMASK_FBD,\r\nfbd_error_mask);\r\n}\r\nstatic int i5400_probe1(struct pci_dev *pdev, int dev_idx)\r\n{\r\nstruct mem_ctl_info *mci;\r\nstruct i5400_pvt *pvt;\r\nstruct edac_mc_layer layers[3];\r\nif (dev_idx >= ARRAY_SIZE(i5400_devs))\r\nreturn -EINVAL;\r\nedac_dbg(0, "MC: pdev bus %u dev=0x%x fn=0x%x\n",\r\npdev->bus->number,\r\nPCI_SLOT(pdev->devfn), PCI_FUNC(pdev->devfn));\r\nif (PCI_FUNC(pdev->devfn) != 0)\r\nreturn -ENODEV;\r\nlayers[0].type = EDAC_MC_LAYER_BRANCH;\r\nlayers[0].size = MAX_BRANCHES;\r\nlayers[0].is_virt_csrow = false;\r\nlayers[1].type = EDAC_MC_LAYER_CHANNEL;\r\nlayers[1].size = CHANNELS_PER_BRANCH;\r\nlayers[1].is_virt_csrow = false;\r\nlayers[2].type = EDAC_MC_LAYER_SLOT;\r\nlayers[2].size = DIMMS_PER_CHANNEL;\r\nlayers[2].is_virt_csrow = true;\r\nmci = edac_mc_alloc(0, ARRAY_SIZE(layers), layers, sizeof(*pvt));\r\nif (mci == NULL)\r\nreturn -ENOMEM;\r\nedac_dbg(0, "MC: mci = %p\n", mci);\r\nmci->pdev = &pdev->dev;\r\npvt = mci->pvt_info;\r\npvt->system_address = pdev;\r\npvt->maxch = MAX_CHANNELS;\r\npvt->maxdimmperch = DIMMS_PER_CHANNEL;\r\nif (i5400_get_devices(mci, dev_idx))\r\ngoto fail0;\r\ni5400_get_mc_regs(mci);\r\nmci->mc_idx = 0;\r\nmci->mtype_cap = MEM_FLAG_FB_DDR2;\r\nmci->edac_ctl_cap = EDAC_FLAG_NONE;\r\nmci->edac_cap = EDAC_FLAG_NONE;\r\nmci->mod_name = "i5400_edac.c";\r\nmci->mod_ver = I5400_REVISION;\r\nmci->ctl_name = i5400_devs[dev_idx].ctl_name;\r\nmci->dev_name = pci_name(pdev);\r\nmci->ctl_page_to_phys = NULL;\r\nmci->edac_check = i5400_check_error;\r\nif (i5400_init_dimms(mci)) {\r\nedac_dbg(0, "MC: Setting mci->edac_cap to EDAC_FLAG_NONE because i5400_init_dimms() returned nonzero value\n");\r\nmci->edac_cap = EDAC_FLAG_NONE;\r\n} else {\r\nedac_dbg(1, "MC: Enable error reporting now\n");\r\ni5400_enable_error_reporting(mci);\r\n}\r\nif (edac_mc_add_mc(mci)) {\r\nedac_dbg(0, "MC: failed edac_mc_add_mc()\n");\r\ngoto fail1;\r\n}\r\ni5400_clear_error(mci);\r\ni5400_pci = edac_pci_create_generic_ctl(&pdev->dev, EDAC_MOD_STR);\r\nif (!i5400_pci) {\r\nprintk(KERN_WARNING\r\n"%s(): Unable to create PCI control\n",\r\n__func__);\r\nprintk(KERN_WARNING\r\n"%s(): PCI error report via EDAC not setup\n",\r\n__func__);\r\n}\r\nreturn 0;\r\nfail1:\r\ni5400_put_devices(mci);\r\nfail0:\r\nedac_mc_free(mci);\r\nreturn -ENODEV;\r\n}\r\nstatic int i5400_init_one(struct pci_dev *pdev, const struct pci_device_id *id)\r\n{\r\nint rc;\r\nedac_dbg(0, "MC:\n");\r\nrc = pci_enable_device(pdev);\r\nif (rc)\r\nreturn rc;\r\nreturn i5400_probe1(pdev, id->driver_data);\r\n}\r\nstatic void i5400_remove_one(struct pci_dev *pdev)\r\n{\r\nstruct mem_ctl_info *mci;\r\nedac_dbg(0, "\n");\r\nif (i5400_pci)\r\nedac_pci_release_generic_ctl(i5400_pci);\r\nmci = edac_mc_del_mc(&pdev->dev);\r\nif (!mci)\r\nreturn;\r\ni5400_put_devices(mci);\r\nedac_mc_free(mci);\r\n}\r\nstatic int __init i5400_init(void)\r\n{\r\nint pci_rc;\r\nedac_dbg(2, "MC:\n");\r\nopstate_init();\r\npci_rc = pci_register_driver(&i5400_driver);\r\nreturn (pci_rc < 0) ? pci_rc : 0;\r\n}\r\nstatic void __exit i5400_exit(void)\r\n{\r\nedac_dbg(2, "MC:\n");\r\npci_unregister_driver(&i5400_driver);\r\n}

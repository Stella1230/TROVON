static void ns87415_set_mode(struct ata_port *ap, struct ata_device *adev, u8 mode)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(ap->host->dev);\r\nint unit = 2 * ap->port_no + adev->devno;\r\nint timing = 0x44 + 2 * unit;\r\nunsigned long T = 1000000000 / 33333;\r\nstruct ata_timing t;\r\nu16 clocking;\r\nu8 iordy;\r\nu8 status;\r\nata_timing_compute(adev, adev->pio_mode, &t, T, 0);\r\nclocking = 17 - clamp_val(t.active, 2, 17);\r\nclocking |= (16 - clamp_val(t.recover, 1, 16)) << 4;\r\nclocking |= (clocking << 8);\r\npci_write_config_word(dev, timing, clocking);\r\npci_read_config_byte(dev, 0x42, &iordy);\r\niordy &= ~(1 << (4 + unit));\r\nif (mode >= XFER_MW_DMA_0 || !ata_pio_need_iordy(adev))\r\niordy |= (1 << (4 + unit));\r\npci_read_config_byte(dev, 0x43, &status);\r\nwhile (status & 0x03) {\r\nudelay(1);\r\npci_read_config_byte(dev, 0x43, &status);\r\n}\r\npci_write_config_byte(dev, 0x42, iordy);\r\n}\r\nstatic void ns87415_set_piomode(struct ata_port *ap, struct ata_device *adev)\r\n{\r\nns87415_set_mode(ap, adev, adev->pio_mode);\r\n}\r\nstatic void ns87415_bmdma_setup(struct ata_queued_cmd *qc)\r\n{\r\nstruct ata_port *ap = qc->ap;\r\nunsigned int rw = (qc->tf.flags & ATA_TFLAG_WRITE);\r\nu8 dmactl;\r\nmb();\r\niowrite32(ap->bmdma_prd_dma, ap->ioaddr.bmdma_addr + ATA_DMA_TABLE_OFS);\r\ndmactl = ioread8(ap->ioaddr.bmdma_addr + ATA_DMA_CMD);\r\ndmactl &= ~(ATA_DMA_WR | ATA_DMA_START);\r\ndmactl |= ATA_DMA_INTR | ATA_DMA_ERR;\r\nif (!rw)\r\ndmactl |= ATA_DMA_WR;\r\niowrite8(dmactl, ap->ioaddr.bmdma_addr + ATA_DMA_CMD);\r\nap->ops->sff_exec_command(ap, &qc->tf);\r\n}\r\nstatic void ns87415_bmdma_start(struct ata_queued_cmd *qc)\r\n{\r\nns87415_set_mode(qc->ap, qc->dev, qc->dev->dma_mode);\r\nata_bmdma_start(qc);\r\n}\r\nstatic void ns87415_bmdma_stop(struct ata_queued_cmd *qc)\r\n{\r\nata_bmdma_stop(qc);\r\nns87415_set_mode(qc->ap, qc->dev, qc->dev->pio_mode);\r\n}\r\nstatic void ns87415_irq_clear(struct ata_port *ap)\r\n{\r\nvoid __iomem *mmio = ap->ioaddr.bmdma_addr;\r\nif (!mmio)\r\nreturn;\r\niowrite8((ioread8(mmio + ATA_DMA_CMD) | ATA_DMA_INTR | ATA_DMA_ERR),\r\nmmio + ATA_DMA_CMD);\r\n}\r\nstatic int ns87415_check_atapi_dma(struct ata_queued_cmd *qc)\r\n{\r\nreturn -EOPNOTSUPP;\r\n}\r\nstatic u8 ns87560_read_buggy(void __iomem *port)\r\n{\r\nu8 tmp;\r\nint retries = SUPERIO_IDE_MAX_RETRIES;\r\ndo {\r\ntmp = ioread8(port);\r\nif (tmp != 0)\r\nreturn tmp;\r\nudelay(50);\r\n} while(retries-- > 0);\r\nreturn tmp;\r\n}\r\nstatic u8 ns87560_check_status(struct ata_port *ap)\r\n{\r\nreturn ns87560_read_buggy(ap->ioaddr.status_addr);\r\n}\r\nvoid ns87560_tf_read(struct ata_port *ap, struct ata_taskfile *tf)\r\n{\r\nstruct ata_ioports *ioaddr = &ap->ioaddr;\r\ntf->command = ns87560_check_status(ap);\r\ntf->feature = ioread8(ioaddr->error_addr);\r\ntf->nsect = ioread8(ioaddr->nsect_addr);\r\ntf->lbal = ioread8(ioaddr->lbal_addr);\r\ntf->lbam = ioread8(ioaddr->lbam_addr);\r\ntf->lbah = ioread8(ioaddr->lbah_addr);\r\ntf->device = ns87560_read_buggy(ioaddr->device_addr);\r\nif (tf->flags & ATA_TFLAG_LBA48) {\r\niowrite8(tf->ctl | ATA_HOB, ioaddr->ctl_addr);\r\ntf->hob_feature = ioread8(ioaddr->error_addr);\r\ntf->hob_nsect = ioread8(ioaddr->nsect_addr);\r\ntf->hob_lbal = ioread8(ioaddr->lbal_addr);\r\ntf->hob_lbam = ioread8(ioaddr->lbam_addr);\r\ntf->hob_lbah = ioread8(ioaddr->lbah_addr);\r\niowrite8(tf->ctl, ioaddr->ctl_addr);\r\nap->last_ctl = tf->ctl;\r\n}\r\n}\r\nstatic u8 ns87560_bmdma_status(struct ata_port *ap)\r\n{\r\nreturn ns87560_read_buggy(ap->ioaddr.bmdma_addr + ATA_DMA_STATUS);\r\n}\r\nstatic void ns87415_fixup(struct pci_dev *pdev)\r\n{\r\npci_write_config_byte(pdev, 0x55, 0xEE);\r\npci_write_config_byte(pdev, 0x54, 0xB7);\r\n}\r\nstatic int ns87415_init_one (struct pci_dev *pdev, const struct pci_device_id *ent)\r\n{\r\nstatic const struct ata_port_info info = {\r\n.flags = ATA_FLAG_SLAVE_POSS,\r\n.pio_mask = ATA_PIO4,\r\n.mwdma_mask = ATA_MWDMA2,\r\n.port_ops = &ns87415_pata_ops,\r\n};\r\nconst struct ata_port_info *ppi[] = { &info, NULL };\r\nint rc;\r\n#if defined(CONFIG_SUPERIO)\r\nstatic const struct ata_port_info info87560 = {\r\n.flags = ATA_FLAG_SLAVE_POSS,\r\n.pio_mask = ATA_PIO4,\r\n.mwdma_mask = ATA_MWDMA2,\r\n.port_ops = &ns87560_pata_ops,\r\n};\r\nif (PCI_SLOT(pdev->devfn) == 0x0E)\r\nppi[0] = &info87560;\r\n#endif\r\nata_print_version_once(&pdev->dev, DRV_VERSION);\r\nrc = pcim_enable_device(pdev);\r\nif (rc)\r\nreturn rc;\r\nns87415_fixup(pdev);\r\nreturn ata_pci_bmdma_init_one(pdev, ppi, &ns87415_sht, NULL, 0);\r\n}\r\nstatic int ns87415_reinit_one(struct pci_dev *pdev)\r\n{\r\nstruct ata_host *host = dev_get_drvdata(&pdev->dev);\r\nint rc;\r\nrc = ata_pci_device_do_resume(pdev);\r\nif (rc)\r\nreturn rc;\r\nns87415_fixup(pdev);\r\nata_host_resume(host);\r\nreturn 0;\r\n}

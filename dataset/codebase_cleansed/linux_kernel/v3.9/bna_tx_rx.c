static void\r\nbna_ib_coalescing_timeo_set(struct bna_ib *ib, u8 coalescing_timeo)\r\n{\r\nib->coalescing_timeo = coalescing_timeo;\r\nib->door_bell.doorbell_ack = BNA_DOORBELL_IB_INT_ACK(\r\n(u32)ib->coalescing_timeo, 0);\r\n}\r\nstatic void\r\nbna_rxf_sm_stopped_entry(struct bna_rxf *rxf)\r\n{\r\ncall_rxf_stop_cbfn(rxf);\r\n}\r\nstatic void\r\nbna_rxf_sm_stopped(struct bna_rxf *rxf, enum bna_rxf_event event)\r\n{\r\nswitch (event) {\r\ncase RXF_E_START:\r\nif (rxf->flags & BNA_RXF_F_PAUSED) {\r\nbfa_fsm_set_state(rxf, bna_rxf_sm_paused);\r\ncall_rxf_start_cbfn(rxf);\r\n} else\r\nbfa_fsm_set_state(rxf, bna_rxf_sm_cfg_wait);\r\nbreak;\r\ncase RXF_E_STOP:\r\ncall_rxf_stop_cbfn(rxf);\r\nbreak;\r\ncase RXF_E_FAIL:\r\nbreak;\r\ncase RXF_E_CONFIG:\r\ncall_rxf_cam_fltr_cbfn(rxf);\r\nbreak;\r\ncase RXF_E_PAUSE:\r\nrxf->flags |= BNA_RXF_F_PAUSED;\r\ncall_rxf_pause_cbfn(rxf);\r\nbreak;\r\ncase RXF_E_RESUME:\r\nrxf->flags &= ~BNA_RXF_F_PAUSED;\r\ncall_rxf_resume_cbfn(rxf);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_rxf_sm_paused_entry(struct bna_rxf *rxf)\r\n{\r\ncall_rxf_pause_cbfn(rxf);\r\n}\r\nstatic void\r\nbna_rxf_sm_paused(struct bna_rxf *rxf, enum bna_rxf_event event)\r\n{\r\nswitch (event) {\r\ncase RXF_E_STOP:\r\ncase RXF_E_FAIL:\r\nbfa_fsm_set_state(rxf, bna_rxf_sm_stopped);\r\nbreak;\r\ncase RXF_E_CONFIG:\r\ncall_rxf_cam_fltr_cbfn(rxf);\r\nbreak;\r\ncase RXF_E_RESUME:\r\nrxf->flags &= ~BNA_RXF_F_PAUSED;\r\nbfa_fsm_set_state(rxf, bna_rxf_sm_cfg_wait);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_rxf_sm_cfg_wait_entry(struct bna_rxf *rxf)\r\n{\r\nif (!bna_rxf_cfg_apply(rxf)) {\r\nbfa_fsm_set_state(rxf, bna_rxf_sm_started);\r\n}\r\n}\r\nstatic void\r\nbna_rxf_sm_cfg_wait(struct bna_rxf *rxf, enum bna_rxf_event event)\r\n{\r\nswitch (event) {\r\ncase RXF_E_STOP:\r\nbfa_fsm_set_state(rxf, bna_rxf_sm_last_resp_wait);\r\nbreak;\r\ncase RXF_E_FAIL:\r\nbna_rxf_cfg_reset(rxf);\r\ncall_rxf_start_cbfn(rxf);\r\ncall_rxf_cam_fltr_cbfn(rxf);\r\ncall_rxf_resume_cbfn(rxf);\r\nbfa_fsm_set_state(rxf, bna_rxf_sm_stopped);\r\nbreak;\r\ncase RXF_E_CONFIG:\r\nbreak;\r\ncase RXF_E_PAUSE:\r\nrxf->flags |= BNA_RXF_F_PAUSED;\r\ncall_rxf_start_cbfn(rxf);\r\nbfa_fsm_set_state(rxf, bna_rxf_sm_fltr_clr_wait);\r\nbreak;\r\ncase RXF_E_FW_RESP:\r\nif (!bna_rxf_cfg_apply(rxf)) {\r\nbfa_fsm_set_state(rxf, bna_rxf_sm_started);\r\n}\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_rxf_sm_started_entry(struct bna_rxf *rxf)\r\n{\r\ncall_rxf_start_cbfn(rxf);\r\ncall_rxf_cam_fltr_cbfn(rxf);\r\ncall_rxf_resume_cbfn(rxf);\r\n}\r\nstatic void\r\nbna_rxf_sm_started(struct bna_rxf *rxf, enum bna_rxf_event event)\r\n{\r\nswitch (event) {\r\ncase RXF_E_STOP:\r\ncase RXF_E_FAIL:\r\nbna_rxf_cfg_reset(rxf);\r\nbfa_fsm_set_state(rxf, bna_rxf_sm_stopped);\r\nbreak;\r\ncase RXF_E_CONFIG:\r\nbfa_fsm_set_state(rxf, bna_rxf_sm_cfg_wait);\r\nbreak;\r\ncase RXF_E_PAUSE:\r\nrxf->flags |= BNA_RXF_F_PAUSED;\r\nif (!bna_rxf_fltr_clear(rxf))\r\nbfa_fsm_set_state(rxf, bna_rxf_sm_paused);\r\nelse\r\nbfa_fsm_set_state(rxf, bna_rxf_sm_fltr_clr_wait);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_rxf_sm_fltr_clr_wait_entry(struct bna_rxf *rxf)\r\n{\r\n}\r\nstatic void\r\nbna_rxf_sm_fltr_clr_wait(struct bna_rxf *rxf, enum bna_rxf_event event)\r\n{\r\nswitch (event) {\r\ncase RXF_E_FAIL:\r\nbna_rxf_cfg_reset(rxf);\r\ncall_rxf_pause_cbfn(rxf);\r\nbfa_fsm_set_state(rxf, bna_rxf_sm_stopped);\r\nbreak;\r\ncase RXF_E_FW_RESP:\r\nif (!bna_rxf_fltr_clear(rxf)) {\r\nbfa_fsm_set_state(rxf, bna_rxf_sm_paused);\r\n}\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_rxf_sm_last_resp_wait_entry(struct bna_rxf *rxf)\r\n{\r\n}\r\nstatic void\r\nbna_rxf_sm_last_resp_wait(struct bna_rxf *rxf, enum bna_rxf_event event)\r\n{\r\nswitch (event) {\r\ncase RXF_E_FAIL:\r\ncase RXF_E_FW_RESP:\r\nbna_rxf_cfg_reset(rxf);\r\nbfa_fsm_set_state(rxf, bna_rxf_sm_stopped);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_bfi_ucast_req(struct bna_rxf *rxf, struct bna_mac *mac,\r\nenum bfi_enet_h2i_msgs req_type)\r\n{\r\nstruct bfi_enet_ucast_req *req = &rxf->bfi_enet_cmd.ucast_req;\r\nbfi_msgq_mhdr_set(req->mh, BFI_MC_ENET, req_type, 0, rxf->rx->rid);\r\nreq->mh.num_entries = htons(\r\nbfi_msgq_num_cmd_entries(sizeof(struct bfi_enet_ucast_req)));\r\nmemcpy(&req->mac_addr, &mac->addr, sizeof(mac_t));\r\nbfa_msgq_cmd_set(&rxf->msgq_cmd, NULL, NULL,\r\nsizeof(struct bfi_enet_ucast_req), &req->mh);\r\nbfa_msgq_cmd_post(&rxf->rx->bna->msgq, &rxf->msgq_cmd);\r\n}\r\nstatic void\r\nbna_bfi_mcast_add_req(struct bna_rxf *rxf, struct bna_mac *mac)\r\n{\r\nstruct bfi_enet_mcast_add_req *req =\r\n&rxf->bfi_enet_cmd.mcast_add_req;\r\nbfi_msgq_mhdr_set(req->mh, BFI_MC_ENET, BFI_ENET_H2I_MAC_MCAST_ADD_REQ,\r\n0, rxf->rx->rid);\r\nreq->mh.num_entries = htons(\r\nbfi_msgq_num_cmd_entries(sizeof(struct bfi_enet_mcast_add_req)));\r\nmemcpy(&req->mac_addr, &mac->addr, sizeof(mac_t));\r\nbfa_msgq_cmd_set(&rxf->msgq_cmd, NULL, NULL,\r\nsizeof(struct bfi_enet_mcast_add_req), &req->mh);\r\nbfa_msgq_cmd_post(&rxf->rx->bna->msgq, &rxf->msgq_cmd);\r\n}\r\nstatic void\r\nbna_bfi_mcast_del_req(struct bna_rxf *rxf, u16 handle)\r\n{\r\nstruct bfi_enet_mcast_del_req *req =\r\n&rxf->bfi_enet_cmd.mcast_del_req;\r\nbfi_msgq_mhdr_set(req->mh, BFI_MC_ENET, BFI_ENET_H2I_MAC_MCAST_DEL_REQ,\r\n0, rxf->rx->rid);\r\nreq->mh.num_entries = htons(\r\nbfi_msgq_num_cmd_entries(sizeof(struct bfi_enet_mcast_del_req)));\r\nreq->handle = htons(handle);\r\nbfa_msgq_cmd_set(&rxf->msgq_cmd, NULL, NULL,\r\nsizeof(struct bfi_enet_mcast_del_req), &req->mh);\r\nbfa_msgq_cmd_post(&rxf->rx->bna->msgq, &rxf->msgq_cmd);\r\n}\r\nstatic void\r\nbna_bfi_mcast_filter_req(struct bna_rxf *rxf, enum bna_status status)\r\n{\r\nstruct bfi_enet_enable_req *req = &rxf->bfi_enet_cmd.req;\r\nbfi_msgq_mhdr_set(req->mh, BFI_MC_ENET,\r\nBFI_ENET_H2I_MAC_MCAST_FILTER_REQ, 0, rxf->rx->rid);\r\nreq->mh.num_entries = htons(\r\nbfi_msgq_num_cmd_entries(sizeof(struct bfi_enet_enable_req)));\r\nreq->enable = status;\r\nbfa_msgq_cmd_set(&rxf->msgq_cmd, NULL, NULL,\r\nsizeof(struct bfi_enet_enable_req), &req->mh);\r\nbfa_msgq_cmd_post(&rxf->rx->bna->msgq, &rxf->msgq_cmd);\r\n}\r\nstatic void\r\nbna_bfi_rx_promisc_req(struct bna_rxf *rxf, enum bna_status status)\r\n{\r\nstruct bfi_enet_enable_req *req = &rxf->bfi_enet_cmd.req;\r\nbfi_msgq_mhdr_set(req->mh, BFI_MC_ENET,\r\nBFI_ENET_H2I_RX_PROMISCUOUS_REQ, 0, rxf->rx->rid);\r\nreq->mh.num_entries = htons(\r\nbfi_msgq_num_cmd_entries(sizeof(struct bfi_enet_enable_req)));\r\nreq->enable = status;\r\nbfa_msgq_cmd_set(&rxf->msgq_cmd, NULL, NULL,\r\nsizeof(struct bfi_enet_enable_req), &req->mh);\r\nbfa_msgq_cmd_post(&rxf->rx->bna->msgq, &rxf->msgq_cmd);\r\n}\r\nstatic void\r\nbna_bfi_rx_vlan_filter_set(struct bna_rxf *rxf, u8 block_idx)\r\n{\r\nstruct bfi_enet_rx_vlan_req *req = &rxf->bfi_enet_cmd.vlan_req;\r\nint i;\r\nint j;\r\nbfi_msgq_mhdr_set(req->mh, BFI_MC_ENET,\r\nBFI_ENET_H2I_RX_VLAN_SET_REQ, 0, rxf->rx->rid);\r\nreq->mh.num_entries = htons(\r\nbfi_msgq_num_cmd_entries(sizeof(struct bfi_enet_rx_vlan_req)));\r\nreq->block_idx = block_idx;\r\nfor (i = 0; i < (BFI_ENET_VLAN_BLOCK_SIZE / 32); i++) {\r\nj = (block_idx * (BFI_ENET_VLAN_BLOCK_SIZE / 32)) + i;\r\nif (rxf->vlan_filter_status == BNA_STATUS_T_ENABLED)\r\nreq->bit_mask[i] =\r\nhtonl(rxf->vlan_filter_table[j]);\r\nelse\r\nreq->bit_mask[i] = 0xFFFFFFFF;\r\n}\r\nbfa_msgq_cmd_set(&rxf->msgq_cmd, NULL, NULL,\r\nsizeof(struct bfi_enet_rx_vlan_req), &req->mh);\r\nbfa_msgq_cmd_post(&rxf->rx->bna->msgq, &rxf->msgq_cmd);\r\n}\r\nstatic void\r\nbna_bfi_vlan_strip_enable(struct bna_rxf *rxf)\r\n{\r\nstruct bfi_enet_enable_req *req = &rxf->bfi_enet_cmd.req;\r\nbfi_msgq_mhdr_set(req->mh, BFI_MC_ENET,\r\nBFI_ENET_H2I_RX_VLAN_STRIP_ENABLE_REQ, 0, rxf->rx->rid);\r\nreq->mh.num_entries = htons(\r\nbfi_msgq_num_cmd_entries(sizeof(struct bfi_enet_enable_req)));\r\nreq->enable = rxf->vlan_strip_status;\r\nbfa_msgq_cmd_set(&rxf->msgq_cmd, NULL, NULL,\r\nsizeof(struct bfi_enet_enable_req), &req->mh);\r\nbfa_msgq_cmd_post(&rxf->rx->bna->msgq, &rxf->msgq_cmd);\r\n}\r\nstatic void\r\nbna_bfi_rit_cfg(struct bna_rxf *rxf)\r\n{\r\nstruct bfi_enet_rit_req *req = &rxf->bfi_enet_cmd.rit_req;\r\nbfi_msgq_mhdr_set(req->mh, BFI_MC_ENET,\r\nBFI_ENET_H2I_RIT_CFG_REQ, 0, rxf->rx->rid);\r\nreq->mh.num_entries = htons(\r\nbfi_msgq_num_cmd_entries(sizeof(struct bfi_enet_rit_req)));\r\nreq->size = htons(rxf->rit_size);\r\nmemcpy(&req->table[0], rxf->rit, rxf->rit_size);\r\nbfa_msgq_cmd_set(&rxf->msgq_cmd, NULL, NULL,\r\nsizeof(struct bfi_enet_rit_req), &req->mh);\r\nbfa_msgq_cmd_post(&rxf->rx->bna->msgq, &rxf->msgq_cmd);\r\n}\r\nstatic void\r\nbna_bfi_rss_cfg(struct bna_rxf *rxf)\r\n{\r\nstruct bfi_enet_rss_cfg_req *req = &rxf->bfi_enet_cmd.rss_req;\r\nint i;\r\nbfi_msgq_mhdr_set(req->mh, BFI_MC_ENET,\r\nBFI_ENET_H2I_RSS_CFG_REQ, 0, rxf->rx->rid);\r\nreq->mh.num_entries = htons(\r\nbfi_msgq_num_cmd_entries(sizeof(struct bfi_enet_rss_cfg_req)));\r\nreq->cfg.type = rxf->rss_cfg.hash_type;\r\nreq->cfg.mask = rxf->rss_cfg.hash_mask;\r\nfor (i = 0; i < BFI_ENET_RSS_KEY_LEN; i++)\r\nreq->cfg.key[i] =\r\nhtonl(rxf->rss_cfg.toeplitz_hash_key[i]);\r\nbfa_msgq_cmd_set(&rxf->msgq_cmd, NULL, NULL,\r\nsizeof(struct bfi_enet_rss_cfg_req), &req->mh);\r\nbfa_msgq_cmd_post(&rxf->rx->bna->msgq, &rxf->msgq_cmd);\r\n}\r\nstatic void\r\nbna_bfi_rss_enable(struct bna_rxf *rxf)\r\n{\r\nstruct bfi_enet_enable_req *req = &rxf->bfi_enet_cmd.req;\r\nbfi_msgq_mhdr_set(req->mh, BFI_MC_ENET,\r\nBFI_ENET_H2I_RSS_ENABLE_REQ, 0, rxf->rx->rid);\r\nreq->mh.num_entries = htons(\r\nbfi_msgq_num_cmd_entries(sizeof(struct bfi_enet_enable_req)));\r\nreq->enable = rxf->rss_status;\r\nbfa_msgq_cmd_set(&rxf->msgq_cmd, NULL, NULL,\r\nsizeof(struct bfi_enet_enable_req), &req->mh);\r\nbfa_msgq_cmd_post(&rxf->rx->bna->msgq, &rxf->msgq_cmd);\r\n}\r\nstatic struct bna_mac *\r\nbna_rxf_mcmac_get(struct bna_rxf *rxf, u8 *mac_addr)\r\n{\r\nstruct bna_mac *mac;\r\nstruct list_head *qe;\r\nlist_for_each(qe, &rxf->mcast_active_q) {\r\nmac = (struct bna_mac *)qe;\r\nif (BNA_MAC_IS_EQUAL(&mac->addr, mac_addr))\r\nreturn mac;\r\n}\r\nlist_for_each(qe, &rxf->mcast_pending_del_q) {\r\nmac = (struct bna_mac *)qe;\r\nif (BNA_MAC_IS_EQUAL(&mac->addr, mac_addr))\r\nreturn mac;\r\n}\r\nreturn NULL;\r\n}\r\nstatic struct bna_mcam_handle *\r\nbna_rxf_mchandle_get(struct bna_rxf *rxf, int handle)\r\n{\r\nstruct bna_mcam_handle *mchandle;\r\nstruct list_head *qe;\r\nlist_for_each(qe, &rxf->mcast_handle_q) {\r\nmchandle = (struct bna_mcam_handle *)qe;\r\nif (mchandle->handle == handle)\r\nreturn mchandle;\r\n}\r\nreturn NULL;\r\n}\r\nstatic void\r\nbna_rxf_mchandle_attach(struct bna_rxf *rxf, u8 *mac_addr, int handle)\r\n{\r\nstruct bna_mac *mcmac;\r\nstruct bna_mcam_handle *mchandle;\r\nmcmac = bna_rxf_mcmac_get(rxf, mac_addr);\r\nmchandle = bna_rxf_mchandle_get(rxf, handle);\r\nif (mchandle == NULL) {\r\nmchandle = bna_mcam_mod_handle_get(&rxf->rx->bna->mcam_mod);\r\nmchandle->handle = handle;\r\nmchandle->refcnt = 0;\r\nlist_add_tail(&mchandle->qe, &rxf->mcast_handle_q);\r\n}\r\nmchandle->refcnt++;\r\nmcmac->handle = mchandle;\r\n}\r\nstatic int\r\nbna_rxf_mcast_del(struct bna_rxf *rxf, struct bna_mac *mac,\r\nenum bna_cleanup_type cleanup)\r\n{\r\nstruct bna_mcam_handle *mchandle;\r\nint ret = 0;\r\nmchandle = mac->handle;\r\nif (mchandle == NULL)\r\nreturn ret;\r\nmchandle->refcnt--;\r\nif (mchandle->refcnt == 0) {\r\nif (cleanup == BNA_HARD_CLEANUP) {\r\nbna_bfi_mcast_del_req(rxf, mchandle->handle);\r\nret = 1;\r\n}\r\nlist_del(&mchandle->qe);\r\nbfa_q_qe_init(&mchandle->qe);\r\nbna_mcam_mod_handle_put(&rxf->rx->bna->mcam_mod, mchandle);\r\n}\r\nmac->handle = NULL;\r\nreturn ret;\r\n}\r\nstatic int\r\nbna_rxf_mcast_cfg_apply(struct bna_rxf *rxf)\r\n{\r\nstruct bna_mac *mac = NULL;\r\nstruct list_head *qe;\r\nint ret;\r\nwhile (!list_empty(&rxf->mcast_pending_del_q)) {\r\nbfa_q_deq(&rxf->mcast_pending_del_q, &qe);\r\nbfa_q_qe_init(qe);\r\nmac = (struct bna_mac *)qe;\r\nret = bna_rxf_mcast_del(rxf, mac, BNA_HARD_CLEANUP);\r\nbna_mcam_mod_mac_put(&rxf->rx->bna->mcam_mod, mac);\r\nif (ret)\r\nreturn ret;\r\n}\r\nif (!list_empty(&rxf->mcast_pending_add_q)) {\r\nbfa_q_deq(&rxf->mcast_pending_add_q, &qe);\r\nbfa_q_qe_init(qe);\r\nmac = (struct bna_mac *)qe;\r\nlist_add_tail(&mac->qe, &rxf->mcast_active_q);\r\nbna_bfi_mcast_add_req(rxf, mac);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nbna_rxf_vlan_cfg_apply(struct bna_rxf *rxf)\r\n{\r\nu8 vlan_pending_bitmask;\r\nint block_idx = 0;\r\nif (rxf->vlan_pending_bitmask) {\r\nvlan_pending_bitmask = rxf->vlan_pending_bitmask;\r\nwhile (!(vlan_pending_bitmask & 0x1)) {\r\nblock_idx++;\r\nvlan_pending_bitmask >>= 1;\r\n}\r\nrxf->vlan_pending_bitmask &= ~(1 << block_idx);\r\nbna_bfi_rx_vlan_filter_set(rxf, block_idx);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nbna_rxf_mcast_cfg_reset(struct bna_rxf *rxf, enum bna_cleanup_type cleanup)\r\n{\r\nstruct list_head *qe;\r\nstruct bna_mac *mac;\r\nint ret;\r\nwhile (!list_empty(&rxf->mcast_pending_del_q)) {\r\nbfa_q_deq(&rxf->mcast_pending_del_q, &qe);\r\nbfa_q_qe_init(qe);\r\nmac = (struct bna_mac *)qe;\r\nret = bna_rxf_mcast_del(rxf, mac, cleanup);\r\nbna_mcam_mod_mac_put(&rxf->rx->bna->mcam_mod, mac);\r\nif (ret)\r\nreturn ret;\r\n}\r\nwhile (!list_empty(&rxf->mcast_active_q)) {\r\nbfa_q_deq(&rxf->mcast_active_q, &qe);\r\nbfa_q_qe_init(qe);\r\nlist_add_tail(qe, &rxf->mcast_pending_add_q);\r\nmac = (struct bna_mac *)qe;\r\nif (bna_rxf_mcast_del(rxf, mac, cleanup))\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nbna_rxf_rss_cfg_apply(struct bna_rxf *rxf)\r\n{\r\nif (rxf->rss_pending) {\r\nif (rxf->rss_pending & BNA_RSS_F_RIT_PENDING) {\r\nrxf->rss_pending &= ~BNA_RSS_F_RIT_PENDING;\r\nbna_bfi_rit_cfg(rxf);\r\nreturn 1;\r\n}\r\nif (rxf->rss_pending & BNA_RSS_F_CFG_PENDING) {\r\nrxf->rss_pending &= ~BNA_RSS_F_CFG_PENDING;\r\nbna_bfi_rss_cfg(rxf);\r\nreturn 1;\r\n}\r\nif (rxf->rss_pending & BNA_RSS_F_STATUS_PENDING) {\r\nrxf->rss_pending &= ~BNA_RSS_F_STATUS_PENDING;\r\nbna_bfi_rss_enable(rxf);\r\nreturn 1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nbna_rxf_cfg_apply(struct bna_rxf *rxf)\r\n{\r\nif (bna_rxf_ucast_cfg_apply(rxf))\r\nreturn 1;\r\nif (bna_rxf_mcast_cfg_apply(rxf))\r\nreturn 1;\r\nif (bna_rxf_promisc_cfg_apply(rxf))\r\nreturn 1;\r\nif (bna_rxf_allmulti_cfg_apply(rxf))\r\nreturn 1;\r\nif (bna_rxf_vlan_cfg_apply(rxf))\r\nreturn 1;\r\nif (bna_rxf_vlan_strip_cfg_apply(rxf))\r\nreturn 1;\r\nif (bna_rxf_rss_cfg_apply(rxf))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int\r\nbna_rxf_fltr_clear(struct bna_rxf *rxf)\r\n{\r\nif (bna_rxf_ucast_cfg_reset(rxf, BNA_HARD_CLEANUP))\r\nreturn 1;\r\nif (bna_rxf_mcast_cfg_reset(rxf, BNA_HARD_CLEANUP))\r\nreturn 1;\r\nif (bna_rxf_promisc_cfg_reset(rxf, BNA_HARD_CLEANUP))\r\nreturn 1;\r\nif (bna_rxf_allmulti_cfg_reset(rxf, BNA_HARD_CLEANUP))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic void\r\nbna_rxf_cfg_reset(struct bna_rxf *rxf)\r\n{\r\nbna_rxf_ucast_cfg_reset(rxf, BNA_SOFT_CLEANUP);\r\nbna_rxf_mcast_cfg_reset(rxf, BNA_SOFT_CLEANUP);\r\nbna_rxf_promisc_cfg_reset(rxf, BNA_SOFT_CLEANUP);\r\nbna_rxf_allmulti_cfg_reset(rxf, BNA_SOFT_CLEANUP);\r\nbna_rxf_vlan_cfg_soft_reset(rxf);\r\nbna_rxf_rss_cfg_soft_reset(rxf);\r\n}\r\nstatic void\r\nbna_rit_init(struct bna_rxf *rxf, int rit_size)\r\n{\r\nstruct bna_rx *rx = rxf->rx;\r\nstruct bna_rxp *rxp;\r\nstruct list_head *qe;\r\nint offset = 0;\r\nrxf->rit_size = rit_size;\r\nlist_for_each(qe, &rx->rxp_q) {\r\nrxp = (struct bna_rxp *)qe;\r\nrxf->rit[offset] = rxp->cq.ccb->id;\r\noffset++;\r\n}\r\n}\r\nvoid\r\nbna_bfi_rxf_cfg_rsp(struct bna_rxf *rxf, struct bfi_msgq_mhdr *msghdr)\r\n{\r\nbfa_fsm_send_event(rxf, RXF_E_FW_RESP);\r\n}\r\nvoid\r\nbna_bfi_rxf_mcast_add_rsp(struct bna_rxf *rxf,\r\nstruct bfi_msgq_mhdr *msghdr)\r\n{\r\nstruct bfi_enet_mcast_add_req *req =\r\n&rxf->bfi_enet_cmd.mcast_add_req;\r\nstruct bfi_enet_mcast_add_rsp *rsp =\r\n(struct bfi_enet_mcast_add_rsp *)msghdr;\r\nbna_rxf_mchandle_attach(rxf, (u8 *)&req->mac_addr,\r\nntohs(rsp->handle));\r\nbfa_fsm_send_event(rxf, RXF_E_FW_RESP);\r\n}\r\nstatic void\r\nbna_rxf_init(struct bna_rxf *rxf,\r\nstruct bna_rx *rx,\r\nstruct bna_rx_config *q_config,\r\nstruct bna_res_info *res_info)\r\n{\r\nrxf->rx = rx;\r\nINIT_LIST_HEAD(&rxf->ucast_pending_add_q);\r\nINIT_LIST_HEAD(&rxf->ucast_pending_del_q);\r\nrxf->ucast_pending_set = 0;\r\nrxf->ucast_active_set = 0;\r\nINIT_LIST_HEAD(&rxf->ucast_active_q);\r\nrxf->ucast_pending_mac = NULL;\r\nINIT_LIST_HEAD(&rxf->mcast_pending_add_q);\r\nINIT_LIST_HEAD(&rxf->mcast_pending_del_q);\r\nINIT_LIST_HEAD(&rxf->mcast_active_q);\r\nINIT_LIST_HEAD(&rxf->mcast_handle_q);\r\nif (q_config->paused)\r\nrxf->flags |= BNA_RXF_F_PAUSED;\r\nrxf->rit = (u8 *)\r\nres_info[BNA_RX_RES_MEM_T_RIT].res_u.mem_info.mdl[0].kva;\r\nbna_rit_init(rxf, q_config->num_paths);\r\nrxf->rss_status = q_config->rss_status;\r\nif (rxf->rss_status == BNA_STATUS_T_ENABLED) {\r\nrxf->rss_cfg = q_config->rss_config;\r\nrxf->rss_pending |= BNA_RSS_F_CFG_PENDING;\r\nrxf->rss_pending |= BNA_RSS_F_RIT_PENDING;\r\nrxf->rss_pending |= BNA_RSS_F_STATUS_PENDING;\r\n}\r\nrxf->vlan_filter_status = BNA_STATUS_T_DISABLED;\r\nmemset(rxf->vlan_filter_table, 0,\r\n(sizeof(u32) * (BFI_ENET_VLAN_ID_MAX / 32)));\r\nrxf->vlan_filter_table[0] |= 1;\r\nrxf->vlan_pending_bitmask = (u8)BFI_VLAN_BMASK_ALL;\r\nrxf->vlan_strip_status = q_config->vlan_strip_status;\r\nbfa_fsm_set_state(rxf, bna_rxf_sm_stopped);\r\n}\r\nstatic void\r\nbna_rxf_uninit(struct bna_rxf *rxf)\r\n{\r\nstruct bna_mac *mac;\r\nrxf->ucast_pending_set = 0;\r\nrxf->ucast_active_set = 0;\r\nwhile (!list_empty(&rxf->ucast_pending_add_q)) {\r\nbfa_q_deq(&rxf->ucast_pending_add_q, &mac);\r\nbfa_q_qe_init(&mac->qe);\r\nbna_ucam_mod_mac_put(&rxf->rx->bna->ucam_mod, mac);\r\n}\r\nif (rxf->ucast_pending_mac) {\r\nbfa_q_qe_init(&rxf->ucast_pending_mac->qe);\r\nbna_ucam_mod_mac_put(&rxf->rx->bna->ucam_mod,\r\nrxf->ucast_pending_mac);\r\nrxf->ucast_pending_mac = NULL;\r\n}\r\nwhile (!list_empty(&rxf->mcast_pending_add_q)) {\r\nbfa_q_deq(&rxf->mcast_pending_add_q, &mac);\r\nbfa_q_qe_init(&mac->qe);\r\nbna_mcam_mod_mac_put(&rxf->rx->bna->mcam_mod, mac);\r\n}\r\nrxf->rxmode_pending = 0;\r\nrxf->rxmode_pending_bitmask = 0;\r\nif (rxf->rx->bna->promisc_rid == rxf->rx->rid)\r\nrxf->rx->bna->promisc_rid = BFI_INVALID_RID;\r\nif (rxf->rx->bna->default_mode_rid == rxf->rx->rid)\r\nrxf->rx->bna->default_mode_rid = BFI_INVALID_RID;\r\nrxf->rss_pending = 0;\r\nrxf->vlan_strip_pending = false;\r\nrxf->flags = 0;\r\nrxf->rx = NULL;\r\n}\r\nstatic void\r\nbna_rx_cb_rxf_started(struct bna_rx *rx)\r\n{\r\nbfa_fsm_send_event(rx, RX_E_RXF_STARTED);\r\n}\r\nstatic void\r\nbna_rxf_start(struct bna_rxf *rxf)\r\n{\r\nrxf->start_cbfn = bna_rx_cb_rxf_started;\r\nrxf->start_cbarg = rxf->rx;\r\nbfa_fsm_send_event(rxf, RXF_E_START);\r\n}\r\nstatic void\r\nbna_rx_cb_rxf_stopped(struct bna_rx *rx)\r\n{\r\nbfa_fsm_send_event(rx, RX_E_RXF_STOPPED);\r\n}\r\nstatic void\r\nbna_rxf_stop(struct bna_rxf *rxf)\r\n{\r\nrxf->stop_cbfn = bna_rx_cb_rxf_stopped;\r\nrxf->stop_cbarg = rxf->rx;\r\nbfa_fsm_send_event(rxf, RXF_E_STOP);\r\n}\r\nstatic void\r\nbna_rxf_fail(struct bna_rxf *rxf)\r\n{\r\nbfa_fsm_send_event(rxf, RXF_E_FAIL);\r\n}\r\nenum bna_cb_status\r\nbna_rx_ucast_set(struct bna_rx *rx, u8 *ucmac,\r\nvoid (*cbfn)(struct bnad *, struct bna_rx *))\r\n{\r\nstruct bna_rxf *rxf = &rx->rxf;\r\nif (rxf->ucast_pending_mac == NULL) {\r\nrxf->ucast_pending_mac =\r\nbna_ucam_mod_mac_get(&rxf->rx->bna->ucam_mod);\r\nif (rxf->ucast_pending_mac == NULL)\r\nreturn BNA_CB_UCAST_CAM_FULL;\r\nbfa_q_qe_init(&rxf->ucast_pending_mac->qe);\r\n}\r\nmemcpy(rxf->ucast_pending_mac->addr, ucmac, ETH_ALEN);\r\nrxf->ucast_pending_set = 1;\r\nrxf->cam_fltr_cbfn = cbfn;\r\nrxf->cam_fltr_cbarg = rx->bna->bnad;\r\nbfa_fsm_send_event(rxf, RXF_E_CONFIG);\r\nreturn BNA_CB_SUCCESS;\r\n}\r\nenum bna_cb_status\r\nbna_rx_mcast_add(struct bna_rx *rx, u8 *addr,\r\nvoid (*cbfn)(struct bnad *, struct bna_rx *))\r\n{\r\nstruct bna_rxf *rxf = &rx->rxf;\r\nstruct bna_mac *mac;\r\nif (bna_mac_find(&rxf->mcast_active_q, addr) ||\r\nbna_mac_find(&rxf->mcast_pending_add_q, addr)) {\r\nif (cbfn)\r\ncbfn(rx->bna->bnad, rx);\r\nreturn BNA_CB_SUCCESS;\r\n}\r\nmac = bna_mcam_mod_mac_get(&rxf->rx->bna->mcam_mod);\r\nif (mac == NULL)\r\nreturn BNA_CB_MCAST_LIST_FULL;\r\nbfa_q_qe_init(&mac->qe);\r\nmemcpy(mac->addr, addr, ETH_ALEN);\r\nlist_add_tail(&mac->qe, &rxf->mcast_pending_add_q);\r\nrxf->cam_fltr_cbfn = cbfn;\r\nrxf->cam_fltr_cbarg = rx->bna->bnad;\r\nbfa_fsm_send_event(rxf, RXF_E_CONFIG);\r\nreturn BNA_CB_SUCCESS;\r\n}\r\nenum bna_cb_status\r\nbna_rx_mcast_listset(struct bna_rx *rx, int count, u8 *mclist,\r\nvoid (*cbfn)(struct bnad *, struct bna_rx *))\r\n{\r\nstruct bna_rxf *rxf = &rx->rxf;\r\nstruct list_head list_head;\r\nstruct list_head *qe;\r\nu8 *mcaddr;\r\nstruct bna_mac *mac;\r\nint i;\r\nINIT_LIST_HEAD(&list_head);\r\nfor (i = 0, mcaddr = mclist; i < count; i++) {\r\nmac = bna_mcam_mod_mac_get(&rxf->rx->bna->mcam_mod);\r\nif (mac == NULL)\r\ngoto err_return;\r\nbfa_q_qe_init(&mac->qe);\r\nmemcpy(mac->addr, mcaddr, ETH_ALEN);\r\nlist_add_tail(&mac->qe, &list_head);\r\nmcaddr += ETH_ALEN;\r\n}\r\nwhile (!list_empty(&rxf->mcast_pending_add_q)) {\r\nbfa_q_deq(&rxf->mcast_pending_add_q, &qe);\r\nbfa_q_qe_init(qe);\r\nmac = (struct bna_mac *)qe;\r\nbna_mcam_mod_mac_put(&rxf->rx->bna->mcam_mod, mac);\r\n}\r\nwhile (!list_empty(&rxf->mcast_active_q)) {\r\nbfa_q_deq(&rxf->mcast_active_q, &qe);\r\nmac = (struct bna_mac *)qe;\r\nbfa_q_qe_init(&mac->qe);\r\nlist_add_tail(&mac->qe, &rxf->mcast_pending_del_q);\r\n}\r\nwhile (!list_empty(&list_head)) {\r\nbfa_q_deq(&list_head, &qe);\r\nmac = (struct bna_mac *)qe;\r\nbfa_q_qe_init(&mac->qe);\r\nlist_add_tail(&mac->qe, &rxf->mcast_pending_add_q);\r\n}\r\nrxf->cam_fltr_cbfn = cbfn;\r\nrxf->cam_fltr_cbarg = rx->bna->bnad;\r\nbfa_fsm_send_event(rxf, RXF_E_CONFIG);\r\nreturn BNA_CB_SUCCESS;\r\nerr_return:\r\nwhile (!list_empty(&list_head)) {\r\nbfa_q_deq(&list_head, &qe);\r\nmac = (struct bna_mac *)qe;\r\nbfa_q_qe_init(&mac->qe);\r\nbna_mcam_mod_mac_put(&rxf->rx->bna->mcam_mod, mac);\r\n}\r\nreturn BNA_CB_MCAST_LIST_FULL;\r\n}\r\nvoid\r\nbna_rx_vlan_add(struct bna_rx *rx, int vlan_id)\r\n{\r\nstruct bna_rxf *rxf = &rx->rxf;\r\nint index = (vlan_id >> BFI_VLAN_WORD_SHIFT);\r\nint bit = (1 << (vlan_id & BFI_VLAN_WORD_MASK));\r\nint group_id = (vlan_id >> BFI_VLAN_BLOCK_SHIFT);\r\nrxf->vlan_filter_table[index] |= bit;\r\nif (rxf->vlan_filter_status == BNA_STATUS_T_ENABLED) {\r\nrxf->vlan_pending_bitmask |= (1 << group_id);\r\nbfa_fsm_send_event(rxf, RXF_E_CONFIG);\r\n}\r\n}\r\nvoid\r\nbna_rx_vlan_del(struct bna_rx *rx, int vlan_id)\r\n{\r\nstruct bna_rxf *rxf = &rx->rxf;\r\nint index = (vlan_id >> BFI_VLAN_WORD_SHIFT);\r\nint bit = (1 << (vlan_id & BFI_VLAN_WORD_MASK));\r\nint group_id = (vlan_id >> BFI_VLAN_BLOCK_SHIFT);\r\nrxf->vlan_filter_table[index] &= ~bit;\r\nif (rxf->vlan_filter_status == BNA_STATUS_T_ENABLED) {\r\nrxf->vlan_pending_bitmask |= (1 << group_id);\r\nbfa_fsm_send_event(rxf, RXF_E_CONFIG);\r\n}\r\n}\r\nstatic int\r\nbna_rxf_ucast_cfg_apply(struct bna_rxf *rxf)\r\n{\r\nstruct bna_mac *mac = NULL;\r\nstruct list_head *qe;\r\nif (!list_empty(&rxf->ucast_pending_del_q)) {\r\nbfa_q_deq(&rxf->ucast_pending_del_q, &qe);\r\nbfa_q_qe_init(qe);\r\nmac = (struct bna_mac *)qe;\r\nbna_bfi_ucast_req(rxf, mac, BFI_ENET_H2I_MAC_UCAST_DEL_REQ);\r\nbna_ucam_mod_mac_put(&rxf->rx->bna->ucam_mod, mac);\r\nreturn 1;\r\n}\r\nif (rxf->ucast_pending_set) {\r\nrxf->ucast_pending_set = 0;\r\nmemcpy(rxf->ucast_active_mac.addr,\r\nrxf->ucast_pending_mac->addr, ETH_ALEN);\r\nrxf->ucast_active_set = 1;\r\nbna_bfi_ucast_req(rxf, &rxf->ucast_active_mac,\r\nBFI_ENET_H2I_MAC_UCAST_SET_REQ);\r\nreturn 1;\r\n}\r\nif (!list_empty(&rxf->ucast_pending_add_q)) {\r\nbfa_q_deq(&rxf->ucast_pending_add_q, &qe);\r\nbfa_q_qe_init(qe);\r\nmac = (struct bna_mac *)qe;\r\nlist_add_tail(&mac->qe, &rxf->ucast_active_q);\r\nbna_bfi_ucast_req(rxf, mac, BFI_ENET_H2I_MAC_UCAST_ADD_REQ);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nbna_rxf_ucast_cfg_reset(struct bna_rxf *rxf, enum bna_cleanup_type cleanup)\r\n{\r\nstruct list_head *qe;\r\nstruct bna_mac *mac;\r\nwhile (!list_empty(&rxf->ucast_pending_del_q)) {\r\nbfa_q_deq(&rxf->ucast_pending_del_q, &qe);\r\nbfa_q_qe_init(qe);\r\nmac = (struct bna_mac *)qe;\r\nif (cleanup == BNA_SOFT_CLEANUP)\r\nbna_ucam_mod_mac_put(&rxf->rx->bna->ucam_mod, mac);\r\nelse {\r\nbna_bfi_ucast_req(rxf, mac,\r\nBFI_ENET_H2I_MAC_UCAST_DEL_REQ);\r\nbna_ucam_mod_mac_put(&rxf->rx->bna->ucam_mod, mac);\r\nreturn 1;\r\n}\r\n}\r\nwhile (!list_empty(&rxf->ucast_active_q)) {\r\nbfa_q_deq(&rxf->ucast_active_q, &qe);\r\nbfa_q_qe_init(qe);\r\nlist_add_tail(qe, &rxf->ucast_pending_add_q);\r\nif (cleanup == BNA_HARD_CLEANUP) {\r\nmac = (struct bna_mac *)qe;\r\nbna_bfi_ucast_req(rxf, mac,\r\nBFI_ENET_H2I_MAC_UCAST_DEL_REQ);\r\nreturn 1;\r\n}\r\n}\r\nif (rxf->ucast_active_set) {\r\nrxf->ucast_pending_set = 1;\r\nrxf->ucast_active_set = 0;\r\nif (cleanup == BNA_HARD_CLEANUP) {\r\nbna_bfi_ucast_req(rxf, &rxf->ucast_active_mac,\r\nBFI_ENET_H2I_MAC_UCAST_CLR_REQ);\r\nreturn 1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nbna_rxf_promisc_cfg_apply(struct bna_rxf *rxf)\r\n{\r\nstruct bna *bna = rxf->rx->bna;\r\nif (is_promisc_enable(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask)) {\r\npromisc_inactive(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask);\r\nrxf->rxmode_active |= BNA_RXMODE_PROMISC;\r\nbna_bfi_rx_promisc_req(rxf, BNA_STATUS_T_ENABLED);\r\nreturn 1;\r\n} else if (is_promisc_disable(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask)) {\r\npromisc_inactive(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask);\r\nrxf->rxmode_active &= ~BNA_RXMODE_PROMISC;\r\nbna->promisc_rid = BFI_INVALID_RID;\r\nbna_bfi_rx_promisc_req(rxf, BNA_STATUS_T_DISABLED);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nbna_rxf_promisc_cfg_reset(struct bna_rxf *rxf, enum bna_cleanup_type cleanup)\r\n{\r\nstruct bna *bna = rxf->rx->bna;\r\nif (is_promisc_disable(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask)) {\r\npromisc_inactive(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask);\r\nrxf->rxmode_active &= ~BNA_RXMODE_PROMISC;\r\nbna->promisc_rid = BFI_INVALID_RID;\r\nif (cleanup == BNA_HARD_CLEANUP) {\r\nbna_bfi_rx_promisc_req(rxf, BNA_STATUS_T_DISABLED);\r\nreturn 1;\r\n}\r\n}\r\nif (rxf->rxmode_active & BNA_RXMODE_PROMISC) {\r\npromisc_enable(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask);\r\nrxf->rxmode_active &= ~BNA_RXMODE_PROMISC;\r\nif (cleanup == BNA_HARD_CLEANUP) {\r\nbna_bfi_rx_promisc_req(rxf, BNA_STATUS_T_DISABLED);\r\nreturn 1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nbna_rxf_allmulti_cfg_apply(struct bna_rxf *rxf)\r\n{\r\nif (is_allmulti_enable(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask)) {\r\nallmulti_inactive(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask);\r\nrxf->rxmode_active |= BNA_RXMODE_ALLMULTI;\r\nbna_bfi_mcast_filter_req(rxf, BNA_STATUS_T_DISABLED);\r\nreturn 1;\r\n} else if (is_allmulti_disable(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask)) {\r\nallmulti_inactive(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask);\r\nrxf->rxmode_active &= ~BNA_RXMODE_ALLMULTI;\r\nbna_bfi_mcast_filter_req(rxf, BNA_STATUS_T_ENABLED);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nbna_rxf_allmulti_cfg_reset(struct bna_rxf *rxf, enum bna_cleanup_type cleanup)\r\n{\r\nif (is_allmulti_disable(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask)) {\r\nallmulti_inactive(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask);\r\nrxf->rxmode_active &= ~BNA_RXMODE_ALLMULTI;\r\nif (cleanup == BNA_HARD_CLEANUP) {\r\nbna_bfi_mcast_filter_req(rxf, BNA_STATUS_T_ENABLED);\r\nreturn 1;\r\n}\r\n}\r\nif (rxf->rxmode_active & BNA_RXMODE_ALLMULTI) {\r\nallmulti_enable(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask);\r\nrxf->rxmode_active &= ~BNA_RXMODE_ALLMULTI;\r\nif (cleanup == BNA_HARD_CLEANUP) {\r\nbna_bfi_mcast_filter_req(rxf, BNA_STATUS_T_ENABLED);\r\nreturn 1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nbna_rxf_promisc_enable(struct bna_rxf *rxf)\r\n{\r\nstruct bna *bna = rxf->rx->bna;\r\nint ret = 0;\r\nif (is_promisc_enable(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask) ||\r\n(rxf->rxmode_active & BNA_RXMODE_PROMISC)) {\r\n} else if (is_promisc_disable(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask)) {\r\npromisc_inactive(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask);\r\n} else {\r\npromisc_enable(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask);\r\nbna->promisc_rid = rxf->rx->rid;\r\nret = 1;\r\n}\r\nreturn ret;\r\n}\r\nstatic int\r\nbna_rxf_promisc_disable(struct bna_rxf *rxf)\r\n{\r\nstruct bna *bna = rxf->rx->bna;\r\nint ret = 0;\r\nif (is_promisc_disable(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask) ||\r\n(!(rxf->rxmode_active & BNA_RXMODE_PROMISC))) {\r\n} else if (is_promisc_enable(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask)) {\r\npromisc_inactive(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask);\r\nbna->promisc_rid = BFI_INVALID_RID;\r\n} else if (rxf->rxmode_active & BNA_RXMODE_PROMISC) {\r\npromisc_disable(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask);\r\nret = 1;\r\n}\r\nreturn ret;\r\n}\r\nstatic int\r\nbna_rxf_allmulti_enable(struct bna_rxf *rxf)\r\n{\r\nint ret = 0;\r\nif (is_allmulti_enable(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask) ||\r\n(rxf->rxmode_active & BNA_RXMODE_ALLMULTI)) {\r\n} else if (is_allmulti_disable(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask)) {\r\nallmulti_inactive(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask);\r\n} else {\r\nallmulti_enable(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask);\r\nret = 1;\r\n}\r\nreturn ret;\r\n}\r\nstatic int\r\nbna_rxf_allmulti_disable(struct bna_rxf *rxf)\r\n{\r\nint ret = 0;\r\nif (is_allmulti_disable(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask) ||\r\n(!(rxf->rxmode_active & BNA_RXMODE_ALLMULTI))) {\r\n} else if (is_allmulti_enable(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask)) {\r\nallmulti_inactive(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask);\r\n} else if (rxf->rxmode_active & BNA_RXMODE_ALLMULTI) {\r\nallmulti_disable(rxf->rxmode_pending,\r\nrxf->rxmode_pending_bitmask);\r\nret = 1;\r\n}\r\nreturn ret;\r\n}\r\nstatic int\r\nbna_rxf_vlan_strip_cfg_apply(struct bna_rxf *rxf)\r\n{\r\nif (rxf->vlan_strip_pending) {\r\nrxf->vlan_strip_pending = false;\r\nbna_bfi_vlan_strip_enable(rxf);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic void bna_rx_sm_stopped_entry(struct bna_rx *rx)\r\n{\r\ncall_rx_stop_cbfn(rx);\r\n}\r\nstatic void bna_rx_sm_stopped(struct bna_rx *rx,\r\nenum bna_rx_event event)\r\n{\r\nswitch (event) {\r\ncase RX_E_START:\r\nbfa_fsm_set_state(rx, bna_rx_sm_start_wait);\r\nbreak;\r\ncase RX_E_STOP:\r\ncall_rx_stop_cbfn(rx);\r\nbreak;\r\ncase RX_E_FAIL:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\nbreak;\r\n}\r\n}\r\nstatic void bna_rx_sm_start_wait_entry(struct bna_rx *rx)\r\n{\r\nbna_bfi_rx_enet_start(rx);\r\n}\r\nvoid\r\nbna_rx_sm_stop_wait_entry(struct bna_rx *rx)\r\n{\r\n}\r\nstatic void\r\nbna_rx_sm_stop_wait(struct bna_rx *rx, enum bna_rx_event event)\r\n{\r\nswitch (event) {\r\ncase RX_E_FAIL:\r\ncase RX_E_STOPPED:\r\nbfa_fsm_set_state(rx, bna_rx_sm_cleanup_wait);\r\nrx->rx_cleanup_cbfn(rx->bna->bnad, rx);\r\nbreak;\r\ncase RX_E_STARTED:\r\nbna_rx_enet_stop(rx);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\nbreak;\r\n}\r\n}\r\nstatic void bna_rx_sm_start_wait(struct bna_rx *rx,\r\nenum bna_rx_event event)\r\n{\r\nswitch (event) {\r\ncase RX_E_STOP:\r\nbfa_fsm_set_state(rx, bna_rx_sm_start_stop_wait);\r\nbreak;\r\ncase RX_E_FAIL:\r\nbfa_fsm_set_state(rx, bna_rx_sm_stopped);\r\nbreak;\r\ncase RX_E_STARTED:\r\nbfa_fsm_set_state(rx, bna_rx_sm_rxf_start_wait);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\nbreak;\r\n}\r\n}\r\nstatic void bna_rx_sm_rxf_start_wait_entry(struct bna_rx *rx)\r\n{\r\nrx->rx_post_cbfn(rx->bna->bnad, rx);\r\nbna_rxf_start(&rx->rxf);\r\n}\r\nvoid\r\nbna_rx_sm_rxf_stop_wait_entry(struct bna_rx *rx)\r\n{\r\n}\r\nstatic void\r\nbna_rx_sm_rxf_stop_wait(struct bna_rx *rx, enum bna_rx_event event)\r\n{\r\nswitch (event) {\r\ncase RX_E_FAIL:\r\nbfa_fsm_set_state(rx, bna_rx_sm_cleanup_wait);\r\nbna_rxf_fail(&rx->rxf);\r\ncall_rx_stall_cbfn(rx);\r\nrx->rx_cleanup_cbfn(rx->bna->bnad, rx);\r\nbreak;\r\ncase RX_E_RXF_STARTED:\r\nbna_rxf_stop(&rx->rxf);\r\nbreak;\r\ncase RX_E_RXF_STOPPED:\r\nbfa_fsm_set_state(rx, bna_rx_sm_stop_wait);\r\ncall_rx_stall_cbfn(rx);\r\nbna_rx_enet_stop(rx);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\nbreak;\r\n}\r\n}\r\nstatic void\r\nbna_rx_sm_start_stop_wait_entry(struct bna_rx *rx)\r\n{\r\n}\r\nstatic void\r\nbna_rx_sm_start_stop_wait(struct bna_rx *rx, enum bna_rx_event event)\r\n{\r\nswitch (event) {\r\ncase RX_E_FAIL:\r\ncase RX_E_STOPPED:\r\nbfa_fsm_set_state(rx, bna_rx_sm_stopped);\r\nbreak;\r\ncase RX_E_STARTED:\r\nbna_rx_enet_stop(rx);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nvoid\r\nbna_rx_sm_started_entry(struct bna_rx *rx)\r\n{\r\nstruct bna_rxp *rxp;\r\nstruct list_head *qe_rxp;\r\nint is_regular = (rx->type == BNA_RX_T_REGULAR);\r\nlist_for_each(qe_rxp, &rx->rxp_q) {\r\nrxp = (struct bna_rxp *)qe_rxp;\r\nbna_ib_start(rx->bna, &rxp->cq.ib, is_regular);\r\n}\r\nbna_ethport_cb_rx_started(&rx->bna->ethport);\r\n}\r\nstatic void\r\nbna_rx_sm_started(struct bna_rx *rx, enum bna_rx_event event)\r\n{\r\nswitch (event) {\r\ncase RX_E_STOP:\r\nbfa_fsm_set_state(rx, bna_rx_sm_rxf_stop_wait);\r\nbna_ethport_cb_rx_stopped(&rx->bna->ethport);\r\nbna_rxf_stop(&rx->rxf);\r\nbreak;\r\ncase RX_E_FAIL:\r\nbfa_fsm_set_state(rx, bna_rx_sm_failed);\r\nbna_ethport_cb_rx_stopped(&rx->bna->ethport);\r\nbna_rxf_fail(&rx->rxf);\r\ncall_rx_stall_cbfn(rx);\r\nrx->rx_cleanup_cbfn(rx->bna->bnad, rx);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\nbreak;\r\n}\r\n}\r\nstatic void bna_rx_sm_rxf_start_wait(struct bna_rx *rx,\r\nenum bna_rx_event event)\r\n{\r\nswitch (event) {\r\ncase RX_E_STOP:\r\nbfa_fsm_set_state(rx, bna_rx_sm_rxf_stop_wait);\r\nbreak;\r\ncase RX_E_FAIL:\r\nbfa_fsm_set_state(rx, bna_rx_sm_failed);\r\nbna_rxf_fail(&rx->rxf);\r\ncall_rx_stall_cbfn(rx);\r\nrx->rx_cleanup_cbfn(rx->bna->bnad, rx);\r\nbreak;\r\ncase RX_E_RXF_STARTED:\r\nbfa_fsm_set_state(rx, bna_rx_sm_started);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\nbreak;\r\n}\r\n}\r\nvoid\r\nbna_rx_sm_cleanup_wait_entry(struct bna_rx *rx)\r\n{\r\n}\r\nvoid\r\nbna_rx_sm_cleanup_wait(struct bna_rx *rx, enum bna_rx_event event)\r\n{\r\nswitch (event) {\r\ncase RX_E_FAIL:\r\ncase RX_E_RXF_STOPPED:\r\nbreak;\r\ncase RX_E_CLEANUP_DONE:\r\nbfa_fsm_set_state(rx, bna_rx_sm_stopped);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\nbreak;\r\n}\r\n}\r\nstatic void\r\nbna_rx_sm_failed_entry(struct bna_rx *rx)\r\n{\r\n}\r\nstatic void\r\nbna_rx_sm_failed(struct bna_rx *rx, enum bna_rx_event event)\r\n{\r\nswitch (event) {\r\ncase RX_E_START:\r\nbfa_fsm_set_state(rx, bna_rx_sm_quiesce_wait);\r\nbreak;\r\ncase RX_E_STOP:\r\nbfa_fsm_set_state(rx, bna_rx_sm_cleanup_wait);\r\nbreak;\r\ncase RX_E_FAIL:\r\ncase RX_E_RXF_STARTED:\r\ncase RX_E_RXF_STOPPED:\r\nbreak;\r\ncase RX_E_CLEANUP_DONE:\r\nbfa_fsm_set_state(rx, bna_rx_sm_stopped);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\nbreak;\r\n} }\r\nstatic void\r\nbna_rx_sm_quiesce_wait_entry(struct bna_rx *rx)\r\n{\r\n}\r\nstatic void\r\nbna_rx_sm_quiesce_wait(struct bna_rx *rx, enum bna_rx_event event)\r\n{\r\nswitch (event) {\r\ncase RX_E_STOP:\r\nbfa_fsm_set_state(rx, bna_rx_sm_cleanup_wait);\r\nbreak;\r\ncase RX_E_FAIL:\r\nbfa_fsm_set_state(rx, bna_rx_sm_failed);\r\nbreak;\r\ncase RX_E_CLEANUP_DONE:\r\nbfa_fsm_set_state(rx, bna_rx_sm_start_wait);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\nbreak;\r\n}\r\n}\r\nstatic void\r\nbna_bfi_rx_enet_start(struct bna_rx *rx)\r\n{\r\nstruct bfi_enet_rx_cfg_req *cfg_req = &rx->bfi_enet_cmd.cfg_req;\r\nstruct bna_rxp *rxp = NULL;\r\nstruct bna_rxq *q0 = NULL, *q1 = NULL;\r\nstruct list_head *rxp_qe;\r\nint i;\r\nbfi_msgq_mhdr_set(cfg_req->mh, BFI_MC_ENET,\r\nBFI_ENET_H2I_RX_CFG_SET_REQ, 0, rx->rid);\r\ncfg_req->mh.num_entries = htons(\r\nbfi_msgq_num_cmd_entries(sizeof(struct bfi_enet_rx_cfg_req)));\r\ncfg_req->num_queue_sets = rx->num_paths;\r\nfor (i = 0, rxp_qe = bfa_q_first(&rx->rxp_q);\r\ni < rx->num_paths;\r\ni++, rxp_qe = bfa_q_next(rxp_qe)) {\r\nrxp = (struct bna_rxp *)rxp_qe;\r\nGET_RXQS(rxp, q0, q1);\r\nswitch (rxp->type) {\r\ncase BNA_RXP_SLR:\r\ncase BNA_RXP_HDS:\r\nbfi_enet_datapath_q_init(&cfg_req->q_cfg[i].qs.q,\r\n&q1->qpt);\r\ncfg_req->q_cfg[i].qs.rx_buffer_size =\r\nhtons((u16)q1->buffer_size);\r\ncase BNA_RXP_SINGLE:\r\nbfi_enet_datapath_q_init(&cfg_req->q_cfg[i].ql.q,\r\n&q0->qpt);\r\nq0->buffer_size =\r\nbna_enet_mtu_get(&rx->bna->enet);\r\ncfg_req->q_cfg[i].ql.rx_buffer_size =\r\nhtons((u16)q0->buffer_size);\r\nbreak;\r\ndefault:\r\nBUG_ON(1);\r\n}\r\nbfi_enet_datapath_q_init(&cfg_req->q_cfg[i].cq.q,\r\n&rxp->cq.qpt);\r\ncfg_req->q_cfg[i].ib.index_addr.a32.addr_lo =\r\nrxp->cq.ib.ib_seg_host_addr.lsb;\r\ncfg_req->q_cfg[i].ib.index_addr.a32.addr_hi =\r\nrxp->cq.ib.ib_seg_host_addr.msb;\r\ncfg_req->q_cfg[i].ib.intr.msix_index =\r\nhtons((u16)rxp->cq.ib.intr_vector);\r\n}\r\ncfg_req->ib_cfg.int_pkt_dma = BNA_STATUS_T_DISABLED;\r\ncfg_req->ib_cfg.int_enabled = BNA_STATUS_T_ENABLED;\r\ncfg_req->ib_cfg.int_pkt_enabled = BNA_STATUS_T_DISABLED;\r\ncfg_req->ib_cfg.continuous_coalescing = BNA_STATUS_T_DISABLED;\r\ncfg_req->ib_cfg.msix = (rxp->cq.ib.intr_type == BNA_INTR_T_MSIX)\r\n? BNA_STATUS_T_ENABLED :\r\nBNA_STATUS_T_DISABLED;\r\ncfg_req->ib_cfg.coalescing_timeout =\r\nhtonl((u32)rxp->cq.ib.coalescing_timeo);\r\ncfg_req->ib_cfg.inter_pkt_timeout =\r\nhtonl((u32)rxp->cq.ib.interpkt_timeo);\r\ncfg_req->ib_cfg.inter_pkt_count = (u8)rxp->cq.ib.interpkt_count;\r\nswitch (rxp->type) {\r\ncase BNA_RXP_SLR:\r\ncfg_req->rx_cfg.rxq_type = BFI_ENET_RXQ_LARGE_SMALL;\r\nbreak;\r\ncase BNA_RXP_HDS:\r\ncfg_req->rx_cfg.rxq_type = BFI_ENET_RXQ_HDS;\r\ncfg_req->rx_cfg.hds.type = rx->hds_cfg.hdr_type;\r\ncfg_req->rx_cfg.hds.force_offset = rx->hds_cfg.forced_offset;\r\ncfg_req->rx_cfg.hds.max_header_size = rx->hds_cfg.forced_offset;\r\nbreak;\r\ncase BNA_RXP_SINGLE:\r\ncfg_req->rx_cfg.rxq_type = BFI_ENET_RXQ_SINGLE;\r\nbreak;\r\ndefault:\r\nBUG_ON(1);\r\n}\r\ncfg_req->rx_cfg.strip_vlan = rx->rxf.vlan_strip_status;\r\nbfa_msgq_cmd_set(&rx->msgq_cmd, NULL, NULL,\r\nsizeof(struct bfi_enet_rx_cfg_req), &cfg_req->mh);\r\nbfa_msgq_cmd_post(&rx->bna->msgq, &rx->msgq_cmd);\r\n}\r\nstatic void\r\nbna_bfi_rx_enet_stop(struct bna_rx *rx)\r\n{\r\nstruct bfi_enet_req *req = &rx->bfi_enet_cmd.req;\r\nbfi_msgq_mhdr_set(req->mh, BFI_MC_ENET,\r\nBFI_ENET_H2I_RX_CFG_CLR_REQ, 0, rx->rid);\r\nreq->mh.num_entries = htons(\r\nbfi_msgq_num_cmd_entries(sizeof(struct bfi_enet_req)));\r\nbfa_msgq_cmd_set(&rx->msgq_cmd, NULL, NULL, sizeof(struct bfi_enet_req),\r\n&req->mh);\r\nbfa_msgq_cmd_post(&rx->bna->msgq, &rx->msgq_cmd);\r\n}\r\nstatic void\r\nbna_rx_enet_stop(struct bna_rx *rx)\r\n{\r\nstruct bna_rxp *rxp;\r\nstruct list_head *qe_rxp;\r\nlist_for_each(qe_rxp, &rx->rxp_q) {\r\nrxp = (struct bna_rxp *)qe_rxp;\r\nbna_ib_stop(rx->bna, &rxp->cq.ib);\r\n}\r\nbna_bfi_rx_enet_stop(rx);\r\n}\r\nstatic int\r\nbna_rx_res_check(struct bna_rx_mod *rx_mod, struct bna_rx_config *rx_cfg)\r\n{\r\nif ((rx_mod->rx_free_count == 0) ||\r\n(rx_mod->rxp_free_count == 0) ||\r\n(rx_mod->rxq_free_count == 0))\r\nreturn 0;\r\nif (rx_cfg->rxp_type == BNA_RXP_SINGLE) {\r\nif ((rx_mod->rxp_free_count < rx_cfg->num_paths) ||\r\n(rx_mod->rxq_free_count < rx_cfg->num_paths))\r\nreturn 0;\r\n} else {\r\nif ((rx_mod->rxp_free_count < rx_cfg->num_paths) ||\r\n(rx_mod->rxq_free_count < (2 * rx_cfg->num_paths)))\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic struct bna_rxq *\r\nbna_rxq_get(struct bna_rx_mod *rx_mod)\r\n{\r\nstruct bna_rxq *rxq = NULL;\r\nstruct list_head *qe = NULL;\r\nbfa_q_deq(&rx_mod->rxq_free_q, &qe);\r\nrx_mod->rxq_free_count--;\r\nrxq = (struct bna_rxq *)qe;\r\nbfa_q_qe_init(&rxq->qe);\r\nreturn rxq;\r\n}\r\nstatic void\r\nbna_rxq_put(struct bna_rx_mod *rx_mod, struct bna_rxq *rxq)\r\n{\r\nbfa_q_qe_init(&rxq->qe);\r\nlist_add_tail(&rxq->qe, &rx_mod->rxq_free_q);\r\nrx_mod->rxq_free_count++;\r\n}\r\nstatic struct bna_rxp *\r\nbna_rxp_get(struct bna_rx_mod *rx_mod)\r\n{\r\nstruct list_head *qe = NULL;\r\nstruct bna_rxp *rxp = NULL;\r\nbfa_q_deq(&rx_mod->rxp_free_q, &qe);\r\nrx_mod->rxp_free_count--;\r\nrxp = (struct bna_rxp *)qe;\r\nbfa_q_qe_init(&rxp->qe);\r\nreturn rxp;\r\n}\r\nstatic void\r\nbna_rxp_put(struct bna_rx_mod *rx_mod, struct bna_rxp *rxp)\r\n{\r\nbfa_q_qe_init(&rxp->qe);\r\nlist_add_tail(&rxp->qe, &rx_mod->rxp_free_q);\r\nrx_mod->rxp_free_count++;\r\n}\r\nstatic struct bna_rx *\r\nbna_rx_get(struct bna_rx_mod *rx_mod, enum bna_rx_type type)\r\n{\r\nstruct list_head *qe = NULL;\r\nstruct bna_rx *rx = NULL;\r\nif (type == BNA_RX_T_REGULAR) {\r\nbfa_q_deq(&rx_mod->rx_free_q, &qe);\r\n} else\r\nbfa_q_deq_tail(&rx_mod->rx_free_q, &qe);\r\nrx_mod->rx_free_count--;\r\nrx = (struct bna_rx *)qe;\r\nbfa_q_qe_init(&rx->qe);\r\nlist_add_tail(&rx->qe, &rx_mod->rx_active_q);\r\nrx->type = type;\r\nreturn rx;\r\n}\r\nstatic void\r\nbna_rx_put(struct bna_rx_mod *rx_mod, struct bna_rx *rx)\r\n{\r\nstruct list_head *prev_qe = NULL;\r\nstruct list_head *qe;\r\nbfa_q_qe_init(&rx->qe);\r\nlist_for_each(qe, &rx_mod->rx_free_q) {\r\nif (((struct bna_rx *)qe)->rid < rx->rid)\r\nprev_qe = qe;\r\nelse\r\nbreak;\r\n}\r\nif (prev_qe == NULL) {\r\nbfa_q_enq_head(&rx_mod->rx_free_q, &rx->qe);\r\n} else if (bfa_q_next(prev_qe) == &rx_mod->rx_free_q) {\r\nlist_add_tail(&rx->qe, &rx_mod->rx_free_q);\r\n} else {\r\nbfa_q_next(&rx->qe) = bfa_q_next(prev_qe);\r\nbfa_q_prev(&rx->qe) = prev_qe;\r\nbfa_q_next(prev_qe) = &rx->qe;\r\nbfa_q_prev(bfa_q_next(&rx->qe)) = &rx->qe;\r\n}\r\nrx_mod->rx_free_count++;\r\n}\r\nstatic void\r\nbna_rxp_add_rxqs(struct bna_rxp *rxp, struct bna_rxq *q0,\r\nstruct bna_rxq *q1)\r\n{\r\nswitch (rxp->type) {\r\ncase BNA_RXP_SINGLE:\r\nrxp->rxq.single.only = q0;\r\nrxp->rxq.single.reserved = NULL;\r\nbreak;\r\ncase BNA_RXP_SLR:\r\nrxp->rxq.slr.large = q0;\r\nrxp->rxq.slr.small = q1;\r\nbreak;\r\ncase BNA_RXP_HDS:\r\nrxp->rxq.hds.data = q0;\r\nrxp->rxq.hds.hdr = q1;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic void\r\nbna_rxq_qpt_setup(struct bna_rxq *rxq,\r\nstruct bna_rxp *rxp,\r\nu32 page_count,\r\nu32 page_size,\r\nstruct bna_mem_descr *qpt_mem,\r\nstruct bna_mem_descr *swqpt_mem,\r\nstruct bna_mem_descr *page_mem)\r\n{\r\nu8 *kva;\r\nu64 dma;\r\nstruct bna_dma_addr bna_dma;\r\nint i;\r\nrxq->qpt.hw_qpt_ptr.lsb = qpt_mem->dma.lsb;\r\nrxq->qpt.hw_qpt_ptr.msb = qpt_mem->dma.msb;\r\nrxq->qpt.kv_qpt_ptr = qpt_mem->kva;\r\nrxq->qpt.page_count = page_count;\r\nrxq->qpt.page_size = page_size;\r\nrxq->rcb->sw_qpt = (void **) swqpt_mem->kva;\r\nrxq->rcb->sw_q = page_mem->kva;\r\nkva = page_mem->kva;\r\nBNA_GET_DMA_ADDR(&page_mem->dma, dma);\r\nfor (i = 0; i < rxq->qpt.page_count; i++) {\r\nrxq->rcb->sw_qpt[i] = kva;\r\nkva += PAGE_SIZE;\r\nBNA_SET_DMA_ADDR(dma, &bna_dma);\r\n((struct bna_dma_addr *)rxq->qpt.kv_qpt_ptr)[i].lsb =\r\nbna_dma.lsb;\r\n((struct bna_dma_addr *)rxq->qpt.kv_qpt_ptr)[i].msb =\r\nbna_dma.msb;\r\ndma += PAGE_SIZE;\r\n}\r\n}\r\nstatic void\r\nbna_rxp_cqpt_setup(struct bna_rxp *rxp,\r\nu32 page_count,\r\nu32 page_size,\r\nstruct bna_mem_descr *qpt_mem,\r\nstruct bna_mem_descr *swqpt_mem,\r\nstruct bna_mem_descr *page_mem)\r\n{\r\nu8 *kva;\r\nu64 dma;\r\nstruct bna_dma_addr bna_dma;\r\nint i;\r\nrxp->cq.qpt.hw_qpt_ptr.lsb = qpt_mem->dma.lsb;\r\nrxp->cq.qpt.hw_qpt_ptr.msb = qpt_mem->dma.msb;\r\nrxp->cq.qpt.kv_qpt_ptr = qpt_mem->kva;\r\nrxp->cq.qpt.page_count = page_count;\r\nrxp->cq.qpt.page_size = page_size;\r\nrxp->cq.ccb->sw_qpt = (void **) swqpt_mem->kva;\r\nrxp->cq.ccb->sw_q = page_mem->kva;\r\nkva = page_mem->kva;\r\nBNA_GET_DMA_ADDR(&page_mem->dma, dma);\r\nfor (i = 0; i < rxp->cq.qpt.page_count; i++) {\r\nrxp->cq.ccb->sw_qpt[i] = kva;\r\nkva += PAGE_SIZE;\r\nBNA_SET_DMA_ADDR(dma, &bna_dma);\r\n((struct bna_dma_addr *)rxp->cq.qpt.kv_qpt_ptr)[i].lsb =\r\nbna_dma.lsb;\r\n((struct bna_dma_addr *)rxp->cq.qpt.kv_qpt_ptr)[i].msb =\r\nbna_dma.msb;\r\ndma += PAGE_SIZE;\r\n}\r\n}\r\nstatic void\r\nbna_rx_mod_cb_rx_stopped(void *arg, struct bna_rx *rx)\r\n{\r\nstruct bna_rx_mod *rx_mod = (struct bna_rx_mod *)arg;\r\nbfa_wc_down(&rx_mod->rx_stop_wc);\r\n}\r\nstatic void\r\nbna_rx_mod_cb_rx_stopped_all(void *arg)\r\n{\r\nstruct bna_rx_mod *rx_mod = (struct bna_rx_mod *)arg;\r\nif (rx_mod->stop_cbfn)\r\nrx_mod->stop_cbfn(&rx_mod->bna->enet);\r\nrx_mod->stop_cbfn = NULL;\r\n}\r\nstatic void\r\nbna_rx_start(struct bna_rx *rx)\r\n{\r\nrx->rx_flags |= BNA_RX_F_ENET_STARTED;\r\nif (rx->rx_flags & BNA_RX_F_ENABLED)\r\nbfa_fsm_send_event(rx, RX_E_START);\r\n}\r\nstatic void\r\nbna_rx_stop(struct bna_rx *rx)\r\n{\r\nrx->rx_flags &= ~BNA_RX_F_ENET_STARTED;\r\nif (rx->fsm == (bfa_fsm_t) bna_rx_sm_stopped)\r\nbna_rx_mod_cb_rx_stopped(&rx->bna->rx_mod, rx);\r\nelse {\r\nrx->stop_cbfn = bna_rx_mod_cb_rx_stopped;\r\nrx->stop_cbarg = &rx->bna->rx_mod;\r\nbfa_fsm_send_event(rx, RX_E_STOP);\r\n}\r\n}\r\nstatic void\r\nbna_rx_fail(struct bna_rx *rx)\r\n{\r\nrx->rx_flags &= ~BNA_RX_F_ENET_STARTED;\r\nbfa_fsm_send_event(rx, RX_E_FAIL);\r\n}\r\nvoid\r\nbna_rx_mod_start(struct bna_rx_mod *rx_mod, enum bna_rx_type type)\r\n{\r\nstruct bna_rx *rx;\r\nstruct list_head *qe;\r\nrx_mod->flags |= BNA_RX_MOD_F_ENET_STARTED;\r\nif (type == BNA_RX_T_LOOPBACK)\r\nrx_mod->flags |= BNA_RX_MOD_F_ENET_LOOPBACK;\r\nlist_for_each(qe, &rx_mod->rx_active_q) {\r\nrx = (struct bna_rx *)qe;\r\nif (rx->type == type)\r\nbna_rx_start(rx);\r\n}\r\n}\r\nvoid\r\nbna_rx_mod_stop(struct bna_rx_mod *rx_mod, enum bna_rx_type type)\r\n{\r\nstruct bna_rx *rx;\r\nstruct list_head *qe;\r\nrx_mod->flags &= ~BNA_RX_MOD_F_ENET_STARTED;\r\nrx_mod->flags &= ~BNA_RX_MOD_F_ENET_LOOPBACK;\r\nrx_mod->stop_cbfn = bna_enet_cb_rx_stopped;\r\nbfa_wc_init(&rx_mod->rx_stop_wc, bna_rx_mod_cb_rx_stopped_all, rx_mod);\r\nlist_for_each(qe, &rx_mod->rx_active_q) {\r\nrx = (struct bna_rx *)qe;\r\nif (rx->type == type) {\r\nbfa_wc_up(&rx_mod->rx_stop_wc);\r\nbna_rx_stop(rx);\r\n}\r\n}\r\nbfa_wc_wait(&rx_mod->rx_stop_wc);\r\n}\r\nvoid\r\nbna_rx_mod_fail(struct bna_rx_mod *rx_mod)\r\n{\r\nstruct bna_rx *rx;\r\nstruct list_head *qe;\r\nrx_mod->flags &= ~BNA_RX_MOD_F_ENET_STARTED;\r\nrx_mod->flags &= ~BNA_RX_MOD_F_ENET_LOOPBACK;\r\nlist_for_each(qe, &rx_mod->rx_active_q) {\r\nrx = (struct bna_rx *)qe;\r\nbna_rx_fail(rx);\r\n}\r\n}\r\nvoid bna_rx_mod_init(struct bna_rx_mod *rx_mod, struct bna *bna,\r\nstruct bna_res_info *res_info)\r\n{\r\nint index;\r\nstruct bna_rx *rx_ptr;\r\nstruct bna_rxp *rxp_ptr;\r\nstruct bna_rxq *rxq_ptr;\r\nrx_mod->bna = bna;\r\nrx_mod->flags = 0;\r\nrx_mod->rx = (struct bna_rx *)\r\nres_info[BNA_MOD_RES_MEM_T_RX_ARRAY].res_u.mem_info.mdl[0].kva;\r\nrx_mod->rxp = (struct bna_rxp *)\r\nres_info[BNA_MOD_RES_MEM_T_RXP_ARRAY].res_u.mem_info.mdl[0].kva;\r\nrx_mod->rxq = (struct bna_rxq *)\r\nres_info[BNA_MOD_RES_MEM_T_RXQ_ARRAY].res_u.mem_info.mdl[0].kva;\r\nINIT_LIST_HEAD(&rx_mod->rx_free_q);\r\nrx_mod->rx_free_count = 0;\r\nINIT_LIST_HEAD(&rx_mod->rxq_free_q);\r\nrx_mod->rxq_free_count = 0;\r\nINIT_LIST_HEAD(&rx_mod->rxp_free_q);\r\nrx_mod->rxp_free_count = 0;\r\nINIT_LIST_HEAD(&rx_mod->rx_active_q);\r\nfor (index = 0; index < bna->ioceth.attr.num_rxp; index++) {\r\nrx_ptr = &rx_mod->rx[index];\r\nbfa_q_qe_init(&rx_ptr->qe);\r\nINIT_LIST_HEAD(&rx_ptr->rxp_q);\r\nrx_ptr->bna = NULL;\r\nrx_ptr->rid = index;\r\nrx_ptr->stop_cbfn = NULL;\r\nrx_ptr->stop_cbarg = NULL;\r\nlist_add_tail(&rx_ptr->qe, &rx_mod->rx_free_q);\r\nrx_mod->rx_free_count++;\r\n}\r\nfor (index = 0; index < bna->ioceth.attr.num_rxp; index++) {\r\nrxp_ptr = &rx_mod->rxp[index];\r\nbfa_q_qe_init(&rxp_ptr->qe);\r\nlist_add_tail(&rxp_ptr->qe, &rx_mod->rxp_free_q);\r\nrx_mod->rxp_free_count++;\r\n}\r\nfor (index = 0; index < (bna->ioceth.attr.num_rxp * 2); index++) {\r\nrxq_ptr = &rx_mod->rxq[index];\r\nbfa_q_qe_init(&rxq_ptr->qe);\r\nlist_add_tail(&rxq_ptr->qe, &rx_mod->rxq_free_q);\r\nrx_mod->rxq_free_count++;\r\n}\r\n}\r\nvoid\r\nbna_rx_mod_uninit(struct bna_rx_mod *rx_mod)\r\n{\r\nstruct list_head *qe;\r\nint i;\r\ni = 0;\r\nlist_for_each(qe, &rx_mod->rx_free_q)\r\ni++;\r\ni = 0;\r\nlist_for_each(qe, &rx_mod->rxp_free_q)\r\ni++;\r\ni = 0;\r\nlist_for_each(qe, &rx_mod->rxq_free_q)\r\ni++;\r\nrx_mod->bna = NULL;\r\n}\r\nvoid\r\nbna_bfi_rx_enet_start_rsp(struct bna_rx *rx, struct bfi_msgq_mhdr *msghdr)\r\n{\r\nstruct bfi_enet_rx_cfg_rsp *cfg_rsp = &rx->bfi_enet_cmd.cfg_rsp;\r\nstruct bna_rxp *rxp = NULL;\r\nstruct bna_rxq *q0 = NULL, *q1 = NULL;\r\nstruct list_head *rxp_qe;\r\nint i;\r\nbfa_msgq_rsp_copy(&rx->bna->msgq, (u8 *)cfg_rsp,\r\nsizeof(struct bfi_enet_rx_cfg_rsp));\r\nrx->hw_id = cfg_rsp->hw_id;\r\nfor (i = 0, rxp_qe = bfa_q_first(&rx->rxp_q);\r\ni < rx->num_paths;\r\ni++, rxp_qe = bfa_q_next(rxp_qe)) {\r\nrxp = (struct bna_rxp *)rxp_qe;\r\nGET_RXQS(rxp, q0, q1);\r\nrxp->cq.ccb->i_dbell->doorbell_addr =\r\nrx->bna->pcidev.pci_bar_kva\r\n+ ntohl(cfg_rsp->q_handles[i].i_dbell);\r\nrxp->hw_id = cfg_rsp->q_handles[i].hw_cqid;\r\nq0->rcb->q_dbell =\r\nrx->bna->pcidev.pci_bar_kva\r\n+ ntohl(cfg_rsp->q_handles[i].ql_dbell);\r\nq0->hw_id = cfg_rsp->q_handles[i].hw_lqid;\r\nif (q1) {\r\nq1->rcb->q_dbell =\r\nrx->bna->pcidev.pci_bar_kva\r\n+ ntohl(cfg_rsp->q_handles[i].qs_dbell);\r\nq1->hw_id = cfg_rsp->q_handles[i].hw_sqid;\r\n}\r\n(*rxp->cq.ccb->hw_producer_index) = 0;\r\nrxp->cq.ccb->producer_index = 0;\r\nq0->rcb->producer_index = q0->rcb->consumer_index = 0;\r\nif (q1)\r\nq1->rcb->producer_index = q1->rcb->consumer_index = 0;\r\n}\r\nbfa_fsm_send_event(rx, RX_E_STARTED);\r\n}\r\nvoid\r\nbna_bfi_rx_enet_stop_rsp(struct bna_rx *rx, struct bfi_msgq_mhdr *msghdr)\r\n{\r\nbfa_fsm_send_event(rx, RX_E_STOPPED);\r\n}\r\nvoid\r\nbna_rx_res_req(struct bna_rx_config *q_cfg, struct bna_res_info *res_info)\r\n{\r\nu32 cq_size, hq_size, dq_size;\r\nu32 cpage_count, hpage_count, dpage_count;\r\nstruct bna_mem_info *mem_info;\r\nu32 cq_depth;\r\nu32 hq_depth;\r\nu32 dq_depth;\r\ndq_depth = q_cfg->q_depth;\r\nhq_depth = ((q_cfg->rxp_type == BNA_RXP_SINGLE) ? 0 : q_cfg->q_depth);\r\ncq_depth = dq_depth + hq_depth;\r\nBNA_TO_POWER_OF_2_HIGH(cq_depth);\r\ncq_size = cq_depth * BFI_CQ_WI_SIZE;\r\ncq_size = ALIGN(cq_size, PAGE_SIZE);\r\ncpage_count = SIZE_TO_PAGES(cq_size);\r\nBNA_TO_POWER_OF_2_HIGH(dq_depth);\r\ndq_size = dq_depth * BFI_RXQ_WI_SIZE;\r\ndq_size = ALIGN(dq_size, PAGE_SIZE);\r\ndpage_count = SIZE_TO_PAGES(dq_size);\r\nif (BNA_RXP_SINGLE != q_cfg->rxp_type) {\r\nBNA_TO_POWER_OF_2_HIGH(hq_depth);\r\nhq_size = hq_depth * BFI_RXQ_WI_SIZE;\r\nhq_size = ALIGN(hq_size, PAGE_SIZE);\r\nhpage_count = SIZE_TO_PAGES(hq_size);\r\n} else\r\nhpage_count = 0;\r\nres_info[BNA_RX_RES_MEM_T_CCB].res_type = BNA_RES_T_MEM;\r\nmem_info = &res_info[BNA_RX_RES_MEM_T_CCB].res_u.mem_info;\r\nmem_info->mem_type = BNA_MEM_T_KVA;\r\nmem_info->len = sizeof(struct bna_ccb);\r\nmem_info->num = q_cfg->num_paths;\r\nres_info[BNA_RX_RES_MEM_T_RCB].res_type = BNA_RES_T_MEM;\r\nmem_info = &res_info[BNA_RX_RES_MEM_T_RCB].res_u.mem_info;\r\nmem_info->mem_type = BNA_MEM_T_KVA;\r\nmem_info->len = sizeof(struct bna_rcb);\r\nmem_info->num = BNA_GET_RXQS(q_cfg);\r\nres_info[BNA_RX_RES_MEM_T_CQPT].res_type = BNA_RES_T_MEM;\r\nmem_info = &res_info[BNA_RX_RES_MEM_T_CQPT].res_u.mem_info;\r\nmem_info->mem_type = BNA_MEM_T_DMA;\r\nmem_info->len = cpage_count * sizeof(struct bna_dma_addr);\r\nmem_info->num = q_cfg->num_paths;\r\nres_info[BNA_RX_RES_MEM_T_CSWQPT].res_type = BNA_RES_T_MEM;\r\nmem_info = &res_info[BNA_RX_RES_MEM_T_CSWQPT].res_u.mem_info;\r\nmem_info->mem_type = BNA_MEM_T_KVA;\r\nmem_info->len = cpage_count * sizeof(void *);\r\nmem_info->num = q_cfg->num_paths;\r\nres_info[BNA_RX_RES_MEM_T_CQPT_PAGE].res_type = BNA_RES_T_MEM;\r\nmem_info = &res_info[BNA_RX_RES_MEM_T_CQPT_PAGE].res_u.mem_info;\r\nmem_info->mem_type = BNA_MEM_T_DMA;\r\nmem_info->len = PAGE_SIZE * cpage_count;\r\nmem_info->num = q_cfg->num_paths;\r\nres_info[BNA_RX_RES_MEM_T_DQPT].res_type = BNA_RES_T_MEM;\r\nmem_info = &res_info[BNA_RX_RES_MEM_T_DQPT].res_u.mem_info;\r\nmem_info->mem_type = BNA_MEM_T_DMA;\r\nmem_info->len = dpage_count * sizeof(struct bna_dma_addr);\r\nmem_info->num = q_cfg->num_paths;\r\nres_info[BNA_RX_RES_MEM_T_DSWQPT].res_type = BNA_RES_T_MEM;\r\nmem_info = &res_info[BNA_RX_RES_MEM_T_DSWQPT].res_u.mem_info;\r\nmem_info->mem_type = BNA_MEM_T_KVA;\r\nmem_info->len = dpage_count * sizeof(void *);\r\nmem_info->num = q_cfg->num_paths;\r\nres_info[BNA_RX_RES_MEM_T_DPAGE].res_type = BNA_RES_T_MEM;\r\nmem_info = &res_info[BNA_RX_RES_MEM_T_DPAGE].res_u.mem_info;\r\nmem_info->mem_type = BNA_MEM_T_DMA;\r\nmem_info->len = PAGE_SIZE * dpage_count;\r\nmem_info->num = q_cfg->num_paths;\r\nres_info[BNA_RX_RES_MEM_T_HQPT].res_type = BNA_RES_T_MEM;\r\nmem_info = &res_info[BNA_RX_RES_MEM_T_HQPT].res_u.mem_info;\r\nmem_info->mem_type = BNA_MEM_T_DMA;\r\nmem_info->len = hpage_count * sizeof(struct bna_dma_addr);\r\nmem_info->num = (hpage_count ? q_cfg->num_paths : 0);\r\nres_info[BNA_RX_RES_MEM_T_HSWQPT].res_type = BNA_RES_T_MEM;\r\nmem_info = &res_info[BNA_RX_RES_MEM_T_HSWQPT].res_u.mem_info;\r\nmem_info->mem_type = BNA_MEM_T_KVA;\r\nmem_info->len = hpage_count * sizeof(void *);\r\nmem_info->num = (hpage_count ? q_cfg->num_paths : 0);\r\nres_info[BNA_RX_RES_MEM_T_HPAGE].res_type = BNA_RES_T_MEM;\r\nmem_info = &res_info[BNA_RX_RES_MEM_T_HPAGE].res_u.mem_info;\r\nmem_info->mem_type = BNA_MEM_T_DMA;\r\nmem_info->len = PAGE_SIZE * hpage_count;\r\nmem_info->num = (hpage_count ? q_cfg->num_paths : 0);\r\nres_info[BNA_RX_RES_MEM_T_IBIDX].res_type = BNA_RES_T_MEM;\r\nmem_info = &res_info[BNA_RX_RES_MEM_T_IBIDX].res_u.mem_info;\r\nmem_info->mem_type = BNA_MEM_T_DMA;\r\nmem_info->len = BFI_IBIDX_SIZE;\r\nmem_info->num = q_cfg->num_paths;\r\nres_info[BNA_RX_RES_MEM_T_RIT].res_type = BNA_RES_T_MEM;\r\nmem_info = &res_info[BNA_RX_RES_MEM_T_RIT].res_u.mem_info;\r\nmem_info->mem_type = BNA_MEM_T_KVA;\r\nmem_info->len = BFI_ENET_RSS_RIT_MAX;\r\nmem_info->num = 1;\r\nres_info[BNA_RX_RES_T_INTR].res_type = BNA_RES_T_INTR;\r\nres_info[BNA_RX_RES_T_INTR].res_u.intr_info.intr_type = BNA_INTR_T_MSIX;\r\nres_info[BNA_RX_RES_T_INTR].res_u.intr_info.num = q_cfg->num_paths;\r\n}\r\nstruct bna_rx *\r\nbna_rx_create(struct bna *bna, struct bnad *bnad,\r\nstruct bna_rx_config *rx_cfg,\r\nconst struct bna_rx_event_cbfn *rx_cbfn,\r\nstruct bna_res_info *res_info,\r\nvoid *priv)\r\n{\r\nstruct bna_rx_mod *rx_mod = &bna->rx_mod;\r\nstruct bna_rx *rx;\r\nstruct bna_rxp *rxp;\r\nstruct bna_rxq *q0;\r\nstruct bna_rxq *q1;\r\nstruct bna_intr_info *intr_info;\r\nu32 page_count;\r\nstruct bna_mem_descr *ccb_mem;\r\nstruct bna_mem_descr *rcb_mem;\r\nstruct bna_mem_descr *unmapq_mem;\r\nstruct bna_mem_descr *cqpt_mem;\r\nstruct bna_mem_descr *cswqpt_mem;\r\nstruct bna_mem_descr *cpage_mem;\r\nstruct bna_mem_descr *hqpt_mem;\r\nstruct bna_mem_descr *dqpt_mem;\r\nstruct bna_mem_descr *hsqpt_mem;\r\nstruct bna_mem_descr *dsqpt_mem;\r\nstruct bna_mem_descr *hpage_mem;\r\nstruct bna_mem_descr *dpage_mem;\r\nint i;\r\nint dpage_count, hpage_count, rcb_idx;\r\nif (!bna_rx_res_check(rx_mod, rx_cfg))\r\nreturn NULL;\r\nintr_info = &res_info[BNA_RX_RES_T_INTR].res_u.intr_info;\r\nccb_mem = &res_info[BNA_RX_RES_MEM_T_CCB].res_u.mem_info.mdl[0];\r\nrcb_mem = &res_info[BNA_RX_RES_MEM_T_RCB].res_u.mem_info.mdl[0];\r\nunmapq_mem = &res_info[BNA_RX_RES_MEM_T_UNMAPQ].res_u.mem_info.mdl[0];\r\ncqpt_mem = &res_info[BNA_RX_RES_MEM_T_CQPT].res_u.mem_info.mdl[0];\r\ncswqpt_mem = &res_info[BNA_RX_RES_MEM_T_CSWQPT].res_u.mem_info.mdl[0];\r\ncpage_mem = &res_info[BNA_RX_RES_MEM_T_CQPT_PAGE].res_u.mem_info.mdl[0];\r\nhqpt_mem = &res_info[BNA_RX_RES_MEM_T_HQPT].res_u.mem_info.mdl[0];\r\ndqpt_mem = &res_info[BNA_RX_RES_MEM_T_DQPT].res_u.mem_info.mdl[0];\r\nhsqpt_mem = &res_info[BNA_RX_RES_MEM_T_HSWQPT].res_u.mem_info.mdl[0];\r\ndsqpt_mem = &res_info[BNA_RX_RES_MEM_T_DSWQPT].res_u.mem_info.mdl[0];\r\nhpage_mem = &res_info[BNA_RX_RES_MEM_T_HPAGE].res_u.mem_info.mdl[0];\r\ndpage_mem = &res_info[BNA_RX_RES_MEM_T_DPAGE].res_u.mem_info.mdl[0];\r\npage_count = res_info[BNA_RX_RES_MEM_T_CQPT_PAGE].res_u.mem_info.len /\r\nPAGE_SIZE;\r\ndpage_count = res_info[BNA_RX_RES_MEM_T_DPAGE].res_u.mem_info.len /\r\nPAGE_SIZE;\r\nhpage_count = res_info[BNA_RX_RES_MEM_T_HPAGE].res_u.mem_info.len /\r\nPAGE_SIZE;\r\nrx = bna_rx_get(rx_mod, rx_cfg->rx_type);\r\nrx->bna = bna;\r\nrx->rx_flags = 0;\r\nINIT_LIST_HEAD(&rx->rxp_q);\r\nrx->stop_cbfn = NULL;\r\nrx->stop_cbarg = NULL;\r\nrx->priv = priv;\r\nrx->rcb_setup_cbfn = rx_cbfn->rcb_setup_cbfn;\r\nrx->rcb_destroy_cbfn = rx_cbfn->rcb_destroy_cbfn;\r\nrx->ccb_setup_cbfn = rx_cbfn->ccb_setup_cbfn;\r\nrx->ccb_destroy_cbfn = rx_cbfn->ccb_destroy_cbfn;\r\nrx->rx_stall_cbfn = rx_cbfn->rx_stall_cbfn;\r\nrx->rx_cleanup_cbfn = rx_cbfn->rx_cleanup_cbfn;\r\nrx->rx_post_cbfn = rx_cbfn->rx_post_cbfn;\r\nif (rx->bna->rx_mod.flags & BNA_RX_MOD_F_ENET_STARTED) {\r\nswitch (rx->type) {\r\ncase BNA_RX_T_REGULAR:\r\nif (!(rx->bna->rx_mod.flags &\r\nBNA_RX_MOD_F_ENET_LOOPBACK))\r\nrx->rx_flags |= BNA_RX_F_ENET_STARTED;\r\nbreak;\r\ncase BNA_RX_T_LOOPBACK:\r\nif (rx->bna->rx_mod.flags & BNA_RX_MOD_F_ENET_LOOPBACK)\r\nrx->rx_flags |= BNA_RX_F_ENET_STARTED;\r\nbreak;\r\n}\r\n}\r\nrx->num_paths = rx_cfg->num_paths;\r\nfor (i = 0, rcb_idx = 0; i < rx->num_paths; i++) {\r\nrxp = bna_rxp_get(rx_mod);\r\nlist_add_tail(&rxp->qe, &rx->rxp_q);\r\nrxp->type = rx_cfg->rxp_type;\r\nrxp->rx = rx;\r\nrxp->cq.rx = rx;\r\nq0 = bna_rxq_get(rx_mod);\r\nif (BNA_RXP_SINGLE == rx_cfg->rxp_type)\r\nq1 = NULL;\r\nelse\r\nq1 = bna_rxq_get(rx_mod);\r\nif (1 == intr_info->num)\r\nrxp->vector = intr_info->idl[0].vector;\r\nelse\r\nrxp->vector = intr_info->idl[i].vector;\r\nrxp->cq.ib.ib_seg_host_addr.lsb =\r\nres_info[BNA_RX_RES_MEM_T_IBIDX].res_u.mem_info.mdl[i].dma.lsb;\r\nrxp->cq.ib.ib_seg_host_addr.msb =\r\nres_info[BNA_RX_RES_MEM_T_IBIDX].res_u.mem_info.mdl[i].dma.msb;\r\nrxp->cq.ib.ib_seg_host_addr_kva =\r\nres_info[BNA_RX_RES_MEM_T_IBIDX].res_u.mem_info.mdl[i].kva;\r\nrxp->cq.ib.intr_type = intr_info->intr_type;\r\nif (intr_info->intr_type == BNA_INTR_T_MSIX)\r\nrxp->cq.ib.intr_vector = rxp->vector;\r\nelse\r\nrxp->cq.ib.intr_vector = (1 << rxp->vector);\r\nrxp->cq.ib.coalescing_timeo = rx_cfg->coalescing_timeo;\r\nrxp->cq.ib.interpkt_count = BFI_RX_INTERPKT_COUNT;\r\nrxp->cq.ib.interpkt_timeo = BFI_RX_INTERPKT_TIMEO;\r\nbna_rxp_add_rxqs(rxp, q0, q1);\r\nq0->rx = rx;\r\nq0->rxp = rxp;\r\nq0->rcb = (struct bna_rcb *) rcb_mem[rcb_idx].kva;\r\nq0->rcb->unmap_q = (void *)unmapq_mem[rcb_idx].kva;\r\nrcb_idx++;\r\nq0->rcb->q_depth = rx_cfg->q_depth;\r\nq0->rcb->rxq = q0;\r\nq0->rcb->bnad = bna->bnad;\r\nq0->rcb->id = 0;\r\nq0->rx_packets = q0->rx_bytes = 0;\r\nq0->rx_packets_with_error = q0->rxbuf_alloc_failed = 0;\r\nbna_rxq_qpt_setup(q0, rxp, dpage_count, PAGE_SIZE,\r\n&dqpt_mem[i], &dsqpt_mem[i], &dpage_mem[i]);\r\nif (rx->rcb_setup_cbfn)\r\nrx->rcb_setup_cbfn(bnad, q0->rcb);\r\nif (q1) {\r\nq1->rx = rx;\r\nq1->rxp = rxp;\r\nq1->rcb = (struct bna_rcb *) rcb_mem[rcb_idx].kva;\r\nq1->rcb->unmap_q = (void *)unmapq_mem[rcb_idx].kva;\r\nrcb_idx++;\r\nq1->rcb->q_depth = rx_cfg->q_depth;\r\nq1->rcb->rxq = q1;\r\nq1->rcb->bnad = bna->bnad;\r\nq1->rcb->id = 1;\r\nq1->buffer_size = (rx_cfg->rxp_type == BNA_RXP_HDS) ?\r\nrx_cfg->hds_config.forced_offset\r\n: rx_cfg->small_buff_size;\r\nq1->rx_packets = q1->rx_bytes = 0;\r\nq1->rx_packets_with_error = q1->rxbuf_alloc_failed = 0;\r\nbna_rxq_qpt_setup(q1, rxp, hpage_count, PAGE_SIZE,\r\n&hqpt_mem[i], &hsqpt_mem[i],\r\n&hpage_mem[i]);\r\nif (rx->rcb_setup_cbfn)\r\nrx->rcb_setup_cbfn(bnad, q1->rcb);\r\n}\r\nrxp->cq.ccb = (struct bna_ccb *) ccb_mem[i].kva;\r\nrxp->cq.ccb->q_depth = rx_cfg->q_depth +\r\n((rx_cfg->rxp_type == BNA_RXP_SINGLE) ?\r\n0 : rx_cfg->q_depth);\r\nrxp->cq.ccb->cq = &rxp->cq;\r\nrxp->cq.ccb->rcb[0] = q0->rcb;\r\nq0->rcb->ccb = rxp->cq.ccb;\r\nif (q1) {\r\nrxp->cq.ccb->rcb[1] = q1->rcb;\r\nq1->rcb->ccb = rxp->cq.ccb;\r\n}\r\nrxp->cq.ccb->hw_producer_index =\r\n(u32 *)rxp->cq.ib.ib_seg_host_addr_kva;\r\nrxp->cq.ccb->i_dbell = &rxp->cq.ib.door_bell;\r\nrxp->cq.ccb->intr_type = rxp->cq.ib.intr_type;\r\nrxp->cq.ccb->intr_vector = rxp->cq.ib.intr_vector;\r\nrxp->cq.ccb->rx_coalescing_timeo =\r\nrxp->cq.ib.coalescing_timeo;\r\nrxp->cq.ccb->pkt_rate.small_pkt_cnt = 0;\r\nrxp->cq.ccb->pkt_rate.large_pkt_cnt = 0;\r\nrxp->cq.ccb->bnad = bna->bnad;\r\nrxp->cq.ccb->id = i;\r\nbna_rxp_cqpt_setup(rxp, page_count, PAGE_SIZE,\r\n&cqpt_mem[i], &cswqpt_mem[i], &cpage_mem[i]);\r\nif (rx->ccb_setup_cbfn)\r\nrx->ccb_setup_cbfn(bnad, rxp->cq.ccb);\r\n}\r\nrx->hds_cfg = rx_cfg->hds_config;\r\nbna_rxf_init(&rx->rxf, rx, rx_cfg, res_info);\r\nbfa_fsm_set_state(rx, bna_rx_sm_stopped);\r\nrx_mod->rid_mask |= (1 << rx->rid);\r\nreturn rx;\r\n}\r\nvoid\r\nbna_rx_destroy(struct bna_rx *rx)\r\n{\r\nstruct bna_rx_mod *rx_mod = &rx->bna->rx_mod;\r\nstruct bna_rxq *q0 = NULL;\r\nstruct bna_rxq *q1 = NULL;\r\nstruct bna_rxp *rxp;\r\nstruct list_head *qe;\r\nbna_rxf_uninit(&rx->rxf);\r\nwhile (!list_empty(&rx->rxp_q)) {\r\nbfa_q_deq(&rx->rxp_q, &rxp);\r\nGET_RXQS(rxp, q0, q1);\r\nif (rx->rcb_destroy_cbfn)\r\nrx->rcb_destroy_cbfn(rx->bna->bnad, q0->rcb);\r\nq0->rcb = NULL;\r\nq0->rxp = NULL;\r\nq0->rx = NULL;\r\nbna_rxq_put(rx_mod, q0);\r\nif (q1) {\r\nif (rx->rcb_destroy_cbfn)\r\nrx->rcb_destroy_cbfn(rx->bna->bnad, q1->rcb);\r\nq1->rcb = NULL;\r\nq1->rxp = NULL;\r\nq1->rx = NULL;\r\nbna_rxq_put(rx_mod, q1);\r\n}\r\nrxp->rxq.slr.large = NULL;\r\nrxp->rxq.slr.small = NULL;\r\nif (rx->ccb_destroy_cbfn)\r\nrx->ccb_destroy_cbfn(rx->bna->bnad, rxp->cq.ccb);\r\nrxp->cq.ccb = NULL;\r\nrxp->rx = NULL;\r\nbna_rxp_put(rx_mod, rxp);\r\n}\r\nlist_for_each(qe, &rx_mod->rx_active_q) {\r\nif (qe == &rx->qe) {\r\nlist_del(&rx->qe);\r\nbfa_q_qe_init(&rx->qe);\r\nbreak;\r\n}\r\n}\r\nrx_mod->rid_mask &= ~(1 << rx->rid);\r\nrx->bna = NULL;\r\nrx->priv = NULL;\r\nbna_rx_put(rx_mod, rx);\r\n}\r\nvoid\r\nbna_rx_enable(struct bna_rx *rx)\r\n{\r\nif (rx->fsm != (bfa_sm_t)bna_rx_sm_stopped)\r\nreturn;\r\nrx->rx_flags |= BNA_RX_F_ENABLED;\r\nif (rx->rx_flags & BNA_RX_F_ENET_STARTED)\r\nbfa_fsm_send_event(rx, RX_E_START);\r\n}\r\nvoid\r\nbna_rx_disable(struct bna_rx *rx, enum bna_cleanup_type type,\r\nvoid (*cbfn)(void *, struct bna_rx *))\r\n{\r\nif (type == BNA_SOFT_CLEANUP) {\r\n(*cbfn)(rx->bna->bnad, rx);\r\n} else {\r\nrx->stop_cbfn = cbfn;\r\nrx->stop_cbarg = rx->bna->bnad;\r\nrx->rx_flags &= ~BNA_RX_F_ENABLED;\r\nbfa_fsm_send_event(rx, RX_E_STOP);\r\n}\r\n}\r\nvoid\r\nbna_rx_cleanup_complete(struct bna_rx *rx)\r\n{\r\nbfa_fsm_send_event(rx, RX_E_CLEANUP_DONE);\r\n}\r\nenum bna_cb_status\r\nbna_rx_mode_set(struct bna_rx *rx, enum bna_rxmode new_mode,\r\nenum bna_rxmode bitmask,\r\nvoid (*cbfn)(struct bnad *, struct bna_rx *))\r\n{\r\nstruct bna_rxf *rxf = &rx->rxf;\r\nint need_hw_config = 0;\r\nif (is_promisc_enable(new_mode, bitmask)) {\r\nif ((rx->bna->promisc_rid != BFI_INVALID_RID) &&\r\n(rx->bna->promisc_rid != rxf->rx->rid))\r\ngoto err_return;\r\nif (rx->bna->default_mode_rid != BFI_INVALID_RID)\r\ngoto err_return;\r\nif (is_default_enable(new_mode, bitmask))\r\ngoto err_return;\r\n}\r\nif (is_default_enable(new_mode, bitmask)) {\r\nif ((rx->bna->default_mode_rid != BFI_INVALID_RID) &&\r\n(rx->bna->default_mode_rid != rxf->rx->rid)) {\r\ngoto err_return;\r\n}\r\nif (rx->bna->promisc_rid != BFI_INVALID_RID)\r\ngoto err_return;\r\n}\r\nif (is_promisc_enable(new_mode, bitmask)) {\r\nif (bna_rxf_promisc_enable(rxf))\r\nneed_hw_config = 1;\r\n} else if (is_promisc_disable(new_mode, bitmask)) {\r\nif (bna_rxf_promisc_disable(rxf))\r\nneed_hw_config = 1;\r\n}\r\nif (is_allmulti_enable(new_mode, bitmask)) {\r\nif (bna_rxf_allmulti_enable(rxf))\r\nneed_hw_config = 1;\r\n} else if (is_allmulti_disable(new_mode, bitmask)) {\r\nif (bna_rxf_allmulti_disable(rxf))\r\nneed_hw_config = 1;\r\n}\r\nif (need_hw_config) {\r\nrxf->cam_fltr_cbfn = cbfn;\r\nrxf->cam_fltr_cbarg = rx->bna->bnad;\r\nbfa_fsm_send_event(rxf, RXF_E_CONFIG);\r\n} else if (cbfn)\r\n(*cbfn)(rx->bna->bnad, rx);\r\nreturn BNA_CB_SUCCESS;\r\nerr_return:\r\nreturn BNA_CB_FAIL;\r\n}\r\nvoid\r\nbna_rx_vlanfilter_enable(struct bna_rx *rx)\r\n{\r\nstruct bna_rxf *rxf = &rx->rxf;\r\nif (rxf->vlan_filter_status == BNA_STATUS_T_DISABLED) {\r\nrxf->vlan_filter_status = BNA_STATUS_T_ENABLED;\r\nrxf->vlan_pending_bitmask = (u8)BFI_VLAN_BMASK_ALL;\r\nbfa_fsm_send_event(rxf, RXF_E_CONFIG);\r\n}\r\n}\r\nvoid\r\nbna_rx_coalescing_timeo_set(struct bna_rx *rx, int coalescing_timeo)\r\n{\r\nstruct bna_rxp *rxp;\r\nstruct list_head *qe;\r\nlist_for_each(qe, &rx->rxp_q) {\r\nrxp = (struct bna_rxp *)qe;\r\nrxp->cq.ccb->rx_coalescing_timeo = coalescing_timeo;\r\nbna_ib_coalescing_timeo_set(&rxp->cq.ib, coalescing_timeo);\r\n}\r\n}\r\nvoid\r\nbna_rx_dim_reconfig(struct bna *bna, const u32 vector[][BNA_BIAS_T_MAX])\r\n{\r\nint i, j;\r\nfor (i = 0; i < BNA_LOAD_T_MAX; i++)\r\nfor (j = 0; j < BNA_BIAS_T_MAX; j++)\r\nbna->rx_mod.dim_vector[i][j] = vector[i][j];\r\n}\r\nvoid\r\nbna_rx_dim_update(struct bna_ccb *ccb)\r\n{\r\nstruct bna *bna = ccb->cq->rx->bna;\r\nu32 load, bias;\r\nu32 pkt_rt, small_rt, large_rt;\r\nu8 coalescing_timeo;\r\nif ((ccb->pkt_rate.small_pkt_cnt == 0) &&\r\n(ccb->pkt_rate.large_pkt_cnt == 0))\r\nreturn;\r\nsmall_rt = ccb->pkt_rate.small_pkt_cnt;\r\nlarge_rt = ccb->pkt_rate.large_pkt_cnt;\r\npkt_rt = small_rt + large_rt;\r\nif (pkt_rt < BNA_PKT_RATE_10K)\r\nload = BNA_LOAD_T_LOW_4;\r\nelse if (pkt_rt < BNA_PKT_RATE_20K)\r\nload = BNA_LOAD_T_LOW_3;\r\nelse if (pkt_rt < BNA_PKT_RATE_30K)\r\nload = BNA_LOAD_T_LOW_2;\r\nelse if (pkt_rt < BNA_PKT_RATE_40K)\r\nload = BNA_LOAD_T_LOW_1;\r\nelse if (pkt_rt < BNA_PKT_RATE_50K)\r\nload = BNA_LOAD_T_HIGH_1;\r\nelse if (pkt_rt < BNA_PKT_RATE_60K)\r\nload = BNA_LOAD_T_HIGH_2;\r\nelse if (pkt_rt < BNA_PKT_RATE_80K)\r\nload = BNA_LOAD_T_HIGH_3;\r\nelse\r\nload = BNA_LOAD_T_HIGH_4;\r\nif (small_rt > (large_rt << 1))\r\nbias = 0;\r\nelse\r\nbias = 1;\r\nccb->pkt_rate.small_pkt_cnt = 0;\r\nccb->pkt_rate.large_pkt_cnt = 0;\r\ncoalescing_timeo = bna->rx_mod.dim_vector[load][bias];\r\nccb->rx_coalescing_timeo = coalescing_timeo;\r\nbna_ib_coalescing_timeo_set(&ccb->cq->ib, coalescing_timeo);\r\n}\r\nstatic void\r\nbna_tx_sm_stopped_entry(struct bna_tx *tx)\r\n{\r\ncall_tx_stop_cbfn(tx);\r\n}\r\nstatic void\r\nbna_tx_sm_stopped(struct bna_tx *tx, enum bna_tx_event event)\r\n{\r\nswitch (event) {\r\ncase TX_E_START:\r\nbfa_fsm_set_state(tx, bna_tx_sm_start_wait);\r\nbreak;\r\ncase TX_E_STOP:\r\ncall_tx_stop_cbfn(tx);\r\nbreak;\r\ncase TX_E_FAIL:\r\nbreak;\r\ncase TX_E_PRIO_CHANGE:\r\ncall_tx_prio_change_cbfn(tx);\r\nbreak;\r\ncase TX_E_BW_UPDATE:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_tx_sm_start_wait_entry(struct bna_tx *tx)\r\n{\r\nbna_bfi_tx_enet_start(tx);\r\n}\r\nstatic void\r\nbna_tx_sm_start_wait(struct bna_tx *tx, enum bna_tx_event event)\r\n{\r\nswitch (event) {\r\ncase TX_E_STOP:\r\ntx->flags &= ~(BNA_TX_F_PRIO_CHANGED | BNA_TX_F_BW_UPDATED);\r\nbfa_fsm_set_state(tx, bna_tx_sm_stop_wait);\r\nbreak;\r\ncase TX_E_FAIL:\r\ntx->flags &= ~(BNA_TX_F_PRIO_CHANGED | BNA_TX_F_BW_UPDATED);\r\nbfa_fsm_set_state(tx, bna_tx_sm_stopped);\r\nbreak;\r\ncase TX_E_STARTED:\r\nif (tx->flags & (BNA_TX_F_PRIO_CHANGED | BNA_TX_F_BW_UPDATED)) {\r\ntx->flags &= ~(BNA_TX_F_PRIO_CHANGED |\r\nBNA_TX_F_BW_UPDATED);\r\nbfa_fsm_set_state(tx, bna_tx_sm_prio_stop_wait);\r\n} else\r\nbfa_fsm_set_state(tx, bna_tx_sm_started);\r\nbreak;\r\ncase TX_E_PRIO_CHANGE:\r\ntx->flags |= BNA_TX_F_PRIO_CHANGED;\r\nbreak;\r\ncase TX_E_BW_UPDATE:\r\ntx->flags |= BNA_TX_F_BW_UPDATED;\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_tx_sm_started_entry(struct bna_tx *tx)\r\n{\r\nstruct bna_txq *txq;\r\nstruct list_head *qe;\r\nint is_regular = (tx->type == BNA_TX_T_REGULAR);\r\nlist_for_each(qe, &tx->txq_q) {\r\ntxq = (struct bna_txq *)qe;\r\ntxq->tcb->priority = txq->priority;\r\nbna_ib_start(tx->bna, &txq->ib, is_regular);\r\n}\r\ntx->tx_resume_cbfn(tx->bna->bnad, tx);\r\n}\r\nstatic void\r\nbna_tx_sm_started(struct bna_tx *tx, enum bna_tx_event event)\r\n{\r\nswitch (event) {\r\ncase TX_E_STOP:\r\nbfa_fsm_set_state(tx, bna_tx_sm_stop_wait);\r\ntx->tx_stall_cbfn(tx->bna->bnad, tx);\r\nbna_tx_enet_stop(tx);\r\nbreak;\r\ncase TX_E_FAIL:\r\nbfa_fsm_set_state(tx, bna_tx_sm_failed);\r\ntx->tx_stall_cbfn(tx->bna->bnad, tx);\r\ntx->tx_cleanup_cbfn(tx->bna->bnad, tx);\r\nbreak;\r\ncase TX_E_PRIO_CHANGE:\r\ncase TX_E_BW_UPDATE:\r\nbfa_fsm_set_state(tx, bna_tx_sm_prio_stop_wait);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_tx_sm_stop_wait_entry(struct bna_tx *tx)\r\n{\r\n}\r\nstatic void\r\nbna_tx_sm_stop_wait(struct bna_tx *tx, enum bna_tx_event event)\r\n{\r\nswitch (event) {\r\ncase TX_E_FAIL:\r\ncase TX_E_STOPPED:\r\nbfa_fsm_set_state(tx, bna_tx_sm_cleanup_wait);\r\ntx->tx_cleanup_cbfn(tx->bna->bnad, tx);\r\nbreak;\r\ncase TX_E_STARTED:\r\nbna_tx_enet_stop(tx);\r\nbreak;\r\ncase TX_E_PRIO_CHANGE:\r\ncase TX_E_BW_UPDATE:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_tx_sm_cleanup_wait_entry(struct bna_tx *tx)\r\n{\r\n}\r\nstatic void\r\nbna_tx_sm_cleanup_wait(struct bna_tx *tx, enum bna_tx_event event)\r\n{\r\nswitch (event) {\r\ncase TX_E_FAIL:\r\ncase TX_E_PRIO_CHANGE:\r\ncase TX_E_BW_UPDATE:\r\nbreak;\r\ncase TX_E_CLEANUP_DONE:\r\nbfa_fsm_set_state(tx, bna_tx_sm_stopped);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_tx_sm_prio_stop_wait_entry(struct bna_tx *tx)\r\n{\r\ntx->tx_stall_cbfn(tx->bna->bnad, tx);\r\nbna_tx_enet_stop(tx);\r\n}\r\nstatic void\r\nbna_tx_sm_prio_stop_wait(struct bna_tx *tx, enum bna_tx_event event)\r\n{\r\nswitch (event) {\r\ncase TX_E_STOP:\r\nbfa_fsm_set_state(tx, bna_tx_sm_stop_wait);\r\nbreak;\r\ncase TX_E_FAIL:\r\nbfa_fsm_set_state(tx, bna_tx_sm_failed);\r\ncall_tx_prio_change_cbfn(tx);\r\ntx->tx_cleanup_cbfn(tx->bna->bnad, tx);\r\nbreak;\r\ncase TX_E_STOPPED:\r\nbfa_fsm_set_state(tx, bna_tx_sm_prio_cleanup_wait);\r\nbreak;\r\ncase TX_E_PRIO_CHANGE:\r\ncase TX_E_BW_UPDATE:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_tx_sm_prio_cleanup_wait_entry(struct bna_tx *tx)\r\n{\r\ncall_tx_prio_change_cbfn(tx);\r\ntx->tx_cleanup_cbfn(tx->bna->bnad, tx);\r\n}\r\nstatic void\r\nbna_tx_sm_prio_cleanup_wait(struct bna_tx *tx, enum bna_tx_event event)\r\n{\r\nswitch (event) {\r\ncase TX_E_STOP:\r\nbfa_fsm_set_state(tx, bna_tx_sm_cleanup_wait);\r\nbreak;\r\ncase TX_E_FAIL:\r\nbfa_fsm_set_state(tx, bna_tx_sm_failed);\r\nbreak;\r\ncase TX_E_PRIO_CHANGE:\r\ncase TX_E_BW_UPDATE:\r\nbreak;\r\ncase TX_E_CLEANUP_DONE:\r\nbfa_fsm_set_state(tx, bna_tx_sm_start_wait);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_tx_sm_failed_entry(struct bna_tx *tx)\r\n{\r\n}\r\nstatic void\r\nbna_tx_sm_failed(struct bna_tx *tx, enum bna_tx_event event)\r\n{\r\nswitch (event) {\r\ncase TX_E_START:\r\nbfa_fsm_set_state(tx, bna_tx_sm_quiesce_wait);\r\nbreak;\r\ncase TX_E_STOP:\r\nbfa_fsm_set_state(tx, bna_tx_sm_cleanup_wait);\r\nbreak;\r\ncase TX_E_FAIL:\r\nbreak;\r\ncase TX_E_CLEANUP_DONE:\r\nbfa_fsm_set_state(tx, bna_tx_sm_stopped);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_tx_sm_quiesce_wait_entry(struct bna_tx *tx)\r\n{\r\n}\r\nstatic void\r\nbna_tx_sm_quiesce_wait(struct bna_tx *tx, enum bna_tx_event event)\r\n{\r\nswitch (event) {\r\ncase TX_E_STOP:\r\nbfa_fsm_set_state(tx, bna_tx_sm_cleanup_wait);\r\nbreak;\r\ncase TX_E_FAIL:\r\nbfa_fsm_set_state(tx, bna_tx_sm_failed);\r\nbreak;\r\ncase TX_E_CLEANUP_DONE:\r\nbfa_fsm_set_state(tx, bna_tx_sm_start_wait);\r\nbreak;\r\ncase TX_E_BW_UPDATE:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(event);\r\n}\r\n}\r\nstatic void\r\nbna_bfi_tx_enet_start(struct bna_tx *tx)\r\n{\r\nstruct bfi_enet_tx_cfg_req *cfg_req = &tx->bfi_enet_cmd.cfg_req;\r\nstruct bna_txq *txq = NULL;\r\nstruct list_head *qe;\r\nint i;\r\nbfi_msgq_mhdr_set(cfg_req->mh, BFI_MC_ENET,\r\nBFI_ENET_H2I_TX_CFG_SET_REQ, 0, tx->rid);\r\ncfg_req->mh.num_entries = htons(\r\nbfi_msgq_num_cmd_entries(sizeof(struct bfi_enet_tx_cfg_req)));\r\ncfg_req->num_queues = tx->num_txq;\r\nfor (i = 0, qe = bfa_q_first(&tx->txq_q);\r\ni < tx->num_txq;\r\ni++, qe = bfa_q_next(qe)) {\r\ntxq = (struct bna_txq *)qe;\r\nbfi_enet_datapath_q_init(&cfg_req->q_cfg[i].q.q, &txq->qpt);\r\ncfg_req->q_cfg[i].q.priority = txq->priority;\r\ncfg_req->q_cfg[i].ib.index_addr.a32.addr_lo =\r\ntxq->ib.ib_seg_host_addr.lsb;\r\ncfg_req->q_cfg[i].ib.index_addr.a32.addr_hi =\r\ntxq->ib.ib_seg_host_addr.msb;\r\ncfg_req->q_cfg[i].ib.intr.msix_index =\r\nhtons((u16)txq->ib.intr_vector);\r\n}\r\ncfg_req->ib_cfg.int_pkt_dma = BNA_STATUS_T_ENABLED;\r\ncfg_req->ib_cfg.int_enabled = BNA_STATUS_T_ENABLED;\r\ncfg_req->ib_cfg.int_pkt_enabled = BNA_STATUS_T_DISABLED;\r\ncfg_req->ib_cfg.continuous_coalescing = BNA_STATUS_T_ENABLED;\r\ncfg_req->ib_cfg.msix = (txq->ib.intr_type == BNA_INTR_T_MSIX)\r\n? BNA_STATUS_T_ENABLED : BNA_STATUS_T_DISABLED;\r\ncfg_req->ib_cfg.coalescing_timeout =\r\nhtonl((u32)txq->ib.coalescing_timeo);\r\ncfg_req->ib_cfg.inter_pkt_timeout =\r\nhtonl((u32)txq->ib.interpkt_timeo);\r\ncfg_req->ib_cfg.inter_pkt_count = (u8)txq->ib.interpkt_count;\r\ncfg_req->tx_cfg.vlan_mode = BFI_ENET_TX_VLAN_WI;\r\ncfg_req->tx_cfg.vlan_id = htons((u16)tx->txf_vlan_id);\r\ncfg_req->tx_cfg.admit_tagged_frame = BNA_STATUS_T_DISABLED;\r\ncfg_req->tx_cfg.apply_vlan_filter = BNA_STATUS_T_DISABLED;\r\nbfa_msgq_cmd_set(&tx->msgq_cmd, NULL, NULL,\r\nsizeof(struct bfi_enet_tx_cfg_req), &cfg_req->mh);\r\nbfa_msgq_cmd_post(&tx->bna->msgq, &tx->msgq_cmd);\r\n}\r\nstatic void\r\nbna_bfi_tx_enet_stop(struct bna_tx *tx)\r\n{\r\nstruct bfi_enet_req *req = &tx->bfi_enet_cmd.req;\r\nbfi_msgq_mhdr_set(req->mh, BFI_MC_ENET,\r\nBFI_ENET_H2I_TX_CFG_CLR_REQ, 0, tx->rid);\r\nreq->mh.num_entries = htons(\r\nbfi_msgq_num_cmd_entries(sizeof(struct bfi_enet_req)));\r\nbfa_msgq_cmd_set(&tx->msgq_cmd, NULL, NULL, sizeof(struct bfi_enet_req),\r\n&req->mh);\r\nbfa_msgq_cmd_post(&tx->bna->msgq, &tx->msgq_cmd);\r\n}\r\nstatic void\r\nbna_tx_enet_stop(struct bna_tx *tx)\r\n{\r\nstruct bna_txq *txq;\r\nstruct list_head *qe;\r\nlist_for_each(qe, &tx->txq_q) {\r\ntxq = (struct bna_txq *)qe;\r\nbna_ib_stop(tx->bna, &txq->ib);\r\n}\r\nbna_bfi_tx_enet_stop(tx);\r\n}\r\nstatic void\r\nbna_txq_qpt_setup(struct bna_txq *txq, int page_count, int page_size,\r\nstruct bna_mem_descr *qpt_mem,\r\nstruct bna_mem_descr *swqpt_mem,\r\nstruct bna_mem_descr *page_mem)\r\n{\r\nu8 *kva;\r\nu64 dma;\r\nstruct bna_dma_addr bna_dma;\r\nint i;\r\ntxq->qpt.hw_qpt_ptr.lsb = qpt_mem->dma.lsb;\r\ntxq->qpt.hw_qpt_ptr.msb = qpt_mem->dma.msb;\r\ntxq->qpt.kv_qpt_ptr = qpt_mem->kva;\r\ntxq->qpt.page_count = page_count;\r\ntxq->qpt.page_size = page_size;\r\ntxq->tcb->sw_qpt = (void **) swqpt_mem->kva;\r\ntxq->tcb->sw_q = page_mem->kva;\r\nkva = page_mem->kva;\r\nBNA_GET_DMA_ADDR(&page_mem->dma, dma);\r\nfor (i = 0; i < page_count; i++) {\r\ntxq->tcb->sw_qpt[i] = kva;\r\nkva += PAGE_SIZE;\r\nBNA_SET_DMA_ADDR(dma, &bna_dma);\r\n((struct bna_dma_addr *)txq->qpt.kv_qpt_ptr)[i].lsb =\r\nbna_dma.lsb;\r\n((struct bna_dma_addr *)txq->qpt.kv_qpt_ptr)[i].msb =\r\nbna_dma.msb;\r\ndma += PAGE_SIZE;\r\n}\r\n}\r\nstatic struct bna_tx *\r\nbna_tx_get(struct bna_tx_mod *tx_mod, enum bna_tx_type type)\r\n{\r\nstruct list_head *qe = NULL;\r\nstruct bna_tx *tx = NULL;\r\nif (list_empty(&tx_mod->tx_free_q))\r\nreturn NULL;\r\nif (type == BNA_TX_T_REGULAR) {\r\nbfa_q_deq(&tx_mod->tx_free_q, &qe);\r\n} else {\r\nbfa_q_deq_tail(&tx_mod->tx_free_q, &qe);\r\n}\r\ntx = (struct bna_tx *)qe;\r\nbfa_q_qe_init(&tx->qe);\r\ntx->type = type;\r\nreturn tx;\r\n}\r\nstatic void\r\nbna_tx_free(struct bna_tx *tx)\r\n{\r\nstruct bna_tx_mod *tx_mod = &tx->bna->tx_mod;\r\nstruct bna_txq *txq;\r\nstruct list_head *prev_qe;\r\nstruct list_head *qe;\r\nwhile (!list_empty(&tx->txq_q)) {\r\nbfa_q_deq(&tx->txq_q, &txq);\r\nbfa_q_qe_init(&txq->qe);\r\ntxq->tcb = NULL;\r\ntxq->tx = NULL;\r\nlist_add_tail(&txq->qe, &tx_mod->txq_free_q);\r\n}\r\nlist_for_each(qe, &tx_mod->tx_active_q) {\r\nif (qe == &tx->qe) {\r\nlist_del(&tx->qe);\r\nbfa_q_qe_init(&tx->qe);\r\nbreak;\r\n}\r\n}\r\ntx->bna = NULL;\r\ntx->priv = NULL;\r\nprev_qe = NULL;\r\nlist_for_each(qe, &tx_mod->tx_free_q) {\r\nif (((struct bna_tx *)qe)->rid < tx->rid)\r\nprev_qe = qe;\r\nelse {\r\nbreak;\r\n}\r\n}\r\nif (prev_qe == NULL) {\r\nbfa_q_enq_head(&tx_mod->tx_free_q, &tx->qe);\r\n} else if (bfa_q_next(prev_qe) == &tx_mod->tx_free_q) {\r\nlist_add_tail(&tx->qe, &tx_mod->tx_free_q);\r\n} else {\r\nbfa_q_next(&tx->qe) = bfa_q_next(prev_qe);\r\nbfa_q_prev(&tx->qe) = prev_qe;\r\nbfa_q_next(prev_qe) = &tx->qe;\r\nbfa_q_prev(bfa_q_next(&tx->qe)) = &tx->qe;\r\n}\r\n}\r\nstatic void\r\nbna_tx_start(struct bna_tx *tx)\r\n{\r\ntx->flags |= BNA_TX_F_ENET_STARTED;\r\nif (tx->flags & BNA_TX_F_ENABLED)\r\nbfa_fsm_send_event(tx, TX_E_START);\r\n}\r\nstatic void\r\nbna_tx_stop(struct bna_tx *tx)\r\n{\r\ntx->stop_cbfn = bna_tx_mod_cb_tx_stopped;\r\ntx->stop_cbarg = &tx->bna->tx_mod;\r\ntx->flags &= ~BNA_TX_F_ENET_STARTED;\r\nbfa_fsm_send_event(tx, TX_E_STOP);\r\n}\r\nstatic void\r\nbna_tx_fail(struct bna_tx *tx)\r\n{\r\ntx->flags &= ~BNA_TX_F_ENET_STARTED;\r\nbfa_fsm_send_event(tx, TX_E_FAIL);\r\n}\r\nvoid\r\nbna_bfi_tx_enet_start_rsp(struct bna_tx *tx, struct bfi_msgq_mhdr *msghdr)\r\n{\r\nstruct bfi_enet_tx_cfg_rsp *cfg_rsp = &tx->bfi_enet_cmd.cfg_rsp;\r\nstruct bna_txq *txq = NULL;\r\nstruct list_head *qe;\r\nint i;\r\nbfa_msgq_rsp_copy(&tx->bna->msgq, (u8 *)cfg_rsp,\r\nsizeof(struct bfi_enet_tx_cfg_rsp));\r\ntx->hw_id = cfg_rsp->hw_id;\r\nfor (i = 0, qe = bfa_q_first(&tx->txq_q);\r\ni < tx->num_txq; i++, qe = bfa_q_next(qe)) {\r\ntxq = (struct bna_txq *)qe;\r\ntxq->tcb->i_dbell->doorbell_addr =\r\ntx->bna->pcidev.pci_bar_kva\r\n+ ntohl(cfg_rsp->q_handles[i].i_dbell);\r\ntxq->tcb->q_dbell =\r\ntx->bna->pcidev.pci_bar_kva\r\n+ ntohl(cfg_rsp->q_handles[i].q_dbell);\r\ntxq->hw_id = cfg_rsp->q_handles[i].hw_qid;\r\n(*txq->tcb->hw_consumer_index) = 0;\r\ntxq->tcb->producer_index = txq->tcb->consumer_index = 0;\r\n}\r\nbfa_fsm_send_event(tx, TX_E_STARTED);\r\n}\r\nvoid\r\nbna_bfi_tx_enet_stop_rsp(struct bna_tx *tx, struct bfi_msgq_mhdr *msghdr)\r\n{\r\nbfa_fsm_send_event(tx, TX_E_STOPPED);\r\n}\r\nvoid\r\nbna_bfi_bw_update_aen(struct bna_tx_mod *tx_mod)\r\n{\r\nstruct bna_tx *tx;\r\nstruct list_head *qe;\r\nlist_for_each(qe, &tx_mod->tx_active_q) {\r\ntx = (struct bna_tx *)qe;\r\nbfa_fsm_send_event(tx, TX_E_BW_UPDATE);\r\n}\r\n}\r\nvoid\r\nbna_tx_res_req(int num_txq, int txq_depth, struct bna_res_info *res_info)\r\n{\r\nu32 q_size;\r\nu32 page_count;\r\nstruct bna_mem_info *mem_info;\r\nres_info[BNA_TX_RES_MEM_T_TCB].res_type = BNA_RES_T_MEM;\r\nmem_info = &res_info[BNA_TX_RES_MEM_T_TCB].res_u.mem_info;\r\nmem_info->mem_type = BNA_MEM_T_KVA;\r\nmem_info->len = sizeof(struct bna_tcb);\r\nmem_info->num = num_txq;\r\nq_size = txq_depth * BFI_TXQ_WI_SIZE;\r\nq_size = ALIGN(q_size, PAGE_SIZE);\r\npage_count = q_size >> PAGE_SHIFT;\r\nres_info[BNA_TX_RES_MEM_T_QPT].res_type = BNA_RES_T_MEM;\r\nmem_info = &res_info[BNA_TX_RES_MEM_T_QPT].res_u.mem_info;\r\nmem_info->mem_type = BNA_MEM_T_DMA;\r\nmem_info->len = page_count * sizeof(struct bna_dma_addr);\r\nmem_info->num = num_txq;\r\nres_info[BNA_TX_RES_MEM_T_SWQPT].res_type = BNA_RES_T_MEM;\r\nmem_info = &res_info[BNA_TX_RES_MEM_T_SWQPT].res_u.mem_info;\r\nmem_info->mem_type = BNA_MEM_T_KVA;\r\nmem_info->len = page_count * sizeof(void *);\r\nmem_info->num = num_txq;\r\nres_info[BNA_TX_RES_MEM_T_PAGE].res_type = BNA_RES_T_MEM;\r\nmem_info = &res_info[BNA_TX_RES_MEM_T_PAGE].res_u.mem_info;\r\nmem_info->mem_type = BNA_MEM_T_DMA;\r\nmem_info->len = PAGE_SIZE * page_count;\r\nmem_info->num = num_txq;\r\nres_info[BNA_TX_RES_MEM_T_IBIDX].res_type = BNA_RES_T_MEM;\r\nmem_info = &res_info[BNA_TX_RES_MEM_T_IBIDX].res_u.mem_info;\r\nmem_info->mem_type = BNA_MEM_T_DMA;\r\nmem_info->len = BFI_IBIDX_SIZE;\r\nmem_info->num = num_txq;\r\nres_info[BNA_TX_RES_INTR_T_TXCMPL].res_type = BNA_RES_T_INTR;\r\nres_info[BNA_TX_RES_INTR_T_TXCMPL].res_u.intr_info.intr_type =\r\nBNA_INTR_T_MSIX;\r\nres_info[BNA_TX_RES_INTR_T_TXCMPL].res_u.intr_info.num = num_txq;\r\n}\r\nstruct bna_tx *\r\nbna_tx_create(struct bna *bna, struct bnad *bnad,\r\nstruct bna_tx_config *tx_cfg,\r\nconst struct bna_tx_event_cbfn *tx_cbfn,\r\nstruct bna_res_info *res_info, void *priv)\r\n{\r\nstruct bna_intr_info *intr_info;\r\nstruct bna_tx_mod *tx_mod = &bna->tx_mod;\r\nstruct bna_tx *tx;\r\nstruct bna_txq *txq;\r\nstruct list_head *qe;\r\nint page_count;\r\nint i;\r\nintr_info = &res_info[BNA_TX_RES_INTR_T_TXCMPL].res_u.intr_info;\r\npage_count = (res_info[BNA_TX_RES_MEM_T_PAGE].res_u.mem_info.len) /\r\nPAGE_SIZE;\r\nif ((intr_info->num != 1) && (intr_info->num != tx_cfg->num_txq))\r\nreturn NULL;\r\ntx = bna_tx_get(tx_mod, tx_cfg->tx_type);\r\nif (!tx)\r\nreturn NULL;\r\ntx->bna = bna;\r\ntx->priv = priv;\r\nINIT_LIST_HEAD(&tx->txq_q);\r\nfor (i = 0; i < tx_cfg->num_txq; i++) {\r\nif (list_empty(&tx_mod->txq_free_q))\r\ngoto err_return;\r\nbfa_q_deq(&tx_mod->txq_free_q, &txq);\r\nbfa_q_qe_init(&txq->qe);\r\nlist_add_tail(&txq->qe, &tx->txq_q);\r\ntxq->tx = tx;\r\n}\r\ntx->tcb_setup_cbfn = tx_cbfn->tcb_setup_cbfn;\r\ntx->tcb_destroy_cbfn = tx_cbfn->tcb_destroy_cbfn;\r\ntx->tx_stall_cbfn = tx_cbfn->tx_stall_cbfn;\r\ntx->tx_resume_cbfn = tx_cbfn->tx_resume_cbfn;\r\ntx->tx_cleanup_cbfn = tx_cbfn->tx_cleanup_cbfn;\r\nlist_add_tail(&tx->qe, &tx_mod->tx_active_q);\r\ntx->num_txq = tx_cfg->num_txq;\r\ntx->flags = 0;\r\nif (tx->bna->tx_mod.flags & BNA_TX_MOD_F_ENET_STARTED) {\r\nswitch (tx->type) {\r\ncase BNA_TX_T_REGULAR:\r\nif (!(tx->bna->tx_mod.flags &\r\nBNA_TX_MOD_F_ENET_LOOPBACK))\r\ntx->flags |= BNA_TX_F_ENET_STARTED;\r\nbreak;\r\ncase BNA_TX_T_LOOPBACK:\r\nif (tx->bna->tx_mod.flags & BNA_TX_MOD_F_ENET_LOOPBACK)\r\ntx->flags |= BNA_TX_F_ENET_STARTED;\r\nbreak;\r\n}\r\n}\r\ni = 0;\r\nlist_for_each(qe, &tx->txq_q) {\r\ntxq = (struct bna_txq *)qe;\r\ntxq->tcb = (struct bna_tcb *)\r\nres_info[BNA_TX_RES_MEM_T_TCB].res_u.mem_info.mdl[i].kva;\r\ntxq->tx_packets = 0;\r\ntxq->tx_bytes = 0;\r\ntxq->ib.ib_seg_host_addr.lsb =\r\nres_info[BNA_TX_RES_MEM_T_IBIDX].res_u.mem_info.mdl[i].dma.lsb;\r\ntxq->ib.ib_seg_host_addr.msb =\r\nres_info[BNA_TX_RES_MEM_T_IBIDX].res_u.mem_info.mdl[i].dma.msb;\r\ntxq->ib.ib_seg_host_addr_kva =\r\nres_info[BNA_TX_RES_MEM_T_IBIDX].res_u.mem_info.mdl[i].kva;\r\ntxq->ib.intr_type = intr_info->intr_type;\r\ntxq->ib.intr_vector = (intr_info->num == 1) ?\r\nintr_info->idl[0].vector :\r\nintr_info->idl[i].vector;\r\nif (intr_info->intr_type == BNA_INTR_T_INTX)\r\ntxq->ib.intr_vector = (1 << txq->ib.intr_vector);\r\ntxq->ib.coalescing_timeo = tx_cfg->coalescing_timeo;\r\ntxq->ib.interpkt_timeo = BFI_TX_INTERPKT_TIMEO;\r\ntxq->ib.interpkt_count = BFI_TX_INTERPKT_COUNT;\r\ntxq->tcb->q_depth = tx_cfg->txq_depth;\r\ntxq->tcb->unmap_q = (void *)\r\nres_info[BNA_TX_RES_MEM_T_UNMAPQ].res_u.mem_info.mdl[i].kva;\r\ntxq->tcb->hw_consumer_index =\r\n(u32 *)txq->ib.ib_seg_host_addr_kva;\r\ntxq->tcb->i_dbell = &txq->ib.door_bell;\r\ntxq->tcb->intr_type = txq->ib.intr_type;\r\ntxq->tcb->intr_vector = txq->ib.intr_vector;\r\ntxq->tcb->txq = txq;\r\ntxq->tcb->bnad = bnad;\r\ntxq->tcb->id = i;\r\nbna_txq_qpt_setup(txq, page_count, PAGE_SIZE,\r\n&res_info[BNA_TX_RES_MEM_T_QPT].res_u.mem_info.mdl[i],\r\n&res_info[BNA_TX_RES_MEM_T_SWQPT].res_u.mem_info.mdl[i],\r\n&res_info[BNA_TX_RES_MEM_T_PAGE].\r\nres_u.mem_info.mdl[i]);\r\nif (tx->tcb_setup_cbfn)\r\n(tx->tcb_setup_cbfn)(bna->bnad, txq->tcb);\r\nif (tx_cfg->num_txq == BFI_TX_MAX_PRIO)\r\ntxq->priority = txq->tcb->id;\r\nelse\r\ntxq->priority = tx_mod->default_prio;\r\ni++;\r\n}\r\ntx->txf_vlan_id = 0;\r\nbfa_fsm_set_state(tx, bna_tx_sm_stopped);\r\ntx_mod->rid_mask |= (1 << tx->rid);\r\nreturn tx;\r\nerr_return:\r\nbna_tx_free(tx);\r\nreturn NULL;\r\n}\r\nvoid\r\nbna_tx_destroy(struct bna_tx *tx)\r\n{\r\nstruct bna_txq *txq;\r\nstruct list_head *qe;\r\nlist_for_each(qe, &tx->txq_q) {\r\ntxq = (struct bna_txq *)qe;\r\nif (tx->tcb_destroy_cbfn)\r\n(tx->tcb_destroy_cbfn)(tx->bna->bnad, txq->tcb);\r\n}\r\ntx->bna->tx_mod.rid_mask &= ~(1 << tx->rid);\r\nbna_tx_free(tx);\r\n}\r\nvoid\r\nbna_tx_enable(struct bna_tx *tx)\r\n{\r\nif (tx->fsm != (bfa_sm_t)bna_tx_sm_stopped)\r\nreturn;\r\ntx->flags |= BNA_TX_F_ENABLED;\r\nif (tx->flags & BNA_TX_F_ENET_STARTED)\r\nbfa_fsm_send_event(tx, TX_E_START);\r\n}\r\nvoid\r\nbna_tx_disable(struct bna_tx *tx, enum bna_cleanup_type type,\r\nvoid (*cbfn)(void *, struct bna_tx *))\r\n{\r\nif (type == BNA_SOFT_CLEANUP) {\r\n(*cbfn)(tx->bna->bnad, tx);\r\nreturn;\r\n}\r\ntx->stop_cbfn = cbfn;\r\ntx->stop_cbarg = tx->bna->bnad;\r\ntx->flags &= ~BNA_TX_F_ENABLED;\r\nbfa_fsm_send_event(tx, TX_E_STOP);\r\n}\r\nvoid\r\nbna_tx_cleanup_complete(struct bna_tx *tx)\r\n{\r\nbfa_fsm_send_event(tx, TX_E_CLEANUP_DONE);\r\n}\r\nstatic void\r\nbna_tx_mod_cb_tx_stopped(void *arg, struct bna_tx *tx)\r\n{\r\nstruct bna_tx_mod *tx_mod = (struct bna_tx_mod *)arg;\r\nbfa_wc_down(&tx_mod->tx_stop_wc);\r\n}\r\nstatic void\r\nbna_tx_mod_cb_tx_stopped_all(void *arg)\r\n{\r\nstruct bna_tx_mod *tx_mod = (struct bna_tx_mod *)arg;\r\nif (tx_mod->stop_cbfn)\r\ntx_mod->stop_cbfn(&tx_mod->bna->enet);\r\ntx_mod->stop_cbfn = NULL;\r\n}\r\nvoid\r\nbna_tx_mod_init(struct bna_tx_mod *tx_mod, struct bna *bna,\r\nstruct bna_res_info *res_info)\r\n{\r\nint i;\r\ntx_mod->bna = bna;\r\ntx_mod->flags = 0;\r\ntx_mod->tx = (struct bna_tx *)\r\nres_info[BNA_MOD_RES_MEM_T_TX_ARRAY].res_u.mem_info.mdl[0].kva;\r\ntx_mod->txq = (struct bna_txq *)\r\nres_info[BNA_MOD_RES_MEM_T_TXQ_ARRAY].res_u.mem_info.mdl[0].kva;\r\nINIT_LIST_HEAD(&tx_mod->tx_free_q);\r\nINIT_LIST_HEAD(&tx_mod->tx_active_q);\r\nINIT_LIST_HEAD(&tx_mod->txq_free_q);\r\nfor (i = 0; i < bna->ioceth.attr.num_txq; i++) {\r\ntx_mod->tx[i].rid = i;\r\nbfa_q_qe_init(&tx_mod->tx[i].qe);\r\nlist_add_tail(&tx_mod->tx[i].qe, &tx_mod->tx_free_q);\r\nbfa_q_qe_init(&tx_mod->txq[i].qe);\r\nlist_add_tail(&tx_mod->txq[i].qe, &tx_mod->txq_free_q);\r\n}\r\ntx_mod->prio_map = BFI_TX_PRIO_MAP_ALL;\r\ntx_mod->default_prio = 0;\r\ntx_mod->iscsi_over_cee = BNA_STATUS_T_DISABLED;\r\ntx_mod->iscsi_prio = -1;\r\n}\r\nvoid\r\nbna_tx_mod_uninit(struct bna_tx_mod *tx_mod)\r\n{\r\nstruct list_head *qe;\r\nint i;\r\ni = 0;\r\nlist_for_each(qe, &tx_mod->tx_free_q)\r\ni++;\r\ni = 0;\r\nlist_for_each(qe, &tx_mod->txq_free_q)\r\ni++;\r\ntx_mod->bna = NULL;\r\n}\r\nvoid\r\nbna_tx_mod_start(struct bna_tx_mod *tx_mod, enum bna_tx_type type)\r\n{\r\nstruct bna_tx *tx;\r\nstruct list_head *qe;\r\ntx_mod->flags |= BNA_TX_MOD_F_ENET_STARTED;\r\nif (type == BNA_TX_T_LOOPBACK)\r\ntx_mod->flags |= BNA_TX_MOD_F_ENET_LOOPBACK;\r\nlist_for_each(qe, &tx_mod->tx_active_q) {\r\ntx = (struct bna_tx *)qe;\r\nif (tx->type == type)\r\nbna_tx_start(tx);\r\n}\r\n}\r\nvoid\r\nbna_tx_mod_stop(struct bna_tx_mod *tx_mod, enum bna_tx_type type)\r\n{\r\nstruct bna_tx *tx;\r\nstruct list_head *qe;\r\ntx_mod->flags &= ~BNA_TX_MOD_F_ENET_STARTED;\r\ntx_mod->flags &= ~BNA_TX_MOD_F_ENET_LOOPBACK;\r\ntx_mod->stop_cbfn = bna_enet_cb_tx_stopped;\r\nbfa_wc_init(&tx_mod->tx_stop_wc, bna_tx_mod_cb_tx_stopped_all, tx_mod);\r\nlist_for_each(qe, &tx_mod->tx_active_q) {\r\ntx = (struct bna_tx *)qe;\r\nif (tx->type == type) {\r\nbfa_wc_up(&tx_mod->tx_stop_wc);\r\nbna_tx_stop(tx);\r\n}\r\n}\r\nbfa_wc_wait(&tx_mod->tx_stop_wc);\r\n}\r\nvoid\r\nbna_tx_mod_fail(struct bna_tx_mod *tx_mod)\r\n{\r\nstruct bna_tx *tx;\r\nstruct list_head *qe;\r\ntx_mod->flags &= ~BNA_TX_MOD_F_ENET_STARTED;\r\ntx_mod->flags &= ~BNA_TX_MOD_F_ENET_LOOPBACK;\r\nlist_for_each(qe, &tx_mod->tx_active_q) {\r\ntx = (struct bna_tx *)qe;\r\nbna_tx_fail(tx);\r\n}\r\n}\r\nvoid\r\nbna_tx_coalescing_timeo_set(struct bna_tx *tx, int coalescing_timeo)\r\n{\r\nstruct bna_txq *txq;\r\nstruct list_head *qe;\r\nlist_for_each(qe, &tx->txq_q) {\r\ntxq = (struct bna_txq *)qe;\r\nbna_ib_coalescing_timeo_set(&txq->ib, coalescing_timeo);\r\n}\r\n}

static int snd_virmidi_probe(struct platform_device *devptr)\r\n{\r\nstruct snd_card *card;\r\nstruct snd_card_virmidi *vmidi;\r\nint idx, err;\r\nint dev = devptr->id;\r\nerr = snd_card_create(index[dev], id[dev], THIS_MODULE,\r\nsizeof(struct snd_card_virmidi), &card);\r\nif (err < 0)\r\nreturn err;\r\nvmidi = card->private_data;\r\nvmidi->card = card;\r\nif (midi_devs[dev] > MAX_MIDI_DEVICES) {\r\nsnd_printk(KERN_WARNING\r\n"too much midi devices for virmidi %d: "\r\n"force to use %d\n", dev, MAX_MIDI_DEVICES);\r\nmidi_devs[dev] = MAX_MIDI_DEVICES;\r\n}\r\nfor (idx = 0; idx < midi_devs[dev]; idx++) {\r\nstruct snd_rawmidi *rmidi;\r\nstruct snd_virmidi_dev *rdev;\r\nif ((err = snd_virmidi_new(card, idx, &rmidi)) < 0)\r\ngoto __nodev;\r\nrdev = rmidi->private_data;\r\nvmidi->midi[idx] = rmidi;\r\nstrcpy(rmidi->name, "Virtual Raw MIDI");\r\nrdev->seq_mode = SNDRV_VIRMIDI_SEQ_DISPATCH;\r\n}\r\nstrcpy(card->driver, "VirMIDI");\r\nstrcpy(card->shortname, "VirMIDI");\r\nsprintf(card->longname, "Virtual MIDI Card %i", dev + 1);\r\nsnd_card_set_dev(card, &devptr->dev);\r\nif ((err = snd_card_register(card)) == 0) {\r\nplatform_set_drvdata(devptr, card);\r\nreturn 0;\r\n}\r\n__nodev:\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\nstatic int snd_virmidi_remove(struct platform_device *devptr)\r\n{\r\nsnd_card_free(platform_get_drvdata(devptr));\r\nplatform_set_drvdata(devptr, NULL);\r\nreturn 0;\r\n}\r\nstatic void snd_virmidi_unregister_all(void)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(devices); ++i)\r\nplatform_device_unregister(devices[i]);\r\nplatform_driver_unregister(&snd_virmidi_driver);\r\n}\r\nstatic int __init alsa_card_virmidi_init(void)\r\n{\r\nint i, cards, err;\r\nif ((err = platform_driver_register(&snd_virmidi_driver)) < 0)\r\nreturn err;\r\ncards = 0;\r\nfor (i = 0; i < SNDRV_CARDS; i++) {\r\nstruct platform_device *device;\r\nif (! enable[i])\r\ncontinue;\r\ndevice = platform_device_register_simple(SND_VIRMIDI_DRIVER,\r\ni, NULL, 0);\r\nif (IS_ERR(device))\r\ncontinue;\r\nif (!platform_get_drvdata(device)) {\r\nplatform_device_unregister(device);\r\ncontinue;\r\n}\r\ndevices[i] = device;\r\ncards++;\r\n}\r\nif (!cards) {\r\n#ifdef MODULE\r\nprintk(KERN_ERR "Card-VirMIDI soundcard not found or device busy\n");\r\n#endif\r\nsnd_virmidi_unregister_all();\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit alsa_card_virmidi_exit(void)\r\n{\r\nsnd_virmidi_unregister_all();\r\n}

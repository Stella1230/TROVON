static int exynos_drm_load(struct drm_device *dev, unsigned long flags)\r\n{\r\nstruct exynos_drm_private *private;\r\nint ret;\r\nint nr;\r\nDRM_DEBUG_DRIVER("%s\n", __FILE__);\r\nprivate = kzalloc(sizeof(struct exynos_drm_private), GFP_KERNEL);\r\nif (!private) {\r\nDRM_ERROR("failed to allocate private\n");\r\nreturn -ENOMEM;\r\n}\r\nINIT_LIST_HEAD(&private->pageflip_event_list);\r\ndev->dev_private = (void *)private;\r\nret = drm_create_iommu_mapping(dev);\r\nif (ret < 0) {\r\nDRM_ERROR("failed to create iommu mapping.\n");\r\ngoto err_crtc;\r\n}\r\ndrm_mode_config_init(dev);\r\ndrm_kms_helper_poll_init(dev);\r\nexynos_drm_mode_config_init(dev);\r\nfor (nr = 0; nr < MAX_CRTC; nr++) {\r\nret = exynos_drm_crtc_create(dev, nr);\r\nif (ret)\r\ngoto err_release_iommu_mapping;\r\n}\r\nfor (nr = 0; nr < MAX_PLANE; nr++) {\r\nstruct drm_plane *plane;\r\nunsigned int possible_crtcs = (1 << MAX_CRTC) - 1;\r\nplane = exynos_plane_init(dev, possible_crtcs, false);\r\nif (!plane)\r\ngoto err_release_iommu_mapping;\r\n}\r\nret = drm_vblank_init(dev, MAX_CRTC);\r\nif (ret)\r\ngoto err_release_iommu_mapping;\r\nret = exynos_drm_device_register(dev);\r\nif (ret)\r\ngoto err_vblank;\r\nexynos_drm_encoder_setup(dev);\r\nret = exynos_drm_fbdev_init(dev);\r\nif (ret) {\r\nDRM_ERROR("failed to initialize drm fbdev\n");\r\ngoto err_drm_device;\r\n}\r\ndrm_vblank_offdelay = VBLANK_OFF_DELAY;\r\nreturn 0;\r\nerr_drm_device:\r\nexynos_drm_device_unregister(dev);\r\nerr_vblank:\r\ndrm_vblank_cleanup(dev);\r\nerr_release_iommu_mapping:\r\ndrm_release_iommu_mapping(dev);\r\nerr_crtc:\r\ndrm_mode_config_cleanup(dev);\r\nkfree(private);\r\nreturn ret;\r\n}\r\nstatic int exynos_drm_unload(struct drm_device *dev)\r\n{\r\nDRM_DEBUG_DRIVER("%s\n", __FILE__);\r\nexynos_drm_fbdev_fini(dev);\r\nexynos_drm_device_unregister(dev);\r\ndrm_vblank_cleanup(dev);\r\ndrm_kms_helper_poll_fini(dev);\r\ndrm_mode_config_cleanup(dev);\r\ndrm_release_iommu_mapping(dev);\r\nkfree(dev->dev_private);\r\ndev->dev_private = NULL;\r\nreturn 0;\r\n}\r\nstatic int exynos_drm_open(struct drm_device *dev, struct drm_file *file)\r\n{\r\nstruct drm_exynos_file_private *file_priv;\r\nDRM_DEBUG_DRIVER("%s\n", __FILE__);\r\nfile_priv = kzalloc(sizeof(*file_priv), GFP_KERNEL);\r\nif (!file_priv)\r\nreturn -ENOMEM;\r\nfile->driver_priv = file_priv;\r\nreturn exynos_drm_subdrv_open(dev, file);\r\n}\r\nstatic void exynos_drm_preclose(struct drm_device *dev,\r\nstruct drm_file *file)\r\n{\r\nstruct exynos_drm_private *private = dev->dev_private;\r\nstruct drm_pending_vblank_event *e, *t;\r\nunsigned long flags;\r\nDRM_DEBUG_DRIVER("%s\n", __FILE__);\r\nspin_lock_irqsave(&dev->event_lock, flags);\r\nlist_for_each_entry_safe(e, t, &private->pageflip_event_list,\r\nbase.link) {\r\nif (e->base.file_priv == file) {\r\nlist_del(&e->base.link);\r\ne->base.destroy(&e->base);\r\n}\r\n}\r\nspin_unlock_irqrestore(&dev->event_lock, flags);\r\nexynos_drm_subdrv_close(dev, file);\r\n}\r\nstatic void exynos_drm_postclose(struct drm_device *dev, struct drm_file *file)\r\n{\r\nDRM_DEBUG_DRIVER("%s\n", __FILE__);\r\nif (!file->driver_priv)\r\nreturn;\r\nkfree(file->driver_priv);\r\nfile->driver_priv = NULL;\r\n}\r\nstatic void exynos_drm_lastclose(struct drm_device *dev)\r\n{\r\nDRM_DEBUG_DRIVER("%s\n", __FILE__);\r\nexynos_drm_fbdev_restore_mode(dev);\r\n}\r\nstatic int exynos_drm_platform_probe(struct platform_device *pdev)\r\n{\r\nDRM_DEBUG_DRIVER("%s\n", __FILE__);\r\npdev->dev.coherent_dma_mask = DMA_BIT_MASK(32);\r\nexynos_drm_driver.num_ioctls = DRM_ARRAY_SIZE(exynos_ioctls);\r\nreturn drm_platform_init(&exynos_drm_driver, pdev);\r\n}\r\nstatic int exynos_drm_platform_remove(struct platform_device *pdev)\r\n{\r\nDRM_DEBUG_DRIVER("%s\n", __FILE__);\r\ndrm_platform_exit(&exynos_drm_driver, pdev);\r\nreturn 0;\r\n}\r\nstatic int __init exynos_drm_init(void)\r\n{\r\nint ret;\r\nDRM_DEBUG_DRIVER("%s\n", __FILE__);\r\n#ifdef CONFIG_DRM_EXYNOS_FIMD\r\nret = platform_driver_register(&fimd_driver);\r\nif (ret < 0)\r\ngoto out_fimd;\r\n#endif\r\n#ifdef CONFIG_DRM_EXYNOS_HDMI\r\nret = platform_driver_register(&hdmi_driver);\r\nif (ret < 0)\r\ngoto out_hdmi;\r\nret = platform_driver_register(&mixer_driver);\r\nif (ret < 0)\r\ngoto out_mixer;\r\nret = platform_driver_register(&exynos_drm_common_hdmi_driver);\r\nif (ret < 0)\r\ngoto out_common_hdmi;\r\nret = exynos_platform_device_hdmi_register();\r\nif (ret < 0)\r\ngoto out_common_hdmi_dev;\r\n#endif\r\n#ifdef CONFIG_DRM_EXYNOS_VIDI\r\nret = platform_driver_register(&vidi_driver);\r\nif (ret < 0)\r\ngoto out_vidi;\r\n#endif\r\n#ifdef CONFIG_DRM_EXYNOS_G2D\r\nret = platform_driver_register(&g2d_driver);\r\nif (ret < 0)\r\ngoto out_g2d;\r\n#endif\r\n#ifdef CONFIG_DRM_EXYNOS_FIMC\r\nret = platform_driver_register(&fimc_driver);\r\nif (ret < 0)\r\ngoto out_fimc;\r\n#endif\r\n#ifdef CONFIG_DRM_EXYNOS_ROTATOR\r\nret = platform_driver_register(&rotator_driver);\r\nif (ret < 0)\r\ngoto out_rotator;\r\n#endif\r\n#ifdef CONFIG_DRM_EXYNOS_GSC\r\nret = platform_driver_register(&gsc_driver);\r\nif (ret < 0)\r\ngoto out_gsc;\r\n#endif\r\n#ifdef CONFIG_DRM_EXYNOS_IPP\r\nret = platform_driver_register(&ipp_driver);\r\nif (ret < 0)\r\ngoto out_ipp;\r\n#endif\r\nret = platform_driver_register(&exynos_drm_platform_driver);\r\nif (ret < 0)\r\ngoto out_drm;\r\nexynos_drm_pdev = platform_device_register_simple("exynos-drm", -1,\r\nNULL, 0);\r\nif (IS_ERR_OR_NULL(exynos_drm_pdev)) {\r\nret = PTR_ERR(exynos_drm_pdev);\r\ngoto out;\r\n}\r\nreturn 0;\r\nout:\r\nplatform_driver_unregister(&exynos_drm_platform_driver);\r\nout_drm:\r\n#ifdef CONFIG_DRM_EXYNOS_IPP\r\nplatform_driver_unregister(&ipp_driver);\r\nout_ipp:\r\n#endif\r\n#ifdef CONFIG_DRM_EXYNOS_GSC\r\nplatform_driver_unregister(&gsc_driver);\r\nout_gsc:\r\n#endif\r\n#ifdef CONFIG_DRM_EXYNOS_ROTATOR\r\nplatform_driver_unregister(&rotator_driver);\r\nout_rotator:\r\n#endif\r\n#ifdef CONFIG_DRM_EXYNOS_FIMC\r\nplatform_driver_unregister(&fimc_driver);\r\nout_fimc:\r\n#endif\r\n#ifdef CONFIG_DRM_EXYNOS_G2D\r\nplatform_driver_unregister(&g2d_driver);\r\nout_g2d:\r\n#endif\r\n#ifdef CONFIG_DRM_EXYNOS_VIDI\r\nplatform_driver_unregister(&vidi_driver);\r\nout_vidi:\r\n#endif\r\n#ifdef CONFIG_DRM_EXYNOS_HDMI\r\nexynos_platform_device_hdmi_unregister();\r\nout_common_hdmi_dev:\r\nplatform_driver_unregister(&exynos_drm_common_hdmi_driver);\r\nout_common_hdmi:\r\nplatform_driver_unregister(&mixer_driver);\r\nout_mixer:\r\nplatform_driver_unregister(&hdmi_driver);\r\nout_hdmi:\r\n#endif\r\n#ifdef CONFIG_DRM_EXYNOS_FIMD\r\nplatform_driver_unregister(&fimd_driver);\r\nout_fimd:\r\n#endif\r\nreturn ret;\r\n}\r\nstatic void __exit exynos_drm_exit(void)\r\n{\r\nDRM_DEBUG_DRIVER("%s\n", __FILE__);\r\nplatform_device_unregister(exynos_drm_pdev);\r\nplatform_driver_unregister(&exynos_drm_platform_driver);\r\n#ifdef CONFIG_DRM_EXYNOS_IPP\r\nplatform_driver_unregister(&ipp_driver);\r\n#endif\r\n#ifdef CONFIG_DRM_EXYNOS_GSC\r\nplatform_driver_unregister(&gsc_driver);\r\n#endif\r\n#ifdef CONFIG_DRM_EXYNOS_ROTATOR\r\nplatform_driver_unregister(&rotator_driver);\r\n#endif\r\n#ifdef CONFIG_DRM_EXYNOS_FIMC\r\nplatform_driver_unregister(&fimc_driver);\r\n#endif\r\n#ifdef CONFIG_DRM_EXYNOS_G2D\r\nplatform_driver_unregister(&g2d_driver);\r\n#endif\r\n#ifdef CONFIG_DRM_EXYNOS_HDMI\r\nexynos_platform_device_hdmi_unregister();\r\nplatform_driver_unregister(&exynos_drm_common_hdmi_driver);\r\nplatform_driver_unregister(&mixer_driver);\r\nplatform_driver_unregister(&hdmi_driver);\r\n#endif\r\n#ifdef CONFIG_DRM_EXYNOS_VIDI\r\nplatform_driver_unregister(&vidi_driver);\r\n#endif\r\n#ifdef CONFIG_DRM_EXYNOS_FIMD\r\nplatform_driver_unregister(&fimd_driver);\r\n#endif\r\n}

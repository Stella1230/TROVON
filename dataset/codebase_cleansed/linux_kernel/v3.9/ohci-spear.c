static void spear_start_ohci(struct spear_ohci *ohci)\r\n{\r\nclk_prepare_enable(ohci->clk);\r\n}\r\nstatic void spear_stop_ohci(struct spear_ohci *ohci)\r\n{\r\nclk_disable_unprepare(ohci->clk);\r\n}\r\nstatic int ohci_spear_start(struct usb_hcd *hcd)\r\n{\r\nstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\r\nint ret;\r\nret = ohci_init(ohci);\r\nif (ret < 0)\r\nreturn ret;\r\nohci->regs = hcd->regs;\r\nret = ohci_run(ohci);\r\nif (ret < 0) {\r\ndev_err(hcd->self.controller, "can't start\n");\r\nohci_stop(hcd);\r\nreturn ret;\r\n}\r\ncreate_debug_files(ohci);\r\n#ifdef DEBUG\r\nohci_dump(ohci, 1);\r\n#endif\r\nreturn 0;\r\n}\r\nstatic int spear_ohci_hcd_drv_probe(struct platform_device *pdev)\r\n{\r\nconst struct hc_driver *driver = &ohci_spear_hc_driver;\r\nstruct usb_hcd *hcd = NULL;\r\nstruct clk *usbh_clk;\r\nstruct spear_ohci *ohci_p;\r\nstruct resource *res;\r\nint retval, irq;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\nretval = irq;\r\ngoto fail;\r\n}\r\nif (!pdev->dev.dma_mask)\r\npdev->dev.dma_mask = &spear_ohci_dma_mask;\r\nusbh_clk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(usbh_clk)) {\r\ndev_err(&pdev->dev, "Error getting interface clock\n");\r\nretval = PTR_ERR(usbh_clk);\r\ngoto fail;\r\n}\r\nhcd = usb_create_hcd(driver, &pdev->dev, dev_name(&pdev->dev));\r\nif (!hcd) {\r\nretval = -ENOMEM;\r\ngoto fail;\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\nretval = -ENODEV;\r\ngoto err_put_hcd;\r\n}\r\nhcd->rsrc_start = pdev->resource[0].start;\r\nhcd->rsrc_len = resource_size(res);\r\nif (!devm_request_mem_region(&pdev->dev, hcd->rsrc_start, hcd->rsrc_len,\r\nhcd_name)) {\r\ndev_dbg(&pdev->dev, "request_mem_region failed\n");\r\nretval = -EBUSY;\r\ngoto err_put_hcd;\r\n}\r\nhcd->regs = devm_ioremap(&pdev->dev, hcd->rsrc_start, hcd->rsrc_len);\r\nif (!hcd->regs) {\r\ndev_dbg(&pdev->dev, "ioremap failed\n");\r\nretval = -ENOMEM;\r\ngoto err_put_hcd;\r\n}\r\nohci_p = (struct spear_ohci *)hcd_to_ohci(hcd);\r\nohci_p->clk = usbh_clk;\r\nspear_start_ohci(ohci_p);\r\nohci_hcd_init(hcd_to_ohci(hcd));\r\nretval = usb_add_hcd(hcd, platform_get_irq(pdev, 0), 0);\r\nif (retval == 0)\r\nreturn retval;\r\nspear_stop_ohci(ohci_p);\r\nerr_put_hcd:\r\nusb_put_hcd(hcd);\r\nfail:\r\ndev_err(&pdev->dev, "init fail, %d\n", retval);\r\nreturn retval;\r\n}\r\nstatic int spear_ohci_hcd_drv_remove(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nstruct spear_ohci *ohci_p = to_spear_ohci(hcd);\r\nusb_remove_hcd(hcd);\r\nif (ohci_p->clk)\r\nspear_stop_ohci(ohci_p);\r\nusb_put_hcd(hcd);\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn 0;\r\n}\r\nstatic int spear_ohci_hcd_drv_suspend(struct platform_device *dev,\r\npm_message_t message)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(dev);\r\nstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\r\nstruct spear_ohci *ohci_p = to_spear_ohci(hcd);\r\nif (time_before(jiffies, ohci->next_statechange))\r\nmsleep(5);\r\nohci->next_statechange = jiffies;\r\nspear_stop_ohci(ohci_p);\r\nreturn 0;\r\n}\r\nstatic int spear_ohci_hcd_drv_resume(struct platform_device *dev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(dev);\r\nstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\r\nstruct spear_ohci *ohci_p = to_spear_ohci(hcd);\r\nif (time_before(jiffies, ohci->next_statechange))\r\nmsleep(5);\r\nohci->next_statechange = jiffies;\r\nspear_start_ohci(ohci_p);\r\nohci_resume(hcd, false);\r\nreturn 0;\r\n}

static void __init imx_cpuidle_devices_uninit(void)\r\n{\r\nint cpu_id;\r\nstruct cpuidle_device *dev;\r\nfor_each_possible_cpu(cpu_id) {\r\ndev = per_cpu_ptr(imx_cpuidle_devices, cpu_id);\r\ncpuidle_unregister_device(dev);\r\n}\r\nfree_percpu(imx_cpuidle_devices);\r\n}\r\nint __init imx_cpuidle_init(struct cpuidle_driver *drv)\r\n{\r\nstruct cpuidle_device *dev;\r\nint cpu_id, ret;\r\nif (drv->state_count > CPUIDLE_STATE_MAX) {\r\npr_err("%s: state_count exceeds maximum\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nret = cpuidle_register_driver(drv);\r\nif (ret) {\r\npr_err("%s: Failed to register cpuidle driver with error: %d\n",\r\n__func__, ret);\r\nreturn ret;\r\n}\r\nimx_cpuidle_devices = alloc_percpu(struct cpuidle_device);\r\nif (imx_cpuidle_devices == NULL) {\r\nret = -ENOMEM;\r\ngoto unregister_drv;\r\n}\r\nfor_each_possible_cpu(cpu_id) {\r\ndev = per_cpu_ptr(imx_cpuidle_devices, cpu_id);\r\ndev->cpu = cpu_id;\r\ndev->state_count = drv->state_count;\r\nret = cpuidle_register_device(dev);\r\nif (ret) {\r\npr_err("%s: Failed to register cpu %u, error: %d\n",\r\n__func__, cpu_id, ret);\r\ngoto uninit;\r\n}\r\n}\r\nreturn 0;\r\nuninit:\r\nimx_cpuidle_devices_uninit();\r\nunregister_drv:\r\ncpuidle_unregister_driver(drv);\r\nreturn ret;\r\n}

static unsigned long\r\n__arm_gen_branch_thumb2(unsigned long pc, unsigned long addr, bool link)\r\n{\r\nunsigned long s, j1, j2, i1, i2, imm10, imm11;\r\nunsigned long first, second;\r\nlong offset;\r\noffset = (long)addr - (long)(pc + 4);\r\nif (offset < -16777216 || offset > 16777214) {\r\nWARN_ON_ONCE(1);\r\nreturn 0;\r\n}\r\ns = (offset >> 24) & 0x1;\r\ni1 = (offset >> 23) & 0x1;\r\ni2 = (offset >> 22) & 0x1;\r\nimm10 = (offset >> 12) & 0x3ff;\r\nimm11 = (offset >> 1) & 0x7ff;\r\nj1 = (!i1) ^ s;\r\nj2 = (!i2) ^ s;\r\nfirst = 0xf000 | (s << 10) | imm10;\r\nsecond = 0x9000 | (j1 << 13) | (j2 << 11) | imm11;\r\nif (link)\r\nsecond |= 1 << 14;\r\nreturn __opcode_thumb32_compose(first, second);\r\n}\r\nstatic unsigned long\r\n__arm_gen_branch_arm(unsigned long pc, unsigned long addr, bool link)\r\n{\r\nunsigned long opcode = 0xea000000;\r\nlong offset;\r\nif (link)\r\nopcode |= 1 << 24;\r\noffset = (long)addr - (long)(pc + 8);\r\nif (unlikely(offset < -33554432 || offset > 33554428)) {\r\nWARN_ON_ONCE(1);\r\nreturn 0;\r\n}\r\noffset = (offset >> 2) & 0x00ffffff;\r\nreturn opcode | offset;\r\n}\r\nunsigned long\r\n__arm_gen_branch(unsigned long pc, unsigned long addr, bool link)\r\n{\r\nif (IS_ENABLED(CONFIG_THUMB2_KERNEL))\r\nreturn __arm_gen_branch_thumb2(pc, addr, link);\r\nelse\r\nreturn __arm_gen_branch_arm(pc, addr, link);\r\n}

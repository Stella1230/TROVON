unifi_TrafficQueue unifi_frame_priority_to_queue(CSR_PRIORITY priority)\r\n{\r\nswitch (priority)\r\n{\r\ncase CSR_QOS_UP0:\r\ncase CSR_QOS_UP3:\r\nreturn UNIFI_TRAFFIC_Q_BE;\r\ncase CSR_QOS_UP1:\r\ncase CSR_QOS_UP2:\r\nreturn UNIFI_TRAFFIC_Q_BK;\r\ncase CSR_QOS_UP4:\r\ncase CSR_QOS_UP5:\r\nreturn UNIFI_TRAFFIC_Q_VI;\r\ncase CSR_QOS_UP6:\r\ncase CSR_QOS_UP7:\r\ncase CSR_MANAGEMENT:\r\nreturn UNIFI_TRAFFIC_Q_VO;\r\ndefault:\r\nreturn UNIFI_TRAFFIC_Q_BE;\r\n}\r\n}\r\nCSR_PRIORITY unifi_get_default_downgrade_priority(unifi_TrafficQueue queue)\r\n{\r\nswitch (queue)\r\n{\r\ncase UNIFI_TRAFFIC_Q_BE:\r\nreturn CSR_QOS_UP0;\r\ncase UNIFI_TRAFFIC_Q_BK:\r\nreturn CSR_QOS_UP1;\r\ncase UNIFI_TRAFFIC_Q_VI:\r\nreturn CSR_QOS_UP5;\r\ncase UNIFI_TRAFFIC_Q_VO:\r\nreturn CSR_QOS_UP6;\r\ndefault:\r\nreturn CSR_QOS_UP0;\r\n}\r\n}\r\nstatic CsrResult send_signal(card_t *card, const u8 *sigptr, u32 siglen,\r\nconst bulk_data_param_t *bulkdata,\r\nq_t *sigq, u32 priority_q, u32 run_bh)\r\n{\r\nu16 i, data_slot_size;\r\ncard_signal_t *csptr;\r\ns16 qe;\r\nCsrResult r;\r\ns16 debug_print = 0;\r\ndata_slot_size = CardGetDataSlotSize(card);\r\nif (!CSR_WIFI_HIP_Q_SLOTS_FREE(sigq))\r\n{\r\nunifi_trace(card->ospriv, UDBG3, "send_signal: %s full\n", sigq->name);\r\nreturn CSR_WIFI_HIP_RESULT_NO_SPACE;\r\n}\r\nqe = CSR_WIFI_HIP_Q_NEXT_W_SLOT(sigq);\r\ncsptr = CSR_WIFI_HIP_Q_SLOT_DATA(sigq, qe);\r\ncsptr->signal_length = (u16)siglen;\r\nmemcpy((void *)csptr->sigbuf, (void *)sigptr, siglen);\r\nfor (i = 0; i < UNIFI_MAX_DATA_REFERENCES; ++i)\r\n{\r\nif ((bulkdata != NULL) && (bulkdata->d[i].data_length != 0))\r\n{\r\nu32 datalen = bulkdata->d[i].data_length;\r\nif (bulkdata->d[i].os_data_ptr == NULL)\r\n{\r\nunifi_error(card->ospriv, "send_signal - NULL bulkdata[%d]\n", i);\r\ndebug_print++;\r\ncsptr->bulkdata[i].data_length = 0;\r\n}\r\nelse\r\n{\r\nif (datalen > data_slot_size)\r\n{\r\nunifi_error(card->ospriv,\r\n"send_signal - Invalid data length %u (@%p), "\r\n"truncating\n",\r\ndatalen, bulkdata->d[i].os_data_ptr);\r\ndatalen = data_slot_size;\r\ndebug_print++;\r\n}\r\ncsptr->bulkdata[i].os_data_ptr = (u8 *)bulkdata->d[i].os_data_ptr;\r\ncsptr->bulkdata[i].os_net_buf_ptr = (u8 *)bulkdata->d[i].os_net_buf_ptr;\r\ncsptr->bulkdata[i].net_buf_length = bulkdata->d[i].net_buf_length;\r\ncsptr->bulkdata[i].data_length = datalen;\r\n}\r\n}\r\nelse\r\n{\r\nUNIFI_INIT_BULK_DATA(&csptr->bulkdata[i]);\r\n}\r\n}\r\nif (debug_print)\r\n{\r\nconst u8 *sig = sigptr;\r\nunifi_error(card->ospriv, "Signal(%d): %*ph\n", siglen,\r\n16, sig);\r\nunifi_error(card->ospriv, "Bulkdata pointer %p(%d), %p(%d)\n",\r\nbulkdata != NULL?bulkdata->d[0].os_data_ptr : NULL,\r\nbulkdata != NULL?bulkdata->d[0].data_length : 0,\r\nbulkdata != NULL?bulkdata->d[1].os_data_ptr : NULL,\r\nbulkdata != NULL?bulkdata->d[1].data_length : 0);\r\n}\r\nCSR_WIFI_HIP_Q_INC_W(sigq);\r\nif (run_bh == 1)\r\n{\r\ncard->bh_reason_host = 1;\r\nr = unifi_run_bh(card->ospriv);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nunifi_error(card->ospriv, "failed to run bh.\n");\r\ncard->bh_reason_host = 0;\r\nfor (i = 0; i < UNIFI_MAX_DATA_REFERENCES; ++i)\r\n{\r\nif (csptr->bulkdata[i].data_length != 0)\r\n{\r\ncsptr->bulkdata[i].os_data_ptr = csptr->bulkdata[i].os_net_buf_ptr = NULL;\r\ncsptr->bulkdata[i].net_buf_length = csptr->bulkdata[i].data_length = 0;\r\n}\r\n}\r\nreturn r;\r\n}\r\n}\r\nelse\r\n{\r\nunifi_error(card->ospriv, "run_bh=%d, bh not called.\n", run_bh);\r\n}\r\nif (CSR_WIFI_HIP_Q_SLOTS_FREE(sigq) == 0)\r\n{\r\nif (sigq != &card->fh_command_queue)\r\n{\r\n#if defined (CSR_WIFI_HIP_DEBUG_OFFLINE) && defined (CSR_WIFI_HIP_DATA_PLANE_PROFILE)\r\nunifi_debug_log_to_buf("P");\r\n#endif\r\nunifi_pause_xmit(card->ospriv, (unifi_TrafficQueue)priority_q);\r\ncard_tx_q_pause(card, priority_q);\r\nif (CSR_WIFI_HIP_Q_SLOTS_USED(sigq) == 0)\r\n{\r\ncard_tx_q_unpause(card, priority_q);\r\nunifi_restart_xmit(card->ospriv, (unifi_TrafficQueue) priority_q);\r\n}\r\n}\r\nelse\r\n{\r\nunifi_warning(card->ospriv,\r\n"send_signal: fh_cmd_q full, not pausing (run_bh=%d)\n",\r\nrun_bh);\r\n}\r\n}\r\nreturn CSR_RESULT_SUCCESS;\r\n}\r\nCsrResult unifi_send_signal(card_t *card, const u8 *sigptr, u32 siglen,\r\nconst bulk_data_param_t *bulkdata)\r\n{\r\nq_t *sig_soft_q;\r\nu16 signal_id;\r\nCsrResult r;\r\nu32 run_bh;\r\nu32 priority_q;\r\nif (sigptr == NULL)\r\n{\r\ncard->bh_reason_host = 1;\r\nreturn unifi_run_bh(card->ospriv);\r\n}\r\npriority_q = 0;\r\nrun_bh = 1;\r\nsignal_id = GET_SIGNAL_ID(sigptr);\r\nif (signal_id == CSR_MA_PACKET_REQUEST_ID)\r\n{\r\nu16 frame_priority;\r\nif (card->periodic_wake_mode == UNIFI_PERIODIC_WAKE_HOST_ENABLED)\r\n{\r\nrun_bh = 0;\r\n}\r\n#if defined (CSR_WIFI_HIP_DEBUG_OFFLINE) && defined (CSR_WIFI_HIP_DATA_PLANE_PROFILE)\r\nunifi_debug_log_to_buf("D");\r\n#endif\r\nif ((bulkdata->d[0].data_length == 0) || (bulkdata->d[0].os_data_ptr == NULL))\r\n{\r\nunifi_error(card->ospriv, "MA-PACKET.req with empty bulk data (%d bytes in %p)\n",\r\nbulkdata->d[0].data_length, bulkdata->d[0].os_data_ptr);\r\ndump((void *)sigptr, siglen);\r\nreturn CSR_RESULT_FAILURE;\r\n}\r\nframe_priority = GET_PACKED_MA_PACKET_REQUEST_FRAME_PRIORITY(sigptr);\r\npriority_q = unifi_frame_priority_to_queue((CSR_PRIORITY)frame_priority);\r\nsig_soft_q = &card->fh_traffic_queue[priority_q];\r\n}\r\nelse\r\n{\r\nsig_soft_q = &card->fh_command_queue;\r\n}\r\nr = send_signal(card, sigptr, siglen, bulkdata, sig_soft_q, priority_q, run_bh);\r\nreturn r;\r\n}\r\nCsrResult unifi_send_resources_available(card_t *card, const u8 *sigptr)\r\n{\r\nq_t *sig_soft_q;\r\nu16 signal_id = GET_SIGNAL_ID(sigptr);\r\nif (signal_id == CSR_MA_PACKET_REQUEST_ID)\r\n{\r\nu16 frame_priority;\r\nu32 priority_q;\r\nframe_priority = GET_PACKED_MA_PACKET_REQUEST_FRAME_PRIORITY(sigptr);\r\npriority_q = unifi_frame_priority_to_queue((CSR_PRIORITY)frame_priority);\r\nsig_soft_q = &card->fh_traffic_queue[priority_q];\r\n}\r\nelse\r\n{\r\nsig_soft_q = &card->fh_command_queue;\r\n}\r\nif (!CSR_WIFI_HIP_Q_SLOTS_FREE(sig_soft_q))\r\n{\r\nunifi_notice(card->ospriv, "unifi_send_resources_available: %s full\n",\r\nsig_soft_q->name);\r\nreturn CSR_WIFI_HIP_RESULT_NO_SPACE;\r\n}\r\nreturn CSR_RESULT_SUCCESS;\r\n}

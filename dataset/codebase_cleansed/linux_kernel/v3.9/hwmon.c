struct device *hwmon_device_register(struct device *dev)\r\n{\r\nstruct device *hwdev;\r\nint id;\r\nid = ida_simple_get(&hwmon_ida, 0, 0, GFP_KERNEL);\r\nif (id < 0)\r\nreturn ERR_PTR(id);\r\nhwdev = device_create(hwmon_class, dev, MKDEV(0, 0), NULL,\r\nHWMON_ID_FORMAT, id);\r\nif (IS_ERR(hwdev))\r\nida_simple_remove(&hwmon_ida, id);\r\nreturn hwdev;\r\n}\r\nvoid hwmon_device_unregister(struct device *dev)\r\n{\r\nint id;\r\nif (likely(sscanf(dev_name(dev), HWMON_ID_FORMAT, &id) == 1)) {\r\ndevice_unregister(dev);\r\nida_simple_remove(&hwmon_ida, id);\r\n} else\r\ndev_dbg(dev->parent,\r\n"hwmon_device_unregister() failed: bad class ID!\n");\r\n}\r\nstatic void __init hwmon_pci_quirks(void)\r\n{\r\n#if defined CONFIG_X86 && defined CONFIG_PCI\r\nstruct pci_dev *sb;\r\nu16 base;\r\nu8 enable;\r\nsb = pci_get_device(PCI_VENDOR_ID_ATI, 0x436c, NULL);\r\nif (sb) {\r\nif (sb->subsystem_vendor == 0x1462 &&\r\nsb->subsystem_device == 0x0031) {\r\npci_read_config_byte(sb, 0x48, &enable);\r\npci_read_config_word(sb, 0x64, &base);\r\nif (base == 0 && !(enable & BIT(2))) {\r\ndev_info(&sb->dev,\r\n"Opening wide generic port at 0x295\n");\r\npci_write_config_word(sb, 0x64, 0x295);\r\npci_write_config_byte(sb, 0x48,\r\nenable | BIT(2));\r\n}\r\n}\r\npci_dev_put(sb);\r\n}\r\n#endif\r\n}\r\nstatic int __init hwmon_init(void)\r\n{\r\nhwmon_pci_quirks();\r\nhwmon_class = class_create(THIS_MODULE, "hwmon");\r\nif (IS_ERR(hwmon_class)) {\r\npr_err("couldn't create sysfs class\n");\r\nreturn PTR_ERR(hwmon_class);\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit hwmon_exit(void)\r\n{\r\nclass_destroy(hwmon_class);\r\n}

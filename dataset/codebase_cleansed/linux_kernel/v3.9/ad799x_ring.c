static irqreturn_t ad799x_trigger_handler(int irq, void *p)\r\n{\r\nstruct iio_poll_func *pf = p;\r\nstruct iio_dev *indio_dev = pf->indio_dev;\r\nstruct ad799x_state *st = iio_priv(indio_dev);\r\ns64 time_ns;\r\n__u8 *rxbuf;\r\nint b_sent;\r\nu8 cmd;\r\nrxbuf = kmalloc(indio_dev->scan_bytes, GFP_KERNEL);\r\nif (rxbuf == NULL)\r\ngoto out;\r\nswitch (st->id) {\r\ncase ad7991:\r\ncase ad7995:\r\ncase ad7999:\r\ncmd = st->config |\r\n(*indio_dev->active_scan_mask << AD799X_CHANNEL_SHIFT);\r\nbreak;\r\ncase ad7992:\r\ncase ad7993:\r\ncase ad7994:\r\ncmd = (*indio_dev->active_scan_mask << AD799X_CHANNEL_SHIFT) |\r\nAD7998_CONV_RES_REG;\r\nbreak;\r\ncase ad7997:\r\ncase ad7998:\r\ncmd = AD7997_8_READ_SEQUENCE | AD7998_CONV_RES_REG;\r\nbreak;\r\ndefault:\r\ncmd = 0;\r\n}\r\nb_sent = i2c_smbus_read_i2c_block_data(st->client,\r\ncmd, bitmap_weight(indio_dev->active_scan_mask,\r\nindio_dev->masklength) * 2, rxbuf);\r\nif (b_sent < 0)\r\ngoto done;\r\ntime_ns = iio_get_time_ns();\r\nif (indio_dev->scan_timestamp)\r\nmemcpy(rxbuf + indio_dev->scan_bytes - sizeof(s64),\r\n&time_ns, sizeof(time_ns));\r\niio_push_to_buffers(indio_dev, rxbuf);\r\ndone:\r\nkfree(rxbuf);\r\nout:\r\niio_trigger_notify_done(indio_dev->trig);\r\nreturn IRQ_HANDLED;\r\n}\r\nint ad799x_register_ring_funcs_and_init(struct iio_dev *indio_dev)\r\n{\r\nreturn iio_triggered_buffer_setup(indio_dev, NULL,\r\n&ad799x_trigger_handler, NULL);\r\n}\r\nvoid ad799x_ring_cleanup(struct iio_dev *indio_dev)\r\n{\r\niio_triggered_buffer_cleanup(indio_dev);\r\n}

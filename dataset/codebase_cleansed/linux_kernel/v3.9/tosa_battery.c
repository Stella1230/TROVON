static unsigned long tosa_read_bat(struct tosa_bat *bat)\r\n{\r\nunsigned long value = 0;\r\nif (bat->gpio_bat < 0 || bat->adc_bat < 0)\r\nreturn 0;\r\nmutex_lock(&bat_lock);\r\ngpio_set_value(bat->gpio_bat, 1);\r\nmsleep(5);\r\nvalue = wm97xx_read_aux_adc(dev_get_drvdata(bat->psy.dev->parent),\r\nbat->adc_bat);\r\ngpio_set_value(bat->gpio_bat, 0);\r\nmutex_unlock(&bat_lock);\r\nvalue = value * 1000000 / bat->adc_bat_divider;\r\nreturn value;\r\n}\r\nstatic unsigned long tosa_read_temp(struct tosa_bat *bat)\r\n{\r\nunsigned long value = 0;\r\nif (bat->gpio_temp < 0 || bat->adc_temp < 0)\r\nreturn 0;\r\nmutex_lock(&bat_lock);\r\ngpio_set_value(bat->gpio_temp, 1);\r\nmsleep(5);\r\nvalue = wm97xx_read_aux_adc(dev_get_drvdata(bat->psy.dev->parent),\r\nbat->adc_temp);\r\ngpio_set_value(bat->gpio_temp, 0);\r\nmutex_unlock(&bat_lock);\r\nvalue = value * 10000 / bat->adc_temp_divider;\r\nreturn value;\r\n}\r\nstatic int tosa_bat_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nint ret = 0;\r\nstruct tosa_bat *bat = container_of(psy, struct tosa_bat, psy);\r\nif (bat->is_present && !bat->is_present(bat)\r\n&& psp != POWER_SUPPLY_PROP_PRESENT) {\r\nreturn -ENODEV;\r\n}\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nval->intval = bat->status;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TECHNOLOGY:\r\nval->intval = bat->technology;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nval->intval = tosa_read_bat(bat);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_MAX:\r\nif (bat->full_chrg == -1)\r\nval->intval = bat->bat_max;\r\nelse\r\nval->intval = bat->full_chrg;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_MAX_DESIGN:\r\nval->intval = bat->bat_max;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_MIN_DESIGN:\r\nval->intval = bat->bat_min;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TEMP:\r\nval->intval = tosa_read_temp(bat);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_PRESENT:\r\nval->intval = bat->is_present ? bat->is_present(bat) : 1;\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic bool tosa_jacket_bat_is_present(struct tosa_bat *bat)\r\n{\r\nreturn gpio_get_value(TOSA_GPIO_JACKET_DETECT) == 0;\r\n}\r\nstatic void tosa_bat_external_power_changed(struct power_supply *psy)\r\n{\r\nschedule_work(&bat_work);\r\n}\r\nstatic irqreturn_t tosa_bat_gpio_isr(int irq, void *data)\r\n{\r\npr_info("tosa_bat_gpio irq: %d\n", gpio_get_value(irq_to_gpio(irq)));\r\nschedule_work(&bat_work);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void tosa_bat_update(struct tosa_bat *bat)\r\n{\r\nint old;\r\nstruct power_supply *psy = &bat->psy;\r\nmutex_lock(&bat->work_lock);\r\nold = bat->status;\r\nif (bat->is_present && !bat->is_present(bat)) {\r\nprintk(KERN_NOTICE "%s not present\n", psy->name);\r\nbat->status = POWER_SUPPLY_STATUS_UNKNOWN;\r\nbat->full_chrg = -1;\r\n} else if (power_supply_am_i_supplied(psy)) {\r\nif (bat->status == POWER_SUPPLY_STATUS_DISCHARGING) {\r\ngpio_set_value(bat->gpio_charge_off, 0);\r\nmdelay(15);\r\n}\r\nif (gpio_get_value(bat->gpio_full)) {\r\nif (old == POWER_SUPPLY_STATUS_CHARGING ||\r\nbat->full_chrg == -1)\r\nbat->full_chrg = tosa_read_bat(bat);\r\ngpio_set_value(bat->gpio_charge_off, 1);\r\nbat->status = POWER_SUPPLY_STATUS_FULL;\r\n} else {\r\ngpio_set_value(bat->gpio_charge_off, 0);\r\nbat->status = POWER_SUPPLY_STATUS_CHARGING;\r\n}\r\n} else {\r\ngpio_set_value(bat->gpio_charge_off, 1);\r\nbat->status = POWER_SUPPLY_STATUS_DISCHARGING;\r\n}\r\nif (old != bat->status)\r\npower_supply_changed(psy);\r\nmutex_unlock(&bat->work_lock);\r\n}\r\nstatic void tosa_bat_work(struct work_struct *work)\r\n{\r\ntosa_bat_update(&tosa_bat_main);\r\ntosa_bat_update(&tosa_bat_jacket);\r\n}\r\nstatic int tosa_bat_suspend(struct platform_device *dev, pm_message_t state)\r\n{\r\nflush_work(&bat_work);\r\nreturn 0;\r\n}\r\nstatic int tosa_bat_resume(struct platform_device *dev)\r\n{\r\nschedule_work(&bat_work);\r\nreturn 0;\r\n}\r\nstatic int tosa_bat_probe(struct platform_device *dev)\r\n{\r\nint ret;\r\nif (!machine_is_tosa())\r\nreturn -ENODEV;\r\nret = gpio_request_array(tosa_bat_gpios, ARRAY_SIZE(tosa_bat_gpios));\r\nif (ret)\r\nreturn ret;\r\nmutex_init(&tosa_bat_main.work_lock);\r\nmutex_init(&tosa_bat_jacket.work_lock);\r\nINIT_WORK(&bat_work, tosa_bat_work);\r\nret = power_supply_register(&dev->dev, &tosa_bat_main.psy);\r\nif (ret)\r\ngoto err_psy_reg_main;\r\nret = power_supply_register(&dev->dev, &tosa_bat_jacket.psy);\r\nif (ret)\r\ngoto err_psy_reg_jacket;\r\nret = power_supply_register(&dev->dev, &tosa_bat_bu.psy);\r\nif (ret)\r\ngoto err_psy_reg_bu;\r\nret = request_irq(gpio_to_irq(TOSA_GPIO_BAT0_CRG),\r\ntosa_bat_gpio_isr,\r\nIRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING,\r\n"main full", &tosa_bat_main);\r\nif (ret)\r\ngoto err_req_main;\r\nret = request_irq(gpio_to_irq(TOSA_GPIO_BAT1_CRG),\r\ntosa_bat_gpio_isr,\r\nIRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING,\r\n"jacket full", &tosa_bat_jacket);\r\nif (ret)\r\ngoto err_req_jacket;\r\nret = request_irq(gpio_to_irq(TOSA_GPIO_JACKET_DETECT),\r\ntosa_bat_gpio_isr,\r\nIRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING,\r\n"jacket detect", &tosa_bat_jacket);\r\nif (!ret) {\r\nschedule_work(&bat_work);\r\nreturn 0;\r\n}\r\nfree_irq(gpio_to_irq(TOSA_GPIO_BAT1_CRG), &tosa_bat_jacket);\r\nerr_req_jacket:\r\nfree_irq(gpio_to_irq(TOSA_GPIO_BAT0_CRG), &tosa_bat_main);\r\nerr_req_main:\r\npower_supply_unregister(&tosa_bat_bu.psy);\r\nerr_psy_reg_bu:\r\npower_supply_unregister(&tosa_bat_jacket.psy);\r\nerr_psy_reg_jacket:\r\npower_supply_unregister(&tosa_bat_main.psy);\r\nerr_psy_reg_main:\r\ncancel_work_sync(&bat_work);\r\ngpio_free_array(tosa_bat_gpios, ARRAY_SIZE(tosa_bat_gpios));\r\nreturn ret;\r\n}\r\nstatic int tosa_bat_remove(struct platform_device *dev)\r\n{\r\nfree_irq(gpio_to_irq(TOSA_GPIO_JACKET_DETECT), &tosa_bat_jacket);\r\nfree_irq(gpio_to_irq(TOSA_GPIO_BAT1_CRG), &tosa_bat_jacket);\r\nfree_irq(gpio_to_irq(TOSA_GPIO_BAT0_CRG), &tosa_bat_main);\r\npower_supply_unregister(&tosa_bat_bu.psy);\r\npower_supply_unregister(&tosa_bat_jacket.psy);\r\npower_supply_unregister(&tosa_bat_main.psy);\r\ncancel_work_sync(&bat_work);\r\ngpio_free_array(tosa_bat_gpios, ARRAY_SIZE(tosa_bat_gpios));\r\nreturn 0;\r\n}

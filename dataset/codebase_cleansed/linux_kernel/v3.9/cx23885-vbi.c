int cx23885_vbi_fmt(struct file *file, void *priv,\r\nstruct v4l2_format *f)\r\n{\r\nstruct cx23885_fh *fh = priv;\r\nstruct cx23885_dev *dev = fh->dev;\r\nif (dev->tvnorm & V4L2_STD_525_60) {\r\nf->fmt.vbi.samples_per_line = VBI_LINE_LENGTH;\r\nf->fmt.vbi.sampling_rate = 27000000;\r\nf->fmt.vbi.sample_format = V4L2_PIX_FMT_GREY;\r\nf->fmt.vbi.offset = 0;\r\nf->fmt.vbi.flags = 0;\r\nf->fmt.vbi.start[0] = 10;\r\nf->fmt.vbi.count[0] = 17;\r\nf->fmt.vbi.start[1] = 263 + 10 + 1;\r\nf->fmt.vbi.count[1] = 17;\r\n} else if (dev->tvnorm & V4L2_STD_625_50) {\r\nf->fmt.vbi.sampling_rate = 35468950;\r\nf->fmt.vbi.start[0] = 7 - 1;\r\nf->fmt.vbi.start[1] = 319 - 1;\r\n}\r\nreturn 0;\r\n}\r\nint cx23885_vbi_irq(struct cx23885_dev *dev, u32 status)\r\n{\r\nu32 count;\r\nint handled = 0;\r\nif (status & VID_BC_MSK_VBI_RISCI1) {\r\ndprintk(1, "%s() VID_BC_MSK_VBI_RISCI1\n", __func__);\r\nspin_lock(&dev->slock);\r\ncount = cx_read(VID_A_GPCNT);\r\ncx23885_video_wakeup(dev, &dev->vbiq, count);\r\nspin_unlock(&dev->slock);\r\nhandled++;\r\n}\r\nif (status & VID_BC_MSK_VBI_RISCI2) {\r\ndprintk(1, "%s() VID_BC_MSK_VBI_RISCI2\n", __func__);\r\ndprintk(2, "stopper vbi\n");\r\nspin_lock(&dev->slock);\r\ncx23885_restart_vbi_queue(dev, &dev->vbiq);\r\nspin_unlock(&dev->slock);\r\nhandled++;\r\n}\r\nreturn handled;\r\n}\r\nstatic int cx23885_start_vbi_dma(struct cx23885_dev *dev,\r\nstruct cx23885_dmaqueue *q,\r\nstruct cx23885_buffer *buf)\r\n{\r\ndprintk(1, "%s()\n", __func__);\r\ncx23885_sram_channel_setup(dev, &dev->sram_channels[SRAM_CH02],\r\nbuf->vb.width, buf->risc.dma);\r\ncx_write(VID_A_GPCNT_CTL, 3);\r\ncx_write(VID_A_VBI_CTRL, 3);\r\ncx_write(VBI_A_GPCNT_CTL, 3);\r\nq->count = 1;\r\ncx23885_irq_add_enable(dev, 0x01);\r\ncx_set(VID_A_INT_MSK, 0x000022);\r\ncx_set(DEV_CNTRL2, (1<<5));\r\ncx_set(VID_A_DMA_CTL, 0x22);\r\nreturn 0;\r\n}\r\nint cx23885_restart_vbi_queue(struct cx23885_dev *dev,\r\nstruct cx23885_dmaqueue *q)\r\n{\r\nstruct cx23885_buffer *buf;\r\nstruct list_head *item;\r\nif (list_empty(&q->active))\r\nreturn 0;\r\nbuf = list_entry(q->active.next, struct cx23885_buffer, vb.queue);\r\ndprintk(2, "restart_queue [%p/%d]: restart dma\n",\r\nbuf, buf->vb.i);\r\ncx23885_start_vbi_dma(dev, q, buf);\r\nlist_for_each(item, &q->active) {\r\nbuf = list_entry(item, struct cx23885_buffer, vb.queue);\r\nbuf->count = q->count++;\r\n}\r\nmod_timer(&q->timeout, jiffies + (BUFFER_TIMEOUT / 30));\r\nreturn 0;\r\n}\r\nvoid cx23885_vbi_timeout(unsigned long data)\r\n{\r\nstruct cx23885_dev *dev = (struct cx23885_dev *)data;\r\nstruct cx23885_dmaqueue *q = &dev->vbiq;\r\nstruct cx23885_buffer *buf;\r\nunsigned long flags;\r\ncx_clear(VID_A_DMA_CTL, 0x22);\r\nspin_lock_irqsave(&dev->slock, flags);\r\nwhile (!list_empty(&q->active)) {\r\nbuf = list_entry(q->active.next, struct cx23885_buffer,\r\nvb.queue);\r\nlist_del(&buf->vb.queue);\r\nbuf->vb.state = VIDEOBUF_ERROR;\r\nwake_up(&buf->vb.done);\r\nprintk("%s/0: [%p/%d] timeout - dma=0x%08lx\n", dev->name,\r\nbuf, buf->vb.i, (unsigned long)buf->risc.dma);\r\n}\r\ncx23885_restart_vbi_queue(dev, q);\r\nspin_unlock_irqrestore(&dev->slock, flags);\r\n}\r\nstatic int\r\nvbi_setup(struct videobuf_queue *q, unsigned int *count, unsigned int *size)\r\n{\r\n*size = VBI_LINE_COUNT * VBI_LINE_LENGTH * 2;\r\nif (0 == *count)\r\n*count = vbibufs;\r\nif (*count < 2)\r\n*count = 2;\r\nif (*count > 32)\r\n*count = 32;\r\nreturn 0;\r\n}\r\nstatic int\r\nvbi_prepare(struct videobuf_queue *q, struct videobuf_buffer *vb,\r\nenum v4l2_field field)\r\n{\r\nstruct cx23885_fh *fh = q->priv_data;\r\nstruct cx23885_dev *dev = fh->dev;\r\nstruct cx23885_buffer *buf = container_of(vb,\r\nstruct cx23885_buffer, vb);\r\nstruct videobuf_dmabuf *dma = videobuf_to_dma(&buf->vb);\r\nunsigned int size;\r\nint rc;\r\nsize = VBI_LINE_COUNT * VBI_LINE_LENGTH * 2;\r\nif (0 != buf->vb.baddr && buf->vb.bsize < size)\r\nreturn -EINVAL;\r\nif (VIDEOBUF_NEEDS_INIT == buf->vb.state) {\r\nbuf->vb.width = VBI_LINE_LENGTH;\r\nbuf->vb.height = VBI_LINE_COUNT;\r\nbuf->vb.size = size;\r\nbuf->vb.field = V4L2_FIELD_SEQ_TB;\r\nrc = videobuf_iolock(q, &buf->vb, NULL);\r\nif (0 != rc)\r\ngoto fail;\r\ncx23885_risc_vbibuffer(dev->pci, &buf->risc,\r\ndma->sglist,\r\n0, buf->vb.width * buf->vb.height,\r\nbuf->vb.width, 0,\r\nbuf->vb.height);\r\n}\r\nbuf->vb.state = VIDEOBUF_PREPARED;\r\nreturn 0;\r\nfail:\r\ncx23885_free_buffer(q, buf);\r\nreturn rc;\r\n}\r\nstatic void\r\nvbi_queue(struct videobuf_queue *vq, struct videobuf_buffer *vb)\r\n{\r\nstruct cx23885_buffer *buf =\r\ncontainer_of(vb, struct cx23885_buffer, vb);\r\nstruct cx23885_buffer *prev;\r\nstruct cx23885_fh *fh = vq->priv_data;\r\nstruct cx23885_dev *dev = fh->dev;\r\nstruct cx23885_dmaqueue *q = &dev->vbiq;\r\nbuf->risc.jmp[0] = cpu_to_le32(RISC_JUMP | RISC_IRQ1 | RISC_CNT_INC);\r\nbuf->risc.jmp[1] = cpu_to_le32(q->stopper.dma);\r\nbuf->risc.jmp[2] = cpu_to_le32(0);\r\nif (list_empty(&q->active)) {\r\nlist_add_tail(&buf->vb.queue, &q->active);\r\ncx23885_start_vbi_dma(dev, q, buf);\r\nbuf->vb.state = VIDEOBUF_ACTIVE;\r\nbuf->count = q->count++;\r\nmod_timer(&q->timeout, jiffies + (BUFFER_TIMEOUT / 30));\r\ndprintk(2, "[%p/%d] vbi_queue - first active\n",\r\nbuf, buf->vb.i);\r\n} else {\r\nprev = list_entry(q->active.prev, struct cx23885_buffer,\r\nvb.queue);\r\nlist_add_tail(&buf->vb.queue, &q->active);\r\nbuf->vb.state = VIDEOBUF_ACTIVE;\r\nbuf->count = q->count++;\r\nprev->risc.jmp[1] = cpu_to_le32(buf->risc.dma);\r\nprev->risc.jmp[2] = cpu_to_le32(0);\r\ndprintk(2, "[%p/%d] buffer_queue - append to active\n",\r\nbuf, buf->vb.i);\r\n}\r\n}\r\nstatic void vbi_release(struct videobuf_queue *q, struct videobuf_buffer *vb)\r\n{\r\nstruct cx23885_buffer *buf =\r\ncontainer_of(vb, struct cx23885_buffer, vb);\r\ncx23885_free_buffer(q, buf);\r\n}

static void gpio_mouse_scan(struct input_polled_dev *dev)\r\n{\r\nstruct gpio_mouse_platform_data *gpio = dev->private;\r\nstruct input_dev *input = dev->input;\r\nint x, y;\r\nif (gpio->bleft >= 0)\r\ninput_report_key(input, BTN_LEFT,\r\ngpio_get_value(gpio->bleft) ^ gpio->polarity);\r\nif (gpio->bmiddle >= 0)\r\ninput_report_key(input, BTN_MIDDLE,\r\ngpio_get_value(gpio->bmiddle) ^ gpio->polarity);\r\nif (gpio->bright >= 0)\r\ninput_report_key(input, BTN_RIGHT,\r\ngpio_get_value(gpio->bright) ^ gpio->polarity);\r\nx = (gpio_get_value(gpio->right) ^ gpio->polarity)\r\n- (gpio_get_value(gpio->left) ^ gpio->polarity);\r\ny = (gpio_get_value(gpio->down) ^ gpio->polarity)\r\n- (gpio_get_value(gpio->up) ^ gpio->polarity);\r\ninput_report_rel(input, REL_X, x);\r\ninput_report_rel(input, REL_Y, y);\r\ninput_sync(input);\r\n}\r\nstatic int gpio_mouse_probe(struct platform_device *pdev)\r\n{\r\nstruct gpio_mouse_platform_data *pdata = pdev->dev.platform_data;\r\nstruct input_polled_dev *input_poll;\r\nstruct input_dev *input;\r\nint pin, i;\r\nint error;\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "no platform data\n");\r\nerror = -ENXIO;\r\ngoto out;\r\n}\r\nif (pdata->scan_ms < 0) {\r\ndev_err(&pdev->dev, "invalid scan time\n");\r\nerror = -EINVAL;\r\ngoto out;\r\n}\r\nfor (i = 0; i < GPIO_MOUSE_PIN_MAX; i++) {\r\npin = pdata->pins[i];\r\nif (pin < 0) {\r\nif (i <= GPIO_MOUSE_PIN_RIGHT) {\r\ndev_err(&pdev->dev,\r\n"missing GPIO for directions\n");\r\nerror = -EINVAL;\r\ngoto out_free_gpios;\r\n}\r\nif (i == GPIO_MOUSE_PIN_BLEFT)\r\ndev_dbg(&pdev->dev, "no left button defined\n");\r\n} else {\r\nerror = gpio_request(pin, "gpio_mouse");\r\nif (error) {\r\ndev_err(&pdev->dev, "fail %d pin (%d idx)\n",\r\npin, i);\r\ngoto out_free_gpios;\r\n}\r\ngpio_direction_input(pin);\r\n}\r\n}\r\ninput_poll = input_allocate_polled_device();\r\nif (!input_poll) {\r\ndev_err(&pdev->dev, "not enough memory for input device\n");\r\nerror = -ENOMEM;\r\ngoto out_free_gpios;\r\n}\r\nplatform_set_drvdata(pdev, input_poll);\r\ninput_poll->private = pdata;\r\ninput_poll->poll = gpio_mouse_scan;\r\ninput_poll->poll_interval = pdata->scan_ms;\r\ninput = input_poll->input;\r\ninput->name = pdev->name;\r\ninput->id.bustype = BUS_HOST;\r\ninput->dev.parent = &pdev->dev;\r\ninput_set_capability(input, EV_REL, REL_X);\r\ninput_set_capability(input, EV_REL, REL_Y);\r\nif (pdata->bleft >= 0)\r\ninput_set_capability(input, EV_KEY, BTN_LEFT);\r\nif (pdata->bmiddle >= 0)\r\ninput_set_capability(input, EV_KEY, BTN_MIDDLE);\r\nif (pdata->bright >= 0)\r\ninput_set_capability(input, EV_KEY, BTN_RIGHT);\r\nerror = input_register_polled_device(input_poll);\r\nif (error) {\r\ndev_err(&pdev->dev, "could not register input device\n");\r\ngoto out_free_polldev;\r\n}\r\ndev_dbg(&pdev->dev, "%d ms scan time, buttons: %s%s%s\n",\r\npdata->scan_ms,\r\npdata->bleft < 0 ? "" : "left ",\r\npdata->bmiddle < 0 ? "" : "middle ",\r\npdata->bright < 0 ? "" : "right");\r\nreturn 0;\r\nout_free_polldev:\r\ninput_free_polled_device(input_poll);\r\nplatform_set_drvdata(pdev, NULL);\r\nout_free_gpios:\r\nwhile (--i >= 0) {\r\npin = pdata->pins[i];\r\nif (pin)\r\ngpio_free(pin);\r\n}\r\nout:\r\nreturn error;\r\n}\r\nstatic int gpio_mouse_remove(struct platform_device *pdev)\r\n{\r\nstruct input_polled_dev *input = platform_get_drvdata(pdev);\r\nstruct gpio_mouse_platform_data *pdata = input->private;\r\nint pin, i;\r\ninput_unregister_polled_device(input);\r\ninput_free_polled_device(input);\r\nfor (i = 0; i < GPIO_MOUSE_PIN_MAX; i++) {\r\npin = pdata->pins[i];\r\nif (pin >= 0)\r\ngpio_free(pin);\r\n}\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn 0;\r\n}

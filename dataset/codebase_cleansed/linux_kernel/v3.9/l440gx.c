static void l440gx_set_vpp(struct map_info *map, int vpp)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&l440gx_vpp_lock, flags);\r\nif (vpp) {\r\nif (++l440gx_vpp_refcnt == 1)\r\noutl(inl(VPP_PORT) | 1, VPP_PORT);\r\n} else {\r\nif (--l440gx_vpp_refcnt == 0)\r\noutl(inl(VPP_PORT) & ~1, VPP_PORT);\r\n}\r\nspin_unlock_irqrestore(&l440gx_vpp_lock, flags);\r\n}\r\nstatic int __init init_l440gx(void)\r\n{\r\nstruct pci_dev *dev, *pm_dev;\r\nstruct resource *pm_iobase;\r\n__u16 word;\r\ndev = pci_get_device(PCI_VENDOR_ID_INTEL,\r\nPCI_DEVICE_ID_INTEL_82371AB_0, NULL);\r\npm_dev = pci_get_device(PCI_VENDOR_ID_INTEL,\r\nPCI_DEVICE_ID_INTEL_82371AB_3, NULL);\r\npci_dev_put(dev);\r\nif (!dev || !pm_dev) {\r\nprintk(KERN_NOTICE "L440GX flash mapping: failed to find PIIX4 ISA bridge, cannot continue\n");\r\npci_dev_put(pm_dev);\r\nreturn -ENODEV;\r\n}\r\nl440gx_map.virt = ioremap_nocache(WINDOW_ADDR, WINDOW_SIZE);\r\nif (!l440gx_map.virt) {\r\nprintk(KERN_WARNING "Failed to ioremap L440GX flash region\n");\r\npci_dev_put(pm_dev);\r\nreturn -ENOMEM;\r\n}\r\nsimple_map_init(&l440gx_map);\r\nprintk(KERN_NOTICE "window_addr = 0x%08lx\n", (unsigned long)l440gx_map.virt);\r\npm_iobase = &pm_dev->resource[PIIXE_IOBASE_RESOURCE];\r\nif (!(pm_iobase->flags & IORESOURCE_IO)) {\r\npm_iobase->name = "pm iobase";\r\npm_iobase->start = 0;\r\npm_iobase->end = 63;\r\npm_iobase->flags = IORESOURCE_IO;\r\npci_read_config_dword(pm_dev, 0x40, &iobase);\r\niobase &= ~1;\r\npm_iobase->start += iobase & ~1;\r\npm_iobase->end += iobase & ~1;\r\npci_dev_put(pm_dev);\r\nif (pci_assign_resource(pm_dev, PIIXE_IOBASE_RESOURCE) != 0) {\r\npci_dev_put(dev);\r\npci_dev_put(pm_dev);\r\nprintk(KERN_WARNING "Could not allocate pm iobase resource\n");\r\niounmap(l440gx_map.virt);\r\nreturn -ENXIO;\r\n}\r\n}\r\niobase = pm_iobase->start;\r\npci_write_config_dword(pm_dev, 0x40, iobase | 1);\r\npci_read_config_word(dev, 0x4e, &word);\r\nword |= 0x4;\r\npci_write_config_word(dev, 0x4e, word);\r\nl440gx_set_vpp(&l440gx_map, 1);\r\noutb(inb(TRIBUF_PORT) & ~1, TRIBUF_PORT);\r\nprintk(KERN_NOTICE "Enabled WE line to L440GX BIOS flash chip.\n");\r\nmymtd = do_map_probe("jedec_probe", &l440gx_map);\r\nif (!mymtd) {\r\nprintk(KERN_NOTICE "JEDEC probe on BIOS chip failed. Using ROM\n");\r\nmymtd = do_map_probe("map_rom", &l440gx_map);\r\n}\r\nif (mymtd) {\r\nmymtd->owner = THIS_MODULE;\r\nmtd_device_register(mymtd, NULL, 0);\r\nreturn 0;\r\n}\r\niounmap(l440gx_map.virt);\r\nreturn -ENXIO;\r\n}\r\nstatic void __exit cleanup_l440gx(void)\r\n{\r\nmtd_device_unregister(mymtd);\r\nmap_destroy(mymtd);\r\niounmap(l440gx_map.virt);\r\n}

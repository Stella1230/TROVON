static int snd_mpu401_create(int dev, struct snd_card **rcard)\r\n{\r\nstruct snd_card *card;\r\nint err;\r\nif (!uart_enter[dev])\r\nsnd_printk(KERN_ERR "the uart_enter option is obsolete; remove it\n");\r\n*rcard = NULL;\r\nerr = snd_card_create(index[dev], id[dev], THIS_MODULE, 0, &card);\r\nif (err < 0)\r\nreturn err;\r\nstrcpy(card->driver, "MPU-401 UART");\r\nstrcpy(card->shortname, card->driver);\r\nsprintf(card->longname, "%s at %#lx, ", card->shortname, port[dev]);\r\nif (irq[dev] >= 0) {\r\nsprintf(card->longname + strlen(card->longname), "irq %d", irq[dev]);\r\n} else {\r\nstrcat(card->longname, "polled");\r\n}\r\nerr = snd_mpu401_uart_new(card, 0, MPU401_HW_MPU401, port[dev], 0,\r\nirq[dev], NULL);\r\nif (err < 0) {\r\nprintk(KERN_ERR "MPU401 not detected at 0x%lx\n", port[dev]);\r\ngoto _err;\r\n}\r\n*rcard = card;\r\nreturn 0;\r\n_err:\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\nstatic int snd_mpu401_probe(struct platform_device *devptr)\r\n{\r\nint dev = devptr->id;\r\nint err;\r\nstruct snd_card *card;\r\nif (port[dev] == SNDRV_AUTO_PORT) {\r\nsnd_printk(KERN_ERR "specify port\n");\r\nreturn -EINVAL;\r\n}\r\nif (irq[dev] == SNDRV_AUTO_IRQ) {\r\nsnd_printk(KERN_ERR "specify or disable IRQ\n");\r\nreturn -EINVAL;\r\n}\r\nerr = snd_mpu401_create(dev, &card);\r\nif (err < 0)\r\nreturn err;\r\nsnd_card_set_dev(card, &devptr->dev);\r\nif ((err = snd_card_register(card)) < 0) {\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\nplatform_set_drvdata(devptr, card);\r\nreturn 0;\r\n}\r\nstatic int snd_mpu401_remove(struct platform_device *devptr)\r\n{\r\nsnd_card_free(platform_get_drvdata(devptr));\r\nplatform_set_drvdata(devptr, NULL);\r\nreturn 0;\r\n}\r\nstatic int snd_mpu401_pnp(int dev, struct pnp_dev *device,\r\nconst struct pnp_device_id *id)\r\n{\r\nif (!pnp_port_valid(device, 0) ||\r\npnp_port_flags(device, 0) & IORESOURCE_DISABLED) {\r\nsnd_printk(KERN_ERR "no PnP port\n");\r\nreturn -ENODEV;\r\n}\r\nif (pnp_port_len(device, 0) < IO_EXTENT) {\r\nsnd_printk(KERN_ERR "PnP port length is %llu, expected %d\n",\r\n(unsigned long long)pnp_port_len(device, 0),\r\nIO_EXTENT);\r\nreturn -ENODEV;\r\n}\r\nport[dev] = pnp_port_start(device, 0);\r\nif (!pnp_irq_valid(device, 0) ||\r\npnp_irq_flags(device, 0) & IORESOURCE_DISABLED) {\r\nsnd_printk(KERN_WARNING "no PnP irq, using polling\n");\r\nirq[dev] = -1;\r\n} else {\r\nirq[dev] = pnp_irq(device, 0);\r\n}\r\nreturn 0;\r\n}\r\nstatic int snd_mpu401_pnp_probe(struct pnp_dev *pnp_dev,\r\nconst struct pnp_device_id *id)\r\n{\r\nstatic int dev;\r\nstruct snd_card *card;\r\nint err;\r\nfor ( ; dev < SNDRV_CARDS; ++dev) {\r\nif (!enable[dev] || !pnp[dev])\r\ncontinue;\r\nerr = snd_mpu401_pnp(dev, pnp_dev, id);\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_mpu401_create(dev, &card);\r\nif (err < 0)\r\nreturn err;\r\nif ((err = snd_card_register(card)) < 0) {\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\nsnd_card_set_dev(card, &pnp_dev->dev);\r\npnp_set_drvdata(pnp_dev, card);\r\nsnd_mpu401_devices++;\r\n++dev;\r\nreturn 0;\r\n}\r\nreturn -ENODEV;\r\n}\r\nstatic void snd_mpu401_pnp_remove(struct pnp_dev *dev)\r\n{\r\nstruct snd_card *card = (struct snd_card *) pnp_get_drvdata(dev);\r\nsnd_card_disconnect(card);\r\nsnd_card_free_when_closed(card);\r\n}\r\nstatic void snd_mpu401_unregister_all(void)\r\n{\r\nint i;\r\nif (pnp_registered)\r\npnp_unregister_driver(&snd_mpu401_pnp_driver);\r\nfor (i = 0; i < ARRAY_SIZE(platform_devices); ++i)\r\nplatform_device_unregister(platform_devices[i]);\r\nplatform_driver_unregister(&snd_mpu401_driver);\r\n}\r\nstatic int __init alsa_card_mpu401_init(void)\r\n{\r\nint i, err;\r\nif ((err = platform_driver_register(&snd_mpu401_driver)) < 0)\r\nreturn err;\r\nfor (i = 0; i < SNDRV_CARDS; i++) {\r\nstruct platform_device *device;\r\nif (! enable[i])\r\ncontinue;\r\n#ifdef CONFIG_PNP\r\nif (pnp[i])\r\ncontinue;\r\n#endif\r\ndevice = platform_device_register_simple(SND_MPU401_DRIVER,\r\ni, NULL, 0);\r\nif (IS_ERR(device))\r\ncontinue;\r\nif (!platform_get_drvdata(device)) {\r\nplatform_device_unregister(device);\r\ncontinue;\r\n}\r\nplatform_devices[i] = device;\r\nsnd_mpu401_devices++;\r\n}\r\nerr = pnp_register_driver(&snd_mpu401_pnp_driver);\r\nif (!err)\r\npnp_registered = 1;\r\nif (!snd_mpu401_devices) {\r\n#ifdef MODULE\r\nprintk(KERN_ERR "MPU-401 device not found or device busy\n");\r\n#endif\r\nsnd_mpu401_unregister_all();\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit alsa_card_mpu401_exit(void)\r\n{\r\nsnd_mpu401_unregister_all();\r\n}

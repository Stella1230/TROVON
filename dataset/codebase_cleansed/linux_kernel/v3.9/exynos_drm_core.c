static int exynos_drm_create_enc_conn(struct drm_device *dev,\r\nstruct exynos_drm_subdrv *subdrv)\r\n{\r\nstruct drm_encoder *encoder;\r\nstruct drm_connector *connector;\r\nint ret;\r\nDRM_DEBUG_DRIVER("%s\n", __FILE__);\r\nsubdrv->manager->dev = subdrv->dev;\r\nencoder = exynos_drm_encoder_create(dev, subdrv->manager,\r\n(1 << MAX_CRTC) - 1);\r\nif (!encoder) {\r\nDRM_ERROR("failed to create encoder\n");\r\nreturn -EFAULT;\r\n}\r\nconnector = exynos_drm_connector_create(dev, encoder);\r\nif (!connector) {\r\nDRM_ERROR("failed to create connector\n");\r\nret = -EFAULT;\r\ngoto err_destroy_encoder;\r\n}\r\nsubdrv->encoder = encoder;\r\nsubdrv->connector = connector;\r\nreturn 0;\r\nerr_destroy_encoder:\r\nencoder->funcs->destroy(encoder);\r\nreturn ret;\r\n}\r\nstatic void exynos_drm_destroy_enc_conn(struct exynos_drm_subdrv *subdrv)\r\n{\r\nif (subdrv->encoder) {\r\nstruct drm_encoder *encoder = subdrv->encoder;\r\nencoder->funcs->destroy(encoder);\r\nsubdrv->encoder = NULL;\r\n}\r\nif (subdrv->connector) {\r\nstruct drm_connector *connector = subdrv->connector;\r\nconnector->funcs->destroy(connector);\r\nsubdrv->connector = NULL;\r\n}\r\n}\r\nstatic int exynos_drm_subdrv_probe(struct drm_device *dev,\r\nstruct exynos_drm_subdrv *subdrv)\r\n{\r\nif (subdrv->probe) {\r\nint ret;\r\nsubdrv->drm_dev = dev;\r\nret = subdrv->probe(dev, subdrv->dev);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic void exynos_drm_subdrv_remove(struct drm_device *dev,\r\nstruct exynos_drm_subdrv *subdrv)\r\n{\r\nDRM_DEBUG_DRIVER("%s\n", __FILE__);\r\nif (subdrv->remove)\r\nsubdrv->remove(dev, subdrv->dev);\r\n}\r\nint exynos_drm_device_register(struct drm_device *dev)\r\n{\r\nstruct exynos_drm_subdrv *subdrv, *n;\r\nunsigned int fine_cnt = 0;\r\nint err;\r\nDRM_DEBUG_DRIVER("%s\n", __FILE__);\r\nif (!dev)\r\nreturn -EINVAL;\r\nlist_for_each_entry_safe(subdrv, n, &exynos_drm_subdrv_list, list) {\r\nerr = exynos_drm_subdrv_probe(dev, subdrv);\r\nif (err) {\r\nDRM_DEBUG("exynos drm subdrv probe failed.\n");\r\nlist_del(&subdrv->list);\r\ncontinue;\r\n}\r\nif (!subdrv->manager) {\r\nfine_cnt++;\r\ncontinue;\r\n}\r\nerr = exynos_drm_create_enc_conn(dev, subdrv);\r\nif (err) {\r\nDRM_DEBUG("failed to create encoder and connector.\n");\r\nexynos_drm_subdrv_remove(dev, subdrv);\r\nlist_del(&subdrv->list);\r\ncontinue;\r\n}\r\nfine_cnt++;\r\n}\r\nif (!fine_cnt)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nint exynos_drm_device_unregister(struct drm_device *dev)\r\n{\r\nstruct exynos_drm_subdrv *subdrv;\r\nDRM_DEBUG_DRIVER("%s\n", __FILE__);\r\nif (!dev) {\r\nWARN(1, "Unexpected drm device unregister!\n");\r\nreturn -EINVAL;\r\n}\r\nlist_for_each_entry(subdrv, &exynos_drm_subdrv_list, list) {\r\nexynos_drm_subdrv_remove(dev, subdrv);\r\nexynos_drm_destroy_enc_conn(subdrv);\r\n}\r\nreturn 0;\r\n}\r\nint exynos_drm_subdrv_register(struct exynos_drm_subdrv *subdrv)\r\n{\r\nDRM_DEBUG_DRIVER("%s\n", __FILE__);\r\nif (!subdrv)\r\nreturn -EINVAL;\r\nlist_add_tail(&subdrv->list, &exynos_drm_subdrv_list);\r\nreturn 0;\r\n}\r\nint exynos_drm_subdrv_unregister(struct exynos_drm_subdrv *subdrv)\r\n{\r\nDRM_DEBUG_DRIVER("%s\n", __FILE__);\r\nif (!subdrv)\r\nreturn -EINVAL;\r\nlist_del(&subdrv->list);\r\nreturn 0;\r\n}\r\nint exynos_drm_subdrv_open(struct drm_device *dev, struct drm_file *file)\r\n{\r\nstruct exynos_drm_subdrv *subdrv;\r\nint ret;\r\nlist_for_each_entry(subdrv, &exynos_drm_subdrv_list, list) {\r\nif (subdrv->open) {\r\nret = subdrv->open(dev, subdrv->dev, file);\r\nif (ret)\r\ngoto err;\r\n}\r\n}\r\nreturn 0;\r\nerr:\r\nlist_for_each_entry_reverse(subdrv, &subdrv->list, list) {\r\nif (subdrv->close)\r\nsubdrv->close(dev, subdrv->dev, file);\r\n}\r\nreturn ret;\r\n}\r\nvoid exynos_drm_subdrv_close(struct drm_device *dev, struct drm_file *file)\r\n{\r\nstruct exynos_drm_subdrv *subdrv;\r\nlist_for_each_entry(subdrv, &exynos_drm_subdrv_list, list) {\r\nif (subdrv->close)\r\nsubdrv->close(dev, subdrv->dev, file);\r\n}\r\n}

static int\r\nwext_freq_to_channel(int m, int e)\r\n{\r\nint mhz;\r\nmhz = m;\r\nwhile (e < 6) {\r\nmhz /= 10;\r\ne++;\r\n}\r\nwhile (e > 6) {\r\nmhz *= 10;\r\ne--;\r\n}\r\nif (mhz >= 5000) {\r\nreturn ((mhz - 5000) / 5);\r\n}\r\nif (mhz == 2482) {\r\nreturn 14;\r\n}\r\nif (mhz >= 2407) {\r\nreturn ((mhz - 2407) / 5);\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nchannel_to_mhz(int ch, int dot11a)\r\n{\r\nif (ch == 0) return 0;\r\nif (ch > 200) return 0;\r\nif (dot11a) {\r\nreturn (5000 + (5 * ch));\r\n}\r\nif (ch == 14) {\r\nreturn 2484;\r\n}\r\nif ((ch < 14) && (ch > 0)) {\r\nreturn (2407 + (5 * ch));\r\n}\r\nreturn 0;\r\n}\r\nvoid uf_sme_wext_ap_set_defaults(unifi_priv_t *priv)\r\n{\r\nmemcpy(priv->ap_config.ssid.ssid,"defaultssid",sizeof("defaultssid"));\r\npriv->ap_config.ssid.length = 8;\r\npriv->ap_config.channel = 6;\r\npriv->ap_config.if_index = 1;\r\npriv->ap_config.credentials.authType = 0;\r\npriv->ap_config.max_connections=8;\r\npriv->group_sec_config.apGroupkeyTimeout = 0;\r\npriv->group_sec_config.apStrictGtkRekey = 0;\r\npriv->group_sec_config.apGmkTimeout = 0;\r\npriv->group_sec_config.apResponseTimeout = 100;\r\npriv->group_sec_config.apRetransLimit = 3;\r\npriv->ap_mac_config.preamble = CSR_WIFI_SME_USE_LONG_PREAMBLE;\r\npriv->ap_mac_config.shortSlotTimeEnabled = FALSE;\r\npriv->ap_mac_config.ctsProtectionType=CSR_WIFI_SME_CTS_PROTECTION_AUTOMATIC;\r\npriv->ap_mac_config.wmmEnabled = TRUE;\r\npriv->ap_mac_config.wmmApParams[0].cwMin=4;\r\npriv->ap_mac_config.wmmApParams[0].cwMax=10;\r\npriv->ap_mac_config.wmmApParams[0].aifs=3;\r\npriv->ap_mac_config.wmmApParams[0].txopLimit=0;\r\npriv->ap_mac_config.wmmApParams[0].admissionControlMandatory=FALSE;\r\npriv->ap_mac_config.wmmApParams[1].cwMin=4;\r\npriv->ap_mac_config.wmmApParams[1].cwMax=10;\r\npriv->ap_mac_config.wmmApParams[1].aifs=7;\r\npriv->ap_mac_config.wmmApParams[1].txopLimit=0;\r\npriv->ap_mac_config.wmmApParams[1].admissionControlMandatory=FALSE;\r\npriv->ap_mac_config.wmmApParams[2].cwMin=3;\r\npriv->ap_mac_config.wmmApParams[2].cwMax=4;\r\npriv->ap_mac_config.wmmApParams[2].aifs=1;\r\npriv->ap_mac_config.wmmApParams[2].txopLimit=94;\r\npriv->ap_mac_config.wmmApParams[2].admissionControlMandatory=FALSE;\r\npriv->ap_mac_config.wmmApParams[3].cwMin=2;\r\npriv->ap_mac_config.wmmApParams[3].cwMax=3;\r\npriv->ap_mac_config.wmmApParams[3].aifs=1;\r\npriv->ap_mac_config.wmmApParams[3].txopLimit=47;\r\npriv->ap_mac_config.wmmApParams[3].admissionControlMandatory=FALSE;\r\npriv->ap_mac_config.wmmApBcParams[0].cwMin=4;\r\npriv->ap_mac_config.wmmApBcParams[0].cwMax=10;\r\npriv->ap_mac_config.wmmApBcParams[0].aifs=3;\r\npriv->ap_mac_config.wmmApBcParams[0].txopLimit=0;\r\npriv->ap_mac_config.wmmApBcParams[0].admissionControlMandatory=FALSE;\r\npriv->ap_mac_config.wmmApBcParams[1].cwMin=4;\r\npriv->ap_mac_config.wmmApBcParams[1].cwMax=10;\r\npriv->ap_mac_config.wmmApBcParams[1].aifs=7;\r\npriv->ap_mac_config.wmmApBcParams[1].txopLimit=0;\r\npriv->ap_mac_config.wmmApBcParams[1].admissionControlMandatory=FALSE;\r\npriv->ap_mac_config.wmmApBcParams[2].cwMin=3;\r\npriv->ap_mac_config.wmmApBcParams[2].cwMax=4;\r\npriv->ap_mac_config.wmmApBcParams[2].aifs=2;\r\npriv->ap_mac_config.wmmApBcParams[2].txopLimit=94;\r\npriv->ap_mac_config.wmmApBcParams[2].admissionControlMandatory=FALSE;\r\npriv->ap_mac_config.wmmApBcParams[3].cwMin=2;\r\npriv->ap_mac_config.wmmApBcParams[3].cwMax=3;\r\npriv->ap_mac_config.wmmApBcParams[3].aifs=2;\r\npriv->ap_mac_config.wmmApBcParams[3].txopLimit=47;\r\npriv->ap_mac_config.wmmApBcParams[3].admissionControlMandatory=FALSE;\r\npriv->ap_mac_config.accessType=CSR_WIFI_AP_ACCESS_TYPE_NONE;\r\npriv->ap_mac_config.macAddressListCount=0;\r\npriv->ap_mac_config.macAddressList=NULL;\r\npriv->ap_mac_config.apHtParams.rxStbc=1;\r\npriv->ap_mac_config.apHtParams.rifsModeAllowed=TRUE;\r\npriv->ap_mac_config.apHtParams.greenfieldSupported=FALSE;\r\npriv->ap_mac_config.apHtParams.shortGi20MHz=TRUE;\r\npriv->ap_mac_config.apHtParams.htProtection=0;\r\npriv->ap_mac_config.apHtParams.dualCtsProtection=FALSE;\r\npriv->ap_mac_config.phySupportedBitmap =\r\n(CSR_WIFI_SME_AP_PHY_SUPPORT_B|CSR_WIFI_SME_AP_PHY_SUPPORT_G|CSR_WIFI_SME_AP_PHY_SUPPORT_N);\r\npriv->ap_mac_config.beaconInterval= 100;\r\npriv->ap_mac_config.dtimPeriod=3;\r\npriv->ap_mac_config.maxListenInterval=0x00ff;\r\npriv->ap_mac_config.supportedRatesCount =\r\nuf_configure_supported_rates(priv->ap_mac_config.supportedRates,priv->ap_mac_config.phySupportedBitmap);\r\n}\r\nvoid\r\nuf_sme_wext_set_defaults(unifi_priv_t *priv)\r\n{\r\nmemset(&priv->connection_config, 0, sizeof(CsrWifiSmeConnectionConfig));\r\npriv->connection_config.bssType = CSR_WIFI_SME_BSS_TYPE_INFRASTRUCTURE;\r\npriv->connection_config.authModeMask = CSR_WIFI_SME_AUTH_MODE_80211_OPEN;\r\npriv->connection_config.encryptionModeMask = CSR_WIFI_SME_ENCRYPTION_CIPHER_NONE;\r\npriv->connection_config.privacyMode = CSR_WIFI_SME_80211_PRIVACY_MODE_DISABLED;\r\npriv->connection_config.wmmQosInfo = 0xFF;\r\npriv->connection_config.ifIndex = CSR_WIFI_SME_RADIO_IF_BOTH;\r\npriv->connection_config.adhocJoinOnly = FALSE;\r\npriv->connection_config.adhocChannel = 6;\r\npriv->wep_tx_key_index = 0;\r\npriv->wext_wireless_stats.qual.qual = 0;\r\npriv->wext_wireless_stats.qual.level = 0;\r\npriv->wext_wireless_stats.qual.noise = 0;\r\npriv->wext_wireless_stats.qual.updated = 0x70;\r\n#ifdef CSR_SUPPORT_WEXT_AP\r\nuf_sme_wext_ap_set_defaults(priv);\r\n#endif\r\n}\r\nstatic int\r\niwprivsdefs(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nint r;\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nCsrWifiSmeMibConfig mibConfig;\r\nCsrWifiSmePowerConfig powerConfig;\r\nunifi_trace(priv, UDBG1, "iwprivs80211defaults: reload defaults\n");\r\nuf_sme_wext_set_defaults(priv);\r\nr = sme_mgt_mib_config_get(priv, &mibConfig);\r\nif (r) {\r\nunifi_error(priv, "iwprivs80211defaults: Get CsrWifiSmeMibConfigValue failed.\n");\r\nreturn r;\r\n}\r\nmibConfig.dot11RtsThreshold = 2347;\r\nmibConfig.dot11FragmentationThreshold = 2346;\r\nr = sme_mgt_mib_config_set(priv, &mibConfig);\r\nif (r) {\r\nunifi_error(priv, "iwprivs80211defaults: Set CsrWifiSmeMibConfigValue failed.\n");\r\nreturn r;\r\n}\r\npowerConfig.powerSaveLevel = CSR_WIFI_SME_POWER_SAVE_LEVEL_LOW;\r\npowerConfig.listenIntervalTu = 100;\r\npowerConfig.rxDtims = 1;\r\nr = sme_mgt_power_config_set(priv, &powerConfig);\r\nif (r) {\r\nunifi_error(priv, "iwprivs80211defaults: Set unifi_PowerConfigValue failed.\n");\r\nreturn r;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\niwprivs80211ps(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nint r = 0;\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nint ps_mode = (int)(*extra);\r\nCsrWifiSmePowerConfig powerConfig;\r\nunifi_trace(priv, UDBG1, "iwprivs80211ps: power save mode = %d\n", ps_mode);\r\nr = sme_mgt_power_config_get(priv, &powerConfig);\r\nif (r) {\r\nunifi_error(priv, "iwprivs80211ps: Get unifi_PowerConfigValue failed.\n");\r\nreturn r;\r\n}\r\nswitch (ps_mode) {\r\ncase CSR_PMM_ACTIVE_MODE:\r\npowerConfig.powerSaveLevel = CSR_WIFI_SME_POWER_SAVE_LEVEL_LOW;\r\nbreak;\r\ncase CSR_PMM_POWER_SAVE:\r\npowerConfig.powerSaveLevel = CSR_WIFI_SME_POWER_SAVE_LEVEL_HIGH;\r\nbreak;\r\ncase CSR_PMM_FAST_POWER_SAVE:\r\npowerConfig.powerSaveLevel = CSR_WIFI_SME_POWER_SAVE_LEVEL_MED;\r\nbreak;\r\ndefault:\r\npowerConfig.powerSaveLevel = CSR_WIFI_SME_POWER_SAVE_LEVEL_AUTO;\r\nbreak;\r\n}\r\nr = sme_mgt_power_config_set(priv, &powerConfig);\r\nif (r) {\r\nunifi_error(priv, "iwprivs80211ps: Set unifi_PowerConfigValue failed.\n");\r\n}\r\nreturn r;\r\n}\r\nstatic int\r\niwprivg80211ps(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nCsrWifiSmePowerConfig powerConfig;\r\nint r;\r\nr = sme_mgt_power_config_get(priv, &powerConfig);\r\nif (r) {\r\nunifi_error(priv, "iwprivg80211ps: Get 802.11 power mode failed.\n");\r\nreturn r;\r\n}\r\nswitch (powerConfig.powerSaveLevel) {\r\ncase CSR_WIFI_SME_POWER_SAVE_LEVEL_LOW:\r\nsnprintf(extra, IWPRIV_POWER_SAVE_MAX_STRING,\r\n"Power save mode: %d (Active)",\r\npowerConfig.powerSaveLevel);\r\nbreak;\r\ncase CSR_WIFI_SME_POWER_SAVE_LEVEL_MED:\r\nsnprintf(extra, IWPRIV_POWER_SAVE_MAX_STRING,\r\n"Power save mode: %d (Fast)",\r\npowerConfig.powerSaveLevel);\r\nbreak;\r\ncase CSR_WIFI_SME_POWER_SAVE_LEVEL_HIGH:\r\nsnprintf(extra, IWPRIV_POWER_SAVE_MAX_STRING,\r\n"Power save mode: %d (Full)",\r\npowerConfig.powerSaveLevel);\r\nbreak;\r\ncase CSR_WIFI_SME_POWER_SAVE_LEVEL_AUTO:\r\nsnprintf(extra, IWPRIV_POWER_SAVE_MAX_STRING,\r\n"Power save mode: %d (Auto)",\r\npowerConfig.powerSaveLevel);\r\nbreak;\r\ndefault:\r\nsnprintf(extra, IWPRIV_POWER_SAVE_MAX_STRING,\r\n"Power save mode: %d (Unknown)",\r\npowerConfig.powerSaveLevel);\r\nbreak;\r\n}\r\nwrqu->data.length = strlen(extra) + 1;\r\nreturn 0;\r\n}\r\nstatic int\r\niwprivssmedebug(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\n#if defined (CSR_WIFI_HIP_DEBUG_OFFLINE)\r\nunifi_debug_buf_dump();\r\n#endif\r\nreturn 0;\r\n}\r\nstatic int hex_look_up(char x)\r\n{\r\nif(x>='0' && x<='9')\r\nreturn (x-48);\r\nif(x>= 'a' && x <= 'f')\r\nreturn (x-87);\r\nreturn -1;\r\n}\r\nstatic int power (int a, int b)\r\n{\r\nint i;\r\nint num =1;\r\nfor(i=0;i<b;i++)\r\nnum *=a;\r\nreturn num;\r\n}\r\nstatic int decode_parameter_from_string(unifi_priv_t* priv, char **str_ptr,\r\nconst char *token, int param_type,\r\nvoid *dst, int param_max_len)\r\n{\r\nu8 int_str[7] = "0";\r\nu32 param_str_len;\r\nu8 *param_str_begin,*param_str_end;\r\nu8 *orig_str = *str_ptr;\r\nif (!strncmp(*str_ptr, token, strlen(token))) {\r\nstrsep(str_ptr, "=,");\r\nparam_str_begin = *str_ptr;\r\nstrsep(str_ptr, "=,");\r\nif (*str_ptr == NULL) {\r\nparam_str_len = strlen(param_str_begin);\r\n} else {\r\nparam_str_end = *str_ptr-1;\r\nparam_str_len = param_str_end - param_str_begin;\r\n}\r\nunifi_trace(priv,UDBG2,"'token:%s', len:%d, ", token, param_str_len);\r\nif (param_str_len > param_max_len) {\r\nunifi_notice(priv,"extracted param len:%d is > MAX:%d\n",param_str_len, param_max_len);\r\nparam_str_len = param_max_len;\r\n}\r\nswitch (param_type) {\r\ncase PARAM_TYPE_INT:\r\n{\r\nu32 *pdst_int = dst,num =0;\r\nint i,j=0;\r\nif (param_str_len > sizeof(int_str)) {\r\nparam_str_len = sizeof(int_str);\r\n}\r\nmemcpy(int_str, param_str_begin, param_str_len);\r\nfor(i = param_str_len; i>0;i--) {\r\nif(int_str[i-1] >= '0' && int_str[i-1] <='9') {\r\nnum += ((int_str[i-1]-'0')*power(10,j));\r\nj++;\r\n} else {\r\nunifi_error(priv,"decode_parameter_from_string:not a number %c\n",(int_str[i-1]));\r\nreturn -1;\r\n}\r\n}\r\n*pdst_int = num;\r\nunifi_trace(priv,UDBG2,"decode_parameter_from_string:decoded int = %d\n",*pdst_int);\r\n}\r\nbreak;\r\ndefault:\r\nmemcpy(dst, param_str_begin, param_str_len);\r\n*((char *)dst + param_str_len) = 0;\r\nunifi_trace(priv,UDBG2,"decode_parameter_from_string:decoded string = %s\n",(char *)dst);\r\nbreak;\r\n}\r\n} else {\r\nunifi_error(priv,"decode_parameter_from_string: Token:%s not found in %s \n",token,orig_str);\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int store_ap_advanced_config_from_string(unifi_priv_t *priv, char *param_str)\r\n{\r\nchar * str_ptr=param_str;\r\nint ret = 0,tmp_var;\r\nchar phy_mode[6];\r\nCsrWifiSmeApMacConfig * ap_mac_config = &priv->ap_mac_config;\r\nret = decode_parameter_from_string(priv, &str_ptr, "BI=",\r\nPARAM_TYPE_INT, &tmp_var, 5);\r\nif(ret) {\r\nunifi_error(priv,"store_ap_advanced_config_from_string: BI not found\n");\r\nreturn -1;\r\n}\r\nap_mac_config->beaconInterval = tmp_var;\r\nret = decode_parameter_from_string(priv, &str_ptr, "DTIM_PER=",\r\nPARAM_TYPE_INT, &tmp_var, 5);\r\nif(ret) {\r\nunifi_error(priv,"store_ap_advanced_config_from_string: DTIM_PER not found\n");\r\nreturn -1;\r\n}\r\nap_mac_config->dtimPeriod = tmp_var;\r\nret = decode_parameter_from_string(priv, &str_ptr, "WMM=",\r\nPARAM_TYPE_INT, &tmp_var, 5);\r\nif(ret) {\r\nunifi_error(priv,"store_ap_advanced_config_from_string: WMM not found\n");\r\nreturn -1;\r\n}\r\nap_mac_config->wmmEnabled = tmp_var;\r\nret = decode_parameter_from_string(priv, &str_ptr, "PHY=",\r\nPARAM_TYPE_STRING, phy_mode, 5);\r\nif(ret) {\r\nunifi_error(priv,"store_ap_advanced_config_from_string: PHY not found\n");\r\n} else {\r\nif(strstr(phy_mode,"b")){\r\nap_mac_config->phySupportedBitmap = CSR_WIFI_SME_AP_PHY_SUPPORT_B;\r\n}\r\nif(strstr(phy_mode,"g")) {\r\nap_mac_config->phySupportedBitmap |= CSR_WIFI_SME_AP_PHY_SUPPORT_G;\r\n}\r\nif(strstr(phy_mode,"n")) {\r\nap_mac_config->phySupportedBitmap |= CSR_WIFI_SME_AP_PHY_SUPPORT_N;\r\n}\r\nap_mac_config->supportedRatesCount =\r\nuf_configure_supported_rates(ap_mac_config->supportedRates, ap_mac_config->phySupportedBitmap);\r\n}\r\nreturn ret;\r\n}\r\nstatic int store_ap_config_from_string( unifi_priv_t * priv,char *param_str)\r\n{\r\nchar *str_ptr = param_str;\r\nchar sub_cmd[16];\r\nchar sec[CSR_WIFI_MAX_SEC_LEN];\r\nchar key[CSR_WIFI_MAX_KEY_LEN];\r\nint ret = 0,tmp_var;\r\nCsrWifiSmeApConfig_t *ap_config = &priv->ap_config;\r\nCsrWifiSmeApMacConfig * ap_mac_config = &priv->ap_mac_config;\r\nmemset(sub_cmd, 0, sizeof(sub_cmd));\r\nif(!strstr(param_str,"END")) {\r\nunifi_error(priv,"store_ap_config_from_string:Invalid config string:%s\n",param_str);\r\nreturn -1;\r\n}\r\nif (decode_parameter_from_string(priv,&str_ptr, "ASCII_CMD=",\r\nPARAM_TYPE_STRING, sub_cmd, 6) != 0) {\r\nreturn -1;\r\n}\r\nif (strncmp(sub_cmd, "AP_CFG", 6)) {\r\nif(!strncmp(sub_cmd ,"ADVCFG", 6)) {\r\nreturn store_ap_advanced_config_from_string(priv, str_ptr);\r\n}\r\nunifi_error(priv,"store_ap_config_from_string: sub_cmd:%s != 'AP_CFG or ADVCFG'!\n", sub_cmd);\r\nreturn -1;\r\n}\r\nmemset(ap_config, 0, sizeof(CsrWifiSmeApConfig_t));\r\nret = decode_parameter_from_string(priv,&str_ptr, "SSID=",\r\nPARAM_TYPE_STRING, ap_config->ssid.ssid,\r\nCSR_WIFI_MAX_SSID_LEN);\r\nif(ret) {\r\nunifi_error(priv,"store_ap_config_from_string: SSID not found\n");\r\nreturn -1;\r\n}\r\nap_config->ssid.length = strlen(ap_config->ssid.ssid);\r\nret = decode_parameter_from_string(priv, &str_ptr, "SEC=",\r\nPARAM_TYPE_STRING, sec, CSR_WIFI_MAX_SEC_LEN);\r\nif(ret) {\r\nunifi_error(priv,"store_ap_config_from_string: SEC not found\n");\r\nreturn -1;\r\n}\r\nret = decode_parameter_from_string(priv,&str_ptr, "KEY=",\r\nPARAM_TYPE_STRING, key, CSR_WIFI_MAX_KEY_LEN);\r\nif(!strcasecmp(sec,"open")) {\r\nunifi_trace(priv,UDBG2,"store_ap_config_from_string: security open");\r\nap_config->credentials.authType = CSR_WIFI_SME_AP_AUTH_TYPE_OPEN_SYSTEM;\r\nif(ret) {\r\nunifi_notice(priv,"store_ap_config_from_string: KEY not found:fine with Open\n");\r\n}\r\n}\r\nelse if(!strcasecmp(sec,"wpa2-psk")) {\r\nint i,j=0;\r\nCsrWifiNmeApAuthPers *pers =\r\n((CsrWifiNmeApAuthPers *)&(ap_config->credentials.nmeAuthType.authTypePersonal));\r\nu8 *psk = pers->authPers_credentials.psk.psk;\r\nunifi_trace(priv,UDBG2,"store_ap_config_from_string: security WPA2");\r\nif(ret) {\r\nunifi_error(priv,"store_ap_config_from_string: KEY not found for WPA2\n");\r\nreturn -1;\r\n}\r\nap_config->credentials.authType = CSR_WIFI_SME_AP_AUTH_TYPE_PERSONAL;\r\npers->authSupport = CSR_WIFI_SME_RSN_AUTH_WPA2PSK;\r\npers->rsnCapabilities =0;\r\npers->wapiCapabilities =0;\r\npers->pskOrPassphrase=CSR_WIFI_NME_AP_CREDENTIAL_TYPE_PSK;\r\npers->authPers_credentials.psk.encryptionMode =\r\n(CSR_WIFI_NME_ENCRYPTION_CIPHER_PAIRWISE_CCMP |CSR_WIFI_NME_ENCRYPTION_CIPHER_GROUP_CCMP) ;\r\nfor(i=0;i<32;i++){\r\npsk[i] = (16*hex_look_up(key[j]))+hex_look_up(key[j+1]);\r\nj+=2;\r\n}\r\n} else {\r\nunifi_notice(priv,"store_ap_config_from_string: Unknown security: Assuming Open");\r\nap_config->credentials.authType = CSR_WIFI_SME_AP_AUTH_TYPE_OPEN_SYSTEM;\r\nreturn -1;\r\n}\r\nret = decode_parameter_from_string(priv,&str_ptr, "CHANNEL=", PARAM_TYPE_INT, &tmp_var, 5);\r\nif(ret)\r\nreturn -1;\r\nap_config->channel = tmp_var;\r\nret = decode_parameter_from_string(priv,&str_ptr, "PREAMBLE=", PARAM_TYPE_INT, &tmp_var, 5);\r\nif(ret)\r\nreturn -1;\r\nap_mac_config->preamble = tmp_var;\r\nret = decode_parameter_from_string(priv,&str_ptr, "MAX_SCB=", PARAM_TYPE_INT, &tmp_var, 5);\r\nap_config->max_connections = tmp_var;\r\nreturn ret;\r\n}\r\nstatic int\r\niwprivsapstart(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nint r;\r\nunifi_trace(priv, UDBG1, "iwprivsapstart\n" );\r\nr = sme_ap_start(priv,interfacePriv->InterfaceTag,&priv->ap_config);\r\nif(r) {\r\nunifi_error(priv,"iwprivsapstart AP START failed : %d\n",-r);\r\n}\r\nreturn r;\r\n}\r\nstatic int\r\niwprivsapconfig(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nchar *cfg_str = NULL;\r\nint r;\r\nunifi_trace(priv, UDBG1, "iwprivsapconfig\n" );\r\nif (wrqu->data.length != 0) {\r\nchar *str;\r\nif (!(cfg_str = kmalloc(wrqu->data.length+1, GFP_KERNEL)))\r\n{\r\nreturn -ENOMEM;\r\n}\r\nif (copy_from_user(cfg_str, wrqu->data.pointer, wrqu->data.length)) {\r\nkfree(cfg_str);\r\nreturn -EFAULT;\r\n}\r\ncfg_str[wrqu->data.length] = 0;\r\nunifi_trace(priv,UDBG2,"length:%d\n",wrqu->data.length);\r\nunifi_trace(priv,UDBG2,"AP configuration string:%s\n",cfg_str);\r\nstr = cfg_str;\r\nif ((r = store_ap_config_from_string(priv,str))) {\r\nunifi_error(priv, "iwprivsapconfig:Failed to decode the string %d\n",r);\r\nkfree(cfg_str);\r\nreturn -EIO;\r\n}\r\n} else {\r\nunifi_error(priv,"iwprivsapconfig argument length = 0 \n");\r\nreturn -EIO;\r\n}\r\nr = sme_ap_config(priv, &priv->ap_mac_config, &priv->group_sec_config);\r\nif(r) {\r\nunifi_error(priv,"iwprivsapstop AP Config failed : %d\n",-r);\r\n} else if(interfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_AP ||\r\ninterfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_P2PGO) {\r\nunifi_trace(priv, UDBG1, "iwprivsapconfig: Starting the AP");\r\nr = sme_ap_start(priv,interfacePriv->InterfaceTag,&priv->ap_config);\r\nif(r) {\r\nunifi_error(priv,"iwprivsapstart AP START failed : %d\n",-r);\r\n}\r\n}\r\nkfree(cfg_str);\r\nreturn r;\r\n}\r\nstatic int\r\niwprivsapstop(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nint r;\r\nu16 interface_tag = interfacePriv->InterfaceTag;\r\nunifi_trace(priv, UDBG1, "iwprivsapstop\n" );\r\nr = sme_ap_stop(priv,interface_tag);\r\nif(r) {\r\nunifi_error(priv,"iwprivsapstop AP STOP failed : %d\n",-r);\r\n}\r\nreturn r;\r\n}\r\nstatic int\r\niwprivsapfwreload(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nunifi_trace(priv, UDBG1, "iwprivsapfwreload\n" );\r\nreturn 0;\r\n}\r\nstatic int\r\niwprivsstackstart(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nunifi_trace(priv, UDBG1, "iwprivsstackstart\n" );\r\nreturn 0;\r\n}\r\nstatic int\r\niwprivsstackstop(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nint r = 0;\r\nu16 interface_tag = interfacePriv->InterfaceTag;\r\nunifi_trace(priv, UDBG1, "iwprivsstackstop\n" );\r\nswitch(interfacePriv->interfaceMode) {\r\ncase CSR_WIFI_ROUTER_CTRL_MODE_STA:\r\ncase CSR_WIFI_ROUTER_CTRL_MODE_P2PCLI:\r\ncase CSR_WIFI_ROUTER_CTRL_MODE_IBSS:\r\nr = sme_mgt_disconnect(priv);\r\nbreak;\r\ncase CSR_WIFI_ROUTER_CTRL_MODE_AP:\r\ncase CSR_WIFI_ROUTER_CTRL_MODE_P2PGO:\r\nr = sme_ap_stop(priv,interface_tag);\r\nbreak;\r\ndefault :\r\nbreak;\r\n}\r\nif(r) {\r\nunifi_error(priv,"iwprivsstackstop Stack stop failed : %d\n",-r);\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\niwprivsconfwapi(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nu8 enable;\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nunifi_trace(priv, UDBG1, "iwprivsconfwapi\n" );\r\nif(interfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_AP ||\r\ninterfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_P2PGO) {\r\nunifi_error(priv, "iwprivsconfwapi: not permitted in Mode %d\n",\r\ninterfacePriv->interfaceMode);\r\nreturn -EPERM;\r\n}\r\nenable = *(u8*)(extra);\r\nif (enable) {\r\npriv->connection_config.authModeMask = CSR_WIFI_SME_AUTH_MODE_80211_OPEN;\r\npriv->connection_config.authModeMask |= (CSR_WIFI_SME_AUTH_MODE_WAPI_WAIPSK | CSR_WIFI_SME_AUTH_MODE_WAPI_WAI);\r\npriv->connection_config.encryptionModeMask |=\r\nCSR_WIFI_SME_ENCRYPTION_CIPHER_PAIRWISE_SMS4 | CSR_WIFI_SME_ENCRYPTION_CIPHER_GROUP_SMS4;\r\n} else {\r\npriv->connection_config.authModeMask &= ~(CSR_WIFI_SME_AUTH_MODE_WAPI_WAIPSK | CSR_WIFI_SME_AUTH_MODE_WAPI_WAI);\r\npriv->connection_config.encryptionModeMask &=\r\n~(CSR_WIFI_SME_ENCRYPTION_CIPHER_PAIRWISE_SMS4 | CSR_WIFI_SME_ENCRYPTION_CIPHER_GROUP_SMS4);\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\niwprivswpikey(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nint r = 0, i;\r\nCsrWifiSmeKey key;\r\nunifiio_wapi_key_t inKey;\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nunifi_trace(priv, UDBG1, "iwprivswpikey\n" );\r\nif(interfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_AP ||\r\ninterfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_P2PGO) {\r\nunifi_error(priv, "iwprivswpikey: not permitted in Mode %d\n",\r\ninterfacePriv->interfaceMode);\r\nreturn -EPERM;\r\n}\r\ninKey = *(unifiio_wapi_key_t*)(extra);\r\nif (inKey.unicastKey) {\r\nkey.keyType = CSR_WIFI_SME_KEY_TYPE_PAIRWISE;\r\n} else {\r\nkey.keyType = CSR_WIFI_SME_KEY_TYPE_GROUP;\r\n}\r\nkey.keyIndex = inKey.keyIndex;\r\nfor (i = 0; i < 16; i+= 2)\r\n{\r\nkey.keyRsc[i/2] = inKey.keyRsc[i+1] << 8 | inKey.keyRsc[i];\r\n}\r\nmemcpy(key.address.a, inKey.address, 6);\r\nkey.keyLength = 32;\r\nmemcpy(key.key, inKey.key, 32);\r\nkey.authenticator = 0;\r\nkey.wepTxKey = 0;\r\nunifi_trace(priv, UDBG1, "keyType = %d, keyIndex = %d, wepTxKey = %d, keyRsc = %x:%x, auth = %d, address = %x:%x, "\r\n"keylength = %d, key = %x:%x\n", key.keyType, key.keyIndex, key.wepTxKey,\r\nkey.keyRsc[0], key.keyRsc[7], key.authenticator,\r\nkey.address.a[0], key.address.a[5], key.keyLength, key.key[0],\r\nkey.key[15]);\r\nr = sme_mgt_key(priv, &key, CSR_WIFI_SME_LIST_ACTION_ADD);\r\nif (r) {\r\nunifi_error(priv, "SETKEYS request was rejected with result %d\n", r);\r\nreturn convert_sme_error(r);\r\n}\r\nreturn r;\r\n}\r\nstatic int\r\nunifi_giwname(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nchar *name = wrqu->name;\r\nunifi_trace(priv, UDBG2, "unifi_giwname\n");\r\nif (priv->if_index == CSR_INDEX_5G) {\r\nstrcpy(name, "IEEE 802.11-a");\r\n} else {\r\nstrcpy(name, "IEEE 802.11-bgn");\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nunifi_siwfreq(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nstruct iw_freq *freq = (struct iw_freq *)wrqu;\r\nunifi_trace(priv, UDBG2, "unifi_siwfreq\n");\r\nif(interfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_AP ||\r\ninterfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_P2PGO) {\r\nunifi_error(priv, "unifi_siwfreq: not permitted in Mode %d\n",\r\ninterfacePriv->interfaceMode);\r\nreturn -EPERM;\r\n}\r\nif ((freq->e == 0) && (freq->m <= 1000)) {\r\npriv->connection_config.adhocChannel = freq->m;\r\n} else {\r\npriv->connection_config.adhocChannel = wext_freq_to_channel(freq->m, freq->e);\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nunifi_giwfreq(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nstruct iw_freq *freq = (struct iw_freq *)wrqu;\r\nint err = 0;\r\nCsrWifiSmeConnectionInfo connectionInfo;\r\nunifi_trace(priv, UDBG2, "unifi_giwfreq\n");\r\nCHECK_INITED(priv);\r\nif(interfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_AP ||\r\ninterfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_P2PGO) {\r\nunifi_error(priv, "unifi_giwfreq: not permitted in Mode %d\n",\r\ninterfacePriv->interfaceMode);\r\nreturn -EPERM;\r\n}\r\nUF_RTNL_UNLOCK();\r\nerr = sme_mgt_connection_info_get(priv, &connectionInfo);\r\nUF_RTNL_LOCK();\r\nfreq->m = channel_to_mhz(connectionInfo.channelNumber,\r\n(connectionInfo.networkType80211 == CSR_WIFI_SME_RADIO_IF_GHZ_5_0));\r\nfreq->e = 6;\r\nreturn convert_sme_error(err);\r\n}\r\nstatic int\r\nunifi_siwmode(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nunifi_trace(priv, UDBG2, "unifi_siwmode\n");\r\nif(interfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_AP ||\r\ninterfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_P2PGO) {\r\nunifi_error(priv, "unifi_siwmode: not permitted in Mode %d\n",\r\ninterfacePriv->interfaceMode);\r\nreturn -EPERM;\r\n}\r\nswitch(wrqu->mode) {\r\ncase IW_MODE_ADHOC:\r\npriv->connection_config.bssType = CSR_WIFI_SME_BSS_TYPE_ADHOC;\r\nbreak;\r\ncase IW_MODE_INFRA:\r\npriv->connection_config.bssType = CSR_WIFI_SME_BSS_TYPE_INFRASTRUCTURE;\r\nbreak;\r\ncase IW_MODE_AUTO:\r\npriv->connection_config.bssType = CSR_WIFI_SME_BSS_TYPE_ANY_BSS;\r\nbreak;\r\ndefault:\r\nunifi_notice(priv, "Unknown IW MODE value.\n");\r\n}\r\npriv->connection_config.ssid.length = 0;\r\nmemset(priv->connection_config.bssid.a, 0xFF, ETH_ALEN);\r\nreturn 0;\r\n}\r\nstatic int\r\nunifi_giwmode(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nint r = 0;\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nCsrWifiSmeConnectionConfig connectionConfig;\r\nunifi_trace(priv, UDBG2, "unifi_giwmode\n");\r\nCHECK_INITED(priv);\r\nunifi_trace(priv, UDBG2, "unifi_giwmode: Exisitng mode = 0x%x\n",\r\ninterfacePriv->interfaceMode);\r\nswitch(interfacePriv->interfaceMode) {\r\ncase CSR_WIFI_ROUTER_CTRL_MODE_STA:\r\ncase CSR_WIFI_ROUTER_CTRL_MODE_P2PCLI:\r\nwrqu->mode = IW_MODE_INFRA;\r\nbreak;\r\ncase CSR_WIFI_ROUTER_CTRL_MODE_AP:\r\ncase CSR_WIFI_ROUTER_CTRL_MODE_P2PGO:\r\nwrqu->mode = IW_MODE_MASTER;\r\nbreak;\r\ncase CSR_WIFI_ROUTER_CTRL_MODE_IBSS:\r\nwrqu->mode = IW_MODE_ADHOC;\r\nbreak;\r\ncase CSR_WIFI_ROUTER_CTRL_MODE_P2P:\r\ncase CSR_WIFI_ROUTER_CTRL_MODE_NONE:\r\nUF_RTNL_UNLOCK();\r\nr = sme_mgt_connection_config_get(priv, &connectionConfig);\r\nUF_RTNL_LOCK();\r\nif (r == 0) {\r\nswitch(connectionConfig.bssType) {\r\ncase CSR_WIFI_SME_BSS_TYPE_ADHOC:\r\nwrqu->mode = IW_MODE_ADHOC;\r\nbreak;\r\ncase CSR_WIFI_SME_BSS_TYPE_INFRASTRUCTURE:\r\nwrqu->mode = IW_MODE_INFRA;\r\nbreak;\r\ndefault:\r\nwrqu->mode = IW_MODE_AUTO;\r\nunifi_notice(priv, "Unknown IW MODE value.\n");\r\n}\r\n}\r\nbreak;\r\ndefault:\r\nwrqu->mode = IW_MODE_AUTO;\r\nunifi_notice(priv, "Unknown IW MODE value.\n");\r\n}\r\nunifi_trace(priv, UDBG4, "unifi_giwmode: mode = 0x%x\n", wrqu->mode);\r\nreturn r;\r\n}\r\nstatic int\r\nunifi_giwrange(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct iw_point *dwrq = &wrqu->data;\r\nstruct iw_range *range = (struct iw_range *) extra;\r\nint i;\r\nunifi_trace(NULL, UDBG2, "unifi_giwrange\n");\r\ndwrq->length = sizeof(struct iw_range);\r\nmemset(range, 0, sizeof(*range));\r\nrange->min_nwid = 0x0000;\r\nrange->max_nwid = 0x0000;\r\nrange->max_qual.qual = 40;\r\nrange->max_qual.level = -120;\r\nrange->max_qual.noise = -120;\r\ni = 0;\r\n#if WIRELESS_EXT > 15\r\nrange->bitrate[i++] = 2 * 500000;\r\nrange->bitrate[i++] = 4 * 500000;\r\nrange->bitrate[i++] = 11 * 500000;\r\nrange->bitrate[i++] = 22 * 500000;\r\nrange->bitrate[i++] = 12 * 500000;\r\nrange->bitrate[i++] = 18 * 500000;\r\nrange->bitrate[i++] = 24 * 500000;\r\nrange->bitrate[i++] = 36 * 500000;\r\nrange->bitrate[i++] = 48 * 500000;\r\nrange->bitrate[i++] = 72 * 500000;\r\nrange->bitrate[i++] = 96 * 500000;\r\nrange->bitrate[i++] = 108 * 500000;\r\n#else\r\nrange->bitrate[i++] = 2 * 500000;\r\nrange->bitrate[i++] = 4 * 500000;\r\nrange->bitrate[i++] = 11 * 500000;\r\nrange->bitrate[i++] = 22 * 500000;\r\nrange->bitrate[i++] = 24 * 500000;\r\nrange->bitrate[i++] = 48 * 500000;\r\nrange->bitrate[i++] = 96 * 500000;\r\nrange->bitrate[i++] = 108 * 500000;\r\n#endif\r\nrange->num_bitrates = i;\r\nrange->max_encoding_tokens = NUM_WEPKEYS;\r\nrange->num_encoding_sizes = 2;\r\nrange->encoding_size[0] = 5;\r\nrange->encoding_size[1] = 13;\r\nrange->we_version_source = 20;\r\nrange->we_version_compiled = WIRELESS_EXT;\r\nrange->num_channels = 14;\r\nrange->num_frequency = 14;\r\nfor (i = 0; (i < range->num_frequency) && (i < IW_MAX_FREQUENCIES); i++) {\r\nint chan = i + 1;\r\nrange->freq[i].i = chan;\r\nrange->freq[i].m = channel_to_mhz(chan, 0);\r\nrange->freq[i].e = 6;\r\n}\r\nif ((i+3) < IW_MAX_FREQUENCIES) {\r\nrange->freq[i].i = 36;\r\nrange->freq[i].m = channel_to_mhz(36, 1);\r\nrange->freq[i].e = 6;\r\nrange->freq[i+1].i = 40;\r\nrange->freq[i+1].m = channel_to_mhz(40, 1);\r\nrange->freq[i+1].e = 6;\r\nrange->freq[i+2].i = 44;\r\nrange->freq[i+2].m = channel_to_mhz(44, 1);\r\nrange->freq[i+2].e = 6;\r\nrange->freq[i+3].i = 48;\r\nrange->freq[i+3].m = channel_to_mhz(48, 1);\r\nrange->freq[i+3].e = 6;\r\n}\r\n#if WIRELESS_EXT > 16\r\nrange->event_capa[0] = (IW_EVENT_CAPA_K_0 |\r\nIW_EVENT_CAPA_MASK(SIOCGIWTHRSPY) |\r\nIW_EVENT_CAPA_MASK(SIOCGIWAP) |\r\nIW_EVENT_CAPA_MASK(SIOCGIWSCAN));\r\nrange->event_capa[1] = IW_EVENT_CAPA_K_1;\r\nrange->event_capa[4] = (IW_EVENT_CAPA_MASK(IWEVTXDROP) |\r\nIW_EVENT_CAPA_MASK(IWEVCUSTOM) |\r\nIW_EVENT_CAPA_MASK(IWEVREGISTERED) |\r\nIW_EVENT_CAPA_MASK(IWEVEXPIRED));\r\n#endif\r\n#if WIRELESS_EXT > 17\r\nrange->enc_capa = IW_ENC_CAPA_WPA | IW_ENC_CAPA_WPA2 |\r\nIW_ENC_CAPA_CIPHER_TKIP | IW_ENC_CAPA_CIPHER_CCMP;\r\n#endif\r\nreturn 0;\r\n}\r\nstatic int\r\nunifi_siwap(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nint err = 0;\r\nCHECK_INITED(priv);\r\nif(interfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_AP ||\r\ninterfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_P2PGO) {\r\nunifi_error(priv, "unifi_siwap: not permitted in Mode %d\n",\r\ninterfacePriv->interfaceMode);\r\nreturn -EPERM;\r\n}\r\nif (wrqu->ap_addr.sa_family != ARPHRD_ETHER) {\r\nreturn -EINVAL;\r\n}\r\nunifi_trace(priv, UDBG1, "unifi_siwap: asked for %pM\n",\r\nwrqu->ap_addr.sa_data);\r\nif (is_zero_ether_addr(wrqu->ap_addr.sa_data)) {\r\npriv->ignore_bssid_join = FALSE;\r\nerr = sme_mgt_disconnect(priv);\r\nif (err) {\r\nunifi_trace(priv, UDBG4, "unifi_siwap: Disconnect failed, status %d\n", err);\r\n}\r\nreturn 0;\r\n}\r\nif (priv->ignore_bssid_join) {\r\nunifi_trace(priv, UDBG4, "unifi_siwap: ignoring second join\n");\r\npriv->ignore_bssid_join = FALSE;\r\n} else {\r\nmemcpy(priv->connection_config.bssid.a, wrqu->ap_addr.sa_data, ETH_ALEN);\r\nunifi_trace(priv, UDBG1, "unifi_siwap: Joining %X:%X:%X:%X:%X:%X\n",\r\npriv->connection_config.bssid.a[0],\r\npriv->connection_config.bssid.a[1],\r\npriv->connection_config.bssid.a[2],\r\npriv->connection_config.bssid.a[3],\r\npriv->connection_config.bssid.a[4],\r\npriv->connection_config.bssid.a[5]);\r\nerr = sme_mgt_connect(priv);\r\nif (err) {\r\nunifi_error(priv, "unifi_siwap: Join failed, status %d\n", err);\r\nreturn convert_sme_error(err);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nunifi_giwap(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nCsrWifiSmeConnectionInfo connectionInfo;\r\nint r = 0;\r\nu8 *bssid;\r\nCHECK_INITED(priv);\r\nunifi_trace(priv, UDBG2, "unifi_giwap\n");\r\nif(interfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_AP ||\r\ninterfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_P2PGO) {\r\nunifi_error(priv, "iwprivswpikey: not permitted in Mode %d\n",\r\ninterfacePriv->interfaceMode);\r\nreturn -EPERM;\r\n}\r\nUF_RTNL_UNLOCK();\r\nr = sme_mgt_connection_info_get(priv, &connectionInfo);\r\nUF_RTNL_LOCK();\r\nif (r == 0) {\r\nbssid = connectionInfo.bssid.a;\r\nwrqu->ap_addr.sa_family = ARPHRD_ETHER;\r\nunifi_trace(priv, UDBG4, "unifi_giwap: BSSID = %pM\n", bssid);\r\nmemcpy(wrqu->ap_addr.sa_data, bssid, ETH_ALEN);\r\n} else {\r\nmemset(wrqu->ap_addr.sa_data, 0, ETH_ALEN);\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nunifi_siwscan(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nint scantype;\r\nint r;\r\nCsrWifiSsid scan_ssid;\r\nunsigned char *channel_list = NULL;\r\nint chans_good = 0;\r\n#if WIRELESS_EXT > 17\r\nstruct iw_point *data = &wrqu->data;\r\nstruct iw_scan_req *req = (struct iw_scan_req *) extra;\r\n#endif\r\nCHECK_INITED(priv);\r\nif(interfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_AP ||\r\ninterfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_P2PGO) {\r\nunifi_error(priv, "unifi_siwscan: not permitted in Mode %d\n",\r\ninterfacePriv->interfaceMode);\r\nreturn -EPERM;\r\n}\r\nscantype = UNIFI_SCAN_ACTIVE;\r\n#if WIRELESS_EXT > 17\r\nif (req) {\r\nif ((req->num_channels > 0) && (req->num_channels < IW_MAX_FREQUENCIES)) {\r\nchannel_list = kmalloc(req->num_channels, GFP_KERNEL);\r\nif (channel_list) {\r\nint i;\r\nfor (i = 0; i < req->num_channels; i++) {\r\nint ch = wext_freq_to_channel(req->channel_list[i].m,\r\nreq->channel_list[i].e);\r\nif (ch) {\r\nchannel_list[chans_good++] = ch;\r\n}\r\n}\r\nunifi_trace(priv, UDBG1,\r\n"SIWSCAN: Scanning %d channels\n", chans_good);\r\n} else {\r\nunifi_error(priv, "SIWSCAN: Can't alloc channel_list (%d)\n",\r\nreq->num_channels);\r\n}\r\n}\r\n}\r\nif (req && (data->flags & IW_SCAN_THIS_ESSID)) {\r\nmemcpy(scan_ssid.ssid, req->essid, req->essid_len);\r\nscan_ssid.length = req->essid_len;\r\nunifi_trace(priv, UDBG1,\r\n"SIWSCAN: Scanning for %.*s\n",\r\nscan_ssid.length, scan_ssid.ssid);\r\n} else\r\n#endif\r\n{\r\nunifi_trace(priv, UDBG1, "SIWSCAN: Scanning for all APs\n");\r\nscan_ssid.length = 0;\r\n}\r\nr = sme_mgt_scan_full(priv, &scan_ssid, chans_good, channel_list);\r\nif (r) {\r\nunifi_error(priv, "SIWSCAN: Scan returned error %d\n", r);\r\n} else {\r\nunifi_trace(priv, UDBG1, "SIWSCAN: Scan done\n");\r\nwext_send_scan_results_event(priv);\r\n}\r\nif (channel_list) {\r\nkfree(channel_list);\r\n}\r\nreturn r;\r\n}\r\nstatic const unsigned char *\r\nunifi_find_info_element(int id, const unsigned char *info, int len)\r\n{\r\nconst unsigned char *ie = info;\r\nwhile (len > 1)\r\n{\r\nint e_id, e_len;\r\ne_id = ie[0];\r\ne_len = ie[1];\r\nif (e_id == id)\r\n{\r\nreturn ie;\r\n}\r\nlen -= (e_len + 2);\r\nie += (e_len + 2);\r\n}\r\nreturn NULL;\r\n}\r\nint\r\nunifi_translate_scan(struct net_device *dev,\r\nstruct iw_request_info *info,\r\nchar *current_ev, char *end_buf,\r\nCsrWifiSmeScanResult *scan_data,\r\nint scan_index)\r\n{\r\nstruct iw_event iwe;\r\nunsigned char *info_elems;\r\nint info_elem_len;\r\nconst unsigned char *elem;\r\nu16 capabilities;\r\nint signal, noise, snr;\r\nchar *start_buf = current_ev;\r\nchar *current_val;\r\nint i, r;\r\ninfo_elems = scan_data->informationElements;\r\ninfo_elem_len = scan_data->informationElementsLength;\r\nif (!scan_data->informationElementsLength || !scan_data->informationElements) {\r\nunifi_error(NULL, "*** NULL SCAN IEs ***\n");\r\nreturn -EIO;\r\n}\r\ncapabilities = scan_data->capabilityInformation;\r\nunifi_trace(NULL, UDBG5, "Capabilities: 0x%x\n", capabilities);\r\nmemset(&iwe, 0, sizeof(iwe));\r\niwe.cmd = SIOCGIWAP;\r\niwe.u.ap_addr.sa_family = ARPHRD_ETHER;\r\nmemcpy(iwe.u.ap_addr.sa_data, scan_data->bssid.a, ETH_ALEN);\r\niwe.len = IW_EV_ADDR_LEN;\r\nr = uf_iwe_stream_add_event(info, start_buf, end_buf, &iwe, IW_EV_ADDR_LEN);\r\nif (r < 0) {\r\nreturn r;\r\n}\r\nstart_buf += r;\r\nelem = unifi_find_info_element(IE_SSID_ID, info_elems, info_elem_len);\r\nif (elem) {\r\nint e_len = elem[1];\r\nconst unsigned char *e_ptr = elem + 2;\r\nunsigned char buf[33];\r\nmemset(&iwe, 0, sizeof(iwe));\r\niwe.cmd = SIOCGIWESSID;\r\niwe.u.essid.length = e_len;\r\nif (iwe.u.essid.length > 32) {\r\niwe.u.essid.length = 32;\r\n}\r\niwe.u.essid.flags = scan_index;\r\nmemcpy(buf, e_ptr, iwe.u.essid.length);\r\nbuf[iwe.u.essid.length] = '\0';\r\nr = uf_iwe_stream_add_point(info, start_buf, end_buf, &iwe, buf);\r\nif (r < 0) {\r\nreturn r;\r\n}\r\nstart_buf += r;\r\n}\r\nmemset(&iwe, 0, sizeof(iwe));\r\niwe.cmd = SIOCGIWMODE;\r\nif (scan_data->bssType == CSR_WIFI_SME_BSS_TYPE_INFRASTRUCTURE) {\r\niwe.u.mode = IW_MODE_INFRA;\r\n} else {\r\niwe.u.mode = IW_MODE_ADHOC;\r\n}\r\niwe.len = IW_EV_UINT_LEN;\r\nr = uf_iwe_stream_add_event(info, start_buf, end_buf, &iwe, IW_EV_UINT_LEN);\r\nif (r < 0) {\r\nreturn r;\r\n}\r\nstart_buf += r;\r\nmemset(&iwe, 0, sizeof(iwe));\r\niwe.cmd = SIOCGIWFREQ;\r\niwe.u.freq.m = scan_data->channelFrequency;\r\niwe.u.freq.e = 6;\r\nr = uf_iwe_stream_add_event(info, start_buf, end_buf, &iwe, IW_EV_FREQ_LEN);\r\nif (r < 0) {\r\nreturn r;\r\n}\r\nstart_buf += r;\r\niwe.cmd = IWEVQUAL;\r\nsignal = scan_data->rssi;\r\nsnr = (scan_data->snr > 0) ? scan_data->snr : 0;\r\nsnr = (snr < 255) ? snr : 255;\r\nnoise = signal - snr;\r\nsignal = (signal < 63) ? signal : 63;\r\nsignal = (signal > -192) ? signal : -192;\r\nnoise = (noise < 63) ? noise : 63;\r\nnoise = (noise > -192) ? noise : -192;\r\nsignal = ( signal < 0 ) ? signal + 0x100 : signal;\r\nnoise = ( noise < 0 ) ? noise + 0x100 : noise;\r\niwe.u.qual.level = (u8)signal;\r\niwe.u.qual.noise = (u8)noise;\r\niwe.u.qual.qual = snr;\r\niwe.u.qual.updated = 0;\r\n#if WIRELESS_EXT > 16\r\niwe.u.qual.updated |= IW_QUAL_LEVEL_UPDATED | IW_QUAL_NOISE_UPDATED |\r\nIW_QUAL_QUAL_UPDATED;\r\n#if WIRELESS_EXT > 18\r\niwe.u.qual.updated |= IW_QUAL_DBM;\r\n#endif\r\n#endif\r\nr = uf_iwe_stream_add_event(info, start_buf, end_buf, &iwe, IW_EV_QUAL_LEN);\r\nif (r < 0) {\r\nreturn r;\r\n}\r\nstart_buf += r;\r\niwe.cmd = SIOCGIWENCODE;\r\nif (capabilities & SIG_CAP_PRIVACY) {\r\niwe.u.data.flags = IW_ENCODE_ENABLED | IW_ENCODE_NOKEY;\r\n} else {\r\niwe.u.data.flags = IW_ENCODE_DISABLED;\r\n}\r\niwe.u.data.length = 0;\r\niwe.len = IW_EV_POINT_LEN + iwe.u.data.length;\r\nr = uf_iwe_stream_add_point(info, start_buf, end_buf, &iwe, "");\r\nif (r < 0) {\r\nreturn r;\r\n}\r\nstart_buf += r;\r\ncurrent_val = start_buf + IW_EV_LCP_LEN;\r\niwe.cmd = SIOCGIWRATE;\r\niwe.u.bitrate.fixed = iwe.u.bitrate.disabled = 0;\r\nelem = unifi_find_info_element(IE_SUPPORTED_RATES_ID,\r\ninfo_elems, info_elem_len);\r\nif (elem) {\r\nint e_len = elem[1];\r\nconst unsigned char *e_ptr = elem + 2;\r\nfor (i = 0; i < e_len; i++) {\r\nif (e_ptr[i] == 0) {\r\nbreak;\r\n}\r\niwe.u.bitrate.value = ((e_ptr[i] & 0x7f) * 500000);\r\nr = uf_iwe_stream_add_value(info, start_buf, current_val, end_buf, &iwe, IW_EV_PARAM_LEN);\r\nif (r < 0) {\r\nreturn r;\r\n}\r\ncurrent_val +=r;\r\n}\r\n}\r\nelem = unifi_find_info_element(IE_EXTENDED_SUPPORTED_RATES_ID,\r\ninfo_elems, info_elem_len);\r\nif (elem) {\r\nint e_len = elem[1];\r\nconst unsigned char *e_ptr = elem + 2;\r\nfor (i = 0; i < e_len; i++) {\r\nif (e_ptr[i] == 0) {\r\nbreak;\r\n}\r\niwe.u.bitrate.value = ((e_ptr[i] & 0x7f) * 500000);\r\nr = uf_iwe_stream_add_value(info, start_buf, current_val, end_buf, &iwe, IW_EV_PARAM_LEN);\r\nif (r < 0) {\r\nreturn r;\r\n}\r\ncurrent_val +=r;\r\n}\r\n}\r\nif ((current_val - start_buf) > IW_EV_LCP_LEN) {\r\nstart_buf = current_val;\r\n}\r\n#if WIRELESS_EXT > 17\r\nmemset(&iwe, 0, sizeof(iwe));\r\niwe.cmd = IWEVGENIE;\r\niwe.u.data.length = info_elem_len;\r\nr = uf_iwe_stream_add_point(info, start_buf, end_buf, &iwe, info_elems);\r\nif (r < 0) {\r\nreturn r;\r\n}\r\nstart_buf += r;\r\n#endif\r\nreturn (start_buf - current_ev);\r\n}\r\nstatic int\r\nunifi_giwscan(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nstruct iw_point *dwrq = &wrqu->data;\r\nint r;\r\nCHECK_INITED(priv);\r\nif(interfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_AP ||\r\ninterfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_P2PGO) {\r\nunifi_error(priv, "unifi_giwscan: not permitted in Mode %d\n",\r\ninterfacePriv->interfaceMode);\r\nreturn -EPERM;\r\n}\r\nunifi_trace(priv, UDBG1,\r\n"unifi_giwscan: buffer (%d bytes) \n",\r\ndwrq->length);\r\nUF_RTNL_UNLOCK();\r\nr = sme_mgt_scan_results_get_async(priv, info, extra, dwrq->length);\r\nUF_RTNL_LOCK();\r\nif (r < 0) {\r\nunifi_trace(priv, UDBG1,\r\n"unifi_giwscan: buffer (%d bytes) not big enough.\n",\r\ndwrq->length);\r\nreturn r;\r\n}\r\ndwrq->length = r;\r\ndwrq->flags = 0;\r\nreturn 0;\r\n}\r\nstatic int\r\nunifi_siwessid(struct net_device *dev, struct iw_request_info *info,\r\nstruct iw_point *data, char *essid)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nint len;\r\nint err = 0;\r\nCHECK_INITED(priv);\r\nif(interfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_AP ||\r\ninterfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_P2PGO) {\r\nunifi_error(priv, "unifi_siwessid: not permitted in Mode %d\n",\r\ninterfacePriv->interfaceMode);\r\nreturn -EPERM;\r\n}\r\nlen = 0;\r\nif (data->flags & 1) {\r\nlen = data->length;\r\nif (len > UNIFI_MAX_SSID_LEN) {\r\nlen = UNIFI_MAX_SSID_LEN;\r\n}\r\n}\r\n#ifdef UNIFI_DEBUG\r\n{\r\nchar essid_str[UNIFI_MAX_SSID_LEN+1];\r\nint i;\r\nfor (i = 0; i < len; i++) {\r\nessid_str[i] = (isprint(essid[i]) ? essid[i] : '?');\r\n}\r\nessid_str[i] = '\0';\r\nunifi_trace(priv, UDBG1, "unifi_siwessid: asked for '%*s' (%d)\n", len, essid_str, len);\r\nunifi_trace(priv, UDBG2, " with authModeMask = %d", priv->connection_config.authModeMask);\r\n}\r\n#endif\r\nmemset(priv->connection_config.bssid.a, 0xFF, ETH_ALEN);\r\nif (len) {\r\nif (essid[len - 1] == 0) {\r\nlen --;\r\n}\r\nmemcpy(priv->connection_config.ssid.ssid, essid, len);\r\npriv->connection_config.ssid.length = len;\r\n} else {\r\npriv->connection_config.ssid.length = 0;\r\n}\r\nUF_RTNL_UNLOCK();\r\nerr = sme_mgt_connect(priv);\r\nUF_RTNL_LOCK();\r\nif (err) {\r\nunifi_error(priv, "unifi_siwessid: Join failed, status %d\n", err);\r\nreturn convert_sme_error(err);\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nunifi_giwessid(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *essid)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nstruct iw_point *data = &wrqu->essid;\r\nCsrWifiSmeConnectionInfo connectionInfo;\r\nint r = 0;\r\nunifi_trace(priv, UDBG2, "unifi_giwessid\n");\r\nCHECK_INITED(priv);\r\nif(interfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_AP ||\r\ninterfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_P2PGO) {\r\nunifi_error(priv, "unifi_giwessid: not permitted in Mode %d\n",\r\ninterfacePriv->interfaceMode);\r\nreturn -EPERM;\r\n}\r\nUF_RTNL_UNLOCK();\r\nr = sme_mgt_connection_info_get(priv, &connectionInfo);\r\nUF_RTNL_LOCK();\r\nif (r == 0) {\r\ndata->length = connectionInfo.ssid.length;\r\nstrncpy(essid,\r\nconnectionInfo.ssid.ssid,\r\ndata->length);\r\ndata->flags = 1;\r\nunifi_trace(priv, UDBG2, "unifi_giwessid: %.*s\n",\r\ndata->length, essid);\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nunifi_siwrate(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nstruct iw_param *args = &wrqu->bitrate;\r\nCsrWifiSmeMibConfig mibConfig;\r\nint r;\r\nCHECK_INITED(priv);\r\nunifi_trace(priv, UDBG2, "unifi_siwrate\n");\r\nUF_RTNL_UNLOCK();\r\nr = sme_mgt_mib_config_get(priv, &mibConfig);\r\nUF_RTNL_LOCK();\r\nif (r) {\r\nunifi_error(priv, "unifi_siwrate: Get CsrWifiSmeMibConfigValue failed.\n");\r\nreturn r;\r\n}\r\nmibConfig.unifiFixTxDataRate = 0;\r\nif (args->value != -1) {\r\nmibConfig.unifiFixTxDataRate = args->value / 500000;\r\n}\r\nif (args->fixed == 1) {\r\nmibConfig.unifiFixMaxTxDataRate = 0;\r\n} else {\r\nmibConfig.unifiFixMaxTxDataRate = 1;\r\n}\r\nUF_RTNL_UNLOCK();\r\nr = sme_mgt_mib_config_set(priv, &mibConfig);\r\nUF_RTNL_LOCK();\r\nif (r) {\r\nunifi_error(priv, "unifi_siwrate: Set CsrWifiSmeMibConfigValue failed.\n");\r\nreturn r;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nunifi_giwrate(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nstruct iw_param *args = &wrqu->bitrate;\r\nint r;\r\nint bitrate, flag;\r\nCsrWifiSmeMibConfig mibConfig;\r\nCsrWifiSmeConnectionStats connectionStats;\r\nunifi_trace(priv, UDBG2, "unifi_giwrate\n");\r\nCHECK_INITED(priv);\r\nflag = 0;\r\nbitrate = 0;\r\nUF_RTNL_UNLOCK();\r\nr = sme_mgt_mib_config_get(priv, &mibConfig);\r\nUF_RTNL_LOCK();\r\nif (r) {\r\nunifi_error(priv, "unifi_giwrate: Get CsrWifiSmeMibConfigValue failed.\n");\r\nreturn r;\r\n}\r\nbitrate = mibConfig.unifiFixTxDataRate;\r\nflag = mibConfig.unifiFixMaxTxDataRate;\r\nif (bitrate == 0) {\r\nUF_RTNL_UNLOCK();\r\nr = sme_mgt_connection_stats_get(priv, &connectionStats);\r\nUF_RTNL_LOCK();\r\nif (r == 0) {\r\nbitrate = connectionStats.unifiTxDataRate;\r\n}\r\n}\r\nargs->value = bitrate * 500000;\r\nargs->fixed = !flag;\r\nreturn 0;\r\n}\r\nstatic int\r\nunifi_siwrts(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nint val = wrqu->rts.value;\r\nint r = 0;\r\nCsrWifiSmeMibConfig mibConfig;\r\nunifi_trace(priv, UDBG2, "unifi_siwrts\n");\r\nCHECK_INITED(priv);\r\nif (wrqu->rts.disabled) {\r\nval = 2347;\r\n}\r\nif ( (val < 0) || (val > 2347) )\r\n{\r\nreturn -EINVAL;\r\n}\r\nUF_RTNL_UNLOCK();\r\nr = sme_mgt_mib_config_get(priv, &mibConfig);\r\nUF_RTNL_LOCK();\r\nif (r) {\r\nunifi_error(priv, "unifi_siwrts: Get CsrWifiSmeMibConfigValue failed.\n");\r\nreturn r;\r\n}\r\nmibConfig.dot11RtsThreshold = val;\r\nUF_RTNL_UNLOCK();\r\nr = sme_mgt_mib_config_set(priv, &mibConfig);\r\nUF_RTNL_LOCK();\r\nif (r) {\r\nunifi_error(priv, "unifi_siwrts: Set CsrWifiSmeMibConfigValue failed.\n");\r\nreturn r;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nunifi_giwrts(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nint r;\r\nint rts_thresh;\r\nCsrWifiSmeMibConfig mibConfig;\r\nunifi_trace(priv, UDBG2, "unifi_giwrts\n");\r\nCHECK_INITED(priv);\r\nUF_RTNL_UNLOCK();\r\nr = sme_mgt_mib_config_get(priv, &mibConfig);\r\nUF_RTNL_LOCK();\r\nif (r) {\r\nunifi_error(priv, "unifi_giwrts: Get CsrWifiSmeMibConfigValue failed.\n");\r\nreturn r;\r\n}\r\nrts_thresh = mibConfig.dot11RtsThreshold;\r\nif (rts_thresh > 2347) {\r\nrts_thresh = 2347;\r\n}\r\nwrqu->rts.value = rts_thresh;\r\nwrqu->rts.disabled = (rts_thresh == 2347);\r\nwrqu->rts.fixed = 1;\r\nreturn 0;\r\n}\r\nstatic int\r\nunifi_siwfrag(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nint val = wrqu->frag.value;\r\nint r = 0;\r\nCsrWifiSmeMibConfig mibConfig;\r\nunifi_trace(priv, UDBG2, "unifi_siwfrag\n");\r\nCHECK_INITED(priv);\r\nif (wrqu->frag.disabled)\r\nval = 2346;\r\nif ( (val < 256) || (val > 2347) )\r\nreturn -EINVAL;\r\nUF_RTNL_UNLOCK();\r\nr = sme_mgt_mib_config_get(priv, &mibConfig);\r\nUF_RTNL_LOCK();\r\nif (r) {\r\nunifi_error(priv, "unifi_siwfrag: Get CsrWifiSmeMibConfigValue failed.\n");\r\nreturn r;\r\n}\r\nmibConfig.dot11FragmentationThreshold = (val & ~0x1);\r\nUF_RTNL_UNLOCK();\r\nr = sme_mgt_mib_config_set(priv, &mibConfig);\r\nUF_RTNL_LOCK();\r\nif (r) {\r\nunifi_error(priv, "unifi_siwfrag: Set CsrWifiSmeMibConfigValue failed.\n");\r\nreturn r;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nunifi_giwfrag(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nint r;\r\nint frag_thresh;\r\nCsrWifiSmeMibConfig mibConfig;\r\nunifi_trace(priv, UDBG2, "unifi_giwfrag\n");\r\nCHECK_INITED(priv);\r\nUF_RTNL_UNLOCK();\r\nr = sme_mgt_mib_config_get(priv, &mibConfig);\r\nUF_RTNL_LOCK();\r\nif (r) {\r\nunifi_error(priv, "unifi_giwfrag: Get CsrWifiSmeMibConfigValue failed.\n");\r\nreturn r;\r\n}\r\nfrag_thresh = mibConfig.dot11FragmentationThreshold;\r\nwrqu->frag.value = frag_thresh;\r\nwrqu->frag.disabled = (frag_thresh >= 2346);\r\nwrqu->frag.fixed = 1;\r\nreturn 0;\r\n}\r\nstatic int\r\nunifi_siwencode(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nstruct iw_point *erq = &wrqu->encoding;\r\nint index;\r\nint rc = 0;\r\nint privacy = -1;\r\nCsrWifiSmeKey sme_key;\r\nunifi_trace(priv, UDBG2, "unifi_siwencode\n");\r\nCHECK_INITED(priv);\r\nif(interfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_AP ||\r\ninterfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_P2PGO) {\r\nunifi_error(priv, "unifi_siwencode: not permitted in Mode %d\n",\r\ninterfacePriv->interfaceMode);\r\nreturn -EPERM;\r\n}\r\nindex = (erq->flags & IW_ENCODE_INDEX);\r\nif ((index < 0) || (index > 4)) {\r\nunifi_error(priv, "unifi_siwencode: Request to set an invalid key (index:%d)", index);\r\nreturn -EINVAL;\r\n}\r\nif (erq->length > 0) {\r\nif ((erq->length > LARGE_KEY_SIZE) || (erq->length < SMALL_KEY_SIZE)) {\r\nunifi_error(priv, "unifi_siwencode: Request to set an invalid key (length:%d)",\r\nerq->length);\r\nreturn -EINVAL;\r\n}\r\nif ((index < 1) || (index > 4)) {\r\nif (!priv->wep_tx_key_index) {\r\npriv->wep_tx_key_index = 1;\r\n}\r\nindex = priv->wep_tx_key_index;\r\n}\r\nif (!priv->wep_tx_key_index) {\r\npriv->wep_tx_key_index = index;\r\n}\r\nunifi_trace(priv, UDBG1, "Tx key Index is %d\n", priv->wep_tx_key_index);\r\nprivacy = 1;\r\nif ((erq->flags & IW_ENCODE_NOKEY) == 0) {\r\nunifi_trace(priv, UDBG1, "New %s key (len=%d, index=%d)\n",\r\n(priv->wep_tx_key_index == index) ? "tx" : "",\r\nerq->length, index);\r\nsme_key.wepTxKey = (priv->wep_tx_key_index == index);\r\nif (priv->wep_tx_key_index == index) {\r\nsme_key.keyType = CSR_WIFI_SME_KEY_TYPE_PAIRWISE;\r\n} else {\r\nsme_key.keyType = CSR_WIFI_SME_KEY_TYPE_GROUP;\r\n}\r\nsme_key.keyIndex = (index - 1);\r\nsme_key.keyLength = erq->length;\r\nsme_key.authenticator = 0;\r\nmemset(sme_key.address.a, 0xFF, ETH_ALEN);\r\nmemcpy(sme_key.key, extra, erq->length);\r\nUF_RTNL_UNLOCK();\r\nrc = sme_mgt_key(priv, &sme_key, CSR_WIFI_SME_LIST_ACTION_ADD);\r\nUF_RTNL_LOCK();\r\nif (rc) {\r\nunifi_error(priv, "unifi_siwencode: Set key failed (%d)", rc);\r\nreturn convert_sme_error(rc);\r\n}\r\npriv->wep_keys[index - 1].len = erq->length;\r\nmemcpy(priv->wep_keys[index - 1].key, extra, erq->length);\r\n}\r\n} else {\r\nif (index != 0) {\r\nunifi_trace(priv, UDBG1, "Tx key Index is %d\n", index - 1);\r\npriv->wep_tx_key_index = index;\r\nsme_key.wepTxKey = 1;\r\nsme_key.keyType = CSR_WIFI_SME_KEY_TYPE_PAIRWISE;\r\nsme_key.keyIndex = (index - 1);\r\nsme_key.keyLength = 0;\r\nsme_key.authenticator = 0;\r\nUF_RTNL_UNLOCK();\r\nrc = sme_mgt_key(priv, &sme_key, CSR_WIFI_SME_LIST_ACTION_ADD);\r\nUF_RTNL_LOCK();\r\nif (rc) {\r\nunifi_error(priv, "unifi_siwencode: Set key failed (%d)", rc);\r\nreturn convert_sme_error(rc);\r\n}\r\nprivacy = 1;\r\n}\r\n}\r\nif (erq->flags & IW_ENCODE_DISABLED) {\r\nunifi_trace(priv, UDBG1, "disable WEP encryption\n");\r\nprivacy = 0;\r\npriv->wep_tx_key_index = 0;\r\nunifi_trace(priv, UDBG1, "IW_ENCODE_DISABLED: CSR_WIFI_SME_AUTH_MODE_80211_OPEN\n");\r\npriv->connection_config.authModeMask = CSR_WIFI_SME_AUTH_MODE_80211_OPEN;\r\n}\r\nif (erq->flags & IW_ENCODE_RESTRICTED) {\r\nunifi_trace(priv, UDBG1, "IW_ENCODE_RESTRICTED: CSR_WIFI_SME_AUTH_MODE_80211_SHARED\n");\r\npriv->connection_config.authModeMask = CSR_WIFI_SME_AUTH_MODE_80211_SHARED;\r\nprivacy = 1;\r\n}\r\nif (erq->flags & IW_ENCODE_OPEN) {\r\nunifi_trace(priv, UDBG1, "IW_ENCODE_OPEN: CSR_WIFI_SME_AUTH_MODE_80211_OPEN\n");\r\npriv->connection_config.authModeMask = CSR_WIFI_SME_AUTH_MODE_80211_OPEN;\r\n}\r\nif (privacy != -1) {\r\npriv->connection_config.privacyMode = privacy ? CSR_WIFI_SME_80211_PRIVACY_MODE_ENABLED : CSR_WIFI_SME_80211_PRIVACY_MODE_DISABLED;\r\npriv->connection_config.encryptionModeMask = privacy ? (CSR_WIFI_SME_ENCRYPTION_CIPHER_PAIRWISE_WEP40 |\r\nCSR_WIFI_SME_ENCRYPTION_CIPHER_PAIRWISE_WEP104 |\r\nCSR_WIFI_SME_ENCRYPTION_CIPHER_GROUP_WEP40 |\r\nCSR_WIFI_SME_ENCRYPTION_CIPHER_GROUP_WEP104) :\r\nCSR_WIFI_SME_ENCRYPTION_CIPHER_NONE;\r\n}\r\nreturn convert_sme_error(rc);\r\n}\r\nstatic int\r\nunifi_giwencode(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nstruct iw_point *erq = &wrqu->encoding;\r\nunifi_trace(priv, UDBG2, "unifi_giwencode\n");\r\nCHECK_INITED(priv);\r\nif(interfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_AP ||\r\ninterfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_P2PGO) {\r\nunifi_error(priv, "unifi_giwencode: not permitted in Mode %d\n",\r\ninterfacePriv->interfaceMode);\r\nreturn -EPERM;\r\n}\r\nif (priv->connection_config.authModeMask == CSR_WIFI_SME_AUTH_MODE_80211_SHARED) {\r\nerq->flags = IW_ENCODE_RESTRICTED;\r\n}\r\nelse {\r\nif (priv->connection_config.privacyMode == CSR_WIFI_SME_80211_PRIVACY_MODE_DISABLED) {\r\nerq->flags = IW_ENCODE_DISABLED;\r\n} else {\r\nerq->flags = IW_ENCODE_OPEN;\r\n}\r\n}\r\nerq->length = 0;\r\nif (erq->flags != IW_ENCODE_DISABLED) {\r\nint index = priv->wep_tx_key_index;\r\nif ((index > 0) && (index <= NUM_WEPKEYS)) {\r\nerq->flags |= (index & IW_ENCODE_INDEX);\r\nerq->length = priv->wep_keys[index - 1].len;\r\nmemcpy(extra, priv->wep_keys[index - 1].key, erq->length);\r\n} else {\r\nunifi_notice(priv, "unifi_giwencode: Surprise, do not have a valid key index (%d)\n",\r\nindex);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nunifi_siwpower(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct iw_param *args = &wrqu->power;\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nint listen_interval, wake_for_dtim;\r\nint r = 0;\r\nCsrWifiSmePowerConfig powerConfig;\r\nunifi_trace(priv, UDBG2, "unifi_siwpower\n");\r\nCHECK_INITED(priv);\r\nif(interfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_AP ||\r\ninterfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_P2PGO) {\r\nunifi_error(priv, "unifi_siwpower: not permitted in Mode %d\n",\r\ninterfacePriv->interfaceMode);\r\nreturn -EPERM;\r\n}\r\nUF_RTNL_UNLOCK();\r\nr = sme_mgt_power_config_get(priv, &powerConfig);\r\nUF_RTNL_LOCK();\r\nif (r) {\r\nunifi_error(priv, "unifi_siwpower: Get unifi_PowerConfigValue failed.\n");\r\nreturn r;\r\n}\r\nlisten_interval = -1;\r\nwake_for_dtim = -1;\r\nif (args->disabled) {\r\npowerConfig.powerSaveLevel = CSR_WIFI_SME_POWER_SAVE_LEVEL_LOW;\r\n}\r\nelse\r\n{\r\npowerConfig.powerSaveLevel = CSR_WIFI_SME_POWER_SAVE_LEVEL_HIGH;\r\nswitch (args->flags & IW_POWER_TYPE) {\r\ncase 0:\r\nbreak;\r\ncase IW_POWER_PERIOD:\r\nlisten_interval = args->value / 1000;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (args->flags & IW_POWER_MODE) {\r\ncase 0:\r\nbreak;\r\ncase IW_POWER_UNICAST_R:\r\nwake_for_dtim = 0;\r\nbreak;\r\ncase IW_POWER_ALL_R:\r\nwake_for_dtim = 1;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nif (listen_interval > 0) {\r\npowerConfig.listenIntervalTu = listen_interval;\r\nunifi_trace(priv, UDBG4, "unifi_siwpower: new Listen Interval = %d.\n",\r\npowerConfig.listenIntervalTu);\r\n}\r\nif (wake_for_dtim >= 0) {\r\npowerConfig.rxDtims = wake_for_dtim;\r\n}\r\nUF_RTNL_UNLOCK();\r\nr = sme_mgt_power_config_set(priv, &powerConfig);\r\nUF_RTNL_LOCK();\r\nif (r) {\r\nunifi_error(priv, "unifi_siwpower: Set unifi_PowerConfigValue failed.\n");\r\nreturn r;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nunifi_giwpower(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nstruct iw_param *args = &wrqu->power;\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nCsrWifiSmePowerConfig powerConfig;\r\nint r;\r\nunifi_trace(priv, UDBG2, "unifi_giwpower\n");\r\nCHECK_INITED(priv);\r\nif(interfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_AP ||\r\ninterfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_P2PGO) {\r\nunifi_error(priv, "unifi_giwpower: not permitted in Mode %d\n",\r\ninterfacePriv->interfaceMode);\r\nreturn -EPERM;\r\n}\r\nargs->flags = 0;\r\nUF_RTNL_UNLOCK();\r\nr = sme_mgt_power_config_get(priv, &powerConfig);\r\nUF_RTNL_LOCK();\r\nif (r) {\r\nunifi_error(priv, "unifi_giwpower: Get unifi_PowerConfigValue failed.\n");\r\nreturn r;\r\n}\r\nunifi_trace(priv, UDBG4, "unifi_giwpower: mode=%d\n",\r\npowerConfig.powerSaveLevel);\r\nargs->disabled = (powerConfig.powerSaveLevel == CSR_WIFI_SME_POWER_SAVE_LEVEL_LOW);\r\nif (args->disabled) {\r\nargs->flags = 0;\r\nreturn 0;\r\n}\r\nargs->value = powerConfig.listenIntervalTu * 1000;\r\nargs->flags |= IW_POWER_PERIOD;\r\nif (powerConfig.rxDtims) {\r\nargs->flags |= IW_POWER_ALL_R;\r\n} else {\r\nargs->flags |= IW_POWER_UNICAST_R;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nunifi_siwcommit(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nreturn 0;\r\n}\r\nstatic int\r\nunifi_siwmlme(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nstruct iw_mlme *mlme = (struct iw_mlme *)extra;\r\nunifi_trace(priv, UDBG2, "unifi_siwmlme\n");\r\nCHECK_INITED(priv);\r\nif(interfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_AP ||\r\ninterfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_P2PGO) {\r\nunifi_error(priv, "unifi_siwmlme: not permitted in Mode %d\n",\r\ninterfacePriv->interfaceMode);\r\nreturn -EPERM;\r\n}\r\nswitch (mlme->cmd) {\r\ncase IW_MLME_DEAUTH:\r\ncase IW_MLME_DISASSOC:\r\nUF_RTNL_UNLOCK();\r\nsme_mgt_disconnect(priv);\r\nUF_RTNL_LOCK();\r\nbreak;\r\ndefault:\r\nreturn -EOPNOTSUPP;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nunifi_siwgenie(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nint len;\r\nunifi_trace(priv, UDBG2, "unifi_siwgenie\n");\r\nif(interfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_AP ||\r\ninterfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_P2PGO) {\r\nunifi_error(priv, "unifi_siwgenie: not permitted in Mode %d\n",\r\ninterfacePriv->interfaceMode);\r\nreturn -EPERM;\r\n}\r\nif ( priv->connection_config.mlmeAssociateReqInformationElements) {\r\nkfree( priv->connection_config.mlmeAssociateReqInformationElements);\r\n}\r\npriv->connection_config.mlmeAssociateReqInformationElementsLength = 0;\r\npriv->connection_config.mlmeAssociateReqInformationElements = NULL;\r\nlen = wrqu->data.length;\r\nif (len == 0) {\r\nreturn 0;\r\n}\r\npriv->connection_config.mlmeAssociateReqInformationElements = kmalloc(len, GFP_KERNEL);\r\nif (priv->connection_config.mlmeAssociateReqInformationElements == NULL) {\r\nreturn -ENOMEM;\r\n}\r\npriv->connection_config.mlmeAssociateReqInformationElementsLength = len;\r\nmemcpy( priv->connection_config.mlmeAssociateReqInformationElements, extra, len);\r\nreturn 0;\r\n}\r\nstatic int\r\nunifi_giwgenie(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nint len;\r\nunifi_trace(priv, UDBG2, "unifi_giwgenie\n");\r\nif(interfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_AP ||\r\ninterfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_P2PGO) {\r\nunifi_error(priv, "unifi_giwgenie: not permitted in Mode %d\n",\r\ninterfacePriv->interfaceMode);\r\nreturn -EPERM;\r\n}\r\nlen = priv->connection_config.mlmeAssociateReqInformationElementsLength;\r\nif (len == 0) {\r\nwrqu->data.length = 0;\r\nreturn 0;\r\n}\r\nif (wrqu->data.length < len) {\r\nreturn -E2BIG;\r\n}\r\nwrqu->data.length = len;\r\nmemcpy(extra, priv->connection_config.mlmeAssociateReqInformationElements, len);\r\nreturn 0;\r\n}\r\nstatic int\r\n_unifi_siwauth(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nCsrWifiSmeAuthModeMask new_auth;\r\nunifi_trace(priv, UDBG2, "unifi_siwauth\n");\r\nif(interfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_AP ||\r\ninterfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_P2PGO) {\r\nunifi_error(priv, "unifi_siwauth: not permitted in Mode %d\n",\r\ninterfacePriv->interfaceMode);\r\nreturn -EPERM;\r\n}\r\nswitch (wrqu->param.flags & IW_AUTH_INDEX) {\r\ncase IW_AUTH_WPA_ENABLED:\r\nunifi_trace(priv, UDBG1, "IW_AUTH_WPA_ENABLED: %d\n", wrqu->param.value);\r\nif (wrqu->param.value == 0) {\r\nunifi_trace(priv, UDBG5, "IW_AUTH_WPA_ENABLED: CSR_WIFI_SME_AUTH_MODE_80211_OPEN\n");\r\npriv->connection_config.authModeMask = CSR_WIFI_SME_AUTH_MODE_80211_OPEN;\r\n}\r\nbreak;\r\ncase IW_AUTH_PRIVACY_INVOKED:\r\nunifi_trace(priv, UDBG1, "IW_AUTH_PRIVACY_INVOKED: %d\n", wrqu->param.value);\r\npriv->connection_config.privacyMode = wrqu->param.value ? CSR_WIFI_SME_80211_PRIVACY_MODE_ENABLED : CSR_WIFI_SME_80211_PRIVACY_MODE_DISABLED;\r\nif (wrqu->param.value == CSR_WIFI_SME_80211_PRIVACY_MODE_DISABLED)\r\n{\r\npriv->connection_config.encryptionModeMask = CSR_WIFI_SME_ENCRYPTION_CIPHER_NONE;\r\n}\r\nbreak;\r\ncase IW_AUTH_80211_AUTH_ALG:\r\nnew_auth = 0;\r\nif (wrqu->param.value & IW_AUTH_ALG_OPEN_SYSTEM) {\r\nunifi_trace(priv, UDBG1, "IW_AUTH_80211_AUTH_ALG: %d (IW_AUTH_ALG_OPEN_SYSTEM)\n", wrqu->param.value);\r\nnew_auth |= CSR_WIFI_SME_AUTH_MODE_80211_OPEN;\r\n}\r\nif (wrqu->param.value & IW_AUTH_ALG_SHARED_KEY) {\r\nunifi_trace(priv, UDBG1, "IW_AUTH_80211_AUTH_ALG: %d (IW_AUTH_ALG_SHARED_KEY)\n", wrqu->param.value);\r\nnew_auth |= CSR_WIFI_SME_AUTH_MODE_80211_SHARED;\r\n}\r\nif (wrqu->param.value & IW_AUTH_ALG_LEAP) {\r\nunifi_trace(priv, UDBG1, "IW_AUTH_80211_AUTH_ALG: %d (IW_AUTH_ALG_LEAP)\n", wrqu->param.value);\r\nnew_auth |= CSR_WIFI_SME_AUTH_MODE_8021X_OTHER1X;\r\n}\r\nif (new_auth == 0) {\r\nunifi_trace(priv, UDBG1, "IW_AUTH_80211_AUTH_ALG: invalid value %d\n",\r\nwrqu->param.value);\r\nreturn -EINVAL;\r\n} else {\r\npriv->connection_config.authModeMask = new_auth;\r\n}\r\nbreak;\r\ncase IW_AUTH_WPA_VERSION:\r\nunifi_trace(priv, UDBG1, "IW_AUTH_WPA_VERSION: %d\n", wrqu->param.value);\r\npriv->ignore_bssid_join = TRUE;\r\nif (!(wrqu->param.value & IW_AUTH_WPA_VERSION_DISABLED)) {\r\npriv->connection_config.authModeMask = CSR_WIFI_SME_AUTH_MODE_80211_OPEN;\r\nif (wrqu->param.value & IW_AUTH_WPA_VERSION_WPA) {\r\nunifi_trace(priv, UDBG4, "IW_AUTH_WPA_VERSION: WPA, WPA-PSK\n");\r\npriv->connection_config.authModeMask |= (CSR_WIFI_SME_AUTH_MODE_8021X_WPA | CSR_WIFI_SME_AUTH_MODE_8021X_WPAPSK);\r\n}\r\nif (wrqu->param.value & IW_AUTH_WPA_VERSION_WPA2) {\r\nunifi_trace(priv, UDBG4, "IW_AUTH_WPA_VERSION: WPA2, WPA2-PSK\n");\r\npriv->connection_config.authModeMask |= (CSR_WIFI_SME_AUTH_MODE_8021X_WPA2 | CSR_WIFI_SME_AUTH_MODE_8021X_WPA2PSK);\r\n}\r\n}\r\nbreak;\r\ncase IW_AUTH_CIPHER_PAIRWISE:\r\nunifi_trace(priv, UDBG1, "IW_AUTH_CIPHER_PAIRWISE: %d\n", wrqu->param.value);\r\npriv->connection_config.encryptionModeMask = CSR_WIFI_SME_ENCRYPTION_CIPHER_NONE;\r\nif (wrqu->param.value & IW_AUTH_CIPHER_WEP40) {\r\npriv->connection_config.encryptionModeMask |=\r\nCSR_WIFI_SME_ENCRYPTION_CIPHER_PAIRWISE_WEP40 | CSR_WIFI_SME_ENCRYPTION_CIPHER_GROUP_WEP40;\r\n}\r\nif (wrqu->param.value & IW_AUTH_CIPHER_WEP104) {\r\npriv->connection_config.encryptionModeMask |=\r\nCSR_WIFI_SME_ENCRYPTION_CIPHER_PAIRWISE_WEP104 | CSR_WIFI_SME_ENCRYPTION_CIPHER_GROUP_WEP104;\r\n}\r\nif (wrqu->param.value & IW_AUTH_CIPHER_TKIP) {\r\npriv->connection_config.encryptionModeMask |=\r\nCSR_WIFI_SME_ENCRYPTION_CIPHER_PAIRWISE_TKIP | CSR_WIFI_SME_ENCRYPTION_CIPHER_GROUP_TKIP;\r\n}\r\nif (wrqu->param.value & IW_AUTH_CIPHER_CCMP) {\r\npriv->connection_config.encryptionModeMask |=\r\nCSR_WIFI_SME_ENCRYPTION_CIPHER_PAIRWISE_CCMP | CSR_WIFI_SME_ENCRYPTION_CIPHER_GROUP_CCMP;\r\n}\r\nbreak;\r\ncase IW_AUTH_CIPHER_GROUP:\r\nunifi_trace(priv, UDBG1, "IW_AUTH_CIPHER_GROUP: %d\n", wrqu->param.value);\r\npriv->connection_config.encryptionModeMask &= ~(CSR_WIFI_SME_ENCRYPTION_CIPHER_GROUP_WEP40 |\r\nCSR_WIFI_SME_ENCRYPTION_CIPHER_GROUP_WEP104 |\r\nCSR_WIFI_SME_ENCRYPTION_CIPHER_GROUP_TKIP |\r\nCSR_WIFI_SME_ENCRYPTION_CIPHER_GROUP_CCMP);\r\nif (wrqu->param.value & IW_AUTH_CIPHER_WEP40) {\r\npriv->connection_config.encryptionModeMask |= CSR_WIFI_SME_ENCRYPTION_CIPHER_GROUP_WEP40;\r\n}\r\nif (wrqu->param.value & IW_AUTH_CIPHER_WEP104) {\r\npriv->connection_config.encryptionModeMask |= CSR_WIFI_SME_ENCRYPTION_CIPHER_GROUP_WEP104;\r\n}\r\nif (wrqu->param.value & IW_AUTH_CIPHER_TKIP) {\r\npriv->connection_config.encryptionModeMask |= CSR_WIFI_SME_ENCRYPTION_CIPHER_GROUP_TKIP;\r\n}\r\nif (wrqu->param.value & IW_AUTH_CIPHER_CCMP) {\r\npriv->connection_config.encryptionModeMask |= CSR_WIFI_SME_ENCRYPTION_CIPHER_GROUP_CCMP;\r\n}\r\nbreak;\r\ncase IW_AUTH_KEY_MGMT:\r\nunifi_trace(priv, UDBG1, "IW_AUTH_KEY_MGMT: %d\n", wrqu->param.value);\r\nif (priv->connection_config.authModeMask & (CSR_WIFI_SME_AUTH_MODE_8021X_WPA | CSR_WIFI_SME_AUTH_MODE_8021X_WPAPSK)) {\r\nif (wrqu->param.value == IW_AUTH_KEY_MGMT_802_1X) {\r\npriv->connection_config.authModeMask &= ~CSR_WIFI_SME_AUTH_MODE_8021X_WPAPSK;\r\n}\r\nif (wrqu->param.value == IW_AUTH_KEY_MGMT_PSK) {\r\npriv->connection_config.authModeMask &= ~CSR_WIFI_SME_AUTH_MODE_8021X_WPA;\r\n}\r\nunifi_trace(priv, UDBG5, "IW_AUTH_KEY_MGMT: WPA: %d\n",\r\npriv->connection_config.authModeMask);\r\n}\r\nif (priv->connection_config.authModeMask & (CSR_WIFI_SME_AUTH_MODE_8021X_WPA2 | CSR_WIFI_SME_AUTH_MODE_8021X_WPA2PSK)) {\r\nif (wrqu->param.value == IW_AUTH_KEY_MGMT_802_1X) {\r\npriv->connection_config.authModeMask &= ~CSR_WIFI_SME_AUTH_MODE_8021X_WPA2PSK;\r\n}\r\nif (wrqu->param.value == IW_AUTH_KEY_MGMT_PSK) {\r\npriv->connection_config.authModeMask &= ~CSR_WIFI_SME_AUTH_MODE_8021X_WPA2;\r\n}\r\nunifi_trace(priv, UDBG5, "IW_AUTH_KEY_MGMT: WPA2: %d\n",\r\npriv->connection_config.authModeMask);\r\n}\r\nbreak;\r\ncase IW_AUTH_TKIP_COUNTERMEASURES:\r\nunifi_trace(priv, UDBG1, "IW_AUTH_TKIP_COUNTERMEASURES: %d\n", wrqu->param.value);\r\nbreak;\r\ncase IW_AUTH_DROP_UNENCRYPTED:\r\nunifi_trace(priv, UDBG1, "IW_AUTH_DROP_UNENCRYPTED: %d\n", wrqu->param.value);\r\nbreak;\r\ncase IW_AUTH_RX_UNENCRYPTED_EAPOL:\r\nunifi_trace(priv, UDBG1, "IW_AUTH_RX_UNENCRYPTED_EAPOL: %d\n", wrqu->param.value);\r\nbreak;\r\ncase IW_AUTH_ROAMING_CONTROL:\r\nunifi_trace(priv, UDBG1, "IW_AUTH_ROAMING_CONTROL: %d\n", wrqu->param.value);\r\nbreak;\r\ndefault:\r\nunifi_trace(priv, UDBG1, "Unsupported auth param %d to 0x%X\n",\r\nwrqu->param.flags & IW_AUTH_INDEX,\r\nwrqu->param.value);\r\nreturn -EOPNOTSUPP;\r\n}\r\nunifi_trace(priv, UDBG2, "authModeMask = %d", priv->connection_config.authModeMask);\r\nreturn 0;\r\n}\r\nstatic int\r\nunifi_siwauth(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nint err = 0;\r\nUF_RTNL_UNLOCK();\r\nerr = _unifi_siwauth(dev, info, wrqu, extra);\r\nUF_RTNL_LOCK();\r\nreturn err;\r\n}\r\nstatic int\r\nunifi_giwauth(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nunifi_trace(NULL, UDBG2, "unifi_giwauth\n");\r\nreturn -EOPNOTSUPP;\r\n}\r\nstatic int\r\n_unifi_siwencodeext(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nstruct iw_encode_ext *ext = (struct iw_encode_ext *)extra;\r\nint r = 0;\r\nunsigned char *keydata;\r\nunsigned char tkip_key[32];\r\nint keyid;\r\nunsigned char *a = (unsigned char *)ext->addr.sa_data;\r\nCsrWifiSmeKey sme_key;\r\nCsrWifiSmeKeyType key_type;\r\nCHECK_INITED(priv);\r\nif(interfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_AP ||\r\ninterfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_P2PGO) {\r\nunifi_error(priv, "unifi_siwencodeext: not permitted in Mode %d\n",\r\ninterfacePriv->interfaceMode);\r\nreturn -EPERM;\r\n}\r\nunifi_trace(priv, UDBG1, "siwencodeext: flags=0x%X, alg=%d, ext_flags=0x%X, len=%d, index=%d,\n",\r\nwrqu->encoding.flags, ext->alg, ext->ext_flags,\r\next->key_len, (wrqu->encoding.flags & IW_ENCODE_INDEX));\r\nunifi_trace(priv, UDBG3, " addr=%pM\n", a);\r\nif ((ext->key_len == 0) && (ext->ext_flags & IW_ENCODE_EXT_SET_TX_KEY)) {\r\nunifi_trace(priv, UDBG1, KERN_ERR "unifi_siwencodeext: NYI should change tx key id here!!\n");\r\nreturn -ENOTSUPP;\r\n}\r\nmemset(&sme_key, 0, sizeof(sme_key));\r\nkeydata = (unsigned char *)(ext + 1);\r\nkeyid = (wrqu->encoding.flags & IW_ENCODE_INDEX);\r\nif (ext->alg == IW_ENCODE_ALG_NONE) {\r\nunifi_trace(priv, UDBG1, "Deleting %s key %d\n",\r\n(ext->ext_flags & IW_ENCODE_EXT_GROUP_KEY) ? "GROUP" : "PAIRWISE",\r\nkeyid);\r\nif (ext->ext_flags & IW_ENCODE_EXT_GROUP_KEY) {\r\nsme_key.keyType = CSR_WIFI_SME_KEY_TYPE_GROUP;\r\n} else {\r\nsme_key.keyType = CSR_WIFI_SME_KEY_TYPE_PAIRWISE;\r\n}\r\nsme_key.keyIndex = (keyid - 1);\r\nsme_key.keyLength = 0;\r\nsme_key.authenticator = 0;\r\nmemcpy(sme_key.address.a, a, ETH_ALEN);\r\nUF_RTNL_UNLOCK();\r\nr = sme_mgt_key(priv, &sme_key, CSR_WIFI_SME_LIST_ACTION_REMOVE);\r\nUF_RTNL_LOCK();\r\nif (r) {\r\nunifi_error(priv, "Delete key request was rejected with result %d\n", r);\r\nreturn convert_sme_error(r);\r\n}\r\nreturn 0;\r\n}\r\nif (ext->alg == IW_ENCODE_ALG_WEP) {\r\nif (!((ext->key_len == 5) || (ext->key_len == 13))) {\r\nunifi_trace(priv, UDBG1, KERN_ERR "Invalid length for WEP key: %d\n", ext->key_len);\r\nreturn -EINVAL;\r\n}\r\nunifi_trace(priv, UDBG1, "Setting WEP key %d tx:%d\n",\r\nkeyid, ext->ext_flags & IW_ENCODE_EXT_SET_TX_KEY);\r\nif (ext->ext_flags & IW_ENCODE_EXT_SET_TX_KEY) {\r\nsme_key.wepTxKey = TRUE;\r\nsme_key.keyType = CSR_WIFI_SME_KEY_TYPE_PAIRWISE;\r\n} else {\r\nsme_key.wepTxKey = FALSE;\r\nsme_key.keyType = CSR_WIFI_SME_KEY_TYPE_GROUP;\r\n}\r\nsme_key.keyIndex = (keyid - 1);\r\nsme_key.keyLength = ext->key_len;\r\nsme_key.authenticator = 0;\r\nmemset(sme_key.address.a, 0xFF, ETH_ALEN);\r\nmemcpy(sme_key.key, keydata, ext->key_len);\r\nUF_RTNL_UNLOCK();\r\nr = sme_mgt_key(priv, &sme_key, CSR_WIFI_SME_LIST_ACTION_ADD);\r\nUF_RTNL_LOCK();\r\nif (r) {\r\nunifi_error(priv, "siwencodeext: Set key failed (%d)", r);\r\nreturn convert_sme_error(r);\r\n}\r\nreturn 0;\r\n}\r\nif (ext->key_len > 32) {\r\nreturn -EINVAL;\r\n}\r\nif ((ext->alg == IW_ENCODE_ALG_TKIP) && (ext->key_len == 32)) {\r\nmemcpy(tkip_key, keydata, 16);\r\nmemcpy(tkip_key + 16, keydata + 24, 8);\r\nmemcpy(tkip_key + 24, keydata + 16, 8);\r\nkeydata = tkip_key;\r\n}\r\nkey_type = (ext->ext_flags & IW_ENCODE_EXT_GROUP_KEY) ?\r\nCSR_WIFI_SME_KEY_TYPE_GROUP :\r\nCSR_WIFI_SME_KEY_TYPE_PAIRWISE;\r\nsme_key.keyType = key_type;\r\nsme_key.keyIndex = (keyid - 1);\r\nsme_key.keyLength = ext->key_len;\r\nsme_key.authenticator = 0;\r\nmemcpy(sme_key.address.a, ext->addr.sa_data, ETH_ALEN);\r\nif (ext->ext_flags & IW_ENCODE_EXT_RX_SEQ_VALID) {\r\nunifi_trace(priv, UDBG5, "RSC first 6 bytes = %*phC\n",\r\n6, ext->rx_seq);\r\nsme_key.keyRsc[0] = ext->rx_seq[1] << 8 | ext->rx_seq[0];\r\nsme_key.keyRsc[1] = ext->rx_seq[3] << 8 | ext->rx_seq[2];\r\nsme_key.keyRsc[2] = ext->rx_seq[5] << 8 | ext->rx_seq[4];\r\nsme_key.keyRsc[3] = ext->rx_seq[7] << 8 | ext->rx_seq[6];\r\n}\r\nmemcpy(sme_key.key, keydata, ext->key_len);\r\nUF_RTNL_UNLOCK();\r\nr = sme_mgt_key(priv, &sme_key, CSR_WIFI_SME_LIST_ACTION_ADD);\r\nUF_RTNL_LOCK();\r\nif (r) {\r\nunifi_error(priv, "SETKEYS request was rejected with result %d\n", r);\r\nreturn convert_sme_error(r);\r\n}\r\nreturn r;\r\n}\r\nstatic int\r\nunifi_siwencodeext(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nint err = 0;\r\nerr = _unifi_siwencodeext(dev, info, wrqu, extra);\r\nreturn err;\r\n}\r\nstatic int\r\nunifi_giwencodeext(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nreturn -EOPNOTSUPP;\r\n}\r\nstatic int\r\nunifi_siwpmksa(struct net_device *dev, struct iw_request_info *info,\r\nunion iwreq_data *wrqu, char *extra)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nstruct iw_pmksa *pmksa = (struct iw_pmksa *)extra;\r\nCsrResult r = 0;\r\nCsrWifiSmePmkidList pmkid_list;\r\nCsrWifiSmePmkid pmkid;\r\nCsrWifiSmeListAction action;\r\nCHECK_INITED(priv);\r\nif(interfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_AP ||\r\ninterfacePriv->interfaceMode == CSR_WIFI_ROUTER_CTRL_MODE_P2PGO) {\r\nunifi_error(priv, "unifi_siwpmksa: not permitted in Mode %d\n",\r\ninterfacePriv->interfaceMode);\r\nreturn -EPERM;\r\n}\r\nunifi_trace(priv, UDBG1, "SIWPMKSA: cmd %d, %pM\n", pmksa->cmd,\r\npmksa->bssid.sa_data);\r\npmkid_list.pmkids = NULL;\r\nswitch (pmksa->cmd) {\r\ncase IW_PMKSA_ADD:\r\npmkid_list.pmkids = &pmkid;\r\naction = CSR_WIFI_SME_LIST_ACTION_ADD;\r\npmkid_list.pmkidsCount = 1;\r\nmemcpy(pmkid.bssid.a, pmksa->bssid.sa_data, ETH_ALEN);\r\nmemcpy(pmkid.pmkid, pmksa->pmkid, UNIFI_PMKID_KEY_SIZE);\r\nbreak;\r\ncase IW_PMKSA_REMOVE:\r\npmkid_list.pmkids = &pmkid;\r\naction = CSR_WIFI_SME_LIST_ACTION_REMOVE;\r\npmkid_list.pmkidsCount = 1;\r\nmemcpy(pmkid.bssid.a, pmksa->bssid.sa_data, ETH_ALEN);\r\nmemcpy(pmkid.pmkid, pmksa->pmkid, UNIFI_PMKID_KEY_SIZE);\r\nbreak;\r\ncase IW_PMKSA_FLUSH:\r\npmkid_list.pmkidsCount = 0;\r\naction = CSR_WIFI_SME_LIST_ACTION_FLUSH;\r\nbreak;\r\ndefault:\r\nunifi_notice(priv, "SIWPMKSA: Unknown command (0x%x)\n", pmksa->cmd);\r\nreturn -EINVAL;\r\n}\r\nUF_RTNL_UNLOCK();\r\nr = sme_mgt_pmkid(priv, action, &pmkid_list);\r\nUF_RTNL_LOCK();\r\nif (r) {\r\nunifi_error(priv, "SIWPMKSA: Set PMKID's Failed.\n");\r\n}\r\nreturn r;\r\n}\r\nstruct iw_statistics *\r\nunifi_get_wireless_stats(struct net_device *dev)\r\n{\r\nnetInterface_priv_t *interfacePriv = (netInterface_priv_t *)netdev_priv(dev);\r\nunifi_priv_t *priv = interfacePriv->privPtr;\r\nif (priv->init_progress != UNIFI_INIT_COMPLETED) {\r\nreturn NULL;\r\n}\r\nreturn &priv->wext_wireless_stats;\r\n}

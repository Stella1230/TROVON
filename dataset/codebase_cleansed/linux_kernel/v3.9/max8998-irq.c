static inline struct max8998_irq_data *\r\nirq_to_max8998_irq(struct max8998_dev *max8998, int irq)\r\n{\r\nreturn &max8998_irqs[irq - max8998->irq_base];\r\n}\r\nstatic void max8998_irq_lock(struct irq_data *data)\r\n{\r\nstruct max8998_dev *max8998 = irq_data_get_irq_chip_data(data);\r\nmutex_lock(&max8998->irqlock);\r\n}\r\nstatic void max8998_irq_sync_unlock(struct irq_data *data)\r\n{\r\nstruct max8998_dev *max8998 = irq_data_get_irq_chip_data(data);\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(max8998->irq_masks_cur); i++) {\r\nif (max8998->irq_masks_cur[i] != max8998->irq_masks_cache[i]) {\r\nmax8998->irq_masks_cache[i] = max8998->irq_masks_cur[i];\r\nmax8998_write_reg(max8998->i2c, MAX8998_REG_IRQM1 + i,\r\nmax8998->irq_masks_cur[i]);\r\n}\r\n}\r\nmutex_unlock(&max8998->irqlock);\r\n}\r\nstatic void max8998_irq_unmask(struct irq_data *data)\r\n{\r\nstruct max8998_dev *max8998 = irq_data_get_irq_chip_data(data);\r\nstruct max8998_irq_data *irq_data = irq_to_max8998_irq(max8998,\r\ndata->irq);\r\nmax8998->irq_masks_cur[irq_data->reg - 1] &= ~irq_data->mask;\r\n}\r\nstatic void max8998_irq_mask(struct irq_data *data)\r\n{\r\nstruct max8998_dev *max8998 = irq_data_get_irq_chip_data(data);\r\nstruct max8998_irq_data *irq_data = irq_to_max8998_irq(max8998,\r\ndata->irq);\r\nmax8998->irq_masks_cur[irq_data->reg - 1] |= irq_data->mask;\r\n}\r\nstatic irqreturn_t max8998_irq_thread(int irq, void *data)\r\n{\r\nstruct max8998_dev *max8998 = data;\r\nu8 irq_reg[MAX8998_NUM_IRQ_REGS];\r\nint ret;\r\nint i;\r\nret = max8998_bulk_read(max8998->i2c, MAX8998_REG_IRQ1,\r\nMAX8998_NUM_IRQ_REGS, irq_reg);\r\nif (ret < 0) {\r\ndev_err(max8998->dev, "Failed to read interrupt register: %d\n",\r\nret);\r\nreturn IRQ_NONE;\r\n}\r\nfor (i = 0; i < MAX8998_NUM_IRQ_REGS; i++)\r\nirq_reg[i] &= ~max8998->irq_masks_cur[i];\r\nfor (i = 0; i < MAX8998_IRQ_NR; i++) {\r\nif (irq_reg[max8998_irqs[i].reg - 1] & max8998_irqs[i].mask)\r\nhandle_nested_irq(max8998->irq_base + i);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nint max8998_irq_resume(struct max8998_dev *max8998)\r\n{\r\nif (max8998->irq && max8998->irq_base)\r\nmax8998_irq_thread(max8998->irq_base, max8998);\r\nreturn 0;\r\n}\r\nint max8998_irq_init(struct max8998_dev *max8998)\r\n{\r\nint i;\r\nint cur_irq;\r\nint ret;\r\nif (!max8998->irq) {\r\ndev_warn(max8998->dev,\r\n"No interrupt specified, no interrupts\n");\r\nmax8998->irq_base = 0;\r\nreturn 0;\r\n}\r\nif (!max8998->irq_base) {\r\ndev_err(max8998->dev,\r\n"No interrupt base specified, no interrupts\n");\r\nreturn 0;\r\n}\r\nmutex_init(&max8998->irqlock);\r\nfor (i = 0; i < MAX8998_NUM_IRQ_REGS; i++) {\r\nmax8998->irq_masks_cur[i] = 0xff;\r\nmax8998->irq_masks_cache[i] = 0xff;\r\nmax8998_write_reg(max8998->i2c, MAX8998_REG_IRQM1 + i, 0xff);\r\n}\r\nmax8998_write_reg(max8998->i2c, MAX8998_REG_STATUSM1, 0xff);\r\nmax8998_write_reg(max8998->i2c, MAX8998_REG_STATUSM2, 0xff);\r\nfor (i = 0; i < MAX8998_IRQ_NR; i++) {\r\ncur_irq = i + max8998->irq_base;\r\nirq_set_chip_data(cur_irq, max8998);\r\nirq_set_chip_and_handler(cur_irq, &max8998_irq_chip,\r\nhandle_edge_irq);\r\nirq_set_nested_thread(cur_irq, 1);\r\n#ifdef CONFIG_ARM\r\nset_irq_flags(cur_irq, IRQF_VALID);\r\n#else\r\nirq_set_noprobe(cur_irq);\r\n#endif\r\n}\r\nret = request_threaded_irq(max8998->irq, NULL, max8998_irq_thread,\r\nIRQF_TRIGGER_FALLING | IRQF_ONESHOT,\r\n"max8998-irq", max8998);\r\nif (ret) {\r\ndev_err(max8998->dev, "Failed to request IRQ %d: %d\n",\r\nmax8998->irq, ret);\r\nreturn ret;\r\n}\r\nif (!max8998->ono)\r\nreturn 0;\r\nret = request_threaded_irq(max8998->ono, NULL, max8998_irq_thread,\r\nIRQF_TRIGGER_FALLING | IRQF_TRIGGER_RISING |\r\nIRQF_ONESHOT, "max8998-ono", max8998);\r\nif (ret)\r\ndev_err(max8998->dev, "Failed to request IRQ %d: %d\n",\r\nmax8998->ono, ret);\r\nreturn 0;\r\n}\r\nvoid max8998_irq_exit(struct max8998_dev *max8998)\r\n{\r\nif (max8998->ono)\r\nfree_irq(max8998->ono, max8998);\r\nif (max8998->irq)\r\nfree_irq(max8998->irq, max8998);\r\n}

static inline struct wm8350_gpio_data *to_wm8350_gpio(struct gpio_chip *chip)\r\n{\r\nreturn container_of(chip, struct wm8350_gpio_data, gpio_chip);\r\n}\r\nstatic int wm8350_gpio_direction_in(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct wm8350_gpio_data *wm8350_gpio = to_wm8350_gpio(chip);\r\nstruct wm8350 *wm8350 = wm8350_gpio->wm8350;\r\nreturn wm8350_set_bits(wm8350, WM8350_GPIO_CONFIGURATION_I_O,\r\n1 << offset);\r\n}\r\nstatic int wm8350_gpio_get(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct wm8350_gpio_data *wm8350_gpio = to_wm8350_gpio(chip);\r\nstruct wm8350 *wm8350 = wm8350_gpio->wm8350;\r\nint ret;\r\nret = wm8350_reg_read(wm8350, WM8350_GPIO_LEVEL);\r\nif (ret < 0)\r\nreturn ret;\r\nif (ret & (1 << offset))\r\nreturn 1;\r\nelse\r\nreturn 0;\r\n}\r\nstatic void wm8350_gpio_set(struct gpio_chip *chip, unsigned offset, int value)\r\n{\r\nstruct wm8350_gpio_data *wm8350_gpio = to_wm8350_gpio(chip);\r\nstruct wm8350 *wm8350 = wm8350_gpio->wm8350;\r\nif (value)\r\nwm8350_set_bits(wm8350, WM8350_GPIO_LEVEL, 1 << offset);\r\nelse\r\nwm8350_clear_bits(wm8350, WM8350_GPIO_LEVEL, 1 << offset);\r\n}\r\nstatic int wm8350_gpio_direction_out(struct gpio_chip *chip,\r\nunsigned offset, int value)\r\n{\r\nstruct wm8350_gpio_data *wm8350_gpio = to_wm8350_gpio(chip);\r\nstruct wm8350 *wm8350 = wm8350_gpio->wm8350;\r\nint ret;\r\nret = wm8350_clear_bits(wm8350, WM8350_GPIO_CONFIGURATION_I_O,\r\n1 << offset);\r\nif (ret < 0)\r\nreturn ret;\r\nwm8350_gpio_set(chip, offset, value);\r\nreturn 0;\r\n}\r\nstatic int wm8350_gpio_to_irq(struct gpio_chip *chip, unsigned offset)\r\n{\r\nstruct wm8350_gpio_data *wm8350_gpio = to_wm8350_gpio(chip);\r\nstruct wm8350 *wm8350 = wm8350_gpio->wm8350;\r\nif (!wm8350->irq_base)\r\nreturn -EINVAL;\r\nreturn wm8350->irq_base + WM8350_IRQ_GPIO(offset);\r\n}\r\nstatic int wm8350_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct wm8350 *wm8350 = dev_get_drvdata(pdev->dev.parent);\r\nstruct wm8350_platform_data *pdata = wm8350->dev->platform_data;\r\nstruct wm8350_gpio_data *wm8350_gpio;\r\nint ret;\r\nwm8350_gpio = devm_kzalloc(&pdev->dev, sizeof(*wm8350_gpio),\r\nGFP_KERNEL);\r\nif (wm8350_gpio == NULL)\r\nreturn -ENOMEM;\r\nwm8350_gpio->wm8350 = wm8350;\r\nwm8350_gpio->gpio_chip = template_chip;\r\nwm8350_gpio->gpio_chip.ngpio = 13;\r\nwm8350_gpio->gpio_chip.dev = &pdev->dev;\r\nif (pdata && pdata->gpio_base)\r\nwm8350_gpio->gpio_chip.base = pdata->gpio_base;\r\nelse\r\nwm8350_gpio->gpio_chip.base = -1;\r\nret = gpiochip_add(&wm8350_gpio->gpio_chip);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Could not register gpiochip, %d\n", ret);\r\nreturn ret;\r\n}\r\nplatform_set_drvdata(pdev, wm8350_gpio);\r\nreturn ret;\r\n}\r\nstatic int wm8350_gpio_remove(struct platform_device *pdev)\r\n{\r\nstruct wm8350_gpio_data *wm8350_gpio = platform_get_drvdata(pdev);\r\nreturn gpiochip_remove(&wm8350_gpio->gpio_chip);\r\n}\r\nstatic int __init wm8350_gpio_init(void)\r\n{\r\nreturn platform_driver_register(&wm8350_gpio_driver);\r\n}\r\nstatic void __exit wm8350_gpio_exit(void)\r\n{\r\nplatform_driver_unregister(&wm8350_gpio_driver);\r\n}

static void rtl8225_write_bitbang(struct ieee80211_hw *dev, u8 addr, u16 data)\r\n{\r\nstruct rtl8187_priv *priv = dev->priv;\r\nu16 reg80, reg84, reg82;\r\nu32 bangdata;\r\nint i;\r\nbangdata = (data << 4) | (addr & 0xf);\r\nreg80 = rtl818x_ioread16(priv, &priv->map->RFPinsOutput) & 0xfff3;\r\nreg82 = rtl818x_ioread16(priv, &priv->map->RFPinsEnable);\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsEnable, reg82 | 0x7);\r\nreg84 = rtl818x_ioread16(priv, &priv->map->RFPinsSelect);\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsSelect, reg84 | 0x7);\r\nudelay(10);\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsOutput, reg80 | (1 << 2));\r\nudelay(2);\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsOutput, reg80);\r\nudelay(10);\r\nfor (i = 15; i >= 0; i--) {\r\nu16 reg = reg80 | (bangdata & (1 << i)) >> i;\r\nif (i & 1)\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsOutput, reg);\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsOutput, reg | (1 << 1));\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsOutput, reg | (1 << 1));\r\nif (!(i & 1))\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsOutput, reg);\r\n}\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsOutput, reg80 | (1 << 2));\r\nudelay(10);\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsOutput, reg80 | (1 << 2));\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsSelect, reg84);\r\n}\r\nstatic void rtl8225_write_8051(struct ieee80211_hw *dev, u8 addr, __le16 data)\r\n{\r\nstruct rtl8187_priv *priv = dev->priv;\r\nu16 reg80, reg82, reg84;\r\nreg80 = rtl818x_ioread16(priv, &priv->map->RFPinsOutput);\r\nreg82 = rtl818x_ioread16(priv, &priv->map->RFPinsEnable);\r\nreg84 = rtl818x_ioread16(priv, &priv->map->RFPinsSelect);\r\nreg80 &= ~(0x3 << 2);\r\nreg84 &= ~0xF;\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsEnable, reg82 | 0x0007);\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsSelect, reg84 | 0x0007);\r\nudelay(10);\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsOutput, reg80 | (1 << 2));\r\nudelay(2);\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsOutput, reg80);\r\nudelay(10);\r\nmutex_lock(&priv->io_mutex);\r\npriv->io_dmabuf->bits16 = data;\r\nusb_control_msg(priv->udev, usb_sndctrlpipe(priv->udev, 0),\r\nRTL8187_REQ_SET_REG, RTL8187_REQT_WRITE,\r\naddr, 0x8225, &priv->io_dmabuf->bits16, sizeof(data),\r\nHZ / 2);\r\nmutex_unlock(&priv->io_mutex);\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsOutput, reg80 | (1 << 2));\r\nudelay(10);\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsOutput, reg80 | (1 << 2));\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsSelect, reg84);\r\n}\r\nstatic void rtl8225_write(struct ieee80211_hw *dev, u8 addr, u16 data)\r\n{\r\nstruct rtl8187_priv *priv = dev->priv;\r\nif (priv->asic_rev)\r\nrtl8225_write_8051(dev, addr, cpu_to_le16(data));\r\nelse\r\nrtl8225_write_bitbang(dev, addr, data);\r\n}\r\nstatic u16 rtl8225_read(struct ieee80211_hw *dev, u8 addr)\r\n{\r\nstruct rtl8187_priv *priv = dev->priv;\r\nu16 reg80, reg82, reg84, out;\r\nint i;\r\nreg80 = rtl818x_ioread16(priv, &priv->map->RFPinsOutput);\r\nreg82 = rtl818x_ioread16(priv, &priv->map->RFPinsEnable);\r\nreg84 = rtl818x_ioread16(priv, &priv->map->RFPinsSelect);\r\nreg80 &= ~0xF;\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsEnable, reg82 | 0x000F);\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsSelect, reg84 | 0x000F);\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsOutput, reg80 | (1 << 2));\r\nudelay(4);\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsOutput, reg80);\r\nudelay(5);\r\nfor (i = 4; i >= 0; i--) {\r\nu16 reg = reg80 | ((addr >> i) & 1);\r\nif (!(i & 1)) {\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsOutput, reg);\r\nudelay(1);\r\n}\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsOutput,\r\nreg | (1 << 1));\r\nudelay(2);\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsOutput,\r\nreg | (1 << 1));\r\nudelay(2);\r\nif (i & 1) {\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsOutput, reg);\r\nudelay(1);\r\n}\r\n}\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsOutput,\r\nreg80 | (1 << 3) | (1 << 1));\r\nudelay(2);\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsOutput,\r\nreg80 | (1 << 3));\r\nudelay(2);\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsOutput,\r\nreg80 | (1 << 3));\r\nudelay(2);\r\nout = 0;\r\nfor (i = 11; i >= 0; i--) {\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsOutput,\r\nreg80 | (1 << 3));\r\nudelay(1);\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsOutput,\r\nreg80 | (1 << 3) | (1 << 1));\r\nudelay(2);\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsOutput,\r\nreg80 | (1 << 3) | (1 << 1));\r\nudelay(2);\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsOutput,\r\nreg80 | (1 << 3) | (1 << 1));\r\nudelay(2);\r\nif (rtl818x_ioread16(priv, &priv->map->RFPinsInput) & (1 << 1))\r\nout |= 1 << i;\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsOutput,\r\nreg80 | (1 << 3));\r\nudelay(2);\r\n}\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsOutput,\r\nreg80 | (1 << 3) | (1 << 2));\r\nudelay(2);\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsEnable, reg82);\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsSelect, reg84);\r\nrtl818x_iowrite16(priv, &priv->map->RFPinsOutput, 0x03A0);\r\nreturn out;\r\n}\r\nstatic void rtl8225_rf_set_tx_power(struct ieee80211_hw *dev, int channel)\r\n{\r\nstruct rtl8187_priv *priv = dev->priv;\r\nu8 cck_power, ofdm_power;\r\nconst u8 *tmp;\r\nu32 reg;\r\nint i;\r\ncck_power = priv->channels[channel - 1].hw_value & 0xF;\r\nofdm_power = priv->channels[channel - 1].hw_value >> 4;\r\ncck_power = min(cck_power, (u8)11);\r\nif (ofdm_power > (u8)15)\r\nofdm_power = 25;\r\nelse\r\nofdm_power += 10;\r\nrtl818x_iowrite8(priv, &priv->map->TX_GAIN_CCK,\r\nrtl8225_tx_gain_cck_ofdm[cck_power / 6] >> 1);\r\nif (channel == 14)\r\ntmp = &rtl8225_tx_power_cck_ch14[(cck_power % 6) * 8];\r\nelse\r\ntmp = &rtl8225_tx_power_cck[(cck_power % 6) * 8];\r\nfor (i = 0; i < 8; i++)\r\nrtl8225_write_phy_cck(dev, 0x44 + i, *tmp++);\r\nmsleep(1);\r\nrtl818x_iowrite8(priv, &priv->map->EEPROM_CMD, RTL818X_EEPROM_CMD_CONFIG);\r\nreg = rtl818x_ioread8(priv, &priv->map->CONFIG3);\r\nrtl818x_iowrite8(priv, &priv->map->CONFIG3,\r\nreg | RTL818X_CONFIG3_ANAPARAM_WRITE);\r\nrtl818x_iowrite32(priv, &priv->map->ANAPARAM2,\r\nRTL8187_RTL8225_ANAPARAM2_ON);\r\nrtl818x_iowrite8(priv, &priv->map->CONFIG3,\r\nreg & ~RTL818X_CONFIG3_ANAPARAM_WRITE);\r\nrtl818x_iowrite8(priv, &priv->map->EEPROM_CMD, RTL818X_EEPROM_CMD_NORMAL);\r\nrtl8225_write_phy_ofdm(dev, 2, 0x42);\r\nrtl8225_write_phy_ofdm(dev, 6, 0x00);\r\nrtl8225_write_phy_ofdm(dev, 8, 0x00);\r\nrtl818x_iowrite8(priv, &priv->map->TX_GAIN_OFDM,\r\nrtl8225_tx_gain_cck_ofdm[ofdm_power / 6] >> 1);\r\ntmp = &rtl8225_tx_power_ofdm[ofdm_power % 6];\r\nrtl8225_write_phy_ofdm(dev, 5, *tmp);\r\nrtl8225_write_phy_ofdm(dev, 7, *tmp);\r\nmsleep(1);\r\n}\r\nstatic void rtl8225_rf_init(struct ieee80211_hw *dev)\r\n{\r\nstruct rtl8187_priv *priv = dev->priv;\r\nint i;\r\nrtl8225_write(dev, 0x0, 0x067);\r\nrtl8225_write(dev, 0x1, 0xFE0);\r\nrtl8225_write(dev, 0x2, 0x44D);\r\nrtl8225_write(dev, 0x3, 0x441);\r\nrtl8225_write(dev, 0x4, 0x486);\r\nrtl8225_write(dev, 0x5, 0xBC0);\r\nrtl8225_write(dev, 0x6, 0xAE6);\r\nrtl8225_write(dev, 0x7, 0x82A);\r\nrtl8225_write(dev, 0x8, 0x01F);\r\nrtl8225_write(dev, 0x9, 0x334);\r\nrtl8225_write(dev, 0xA, 0xFD4);\r\nrtl8225_write(dev, 0xB, 0x391);\r\nrtl8225_write(dev, 0xC, 0x050);\r\nrtl8225_write(dev, 0xD, 0x6DB);\r\nrtl8225_write(dev, 0xE, 0x029);\r\nrtl8225_write(dev, 0xF, 0x914); msleep(100);\r\nrtl8225_write(dev, 0x2, 0xC4D); msleep(200);\r\nrtl8225_write(dev, 0x2, 0x44D); msleep(200);\r\nif (!(rtl8225_read(dev, 6) & (1 << 7))) {\r\nrtl8225_write(dev, 0x02, 0x0c4d);\r\nmsleep(200);\r\nrtl8225_write(dev, 0x02, 0x044d);\r\nmsleep(100);\r\nif (!(rtl8225_read(dev, 6) & (1 << 7)))\r\nwiphy_warn(dev->wiphy, "RF Calibration Failed! %x\n",\r\nrtl8225_read(dev, 6));\r\n}\r\nrtl8225_write(dev, 0x0, 0x127);\r\nfor (i = 0; i < ARRAY_SIZE(rtl8225bcd_rxgain); i++) {\r\nrtl8225_write(dev, 0x1, i + 1);\r\nrtl8225_write(dev, 0x2, rtl8225bcd_rxgain[i]);\r\n}\r\nrtl8225_write(dev, 0x0, 0x027);\r\nrtl8225_write(dev, 0x0, 0x22F);\r\nfor (i = 0; i < ARRAY_SIZE(rtl8225_agc); i++) {\r\nrtl8225_write_phy_ofdm(dev, 0xB, rtl8225_agc[i]);\r\nrtl8225_write_phy_ofdm(dev, 0xA, 0x80 + i);\r\n}\r\nmsleep(1);\r\nrtl8225_write_phy_ofdm(dev, 0x00, 0x01);\r\nrtl8225_write_phy_ofdm(dev, 0x01, 0x02);\r\nrtl8225_write_phy_ofdm(dev, 0x02, 0x42);\r\nrtl8225_write_phy_ofdm(dev, 0x03, 0x00);\r\nrtl8225_write_phy_ofdm(dev, 0x04, 0x00);\r\nrtl8225_write_phy_ofdm(dev, 0x05, 0x00);\r\nrtl8225_write_phy_ofdm(dev, 0x06, 0x40);\r\nrtl8225_write_phy_ofdm(dev, 0x07, 0x00);\r\nrtl8225_write_phy_ofdm(dev, 0x08, 0x40);\r\nrtl8225_write_phy_ofdm(dev, 0x09, 0xfe);\r\nrtl8225_write_phy_ofdm(dev, 0x0a, 0x09);\r\nrtl8225_write_phy_ofdm(dev, 0x0b, 0x80);\r\nrtl8225_write_phy_ofdm(dev, 0x0c, 0x01);\r\nrtl8225_write_phy_ofdm(dev, 0x0e, 0xd3);\r\nrtl8225_write_phy_ofdm(dev, 0x0f, 0x38);\r\nrtl8225_write_phy_ofdm(dev, 0x10, 0x84);\r\nrtl8225_write_phy_ofdm(dev, 0x11, 0x06);\r\nrtl8225_write_phy_ofdm(dev, 0x12, 0x20);\r\nrtl8225_write_phy_ofdm(dev, 0x13, 0x20);\r\nrtl8225_write_phy_ofdm(dev, 0x14, 0x00);\r\nrtl8225_write_phy_ofdm(dev, 0x15, 0x40);\r\nrtl8225_write_phy_ofdm(dev, 0x16, 0x00);\r\nrtl8225_write_phy_ofdm(dev, 0x17, 0x40);\r\nrtl8225_write_phy_ofdm(dev, 0x18, 0xef);\r\nrtl8225_write_phy_ofdm(dev, 0x19, 0x19);\r\nrtl8225_write_phy_ofdm(dev, 0x1a, 0x20);\r\nrtl8225_write_phy_ofdm(dev, 0x1b, 0x76);\r\nrtl8225_write_phy_ofdm(dev, 0x1c, 0x04);\r\nrtl8225_write_phy_ofdm(dev, 0x1e, 0x95);\r\nrtl8225_write_phy_ofdm(dev, 0x1f, 0x75);\r\nrtl8225_write_phy_ofdm(dev, 0x20, 0x1f);\r\nrtl8225_write_phy_ofdm(dev, 0x21, 0x27);\r\nrtl8225_write_phy_ofdm(dev, 0x22, 0x16);\r\nrtl8225_write_phy_ofdm(dev, 0x24, 0x46);\r\nrtl8225_write_phy_ofdm(dev, 0x25, 0x20);\r\nrtl8225_write_phy_ofdm(dev, 0x26, 0x90);\r\nrtl8225_write_phy_ofdm(dev, 0x27, 0x88);\r\nrtl8225_write_phy_ofdm(dev, 0x0d, rtl8225_gain[2 * 4]);\r\nrtl8225_write_phy_ofdm(dev, 0x1b, rtl8225_gain[2 * 4 + 2]);\r\nrtl8225_write_phy_ofdm(dev, 0x1d, rtl8225_gain[2 * 4 + 3]);\r\nrtl8225_write_phy_ofdm(dev, 0x23, rtl8225_gain[2 * 4 + 1]);\r\nrtl8225_write_phy_cck(dev, 0x00, 0x98);\r\nrtl8225_write_phy_cck(dev, 0x03, 0x20);\r\nrtl8225_write_phy_cck(dev, 0x04, 0x7e);\r\nrtl8225_write_phy_cck(dev, 0x05, 0x12);\r\nrtl8225_write_phy_cck(dev, 0x06, 0xfc);\r\nrtl8225_write_phy_cck(dev, 0x07, 0x78);\r\nrtl8225_write_phy_cck(dev, 0x08, 0x2e);\r\nrtl8225_write_phy_cck(dev, 0x10, 0x9b);\r\nrtl8225_write_phy_cck(dev, 0x11, 0x88);\r\nrtl8225_write_phy_cck(dev, 0x12, 0x47);\r\nrtl8225_write_phy_cck(dev, 0x13, 0xd0);\r\nrtl8225_write_phy_cck(dev, 0x19, 0x00);\r\nrtl8225_write_phy_cck(dev, 0x1a, 0xa0);\r\nrtl8225_write_phy_cck(dev, 0x1b, 0x08);\r\nrtl8225_write_phy_cck(dev, 0x40, 0x86);\r\nrtl8225_write_phy_cck(dev, 0x41, 0x8d);\r\nrtl8225_write_phy_cck(dev, 0x42, 0x15);\r\nrtl8225_write_phy_cck(dev, 0x43, 0x18);\r\nrtl8225_write_phy_cck(dev, 0x44, 0x1f);\r\nrtl8225_write_phy_cck(dev, 0x45, 0x1e);\r\nrtl8225_write_phy_cck(dev, 0x46, 0x1a);\r\nrtl8225_write_phy_cck(dev, 0x47, 0x15);\r\nrtl8225_write_phy_cck(dev, 0x48, 0x10);\r\nrtl8225_write_phy_cck(dev, 0x49, 0x0a);\r\nrtl8225_write_phy_cck(dev, 0x4a, 0x05);\r\nrtl8225_write_phy_cck(dev, 0x4b, 0x02);\r\nrtl8225_write_phy_cck(dev, 0x4c, 0x05);\r\nrtl818x_iowrite8(priv, &priv->map->TESTR, 0x0D);\r\nrtl8225_rf_set_tx_power(dev, 1);\r\nrtl8225_write_phy_cck(dev, 0x10, 0x9b);\r\nrtl8225_write_phy_ofdm(dev, 0x26, 0x90);\r\nrtl818x_iowrite8(priv, &priv->map->TX_ANTENNA, 0x03);\r\nmsleep(1);\r\nrtl818x_iowrite32(priv, (__le32 *)0xFF94, 0x3dc00002);\r\nrtl8225_write(dev, 0x0c, 0x50);\r\nrtl8225_write_phy_ofdm(dev, 0x0d, rtl8225_gain[2 * 4]);\r\nrtl8225_write_phy_ofdm(dev, 0x1b, rtl8225_gain[2 * 4 + 2]);\r\nrtl8225_write_phy_ofdm(dev, 0x1d, rtl8225_gain[2 * 4 + 3]);\r\nrtl8225_write_phy_ofdm(dev, 0x23, rtl8225_gain[2 * 4 + 1]);\r\nrtl8225_write_phy_cck(dev, 0x41, rtl8225_threshold[2]);\r\n}\r\nstatic void rtl8225z2_rf_set_tx_power(struct ieee80211_hw *dev, int channel)\r\n{\r\nstruct rtl8187_priv *priv = dev->priv;\r\nu8 cck_power, ofdm_power;\r\nconst u8 *tmp;\r\nu32 reg;\r\nint i;\r\ncck_power = priv->channels[channel - 1].hw_value & 0xF;\r\nofdm_power = priv->channels[channel - 1].hw_value >> 4;\r\ncck_power = min(cck_power, (u8)15);\r\ncck_power += priv->txpwr_base & 0xF;\r\ncck_power = min(cck_power, (u8)35);\r\nif (ofdm_power > (u8)15)\r\nofdm_power = 25;\r\nelse\r\nofdm_power += 10;\r\nofdm_power += priv->txpwr_base >> 4;\r\nofdm_power = min(ofdm_power, (u8)35);\r\nif (channel == 14)\r\ntmp = rtl8225z2_tx_power_cck_ch14;\r\nelse\r\ntmp = rtl8225z2_tx_power_cck;\r\nfor (i = 0; i < 8; i++)\r\nrtl8225_write_phy_cck(dev, 0x44 + i, *tmp++);\r\nrtl818x_iowrite8(priv, &priv->map->TX_GAIN_CCK,\r\nrtl8225z2_tx_gain_cck_ofdm[cck_power]);\r\nmsleep(1);\r\nrtl818x_iowrite8(priv, &priv->map->EEPROM_CMD, RTL818X_EEPROM_CMD_CONFIG);\r\nreg = rtl818x_ioread8(priv, &priv->map->CONFIG3);\r\nrtl818x_iowrite8(priv, &priv->map->CONFIG3,\r\nreg | RTL818X_CONFIG3_ANAPARAM_WRITE);\r\nrtl818x_iowrite32(priv, &priv->map->ANAPARAM2,\r\nRTL8187_RTL8225_ANAPARAM2_ON);\r\nrtl818x_iowrite8(priv, &priv->map->CONFIG3,\r\nreg & ~RTL818X_CONFIG3_ANAPARAM_WRITE);\r\nrtl818x_iowrite8(priv, &priv->map->EEPROM_CMD, RTL818X_EEPROM_CMD_NORMAL);\r\nrtl8225_write_phy_ofdm(dev, 2, 0x42);\r\nrtl8225_write_phy_ofdm(dev, 5, 0x00);\r\nrtl8225_write_phy_ofdm(dev, 6, 0x40);\r\nrtl8225_write_phy_ofdm(dev, 7, 0x00);\r\nrtl8225_write_phy_ofdm(dev, 8, 0x40);\r\nrtl818x_iowrite8(priv, &priv->map->TX_GAIN_OFDM,\r\nrtl8225z2_tx_gain_cck_ofdm[ofdm_power]);\r\nmsleep(1);\r\n}\r\nstatic void rtl8225z2_b_rf_set_tx_power(struct ieee80211_hw *dev, int channel)\r\n{\r\nstruct rtl8187_priv *priv = dev->priv;\r\nu8 cck_power, ofdm_power;\r\nconst u8 *tmp;\r\nint i;\r\ncck_power = priv->channels[channel - 1].hw_value & 0xF;\r\nofdm_power = priv->channels[channel - 1].hw_value >> 4;\r\nif (cck_power > 15)\r\ncck_power = (priv->hw_rev == RTL8187BvB) ? 15 : 22;\r\nelse\r\ncck_power += (priv->hw_rev == RTL8187BvB) ? 0 : 7;\r\ncck_power += priv->txpwr_base & 0xF;\r\ncck_power = min(cck_power, (u8)35);\r\nif (ofdm_power > 15)\r\nofdm_power = (priv->hw_rev == RTL8187BvB) ? 17 : 25;\r\nelse\r\nofdm_power += (priv->hw_rev == RTL8187BvB) ? 2 : 10;\r\nofdm_power += (priv->txpwr_base >> 4) & 0xF;\r\nofdm_power = min(ofdm_power, (u8)35);\r\nif (channel == 14)\r\ntmp = rtl8225z2_tx_power_cck_ch14;\r\nelse\r\ntmp = rtl8225z2_tx_power_cck;\r\nif (priv->hw_rev == RTL8187BvB) {\r\nif (cck_power <= 6)\r\n;\r\nelse if (cck_power <= 11)\r\ntmp += 8;\r\nelse\r\ntmp += 16;\r\n} else {\r\nif (cck_power <= 5)\r\n;\r\nelse if (cck_power <= 11)\r\ntmp += 8;\r\nelse if (cck_power <= 17)\r\ntmp += 16;\r\nelse\r\ntmp += 24;\r\n}\r\nfor (i = 0; i < 8; i++)\r\nrtl8225_write_phy_cck(dev, 0x44 + i, *tmp++);\r\nrtl818x_iowrite8(priv, &priv->map->TX_GAIN_CCK,\r\nrtl8225z2_tx_gain_cck_ofdm[cck_power] << 1);\r\nmsleep(1);\r\nrtl818x_iowrite8(priv, &priv->map->TX_GAIN_OFDM,\r\nrtl8225z2_tx_gain_cck_ofdm[ofdm_power] << 1);\r\nif (priv->hw_rev == RTL8187BvB) {\r\nif (ofdm_power <= 11) {\r\nrtl8225_write_phy_ofdm(dev, 0x87, 0x60);\r\nrtl8225_write_phy_ofdm(dev, 0x89, 0x60);\r\n} else {\r\nrtl8225_write_phy_ofdm(dev, 0x87, 0x5c);\r\nrtl8225_write_phy_ofdm(dev, 0x89, 0x5c);\r\n}\r\n} else {\r\nif (ofdm_power <= 11) {\r\nrtl8225_write_phy_ofdm(dev, 0x87, 0x5c);\r\nrtl8225_write_phy_ofdm(dev, 0x89, 0x5c);\r\n} else if (ofdm_power <= 17) {\r\nrtl8225_write_phy_ofdm(dev, 0x87, 0x54);\r\nrtl8225_write_phy_ofdm(dev, 0x89, 0x54);\r\n} else {\r\nrtl8225_write_phy_ofdm(dev, 0x87, 0x50);\r\nrtl8225_write_phy_ofdm(dev, 0x89, 0x50);\r\n}\r\n}\r\nmsleep(1);\r\n}\r\nstatic void rtl8225z2_rf_init(struct ieee80211_hw *dev)\r\n{\r\nstruct rtl8187_priv *priv = dev->priv;\r\nint i;\r\nrtl8225_write(dev, 0x0, 0x2BF);\r\nrtl8225_write(dev, 0x1, 0xEE0);\r\nrtl8225_write(dev, 0x2, 0x44D);\r\nrtl8225_write(dev, 0x3, 0x441);\r\nrtl8225_write(dev, 0x4, 0x8C3);\r\nrtl8225_write(dev, 0x5, 0xC72);\r\nrtl8225_write(dev, 0x6, 0x0E6);\r\nrtl8225_write(dev, 0x7, 0x82A);\r\nrtl8225_write(dev, 0x8, 0x03F);\r\nrtl8225_write(dev, 0x9, 0x335);\r\nrtl8225_write(dev, 0xa, 0x9D4);\r\nrtl8225_write(dev, 0xb, 0x7BB);\r\nrtl8225_write(dev, 0xc, 0x850);\r\nrtl8225_write(dev, 0xd, 0xCDF);\r\nrtl8225_write(dev, 0xe, 0x02B);\r\nrtl8225_write(dev, 0xf, 0x114);\r\nmsleep(100);\r\nrtl8225_write(dev, 0x0, 0x1B7);\r\nfor (i = 0; i < ARRAY_SIZE(rtl8225z2_rxgain); i++) {\r\nrtl8225_write(dev, 0x1, i + 1);\r\nrtl8225_write(dev, 0x2, rtl8225z2_rxgain[i]);\r\n}\r\nrtl8225_write(dev, 0x3, 0x080);\r\nrtl8225_write(dev, 0x5, 0x004);\r\nrtl8225_write(dev, 0x0, 0x0B7);\r\nrtl8225_write(dev, 0x2, 0xc4D);\r\nmsleep(200);\r\nrtl8225_write(dev, 0x2, 0x44D);\r\nmsleep(100);\r\nif (!(rtl8225_read(dev, 6) & (1 << 7))) {\r\nrtl8225_write(dev, 0x02, 0x0C4D);\r\nmsleep(200);\r\nrtl8225_write(dev, 0x02, 0x044D);\r\nmsleep(100);\r\nif (!(rtl8225_read(dev, 6) & (1 << 7)))\r\nwiphy_warn(dev->wiphy, "RF Calibration Failed! %x\n",\r\nrtl8225_read(dev, 6));\r\n}\r\nmsleep(200);\r\nrtl8225_write(dev, 0x0, 0x2BF);\r\nfor (i = 0; i < ARRAY_SIZE(rtl8225_agc); i++) {\r\nrtl8225_write_phy_ofdm(dev, 0xB, rtl8225_agc[i]);\r\nrtl8225_write_phy_ofdm(dev, 0xA, 0x80 + i);\r\n}\r\nmsleep(1);\r\nrtl8225_write_phy_ofdm(dev, 0x00, 0x01);\r\nrtl8225_write_phy_ofdm(dev, 0x01, 0x02);\r\nrtl8225_write_phy_ofdm(dev, 0x02, 0x42);\r\nrtl8225_write_phy_ofdm(dev, 0x03, 0x00);\r\nrtl8225_write_phy_ofdm(dev, 0x04, 0x00);\r\nrtl8225_write_phy_ofdm(dev, 0x05, 0x00);\r\nrtl8225_write_phy_ofdm(dev, 0x06, 0x40);\r\nrtl8225_write_phy_ofdm(dev, 0x07, 0x00);\r\nrtl8225_write_phy_ofdm(dev, 0x08, 0x40);\r\nrtl8225_write_phy_ofdm(dev, 0x09, 0xfe);\r\nrtl8225_write_phy_ofdm(dev, 0x0a, 0x08);\r\nrtl8225_write_phy_ofdm(dev, 0x0b, 0x80);\r\nrtl8225_write_phy_ofdm(dev, 0x0c, 0x01);\r\nrtl8225_write_phy_ofdm(dev, 0x0d, 0x43);\r\nrtl8225_write_phy_ofdm(dev, 0x0e, 0xd3);\r\nrtl8225_write_phy_ofdm(dev, 0x0f, 0x38);\r\nrtl8225_write_phy_ofdm(dev, 0x10, 0x84);\r\nrtl8225_write_phy_ofdm(dev, 0x11, 0x07);\r\nrtl8225_write_phy_ofdm(dev, 0x12, 0x20);\r\nrtl8225_write_phy_ofdm(dev, 0x13, 0x20);\r\nrtl8225_write_phy_ofdm(dev, 0x14, 0x00);\r\nrtl8225_write_phy_ofdm(dev, 0x15, 0x40);\r\nrtl8225_write_phy_ofdm(dev, 0x16, 0x00);\r\nrtl8225_write_phy_ofdm(dev, 0x17, 0x40);\r\nrtl8225_write_phy_ofdm(dev, 0x18, 0xef);\r\nrtl8225_write_phy_ofdm(dev, 0x19, 0x19);\r\nrtl8225_write_phy_ofdm(dev, 0x1a, 0x20);\r\nrtl8225_write_phy_ofdm(dev, 0x1b, 0x15);\r\nrtl8225_write_phy_ofdm(dev, 0x1c, 0x04);\r\nrtl8225_write_phy_ofdm(dev, 0x1d, 0xc5);\r\nrtl8225_write_phy_ofdm(dev, 0x1e, 0x95);\r\nrtl8225_write_phy_ofdm(dev, 0x1f, 0x75);\r\nrtl8225_write_phy_ofdm(dev, 0x20, 0x1f);\r\nrtl8225_write_phy_ofdm(dev, 0x21, 0x17);\r\nrtl8225_write_phy_ofdm(dev, 0x22, 0x16);\r\nrtl8225_write_phy_ofdm(dev, 0x23, 0x80);\r\nrtl8225_write_phy_ofdm(dev, 0x24, 0x46);\r\nrtl8225_write_phy_ofdm(dev, 0x25, 0x00);\r\nrtl8225_write_phy_ofdm(dev, 0x26, 0x90);\r\nrtl8225_write_phy_ofdm(dev, 0x27, 0x88);\r\nrtl8225_write_phy_ofdm(dev, 0x0b, rtl8225z2_gain_bg[4 * 3]);\r\nrtl8225_write_phy_ofdm(dev, 0x1b, rtl8225z2_gain_bg[4 * 3 + 1]);\r\nrtl8225_write_phy_ofdm(dev, 0x1d, rtl8225z2_gain_bg[4 * 3 + 2]);\r\nrtl8225_write_phy_ofdm(dev, 0x21, 0x37);\r\nrtl8225_write_phy_cck(dev, 0x00, 0x98);\r\nrtl8225_write_phy_cck(dev, 0x03, 0x20);\r\nrtl8225_write_phy_cck(dev, 0x04, 0x7e);\r\nrtl8225_write_phy_cck(dev, 0x05, 0x12);\r\nrtl8225_write_phy_cck(dev, 0x06, 0xfc);\r\nrtl8225_write_phy_cck(dev, 0x07, 0x78);\r\nrtl8225_write_phy_cck(dev, 0x08, 0x2e);\r\nrtl8225_write_phy_cck(dev, 0x10, 0x9b);\r\nrtl8225_write_phy_cck(dev, 0x11, 0x88);\r\nrtl8225_write_phy_cck(dev, 0x12, 0x47);\r\nrtl8225_write_phy_cck(dev, 0x13, 0xd0);\r\nrtl8225_write_phy_cck(dev, 0x19, 0x00);\r\nrtl8225_write_phy_cck(dev, 0x1a, 0xa0);\r\nrtl8225_write_phy_cck(dev, 0x1b, 0x08);\r\nrtl8225_write_phy_cck(dev, 0x40, 0x86);\r\nrtl8225_write_phy_cck(dev, 0x41, 0x8d);\r\nrtl8225_write_phy_cck(dev, 0x42, 0x15);\r\nrtl8225_write_phy_cck(dev, 0x43, 0x18);\r\nrtl8225_write_phy_cck(dev, 0x44, 0x36);\r\nrtl8225_write_phy_cck(dev, 0x45, 0x35);\r\nrtl8225_write_phy_cck(dev, 0x46, 0x2e);\r\nrtl8225_write_phy_cck(dev, 0x47, 0x25);\r\nrtl8225_write_phy_cck(dev, 0x48, 0x1c);\r\nrtl8225_write_phy_cck(dev, 0x49, 0x12);\r\nrtl8225_write_phy_cck(dev, 0x4a, 0x09);\r\nrtl8225_write_phy_cck(dev, 0x4b, 0x04);\r\nrtl8225_write_phy_cck(dev, 0x4c, 0x05);\r\nrtl818x_iowrite8(priv, (u8 *)0xFF5B, 0x0D); msleep(1);\r\nrtl8225z2_rf_set_tx_power(dev, 1);\r\nrtl8225_write_phy_cck(dev, 0x10, 0x9b);\r\nrtl8225_write_phy_ofdm(dev, 0x26, 0x90);\r\nrtl818x_iowrite8(priv, &priv->map->TX_ANTENNA, 0x03);\r\nmsleep(1);\r\nrtl818x_iowrite32(priv, (__le32 *)0xFF94, 0x3dc00002);\r\n}\r\nstatic void rtl8225z2_b_rf_init(struct ieee80211_hw *dev)\r\n{\r\nstruct rtl8187_priv *priv = dev->priv;\r\nint i;\r\nrtl8225_write(dev, 0x0, 0x0B7);\r\nrtl8225_write(dev, 0x1, 0xEE0);\r\nrtl8225_write(dev, 0x2, 0x44D);\r\nrtl8225_write(dev, 0x3, 0x441);\r\nrtl8225_write(dev, 0x4, 0x8C3);\r\nrtl8225_write(dev, 0x5, 0xC72);\r\nrtl8225_write(dev, 0x6, 0x0E6);\r\nrtl8225_write(dev, 0x7, 0x82A);\r\nrtl8225_write(dev, 0x8, 0x03F);\r\nrtl8225_write(dev, 0x9, 0x335);\r\nrtl8225_write(dev, 0xa, 0x9D4);\r\nrtl8225_write(dev, 0xb, 0x7BB);\r\nrtl8225_write(dev, 0xc, 0x850);\r\nrtl8225_write(dev, 0xd, 0xCDF);\r\nrtl8225_write(dev, 0xe, 0x02B);\r\nrtl8225_write(dev, 0xf, 0x114);\r\nrtl8225_write(dev, 0x0, 0x1B7);\r\nfor (i = 0; i < ARRAY_SIZE(rtl8225z2_rxgain); i++) {\r\nrtl8225_write(dev, 0x1, i + 1);\r\nrtl8225_write(dev, 0x2, rtl8225z2_rxgain[i]);\r\n}\r\nrtl8225_write(dev, 0x3, 0x080);\r\nrtl8225_write(dev, 0x5, 0x004);\r\nrtl8225_write(dev, 0x0, 0x0B7);\r\nrtl8225_write(dev, 0x2, 0xC4D);\r\nrtl8225_write(dev, 0x2, 0x44D);\r\nrtl8225_write(dev, 0x0, 0x2BF);\r\nrtl818x_iowrite8(priv, &priv->map->TX_GAIN_CCK, 0x03);\r\nrtl818x_iowrite8(priv, &priv->map->TX_GAIN_OFDM, 0x07);\r\nrtl818x_iowrite8(priv, &priv->map->TX_ANTENNA, 0x03);\r\nrtl8225_write_phy_ofdm(dev, 0x80, 0x12);\r\nfor (i = 0; i < ARRAY_SIZE(rtl8225z2_agc); i++) {\r\nrtl8225_write_phy_ofdm(dev, 0xF, rtl8225z2_agc[i]);\r\nrtl8225_write_phy_ofdm(dev, 0xE, 0x80 + i);\r\nrtl8225_write_phy_ofdm(dev, 0xE, 0);\r\n}\r\nrtl8225_write_phy_ofdm(dev, 0x80, 0x10);\r\nfor (i = 0; i < ARRAY_SIZE(rtl8225z2_ofdm); i++)\r\nrtl8225_write_phy_ofdm(dev, i, rtl8225z2_ofdm[i]);\r\nrtl8225_write_phy_ofdm(dev, 0x97, 0x46);\r\nrtl8225_write_phy_ofdm(dev, 0xa4, 0xb6);\r\nrtl8225_write_phy_ofdm(dev, 0x85, 0xfc);\r\nrtl8225_write_phy_cck(dev, 0xc1, 0x88);\r\n}\r\nstatic void rtl8225_rf_stop(struct ieee80211_hw *dev)\r\n{\r\nrtl8225_write(dev, 0x4, 0x1f);\r\n}\r\nstatic void rtl8225_rf_set_channel(struct ieee80211_hw *dev,\r\nstruct ieee80211_conf *conf)\r\n{\r\nstruct rtl8187_priv *priv = dev->priv;\r\nint chan = ieee80211_frequency_to_channel(conf->channel->center_freq);\r\nif (priv->rf->init == rtl8225_rf_init)\r\nrtl8225_rf_set_tx_power(dev, chan);\r\nelse if (priv->rf->init == rtl8225z2_rf_init)\r\nrtl8225z2_rf_set_tx_power(dev, chan);\r\nelse\r\nrtl8225z2_b_rf_set_tx_power(dev, chan);\r\nrtl8225_write(dev, 0x7, rtl8225_chan[chan - 1]);\r\nmsleep(10);\r\n}\r\nconst struct rtl818x_rf_ops * rtl8187_detect_rf(struct ieee80211_hw *dev)\r\n{\r\nu16 reg8, reg9;\r\nstruct rtl8187_priv *priv = dev->priv;\r\nif (!priv->is_rtl8187b) {\r\nrtl8225_write(dev, 0, 0x1B7);\r\nreg8 = rtl8225_read(dev, 8);\r\nreg9 = rtl8225_read(dev, 9);\r\nrtl8225_write(dev, 0, 0x0B7);\r\nif (reg8 != 0x588 || reg9 != 0x700)\r\nreturn &rtl8225_ops;\r\nreturn &rtl8225z2_ops;\r\n} else\r\nreturn &rtl8225z2_b_ops;\r\n}

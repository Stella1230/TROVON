static void EnableSRAM(THINKPAD_BD_DATA * pBDData)\r\n{\r\nDSP_3780I_CONFIG_SETTINGS *pSettings = &pBDData->rDspSettings;\r\nunsigned short usDspBaseIO = pSettings->usDspBaseIO;\r\nDSP_GPIO_OUTPUT_DATA_15_8 rGpioOutputData;\r\nDSP_GPIO_DRIVER_ENABLE_15_8 rGpioDriverEnable;\r\nDSP_GPIO_MODE_15_8 rGpioMode;\r\nPRINTK_1(TRACE_TP3780I, "tp3780i::EnableSRAM, entry\n");\r\nMKWORD(rGpioMode) = ReadMsaCfg(DSP_GpioModeControl_15_8);\r\nrGpioMode.GpioMode10 = 0;\r\nWriteMsaCfg(DSP_GpioModeControl_15_8, MKWORD(rGpioMode));\r\nMKWORD(rGpioDriverEnable) = 0;\r\nrGpioDriverEnable.Enable10 = TRUE;\r\nrGpioDriverEnable.Mask10 = TRUE;\r\nWriteMsaCfg(DSP_GpioDriverEnable_15_8, MKWORD(rGpioDriverEnable));\r\nMKWORD(rGpioOutputData) = 0;\r\nrGpioOutputData.Latch10 = 0;\r\nrGpioOutputData.Mask10 = TRUE;\r\nWriteMsaCfg(DSP_GpioOutputData_15_8, MKWORD(rGpioOutputData));\r\nPRINTK_1(TRACE_TP3780I, "tp3780i::EnableSRAM exit\n");\r\n}\r\nstatic irqreturn_t UartInterrupt(int irq, void *dev_id)\r\n{\r\nPRINTK_3(TRACE_TP3780I,\r\n"tp3780i::UartInterrupt entry irq %x dev_id %p\n", irq, dev_id);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t DspInterrupt(int irq, void *dev_id)\r\n{\r\npMWAVE_DEVICE_DATA pDrvData = &mwave_s_mdd;\r\nDSP_3780I_CONFIG_SETTINGS *pSettings = &pDrvData->rBDData.rDspSettings;\r\nunsigned short usDspBaseIO = pSettings->usDspBaseIO;\r\nunsigned short usIPCSource = 0, usIsolationMask, usPCNum;\r\nPRINTK_3(TRACE_TP3780I,\r\n"tp3780i::DspInterrupt entry irq %x dev_id %p\n", irq, dev_id);\r\nif (dsp3780I_GetIPCSource(usDspBaseIO, &usIPCSource) == 0) {\r\nPRINTK_2(TRACE_TP3780I,\r\n"tp3780i::DspInterrupt, return from dsp3780i_GetIPCSource, usIPCSource %x\n",\r\nusIPCSource);\r\nusIsolationMask = 1;\r\nfor (usPCNum = 1; usPCNum <= 16; usPCNum++) {\r\nif (usIPCSource & usIsolationMask) {\r\nusIPCSource &= ~usIsolationMask;\r\nPRINTK_3(TRACE_TP3780I,\r\n"tp3780i::DspInterrupt usPCNum %x usIPCSource %x\n",\r\nusPCNum, usIPCSource);\r\nif (pDrvData->IPCs[usPCNum - 1].usIntCount == 0) {\r\npDrvData->IPCs[usPCNum - 1].usIntCount = 1;\r\n}\r\nPRINTK_2(TRACE_TP3780I,\r\n"tp3780i::DspInterrupt usIntCount %x\n",\r\npDrvData->IPCs[usPCNum - 1].usIntCount);\r\nif (pDrvData->IPCs[usPCNum - 1].bIsEnabled == TRUE) {\r\nPRINTK_2(TRACE_TP3780I,\r\n"tp3780i::DspInterrupt, waking up usPCNum %x\n",\r\nusPCNum - 1);\r\nwake_up_interruptible(&pDrvData->IPCs[usPCNum - 1].ipc_wait_queue);\r\n} else {\r\nPRINTK_2(TRACE_TP3780I,\r\n"tp3780i::DspInterrupt, no one waiting for IPC %x\n",\r\nusPCNum - 1);\r\n}\r\n}\r\nif (usIPCSource == 0)\r\nbreak;\r\nusIsolationMask = usIsolationMask << 1;\r\n}\r\n} else {\r\nPRINTK_1(TRACE_TP3780I,\r\n"tp3780i::DspInterrupt, return false from dsp3780i_GetIPCSource\n");\r\n}\r\nPRINTK_1(TRACE_TP3780I, "tp3780i::DspInterrupt exit\n");\r\nreturn IRQ_HANDLED;\r\n}\r\nint tp3780I_InitializeBoardData(THINKPAD_BD_DATA * pBDData)\r\n{\r\nint retval = 0;\r\nDSP_3780I_CONFIG_SETTINGS *pSettings = &pBDData->rDspSettings;\r\nPRINTK_2(TRACE_TP3780I, "tp3780i::tp3780I_InitializeBoardData entry pBDData %p\n", pBDData);\r\npBDData->bDSPEnabled = FALSE;\r\npSettings->bInterruptClaimed = FALSE;\r\nretval = smapi_init();\r\nif (retval) {\r\nPRINTK_ERROR(KERN_ERR_MWAVE "tp3780i::tp3780I_InitializeBoardData: Error: SMAPI is not available on this machine\n");\r\n} else {\r\nif (mwave_3780i_irq || mwave_3780i_io || mwave_uart_irq || mwave_uart_io) {\r\nretval = smapi_set_DSP_cfg();\r\n}\r\n}\r\nPRINTK_2(TRACE_TP3780I, "tp3780i::tp3780I_InitializeBoardData exit retval %x\n", retval);\r\nreturn retval;\r\n}\r\nint tp3780I_Cleanup(THINKPAD_BD_DATA * pBDData)\r\n{\r\nint retval = 0;\r\nPRINTK_2(TRACE_TP3780I,\r\n"tp3780i::tp3780I_Cleanup entry and exit pBDData %p\n", pBDData);\r\nreturn retval;\r\n}\r\nint tp3780I_CalcResources(THINKPAD_BD_DATA * pBDData)\r\n{\r\nSMAPI_DSP_SETTINGS rSmapiInfo;\r\nDSP_3780I_CONFIG_SETTINGS *pSettings = &pBDData->rDspSettings;\r\nPRINTK_2(TRACE_TP3780I,\r\n"tp3780i::tp3780I_CalcResources entry pBDData %p\n", pBDData);\r\nif (smapi_query_DSP_cfg(&rSmapiInfo)) {\r\nPRINTK_ERROR(KERN_ERR_MWAVE "tp3780i::tp3780I_CalcResources: Error: Could not query DSP config. Aborting.\n");\r\nreturn -EIO;\r\n}\r\nif (\r\n( rSmapiInfo.usDspIRQ == 0 )\r\n|| ( rSmapiInfo.usDspBaseIO == 0 )\r\n|| ( rSmapiInfo.usUartIRQ == 0 )\r\n|| ( rSmapiInfo.usUartBaseIO == 0 )\r\n) {\r\nPRINTK_ERROR(KERN_ERR_MWAVE "tp3780i::tp3780I_CalcResources: Error: Illegal resource setting. Aborting.\n");\r\nreturn -EIO;\r\n}\r\npSettings->bDSPEnabled = (rSmapiInfo.bDSPEnabled && rSmapiInfo.bDSPPresent);\r\npSettings->bModemEnabled = rSmapiInfo.bModemEnabled;\r\npSettings->usDspIrq = rSmapiInfo.usDspIRQ;\r\npSettings->usDspDma = rSmapiInfo.usDspDMA;\r\npSettings->usDspBaseIO = rSmapiInfo.usDspBaseIO;\r\npSettings->usUartIrq = rSmapiInfo.usUartIRQ;\r\npSettings->usUartBaseIO = rSmapiInfo.usUartBaseIO;\r\npSettings->uDStoreSize = TP_ABILITIES_DATA_SIZE;\r\npSettings->uIStoreSize = TP_ABILITIES_INST_SIZE;\r\npSettings->uIps = TP_ABILITIES_INTS_PER_SEC;\r\nif (pSettings->bDSPEnabled && pSettings->bModemEnabled && pSettings->usDspIrq == pSettings->usUartIrq) {\r\npBDData->bShareDspIrq = pBDData->bShareUartIrq = 1;\r\n} else {\r\npBDData->bShareDspIrq = pBDData->bShareUartIrq = 0;\r\n}\r\nPRINTK_1(TRACE_TP3780I, "tp3780i::tp3780I_CalcResources exit\n");\r\nreturn 0;\r\n}\r\nint tp3780I_ClaimResources(THINKPAD_BD_DATA * pBDData)\r\n{\r\nint retval = 0;\r\nDSP_3780I_CONFIG_SETTINGS *pSettings = &pBDData->rDspSettings;\r\nstruct resource *pres;\r\nPRINTK_2(TRACE_TP3780I,\r\n"tp3780i::tp3780I_ClaimResources entry pBDData %p\n", pBDData);\r\npres = request_region(pSettings->usDspBaseIO, 16, "mwave_3780i");\r\nif ( pres == NULL ) retval = -EIO;\r\nif (retval) {\r\nPRINTK_ERROR(KERN_ERR_MWAVE "tp3780i::tp3780I_ClaimResources: Error: Could not claim I/O region starting at %x\n", pSettings->usDspBaseIO);\r\nretval = -EIO;\r\n}\r\nPRINTK_2(TRACE_TP3780I, "tp3780i::tp3780I_ClaimResources exit retval %x\n", retval);\r\nreturn retval;\r\n}\r\nint tp3780I_ReleaseResources(THINKPAD_BD_DATA * pBDData)\r\n{\r\nint retval = 0;\r\nDSP_3780I_CONFIG_SETTINGS *pSettings = &pBDData->rDspSettings;\r\nPRINTK_2(TRACE_TP3780I,\r\n"tp3780i::tp3780I_ReleaseResources entry pBDData %p\n", pBDData);\r\nrelease_region(pSettings->usDspBaseIO & (~3), 16);\r\nif (pSettings->bInterruptClaimed) {\r\nfree_irq(pSettings->usDspIrq, NULL);\r\npSettings->bInterruptClaimed = FALSE;\r\n}\r\nPRINTK_2(TRACE_TP3780I,\r\n"tp3780i::tp3780I_ReleaseResources exit retval %x\n", retval);\r\nreturn retval;\r\n}\r\nint tp3780I_EnableDSP(THINKPAD_BD_DATA * pBDData)\r\n{\r\nDSP_3780I_CONFIG_SETTINGS *pSettings = &pBDData->rDspSettings;\r\nBOOLEAN bDSPPoweredUp = FALSE, bInterruptAllocated = FALSE;\r\nPRINTK_2(TRACE_TP3780I, "tp3780i::tp3780I_EnableDSP entry pBDData %p\n", pBDData);\r\nif (pBDData->bDSPEnabled) {\r\nPRINTK_ERROR(KERN_ERR_MWAVE "tp3780i::tp3780I_EnableDSP: Error: DSP already enabled!\n");\r\ngoto exit_cleanup;\r\n}\r\nif (!pSettings->bDSPEnabled) {\r\nPRINTK_ERROR(KERN_ERR_MWAVE "tp3780::tp3780I_EnableDSP: Error: pSettings->bDSPEnabled not set\n");\r\ngoto exit_cleanup;\r\n}\r\nif (\r\n(pSettings->usDspIrq >= s_numIrqs)\r\n|| (pSettings->usDspDma >= s_numDmas)\r\n|| (s_ausThinkpadIrqToField[pSettings->usDspIrq] == 0xFFFF)\r\n|| (s_ausThinkpadDmaToField[pSettings->usDspDma] == 0xFFFF)\r\n) {\r\nPRINTK_ERROR(KERN_ERR_MWAVE "tp3780i::tp3780I_EnableDSP: Error: invalid irq %x\n", pSettings->usDspIrq);\r\ngoto exit_cleanup;\r\n}\r\nif (\r\n((pSettings->usDspBaseIO & 0xF00F) != 0)\r\n|| (pSettings->usDspBaseIO & 0x0FF0) == 0\r\n) {\r\nPRINTK_ERROR(KERN_ERR_MWAVE "tp3780i::tp3780I_EnableDSP: Error: Invalid DSP base I/O address %x\n", pSettings->usDspBaseIO);\r\ngoto exit_cleanup;\r\n}\r\nif (pSettings->bModemEnabled) {\r\nif (\r\npSettings->usUartIrq >= s_numIrqs\r\n|| s_ausThinkpadIrqToField[pSettings->usUartIrq] == 0xFFFF\r\n) {\r\nPRINTK_ERROR(KERN_ERR_MWAVE "tp3780i::tp3780I_EnableDSP: Error: Invalid UART IRQ %x\n", pSettings->usUartIrq);\r\ngoto exit_cleanup;\r\n}\r\nswitch (pSettings->usUartBaseIO) {\r\ncase 0x03F8:\r\ncase 0x02F8:\r\ncase 0x03E8:\r\ncase 0x02E8:\r\nbreak;\r\ndefault:\r\nPRINTK_ERROR("tp3780i::tp3780I_EnableDSP: Error: Invalid UART base I/O address %x\n", pSettings->usUartBaseIO);\r\ngoto exit_cleanup;\r\n}\r\n}\r\npSettings->bDspIrqActiveLow = pSettings->bDspIrqPulse = TRUE;\r\npSettings->bUartIrqActiveLow = pSettings->bUartIrqPulse = TRUE;\r\nif (pBDData->bShareDspIrq) {\r\npSettings->bDspIrqActiveLow = FALSE;\r\n}\r\nif (pBDData->bShareUartIrq) {\r\npSettings->bUartIrqActiveLow = FALSE;\r\n}\r\npSettings->usNumTransfers = TP_CFG_NumTransfers;\r\npSettings->usReRequest = TP_CFG_RerequestTimer;\r\npSettings->bEnableMEMCS16 = TP_CFG_MEMCS16;\r\npSettings->usIsaMemCmdWidth = TP_CFG_IsaMemCmdWidth;\r\npSettings->bGateIOCHRDY = TP_CFG_GateIOCHRDY;\r\npSettings->bEnablePwrMgmt = TP_CFG_EnablePwrMgmt;\r\npSettings->usHBusTimerLoadValue = TP_CFG_HBusTimerValue;\r\npSettings->bDisableLBusTimeout = TP_CFG_DisableLBusTimeout;\r\npSettings->usN_Divisor = TP_CFG_N_Divisor;\r\npSettings->usM_Multiplier = TP_CFG_M_Multiplier;\r\npSettings->bPllBypass = TP_CFG_PllBypass;\r\npSettings->usChipletEnable = TP_CFG_ChipletEnable;\r\nif (request_irq(pSettings->usUartIrq, &UartInterrupt, 0, "mwave_uart", NULL)) {\r\nPRINTK_ERROR(KERN_ERR_MWAVE "tp3780i::tp3780I_EnableDSP: Error: Could not get UART IRQ %x\n", pSettings->usUartIrq);\r\ngoto exit_cleanup;\r\n} else {\r\nfree_irq(pSettings->usUartIrq, NULL);\r\n}\r\nif (request_irq(pSettings->usDspIrq, &DspInterrupt, 0, "mwave_3780i", NULL)) {\r\nPRINTK_ERROR("tp3780i::tp3780I_EnableDSP: Error: Could not get 3780i IRQ %x\n", pSettings->usDspIrq);\r\ngoto exit_cleanup;\r\n} else {\r\nPRINTK_3(TRACE_TP3780I,\r\n"tp3780i::tp3780I_EnableDSP, got interrupt %x bShareDspIrq %x\n",\r\npSettings->usDspIrq, pBDData->bShareDspIrq);\r\nbInterruptAllocated = TRUE;\r\npSettings->bInterruptClaimed = TRUE;\r\n}\r\nsmapi_set_DSP_power_state(FALSE);\r\nif (smapi_set_DSP_power_state(TRUE)) {\r\nPRINTK_ERROR(KERN_ERR_MWAVE "tp3780i::tp3780I_EnableDSP: Error: smapi_set_DSP_power_state(TRUE) failed\n");\r\ngoto exit_cleanup;\r\n} else {\r\nbDSPPoweredUp = TRUE;\r\n}\r\nif (dsp3780I_EnableDSP(pSettings, s_ausThinkpadIrqToField, s_ausThinkpadDmaToField)) {\r\nPRINTK_ERROR("tp3780i::tp3780I_EnableDSP: Error: dsp7880I_EnableDSP() failed\n");\r\ngoto exit_cleanup;\r\n}\r\nEnableSRAM(pBDData);\r\npBDData->bDSPEnabled = TRUE;\r\nPRINTK_1(TRACE_TP3780I, "tp3780i::tp3780I_EnableDSP exit\n");\r\nreturn 0;\r\nexit_cleanup:\r\nPRINTK_ERROR("tp3780i::tp3780I_EnableDSP: Cleaning up\n");\r\nif (bDSPPoweredUp)\r\nsmapi_set_DSP_power_state(FALSE);\r\nif (bInterruptAllocated) {\r\nfree_irq(pSettings->usDspIrq, NULL);\r\npSettings->bInterruptClaimed = FALSE;\r\n}\r\nreturn -EIO;\r\n}\r\nint tp3780I_DisableDSP(THINKPAD_BD_DATA * pBDData)\r\n{\r\nint retval = 0;\r\nDSP_3780I_CONFIG_SETTINGS *pSettings = &pBDData->rDspSettings;\r\nPRINTK_2(TRACE_TP3780I, "tp3780i::tp3780I_DisableDSP entry pBDData %p\n", pBDData);\r\nif (pBDData->bDSPEnabled) {\r\ndsp3780I_DisableDSP(&pBDData->rDspSettings);\r\nif (pSettings->bInterruptClaimed) {\r\nfree_irq(pSettings->usDspIrq, NULL);\r\npSettings->bInterruptClaimed = FALSE;\r\n}\r\nsmapi_set_DSP_power_state(FALSE);\r\npBDData->bDSPEnabled = FALSE;\r\n}\r\nPRINTK_2(TRACE_TP3780I, "tp3780i::tp3780I_DisableDSP exit retval %x\n", retval);\r\nreturn retval;\r\n}\r\nint tp3780I_ResetDSP(THINKPAD_BD_DATA * pBDData)\r\n{\r\nint retval = 0;\r\nDSP_3780I_CONFIG_SETTINGS *pSettings = &pBDData->rDspSettings;\r\nPRINTK_2(TRACE_TP3780I, "tp3780i::tp3780I_ResetDSP entry pBDData %p\n",\r\npBDData);\r\nif (dsp3780I_Reset(pSettings) == 0) {\r\nEnableSRAM(pBDData);\r\n} else {\r\nretval = -EIO;\r\n}\r\nPRINTK_2(TRACE_TP3780I, "tp3780i::tp3780I_ResetDSP exit retval %x\n", retval);\r\nreturn retval;\r\n}\r\nint tp3780I_StartDSP(THINKPAD_BD_DATA * pBDData)\r\n{\r\nint retval = 0;\r\nDSP_3780I_CONFIG_SETTINGS *pSettings = &pBDData->rDspSettings;\r\nPRINTK_2(TRACE_TP3780I, "tp3780i::tp3780I_StartDSP entry pBDData %p\n", pBDData);\r\nif (dsp3780I_Run(pSettings) == 0) {\r\n} else {\r\nretval = -EIO;\r\n}\r\nPRINTK_2(TRACE_TP3780I, "tp3780i::tp3780I_StartDSP exit retval %x\n", retval);\r\nreturn retval;\r\n}\r\nint tp3780I_QueryAbilities(THINKPAD_BD_DATA * pBDData, MW_ABILITIES * pAbilities)\r\n{\r\nint retval = 0;\r\nPRINTK_2(TRACE_TP3780I,\r\n"tp3780i::tp3780I_QueryAbilities entry pBDData %p\n", pBDData);\r\npAbilities->instr_per_sec = pBDData->rDspSettings.uIps;\r\npAbilities->data_size = pBDData->rDspSettings.uDStoreSize;\r\npAbilities->inst_size = pBDData->rDspSettings.uIStoreSize;\r\npAbilities->bus_dma_bw = pBDData->rDspSettings.uDmaBandwidth;\r\npAbilities->component_list[0] = 0x00010000 | MW_ADC_MASK;\r\npAbilities->component_list[1] = 0x00010000 | MW_ACI_MASK;\r\npAbilities->component_list[2] = 0x00010000 | MW_AIC1_MASK;\r\npAbilities->component_list[3] = 0x00010000 | MW_AIC2_MASK;\r\npAbilities->component_list[4] = 0x00010000 | MW_CDDAC_MASK;\r\npAbilities->component_list[5] = 0x00010000 | MW_MIDI_MASK;\r\npAbilities->component_list[6] = 0x00010000 | MW_UART_MASK;\r\npAbilities->component_count = 7;\r\nmemcpy(pAbilities->mwave_os_name, TP_ABILITIES_MWAVEOS_NAME,\r\nsizeof(TP_ABILITIES_MWAVEOS_NAME));\r\nmemcpy(pAbilities->bios_task_name, TP_ABILITIES_BIOSTASK_NAME,\r\nsizeof(TP_ABILITIES_BIOSTASK_NAME));\r\nPRINTK_1(TRACE_TP3780I,\r\n"tp3780i::tp3780I_QueryAbilities exit retval=SUCCESSFUL\n");\r\nreturn retval;\r\n}\r\nint tp3780I_ReadWriteDspDStore(THINKPAD_BD_DATA * pBDData, unsigned int uOpcode,\r\nvoid __user *pvBuffer, unsigned int uCount,\r\nunsigned long ulDSPAddr)\r\n{\r\nint retval = 0;\r\nDSP_3780I_CONFIG_SETTINGS *pSettings = &pBDData->rDspSettings;\r\nunsigned short usDspBaseIO = pSettings->usDspBaseIO;\r\nBOOLEAN bRC = 0;\r\nPRINTK_6(TRACE_TP3780I,\r\n"tp3780i::tp3780I_ReadWriteDspDStore entry pBDData %p, uOpcode %x, pvBuffer %p, uCount %x, ulDSPAddr %lx\n",\r\npBDData, uOpcode, pvBuffer, uCount, ulDSPAddr);\r\nif (pBDData->bDSPEnabled) {\r\nswitch (uOpcode) {\r\ncase IOCTL_MW_READ_DATA:\r\nbRC = dsp3780I_ReadDStore(usDspBaseIO, pvBuffer, uCount, ulDSPAddr);\r\nbreak;\r\ncase IOCTL_MW_READCLEAR_DATA:\r\nbRC = dsp3780I_ReadAndClearDStore(usDspBaseIO, pvBuffer, uCount, ulDSPAddr);\r\nbreak;\r\ncase IOCTL_MW_WRITE_DATA:\r\nbRC = dsp3780I_WriteDStore(usDspBaseIO, pvBuffer, uCount, ulDSPAddr);\r\nbreak;\r\n}\r\n}\r\nretval = (bRC) ? -EIO : 0;\r\nPRINTK_2(TRACE_TP3780I, "tp3780i::tp3780I_ReadWriteDspDStore exit retval %x\n", retval);\r\nreturn retval;\r\n}\r\nint tp3780I_ReadWriteDspIStore(THINKPAD_BD_DATA * pBDData, unsigned int uOpcode,\r\nvoid __user *pvBuffer, unsigned int uCount,\r\nunsigned long ulDSPAddr)\r\n{\r\nint retval = 0;\r\nDSP_3780I_CONFIG_SETTINGS *pSettings = &pBDData->rDspSettings;\r\nunsigned short usDspBaseIO = pSettings->usDspBaseIO;\r\nBOOLEAN bRC = 0;\r\nPRINTK_6(TRACE_TP3780I,\r\n"tp3780i::tp3780I_ReadWriteDspIStore entry pBDData %p, uOpcode %x, pvBuffer %p, uCount %x, ulDSPAddr %lx\n",\r\npBDData, uOpcode, pvBuffer, uCount, ulDSPAddr);\r\nif (pBDData->bDSPEnabled) {\r\nswitch (uOpcode) {\r\ncase IOCTL_MW_READ_INST:\r\nbRC = dsp3780I_ReadIStore(usDspBaseIO, pvBuffer, uCount, ulDSPAddr);\r\nbreak;\r\ncase IOCTL_MW_WRITE_INST:\r\nbRC = dsp3780I_WriteIStore(usDspBaseIO, pvBuffer, uCount, ulDSPAddr);\r\nbreak;\r\n}\r\n}\r\nretval = (bRC) ? -EIO : 0;\r\nPRINTK_2(TRACE_TP3780I,\r\n"tp3780i::tp3780I_ReadWriteDspIStore exit retval %x\n", retval);\r\nreturn retval;\r\n}

CsrResult\r\nunifi_net_data_malloc(void *ospriv, bulk_data_desc_t *bulk_data_slot, unsigned int size)\r\n{\r\nstruct sk_buff *skb;\r\nunifi_priv_t *priv = (unifi_priv_t*)ospriv;\r\nint rounded_length;\r\nif (priv->card_info.sdio_block_size == 0) {\r\nunifi_error(priv, "unifi_net_data_malloc: Invalid SDIO block size\n");\r\nreturn CSR_RESULT_FAILURE;\r\n}\r\nrounded_length = (size + priv->card_info.sdio_block_size - 1) & ~(priv->card_info.sdio_block_size - 1);\r\nskb = dev_alloc_skb(rounded_length + 2 + ETH_HLEN + CSR_WIFI_ALIGN_BYTES);\r\nif (! skb) {\r\nunifi_error(ospriv, "alloc_skb failed.\n");\r\nbulk_data_slot->os_net_buf_ptr = NULL;\r\nbulk_data_slot->net_buf_length = 0;\r\nbulk_data_slot->os_data_ptr = NULL;\r\nbulk_data_slot->data_length = 0;\r\nreturn CSR_RESULT_FAILURE;\r\n}\r\nbulk_data_slot->os_net_buf_ptr = (const unsigned char*)skb;\r\nbulk_data_slot->net_buf_length = rounded_length + 2 + ETH_HLEN + CSR_WIFI_ALIGN_BYTES;\r\nbulk_data_slot->os_data_ptr = (const void*)skb->data;\r\nbulk_data_slot->data_length = size;\r\nreturn CSR_RESULT_SUCCESS;\r\n}\r\nvoid\r\nunifi_net_data_free(void *ospriv, bulk_data_desc_t *bulk_data_slot)\r\n{\r\nstruct sk_buff *skb;\r\nCSR_UNUSED(ospriv);\r\nskb = (struct sk_buff *)bulk_data_slot->os_net_buf_ptr;\r\ndev_kfree_skb(skb);\r\nbulk_data_slot->net_buf_length = 0;\r\nbulk_data_slot->data_length = 0;\r\nbulk_data_slot->os_data_ptr = bulk_data_slot->os_net_buf_ptr = NULL;\r\n}\r\nCsrResult\r\nunifi_net_dma_align(void *ospriv, bulk_data_desc_t *bulk_data_slot)\r\n{\r\nstruct sk_buff *skb;\r\nunsigned long buf_address;\r\nint offset;\r\nunifi_priv_t *priv = (unifi_priv_t*)ospriv;\r\nif ((bulk_data_slot == NULL) || (CSR_WIFI_ALIGN_BYTES == 0)) {\r\nreturn CSR_RESULT_SUCCESS;\r\n}\r\nif ((bulk_data_slot->os_data_ptr == NULL) || (bulk_data_slot->data_length == 0)) {\r\nreturn CSR_RESULT_SUCCESS;\r\n}\r\nbuf_address = (unsigned long)(bulk_data_slot->os_data_ptr) & (CSR_WIFI_ALIGN_BYTES - 1);\r\nunifi_trace(priv, UDBG5,\r\n"unifi_net_dma_align: Allign buffer (0x%p) by %d bytes\n",\r\nbulk_data_slot->os_data_ptr, buf_address);\r\noffset = CSR_WIFI_ALIGN_BYTES - buf_address;\r\nif (offset < 0) {\r\nunifi_error(priv, "unifi_net_dma_align: Failed (offset=%d)\n", offset);\r\nreturn CSR_RESULT_FAILURE;\r\n}\r\nskb = (struct sk_buff*)(bulk_data_slot->os_net_buf_ptr);\r\nskb_reserve(skb, offset);\r\nbulk_data_slot->os_net_buf_ptr = (const unsigned char*)skb;\r\nbulk_data_slot->os_data_ptr = (const void*)(skb->data);\r\nreturn CSR_RESULT_SUCCESS;\r\n}\r\nchar* print_time(void )\r\n{\r\nunsigned long long t;\r\nunsigned long nanosec_rem;\r\nt = cpu_clock(printk_cpu);\r\nnanosec_rem = do_div(t, 1000000000);\r\nsprintf(tbuf, "[%5lu.%06lu] ",\r\n(unsigned long) t,\r\nnanosec_rem / 1000);\r\nreturn tbuf;\r\n}\r\nvoid\r\nunifi_error(void* ospriv, const char *fmt, ...)\r\n{\r\nunifi_priv_t *priv = (unifi_priv_t*) ospriv;\r\nchar s[DEBUG_BUFFER_SIZE];\r\nva_list args;\r\nunsigned int len;\r\n#ifdef ANDROID_TIMESTAMP\r\nif (priv != NULL) {\r\nlen = snprintf(s, DEBUG_BUFFER_SIZE, KERN_ERR "%s unifi%d: ", print_time(), priv->instance);\r\n} else {\r\nlen = snprintf(s, DEBUG_BUFFER_SIZE, KERN_ERR "%s unifi: ", print_time());\r\n}\r\n#else\r\nif (priv != NULL) {\r\nlen = snprintf(s, DEBUG_BUFFER_SIZE, KERN_ERR "unifi%d: ", priv->instance);\r\n} else {\r\nlen = snprintf(s, DEBUG_BUFFER_SIZE, KERN_ERR "unifi: ");\r\n}\r\n#endif\r\nFORMAT_TRACE(s, len, args, fmt);\r\nprintk("%s", s);\r\n}\r\nvoid\r\nunifi_warning(void* ospriv, const char *fmt, ...)\r\n{\r\nunifi_priv_t *priv = (unifi_priv_t*) ospriv;\r\nchar s[DEBUG_BUFFER_SIZE];\r\nva_list args;\r\nunsigned int len;\r\n#ifdef ANDROID_TIMESTAMP\r\nif (priv != NULL) {\r\nlen = snprintf(s, DEBUG_BUFFER_SIZE, KERN_WARNING "%s unifi%d: ", print_time(), priv->instance);\r\n} else {\r\nlen = snprintf(s, DEBUG_BUFFER_SIZE, KERN_WARNING "%s unifi: ", print_time());\r\n}\r\n#else\r\nif (priv != NULL) {\r\nlen = snprintf(s, DEBUG_BUFFER_SIZE, KERN_WARNING "unifi%d: ", priv->instance);\r\n} else {\r\nlen = snprintf(s, DEBUG_BUFFER_SIZE, KERN_WARNING "unifi: ");\r\n}\r\n#endif\r\nFORMAT_TRACE(s, len, args, fmt);\r\nprintk("%s", s);\r\n}\r\nvoid\r\nunifi_notice(void* ospriv, const char *fmt, ...)\r\n{\r\nunifi_priv_t *priv = (unifi_priv_t*) ospriv;\r\nchar s[DEBUG_BUFFER_SIZE];\r\nva_list args;\r\nunsigned int len;\r\n#ifdef ANDROID_TIMESTAMP\r\nif (priv != NULL) {\r\nlen = snprintf(s, DEBUG_BUFFER_SIZE, KERN_NOTICE "%s unifi%d: ", print_time(), priv->instance);\r\n} else {\r\nlen = snprintf(s, DEBUG_BUFFER_SIZE, KERN_NOTICE "%s unifi: ", print_time());\r\n}\r\n#else\r\nif (priv != NULL) {\r\nlen = snprintf(s, DEBUG_BUFFER_SIZE, KERN_NOTICE "unifi%d: ", priv->instance);\r\n} else {\r\nlen = snprintf(s, DEBUG_BUFFER_SIZE, KERN_NOTICE "unifi: ");\r\n}\r\n#endif\r\nFORMAT_TRACE(s, len, args, fmt);\r\nprintk("%s", s);\r\n}\r\nvoid\r\nunifi_info(void* ospriv, const char *fmt, ...)\r\n{\r\nunifi_priv_t *priv = (unifi_priv_t*) ospriv;\r\nchar s[DEBUG_BUFFER_SIZE];\r\nva_list args;\r\nunsigned int len;\r\n#ifdef ANDROID_TIMESTAMP\r\nif (priv != NULL) {\r\nlen = snprintf(s, DEBUG_BUFFER_SIZE, KERN_INFO "%s unifi%d: ", print_time(), priv->instance);\r\n} else {\r\nlen = snprintf(s, DEBUG_BUFFER_SIZE, KERN_INFO "%s unifi: ", print_time());\r\n}\r\n#else\r\nif (priv != NULL) {\r\nlen = snprintf(s, DEBUG_BUFFER_SIZE, KERN_INFO "unifi%d: ", priv->instance);\r\n} else {\r\nlen = snprintf(s, DEBUG_BUFFER_SIZE, KERN_INFO "unifi: ");\r\n}\r\n#endif\r\nFORMAT_TRACE(s, len, args, fmt);\r\nprintk("%s", s);\r\n}\r\nvoid\r\nunifi_trace(void* ospriv, int level, const char *fmt, ...)\r\n{\r\nunifi_priv_t *priv = (unifi_priv_t*) ospriv;\r\nchar s[DEBUG_BUFFER_SIZE];\r\nva_list args;\r\nunsigned int len;\r\nif (unifi_debug >= level) {\r\n#ifdef ANDROID_TIMESTAMP\r\nif (priv != NULL) {\r\nlen = snprintf(s, DEBUG_BUFFER_SIZE, KERN_ERR "%s unifi%d: ", print_time(), priv->instance);\r\n} else {\r\nlen = snprintf(s, DEBUG_BUFFER_SIZE, KERN_ERR "%s unifi: ", print_time());\r\n}\r\n#else\r\nif (priv != NULL) {\r\nlen = snprintf(s, DEBUG_BUFFER_SIZE, KERN_ERR "unifi%d: ", priv->instance);\r\n} else {\r\nlen = snprintf(s, DEBUG_BUFFER_SIZE, KERN_ERR "unifi: ");\r\n}\r\n#endif\r\nFORMAT_TRACE(s, len, args, fmt);\r\nprintk("%s", s);\r\n}\r\n}\r\nvoid\r\nunifi_error_nop(void* ospriv, const char *fmt, ...)\r\n{\r\n}\r\nvoid\r\nunifi_trace_nop(void* ospriv, int level, const char *fmt, ...)\r\n{\r\n}\r\nvoid\r\nunifi_dump(void *ospriv, int level, const char *msg, void *mem, u16 len)\r\n{\r\nunifi_priv_t *priv = (unifi_priv_t*) ospriv;\r\nif (unifi_debug >= level) {\r\n#ifdef ANDROID_TIMESTAMP\r\nif (priv != NULL) {\r\nprintk(KERN_ERR "%s unifi%d: --- dump: %s ---\n", print_time(), priv->instance, msg ? msg : "");\r\n} else {\r\nprintk(KERN_ERR "%s unifi: --- dump: %s ---\n", print_time(), msg ? msg : "");\r\n}\r\n#else\r\nif (priv != NULL) {\r\nprintk(KERN_ERR "unifi%d: --- dump: %s ---\n", priv->instance, msg ? msg : "");\r\n} else {\r\nprintk(KERN_ERR "unifi: --- dump: %s ---\n", msg ? msg : "");\r\n}\r\n#endif\r\ndump(mem, len);\r\nif (priv != NULL) {\r\nprintk(KERN_ERR "unifi%d: --- end of dump ---\n", priv->instance);\r\n} else {\r\nprintk(KERN_ERR "unifi: --- end of dump ---\n");\r\n}\r\n}\r\n}\r\nvoid\r\ndump(void *mem, u16 len)\r\n{\r\nint i, col = 0;\r\nunsigned char *pdata = (unsigned char *)mem;\r\n#ifdef ANDROID_TIMESTAMP\r\nprintk("timestamp %s \n", print_time());\r\n#endif\r\nif (mem == NULL) {\r\nprintk("(null dump)\n");\r\nreturn;\r\n}\r\nfor (i = 0; i < len; i++) {\r\nif (col == 0)\r\nprintk("0x%02X: ", i);\r\nprintk(" %02X", pdata[i]);\r\nif (++col == 16) {\r\nprintk("\n");\r\ncol = 0;\r\n}\r\n}\r\nif (col)\r\nprintk("\n");\r\n}\r\nvoid\r\ndump16(void *mem, u16 len)\r\n{\r\nint i, col=0;\r\nunsigned short *p = (unsigned short *)mem;\r\n#ifdef ANDROID_TIMESTAMP\r\nprintk("timestamp %s \n", print_time());\r\n#endif\r\nfor (i = 0; i < len; i+=2) {\r\nif (col == 0)\r\nprintk("0x%02X: ", i);\r\nprintk(" %04X", *p++);\r\nif (++col == 8) {\r\nprintk("\n");\r\ncol = 0;\r\n}\r\n}\r\nif (col)\r\nprintk("\n");\r\n}\r\nvoid\r\ndump_str(void *mem, u16 len)\r\n{\r\nint i;\r\nunsigned char *pdata = (unsigned char *)mem;\r\n#ifdef ANDROID_TIMESTAMP\r\nprintk("timestamp %s \n", print_time());\r\n#endif\r\nfor (i = 0; i < len; i++) {\r\nprintk("%c", pdata[i]);\r\n}\r\nprintk("\n");\r\n}

static void parport_sunbpp_disable_irq(struct parport *p)\r\n{\r\nstruct bpp_regs __iomem *regs = (struct bpp_regs __iomem *)p->base;\r\nu32 tmp;\r\ntmp = sbus_readl(&regs->p_csr);\r\ntmp &= ~DMA_INT_ENAB;\r\nsbus_writel(tmp, &regs->p_csr);\r\n}\r\nstatic void parport_sunbpp_enable_irq(struct parport *p)\r\n{\r\nstruct bpp_regs __iomem *regs = (struct bpp_regs __iomem *)p->base;\r\nu32 tmp;\r\ntmp = sbus_readl(&regs->p_csr);\r\ntmp |= DMA_INT_ENAB;\r\nsbus_writel(tmp, &regs->p_csr);\r\n}\r\nstatic void parport_sunbpp_write_data(struct parport *p, unsigned char d)\r\n{\r\nstruct bpp_regs __iomem *regs = (struct bpp_regs __iomem *)p->base;\r\nsbus_writeb(d, &regs->p_dr);\r\ndprintk((KERN_DEBUG "wrote 0x%x\n", d));\r\n}\r\nstatic unsigned char parport_sunbpp_read_data(struct parport *p)\r\n{\r\nstruct bpp_regs __iomem *regs = (struct bpp_regs __iomem *)p->base;\r\nreturn sbus_readb(&regs->p_dr);\r\n}\r\nstatic unsigned char status_sunbpp_to_pc(struct parport *p)\r\n{\r\nstruct bpp_regs __iomem *regs = (struct bpp_regs __iomem *)p->base;\r\nunsigned char bits = 0;\r\nunsigned char value_tcr = sbus_readb(&regs->p_tcr);\r\nunsigned char value_ir = sbus_readb(&regs->p_ir);\r\nif (!(value_ir & P_IR_ERR))\r\nbits |= PARPORT_STATUS_ERROR;\r\nif (!(value_ir & P_IR_SLCT))\r\nbits |= PARPORT_STATUS_SELECT;\r\nif (!(value_ir & P_IR_PE))\r\nbits |= PARPORT_STATUS_PAPEROUT;\r\nif (value_tcr & P_TCR_ACK)\r\nbits |= PARPORT_STATUS_ACK;\r\nif (!(value_tcr & P_TCR_BUSY))\r\nbits |= PARPORT_STATUS_BUSY;\r\ndprintk((KERN_DEBUG "tcr 0x%x ir 0x%x\n", value_tcr, value_ir));\r\ndprintk((KERN_DEBUG "read status 0x%x\n", bits));\r\nreturn bits;\r\n}\r\nstatic unsigned char control_sunbpp_to_pc(struct parport *p)\r\n{\r\nstruct bpp_regs __iomem *regs = (struct bpp_regs __iomem *)p->base;\r\nunsigned char bits = 0;\r\nunsigned char value_tcr = sbus_readb(&regs->p_tcr);\r\nunsigned char value_or = sbus_readb(&regs->p_or);\r\nif (!(value_tcr & P_TCR_DS))\r\nbits |= PARPORT_CONTROL_STROBE;\r\nif (!(value_or & P_OR_AFXN))\r\nbits |= PARPORT_CONTROL_AUTOFD;\r\nif (!(value_or & P_OR_INIT))\r\nbits |= PARPORT_CONTROL_INIT;\r\nif (value_or & P_OR_SLCT_IN)\r\nbits |= PARPORT_CONTROL_SELECT;\r\ndprintk((KERN_DEBUG "tcr 0x%x or 0x%x\n", value_tcr, value_or));\r\ndprintk((KERN_DEBUG "read control 0x%x\n", bits));\r\nreturn bits;\r\n}\r\nstatic unsigned char parport_sunbpp_read_control(struct parport *p)\r\n{\r\nreturn control_sunbpp_to_pc(p);\r\n}\r\nstatic unsigned char parport_sunbpp_frob_control(struct parport *p,\r\nunsigned char mask,\r\nunsigned char val)\r\n{\r\nstruct bpp_regs __iomem *regs = (struct bpp_regs __iomem *)p->base;\r\nunsigned char value_tcr = sbus_readb(&regs->p_tcr);\r\nunsigned char value_or = sbus_readb(&regs->p_or);\r\ndprintk((KERN_DEBUG "frob1: tcr 0x%x or 0x%x\n",\r\nvalue_tcr, value_or));\r\nif (mask & PARPORT_CONTROL_STROBE) {\r\nif (val & PARPORT_CONTROL_STROBE) {\r\nvalue_tcr &= ~P_TCR_DS;\r\n} else {\r\nvalue_tcr |= P_TCR_DS;\r\n}\r\n}\r\nif (mask & PARPORT_CONTROL_AUTOFD) {\r\nif (val & PARPORT_CONTROL_AUTOFD) {\r\nvalue_or &= ~P_OR_AFXN;\r\n} else {\r\nvalue_or |= P_OR_AFXN;\r\n}\r\n}\r\nif (mask & PARPORT_CONTROL_INIT) {\r\nif (val & PARPORT_CONTROL_INIT) {\r\nvalue_or &= ~P_OR_INIT;\r\n} else {\r\nvalue_or |= P_OR_INIT;\r\n}\r\n}\r\nif (mask & PARPORT_CONTROL_SELECT) {\r\nif (val & PARPORT_CONTROL_SELECT) {\r\nvalue_or |= P_OR_SLCT_IN;\r\n} else {\r\nvalue_or &= ~P_OR_SLCT_IN;\r\n}\r\n}\r\nsbus_writeb(value_or, &regs->p_or);\r\nsbus_writeb(value_tcr, &regs->p_tcr);\r\ndprintk((KERN_DEBUG "frob2: tcr 0x%x or 0x%x\n",\r\nvalue_tcr, value_or));\r\nreturn parport_sunbpp_read_control(p);\r\n}\r\nstatic void parport_sunbpp_write_control(struct parport *p, unsigned char d)\r\n{\r\nconst unsigned char wm = (PARPORT_CONTROL_STROBE |\r\nPARPORT_CONTROL_AUTOFD |\r\nPARPORT_CONTROL_INIT |\r\nPARPORT_CONTROL_SELECT);\r\nparport_sunbpp_frob_control (p, wm, d & wm);\r\n}\r\nstatic unsigned char parport_sunbpp_read_status(struct parport *p)\r\n{\r\nreturn status_sunbpp_to_pc(p);\r\n}\r\nstatic void parport_sunbpp_data_forward (struct parport *p)\r\n{\r\nstruct bpp_regs __iomem *regs = (struct bpp_regs __iomem *)p->base;\r\nunsigned char value_tcr = sbus_readb(&regs->p_tcr);\r\ndprintk((KERN_DEBUG "forward\n"));\r\nvalue_tcr &= ~P_TCR_DIR;\r\nsbus_writeb(value_tcr, &regs->p_tcr);\r\n}\r\nstatic void parport_sunbpp_data_reverse (struct parport *p)\r\n{\r\nstruct bpp_regs __iomem *regs = (struct bpp_regs __iomem *)p->base;\r\nu8 val = sbus_readb(&regs->p_tcr);\r\ndprintk((KERN_DEBUG "reverse\n"));\r\nval |= P_TCR_DIR;\r\nsbus_writeb(val, &regs->p_tcr);\r\n}\r\nstatic void parport_sunbpp_init_state(struct pardevice *dev, struct parport_state *s)\r\n{\r\ns->u.pc.ctr = 0xc;\r\ns->u.pc.ecr = 0x0;\r\n}\r\nstatic void parport_sunbpp_save_state(struct parport *p, struct parport_state *s)\r\n{\r\ns->u.pc.ctr = parport_sunbpp_read_control(p);\r\n}\r\nstatic void parport_sunbpp_restore_state(struct parport *p, struct parport_state *s)\r\n{\r\nparport_sunbpp_write_control(p, s->u.pc.ctr);\r\n}\r\nstatic int bpp_probe(struct platform_device *op)\r\n{\r\nstruct parport_operations *ops;\r\nstruct bpp_regs __iomem *regs;\r\nint irq, dma, err = 0, size;\r\nunsigned char value_tcr;\r\nvoid __iomem *base;\r\nstruct parport *p;\r\nirq = op->archdata.irqs[0];\r\nbase = of_ioremap(&op->resource[0], 0,\r\nresource_size(&op->resource[0]),\r\n"sunbpp");\r\nif (!base)\r\nreturn -ENODEV;\r\nsize = resource_size(&op->resource[0]);\r\ndma = PARPORT_DMA_NONE;\r\nops = kmalloc(sizeof(struct parport_operations), GFP_KERNEL);\r\nif (!ops)\r\ngoto out_unmap;\r\nmemcpy (ops, &parport_sunbpp_ops, sizeof(struct parport_operations));\r\ndprintk(("register_port\n"));\r\nif (!(p = parport_register_port((unsigned long)base, irq, dma, ops)))\r\ngoto out_free_ops;\r\np->size = size;\r\np->dev = &op->dev;\r\nif ((err = request_irq(p->irq, parport_irq_handler,\r\nIRQF_SHARED, p->name, p)) != 0) {\r\ngoto out_put_port;\r\n}\r\nparport_sunbpp_enable_irq(p);\r\nregs = (struct bpp_regs __iomem *)p->base;\r\nvalue_tcr = sbus_readb(&regs->p_tcr);\r\nvalue_tcr &= ~P_TCR_DIR;\r\nsbus_writeb(value_tcr, &regs->p_tcr);\r\nprintk(KERN_INFO "%s: sunbpp at 0x%lx\n", p->name, p->base);\r\ndev_set_drvdata(&op->dev, p);\r\nparport_announce_port(p);\r\nreturn 0;\r\nout_put_port:\r\nparport_put_port(p);\r\nout_free_ops:\r\nkfree(ops);\r\nout_unmap:\r\nof_iounmap(&op->resource[0], base, size);\r\nreturn err;\r\n}\r\nstatic int bpp_remove(struct platform_device *op)\r\n{\r\nstruct parport *p = dev_get_drvdata(&op->dev);\r\nstruct parport_operations *ops = p->ops;\r\nparport_remove_port(p);\r\nif (p->irq != PARPORT_IRQ_NONE) {\r\nparport_sunbpp_disable_irq(p);\r\nfree_irq(p->irq, p);\r\n}\r\nof_iounmap(&op->resource[0], (void __iomem *) p->base, p->size);\r\nparport_put_port(p);\r\nkfree(ops);\r\ndev_set_drvdata(&op->dev, NULL);\r\nreturn 0;\r\n}

static int\r\nrv3029c2_i2c_read_regs(struct i2c_client *client, u8 reg, u8 *buf,\r\nunsigned len)\r\n{\r\nint ret;\r\nif ((reg > RV3029C2_USR1_RAM_PAGE + 7) ||\r\n(reg + len > RV3029C2_USR1_RAM_PAGE + 8))\r\nreturn -EINVAL;\r\nret = i2c_smbus_read_i2c_block_data(client, reg, len, buf);\r\nif (ret < 0)\r\nreturn ret;\r\nif (ret < len)\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic int\r\nrv3029c2_i2c_write_regs(struct i2c_client *client, u8 reg, u8 const buf[],\r\nunsigned len)\r\n{\r\nif ((reg > RV3029C2_USR1_RAM_PAGE + 7) ||\r\n(reg + len > RV3029C2_USR1_RAM_PAGE + 8))\r\nreturn -EINVAL;\r\nreturn i2c_smbus_write_i2c_block_data(client, reg, len, buf);\r\n}\r\nstatic int\r\nrv3029c2_i2c_get_sr(struct i2c_client *client, u8 *buf)\r\n{\r\nint ret = rv3029c2_i2c_read_regs(client, RV3029C2_STATUS, buf, 1);\r\nif (ret < 0)\r\nreturn -EIO;\r\ndev_dbg(&client->dev, "status = 0x%.2x (%d)\n", buf[0], buf[0]);\r\nreturn 0;\r\n}\r\nstatic int\r\nrv3029c2_i2c_set_sr(struct i2c_client *client, u8 val)\r\n{\r\nu8 buf[1];\r\nint sr;\r\nbuf[0] = val;\r\nsr = rv3029c2_i2c_write_regs(client, RV3029C2_STATUS, buf, 1);\r\ndev_dbg(&client->dev, "status = 0x%.2x (%d)\n", buf[0], buf[0]);\r\nif (sr < 0)\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic int\r\nrv3029c2_i2c_read_time(struct i2c_client *client, struct rtc_time *tm)\r\n{\r\nu8 buf[1];\r\nint ret;\r\nu8 regs[RV3029C2_WATCH_SECTION_LEN] = { 0, };\r\nret = rv3029c2_i2c_get_sr(client, buf);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "%s: reading SR failed\n", __func__);\r\nreturn -EIO;\r\n}\r\nret = rv3029c2_i2c_read_regs(client, RV3029C2_W_SEC , regs,\r\nRV3029C2_WATCH_SECTION_LEN);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "%s: reading RTC section failed\n",\r\n__func__);\r\nreturn ret;\r\n}\r\ntm->tm_sec = bcd2bin(regs[RV3029C2_W_SEC-RV3029C2_W_SEC]);\r\ntm->tm_min = bcd2bin(regs[RV3029C2_W_MINUTES-RV3029C2_W_SEC]);\r\n{\r\nconst u8 _hr = regs[RV3029C2_W_HOURS-RV3029C2_W_SEC];\r\nif (_hr & RV3029C2_REG_HR_12_24) {\r\ntm->tm_hour = bcd2bin(_hr & 0x1f);\r\nif (_hr & RV3029C2_REG_HR_PM)\r\ntm->tm_hour += 12;\r\n} else\r\ntm->tm_hour = bcd2bin(_hr & 0x3f);\r\n}\r\ntm->tm_mday = bcd2bin(regs[RV3029C2_W_DATE-RV3029C2_W_SEC]);\r\ntm->tm_mon = bcd2bin(regs[RV3029C2_W_MONTHS-RV3029C2_W_SEC]) - 1;\r\ntm->tm_year = bcd2bin(regs[RV3029C2_W_YEARS-RV3029C2_W_SEC]) + 100;\r\ntm->tm_wday = bcd2bin(regs[RV3029C2_W_DAYS-RV3029C2_W_SEC]) - 1;\r\nreturn 0;\r\n}\r\nstatic int rv3029c2_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nreturn rv3029c2_i2c_read_time(to_i2c_client(dev), tm);\r\n}\r\nstatic int\r\nrv3029c2_i2c_read_alarm(struct i2c_client *client, struct rtc_wkalrm *alarm)\r\n{\r\nstruct rtc_time *const tm = &alarm->time;\r\nint ret;\r\nu8 regs[8];\r\nret = rv3029c2_i2c_get_sr(client, regs);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "%s: reading SR failed\n", __func__);\r\nreturn -EIO;\r\n}\r\nret = rv3029c2_i2c_read_regs(client, RV3029C2_A_SC, regs,\r\nRV3029C2_ALARM_SECTION_LEN);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "%s: reading alarm section failed\n",\r\n__func__);\r\nreturn ret;\r\n}\r\ntm->tm_sec = bcd2bin(regs[RV3029C2_A_SC-RV3029C2_A_SC] & 0x7f);\r\ntm->tm_min = bcd2bin(regs[RV3029C2_A_MN-RV3029C2_A_SC] & 0x7f);\r\ntm->tm_hour = bcd2bin(regs[RV3029C2_A_HR-RV3029C2_A_SC] & 0x3f);\r\ntm->tm_mday = bcd2bin(regs[RV3029C2_A_DT-RV3029C2_A_SC] & 0x3f);\r\ntm->tm_mon = bcd2bin(regs[RV3029C2_A_MO-RV3029C2_A_SC] & 0x1f) - 1;\r\ntm->tm_year = bcd2bin(regs[RV3029C2_A_YR-RV3029C2_A_SC] & 0x7f) + 100;\r\ntm->tm_wday = bcd2bin(regs[RV3029C2_A_DW-RV3029C2_A_SC] & 0x07) - 1;\r\nreturn 0;\r\n}\r\nstatic int\r\nrv3029c2_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alarm)\r\n{\r\nreturn rv3029c2_i2c_read_alarm(to_i2c_client(dev), alarm);\r\n}\r\nstatic int rv3029c2_rtc_i2c_alarm_set_irq(struct i2c_client *client,\r\nint enable)\r\n{\r\nint ret;\r\nu8 buf[1];\r\nret = rv3029c2_i2c_read_regs(client, RV3029C2_IRQ_CTRL, buf, 1);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "can't read INT reg\n");\r\nreturn ret;\r\n}\r\nif (enable)\r\nbuf[0] |= RV3029C2_IRQ_CTRL_AIE;\r\nelse\r\nbuf[0] &= ~RV3029C2_IRQ_CTRL_AIE;\r\nret = rv3029c2_i2c_write_regs(client, RV3029C2_IRQ_CTRL, buf, 1);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "can't set INT reg\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rv3029c2_rtc_i2c_set_alarm(struct i2c_client *client,\r\nstruct rtc_wkalrm *alarm)\r\n{\r\nstruct rtc_time *const tm = &alarm->time;\r\nint ret;\r\nu8 regs[8];\r\nif (tm->tm_year < 100)\r\nreturn -EINVAL;\r\nret = rv3029c2_i2c_get_sr(client, regs);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "%s: reading SR failed\n", __func__);\r\nreturn -EIO;\r\n}\r\nregs[RV3029C2_A_SC-RV3029C2_A_SC] = bin2bcd(tm->tm_sec & 0x7f);\r\nregs[RV3029C2_A_MN-RV3029C2_A_SC] = bin2bcd(tm->tm_min & 0x7f);\r\nregs[RV3029C2_A_HR-RV3029C2_A_SC] = bin2bcd(tm->tm_hour & 0x3f);\r\nregs[RV3029C2_A_DT-RV3029C2_A_SC] = bin2bcd(tm->tm_mday & 0x3f);\r\nregs[RV3029C2_A_MO-RV3029C2_A_SC] = bin2bcd((tm->tm_mon & 0x1f) - 1);\r\nregs[RV3029C2_A_DW-RV3029C2_A_SC] = bin2bcd((tm->tm_wday & 7) - 1);\r\nregs[RV3029C2_A_YR-RV3029C2_A_SC] = bin2bcd((tm->tm_year & 0x7f) - 100);\r\nret = rv3029c2_i2c_write_regs(client, RV3029C2_A_SC, regs,\r\nRV3029C2_ALARM_SECTION_LEN);\r\nif (ret < 0)\r\nreturn ret;\r\nif (alarm->enabled) {\r\nu8 buf[1];\r\nret = rv3029c2_i2c_read_regs(client, RV3029C2_IRQ_FLAGS,\r\nbuf, 1);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "can't read alarm flag\n");\r\nreturn ret;\r\n}\r\nbuf[0] &= ~RV3029C2_IRQ_FLAGS_AF;\r\nret = rv3029c2_i2c_write_regs(client, RV3029C2_IRQ_FLAGS,\r\nbuf, 1);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "can't set alarm flag\n");\r\nreturn ret;\r\n}\r\nret = rv3029c2_rtc_i2c_alarm_set_irq(client, 1);\r\nif (ret)\r\nreturn ret;\r\ndev_dbg(&client->dev, "alarm IRQ armed\n");\r\n} else {\r\nret = rv3029c2_rtc_i2c_alarm_set_irq(client, 1);\r\nif (ret)\r\nreturn ret;\r\ndev_dbg(&client->dev, "alarm IRQ disabled\n");\r\n}\r\nreturn 0;\r\n}\r\nstatic int rv3029c2_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alarm)\r\n{\r\nreturn rv3029c2_rtc_i2c_set_alarm(to_i2c_client(dev), alarm);\r\n}\r\nstatic int\r\nrv3029c2_i2c_set_time(struct i2c_client *client, struct rtc_time const *tm)\r\n{\r\nu8 regs[8];\r\nint ret;\r\nif (tm->tm_year < 100)\r\nreturn -EINVAL;\r\nregs[RV3029C2_W_SEC-RV3029C2_W_SEC] = bin2bcd(tm->tm_sec);\r\nregs[RV3029C2_W_MINUTES-RV3029C2_W_SEC] = bin2bcd(tm->tm_min);\r\nregs[RV3029C2_W_HOURS-RV3029C2_W_SEC] = bin2bcd(tm->tm_hour);\r\nregs[RV3029C2_W_DATE-RV3029C2_W_SEC] = bin2bcd(tm->tm_mday);\r\nregs[RV3029C2_W_MONTHS-RV3029C2_W_SEC] = bin2bcd(tm->tm_mon+1);\r\nregs[RV3029C2_W_DAYS-RV3029C2_W_SEC] = bin2bcd((tm->tm_wday & 7)+1);\r\nregs[RV3029C2_W_YEARS-RV3029C2_W_SEC] = bin2bcd(tm->tm_year - 100);\r\nret = rv3029c2_i2c_write_regs(client, RV3029C2_W_SEC, regs,\r\nRV3029C2_WATCH_SECTION_LEN);\r\nif (ret < 0)\r\nreturn ret;\r\nret = rv3029c2_i2c_get_sr(client, regs);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "%s: reading SR failed\n", __func__);\r\nreturn ret;\r\n}\r\nret = rv3029c2_i2c_set_sr(client, (regs[0] & ~RV3029C2_STATUS_PON));\r\nif (ret < 0) {\r\ndev_err(&client->dev, "%s: reading SR failed\n", __func__);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rv3029c2_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nreturn rv3029c2_i2c_set_time(to_i2c_client(dev), tm);\r\n}\r\nstatic int rv3029c2_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct rtc_device *rtc;\r\nint rc = 0;\r\nu8 buf[1];\r\nif (!i2c_check_functionality(client->adapter, I2C_FUNC_SMBUS_EMUL))\r\nreturn -ENODEV;\r\nrtc = rtc_device_register(client->name,\r\n&client->dev, &rv3029c2_rtc_ops,\r\nTHIS_MODULE);\r\nif (IS_ERR(rtc))\r\nreturn PTR_ERR(rtc);\r\ni2c_set_clientdata(client, rtc);\r\nrc = rv3029c2_i2c_get_sr(client, buf);\r\nif (rc < 0) {\r\ndev_err(&client->dev, "reading status failed\n");\r\ngoto exit_unregister;\r\n}\r\nreturn 0;\r\nexit_unregister:\r\nrtc_device_unregister(rtc);\r\nreturn rc;\r\n}\r\nstatic int rv3029c2_remove(struct i2c_client *client)\r\n{\r\nstruct rtc_device *rtc = i2c_get_clientdata(client);\r\nrtc_device_unregister(rtc);\r\nreturn 0;\r\n}

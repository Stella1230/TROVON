unsigned char vrtc_cmos_read(unsigned char reg)\r\n{\r\nunsigned char retval;\r\nif (reg > 0xd || !vrtc_virt_base)\r\nreturn 0xff;\r\nlock_cmos_prefix(reg);\r\nretval = __raw_readb(vrtc_virt_base + (reg << 2));\r\nlock_cmos_suffix(reg);\r\nreturn retval;\r\n}\r\nvoid vrtc_cmos_write(unsigned char val, unsigned char reg)\r\n{\r\nif (reg > 0xd || !vrtc_virt_base)\r\nreturn;\r\nlock_cmos_prefix(reg);\r\n__raw_writeb(val, vrtc_virt_base + (reg << 2));\r\nlock_cmos_suffix(reg);\r\n}\r\nunsigned long vrtc_get_time(void)\r\n{\r\nu8 sec, min, hour, mday, mon;\r\nunsigned long flags;\r\nu32 year;\r\nspin_lock_irqsave(&rtc_lock, flags);\r\nwhile ((vrtc_cmos_read(RTC_FREQ_SELECT) & RTC_UIP))\r\ncpu_relax();\r\nsec = vrtc_cmos_read(RTC_SECONDS);\r\nmin = vrtc_cmos_read(RTC_MINUTES);\r\nhour = vrtc_cmos_read(RTC_HOURS);\r\nmday = vrtc_cmos_read(RTC_DAY_OF_MONTH);\r\nmon = vrtc_cmos_read(RTC_MONTH);\r\nyear = vrtc_cmos_read(RTC_YEAR);\r\nspin_unlock_irqrestore(&rtc_lock, flags);\r\nyear += 1972;\r\nprintk(KERN_INFO "vRTC: sec: %d min: %d hour: %d day: %d "\r\n"mon: %d year: %d\n", sec, min, hour, mday, mon, year);\r\nreturn mktime(year, mon, mday, hour, min, sec);\r\n}\r\nint vrtc_set_mmss(unsigned long nowtime)\r\n{\r\nint real_sec, real_min;\r\nunsigned long flags;\r\nint vrtc_min;\r\nspin_lock_irqsave(&rtc_lock, flags);\r\nvrtc_min = vrtc_cmos_read(RTC_MINUTES);\r\nreal_sec = nowtime % 60;\r\nreal_min = nowtime / 60;\r\nif (((abs(real_min - vrtc_min) + 15)/30) & 1)\r\nreal_min += 30;\r\nreal_min %= 60;\r\nvrtc_cmos_write(real_sec, RTC_SECONDS);\r\nvrtc_cmos_write(real_min, RTC_MINUTES);\r\nspin_unlock_irqrestore(&rtc_lock, flags);\r\nreturn 0;\r\n}\r\nvoid __init mrst_rtc_init(void)\r\n{\r\nunsigned long vrtc_paddr;\r\nsfi_table_parse(SFI_SIG_MRTC, NULL, NULL, sfi_parse_mrtc);\r\nvrtc_paddr = sfi_mrtc_array[0].phys_addr;\r\nif (!sfi_mrtc_num || !vrtc_paddr)\r\nreturn;\r\nvrtc_virt_base = (void __iomem *)set_fixmap_offset_nocache(FIX_LNW_VRTC,\r\nvrtc_paddr);\r\nx86_platform.get_wallclock = vrtc_get_time;\r\nx86_platform.set_wallclock = vrtc_set_mmss;\r\n}\r\nstatic int __init mrst_device_create(void)\r\n{\r\nif (!mrst_identify_cpu())\r\nreturn -ENODEV;\r\nif (!sfi_mrtc_num)\r\nreturn -ENODEV;\r\nvrtc_resources[0].start = sfi_mrtc_array[0].phys_addr;\r\nvrtc_resources[0].end = sfi_mrtc_array[0].phys_addr +\r\nMRST_VRTC_MAP_SZ;\r\nvrtc_resources[1].start = sfi_mrtc_array[0].irq;\r\nvrtc_resources[1].end = sfi_mrtc_array[0].irq;\r\nreturn platform_device_register(&vrtc_device);\r\n}

static int delkin_cb_init_chipset(struct pci_dev *dev)\r\n{\r\nunsigned long base = pci_resource_start(dev, 0);\r\nint i;\r\noutb(0x02, base + 0x1e);\r\ninb(base + 0x17);\r\nfor (i = 0; i < sizeof(setup); ++i) {\r\nif (setup[i])\r\noutb(setup[i], base + i);\r\n}\r\nreturn 0;\r\n}\r\nstatic int delkin_cb_probe(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nstruct ide_host *host;\r\nunsigned long base;\r\nint rc;\r\nstruct ide_hw hw, *hws[] = { &hw };\r\nrc = pci_enable_device(dev);\r\nif (rc) {\r\nprintk(KERN_ERR "delkin_cb: pci_enable_device failed (%d)\n", rc);\r\nreturn rc;\r\n}\r\nrc = pci_request_regions(dev, "delkin_cb");\r\nif (rc) {\r\nprintk(KERN_ERR "delkin_cb: pci_request_regions failed (%d)\n", rc);\r\npci_disable_device(dev);\r\nreturn rc;\r\n}\r\nbase = pci_resource_start(dev, 0);\r\ndelkin_cb_init_chipset(dev);\r\nmemset(&hw, 0, sizeof(hw));\r\nide_std_init_ports(&hw, base + 0x10, base + 0x1e);\r\nhw.irq = dev->irq;\r\nhw.dev = &dev->dev;\r\nrc = ide_host_add(&delkin_cb_port_info, hws, 1, &host);\r\nif (rc)\r\ngoto out_disable;\r\npci_set_drvdata(dev, host);\r\nreturn 0;\r\nout_disable:\r\npci_release_regions(dev);\r\npci_disable_device(dev);\r\nreturn rc;\r\n}\r\nstatic void\r\ndelkin_cb_remove (struct pci_dev *dev)\r\n{\r\nstruct ide_host *host = pci_get_drvdata(dev);\r\nide_host_remove(host);\r\npci_release_regions(dev);\r\npci_disable_device(dev);\r\n}\r\nstatic int delkin_cb_suspend(struct pci_dev *dev, pm_message_t state)\r\n{\r\npci_save_state(dev);\r\npci_disable_device(dev);\r\npci_set_power_state(dev, pci_choose_state(dev, state));\r\nreturn 0;\r\n}\r\nstatic int delkin_cb_resume(struct pci_dev *dev)\r\n{\r\nstruct ide_host *host = pci_get_drvdata(dev);\r\nint rc;\r\npci_set_power_state(dev, PCI_D0);\r\nrc = pci_enable_device(dev);\r\nif (rc)\r\nreturn rc;\r\npci_restore_state(dev);\r\npci_set_master(dev);\r\nif (host->init_chipset)\r\nhost->init_chipset(dev);\r\nreturn 0;\r\n}\r\nstatic int __init delkin_cb_init(void)\r\n{\r\nreturn pci_register_driver(&delkin_cb_pci_driver);\r\n}\r\nstatic void __exit delkin_cb_exit(void)\r\n{\r\npci_unregister_driver(&delkin_cb_pci_driver);\r\n}

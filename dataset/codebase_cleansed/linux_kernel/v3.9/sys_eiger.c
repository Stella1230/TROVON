static inline void\r\neiger_update_irq_hw(unsigned long irq, unsigned long mask)\r\n{\r\nint regaddr;\r\nmask = (irq >= 64 ? mask << 16 : mask >> ((irq - 16) & 0x30));\r\nregaddr = 0x510 + (((irq - 16) >> 2) & 0x0c);\r\noutl(mask & 0xffff0000UL, regaddr);\r\n}\r\nstatic inline void\r\neiger_enable_irq(struct irq_data *d)\r\n{\r\nunsigned int irq = d->irq;\r\nunsigned long mask;\r\nmask = (cached_irq_mask[irq >= 64] &= ~(1UL << (irq & 63)));\r\neiger_update_irq_hw(irq, mask);\r\n}\r\nstatic void\r\neiger_disable_irq(struct irq_data *d)\r\n{\r\nunsigned int irq = d->irq;\r\nunsigned long mask;\r\nmask = (cached_irq_mask[irq >= 64] |= 1UL << (irq & 63));\r\neiger_update_irq_hw(irq, mask);\r\n}\r\nstatic void\r\neiger_device_interrupt(unsigned long vector)\r\n{\r\nunsigned intstatus;\r\nintstatus = inw(0x500) & 15;\r\nif (intstatus) {\r\nif (intstatus & 8) handle_irq(16+3);\r\nif (intstatus & 4) handle_irq(16+2);\r\nif (intstatus & 2) handle_irq(16+1);\r\nif (intstatus & 1) handle_irq(16+0);\r\n} else {\r\nisa_device_interrupt(vector);\r\n}\r\n}\r\nstatic void\r\neiger_srm_device_interrupt(unsigned long vector)\r\n{\r\nint irq = (vector - 0x800) >> 4;\r\nhandle_irq(irq);\r\n}\r\nstatic void __init\r\neiger_init_irq(void)\r\n{\r\nlong i;\r\noutb(0, DMA1_RESET_REG);\r\noutb(0, DMA2_RESET_REG);\r\noutb(DMA_MODE_CASCADE, DMA2_MODE_REG);\r\noutb(0, DMA2_MASK_REG);\r\nif (alpha_using_srm)\r\nalpha_mv.device_interrupt = eiger_srm_device_interrupt;\r\nfor (i = 16; i < 128; i += 16)\r\neiger_update_irq_hw(i, -1);\r\ninit_i8259a_irqs();\r\nfor (i = 16; i < 128; ++i) {\r\nirq_set_chip_and_handler(i, &eiger_irq_type, handle_level_irq);\r\nirq_set_status_flags(i, IRQ_LEVEL);\r\n}\r\n}\r\nstatic int __init\r\neiger_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nu8 irq_orig;\r\npci_read_config_byte(dev, PCI_INTERRUPT_LINE, &irq_orig);\r\nreturn irq_orig - 0x80;\r\n}\r\nstatic u8 __init\r\neiger_swizzle(struct pci_dev *dev, u8 *pinp)\r\n{\r\nstruct pci_controller *hose = dev->sysdata;\r\nint slot, pin = *pinp;\r\nint bridge_count = 0;\r\nint backplane = inw(0x502) & 0x0f;\r\nswitch (backplane)\r\n{\r\ncase 0x00: bridge_count = 0; break;\r\ncase 0x01: bridge_count = 1; break;\r\ncase 0x03: bridge_count = 2; break;\r\ncase 0x07: bridge_count = 3; break;\r\ncase 0x0f: bridge_count = 4; break;\r\n};\r\nslot = PCI_SLOT(dev->devfn);\r\nwhile (dev->bus->self) {\r\nif (hose->index == 0\r\n&& (PCI_SLOT(dev->bus->self->devfn)\r\n> 20 - bridge_count)) {\r\nslot = PCI_SLOT(dev->devfn);\r\nbreak;\r\n}\r\npin = pci_swizzle_interrupt_pin(dev, pin);\r\ndev = dev->bus->self;\r\n}\r\n*pinp = pin;\r\nreturn slot;\r\n}

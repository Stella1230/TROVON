static void ali_start(void)\r\n{\r\nu32 val;\r\nspin_lock(&ali_lock);\r\npci_read_config_dword(ali_pci, 0xCC, &val);\r\nval &= ~0x3F;\r\nval |= (1 << 25) | ali_timeout_bits;\r\npci_write_config_dword(ali_pci, 0xCC, val);\r\nspin_unlock(&ali_lock);\r\n}\r\nstatic void ali_stop(void)\r\n{\r\nu32 val;\r\nspin_lock(&ali_lock);\r\npci_read_config_dword(ali_pci, 0xCC, &val);\r\nval &= ~0x3F;\r\nval &= ~(1 << 25);\r\npci_write_config_dword(ali_pci, 0xCC, val);\r\nspin_unlock(&ali_lock);\r\n}\r\nstatic void ali_keepalive(void)\r\n{\r\nali_start();\r\n}\r\nstatic int ali_settimer(int t)\r\n{\r\nif (t < 0)\r\nreturn -EINVAL;\r\nelse if (t < 60)\r\nali_timeout_bits = t|(1 << 6);\r\nelse if (t < 3600)\r\nali_timeout_bits = (t / 60)|(1 << 7);\r\nelse if (t < 18000)\r\nali_timeout_bits = (t / 300)|(1 << 6)|(1 << 7);\r\nelse\r\nreturn -EINVAL;\r\ntimeout = t;\r\nreturn 0;\r\n}\r\nstatic ssize_t ali_write(struct file *file, const char __user *data,\r\nsize_t len, loff_t *ppos)\r\n{\r\nif (len) {\r\nif (!nowayout) {\r\nsize_t i;\r\nali_expect_release = 0;\r\nfor (i = 0; i != len; i++) {\r\nchar c;\r\nif (get_user(c, data + i))\r\nreturn -EFAULT;\r\nif (c == 'V')\r\nali_expect_release = 42;\r\n}\r\n}\r\nali_start();\r\n}\r\nreturn len;\r\n}\r\nstatic long ali_ioctl(struct file *file, unsigned int cmd, unsigned long arg)\r\n{\r\nvoid __user *argp = (void __user *)arg;\r\nint __user *p = argp;\r\nstatic const struct watchdog_info ident = {\r\n.options = WDIOF_KEEPALIVEPING |\r\nWDIOF_SETTIMEOUT |\r\nWDIOF_MAGICCLOSE,\r\n.firmware_version = 0,\r\n.identity = "ALi M1535 WatchDog Timer",\r\n};\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nreturn copy_to_user(argp, &ident, sizeof(ident)) ? -EFAULT : 0;\r\ncase WDIOC_GETSTATUS:\r\ncase WDIOC_GETBOOTSTATUS:\r\nreturn put_user(0, p);\r\ncase WDIOC_SETOPTIONS:\r\n{\r\nint new_options, retval = -EINVAL;\r\nif (get_user(new_options, p))\r\nreturn -EFAULT;\r\nif (new_options & WDIOS_DISABLECARD) {\r\nali_stop();\r\nretval = 0;\r\n}\r\nif (new_options & WDIOS_ENABLECARD) {\r\nali_start();\r\nretval = 0;\r\n}\r\nreturn retval;\r\n}\r\ncase WDIOC_KEEPALIVE:\r\nali_keepalive();\r\nreturn 0;\r\ncase WDIOC_SETTIMEOUT:\r\n{\r\nint new_timeout;\r\nif (get_user(new_timeout, p))\r\nreturn -EFAULT;\r\nif (ali_settimer(new_timeout))\r\nreturn -EINVAL;\r\nali_keepalive();\r\n}\r\ncase WDIOC_GETTIMEOUT:\r\nreturn put_user(timeout, p);\r\ndefault:\r\nreturn -ENOTTY;\r\n}\r\n}\r\nstatic int ali_open(struct inode *inode, struct file *file)\r\n{\r\nif (test_and_set_bit(0, &ali_is_open))\r\nreturn -EBUSY;\r\nali_start();\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic int ali_release(struct inode *inode, struct file *file)\r\n{\r\nif (ali_expect_release == 42)\r\nali_stop();\r\nelse {\r\npr_crit("Unexpected close, not stopping watchdog!\n");\r\nali_keepalive();\r\n}\r\nclear_bit(0, &ali_is_open);\r\nali_expect_release = 0;\r\nreturn 0;\r\n}\r\nstatic int ali_notify_sys(struct notifier_block *this,\r\nunsigned long code, void *unused)\r\n{\r\nif (code == SYS_DOWN || code == SYS_HALT)\r\nali_stop();\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int __init ali_find_watchdog(void)\r\n{\r\nstruct pci_dev *pdev;\r\nu32 wdog;\r\npdev = pci_get_device(PCI_VENDOR_ID_AL, 0x1535, NULL);\r\nif (pdev == NULL)\r\npdev = pci_get_device(PCI_VENDOR_ID_AL, 0x1533, NULL);\r\nif (pdev == NULL)\r\nreturn -ENODEV;\r\npci_dev_put(pdev);\r\npdev = pci_get_device(PCI_VENDOR_ID_AL, 0x7101, NULL);\r\nif (pdev == NULL)\r\nreturn -ENODEV;\r\nif (pci_enable_device(pdev)) {\r\npci_dev_put(pdev);\r\nreturn -EIO;\r\n}\r\nali_pci = pdev;\r\npci_read_config_dword(pdev, 0xCC, &wdog);\r\nwdog &= ~0x3F;\r\nwdog &= ~((1 << 27)|(1 << 26)|(1 << 25)|(1 << 24));\r\nwdog &= ~((1 << 16)|(1 << 13)|(1 << 12)|(1 << 11)|(1 << 10)|(1 << 9));\r\npci_write_config_dword(pdev, 0xCC, wdog);\r\nreturn 0;\r\n}\r\nstatic int __init watchdog_init(void)\r\n{\r\nint ret;\r\nif (ali_find_watchdog() != 0)\r\nreturn -ENODEV;\r\nif (timeout < 1 || timeout >= 18000) {\r\ntimeout = WATCHDOG_TIMEOUT;\r\npr_info("timeout value must be 0 < timeout < 18000, using %d\n",\r\ntimeout);\r\n}\r\nali_settimer(timeout);\r\nret = register_reboot_notifier(&ali_notifier);\r\nif (ret != 0) {\r\npr_err("cannot register reboot notifier (err=%d)\n", ret);\r\ngoto out;\r\n}\r\nret = misc_register(&ali_miscdev);\r\nif (ret != 0) {\r\npr_err("cannot register miscdev on minor=%d (err=%d)\n",\r\nWATCHDOG_MINOR, ret);\r\ngoto unreg_reboot;\r\n}\r\npr_info("initialized. timeout=%d sec (nowayout=%d)\n",\r\ntimeout, nowayout);\r\nout:\r\nreturn ret;\r\nunreg_reboot:\r\nunregister_reboot_notifier(&ali_notifier);\r\ngoto out;\r\n}\r\nstatic void __exit watchdog_exit(void)\r\n{\r\nali_stop();\r\nmisc_deregister(&ali_miscdev);\r\nunregister_reboot_notifier(&ali_notifier);\r\npci_dev_put(ali_pci);\r\n}

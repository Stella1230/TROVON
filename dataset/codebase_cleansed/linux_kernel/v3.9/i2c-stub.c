static s32 stub_xfer(struct i2c_adapter *adap, u16 addr, unsigned short flags,\r\nchar read_write, u8 command, int size, union i2c_smbus_data *data)\r\n{\r\ns32 ret;\r\nint i, len;\r\nstruct stub_chip *chip = NULL;\r\nfor (i = 0; i < MAX_CHIPS && chip_addr[i]; i++) {\r\nif (addr == chip_addr[i]) {\r\nchip = stub_chips + i;\r\nbreak;\r\n}\r\n}\r\nif (!chip)\r\nreturn -ENODEV;\r\nswitch (size) {\r\ncase I2C_SMBUS_QUICK:\r\ndev_dbg(&adap->dev, "smbus quick - addr 0x%02x\n", addr);\r\nret = 0;\r\nbreak;\r\ncase I2C_SMBUS_BYTE:\r\nif (read_write == I2C_SMBUS_WRITE) {\r\nchip->pointer = command;\r\ndev_dbg(&adap->dev,\r\n"smbus byte - addr 0x%02x, wrote 0x%02x.\n",\r\naddr, command);\r\n} else {\r\ndata->byte = chip->words[chip->pointer++] & 0xff;\r\ndev_dbg(&adap->dev,\r\n"smbus byte - addr 0x%02x, read 0x%02x.\n",\r\naddr, data->byte);\r\n}\r\nret = 0;\r\nbreak;\r\ncase I2C_SMBUS_BYTE_DATA:\r\nif (read_write == I2C_SMBUS_WRITE) {\r\nchip->words[command] &= 0xff00;\r\nchip->words[command] |= data->byte;\r\ndev_dbg(&adap->dev,\r\n"smbus byte data - addr 0x%02x, wrote 0x%02x at 0x%02x.\n",\r\naddr, data->byte, command);\r\n} else {\r\ndata->byte = chip->words[command] & 0xff;\r\ndev_dbg(&adap->dev,\r\n"smbus byte data - addr 0x%02x, read 0x%02x at 0x%02x.\n",\r\naddr, data->byte, command);\r\n}\r\nchip->pointer = command + 1;\r\nret = 0;\r\nbreak;\r\ncase I2C_SMBUS_WORD_DATA:\r\nif (read_write == I2C_SMBUS_WRITE) {\r\nchip->words[command] = data->word;\r\ndev_dbg(&adap->dev,\r\n"smbus word data - addr 0x%02x, wrote 0x%04x at 0x%02x.\n",\r\naddr, data->word, command);\r\n} else {\r\ndata->word = chip->words[command];\r\ndev_dbg(&adap->dev,\r\n"smbus word data - addr 0x%02x, read 0x%04x at 0x%02x.\n",\r\naddr, data->word, command);\r\n}\r\nret = 0;\r\nbreak;\r\ncase I2C_SMBUS_I2C_BLOCK_DATA:\r\nlen = data->block[0];\r\nif (read_write == I2C_SMBUS_WRITE) {\r\nfor (i = 0; i < len; i++) {\r\nchip->words[command + i] &= 0xff00;\r\nchip->words[command + i] |= data->block[1 + i];\r\n}\r\ndev_dbg(&adap->dev,\r\n"i2c block data - addr 0x%02x, wrote %d bytes at 0x%02x.\n",\r\naddr, len, command);\r\n} else {\r\nfor (i = 0; i < len; i++) {\r\ndata->block[1 + i] =\r\nchip->words[command + i] & 0xff;\r\n}\r\ndev_dbg(&adap->dev,\r\n"i2c block data - addr 0x%02x, read %d bytes at 0x%02x.\n",\r\naddr, len, command);\r\n}\r\nret = 0;\r\nbreak;\r\ndefault:\r\ndev_dbg(&adap->dev, "Unsupported I2C/SMBus command\n");\r\nret = -EOPNOTSUPP;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic u32 stub_func(struct i2c_adapter *adapter)\r\n{\r\nreturn STUB_FUNC & functionality;\r\n}\r\nstatic int __init i2c_stub_init(void)\r\n{\r\nint i, ret;\r\nif (!chip_addr[0]) {\r\npr_err("i2c-stub: Please specify a chip address\n");\r\nreturn -ENODEV;\r\n}\r\nfor (i = 0; i < MAX_CHIPS && chip_addr[i]; i++) {\r\nif (chip_addr[i] < 0x03 || chip_addr[i] > 0x77) {\r\npr_err("i2c-stub: Invalid chip address 0x%02x\n",\r\nchip_addr[i]);\r\nreturn -EINVAL;\r\n}\r\npr_info("i2c-stub: Virtual chip at 0x%02x\n", chip_addr[i]);\r\n}\r\nstub_chips = kzalloc(i * sizeof(struct stub_chip), GFP_KERNEL);\r\nif (!stub_chips) {\r\npr_err("i2c-stub: Out of memory\n");\r\nreturn -ENOMEM;\r\n}\r\nret = i2c_add_adapter(&stub_adapter);\r\nif (ret)\r\nkfree(stub_chips);\r\nreturn ret;\r\n}\r\nstatic void __exit i2c_stub_exit(void)\r\n{\r\ni2c_del_adapter(&stub_adapter);\r\nkfree(stub_chips);\r\n}

static int wl1273_fm_read_reg(struct wl1273_core *core, u8 reg, u16 *value)\r\n{\r\nstruct i2c_client *client = core->client;\r\nu8 b[2];\r\nint r;\r\nr = i2c_smbus_read_i2c_block_data(client, reg, sizeof(b), b);\r\nif (r != 2) {\r\ndev_err(&client->dev, "%s: Read: %d fails.\n", __func__, reg);\r\nreturn -EREMOTEIO;\r\n}\r\n*value = (u16)b[0] << 8 | b[1];\r\nreturn 0;\r\n}\r\nstatic int wl1273_fm_write_cmd(struct wl1273_core *core, u8 cmd, u16 param)\r\n{\r\nstruct i2c_client *client = core->client;\r\nu8 buf[] = { (param >> 8) & 0xff, param & 0xff };\r\nint r;\r\nr = i2c_smbus_write_i2c_block_data(client, cmd, sizeof(buf), buf);\r\nif (r) {\r\ndev_err(&client->dev, "%s: Cmd: %d fails.\n", __func__, cmd);\r\nreturn r;\r\n}\r\nreturn 0;\r\n}\r\nstatic int wl1273_fm_write_data(struct wl1273_core *core, u8 *data, u16 len)\r\n{\r\nstruct i2c_client *client = core->client;\r\nstruct i2c_msg msg;\r\nint r;\r\nmsg.addr = client->addr;\r\nmsg.flags = 0;\r\nmsg.buf = data;\r\nmsg.len = len;\r\nr = i2c_transfer(client->adapter, &msg, 1);\r\nif (r != 1) {\r\ndev_err(&client->dev, "%s: write error.\n", __func__);\r\nreturn -EREMOTEIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int wl1273_fm_set_audio(struct wl1273_core *core, unsigned int new_mode)\r\n{\r\nint r = 0;\r\nif (core->mode == WL1273_MODE_OFF ||\r\ncore->mode == WL1273_MODE_SUSPENDED)\r\nreturn -EPERM;\r\nif (core->mode == WL1273_MODE_RX && new_mode == WL1273_AUDIO_DIGITAL) {\r\nr = wl1273_fm_write_cmd(core, WL1273_PCM_MODE_SET,\r\nWL1273_PCM_DEF_MODE);\r\nif (r)\r\ngoto out;\r\nr = wl1273_fm_write_cmd(core, WL1273_I2S_MODE_CONFIG_SET,\r\ncore->i2s_mode);\r\nif (r)\r\ngoto out;\r\nr = wl1273_fm_write_cmd(core, WL1273_AUDIO_ENABLE,\r\nWL1273_AUDIO_ENABLE_I2S);\r\nif (r)\r\ngoto out;\r\n} else if (core->mode == WL1273_MODE_RX &&\r\nnew_mode == WL1273_AUDIO_ANALOG) {\r\nr = wl1273_fm_write_cmd(core, WL1273_AUDIO_ENABLE,\r\nWL1273_AUDIO_ENABLE_ANALOG);\r\nif (r)\r\ngoto out;\r\n} else if (core->mode == WL1273_MODE_TX &&\r\nnew_mode == WL1273_AUDIO_DIGITAL) {\r\nr = wl1273_fm_write_cmd(core, WL1273_I2S_MODE_CONFIG_SET,\r\ncore->i2s_mode);\r\nif (r)\r\ngoto out;\r\nr = wl1273_fm_write_cmd(core, WL1273_AUDIO_IO_SET,\r\nWL1273_AUDIO_IO_SET_I2S);\r\nif (r)\r\ngoto out;\r\n} else if (core->mode == WL1273_MODE_TX &&\r\nnew_mode == WL1273_AUDIO_ANALOG) {\r\nr = wl1273_fm_write_cmd(core, WL1273_AUDIO_IO_SET,\r\nWL1273_AUDIO_IO_SET_ANALOG);\r\nif (r)\r\ngoto out;\r\n}\r\ncore->audio_mode = new_mode;\r\nout:\r\nreturn r;\r\n}\r\nstatic int wl1273_fm_set_volume(struct wl1273_core *core, unsigned int volume)\r\n{\r\nint r;\r\nif (volume > WL1273_MAX_VOLUME)\r\nreturn -EINVAL;\r\nif (core->volume == volume)\r\nreturn 0;\r\nr = wl1273_fm_write_cmd(core, WL1273_VOLUME_SET, volume);\r\nif (r)\r\nreturn r;\r\ncore->volume = volume;\r\nreturn 0;\r\n}\r\nstatic int wl1273_core_remove(struct i2c_client *client)\r\n{\r\nstruct wl1273_core *core = i2c_get_clientdata(client);\r\ndev_dbg(&client->dev, "%s\n", __func__);\r\nmfd_remove_devices(&client->dev);\r\nkfree(core);\r\nreturn 0;\r\n}\r\nstatic int wl1273_core_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct wl1273_fm_platform_data *pdata = client->dev.platform_data;\r\nstruct wl1273_core *core;\r\nstruct mfd_cell *cell;\r\nint children = 0;\r\nint r = 0;\r\ndev_dbg(&client->dev, "%s\n", __func__);\r\nif (!pdata) {\r\ndev_err(&client->dev, "No platform data.\n");\r\nreturn -EINVAL;\r\n}\r\nif (!(pdata->children & WL1273_RADIO_CHILD)) {\r\ndev_err(&client->dev, "Cannot function without radio child.\n");\r\nreturn -EINVAL;\r\n}\r\ncore = kzalloc(sizeof(*core), GFP_KERNEL);\r\nif (!core)\r\nreturn -ENOMEM;\r\ncore->pdata = pdata;\r\ncore->client = client;\r\nmutex_init(&core->lock);\r\ni2c_set_clientdata(client, core);\r\ndev_dbg(&client->dev, "%s: Have V4L2.\n", __func__);\r\ncell = &core->cells[children];\r\ncell->name = "wl1273_fm_radio";\r\ncell->platform_data = &core;\r\ncell->pdata_size = sizeof(core);\r\nchildren++;\r\ncore->read = wl1273_fm_read_reg;\r\ncore->write = wl1273_fm_write_cmd;\r\ncore->write_data = wl1273_fm_write_data;\r\ncore->set_audio = wl1273_fm_set_audio;\r\ncore->set_volume = wl1273_fm_set_volume;\r\nif (pdata->children & WL1273_CODEC_CHILD) {\r\ncell = &core->cells[children];\r\ndev_dbg(&client->dev, "%s: Have codec.\n", __func__);\r\ncell->name = "wl1273-codec";\r\ncell->platform_data = &core;\r\ncell->pdata_size = sizeof(core);\r\nchildren++;\r\n}\r\ndev_dbg(&client->dev, "%s: number of children: %d.\n",\r\n__func__, children);\r\nr = mfd_add_devices(&client->dev, -1, core->cells,\r\nchildren, NULL, 0, NULL);\r\nif (r)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\npdata->free_resources();\r\nkfree(core);\r\ndev_dbg(&client->dev, "%s\n", __func__);\r\nreturn r;\r\n}\r\nstatic int __init wl1273_core_init(void)\r\n{\r\nint r;\r\nr = i2c_add_driver(&wl1273_core_driver);\r\nif (r) {\r\npr_err(WL1273_FM_DRIVER_NAME\r\n": driver registration failed\n");\r\nreturn r;\r\n}\r\nreturn r;\r\n}\r\nstatic void __exit wl1273_core_exit(void)\r\n{\r\ni2c_del_driver(&wl1273_core_driver);\r\n}

static void addi_eeprom_clk_93c76(unsigned long iobase, unsigned int val)\r\n{\r\noutl(val & ~EE93C76_CLK_BIT, iobase);\r\nudelay(100);\r\noutl(val | EE93C76_CLK_BIT, iobase);\r\nudelay(100);\r\n}\r\nstatic unsigned int addi_eeprom_cmd_93c76(unsigned long iobase,\r\nunsigned int cmd,\r\nunsigned char len)\r\n{\r\nunsigned int val = EE93C76_CS_BIT;\r\nint i;\r\noutl(val, iobase);\r\nudelay(100);\r\nfor (i = (len - 1); i >= 0; i--) {\r\nif (cmd & (1 << i))\r\nval |= EE93C76_DOUT_BIT;\r\nelse\r\nval &= ~EE93C76_DOUT_BIT;\r\noutl(val, iobase);\r\nudelay(100);\r\naddi_eeprom_clk_93c76(iobase, val);\r\n}\r\nreturn val;\r\n}\r\nstatic unsigned short addi_eeprom_readw_93c76(unsigned long iobase,\r\nunsigned short addr)\r\n{\r\nunsigned short val = 0;\r\nunsigned int cmd;\r\nunsigned int tmp;\r\nint i;\r\ncmd = EE93C76_READ_CMD | (addr / 2);\r\ncmd = addi_eeprom_cmd_93c76(iobase, cmd, EE93C76_CMD_LEN);\r\nfor (i = 0; i < 16; i++) {\r\naddi_eeprom_clk_93c76(iobase, cmd);\r\ntmp = inl(iobase);\r\nudelay(100);\r\nval <<= 1;\r\nif (tmp & EE93C76_DIN_BIT)\r\nval |= 0x1;\r\n}\r\noutl(0, iobase);\r\nudelay(100);\r\nreturn val;\r\n}\r\nstatic void addi_eeprom_nvram_wait(unsigned long iobase)\r\n{\r\nunsigned char val;\r\ndo {\r\nval = inb(iobase + AMCC_OP_REG_MCSR_NVCMD);\r\n} while (val & 0x80);\r\n}\r\nstatic unsigned short addi_eeprom_readw_nvram(unsigned long iobase,\r\nunsigned short addr)\r\n{\r\nunsigned short val = 0;\r\nunsigned char tmp;\r\nunsigned char i;\r\nfor (i = 0; i < 2; i++) {\r\noutb(NVCMD_LOAD_LOW, iobase + AMCC_OP_REG_MCSR_NVCMD);\r\naddi_eeprom_nvram_wait(iobase);\r\noutb((addr + i) & 0xff, iobase + AMCC_OP_REG_MCSR_NVDATA);\r\naddi_eeprom_nvram_wait(iobase);\r\noutb(NVCMD_LOAD_HIGH, iobase + AMCC_OP_REG_MCSR_NVCMD);\r\naddi_eeprom_nvram_wait(iobase);\r\noutb(((addr + i) >> 8) & 0xff,\r\niobase + AMCC_OP_REG_MCSR_NVDATA);\r\naddi_eeprom_nvram_wait(iobase);\r\noutb(NVCMD_BEGIN_READ, iobase + AMCC_OP_REG_MCSR_NVCMD);\r\naddi_eeprom_nvram_wait(iobase);\r\ntmp = inb(iobase + AMCC_OP_REG_MCSR_NVDATA);\r\naddi_eeprom_nvram_wait(iobase);\r\nif (i == 0)\r\nval |= tmp;\r\nelse\r\nval |= (tmp << 8);\r\n}\r\nreturn val;\r\n}\r\nstatic unsigned short addi_eeprom_readw(unsigned long iobase,\r\nchar *type,\r\nunsigned short addr)\r\n{\r\nunsigned short val = 0;\r\naddr += NVRAM_USER_DATA_START;\r\nif (!strcmp(type, "S5920") || !strcmp(type, "S5933"))\r\nval = addi_eeprom_readw_nvram(iobase, addr);\r\nif (!strcmp(type, "93C76"))\r\nval = addi_eeprom_readw_93c76(iobase, addr);\r\nreturn val;\r\n}\r\nstatic void addi_eeprom_read_di_info(struct comedi_device *dev,\r\nunsigned long iobase,\r\nunsigned short addr)\r\n{\r\nconst struct addi_board *this_board = comedi_board(dev);\r\nstruct addi_private *devpriv = dev->private;\r\nchar *type = this_board->pc_EepromChip;\r\nunsigned short tmp;\r\ntmp = addi_eeprom_readw(iobase, type, addr + 6);\r\ndevpriv->s_EeParameters.i_NbrDiChannel = tmp;\r\ntmp = addi_eeprom_readw(iobase, type, addr + 8);\r\ntmp = (tmp >> 7) & 0x01;\r\ntmp = addi_eeprom_readw(iobase, type, addr + 10);\r\n}\r\nstatic void addi_eeprom_read_do_info(struct comedi_device *dev,\r\nunsigned long iobase,\r\nunsigned short addr)\r\n{\r\nconst struct addi_board *this_board = comedi_board(dev);\r\nstruct addi_private *devpriv = dev->private;\r\nchar *type = this_board->pc_EepromChip;\r\nunsigned short tmp;\r\ntmp = addi_eeprom_readw(iobase, type, addr + 6);\r\ndevpriv->s_EeParameters.i_NbrDoChannel = tmp;\r\ndevpriv->s_EeParameters.i_DoMaxdata = 0xffffffff >> (32 - tmp);\r\n}\r\nstatic void addi_eeprom_read_timer_info(struct comedi_device *dev,\r\nunsigned long iobase,\r\nunsigned short addr)\r\n{\r\nstruct addi_private *devpriv = dev->private;\r\n#if 0\r\nconst struct addi_board *this_board = comedi_board(dev);\r\nchar *type = this_board->pc_EepromChip;\r\nunsigned short offset = 0;\r\nunsigned short ntimers;\r\nunsigned short tmp;\r\nint i;\r\nntimers = addi_eeprom_readw(iobase, type, addr + 6);\r\nfor (i = 0; i < ntimers; i++) {\r\nunsigned short size;\r\nunsigned short res;\r\nunsigned short mode;\r\nunsigned short min_timing;\r\nunsigned short timebase;\r\nsize = addi_eeprom_readw(iobase, type, addr + 8 + offset + 0);\r\ntmp = addi_eeprom_readw(iobase, type, addr + 8 + offset + 2);\r\nres = (tmp >> 10) & 0x3f;\r\nmode = (tmp >> 4) & 0x3f;\r\ntmp = addi_eeprom_readw(iobase, type, addr + 8 + offset + 4);\r\nmin_timing = (tmp >> 6) & 0x3ff;\r\nTimebase = tmp & 0x3f;\r\noffset += size;\r\n}\r\n#endif\r\ndevpriv->s_EeParameters.i_Timer = 1;\r\n}\r\nstatic void addi_eeprom_read_ao_info(struct comedi_device *dev,\r\nunsigned long iobase,\r\nunsigned short addr)\r\n{\r\nconst struct addi_board *this_board = comedi_board(dev);\r\nstruct addi_private *devpriv = dev->private;\r\nchar *type = this_board->pc_EepromChip;\r\nunsigned short tmp;\r\ntmp = addi_eeprom_readw(iobase, type, addr + 10);\r\ndevpriv->s_EeParameters.i_NbrAoChannel = (tmp >> 4) & 0x3ff;\r\ntmp = addi_eeprom_readw(iobase, type, addr + 16);\r\ntmp = (tmp >> 8) & 0xff;\r\ndevpriv->s_EeParameters.i_AoMaxdata = 0xfff >> (16 - tmp);\r\n}\r\nstatic void addi_eeprom_read_ai_info(struct comedi_device *dev,\r\nunsigned long iobase,\r\nunsigned short addr)\r\n{\r\nconst struct addi_board *this_board = comedi_board(dev);\r\nstruct addi_private *devpriv = dev->private;\r\nchar *type = this_board->pc_EepromChip;\r\nunsigned short offset;\r\nunsigned short tmp;\r\ntmp = addi_eeprom_readw(iobase, type, addr + 10);\r\ndevpriv->s_EeParameters.i_NbrAiChannel = (tmp >> 4) & 0x3ff;\r\nif (!strcmp(this_board->pc_DriverName, "apci3200"))\r\ndevpriv->s_EeParameters.i_NbrAiChannel *= 4;\r\ntmp = addi_eeprom_readw(iobase, type, addr + 16);\r\ndevpriv->s_EeParameters.ui_MinAcquisitiontimeNs = tmp * 1000;\r\ntmp = addi_eeprom_readw(iobase, type, addr + 30);\r\ndevpriv->s_EeParameters.ui_MinDelaytimeNs = tmp * 1000;\r\ntmp = addi_eeprom_readw(iobase, type, addr + 20);\r\ndevpriv->s_EeParameters.i_Dma = (tmp >> 13) & 0x01;\r\ntmp = addi_eeprom_readw(iobase, type, addr + 72) & 0xff;\r\nif (tmp) {\r\noffset = 74 + (2 * tmp) + (10 * (1 + (tmp / 16)));\r\n} else {\r\noffset = 74;\r\n}\r\ntmp = addi_eeprom_readw(iobase, type, addr + offset + 2) & 0x1f;\r\ndevpriv->s_EeParameters.i_AiMaxdata = 0xffff >> (16 - tmp);\r\n}\r\nstatic void addi_eeprom_read_info(struct comedi_device *dev,\r\nunsigned long iobase)\r\n{\r\nconst struct addi_board *this_board = comedi_board(dev);\r\nchar *type = this_board->pc_EepromChip;\r\nunsigned short size;\r\nunsigned char nfuncs;\r\nint i;\r\nsize = addi_eeprom_readw(iobase, type, 8);\r\nnfuncs = addi_eeprom_readw(iobase, type, 10) & 0xff;\r\nfor (i = 0; i < nfuncs; i++) {\r\nunsigned short offset = i * 4;\r\nunsigned short addr;\r\nunsigned char func;\r\nfunc = addi_eeprom_readw(iobase, type, 12 + offset) & 0x3f;\r\naddr = addi_eeprom_readw(iobase, type, 14 + offset);\r\nswitch (func) {\r\ncase EEPROM_DIGITALINPUT:\r\naddi_eeprom_read_di_info(dev, iobase, addr);\r\nbreak;\r\ncase EEPROM_DIGITALOUTPUT:\r\naddi_eeprom_read_do_info(dev, iobase, addr);\r\nbreak;\r\ncase EEPROM_ANALOGINPUT:\r\naddi_eeprom_read_ai_info(dev, iobase, addr);\r\nbreak;\r\ncase EEPROM_ANALOGOUTPUT:\r\naddi_eeprom_read_ao_info(dev, iobase, addr);\r\nbreak;\r\ncase EEPROM_TIMER:\r\ncase EEPROM_WATCHDOG:\r\ncase EEPROM_TIMER_WATCHDOG_COUNTER:\r\naddi_eeprom_read_timer_info(dev, iobase, addr);\r\nbreak;\r\n}\r\n}\r\n}

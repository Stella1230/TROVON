void flush_icache_page(struct vm_area_struct *vma, struct page *page)\r\n{\r\nunsigned long start = page_to_phys(page);\r\nunsigned long flags;\r\nflags = smp_lock_cache();\r\nmn10300_local_dcache_flush_page(start);\r\nmn10300_local_icache_inv_page(start);\r\nsmp_cache_call(SMP_IDCACHE_INV_FLUSH_RANGE, start, start + PAGE_SIZE);\r\nsmp_unlock_cache(flags);\r\n}\r\nstatic void flush_icache_page_range(unsigned long start, unsigned long end)\r\n{\r\nunsigned long addr, size, off;\r\nstruct page *page;\r\npgd_t *pgd;\r\npud_t *pud;\r\npmd_t *pmd;\r\npte_t *ppte, pte;\r\noff = start & ~PAGE_MASK;\r\nsize = end - start;\r\npgd = pgd_offset(current->mm, start);\r\nif (!pgd || !pgd_val(*pgd))\r\nreturn;\r\npud = pud_offset(pgd, start);\r\nif (!pud || !pud_val(*pud))\r\nreturn;\r\npmd = pmd_offset(pud, start);\r\nif (!pmd || !pmd_val(*pmd))\r\nreturn;\r\nppte = pte_offset_map(pmd, start);\r\nif (!ppte)\r\nreturn;\r\npte = *ppte;\r\npte_unmap(ppte);\r\nif (pte_none(pte))\r\nreturn;\r\npage = pte_page(pte);\r\nif (!page)\r\nreturn;\r\naddr = page_to_phys(page);\r\nmn10300_local_dcache_flush_range2(addr + off, size);\r\nmn10300_local_icache_inv_range2(addr + off, size);\r\nsmp_cache_call(SMP_IDCACHE_INV_FLUSH_RANGE, start, end);\r\n}\r\nvoid flush_icache_range(unsigned long start, unsigned long end)\r\n{\r\nunsigned long start_page, end_page;\r\nunsigned long flags;\r\nflags = smp_lock_cache();\r\nif (end > 0x80000000UL) {\r\nif (end > 0xa0000000UL) {\r\nend = 0xa0000000UL;\r\nif (start >= end)\r\ngoto done;\r\n}\r\nstart_page = (start >= 0x80000000UL) ? start : 0x80000000UL;\r\nmn10300_local_dcache_flush_range(start_page, end);\r\nmn10300_local_icache_inv_range(start_page, end);\r\nsmp_cache_call(SMP_IDCACHE_INV_FLUSH_RANGE, start_page, end);\r\nif (start_page == start)\r\ngoto done;\r\nend = start_page;\r\n}\r\nstart_page = start & PAGE_MASK;\r\nend_page = (end - 1) & PAGE_MASK;\r\nif (start_page == end_page) {\r\nflush_icache_page_range(start, end);\r\n} else if (start_page + 1 == end_page) {\r\nflush_icache_page_range(start, end_page);\r\nflush_icache_page_range(end_page, end);\r\n} else {\r\nmn10300_dcache_flush();\r\nmn10300_icache_inv();\r\nsmp_cache_call(SMP_IDCACHE_INV_FLUSH, 0, 0);\r\n}\r\ndone:\r\nsmp_unlock_cache(flags);\r\n}

static int i_APCI1710_InsnConfigDigitalIO(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct addi_private *devpriv = dev->private;\r\nunsigned char b_ModulNbr, b_ChannelAMode, b_ChannelBMode;\r\nunsigned char b_MemoryOnOff, b_ConfigType;\r\nint i_ReturnValue = 0;\r\nunsigned int dw_WriteConfig = 0;\r\nb_ModulNbr = (unsigned char) CR_AREF(insn->chanspec);\r\nb_ConfigType = (unsigned char) data[0];\r\nb_ChannelAMode = (unsigned char) data[1];\r\nb_ChannelBMode = (unsigned char) data[2];\r\nb_MemoryOnOff = (unsigned char) data[1];\r\ni_ReturnValue = insn->n;\r\nif (b_ModulNbr >= 4) {\r\nDPRINTK("Module Number invalid\n");\r\ni_ReturnValue = -2;\r\nreturn i_ReturnValue;\r\n}\r\nswitch (b_ConfigType) {\r\ncase APCI1710_DIGIO_MEMORYONOFF:\r\nif (b_MemoryOnOff)\r\n{\r\ndevpriv->s_ModuleInfo[b_ModulNbr].\r\ns_DigitalIOInfo.b_OutputMemoryEnabled = 1;\r\ndevpriv->s_ModuleInfo[b_ModulNbr].\r\ns_DigitalIOInfo.dw_OutputMemory = 0;\r\n} else\r\n{\r\ndevpriv->s_ModuleInfo[b_ModulNbr].\r\ns_DigitalIOInfo.b_OutputMemoryEnabled = 0;\r\n}\r\nbreak;\r\ncase APCI1710_DIGIO_INIT:\r\nif ((devpriv->s_BoardInfos.\r\ndw_MolduleConfiguration[b_ModulNbr] &\r\n0xFFFF0000UL) == APCI1710_DIGITAL_IO) {\r\nif ((b_ChannelAMode == 0) || (b_ChannelAMode == 1)) {\r\nif ((b_ChannelBMode == 0)\r\n|| (b_ChannelBMode == 1)) {\r\ndevpriv->s_ModuleInfo[b_ModulNbr].\r\ns_DigitalIOInfo.b_DigitalInit =\r\n1;\r\ndevpriv->s_ModuleInfo[b_ModulNbr].\r\ns_DigitalIOInfo.\r\nb_ChannelAMode = b_ChannelAMode;\r\ndevpriv->s_ModuleInfo[b_ModulNbr].\r\ns_DigitalIOInfo.\r\nb_ChannelBMode = b_ChannelBMode;\r\ndw_WriteConfig =\r\n(unsigned int) (b_ChannelAMode |\r\n(b_ChannelBMode * 2));\r\noutl(dw_WriteConfig,\r\ndevpriv->s_BoardInfos.\r\nui_Address + 4 +\r\n(64 * b_ModulNbr));\r\n} else {\r\nDPRINTK("Bi-directional channel B configuration error\n");\r\ni_ReturnValue = -5;\r\n}\r\n} else {\r\nDPRINTK("Bi-directional channel A configuration error\n");\r\ni_ReturnValue = -4;\r\n}\r\n} else {\r\nDPRINTK("The module is not a digital I/O module\n");\r\ni_ReturnValue = -3;\r\n}\r\n}\r\nprintk("Return Value %d\n", i_ReturnValue);\r\nreturn i_ReturnValue;\r\n}\r\nstatic int i_APCI1710_InsnReadDigitalIOChlValue(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct addi_private *devpriv = dev->private;\r\nint i_ReturnValue = 0;\r\nunsigned int dw_StatusReg;\r\nunsigned char b_ModulNbr, b_InputChannel;\r\nunsigned char *pb_ChannelStatus;\r\nb_ModulNbr = (unsigned char) CR_AREF(insn->chanspec);\r\nb_InputChannel = (unsigned char) CR_CHAN(insn->chanspec);\r\ndata[0] = 0;\r\npb_ChannelStatus = (unsigned char *) &data[0];\r\ni_ReturnValue = insn->n;\r\nif (b_ModulNbr < 4) {\r\nif ((devpriv->s_BoardInfos.\r\ndw_MolduleConfiguration[b_ModulNbr] &\r\n0xFFFF0000UL) == APCI1710_DIGITAL_IO) {\r\nif (b_InputChannel <= 6) {\r\nif (devpriv->s_ModuleInfo[b_ModulNbr].\r\ns_DigitalIOInfo.b_DigitalInit == 1) {\r\nif (b_InputChannel > 4) {\r\nif (b_InputChannel == 5) {\r\nif (devpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_DigitalIOInfo.\r\nb_ChannelAMode\r\n!= 0) {\r\ni_ReturnValue =\r\n-6;\r\n}\r\n}\r\nelse {\r\nif (devpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_DigitalIOInfo.\r\nb_ChannelBMode\r\n!= 0) {\r\ni_ReturnValue =\r\n-7;\r\n}\r\n}\r\n}\r\nif (i_ReturnValue >= 0) {\r\ndw_StatusReg =\r\ninl(devpriv->\r\ns_BoardInfos.\r\nui_Address +\r\n(64 * b_ModulNbr));\r\n*pb_ChannelStatus =\r\n(unsigned char) ((dw_StatusReg ^\r\n0x1C) >>\r\nb_InputChannel) & 1;\r\n}\r\n} else {\r\nDPRINTK("Digital I/O not initialised\n");\r\ni_ReturnValue = -5;\r\n}\r\n} else {\r\nDPRINTK("Selected digital input error\n");\r\ni_ReturnValue = -4;\r\n}\r\n} else {\r\nDPRINTK("The module is not a digital I/O module\n");\r\ni_ReturnValue = -3;\r\n}\r\n} else {\r\nDPRINTK("Module number error\n");\r\ni_ReturnValue = -2;\r\n}\r\nreturn i_ReturnValue;\r\n}\r\nstatic int i_APCI1710_InsnWriteDigitalIOChlOnOff(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct addi_private *devpriv = dev->private;\r\nint i_ReturnValue = 0;\r\nunsigned int dw_WriteValue = 0;\r\nunsigned char b_ModulNbr, b_OutputChannel;\r\ni_ReturnValue = insn->n;\r\nb_ModulNbr = CR_AREF(insn->chanspec);\r\nb_OutputChannel = CR_CHAN(insn->chanspec);\r\nif (b_ModulNbr < 4) {\r\nif ((devpriv->s_BoardInfos.\r\ndw_MolduleConfiguration[b_ModulNbr] &\r\n0xFFFF0000UL) == APCI1710_DIGITAL_IO) {\r\nif (devpriv->s_ModuleInfo[b_ModulNbr].\r\ns_DigitalIOInfo.b_DigitalInit == 1) {\r\nswitch (b_OutputChannel) {\r\ncase 0:\r\nbreak;\r\ncase 1:\r\nif (devpriv->s_ModuleInfo[b_ModulNbr].\r\ns_DigitalIOInfo.\r\nb_ChannelAMode != 1) {\r\ni_ReturnValue = -6;\r\n}\r\nbreak;\r\ncase 2:\r\nif (devpriv->s_ModuleInfo[b_ModulNbr].\r\ns_DigitalIOInfo.\r\nb_ChannelBMode != 1) {\r\ni_ReturnValue = -7;\r\n}\r\nbreak;\r\ndefault:\r\ni_ReturnValue = -4;\r\nbreak;\r\n}\r\nif (i_ReturnValue >= 0) {\r\nif (data[0]) {\r\nif (devpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_DigitalIOInfo.\r\nb_OutputMemoryEnabled ==\r\n1) {\r\ndw_WriteValue =\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_DigitalIOInfo.\r\ndw_OutputMemory\r\n| (1 <<\r\nb_OutputChannel);\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_DigitalIOInfo.\r\ndw_OutputMemory\r\n= dw_WriteValue;\r\n} else {\r\ndw_WriteValue =\r\n1 <<\r\nb_OutputChannel;\r\n}\r\n}\r\nelse {\r\nif (devpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_DigitalIOInfo.\r\nb_OutputMemoryEnabled ==\r\n1) {\r\ndw_WriteValue =\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_DigitalIOInfo.\r\ndw_OutputMemory\r\n& (0xFFFFFFFFUL\r\n-\r\n(1 << b_OutputChannel));\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_DigitalIOInfo.\r\ndw_OutputMemory\r\n= dw_WriteValue;\r\n} else {\r\ni_ReturnValue = -8;\r\n}\r\n}\r\n*/\r\noutl(dw_WriteValue,\r\ndevpriv->s_BoardInfos.\r\nui_Address + (64 * b_ModulNbr));\r\n}\r\n} else {\r\ni_ReturnValue = -5;\r\n}\r\n} else {\r\ni_ReturnValue = -3;\r\n}\r\n} else {\r\ni_ReturnValue = -2;\r\n}\r\nreturn i_ReturnValue;\r\n}\r\nstatic int i_APCI1710_InsnBitsDigitalIOPortOnOff(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct addi_private *devpriv = dev->private;\r\nint i_ReturnValue = 0;\r\nunsigned int dw_WriteValue = 0;\r\nunsigned int dw_StatusReg;\r\nunsigned char b_ModulNbr, b_PortValue;\r\nunsigned char b_PortOperation, b_PortOnOFF;\r\nunsigned char *pb_PortValue;\r\nb_ModulNbr = (unsigned char) CR_AREF(insn->chanspec);\r\nb_PortOperation = (unsigned char) data[0];\r\nb_PortOnOFF = (unsigned char) data[1];\r\nb_PortValue = (unsigned char) data[2];\r\ni_ReturnValue = insn->n;\r\npb_PortValue = (unsigned char *) &data[0];\r\nswitch (b_PortOperation) {\r\ncase APCI1710_INPUT:\r\nif (b_ModulNbr < 4) {\r\nif ((devpriv->s_BoardInfos.\r\ndw_MolduleConfiguration[b_ModulNbr] &\r\n0xFFFF0000UL) == APCI1710_DIGITAL_IO) {\r\nif (devpriv->s_ModuleInfo[b_ModulNbr].\r\ns_DigitalIOInfo.b_DigitalInit == 1) {\r\ndw_StatusReg =\r\ninl(devpriv->s_BoardInfos.\r\nui_Address + (64 * b_ModulNbr));\r\n*pb_PortValue =\r\n(unsigned char) (dw_StatusReg ^ 0x1C);\r\n} else {\r\ni_ReturnValue = -4;\r\n}\r\n} else {\r\ni_ReturnValue = -3;\r\n}\r\n} else {\r\ni_ReturnValue = -2;\r\n}\r\nbreak;\r\ncase APCI1710_OUTPUT:\r\nif (b_ModulNbr < 4) {\r\nif ((devpriv->s_BoardInfos.\r\ndw_MolduleConfiguration[b_ModulNbr] &\r\n0xFFFF0000UL) == APCI1710_DIGITAL_IO) {\r\nif (devpriv->s_ModuleInfo[b_ModulNbr].\r\ns_DigitalIOInfo.b_DigitalInit == 1) {\r\nif (b_PortValue <= 7) {\r\nif ((b_PortValue & 2) == 2) {\r\nif (devpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_DigitalIOInfo.\r\nb_ChannelAMode\r\n!= 1) {\r\ni_ReturnValue =\r\n-6;\r\n}\r\n}\r\nif ((b_PortValue & 4) == 4) {\r\nif (devpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_DigitalIOInfo.\r\nb_ChannelBMode\r\n!= 1) {\r\ni_ReturnValue =\r\n-7;\r\n}\r\n}\r\nif (i_ReturnValue >= 0) {\r\nswitch (b_PortOnOFF) {\r\ncase APCI1710_ON:\r\nif (devpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_DigitalIOInfo.\r\nb_OutputMemoryEnabled\r\n== 1) {\r\ndw_WriteValue\r\n=\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_DigitalIOInfo.\r\ndw_OutputMemory\r\n|\r\nb_PortValue;\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_DigitalIOInfo.\r\ndw_OutputMemory\r\n=\r\ndw_WriteValue;\r\n} else {\r\ndw_WriteValue\r\n=\r\nb_PortValue;\r\n}\r\nbreak;\r\ncase APCI1710_OFF:\r\nif (devpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_DigitalIOInfo.\r\nb_OutputMemoryEnabled\r\n== 1) {\r\ndw_WriteValue\r\n=\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_DigitalIOInfo.\r\ndw_OutputMemory\r\n&\r\n(0xFFFFFFFFUL\r\n-\r\nb_PortValue);\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_DigitalIOInfo.\r\ndw_OutputMemory\r\n=\r\ndw_WriteValue;\r\n} else {\r\ni_ReturnValue\r\n=\r\n-8;\r\n}\r\n}\r\noutl(dw_WriteValue,\r\ndevpriv->\r\ns_BoardInfos.\r\nui_Address +\r\n(64 * b_ModulNbr));\r\n}\r\n} else {\r\ni_ReturnValue = -4;\r\n}\r\n} else {\r\ni_ReturnValue = -5;\r\n}\r\n} else {\r\ni_ReturnValue = -3;\r\n}\r\n} else {\r\ni_ReturnValue = -2;\r\n}\r\nbreak;\r\ndefault:\r\ni_ReturnValue = -9;\r\nDPRINTK("NO INPUT/OUTPUT specified\n");\r\n}\r\nreturn i_ReturnValue;\r\n}

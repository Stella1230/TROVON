static void __cpuinit longrun_get_policy(struct cpufreq_policy *policy)\r\n{\r\nu32 msr_lo, msr_hi;\r\nrdmsr(MSR_TMTA_LONGRUN_FLAGS, msr_lo, msr_hi);\r\npr_debug("longrun flags are %x - %x\n", msr_lo, msr_hi);\r\nif (msr_lo & 0x01)\r\npolicy->policy = CPUFREQ_POLICY_PERFORMANCE;\r\nelse\r\npolicy->policy = CPUFREQ_POLICY_POWERSAVE;\r\nrdmsr(MSR_TMTA_LONGRUN_CTRL, msr_lo, msr_hi);\r\npr_debug("longrun ctrl is %x - %x\n", msr_lo, msr_hi);\r\nmsr_lo &= 0x0000007F;\r\nmsr_hi &= 0x0000007F;\r\nif (longrun_high_freq <= longrun_low_freq) {\r\npolicy->min = policy->max = longrun_high_freq;\r\n} else {\r\npolicy->min = longrun_low_freq + msr_lo *\r\n((longrun_high_freq - longrun_low_freq) / 100);\r\npolicy->max = longrun_low_freq + msr_hi *\r\n((longrun_high_freq - longrun_low_freq) / 100);\r\n}\r\npolicy->cpu = 0;\r\n}\r\nstatic int longrun_set_policy(struct cpufreq_policy *policy)\r\n{\r\nu32 msr_lo, msr_hi;\r\nu32 pctg_lo, pctg_hi;\r\nif (!policy)\r\nreturn -EINVAL;\r\nif (longrun_high_freq <= longrun_low_freq) {\r\npctg_lo = pctg_hi = 100;\r\n} else {\r\npctg_lo = (policy->min - longrun_low_freq) /\r\n((longrun_high_freq - longrun_low_freq) / 100);\r\npctg_hi = (policy->max - longrun_low_freq) /\r\n((longrun_high_freq - longrun_low_freq) / 100);\r\n}\r\nif (pctg_hi > 100)\r\npctg_hi = 100;\r\nif (pctg_lo > pctg_hi)\r\npctg_lo = pctg_hi;\r\nrdmsr(MSR_TMTA_LONGRUN_FLAGS, msr_lo, msr_hi);\r\nmsr_lo &= 0xFFFFFFFE;\r\nswitch (policy->policy) {\r\ncase CPUFREQ_POLICY_PERFORMANCE:\r\nmsr_lo |= 0x00000001;\r\nbreak;\r\ncase CPUFREQ_POLICY_POWERSAVE:\r\nbreak;\r\n}\r\nwrmsr(MSR_TMTA_LONGRUN_FLAGS, msr_lo, msr_hi);\r\nrdmsr(MSR_TMTA_LONGRUN_CTRL, msr_lo, msr_hi);\r\nmsr_lo &= 0xFFFFFF80;\r\nmsr_hi &= 0xFFFFFF80;\r\nmsr_lo |= pctg_lo;\r\nmsr_hi |= pctg_hi;\r\nwrmsr(MSR_TMTA_LONGRUN_CTRL, msr_lo, msr_hi);\r\nreturn 0;\r\n}\r\nstatic int longrun_verify_policy(struct cpufreq_policy *policy)\r\n{\r\nif (!policy)\r\nreturn -EINVAL;\r\npolicy->cpu = 0;\r\ncpufreq_verify_within_limits(policy,\r\npolicy->cpuinfo.min_freq,\r\npolicy->cpuinfo.max_freq);\r\nif ((policy->policy != CPUFREQ_POLICY_POWERSAVE) &&\r\n(policy->policy != CPUFREQ_POLICY_PERFORMANCE))\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic unsigned int longrun_get(unsigned int cpu)\r\n{\r\nu32 eax, ebx, ecx, edx;\r\nif (cpu)\r\nreturn 0;\r\ncpuid(0x80860007, &eax, &ebx, &ecx, &edx);\r\npr_debug("cpuid eax is %u\n", eax);\r\nreturn eax * 1000;\r\n}\r\nstatic int __cpuinit longrun_determine_freqs(unsigned int *low_freq,\r\nunsigned int *high_freq)\r\n{\r\nu32 msr_lo, msr_hi;\r\nu32 save_lo, save_hi;\r\nu32 eax, ebx, ecx, edx;\r\nu32 try_hi;\r\nstruct cpuinfo_x86 *c = &cpu_data(0);\r\nif (!low_freq || !high_freq)\r\nreturn -EINVAL;\r\nif (cpu_has(c, X86_FEATURE_LRTI)) {\r\nrdmsr(MSR_TMTA_LRTI_READOUT, msr_lo, msr_hi);\r\nwrmsr(MSR_TMTA_LRTI_READOUT, msr_hi, msr_hi);\r\nrdmsr(MSR_TMTA_LRTI_VOLT_MHZ, msr_lo, msr_hi);\r\n*low_freq = msr_lo * 1000;\r\nwrmsr(MSR_TMTA_LRTI_READOUT, 0, msr_hi);\r\nrdmsr(MSR_TMTA_LRTI_VOLT_MHZ, msr_lo, msr_hi);\r\n*high_freq = msr_lo * 1000;\r\npr_debug("longrun table interface told %u - %u kHz\n",\r\n*low_freq, *high_freq);\r\nif (*low_freq > *high_freq)\r\n*low_freq = *high_freq;\r\nreturn 0;\r\n}\r\n*high_freq = (cpu_khz / 1000);\r\n*high_freq = *high_freq * 1000;\r\npr_debug("high frequency is %u kHz\n", *high_freq);\r\nrdmsr(MSR_TMTA_LONGRUN_CTRL, msr_lo, msr_hi);\r\nsave_lo = msr_lo & 0x0000007F;\r\nsave_hi = msr_hi & 0x0000007F;\r\ncpuid(0x80860007, &eax, &ebx, &ecx, &edx);\r\nfor (try_hi = 80; try_hi > 0 && ecx > 90; try_hi -= 10) {\r\nmsr_lo &= 0xFFFFFF80;\r\nmsr_hi &= 0xFFFFFF80;\r\nmsr_hi |= try_hi;\r\nwrmsr(MSR_TMTA_LONGRUN_CTRL, msr_lo, msr_hi);\r\ncpuid(0x80860007, &eax, &ebx, &ecx, &edx);\r\nwrmsr(MSR_TMTA_LONGRUN_CTRL, save_lo, save_hi);\r\n}\r\npr_debug("percentage is %u %%, freq is %u MHz\n", ecx, eax);\r\nebx = (((cpu_khz / 1000) * ecx) / 100);\r\nif ((ecx > 95) || (ecx == 0) || (eax < ebx))\r\nreturn -EIO;\r\nedx = ((eax - ebx) * 100) / (100 - ecx);\r\n*low_freq = edx * 1000;\r\npr_debug("low frequency is %u kHz\n", *low_freq);\r\nif (*low_freq > *high_freq)\r\n*low_freq = *high_freq;\r\nreturn 0;\r\n}\r\nstatic int __cpuinit longrun_cpu_init(struct cpufreq_policy *policy)\r\n{\r\nint result = 0;\r\nif (policy->cpu != 0)\r\nreturn -ENODEV;\r\nresult = longrun_determine_freqs(&longrun_low_freq, &longrun_high_freq);\r\nif (result)\r\nreturn result;\r\npolicy->cpuinfo.min_freq = longrun_low_freq;\r\npolicy->cpuinfo.max_freq = longrun_high_freq;\r\npolicy->cpuinfo.transition_latency = CPUFREQ_ETERNAL;\r\nlongrun_get_policy(policy);\r\nreturn 0;\r\n}\r\nstatic int __init longrun_init(void)\r\n{\r\nif (!x86_match_cpu(longrun_ids))\r\nreturn -ENODEV;\r\nreturn cpufreq_register_driver(&longrun_driver);\r\n}\r\nstatic void __exit longrun_exit(void)\r\n{\r\ncpufreq_unregister_driver(&longrun_driver);\r\n}

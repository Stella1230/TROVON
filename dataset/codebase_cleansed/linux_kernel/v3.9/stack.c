static\r\nstruct sk_buff *wimax_gnl_re_state_change_alloc(\r\nstruct wimax_dev *wimax_dev,\r\nenum wimax_st new_state, enum wimax_st old_state,\r\nvoid **header)\r\n{\r\nint result;\r\nstruct device *dev = wimax_dev_to_dev(wimax_dev);\r\nvoid *data;\r\nstruct sk_buff *report_skb;\r\nd_fnstart(3, dev, "(wimax_dev %p new_state %u old_state %u)\n",\r\nwimax_dev, new_state, old_state);\r\nresult = -ENOMEM;\r\nreport_skb = nlmsg_new(NLMSG_DEFAULT_SIZE, GFP_KERNEL);\r\nif (report_skb == NULL) {\r\ndev_err(dev, "RE_STCH: can't create message\n");\r\ngoto error_new;\r\n}\r\ndata = genlmsg_put(report_skb, 0, wimax_gnl_mcg.id, &wimax_gnl_family,\r\n0, WIMAX_GNL_RE_STATE_CHANGE);\r\nif (data == NULL) {\r\ndev_err(dev, "RE_STCH: can't put data into message\n");\r\ngoto error_put;\r\n}\r\n*header = data;\r\nresult = nla_put_u8(report_skb, WIMAX_GNL_STCH_STATE_OLD, old_state);\r\nif (result < 0) {\r\ndev_err(dev, "RE_STCH: Error adding OLD attr: %d\n", result);\r\ngoto error_put;\r\n}\r\nresult = nla_put_u8(report_skb, WIMAX_GNL_STCH_STATE_NEW, new_state);\r\nif (result < 0) {\r\ndev_err(dev, "RE_STCH: Error adding NEW attr: %d\n", result);\r\ngoto error_put;\r\n}\r\nresult = nla_put_u32(report_skb, WIMAX_GNL_STCH_IFIDX,\r\nwimax_dev->net_dev->ifindex);\r\nif (result < 0) {\r\ndev_err(dev, "RE_STCH: Error adding IFINDEX attribute\n");\r\ngoto error_put;\r\n}\r\nd_fnend(3, dev, "(wimax_dev %p new_state %u old_state %u) = %p\n",\r\nwimax_dev, new_state, old_state, report_skb);\r\nreturn report_skb;\r\nerror_put:\r\nnlmsg_free(report_skb);\r\nerror_new:\r\nd_fnend(3, dev, "(wimax_dev %p new_state %u old_state %u) = %d\n",\r\nwimax_dev, new_state, old_state, result);\r\nreturn ERR_PTR(result);\r\n}\r\nstatic\r\nint wimax_gnl_re_state_change_send(\r\nstruct wimax_dev *wimax_dev, struct sk_buff *report_skb,\r\nvoid *header)\r\n{\r\nint result = 0;\r\nstruct device *dev = wimax_dev_to_dev(wimax_dev);\r\nd_fnstart(3, dev, "(wimax_dev %p report_skb %p)\n",\r\nwimax_dev, report_skb);\r\nif (report_skb == NULL) {\r\nresult = -ENOMEM;\r\ngoto out;\r\n}\r\ngenlmsg_end(report_skb, header);\r\ngenlmsg_multicast(report_skb, 0, wimax_gnl_mcg.id, GFP_KERNEL);\r\nout:\r\nd_fnend(3, dev, "(wimax_dev %p report_skb %p) = %d\n",\r\nwimax_dev, report_skb, result);\r\nreturn result;\r\n}\r\nstatic\r\nvoid __check_new_state(enum wimax_st old_state, enum wimax_st new_state,\r\nunsigned int allowed_states_bm)\r\n{\r\nif (WARN_ON(((1 << new_state) & allowed_states_bm) == 0)) {\r\nprintk(KERN_ERR "SW BUG! Forbidden state change %u -> %u\n",\r\nold_state, new_state);\r\n}\r\n}\r\nvoid __wimax_state_change(struct wimax_dev *wimax_dev, enum wimax_st new_state)\r\n{\r\nstruct device *dev = wimax_dev_to_dev(wimax_dev);\r\nenum wimax_st old_state = wimax_dev->state;\r\nstruct sk_buff *stch_skb;\r\nvoid *header;\r\nd_fnstart(3, dev, "(wimax_dev %p new_state %u [old %u])\n",\r\nwimax_dev, new_state, old_state);\r\nif (WARN_ON(new_state >= __WIMAX_ST_INVALID)) {\r\ndev_err(dev, "SW BUG: requesting invalid state %u\n",\r\nnew_state);\r\ngoto out;\r\n}\r\nif (old_state == new_state)\r\ngoto out;\r\nheader = NULL;\r\nstch_skb = wimax_gnl_re_state_change_alloc(\r\nwimax_dev, new_state, old_state, &header);\r\nswitch (old_state) {\r\ncase __WIMAX_ST_NULL:\r\n__check_new_state(old_state, new_state,\r\n1 << WIMAX_ST_DOWN);\r\nbreak;\r\ncase WIMAX_ST_DOWN:\r\n__check_new_state(old_state, new_state,\r\n1 << __WIMAX_ST_QUIESCING\r\n| 1 << WIMAX_ST_UNINITIALIZED\r\n| 1 << WIMAX_ST_RADIO_OFF);\r\nbreak;\r\ncase __WIMAX_ST_QUIESCING:\r\n__check_new_state(old_state, new_state, 1 << WIMAX_ST_DOWN);\r\nbreak;\r\ncase WIMAX_ST_UNINITIALIZED:\r\n__check_new_state(old_state, new_state,\r\n1 << __WIMAX_ST_QUIESCING\r\n| 1 << WIMAX_ST_RADIO_OFF);\r\nbreak;\r\ncase WIMAX_ST_RADIO_OFF:\r\n__check_new_state(old_state, new_state,\r\n1 << __WIMAX_ST_QUIESCING\r\n| 1 << WIMAX_ST_READY);\r\nbreak;\r\ncase WIMAX_ST_READY:\r\n__check_new_state(old_state, new_state,\r\n1 << __WIMAX_ST_QUIESCING\r\n| 1 << WIMAX_ST_RADIO_OFF\r\n| 1 << WIMAX_ST_SCANNING\r\n| 1 << WIMAX_ST_CONNECTING\r\n| 1 << WIMAX_ST_CONNECTED);\r\nbreak;\r\ncase WIMAX_ST_SCANNING:\r\n__check_new_state(old_state, new_state,\r\n1 << __WIMAX_ST_QUIESCING\r\n| 1 << WIMAX_ST_RADIO_OFF\r\n| 1 << WIMAX_ST_READY\r\n| 1 << WIMAX_ST_CONNECTING\r\n| 1 << WIMAX_ST_CONNECTED);\r\nbreak;\r\ncase WIMAX_ST_CONNECTING:\r\n__check_new_state(old_state, new_state,\r\n1 << __WIMAX_ST_QUIESCING\r\n| 1 << WIMAX_ST_RADIO_OFF\r\n| 1 << WIMAX_ST_READY\r\n| 1 << WIMAX_ST_SCANNING\r\n| 1 << WIMAX_ST_CONNECTED);\r\nbreak;\r\ncase WIMAX_ST_CONNECTED:\r\n__check_new_state(old_state, new_state,\r\n1 << __WIMAX_ST_QUIESCING\r\n| 1 << WIMAX_ST_RADIO_OFF\r\n| 1 << WIMAX_ST_READY);\r\nnetif_tx_disable(wimax_dev->net_dev);\r\nnetif_carrier_off(wimax_dev->net_dev);\r\nbreak;\r\ncase __WIMAX_ST_INVALID:\r\ndefault:\r\ndev_err(dev, "SW BUG: wimax_dev %p is in unknown state %u\n",\r\nwimax_dev, wimax_dev->state);\r\nWARN_ON(1);\r\ngoto out;\r\n}\r\nswitch (new_state) {\r\ncase __WIMAX_ST_NULL:\r\ndev_err(dev, "SW BUG: wimax_dev %p entering NULL state "\r\n"from %u\n", wimax_dev, wimax_dev->state);\r\nWARN_ON(1);\r\nbreak;\r\ncase WIMAX_ST_DOWN:\r\nbreak;\r\ncase __WIMAX_ST_QUIESCING:\r\nbreak;\r\ncase WIMAX_ST_UNINITIALIZED:\r\nbreak;\r\ncase WIMAX_ST_RADIO_OFF:\r\nbreak;\r\ncase WIMAX_ST_READY:\r\nbreak;\r\ncase WIMAX_ST_SCANNING:\r\nbreak;\r\ncase WIMAX_ST_CONNECTING:\r\nbreak;\r\ncase WIMAX_ST_CONNECTED:\r\nnetif_carrier_on(wimax_dev->net_dev);\r\nnetif_wake_queue(wimax_dev->net_dev);\r\nbreak;\r\ncase __WIMAX_ST_INVALID:\r\ndefault:\r\nBUG();\r\n}\r\n__wimax_state_set(wimax_dev, new_state);\r\nif (!IS_ERR(stch_skb))\r\nwimax_gnl_re_state_change_send(wimax_dev, stch_skb, header);\r\nout:\r\nd_fnend(3, dev, "(wimax_dev %p new_state %u [old %u]) = void\n",\r\nwimax_dev, new_state, old_state);\r\n}\r\nvoid wimax_state_change(struct wimax_dev *wimax_dev, enum wimax_st new_state)\r\n{\r\nmutex_lock(&wimax_dev->mutex);\r\nif (wimax_dev->state > __WIMAX_ST_NULL)\r\n__wimax_state_change(wimax_dev, new_state);\r\nmutex_unlock(&wimax_dev->mutex);\r\n}\r\nenum wimax_st wimax_state_get(struct wimax_dev *wimax_dev)\r\n{\r\nenum wimax_st state;\r\nmutex_lock(&wimax_dev->mutex);\r\nstate = wimax_dev->state;\r\nmutex_unlock(&wimax_dev->mutex);\r\nreturn state;\r\n}\r\nvoid wimax_dev_init(struct wimax_dev *wimax_dev)\r\n{\r\nINIT_LIST_HEAD(&wimax_dev->id_table_node);\r\n__wimax_state_set(wimax_dev, __WIMAX_ST_NULL);\r\nmutex_init(&wimax_dev->mutex);\r\nmutex_init(&wimax_dev->mutex_reset);\r\n}\r\nstatic\r\nsize_t wimax_addr_scnprint(char *addr_str, size_t addr_str_size,\r\nunsigned char *addr, size_t addr_len)\r\n{\r\nunsigned int cnt, total;\r\nfor (total = cnt = 0; cnt < addr_len; cnt++)\r\ntotal += scnprintf(addr_str + total, addr_str_size - total,\r\n"%02x%c", addr[cnt],\r\ncnt == addr_len - 1 ? '\0' : ':');\r\nreturn total;\r\n}\r\nint wimax_dev_add(struct wimax_dev *wimax_dev, struct net_device *net_dev)\r\n{\r\nint result;\r\nstruct device *dev = net_dev->dev.parent;\r\nchar addr_str[32];\r\nd_fnstart(3, dev, "(wimax_dev %p net_dev %p)\n", wimax_dev, net_dev);\r\nwimax_dev->net_dev = net_dev;\r\nresult = wimax_rfkill_add(wimax_dev);\r\nif (result < 0)\r\ngoto error_rfkill_add;\r\nmutex_lock(&wimax_dev->mutex);\r\nwimax_id_table_add(wimax_dev);\r\nresult = wimax_debugfs_add(wimax_dev);\r\nif (result < 0) {\r\ndev_err(dev, "cannot initialize debugfs: %d\n",\r\nresult);\r\ngoto error_debugfs_add;\r\n}\r\n__wimax_state_set(wimax_dev, WIMAX_ST_DOWN);\r\nmutex_unlock(&wimax_dev->mutex);\r\nwimax_addr_scnprint(addr_str, sizeof(addr_str),\r\nnet_dev->dev_addr, net_dev->addr_len);\r\ndev_err(dev, "WiMAX interface %s (%s) ready\n",\r\nnet_dev->name, addr_str);\r\nd_fnend(3, dev, "(wimax_dev %p net_dev %p) = 0\n", wimax_dev, net_dev);\r\nreturn 0;\r\nerror_debugfs_add:\r\nwimax_id_table_rm(wimax_dev);\r\nmutex_unlock(&wimax_dev->mutex);\r\nwimax_rfkill_rm(wimax_dev);\r\nerror_rfkill_add:\r\nd_fnend(3, dev, "(wimax_dev %p net_dev %p) = %d\n",\r\nwimax_dev, net_dev, result);\r\nreturn result;\r\n}\r\nvoid wimax_dev_rm(struct wimax_dev *wimax_dev)\r\n{\r\nd_fnstart(3, NULL, "(wimax_dev %p)\n", wimax_dev);\r\nmutex_lock(&wimax_dev->mutex);\r\n__wimax_state_change(wimax_dev, __WIMAX_ST_QUIESCING);\r\nwimax_debugfs_rm(wimax_dev);\r\nwimax_id_table_rm(wimax_dev);\r\n__wimax_state_change(wimax_dev, WIMAX_ST_DOWN);\r\nmutex_unlock(&wimax_dev->mutex);\r\nwimax_rfkill_rm(wimax_dev);\r\nd_fnend(3, NULL, "(wimax_dev %p) = void\n", wimax_dev);\r\n}\r\nstatic\r\nint __init wimax_subsys_init(void)\r\n{\r\nint result, cnt;\r\nd_fnstart(4, NULL, "()\n");\r\nd_parse_params(D_LEVEL, D_LEVEL_SIZE, wimax_debug_params,\r\n"wimax.debug");\r\nsnprintf(wimax_gnl_family.name, sizeof(wimax_gnl_family.name),\r\n"WiMAX");\r\nresult = genl_register_family(&wimax_gnl_family);\r\nif (unlikely(result < 0)) {\r\nprintk(KERN_ERR "cannot register generic netlink family: %d\n",\r\nresult);\r\ngoto error_register_family;\r\n}\r\nfor (cnt = 0; cnt < ARRAY_SIZE(wimax_gnl_ops); cnt++) {\r\nresult = genl_register_ops(&wimax_gnl_family,\r\nwimax_gnl_ops[cnt]);\r\nd_printf(4, NULL, "registering generic netlink op code "\r\n"%u: %d\n", wimax_gnl_ops[cnt]->cmd, result);\r\nif (unlikely(result < 0)) {\r\nprintk(KERN_ERR "cannot register generic netlink op "\r\n"code %u: %d\n",\r\nwimax_gnl_ops[cnt]->cmd, result);\r\ngoto error_register_ops;\r\n}\r\n}\r\nresult = genl_register_mc_group(&wimax_gnl_family, &wimax_gnl_mcg);\r\nif (result < 0)\r\ngoto error_mc_group;\r\nd_fnend(4, NULL, "() = 0\n");\r\nreturn 0;\r\nerror_mc_group:\r\nerror_register_ops:\r\nfor (cnt--; cnt >= 0; cnt--)\r\ngenl_unregister_ops(&wimax_gnl_family,\r\nwimax_gnl_ops[cnt]);\r\ngenl_unregister_family(&wimax_gnl_family);\r\nerror_register_family:\r\nd_fnend(4, NULL, "() = %d\n", result);\r\nreturn result;\r\n}\r\nstatic\r\nvoid __exit wimax_subsys_exit(void)\r\n{\r\nint cnt;\r\nwimax_id_table_release();\r\ngenl_unregister_mc_group(&wimax_gnl_family, &wimax_gnl_mcg);\r\nfor (cnt = ARRAY_SIZE(wimax_gnl_ops) - 1; cnt >= 0; cnt--)\r\ngenl_unregister_ops(&wimax_gnl_family,\r\nwimax_gnl_ops[cnt]);\r\ngenl_unregister_family(&wimax_gnl_family);\r\n}

static int get_ramp_delay(int ramp_delay)\r\n{\r\nunsigned char cnt = 0;\r\nramp_delay /= 6;\r\nwhile (true) {\r\nramp_delay = ramp_delay >> 1;\r\nif (ramp_delay == 0)\r\nbreak;\r\ncnt++;\r\n}\r\nreturn cnt;\r\n}\r\nstatic int s2mps11_pmic_probe(struct platform_device *pdev)\r\n{\r\nstruct sec_pmic_dev *iodev = dev_get_drvdata(pdev->dev.parent);\r\nstruct sec_platform_data *pdata = dev_get_platdata(iodev->dev);\r\nstruct regulator_config config = { };\r\nstruct s2mps11_info *s2mps11;\r\nint i, ret;\r\nunsigned char ramp_enable, ramp_reg = 0;\r\nif (!pdata) {\r\ndev_err(pdev->dev.parent, "Platform data not supplied\n");\r\nreturn -ENODEV;\r\n}\r\ns2mps11 = devm_kzalloc(&pdev->dev, sizeof(struct s2mps11_info),\r\nGFP_KERNEL);\r\nif (!s2mps11)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, s2mps11);\r\ns2mps11->ramp_delay2 = pdata->buck2_ramp_delay;\r\ns2mps11->ramp_delay34 = pdata->buck34_ramp_delay;\r\ns2mps11->ramp_delay5 = pdata->buck5_ramp_delay;\r\ns2mps11->ramp_delay16 = pdata->buck16_ramp_delay;\r\ns2mps11->ramp_delay7810 = pdata->buck7810_ramp_delay;\r\ns2mps11->ramp_delay9 = pdata->buck9_ramp_delay;\r\ns2mps11->buck6_ramp = pdata->buck6_ramp_enable;\r\ns2mps11->buck2_ramp = pdata->buck2_ramp_enable;\r\ns2mps11->buck3_ramp = pdata->buck3_ramp_enable;\r\ns2mps11->buck4_ramp = pdata->buck4_ramp_enable;\r\nramp_enable = (s2mps11->buck2_ramp << 3) | (s2mps11->buck3_ramp << 2) |\r\n(s2mps11->buck4_ramp << 1) | s2mps11->buck6_ramp ;\r\nif (ramp_enable) {\r\nif (s2mps11->buck2_ramp)\r\nramp_reg |= get_ramp_delay(s2mps11->ramp_delay2) << 6;\r\nif (s2mps11->buck3_ramp || s2mps11->buck4_ramp)\r\nramp_reg |= get_ramp_delay(s2mps11->ramp_delay34) << 4;\r\nsec_reg_write(iodev, S2MPS11_REG_RAMP, ramp_reg | ramp_enable);\r\n}\r\nramp_reg &= 0x00;\r\nramp_reg |= get_ramp_delay(s2mps11->ramp_delay5) << 6;\r\nramp_reg |= get_ramp_delay(s2mps11->ramp_delay16) << 4;\r\nramp_reg |= get_ramp_delay(s2mps11->ramp_delay7810) << 2;\r\nramp_reg |= get_ramp_delay(s2mps11->ramp_delay9);\r\nsec_reg_write(iodev, S2MPS11_REG_RAMP_BUCK, ramp_reg);\r\nfor (i = 0; i < S2MPS11_REGULATOR_MAX; i++) {\r\nconfig.dev = &pdev->dev;\r\nconfig.regmap = iodev->regmap;\r\nconfig.init_data = pdata->regulators[i].initdata;\r\nconfig.driver_data = s2mps11;\r\ns2mps11->rdev[i] = regulator_register(&regulators[i], &config);\r\nif (IS_ERR(s2mps11->rdev[i])) {\r\nret = PTR_ERR(s2mps11->rdev[i]);\r\ndev_err(&pdev->dev, "regulator init failed for %d\n",\r\ni);\r\ns2mps11->rdev[i] = NULL;\r\ngoto err;\r\n}\r\n}\r\nreturn 0;\r\nerr:\r\nfor (i = 0; i < S2MPS11_REGULATOR_MAX; i++)\r\nregulator_unregister(s2mps11->rdev[i]);\r\nreturn ret;\r\n}\r\nstatic int s2mps11_pmic_remove(struct platform_device *pdev)\r\n{\r\nstruct s2mps11_info *s2mps11 = platform_get_drvdata(pdev);\r\nint i;\r\nfor (i = 0; i < S2MPS11_REGULATOR_MAX; i++)\r\nregulator_unregister(s2mps11->rdev[i]);\r\nreturn 0;\r\n}\r\nstatic int __init s2mps11_pmic_init(void)\r\n{\r\nreturn platform_driver_register(&s2mps11_pmic_driver);\r\n}\r\nstatic void __exit s2mps11_pmic_exit(void)\r\n{\r\nplatform_driver_unregister(&s2mps11_pmic_driver);\r\n}

static inline int forward_to_spi_cmd(struct cfspi *cfspi)\r\n{\r\nreturn cfspi->rx_cpck_len;\r\n}\r\nstatic inline int forward_to_spi_cmd(struct cfspi *cfspi)\r\n{\r\nreturn 0;\r\n}\r\nstatic inline void debugfs_store_prev(struct cfspi *cfspi)\r\n{\r\ncfspi->pcmd = cfspi->cmd;\r\ncfspi->tx_ppck_len = cfspi->tx_cpck_len;\r\ncfspi->rx_ppck_len = cfspi->rx_cpck_len;\r\n}\r\nstatic inline void debugfs_store_prev(struct cfspi *cfspi)\r\n{\r\n}\r\nvoid cfspi_xfer(struct work_struct *work)\r\n{\r\nstruct cfspi *cfspi;\r\nu8 *ptr = NULL;\r\nunsigned long flags;\r\nint ret;\r\ncfspi = container_of(work, struct cfspi, work);\r\ncfspi->cmd = SPI_CMD_EOT;\r\nfor (;;) {\r\ncfspi_dbg_state(cfspi, CFSPI_STATE_WAITING);\r\nwait_event_interruptible(cfspi->wait,\r\ntest_bit(SPI_XFER, &cfspi->state) ||\r\ntest_bit(SPI_TERMINATE, &cfspi->state));\r\nif (test_bit(SPI_TERMINATE, &cfspi->state))\r\nreturn;\r\n#if CFSPI_DBG_PREFILL\r\nmemset(cfspi->xfer.va_tx, 0xFF, SPI_DMA_BUF_LEN);\r\nmemset(cfspi->xfer.va_rx, 0xFF, SPI_DMA_BUF_LEN);\r\n#endif\r\ncfspi_dbg_state(cfspi, CFSPI_STATE_AWAKE);\r\nif (cfspi->tx_cpck_len) {\r\nint len;\r\ncfspi_dbg_state(cfspi, CFSPI_STATE_FETCH_PKT);\r\nptr = (u8 *) cfspi->xfer.va_tx;\r\nptr += SPI_IND_SZ;\r\nlen = cfspi_xmitfrm(cfspi, ptr, cfspi->tx_cpck_len);\r\nWARN_ON(len != cfspi->tx_cpck_len);\r\n}\r\ncfspi_dbg_state(cfspi, CFSPI_STATE_GET_NEXT);\r\ncfspi->tx_npck_len = cfspi_xmitlen(cfspi);\r\nWARN_ON(cfspi->tx_npck_len > SPI_DMA_BUF_LEN);\r\nptr = (u8 *) cfspi->xfer.va_tx;\r\n*ptr++ = SPI_CMD_IND;\r\n*ptr++ = (SPI_CMD_IND & 0xFF00) >> 8;\r\n*ptr++ = cfspi->tx_npck_len & 0x00FF;\r\n*ptr++ = (cfspi->tx_npck_len & 0xFF00) >> 8;\r\ncfspi->xfer.tx_dma_len = cfspi->tx_cpck_len + SPI_IND_SZ;\r\ncfspi->xfer.rx_dma_len = cfspi->rx_cpck_len + SPI_CMD_SZ;\r\nif (cfspi->tx_cpck_len &&\r\n(cfspi->xfer.tx_dma_len % spi_frm_align)) {\r\ncfspi->xfer.tx_dma_len += spi_frm_align -\r\n(cfspi->xfer.tx_dma_len % spi_frm_align);\r\n}\r\nif (cfspi->rx_cpck_len &&\r\n(cfspi->xfer.rx_dma_len % spi_frm_align)) {\r\ncfspi->xfer.rx_dma_len += spi_frm_align -\r\n(cfspi->xfer.rx_dma_len % spi_frm_align);\r\n}\r\ncfspi_dbg_state(cfspi, CFSPI_STATE_INIT_XFER);\r\nret = cfspi->dev->init_xfer(&cfspi->xfer, cfspi->dev);\r\nWARN_ON(ret);\r\ncfspi_dbg_state(cfspi, CFSPI_STATE_WAIT_ACTIVE);\r\nudelay(MIN_TRANSITION_TIME_USEC);\r\ncfspi_dbg_state(cfspi, CFSPI_STATE_SIG_ACTIVE);\r\ncfspi->dev->sig_xfer(true, cfspi->dev);\r\ncfspi_dbg_state(cfspi, CFSPI_STATE_WAIT_XFER_DONE);\r\nwait_for_completion(&cfspi->comp);\r\ncfspi_dbg_state(cfspi, CFSPI_STATE_XFER_DONE);\r\nif (cfspi->cmd == SPI_CMD_EOT) {\r\nclear_bit(SPI_SS_ON, &cfspi->state);\r\n}\r\ncfspi_dbg_state(cfspi, CFSPI_STATE_WAIT_INACTIVE);\r\nif (SPI_XFER_TIME_USEC(cfspi->xfer.tx_dma_len,\r\ncfspi->dev->clk_mhz) <\r\nMIN_TRANSITION_TIME_USEC) {\r\nudelay(MIN_TRANSITION_TIME_USEC -\r\nSPI_XFER_TIME_USEC\r\n(cfspi->xfer.tx_dma_len, cfspi->dev->clk_mhz));\r\n}\r\ncfspi_dbg_state(cfspi, CFSPI_STATE_SIG_INACTIVE);\r\ncfspi->dev->sig_xfer(false, cfspi->dev);\r\nif (cfspi->rx_cpck_len) {\r\nint len;\r\ncfspi_dbg_state(cfspi, CFSPI_STATE_DELIVER_PKT);\r\nptr = ((u8 *)(cfspi->xfer.va_rx + SPI_DATA_POS));\r\nlen = cfspi_rxfrm(cfspi, ptr, cfspi->rx_cpck_len);\r\nWARN_ON(len != cfspi->rx_cpck_len);\r\n}\r\nptr = (u8 *) cfspi->xfer.va_rx;\r\nptr += forward_to_spi_cmd(cfspi);\r\ncfspi->cmd = *ptr++;\r\ncfspi->cmd |= ((*ptr++) << 8) & 0xFF00;\r\ncfspi->rx_npck_len = *ptr++;\r\ncfspi->rx_npck_len |= ((*ptr++) << 8) & 0xFF00;\r\nWARN_ON(cfspi->rx_npck_len > SPI_DMA_BUF_LEN);\r\nWARN_ON(cfspi->cmd > SPI_CMD_EOT);\r\ndebugfs_store_prev(cfspi);\r\nif (cfspi->cmd == SPI_CMD_EOT) {\r\ncfspi->tx_cpck_len = 0;\r\ncfspi->rx_cpck_len = 0;\r\n} else {\r\ncfspi->tx_cpck_len = cfspi->tx_npck_len;\r\ncfspi->rx_cpck_len = cfspi->rx_npck_len;\r\n}\r\nspin_lock_irqsave(&cfspi->lock, flags);\r\nif (cfspi->cmd == SPI_CMD_EOT && !cfspi_xmitlen(cfspi)\r\n&& !test_bit(SPI_SS_ON, &cfspi->state))\r\nclear_bit(SPI_XFER, &cfspi->state);\r\nspin_unlock_irqrestore(&cfspi->lock, flags);\r\n}\r\n}

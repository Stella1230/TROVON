struct iscsi_datain_req *iscsit_allocate_datain_req(void)\r\n{\r\nstruct iscsi_datain_req *dr;\r\ndr = kmem_cache_zalloc(lio_dr_cache, GFP_ATOMIC);\r\nif (!dr) {\r\npr_err("Unable to allocate memory for"\r\n" struct iscsi_datain_req\n");\r\nreturn NULL;\r\n}\r\nINIT_LIST_HEAD(&dr->cmd_datain_node);\r\nreturn dr;\r\n}\r\nvoid iscsit_attach_datain_req(struct iscsi_cmd *cmd, struct iscsi_datain_req *dr)\r\n{\r\nspin_lock(&cmd->datain_lock);\r\nlist_add_tail(&dr->cmd_datain_node, &cmd->datain_list);\r\nspin_unlock(&cmd->datain_lock);\r\n}\r\nvoid iscsit_free_datain_req(struct iscsi_cmd *cmd, struct iscsi_datain_req *dr)\r\n{\r\nspin_lock(&cmd->datain_lock);\r\nlist_del(&dr->cmd_datain_node);\r\nspin_unlock(&cmd->datain_lock);\r\nkmem_cache_free(lio_dr_cache, dr);\r\n}\r\nvoid iscsit_free_all_datain_reqs(struct iscsi_cmd *cmd)\r\n{\r\nstruct iscsi_datain_req *dr, *dr_tmp;\r\nspin_lock(&cmd->datain_lock);\r\nlist_for_each_entry_safe(dr, dr_tmp, &cmd->datain_list, cmd_datain_node) {\r\nlist_del(&dr->cmd_datain_node);\r\nkmem_cache_free(lio_dr_cache, dr);\r\n}\r\nspin_unlock(&cmd->datain_lock);\r\n}\r\nstruct iscsi_datain_req *iscsit_get_datain_req(struct iscsi_cmd *cmd)\r\n{\r\nif (list_empty(&cmd->datain_list)) {\r\npr_err("cmd->datain_list is empty for ITT:"\r\n" 0x%08x\n", cmd->init_task_tag);\r\nreturn NULL;\r\n}\r\nreturn list_first_entry(&cmd->datain_list, struct iscsi_datain_req,\r\ncmd_datain_node);\r\n}\r\nstatic struct iscsi_datain_req *iscsit_set_datain_values_yes_and_yes(\r\nstruct iscsi_cmd *cmd,\r\nstruct iscsi_datain *datain)\r\n{\r\nu32 next_burst_len, read_data_done, read_data_left;\r\nstruct iscsi_conn *conn = cmd->conn;\r\nstruct iscsi_datain_req *dr;\r\ndr = iscsit_get_datain_req(cmd);\r\nif (!dr)\r\nreturn NULL;\r\nif (dr->recovery && dr->generate_recovery_values) {\r\nif (iscsit_create_recovery_datain_values_datasequenceinorder_yes(\r\ncmd, dr) < 0)\r\nreturn NULL;\r\ndr->generate_recovery_values = 0;\r\n}\r\nnext_burst_len = (!dr->recovery) ?\r\ncmd->next_burst_len : dr->next_burst_len;\r\nread_data_done = (!dr->recovery) ?\r\ncmd->read_data_done : dr->read_data_done;\r\nread_data_left = (cmd->se_cmd.data_length - read_data_done);\r\nif (!read_data_left) {\r\npr_err("ITT: 0x%08x read_data_left is zero!\n",\r\ncmd->init_task_tag);\r\nreturn NULL;\r\n}\r\nif ((read_data_left <= conn->conn_ops->MaxRecvDataSegmentLength) &&\r\n(read_data_left <= (conn->sess->sess_ops->MaxBurstLength -\r\nnext_burst_len))) {\r\ndatain->length = read_data_left;\r\ndatain->flags |= (ISCSI_FLAG_CMD_FINAL | ISCSI_FLAG_DATA_STATUS);\r\nif (conn->sess->sess_ops->ErrorRecoveryLevel > 0)\r\ndatain->flags |= ISCSI_FLAG_DATA_ACK;\r\n} else {\r\nif ((next_burst_len +\r\nconn->conn_ops->MaxRecvDataSegmentLength) <\r\nconn->sess->sess_ops->MaxBurstLength) {\r\ndatain->length =\r\nconn->conn_ops->MaxRecvDataSegmentLength;\r\nnext_burst_len += datain->length;\r\n} else {\r\ndatain->length = (conn->sess->sess_ops->MaxBurstLength -\r\nnext_burst_len);\r\nnext_burst_len = 0;\r\ndatain->flags |= ISCSI_FLAG_CMD_FINAL;\r\nif (conn->sess->sess_ops->ErrorRecoveryLevel > 0)\r\ndatain->flags |= ISCSI_FLAG_DATA_ACK;\r\n}\r\n}\r\ndatain->data_sn = (!dr->recovery) ? cmd->data_sn++ : dr->data_sn++;\r\ndatain->offset = read_data_done;\r\nif (!dr->recovery) {\r\ncmd->next_burst_len = next_burst_len;\r\ncmd->read_data_done += datain->length;\r\n} else {\r\ndr->next_burst_len = next_burst_len;\r\ndr->read_data_done += datain->length;\r\n}\r\nif (!dr->recovery) {\r\nif (datain->flags & ISCSI_FLAG_DATA_STATUS)\r\ndr->dr_complete = DATAIN_COMPLETE_NORMAL;\r\nreturn dr;\r\n}\r\nif (!dr->runlength) {\r\nif (datain->flags & ISCSI_FLAG_DATA_STATUS) {\r\ndr->dr_complete =\r\n(dr->recovery == DATAIN_WITHIN_COMMAND_RECOVERY) ?\r\nDATAIN_COMPLETE_WITHIN_COMMAND_RECOVERY :\r\nDATAIN_COMPLETE_CONNECTION_RECOVERY;\r\n}\r\n} else {\r\nif ((dr->begrun + dr->runlength) == dr->data_sn) {\r\ndr->dr_complete =\r\n(dr->recovery == DATAIN_WITHIN_COMMAND_RECOVERY) ?\r\nDATAIN_COMPLETE_WITHIN_COMMAND_RECOVERY :\r\nDATAIN_COMPLETE_CONNECTION_RECOVERY;\r\n}\r\n}\r\nreturn dr;\r\n}\r\nstatic struct iscsi_datain_req *iscsit_set_datain_values_no_and_yes(\r\nstruct iscsi_cmd *cmd,\r\nstruct iscsi_datain *datain)\r\n{\r\nu32 offset, read_data_done, read_data_left, seq_send_order;\r\nstruct iscsi_conn *conn = cmd->conn;\r\nstruct iscsi_datain_req *dr;\r\nstruct iscsi_seq *seq;\r\ndr = iscsit_get_datain_req(cmd);\r\nif (!dr)\r\nreturn NULL;\r\nif (dr->recovery && dr->generate_recovery_values) {\r\nif (iscsit_create_recovery_datain_values_datasequenceinorder_no(\r\ncmd, dr) < 0)\r\nreturn NULL;\r\ndr->generate_recovery_values = 0;\r\n}\r\nread_data_done = (!dr->recovery) ?\r\ncmd->read_data_done : dr->read_data_done;\r\nseq_send_order = (!dr->recovery) ?\r\ncmd->seq_send_order : dr->seq_send_order;\r\nread_data_left = (cmd->se_cmd.data_length - read_data_done);\r\nif (!read_data_left) {\r\npr_err("ITT: 0x%08x read_data_left is zero!\n",\r\ncmd->init_task_tag);\r\nreturn NULL;\r\n}\r\nseq = iscsit_get_seq_holder_for_datain(cmd, seq_send_order);\r\nif (!seq)\r\nreturn NULL;\r\nseq->sent = 1;\r\nif (!dr->recovery && !seq->next_burst_len)\r\nseq->first_datasn = cmd->data_sn;\r\noffset = (seq->offset + seq->next_burst_len);\r\nif ((offset + conn->conn_ops->MaxRecvDataSegmentLength) >=\r\ncmd->se_cmd.data_length) {\r\ndatain->length = (cmd->se_cmd.data_length - offset);\r\ndatain->offset = offset;\r\ndatain->flags |= ISCSI_FLAG_CMD_FINAL;\r\nif (conn->sess->sess_ops->ErrorRecoveryLevel > 0)\r\ndatain->flags |= ISCSI_FLAG_DATA_ACK;\r\nseq->next_burst_len = 0;\r\nseq_send_order++;\r\n} else {\r\nif ((seq->next_burst_len +\r\nconn->conn_ops->MaxRecvDataSegmentLength) <\r\nconn->sess->sess_ops->MaxBurstLength) {\r\ndatain->length =\r\nconn->conn_ops->MaxRecvDataSegmentLength;\r\ndatain->offset = (seq->offset + seq->next_burst_len);\r\nseq->next_burst_len += datain->length;\r\n} else {\r\ndatain->length = (conn->sess->sess_ops->MaxBurstLength -\r\nseq->next_burst_len);\r\ndatain->offset = (seq->offset + seq->next_burst_len);\r\ndatain->flags |= ISCSI_FLAG_CMD_FINAL;\r\nif (conn->sess->sess_ops->ErrorRecoveryLevel > 0)\r\ndatain->flags |= ISCSI_FLAG_DATA_ACK;\r\nseq->next_burst_len = 0;\r\nseq_send_order++;\r\n}\r\n}\r\nif ((read_data_done + datain->length) == cmd->se_cmd.data_length)\r\ndatain->flags |= ISCSI_FLAG_DATA_STATUS;\r\ndatain->data_sn = (!dr->recovery) ? cmd->data_sn++ : dr->data_sn++;\r\nif (!dr->recovery) {\r\ncmd->seq_send_order = seq_send_order;\r\ncmd->read_data_done += datain->length;\r\n} else {\r\ndr->seq_send_order = seq_send_order;\r\ndr->read_data_done += datain->length;\r\n}\r\nif (!dr->recovery) {\r\nif (datain->flags & ISCSI_FLAG_CMD_FINAL)\r\nseq->last_datasn = datain->data_sn;\r\nif (datain->flags & ISCSI_FLAG_DATA_STATUS)\r\ndr->dr_complete = DATAIN_COMPLETE_NORMAL;\r\nreturn dr;\r\n}\r\nif (!dr->runlength) {\r\nif (datain->flags & ISCSI_FLAG_DATA_STATUS) {\r\ndr->dr_complete =\r\n(dr->recovery == DATAIN_WITHIN_COMMAND_RECOVERY) ?\r\nDATAIN_COMPLETE_WITHIN_COMMAND_RECOVERY :\r\nDATAIN_COMPLETE_CONNECTION_RECOVERY;\r\n}\r\n} else {\r\nif ((dr->begrun + dr->runlength) == dr->data_sn) {\r\ndr->dr_complete =\r\n(dr->recovery == DATAIN_WITHIN_COMMAND_RECOVERY) ?\r\nDATAIN_COMPLETE_WITHIN_COMMAND_RECOVERY :\r\nDATAIN_COMPLETE_CONNECTION_RECOVERY;\r\n}\r\n}\r\nreturn dr;\r\n}\r\nstatic struct iscsi_datain_req *iscsit_set_datain_values_yes_and_no(\r\nstruct iscsi_cmd *cmd,\r\nstruct iscsi_datain *datain)\r\n{\r\nu32 next_burst_len, read_data_done, read_data_left;\r\nstruct iscsi_conn *conn = cmd->conn;\r\nstruct iscsi_datain_req *dr;\r\nstruct iscsi_pdu *pdu;\r\ndr = iscsit_get_datain_req(cmd);\r\nif (!dr)\r\nreturn NULL;\r\nif (dr->recovery && dr->generate_recovery_values) {\r\nif (iscsit_create_recovery_datain_values_datasequenceinorder_yes(\r\ncmd, dr) < 0)\r\nreturn NULL;\r\ndr->generate_recovery_values = 0;\r\n}\r\nnext_burst_len = (!dr->recovery) ?\r\ncmd->next_burst_len : dr->next_burst_len;\r\nread_data_done = (!dr->recovery) ?\r\ncmd->read_data_done : dr->read_data_done;\r\nread_data_left = (cmd->se_cmd.data_length - read_data_done);\r\nif (!read_data_left) {\r\npr_err("ITT: 0x%08x read_data_left is zero!\n",\r\ncmd->init_task_tag);\r\nreturn dr;\r\n}\r\npdu = iscsit_get_pdu_holder_for_seq(cmd, NULL);\r\nif (!pdu)\r\nreturn dr;\r\nif ((read_data_done + pdu->length) == cmd->se_cmd.data_length) {\r\npdu->flags |= (ISCSI_FLAG_CMD_FINAL | ISCSI_FLAG_DATA_STATUS);\r\nif (conn->sess->sess_ops->ErrorRecoveryLevel > 0)\r\npdu->flags |= ISCSI_FLAG_DATA_ACK;\r\nnext_burst_len = 0;\r\n} else {\r\nif ((next_burst_len + conn->conn_ops->MaxRecvDataSegmentLength) <\r\nconn->sess->sess_ops->MaxBurstLength)\r\nnext_burst_len += pdu->length;\r\nelse {\r\npdu->flags |= ISCSI_FLAG_CMD_FINAL;\r\nif (conn->sess->sess_ops->ErrorRecoveryLevel > 0)\r\npdu->flags |= ISCSI_FLAG_DATA_ACK;\r\nnext_burst_len = 0;\r\n}\r\n}\r\npdu->data_sn = (!dr->recovery) ? cmd->data_sn++ : dr->data_sn++;\r\nif (!dr->recovery) {\r\ncmd->next_burst_len = next_burst_len;\r\ncmd->read_data_done += pdu->length;\r\n} else {\r\ndr->next_burst_len = next_burst_len;\r\ndr->read_data_done += pdu->length;\r\n}\r\ndatain->flags = pdu->flags;\r\ndatain->length = pdu->length;\r\ndatain->offset = pdu->offset;\r\ndatain->data_sn = pdu->data_sn;\r\nif (!dr->recovery) {\r\nif (datain->flags & ISCSI_FLAG_DATA_STATUS)\r\ndr->dr_complete = DATAIN_COMPLETE_NORMAL;\r\nreturn dr;\r\n}\r\nif (!dr->runlength) {\r\nif (datain->flags & ISCSI_FLAG_DATA_STATUS) {\r\ndr->dr_complete =\r\n(dr->recovery == DATAIN_WITHIN_COMMAND_RECOVERY) ?\r\nDATAIN_COMPLETE_WITHIN_COMMAND_RECOVERY :\r\nDATAIN_COMPLETE_CONNECTION_RECOVERY;\r\n}\r\n} else {\r\nif ((dr->begrun + dr->runlength) == dr->data_sn) {\r\ndr->dr_complete =\r\n(dr->recovery == DATAIN_WITHIN_COMMAND_RECOVERY) ?\r\nDATAIN_COMPLETE_WITHIN_COMMAND_RECOVERY :\r\nDATAIN_COMPLETE_CONNECTION_RECOVERY;\r\n}\r\n}\r\nreturn dr;\r\n}\r\nstatic struct iscsi_datain_req *iscsit_set_datain_values_no_and_no(\r\nstruct iscsi_cmd *cmd,\r\nstruct iscsi_datain *datain)\r\n{\r\nu32 read_data_done, read_data_left, seq_send_order;\r\nstruct iscsi_conn *conn = cmd->conn;\r\nstruct iscsi_datain_req *dr;\r\nstruct iscsi_pdu *pdu;\r\nstruct iscsi_seq *seq = NULL;\r\ndr = iscsit_get_datain_req(cmd);\r\nif (!dr)\r\nreturn NULL;\r\nif (dr->recovery && dr->generate_recovery_values) {\r\nif (iscsit_create_recovery_datain_values_datasequenceinorder_no(\r\ncmd, dr) < 0)\r\nreturn NULL;\r\ndr->generate_recovery_values = 0;\r\n}\r\nread_data_done = (!dr->recovery) ?\r\ncmd->read_data_done : dr->read_data_done;\r\nseq_send_order = (!dr->recovery) ?\r\ncmd->seq_send_order : dr->seq_send_order;\r\nread_data_left = (cmd->se_cmd.data_length - read_data_done);\r\nif (!read_data_left) {\r\npr_err("ITT: 0x%08x read_data_left is zero!\n",\r\ncmd->init_task_tag);\r\nreturn NULL;\r\n}\r\nseq = iscsit_get_seq_holder_for_datain(cmd, seq_send_order);\r\nif (!seq)\r\nreturn NULL;\r\nseq->sent = 1;\r\nif (!dr->recovery && !seq->next_burst_len)\r\nseq->first_datasn = cmd->data_sn;\r\npdu = iscsit_get_pdu_holder_for_seq(cmd, seq);\r\nif (!pdu)\r\nreturn NULL;\r\nif (seq->pdu_send_order == seq->pdu_count) {\r\npdu->flags |= ISCSI_FLAG_CMD_FINAL;\r\nif (conn->sess->sess_ops->ErrorRecoveryLevel > 0)\r\npdu->flags |= ISCSI_FLAG_DATA_ACK;\r\nseq->next_burst_len = 0;\r\nseq_send_order++;\r\n} else\r\nseq->next_burst_len += pdu->length;\r\nif ((read_data_done + pdu->length) == cmd->se_cmd.data_length)\r\npdu->flags |= ISCSI_FLAG_DATA_STATUS;\r\npdu->data_sn = (!dr->recovery) ? cmd->data_sn++ : dr->data_sn++;\r\nif (!dr->recovery) {\r\ncmd->seq_send_order = seq_send_order;\r\ncmd->read_data_done += pdu->length;\r\n} else {\r\ndr->seq_send_order = seq_send_order;\r\ndr->read_data_done += pdu->length;\r\n}\r\ndatain->flags = pdu->flags;\r\ndatain->length = pdu->length;\r\ndatain->offset = pdu->offset;\r\ndatain->data_sn = pdu->data_sn;\r\nif (!dr->recovery) {\r\nif (datain->flags & ISCSI_FLAG_CMD_FINAL)\r\nseq->last_datasn = datain->data_sn;\r\nif (datain->flags & ISCSI_FLAG_DATA_STATUS)\r\ndr->dr_complete = DATAIN_COMPLETE_NORMAL;\r\nreturn dr;\r\n}\r\nif (!dr->runlength) {\r\nif (datain->flags & ISCSI_FLAG_DATA_STATUS) {\r\ndr->dr_complete =\r\n(dr->recovery == DATAIN_WITHIN_COMMAND_RECOVERY) ?\r\nDATAIN_COMPLETE_WITHIN_COMMAND_RECOVERY :\r\nDATAIN_COMPLETE_CONNECTION_RECOVERY;\r\n}\r\n} else {\r\nif ((dr->begrun + dr->runlength) == dr->data_sn) {\r\ndr->dr_complete =\r\n(dr->recovery == DATAIN_WITHIN_COMMAND_RECOVERY) ?\r\nDATAIN_COMPLETE_WITHIN_COMMAND_RECOVERY :\r\nDATAIN_COMPLETE_CONNECTION_RECOVERY;\r\n}\r\n}\r\nreturn dr;\r\n}\r\nstruct iscsi_datain_req *iscsit_get_datain_values(\r\nstruct iscsi_cmd *cmd,\r\nstruct iscsi_datain *datain)\r\n{\r\nstruct iscsi_conn *conn = cmd->conn;\r\nif (conn->sess->sess_ops->DataSequenceInOrder &&\r\nconn->sess->sess_ops->DataPDUInOrder)\r\nreturn iscsit_set_datain_values_yes_and_yes(cmd, datain);\r\nelse if (!conn->sess->sess_ops->DataSequenceInOrder &&\r\nconn->sess->sess_ops->DataPDUInOrder)\r\nreturn iscsit_set_datain_values_no_and_yes(cmd, datain);\r\nelse if (conn->sess->sess_ops->DataSequenceInOrder &&\r\n!conn->sess->sess_ops->DataPDUInOrder)\r\nreturn iscsit_set_datain_values_yes_and_no(cmd, datain);\r\nelse if (!conn->sess->sess_ops->DataSequenceInOrder &&\r\n!conn->sess->sess_ops->DataPDUInOrder)\r\nreturn iscsit_set_datain_values_no_and_no(cmd, datain);\r\nreturn NULL;\r\n}

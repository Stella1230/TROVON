static bool rb532_button_pressed(void)\r\n{\r\nint val;\r\nset_latch_u5(0, LO_FOFF);\r\ngpio_direction_input(GPIO_BTN_S1);\r\nval = gpio_get_value(GPIO_BTN_S1);\r\nrb532_gpio_set_func(GPIO_BTN_S1);\r\nset_latch_u5(LO_FOFF, 0);\r\nreturn !val;\r\n}\r\nstatic void rb532_button_poll(struct input_polled_dev *poll_dev)\r\n{\r\ninput_report_key(poll_dev->input, RB532_BTN_KSYM,\r\nrb532_button_pressed());\r\ninput_sync(poll_dev->input);\r\n}\r\nstatic int rb532_button_probe(struct platform_device *pdev)\r\n{\r\nstruct input_polled_dev *poll_dev;\r\nint error;\r\npoll_dev = input_allocate_polled_device();\r\nif (!poll_dev)\r\nreturn -ENOMEM;\r\npoll_dev->poll = rb532_button_poll;\r\npoll_dev->poll_interval = RB532_BTN_RATE;\r\npoll_dev->input->name = "rb532 button";\r\npoll_dev->input->phys = "rb532/button0";\r\npoll_dev->input->id.bustype = BUS_HOST;\r\npoll_dev->input->dev.parent = &pdev->dev;\r\ndev_set_drvdata(&pdev->dev, poll_dev);\r\ninput_set_capability(poll_dev->input, EV_KEY, RB532_BTN_KSYM);\r\nerror = input_register_polled_device(poll_dev);\r\nif (error) {\r\ninput_free_polled_device(poll_dev);\r\nreturn error;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rb532_button_remove(struct platform_device *pdev)\r\n{\r\nstruct input_polled_dev *poll_dev = dev_get_drvdata(&pdev->dev);\r\ninput_unregister_polled_device(poll_dev);\r\ninput_free_polled_device(poll_dev);\r\ndev_set_drvdata(&pdev->dev, NULL);\r\nreturn 0;\r\n}

int ipv4_skb_to_auditdata(struct sk_buff *skb,\r\nstruct common_audit_data *ad, u8 *proto)\r\n{\r\nint ret = 0;\r\nstruct iphdr *ih;\r\nih = ip_hdr(skb);\r\nif (ih == NULL)\r\nreturn -EINVAL;\r\nad->u.net->v4info.saddr = ih->saddr;\r\nad->u.net->v4info.daddr = ih->daddr;\r\nif (proto)\r\n*proto = ih->protocol;\r\nif (ntohs(ih->frag_off) & IP_OFFSET)\r\nreturn 0;\r\nswitch (ih->protocol) {\r\ncase IPPROTO_TCP: {\r\nstruct tcphdr *th = tcp_hdr(skb);\r\nif (th == NULL)\r\nbreak;\r\nad->u.net->sport = th->source;\r\nad->u.net->dport = th->dest;\r\nbreak;\r\n}\r\ncase IPPROTO_UDP: {\r\nstruct udphdr *uh = udp_hdr(skb);\r\nif (uh == NULL)\r\nbreak;\r\nad->u.net->sport = uh->source;\r\nad->u.net->dport = uh->dest;\r\nbreak;\r\n}\r\ncase IPPROTO_DCCP: {\r\nstruct dccp_hdr *dh = dccp_hdr(skb);\r\nif (dh == NULL)\r\nbreak;\r\nad->u.net->sport = dh->dccph_sport;\r\nad->u.net->dport = dh->dccph_dport;\r\nbreak;\r\n}\r\ncase IPPROTO_SCTP: {\r\nstruct sctphdr *sh = sctp_hdr(skb);\r\nif (sh == NULL)\r\nbreak;\r\nad->u.net->sport = sh->source;\r\nad->u.net->dport = sh->dest;\r\nbreak;\r\n}\r\ndefault:\r\nret = -EINVAL;\r\n}\r\nreturn ret;\r\n}\r\nint ipv6_skb_to_auditdata(struct sk_buff *skb,\r\nstruct common_audit_data *ad, u8 *proto)\r\n{\r\nint offset, ret = 0;\r\nstruct ipv6hdr *ip6;\r\nu8 nexthdr;\r\n__be16 frag_off;\r\nip6 = ipv6_hdr(skb);\r\nif (ip6 == NULL)\r\nreturn -EINVAL;\r\nad->u.net->v6info.saddr = ip6->saddr;\r\nad->u.net->v6info.daddr = ip6->daddr;\r\nret = 0;\r\noffset = skb_network_offset(skb);\r\noffset += sizeof(*ip6);\r\nnexthdr = ip6->nexthdr;\r\noffset = ipv6_skip_exthdr(skb, offset, &nexthdr, &frag_off);\r\nif (offset < 0)\r\nreturn 0;\r\nif (proto)\r\n*proto = nexthdr;\r\nswitch (nexthdr) {\r\ncase IPPROTO_TCP: {\r\nstruct tcphdr _tcph, *th;\r\nth = skb_header_pointer(skb, offset, sizeof(_tcph), &_tcph);\r\nif (th == NULL)\r\nbreak;\r\nad->u.net->sport = th->source;\r\nad->u.net->dport = th->dest;\r\nbreak;\r\n}\r\ncase IPPROTO_UDP: {\r\nstruct udphdr _udph, *uh;\r\nuh = skb_header_pointer(skb, offset, sizeof(_udph), &_udph);\r\nif (uh == NULL)\r\nbreak;\r\nad->u.net->sport = uh->source;\r\nad->u.net->dport = uh->dest;\r\nbreak;\r\n}\r\ncase IPPROTO_DCCP: {\r\nstruct dccp_hdr _dccph, *dh;\r\ndh = skb_header_pointer(skb, offset, sizeof(_dccph), &_dccph);\r\nif (dh == NULL)\r\nbreak;\r\nad->u.net->sport = dh->dccph_sport;\r\nad->u.net->dport = dh->dccph_dport;\r\nbreak;\r\n}\r\ncase IPPROTO_SCTP: {\r\nstruct sctphdr _sctph, *sh;\r\nsh = skb_header_pointer(skb, offset, sizeof(_sctph), &_sctph);\r\nif (sh == NULL)\r\nbreak;\r\nad->u.net->sport = sh->source;\r\nad->u.net->dport = sh->dest;\r\nbreak;\r\n}\r\ndefault:\r\nret = -EINVAL;\r\n}\r\nreturn ret;\r\n}\r\nstatic inline void print_ipv6_addr(struct audit_buffer *ab,\r\nstruct in6_addr *addr, __be16 port,\r\nchar *name1, char *name2)\r\n{\r\nif (!ipv6_addr_any(addr))\r\naudit_log_format(ab, " %s=%pI6c", name1, addr);\r\nif (port)\r\naudit_log_format(ab, " %s=%d", name2, ntohs(port));\r\n}\r\nstatic inline void print_ipv4_addr(struct audit_buffer *ab, __be32 addr,\r\n__be16 port, char *name1, char *name2)\r\n{\r\nif (addr)\r\naudit_log_format(ab, " %s=%pI4", name1, &addr);\r\nif (port)\r\naudit_log_format(ab, " %s=%d", name2, ntohs(port));\r\n}\r\nstatic void dump_common_audit_data(struct audit_buffer *ab,\r\nstruct common_audit_data *a)\r\n{\r\nstruct task_struct *tsk = current;\r\nBUILD_BUG_ON(sizeof(a->u) > sizeof(void *)*2);\r\naudit_log_format(ab, " pid=%d comm=", tsk->pid);\r\naudit_log_untrustedstring(ab, tsk->comm);\r\nswitch (a->type) {\r\ncase LSM_AUDIT_DATA_NONE:\r\nreturn;\r\ncase LSM_AUDIT_DATA_IPC:\r\naudit_log_format(ab, " key=%d ", a->u.ipc_id);\r\nbreak;\r\ncase LSM_AUDIT_DATA_CAP:\r\naudit_log_format(ab, " capability=%d ", a->u.cap);\r\nbreak;\r\ncase LSM_AUDIT_DATA_PATH: {\r\nstruct inode *inode;\r\naudit_log_d_path(ab, " path=", &a->u.path);\r\ninode = a->u.path.dentry->d_inode;\r\nif (inode) {\r\naudit_log_format(ab, " dev=");\r\naudit_log_untrustedstring(ab, inode->i_sb->s_id);\r\naudit_log_format(ab, " ino=%lu", inode->i_ino);\r\n}\r\nbreak;\r\n}\r\ncase LSM_AUDIT_DATA_DENTRY: {\r\nstruct inode *inode;\r\naudit_log_format(ab, " name=");\r\naudit_log_untrustedstring(ab, a->u.dentry->d_name.name);\r\ninode = a->u.dentry->d_inode;\r\nif (inode) {\r\naudit_log_format(ab, " dev=");\r\naudit_log_untrustedstring(ab, inode->i_sb->s_id);\r\naudit_log_format(ab, " ino=%lu", inode->i_ino);\r\n}\r\nbreak;\r\n}\r\ncase LSM_AUDIT_DATA_INODE: {\r\nstruct dentry *dentry;\r\nstruct inode *inode;\r\ninode = a->u.inode;\r\ndentry = d_find_alias(inode);\r\nif (dentry) {\r\naudit_log_format(ab, " name=");\r\naudit_log_untrustedstring(ab,\r\ndentry->d_name.name);\r\ndput(dentry);\r\n}\r\naudit_log_format(ab, " dev=");\r\naudit_log_untrustedstring(ab, inode->i_sb->s_id);\r\naudit_log_format(ab, " ino=%lu", inode->i_ino);\r\nbreak;\r\n}\r\ncase LSM_AUDIT_DATA_TASK:\r\ntsk = a->u.tsk;\r\nif (tsk && tsk->pid) {\r\naudit_log_format(ab, " pid=%d comm=", tsk->pid);\r\naudit_log_untrustedstring(ab, tsk->comm);\r\n}\r\nbreak;\r\ncase LSM_AUDIT_DATA_NET:\r\nif (a->u.net->sk) {\r\nstruct sock *sk = a->u.net->sk;\r\nstruct unix_sock *u;\r\nint len = 0;\r\nchar *p = NULL;\r\nswitch (sk->sk_family) {\r\ncase AF_INET: {\r\nstruct inet_sock *inet = inet_sk(sk);\r\nprint_ipv4_addr(ab, inet->inet_rcv_saddr,\r\ninet->inet_sport,\r\n"laddr", "lport");\r\nprint_ipv4_addr(ab, inet->inet_daddr,\r\ninet->inet_dport,\r\n"faddr", "fport");\r\nbreak;\r\n}\r\ncase AF_INET6: {\r\nstruct inet_sock *inet = inet_sk(sk);\r\nstruct ipv6_pinfo *inet6 = inet6_sk(sk);\r\nprint_ipv6_addr(ab, &inet6->rcv_saddr,\r\ninet->inet_sport,\r\n"laddr", "lport");\r\nprint_ipv6_addr(ab, &inet6->daddr,\r\ninet->inet_dport,\r\n"faddr", "fport");\r\nbreak;\r\n}\r\ncase AF_UNIX:\r\nu = unix_sk(sk);\r\nif (u->path.dentry) {\r\naudit_log_d_path(ab, " path=", &u->path);\r\nbreak;\r\n}\r\nif (!u->addr)\r\nbreak;\r\nlen = u->addr->len-sizeof(short);\r\np = &u->addr->name->sun_path[0];\r\naudit_log_format(ab, " path=");\r\nif (*p)\r\naudit_log_untrustedstring(ab, p);\r\nelse\r\naudit_log_n_hex(ab, p, len);\r\nbreak;\r\n}\r\n}\r\nswitch (a->u.net->family) {\r\ncase AF_INET:\r\nprint_ipv4_addr(ab, a->u.net->v4info.saddr,\r\na->u.net->sport,\r\n"saddr", "src");\r\nprint_ipv4_addr(ab, a->u.net->v4info.daddr,\r\na->u.net->dport,\r\n"daddr", "dest");\r\nbreak;\r\ncase AF_INET6:\r\nprint_ipv6_addr(ab, &a->u.net->v6info.saddr,\r\na->u.net->sport,\r\n"saddr", "src");\r\nprint_ipv6_addr(ab, &a->u.net->v6info.daddr,\r\na->u.net->dport,\r\n"daddr", "dest");\r\nbreak;\r\n}\r\nif (a->u.net->netif > 0) {\r\nstruct net_device *dev;\r\ndev = dev_get_by_index(&init_net, a->u.net->netif);\r\nif (dev) {\r\naudit_log_format(ab, " netif=%s", dev->name);\r\ndev_put(dev);\r\n}\r\n}\r\nbreak;\r\n#ifdef CONFIG_KEYS\r\ncase LSM_AUDIT_DATA_KEY:\r\naudit_log_format(ab, " key_serial=%u", a->u.key_struct.key);\r\nif (a->u.key_struct.key_desc) {\r\naudit_log_format(ab, " key_desc=");\r\naudit_log_untrustedstring(ab, a->u.key_struct.key_desc);\r\n}\r\nbreak;\r\n#endif\r\ncase LSM_AUDIT_DATA_KMOD:\r\naudit_log_format(ab, " kmod=");\r\naudit_log_untrustedstring(ab, a->u.kmod_name);\r\nbreak;\r\n}\r\n}\r\nvoid common_lsm_audit(struct common_audit_data *a,\r\nvoid (*pre_audit)(struct audit_buffer *, void *),\r\nvoid (*post_audit)(struct audit_buffer *, void *))\r\n{\r\nstruct audit_buffer *ab;\r\nif (a == NULL)\r\nreturn;\r\nab = audit_log_start(current->audit_context, GFP_ATOMIC, AUDIT_AVC);\r\nif (ab == NULL)\r\nreturn;\r\nif (pre_audit)\r\npre_audit(ab, a);\r\ndump_common_audit_data(ab, a);\r\nif (post_audit)\r\npost_audit(ab, a);\r\naudit_log_end(ab);\r\n}

static inline u16 channel2freq_bg(u8 channel)\r\n{\r\nB43_WARN_ON(!(channel >= 1 && channel <= 14));\r\nreturn b43_radio_channel_codes_bg[channel - 1];\r\n}\r\nstatic void generate_rfatt_list(struct b43_wldev *dev,\r\nstruct b43_rfatt_list *list)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstatic const struct b43_rfatt rfatt_0[] = {\r\n{.att = 3,.with_padmix = 0,},\r\n{.att = 1,.with_padmix = 0,},\r\n{.att = 5,.with_padmix = 0,},\r\n{.att = 7,.with_padmix = 0,},\r\n{.att = 9,.with_padmix = 0,},\r\n{.att = 2,.with_padmix = 0,},\r\n{.att = 0,.with_padmix = 0,},\r\n{.att = 4,.with_padmix = 0,},\r\n{.att = 6,.with_padmix = 0,},\r\n{.att = 8,.with_padmix = 0,},\r\n{.att = 1,.with_padmix = 1,},\r\n{.att = 2,.with_padmix = 1,},\r\n{.att = 3,.with_padmix = 1,},\r\n{.att = 4,.with_padmix = 1,},\r\n};\r\nstatic const struct b43_rfatt rfatt_1[] = {\r\n{.att = 2,.with_padmix = 1,},\r\n{.att = 4,.with_padmix = 1,},\r\n{.att = 6,.with_padmix = 1,},\r\n{.att = 8,.with_padmix = 1,},\r\n{.att = 10,.with_padmix = 1,},\r\n{.att = 12,.with_padmix = 1,},\r\n{.att = 14,.with_padmix = 1,},\r\n};\r\nstatic const struct b43_rfatt rfatt_2[] = {\r\n{.att = 0,.with_padmix = 1,},\r\n{.att = 2,.with_padmix = 1,},\r\n{.att = 4,.with_padmix = 1,},\r\n{.att = 6,.with_padmix = 1,},\r\n{.att = 8,.with_padmix = 1,},\r\n{.att = 9,.with_padmix = 1,},\r\n{.att = 9,.with_padmix = 1,},\r\n};\r\nif (!b43_has_hardware_pctl(dev)) {\r\nlist->list = rfatt_0;\r\nlist->len = ARRAY_SIZE(rfatt_0);\r\nlist->min_val = 0;\r\nlist->max_val = 9;\r\nreturn;\r\n}\r\nif (phy->radio_ver == 0x2050 && phy->radio_rev == 8) {\r\nlist->list = rfatt_1;\r\nlist->len = ARRAY_SIZE(rfatt_1);\r\nlist->min_val = 0;\r\nlist->max_val = 14;\r\nreturn;\r\n}\r\nlist->list = rfatt_2;\r\nlist->len = ARRAY_SIZE(rfatt_2);\r\nlist->min_val = 0;\r\nlist->max_val = 9;\r\n}\r\nstatic void generate_bbatt_list(struct b43_wldev *dev,\r\nstruct b43_bbatt_list *list)\r\n{\r\nstatic const struct b43_bbatt bbatt_0[] = {\r\n{.att = 0,},\r\n{.att = 1,},\r\n{.att = 2,},\r\n{.att = 3,},\r\n{.att = 4,},\r\n{.att = 5,},\r\n{.att = 6,},\r\n{.att = 7,},\r\n{.att = 8,},\r\n};\r\nlist->list = bbatt_0;\r\nlist->len = ARRAY_SIZE(bbatt_0);\r\nlist->min_val = 0;\r\nlist->max_val = 8;\r\n}\r\nstatic void b43_shm_clear_tssi(struct b43_wldev *dev)\r\n{\r\nb43_shm_write16(dev, B43_SHM_SHARED, 0x0058, 0x7F7F);\r\nb43_shm_write16(dev, B43_SHM_SHARED, 0x005a, 0x7F7F);\r\nb43_shm_write16(dev, B43_SHM_SHARED, 0x0070, 0x7F7F);\r\nb43_shm_write16(dev, B43_SHM_SHARED, 0x0072, 0x7F7F);\r\n}\r\nstatic void b43_synth_pu_workaround(struct b43_wldev *dev, u8 channel)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nmight_sleep();\r\nif (phy->radio_ver != 0x2050 || phy->radio_rev >= 6) {\r\nreturn;\r\n}\r\nif (channel <= 10) {\r\nb43_write16(dev, B43_MMIO_CHANNEL,\r\nchannel2freq_bg(channel + 4));\r\n} else {\r\nb43_write16(dev, B43_MMIO_CHANNEL, channel2freq_bg(1));\r\n}\r\nmsleep(1);\r\nb43_write16(dev, B43_MMIO_CHANNEL, channel2freq_bg(channel));\r\n}\r\nvoid b43_gphy_set_baseband_attenuation(struct b43_wldev *dev,\r\nu16 baseband_attenuation)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nif (phy->analog == 0) {\r\nb43_write16(dev, B43_MMIO_PHY0, (b43_read16(dev, B43_MMIO_PHY0)\r\n& 0xFFF0) |\r\nbaseband_attenuation);\r\n} else if (phy->analog > 1) {\r\nb43_phy_maskset(dev, B43_PHY_DACCTL, 0xFFC3, (baseband_attenuation << 2));\r\n} else {\r\nb43_phy_maskset(dev, B43_PHY_DACCTL, 0xFF87, (baseband_attenuation << 3));\r\n}\r\n}\r\nstatic void b43_set_txpower_g(struct b43_wldev *dev,\r\nconst struct b43_bbatt *bbatt,\r\nconst struct b43_rfatt *rfatt, u8 tx_control)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_g *gphy = phy->g;\r\nstruct b43_txpower_lo_control *lo = gphy->lo_control;\r\nu16 bb, rf;\r\nu16 tx_bias, tx_magn;\r\nbb = bbatt->att;\r\nrf = rfatt->att;\r\ntx_bias = lo->tx_bias;\r\ntx_magn = lo->tx_magn;\r\nif (unlikely(tx_bias == 0xFF))\r\ntx_bias = 0;\r\ngphy->tx_control = tx_control;\r\nmemmove(&gphy->rfatt, rfatt, sizeof(*rfatt));\r\ngphy->rfatt.with_padmix = !!(tx_control & B43_TXCTL_TXMIX);\r\nmemmove(&gphy->bbatt, bbatt, sizeof(*bbatt));\r\nif (b43_debug(dev, B43_DBG_XMITPOWER)) {\r\nb43dbg(dev->wl, "Tuning TX-power to bbatt(%u), "\r\n"rfatt(%u), tx_control(0x%02X), "\r\n"tx_bias(0x%02X), tx_magn(0x%02X)\n",\r\nbb, rf, tx_control, tx_bias, tx_magn);\r\n}\r\nb43_gphy_set_baseband_attenuation(dev, bb);\r\nb43_shm_write16(dev, B43_SHM_SHARED, B43_SHM_SH_RFATT, rf);\r\nif (phy->radio_ver == 0x2050 && phy->radio_rev == 8) {\r\nb43_radio_write16(dev, 0x43,\r\n(rf & 0x000F) | (tx_control & 0x0070));\r\n} else {\r\nb43_radio_maskset(dev, 0x43, 0xFFF0, (rf & 0x000F));\r\nb43_radio_maskset(dev, 0x52, ~0x0070, (tx_control & 0x0070));\r\n}\r\nif (has_tx_magnification(phy)) {\r\nb43_radio_write16(dev, 0x52, tx_magn | tx_bias);\r\n} else {\r\nb43_radio_maskset(dev, 0x52, 0xFFF0, (tx_bias & 0x000F));\r\n}\r\nb43_lo_g_adjust(dev);\r\n}\r\nstatic void b43_gphy_tssi_power_lt_init(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_g *gphy = dev->phy.g;\r\nint i;\r\nu16 value;\r\nfor (i = 0; i < 32; i++)\r\nb43_ofdmtab_write16(dev, 0x3C20, i, gphy->tssi2dbm[i]);\r\nfor (i = 32; i < 64; i++)\r\nb43_ofdmtab_write16(dev, 0x3C00, i - 32, gphy->tssi2dbm[i]);\r\nfor (i = 0; i < 64; i += 2) {\r\nvalue = (u16) gphy->tssi2dbm[i];\r\nvalue |= ((u16) gphy->tssi2dbm[i + 1]) << 8;\r\nb43_phy_write(dev, 0x380 + (i / 2), value);\r\n}\r\n}\r\nstatic void b43_gphy_gain_lt_init(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_g *gphy = phy->g;\r\nstruct b43_txpower_lo_control *lo = gphy->lo_control;\r\nu16 nr_written = 0;\r\nu16 tmp;\r\nu8 rf, bb;\r\nfor (rf = 0; rf < lo->rfatt_list.len; rf++) {\r\nfor (bb = 0; bb < lo->bbatt_list.len; bb++) {\r\nif (nr_written >= 0x40)\r\nreturn;\r\ntmp = lo->bbatt_list.list[bb].att;\r\ntmp <<= 8;\r\nif (phy->radio_rev == 8)\r\ntmp |= 0x50;\r\nelse\r\ntmp |= 0x40;\r\ntmp |= lo->rfatt_list.list[rf].att;\r\nb43_phy_write(dev, 0x3C0 + nr_written, tmp);\r\nnr_written++;\r\n}\r\n}\r\n}\r\nstatic void b43_set_all_gains(struct b43_wldev *dev,\r\ns16 first, s16 second, s16 third)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nu16 i;\r\nu16 start = 0x08, end = 0x18;\r\nu16 tmp;\r\nu16 table;\r\nif (phy->rev <= 1) {\r\nstart = 0x10;\r\nend = 0x20;\r\n}\r\ntable = B43_OFDMTAB_GAINX;\r\nif (phy->rev <= 1)\r\ntable = B43_OFDMTAB_GAINX_R1;\r\nfor (i = 0; i < 4; i++)\r\nb43_ofdmtab_write16(dev, table, i, first);\r\nfor (i = start; i < end; i++)\r\nb43_ofdmtab_write16(dev, table, i, second);\r\nif (third != -1) {\r\ntmp = ((u16) third << 14) | ((u16) third << 6);\r\nb43_phy_maskset(dev, 0x04A0, 0xBFBF, tmp);\r\nb43_phy_maskset(dev, 0x04A1, 0xBFBF, tmp);\r\nb43_phy_maskset(dev, 0x04A2, 0xBFBF, tmp);\r\n}\r\nb43_dummy_transmission(dev, false, true);\r\n}\r\nstatic void b43_set_original_gains(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nu16 i, tmp;\r\nu16 table;\r\nu16 start = 0x0008, end = 0x0018;\r\nif (phy->rev <= 1) {\r\nstart = 0x0010;\r\nend = 0x0020;\r\n}\r\ntable = B43_OFDMTAB_GAINX;\r\nif (phy->rev <= 1)\r\ntable = B43_OFDMTAB_GAINX_R1;\r\nfor (i = 0; i < 4; i++) {\r\ntmp = (i & 0xFFFC);\r\ntmp |= (i & 0x0001) << 1;\r\ntmp |= (i & 0x0002) >> 1;\r\nb43_ofdmtab_write16(dev, table, i, tmp);\r\n}\r\nfor (i = start; i < end; i++)\r\nb43_ofdmtab_write16(dev, table, i, i - start);\r\nb43_phy_maskset(dev, 0x04A0, 0xBFBF, 0x4040);\r\nb43_phy_maskset(dev, 0x04A1, 0xBFBF, 0x4040);\r\nb43_phy_maskset(dev, 0x04A2, 0xBFBF, 0x4000);\r\nb43_dummy_transmission(dev, false, true);\r\n}\r\nstatic void b43_nrssi_hw_write(struct b43_wldev *dev, u16 offset, s16 val)\r\n{\r\nb43_phy_write(dev, B43_PHY_NRSSILT_CTRL, offset);\r\nb43_phy_write(dev, B43_PHY_NRSSILT_DATA, (u16) val);\r\n}\r\nstatic s16 b43_nrssi_hw_read(struct b43_wldev *dev, u16 offset)\r\n{\r\nu16 val;\r\nb43_phy_write(dev, B43_PHY_NRSSILT_CTRL, offset);\r\nval = b43_phy_read(dev, B43_PHY_NRSSILT_DATA);\r\nreturn (s16) val;\r\n}\r\nstatic void b43_nrssi_hw_update(struct b43_wldev *dev, u16 val)\r\n{\r\nu16 i;\r\ns16 tmp;\r\nfor (i = 0; i < 64; i++) {\r\ntmp = b43_nrssi_hw_read(dev, i);\r\ntmp -= val;\r\ntmp = clamp_val(tmp, -32, 31);\r\nb43_nrssi_hw_write(dev, i, tmp);\r\n}\r\n}\r\nstatic void b43_nrssi_mem_update(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_g *gphy = dev->phy.g;\r\ns16 i, delta;\r\ns32 tmp;\r\ndelta = 0x1F - gphy->nrssi[0];\r\nfor (i = 0; i < 64; i++) {\r\ntmp = (i - delta) * gphy->nrssislope;\r\ntmp /= 0x10000;\r\ntmp += 0x3A;\r\ntmp = clamp_val(tmp, 0, 0x3F);\r\ngphy->nrssi_lt[i] = tmp;\r\n}\r\n}\r\nstatic void b43_calc_nrssi_offset(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nu16 backup[20] = { 0 };\r\ns16 v47F;\r\nu16 i;\r\nu16 saved = 0xFFFF;\r\nbackup[0] = b43_phy_read(dev, 0x0001);\r\nbackup[1] = b43_phy_read(dev, 0x0811);\r\nbackup[2] = b43_phy_read(dev, 0x0812);\r\nif (phy->rev != 1) {\r\nbackup[3] = b43_phy_read(dev, 0x0814);\r\nbackup[4] = b43_phy_read(dev, 0x0815);\r\n}\r\nbackup[5] = b43_phy_read(dev, 0x005A);\r\nbackup[6] = b43_phy_read(dev, 0x0059);\r\nbackup[7] = b43_phy_read(dev, 0x0058);\r\nbackup[8] = b43_phy_read(dev, 0x000A);\r\nbackup[9] = b43_phy_read(dev, 0x0003);\r\nbackup[10] = b43_radio_read16(dev, 0x007A);\r\nbackup[11] = b43_radio_read16(dev, 0x0043);\r\nb43_phy_mask(dev, 0x0429, 0x7FFF);\r\nb43_phy_maskset(dev, 0x0001, 0x3FFF, 0x4000);\r\nb43_phy_set(dev, 0x0811, 0x000C);\r\nb43_phy_maskset(dev, 0x0812, 0xFFF3, 0x0004);\r\nb43_phy_mask(dev, 0x0802, ~(0x1 | 0x2));\r\nif (phy->rev >= 6) {\r\nbackup[12] = b43_phy_read(dev, 0x002E);\r\nbackup[13] = b43_phy_read(dev, 0x002F);\r\nbackup[14] = b43_phy_read(dev, 0x080F);\r\nbackup[15] = b43_phy_read(dev, 0x0810);\r\nbackup[16] = b43_phy_read(dev, 0x0801);\r\nbackup[17] = b43_phy_read(dev, 0x0060);\r\nbackup[18] = b43_phy_read(dev, 0x0014);\r\nbackup[19] = b43_phy_read(dev, 0x0478);\r\nb43_phy_write(dev, 0x002E, 0);\r\nb43_phy_write(dev, 0x002F, 0);\r\nb43_phy_write(dev, 0x080F, 0);\r\nb43_phy_write(dev, 0x0810, 0);\r\nb43_phy_set(dev, 0x0478, 0x0100);\r\nb43_phy_set(dev, 0x0801, 0x0040);\r\nb43_phy_set(dev, 0x0060, 0x0040);\r\nb43_phy_set(dev, 0x0014, 0x0200);\r\n}\r\nb43_radio_set(dev, 0x007A, 0x0070);\r\nb43_radio_set(dev, 0x007A, 0x0080);\r\nudelay(30);\r\nv47F = (s16) ((b43_phy_read(dev, 0x047F) >> 8) & 0x003F);\r\nif (v47F >= 0x20)\r\nv47F -= 0x40;\r\nif (v47F == 31) {\r\nfor (i = 7; i >= 4; i--) {\r\nb43_radio_write16(dev, 0x007B, i);\r\nudelay(20);\r\nv47F =\r\n(s16) ((b43_phy_read(dev, 0x047F) >> 8) & 0x003F);\r\nif (v47F >= 0x20)\r\nv47F -= 0x40;\r\nif (v47F < 31 && saved == 0xFFFF)\r\nsaved = i;\r\n}\r\nif (saved == 0xFFFF)\r\nsaved = 4;\r\n} else {\r\nb43_radio_mask(dev, 0x007A, 0x007F);\r\nif (phy->rev != 1) {\r\nb43_phy_set(dev, 0x0814, 0x0001);\r\nb43_phy_mask(dev, 0x0815, 0xFFFE);\r\n}\r\nb43_phy_set(dev, 0x0811, 0x000C);\r\nb43_phy_set(dev, 0x0812, 0x000C);\r\nb43_phy_set(dev, 0x0811, 0x0030);\r\nb43_phy_set(dev, 0x0812, 0x0030);\r\nb43_phy_write(dev, 0x005A, 0x0480);\r\nb43_phy_write(dev, 0x0059, 0x0810);\r\nb43_phy_write(dev, 0x0058, 0x000D);\r\nif (phy->rev == 0) {\r\nb43_phy_write(dev, 0x0003, 0x0122);\r\n} else {\r\nb43_phy_set(dev, 0x000A, 0x2000);\r\n}\r\nif (phy->rev != 1) {\r\nb43_phy_set(dev, 0x0814, 0x0004);\r\nb43_phy_mask(dev, 0x0815, 0xFFFB);\r\n}\r\nb43_phy_maskset(dev, 0x0003, 0xFF9F, 0x0040);\r\nb43_radio_set(dev, 0x007A, 0x000F);\r\nb43_set_all_gains(dev, 3, 0, 1);\r\nb43_radio_maskset(dev, 0x0043, 0x00F0, 0x000F);\r\nudelay(30);\r\nv47F = (s16) ((b43_phy_read(dev, 0x047F) >> 8) & 0x003F);\r\nif (v47F >= 0x20)\r\nv47F -= 0x40;\r\nif (v47F == -32) {\r\nfor (i = 0; i < 4; i++) {\r\nb43_radio_write16(dev, 0x007B, i);\r\nudelay(20);\r\nv47F =\r\n(s16) ((b43_phy_read(dev, 0x047F) >> 8) &\r\n0x003F);\r\nif (v47F >= 0x20)\r\nv47F -= 0x40;\r\nif (v47F > -31 && saved == 0xFFFF)\r\nsaved = i;\r\n}\r\nif (saved == 0xFFFF)\r\nsaved = 3;\r\n} else\r\nsaved = 0;\r\n}\r\nb43_radio_write16(dev, 0x007B, saved);\r\nif (phy->rev >= 6) {\r\nb43_phy_write(dev, 0x002E, backup[12]);\r\nb43_phy_write(dev, 0x002F, backup[13]);\r\nb43_phy_write(dev, 0x080F, backup[14]);\r\nb43_phy_write(dev, 0x0810, backup[15]);\r\n}\r\nif (phy->rev != 1) {\r\nb43_phy_write(dev, 0x0814, backup[3]);\r\nb43_phy_write(dev, 0x0815, backup[4]);\r\n}\r\nb43_phy_write(dev, 0x005A, backup[5]);\r\nb43_phy_write(dev, 0x0059, backup[6]);\r\nb43_phy_write(dev, 0x0058, backup[7]);\r\nb43_phy_write(dev, 0x000A, backup[8]);\r\nb43_phy_write(dev, 0x0003, backup[9]);\r\nb43_radio_write16(dev, 0x0043, backup[11]);\r\nb43_radio_write16(dev, 0x007A, backup[10]);\r\nb43_phy_write(dev, 0x0802, b43_phy_read(dev, 0x0802) | 0x1 | 0x2);\r\nb43_phy_set(dev, 0x0429, 0x8000);\r\nb43_set_original_gains(dev);\r\nif (phy->rev >= 6) {\r\nb43_phy_write(dev, 0x0801, backup[16]);\r\nb43_phy_write(dev, 0x0060, backup[17]);\r\nb43_phy_write(dev, 0x0014, backup[18]);\r\nb43_phy_write(dev, 0x0478, backup[19]);\r\n}\r\nb43_phy_write(dev, 0x0001, backup[0]);\r\nb43_phy_write(dev, 0x0812, backup[2]);\r\nb43_phy_write(dev, 0x0811, backup[1]);\r\n}\r\nstatic void b43_calc_nrssi_slope(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_g *gphy = phy->g;\r\nu16 backup[18] = { 0 };\r\nu16 tmp;\r\ns16 nrssi0, nrssi1;\r\nB43_WARN_ON(phy->type != B43_PHYTYPE_G);\r\nif (phy->radio_rev >= 9)\r\nreturn;\r\nif (phy->radio_rev == 8)\r\nb43_calc_nrssi_offset(dev);\r\nb43_phy_mask(dev, B43_PHY_G_CRS, 0x7FFF);\r\nb43_phy_mask(dev, 0x0802, 0xFFFC);\r\nbackup[7] = b43_read16(dev, 0x03E2);\r\nb43_write16(dev, 0x03E2, b43_read16(dev, 0x03E2) | 0x8000);\r\nbackup[0] = b43_radio_read16(dev, 0x007A);\r\nbackup[1] = b43_radio_read16(dev, 0x0052);\r\nbackup[2] = b43_radio_read16(dev, 0x0043);\r\nbackup[3] = b43_phy_read(dev, 0x0015);\r\nbackup[4] = b43_phy_read(dev, 0x005A);\r\nbackup[5] = b43_phy_read(dev, 0x0059);\r\nbackup[6] = b43_phy_read(dev, 0x0058);\r\nbackup[8] = b43_read16(dev, 0x03E6);\r\nbackup[9] = b43_read16(dev, B43_MMIO_CHANNEL_EXT);\r\nif (phy->rev >= 3) {\r\nbackup[10] = b43_phy_read(dev, 0x002E);\r\nbackup[11] = b43_phy_read(dev, 0x002F);\r\nbackup[12] = b43_phy_read(dev, 0x080F);\r\nbackup[13] = b43_phy_read(dev, B43_PHY_G_LO_CONTROL);\r\nbackup[14] = b43_phy_read(dev, 0x0801);\r\nbackup[15] = b43_phy_read(dev, 0x0060);\r\nbackup[16] = b43_phy_read(dev, 0x0014);\r\nbackup[17] = b43_phy_read(dev, 0x0478);\r\nb43_phy_write(dev, 0x002E, 0);\r\nb43_phy_write(dev, B43_PHY_G_LO_CONTROL, 0);\r\nswitch (phy->rev) {\r\ncase 4:\r\ncase 6:\r\ncase 7:\r\nb43_phy_set(dev, 0x0478, 0x0100);\r\nb43_phy_set(dev, 0x0801, 0x0040);\r\nbreak;\r\ncase 3:\r\ncase 5:\r\nb43_phy_mask(dev, 0x0801, 0xFFBF);\r\nbreak;\r\n}\r\nb43_phy_set(dev, 0x0060, 0x0040);\r\nb43_phy_set(dev, 0x0014, 0x0200);\r\n}\r\nb43_radio_set(dev, 0x007A, 0x0070);\r\nb43_set_all_gains(dev, 0, 8, 0);\r\nb43_radio_mask(dev, 0x007A, 0x00F7);\r\nif (phy->rev >= 2) {\r\nb43_phy_maskset(dev, 0x0811, 0xFFCF, 0x0030);\r\nb43_phy_maskset(dev, 0x0812, 0xFFCF, 0x0010);\r\n}\r\nb43_radio_set(dev, 0x007A, 0x0080);\r\nudelay(20);\r\nnrssi0 = (s16) ((b43_phy_read(dev, 0x047F) >> 8) & 0x003F);\r\nif (nrssi0 >= 0x0020)\r\nnrssi0 -= 0x0040;\r\nb43_radio_mask(dev, 0x007A, 0x007F);\r\nif (phy->rev >= 2) {\r\nb43_phy_maskset(dev, 0x0003, 0xFF9F, 0x0040);\r\n}\r\nb43_write16(dev, B43_MMIO_CHANNEL_EXT,\r\nb43_read16(dev, B43_MMIO_CHANNEL_EXT)\r\n| 0x2000);\r\nb43_radio_set(dev, 0x007A, 0x000F);\r\nb43_phy_write(dev, 0x0015, 0xF330);\r\nif (phy->rev >= 2) {\r\nb43_phy_maskset(dev, 0x0812, 0xFFCF, 0x0020);\r\nb43_phy_maskset(dev, 0x0811, 0xFFCF, 0x0020);\r\n}\r\nb43_set_all_gains(dev, 3, 0, 1);\r\nif (phy->radio_rev == 8) {\r\nb43_radio_write16(dev, 0x0043, 0x001F);\r\n} else {\r\ntmp = b43_radio_read16(dev, 0x0052) & 0xFF0F;\r\nb43_radio_write16(dev, 0x0052, tmp | 0x0060);\r\ntmp = b43_radio_read16(dev, 0x0043) & 0xFFF0;\r\nb43_radio_write16(dev, 0x0043, tmp | 0x0009);\r\n}\r\nb43_phy_write(dev, 0x005A, 0x0480);\r\nb43_phy_write(dev, 0x0059, 0x0810);\r\nb43_phy_write(dev, 0x0058, 0x000D);\r\nudelay(20);\r\nnrssi1 = (s16) ((b43_phy_read(dev, 0x047F) >> 8) & 0x003F);\r\nif (nrssi1 >= 0x0020)\r\nnrssi1 -= 0x0040;\r\nif (nrssi0 == nrssi1)\r\ngphy->nrssislope = 0x00010000;\r\nelse\r\ngphy->nrssislope = 0x00400000 / (nrssi0 - nrssi1);\r\nif (nrssi0 >= -4) {\r\ngphy->nrssi[0] = nrssi1;\r\ngphy->nrssi[1] = nrssi0;\r\n}\r\nif (phy->rev >= 3) {\r\nb43_phy_write(dev, 0x002E, backup[10]);\r\nb43_phy_write(dev, 0x002F, backup[11]);\r\nb43_phy_write(dev, 0x080F, backup[12]);\r\nb43_phy_write(dev, B43_PHY_G_LO_CONTROL, backup[13]);\r\n}\r\nif (phy->rev >= 2) {\r\nb43_phy_mask(dev, 0x0812, 0xFFCF);\r\nb43_phy_mask(dev, 0x0811, 0xFFCF);\r\n}\r\nb43_radio_write16(dev, 0x007A, backup[0]);\r\nb43_radio_write16(dev, 0x0052, backup[1]);\r\nb43_radio_write16(dev, 0x0043, backup[2]);\r\nb43_write16(dev, 0x03E2, backup[7]);\r\nb43_write16(dev, 0x03E6, backup[8]);\r\nb43_write16(dev, B43_MMIO_CHANNEL_EXT, backup[9]);\r\nb43_phy_write(dev, 0x0015, backup[3]);\r\nb43_phy_write(dev, 0x005A, backup[4]);\r\nb43_phy_write(dev, 0x0059, backup[5]);\r\nb43_phy_write(dev, 0x0058, backup[6]);\r\nb43_synth_pu_workaround(dev, phy->channel);\r\nb43_phy_set(dev, 0x0802, (0x0001 | 0x0002));\r\nb43_set_original_gains(dev);\r\nb43_phy_set(dev, B43_PHY_G_CRS, 0x8000);\r\nif (phy->rev >= 3) {\r\nb43_phy_write(dev, 0x0801, backup[14]);\r\nb43_phy_write(dev, 0x0060, backup[15]);\r\nb43_phy_write(dev, 0x0014, backup[16]);\r\nb43_phy_write(dev, 0x0478, backup[17]);\r\n}\r\nb43_nrssi_mem_update(dev);\r\nb43_calc_nrssi_threshold(dev);\r\n}\r\nstatic void b43_calc_nrssi_threshold(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_g *gphy = phy->g;\r\ns32 a, b;\r\ns16 tmp16;\r\nu16 tmp_u16;\r\nB43_WARN_ON(phy->type != B43_PHYTYPE_G);\r\nif (!phy->gmode ||\r\n!(dev->dev->bus_sprom->boardflags_lo & B43_BFL_RSSI)) {\r\ntmp16 = b43_nrssi_hw_read(dev, 0x20);\r\nif (tmp16 >= 0x20)\r\ntmp16 -= 0x40;\r\nif (tmp16 < 3) {\r\nb43_phy_maskset(dev, 0x048A, 0xF000, 0x09EB);\r\n} else {\r\nb43_phy_maskset(dev, 0x048A, 0xF000, 0x0AED);\r\n}\r\n} else {\r\nif (gphy->interfmode == B43_INTERFMODE_NONWLAN) {\r\na = 0xE;\r\nb = 0xA;\r\n} else if (!gphy->aci_wlan_automatic && gphy->aci_enable) {\r\na = 0x13;\r\nb = 0x12;\r\n} else {\r\na = 0xE;\r\nb = 0x11;\r\n}\r\na = a * (gphy->nrssi[1] - gphy->nrssi[0]);\r\na += (gphy->nrssi[0] << 6);\r\nif (a < 32)\r\na += 31;\r\nelse\r\na += 32;\r\na = a >> 6;\r\na = clamp_val(a, -31, 31);\r\nb = b * (gphy->nrssi[1] - gphy->nrssi[0]);\r\nb += (gphy->nrssi[0] << 6);\r\nif (b < 32)\r\nb += 31;\r\nelse\r\nb += 32;\r\nb = b >> 6;\r\nb = clamp_val(b, -31, 31);\r\ntmp_u16 = b43_phy_read(dev, 0x048A) & 0xF000;\r\ntmp_u16 |= ((u32) b & 0x0000003F);\r\ntmp_u16 |= (((u32) a & 0x0000003F) << 6);\r\nb43_phy_write(dev, 0x048A, tmp_u16);\r\n}\r\n}\r\nstatic void _stack_save(u32 *_stackptr, size_t *stackidx,\r\nu8 id, u16 offset, u16 value)\r\n{\r\nu32 *stackptr = &(_stackptr[*stackidx]);\r\nB43_WARN_ON(offset & 0xF000);\r\nB43_WARN_ON(id & 0xF0);\r\n*stackptr = offset;\r\n*stackptr |= ((u32) id) << 12;\r\n*stackptr |= ((u32) value) << 16;\r\n(*stackidx)++;\r\nB43_WARN_ON(*stackidx >= B43_INTERFSTACK_SIZE);\r\n}\r\nstatic u16 _stack_restore(u32 *stackptr, u8 id, u16 offset)\r\n{\r\nsize_t i;\r\nB43_WARN_ON(offset & 0xF000);\r\nB43_WARN_ON(id & 0xF0);\r\nfor (i = 0; i < B43_INTERFSTACK_SIZE; i++, stackptr++) {\r\nif ((*stackptr & 0x00000FFF) != offset)\r\ncontinue;\r\nif (((*stackptr & 0x0000F000) >> 12) != id)\r\ncontinue;\r\nreturn ((*stackptr & 0xFFFF0000) >> 16);\r\n}\r\nB43_WARN_ON(1);\r\nreturn 0;\r\n}\r\nstatic void\r\nb43_radio_interference_mitigation_enable(struct b43_wldev *dev, int mode)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_g *gphy = phy->g;\r\nu16 tmp, flipped;\r\nsize_t stackidx = 0;\r\nu32 *stack = gphy->interfstack;\r\nswitch (mode) {\r\ncase B43_INTERFMODE_NONWLAN:\r\nif (phy->rev != 1) {\r\nb43_phy_set(dev, 0x042B, 0x0800);\r\nb43_phy_mask(dev, B43_PHY_G_CRS, ~0x4000);\r\nbreak;\r\n}\r\nradio_stacksave(0x0078);\r\ntmp = (b43_radio_read16(dev, 0x0078) & 0x001E);\r\nB43_WARN_ON(tmp > 15);\r\nflipped = bitrev4(tmp);\r\nif (flipped < 10 && flipped >= 8)\r\nflipped = 7;\r\nelse if (flipped >= 10)\r\nflipped -= 3;\r\nflipped = (bitrev4(flipped) << 1) | 0x0020;\r\nb43_radio_write16(dev, 0x0078, flipped);\r\nb43_calc_nrssi_threshold(dev);\r\nphy_stacksave(0x0406);\r\nb43_phy_write(dev, 0x0406, 0x7E28);\r\nb43_phy_set(dev, 0x042B, 0x0800);\r\nb43_phy_set(dev, B43_PHY_RADIO_BITFIELD, 0x1000);\r\nphy_stacksave(0x04A0);\r\nb43_phy_maskset(dev, 0x04A0, 0xC0C0, 0x0008);\r\nphy_stacksave(0x04A1);\r\nb43_phy_maskset(dev, 0x04A1, 0xC0C0, 0x0605);\r\nphy_stacksave(0x04A2);\r\nb43_phy_maskset(dev, 0x04A2, 0xC0C0, 0x0204);\r\nphy_stacksave(0x04A8);\r\nb43_phy_maskset(dev, 0x04A8, 0xC0C0, 0x0803);\r\nphy_stacksave(0x04AB);\r\nb43_phy_maskset(dev, 0x04AB, 0xC0C0, 0x0605);\r\nphy_stacksave(0x04A7);\r\nb43_phy_write(dev, 0x04A7, 0x0002);\r\nphy_stacksave(0x04A3);\r\nb43_phy_write(dev, 0x04A3, 0x287A);\r\nphy_stacksave(0x04A9);\r\nb43_phy_write(dev, 0x04A9, 0x2027);\r\nphy_stacksave(0x0493);\r\nb43_phy_write(dev, 0x0493, 0x32F5);\r\nphy_stacksave(0x04AA);\r\nb43_phy_write(dev, 0x04AA, 0x2027);\r\nphy_stacksave(0x04AC);\r\nb43_phy_write(dev, 0x04AC, 0x32F5);\r\nbreak;\r\ncase B43_INTERFMODE_MANUALWLAN:\r\nif (b43_phy_read(dev, 0x0033) & 0x0800)\r\nbreak;\r\ngphy->aci_enable = true;\r\nphy_stacksave(B43_PHY_RADIO_BITFIELD);\r\nphy_stacksave(B43_PHY_G_CRS);\r\nif (phy->rev < 2) {\r\nphy_stacksave(0x0406);\r\n} else {\r\nphy_stacksave(0x04C0);\r\nphy_stacksave(0x04C1);\r\n}\r\nphy_stacksave(0x0033);\r\nphy_stacksave(0x04A7);\r\nphy_stacksave(0x04A3);\r\nphy_stacksave(0x04A9);\r\nphy_stacksave(0x04AA);\r\nphy_stacksave(0x04AC);\r\nphy_stacksave(0x0493);\r\nphy_stacksave(0x04A1);\r\nphy_stacksave(0x04A0);\r\nphy_stacksave(0x04A2);\r\nphy_stacksave(0x048A);\r\nphy_stacksave(0x04A8);\r\nphy_stacksave(0x04AB);\r\nif (phy->rev == 2) {\r\nphy_stacksave(0x04AD);\r\nphy_stacksave(0x04AE);\r\n} else if (phy->rev >= 3) {\r\nphy_stacksave(0x04AD);\r\nphy_stacksave(0x0415);\r\nphy_stacksave(0x0416);\r\nphy_stacksave(0x0417);\r\nofdmtab_stacksave(0x1A00, 0x2);\r\nofdmtab_stacksave(0x1A00, 0x3);\r\n}\r\nphy_stacksave(0x042B);\r\nphy_stacksave(0x048C);\r\nb43_phy_mask(dev, B43_PHY_RADIO_BITFIELD, ~0x1000);\r\nb43_phy_maskset(dev, B43_PHY_G_CRS, 0xFFFC, 0x0002);\r\nb43_phy_write(dev, 0x0033, 0x0800);\r\nb43_phy_write(dev, 0x04A3, 0x2027);\r\nb43_phy_write(dev, 0x04A9, 0x1CA8);\r\nb43_phy_write(dev, 0x0493, 0x287A);\r\nb43_phy_write(dev, 0x04AA, 0x1CA8);\r\nb43_phy_write(dev, 0x04AC, 0x287A);\r\nb43_phy_maskset(dev, 0x04A0, 0xFFC0, 0x001A);\r\nb43_phy_write(dev, 0x04A7, 0x000D);\r\nif (phy->rev < 2) {\r\nb43_phy_write(dev, 0x0406, 0xFF0D);\r\n} else if (phy->rev == 2) {\r\nb43_phy_write(dev, 0x04C0, 0xFFFF);\r\nb43_phy_write(dev, 0x04C1, 0x00A9);\r\n} else {\r\nb43_phy_write(dev, 0x04C0, 0x00C1);\r\nb43_phy_write(dev, 0x04C1, 0x0059);\r\n}\r\nb43_phy_maskset(dev, 0x04A1, 0xC0FF, 0x1800);\r\nb43_phy_maskset(dev, 0x04A1, 0xFFC0, 0x0015);\r\nb43_phy_maskset(dev, 0x04A8, 0xCFFF, 0x1000);\r\nb43_phy_maskset(dev, 0x04A8, 0xF0FF, 0x0A00);\r\nb43_phy_maskset(dev, 0x04AB, 0xCFFF, 0x1000);\r\nb43_phy_maskset(dev, 0x04AB, 0xF0FF, 0x0800);\r\nb43_phy_maskset(dev, 0x04AB, 0xFFCF, 0x0010);\r\nb43_phy_maskset(dev, 0x04AB, 0xFFF0, 0x0005);\r\nb43_phy_maskset(dev, 0x04A8, 0xFFCF, 0x0010);\r\nb43_phy_maskset(dev, 0x04A8, 0xFFF0, 0x0006);\r\nb43_phy_maskset(dev, 0x04A2, 0xF0FF, 0x0800);\r\nb43_phy_maskset(dev, 0x04A0, 0xF0FF, 0x0500);\r\nb43_phy_maskset(dev, 0x04A2, 0xFFF0, 0x000B);\r\nif (phy->rev >= 3) {\r\nb43_phy_mask(dev, 0x048A, 0x7FFF);\r\nb43_phy_maskset(dev, 0x0415, 0x8000, 0x36D8);\r\nb43_phy_maskset(dev, 0x0416, 0x8000, 0x36D8);\r\nb43_phy_maskset(dev, 0x0417, 0xFE00, 0x016D);\r\n} else {\r\nb43_phy_set(dev, 0x048A, 0x1000);\r\nb43_phy_maskset(dev, 0x048A, 0x9FFF, 0x2000);\r\nb43_hf_write(dev, b43_hf_read(dev) | B43_HF_ACIW);\r\n}\r\nif (phy->rev >= 2) {\r\nb43_phy_set(dev, 0x042B, 0x0800);\r\n}\r\nb43_phy_maskset(dev, 0x048C, 0xF0FF, 0x0200);\r\nif (phy->rev == 2) {\r\nb43_phy_maskset(dev, 0x04AE, 0xFF00, 0x007F);\r\nb43_phy_maskset(dev, 0x04AD, 0x00FF, 0x1300);\r\n} else if (phy->rev >= 6) {\r\nb43_ofdmtab_write16(dev, 0x1A00, 0x3, 0x007F);\r\nb43_ofdmtab_write16(dev, 0x1A00, 0x2, 0x007F);\r\nb43_phy_mask(dev, 0x04AD, 0x00FF);\r\n}\r\nb43_calc_nrssi_slope(dev);\r\nbreak;\r\ndefault:\r\nB43_WARN_ON(1);\r\n}\r\n}\r\nstatic void\r\nb43_radio_interference_mitigation_disable(struct b43_wldev *dev, int mode)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_g *gphy = phy->g;\r\nu32 *stack = gphy->interfstack;\r\nswitch (mode) {\r\ncase B43_INTERFMODE_NONWLAN:\r\nif (phy->rev != 1) {\r\nb43_phy_mask(dev, 0x042B, ~0x0800);\r\nb43_phy_set(dev, B43_PHY_G_CRS, 0x4000);\r\nbreak;\r\n}\r\nradio_stackrestore(0x0078);\r\nb43_calc_nrssi_threshold(dev);\r\nphy_stackrestore(0x0406);\r\nb43_phy_mask(dev, 0x042B, ~0x0800);\r\nif (!dev->bad_frames_preempt) {\r\nb43_phy_mask(dev, B43_PHY_RADIO_BITFIELD, ~(1 << 11));\r\n}\r\nb43_phy_set(dev, B43_PHY_G_CRS, 0x4000);\r\nphy_stackrestore(0x04A0);\r\nphy_stackrestore(0x04A1);\r\nphy_stackrestore(0x04A2);\r\nphy_stackrestore(0x04A8);\r\nphy_stackrestore(0x04AB);\r\nphy_stackrestore(0x04A7);\r\nphy_stackrestore(0x04A3);\r\nphy_stackrestore(0x04A9);\r\nphy_stackrestore(0x0493);\r\nphy_stackrestore(0x04AA);\r\nphy_stackrestore(0x04AC);\r\nbreak;\r\ncase B43_INTERFMODE_MANUALWLAN:\r\nif (!(b43_phy_read(dev, 0x0033) & 0x0800))\r\nbreak;\r\ngphy->aci_enable = false;\r\nphy_stackrestore(B43_PHY_RADIO_BITFIELD);\r\nphy_stackrestore(B43_PHY_G_CRS);\r\nphy_stackrestore(0x0033);\r\nphy_stackrestore(0x04A3);\r\nphy_stackrestore(0x04A9);\r\nphy_stackrestore(0x0493);\r\nphy_stackrestore(0x04AA);\r\nphy_stackrestore(0x04AC);\r\nphy_stackrestore(0x04A0);\r\nphy_stackrestore(0x04A7);\r\nif (phy->rev >= 2) {\r\nphy_stackrestore(0x04C0);\r\nphy_stackrestore(0x04C1);\r\n} else\r\nphy_stackrestore(0x0406);\r\nphy_stackrestore(0x04A1);\r\nphy_stackrestore(0x04AB);\r\nphy_stackrestore(0x04A8);\r\nif (phy->rev == 2) {\r\nphy_stackrestore(0x04AD);\r\nphy_stackrestore(0x04AE);\r\n} else if (phy->rev >= 3) {\r\nphy_stackrestore(0x04AD);\r\nphy_stackrestore(0x0415);\r\nphy_stackrestore(0x0416);\r\nphy_stackrestore(0x0417);\r\nofdmtab_stackrestore(0x1A00, 0x2);\r\nofdmtab_stackrestore(0x1A00, 0x3);\r\n}\r\nphy_stackrestore(0x04A2);\r\nphy_stackrestore(0x048A);\r\nphy_stackrestore(0x042B);\r\nphy_stackrestore(0x048C);\r\nb43_hf_write(dev, b43_hf_read(dev) & ~B43_HF_ACIW);\r\nb43_calc_nrssi_slope(dev);\r\nbreak;\r\ndefault:\r\nB43_WARN_ON(1);\r\n}\r\n}\r\nstatic u16 b43_radio_core_calibration_value(struct b43_wldev *dev)\r\n{\r\nu16 reg, index, ret;\r\nstatic const u8 rcc_table[] = {\r\n0x02, 0x03, 0x01, 0x0F,\r\n0x06, 0x07, 0x05, 0x0F,\r\n0x0A, 0x0B, 0x09, 0x0F,\r\n0x0E, 0x0F, 0x0D, 0x0F,\r\n};\r\nreg = b43_radio_read16(dev, 0x60);\r\nindex = (reg & 0x001E) >> 1;\r\nret = rcc_table[index] << 1;\r\nret |= (reg & 0x0001);\r\nret |= 0x0020;\r\nreturn ret;\r\n}\r\nstatic u16 radio2050_rfover_val(struct b43_wldev *dev,\r\nu16 phy_register, unsigned int lpd)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_g *gphy = phy->g;\r\nstruct ssb_sprom *sprom = dev->dev->bus_sprom;\r\nif (!phy->gmode)\r\nreturn 0;\r\nif (has_loopback_gain(phy)) {\r\nint max_lb_gain = gphy->max_lb_gain;\r\nu16 extlna;\r\nu16 i;\r\nif (phy->radio_rev == 8)\r\nmax_lb_gain += 0x3E;\r\nelse\r\nmax_lb_gain += 0x26;\r\nif (max_lb_gain >= 0x46) {\r\nextlna = 0x3000;\r\nmax_lb_gain -= 0x46;\r\n} else if (max_lb_gain >= 0x3A) {\r\nextlna = 0x1000;\r\nmax_lb_gain -= 0x3A;\r\n} else if (max_lb_gain >= 0x2E) {\r\nextlna = 0x2000;\r\nmax_lb_gain -= 0x2E;\r\n} else {\r\nextlna = 0;\r\nmax_lb_gain -= 0x10;\r\n}\r\nfor (i = 0; i < 16; i++) {\r\nmax_lb_gain -= (i * 6);\r\nif (max_lb_gain < 6)\r\nbreak;\r\n}\r\nif ((phy->rev < 7) ||\r\n!(sprom->boardflags_lo & B43_BFL_EXTLNA)) {\r\nif (phy_register == B43_PHY_RFOVER) {\r\nreturn 0x1B3;\r\n} else if (phy_register == B43_PHY_RFOVERVAL) {\r\nextlna |= (i << 8);\r\nswitch (lpd) {\r\ncase LPD(0, 1, 1):\r\nreturn 0x0F92;\r\ncase LPD(0, 0, 1):\r\ncase LPD(1, 0, 1):\r\nreturn (0x0092 | extlna);\r\ncase LPD(1, 0, 0):\r\nreturn (0x0093 | extlna);\r\n}\r\nB43_WARN_ON(1);\r\n}\r\nB43_WARN_ON(1);\r\n} else {\r\nif (phy_register == B43_PHY_RFOVER) {\r\nreturn 0x9B3;\r\n} else if (phy_register == B43_PHY_RFOVERVAL) {\r\nif (extlna)\r\nextlna |= 0x8000;\r\nextlna |= (i << 8);\r\nswitch (lpd) {\r\ncase LPD(0, 1, 1):\r\nreturn 0x8F92;\r\ncase LPD(0, 0, 1):\r\nreturn (0x8092 | extlna);\r\ncase LPD(1, 0, 1):\r\nreturn (0x2092 | extlna);\r\ncase LPD(1, 0, 0):\r\nreturn (0x2093 | extlna);\r\n}\r\nB43_WARN_ON(1);\r\n}\r\nB43_WARN_ON(1);\r\n}\r\n} else {\r\nif ((phy->rev < 7) ||\r\n!(sprom->boardflags_lo & B43_BFL_EXTLNA)) {\r\nif (phy_register == B43_PHY_RFOVER) {\r\nreturn 0x1B3;\r\n} else if (phy_register == B43_PHY_RFOVERVAL) {\r\nswitch (lpd) {\r\ncase LPD(0, 1, 1):\r\nreturn 0x0FB2;\r\ncase LPD(0, 0, 1):\r\nreturn 0x00B2;\r\ncase LPD(1, 0, 1):\r\nreturn 0x30B2;\r\ncase LPD(1, 0, 0):\r\nreturn 0x30B3;\r\n}\r\nB43_WARN_ON(1);\r\n}\r\nB43_WARN_ON(1);\r\n} else {\r\nif (phy_register == B43_PHY_RFOVER) {\r\nreturn 0x9B3;\r\n} else if (phy_register == B43_PHY_RFOVERVAL) {\r\nswitch (lpd) {\r\ncase LPD(0, 1, 1):\r\nreturn 0x8FB2;\r\ncase LPD(0, 0, 1):\r\nreturn 0x80B2;\r\ncase LPD(1, 0, 1):\r\nreturn 0x20B2;\r\ncase LPD(1, 0, 0):\r\nreturn 0x20B3;\r\n}\r\nB43_WARN_ON(1);\r\n}\r\nB43_WARN_ON(1);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic u16 b43_radio_init2050(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct init2050_saved_values sav;\r\nu16 rcc;\r\nu16 radio78;\r\nu16 ret;\r\nu16 i, j;\r\nu32 tmp1 = 0, tmp2 = 0;\r\nmemset(&sav, 0, sizeof(sav));\r\nsav.radio_43 = b43_radio_read16(dev, 0x43);\r\nsav.radio_51 = b43_radio_read16(dev, 0x51);\r\nsav.radio_52 = b43_radio_read16(dev, 0x52);\r\nsav.phy_pgactl = b43_phy_read(dev, B43_PHY_PGACTL);\r\nsav.phy_cck_5A = b43_phy_read(dev, B43_PHY_CCK(0x5A));\r\nsav.phy_cck_59 = b43_phy_read(dev, B43_PHY_CCK(0x59));\r\nsav.phy_cck_58 = b43_phy_read(dev, B43_PHY_CCK(0x58));\r\nif (phy->type == B43_PHYTYPE_B) {\r\nsav.phy_cck_30 = b43_phy_read(dev, B43_PHY_CCK(0x30));\r\nsav.reg_3EC = b43_read16(dev, 0x3EC);\r\nb43_phy_write(dev, B43_PHY_CCK(0x30), 0xFF);\r\nb43_write16(dev, 0x3EC, 0x3F3F);\r\n} else if (phy->gmode || phy->rev >= 2) {\r\nsav.phy_rfover = b43_phy_read(dev, B43_PHY_RFOVER);\r\nsav.phy_rfoverval = b43_phy_read(dev, B43_PHY_RFOVERVAL);\r\nsav.phy_analogover = b43_phy_read(dev, B43_PHY_ANALOGOVER);\r\nsav.phy_analogoverval =\r\nb43_phy_read(dev, B43_PHY_ANALOGOVERVAL);\r\nsav.phy_crs0 = b43_phy_read(dev, B43_PHY_CRS0);\r\nsav.phy_classctl = b43_phy_read(dev, B43_PHY_CLASSCTL);\r\nb43_phy_set(dev, B43_PHY_ANALOGOVER, 0x0003);\r\nb43_phy_mask(dev, B43_PHY_ANALOGOVERVAL, 0xFFFC);\r\nb43_phy_mask(dev, B43_PHY_CRS0, 0x7FFF);\r\nb43_phy_mask(dev, B43_PHY_CLASSCTL, 0xFFFC);\r\nif (has_loopback_gain(phy)) {\r\nsav.phy_lo_mask = b43_phy_read(dev, B43_PHY_LO_MASK);\r\nsav.phy_lo_ctl = b43_phy_read(dev, B43_PHY_LO_CTL);\r\nif (phy->rev >= 3)\r\nb43_phy_write(dev, B43_PHY_LO_MASK, 0xC020);\r\nelse\r\nb43_phy_write(dev, B43_PHY_LO_MASK, 0x8020);\r\nb43_phy_write(dev, B43_PHY_LO_CTL, 0);\r\n}\r\nb43_phy_write(dev, B43_PHY_RFOVERVAL,\r\nradio2050_rfover_val(dev, B43_PHY_RFOVERVAL,\r\nLPD(0, 1, 1)));\r\nb43_phy_write(dev, B43_PHY_RFOVER,\r\nradio2050_rfover_val(dev, B43_PHY_RFOVER, 0));\r\n}\r\nb43_write16(dev, 0x3E2, b43_read16(dev, 0x3E2) | 0x8000);\r\nsav.phy_syncctl = b43_phy_read(dev, B43_PHY_SYNCCTL);\r\nb43_phy_mask(dev, B43_PHY_SYNCCTL, 0xFF7F);\r\nsav.reg_3E6 = b43_read16(dev, 0x3E6);\r\nsav.reg_3F4 = b43_read16(dev, 0x3F4);\r\nif (phy->analog == 0) {\r\nb43_write16(dev, 0x03E6, 0x0122);\r\n} else {\r\nif (phy->analog >= 2) {\r\nb43_phy_maskset(dev, B43_PHY_CCK(0x03), 0xFFBF, 0x40);\r\n}\r\nb43_write16(dev, B43_MMIO_CHANNEL_EXT,\r\n(b43_read16(dev, B43_MMIO_CHANNEL_EXT) | 0x2000));\r\n}\r\nrcc = b43_radio_core_calibration_value(dev);\r\nif (phy->type == B43_PHYTYPE_B)\r\nb43_radio_write16(dev, 0x78, 0x26);\r\nif (phy->gmode || phy->rev >= 2) {\r\nb43_phy_write(dev, B43_PHY_RFOVERVAL,\r\nradio2050_rfover_val(dev, B43_PHY_RFOVERVAL,\r\nLPD(0, 1, 1)));\r\n}\r\nb43_phy_write(dev, B43_PHY_PGACTL, 0xBFAF);\r\nb43_phy_write(dev, B43_PHY_CCK(0x2B), 0x1403);\r\nif (phy->gmode || phy->rev >= 2) {\r\nb43_phy_write(dev, B43_PHY_RFOVERVAL,\r\nradio2050_rfover_val(dev, B43_PHY_RFOVERVAL,\r\nLPD(0, 0, 1)));\r\n}\r\nb43_phy_write(dev, B43_PHY_PGACTL, 0xBFA0);\r\nb43_radio_set(dev, 0x51, 0x0004);\r\nif (phy->radio_rev == 8) {\r\nb43_radio_write16(dev, 0x43, 0x1F);\r\n} else {\r\nb43_radio_write16(dev, 0x52, 0);\r\nb43_radio_maskset(dev, 0x43, 0xFFF0, 0x0009);\r\n}\r\nb43_phy_write(dev, B43_PHY_CCK(0x58), 0);\r\nfor (i = 0; i < 16; i++) {\r\nb43_phy_write(dev, B43_PHY_CCK(0x5A), 0x0480);\r\nb43_phy_write(dev, B43_PHY_CCK(0x59), 0xC810);\r\nb43_phy_write(dev, B43_PHY_CCK(0x58), 0x000D);\r\nif (phy->gmode || phy->rev >= 2) {\r\nb43_phy_write(dev, B43_PHY_RFOVERVAL,\r\nradio2050_rfover_val(dev,\r\nB43_PHY_RFOVERVAL,\r\nLPD(1, 0, 1)));\r\n}\r\nb43_phy_write(dev, B43_PHY_PGACTL, 0xAFB0);\r\nudelay(10);\r\nif (phy->gmode || phy->rev >= 2) {\r\nb43_phy_write(dev, B43_PHY_RFOVERVAL,\r\nradio2050_rfover_val(dev,\r\nB43_PHY_RFOVERVAL,\r\nLPD(1, 0, 1)));\r\n}\r\nb43_phy_write(dev, B43_PHY_PGACTL, 0xEFB0);\r\nudelay(10);\r\nif (phy->gmode || phy->rev >= 2) {\r\nb43_phy_write(dev, B43_PHY_RFOVERVAL,\r\nradio2050_rfover_val(dev,\r\nB43_PHY_RFOVERVAL,\r\nLPD(1, 0, 0)));\r\n}\r\nb43_phy_write(dev, B43_PHY_PGACTL, 0xFFF0);\r\nudelay(20);\r\ntmp1 += b43_phy_read(dev, B43_PHY_LO_LEAKAGE);\r\nb43_phy_write(dev, B43_PHY_CCK(0x58), 0);\r\nif (phy->gmode || phy->rev >= 2) {\r\nb43_phy_write(dev, B43_PHY_RFOVERVAL,\r\nradio2050_rfover_val(dev,\r\nB43_PHY_RFOVERVAL,\r\nLPD(1, 0, 1)));\r\n}\r\nb43_phy_write(dev, B43_PHY_PGACTL, 0xAFB0);\r\n}\r\nudelay(10);\r\nb43_phy_write(dev, B43_PHY_CCK(0x58), 0);\r\ntmp1++;\r\ntmp1 >>= 9;\r\nfor (i = 0; i < 16; i++) {\r\nradio78 = (bitrev4(i) << 1) | 0x0020;\r\nb43_radio_write16(dev, 0x78, radio78);\r\nudelay(10);\r\nfor (j = 0; j < 16; j++) {\r\nb43_phy_write(dev, B43_PHY_CCK(0x5A), 0x0D80);\r\nb43_phy_write(dev, B43_PHY_CCK(0x59), 0xC810);\r\nb43_phy_write(dev, B43_PHY_CCK(0x58), 0x000D);\r\nif (phy->gmode || phy->rev >= 2) {\r\nb43_phy_write(dev, B43_PHY_RFOVERVAL,\r\nradio2050_rfover_val(dev,\r\nB43_PHY_RFOVERVAL,\r\nLPD(1, 0,\r\n1)));\r\n}\r\nb43_phy_write(dev, B43_PHY_PGACTL, 0xAFB0);\r\nudelay(10);\r\nif (phy->gmode || phy->rev >= 2) {\r\nb43_phy_write(dev, B43_PHY_RFOVERVAL,\r\nradio2050_rfover_val(dev,\r\nB43_PHY_RFOVERVAL,\r\nLPD(1, 0,\r\n1)));\r\n}\r\nb43_phy_write(dev, B43_PHY_PGACTL, 0xEFB0);\r\nudelay(10);\r\nif (phy->gmode || phy->rev >= 2) {\r\nb43_phy_write(dev, B43_PHY_RFOVERVAL,\r\nradio2050_rfover_val(dev,\r\nB43_PHY_RFOVERVAL,\r\nLPD(1, 0,\r\n0)));\r\n}\r\nb43_phy_write(dev, B43_PHY_PGACTL, 0xFFF0);\r\nudelay(10);\r\ntmp2 += b43_phy_read(dev, B43_PHY_LO_LEAKAGE);\r\nb43_phy_write(dev, B43_PHY_CCK(0x58), 0);\r\nif (phy->gmode || phy->rev >= 2) {\r\nb43_phy_write(dev, B43_PHY_RFOVERVAL,\r\nradio2050_rfover_val(dev,\r\nB43_PHY_RFOVERVAL,\r\nLPD(1, 0,\r\n1)));\r\n}\r\nb43_phy_write(dev, B43_PHY_PGACTL, 0xAFB0);\r\n}\r\ntmp2++;\r\ntmp2 >>= 8;\r\nif (tmp1 < tmp2)\r\nbreak;\r\n}\r\nb43_phy_write(dev, B43_PHY_PGACTL, sav.phy_pgactl);\r\nb43_radio_write16(dev, 0x51, sav.radio_51);\r\nb43_radio_write16(dev, 0x52, sav.radio_52);\r\nb43_radio_write16(dev, 0x43, sav.radio_43);\r\nb43_phy_write(dev, B43_PHY_CCK(0x5A), sav.phy_cck_5A);\r\nb43_phy_write(dev, B43_PHY_CCK(0x59), sav.phy_cck_59);\r\nb43_phy_write(dev, B43_PHY_CCK(0x58), sav.phy_cck_58);\r\nb43_write16(dev, 0x3E6, sav.reg_3E6);\r\nif (phy->analog != 0)\r\nb43_write16(dev, 0x3F4, sav.reg_3F4);\r\nb43_phy_write(dev, B43_PHY_SYNCCTL, sav.phy_syncctl);\r\nb43_synth_pu_workaround(dev, phy->channel);\r\nif (phy->type == B43_PHYTYPE_B) {\r\nb43_phy_write(dev, B43_PHY_CCK(0x30), sav.phy_cck_30);\r\nb43_write16(dev, 0x3EC, sav.reg_3EC);\r\n} else if (phy->gmode) {\r\nb43_write16(dev, B43_MMIO_PHY_RADIO,\r\nb43_read16(dev, B43_MMIO_PHY_RADIO)\r\n& 0x7FFF);\r\nb43_phy_write(dev, B43_PHY_RFOVER, sav.phy_rfover);\r\nb43_phy_write(dev, B43_PHY_RFOVERVAL, sav.phy_rfoverval);\r\nb43_phy_write(dev, B43_PHY_ANALOGOVER, sav.phy_analogover);\r\nb43_phy_write(dev, B43_PHY_ANALOGOVERVAL,\r\nsav.phy_analogoverval);\r\nb43_phy_write(dev, B43_PHY_CRS0, sav.phy_crs0);\r\nb43_phy_write(dev, B43_PHY_CLASSCTL, sav.phy_classctl);\r\nif (has_loopback_gain(phy)) {\r\nb43_phy_write(dev, B43_PHY_LO_MASK, sav.phy_lo_mask);\r\nb43_phy_write(dev, B43_PHY_LO_CTL, sav.phy_lo_ctl);\r\n}\r\n}\r\nif (i > 15)\r\nret = radio78;\r\nelse\r\nret = rcc;\r\nreturn ret;\r\n}\r\nstatic void b43_phy_initb5(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_g *gphy = phy->g;\r\nu16 offset, value;\r\nu8 old_channel;\r\nif (phy->analog == 1) {\r\nb43_radio_set(dev, 0x007A, 0x0050);\r\n}\r\nif ((dev->dev->board_vendor != SSB_BOARDVENDOR_BCM) &&\r\n(dev->dev->board_type != SSB_BOARD_BU4306)) {\r\nvalue = 0x2120;\r\nfor (offset = 0x00A8; offset < 0x00C7; offset++) {\r\nb43_phy_write(dev, offset, value);\r\nvalue += 0x202;\r\n}\r\n}\r\nb43_phy_maskset(dev, 0x0035, 0xF0FF, 0x0700);\r\nif (phy->radio_ver == 0x2050)\r\nb43_phy_write(dev, 0x0038, 0x0667);\r\nif (phy->gmode || phy->rev >= 2) {\r\nif (phy->radio_ver == 0x2050) {\r\nb43_radio_set(dev, 0x007A, 0x0020);\r\nb43_radio_set(dev, 0x0051, 0x0004);\r\n}\r\nb43_write16(dev, B43_MMIO_PHY_RADIO, 0x0000);\r\nb43_phy_set(dev, 0x0802, 0x0100);\r\nb43_phy_set(dev, 0x042B, 0x2000);\r\nb43_phy_write(dev, 0x001C, 0x186A);\r\nb43_phy_maskset(dev, 0x0013, 0x00FF, 0x1900);\r\nb43_phy_maskset(dev, 0x0035, 0xFFC0, 0x0064);\r\nb43_phy_maskset(dev, 0x005D, 0xFF80, 0x000A);\r\n}\r\nif (dev->bad_frames_preempt) {\r\nb43_phy_set(dev, B43_PHY_RADIO_BITFIELD, (1 << 11));\r\n}\r\nif (phy->analog == 1) {\r\nb43_phy_write(dev, 0x0026, 0xCE00);\r\nb43_phy_write(dev, 0x0021, 0x3763);\r\nb43_phy_write(dev, 0x0022, 0x1BC3);\r\nb43_phy_write(dev, 0x0023, 0x06F9);\r\nb43_phy_write(dev, 0x0024, 0x037E);\r\n} else\r\nb43_phy_write(dev, 0x0026, 0xCC00);\r\nb43_phy_write(dev, 0x0030, 0x00C6);\r\nb43_write16(dev, 0x03EC, 0x3F22);\r\nif (phy->analog == 1)\r\nb43_phy_write(dev, 0x0020, 0x3E1C);\r\nelse\r\nb43_phy_write(dev, 0x0020, 0x301C);\r\nif (phy->analog == 0)\r\nb43_write16(dev, 0x03E4, 0x3000);\r\nold_channel = phy->channel;\r\nb43_gphy_channel_switch(dev, 7, 0);\r\nif (phy->radio_ver != 0x2050) {\r\nb43_radio_write16(dev, 0x0075, 0x0080);\r\nb43_radio_write16(dev, 0x0079, 0x0081);\r\n}\r\nb43_radio_write16(dev, 0x0050, 0x0020);\r\nb43_radio_write16(dev, 0x0050, 0x0023);\r\nif (phy->radio_ver == 0x2050) {\r\nb43_radio_write16(dev, 0x0050, 0x0020);\r\nb43_radio_write16(dev, 0x005A, 0x0070);\r\n}\r\nb43_radio_write16(dev, 0x005B, 0x007B);\r\nb43_radio_write16(dev, 0x005C, 0x00B0);\r\nb43_radio_set(dev, 0x007A, 0x0007);\r\nb43_gphy_channel_switch(dev, old_channel, 0);\r\nb43_phy_write(dev, 0x0014, 0x0080);\r\nb43_phy_write(dev, 0x0032, 0x00CA);\r\nb43_phy_write(dev, 0x002A, 0x88A3);\r\nb43_set_txpower_g(dev, &gphy->bbatt, &gphy->rfatt, gphy->tx_control);\r\nif (phy->radio_ver == 0x2050)\r\nb43_radio_write16(dev, 0x005D, 0x000D);\r\nb43_write16(dev, 0x03E4, (b43_read16(dev, 0x03E4) & 0xFFC0) | 0x0004);\r\n}\r\nstatic void b43_phy_initb6(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_g *gphy = phy->g;\r\nu16 offset, val;\r\nu8 old_channel;\r\nb43_phy_write(dev, 0x003E, 0x817A);\r\nb43_radio_write16(dev, 0x007A,\r\n(b43_radio_read16(dev, 0x007A) | 0x0058));\r\nif (phy->radio_rev == 4 || phy->radio_rev == 5) {\r\nb43_radio_write16(dev, 0x51, 0x37);\r\nb43_radio_write16(dev, 0x52, 0x70);\r\nb43_radio_write16(dev, 0x53, 0xB3);\r\nb43_radio_write16(dev, 0x54, 0x9B);\r\nb43_radio_write16(dev, 0x5A, 0x88);\r\nb43_radio_write16(dev, 0x5B, 0x88);\r\nb43_radio_write16(dev, 0x5D, 0x88);\r\nb43_radio_write16(dev, 0x5E, 0x88);\r\nb43_radio_write16(dev, 0x7D, 0x88);\r\nb43_hf_write(dev, b43_hf_read(dev)\r\n| B43_HF_TSSIRPSMW);\r\n}\r\nB43_WARN_ON(phy->radio_rev == 6 || phy->radio_rev == 7);\r\nif (phy->radio_rev == 8) {\r\nb43_radio_write16(dev, 0x51, 0);\r\nb43_radio_write16(dev, 0x52, 0x40);\r\nb43_radio_write16(dev, 0x53, 0xB7);\r\nb43_radio_write16(dev, 0x54, 0x98);\r\nb43_radio_write16(dev, 0x5A, 0x88);\r\nb43_radio_write16(dev, 0x5B, 0x6B);\r\nb43_radio_write16(dev, 0x5C, 0x0F);\r\nif (dev->dev->bus_sprom->boardflags_lo & B43_BFL_ALTIQ) {\r\nb43_radio_write16(dev, 0x5D, 0xFA);\r\nb43_radio_write16(dev, 0x5E, 0xD8);\r\n} else {\r\nb43_radio_write16(dev, 0x5D, 0xF5);\r\nb43_radio_write16(dev, 0x5E, 0xB8);\r\n}\r\nb43_radio_write16(dev, 0x0073, 0x0003);\r\nb43_radio_write16(dev, 0x007D, 0x00A8);\r\nb43_radio_write16(dev, 0x007C, 0x0001);\r\nb43_radio_write16(dev, 0x007E, 0x0008);\r\n}\r\nval = 0x1E1F;\r\nfor (offset = 0x0088; offset < 0x0098; offset++) {\r\nb43_phy_write(dev, offset, val);\r\nval -= 0x0202;\r\n}\r\nval = 0x3E3F;\r\nfor (offset = 0x0098; offset < 0x00A8; offset++) {\r\nb43_phy_write(dev, offset, val);\r\nval -= 0x0202;\r\n}\r\nval = 0x2120;\r\nfor (offset = 0x00A8; offset < 0x00C8; offset++) {\r\nb43_phy_write(dev, offset, (val & 0x3F3F));\r\nval += 0x0202;\r\n}\r\nif (phy->type == B43_PHYTYPE_G) {\r\nb43_radio_set(dev, 0x007A, 0x0020);\r\nb43_radio_set(dev, 0x0051, 0x0004);\r\nb43_phy_set(dev, 0x0802, 0x0100);\r\nb43_phy_set(dev, 0x042B, 0x2000);\r\nb43_phy_write(dev, 0x5B, 0);\r\nb43_phy_write(dev, 0x5C, 0);\r\n}\r\nold_channel = phy->channel;\r\nif (old_channel >= 8)\r\nb43_gphy_channel_switch(dev, 1, 0);\r\nelse\r\nb43_gphy_channel_switch(dev, 13, 0);\r\nb43_radio_write16(dev, 0x0050, 0x0020);\r\nb43_radio_write16(dev, 0x0050, 0x0023);\r\nudelay(40);\r\nif (phy->radio_rev < 6 || phy->radio_rev == 8) {\r\nb43_radio_write16(dev, 0x7C, (b43_radio_read16(dev, 0x7C)\r\n| 0x0002));\r\nb43_radio_write16(dev, 0x50, 0x20);\r\n}\r\nif (phy->radio_rev <= 2) {\r\nb43_radio_write16(dev, 0x7C, 0x20);\r\nb43_radio_write16(dev, 0x5A, 0x70);\r\nb43_radio_write16(dev, 0x5B, 0x7B);\r\nb43_radio_write16(dev, 0x5C, 0xB0);\r\n}\r\nb43_radio_maskset(dev, 0x007A, 0x00F8, 0x0007);\r\nb43_gphy_channel_switch(dev, old_channel, 0);\r\nb43_phy_write(dev, 0x0014, 0x0200);\r\nif (phy->radio_rev >= 6)\r\nb43_phy_write(dev, 0x2A, 0x88C2);\r\nelse\r\nb43_phy_write(dev, 0x2A, 0x8AC0);\r\nb43_phy_write(dev, 0x0038, 0x0668);\r\nb43_set_txpower_g(dev, &gphy->bbatt, &gphy->rfatt, gphy->tx_control);\r\nif (phy->radio_rev <= 5) {\r\nb43_phy_maskset(dev, 0x5D, 0xFF80, 0x0003);\r\n}\r\nif (phy->radio_rev <= 2)\r\nb43_radio_write16(dev, 0x005D, 0x000D);\r\nif (phy->analog == 4) {\r\nb43_write16(dev, 0x3E4, 9);\r\nb43_phy_mask(dev, 0x61, 0x0FFF);\r\n} else {\r\nb43_phy_maskset(dev, 0x0002, 0xFFC0, 0x0004);\r\n}\r\nif (phy->type == B43_PHYTYPE_B)\r\nB43_WARN_ON(1);\r\nelse if (phy->type == B43_PHYTYPE_G)\r\nb43_write16(dev, 0x03E6, 0x0);\r\n}\r\nstatic void b43_calc_loopback_gain(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_g *gphy = phy->g;\r\nu16 backup_phy[16] = { 0 };\r\nu16 backup_radio[3];\r\nu16 backup_bband;\r\nu16 i, j, loop_i_max;\r\nu16 trsw_rx;\r\nu16 loop1_outer_done, loop1_inner_done;\r\nbackup_phy[0] = b43_phy_read(dev, B43_PHY_CRS0);\r\nbackup_phy[1] = b43_phy_read(dev, B43_PHY_CCKBBANDCFG);\r\nbackup_phy[2] = b43_phy_read(dev, B43_PHY_RFOVER);\r\nbackup_phy[3] = b43_phy_read(dev, B43_PHY_RFOVERVAL);\r\nif (phy->rev != 1) {\r\nbackup_phy[4] = b43_phy_read(dev, B43_PHY_ANALOGOVER);\r\nbackup_phy[5] = b43_phy_read(dev, B43_PHY_ANALOGOVERVAL);\r\n}\r\nbackup_phy[6] = b43_phy_read(dev, B43_PHY_CCK(0x5A));\r\nbackup_phy[7] = b43_phy_read(dev, B43_PHY_CCK(0x59));\r\nbackup_phy[8] = b43_phy_read(dev, B43_PHY_CCK(0x58));\r\nbackup_phy[9] = b43_phy_read(dev, B43_PHY_CCK(0x0A));\r\nbackup_phy[10] = b43_phy_read(dev, B43_PHY_CCK(0x03));\r\nbackup_phy[11] = b43_phy_read(dev, B43_PHY_LO_MASK);\r\nbackup_phy[12] = b43_phy_read(dev, B43_PHY_LO_CTL);\r\nbackup_phy[13] = b43_phy_read(dev, B43_PHY_CCK(0x2B));\r\nbackup_phy[14] = b43_phy_read(dev, B43_PHY_PGACTL);\r\nbackup_phy[15] = b43_phy_read(dev, B43_PHY_LO_LEAKAGE);\r\nbackup_bband = gphy->bbatt.att;\r\nbackup_radio[0] = b43_radio_read16(dev, 0x52);\r\nbackup_radio[1] = b43_radio_read16(dev, 0x43);\r\nbackup_radio[2] = b43_radio_read16(dev, 0x7A);\r\nb43_phy_mask(dev, B43_PHY_CRS0, 0x3FFF);\r\nb43_phy_set(dev, B43_PHY_CCKBBANDCFG, 0x8000);\r\nb43_phy_set(dev, B43_PHY_RFOVER, 0x0002);\r\nb43_phy_mask(dev, B43_PHY_RFOVERVAL, 0xFFFD);\r\nb43_phy_set(dev, B43_PHY_RFOVER, 0x0001);\r\nb43_phy_mask(dev, B43_PHY_RFOVERVAL, 0xFFFE);\r\nif (phy->rev != 1) {\r\nb43_phy_set(dev, B43_PHY_ANALOGOVER, 0x0001);\r\nb43_phy_mask(dev, B43_PHY_ANALOGOVERVAL, 0xFFFE);\r\nb43_phy_set(dev, B43_PHY_ANALOGOVER, 0x0002);\r\nb43_phy_mask(dev, B43_PHY_ANALOGOVERVAL, 0xFFFD);\r\n}\r\nb43_phy_set(dev, B43_PHY_RFOVER, 0x000C);\r\nb43_phy_set(dev, B43_PHY_RFOVERVAL, 0x000C);\r\nb43_phy_set(dev, B43_PHY_RFOVER, 0x0030);\r\nb43_phy_maskset(dev, B43_PHY_RFOVERVAL, 0xFFCF, 0x10);\r\nb43_phy_write(dev, B43_PHY_CCK(0x5A), 0x0780);\r\nb43_phy_write(dev, B43_PHY_CCK(0x59), 0xC810);\r\nb43_phy_write(dev, B43_PHY_CCK(0x58), 0x000D);\r\nb43_phy_set(dev, B43_PHY_CCK(0x0A), 0x2000);\r\nif (phy->rev != 1) {\r\nb43_phy_set(dev, B43_PHY_ANALOGOVER, 0x0004);\r\nb43_phy_mask(dev, B43_PHY_ANALOGOVERVAL, 0xFFFB);\r\n}\r\nb43_phy_maskset(dev, B43_PHY_CCK(0x03), 0xFF9F, 0x40);\r\nif (phy->radio_rev == 8) {\r\nb43_radio_write16(dev, 0x43, 0x000F);\r\n} else {\r\nb43_radio_write16(dev, 0x52, 0);\r\nb43_radio_maskset(dev, 0x43, 0xFFF0, 0x9);\r\n}\r\nb43_gphy_set_baseband_attenuation(dev, 11);\r\nif (phy->rev >= 3)\r\nb43_phy_write(dev, B43_PHY_LO_MASK, 0xC020);\r\nelse\r\nb43_phy_write(dev, B43_PHY_LO_MASK, 0x8020);\r\nb43_phy_write(dev, B43_PHY_LO_CTL, 0);\r\nb43_phy_maskset(dev, B43_PHY_CCK(0x2B), 0xFFC0, 0x01);\r\nb43_phy_maskset(dev, B43_PHY_CCK(0x2B), 0xC0FF, 0x800);\r\nb43_phy_set(dev, B43_PHY_RFOVER, 0x0100);\r\nb43_phy_mask(dev, B43_PHY_RFOVERVAL, 0xCFFF);\r\nif (dev->dev->bus_sprom->boardflags_lo & B43_BFL_EXTLNA) {\r\nif (phy->rev >= 7) {\r\nb43_phy_set(dev, B43_PHY_RFOVER, 0x0800);\r\nb43_phy_set(dev, B43_PHY_RFOVERVAL, 0x8000);\r\n}\r\n}\r\nb43_radio_mask(dev, 0x7A, 0x00F7);\r\nj = 0;\r\nloop_i_max = (phy->radio_rev == 8) ? 15 : 9;\r\nfor (i = 0; i < loop_i_max; i++) {\r\nfor (j = 0; j < 16; j++) {\r\nb43_radio_write16(dev, 0x43, i);\r\nb43_phy_maskset(dev, B43_PHY_RFOVERVAL, 0xF0FF, (j << 8));\r\nb43_phy_maskset(dev, B43_PHY_PGACTL, 0x0FFF, 0xA000);\r\nb43_phy_set(dev, B43_PHY_PGACTL, 0xF000);\r\nudelay(20);\r\nif (b43_phy_read(dev, B43_PHY_LO_LEAKAGE) >= 0xDFC)\r\ngoto exit_loop1;\r\n}\r\n}\r\nexit_loop1:\r\nloop1_outer_done = i;\r\nloop1_inner_done = j;\r\nif (j >= 8) {\r\nb43_phy_set(dev, B43_PHY_RFOVERVAL, 0x30);\r\ntrsw_rx = 0x1B;\r\nfor (j = j - 8; j < 16; j++) {\r\nb43_phy_maskset(dev, B43_PHY_RFOVERVAL, 0xF0FF, (j << 8));\r\nb43_phy_maskset(dev, B43_PHY_PGACTL, 0x0FFF, 0xA000);\r\nb43_phy_set(dev, B43_PHY_PGACTL, 0xF000);\r\nudelay(20);\r\ntrsw_rx -= 3;\r\nif (b43_phy_read(dev, B43_PHY_LO_LEAKAGE) >= 0xDFC)\r\ngoto exit_loop2;\r\n}\r\n} else\r\ntrsw_rx = 0x18;\r\nexit_loop2:\r\nif (phy->rev != 1) {\r\nb43_phy_write(dev, B43_PHY_ANALOGOVER, backup_phy[4]);\r\nb43_phy_write(dev, B43_PHY_ANALOGOVERVAL, backup_phy[5]);\r\n}\r\nb43_phy_write(dev, B43_PHY_CCK(0x5A), backup_phy[6]);\r\nb43_phy_write(dev, B43_PHY_CCK(0x59), backup_phy[7]);\r\nb43_phy_write(dev, B43_PHY_CCK(0x58), backup_phy[8]);\r\nb43_phy_write(dev, B43_PHY_CCK(0x0A), backup_phy[9]);\r\nb43_phy_write(dev, B43_PHY_CCK(0x03), backup_phy[10]);\r\nb43_phy_write(dev, B43_PHY_LO_MASK, backup_phy[11]);\r\nb43_phy_write(dev, B43_PHY_LO_CTL, backup_phy[12]);\r\nb43_phy_write(dev, B43_PHY_CCK(0x2B), backup_phy[13]);\r\nb43_phy_write(dev, B43_PHY_PGACTL, backup_phy[14]);\r\nb43_gphy_set_baseband_attenuation(dev, backup_bband);\r\nb43_radio_write16(dev, 0x52, backup_radio[0]);\r\nb43_radio_write16(dev, 0x43, backup_radio[1]);\r\nb43_radio_write16(dev, 0x7A, backup_radio[2]);\r\nb43_phy_write(dev, B43_PHY_RFOVER, backup_phy[2] | 0x0003);\r\nudelay(10);\r\nb43_phy_write(dev, B43_PHY_RFOVER, backup_phy[2]);\r\nb43_phy_write(dev, B43_PHY_RFOVERVAL, backup_phy[3]);\r\nb43_phy_write(dev, B43_PHY_CRS0, backup_phy[0]);\r\nb43_phy_write(dev, B43_PHY_CCKBBANDCFG, backup_phy[1]);\r\ngphy->max_lb_gain =\r\n((loop1_inner_done * 6) - (loop1_outer_done * 4)) - 11;\r\ngphy->trsw_rx_gain = trsw_rx * 2;\r\n}\r\nstatic void b43_hardware_pctl_early_init(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nif (!b43_has_hardware_pctl(dev)) {\r\nb43_phy_write(dev, 0x047A, 0xC111);\r\nreturn;\r\n}\r\nb43_phy_mask(dev, 0x0036, 0xFEFF);\r\nb43_phy_write(dev, 0x002F, 0x0202);\r\nb43_phy_set(dev, 0x047C, 0x0002);\r\nb43_phy_set(dev, 0x047A, 0xF000);\r\nif (phy->radio_ver == 0x2050 && phy->radio_rev == 8) {\r\nb43_phy_maskset(dev, 0x047A, 0xFF0F, 0x0010);\r\nb43_phy_set(dev, 0x005D, 0x8000);\r\nb43_phy_maskset(dev, 0x004E, 0xFFC0, 0x0010);\r\nb43_phy_write(dev, 0x002E, 0xC07F);\r\nb43_phy_set(dev, 0x0036, 0x0400);\r\n} else {\r\nb43_phy_set(dev, 0x0036, 0x0200);\r\nb43_phy_set(dev, 0x0036, 0x0400);\r\nb43_phy_mask(dev, 0x005D, 0x7FFF);\r\nb43_phy_mask(dev, 0x004F, 0xFFFE);\r\nb43_phy_maskset(dev, 0x004E, 0xFFC0, 0x0010);\r\nb43_phy_write(dev, 0x002E, 0xC07F);\r\nb43_phy_maskset(dev, 0x047A, 0xFF0F, 0x0010);\r\n}\r\n}\r\nstatic void b43_hardware_pctl_init_gphy(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_g *gphy = phy->g;\r\nif (!b43_has_hardware_pctl(dev)) {\r\nb43_hf_write(dev, b43_hf_read(dev) & ~B43_HF_HWPCTL);\r\nreturn;\r\n}\r\nb43_phy_maskset(dev, 0x0036, 0xFFC0, (gphy->tgt_idle_tssi - gphy->cur_idle_tssi));\r\nb43_phy_maskset(dev, 0x0478, 0xFF00, (gphy->tgt_idle_tssi - gphy->cur_idle_tssi));\r\nb43_gphy_tssi_power_lt_init(dev);\r\nb43_gphy_gain_lt_init(dev);\r\nb43_phy_mask(dev, 0x0060, 0xFFBF);\r\nb43_phy_write(dev, 0x0014, 0x0000);\r\nB43_WARN_ON(phy->rev < 6);\r\nb43_phy_set(dev, 0x0478, 0x0800);\r\nb43_phy_mask(dev, 0x0478, 0xFEFF);\r\nb43_phy_mask(dev, 0x0801, 0xFFBF);\r\nb43_gphy_dc_lt_init(dev, 1);\r\nb43_hf_write(dev, b43_hf_read(dev) | B43_HF_HWPCTL);\r\n}\r\nstatic void b43_phy_init_pctl(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_g *gphy = phy->g;\r\nstruct b43_rfatt old_rfatt;\r\nstruct b43_bbatt old_bbatt;\r\nu8 old_tx_control = 0;\r\nB43_WARN_ON(phy->type != B43_PHYTYPE_G);\r\nif ((dev->dev->board_vendor == SSB_BOARDVENDOR_BCM) &&\r\n(dev->dev->board_type == SSB_BOARD_BU4306))\r\nreturn;\r\nb43_phy_write(dev, 0x0028, 0x8018);\r\nb43_write16(dev, B43_MMIO_PHY0, b43_read16(dev, B43_MMIO_PHY0)\r\n& 0xFFDF);\r\nif (!phy->gmode)\r\nreturn;\r\nb43_hardware_pctl_early_init(dev);\r\nif (gphy->cur_idle_tssi == 0) {\r\nif (phy->radio_ver == 0x2050 && phy->analog == 0) {\r\nb43_radio_maskset(dev, 0x0076, 0x00F7, 0x0084);\r\n} else {\r\nstruct b43_rfatt rfatt;\r\nstruct b43_bbatt bbatt;\r\nmemcpy(&old_rfatt, &gphy->rfatt, sizeof(old_rfatt));\r\nmemcpy(&old_bbatt, &gphy->bbatt, sizeof(old_bbatt));\r\nold_tx_control = gphy->tx_control;\r\nbbatt.att = 11;\r\nif (phy->radio_rev == 8) {\r\nrfatt.att = 15;\r\nrfatt.with_padmix = true;\r\n} else {\r\nrfatt.att = 9;\r\nrfatt.with_padmix = false;\r\n}\r\nb43_set_txpower_g(dev, &bbatt, &rfatt, 0);\r\n}\r\nb43_dummy_transmission(dev, false, true);\r\ngphy->cur_idle_tssi = b43_phy_read(dev, B43_PHY_ITSSI);\r\nif (B43_DEBUG) {\r\nif (abs(gphy->cur_idle_tssi - gphy->tgt_idle_tssi) >= 20) {\r\nb43dbg(dev->wl,\r\n"!WARNING! Idle-TSSI phy->cur_idle_tssi "\r\n"measuring failed. (cur=%d, tgt=%d). Disabling TX power "\r\n"adjustment.\n", gphy->cur_idle_tssi,\r\ngphy->tgt_idle_tssi);\r\ngphy->cur_idle_tssi = 0;\r\n}\r\n}\r\nif (phy->radio_ver == 0x2050 && phy->analog == 0) {\r\nb43_radio_mask(dev, 0x0076, 0xFF7B);\r\n} else {\r\nb43_set_txpower_g(dev, &old_bbatt,\r\n&old_rfatt, old_tx_control);\r\n}\r\n}\r\nb43_hardware_pctl_init_gphy(dev);\r\nb43_shm_clear_tssi(dev);\r\n}\r\nstatic void b43_phy_initg(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_g *gphy = phy->g;\r\nu16 tmp;\r\nif (phy->rev == 1)\r\nb43_phy_initb5(dev);\r\nelse\r\nb43_phy_initb6(dev);\r\nif (phy->rev >= 2 || phy->gmode)\r\nb43_phy_inita(dev);\r\nif (phy->rev >= 2) {\r\nb43_phy_write(dev, B43_PHY_ANALOGOVER, 0);\r\nb43_phy_write(dev, B43_PHY_ANALOGOVERVAL, 0);\r\n}\r\nif (phy->rev == 2) {\r\nb43_phy_write(dev, B43_PHY_RFOVER, 0);\r\nb43_phy_write(dev, B43_PHY_PGACTL, 0xC0);\r\n}\r\nif (phy->rev > 5) {\r\nb43_phy_write(dev, B43_PHY_RFOVER, 0x400);\r\nb43_phy_write(dev, B43_PHY_PGACTL, 0xC0);\r\n}\r\nif (phy->gmode || phy->rev >= 2) {\r\ntmp = b43_phy_read(dev, B43_PHY_VERSION_OFDM);\r\ntmp &= B43_PHYVER_VERSION;\r\nif (tmp == 3 || tmp == 5) {\r\nb43_phy_write(dev, B43_PHY_OFDM(0xC2), 0x1816);\r\nb43_phy_write(dev, B43_PHY_OFDM(0xC3), 0x8006);\r\n}\r\nif (tmp == 5) {\r\nb43_phy_maskset(dev, B43_PHY_OFDM(0xCC), 0x00FF, 0x1F00);\r\n}\r\n}\r\nif ((phy->rev <= 2 && phy->gmode) || phy->rev >= 2)\r\nb43_phy_write(dev, B43_PHY_OFDM(0x7E), 0x78);\r\nif (phy->radio_rev == 8) {\r\nb43_phy_set(dev, B43_PHY_EXTG(0x01), 0x80);\r\nb43_phy_set(dev, B43_PHY_OFDM(0x3E), 0x4);\r\n}\r\nif (has_loopback_gain(phy))\r\nb43_calc_loopback_gain(dev);\r\nif (phy->radio_rev != 8) {\r\nif (gphy->initval == 0xFFFF)\r\ngphy->initval = b43_radio_init2050(dev);\r\nelse\r\nb43_radio_write16(dev, 0x0078, gphy->initval);\r\n}\r\nb43_lo_g_init(dev);\r\nif (has_tx_magnification(phy)) {\r\nb43_radio_write16(dev, 0x52,\r\n(b43_radio_read16(dev, 0x52) & 0xFF00)\r\n| gphy->lo_control->tx_bias | gphy->\r\nlo_control->tx_magn);\r\n} else {\r\nb43_radio_maskset(dev, 0x52, 0xFFF0, gphy->lo_control->tx_bias);\r\n}\r\nif (phy->rev >= 6) {\r\nb43_phy_maskset(dev, B43_PHY_CCK(0x36), 0x0FFF, (gphy->lo_control->tx_bias << 12));\r\n}\r\nif (dev->dev->bus_sprom->boardflags_lo & B43_BFL_PACTRL)\r\nb43_phy_write(dev, B43_PHY_CCK(0x2E), 0x8075);\r\nelse\r\nb43_phy_write(dev, B43_PHY_CCK(0x2E), 0x807F);\r\nif (phy->rev < 2)\r\nb43_phy_write(dev, B43_PHY_CCK(0x2F), 0x101);\r\nelse\r\nb43_phy_write(dev, B43_PHY_CCK(0x2F), 0x202);\r\nif (phy->gmode || phy->rev >= 2) {\r\nb43_lo_g_adjust(dev);\r\nb43_phy_write(dev, B43_PHY_LO_MASK, 0x8078);\r\n}\r\nif (!(dev->dev->bus_sprom->boardflags_lo & B43_BFL_RSSI)) {\r\nb43_nrssi_hw_update(dev, 0xFFFF);\r\nb43_calc_nrssi_threshold(dev);\r\n} else if (phy->gmode || phy->rev >= 2) {\r\nif (gphy->nrssi[0] == -1000) {\r\nB43_WARN_ON(gphy->nrssi[1] != -1000);\r\nb43_calc_nrssi_slope(dev);\r\n} else\r\nb43_calc_nrssi_threshold(dev);\r\n}\r\nif (phy->radio_rev == 8)\r\nb43_phy_write(dev, B43_PHY_EXTG(0x05), 0x3230);\r\nb43_phy_init_pctl(dev);\r\nif ((dev->dev->chip_id == 0x4306\r\n&& dev->dev->chip_pkg == 2) || 0) {\r\nb43_phy_mask(dev, B43_PHY_CRS0, 0xBFFF);\r\nb43_phy_mask(dev, B43_PHY_OFDM(0xC3), 0x7FFF);\r\n}\r\n}\r\nvoid b43_gphy_channel_switch(struct b43_wldev *dev,\r\nunsigned int channel,\r\nbool synthetic_pu_workaround)\r\n{\r\nif (synthetic_pu_workaround)\r\nb43_synth_pu_workaround(dev, channel);\r\nb43_write16(dev, B43_MMIO_CHANNEL, channel2freq_bg(channel));\r\nif (channel == 14) {\r\nif (dev->dev->bus_sprom->country_code ==\r\nSSB_SPROM1CCODE_JAPAN)\r\nb43_hf_write(dev,\r\nb43_hf_read(dev) & ~B43_HF_ACPR);\r\nelse\r\nb43_hf_write(dev,\r\nb43_hf_read(dev) | B43_HF_ACPR);\r\nb43_write16(dev, B43_MMIO_CHANNEL_EXT,\r\nb43_read16(dev, B43_MMIO_CHANNEL_EXT)\r\n| (1 << 11));\r\n} else {\r\nb43_write16(dev, B43_MMIO_CHANNEL_EXT,\r\nb43_read16(dev, B43_MMIO_CHANNEL_EXT)\r\n& 0xF7BF);\r\n}\r\n}\r\nstatic void default_baseband_attenuation(struct b43_wldev *dev,\r\nstruct b43_bbatt *bb)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nif (phy->radio_ver == 0x2050 && phy->radio_rev < 6)\r\nbb->att = 0;\r\nelse\r\nbb->att = 2;\r\n}\r\nstatic void default_radio_attenuation(struct b43_wldev *dev,\r\nstruct b43_rfatt *rf)\r\n{\r\nstruct b43_bus_dev *bdev = dev->dev;\r\nstruct b43_phy *phy = &dev->phy;\r\nrf->with_padmix = false;\r\nif (dev->dev->board_vendor == SSB_BOARDVENDOR_BCM &&\r\ndev->dev->board_type == SSB_BOARD_BCM4309G) {\r\nif (dev->dev->board_rev < 0x43) {\r\nrf->att = 2;\r\nreturn;\r\n} else if (dev->dev->board_rev < 0x51) {\r\nrf->att = 3;\r\nreturn;\r\n}\r\n}\r\nif (phy->type == B43_PHYTYPE_A) {\r\nrf->att = 0x60;\r\nreturn;\r\n}\r\nswitch (phy->radio_ver) {\r\ncase 0x2053:\r\nswitch (phy->radio_rev) {\r\ncase 1:\r\nrf->att = 6;\r\nreturn;\r\n}\r\nbreak;\r\ncase 0x2050:\r\nswitch (phy->radio_rev) {\r\ncase 0:\r\nrf->att = 5;\r\nreturn;\r\ncase 1:\r\nif (phy->type == B43_PHYTYPE_G) {\r\nif (bdev->board_vendor == SSB_BOARDVENDOR_BCM\r\n&& bdev->board_type == SSB_BOARD_BCM4309G\r\n&& bdev->board_rev >= 30)\r\nrf->att = 3;\r\nelse if (bdev->board_vendor ==\r\nSSB_BOARDVENDOR_BCM\r\n&& bdev->board_type ==\r\nSSB_BOARD_BU4306)\r\nrf->att = 3;\r\nelse\r\nrf->att = 1;\r\n} else {\r\nif (bdev->board_vendor == SSB_BOARDVENDOR_BCM\r\n&& bdev->board_type == SSB_BOARD_BCM4309G\r\n&& bdev->board_rev >= 30)\r\nrf->att = 7;\r\nelse\r\nrf->att = 6;\r\n}\r\nreturn;\r\ncase 2:\r\nif (phy->type == B43_PHYTYPE_G) {\r\nif (bdev->board_vendor == SSB_BOARDVENDOR_BCM\r\n&& bdev->board_type == SSB_BOARD_BCM4309G\r\n&& bdev->board_rev >= 30)\r\nrf->att = 3;\r\nelse if (bdev->board_vendor ==\r\nSSB_BOARDVENDOR_BCM\r\n&& bdev->board_type ==\r\nSSB_BOARD_BU4306)\r\nrf->att = 5;\r\nelse if (bdev->chip_id == 0x4320)\r\nrf->att = 4;\r\nelse\r\nrf->att = 3;\r\n} else\r\nrf->att = 6;\r\nreturn;\r\ncase 3:\r\nrf->att = 5;\r\nreturn;\r\ncase 4:\r\ncase 5:\r\nrf->att = 1;\r\nreturn;\r\ncase 6:\r\ncase 7:\r\nrf->att = 5;\r\nreturn;\r\ncase 8:\r\nrf->att = 0xA;\r\nrf->with_padmix = true;\r\nreturn;\r\ncase 9:\r\ndefault:\r\nrf->att = 5;\r\nreturn;\r\n}\r\n}\r\nrf->att = 5;\r\n}\r\nstatic u16 default_tx_control(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nif (phy->radio_ver != 0x2050)\r\nreturn 0;\r\nif (phy->radio_rev == 1)\r\nreturn B43_TXCTL_PA2DB | B43_TXCTL_TXMIX;\r\nif (phy->radio_rev < 6)\r\nreturn B43_TXCTL_PA2DB;\r\nif (phy->radio_rev == 8)\r\nreturn B43_TXCTL_TXMIX;\r\nreturn 0;\r\n}\r\nstatic u8 b43_gphy_aci_detect(struct b43_wldev *dev, u8 channel)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_g *gphy = phy->g;\r\nu8 ret = 0;\r\nu16 saved, rssi, temp;\r\nint i, j = 0;\r\nsaved = b43_phy_read(dev, 0x0403);\r\nb43_switch_channel(dev, channel);\r\nb43_phy_write(dev, 0x0403, (saved & 0xFFF8) | 5);\r\nif (gphy->aci_hw_rssi)\r\nrssi = b43_phy_read(dev, 0x048A) & 0x3F;\r\nelse\r\nrssi = saved & 0x3F;\r\nif (rssi > 32)\r\nrssi -= 64;\r\nfor (i = 0; i < 100; i++) {\r\ntemp = (b43_phy_read(dev, 0x047F) >> 8) & 0x3F;\r\nif (temp > 32)\r\ntemp -= 64;\r\nif (temp < rssi)\r\nj++;\r\nif (j >= 20)\r\nret = 1;\r\n}\r\nb43_phy_write(dev, 0x0403, saved);\r\nreturn ret;\r\n}\r\nstatic u8 b43_gphy_aci_scan(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nu8 ret[13];\r\nunsigned int channel = phy->channel;\r\nunsigned int i, j, start, end;\r\nif (!((phy->type == B43_PHYTYPE_G) && (phy->rev > 0)))\r\nreturn 0;\r\nb43_phy_lock(dev);\r\nb43_radio_lock(dev);\r\nb43_phy_mask(dev, 0x0802, 0xFFFC);\r\nb43_phy_mask(dev, B43_PHY_G_CRS, 0x7FFF);\r\nb43_set_all_gains(dev, 3, 8, 1);\r\nstart = (channel - 5 > 0) ? channel - 5 : 1;\r\nend = (channel + 5 < 14) ? channel + 5 : 13;\r\nfor (i = start; i <= end; i++) {\r\nif (abs(channel - i) > 2)\r\nret[i - 1] = b43_gphy_aci_detect(dev, i);\r\n}\r\nb43_switch_channel(dev, channel);\r\nb43_phy_maskset(dev, 0x0802, 0xFFFC, 0x0003);\r\nb43_phy_mask(dev, 0x0403, 0xFFF8);\r\nb43_phy_set(dev, B43_PHY_G_CRS, 0x8000);\r\nb43_set_original_gains(dev);\r\nfor (i = 0; i < 13; i++) {\r\nif (!ret[i])\r\ncontinue;\r\nend = (i + 5 < 13) ? i + 5 : 13;\r\nfor (j = i; j < end; j++)\r\nret[j] = 1;\r\n}\r\nb43_radio_unlock(dev);\r\nb43_phy_unlock(dev);\r\nreturn ret[channel - 1];\r\n}\r\nstatic s32 b43_tssi2dbm_ad(s32 num, s32 den)\r\n{\r\nif (num < 0)\r\nreturn num / den;\r\nelse\r\nreturn (num + den / 2) / den;\r\n}\r\nstatic s8 b43_tssi2dbm_entry(s8 entry[], u8 index,\r\ns16 pab0, s16 pab1, s16 pab2)\r\n{\r\ns32 m1, m2, f = 256, q, delta;\r\ns8 i = 0;\r\nm1 = b43_tssi2dbm_ad(16 * pab0 + index * pab1, 32);\r\nm2 = max(b43_tssi2dbm_ad(32768 + index * pab2, 256), 1);\r\ndo {\r\nif (i > 15)\r\nreturn -EINVAL;\r\nq = b43_tssi2dbm_ad(f * 4096 -\r\nb43_tssi2dbm_ad(m2 * f, 16) * f, 2048);\r\ndelta = abs(q - f);\r\nf = q;\r\ni++;\r\n} while (delta >= 2);\r\nentry[index] = clamp_val(b43_tssi2dbm_ad(m1 * f, 8192), -127, 128);\r\nreturn 0;\r\n}\r\nu8 *b43_generate_dyn_tssi2dbm_tab(struct b43_wldev *dev,\r\ns16 pab0, s16 pab1, s16 pab2)\r\n{\r\nunsigned int i;\r\nu8 *tab;\r\nint err;\r\ntab = kmalloc(64, GFP_KERNEL);\r\nif (!tab) {\r\nb43err(dev->wl, "Could not allocate memory "\r\n"for tssi2dbm table\n");\r\nreturn NULL;\r\n}\r\nfor (i = 0; i < 64; i++) {\r\nerr = b43_tssi2dbm_entry(tab, i, pab0, pab1, pab2);\r\nif (err) {\r\nb43err(dev->wl, "Could not generate "\r\n"tssi2dBm table\n");\r\nkfree(tab);\r\nreturn NULL;\r\n}\r\n}\r\nreturn tab;\r\n}\r\nstatic int b43_gphy_init_tssi2dbm_table(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_g *gphy = phy->g;\r\ns16 pab0, pab1, pab2;\r\npab0 = (s16) (dev->dev->bus_sprom->pa0b0);\r\npab1 = (s16) (dev->dev->bus_sprom->pa0b1);\r\npab2 = (s16) (dev->dev->bus_sprom->pa0b2);\r\nB43_WARN_ON((dev->dev->chip_id == 0x4301) &&\r\n(phy->radio_ver != 0x2050));\r\ngphy->dyn_tssi_tbl = false;\r\nif (pab0 != 0 && pab1 != 0 && pab2 != 0 &&\r\npab0 != -1 && pab1 != -1 && pab2 != -1) {\r\nif ((s8) dev->dev->bus_sprom->itssi_bg != 0 &&\r\n(s8) dev->dev->bus_sprom->itssi_bg != -1) {\r\ngphy->tgt_idle_tssi =\r\n(s8) (dev->dev->bus_sprom->itssi_bg);\r\n} else\r\ngphy->tgt_idle_tssi = 62;\r\ngphy->tssi2dbm = b43_generate_dyn_tssi2dbm_tab(dev, pab0,\r\npab1, pab2);\r\nif (!gphy->tssi2dbm)\r\nreturn -ENOMEM;\r\ngphy->dyn_tssi_tbl = true;\r\n} else {\r\ngphy->tgt_idle_tssi = 52;\r\ngphy->tssi2dbm = b43_tssi2dbm_g_table;\r\n}\r\nreturn 0;\r\n}\r\nstatic int b43_gphy_op_allocate(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy_g *gphy;\r\nstruct b43_txpower_lo_control *lo;\r\nint err;\r\ngphy = kzalloc(sizeof(*gphy), GFP_KERNEL);\r\nif (!gphy) {\r\nerr = -ENOMEM;\r\ngoto error;\r\n}\r\ndev->phy.g = gphy;\r\nlo = kzalloc(sizeof(*lo), GFP_KERNEL);\r\nif (!lo) {\r\nerr = -ENOMEM;\r\ngoto err_free_gphy;\r\n}\r\ngphy->lo_control = lo;\r\nerr = b43_gphy_init_tssi2dbm_table(dev);\r\nif (err)\r\ngoto err_free_lo;\r\nreturn 0;\r\nerr_free_lo:\r\nkfree(lo);\r\nerr_free_gphy:\r\nkfree(gphy);\r\nerror:\r\nreturn err;\r\n}\r\nstatic void b43_gphy_op_prepare_structs(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_g *gphy = phy->g;\r\nconst void *tssi2dbm;\r\nint tgt_idle_tssi;\r\nstruct b43_txpower_lo_control *lo;\r\nunsigned int i;\r\ntssi2dbm = gphy->tssi2dbm;\r\ntgt_idle_tssi = gphy->tgt_idle_tssi;\r\nlo = gphy->lo_control;\r\nmemset(gphy, 0, sizeof(*gphy));\r\ngphy->tssi2dbm = tssi2dbm;\r\ngphy->tgt_idle_tssi = tgt_idle_tssi;\r\ngphy->lo_control = lo;\r\nmemset(gphy->minlowsig, 0xFF, sizeof(gphy->minlowsig));\r\nfor (i = 0; i < ARRAY_SIZE(gphy->nrssi); i++)\r\ngphy->nrssi[i] = -1000;\r\nfor (i = 0; i < ARRAY_SIZE(gphy->nrssi_lt); i++)\r\ngphy->nrssi_lt[i] = i;\r\ngphy->lofcal = 0xFFFF;\r\ngphy->initval = 0xFFFF;\r\ngphy->interfmode = B43_INTERFMODE_NONE;\r\ngphy->ofdmtab_addr_direction = B43_OFDMTAB_DIRECTION_UNKNOWN;\r\ngphy->average_tssi = 0xFF;\r\nlo->tx_bias = 0xFF;\r\nINIT_LIST_HEAD(&lo->calib_list);\r\n}\r\nstatic void b43_gphy_op_free(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_g *gphy = phy->g;\r\nkfree(gphy->lo_control);\r\nif (gphy->dyn_tssi_tbl)\r\nkfree(gphy->tssi2dbm);\r\ngphy->dyn_tssi_tbl = false;\r\ngphy->tssi2dbm = NULL;\r\nkfree(gphy);\r\ndev->phy.g = NULL;\r\n}\r\nstatic int b43_gphy_op_prepare_hardware(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_g *gphy = phy->g;\r\nstruct b43_txpower_lo_control *lo = gphy->lo_control;\r\nB43_WARN_ON(phy->type != B43_PHYTYPE_G);\r\ndefault_baseband_attenuation(dev, &gphy->bbatt);\r\ndefault_radio_attenuation(dev, &gphy->rfatt);\r\ngphy->tx_control = (default_tx_control(dev) << 4);\r\ngenerate_rfatt_list(dev, &lo->rfatt_list);\r\ngenerate_bbatt_list(dev, &lo->bbatt_list);\r\nb43_read32(dev, B43_MMIO_MACCTL);\r\nif (phy->rev == 1) {\r\nphy->gmode = false;\r\nb43_wireless_core_reset(dev, 0);\r\nb43_phy_initg(dev);\r\nphy->gmode = true;\r\nb43_wireless_core_reset(dev, 1);\r\n}\r\nreturn 0;\r\n}\r\nstatic int b43_gphy_op_init(struct b43_wldev *dev)\r\n{\r\nb43_phy_initg(dev);\r\nreturn 0;\r\n}\r\nstatic void b43_gphy_op_exit(struct b43_wldev *dev)\r\n{\r\nb43_lo_g_cleanup(dev);\r\n}\r\nstatic u16 b43_gphy_op_read(struct b43_wldev *dev, u16 reg)\r\n{\r\nb43_write16(dev, B43_MMIO_PHY_CONTROL, reg);\r\nreturn b43_read16(dev, B43_MMIO_PHY_DATA);\r\n}\r\nstatic void b43_gphy_op_write(struct b43_wldev *dev, u16 reg, u16 value)\r\n{\r\nb43_write16(dev, B43_MMIO_PHY_CONTROL, reg);\r\nb43_write16(dev, B43_MMIO_PHY_DATA, value);\r\n}\r\nstatic u16 b43_gphy_op_radio_read(struct b43_wldev *dev, u16 reg)\r\n{\r\nB43_WARN_ON(reg == 1);\r\nreg |= 0x80;\r\nb43_write16(dev, B43_MMIO_RADIO_CONTROL, reg);\r\nreturn b43_read16(dev, B43_MMIO_RADIO_DATA_LOW);\r\n}\r\nstatic void b43_gphy_op_radio_write(struct b43_wldev *dev, u16 reg, u16 value)\r\n{\r\nB43_WARN_ON(reg == 1);\r\nb43_write16(dev, B43_MMIO_RADIO_CONTROL, reg);\r\nb43_write16(dev, B43_MMIO_RADIO_DATA_LOW, value);\r\n}\r\nstatic bool b43_gphy_op_supports_hwpctl(struct b43_wldev *dev)\r\n{\r\nreturn (dev->phy.rev >= 6);\r\n}\r\nstatic void b43_gphy_op_software_rfkill(struct b43_wldev *dev,\r\nbool blocked)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_g *gphy = phy->g;\r\nunsigned int channel;\r\nmight_sleep();\r\nif (!blocked) {\r\nif (phy->radio_on)\r\nreturn;\r\nb43_phy_write(dev, 0x0015, 0x8000);\r\nb43_phy_write(dev, 0x0015, 0xCC00);\r\nb43_phy_write(dev, 0x0015, (phy->gmode ? 0x00C0 : 0x0000));\r\nif (gphy->radio_off_context.valid) {\r\nb43_phy_write(dev, B43_PHY_RFOVER,\r\ngphy->radio_off_context.rfover);\r\nb43_phy_write(dev, B43_PHY_RFOVERVAL,\r\ngphy->radio_off_context.rfoverval);\r\ngphy->radio_off_context.valid = false;\r\n}\r\nchannel = phy->channel;\r\nb43_gphy_channel_switch(dev, 6, 1);\r\nb43_gphy_channel_switch(dev, channel, 0);\r\n} else {\r\nu16 rfover, rfoverval;\r\nrfover = b43_phy_read(dev, B43_PHY_RFOVER);\r\nrfoverval = b43_phy_read(dev, B43_PHY_RFOVERVAL);\r\ngphy->radio_off_context.rfover = rfover;\r\ngphy->radio_off_context.rfoverval = rfoverval;\r\ngphy->radio_off_context.valid = true;\r\nb43_phy_write(dev, B43_PHY_RFOVER, rfover | 0x008C);\r\nb43_phy_write(dev, B43_PHY_RFOVERVAL, rfoverval & 0xFF73);\r\n}\r\n}\r\nstatic int b43_gphy_op_switch_channel(struct b43_wldev *dev,\r\nunsigned int new_channel)\r\n{\r\nif ((new_channel < 1) || (new_channel > 14))\r\nreturn -EINVAL;\r\nb43_gphy_channel_switch(dev, new_channel, 0);\r\nreturn 0;\r\n}\r\nstatic unsigned int b43_gphy_op_get_default_chan(struct b43_wldev *dev)\r\n{\r\nreturn 1;\r\n}\r\nstatic void b43_gphy_op_set_rx_antenna(struct b43_wldev *dev, int antenna)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nu16 tmp;\r\nint autodiv = 0;\r\nif (antenna == B43_ANTENNA_AUTO0 || antenna == B43_ANTENNA_AUTO1)\r\nautodiv = 1;\r\nb43_hf_write(dev, b43_hf_read(dev) & ~B43_HF_ANTDIVHELP);\r\nb43_phy_maskset(dev, B43_PHY_BBANDCFG, ~B43_PHY_BBANDCFG_RXANT,\r\n(autodiv ? B43_ANTENNA_AUTO1 : antenna) <<\r\nB43_PHY_BBANDCFG_RXANT_SHIFT);\r\nif (autodiv) {\r\ntmp = b43_phy_read(dev, B43_PHY_ANTDWELL);\r\nif (antenna == B43_ANTENNA_AUTO1)\r\ntmp &= ~B43_PHY_ANTDWELL_AUTODIV1;\r\nelse\r\ntmp |= B43_PHY_ANTDWELL_AUTODIV1;\r\nb43_phy_write(dev, B43_PHY_ANTDWELL, tmp);\r\n}\r\ntmp = b43_phy_read(dev, B43_PHY_ANTWRSETT);\r\nif (autodiv)\r\ntmp |= B43_PHY_ANTWRSETT_ARXDIV;\r\nelse\r\ntmp &= ~B43_PHY_ANTWRSETT_ARXDIV;\r\nb43_phy_write(dev, B43_PHY_ANTWRSETT, tmp);\r\nif (autodiv)\r\nb43_phy_set(dev, B43_PHY_ANTWRSETT, B43_PHY_ANTWRSETT_ARXDIV);\r\nelse {\r\nb43_phy_mask(dev, B43_PHY_ANTWRSETT,\r\nB43_PHY_ANTWRSETT_ARXDIV);\r\n}\r\nif (phy->rev >= 2) {\r\nb43_phy_set(dev, B43_PHY_OFDM61, B43_PHY_OFDM61_10);\r\nb43_phy_maskset(dev, B43_PHY_DIVSRCHGAINBACK, 0xFF00, 0x15);\r\nif (phy->rev == 2)\r\nb43_phy_write(dev, B43_PHY_ADIVRELATED, 8);\r\nelse\r\nb43_phy_maskset(dev, B43_PHY_ADIVRELATED, 0xFF00, 8);\r\n}\r\nif (phy->rev >= 6)\r\nb43_phy_write(dev, B43_PHY_OFDM9B, 0xDC);\r\nb43_hf_write(dev, b43_hf_read(dev) | B43_HF_ANTDIVHELP);\r\n}\r\nstatic int b43_gphy_op_interf_mitigation(struct b43_wldev *dev,\r\nenum b43_interference_mitigation mode)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_g *gphy = phy->g;\r\nint currentmode;\r\nB43_WARN_ON(phy->type != B43_PHYTYPE_G);\r\nif ((phy->rev == 0) || (!phy->gmode))\r\nreturn -ENODEV;\r\ngphy->aci_wlan_automatic = false;\r\nswitch (mode) {\r\ncase B43_INTERFMODE_AUTOWLAN:\r\ngphy->aci_wlan_automatic = true;\r\nif (gphy->aci_enable)\r\nmode = B43_INTERFMODE_MANUALWLAN;\r\nelse\r\nmode = B43_INTERFMODE_NONE;\r\nbreak;\r\ncase B43_INTERFMODE_NONE:\r\ncase B43_INTERFMODE_NONWLAN:\r\ncase B43_INTERFMODE_MANUALWLAN:\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ncurrentmode = gphy->interfmode;\r\nif (currentmode == mode)\r\nreturn 0;\r\nif (currentmode != B43_INTERFMODE_NONE)\r\nb43_radio_interference_mitigation_disable(dev, currentmode);\r\nif (mode == B43_INTERFMODE_NONE) {\r\ngphy->aci_enable = false;\r\ngphy->aci_hw_rssi = false;\r\n} else\r\nb43_radio_interference_mitigation_enable(dev, mode);\r\ngphy->interfmode = mode;\r\nreturn 0;\r\n}\r\nstatic s8 b43_gphy_estimate_power_out(struct b43_wldev *dev, s8 tssi)\r\n{\r\nstruct b43_phy_g *gphy = dev->phy.g;\r\ns8 dbm;\r\ns32 tmp;\r\ntmp = (gphy->tgt_idle_tssi - gphy->cur_idle_tssi + tssi);\r\ntmp = clamp_val(tmp, 0x00, 0x3F);\r\ndbm = gphy->tssi2dbm[tmp];\r\nreturn dbm;\r\n}\r\nstatic void b43_put_attenuation_into_ranges(struct b43_wldev *dev,\r\nint *_bbatt, int *_rfatt)\r\n{\r\nint rfatt = *_rfatt;\r\nint bbatt = *_bbatt;\r\nstruct b43_txpower_lo_control *lo = dev->phy.g->lo_control;\r\nconst int rf_min = lo->rfatt_list.min_val;\r\nconst int rf_max = lo->rfatt_list.max_val;\r\nconst int bb_min = lo->bbatt_list.min_val;\r\nconst int bb_max = lo->bbatt_list.max_val;\r\nwhile (1) {\r\nif (rfatt > rf_max && bbatt > bb_max - 4)\r\nbreak;\r\nif (rfatt < rf_min && bbatt < bb_min + 4)\r\nbreak;\r\nif (bbatt > bb_max && rfatt > rf_max - 1)\r\nbreak;\r\nif (bbatt < bb_min && rfatt < rf_min + 1)\r\nbreak;\r\nif (bbatt > bb_max) {\r\nbbatt -= 4;\r\nrfatt += 1;\r\ncontinue;\r\n}\r\nif (bbatt < bb_min) {\r\nbbatt += 4;\r\nrfatt -= 1;\r\ncontinue;\r\n}\r\nif (rfatt > rf_max) {\r\nrfatt -= 1;\r\nbbatt += 4;\r\ncontinue;\r\n}\r\nif (rfatt < rf_min) {\r\nrfatt += 1;\r\nbbatt -= 4;\r\ncontinue;\r\n}\r\nbreak;\r\n}\r\n*_rfatt = clamp_val(rfatt, rf_min, rf_max);\r\n*_bbatt = clamp_val(bbatt, bb_min, bb_max);\r\n}\r\nstatic void b43_gphy_op_adjust_txpower(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_g *gphy = phy->g;\r\nint rfatt, bbatt;\r\nu8 tx_control;\r\nb43_mac_suspend(dev);\r\nbbatt = gphy->bbatt.att;\r\nbbatt += gphy->bbatt_delta;\r\nrfatt = gphy->rfatt.att;\r\nrfatt += gphy->rfatt_delta;\r\nb43_put_attenuation_into_ranges(dev, &bbatt, &rfatt);\r\ntx_control = gphy->tx_control;\r\nif ((phy->radio_ver == 0x2050) && (phy->radio_rev == 2)) {\r\nif (rfatt <= 1) {\r\nif (tx_control == 0) {\r\ntx_control =\r\nB43_TXCTL_PA2DB |\r\nB43_TXCTL_TXMIX;\r\nrfatt += 2;\r\nbbatt += 2;\r\n} else if (dev->dev->bus_sprom->\r\nboardflags_lo &\r\nB43_BFL_PACTRL) {\r\nbbatt += 4 * (rfatt - 2);\r\nrfatt = 2;\r\n}\r\n} else if (rfatt > 4 && tx_control) {\r\ntx_control = 0;\r\nif (bbatt < 3) {\r\nrfatt -= 3;\r\nbbatt += 2;\r\n} else {\r\nrfatt -= 2;\r\nbbatt -= 2;\r\n}\r\n}\r\n}\r\ngphy->tx_control = tx_control;\r\nb43_put_attenuation_into_ranges(dev, &bbatt, &rfatt);\r\ngphy->rfatt.att = rfatt;\r\ngphy->bbatt.att = bbatt;\r\nif (b43_debug(dev, B43_DBG_XMITPOWER))\r\nb43dbg(dev->wl, "Adjusting TX power\n");\r\nb43_phy_lock(dev);\r\nb43_radio_lock(dev);\r\nb43_set_txpower_g(dev, &gphy->bbatt, &gphy->rfatt,\r\ngphy->tx_control);\r\nb43_radio_unlock(dev);\r\nb43_phy_unlock(dev);\r\nb43_mac_enable(dev);\r\n}\r\nstatic enum b43_txpwr_result b43_gphy_op_recalc_txpower(struct b43_wldev *dev,\r\nbool ignore_tssi)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_g *gphy = phy->g;\r\nunsigned int average_tssi;\r\nint cck_result, ofdm_result;\r\nint estimated_pwr, desired_pwr, pwr_adjust;\r\nint rfatt_delta, bbatt_delta;\r\nunsigned int max_pwr;\r\ncck_result = b43_phy_shm_tssi_read(dev, B43_SHM_SH_TSSI_CCK);\r\nofdm_result = b43_phy_shm_tssi_read(dev, B43_SHM_SH_TSSI_OFDM_G);\r\nif ((cck_result < 0) && (ofdm_result < 0)) {\r\nif (!ignore_tssi)\r\ngoto no_adjustment_needed;\r\ncck_result = 0;\r\nofdm_result = 0;\r\n}\r\nif (cck_result < 0)\r\naverage_tssi = ofdm_result;\r\nelse if (ofdm_result < 0)\r\naverage_tssi = cck_result;\r\nelse\r\naverage_tssi = (cck_result + ofdm_result) / 2;\r\nif (likely(gphy->average_tssi != 0xFF))\r\naverage_tssi = (average_tssi + gphy->average_tssi) / 2;\r\ngphy->average_tssi = average_tssi;\r\nB43_WARN_ON(average_tssi >= B43_TSSI_MAX);\r\nestimated_pwr = b43_gphy_estimate_power_out(dev, average_tssi);\r\nB43_WARN_ON(phy->type != B43_PHYTYPE_G);\r\nmax_pwr = dev->dev->bus_sprom->maxpwr_bg;\r\nif (dev->dev->bus_sprom->boardflags_lo & B43_BFL_PACTRL)\r\nmax_pwr -= 3;\r\nif (unlikely(max_pwr >= INT_TO_Q52(30))) {\r\nb43warn(dev->wl,\r\n"Invalid max-TX-power value in SPROM.\n");\r\nmax_pwr = INT_TO_Q52(20);\r\ndev->dev->bus_sprom->maxpwr_bg = max_pwr;\r\n}\r\nif (phy->desired_txpower < 0)\r\ndesired_pwr = INT_TO_Q52(0);\r\nelse\r\ndesired_pwr = INT_TO_Q52(phy->desired_txpower);\r\ndesired_pwr = clamp_val(desired_pwr, 0, max_pwr);\r\nif (b43_debug(dev, B43_DBG_XMITPOWER)) {\r\nb43dbg(dev->wl,\r\n"[TX power] current = " Q52_FMT\r\n" dBm, desired = " Q52_FMT\r\n" dBm, max = " Q52_FMT "\n",\r\nQ52_ARG(estimated_pwr),\r\nQ52_ARG(desired_pwr),\r\nQ52_ARG(max_pwr));\r\n}\r\npwr_adjust = desired_pwr - estimated_pwr;\r\nif (pwr_adjust == 0)\r\ngoto no_adjustment_needed;\r\nrfatt_delta = ((pwr_adjust + 7) / 8);\r\nrfatt_delta = -rfatt_delta;\r\nbbatt_delta = pwr_adjust / 2;\r\nbbatt_delta = -bbatt_delta;\r\nbbatt_delta -= 4 * rfatt_delta;\r\n#if B43_DEBUG\r\nif (b43_debug(dev, B43_DBG_XMITPOWER)) {\r\nint dbm = pwr_adjust < 0 ? -pwr_adjust : pwr_adjust;\r\nb43dbg(dev->wl,\r\n"[TX power deltas] %s" Q52_FMT " dBm => "\r\n"bbatt-delta = %d, rfatt-delta = %d\n",\r\n(pwr_adjust < 0 ? "-" : ""), Q52_ARG(dbm),\r\nbbatt_delta, rfatt_delta);\r\n}\r\n#endif\r\nif ((rfatt_delta == 0) && (bbatt_delta == 0))\r\ngoto no_adjustment_needed;\r\ngphy->bbatt_delta = bbatt_delta;\r\ngphy->rfatt_delta = rfatt_delta;\r\nreturn B43_TXPWR_RES_NEED_ADJUST;\r\nno_adjustment_needed:\r\nreturn B43_TXPWR_RES_DONE;\r\n}\r\nstatic void b43_gphy_op_pwork_15sec(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nstruct b43_phy_g *gphy = phy->g;\r\nb43_mac_suspend(dev);\r\nif (gphy->aci_enable && gphy->aci_wlan_automatic) {\r\nif (!gphy->aci_enable && 1 ) {\r\nif (0 ) {\r\nphy->ops->interf_mitigation(dev,\r\nB43_INTERFMODE_MANUALWLAN);\r\n}\r\n} else if (0 ) {\r\nif ( !b43_gphy_aci_scan(dev))\r\nphy->ops->interf_mitigation(dev, B43_INTERFMODE_NONE);\r\n}\r\n} else if (gphy->interfmode == B43_INTERFMODE_NONWLAN &&\r\nphy->rev == 1) {\r\n}\r\nb43_lo_g_maintanance_work(dev);\r\nb43_mac_enable(dev);\r\n}\r\nstatic void b43_gphy_op_pwork_60sec(struct b43_wldev *dev)\r\n{\r\nstruct b43_phy *phy = &dev->phy;\r\nif (!(dev->dev->bus_sprom->boardflags_lo & B43_BFL_RSSI))\r\nreturn;\r\nb43_mac_suspend(dev);\r\nb43_calc_nrssi_slope(dev);\r\nif ((phy->radio_ver == 0x2050) && (phy->radio_rev == 8)) {\r\nu8 old_chan = phy->channel;\r\nif (old_chan >= 8)\r\nb43_switch_channel(dev, 1);\r\nelse\r\nb43_switch_channel(dev, 13);\r\nb43_switch_channel(dev, old_chan);\r\n}\r\nb43_mac_enable(dev);\r\n}

int carl9170_set_dyn_sifs_ack(struct ar9170 *ar)\r\n{\r\nu32 val;\r\nif (conf_is_ht40(&ar->hw->conf))\r\nval = 0x010a;\r\nelse {\r\nif (ar->hw->conf.channel->band == IEEE80211_BAND_2GHZ)\r\nval = 0x105;\r\nelse\r\nval = 0x104;\r\n}\r\nreturn carl9170_write_reg(ar, AR9170_MAC_REG_DYNAMIC_SIFS_ACK, val);\r\n}\r\nint carl9170_set_rts_cts_rate(struct ar9170 *ar)\r\n{\r\nu32 rts_rate, cts_rate;\r\nif (conf_is_ht(&ar->hw->conf)) {\r\nrts_rate = 0x1da;\r\ncts_rate = 0x10a;\r\n} else {\r\nif (ar->hw->conf.channel->band == IEEE80211_BAND_2GHZ) {\r\nrts_rate = 033;\r\ncts_rate = 003;\r\n} else {\r\nrts_rate = 0x1bb;\r\ncts_rate = 0x10b;\r\n}\r\n}\r\nreturn carl9170_write_reg(ar, AR9170_MAC_REG_RTS_CTS_RATE,\r\nrts_rate | (cts_rate) << 16);\r\n}\r\nint carl9170_set_slot_time(struct ar9170 *ar)\r\n{\r\nstruct ieee80211_vif *vif;\r\nu32 slottime = 20;\r\nrcu_read_lock();\r\nvif = carl9170_get_main_vif(ar);\r\nif (!vif) {\r\nrcu_read_unlock();\r\nreturn 0;\r\n}\r\nif ((ar->hw->conf.channel->band == IEEE80211_BAND_5GHZ) ||\r\nvif->bss_conf.use_short_slot)\r\nslottime = 9;\r\nrcu_read_unlock();\r\nreturn carl9170_write_reg(ar, AR9170_MAC_REG_SLOT_TIME,\r\nslottime << 10);\r\n}\r\nint carl9170_set_mac_rates(struct ar9170 *ar)\r\n{\r\nstruct ieee80211_vif *vif;\r\nu32 basic, mandatory;\r\nrcu_read_lock();\r\nvif = carl9170_get_main_vif(ar);\r\nif (!vif) {\r\nrcu_read_unlock();\r\nreturn 0;\r\n}\r\nbasic = (vif->bss_conf.basic_rates & 0xf);\r\nbasic |= (vif->bss_conf.basic_rates & 0xff0) << 4;\r\nrcu_read_unlock();\r\nif (ar->hw->conf.channel->band == IEEE80211_BAND_5GHZ)\r\nmandatory = 0xff00;\r\nelse\r\nmandatory = 0xff0f;\r\ncarl9170_regwrite_begin(ar);\r\ncarl9170_regwrite(AR9170_MAC_REG_BASIC_RATE, basic);\r\ncarl9170_regwrite(AR9170_MAC_REG_MANDATORY_RATE, mandatory);\r\ncarl9170_regwrite_finish();\r\nreturn carl9170_regwrite_result();\r\n}\r\nint carl9170_set_qos(struct ar9170 *ar)\r\n{\r\ncarl9170_regwrite_begin(ar);\r\ncarl9170_regwrite(AR9170_MAC_REG_AC0_CW, ar->edcf[0].cw_min |\r\n(ar->edcf[0].cw_max << 16));\r\ncarl9170_regwrite(AR9170_MAC_REG_AC1_CW, ar->edcf[1].cw_min |\r\n(ar->edcf[1].cw_max << 16));\r\ncarl9170_regwrite(AR9170_MAC_REG_AC2_CW, ar->edcf[2].cw_min |\r\n(ar->edcf[2].cw_max << 16));\r\ncarl9170_regwrite(AR9170_MAC_REG_AC3_CW, ar->edcf[3].cw_min |\r\n(ar->edcf[3].cw_max << 16));\r\ncarl9170_regwrite(AR9170_MAC_REG_AC4_CW, ar->edcf[4].cw_min |\r\n(ar->edcf[4].cw_max << 16));\r\ncarl9170_regwrite(AR9170_MAC_REG_AC2_AC1_AC0_AIFS,\r\n((ar->edcf[0].aifs * 9 + 10)) |\r\n((ar->edcf[1].aifs * 9 + 10) << 12) |\r\n((ar->edcf[2].aifs * 9 + 10) << 24));\r\ncarl9170_regwrite(AR9170_MAC_REG_AC4_AC3_AC2_AIFS,\r\n((ar->edcf[2].aifs * 9 + 10) >> 8) |\r\n((ar->edcf[3].aifs * 9 + 10) << 4) |\r\n((ar->edcf[4].aifs * 9 + 10) << 16));\r\ncarl9170_regwrite(AR9170_MAC_REG_AC1_AC0_TXOP,\r\nar->edcf[0].txop | ar->edcf[1].txop << 16);\r\ncarl9170_regwrite(AR9170_MAC_REG_AC3_AC2_TXOP,\r\nar->edcf[2].txop | ar->edcf[3].txop << 16 |\r\nar->edcf[4].txop << 24);\r\ncarl9170_regwrite_finish();\r\nreturn carl9170_regwrite_result();\r\n}\r\nint carl9170_init_mac(struct ar9170 *ar)\r\n{\r\ncarl9170_regwrite_begin(ar);\r\ncarl9170_regwrite(0x1c3600, 0x3);\r\ncarl9170_regwrite(AR9170_MAC_REG_ACK_EXTENSION, 0x40);\r\ncarl9170_regwrite(AR9170_MAC_REG_RETRY_MAX, 0x0);\r\ncarl9170_regwrite(AR9170_MAC_REG_FRAMETYPE_FILTER,\r\nAR9170_MAC_FTF_MONITOR);\r\ncarl9170_regwrite(AR9170_MAC_REG_SNIFFER,\r\nAR9170_MAC_SNIFFER_DEFAULTS);\r\ncarl9170_regwrite(AR9170_MAC_REG_RX_THRESHOLD, 0xc1f80);\r\ncarl9170_regwrite(AR9170_MAC_REG_RX_PE_DELAY, 0x70);\r\ncarl9170_regwrite(AR9170_MAC_REG_EIFS_AND_SIFS, 0xa144000);\r\ncarl9170_regwrite(AR9170_MAC_REG_SLOT_TIME, 9 << 10);\r\ncarl9170_regwrite(AR9170_MAC_REG_TID_CFACK_CFEND_RATE, 0x59900000);\r\ncarl9170_regwrite(AR9170_MAC_REG_TXOP_DURATION, 0x201);\r\ncarl9170_regwrite(AR9170_MAC_REG_BCN_HT1, 0x8000170);\r\ncarl9170_regwrite(AR9170_MAC_REG_BACKOFF_PROTECT, 0x105);\r\ncarl9170_regwrite(AR9170_MAC_REG_AMPDU_FACTOR, 0x8000a);\r\ncarl9170_regwrite(AR9170_MAC_REG_AMPDU_DENSITY, 0x140a07);\r\ncarl9170_regwrite(AR9170_MAC_REG_FRAMETYPE_FILTER,\r\nAR9170_MAC_FTF_DEFAULTS);\r\ncarl9170_regwrite(AR9170_MAC_REG_RX_CONTROL,\r\nAR9170_MAC_RX_CTRL_DEAGG |\r\nAR9170_MAC_RX_CTRL_SHORT_FILTER);\r\ncarl9170_regwrite(AR9170_MAC_REG_BASIC_RATE, 0x150f);\r\ncarl9170_regwrite(AR9170_MAC_REG_MANDATORY_RATE, 0x150f);\r\ncarl9170_regwrite(AR9170_MAC_REG_RTS_CTS_RATE, 0x0030033);\r\ncarl9170_regwrite(AR9170_MAC_REG_ACK_TPC, 0x4003c1e);\r\ncarl9170_regwrite(AR9170_MAC_REG_AMPDU_RX_THRESH, 0xffff);\r\ncarl9170_regwrite(AR9170_MAC_REG_MISC_680, 0xf00008);\r\ncarl9170_regwrite(AR9170_MAC_REG_RX_TIMEOUT, 0x0);\r\ncarl9170_regwrite(AR9170_MAC_REG_TXRX_MPI, 0x110011);\r\ncarl9170_regwrite(AR9170_MAC_REG_FCS_SELECT,\r\nAR9170_MAC_FCS_FIFO_PROT);\r\ncarl9170_regwrite(AR9170_MAC_REG_TXOP_NOT_ENOUGH_IND,\r\n0x141e0f48);\r\ncarl9170_regwrite(AR9170_MAC_REG_GROUP_HASH_TBL_L, 0xffffffff);\r\ncarl9170_regwrite(AR9170_MAC_REG_GROUP_HASH_TBL_H, 0xffffffff);\r\ncarl9170_regwrite(AR9170_MAC_REG_PRETBTT, 0x0);\r\ncarl9170_regwrite(AR9170_MAC_REG_BCN_PERIOD, 0x0);\r\ncarl9170_regwrite_finish();\r\nreturn carl9170_regwrite_result();\r\n}\r\nstatic int carl9170_set_mac_reg(struct ar9170 *ar,\r\nconst u32 reg, const u8 *mac)\r\n{\r\nstatic const u8 zero[ETH_ALEN] = { 0 };\r\nif (!mac)\r\nmac = zero;\r\ncarl9170_regwrite_begin(ar);\r\ncarl9170_regwrite(reg, get_unaligned_le32(mac));\r\ncarl9170_regwrite(reg + 4, get_unaligned_le16(mac + 4));\r\ncarl9170_regwrite_finish();\r\nreturn carl9170_regwrite_result();\r\n}\r\nint carl9170_mod_virtual_mac(struct ar9170 *ar, const unsigned int id,\r\nconst u8 *mac)\r\n{\r\nif (WARN_ON(id >= ar->fw.vif_num))\r\nreturn -EINVAL;\r\nreturn carl9170_set_mac_reg(ar,\r\nAR9170_MAC_REG_ACK_TABLE + (id - 1) * 8, mac);\r\n}\r\nint carl9170_update_multicast(struct ar9170 *ar, const u64 mc_hash)\r\n{\r\nint err;\r\ncarl9170_regwrite_begin(ar);\r\ncarl9170_regwrite(AR9170_MAC_REG_GROUP_HASH_TBL_H, mc_hash >> 32);\r\ncarl9170_regwrite(AR9170_MAC_REG_GROUP_HASH_TBL_L, mc_hash);\r\ncarl9170_regwrite_finish();\r\nerr = carl9170_regwrite_result();\r\nif (err)\r\nreturn err;\r\nar->cur_mc_hash = mc_hash;\r\nreturn 0;\r\n}\r\nint carl9170_set_operating_mode(struct ar9170 *ar)\r\n{\r\nstruct ieee80211_vif *vif;\r\nstruct ath_common *common = &ar->common;\r\nu8 *mac_addr, *bssid;\r\nu32 cam_mode = AR9170_MAC_CAM_DEFAULTS;\r\nu32 enc_mode = AR9170_MAC_ENCRYPTION_DEFAULTS |\r\nAR9170_MAC_ENCRYPTION_MGMT_RX_SOFTWARE;\r\nu32 rx_ctrl = AR9170_MAC_RX_CTRL_DEAGG |\r\nAR9170_MAC_RX_CTRL_SHORT_FILTER;\r\nu32 sniffer = AR9170_MAC_SNIFFER_DEFAULTS;\r\nint err = 0;\r\nrcu_read_lock();\r\nvif = carl9170_get_main_vif(ar);\r\nif (vif) {\r\nmac_addr = common->macaddr;\r\nbssid = common->curbssid;\r\nswitch (vif->type) {\r\ncase NL80211_IFTYPE_ADHOC:\r\ncam_mode |= AR9170_MAC_CAM_IBSS;\r\nbreak;\r\ncase NL80211_IFTYPE_MESH_POINT:\r\ncase NL80211_IFTYPE_AP:\r\ncam_mode |= AR9170_MAC_CAM_AP;\r\nrx_ctrl |= AR9170_MAC_RX_CTRL_PASS_TO_HOST;\r\nbreak;\r\ncase NL80211_IFTYPE_WDS:\r\ncam_mode |= AR9170_MAC_CAM_AP_WDS;\r\nrx_ctrl |= AR9170_MAC_RX_CTRL_PASS_TO_HOST;\r\nbreak;\r\ncase NL80211_IFTYPE_STATION:\r\ncam_mode |= AR9170_MAC_CAM_STA;\r\nrx_ctrl |= AR9170_MAC_RX_CTRL_PASS_TO_HOST;\r\nbreak;\r\ndefault:\r\nWARN(1, "Unsupported operation mode %x\n", vif->type);\r\nerr = -EOPNOTSUPP;\r\nbreak;\r\n}\r\n} else {\r\ncam_mode |= AR9170_MAC_CAM_STA;\r\nrx_ctrl |= AR9170_MAC_RX_CTRL_PASS_TO_HOST;\r\nmac_addr = common->macaddr;\r\nbssid = NULL;\r\n}\r\nrcu_read_unlock();\r\nif (err)\r\nreturn err;\r\nif (ar->rx_software_decryption)\r\nenc_mode |= AR9170_MAC_ENCRYPTION_RX_SOFTWARE;\r\nif (ar->sniffer_enabled) {\r\nenc_mode |= AR9170_MAC_ENCRYPTION_RX_SOFTWARE;\r\n}\r\nerr = carl9170_set_mac_reg(ar, AR9170_MAC_REG_MAC_ADDR_L, mac_addr);\r\nif (err)\r\nreturn err;\r\nerr = carl9170_set_mac_reg(ar, AR9170_MAC_REG_BSSID_L, bssid);\r\nif (err)\r\nreturn err;\r\ncarl9170_regwrite_begin(ar);\r\ncarl9170_regwrite(AR9170_MAC_REG_SNIFFER, sniffer);\r\ncarl9170_regwrite(AR9170_MAC_REG_CAM_MODE, cam_mode);\r\ncarl9170_regwrite(AR9170_MAC_REG_ENCRYPTION, enc_mode);\r\ncarl9170_regwrite(AR9170_MAC_REG_RX_CONTROL, rx_ctrl);\r\ncarl9170_regwrite_finish();\r\nreturn carl9170_regwrite_result();\r\n}\r\nint carl9170_set_hwretry_limit(struct ar9170 *ar, const unsigned int max_retry)\r\n{\r\nu32 tmp = min_t(u32, 0x33333, max_retry * 0x11111);\r\nreturn carl9170_write_reg(ar, AR9170_MAC_REG_RETRY_MAX, tmp);\r\n}\r\nint carl9170_set_beacon_timers(struct ar9170 *ar)\r\n{\r\nstruct ieee80211_vif *vif;\r\nu32 v = 0;\r\nu32 pretbtt = 0;\r\nrcu_read_lock();\r\nvif = carl9170_get_main_vif(ar);\r\nif (vif) {\r\nstruct carl9170_vif_info *mvif;\r\nmvif = (void *) vif->drv_priv;\r\nif (mvif->enable_beacon && !WARN_ON(!ar->beacon_enabled)) {\r\nar->global_beacon_int = vif->bss_conf.beacon_int /\r\nar->beacon_enabled;\r\nSET_VAL(AR9170_MAC_BCN_DTIM, v,\r\nvif->bss_conf.dtim_period);\r\nswitch (vif->type) {\r\ncase NL80211_IFTYPE_MESH_POINT:\r\ncase NL80211_IFTYPE_ADHOC:\r\nv |= AR9170_MAC_BCN_IBSS_MODE;\r\nbreak;\r\ncase NL80211_IFTYPE_AP:\r\nv |= AR9170_MAC_BCN_AP_MODE;\r\nbreak;\r\ndefault:\r\nWARN_ON_ONCE(1);\r\nbreak;\r\n}\r\n} else if (vif->type == NL80211_IFTYPE_STATION) {\r\nar->global_beacon_int = vif->bss_conf.beacon_int;\r\nSET_VAL(AR9170_MAC_BCN_DTIM, v,\r\nar->hw->conf.ps_dtim_period);\r\nv |= AR9170_MAC_BCN_STA_PS |\r\nAR9170_MAC_BCN_PWR_MGT;\r\n}\r\nif (ar->global_beacon_int) {\r\nif (ar->global_beacon_int < 15) {\r\nrcu_read_unlock();\r\nreturn -ERANGE;\r\n}\r\nar->global_pretbtt = ar->global_beacon_int -\r\nCARL9170_PRETBTT_KUS;\r\n} else {\r\nar->global_pretbtt = 0;\r\n}\r\n} else {\r\nar->global_beacon_int = 0;\r\nar->global_pretbtt = 0;\r\n}\r\nrcu_read_unlock();\r\nSET_VAL(AR9170_MAC_BCN_PERIOD, v, ar->global_beacon_int);\r\nSET_VAL(AR9170_MAC_PRETBTT, pretbtt, ar->global_pretbtt);\r\nSET_VAL(AR9170_MAC_PRETBTT2, pretbtt, ar->global_pretbtt);\r\ncarl9170_regwrite_begin(ar);\r\ncarl9170_regwrite(AR9170_MAC_REG_PRETBTT, pretbtt);\r\ncarl9170_regwrite(AR9170_MAC_REG_BCN_PERIOD, v);\r\ncarl9170_regwrite_finish();\r\nreturn carl9170_regwrite_result();\r\n}\r\nint carl9170_upload_key(struct ar9170 *ar, const u8 id, const u8 *mac,\r\nconst u8 ktype, const u8 keyidx, const u8 *keydata,\r\nconst int keylen)\r\n{\r\nstruct carl9170_set_key_cmd key = { };\r\nstatic const u8 bcast[ETH_ALEN] = {\r\n0xff, 0xff, 0xff, 0xff, 0xff, 0xff };\r\nmac = mac ? : bcast;\r\nkey.user = cpu_to_le16(id);\r\nkey.keyId = cpu_to_le16(keyidx);\r\nkey.type = cpu_to_le16(ktype);\r\nmemcpy(&key.macAddr, mac, ETH_ALEN);\r\nif (keydata)\r\nmemcpy(&key.key, keydata, keylen);\r\nreturn carl9170_exec_cmd(ar, CARL9170_CMD_EKEY,\r\nsizeof(key), (u8 *)&key, 0, NULL);\r\n}\r\nint carl9170_disable_key(struct ar9170 *ar, const u8 id)\r\n{\r\nstruct carl9170_disable_key_cmd key = { };\r\nkey.user = cpu_to_le16(id);\r\nreturn carl9170_exec_cmd(ar, CARL9170_CMD_DKEY,\r\nsizeof(key), (u8 *)&key, 0, NULL);\r\n}\r\nint carl9170_set_mac_tpc(struct ar9170 *ar, struct ieee80211_channel *channel)\r\n{\r\nunsigned int power, chains;\r\nif (ar->eeprom.tx_mask != 1)\r\nchains = AR9170_TX_PHY_TXCHAIN_2;\r\nelse\r\nchains = AR9170_TX_PHY_TXCHAIN_1;\r\nswitch (channel->band) {\r\ncase IEEE80211_BAND_2GHZ:\r\npower = ar->power_2G_ofdm[0] & 0x3f;\r\nbreak;\r\ncase IEEE80211_BAND_5GHZ:\r\npower = ar->power_5G_leg[0] & 0x3f;\r\nbreak;\r\ndefault:\r\nBUG_ON(1);\r\n}\r\npower = min_t(unsigned int, power, ar->hw->conf.power_level * 2);\r\ncarl9170_regwrite_begin(ar);\r\ncarl9170_regwrite(AR9170_MAC_REG_ACK_TPC,\r\n0x3c1e | power << 20 | chains << 26);\r\ncarl9170_regwrite(AR9170_MAC_REG_RTS_CTS_TPC,\r\npower << 5 | chains << 11 |\r\npower << 21 | chains << 27);\r\ncarl9170_regwrite(AR9170_MAC_REG_CFEND_QOSNULL_TPC,\r\npower << 5 | chains << 11 |\r\npower << 21 | chains << 27);\r\ncarl9170_regwrite_finish();\r\nreturn carl9170_regwrite_result();\r\n}

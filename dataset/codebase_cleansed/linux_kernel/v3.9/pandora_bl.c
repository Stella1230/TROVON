static int pandora_backlight_update_status(struct backlight_device *bl)\r\n{\r\nint brightness = bl->props.brightness;\r\nu8 r;\r\nif (bl->props.power != FB_BLANK_UNBLANK)\r\nbrightness = 0;\r\nif (bl->props.state & BL_CORE_FBBLANK)\r\nbrightness = 0;\r\nif (bl->props.state & BL_CORE_SUSPENDED)\r\nbrightness = 0;\r\nif ((unsigned int)brightness > MAX_USER_VALUE)\r\nbrightness = MAX_USER_VALUE;\r\nif (brightness == 0) {\r\nif (bl->props.state & PANDORABL_WAS_OFF)\r\ngoto done;\r\ntwl_i2c_read_u8(TWL4030_MODULE_INTBR, &r, TWL_INTBR_GPBR1);\r\nr &= ~PWM0_ENABLE;\r\ntwl_i2c_write_u8(TWL4030_MODULE_INTBR, r, TWL_INTBR_GPBR1);\r\nr &= ~PWM0_CLK_ENABLE;\r\ntwl_i2c_write_u8(TWL4030_MODULE_INTBR, r, TWL_INTBR_GPBR1);\r\ngoto done;\r\n}\r\nif (bl->props.state & PANDORABL_WAS_OFF) {\r\ntwl_i2c_write_u8(TWL_MODULE_PWM, MAX_VALUE, TWL_PWM0_OFF);\r\ntwl_i2c_read_u8(TWL4030_MODULE_INTBR, &r, TWL_INTBR_GPBR1);\r\nr &= ~PWM0_ENABLE;\r\nr |= PWM0_CLK_ENABLE;\r\ntwl_i2c_write_u8(TWL4030_MODULE_INTBR, r, TWL_INTBR_GPBR1);\r\nr |= PWM0_ENABLE;\r\ntwl_i2c_write_u8(TWL4030_MODULE_INTBR, r, TWL_INTBR_GPBR1);\r\nusleep_range(2000, 10000);\r\n}\r\ntwl_i2c_write_u8(TWL_MODULE_PWM, MIN_VALUE + brightness, TWL_PWM0_OFF);\r\ndone:\r\nif (brightness != 0)\r\nbl->props.state &= ~PANDORABL_WAS_OFF;\r\nelse\r\nbl->props.state |= PANDORABL_WAS_OFF;\r\nreturn 0;\r\n}\r\nstatic int pandora_backlight_get_brightness(struct backlight_device *bl)\r\n{\r\nreturn bl->props.brightness;\r\n}\r\nstatic int pandora_backlight_probe(struct platform_device *pdev)\r\n{\r\nstruct backlight_properties props;\r\nstruct backlight_device *bl;\r\nu8 r;\r\nmemset(&props, 0, sizeof(props));\r\nprops.max_brightness = MAX_USER_VALUE;\r\nprops.type = BACKLIGHT_RAW;\r\nbl = backlight_device_register(pdev->name, &pdev->dev,\r\nNULL, &pandora_backlight_ops, &props);\r\nif (IS_ERR(bl)) {\r\ndev_err(&pdev->dev, "failed to register backlight\n");\r\nreturn PTR_ERR(bl);\r\n}\r\nplatform_set_drvdata(pdev, bl);\r\ntwl_i2c_write_u8(TWL_MODULE_PWM, 0x80, TWL_PWM0_ON);\r\nbl->props.state |= PANDORABL_WAS_OFF;\r\nbl->props.brightness = MAX_USER_VALUE;\r\nbacklight_update_status(bl);\r\ntwl_i2c_read_u8(TWL4030_MODULE_INTBR, &r, TWL_INTBR_PMBR1);\r\nr &= ~TWL_PMBR1_PWM0_MUXMASK;\r\nr |= TWL_PMBR1_PWM0;\r\ntwl_i2c_write_u8(TWL4030_MODULE_INTBR, r, TWL_INTBR_PMBR1);\r\nreturn 0;\r\n}\r\nstatic int pandora_backlight_remove(struct platform_device *pdev)\r\n{\r\nstruct backlight_device *bl = platform_get_drvdata(pdev);\r\nbacklight_device_unregister(bl);\r\nreturn 0;\r\n}

static int\r\nohci_ppc_of_start(struct usb_hcd *hcd)\r\n{\r\nstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\r\nint ret;\r\nif ((ret = ohci_init(ohci)) < 0)\r\nreturn ret;\r\nif ((ret = ohci_run(ohci)) < 0) {\r\ndev_err(hcd->self.controller, "can't start %s\n",\r\nhcd->self.bus_name);\r\nohci_stop(hcd);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ohci_hcd_ppc_of_probe(struct platform_device *op)\r\n{\r\nstruct device_node *dn = op->dev.of_node;\r\nstruct usb_hcd *hcd;\r\nstruct ohci_hcd *ohci;\r\nstruct resource res;\r\nint irq;\r\nint rv;\r\nint is_bigendian;\r\nstruct device_node *np;\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\nis_bigendian =\r\nof_device_is_compatible(dn, "ohci-bigendian") ||\r\nof_device_is_compatible(dn, "ohci-be");\r\ndev_dbg(&op->dev, "initializing PPC-OF USB Controller\n");\r\nrv = of_address_to_resource(dn, 0, &res);\r\nif (rv)\r\nreturn rv;\r\nhcd = usb_create_hcd(&ohci_ppc_of_hc_driver, &op->dev, "PPC-OF USB");\r\nif (!hcd)\r\nreturn -ENOMEM;\r\nhcd->rsrc_start = res.start;\r\nhcd->rsrc_len = resource_size(&res);\r\nif (!request_mem_region(hcd->rsrc_start, hcd->rsrc_len, hcd_name)) {\r\nprintk(KERN_ERR "%s: request_mem_region failed\n", __FILE__);\r\nrv = -EBUSY;\r\ngoto err_rmr;\r\n}\r\nirq = irq_of_parse_and_map(dn, 0);\r\nif (irq == NO_IRQ) {\r\nprintk(KERN_ERR "%s: irq_of_parse_and_map failed\n", __FILE__);\r\nrv = -EBUSY;\r\ngoto err_irq;\r\n}\r\nhcd->regs = ioremap(hcd->rsrc_start, hcd->rsrc_len);\r\nif (!hcd->regs) {\r\nprintk(KERN_ERR "%s: ioremap failed\n", __FILE__);\r\nrv = -ENOMEM;\r\ngoto err_ioremap;\r\n}\r\nohci = hcd_to_ohci(hcd);\r\nif (is_bigendian) {\r\nohci->flags |= OHCI_QUIRK_BE_MMIO | OHCI_QUIRK_BE_DESC;\r\nif (of_device_is_compatible(dn, "fsl,mpc5200-ohci"))\r\nohci->flags |= OHCI_QUIRK_FRAME_NO;\r\nif (of_device_is_compatible(dn, "mpc5200-ohci"))\r\nohci->flags |= OHCI_QUIRK_FRAME_NO;\r\n}\r\nohci_hcd_init(ohci);\r\nrv = usb_add_hcd(hcd, irq, 0);\r\nif (rv == 0)\r\nreturn 0;\r\nnp = of_find_compatible_node(NULL, NULL, "ibm,usb-ehci-440epx");\r\nif (np != NULL) {\r\nif (!of_address_to_resource(np, 0, &res)) {\r\nif (!request_mem_region(res.start, 0x4, hcd_name)) {\r\nwritel_be((readl_be(&ohci->regs->control) |\r\nOHCI_USB_SUSPEND), &ohci->regs->control);\r\n(void) readl_be(&ohci->regs->control);\r\n} else\r\nrelease_mem_region(res.start, 0x4);\r\n} else\r\npr_debug("%s: cannot get ehci offset from fdt\n", __FILE__);\r\n}\r\niounmap(hcd->regs);\r\nerr_ioremap:\r\nirq_dispose_mapping(irq);\r\nerr_irq:\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nerr_rmr:\r\nusb_put_hcd(hcd);\r\nreturn rv;\r\n}\r\nstatic int ohci_hcd_ppc_of_remove(struct platform_device *op)\r\n{\r\nstruct usb_hcd *hcd = dev_get_drvdata(&op->dev);\r\ndev_set_drvdata(&op->dev, NULL);\r\ndev_dbg(&op->dev, "stopping PPC-OF USB Controller\n");\r\nusb_remove_hcd(hcd);\r\niounmap(hcd->regs);\r\nirq_dispose_mapping(hcd->irq);\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nusb_put_hcd(hcd);\r\nreturn 0;\r\n}\r\nstatic void ohci_hcd_ppc_of_shutdown(struct platform_device *op)\r\n{\r\nstruct usb_hcd *hcd = dev_get_drvdata(&op->dev);\r\nif (hcd->driver->shutdown)\r\nhcd->driver->shutdown(hcd);\r\n}

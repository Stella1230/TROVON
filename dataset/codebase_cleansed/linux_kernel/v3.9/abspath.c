static const char *get_pwd_cwd(void)\r\n{\r\nstatic char cwd[PATH_MAX + 1];\r\nchar *pwd;\r\nstruct stat cwd_stat, pwd_stat;\r\nif (getcwd(cwd, PATH_MAX) == NULL)\r\nreturn NULL;\r\npwd = getenv("PWD");\r\nif (pwd && strcmp(pwd, cwd)) {\r\nstat(cwd, &cwd_stat);\r\nif (!stat(pwd, &pwd_stat) &&\r\npwd_stat.st_dev == cwd_stat.st_dev &&\r\npwd_stat.st_ino == cwd_stat.st_ino) {\r\nstrlcpy(cwd, pwd, PATH_MAX);\r\n}\r\n}\r\nreturn cwd;\r\n}\r\nconst char *make_nonrelative_path(const char *path)\r\n{\r\nstatic char buf[PATH_MAX + 1];\r\nif (is_absolute_path(path)) {\r\nif (strlcpy(buf, path, PATH_MAX) >= PATH_MAX)\r\ndie("Too long path: %.*s", 60, path);\r\n} else {\r\nconst char *cwd = get_pwd_cwd();\r\nif (!cwd)\r\ndie("Cannot determine the current working directory");\r\nif (snprintf(buf, PATH_MAX, "%s/%s", cwd, path) >= PATH_MAX)\r\ndie("Too long path: %.*s", 60, path);\r\n}\r\nreturn buf;\r\n}

static int max8649_enable(struct regulator_dev *rdev)\r\n{\r\nstruct max8649_regulator_info *info = rdev_get_drvdata(rdev);\r\nreturn regmap_update_bits(info->regmap, MAX8649_CONTROL, MAX8649_EN_PD, 0);\r\n}\r\nstatic int max8649_disable(struct regulator_dev *rdev)\r\n{\r\nstruct max8649_regulator_info *info = rdev_get_drvdata(rdev);\r\nreturn regmap_update_bits(info->regmap, MAX8649_CONTROL, MAX8649_EN_PD,\r\nMAX8649_EN_PD);\r\n}\r\nstatic int max8649_is_enabled(struct regulator_dev *rdev)\r\n{\r\nstruct max8649_regulator_info *info = rdev_get_drvdata(rdev);\r\nunsigned int val;\r\nint ret;\r\nret = regmap_read(info->regmap, MAX8649_CONTROL, &val);\r\nif (ret != 0)\r\nreturn ret;\r\nreturn !((unsigned char)val & MAX8649_EN_PD);\r\n}\r\nstatic int max8649_enable_time(struct regulator_dev *rdev)\r\n{\r\nstruct max8649_regulator_info *info = rdev_get_drvdata(rdev);\r\nint voltage, rate, ret;\r\nunsigned int val;\r\nret = regmap_read(info->regmap, rdev->desc->vsel_reg, &val);\r\nif (ret != 0)\r\nreturn ret;\r\nval &= MAX8649_VOL_MASK;\r\nvoltage = regulator_list_voltage_linear(rdev, (unsigned char)val);\r\nret = regmap_read(info->regmap, MAX8649_RAMP, &val);\r\nif (ret != 0)\r\nreturn ret;\r\nret = (val & MAX8649_RAMP_MASK) >> 5;\r\nrate = (32 * 1000) >> ret;\r\nreturn DIV_ROUND_UP(voltage, rate);\r\n}\r\nstatic int max8649_set_mode(struct regulator_dev *rdev, unsigned int mode)\r\n{\r\nstruct max8649_regulator_info *info = rdev_get_drvdata(rdev);\r\nswitch (mode) {\r\ncase REGULATOR_MODE_FAST:\r\nregmap_update_bits(info->regmap, rdev->desc->vsel_reg,\r\nMAX8649_FORCE_PWM, MAX8649_FORCE_PWM);\r\nbreak;\r\ncase REGULATOR_MODE_NORMAL:\r\nregmap_update_bits(info->regmap, rdev->desc->vsel_reg,\r\nMAX8649_FORCE_PWM, 0);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic unsigned int max8649_get_mode(struct regulator_dev *rdev)\r\n{\r\nstruct max8649_regulator_info *info = rdev_get_drvdata(rdev);\r\nunsigned int val;\r\nint ret;\r\nret = regmap_read(info->regmap, rdev->desc->vsel_reg, &val);\r\nif (ret != 0)\r\nreturn ret;\r\nif (val & MAX8649_FORCE_PWM)\r\nreturn REGULATOR_MODE_FAST;\r\nreturn REGULATOR_MODE_NORMAL;\r\n}\r\nstatic int max8649_regulator_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct max8649_platform_data *pdata = client->dev.platform_data;\r\nstruct max8649_regulator_info *info = NULL;\r\nstruct regulator_config config = { };\r\nunsigned int val;\r\nunsigned char data;\r\nint ret;\r\ninfo = devm_kzalloc(&client->dev, sizeof(struct max8649_regulator_info),\r\nGFP_KERNEL);\r\nif (!info) {\r\ndev_err(&client->dev, "No enough memory\n");\r\nreturn -ENOMEM;\r\n}\r\ninfo->regmap = devm_regmap_init_i2c(client, &max8649_regmap_config);\r\nif (IS_ERR(info->regmap)) {\r\nret = PTR_ERR(info->regmap);\r\ndev_err(&client->dev, "Failed to allocate register map: %d\n", ret);\r\nreturn ret;\r\n}\r\ninfo->dev = &client->dev;\r\ni2c_set_clientdata(client, info);\r\ninfo->mode = pdata->mode;\r\nswitch (info->mode) {\r\ncase 0:\r\ndcdc_desc.vsel_reg = MAX8649_MODE0;\r\nbreak;\r\ncase 1:\r\ndcdc_desc.vsel_reg = MAX8649_MODE1;\r\nbreak;\r\ncase 2:\r\ndcdc_desc.vsel_reg = MAX8649_MODE2;\r\nbreak;\r\ncase 3:\r\ndcdc_desc.vsel_reg = MAX8649_MODE3;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nret = regmap_read(info->regmap, MAX8649_CHIP_ID1, &val);\r\nif (ret != 0) {\r\ndev_err(info->dev, "Failed to detect ID of MAX8649:%d\n",\r\nret);\r\nreturn ret;\r\n}\r\ndev_info(info->dev, "Detected MAX8649 (ID:%x)\n", val);\r\nregmap_update_bits(info->regmap, MAX8649_CONTROL, MAX8649_VID_MASK, 0);\r\ninfo->extclk = pdata->extclk;\r\ndata = (info->extclk) ? MAX8649_SYNC_EXTCLK : 0;\r\nregmap_update_bits(info->regmap, dcdc_desc.vsel_reg,\r\nMAX8649_SYNC_EXTCLK, data);\r\nif (info->extclk) {\r\ninfo->extclk_freq = pdata->extclk_freq;\r\nregmap_update_bits(info->regmap, MAX8649_SYNC, MAX8649_EXT_MASK,\r\ninfo->extclk_freq << 6);\r\n}\r\nif (pdata->ramp_timing) {\r\ninfo->ramp_timing = pdata->ramp_timing;\r\nregmap_update_bits(info->regmap, MAX8649_RAMP, MAX8649_RAMP_MASK,\r\ninfo->ramp_timing << 5);\r\n}\r\ninfo->ramp_down = pdata->ramp_down;\r\nif (info->ramp_down) {\r\nregmap_update_bits(info->regmap, MAX8649_RAMP, MAX8649_RAMP_DOWN,\r\nMAX8649_RAMP_DOWN);\r\n}\r\nconfig.dev = &client->dev;\r\nconfig.init_data = pdata->regulator;\r\nconfig.driver_data = info;\r\nconfig.regmap = info->regmap;\r\ninfo->regulator = regulator_register(&dcdc_desc, &config);\r\nif (IS_ERR(info->regulator)) {\r\ndev_err(info->dev, "failed to register regulator %s\n",\r\ndcdc_desc.name);\r\nreturn PTR_ERR(info->regulator);\r\n}\r\nreturn 0;\r\n}\r\nstatic int max8649_regulator_remove(struct i2c_client *client)\r\n{\r\nstruct max8649_regulator_info *info = i2c_get_clientdata(client);\r\nif (info) {\r\nif (info->regulator)\r\nregulator_unregister(info->regulator);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init max8649_init(void)\r\n{\r\nreturn i2c_add_driver(&max8649_driver);\r\n}\r\nstatic void __exit max8649_exit(void)\r\n{\r\ni2c_del_driver(&max8649_driver);\r\n}

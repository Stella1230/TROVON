static inline void ep93xx_pwm_writel(struct ep93xx_pwm *pwm,\r\nunsigned int val, unsigned int off)\r\n{\r\n__raw_writel(val, pwm->mmio_base + off);\r\n}\r\nstatic inline unsigned int ep93xx_pwm_readl(struct ep93xx_pwm *pwm,\r\nunsigned int off)\r\n{\r\nreturn __raw_readl(pwm->mmio_base + off);\r\n}\r\nstatic inline void ep93xx_pwm_write_tc(struct ep93xx_pwm *pwm, u16 value)\r\n{\r\nep93xx_pwm_writel(pwm, value, EP93XX_PWMx_TERM_COUNT);\r\n}\r\nstatic inline u16 ep93xx_pwm_read_tc(struct ep93xx_pwm *pwm)\r\n{\r\nreturn ep93xx_pwm_readl(pwm, EP93XX_PWMx_TERM_COUNT);\r\n}\r\nstatic inline void ep93xx_pwm_write_dc(struct ep93xx_pwm *pwm, u16 value)\r\n{\r\nep93xx_pwm_writel(pwm, value, EP93XX_PWMx_DUTY_CYCLE);\r\n}\r\nstatic inline void ep93xx_pwm_enable(struct ep93xx_pwm *pwm)\r\n{\r\nep93xx_pwm_writel(pwm, 0x1, EP93XX_PWMx_ENABLE);\r\n}\r\nstatic inline void ep93xx_pwm_disable(struct ep93xx_pwm *pwm)\r\n{\r\nep93xx_pwm_writel(pwm, 0x0, EP93XX_PWMx_ENABLE);\r\n}\r\nstatic inline int ep93xx_pwm_is_enabled(struct ep93xx_pwm *pwm)\r\n{\r\nreturn ep93xx_pwm_readl(pwm, EP93XX_PWMx_ENABLE) & 0x1;\r\n}\r\nstatic inline void ep93xx_pwm_invert(struct ep93xx_pwm *pwm)\r\n{\r\nep93xx_pwm_writel(pwm, 0x1, EP93XX_PWMx_INVERT);\r\n}\r\nstatic inline void ep93xx_pwm_normal(struct ep93xx_pwm *pwm)\r\n{\r\nep93xx_pwm_writel(pwm, 0x0, EP93XX_PWMx_INVERT);\r\n}\r\nstatic inline int ep93xx_pwm_is_inverted(struct ep93xx_pwm *pwm)\r\n{\r\nreturn ep93xx_pwm_readl(pwm, EP93XX_PWMx_INVERT) & 0x1;\r\n}\r\nstatic ssize_t ep93xx_pwm_get_min_freq(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct ep93xx_pwm *pwm = platform_get_drvdata(pdev);\r\nunsigned long rate = clk_get_rate(pwm->clk);\r\nreturn sprintf(buf, "%ld\n", rate / (EP93XX_PWM_MAX_COUNT + 1));\r\n}\r\nstatic ssize_t ep93xx_pwm_get_max_freq(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct ep93xx_pwm *pwm = platform_get_drvdata(pdev);\r\nunsigned long rate = clk_get_rate(pwm->clk);\r\nreturn sprintf(buf, "%ld\n", rate / 2);\r\n}\r\nstatic ssize_t ep93xx_pwm_get_freq(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct ep93xx_pwm *pwm = platform_get_drvdata(pdev);\r\nif (ep93xx_pwm_is_enabled(pwm)) {\r\nunsigned long rate = clk_get_rate(pwm->clk);\r\nu16 term = ep93xx_pwm_read_tc(pwm);\r\nreturn sprintf(buf, "%ld\n", rate / (term + 1));\r\n} else {\r\nreturn sprintf(buf, "disabled\n");\r\n}\r\n}\r\nstatic ssize_t ep93xx_pwm_set_freq(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct ep93xx_pwm *pwm = platform_get_drvdata(pdev);\r\nlong val;\r\nint err;\r\nerr = strict_strtol(buf, 10, &val);\r\nif (err)\r\nreturn -EINVAL;\r\nif (val == 0) {\r\nep93xx_pwm_disable(pwm);\r\n} else if (val <= (clk_get_rate(pwm->clk) / 2)) {\r\nu32 term, duty;\r\nval = (clk_get_rate(pwm->clk) / val) - 1;\r\nif (val > EP93XX_PWM_MAX_COUNT)\r\nval = EP93XX_PWM_MAX_COUNT;\r\nif (val < 1)\r\nval = 1;\r\nterm = ep93xx_pwm_read_tc(pwm);\r\nduty = ((val + 1) * pwm->duty_percent / 100) - 1;\r\nif (val > term) {\r\nep93xx_pwm_write_tc(pwm, val);\r\nep93xx_pwm_write_dc(pwm, duty);\r\n} else {\r\nep93xx_pwm_write_dc(pwm, duty);\r\nep93xx_pwm_write_tc(pwm, val);\r\n}\r\nif (!ep93xx_pwm_is_enabled(pwm))\r\nep93xx_pwm_enable(pwm);\r\n} else {\r\nreturn -EINVAL;\r\n}\r\nreturn count;\r\n}\r\nstatic ssize_t ep93xx_pwm_get_duty_percent(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct ep93xx_pwm *pwm = platform_get_drvdata(pdev);\r\nreturn sprintf(buf, "%d\n", pwm->duty_percent);\r\n}\r\nstatic ssize_t ep93xx_pwm_set_duty_percent(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct ep93xx_pwm *pwm = platform_get_drvdata(pdev);\r\nlong val;\r\nint err;\r\nerr = strict_strtol(buf, 10, &val);\r\nif (err)\r\nreturn -EINVAL;\r\nif (val > 0 && val < 100) {\r\nu32 term = ep93xx_pwm_read_tc(pwm);\r\nep93xx_pwm_write_dc(pwm, ((term + 1) * val / 100) - 1);\r\npwm->duty_percent = val;\r\nreturn count;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic ssize_t ep93xx_pwm_get_invert(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct ep93xx_pwm *pwm = platform_get_drvdata(pdev);\r\nreturn sprintf(buf, "%d\n", ep93xx_pwm_is_inverted(pwm));\r\n}\r\nstatic ssize_t ep93xx_pwm_set_invert(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct ep93xx_pwm *pwm = platform_get_drvdata(pdev);\r\nlong val;\r\nint err;\r\nerr = strict_strtol(buf, 10, &val);\r\nif (err)\r\nreturn -EINVAL;\r\nif (val == 0)\r\nep93xx_pwm_normal(pwm);\r\nelse if (val == 1)\r\nep93xx_pwm_invert(pwm);\r\nelse\r\nreturn -EINVAL;\r\nreturn count;\r\n}\r\nstatic int __init ep93xx_pwm_probe(struct platform_device *pdev)\r\n{\r\nstruct ep93xx_pwm *pwm;\r\nstruct resource *res;\r\nint err;\r\nerr = ep93xx_pwm_acquire_gpio(pdev);\r\nif (err)\r\nreturn err;\r\npwm = kzalloc(sizeof(struct ep93xx_pwm), GFP_KERNEL);\r\nif (!pwm) {\r\nerr = -ENOMEM;\r\ngoto fail_no_mem;\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (res == NULL) {\r\nerr = -ENXIO;\r\ngoto fail_no_mem_resource;\r\n}\r\nres = request_mem_region(res->start, resource_size(res), pdev->name);\r\nif (res == NULL) {\r\nerr = -EBUSY;\r\ngoto fail_no_mem_resource;\r\n}\r\npwm->mmio_base = ioremap(res->start, resource_size(res));\r\nif (pwm->mmio_base == NULL) {\r\nerr = -ENXIO;\r\ngoto fail_no_ioremap;\r\n}\r\nerr = sysfs_create_group(&pdev->dev.kobj, &ep93xx_pwm_sysfs_files);\r\nif (err)\r\ngoto fail_no_sysfs;\r\npwm->clk = clk_get(&pdev->dev, "pwm_clk");\r\nif (IS_ERR(pwm->clk)) {\r\nerr = PTR_ERR(pwm->clk);\r\ngoto fail_no_clk;\r\n}\r\npwm->duty_percent = 50;\r\nplatform_set_drvdata(pdev, pwm);\r\nep93xx_pwm_disable(pwm);\r\nep93xx_pwm_write_tc(pwm, EP93XX_PWM_MAX_COUNT);\r\nep93xx_pwm_write_dc(pwm, EP93XX_PWM_MAX_COUNT / 2);\r\nclk_enable(pwm->clk);\r\nreturn 0;\r\nfail_no_clk:\r\nsysfs_remove_group(&pdev->dev.kobj, &ep93xx_pwm_sysfs_files);\r\nfail_no_sysfs:\r\niounmap(pwm->mmio_base);\r\nfail_no_ioremap:\r\nrelease_mem_region(res->start, resource_size(res));\r\nfail_no_mem_resource:\r\nkfree(pwm);\r\nfail_no_mem:\r\nep93xx_pwm_release_gpio(pdev);\r\nreturn err;\r\n}\r\nstatic int __exit ep93xx_pwm_remove(struct platform_device *pdev)\r\n{\r\nstruct ep93xx_pwm *pwm = platform_get_drvdata(pdev);\r\nstruct resource *res = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nep93xx_pwm_disable(pwm);\r\nclk_disable(pwm->clk);\r\nclk_put(pwm->clk);\r\nplatform_set_drvdata(pdev, NULL);\r\nsysfs_remove_group(&pdev->dev.kobj, &ep93xx_pwm_sysfs_files);\r\niounmap(pwm->mmio_base);\r\nrelease_mem_region(res->start, resource_size(res));\r\nkfree(pwm);\r\nep93xx_pwm_release_gpio(pdev);\r\nreturn 0;\r\n}\r\nstatic int __init ep93xx_pwm_init(void)\r\n{\r\nreturn platform_driver_probe(&ep93xx_pwm_driver, ep93xx_pwm_probe);\r\n}\r\nstatic void __exit ep93xx_pwm_exit(void)\r\n{\r\nplatform_driver_unregister(&ep93xx_pwm_driver);\r\n}

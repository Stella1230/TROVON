static int hdmi_panel_probe(struct omap_dss_device *dssdev)\r\n{\r\nconst struct omap_video_timings default_timings = {\r\n.x_res = 640,\r\n.y_res = 480,\r\n.pixel_clock = 25175,\r\n.hsw = 96,\r\n.hfp = 16,\r\n.hbp = 48,\r\n.vsw = 2,\r\n.vfp = 11,\r\n.vbp = 31,\r\n.vsync_level = OMAPDSS_SIG_ACTIVE_LOW,\r\n.hsync_level = OMAPDSS_SIG_ACTIVE_LOW,\r\n.interlace = false,\r\n};\r\nDSSDBG("ENTER hdmi_panel_probe\n");\r\ndssdev->panel.timings = default_timings;\r\nDSSDBG("hdmi_panel_probe x_res= %d y_res = %d\n",\r\ndssdev->panel.timings.x_res,\r\ndssdev->panel.timings.y_res);\r\nomapdss_hdmi_display_set_timing(dssdev, &dssdev->panel.timings);\r\nreturn 0;\r\n}\r\nstatic void hdmi_panel_remove(struct omap_dss_device *dssdev)\r\n{\r\n}\r\nstatic int hdmi_panel_audio_enable(struct omap_dss_device *dssdev)\r\n{\r\nunsigned long flags;\r\nint r;\r\nmutex_lock(&hdmi.lock);\r\nspin_lock_irqsave(&hdmi.audio_lock, flags);\r\nif (dssdev->state != OMAP_DSS_DISPLAY_ACTIVE ||\r\n!hdmi_mode_has_audio()) {\r\nDSSERR("audio not supported or display is off\n");\r\nr = -EPERM;\r\ngoto err;\r\n}\r\nr = hdmi_audio_enable();\r\nif (!r)\r\ndssdev->audio_state = OMAP_DSS_AUDIO_ENABLED;\r\nerr:\r\nspin_unlock_irqrestore(&hdmi.audio_lock, flags);\r\nmutex_unlock(&hdmi.lock);\r\nreturn r;\r\n}\r\nstatic void hdmi_panel_audio_disable(struct omap_dss_device *dssdev)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&hdmi.audio_lock, flags);\r\nhdmi_audio_disable();\r\ndssdev->audio_state = OMAP_DSS_AUDIO_DISABLED;\r\nspin_unlock_irqrestore(&hdmi.audio_lock, flags);\r\n}\r\nstatic int hdmi_panel_audio_start(struct omap_dss_device *dssdev)\r\n{\r\nunsigned long flags;\r\nint r;\r\nspin_lock_irqsave(&hdmi.audio_lock, flags);\r\nif (dssdev->audio_state != OMAP_DSS_AUDIO_ENABLED) {\r\nDSSERR("audio start from invalid state\n");\r\nr = -EPERM;\r\ngoto err;\r\n}\r\nr = hdmi_audio_start();\r\nif (!r)\r\ndssdev->audio_state = OMAP_DSS_AUDIO_PLAYING;\r\nerr:\r\nspin_unlock_irqrestore(&hdmi.audio_lock, flags);\r\nreturn r;\r\n}\r\nstatic void hdmi_panel_audio_stop(struct omap_dss_device *dssdev)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&hdmi.audio_lock, flags);\r\nhdmi_audio_stop();\r\ndssdev->audio_state = OMAP_DSS_AUDIO_ENABLED;\r\nspin_unlock_irqrestore(&hdmi.audio_lock, flags);\r\n}\r\nstatic bool hdmi_panel_audio_supported(struct omap_dss_device *dssdev)\r\n{\r\nbool r = false;\r\nmutex_lock(&hdmi.lock);\r\nif (dssdev->state != OMAP_DSS_DISPLAY_ACTIVE)\r\ngoto err;\r\nif (!hdmi_mode_has_audio())\r\ngoto err;\r\nr = true;\r\nerr:\r\nmutex_unlock(&hdmi.lock);\r\nreturn r;\r\n}\r\nstatic int hdmi_panel_audio_config(struct omap_dss_device *dssdev,\r\nstruct omap_dss_audio *audio)\r\n{\r\nunsigned long flags;\r\nint r;\r\nmutex_lock(&hdmi.lock);\r\nspin_lock_irqsave(&hdmi.audio_lock, flags);\r\nif (dssdev->state != OMAP_DSS_DISPLAY_ACTIVE ||\r\n!hdmi_mode_has_audio()) {\r\nDSSERR("audio not supported or display is off\n");\r\nr = -EPERM;\r\ngoto err;\r\n}\r\nr = hdmi_audio_config(audio);\r\nif (!r)\r\ndssdev->audio_state = OMAP_DSS_AUDIO_CONFIGURED;\r\nerr:\r\nspin_unlock_irqrestore(&hdmi.audio_lock, flags);\r\nmutex_unlock(&hdmi.lock);\r\nreturn r;\r\n}\r\nstatic int hdmi_panel_audio_enable(struct omap_dss_device *dssdev)\r\n{\r\nreturn -EPERM;\r\n}\r\nstatic void hdmi_panel_audio_disable(struct omap_dss_device *dssdev)\r\n{\r\n}\r\nstatic int hdmi_panel_audio_start(struct omap_dss_device *dssdev)\r\n{\r\nreturn -EPERM;\r\n}\r\nstatic void hdmi_panel_audio_stop(struct omap_dss_device *dssdev)\r\n{\r\n}\r\nstatic bool hdmi_panel_audio_supported(struct omap_dss_device *dssdev)\r\n{\r\nreturn false;\r\n}\r\nstatic int hdmi_panel_audio_config(struct omap_dss_device *dssdev,\r\nstruct omap_dss_audio *audio)\r\n{\r\nreturn -EPERM;\r\n}\r\nstatic int hdmi_panel_enable(struct omap_dss_device *dssdev)\r\n{\r\nint r = 0;\r\nDSSDBG("ENTER hdmi_panel_enable\n");\r\nmutex_lock(&hdmi.lock);\r\nif (dssdev->state != OMAP_DSS_DISPLAY_DISABLED) {\r\nr = -EINVAL;\r\ngoto err;\r\n}\r\nomapdss_hdmi_display_set_timing(dssdev, &dssdev->panel.timings);\r\nr = omapdss_hdmi_display_enable(dssdev);\r\nif (r) {\r\nDSSERR("failed to power on\n");\r\ngoto err;\r\n}\r\ndssdev->state = OMAP_DSS_DISPLAY_ACTIVE;\r\nerr:\r\nmutex_unlock(&hdmi.lock);\r\nreturn r;\r\n}\r\nstatic void hdmi_panel_disable(struct omap_dss_device *dssdev)\r\n{\r\nmutex_lock(&hdmi.lock);\r\nif (dssdev->state == OMAP_DSS_DISPLAY_ACTIVE) {\r\nhdmi_panel_audio_disable(dssdev);\r\nomapdss_hdmi_display_disable(dssdev);\r\n}\r\ndssdev->state = OMAP_DSS_DISPLAY_DISABLED;\r\nmutex_unlock(&hdmi.lock);\r\n}\r\nstatic void hdmi_get_timings(struct omap_dss_device *dssdev,\r\nstruct omap_video_timings *timings)\r\n{\r\nmutex_lock(&hdmi.lock);\r\n*timings = dssdev->panel.timings;\r\nmutex_unlock(&hdmi.lock);\r\n}\r\nstatic void hdmi_set_timings(struct omap_dss_device *dssdev,\r\nstruct omap_video_timings *timings)\r\n{\r\nDSSDBG("hdmi_set_timings\n");\r\nmutex_lock(&hdmi.lock);\r\nhdmi_panel_audio_disable(dssdev);\r\nomapdss_hdmi_display_set_timing(dssdev, timings);\r\ndssdev->panel.timings = *timings;\r\nmutex_unlock(&hdmi.lock);\r\n}\r\nstatic int hdmi_check_timings(struct omap_dss_device *dssdev,\r\nstruct omap_video_timings *timings)\r\n{\r\nint r = 0;\r\nDSSDBG("hdmi_check_timings\n");\r\nmutex_lock(&hdmi.lock);\r\nr = omapdss_hdmi_display_check_timing(dssdev, timings);\r\nmutex_unlock(&hdmi.lock);\r\nreturn r;\r\n}\r\nstatic int hdmi_read_edid(struct omap_dss_device *dssdev, u8 *buf, int len)\r\n{\r\nint r;\r\nbool need_enable;\r\nmutex_lock(&hdmi.lock);\r\nneed_enable = dssdev->state == OMAP_DSS_DISPLAY_DISABLED;\r\nif (need_enable) {\r\nr = omapdss_hdmi_core_enable(dssdev);\r\nif (r)\r\ngoto err;\r\n}\r\nr = omapdss_hdmi_read_edid(buf, len);\r\nif (need_enable)\r\nomapdss_hdmi_core_disable(dssdev);\r\nerr:\r\nmutex_unlock(&hdmi.lock);\r\nreturn r;\r\n}\r\nstatic bool hdmi_detect(struct omap_dss_device *dssdev)\r\n{\r\nint r;\r\nbool need_enable;\r\nmutex_lock(&hdmi.lock);\r\nneed_enable = dssdev->state == OMAP_DSS_DISPLAY_DISABLED;\r\nif (need_enable) {\r\nr = omapdss_hdmi_core_enable(dssdev);\r\nif (r)\r\ngoto err;\r\n}\r\nr = omapdss_hdmi_detect();\r\nif (need_enable)\r\nomapdss_hdmi_core_disable(dssdev);\r\nerr:\r\nmutex_unlock(&hdmi.lock);\r\nreturn r;\r\n}\r\nint hdmi_panel_init(void)\r\n{\r\nmutex_init(&hdmi.lock);\r\n#if defined(CONFIG_OMAP4_DSS_HDMI_AUDIO)\r\nspin_lock_init(&hdmi.audio_lock);\r\n#endif\r\nreturn omap_dss_register_driver(&hdmi_driver);\r\n}\r\nvoid hdmi_panel_exit(void)\r\n{\r\nomap_dss_unregister_driver(&hdmi_driver);\r\n}

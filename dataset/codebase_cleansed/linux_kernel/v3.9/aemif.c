static int aemif_calc_rate(int wanted, unsigned long clk, int max)\r\n{\r\nint result;\r\nresult = DIV_ROUND_UP((wanted * clk), NSEC_PER_MSEC) - 1;\r\npr_debug("%s: result %d from %ld, %d\n", __func__, result, clk, wanted);\r\nif (result < 0)\r\nresult = 0;\r\nelse if (result > max)\r\nresult = -EINVAL;\r\nreturn result;\r\n}\r\nint davinci_aemif_setup_timing(struct davinci_aemif_timing *t,\r\nvoid __iomem *base, unsigned cs)\r\n{\r\nunsigned set, val;\r\nint ta, rhold, rstrobe, rsetup, whold, wstrobe, wsetup;\r\nunsigned offset = A1CR_OFFSET + cs * 4;\r\nstruct clk *aemif_clk;\r\nunsigned long clkrate;\r\nif (!t)\r\nreturn 0;\r\naemif_clk = clk_get(NULL, "aemif");\r\nif (IS_ERR(aemif_clk))\r\nreturn PTR_ERR(aemif_clk);\r\nclkrate = clk_get_rate(aemif_clk);\r\nclkrate /= 1000;\r\nta = aemif_calc_rate(t->ta, clkrate, TA_MAX);\r\nrhold = aemif_calc_rate(t->rhold, clkrate, RHOLD_MAX);\r\nrstrobe = aemif_calc_rate(t->rstrobe, clkrate, RSTROBE_MAX);\r\nrsetup = aemif_calc_rate(t->rsetup, clkrate, RSETUP_MAX);\r\nwhold = aemif_calc_rate(t->whold, clkrate, WHOLD_MAX);\r\nwstrobe = aemif_calc_rate(t->wstrobe, clkrate, WSTROBE_MAX);\r\nwsetup = aemif_calc_rate(t->wsetup, clkrate, WSETUP_MAX);\r\nif (ta < 0 || rhold < 0 || rstrobe < 0 || rsetup < 0 ||\r\nwhold < 0 || wstrobe < 0 || wsetup < 0) {\r\npr_err("%s: cannot get suitable timings\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nset = TA(ta) | RHOLD(rhold) | RSTROBE(rstrobe) | RSETUP(rsetup) |\r\nWHOLD(whold) | WSTROBE(wstrobe) | WSETUP(wsetup);\r\nval = __raw_readl(base + offset);\r\nval &= ~TIMING_MASK;\r\nval |= set;\r\n__raw_writel(val, base + offset);\r\nreturn 0;\r\n}

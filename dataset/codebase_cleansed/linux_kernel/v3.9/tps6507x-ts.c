static int tps6507x_read_u8(struct tps6507x_ts *tsc, u8 reg, u8 *data)\r\n{\r\nint err;\r\nerr = tsc->mfd->read_dev(tsc->mfd, reg, 1, data);\r\nif (err)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int tps6507x_write_u8(struct tps6507x_ts *tsc, u8 reg, u8 data)\r\n{\r\nreturn tsc->mfd->write_dev(tsc->mfd, reg, 1, &data);\r\n}\r\nstatic s32 tps6507x_adc_conversion(struct tps6507x_ts *tsc,\r\nu8 tsc_mode, u16 *value)\r\n{\r\ns32 ret;\r\nu8 adc_status;\r\nu8 result;\r\nret = tps6507x_write_u8(tsc, TPS6507X_REG_TSCMODE, tsc_mode);\r\nif (ret) {\r\ndev_err(tsc->dev, "TSC mode read failed\n");\r\ngoto err;\r\n}\r\nret = tps6507x_write_u8(tsc, TPS6507X_REG_ADCONFIG,\r\nTPS6507X_ADCONFIG_CONVERT_TS);\r\nif (ret) {\r\ndev_err(tsc->dev, "ADC config write failed\n");\r\nreturn ret;\r\n}\r\ndo {\r\nret = tps6507x_read_u8(tsc, TPS6507X_REG_ADCONFIG,\r\n&adc_status);\r\nif (ret) {\r\ndev_err(tsc->dev, "ADC config read failed\n");\r\ngoto err;\r\n}\r\n} while (adc_status & TPS6507X_ADCONFIG_START_CONVERSION);\r\nret = tps6507x_read_u8(tsc, TPS6507X_REG_ADRESULT_2, &result);\r\nif (ret) {\r\ndev_err(tsc->dev, "ADC result 2 read failed\n");\r\ngoto err;\r\n}\r\n*value = (result & TPS6507X_REG_ADRESULT_2_MASK) << 8;\r\nret = tps6507x_read_u8(tsc, TPS6507X_REG_ADRESULT_1, &result);\r\nif (ret) {\r\ndev_err(tsc->dev, "ADC result 1 read failed\n");\r\ngoto err;\r\n}\r\n*value |= result;\r\ndev_dbg(tsc->dev, "TSC channel %d = 0x%X\n", tsc_mode, *value);\r\nerr:\r\nreturn ret;\r\n}\r\nstatic s32 tps6507x_adc_standby(struct tps6507x_ts *tsc)\r\n{\r\ns32 ret;\r\ns32 loops = 0;\r\nu8 val;\r\nret = tps6507x_write_u8(tsc, TPS6507X_REG_ADCONFIG,\r\nTPS6507X_ADCONFIG_INPUT_TSC);\r\nif (ret)\r\nreturn ret;\r\nret = tps6507x_write_u8(tsc, TPS6507X_REG_TSCMODE,\r\nTPS6507X_TSCMODE_STANDBY);\r\nif (ret)\r\nreturn ret;\r\nret = tps6507x_read_u8(tsc, TPS6507X_REG_INT, &val);\r\nif (ret)\r\nreturn ret;\r\nwhile (val & TPS6507X_REG_TSC_INT) {\r\nmdelay(10);\r\nret = tps6507x_read_u8(tsc, TPS6507X_REG_INT, &val);\r\nif (ret)\r\nreturn ret;\r\nloops++;\r\n}\r\nreturn ret;\r\n}\r\nstatic void tps6507x_ts_handler(struct work_struct *work)\r\n{\r\nstruct tps6507x_ts *tsc = container_of(work,\r\nstruct tps6507x_ts, work.work);\r\nstruct input_dev *input_dev = tsc->input_dev;\r\nint pendown;\r\nint schd;\r\nint poll = 0;\r\ns32 ret;\r\nret = tps6507x_adc_conversion(tsc, TPS6507X_TSCMODE_PRESSURE,\r\n&tsc->tc.pressure);\r\nif (ret)\r\ngoto done;\r\npendown = tsc->tc.pressure > tsc->min_pressure;\r\nif (unlikely(!pendown && tsc->pendown)) {\r\ndev_dbg(tsc->dev, "UP\n");\r\ninput_report_key(input_dev, BTN_TOUCH, 0);\r\ninput_report_abs(input_dev, ABS_PRESSURE, 0);\r\ninput_sync(input_dev);\r\ntsc->pendown = 0;\r\n}\r\nif (pendown) {\r\nif (!tsc->pendown) {\r\ndev_dbg(tsc->dev, "DOWN\n");\r\ninput_report_key(input_dev, BTN_TOUCH, 1);\r\n} else\r\ndev_dbg(tsc->dev, "still down\n");\r\nret = tps6507x_adc_conversion(tsc, TPS6507X_TSCMODE_X_POSITION,\r\n&tsc->tc.x);\r\nif (ret)\r\ngoto done;\r\nret = tps6507x_adc_conversion(tsc, TPS6507X_TSCMODE_Y_POSITION,\r\n&tsc->tc.y);\r\nif (ret)\r\ngoto done;\r\ninput_report_abs(input_dev, ABS_X, tsc->tc.x);\r\ninput_report_abs(input_dev, ABS_Y, tsc->tc.y);\r\ninput_report_abs(input_dev, ABS_PRESSURE, tsc->tc.pressure);\r\ninput_sync(input_dev);\r\ntsc->pendown = 1;\r\npoll = 1;\r\n}\r\ndone:\r\npoll = 1;\r\nif (poll) {\r\nschd = schedule_delayed_work(&tsc->work,\r\nmsecs_to_jiffies(tsc->poll_period));\r\nif (schd)\r\ntsc->polling = 1;\r\nelse {\r\ntsc->polling = 0;\r\ndev_err(tsc->dev, "re-schedule failed");\r\n}\r\n} else\r\ntsc->polling = 0;\r\nret = tps6507x_adc_standby(tsc);\r\n}\r\nstatic int tps6507x_ts_probe(struct platform_device *pdev)\r\n{\r\nint error;\r\nstruct tps6507x_ts *tsc;\r\nstruct tps6507x_dev *tps6507x_dev = dev_get_drvdata(pdev->dev.parent);\r\nstruct touchscreen_init_data *init_data;\r\nstruct input_dev *input_dev;\r\nstruct tps6507x_board *tps_board;\r\nint schd;\r\ntps_board = (struct tps6507x_board *)tps6507x_dev->dev->platform_data;\r\nif (!tps_board) {\r\ndev_err(tps6507x_dev->dev,\r\n"Could not find tps6507x platform data\n");\r\nreturn -EIO;\r\n}\r\ninit_data = tps_board->tps6507x_ts_init_data;\r\ntsc = kzalloc(sizeof(struct tps6507x_ts), GFP_KERNEL);\r\nif (!tsc) {\r\ndev_err(tps6507x_dev->dev, "failed to allocate driver data\n");\r\nerror = -ENOMEM;\r\ngoto err0;\r\n}\r\ntps6507x_dev->ts = tsc;\r\ntsc->mfd = tps6507x_dev;\r\ntsc->dev = tps6507x_dev->dev;\r\ninput_dev = input_allocate_device();\r\nif (!input_dev) {\r\ndev_err(tsc->dev, "Failed to allocate input device.\n");\r\nerror = -ENOMEM;\r\ngoto err1;\r\n}\r\ninput_dev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_ABS);\r\ninput_dev->keybit[BIT_WORD(BTN_TOUCH)] = BIT_MASK(BTN_TOUCH);\r\ninput_set_abs_params(input_dev, ABS_X, 0, MAX_10BIT, 0, 0);\r\ninput_set_abs_params(input_dev, ABS_Y, 0, MAX_10BIT, 0, 0);\r\ninput_set_abs_params(input_dev, ABS_PRESSURE, 0, MAX_10BIT, 0, 0);\r\ninput_dev->name = "TPS6507x Touchscreen";\r\ninput_dev->id.bustype = BUS_I2C;\r\ninput_dev->dev.parent = tsc->dev;\r\nsnprintf(tsc->phys, sizeof(tsc->phys),\r\n"%s/input0", dev_name(tsc->dev));\r\ninput_dev->phys = tsc->phys;\r\ndev_dbg(tsc->dev, "device: %s\n", input_dev->phys);\r\ninput_set_drvdata(input_dev, tsc);\r\ntsc->input_dev = input_dev;\r\nINIT_DELAYED_WORK(&tsc->work, tps6507x_ts_handler);\r\nif (init_data) {\r\ntsc->poll_period = init_data->poll_period;\r\ntsc->vref = init_data->vref;\r\ntsc->min_pressure = init_data->min_pressure;\r\ninput_dev->id.vendor = init_data->vendor;\r\ninput_dev->id.product = init_data->product;\r\ninput_dev->id.version = init_data->version;\r\n} else {\r\ntsc->poll_period = TSC_DEFAULT_POLL_PERIOD;\r\ntsc->min_pressure = TPS_DEFAULT_MIN_PRESSURE;\r\n}\r\nerror = tps6507x_adc_standby(tsc);\r\nif (error)\r\ngoto err2;\r\nerror = input_register_device(input_dev);\r\nif (error)\r\ngoto err2;\r\nschd = schedule_delayed_work(&tsc->work,\r\nmsecs_to_jiffies(tsc->poll_period));\r\nif (schd)\r\ntsc->polling = 1;\r\nelse {\r\ntsc->polling = 0;\r\ndev_err(tsc->dev, "schedule failed");\r\ngoto err2;\r\n}\r\nplatform_set_drvdata(pdev, tps6507x_dev);\r\nreturn 0;\r\nerr2:\r\ncancel_delayed_work_sync(&tsc->work);\r\ninput_free_device(input_dev);\r\nerr1:\r\nkfree(tsc);\r\ntps6507x_dev->ts = NULL;\r\nerr0:\r\nreturn error;\r\n}\r\nstatic int tps6507x_ts_remove(struct platform_device *pdev)\r\n{\r\nstruct tps6507x_dev *tps6507x_dev = platform_get_drvdata(pdev);\r\nstruct tps6507x_ts *tsc = tps6507x_dev->ts;\r\nstruct input_dev *input_dev = tsc->input_dev;\r\ncancel_delayed_work_sync(&tsc->work);\r\ninput_unregister_device(input_dev);\r\ntps6507x_dev->ts = NULL;\r\nkfree(tsc);\r\nreturn 0;\r\n}

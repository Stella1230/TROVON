static int microtune_release(struct dvb_frontend *fe)\r\n{\r\nkfree(fe->tuner_priv);\r\nfe->tuner_priv = NULL;\r\nreturn 0;\r\n}\r\nstatic int microtune_get_frequency(struct dvb_frontend *fe, u32 *frequency)\r\n{\r\nstruct microtune_priv *priv = fe->tuner_priv;\r\n*frequency = priv->frequency;\r\nreturn 0;\r\n}\r\nstatic int mt2032_spurcheck(struct dvb_frontend *fe,\r\nint f1, int f2, int spectrum_from,int spectrum_to)\r\n{\r\nstruct microtune_priv *priv = fe->tuner_priv;\r\nint n1=1,n2,f;\r\nf1=f1/1000;\r\nf2=f2/1000;\r\nspectrum_from/=1000;\r\nspectrum_to/=1000;\r\ntuner_dbg("spurcheck f1=%d f2=%d from=%d to=%d\n",\r\nf1,f2,spectrum_from,spectrum_to);\r\ndo {\r\nn2=-n1;\r\nf=n1*(f1-f2);\r\ndo {\r\nn2--;\r\nf=f-f2;\r\ntuner_dbg("spurtest n1=%d n2=%d ftest=%d\n",n1,n2,f);\r\nif( (f>spectrum_from) && (f<spectrum_to))\r\ntuner_dbg("mt2032 spurcheck triggered: %d\n",n1);\r\n} while ( (f>(f2-spectrum_to)) || (n2>-5));\r\nn1++;\r\n} while (n1<5);\r\nreturn 1;\r\n}\r\nstatic int mt2032_compute_freq(struct dvb_frontend *fe,\r\nunsigned int rfin,\r\nunsigned int if1, unsigned int if2,\r\nunsigned int spectrum_from,\r\nunsigned int spectrum_to,\r\nunsigned char *buf,\r\nint *ret_sel,\r\nunsigned int xogc)\r\n{\r\nstruct microtune_priv *priv = fe->tuner_priv;\r\nunsigned int fref,lo1,lo1n,lo1a,s,sel,lo1freq, desired_lo1,\r\ndesired_lo2,lo2,lo2n,lo2a,lo2num,lo2freq;\r\nfref= 5250 *1000;\r\ndesired_lo1=rfin+if1;\r\nlo1=(2*(desired_lo1/1000)+(fref/1000)) / (2*fref/1000);\r\nlo1n=lo1/8;\r\nlo1a=lo1-(lo1n*8);\r\ns=rfin/1000/1000+1090;\r\nif(optimize_vco) {\r\nif(s>1890) sel=0;\r\nelse if(s>1720) sel=1;\r\nelse if(s>1530) sel=2;\r\nelse if(s>1370) sel=3;\r\nelse sel=4;\r\n}\r\nelse {\r\nif(s>1790) sel=0;\r\nelse if(s>1617) sel=1;\r\nelse if(s>1449) sel=2;\r\nelse if(s>1291) sel=3;\r\nelse sel=4;\r\n}\r\n*ret_sel=sel;\r\nlo1freq=(lo1a+8*lo1n)*fref;\r\ntuner_dbg("mt2032: rfin=%d lo1=%d lo1n=%d lo1a=%d sel=%d, lo1freq=%d\n",\r\nrfin,lo1,lo1n,lo1a,sel,lo1freq);\r\ndesired_lo2=lo1freq-rfin-if2;\r\nlo2=(desired_lo2)/fref;\r\nlo2n=lo2/8;\r\nlo2a=lo2-(lo2n*8);\r\nlo2num=((desired_lo2/1000)%(fref/1000))* 3780/(fref/1000);\r\nlo2freq=(lo2a+8*lo2n)*fref + lo2num*(fref/1000)/3780*1000;\r\ntuner_dbg("mt2032: rfin=%d lo2=%d lo2n=%d lo2a=%d num=%d lo2freq=%d\n",\r\nrfin,lo2,lo2n,lo2a,lo2num,lo2freq);\r\nif (lo1a > 7 || lo1n < 17 || lo1n > 48 || lo2a > 7 || lo2n < 17 ||\r\nlo2n > 30) {\r\ntuner_info("mt2032: frequency parameters out of range: %d %d %d %d\n",\r\nlo1a, lo1n, lo2a,lo2n);\r\nreturn(-1);\r\n}\r\nmt2032_spurcheck(fe, lo1freq, desired_lo2, spectrum_from, spectrum_to);\r\nbuf[0]=lo1n-1;\r\nbuf[1]=lo1a | (sel<<4);\r\nbuf[2]=0x86;\r\nbuf[3]=0x0f;\r\nbuf[4]=0x1f;\r\nbuf[5]=(lo2n-1) | (lo2a<<5);\r\nif(rfin >400*1000*1000)\r\nbuf[6]=0xe4;\r\nelse\r\nbuf[6]=0xf4;\r\nbuf[7]=8+xogc;\r\nbuf[8]=0xc3;\r\nbuf[9]=0x4e;\r\nbuf[10]=0xec;\r\nbuf[11]=(lo2num&0xff);\r\nbuf[12]=(lo2num>>8) |0x80;\r\nreturn 0;\r\n}\r\nstatic int mt2032_check_lo_lock(struct dvb_frontend *fe)\r\n{\r\nstruct microtune_priv *priv = fe->tuner_priv;\r\nint try,lock=0;\r\nunsigned char buf[2];\r\nfor(try=0;try<10;try++) {\r\nbuf[0]=0x0e;\r\ntuner_i2c_xfer_send(&priv->i2c_props,buf,1);\r\ntuner_i2c_xfer_recv(&priv->i2c_props,buf,1);\r\ntuner_dbg("mt2032 Reg.E=0x%02x\n",buf[0]);\r\nlock=buf[0] &0x06;\r\nif (lock==6)\r\nbreak;\r\ntuner_dbg("mt2032: pll wait 1ms for lock (0x%2x)\n",buf[0]);\r\nudelay(1000);\r\n}\r\nreturn lock;\r\n}\r\nstatic int mt2032_optimize_vco(struct dvb_frontend *fe,int sel,int lock)\r\n{\r\nstruct microtune_priv *priv = fe->tuner_priv;\r\nunsigned char buf[2];\r\nint tad1;\r\nbuf[0]=0x0f;\r\ntuner_i2c_xfer_send(&priv->i2c_props,buf,1);\r\ntuner_i2c_xfer_recv(&priv->i2c_props,buf,1);\r\ntuner_dbg("mt2032 Reg.F=0x%02x\n",buf[0]);\r\ntad1=buf[0]&0x07;\r\nif(tad1 ==0) return lock;\r\nif(tad1 ==1) return lock;\r\nif(tad1==2) {\r\nif(sel==0)\r\nreturn lock;\r\nelse sel--;\r\n}\r\nelse {\r\nif(sel<4)\r\nsel++;\r\nelse\r\nreturn lock;\r\n}\r\ntuner_dbg("mt2032 optimize_vco: sel=%d\n",sel);\r\nbuf[0]=0x0f;\r\nbuf[1]=sel;\r\ntuner_i2c_xfer_send(&priv->i2c_props,buf,2);\r\nlock=mt2032_check_lo_lock(fe);\r\nreturn lock;\r\n}\r\nstatic void mt2032_set_if_freq(struct dvb_frontend *fe, unsigned int rfin,\r\nunsigned int if1, unsigned int if2,\r\nunsigned int from, unsigned int to)\r\n{\r\nunsigned char buf[21];\r\nint lint_try,ret,sel,lock=0;\r\nstruct microtune_priv *priv = fe->tuner_priv;\r\ntuner_dbg("mt2032_set_if_freq rfin=%d if1=%d if2=%d from=%d to=%d\n",\r\nrfin,if1,if2,from,to);\r\nbuf[0]=0;\r\nret=tuner_i2c_xfer_send(&priv->i2c_props,buf,1);\r\ntuner_i2c_xfer_recv(&priv->i2c_props,buf,21);\r\nbuf[0]=0;\r\nret=mt2032_compute_freq(fe,rfin,if1,if2,from,to,&buf[1],&sel,priv->xogc);\r\nif (ret<0)\r\nreturn;\r\nbuf[0]=0;\r\nret=tuner_i2c_xfer_send(&priv->i2c_props,buf,4);\r\nbuf[5]=5;\r\nret=tuner_i2c_xfer_send(&priv->i2c_props,buf+5,4);\r\nbuf[11]=11;\r\nret=tuner_i2c_xfer_send(&priv->i2c_props,buf+11,3);\r\nif(ret!=3)\r\ntuner_warn("i2c i/o error: rc == %d (should be 3)\n",ret);\r\nfor(lint_try=0; lint_try<2; lint_try++) {\r\nlock=mt2032_check_lo_lock(fe);\r\nif(optimize_vco)\r\nlock=mt2032_optimize_vco(fe,sel,lock);\r\nif(lock==6) break;\r\ntuner_dbg("mt2032: re-init PLLs by LINT\n");\r\nbuf[0]=7;\r\nbuf[1]=0x80 +8+priv->xogc;\r\ntuner_i2c_xfer_send(&priv->i2c_props,buf,2);\r\nmdelay(10);\r\nbuf[1]=8+priv->xogc;\r\ntuner_i2c_xfer_send(&priv->i2c_props,buf,2);\r\n}\r\nif (lock!=6)\r\ntuner_warn("MT2032 Fatal Error: PLLs didn't lock.\n");\r\nbuf[0]=2;\r\nbuf[1]=0x20;\r\nret=tuner_i2c_xfer_send(&priv->i2c_props,buf,2);\r\nif (ret!=2)\r\ntuner_warn("i2c i/o error: rc == %d (should be 2)\n",ret);\r\n}\r\nstatic int mt2032_set_tv_freq(struct dvb_frontend *fe,\r\nstruct analog_parameters *params)\r\n{\r\nint if2,from,to;\r\nif (params->std & V4L2_STD_525_60) {\r\nfrom = 40750*1000;\r\nto = 46750*1000;\r\nif2 = 45750*1000;\r\n} else {\r\nfrom = 32900*1000;\r\nto = 39900*1000;\r\nif2 = 38900*1000;\r\n}\r\nmt2032_set_if_freq(fe, params->frequency*62500,\r\n1090*1000*1000, if2, from, to);\r\nreturn 0;\r\n}\r\nstatic int mt2032_set_radio_freq(struct dvb_frontend *fe,\r\nstruct analog_parameters *params)\r\n{\r\nstruct microtune_priv *priv = fe->tuner_priv;\r\nint if2;\r\nif (params->std & V4L2_STD_525_60) {\r\ntuner_dbg("pinnacle ntsc\n");\r\nif2 = 41300 * 1000;\r\n} else {\r\ntuner_dbg("pinnacle pal\n");\r\nif2 = 33300 * 1000;\r\n}\r\nmt2032_set_if_freq(fe, params->frequency * 125 / 2,\r\n1085*1000*1000,if2,if2,if2);\r\nreturn 0;\r\n}\r\nstatic int mt2032_set_params(struct dvb_frontend *fe,\r\nstruct analog_parameters *params)\r\n{\r\nstruct microtune_priv *priv = fe->tuner_priv;\r\nint ret = -EINVAL;\r\nswitch (params->mode) {\r\ncase V4L2_TUNER_RADIO:\r\nret = mt2032_set_radio_freq(fe, params);\r\npriv->frequency = params->frequency * 125 / 2;\r\nbreak;\r\ncase V4L2_TUNER_ANALOG_TV:\r\ncase V4L2_TUNER_DIGITAL_TV:\r\nret = mt2032_set_tv_freq(fe, params);\r\npriv->frequency = params->frequency * 62500;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int mt2032_init(struct dvb_frontend *fe)\r\n{\r\nstruct microtune_priv *priv = fe->tuner_priv;\r\nunsigned char buf[21];\r\nint ret,xogc,xok=0;\r\nbuf[1]=2;\r\nbuf[2]=0xff;\r\nbuf[3]=0x0f;\r\nbuf[4]=0x1f;\r\nret=tuner_i2c_xfer_send(&priv->i2c_props,buf+1,4);\r\nbuf[5]=6;\r\nbuf[6]=0xe4;\r\nbuf[7]=0x8f;\r\nbuf[8]=0xc3;\r\nbuf[9]=0x4e;\r\nbuf[10]=0xec;\r\nret=tuner_i2c_xfer_send(&priv->i2c_props,buf+5,6);\r\nbuf[12]=13;\r\nbuf[13]=0x32;\r\nret=tuner_i2c_xfer_send(&priv->i2c_props,buf+12,2);\r\nxogc=7;\r\ndo {\r\ntuner_dbg("mt2032: xogc = 0x%02x\n",xogc&0x07);\r\nmdelay(10);\r\nbuf[0]=0x0e;\r\ntuner_i2c_xfer_send(&priv->i2c_props,buf,1);\r\ntuner_i2c_xfer_recv(&priv->i2c_props,buf,1);\r\nxok=buf[0]&0x01;\r\ntuner_dbg("mt2032: xok = 0x%02x\n",xok);\r\nif (xok == 1) break;\r\nxogc--;\r\ntuner_dbg("mt2032: xogc = 0x%02x\n",xogc&0x07);\r\nif (xogc == 3) {\r\nxogc=4;\r\nbreak;\r\n}\r\nbuf[0]=0x07;\r\nbuf[1]=0x88 + xogc;\r\nret=tuner_i2c_xfer_send(&priv->i2c_props,buf,2);\r\nif (ret!=2)\r\ntuner_warn("i2c i/o error: rc == %d (should be 2)\n",ret);\r\n} while (xok != 1 );\r\npriv->xogc=xogc;\r\nmemcpy(&fe->ops.tuner_ops, &mt2032_tuner_ops, sizeof(struct dvb_tuner_ops));\r\nreturn(1);\r\n}\r\nstatic void mt2050_set_antenna(struct dvb_frontend *fe, unsigned char antenna)\r\n{\r\nstruct microtune_priv *priv = fe->tuner_priv;\r\nunsigned char buf[2];\r\nbuf[0] = 6;\r\nbuf[1] = antenna ? 0x11 : 0x10;\r\ntuner_i2c_xfer_send(&priv->i2c_props, buf, 2);\r\ntuner_dbg("mt2050: enabled antenna connector %d\n", antenna);\r\n}\r\nstatic void mt2050_set_if_freq(struct dvb_frontend *fe,unsigned int freq, unsigned int if2)\r\n{\r\nstruct microtune_priv *priv = fe->tuner_priv;\r\nunsigned int if1=1218*1000*1000;\r\nunsigned int f_lo1,f_lo2,lo1,lo2,f_lo1_modulo,f_lo2_modulo,num1,num2,div1a,div1b,div2a,div2b;\r\nint ret;\r\nunsigned char buf[6];\r\ntuner_dbg("mt2050_set_if_freq freq=%d if1=%d if2=%d\n",\r\nfreq,if1,if2);\r\nf_lo1=freq+if1;\r\nf_lo1=(f_lo1/1000000)*1000000;\r\nf_lo2=f_lo1-freq-if2;\r\nf_lo2=(f_lo2/50000)*50000;\r\nlo1=f_lo1/4000000;\r\nlo2=f_lo2/4000000;\r\nf_lo1_modulo= f_lo1-(lo1*4000000);\r\nf_lo2_modulo= f_lo2-(lo2*4000000);\r\nnum1=4*f_lo1_modulo/4000000;\r\nnum2=4096*(f_lo2_modulo/1000)/4000;\r\ndiv1a=(lo1/12)-1;\r\ndiv1b=lo1-(div1a+1)*12;\r\ndiv2a=(lo2/8)-1;\r\ndiv2b=lo2-(div2a+1)*8;\r\nif (debug > 1) {\r\ntuner_dbg("lo1 lo2 = %d %d\n", lo1, lo2);\r\ntuner_dbg("num1 num2 div1a div1b div2a div2b= %x %x %x %x %x %x\n",\r\nnum1,num2,div1a,div1b,div2a,div2b);\r\n}\r\nbuf[0]=1;\r\nbuf[1]= 4*div1b + num1;\r\nif(freq<275*1000*1000) buf[1] = buf[1]|0x80;\r\nbuf[2]=div1a;\r\nbuf[3]=32*div2b + num2/256;\r\nbuf[4]=num2-(num2/256)*256;\r\nbuf[5]=div2a;\r\nif(num2!=0) buf[5]=buf[5]|0x40;\r\nif (debug > 1) {\r\nint i;\r\ntuner_dbg("bufs is: ");\r\nfor(i=0;i<6;i++)\r\nprintk("%x ",buf[i]);\r\nprintk("\n");\r\n}\r\nret=tuner_i2c_xfer_send(&priv->i2c_props,buf,6);\r\nif (ret!=6)\r\ntuner_warn("i2c i/o error: rc == %d (should be 6)\n",ret);\r\n}\r\nstatic int mt2050_set_tv_freq(struct dvb_frontend *fe,\r\nstruct analog_parameters *params)\r\n{\r\nunsigned int if2;\r\nif (params->std & V4L2_STD_525_60) {\r\nif2 = 45750*1000;\r\n} else {\r\nif2 = 38900*1000;\r\n}\r\nif (V4L2_TUNER_DIGITAL_TV == params->mode) {\r\nif2 = 36150*1000;\r\n}\r\nmt2050_set_if_freq(fe, params->frequency*62500, if2);\r\nmt2050_set_antenna(fe, tv_antenna);\r\nreturn 0;\r\n}\r\nstatic int mt2050_set_radio_freq(struct dvb_frontend *fe,\r\nstruct analog_parameters *params)\r\n{\r\nstruct microtune_priv *priv = fe->tuner_priv;\r\nint if2;\r\nif (params->std & V4L2_STD_525_60) {\r\ntuner_dbg("pinnacle ntsc\n");\r\nif2 = 41300 * 1000;\r\n} else {\r\ntuner_dbg("pinnacle pal\n");\r\nif2 = 33300 * 1000;\r\n}\r\nmt2050_set_if_freq(fe, params->frequency * 125 / 2, if2);\r\nmt2050_set_antenna(fe, radio_antenna);\r\nreturn 0;\r\n}\r\nstatic int mt2050_set_params(struct dvb_frontend *fe,\r\nstruct analog_parameters *params)\r\n{\r\nstruct microtune_priv *priv = fe->tuner_priv;\r\nint ret = -EINVAL;\r\nswitch (params->mode) {\r\ncase V4L2_TUNER_RADIO:\r\nret = mt2050_set_radio_freq(fe, params);\r\npriv->frequency = params->frequency * 125 / 2;\r\nbreak;\r\ncase V4L2_TUNER_ANALOG_TV:\r\ncase V4L2_TUNER_DIGITAL_TV:\r\nret = mt2050_set_tv_freq(fe, params);\r\npriv->frequency = params->frequency * 62500;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int mt2050_init(struct dvb_frontend *fe)\r\n{\r\nstruct microtune_priv *priv = fe->tuner_priv;\r\nunsigned char buf[2];\r\nbuf[0] = 6;\r\nbuf[1] = 0x10;\r\ntuner_i2c_xfer_send(&priv->i2c_props, buf, 2);\r\nbuf[0] = 0x0f;\r\nbuf[1] = 0x0f;\r\ntuner_i2c_xfer_send(&priv->i2c_props, buf, 2);\r\nbuf[0] = 0x0d;\r\ntuner_i2c_xfer_send(&priv->i2c_props, buf, 1);\r\ntuner_i2c_xfer_recv(&priv->i2c_props, buf, 1);\r\ntuner_dbg("mt2050: sro is %x\n", buf[0]);\r\nmemcpy(&fe->ops.tuner_ops, &mt2050_tuner_ops, sizeof(struct dvb_tuner_ops));\r\nreturn 0;\r\n}\r\nstruct dvb_frontend *microtune_attach(struct dvb_frontend *fe,\r\nstruct i2c_adapter* i2c_adap,\r\nu8 i2c_addr)\r\n{\r\nstruct microtune_priv *priv = NULL;\r\nchar *name;\r\nunsigned char buf[21];\r\nint company_code;\r\npriv = kzalloc(sizeof(struct microtune_priv), GFP_KERNEL);\r\nif (priv == NULL)\r\nreturn NULL;\r\nfe->tuner_priv = priv;\r\npriv->i2c_props.addr = i2c_addr;\r\npriv->i2c_props.adap = i2c_adap;\r\npriv->i2c_props.name = "mt20xx";\r\nmemset(buf,0,sizeof(buf));\r\nname = "unknown";\r\ntuner_i2c_xfer_send(&priv->i2c_props,buf,1);\r\ntuner_i2c_xfer_recv(&priv->i2c_props,buf,21);\r\nif (debug) {\r\nint i;\r\ntuner_dbg("MT20xx hexdump:");\r\nfor(i=0;i<21;i++) {\r\nprintk(" %02x",buf[i]);\r\nif(((i+1)%8)==0) printk(" ");\r\n}\r\nprintk("\n");\r\n}\r\ncompany_code = buf[0x11] << 8 | buf[0x12];\r\ntuner_info("microtune: companycode=%04x part=%02x rev=%02x\n",\r\ncompany_code,buf[0x13],buf[0x14]);\r\nif (buf[0x13] < ARRAY_SIZE(microtune_part) &&\r\nNULL != microtune_part[buf[0x13]])\r\nname = microtune_part[buf[0x13]];\r\nswitch (buf[0x13]) {\r\ncase MT2032:\r\nmt2032_init(fe);\r\nbreak;\r\ncase MT2050:\r\nmt2050_init(fe);\r\nbreak;\r\ndefault:\r\ntuner_info("microtune %s found, not (yet?) supported, sorry :-/\n",\r\nname);\r\nreturn NULL;\r\n}\r\nstrlcpy(fe->ops.tuner_ops.info.name, name,\r\nsizeof(fe->ops.tuner_ops.info.name));\r\ntuner_info("microtune %s found, OK\n",name);\r\nreturn fe;\r\n}

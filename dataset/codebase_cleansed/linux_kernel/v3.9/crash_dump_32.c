static inline bool is_crashed_pfn_valid(unsigned long pfn)\r\n{\r\n#ifndef CONFIG_X86_PAE\r\nreturn pte_pfn(pfn_pte(pfn, __pgprot(0))) == pfn;\r\n#else\r\nreturn true;\r\n#endif\r\n}\r\nssize_t copy_oldmem_page(unsigned long pfn, char *buf,\r\nsize_t csize, unsigned long offset, int userbuf)\r\n{\r\nvoid *vaddr;\r\nif (!csize)\r\nreturn 0;\r\nif (!is_crashed_pfn_valid(pfn))\r\nreturn -EFAULT;\r\nvaddr = kmap_atomic_pfn(pfn);\r\nif (!userbuf) {\r\nmemcpy(buf, (vaddr + offset), csize);\r\nkunmap_atomic(vaddr);\r\n} else {\r\nif (!kdump_buf_page) {\r\nprintk(KERN_WARNING "Kdump: Kdump buffer page not"\r\n" allocated\n");\r\nkunmap_atomic(vaddr);\r\nreturn -EFAULT;\r\n}\r\ncopy_page(kdump_buf_page, vaddr);\r\nkunmap_atomic(vaddr);\r\nif (copy_to_user(buf, (kdump_buf_page + offset), csize))\r\nreturn -EFAULT;\r\n}\r\nreturn csize;\r\n}\r\nstatic int __init kdump_buf_page_init(void)\r\n{\r\nint ret = 0;\r\nkdump_buf_page = kmalloc(PAGE_SIZE, GFP_KERNEL);\r\nif (!kdump_buf_page) {\r\nprintk(KERN_WARNING "Kdump: Failed to allocate kdump buffer"\r\n" page\n");\r\nret = -ENOMEM;\r\n}\r\nreturn ret;\r\n}

static int au1xtoy_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nunsigned long t;\r\nt = au_readl(SYS_TOYREAD);\r\nrtc_time_to_tm(t, tm);\r\nreturn rtc_valid_tm(tm);\r\n}\r\nstatic int au1xtoy_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nunsigned long t;\r\nrtc_tm_to_time(tm, &t);\r\nau_writel(t, SYS_TOYWRITE);\r\nau_sync();\r\nwhile (au_readl(SYS_COUNTER_CNTRL) & SYS_CNTRL_C0S)\r\nmsleep(1);\r\nreturn 0;\r\n}\r\nstatic int au1xtoy_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct rtc_device *rtcdev;\r\nunsigned long t;\r\nint ret;\r\nt = au_readl(SYS_COUNTER_CNTRL);\r\nif (!(t & CNTR_OK)) {\r\ndev_err(&pdev->dev, "counters not working; aborting.\n");\r\nret = -ENODEV;\r\ngoto out_err;\r\n}\r\nret = -ETIMEDOUT;\r\nif (au_readl(SYS_TOYTRIM) != 32767) {\r\nt = 0x00100000;\r\nwhile ((au_readl(SYS_COUNTER_CNTRL) & SYS_CNTRL_T0S) && --t)\r\nmsleep(1);\r\nif (!t) {\r\ndev_err(&pdev->dev, "timeout waiting for access\n");\r\ngoto out_err;\r\n}\r\nau_writel(32767, SYS_TOYTRIM);\r\nau_sync();\r\n}\r\nwhile (au_readl(SYS_COUNTER_CNTRL) & SYS_CNTRL_C0S)\r\nmsleep(1);\r\nrtcdev = rtc_device_register("rtc-au1xxx", &pdev->dev,\r\n&au1xtoy_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtcdev)) {\r\nret = PTR_ERR(rtcdev);\r\ngoto out_err;\r\n}\r\nplatform_set_drvdata(pdev, rtcdev);\r\nreturn 0;\r\nout_err:\r\nreturn ret;\r\n}\r\nstatic int au1xtoy_rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct rtc_device *rtcdev = platform_get_drvdata(pdev);\r\nrtc_device_unregister(rtcdev);\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn 0;\r\n}\r\nstatic int __init au1xtoy_rtc_init(void)\r\n{\r\nreturn platform_driver_probe(&au1xrtc_driver, au1xtoy_rtc_probe);\r\n}\r\nstatic void __exit au1xtoy_rtc_exit(void)\r\n{\r\nplatform_driver_unregister(&au1xrtc_driver);\r\n}

static int proc_self_readlink(struct dentry *dentry, char __user *buffer,\r\nint buflen)\r\n{\r\nstruct pid_namespace *ns = dentry->d_sb->s_fs_info;\r\npid_t tgid = task_tgid_nr_ns(current, ns);\r\nchar tmp[PROC_NUMBUF];\r\nif (!tgid)\r\nreturn -ENOENT;\r\nsprintf(tmp, "%d", tgid);\r\nreturn vfs_readlink(dentry,buffer,buflen,tmp);\r\n}\r\nstatic void *proc_self_follow_link(struct dentry *dentry, struct nameidata *nd)\r\n{\r\nstruct pid_namespace *ns = dentry->d_sb->s_fs_info;\r\npid_t tgid = task_tgid_nr_ns(current, ns);\r\nchar *name = ERR_PTR(-ENOENT);\r\nif (tgid) {\r\nname = kmalloc(12, GFP_KERNEL);\r\nif (!name)\r\nname = ERR_PTR(-ENOMEM);\r\nelse\r\nsprintf(name, "%d", tgid);\r\n}\r\nnd_set_link(nd, name);\r\nreturn NULL;\r\n}\r\nstatic void proc_self_put_link(struct dentry *dentry, struct nameidata *nd,\r\nvoid *cookie)\r\n{\r\nchar *s = nd_get_link(nd);\r\nif (!IS_ERR(s))\r\nkfree(s);\r\n}\r\nvoid __init proc_self_init(void)\r\n{\r\nstruct proc_dir_entry *proc_self_symlink;\r\nmode_t mode;\r\nmode = S_IFLNK | S_IRWXUGO;\r\nproc_self_symlink = proc_create("self", mode, NULL, NULL );\r\nproc_self_symlink->proc_iops = &proc_self_inode_operations;\r\n}

static inline struct f_gether *func_to_geth(struct usb_function *f)\r\n{\r\nreturn container_of(f, struct f_gether, port.func);\r\n}\r\nstatic int geth_set_alt(struct usb_function *f, unsigned intf, unsigned alt)\r\n{\r\nstruct f_gether *geth = func_to_geth(f);\r\nstruct usb_composite_dev *cdev = f->config->cdev;\r\nstruct net_device *net;\r\nif (geth->port.in_ep->driver_data) {\r\nDBG(cdev, "reset cdc subset\n");\r\ngether_disconnect(&geth->port);\r\n}\r\nDBG(cdev, "init + activate cdc subset\n");\r\nif (config_ep_by_speed(cdev->gadget, f, geth->port.in_ep) ||\r\nconfig_ep_by_speed(cdev->gadget, f, geth->port.out_ep)) {\r\ngeth->port.in_ep->desc = NULL;\r\ngeth->port.out_ep->desc = NULL;\r\nreturn -EINVAL;\r\n}\r\nnet = gether_connect(&geth->port);\r\nreturn IS_ERR(net) ? PTR_ERR(net) : 0;\r\n}\r\nstatic void geth_disable(struct usb_function *f)\r\n{\r\nstruct f_gether *geth = func_to_geth(f);\r\nstruct usb_composite_dev *cdev = f->config->cdev;\r\nDBG(cdev, "net deactivated\n");\r\ngether_disconnect(&geth->port);\r\n}\r\nstatic int\r\ngeth_bind(struct usb_configuration *c, struct usb_function *f)\r\n{\r\nstruct usb_composite_dev *cdev = c->cdev;\r\nstruct f_gether *geth = func_to_geth(f);\r\nint status;\r\nstruct usb_ep *ep;\r\nstatus = usb_interface_id(c, f);\r\nif (status < 0)\r\ngoto fail;\r\nsubset_data_intf.bInterfaceNumber = status;\r\nstatus = -ENODEV;\r\nep = usb_ep_autoconfig(cdev->gadget, &fs_subset_in_desc);\r\nif (!ep)\r\ngoto fail;\r\ngeth->port.in_ep = ep;\r\nep->driver_data = cdev;\r\nep = usb_ep_autoconfig(cdev->gadget, &fs_subset_out_desc);\r\nif (!ep)\r\ngoto fail;\r\ngeth->port.out_ep = ep;\r\nep->driver_data = cdev;\r\nhs_subset_in_desc.bEndpointAddress = fs_subset_in_desc.bEndpointAddress;\r\nhs_subset_out_desc.bEndpointAddress =\r\nfs_subset_out_desc.bEndpointAddress;\r\nss_subset_in_desc.bEndpointAddress = fs_subset_in_desc.bEndpointAddress;\r\nss_subset_out_desc.bEndpointAddress =\r\nfs_subset_out_desc.bEndpointAddress;\r\nstatus = usb_assign_descriptors(f, fs_eth_function, hs_eth_function,\r\nss_eth_function);\r\nif (status)\r\ngoto fail;\r\nDBG(cdev, "CDC Subset: %s speed IN/%s OUT/%s\n",\r\ngadget_is_superspeed(c->cdev->gadget) ? "super" :\r\ngadget_is_dualspeed(c->cdev->gadget) ? "dual" : "full",\r\ngeth->port.in_ep->name, geth->port.out_ep->name);\r\nreturn 0;\r\nfail:\r\nusb_free_all_descriptors(f);\r\nif (geth->port.out_ep)\r\ngeth->port.out_ep->driver_data = NULL;\r\nif (geth->port.in_ep)\r\ngeth->port.in_ep->driver_data = NULL;\r\nERROR(cdev, "%s: can't bind, err %d\n", f->name, status);\r\nreturn status;\r\n}\r\nstatic void\r\ngeth_unbind(struct usb_configuration *c, struct usb_function *f)\r\n{\r\ngeth_string_defs[0].id = 0;\r\nusb_free_all_descriptors(f);\r\nkfree(func_to_geth(f));\r\n}\r\nint geth_bind_config(struct usb_configuration *c, u8 ethaddr[ETH_ALEN])\r\n{\r\nstruct f_gether *geth;\r\nint status;\r\nif (!ethaddr)\r\nreturn -EINVAL;\r\nif (geth_string_defs[0].id == 0) {\r\nstatus = usb_string_ids_tab(c->cdev, geth_string_defs);\r\nif (status < 0)\r\nreturn status;\r\nsubset_data_intf.iInterface = geth_string_defs[0].id;\r\nether_desc.iMACAddress = geth_string_defs[1].id;\r\n}\r\ngeth = kzalloc(sizeof *geth, GFP_KERNEL);\r\nif (!geth)\r\nreturn -ENOMEM;\r\nsnprintf(geth->ethaddr, sizeof geth->ethaddr, "%pm", ethaddr);\r\ngeth_string_defs[1].s = geth->ethaddr;\r\ngeth->port.cdc_filter = DEFAULT_FILTER;\r\ngeth->port.func.name = "cdc_subset";\r\ngeth->port.func.strings = geth_strings;\r\ngeth->port.func.bind = geth_bind;\r\ngeth->port.func.unbind = geth_unbind;\r\ngeth->port.func.set_alt = geth_set_alt;\r\ngeth->port.func.disable = geth_disable;\r\nstatus = usb_add_function(c, &geth->port.func);\r\nif (status)\r\nkfree(geth);\r\nreturn status;\r\n}

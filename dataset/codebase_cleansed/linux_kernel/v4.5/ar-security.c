static struct rxrpc_security *rxrpc_security_get(struct rxrpc_security *sec)\r\n{\r\nreturn try_module_get(sec->owner) ? sec : NULL;\r\n}\r\nstatic void rxrpc_security_put(struct rxrpc_security *sec)\r\n{\r\nmodule_put(sec->owner);\r\n}\r\nstatic struct rxrpc_security *rxrpc_security_lookup(u8 security_index)\r\n{\r\nstruct rxrpc_security *sec = NULL;\r\n_enter("");\r\ndown_read(&rxrpc_security_sem);\r\nlist_for_each_entry(sec, &rxrpc_security_methods, link) {\r\nif (sec->security_index == security_index) {\r\nif (unlikely(!rxrpc_security_get(sec)))\r\nbreak;\r\ngoto out;\r\n}\r\n}\r\nsec = NULL;\r\nout:\r\nup_read(&rxrpc_security_sem);\r\n_leave(" = %p [%s]", sec, sec ? sec->name : "");\r\nreturn sec;\r\n}\r\nint rxrpc_register_security(struct rxrpc_security *sec)\r\n{\r\nstruct rxrpc_security *psec;\r\nint ret;\r\n_enter("");\r\ndown_write(&rxrpc_security_sem);\r\nret = -EEXIST;\r\nlist_for_each_entry(psec, &rxrpc_security_methods, link) {\r\nif (psec->security_index == sec->security_index)\r\ngoto out;\r\n}\r\nlist_add(&sec->link, &rxrpc_security_methods);\r\nprintk(KERN_NOTICE "RxRPC: Registered security type %d '%s'\n",\r\nsec->security_index, sec->name);\r\nret = 0;\r\nout:\r\nup_write(&rxrpc_security_sem);\r\n_leave(" = %d", ret);\r\nreturn ret;\r\n}\r\nvoid rxrpc_unregister_security(struct rxrpc_security *sec)\r\n{\r\n_enter("");\r\ndown_write(&rxrpc_security_sem);\r\nlist_del_init(&sec->link);\r\nup_write(&rxrpc_security_sem);\r\nprintk(KERN_NOTICE "RxRPC: Unregistered security type %d '%s'\n",\r\nsec->security_index, sec->name);\r\n}\r\nint rxrpc_init_client_conn_security(struct rxrpc_connection *conn)\r\n{\r\nstruct rxrpc_key_token *token;\r\nstruct rxrpc_security *sec;\r\nstruct key *key = conn->key;\r\nint ret;\r\n_enter("{%d},{%x}", conn->debug_id, key_serial(key));\r\nif (!key)\r\nreturn 0;\r\nret = key_validate(key);\r\nif (ret < 0)\r\nreturn ret;\r\ntoken = key->payload.data[0];\r\nif (!token)\r\nreturn -EKEYREJECTED;\r\nsec = rxrpc_security_lookup(token->security_index);\r\nif (!sec)\r\nreturn -EKEYREJECTED;\r\nconn->security = sec;\r\nret = conn->security->init_connection_security(conn);\r\nif (ret < 0) {\r\nrxrpc_security_put(conn->security);\r\nconn->security = NULL;\r\nreturn ret;\r\n}\r\n_leave(" = 0");\r\nreturn 0;\r\n}\r\nint rxrpc_init_server_conn_security(struct rxrpc_connection *conn)\r\n{\r\nstruct rxrpc_security *sec;\r\nstruct rxrpc_local *local = conn->trans->local;\r\nstruct rxrpc_sock *rx;\r\nstruct key *key;\r\nkey_ref_t kref;\r\nchar kdesc[5+1+3+1];\r\n_enter("");\r\nsprintf(kdesc, "%u:%u", ntohs(conn->service_id), conn->security_ix);\r\nsec = rxrpc_security_lookup(conn->security_ix);\r\nif (!sec) {\r\n_leave(" = -ENOKEY [lookup]");\r\nreturn -ENOKEY;\r\n}\r\nread_lock_bh(&local->services_lock);\r\nlist_for_each_entry(rx, &local->services, listen_link) {\r\nif (rx->service_id == conn->service_id)\r\ngoto found_service;\r\n}\r\nread_unlock_bh(&local->services_lock);\r\nrxrpc_security_put(sec);\r\n_leave(" = -ENOENT");\r\nreturn -ENOENT;\r\nfound_service:\r\nif (!rx->securities) {\r\nread_unlock_bh(&local->services_lock);\r\nrxrpc_security_put(sec);\r\n_leave(" = -ENOKEY");\r\nreturn -ENOKEY;\r\n}\r\nkref = keyring_search(make_key_ref(rx->securities, 1UL),\r\n&key_type_rxrpc_s, kdesc);\r\nif (IS_ERR(kref)) {\r\nread_unlock_bh(&local->services_lock);\r\nrxrpc_security_put(sec);\r\n_leave(" = %ld [search]", PTR_ERR(kref));\r\nreturn PTR_ERR(kref);\r\n}\r\nkey = key_ref_to_ptr(kref);\r\nread_unlock_bh(&local->services_lock);\r\nconn->server_key = key;\r\nconn->security = sec;\r\n_leave(" = 0");\r\nreturn 0;\r\n}\r\nint rxrpc_secure_packet(const struct rxrpc_call *call,\r\nstruct sk_buff *skb,\r\nsize_t data_size,\r\nvoid *sechdr)\r\n{\r\nif (call->conn->security)\r\nreturn call->conn->security->secure_packet(\r\ncall, skb, data_size, sechdr);\r\nreturn 0;\r\n}\r\nint rxrpc_verify_packet(const struct rxrpc_call *call, struct sk_buff *skb,\r\nu32 *_abort_code)\r\n{\r\nif (call->conn->security)\r\nreturn call->conn->security->verify_packet(\r\ncall, skb, _abort_code);\r\nreturn 0;\r\n}\r\nvoid rxrpc_clear_conn_security(struct rxrpc_connection *conn)\r\n{\r\n_enter("{%d}", conn->debug_id);\r\nif (conn->security) {\r\nconn->security->clear(conn);\r\nrxrpc_security_put(conn->security);\r\nconn->security = NULL;\r\n}\r\nkey_put(conn->key);\r\nkey_put(conn->server_key);\r\n}

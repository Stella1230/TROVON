static void nsp_message_in(struct scsi_cmnd *SCpnt)\r\n{\r\nunsigned int base = SCpnt->device->host->io_port;\r\nnsp_hw_data *data = (nsp_hw_data *)SCpnt->device->host->hostdata;\r\nunsigned char data_reg, control_reg;\r\nint ret, len;\r\nret = 16;\r\nlen = 0;\r\nnsp_dbg(NSP_DEBUG_MSGINOCCUR, "msgin loop");\r\ndo {\r\ndata_reg = nsp_index_read(base, SCSIDATAIN);\r\ncontrol_reg = nsp_index_read(base, SCSIBUSCTRL);\r\ncontrol_reg |= SCSI_ACK;\r\nnsp_index_write(base, SCSIBUSCTRL, control_reg);\r\nnsp_negate_signal(SCpnt, BUSMON_REQ, "msgin<REQ>");\r\ndata->MsgBuffer[len] = data_reg; len++;\r\ncontrol_reg = nsp_index_read(base, SCSIBUSCTRL);\r\ncontrol_reg &= ~SCSI_ACK;\r\nnsp_index_write(base, SCSIBUSCTRL, control_reg);\r\nret = nsp_expect_signal(SCpnt, BUSPHASE_MESSAGE_IN, BUSMON_REQ);\r\n} while (ret > 0 && MSGBUF_SIZE > len);\r\ndata->MsgLen = len;\r\n}\r\nstatic void nsp_message_out(struct scsi_cmnd *SCpnt)\r\n{\r\nnsp_hw_data *data = (nsp_hw_data *)SCpnt->device->host->hostdata;\r\nint ret = 1;\r\nint len = data->MsgLen;\r\nnsp_dbg(NSP_DEBUG_MSGOUTOCCUR, "msgout loop");\r\ndo {\r\nif (nsp_xfer(SCpnt, BUSPHASE_MESSAGE_OUT)) {\r\nnsp_msg(KERN_DEBUG, "msgout: xfer short");\r\n}\r\nret = nsp_expect_signal(SCpnt, BUSPHASE_MESSAGE_OUT, BUSMON_REQ);\r\n} while (ret > 0 && len-- > 0);\r\n}

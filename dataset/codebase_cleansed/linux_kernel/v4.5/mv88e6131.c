static char *mv88e6131_probe(struct device *host_dev, int sw_addr)\r\n{\r\nreturn mv88e6xxx_lookup_name(host_dev, sw_addr, mv88e6131_table,\r\nARRAY_SIZE(mv88e6131_table));\r\n}\r\nstatic int mv88e6131_setup_global(struct dsa_switch *ds)\r\n{\r\nu32 upstream_port = dsa_upstream_port(ds);\r\nint ret;\r\nu32 reg;\r\nret = mv88e6xxx_setup_global(ds);\r\nif (ret)\r\nreturn ret;\r\nREG_WRITE(REG_GLOBAL, GLOBAL_CONTROL,\r\nGLOBAL_CONTROL_PPU_ENABLE | GLOBAL_CONTROL_MAX_FRAME_1632);\r\nREG_WRITE(REG_GLOBAL, GLOBAL_CORE_TAG_TYPE, 0x8100);\r\nreg = upstream_port << GLOBAL_MONITOR_CONTROL_INGRESS_SHIFT |\r\nupstream_port << GLOBAL_MONITOR_CONTROL_EGRESS_SHIFT |\r\nGLOBAL_MONITOR_CONTROL_ARP_DISABLED;\r\nREG_WRITE(REG_GLOBAL, GLOBAL_MONITOR_CONTROL, reg);\r\nif (ds->dst->pd->nr_chips > 1)\r\nREG_WRITE(REG_GLOBAL, GLOBAL_CONTROL_2,\r\nGLOBAL_CONTROL_2_MULTIPLE_CASCADE |\r\n(ds->index & 0x1f));\r\nelse\r\nREG_WRITE(REG_GLOBAL, GLOBAL_CONTROL_2,\r\nGLOBAL_CONTROL_2_NO_CASCADE |\r\n(ds->index & 0x1f));\r\nREG_WRITE(REG_GLOBAL2, GLOBAL2_PRIO_OVERRIDE,\r\nGLOBAL2_PRIO_OVERRIDE_FORCE_SNOOP |\r\n7 << GLOBAL2_PRIO_OVERRIDE_SNOOP_SHIFT |\r\nGLOBAL2_PRIO_OVERRIDE_FORCE_ARP |\r\n7 << GLOBAL2_PRIO_OVERRIDE_ARP_SHIFT);\r\nreturn 0;\r\n}\r\nstatic int mv88e6131_setup(struct dsa_switch *ds)\r\n{\r\nstruct mv88e6xxx_priv_state *ps = ds_to_priv(ds);\r\nint ret;\r\nret = mv88e6xxx_setup_common(ds);\r\nif (ret < 0)\r\nreturn ret;\r\nmv88e6xxx_ppu_state_init(ds);\r\nswitch (ps->id) {\r\ncase PORT_SWITCH_ID_6085:\r\ncase PORT_SWITCH_ID_6185:\r\nps->num_ports = 10;\r\nbreak;\r\ncase PORT_SWITCH_ID_6095:\r\nps->num_ports = 11;\r\nbreak;\r\ncase PORT_SWITCH_ID_6131:\r\ncase PORT_SWITCH_ID_6131_B2:\r\nps->num_ports = 8;\r\nbreak;\r\ndefault:\r\nreturn -ENODEV;\r\n}\r\nret = mv88e6xxx_switch_reset(ds, false);\r\nif (ret < 0)\r\nreturn ret;\r\nret = mv88e6131_setup_global(ds);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn mv88e6xxx_setup_ports(ds);\r\n}\r\nstatic int mv88e6131_port_to_phy_addr(struct dsa_switch *ds, int port)\r\n{\r\nstruct mv88e6xxx_priv_state *ps = ds_to_priv(ds);\r\nif (port >= 0 && port < ps->num_ports)\r\nreturn port;\r\nreturn -EINVAL;\r\n}\r\nstatic int\r\nmv88e6131_phy_read(struct dsa_switch *ds, int port, int regnum)\r\n{\r\nint addr = mv88e6131_port_to_phy_addr(ds, port);\r\nif (addr < 0)\r\nreturn addr;\r\nreturn mv88e6xxx_phy_read_ppu(ds, addr, regnum);\r\n}\r\nstatic int\r\nmv88e6131_phy_write(struct dsa_switch *ds,\r\nint port, int regnum, u16 val)\r\n{\r\nint addr = mv88e6131_port_to_phy_addr(ds, port);\r\nif (addr < 0)\r\nreturn addr;\r\nreturn mv88e6xxx_phy_write_ppu(ds, addr, regnum, val);\r\n}

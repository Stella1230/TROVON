static int awg_generate_instr(enum opcode opcode,\r\nlong int arg,\r\nlong int mux_sel,\r\nlong int data_en,\r\nstruct awg_code_generation_params *fwparams)\r\n{\r\nu32 instruction = 0;\r\nu32 mux = (mux_sel << 8) & 0x1ff;\r\nu32 data_enable = (data_en << 9) & 0x2ff;\r\nlong int arg_tmp = arg;\r\nwhile (arg_tmp > 0) {\r\narg = arg_tmp;\r\nif (fwparams->instruction_offset >= AWG_MAX_INST) {\r\nDRM_ERROR("too many number of instructions\n");\r\nreturn -EINVAL;\r\n}\r\nswitch (opcode) {\r\ncase SKIP:\r\narg--;\r\narg_tmp--;\r\nif (arg < 0) {\r\nreturn 0;\r\n}\r\nif (arg == 0) {\r\nopcode = SET;\r\nbreak;\r\n}\r\nmux = 0;\r\ndata_enable = 0;\r\narg &= (0x3ff);\r\nbreak;\r\ncase REPEAT:\r\ncase REPLAY:\r\nif (arg == 0) {\r\nreturn 0;\r\n}\r\nmux = 0;\r\ndata_enable = 0;\r\narg &= (0x3ff);\r\nbreak;\r\ncase JUMP:\r\nmux = 0;\r\ndata_enable = 0;\r\narg |= 0x40;\r\narg &= 0x3ff;\r\nbreak;\r\ncase STOP:\r\narg = 0;\r\nbreak;\r\ncase SET:\r\ncase RPTSET:\r\ncase RPLSET:\r\ncase HOLD:\r\narg &= (0x0ff);\r\nbreak;\r\ndefault:\r\nDRM_ERROR("instruction %d does not exist\n", opcode);\r\nreturn -EINVAL;\r\n}\r\narg_tmp = arg_tmp - arg;\r\narg = ((arg + mux) + data_enable);\r\ninstruction = ((opcode) << AWG_OPCODE_OFFSET) | arg;\r\nfwparams->ram_code[fwparams->instruction_offset] =\r\ninstruction & (0x3fff);\r\nfwparams->instruction_offset++;\r\n}\r\nreturn 0;\r\n}\r\nint sti_awg_generate_code_data_enable_mode(\r\nstruct awg_code_generation_params *fwparams,\r\nstruct awg_timing *timing)\r\n{\r\nlong int val;\r\nlong int data_en;\r\nint ret = 0;\r\nif (timing->trailing_lines > 0) {\r\nval = timing->blanking_level;\r\ndata_en = 0;\r\nret |= awg_generate_instr(RPLSET, val, 0, data_en, fwparams);\r\nval = timing->trailing_lines - 1;\r\ndata_en = 0;\r\nret |= awg_generate_instr(REPLAY, val, 0, data_en, fwparams);\r\n}\r\nif (timing->trailing_pixels > 0) {\r\nval = timing->blanking_level;\r\ndata_en = 0;\r\nret |= awg_generate_instr(RPLSET, val, 0, data_en, fwparams);\r\nval = timing->trailing_pixels - 1;\r\ndata_en = 0;\r\nret |= awg_generate_instr(SKIP, val, 0, data_en, fwparams);\r\n}\r\nval = timing->blanking_level;\r\ndata_en = 1;\r\nret |= awg_generate_instr((timing->trailing_pixels > 0) ? SET : RPLSET,\r\nval, 0, data_en, fwparams);\r\nif (timing->blanking_pixels > 0) {\r\nval = timing->active_pixels - 1;\r\ndata_en = 1;\r\nret |= awg_generate_instr(SKIP, val, 0, data_en, fwparams);\r\nval = timing->blanking_level;\r\ndata_en = 0;\r\nret |= awg_generate_instr(SET, val, 0, data_en, fwparams);\r\n}\r\nval = timing->active_lines - 1;\r\ndata_en = 0;\r\nret |= awg_generate_instr(REPLAY, val, 0, data_en, fwparams);\r\nif (timing->blanking_lines > 0) {\r\nval = timing->blanking_level;\r\ndata_en = 0;\r\nret |= awg_generate_instr(RPLSET, val, 0, data_en, fwparams);\r\nval = timing->blanking_lines - 1;\r\ndata_en = 0;\r\nret |= awg_generate_instr(REPLAY, val, 0, data_en, fwparams);\r\n}\r\nreturn ret;\r\n}

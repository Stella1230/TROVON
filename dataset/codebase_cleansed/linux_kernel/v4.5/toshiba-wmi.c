static void toshiba_wmi_notify(u32 value, void *context)\r\n{\r\nstruct acpi_buffer response = { ACPI_ALLOCATE_BUFFER, NULL };\r\nunion acpi_object *obj;\r\nacpi_status status;\r\nstatus = wmi_get_event_data(value, &response);\r\nif (ACPI_FAILURE(status)) {\r\npr_err("Bad event status 0x%x\n", status);\r\nreturn;\r\n}\r\nobj = (union acpi_object *)response.pointer;\r\nif (!obj)\r\nreturn;\r\npr_debug("Unknown event received, obj type %x\n", obj->type);\r\nkfree(response.pointer);\r\n}\r\nstatic int __init toshiba_wmi_input_setup(void)\r\n{\r\nacpi_status status;\r\nint err;\r\ntoshiba_wmi_input_dev = input_allocate_device();\r\nif (!toshiba_wmi_input_dev)\r\nreturn -ENOMEM;\r\ntoshiba_wmi_input_dev->name = "Toshiba WMI hotkeys";\r\ntoshiba_wmi_input_dev->phys = "wmi/input0";\r\ntoshiba_wmi_input_dev->id.bustype = BUS_HOST;\r\nerr = sparse_keymap_setup(toshiba_wmi_input_dev,\r\ntoshiba_wmi_keymap, NULL);\r\nif (err)\r\ngoto err_free_dev;\r\nstatus = wmi_install_notify_handler(TOSHIBA_WMI_EVENT_GUID,\r\ntoshiba_wmi_notify, NULL);\r\nif (ACPI_FAILURE(status)) {\r\nerr = -EIO;\r\ngoto err_free_keymap;\r\n}\r\nerr = input_register_device(toshiba_wmi_input_dev);\r\nif (err)\r\ngoto err_remove_notifier;\r\nreturn 0;\r\nerr_remove_notifier:\r\nwmi_remove_notify_handler(TOSHIBA_WMI_EVENT_GUID);\r\nerr_free_keymap:\r\nsparse_keymap_free(toshiba_wmi_input_dev);\r\nerr_free_dev:\r\ninput_free_device(toshiba_wmi_input_dev);\r\nreturn err;\r\n}\r\nstatic void toshiba_wmi_input_destroy(void)\r\n{\r\nwmi_remove_notify_handler(TOSHIBA_WMI_EVENT_GUID);\r\nsparse_keymap_free(toshiba_wmi_input_dev);\r\ninput_unregister_device(toshiba_wmi_input_dev);\r\n}\r\nstatic int __init toshiba_wmi_init(void)\r\n{\r\nint ret;\r\nif (!wmi_has_guid(TOSHIBA_WMI_EVENT_GUID))\r\nreturn -ENODEV;\r\nret = toshiba_wmi_input_setup();\r\nif (ret) {\r\npr_err("Failed to setup input device\n");\r\nreturn ret;\r\n}\r\npr_info("Toshiba WMI Hotkey Driver\n");\r\nreturn 0;\r\n}\r\nstatic void __exit toshiba_wmi_exit(void)\r\n{\r\nif (wmi_has_guid(TOSHIBA_WMI_EVENT_GUID))\r\ntoshiba_wmi_input_destroy();\r\n}

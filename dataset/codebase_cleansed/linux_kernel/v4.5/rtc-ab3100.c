static int ab3100_rtc_set_mmss(struct device *dev, time64_t secs)\r\n{\r\nu8 regs[] = {AB3100_TI0, AB3100_TI1, AB3100_TI2,\r\nAB3100_TI3, AB3100_TI4, AB3100_TI5};\r\nunsigned char buf[6];\r\nu64 hw_counter = secs * AB3100_RTC_CLOCK_RATE * 2;\r\nint err = 0;\r\nint i;\r\nbuf[0] = (hw_counter) & 0xFF;\r\nbuf[1] = (hw_counter >> 8) & 0xFF;\r\nbuf[2] = (hw_counter >> 16) & 0xFF;\r\nbuf[3] = (hw_counter >> 24) & 0xFF;\r\nbuf[4] = (hw_counter >> 32) & 0xFF;\r\nbuf[5] = (hw_counter >> 40) & 0xFF;\r\nfor (i = 0; i < 6; i++) {\r\nerr = abx500_set_register_interruptible(dev, 0,\r\nregs[i], buf[i]);\r\nif (err)\r\nreturn err;\r\n}\r\nreturn abx500_mask_and_set_register_interruptible(dev, 0,\r\nAB3100_RTC,\r\n0x01, 0x01);\r\n}\r\nstatic int ab3100_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\ntime64_t time;\r\nu8 rtcval;\r\nint err;\r\nerr = abx500_get_register_interruptible(dev, 0,\r\nAB3100_RTC, &rtcval);\r\nif (err)\r\nreturn err;\r\nif (!(rtcval & 0x01)) {\r\ndev_info(dev, "clock not set (lost power)");\r\nreturn -EINVAL;\r\n} else {\r\nu64 hw_counter;\r\nu8 buf[6];\r\nerr = abx500_get_register_page_interruptible(dev, 0,\r\nAB3100_TI0,\r\nbuf, 6);\r\nif (err != 0)\r\nreturn err;\r\nhw_counter = ((u64) buf[5] << 40) | ((u64) buf[4] << 32) |\r\n((u64) buf[3] << 24) | ((u64) buf[2] << 16) |\r\n((u64) buf[1] << 8) | (u64) buf[0];\r\ntime = hw_counter / (u64) (AB3100_RTC_CLOCK_RATE * 2);\r\n}\r\nrtc_time64_to_tm(time, tm);\r\nreturn rtc_valid_tm(tm);\r\n}\r\nstatic int ab3100_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alarm)\r\n{\r\ntime64_t time;\r\nu64 hw_counter;\r\nu8 buf[6];\r\nu8 rtcval;\r\nint err;\r\nerr = abx500_get_register_interruptible(dev, 0,\r\nAB3100_RTC, &rtcval);\r\nif (err)\r\nreturn err;\r\nif (rtcval & 0x04)\r\nalarm->enabled = 1;\r\nelse\r\nalarm->enabled = 0;\r\nalarm->pending = 0;\r\nerr = abx500_get_register_page_interruptible(dev, 0,\r\nAB3100_AL0, buf, 4);\r\nif (err)\r\nreturn err;\r\nhw_counter = ((u64) buf[3] << 40) | ((u64) buf[2] << 32) |\r\n((u64) buf[1] << 24) | ((u64) buf[0] << 16);\r\ntime = hw_counter / (u64) (AB3100_RTC_CLOCK_RATE * 2);\r\nrtc_time64_to_tm(time, &alarm->time);\r\nreturn rtc_valid_tm(&alarm->time);\r\n}\r\nstatic int ab3100_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alarm)\r\n{\r\nu8 regs[] = {AB3100_AL0, AB3100_AL1, AB3100_AL2, AB3100_AL3};\r\nunsigned char buf[4];\r\ntime64_t secs;\r\nu64 hw_counter;\r\nint err;\r\nint i;\r\nsecs = rtc_tm_to_time64(&alarm->time);\r\nhw_counter = secs * AB3100_RTC_CLOCK_RATE * 2;\r\nbuf[0] = (hw_counter >> 16) & 0xFF;\r\nbuf[1] = (hw_counter >> 24) & 0xFF;\r\nbuf[2] = (hw_counter >> 32) & 0xFF;\r\nbuf[3] = (hw_counter >> 40) & 0xFF;\r\nfor (i = 0; i < 4; i++) {\r\nerr = abx500_set_register_interruptible(dev, 0,\r\nregs[i], buf[i]);\r\nif (err)\r\nreturn err;\r\n}\r\nreturn abx500_mask_and_set_register_interruptible(dev, 0,\r\nAB3100_RTC, (1 << 2),\r\nalarm->enabled << 2);\r\n}\r\nstatic int ab3100_rtc_irq_enable(struct device *dev, unsigned int enabled)\r\n{\r\nif (enabled)\r\nreturn abx500_mask_and_set_register_interruptible(dev, 0,\r\nAB3100_RTC, (1 << 2),\r\n1 << 2);\r\nelse\r\nreturn abx500_mask_and_set_register_interruptible(dev, 0,\r\nAB3100_RTC, (1 << 2),\r\n0);\r\n}\r\nstatic int __init ab3100_rtc_probe(struct platform_device *pdev)\r\n{\r\nint err;\r\nu8 regval;\r\nstruct rtc_device *rtc;\r\nerr = abx500_get_register_interruptible(&pdev->dev, 0,\r\nAB3100_RTC, &regval);\r\nif (err) {\r\ndev_err(&pdev->dev, "unable to read RTC register\n");\r\nreturn -ENODEV;\r\n}\r\nif ((regval & 0xFE) != RTC_SETTING) {\r\ndev_warn(&pdev->dev, "not default value in RTC reg 0x%x\n",\r\nregval);\r\n}\r\nif ((regval & 1) == 0) {\r\nregval = 1 | RTC_SETTING;\r\nerr = abx500_set_register_interruptible(&pdev->dev, 0,\r\nAB3100_RTC, regval);\r\n}\r\nrtc = devm_rtc_device_register(&pdev->dev, "ab3100-rtc",\r\n&ab3100_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc)) {\r\nerr = PTR_ERR(rtc);\r\nreturn err;\r\n}\r\nplatform_set_drvdata(pdev, rtc);\r\nreturn 0;\r\n}

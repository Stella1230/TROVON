static void dw_mci_k3_set_ios(struct dw_mci *host, struct mmc_ios *ios)\r\n{\r\nint ret;\r\nret = clk_set_rate(host->ciu_clk, ios->clock);\r\nif (ret)\r\ndev_warn(host->dev, "failed to set rate %uHz\n", ios->clock);\r\nhost->bus_hz = clk_get_rate(host->ciu_clk);\r\n}\r\nstatic int dw_mci_hi6220_parse_dt(struct dw_mci *host)\r\n{\r\nstruct k3_priv *priv;\r\npriv = devm_kzalloc(host->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->reg = syscon_regmap_lookup_by_phandle(host->dev->of_node,\r\n"hisilicon,peripheral-syscon");\r\nif (IS_ERR(priv->reg))\r\npriv->reg = NULL;\r\nhost->priv = priv;\r\nreturn 0;\r\n}\r\nstatic int dw_mci_hi6220_switch_voltage(struct mmc_host *mmc, struct mmc_ios *ios)\r\n{\r\nstruct dw_mci_slot *slot = mmc_priv(mmc);\r\nstruct k3_priv *priv;\r\nstruct dw_mci *host;\r\nint min_uv, max_uv;\r\nint ret;\r\nhost = slot->host;\r\npriv = host->priv;\r\nif (!priv || !priv->reg)\r\nreturn 0;\r\nif (ios->signal_voltage == MMC_SIGNAL_VOLTAGE_330) {\r\nret = regmap_update_bits(priv->reg, AO_SCTRL_CTRL3,\r\nAO_SCTRL_SEL18, 0);\r\nmin_uv = 3000000;\r\nmax_uv = 3000000;\r\n} else if (ios->signal_voltage == MMC_SIGNAL_VOLTAGE_180) {\r\nret = regmap_update_bits(priv->reg, AO_SCTRL_CTRL3,\r\nAO_SCTRL_SEL18, AO_SCTRL_SEL18);\r\nmin_uv = 1800000;\r\nmax_uv = 1800000;\r\n} else {\r\ndev_dbg(host->dev, "voltage not supported\n");\r\nreturn -EINVAL;\r\n}\r\nif (ret) {\r\ndev_dbg(host->dev, "switch voltage failed\n");\r\nreturn ret;\r\n}\r\nif (IS_ERR_OR_NULL(mmc->supply.vqmmc))\r\nreturn 0;\r\nret = regulator_set_voltage(mmc->supply.vqmmc, min_uv, max_uv);\r\nif (ret) {\r\ndev_dbg(host->dev, "Regulator set error %d: %d - %d\n",\r\nret, min_uv, max_uv);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic void dw_mci_hi6220_set_ios(struct dw_mci *host, struct mmc_ios *ios)\r\n{\r\nint ret;\r\nunsigned int clock;\r\nclock = (ios->clock <= 25000000) ? 25000000 : ios->clock;\r\nret = clk_set_rate(host->biu_clk, clock);\r\nif (ret)\r\ndev_warn(host->dev, "failed to set rate %uHz\n", clock);\r\nhost->bus_hz = clk_get_rate(host->biu_clk);\r\n}\r\nstatic int dw_mci_k3_probe(struct platform_device *pdev)\r\n{\r\nconst struct dw_mci_drv_data *drv_data;\r\nconst struct of_device_id *match;\r\nmatch = of_match_node(dw_mci_k3_match, pdev->dev.of_node);\r\ndrv_data = match->data;\r\nreturn dw_mci_pltfm_register(pdev, drv_data);\r\n}\r\nstatic int dw_mci_k3_suspend(struct device *dev)\r\n{\r\nstruct dw_mci *host = dev_get_drvdata(dev);\r\nint ret;\r\nret = dw_mci_suspend(host);\r\nif (!ret)\r\nclk_disable_unprepare(host->ciu_clk);\r\nreturn ret;\r\n}\r\nstatic int dw_mci_k3_resume(struct device *dev)\r\n{\r\nstruct dw_mci *host = dev_get_drvdata(dev);\r\nint ret;\r\nret = clk_prepare_enable(host->ciu_clk);\r\nif (ret) {\r\ndev_err(host->dev, "failed to enable ciu clock\n");\r\nreturn ret;\r\n}\r\nreturn dw_mci_resume(host);\r\n}

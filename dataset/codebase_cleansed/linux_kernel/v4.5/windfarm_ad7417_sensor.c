static int wf_ad7417_temp_get(struct wf_sensor *sr, s32 *value)\r\n{\r\nstruct wf_ad7417_priv *pv = sr->priv;\r\nu8 buf[2];\r\ns16 raw;\r\nint rc;\r\n*value = 0;\r\nmutex_lock(&pv->lock);\r\nbuf[0] = 0;\r\nrc = i2c_master_send(pv->i2c, buf, 1);\r\nif (rc < 0)\r\ngoto error;\r\nrc = i2c_master_recv(pv->i2c, buf, 2);\r\nif (rc < 0)\r\ngoto error;\r\nraw = be16_to_cpup((__le16 *)buf);\r\n*value = ((s32)raw) << 8;\r\nmutex_unlock(&pv->lock);\r\nreturn 0;\r\nerror:\r\nmutex_unlock(&pv->lock);\r\nreturn -1;\r\n}\r\nstatic void wf_ad7417_adc_convert(struct wf_ad7417_priv *pv,\r\nint chan, s32 raw, s32 *value)\r\n{\r\nswitch(chan) {\r\ncase 1:\r\n*value = (raw * (s32)pv->mpu->mdiode +\r\n((s32)pv->mpu->bdiode << 12)) >> 2;\r\nbreak;\r\ncase 2:\r\n*value = raw * ADC_12V_CURRENT_SCALE;\r\nbreak;\r\ncase 3:\r\n*value = raw * ADC_CPU_VOLTAGE_SCALE;\r\nbreak;\r\ncase 4:\r\n*value = raw * ADC_CPU_CURRENT_SCALE;\r\nbreak;\r\n}\r\n}\r\nstatic int wf_ad7417_adc_get(struct wf_sensor *sr, s32 *value)\r\n{\r\nstruct wf_ad7417_priv *pv = sr->priv;\r\nint chan = sr - pv->sensors;\r\nint i, rc;\r\nu8 buf[2];\r\nu16 raw;\r\n*value = 0;\r\nmutex_lock(&pv->lock);\r\nfor (i = 0; i < 10; i++) {\r\nbuf[0] = 1;\r\nbuf[1] = (pv->config & 0x1f) | (chan << 5);\r\nrc = i2c_master_send(pv->i2c, buf, 2);\r\nif (rc < 0)\r\ngoto error;\r\nmsleep(1);\r\nbuf[0] = 4;\r\nrc = i2c_master_send(pv->i2c, buf, 1);\r\nif (rc < 0)\r\ngoto error;\r\nrc = i2c_master_recv(pv->i2c, buf, 2);\r\nif (rc < 0)\r\ngoto error;\r\nraw = be16_to_cpup((__le16 *)buf) >> 6;\r\nwf_ad7417_adc_convert(pv, chan, raw, value);\r\ndev_vdbg(&pv->i2c->dev, "ADC chan %d [%s]"\r\n" raw value: 0x%x, conv to: 0x%08x\n",\r\nchan, sr->name, raw, *value);\r\nmutex_unlock(&pv->lock);\r\nreturn 0;\r\nerror:\r\ndev_dbg(&pv->i2c->dev,\r\n"Error reading ADC, try %d...\n", i);\r\nif (i < 9)\r\nmsleep(10);\r\n}\r\nmutex_unlock(&pv->lock);\r\nreturn -1;\r\n}\r\nstatic void wf_ad7417_release(struct kref *ref)\r\n{\r\nstruct wf_ad7417_priv *pv = container_of(ref,\r\nstruct wf_ad7417_priv, ref);\r\nkfree(pv);\r\n}\r\nstatic void wf_ad7417_sensor_release(struct wf_sensor *sr)\r\n{\r\nstruct wf_ad7417_priv *pv = sr->priv;\r\nkfree(sr->name);\r\nkref_put(&pv->ref, wf_ad7417_release);\r\n}\r\nstatic void wf_ad7417_add_sensor(struct wf_ad7417_priv *pv,\r\nint index, const char *name,\r\nconst struct wf_sensor_ops *ops)\r\n{\r\npv->sensors[index].name = kasprintf(GFP_KERNEL, "%s-%d", name, pv->cpu);\r\npv->sensors[index].priv = pv;\r\npv->sensors[index].ops = ops;\r\nif (!wf_register_sensor(&pv->sensors[index]))\r\nkref_get(&pv->ref);\r\n}\r\nstatic void wf_ad7417_init_chip(struct wf_ad7417_priv *pv)\r\n{\r\nint rc;\r\nu8 buf[2];\r\nu8 config = 0;\r\nbuf[0] = 5;\r\nbuf[1] = 0;\r\ni2c_master_send(pv->i2c, buf, 2);\r\nbuf[0] = 1;\r\nrc = i2c_master_send(pv->i2c, buf, 1);\r\nif (rc > 0) {\r\nrc = i2c_master_recv(pv->i2c, buf, 1);\r\nif (rc > 0) {\r\nconfig = buf[0];\r\ndev_dbg(&pv->i2c->dev, "ADC config reg: %02x\n",\r\nconfig);\r\nconfig &= 0xfe;\r\nbuf[0] = 1;\r\nbuf[1] = config;\r\nrc = i2c_master_send(pv->i2c, buf, 2);\r\n}\r\n}\r\nif (rc <= 0)\r\ndev_err(&pv->i2c->dev, "Error reading ADC config\n");\r\npv->config = config;\r\n}\r\nstatic int wf_ad7417_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct wf_ad7417_priv *pv;\r\nconst struct mpu_data *mpu;\r\nconst char *loc;\r\nint cpu_nr;\r\nloc = of_get_property(client->dev.of_node, "hwsensor-location", NULL);\r\nif (!loc) {\r\ndev_warn(&client->dev, "Missing hwsensor-location property!\n");\r\nreturn -ENXIO;\r\n}\r\nif (!strncmp(loc, "CPU A", 5))\r\ncpu_nr = 0;\r\nelse if (!strncmp(loc, "CPU B", 5))\r\ncpu_nr = 1;\r\nelse {\r\npr_err("wf_ad7417: Can't identify location %s\n", loc);\r\nreturn -ENXIO;\r\n}\r\nmpu = wf_get_mpu(cpu_nr);\r\nif (!mpu) {\r\ndev_err(&client->dev, "Failed to retrieve MPU data\n");\r\nreturn -ENXIO;\r\n}\r\npv = kzalloc(sizeof(struct wf_ad7417_priv), GFP_KERNEL);\r\nif (pv == NULL)\r\nreturn -ENODEV;\r\nkref_init(&pv->ref);\r\nmutex_init(&pv->lock);\r\npv->i2c = client;\r\npv->cpu = cpu_nr;\r\npv->mpu = mpu;\r\ndev_set_drvdata(&client->dev, pv);\r\nwf_ad7417_init_chip(pv);\r\nwf_ad7417_add_sensor(pv, 0, "cpu-amb-temp", &wf_ad7417_temp_ops);\r\nwf_ad7417_add_sensor(pv, 1, "cpu-diode-temp", &wf_ad7417_adc_ops);\r\nwf_ad7417_add_sensor(pv, 2, "cpu-12v-current", &wf_ad7417_adc_ops);\r\nwf_ad7417_add_sensor(pv, 3, "cpu-voltage", &wf_ad7417_adc_ops);\r\nwf_ad7417_add_sensor(pv, 4, "cpu-current", &wf_ad7417_adc_ops);\r\nreturn 0;\r\n}\r\nstatic int wf_ad7417_remove(struct i2c_client *client)\r\n{\r\nstruct wf_ad7417_priv *pv = dev_get_drvdata(&client->dev);\r\nint i;\r\npv->i2c = NULL;\r\nfor (i = 0; i < 5; i++)\r\nwf_unregister_sensor(&pv->sensors[i]);\r\nkref_put(&pv->ref, wf_ad7417_release);\r\nreturn 0;\r\n}\r\nstatic int wf_ad7417_init(void)\r\n{\r\nif (!of_machine_is_compatible("PowerMac7,2") &&\r\n!of_machine_is_compatible("PowerMac7,3") &&\r\n!of_machine_is_compatible("RackMac3,1"))\r\nreturn -ENODEV;\r\nreturn i2c_add_driver(&wf_ad7417_driver);\r\n}\r\nstatic void wf_ad7417_exit(void)\r\n{\r\ni2c_del_driver(&wf_ad7417_driver);\r\n}

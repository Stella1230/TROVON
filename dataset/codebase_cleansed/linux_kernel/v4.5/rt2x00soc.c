static void rt2x00soc_free_reg(struct rt2x00_dev *rt2x00dev)\r\n{\r\nkfree(rt2x00dev->rf);\r\nrt2x00dev->rf = NULL;\r\nkfree(rt2x00dev->eeprom);\r\nrt2x00dev->eeprom = NULL;\r\niounmap(rt2x00dev->csr.base);\r\n}\r\nstatic int rt2x00soc_alloc_reg(struct rt2x00_dev *rt2x00dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(rt2x00dev->dev);\r\nstruct resource *res;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENODEV;\r\nrt2x00dev->csr.base = ioremap(res->start, resource_size(res));\r\nif (!rt2x00dev->csr.base)\r\nreturn -ENOMEM;\r\nrt2x00dev->eeprom = kzalloc(rt2x00dev->ops->eeprom_size, GFP_KERNEL);\r\nif (!rt2x00dev->eeprom)\r\ngoto exit;\r\nrt2x00dev->rf = kzalloc(rt2x00dev->ops->rf_size, GFP_KERNEL);\r\nif (!rt2x00dev->rf)\r\ngoto exit;\r\nreturn 0;\r\nexit:\r\nrt2x00_probe_err("Failed to allocate registers\n");\r\nrt2x00soc_free_reg(rt2x00dev);\r\nreturn -ENOMEM;\r\n}\r\nint rt2x00soc_probe(struct platform_device *pdev, const struct rt2x00_ops *ops)\r\n{\r\nstruct ieee80211_hw *hw;\r\nstruct rt2x00_dev *rt2x00dev;\r\nint retval;\r\nhw = ieee80211_alloc_hw(sizeof(struct rt2x00_dev), ops->hw);\r\nif (!hw) {\r\nrt2x00_probe_err("Failed to allocate hardware\n");\r\nreturn -ENOMEM;\r\n}\r\nplatform_set_drvdata(pdev, hw);\r\nrt2x00dev = hw->priv;\r\nrt2x00dev->dev = &pdev->dev;\r\nrt2x00dev->ops = ops;\r\nrt2x00dev->hw = hw;\r\nrt2x00dev->irq = platform_get_irq(pdev, 0);\r\nrt2x00dev->name = pdev->dev.driver->name;\r\nrt2x00_set_chip_intf(rt2x00dev, RT2X00_CHIP_INTF_SOC);\r\nretval = rt2x00soc_alloc_reg(rt2x00dev);\r\nif (retval)\r\ngoto exit_free_device;\r\nretval = rt2x00lib_probe_dev(rt2x00dev);\r\nif (retval)\r\ngoto exit_free_reg;\r\nreturn 0;\r\nexit_free_reg:\r\nrt2x00soc_free_reg(rt2x00dev);\r\nexit_free_device:\r\nieee80211_free_hw(hw);\r\nreturn retval;\r\n}\r\nint rt2x00soc_remove(struct platform_device *pdev)\r\n{\r\nstruct ieee80211_hw *hw = platform_get_drvdata(pdev);\r\nstruct rt2x00_dev *rt2x00dev = hw->priv;\r\nrt2x00lib_remove_dev(rt2x00dev);\r\nrt2x00soc_free_reg(rt2x00dev);\r\nieee80211_free_hw(hw);\r\nreturn 0;\r\n}\r\nint rt2x00soc_suspend(struct platform_device *pdev, pm_message_t state)\r\n{\r\nstruct ieee80211_hw *hw = platform_get_drvdata(pdev);\r\nstruct rt2x00_dev *rt2x00dev = hw->priv;\r\nreturn rt2x00lib_suspend(rt2x00dev, state);\r\n}\r\nint rt2x00soc_resume(struct platform_device *pdev)\r\n{\r\nstruct ieee80211_hw *hw = platform_get_drvdata(pdev);\r\nstruct rt2x00_dev *rt2x00dev = hw->priv;\r\nreturn rt2x00lib_resume(rt2x00dev);\r\n}

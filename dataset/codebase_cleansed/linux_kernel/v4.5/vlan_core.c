bool vlan_do_receive(struct sk_buff **skbp)\r\n{\r\nstruct sk_buff *skb = *skbp;\r\n__be16 vlan_proto = skb->vlan_proto;\r\nu16 vlan_id = skb_vlan_tag_get_id(skb);\r\nstruct net_device *vlan_dev;\r\nstruct vlan_pcpu_stats *rx_stats;\r\nvlan_dev = vlan_find_dev(skb->dev, vlan_proto, vlan_id);\r\nif (!vlan_dev)\r\nreturn false;\r\nskb = *skbp = skb_share_check(skb, GFP_ATOMIC);\r\nif (unlikely(!skb))\r\nreturn false;\r\nskb->dev = vlan_dev;\r\nif (unlikely(skb->pkt_type == PACKET_OTHERHOST)) {\r\nif (ether_addr_equal_64bits(eth_hdr(skb)->h_dest, vlan_dev->dev_addr))\r\nskb->pkt_type = PACKET_HOST;\r\n}\r\nif (!(vlan_dev_priv(vlan_dev)->flags & VLAN_FLAG_REORDER_HDR) &&\r\n!netif_is_macvlan_port(vlan_dev) &&\r\n!netif_is_bridge_port(vlan_dev)) {\r\nunsigned int offset = skb->data - skb_mac_header(skb);\r\nskb_push(skb, offset);\r\nskb = *skbp = vlan_insert_tag(skb, skb->vlan_proto,\r\nskb->vlan_tci);\r\nif (!skb)\r\nreturn false;\r\nskb_pull(skb, offset + VLAN_HLEN);\r\nskb_reset_mac_len(skb);\r\n}\r\nskb->priority = vlan_get_ingress_priority(vlan_dev, skb->vlan_tci);\r\nskb->vlan_tci = 0;\r\nrx_stats = this_cpu_ptr(vlan_dev_priv(vlan_dev)->vlan_pcpu_stats);\r\nu64_stats_update_begin(&rx_stats->syncp);\r\nrx_stats->rx_packets++;\r\nrx_stats->rx_bytes += skb->len;\r\nif (skb->pkt_type == PACKET_MULTICAST)\r\nrx_stats->rx_multicast++;\r\nu64_stats_update_end(&rx_stats->syncp);\r\nreturn true;\r\n}\r\nstruct net_device *__vlan_find_dev_deep_rcu(struct net_device *dev,\r\n__be16 vlan_proto, u16 vlan_id)\r\n{\r\nstruct vlan_info *vlan_info = rcu_dereference(dev->vlan_info);\r\nif (vlan_info) {\r\nreturn vlan_group_get_device(&vlan_info->grp,\r\nvlan_proto, vlan_id);\r\n} else {\r\nstruct net_device *upper_dev;\r\nupper_dev = netdev_master_upper_dev_get_rcu(dev);\r\nif (upper_dev)\r\nreturn __vlan_find_dev_deep_rcu(upper_dev,\r\nvlan_proto, vlan_id);\r\n}\r\nreturn NULL;\r\n}\r\nstruct net_device *vlan_dev_real_dev(const struct net_device *dev)\r\n{\r\nstruct net_device *ret = vlan_dev_priv(dev)->real_dev;\r\nwhile (is_vlan_dev(ret))\r\nret = vlan_dev_priv(ret)->real_dev;\r\nreturn ret;\r\n}\r\nu16 vlan_dev_vlan_id(const struct net_device *dev)\r\n{\r\nreturn vlan_dev_priv(dev)->vlan_id;\r\n}\r\n__be16 vlan_dev_vlan_proto(const struct net_device *dev)\r\n{\r\nreturn vlan_dev_priv(dev)->vlan_proto;\r\n}\r\nstatic void vlan_group_free(struct vlan_group *grp)\r\n{\r\nint i, j;\r\nfor (i = 0; i < VLAN_PROTO_NUM; i++)\r\nfor (j = 0; j < VLAN_GROUP_ARRAY_SPLIT_PARTS; j++)\r\nkfree(grp->vlan_devices_arrays[i][j]);\r\n}\r\nstatic void vlan_info_free(struct vlan_info *vlan_info)\r\n{\r\nvlan_group_free(&vlan_info->grp);\r\nkfree(vlan_info);\r\n}\r\nstatic void vlan_info_rcu_free(struct rcu_head *rcu)\r\n{\r\nvlan_info_free(container_of(rcu, struct vlan_info, rcu));\r\n}\r\nstatic struct vlan_info *vlan_info_alloc(struct net_device *dev)\r\n{\r\nstruct vlan_info *vlan_info;\r\nvlan_info = kzalloc(sizeof(struct vlan_info), GFP_KERNEL);\r\nif (!vlan_info)\r\nreturn NULL;\r\nvlan_info->real_dev = dev;\r\nINIT_LIST_HEAD(&vlan_info->vid_list);\r\nreturn vlan_info;\r\n}\r\nstatic bool vlan_hw_filter_capable(const struct net_device *dev,\r\nconst struct vlan_vid_info *vid_info)\r\n{\r\nif (vid_info->proto == htons(ETH_P_8021Q) &&\r\ndev->features & NETIF_F_HW_VLAN_CTAG_FILTER)\r\nreturn true;\r\nif (vid_info->proto == htons(ETH_P_8021AD) &&\r\ndev->features & NETIF_F_HW_VLAN_STAG_FILTER)\r\nreturn true;\r\nreturn false;\r\n}\r\nstatic struct vlan_vid_info *vlan_vid_info_get(struct vlan_info *vlan_info,\r\n__be16 proto, u16 vid)\r\n{\r\nstruct vlan_vid_info *vid_info;\r\nlist_for_each_entry(vid_info, &vlan_info->vid_list, list) {\r\nif (vid_info->proto == proto && vid_info->vid == vid)\r\nreturn vid_info;\r\n}\r\nreturn NULL;\r\n}\r\nstatic struct vlan_vid_info *vlan_vid_info_alloc(__be16 proto, u16 vid)\r\n{\r\nstruct vlan_vid_info *vid_info;\r\nvid_info = kzalloc(sizeof(struct vlan_vid_info), GFP_KERNEL);\r\nif (!vid_info)\r\nreturn NULL;\r\nvid_info->proto = proto;\r\nvid_info->vid = vid;\r\nreturn vid_info;\r\n}\r\nstatic int __vlan_vid_add(struct vlan_info *vlan_info, __be16 proto, u16 vid,\r\nstruct vlan_vid_info **pvid_info)\r\n{\r\nstruct net_device *dev = vlan_info->real_dev;\r\nconst struct net_device_ops *ops = dev->netdev_ops;\r\nstruct vlan_vid_info *vid_info;\r\nint err;\r\nvid_info = vlan_vid_info_alloc(proto, vid);\r\nif (!vid_info)\r\nreturn -ENOMEM;\r\nif (vlan_hw_filter_capable(dev, vid_info)) {\r\nif (netif_device_present(dev))\r\nerr = ops->ndo_vlan_rx_add_vid(dev, proto, vid);\r\nelse\r\nerr = -ENODEV;\r\nif (err) {\r\nkfree(vid_info);\r\nreturn err;\r\n}\r\n}\r\nlist_add(&vid_info->list, &vlan_info->vid_list);\r\nvlan_info->nr_vids++;\r\n*pvid_info = vid_info;\r\nreturn 0;\r\n}\r\nint vlan_vid_add(struct net_device *dev, __be16 proto, u16 vid)\r\n{\r\nstruct vlan_info *vlan_info;\r\nstruct vlan_vid_info *vid_info;\r\nbool vlan_info_created = false;\r\nint err;\r\nASSERT_RTNL();\r\nvlan_info = rtnl_dereference(dev->vlan_info);\r\nif (!vlan_info) {\r\nvlan_info = vlan_info_alloc(dev);\r\nif (!vlan_info)\r\nreturn -ENOMEM;\r\nvlan_info_created = true;\r\n}\r\nvid_info = vlan_vid_info_get(vlan_info, proto, vid);\r\nif (!vid_info) {\r\nerr = __vlan_vid_add(vlan_info, proto, vid, &vid_info);\r\nif (err)\r\ngoto out_free_vlan_info;\r\n}\r\nvid_info->refcount++;\r\nif (vlan_info_created)\r\nrcu_assign_pointer(dev->vlan_info, vlan_info);\r\nreturn 0;\r\nout_free_vlan_info:\r\nif (vlan_info_created)\r\nkfree(vlan_info);\r\nreturn err;\r\n}\r\nstatic void __vlan_vid_del(struct vlan_info *vlan_info,\r\nstruct vlan_vid_info *vid_info)\r\n{\r\nstruct net_device *dev = vlan_info->real_dev;\r\nconst struct net_device_ops *ops = dev->netdev_ops;\r\n__be16 proto = vid_info->proto;\r\nu16 vid = vid_info->vid;\r\nint err;\r\nif (vlan_hw_filter_capable(dev, vid_info)) {\r\nif (netif_device_present(dev))\r\nerr = ops->ndo_vlan_rx_kill_vid(dev, proto, vid);\r\nelse\r\nerr = -ENODEV;\r\nif (err) {\r\npr_warn("failed to kill vid %04x/%d for device %s\n",\r\nproto, vid, dev->name);\r\n}\r\n}\r\nlist_del(&vid_info->list);\r\nkfree(vid_info);\r\nvlan_info->nr_vids--;\r\n}\r\nvoid vlan_vid_del(struct net_device *dev, __be16 proto, u16 vid)\r\n{\r\nstruct vlan_info *vlan_info;\r\nstruct vlan_vid_info *vid_info;\r\nASSERT_RTNL();\r\nvlan_info = rtnl_dereference(dev->vlan_info);\r\nif (!vlan_info)\r\nreturn;\r\nvid_info = vlan_vid_info_get(vlan_info, proto, vid);\r\nif (!vid_info)\r\nreturn;\r\nvid_info->refcount--;\r\nif (vid_info->refcount == 0) {\r\n__vlan_vid_del(vlan_info, vid_info);\r\nif (vlan_info->nr_vids == 0) {\r\nRCU_INIT_POINTER(dev->vlan_info, NULL);\r\ncall_rcu(&vlan_info->rcu, vlan_info_rcu_free);\r\n}\r\n}\r\n}\r\nint vlan_vids_add_by_dev(struct net_device *dev,\r\nconst struct net_device *by_dev)\r\n{\r\nstruct vlan_vid_info *vid_info;\r\nstruct vlan_info *vlan_info;\r\nint err;\r\nASSERT_RTNL();\r\nvlan_info = rtnl_dereference(by_dev->vlan_info);\r\nif (!vlan_info)\r\nreturn 0;\r\nlist_for_each_entry(vid_info, &vlan_info->vid_list, list) {\r\nerr = vlan_vid_add(dev, vid_info->proto, vid_info->vid);\r\nif (err)\r\ngoto unwind;\r\n}\r\nreturn 0;\r\nunwind:\r\nlist_for_each_entry_continue_reverse(vid_info,\r\n&vlan_info->vid_list,\r\nlist) {\r\nvlan_vid_del(dev, vid_info->proto, vid_info->vid);\r\n}\r\nreturn err;\r\n}\r\nvoid vlan_vids_del_by_dev(struct net_device *dev,\r\nconst struct net_device *by_dev)\r\n{\r\nstruct vlan_vid_info *vid_info;\r\nstruct vlan_info *vlan_info;\r\nASSERT_RTNL();\r\nvlan_info = rtnl_dereference(by_dev->vlan_info);\r\nif (!vlan_info)\r\nreturn;\r\nlist_for_each_entry(vid_info, &vlan_info->vid_list, list)\r\nvlan_vid_del(dev, vid_info->proto, vid_info->vid);\r\n}\r\nbool vlan_uses_dev(const struct net_device *dev)\r\n{\r\nstruct vlan_info *vlan_info;\r\nASSERT_RTNL();\r\nvlan_info = rtnl_dereference(dev->vlan_info);\r\nif (!vlan_info)\r\nreturn false;\r\nreturn vlan_info->grp.nr_vlan_devs ? true : false;\r\n}

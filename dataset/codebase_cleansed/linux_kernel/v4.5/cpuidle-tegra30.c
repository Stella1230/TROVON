static bool tegra30_cpu_cluster_power_down(struct cpuidle_device *dev,\r\nstruct cpuidle_driver *drv,\r\nint index)\r\n{\r\nif (num_online_cpus() > 1 || !tegra_cpu_rail_off_ready()) {\r\ncpu_do_idle();\r\nreturn false;\r\n}\r\ntick_broadcast_enter();\r\ntegra_idle_lp2_last();\r\ntick_broadcast_exit();\r\nreturn true;\r\n}\r\nstatic bool tegra30_cpu_core_power_down(struct cpuidle_device *dev,\r\nstruct cpuidle_driver *drv,\r\nint index)\r\n{\r\ntick_broadcast_enter();\r\nsmp_wmb();\r\ncpu_suspend(0, tegra30_sleep_cpu_secondary_finish);\r\ntick_broadcast_exit();\r\nreturn true;\r\n}\r\nstatic inline bool tegra30_cpu_core_power_down(struct cpuidle_device *dev,\r\nstruct cpuidle_driver *drv,\r\nint index)\r\n{\r\nreturn true;\r\n}\r\nstatic int tegra30_idle_lp2(struct cpuidle_device *dev,\r\nstruct cpuidle_driver *drv,\r\nint index)\r\n{\r\nbool entered_lp2 = false;\r\nbool last_cpu;\r\nlocal_fiq_disable();\r\nlast_cpu = tegra_set_cpu_in_lp2();\r\ncpu_pm_enter();\r\nif (dev->cpu == 0) {\r\nif (last_cpu)\r\nentered_lp2 = tegra30_cpu_cluster_power_down(dev, drv,\r\nindex);\r\nelse\r\ncpu_do_idle();\r\n} else {\r\nentered_lp2 = tegra30_cpu_core_power_down(dev, drv, index);\r\n}\r\ncpu_pm_exit();\r\ntegra_clear_cpu_in_lp2();\r\nlocal_fiq_enable();\r\nsmp_rmb();\r\nreturn (entered_lp2) ? index : 0;\r\n}\r\nint __init tegra30_cpuidle_init(void)\r\n{\r\nreturn cpuidle_register(&tegra_idle_driver, NULL);\r\n}

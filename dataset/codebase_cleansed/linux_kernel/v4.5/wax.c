static void wax_choose_irq(struct parisc_device *dev, void *ctrl)\r\n{\r\nint irq;\r\nswitch (dev->id.sversion) {\r\ncase 0x73: irq = 1; break;\r\ncase 0x8c: irq = 6; break;\r\ncase 0x90: irq = 10; break;\r\ndefault: return;\r\n}\r\ngsc_asic_assign_irq(ctrl, irq, &dev->irq);\r\nswitch (dev->id.sversion) {\r\ncase 0x73: irq = 2; break;\r\ncase 0x90: irq = 0; break;\r\ndefault: return;\r\n}\r\ngsc_asic_assign_irq(ctrl, irq, &dev->aux_irq);\r\n}\r\nstatic void __init\r\nwax_init_irq(struct gsc_asic *wax)\r\n{\r\nunsigned long base = wax->hpa;\r\ngsc_writel(0x00000000, base+OFFSET_IMR);\r\ngsc_readl(base+OFFSET_IRR);\r\n}\r\nstatic int __init wax_init_chip(struct parisc_device *dev)\r\n{\r\nstruct gsc_asic *wax;\r\nstruct parisc_device *parent;\r\nstruct gsc_irq gsc_irq;\r\nint ret;\r\nwax = kzalloc(sizeof(*wax), GFP_KERNEL);\r\nif (!wax)\r\nreturn -ENOMEM;\r\nwax->name = "wax";\r\nwax->hpa = dev->hpa.start;\r\nwax->version = 0;\r\nprintk(KERN_INFO "%s at 0x%lx found.\n", wax->name, wax->hpa);\r\nwax_init_irq(wax);\r\ndev->irq = gsc_claim_irq(&gsc_irq, WAX_GSC_IRQ);\r\nif (dev->irq < 0) {\r\nprintk(KERN_ERR "%s(): cannot get GSC irq\n",\r\n__func__);\r\nkfree(wax);\r\nreturn -EBUSY;\r\n}\r\nwax->eim = ((u32) gsc_irq.txn_addr) | gsc_irq.txn_data;\r\nret = request_irq(gsc_irq.irq, gsc_asic_intr, 0, "wax", wax);\r\nif (ret < 0) {\r\nkfree(wax);\r\nreturn ret;\r\n}\r\ngsc_writel(wax->eim, wax->hpa + OFFSET_IAR);\r\nret = gsc_common_setup(dev, wax);\r\nif (ret) {\r\nkfree(wax);\r\nreturn ret;\r\n}\r\ngsc_fixup_irqs(dev, wax, wax_choose_irq);\r\nparent = parisc_parent(dev);\r\nif (parent->id.hw_type != HPHW_IOA) {\r\ngsc_fixup_irqs(parent, wax, wax_choose_irq);\r\n}\r\nreturn ret;\r\n}

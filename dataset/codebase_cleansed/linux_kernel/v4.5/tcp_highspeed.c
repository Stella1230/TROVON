static void hstcp_init(struct sock *sk)\r\n{\r\nstruct tcp_sock *tp = tcp_sk(sk);\r\nstruct hstcp *ca = inet_csk_ca(sk);\r\nca->ai = 0;\r\ntp->snd_cwnd_clamp = min_t(u32, tp->snd_cwnd_clamp, 0xffffffff/128);\r\n}\r\nstatic void hstcp_cong_avoid(struct sock *sk, u32 ack, u32 acked)\r\n{\r\nstruct tcp_sock *tp = tcp_sk(sk);\r\nstruct hstcp *ca = inet_csk_ca(sk);\r\nif (!tcp_is_cwnd_limited(sk))\r\nreturn;\r\nif (tcp_in_slow_start(tp))\r\ntcp_slow_start(tp, acked);\r\nelse {\r\nif (tp->snd_cwnd > hstcp_aimd_vals[ca->ai].cwnd) {\r\nwhile (tp->snd_cwnd > hstcp_aimd_vals[ca->ai].cwnd &&\r\nca->ai < HSTCP_AIMD_MAX - 1)\r\nca->ai++;\r\n} else if (ca->ai && tp->snd_cwnd <= hstcp_aimd_vals[ca->ai-1].cwnd) {\r\nwhile (ca->ai && tp->snd_cwnd <= hstcp_aimd_vals[ca->ai-1].cwnd)\r\nca->ai--;\r\n}\r\nif (tp->snd_cwnd < tp->snd_cwnd_clamp) {\r\ntp->snd_cwnd_cnt += ca->ai + 1;\r\nif (tp->snd_cwnd_cnt >= tp->snd_cwnd) {\r\ntp->snd_cwnd_cnt -= tp->snd_cwnd;\r\ntp->snd_cwnd++;\r\n}\r\n}\r\n}\r\n}\r\nstatic u32 hstcp_ssthresh(struct sock *sk)\r\n{\r\nconst struct tcp_sock *tp = tcp_sk(sk);\r\nconst struct hstcp *ca = inet_csk_ca(sk);\r\nreturn max(tp->snd_cwnd - ((tp->snd_cwnd * hstcp_aimd_vals[ca->ai].md) >> 8), 2U);\r\n}\r\nstatic int __init hstcp_register(void)\r\n{\r\nBUILD_BUG_ON(sizeof(struct hstcp) > ICSK_CA_PRIV_SIZE);\r\nreturn tcp_register_congestion_control(&tcp_highspeed);\r\n}\r\nstatic void __exit hstcp_unregister(void)\r\n{\r\ntcp_unregister_congestion_control(&tcp_highspeed);\r\n}

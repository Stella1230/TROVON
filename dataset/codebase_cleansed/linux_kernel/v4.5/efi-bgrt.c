void __init efi_bgrt_init(void)\r\n{\r\nacpi_status status;\r\nvoid __iomem *image;\r\nbool ioremapped = false;\r\nstruct bmp_header bmp_header;\r\nif (acpi_disabled)\r\nreturn;\r\nstatus = acpi_get_table("BGRT", 0,\r\n(struct acpi_table_header **)&bgrt_tab);\r\nif (ACPI_FAILURE(status))\r\nreturn;\r\nif (bgrt_tab->header.length < sizeof(*bgrt_tab)) {\r\npr_err("Ignoring BGRT: invalid length %u (expected %zu)\n",\r\nbgrt_tab->header.length, sizeof(*bgrt_tab));\r\nreturn;\r\n}\r\nif (bgrt_tab->version != 1) {\r\npr_err("Ignoring BGRT: invalid version %u (expected 1)\n",\r\nbgrt_tab->version);\r\nreturn;\r\n}\r\nif (bgrt_tab->status & 0xfe) {\r\npr_err("Ignoring BGRT: reserved status bits are non-zero %u\n",\r\nbgrt_tab->status);\r\nreturn;\r\n}\r\nif (bgrt_tab->status != 1) {\r\npr_debug("Ignoring BGRT: invalid status %u (expected 1)\n",\r\nbgrt_tab->status);\r\nreturn;\r\n}\r\nif (bgrt_tab->image_type != 0) {\r\npr_err("Ignoring BGRT: invalid image type %u (expected 0)\n",\r\nbgrt_tab->image_type);\r\nreturn;\r\n}\r\nif (!bgrt_tab->image_address) {\r\npr_err("Ignoring BGRT: null image address\n");\r\nreturn;\r\n}\r\nimage = efi_lookup_mapped_addr(bgrt_tab->image_address);\r\nif (!image) {\r\nimage = early_ioremap(bgrt_tab->image_address,\r\nsizeof(bmp_header));\r\nioremapped = true;\r\nif (!image) {\r\npr_err("Ignoring BGRT: failed to map image header memory\n");\r\nreturn;\r\n}\r\n}\r\nmemcpy_fromio(&bmp_header, image, sizeof(bmp_header));\r\nif (ioremapped)\r\nearly_iounmap(image, sizeof(bmp_header));\r\nbgrt_image_size = bmp_header.size;\r\nbgrt_image = kmalloc(bgrt_image_size, GFP_KERNEL | __GFP_NOWARN);\r\nif (!bgrt_image) {\r\npr_err("Ignoring BGRT: failed to allocate memory for image (wanted %zu bytes)\n",\r\nbgrt_image_size);\r\nreturn;\r\n}\r\nif (ioremapped) {\r\nimage = early_ioremap(bgrt_tab->image_address,\r\nbmp_header.size);\r\nif (!image) {\r\npr_err("Ignoring BGRT: failed to map image memory\n");\r\nkfree(bgrt_image);\r\nbgrt_image = NULL;\r\nreturn;\r\n}\r\n}\r\nmemcpy_fromio(bgrt_image, image, bgrt_image_size);\r\nif (ioremapped)\r\nearly_iounmap(image, bmp_header.size);\r\n}

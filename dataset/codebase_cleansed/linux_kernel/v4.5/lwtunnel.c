struct lwtunnel_state *lwtunnel_state_alloc(int encap_len)\r\n{\r\nstruct lwtunnel_state *lws;\r\nlws = kzalloc(sizeof(*lws) + encap_len, GFP_ATOMIC);\r\nreturn lws;\r\n}\r\nint lwtunnel_encap_add_ops(const struct lwtunnel_encap_ops *ops,\r\nunsigned int num)\r\n{\r\nif (num > LWTUNNEL_ENCAP_MAX)\r\nreturn -ERANGE;\r\nreturn !cmpxchg((const struct lwtunnel_encap_ops **)\r\n&lwtun_encaps[num],\r\nNULL, ops) ? 0 : -1;\r\n}\r\nint lwtunnel_encap_del_ops(const struct lwtunnel_encap_ops *ops,\r\nunsigned int encap_type)\r\n{\r\nint ret;\r\nif (encap_type == LWTUNNEL_ENCAP_NONE ||\r\nencap_type > LWTUNNEL_ENCAP_MAX)\r\nreturn -ERANGE;\r\nret = (cmpxchg((const struct lwtunnel_encap_ops **)\r\n&lwtun_encaps[encap_type],\r\nops, NULL) == ops) ? 0 : -1;\r\nsynchronize_net();\r\nreturn ret;\r\n}\r\nint lwtunnel_build_state(struct net_device *dev, u16 encap_type,\r\nstruct nlattr *encap, unsigned int family,\r\nconst void *cfg, struct lwtunnel_state **lws)\r\n{\r\nconst struct lwtunnel_encap_ops *ops;\r\nint ret = -EINVAL;\r\nif (encap_type == LWTUNNEL_ENCAP_NONE ||\r\nencap_type > LWTUNNEL_ENCAP_MAX)\r\nreturn ret;\r\nret = -EOPNOTSUPP;\r\nrcu_read_lock();\r\nops = rcu_dereference(lwtun_encaps[encap_type]);\r\nif (likely(ops && ops->build_state))\r\nret = ops->build_state(dev, encap, family, cfg, lws);\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nint lwtunnel_fill_encap(struct sk_buff *skb, struct lwtunnel_state *lwtstate)\r\n{\r\nconst struct lwtunnel_encap_ops *ops;\r\nstruct nlattr *nest;\r\nint ret = -EINVAL;\r\nif (!lwtstate)\r\nreturn 0;\r\nif (lwtstate->type == LWTUNNEL_ENCAP_NONE ||\r\nlwtstate->type > LWTUNNEL_ENCAP_MAX)\r\nreturn 0;\r\nret = -EOPNOTSUPP;\r\nnest = nla_nest_start(skb, RTA_ENCAP);\r\nrcu_read_lock();\r\nops = rcu_dereference(lwtun_encaps[lwtstate->type]);\r\nif (likely(ops && ops->fill_encap))\r\nret = ops->fill_encap(skb, lwtstate);\r\nrcu_read_unlock();\r\nif (ret)\r\ngoto nla_put_failure;\r\nnla_nest_end(skb, nest);\r\nret = nla_put_u16(skb, RTA_ENCAP_TYPE, lwtstate->type);\r\nif (ret)\r\ngoto nla_put_failure;\r\nreturn 0;\r\nnla_put_failure:\r\nnla_nest_cancel(skb, nest);\r\nreturn (ret == -EOPNOTSUPP ? 0 : ret);\r\n}\r\nint lwtunnel_get_encap_size(struct lwtunnel_state *lwtstate)\r\n{\r\nconst struct lwtunnel_encap_ops *ops;\r\nint ret = 0;\r\nif (!lwtstate)\r\nreturn 0;\r\nif (lwtstate->type == LWTUNNEL_ENCAP_NONE ||\r\nlwtstate->type > LWTUNNEL_ENCAP_MAX)\r\nreturn 0;\r\nrcu_read_lock();\r\nops = rcu_dereference(lwtun_encaps[lwtstate->type]);\r\nif (likely(ops && ops->get_encap_size))\r\nret = nla_total_size(ops->get_encap_size(lwtstate));\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nint lwtunnel_cmp_encap(struct lwtunnel_state *a, struct lwtunnel_state *b)\r\n{\r\nconst struct lwtunnel_encap_ops *ops;\r\nint ret = 0;\r\nif (!a && !b)\r\nreturn 0;\r\nif (!a || !b)\r\nreturn 1;\r\nif (a->type != b->type)\r\nreturn 1;\r\nif (a->type == LWTUNNEL_ENCAP_NONE ||\r\na->type > LWTUNNEL_ENCAP_MAX)\r\nreturn 0;\r\nrcu_read_lock();\r\nops = rcu_dereference(lwtun_encaps[a->type]);\r\nif (likely(ops && ops->cmp_encap))\r\nret = ops->cmp_encap(a, b);\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nint lwtunnel_output(struct net *net, struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct dst_entry *dst = skb_dst(skb);\r\nconst struct lwtunnel_encap_ops *ops;\r\nstruct lwtunnel_state *lwtstate;\r\nint ret = -EINVAL;\r\nif (!dst)\r\ngoto drop;\r\nlwtstate = dst->lwtstate;\r\nif (lwtstate->type == LWTUNNEL_ENCAP_NONE ||\r\nlwtstate->type > LWTUNNEL_ENCAP_MAX)\r\nreturn 0;\r\nret = -EOPNOTSUPP;\r\nrcu_read_lock();\r\nops = rcu_dereference(lwtun_encaps[lwtstate->type]);\r\nif (likely(ops && ops->output))\r\nret = ops->output(net, sk, skb);\r\nrcu_read_unlock();\r\nif (ret == -EOPNOTSUPP)\r\ngoto drop;\r\nreturn ret;\r\ndrop:\r\nkfree_skb(skb);\r\nreturn ret;\r\n}\r\nint lwtunnel_input(struct sk_buff *skb)\r\n{\r\nstruct dst_entry *dst = skb_dst(skb);\r\nconst struct lwtunnel_encap_ops *ops;\r\nstruct lwtunnel_state *lwtstate;\r\nint ret = -EINVAL;\r\nif (!dst)\r\ngoto drop;\r\nlwtstate = dst->lwtstate;\r\nif (lwtstate->type == LWTUNNEL_ENCAP_NONE ||\r\nlwtstate->type > LWTUNNEL_ENCAP_MAX)\r\nreturn 0;\r\nret = -EOPNOTSUPP;\r\nrcu_read_lock();\r\nops = rcu_dereference(lwtun_encaps[lwtstate->type]);\r\nif (likely(ops && ops->input))\r\nret = ops->input(skb);\r\nrcu_read_unlock();\r\nif (ret == -EOPNOTSUPP)\r\ngoto drop;\r\nreturn ret;\r\ndrop:\r\nkfree_skb(skb);\r\nreturn ret;\r\n}

static int _hid_sensor_power_state(struct hid_sensor_common *st, bool state)\r\n{\r\nint state_val;\r\nint report_val;\r\ns32 poll_value = 0;\r\nif (state) {\r\nif (!atomic_read(&st->user_requested_state))\r\nreturn 0;\r\nif (sensor_hub_device_open(st->hsdev))\r\nreturn -EIO;\r\natomic_inc(&st->data_ready);\r\nstate_val = hid_sensor_get_usage_index(st->hsdev,\r\nst->power_state.report_id,\r\nst->power_state.index,\r\nHID_USAGE_SENSOR_PROP_POWER_STATE_D0_FULL_POWER_ENUM);\r\nreport_val = hid_sensor_get_usage_index(st->hsdev,\r\nst->report_state.report_id,\r\nst->report_state.index,\r\nHID_USAGE_SENSOR_PROP_REPORTING_STATE_ALL_EVENTS_ENUM);\r\npoll_value = hid_sensor_read_poll_value(st);\r\n} else {\r\nint val;\r\nval = atomic_dec_if_positive(&st->data_ready);\r\nif (val < 0)\r\nreturn 0;\r\nsensor_hub_device_close(st->hsdev);\r\nstate_val = hid_sensor_get_usage_index(st->hsdev,\r\nst->power_state.report_id,\r\nst->power_state.index,\r\nHID_USAGE_SENSOR_PROP_POWER_STATE_D4_POWER_OFF_ENUM);\r\nreport_val = hid_sensor_get_usage_index(st->hsdev,\r\nst->report_state.report_id,\r\nst->report_state.index,\r\nHID_USAGE_SENSOR_PROP_REPORTING_STATE_NO_EVENTS_ENUM);\r\n}\r\nif (state_val >= 0) {\r\nstate_val += st->power_state.logical_minimum;\r\nsensor_hub_set_feature(st->hsdev, st->power_state.report_id,\r\nst->power_state.index, sizeof(state_val),\r\n&state_val);\r\n}\r\nif (report_val >= 0) {\r\nreport_val += st->report_state.logical_minimum;\r\nsensor_hub_set_feature(st->hsdev, st->report_state.report_id,\r\nst->report_state.index,\r\nsizeof(report_val),\r\n&report_val);\r\n}\r\nsensor_hub_get_feature(st->hsdev, st->power_state.report_id,\r\nst->power_state.index,\r\nsizeof(state_val), &state_val);\r\nif (state && poll_value)\r\nmsleep_interruptible(poll_value * 2);\r\nreturn 0;\r\n}\r\nint hid_sensor_power_state(struct hid_sensor_common *st, bool state)\r\n{\r\n#ifdef CONFIG_PM\r\nint ret;\r\natomic_set(&st->user_requested_state, state);\r\nif (state)\r\nret = pm_runtime_get_sync(&st->pdev->dev);\r\nelse {\r\npm_runtime_mark_last_busy(&st->pdev->dev);\r\nret = pm_runtime_put_autosuspend(&st->pdev->dev);\r\n}\r\nif (ret < 0) {\r\nif (state)\r\npm_runtime_put_noidle(&st->pdev->dev);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n#else\r\natomic_set(&st->user_requested_state, state);\r\nreturn _hid_sensor_power_state(st, state);\r\n#endif\r\n}\r\nstatic int hid_sensor_data_rdy_trigger_set_state(struct iio_trigger *trig,\r\nbool state)\r\n{\r\nreturn hid_sensor_power_state(iio_trigger_get_drvdata(trig), state);\r\n}\r\nvoid hid_sensor_remove_trigger(struct hid_sensor_common *attrb)\r\n{\r\niio_trigger_unregister(attrb->trigger);\r\niio_trigger_free(attrb->trigger);\r\n}\r\nint hid_sensor_setup_trigger(struct iio_dev *indio_dev, const char *name,\r\nstruct hid_sensor_common *attrb)\r\n{\r\nint ret;\r\nstruct iio_trigger *trig;\r\ntrig = iio_trigger_alloc("%s-dev%d", name, indio_dev->id);\r\nif (trig == NULL) {\r\ndev_err(&indio_dev->dev, "Trigger Allocate Failed\n");\r\nret = -ENOMEM;\r\ngoto error_ret;\r\n}\r\ntrig->dev.parent = indio_dev->dev.parent;\r\niio_trigger_set_drvdata(trig, attrb);\r\ntrig->ops = &hid_sensor_trigger_ops;\r\nret = iio_trigger_register(trig);\r\nif (ret) {\r\ndev_err(&indio_dev->dev, "Trigger Register Failed\n");\r\ngoto error_free_trig;\r\n}\r\nattrb->trigger = trig;\r\nindio_dev->trig = iio_trigger_get(trig);\r\nret = pm_runtime_set_active(&indio_dev->dev);\r\nif (ret)\r\ngoto error_unreg_trigger;\r\niio_device_set_drvdata(indio_dev, attrb);\r\npm_suspend_ignore_children(&attrb->pdev->dev, true);\r\npm_runtime_enable(&attrb->pdev->dev);\r\npm_runtime_set_autosuspend_delay(&attrb->pdev->dev,\r\n3000);\r\npm_runtime_use_autosuspend(&attrb->pdev->dev);\r\nreturn ret;\r\nerror_unreg_trigger:\r\niio_trigger_unregister(trig);\r\nerror_free_trig:\r\niio_trigger_free(trig);\r\nerror_ret:\r\nreturn ret;\r\n}\r\nstatic int hid_sensor_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct iio_dev *indio_dev = platform_get_drvdata(pdev);\r\nstruct hid_sensor_common *attrb = iio_device_get_drvdata(indio_dev);\r\nreturn _hid_sensor_power_state(attrb, false);\r\n}\r\nstatic int hid_sensor_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct iio_dev *indio_dev = platform_get_drvdata(pdev);\r\nstruct hid_sensor_common *attrb = iio_device_get_drvdata(indio_dev);\r\nreturn _hid_sensor_power_state(attrb, true);\r\n}

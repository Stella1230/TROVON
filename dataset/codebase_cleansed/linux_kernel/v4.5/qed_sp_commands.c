int qed_sp_init_request(struct qed_hwfn *p_hwfn,\r\nstruct qed_spq_entry **pp_ent,\r\nu32 cid,\r\nu16 opaque_fid,\r\nu8 cmd,\r\nu8 protocol,\r\nstruct qed_sp_init_request_params *p_params)\r\n{\r\nint rc = -EINVAL;\r\nstruct qed_spq_entry *p_ent = NULL;\r\nu32 opaque_cid = opaque_fid << 16 | cid;\r\nif (!pp_ent)\r\nreturn -ENOMEM;\r\nrc = qed_spq_get_entry(p_hwfn, pp_ent);\r\nif (rc != 0)\r\nreturn rc;\r\np_ent = *pp_ent;\r\np_ent->elem.hdr.cid = cpu_to_le32(opaque_cid);\r\np_ent->elem.hdr.cmd_id = cmd;\r\np_ent->elem.hdr.protocol_id = protocol;\r\np_ent->priority = QED_SPQ_PRIORITY_NORMAL;\r\np_ent->comp_mode = p_params->comp_mode;\r\np_ent->comp_done.done = 0;\r\nswitch (p_ent->comp_mode) {\r\ncase QED_SPQ_MODE_EBLOCK:\r\np_ent->comp_cb.cookie = &p_ent->comp_done;\r\nbreak;\r\ncase QED_SPQ_MODE_BLOCK:\r\nif (!p_params->p_comp_data)\r\nreturn -EINVAL;\r\np_ent->comp_cb.cookie = p_params->p_comp_data->cookie;\r\nbreak;\r\ncase QED_SPQ_MODE_CB:\r\nif (!p_params->p_comp_data)\r\np_ent->comp_cb.function = NULL;\r\nelse\r\np_ent->comp_cb = *p_params->p_comp_data;\r\nbreak;\r\ndefault:\r\nDP_NOTICE(p_hwfn, "Unknown SPQE completion mode %d\n",\r\np_ent->comp_mode);\r\nreturn -EINVAL;\r\n}\r\nDP_VERBOSE(p_hwfn, QED_MSG_SPQ,\r\n"Initialized: CID %08x cmd %02x protocol %02x data_addr %lu comp_mode [%s]\n",\r\nopaque_cid, cmd, protocol,\r\n(unsigned long)&p_ent->ramrod,\r\nD_TRINE(p_ent->comp_mode, QED_SPQ_MODE_EBLOCK,\r\nQED_SPQ_MODE_BLOCK, "MODE_EBLOCK", "MODE_BLOCK",\r\n"MODE_CB"));\r\nif (p_params->ramrod_data_size)\r\nmemset(&p_ent->ramrod, 0, p_params->ramrod_data_size);\r\nreturn 0;\r\n}\r\nint qed_sp_pf_start(struct qed_hwfn *p_hwfn,\r\nenum mf_mode mode)\r\n{\r\nstruct qed_sp_init_request_params params;\r\nstruct pf_start_ramrod_data *p_ramrod = NULL;\r\nu16 sb = qed_int_get_sp_sb_id(p_hwfn);\r\nu8 sb_index = p_hwfn->p_eq->eq_sb_index;\r\nstruct qed_spq_entry *p_ent = NULL;\r\nint rc = -EINVAL;\r\nqed_eq_prod_update(p_hwfn,\r\nqed_chain_get_prod_idx(&p_hwfn->p_eq->chain));\r\nmemset(&params, 0, sizeof(params));\r\nparams.ramrod_data_size = sizeof(*p_ramrod);\r\nparams.comp_mode = QED_SPQ_MODE_EBLOCK;\r\nrc = qed_sp_init_request(p_hwfn,\r\n&p_ent,\r\nqed_spq_get_cid(p_hwfn),\r\np_hwfn->hw_info.opaque_fid,\r\nCOMMON_RAMROD_PF_START,\r\nPROTOCOLID_COMMON,\r\n&params);\r\nif (rc)\r\nreturn rc;\r\np_ramrod = &p_ent->ramrod.pf_start;\r\np_ramrod->event_ring_sb_id = cpu_to_le16(sb);\r\np_ramrod->event_ring_sb_index = sb_index;\r\np_ramrod->path_id = QED_PATH_ID(p_hwfn);\r\np_ramrod->dont_log_ramrods = 0;\r\np_ramrod->log_type_mask = cpu_to_le16(0xf);\r\np_ramrod->mf_mode = mode;\r\np_ramrod->outer_tag = p_hwfn->hw_info.ovlan;\r\np_ramrod->event_ring_pbl_addr.hi =\r\nDMA_HI_LE(p_hwfn->p_eq->chain.pbl.p_phys_table);\r\np_ramrod->event_ring_pbl_addr.lo =\r\nDMA_LO_LE(p_hwfn->p_eq->chain.pbl.p_phys_table);\r\np_ramrod->event_ring_num_pages = (u8)p_hwfn->p_eq->chain.page_cnt;\r\np_ramrod->consolid_q_pbl_addr.hi =\r\nDMA_HI_LE(p_hwfn->p_consq->chain.pbl.p_phys_table);\r\np_ramrod->consolid_q_pbl_addr.lo =\r\nDMA_LO_LE(p_hwfn->p_consq->chain.pbl.p_phys_table);\r\np_hwfn->hw_info.personality = PERSONALITY_ETH;\r\nDP_VERBOSE(p_hwfn, QED_MSG_SPQ,\r\n"Setting event_ring_sb [id %04x index %02x], mf [%s] outer_tag [%d]\n",\r\nsb, sb_index,\r\n(p_ramrod->mf_mode == SF) ? "SF" : "Multi-Pf",\r\np_ramrod->outer_tag);\r\nreturn qed_spq_post(p_hwfn, p_ent, NULL);\r\n}\r\nint qed_sp_pf_stop(struct qed_hwfn *p_hwfn)\r\n{\r\nstruct qed_sp_init_request_params params;\r\nstruct qed_spq_entry *p_ent = NULL;\r\nint rc = -EINVAL;\r\nmemset(&params, 0, sizeof(params));\r\nparams.comp_mode = QED_SPQ_MODE_EBLOCK;\r\nrc = qed_sp_init_request(p_hwfn, &p_ent, qed_spq_get_cid(p_hwfn),\r\np_hwfn->hw_info.opaque_fid,\r\nCOMMON_RAMROD_PF_STOP, PROTOCOLID_COMMON,\r\n&params);\r\nif (rc)\r\nreturn rc;\r\nreturn qed_spq_post(p_hwfn, p_ent, NULL);\r\n}

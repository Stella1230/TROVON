static int __init mcp_write_pairing_set(void)\r\n{\r\nu32 creds = 0;\r\nif (!cpubiuctrl_base)\r\nreturn -1;\r\ncreds = readl_relaxed(cpubiuctrl_base + CPU_CREDIT_REG_OFFSET);\r\nif (mcp_wr_pairing_en) {\r\npr_info("MCP: Enabling write pairing\n");\r\nwritel_relaxed(creds | CPU_CREDIT_REG_MCPx_WR_PAIRING_EN_MASK,\r\ncpubiuctrl_base + CPU_CREDIT_REG_OFFSET);\r\n} else if (creds & CPU_CREDIT_REG_MCPx_WR_PAIRING_EN_MASK) {\r\npr_info("MCP: Disabling write pairing\n");\r\nwritel_relaxed(creds & ~CPU_CREDIT_REG_MCPx_WR_PAIRING_EN_MASK,\r\ncpubiuctrl_base + CPU_CREDIT_REG_OFFSET);\r\n} else {\r\npr_info("MCP: Write pairing already disabled\n");\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init setup_hifcpubiuctrl_regs(void)\r\n{\r\nstruct device_node *np;\r\nint ret = 0;\r\nnp = of_find_compatible_node(NULL, NULL, "brcm,brcmstb-cpu-biu-ctrl");\r\nif (!np) {\r\npr_err("missing BIU control node\n");\r\nreturn -ENODEV;\r\n}\r\ncpubiuctrl_base = of_iomap(np, 0);\r\nif (!cpubiuctrl_base) {\r\npr_err("failed to remap BIU control base\n");\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nmcp_wr_pairing_en = of_property_read_bool(np, "brcm,write-pairing");\r\nout:\r\nof_node_put(np);\r\nreturn ret;\r\n}\r\nstatic int brcmstb_cpu_credit_reg_suspend(void)\r\n{\r\nif (cpubiuctrl_base)\r\ncpu_credit_reg_dump =\r\nreadl_relaxed(cpubiuctrl_base + CPU_CREDIT_REG_OFFSET);\r\nreturn 0;\r\n}\r\nstatic void brcmstb_cpu_credit_reg_resume(void)\r\n{\r\nif (cpubiuctrl_base)\r\nwritel_relaxed(cpu_credit_reg_dump,\r\ncpubiuctrl_base + CPU_CREDIT_REG_OFFSET);\r\n}\r\nvoid __init brcmstb_biuctrl_init(void)\r\n{\r\nint ret;\r\nsetup_hifcpubiuctrl_regs();\r\nret = mcp_write_pairing_set();\r\nif (ret) {\r\npr_err("MCP: Unable to disable write pairing!\n");\r\nreturn;\r\n}\r\n#ifdef CONFIG_PM_SLEEP\r\nregister_syscore_ops(&brcmstb_cpu_credit_syscore_ops);\r\n#endif\r\n}

static int __init sim_console(char *str)\r\n{\r\nuse_sim_console = 1;\r\nreturn 0;\r\n}\r\nint tile_console_write(const char *buf, int count)\r\n{\r\nif (unlikely(use_sim_console)) {\r\nint i;\r\nfor (i = 0; i < count; ++i)\r\n__insn_mtspr(SPR_SIM_CONTROL, SIM_CONTROL_PUTC |\r\n(buf[i] << _SIM_CONTROL_OPERATOR_BITS));\r\n__insn_mtspr(SPR_SIM_CONTROL, SIM_CONTROL_PUTC |\r\n(SIM_PUTC_FLUSH_BINARY <<\r\n_SIM_CONTROL_OPERATOR_BITS));\r\nreturn 0;\r\n} else {\r\nreturn hv_console_write((HV_VirtAddr)buf, count) ?: -EAGAIN;\r\n}\r\n}\r\nstatic int hvc_tile_put_chars(uint32_t vt, const char *buf, int count)\r\n{\r\nreturn tile_console_write(buf, count);\r\n}\r\nstatic int hvc_tile_get_chars(uint32_t vt, char *buf, int count)\r\n{\r\nint i, c;\r\nfor (i = 0; i < count; ++i) {\r\nc = hv_console_read_if_ready();\r\nif (c < 0)\r\nbreak;\r\nbuf[i] = c;\r\n}\r\nreturn i;\r\n}\r\nstatic int hvc_tile_notifier_add_irq(struct hvc_struct *hp, int irq)\r\n{\r\nint rc;\r\nint cpu = raw_smp_processor_id();\r\nHV_Coord coord = { .x = cpu_x(cpu), .y = cpu_y(cpu) };\r\nrc = notifier_add_irq(hp, irq);\r\nif (rc)\r\nreturn rc;\r\nif (hv_console_set_ipi(KERNEL_PL, irq, coord) < 0)\r\nnotifier_del_irq(hp, irq);\r\nreturn 0;\r\n}\r\nstatic void hvc_tile_notifier_del_irq(struct hvc_struct *hp, int irq)\r\n{\r\nHV_Coord coord = { 0, 0 };\r\nhv_console_set_ipi(KERNEL_PL, -1, coord);\r\nnotifier_del_irq(hp, irq);\r\n}\r\nstatic void hvc_tile_notifier_hangup_irq(struct hvc_struct *hp, int irq)\r\n{\r\nhvc_tile_notifier_del_irq(hp, irq);\r\n}\r\nstatic int hvc_tile_probe(struct platform_device *pdev)\r\n{\r\nstruct hvc_struct *hp;\r\nint tile_hvc_irq;\r\ntile_hvc_irq = irq_alloc_hwirq(-1);\r\nif (!tile_hvc_irq)\r\nreturn -ENXIO;\r\ntile_irq_activate(tile_hvc_irq, TILE_IRQ_PERCPU);\r\nhp = hvc_alloc(0, tile_hvc_irq, &hvc_tile_get_put_ops, 128);\r\nif (IS_ERR(hp)) {\r\nirq_free_hwirq(tile_hvc_irq);\r\nreturn PTR_ERR(hp);\r\n}\r\ndev_set_drvdata(&pdev->dev, hp);\r\nreturn 0;\r\n}\r\nstatic int hvc_tile_remove(struct platform_device *pdev)\r\n{\r\nint rc;\r\nstruct hvc_struct *hp = dev_get_drvdata(&pdev->dev);\r\nrc = hvc_remove(hp);\r\nif (rc == 0)\r\nirq_free_hwirq(hp->data);\r\nreturn rc;\r\n}\r\nstatic void hvc_tile_shutdown(struct platform_device *pdev)\r\n{\r\nstruct hvc_struct *hp = dev_get_drvdata(&pdev->dev);\r\nhvc_tile_notifier_del_irq(hp, hp->data);\r\n}\r\nstatic int __init hvc_tile_console_init(void)\r\n{\r\nhvc_instantiate(0, 0, &hvc_tile_get_put_ops);\r\nadd_preferred_console("hvc", 0, NULL);\r\nreturn 0;\r\n}\r\nstatic int __init hvc_tile_init(void)\r\n{\r\n#ifndef __tilegx__\r\nstruct hvc_struct *hp;\r\nhp = hvc_alloc(0, 0, &hvc_tile_get_put_ops, 128);\r\nreturn PTR_ERR_OR_ZERO(hp);\r\n#else\r\nplatform_device_register(&hvc_tile_pdev);\r\nreturn platform_driver_register(&hvc_tile_driver);\r\n#endif\r\n}

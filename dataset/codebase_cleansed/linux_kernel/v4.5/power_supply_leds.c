static void power_supply_update_bat_leds(struct power_supply *psy)\r\n{\r\nunion power_supply_propval status;\r\nunsigned long delay_on = 0;\r\nunsigned long delay_off = 0;\r\nif (power_supply_get_property(psy, POWER_SUPPLY_PROP_STATUS, &status))\r\nreturn;\r\ndev_dbg(&psy->dev, "%s %d\n", __func__, status.intval);\r\nswitch (status.intval) {\r\ncase POWER_SUPPLY_STATUS_FULL:\r\nled_trigger_event(psy->charging_full_trig, LED_FULL);\r\nled_trigger_event(psy->charging_trig, LED_OFF);\r\nled_trigger_event(psy->full_trig, LED_FULL);\r\nled_trigger_event(psy->charging_blink_full_solid_trig,\r\nLED_FULL);\r\nbreak;\r\ncase POWER_SUPPLY_STATUS_CHARGING:\r\nled_trigger_event(psy->charging_full_trig, LED_FULL);\r\nled_trigger_event(psy->charging_trig, LED_FULL);\r\nled_trigger_event(psy->full_trig, LED_OFF);\r\nled_trigger_blink(psy->charging_blink_full_solid_trig,\r\n&delay_on, &delay_off);\r\nbreak;\r\ndefault:\r\nled_trigger_event(psy->charging_full_trig, LED_OFF);\r\nled_trigger_event(psy->charging_trig, LED_OFF);\r\nled_trigger_event(psy->full_trig, LED_OFF);\r\nled_trigger_event(psy->charging_blink_full_solid_trig,\r\nLED_OFF);\r\nbreak;\r\n}\r\n}\r\nstatic int power_supply_create_bat_triggers(struct power_supply *psy)\r\n{\r\npsy->charging_full_trig_name = kasprintf(GFP_KERNEL,\r\n"%s-charging-or-full", psy->desc->name);\r\nif (!psy->charging_full_trig_name)\r\ngoto charging_full_failed;\r\npsy->charging_trig_name = kasprintf(GFP_KERNEL,\r\n"%s-charging", psy->desc->name);\r\nif (!psy->charging_trig_name)\r\ngoto charging_failed;\r\npsy->full_trig_name = kasprintf(GFP_KERNEL, "%s-full", psy->desc->name);\r\nif (!psy->full_trig_name)\r\ngoto full_failed;\r\npsy->charging_blink_full_solid_trig_name = kasprintf(GFP_KERNEL,\r\n"%s-charging-blink-full-solid", psy->desc->name);\r\nif (!psy->charging_blink_full_solid_trig_name)\r\ngoto charging_blink_full_solid_failed;\r\nled_trigger_register_simple(psy->charging_full_trig_name,\r\n&psy->charging_full_trig);\r\nled_trigger_register_simple(psy->charging_trig_name,\r\n&psy->charging_trig);\r\nled_trigger_register_simple(psy->full_trig_name,\r\n&psy->full_trig);\r\nled_trigger_register_simple(psy->charging_blink_full_solid_trig_name,\r\n&psy->charging_blink_full_solid_trig);\r\nreturn 0;\r\ncharging_blink_full_solid_failed:\r\nkfree(psy->full_trig_name);\r\nfull_failed:\r\nkfree(psy->charging_trig_name);\r\ncharging_failed:\r\nkfree(psy->charging_full_trig_name);\r\ncharging_full_failed:\r\nreturn -ENOMEM;\r\n}\r\nstatic void power_supply_remove_bat_triggers(struct power_supply *psy)\r\n{\r\nled_trigger_unregister_simple(psy->charging_full_trig);\r\nled_trigger_unregister_simple(psy->charging_trig);\r\nled_trigger_unregister_simple(psy->full_trig);\r\nled_trigger_unregister_simple(psy->charging_blink_full_solid_trig);\r\nkfree(psy->charging_blink_full_solid_trig_name);\r\nkfree(psy->full_trig_name);\r\nkfree(psy->charging_trig_name);\r\nkfree(psy->charging_full_trig_name);\r\n}\r\nstatic void power_supply_update_gen_leds(struct power_supply *psy)\r\n{\r\nunion power_supply_propval online;\r\nif (power_supply_get_property(psy, POWER_SUPPLY_PROP_ONLINE, &online))\r\nreturn;\r\ndev_dbg(&psy->dev, "%s %d\n", __func__, online.intval);\r\nif (online.intval)\r\nled_trigger_event(psy->online_trig, LED_FULL);\r\nelse\r\nled_trigger_event(psy->online_trig, LED_OFF);\r\n}\r\nstatic int power_supply_create_gen_triggers(struct power_supply *psy)\r\n{\r\npsy->online_trig_name = kasprintf(GFP_KERNEL, "%s-online",\r\npsy->desc->name);\r\nif (!psy->online_trig_name)\r\nreturn -ENOMEM;\r\nled_trigger_register_simple(psy->online_trig_name, &psy->online_trig);\r\nreturn 0;\r\n}\r\nstatic void power_supply_remove_gen_triggers(struct power_supply *psy)\r\n{\r\nled_trigger_unregister_simple(psy->online_trig);\r\nkfree(psy->online_trig_name);\r\n}\r\nvoid power_supply_update_leds(struct power_supply *psy)\r\n{\r\nif (psy->desc->type == POWER_SUPPLY_TYPE_BATTERY)\r\npower_supply_update_bat_leds(psy);\r\nelse\r\npower_supply_update_gen_leds(psy);\r\n}\r\nint power_supply_create_triggers(struct power_supply *psy)\r\n{\r\nif (psy->desc->type == POWER_SUPPLY_TYPE_BATTERY)\r\nreturn power_supply_create_bat_triggers(psy);\r\nreturn power_supply_create_gen_triggers(psy);\r\n}\r\nvoid power_supply_remove_triggers(struct power_supply *psy)\r\n{\r\nif (psy->desc->type == POWER_SUPPLY_TYPE_BATTERY)\r\npower_supply_remove_bat_triggers(psy);\r\nelse\r\npower_supply_remove_gen_triggers(psy);\r\n}

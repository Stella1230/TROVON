int logfs_compress(void *in, void *out, size_t inlen, size_t outlen)\r\n{\r\nint err, ret;\r\nret = -EIO;\r\nmutex_lock(&compr_mutex);\r\nerr = zlib_deflateInit(&stream, COMPR_LEVEL);\r\nif (err != Z_OK)\r\ngoto error;\r\nstream.next_in = in;\r\nstream.avail_in = inlen;\r\nstream.total_in = 0;\r\nstream.next_out = out;\r\nstream.avail_out = outlen;\r\nstream.total_out = 0;\r\nerr = zlib_deflate(&stream, Z_FINISH);\r\nif (err != Z_STREAM_END)\r\ngoto error;\r\nerr = zlib_deflateEnd(&stream);\r\nif (err != Z_OK)\r\ngoto error;\r\nif (stream.total_out >= stream.total_in)\r\ngoto error;\r\nret = stream.total_out;\r\nerror:\r\nmutex_unlock(&compr_mutex);\r\nreturn ret;\r\n}\r\nint logfs_uncompress(void *in, void *out, size_t inlen, size_t outlen)\r\n{\r\nint err, ret;\r\nret = -EIO;\r\nmutex_lock(&compr_mutex);\r\nerr = zlib_inflateInit(&stream);\r\nif (err != Z_OK)\r\ngoto error;\r\nstream.next_in = in;\r\nstream.avail_in = inlen;\r\nstream.total_in = 0;\r\nstream.next_out = out;\r\nstream.avail_out = outlen;\r\nstream.total_out = 0;\r\nerr = zlib_inflate(&stream, Z_FINISH);\r\nif (err != Z_STREAM_END)\r\ngoto error;\r\nerr = zlib_inflateEnd(&stream);\r\nif (err != Z_OK)\r\ngoto error;\r\nret = 0;\r\nerror:\r\nmutex_unlock(&compr_mutex);\r\nreturn ret;\r\n}\r\nint __init logfs_compr_init(void)\r\n{\r\nsize_t size = max(zlib_deflate_workspacesize(MAX_WBITS, MAX_MEM_LEVEL),\r\nzlib_inflate_workspacesize());\r\nstream.workspace = vmalloc(size);\r\nif (!stream.workspace)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nvoid logfs_compr_exit(void)\r\n{\r\nvfree(stream.workspace);\r\n}

static inline void omapbl_send_intensity(int intensity)\r\n{\r\nomap_writeb(intensity, OMAP_PWL_ENABLE);\r\n}\r\nstatic inline void omapbl_send_enable(int enable)\r\n{\r\nomap_writeb(enable, OMAP_PWL_CLK_ENABLE);\r\n}\r\nstatic void omapbl_blank(struct omap_backlight *bl, int mode)\r\n{\r\nif (bl->pdata->set_power)\r\nbl->pdata->set_power(bl->dev, mode);\r\nswitch (mode) {\r\ncase FB_BLANK_NORMAL:\r\ncase FB_BLANK_VSYNC_SUSPEND:\r\ncase FB_BLANK_HSYNC_SUSPEND:\r\ncase FB_BLANK_POWERDOWN:\r\nomapbl_send_intensity(0);\r\nomapbl_send_enable(0);\r\nbreak;\r\ncase FB_BLANK_UNBLANK:\r\nomapbl_send_intensity(bl->current_intensity);\r\nomapbl_send_enable(1);\r\nbreak;\r\n}\r\n}\r\nstatic int omapbl_suspend(struct device *dev)\r\n{\r\nstruct backlight_device *bl_dev = dev_get_drvdata(dev);\r\nstruct omap_backlight *bl = bl_get_data(bl_dev);\r\nomapbl_blank(bl, FB_BLANK_POWERDOWN);\r\nreturn 0;\r\n}\r\nstatic int omapbl_resume(struct device *dev)\r\n{\r\nstruct backlight_device *bl_dev = dev_get_drvdata(dev);\r\nstruct omap_backlight *bl = bl_get_data(bl_dev);\r\nomapbl_blank(bl, bl->powermode);\r\nreturn 0;\r\n}\r\nstatic int omapbl_set_power(struct backlight_device *dev, int state)\r\n{\r\nstruct omap_backlight *bl = bl_get_data(dev);\r\nomapbl_blank(bl, state);\r\nbl->powermode = state;\r\nreturn 0;\r\n}\r\nstatic int omapbl_update_status(struct backlight_device *dev)\r\n{\r\nstruct omap_backlight *bl = bl_get_data(dev);\r\nif (bl->current_intensity != dev->props.brightness) {\r\nif (bl->powermode == FB_BLANK_UNBLANK)\r\nomapbl_send_intensity(dev->props.brightness);\r\nbl->current_intensity = dev->props.brightness;\r\n}\r\nif (dev->props.fb_blank != bl->powermode)\r\nomapbl_set_power(dev, dev->props.fb_blank);\r\nreturn 0;\r\n}\r\nstatic int omapbl_get_intensity(struct backlight_device *dev)\r\n{\r\nstruct omap_backlight *bl = bl_get_data(dev);\r\nreturn bl->current_intensity;\r\n}\r\nstatic int omapbl_probe(struct platform_device *pdev)\r\n{\r\nstruct backlight_properties props;\r\nstruct backlight_device *dev;\r\nstruct omap_backlight *bl;\r\nstruct omap_backlight_config *pdata = dev_get_platdata(&pdev->dev);\r\nif (!pdata)\r\nreturn -ENXIO;\r\nbl = devm_kzalloc(&pdev->dev, sizeof(struct omap_backlight),\r\nGFP_KERNEL);\r\nif (unlikely(!bl))\r\nreturn -ENOMEM;\r\nmemset(&props, 0, sizeof(struct backlight_properties));\r\nprops.type = BACKLIGHT_RAW;\r\nprops.max_brightness = OMAPBL_MAX_INTENSITY;\r\ndev = devm_backlight_device_register(&pdev->dev, "omap-bl", &pdev->dev,\r\nbl, &omapbl_ops, &props);\r\nif (IS_ERR(dev))\r\nreturn PTR_ERR(dev);\r\nbl->powermode = FB_BLANK_POWERDOWN;\r\nbl->current_intensity = 0;\r\nbl->pdata = pdata;\r\nbl->dev = &pdev->dev;\r\nplatform_set_drvdata(pdev, dev);\r\nomap_cfg_reg(PWL);\r\ndev->props.fb_blank = FB_BLANK_UNBLANK;\r\ndev->props.brightness = pdata->default_intensity;\r\nomapbl_update_status(dev);\r\ndev_info(&pdev->dev, "OMAP LCD backlight initialised\n");\r\nreturn 0;\r\n}

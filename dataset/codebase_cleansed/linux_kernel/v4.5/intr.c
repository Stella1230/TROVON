static void format_hwmsg(char *msg, size_t msgl, const char *hwmsg)\r\n{\r\nstrlcat(msg, "[", msgl);\r\nstrlcat(msg, hwmsg, msgl);\r\nstrlcat(msg, "]", msgl);\r\n}\r\nvoid hfi1_format_hwerrors(u64 hwerrs, const struct hfi1_hwerror_msgs *hwerrmsgs,\r\nsize_t nhwerrmsgs, char *msg, size_t msgl)\r\n{\r\nint i;\r\nfor (i = 0; i < nhwerrmsgs; i++)\r\nif (hwerrs & hwerrmsgs[i].mask)\r\nformat_hwmsg(msg, msgl, hwerrmsgs[i].msg);\r\n}\r\nstatic void signal_ib_event(struct hfi1_pportdata *ppd, enum ib_event_type ev)\r\n{\r\nstruct ib_event event;\r\nstruct hfi1_devdata *dd = ppd->dd;\r\nif (!(dd->flags & HFI1_INITTED))\r\nreturn;\r\nevent.device = &dd->verbs_dev.ibdev;\r\nevent.element.port_num = ppd->port;\r\nevent.event = ev;\r\nib_dispatch_event(&event);\r\n}\r\nvoid handle_linkup_change(struct hfi1_devdata *dd, u32 linkup)\r\n{\r\nstruct hfi1_pportdata *ppd = &dd->pport[0];\r\nenum ib_event_type ev;\r\nif (!(ppd->linkup ^ !!linkup))\r\nreturn;\r\nif (linkup) {\r\nif (quick_linkup\r\n|| dd->icode == ICODE_FUNCTIONAL_SIMULATOR) {\r\nset_up_vl15(dd, dd->vau, dd->vl15_init);\r\nassign_remote_cm_au_table(dd, dd->vcu);\r\nppd->neighbor_guid =\r\nread_csr(dd,\r\nDC_DC8051_STS_REMOTE_GUID);\r\nppd->neighbor_type =\r\nread_csr(dd, DC_DC8051_STS_REMOTE_NODE_TYPE) &\r\nDC_DC8051_STS_REMOTE_NODE_TYPE_VAL_MASK;\r\nppd->neighbor_port_number =\r\nread_csr(dd, DC_DC8051_STS_REMOTE_PORT_NO) &\r\nDC_DC8051_STS_REMOTE_PORT_NO_VAL_SMASK;\r\ndd_dev_info(dd,\r\n"Neighbor GUID: %llx Neighbor type %d\n",\r\nppd->neighbor_guid,\r\nppd->neighbor_type);\r\n}\r\nppd->linkup = 1;\r\nppd->offline_disabled_reason = OPA_LINKDOWN_REASON_NONE;\r\nget_linkup_link_widths(ppd);\r\n} else {\r\nppd->linkup = 0;\r\nreset_link_credits(dd);\r\nstart_freeze_handling(ppd, FREEZE_SELF|FREEZE_LINK_DOWN);\r\nev = IB_EVENT_PORT_ERR;\r\nhfi1_set_uevent_bits(ppd, _HFI1_EVENT_LINKDOWN_BIT);\r\nppd->neighbor_normal = 0;\r\nsignal_ib_event(ppd, ev);\r\n}\r\n}\r\nvoid handle_user_interrupt(struct hfi1_ctxtdata *rcd)\r\n{\r\nstruct hfi1_devdata *dd = rcd->dd;\r\nunsigned long flags;\r\nspin_lock_irqsave(&dd->uctxt_lock, flags);\r\nif (!rcd->cnt)\r\ngoto done;\r\nif (test_and_clear_bit(HFI1_CTXT_WAITING_RCV, &rcd->event_flags)) {\r\nwake_up_interruptible(&rcd->wait);\r\nhfi1_rcvctrl(dd, HFI1_RCVCTRL_INTRAVAIL_DIS, rcd->ctxt);\r\n} else if (test_and_clear_bit(HFI1_CTXT_WAITING_URG,\r\n&rcd->event_flags)) {\r\nrcd->urgent++;\r\nwake_up_interruptible(&rcd->wait);\r\n}\r\ndone:\r\nspin_unlock_irqrestore(&dd->uctxt_lock, flags);\r\n}

static void setDisplayControl(int ctrl, int disp_state)\r\n{\r\nunsigned long ulDisplayCtrlReg, ulReservedBits;\r\nint cnt;\r\ncnt = 0;\r\nif (!ctrl) {\r\nulDisplayCtrlReg = PEEK32(PANEL_DISPLAY_CTRL);\r\nif (disp_state) {\r\nulDisplayCtrlReg = FIELD_SET(ulDisplayCtrlReg,\r\nPANEL_DISPLAY_CTRL, TIMING, ENABLE);\r\nPOKE32(PANEL_DISPLAY_CTRL, ulDisplayCtrlReg);\r\nulDisplayCtrlReg = FIELD_SET(ulDisplayCtrlReg,\r\nPANEL_DISPLAY_CTRL, PLANE, ENABLE);\r\nulReservedBits = FIELD_SET(0, PANEL_DISPLAY_CTRL, RESERVED_1_MASK, ENABLE) |\r\nFIELD_SET(0, PANEL_DISPLAY_CTRL, RESERVED_2_MASK, ENABLE) |\r\nFIELD_SET(0, PANEL_DISPLAY_CTRL, RESERVED_3_MASK, ENABLE);\r\ndo {\r\ncnt++;\r\nPOKE32(PANEL_DISPLAY_CTRL, ulDisplayCtrlReg);\r\n} while ((PEEK32(PANEL_DISPLAY_CTRL) & ~ulReservedBits) !=\r\n(ulDisplayCtrlReg & ~ulReservedBits));\r\nprintk("Set Panel Plane enbit:after tried %d times\n", cnt);\r\n} else {\r\nulDisplayCtrlReg = FIELD_SET(ulDisplayCtrlReg,\r\nPANEL_DISPLAY_CTRL, PLANE, DISABLE);\r\nPOKE32(PANEL_DISPLAY_CTRL, ulDisplayCtrlReg);\r\nulDisplayCtrlReg = FIELD_SET(ulDisplayCtrlReg,\r\nPANEL_DISPLAY_CTRL, TIMING, DISABLE);\r\nPOKE32(PANEL_DISPLAY_CTRL, ulDisplayCtrlReg);\r\n}\r\n} else {\r\nulDisplayCtrlReg = PEEK32(CRT_DISPLAY_CTRL);\r\nif (disp_state) {\r\nulDisplayCtrlReg = FIELD_SET(ulDisplayCtrlReg,\r\nCRT_DISPLAY_CTRL, TIMING, ENABLE);\r\nPOKE32(CRT_DISPLAY_CTRL, ulDisplayCtrlReg);\r\nulDisplayCtrlReg = FIELD_SET(ulDisplayCtrlReg,\r\nCRT_DISPLAY_CTRL, PLANE, ENABLE);\r\nulReservedBits = FIELD_SET(0, CRT_DISPLAY_CTRL, RESERVED_1_MASK, ENABLE) |\r\nFIELD_SET(0, CRT_DISPLAY_CTRL, RESERVED_2_MASK, ENABLE) |\r\nFIELD_SET(0, CRT_DISPLAY_CTRL, RESERVED_3_MASK, ENABLE) |\r\nFIELD_SET(0, CRT_DISPLAY_CTRL, RESERVED_4_MASK, ENABLE);\r\ndo {\r\ncnt++;\r\nPOKE32(CRT_DISPLAY_CTRL, ulDisplayCtrlReg);\r\n} while ((PEEK32(CRT_DISPLAY_CTRL) & ~ulReservedBits) !=\r\n(ulDisplayCtrlReg & ~ulReservedBits));\r\nprintk("Set Crt Plane enbit:after tried %d times\n", cnt);\r\n} else {\r\nulDisplayCtrlReg = FIELD_SET(ulDisplayCtrlReg,\r\nCRT_DISPLAY_CTRL, PLANE, DISABLE);\r\nPOKE32(CRT_DISPLAY_CTRL, ulDisplayCtrlReg);\r\nulDisplayCtrlReg = FIELD_SET(ulDisplayCtrlReg,\r\nCRT_DISPLAY_CTRL, TIMING, DISABLE);\r\nPOKE32(CRT_DISPLAY_CTRL, ulDisplayCtrlReg);\r\n}\r\n}\r\n}\r\nstatic void waitNextVerticalSync(int ctrl, int delay)\r\n{\r\nunsigned int status;\r\nif (!ctrl) {\r\nif ((FIELD_GET(PEEK32(PANEL_PLL_CTRL), PANEL_PLL_CTRL, POWER) ==\r\nPANEL_PLL_CTRL_POWER_OFF) ||\r\n(FIELD_GET(PEEK32(PANEL_DISPLAY_CTRL), PANEL_DISPLAY_CTRL, TIMING) ==\r\nPANEL_DISPLAY_CTRL_TIMING_DISABLE)) {\r\nreturn;\r\n}\r\nwhile (delay-- > 0) {\r\ndo {\r\nstatus = FIELD_GET(PEEK32(SYSTEM_CTRL),\r\nSYSTEM_CTRL,\r\nPANEL_VSYNC);\r\n} while (status == SYSTEM_CTRL_PANEL_VSYNC_ACTIVE);\r\ndo {\r\nstatus = FIELD_GET(PEEK32(SYSTEM_CTRL),\r\nSYSTEM_CTRL,\r\nPANEL_VSYNC);\r\n} while (status == SYSTEM_CTRL_PANEL_VSYNC_INACTIVE);\r\n}\r\n} else {\r\nif ((FIELD_GET(PEEK32(CRT_PLL_CTRL), CRT_PLL_CTRL, POWER) ==\r\nCRT_PLL_CTRL_POWER_OFF) ||\r\n(FIELD_GET(PEEK32(CRT_DISPLAY_CTRL), CRT_DISPLAY_CTRL, TIMING) ==\r\nCRT_DISPLAY_CTRL_TIMING_DISABLE)) {\r\nreturn;\r\n}\r\nwhile (delay-- > 0) {\r\ndo {\r\nstatus = FIELD_GET(PEEK32(SYSTEM_CTRL),\r\nSYSTEM_CTRL,\r\nCRT_VSYNC);\r\n} while (status == SYSTEM_CTRL_CRT_VSYNC_ACTIVE);\r\ndo {\r\nstatus = FIELD_GET(PEEK32(SYSTEM_CTRL),\r\nSYSTEM_CTRL,\r\nCRT_VSYNC);\r\n} while (status == SYSTEM_CTRL_CRT_VSYNC_INACTIVE);\r\n}\r\n}\r\n}\r\nstatic void swPanelPowerSequence(int disp, int delay)\r\n{\r\nunsigned int reg;\r\nreg = PEEK32(PANEL_DISPLAY_CTRL);\r\nreg = FIELD_VALUE(reg, PANEL_DISPLAY_CTRL, FPEN, disp);\r\nPOKE32(PANEL_DISPLAY_CTRL, reg);\r\nprimaryWaitVerticalSync(delay);\r\nreg = PEEK32(PANEL_DISPLAY_CTRL);\r\nreg = FIELD_VALUE(reg, PANEL_DISPLAY_CTRL, DATA, disp);\r\nPOKE32(PANEL_DISPLAY_CTRL, reg);\r\nprimaryWaitVerticalSync(delay);\r\nreg = PEEK32(PANEL_DISPLAY_CTRL);\r\nreg = FIELD_VALUE(reg, PANEL_DISPLAY_CTRL, VBIASEN, disp);\r\nPOKE32(PANEL_DISPLAY_CTRL, reg);\r\nprimaryWaitVerticalSync(delay);\r\nreg = PEEK32(PANEL_DISPLAY_CTRL);\r\nreg = FIELD_VALUE(reg, PANEL_DISPLAY_CTRL, FPEN, disp);\r\nPOKE32(PANEL_DISPLAY_CTRL, reg);\r\nprimaryWaitVerticalSync(delay);\r\n}\r\nvoid ddk750_setLogicalDispOut(disp_output_t output)\r\n{\r\nunsigned int reg;\r\nif (output & PNL_2_USAGE) {\r\nreg = PEEK32(PANEL_DISPLAY_CTRL);\r\nreg = FIELD_VALUE(reg, PANEL_DISPLAY_CTRL, SELECT, (output & PNL_2_MASK)>>PNL_2_OFFSET);\r\nPOKE32(PANEL_DISPLAY_CTRL, reg);\r\n}\r\nif (output & CRT_2_USAGE) {\r\nreg = PEEK32(CRT_DISPLAY_CTRL);\r\nreg = FIELD_VALUE(reg, CRT_DISPLAY_CTRL, SELECT, (output & CRT_2_MASK)>>CRT_2_OFFSET);\r\nreg = FIELD_SET(reg, CRT_DISPLAY_CTRL, BLANK, OFF);\r\nPOKE32(CRT_DISPLAY_CTRL, reg);\r\n}\r\nif (output & PRI_TP_USAGE) {\r\nsetDisplayControl(0, (output & PRI_TP_MASK) >> PRI_TP_OFFSET);\r\n}\r\nif (output & SEC_TP_USAGE) {\r\nsetDisplayControl(1, (output & SEC_TP_MASK) >> SEC_TP_OFFSET);\r\n}\r\nif (output & PNL_SEQ_USAGE) {\r\nswPanelPowerSequence((output & PNL_SEQ_MASK) >> PNL_SEQ_OFFSET, 4);\r\n}\r\nif (output & DAC_USAGE)\r\nsetDAC((output & DAC_MASK) >> DAC_OFFSET);\r\nif (output & DPMS_USAGE)\r\nddk750_setDPMS((output & DPMS_MASK) >> DPMS_OFFSET);\r\n}

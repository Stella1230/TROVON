static inline int sjisibm2euc(unsigned char *euc, const unsigned char sjis_hi,\r\nconst unsigned char sjis_lo)\r\n{\r\nint index;\r\nindex = ((sjis_hi - 0xFA) * (0xFD - 0x40)) + (sjis_lo - 0x40);\r\nif (IS_EUC_IBM2JISX0208(sjisibm2euc_map[index][0],\r\nsjisibm2euc_map[index][1])) {\r\neuc[0] = sjisibm2euc_map[index][0];\r\neuc[1] = sjisibm2euc_map[index][1];\r\nreturn 2;\r\n} else {\r\neuc[0] = SS3;\r\neuc[1] = sjisibm2euc_map[index][0];\r\neuc[2] = sjisibm2euc_map[index][1];\r\nreturn 3;\r\n}\r\n}\r\nstatic inline int euc2sjisibm_jisx0212(unsigned char *sjis, const unsigned char euc_hi,\r\nconst unsigned char euc_lo)\r\n{\r\nint index, min_index, max_index;\r\nunsigned short euc;\r\nmin_index = 0;\r\nmax_index = ARRAY_SIZE(euc2sjisibm_jisx0212_map) - 1;\r\neuc = (euc_hi << 8) | euc_lo;\r\nwhile (min_index <= max_index) {\r\nindex = (min_index + max_index) / 2;\r\nif (euc < euc2sjisibm_jisx0212_map[index].euc)\r\nmax_index = index - 1;\r\nelse\r\nmin_index = index + 1;\r\nif (euc == euc2sjisibm_jisx0212_map[index].euc) {\r\nsjis[0] = euc2sjisibm_jisx0212_map[index].sjis[0];\r\nsjis[1] = euc2sjisibm_jisx0212_map[index].sjis[1];\r\nreturn 3;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic inline int euc2sjisibm_g3upper(unsigned char *sjis, const unsigned char euc_hi,\r\nconst unsigned char euc_lo)\r\n{\r\nint index;\r\nif (euc_hi == 0xF3)\r\nindex = ((euc_hi << 8) | euc_lo) - 0xF3F3;\r\nelse\r\nindex = ((euc_hi << 8) | euc_lo) - 0xF4A1 + 12;\r\nif ((index < 0) || (index >= ARRAY_SIZE(euc2sjisibm_g3upper_map)))\r\nreturn 0;\r\nsjis[0] = euc2sjisibm_g3upper_map[index][0];\r\nsjis[1] = euc2sjisibm_g3upper_map[index][1];\r\nreturn 3;\r\n}\r\nstatic inline int euc2sjisibm(unsigned char *sjis, const unsigned char euc_hi,\r\nconst unsigned char euc_lo)\r\n{\r\nint n;\r\n#if 0\r\nif ((euc_hi == 0xA2) && (euc_lo == 0xCC)) {\r\nsjis[0] = 0xFA;\r\nsjis[1] = 0x54;\r\nreturn 2;\r\n} else if ((euc_hi == 0xA2) && (euc_lo == 0xE8)) {\r\nsjis[0] = 0xFA;\r\nsjis[1] = 0x5B;\r\nreturn 2;\r\n}\r\n#endif\r\nif ((n = euc2sjisibm_g3upper(sjis, euc_hi, euc_lo))) {\r\nreturn n;\r\n} else if ((n = euc2sjisibm_jisx0212(sjis, euc_hi, euc_lo))) {\r\nreturn n;\r\n}\r\nreturn 0;\r\n}\r\nstatic inline int sjisnec2sjisibm(unsigned char *sjisibm,\r\nconst unsigned char sjisnec_hi,\r\nconst unsigned char sjisnec_lo)\r\n{\r\nint count;\r\nif (! IS_SJIS_NECIBM(sjisnec_hi, sjisnec_lo))\r\nreturn 0;\r\nif ((sjisnec_hi == 0xEE) && (sjisnec_lo == 0xF9)) {\r\nsjisibm[0] = 0x81;\r\nsjisibm[1] = 0xCA;\r\nreturn 2;\r\n}\r\nif ((sjisnec_hi == 0xEE) && (sjisnec_lo >= 0xEF)) {\r\ncount = (sjisnec_hi << 8 | sjisnec_lo)\r\n- (sjisnec_lo <= 0xF9 ? 0xEEEF : (0xEEEF - 10));\r\n} else {\r\ncount = (sjisnec_hi - 0xED) * (0xFC - 0x40)\r\n+ (sjisnec_lo - 0x40) + (0x5C - 0x40);\r\nif (sjisnec_lo >= 0x7F)\r\ncount--;\r\n}\r\nsjisibm[0] = 0xFA + (count / (0xFC - 0x40));\r\nsjisibm[1] = 0x40 + (count % (0xFC - 0x40));\r\nif (sjisibm[1] >= 0x7F)\r\nsjisibm[1]++;\r\nreturn 2;\r\n}\r\nstatic int uni2char(const wchar_t uni,\r\nunsigned char *out, int boundlen)\r\n{\r\nint n;\r\nif (!p_nls)\r\nreturn -EINVAL;\r\nif ((n = p_nls->uni2char(uni, out, boundlen)) < 0)\r\nreturn n;\r\nif (n == 1) {\r\nif (IS_SJIS_JISX0201KANA(out[0])) {\r\nif (boundlen < 2)\r\nreturn -ENAMETOOLONG;\r\nout[1] = out[0];\r\nout[0] = SS2;\r\nreturn 2;\r\n}\r\n} else if (n == 2) {\r\nsjisnec2sjisibm(out, out[0], out[1]);\r\nif (IS_SJIS_UDC_LOW(out[0], out[1])) {\r\nMAP_SJIS2EUC(out[0], out[1], 0xF0, out[0], out[1], 0xF5);\r\n} else if (IS_SJIS_UDC_HI(out[0], out[1])) {\r\nunsigned char ch, cl;\r\nif (boundlen < 3)\r\nreturn -ENAMETOOLONG;\r\nn = 3; ch = out[0]; cl = out[1];\r\nout[0] = SS3;\r\nMAP_SJIS2EUC(ch, cl, 0xF5, out[1], out[2], 0xF5);\r\n} else if (IS_SJIS_IBM(out[0], out[1])) {\r\nunsigned char euc[3], i;\r\nn = sjisibm2euc(euc, out[0], out[1]);\r\nif (boundlen < n)\r\nreturn -ENAMETOOLONG;\r\nfor (i = 0; i < n; i++)\r\nout[i] = euc[i];\r\n} else if (IS_SJIS_JISX0208(out[0], out[1])) {\r\nout[0] = (out[0]^0xA0)*2 + 0x5F;\r\nif (out[1] > 0x9E)\r\nout[0]++;\r\nif (out[1] < 0x7F)\r\nout[1] = out[1] + 0x61;\r\nelse if (out[1] < 0x9F)\r\nout[1] = out[1] + 0x60;\r\nelse\r\nout[1] = out[1] + 0x02;\r\n} else {\r\nreturn -EINVAL;\r\n}\r\n}\r\nelse\r\nreturn -EINVAL;\r\nreturn n;\r\n}\r\nstatic int char2uni(const unsigned char *rawstring, int boundlen,\r\nwchar_t *uni)\r\n{\r\nunsigned char sjis_temp[2];\r\nint euc_offset, n;\r\nif ( !p_nls )\r\nreturn -EINVAL;\r\nif (boundlen <= 0)\r\nreturn -ENAMETOOLONG;\r\nif (rawstring[0] > 0x7F) {\r\nif (rawstring[0] == SS3) {\r\nif (boundlen < 3)\r\nreturn -EINVAL;\r\neuc_offset = 3;\r\nif (IS_EUC_UDC_HI(rawstring[1], rawstring[2])) {\r\nMAP_EUC2SJIS(rawstring[1], rawstring[2], 0xF5,\r\nsjis_temp[0], sjis_temp[1], 0xF5);\r\n} else if (euc2sjisibm(sjis_temp,rawstring[1],rawstring[2])) {\r\n} else {\r\nreturn -EINVAL;\r\n}\r\n} else {\r\nif (boundlen < 2)\r\nreturn -EINVAL;\r\neuc_offset = 2;\r\nif (IS_EUC_JISX0201KANA(rawstring[0], rawstring[1])) {\r\nsjis_temp[0] = rawstring[1];\r\nsjis_temp[1] = 0x00;\r\n} else if (IS_EUC_UDC_LOW(rawstring[0], rawstring[1])) {\r\nMAP_EUC2SJIS(rawstring[0], rawstring[1], 0xF5,\r\nsjis_temp[0], sjis_temp[1], 0xF0);\r\n} else if (IS_EUC_JISX0208(rawstring[0], rawstring[1])) {\r\nsjis_temp[0] = ((rawstring[0]-0x5f)/2) ^ 0xA0;\r\nif (!(rawstring[0] & 1))\r\nsjis_temp[1] = rawstring[1] - 0x02;\r\nelse if (rawstring[1] < 0xE0)\r\nsjis_temp[1] = rawstring[1] - 0x61;\r\nelse\r\nsjis_temp[1] = rawstring[1] - 0x60;\r\n} else {\r\nreturn -EINVAL;\r\n}\r\n}\r\n} else {\r\neuc_offset = 1;\r\nsjis_temp[0] = rawstring[0];\r\nsjis_temp[1] = 0x00;\r\n}\r\nif ( (n = p_nls->char2uni(sjis_temp, sizeof(sjis_temp), uni)) < 0)\r\nreturn n;\r\nreturn euc_offset;\r\n}\r\nstatic int __init init_nls_euc_jp(void)\r\n{\r\np_nls = load_nls("cp932");\r\nif (p_nls) {\r\ntable.charset2upper = p_nls->charset2upper;\r\ntable.charset2lower = p_nls->charset2lower;\r\nreturn register_nls(&table);\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic void __exit exit_nls_euc_jp(void)\r\n{\r\nunregister_nls(&table);\r\nunload_nls(p_nls);\r\n}

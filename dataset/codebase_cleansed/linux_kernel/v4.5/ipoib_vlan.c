static ssize_t show_parent(struct device *d, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct net_device *dev = to_net_dev(d);\r\nstruct ipoib_dev_priv *priv = netdev_priv(dev);\r\nreturn sprintf(buf, "%s\n", priv->parent->name);\r\n}\r\nint __ipoib_vlan_add(struct ipoib_dev_priv *ppriv, struct ipoib_dev_priv *priv,\r\nu16 pkey, int type)\r\n{\r\nint result;\r\npriv->max_ib_mtu = ppriv->max_ib_mtu;\r\npriv->dev->mtu = IPOIB_UD_MTU(priv->max_ib_mtu);\r\npriv->mcast_mtu = priv->admin_mtu = priv->dev->mtu;\r\npriv->parent = ppriv->dev;\r\nset_bit(IPOIB_FLAG_SUBINTERFACE, &priv->flags);\r\nresult = ipoib_set_dev_features(priv, ppriv->ca);\r\nif (result)\r\ngoto err;\r\npriv->pkey = pkey;\r\nmemcpy(priv->dev->dev_addr, ppriv->dev->dev_addr, INFINIBAND_ALEN);\r\npriv->dev->broadcast[8] = pkey >> 8;\r\npriv->dev->broadcast[9] = pkey & 0xff;\r\nresult = ipoib_dev_init(priv->dev, ppriv->ca, ppriv->port);\r\nif (result < 0) {\r\nipoib_warn(ppriv, "failed to initialize subinterface: "\r\n"device %s, port %d",\r\nppriv->ca->name, ppriv->port);\r\ngoto err;\r\n}\r\nresult = register_netdevice(priv->dev);\r\nif (result) {\r\nipoib_warn(priv, "failed to initialize; error %i", result);\r\ngoto register_failed;\r\n}\r\nipoib_create_debug_files(priv->dev);\r\nif (type == IPOIB_LEGACY_CHILD) {\r\nif (ipoib_cm_add_mode_attr(priv->dev))\r\ngoto sysfs_failed;\r\nif (ipoib_add_pkey_attr(priv->dev))\r\ngoto sysfs_failed;\r\nif (ipoib_add_umcast_attr(priv->dev))\r\ngoto sysfs_failed;\r\nif (device_create_file(&priv->dev->dev, &dev_attr_parent))\r\ngoto sysfs_failed;\r\n}\r\npriv->child_type = type;\r\nlist_add_tail(&priv->list, &ppriv->child_intfs);\r\nreturn 0;\r\nsysfs_failed:\r\nresult = -ENOMEM;\r\nipoib_delete_debug_files(priv->dev);\r\nunregister_netdevice(priv->dev);\r\nregister_failed:\r\nipoib_dev_cleanup(priv->dev);\r\nerr:\r\nreturn result;\r\n}\r\nint ipoib_vlan_add(struct net_device *pdev, unsigned short pkey)\r\n{\r\nstruct ipoib_dev_priv *ppriv, *priv;\r\nchar intf_name[IFNAMSIZ];\r\nstruct ipoib_dev_priv *tpriv;\r\nint result;\r\nif (!capable(CAP_NET_ADMIN))\r\nreturn -EPERM;\r\nppriv = netdev_priv(pdev);\r\nsnprintf(intf_name, sizeof intf_name, "%s.%04x",\r\nppriv->dev->name, pkey);\r\npriv = ipoib_intf_alloc(intf_name);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nif (!rtnl_trylock())\r\nreturn restart_syscall();\r\ndown_write(&ppriv->vlan_rwsem);\r\nif (ppriv->pkey == pkey) {\r\nresult = -ENOTUNIQ;\r\ngoto out;\r\n}\r\nlist_for_each_entry(tpriv, &ppriv->child_intfs, list) {\r\nif (tpriv->pkey == pkey &&\r\ntpriv->child_type == IPOIB_LEGACY_CHILD) {\r\nresult = -ENOTUNIQ;\r\ngoto out;\r\n}\r\n}\r\nresult = __ipoib_vlan_add(ppriv, priv, pkey, IPOIB_LEGACY_CHILD);\r\nout:\r\nup_write(&ppriv->vlan_rwsem);\r\nif (result)\r\nfree_netdev(priv->dev);\r\nrtnl_unlock();\r\nreturn result;\r\n}\r\nint ipoib_vlan_delete(struct net_device *pdev, unsigned short pkey)\r\n{\r\nstruct ipoib_dev_priv *ppriv, *priv, *tpriv;\r\nstruct net_device *dev = NULL;\r\nif (!capable(CAP_NET_ADMIN))\r\nreturn -EPERM;\r\nppriv = netdev_priv(pdev);\r\nif (!rtnl_trylock())\r\nreturn restart_syscall();\r\ndown_write(&ppriv->vlan_rwsem);\r\nlist_for_each_entry_safe(priv, tpriv, &ppriv->child_intfs, list) {\r\nif (priv->pkey == pkey &&\r\npriv->child_type == IPOIB_LEGACY_CHILD) {\r\nunregister_netdevice(priv->dev);\r\nlist_del(&priv->list);\r\ndev = priv->dev;\r\nbreak;\r\n}\r\n}\r\nup_write(&ppriv->vlan_rwsem);\r\nrtnl_unlock();\r\nif (dev) {\r\nfree_netdev(dev);\r\nreturn 0;\r\n}\r\nreturn -ENODEV;\r\n}

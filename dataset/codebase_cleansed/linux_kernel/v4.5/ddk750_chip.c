logical_chip_type_t getChipType(void)\r\n{\r\nunsigned short physicalID;\r\nchar physicalRev;\r\nlogical_chip_type_t chip;\r\nphysicalID = devId750;\r\nphysicalRev = revId750;\r\nif (physicalID == 0x718)\r\nchip = SM718;\r\nelse if (physicalID == 0x750) {\r\nchip = SM750;\r\nif (physicalRev == SM750LE_REVISION_ID)\r\nchip = SM750LE;\r\n} else\r\nchip = SM_UNKNOWN;\r\nreturn chip;\r\n}\r\nstatic unsigned int get_mxclk_freq(void)\r\n{\r\nunsigned int pll_reg;\r\nunsigned int M, N, OD, POD;\r\nif (getChipType() == SM750LE)\r\nreturn MHz(130);\r\npll_reg = PEEK32(MXCLK_PLL_CTRL);\r\nM = FIELD_GET(pll_reg, PANEL_PLL_CTRL, M);\r\nN = FIELD_GET(pll_reg, PANEL_PLL_CTRL, N);\r\nOD = FIELD_GET(pll_reg, PANEL_PLL_CTRL, OD);\r\nPOD = FIELD_GET(pll_reg, PANEL_PLL_CTRL, POD);\r\nreturn DEFAULT_INPUT_CLOCK * M / N / (1 << OD) / (1 << POD);\r\n}\r\nstatic void setChipClock(unsigned int frequency)\r\n{\r\npll_value_t pll;\r\nunsigned int ulActualMxClk;\r\nif (getChipType() == SM750LE)\r\nreturn;\r\nif (frequency) {\r\npll.inputFreq = DEFAULT_INPUT_CLOCK;\r\npll.clockType = MXCLK_PLL;\r\nulActualMxClk = calcPllValue(frequency, &pll);\r\nPOKE32(MXCLK_PLL_CTRL, formatPllReg(&pll));\r\n}\r\n}\r\nstatic void setMemoryClock(unsigned int frequency)\r\n{\r\nunsigned int ulReg, divisor;\r\nif (getChipType() == SM750LE)\r\nreturn;\r\nif (frequency) {\r\nif (frequency > MHz(336))\r\nfrequency = MHz(336);\r\ndivisor = roundedDiv(get_mxclk_freq(), frequency);\r\nulReg = PEEK32(CURRENT_GATE);\r\nswitch (divisor) {\r\ndefault:\r\ncase 1:\r\nulReg = FIELD_SET(ulReg, CURRENT_GATE, M2XCLK, DIV_1);\r\nbreak;\r\ncase 2:\r\nulReg = FIELD_SET(ulReg, CURRENT_GATE, M2XCLK, DIV_2);\r\nbreak;\r\ncase 3:\r\nulReg = FIELD_SET(ulReg, CURRENT_GATE, M2XCLK, DIV_3);\r\nbreak;\r\ncase 4:\r\nulReg = FIELD_SET(ulReg, CURRENT_GATE, M2XCLK, DIV_4);\r\nbreak;\r\n}\r\nsetCurrentGate(ulReg);\r\n}\r\n}\r\nstatic void setMasterClock(unsigned int frequency)\r\n{\r\nunsigned int ulReg, divisor;\r\nif (getChipType() == SM750LE)\r\nreturn;\r\nif (frequency) {\r\nif (frequency > MHz(190))\r\nfrequency = MHz(190);\r\ndivisor = roundedDiv(get_mxclk_freq(), frequency);\r\nulReg = PEEK32(CURRENT_GATE);\r\nswitch (divisor) {\r\ndefault:\r\ncase 3:\r\nulReg = FIELD_SET(ulReg, CURRENT_GATE, MCLK, DIV_3);\r\nbreak;\r\ncase 4:\r\nulReg = FIELD_SET(ulReg, CURRENT_GATE, MCLK, DIV_4);\r\nbreak;\r\ncase 6:\r\nulReg = FIELD_SET(ulReg, CURRENT_GATE, MCLK, DIV_6);\r\nbreak;\r\ncase 8:\r\nulReg = FIELD_SET(ulReg, CURRENT_GATE, MCLK, DIV_8);\r\nbreak;\r\n}\r\nsetCurrentGate(ulReg);\r\n}\r\n}\r\nunsigned int ddk750_getVMSize(void)\r\n{\r\nunsigned int reg;\r\nunsigned int data;\r\nif (getChipType() == SM750LE)\r\nreturn SZ_64M;\r\nreg = PEEK32(MODE0_GATE);\r\nreg = FIELD_SET(reg, MODE0_GATE, GPIO, ON);\r\nPOKE32(MODE0_GATE, reg);\r\nreg = FIELD_GET(PEEK32(MISC_CTRL), MISC_CTRL, LOCALMEM_SIZE);\r\nswitch (reg) {\r\ncase MISC_CTRL_LOCALMEM_SIZE_8M:\r\ndata = SZ_8M; break;\r\ncase MISC_CTRL_LOCALMEM_SIZE_16M:\r\ndata = SZ_16M; break;\r\ncase MISC_CTRL_LOCALMEM_SIZE_32M:\r\ndata = SZ_32M; break;\r\ncase MISC_CTRL_LOCALMEM_SIZE_64M:\r\ndata = SZ_64M; break;\r\ndefault:\r\ndata = 0;\r\nbreak;\r\n}\r\nreturn data;\r\n}\r\nint ddk750_initHw(initchip_param_t *pInitParam)\r\n{\r\nunsigned int ulReg;\r\nif (pInitParam->powerMode != 0)\r\npInitParam->powerMode = 0;\r\nsetPowerMode(pInitParam->powerMode);\r\nulReg = PEEK32(CURRENT_GATE);\r\nulReg = FIELD_SET(ulReg, CURRENT_GATE, DISPLAY, ON);\r\nulReg = FIELD_SET(ulReg, CURRENT_GATE, LOCALMEM, ON);\r\nsetCurrentGate(ulReg);\r\nif (getChipType() != SM750LE) {\r\nulReg = PEEK32(VGA_CONFIGURATION);\r\nulReg = FIELD_SET(ulReg, VGA_CONFIGURATION, PLL, PANEL);\r\nulReg = FIELD_SET(ulReg, VGA_CONFIGURATION, MODE, GRAPHIC);\r\nPOKE32(VGA_CONFIGURATION, ulReg);\r\n} else {\r\n#if defined(__i386__) || defined(__x86_64__)\r\noutb_p(0x88, 0x3d4);\r\noutb_p(0x06, 0x3d5);\r\n#endif\r\n}\r\nsetChipClock(MHz((unsigned int)pInitParam->chipClock));\r\nsetMemoryClock(MHz(pInitParam->memClock));\r\nsetMasterClock(MHz(pInitParam->masterClock));\r\nif (pInitParam->resetMemory == 1) {\r\nulReg = PEEK32(MISC_CTRL);\r\nulReg = FIELD_SET(ulReg, MISC_CTRL, LOCALMEM_RESET, RESET);\r\nPOKE32(MISC_CTRL, ulReg);\r\nulReg = FIELD_SET(ulReg, MISC_CTRL, LOCALMEM_RESET, NORMAL);\r\nPOKE32(MISC_CTRL, ulReg);\r\n}\r\nif (pInitParam->setAllEngOff == 1) {\r\nenable2DEngine(0);\r\nulReg = PEEK32(VIDEO_DISPLAY_CTRL);\r\nulReg = FIELD_SET(ulReg, VIDEO_DISPLAY_CTRL, PLANE, DISABLE);\r\nPOKE32(VIDEO_DISPLAY_CTRL, ulReg);\r\nulReg = PEEK32(VIDEO_ALPHA_DISPLAY_CTRL);\r\nulReg = FIELD_SET(ulReg, VIDEO_ALPHA_DISPLAY_CTRL, PLANE, DISABLE);\r\nPOKE32(VIDEO_ALPHA_DISPLAY_CTRL, ulReg);\r\nulReg = PEEK32(ALPHA_DISPLAY_CTRL);\r\nulReg = FIELD_SET(ulReg, ALPHA_DISPLAY_CTRL, PLANE, DISABLE);\r\nPOKE32(ALPHA_DISPLAY_CTRL, ulReg);\r\nulReg = PEEK32(DMA_ABORT_INTERRUPT);\r\nulReg = FIELD_SET(ulReg, DMA_ABORT_INTERRUPT, ABORT_1, ABORT);\r\nPOKE32(DMA_ABORT_INTERRUPT, ulReg);\r\nenableDMA(0);\r\n}\r\nreturn 0;\r\n}\r\nunsigned int calcPllValue(unsigned int request_orig, pll_value_t *pll)\r\n{\r\nint N, M, X, d;\r\nint mini_diff;\r\nunsigned int RN, quo, rem, fl_quo;\r\nunsigned int input, request;\r\nunsigned int tmpClock, ret;\r\nconst int max_OD = 3;\r\nint max_d;\r\nif (getChipType() == SM750LE) {\r\nreturn request_orig;\r\n}\r\nret = 0;\r\nmini_diff = ~0;\r\nrequest = request_orig / 1000;\r\ninput = pll->inputFreq / 1000;\r\nif (pll->clockType == MXCLK_PLL)\r\nmax_d = 3;\r\nfor (N = 15; N > 1; N--) {\r\nRN = N * request;\r\nquo = RN / input;\r\nrem = RN % input;\r\nfl_quo = (rem * 10000 / input);\r\nfor (d = max_d; d >= 0; d--) {\r\nX = (1 << d);\r\nM = quo * X;\r\nM += fl_quo * X / 10000;\r\nM += (fl_quo * X % 10000) > 5000 ? 1 : 0;\r\nif (M < 256 && M > 0) {\r\nunsigned int diff;\r\ntmpClock = pll->inputFreq * M / N / X;\r\ndiff = absDiff(tmpClock, request_orig);\r\nif (diff < mini_diff) {\r\npll->M = M;\r\npll->N = N;\r\npll->POD = 0;\r\nif (d > max_OD)\r\npll->POD = d - max_OD;\r\npll->OD = d - pll->POD;\r\nmini_diff = diff;\r\nret = tmpClock;\r\n}\r\n}\r\n}\r\n}\r\nreturn ret;\r\n}\r\nunsigned int formatPllReg(pll_value_t *pPLL)\r\n{\r\nunsigned int ulPllReg = 0;\r\nulPllReg =\r\nFIELD_SET(0, PANEL_PLL_CTRL, BYPASS, OFF)\r\n| FIELD_SET(0, PANEL_PLL_CTRL, POWER, ON)\r\n| FIELD_SET(0, PANEL_PLL_CTRL, INPUT, OSC)\r\n#ifndef VALIDATION_CHIP\r\n| FIELD_VALUE(0, PANEL_PLL_CTRL, POD, pPLL->POD)\r\n#endif\r\n| FIELD_VALUE(0, PANEL_PLL_CTRL, OD, pPLL->OD)\r\n| FIELD_VALUE(0, PANEL_PLL_CTRL, N, pPLL->N)\r\n| FIELD_VALUE(0, PANEL_PLL_CTRL, M, pPLL->M);\r\nreturn ulPllReg;\r\n}

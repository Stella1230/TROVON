static int rt2x00lib_request_firmware(struct rt2x00_dev *rt2x00dev)\r\n{\r\nstruct device *device = wiphy_dev(rt2x00dev->hw->wiphy);\r\nconst struct firmware *fw;\r\nchar *fw_name;\r\nint retval;\r\nfw_name = rt2x00dev->ops->lib->get_firmware_name(rt2x00dev);\r\nif (!fw_name) {\r\nrt2x00_err(rt2x00dev,\r\n"Invalid firmware filename\n"\r\n"Please file bug report to %s\n", DRV_PROJECT);\r\nreturn -EINVAL;\r\n}\r\nrt2x00_info(rt2x00dev, "Loading firmware file '%s'\n", fw_name);\r\nretval = request_firmware(&fw, fw_name, device);\r\nif (retval) {\r\nrt2x00_err(rt2x00dev, "Failed to request Firmware\n");\r\nreturn retval;\r\n}\r\nif (!fw || !fw->size || !fw->data) {\r\nrt2x00_err(rt2x00dev, "Failed to read Firmware\n");\r\nrelease_firmware(fw);\r\nreturn -ENOENT;\r\n}\r\nrt2x00_info(rt2x00dev, "Firmware detected - version: %d.%d\n",\r\nfw->data[fw->size - 4], fw->data[fw->size - 3]);\r\nsnprintf(rt2x00dev->hw->wiphy->fw_version,\r\nsizeof(rt2x00dev->hw->wiphy->fw_version), "%d.%d",\r\nfw->data[fw->size - 4], fw->data[fw->size - 3]);\r\nretval = rt2x00dev->ops->lib->check_firmware(rt2x00dev, fw->data, fw->size);\r\nswitch (retval) {\r\ncase FW_OK:\r\nbreak;\r\ncase FW_BAD_CRC:\r\nrt2x00_err(rt2x00dev, "Firmware checksum error\n");\r\ngoto exit;\r\ncase FW_BAD_LENGTH:\r\nrt2x00_err(rt2x00dev, "Invalid firmware file length (len=%zu)\n",\r\nfw->size);\r\ngoto exit;\r\ncase FW_BAD_VERSION:\r\nrt2x00_err(rt2x00dev, "Current firmware does not support detected chipset\n");\r\ngoto exit;\r\n}\r\nrt2x00dev->fw = fw;\r\nreturn 0;\r\nexit:\r\nrelease_firmware(fw);\r\nreturn -ENOENT;\r\n}\r\nint rt2x00lib_load_firmware(struct rt2x00_dev *rt2x00dev)\r\n{\r\nint retval;\r\nif (!rt2x00_has_cap_flag(rt2x00dev, REQUIRE_FIRMWARE))\r\nreturn 0;\r\nif (!rt2x00dev->fw) {\r\nretval = rt2x00lib_request_firmware(rt2x00dev);\r\nif (retval)\r\nreturn retval;\r\n}\r\nretval = rt2x00dev->ops->lib->load_firmware(rt2x00dev,\r\nrt2x00dev->fw->data,\r\nrt2x00dev->fw->size);\r\nrt2x00leds_led_assoc(rt2x00dev, false);\r\nreturn retval;\r\n}\r\nvoid rt2x00lib_free_firmware(struct rt2x00_dev *rt2x00dev)\r\n{\r\nrelease_firmware(rt2x00dev->fw);\r\nrt2x00dev->fw = NULL;\r\n}

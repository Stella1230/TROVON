static int spear1310_miphy_pcie_init(struct spear1310_miphy_priv *priv)\r\n{\r\nu32 val;\r\nregmap_update_bits(priv->misc, SPEAR1310_PCIE_MIPHY_CFG_1,\r\nSPEAR1310_PCIE_SATA_MIPHY_CFG_PCIE_MASK,\r\nSPEAR1310_PCIE_SATA_MIPHY_CFG_PCIE);\r\nswitch (priv->id) {\r\ncase 0:\r\nval = SPEAR1310_PCIE_CFG_VAL(0);\r\nbreak;\r\ncase 1:\r\nval = SPEAR1310_PCIE_CFG_VAL(1);\r\nbreak;\r\ncase 2:\r\nval = SPEAR1310_PCIE_CFG_VAL(2);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nregmap_update_bits(priv->misc, SPEAR1310_PCIE_SATA_CFG,\r\nSPEAR1310_PCIE_CFG_MASK(priv->id), val);\r\nreturn 0;\r\n}\r\nstatic int spear1310_miphy_pcie_exit(struct spear1310_miphy_priv *priv)\r\n{\r\nregmap_update_bits(priv->misc, SPEAR1310_PCIE_SATA_CFG,\r\nSPEAR1310_PCIE_CFG_MASK(priv->id), 0);\r\nregmap_update_bits(priv->misc, SPEAR1310_PCIE_MIPHY_CFG_1,\r\nSPEAR1310_PCIE_SATA_MIPHY_CFG_PCIE_MASK, 0);\r\nreturn 0;\r\n}\r\nstatic int spear1310_miphy_init(struct phy *phy)\r\n{\r\nstruct spear1310_miphy_priv *priv = phy_get_drvdata(phy);\r\nint ret = 0;\r\nif (priv->mode == PCIE)\r\nret = spear1310_miphy_pcie_init(priv);\r\nreturn ret;\r\n}\r\nstatic int spear1310_miphy_exit(struct phy *phy)\r\n{\r\nstruct spear1310_miphy_priv *priv = phy_get_drvdata(phy);\r\nint ret = 0;\r\nif (priv->mode == PCIE)\r\nret = spear1310_miphy_pcie_exit(priv);\r\nreturn ret;\r\n}\r\nstatic struct phy *spear1310_miphy_xlate(struct device *dev,\r\nstruct of_phandle_args *args)\r\n{\r\nstruct spear1310_miphy_priv *priv = dev_get_drvdata(dev);\r\nif (args->args_count < 1) {\r\ndev_err(dev, "DT did not pass correct no of args\n");\r\nreturn ERR_PTR(-ENODEV);\r\n}\r\npriv->mode = args->args[0];\r\nif (priv->mode != SATA && priv->mode != PCIE) {\r\ndev_err(dev, "DT did not pass correct phy mode\n");\r\nreturn ERR_PTR(-ENODEV);\r\n}\r\nreturn priv->phy;\r\n}\r\nstatic int spear1310_miphy_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct spear1310_miphy_priv *priv;\r\nstruct phy_provider *phy_provider;\r\npriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->misc =\r\nsyscon_regmap_lookup_by_phandle(dev->of_node, "misc");\r\nif (IS_ERR(priv->misc)) {\r\ndev_err(dev, "failed to find misc regmap\n");\r\nreturn PTR_ERR(priv->misc);\r\n}\r\nif (of_property_read_u32(dev->of_node, "phy-id", &priv->id)) {\r\ndev_err(dev, "failed to find phy id\n");\r\nreturn -EINVAL;\r\n}\r\npriv->phy = devm_phy_create(dev, NULL, &spear1310_miphy_ops);\r\nif (IS_ERR(priv->phy)) {\r\ndev_err(dev, "failed to create SATA PCIe PHY\n");\r\nreturn PTR_ERR(priv->phy);\r\n}\r\ndev_set_drvdata(dev, priv);\r\nphy_set_drvdata(priv->phy, priv);\r\nphy_provider =\r\ndevm_of_phy_provider_register(dev, spear1310_miphy_xlate);\r\nif (IS_ERR(phy_provider)) {\r\ndev_err(dev, "failed to register phy provider\n");\r\nreturn PTR_ERR(phy_provider);\r\n}\r\nreturn 0;\r\n}

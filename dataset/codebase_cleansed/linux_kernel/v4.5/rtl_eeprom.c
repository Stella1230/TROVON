static void _rtl92e_gpio_write_bit(struct net_device *dev, int no, bool val)\r\n{\r\nu8 reg = rtl92e_readb(dev, EPROM_CMD);\r\nif (val)\r\nreg |= 1 << no;\r\nelse\r\nreg &= ~(1 << no);\r\nrtl92e_writeb(dev, EPROM_CMD, reg);\r\nudelay(EPROM_DELAY);\r\n}\r\nstatic bool _rtl92e_gpio_get_bit(struct net_device *dev, int no)\r\n{\r\nu8 reg = rtl92e_readb(dev, EPROM_CMD);\r\nreturn (reg >> no) & 0x1;\r\n}\r\nstatic void _rtl92e_eeprom_ck_cycle(struct net_device *dev)\r\n{\r\n_rtl92e_gpio_write_bit(dev, EPROM_CK_BIT, 1);\r\n_rtl92e_gpio_write_bit(dev, EPROM_CK_BIT, 0);\r\n}\r\nstatic u16 _rtl92e_eeprom_xfer(struct net_device *dev, u16 data, int tx_len)\r\n{\r\nu16 ret = 0;\r\nint rx_len = 16;\r\n_rtl92e_gpio_write_bit(dev, EPROM_CS_BIT, 1);\r\n_rtl92e_eeprom_ck_cycle(dev);\r\nwhile (tx_len--) {\r\n_rtl92e_gpio_write_bit(dev, EPROM_W_BIT,\r\n(data >> tx_len) & 0x1);\r\n_rtl92e_eeprom_ck_cycle(dev);\r\n}\r\n_rtl92e_gpio_write_bit(dev, EPROM_W_BIT, 0);\r\nwhile (rx_len--) {\r\n_rtl92e_eeprom_ck_cycle(dev);\r\nret |= _rtl92e_gpio_get_bit(dev, EPROM_R_BIT) << rx_len;\r\n}\r\n_rtl92e_gpio_write_bit(dev, EPROM_CS_BIT, 0);\r\n_rtl92e_eeprom_ck_cycle(dev);\r\nreturn ret;\r\n}\r\nu32 rtl92e_eeprom_read(struct net_device *dev, u32 addr)\r\n{\r\nstruct r8192_priv *priv = rtllib_priv(dev);\r\nu32 ret = 0;\r\nrtl92e_writeb(dev, EPROM_CMD,\r\n(EPROM_CMD_PROGRAM << EPROM_CMD_OPERATING_MODE_SHIFT));\r\nudelay(EPROM_DELAY);\r\nif (priv->epromtype == EEPROM_93C56)\r\nret = _rtl92e_eeprom_xfer(dev, (addr & 0xFF) | (0x6 << 8), 11);\r\nelse\r\nret = _rtl92e_eeprom_xfer(dev, (addr & 0x3F) | (0x6 << 6), 9);\r\nrtl92e_writeb(dev, EPROM_CMD,\r\n(EPROM_CMD_NORMAL<<EPROM_CMD_OPERATING_MODE_SHIFT));\r\nreturn ret;\r\n}

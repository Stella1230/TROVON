static int print_hook(const char *fmt, ...)\r\n{\r\nchar buf[400];\r\nint len;\r\nva_list args;\r\nva_start(args, fmt);\r\nvsnprintf(buf, sizeof(buf), fmt, args);\r\nva_end(args);\r\nlen = strlen(buf);\r\nif (*sn_oemdata_size + len <= sn_oemdata_bufsize)\r\nmemcpy(*sn_oemdata + *sn_oemdata_size, buf, len);\r\n*sn_oemdata_size += len;\r\nreturn 0;\r\n}\r\nstatic void sn_cpei_handler(int irq, void *devid, struct pt_regs *regs)\r\n{\r\nia64_sn_plat_cpei_handler();\r\n}\r\nstatic void sn_cpei_timer_handler(unsigned long dummy)\r\n{\r\nsn_cpei_handler(-1, NULL, NULL);\r\nmod_timer(&sn_cpei_timer, jiffies + CPEI_INTERVAL);\r\n}\r\nvoid sn_init_cpei_timer(void)\r\n{\r\ninit_timer(&sn_cpei_timer);\r\nsn_cpei_timer.expires = jiffies + CPEI_INTERVAL;\r\nsn_cpei_timer.function = sn_cpei_timer_handler;\r\nadd_timer(&sn_cpei_timer);\r\n}\r\nstatic int\r\nsn_platform_plat_specific_err_print(const u8 * sect_header, u8 ** oemdata,\r\nu64 * oemdata_size)\r\n{\r\nmutex_lock(&sn_oemdata_mutex);\r\nsn_oemdata = oemdata;\r\nsn_oemdata_size = oemdata_size;\r\nsn_oemdata_bufsize = 0;\r\n*sn_oemdata_size = PAGE_SIZE;\r\nwhile (*sn_oemdata_size > sn_oemdata_bufsize) {\r\nu8 *newbuf = vmalloc(*sn_oemdata_size);\r\nif (!newbuf) {\r\nmutex_unlock(&sn_oemdata_mutex);\r\nprintk(KERN_ERR "%s: unable to extend sn_oemdata\n",\r\n__func__);\r\nreturn 1;\r\n}\r\nvfree(*sn_oemdata);\r\n*sn_oemdata = newbuf;\r\nsn_oemdata_bufsize = *sn_oemdata_size;\r\n*sn_oemdata_size = 0;\r\nia64_sn_plat_specific_err_print(print_hook, (char *)sect_header);\r\n}\r\nmutex_unlock(&sn_oemdata_mutex);\r\nreturn 0;\r\n}\r\nint sn_salinfo_platform_oemdata(const u8 *sect_header, u8 **oemdata, u64 *oemdata_size)\r\n{\r\nefi_guid_t guid = *(efi_guid_t *)sect_header;\r\nint valid = 0;\r\n*oemdata_size = 0;\r\nvfree(*oemdata);\r\n*oemdata = NULL;\r\nif (efi_guidcmp(guid, SAL_PLAT_SPECIFIC_ERR_SECT_GUID) == 0) {\r\nsal_log_plat_specific_err_info_t *psei = (sal_log_plat_specific_err_info_t *)sect_header;\r\nvalid = psei->valid.oem_data;\r\n} else if (efi_guidcmp(guid, SAL_PLAT_MEM_DEV_ERR_SECT_GUID) == 0) {\r\nsal_log_mem_dev_err_info_t *mdei = (sal_log_mem_dev_err_info_t *)sect_header;\r\nvalid = mdei->valid.oem_data;\r\n}\r\nif (valid)\r\nreturn sn_platform_plat_specific_err_print(sect_header, oemdata, oemdata_size);\r\nelse\r\nreturn 0;\r\n}\r\nstatic int __init sn_salinfo_init(void)\r\n{\r\nif (ia64_platform_is("sn2"))\r\nsalinfo_platform_oemdata = &sn_salinfo_platform_oemdata;\r\nreturn 0;\r\n}

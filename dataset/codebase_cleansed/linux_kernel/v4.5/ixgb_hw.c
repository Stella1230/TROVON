static u32 ixgb_mac_reset(struct ixgb_hw *hw)\r\n{\r\nu32 ctrl_reg;\r\nctrl_reg = IXGB_CTRL0_RST |\r\nIXGB_CTRL0_SDP3_DIR |\r\nIXGB_CTRL0_SDP2_DIR |\r\nIXGB_CTRL0_SDP1_DIR |\r\nIXGB_CTRL0_SDP0_DIR |\r\nIXGB_CTRL0_SDP3 |\r\nIXGB_CTRL0_SDP2 |\r\nIXGB_CTRL0_SDP0;\r\n#ifdef HP_ZX1\r\nIXGB_WRITE_REG_IO(hw, CTRL0, ctrl_reg);\r\n#else\r\nIXGB_WRITE_REG(hw, CTRL0, ctrl_reg);\r\n#endif\r\nmsleep(IXGB_DELAY_AFTER_RESET);\r\nctrl_reg = IXGB_READ_REG(hw, CTRL0);\r\n#ifdef DBG\r\nASSERT(!(ctrl_reg & IXGB_CTRL0_RST));\r\n#endif\r\nif (hw->subsystem_vendor_id == PCI_VENDOR_ID_SUN) {\r\nctrl_reg =\r\nIXGB_CTRL1_GPI0_EN |\r\nIXGB_CTRL1_SDP6_DIR |\r\nIXGB_CTRL1_SDP7_DIR |\r\nIXGB_CTRL1_SDP6 |\r\nIXGB_CTRL1_SDP7;\r\nIXGB_WRITE_REG(hw, CTRL1, ctrl_reg);\r\nixgb_optics_reset_bcm(hw);\r\n}\r\nif (hw->phy_type == ixgb_phy_type_txn17401)\r\nixgb_optics_reset(hw);\r\nreturn ctrl_reg;\r\n}\r\nbool\r\nixgb_adapter_stop(struct ixgb_hw *hw)\r\n{\r\nu32 ctrl_reg;\r\nu32 icr_reg;\r\nENTER();\r\nif (hw->adapter_stopped) {\r\npr_debug("Exiting because the adapter is already stopped!!!\n");\r\nreturn false;\r\n}\r\nhw->adapter_stopped = true;\r\npr_debug("Masking off all interrupts\n");\r\nIXGB_WRITE_REG(hw, IMC, 0xFFFFFFFF);\r\nIXGB_WRITE_REG(hw, RCTL, IXGB_READ_REG(hw, RCTL) & ~IXGB_RCTL_RXEN);\r\nIXGB_WRITE_REG(hw, TCTL, IXGB_READ_REG(hw, TCTL) & ~IXGB_TCTL_TXEN);\r\nIXGB_WRITE_FLUSH(hw);\r\nmsleep(IXGB_DELAY_BEFORE_RESET);\r\npr_debug("Issuing a global reset to MAC\n");\r\nctrl_reg = ixgb_mac_reset(hw);\r\npr_debug("Masking off all interrupts\n");\r\nIXGB_WRITE_REG(hw, IMC, 0xffffffff);\r\nicr_reg = IXGB_READ_REG(hw, ICR);\r\nreturn ctrl_reg & IXGB_CTRL0_RST;\r\n}\r\nstatic ixgb_xpak_vendor\r\nixgb_identify_xpak_vendor(struct ixgb_hw *hw)\r\n{\r\nu32 i;\r\nu16 vendor_name[5];\r\nixgb_xpak_vendor xpak_vendor;\r\nENTER();\r\nfor (i = 0; i < 5; i++) {\r\nvendor_name[i] = ixgb_read_phy_reg(hw,\r\nMDIO_PMA_PMD_XPAK_VENDOR_NAME\r\n+ i, IXGB_PHY_ADDRESS,\r\nMDIO_MMD_PMAPMD);\r\n}\r\nif (vendor_name[0] == 'I' &&\r\nvendor_name[1] == 'N' &&\r\nvendor_name[2] == 'T' &&\r\nvendor_name[3] == 'E' && vendor_name[4] == 'L') {\r\nxpak_vendor = ixgb_xpak_vendor_intel;\r\n} else {\r\nxpak_vendor = ixgb_xpak_vendor_infineon;\r\n}\r\nreturn xpak_vendor;\r\n}\r\nstatic ixgb_phy_type\r\nixgb_identify_phy(struct ixgb_hw *hw)\r\n{\r\nixgb_phy_type phy_type;\r\nixgb_xpak_vendor xpak_vendor;\r\nENTER();\r\nswitch (hw->device_id) {\r\ncase IXGB_DEVICE_ID_82597EX:\r\npr_debug("Identified TXN17401 optics\n");\r\nphy_type = ixgb_phy_type_txn17401;\r\nbreak;\r\ncase IXGB_DEVICE_ID_82597EX_SR:\r\nxpak_vendor = ixgb_identify_xpak_vendor(hw);\r\nif (xpak_vendor == ixgb_xpak_vendor_intel) {\r\npr_debug("Identified TXN17201 optics\n");\r\nphy_type = ixgb_phy_type_txn17201;\r\n} else {\r\npr_debug("Identified G6005 optics\n");\r\nphy_type = ixgb_phy_type_g6005;\r\n}\r\nbreak;\r\ncase IXGB_DEVICE_ID_82597EX_LR:\r\npr_debug("Identified G6104 optics\n");\r\nphy_type = ixgb_phy_type_g6104;\r\nbreak;\r\ncase IXGB_DEVICE_ID_82597EX_CX4:\r\npr_debug("Identified CX4\n");\r\nxpak_vendor = ixgb_identify_xpak_vendor(hw);\r\nif (xpak_vendor == ixgb_xpak_vendor_intel) {\r\npr_debug("Identified TXN17201 optics\n");\r\nphy_type = ixgb_phy_type_txn17201;\r\n} else {\r\npr_debug("Identified G6005 optics\n");\r\nphy_type = ixgb_phy_type_g6005;\r\n}\r\nbreak;\r\ndefault:\r\npr_debug("Unknown physical layer module\n");\r\nphy_type = ixgb_phy_type_unknown;\r\nbreak;\r\n}\r\nif (hw->subsystem_vendor_id == PCI_VENDOR_ID_SUN)\r\nphy_type = ixgb_phy_type_bcm;\r\nreturn phy_type;\r\n}\r\nbool\r\nixgb_init_hw(struct ixgb_hw *hw)\r\n{\r\nu32 i;\r\nu32 ctrl_reg;\r\nbool status;\r\nENTER();\r\npr_debug("Issuing a global reset to MAC\n");\r\nctrl_reg = ixgb_mac_reset(hw);\r\npr_debug("Issuing an EE reset to MAC\n");\r\n#ifdef HP_ZX1\r\nIXGB_WRITE_REG_IO(hw, CTRL1, IXGB_CTRL1_EE_RST);\r\n#else\r\nIXGB_WRITE_REG(hw, CTRL1, IXGB_CTRL1_EE_RST);\r\n#endif\r\nmsleep(IXGB_DELAY_AFTER_EE_RESET);\r\nif (!ixgb_get_eeprom_data(hw))\r\nreturn false;\r\nhw->device_id = ixgb_get_ee_device_id(hw);\r\nhw->phy_type = ixgb_identify_phy(hw);\r\nixgb_init_rx_addrs(hw);\r\nif (!mac_addr_valid(hw->curr_mac_addr)) {\r\npr_debug("MAC address invalid after ixgb_init_rx_addrs\n");\r\nreturn(false);\r\n}\r\nhw->adapter_stopped = false;\r\nixgb_get_bus_info(hw);\r\npr_debug("Zeroing the MTA\n");\r\nfor (i = 0; i < IXGB_MC_TBL_SIZE; i++)\r\nIXGB_WRITE_REG_ARRAY(hw, MTA, i, 0);\r\nixgb_clear_vfta(hw);\r\nixgb_clear_hw_cntrs(hw);\r\nstatus = ixgb_setup_fc(hw);\r\nixgb_check_for_link(hw);\r\nreturn status;\r\n}\r\nstatic void\r\nixgb_init_rx_addrs(struct ixgb_hw *hw)\r\n{\r\nu32 i;\r\nENTER();\r\nif (!mac_addr_valid(hw->curr_mac_addr)) {\r\nixgb_get_ee_mac_addr(hw, hw->curr_mac_addr);\r\npr_debug("Keeping Permanent MAC Addr = %pM\n",\r\nhw->curr_mac_addr);\r\n} else {\r\npr_debug("Overriding MAC Address in RAR[0]\n");\r\npr_debug("New MAC Addr = %pM\n", hw->curr_mac_addr);\r\nixgb_rar_set(hw, hw->curr_mac_addr, 0);\r\n}\r\npr_debug("Clearing RAR[1-15]\n");\r\nfor (i = 1; i < IXGB_RAR_ENTRIES; i++) {\r\nIXGB_WRITE_REG_ARRAY(hw, RA, ((i << 1) + 1), 0);\r\nIXGB_WRITE_REG_ARRAY(hw, RA, (i << 1), 0);\r\n}\r\n}\r\nvoid\r\nixgb_mc_addr_list_update(struct ixgb_hw *hw,\r\nu8 *mc_addr_list,\r\nu32 mc_addr_count,\r\nu32 pad)\r\n{\r\nu32 hash_value;\r\nu32 i;\r\nu32 rar_used_count = 1;\r\nu8 *mca;\r\nENTER();\r\nhw->num_mc_addrs = mc_addr_count;\r\npr_debug("Clearing RAR[1-15]\n");\r\nfor (i = rar_used_count; i < IXGB_RAR_ENTRIES; i++) {\r\nIXGB_WRITE_REG_ARRAY(hw, RA, (i << 1), 0);\r\nIXGB_WRITE_REG_ARRAY(hw, RA, ((i << 1) + 1), 0);\r\n}\r\npr_debug("Clearing MTA\n");\r\nfor (i = 0; i < IXGB_MC_TBL_SIZE; i++)\r\nIXGB_WRITE_REG_ARRAY(hw, MTA, i, 0);\r\nmca = mc_addr_list;\r\nfor (i = 0; i < mc_addr_count; i++) {\r\npr_debug("Adding the multicast addresses:\n");\r\npr_debug("MC Addr #%d = %pM\n", i, mca);\r\nif (rar_used_count < IXGB_RAR_ENTRIES) {\r\nixgb_rar_set(hw, mca, rar_used_count);\r\npr_debug("Added a multicast address to RAR[%d]\n", i);\r\nrar_used_count++;\r\n} else {\r\nhash_value = ixgb_hash_mc_addr(hw, mca);\r\npr_debug("Hash value = 0x%03X\n", hash_value);\r\nixgb_mta_set(hw, hash_value);\r\n}\r\nmca += ETH_ALEN + pad;\r\n}\r\npr_debug("MC Update Complete\n");\r\n}\r\nstatic u32\r\nixgb_hash_mc_addr(struct ixgb_hw *hw,\r\nu8 *mc_addr)\r\n{\r\nu32 hash_value = 0;\r\nENTER();\r\nswitch (hw->mc_filter_type) {\r\ncase 0:\r\nhash_value =\r\n((mc_addr[4] >> 4) | (((u16) mc_addr[5]) << 4));\r\nbreak;\r\ncase 1:\r\nhash_value =\r\n((mc_addr[4] >> 3) | (((u16) mc_addr[5]) << 5));\r\nbreak;\r\ncase 2:\r\nhash_value =\r\n((mc_addr[4] >> 2) | (((u16) mc_addr[5]) << 6));\r\nbreak;\r\ncase 3:\r\nhash_value = ((mc_addr[4]) | (((u16) mc_addr[5]) << 8));\r\nbreak;\r\ndefault:\r\npr_debug("MC filter type param set incorrectly\n");\r\nASSERT(0);\r\nbreak;\r\n}\r\nhash_value &= 0xFFF;\r\nreturn hash_value;\r\n}\r\nstatic void\r\nixgb_mta_set(struct ixgb_hw *hw,\r\nu32 hash_value)\r\n{\r\nu32 hash_bit, hash_reg;\r\nu32 mta_reg;\r\nhash_reg = (hash_value >> 5) & 0x7F;\r\nhash_bit = hash_value & 0x1F;\r\nmta_reg = IXGB_READ_REG_ARRAY(hw, MTA, hash_reg);\r\nmta_reg |= (1 << hash_bit);\r\nIXGB_WRITE_REG_ARRAY(hw, MTA, hash_reg, mta_reg);\r\n}\r\nvoid\r\nixgb_rar_set(struct ixgb_hw *hw,\r\nu8 *addr,\r\nu32 index)\r\n{\r\nu32 rar_low, rar_high;\r\nENTER();\r\nrar_low = ((u32) addr[0] |\r\n((u32)addr[1] << 8) |\r\n((u32)addr[2] << 16) |\r\n((u32)addr[3] << 24));\r\nrar_high = ((u32) addr[4] |\r\n((u32)addr[5] << 8) |\r\nIXGB_RAH_AV);\r\nIXGB_WRITE_REG_ARRAY(hw, RA, (index << 1), rar_low);\r\nIXGB_WRITE_REG_ARRAY(hw, RA, ((index << 1) + 1), rar_high);\r\n}\r\nvoid\r\nixgb_write_vfta(struct ixgb_hw *hw,\r\nu32 offset,\r\nu32 value)\r\n{\r\nIXGB_WRITE_REG_ARRAY(hw, VFTA, offset, value);\r\n}\r\nstatic void\r\nixgb_clear_vfta(struct ixgb_hw *hw)\r\n{\r\nu32 offset;\r\nfor (offset = 0; offset < IXGB_VLAN_FILTER_TBL_SIZE; offset++)\r\nIXGB_WRITE_REG_ARRAY(hw, VFTA, offset, 0);\r\n}\r\nstatic bool\r\nixgb_setup_fc(struct ixgb_hw *hw)\r\n{\r\nu32 ctrl_reg;\r\nu32 pap_reg = 0;\r\nbool status = true;\r\nENTER();\r\nctrl_reg = IXGB_READ_REG(hw, CTRL0);\r\nctrl_reg &= ~(IXGB_CTRL0_RPE | IXGB_CTRL0_TPE);\r\nswitch (hw->fc.type) {\r\ncase ixgb_fc_none:\r\nctrl_reg |= (IXGB_CTRL0_CMDC);\r\nbreak;\r\ncase ixgb_fc_rx_pause:\r\nctrl_reg |= (IXGB_CTRL0_RPE);\r\nbreak;\r\ncase ixgb_fc_tx_pause:\r\nctrl_reg |= (IXGB_CTRL0_TPE);\r\npap_reg = hw->fc.pause_time;\r\nbreak;\r\ncase ixgb_fc_full:\r\nctrl_reg |= (IXGB_CTRL0_RPE | IXGB_CTRL0_TPE);\r\npap_reg = hw->fc.pause_time;\r\nbreak;\r\ndefault:\r\npr_debug("Flow control param set incorrectly\n");\r\nASSERT(0);\r\nbreak;\r\n}\r\nIXGB_WRITE_REG(hw, CTRL0, ctrl_reg);\r\nif (pap_reg != 0)\r\nIXGB_WRITE_REG(hw, PAP, pap_reg);\r\nif (!(hw->fc.type & ixgb_fc_tx_pause)) {\r\nIXGB_WRITE_REG(hw, FCRTL, 0);\r\nIXGB_WRITE_REG(hw, FCRTH, 0);\r\n} else {\r\nif (hw->fc.send_xon) {\r\nIXGB_WRITE_REG(hw, FCRTL,\r\n(hw->fc.low_water | IXGB_FCRTL_XONE));\r\n} else {\r\nIXGB_WRITE_REG(hw, FCRTL, hw->fc.low_water);\r\n}\r\nIXGB_WRITE_REG(hw, FCRTH, hw->fc.high_water);\r\n}\r\nreturn status;\r\n}\r\nstatic u16\r\nixgb_read_phy_reg(struct ixgb_hw *hw,\r\nu32 reg_address,\r\nu32 phy_address,\r\nu32 device_type)\r\n{\r\nu32 i;\r\nu32 data;\r\nu32 command = 0;\r\nASSERT(reg_address <= IXGB_MAX_PHY_REG_ADDRESS);\r\nASSERT(phy_address <= IXGB_MAX_PHY_ADDRESS);\r\nASSERT(device_type <= IXGB_MAX_PHY_DEV_TYPE);\r\ncommand = ((reg_address << IXGB_MSCA_NP_ADDR_SHIFT) |\r\n(device_type << IXGB_MSCA_DEV_TYPE_SHIFT) |\r\n(phy_address << IXGB_MSCA_PHY_ADDR_SHIFT) |\r\n(IXGB_MSCA_ADDR_CYCLE | IXGB_MSCA_MDI_COMMAND));\r\nIXGB_WRITE_REG(hw, MSCA, command);\r\nfor (i = 0; i < 10; i++)\r\n{\r\nudelay(10);\r\ncommand = IXGB_READ_REG(hw, MSCA);\r\nif ((command & IXGB_MSCA_MDI_COMMAND) == 0)\r\nbreak;\r\n}\r\nASSERT((command & IXGB_MSCA_MDI_COMMAND) == 0);\r\ncommand = ((reg_address << IXGB_MSCA_NP_ADDR_SHIFT) |\r\n(device_type << IXGB_MSCA_DEV_TYPE_SHIFT) |\r\n(phy_address << IXGB_MSCA_PHY_ADDR_SHIFT) |\r\n(IXGB_MSCA_READ | IXGB_MSCA_MDI_COMMAND));\r\nIXGB_WRITE_REG(hw, MSCA, command);\r\nfor (i = 0; i < 10; i++)\r\n{\r\nudelay(10);\r\ncommand = IXGB_READ_REG(hw, MSCA);\r\nif ((command & IXGB_MSCA_MDI_COMMAND) == 0)\r\nbreak;\r\n}\r\nASSERT((command & IXGB_MSCA_MDI_COMMAND) == 0);\r\ndata = IXGB_READ_REG(hw, MSRWD);\r\ndata >>= IXGB_MSRWD_READ_DATA_SHIFT;\r\nreturn((u16) data);\r\n}\r\nstatic void\r\nixgb_write_phy_reg(struct ixgb_hw *hw,\r\nu32 reg_address,\r\nu32 phy_address,\r\nu32 device_type,\r\nu16 data)\r\n{\r\nu32 i;\r\nu32 command = 0;\r\nASSERT(reg_address <= IXGB_MAX_PHY_REG_ADDRESS);\r\nASSERT(phy_address <= IXGB_MAX_PHY_ADDRESS);\r\nASSERT(device_type <= IXGB_MAX_PHY_DEV_TYPE);\r\nIXGB_WRITE_REG(hw, MSRWD, (u32)data);\r\ncommand = ((reg_address << IXGB_MSCA_NP_ADDR_SHIFT) |\r\n(device_type << IXGB_MSCA_DEV_TYPE_SHIFT) |\r\n(phy_address << IXGB_MSCA_PHY_ADDR_SHIFT) |\r\n(IXGB_MSCA_ADDR_CYCLE | IXGB_MSCA_MDI_COMMAND));\r\nIXGB_WRITE_REG(hw, MSCA, command);\r\nfor (i = 0; i < 10; i++)\r\n{\r\nudelay(10);\r\ncommand = IXGB_READ_REG(hw, MSCA);\r\nif ((command & IXGB_MSCA_MDI_COMMAND) == 0)\r\nbreak;\r\n}\r\nASSERT((command & IXGB_MSCA_MDI_COMMAND) == 0);\r\ncommand = ((reg_address << IXGB_MSCA_NP_ADDR_SHIFT) |\r\n(device_type << IXGB_MSCA_DEV_TYPE_SHIFT) |\r\n(phy_address << IXGB_MSCA_PHY_ADDR_SHIFT) |\r\n(IXGB_MSCA_WRITE | IXGB_MSCA_MDI_COMMAND));\r\nIXGB_WRITE_REG(hw, MSCA, command);\r\nfor (i = 0; i < 10; i++)\r\n{\r\nudelay(10);\r\ncommand = IXGB_READ_REG(hw, MSCA);\r\nif ((command & IXGB_MSCA_MDI_COMMAND) == 0)\r\nbreak;\r\n}\r\nASSERT((command & IXGB_MSCA_MDI_COMMAND) == 0);\r\n}\r\nvoid\r\nixgb_check_for_link(struct ixgb_hw *hw)\r\n{\r\nu32 status_reg;\r\nu32 xpcss_reg;\r\nENTER();\r\nxpcss_reg = IXGB_READ_REG(hw, XPCSS);\r\nstatus_reg = IXGB_READ_REG(hw, STATUS);\r\nif ((xpcss_reg & IXGB_XPCSS_ALIGN_STATUS) &&\r\n(status_reg & IXGB_STATUS_LU)) {\r\nhw->link_up = true;\r\n} else if (!(xpcss_reg & IXGB_XPCSS_ALIGN_STATUS) &&\r\n(status_reg & IXGB_STATUS_LU)) {\r\npr_debug("XPCSS Not Aligned while Status:LU is set\n");\r\nhw->link_up = ixgb_link_reset(hw);\r\n} else {\r\nhw->link_up = ixgb_link_reset(hw);\r\n}\r\n}\r\nbool ixgb_check_for_bad_link(struct ixgb_hw *hw)\r\n{\r\nu32 newLFC, newRFC;\r\nbool bad_link_returncode = false;\r\nif (hw->phy_type == ixgb_phy_type_txn17401) {\r\nnewLFC = IXGB_READ_REG(hw, LFC);\r\nnewRFC = IXGB_READ_REG(hw, RFC);\r\nif ((hw->lastLFC + 250 < newLFC)\r\n|| (hw->lastRFC + 250 < newRFC)) {\r\npr_debug("BAD LINK! too many LFC/RFC since last check\n");\r\nbad_link_returncode = true;\r\n}\r\nhw->lastLFC = newLFC;\r\nhw->lastRFC = newRFC;\r\n}\r\nreturn bad_link_returncode;\r\n}\r\nstatic void\r\nixgb_clear_hw_cntrs(struct ixgb_hw *hw)\r\n{\r\nvolatile u32 temp_reg;\r\nENTER();\r\nif (hw->adapter_stopped) {\r\npr_debug("Exiting because the adapter is stopped!!!\n");\r\nreturn;\r\n}\r\ntemp_reg = IXGB_READ_REG(hw, TPRL);\r\ntemp_reg = IXGB_READ_REG(hw, TPRH);\r\ntemp_reg = IXGB_READ_REG(hw, GPRCL);\r\ntemp_reg = IXGB_READ_REG(hw, GPRCH);\r\ntemp_reg = IXGB_READ_REG(hw, BPRCL);\r\ntemp_reg = IXGB_READ_REG(hw, BPRCH);\r\ntemp_reg = IXGB_READ_REG(hw, MPRCL);\r\ntemp_reg = IXGB_READ_REG(hw, MPRCH);\r\ntemp_reg = IXGB_READ_REG(hw, UPRCL);\r\ntemp_reg = IXGB_READ_REG(hw, UPRCH);\r\ntemp_reg = IXGB_READ_REG(hw, VPRCL);\r\ntemp_reg = IXGB_READ_REG(hw, VPRCH);\r\ntemp_reg = IXGB_READ_REG(hw, JPRCL);\r\ntemp_reg = IXGB_READ_REG(hw, JPRCH);\r\ntemp_reg = IXGB_READ_REG(hw, GORCL);\r\ntemp_reg = IXGB_READ_REG(hw, GORCH);\r\ntemp_reg = IXGB_READ_REG(hw, TORL);\r\ntemp_reg = IXGB_READ_REG(hw, TORH);\r\ntemp_reg = IXGB_READ_REG(hw, RNBC);\r\ntemp_reg = IXGB_READ_REG(hw, RUC);\r\ntemp_reg = IXGB_READ_REG(hw, ROC);\r\ntemp_reg = IXGB_READ_REG(hw, RLEC);\r\ntemp_reg = IXGB_READ_REG(hw, CRCERRS);\r\ntemp_reg = IXGB_READ_REG(hw, ICBC);\r\ntemp_reg = IXGB_READ_REG(hw, ECBC);\r\ntemp_reg = IXGB_READ_REG(hw, MPC);\r\ntemp_reg = IXGB_READ_REG(hw, TPTL);\r\ntemp_reg = IXGB_READ_REG(hw, TPTH);\r\ntemp_reg = IXGB_READ_REG(hw, GPTCL);\r\ntemp_reg = IXGB_READ_REG(hw, GPTCH);\r\ntemp_reg = IXGB_READ_REG(hw, BPTCL);\r\ntemp_reg = IXGB_READ_REG(hw, BPTCH);\r\ntemp_reg = IXGB_READ_REG(hw, MPTCL);\r\ntemp_reg = IXGB_READ_REG(hw, MPTCH);\r\ntemp_reg = IXGB_READ_REG(hw, UPTCL);\r\ntemp_reg = IXGB_READ_REG(hw, UPTCH);\r\ntemp_reg = IXGB_READ_REG(hw, VPTCL);\r\ntemp_reg = IXGB_READ_REG(hw, VPTCH);\r\ntemp_reg = IXGB_READ_REG(hw, JPTCL);\r\ntemp_reg = IXGB_READ_REG(hw, JPTCH);\r\ntemp_reg = IXGB_READ_REG(hw, GOTCL);\r\ntemp_reg = IXGB_READ_REG(hw, GOTCH);\r\ntemp_reg = IXGB_READ_REG(hw, TOTL);\r\ntemp_reg = IXGB_READ_REG(hw, TOTH);\r\ntemp_reg = IXGB_READ_REG(hw, DC);\r\ntemp_reg = IXGB_READ_REG(hw, PLT64C);\r\ntemp_reg = IXGB_READ_REG(hw, TSCTC);\r\ntemp_reg = IXGB_READ_REG(hw, TSCTFC);\r\ntemp_reg = IXGB_READ_REG(hw, IBIC);\r\ntemp_reg = IXGB_READ_REG(hw, RFC);\r\ntemp_reg = IXGB_READ_REG(hw, LFC);\r\ntemp_reg = IXGB_READ_REG(hw, PFRC);\r\ntemp_reg = IXGB_READ_REG(hw, PFTC);\r\ntemp_reg = IXGB_READ_REG(hw, MCFRC);\r\ntemp_reg = IXGB_READ_REG(hw, MCFTC);\r\ntemp_reg = IXGB_READ_REG(hw, XONRXC);\r\ntemp_reg = IXGB_READ_REG(hw, XONTXC);\r\ntemp_reg = IXGB_READ_REG(hw, XOFFRXC);\r\ntemp_reg = IXGB_READ_REG(hw, XOFFTXC);\r\ntemp_reg = IXGB_READ_REG(hw, RJC);\r\n}\r\nvoid\r\nixgb_led_on(struct ixgb_hw *hw)\r\n{\r\nu32 ctrl0_reg = IXGB_READ_REG(hw, CTRL0);\r\nctrl0_reg &= ~IXGB_CTRL0_SDP0;\r\nIXGB_WRITE_REG(hw, CTRL0, ctrl0_reg);\r\n}\r\nvoid\r\nixgb_led_off(struct ixgb_hw *hw)\r\n{\r\nu32 ctrl0_reg = IXGB_READ_REG(hw, CTRL0);\r\nctrl0_reg |= IXGB_CTRL0_SDP0;\r\nIXGB_WRITE_REG(hw, CTRL0, ctrl0_reg);\r\n}\r\nstatic void\r\nixgb_get_bus_info(struct ixgb_hw *hw)\r\n{\r\nu32 status_reg;\r\nstatus_reg = IXGB_READ_REG(hw, STATUS);\r\nhw->bus.type = (status_reg & IXGB_STATUS_PCIX_MODE) ?\r\nixgb_bus_type_pcix : ixgb_bus_type_pci;\r\nif (hw->bus.type == ixgb_bus_type_pci) {\r\nhw->bus.speed = (status_reg & IXGB_STATUS_PCI_SPD) ?\r\nixgb_bus_speed_66 : ixgb_bus_speed_33;\r\n} else {\r\nswitch (status_reg & IXGB_STATUS_PCIX_SPD_MASK) {\r\ncase IXGB_STATUS_PCIX_SPD_66:\r\nhw->bus.speed = ixgb_bus_speed_66;\r\nbreak;\r\ncase IXGB_STATUS_PCIX_SPD_100:\r\nhw->bus.speed = ixgb_bus_speed_100;\r\nbreak;\r\ncase IXGB_STATUS_PCIX_SPD_133:\r\nhw->bus.speed = ixgb_bus_speed_133;\r\nbreak;\r\ndefault:\r\nhw->bus.speed = ixgb_bus_speed_reserved;\r\nbreak;\r\n}\r\n}\r\nhw->bus.width = (status_reg & IXGB_STATUS_BUS64) ?\r\nixgb_bus_width_64 : ixgb_bus_width_32;\r\n}\r\nstatic bool\r\nmac_addr_valid(u8 *mac_addr)\r\n{\r\nbool is_valid = true;\r\nENTER();\r\nif (is_multicast_ether_addr(mac_addr)) {\r\npr_debug("MAC address is multicast\n");\r\nis_valid = false;\r\n}\r\nelse if (is_broadcast_ether_addr(mac_addr)) {\r\npr_debug("MAC address is broadcast\n");\r\nis_valid = false;\r\n}\r\nelse if (is_zero_ether_addr(mac_addr)) {\r\npr_debug("MAC address is all zeros\n");\r\nis_valid = false;\r\n}\r\nreturn is_valid;\r\n}\r\nstatic bool\r\nixgb_link_reset(struct ixgb_hw *hw)\r\n{\r\nbool link_status = false;\r\nu8 wait_retries = MAX_RESET_ITERATIONS;\r\nu8 lrst_retries = MAX_RESET_ITERATIONS;\r\ndo {\r\nIXGB_WRITE_REG(hw, CTRL0,\r\nIXGB_READ_REG(hw, CTRL0) | IXGB_CTRL0_LRST);\r\ndo {\r\nudelay(IXGB_DELAY_USECS_AFTER_LINK_RESET);\r\nlink_status =\r\n((IXGB_READ_REG(hw, STATUS) & IXGB_STATUS_LU)\r\n&& (IXGB_READ_REG(hw, XPCSS) &\r\nIXGB_XPCSS_ALIGN_STATUS)) ? true : false;\r\n} while (!link_status && --wait_retries);\r\n} while (!link_status && --lrst_retries);\r\nreturn link_status;\r\n}\r\nstatic void\r\nixgb_optics_reset(struct ixgb_hw *hw)\r\n{\r\nif (hw->phy_type == ixgb_phy_type_txn17401) {\r\nu16 mdio_reg;\r\nixgb_write_phy_reg(hw,\r\nMDIO_CTRL1,\r\nIXGB_PHY_ADDRESS,\r\nMDIO_MMD_PMAPMD,\r\nMDIO_CTRL1_RESET);\r\nmdio_reg = ixgb_read_phy_reg(hw,\r\nMDIO_CTRL1,\r\nIXGB_PHY_ADDRESS,\r\nMDIO_MMD_PMAPMD);\r\n}\r\n}\r\nstatic void\r\nixgb_optics_reset_bcm(struct ixgb_hw *hw)\r\n{\r\nu32 ctrl = IXGB_READ_REG(hw, CTRL0);\r\nctrl &= ~IXGB_CTRL0_SDP2;\r\nctrl |= IXGB_CTRL0_SDP3;\r\nIXGB_WRITE_REG(hw, CTRL0, ctrl);\r\nIXGB_WRITE_FLUSH(hw);\r\nmsleep(IXGB_SUN_PHY_RESET_DELAY);\r\nixgb_write_phy_reg(hw,\r\nIXGB_BCM8704_USER_PMD_TX_CTRL_REG,\r\nIXGB_SUN_PHY_ADDRESS,\r\nIXGB_BCM8704_USER_DEV3_ADDR,\r\nIXGB_BCM8704_USER_PMD_TX_CTRL_REG_VAL);\r\nixgb_read_phy_reg(hw,\r\nIXGB_BCM8704_USER_PMD_TX_CTRL_REG,\r\nIXGB_SUN_PHY_ADDRESS,\r\nIXGB_BCM8704_USER_DEV3_ADDR);\r\nixgb_read_phy_reg(hw,\r\nIXGB_BCM8704_USER_PMD_TX_CTRL_REG,\r\nIXGB_SUN_PHY_ADDRESS,\r\nIXGB_BCM8704_USER_DEV3_ADDR);\r\nixgb_write_phy_reg(hw,\r\nIXGB_BCM8704_USER_CTRL_REG,\r\nIXGB_SUN_PHY_ADDRESS,\r\nIXGB_BCM8704_USER_DEV3_ADDR,\r\nIXGB_BCM8704_USER_CTRL_REG_VAL);\r\nixgb_read_phy_reg(hw,\r\nIXGB_BCM8704_USER_CTRL_REG,\r\nIXGB_SUN_PHY_ADDRESS,\r\nIXGB_BCM8704_USER_DEV3_ADDR);\r\nixgb_read_phy_reg(hw,\r\nIXGB_BCM8704_USER_CTRL_REG,\r\nIXGB_SUN_PHY_ADDRESS,\r\nIXGB_BCM8704_USER_DEV3_ADDR);\r\nmsleep(IXGB_SUN_PHY_RESET_DELAY);\r\n}

static int ohci_hcd_omap3_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct ohci_hcd *ohci;\r\nstruct usb_hcd *hcd = NULL;\r\nvoid __iomem *regs = NULL;\r\nstruct resource *res;\r\nint ret;\r\nint irq;\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\nif (!dev->parent) {\r\ndev_err(dev, "Missing parent device\n");\r\nreturn -ENODEV;\r\n}\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\ndev_err(dev, "OHCI irq failed\n");\r\nreturn -ENODEV;\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\ndev_err(dev, "UHH OHCI get resource failed\n");\r\nreturn -ENOMEM;\r\n}\r\nregs = ioremap(res->start, resource_size(res));\r\nif (!regs) {\r\ndev_err(dev, "UHH OHCI ioremap failed\n");\r\nreturn -ENOMEM;\r\n}\r\nret = dma_coerce_mask_and_coherent(dev, DMA_BIT_MASK(32));\r\nif (ret)\r\ngoto err_io;\r\nret = -ENODEV;\r\nhcd = usb_create_hcd(&ohci_omap3_hc_driver, dev,\r\ndev_name(dev));\r\nif (!hcd) {\r\ndev_err(dev, "usb_create_hcd failed\n");\r\ngoto err_io;\r\n}\r\nhcd->rsrc_start = res->start;\r\nhcd->rsrc_len = resource_size(res);\r\nhcd->regs = regs;\r\npm_runtime_enable(dev);\r\npm_runtime_get_sync(dev);\r\nohci = hcd_to_ohci(hcd);\r\nohci->hc_control = OHCI_CTRL_RWC;\r\nret = usb_add_hcd(hcd, irq, 0);\r\nif (ret) {\r\ndev_dbg(dev, "failed to add hcd with err %d\n", ret);\r\ngoto err_add_hcd;\r\n}\r\ndevice_wakeup_enable(hcd->self.controller);\r\nreturn 0;\r\nerr_add_hcd:\r\npm_runtime_put_sync(dev);\r\nusb_put_hcd(hcd);\r\nerr_io:\r\niounmap(regs);\r\nreturn ret;\r\n}\r\nstatic int ohci_hcd_omap3_remove(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct usb_hcd *hcd = dev_get_drvdata(dev);\r\niounmap(hcd->regs);\r\nusb_remove_hcd(hcd);\r\npm_runtime_put_sync(dev);\r\npm_runtime_disable(dev);\r\nusb_put_hcd(hcd);\r\nreturn 0;\r\n}\r\nstatic int __init ohci_omap3_init(void)\r\n{\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\npr_info("%s: " DRIVER_DESC "\n", hcd_name);\r\nohci_init_driver(&ohci_omap3_hc_driver, NULL);\r\nreturn platform_driver_register(&ohci_hcd_omap3_driver);\r\n}\r\nstatic void __exit ohci_omap3_cleanup(void)\r\n{\r\nplatform_driver_unregister(&ohci_hcd_omap3_driver);\r\n}

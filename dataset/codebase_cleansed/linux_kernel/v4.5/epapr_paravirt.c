static int __init early_init_dt_scan_epapr(unsigned long node,\r\nconst char *uname,\r\nint depth, void *data)\r\n{\r\nconst u32 *insts;\r\nint len;\r\nint i;\r\ninsts = of_get_flat_dt_prop(node, "hcall-instructions", &len);\r\nif (!insts)\r\nreturn 0;\r\nif (len % 4 || len > (4 * 4))\r\nreturn -1;\r\nfor (i = 0; i < (len / 4); i++) {\r\nu32 inst = be32_to_cpu(insts[i]);\r\npatch_instruction(epapr_hypercall_start + i, inst);\r\n#if !defined(CONFIG_64BIT) || defined(CONFIG_PPC_BOOK3E_64)\r\npatch_instruction(epapr_ev_idle_start + i, inst);\r\n#endif\r\n}\r\n#if !defined(CONFIG_64BIT) || defined(CONFIG_PPC_BOOK3E_64)\r\nif (of_get_flat_dt_prop(node, "has-idle", NULL))\r\nepapr_has_idle = true;\r\n#endif\r\nepapr_paravirt_enabled = true;\r\nreturn 1;\r\n}\r\nint __init epapr_paravirt_early_init(void)\r\n{\r\nof_scan_flat_dt(early_init_dt_scan_epapr, NULL);\r\nreturn 0;\r\n}\r\nstatic int __init epapr_idle_init(void)\r\n{\r\n#if !defined(CONFIG_64BIT) || defined(CONFIG_PPC_BOOK3E_64)\r\nif (epapr_has_idle)\r\nppc_md.power_save = epapr_ev_idle;\r\n#endif\r\nreturn 0;\r\n}

static void qed_enable_pf_rl(struct qed_hwfn *p_hwfn,\r\nbool pf_rl_en)\r\n{\r\nSTORE_RT_REG(p_hwfn, QM_REG_RLPFENABLE_RT_OFFSET, pf_rl_en ? 1 : 0);\r\nif (pf_rl_en) {\r\nSTORE_RT_REG(p_hwfn, QM_REG_RLPFVOQENABLE_RT_OFFSET,\r\n(1 << MAX_NUM_VOQS) - 1);\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_RLPFPERIOD_RT_OFFSET,\r\nQM_RL_PERIOD_CLK_25M);\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_RLPFPERIODTIMER_RT_OFFSET,\r\nQM_RL_PERIOD_CLK_25M);\r\nif (QM_BYPASS_EN)\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_AFULLQMBYPTHRPFRL_RT_OFFSET,\r\nQM_RL_UPPER_BOUND);\r\n}\r\n}\r\nstatic void qed_enable_pf_wfq(struct qed_hwfn *p_hwfn,\r\nbool pf_wfq_en)\r\n{\r\nSTORE_RT_REG(p_hwfn, QM_REG_WFQPFENABLE_RT_OFFSET, pf_wfq_en ? 1 : 0);\r\nif (pf_wfq_en && QM_BYPASS_EN)\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_AFULLQMBYPTHRPFWFQ_RT_OFFSET,\r\nQM_WFQ_UPPER_BOUND);\r\n}\r\nstatic void qed_enable_vport_rl(struct qed_hwfn *p_hwfn,\r\nbool vport_rl_en)\r\n{\r\nSTORE_RT_REG(p_hwfn, QM_REG_RLGLBLENABLE_RT_OFFSET,\r\nvport_rl_en ? 1 : 0);\r\nif (vport_rl_en) {\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_RLGLBLPERIOD_0_RT_OFFSET,\r\nQM_RL_PERIOD_CLK_25M);\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_RLGLBLPERIODTIMER_0_RT_OFFSET,\r\nQM_RL_PERIOD_CLK_25M);\r\nif (QM_BYPASS_EN)\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_AFULLQMBYPTHRGLBLRL_RT_OFFSET,\r\nQM_RL_UPPER_BOUND);\r\n}\r\n}\r\nstatic void qed_enable_vport_wfq(struct qed_hwfn *p_hwfn,\r\nbool vport_wfq_en)\r\n{\r\nSTORE_RT_REG(p_hwfn, QM_REG_WFQVPENABLE_RT_OFFSET,\r\nvport_wfq_en ? 1 : 0);\r\nif (vport_wfq_en && QM_BYPASS_EN)\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_AFULLQMBYPTHRVPWFQ_RT_OFFSET,\r\nQM_WFQ_UPPER_BOUND);\r\n}\r\nstatic void qed_cmdq_lines_voq_rt_init(struct qed_hwfn *p_hwfn,\r\nu8 voq,\r\nu16 cmdq_lines)\r\n{\r\nu32 qm_line_crd;\r\nbool is_bb_a0 = QED_IS_BB_A0(p_hwfn->cdev);\r\nif (is_bb_a0)\r\ncmdq_lines = min_t(u32, cmdq_lines, 1022);\r\nqm_line_crd = QM_VOQ_LINE_CRD(cmdq_lines);\r\nOVERWRITE_RT_REG(p_hwfn, PBF_CMDQ_LINES_RT_OFFSET(voq),\r\n(u32)cmdq_lines);\r\nSTORE_RT_REG(p_hwfn, QM_REG_VOQCRDLINE_RT_OFFSET + voq, qm_line_crd);\r\nSTORE_RT_REG(p_hwfn, QM_REG_VOQINITCRDLINE_RT_OFFSET + voq,\r\nqm_line_crd);\r\n}\r\nstatic void qed_cmdq_lines_rt_init(\r\nstruct qed_hwfn *p_hwfn,\r\nu8 max_ports_per_engine,\r\nu8 max_phys_tcs_per_port,\r\nstruct init_qm_port_params port_params[MAX_NUM_PORTS])\r\n{\r\nu8 tc, voq, port_id;\r\nfor (voq = 0; voq < MAX_NUM_VOQS; voq++)\r\nSTORE_RT_REG(p_hwfn, PBF_CMDQ_LINES_RT_OFFSET(voq), 0);\r\nfor (port_id = 0; port_id < max_ports_per_engine; port_id++) {\r\nif (port_params[port_id].active) {\r\nu16 phys_lines, phys_lines_per_tc;\r\nu8 phys_tcs = port_params[port_id].num_active_phys_tcs;\r\nphys_lines = port_params[port_id].num_pbf_cmd_lines -\r\nPBF_CMDQ_PURE_LB_LINES;\r\nphys_lines_per_tc = phys_lines / phys_tcs;\r\nfor (tc = 0; tc < phys_tcs; tc++) {\r\nvoq = PHYS_VOQ(port_id, tc,\r\nmax_phys_tcs_per_port);\r\nqed_cmdq_lines_voq_rt_init(p_hwfn, voq,\r\nphys_lines_per_tc);\r\n}\r\nqed_cmdq_lines_voq_rt_init(p_hwfn, LB_VOQ(port_id),\r\nPBF_CMDQ_PURE_LB_LINES);\r\n}\r\n}\r\n}\r\nstatic void qed_btb_blocks_rt_init(\r\nstruct qed_hwfn *p_hwfn,\r\nu8 max_ports_per_engine,\r\nu8 max_phys_tcs_per_port,\r\nstruct init_qm_port_params port_params[MAX_NUM_PORTS])\r\n{\r\nu32 usable_blocks, pure_lb_blocks, phys_blocks;\r\nu8 tc, voq, port_id;\r\nfor (port_id = 0; port_id < max_ports_per_engine; port_id++) {\r\nu32 temp;\r\nu8 phys_tcs;\r\nif (!port_params[port_id].active)\r\ncontinue;\r\nphys_tcs = port_params[port_id].num_active_phys_tcs;\r\nusable_blocks = port_params[port_id].num_btb_blocks -\r\nBTB_HEADROOM_BLOCKS;\r\npure_lb_blocks = (usable_blocks * BTB_PURE_LB_FACTOR) /\r\n(phys_tcs * BTB_PURE_LB_FACTOR +\r\nBTB_PURE_LB_RATIO);\r\npure_lb_blocks = max_t(u32, BTB_JUMBO_PKT_BLOCKS,\r\npure_lb_blocks / BTB_PURE_LB_FACTOR);\r\nphys_blocks = (usable_blocks - pure_lb_blocks) / phys_tcs;\r\nfor (tc = 0; tc < phys_tcs; tc++) {\r\nvoq = PHYS_VOQ(port_id, tc, max_phys_tcs_per_port);\r\nSTORE_RT_REG(p_hwfn, PBF_BTB_GUARANTEED_RT_OFFSET(voq),\r\nphys_blocks);\r\n}\r\ntemp = LB_VOQ(port_id);\r\nSTORE_RT_REG(p_hwfn, PBF_BTB_GUARANTEED_RT_OFFSET(temp),\r\npure_lb_blocks);\r\n}\r\n}\r\nstatic void qed_tx_pq_map_rt_init(\r\nstruct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt,\r\nstruct qed_qm_pf_rt_init_params *p_params,\r\nu32 base_mem_addr_4kb)\r\n{\r\nstruct init_qm_vport_params *vport_params = p_params->vport_params;\r\nu16 num_pqs = p_params->num_pf_pqs + p_params->num_vf_pqs;\r\nu16 first_pq_group = p_params->start_pq / QM_PF_QUEUE_GROUP_SIZE;\r\nu16 last_pq_group = (p_params->start_pq + num_pqs - 1) /\r\nQM_PF_QUEUE_GROUP_SIZE;\r\nbool is_bb_a0 = QED_IS_BB_A0(p_hwfn->cdev);\r\nu16 i, pq_id, pq_group;\r\nu32 tx_pq_vf_mask[MAX_QM_TX_QUEUES / QM_PF_QUEUE_GROUP_SIZE] = { 0 };\r\nu32 tx_pq_vf_mask_width = is_bb_a0 ? 32 : QM_PF_QUEUE_GROUP_SIZE;\r\nu32 num_tx_pq_vf_masks = MAX_QM_TX_QUEUES / tx_pq_vf_mask_width;\r\nu32 pq_mem_4kb = QM_PQ_MEM_4KB(p_params->num_pf_cids);\r\nu32 vport_pq_mem_4kb = QM_PQ_MEM_4KB(p_params->num_vf_cids);\r\nu32 mem_addr_4kb = base_mem_addr_4kb;\r\nfor (pq_group = first_pq_group; pq_group <= last_pq_group; pq_group++)\r\nSTORE_RT_REG(p_hwfn, QM_REG_PQTX2PF_0_RT_OFFSET + pq_group,\r\n(u32)(p_params->pf_id));\r\nSTORE_RT_REG(p_hwfn, QM_REG_MAXPQSIZE_0_RT_OFFSET,\r\nQM_PQ_SIZE_256B(p_params->num_pf_cids));\r\nSTORE_RT_REG(p_hwfn, QM_REG_MAXPQSIZE_1_RT_OFFSET,\r\nQM_PQ_SIZE_256B(p_params->num_vf_cids));\r\nfor (i = 0, pq_id = p_params->start_pq; i < num_pqs; i++, pq_id++) {\r\nu8 voq = VOQ(p_params->port_id, p_params->pq_params[i].tc_id,\r\np_params->max_phys_tcs_per_port);\r\nbool is_vf_pq = (i >= p_params->num_pf_pqs);\r\nstruct qm_rf_pq_map tx_pq_map;\r\nu8 vport_id_in_pf = p_params->pq_params[i].vport_id -\r\np_params->start_vport;\r\nu16 *pq_ids = &vport_params[vport_id_in_pf].first_tx_pq_id[0];\r\nu16 first_tx_pq_id = pq_ids[p_params->pq_params[i].tc_id];\r\nif (first_tx_pq_id == QM_INVALID_PQ_ID) {\r\npq_ids[p_params->pq_params[i].tc_id] = pq_id;\r\nfirst_tx_pq_id = pq_id;\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_WFQVPMAP_RT_OFFSET +\r\nfirst_tx_pq_id,\r\n(voq << QM_WFQ_VP_PQ_VOQ_SHIFT) |\r\n(p_params->pf_id <<\r\nQM_WFQ_VP_PQ_PF_SHIFT));\r\n}\r\nmemset(&tx_pq_map, 0, sizeof(tx_pq_map));\r\nSET_FIELD(tx_pq_map.reg, QM_RF_PQ_MAP_PQ_VALID, 1);\r\nSET_FIELD(tx_pq_map.reg, QM_RF_PQ_MAP_RL_VALID,\r\nis_vf_pq ? 1 : 0);\r\nSET_FIELD(tx_pq_map.reg, QM_RF_PQ_MAP_VP_PQ_ID, first_tx_pq_id);\r\nSET_FIELD(tx_pq_map.reg, QM_RF_PQ_MAP_RL_ID,\r\nis_vf_pq ? p_params->pq_params[i].vport_id : 0);\r\nSET_FIELD(tx_pq_map.reg, QM_RF_PQ_MAP_VOQ, voq);\r\nSET_FIELD(tx_pq_map.reg, QM_RF_PQ_MAP_WRR_WEIGHT_GROUP,\r\np_params->pq_params[i].wrr_group);\r\nSTORE_RT_REG(p_hwfn, QM_REG_TXPQMAP_RT_OFFSET + pq_id,\r\n*((u32 *)&tx_pq_map));\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_BASEADDRTXPQ_RT_OFFSET + pq_id,\r\nmem_addr_4kb);\r\nif (is_vf_pq) {\r\ntx_pq_vf_mask[pq_id / tx_pq_vf_mask_width] |=\r\n(1 << (pq_id % tx_pq_vf_mask_width));\r\nmem_addr_4kb += vport_pq_mem_4kb;\r\n} else {\r\nmem_addr_4kb += pq_mem_4kb;\r\n}\r\n}\r\nfor (i = 0; i < num_tx_pq_vf_masks; i++) {\r\nif (tx_pq_vf_mask[i]) {\r\nif (is_bb_a0) {\r\nu32 curr_mask = 0, addr;\r\naddr = QM_REG_MAXPQSIZETXSEL_0 + (i * 4);\r\nif (!p_params->is_first_pf)\r\ncurr_mask = qed_rd(p_hwfn, p_ptt,\r\naddr);\r\naddr = QM_REG_MAXPQSIZETXSEL_0_RT_OFFSET + i;\r\nSTORE_RT_REG(p_hwfn, addr,\r\ncurr_mask | tx_pq_vf_mask[i]);\r\n} else {\r\nu32 addr;\r\naddr = QM_REG_MAXPQSIZETXSEL_0_RT_OFFSET + i;\r\nSTORE_RT_REG(p_hwfn, addr,\r\ntx_pq_vf_mask[i]);\r\n}\r\n}\r\n}\r\n}\r\nstatic void qed_other_pq_map_rt_init(struct qed_hwfn *p_hwfn,\r\nu8 port_id,\r\nu8 pf_id,\r\nu32 num_pf_cids,\r\nu32 num_tids,\r\nu32 base_mem_addr_4kb)\r\n{\r\nu16 i, pq_id;\r\nu16 pq_group = pf_id;\r\nu32 pq_size = num_pf_cids + num_tids;\r\nu32 pq_mem_4kb = QM_PQ_MEM_4KB(pq_size);\r\nu32 mem_addr_4kb = base_mem_addr_4kb;\r\nSTORE_RT_REG(p_hwfn, QM_REG_PQOTHER2PF_0_RT_OFFSET + pq_group,\r\n(u32)(pf_id));\r\nSTORE_RT_REG(p_hwfn, QM_REG_MAXPQSIZE_2_RT_OFFSET,\r\nQM_PQ_SIZE_256B(pq_size));\r\nfor (i = 0, pq_id = pf_id * QM_PF_QUEUE_GROUP_SIZE;\r\ni < QM_OTHER_PQS_PER_PF; i++, pq_id++) {\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_BASEADDROTHERPQ_RT_OFFSET + pq_id,\r\nmem_addr_4kb);\r\nmem_addr_4kb += pq_mem_4kb;\r\n}\r\n}\r\nstatic int qed_pf_wfq_rt_init(struct qed_hwfn *p_hwfn,\r\nstruct qed_qm_pf_rt_init_params *p_params)\r\n{\r\nu16 num_tx_pqs = p_params->num_pf_pqs + p_params->num_vf_pqs;\r\nu32 crd_reg_offset;\r\nu32 inc_val;\r\nu16 i;\r\nif (p_params->pf_id < MAX_NUM_PFS_BB)\r\ncrd_reg_offset = QM_REG_WFQPFCRD_RT_OFFSET;\r\nelse\r\ncrd_reg_offset = QM_REG_WFQPFCRD_MSB_RT_OFFSET +\r\n(p_params->pf_id % MAX_NUM_PFS_BB);\r\ninc_val = QM_WFQ_INC_VAL(p_params->pf_wfq);\r\nif (inc_val > QM_WFQ_MAX_INC_VAL) {\r\nDP_NOTICE(p_hwfn, "Invalid PF WFQ weight configuration");\r\nreturn -1;\r\n}\r\nSTORE_RT_REG(p_hwfn, QM_REG_WFQPFWEIGHT_RT_OFFSET + p_params->pf_id,\r\ninc_val);\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_WFQPFUPPERBOUND_RT_OFFSET + p_params->pf_id,\r\nQM_WFQ_UPPER_BOUND | QM_WFQ_CRD_REG_SIGN_BIT);\r\nfor (i = 0; i < num_tx_pqs; i++) {\r\nu8 voq = VOQ(p_params->port_id, p_params->pq_params[i].tc_id,\r\np_params->max_phys_tcs_per_port);\r\nOVERWRITE_RT_REG(p_hwfn,\r\ncrd_reg_offset + voq * MAX_NUM_PFS_BB,\r\nQM_WFQ_INIT_CRD(inc_val) |\r\nQM_WFQ_CRD_REG_SIGN_BIT);\r\n}\r\nreturn 0;\r\n}\r\nstatic int qed_pf_rl_rt_init(struct qed_hwfn *p_hwfn,\r\nu8 pf_id,\r\nu32 pf_rl)\r\n{\r\nu32 inc_val = QM_RL_INC_VAL(pf_rl);\r\nif (inc_val > QM_RL_MAX_INC_VAL) {\r\nDP_NOTICE(p_hwfn, "Invalid PF rate limit configuration");\r\nreturn -1;\r\n}\r\nSTORE_RT_REG(p_hwfn, QM_REG_RLPFCRD_RT_OFFSET + pf_id,\r\nQM_RL_CRD_REG_SIGN_BIT);\r\nSTORE_RT_REG(p_hwfn, QM_REG_RLPFUPPERBOUND_RT_OFFSET + pf_id,\r\nQM_RL_UPPER_BOUND | QM_RL_CRD_REG_SIGN_BIT);\r\nSTORE_RT_REG(p_hwfn, QM_REG_RLPFINCVAL_RT_OFFSET + pf_id, inc_val);\r\nreturn 0;\r\n}\r\nstatic int qed_vp_wfq_rt_init(struct qed_hwfn *p_hwfn,\r\nu8 start_vport,\r\nu8 num_vports,\r\nstruct init_qm_vport_params *vport_params)\r\n{\r\nu8 tc, i, vport_id;\r\nu32 inc_val;\r\nfor (i = 0, vport_id = start_vport; i < num_vports; i++, vport_id++) {\r\nu32 temp = QM_REG_WFQVPUPPERBOUND_RT_OFFSET;\r\nu16 *pq_ids = &vport_params[i].first_tx_pq_id[0];\r\nif (!vport_params[i].vport_wfq)\r\ncontinue;\r\ninc_val = QM_WFQ_INC_VAL(vport_params[i].vport_wfq);\r\nif (inc_val > QM_WFQ_MAX_INC_VAL) {\r\nDP_NOTICE(p_hwfn,\r\n"Invalid VPORT WFQ weight configuration");\r\nreturn -1;\r\n}\r\nfor (tc = 0; tc < NUM_OF_TCS; tc++) {\r\nu16 vport_pq_id = pq_ids[tc];\r\nif (vport_pq_id != QM_INVALID_PQ_ID) {\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_WFQVPWEIGHT_RT_OFFSET +\r\nvport_pq_id, inc_val);\r\nSTORE_RT_REG(p_hwfn, temp + vport_pq_id,\r\nQM_WFQ_UPPER_BOUND |\r\nQM_WFQ_CRD_REG_SIGN_BIT);\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_WFQVPCRD_RT_OFFSET +\r\nvport_pq_id,\r\nQM_WFQ_INIT_CRD(inc_val) |\r\nQM_WFQ_CRD_REG_SIGN_BIT);\r\n}\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int qed_vport_rl_rt_init(struct qed_hwfn *p_hwfn,\r\nu8 start_vport,\r\nu8 num_vports,\r\nstruct init_qm_vport_params *vport_params)\r\n{\r\nu8 i, vport_id;\r\nfor (i = 0, vport_id = start_vport; i < num_vports; i++, vport_id++) {\r\nu32 inc_val = QM_RL_INC_VAL(vport_params[i].vport_rl);\r\nif (inc_val > QM_RL_MAX_INC_VAL) {\r\nDP_NOTICE(p_hwfn,\r\n"Invalid VPORT rate-limit configuration");\r\nreturn -1;\r\n}\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_RLGLBLCRD_RT_OFFSET + vport_id,\r\nQM_RL_CRD_REG_SIGN_BIT);\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_RLGLBLUPPERBOUND_RT_OFFSET + vport_id,\r\nQM_RL_UPPER_BOUND | QM_RL_CRD_REG_SIGN_BIT);\r\nSTORE_RT_REG(p_hwfn,\r\nQM_REG_RLGLBLINCVAL_RT_OFFSET + vport_id,\r\ninc_val);\r\n}\r\nreturn 0;\r\n}\r\nstatic bool qed_poll_on_qm_cmd_ready(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt)\r\n{\r\nu32 reg_val, i;\r\nfor (i = 0, reg_val = 0; i < QM_STOP_CMD_MAX_POLL_COUNT && reg_val == 0;\r\ni++) {\r\nudelay(QM_STOP_CMD_POLL_PERIOD_US);\r\nreg_val = qed_rd(p_hwfn, p_ptt, QM_REG_SDMCMDREADY);\r\n}\r\nif (i == QM_STOP_CMD_MAX_POLL_COUNT) {\r\nDP_VERBOSE(p_hwfn, NETIF_MSG_HW,\r\n"Timeout when waiting for QM SDM command ready signal\n");\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nstatic bool qed_send_qm_cmd(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt,\r\nu32 cmd_addr,\r\nu32 cmd_data_lsb,\r\nu32 cmd_data_msb)\r\n{\r\nif (!qed_poll_on_qm_cmd_ready(p_hwfn, p_ptt))\r\nreturn false;\r\nqed_wr(p_hwfn, p_ptt, QM_REG_SDMCMDADDR, cmd_addr);\r\nqed_wr(p_hwfn, p_ptt, QM_REG_SDMCMDDATALSB, cmd_data_lsb);\r\nqed_wr(p_hwfn, p_ptt, QM_REG_SDMCMDDATAMSB, cmd_data_msb);\r\nqed_wr(p_hwfn, p_ptt, QM_REG_SDMCMDGO, 1);\r\nqed_wr(p_hwfn, p_ptt, QM_REG_SDMCMDGO, 0);\r\nreturn qed_poll_on_qm_cmd_ready(p_hwfn, p_ptt);\r\n}\r\nu32 qed_qm_pf_mem_size(u8 pf_id,\r\nu32 num_pf_cids,\r\nu32 num_vf_cids,\r\nu32 num_tids,\r\nu16 num_pf_pqs,\r\nu16 num_vf_pqs)\r\n{\r\nreturn QM_PQ_MEM_4KB(num_pf_cids) * num_pf_pqs +\r\nQM_PQ_MEM_4KB(num_vf_cids) * num_vf_pqs +\r\nQM_PQ_MEM_4KB(num_pf_cids + num_tids) * QM_OTHER_PQS_PER_PF;\r\n}\r\nint qed_qm_common_rt_init(\r\nstruct qed_hwfn *p_hwfn,\r\nstruct qed_qm_common_rt_init_params *p_params)\r\n{\r\nu32 mask = (QM_OPPOR_LINE_VOQ_DEF <<\r\nQM_RF_OPPORTUNISTIC_MASK_LINEVOQ_SHIFT) |\r\n(QM_BYTE_CRD_EN << QM_RF_OPPORTUNISTIC_MASK_BYTEVOQ_SHIFT) |\r\n(p_params->pf_wfq_en <<\r\nQM_RF_OPPORTUNISTIC_MASK_PFWFQ_SHIFT) |\r\n(p_params->vport_wfq_en <<\r\nQM_RF_OPPORTUNISTIC_MASK_VPWFQ_SHIFT) |\r\n(p_params->pf_rl_en <<\r\nQM_RF_OPPORTUNISTIC_MASK_PFRL_SHIFT) |\r\n(p_params->vport_rl_en <<\r\nQM_RF_OPPORTUNISTIC_MASK_VPQCNRL_SHIFT) |\r\n(QM_OPPOR_FW_STOP_DEF <<\r\nQM_RF_OPPORTUNISTIC_MASK_FWPAUSE_SHIFT) |\r\n(QM_OPPOR_PQ_EMPTY_DEF <<\r\nQM_RF_OPPORTUNISTIC_MASK_QUEUEEMPTY_SHIFT);\r\nSTORE_RT_REG(p_hwfn, QM_REG_AFULLOPRTNSTCCRDMASK_RT_OFFSET, mask);\r\nqed_enable_pf_rl(p_hwfn, p_params->pf_rl_en);\r\nqed_enable_pf_wfq(p_hwfn, p_params->pf_wfq_en);\r\nqed_enable_vport_rl(p_hwfn, p_params->vport_rl_en);\r\nqed_enable_vport_wfq(p_hwfn, p_params->vport_wfq_en);\r\nqed_cmdq_lines_rt_init(p_hwfn,\r\np_params->max_ports_per_engine,\r\np_params->max_phys_tcs_per_port,\r\np_params->port_params);\r\nqed_btb_blocks_rt_init(p_hwfn,\r\np_params->max_ports_per_engine,\r\np_params->max_phys_tcs_per_port,\r\np_params->port_params);\r\nreturn 0;\r\n}\r\nint qed_qm_pf_rt_init(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt,\r\nstruct qed_qm_pf_rt_init_params *p_params)\r\n{\r\nstruct init_qm_vport_params *vport_params = p_params->vport_params;\r\nu32 other_mem_size_4kb = QM_PQ_MEM_4KB(p_params->num_pf_cids +\r\np_params->num_tids) *\r\nQM_OTHER_PQS_PER_PF;\r\nu8 tc, i;\r\nfor (i = 0; i < p_params->num_vports; i++)\r\nfor (tc = 0; tc < NUM_OF_TCS; tc++)\r\nvport_params[i].first_tx_pq_id[tc] = QM_INVALID_PQ_ID;\r\nqed_other_pq_map_rt_init(p_hwfn, p_params->port_id, p_params->pf_id,\r\np_params->num_pf_cids, p_params->num_tids, 0);\r\nqed_tx_pq_map_rt_init(p_hwfn, p_ptt, p_params, other_mem_size_4kb);\r\nif (p_params->pf_wfq)\r\nif (qed_pf_wfq_rt_init(p_hwfn, p_params))\r\nreturn -1;\r\nif (qed_pf_rl_rt_init(p_hwfn, p_params->pf_id, p_params->pf_rl))\r\nreturn -1;\r\nif (qed_vp_wfq_rt_init(p_hwfn, p_params->start_vport,\r\np_params->num_vports, vport_params))\r\nreturn -1;\r\nif (qed_vport_rl_rt_init(p_hwfn, p_params->start_vport,\r\np_params->num_vports, vport_params))\r\nreturn -1;\r\nreturn 0;\r\n}\r\nint qed_init_pf_rl(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt,\r\nu8 pf_id,\r\nu32 pf_rl)\r\n{\r\nu32 inc_val = QM_RL_INC_VAL(pf_rl);\r\nif (inc_val > QM_RL_MAX_INC_VAL) {\r\nDP_NOTICE(p_hwfn, "Invalid PF rate limit configuration");\r\nreturn -1;\r\n}\r\nqed_wr(p_hwfn, p_ptt,\r\nQM_REG_RLPFCRD + pf_id * 4,\r\nQM_RL_CRD_REG_SIGN_BIT);\r\nqed_wr(p_hwfn, p_ptt, QM_REG_RLPFINCVAL + pf_id * 4, inc_val);\r\nreturn 0;\r\n}\r\nint qed_init_vport_rl(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt,\r\nu8 vport_id,\r\nu32 vport_rl)\r\n{\r\nu32 inc_val = QM_RL_INC_VAL(vport_rl);\r\nif (inc_val > QM_RL_MAX_INC_VAL) {\r\nDP_NOTICE(p_hwfn, "Invalid VPORT rate-limit configuration");\r\nreturn -1;\r\n}\r\nqed_wr(p_hwfn, p_ptt,\r\nQM_REG_RLGLBLCRD + vport_id * 4,\r\nQM_RL_CRD_REG_SIGN_BIT);\r\nqed_wr(p_hwfn, p_ptt, QM_REG_RLGLBLINCVAL + vport_id * 4, inc_val);\r\nreturn 0;\r\n}\r\nbool qed_send_qm_stop_cmd(struct qed_hwfn *p_hwfn,\r\nstruct qed_ptt *p_ptt,\r\nbool is_release_cmd,\r\nbool is_tx_pq,\r\nu16 start_pq,\r\nu16 num_pqs)\r\n{\r\nu32 cmd_arr[QM_CMD_STRUCT_SIZE(QM_STOP_CMD)] = { 0 };\r\nu32 pq_mask = 0, last_pq = start_pq + num_pqs - 1, pq_id;\r\nQM_CMD_SET_FIELD(cmd_arr, QM_STOP_CMD, PQ_TYPE, is_tx_pq ? 0 : 1);\r\nfor (pq_id = start_pq; pq_id <= last_pq; pq_id++) {\r\nif (!is_release_cmd)\r\npq_mask |= (1 << (pq_id % QM_STOP_PQ_MASK_WIDTH));\r\nif ((pq_id == last_pq) ||\r\n(pq_id % QM_STOP_PQ_MASK_WIDTH ==\r\n(QM_STOP_PQ_MASK_WIDTH - 1))) {\r\nQM_CMD_SET_FIELD(cmd_arr, QM_STOP_CMD,\r\nPAUSE_MASK, pq_mask);\r\nQM_CMD_SET_FIELD(cmd_arr, QM_STOP_CMD,\r\nGROUP_ID,\r\npq_id / QM_STOP_PQ_MASK_WIDTH);\r\nif (!qed_send_qm_cmd(p_hwfn, p_ptt, QM_STOP_CMD_ADDR,\r\ncmd_arr[0], cmd_arr[1]))\r\nreturn false;\r\npq_mask = 0;\r\n}\r\n}\r\nreturn true;\r\n}

irqreturn_t netup_spi_interrupt(struct netup_spi *spi)\r\n{\r\nu16 reg;\r\nunsigned long flags;\r\nif (!spi)\r\nreturn IRQ_NONE;\r\nspin_lock_irqsave(&spi->lock, flags);\r\nreg = readw(&spi->regs->control_stat);\r\nif (!(reg & NETUP_SPI_CTRL_IRQ)) {\r\nspin_unlock_irqrestore(&spi->lock, flags);\r\ndev_dbg(&spi->master->dev,\r\n"%s(): not mine interrupt\n", __func__);\r\nreturn IRQ_NONE;\r\n}\r\nwritew(reg | NETUP_SPI_CTRL_IRQ, &spi->regs->control_stat);\r\nreg = readw(&spi->regs->control_stat);\r\nwritew(reg & ~NETUP_SPI_CTRL_IMASK, &spi->regs->control_stat);\r\nspi->state = SPI_STATE_DONE;\r\nwake_up(&spi->waitq);\r\nspin_unlock_irqrestore(&spi->lock, flags);\r\ndev_dbg(&spi->master->dev,\r\n"%s(): SPI interrupt handled\n", __func__);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int netup_spi_transfer(struct spi_master *master,\r\nstruct spi_message *msg)\r\n{\r\nstruct netup_spi *spi = spi_master_get_devdata(master);\r\nstruct spi_transfer *t;\r\nint result = 0;\r\nu32 tr_size;\r\nwritew(NETUP_SPI_CTRL_LAST_CS, &spi->regs->control_stat);\r\nwritew(0, &spi->regs->control_stat);\r\nlist_for_each_entry(t, &msg->transfers, transfer_list) {\r\ntr_size = t->len;\r\nwhile (tr_size) {\r\nu32 frag_offset = t->len - tr_size;\r\nu32 frag_size = (tr_size > sizeof(spi->regs->data)) ?\r\nsizeof(spi->regs->data) : tr_size;\r\nint frag_last = 0;\r\nif (list_is_last(&t->transfer_list,\r\n&msg->transfers) &&\r\nfrag_offset + frag_size == t->len) {\r\nfrag_last = 1;\r\n}\r\nif (t->tx_buf) {\r\nmemcpy_toio(spi->regs->data,\r\nt->tx_buf + frag_offset,\r\nfrag_size);\r\n} else {\r\nmemset_io(spi->regs->data,\r\n0, frag_size);\r\n}\r\nspi->state = SPI_STATE_START;\r\nwritew((frag_size & 0x3ff) |\r\nNETUP_SPI_CTRL_IMASK |\r\nNETUP_SPI_CTRL_START |\r\n(frag_last ? NETUP_SPI_CTRL_LAST_CS : 0),\r\n&spi->regs->control_stat);\r\ndev_dbg(&spi->master->dev,\r\n"%s(): control_stat 0x%04x\n",\r\n__func__, readw(&spi->regs->control_stat));\r\nwait_event_timeout(spi->waitq,\r\nspi->state != SPI_STATE_START,\r\nmsecs_to_jiffies(NETUP_SPI_TIMEOUT));\r\nif (spi->state == SPI_STATE_DONE) {\r\nif (t->rx_buf) {\r\nmemcpy_fromio(t->rx_buf + frag_offset,\r\nspi->regs->data, frag_size);\r\n}\r\n} else {\r\nif (spi->state == SPI_STATE_START) {\r\ndev_dbg(&spi->master->dev,\r\n"%s(): transfer timeout\n",\r\n__func__);\r\n} else {\r\ndev_dbg(&spi->master->dev,\r\n"%s(): invalid state %d\n",\r\n__func__, spi->state);\r\n}\r\nresult = -EIO;\r\ngoto done;\r\n}\r\ntr_size -= frag_size;\r\nmsg->actual_length += frag_size;\r\n}\r\n}\r\ndone:\r\nmsg->status = result;\r\nspi_finalize_current_message(master);\r\nreturn result;\r\n}\r\nstatic int netup_spi_setup(struct spi_device *spi)\r\n{\r\nreturn 0;\r\n}\r\nint netup_spi_init(struct netup_unidvb_dev *ndev)\r\n{\r\nstruct spi_master *master;\r\nstruct netup_spi *nspi;\r\nmaster = spi_alloc_master(&ndev->pci_dev->dev,\r\nsizeof(struct netup_spi));\r\nif (!master) {\r\ndev_err(&ndev->pci_dev->dev,\r\n"%s(): unable to alloc SPI master\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nnspi = spi_master_get_devdata(master);\r\nmaster->mode_bits = SPI_CPOL | SPI_CPHA | SPI_LSB_FIRST;\r\nmaster->bus_num = -1;\r\nmaster->num_chipselect = 1;\r\nmaster->transfer_one_message = netup_spi_transfer;\r\nmaster->setup = netup_spi_setup;\r\nspin_lock_init(&nspi->lock);\r\ninit_waitqueue_head(&nspi->waitq);\r\nnspi->master = master;\r\nnspi->regs = (struct netup_spi_regs __iomem *)(ndev->bmmio0 + 0x4000);\r\nwritew(2, &nspi->regs->clock_divider);\r\nwritew(NETUP_UNIDVB_IRQ_SPI, ndev->bmmio0 + REG_IMASK_SET);\r\nndev->spi = nspi;\r\nif (spi_register_master(master)) {\r\nndev->spi = NULL;\r\ndev_err(&ndev->pci_dev->dev,\r\n"%s(): unable to register SPI bus\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nsnprintf(netup_spi_name,\r\nsizeof(netup_spi_name),\r\n"fpga_%02x:%02x.%01x",\r\nndev->pci_bus,\r\nndev->pci_slot,\r\nndev->pci_func);\r\nif (!spi_new_device(master, &netup_spi_board)) {\r\nndev->spi = NULL;\r\ndev_err(&ndev->pci_dev->dev,\r\n"%s(): unable to create SPI device\n", __func__);\r\nreturn -EINVAL;\r\n}\r\ndev_dbg(&ndev->pci_dev->dev, "%s(): SPI init OK\n", __func__);\r\nreturn 0;\r\n}\r\nvoid netup_spi_release(struct netup_unidvb_dev *ndev)\r\n{\r\nu16 reg;\r\nunsigned long flags;\r\nstruct netup_spi *spi = ndev->spi;\r\nif (!spi)\r\nreturn;\r\nspin_lock_irqsave(&spi->lock, flags);\r\nreg = readw(&spi->regs->control_stat);\r\nwritew(reg | NETUP_SPI_CTRL_IRQ, &spi->regs->control_stat);\r\nreg = readw(&spi->regs->control_stat);\r\nwritew(reg & ~NETUP_SPI_CTRL_IMASK, &spi->regs->control_stat);\r\nspin_unlock_irqrestore(&spi->lock, flags);\r\nspi_unregister_master(spi->master);\r\nndev->spi = NULL;\r\n}

int dasd_gendisk_alloc(struct dasd_block *block)\r\n{\r\nstruct gendisk *gdp;\r\nstruct dasd_device *base;\r\nint len;\r\nbase = block->base;\r\nif (base->devindex >= DASD_PER_MAJOR)\r\nreturn -EBUSY;\r\ngdp = alloc_disk(1 << DASD_PARTN_BITS);\r\nif (!gdp)\r\nreturn -ENOMEM;\r\ngdp->major = DASD_MAJOR;\r\ngdp->first_minor = base->devindex << DASD_PARTN_BITS;\r\ngdp->fops = &dasd_device_operations;\r\ngdp->driverfs_dev = &base->cdev->dev;\r\nlen = sprintf(gdp->disk_name, "dasd");\r\nif (base->devindex > 25) {\r\nif (base->devindex > 701) {\r\nif (base->devindex > 18277)\r\nlen += sprintf(gdp->disk_name + len, "%c",\r\n'a'+(((base->devindex-18278)\r\n/17576)%26));\r\nlen += sprintf(gdp->disk_name + len, "%c",\r\n'a'+(((base->devindex-702)/676)%26));\r\n}\r\nlen += sprintf(gdp->disk_name + len, "%c",\r\n'a'+(((base->devindex-26)/26)%26));\r\n}\r\nlen += sprintf(gdp->disk_name + len, "%c", 'a'+(base->devindex%26));\r\nif (base->features & DASD_FEATURE_READONLY ||\r\ntest_bit(DASD_FLAG_DEVICE_RO, &base->flags))\r\nset_disk_ro(gdp, 1);\r\ndasd_add_link_to_gendisk(gdp, base);\r\ngdp->queue = block->request_queue;\r\nblock->gdp = gdp;\r\nset_capacity(block->gdp, 0);\r\nadd_disk(block->gdp);\r\nreturn 0;\r\n}\r\nvoid dasd_gendisk_free(struct dasd_block *block)\r\n{\r\nif (block->gdp) {\r\ndel_gendisk(block->gdp);\r\nblock->gdp->private_data = NULL;\r\nput_disk(block->gdp);\r\nblock->gdp = NULL;\r\n}\r\n}\r\nint dasd_scan_partitions(struct dasd_block *block)\r\n{\r\nstruct block_device *bdev;\r\nint rc;\r\nbdev = bdget_disk(block->gdp, 0);\r\nif (!bdev) {\r\nDBF_DEV_EVENT(DBF_ERR, block->base, "%s",\r\n"scan partitions error, bdget returned NULL");\r\nreturn -ENODEV;\r\n}\r\nrc = blkdev_get(bdev, FMODE_READ, NULL);\r\nif (rc < 0) {\r\nDBF_DEV_EVENT(DBF_ERR, block->base,\r\n"scan partitions error, blkdev_get returned %d",\r\nrc);\r\nreturn -ENODEV;\r\n}\r\nrc = blkdev_reread_part(bdev);\r\nif (rc)\r\nDBF_DEV_EVENT(DBF_ERR, block->base,\r\n"scan partitions error, rc %d", rc);\r\nblock->bdev = bdev;\r\nreturn 0;\r\n}\r\nvoid dasd_destroy_partitions(struct dasd_block *block)\r\n{\r\nstruct blkpg_partition bpart;\r\nstruct blkpg_ioctl_arg barg;\r\nstruct block_device *bdev;\r\nbdev = block->bdev;\r\nblock->bdev = NULL;\r\nmemset(&bpart, 0, sizeof(struct blkpg_partition));\r\nmemset(&barg, 0, sizeof(struct blkpg_ioctl_arg));\r\nbarg.data = (void __force __user *) &bpart;\r\nbarg.op = BLKPG_DEL_PARTITION;\r\nfor (bpart.pno = block->gdp->minors - 1; bpart.pno > 0; bpart.pno--)\r\nioctl_by_bdev(bdev, BLKPG, (unsigned long) &barg);\r\ninvalidate_partition(block->gdp, 0);\r\nblkdev_put(bdev, FMODE_READ);\r\nset_capacity(block->gdp, 0);\r\n}\r\nint dasd_gendisk_init(void)\r\n{\r\nint rc;\r\nrc = register_blkdev(DASD_MAJOR, "dasd");\r\nif (rc != 0) {\r\npr_warning("Registering the device driver with major number "\r\n"%d failed\n", DASD_MAJOR);\r\nreturn rc;\r\n}\r\nreturn 0;\r\n}\r\nvoid dasd_gendisk_exit(void)\r\n{\r\nunregister_blkdev(DASD_MAJOR, "dasd");\r\n}

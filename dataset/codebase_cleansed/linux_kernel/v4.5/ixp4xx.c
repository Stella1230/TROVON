static inline u16 flash_read16(void __iomem *addr)\r\n{\r\nreturn be16_to_cpu(__raw_readw((void __iomem *)((unsigned long)addr ^ 0x2)));\r\n}\r\nstatic inline void flash_write16(u16 d, void __iomem *addr)\r\n{\r\n__raw_writew(cpu_to_be16(d), (void __iomem *)((unsigned long)addr ^ 0x2));\r\n}\r\nstatic inline u16 flash_read16(const void __iomem *addr)\r\n{\r\nreturn __raw_readw(addr);\r\n}\r\nstatic inline void flash_write16(u16 d, void __iomem *addr)\r\n{\r\n__raw_writew(d, addr);\r\n}\r\nstatic map_word ixp4xx_read16(struct map_info *map, unsigned long ofs)\r\n{\r\nmap_word val;\r\nval.x[0] = flash_read16(map->virt + ofs);\r\nreturn val;\r\n}\r\nstatic void ixp4xx_copy_from(struct map_info *map, void *to,\r\nunsigned long from, ssize_t len)\r\n{\r\nu8 *dest = (u8 *) to;\r\nvoid __iomem *src = map->virt + from;\r\nif (len <= 0)\r\nreturn;\r\nif (from & 1) {\r\n*dest++ = BYTE1(flash_read16(src-1));\r\nsrc++;\r\n--len;\r\n}\r\nwhile (len >= 2) {\r\nu16 data = flash_read16(src);\r\n*dest++ = BYTE0(data);\r\n*dest++ = BYTE1(data);\r\nsrc += 2;\r\nlen -= 2;\r\n}\r\nif (len > 0)\r\n*dest++ = BYTE0(flash_read16(src));\r\n}\r\nstatic void ixp4xx_probe_write16(struct map_info *map, map_word d, unsigned long adr)\r\n{\r\nif (!(adr & 1))\r\nflash_write16(d.x[0], map->virt + adr);\r\n}\r\nstatic void ixp4xx_write16(struct map_info *map, map_word d, unsigned long adr)\r\n{\r\nflash_write16(d.x[0], map->virt + adr);\r\n}\r\nstatic int ixp4xx_flash_remove(struct platform_device *dev)\r\n{\r\nstruct flash_platform_data *plat = dev_get_platdata(&dev->dev);\r\nstruct ixp4xx_flash_info *info = platform_get_drvdata(dev);\r\nif(!info)\r\nreturn 0;\r\nif (info->mtd) {\r\nmtd_device_unregister(info->mtd);\r\nmap_destroy(info->mtd);\r\n}\r\nif (plat->exit)\r\nplat->exit();\r\nreturn 0;\r\n}\r\nstatic int ixp4xx_flash_probe(struct platform_device *dev)\r\n{\r\nstruct flash_platform_data *plat = dev_get_platdata(&dev->dev);\r\nstruct ixp4xx_flash_info *info;\r\nstruct mtd_part_parser_data ppdata = {\r\n.origin = dev->resource->start,\r\n};\r\nint err = -1;\r\nif (!plat)\r\nreturn -ENODEV;\r\nif (plat->init) {\r\nerr = plat->init();\r\nif (err)\r\nreturn err;\r\n}\r\ninfo = devm_kzalloc(&dev->dev, sizeof(struct ixp4xx_flash_info),\r\nGFP_KERNEL);\r\nif(!info) {\r\nerr = -ENOMEM;\r\ngoto Error;\r\n}\r\nplatform_set_drvdata(dev, info);\r\ninfo->map.phys = NO_XIP;\r\ninfo->map.size = resource_size(dev->resource);\r\ninfo->map.bankwidth = 2;\r\ninfo->map.name = dev_name(&dev->dev);\r\ninfo->map.read = ixp4xx_read16;\r\ninfo->map.write = ixp4xx_probe_write16;\r\ninfo->map.copy_from = ixp4xx_copy_from;\r\ninfo->map.virt = devm_ioremap_resource(&dev->dev, dev->resource);\r\nif (IS_ERR(info->map.virt)) {\r\nerr = PTR_ERR(info->map.virt);\r\ngoto Error;\r\n}\r\ninfo->mtd = do_map_probe(plat->map_name, &info->map);\r\nif (!info->mtd) {\r\nprintk(KERN_ERR "IXP4XXFlash: map_probe failed\n");\r\nerr = -ENXIO;\r\ngoto Error;\r\n}\r\ninfo->mtd->dev.parent = &dev->dev;\r\ninfo->map.write = ixp4xx_write16;\r\nerr = mtd_device_parse_register(info->mtd, probes, &ppdata,\r\nplat->parts, plat->nr_parts);\r\nif (err) {\r\nprintk(KERN_ERR "Could not parse partitions\n");\r\ngoto Error;\r\n}\r\nreturn 0;\r\nError:\r\nixp4xx_flash_remove(dev);\r\nreturn err;\r\n}

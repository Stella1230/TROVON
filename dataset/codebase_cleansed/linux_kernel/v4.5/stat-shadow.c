static int evsel_context(struct perf_evsel *evsel)\r\n{\r\nint ctx = 0;\r\nif (evsel->attr.exclude_kernel)\r\nctx |= CTX_BIT_KERNEL;\r\nif (evsel->attr.exclude_user)\r\nctx |= CTX_BIT_USER;\r\nif (evsel->attr.exclude_hv)\r\nctx |= CTX_BIT_HV;\r\nif (evsel->attr.exclude_host)\r\nctx |= CTX_BIT_HOST;\r\nif (evsel->attr.exclude_idle)\r\nctx |= CTX_BIT_IDLE;\r\nreturn ctx;\r\n}\r\nvoid perf_stat__reset_shadow_stats(void)\r\n{\r\nmemset(runtime_nsecs_stats, 0, sizeof(runtime_nsecs_stats));\r\nmemset(runtime_cycles_stats, 0, sizeof(runtime_cycles_stats));\r\nmemset(runtime_stalled_cycles_front_stats, 0, sizeof(runtime_stalled_cycles_front_stats));\r\nmemset(runtime_stalled_cycles_back_stats, 0, sizeof(runtime_stalled_cycles_back_stats));\r\nmemset(runtime_branches_stats, 0, sizeof(runtime_branches_stats));\r\nmemset(runtime_cacherefs_stats, 0, sizeof(runtime_cacherefs_stats));\r\nmemset(runtime_l1_dcache_stats, 0, sizeof(runtime_l1_dcache_stats));\r\nmemset(runtime_l1_icache_stats, 0, sizeof(runtime_l1_icache_stats));\r\nmemset(runtime_ll_cache_stats, 0, sizeof(runtime_ll_cache_stats));\r\nmemset(runtime_itlb_cache_stats, 0, sizeof(runtime_itlb_cache_stats));\r\nmemset(runtime_dtlb_cache_stats, 0, sizeof(runtime_dtlb_cache_stats));\r\nmemset(runtime_cycles_in_tx_stats, 0,\r\nsizeof(runtime_cycles_in_tx_stats));\r\nmemset(runtime_transaction_stats, 0,\r\nsizeof(runtime_transaction_stats));\r\nmemset(runtime_elision_stats, 0, sizeof(runtime_elision_stats));\r\nmemset(&walltime_nsecs_stats, 0, sizeof(walltime_nsecs_stats));\r\n}\r\nvoid perf_stat__update_shadow_stats(struct perf_evsel *counter, u64 *count,\r\nint cpu)\r\n{\r\nint ctx = evsel_context(counter);\r\nif (perf_evsel__match(counter, SOFTWARE, SW_TASK_CLOCK))\r\nupdate_stats(&runtime_nsecs_stats[cpu], count[0]);\r\nelse if (perf_evsel__match(counter, HARDWARE, HW_CPU_CYCLES))\r\nupdate_stats(&runtime_cycles_stats[ctx][cpu], count[0]);\r\nelse if (perf_stat_evsel__is(counter, CYCLES_IN_TX))\r\nupdate_stats(&runtime_cycles_in_tx_stats[ctx][cpu], count[0]);\r\nelse if (perf_stat_evsel__is(counter, TRANSACTION_START))\r\nupdate_stats(&runtime_transaction_stats[ctx][cpu], count[0]);\r\nelse if (perf_stat_evsel__is(counter, ELISION_START))\r\nupdate_stats(&runtime_elision_stats[ctx][cpu], count[0]);\r\nelse if (perf_evsel__match(counter, HARDWARE, HW_STALLED_CYCLES_FRONTEND))\r\nupdate_stats(&runtime_stalled_cycles_front_stats[ctx][cpu], count[0]);\r\nelse if (perf_evsel__match(counter, HARDWARE, HW_STALLED_CYCLES_BACKEND))\r\nupdate_stats(&runtime_stalled_cycles_back_stats[ctx][cpu], count[0]);\r\nelse if (perf_evsel__match(counter, HARDWARE, HW_BRANCH_INSTRUCTIONS))\r\nupdate_stats(&runtime_branches_stats[ctx][cpu], count[0]);\r\nelse if (perf_evsel__match(counter, HARDWARE, HW_CACHE_REFERENCES))\r\nupdate_stats(&runtime_cacherefs_stats[ctx][cpu], count[0]);\r\nelse if (perf_evsel__match(counter, HW_CACHE, HW_CACHE_L1D))\r\nupdate_stats(&runtime_l1_dcache_stats[ctx][cpu], count[0]);\r\nelse if (perf_evsel__match(counter, HW_CACHE, HW_CACHE_L1I))\r\nupdate_stats(&runtime_ll_cache_stats[ctx][cpu], count[0]);\r\nelse if (perf_evsel__match(counter, HW_CACHE, HW_CACHE_LL))\r\nupdate_stats(&runtime_ll_cache_stats[ctx][cpu], count[0]);\r\nelse if (perf_evsel__match(counter, HW_CACHE, HW_CACHE_DTLB))\r\nupdate_stats(&runtime_dtlb_cache_stats[ctx][cpu], count[0]);\r\nelse if (perf_evsel__match(counter, HW_CACHE, HW_CACHE_ITLB))\r\nupdate_stats(&runtime_itlb_cache_stats[ctx][cpu], count[0]);\r\n}\r\nstatic const char *get_ratio_color(enum grc_type type, double ratio)\r\n{\r\nstatic const double grc_table[GRC_MAX_NR][3] = {\r\n[GRC_STALLED_CYCLES_FE] = { 50.0, 30.0, 10.0 },\r\n[GRC_STALLED_CYCLES_BE] = { 75.0, 50.0, 20.0 },\r\n[GRC_CACHE_MISSES] = { 20.0, 10.0, 5.0 },\r\n};\r\nconst char *color = PERF_COLOR_NORMAL;\r\nif (ratio > grc_table[type][0])\r\ncolor = PERF_COLOR_RED;\r\nelse if (ratio > grc_table[type][1])\r\ncolor = PERF_COLOR_MAGENTA;\r\nelse if (ratio > grc_table[type][2])\r\ncolor = PERF_COLOR_YELLOW;\r\nreturn color;\r\n}\r\nstatic void print_stalled_cycles_frontend(FILE *out, int cpu,\r\nstruct perf_evsel *evsel\r\n__maybe_unused, double avg)\r\n{\r\ndouble total, ratio = 0.0;\r\nconst char *color;\r\nint ctx = evsel_context(evsel);\r\ntotal = avg_stats(&runtime_cycles_stats[ctx][cpu]);\r\nif (total)\r\nratio = avg / total * 100.0;\r\ncolor = get_ratio_color(GRC_STALLED_CYCLES_FE, ratio);\r\nfprintf(out, " # ");\r\ncolor_fprintf(out, color, "%6.2f%%", ratio);\r\nfprintf(out, " frontend cycles idle ");\r\n}\r\nstatic void print_stalled_cycles_backend(FILE *out, int cpu,\r\nstruct perf_evsel *evsel\r\n__maybe_unused, double avg)\r\n{\r\ndouble total, ratio = 0.0;\r\nconst char *color;\r\nint ctx = evsel_context(evsel);\r\ntotal = avg_stats(&runtime_cycles_stats[ctx][cpu]);\r\nif (total)\r\nratio = avg / total * 100.0;\r\ncolor = get_ratio_color(GRC_STALLED_CYCLES_BE, ratio);\r\nfprintf(out, " # ");\r\ncolor_fprintf(out, color, "%6.2f%%", ratio);\r\nfprintf(out, " backend cycles idle ");\r\n}\r\nstatic void print_branch_misses(FILE *out, int cpu,\r\nstruct perf_evsel *evsel __maybe_unused,\r\ndouble avg)\r\n{\r\ndouble total, ratio = 0.0;\r\nconst char *color;\r\nint ctx = evsel_context(evsel);\r\ntotal = avg_stats(&runtime_branches_stats[ctx][cpu]);\r\nif (total)\r\nratio = avg / total * 100.0;\r\ncolor = get_ratio_color(GRC_CACHE_MISSES, ratio);\r\nfprintf(out, " # ");\r\ncolor_fprintf(out, color, "%6.2f%%", ratio);\r\nfprintf(out, " of all branches ");\r\n}\r\nstatic void print_l1_dcache_misses(FILE *out, int cpu,\r\nstruct perf_evsel *evsel __maybe_unused,\r\ndouble avg)\r\n{\r\ndouble total, ratio = 0.0;\r\nconst char *color;\r\nint ctx = evsel_context(evsel);\r\ntotal = avg_stats(&runtime_l1_dcache_stats[ctx][cpu]);\r\nif (total)\r\nratio = avg / total * 100.0;\r\ncolor = get_ratio_color(GRC_CACHE_MISSES, ratio);\r\nfprintf(out, " # ");\r\ncolor_fprintf(out, color, "%6.2f%%", ratio);\r\nfprintf(out, " of all L1-dcache hits ");\r\n}\r\nstatic void print_l1_icache_misses(FILE *out, int cpu,\r\nstruct perf_evsel *evsel __maybe_unused,\r\ndouble avg)\r\n{\r\ndouble total, ratio = 0.0;\r\nconst char *color;\r\nint ctx = evsel_context(evsel);\r\ntotal = avg_stats(&runtime_l1_icache_stats[ctx][cpu]);\r\nif (total)\r\nratio = avg / total * 100.0;\r\ncolor = get_ratio_color(GRC_CACHE_MISSES, ratio);\r\nfprintf(out, " # ");\r\ncolor_fprintf(out, color, "%6.2f%%", ratio);\r\nfprintf(out, " of all L1-icache hits ");\r\n}\r\nstatic void print_dtlb_cache_misses(FILE *out, int cpu,\r\nstruct perf_evsel *evsel __maybe_unused,\r\ndouble avg)\r\n{\r\ndouble total, ratio = 0.0;\r\nconst char *color;\r\nint ctx = evsel_context(evsel);\r\ntotal = avg_stats(&runtime_dtlb_cache_stats[ctx][cpu]);\r\nif (total)\r\nratio = avg / total * 100.0;\r\ncolor = get_ratio_color(GRC_CACHE_MISSES, ratio);\r\nfprintf(out, " # ");\r\ncolor_fprintf(out, color, "%6.2f%%", ratio);\r\nfprintf(out, " of all dTLB cache hits ");\r\n}\r\nstatic void print_itlb_cache_misses(FILE *out, int cpu,\r\nstruct perf_evsel *evsel __maybe_unused,\r\ndouble avg)\r\n{\r\ndouble total, ratio = 0.0;\r\nconst char *color;\r\nint ctx = evsel_context(evsel);\r\ntotal = avg_stats(&runtime_itlb_cache_stats[ctx][cpu]);\r\nif (total)\r\nratio = avg / total * 100.0;\r\ncolor = get_ratio_color(GRC_CACHE_MISSES, ratio);\r\nfprintf(out, " # ");\r\ncolor_fprintf(out, color, "%6.2f%%", ratio);\r\nfprintf(out, " of all iTLB cache hits ");\r\n}\r\nstatic void print_ll_cache_misses(FILE *out, int cpu,\r\nstruct perf_evsel *evsel __maybe_unused,\r\ndouble avg)\r\n{\r\ndouble total, ratio = 0.0;\r\nconst char *color;\r\nint ctx = evsel_context(evsel);\r\ntotal = avg_stats(&runtime_ll_cache_stats[ctx][cpu]);\r\nif (total)\r\nratio = avg / total * 100.0;\r\ncolor = get_ratio_color(GRC_CACHE_MISSES, ratio);\r\nfprintf(out, " # ");\r\ncolor_fprintf(out, color, "%6.2f%%", ratio);\r\nfprintf(out, " of all LL-cache hits ");\r\n}\r\nvoid perf_stat__print_shadow_stats(FILE *out, struct perf_evsel *evsel,\r\ndouble avg, int cpu, enum aggr_mode aggr)\r\n{\r\ndouble total, ratio = 0.0, total2;\r\nint ctx = evsel_context(evsel);\r\nif (perf_evsel__match(evsel, HARDWARE, HW_INSTRUCTIONS)) {\r\ntotal = avg_stats(&runtime_cycles_stats[ctx][cpu]);\r\nif (total) {\r\nratio = avg / total;\r\nfprintf(out, " # %5.2f insns per cycle ", ratio);\r\n} else {\r\nfprintf(out, " ");\r\n}\r\ntotal = avg_stats(&runtime_stalled_cycles_front_stats[ctx][cpu]);\r\ntotal = max(total, avg_stats(&runtime_stalled_cycles_back_stats[ctx][cpu]));\r\nif (total && avg) {\r\nratio = total / avg;\r\nfprintf(out, "\n");\r\nif (aggr == AGGR_NONE)\r\nfprintf(out, " ");\r\nfprintf(out, " # %5.2f stalled cycles per insn", ratio);\r\n}\r\n} else if (perf_evsel__match(evsel, HARDWARE, HW_BRANCH_MISSES) &&\r\nruntime_branches_stats[ctx][cpu].n != 0) {\r\nprint_branch_misses(out, cpu, evsel, avg);\r\n} else if (\r\nevsel->attr.type == PERF_TYPE_HW_CACHE &&\r\nevsel->attr.config == ( PERF_COUNT_HW_CACHE_L1D |\r\n((PERF_COUNT_HW_CACHE_OP_READ) << 8) |\r\n((PERF_COUNT_HW_CACHE_RESULT_MISS) << 16)) &&\r\nruntime_l1_dcache_stats[ctx][cpu].n != 0) {\r\nprint_l1_dcache_misses(out, cpu, evsel, avg);\r\n} else if (\r\nevsel->attr.type == PERF_TYPE_HW_CACHE &&\r\nevsel->attr.config == ( PERF_COUNT_HW_CACHE_L1I |\r\n((PERF_COUNT_HW_CACHE_OP_READ) << 8) |\r\n((PERF_COUNT_HW_CACHE_RESULT_MISS) << 16)) &&\r\nruntime_l1_icache_stats[ctx][cpu].n != 0) {\r\nprint_l1_icache_misses(out, cpu, evsel, avg);\r\n} else if (\r\nevsel->attr.type == PERF_TYPE_HW_CACHE &&\r\nevsel->attr.config == ( PERF_COUNT_HW_CACHE_DTLB |\r\n((PERF_COUNT_HW_CACHE_OP_READ) << 8) |\r\n((PERF_COUNT_HW_CACHE_RESULT_MISS) << 16)) &&\r\nruntime_dtlb_cache_stats[ctx][cpu].n != 0) {\r\nprint_dtlb_cache_misses(out, cpu, evsel, avg);\r\n} else if (\r\nevsel->attr.type == PERF_TYPE_HW_CACHE &&\r\nevsel->attr.config == ( PERF_COUNT_HW_CACHE_ITLB |\r\n((PERF_COUNT_HW_CACHE_OP_READ) << 8) |\r\n((PERF_COUNT_HW_CACHE_RESULT_MISS) << 16)) &&\r\nruntime_itlb_cache_stats[ctx][cpu].n != 0) {\r\nprint_itlb_cache_misses(out, cpu, evsel, avg);\r\n} else if (\r\nevsel->attr.type == PERF_TYPE_HW_CACHE &&\r\nevsel->attr.config == ( PERF_COUNT_HW_CACHE_LL |\r\n((PERF_COUNT_HW_CACHE_OP_READ) << 8) |\r\n((PERF_COUNT_HW_CACHE_RESULT_MISS) << 16)) &&\r\nruntime_ll_cache_stats[ctx][cpu].n != 0) {\r\nprint_ll_cache_misses(out, cpu, evsel, avg);\r\n} else if (perf_evsel__match(evsel, HARDWARE, HW_CACHE_MISSES) &&\r\nruntime_cacherefs_stats[ctx][cpu].n != 0) {\r\ntotal = avg_stats(&runtime_cacherefs_stats[ctx][cpu]);\r\nif (total)\r\nratio = avg * 100 / total;\r\nfprintf(out, " # %8.3f %% of all cache refs ", ratio);\r\n} else if (perf_evsel__match(evsel, HARDWARE, HW_STALLED_CYCLES_FRONTEND)) {\r\nprint_stalled_cycles_frontend(out, cpu, evsel, avg);\r\n} else if (perf_evsel__match(evsel, HARDWARE, HW_STALLED_CYCLES_BACKEND)) {\r\nprint_stalled_cycles_backend(out, cpu, evsel, avg);\r\n} else if (perf_evsel__match(evsel, HARDWARE, HW_CPU_CYCLES)) {\r\ntotal = avg_stats(&runtime_nsecs_stats[cpu]);\r\nif (total) {\r\nratio = avg / total;\r\nfprintf(out, " # %8.3f GHz ", ratio);\r\n} else {\r\nfprintf(out, " ");\r\n}\r\n} else if (perf_stat_evsel__is(evsel, CYCLES_IN_TX)) {\r\ntotal = avg_stats(&runtime_cycles_stats[ctx][cpu]);\r\nif (total)\r\nfprintf(out,\r\n" # %5.2f%% transactional cycles ",\r\n100.0 * (avg / total));\r\n} else if (perf_stat_evsel__is(evsel, CYCLES_IN_TX_CP)) {\r\ntotal = avg_stats(&runtime_cycles_stats[ctx][cpu]);\r\ntotal2 = avg_stats(&runtime_cycles_in_tx_stats[ctx][cpu]);\r\nif (total2 < avg)\r\ntotal2 = avg;\r\nif (total)\r\nfprintf(out,\r\n" # %5.2f%% aborted cycles ",\r\n100.0 * ((total2-avg) / total));\r\n} else if (perf_stat_evsel__is(evsel, TRANSACTION_START) &&\r\nruntime_cycles_in_tx_stats[ctx][cpu].n != 0) {\r\ntotal = avg_stats(&runtime_cycles_in_tx_stats[ctx][cpu]);\r\nif (avg)\r\nratio = total / avg;\r\nfprintf(out, " # %8.0f cycles / transaction ", ratio);\r\n} else if (perf_stat_evsel__is(evsel, ELISION_START) &&\r\nruntime_cycles_in_tx_stats[ctx][cpu].n != 0) {\r\ntotal = avg_stats(&runtime_cycles_in_tx_stats[ctx][cpu]);\r\nif (avg)\r\nratio = total / avg;\r\nfprintf(out, " # %8.0f cycles / elision ", ratio);\r\n} else if (perf_evsel__match(evsel, SOFTWARE, SW_TASK_CLOCK)) {\r\nif ((ratio = avg_stats(&walltime_nsecs_stats)) != 0)\r\nfprintf(out, " # %8.3f CPUs utilized ", avg / ratio);\r\nelse\r\nfprintf(out, " ");\r\n} else if (runtime_nsecs_stats[cpu].n != 0) {\r\nchar unit = 'M';\r\ntotal = avg_stats(&runtime_nsecs_stats[cpu]);\r\nif (total)\r\nratio = 1000.0 * avg / total;\r\nif (ratio < 0.001) {\r\nratio *= 1000;\r\nunit = 'K';\r\n}\r\nfprintf(out, " # %8.3f %c/sec ", ratio, unit);\r\n} else {\r\nfprintf(out, " ");\r\n}\r\n}

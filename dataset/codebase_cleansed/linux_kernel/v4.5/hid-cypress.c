static __u8 *cp_report_fixup(struct hid_device *hdev, __u8 *rdesc,\r\nunsigned int *rsize)\r\n{\r\nunsigned long quirks = (unsigned long)hid_get_drvdata(hdev);\r\nunsigned int i;\r\nif (!(quirks & CP_RDESC_SWAPPED_MIN_MAX))\r\nreturn rdesc;\r\nfor (i = 0; i < *rsize - 4; i++)\r\nif (rdesc[i] == 0x29 && rdesc[i + 2] == 0x19) {\r\nrdesc[i] = 0x19;\r\nrdesc[i + 2] = 0x29;\r\nswap(rdesc[i + 3], rdesc[i + 1]);\r\n}\r\nreturn rdesc;\r\n}\r\nstatic int cp_input_mapped(struct hid_device *hdev, struct hid_input *hi,\r\nstruct hid_field *field, struct hid_usage *usage,\r\nunsigned long **bit, int *max)\r\n{\r\nunsigned long quirks = (unsigned long)hid_get_drvdata(hdev);\r\nif (!(quirks & CP_2WHEEL_MOUSE_HACK))\r\nreturn 0;\r\nif (usage->type == EV_REL && usage->code == REL_WHEEL)\r\nset_bit(REL_HWHEEL, *bit);\r\nif (usage->hid == 0x00090005)\r\nreturn -1;\r\nreturn 0;\r\n}\r\nstatic int cp_event(struct hid_device *hdev, struct hid_field *field,\r\nstruct hid_usage *usage, __s32 value)\r\n{\r\nunsigned long quirks = (unsigned long)hid_get_drvdata(hdev);\r\nif (!(hdev->claimed & HID_CLAIMED_INPUT) || !field->hidinput ||\r\n!usage->type || !(quirks & CP_2WHEEL_MOUSE_HACK))\r\nreturn 0;\r\nif (usage->hid == 0x00090005) {\r\nif (value)\r\nquirks |= CP_2WHEEL_MOUSE_HACK_ON;\r\nelse\r\nquirks &= ~CP_2WHEEL_MOUSE_HACK_ON;\r\nhid_set_drvdata(hdev, (void *)quirks);\r\nreturn 1;\r\n}\r\nif (usage->code == REL_WHEEL && (quirks & CP_2WHEEL_MOUSE_HACK_ON)) {\r\nstruct input_dev *input = field->hidinput->input;\r\ninput_event(input, usage->type, REL_HWHEEL, value);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int cp_probe(struct hid_device *hdev, const struct hid_device_id *id)\r\n{\r\nunsigned long quirks = id->driver_data;\r\nint ret;\r\nhid_set_drvdata(hdev, (void *)quirks);\r\nret = hid_parse(hdev);\r\nif (ret) {\r\nhid_err(hdev, "parse failed\n");\r\ngoto err_free;\r\n}\r\nret = hid_hw_start(hdev, HID_CONNECT_DEFAULT);\r\nif (ret) {\r\nhid_err(hdev, "hw start failed\n");\r\ngoto err_free;\r\n}\r\nreturn 0;\r\nerr_free:\r\nreturn ret;\r\n}

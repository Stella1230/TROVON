static long hwdep_read(struct snd_hwdep *hwdep, char __user *buf,\r\nlong count, loff_t *offset)\r\n{\r\nstruct snd_dice *dice = hwdep->private_data;\r\nDEFINE_WAIT(wait);\r\nunion snd_firewire_event event;\r\nspin_lock_irq(&dice->lock);\r\nwhile (!dice->dev_lock_changed && dice->notification_bits == 0) {\r\nprepare_to_wait(&dice->hwdep_wait, &wait, TASK_INTERRUPTIBLE);\r\nspin_unlock_irq(&dice->lock);\r\nschedule();\r\nfinish_wait(&dice->hwdep_wait, &wait);\r\nif (signal_pending(current))\r\nreturn -ERESTARTSYS;\r\nspin_lock_irq(&dice->lock);\r\n}\r\nmemset(&event, 0, sizeof(event));\r\nif (dice->dev_lock_changed) {\r\nevent.lock_status.type = SNDRV_FIREWIRE_EVENT_LOCK_STATUS;\r\nevent.lock_status.status = dice->dev_lock_count > 0;\r\ndice->dev_lock_changed = false;\r\ncount = min_t(long, count, sizeof(event.lock_status));\r\n} else {\r\nevent.dice_notification.type =\r\nSNDRV_FIREWIRE_EVENT_DICE_NOTIFICATION;\r\nevent.dice_notification.notification = dice->notification_bits;\r\ndice->notification_bits = 0;\r\ncount = min_t(long, count, sizeof(event.dice_notification));\r\n}\r\nspin_unlock_irq(&dice->lock);\r\nif (copy_to_user(buf, &event, count))\r\nreturn -EFAULT;\r\nreturn count;\r\n}\r\nstatic unsigned int hwdep_poll(struct snd_hwdep *hwdep, struct file *file,\r\npoll_table *wait)\r\n{\r\nstruct snd_dice *dice = hwdep->private_data;\r\nunsigned int events;\r\npoll_wait(file, &dice->hwdep_wait, wait);\r\nspin_lock_irq(&dice->lock);\r\nif (dice->dev_lock_changed || dice->notification_bits != 0)\r\nevents = POLLIN | POLLRDNORM;\r\nelse\r\nevents = 0;\r\nspin_unlock_irq(&dice->lock);\r\nreturn events;\r\n}\r\nstatic int hwdep_get_info(struct snd_dice *dice, void __user *arg)\r\n{\r\nstruct fw_device *dev = fw_parent_device(dice->unit);\r\nstruct snd_firewire_get_info info;\r\nmemset(&info, 0, sizeof(info));\r\ninfo.type = SNDRV_FIREWIRE_TYPE_DICE;\r\ninfo.card = dev->card->index;\r\n*(__be32 *)&info.guid[0] = cpu_to_be32(dev->config_rom[3]);\r\n*(__be32 *)&info.guid[4] = cpu_to_be32(dev->config_rom[4]);\r\nstrlcpy(info.device_name, dev_name(&dev->device),\r\nsizeof(info.device_name));\r\nif (copy_to_user(arg, &info, sizeof(info)))\r\nreturn -EFAULT;\r\nreturn 0;\r\n}\r\nstatic int hwdep_lock(struct snd_dice *dice)\r\n{\r\nint err;\r\nspin_lock_irq(&dice->lock);\r\nif (dice->dev_lock_count == 0) {\r\ndice->dev_lock_count = -1;\r\nerr = 0;\r\n} else {\r\nerr = -EBUSY;\r\n}\r\nspin_unlock_irq(&dice->lock);\r\nreturn err;\r\n}\r\nstatic int hwdep_unlock(struct snd_dice *dice)\r\n{\r\nint err;\r\nspin_lock_irq(&dice->lock);\r\nif (dice->dev_lock_count == -1) {\r\ndice->dev_lock_count = 0;\r\nerr = 0;\r\n} else {\r\nerr = -EBADFD;\r\n}\r\nspin_unlock_irq(&dice->lock);\r\nreturn err;\r\n}\r\nstatic int hwdep_release(struct snd_hwdep *hwdep, struct file *file)\r\n{\r\nstruct snd_dice *dice = hwdep->private_data;\r\nspin_lock_irq(&dice->lock);\r\nif (dice->dev_lock_count == -1)\r\ndice->dev_lock_count = 0;\r\nspin_unlock_irq(&dice->lock);\r\nreturn 0;\r\n}\r\nstatic int hwdep_ioctl(struct snd_hwdep *hwdep, struct file *file,\r\nunsigned int cmd, unsigned long arg)\r\n{\r\nstruct snd_dice *dice = hwdep->private_data;\r\nswitch (cmd) {\r\ncase SNDRV_FIREWIRE_IOCTL_GET_INFO:\r\nreturn hwdep_get_info(dice, (void __user *)arg);\r\ncase SNDRV_FIREWIRE_IOCTL_LOCK:\r\nreturn hwdep_lock(dice);\r\ncase SNDRV_FIREWIRE_IOCTL_UNLOCK:\r\nreturn hwdep_unlock(dice);\r\ndefault:\r\nreturn -ENOIOCTLCMD;\r\n}\r\n}\r\nstatic int hwdep_compat_ioctl(struct snd_hwdep *hwdep, struct file *file,\r\nunsigned int cmd, unsigned long arg)\r\n{\r\nreturn hwdep_ioctl(hwdep, file, cmd,\r\n(unsigned long)compat_ptr(arg));\r\n}\r\nint snd_dice_create_hwdep(struct snd_dice *dice)\r\n{\r\nstatic const struct snd_hwdep_ops ops = {\r\n.read = hwdep_read,\r\n.release = hwdep_release,\r\n.poll = hwdep_poll,\r\n.ioctl = hwdep_ioctl,\r\n.ioctl_compat = hwdep_compat_ioctl,\r\n};\r\nstruct snd_hwdep *hwdep;\r\nint err;\r\nerr = snd_hwdep_new(dice->card, "DICE", 0, &hwdep);\r\nif (err < 0)\r\nreturn err;\r\nstrcpy(hwdep->name, "DICE");\r\nhwdep->iface = SNDRV_HWDEP_IFACE_FW_DICE;\r\nhwdep->ops = ops;\r\nhwdep->private_data = dice;\r\nhwdep->exclusive = true;\r\nreturn 0;\r\n}

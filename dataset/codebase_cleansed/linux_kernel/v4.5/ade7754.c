static int ade7754_spi_write_reg_8(struct device *dev,\r\nu8 reg_address,\r\nu8 val)\r\n{\r\nint ret;\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7754_state *st = iio_priv(indio_dev);\r\nmutex_lock(&st->buf_lock);\r\nst->tx[0] = ADE7754_WRITE_REG(reg_address);\r\nst->tx[1] = val;\r\nret = spi_write(st->us, st->tx, 2);\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic int ade7754_spi_write_reg_16(struct device *dev,\r\nu8 reg_address,\r\nu16 value)\r\n{\r\nint ret;\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7754_state *st = iio_priv(indio_dev);\r\nmutex_lock(&st->buf_lock);\r\nst->tx[0] = ADE7754_WRITE_REG(reg_address);\r\nst->tx[1] = (value >> 8) & 0xFF;\r\nst->tx[2] = value & 0xFF;\r\nret = spi_write(st->us, st->tx, 3);\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic int ade7754_spi_read_reg_8(struct device *dev,\r\nu8 reg_address,\r\nu8 *val)\r\n{\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7754_state *st = iio_priv(indio_dev);\r\nint ret;\r\nret = spi_w8r8(st->us, ADE7754_READ_REG(reg_address));\r\nif (ret < 0) {\r\ndev_err(&st->us->dev, "problem when reading 8 bit register 0x%02X",\r\nreg_address);\r\nreturn ret;\r\n}\r\n*val = ret;\r\nreturn 0;\r\n}\r\nstatic int ade7754_spi_read_reg_16(struct device *dev,\r\nu8 reg_address,\r\nu16 *val)\r\n{\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7754_state *st = iio_priv(indio_dev);\r\nint ret;\r\nret = spi_w8r16be(st->us, ADE7754_READ_REG(reg_address));\r\nif (ret < 0) {\r\ndev_err(&st->us->dev, "problem when reading 16 bit register 0x%02X",\r\nreg_address);\r\nreturn ret;\r\n}\r\n*val = ret;\r\nreturn 0;\r\n}\r\nstatic int ade7754_spi_read_reg_24(struct device *dev,\r\nu8 reg_address,\r\nu32 *val)\r\n{\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7754_state *st = iio_priv(indio_dev);\r\nint ret;\r\nstruct spi_transfer xfers[] = {\r\n{\r\n.tx_buf = st->tx,\r\n.rx_buf = st->rx,\r\n.bits_per_word = 8,\r\n.len = 4,\r\n},\r\n};\r\nmutex_lock(&st->buf_lock);\r\nst->tx[0] = ADE7754_READ_REG(reg_address);\r\nst->tx[1] = 0;\r\nst->tx[2] = 0;\r\nst->tx[3] = 0;\r\nret = spi_sync_transfer(st->us, xfers, ARRAY_SIZE(xfers));\r\nif (ret) {\r\ndev_err(&st->us->dev, "problem when reading 24 bit register 0x%02X",\r\nreg_address);\r\ngoto error_ret;\r\n}\r\n*val = (st->rx[1] << 16) | (st->rx[2] << 8) | st->rx[3];\r\nerror_ret:\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic ssize_t ade7754_read_8bit(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nint ret;\r\nu8 val = 0;\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nret = ade7754_spi_read_reg_8(dev, this_attr->address, &val);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, "%u\n", val);\r\n}\r\nstatic ssize_t ade7754_read_16bit(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nint ret;\r\nu16 val = 0;\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nret = ade7754_spi_read_reg_16(dev, this_attr->address, &val);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, "%u\n", val);\r\n}\r\nstatic ssize_t ade7754_read_24bit(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nint ret;\r\nu32 val = 0;\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nret = ade7754_spi_read_reg_24(dev, this_attr->address, &val);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, "%u\n", val & 0xFFFFFF);\r\n}\r\nstatic ssize_t ade7754_write_8bit(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nint ret;\r\nu8 val;\r\nret = kstrtou8(buf, 10, &val);\r\nif (ret)\r\ngoto error_ret;\r\nret = ade7754_spi_write_reg_8(dev, this_attr->address, val);\r\nerror_ret:\r\nreturn ret ? ret : len;\r\n}\r\nstatic ssize_t ade7754_write_16bit(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nint ret;\r\nu16 val;\r\nret = kstrtou16(buf, 10, &val);\r\nif (ret)\r\ngoto error_ret;\r\nret = ade7754_spi_write_reg_16(dev, this_attr->address, val);\r\nerror_ret:\r\nreturn ret ? ret : len;\r\n}\r\nstatic int ade7754_reset(struct device *dev)\r\n{\r\nint ret;\r\nu8 val;\r\nret = ade7754_spi_read_reg_8(dev, ADE7754_OPMODE, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nval |= BIT(6);\r\nreturn ade7754_spi_write_reg_8(dev, ADE7754_OPMODE, val);\r\n}\r\nstatic int ade7754_set_irq(struct device *dev, bool enable)\r\n{\r\nint ret;\r\nu16 irqen;\r\nret = ade7754_spi_read_reg_16(dev, ADE7754_IRQEN, &irqen);\r\nif (ret)\r\ngoto error_ret;\r\nif (enable)\r\nirqen |= BIT(14);\r\nelse\r\nirqen &= ~BIT(14);\r\nret = ade7754_spi_write_reg_16(dev, ADE7754_IRQEN, irqen);\r\nif (ret)\r\ngoto error_ret;\r\nerror_ret:\r\nreturn ret;\r\n}\r\nstatic int ade7754_stop_device(struct device *dev)\r\n{\r\nint ret;\r\nu8 val;\r\nret = ade7754_spi_read_reg_8(dev, ADE7754_OPMODE, &val);\r\nif (ret < 0) {\r\ndev_err(dev, "unable to power down the device, error: %d",\r\nret);\r\nreturn ret;\r\n}\r\nval |= 7 << 3;\r\nreturn ade7754_spi_write_reg_8(dev, ADE7754_OPMODE, val);\r\n}\r\nstatic int ade7754_initial_setup(struct iio_dev *indio_dev)\r\n{\r\nint ret;\r\nstruct ade7754_state *st = iio_priv(indio_dev);\r\nstruct device *dev = &indio_dev->dev;\r\nst->us->mode = SPI_MODE_3;\r\nspi_setup(st->us);\r\nret = ade7754_set_irq(dev, false);\r\nif (ret) {\r\ndev_err(dev, "disable irq failed");\r\ngoto err_ret;\r\n}\r\nade7754_reset(dev);\r\nmsleep(ADE7754_STARTUP_DELAY);\r\nerr_ret:\r\nreturn ret;\r\n}\r\nstatic ssize_t ade7754_read_frequency(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nint ret;\r\nu8 t;\r\nint sps;\r\nret = ade7754_spi_read_reg_8(dev,\r\nADE7754_WAVMODE,\r\n&t);\r\nif (ret)\r\nreturn ret;\r\nt = (t >> 3) & 0x3;\r\nsps = 26000 / (1 + t);\r\nreturn sprintf(buf, "%d\n", sps);\r\n}\r\nstatic ssize_t ade7754_write_frequency(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7754_state *st = iio_priv(indio_dev);\r\nu16 val;\r\nint ret;\r\nu8 reg, t;\r\nret = kstrtou16(buf, 10, &val);\r\nif (ret)\r\nreturn ret;\r\nif (!val)\r\nreturn -EINVAL;\r\nmutex_lock(&indio_dev->mlock);\r\nt = 26000 / val;\r\nif (t > 0)\r\nt--;\r\nif (t > 1)\r\nst->us->max_speed_hz = ADE7754_SPI_SLOW;\r\nelse\r\nst->us->max_speed_hz = ADE7754_SPI_FAST;\r\nret = ade7754_spi_read_reg_8(dev, ADE7754_WAVMODE, &reg);\r\nif (ret)\r\ngoto out;\r\nreg &= ~(3 << 3);\r\nreg |= t << 3;\r\nret = ade7754_spi_write_reg_8(dev, ADE7754_WAVMODE, reg);\r\nout:\r\nmutex_unlock(&indio_dev->mlock);\r\nreturn ret ? ret : len;\r\n}\r\nstatic int ade7754_probe(struct spi_device *spi)\r\n{\r\nint ret;\r\nstruct ade7754_state *st;\r\nstruct iio_dev *indio_dev;\r\nindio_dev = devm_iio_device_alloc(&spi->dev, sizeof(*st));\r\nif (!indio_dev)\r\nreturn -ENOMEM;\r\nspi_set_drvdata(spi, indio_dev);\r\nst = iio_priv(indio_dev);\r\nst->us = spi;\r\nmutex_init(&st->buf_lock);\r\nindio_dev->name = spi->dev.driver->name;\r\nindio_dev->dev.parent = &spi->dev;\r\nindio_dev->info = &ade7754_info;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nret = ade7754_initial_setup(indio_dev);\r\nif (ret)\r\ngoto powerdown_on_error;\r\nret = iio_device_register(indio_dev);\r\nif (ret)\r\ngoto powerdown_on_error;\r\nreturn ret;\r\npowerdown_on_error:\r\nade7754_stop_device(&indio_dev->dev);\r\nreturn ret;\r\n}\r\nstatic int ade7754_remove(struct spi_device *spi)\r\n{\r\nstruct iio_dev *indio_dev = spi_get_drvdata(spi);\r\niio_device_unregister(indio_dev);\r\nade7754_stop_device(&indio_dev->dev);\r\nreturn 0;\r\n}

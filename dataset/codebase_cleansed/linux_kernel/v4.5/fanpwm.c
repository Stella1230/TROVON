static int\r\nnvkm_fanpwm_get(struct nvkm_therm *therm)\r\n{\r\nstruct nvkm_fanpwm *fan = (void *)therm->fan;\r\nstruct nvkm_device *device = therm->subdev.device;\r\nstruct nvkm_gpio *gpio = device->gpio;\r\nint card_type = device->card_type;\r\nu32 divs, duty;\r\nint ret;\r\nret = therm->func->pwm_get(therm, fan->func.line, &divs, &duty);\r\nif (ret == 0 && divs) {\r\ndivs = max(divs, duty);\r\nif (card_type <= NV_40 || (fan->func.log[0] & 1))\r\nduty = divs - duty;\r\nreturn (duty * 100) / divs;\r\n}\r\nreturn nvkm_gpio_get(gpio, 0, fan->func.func, fan->func.line) * 100;\r\n}\r\nstatic int\r\nnvkm_fanpwm_set(struct nvkm_therm *therm, int percent)\r\n{\r\nstruct nvkm_fanpwm *fan = (void *)therm->fan;\r\nint card_type = therm->subdev.device->card_type;\r\nu32 divs, duty;\r\nint ret;\r\ndivs = fan->base.perf.pwm_divisor;\r\nif (fan->base.bios.pwm_freq) {\r\ndivs = 1;\r\nif (therm->func->pwm_clock)\r\ndivs = therm->func->pwm_clock(therm, fan->func.line);\r\ndivs /= fan->base.bios.pwm_freq;\r\n}\r\nduty = ((divs * percent) + 99) / 100;\r\nif (card_type <= NV_40 || (fan->func.log[0] & 1))\r\nduty = divs - duty;\r\nret = therm->func->pwm_set(therm, fan->func.line, divs, duty);\r\nif (ret == 0)\r\nret = therm->func->pwm_ctrl(therm, fan->func.line, true);\r\nreturn ret;\r\n}\r\nint\r\nnvkm_fanpwm_create(struct nvkm_therm *therm, struct dcb_gpio_func *func)\r\n{\r\nstruct nvkm_device *device = therm->subdev.device;\r\nstruct nvkm_bios *bios = device->bios;\r\nstruct nvkm_fanpwm *fan;\r\nstruct nvbios_therm_fan info = {};\r\nu32 divs, duty;\r\nnvbios_fan_parse(bios, &info);\r\nif (!nvkm_boolopt(device->cfgopt, "NvFanPWM", func->param) ||\r\n!therm->func->pwm_ctrl || info.type == NVBIOS_THERM_FAN_TOGGLE ||\r\ntherm->func->pwm_get(therm, func->line, &divs, &duty) == -ENODEV)\r\nreturn -ENODEV;\r\nfan = kzalloc(sizeof(*fan), GFP_KERNEL);\r\ntherm->fan = &fan->base;\r\nif (!fan)\r\nreturn -ENOMEM;\r\nfan->base.type = "PWM";\r\nfan->base.get = nvkm_fanpwm_get;\r\nfan->base.set = nvkm_fanpwm_set;\r\nfan->func = *func;\r\nreturn 0;\r\n}

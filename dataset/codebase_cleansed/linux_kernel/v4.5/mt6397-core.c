static void mt6397_irq_lock(struct irq_data *data)\r\n{\r\nstruct mt6397_chip *mt6397 = irq_data_get_irq_chip_data(data);\r\nmutex_lock(&mt6397->irqlock);\r\n}\r\nstatic void mt6397_irq_sync_unlock(struct irq_data *data)\r\n{\r\nstruct mt6397_chip *mt6397 = irq_data_get_irq_chip_data(data);\r\nregmap_write(mt6397->regmap, MT6397_INT_CON0, mt6397->irq_masks_cur[0]);\r\nregmap_write(mt6397->regmap, MT6397_INT_CON1, mt6397->irq_masks_cur[1]);\r\nmutex_unlock(&mt6397->irqlock);\r\n}\r\nstatic void mt6397_irq_disable(struct irq_data *data)\r\n{\r\nstruct mt6397_chip *mt6397 = irq_data_get_irq_chip_data(data);\r\nint shift = data->hwirq & 0xf;\r\nint reg = data->hwirq >> 4;\r\nmt6397->irq_masks_cur[reg] &= ~BIT(shift);\r\n}\r\nstatic void mt6397_irq_enable(struct irq_data *data)\r\n{\r\nstruct mt6397_chip *mt6397 = irq_data_get_irq_chip_data(data);\r\nint shift = data->hwirq & 0xf;\r\nint reg = data->hwirq >> 4;\r\nmt6397->irq_masks_cur[reg] |= BIT(shift);\r\n}\r\nstatic int mt6397_irq_set_wake(struct irq_data *irq_data, unsigned int on)\r\n{\r\nstruct mt6397_chip *mt6397 = irq_data_get_irq_chip_data(irq_data);\r\nint shift = irq_data->hwirq & 0xf;\r\nint reg = irq_data->hwirq >> 4;\r\nif (on)\r\nmt6397->wake_mask[reg] |= BIT(shift);\r\nelse\r\nmt6397->wake_mask[reg] &= ~BIT(shift);\r\nreturn 0;\r\n}\r\nstatic void mt6397_irq_handle_reg(struct mt6397_chip *mt6397, int reg,\r\nint irqbase)\r\n{\r\nunsigned int status;\r\nint i, irq, ret;\r\nret = regmap_read(mt6397->regmap, reg, &status);\r\nif (ret) {\r\ndev_err(mt6397->dev, "Failed to read irq status: %d\n", ret);\r\nreturn;\r\n}\r\nfor (i = 0; i < 16; i++) {\r\nif (status & BIT(i)) {\r\nirq = irq_find_mapping(mt6397->irq_domain, irqbase + i);\r\nif (irq)\r\nhandle_nested_irq(irq);\r\n}\r\n}\r\nregmap_write(mt6397->regmap, reg, status);\r\n}\r\nstatic irqreturn_t mt6397_irq_thread(int irq, void *data)\r\n{\r\nstruct mt6397_chip *mt6397 = data;\r\nmt6397_irq_handle_reg(mt6397, MT6397_INT_STATUS0, 0);\r\nmt6397_irq_handle_reg(mt6397, MT6397_INT_STATUS1, 16);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int mt6397_irq_domain_map(struct irq_domain *d, unsigned int irq,\r\nirq_hw_number_t hw)\r\n{\r\nstruct mt6397_chip *mt6397 = d->host_data;\r\nirq_set_chip_data(irq, mt6397);\r\nirq_set_chip_and_handler(irq, &mt6397_irq_chip, handle_level_irq);\r\nirq_set_nested_thread(irq, 1);\r\nirq_set_noprobe(irq);\r\nreturn 0;\r\n}\r\nstatic int mt6397_irq_init(struct mt6397_chip *mt6397)\r\n{\r\nint ret;\r\nmutex_init(&mt6397->irqlock);\r\nregmap_write(mt6397->regmap, MT6397_INT_CON0, 0x0);\r\nregmap_write(mt6397->regmap, MT6397_INT_CON1, 0x0);\r\nmt6397->irq_domain = irq_domain_add_linear(mt6397->dev->of_node,\r\nMT6397_IRQ_NR, &mt6397_irq_domain_ops, mt6397);\r\nif (!mt6397->irq_domain) {\r\ndev_err(mt6397->dev, "could not create irq domain\n");\r\nreturn -ENOMEM;\r\n}\r\nret = devm_request_threaded_irq(mt6397->dev, mt6397->irq, NULL,\r\nmt6397_irq_thread, IRQF_ONESHOT, "mt6397-pmic", mt6397);\r\nif (ret) {\r\ndev_err(mt6397->dev, "failed to register irq=%d; err: %d\n",\r\nmt6397->irq, ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mt6397_irq_suspend(struct device *dev)\r\n{\r\nstruct mt6397_chip *chip = dev_get_drvdata(dev);\r\nregmap_write(chip->regmap, MT6397_INT_CON0, chip->wake_mask[0]);\r\nregmap_write(chip->regmap, MT6397_INT_CON1, chip->wake_mask[1]);\r\nenable_irq_wake(chip->irq);\r\nreturn 0;\r\n}\r\nstatic int mt6397_irq_resume(struct device *dev)\r\n{\r\nstruct mt6397_chip *chip = dev_get_drvdata(dev);\r\nregmap_write(chip->regmap, MT6397_INT_CON0, chip->irq_masks_cur[0]);\r\nregmap_write(chip->regmap, MT6397_INT_CON1, chip->irq_masks_cur[1]);\r\ndisable_irq_wake(chip->irq);\r\nreturn 0;\r\n}\r\nstatic int mt6397_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct mt6397_chip *mt6397;\r\nmt6397 = devm_kzalloc(&pdev->dev, sizeof(*mt6397), GFP_KERNEL);\r\nif (!mt6397)\r\nreturn -ENOMEM;\r\nmt6397->dev = &pdev->dev;\r\nmt6397->regmap = dev_get_regmap(pdev->dev.parent, NULL);\r\nif (!mt6397->regmap)\r\nreturn -ENODEV;\r\nplatform_set_drvdata(pdev, mt6397);\r\nmt6397->irq = platform_get_irq(pdev, 0);\r\nif (mt6397->irq > 0) {\r\nret = mt6397_irq_init(mt6397);\r\nif (ret)\r\nreturn ret;\r\n}\r\nret = mfd_add_devices(&pdev->dev, -1, mt6397_devs,\r\nARRAY_SIZE(mt6397_devs), NULL, 0, NULL);\r\nif (ret)\r\ndev_err(&pdev->dev, "failed to add child devices: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int mt6397_remove(struct platform_device *pdev)\r\n{\r\nmfd_remove_devices(&pdev->dev);\r\nreturn 0;\r\n}

static int as3711_set_mode_sd(struct regulator_dev *rdev, unsigned int mode)\r\n{\r\nunsigned int fast_bit = rdev->desc->enable_mask,\r\nlow_noise_bit = fast_bit << 4;\r\nu8 val;\r\nswitch (mode) {\r\ncase REGULATOR_MODE_FAST:\r\nval = fast_bit | low_noise_bit;\r\nbreak;\r\ncase REGULATOR_MODE_NORMAL:\r\nval = low_noise_bit;\r\nbreak;\r\ncase REGULATOR_MODE_IDLE:\r\nval = 0;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn regmap_update_bits(rdev->regmap, AS3711_SD_CONTROL_1,\r\nlow_noise_bit | fast_bit, val);\r\n}\r\nstatic unsigned int as3711_get_mode_sd(struct regulator_dev *rdev)\r\n{\r\nunsigned int fast_bit = rdev->desc->enable_mask,\r\nlow_noise_bit = fast_bit << 4, mask = fast_bit | low_noise_bit;\r\nunsigned int val;\r\nint ret = regmap_read(rdev->regmap, AS3711_SD_CONTROL_1, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nif ((val & mask) == mask)\r\nreturn REGULATOR_MODE_FAST;\r\nif ((val & mask) == low_noise_bit)\r\nreturn REGULATOR_MODE_NORMAL;\r\nif (!(val & mask))\r\nreturn REGULATOR_MODE_IDLE;\r\nreturn -EINVAL;\r\n}\r\nstatic int as3711_regulator_parse_dt(struct device *dev,\r\nstruct device_node **of_node, const int count)\r\n{\r\nstruct as3711_regulator_pdata *pdata = dev_get_platdata(dev);\r\nstruct device_node *regulators =\r\nof_get_child_by_name(dev->parent->of_node, "regulators");\r\nstruct of_regulator_match *match;\r\nint ret, i;\r\nif (!regulators) {\r\ndev_err(dev, "regulator node not found\n");\r\nreturn -ENODEV;\r\n}\r\nret = of_regulator_match(dev->parent, regulators,\r\nas3711_regulator_matches, count);\r\nof_node_put(regulators);\r\nif (ret < 0) {\r\ndev_err(dev, "Error parsing regulator init data: %d\n", ret);\r\nreturn ret;\r\n}\r\nfor (i = 0, match = as3711_regulator_matches; i < count; i++, match++)\r\nif (match->of_node) {\r\npdata->init_data[i] = match->init_data;\r\nof_node[i] = match->of_node;\r\n}\r\nreturn 0;\r\n}\r\nstatic int as3711_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct as3711_regulator_pdata *pdata = dev_get_platdata(&pdev->dev);\r\nstruct as3711 *as3711 = dev_get_drvdata(pdev->dev.parent);\r\nstruct regulator_config config = {.dev = &pdev->dev,};\r\nstruct as3711_regulator *reg = NULL;\r\nstruct as3711_regulator *regs;\r\nstruct device_node *of_node[AS3711_REGULATOR_NUM] = {};\r\nstruct regulator_dev *rdev;\r\nstruct as3711_regulator_info *ri;\r\nint ret;\r\nint id;\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "No platform data...\n");\r\nreturn -ENODEV;\r\n}\r\nif (pdev->dev.parent->of_node) {\r\nret = as3711_regulator_parse_dt(&pdev->dev, of_node, AS3711_REGULATOR_NUM);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "DT parsing failed: %d\n", ret);\r\nreturn ret;\r\n}\r\n}\r\nregs = devm_kzalloc(&pdev->dev, AS3711_REGULATOR_NUM *\r\nsizeof(struct as3711_regulator), GFP_KERNEL);\r\nif (!regs)\r\nreturn -ENOMEM;\r\nfor (id = 0, ri = as3711_reg_info; id < AS3711_REGULATOR_NUM; ++id, ri++) {\r\nreg = &regs[id];\r\nreg->reg_info = ri;\r\nconfig.init_data = pdata->init_data[id];\r\nconfig.driver_data = reg;\r\nconfig.regmap = as3711->regmap;\r\nconfig.of_node = of_node[id];\r\nrdev = devm_regulator_register(&pdev->dev, &ri->desc, &config);\r\nif (IS_ERR(rdev)) {\r\ndev_err(&pdev->dev, "Failed to register regulator %s\n",\r\nri->desc.name);\r\nreturn PTR_ERR(rdev);\r\n}\r\n}\r\nplatform_set_drvdata(pdev, regs);\r\nreturn 0;\r\n}\r\nstatic int __init as3711_regulator_init(void)\r\n{\r\nreturn platform_driver_register(&as3711_regulator_driver);\r\n}\r\nstatic void __exit as3711_regulator_exit(void)\r\n{\r\nplatform_driver_unregister(&as3711_regulator_driver);\r\n}

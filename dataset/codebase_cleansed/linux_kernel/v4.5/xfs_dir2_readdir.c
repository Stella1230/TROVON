static unsigned char\r\nxfs_dir3_get_dtype(\r\nstruct xfs_mount *mp,\r\n__uint8_t filetype)\r\n{\r\nif (!xfs_sb_version_hasftype(&mp->m_sb))\r\nreturn DT_UNKNOWN;\r\nif (filetype >= XFS_DIR3_FT_MAX)\r\nreturn DT_UNKNOWN;\r\nreturn xfs_dir3_filetype_table[filetype];\r\n}\r\nSTATIC int\r\nxfs_dir2_sf_getdents(\r\nstruct xfs_da_args *args,\r\nstruct dir_context *ctx)\r\n{\r\nint i;\r\nstruct xfs_inode *dp = args->dp;\r\nxfs_dir2_dataptr_t off;\r\nxfs_dir2_sf_entry_t *sfep;\r\nxfs_dir2_sf_hdr_t *sfp;\r\nxfs_dir2_dataptr_t dot_offset;\r\nxfs_dir2_dataptr_t dotdot_offset;\r\nxfs_ino_t ino;\r\nstruct xfs_da_geometry *geo = args->geo;\r\nASSERT(dp->i_df.if_flags & XFS_IFINLINE);\r\nif (dp->i_d.di_size < offsetof(xfs_dir2_sf_hdr_t, parent)) {\r\nASSERT(XFS_FORCED_SHUTDOWN(dp->i_mount));\r\nreturn -EIO;\r\n}\r\nASSERT(dp->i_df.if_bytes == dp->i_d.di_size);\r\nASSERT(dp->i_df.if_u1.if_data != NULL);\r\nsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\r\nASSERT(dp->i_d.di_size >= xfs_dir2_sf_hdr_size(sfp->i8count));\r\nif (xfs_dir2_dataptr_to_db(geo, ctx->pos) > geo->datablk)\r\nreturn 0;\r\ndot_offset = xfs_dir2_db_off_to_dataptr(geo, geo->datablk,\r\ndp->d_ops->data_dot_offset);\r\ndotdot_offset = xfs_dir2_db_off_to_dataptr(geo, geo->datablk,\r\ndp->d_ops->data_dotdot_offset);\r\nif (ctx->pos <= dot_offset) {\r\nctx->pos = dot_offset & 0x7fffffff;\r\nif (!dir_emit(ctx, ".", 1, dp->i_ino, DT_DIR))\r\nreturn 0;\r\n}\r\nif (ctx->pos <= dotdot_offset) {\r\nino = dp->d_ops->sf_get_parent_ino(sfp);\r\nctx->pos = dotdot_offset & 0x7fffffff;\r\nif (!dir_emit(ctx, "..", 2, ino, DT_DIR))\r\nreturn 0;\r\n}\r\nsfep = xfs_dir2_sf_firstentry(sfp);\r\nfor (i = 0; i < sfp->count; i++) {\r\n__uint8_t filetype;\r\noff = xfs_dir2_db_off_to_dataptr(geo, geo->datablk,\r\nxfs_dir2_sf_get_offset(sfep));\r\nif (ctx->pos > off) {\r\nsfep = dp->d_ops->sf_nextentry(sfp, sfep);\r\ncontinue;\r\n}\r\nino = dp->d_ops->sf_get_ino(sfp, sfep);\r\nfiletype = dp->d_ops->sf_get_ftype(sfep);\r\nctx->pos = off & 0x7fffffff;\r\nif (!dir_emit(ctx, (char *)sfep->name, sfep->namelen, ino,\r\nxfs_dir3_get_dtype(dp->i_mount, filetype)))\r\nreturn 0;\r\nsfep = dp->d_ops->sf_nextentry(sfp, sfep);\r\n}\r\nctx->pos = xfs_dir2_db_off_to_dataptr(geo, geo->datablk + 1, 0) &\r\n0x7fffffff;\r\nreturn 0;\r\n}\r\nSTATIC int\r\nxfs_dir2_block_getdents(\r\nstruct xfs_da_args *args,\r\nstruct dir_context *ctx)\r\n{\r\nstruct xfs_inode *dp = args->dp;\r\nxfs_dir2_data_hdr_t *hdr;\r\nstruct xfs_buf *bp;\r\nxfs_dir2_block_tail_t *btp;\r\nxfs_dir2_data_entry_t *dep;\r\nxfs_dir2_data_unused_t *dup;\r\nchar *endptr;\r\nint error;\r\nchar *ptr;\r\nint wantoff;\r\nxfs_off_t cook;\r\nstruct xfs_da_geometry *geo = args->geo;\r\nint lock_mode;\r\nif (xfs_dir2_dataptr_to_db(geo, ctx->pos) > geo->datablk)\r\nreturn 0;\r\nlock_mode = xfs_ilock_data_map_shared(dp);\r\nerror = xfs_dir3_block_read(NULL, dp, &bp);\r\nxfs_iunlock(dp, lock_mode);\r\nif (error)\r\nreturn error;\r\nwantoff = xfs_dir2_dataptr_to_off(geo, ctx->pos);\r\nhdr = bp->b_addr;\r\nxfs_dir3_data_check(dp, bp);\r\nbtp = xfs_dir2_block_tail_p(geo, hdr);\r\nptr = (char *)dp->d_ops->data_entry_p(hdr);\r\nendptr = (char *)xfs_dir2_block_leaf_p(btp);\r\nwhile (ptr < endptr) {\r\n__uint8_t filetype;\r\ndup = (xfs_dir2_data_unused_t *)ptr;\r\nif (be16_to_cpu(dup->freetag) == XFS_DIR2_DATA_FREE_TAG) {\r\nptr += be16_to_cpu(dup->length);\r\ncontinue;\r\n}\r\ndep = (xfs_dir2_data_entry_t *)ptr;\r\nptr += dp->d_ops->data_entsize(dep->namelen);\r\nif ((char *)dep - (char *)hdr < wantoff)\r\ncontinue;\r\ncook = xfs_dir2_db_off_to_dataptr(geo, geo->datablk,\r\n(char *)dep - (char *)hdr);\r\nctx->pos = cook & 0x7fffffff;\r\nfiletype = dp->d_ops->data_get_ftype(dep);\r\nif (!dir_emit(ctx, (char *)dep->name, dep->namelen,\r\nbe64_to_cpu(dep->inumber),\r\nxfs_dir3_get_dtype(dp->i_mount, filetype))) {\r\nxfs_trans_brelse(NULL, bp);\r\nreturn 0;\r\n}\r\n}\r\nctx->pos = xfs_dir2_db_off_to_dataptr(geo, geo->datablk + 1, 0) &\r\n0x7fffffff;\r\nxfs_trans_brelse(NULL, bp);\r\nreturn 0;\r\n}\r\nSTATIC int\r\nxfs_dir2_leaf_readbuf(\r\nstruct xfs_da_args *args,\r\nsize_t bufsize,\r\nstruct xfs_dir2_leaf_map_info *mip,\r\nxfs_dir2_off_t *curoff,\r\nstruct xfs_buf **bpp)\r\n{\r\nstruct xfs_inode *dp = args->dp;\r\nstruct xfs_buf *bp = *bpp;\r\nstruct xfs_bmbt_irec *map = mip->map;\r\nstruct blk_plug plug;\r\nint error = 0;\r\nint length;\r\nint i;\r\nint j;\r\nstruct xfs_da_geometry *geo = args->geo;\r\nif (bp) {\r\nxfs_trans_brelse(NULL, bp);\r\nbp = NULL;\r\nmip->map_blocks -= geo->fsbcount;\r\nfor (i = geo->fsbcount; i > 0; ) {\r\nj = min_t(int, map->br_blockcount, i);\r\nmap->br_blockcount -= j;\r\nmap->br_startblock += j;\r\nmap->br_startoff += j;\r\nif (!map->br_blockcount && --mip->map_valid)\r\nmemmove(&map[0], &map[1],\r\nsizeof(map[0]) * mip->map_valid);\r\ni -= j;\r\n}\r\n}\r\nmip->ra_want = howmany(bufsize + geo->blksize, (1 << geo->fsblog)) - 1;\r\nASSERT(mip->ra_want >= 0);\r\nif (1 + mip->ra_want > mip->map_blocks &&\r\nmip->map_off < xfs_dir2_byte_to_da(geo, XFS_DIR2_LEAF_OFFSET)) {\r\nmip->nmap = mip->map_size - mip->map_valid;\r\nerror = xfs_bmapi_read(dp, mip->map_off,\r\nxfs_dir2_byte_to_da(geo, XFS_DIR2_LEAF_OFFSET) -\r\nmip->map_off,\r\n&map[mip->map_valid], &mip->nmap, 0);\r\nif (error)\r\ngoto out;\r\nif (mip->nmap == mip->map_size - mip->map_valid) {\r\ni = mip->map_valid + mip->nmap - 1;\r\nmip->map_off = map[i].br_startoff + map[i].br_blockcount;\r\n} else\r\nmip->map_off = xfs_dir2_byte_to_da(geo,\r\nXFS_DIR2_LEAF_OFFSET);\r\nfor (i = mip->map_valid; i < mip->map_valid + mip->nmap; ) {\r\nif (map[i].br_startblock == HOLESTARTBLOCK) {\r\nmip->nmap--;\r\nlength = mip->map_valid + mip->nmap - i;\r\nif (length)\r\nmemmove(&map[i], &map[i + 1],\r\nsizeof(map[i]) * length);\r\n} else {\r\nmip->map_blocks += map[i].br_blockcount;\r\ni++;\r\n}\r\n}\r\nmip->map_valid += mip->nmap;\r\n}\r\nif (!mip->map_valid) {\r\n*curoff = xfs_dir2_da_to_byte(geo, mip->map_off);\r\ngoto out;\r\n}\r\nmip->curdb = xfs_dir2_da_to_db(geo, map->br_startoff);\r\nerror = xfs_dir3_data_read(NULL, dp, map->br_startoff,\r\nmap->br_blockcount >= geo->fsbcount ?\r\nXFS_FSB_TO_DADDR(dp->i_mount, map->br_startblock) :\r\n-1, &bp);\r\nif (error)\r\ngoto out;\r\nif (mip->ra_current)\r\nmip->ra_current -= geo->fsbcount;\r\nblk_start_plug(&plug);\r\nfor (mip->ra_index = mip->ra_offset = i = 0;\r\nmip->ra_want > mip->ra_current && i < mip->map_blocks;\r\ni += geo->fsbcount) {\r\nASSERT(mip->ra_index < mip->map_valid);\r\nif (i > mip->ra_current &&\r\nmap[mip->ra_index].br_blockcount >= geo->fsbcount) {\r\nxfs_dir3_data_readahead(dp,\r\nmap[mip->ra_index].br_startoff + mip->ra_offset,\r\nXFS_FSB_TO_DADDR(dp->i_mount,\r\nmap[mip->ra_index].br_startblock +\r\nmip->ra_offset));\r\nmip->ra_current = i;\r\n}\r\nelse if (i > mip->ra_current) {\r\nxfs_dir3_data_readahead(dp,\r\nmap[mip->ra_index].br_startoff +\r\nmip->ra_offset, -1);\r\nmip->ra_current = i;\r\n}\r\nfor (j = 0; j < geo->fsbcount; j += length ) {\r\nlength = min_t(int, geo->fsbcount,\r\nmap[mip->ra_index].br_blockcount -\r\nmip->ra_offset);\r\nmip->ra_offset += length;\r\nif (mip->ra_offset == map[mip->ra_index].br_blockcount) {\r\nmip->ra_offset = 0;\r\nmip->ra_index++;\r\n}\r\n}\r\n}\r\nblk_finish_plug(&plug);\r\nout:\r\n*bpp = bp;\r\nreturn error;\r\n}\r\nSTATIC int\r\nxfs_dir2_leaf_getdents(\r\nstruct xfs_da_args *args,\r\nstruct dir_context *ctx,\r\nsize_t bufsize)\r\n{\r\nstruct xfs_inode *dp = args->dp;\r\nstruct xfs_buf *bp = NULL;\r\nxfs_dir2_data_hdr_t *hdr;\r\nxfs_dir2_data_entry_t *dep;\r\nxfs_dir2_data_unused_t *dup;\r\nint error = 0;\r\nint length;\r\nint byteoff;\r\nxfs_dir2_off_t curoff;\r\nxfs_dir2_off_t newoff;\r\nchar *ptr = NULL;\r\nstruct xfs_dir2_leaf_map_info *map_info;\r\nstruct xfs_da_geometry *geo = args->geo;\r\nif (ctx->pos >= XFS_DIR2_MAX_DATAPTR)\r\nreturn 0;\r\nlength = howmany(bufsize + geo->blksize, (1 << geo->fsblog));\r\nmap_info = kmem_zalloc(offsetof(struct xfs_dir2_leaf_map_info, map) +\r\n(length * sizeof(struct xfs_bmbt_irec)),\r\nKM_SLEEP | KM_NOFS);\r\nmap_info->map_size = length;\r\ncuroff = xfs_dir2_dataptr_to_byte(ctx->pos);\r\nmap_info->map_off = xfs_dir2_db_to_da(geo,\r\nxfs_dir2_byte_to_db(geo, curoff));\r\nwhile (curoff < XFS_DIR2_LEAF_OFFSET) {\r\n__uint8_t filetype;\r\nif (!bp || ptr >= (char *)bp->b_addr + geo->blksize) {\r\nint lock_mode;\r\nlock_mode = xfs_ilock_data_map_shared(dp);\r\nerror = xfs_dir2_leaf_readbuf(args, bufsize, map_info,\r\n&curoff, &bp);\r\nxfs_iunlock(dp, lock_mode);\r\nif (error || !map_info->map_valid)\r\nbreak;\r\nnewoff = xfs_dir2_db_off_to_byte(geo,\r\nmap_info->curdb, 0);\r\nif (curoff < newoff)\r\ncuroff = newoff;\r\nelse if (curoff > newoff)\r\nASSERT(xfs_dir2_byte_to_db(geo, curoff) ==\r\nmap_info->curdb);\r\nhdr = bp->b_addr;\r\nxfs_dir3_data_check(dp, bp);\r\nptr = (char *)dp->d_ops->data_entry_p(hdr);\r\nbyteoff = xfs_dir2_byte_to_off(geo, curoff);\r\nif (byteoff == 0)\r\ncuroff += dp->d_ops->data_entry_offset;\r\nelse {\r\nwhile ((char *)ptr - (char *)hdr < byteoff) {\r\ndup = (xfs_dir2_data_unused_t *)ptr;\r\nif (be16_to_cpu(dup->freetag)\r\n== XFS_DIR2_DATA_FREE_TAG) {\r\nlength = be16_to_cpu(dup->length);\r\nptr += length;\r\ncontinue;\r\n}\r\ndep = (xfs_dir2_data_entry_t *)ptr;\r\nlength =\r\ndp->d_ops->data_entsize(dep->namelen);\r\nptr += length;\r\n}\r\ncuroff =\r\nxfs_dir2_db_off_to_byte(geo,\r\nxfs_dir2_byte_to_db(geo, curoff),\r\n(char *)ptr - (char *)hdr);\r\nif (ptr >= (char *)hdr + geo->blksize) {\r\ncontinue;\r\n}\r\n}\r\n}\r\ndup = (xfs_dir2_data_unused_t *)ptr;\r\nif (be16_to_cpu(dup->freetag) == XFS_DIR2_DATA_FREE_TAG) {\r\nlength = be16_to_cpu(dup->length);\r\nptr += length;\r\ncuroff += length;\r\ncontinue;\r\n}\r\ndep = (xfs_dir2_data_entry_t *)ptr;\r\nlength = dp->d_ops->data_entsize(dep->namelen);\r\nfiletype = dp->d_ops->data_get_ftype(dep);\r\nctx->pos = xfs_dir2_byte_to_dataptr(curoff) & 0x7fffffff;\r\nif (!dir_emit(ctx, (char *)dep->name, dep->namelen,\r\nbe64_to_cpu(dep->inumber),\r\nxfs_dir3_get_dtype(dp->i_mount, filetype)))\r\nbreak;\r\nptr += length;\r\ncuroff += length;\r\nbufsize = bufsize > length ? bufsize - length : 0;\r\n}\r\nif (curoff > xfs_dir2_dataptr_to_byte(XFS_DIR2_MAX_DATAPTR))\r\nctx->pos = XFS_DIR2_MAX_DATAPTR & 0x7fffffff;\r\nelse\r\nctx->pos = xfs_dir2_byte_to_dataptr(curoff) & 0x7fffffff;\r\nkmem_free(map_info);\r\nif (bp)\r\nxfs_trans_brelse(NULL, bp);\r\nreturn error;\r\n}\r\nint\r\nxfs_readdir(\r\nstruct xfs_inode *dp,\r\nstruct dir_context *ctx,\r\nsize_t bufsize)\r\n{\r\nstruct xfs_da_args args = { NULL };\r\nint rval;\r\nint v;\r\ntrace_xfs_readdir(dp);\r\nif (XFS_FORCED_SHUTDOWN(dp->i_mount))\r\nreturn -EIO;\r\nASSERT(S_ISDIR(dp->i_d.di_mode));\r\nXFS_STATS_INC(dp->i_mount, xs_dir_getdents);\r\nargs.dp = dp;\r\nargs.geo = dp->i_mount->m_dir_geo;\r\nxfs_ilock(dp, XFS_IOLOCK_SHARED);\r\nif (dp->i_d.di_format == XFS_DINODE_FMT_LOCAL)\r\nrval = xfs_dir2_sf_getdents(&args, ctx);\r\nelse if ((rval = xfs_dir2_isblock(&args, &v)))\r\n;\r\nelse if (v)\r\nrval = xfs_dir2_block_getdents(&args, ctx);\r\nelse\r\nrval = xfs_dir2_leaf_getdents(&args, ctx, bufsize);\r\nxfs_iunlock(dp, XFS_IOLOCK_SHARED);\r\nreturn rval;\r\n}

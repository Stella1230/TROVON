static ssize_t dgnc_driver_version_show(struct device_driver *ddp, char *buf)\r\n{\r\nreturn snprintf(buf, PAGE_SIZE, "%s\n", DG_PART);\r\n}\r\nstatic ssize_t dgnc_driver_boards_show(struct device_driver *ddp, char *buf)\r\n{\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", dgnc_NumBoards);\r\n}\r\nstatic ssize_t dgnc_driver_maxboards_show(struct device_driver *ddp, char *buf)\r\n{\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", MAXBOARDS);\r\n}\r\nstatic ssize_t dgnc_driver_pollrate_show(struct device_driver *ddp, char *buf)\r\n{\r\nreturn snprintf(buf, PAGE_SIZE, "%dms\n", dgnc_poll_tick);\r\n}\r\nstatic ssize_t dgnc_driver_pollrate_store(struct device_driver *ddp,\r\nconst char *buf, size_t count)\r\n{\r\nunsigned long flags;\r\nint tick;\r\nint ret;\r\nret = sscanf(buf, "%d\n", &tick);\r\nif (ret != 1)\r\nreturn -EINVAL;\r\nspin_lock_irqsave(&dgnc_poll_lock, flags);\r\ndgnc_poll_tick = tick;\r\nspin_unlock_irqrestore(&dgnc_poll_lock, flags);\r\nreturn count;\r\n}\r\nvoid dgnc_create_driver_sysfiles(struct pci_driver *dgnc_driver)\r\n{\r\nint rc = 0;\r\nstruct device_driver *driverfs = &dgnc_driver->driver;\r\nrc |= driver_create_file(driverfs, &driver_attr_version);\r\nrc |= driver_create_file(driverfs, &driver_attr_boards);\r\nrc |= driver_create_file(driverfs, &driver_attr_maxboards);\r\nrc |= driver_create_file(driverfs, &driver_attr_pollrate);\r\nif (rc)\r\npr_err("DGNC: sysfs driver_create_file failed!\n");\r\n}\r\nvoid dgnc_remove_driver_sysfiles(struct pci_driver *dgnc_driver)\r\n{\r\nstruct device_driver *driverfs = &dgnc_driver->driver;\r\ndriver_remove_file(driverfs, &driver_attr_version);\r\ndriver_remove_file(driverfs, &driver_attr_boards);\r\ndriver_remove_file(driverfs, &driver_attr_maxboards);\r\ndriver_remove_file(driverfs, &driver_attr_pollrate);\r\n}\r\nstatic ssize_t dgnc_vpd_show(struct device *p, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct dgnc_board *bd;\r\nint count = 0;\r\nint i = 0;\r\nDGNC_VERIFY_BOARD(p, bd);\r\ncount += sprintf(buf + count,\r\n"\n 0 1 2 3 4 5 6 7 8 9 A B C D E F");\r\nfor (i = 0; i < 0x40 * 2; i++) {\r\nif (!(i % 16))\r\ncount += sprintf(buf + count, "\n%04X ", i * 2);\r\ncount += sprintf(buf + count, "%02X ", bd->vpd[i]);\r\n}\r\ncount += sprintf(buf + count, "\n");\r\nreturn count;\r\n}\r\nstatic ssize_t dgnc_serial_number_show(struct device *p,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct dgnc_board *bd;\r\nint count = 0;\r\nDGNC_VERIFY_BOARD(p, bd);\r\nif (bd->serial_num[0] == '\0')\r\ncount += sprintf(buf + count, "<UNKNOWN>\n");\r\nelse\r\ncount += sprintf(buf + count, "%s\n", bd->serial_num);\r\nreturn count;\r\n}\r\nstatic ssize_t dgnc_ports_state_show(struct device *p,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct dgnc_board *bd;\r\nint count = 0;\r\nint i = 0;\r\nDGNC_VERIFY_BOARD(p, bd);\r\nfor (i = 0; i < bd->nasync; i++) {\r\ncount += snprintf(buf + count, PAGE_SIZE - count,\r\n"%d %s\n", bd->channels[i]->ch_portnum,\r\nbd->channels[i]->ch_open_count ? "Open" : "Closed");\r\n}\r\nreturn count;\r\n}\r\nstatic ssize_t dgnc_ports_baud_show(struct device *p,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct dgnc_board *bd;\r\nint count = 0;\r\nint i = 0;\r\nDGNC_VERIFY_BOARD(p, bd);\r\nfor (i = 0; i < bd->nasync; i++) {\r\ncount += snprintf(buf + count, PAGE_SIZE - count,\r\n"%d %d\n", bd->channels[i]->ch_portnum,\r\nbd->channels[i]->ch_old_baud);\r\n}\r\nreturn count;\r\n}\r\nstatic ssize_t dgnc_ports_msignals_show(struct device *p,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct dgnc_board *bd;\r\nint count = 0;\r\nint i = 0;\r\nDGNC_VERIFY_BOARD(p, bd);\r\nfor (i = 0; i < bd->nasync; i++) {\r\nif (bd->channels[i]->ch_open_count) {\r\ncount += snprintf(buf + count, PAGE_SIZE - count,\r\n"%d %s %s %s %s %s %s\n",\r\nbd->channels[i]->ch_portnum,\r\n(bd->channels[i]->ch_mostat & UART_MCR_RTS) ? "RTS" : "",\r\n(bd->channels[i]->ch_mistat & UART_MSR_CTS) ? "CTS" : "",\r\n(bd->channels[i]->ch_mostat & UART_MCR_DTR) ? "DTR" : "",\r\n(bd->channels[i]->ch_mistat & UART_MSR_DSR) ? "DSR" : "",\r\n(bd->channels[i]->ch_mistat & UART_MSR_DCD) ? "DCD" : "",\r\n(bd->channels[i]->ch_mistat & UART_MSR_RI) ? "RI" : "");\r\n} else {\r\ncount += snprintf(buf + count, PAGE_SIZE - count,\r\n"%d\n", bd->channels[i]->ch_portnum);\r\n}\r\n}\r\nreturn count;\r\n}\r\nstatic ssize_t dgnc_ports_iflag_show(struct device *p,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct dgnc_board *bd;\r\nint count = 0;\r\nint i = 0;\r\nDGNC_VERIFY_BOARD(p, bd);\r\nfor (i = 0; i < bd->nasync; i++) {\r\ncount += snprintf(buf + count, PAGE_SIZE - count, "%d %x\n",\r\nbd->channels[i]->ch_portnum,\r\nbd->channels[i]->ch_c_iflag);\r\n}\r\nreturn count;\r\n}\r\nstatic ssize_t dgnc_ports_cflag_show(struct device *p,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct dgnc_board *bd;\r\nint count = 0;\r\nint i = 0;\r\nDGNC_VERIFY_BOARD(p, bd);\r\nfor (i = 0; i < bd->nasync; i++) {\r\ncount += snprintf(buf + count, PAGE_SIZE - count, "%d %x\n",\r\nbd->channels[i]->ch_portnum,\r\nbd->channels[i]->ch_c_cflag);\r\n}\r\nreturn count;\r\n}\r\nstatic ssize_t dgnc_ports_oflag_show(struct device *p,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct dgnc_board *bd;\r\nint count = 0;\r\nint i = 0;\r\nDGNC_VERIFY_BOARD(p, bd);\r\nfor (i = 0; i < bd->nasync; i++) {\r\ncount += snprintf(buf + count, PAGE_SIZE - count, "%d %x\n",\r\nbd->channels[i]->ch_portnum,\r\nbd->channels[i]->ch_c_oflag);\r\n}\r\nreturn count;\r\n}\r\nstatic ssize_t dgnc_ports_lflag_show(struct device *p,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct dgnc_board *bd;\r\nint count = 0;\r\nint i = 0;\r\nDGNC_VERIFY_BOARD(p, bd);\r\nfor (i = 0; i < bd->nasync; i++) {\r\ncount += snprintf(buf + count, PAGE_SIZE - count, "%d %x\n",\r\nbd->channels[i]->ch_portnum,\r\nbd->channels[i]->ch_c_lflag);\r\n}\r\nreturn count;\r\n}\r\nstatic ssize_t dgnc_ports_digi_flag_show(struct device *p,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct dgnc_board *bd;\r\nint count = 0;\r\nint i = 0;\r\nDGNC_VERIFY_BOARD(p, bd);\r\nfor (i = 0; i < bd->nasync; i++) {\r\ncount += snprintf(buf + count, PAGE_SIZE - count, "%d %x\n",\r\nbd->channels[i]->ch_portnum,\r\nbd->channels[i]->ch_digi.digi_flags);\r\n}\r\nreturn count;\r\n}\r\nstatic ssize_t dgnc_ports_rxcount_show(struct device *p,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct dgnc_board *bd;\r\nint count = 0;\r\nint i = 0;\r\nDGNC_VERIFY_BOARD(p, bd);\r\nfor (i = 0; i < bd->nasync; i++) {\r\ncount += snprintf(buf + count, PAGE_SIZE - count, "%d %ld\n",\r\nbd->channels[i]->ch_portnum,\r\nbd->channels[i]->ch_rxcount);\r\n}\r\nreturn count;\r\n}\r\nstatic ssize_t dgnc_ports_txcount_show(struct device *p,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct dgnc_board *bd;\r\nint count = 0;\r\nint i = 0;\r\nDGNC_VERIFY_BOARD(p, bd);\r\nfor (i = 0; i < bd->nasync; i++) {\r\ncount += snprintf(buf + count, PAGE_SIZE - count, "%d %ld\n",\r\nbd->channels[i]->ch_portnum,\r\nbd->channels[i]->ch_txcount);\r\n}\r\nreturn count;\r\n}\r\nvoid dgnc_create_ports_sysfiles(struct dgnc_board *bd)\r\n{\r\nint rc = 0;\r\ndev_set_drvdata(&bd->pdev->dev, bd);\r\nrc |= device_create_file(&bd->pdev->dev, &dev_attr_ports_state);\r\nrc |= device_create_file(&bd->pdev->dev, &dev_attr_ports_baud);\r\nrc |= device_create_file(&bd->pdev->dev, &dev_attr_ports_msignals);\r\nrc |= device_create_file(&bd->pdev->dev, &dev_attr_ports_iflag);\r\nrc |= device_create_file(&bd->pdev->dev, &dev_attr_ports_cflag);\r\nrc |= device_create_file(&bd->pdev->dev, &dev_attr_ports_oflag);\r\nrc |= device_create_file(&bd->pdev->dev, &dev_attr_ports_lflag);\r\nrc |= device_create_file(&bd->pdev->dev, &dev_attr_ports_digi_flag);\r\nrc |= device_create_file(&bd->pdev->dev, &dev_attr_ports_rxcount);\r\nrc |= device_create_file(&bd->pdev->dev, &dev_attr_ports_txcount);\r\nrc |= device_create_file(&bd->pdev->dev, &dev_attr_vpd);\r\nrc |= device_create_file(&bd->pdev->dev, &dev_attr_serial_number);\r\nif (rc)\r\ndev_err(&bd->pdev->dev, "dgnc: sysfs device_create_file failed!\n");\r\n}\r\nvoid dgnc_remove_ports_sysfiles(struct dgnc_board *bd)\r\n{\r\ndevice_remove_file(&bd->pdev->dev, &dev_attr_ports_state);\r\ndevice_remove_file(&bd->pdev->dev, &dev_attr_ports_baud);\r\ndevice_remove_file(&bd->pdev->dev, &dev_attr_ports_msignals);\r\ndevice_remove_file(&bd->pdev->dev, &dev_attr_ports_iflag);\r\ndevice_remove_file(&bd->pdev->dev, &dev_attr_ports_cflag);\r\ndevice_remove_file(&bd->pdev->dev, &dev_attr_ports_oflag);\r\ndevice_remove_file(&bd->pdev->dev, &dev_attr_ports_lflag);\r\ndevice_remove_file(&bd->pdev->dev, &dev_attr_ports_digi_flag);\r\ndevice_remove_file(&bd->pdev->dev, &dev_attr_ports_rxcount);\r\ndevice_remove_file(&bd->pdev->dev, &dev_attr_ports_txcount);\r\ndevice_remove_file(&bd->pdev->dev, &dev_attr_vpd);\r\ndevice_remove_file(&bd->pdev->dev, &dev_attr_serial_number);\r\n}\r\nstatic ssize_t dgnc_tty_state_show(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct dgnc_board *bd;\r\nstruct channel_t *ch;\r\nstruct un_t *un;\r\nif (!d)\r\nreturn 0;\r\nun = dev_get_drvdata(d);\r\nif (!un || un->magic != DGNC_UNIT_MAGIC)\r\nreturn 0;\r\nch = un->un_ch;\r\nif (!ch || ch->magic != DGNC_CHANNEL_MAGIC)\r\nreturn 0;\r\nbd = ch->ch_bd;\r\nif (!bd || bd->magic != DGNC_BOARD_MAGIC)\r\nreturn 0;\r\nif (bd->state != BOARD_READY)\r\nreturn 0;\r\nreturn snprintf(buf, PAGE_SIZE, "%s",\r\nun->un_open_count ? "Open" : "Closed");\r\n}\r\nstatic ssize_t dgnc_tty_baud_show(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct dgnc_board *bd;\r\nstruct channel_t *ch;\r\nstruct un_t *un;\r\nif (!d)\r\nreturn 0;\r\nun = dev_get_drvdata(d);\r\nif (!un || un->magic != DGNC_UNIT_MAGIC)\r\nreturn 0;\r\nch = un->un_ch;\r\nif (!ch || ch->magic != DGNC_CHANNEL_MAGIC)\r\nreturn 0;\r\nbd = ch->ch_bd;\r\nif (!bd || bd->magic != DGNC_BOARD_MAGIC)\r\nreturn 0;\r\nif (bd->state != BOARD_READY)\r\nreturn 0;\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", ch->ch_old_baud);\r\n}\r\nstatic ssize_t dgnc_tty_msignals_show(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct dgnc_board *bd;\r\nstruct channel_t *ch;\r\nstruct un_t *un;\r\nif (!d)\r\nreturn 0;\r\nun = dev_get_drvdata(d);\r\nif (!un || un->magic != DGNC_UNIT_MAGIC)\r\nreturn 0;\r\nch = un->un_ch;\r\nif (!ch || ch->magic != DGNC_CHANNEL_MAGIC)\r\nreturn 0;\r\nbd = ch->ch_bd;\r\nif (!bd || bd->magic != DGNC_BOARD_MAGIC)\r\nreturn 0;\r\nif (bd->state != BOARD_READY)\r\nreturn 0;\r\nif (ch->ch_open_count) {\r\nreturn snprintf(buf, PAGE_SIZE, "%s %s %s %s %s %s\n",\r\n(ch->ch_mostat & UART_MCR_RTS) ? "RTS" : "",\r\n(ch->ch_mistat & UART_MSR_CTS) ? "CTS" : "",\r\n(ch->ch_mostat & UART_MCR_DTR) ? "DTR" : "",\r\n(ch->ch_mistat & UART_MSR_DSR) ? "DSR" : "",\r\n(ch->ch_mistat & UART_MSR_DCD) ? "DCD" : "",\r\n(ch->ch_mistat & UART_MSR_RI) ? "RI" : "");\r\n}\r\nreturn 0;\r\n}\r\nstatic ssize_t dgnc_tty_iflag_show(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct dgnc_board *bd;\r\nstruct channel_t *ch;\r\nstruct un_t *un;\r\nif (!d)\r\nreturn 0;\r\nun = dev_get_drvdata(d);\r\nif (!un || un->magic != DGNC_UNIT_MAGIC)\r\nreturn 0;\r\nch = un->un_ch;\r\nif (!ch || ch->magic != DGNC_CHANNEL_MAGIC)\r\nreturn 0;\r\nbd = ch->ch_bd;\r\nif (!bd || bd->magic != DGNC_BOARD_MAGIC)\r\nreturn 0;\r\nif (bd->state != BOARD_READY)\r\nreturn 0;\r\nreturn snprintf(buf, PAGE_SIZE, "%x\n", ch->ch_c_iflag);\r\n}\r\nstatic ssize_t dgnc_tty_cflag_show(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct dgnc_board *bd;\r\nstruct channel_t *ch;\r\nstruct un_t *un;\r\nif (!d)\r\nreturn 0;\r\nun = dev_get_drvdata(d);\r\nif (!un || un->magic != DGNC_UNIT_MAGIC)\r\nreturn 0;\r\nch = un->un_ch;\r\nif (!ch || ch->magic != DGNC_CHANNEL_MAGIC)\r\nreturn 0;\r\nbd = ch->ch_bd;\r\nif (!bd || bd->magic != DGNC_BOARD_MAGIC)\r\nreturn 0;\r\nif (bd->state != BOARD_READY)\r\nreturn 0;\r\nreturn snprintf(buf, PAGE_SIZE, "%x\n", ch->ch_c_cflag);\r\n}\r\nstatic ssize_t dgnc_tty_oflag_show(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct dgnc_board *bd;\r\nstruct channel_t *ch;\r\nstruct un_t *un;\r\nif (!d)\r\nreturn 0;\r\nun = dev_get_drvdata(d);\r\nif (!un || un->magic != DGNC_UNIT_MAGIC)\r\nreturn 0;\r\nch = un->un_ch;\r\nif (!ch || ch->magic != DGNC_CHANNEL_MAGIC)\r\nreturn 0;\r\nbd = ch->ch_bd;\r\nif (!bd || bd->magic != DGNC_BOARD_MAGIC)\r\nreturn 0;\r\nif (bd->state != BOARD_READY)\r\nreturn 0;\r\nreturn snprintf(buf, PAGE_SIZE, "%x\n", ch->ch_c_oflag);\r\n}\r\nstatic ssize_t dgnc_tty_lflag_show(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct dgnc_board *bd;\r\nstruct channel_t *ch;\r\nstruct un_t *un;\r\nif (!d)\r\nreturn 0;\r\nun = dev_get_drvdata(d);\r\nif (!un || un->magic != DGNC_UNIT_MAGIC)\r\nreturn 0;\r\nch = un->un_ch;\r\nif (!ch || ch->magic != DGNC_CHANNEL_MAGIC)\r\nreturn 0;\r\nbd = ch->ch_bd;\r\nif (!bd || bd->magic != DGNC_BOARD_MAGIC)\r\nreturn 0;\r\nif (bd->state != BOARD_READY)\r\nreturn 0;\r\nreturn snprintf(buf, PAGE_SIZE, "%x\n", ch->ch_c_lflag);\r\n}\r\nstatic ssize_t dgnc_tty_digi_flag_show(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct dgnc_board *bd;\r\nstruct channel_t *ch;\r\nstruct un_t *un;\r\nif (!d)\r\nreturn 0;\r\nun = dev_get_drvdata(d);\r\nif (!un || un->magic != DGNC_UNIT_MAGIC)\r\nreturn 0;\r\nch = un->un_ch;\r\nif (!ch || ch->magic != DGNC_CHANNEL_MAGIC)\r\nreturn 0;\r\nbd = ch->ch_bd;\r\nif (!bd || bd->magic != DGNC_BOARD_MAGIC)\r\nreturn 0;\r\nif (bd->state != BOARD_READY)\r\nreturn 0;\r\nreturn snprintf(buf, PAGE_SIZE, "%x\n", ch->ch_digi.digi_flags);\r\n}\r\nstatic ssize_t dgnc_tty_rxcount_show(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct dgnc_board *bd;\r\nstruct channel_t *ch;\r\nstruct un_t *un;\r\nif (!d)\r\nreturn 0;\r\nun = dev_get_drvdata(d);\r\nif (!un || un->magic != DGNC_UNIT_MAGIC)\r\nreturn 0;\r\nch = un->un_ch;\r\nif (!ch || ch->magic != DGNC_CHANNEL_MAGIC)\r\nreturn 0;\r\nbd = ch->ch_bd;\r\nif (!bd || bd->magic != DGNC_BOARD_MAGIC)\r\nreturn 0;\r\nif (bd->state != BOARD_READY)\r\nreturn 0;\r\nreturn snprintf(buf, PAGE_SIZE, "%ld\n", ch->ch_rxcount);\r\n}\r\nstatic ssize_t dgnc_tty_txcount_show(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct dgnc_board *bd;\r\nstruct channel_t *ch;\r\nstruct un_t *un;\r\nif (!d)\r\nreturn 0;\r\nun = dev_get_drvdata(d);\r\nif (!un || un->magic != DGNC_UNIT_MAGIC)\r\nreturn 0;\r\nch = un->un_ch;\r\nif (!ch || ch->magic != DGNC_CHANNEL_MAGIC)\r\nreturn 0;\r\nbd = ch->ch_bd;\r\nif (!bd || bd->magic != DGNC_BOARD_MAGIC)\r\nreturn 0;\r\nif (bd->state != BOARD_READY)\r\nreturn 0;\r\nreturn snprintf(buf, PAGE_SIZE, "%ld\n", ch->ch_txcount);\r\n}\r\nstatic ssize_t dgnc_tty_name_show(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct dgnc_board *bd;\r\nstruct channel_t *ch;\r\nstruct un_t *un;\r\nif (!d)\r\nreturn 0;\r\nun = dev_get_drvdata(d);\r\nif (!un || un->magic != DGNC_UNIT_MAGIC)\r\nreturn 0;\r\nch = un->un_ch;\r\nif (!ch || ch->magic != DGNC_CHANNEL_MAGIC)\r\nreturn 0;\r\nbd = ch->ch_bd;\r\nif (!bd || bd->magic != DGNC_BOARD_MAGIC)\r\nreturn 0;\r\nif (bd->state != BOARD_READY)\r\nreturn 0;\r\nreturn snprintf(buf, PAGE_SIZE, "%sn%d%c\n",\r\n(un->un_type == DGNC_PRINT) ? "pr" : "tty",\r\nbd->boardnum + 1, 'a' + ch->ch_portnum);\r\n}\r\nvoid dgnc_create_tty_sysfs(struct un_t *un, struct device *c)\r\n{\r\nint ret;\r\nret = sysfs_create_group(&c->kobj, &dgnc_tty_attribute_group);\r\nif (ret) {\r\ndev_err(c, "dgnc: failed to create sysfs tty device attributes.\n");\r\nsysfs_remove_group(&c->kobj, &dgnc_tty_attribute_group);\r\nreturn;\r\n}\r\ndev_set_drvdata(c, un);\r\n}\r\nvoid dgnc_remove_tty_sysfs(struct device *c)\r\n{\r\nsysfs_remove_group(&c->kobj, &dgnc_tty_attribute_group);\r\n}

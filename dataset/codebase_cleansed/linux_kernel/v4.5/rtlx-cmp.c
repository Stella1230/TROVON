static void rtlx_interrupt(void)\r\n{\r\nint i;\r\nstruct rtlx_info *info;\r\nstruct rtlx_info **p = vpe_get_shared(aprp_cpu_index());\r\nif (p == NULL || *p == NULL)\r\nreturn;\r\ninfo = *p;\r\nif (info->ap_int_pending == 1 && smp_processor_id() == 0) {\r\nfor (i = 0; i < RTLX_CHANNELS; i++) {\r\nwake_up(&channel_wqs[i].lx_queue);\r\nwake_up(&channel_wqs[i].rt_queue);\r\n}\r\ninfo->ap_int_pending = 0;\r\n}\r\n}\r\nvoid _interrupt_sp(void)\r\n{\r\nsmp_send_reschedule(aprp_cpu_index());\r\n}\r\nint __init rtlx_module_init(void)\r\n{\r\nstruct device *dev;\r\nint i, err;\r\nif (!cpu_has_mipsmt) {\r\npr_warn("VPE loader: not a MIPS MT capable processor\n");\r\nreturn -ENODEV;\r\n}\r\nif (num_possible_cpus() - aprp_cpu_index() < 1) {\r\npr_warn("No TCs reserved for AP/SP, not initializing RTLX.\n"\r\n"Pass maxcpus=<n> argument as kernel argument\n");\r\nreturn -ENODEV;\r\n}\r\nmajor = register_chrdev(0, RTLX_MODULE_NAME, &rtlx_fops);\r\nif (major < 0) {\r\npr_err("rtlx_module_init: unable to register device\n");\r\nreturn major;\r\n}\r\nfor (i = 0; i < RTLX_CHANNELS; i++) {\r\ninit_waitqueue_head(&channel_wqs[i].rt_queue);\r\ninit_waitqueue_head(&channel_wqs[i].lx_queue);\r\natomic_set(&channel_wqs[i].in_open, 0);\r\nmutex_init(&channel_wqs[i].mutex);\r\ndev = device_create(mt_class, NULL, MKDEV(major, i), NULL,\r\n"%s%d", RTLX_MODULE_NAME, i);\r\nif (IS_ERR(dev)) {\r\nwhile (i--)\r\ndevice_destroy(mt_class, MKDEV(major, i));\r\nerr = PTR_ERR(dev);\r\ngoto out_chrdev;\r\n}\r\n}\r\nrtlx_notify.start = rtlx_starting;\r\nrtlx_notify.stop = rtlx_stopping;\r\nvpe_notify(aprp_cpu_index(), &rtlx_notify);\r\nif (cpu_has_vint) {\r\naprp_hook = rtlx_interrupt;\r\n} else {\r\npr_err("APRP RTLX init on non-vectored-interrupt processor\n");\r\nerr = -ENODEV;\r\ngoto out_class;\r\n}\r\nreturn 0;\r\nout_class:\r\nfor (i = 0; i < RTLX_CHANNELS; i++)\r\ndevice_destroy(mt_class, MKDEV(major, i));\r\nout_chrdev:\r\nunregister_chrdev(major, RTLX_MODULE_NAME);\r\nreturn err;\r\n}\r\nvoid __exit rtlx_module_exit(void)\r\n{\r\nint i;\r\nfor (i = 0; i < RTLX_CHANNELS; i++)\r\ndevice_destroy(mt_class, MKDEV(major, i));\r\nunregister_chrdev(major, RTLX_MODULE_NAME);\r\naprp_hook = NULL;\r\n}

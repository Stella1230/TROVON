struct timespec *\r\nudf_disk_stamp_to_time(struct timespec *dest, struct timestamp src)\r\n{\r\nint yday;\r\nu16 typeAndTimezone = le16_to_cpu(src.typeAndTimezone);\r\nu16 year = le16_to_cpu(src.year);\r\nuint8_t type = typeAndTimezone >> 12;\r\nint16_t offset;\r\nif (type == 1) {\r\noffset = typeAndTimezone << 4;\r\noffset = (offset >> 4);\r\nif (offset == -2047)\r\noffset = 0;\r\n} else\r\noffset = 0;\r\nif ((year < EPOCH_YEAR) ||\r\n(year >= EPOCH_YEAR + MAX_YEAR_SECONDS)) {\r\nreturn NULL;\r\n}\r\ndest->tv_sec = year_seconds[year - EPOCH_YEAR];\r\ndest->tv_sec -= offset * 60;\r\nyday = ((__mon_yday[__isleap(year)][src.month - 1]) + src.day - 1);\r\ndest->tv_sec += (((yday * 24) + src.hour) * 60 + src.minute) * 60 + src.second;\r\ndest->tv_nsec = 1000 * (src.centiseconds * 10000 +\r\nsrc.hundredsOfMicroseconds * 100 + src.microseconds);\r\nreturn dest;\r\n}\r\nstruct timestamp *\r\nudf_time_to_disk_stamp(struct timestamp *dest, struct timespec ts)\r\n{\r\nlong int days, rem, y;\r\nconst unsigned short int *ip;\r\nint16_t offset;\r\noffset = -sys_tz.tz_minuteswest;\r\nif (!dest)\r\nreturn NULL;\r\ndest->typeAndTimezone = cpu_to_le16(0x1000 | (offset & 0x0FFF));\r\nts.tv_sec += offset * 60;\r\ndays = ts.tv_sec / SECS_PER_DAY;\r\nrem = ts.tv_sec % SECS_PER_DAY;\r\ndest->hour = rem / SECS_PER_HOUR;\r\nrem %= SECS_PER_HOUR;\r\ndest->minute = rem / 60;\r\ndest->second = rem % 60;\r\ny = 1970;\r\n#define DIV(a, b) ((a) / (b) - ((a) % (b) < 0))\r\n#define LEAPS_THRU_END_OF(y) (DIV (y, 4) - DIV (y, 100) + DIV (y, 400))\r\nwhile (days < 0 || days >= (__isleap(y) ? 366 : 365)) {\r\nlong int yg = y + days / 365 - (days % 365 < 0);\r\ndays -= ((yg - y) * 365\r\n+ LEAPS_THRU_END_OF(yg - 1)\r\n- LEAPS_THRU_END_OF(y - 1));\r\ny = yg;\r\n}\r\ndest->year = cpu_to_le16(y);\r\nip = __mon_yday[__isleap(y)];\r\nfor (y = 11; days < (long int)ip[y]; --y)\r\ncontinue;\r\ndays -= ip[y];\r\ndest->month = y + 1;\r\ndest->day = days + 1;\r\ndest->centiseconds = ts.tv_nsec / 10000000;\r\ndest->hundredsOfMicroseconds = (ts.tv_nsec / 1000 -\r\ndest->centiseconds * 10000) / 100;\r\ndest->microseconds = (ts.tv_nsec / 1000 - dest->centiseconds * 10000 -\r\ndest->hundredsOfMicroseconds * 100);\r\nreturn dest;\r\n}

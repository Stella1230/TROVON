static int rockchip_iodomain_write(struct rockchip_iodomain_supply *supply,\r\nint uV)\r\n{\r\nstruct rockchip_iodomain *iod = supply->iod;\r\nu32 val;\r\nint ret;\r\nval = (uV > MAX_VOLTAGE_1_8) ? 0 : 1;\r\nval <<= supply->idx;\r\nval |= (BIT(supply->idx) << 16);\r\nret = regmap_write(iod->grf, iod->soc_data->grf_offset, val);\r\nif (ret)\r\ndev_err(iod->dev, "Couldn't write to GRF\n");\r\nreturn ret;\r\n}\r\nstatic int rockchip_iodomain_notify(struct notifier_block *nb,\r\nunsigned long event,\r\nvoid *data)\r\n{\r\nstruct rockchip_iodomain_supply *supply =\r\ncontainer_of(nb, struct rockchip_iodomain_supply, nb);\r\nint uV;\r\nint ret;\r\nif (event & REGULATOR_EVENT_PRE_VOLTAGE_CHANGE) {\r\nstruct pre_voltage_change_data *pvc_data = data;\r\nuV = max_t(unsigned long, pvc_data->old_uV, pvc_data->max_uV);\r\n} else if (event & (REGULATOR_EVENT_VOLTAGE_CHANGE |\r\nREGULATOR_EVENT_ABORT_VOLTAGE_CHANGE)) {\r\nuV = (unsigned long)data;\r\n} else {\r\nreturn NOTIFY_OK;\r\n}\r\ndev_dbg(supply->iod->dev, "Setting to %d\n", uV);\r\nif (uV > MAX_VOLTAGE_3_3) {\r\ndev_err(supply->iod->dev, "Voltage too high: %d\n", uV);\r\nif (event == REGULATOR_EVENT_PRE_VOLTAGE_CHANGE)\r\nreturn NOTIFY_BAD;\r\n}\r\nret = rockchip_iodomain_write(supply, uV);\r\nif (ret && event == REGULATOR_EVENT_PRE_VOLTAGE_CHANGE)\r\nreturn NOTIFY_BAD;\r\ndev_info(supply->iod->dev, "Setting to %d done\n", uV);\r\nreturn NOTIFY_OK;\r\n}\r\nstatic void rk3288_iodomain_init(struct rockchip_iodomain *iod)\r\n{\r\nint ret;\r\nu32 val;\r\nif (!iod->supplies[RK3288_SOC_FLASH_SUPPLY_NUM].reg)\r\nreturn;\r\nval = RK3288_SOC_CON2_FLASH0 | (RK3288_SOC_CON2_FLASH0 << 16);\r\nret = regmap_write(iod->grf, RK3288_SOC_CON2, val);\r\nif (ret < 0)\r\ndev_warn(iod->dev, "couldn't update flash0 ctrl\n");\r\n}\r\nstatic void rk3368_iodomain_init(struct rockchip_iodomain *iod)\r\n{\r\nint ret;\r\nu32 val;\r\nif (!iod->supplies[RK3368_SOC_FLASH_SUPPLY_NUM].reg)\r\nreturn;\r\nval = RK3368_SOC_CON15_FLASH0 | (RK3368_SOC_CON15_FLASH0 << 16);\r\nret = regmap_write(iod->grf, RK3368_SOC_CON15, val);\r\nif (ret < 0)\r\ndev_warn(iod->dev, "couldn't update flash0 ctrl\n");\r\n}\r\nstatic int rockchip_iodomain_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nconst struct of_device_id *match;\r\nstruct rockchip_iodomain *iod;\r\nint i, ret = 0;\r\nif (!np)\r\nreturn -ENODEV;\r\niod = devm_kzalloc(&pdev->dev, sizeof(*iod), GFP_KERNEL);\r\nif (!iod)\r\nreturn -ENOMEM;\r\niod->dev = &pdev->dev;\r\nplatform_set_drvdata(pdev, iod);\r\nmatch = of_match_node(rockchip_iodomain_match, np);\r\niod->soc_data = (struct rockchip_iodomain_soc_data *)match->data;\r\niod->grf = syscon_regmap_lookup_by_phandle(np, "rockchip,grf");\r\nif (IS_ERR(iod->grf)) {\r\ndev_err(&pdev->dev, "couldn't find grf regmap\n");\r\nreturn PTR_ERR(iod->grf);\r\n}\r\nfor (i = 0; i < MAX_SUPPLIES; i++) {\r\nconst char *supply_name = iod->soc_data->supply_names[i];\r\nstruct rockchip_iodomain_supply *supply = &iod->supplies[i];\r\nstruct regulator *reg;\r\nint uV;\r\nif (!supply_name)\r\ncontinue;\r\nreg = devm_regulator_get_optional(iod->dev, supply_name);\r\nif (IS_ERR(reg)) {\r\nret = PTR_ERR(reg);\r\nif (ret == -ENODEV)\r\ncontinue;\r\nelse if (ret != -EPROBE_DEFER)\r\ndev_err(iod->dev, "couldn't get regulator %s\n",\r\nsupply_name);\r\ngoto unreg_notify;\r\n}\r\nuV = regulator_get_voltage(reg);\r\nif (uV < 0) {\r\ndev_err(iod->dev, "Can't determine voltage: %s\n",\r\nsupply_name);\r\ngoto unreg_notify;\r\n}\r\nif (uV > MAX_VOLTAGE_3_3) {\r\ndev_crit(iod->dev,\r\n"%d uV is too high. May damage SoC!\n",\r\nuV);\r\nret = -EINVAL;\r\ngoto unreg_notify;\r\n}\r\nsupply->idx = i;\r\nsupply->iod = iod;\r\nsupply->reg = reg;\r\nsupply->nb.notifier_call = rockchip_iodomain_notify;\r\nret = rockchip_iodomain_write(supply, uV);\r\nif (ret) {\r\nsupply->reg = NULL;\r\ngoto unreg_notify;\r\n}\r\nret = regulator_register_notifier(reg, &supply->nb);\r\nif (ret) {\r\ndev_err(&pdev->dev,\r\n"regulator notifier request failed\n");\r\nsupply->reg = NULL;\r\ngoto unreg_notify;\r\n}\r\n}\r\nif (iod->soc_data->init)\r\niod->soc_data->init(iod);\r\nreturn 0;\r\nunreg_notify:\r\nfor (i = MAX_SUPPLIES - 1; i >= 0; i--) {\r\nstruct rockchip_iodomain_supply *io_supply = &iod->supplies[i];\r\nif (io_supply->reg)\r\nregulator_unregister_notifier(io_supply->reg,\r\n&io_supply->nb);\r\n}\r\nreturn ret;\r\n}\r\nstatic int rockchip_iodomain_remove(struct platform_device *pdev)\r\n{\r\nstruct rockchip_iodomain *iod = platform_get_drvdata(pdev);\r\nint i;\r\nfor (i = MAX_SUPPLIES - 1; i >= 0; i--) {\r\nstruct rockchip_iodomain_supply *io_supply = &iod->supplies[i];\r\nif (io_supply->reg)\r\nregulator_unregister_notifier(io_supply->reg,\r\n&io_supply->nb);\r\n}\r\nreturn 0;\r\n}

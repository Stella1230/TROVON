struct frame_vector *vb2_create_framevec(unsigned long start,\r\nunsigned long length,\r\nbool write)\r\n{\r\nint ret;\r\nunsigned long first, last;\r\nunsigned long nr;\r\nstruct frame_vector *vec;\r\nfirst = start >> PAGE_SHIFT;\r\nlast = (start + length - 1) >> PAGE_SHIFT;\r\nnr = last - first + 1;\r\nvec = frame_vector_create(nr);\r\nif (!vec)\r\nreturn ERR_PTR(-ENOMEM);\r\nret = get_vaddr_frames(start, nr, write, 1, vec);\r\nif (ret < 0)\r\ngoto out_destroy;\r\nif (ret != nr) {\r\nret = -EFAULT;\r\ngoto out_release;\r\n}\r\nreturn vec;\r\nout_release:\r\nput_vaddr_frames(vec);\r\nout_destroy:\r\nframe_vector_destroy(vec);\r\nreturn ERR_PTR(ret);\r\n}\r\nvoid vb2_destroy_framevec(struct frame_vector *vec)\r\n{\r\nput_vaddr_frames(vec);\r\nframe_vector_destroy(vec);\r\n}\r\nstatic void vb2_common_vm_open(struct vm_area_struct *vma)\r\n{\r\nstruct vb2_vmarea_handler *h = vma->vm_private_data;\r\npr_debug("%s: %p, refcount: %d, vma: %08lx-%08lx\n",\r\n__func__, h, atomic_read(h->refcount), vma->vm_start,\r\nvma->vm_end);\r\natomic_inc(h->refcount);\r\n}\r\nstatic void vb2_common_vm_close(struct vm_area_struct *vma)\r\n{\r\nstruct vb2_vmarea_handler *h = vma->vm_private_data;\r\npr_debug("%s: %p, refcount: %d, vma: %08lx-%08lx\n",\r\n__func__, h, atomic_read(h->refcount), vma->vm_start,\r\nvma->vm_end);\r\nh->put(h->arg);\r\n}

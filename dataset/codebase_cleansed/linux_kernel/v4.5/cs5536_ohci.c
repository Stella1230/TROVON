void pci_ohci_write_reg(int reg, u32 value)\r\n{\r\nu32 hi = 0, lo = value;\r\nswitch (reg) {\r\ncase PCI_COMMAND:\r\n_rdmsr(USB_MSR_REG(USB_OHCI), &hi, &lo);\r\nif (value & PCI_COMMAND_MASTER)\r\nhi |= PCI_COMMAND_MASTER;\r\nelse\r\nhi &= ~PCI_COMMAND_MASTER;\r\nif (value & PCI_COMMAND_MEMORY)\r\nhi |= PCI_COMMAND_MEMORY;\r\nelse\r\nhi &= ~PCI_COMMAND_MEMORY;\r\n_wrmsr(USB_MSR_REG(USB_OHCI), hi, lo);\r\nbreak;\r\ncase PCI_STATUS:\r\nif (value & PCI_STATUS_PARITY) {\r\n_rdmsr(SB_MSR_REG(SB_ERROR), &hi, &lo);\r\nif (lo & SB_PARE_ERR_FLAG) {\r\nlo = (lo & 0x0000ffff) | SB_PARE_ERR_FLAG;\r\n_wrmsr(SB_MSR_REG(SB_ERROR), hi, lo);\r\n}\r\n}\r\nbreak;\r\ncase PCI_BAR0_REG:\r\nif (value == PCI_BAR_RANGE_MASK) {\r\n_rdmsr(GLCP_MSR_REG(GLCP_SOFT_COM), &hi, &lo);\r\nlo |= SOFT_BAR_OHCI_FLAG;\r\n_wrmsr(GLCP_MSR_REG(GLCP_SOFT_COM), hi, lo);\r\n} else if ((value & 0x01) == 0x00) {\r\n_rdmsr(USB_MSR_REG(USB_OHCI), &hi, &lo);\r\nlo = value;\r\n_wrmsr(USB_MSR_REG(USB_OHCI), hi, lo);\r\nvalue &= 0xfffffff0;\r\nhi = 0x40000000 | ((value & 0xff000000) >> 24);\r\nlo = 0x000fffff | ((value & 0x00fff000) << 8);\r\n_wrmsr(GLIU_MSR_REG(GLIU_P2D_BM3), hi, lo);\r\n}\r\nbreak;\r\ncase PCI_OHCI_INT_REG:\r\n_rdmsr(DIVIL_MSR_REG(PIC_YSEL_LOW), &hi, &lo);\r\nlo &= ~(0xf << PIC_YSEL_LOW_USB_SHIFT);\r\nif (value)\r\nlo |= (CS5536_USB_INTR << PIC_YSEL_LOW_USB_SHIFT);\r\n_wrmsr(DIVIL_MSR_REG(PIC_YSEL_LOW), hi, lo);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nu32 pci_ohci_read_reg(int reg)\r\n{\r\nu32 conf_data = 0;\r\nu32 hi, lo;\r\nswitch (reg) {\r\ncase PCI_VENDOR_ID:\r\nconf_data =\r\nCFG_PCI_VENDOR_ID(CS5536_OHCI_DEVICE_ID, CS5536_VENDOR_ID);\r\nbreak;\r\ncase PCI_COMMAND:\r\n_rdmsr(USB_MSR_REG(USB_OHCI), &hi, &lo);\r\nif (hi & PCI_COMMAND_MASTER)\r\nconf_data |= PCI_COMMAND_MASTER;\r\nif (hi & PCI_COMMAND_MEMORY)\r\nconf_data |= PCI_COMMAND_MEMORY;\r\nbreak;\r\ncase PCI_STATUS:\r\nconf_data |= PCI_STATUS_66MHZ;\r\nconf_data |= PCI_STATUS_FAST_BACK;\r\n_rdmsr(SB_MSR_REG(SB_ERROR), &hi, &lo);\r\nif (lo & SB_PARE_ERR_FLAG)\r\nconf_data |= PCI_STATUS_PARITY;\r\nconf_data |= PCI_STATUS_DEVSEL_MEDIUM;\r\nbreak;\r\ncase PCI_CLASS_REVISION:\r\n_rdmsr(USB_MSR_REG(USB_CAP), &hi, &lo);\r\nconf_data = lo & 0x000000ff;\r\nconf_data |= (CS5536_OHCI_CLASS_CODE << 8);\r\nbreak;\r\ncase PCI_CACHE_LINE_SIZE:\r\nconf_data =\r\nCFG_PCI_CACHE_LINE_SIZE(PCI_NORMAL_HEADER_TYPE,\r\nPCI_NORMAL_LATENCY_TIMER);\r\nbreak;\r\ncase PCI_BAR0_REG:\r\n_rdmsr(GLCP_MSR_REG(GLCP_SOFT_COM), &hi, &lo);\r\nif (lo & SOFT_BAR_OHCI_FLAG) {\r\nconf_data = CS5536_OHCI_RANGE |\r\nPCI_BASE_ADDRESS_SPACE_MEMORY;\r\nlo &= ~SOFT_BAR_OHCI_FLAG;\r\n_wrmsr(GLCP_MSR_REG(GLCP_SOFT_COM), hi, lo);\r\n} else {\r\n_rdmsr(USB_MSR_REG(USB_OHCI), &hi, &lo);\r\nconf_data = lo & 0xffffff00;\r\nconf_data &= ~0x0000000f;\r\n}\r\nbreak;\r\ncase PCI_CARDBUS_CIS:\r\nconf_data = PCI_CARDBUS_CIS_POINTER;\r\nbreak;\r\ncase PCI_SUBSYSTEM_VENDOR_ID:\r\nconf_data =\r\nCFG_PCI_VENDOR_ID(CS5536_OHCI_SUB_ID, CS5536_SUB_VENDOR_ID);\r\nbreak;\r\ncase PCI_ROM_ADDRESS:\r\nconf_data = PCI_EXPANSION_ROM_BAR;\r\nbreak;\r\ncase PCI_CAPABILITY_LIST:\r\nconf_data = PCI_CAPLIST_USB_POINTER;\r\nbreak;\r\ncase PCI_INTERRUPT_LINE:\r\nconf_data =\r\nCFG_PCI_INTERRUPT_LINE(PCI_DEFAULT_PIN, CS5536_USB_INTR);\r\nbreak;\r\ncase PCI_OHCI_INT_REG:\r\n_rdmsr(DIVIL_MSR_REG(PIC_YSEL_LOW), &hi, &lo);\r\nif ((lo & 0x00000f00) == CS5536_USB_INTR)\r\nconf_data = 1;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn conf_data;\r\n}

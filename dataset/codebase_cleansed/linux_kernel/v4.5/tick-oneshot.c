int tick_program_event(ktime_t expires, int force)\r\n{\r\nstruct clock_event_device *dev = __this_cpu_read(tick_cpu_device.evtdev);\r\nif (unlikely(expires.tv64 == KTIME_MAX)) {\r\nclockevents_switch_state(dev, CLOCK_EVT_STATE_ONESHOT_STOPPED);\r\nreturn 0;\r\n}\r\nif (unlikely(clockevent_state_oneshot_stopped(dev))) {\r\nclockevents_switch_state(dev, CLOCK_EVT_STATE_ONESHOT);\r\n}\r\nreturn clockevents_program_event(dev, expires, force);\r\n}\r\nvoid tick_resume_oneshot(void)\r\n{\r\nstruct clock_event_device *dev = __this_cpu_read(tick_cpu_device.evtdev);\r\nclockevents_switch_state(dev, CLOCK_EVT_STATE_ONESHOT);\r\nclockevents_program_event(dev, ktime_get(), true);\r\n}\r\nvoid tick_setup_oneshot(struct clock_event_device *newdev,\r\nvoid (*handler)(struct clock_event_device *),\r\nktime_t next_event)\r\n{\r\nnewdev->event_handler = handler;\r\nclockevents_switch_state(newdev, CLOCK_EVT_STATE_ONESHOT);\r\nclockevents_program_event(newdev, next_event, true);\r\n}\r\nint tick_switch_to_oneshot(void (*handler)(struct clock_event_device *))\r\n{\r\nstruct tick_device *td = this_cpu_ptr(&tick_cpu_device);\r\nstruct clock_event_device *dev = td->evtdev;\r\nif (!dev || !(dev->features & CLOCK_EVT_FEAT_ONESHOT) ||\r\n!tick_device_is_functional(dev)) {\r\nprintk(KERN_INFO "Clockevents: "\r\n"could not switch to one-shot mode:");\r\nif (!dev) {\r\nprintk(" no tick device\n");\r\n} else {\r\nif (!tick_device_is_functional(dev))\r\nprintk(" %s is not functional.\n", dev->name);\r\nelse\r\nprintk(" %s does not support one-shot mode.\n",\r\ndev->name);\r\n}\r\nreturn -EINVAL;\r\n}\r\ntd->mode = TICKDEV_MODE_ONESHOT;\r\ndev->event_handler = handler;\r\nclockevents_switch_state(dev, CLOCK_EVT_STATE_ONESHOT);\r\ntick_broadcast_switch_to_oneshot();\r\nreturn 0;\r\n}\r\nint tick_oneshot_mode_active(void)\r\n{\r\nunsigned long flags;\r\nint ret;\r\nlocal_irq_save(flags);\r\nret = __this_cpu_read(tick_cpu_device.mode) == TICKDEV_MODE_ONESHOT;\r\nlocal_irq_restore(flags);\r\nreturn ret;\r\n}\r\nint tick_init_highres(void)\r\n{\r\nreturn tick_switch_to_oneshot(hrtimer_interrupt);\r\n}

struct tpm_chip *tpm_chip_find_get(int chip_num)\r\n{\r\nstruct tpm_chip *pos, *chip = NULL;\r\nrcu_read_lock();\r\nlist_for_each_entry_rcu(pos, &tpm_chip_list, list) {\r\nif (chip_num != TPM_ANY_NUM && chip_num != pos->dev_num)\r\ncontinue;\r\nif (try_module_get(pos->pdev->driver->owner)) {\r\nchip = pos;\r\nbreak;\r\n}\r\n}\r\nrcu_read_unlock();\r\nreturn chip;\r\n}\r\nstatic void tpm_dev_release(struct device *dev)\r\n{\r\nstruct tpm_chip *chip = container_of(dev, struct tpm_chip, dev);\r\nspin_lock(&driver_lock);\r\nclear_bit(chip->dev_num, dev_mask);\r\nspin_unlock(&driver_lock);\r\nkfree(chip);\r\n}\r\nstruct tpm_chip *tpmm_chip_alloc(struct device *dev,\r\nconst struct tpm_class_ops *ops)\r\n{\r\nstruct tpm_chip *chip;\r\nchip = kzalloc(sizeof(*chip), GFP_KERNEL);\r\nif (chip == NULL)\r\nreturn ERR_PTR(-ENOMEM);\r\nmutex_init(&chip->tpm_mutex);\r\nINIT_LIST_HEAD(&chip->list);\r\nchip->ops = ops;\r\nspin_lock(&driver_lock);\r\nchip->dev_num = find_first_zero_bit(dev_mask, TPM_NUM_DEVICES);\r\nspin_unlock(&driver_lock);\r\nif (chip->dev_num >= TPM_NUM_DEVICES) {\r\ndev_err(dev, "No available tpm device numbers\n");\r\nkfree(chip);\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nset_bit(chip->dev_num, dev_mask);\r\nscnprintf(chip->devname, sizeof(chip->devname), "tpm%d", chip->dev_num);\r\nchip->pdev = dev;\r\ndev_set_drvdata(dev, chip);\r\nchip->dev.class = tpm_class;\r\nchip->dev.release = tpm_dev_release;\r\nchip->dev.parent = chip->pdev;\r\n#ifdef CONFIG_ACPI\r\nchip->dev.groups = chip->groups;\r\n#endif\r\nif (chip->dev_num == 0)\r\nchip->dev.devt = MKDEV(MISC_MAJOR, TPM_MINOR);\r\nelse\r\nchip->dev.devt = MKDEV(MAJOR(tpm_devt), chip->dev_num);\r\ndev_set_name(&chip->dev, "%s", chip->devname);\r\ndevice_initialize(&chip->dev);\r\ncdev_init(&chip->cdev, &tpm_fops);\r\nchip->cdev.owner = chip->pdev->driver->owner;\r\nchip->cdev.kobj.parent = &chip->dev.kobj;\r\nreturn chip;\r\n}\r\nstatic int tpm_dev_add_device(struct tpm_chip *chip)\r\n{\r\nint rc;\r\nrc = cdev_add(&chip->cdev, chip->dev.devt, 1);\r\nif (rc) {\r\ndev_err(&chip->dev,\r\n"unable to cdev_add() %s, major %d, minor %d, err=%d\n",\r\nchip->devname, MAJOR(chip->dev.devt),\r\nMINOR(chip->dev.devt), rc);\r\ndevice_unregister(&chip->dev);\r\nreturn rc;\r\n}\r\nrc = device_add(&chip->dev);\r\nif (rc) {\r\ndev_err(&chip->dev,\r\n"unable to device_register() %s, major %d, minor %d, err=%d\n",\r\nchip->devname, MAJOR(chip->dev.devt),\r\nMINOR(chip->dev.devt), rc);\r\nreturn rc;\r\n}\r\nreturn rc;\r\n}\r\nstatic void tpm_dev_del_device(struct tpm_chip *chip)\r\n{\r\ncdev_del(&chip->cdev);\r\ndevice_unregister(&chip->dev);\r\n}\r\nstatic int tpm1_chip_register(struct tpm_chip *chip)\r\n{\r\nint rc;\r\nif (chip->flags & TPM_CHIP_FLAG_TPM2)\r\nreturn 0;\r\nrc = tpm_sysfs_add_device(chip);\r\nif (rc)\r\nreturn rc;\r\nchip->bios_dir = tpm_bios_log_setup(chip->devname);\r\nreturn 0;\r\n}\r\nstatic void tpm1_chip_unregister(struct tpm_chip *chip)\r\n{\r\nif (chip->flags & TPM_CHIP_FLAG_TPM2)\r\nreturn;\r\nif (chip->bios_dir)\r\ntpm_bios_log_teardown(chip->bios_dir);\r\ntpm_sysfs_del_device(chip);\r\n}\r\nint tpm_chip_register(struct tpm_chip *chip)\r\n{\r\nint rc;\r\nrc = tpm1_chip_register(chip);\r\nif (rc)\r\nreturn rc;\r\ntpm_add_ppi(chip);\r\nrc = tpm_dev_add_device(chip);\r\nif (rc)\r\ngoto out_err;\r\nspin_lock(&driver_lock);\r\nlist_add_tail_rcu(&chip->list, &tpm_chip_list);\r\nspin_unlock(&driver_lock);\r\nchip->flags |= TPM_CHIP_FLAG_REGISTERED;\r\nif (!(chip->flags & TPM_CHIP_FLAG_TPM2)) {\r\nrc = __compat_only_sysfs_link_entry_to_kobj(&chip->pdev->kobj,\r\n&chip->dev.kobj,\r\n"ppi");\r\nif (rc && rc != -ENOENT) {\r\ntpm_chip_unregister(chip);\r\nreturn rc;\r\n}\r\n}\r\nreturn 0;\r\nout_err:\r\ntpm1_chip_unregister(chip);\r\nreturn rc;\r\n}\r\nvoid tpm_chip_unregister(struct tpm_chip *chip)\r\n{\r\nif (!(chip->flags & TPM_CHIP_FLAG_REGISTERED))\r\nreturn;\r\nspin_lock(&driver_lock);\r\nlist_del_rcu(&chip->list);\r\nspin_unlock(&driver_lock);\r\nsynchronize_rcu();\r\nif (!(chip->flags & TPM_CHIP_FLAG_TPM2))\r\nsysfs_remove_link(&chip->pdev->kobj, "ppi");\r\ntpm1_chip_unregister(chip);\r\ntpm_dev_del_device(chip);\r\n}

void phonet_address_notify(int event, struct net_device *dev, u8 addr)\r\n{\r\nstruct sk_buff *skb;\r\nint err = -ENOBUFS;\r\nskb = nlmsg_new(NLMSG_ALIGN(sizeof(struct ifaddrmsg)) +\r\nnla_total_size(1), GFP_KERNEL);\r\nif (skb == NULL)\r\ngoto errout;\r\nerr = fill_addr(skb, dev, addr, 0, 0, event);\r\nif (err < 0) {\r\nWARN_ON(err == -EMSGSIZE);\r\nkfree_skb(skb);\r\ngoto errout;\r\n}\r\nrtnl_notify(skb, dev_net(dev), 0,\r\nRTNLGRP_PHONET_IFADDR, NULL, GFP_KERNEL);\r\nreturn;\r\nerrout:\r\nrtnl_set_sk_err(dev_net(dev), RTNLGRP_PHONET_IFADDR, err);\r\n}\r\nstatic int addr_doit(struct sk_buff *skb, struct nlmsghdr *nlh)\r\n{\r\nstruct net *net = sock_net(skb->sk);\r\nstruct nlattr *tb[IFA_MAX+1];\r\nstruct net_device *dev;\r\nstruct ifaddrmsg *ifm;\r\nint err;\r\nu8 pnaddr;\r\nif (!netlink_capable(skb, CAP_NET_ADMIN))\r\nreturn -EPERM;\r\nif (!netlink_capable(skb, CAP_SYS_ADMIN))\r\nreturn -EPERM;\r\nASSERT_RTNL();\r\nerr = nlmsg_parse(nlh, sizeof(*ifm), tb, IFA_MAX, ifa_phonet_policy);\r\nif (err < 0)\r\nreturn err;\r\nifm = nlmsg_data(nlh);\r\nif (tb[IFA_LOCAL] == NULL)\r\nreturn -EINVAL;\r\npnaddr = nla_get_u8(tb[IFA_LOCAL]);\r\nif (pnaddr & 3)\r\nreturn -EINVAL;\r\ndev = __dev_get_by_index(net, ifm->ifa_index);\r\nif (dev == NULL)\r\nreturn -ENODEV;\r\nif (nlh->nlmsg_type == RTM_NEWADDR)\r\nerr = phonet_address_add(dev, pnaddr);\r\nelse\r\nerr = phonet_address_del(dev, pnaddr);\r\nif (!err)\r\nphonet_address_notify(nlh->nlmsg_type, dev, pnaddr);\r\nreturn err;\r\n}\r\nstatic int fill_addr(struct sk_buff *skb, struct net_device *dev, u8 addr,\r\nu32 portid, u32 seq, int event)\r\n{\r\nstruct ifaddrmsg *ifm;\r\nstruct nlmsghdr *nlh;\r\nnlh = nlmsg_put(skb, portid, seq, event, sizeof(*ifm), 0);\r\nif (nlh == NULL)\r\nreturn -EMSGSIZE;\r\nifm = nlmsg_data(nlh);\r\nifm->ifa_family = AF_PHONET;\r\nifm->ifa_prefixlen = 0;\r\nifm->ifa_flags = IFA_F_PERMANENT;\r\nifm->ifa_scope = RT_SCOPE_LINK;\r\nifm->ifa_index = dev->ifindex;\r\nif (nla_put_u8(skb, IFA_LOCAL, addr))\r\ngoto nla_put_failure;\r\nnlmsg_end(skb, nlh);\r\nreturn 0;\r\nnla_put_failure:\r\nnlmsg_cancel(skb, nlh);\r\nreturn -EMSGSIZE;\r\n}\r\nstatic int getaddr_dumpit(struct sk_buff *skb, struct netlink_callback *cb)\r\n{\r\nstruct phonet_device_list *pndevs;\r\nstruct phonet_device *pnd;\r\nint dev_idx = 0, dev_start_idx = cb->args[0];\r\nint addr_idx = 0, addr_start_idx = cb->args[1];\r\npndevs = phonet_device_list(sock_net(skb->sk));\r\nrcu_read_lock();\r\nlist_for_each_entry_rcu(pnd, &pndevs->list, list) {\r\nu8 addr;\r\nif (dev_idx > dev_start_idx)\r\naddr_start_idx = 0;\r\nif (dev_idx++ < dev_start_idx)\r\ncontinue;\r\naddr_idx = 0;\r\nfor_each_set_bit(addr, pnd->addrs, 64) {\r\nif (addr_idx++ < addr_start_idx)\r\ncontinue;\r\nif (fill_addr(skb, pnd->netdev, addr << 2,\r\nNETLINK_CB(cb->skb).portid,\r\ncb->nlh->nlmsg_seq, RTM_NEWADDR) < 0)\r\ngoto out;\r\n}\r\n}\r\nout:\r\nrcu_read_unlock();\r\ncb->args[0] = dev_idx;\r\ncb->args[1] = addr_idx;\r\nreturn skb->len;\r\n}\r\nstatic int fill_route(struct sk_buff *skb, struct net_device *dev, u8 dst,\r\nu32 portid, u32 seq, int event)\r\n{\r\nstruct rtmsg *rtm;\r\nstruct nlmsghdr *nlh;\r\nnlh = nlmsg_put(skb, portid, seq, event, sizeof(*rtm), 0);\r\nif (nlh == NULL)\r\nreturn -EMSGSIZE;\r\nrtm = nlmsg_data(nlh);\r\nrtm->rtm_family = AF_PHONET;\r\nrtm->rtm_dst_len = 6;\r\nrtm->rtm_src_len = 0;\r\nrtm->rtm_tos = 0;\r\nrtm->rtm_table = RT_TABLE_MAIN;\r\nrtm->rtm_protocol = RTPROT_STATIC;\r\nrtm->rtm_scope = RT_SCOPE_UNIVERSE;\r\nrtm->rtm_type = RTN_UNICAST;\r\nrtm->rtm_flags = 0;\r\nif (nla_put_u8(skb, RTA_DST, dst) ||\r\nnla_put_u32(skb, RTA_OIF, dev->ifindex))\r\ngoto nla_put_failure;\r\nnlmsg_end(skb, nlh);\r\nreturn 0;\r\nnla_put_failure:\r\nnlmsg_cancel(skb, nlh);\r\nreturn -EMSGSIZE;\r\n}\r\nvoid rtm_phonet_notify(int event, struct net_device *dev, u8 dst)\r\n{\r\nstruct sk_buff *skb;\r\nint err = -ENOBUFS;\r\nskb = nlmsg_new(NLMSG_ALIGN(sizeof(struct ifaddrmsg)) +\r\nnla_total_size(1) + nla_total_size(4), GFP_KERNEL);\r\nif (skb == NULL)\r\ngoto errout;\r\nerr = fill_route(skb, dev, dst, 0, 0, event);\r\nif (err < 0) {\r\nWARN_ON(err == -EMSGSIZE);\r\nkfree_skb(skb);\r\ngoto errout;\r\n}\r\nrtnl_notify(skb, dev_net(dev), 0,\r\nRTNLGRP_PHONET_ROUTE, NULL, GFP_KERNEL);\r\nreturn;\r\nerrout:\r\nrtnl_set_sk_err(dev_net(dev), RTNLGRP_PHONET_ROUTE, err);\r\n}\r\nstatic int route_doit(struct sk_buff *skb, struct nlmsghdr *nlh)\r\n{\r\nstruct net *net = sock_net(skb->sk);\r\nstruct nlattr *tb[RTA_MAX+1];\r\nstruct net_device *dev;\r\nstruct rtmsg *rtm;\r\nint err;\r\nu8 dst;\r\nif (!netlink_capable(skb, CAP_NET_ADMIN))\r\nreturn -EPERM;\r\nif (!netlink_capable(skb, CAP_SYS_ADMIN))\r\nreturn -EPERM;\r\nASSERT_RTNL();\r\nerr = nlmsg_parse(nlh, sizeof(*rtm), tb, RTA_MAX, rtm_phonet_policy);\r\nif (err < 0)\r\nreturn err;\r\nrtm = nlmsg_data(nlh);\r\nif (rtm->rtm_table != RT_TABLE_MAIN || rtm->rtm_type != RTN_UNICAST)\r\nreturn -EINVAL;\r\nif (tb[RTA_DST] == NULL || tb[RTA_OIF] == NULL)\r\nreturn -EINVAL;\r\ndst = nla_get_u8(tb[RTA_DST]);\r\nif (dst & 3)\r\nreturn -EINVAL;\r\ndev = __dev_get_by_index(net, nla_get_u32(tb[RTA_OIF]));\r\nif (dev == NULL)\r\nreturn -ENODEV;\r\nif (nlh->nlmsg_type == RTM_NEWROUTE)\r\nerr = phonet_route_add(dev, dst);\r\nelse\r\nerr = phonet_route_del(dev, dst);\r\nif (!err)\r\nrtm_phonet_notify(nlh->nlmsg_type, dev, dst);\r\nreturn err;\r\n}\r\nstatic int route_dumpit(struct sk_buff *skb, struct netlink_callback *cb)\r\n{\r\nstruct net *net = sock_net(skb->sk);\r\nu8 addr;\r\nrcu_read_lock();\r\nfor (addr = cb->args[0]; addr < 64; addr++) {\r\nstruct net_device *dev = phonet_route_get_rcu(net, addr << 2);\r\nif (!dev)\r\ncontinue;\r\nif (fill_route(skb, dev, addr << 2, NETLINK_CB(cb->skb).portid,\r\ncb->nlh->nlmsg_seq, RTM_NEWROUTE) < 0)\r\ngoto out;\r\n}\r\nout:\r\nrcu_read_unlock();\r\ncb->args[0] = addr;\r\nreturn skb->len;\r\n}\r\nint __init phonet_netlink_register(void)\r\n{\r\nint err = __rtnl_register(PF_PHONET, RTM_NEWADDR, addr_doit,\r\nNULL, NULL);\r\nif (err)\r\nreturn err;\r\n__rtnl_register(PF_PHONET, RTM_DELADDR, addr_doit, NULL, NULL);\r\n__rtnl_register(PF_PHONET, RTM_GETADDR, NULL, getaddr_dumpit, NULL);\r\n__rtnl_register(PF_PHONET, RTM_NEWROUTE, route_doit, NULL, NULL);\r\n__rtnl_register(PF_PHONET, RTM_DELROUTE, route_doit, NULL, NULL);\r\n__rtnl_register(PF_PHONET, RTM_GETROUTE, NULL, route_dumpit, NULL);\r\nreturn 0;\r\n}

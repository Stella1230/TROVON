int __init tx4938_report_pciclk(void)\r\n{\r\nint pciclk = 0;\r\nprintk(KERN_INFO "PCIC --%s PCICLK:",\r\n(__raw_readq(&tx4938_ccfgptr->ccfg) & TX4938_CCFG_PCI66) ?\r\n" PCI66" : "");\r\nif (__raw_readq(&tx4938_ccfgptr->pcfg) & TX4938_PCFG_PCICLKEN_ALL) {\r\nu64 ccfg = __raw_readq(&tx4938_ccfgptr->ccfg);\r\nswitch ((unsigned long)ccfg &\r\nTX4938_CCFG_PCIDIVMODE_MASK) {\r\ncase TX4938_CCFG_PCIDIVMODE_4:\r\npciclk = txx9_cpu_clock / 4; break;\r\ncase TX4938_CCFG_PCIDIVMODE_4_5:\r\npciclk = txx9_cpu_clock * 2 / 9; break;\r\ncase TX4938_CCFG_PCIDIVMODE_5:\r\npciclk = txx9_cpu_clock / 5; break;\r\ncase TX4938_CCFG_PCIDIVMODE_5_5:\r\npciclk = txx9_cpu_clock * 2 / 11; break;\r\ncase TX4938_CCFG_PCIDIVMODE_8:\r\npciclk = txx9_cpu_clock / 8; break;\r\ncase TX4938_CCFG_PCIDIVMODE_9:\r\npciclk = txx9_cpu_clock / 9; break;\r\ncase TX4938_CCFG_PCIDIVMODE_10:\r\npciclk = txx9_cpu_clock / 10; break;\r\ncase TX4938_CCFG_PCIDIVMODE_11:\r\npciclk = txx9_cpu_clock / 11; break;\r\n}\r\nprintk("Internal(%u.%uMHz)",\r\n(pciclk + 50000) / 1000000,\r\n((pciclk + 50000) / 100000) % 10);\r\n} else {\r\nprintk("External");\r\npciclk = -1;\r\n}\r\nprintk("\n");\r\nreturn pciclk;\r\n}\r\nvoid __init tx4938_report_pci1clk(void)\r\n{\r\n__u64 ccfg = __raw_readq(&tx4938_ccfgptr->ccfg);\r\nunsigned int pciclk =\r\ntxx9_gbus_clock / ((ccfg & TX4938_CCFG_PCI1DMD) ? 4 : 2);\r\nprintk(KERN_INFO "PCIC1 -- %sPCICLK:%u.%uMHz\n",\r\n(ccfg & TX4938_CCFG_PCI1_66) ? "PCI66 " : "",\r\n(pciclk + 50000) / 1000000,\r\n((pciclk + 50000) / 100000) % 10);\r\n}\r\nint __init tx4938_pciclk66_setup(void)\r\n{\r\nint pciclk;\r\ntx4938_ccfg_set(TX4938_CCFG_PCI66);\r\nif (__raw_readq(&tx4938_ccfgptr->pcfg) & TX4938_PCFG_PCICLKEN_ALL) {\r\nunsigned int pcidivmode = 0;\r\nu64 ccfg = __raw_readq(&tx4938_ccfgptr->ccfg);\r\npcidivmode = (unsigned long)ccfg &\r\nTX4938_CCFG_PCIDIVMODE_MASK;\r\nswitch (pcidivmode) {\r\ncase TX4938_CCFG_PCIDIVMODE_8:\r\ncase TX4938_CCFG_PCIDIVMODE_4:\r\npcidivmode = TX4938_CCFG_PCIDIVMODE_4;\r\npciclk = txx9_cpu_clock / 4;\r\nbreak;\r\ncase TX4938_CCFG_PCIDIVMODE_9:\r\ncase TX4938_CCFG_PCIDIVMODE_4_5:\r\npcidivmode = TX4938_CCFG_PCIDIVMODE_4_5;\r\npciclk = txx9_cpu_clock * 2 / 9;\r\nbreak;\r\ncase TX4938_CCFG_PCIDIVMODE_10:\r\ncase TX4938_CCFG_PCIDIVMODE_5:\r\npcidivmode = TX4938_CCFG_PCIDIVMODE_5;\r\npciclk = txx9_cpu_clock / 5;\r\nbreak;\r\ncase TX4938_CCFG_PCIDIVMODE_11:\r\ncase TX4938_CCFG_PCIDIVMODE_5_5:\r\ndefault:\r\npcidivmode = TX4938_CCFG_PCIDIVMODE_5_5;\r\npciclk = txx9_cpu_clock * 2 / 11;\r\nbreak;\r\n}\r\ntx4938_ccfg_change(TX4938_CCFG_PCIDIVMODE_MASK,\r\npcidivmode);\r\nprintk(KERN_DEBUG "PCICLK: ccfg:%08lx\n",\r\n(unsigned long)__raw_readq(&tx4938_ccfgptr->ccfg));\r\n} else\r\npciclk = -1;\r\nreturn pciclk;\r\n}\r\nint __init tx4938_pcic1_map_irq(const struct pci_dev *dev, u8 slot)\r\n{\r\nif (get_tx4927_pcicptr(dev->bus->sysdata) == tx4938_pcic1ptr) {\r\nswitch (slot) {\r\ncase TX4927_PCIC_IDSEL_AD_TO_SLOT(31):\r\nif (__raw_readq(&tx4938_ccfgptr->pcfg) &\r\nTX4938_PCFG_ETH0_SEL)\r\nreturn TXX9_IRQ_BASE + TX4938_IR_ETH0;\r\nbreak;\r\ncase TX4927_PCIC_IDSEL_AD_TO_SLOT(30):\r\nif (__raw_readq(&tx4938_ccfgptr->pcfg) &\r\nTX4938_PCFG_ETH1_SEL)\r\nreturn TXX9_IRQ_BASE + TX4938_IR_ETH1;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nreturn -1;\r\n}\r\nvoid __init tx4938_setup_pcierr_irq(void)\r\n{\r\nif (request_irq(TXX9_IRQ_BASE + TX4938_IR_PCIERR,\r\ntx4927_pcierr_interrupt,\r\n0, "PCI error",\r\n(void *)TX4927_PCIC_REG))\r\nprintk(KERN_WARNING "Failed to request irq for PCIERR\n");\r\n}

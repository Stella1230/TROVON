static irqreturn_t altera_ps2_rxint(int irq, void *dev_id)\r\n{\r\nstruct ps2if *ps2if = dev_id;\r\nunsigned int status;\r\nirqreturn_t handled = IRQ_NONE;\r\nwhile ((status = readl(ps2if->base)) & 0xffff0000) {\r\nserio_interrupt(ps2if->io, status & 0xff, 0);\r\nhandled = IRQ_HANDLED;\r\n}\r\nreturn handled;\r\n}\r\nstatic int altera_ps2_write(struct serio *io, unsigned char val)\r\n{\r\nstruct ps2if *ps2if = io->port_data;\r\nwritel(val, ps2if->base);\r\nreturn 0;\r\n}\r\nstatic int altera_ps2_open(struct serio *io)\r\n{\r\nstruct ps2if *ps2if = io->port_data;\r\nwhile (readl(ps2if->base) & 0xffff0000)\r\n;\r\nwritel(1, ps2if->base + 4);\r\nreturn 0;\r\n}\r\nstatic void altera_ps2_close(struct serio *io)\r\n{\r\nstruct ps2if *ps2if = io->port_data;\r\nwritel(0, ps2if->base + 4);\r\n}\r\nstatic int altera_ps2_probe(struct platform_device *pdev)\r\n{\r\nstruct ps2if *ps2if;\r\nstruct resource *res;\r\nstruct serio *serio;\r\nint error, irq;\r\nps2if = devm_kzalloc(&pdev->dev, sizeof(struct ps2if), GFP_KERNEL);\r\nif (!ps2if)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nps2if->base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(ps2if->base))\r\nreturn PTR_ERR(ps2if->base);\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0)\r\nreturn -ENXIO;\r\nerror = devm_request_irq(&pdev->dev, irq, altera_ps2_rxint, 0,\r\npdev->name, ps2if);\r\nif (error) {\r\ndev_err(&pdev->dev, "could not request IRQ %d\n", irq);\r\nreturn error;\r\n}\r\nserio = kzalloc(sizeof(struct serio), GFP_KERNEL);\r\nif (!serio)\r\nreturn -ENOMEM;\r\nserio->id.type = SERIO_8042;\r\nserio->write = altera_ps2_write;\r\nserio->open = altera_ps2_open;\r\nserio->close = altera_ps2_close;\r\nstrlcpy(serio->name, dev_name(&pdev->dev), sizeof(serio->name));\r\nstrlcpy(serio->phys, dev_name(&pdev->dev), sizeof(serio->phys));\r\nserio->port_data = ps2if;\r\nserio->dev.parent = &pdev->dev;\r\nps2if->io = serio;\r\ndev_info(&pdev->dev, "base %p, irq %d\n", ps2if->base, irq);\r\nserio_register_port(ps2if->io);\r\nplatform_set_drvdata(pdev, ps2if);\r\nreturn 0;\r\n}\r\nstatic int altera_ps2_remove(struct platform_device *pdev)\r\n{\r\nstruct ps2if *ps2if = platform_get_drvdata(pdev);\r\nserio_unregister_port(ps2if->io);\r\nreturn 0;\r\n}

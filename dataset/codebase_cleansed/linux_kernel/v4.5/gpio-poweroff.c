static void gpio_poweroff_do_poweroff(void)\r\n{\r\nBUG_ON(!reset_gpio);\r\ngpiod_direction_output(reset_gpio, 1);\r\nmdelay(100);\r\ngpiod_set_value(reset_gpio, 0);\r\nmdelay(100);\r\ngpiod_set_value(reset_gpio, 1);\r\nmdelay(3000);\r\nWARN_ON(1);\r\n}\r\nstatic int gpio_poweroff_probe(struct platform_device *pdev)\r\n{\r\nbool input = false;\r\nenum gpiod_flags flags;\r\nif (pm_power_off != NULL) {\r\ndev_err(&pdev->dev,\r\n"%s: pm_power_off function already registered",\r\n__func__);\r\nreturn -EBUSY;\r\n}\r\ninput = of_property_read_bool(pdev->dev.of_node, "input");\r\nif (input)\r\nflags = GPIOD_IN;\r\nelse\r\nflags = GPIOD_OUT_LOW;\r\nreset_gpio = devm_gpiod_get(&pdev->dev, NULL, flags);\r\nif (IS_ERR(reset_gpio))\r\nreturn PTR_ERR(reset_gpio);\r\npm_power_off = &gpio_poweroff_do_poweroff;\r\nreturn 0;\r\n}\r\nstatic int gpio_poweroff_remove(struct platform_device *pdev)\r\n{\r\nif (pm_power_off == &gpio_poweroff_do_poweroff)\r\npm_power_off = NULL;\r\nreturn 0;\r\n}

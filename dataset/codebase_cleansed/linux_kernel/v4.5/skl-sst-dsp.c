void skl_dsp_set_state_locked(struct sst_dsp *ctx, int state)\r\n{\r\nmutex_lock(&ctx->mutex);\r\nctx->sst_state = state;\r\nmutex_unlock(&ctx->mutex);\r\n}\r\nstatic int skl_dsp_core_set_reset_state(struct sst_dsp *ctx)\r\n{\r\nint ret;\r\nsst_dsp_shim_update_bits_unlocked(ctx,\r\nSKL_ADSP_REG_ADSPCS, SKL_ADSPCS_CRST_MASK,\r\nSKL_ADSPCS_CRST(SKL_DSP_CORES_MASK));\r\nret = sst_dsp_register_poll(ctx,\r\nSKL_ADSP_REG_ADSPCS,\r\nSKL_ADSPCS_CRST_MASK,\r\nSKL_ADSPCS_CRST(SKL_DSP_CORES_MASK),\r\nSKL_DSP_RESET_TO,\r\n"Set reset");\r\nif ((sst_dsp_shim_read_unlocked(ctx, SKL_ADSP_REG_ADSPCS) &\r\nSKL_ADSPCS_CRST(SKL_DSP_CORES_MASK)) !=\r\nSKL_ADSPCS_CRST(SKL_DSP_CORES_MASK)) {\r\ndev_err(ctx->dev, "Set reset state failed\n");\r\nret = -EIO;\r\n}\r\nreturn ret;\r\n}\r\nstatic int skl_dsp_core_unset_reset_state(struct sst_dsp *ctx)\r\n{\r\nint ret;\r\ndev_dbg(ctx->dev, "In %s\n", __func__);\r\nsst_dsp_shim_update_bits_unlocked(ctx, SKL_ADSP_REG_ADSPCS,\r\nSKL_ADSPCS_CRST_MASK, 0);\r\nret = sst_dsp_register_poll(ctx,\r\nSKL_ADSP_REG_ADSPCS,\r\nSKL_ADSPCS_CRST_MASK,\r\n0,\r\nSKL_DSP_RESET_TO,\r\n"Unset reset");\r\nif ((sst_dsp_shim_read_unlocked(ctx, SKL_ADSP_REG_ADSPCS) &\r\nSKL_ADSPCS_CRST(SKL_DSP_CORES_MASK)) != 0) {\r\ndev_err(ctx->dev, "Unset reset state failed\n");\r\nret = -EIO;\r\n}\r\nreturn ret;\r\n}\r\nstatic bool is_skl_dsp_core_enable(struct sst_dsp *ctx)\r\n{\r\nint val;\r\nbool is_enable;\r\nval = sst_dsp_shim_read_unlocked(ctx, SKL_ADSP_REG_ADSPCS);\r\nis_enable = ((val & SKL_ADSPCS_CPA(SKL_DSP_CORES_MASK)) &&\r\n(val & SKL_ADSPCS_SPA(SKL_DSP_CORES_MASK)) &&\r\n!(val & SKL_ADSPCS_CRST(SKL_DSP_CORES_MASK)) &&\r\n!(val & SKL_ADSPCS_CSTALL(SKL_DSP_CORES_MASK)));\r\ndev_dbg(ctx->dev, "DSP core is enabled=%d\n", is_enable);\r\nreturn is_enable;\r\n}\r\nstatic int skl_dsp_reset_core(struct sst_dsp *ctx)\r\n{\r\nsst_dsp_shim_write_unlocked(ctx, SKL_ADSP_REG_ADSPCS,\r\nsst_dsp_shim_read_unlocked(ctx, SKL_ADSP_REG_ADSPCS) &\r\nSKL_ADSPCS_CSTALL(SKL_DSP_CORES_MASK));\r\nreturn skl_dsp_core_set_reset_state(ctx);\r\n}\r\nstatic int skl_dsp_start_core(struct sst_dsp *ctx)\r\n{\r\nint ret;\r\nret = skl_dsp_core_unset_reset_state(ctx);\r\nif (ret < 0) {\r\ndev_dbg(ctx->dev, "dsp unset reset fails\n");\r\nreturn ret;\r\n}\r\ndev_dbg(ctx->dev, "run core...\n");\r\nsst_dsp_shim_write_unlocked(ctx, SKL_ADSP_REG_ADSPCS,\r\nsst_dsp_shim_read_unlocked(ctx, SKL_ADSP_REG_ADSPCS) &\r\n~SKL_ADSPCS_CSTALL(SKL_DSP_CORES_MASK));\r\nif (!is_skl_dsp_core_enable(ctx)) {\r\nskl_dsp_reset_core(ctx);\r\ndev_err(ctx->dev, "DSP core enable failed\n");\r\nret = -EIO;\r\n}\r\nreturn ret;\r\n}\r\nstatic int skl_dsp_core_power_up(struct sst_dsp *ctx)\r\n{\r\nint ret;\r\nsst_dsp_shim_update_bits_unlocked(ctx, SKL_ADSP_REG_ADSPCS,\r\nSKL_ADSPCS_SPA_MASK, SKL_ADSPCS_SPA(SKL_DSP_CORES_MASK));\r\nret = sst_dsp_register_poll(ctx,\r\nSKL_ADSP_REG_ADSPCS,\r\nSKL_ADSPCS_CPA_MASK,\r\nSKL_ADSPCS_CPA(SKL_DSP_CORES_MASK),\r\nSKL_DSP_PU_TO,\r\n"Power up");\r\nif ((sst_dsp_shim_read_unlocked(ctx, SKL_ADSP_REG_ADSPCS) &\r\nSKL_ADSPCS_CPA(SKL_DSP_CORES_MASK)) !=\r\nSKL_ADSPCS_CPA(SKL_DSP_CORES_MASK)) {\r\ndev_err(ctx->dev, "DSP core power up failed\n");\r\nret = -EIO;\r\n}\r\nreturn ret;\r\n}\r\nstatic int skl_dsp_core_power_down(struct sst_dsp *ctx)\r\n{\r\nsst_dsp_shim_update_bits_unlocked(ctx, SKL_ADSP_REG_ADSPCS,\r\nSKL_ADSPCS_SPA_MASK, 0);\r\nreturn sst_dsp_register_poll(ctx,\r\nSKL_ADSP_REG_ADSPCS,\r\nSKL_ADSPCS_CPA_MASK,\r\n0,\r\nSKL_DSP_PD_TO,\r\n"Power down");\r\n}\r\nstatic int skl_dsp_enable_core(struct sst_dsp *ctx)\r\n{\r\nint ret;\r\nret = skl_dsp_core_power_up(ctx);\r\nif (ret < 0) {\r\ndev_dbg(ctx->dev, "dsp core power up failed\n");\r\nreturn ret;\r\n}\r\nreturn skl_dsp_start_core(ctx);\r\n}\r\nint skl_dsp_disable_core(struct sst_dsp *ctx)\r\n{\r\nint ret;\r\nret = skl_dsp_reset_core(ctx);\r\nif (ret < 0) {\r\ndev_err(ctx->dev, "dsp core reset failed\n");\r\nreturn ret;\r\n}\r\nret = skl_dsp_core_power_down(ctx);\r\nif (ret < 0) {\r\ndev_err(ctx->dev, "dsp core power down failed\n");\r\nreturn ret;\r\n}\r\nif (is_skl_dsp_core_enable(ctx)) {\r\ndev_err(ctx->dev, "DSP core disable failed\n");\r\nret = -EIO;\r\n}\r\nreturn ret;\r\n}\r\nint skl_dsp_boot(struct sst_dsp *ctx)\r\n{\r\nint ret;\r\nif (is_skl_dsp_core_enable(ctx)) {\r\ndev_dbg(ctx->dev, "dsp core is already enabled, so reset the dap core\n");\r\nret = skl_dsp_reset_core(ctx);\r\nif (ret < 0) {\r\ndev_err(ctx->dev, "dsp reset failed\n");\r\nreturn ret;\r\n}\r\nret = skl_dsp_start_core(ctx);\r\nif (ret < 0) {\r\ndev_err(ctx->dev, "dsp start failed\n");\r\nreturn ret;\r\n}\r\n} else {\r\ndev_dbg(ctx->dev, "disable and enable to make sure DSP is invalid state\n");\r\nret = skl_dsp_disable_core(ctx);\r\nif (ret < 0) {\r\ndev_err(ctx->dev, "dsp disable core failes\n");\r\nreturn ret;\r\n}\r\nret = skl_dsp_enable_core(ctx);\r\n}\r\nreturn ret;\r\n}\r\nirqreturn_t skl_dsp_sst_interrupt(int irq, void *dev_id)\r\n{\r\nstruct sst_dsp *ctx = dev_id;\r\nu32 val;\r\nirqreturn_t result = IRQ_NONE;\r\nspin_lock(&ctx->spinlock);\r\nval = sst_dsp_shim_read_unlocked(ctx, SKL_ADSP_REG_ADSPIS);\r\nctx->intr_status = val;\r\nif (val == 0xffffffff) {\r\nspin_unlock(&ctx->spinlock);\r\nreturn IRQ_NONE;\r\n}\r\nif (val & SKL_ADSPIS_IPC) {\r\nskl_ipc_int_disable(ctx);\r\nresult = IRQ_WAKE_THREAD;\r\n}\r\nif (val & SKL_ADSPIS_CL_DMA) {\r\nskl_cldma_int_disable(ctx);\r\nresult = IRQ_WAKE_THREAD;\r\n}\r\nspin_unlock(&ctx->spinlock);\r\nreturn result;\r\n}\r\nint skl_dsp_wake(struct sst_dsp *ctx)\r\n{\r\nreturn ctx->fw_ops.set_state_D0(ctx);\r\n}\r\nint skl_dsp_sleep(struct sst_dsp *ctx)\r\n{\r\nreturn ctx->fw_ops.set_state_D3(ctx);\r\n}\r\nstruct sst_dsp *skl_dsp_ctx_init(struct device *dev,\r\nstruct sst_dsp_device *sst_dev, int irq)\r\n{\r\nint ret;\r\nstruct sst_dsp *sst;\r\nsst = devm_kzalloc(dev, sizeof(*sst), GFP_KERNEL);\r\nif (sst == NULL)\r\nreturn NULL;\r\nspin_lock_init(&sst->spinlock);\r\nmutex_init(&sst->mutex);\r\nsst->dev = dev;\r\nsst->sst_dev = sst_dev;\r\nsst->irq = irq;\r\nsst->ops = sst_dev->ops;\r\nsst->thread_context = sst_dev->thread_context;\r\nif (sst->ops->init) {\r\nret = sst->ops->init(sst, NULL);\r\nif (ret < 0)\r\nreturn NULL;\r\n}\r\nret = request_threaded_irq(sst->irq, sst->ops->irq_handler,\r\nsst_dev->thread, IRQF_SHARED, "AudioDSP", sst);\r\nif (ret) {\r\ndev_err(sst->dev, "unable to grab threaded IRQ %d, disabling device\n",\r\nsst->irq);\r\nreturn NULL;\r\n}\r\nreturn sst;\r\n}\r\nvoid skl_dsp_free(struct sst_dsp *dsp)\r\n{\r\nskl_ipc_int_disable(dsp);\r\nfree_irq(dsp->irq, dsp);\r\nskl_dsp_disable_core(dsp);\r\n}\r\nbool is_skl_dsp_running(struct sst_dsp *ctx)\r\n{\r\nreturn (ctx->sst_state == SKL_DSP_RUNNING);\r\n}

static void wdt_timer_ping(unsigned long data)\r\n{\r\nchar tmp;\r\nif (time_before(jiffies, next_heartbeat)) {\r\npci_read_config_byte(alim7101_pmu, 0x92, &tmp);\r\npci_write_config_byte(alim7101_pmu,\r\nALI_7101_WDT, (tmp & ~ALI_WDT_ARM));\r\npci_write_config_byte(alim7101_pmu,\r\nALI_7101_WDT, (tmp | ALI_WDT_ARM));\r\nif (use_gpio) {\r\npci_read_config_byte(alim7101_pmu,\r\nALI_7101_GPIO_O, &tmp);\r\npci_write_config_byte(alim7101_pmu,\r\nALI_7101_GPIO_O, tmp | 0x20);\r\npci_write_config_byte(alim7101_pmu,\r\nALI_7101_GPIO_O, tmp & ~0x20);\r\n}\r\n} else {\r\npr_warn("Heartbeat lost! Will not ping the watchdog\n");\r\n}\r\nmod_timer(&timer, jiffies + WDT_INTERVAL);\r\n}\r\nstatic void wdt_change(int writeval)\r\n{\r\nchar tmp;\r\npci_read_config_byte(alim7101_pmu, ALI_7101_WDT, &tmp);\r\nif (writeval == WDT_ENABLE) {\r\npci_write_config_byte(alim7101_pmu,\r\nALI_7101_WDT, (tmp | ALI_WDT_ARM));\r\nif (use_gpio) {\r\npci_read_config_byte(alim7101_pmu,\r\nALI_7101_GPIO_O, &tmp);\r\npci_write_config_byte(alim7101_pmu,\r\nALI_7101_GPIO_O, tmp & ~0x20);\r\n}\r\n} else {\r\npci_write_config_byte(alim7101_pmu,\r\nALI_7101_WDT, (tmp & ~ALI_WDT_ARM));\r\nif (use_gpio) {\r\npci_read_config_byte(alim7101_pmu,\r\nALI_7101_GPIO_O, &tmp);\r\npci_write_config_byte(alim7101_pmu,\r\nALI_7101_GPIO_O, tmp | 0x20);\r\n}\r\n}\r\n}\r\nstatic void wdt_startup(void)\r\n{\r\nnext_heartbeat = jiffies + (timeout * HZ);\r\nwdt_change(WDT_ENABLE);\r\nmod_timer(&timer, jiffies + WDT_INTERVAL);\r\npr_info("Watchdog timer is now enabled\n");\r\n}\r\nstatic void wdt_turnoff(void)\r\n{\r\ndel_timer_sync(&timer);\r\nwdt_change(WDT_DISABLE);\r\npr_info("Watchdog timer is now disabled...\n");\r\n}\r\nstatic void wdt_keepalive(void)\r\n{\r\nnext_heartbeat = jiffies + (timeout * HZ);\r\n}\r\nstatic ssize_t fop_write(struct file *file, const char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nif (count) {\r\nif (!nowayout) {\r\nsize_t ofs;\r\nwdt_expect_close = 0;\r\nfor (ofs = 0; ofs != count; ofs++) {\r\nchar c;\r\nif (get_user(c, buf + ofs))\r\nreturn -EFAULT;\r\nif (c == 'V')\r\nwdt_expect_close = 42;\r\n}\r\n}\r\nwdt_keepalive();\r\n}\r\nreturn count;\r\n}\r\nstatic int fop_open(struct inode *inode, struct file *file)\r\n{\r\nif (test_and_set_bit(0, &wdt_is_open))\r\nreturn -EBUSY;\r\nwdt_startup();\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic int fop_close(struct inode *inode, struct file *file)\r\n{\r\nif (wdt_expect_close == 42)\r\nwdt_turnoff();\r\nelse {\r\npr_crit("device file closed unexpectedly. Will not stop the WDT!\n");\r\n}\r\nclear_bit(0, &wdt_is_open);\r\nwdt_expect_close = 0;\r\nreturn 0;\r\n}\r\nstatic long fop_ioctl(struct file *file, unsigned int cmd, unsigned long arg)\r\n{\r\nvoid __user *argp = (void __user *)arg;\r\nint __user *p = argp;\r\nstatic const struct watchdog_info ident = {\r\n.options = WDIOF_KEEPALIVEPING | WDIOF_SETTIMEOUT\r\n| WDIOF_MAGICCLOSE,\r\n.firmware_version = 1,\r\n.identity = "ALiM7101",\r\n};\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nreturn copy_to_user(argp, &ident, sizeof(ident)) ? -EFAULT : 0;\r\ncase WDIOC_GETSTATUS:\r\ncase WDIOC_GETBOOTSTATUS:\r\nreturn put_user(0, p);\r\ncase WDIOC_SETOPTIONS:\r\n{\r\nint new_options, retval = -EINVAL;\r\nif (get_user(new_options, p))\r\nreturn -EFAULT;\r\nif (new_options & WDIOS_DISABLECARD) {\r\nwdt_turnoff();\r\nretval = 0;\r\n}\r\nif (new_options & WDIOS_ENABLECARD) {\r\nwdt_startup();\r\nretval = 0;\r\n}\r\nreturn retval;\r\n}\r\ncase WDIOC_KEEPALIVE:\r\nwdt_keepalive();\r\nreturn 0;\r\ncase WDIOC_SETTIMEOUT:\r\n{\r\nint new_timeout;\r\nif (get_user(new_timeout, p))\r\nreturn -EFAULT;\r\nif (new_timeout < 1 || new_timeout > 3600)\r\nreturn -EINVAL;\r\ntimeout = new_timeout;\r\nwdt_keepalive();\r\n}\r\ncase WDIOC_GETTIMEOUT:\r\nreturn put_user(timeout, p);\r\ndefault:\r\nreturn -ENOTTY;\r\n}\r\n}\r\nstatic int wdt_restart_handle(struct notifier_block *this, unsigned long mode,\r\nvoid *cmd)\r\n{\r\nwdt_change(WDT_ENABLE);\r\nwhile (true)\r\n;\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int wdt_notify_sys(struct notifier_block *this,\r\nunsigned long code, void *unused)\r\n{\r\nif (code == SYS_DOWN || code == SYS_HALT)\r\nwdt_turnoff();\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic void __exit alim7101_wdt_unload(void)\r\n{\r\nwdt_turnoff();\r\nmisc_deregister(&wdt_miscdev);\r\nunregister_reboot_notifier(&wdt_notifier);\r\nunregister_restart_handler(&wdt_restart_handler);\r\npci_dev_put(alim7101_pmu);\r\n}\r\nstatic int __init alim7101_wdt_init(void)\r\n{\r\nint rc = -EBUSY;\r\nstruct pci_dev *ali1543_south;\r\nchar tmp;\r\npr_info("Steve Hill <steve@navaho.co.uk>\n");\r\nalim7101_pmu = pci_get_device(PCI_VENDOR_ID_AL, PCI_DEVICE_ID_AL_M7101,\r\nNULL);\r\nif (!alim7101_pmu) {\r\npr_info("ALi M7101 PMU not present - WDT not set\n");\r\nreturn -EBUSY;\r\n}\r\npci_write_config_byte(alim7101_pmu, ALI_7101_WDT, 0x02);\r\nali1543_south = pci_get_device(PCI_VENDOR_ID_AL, PCI_DEVICE_ID_AL_M1533,\r\nNULL);\r\nif (!ali1543_south) {\r\npr_info("ALi 1543 South-Bridge not present - WDT not set\n");\r\ngoto err_out;\r\n}\r\npci_read_config_byte(ali1543_south, 0x5e, &tmp);\r\npci_dev_put(ali1543_south);\r\nif ((tmp & 0x1e) == 0x00) {\r\nif (!use_gpio) {\r\npr_info("Detected old alim7101 revision 'a1d'. If this is a cobalt board, set the 'use_gpio' module parameter.\n");\r\ngoto err_out;\r\n}\r\nnowayout = 1;\r\n} else if ((tmp & 0x1e) != 0x12 && (tmp & 0x1e) != 0x00) {\r\npr_info("ALi 1543 South-Bridge does not have the correct revision number (???1001?) - WDT not set\n");\r\ngoto err_out;\r\n}\r\nif (timeout < 1 || timeout > 3600) {\r\ntimeout = WATCHDOG_TIMEOUT;\r\npr_info("timeout value must be 1 <= x <= 3600, using %d\n",\r\ntimeout);\r\n}\r\nrc = register_reboot_notifier(&wdt_notifier);\r\nif (rc) {\r\npr_err("cannot register reboot notifier (err=%d)\n", rc);\r\ngoto err_out;\r\n}\r\nrc = register_restart_handler(&wdt_restart_handler);\r\nif (rc) {\r\npr_err("cannot register restart handler (err=%d)\n", rc);\r\ngoto err_out_reboot;\r\n}\r\nrc = misc_register(&wdt_miscdev);\r\nif (rc) {\r\npr_err("cannot register miscdev on minor=%d (err=%d)\n",\r\nwdt_miscdev.minor, rc);\r\ngoto err_out_restart;\r\n}\r\nif (nowayout)\r\n__module_get(THIS_MODULE);\r\npr_info("WDT driver for ALi M7101 initialised. timeout=%d sec (nowayout=%d)\n",\r\ntimeout, nowayout);\r\nreturn 0;\r\nerr_out_restart:\r\nunregister_restart_handler(&wdt_restart_handler);\r\nerr_out_reboot:\r\nunregister_reboot_notifier(&wdt_notifier);\r\nerr_out:\r\npci_dev_put(alim7101_pmu);\r\nreturn rc;\r\n}

static int regmap_atmel_hlcdc_reg_write(void *context, unsigned int reg,\r\nunsigned int val)\r\n{\r\nstruct atmel_hlcdc_regmap *hregmap = context;\r\nif (reg <= ATMEL_HLCDC_DIS) {\r\nu32 status;\r\nreadl_poll_timeout(hregmap->regs + ATMEL_HLCDC_SR, status,\r\n!(status & ATMEL_HLCDC_SIP), 1, 100);\r\n}\r\nwritel(val, hregmap->regs + reg);\r\nreturn 0;\r\n}\r\nstatic int regmap_atmel_hlcdc_reg_read(void *context, unsigned int reg,\r\nunsigned int *val)\r\n{\r\nstruct atmel_hlcdc_regmap *hregmap = context;\r\n*val = readl(hregmap->regs + reg);\r\nreturn 0;\r\n}\r\nstatic int atmel_hlcdc_probe(struct platform_device *pdev)\r\n{\r\nstruct atmel_hlcdc_regmap *hregmap;\r\nstruct device *dev = &pdev->dev;\r\nstruct atmel_hlcdc *hlcdc;\r\nstruct resource *res;\r\nhregmap = devm_kzalloc(dev, sizeof(*hregmap), GFP_KERNEL);\r\nif (!hregmap)\r\nreturn -ENOMEM;\r\nhlcdc = devm_kzalloc(dev, sizeof(*hlcdc), GFP_KERNEL);\r\nif (!hlcdc)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nhregmap->regs = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(hregmap->regs))\r\nreturn PTR_ERR(hregmap->regs);\r\nhlcdc->irq = platform_get_irq(pdev, 0);\r\nif (hlcdc->irq < 0)\r\nreturn hlcdc->irq;\r\nhlcdc->periph_clk = devm_clk_get(dev, "periph_clk");\r\nif (IS_ERR(hlcdc->periph_clk)) {\r\ndev_err(dev, "failed to get peripheral clock\n");\r\nreturn PTR_ERR(hlcdc->periph_clk);\r\n}\r\nhlcdc->sys_clk = devm_clk_get(dev, "sys_clk");\r\nif (IS_ERR(hlcdc->sys_clk)) {\r\ndev_err(dev, "failed to get system clock\n");\r\nreturn PTR_ERR(hlcdc->sys_clk);\r\n}\r\nhlcdc->slow_clk = devm_clk_get(dev, "slow_clk");\r\nif (IS_ERR(hlcdc->slow_clk)) {\r\ndev_err(dev, "failed to get slow clock\n");\r\nreturn PTR_ERR(hlcdc->slow_clk);\r\n}\r\nhlcdc->regmap = devm_regmap_init(dev, NULL, hregmap,\r\n&atmel_hlcdc_regmap_config);\r\nif (IS_ERR(hlcdc->regmap))\r\nreturn PTR_ERR(hlcdc->regmap);\r\ndev_set_drvdata(dev, hlcdc);\r\nreturn mfd_add_devices(dev, -1, atmel_hlcdc_cells,\r\nARRAY_SIZE(atmel_hlcdc_cells),\r\nNULL, 0, NULL);\r\n}\r\nstatic int atmel_hlcdc_remove(struct platform_device *pdev)\r\n{\r\nmfd_remove_devices(&pdev->dev);\r\nreturn 0;\r\n}

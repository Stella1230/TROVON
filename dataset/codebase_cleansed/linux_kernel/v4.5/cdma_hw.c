static void push_buffer_init(struct push_buffer *pb)\r\n{\r\n*(u32 *)(pb->mapped + pb->size_bytes) = host1x_opcode_restart(0);\r\n}\r\nstatic void cdma_timeout_cpu_incr(struct host1x_cdma *cdma, u32 getptr,\r\nu32 syncpt_incrs, u32 syncval, u32 nr_slots)\r\n{\r\nstruct host1x *host1x = cdma_to_host1x(cdma);\r\nstruct push_buffer *pb = &cdma->push_buffer;\r\nu32 i;\r\nfor (i = 0; i < syncpt_incrs; i++)\r\nhost1x_syncpt_incr(cdma->timeout.syncpt);\r\nhost1x_syncpt_load(cdma->timeout.syncpt);\r\nwhile (nr_slots--) {\r\nu32 *p = (u32 *)(pb->mapped + getptr);\r\n*(p++) = HOST1X_OPCODE_NOP;\r\n*(p++) = HOST1X_OPCODE_NOP;\r\ndev_dbg(host1x->dev, "%s: NOP at %pad+%#x\n", __func__,\r\n&pb->phys, getptr);\r\ngetptr = (getptr + 8) & (pb->size_bytes - 1);\r\n}\r\nwmb();\r\n}\r\nstatic void cdma_start(struct host1x_cdma *cdma)\r\n{\r\nstruct host1x_channel *ch = cdma_to_channel(cdma);\r\nif (cdma->running)\r\nreturn;\r\ncdma->last_pos = cdma->push_buffer.pos;\r\nhost1x_ch_writel(ch, HOST1X_CHANNEL_DMACTRL_DMASTOP,\r\nHOST1X_CHANNEL_DMACTRL);\r\nhost1x_ch_writel(ch, cdma->push_buffer.phys, HOST1X_CHANNEL_DMASTART);\r\nhost1x_ch_writel(ch, cdma->push_buffer.pos, HOST1X_CHANNEL_DMAPUT);\r\nhost1x_ch_writel(ch, cdma->push_buffer.phys +\r\ncdma->push_buffer.size_bytes + 4,\r\nHOST1X_CHANNEL_DMAEND);\r\nhost1x_ch_writel(ch, HOST1X_CHANNEL_DMACTRL_DMASTOP |\r\nHOST1X_CHANNEL_DMACTRL_DMAGETRST |\r\nHOST1X_CHANNEL_DMACTRL_DMAINITGET,\r\nHOST1X_CHANNEL_DMACTRL);\r\nhost1x_ch_writel(ch, 0, HOST1X_CHANNEL_DMACTRL);\r\ncdma->running = true;\r\n}\r\nstatic void cdma_timeout_restart(struct host1x_cdma *cdma, u32 getptr)\r\n{\r\nstruct host1x *host1x = cdma_to_host1x(cdma);\r\nstruct host1x_channel *ch = cdma_to_channel(cdma);\r\nif (cdma->running)\r\nreturn;\r\ncdma->last_pos = cdma->push_buffer.pos;\r\nhost1x_ch_writel(ch, HOST1X_CHANNEL_DMACTRL_DMASTOP,\r\nHOST1X_CHANNEL_DMACTRL);\r\nhost1x_ch_writel(ch, cdma->push_buffer.phys, HOST1X_CHANNEL_DMASTART);\r\nhost1x_ch_writel(ch, cdma->push_buffer.phys +\r\ncdma->push_buffer.size_bytes,\r\nHOST1X_CHANNEL_DMAEND);\r\nhost1x_ch_writel(ch, getptr, HOST1X_CHANNEL_DMAPUT);\r\nhost1x_ch_writel(ch, HOST1X_CHANNEL_DMACTRL_DMASTOP |\r\nHOST1X_CHANNEL_DMACTRL_DMAGETRST |\r\nHOST1X_CHANNEL_DMACTRL_DMAINITGET,\r\nHOST1X_CHANNEL_DMACTRL);\r\ndev_dbg(host1x->dev,\r\n"%s: DMA GET 0x%x, PUT HW 0x%x / shadow 0x%x\n", __func__,\r\nhost1x_ch_readl(ch, HOST1X_CHANNEL_DMAGET),\r\nhost1x_ch_readl(ch, HOST1X_CHANNEL_DMAPUT),\r\ncdma->last_pos);\r\nhost1x_ch_writel(ch, HOST1X_CHANNEL_DMACTRL_DMASTOP,\r\nHOST1X_CHANNEL_DMACTRL);\r\nhost1x_ch_writel(ch, cdma->push_buffer.pos, HOST1X_CHANNEL_DMAPUT);\r\nhost1x_ch_writel(ch, 0, HOST1X_CHANNEL_DMACTRL);\r\ncdma->running = true;\r\n}\r\nstatic void cdma_flush(struct host1x_cdma *cdma)\r\n{\r\nstruct host1x_channel *ch = cdma_to_channel(cdma);\r\nif (cdma->push_buffer.pos != cdma->last_pos) {\r\nhost1x_ch_writel(ch, cdma->push_buffer.pos,\r\nHOST1X_CHANNEL_DMAPUT);\r\ncdma->last_pos = cdma->push_buffer.pos;\r\n}\r\n}\r\nstatic void cdma_stop(struct host1x_cdma *cdma)\r\n{\r\nstruct host1x_channel *ch = cdma_to_channel(cdma);\r\nmutex_lock(&cdma->lock);\r\nif (cdma->running) {\r\nhost1x_cdma_wait_locked(cdma, CDMA_EVENT_SYNC_QUEUE_EMPTY);\r\nhost1x_ch_writel(ch, HOST1X_CHANNEL_DMACTRL_DMASTOP,\r\nHOST1X_CHANNEL_DMACTRL);\r\ncdma->running = false;\r\n}\r\nmutex_unlock(&cdma->lock);\r\n}\r\nstatic void cdma_freeze(struct host1x_cdma *cdma)\r\n{\r\nstruct host1x *host = cdma_to_host1x(cdma);\r\nstruct host1x_channel *ch = cdma_to_channel(cdma);\r\nu32 cmdproc_stop;\r\nif (cdma->torndown && !cdma->running) {\r\ndev_warn(host->dev, "Already torn down\n");\r\nreturn;\r\n}\r\ndev_dbg(host->dev, "freezing channel (id %d)\n", ch->id);\r\ncmdproc_stop = host1x_sync_readl(host, HOST1X_SYNC_CMDPROC_STOP);\r\ncmdproc_stop |= BIT(ch->id);\r\nhost1x_sync_writel(host, cmdproc_stop, HOST1X_SYNC_CMDPROC_STOP);\r\ndev_dbg(host->dev, "%s: DMA GET 0x%x, PUT HW 0x%x / shadow 0x%x\n",\r\n__func__, host1x_ch_readl(ch, HOST1X_CHANNEL_DMAGET),\r\nhost1x_ch_readl(ch, HOST1X_CHANNEL_DMAPUT),\r\ncdma->last_pos);\r\nhost1x_ch_writel(ch, HOST1X_CHANNEL_DMACTRL_DMASTOP,\r\nHOST1X_CHANNEL_DMACTRL);\r\nhost1x_sync_writel(host, BIT(ch->id), HOST1X_SYNC_CH_TEARDOWN);\r\ncdma->running = false;\r\ncdma->torndown = true;\r\n}\r\nstatic void cdma_resume(struct host1x_cdma *cdma, u32 getptr)\r\n{\r\nstruct host1x *host1x = cdma_to_host1x(cdma);\r\nstruct host1x_channel *ch = cdma_to_channel(cdma);\r\nu32 cmdproc_stop;\r\ndev_dbg(host1x->dev,\r\n"resuming channel (id %d, DMAGET restart = 0x%x)\n",\r\nch->id, getptr);\r\ncmdproc_stop = host1x_sync_readl(host1x, HOST1X_SYNC_CMDPROC_STOP);\r\ncmdproc_stop &= ~(BIT(ch->id));\r\nhost1x_sync_writel(host1x, cmdproc_stop, HOST1X_SYNC_CMDPROC_STOP);\r\ncdma->torndown = false;\r\ncdma_timeout_restart(cdma, getptr);\r\n}\r\nstatic void cdma_timeout_handler(struct work_struct *work)\r\n{\r\nstruct host1x_cdma *cdma;\r\nstruct host1x *host1x;\r\nstruct host1x_channel *ch;\r\nu32 syncpt_val;\r\nu32 prev_cmdproc, cmdproc_stop;\r\ncdma = container_of(to_delayed_work(work), struct host1x_cdma,\r\ntimeout.wq);\r\nhost1x = cdma_to_host1x(cdma);\r\nch = cdma_to_channel(cdma);\r\nhost1x_debug_dump(cdma_to_host1x(cdma));\r\nmutex_lock(&cdma->lock);\r\nif (!cdma->timeout.client) {\r\ndev_dbg(host1x->dev,\r\n"cdma_timeout: expired, but has no clientid\n");\r\nmutex_unlock(&cdma->lock);\r\nreturn;\r\n}\r\nprev_cmdproc = host1x_sync_readl(host1x, HOST1X_SYNC_CMDPROC_STOP);\r\ncmdproc_stop = prev_cmdproc | BIT(ch->id);\r\nhost1x_sync_writel(host1x, cmdproc_stop, HOST1X_SYNC_CMDPROC_STOP);\r\ndev_dbg(host1x->dev, "cdma_timeout: cmdproc was 0x%x is 0x%x\n",\r\nprev_cmdproc, cmdproc_stop);\r\nsyncpt_val = host1x_syncpt_load(cdma->timeout.syncpt);\r\nif ((s32)(syncpt_val - cdma->timeout.syncpt_val) >= 0) {\r\ndev_dbg(host1x->dev,\r\n"cdma_timeout: expired, but buffer had completed\n");\r\ncmdproc_stop = prev_cmdproc & ~(BIT(ch->id));\r\nhost1x_sync_writel(host1x, cmdproc_stop,\r\nHOST1X_SYNC_CMDPROC_STOP);\r\nmutex_unlock(&cdma->lock);\r\nreturn;\r\n}\r\ndev_warn(host1x->dev, "%s: timeout: %d (%s), HW thresh %d, done %d\n",\r\n__func__, cdma->timeout.syncpt->id, cdma->timeout.syncpt->name,\r\nsyncpt_val, cdma->timeout.syncpt_val);\r\nhost1x_hw_cdma_freeze(host1x, cdma);\r\nhost1x_cdma_update_sync_queue(cdma, ch->dev);\r\nmutex_unlock(&cdma->lock);\r\n}\r\nstatic int cdma_timeout_init(struct host1x_cdma *cdma, u32 syncpt_id)\r\n{\r\nINIT_DELAYED_WORK(&cdma->timeout.wq, cdma_timeout_handler);\r\ncdma->timeout.initialized = true;\r\nreturn 0;\r\n}\r\nstatic void cdma_timeout_destroy(struct host1x_cdma *cdma)\r\n{\r\nif (cdma->timeout.initialized)\r\ncancel_delayed_work(&cdma->timeout.wq);\r\ncdma->timeout.initialized = false;\r\n}

static inline void pcf2123_delay_trec(void)\r\n{\r\nndelay(30);\r\n}\r\nstatic ssize_t pcf2123_show(struct device *dev, struct device_attribute *attr,\r\nchar *buffer)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nstruct pcf2123_sysfs_reg *r;\r\nu8 txbuf[1], rxbuf[1];\r\nunsigned long reg;\r\nint ret;\r\nr = container_of(attr, struct pcf2123_sysfs_reg, attr);\r\nret = kstrtoul(r->name, 16, &reg);\r\nif (ret)\r\nreturn ret;\r\ntxbuf[0] = PCF2123_READ | reg;\r\nret = spi_write_then_read(spi, txbuf, 1, rxbuf, 1);\r\nif (ret < 0)\r\nreturn -EIO;\r\npcf2123_delay_trec();\r\nreturn sprintf(buffer, "0x%x\n", rxbuf[0]);\r\n}\r\nstatic ssize_t pcf2123_store(struct device *dev, struct device_attribute *attr,\r\nconst char *buffer, size_t count) {\r\nstruct spi_device *spi = to_spi_device(dev);\r\nstruct pcf2123_sysfs_reg *r;\r\nu8 txbuf[2];\r\nunsigned long reg;\r\nunsigned long val;\r\nint ret;\r\nr = container_of(attr, struct pcf2123_sysfs_reg, attr);\r\nret = kstrtoul(r->name, 16, &reg);\r\nif (ret)\r\nreturn ret;\r\nret = kstrtoul(buffer, 10, &val);\r\nif (ret)\r\nreturn ret;\r\ntxbuf[0] = PCF2123_WRITE | reg;\r\ntxbuf[1] = val;\r\nret = spi_write(spi, txbuf, sizeof(txbuf));\r\nif (ret < 0)\r\nreturn -EIO;\r\npcf2123_delay_trec();\r\nreturn count;\r\n}\r\nstatic int pcf2123_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nu8 txbuf[1], rxbuf[7];\r\nint ret;\r\ntxbuf[0] = PCF2123_READ | PCF2123_REG_SC;\r\nret = spi_write_then_read(spi, txbuf, sizeof(txbuf),\r\nrxbuf, sizeof(rxbuf));\r\nif (ret < 0)\r\nreturn ret;\r\npcf2123_delay_trec();\r\ntm->tm_sec = bcd2bin(rxbuf[0] & 0x7F);\r\ntm->tm_min = bcd2bin(rxbuf[1] & 0x7F);\r\ntm->tm_hour = bcd2bin(rxbuf[2] & 0x3F);\r\ntm->tm_mday = bcd2bin(rxbuf[3] & 0x3F);\r\ntm->tm_wday = rxbuf[4] & 0x07;\r\ntm->tm_mon = bcd2bin(rxbuf[5] & 0x1F) - 1;\r\ntm->tm_year = bcd2bin(rxbuf[6]);\r\nif (tm->tm_year < 70)\r\ntm->tm_year += 100;\r\ndev_dbg(dev, "%s: tm is secs=%d, mins=%d, hours=%d, "\r\n"mday=%d, mon=%d, year=%d, wday=%d\n",\r\n__func__,\r\ntm->tm_sec, tm->tm_min, tm->tm_hour,\r\ntm->tm_mday, tm->tm_mon, tm->tm_year, tm->tm_wday);\r\nreturn rtc_valid_tm(tm);\r\n}\r\nstatic int pcf2123_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nu8 txbuf[8];\r\nint ret;\r\ndev_dbg(dev, "%s: tm is secs=%d, mins=%d, hours=%d, "\r\n"mday=%d, mon=%d, year=%d, wday=%d\n",\r\n__func__,\r\ntm->tm_sec, tm->tm_min, tm->tm_hour,\r\ntm->tm_mday, tm->tm_mon, tm->tm_year, tm->tm_wday);\r\ntxbuf[0] = PCF2123_WRITE | PCF2123_REG_CTRL1;\r\ntxbuf[1] = 0x20;\r\nret = spi_write(spi, txbuf, 2);\r\nif (ret < 0)\r\nreturn ret;\r\npcf2123_delay_trec();\r\ntxbuf[0] = PCF2123_WRITE | PCF2123_REG_SC;\r\ntxbuf[1] = bin2bcd(tm->tm_sec & 0x7F);\r\ntxbuf[2] = bin2bcd(tm->tm_min & 0x7F);\r\ntxbuf[3] = bin2bcd(tm->tm_hour & 0x3F);\r\ntxbuf[4] = bin2bcd(tm->tm_mday & 0x3F);\r\ntxbuf[5] = tm->tm_wday & 0x07;\r\ntxbuf[6] = bin2bcd((tm->tm_mon + 1) & 0x1F);\r\ntxbuf[7] = bin2bcd(tm->tm_year < 100 ? tm->tm_year : tm->tm_year - 100);\r\nret = spi_write(spi, txbuf, sizeof(txbuf));\r\nif (ret < 0)\r\nreturn ret;\r\npcf2123_delay_trec();\r\ntxbuf[0] = PCF2123_WRITE | PCF2123_REG_CTRL1;\r\ntxbuf[1] = 0x00;\r\nret = spi_write(spi, txbuf, 2);\r\nif (ret < 0)\r\nreturn ret;\r\npcf2123_delay_trec();\r\nreturn 0;\r\n}\r\nstatic int pcf2123_probe(struct spi_device *spi)\r\n{\r\nstruct rtc_device *rtc;\r\nstruct pcf2123_plat_data *pdata;\r\nu8 txbuf[2], rxbuf[2];\r\nint ret, i;\r\npdata = devm_kzalloc(&spi->dev, sizeof(struct pcf2123_plat_data),\r\nGFP_KERNEL);\r\nif (!pdata)\r\nreturn -ENOMEM;\r\nspi->dev.platform_data = pdata;\r\ntxbuf[0] = PCF2123_WRITE | PCF2123_REG_CTRL1;\r\ntxbuf[1] = 0x58;\r\ndev_dbg(&spi->dev, "resetting RTC (0x%02X 0x%02X)\n",\r\ntxbuf[0], txbuf[1]);\r\nret = spi_write(spi, txbuf, 2 * sizeof(u8));\r\nif (ret < 0)\r\ngoto kfree_exit;\r\npcf2123_delay_trec();\r\ntxbuf[0] = PCF2123_WRITE | PCF2123_REG_CTRL1;\r\ntxbuf[1] = 0x20;\r\ndev_dbg(&spi->dev, "stopping RTC (0x%02X 0x%02X)\n",\r\ntxbuf[0], txbuf[1]);\r\nret = spi_write(spi, txbuf, 2 * sizeof(u8));\r\nif (ret < 0)\r\ngoto kfree_exit;\r\npcf2123_delay_trec();\r\ntxbuf[0] = PCF2123_READ | PCF2123_REG_CTRL1;\r\ndev_dbg(&spi->dev, "checking for presence of RTC (0x%02X)\n",\r\ntxbuf[0]);\r\nret = spi_write_then_read(spi, txbuf, 1 * sizeof(u8),\r\nrxbuf, 2 * sizeof(u8));\r\ndev_dbg(&spi->dev, "received data from RTC (0x%02X 0x%02X)\n",\r\nrxbuf[0], rxbuf[1]);\r\nif (ret < 0)\r\ngoto kfree_exit;\r\npcf2123_delay_trec();\r\nif (!(rxbuf[0] & 0x20)) {\r\ndev_err(&spi->dev, "chip not found\n");\r\nret = -ENODEV;\r\ngoto kfree_exit;\r\n}\r\ndev_info(&spi->dev, "chip found, driver version " DRV_VERSION "\n");\r\ndev_info(&spi->dev, "spiclk %u KHz.\n",\r\n(spi->max_speed_hz + 500) / 1000);\r\ntxbuf[0] = PCF2123_WRITE | PCF2123_REG_CTRL1;\r\ntxbuf[1] = 0x00;\r\nret = spi_write(spi, txbuf, sizeof(txbuf));\r\nif (ret < 0)\r\ngoto kfree_exit;\r\npcf2123_delay_trec();\r\nrtc = devm_rtc_device_register(&spi->dev, pcf2123_driver.driver.name,\r\n&pcf2123_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc)) {\r\ndev_err(&spi->dev, "failed to register.\n");\r\nret = PTR_ERR(rtc);\r\ngoto kfree_exit;\r\n}\r\npdata->rtc = rtc;\r\nfor (i = 0; i < 16; i++) {\r\nsysfs_attr_init(&pdata->regs[i].attr.attr);\r\nsprintf(pdata->regs[i].name, "%1x", i);\r\npdata->regs[i].attr.attr.mode = S_IRUGO | S_IWUSR;\r\npdata->regs[i].attr.attr.name = pdata->regs[i].name;\r\npdata->regs[i].attr.show = pcf2123_show;\r\npdata->regs[i].attr.store = pcf2123_store;\r\nret = device_create_file(&spi->dev, &pdata->regs[i].attr);\r\nif (ret) {\r\ndev_err(&spi->dev, "Unable to create sysfs %s\n",\r\npdata->regs[i].name);\r\ngoto sysfs_exit;\r\n}\r\n}\r\nreturn 0;\r\nsysfs_exit:\r\nfor (i--; i >= 0; i--)\r\ndevice_remove_file(&spi->dev, &pdata->regs[i].attr);\r\nkfree_exit:\r\nspi->dev.platform_data = NULL;\r\nreturn ret;\r\n}\r\nstatic int pcf2123_remove(struct spi_device *spi)\r\n{\r\nstruct pcf2123_plat_data *pdata = dev_get_platdata(&spi->dev);\r\nint i;\r\nif (pdata) {\r\nfor (i = 0; i < 16; i++)\r\nif (pdata->regs[i].name[0])\r\ndevice_remove_file(&spi->dev,\r\n&pdata->regs[i].attr);\r\n}\r\nreturn 0;\r\n}

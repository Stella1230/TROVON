void intel_pt_log_enable(void)\r\n{\r\nintel_pt_enable_logging = true;\r\n}\r\nvoid intel_pt_log_disable(void)\r\n{\r\nif (f)\r\nfflush(f);\r\nintel_pt_enable_logging = false;\r\n}\r\nvoid intel_pt_log_set_name(const char *name)\r\n{\r\nstrncpy(log_name, name, MAX_LOG_NAME - 5);\r\nstrcat(log_name, ".log");\r\n}\r\nstatic void intel_pt_print_data(const unsigned char *buf, int len, uint64_t pos,\r\nint indent)\r\n{\r\nint i;\r\nfor (i = 0; i < indent; i++)\r\nfprintf(f, " ");\r\nfprintf(f, " %08" PRIx64 ": ", pos);\r\nfor (i = 0; i < len; i++)\r\nfprintf(f, " %02x", buf[i]);\r\nfor (; i < 16; i++)\r\nfprintf(f, " ");\r\nfprintf(f, " ");\r\n}\r\nstatic void intel_pt_print_no_data(uint64_t pos, int indent)\r\n{\r\nint i;\r\nfor (i = 0; i < indent; i++)\r\nfprintf(f, " ");\r\nfprintf(f, " %08" PRIx64 ": ", pos);\r\nfor (i = 0; i < 16; i++)\r\nfprintf(f, " ");\r\nfprintf(f, " ");\r\n}\r\nstatic int intel_pt_log_open(void)\r\n{\r\nif (!intel_pt_enable_logging)\r\nreturn -1;\r\nif (f)\r\nreturn 0;\r\nif (!log_name[0])\r\nreturn -1;\r\nf = fopen(log_name, "w+");\r\nif (!f) {\r\nintel_pt_enable_logging = false;\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nvoid __intel_pt_log_packet(const struct intel_pt_pkt *packet, int pkt_len,\r\nuint64_t pos, const unsigned char *buf)\r\n{\r\nchar desc[INTEL_PT_PKT_DESC_MAX];\r\nif (intel_pt_log_open())\r\nreturn;\r\nintel_pt_print_data(buf, pkt_len, pos, 0);\r\nintel_pt_pkt_desc(packet, desc, INTEL_PT_PKT_DESC_MAX);\r\nfprintf(f, "%s\n", desc);\r\n}\r\nvoid __intel_pt_log_insn(struct intel_pt_insn *intel_pt_insn, uint64_t ip)\r\n{\r\nchar desc[INTEL_PT_INSN_DESC_MAX];\r\nsize_t len = intel_pt_insn->length;\r\nif (intel_pt_log_open())\r\nreturn;\r\nif (len > INTEL_PT_INSN_DBG_BUF_SZ)\r\nlen = INTEL_PT_INSN_DBG_BUF_SZ;\r\nintel_pt_print_data(intel_pt_insn->buf, len, ip, 8);\r\nif (intel_pt_insn_desc(intel_pt_insn, desc, INTEL_PT_INSN_DESC_MAX) > 0)\r\nfprintf(f, "%s\n", desc);\r\nelse\r\nfprintf(f, "Bad instruction!\n");\r\n}\r\nvoid __intel_pt_log_insn_no_data(struct intel_pt_insn *intel_pt_insn,\r\nuint64_t ip)\r\n{\r\nchar desc[INTEL_PT_INSN_DESC_MAX];\r\nif (intel_pt_log_open())\r\nreturn;\r\nintel_pt_print_no_data(ip, 8);\r\nif (intel_pt_insn_desc(intel_pt_insn, desc, INTEL_PT_INSN_DESC_MAX) > 0)\r\nfprintf(f, "%s\n", desc);\r\nelse\r\nfprintf(f, "Bad instruction!\n");\r\n}\r\nvoid __intel_pt_log(const char *fmt, ...)\r\n{\r\nva_list args;\r\nif (intel_pt_log_open())\r\nreturn;\r\nva_start(args, fmt);\r\nvfprintf(f, fmt, args);\r\nva_end(args);\r\n}

static void it8152_mask_irq(struct irq_data *d)\r\n{\r\nunsigned int irq = d->irq;\r\nif (irq >= IT8152_LD_IRQ(0)) {\r\n__raw_writel((__raw_readl(IT8152_INTC_LDCNIMR) |\r\n(1 << (irq - IT8152_LD_IRQ(0)))),\r\nIT8152_INTC_LDCNIMR);\r\n} else if (irq >= IT8152_LP_IRQ(0)) {\r\n__raw_writel((__raw_readl(IT8152_INTC_LPCNIMR) |\r\n(1 << (irq - IT8152_LP_IRQ(0)))),\r\nIT8152_INTC_LPCNIMR);\r\n} else if (irq >= IT8152_PD_IRQ(0)) {\r\n__raw_writel((__raw_readl(IT8152_INTC_PDCNIMR) |\r\n(1 << (irq - IT8152_PD_IRQ(0)))),\r\nIT8152_INTC_PDCNIMR);\r\n}\r\n}\r\nstatic void it8152_unmask_irq(struct irq_data *d)\r\n{\r\nunsigned int irq = d->irq;\r\nif (irq >= IT8152_LD_IRQ(0)) {\r\n__raw_writel((__raw_readl(IT8152_INTC_LDCNIMR) &\r\n~(1 << (irq - IT8152_LD_IRQ(0)))),\r\nIT8152_INTC_LDCNIMR);\r\n} else if (irq >= IT8152_LP_IRQ(0)) {\r\n__raw_writel((__raw_readl(IT8152_INTC_LPCNIMR) &\r\n~(1 << (irq - IT8152_LP_IRQ(0)))),\r\nIT8152_INTC_LPCNIMR);\r\n} else if (irq >= IT8152_PD_IRQ(0)) {\r\n__raw_writel((__raw_readl(IT8152_INTC_PDCNIMR) &\r\n~(1 << (irq - IT8152_PD_IRQ(0)))),\r\nIT8152_INTC_PDCNIMR);\r\n}\r\n}\r\nvoid it8152_init_irq(void)\r\n{\r\nint irq;\r\n__raw_writel((0xffff), IT8152_INTC_PDCNIMR);\r\n__raw_writel((0), IT8152_INTC_PDCNIRR);\r\n__raw_writel((0xffff), IT8152_INTC_LPCNIMR);\r\n__raw_writel((0), IT8152_INTC_LPCNIRR);\r\n__raw_writel((0xffff), IT8152_INTC_LDCNIMR);\r\n__raw_writel((0), IT8152_INTC_LDCNIRR);\r\nfor (irq = IT8152_IRQ(0); irq <= IT8152_LAST_IRQ; irq++) {\r\nirq_set_chip_and_handler(irq, &it8152_irq_chip,\r\nhandle_level_irq);\r\nirq_clear_status_flags(irq, IRQ_NOREQUEST | IRQ_NOPROBE);\r\n}\r\n}\r\nvoid it8152_irq_demux(struct irq_desc *desc)\r\n{\r\nint bits_pd, bits_lp, bits_ld;\r\nint i;\r\nwhile (1) {\r\nbits_pd = __raw_readl(IT8152_INTC_PDCNIRR);\r\nbits_lp = __raw_readl(IT8152_INTC_LPCNIRR);\r\nbits_ld = __raw_readl(IT8152_INTC_LDCNIRR);\r\n__raw_writel((~bits_pd), IT8152_INTC_PDCNIRR);\r\n__raw_writel((~bits_lp), IT8152_INTC_LPCNIRR);\r\n__raw_writel((~bits_ld), IT8152_INTC_LDCNIRR);\r\nif (!(bits_ld | bits_lp | bits_pd)) {\r\nbits_pd = __raw_readl(IT8152_INTC_PDCNIRR);\r\nbits_lp = __raw_readl(IT8152_INTC_LPCNIRR);\r\nbits_ld = __raw_readl(IT8152_INTC_LDCNIRR);\r\nif (!(bits_ld | bits_lp | bits_pd))\r\nreturn;\r\n}\r\nbits_pd &= ((1 << IT8152_PD_IRQ_COUNT) - 1);\r\nwhile (bits_pd) {\r\ni = __ffs(bits_pd);\r\ngeneric_handle_irq(IT8152_PD_IRQ(i));\r\nbits_pd &= ~(1 << i);\r\n}\r\nbits_lp &= ((1 << IT8152_LP_IRQ_COUNT) - 1);\r\nwhile (bits_lp) {\r\ni = __ffs(bits_lp);\r\ngeneric_handle_irq(IT8152_LP_IRQ(i));\r\nbits_lp &= ~(1 << i);\r\n}\r\nbits_ld &= ((1 << IT8152_LD_IRQ_COUNT) - 1);\r\nwhile (bits_ld) {\r\ni = __ffs(bits_ld);\r\ngeneric_handle_irq(IT8152_LD_IRQ(i));\r\nbits_ld &= ~(1 << i);\r\n}\r\n}\r\n}\r\nint __init it8152_pci_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nif ((dev->vendor == PCI_VENDOR_ID_ITE) &&\r\n(dev->device == PCI_DEVICE_ID_ITE_8152)) {\r\nif ((dev->class >> 8) == PCI_CLASS_MULTIMEDIA_AUDIO)\r\nreturn IT8152_AUDIO_INT;\r\nif ((dev->class >> 8) == PCI_CLASS_SERIAL_USB)\r\nreturn IT8152_USB_INT;\r\nif ((dev->class >> 8) == PCI_CLASS_SYSTEM_DMA)\r\nreturn IT8152_CDMA_INT;\r\n}\r\nreturn 0;\r\n}\r\nstatic unsigned long it8152_pci_dev_base_address(struct pci_bus *bus,\r\nunsigned int devfn)\r\n{\r\nunsigned long addr = 0;\r\nif (bus->number == 0) {\r\nif (devfn < PCI_DEVFN(MAX_SLOTS, 0))\r\naddr = (devfn << 8);\r\n} else\r\naddr = (bus->number << 16) | (devfn << 8);\r\nreturn addr;\r\n}\r\nstatic int it8152_pci_read_config(struct pci_bus *bus,\r\nunsigned int devfn, int where,\r\nint size, u32 *value)\r\n{\r\nunsigned long addr = it8152_pci_dev_base_address(bus, devfn);\r\nu32 v;\r\nint shift;\r\nshift = (where & 3);\r\n__raw_writel((addr + where), IT8152_PCI_CFG_ADDR);\r\nv = (__raw_readl(IT8152_PCI_CFG_DATA) >> (8 * (shift)));\r\n*value = v;\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int it8152_pci_write_config(struct pci_bus *bus,\r\nunsigned int devfn, int where,\r\nint size, u32 value)\r\n{\r\nunsigned long addr = it8152_pci_dev_base_address(bus, devfn);\r\nu32 v, vtemp, mask = 0;\r\nint shift;\r\nif (size == 1)\r\nmask = 0xff;\r\nif (size == 2)\r\nmask = 0xffff;\r\nshift = (where & 3);\r\n__raw_writel((addr + where), IT8152_PCI_CFG_ADDR);\r\nvtemp = __raw_readl(IT8152_PCI_CFG_DATA);\r\nif (mask)\r\nvtemp &= ~(mask << (8 * shift));\r\nelse\r\nvtemp = 0;\r\nv = (value << (8 * shift));\r\n__raw_writel((addr + where), IT8152_PCI_CFG_ADDR);\r\n__raw_writel((v | vtemp), IT8152_PCI_CFG_DATA);\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int it8152_needs_bounce(struct device *dev, dma_addr_t dma_addr, size_t size)\r\n{\r\ndev_dbg(dev, "%s: dma_addr %08x, size %08x\n",\r\n__func__, dma_addr, size);\r\nreturn (dma_addr + size - PHYS_OFFSET) >= SZ_64M;\r\n}\r\nstatic int it8152_pci_platform_notify(struct device *dev)\r\n{\r\nif (dev_is_pci(dev)) {\r\nif (dev->dma_mask)\r\n*dev->dma_mask = (SZ_64M - 1) | PHYS_OFFSET;\r\ndev->coherent_dma_mask = (SZ_64M - 1) | PHYS_OFFSET;\r\ndmabounce_register_dev(dev, 2048, 4096, it8152_needs_bounce);\r\n}\r\nreturn 0;\r\n}\r\nstatic int it8152_pci_platform_notify_remove(struct device *dev)\r\n{\r\nif (dev_is_pci(dev))\r\ndmabounce_unregister_dev(dev);\r\nreturn 0;\r\n}\r\nint dma_set_coherent_mask(struct device *dev, u64 mask)\r\n{\r\nif (mask >= PHYS_OFFSET + SZ_64M - 1)\r\nreturn 0;\r\nreturn -EIO;\r\n}\r\nint __init it8152_pci_setup(int nr, struct pci_sys_data *sys)\r\n{\r\nit8152_io.start = (unsigned long)IT8152_IO_BASE + 0x12000;\r\nit8152_io.end = (unsigned long)IT8152_IO_BASE + 0x12000 + 0x100000;\r\nsys->mem_offset = 0x10000000;\r\nsys->io_offset = (unsigned long)IT8152_IO_BASE;\r\nif (request_resource(&ioport_resource, &it8152_io)) {\r\nprintk(KERN_ERR "PCI: unable to allocate IO region\n");\r\ngoto err0;\r\n}\r\nif (request_resource(&iomem_resource, &it8152_mem)) {\r\nprintk(KERN_ERR "PCI: unable to allocate memory region\n");\r\ngoto err1;\r\n}\r\npci_add_resource_offset(&sys->resources, &it8152_io, sys->io_offset);\r\npci_add_resource_offset(&sys->resources, &it8152_mem, sys->mem_offset);\r\nif (platform_notify || platform_notify_remove) {\r\nprintk(KERN_ERR "PCI: Can't use platform_notify\n");\r\ngoto err2;\r\n}\r\nplatform_notify = it8152_pci_platform_notify;\r\nplatform_notify_remove = it8152_pci_platform_notify_remove;\r\nreturn 1;\r\nerr2:\r\nrelease_resource(&it8152_io);\r\nerr1:\r\nrelease_resource(&it8152_mem);\r\nerr0:\r\nreturn -EBUSY;\r\n}\r\nvoid pcibios_set_master(struct pci_dev *dev)\r\n{\r\nu8 lat;\r\nif ((dev->vendor == PCI_VENDOR_ID_ITE) &&\r\n(dev->device == PCI_DEVICE_ID_ITE_8152) &&\r\n((dev->class >> 8) == PCI_CLASS_SERIAL_USB))\r\nreturn;\r\npci_read_config_byte(dev, PCI_LATENCY_TIMER, &lat);\r\nif (lat < 16)\r\nlat = (64 <= pcibios_max_latency) ? 64 : pcibios_max_latency;\r\nelse if (lat > pcibios_max_latency)\r\nlat = pcibios_max_latency;\r\nelse\r\nreturn;\r\nprintk(KERN_DEBUG "PCI: Setting latency timer of device %s to %d\n",\r\npci_name(dev), lat);\r\npci_write_config_byte(dev, PCI_LATENCY_TIMER, lat);\r\n}

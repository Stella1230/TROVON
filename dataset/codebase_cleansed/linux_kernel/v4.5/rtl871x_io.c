static uint _init_intf_hdl(struct _adapter *padapter,\r\nstruct intf_hdl *pintf_hdl)\r\n{\r\nstruct intf_priv *pintf_priv;\r\nvoid (*set_intf_option)(u32 *poption) = NULL;\r\nvoid (*set_intf_funs)(struct intf_hdl *pintf_hdl);\r\nvoid (*set_intf_ops)(struct _io_ops *pops);\r\nuint (*init_intf_priv)(struct intf_priv *pintfpriv);\r\nset_intf_option = &(r8712_usb_set_intf_option);\r\nset_intf_funs = &(r8712_usb_set_intf_funs);\r\nset_intf_ops = &r8712_usb_set_intf_ops;\r\ninit_intf_priv = &r8712_usb_init_intf_priv;\r\npintf_priv = pintf_hdl->pintfpriv = kmalloc(sizeof(struct intf_priv),\r\nGFP_ATOMIC);\r\nif (pintf_priv == NULL)\r\ngoto _init_intf_hdl_fail;\r\npintf_hdl->adapter = (u8 *)padapter;\r\nset_intf_option(&pintf_hdl->intf_option);\r\nset_intf_funs(pintf_hdl);\r\nset_intf_ops(&pintf_hdl->io_ops);\r\npintf_priv->intf_dev = (u8 *)&(padapter->dvobjpriv);\r\nif (init_intf_priv(pintf_priv) == _FAIL)\r\ngoto _init_intf_hdl_fail;\r\nreturn _SUCCESS;\r\n_init_intf_hdl_fail:\r\nkfree(pintf_priv);\r\nreturn _FAIL;\r\n}\r\nstatic void _unload_intf_hdl(struct intf_priv *pintfpriv)\r\n{\r\nvoid (*unload_intf_priv)(struct intf_priv *pintfpriv);\r\nunload_intf_priv = &r8712_usb_unload_intf_priv;\r\nunload_intf_priv(pintfpriv);\r\nkfree(pintfpriv);\r\n}\r\nstatic uint register_intf_hdl(u8 *dev, struct intf_hdl *pintfhdl)\r\n{\r\nstruct _adapter *adapter = (struct _adapter *)dev;\r\npintfhdl->intf_option = 0;\r\npintfhdl->adapter = dev;\r\npintfhdl->intf_dev = (u8 *)&(adapter->dvobjpriv);\r\nif (!_init_intf_hdl(adapter, pintfhdl))\r\ngoto register_intf_hdl_fail;\r\nreturn _SUCCESS;\r\nregister_intf_hdl_fail:\r\nreturn false;\r\n}\r\nstatic void unregister_intf_hdl(struct intf_hdl *pintfhdl)\r\n{\r\n_unload_intf_hdl(pintfhdl->pintfpriv);\r\nmemset((u8 *)pintfhdl, 0, sizeof(struct intf_hdl));\r\n}\r\nuint r8712_alloc_io_queue(struct _adapter *adapter)\r\n{\r\nu32 i;\r\nstruct io_queue *pio_queue;\r\nstruct io_req *pio_req;\r\npio_queue = kmalloc(sizeof(*pio_queue), GFP_ATOMIC);\r\nif (pio_queue == NULL)\r\ngoto alloc_io_queue_fail;\r\nINIT_LIST_HEAD(&pio_queue->free_ioreqs);\r\nINIT_LIST_HEAD(&pio_queue->processing);\r\nINIT_LIST_HEAD(&pio_queue->pending);\r\nspin_lock_init(&pio_queue->lock);\r\npio_queue->pallocated_free_ioreqs_buf = kmalloc(NUM_IOREQ *\r\n(sizeof(struct io_req)) + 4,\r\nGFP_ATOMIC);\r\nif ((pio_queue->pallocated_free_ioreqs_buf) == NULL)\r\ngoto alloc_io_queue_fail;\r\nmemset(pio_queue->pallocated_free_ioreqs_buf, 0,\r\n(NUM_IOREQ * (sizeof(struct io_req)) + 4));\r\npio_queue->free_ioreqs_buf = pio_queue->pallocated_free_ioreqs_buf + 4\r\n- ((addr_t)(pio_queue->pallocated_free_ioreqs_buf)\r\n& 3);\r\npio_req = (struct io_req *)(pio_queue->free_ioreqs_buf);\r\nfor (i = 0; i < NUM_IOREQ; i++) {\r\nINIT_LIST_HEAD(&pio_req->list);\r\nlist_add_tail(&pio_req->list, &pio_queue->free_ioreqs);\r\npio_req++;\r\n}\r\nif ((register_intf_hdl((u8 *)adapter, &(pio_queue->intf))) == _FAIL)\r\ngoto alloc_io_queue_fail;\r\nadapter->pio_queue = pio_queue;\r\nreturn _SUCCESS;\r\nalloc_io_queue_fail:\r\nif (pio_queue) {\r\nkfree(pio_queue->pallocated_free_ioreqs_buf);\r\nkfree(pio_queue);\r\n}\r\nadapter->pio_queue = NULL;\r\nreturn _FAIL;\r\n}\r\nvoid r8712_free_io_queue(struct _adapter *adapter)\r\n{\r\nstruct io_queue *pio_queue = adapter->pio_queue;\r\nif (pio_queue) {\r\nkfree(pio_queue->pallocated_free_ioreqs_buf);\r\nadapter->pio_queue = NULL;\r\nunregister_intf_hdl(&pio_queue->intf);\r\nkfree(pio_queue);\r\n}\r\n}

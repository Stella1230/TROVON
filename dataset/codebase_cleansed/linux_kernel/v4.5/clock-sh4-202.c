static unsigned long emi_clk_recalc(struct clk *clk)\r\n{\r\nint idx = __raw_readl(CPG2_FRQCR3) & 0x0007;\r\nreturn clk->parent->rate / frqcr3_divisors[idx];\r\n}\r\nstatic inline int frqcr3_lookup(struct clk *clk, unsigned long rate)\r\n{\r\nint divisor = clk->parent->rate / rate;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(frqcr3_divisors); i++)\r\nif (frqcr3_divisors[i] == divisor)\r\nreturn frqcr3_values[i];\r\nreturn 5;\r\n}\r\nstatic unsigned long femi_clk_recalc(struct clk *clk)\r\n{\r\nint idx = (__raw_readl(CPG2_FRQCR3) >> 3) & 0x0007;\r\nreturn clk->parent->rate / frqcr3_divisors[idx];\r\n}\r\nstatic void shoc_clk_init(struct clk *clk)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(frqcr3_divisors); i++) {\r\nint divisor = frqcr3_divisors[i];\r\nif (clk->ops->set_rate(clk, clk->parent->rate / divisor) == 0)\r\nbreak;\r\n}\r\nWARN_ON(i == ARRAY_SIZE(frqcr3_divisors));\r\n}\r\nstatic unsigned long shoc_clk_recalc(struct clk *clk)\r\n{\r\nint idx = (__raw_readl(CPG2_FRQCR3) >> 6) & 0x0007;\r\nreturn clk->parent->rate / frqcr3_divisors[idx];\r\n}\r\nstatic int shoc_clk_verify_rate(struct clk *clk, unsigned long rate)\r\n{\r\nstruct clk *bclk = clk_get(NULL, "bus_clk");\r\nunsigned long bclk_rate = clk_get_rate(bclk);\r\nclk_put(bclk);\r\nif (rate > bclk_rate)\r\nreturn 1;\r\nif (rate > 66000000)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int shoc_clk_set_rate(struct clk *clk, unsigned long rate)\r\n{\r\nunsigned long frqcr3;\r\nunsigned int tmp;\r\nif (shoc_clk_verify_rate(clk, rate) != 0)\r\nreturn -EINVAL;\r\ntmp = frqcr3_lookup(clk, rate);\r\nfrqcr3 = __raw_readl(CPG2_FRQCR3);\r\nfrqcr3 &= ~(0x0007 << 6);\r\nfrqcr3 |= tmp << 6;\r\n__raw_writel(frqcr3, CPG2_FRQCR3);\r\nclk->rate = clk->parent->rate / frqcr3_divisors[tmp];\r\nreturn 0;\r\n}\r\nint __init arch_clk_init(void)\r\n{\r\nstruct clk *clk;\r\nint i, ret = 0;\r\ncpg_clk_init();\r\nclk = clk_get(NULL, "master_clk");\r\nfor (i = 0; i < ARRAY_SIZE(sh4202_onchip_clocks); i++) {\r\nstruct clk *clkp = sh4202_onchip_clocks[i];\r\nclkp->parent = clk;\r\nret |= clk_register(clkp);\r\n}\r\nclk_put(clk);\r\nclkdev_add_table(lookups, ARRAY_SIZE(lookups));\r\nreturn ret;\r\n}

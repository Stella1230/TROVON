irqreturn_t pdacf_interrupt(int irq, void *dev)\r\n{\r\nstruct snd_pdacf *chip = dev;\r\nunsigned short stat;\r\nbool wake_thread = false;\r\nif ((chip->chip_status & (PDAUDIOCF_STAT_IS_STALE|\r\nPDAUDIOCF_STAT_IS_CONFIGURED|\r\nPDAUDIOCF_STAT_IS_SUSPENDED)) != PDAUDIOCF_STAT_IS_CONFIGURED)\r\nreturn IRQ_HANDLED;\r\nstat = inw(chip->port + PDAUDIOCF_REG_ISR);\r\nif (stat & (PDAUDIOCF_IRQLVL|PDAUDIOCF_IRQOVR)) {\r\nif (stat & PDAUDIOCF_IRQOVR)\r\nsnd_printk(KERN_ERR "PDAUDIOCF SRAM buffer overrun detected!\n");\r\nif (chip->pcm_substream)\r\nwake_thread = true;\r\nif (!(stat & PDAUDIOCF_IRQAKM))\r\nstat |= PDAUDIOCF_IRQAKM;\r\n}\r\nif (get_irq_regs() != NULL)\r\nsnd_ak4117_check_rate_and_errors(chip->ak4117, 0);\r\nreturn wake_thread ? IRQ_WAKE_THREAD : IRQ_HANDLED;\r\n}\r\nstatic inline void pdacf_transfer_mono16(u16 *dst, u16 xor, unsigned int size, unsigned long rdp_port)\r\n{\r\nwhile (size-- > 0) {\r\n*dst++ = inw(rdp_port) ^ xor;\r\ninw(rdp_port);\r\n}\r\n}\r\nstatic inline void pdacf_transfer_mono32(u32 *dst, u32 xor, unsigned int size, unsigned long rdp_port)\r\n{\r\nregister u16 val1, val2;\r\nwhile (size-- > 0) {\r\nval1 = inw(rdp_port);\r\nval2 = inw(rdp_port);\r\ninw(rdp_port);\r\n*dst++ = ((((u32)val2 & 0xff) << 24) | ((u32)val1 << 8)) ^ xor;\r\n}\r\n}\r\nstatic inline void pdacf_transfer_stereo16(u16 *dst, u16 xor, unsigned int size, unsigned long rdp_port)\r\n{\r\nwhile (size-- > 0) {\r\n*dst++ = inw(rdp_port) ^ xor;\r\n*dst++ = inw(rdp_port) ^ xor;\r\n}\r\n}\r\nstatic inline void pdacf_transfer_stereo32(u32 *dst, u32 xor, unsigned int size, unsigned long rdp_port)\r\n{\r\nregister u16 val1, val2, val3;\r\nwhile (size-- > 0) {\r\nval1 = inw(rdp_port);\r\nval2 = inw(rdp_port);\r\nval3 = inw(rdp_port);\r\n*dst++ = ((((u32)val2 & 0xff) << 24) | ((u32)val1 << 8)) ^ xor;\r\n*dst++ = (((u32)val3 << 16) | (val2 & 0xff00)) ^ xor;\r\n}\r\n}\r\nstatic inline void pdacf_transfer_mono16sw(u16 *dst, u16 xor, unsigned int size, unsigned long rdp_port)\r\n{\r\nwhile (size-- > 0) {\r\n*dst++ = swab16(inw(rdp_port) ^ xor);\r\ninw(rdp_port);\r\n}\r\n}\r\nstatic inline void pdacf_transfer_mono32sw(u32 *dst, u32 xor, unsigned int size, unsigned long rdp_port)\r\n{\r\nregister u16 val1, val2;\r\nwhile (size-- > 0) {\r\nval1 = inw(rdp_port);\r\nval2 = inw(rdp_port);\r\ninw(rdp_port);\r\n*dst++ = swab32((((val2 & 0xff) << 24) | ((u32)val1 << 8)) ^ xor);\r\n}\r\n}\r\nstatic inline void pdacf_transfer_stereo16sw(u16 *dst, u16 xor, unsigned int size, unsigned long rdp_port)\r\n{\r\nwhile (size-- > 0) {\r\n*dst++ = swab16(inw(rdp_port) ^ xor);\r\n*dst++ = swab16(inw(rdp_port) ^ xor);\r\n}\r\n}\r\nstatic inline void pdacf_transfer_stereo32sw(u32 *dst, u32 xor, unsigned int size, unsigned long rdp_port)\r\n{\r\nregister u16 val1, val2, val3;\r\nwhile (size-- > 0) {\r\nval1 = inw(rdp_port);\r\nval2 = inw(rdp_port);\r\nval3 = inw(rdp_port);\r\n*dst++ = swab32((((val2 & 0xff) << 24) | ((u32)val1 << 8)) ^ xor);\r\n*dst++ = swab32((((u32)val3 << 16) | (val2 & 0xff00)) ^ xor);\r\n}\r\n}\r\nstatic inline void pdacf_transfer_mono24le(u8 *dst, u16 xor, unsigned int size, unsigned long rdp_port)\r\n{\r\nregister u16 val1, val2;\r\nregister u32 xval1;\r\nwhile (size-- > 0) {\r\nval1 = inw(rdp_port);\r\nval2 = inw(rdp_port);\r\ninw(rdp_port);\r\nxval1 = (((val2 & 0xff) << 8) | (val1 << 16)) ^ xor;\r\n*dst++ = (u8)(xval1 >> 8);\r\n*dst++ = (u8)(xval1 >> 16);\r\n*dst++ = (u8)(xval1 >> 24);\r\n}\r\n}\r\nstatic inline void pdacf_transfer_mono24be(u8 *dst, u16 xor, unsigned int size, unsigned long rdp_port)\r\n{\r\nregister u16 val1, val2;\r\nregister u32 xval1;\r\nwhile (size-- > 0) {\r\nval1 = inw(rdp_port);\r\nval2 = inw(rdp_port);\r\ninw(rdp_port);\r\nxval1 = (((val2 & 0xff) << 8) | (val1 << 16)) ^ xor;\r\n*dst++ = (u8)(xval1 >> 24);\r\n*dst++ = (u8)(xval1 >> 16);\r\n*dst++ = (u8)(xval1 >> 8);\r\n}\r\n}\r\nstatic inline void pdacf_transfer_stereo24le(u8 *dst, u32 xor, unsigned int size, unsigned long rdp_port)\r\n{\r\nregister u16 val1, val2, val3;\r\nregister u32 xval1, xval2;\r\nwhile (size-- > 0) {\r\nval1 = inw(rdp_port);\r\nval2 = inw(rdp_port);\r\nval3 = inw(rdp_port);\r\nxval1 = ((((u32)val2 & 0xff) << 24) | ((u32)val1 << 8)) ^ xor;\r\nxval2 = (((u32)val3 << 16) | (val2 & 0xff00)) ^ xor;\r\n*dst++ = (u8)(xval1 >> 8);\r\n*dst++ = (u8)(xval1 >> 16);\r\n*dst++ = (u8)(xval1 >> 24);\r\n*dst++ = (u8)(xval2 >> 8);\r\n*dst++ = (u8)(xval2 >> 16);\r\n*dst++ = (u8)(xval2 >> 24);\r\n}\r\n}\r\nstatic inline void pdacf_transfer_stereo24be(u8 *dst, u32 xor, unsigned int size, unsigned long rdp_port)\r\n{\r\nregister u16 val1, val2, val3;\r\nregister u32 xval1, xval2;\r\nwhile (size-- > 0) {\r\nval1 = inw(rdp_port);\r\nval2 = inw(rdp_port);\r\nval3 = inw(rdp_port);\r\nxval1 = ((((u32)val2 & 0xff) << 24) | ((u32)val1 << 8)) ^ xor;\r\nxval2 = (((u32)val3 << 16) | (val2 & 0xff00)) ^ xor;\r\n*dst++ = (u8)(xval1 >> 24);\r\n*dst++ = (u8)(xval1 >> 16);\r\n*dst++ = (u8)(xval1 >> 8);\r\n*dst++ = (u8)(xval2 >> 24);\r\n*dst++ = (u8)(xval2 >> 16);\r\n*dst++ = (u8)(xval2 >> 8);\r\n}\r\n}\r\nstatic void pdacf_transfer(struct snd_pdacf *chip, unsigned int size, unsigned int off)\r\n{\r\nunsigned long rdp_port = chip->port + PDAUDIOCF_REG_MD;\r\nunsigned int xor = chip->pcm_xor;\r\nif (chip->pcm_sample == 3) {\r\nif (chip->pcm_little) {\r\nif (chip->pcm_channels == 1) {\r\npdacf_transfer_mono24le((char *)chip->pcm_area + (off * 3), xor, size, rdp_port);\r\n} else {\r\npdacf_transfer_stereo24le((char *)chip->pcm_area + (off * 6), xor, size, rdp_port);\r\n}\r\n} else {\r\nif (chip->pcm_channels == 1) {\r\npdacf_transfer_mono24be((char *)chip->pcm_area + (off * 3), xor, size, rdp_port);\r\n} else {\r\npdacf_transfer_stereo24be((char *)chip->pcm_area + (off * 6), xor, size, rdp_port);\r\n}\r\n}\r\nreturn;\r\n}\r\nif (chip->pcm_swab == 0) {\r\nif (chip->pcm_channels == 1) {\r\nif (chip->pcm_frame == 2) {\r\npdacf_transfer_mono16((u16 *)chip->pcm_area + off, xor, size, rdp_port);\r\n} else {\r\npdacf_transfer_mono32((u32 *)chip->pcm_area + off, xor, size, rdp_port);\r\n}\r\n} else {\r\nif (chip->pcm_frame == 2) {\r\npdacf_transfer_stereo16((u16 *)chip->pcm_area + (off * 2), xor, size, rdp_port);\r\n} else {\r\npdacf_transfer_stereo32((u32 *)chip->pcm_area + (off * 2), xor, size, rdp_port);\r\n}\r\n}\r\n} else {\r\nif (chip->pcm_channels == 1) {\r\nif (chip->pcm_frame == 2) {\r\npdacf_transfer_mono16sw((u16 *)chip->pcm_area + off, xor, size, rdp_port);\r\n} else {\r\npdacf_transfer_mono32sw((u32 *)chip->pcm_area + off, xor, size, rdp_port);\r\n}\r\n} else {\r\nif (chip->pcm_frame == 2) {\r\npdacf_transfer_stereo16sw((u16 *)chip->pcm_area + (off * 2), xor, size, rdp_port);\r\n} else {\r\npdacf_transfer_stereo32sw((u32 *)chip->pcm_area + (off * 2), xor, size, rdp_port);\r\n}\r\n}\r\n}\r\n}\r\nirqreturn_t pdacf_threaded_irq(int irq, void *dev)\r\n{\r\nstruct snd_pdacf *chip = dev;\r\nint size, off, cont, rdp, wdp;\r\nif ((chip->chip_status & (PDAUDIOCF_STAT_IS_STALE|PDAUDIOCF_STAT_IS_CONFIGURED)) != PDAUDIOCF_STAT_IS_CONFIGURED)\r\nreturn IRQ_HANDLED;\r\nif (chip->pcm_substream == NULL || chip->pcm_substream->runtime == NULL || !snd_pcm_running(chip->pcm_substream))\r\nreturn IRQ_HANDLED;\r\nrdp = inw(chip->port + PDAUDIOCF_REG_RDP);\r\nwdp = inw(chip->port + PDAUDIOCF_REG_WDP);\r\nsize = wdp - rdp;\r\nif (size < 0)\r\nsize += 0x10000;\r\nif (size == 0)\r\nsize = 0x10000;\r\nsize /= chip->pcm_frame;\r\nif (size > 64)\r\nsize -= 32;\r\n#if 0\r\nchip->pcm_hwptr += size;\r\nchip->pcm_hwptr %= chip->pcm_size;\r\nchip->pcm_tdone += size;\r\nif (chip->pcm_frame == 2) {\r\nunsigned long rdp_port = chip->port + PDAUDIOCF_REG_MD;\r\nwhile (size-- > 0) {\r\ninw(rdp_port);\r\ninw(rdp_port);\r\n}\r\n} else {\r\nunsigned long rdp_port = chip->port + PDAUDIOCF_REG_MD;\r\nwhile (size-- > 0) {\r\ninw(rdp_port);\r\ninw(rdp_port);\r\ninw(rdp_port);\r\n}\r\n}\r\n#else\r\noff = chip->pcm_hwptr + chip->pcm_tdone;\r\noff %= chip->pcm_size;\r\nchip->pcm_tdone += size;\r\nwhile (size > 0) {\r\ncont = chip->pcm_size - off;\r\nif (cont > size)\r\ncont = size;\r\npdacf_transfer(chip, cont, off);\r\noff += cont;\r\noff %= chip->pcm_size;\r\nsize -= cont;\r\n}\r\n#endif\r\nmutex_lock(&chip->reg_lock);\r\nwhile (chip->pcm_tdone >= chip->pcm_period) {\r\nchip->pcm_hwptr += chip->pcm_period;\r\nchip->pcm_hwptr %= chip->pcm_size;\r\nchip->pcm_tdone -= chip->pcm_period;\r\nmutex_unlock(&chip->reg_lock);\r\nsnd_pcm_period_elapsed(chip->pcm_substream);\r\nmutex_lock(&chip->reg_lock);\r\n}\r\nmutex_unlock(&chip->reg_lock);\r\nreturn IRQ_HANDLED;\r\n}

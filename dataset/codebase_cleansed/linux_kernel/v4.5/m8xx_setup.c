static irqreturn_t timebase_interrupt(int irq, void *dev)\r\n{\r\nprintk ("timebase_interrupt()\n");\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __init get_freq(char *name, unsigned long *val)\r\n{\r\nstruct device_node *cpu;\r\nconst unsigned int *fp;\r\nint found = 0;\r\ncpu = of_find_node_by_type(NULL, "cpu");\r\nif (cpu) {\r\nfp = of_get_property(cpu, name, NULL);\r\nif (fp) {\r\nfound = 1;\r\n*val = *fp;\r\n}\r\nof_node_put(cpu);\r\n}\r\nreturn found;\r\n}\r\nvoid __init mpc8xx_calibrate_decr(void)\r\n{\r\nstruct device_node *cpu;\r\ncark8xx_t __iomem *clk_r1;\r\ncar8xx_t __iomem *clk_r2;\r\nsitk8xx_t __iomem *sys_tmr1;\r\nsit8xx_t __iomem *sys_tmr2;\r\nint irq, virq;\r\nclk_r1 = immr_map(im_clkrstk);\r\nout_be32(&clk_r1->cark_sccrk, ~KAPWR_KEY);\r\nout_be32(&clk_r1->cark_sccrk, KAPWR_KEY);\r\nimmr_unmap(clk_r1);\r\nclk_r2 = immr_map(im_clkrst);\r\nsetbits32(&clk_r2->car_sccr, 0x02000000);\r\nimmr_unmap(clk_r2);\r\nppc_proc_freq = 50000000;\r\nif (!get_freq("clock-frequency", &ppc_proc_freq))\r\nprintk(KERN_ERR "WARNING: Estimating processor frequency "\r\n"(not found)\n");\r\nppc_tb_freq = ppc_proc_freq / 16;\r\nprintk("Decrementer Frequency = 0x%lx\n", ppc_tb_freq);\r\nsys_tmr1 = immr_map(im_sitk);\r\nout_be32(&sys_tmr1->sitk_tbscrk, ~KAPWR_KEY);\r\nout_be32(&sys_tmr1->sitk_rtcsck, ~KAPWR_KEY);\r\nout_be32(&sys_tmr1->sitk_tbk, ~KAPWR_KEY);\r\nout_be32(&sys_tmr1->sitk_tbscrk, KAPWR_KEY);\r\nout_be32(&sys_tmr1->sitk_rtcsck, KAPWR_KEY);\r\nout_be32(&sys_tmr1->sitk_tbk, KAPWR_KEY);\r\nimmr_unmap(sys_tmr1);\r\ninit_internal_rtc();\r\ncpu = of_find_node_by_type(NULL, "cpu");\r\nvirq= irq_of_parse_and_map(cpu, 0);\r\nirq = virq_to_hw(virq);\r\nsys_tmr2 = immr_map(im_sit);\r\nout_be16(&sys_tmr2->sit_tbscr, ((1 << (7 - (irq/2))) << 8) |\r\n(TBSCR_TBF | TBSCR_TBE));\r\nimmr_unmap(sys_tmr2);\r\nif (setup_irq(virq, &tbint_irqaction))\r\npanic("Could not allocate timer IRQ!");\r\n}\r\nint mpc8xx_set_rtc_time(struct rtc_time *tm)\r\n{\r\nsitk8xx_t __iomem *sys_tmr1;\r\nsit8xx_t __iomem *sys_tmr2;\r\nint time;\r\nsys_tmr1 = immr_map(im_sitk);\r\nsys_tmr2 = immr_map(im_sit);\r\ntime = mktime(tm->tm_year+1900, tm->tm_mon+1, tm->tm_mday,\r\ntm->tm_hour, tm->tm_min, tm->tm_sec);\r\nout_be32(&sys_tmr1->sitk_rtck, KAPWR_KEY);\r\nout_be32(&sys_tmr2->sit_rtc, time);\r\nout_be32(&sys_tmr1->sitk_rtck, ~KAPWR_KEY);\r\nimmr_unmap(sys_tmr2);\r\nimmr_unmap(sys_tmr1);\r\nreturn 0;\r\n}\r\nvoid mpc8xx_get_rtc_time(struct rtc_time *tm)\r\n{\r\nunsigned long data;\r\nsit8xx_t __iomem *sys_tmr = immr_map(im_sit);\r\ndata = in_be32(&sys_tmr->sit_rtc);\r\nto_tm(data, tm);\r\ntm->tm_year -= 1900;\r\ntm->tm_mon -= 1;\r\nimmr_unmap(sys_tmr);\r\nreturn;\r\n}\r\nvoid mpc8xx_restart(char *cmd)\r\n{\r\ncar8xx_t __iomem *clk_r = immr_map(im_clkrst);\r\nlocal_irq_disable();\r\nsetbits32(&clk_r->car_plprcr, 0x00000080);\r\nmtmsr(mfmsr() & ~0x1000);\r\nin_8(&clk_r->res[0]);\r\npanic("Restart failed\n");\r\n}\r\nstatic void cpm_cascade(struct irq_desc *desc)\r\n{\r\nstruct irq_chip *chip = irq_desc_get_chip(desc);\r\nint cascade_irq = cpm_get_irq();\r\nif (cascade_irq >= 0)\r\ngeneric_handle_irq(cascade_irq);\r\nchip->irq_eoi(&desc->irq_data);\r\n}\r\nvoid __init mpc8xx_pics_init(void)\r\n{\r\nint irq;\r\nif (mpc8xx_pic_init()) {\r\nprintk(KERN_ERR "Failed interrupt 8xx controller initialization\n");\r\nreturn;\r\n}\r\nirq = cpm_pic_init();\r\nif (irq != NO_IRQ)\r\nirq_set_chained_handler(irq, cpm_cascade);\r\n}

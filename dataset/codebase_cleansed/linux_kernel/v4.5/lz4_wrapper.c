static void *lz4_comp_opts(struct squashfs_sb_info *msblk,\r\nvoid *buff, int len)\r\n{\r\nstruct lz4_comp_opts *comp_opts = buff;\r\nif (comp_opts == NULL || len < sizeof(*comp_opts))\r\nreturn ERR_PTR(-EIO);\r\nif (le32_to_cpu(comp_opts->version) != LZ4_LEGACY) {\r\nERROR("Unknown LZ4 version\n");\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nreturn NULL;\r\n}\r\nstatic void *lz4_init(struct squashfs_sb_info *msblk, void *buff)\r\n{\r\nint block_size = max_t(int, msblk->block_size, SQUASHFS_METADATA_SIZE);\r\nstruct squashfs_lz4 *stream;\r\nstream = kzalloc(sizeof(*stream), GFP_KERNEL);\r\nif (stream == NULL)\r\ngoto failed;\r\nstream->input = vmalloc(block_size);\r\nif (stream->input == NULL)\r\ngoto failed2;\r\nstream->output = vmalloc(block_size);\r\nif (stream->output == NULL)\r\ngoto failed3;\r\nreturn stream;\r\nfailed3:\r\nvfree(stream->input);\r\nfailed2:\r\nkfree(stream);\r\nfailed:\r\nERROR("Failed to initialise LZ4 decompressor\n");\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nstatic void lz4_free(void *strm)\r\n{\r\nstruct squashfs_lz4 *stream = strm;\r\nif (stream) {\r\nvfree(stream->input);\r\nvfree(stream->output);\r\n}\r\nkfree(stream);\r\n}\r\nstatic int lz4_uncompress(struct squashfs_sb_info *msblk, void *strm,\r\nstruct buffer_head **bh, int b, int offset, int length,\r\nstruct squashfs_page_actor *output)\r\n{\r\nstruct squashfs_lz4 *stream = strm;\r\nvoid *buff = stream->input, *data;\r\nint avail, i, bytes = length, res;\r\nsize_t dest_len = output->length;\r\nfor (i = 0; i < b; i++) {\r\navail = min(bytes, msblk->devblksize - offset);\r\nmemcpy(buff, bh[i]->b_data + offset, avail);\r\nbuff += avail;\r\nbytes -= avail;\r\noffset = 0;\r\nput_bh(bh[i]);\r\n}\r\nres = lz4_decompress_unknownoutputsize(stream->input, length,\r\nstream->output, &dest_len);\r\nif (res)\r\nreturn -EIO;\r\nbytes = dest_len;\r\ndata = squashfs_first_page(output);\r\nbuff = stream->output;\r\nwhile (data) {\r\nif (bytes <= PAGE_CACHE_SIZE) {\r\nmemcpy(data, buff, bytes);\r\nbreak;\r\n}\r\nmemcpy(data, buff, PAGE_CACHE_SIZE);\r\nbuff += PAGE_CACHE_SIZE;\r\nbytes -= PAGE_CACHE_SIZE;\r\ndata = squashfs_next_page(output);\r\n}\r\nsquashfs_finish_page(output);\r\nreturn dest_len;\r\n}

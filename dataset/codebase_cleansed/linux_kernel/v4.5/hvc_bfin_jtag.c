static inline uint32_t bfin_write_emudat(uint32_t emudat)\r\n{\r\n__asm__ __volatile__("emudat = %0;" : : "d"(emudat));\r\nreturn emudat;\r\n}\r\nstatic inline uint32_t bfin_read_emudat(void)\r\n{\r\nuint32_t emudat;\r\n__asm__ __volatile__("%0 = emudat;" : "=d"(emudat));\r\nreturn emudat;\r\n}\r\nstatic int hvc_bfin_put_chars(uint32_t vt, const char *buf, int count)\r\n{\r\nstatic uint32_t outbound_len;\r\nuint32_t emudat;\r\nint ret;\r\nif (bfin_read_DBGSTAT() & EMUDOF)\r\nreturn 0;\r\nif (!outbound_len) {\r\noutbound_len = count;\r\nbfin_write_emudat(outbound_len);\r\nreturn 0;\r\n}\r\nret = min(outbound_len, (uint32_t)4);\r\nmemcpy(&emudat, buf, ret);\r\nbfin_write_emudat(emudat);\r\noutbound_len -= ret;\r\nreturn ret;\r\n}\r\nstatic int hvc_bfin_get_chars(uint32_t vt, char *buf, int count)\r\n{\r\nstatic uint32_t inbound_len;\r\nuint32_t emudat;\r\nint ret;\r\nif (!(bfin_read_DBGSTAT() & EMUDIF))\r\nreturn 0;\r\nemudat = bfin_read_emudat();\r\nif (!inbound_len) {\r\ninbound_len = emudat;\r\nreturn 0;\r\n}\r\nret = min(inbound_len, (uint32_t)4);\r\nmemcpy(buf, &emudat, ret);\r\ninbound_len -= ret;\r\nreturn ret;\r\n}\r\nstatic int __init hvc_bfin_console_init(void)\r\n{\r\nhvc_instantiate(0, 0, &hvc_bfin_get_put_ops);\r\nreturn 0;\r\n}\r\nstatic int __init hvc_bfin_init(void)\r\n{\r\nhvc_alloc(0, 0, &hvc_bfin_get_put_ops, 128);\r\nreturn 0;\r\n}

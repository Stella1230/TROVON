static void vexpress_reset_do(struct device *dev, const char *what)\r\n{\r\nint err = -ENOENT;\r\nstruct regmap *reg = dev_get_drvdata(dev);\r\nif (reg) {\r\nerr = regmap_write(reg, 0, 0);\r\nif (!err)\r\nmdelay(1000);\r\n}\r\ndev_emerg(dev, "Unable to %s (%d)\n", what, err);\r\n}\r\nstatic void vexpress_power_off(void)\r\n{\r\nvexpress_reset_do(vexpress_power_off_device, "power off");\r\n}\r\nstatic int vexpress_restart(struct notifier_block *this, unsigned long mode,\r\nvoid *cmd)\r\n{\r\nvexpress_reset_do(vexpress_restart_device, "restart");\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic ssize_t vexpress_reset_active_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "%d\n", vexpress_restart_device == dev);\r\n}\r\nstatic ssize_t vexpress_reset_active_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nlong value;\r\nint err = kstrtol(buf, 0, &value);\r\nif (!err && value)\r\nvexpress_restart_device = dev;\r\nreturn err ? err : count;\r\n}\r\nstatic int _vexpress_register_restart_handler(struct device *dev)\r\n{\r\nint err;\r\nvexpress_restart_device = dev;\r\nerr = register_restart_handler(&vexpress_restart_nb);\r\nif (err) {\r\ndev_err(dev, "cannot register restart handler (err=%d)\n", err);\r\nreturn err;\r\n}\r\ndevice_create_file(dev, &dev_attr_active);\r\nreturn 0;\r\n}\r\nstatic int vexpress_reset_probe(struct platform_device *pdev)\r\n{\r\nconst struct of_device_id *match =\r\nof_match_device(vexpress_reset_of_match, &pdev->dev);\r\nstruct regmap *regmap;\r\nint ret = 0;\r\nif (!match)\r\nreturn -EINVAL;\r\nregmap = devm_regmap_init_vexpress_config(&pdev->dev);\r\nif (IS_ERR(regmap))\r\nreturn PTR_ERR(regmap);\r\ndev_set_drvdata(&pdev->dev, regmap);\r\nswitch ((enum vexpress_reset_func)match->data) {\r\ncase FUNC_SHUTDOWN:\r\nvexpress_power_off_device = &pdev->dev;\r\npm_power_off = vexpress_power_off;\r\nbreak;\r\ncase FUNC_RESET:\r\nif (!vexpress_restart_device)\r\nret = _vexpress_register_restart_handler(&pdev->dev);\r\nbreak;\r\ncase FUNC_REBOOT:\r\nret = _vexpress_register_restart_handler(&pdev->dev);\r\nbreak;\r\n};\r\nreturn ret;\r\n}\r\nstatic int __init vexpress_reset_init(void)\r\n{\r\nreturn platform_driver_register(&vexpress_reset_driver);\r\n}

static int dw_spi_mmio_probe(struct platform_device *pdev)\r\n{\r\nstruct dw_spi_mmio *dwsmmio;\r\nstruct dw_spi *dws;\r\nstruct resource *mem;\r\nint ret;\r\nint num_cs;\r\ndwsmmio = devm_kzalloc(&pdev->dev, sizeof(struct dw_spi_mmio),\r\nGFP_KERNEL);\r\nif (!dwsmmio)\r\nreturn -ENOMEM;\r\ndws = &dwsmmio->dws;\r\nmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!mem) {\r\ndev_err(&pdev->dev, "no mem resource?\n");\r\nreturn -EINVAL;\r\n}\r\ndws->regs = devm_ioremap_resource(&pdev->dev, mem);\r\nif (IS_ERR(dws->regs)) {\r\ndev_err(&pdev->dev, "SPI region map failed\n");\r\nreturn PTR_ERR(dws->regs);\r\n}\r\ndws->irq = platform_get_irq(pdev, 0);\r\nif (dws->irq < 0) {\r\ndev_err(&pdev->dev, "no irq resource?\n");\r\nreturn dws->irq;\r\n}\r\ndwsmmio->clk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(dwsmmio->clk))\r\nreturn PTR_ERR(dwsmmio->clk);\r\nret = clk_prepare_enable(dwsmmio->clk);\r\nif (ret)\r\nreturn ret;\r\ndws->bus_num = pdev->id;\r\ndws->max_freq = clk_get_rate(dwsmmio->clk);\r\ndevice_property_read_u32(&pdev->dev, "reg-io-width", &dws->reg_io_width);\r\nnum_cs = 4;\r\ndevice_property_read_u32(&pdev->dev, "num-cs", &num_cs);\r\ndws->num_cs = num_cs;\r\nif (pdev->dev.of_node) {\r\nint i;\r\nfor (i = 0; i < dws->num_cs; i++) {\r\nint cs_gpio = of_get_named_gpio(pdev->dev.of_node,\r\n"cs-gpios", i);\r\nif (cs_gpio == -EPROBE_DEFER) {\r\nret = cs_gpio;\r\ngoto out;\r\n}\r\nif (gpio_is_valid(cs_gpio)) {\r\nret = devm_gpio_request(&pdev->dev, cs_gpio,\r\ndev_name(&pdev->dev));\r\nif (ret)\r\ngoto out;\r\n}\r\n}\r\n}\r\nret = dw_spi_add_host(&pdev->dev, dws);\r\nif (ret)\r\ngoto out;\r\nplatform_set_drvdata(pdev, dwsmmio);\r\nreturn 0;\r\nout:\r\nclk_disable_unprepare(dwsmmio->clk);\r\nreturn ret;\r\n}\r\nstatic int dw_spi_mmio_remove(struct platform_device *pdev)\r\n{\r\nstruct dw_spi_mmio *dwsmmio = platform_get_drvdata(pdev);\r\nclk_disable_unprepare(dwsmmio->clk);\r\ndw_spi_remove_host(&dwsmmio->dws);\r\nreturn 0;\r\n}

static inline u32 lshift(u32 x, unsigned int s)\r\n{\r\nx &= 0xFFFFFFFF;\r\nreturn ((x << s) & 0xFFFFFFFF) | (x >> (32 - s));\r\n}\r\nstatic inline u32 F(u32 x, u32 y, u32 z)\r\n{\r\nreturn (x & y) | ((~x) & z);\r\n}\r\nstatic inline u32 G(u32 x, u32 y, u32 z)\r\n{\r\nreturn (x & y) | (x & z) | (y & z);\r\n}\r\nstatic inline u32 H(u32 x, u32 y, u32 z)\r\n{\r\nreturn x ^ y ^ z;\r\n}\r\nstatic inline void le32_to_cpu_array(u32 *buf, unsigned int words)\r\n{\r\nwhile (words--) {\r\n__le32_to_cpus(buf);\r\nbuf++;\r\n}\r\n}\r\nstatic inline void cpu_to_le32_array(u32 *buf, unsigned int words)\r\n{\r\nwhile (words--) {\r\n__cpu_to_le32s(buf);\r\nbuf++;\r\n}\r\n}\r\nstatic void md4_transform(u32 *hash, u32 const *in)\r\n{\r\nu32 a, b, c, d;\r\na = hash[0];\r\nb = hash[1];\r\nc = hash[2];\r\nd = hash[3];\r\nROUND1(a, b, c, d, in[0], 3);\r\nROUND1(d, a, b, c, in[1], 7);\r\nROUND1(c, d, a, b, in[2], 11);\r\nROUND1(b, c, d, a, in[3], 19);\r\nROUND1(a, b, c, d, in[4], 3);\r\nROUND1(d, a, b, c, in[5], 7);\r\nROUND1(c, d, a, b, in[6], 11);\r\nROUND1(b, c, d, a, in[7], 19);\r\nROUND1(a, b, c, d, in[8], 3);\r\nROUND1(d, a, b, c, in[9], 7);\r\nROUND1(c, d, a, b, in[10], 11);\r\nROUND1(b, c, d, a, in[11], 19);\r\nROUND1(a, b, c, d, in[12], 3);\r\nROUND1(d, a, b, c, in[13], 7);\r\nROUND1(c, d, a, b, in[14], 11);\r\nROUND1(b, c, d, a, in[15], 19);\r\nROUND2(a, b, c, d,in[ 0], 3);\r\nROUND2(d, a, b, c, in[4], 5);\r\nROUND2(c, d, a, b, in[8], 9);\r\nROUND2(b, c, d, a, in[12], 13);\r\nROUND2(a, b, c, d, in[1], 3);\r\nROUND2(d, a, b, c, in[5], 5);\r\nROUND2(c, d, a, b, in[9], 9);\r\nROUND2(b, c, d, a, in[13], 13);\r\nROUND2(a, b, c, d, in[2], 3);\r\nROUND2(d, a, b, c, in[6], 5);\r\nROUND2(c, d, a, b, in[10], 9);\r\nROUND2(b, c, d, a, in[14], 13);\r\nROUND2(a, b, c, d, in[3], 3);\r\nROUND2(d, a, b, c, in[7], 5);\r\nROUND2(c, d, a, b, in[11], 9);\r\nROUND2(b, c, d, a, in[15], 13);\r\nROUND3(a, b, c, d,in[ 0], 3);\r\nROUND3(d, a, b, c, in[8], 9);\r\nROUND3(c, d, a, b, in[4], 11);\r\nROUND3(b, c, d, a, in[12], 15);\r\nROUND3(a, b, c, d, in[2], 3);\r\nROUND3(d, a, b, c, in[10], 9);\r\nROUND3(c, d, a, b, in[6], 11);\r\nROUND3(b, c, d, a, in[14], 15);\r\nROUND3(a, b, c, d, in[1], 3);\r\nROUND3(d, a, b, c, in[9], 9);\r\nROUND3(c, d, a, b, in[5], 11);\r\nROUND3(b, c, d, a, in[13], 15);\r\nROUND3(a, b, c, d, in[3], 3);\r\nROUND3(d, a, b, c, in[11], 9);\r\nROUND3(c, d, a, b, in[7], 11);\r\nROUND3(b, c, d, a, in[15], 15);\r\nhash[0] += a;\r\nhash[1] += b;\r\nhash[2] += c;\r\nhash[3] += d;\r\n}\r\nstatic inline void md4_transform_helper(struct md4_ctx *ctx)\r\n{\r\nle32_to_cpu_array(ctx->block, ARRAY_SIZE(ctx->block));\r\nmd4_transform(ctx->hash, ctx->block);\r\n}\r\nstatic int md4_init(struct shash_desc *desc)\r\n{\r\nstruct md4_ctx *mctx = shash_desc_ctx(desc);\r\nmctx->hash[0] = 0x67452301;\r\nmctx->hash[1] = 0xefcdab89;\r\nmctx->hash[2] = 0x98badcfe;\r\nmctx->hash[3] = 0x10325476;\r\nmctx->byte_count = 0;\r\nreturn 0;\r\n}\r\nstatic int md4_update(struct shash_desc *desc, const u8 *data, unsigned int len)\r\n{\r\nstruct md4_ctx *mctx = shash_desc_ctx(desc);\r\nconst u32 avail = sizeof(mctx->block) - (mctx->byte_count & 0x3f);\r\nmctx->byte_count += len;\r\nif (avail > len) {\r\nmemcpy((char *)mctx->block + (sizeof(mctx->block) - avail),\r\ndata, len);\r\nreturn 0;\r\n}\r\nmemcpy((char *)mctx->block + (sizeof(mctx->block) - avail),\r\ndata, avail);\r\nmd4_transform_helper(mctx);\r\ndata += avail;\r\nlen -= avail;\r\nwhile (len >= sizeof(mctx->block)) {\r\nmemcpy(mctx->block, data, sizeof(mctx->block));\r\nmd4_transform_helper(mctx);\r\ndata += sizeof(mctx->block);\r\nlen -= sizeof(mctx->block);\r\n}\r\nmemcpy(mctx->block, data, len);\r\nreturn 0;\r\n}\r\nstatic int md4_final(struct shash_desc *desc, u8 *out)\r\n{\r\nstruct md4_ctx *mctx = shash_desc_ctx(desc);\r\nconst unsigned int offset = mctx->byte_count & 0x3f;\r\nchar *p = (char *)mctx->block + offset;\r\nint padding = 56 - (offset + 1);\r\n*p++ = 0x80;\r\nif (padding < 0) {\r\nmemset(p, 0x00, padding + sizeof (u64));\r\nmd4_transform_helper(mctx);\r\np = (char *)mctx->block;\r\npadding = 56;\r\n}\r\nmemset(p, 0, padding);\r\nmctx->block[14] = mctx->byte_count << 3;\r\nmctx->block[15] = mctx->byte_count >> 29;\r\nle32_to_cpu_array(mctx->block, (sizeof(mctx->block) -\r\nsizeof(u64)) / sizeof(u32));\r\nmd4_transform(mctx->hash, mctx->block);\r\ncpu_to_le32_array(mctx->hash, ARRAY_SIZE(mctx->hash));\r\nmemcpy(out, mctx->hash, sizeof(mctx->hash));\r\nmemset(mctx, 0, sizeof(*mctx));\r\nreturn 0;\r\n}\r\nstatic int __init md4_mod_init(void)\r\n{\r\nreturn crypto_register_shash(&alg);\r\n}\r\nstatic void __exit md4_mod_fini(void)\r\n{\r\ncrypto_unregister_shash(&alg);\r\n}

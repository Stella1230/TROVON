static void __init tx4927_wdr_init(void)\r\n{\r\nif (____raw_readq(&tx4927_ccfgptr->ccfg) & TX4927_CCFG_WDRST)\r\npr_warn("Watchdog reset detected at 0x%lx\n",\r\nread_c0_errorepc());\r\ntx4927_ccfg_set(TX4927_CCFG_WDRST);\r\ntx4927_ccfg_set(TX4927_CCFG_WR);\r\n}\r\nvoid __init tx4927_wdt_init(void)\r\n{\r\ntxx9_wdt_init(TX4927_TMR_REG(2) & 0xfffffffffULL);\r\n}\r\nstatic void tx4927_machine_restart(char *command)\r\n{\r\nlocal_irq_disable();\r\npr_emerg("Rebooting (with %s watchdog reset)...\n",\r\n(____raw_readq(&tx4927_ccfgptr->ccfg) & TX4927_CCFG_WDREXEN) ?\r\n"external" : "internal");\r\ntx4927_ccfg_set(TX4927_CCFG_WDRST);\r\ntxx9_wdt_now(TX4927_TMR_REG(2) & 0xfffffffffULL);\r\nwhile (!(____raw_readq(&tx4927_ccfgptr->ccfg) & TX4927_CCFG_WDRST))\r\n;\r\nmdelay(10);\r\nif (____raw_readq(&tx4927_ccfgptr->ccfg) & TX4927_CCFG_WDREXEN) {\r\npr_emerg("Rebooting (with internal watchdog reset)...\n");\r\ntx4927_ccfg_clear(TX4927_CCFG_WDREXEN);\r\n}\r\n(*_machine_halt)();\r\n}\r\nstatic int tx4927_be_handler(struct pt_regs *regs, int is_fixup)\r\n{\r\nint data = regs->cp0_cause & 4;\r\nconsole_verbose();\r\npr_err("%cBE exception at %#lx\n", data ? 'D' : 'I', regs->cp0_epc);\r\npr_err("ccfg:%llx, toea:%llx\n",\r\n(unsigned long long)____raw_readq(&tx4927_ccfgptr->ccfg),\r\n(unsigned long long)____raw_readq(&tx4927_ccfgptr->toea));\r\n#ifdef CONFIG_PCI\r\ntx4927_report_pcic_status();\r\n#endif\r\nshow_registers(regs);\r\npanic("BusError!");\r\n}\r\nstatic void __init tx4927_be_init(void)\r\n{\r\nboard_be_handler = tx4927_be_handler;\r\n}\r\nvoid __init tx4927_setup(void)\r\n{\r\nint i;\r\n__u32 divmode;\r\nunsigned int cpuclk = 0;\r\nu64 ccfg;\r\ntxx9_reg_res_init(TX4927_REV_PCODE(), TX4927_REG_BASE,\r\nTX4927_REG_SIZE);\r\nset_c0_config(TX49_CONF_CWFON);\r\nfor (i = 0; i < 8; i++) {\r\nif (!(TX4927_EBUSC_CR(i) & 0x8))\r\ncontinue;\r\ntxx9_ce_res[i].start = (unsigned long)TX4927_EBUSC_BA(i);\r\ntxx9_ce_res[i].end =\r\ntxx9_ce_res[i].start + TX4927_EBUSC_SIZE(i) - 1;\r\nrequest_resource(&iomem_resource, &txx9_ce_res[i]);\r\n}\r\nccfg = ____raw_readq(&tx4927_ccfgptr->ccfg);\r\nif (txx9_master_clock) {\r\ndivmode = (__u32)ccfg & TX4927_CCFG_DIVMODE_MASK;\r\nswitch (divmode) {\r\ncase TX4927_CCFG_DIVMODE_8:\r\ncase TX4927_CCFG_DIVMODE_10:\r\ncase TX4927_CCFG_DIVMODE_12:\r\ncase TX4927_CCFG_DIVMODE_16:\r\ntxx9_gbus_clock = txx9_master_clock * 4; break;\r\ndefault:\r\ntxx9_gbus_clock = txx9_master_clock;\r\n}\r\nswitch (divmode) {\r\ncase TX4927_CCFG_DIVMODE_2:\r\ncase TX4927_CCFG_DIVMODE_8:\r\ncpuclk = txx9_gbus_clock * 2; break;\r\ncase TX4927_CCFG_DIVMODE_2_5:\r\ncase TX4927_CCFG_DIVMODE_10:\r\ncpuclk = txx9_gbus_clock * 5 / 2; break;\r\ncase TX4927_CCFG_DIVMODE_3:\r\ncase TX4927_CCFG_DIVMODE_12:\r\ncpuclk = txx9_gbus_clock * 3; break;\r\ncase TX4927_CCFG_DIVMODE_4:\r\ncase TX4927_CCFG_DIVMODE_16:\r\ncpuclk = txx9_gbus_clock * 4; break;\r\n}\r\ntxx9_cpu_clock = cpuclk;\r\n} else {\r\nif (txx9_cpu_clock == 0)\r\ntxx9_cpu_clock = 200000000;\r\ncpuclk = txx9_cpu_clock;\r\ndivmode = (__u32)ccfg & TX4927_CCFG_DIVMODE_MASK;\r\nswitch (divmode) {\r\ncase TX4927_CCFG_DIVMODE_2:\r\ncase TX4927_CCFG_DIVMODE_8:\r\ntxx9_gbus_clock = cpuclk / 2; break;\r\ncase TX4927_CCFG_DIVMODE_2_5:\r\ncase TX4927_CCFG_DIVMODE_10:\r\ntxx9_gbus_clock = cpuclk * 2 / 5; break;\r\ncase TX4927_CCFG_DIVMODE_3:\r\ncase TX4927_CCFG_DIVMODE_12:\r\ntxx9_gbus_clock = cpuclk / 3; break;\r\ncase TX4927_CCFG_DIVMODE_4:\r\ncase TX4927_CCFG_DIVMODE_16:\r\ntxx9_gbus_clock = cpuclk / 4; break;\r\n}\r\nswitch (divmode) {\r\ncase TX4927_CCFG_DIVMODE_8:\r\ncase TX4927_CCFG_DIVMODE_10:\r\ncase TX4927_CCFG_DIVMODE_12:\r\ncase TX4927_CCFG_DIVMODE_16:\r\ntxx9_master_clock = txx9_gbus_clock / 4; break;\r\ndefault:\r\ntxx9_master_clock = txx9_gbus_clock;\r\n}\r\n}\r\nloops_per_jiffy = txx9_cpu_clock / HZ / 2;\r\ntx4927_wdr_init();\r\ntx4927_ccfg_set(TX4927_CCFG_BEOW);\r\nif (txx9_ccfg_toeon)\r\ntx4927_ccfg_set(TX4927_CCFG_TOE);\r\ntxx9_clear64(&tx4927_ccfgptr->pcfg, TX4927_PCFG_DMASEL_ALL);\r\nif (!(____raw_readq(&tx4927_ccfgptr->ccfg) & TX4927_CCFG_PCIARB))\r\ntxx9_clear64(&tx4927_ccfgptr->pcfg, TX4927_PCFG_PCICLKEN_ALL);\r\nprintk(KERN_INFO "%s -- %dMHz(M%dMHz) CRIR:%08x CCFG:%llx PCFG:%llx\n",\r\ntxx9_pcode_str,\r\n(cpuclk + 500000) / 1000000,\r\n(txx9_master_clock + 500000) / 1000000,\r\n(__u32)____raw_readq(&tx4927_ccfgptr->crir),\r\n(unsigned long long)____raw_readq(&tx4927_ccfgptr->ccfg),\r\n(unsigned long long)____raw_readq(&tx4927_ccfgptr->pcfg));\r\nprintk(KERN_INFO "%s SDRAMC --", txx9_pcode_str);\r\nfor (i = 0; i < 4; i++) {\r\n__u64 cr = TX4927_SDRAMC_CR(i);\r\nunsigned long base, size;\r\nif (!((__u32)cr & 0x00000400))\r\ncontinue;\r\nbase = (unsigned long)(cr >> 49) << 21;\r\nsize = (((unsigned long)(cr >> 33) & 0x7fff) + 1) << 21;\r\nprintk(" CR%d:%016llx", i, (unsigned long long)cr);\r\ntx4927_sdram_resource[i].name = "SDRAM";\r\ntx4927_sdram_resource[i].start = base;\r\ntx4927_sdram_resource[i].end = base + size - 1;\r\ntx4927_sdram_resource[i].flags = IORESOURCE_MEM;\r\nrequest_resource(&iomem_resource, &tx4927_sdram_resource[i]);\r\n}\r\nprintk(" TR:%09llx\n",\r\n(unsigned long long)____raw_readq(&tx4927_sdramcptr->tr));\r\nfor (i = 0; i < TX4927_NR_TMR; i++)\r\ntxx9_tmr_init(TX4927_TMR_REG(i) & 0xfffffffffULL);\r\ntxx9_gpio_init(TX4927_PIO_REG & 0xfffffffffULL, 0, TX4927_NUM_PIO);\r\n__raw_writel(0, &tx4927_pioptr->maskcpu);\r\n__raw_writel(0, &tx4927_pioptr->maskext);\r\n_machine_restart = tx4927_machine_restart;\r\nboard_be_init = tx4927_be_init;\r\n}\r\nvoid __init tx4927_time_init(unsigned int tmrnr)\r\n{\r\nif (____raw_readq(&tx4927_ccfgptr->ccfg) & TX4927_CCFG_TINTDIS)\r\ntxx9_clockevent_init(TX4927_TMR_REG(tmrnr) & 0xfffffffffULL,\r\nTXX9_IRQ_BASE + TX4927_IR_TMR(tmrnr),\r\nTXX9_IMCLK);\r\n}\r\nvoid __init tx4927_sio_init(unsigned int sclk, unsigned int cts_mask)\r\n{\r\nint i;\r\nfor (i = 0; i < 2; i++)\r\ntxx9_sio_init(TX4927_SIO_REG(i) & 0xfffffffffULL,\r\nTXX9_IRQ_BASE + TX4927_IR_SIO(i),\r\ni, sclk, (1 << i) & cts_mask);\r\n}\r\nvoid __init tx4927_mtd_init(int ch)\r\n{\r\nstruct physmap_flash_data pdata = {\r\n.width = TX4927_EBUSC_WIDTH(ch) / 8,\r\n};\r\nunsigned long start = txx9_ce_res[ch].start;\r\nunsigned long size = txx9_ce_res[ch].end - start + 1;\r\nif (!(TX4927_EBUSC_CR(ch) & 0x8))\r\nreturn;\r\ntxx9_physmap_flash_init(ch, start, size, &pdata);\r\n}\r\nvoid __init tx4927_dmac_init(int memcpy_chan)\r\n{\r\nstruct txx9dmac_platform_data plat_data = {\r\n.memcpy_chan = memcpy_chan,\r\n.have_64bit_regs = true,\r\n};\r\ntxx9_dmac_init(0, TX4927_DMA_REG & 0xfffffffffULL,\r\nTXX9_IRQ_BASE + TX4927_IR_DMA(0), &plat_data);\r\n}\r\nvoid __init tx4927_aclc_init(unsigned int dma_chan_out,\r\nunsigned int dma_chan_in)\r\n{\r\nu64 pcfg = __raw_readq(&tx4927_ccfgptr->pcfg);\r\n__u64 dmasel_mask = 0, dmasel = 0;\r\nunsigned long flags;\r\nif (!(pcfg & TX4927_PCFG_SEL2))\r\nreturn;\r\nswitch (dma_chan_out) {\r\ncase 0:\r\ndmasel_mask |= TX4927_PCFG_DMASEL0_MASK;\r\ndmasel |= TX4927_PCFG_DMASEL0_ACL0;\r\nbreak;\r\ncase 2:\r\ndmasel_mask |= TX4927_PCFG_DMASEL2_MASK;\r\ndmasel |= TX4927_PCFG_DMASEL2_ACL0;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nswitch (dma_chan_in) {\r\ncase 1:\r\ndmasel_mask |= TX4927_PCFG_DMASEL1_MASK;\r\ndmasel |= TX4927_PCFG_DMASEL1_ACL1;\r\nbreak;\r\ncase 3:\r\ndmasel_mask |= TX4927_PCFG_DMASEL3_MASK;\r\ndmasel |= TX4927_PCFG_DMASEL3_ACL1;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nlocal_irq_save(flags);\r\ntxx9_clear64(&tx4927_ccfgptr->pcfg, dmasel_mask);\r\ntxx9_set64(&tx4927_ccfgptr->pcfg, dmasel);\r\nlocal_irq_restore(flags);\r\ntxx9_aclc_init(TX4927_ACLC_REG & 0xfffffffffULL,\r\nTXX9_IRQ_BASE + TX4927_IR_ACLC,\r\n0, dma_chan_out, dma_chan_in);\r\n}\r\nstatic void __init tx4927_stop_unused_modules(void)\r\n{\r\n__u64 pcfg, rst = 0, ckd = 0;\r\nchar buf[128];\r\nbuf[0] = '\0';\r\nlocal_irq_disable();\r\npcfg = ____raw_readq(&tx4927_ccfgptr->pcfg);\r\nif (!(pcfg & TX4927_PCFG_SEL2)) {\r\nrst |= TX4927_CLKCTR_ACLRST;\r\nckd |= TX4927_CLKCTR_ACLCKD;\r\nstrcat(buf, " ACLC");\r\n}\r\nif (rst | ckd) {\r\ntxx9_set64(&tx4927_ccfgptr->clkctr, rst);\r\ntxx9_set64(&tx4927_ccfgptr->clkctr, ckd);\r\n}\r\nlocal_irq_enable();\r\nif (buf[0])\r\npr_info("%s: stop%s\n", txx9_pcode_str, buf);\r\n}\r\nstatic int __init tx4927_late_init(void)\r\n{\r\nif (txx9_pcode != 0x4927)\r\nreturn -ENODEV;\r\ntx4927_stop_unused_modules();\r\nreturn 0;\r\n}

static void parisc_linux_get_fpu_type(u_int fpregs[])\r\n{\r\nif (boot_cpu_data.cpu_type == pcxs)\r\nfpregs[FPU_TYPE_FLAG_POS] = TIMEX_EXTEN_FLAG;\r\nelse if (boot_cpu_data.cpu_type == pcxt ||\r\nboot_cpu_data.cpu_type == pcxt_)\r\nfpregs[FPU_TYPE_FLAG_POS] = ROLEX_EXTEN_FLAG;\r\nelse if (boot_cpu_data.cpu_type >= pcxu)\r\nfpregs[FPU_TYPE_FLAG_POS] = PA2_0_FPU_FLAG;\r\n}\r\nu_int\r\nfpudispatch(u_int ir, u_int excp_code, u_int holder, u_int fpregs[])\r\n{\r\nu_int class, subop;\r\nu_int fpu_type_flags;\r\nVASSERT(sizeof(int) == 4);\r\nparisc_linux_get_fpu_type(fpregs);\r\nfpu_type_flags=fpregs[FPU_TYPE_FLAG_POS];\r\nclass = get_class(ir);\r\nif (class == 1) {\r\nif (fpu_type_flags & PA2_0_FPU_FLAG)\r\nsubop = get_subop1_PA2_0(ir);\r\nelse\r\nsubop = get_subop1_PA1_1(ir);\r\n}\r\nelse\r\nsubop = get_subop(ir);\r\nif (FPUDEBUG) printk("class %d subop %d\n", class, subop);\r\nswitch (excp_code) {\r\ncase MAJOR_0C_EXCP:\r\ncase PA83_UNIMP_EXCP:\r\nreturn(decode_0c(ir,class,subop,fpregs));\r\ncase MAJOR_0E_EXCP:\r\nreturn(decode_0e(ir,class,subop,fpregs));\r\ncase MAJOR_06_EXCP:\r\nreturn(decode_06(ir,fpregs));\r\ncase MAJOR_26_EXCP:\r\nreturn(decode_26(ir,fpregs));\r\ncase MAJOR_2E_EXCP:\r\nreturn(decode_2e(ir,fpregs));\r\ndefault:\r\nreturn(UNIMPLEMENTEDEXCEPTION);\r\n}\r\n}\r\nu_int\r\nemfpudispatch(u_int ir, u_int dummy1, u_int dummy2, u_int fpregs[])\r\n{\r\nu_int class, subop, major;\r\nu_int fpu_type_flags;\r\nVASSERT(sizeof(int) == 4);\r\nfpu_type_flags=fpregs[FPU_TYPE_FLAG_POS];\r\nmajor = get_major(ir);\r\nclass = get_class(ir);\r\nif (class == 1) {\r\nif (fpu_type_flags & PA2_0_FPU_FLAG)\r\nsubop = get_subop1_PA2_0(ir);\r\nelse\r\nsubop = get_subop1_PA1_1(ir);\r\n}\r\nelse\r\nsubop = get_subop(ir);\r\nswitch (major) {\r\ncase 0x0C:\r\nreturn(decode_0c(ir,class,subop,fpregs));\r\ncase 0x0E:\r\nreturn(decode_0e(ir,class,subop,fpregs));\r\ncase 0x06:\r\nreturn(decode_06(ir,fpregs));\r\ncase 0x26:\r\nreturn(decode_26(ir,fpregs));\r\ncase 0x2E:\r\nreturn(decode_2e(ir,fpregs));\r\ndefault:\r\nreturn(PA83_UNIMP_EXCP);\r\n}\r\n}\r\nstatic u_int\r\ndecode_0c(u_int ir, u_int class, u_int subop, u_int fpregs[])\r\n{\r\nu_int r1,r2,t;\r\nu_int fmt;\r\nu_int df;\r\nu_int *status;\r\nu_int retval, local_status;\r\nu_int fpu_type_flags;\r\nif (ir == COPR_INST) {\r\nfpregs[0] = EMULATION_VERSION << 11;\r\nreturn(NOEXCEPTION);\r\n}\r\nstatus = &fpregs[0];\r\nlocal_status = fpregs[0];\r\nr1 = extru(ir,fpr1pos,5) * sizeof(double)/sizeof(u_int);\r\nif (r1 == 0)\r\nr1 = fpzeroreg;\r\nt = extru(ir,fptpos,5) * sizeof(double)/sizeof(u_int);\r\nif (t == 0 && class != 2)\r\nreturn(MAJOR_0C_EXCP);\r\nfmt = extru(ir,fpfmtpos,2);\r\nswitch (class) {\r\ncase 0:\r\nswitch (subop) {\r\ncase 0:\r\ncase 1:\r\nreturn(MAJOR_0C_EXCP);\r\ncase 2:\r\nswitch (fmt) {\r\ncase 2:\r\nreturn(MAJOR_0C_EXCP);\r\ncase 3:\r\nt &= ~3;\r\nr1 &= ~3;\r\nfpregs[t+3] = fpregs[r1+3];\r\nfpregs[t+2] = fpregs[r1+2];\r\ncase 1:\r\nfpregs[t+1] = fpregs[r1+1];\r\ncase 0:\r\nfpregs[t] = fpregs[r1];\r\nreturn(NOEXCEPTION);\r\n}\r\ncase 3:\r\nswitch (fmt) {\r\ncase 2:\r\nreturn(MAJOR_0C_EXCP);\r\ncase 3:\r\nt &= ~3;\r\nr1 &= ~3;\r\nfpregs[t+3] = fpregs[r1+3];\r\nfpregs[t+2] = fpregs[r1+2];\r\ncase 1:\r\nfpregs[t+1] = fpregs[r1+1];\r\ncase 0:\r\nfpregs[t] = fpregs[r1] & 0x7fffffff;\r\nreturn(NOEXCEPTION);\r\n}\r\ncase 6:\r\nswitch (fmt) {\r\ncase 2:\r\nreturn(MAJOR_0C_EXCP);\r\ncase 3:\r\nt &= ~3;\r\nr1 &= ~3;\r\nfpregs[t+3] = fpregs[r1+3];\r\nfpregs[t+2] = fpregs[r1+2];\r\ncase 1:\r\nfpregs[t+1] = fpregs[r1+1];\r\ncase 0:\r\nfpregs[t] = fpregs[r1] ^ 0x80000000;\r\nreturn(NOEXCEPTION);\r\n}\r\ncase 7:\r\nswitch (fmt) {\r\ncase 2:\r\nreturn(MAJOR_0C_EXCP);\r\ncase 3:\r\nt &= ~3;\r\nr1 &= ~3;\r\nfpregs[t+3] = fpregs[r1+3];\r\nfpregs[t+2] = fpregs[r1+2];\r\ncase 1:\r\nfpregs[t+1] = fpregs[r1+1];\r\ncase 0:\r\nfpregs[t] = fpregs[r1] | 0x80000000;\r\nreturn(NOEXCEPTION);\r\n}\r\ncase 4:\r\nswitch (fmt) {\r\ncase 0:\r\nreturn(sgl_fsqrt(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 1:\r\nreturn(dbl_fsqrt(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 2:\r\ncase 3:\r\nreturn(MAJOR_0C_EXCP);\r\n}\r\ncase 5:\r\nswitch (fmt) {\r\ncase 0:\r\nreturn(sgl_frnd(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 1:\r\nreturn(dbl_frnd(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 2:\r\ncase 3:\r\nreturn(MAJOR_0C_EXCP);\r\n}\r\n}\r\ncase 1:\r\ndf = extru(ir,fpdfpos,2);\r\nif ((df & 2) || (fmt & 2)) {\r\nreturn(MAJOR_0C_EXCP);\r\n}\r\nfmt = (fmt << 1) | df;\r\nswitch (subop) {\r\ncase 0:\r\nswitch(fmt) {\r\ncase 0:\r\nreturn(MAJOR_0C_EXCP);\r\ncase 1:\r\nreturn(sgl_to_dbl_fcnvff(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 2:\r\nreturn(dbl_to_sgl_fcnvff(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 3:\r\nreturn(MAJOR_0C_EXCP);\r\n}\r\ncase 1:\r\nswitch(fmt) {\r\ncase 0:\r\nreturn(sgl_to_sgl_fcnvxf(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 1:\r\nreturn(sgl_to_dbl_fcnvxf(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 2:\r\nreturn(dbl_to_sgl_fcnvxf(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 3:\r\nreturn(dbl_to_dbl_fcnvxf(&fpregs[r1],0,\r\n&fpregs[t],status));\r\n}\r\ncase 2:\r\nswitch(fmt) {\r\ncase 0:\r\nreturn(sgl_to_sgl_fcnvfx(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 1:\r\nreturn(sgl_to_dbl_fcnvfx(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 2:\r\nreturn(dbl_to_sgl_fcnvfx(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 3:\r\nreturn(dbl_to_dbl_fcnvfx(&fpregs[r1],0,\r\n&fpregs[t],status));\r\n}\r\ncase 3:\r\nswitch(fmt) {\r\ncase 0:\r\nreturn(sgl_to_sgl_fcnvfxt(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 1:\r\nreturn(sgl_to_dbl_fcnvfxt(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 2:\r\nreturn(dbl_to_sgl_fcnvfxt(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 3:\r\nreturn(dbl_to_dbl_fcnvfxt(&fpregs[r1],0,\r\n&fpregs[t],status));\r\n}\r\ncase 5:\r\nswitch(fmt) {\r\ncase 0:\r\nreturn(sgl_to_sgl_fcnvuf(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 1:\r\nreturn(sgl_to_dbl_fcnvuf(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 2:\r\nreturn(dbl_to_sgl_fcnvuf(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 3:\r\nreturn(dbl_to_dbl_fcnvuf(&fpregs[r1],0,\r\n&fpregs[t],status));\r\n}\r\ncase 6:\r\nswitch(fmt) {\r\ncase 0:\r\nreturn(sgl_to_sgl_fcnvfu(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 1:\r\nreturn(sgl_to_dbl_fcnvfu(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 2:\r\nreturn(dbl_to_sgl_fcnvfu(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 3:\r\nreturn(dbl_to_dbl_fcnvfu(&fpregs[r1],0,\r\n&fpregs[t],status));\r\n}\r\ncase 7:\r\nswitch(fmt) {\r\ncase 0:\r\nreturn(sgl_to_sgl_fcnvfut(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 1:\r\nreturn(sgl_to_dbl_fcnvfut(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 2:\r\nreturn(dbl_to_sgl_fcnvfut(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 3:\r\nreturn(dbl_to_dbl_fcnvfut(&fpregs[r1],0,\r\n&fpregs[t],status));\r\n}\r\ncase 4:\r\nreturn(MAJOR_0C_EXCP);\r\n}\r\ncase 2:\r\nfpu_type_flags=fpregs[FPU_TYPE_FLAG_POS];\r\nr2 = extru(ir, fpr2pos, 5) * sizeof(double)/sizeof(u_int);\r\nif (r2 == 0)\r\nr2 = fpzeroreg;\r\nif (fpu_type_flags & PA2_0_FPU_FLAG) {\r\nif (extru(ir, fpnulpos, 1)) {\r\nswitch (fmt) {\r\ncase 0:\r\nBUG();\r\ncase 1:\r\ncase 2:\r\ncase 3:\r\nreturn(MAJOR_0C_EXCP);\r\n}\r\n} else {\r\nswitch (fmt) {\r\ncase 0:\r\nretval = sgl_fcmp(&fpregs[r1],\r\n&fpregs[r2],extru(ir,fptpos,5),\r\n&local_status);\r\nupdate_status_cbit(status,local_status,\r\nfpu_type_flags, subop);\r\nreturn(retval);\r\ncase 1:\r\nretval = dbl_fcmp(&fpregs[r1],\r\n&fpregs[r2],extru(ir,fptpos,5),\r\n&local_status);\r\nupdate_status_cbit(status,local_status,\r\nfpu_type_flags, subop);\r\nreturn(retval);\r\ncase 2:\r\ncase 3:\r\nreturn(MAJOR_0C_EXCP);\r\n}\r\n}\r\n}\r\nelse {\r\nswitch (subop) {\r\ncase 2:\r\ncase 3:\r\ncase 4:\r\ncase 5:\r\ncase 6:\r\ncase 7:\r\nreturn(MAJOR_0C_EXCP);\r\ncase 0:\r\nswitch (fmt) {\r\ncase 0:\r\nretval = sgl_fcmp(&fpregs[r1],\r\n&fpregs[r2],extru(ir,fptpos,5),\r\n&local_status);\r\nupdate_status_cbit(status,local_status,\r\nfpu_type_flags, subop);\r\nreturn(retval);\r\ncase 1:\r\nretval = dbl_fcmp(&fpregs[r1],\r\n&fpregs[r2],extru(ir,fptpos,5),\r\n&local_status);\r\nupdate_status_cbit(status,local_status,\r\nfpu_type_flags, subop);\r\nreturn(retval);\r\ncase 2:\r\ncase 3:\r\nreturn(MAJOR_0C_EXCP);\r\n}\r\ncase 1:\r\nswitch (fmt) {\r\ncase 0:\r\nBUG();\r\ncase 1:\r\ncase 2:\r\ncase 3:\r\nreturn(MAJOR_0C_EXCP);\r\n}\r\n}\r\n}\r\ncase 3:\r\nr2 = extru(ir,fpr2pos,5) * sizeof(double)/sizeof(u_int);\r\nif (r2 == 0)\r\nr2 = fpzeroreg;\r\nswitch (subop) {\r\ncase 5:\r\ncase 6:\r\ncase 7:\r\nreturn(MAJOR_0C_EXCP);\r\ncase 0:\r\nswitch (fmt) {\r\ncase 0:\r\nreturn(sgl_fadd(&fpregs[r1],&fpregs[r2],\r\n&fpregs[t],status));\r\ncase 1:\r\nreturn(dbl_fadd(&fpregs[r1],&fpregs[r2],\r\n&fpregs[t],status));\r\ncase 2:\r\ncase 3:\r\nreturn(MAJOR_0C_EXCP);\r\n}\r\ncase 1:\r\nswitch (fmt) {\r\ncase 0:\r\nreturn(sgl_fsub(&fpregs[r1],&fpregs[r2],\r\n&fpregs[t],status));\r\ncase 1:\r\nreturn(dbl_fsub(&fpregs[r1],&fpregs[r2],\r\n&fpregs[t],status));\r\ncase 2:\r\ncase 3:\r\nreturn(MAJOR_0C_EXCP);\r\n}\r\ncase 2:\r\nswitch (fmt) {\r\ncase 0:\r\nreturn(sgl_fmpy(&fpregs[r1],&fpregs[r2],\r\n&fpregs[t],status));\r\ncase 1:\r\nreturn(dbl_fmpy(&fpregs[r1],&fpregs[r2],\r\n&fpregs[t],status));\r\ncase 2:\r\ncase 3:\r\nreturn(MAJOR_0C_EXCP);\r\n}\r\ncase 3:\r\nswitch (fmt) {\r\ncase 0:\r\nreturn(sgl_fdiv(&fpregs[r1],&fpregs[r2],\r\n&fpregs[t],status));\r\ncase 1:\r\nreturn(dbl_fdiv(&fpregs[r1],&fpregs[r2],\r\n&fpregs[t],status));\r\ncase 2:\r\ncase 3:\r\nreturn(MAJOR_0C_EXCP);\r\n}\r\ncase 4:\r\nswitch (fmt) {\r\ncase 0:\r\nreturn(sgl_frem(&fpregs[r1],&fpregs[r2],\r\n&fpregs[t],status));\r\ncase 1:\r\nreturn(dbl_frem(&fpregs[r1],&fpregs[r2],\r\n&fpregs[t],status));\r\ncase 2:\r\ncase 3:\r\nreturn(MAJOR_0C_EXCP);\r\n}\r\n}\r\n}\r\nreturn(MAJOR_0C_EXCP);\r\n}\r\nstatic u_int\r\ndecode_0e(ir,class,subop,fpregs)\r\nu_int ir,class,subop;\r\nu_int fpregs[];\r\n{\r\nu_int r1,r2,t;\r\nu_int fmt;\r\nu_int df;\r\nu_int *status;\r\nu_int retval, local_status;\r\nu_int fpu_type_flags;\r\nstatus = &fpregs[0];\r\nlocal_status = fpregs[0];\r\nr1 = ((extru(ir,fpr1pos,5)<<1)|(extru(ir,fpxr1pos,1)));\r\nif (r1 == 0)\r\nr1 = fpzeroreg;\r\nt = ((extru(ir,fptpos,5)<<1)|(extru(ir,fpxtpos,1)));\r\nif (t == 0 && class != 2)\r\nreturn(MAJOR_0E_EXCP);\r\nif (class < 2)\r\nfmt = extru(ir,fpfmtpos,2);\r\nelse\r\nfmt = extru(ir,fp0efmtpos,1);\r\nif (fmt == DBL) {\r\nr1 &= ~1;\r\nif (class != 1)\r\nt &= ~1;\r\n}\r\nswitch (class) {\r\ncase 0:\r\nswitch (subop) {\r\ncase 0:\r\ncase 1:\r\nreturn(MAJOR_0E_EXCP);\r\ncase 2:\r\nswitch (fmt) {\r\ncase 2:\r\ncase 3:\r\nreturn(MAJOR_0E_EXCP);\r\ncase 1:\r\nfpregs[t+1] = fpregs[r1+1];\r\ncase 0:\r\nfpregs[t] = fpregs[r1];\r\nreturn(NOEXCEPTION);\r\n}\r\ncase 3:\r\nswitch (fmt) {\r\ncase 2:\r\ncase 3:\r\nreturn(MAJOR_0E_EXCP);\r\ncase 1:\r\nfpregs[t+1] = fpregs[r1+1];\r\ncase 0:\r\nfpregs[t] = fpregs[r1] & 0x7fffffff;\r\nreturn(NOEXCEPTION);\r\n}\r\ncase 6:\r\nswitch (fmt) {\r\ncase 2:\r\ncase 3:\r\nreturn(MAJOR_0E_EXCP);\r\ncase 1:\r\nfpregs[t+1] = fpregs[r1+1];\r\ncase 0:\r\nfpregs[t] = fpregs[r1] ^ 0x80000000;\r\nreturn(NOEXCEPTION);\r\n}\r\ncase 7:\r\nswitch (fmt) {\r\ncase 2:\r\ncase 3:\r\nreturn(MAJOR_0E_EXCP);\r\ncase 1:\r\nfpregs[t+1] = fpregs[r1+1];\r\ncase 0:\r\nfpregs[t] = fpregs[r1] | 0x80000000;\r\nreturn(NOEXCEPTION);\r\n}\r\ncase 4:\r\nswitch (fmt) {\r\ncase 0:\r\nreturn(sgl_fsqrt(&fpregs[r1],0,\r\n&fpregs[t], status));\r\ncase 1:\r\nreturn(dbl_fsqrt(&fpregs[r1],0,\r\n&fpregs[t], status));\r\ncase 2:\r\ncase 3:\r\nreturn(MAJOR_0E_EXCP);\r\n}\r\ncase 5:\r\nswitch (fmt) {\r\ncase 0:\r\nreturn(sgl_frnd(&fpregs[r1],0,\r\n&fpregs[t], status));\r\ncase 1:\r\nreturn(dbl_frnd(&fpregs[r1],0,\r\n&fpregs[t], status));\r\ncase 2:\r\ncase 3:\r\nreturn(MAJOR_0E_EXCP);\r\n}\r\n}\r\ncase 1:\r\ndf = extru(ir,fpdfpos,2);\r\nif (df == DBL) {\r\nt &= ~1;\r\n}\r\nif ((df & 2) || (fmt & 2))\r\nreturn(MAJOR_0E_EXCP);\r\nfmt = (fmt << 1) | df;\r\nswitch (subop) {\r\ncase 0:\r\nswitch(fmt) {\r\ncase 0:\r\nreturn(MAJOR_0E_EXCP);\r\ncase 1:\r\nreturn(sgl_to_dbl_fcnvff(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 2:\r\nreturn(dbl_to_sgl_fcnvff(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 3:\r\nreturn(MAJOR_0E_EXCP);\r\n}\r\ncase 1:\r\nswitch(fmt) {\r\ncase 0:\r\nreturn(sgl_to_sgl_fcnvxf(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 1:\r\nreturn(sgl_to_dbl_fcnvxf(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 2:\r\nreturn(dbl_to_sgl_fcnvxf(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 3:\r\nreturn(dbl_to_dbl_fcnvxf(&fpregs[r1],0,\r\n&fpregs[t],status));\r\n}\r\ncase 2:\r\nswitch(fmt) {\r\ncase 0:\r\nreturn(sgl_to_sgl_fcnvfx(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 1:\r\nreturn(sgl_to_dbl_fcnvfx(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 2:\r\nreturn(dbl_to_sgl_fcnvfx(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 3:\r\nreturn(dbl_to_dbl_fcnvfx(&fpregs[r1],0,\r\n&fpregs[t],status));\r\n}\r\ncase 3:\r\nswitch(fmt) {\r\ncase 0:\r\nreturn(sgl_to_sgl_fcnvfxt(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 1:\r\nreturn(sgl_to_dbl_fcnvfxt(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 2:\r\nreturn(dbl_to_sgl_fcnvfxt(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 3:\r\nreturn(dbl_to_dbl_fcnvfxt(&fpregs[r1],0,\r\n&fpregs[t],status));\r\n}\r\ncase 5:\r\nswitch(fmt) {\r\ncase 0:\r\nreturn(sgl_to_sgl_fcnvuf(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 1:\r\nreturn(sgl_to_dbl_fcnvuf(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 2:\r\nreturn(dbl_to_sgl_fcnvuf(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 3:\r\nreturn(dbl_to_dbl_fcnvuf(&fpregs[r1],0,\r\n&fpregs[t],status));\r\n}\r\ncase 6:\r\nswitch(fmt) {\r\ncase 0:\r\nreturn(sgl_to_sgl_fcnvfu(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 1:\r\nreturn(sgl_to_dbl_fcnvfu(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 2:\r\nreturn(dbl_to_sgl_fcnvfu(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 3:\r\nreturn(dbl_to_dbl_fcnvfu(&fpregs[r1],0,\r\n&fpregs[t],status));\r\n}\r\ncase 7:\r\nswitch(fmt) {\r\ncase 0:\r\nreturn(sgl_to_sgl_fcnvfut(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 1:\r\nreturn(sgl_to_dbl_fcnvfut(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 2:\r\nreturn(dbl_to_sgl_fcnvfut(&fpregs[r1],0,\r\n&fpregs[t],status));\r\ncase 3:\r\nreturn(dbl_to_dbl_fcnvfut(&fpregs[r1],0,\r\n&fpregs[t],status));\r\n}\r\ncase 4:\r\nreturn(MAJOR_0C_EXCP);\r\n}\r\ncase 2:\r\nif (fmt == DBL)\r\nr2 = (extru(ir,fpr2pos,5)<<1);\r\nelse\r\nr2 = ((extru(ir,fpr2pos,5)<<1)|(extru(ir,fpxr2pos,1)));\r\nfpu_type_flags=fpregs[FPU_TYPE_FLAG_POS];\r\nif (r2 == 0)\r\nr2 = fpzeroreg;\r\nif (fpu_type_flags & PA2_0_FPU_FLAG) {\r\nif (extru(ir, fpnulpos, 1)) {\r\nreturn(MAJOR_0E_EXCP);\r\n} else {\r\nswitch (fmt) {\r\ncase 0:\r\nretval = sgl_fcmp(&fpregs[r1],\r\n&fpregs[r2],extru(ir,fptpos,5),\r\n&local_status);\r\nupdate_status_cbit(status,local_status,\r\nfpu_type_flags, subop);\r\nreturn(retval);\r\ncase 1:\r\nretval = dbl_fcmp(&fpregs[r1],\r\n&fpregs[r2],extru(ir,fptpos,5),\r\n&local_status);\r\nupdate_status_cbit(status,local_status,\r\nfpu_type_flags, subop);\r\nreturn(retval);\r\n}\r\n}\r\n}\r\nelse {\r\nswitch (subop) {\r\ncase 1:\r\ncase 2:\r\ncase 3:\r\ncase 4:\r\ncase 5:\r\ncase 6:\r\ncase 7:\r\nreturn(MAJOR_0E_EXCP);\r\ncase 0:\r\nswitch (fmt) {\r\ncase 0:\r\nretval = sgl_fcmp(&fpregs[r1],\r\n&fpregs[r2],extru(ir,fptpos,5),\r\n&local_status);\r\nupdate_status_cbit(status,local_status,\r\nfpu_type_flags, subop);\r\nreturn(retval);\r\ncase 1:\r\nretval = dbl_fcmp(&fpregs[r1],\r\n&fpregs[r2],extru(ir,fptpos,5),\r\n&local_status);\r\nupdate_status_cbit(status,local_status,\r\nfpu_type_flags, subop);\r\nreturn(retval);\r\n}\r\n}\r\n}\r\ncase 3:\r\nif (fmt == DBL)\r\nr2 = (extru(ir,fpr2pos,5)<<1);\r\nelse\r\nr2 = ((extru(ir,fpr2pos,5)<<1)|(extru(ir,fpxr2pos,1)));\r\nif (r2 == 0)\r\nr2 = fpzeroreg;\r\nswitch (subop) {\r\ncase 5:\r\ncase 6:\r\ncase 7:\r\nreturn(MAJOR_0E_EXCP);\r\ncase 0:\r\nswitch (fmt) {\r\ncase 0:\r\nreturn(sgl_fadd(&fpregs[r1],&fpregs[r2],\r\n&fpregs[t],status));\r\ncase 1:\r\nreturn(dbl_fadd(&fpregs[r1],&fpregs[r2],\r\n&fpregs[t],status));\r\n}\r\ncase 1:\r\nswitch (fmt) {\r\ncase 0:\r\nreturn(sgl_fsub(&fpregs[r1],&fpregs[r2],\r\n&fpregs[t],status));\r\ncase 1:\r\nreturn(dbl_fsub(&fpregs[r1],&fpregs[r2],\r\n&fpregs[t],status));\r\n}\r\ncase 2:\r\nif (extru(ir,fpxpos,1)) {\r\nswitch (fmt) {\r\ncase 0:\r\nif (t & 1)\r\nreturn(MAJOR_0E_EXCP);\r\nBUG();\r\nreturn(NOEXCEPTION);\r\ncase 1:\r\nreturn(MAJOR_0E_EXCP);\r\n}\r\n}\r\nelse {\r\nswitch (fmt) {\r\ncase 0:\r\nreturn(sgl_fmpy(&fpregs[r1],\r\n&fpregs[r2],&fpregs[t],status));\r\ncase 1:\r\nreturn(dbl_fmpy(&fpregs[r1],\r\n&fpregs[r2],&fpregs[t],status));\r\n}\r\n}\r\ncase 3:\r\nswitch (fmt) {\r\ncase 0:\r\nreturn(sgl_fdiv(&fpregs[r1],&fpregs[r2],\r\n&fpregs[t],status));\r\ncase 1:\r\nreturn(dbl_fdiv(&fpregs[r1],&fpregs[r2],\r\n&fpregs[t],status));\r\n}\r\ncase 4:\r\nswitch (fmt) {\r\ncase 0:\r\nreturn(sgl_frem(&fpregs[r1],&fpregs[r2],\r\n&fpregs[t],status));\r\ncase 1:\r\nreturn(dbl_frem(&fpregs[r1],&fpregs[r2],\r\n&fpregs[t],status));\r\n}\r\n}\r\n}\r\nreturn(MAJOR_0E_EXCP);\r\n}\r\nstatic u_int\r\ndecode_06(ir,fpregs)\r\nu_int ir;\r\nu_int fpregs[];\r\n{\r\nu_int rm1, rm2, tm, ra, ta;\r\nu_int fmt;\r\nu_int error = 0;\r\nu_int status;\r\nu_int fpu_type_flags;\r\nunion {\r\ndouble dbl;\r\nfloat flt;\r\nstruct { u_int i1; u_int i2; } ints;\r\n} mtmp, atmp;\r\nstatus = fpregs[0];\r\nfpu_type_flags=fpregs[FPU_TYPE_FLAG_POS];\r\nfmt = extru(ir, fpmultifmt, 1);\r\nif (fmt == 0) {\r\nrm1 = extru(ir, fprm1pos, 5) * sizeof(double)/sizeof(u_int);\r\nif (rm1 == 0)\r\nrm1 = fpzeroreg;\r\nrm2 = extru(ir, fprm2pos, 5) * sizeof(double)/sizeof(u_int);\r\nif (rm2 == 0)\r\nrm2 = fpzeroreg;\r\ntm = extru(ir, fptmpos, 5) * sizeof(double)/sizeof(u_int);\r\nif (tm == 0)\r\nreturn(MAJOR_06_EXCP);\r\nra = extru(ir, fprapos, 5) * sizeof(double)/sizeof(u_int);\r\nta = extru(ir, fptapos, 5) * sizeof(double)/sizeof(u_int);\r\nif (ta == 0)\r\nreturn(MAJOR_06_EXCP);\r\nif (fpu_type_flags & TIMEX_ROLEX_FPU_MASK) {\r\nif (ra == 0) {\r\nif (dbl_fmpy(&fpregs[rm1],&fpregs[rm2],\r\n&mtmp.ints.i1,&status))\r\nerror = 1;\r\nif (dbl_to_sgl_fcnvfxt(&fpregs[ta],\r\n&atmp.ints.i1,&atmp.ints.i1,&status))\r\nerror = 1;\r\n}\r\nelse {\r\nif (dbl_fmpy(&fpregs[rm1],&fpregs[rm2],&mtmp.ints.i1,\r\n&status))\r\nerror = 1;\r\nif (dbl_fadd(&fpregs[ta], &fpregs[ra], &atmp.ints.i1,\r\n&status))\r\nerror = 1;\r\n}\r\n}\r\nelse\r\n{\r\nif (ra == 0)\r\nra = fpzeroreg;\r\nif (dbl_fmpy(&fpregs[rm1],&fpregs[rm2],&mtmp.ints.i1,\r\n&status))\r\nerror = 1;\r\nif (dbl_fadd(&fpregs[ta], &fpregs[ra], &atmp.ints.i1,\r\n&status))\r\nerror = 1;\r\n}\r\nif (error)\r\nreturn(MAJOR_06_EXCP);\r\nelse {\r\nfpregs[tm] = mtmp.ints.i1;\r\nfpregs[tm+1] = mtmp.ints.i2;\r\nfpregs[ta] = atmp.ints.i1;\r\nfpregs[ta+1] = atmp.ints.i2;\r\nfpregs[0] = status;\r\nreturn(NOEXCEPTION);\r\n}\r\n}\r\nelse {\r\nrm1 = (extru(ir,fprm1pos,4) | 0x10 ) << 1;\r\nrm1 |= extru(ir,fprm1pos-4,1);\r\nrm2 = (extru(ir,fprm2pos,4) | 0x10 ) << 1;\r\nrm2 |= extru(ir,fprm2pos-4,1);\r\ntm = (extru(ir,fptmpos,4) | 0x10 ) << 1;\r\ntm |= extru(ir,fptmpos-4,1);\r\nra = (extru(ir,fprapos,4) | 0x10 ) << 1;\r\nra |= extru(ir,fprapos-4,1);\r\nta = (extru(ir,fptapos,4) | 0x10 ) << 1;\r\nta |= extru(ir,fptapos-4,1);\r\nif (ra == 0x20 &&(fpu_type_flags & TIMEX_ROLEX_FPU_MASK)) {\r\nif (sgl_fmpy(&fpregs[rm1],&fpregs[rm2],&mtmp.ints.i1,\r\n&status))\r\nerror = 1;\r\nif (sgl_to_sgl_fcnvfxt(&fpregs[ta],&atmp.ints.i1,\r\n&atmp.ints.i1,&status))\r\nerror = 1;\r\n}\r\nelse {\r\nif (sgl_fmpy(&fpregs[rm1],&fpregs[rm2],&mtmp.ints.i1,\r\n&status))\r\nerror = 1;\r\nif (sgl_fadd(&fpregs[ta], &fpregs[ra], &atmp.ints.i1,\r\n&status))\r\nerror = 1;\r\n}\r\nif (error)\r\nreturn(MAJOR_06_EXCP);\r\nelse {\r\nfpregs[tm] = mtmp.ints.i1;\r\nfpregs[ta] = atmp.ints.i1;\r\nfpregs[0] = status;\r\nreturn(NOEXCEPTION);\r\n}\r\n}\r\n}\r\nstatic u_int\r\ndecode_26(ir,fpregs)\r\nu_int ir;\r\nu_int fpregs[];\r\n{\r\nu_int rm1, rm2, tm, ra, ta;\r\nu_int fmt;\r\nu_int error = 0;\r\nu_int status;\r\nunion {\r\ndouble dbl;\r\nfloat flt;\r\nstruct { u_int i1; u_int i2; } ints;\r\n} mtmp, atmp;\r\nstatus = fpregs[0];\r\nfmt = extru(ir, fpmultifmt, 1);\r\nif (fmt == 0) {\r\nrm1 = extru(ir, fprm1pos, 5) * sizeof(double)/sizeof(u_int);\r\nif (rm1 == 0)\r\nrm1 = fpzeroreg;\r\nrm2 = extru(ir, fprm2pos, 5) * sizeof(double)/sizeof(u_int);\r\nif (rm2 == 0)\r\nrm2 = fpzeroreg;\r\ntm = extru(ir, fptmpos, 5) * sizeof(double)/sizeof(u_int);\r\nif (tm == 0)\r\nreturn(MAJOR_26_EXCP);\r\nra = extru(ir, fprapos, 5) * sizeof(double)/sizeof(u_int);\r\nif (ra == 0)\r\nreturn(MAJOR_26_EXCP);\r\nta = extru(ir, fptapos, 5) * sizeof(double)/sizeof(u_int);\r\nif (ta == 0)\r\nreturn(MAJOR_26_EXCP);\r\nif (dbl_fmpy(&fpregs[rm1],&fpregs[rm2],&mtmp.ints.i1,&status))\r\nerror = 1;\r\nif (dbl_fsub(&fpregs[ta], &fpregs[ra], &atmp.ints.i1,&status))\r\nerror = 1;\r\nif (error)\r\nreturn(MAJOR_26_EXCP);\r\nelse {\r\nfpregs[tm] = mtmp.ints.i1;\r\nfpregs[tm+1] = mtmp.ints.i2;\r\nfpregs[ta] = atmp.ints.i1;\r\nfpregs[ta+1] = atmp.ints.i2;\r\nfpregs[0] = status;\r\nreturn(NOEXCEPTION);\r\n}\r\n}\r\nelse {\r\nrm1 = (extru(ir,fprm1pos,4) | 0x10 ) << 1;\r\nrm1 |= extru(ir,fprm1pos-4,1);\r\nrm2 = (extru(ir,fprm2pos,4) | 0x10 ) << 1;\r\nrm2 |= extru(ir,fprm2pos-4,1);\r\ntm = (extru(ir,fptmpos,4) | 0x10 ) << 1;\r\ntm |= extru(ir,fptmpos-4,1);\r\nra = (extru(ir,fprapos,4) | 0x10 ) << 1;\r\nra |= extru(ir,fprapos-4,1);\r\nta = (extru(ir,fptapos,4) | 0x10 ) << 1;\r\nta |= extru(ir,fptapos-4,1);\r\nif (sgl_fmpy(&fpregs[rm1],&fpregs[rm2],&mtmp.ints.i1,&status))\r\nerror = 1;\r\nif (sgl_fsub(&fpregs[ta], &fpregs[ra], &atmp.ints.i1,&status))\r\nerror = 1;\r\nif (error)\r\nreturn(MAJOR_26_EXCP);\r\nelse {\r\nfpregs[tm] = mtmp.ints.i1;\r\nfpregs[ta] = atmp.ints.i1;\r\nfpregs[0] = status;\r\nreturn(NOEXCEPTION);\r\n}\r\n}\r\n}\r\nstatic u_int\r\ndecode_2e(ir,fpregs)\r\nu_int ir;\r\nu_int fpregs[];\r\n{\r\nu_int rm1, rm2, ra, t;\r\nu_int fmt;\r\nfmt = extru(ir,fpfmtpos,1);\r\nif (fmt == DBL) {\r\nrm1 = extru(ir,fprm1pos,5) * sizeof(double)/sizeof(u_int);\r\nif (rm1 == 0)\r\nrm1 = fpzeroreg;\r\nrm2 = extru(ir,fprm2pos,5) * sizeof(double)/sizeof(u_int);\r\nif (rm2 == 0)\r\nrm2 = fpzeroreg;\r\nra = ((extru(ir,fpraupos,3)<<2)|(extru(ir,fpralpos,3)>>1)) *\r\nsizeof(double)/sizeof(u_int);\r\nif (ra == 0)\r\nra = fpzeroreg;\r\nt = extru(ir,fptpos,5) * sizeof(double)/sizeof(u_int);\r\nif (t == 0)\r\nreturn(MAJOR_2E_EXCP);\r\nif (extru(ir,fpfusedsubop,1)) {\r\nreturn(dbl_fmpynfadd(&fpregs[rm1], &fpregs[rm2],\r\n&fpregs[ra], &fpregs[0], &fpregs[t]));\r\n} else {\r\nreturn(dbl_fmpyfadd(&fpregs[rm1], &fpregs[rm2],\r\n&fpregs[ra], &fpregs[0], &fpregs[t]));\r\n}\r\n}\r\nelse {\r\nrm1 = (extru(ir,fprm1pos,5)<<1)|(extru(ir,fpxrm1pos,1));\r\nif (rm1 == 0)\r\nrm1 = fpzeroreg;\r\nrm2 = (extru(ir,fprm2pos,5)<<1)|(extru(ir,fpxrm2pos,1));\r\nif (rm2 == 0)\r\nrm2 = fpzeroreg;\r\nra = (extru(ir,fpraupos,3)<<3)|extru(ir,fpralpos,3);\r\nif (ra == 0)\r\nra = fpzeroreg;\r\nt = ((extru(ir,fptpos,5)<<1)|(extru(ir,fpxtpos,1)));\r\nif (t == 0)\r\nreturn(MAJOR_2E_EXCP);\r\nif (extru(ir,fpfusedsubop,1)) {\r\nreturn(sgl_fmpynfadd(&fpregs[rm1], &fpregs[rm2],\r\n&fpregs[ra], &fpregs[0], &fpregs[t]));\r\n} else {\r\nreturn(sgl_fmpyfadd(&fpregs[rm1], &fpregs[rm2],\r\n&fpregs[ra], &fpregs[0], &fpregs[t]));\r\n}\r\n}\r\n}\r\nstatic void\r\nupdate_status_cbit(status, new_status, fpu_type, y_field)\r\nu_int *status, new_status;\r\nu_int fpu_type;\r\nu_int y_field;\r\n{\r\nif ((fpu_type & TIMEX_EXTEN_FLAG) ||\r\n(fpu_type & ROLEX_EXTEN_FLAG) ||\r\n(fpu_type & PA2_0_FPU_FLAG)) {\r\nif (y_field == 0) {\r\n*status = ((*status & 0x04000000) >> 5) |\r\n((*status & 0x003ff000) >> 1) |\r\n(new_status & 0xffc007ff);\r\n} else {\r\n*status = (*status & 0x04000000) |\r\n((new_status & 0x04000000) >> (y_field+4)) |\r\n(new_status & ~0x04000000 &\r\n~(0x04000000 >> (y_field+4)));\r\n}\r\n}\r\nelse {\r\n*status = new_status;\r\n}\r\n}

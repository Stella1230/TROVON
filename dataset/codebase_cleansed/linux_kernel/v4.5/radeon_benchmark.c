static int radeon_benchmark_do_move(struct radeon_device *rdev, unsigned size,\r\nuint64_t saddr, uint64_t daddr,\r\nint flag, int n,\r\nstruct reservation_object *resv)\r\n{\r\nunsigned long start_jiffies;\r\nunsigned long end_jiffies;\r\nstruct radeon_fence *fence = NULL;\r\nint i, r;\r\nstart_jiffies = jiffies;\r\nfor (i = 0; i < n; i++) {\r\nswitch (flag) {\r\ncase RADEON_BENCHMARK_COPY_DMA:\r\nfence = radeon_copy_dma(rdev, saddr, daddr,\r\nsize / RADEON_GPU_PAGE_SIZE,\r\nresv);\r\nbreak;\r\ncase RADEON_BENCHMARK_COPY_BLIT:\r\nfence = radeon_copy_blit(rdev, saddr, daddr,\r\nsize / RADEON_GPU_PAGE_SIZE,\r\nresv);\r\nbreak;\r\ndefault:\r\nDRM_ERROR("Unknown copy method\n");\r\nreturn -EINVAL;\r\n}\r\nif (IS_ERR(fence))\r\nreturn PTR_ERR(fence);\r\nr = radeon_fence_wait(fence, false);\r\nradeon_fence_unref(&fence);\r\nif (r)\r\nreturn r;\r\n}\r\nend_jiffies = jiffies;\r\nreturn jiffies_to_msecs(end_jiffies - start_jiffies);\r\n}\r\nstatic void radeon_benchmark_log_results(int n, unsigned size,\r\nunsigned int time,\r\nunsigned sdomain, unsigned ddomain,\r\nchar *kind)\r\n{\r\nunsigned int throughput = (n * (size >> 10)) / time;\r\nDRM_INFO("radeon: %s %u bo moves of %u kB from"\r\n" %d to %d in %u ms, throughput: %u Mb/s or %u MB/s\n",\r\nkind, n, size >> 10, sdomain, ddomain, time,\r\nthroughput * 8, throughput);\r\n}\r\nstatic void radeon_benchmark_move(struct radeon_device *rdev, unsigned size,\r\nunsigned sdomain, unsigned ddomain)\r\n{\r\nstruct radeon_bo *dobj = NULL;\r\nstruct radeon_bo *sobj = NULL;\r\nuint64_t saddr, daddr;\r\nint r, n;\r\nint time;\r\nn = RADEON_BENCHMARK_ITERATIONS;\r\nr = radeon_bo_create(rdev, size, PAGE_SIZE, true, sdomain, 0, NULL, NULL, &sobj);\r\nif (r) {\r\ngoto out_cleanup;\r\n}\r\nr = radeon_bo_reserve(sobj, false);\r\nif (unlikely(r != 0))\r\ngoto out_cleanup;\r\nr = radeon_bo_pin(sobj, sdomain, &saddr);\r\nradeon_bo_unreserve(sobj);\r\nif (r) {\r\ngoto out_cleanup;\r\n}\r\nr = radeon_bo_create(rdev, size, PAGE_SIZE, true, ddomain, 0, NULL, NULL, &dobj);\r\nif (r) {\r\ngoto out_cleanup;\r\n}\r\nr = radeon_bo_reserve(dobj, false);\r\nif (unlikely(r != 0))\r\ngoto out_cleanup;\r\nr = radeon_bo_pin(dobj, ddomain, &daddr);\r\nradeon_bo_unreserve(dobj);\r\nif (r) {\r\ngoto out_cleanup;\r\n}\r\nif (rdev->asic->copy.dma) {\r\ntime = radeon_benchmark_do_move(rdev, size, saddr, daddr,\r\nRADEON_BENCHMARK_COPY_DMA, n,\r\ndobj->tbo.resv);\r\nif (time < 0)\r\ngoto out_cleanup;\r\nif (time > 0)\r\nradeon_benchmark_log_results(n, size, time,\r\nsdomain, ddomain, "dma");\r\n}\r\nif (rdev->asic->copy.blit) {\r\ntime = radeon_benchmark_do_move(rdev, size, saddr, daddr,\r\nRADEON_BENCHMARK_COPY_BLIT, n,\r\ndobj->tbo.resv);\r\nif (time < 0)\r\ngoto out_cleanup;\r\nif (time > 0)\r\nradeon_benchmark_log_results(n, size, time,\r\nsdomain, ddomain, "blit");\r\n}\r\nout_cleanup:\r\nif (sobj) {\r\nr = radeon_bo_reserve(sobj, false);\r\nif (likely(r == 0)) {\r\nradeon_bo_unpin(sobj);\r\nradeon_bo_unreserve(sobj);\r\n}\r\nradeon_bo_unref(&sobj);\r\n}\r\nif (dobj) {\r\nr = radeon_bo_reserve(dobj, false);\r\nif (likely(r == 0)) {\r\nradeon_bo_unpin(dobj);\r\nradeon_bo_unreserve(dobj);\r\n}\r\nradeon_bo_unref(&dobj);\r\n}\r\nif (r) {\r\nDRM_ERROR("Error while benchmarking BO move.\n");\r\n}\r\n}\r\nvoid radeon_benchmark(struct radeon_device *rdev, int test_number)\r\n{\r\nint i;\r\nint common_modes[RADEON_BENCHMARK_COMMON_MODES_N] = {\r\n640 * 480 * 4,\r\n720 * 480 * 4,\r\n800 * 600 * 4,\r\n848 * 480 * 4,\r\n1024 * 768 * 4,\r\n1152 * 768 * 4,\r\n1280 * 720 * 4,\r\n1280 * 800 * 4,\r\n1280 * 854 * 4,\r\n1280 * 960 * 4,\r\n1280 * 1024 * 4,\r\n1440 * 900 * 4,\r\n1400 * 1050 * 4,\r\n1680 * 1050 * 4,\r\n1600 * 1200 * 4,\r\n1920 * 1080 * 4,\r\n1920 * 1200 * 4\r\n};\r\nswitch (test_number) {\r\ncase 1:\r\nradeon_benchmark_move(rdev, 1024*1024, RADEON_GEM_DOMAIN_GTT,\r\nRADEON_GEM_DOMAIN_VRAM);\r\nradeon_benchmark_move(rdev, 1024*1024, RADEON_GEM_DOMAIN_VRAM,\r\nRADEON_GEM_DOMAIN_GTT);\r\nbreak;\r\ncase 2:\r\nradeon_benchmark_move(rdev, 1024*1024, RADEON_GEM_DOMAIN_VRAM,\r\nRADEON_GEM_DOMAIN_VRAM);\r\nbreak;\r\ncase 3:\r\nfor (i = 1; i <= 16384; i <<= 1)\r\nradeon_benchmark_move(rdev, i * RADEON_GPU_PAGE_SIZE,\r\nRADEON_GEM_DOMAIN_GTT,\r\nRADEON_GEM_DOMAIN_VRAM);\r\nbreak;\r\ncase 4:\r\nfor (i = 1; i <= 16384; i <<= 1)\r\nradeon_benchmark_move(rdev, i * RADEON_GPU_PAGE_SIZE,\r\nRADEON_GEM_DOMAIN_VRAM,\r\nRADEON_GEM_DOMAIN_GTT);\r\nbreak;\r\ncase 5:\r\nfor (i = 1; i <= 16384; i <<= 1)\r\nradeon_benchmark_move(rdev, i * RADEON_GPU_PAGE_SIZE,\r\nRADEON_GEM_DOMAIN_VRAM,\r\nRADEON_GEM_DOMAIN_VRAM);\r\nbreak;\r\ncase 6:\r\nfor (i = 0; i < RADEON_BENCHMARK_COMMON_MODES_N; i++)\r\nradeon_benchmark_move(rdev, common_modes[i],\r\nRADEON_GEM_DOMAIN_GTT,\r\nRADEON_GEM_DOMAIN_VRAM);\r\nbreak;\r\ncase 7:\r\nfor (i = 0; i < RADEON_BENCHMARK_COMMON_MODES_N; i++)\r\nradeon_benchmark_move(rdev, common_modes[i],\r\nRADEON_GEM_DOMAIN_VRAM,\r\nRADEON_GEM_DOMAIN_GTT);\r\nbreak;\r\ncase 8:\r\nfor (i = 0; i < RADEON_BENCHMARK_COMMON_MODES_N; i++)\r\nradeon_benchmark_move(rdev, common_modes[i],\r\nRADEON_GEM_DOMAIN_VRAM,\r\nRADEON_GEM_DOMAIN_VRAM);\r\nbreak;\r\ndefault:\r\nDRM_ERROR("Unknown benchmark\n");\r\n}\r\n}

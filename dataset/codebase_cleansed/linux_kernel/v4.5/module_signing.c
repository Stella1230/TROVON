int mod_verify_sig(const void *mod, unsigned long *_modlen)\r\n{\r\nstruct module_signature ms;\r\nsize_t modlen = *_modlen, sig_len;\r\npr_devel("==>%s(,%zu)\n", __func__, modlen);\r\nif (modlen <= sizeof(ms))\r\nreturn -EBADMSG;\r\nmemcpy(&ms, mod + (modlen - sizeof(ms)), sizeof(ms));\r\nmodlen -= sizeof(ms);\r\nsig_len = be32_to_cpu(ms.sig_len);\r\nif (sig_len >= modlen)\r\nreturn -EBADMSG;\r\nmodlen -= sig_len;\r\n*_modlen = modlen;\r\nif (ms.id_type != PKEY_ID_PKCS7) {\r\npr_err("Module is not signed with expected PKCS#7 message\n");\r\nreturn -ENOPKG;\r\n}\r\nif (ms.algo != 0 ||\r\nms.hash != 0 ||\r\nms.signer_len != 0 ||\r\nms.key_id_len != 0 ||\r\nms.__pad[0] != 0 ||\r\nms.__pad[1] != 0 ||\r\nms.__pad[2] != 0) {\r\npr_err("PKCS#7 signature info has unexpected non-zero params\n");\r\nreturn -EBADMSG;\r\n}\r\nreturn system_verify_data(mod, modlen, mod + modlen, sig_len,\r\nVERIFYING_MODULE_SIGNATURE);\r\n}

static int sha256_ce_update(struct shash_desc *desc, const u8 *data,\r\nunsigned int len)\r\n{\r\nstruct sha256_ce_state *sctx = shash_desc_ctx(desc);\r\nsctx->finalize = 0;\r\nkernel_neon_begin_partial(28);\r\nsha256_base_do_update(desc, data, len,\r\n(sha256_block_fn *)sha2_ce_transform);\r\nkernel_neon_end();\r\nreturn 0;\r\n}\r\nstatic int sha256_ce_finup(struct shash_desc *desc, const u8 *data,\r\nunsigned int len, u8 *out)\r\n{\r\nstruct sha256_ce_state *sctx = shash_desc_ctx(desc);\r\nbool finalize = !sctx->sst.count && !(len % SHA256_BLOCK_SIZE);\r\nASM_EXPORT(sha256_ce_offsetof_count,\r\noffsetof(struct sha256_ce_state, sst.count));\r\nASM_EXPORT(sha256_ce_offsetof_finalize,\r\noffsetof(struct sha256_ce_state, finalize));\r\nsctx->finalize = finalize;\r\nkernel_neon_begin_partial(28);\r\nsha256_base_do_update(desc, data, len,\r\n(sha256_block_fn *)sha2_ce_transform);\r\nif (!finalize)\r\nsha256_base_do_finalize(desc,\r\n(sha256_block_fn *)sha2_ce_transform);\r\nkernel_neon_end();\r\nreturn sha256_base_finish(desc, out);\r\n}\r\nstatic int sha256_ce_final(struct shash_desc *desc, u8 *out)\r\n{\r\nstruct sha256_ce_state *sctx = shash_desc_ctx(desc);\r\nsctx->finalize = 0;\r\nkernel_neon_begin_partial(28);\r\nsha256_base_do_finalize(desc, (sha256_block_fn *)sha2_ce_transform);\r\nkernel_neon_end();\r\nreturn sha256_base_finish(desc, out);\r\n}\r\nstatic int __init sha2_ce_mod_init(void)\r\n{\r\nreturn crypto_register_shashes(algs, ARRAY_SIZE(algs));\r\n}\r\nstatic void __exit sha2_ce_mod_fini(void)\r\n{\r\ncrypto_unregister_shashes(algs, ARRAY_SIZE(algs));\r\n}

static inline struct mic_device *scdev_to_mdev(struct scif_hw_dev *scdev)\r\n{\r\nreturn dev_get_drvdata(scdev->dev.parent);\r\n}\r\nstatic void *__mic_dma_alloc(struct device *dev, size_t size,\r\ndma_addr_t *dma_handle, gfp_t gfp,\r\nstruct dma_attrs *attrs)\r\n{\r\nstruct scif_hw_dev *scdev = dev_get_drvdata(dev);\r\nstruct mic_device *mdev = scdev_to_mdev(scdev);\r\ndma_addr_t tmp;\r\nvoid *va = kmalloc(size, gfp);\r\nif (va) {\r\ntmp = mic_map_single(mdev, va, size);\r\nif (dma_mapping_error(dev, tmp)) {\r\nkfree(va);\r\nva = NULL;\r\n} else {\r\n*dma_handle = tmp;\r\n}\r\n}\r\nreturn va;\r\n}\r\nstatic void __mic_dma_free(struct device *dev, size_t size, void *vaddr,\r\ndma_addr_t dma_handle, struct dma_attrs *attrs)\r\n{\r\nstruct scif_hw_dev *scdev = dev_get_drvdata(dev);\r\nstruct mic_device *mdev = scdev_to_mdev(scdev);\r\nmic_unmap_single(mdev, dma_handle, size);\r\nkfree(vaddr);\r\n}\r\nstatic dma_addr_t\r\n__mic_dma_map_page(struct device *dev, struct page *page, unsigned long offset,\r\nsize_t size, enum dma_data_direction dir,\r\nstruct dma_attrs *attrs)\r\n{\r\nvoid *va = phys_to_virt(page_to_phys(page)) + offset;\r\nstruct scif_hw_dev *scdev = dev_get_drvdata(dev);\r\nstruct mic_device *mdev = scdev_to_mdev(scdev);\r\nreturn mic_map_single(mdev, va, size);\r\n}\r\nstatic void\r\n__mic_dma_unmap_page(struct device *dev, dma_addr_t dma_addr,\r\nsize_t size, enum dma_data_direction dir,\r\nstruct dma_attrs *attrs)\r\n{\r\nstruct scif_hw_dev *scdev = dev_get_drvdata(dev);\r\nstruct mic_device *mdev = scdev_to_mdev(scdev);\r\nmic_unmap_single(mdev, dma_addr, size);\r\n}\r\nstatic int __mic_dma_map_sg(struct device *dev, struct scatterlist *sg,\r\nint nents, enum dma_data_direction dir,\r\nstruct dma_attrs *attrs)\r\n{\r\nstruct scif_hw_dev *scdev = dev_get_drvdata(dev);\r\nstruct mic_device *mdev = scdev_to_mdev(scdev);\r\nstruct scatterlist *s;\r\nint i, j, ret;\r\ndma_addr_t da;\r\nret = dma_map_sg(&mdev->pdev->dev, sg, nents, dir);\r\nif (ret <= 0)\r\nreturn 0;\r\nfor_each_sg(sg, s, nents, i) {\r\nda = mic_map(mdev, sg_dma_address(s) + s->offset, s->length);\r\nif (!da)\r\ngoto err;\r\nsg_dma_address(s) = da;\r\n}\r\nreturn nents;\r\nerr:\r\nfor_each_sg(sg, s, i, j) {\r\nmic_unmap(mdev, sg_dma_address(s), s->length);\r\nsg_dma_address(s) = mic_to_dma_addr(mdev, sg_dma_address(s));\r\n}\r\ndma_unmap_sg(&mdev->pdev->dev, sg, nents, dir);\r\nreturn 0;\r\n}\r\nstatic void __mic_dma_unmap_sg(struct device *dev,\r\nstruct scatterlist *sg, int nents,\r\nenum dma_data_direction dir,\r\nstruct dma_attrs *attrs)\r\n{\r\nstruct scif_hw_dev *scdev = dev_get_drvdata(dev);\r\nstruct mic_device *mdev = scdev_to_mdev(scdev);\r\nstruct scatterlist *s;\r\ndma_addr_t da;\r\nint i;\r\nfor_each_sg(sg, s, nents, i) {\r\nda = mic_to_dma_addr(mdev, sg_dma_address(s));\r\nmic_unmap(mdev, sg_dma_address(s), s->length);\r\nsg_dma_address(s) = da;\r\n}\r\ndma_unmap_sg(&mdev->pdev->dev, sg, nents, dir);\r\n}\r\nstatic struct mic_irq *\r\n___mic_request_irq(struct scif_hw_dev *scdev,\r\nirqreturn_t (*func)(int irq, void *data),\r\nconst char *name,\r\nvoid *data, int db)\r\n{\r\nstruct mic_device *mdev = scdev_to_mdev(scdev);\r\nreturn mic_request_threaded_irq(mdev, func, NULL, name, data,\r\ndb, MIC_INTR_DB);\r\n}\r\nstatic void\r\n___mic_free_irq(struct scif_hw_dev *scdev,\r\nstruct mic_irq *cookie, void *data)\r\n{\r\nstruct mic_device *mdev = scdev_to_mdev(scdev);\r\nreturn mic_free_irq(mdev, cookie, data);\r\n}\r\nstatic void ___mic_ack_interrupt(struct scif_hw_dev *scdev, int num)\r\n{\r\nstruct mic_device *mdev = scdev_to_mdev(scdev);\r\nmdev->ops->intr_workarounds(mdev);\r\n}\r\nstatic int ___mic_next_db(struct scif_hw_dev *scdev)\r\n{\r\nstruct mic_device *mdev = scdev_to_mdev(scdev);\r\nreturn mic_next_db(mdev);\r\n}\r\nstatic void ___mic_send_intr(struct scif_hw_dev *scdev, int db)\r\n{\r\nstruct mic_device *mdev = scdev_to_mdev(scdev);\r\nmdev->ops->send_intr(mdev, db);\r\n}\r\nstatic void __iomem *___mic_ioremap(struct scif_hw_dev *scdev,\r\nphys_addr_t pa, size_t len)\r\n{\r\nstruct mic_device *mdev = scdev_to_mdev(scdev);\r\nreturn mdev->aper.va + pa;\r\n}\r\nstatic void ___mic_iounmap(struct scif_hw_dev *scdev, void __iomem *va)\r\n{\r\n}\r\nstatic inline struct mic_device *mbdev_to_mdev(struct mbus_device *mbdev)\r\n{\r\nreturn dev_get_drvdata(mbdev->dev.parent);\r\n}\r\nstatic dma_addr_t\r\nmic_dma_map_page(struct device *dev, struct page *page,\r\nunsigned long offset, size_t size, enum dma_data_direction dir,\r\nstruct dma_attrs *attrs)\r\n{\r\nvoid *va = phys_to_virt(page_to_phys(page)) + offset;\r\nstruct mic_device *mdev = dev_get_drvdata(dev->parent);\r\nreturn mic_map_single(mdev, va, size);\r\n}\r\nstatic void\r\nmic_dma_unmap_page(struct device *dev, dma_addr_t dma_addr,\r\nsize_t size, enum dma_data_direction dir,\r\nstruct dma_attrs *attrs)\r\n{\r\nstruct mic_device *mdev = dev_get_drvdata(dev->parent);\r\nmic_unmap_single(mdev, dma_addr, size);\r\n}\r\nstatic struct mic_irq *\r\n_mic_request_threaded_irq(struct mbus_device *mbdev,\r\nirq_handler_t handler, irq_handler_t thread_fn,\r\nconst char *name, void *data, int intr_src)\r\n{\r\nreturn mic_request_threaded_irq(mbdev_to_mdev(mbdev), handler,\r\nthread_fn, name, data,\r\nintr_src, MIC_INTR_DMA);\r\n}\r\nstatic void _mic_free_irq(struct mbus_device *mbdev,\r\nstruct mic_irq *cookie, void *data)\r\n{\r\nreturn mic_free_irq(mbdev_to_mdev(mbdev), cookie, data);\r\n}\r\nstatic void _mic_ack_interrupt(struct mbus_device *mbdev, int num)\r\n{\r\nstruct mic_device *mdev = mbdev_to_mdev(mbdev);\r\nmdev->ops->intr_workarounds(mdev);\r\n}\r\nvoid mic_bootparam_init(struct mic_device *mdev)\r\n{\r\nstruct mic_bootparam *bootparam = mdev->dp;\r\nbootparam->magic = cpu_to_le32(MIC_MAGIC);\r\nbootparam->h2c_config_db = -1;\r\nbootparam->node_id = mdev->id + 1;\r\nbootparam->scif_host_dma_addr = 0x0;\r\nbootparam->scif_card_dma_addr = 0x0;\r\nbootparam->c2h_scif_db = -1;\r\nbootparam->h2c_scif_db = -1;\r\n}\r\nstatic inline struct mic_device *cosmdev_to_mdev(struct cosm_device *cdev)\r\n{\r\nreturn dev_get_drvdata(cdev->dev.parent);\r\n}\r\nstatic void _mic_reset(struct cosm_device *cdev)\r\n{\r\nstruct mic_device *mdev = cosmdev_to_mdev(cdev);\r\nmdev->ops->reset_fw_ready(mdev);\r\nmdev->ops->reset(mdev);\r\n}\r\nstatic bool _mic_ready(struct cosm_device *cdev)\r\n{\r\nstruct mic_device *mdev = cosmdev_to_mdev(cdev);\r\nreturn mdev->ops->is_fw_ready(mdev);\r\n}\r\nstatic int mic_request_dma_chans(struct mic_device *mdev)\r\n{\r\ndma_cap_mask_t mask;\r\nstruct dma_chan *chan;\r\nrequest_module("mic_x100_dma");\r\ndma_cap_zero(mask);\r\ndma_cap_set(DMA_MEMCPY, mask);\r\ndo {\r\nchan = dma_request_channel(mask, mdev->ops->dma_filter,\r\n&mdev->pdev->dev);\r\nif (chan) {\r\nmdev->dma_ch[mdev->num_dma_ch++] = chan;\r\nif (mdev->num_dma_ch >= MIC_MAX_DMA_CHAN)\r\nbreak;\r\n}\r\n} while (chan);\r\ndev_info(&mdev->pdev->dev, "DMA channels # %d\n", mdev->num_dma_ch);\r\nreturn mdev->num_dma_ch;\r\n}\r\nstatic void mic_free_dma_chans(struct mic_device *mdev)\r\n{\r\nint i = 0;\r\nfor (i = 0; i < mdev->num_dma_ch; i++) {\r\ndma_release_channel(mdev->dma_ch[i]);\r\nmdev->dma_ch[i] = NULL;\r\n}\r\nmdev->num_dma_ch = 0;\r\n}\r\nstatic int _mic_start(struct cosm_device *cdev, int id)\r\n{\r\nstruct mic_device *mdev = cosmdev_to_mdev(cdev);\r\nint rc;\r\nmic_bootparam_init(mdev);\r\nmdev->dma_mbdev = mbus_register_device(&mdev->pdev->dev,\r\nMBUS_DEV_DMA_HOST, &mic_dma_ops,\r\n&mbus_hw_ops, id, mdev->mmio.va);\r\nif (IS_ERR(mdev->dma_mbdev)) {\r\nrc = PTR_ERR(mdev->dma_mbdev);\r\ngoto unlock_ret;\r\n}\r\nif (!mic_request_dma_chans(mdev)) {\r\nrc = -ENODEV;\r\ngoto dma_remove;\r\n}\r\nmdev->scdev = scif_register_device(&mdev->pdev->dev, MIC_SCIF_DEV,\r\n&__mic_dma_ops, &scif_hw_ops,\r\nid + 1, 0, &mdev->mmio,\r\n&mdev->aper, mdev->dp, NULL,\r\nmdev->dma_ch, mdev->num_dma_ch,\r\ntrue);\r\nif (IS_ERR(mdev->scdev)) {\r\nrc = PTR_ERR(mdev->scdev);\r\ngoto dma_free;\r\n}\r\nrc = mdev->ops->load_mic_fw(mdev, NULL);\r\nif (rc)\r\ngoto scif_remove;\r\nmic_smpt_restore(mdev);\r\nmic_intr_restore(mdev);\r\nmdev->intr_ops->enable_interrupts(mdev);\r\nmdev->ops->write_spad(mdev, MIC_DPLO_SPAD, mdev->dp_dma_addr);\r\nmdev->ops->write_spad(mdev, MIC_DPHI_SPAD, mdev->dp_dma_addr >> 32);\r\nmdev->ops->send_firmware_intr(mdev);\r\ngoto unlock_ret;\r\nscif_remove:\r\nscif_unregister_device(mdev->scdev);\r\ndma_free:\r\nmic_free_dma_chans(mdev);\r\ndma_remove:\r\nmbus_unregister_device(mdev->dma_mbdev);\r\nunlock_ret:\r\nreturn rc;\r\n}\r\nstatic void _mic_stop(struct cosm_device *cdev, bool force)\r\n{\r\nstruct mic_device *mdev = cosmdev_to_mdev(cdev);\r\nmic_virtio_reset_devices(mdev);\r\nscif_unregister_device(mdev->scdev);\r\nmic_free_dma_chans(mdev);\r\nmbus_unregister_device(mdev->dma_mbdev);\r\nmic_bootparam_init(mdev);\r\n}\r\nstatic ssize_t _mic_family(struct cosm_device *cdev, char *buf)\r\n{\r\nstruct mic_device *mdev = cosmdev_to_mdev(cdev);\r\nstatic const char *family[MIC_FAMILY_LAST] = { "x100", "Unknown" };\r\nreturn scnprintf(buf, PAGE_SIZE, "%s\n", family[mdev->family]);\r\n}\r\nstatic ssize_t _mic_stepping(struct cosm_device *cdev, char *buf)\r\n{\r\nstruct mic_device *mdev = cosmdev_to_mdev(cdev);\r\nconst char *string = "??";\r\nswitch (mdev->stepping) {\r\ncase MIC_A0_STEP:\r\nstring = "A0";\r\nbreak;\r\ncase MIC_B0_STEP:\r\nstring = "B0";\r\nbreak;\r\ncase MIC_B1_STEP:\r\nstring = "B1";\r\nbreak;\r\ncase MIC_C0_STEP:\r\nstring = "C0";\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn scnprintf(buf, PAGE_SIZE, "%s\n", string);\r\n}\r\nstatic struct mic_mw *_mic_aper(struct cosm_device *cdev)\r\n{\r\nstruct mic_device *mdev = cosmdev_to_mdev(cdev);\r\nreturn &mdev->aper;\r\n}

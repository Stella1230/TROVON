static inline int __sungem_phy_read(struct mii_phy* phy, int id, int reg)\r\n{\r\nreturn phy->mdio_read(phy->dev, id, reg);\r\n}\r\nstatic inline void __sungem_phy_write(struct mii_phy* phy, int id, int reg, int val)\r\n{\r\nphy->mdio_write(phy->dev, id, reg, val);\r\n}\r\nstatic inline int sungem_phy_read(struct mii_phy* phy, int reg)\r\n{\r\nreturn phy->mdio_read(phy->dev, phy->mii_id, reg);\r\n}\r\nstatic inline void sungem_phy_write(struct mii_phy* phy, int reg, int val)\r\n{\r\nphy->mdio_write(phy->dev, phy->mii_id, reg, val);\r\n}\r\nstatic int reset_one_mii_phy(struct mii_phy* phy, int phy_id)\r\n{\r\nu16 val;\r\nint limit = 10000;\r\nval = __sungem_phy_read(phy, phy_id, MII_BMCR);\r\nval &= ~(BMCR_ISOLATE | BMCR_PDOWN);\r\nval |= BMCR_RESET;\r\n__sungem_phy_write(phy, phy_id, MII_BMCR, val);\r\nudelay(100);\r\nwhile (--limit) {\r\nval = __sungem_phy_read(phy, phy_id, MII_BMCR);\r\nif ((val & BMCR_RESET) == 0)\r\nbreak;\r\nudelay(10);\r\n}\r\nif ((val & BMCR_ISOLATE) && limit > 0)\r\n__sungem_phy_write(phy, phy_id, MII_BMCR, val & ~BMCR_ISOLATE);\r\nreturn limit <= 0;\r\n}\r\nstatic int bcm5201_init(struct mii_phy* phy)\r\n{\r\nu16 data;\r\ndata = sungem_phy_read(phy, MII_BCM5201_MULTIPHY);\r\ndata &= ~MII_BCM5201_MULTIPHY_SUPERISOLATE;\r\nsungem_phy_write(phy, MII_BCM5201_MULTIPHY, data);\r\nsungem_phy_write(phy, MII_BCM5201_INTERRUPT, 0);\r\nreturn 0;\r\n}\r\nstatic int bcm5201_suspend(struct mii_phy* phy)\r\n{\r\nsungem_phy_write(phy, MII_BCM5201_INTERRUPT, 0);\r\nsungem_phy_write(phy, MII_BCM5201_MULTIPHY, MII_BCM5201_MULTIPHY_SUPERISOLATE);\r\nreturn 0;\r\n}\r\nstatic int bcm5221_init(struct mii_phy* phy)\r\n{\r\nu16 data;\r\ndata = sungem_phy_read(phy, MII_BCM5221_TEST);\r\nsungem_phy_write(phy, MII_BCM5221_TEST,\r\ndata | MII_BCM5221_TEST_ENABLE_SHADOWS);\r\ndata = sungem_phy_read(phy, MII_BCM5221_SHDOW_AUX_STAT2);\r\nsungem_phy_write(phy, MII_BCM5221_SHDOW_AUX_STAT2,\r\ndata | MII_BCM5221_SHDOW_AUX_STAT2_APD);\r\ndata = sungem_phy_read(phy, MII_BCM5221_SHDOW_AUX_MODE4);\r\nsungem_phy_write(phy, MII_BCM5221_SHDOW_AUX_MODE4,\r\ndata | MII_BCM5221_SHDOW_AUX_MODE4_CLKLOPWR);\r\ndata = sungem_phy_read(phy, MII_BCM5221_TEST);\r\nsungem_phy_write(phy, MII_BCM5221_TEST,\r\ndata & ~MII_BCM5221_TEST_ENABLE_SHADOWS);\r\nreturn 0;\r\n}\r\nstatic int bcm5221_suspend(struct mii_phy* phy)\r\n{\r\nu16 data;\r\ndata = sungem_phy_read(phy, MII_BCM5221_TEST);\r\nsungem_phy_write(phy, MII_BCM5221_TEST,\r\ndata | MII_BCM5221_TEST_ENABLE_SHADOWS);\r\ndata = sungem_phy_read(phy, MII_BCM5221_SHDOW_AUX_MODE4);\r\nsungem_phy_write(phy, MII_BCM5221_SHDOW_AUX_MODE4,\r\ndata | MII_BCM5221_SHDOW_AUX_MODE4_IDDQMODE);\r\nreturn 0;\r\n}\r\nstatic int bcm5241_init(struct mii_phy* phy)\r\n{\r\nu16 data;\r\ndata = sungem_phy_read(phy, MII_BCM5221_TEST);\r\nsungem_phy_write(phy, MII_BCM5221_TEST,\r\ndata | MII_BCM5221_TEST_ENABLE_SHADOWS);\r\ndata = sungem_phy_read(phy, MII_BCM5221_SHDOW_AUX_STAT2);\r\nsungem_phy_write(phy, MII_BCM5221_SHDOW_AUX_STAT2,\r\ndata | MII_BCM5221_SHDOW_AUX_STAT2_APD);\r\ndata = sungem_phy_read(phy, MII_BCM5221_SHDOW_AUX_MODE4);\r\nsungem_phy_write(phy, MII_BCM5221_SHDOW_AUX_MODE4,\r\ndata & ~MII_BCM5241_SHDOW_AUX_MODE4_STANDBYPWR);\r\ndata = sungem_phy_read(phy, MII_BCM5221_TEST);\r\nsungem_phy_write(phy, MII_BCM5221_TEST,\r\ndata & ~MII_BCM5221_TEST_ENABLE_SHADOWS);\r\nreturn 0;\r\n}\r\nstatic int bcm5241_suspend(struct mii_phy* phy)\r\n{\r\nu16 data;\r\ndata = sungem_phy_read(phy, MII_BCM5221_TEST);\r\nsungem_phy_write(phy, MII_BCM5221_TEST,\r\ndata | MII_BCM5221_TEST_ENABLE_SHADOWS);\r\ndata = sungem_phy_read(phy, MII_BCM5221_SHDOW_AUX_MODE4);\r\nsungem_phy_write(phy, MII_BCM5221_SHDOW_AUX_MODE4,\r\ndata | MII_BCM5241_SHDOW_AUX_MODE4_STANDBYPWR);\r\nreturn 0;\r\n}\r\nstatic int bcm5400_init(struct mii_phy* phy)\r\n{\r\nu16 data;\r\ndata = sungem_phy_read(phy, MII_BCM5400_AUXCONTROL);\r\ndata |= MII_BCM5400_AUXCONTROL_PWR10BASET;\r\nsungem_phy_write(phy, MII_BCM5400_AUXCONTROL, data);\r\ndata = sungem_phy_read(phy, MII_BCM5400_GB_CONTROL);\r\ndata |= MII_BCM5400_GB_CONTROL_FULLDUPLEXCAP;\r\nsungem_phy_write(phy, MII_BCM5400_GB_CONTROL, data);\r\nudelay(100);\r\n(void)reset_one_mii_phy(phy, 0x1f);\r\ndata = __sungem_phy_read(phy, 0x1f, MII_BCM5201_MULTIPHY);\r\ndata |= MII_BCM5201_MULTIPHY_SERIALMODE;\r\n__sungem_phy_write(phy, 0x1f, MII_BCM5201_MULTIPHY, data);\r\ndata = sungem_phy_read(phy, MII_BCM5400_AUXCONTROL);\r\ndata &= ~MII_BCM5400_AUXCONTROL_PWR10BASET;\r\nsungem_phy_write(phy, MII_BCM5400_AUXCONTROL, data);\r\nreturn 0;\r\n}\r\nstatic int bcm5400_suspend(struct mii_phy* phy)\r\n{\r\n#if 0\r\nsungem_phy_write(phy, MII_BMCR, BMCR_PDOWN);\r\n#endif\r\nreturn 0;\r\n}\r\nstatic int bcm5401_init(struct mii_phy* phy)\r\n{\r\nu16 data;\r\nint rev;\r\nrev = sungem_phy_read(phy, MII_PHYSID2) & 0x000f;\r\nif (rev == 0 || rev == 3) {\r\nsungem_phy_write(phy, 0x18, 0x0c20);\r\nsungem_phy_write(phy, 0x17, 0x0012);\r\nsungem_phy_write(phy, 0x15, 0x1804);\r\nsungem_phy_write(phy, 0x17, 0x0013);\r\nsungem_phy_write(phy, 0x15, 0x1204);\r\nsungem_phy_write(phy, 0x17, 0x8006);\r\nsungem_phy_write(phy, 0x15, 0x0132);\r\nsungem_phy_write(phy, 0x17, 0x8006);\r\nsungem_phy_write(phy, 0x15, 0x0232);\r\nsungem_phy_write(phy, 0x17, 0x201f);\r\nsungem_phy_write(phy, 0x15, 0x0a20);\r\n}\r\ndata = sungem_phy_read(phy, MII_BCM5400_GB_CONTROL);\r\ndata |= MII_BCM5400_GB_CONTROL_FULLDUPLEXCAP;\r\nsungem_phy_write(phy, MII_BCM5400_GB_CONTROL, data);\r\nudelay(10);\r\n(void)reset_one_mii_phy(phy, 0x1f);\r\ndata = __sungem_phy_read(phy, 0x1f, MII_BCM5201_MULTIPHY);\r\ndata |= MII_BCM5201_MULTIPHY_SERIALMODE;\r\n__sungem_phy_write(phy, 0x1f, MII_BCM5201_MULTIPHY, data);\r\nreturn 0;\r\n}\r\nstatic int bcm5401_suspend(struct mii_phy* phy)\r\n{\r\n#if 0\r\nsungem_phy_write(phy, MII_BMCR, BMCR_PDOWN);\r\n#endif\r\nreturn 0;\r\n}\r\nstatic int bcm5411_init(struct mii_phy* phy)\r\n{\r\nu16 data;\r\nsungem_phy_write(phy, 0x1c, 0x8c23);\r\nsungem_phy_write(phy, 0x1c, 0x8ca3);\r\nsungem_phy_write(phy, 0x1c, 0x8c23);\r\nsungem_phy_write(phy, MII_BMCR, BMCR_RESET);\r\nsungem_phy_write(phy, MII_BMCR, 0x1340);\r\ndata = sungem_phy_read(phy, MII_BCM5400_GB_CONTROL);\r\ndata |= MII_BCM5400_GB_CONTROL_FULLDUPLEXCAP;\r\nsungem_phy_write(phy, MII_BCM5400_GB_CONTROL, data);\r\nudelay(10);\r\n(void)reset_one_mii_phy(phy, 0x1f);\r\nreturn 0;\r\n}\r\nstatic int genmii_setup_aneg(struct mii_phy *phy, u32 advertise)\r\n{\r\nu16 ctl, adv;\r\nphy->autoneg = 1;\r\nphy->speed = SPEED_10;\r\nphy->duplex = DUPLEX_HALF;\r\nphy->pause = 0;\r\nphy->advertising = advertise;\r\nadv = sungem_phy_read(phy, MII_ADVERTISE);\r\nadv &= ~(ADVERTISE_ALL | ADVERTISE_100BASE4);\r\nif (advertise & ADVERTISED_10baseT_Half)\r\nadv |= ADVERTISE_10HALF;\r\nif (advertise & ADVERTISED_10baseT_Full)\r\nadv |= ADVERTISE_10FULL;\r\nif (advertise & ADVERTISED_100baseT_Half)\r\nadv |= ADVERTISE_100HALF;\r\nif (advertise & ADVERTISED_100baseT_Full)\r\nadv |= ADVERTISE_100FULL;\r\nsungem_phy_write(phy, MII_ADVERTISE, adv);\r\nctl = sungem_phy_read(phy, MII_BMCR);\r\nctl |= (BMCR_ANENABLE | BMCR_ANRESTART);\r\nsungem_phy_write(phy, MII_BMCR, ctl);\r\nreturn 0;\r\n}\r\nstatic int genmii_setup_forced(struct mii_phy *phy, int speed, int fd)\r\n{\r\nu16 ctl;\r\nphy->autoneg = 0;\r\nphy->speed = speed;\r\nphy->duplex = fd;\r\nphy->pause = 0;\r\nctl = sungem_phy_read(phy, MII_BMCR);\r\nctl &= ~(BMCR_FULLDPLX|BMCR_SPEED100|BMCR_ANENABLE);\r\nsungem_phy_write(phy, MII_BMCR, ctl | BMCR_RESET);\r\nswitch(speed) {\r\ncase SPEED_10:\r\nbreak;\r\ncase SPEED_100:\r\nctl |= BMCR_SPEED100;\r\nbreak;\r\ncase SPEED_1000:\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (fd == DUPLEX_FULL)\r\nctl |= BMCR_FULLDPLX;\r\nsungem_phy_write(phy, MII_BMCR, ctl);\r\nreturn 0;\r\n}\r\nstatic int genmii_poll_link(struct mii_phy *phy)\r\n{\r\nu16 status;\r\n(void)sungem_phy_read(phy, MII_BMSR);\r\nstatus = sungem_phy_read(phy, MII_BMSR);\r\nif ((status & BMSR_LSTATUS) == 0)\r\nreturn 0;\r\nif (phy->autoneg && !(status & BMSR_ANEGCOMPLETE))\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic int genmii_read_link(struct mii_phy *phy)\r\n{\r\nu16 lpa;\r\nif (phy->autoneg) {\r\nlpa = sungem_phy_read(phy, MII_LPA);\r\nif (lpa & (LPA_10FULL | LPA_100FULL))\r\nphy->duplex = DUPLEX_FULL;\r\nelse\r\nphy->duplex = DUPLEX_HALF;\r\nif (lpa & (LPA_100FULL | LPA_100HALF))\r\nphy->speed = SPEED_100;\r\nelse\r\nphy->speed = SPEED_10;\r\nphy->pause = 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int generic_suspend(struct mii_phy* phy)\r\n{\r\nsungem_phy_write(phy, MII_BMCR, BMCR_PDOWN);\r\nreturn 0;\r\n}\r\nstatic int bcm5421_init(struct mii_phy* phy)\r\n{\r\nu16 data;\r\nunsigned int id;\r\nid = (sungem_phy_read(phy, MII_PHYSID1) << 16 | sungem_phy_read(phy, MII_PHYSID2));\r\nif (id == 0x002060e0) {\r\nsungem_phy_write(phy, 0x18, 0x1007);\r\ndata = sungem_phy_read(phy, 0x18);\r\nsungem_phy_write(phy, 0x18, data | 0x0400);\r\nsungem_phy_write(phy, 0x18, 0x0007);\r\ndata = sungem_phy_read(phy, 0x18);\r\nsungem_phy_write(phy, 0x18, data | 0x0800);\r\nsungem_phy_write(phy, 0x17, 0x000a);\r\ndata = sungem_phy_read(phy, 0x15);\r\nsungem_phy_write(phy, 0x15, data | 0x0200);\r\n}\r\nif ((id & 0xfffffff0) == 0x002062e0) {\r\nsungem_phy_write(phy, 4, 0x01e1);\r\nsungem_phy_write(phy, 9, 0x0300);\r\n}\r\n#ifdef CONFIG_PPC_PMAC\r\nif (phy->platform_data) {\r\nstruct device_node *np = of_get_parent(phy->platform_data);\r\nint can_low_power = 1;\r\nif (np == NULL || of_get_property(np, "no-autolowpower", NULL))\r\ncan_low_power = 0;\r\nif (can_low_power) {\r\nsungem_phy_write(phy, 0x1c, 0x9002);\r\nsungem_phy_write(phy, 0x1c, 0xa821);\r\nsungem_phy_write(phy, 0x1c, 0x941d);\r\n}\r\n}\r\n#endif\r\nreturn 0;\r\n}\r\nstatic int bcm54xx_setup_aneg(struct mii_phy *phy, u32 advertise)\r\n{\r\nu16 ctl, adv;\r\nphy->autoneg = 1;\r\nphy->speed = SPEED_10;\r\nphy->duplex = DUPLEX_HALF;\r\nphy->pause = 0;\r\nphy->advertising = advertise;\r\nadv = sungem_phy_read(phy, MII_ADVERTISE);\r\nadv &= ~(ADVERTISE_ALL | ADVERTISE_100BASE4);\r\nif (advertise & ADVERTISED_10baseT_Half)\r\nadv |= ADVERTISE_10HALF;\r\nif (advertise & ADVERTISED_10baseT_Full)\r\nadv |= ADVERTISE_10FULL;\r\nif (advertise & ADVERTISED_100baseT_Half)\r\nadv |= ADVERTISE_100HALF;\r\nif (advertise & ADVERTISED_100baseT_Full)\r\nadv |= ADVERTISE_100FULL;\r\nif (advertise & ADVERTISED_Pause)\r\nadv |= ADVERTISE_PAUSE_CAP;\r\nif (advertise & ADVERTISED_Asym_Pause)\r\nadv |= ADVERTISE_PAUSE_ASYM;\r\nsungem_phy_write(phy, MII_ADVERTISE, adv);\r\nadv = sungem_phy_read(phy, MII_1000BASETCONTROL);\r\nadv &= ~(MII_1000BASETCONTROL_FULLDUPLEXCAP|MII_1000BASETCONTROL_HALFDUPLEXCAP);\r\nif (advertise & SUPPORTED_1000baseT_Half)\r\nadv |= MII_1000BASETCONTROL_HALFDUPLEXCAP;\r\nif (advertise & SUPPORTED_1000baseT_Full)\r\nadv |= MII_1000BASETCONTROL_FULLDUPLEXCAP;\r\nsungem_phy_write(phy, MII_1000BASETCONTROL, adv);\r\nctl = sungem_phy_read(phy, MII_BMCR);\r\nctl |= (BMCR_ANENABLE | BMCR_ANRESTART);\r\nsungem_phy_write(phy, MII_BMCR, ctl);\r\nreturn 0;\r\n}\r\nstatic int bcm54xx_setup_forced(struct mii_phy *phy, int speed, int fd)\r\n{\r\nu16 ctl;\r\nphy->autoneg = 0;\r\nphy->speed = speed;\r\nphy->duplex = fd;\r\nphy->pause = 0;\r\nctl = sungem_phy_read(phy, MII_BMCR);\r\nctl &= ~(BMCR_FULLDPLX|BMCR_SPEED100|BMCR_SPD2|BMCR_ANENABLE);\r\nsungem_phy_write(phy, MII_BMCR, ctl | BMCR_RESET);\r\nswitch(speed) {\r\ncase SPEED_10:\r\nbreak;\r\ncase SPEED_100:\r\nctl |= BMCR_SPEED100;\r\nbreak;\r\ncase SPEED_1000:\r\nctl |= BMCR_SPD2;\r\n}\r\nif (fd == DUPLEX_FULL)\r\nctl |= BMCR_FULLDPLX;\r\nsungem_phy_write(phy, MII_BMCR, ctl);\r\nreturn 0;\r\n}\r\nstatic int bcm54xx_read_link(struct mii_phy *phy)\r\n{\r\nint link_mode;\r\nu16 val;\r\nif (phy->autoneg) {\r\nval = sungem_phy_read(phy, MII_BCM5400_AUXSTATUS);\r\nlink_mode = ((val & MII_BCM5400_AUXSTATUS_LINKMODE_MASK) >>\r\nMII_BCM5400_AUXSTATUS_LINKMODE_SHIFT);\r\nphy->duplex = phy_BCM5400_link_table[link_mode][0] ?\r\nDUPLEX_FULL : DUPLEX_HALF;\r\nphy->speed = phy_BCM5400_link_table[link_mode][2] ?\r\nSPEED_1000 :\r\n(phy_BCM5400_link_table[link_mode][1] ?\r\nSPEED_100 : SPEED_10);\r\nval = sungem_phy_read(phy, MII_LPA);\r\nphy->pause = (phy->duplex == DUPLEX_FULL) &&\r\n((val & LPA_PAUSE) != 0);\r\n}\r\nreturn 0;\r\n}\r\nstatic int marvell88e1111_init(struct mii_phy* phy)\r\n{\r\nu16 rev;\r\nrev = sungem_phy_read(phy, MII_PHYSID2) & 0x000f;\r\nif (rev == 0) {\r\nsungem_phy_write(phy, 0x1d, 0x000a);\r\nsungem_phy_write(phy, 0x1e, 0x0821);\r\nsungem_phy_write(phy, 0x1d, 0x0006);\r\nsungem_phy_write(phy, 0x1e, 0x8600);\r\nsungem_phy_write(phy, 0x1d, 0x000b);\r\nsungem_phy_write(phy, 0x1e, 0x0100);\r\nsungem_phy_write(phy, 0x1d, 0x0004);\r\nsungem_phy_write(phy, 0x1e, 0x4850);\r\n}\r\nreturn 0;\r\n}\r\nstatic int bcm5421_poll_link(struct mii_phy* phy)\r\n{\r\nu32 phy_reg;\r\nint mode;\r\nsungem_phy_write(phy, MII_NCONFIG, 0x1000);\r\nphy_reg = sungem_phy_read(phy, MII_NCONFIG);\r\nmode = (phy_reg & BCM5421_MODE_MASK) >> 5;\r\nif ( mode == BCM54XX_COPPER)\r\nreturn genmii_poll_link(phy);\r\nsungem_phy_write(phy, MII_NCONFIG, 0x2000);\r\nphy_reg = sungem_phy_read(phy, MII_NCONFIG);\r\nif (phy_reg & 0x0020)\r\nreturn 0;\r\nelse\r\nreturn 1;\r\n}\r\nstatic int bcm5421_read_link(struct mii_phy* phy)\r\n{\r\nu32 phy_reg;\r\nint mode;\r\nsungem_phy_write(phy, MII_NCONFIG, 0x1000);\r\nphy_reg = sungem_phy_read(phy, MII_NCONFIG);\r\nmode = (phy_reg & BCM5421_MODE_MASK ) >> 5;\r\nif ( mode == BCM54XX_COPPER)\r\nreturn bcm54xx_read_link(phy);\r\nphy->speed = SPEED_1000;\r\nsungem_phy_write(phy, MII_NCONFIG, 0x2000);\r\nphy_reg = sungem_phy_read(phy, MII_NCONFIG);\r\nif ( (phy_reg & 0x0080) >> 7)\r\nphy->duplex |= DUPLEX_HALF;\r\nelse\r\nphy->duplex |= DUPLEX_FULL;\r\nreturn 0;\r\n}\r\nstatic int bcm5421_enable_fiber(struct mii_phy* phy, int autoneg)\r\n{\r\nsungem_phy_write(phy, MII_NCONFIG, 0x9020);\r\nsungem_phy_write(phy, MII_NCONFIG, 0x945f);\r\nif (!autoneg) {\r\nsungem_phy_write(phy, MII_NCONFIG, 0xfc01);\r\nsungem_phy_write(phy, 0x0b, 0x0004);\r\n}\r\nphy->autoneg = autoneg;\r\nreturn 0;\r\n}\r\nstatic int bcm5461_poll_link(struct mii_phy* phy)\r\n{\r\nu32 phy_reg;\r\nint mode;\r\nsungem_phy_write(phy, MII_NCONFIG, 0x7c00);\r\nphy_reg = sungem_phy_read(phy, MII_NCONFIG);\r\nmode = (phy_reg & BCM5461_MODE_MASK ) >> 1;\r\nif ( mode == BCM54XX_COPPER)\r\nreturn genmii_poll_link(phy);\r\nsungem_phy_write(phy, MII_NCONFIG, 0x7000);\r\nphy_reg = sungem_phy_read(phy, MII_NCONFIG);\r\nif (phy_reg & BCM5461_FIBER_LINK)\r\nreturn 1;\r\nelse\r\nreturn 0;\r\n}\r\nstatic int bcm5461_read_link(struct mii_phy* phy)\r\n{\r\nu32 phy_reg;\r\nint mode;\r\nsungem_phy_write(phy, MII_NCONFIG, 0x7c00);\r\nphy_reg = sungem_phy_read(phy, MII_NCONFIG);\r\nmode = (phy_reg & BCM5461_MODE_MASK ) >> 1;\r\nif ( mode == BCM54XX_COPPER) {\r\nreturn bcm54xx_read_link(phy);\r\n}\r\nphy->speed = SPEED_1000;\r\nsungem_phy_write(phy, MII_NCONFIG, 0x7000);\r\nphy_reg = sungem_phy_read(phy, MII_NCONFIG);\r\nif (phy_reg & BCM5461_FIBER_DUPLEX)\r\nphy->duplex |= DUPLEX_FULL;\r\nelse\r\nphy->duplex |= DUPLEX_HALF;\r\nreturn 0;\r\n}\r\nstatic int bcm5461_enable_fiber(struct mii_phy* phy, int autoneg)\r\n{\r\nsungem_phy_write(phy, MII_NCONFIG, 0xfc0b);\r\nif (autoneg) {\r\nsungem_phy_write(phy, MII_ADVERTISE, 0x01e0);\r\nsungem_phy_write(phy, MII_BMCR, 0x1140);\r\n} else {\r\nsungem_phy_write(phy, MII_BMCR, 0x0140);\r\n}\r\nphy->autoneg = autoneg;\r\nreturn 0;\r\n}\r\nstatic int marvell_setup_aneg(struct mii_phy *phy, u32 advertise)\r\n{\r\nu16 ctl, adv;\r\nphy->autoneg = 1;\r\nphy->speed = SPEED_10;\r\nphy->duplex = DUPLEX_HALF;\r\nphy->pause = 0;\r\nphy->advertising = advertise;\r\nadv = sungem_phy_read(phy, MII_ADVERTISE);\r\nadv &= ~(ADVERTISE_ALL | ADVERTISE_100BASE4);\r\nif (advertise & ADVERTISED_10baseT_Half)\r\nadv |= ADVERTISE_10HALF;\r\nif (advertise & ADVERTISED_10baseT_Full)\r\nadv |= ADVERTISE_10FULL;\r\nif (advertise & ADVERTISED_100baseT_Half)\r\nadv |= ADVERTISE_100HALF;\r\nif (advertise & ADVERTISED_100baseT_Full)\r\nadv |= ADVERTISE_100FULL;\r\nif (advertise & ADVERTISED_Pause)\r\nadv |= ADVERTISE_PAUSE_CAP;\r\nif (advertise & ADVERTISED_Asym_Pause)\r\nadv |= ADVERTISE_PAUSE_ASYM;\r\nsungem_phy_write(phy, MII_ADVERTISE, adv);\r\nadv = sungem_phy_read(phy, MII_M1011_PHY_SPEC_CONTROL);\r\nadv |= MII_M1011_PHY_SPEC_CONTROL_AUTO_MDIX;\r\nadv &= ~(MII_1000BASETCONTROL_FULLDUPLEXCAP |\r\nMII_1000BASETCONTROL_HALFDUPLEXCAP);\r\nif (advertise & SUPPORTED_1000baseT_Half)\r\nadv |= MII_1000BASETCONTROL_HALFDUPLEXCAP;\r\nif (advertise & SUPPORTED_1000baseT_Full)\r\nadv |= MII_1000BASETCONTROL_FULLDUPLEXCAP;\r\nsungem_phy_write(phy, MII_1000BASETCONTROL, adv);\r\nctl = sungem_phy_read(phy, MII_BMCR);\r\nctl |= (BMCR_ANENABLE | BMCR_ANRESTART);\r\nsungem_phy_write(phy, MII_BMCR, ctl);\r\nreturn 0;\r\n}\r\nstatic int marvell_setup_forced(struct mii_phy *phy, int speed, int fd)\r\n{\r\nu16 ctl, ctl2;\r\nphy->autoneg = 0;\r\nphy->speed = speed;\r\nphy->duplex = fd;\r\nphy->pause = 0;\r\nctl = sungem_phy_read(phy, MII_BMCR);\r\nctl &= ~(BMCR_FULLDPLX|BMCR_SPEED100|BMCR_SPD2|BMCR_ANENABLE);\r\nctl |= BMCR_RESET;\r\nswitch(speed) {\r\ncase SPEED_10:\r\nbreak;\r\ncase SPEED_100:\r\nctl |= BMCR_SPEED100;\r\nbreak;\r\ncase SPEED_1000:\r\nctl |= BMCR_SPD2;\r\n}\r\nif (fd == DUPLEX_FULL)\r\nctl |= BMCR_FULLDPLX;\r\nctl2 = sungem_phy_read(phy, MII_M1011_PHY_SPEC_CONTROL);\r\nctl2 &= ~(MII_M1011_PHY_SPEC_CONTROL_MANUAL_MDIX |\r\nMII_M1011_PHY_SPEC_CONTROL_AUTO_MDIX |\r\nMII_1000BASETCONTROL_FULLDUPLEXCAP |\r\nMII_1000BASETCONTROL_HALFDUPLEXCAP);\r\nif (speed == SPEED_1000)\r\nctl2 |= (fd == DUPLEX_FULL) ?\r\nMII_1000BASETCONTROL_FULLDUPLEXCAP :\r\nMII_1000BASETCONTROL_HALFDUPLEXCAP;\r\nsungem_phy_write(phy, MII_1000BASETCONTROL, ctl2);\r\nsungem_phy_write(phy, MII_BMCR, ctl);\r\nreturn 0;\r\n}\r\nstatic int marvell_read_link(struct mii_phy *phy)\r\n{\r\nu16 status, pmask;\r\nif (phy->autoneg) {\r\nstatus = sungem_phy_read(phy, MII_M1011_PHY_SPEC_STATUS);\r\nif ((status & MII_M1011_PHY_SPEC_STATUS_RESOLVED) == 0)\r\nreturn -EAGAIN;\r\nif (status & MII_M1011_PHY_SPEC_STATUS_1000)\r\nphy->speed = SPEED_1000;\r\nelse if (status & MII_M1011_PHY_SPEC_STATUS_100)\r\nphy->speed = SPEED_100;\r\nelse\r\nphy->speed = SPEED_10;\r\nif (status & MII_M1011_PHY_SPEC_STATUS_FULLDUPLEX)\r\nphy->duplex = DUPLEX_FULL;\r\nelse\r\nphy->duplex = DUPLEX_HALF;\r\npmask = MII_M1011_PHY_SPEC_STATUS_TX_PAUSE |\r\nMII_M1011_PHY_SPEC_STATUS_RX_PAUSE;\r\nphy->pause = (status & pmask) == pmask;\r\n}\r\nreturn 0;\r\n}\r\nint sungem_phy_probe(struct mii_phy *phy, int mii_id)\r\n{\r\nint rc;\r\nu32 id;\r\nstruct mii_phy_def* def;\r\nint i;\r\nphy->mii_id = mii_id;\r\nrc = reset_one_mii_phy(phy, mii_id);\r\nif (rc)\r\ngoto fail;\r\nid = (sungem_phy_read(phy, MII_PHYSID1) << 16 | sungem_phy_read(phy, MII_PHYSID2));\r\nprintk(KERN_DEBUG KBUILD_MODNAME ": " "PHY ID: %x, addr: %x\n",\r\nid, mii_id);\r\nfor (i=0; (def = mii_phy_table[i]) != NULL; i++)\r\nif ((id & def->phy_id_mask) == def->phy_id)\r\nbreak;\r\nif (def == NULL)\r\ngoto fail;\r\nphy->def = def;\r\nreturn 0;\r\nfail:\r\nphy->speed = 0;\r\nphy->duplex = 0;\r\nphy->pause = 0;\r\nphy->advertising = 0;\r\nreturn -ENODEV;\r\n}

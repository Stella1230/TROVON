static struct se_device *to_stat_dev(struct config_item *item)\r\n{\r\nstruct se_dev_stat_grps *sgrps = container_of(to_config_group(item),\r\nstruct se_dev_stat_grps, scsi_dev_group);\r\nreturn container_of(sgrps, struct se_device, dev_stat_grps);\r\n}\r\nstatic ssize_t target_stat_inst_show(struct config_item *item, char *page)\r\n{\r\nstruct se_hba *hba = to_stat_dev(item)->se_hba;\r\nreturn snprintf(page, PAGE_SIZE, "%u\n", hba->hba_index);\r\n}\r\nstatic ssize_t target_stat_indx_show(struct config_item *item, char *page)\r\n{\r\nreturn snprintf(page, PAGE_SIZE, "%u\n", to_stat_dev(item)->dev_index);\r\n}\r\nstatic ssize_t target_stat_role_show(struct config_item *item, char *page)\r\n{\r\nreturn snprintf(page, PAGE_SIZE, "Target\n");\r\n}\r\nstatic ssize_t target_stat_ports_show(struct config_item *item, char *page)\r\n{\r\nreturn snprintf(page, PAGE_SIZE, "%u\n", to_stat_dev(item)->export_count);\r\n}\r\nstatic struct se_device *to_stat_tgt_dev(struct config_item *item)\r\n{\r\nstruct se_dev_stat_grps *sgrps = container_of(to_config_group(item),\r\nstruct se_dev_stat_grps, scsi_tgt_dev_group);\r\nreturn container_of(sgrps, struct se_device, dev_stat_grps);\r\n}\r\nstatic ssize_t target_stat_tgt_inst_show(struct config_item *item, char *page)\r\n{\r\nstruct se_hba *hba = to_stat_tgt_dev(item)->se_hba;\r\nreturn snprintf(page, PAGE_SIZE, "%u\n", hba->hba_index);\r\n}\r\nstatic ssize_t target_stat_tgt_indx_show(struct config_item *item, char *page)\r\n{\r\nreturn snprintf(page, PAGE_SIZE, "%u\n", to_stat_tgt_dev(item)->dev_index);\r\n}\r\nstatic ssize_t target_stat_tgt_num_lus_show(struct config_item *item,\r\nchar *page)\r\n{\r\nreturn snprintf(page, PAGE_SIZE, "%u\n", LU_COUNT);\r\n}\r\nstatic ssize_t target_stat_tgt_status_show(struct config_item *item,\r\nchar *page)\r\n{\r\nif (to_stat_tgt_dev(item)->export_count)\r\nreturn snprintf(page, PAGE_SIZE, "activated");\r\nelse\r\nreturn snprintf(page, PAGE_SIZE, "deactivated");\r\n}\r\nstatic ssize_t target_stat_tgt_non_access_lus_show(struct config_item *item,\r\nchar *page)\r\n{\r\nint non_accessible_lus;\r\nif (to_stat_tgt_dev(item)->export_count)\r\nnon_accessible_lus = 0;\r\nelse\r\nnon_accessible_lus = 1;\r\nreturn snprintf(page, PAGE_SIZE, "%u\n", non_accessible_lus);\r\n}\r\nstatic ssize_t target_stat_tgt_resets_show(struct config_item *item,\r\nchar *page)\r\n{\r\nreturn snprintf(page, PAGE_SIZE, "%lu\n",\r\natomic_long_read(&to_stat_tgt_dev(item)->num_resets));\r\n}\r\nstatic struct se_device *to_stat_lu_dev(struct config_item *item)\r\n{\r\nstruct se_dev_stat_grps *sgrps = container_of(to_config_group(item),\r\nstruct se_dev_stat_grps, scsi_lu_group);\r\nreturn container_of(sgrps, struct se_device, dev_stat_grps);\r\n}\r\nstatic ssize_t target_stat_lu_inst_show(struct config_item *item, char *page)\r\n{\r\nstruct se_hba *hba = to_stat_lu_dev(item)->se_hba;\r\nreturn snprintf(page, PAGE_SIZE, "%u\n", hba->hba_index);\r\n}\r\nstatic ssize_t target_stat_lu_dev_show(struct config_item *item, char *page)\r\n{\r\nreturn snprintf(page, PAGE_SIZE, "%u\n",\r\nto_stat_lu_dev(item)->dev_index);\r\n}\r\nstatic ssize_t target_stat_lu_indx_show(struct config_item *item, char *page)\r\n{\r\nreturn snprintf(page, PAGE_SIZE, "%u\n", SCSI_LU_INDEX);\r\n}\r\nstatic ssize_t target_stat_lu_lun_show(struct config_item *item, char *page)\r\n{\r\nreturn snprintf(page, PAGE_SIZE, "%llu\n", (unsigned long long)0);\r\n}\r\nstatic ssize_t target_stat_lu_lu_name_show(struct config_item *item, char *page)\r\n{\r\nstruct se_device *dev = to_stat_lu_dev(item);\r\nreturn snprintf(page, PAGE_SIZE, "%s\n",\r\n(strlen(dev->t10_wwn.unit_serial)) ?\r\ndev->t10_wwn.unit_serial : "None");\r\n}\r\nstatic ssize_t target_stat_lu_vend_show(struct config_item *item, char *page)\r\n{\r\nstruct se_device *dev = to_stat_lu_dev(item);\r\nint i;\r\nchar str[sizeof(dev->t10_wwn.vendor)+1];\r\nfor (i = 0; i < sizeof(dev->t10_wwn.vendor); i++)\r\nstr[i] = ISPRINT(dev->t10_wwn.vendor[i]) ?\r\ndev->t10_wwn.vendor[i] : ' ';\r\nstr[i] = '\0';\r\nreturn snprintf(page, PAGE_SIZE, "%s\n", str);\r\n}\r\nstatic ssize_t target_stat_lu_prod_show(struct config_item *item, char *page)\r\n{\r\nstruct se_device *dev = to_stat_lu_dev(item);\r\nint i;\r\nchar str[sizeof(dev->t10_wwn.model)+1];\r\nfor (i = 0; i < sizeof(dev->t10_wwn.model); i++)\r\nstr[i] = ISPRINT(dev->t10_wwn.model[i]) ?\r\ndev->t10_wwn.model[i] : ' ';\r\nstr[i] = '\0';\r\nreturn snprintf(page, PAGE_SIZE, "%s\n", str);\r\n}\r\nstatic ssize_t target_stat_lu_rev_show(struct config_item *item, char *page)\r\n{\r\nstruct se_device *dev = to_stat_lu_dev(item);\r\nint i;\r\nchar str[sizeof(dev->t10_wwn.revision)+1];\r\nfor (i = 0; i < sizeof(dev->t10_wwn.revision); i++)\r\nstr[i] = ISPRINT(dev->t10_wwn.revision[i]) ?\r\ndev->t10_wwn.revision[i] : ' ';\r\nstr[i] = '\0';\r\nreturn snprintf(page, PAGE_SIZE, "%s\n", str);\r\n}\r\nstatic ssize_t target_stat_lu_dev_type_show(struct config_item *item, char *page)\r\n{\r\nstruct se_device *dev = to_stat_lu_dev(item);\r\nreturn snprintf(page, PAGE_SIZE, "%u\n",\r\ndev->transport->get_device_type(dev));\r\n}\r\nstatic ssize_t target_stat_lu_status_show(struct config_item *item, char *page)\r\n{\r\nstruct se_device *dev = to_stat_lu_dev(item);\r\nreturn snprintf(page, PAGE_SIZE, "%s\n",\r\n(dev->export_count) ? "available" : "notavailable");\r\n}\r\nstatic ssize_t target_stat_lu_state_bit_show(struct config_item *item,\r\nchar *page)\r\n{\r\nreturn snprintf(page, PAGE_SIZE, "exposed\n");\r\n}\r\nstatic ssize_t target_stat_lu_num_cmds_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_device *dev = to_stat_lu_dev(item);\r\nreturn snprintf(page, PAGE_SIZE, "%lu\n",\r\natomic_long_read(&dev->num_cmds));\r\n}\r\nstatic ssize_t target_stat_lu_read_mbytes_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_device *dev = to_stat_lu_dev(item);\r\nreturn snprintf(page, PAGE_SIZE, "%lu\n",\r\natomic_long_read(&dev->read_bytes) >> 20);\r\n}\r\nstatic ssize_t target_stat_lu_write_mbytes_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_device *dev = to_stat_lu_dev(item);\r\nreturn snprintf(page, PAGE_SIZE, "%lu\n",\r\natomic_long_read(&dev->write_bytes) >> 20);\r\n}\r\nstatic ssize_t target_stat_lu_resets_show(struct config_item *item, char *page)\r\n{\r\nstruct se_device *dev = to_stat_lu_dev(item);\r\nreturn snprintf(page, PAGE_SIZE, "%lu\n",\r\natomic_long_read(&dev->num_resets));\r\n}\r\nstatic ssize_t target_stat_lu_full_stat_show(struct config_item *item,\r\nchar *page)\r\n{\r\nreturn snprintf(page, PAGE_SIZE, "%u\n", 0);\r\n}\r\nstatic ssize_t target_stat_lu_hs_num_cmds_show(struct config_item *item,\r\nchar *page)\r\n{\r\nreturn snprintf(page, PAGE_SIZE, "%u\n", 0);\r\n}\r\nstatic ssize_t target_stat_lu_creation_time_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_device *dev = to_stat_lu_dev(item);\r\nreturn snprintf(page, PAGE_SIZE, "%u\n", (u32)(((u32)dev->creation_time -\r\nINITIAL_JIFFIES) * 100 / HZ));\r\n}\r\nvoid target_stat_setup_dev_default_groups(struct se_device *dev)\r\n{\r\nstruct config_group *dev_stat_grp = &dev->dev_stat_grps.stat_group;\r\nconfig_group_init_type_name(&dev->dev_stat_grps.scsi_dev_group,\r\n"scsi_dev", &target_stat_scsi_dev_cit);\r\nconfig_group_init_type_name(&dev->dev_stat_grps.scsi_tgt_dev_group,\r\n"scsi_tgt_dev", &target_stat_scsi_tgt_dev_cit);\r\nconfig_group_init_type_name(&dev->dev_stat_grps.scsi_lu_group,\r\n"scsi_lu", &target_stat_scsi_lu_cit);\r\ndev_stat_grp->default_groups[0] = &dev->dev_stat_grps.scsi_dev_group;\r\ndev_stat_grp->default_groups[1] = &dev->dev_stat_grps.scsi_tgt_dev_group;\r\ndev_stat_grp->default_groups[2] = &dev->dev_stat_grps.scsi_lu_group;\r\ndev_stat_grp->default_groups[3] = NULL;\r\n}\r\nstatic struct se_lun *to_stat_port(struct config_item *item)\r\n{\r\nstruct se_port_stat_grps *pgrps = container_of(to_config_group(item),\r\nstruct se_port_stat_grps, scsi_port_group);\r\nreturn container_of(pgrps, struct se_lun, port_stat_grps);\r\n}\r\nstatic ssize_t target_stat_port_inst_show(struct config_item *item, char *page)\r\n{\r\nstruct se_lun *lun = to_stat_port(item);\r\nstruct se_device *dev;\r\nssize_t ret = -ENODEV;\r\nrcu_read_lock();\r\ndev = rcu_dereference(lun->lun_se_dev);\r\nif (dev)\r\nret = snprintf(page, PAGE_SIZE, "%u\n", dev->hba_index);\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_port_dev_show(struct config_item *item, char *page)\r\n{\r\nstruct se_lun *lun = to_stat_port(item);\r\nstruct se_device *dev;\r\nssize_t ret = -ENODEV;\r\nrcu_read_lock();\r\ndev = rcu_dereference(lun->lun_se_dev);\r\nif (dev)\r\nret = snprintf(page, PAGE_SIZE, "%u\n", dev->dev_index);\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_port_indx_show(struct config_item *item, char *page)\r\n{\r\nstruct se_lun *lun = to_stat_port(item);\r\nstruct se_device *dev;\r\nssize_t ret = -ENODEV;\r\nrcu_read_lock();\r\ndev = rcu_dereference(lun->lun_se_dev);\r\nif (dev)\r\nret = snprintf(page, PAGE_SIZE, "%u\n", lun->lun_rtpi);\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_port_role_show(struct config_item *item, char *page)\r\n{\r\nstruct se_lun *lun = to_stat_port(item);\r\nstruct se_device *dev;\r\nssize_t ret = -ENODEV;\r\nrcu_read_lock();\r\ndev = rcu_dereference(lun->lun_se_dev);\r\nif (dev)\r\nret = snprintf(page, PAGE_SIZE, "%s%u\n", "Device", dev->dev_index);\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_port_busy_count_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun *lun = to_stat_port(item);\r\nstruct se_device *dev;\r\nssize_t ret = -ENODEV;\r\nrcu_read_lock();\r\ndev = rcu_dereference(lun->lun_se_dev);\r\nif (dev) {\r\nret = snprintf(page, PAGE_SIZE, "%u\n", 0);\r\n}\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic struct se_lun *to_stat_tgt_port(struct config_item *item)\r\n{\r\nstruct se_port_stat_grps *pgrps = container_of(to_config_group(item),\r\nstruct se_port_stat_grps, scsi_tgt_port_group);\r\nreturn container_of(pgrps, struct se_lun, port_stat_grps);\r\n}\r\nstatic ssize_t target_stat_tgt_port_inst_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun *lun = to_stat_tgt_port(item);\r\nstruct se_device *dev;\r\nssize_t ret = -ENODEV;\r\nrcu_read_lock();\r\ndev = rcu_dereference(lun->lun_se_dev);\r\nif (dev)\r\nret = snprintf(page, PAGE_SIZE, "%u\n", dev->hba_index);\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_tgt_port_dev_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun *lun = to_stat_tgt_port(item);\r\nstruct se_device *dev;\r\nssize_t ret = -ENODEV;\r\nrcu_read_lock();\r\ndev = rcu_dereference(lun->lun_se_dev);\r\nif (dev)\r\nret = snprintf(page, PAGE_SIZE, "%u\n", dev->dev_index);\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_tgt_port_indx_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun *lun = to_stat_tgt_port(item);\r\nstruct se_device *dev;\r\nssize_t ret = -ENODEV;\r\nrcu_read_lock();\r\ndev = rcu_dereference(lun->lun_se_dev);\r\nif (dev)\r\nret = snprintf(page, PAGE_SIZE, "%u\n", lun->lun_rtpi);\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_tgt_port_name_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun *lun = to_stat_tgt_port(item);\r\nstruct se_portal_group *tpg = lun->lun_tpg;\r\nstruct se_device *dev;\r\nssize_t ret = -ENODEV;\r\nrcu_read_lock();\r\ndev = rcu_dereference(lun->lun_se_dev);\r\nif (dev)\r\nret = snprintf(page, PAGE_SIZE, "%sPort#%u\n",\r\ntpg->se_tpg_tfo->get_fabric_name(),\r\nlun->lun_rtpi);\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_tgt_port_port_index_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun *lun = to_stat_tgt_port(item);\r\nstruct se_portal_group *tpg = lun->lun_tpg;\r\nstruct se_device *dev;\r\nssize_t ret = -ENODEV;\r\nrcu_read_lock();\r\ndev = rcu_dereference(lun->lun_se_dev);\r\nif (dev)\r\nret = snprintf(page, PAGE_SIZE, "%s%s%d\n",\r\ntpg->se_tpg_tfo->tpg_get_wwn(tpg), "+t+",\r\ntpg->se_tpg_tfo->tpg_get_tag(tpg));\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_tgt_port_in_cmds_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun *lun = to_stat_tgt_port(item);\r\nstruct se_device *dev;\r\nssize_t ret = -ENODEV;\r\nrcu_read_lock();\r\ndev = rcu_dereference(lun->lun_se_dev);\r\nif (dev)\r\nret = snprintf(page, PAGE_SIZE, "%lu\n",\r\natomic_long_read(&lun->lun_stats.cmd_pdus));\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_tgt_port_write_mbytes_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun *lun = to_stat_tgt_port(item);\r\nstruct se_device *dev;\r\nssize_t ret = -ENODEV;\r\nrcu_read_lock();\r\ndev = rcu_dereference(lun->lun_se_dev);\r\nif (dev)\r\nret = snprintf(page, PAGE_SIZE, "%u\n",\r\n(u32)(atomic_long_read(&lun->lun_stats.rx_data_octets) >> 20));\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_tgt_port_read_mbytes_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun *lun = to_stat_tgt_port(item);\r\nstruct se_device *dev;\r\nssize_t ret = -ENODEV;\r\nrcu_read_lock();\r\ndev = rcu_dereference(lun->lun_se_dev);\r\nif (dev)\r\nret = snprintf(page, PAGE_SIZE, "%u\n",\r\n(u32)(atomic_long_read(&lun->lun_stats.tx_data_octets) >> 20));\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_tgt_port_hs_in_cmds_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun *lun = to_stat_tgt_port(item);\r\nstruct se_device *dev;\r\nssize_t ret = -ENODEV;\r\nrcu_read_lock();\r\ndev = rcu_dereference(lun->lun_se_dev);\r\nif (dev) {\r\nret = snprintf(page, PAGE_SIZE, "%u\n", 0);\r\n}\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic struct se_lun *to_transport_stat(struct config_item *item)\r\n{\r\nstruct se_port_stat_grps *pgrps = container_of(to_config_group(item),\r\nstruct se_port_stat_grps, scsi_transport_group);\r\nreturn container_of(pgrps, struct se_lun, port_stat_grps);\r\n}\r\nstatic ssize_t target_stat_transport_inst_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun *lun = to_transport_stat(item);\r\nstruct se_device *dev;\r\nssize_t ret = -ENODEV;\r\nrcu_read_lock();\r\ndev = rcu_dereference(lun->lun_se_dev);\r\nif (dev)\r\nret = snprintf(page, PAGE_SIZE, "%u\n", dev->hba_index);\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_transport_device_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun *lun = to_transport_stat(item);\r\nstruct se_device *dev;\r\nstruct se_portal_group *tpg = lun->lun_tpg;\r\nssize_t ret = -ENODEV;\r\nrcu_read_lock();\r\ndev = rcu_dereference(lun->lun_se_dev);\r\nif (dev) {\r\nret = snprintf(page, PAGE_SIZE, "scsiTransport%s\n",\r\ntpg->se_tpg_tfo->get_fabric_name());\r\n}\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_transport_indx_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun *lun = to_transport_stat(item);\r\nstruct se_device *dev;\r\nstruct se_portal_group *tpg = lun->lun_tpg;\r\nssize_t ret = -ENODEV;\r\nrcu_read_lock();\r\ndev = rcu_dereference(lun->lun_se_dev);\r\nif (dev)\r\nret = snprintf(page, PAGE_SIZE, "%u\n",\r\ntpg->se_tpg_tfo->tpg_get_inst_index(tpg));\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_transport_dev_name_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun *lun = to_transport_stat(item);\r\nstruct se_device *dev;\r\nstruct se_portal_group *tpg = lun->lun_tpg;\r\nstruct t10_wwn *wwn;\r\nssize_t ret = -ENODEV;\r\nrcu_read_lock();\r\ndev = rcu_dereference(lun->lun_se_dev);\r\nif (dev) {\r\nwwn = &dev->t10_wwn;\r\nret = snprintf(page, PAGE_SIZE, "%s+%s\n",\r\ntpg->se_tpg_tfo->tpg_get_wwn(tpg),\r\n(strlen(wwn->unit_serial)) ? wwn->unit_serial :\r\nwwn->vendor);\r\n}\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nvoid target_stat_setup_port_default_groups(struct se_lun *lun)\r\n{\r\nstruct config_group *port_stat_grp = &lun->port_stat_grps.stat_group;\r\nconfig_group_init_type_name(&lun->port_stat_grps.scsi_port_group,\r\n"scsi_port", &target_stat_scsi_port_cit);\r\nconfig_group_init_type_name(&lun->port_stat_grps.scsi_tgt_port_group,\r\n"scsi_tgt_port", &target_stat_scsi_tgt_port_cit);\r\nconfig_group_init_type_name(&lun->port_stat_grps.scsi_transport_group,\r\n"scsi_transport", &target_stat_scsi_transport_cit);\r\nport_stat_grp->default_groups[0] = &lun->port_stat_grps.scsi_port_group;\r\nport_stat_grp->default_groups[1] = &lun->port_stat_grps.scsi_tgt_port_group;\r\nport_stat_grp->default_groups[2] = &lun->port_stat_grps.scsi_transport_group;\r\nport_stat_grp->default_groups[3] = NULL;\r\n}\r\nstatic struct se_lun_acl *auth_to_lacl(struct config_item *item)\r\n{\r\nstruct se_ml_stat_grps *lgrps = container_of(to_config_group(item),\r\nstruct se_ml_stat_grps, scsi_auth_intr_group);\r\nreturn container_of(lgrps, struct se_lun_acl, ml_stat_grps);\r\n}\r\nstatic ssize_t target_stat_auth_inst_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun_acl *lacl = auth_to_lacl(item);\r\nstruct se_node_acl *nacl = lacl->se_lun_nacl;\r\nstruct se_dev_entry *deve;\r\nstruct se_portal_group *tpg;\r\nssize_t ret;\r\nrcu_read_lock();\r\ndeve = target_nacl_find_deve(nacl, lacl->mapped_lun);\r\nif (!deve) {\r\nrcu_read_unlock();\r\nreturn -ENODEV;\r\n}\r\ntpg = nacl->se_tpg;\r\nret = snprintf(page, PAGE_SIZE, "%u\n",\r\ntpg->se_tpg_tfo->tpg_get_inst_index(tpg));\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_auth_dev_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun_acl *lacl = auth_to_lacl(item);\r\nstruct se_node_acl *nacl = lacl->se_lun_nacl;\r\nstruct se_dev_entry *deve;\r\nstruct se_lun *lun;\r\nssize_t ret;\r\nrcu_read_lock();\r\ndeve = target_nacl_find_deve(nacl, lacl->mapped_lun);\r\nif (!deve) {\r\nrcu_read_unlock();\r\nreturn -ENODEV;\r\n}\r\nlun = rcu_dereference(deve->se_lun);\r\nret = snprintf(page, PAGE_SIZE, "%u\n", lun->lun_index);\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_auth_port_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun_acl *lacl = auth_to_lacl(item);\r\nstruct se_node_acl *nacl = lacl->se_lun_nacl;\r\nstruct se_dev_entry *deve;\r\nstruct se_portal_group *tpg;\r\nssize_t ret;\r\nrcu_read_lock();\r\ndeve = target_nacl_find_deve(nacl, lacl->mapped_lun);\r\nif (!deve) {\r\nrcu_read_unlock();\r\nreturn -ENODEV;\r\n}\r\ntpg = nacl->se_tpg;\r\nret = snprintf(page, PAGE_SIZE, "%u\n", tpg->se_tpg_tfo->tpg_get_tag(tpg));\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_auth_indx_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun_acl *lacl = auth_to_lacl(item);\r\nstruct se_node_acl *nacl = lacl->se_lun_nacl;\r\nstruct se_dev_entry *deve;\r\nssize_t ret;\r\nrcu_read_lock();\r\ndeve = target_nacl_find_deve(nacl, lacl->mapped_lun);\r\nif (!deve) {\r\nrcu_read_unlock();\r\nreturn -ENODEV;\r\n}\r\nret = snprintf(page, PAGE_SIZE, "%u\n", nacl->acl_index);\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_auth_dev_or_port_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun_acl *lacl = auth_to_lacl(item);\r\nstruct se_node_acl *nacl = lacl->se_lun_nacl;\r\nstruct se_dev_entry *deve;\r\nssize_t ret;\r\nrcu_read_lock();\r\ndeve = target_nacl_find_deve(nacl, lacl->mapped_lun);\r\nif (!deve) {\r\nrcu_read_unlock();\r\nreturn -ENODEV;\r\n}\r\nret = snprintf(page, PAGE_SIZE, "%u\n", 1);\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_auth_intr_name_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun_acl *lacl = auth_to_lacl(item);\r\nstruct se_node_acl *nacl = lacl->se_lun_nacl;\r\nstruct se_dev_entry *deve;\r\nssize_t ret;\r\nrcu_read_lock();\r\ndeve = target_nacl_find_deve(nacl, lacl->mapped_lun);\r\nif (!deve) {\r\nrcu_read_unlock();\r\nreturn -ENODEV;\r\n}\r\nret = snprintf(page, PAGE_SIZE, "%s\n", nacl->initiatorname);\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_auth_map_indx_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun_acl *lacl = auth_to_lacl(item);\r\nstruct se_node_acl *nacl = lacl->se_lun_nacl;\r\nstruct se_dev_entry *deve;\r\nssize_t ret;\r\nrcu_read_lock();\r\ndeve = target_nacl_find_deve(nacl, lacl->mapped_lun);\r\nif (!deve) {\r\nrcu_read_unlock();\r\nreturn -ENODEV;\r\n}\r\nret = snprintf(page, PAGE_SIZE, "%u\n", 0);\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_auth_att_count_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun_acl *lacl = auth_to_lacl(item);\r\nstruct se_node_acl *nacl = lacl->se_lun_nacl;\r\nstruct se_dev_entry *deve;\r\nssize_t ret;\r\nrcu_read_lock();\r\ndeve = target_nacl_find_deve(nacl, lacl->mapped_lun);\r\nif (!deve) {\r\nrcu_read_unlock();\r\nreturn -ENODEV;\r\n}\r\nret = snprintf(page, PAGE_SIZE, "%u\n", deve->attach_count);\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_auth_num_cmds_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun_acl *lacl = auth_to_lacl(item);\r\nstruct se_node_acl *nacl = lacl->se_lun_nacl;\r\nstruct se_dev_entry *deve;\r\nssize_t ret;\r\nrcu_read_lock();\r\ndeve = target_nacl_find_deve(nacl, lacl->mapped_lun);\r\nif (!deve) {\r\nrcu_read_unlock();\r\nreturn -ENODEV;\r\n}\r\nret = snprintf(page, PAGE_SIZE, "%lu\n",\r\natomic_long_read(&deve->total_cmds));\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_auth_read_mbytes_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun_acl *lacl = auth_to_lacl(item);\r\nstruct se_node_acl *nacl = lacl->se_lun_nacl;\r\nstruct se_dev_entry *deve;\r\nssize_t ret;\r\nrcu_read_lock();\r\ndeve = target_nacl_find_deve(nacl, lacl->mapped_lun);\r\nif (!deve) {\r\nrcu_read_unlock();\r\nreturn -ENODEV;\r\n}\r\nret = snprintf(page, PAGE_SIZE, "%u\n",\r\n(u32)(atomic_long_read(&deve->read_bytes) >> 20));\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_auth_write_mbytes_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun_acl *lacl = auth_to_lacl(item);\r\nstruct se_node_acl *nacl = lacl->se_lun_nacl;\r\nstruct se_dev_entry *deve;\r\nssize_t ret;\r\nrcu_read_lock();\r\ndeve = target_nacl_find_deve(nacl, lacl->mapped_lun);\r\nif (!deve) {\r\nrcu_read_unlock();\r\nreturn -ENODEV;\r\n}\r\nret = snprintf(page, PAGE_SIZE, "%u\n",\r\n(u32)(atomic_long_read(&deve->write_bytes) >> 20));\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_auth_hs_num_cmds_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun_acl *lacl = auth_to_lacl(item);\r\nstruct se_node_acl *nacl = lacl->se_lun_nacl;\r\nstruct se_dev_entry *deve;\r\nssize_t ret;\r\nrcu_read_lock();\r\ndeve = target_nacl_find_deve(nacl, lacl->mapped_lun);\r\nif (!deve) {\r\nrcu_read_unlock();\r\nreturn -ENODEV;\r\n}\r\nret = snprintf(page, PAGE_SIZE, "%u\n", 0);\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_auth_creation_time_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun_acl *lacl = auth_to_lacl(item);\r\nstruct se_node_acl *nacl = lacl->se_lun_nacl;\r\nstruct se_dev_entry *deve;\r\nssize_t ret;\r\nrcu_read_lock();\r\ndeve = target_nacl_find_deve(nacl, lacl->mapped_lun);\r\nif (!deve) {\r\nrcu_read_unlock();\r\nreturn -ENODEV;\r\n}\r\nret = snprintf(page, PAGE_SIZE, "%u\n", (u32)(((u32)deve->creation_time -\r\nINITIAL_JIFFIES) * 100 / HZ));\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_auth_row_status_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun_acl *lacl = auth_to_lacl(item);\r\nstruct se_node_acl *nacl = lacl->se_lun_nacl;\r\nstruct se_dev_entry *deve;\r\nssize_t ret;\r\nrcu_read_lock();\r\ndeve = target_nacl_find_deve(nacl, lacl->mapped_lun);\r\nif (!deve) {\r\nrcu_read_unlock();\r\nreturn -ENODEV;\r\n}\r\nret = snprintf(page, PAGE_SIZE, "Ready\n");\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic struct se_lun_acl *iport_to_lacl(struct config_item *item)\r\n{\r\nstruct se_ml_stat_grps *lgrps = container_of(to_config_group(item),\r\nstruct se_ml_stat_grps, scsi_att_intr_port_group);\r\nreturn container_of(lgrps, struct se_lun_acl, ml_stat_grps);\r\n}\r\nstatic ssize_t target_stat_iport_inst_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun_acl *lacl = iport_to_lacl(item);\r\nstruct se_node_acl *nacl = lacl->se_lun_nacl;\r\nstruct se_dev_entry *deve;\r\nstruct se_portal_group *tpg;\r\nssize_t ret;\r\nrcu_read_lock();\r\ndeve = target_nacl_find_deve(nacl, lacl->mapped_lun);\r\nif (!deve) {\r\nrcu_read_unlock();\r\nreturn -ENODEV;\r\n}\r\ntpg = nacl->se_tpg;\r\nret = snprintf(page, PAGE_SIZE, "%u\n",\r\ntpg->se_tpg_tfo->tpg_get_inst_index(tpg));\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_iport_dev_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun_acl *lacl = iport_to_lacl(item);\r\nstruct se_node_acl *nacl = lacl->se_lun_nacl;\r\nstruct se_dev_entry *deve;\r\nstruct se_lun *lun;\r\nssize_t ret;\r\nrcu_read_lock();\r\ndeve = target_nacl_find_deve(nacl, lacl->mapped_lun);\r\nif (!deve) {\r\nrcu_read_unlock();\r\nreturn -ENODEV;\r\n}\r\nlun = rcu_dereference(deve->se_lun);\r\nret = snprintf(page, PAGE_SIZE, "%u\n", lun->lun_index);\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_iport_port_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun_acl *lacl = iport_to_lacl(item);\r\nstruct se_node_acl *nacl = lacl->se_lun_nacl;\r\nstruct se_dev_entry *deve;\r\nstruct se_portal_group *tpg;\r\nssize_t ret;\r\nrcu_read_lock();\r\ndeve = target_nacl_find_deve(nacl, lacl->mapped_lun);\r\nif (!deve) {\r\nrcu_read_unlock();\r\nreturn -ENODEV;\r\n}\r\ntpg = nacl->se_tpg;\r\nret = snprintf(page, PAGE_SIZE, "%u\n", tpg->se_tpg_tfo->tpg_get_tag(tpg));\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_iport_indx_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun_acl *lacl = iport_to_lacl(item);\r\nstruct se_node_acl *nacl = lacl->se_lun_nacl;\r\nstruct se_session *se_sess;\r\nstruct se_portal_group *tpg;\r\nssize_t ret;\r\nspin_lock_irq(&nacl->nacl_sess_lock);\r\nse_sess = nacl->nacl_sess;\r\nif (!se_sess) {\r\nspin_unlock_irq(&nacl->nacl_sess_lock);\r\nreturn -ENODEV;\r\n}\r\ntpg = nacl->se_tpg;\r\nret = snprintf(page, PAGE_SIZE, "%u\n",\r\ntpg->se_tpg_tfo->sess_get_index(se_sess));\r\nspin_unlock_irq(&nacl->nacl_sess_lock);\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_iport_port_auth_indx_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun_acl *lacl = iport_to_lacl(item);\r\nstruct se_node_acl *nacl = lacl->se_lun_nacl;\r\nstruct se_dev_entry *deve;\r\nssize_t ret;\r\nrcu_read_lock();\r\ndeve = target_nacl_find_deve(nacl, lacl->mapped_lun);\r\nif (!deve) {\r\nrcu_read_unlock();\r\nreturn -ENODEV;\r\n}\r\nret = snprintf(page, PAGE_SIZE, "%u\n", nacl->acl_index);\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nstatic ssize_t target_stat_iport_port_ident_show(struct config_item *item,\r\nchar *page)\r\n{\r\nstruct se_lun_acl *lacl = iport_to_lacl(item);\r\nstruct se_node_acl *nacl = lacl->se_lun_nacl;\r\nstruct se_session *se_sess;\r\nstruct se_portal_group *tpg;\r\nssize_t ret;\r\nunsigned char buf[64];\r\nspin_lock_irq(&nacl->nacl_sess_lock);\r\nse_sess = nacl->nacl_sess;\r\nif (!se_sess) {\r\nspin_unlock_irq(&nacl->nacl_sess_lock);\r\nreturn -ENODEV;\r\n}\r\ntpg = nacl->se_tpg;\r\nmemset(buf, 0, 64);\r\nif (tpg->se_tpg_tfo->sess_get_initiator_sid != NULL)\r\ntpg->se_tpg_tfo->sess_get_initiator_sid(se_sess, buf, 64);\r\nret = snprintf(page, PAGE_SIZE, "%s+i+%s\n", nacl->initiatorname, buf);\r\nspin_unlock_irq(&nacl->nacl_sess_lock);\r\nreturn ret;\r\n}\r\nvoid target_stat_setup_mappedlun_default_groups(struct se_lun_acl *lacl)\r\n{\r\nstruct config_group *ml_stat_grp = &lacl->ml_stat_grps.stat_group;\r\nconfig_group_init_type_name(&lacl->ml_stat_grps.scsi_auth_intr_group,\r\n"scsi_auth_intr", &target_stat_scsi_auth_intr_cit);\r\nconfig_group_init_type_name(&lacl->ml_stat_grps.scsi_att_intr_port_group,\r\n"scsi_att_intr_port", &target_stat_scsi_att_intr_port_cit);\r\nml_stat_grp->default_groups[0] = &lacl->ml_stat_grps.scsi_auth_intr_group;\r\nml_stat_grp->default_groups[1] = &lacl->ml_stat_grps.scsi_att_intr_port_group;\r\nml_stat_grp->default_groups[2] = NULL;\r\n}

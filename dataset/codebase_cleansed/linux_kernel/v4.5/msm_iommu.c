static int msm_fault_handler(struct iommu_domain *iommu, struct device *dev,\r\nunsigned long iova, int flags, void *arg)\r\n{\r\npr_warn_ratelimited("*** fault: iova=%08lx, flags=%d\n", iova, flags);\r\nreturn 0;\r\n}\r\nstatic int msm_iommu_attach(struct msm_mmu *mmu, const char **names, int cnt)\r\n{\r\nstruct msm_iommu *iommu = to_msm_iommu(mmu);\r\nreturn iommu_attach_device(iommu->domain, mmu->dev);\r\n}\r\nstatic void msm_iommu_detach(struct msm_mmu *mmu, const char **names, int cnt)\r\n{\r\nstruct msm_iommu *iommu = to_msm_iommu(mmu);\r\niommu_detach_device(iommu->domain, mmu->dev);\r\n}\r\nstatic int msm_iommu_map(struct msm_mmu *mmu, uint32_t iova,\r\nstruct sg_table *sgt, unsigned len, int prot)\r\n{\r\nstruct msm_iommu *iommu = to_msm_iommu(mmu);\r\nstruct iommu_domain *domain = iommu->domain;\r\nstruct scatterlist *sg;\r\nunsigned int da = iova;\r\nunsigned int i, j;\r\nint ret;\r\nif (!domain || !sgt)\r\nreturn -EINVAL;\r\nfor_each_sg(sgt->sgl, sg, sgt->nents, i) {\r\nu32 pa = sg_phys(sg) - sg->offset;\r\nsize_t bytes = sg->length + sg->offset;\r\nVERB("map[%d]: %08x %08x(%zx)", i, iova, pa, bytes);\r\nret = iommu_map(domain, da, pa, bytes, prot);\r\nif (ret)\r\ngoto fail;\r\nda += bytes;\r\n}\r\nreturn 0;\r\nfail:\r\nda = iova;\r\nfor_each_sg(sgt->sgl, sg, i, j) {\r\nsize_t bytes = sg->length + sg->offset;\r\niommu_unmap(domain, da, bytes);\r\nda += bytes;\r\n}\r\nreturn ret;\r\n}\r\nstatic int msm_iommu_unmap(struct msm_mmu *mmu, uint32_t iova,\r\nstruct sg_table *sgt, unsigned len)\r\n{\r\nstruct msm_iommu *iommu = to_msm_iommu(mmu);\r\nstruct iommu_domain *domain = iommu->domain;\r\nstruct scatterlist *sg;\r\nunsigned int da = iova;\r\nint i;\r\nfor_each_sg(sgt->sgl, sg, sgt->nents, i) {\r\nsize_t bytes = sg->length + sg->offset;\r\nsize_t unmapped;\r\nunmapped = iommu_unmap(domain, da, bytes);\r\nif (unmapped < bytes)\r\nreturn unmapped;\r\nVERB("unmap[%d]: %08x(%zx)", i, iova, bytes);\r\nBUG_ON(!PAGE_ALIGNED(bytes));\r\nda += bytes;\r\n}\r\nreturn 0;\r\n}\r\nstatic void msm_iommu_destroy(struct msm_mmu *mmu)\r\n{\r\nstruct msm_iommu *iommu = to_msm_iommu(mmu);\r\niommu_domain_free(iommu->domain);\r\nkfree(iommu);\r\n}\r\nstruct msm_mmu *msm_iommu_new(struct device *dev, struct iommu_domain *domain)\r\n{\r\nstruct msm_iommu *iommu;\r\niommu = kzalloc(sizeof(*iommu), GFP_KERNEL);\r\nif (!iommu)\r\nreturn ERR_PTR(-ENOMEM);\r\niommu->domain = domain;\r\nmsm_mmu_init(&iommu->base, dev, &funcs);\r\niommu_set_fault_handler(domain, msm_fault_handler, dev);\r\nreturn &iommu->base;\r\n}

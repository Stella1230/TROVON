static void xgbe_an_enable_kr_training(struct xgbe_prv_data *pdata)\r\n{\r\nunsigned int reg;\r\nreg = XMDIO_READ(pdata, MDIO_MMD_PMAPMD, MDIO_PMA_10GBR_PMD_CTRL);\r\nreg |= XGBE_KR_TRAINING_ENABLE;\r\nXMDIO_WRITE(pdata, MDIO_MMD_PMAPMD, MDIO_PMA_10GBR_PMD_CTRL, reg);\r\n}\r\nstatic void xgbe_an_disable_kr_training(struct xgbe_prv_data *pdata)\r\n{\r\nunsigned int reg;\r\nreg = XMDIO_READ(pdata, MDIO_MMD_PMAPMD, MDIO_PMA_10GBR_PMD_CTRL);\r\nreg &= ~XGBE_KR_TRAINING_ENABLE;\r\nXMDIO_WRITE(pdata, MDIO_MMD_PMAPMD, MDIO_PMA_10GBR_PMD_CTRL, reg);\r\n}\r\nstatic void xgbe_pcs_power_cycle(struct xgbe_prv_data *pdata)\r\n{\r\nunsigned int reg;\r\nreg = XMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_CTRL1);\r\nreg |= MDIO_CTRL1_LPOWER;\r\nXMDIO_WRITE(pdata, MDIO_MMD_PCS, MDIO_CTRL1, reg);\r\nusleep_range(75, 100);\r\nreg &= ~MDIO_CTRL1_LPOWER;\r\nXMDIO_WRITE(pdata, MDIO_MMD_PCS, MDIO_CTRL1, reg);\r\n}\r\nstatic void xgbe_serdes_start_ratechange(struct xgbe_prv_data *pdata)\r\n{\r\nXSIR1_IOWRITE_BITS(pdata, SIR1_SPEED, RATECHANGE, 1);\r\n}\r\nstatic void xgbe_serdes_complete_ratechange(struct xgbe_prv_data *pdata)\r\n{\r\nunsigned int wait;\r\nu16 status;\r\nXSIR1_IOWRITE_BITS(pdata, SIR1_SPEED, RATECHANGE, 0);\r\nwait = XGBE_RATECHANGE_COUNT;\r\nwhile (wait--) {\r\nusleep_range(50, 75);\r\nstatus = XSIR0_IOREAD(pdata, SIR0_STATUS);\r\nif (XSIR_GET_BITS(status, SIR0_STATUS, RX_READY) &&\r\nXSIR_GET_BITS(status, SIR0_STATUS, TX_READY))\r\ngoto rx_reset;\r\n}\r\nnetif_dbg(pdata, link, pdata->netdev, "SerDes rx/tx not ready (%#hx)\n",\r\nstatus);\r\nrx_reset:\r\nXRXTX_IOWRITE_BITS(pdata, RXTX_REG6, RESETB_RXD, 0);\r\nXRXTX_IOWRITE_BITS(pdata, RXTX_REG6, RESETB_RXD, 1);\r\n}\r\nstatic void xgbe_xgmii_mode(struct xgbe_prv_data *pdata)\r\n{\r\nunsigned int reg;\r\nxgbe_an_enable_kr_training(pdata);\r\npdata->hw_if.set_xgmii_speed(pdata);\r\nreg = XMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_CTRL2);\r\nreg &= ~MDIO_PCS_CTRL2_TYPE;\r\nreg |= MDIO_PCS_CTRL2_10GBR;\r\nXMDIO_WRITE(pdata, MDIO_MMD_PCS, MDIO_CTRL2, reg);\r\nreg = XMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_CTRL1);\r\nreg &= ~MDIO_CTRL1_SPEEDSEL;\r\nreg |= MDIO_CTRL1_SPEED10G;\r\nXMDIO_WRITE(pdata, MDIO_MMD_PCS, MDIO_CTRL1, reg);\r\nxgbe_pcs_power_cycle(pdata);\r\nxgbe_serdes_start_ratechange(pdata);\r\nXSIR1_IOWRITE_BITS(pdata, SIR1_SPEED, DATARATE, XGBE_SPEED_10000_RATE);\r\nXSIR1_IOWRITE_BITS(pdata, SIR1_SPEED, WORDMODE, XGBE_SPEED_10000_WORD);\r\nXSIR1_IOWRITE_BITS(pdata, SIR1_SPEED, PLLSEL, XGBE_SPEED_10000_PLL);\r\nXSIR1_IOWRITE_BITS(pdata, SIR1_SPEED, CDR_RATE,\r\npdata->serdes_cdr_rate[XGBE_SPEED_10000]);\r\nXSIR1_IOWRITE_BITS(pdata, SIR1_SPEED, TXAMP,\r\npdata->serdes_tx_amp[XGBE_SPEED_10000]);\r\nXRXTX_IOWRITE_BITS(pdata, RXTX_REG20, BLWC_ENA,\r\npdata->serdes_blwc[XGBE_SPEED_10000]);\r\nXRXTX_IOWRITE_BITS(pdata, RXTX_REG114, PQ_REG,\r\npdata->serdes_pq_skew[XGBE_SPEED_10000]);\r\nXRXTX_IOWRITE_BITS(pdata, RXTX_REG129, RXDFE_CONFIG,\r\npdata->serdes_dfe_tap_cfg[XGBE_SPEED_10000]);\r\nXRXTX_IOWRITE(pdata, RXTX_REG22,\r\npdata->serdes_dfe_tap_ena[XGBE_SPEED_10000]);\r\nxgbe_serdes_complete_ratechange(pdata);\r\nnetif_dbg(pdata, link, pdata->netdev, "10GbE KR mode set\n");\r\n}\r\nstatic void xgbe_gmii_2500_mode(struct xgbe_prv_data *pdata)\r\n{\r\nunsigned int reg;\r\nxgbe_an_disable_kr_training(pdata);\r\npdata->hw_if.set_gmii_2500_speed(pdata);\r\nreg = XMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_CTRL2);\r\nreg &= ~MDIO_PCS_CTRL2_TYPE;\r\nreg |= MDIO_PCS_CTRL2_10GBX;\r\nXMDIO_WRITE(pdata, MDIO_MMD_PCS, MDIO_CTRL2, reg);\r\nreg = XMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_CTRL1);\r\nreg &= ~MDIO_CTRL1_SPEEDSEL;\r\nreg |= MDIO_CTRL1_SPEED1G;\r\nXMDIO_WRITE(pdata, MDIO_MMD_PCS, MDIO_CTRL1, reg);\r\nxgbe_pcs_power_cycle(pdata);\r\nxgbe_serdes_start_ratechange(pdata);\r\nXSIR1_IOWRITE_BITS(pdata, SIR1_SPEED, DATARATE, XGBE_SPEED_2500_RATE);\r\nXSIR1_IOWRITE_BITS(pdata, SIR1_SPEED, WORDMODE, XGBE_SPEED_2500_WORD);\r\nXSIR1_IOWRITE_BITS(pdata, SIR1_SPEED, PLLSEL, XGBE_SPEED_2500_PLL);\r\nXSIR1_IOWRITE_BITS(pdata, SIR1_SPEED, CDR_RATE,\r\npdata->serdes_cdr_rate[XGBE_SPEED_2500]);\r\nXSIR1_IOWRITE_BITS(pdata, SIR1_SPEED, TXAMP,\r\npdata->serdes_tx_amp[XGBE_SPEED_2500]);\r\nXRXTX_IOWRITE_BITS(pdata, RXTX_REG20, BLWC_ENA,\r\npdata->serdes_blwc[XGBE_SPEED_2500]);\r\nXRXTX_IOWRITE_BITS(pdata, RXTX_REG114, PQ_REG,\r\npdata->serdes_pq_skew[XGBE_SPEED_2500]);\r\nXRXTX_IOWRITE_BITS(pdata, RXTX_REG129, RXDFE_CONFIG,\r\npdata->serdes_dfe_tap_cfg[XGBE_SPEED_2500]);\r\nXRXTX_IOWRITE(pdata, RXTX_REG22,\r\npdata->serdes_dfe_tap_ena[XGBE_SPEED_2500]);\r\nxgbe_serdes_complete_ratechange(pdata);\r\nnetif_dbg(pdata, link, pdata->netdev, "2.5GbE KX mode set\n");\r\n}\r\nstatic void xgbe_gmii_mode(struct xgbe_prv_data *pdata)\r\n{\r\nunsigned int reg;\r\nxgbe_an_disable_kr_training(pdata);\r\npdata->hw_if.set_gmii_speed(pdata);\r\nreg = XMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_CTRL2);\r\nreg &= ~MDIO_PCS_CTRL2_TYPE;\r\nreg |= MDIO_PCS_CTRL2_10GBX;\r\nXMDIO_WRITE(pdata, MDIO_MMD_PCS, MDIO_CTRL2, reg);\r\nreg = XMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_CTRL1);\r\nreg &= ~MDIO_CTRL1_SPEEDSEL;\r\nreg |= MDIO_CTRL1_SPEED1G;\r\nXMDIO_WRITE(pdata, MDIO_MMD_PCS, MDIO_CTRL1, reg);\r\nxgbe_pcs_power_cycle(pdata);\r\nxgbe_serdes_start_ratechange(pdata);\r\nXSIR1_IOWRITE_BITS(pdata, SIR1_SPEED, DATARATE, XGBE_SPEED_1000_RATE);\r\nXSIR1_IOWRITE_BITS(pdata, SIR1_SPEED, WORDMODE, XGBE_SPEED_1000_WORD);\r\nXSIR1_IOWRITE_BITS(pdata, SIR1_SPEED, PLLSEL, XGBE_SPEED_1000_PLL);\r\nXSIR1_IOWRITE_BITS(pdata, SIR1_SPEED, CDR_RATE,\r\npdata->serdes_cdr_rate[XGBE_SPEED_1000]);\r\nXSIR1_IOWRITE_BITS(pdata, SIR1_SPEED, TXAMP,\r\npdata->serdes_tx_amp[XGBE_SPEED_1000]);\r\nXRXTX_IOWRITE_BITS(pdata, RXTX_REG20, BLWC_ENA,\r\npdata->serdes_blwc[XGBE_SPEED_1000]);\r\nXRXTX_IOWRITE_BITS(pdata, RXTX_REG114, PQ_REG,\r\npdata->serdes_pq_skew[XGBE_SPEED_1000]);\r\nXRXTX_IOWRITE_BITS(pdata, RXTX_REG129, RXDFE_CONFIG,\r\npdata->serdes_dfe_tap_cfg[XGBE_SPEED_1000]);\r\nXRXTX_IOWRITE(pdata, RXTX_REG22,\r\npdata->serdes_dfe_tap_ena[XGBE_SPEED_1000]);\r\nxgbe_serdes_complete_ratechange(pdata);\r\nnetif_dbg(pdata, link, pdata->netdev, "1GbE KX mode set\n");\r\n}\r\nstatic void xgbe_cur_mode(struct xgbe_prv_data *pdata,\r\nenum xgbe_mode *mode)\r\n{\r\nunsigned int reg;\r\nreg = XMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_CTRL2);\r\nif ((reg & MDIO_PCS_CTRL2_TYPE) == MDIO_PCS_CTRL2_10GBR)\r\n*mode = XGBE_MODE_KR;\r\nelse\r\n*mode = XGBE_MODE_KX;\r\n}\r\nstatic bool xgbe_in_kr_mode(struct xgbe_prv_data *pdata)\r\n{\r\nenum xgbe_mode mode;\r\nxgbe_cur_mode(pdata, &mode);\r\nreturn (mode == XGBE_MODE_KR);\r\n}\r\nstatic void xgbe_switch_mode(struct xgbe_prv_data *pdata)\r\n{\r\nif (xgbe_in_kr_mode(pdata)) {\r\nif (pdata->speed_set == XGBE_SPEEDSET_1000_10000)\r\nxgbe_gmii_mode(pdata);\r\nelse\r\nxgbe_gmii_2500_mode(pdata);\r\n} else {\r\nxgbe_xgmii_mode(pdata);\r\n}\r\n}\r\nstatic void xgbe_set_mode(struct xgbe_prv_data *pdata,\r\nenum xgbe_mode mode)\r\n{\r\nenum xgbe_mode cur_mode;\r\nxgbe_cur_mode(pdata, &cur_mode);\r\nif (mode != cur_mode)\r\nxgbe_switch_mode(pdata);\r\n}\r\nstatic bool xgbe_use_xgmii_mode(struct xgbe_prv_data *pdata)\r\n{\r\nif (pdata->phy.autoneg == AUTONEG_ENABLE) {\r\nif (pdata->phy.advertising & ADVERTISED_10000baseKR_Full)\r\nreturn true;\r\n} else {\r\nif (pdata->phy.speed == SPEED_10000)\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic bool xgbe_use_gmii_2500_mode(struct xgbe_prv_data *pdata)\r\n{\r\nif (pdata->phy.autoneg == AUTONEG_ENABLE) {\r\nif (pdata->phy.advertising & ADVERTISED_2500baseX_Full)\r\nreturn true;\r\n} else {\r\nif (pdata->phy.speed == SPEED_2500)\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic bool xgbe_use_gmii_mode(struct xgbe_prv_data *pdata)\r\n{\r\nif (pdata->phy.autoneg == AUTONEG_ENABLE) {\r\nif (pdata->phy.advertising & ADVERTISED_1000baseKX_Full)\r\nreturn true;\r\n} else {\r\nif (pdata->phy.speed == SPEED_1000)\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic void xgbe_set_an(struct xgbe_prv_data *pdata, bool enable, bool restart)\r\n{\r\nunsigned int reg;\r\nreg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_CTRL1);\r\nreg &= ~MDIO_AN_CTRL1_ENABLE;\r\nif (enable)\r\nreg |= MDIO_AN_CTRL1_ENABLE;\r\nif (restart)\r\nreg |= MDIO_AN_CTRL1_RESTART;\r\nXMDIO_WRITE(pdata, MDIO_MMD_AN, MDIO_CTRL1, reg);\r\n}\r\nstatic void xgbe_restart_an(struct xgbe_prv_data *pdata)\r\n{\r\nxgbe_set_an(pdata, true, true);\r\nnetif_dbg(pdata, link, pdata->netdev, "AN enabled/restarted\n");\r\n}\r\nstatic void xgbe_disable_an(struct xgbe_prv_data *pdata)\r\n{\r\nxgbe_set_an(pdata, false, false);\r\nnetif_dbg(pdata, link, pdata->netdev, "AN disabled\n");\r\n}\r\nstatic enum xgbe_an xgbe_an_tx_training(struct xgbe_prv_data *pdata,\r\nenum xgbe_rx *state)\r\n{\r\nunsigned int ad_reg, lp_reg, reg;\r\n*state = XGBE_RX_COMPLETE;\r\nif (!xgbe_in_kr_mode(pdata))\r\nreturn XGBE_AN_PAGE_RECEIVED;\r\nad_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE + 2);\r\nlp_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_LPA + 2);\r\nreg = XMDIO_READ(pdata, MDIO_MMD_PMAPMD, MDIO_PMA_10GBR_FECCTRL);\r\nreg &= ~(MDIO_PMA_10GBR_FECABLE_ABLE | MDIO_PMA_10GBR_FECABLE_ERRABLE);\r\nif ((ad_reg & 0xc000) && (lp_reg & 0xc000))\r\nreg |= pdata->fec_ability;\r\nXMDIO_WRITE(pdata, MDIO_MMD_PMAPMD, MDIO_PMA_10GBR_FECCTRL, reg);\r\nreg = XMDIO_READ(pdata, MDIO_MMD_PMAPMD, MDIO_PMA_10GBR_PMD_CTRL);\r\nif (reg & XGBE_KR_TRAINING_ENABLE) {\r\nXSIR0_IOWRITE_BITS(pdata, SIR0_KR_RT_1, RESET, 1);\r\nreg |= XGBE_KR_TRAINING_START;\r\nXMDIO_WRITE(pdata, MDIO_MMD_PMAPMD, MDIO_PMA_10GBR_PMD_CTRL,\r\nreg);\r\nXSIR0_IOWRITE_BITS(pdata, SIR0_KR_RT_1, RESET, 0);\r\nnetif_dbg(pdata, link, pdata->netdev,\r\n"KR training initiated\n");\r\n}\r\nreturn XGBE_AN_PAGE_RECEIVED;\r\n}\r\nstatic enum xgbe_an xgbe_an_tx_xnp(struct xgbe_prv_data *pdata,\r\nenum xgbe_rx *state)\r\n{\r\nu16 msg;\r\n*state = XGBE_RX_XNP;\r\nmsg = XGBE_XNP_MCF_NULL_MESSAGE;\r\nmsg |= XGBE_XNP_MP_FORMATTED;\r\nXMDIO_WRITE(pdata, MDIO_MMD_AN, MDIO_AN_XNP + 2, 0);\r\nXMDIO_WRITE(pdata, MDIO_MMD_AN, MDIO_AN_XNP + 1, 0);\r\nXMDIO_WRITE(pdata, MDIO_MMD_AN, MDIO_AN_XNP, msg);\r\nreturn XGBE_AN_PAGE_RECEIVED;\r\n}\r\nstatic enum xgbe_an xgbe_an_rx_bpa(struct xgbe_prv_data *pdata,\r\nenum xgbe_rx *state)\r\n{\r\nunsigned int link_support;\r\nunsigned int reg, ad_reg, lp_reg;\r\nreg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_LPA + 1);\r\nlink_support = xgbe_in_kr_mode(pdata) ? 0x80 : 0x20;\r\nif (!(reg & link_support))\r\nreturn XGBE_AN_INCOMPAT_LINK;\r\nad_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE);\r\nlp_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_LPA);\r\nreturn ((ad_reg & XGBE_XNP_NP_EXCHANGE) ||\r\n(lp_reg & XGBE_XNP_NP_EXCHANGE))\r\n? xgbe_an_tx_xnp(pdata, state)\r\n: xgbe_an_tx_training(pdata, state);\r\n}\r\nstatic enum xgbe_an xgbe_an_rx_xnp(struct xgbe_prv_data *pdata,\r\nenum xgbe_rx *state)\r\n{\r\nunsigned int ad_reg, lp_reg;\r\nad_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_XNP);\r\nlp_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_LPX);\r\nreturn ((ad_reg & XGBE_XNP_NP_EXCHANGE) ||\r\n(lp_reg & XGBE_XNP_NP_EXCHANGE))\r\n? xgbe_an_tx_xnp(pdata, state)\r\n: xgbe_an_tx_training(pdata, state);\r\n}\r\nstatic enum xgbe_an xgbe_an_page_received(struct xgbe_prv_data *pdata)\r\n{\r\nenum xgbe_rx *state;\r\nunsigned long an_timeout;\r\nenum xgbe_an ret;\r\nif (!pdata->an_start) {\r\npdata->an_start = jiffies;\r\n} else {\r\nan_timeout = pdata->an_start +\r\nmsecs_to_jiffies(XGBE_AN_MS_TIMEOUT);\r\nif (time_after(jiffies, an_timeout)) {\r\npdata->kr_state = XGBE_RX_BPA;\r\npdata->kx_state = XGBE_RX_BPA;\r\npdata->an_start = jiffies;\r\nnetif_dbg(pdata, link, pdata->netdev,\r\n"AN timed out, resetting state\n");\r\n}\r\n}\r\nstate = xgbe_in_kr_mode(pdata) ? &pdata->kr_state\r\n: &pdata->kx_state;\r\nswitch (*state) {\r\ncase XGBE_RX_BPA:\r\nret = xgbe_an_rx_bpa(pdata, state);\r\nbreak;\r\ncase XGBE_RX_XNP:\r\nret = xgbe_an_rx_xnp(pdata, state);\r\nbreak;\r\ndefault:\r\nret = XGBE_AN_ERROR;\r\n}\r\nreturn ret;\r\n}\r\nstatic enum xgbe_an xgbe_an_incompat_link(struct xgbe_prv_data *pdata)\r\n{\r\nif (xgbe_in_kr_mode(pdata)) {\r\npdata->kr_state = XGBE_RX_ERROR;\r\nif (!(pdata->phy.advertising & ADVERTISED_1000baseKX_Full) &&\r\n!(pdata->phy.advertising & ADVERTISED_2500baseX_Full))\r\nreturn XGBE_AN_NO_LINK;\r\nif (pdata->kx_state != XGBE_RX_BPA)\r\nreturn XGBE_AN_NO_LINK;\r\n} else {\r\npdata->kx_state = XGBE_RX_ERROR;\r\nif (!(pdata->phy.advertising & ADVERTISED_10000baseKR_Full))\r\nreturn XGBE_AN_NO_LINK;\r\nif (pdata->kr_state != XGBE_RX_BPA)\r\nreturn XGBE_AN_NO_LINK;\r\n}\r\nxgbe_disable_an(pdata);\r\nxgbe_switch_mode(pdata);\r\nxgbe_restart_an(pdata);\r\nreturn XGBE_AN_INCOMPAT_LINK;\r\n}\r\nstatic irqreturn_t xgbe_an_isr(int irq, void *data)\r\n{\r\nstruct xgbe_prv_data *pdata = (struct xgbe_prv_data *)data;\r\nnetif_dbg(pdata, intr, pdata->netdev, "AN interrupt received\n");\r\ndisable_irq_nosync(pdata->an_irq);\r\nqueue_work(pdata->an_workqueue, &pdata->an_irq_work);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void xgbe_an_irq_work(struct work_struct *work)\r\n{\r\nstruct xgbe_prv_data *pdata = container_of(work,\r\nstruct xgbe_prv_data,\r\nan_irq_work);\r\nflush_work(&pdata->an_work);\r\nqueue_work(pdata->an_workqueue, &pdata->an_work);\r\n}\r\nstatic const char *xgbe_state_as_string(enum xgbe_an state)\r\n{\r\nswitch (state) {\r\ncase XGBE_AN_READY:\r\nreturn "Ready";\r\ncase XGBE_AN_PAGE_RECEIVED:\r\nreturn "Page-Received";\r\ncase XGBE_AN_INCOMPAT_LINK:\r\nreturn "Incompatible-Link";\r\ncase XGBE_AN_COMPLETE:\r\nreturn "Complete";\r\ncase XGBE_AN_NO_LINK:\r\nreturn "No-Link";\r\ncase XGBE_AN_ERROR:\r\nreturn "Error";\r\ndefault:\r\nreturn "Undefined";\r\n}\r\n}\r\nstatic void xgbe_an_state_machine(struct work_struct *work)\r\n{\r\nstruct xgbe_prv_data *pdata = container_of(work,\r\nstruct xgbe_prv_data,\r\nan_work);\r\nenum xgbe_an cur_state = pdata->an_state;\r\nunsigned int int_reg, int_mask;\r\nmutex_lock(&pdata->an_mutex);\r\nint_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_INT);\r\nif (!int_reg)\r\ngoto out;\r\nnext_int:\r\nif (int_reg & XGBE_AN_PG_RCV) {\r\npdata->an_state = XGBE_AN_PAGE_RECEIVED;\r\nint_mask = XGBE_AN_PG_RCV;\r\n} else if (int_reg & XGBE_AN_INC_LINK) {\r\npdata->an_state = XGBE_AN_INCOMPAT_LINK;\r\nint_mask = XGBE_AN_INC_LINK;\r\n} else if (int_reg & XGBE_AN_INT_CMPLT) {\r\npdata->an_state = XGBE_AN_COMPLETE;\r\nint_mask = XGBE_AN_INT_CMPLT;\r\n} else {\r\npdata->an_state = XGBE_AN_ERROR;\r\nint_mask = 0;\r\n}\r\nint_reg &= ~int_mask;\r\nXMDIO_WRITE(pdata, MDIO_MMD_AN, MDIO_AN_INT, int_reg);\r\npdata->an_result = pdata->an_state;\r\nagain:\r\nnetif_dbg(pdata, link, pdata->netdev, "AN %s\n",\r\nxgbe_state_as_string(pdata->an_state));\r\ncur_state = pdata->an_state;\r\nswitch (pdata->an_state) {\r\ncase XGBE_AN_READY:\r\npdata->an_supported = 0;\r\nbreak;\r\ncase XGBE_AN_PAGE_RECEIVED:\r\npdata->an_state = xgbe_an_page_received(pdata);\r\npdata->an_supported++;\r\nbreak;\r\ncase XGBE_AN_INCOMPAT_LINK:\r\npdata->an_supported = 0;\r\npdata->parallel_detect = 0;\r\npdata->an_state = xgbe_an_incompat_link(pdata);\r\nbreak;\r\ncase XGBE_AN_COMPLETE:\r\npdata->parallel_detect = pdata->an_supported ? 0 : 1;\r\nnetif_dbg(pdata, link, pdata->netdev, "%s successful\n",\r\npdata->an_supported ? "Auto negotiation"\r\n: "Parallel detection");\r\nbreak;\r\ncase XGBE_AN_NO_LINK:\r\nbreak;\r\ndefault:\r\npdata->an_state = XGBE_AN_ERROR;\r\n}\r\nif (pdata->an_state == XGBE_AN_NO_LINK) {\r\nint_reg = 0;\r\nXMDIO_WRITE(pdata, MDIO_MMD_AN, MDIO_AN_INT, 0);\r\n} else if (pdata->an_state == XGBE_AN_ERROR) {\r\nnetdev_err(pdata->netdev,\r\n"error during auto-negotiation, state=%u\n",\r\ncur_state);\r\nint_reg = 0;\r\nXMDIO_WRITE(pdata, MDIO_MMD_AN, MDIO_AN_INT, 0);\r\n}\r\nif (pdata->an_state >= XGBE_AN_COMPLETE) {\r\npdata->an_result = pdata->an_state;\r\npdata->an_state = XGBE_AN_READY;\r\npdata->kr_state = XGBE_RX_BPA;\r\npdata->kx_state = XGBE_RX_BPA;\r\npdata->an_start = 0;\r\nnetif_dbg(pdata, link, pdata->netdev, "AN result: %s\n",\r\nxgbe_state_as_string(pdata->an_result));\r\n}\r\nif (cur_state != pdata->an_state)\r\ngoto again;\r\nif (int_reg)\r\ngoto next_int;\r\nout:\r\nenable_irq(pdata->an_irq);\r\nmutex_unlock(&pdata->an_mutex);\r\n}\r\nstatic void xgbe_an_init(struct xgbe_prv_data *pdata)\r\n{\r\nunsigned int reg;\r\nreg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE + 2);\r\nif (pdata->phy.advertising & ADVERTISED_10000baseR_FEC)\r\nreg |= 0xc000;\r\nelse\r\nreg &= ~0xc000;\r\nXMDIO_WRITE(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE + 2, reg);\r\nreg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE + 1);\r\nif (pdata->phy.advertising & ADVERTISED_10000baseKR_Full)\r\nreg |= 0x80;\r\nelse\r\nreg &= ~0x80;\r\nif ((pdata->phy.advertising & ADVERTISED_1000baseKX_Full) ||\r\n(pdata->phy.advertising & ADVERTISED_2500baseX_Full))\r\nreg |= 0x20;\r\nelse\r\nreg &= ~0x20;\r\nXMDIO_WRITE(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE + 1, reg);\r\nreg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE);\r\nif (pdata->phy.advertising & ADVERTISED_Pause)\r\nreg |= 0x400;\r\nelse\r\nreg &= ~0x400;\r\nif (pdata->phy.advertising & ADVERTISED_Asym_Pause)\r\nreg |= 0x800;\r\nelse\r\nreg &= ~0x800;\r\nreg &= ~XGBE_XNP_NP_EXCHANGE;\r\nXMDIO_WRITE(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE, reg);\r\nnetif_dbg(pdata, link, pdata->netdev, "AN initialized\n");\r\n}\r\nstatic const char *xgbe_phy_fc_string(struct xgbe_prv_data *pdata)\r\n{\r\nif (pdata->tx_pause && pdata->rx_pause)\r\nreturn "rx/tx";\r\nelse if (pdata->rx_pause)\r\nreturn "rx";\r\nelse if (pdata->tx_pause)\r\nreturn "tx";\r\nelse\r\nreturn "off";\r\n}\r\nstatic const char *xgbe_phy_speed_string(int speed)\r\n{\r\nswitch (speed) {\r\ncase SPEED_1000:\r\nreturn "1Gbps";\r\ncase SPEED_2500:\r\nreturn "2.5Gbps";\r\ncase SPEED_10000:\r\nreturn "10Gbps";\r\ncase SPEED_UNKNOWN:\r\nreturn "Unknown";\r\ndefault:\r\nreturn "Unsupported";\r\n}\r\n}\r\nstatic void xgbe_phy_print_status(struct xgbe_prv_data *pdata)\r\n{\r\nif (pdata->phy.link)\r\nnetdev_info(pdata->netdev,\r\n"Link is Up - %s/%s - flow control %s\n",\r\nxgbe_phy_speed_string(pdata->phy.speed),\r\npdata->phy.duplex == DUPLEX_FULL ? "Full" : "Half",\r\nxgbe_phy_fc_string(pdata));\r\nelse\r\nnetdev_info(pdata->netdev, "Link is Down\n");\r\n}\r\nstatic void xgbe_phy_adjust_link(struct xgbe_prv_data *pdata)\r\n{\r\nint new_state = 0;\r\nif (pdata->phy.link) {\r\npdata->pause_autoneg = pdata->phy.pause_autoneg;\r\nif (pdata->tx_pause != pdata->phy.tx_pause) {\r\nnew_state = 1;\r\npdata->hw_if.config_tx_flow_control(pdata);\r\npdata->tx_pause = pdata->phy.tx_pause;\r\n}\r\nif (pdata->rx_pause != pdata->phy.rx_pause) {\r\nnew_state = 1;\r\npdata->hw_if.config_rx_flow_control(pdata);\r\npdata->rx_pause = pdata->phy.rx_pause;\r\n}\r\nif (pdata->phy_speed != pdata->phy.speed) {\r\nnew_state = 1;\r\npdata->phy_speed = pdata->phy.speed;\r\n}\r\nif (pdata->phy_link != pdata->phy.link) {\r\nnew_state = 1;\r\npdata->phy_link = pdata->phy.link;\r\n}\r\n} else if (pdata->phy_link) {\r\nnew_state = 1;\r\npdata->phy_link = 0;\r\npdata->phy_speed = SPEED_UNKNOWN;\r\n}\r\nif (new_state && netif_msg_link(pdata))\r\nxgbe_phy_print_status(pdata);\r\n}\r\nstatic int xgbe_phy_config_fixed(struct xgbe_prv_data *pdata)\r\n{\r\nnetif_dbg(pdata, link, pdata->netdev, "fixed PHY configuration\n");\r\nxgbe_disable_an(pdata);\r\nswitch (pdata->phy.speed) {\r\ncase SPEED_10000:\r\nxgbe_set_mode(pdata, XGBE_MODE_KR);\r\nbreak;\r\ncase SPEED_2500:\r\ncase SPEED_1000:\r\nxgbe_set_mode(pdata, XGBE_MODE_KX);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (pdata->phy.duplex != DUPLEX_FULL)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int __xgbe_phy_config_aneg(struct xgbe_prv_data *pdata)\r\n{\r\nset_bit(XGBE_LINK_INIT, &pdata->dev_state);\r\npdata->link_check = jiffies;\r\nif (pdata->phy.autoneg != AUTONEG_ENABLE)\r\nreturn xgbe_phy_config_fixed(pdata);\r\nnetif_dbg(pdata, link, pdata->netdev, "AN PHY configuration\n");\r\ndisable_irq(pdata->an_irq);\r\nif (pdata->phy.advertising & ADVERTISED_10000baseKR_Full) {\r\nxgbe_set_mode(pdata, XGBE_MODE_KR);\r\n} else if ((pdata->phy.advertising & ADVERTISED_1000baseKX_Full) ||\r\n(pdata->phy.advertising & ADVERTISED_2500baseX_Full)) {\r\nxgbe_set_mode(pdata, XGBE_MODE_KX);\r\n} else {\r\nenable_irq(pdata->an_irq);\r\nreturn -EINVAL;\r\n}\r\nxgbe_disable_an(pdata);\r\nXMDIO_WRITE(pdata, MDIO_MMD_AN, MDIO_AN_INT, 0);\r\npdata->an_result = XGBE_AN_READY;\r\npdata->an_state = XGBE_AN_READY;\r\npdata->kr_state = XGBE_RX_BPA;\r\npdata->kx_state = XGBE_RX_BPA;\r\nenable_irq(pdata->an_irq);\r\nxgbe_an_init(pdata);\r\nxgbe_restart_an(pdata);\r\nreturn 0;\r\n}\r\nstatic int xgbe_phy_config_aneg(struct xgbe_prv_data *pdata)\r\n{\r\nint ret;\r\nmutex_lock(&pdata->an_mutex);\r\nret = __xgbe_phy_config_aneg(pdata);\r\nif (ret)\r\nset_bit(XGBE_LINK_ERR, &pdata->dev_state);\r\nelse\r\nclear_bit(XGBE_LINK_ERR, &pdata->dev_state);\r\nmutex_unlock(&pdata->an_mutex);\r\nreturn ret;\r\n}\r\nstatic bool xgbe_phy_aneg_done(struct xgbe_prv_data *pdata)\r\n{\r\nreturn (pdata->an_result == XGBE_AN_COMPLETE);\r\n}\r\nstatic void xgbe_check_link_timeout(struct xgbe_prv_data *pdata)\r\n{\r\nunsigned long link_timeout;\r\nlink_timeout = pdata->link_check + (XGBE_LINK_TIMEOUT * HZ);\r\nif (time_after(jiffies, link_timeout)) {\r\nnetif_dbg(pdata, link, pdata->netdev, "AN link timeout\n");\r\nxgbe_phy_config_aneg(pdata);\r\n}\r\n}\r\nstatic void xgbe_phy_status_force(struct xgbe_prv_data *pdata)\r\n{\r\nif (xgbe_in_kr_mode(pdata)) {\r\npdata->phy.speed = SPEED_10000;\r\n} else {\r\nswitch (pdata->speed_set) {\r\ncase XGBE_SPEEDSET_1000_10000:\r\npdata->phy.speed = SPEED_1000;\r\nbreak;\r\ncase XGBE_SPEEDSET_2500_10000:\r\npdata->phy.speed = SPEED_2500;\r\nbreak;\r\n}\r\n}\r\npdata->phy.duplex = DUPLEX_FULL;\r\n}\r\nstatic void xgbe_phy_status_aneg(struct xgbe_prv_data *pdata)\r\n{\r\nunsigned int ad_reg, lp_reg;\r\npdata->phy.lp_advertising = 0;\r\nif ((pdata->phy.autoneg != AUTONEG_ENABLE) || pdata->parallel_detect)\r\nreturn xgbe_phy_status_force(pdata);\r\npdata->phy.lp_advertising |= ADVERTISED_Autoneg;\r\npdata->phy.lp_advertising |= ADVERTISED_Backplane;\r\nad_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE);\r\nlp_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_LPA);\r\nif (lp_reg & 0x400)\r\npdata->phy.lp_advertising |= ADVERTISED_Pause;\r\nif (lp_reg & 0x800)\r\npdata->phy.lp_advertising |= ADVERTISED_Asym_Pause;\r\nif (pdata->phy.pause_autoneg) {\r\npdata->phy.tx_pause = 0;\r\npdata->phy.rx_pause = 0;\r\nif (ad_reg & lp_reg & 0x400) {\r\npdata->phy.tx_pause = 1;\r\npdata->phy.rx_pause = 1;\r\n} else if (ad_reg & lp_reg & 0x800) {\r\nif (ad_reg & 0x400)\r\npdata->phy.rx_pause = 1;\r\nelse if (lp_reg & 0x400)\r\npdata->phy.tx_pause = 1;\r\n}\r\n}\r\nad_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE + 1);\r\nlp_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_LPA + 1);\r\nif (lp_reg & 0x80)\r\npdata->phy.lp_advertising |= ADVERTISED_10000baseKR_Full;\r\nif (lp_reg & 0x20) {\r\nswitch (pdata->speed_set) {\r\ncase XGBE_SPEEDSET_1000_10000:\r\npdata->phy.lp_advertising |= ADVERTISED_1000baseKX_Full;\r\nbreak;\r\ncase XGBE_SPEEDSET_2500_10000:\r\npdata->phy.lp_advertising |= ADVERTISED_2500baseX_Full;\r\nbreak;\r\n}\r\n}\r\nad_reg &= lp_reg;\r\nif (ad_reg & 0x80) {\r\npdata->phy.speed = SPEED_10000;\r\nxgbe_set_mode(pdata, XGBE_MODE_KR);\r\n} else if (ad_reg & 0x20) {\r\nswitch (pdata->speed_set) {\r\ncase XGBE_SPEEDSET_1000_10000:\r\npdata->phy.speed = SPEED_1000;\r\nbreak;\r\ncase XGBE_SPEEDSET_2500_10000:\r\npdata->phy.speed = SPEED_2500;\r\nbreak;\r\n}\r\nxgbe_set_mode(pdata, XGBE_MODE_KX);\r\n} else {\r\npdata->phy.speed = SPEED_UNKNOWN;\r\n}\r\nad_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE + 2);\r\nlp_reg = XMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_LPA + 2);\r\nif (lp_reg & 0xc000)\r\npdata->phy.lp_advertising |= ADVERTISED_10000baseR_FEC;\r\npdata->phy.duplex = DUPLEX_FULL;\r\n}\r\nstatic void xgbe_phy_status(struct xgbe_prv_data *pdata)\r\n{\r\nunsigned int reg, link_aneg;\r\nif (test_bit(XGBE_LINK_ERR, &pdata->dev_state)) {\r\nnetif_carrier_off(pdata->netdev);\r\npdata->phy.link = 0;\r\ngoto adjust_link;\r\n}\r\nlink_aneg = (pdata->phy.autoneg == AUTONEG_ENABLE);\r\nreg = XMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_STAT1);\r\nreg = XMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_STAT1);\r\npdata->phy.link = (reg & MDIO_STAT1_LSTATUS) ? 1 : 0;\r\nif (pdata->phy.link) {\r\nif (link_aneg && !xgbe_phy_aneg_done(pdata)) {\r\nxgbe_check_link_timeout(pdata);\r\nreturn;\r\n}\r\nxgbe_phy_status_aneg(pdata);\r\nif (test_bit(XGBE_LINK_INIT, &pdata->dev_state))\r\nclear_bit(XGBE_LINK_INIT, &pdata->dev_state);\r\nnetif_carrier_on(pdata->netdev);\r\n} else {\r\nif (test_bit(XGBE_LINK_INIT, &pdata->dev_state)) {\r\nxgbe_check_link_timeout(pdata);\r\nif (link_aneg)\r\nreturn;\r\n}\r\nxgbe_phy_status_aneg(pdata);\r\nnetif_carrier_off(pdata->netdev);\r\n}\r\nadjust_link:\r\nxgbe_phy_adjust_link(pdata);\r\n}\r\nstatic void xgbe_phy_stop(struct xgbe_prv_data *pdata)\r\n{\r\nnetif_dbg(pdata, link, pdata->netdev, "stopping PHY\n");\r\nxgbe_disable_an(pdata);\r\nXMDIO_WRITE(pdata, MDIO_MMD_AN, MDIO_AN_INTMASK, 0);\r\ndevm_free_irq(pdata->dev, pdata->an_irq, pdata);\r\npdata->phy.link = 0;\r\nnetif_carrier_off(pdata->netdev);\r\nxgbe_phy_adjust_link(pdata);\r\n}\r\nstatic int xgbe_phy_start(struct xgbe_prv_data *pdata)\r\n{\r\nstruct net_device *netdev = pdata->netdev;\r\nint ret;\r\nnetif_dbg(pdata, link, pdata->netdev, "starting PHY\n");\r\nret = devm_request_irq(pdata->dev, pdata->an_irq,\r\nxgbe_an_isr, 0, pdata->an_name,\r\npdata);\r\nif (ret) {\r\nnetdev_err(netdev, "phy irq request failed\n");\r\nreturn ret;\r\n}\r\nif (xgbe_use_xgmii_mode(pdata)) {\r\nxgbe_xgmii_mode(pdata);\r\n} else if (xgbe_use_gmii_mode(pdata)) {\r\nxgbe_gmii_mode(pdata);\r\n} else if (xgbe_use_gmii_2500_mode(pdata)) {\r\nxgbe_gmii_2500_mode(pdata);\r\n} else {\r\nret = -EINVAL;\r\ngoto err_irq;\r\n}\r\nxgbe_an_init(pdata);\r\nXMDIO_WRITE(pdata, MDIO_MMD_AN, MDIO_AN_INTMASK, 0x07);\r\nreturn xgbe_phy_config_aneg(pdata);\r\nerr_irq:\r\ndevm_free_irq(pdata->dev, pdata->an_irq, pdata);\r\nreturn ret;\r\n}\r\nstatic int xgbe_phy_reset(struct xgbe_prv_data *pdata)\r\n{\r\nunsigned int count, reg;\r\nreg = XMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_CTRL1);\r\nreg |= MDIO_CTRL1_RESET;\r\nXMDIO_WRITE(pdata, MDIO_MMD_PCS, MDIO_CTRL1, reg);\r\ncount = 50;\r\ndo {\r\nmsleep(20);\r\nreg = XMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_CTRL1);\r\n} while ((reg & MDIO_CTRL1_RESET) && --count);\r\nif (reg & MDIO_CTRL1_RESET)\r\nreturn -ETIMEDOUT;\r\nxgbe_disable_an(pdata);\r\nXMDIO_WRITE(pdata, MDIO_MMD_AN, MDIO_AN_INT, 0);\r\nreturn 0;\r\n}\r\nstatic void xgbe_dump_phy_registers(struct xgbe_prv_data *pdata)\r\n{\r\nstruct device *dev = pdata->dev;\r\ndev_dbg(dev, "\n************* PHY Reg dump **********************\n");\r\ndev_dbg(dev, "PCS Control Reg (%#04x) = %#04x\n", MDIO_CTRL1,\r\nXMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_CTRL1));\r\ndev_dbg(dev, "PCS Status Reg (%#04x) = %#04x\n", MDIO_STAT1,\r\nXMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_STAT1));\r\ndev_dbg(dev, "Phy Id (PHYS ID 1 %#04x)= %#04x\n", MDIO_DEVID1,\r\nXMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_DEVID1));\r\ndev_dbg(dev, "Phy Id (PHYS ID 2 %#04x)= %#04x\n", MDIO_DEVID2,\r\nXMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_DEVID2));\r\ndev_dbg(dev, "Devices in Package (%#04x)= %#04x\n", MDIO_DEVS1,\r\nXMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_DEVS1));\r\ndev_dbg(dev, "Devices in Package (%#04x)= %#04x\n", MDIO_DEVS2,\r\nXMDIO_READ(pdata, MDIO_MMD_PCS, MDIO_DEVS2));\r\ndev_dbg(dev, "Auto-Neg Control Reg (%#04x) = %#04x\n", MDIO_CTRL1,\r\nXMDIO_READ(pdata, MDIO_MMD_AN, MDIO_CTRL1));\r\ndev_dbg(dev, "Auto-Neg Status Reg (%#04x) = %#04x\n", MDIO_STAT1,\r\nXMDIO_READ(pdata, MDIO_MMD_AN, MDIO_STAT1));\r\ndev_dbg(dev, "Auto-Neg Ad Reg 1 (%#04x) = %#04x\n",\r\nMDIO_AN_ADVERTISE,\r\nXMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE));\r\ndev_dbg(dev, "Auto-Neg Ad Reg 2 (%#04x) = %#04x\n",\r\nMDIO_AN_ADVERTISE + 1,\r\nXMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE + 1));\r\ndev_dbg(dev, "Auto-Neg Ad Reg 3 (%#04x) = %#04x\n",\r\nMDIO_AN_ADVERTISE + 2,\r\nXMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_ADVERTISE + 2));\r\ndev_dbg(dev, "Auto-Neg Completion Reg (%#04x) = %#04x\n",\r\nMDIO_AN_COMP_STAT,\r\nXMDIO_READ(pdata, MDIO_MMD_AN, MDIO_AN_COMP_STAT));\r\ndev_dbg(dev, "\n*************************************************\n");\r\n}\r\nstatic void xgbe_phy_init(struct xgbe_prv_data *pdata)\r\n{\r\nmutex_init(&pdata->an_mutex);\r\nINIT_WORK(&pdata->an_irq_work, xgbe_an_irq_work);\r\nINIT_WORK(&pdata->an_work, xgbe_an_state_machine);\r\npdata->mdio_mmd = MDIO_MMD_PCS;\r\npdata->phy.supported = SUPPORTED_Autoneg;\r\npdata->phy.supported |= SUPPORTED_Pause | SUPPORTED_Asym_Pause;\r\npdata->phy.supported |= SUPPORTED_Backplane;\r\npdata->phy.supported |= SUPPORTED_10000baseKR_Full;\r\nswitch (pdata->speed_set) {\r\ncase XGBE_SPEEDSET_1000_10000:\r\npdata->phy.supported |= SUPPORTED_1000baseKX_Full;\r\nbreak;\r\ncase XGBE_SPEEDSET_2500_10000:\r\npdata->phy.supported |= SUPPORTED_2500baseX_Full;\r\nbreak;\r\n}\r\npdata->fec_ability = XMDIO_READ(pdata, MDIO_MMD_PMAPMD,\r\nMDIO_PMA_10GBR_FECABLE);\r\npdata->fec_ability &= (MDIO_PMA_10GBR_FECABLE_ABLE |\r\nMDIO_PMA_10GBR_FECABLE_ERRABLE);\r\nif (pdata->fec_ability & MDIO_PMA_10GBR_FECABLE_ABLE)\r\npdata->phy.supported |= SUPPORTED_10000baseR_FEC;\r\npdata->phy.advertising = pdata->phy.supported;\r\npdata->phy.address = 0;\r\npdata->phy.autoneg = AUTONEG_ENABLE;\r\npdata->phy.speed = SPEED_UNKNOWN;\r\npdata->phy.duplex = DUPLEX_UNKNOWN;\r\npdata->phy.link = 0;\r\npdata->phy.pause_autoneg = pdata->pause_autoneg;\r\npdata->phy.tx_pause = pdata->tx_pause;\r\npdata->phy.rx_pause = pdata->rx_pause;\r\npdata->phy.advertising &= ~ADVERTISED_Pause;\r\npdata->phy.advertising &= ~ADVERTISED_Asym_Pause;\r\nif (pdata->rx_pause) {\r\npdata->phy.advertising |= ADVERTISED_Pause;\r\npdata->phy.advertising |= ADVERTISED_Asym_Pause;\r\n}\r\nif (pdata->tx_pause)\r\npdata->phy.advertising ^= ADVERTISED_Asym_Pause;\r\nif (netif_msg_drv(pdata))\r\nxgbe_dump_phy_registers(pdata);\r\n}\r\nvoid xgbe_init_function_ptrs_phy(struct xgbe_phy_if *phy_if)\r\n{\r\nphy_if->phy_init = xgbe_phy_init;\r\nphy_if->phy_reset = xgbe_phy_reset;\r\nphy_if->phy_start = xgbe_phy_start;\r\nphy_if->phy_stop = xgbe_phy_stop;\r\nphy_if->phy_status = xgbe_phy_status;\r\nphy_if->phy_config_aneg = xgbe_phy_config_aneg;\r\n}

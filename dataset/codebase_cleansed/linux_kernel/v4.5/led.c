void ath5k_led_enable(struct ath5k_hw *ah)\r\n{\r\nif (test_bit(ATH_STAT_LEDSOFT, ah->status)) {\r\nath5k_hw_set_gpio_output(ah, ah->led_pin);\r\nath5k_led_off(ah);\r\n}\r\n}\r\nstatic void ath5k_led_on(struct ath5k_hw *ah)\r\n{\r\nif (!test_bit(ATH_STAT_LEDSOFT, ah->status))\r\nreturn;\r\nath5k_hw_set_gpio(ah, ah->led_pin, ah->led_on);\r\n}\r\nvoid ath5k_led_off(struct ath5k_hw *ah)\r\n{\r\nif (!test_bit(ATH_STAT_LEDSOFT, ah->status))\r\nreturn;\r\nath5k_hw_set_gpio(ah, ah->led_pin, !ah->led_on);\r\n}\r\nstatic void\r\nath5k_led_brightness_set(struct led_classdev *led_dev,\r\nenum led_brightness brightness)\r\n{\r\nstruct ath5k_led *led = container_of(led_dev, struct ath5k_led,\r\nled_dev);\r\nif (brightness == LED_OFF)\r\nath5k_led_off(led->ah);\r\nelse\r\nath5k_led_on(led->ah);\r\n}\r\nstatic int\r\nath5k_register_led(struct ath5k_hw *ah, struct ath5k_led *led,\r\nconst char *name, const char *trigger)\r\n{\r\nint err;\r\nled->ah = ah;\r\nstrncpy(led->name, name, sizeof(led->name));\r\nled->name[sizeof(led->name)-1] = 0;\r\nled->led_dev.name = led->name;\r\nled->led_dev.default_trigger = trigger;\r\nled->led_dev.brightness_set = ath5k_led_brightness_set;\r\nerr = led_classdev_register(ah->dev, &led->led_dev);\r\nif (err) {\r\nATH5K_WARN(ah, "could not register LED %s\n", name);\r\nled->ah = NULL;\r\n}\r\nreturn err;\r\n}\r\nstatic void\r\nath5k_unregister_led(struct ath5k_led *led)\r\n{\r\nif (!led->ah)\r\nreturn;\r\nled_classdev_unregister(&led->led_dev);\r\nath5k_led_off(led->ah);\r\nled->ah = NULL;\r\n}\r\nvoid ath5k_unregister_leds(struct ath5k_hw *ah)\r\n{\r\nath5k_unregister_led(&ah->rx_led);\r\nath5k_unregister_led(&ah->tx_led);\r\n}\r\nint ath5k_init_leds(struct ath5k_hw *ah)\r\n{\r\nint ret = 0;\r\nstruct ieee80211_hw *hw = ah->hw;\r\n#ifndef CONFIG_ATH5K_AHB\r\nstruct pci_dev *pdev = ah->pdev;\r\n#endif\r\nchar name[ATH5K_LED_MAX_NAME_LEN + 1];\r\nconst struct pci_device_id *match;\r\nif (!ah->pdev)\r\nreturn 0;\r\n#ifdef CONFIG_ATH5K_AHB\r\nmatch = NULL;\r\n#else\r\nmatch = pci_match_id(&ath5k_led_devices[0], pdev);\r\n#endif\r\nif (match) {\r\n__set_bit(ATH_STAT_LEDSOFT, ah->status);\r\nah->led_pin = ATH_PIN(match->driver_data);\r\nah->led_on = ATH_POLARITY(match->driver_data);\r\n}\r\nif (!test_bit(ATH_STAT_LEDSOFT, ah->status))\r\ngoto out;\r\nath5k_led_enable(ah);\r\nsnprintf(name, sizeof(name), "ath5k-%s::rx", wiphy_name(hw->wiphy));\r\nret = ath5k_register_led(ah, &ah->rx_led, name,\r\nieee80211_get_rx_led_name(hw));\r\nif (ret)\r\ngoto out;\r\nsnprintf(name, sizeof(name), "ath5k-%s::tx", wiphy_name(hw->wiphy));\r\nret = ath5k_register_led(ah, &ah->tx_led, name,\r\nieee80211_get_tx_led_name(hw));\r\nout:\r\nreturn ret;\r\n}

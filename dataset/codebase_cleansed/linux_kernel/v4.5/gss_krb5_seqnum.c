static s32\r\nkrb5_make_rc4_seq_num(struct krb5_ctx *kctx, int direction, s32 seqnum,\r\nunsigned char *cksum, unsigned char *buf)\r\n{\r\nstruct crypto_blkcipher *cipher;\r\nunsigned char plain[8];\r\ns32 code;\r\ndprintk("RPC: %s:\n", __func__);\r\ncipher = crypto_alloc_blkcipher(kctx->gk5e->encrypt_name, 0,\r\nCRYPTO_ALG_ASYNC);\r\nif (IS_ERR(cipher))\r\nreturn PTR_ERR(cipher);\r\nplain[0] = (unsigned char) ((seqnum >> 24) & 0xff);\r\nplain[1] = (unsigned char) ((seqnum >> 16) & 0xff);\r\nplain[2] = (unsigned char) ((seqnum >> 8) & 0xff);\r\nplain[3] = (unsigned char) ((seqnum >> 0) & 0xff);\r\nplain[4] = direction;\r\nplain[5] = direction;\r\nplain[6] = direction;\r\nplain[7] = direction;\r\ncode = krb5_rc4_setup_seq_key(kctx, cipher, cksum);\r\nif (code)\r\ngoto out;\r\ncode = krb5_encrypt(cipher, cksum, plain, buf, 8);\r\nout:\r\ncrypto_free_blkcipher(cipher);\r\nreturn code;\r\n}\r\ns32\r\nkrb5_make_seq_num(struct krb5_ctx *kctx,\r\nstruct crypto_blkcipher *key,\r\nint direction,\r\nu32 seqnum,\r\nunsigned char *cksum, unsigned char *buf)\r\n{\r\nunsigned char plain[8];\r\nif (kctx->enctype == ENCTYPE_ARCFOUR_HMAC)\r\nreturn krb5_make_rc4_seq_num(kctx, direction, seqnum,\r\ncksum, buf);\r\nplain[0] = (unsigned char) (seqnum & 0xff);\r\nplain[1] = (unsigned char) ((seqnum >> 8) & 0xff);\r\nplain[2] = (unsigned char) ((seqnum >> 16) & 0xff);\r\nplain[3] = (unsigned char) ((seqnum >> 24) & 0xff);\r\nplain[4] = direction;\r\nplain[5] = direction;\r\nplain[6] = direction;\r\nplain[7] = direction;\r\nreturn krb5_encrypt(key, cksum, plain, buf, 8);\r\n}\r\nstatic s32\r\nkrb5_get_rc4_seq_num(struct krb5_ctx *kctx, unsigned char *cksum,\r\nunsigned char *buf, int *direction, s32 *seqnum)\r\n{\r\nstruct crypto_blkcipher *cipher;\r\nunsigned char plain[8];\r\ns32 code;\r\ndprintk("RPC: %s:\n", __func__);\r\ncipher = crypto_alloc_blkcipher(kctx->gk5e->encrypt_name, 0,\r\nCRYPTO_ALG_ASYNC);\r\nif (IS_ERR(cipher))\r\nreturn PTR_ERR(cipher);\r\ncode = krb5_rc4_setup_seq_key(kctx, cipher, cksum);\r\nif (code)\r\ngoto out;\r\ncode = krb5_decrypt(cipher, cksum, buf, plain, 8);\r\nif (code)\r\ngoto out;\r\nif ((plain[4] != plain[5]) || (plain[4] != plain[6])\r\n|| (plain[4] != plain[7])) {\r\ncode = (s32)KG_BAD_SEQ;\r\ngoto out;\r\n}\r\n*direction = plain[4];\r\n*seqnum = ((plain[0] << 24) | (plain[1] << 16) |\r\n(plain[2] << 8) | (plain[3]));\r\nout:\r\ncrypto_free_blkcipher(cipher);\r\nreturn code;\r\n}\r\ns32\r\nkrb5_get_seq_num(struct krb5_ctx *kctx,\r\nunsigned char *cksum,\r\nunsigned char *buf,\r\nint *direction, u32 *seqnum)\r\n{\r\ns32 code;\r\nunsigned char plain[8];\r\nstruct crypto_blkcipher *key = kctx->seq;\r\ndprintk("RPC: krb5_get_seq_num:\n");\r\nif (kctx->enctype == ENCTYPE_ARCFOUR_HMAC)\r\nreturn krb5_get_rc4_seq_num(kctx, cksum, buf,\r\ndirection, seqnum);\r\nif ((code = krb5_decrypt(key, cksum, buf, plain, 8)))\r\nreturn code;\r\nif ((plain[4] != plain[5]) || (plain[4] != plain[6]) ||\r\n(plain[4] != plain[7]))\r\nreturn (s32)KG_BAD_SEQ;\r\n*direction = plain[4];\r\n*seqnum = ((plain[0]) |\r\n(plain[1] << 8) | (plain[2] << 16) | (plain[3] << 24));\r\nreturn 0;\r\n}

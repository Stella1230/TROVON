static void inv_clear_kfifo(struct inv_mpu6050_state *st)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&st->time_stamp_lock, flags);\r\nkfifo_reset(&st->timestamps);\r\nspin_unlock_irqrestore(&st->time_stamp_lock, flags);\r\n}\r\nint inv_reset_fifo(struct iio_dev *indio_dev)\r\n{\r\nint result;\r\nu8 d;\r\nstruct inv_mpu6050_state *st = iio_priv(indio_dev);\r\nresult = inv_mpu6050_write_reg(st, st->reg->int_enable, 0);\r\nif (result) {\r\ndev_err(&st->client->dev, "int_enable failed %d\n", result);\r\nreturn result;\r\n}\r\nresult = inv_mpu6050_write_reg(st, st->reg->fifo_en, 0);\r\nif (result)\r\ngoto reset_fifo_fail;\r\nresult = inv_mpu6050_write_reg(st, st->reg->user_ctrl, 0);\r\nif (result)\r\ngoto reset_fifo_fail;\r\nresult = inv_mpu6050_write_reg(st, st->reg->user_ctrl,\r\nINV_MPU6050_BIT_FIFO_RST);\r\nif (result)\r\ngoto reset_fifo_fail;\r\ninv_clear_kfifo(st);\r\nif (st->chip_config.accl_fifo_enable ||\r\nst->chip_config.gyro_fifo_enable) {\r\nresult = inv_mpu6050_write_reg(st, st->reg->int_enable,\r\nINV_MPU6050_BIT_DATA_RDY_EN);\r\nif (result)\r\nreturn result;\r\n}\r\nresult = inv_mpu6050_write_reg(st, st->reg->user_ctrl,\r\nINV_MPU6050_BIT_FIFO_EN);\r\nif (result)\r\ngoto reset_fifo_fail;\r\nd = 0;\r\nif (st->chip_config.gyro_fifo_enable)\r\nd |= INV_MPU6050_BITS_GYRO_OUT;\r\nif (st->chip_config.accl_fifo_enable)\r\nd |= INV_MPU6050_BIT_ACCEL_OUT;\r\nresult = inv_mpu6050_write_reg(st, st->reg->fifo_en, d);\r\nif (result)\r\ngoto reset_fifo_fail;\r\nreturn 0;\r\nreset_fifo_fail:\r\ndev_err(&st->client->dev, "reset fifo failed %d\n", result);\r\nresult = inv_mpu6050_write_reg(st, st->reg->int_enable,\r\nINV_MPU6050_BIT_DATA_RDY_EN);\r\nreturn result;\r\n}\r\nirqreturn_t inv_mpu6050_irq_handler(int irq, void *p)\r\n{\r\nstruct iio_poll_func *pf = p;\r\nstruct iio_dev *indio_dev = pf->indio_dev;\r\nstruct inv_mpu6050_state *st = iio_priv(indio_dev);\r\ns64 timestamp;\r\ntimestamp = iio_get_time_ns();\r\nkfifo_in_spinlocked(&st->timestamps, &timestamp, 1,\r\n&st->time_stamp_lock);\r\nreturn IRQ_WAKE_THREAD;\r\n}\r\nirqreturn_t inv_mpu6050_read_fifo(int irq, void *p)\r\n{\r\nstruct iio_poll_func *pf = p;\r\nstruct iio_dev *indio_dev = pf->indio_dev;\r\nstruct inv_mpu6050_state *st = iio_priv(indio_dev);\r\nsize_t bytes_per_datum;\r\nint result;\r\nu8 data[INV_MPU6050_OUTPUT_DATA_SIZE];\r\nu16 fifo_count;\r\ns64 timestamp;\r\nmutex_lock(&indio_dev->mlock);\r\nif (!(st->chip_config.accl_fifo_enable |\r\nst->chip_config.gyro_fifo_enable))\r\ngoto end_session;\r\nbytes_per_datum = 0;\r\nif (st->chip_config.accl_fifo_enable)\r\nbytes_per_datum += INV_MPU6050_BYTES_PER_3AXIS_SENSOR;\r\nif (st->chip_config.gyro_fifo_enable)\r\nbytes_per_datum += INV_MPU6050_BYTES_PER_3AXIS_SENSOR;\r\nresult = i2c_smbus_read_i2c_block_data(st->client,\r\nst->reg->fifo_count_h,\r\nINV_MPU6050_FIFO_COUNT_BYTE, data);\r\nif (result != INV_MPU6050_FIFO_COUNT_BYTE)\r\ngoto end_session;\r\nfifo_count = be16_to_cpup((__be16 *)(&data[0]));\r\nif (fifo_count < bytes_per_datum)\r\ngoto end_session;\r\nif (fifo_count & 1)\r\ngoto flush_fifo;\r\nif (fifo_count > INV_MPU6050_FIFO_THRESHOLD)\r\ngoto flush_fifo;\r\nif (kfifo_len(&st->timestamps) >\r\nfifo_count / bytes_per_datum + INV_MPU6050_TIME_STAMP_TOR)\r\ngoto flush_fifo;\r\nwhile (fifo_count >= bytes_per_datum) {\r\nresult = i2c_smbus_read_i2c_block_data(st->client,\r\nst->reg->fifo_r_w,\r\nbytes_per_datum, data);\r\nif (result != bytes_per_datum)\r\ngoto flush_fifo;\r\nresult = kfifo_out(&st->timestamps, &timestamp, 1);\r\nif (0 == result)\r\ntimestamp = 0;\r\nresult = iio_push_to_buffers_with_timestamp(indio_dev, data,\r\ntimestamp);\r\nif (result)\r\ngoto flush_fifo;\r\nfifo_count -= bytes_per_datum;\r\n}\r\nend_session:\r\nmutex_unlock(&indio_dev->mlock);\r\niio_trigger_notify_done(indio_dev->trig);\r\nreturn IRQ_HANDLED;\r\nflush_fifo:\r\ninv_reset_fifo(indio_dev);\r\nmutex_unlock(&indio_dev->mlock);\r\niio_trigger_notify_done(indio_dev->trig);\r\nreturn IRQ_HANDLED;\r\n}

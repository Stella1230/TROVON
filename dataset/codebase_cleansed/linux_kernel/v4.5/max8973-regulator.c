static bool find_voltage_set_register(struct max8973_chip *tps,\r\nint req_vsel, int *vout_reg, int *gpio_val)\r\n{\r\nint i;\r\nbool found = false;\r\nint new_vout_reg = tps->lru_index[MAX8973_MAX_VOUT_REG - 1];\r\nint found_index = MAX8973_MAX_VOUT_REG - 1;\r\nfor (i = 0; i < MAX8973_MAX_VOUT_REG; ++i) {\r\nif (tps->curr_vout_val[tps->lru_index[i]] == req_vsel) {\r\nnew_vout_reg = tps->lru_index[i];\r\nfound_index = i;\r\nfound = true;\r\ngoto update_lru_index;\r\n}\r\n}\r\nupdate_lru_index:\r\nfor (i = found_index; i > 0; i--)\r\ntps->lru_index[i] = tps->lru_index[i - 1];\r\ntps->lru_index[0] = new_vout_reg;\r\n*gpio_val = new_vout_reg;\r\n*vout_reg = MAX8973_VOUT + new_vout_reg;\r\nreturn found;\r\n}\r\nstatic int max8973_dcdc_get_voltage_sel(struct regulator_dev *rdev)\r\n{\r\nstruct max8973_chip *max = rdev_get_drvdata(rdev);\r\nunsigned int data;\r\nint ret;\r\nret = regmap_read(max->regmap, max->curr_vout_reg, &data);\r\nif (ret < 0) {\r\ndev_err(max->dev, "register %d read failed, err = %d\n",\r\nmax->curr_vout_reg, ret);\r\nreturn ret;\r\n}\r\nreturn data & MAX8973_VOUT_MASK;\r\n}\r\nstatic int max8973_dcdc_set_voltage_sel(struct regulator_dev *rdev,\r\nunsigned vsel)\r\n{\r\nstruct max8973_chip *max = rdev_get_drvdata(rdev);\r\nint ret;\r\nbool found = false;\r\nint vout_reg = max->curr_vout_reg;\r\nint gpio_val = max->curr_gpio_val;\r\nif (gpio_is_valid(max->dvs_gpio))\r\nfound = find_voltage_set_register(max, vsel,\r\n&vout_reg, &gpio_val);\r\nif (!found) {\r\nret = regmap_update_bits(max->regmap, vout_reg,\r\nMAX8973_VOUT_MASK, vsel);\r\nif (ret < 0) {\r\ndev_err(max->dev, "register %d update failed, err %d\n",\r\nvout_reg, ret);\r\nreturn ret;\r\n}\r\nmax->curr_vout_reg = vout_reg;\r\nmax->curr_vout_val[gpio_val] = vsel;\r\n}\r\nif (gpio_is_valid(max->dvs_gpio)) {\r\ngpio_set_value_cansleep(max->dvs_gpio, gpio_val & 0x1);\r\nmax->curr_gpio_val = gpio_val;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max8973_dcdc_set_mode(struct regulator_dev *rdev, unsigned int mode)\r\n{\r\nstruct max8973_chip *max = rdev_get_drvdata(rdev);\r\nint ret;\r\nint pwm;\r\nswitch (mode) {\r\ncase REGULATOR_MODE_FAST:\r\npwm = MAX8973_FPWM_EN_M;\r\nbreak;\r\ncase REGULATOR_MODE_NORMAL:\r\npwm = 0;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nret = regmap_update_bits(max->regmap, MAX8973_CONTROL1,\r\nMAX8973_FPWM_EN_M, pwm);\r\nif (ret < 0)\r\ndev_err(max->dev, "register %d update failed, err %d\n",\r\nMAX8973_CONTROL1, ret);\r\nreturn ret;\r\n}\r\nstatic unsigned int max8973_dcdc_get_mode(struct regulator_dev *rdev)\r\n{\r\nstruct max8973_chip *max = rdev_get_drvdata(rdev);\r\nunsigned int data;\r\nint ret;\r\nret = regmap_read(max->regmap, MAX8973_CONTROL1, &data);\r\nif (ret < 0) {\r\ndev_err(max->dev, "register %d read failed, err %d\n",\r\nMAX8973_CONTROL1, ret);\r\nreturn ret;\r\n}\r\nreturn (data & MAX8973_FPWM_EN_M) ?\r\nREGULATOR_MODE_FAST : REGULATOR_MODE_NORMAL;\r\n}\r\nstatic int max8973_set_ramp_delay(struct regulator_dev *rdev,\r\nint ramp_delay)\r\n{\r\nstruct max8973_chip *max = rdev_get_drvdata(rdev);\r\nunsigned int control;\r\nint ret;\r\nint ret_val;\r\nif (ramp_delay < 25000) {\r\ncontrol = MAX8973_RAMP_12mV_PER_US;\r\nret_val = 12000;\r\n} else if (ramp_delay < 50000) {\r\ncontrol = MAX8973_RAMP_25mV_PER_US;\r\nret_val = 25000;\r\n} else if (ramp_delay < 200000) {\r\ncontrol = MAX8973_RAMP_50mV_PER_US;\r\nret_val = 50000;\r\n} else {\r\ncontrol = MAX8973_RAMP_200mV_PER_US;\r\nret_val = 200000;\r\n}\r\nret = regmap_update_bits(max->regmap, MAX8973_CONTROL1,\r\nMAX8973_RAMP_MASK, control);\r\nif (ret < 0)\r\ndev_err(max->dev, "register %d update failed, %d",\r\nMAX8973_CONTROL1, ret);\r\nreturn ret;\r\n}\r\nstatic int max8973_set_current_limit(struct regulator_dev *rdev,\r\nint min_ua, int max_ua)\r\n{\r\nstruct max8973_chip *max = rdev_get_drvdata(rdev);\r\nunsigned int val;\r\nint ret;\r\nif (max_ua <= 9000000)\r\nval = MAX8973_CKKADV_TRIP_75mV_PER_US;\r\nelse if (max_ua <= 12000000)\r\nval = MAX8973_CKKADV_TRIP_150mV_PER_US;\r\nelse\r\nval = MAX8973_CKKADV_TRIP_DISABLE;\r\nret = regmap_update_bits(max->regmap, MAX8973_CONTROL2,\r\nMAX8973_CKKADV_TRIP_MASK, val);\r\nif (ret < 0) {\r\ndev_err(max->dev, "register %d update failed: %d\n",\r\nMAX8973_CONTROL2, ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max8973_get_current_limit(struct regulator_dev *rdev)\r\n{\r\nstruct max8973_chip *max = rdev_get_drvdata(rdev);\r\nunsigned int control2;\r\nint ret;\r\nret = regmap_read(max->regmap, MAX8973_CONTROL2, &control2);\r\nif (ret < 0) {\r\ndev_err(max->dev, "register %d read failed: %d\n",\r\nMAX8973_CONTROL2, ret);\r\nreturn ret;\r\n}\r\nswitch (control2 & MAX8973_CKKADV_TRIP_MASK) {\r\ncase MAX8973_CKKADV_TRIP_DISABLE:\r\nreturn 15000000;\r\ncase MAX8973_CKKADV_TRIP_150mV_PER_US:\r\nreturn 12000000;\r\ncase MAX8973_CKKADV_TRIP_75mV_PER_US:\r\nreturn 9000000;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 9000000;\r\n}\r\nstatic int max8973_init_dcdc(struct max8973_chip *max,\r\nstruct max8973_regulator_platform_data *pdata)\r\n{\r\nint ret;\r\nuint8_t control1 = 0;\r\nuint8_t control2 = 0;\r\nunsigned int data;\r\nret = regmap_read(max->regmap, MAX8973_CONTROL1, &data);\r\nif (ret < 0) {\r\ndev_err(max->dev, "register %d read failed, err = %d",\r\nMAX8973_CONTROL1, ret);\r\nreturn ret;\r\n}\r\ncontrol1 = data & MAX8973_RAMP_MASK;\r\nswitch (control1) {\r\ncase MAX8973_RAMP_12mV_PER_US:\r\nmax->desc.ramp_delay = 12000;\r\nbreak;\r\ncase MAX8973_RAMP_25mV_PER_US:\r\nmax->desc.ramp_delay = 25000;\r\nbreak;\r\ncase MAX8973_RAMP_50mV_PER_US:\r\nmax->desc.ramp_delay = 50000;\r\nbreak;\r\ncase MAX8973_RAMP_200mV_PER_US:\r\nmax->desc.ramp_delay = 200000;\r\nbreak;\r\n}\r\nif (pdata->control_flags & MAX8973_CONTROL_REMOTE_SENSE_ENABLE)\r\ncontrol1 |= MAX8973_SNS_ENABLE;\r\nif (!(pdata->control_flags & MAX8973_CONTROL_FALLING_SLEW_RATE_ENABLE))\r\ncontrol1 |= MAX8973_NFSR_ENABLE;\r\nif (pdata->control_flags & MAX8973_CONTROL_OUTPUT_ACTIVE_DISCH_ENABLE)\r\ncontrol1 |= MAX8973_AD_ENABLE;\r\nif (pdata->control_flags & MAX8973_CONTROL_BIAS_ENABLE) {\r\ncontrol1 |= MAX8973_BIAS_ENABLE;\r\nmax->desc.enable_time = 20;\r\n} else {\r\nmax->desc.enable_time = 240;\r\n}\r\nif (pdata->control_flags & MAX8973_CONTROL_FREQ_SHIFT_9PER_ENABLE)\r\ncontrol1 |= MAX8973_FREQSHIFT_9PER;\r\nif (!(pdata->control_flags & MAX8973_CONTROL_PULL_DOWN_ENABLE))\r\ncontrol2 |= MAX8973_DISCH_ENBABLE;\r\nswitch (pdata->control_flags & MAX8973_CONTROL_CLKADV_TRIP_MASK) {\r\ncase MAX8973_CONTROL_CLKADV_TRIP_DISABLED:\r\ncontrol2 |= MAX8973_CKKADV_TRIP_DISABLE;\r\nbreak;\r\ncase MAX8973_CONTROL_CLKADV_TRIP_75mV_PER_US:\r\ncontrol2 |= MAX8973_CKKADV_TRIP_75mV_PER_US;\r\nbreak;\r\ncase MAX8973_CONTROL_CLKADV_TRIP_150mV_PER_US:\r\ncontrol2 |= MAX8973_CKKADV_TRIP_150mV_PER_US;\r\nbreak;\r\ncase MAX8973_CONTROL_CLKADV_TRIP_75mV_PER_US_HIST_DIS:\r\ncontrol2 |= MAX8973_CKKADV_TRIP_75mV_PER_US_HIST_DIS;\r\nbreak;\r\n}\r\nswitch (pdata->control_flags & MAX8973_CONTROL_INDUCTOR_VALUE_MASK) {\r\ncase MAX8973_CONTROL_INDUCTOR_VALUE_NOMINAL:\r\ncontrol2 |= MAX8973_INDUCTOR_NOMINAL;\r\nbreak;\r\ncase MAX8973_CONTROL_INDUCTOR_VALUE_MINUS_30_PER:\r\ncontrol2 |= MAX8973_INDUCTOR_MIN_30_PER;\r\nbreak;\r\ncase MAX8973_CONTROL_INDUCTOR_VALUE_PLUS_30_PER:\r\ncontrol2 |= MAX8973_INDUCTOR_PLUS_30_PER;\r\nbreak;\r\ncase MAX8973_CONTROL_INDUCTOR_VALUE_PLUS_60_PER:\r\ncontrol2 |= MAX8973_INDUCTOR_PLUS_60_PER;\r\nbreak;\r\n}\r\nret = regmap_write(max->regmap, MAX8973_CONTROL1, control1);\r\nif (ret < 0) {\r\ndev_err(max->dev, "register %d write failed, err = %d",\r\nMAX8973_CONTROL1, ret);\r\nreturn ret;\r\n}\r\nret = regmap_write(max->regmap, MAX8973_CONTROL2, control2);\r\nif (ret < 0) {\r\ndev_err(max->dev, "register %d write failed, err = %d",\r\nMAX8973_CONTROL2, ret);\r\nreturn ret;\r\n}\r\nif (max->enable_external_control && (max->id == MAX8973)) {\r\nret = regmap_update_bits(max->regmap, MAX8973_VOUT,\r\nMAX8973_VOUT_ENABLE, 0);\r\nif (ret < 0)\r\ndev_err(max->dev, "register %d update failed, err = %d",\r\nMAX8973_VOUT, ret);\r\n}\r\nreturn ret;\r\n}\r\nstatic struct max8973_regulator_platform_data *max8973_parse_dt(\r\nstruct device *dev)\r\n{\r\nstruct max8973_regulator_platform_data *pdata;\r\nstruct device_node *np = dev->of_node;\r\nint ret;\r\nu32 pval;\r\nbool etr_enable;\r\nbool etr_sensitivity_high;\r\npdata = devm_kzalloc(dev, sizeof(*pdata), GFP_KERNEL);\r\nif (!pdata)\r\nreturn NULL;\r\npdata->enable_ext_control = of_property_read_bool(np,\r\n"maxim,externally-enable");\r\npdata->enable_gpio = of_get_named_gpio(np, "maxim,enable-gpio", 0);\r\npdata->dvs_gpio = of_get_named_gpio(np, "maxim,dvs-gpio", 0);\r\nret = of_property_read_u32(np, "maxim,dvs-default-state", &pval);\r\nif (!ret)\r\npdata->dvs_def_state = pval;\r\nif (of_property_read_bool(np, "maxim,enable-remote-sense"))\r\npdata->control_flags |= MAX8973_CONTROL_REMOTE_SENSE_ENABLE;\r\nif (of_property_read_bool(np, "maxim,enable-falling-slew-rate"))\r\npdata->control_flags |=\r\nMAX8973_CONTROL_FALLING_SLEW_RATE_ENABLE;\r\nif (of_property_read_bool(np, "maxim,enable-active-discharge"))\r\npdata->control_flags |=\r\nMAX8973_CONTROL_OUTPUT_ACTIVE_DISCH_ENABLE;\r\nif (of_property_read_bool(np, "maxim,enable-frequency-shift"))\r\npdata->control_flags |= MAX8973_CONTROL_FREQ_SHIFT_9PER_ENABLE;\r\nif (of_property_read_bool(np, "maxim,enable-bias-control"))\r\npdata->control_flags |= MAX8973_CONTROL_BIAS_ENABLE;\r\netr_enable = of_property_read_bool(np, "maxim,enable-etr");\r\netr_sensitivity_high = of_property_read_bool(np,\r\n"maxim,enable-high-etr-sensitivity");\r\nif (etr_sensitivity_high)\r\netr_enable = true;\r\nif (etr_enable) {\r\nif (etr_sensitivity_high)\r\npdata->control_flags |=\r\nMAX8973_CONTROL_CLKADV_TRIP_75mV_PER_US;\r\nelse\r\npdata->control_flags |=\r\nMAX8973_CONTROL_CLKADV_TRIP_150mV_PER_US;\r\n} else {\r\npdata->control_flags |= MAX8973_CONTROL_CLKADV_TRIP_DISABLED;\r\n}\r\nreturn pdata;\r\n}\r\nstatic int max8973_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct max8973_regulator_platform_data *pdata;\r\nstruct regulator_init_data *ridata;\r\nstruct regulator_config config = { };\r\nstruct regulator_dev *rdev;\r\nstruct max8973_chip *max;\r\nbool pdata_from_dt = false;\r\nunsigned int chip_id;\r\nint ret;\r\npdata = dev_get_platdata(&client->dev);\r\nif (!pdata && client->dev.of_node) {\r\npdata = max8973_parse_dt(&client->dev);\r\npdata_from_dt = true;\r\n}\r\nif (!pdata) {\r\ndev_err(&client->dev, "No Platform data");\r\nreturn -EIO;\r\n}\r\nif ((pdata->dvs_gpio == -EPROBE_DEFER) ||\r\n(pdata->enable_gpio == -EPROBE_DEFER))\r\nreturn -EPROBE_DEFER;\r\nmax = devm_kzalloc(&client->dev, sizeof(*max), GFP_KERNEL);\r\nif (!max)\r\nreturn -ENOMEM;\r\nmax->regmap = devm_regmap_init_i2c(client, &max8973_regmap_config);\r\nif (IS_ERR(max->regmap)) {\r\nret = PTR_ERR(max->regmap);\r\ndev_err(&client->dev, "regmap init failed, err %d\n", ret);\r\nreturn ret;\r\n}\r\nif (client->dev.of_node) {\r\nconst struct of_device_id *match;\r\nmatch = of_match_device(of_match_ptr(of_max8973_match_tbl),\r\n&client->dev);\r\nif (!match)\r\nreturn -ENODATA;\r\nmax->id = (u32)((uintptr_t)match->data);\r\n} else {\r\nmax->id = id->driver_data;\r\n}\r\nret = regmap_read(max->regmap, MAX8973_CHIPID1, &chip_id);\r\nif (ret < 0) {\r\ndev_err(&client->dev, "register CHIPID1 read failed, %d", ret);\r\nreturn ret;\r\n}\r\ndev_info(&client->dev, "CHIP-ID OTP: 0x%02x ID_M: 0x%02x\n",\r\n(chip_id >> 4) & 0xF, (chip_id >> 1) & 0x7);\r\ni2c_set_clientdata(client, max);\r\nmax->ops = max8973_dcdc_ops;\r\nmax->dev = &client->dev;\r\nmax->desc.name = id->name;\r\nmax->desc.id = 0;\r\nmax->desc.ops = &max->ops;\r\nmax->desc.type = REGULATOR_VOLTAGE;\r\nmax->desc.owner = THIS_MODULE;\r\nmax->desc.min_uV = MAX8973_MIN_VOLATGE;\r\nmax->desc.uV_step = MAX8973_VOLATGE_STEP;\r\nmax->desc.n_voltages = MAX8973_BUCK_N_VOLTAGE;\r\nmax->dvs_gpio = (pdata->dvs_gpio) ? pdata->dvs_gpio : -EINVAL;\r\nmax->enable_gpio = (pdata->enable_gpio) ? pdata->enable_gpio : -EINVAL;\r\nmax->enable_external_control = pdata->enable_ext_control;\r\nmax->curr_gpio_val = pdata->dvs_def_state;\r\nmax->curr_vout_reg = MAX8973_VOUT + pdata->dvs_def_state;\r\nif (gpio_is_valid(max->enable_gpio))\r\nmax->enable_external_control = true;\r\nmax->lru_index[0] = max->curr_vout_reg;\r\nif (gpio_is_valid(max->dvs_gpio)) {\r\nint gpio_flags;\r\nint i;\r\ngpio_flags = (pdata->dvs_def_state) ?\r\nGPIOF_OUT_INIT_HIGH : GPIOF_OUT_INIT_LOW;\r\nret = devm_gpio_request_one(&client->dev, max->dvs_gpio,\r\ngpio_flags, "max8973-dvs");\r\nif (ret) {\r\ndev_err(&client->dev,\r\n"gpio_request for gpio %d failed, err = %d\n",\r\nmax->dvs_gpio, ret);\r\nreturn ret;\r\n}\r\nfor (i = 0; i < MAX8973_MAX_VOUT_REG; ++i)\r\nmax->lru_index[i] = i;\r\nmax->lru_index[0] = max->curr_vout_reg;\r\nmax->lru_index[max->curr_vout_reg] = 0;\r\n} else {\r\nmax->ops.set_voltage_sel = regulator_set_voltage_sel_regmap;\r\nmax->ops.get_voltage_sel = regulator_get_voltage_sel_regmap;\r\nmax->desc.vsel_reg = max->curr_vout_reg;\r\nmax->desc.vsel_mask = MAX8973_VOUT_MASK;\r\n}\r\nif (pdata_from_dt)\r\npdata->reg_init_data = of_get_regulator_init_data(&client->dev,\r\nclient->dev.of_node, &max->desc);\r\nridata = pdata->reg_init_data;\r\nswitch (max->id) {\r\ncase MAX8973:\r\nif (!pdata->enable_ext_control) {\r\nmax->desc.enable_reg = MAX8973_VOUT;\r\nmax->desc.enable_mask = MAX8973_VOUT_ENABLE;\r\nmax->ops.enable = regulator_enable_regmap;\r\nmax->ops.disable = regulator_disable_regmap;\r\nmax->ops.is_enabled = regulator_is_enabled_regmap;\r\nbreak;\r\n}\r\nif (gpio_is_valid(max->enable_gpio)) {\r\nconfig.ena_gpio_flags = GPIOF_OUT_INIT_LOW;\r\nif (ridata && (ridata->constraints.always_on ||\r\nridata->constraints.boot_on))\r\nconfig.ena_gpio_flags = GPIOF_OUT_INIT_HIGH;\r\nconfig.ena_gpio = max->enable_gpio;\r\n}\r\nbreak;\r\ncase MAX77621:\r\nif (gpio_is_valid(max->enable_gpio)) {\r\nret = devm_gpio_request_one(&client->dev,\r\nmax->enable_gpio, GPIOF_OUT_INIT_HIGH,\r\n"max8973-en-gpio");\r\nif (ret) {\r\ndev_err(&client->dev,\r\n"gpio_request for gpio %d failed: %d\n",\r\nmax->enable_gpio, ret);\r\nreturn ret;\r\n}\r\n}\r\nmax->desc.enable_reg = MAX8973_VOUT;\r\nmax->desc.enable_mask = MAX8973_VOUT_ENABLE;\r\nmax->ops.enable = regulator_enable_regmap;\r\nmax->ops.disable = regulator_disable_regmap;\r\nmax->ops.is_enabled = regulator_is_enabled_regmap;\r\nmax->ops.set_current_limit = max8973_set_current_limit;\r\nmax->ops.get_current_limit = max8973_get_current_limit;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nret = max8973_init_dcdc(max, pdata);\r\nif (ret < 0) {\r\ndev_err(max->dev, "Max8973 Init failed, err = %d\n", ret);\r\nreturn ret;\r\n}\r\nconfig.dev = &client->dev;\r\nconfig.init_data = pdata->reg_init_data;\r\nconfig.driver_data = max;\r\nconfig.of_node = client->dev.of_node;\r\nconfig.regmap = max->regmap;\r\nrdev = devm_regulator_register(&client->dev, &max->desc, &config);\r\nif (IS_ERR(rdev)) {\r\nret = PTR_ERR(rdev);\r\ndev_err(max->dev, "regulator register failed, err %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init max8973_init(void)\r\n{\r\nreturn i2c_add_driver(&max8973_i2c_driver);\r\n}\r\nstatic void __exit max8973_cleanup(void)\r\n{\r\ni2c_del_driver(&max8973_i2c_driver);\r\n}

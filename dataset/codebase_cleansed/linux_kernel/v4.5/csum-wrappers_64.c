__wsum\r\ncsum_partial_copy_from_user(const void __user *src, void *dst,\r\nint len, __wsum isum, int *errp)\r\n{\r\nmight_sleep();\r\n*errp = 0;\r\nif (!likely(access_ok(VERIFY_READ, src, len)))\r\ngoto out_err;\r\nif (unlikely((unsigned long)src & 6)) {\r\nwhile (((unsigned long)src & 6) && len >= 2) {\r\n__u16 val16;\r\nif (__get_user(val16, (const __u16 __user *)src))\r\ngoto out_err;\r\n*(__u16 *)dst = val16;\r\nisum = (__force __wsum)add32_with_carry(\r\n(__force unsigned)isum, val16);\r\nsrc += 2;\r\ndst += 2;\r\nlen -= 2;\r\n}\r\n}\r\nstac();\r\nisum = csum_partial_copy_generic((__force const void *)src,\r\ndst, len, isum, errp, NULL);\r\nclac();\r\nif (unlikely(*errp))\r\ngoto out_err;\r\nreturn isum;\r\nout_err:\r\n*errp = -EFAULT;\r\nmemset(dst, 0, len);\r\nreturn isum;\r\n}\r\n__wsum\r\ncsum_partial_copy_to_user(const void *src, void __user *dst,\r\nint len, __wsum isum, int *errp)\r\n{\r\n__wsum ret;\r\nmight_sleep();\r\nif (unlikely(!access_ok(VERIFY_WRITE, dst, len))) {\r\n*errp = -EFAULT;\r\nreturn 0;\r\n}\r\nif (unlikely((unsigned long)dst & 6)) {\r\nwhile (((unsigned long)dst & 6) && len >= 2) {\r\n__u16 val16 = *(__u16 *)src;\r\nisum = (__force __wsum)add32_with_carry(\r\n(__force unsigned)isum, val16);\r\n*errp = __put_user(val16, (__u16 __user *)dst);\r\nif (*errp)\r\nreturn isum;\r\nsrc += 2;\r\ndst += 2;\r\nlen -= 2;\r\n}\r\n}\r\n*errp = 0;\r\nstac();\r\nret = csum_partial_copy_generic(src, (void __force *)dst,\r\nlen, isum, NULL, errp);\r\nclac();\r\nreturn ret;\r\n}\r\n__wsum\r\ncsum_partial_copy_nocheck(const void *src, void *dst, int len, __wsum sum)\r\n{\r\nreturn csum_partial_copy_generic(src, dst, len, sum, NULL, NULL);\r\n}\r\n__sum16 csum_ipv6_magic(const struct in6_addr *saddr,\r\nconst struct in6_addr *daddr,\r\n__u32 len, unsigned short proto, __wsum sum)\r\n{\r\n__u64 rest, sum64;\r\nrest = (__force __u64)htonl(len) + (__force __u64)htons(proto) +\r\n(__force __u64)sum;\r\nasm(" addq (%[saddr]),%[sum]\n"\r\n" adcq 8(%[saddr]),%[sum]\n"\r\n" adcq (%[daddr]),%[sum]\n"\r\n" adcq 8(%[daddr]),%[sum]\n"\r\n" adcq $0,%[sum]\n"\r\n: [sum] "=r" (sum64)\r\n: "[sum]" (rest), [saddr] "r" (saddr), [daddr] "r" (daddr));\r\nreturn csum_fold(\r\n(__force __wsum)add32_with_carry(sum64 & 0xffffffff, sum64>>32));\r\n}

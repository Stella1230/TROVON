static void __init mpc8272_ads_pic_init(void)\r\n{\r\nstruct device_node *np = of_find_compatible_node(NULL, NULL,\r\n"fsl,cpm2-pic");\r\nif (!np) {\r\nprintk(KERN_ERR "PIC init: can not find fsl,cpm2-pic node\n");\r\nreturn;\r\n}\r\ncpm2_pic_init(np);\r\nof_node_put(np);\r\npq2ads_pci_init_irq();\r\n}\r\nstatic void __init init_ioports(void)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(mpc8272_ads_pins); i++) {\r\nstruct cpm_pin *pin = &mpc8272_ads_pins[i];\r\ncpm2_set_pin(pin->port, pin->pin, pin->flags);\r\n}\r\ncpm2_clk_setup(CPM_CLK_SCC1, CPM_BRG1, CPM_CLK_RX);\r\ncpm2_clk_setup(CPM_CLK_SCC1, CPM_BRG1, CPM_CLK_TX);\r\ncpm2_clk_setup(CPM_CLK_SCC3, CPM_CLK8, CPM_CLK_RX);\r\ncpm2_clk_setup(CPM_CLK_SCC3, CPM_CLK8, CPM_CLK_TX);\r\ncpm2_clk_setup(CPM_CLK_SCC4, CPM_BRG4, CPM_CLK_RX);\r\ncpm2_clk_setup(CPM_CLK_SCC4, CPM_BRG4, CPM_CLK_TX);\r\ncpm2_clk_setup(CPM_CLK_FCC1, CPM_CLK11, CPM_CLK_RX);\r\ncpm2_clk_setup(CPM_CLK_FCC1, CPM_CLK10, CPM_CLK_TX);\r\ncpm2_clk_setup(CPM_CLK_FCC2, CPM_CLK15, CPM_CLK_RX);\r\ncpm2_clk_setup(CPM_CLK_FCC2, CPM_CLK16, CPM_CLK_TX);\r\n}\r\nstatic void __init mpc8272_ads_setup_arch(void)\r\n{\r\nstruct device_node *np;\r\n__be32 __iomem *bcsr;\r\nif (ppc_md.progress)\r\nppc_md.progress("mpc8272_ads_setup_arch()", 0);\r\ncpm2_reset();\r\nnp = of_find_compatible_node(NULL, NULL, "fsl,mpc8272ads-bcsr");\r\nif (!np) {\r\nprintk(KERN_ERR "No bcsr in device tree\n");\r\nreturn;\r\n}\r\nbcsr = of_iomap(np, 0);\r\nof_node_put(np);\r\nif (!bcsr) {\r\nprintk(KERN_ERR "Cannot map BCSR registers\n");\r\nreturn;\r\n}\r\n#define BCSR1_FETHIEN 0x08000000\r\n#define BCSR1_FETH_RST 0x04000000\r\n#define BCSR1_RS232_EN1 0x02000000\r\n#define BCSR1_RS232_EN2 0x01000000\r\n#define BCSR3_USB_nEN 0x80000000\r\n#define BCSR3_FETHIEN2 0x10000000\r\n#define BCSR3_FETH2_RST 0x08000000\r\nclrbits32(&bcsr[1], BCSR1_RS232_EN1 | BCSR1_RS232_EN2 | BCSR1_FETHIEN);\r\nsetbits32(&bcsr[1], BCSR1_FETH_RST);\r\nclrbits32(&bcsr[3], BCSR3_FETHIEN2);\r\nsetbits32(&bcsr[3], BCSR3_FETH2_RST);\r\nclrbits32(&bcsr[3], BCSR3_USB_nEN);\r\niounmap(bcsr);\r\ninit_ioports();\r\npq2_init_pci();\r\nif (ppc_md.progress)\r\nppc_md.progress("mpc8272_ads_setup_arch(), finish", 0);\r\n}\r\nstatic int __init declare_of_platform_devices(void)\r\n{\r\nof_platform_bus_probe(NULL, of_bus_ids, NULL);\r\nreturn 0;\r\n}\r\nstatic int __init mpc8272_ads_probe(void)\r\n{\r\nunsigned long root = of_get_flat_dt_root();\r\nreturn of_flat_dt_is_compatible(root, "fsl,mpc8272ads");\r\n}

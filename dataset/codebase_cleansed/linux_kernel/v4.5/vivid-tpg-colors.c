static void mult_matrix(double *r, double *g, double *b, const double m[3][3])\r\n{\r\ndouble ir, ig, ib;\r\nir = m[0][0] * (*r) + m[0][1] * (*g) + m[0][2] * (*b);\r\nig = m[1][0] * (*r) + m[1][1] * (*g) + m[1][2] * (*b);\r\nib = m[2][0] * (*r) + m[2][1] * (*g) + m[2][2] * (*b);\r\n*r = ir;\r\n*g = ig;\r\n*b = ib;\r\n}\r\nstatic double transfer_srgb_to_rgb(double v)\r\n{\r\nif (v < -0.04045)\r\nreturn pow((-v + 0.055) / 1.055, 2.4);\r\nreturn (v <= 0.04045) ? v / 12.92 : pow((v + 0.055) / 1.055, 2.4);\r\n}\r\nstatic double transfer_rgb_to_srgb(double v)\r\n{\r\nif (v <= -0.0031308)\r\nreturn -1.055 * pow(-v, 1.0 / 2.4) + 0.055;\r\nif (v <= 0.0031308)\r\nreturn v * 12.92;\r\nreturn 1.055 * pow(v, 1.0 / 2.4) - 0.055;\r\n}\r\nstatic double transfer_rgb_to_smpte240m(double v)\r\n{\r\nreturn (v <= 0.0228) ? v * 4.0 : 1.1115 * pow(v, 0.45) - 0.1115;\r\n}\r\nstatic double transfer_rgb_to_rec709(double v)\r\n{\r\nif (v <= -0.018)\r\nreturn -1.099 * pow(-v, 0.45) + 0.099;\r\nreturn (v < 0.018) ? v * 4.5 : 1.099 * pow(v, 0.45) - 0.099;\r\n}\r\nstatic double transfer_rec709_to_rgb(double v)\r\n{\r\nreturn (v < 0.081) ? v / 4.5 : pow((v + 0.099) / 1.099, 1.0 / 0.45);\r\n}\r\nstatic double transfer_rgb_to_adobergb(double v)\r\n{\r\nreturn pow(v, 1.0 / 2.19921875);\r\n}\r\nstatic double transfer_rgb_to_dcip3(double v)\r\n{\r\nreturn pow(v, 1.0 / 2.6);\r\n}\r\nstatic double transfer_rgb_to_smpte2084(double v)\r\n{\r\nconst double m1 = (2610.0 / 4096.0) / 4.0;\r\nconst double m2 = 128.0 * 2523.0 / 4096.0;\r\nconst double c1 = 3424.0 / 4096.0;\r\nconst double c2 = 32.0 * 2413.0 / 4096.0;\r\nconst double c3 = 32.0 * 2392.0 / 4096.0;\r\nv = pow(v, m1);\r\nreturn pow((c1 + c2 * v) / (1 + c3 * v), m2);\r\n}\r\nstatic double transfer_srgb_to_rec709(double v)\r\n{\r\nreturn transfer_rgb_to_rec709(transfer_srgb_to_rgb(v));\r\n}\r\nstatic void csc(enum v4l2_colorspace colorspace, enum v4l2_xfer_func xfer_func,\r\ndouble *r, double *g, double *b)\r\n{\r\nint clamp = 1;\r\n*r = transfer_srgb_to_rgb(*r);\r\n*g = transfer_srgb_to_rgb(*g);\r\n*b = transfer_srgb_to_rgb(*b);\r\nswitch (colorspace) {\r\ncase V4L2_COLORSPACE_SMPTE240M:\r\nmult_matrix(r, g, b, rec709_to_240m);\r\nbreak;\r\ncase V4L2_COLORSPACE_SMPTE170M:\r\nmult_matrix(r, g, b, rec709_to_170m);\r\nbreak;\r\ncase V4L2_COLORSPACE_470_SYSTEM_BG:\r\nmult_matrix(r, g, b, rec709_to_ebu);\r\nbreak;\r\ncase V4L2_COLORSPACE_470_SYSTEM_M:\r\nmult_matrix(r, g, b, rec709_to_ntsc1953);\r\nbreak;\r\ncase V4L2_COLORSPACE_ADOBERGB:\r\nmult_matrix(r, g, b, rec709_to_adobergb);\r\nbreak;\r\ncase V4L2_COLORSPACE_BT2020:\r\nmult_matrix(r, g, b, rec709_to_bt2020);\r\nbreak;\r\ncase V4L2_COLORSPACE_DCI_P3:\r\nmult_matrix(r, g, b, rec709_to_dcip3);\r\nbreak;\r\ncase V4L2_COLORSPACE_SRGB:\r\ncase V4L2_COLORSPACE_REC709:\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (clamp) {\r\n*r = ((*r) < 0) ? 0 : (((*r) > 1) ? 1 : (*r));\r\n*g = ((*g) < 0) ? 0 : (((*g) > 1) ? 1 : (*g));\r\n*b = ((*b) < 0) ? 0 : (((*b) > 1) ? 1 : (*b));\r\n}\r\nswitch (xfer_func) {\r\ncase V4L2_XFER_FUNC_709:\r\n*r = transfer_rgb_to_rec709(*r);\r\n*g = transfer_rgb_to_rec709(*g);\r\n*b = transfer_rgb_to_rec709(*b);\r\nbreak;\r\ncase V4L2_XFER_FUNC_SRGB:\r\n*r = transfer_rgb_to_srgb(*r);\r\n*g = transfer_rgb_to_srgb(*g);\r\n*b = transfer_rgb_to_srgb(*b);\r\nbreak;\r\ncase V4L2_XFER_FUNC_ADOBERGB:\r\n*r = transfer_rgb_to_adobergb(*r);\r\n*g = transfer_rgb_to_adobergb(*g);\r\n*b = transfer_rgb_to_adobergb(*b);\r\nbreak;\r\ncase V4L2_XFER_FUNC_DCI_P3:\r\n*r = transfer_rgb_to_dcip3(*r);\r\n*g = transfer_rgb_to_dcip3(*g);\r\n*b = transfer_rgb_to_dcip3(*b);\r\nbreak;\r\ncase V4L2_XFER_FUNC_SMPTE2084:\r\n*r = transfer_rgb_to_smpte2084(*r);\r\n*g = transfer_rgb_to_smpte2084(*g);\r\n*b = transfer_rgb_to_smpte2084(*b);\r\nbreak;\r\ncase V4L2_XFER_FUNC_SMPTE240M:\r\n*r = transfer_rgb_to_smpte240m(*r);\r\n*g = transfer_rgb_to_smpte240m(*g);\r\n*b = transfer_rgb_to_smpte240m(*b);\r\nbreak;\r\ncase V4L2_XFER_FUNC_NONE:\r\nbreak;\r\n}\r\n}\r\nint main(int argc, char **argv)\r\n{\r\nstatic const unsigned colorspaces[] = {\r\n0,\r\nV4L2_COLORSPACE_SMPTE170M,\r\nV4L2_COLORSPACE_SMPTE240M,\r\nV4L2_COLORSPACE_REC709,\r\n0,\r\nV4L2_COLORSPACE_470_SYSTEM_M,\r\nV4L2_COLORSPACE_470_SYSTEM_BG,\r\n0,\r\nV4L2_COLORSPACE_SRGB,\r\nV4L2_COLORSPACE_ADOBERGB,\r\nV4L2_COLORSPACE_BT2020,\r\n0,\r\nV4L2_COLORSPACE_DCI_P3,\r\n};\r\nstatic const char * const colorspace_names[] = {\r\n"",\r\n"V4L2_COLORSPACE_SMPTE170M",\r\n"V4L2_COLORSPACE_SMPTE240M",\r\n"V4L2_COLORSPACE_REC709",\r\n"",\r\n"V4L2_COLORSPACE_470_SYSTEM_M",\r\n"V4L2_COLORSPACE_470_SYSTEM_BG",\r\n"",\r\n"V4L2_COLORSPACE_SRGB",\r\n"V4L2_COLORSPACE_ADOBERGB",\r\n"V4L2_COLORSPACE_BT2020",\r\n"",\r\n"V4L2_COLORSPACE_DCI_P3",\r\n};\r\nstatic const char * const xfer_func_names[] = {\r\n"",\r\n"V4L2_XFER_FUNC_709",\r\n"V4L2_XFER_FUNC_SRGB",\r\n"V4L2_XFER_FUNC_ADOBERGB",\r\n"V4L2_XFER_FUNC_SMPTE240M",\r\n"V4L2_XFER_FUNC_NONE",\r\n"V4L2_XFER_FUNC_DCI_P3",\r\n"V4L2_XFER_FUNC_SMPTE2084",\r\n};\r\nint i;\r\nint x;\r\nint c;\r\nprintf("/* Generated table */\n");\r\nprintf("const unsigned short tpg_rec709_to_linear[255 * 16 + 1] = {");\r\nfor (i = 0; i <= 255 * 16; i++) {\r\nif (i % 16 == 0)\r\nprintf("\n\t");\r\nprintf("%4d,%s",\r\n(int)(0.5 + 16.0 * 255.0 *\r\ntransfer_rec709_to_rgb(i / (16.0 * 255.0))),\r\ni % 16 == 15 || i == 255 * 16 ? "" : " ");\r\n}\r\nprintf("\n};\n\n");\r\nprintf("/* Generated table */\n");\r\nprintf("const unsigned short tpg_linear_to_rec709[255 * 16 + 1] = {");\r\nfor (i = 0; i <= 255 * 16; i++) {\r\nif (i % 16 == 0)\r\nprintf("\n\t");\r\nprintf("%4d,%s",\r\n(int)(0.5 + 16.0 * 255.0 *\r\ntransfer_rgb_to_rec709(i / (16.0 * 255.0))),\r\ni % 16 == 15 || i == 255 * 16 ? "" : " ");\r\n}\r\nprintf("\n};\n\n");\r\nprintf("/* Generated table */\n");\r\nprintf("const struct color16 tpg_csc_colors[V4L2_COLORSPACE_DCI_P3 + 1][V4L2_XFER_FUNC_SMPTE2084 + 1][TPG_COLOR_CSC_BLACK + 1] = {\n");\r\nfor (c = 0; c <= V4L2_COLORSPACE_DCI_P3; c++) {\r\nfor (x = 1; x <= V4L2_XFER_FUNC_SMPTE2084; x++) {\r\nfor (i = 0; i <= TPG_COLOR_CSC_BLACK; i++) {\r\ndouble r, g, b;\r\nif (colorspaces[c] == 0)\r\ncontinue;\r\nr = tpg_colors[i].r / 255.0;\r\ng = tpg_colors[i].g / 255.0;\r\nb = tpg_colors[i].b / 255.0;\r\ncsc(c, x, &r, &g, &b);\r\nprintf("\t[%s][%s][%d] = { %d, %d, %d },\n",\r\ncolorspace_names[c],\r\nxfer_func_names[x], i,\r\n(int)(r * 4080), (int)(g * 4080), (int)(b * 4080));\r\n}\r\n}\r\n}\r\nprintf("};\n\n");\r\nreturn 0;\r\n}

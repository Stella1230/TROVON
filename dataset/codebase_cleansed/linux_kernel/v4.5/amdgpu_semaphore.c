int amdgpu_semaphore_create(struct amdgpu_device *adev,\r\nstruct amdgpu_semaphore **semaphore)\r\n{\r\nint r;\r\n*semaphore = kmalloc(sizeof(struct amdgpu_semaphore), GFP_KERNEL);\r\nif (*semaphore == NULL) {\r\nreturn -ENOMEM;\r\n}\r\nr = amdgpu_sa_bo_new(&adev->ring_tmp_bo,\r\n&(*semaphore)->sa_bo, 8, 8);\r\nif (r) {\r\nkfree(*semaphore);\r\n*semaphore = NULL;\r\nreturn r;\r\n}\r\n(*semaphore)->waiters = 0;\r\n(*semaphore)->gpu_addr = amdgpu_sa_bo_gpu_addr((*semaphore)->sa_bo);\r\n*((uint64_t *)amdgpu_sa_bo_cpu_addr((*semaphore)->sa_bo)) = 0;\r\nreturn 0;\r\n}\r\nbool amdgpu_semaphore_emit_signal(struct amdgpu_ring *ring,\r\nstruct amdgpu_semaphore *semaphore)\r\n{\r\ntrace_amdgpu_semaphore_signale(ring->idx, semaphore);\r\nif (amdgpu_ring_emit_semaphore(ring, semaphore, false)) {\r\n--semaphore->waiters;\r\nring->last_semaphore_signal_addr = semaphore->gpu_addr;\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nbool amdgpu_semaphore_emit_wait(struct amdgpu_ring *ring,\r\nstruct amdgpu_semaphore *semaphore)\r\n{\r\ntrace_amdgpu_semaphore_wait(ring->idx, semaphore);\r\nif (amdgpu_ring_emit_semaphore(ring, semaphore, true)) {\r\n++semaphore->waiters;\r\nring->last_semaphore_wait_addr = semaphore->gpu_addr;\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nvoid amdgpu_semaphore_free(struct amdgpu_device *adev,\r\nstruct amdgpu_semaphore **semaphore,\r\nstruct fence *fence)\r\n{\r\nif (semaphore == NULL || *semaphore == NULL) {\r\nreturn;\r\n}\r\nif ((*semaphore)->waiters > 0) {\r\ndev_err(adev->dev, "semaphore %p has more waiters than signalers,"\r\n" hardware lockup imminent!\n", *semaphore);\r\n}\r\namdgpu_sa_bo_free(adev, &(*semaphore)->sa_bo, fence);\r\nkfree(*semaphore);\r\n*semaphore = NULL;\r\n}

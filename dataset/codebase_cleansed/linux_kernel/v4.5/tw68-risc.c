static __le32 *tw68_risc_field(__le32 *rp, struct scatterlist *sglist,\r\nunsigned int offset, u32 sync_line,\r\nunsigned int bpl, unsigned int padding,\r\nunsigned int lines, bool jump)\r\n{\r\nstruct scatterlist *sg;\r\nunsigned int line, todo, done;\r\nif (jump) {\r\n*(rp++) = cpu_to_le32(RISC_JUMP);\r\n*(rp++) = 0;\r\n}\r\nif (sync_line == 1)\r\n*(rp++) = cpu_to_le32(RISC_SYNCO);\r\nelse\r\n*(rp++) = cpu_to_le32(RISC_SYNCE);\r\n*(rp++) = 0;\r\nsg = sglist;\r\nfor (line = 0; line < lines; line++) {\r\nwhile (offset && offset >= sg_dma_len(sg)) {\r\noffset -= sg_dma_len(sg);\r\nsg = sg_next(sg);\r\n}\r\nif (bpl <= sg_dma_len(sg) - offset) {\r\n*(rp++) = cpu_to_le32(RISC_LINESTART |\r\nbpl);\r\n*(rp++) = cpu_to_le32(sg_dma_address(sg) + offset);\r\noffset += bpl;\r\n} else {\r\ntodo = bpl;\r\ndone = (sg_dma_len(sg) - offset);\r\n*(rp++) = cpu_to_le32(RISC_LINESTART |\r\n(7 << 24) |\r\ndone);\r\n*(rp++) = cpu_to_le32(sg_dma_address(sg) + offset);\r\ntodo -= done;\r\nsg = sg_next(sg);\r\nwhile (todo > sg_dma_len(sg)) {\r\n*(rp++) = cpu_to_le32(RISC_INLINE |\r\n(done << 12) |\r\nsg_dma_len(sg));\r\n*(rp++) = cpu_to_le32(sg_dma_address(sg));\r\ntodo -= sg_dma_len(sg);\r\nsg = sg_next(sg);\r\ndone += sg_dma_len(sg);\r\n}\r\nif (todo) {\r\n*(rp++) = cpu_to_le32(RISC_INLINE |\r\n(done << 12) |\r\ntodo);\r\n*(rp++) = cpu_to_le32(sg_dma_address(sg));\r\n}\r\noffset = todo;\r\n}\r\noffset += padding;\r\n}\r\nreturn rp;\r\n}\r\nint tw68_risc_buffer(struct pci_dev *pci,\r\nstruct tw68_buf *buf,\r\nstruct scatterlist *sglist,\r\nunsigned int top_offset,\r\nunsigned int bottom_offset,\r\nunsigned int bpl,\r\nunsigned int padding,\r\nunsigned int lines)\r\n{\r\nu32 instructions, fields;\r\n__le32 *rp;\r\nfields = 0;\r\nif (UNSET != top_offset)\r\nfields++;\r\nif (UNSET != bottom_offset)\r\nfields++;\r\ninstructions = fields * (1 + (((bpl + padding) * lines) /\r\nPAGE_SIZE) + lines) + 4;\r\nbuf->size = instructions * 8;\r\nbuf->cpu = pci_alloc_consistent(pci, buf->size, &buf->dma);\r\nif (buf->cpu == NULL)\r\nreturn -ENOMEM;\r\nrp = buf->cpu;\r\nif (UNSET != top_offset)\r\nrp = tw68_risc_field(rp, sglist, top_offset, 1,\r\nbpl, padding, lines, true);\r\nif (UNSET != bottom_offset)\r\nrp = tw68_risc_field(rp, sglist, bottom_offset, 2,\r\nbpl, padding, lines, top_offset == UNSET);\r\nbuf->jmp = rp;\r\nbuf->cpu[1] = cpu_to_le32(buf->dma + 8);\r\nBUG_ON((buf->jmp - buf->cpu + 2) * sizeof(buf->cpu[0]) > buf->size);\r\nreturn 0;\r\n}

static void disable_timer(struct cs5535_mfgpt_timer *timer)\r\n{\r\ncs5535_mfgpt_write(timer, MFGPT_REG_SETUP,\r\n(uint16_t) ~MFGPT_SETUP_CNTEN | MFGPT_SETUP_CMP1 |\r\nMFGPT_SETUP_CMP2);\r\n}\r\nstatic void start_timer(struct cs5535_mfgpt_timer *timer, uint16_t delta)\r\n{\r\ncs5535_mfgpt_write(timer, MFGPT_REG_CMP2, delta);\r\ncs5535_mfgpt_write(timer, MFGPT_REG_COUNTER, 0);\r\ncs5535_mfgpt_write(timer, MFGPT_REG_SETUP,\r\nMFGPT_SETUP_CNTEN | MFGPT_SETUP_CMP2);\r\n}\r\nstatic int mfgpt_shutdown(struct clock_event_device *evt)\r\n{\r\ndisable_timer(cs5535_event_clock);\r\nreturn 0;\r\n}\r\nstatic int mfgpt_set_periodic(struct clock_event_device *evt)\r\n{\r\ndisable_timer(cs5535_event_clock);\r\nstart_timer(cs5535_event_clock, MFGPT_PERIODIC);\r\nreturn 0;\r\n}\r\nstatic int mfgpt_next_event(unsigned long delta, struct clock_event_device *evt)\r\n{\r\nstart_timer(cs5535_event_clock, delta);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t mfgpt_tick(int irq, void *dev_id)\r\n{\r\nuint16_t val = cs5535_mfgpt_read(cs5535_event_clock, MFGPT_REG_SETUP);\r\nif (!(val & (MFGPT_SETUP_SETUP | MFGPT_SETUP_CMP2 | MFGPT_SETUP_CMP1)))\r\nreturn IRQ_NONE;\r\ndisable_timer(cs5535_event_clock);\r\nif (clockevent_state_shutdown(&cs5535_clockevent))\r\nreturn IRQ_HANDLED;\r\ncs5535_mfgpt_write(cs5535_event_clock, MFGPT_REG_COUNTER, 0);\r\nif (clockevent_state_periodic(&cs5535_clockevent))\r\ncs5535_mfgpt_write(cs5535_event_clock, MFGPT_REG_SETUP,\r\nMFGPT_SETUP_CNTEN | MFGPT_SETUP_CMP2);\r\ncs5535_clockevent.event_handler(&cs5535_clockevent);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __init cs5535_mfgpt_init(void)\r\n{\r\nstruct cs5535_mfgpt_timer *timer;\r\nint ret;\r\nuint16_t val;\r\ntimer = cs5535_mfgpt_alloc_timer(MFGPT_TIMER_ANY, MFGPT_DOMAIN_WORKING);\r\nif (!timer) {\r\nprintk(KERN_ERR DRV_NAME ": Could not allocate MFGPT timer\n");\r\nreturn -ENODEV;\r\n}\r\ncs5535_event_clock = timer;\r\nif (cs5535_mfgpt_setup_irq(timer, MFGPT_CMP2, &timer_irq)) {\r\nprintk(KERN_ERR DRV_NAME ": Could not set up IRQ %d\n",\r\ntimer_irq);\r\ngoto err_timer;\r\n}\r\nret = setup_irq(timer_irq, &mfgptirq);\r\nif (ret) {\r\nprintk(KERN_ERR DRV_NAME ": Unable to set up the interrupt.\n");\r\ngoto err_irq;\r\n}\r\nval = MFGPT_SCALE | (3 << 8);\r\ncs5535_mfgpt_write(cs5535_event_clock, MFGPT_REG_SETUP, val);\r\nprintk(KERN_INFO DRV_NAME\r\n": Registering MFGPT timer as a clock event, using IRQ %d\n",\r\ntimer_irq);\r\nclockevents_config_and_register(&cs5535_clockevent, MFGPT_HZ,\r\n0xF, 0xFFFE);\r\nreturn 0;\r\nerr_irq:\r\ncs5535_mfgpt_release_irq(cs5535_event_clock, MFGPT_CMP2, &timer_irq);\r\nerr_timer:\r\ncs5535_mfgpt_free_timer(cs5535_event_clock);\r\nprintk(KERN_ERR DRV_NAME ": Unable to set up the MFGPT clock source\n");\r\nreturn -EIO;\r\n}

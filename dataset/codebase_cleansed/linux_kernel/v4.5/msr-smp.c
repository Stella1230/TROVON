static void __rdmsr_on_cpu(void *info)\r\n{\r\nstruct msr_info *rv = info;\r\nstruct msr *reg;\r\nint this_cpu = raw_smp_processor_id();\r\nif (rv->msrs)\r\nreg = per_cpu_ptr(rv->msrs, this_cpu);\r\nelse\r\nreg = &rv->reg;\r\nrdmsr(rv->msr_no, reg->l, reg->h);\r\n}\r\nstatic void __wrmsr_on_cpu(void *info)\r\n{\r\nstruct msr_info *rv = info;\r\nstruct msr *reg;\r\nint this_cpu = raw_smp_processor_id();\r\nif (rv->msrs)\r\nreg = per_cpu_ptr(rv->msrs, this_cpu);\r\nelse\r\nreg = &rv->reg;\r\nwrmsr(rv->msr_no, reg->l, reg->h);\r\n}\r\nint rdmsr_on_cpu(unsigned int cpu, u32 msr_no, u32 *l, u32 *h)\r\n{\r\nint err;\r\nstruct msr_info rv;\r\nmemset(&rv, 0, sizeof(rv));\r\nrv.msr_no = msr_no;\r\nerr = smp_call_function_single(cpu, __rdmsr_on_cpu, &rv, 1);\r\n*l = rv.reg.l;\r\n*h = rv.reg.h;\r\nreturn err;\r\n}\r\nint rdmsrl_on_cpu(unsigned int cpu, u32 msr_no, u64 *q)\r\n{\r\nint err;\r\nstruct msr_info rv;\r\nmemset(&rv, 0, sizeof(rv));\r\nrv.msr_no = msr_no;\r\nerr = smp_call_function_single(cpu, __rdmsr_on_cpu, &rv, 1);\r\n*q = rv.reg.q;\r\nreturn err;\r\n}\r\nint wrmsr_on_cpu(unsigned int cpu, u32 msr_no, u32 l, u32 h)\r\n{\r\nint err;\r\nstruct msr_info rv;\r\nmemset(&rv, 0, sizeof(rv));\r\nrv.msr_no = msr_no;\r\nrv.reg.l = l;\r\nrv.reg.h = h;\r\nerr = smp_call_function_single(cpu, __wrmsr_on_cpu, &rv, 1);\r\nreturn err;\r\n}\r\nint wrmsrl_on_cpu(unsigned int cpu, u32 msr_no, u64 q)\r\n{\r\nint err;\r\nstruct msr_info rv;\r\nmemset(&rv, 0, sizeof(rv));\r\nrv.msr_no = msr_no;\r\nrv.reg.q = q;\r\nerr = smp_call_function_single(cpu, __wrmsr_on_cpu, &rv, 1);\r\nreturn err;\r\n}\r\nstatic void __rwmsr_on_cpus(const struct cpumask *mask, u32 msr_no,\r\nstruct msr *msrs,\r\nvoid (*msr_func) (void *info))\r\n{\r\nstruct msr_info rv;\r\nint this_cpu;\r\nmemset(&rv, 0, sizeof(rv));\r\nrv.msrs = msrs;\r\nrv.msr_no = msr_no;\r\nthis_cpu = get_cpu();\r\nif (cpumask_test_cpu(this_cpu, mask))\r\nmsr_func(&rv);\r\nsmp_call_function_many(mask, msr_func, &rv, 1);\r\nput_cpu();\r\n}\r\nvoid rdmsr_on_cpus(const struct cpumask *mask, u32 msr_no, struct msr *msrs)\r\n{\r\n__rwmsr_on_cpus(mask, msr_no, msrs, __rdmsr_on_cpu);\r\n}\r\nvoid wrmsr_on_cpus(const struct cpumask *mask, u32 msr_no, struct msr *msrs)\r\n{\r\n__rwmsr_on_cpus(mask, msr_no, msrs, __wrmsr_on_cpu);\r\n}\r\nstatic void __rdmsr_safe_on_cpu(void *info)\r\n{\r\nstruct msr_info *rv = info;\r\nrv->err = rdmsr_safe(rv->msr_no, &rv->reg.l, &rv->reg.h);\r\n}\r\nstatic void __wrmsr_safe_on_cpu(void *info)\r\n{\r\nstruct msr_info *rv = info;\r\nrv->err = wrmsr_safe(rv->msr_no, rv->reg.l, rv->reg.h);\r\n}\r\nint rdmsr_safe_on_cpu(unsigned int cpu, u32 msr_no, u32 *l, u32 *h)\r\n{\r\nint err;\r\nstruct msr_info rv;\r\nmemset(&rv, 0, sizeof(rv));\r\nrv.msr_no = msr_no;\r\nerr = smp_call_function_single(cpu, __rdmsr_safe_on_cpu, &rv, 1);\r\n*l = rv.reg.l;\r\n*h = rv.reg.h;\r\nreturn err ? err : rv.err;\r\n}\r\nint wrmsr_safe_on_cpu(unsigned int cpu, u32 msr_no, u32 l, u32 h)\r\n{\r\nint err;\r\nstruct msr_info rv;\r\nmemset(&rv, 0, sizeof(rv));\r\nrv.msr_no = msr_no;\r\nrv.reg.l = l;\r\nrv.reg.h = h;\r\nerr = smp_call_function_single(cpu, __wrmsr_safe_on_cpu, &rv, 1);\r\nreturn err ? err : rv.err;\r\n}\r\nint wrmsrl_safe_on_cpu(unsigned int cpu, u32 msr_no, u64 q)\r\n{\r\nint err;\r\nstruct msr_info rv;\r\nmemset(&rv, 0, sizeof(rv));\r\nrv.msr_no = msr_no;\r\nrv.reg.q = q;\r\nerr = smp_call_function_single(cpu, __wrmsr_safe_on_cpu, &rv, 1);\r\nreturn err ? err : rv.err;\r\n}\r\nint rdmsrl_safe_on_cpu(unsigned int cpu, u32 msr_no, u64 *q)\r\n{\r\nint err;\r\nstruct msr_info rv;\r\nmemset(&rv, 0, sizeof(rv));\r\nrv.msr_no = msr_no;\r\nerr = smp_call_function_single(cpu, __rdmsr_safe_on_cpu, &rv, 1);\r\n*q = rv.reg.q;\r\nreturn err ? err : rv.err;\r\n}\r\nstatic void __rdmsr_safe_regs_on_cpu(void *info)\r\n{\r\nstruct msr_regs_info *rv = info;\r\nrv->err = rdmsr_safe_regs(rv->regs);\r\n}\r\nstatic void __wrmsr_safe_regs_on_cpu(void *info)\r\n{\r\nstruct msr_regs_info *rv = info;\r\nrv->err = wrmsr_safe_regs(rv->regs);\r\n}\r\nint rdmsr_safe_regs_on_cpu(unsigned int cpu, u32 *regs)\r\n{\r\nint err;\r\nstruct msr_regs_info rv;\r\nrv.regs = regs;\r\nrv.err = -EIO;\r\nerr = smp_call_function_single(cpu, __rdmsr_safe_regs_on_cpu, &rv, 1);\r\nreturn err ? err : rv.err;\r\n}\r\nint wrmsr_safe_regs_on_cpu(unsigned int cpu, u32 *regs)\r\n{\r\nint err;\r\nstruct msr_regs_info rv;\r\nrv.regs = regs;\r\nrv.err = -EIO;\r\nerr = smp_call_function_single(cpu, __wrmsr_safe_regs_on_cpu, &rv, 1);\r\nreturn err ? err : rv.err;\r\n}

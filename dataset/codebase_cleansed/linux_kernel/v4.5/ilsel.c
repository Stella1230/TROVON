static inline unsigned int ilsel_offset(unsigned int bit)\r\n{\r\nreturn ILSEL_LEVELS - bit - 1;\r\n}\r\nstatic inline unsigned long mk_ilsel_addr(unsigned int bit)\r\n{\r\nreturn ILSEL_BASE + ((ilsel_offset(bit) >> 1) & ~0x1);\r\n}\r\nstatic inline unsigned int mk_ilsel_shift(unsigned int bit)\r\n{\r\nreturn (ilsel_offset(bit) & 0x3) << 2;\r\n}\r\nstatic void __ilsel_enable(ilsel_source_t set, unsigned int bit)\r\n{\r\nunsigned int tmp, shift;\r\nunsigned long addr;\r\npr_notice("enabling ILSEL set %d\n", set);\r\naddr = mk_ilsel_addr(bit);\r\nshift = mk_ilsel_shift(bit);\r\npr_debug("%s: bit#%d: addr - 0x%08lx (shift %d, set %d)\n",\r\n__func__, bit, addr, shift, set);\r\ntmp = __raw_readw(addr);\r\ntmp &= ~(0xf << shift);\r\ntmp |= set << shift;\r\n__raw_writew(tmp, addr);\r\n}\r\nint ilsel_enable(ilsel_source_t set)\r\n{\r\nunsigned int bit;\r\nif (unlikely(set > ILSEL_KEY)) {\r\npr_err("Aliased sources must use ilsel_enable_fixed()\n");\r\nreturn -EINVAL;\r\n}\r\ndo {\r\nbit = find_first_zero_bit(&ilsel_level_map, ILSEL_LEVELS);\r\n} while (test_and_set_bit(bit, &ilsel_level_map));\r\n__ilsel_enable(set, bit);\r\nreturn bit;\r\n}\r\nint ilsel_enable_fixed(ilsel_source_t set, unsigned int level)\r\n{\r\nunsigned int bit = ilsel_offset(level - 1);\r\nif (test_and_set_bit(bit, &ilsel_level_map))\r\nreturn -EBUSY;\r\n__ilsel_enable(set, bit);\r\nreturn bit;\r\n}\r\nvoid ilsel_disable(unsigned int irq)\r\n{\r\nunsigned long addr;\r\nunsigned int tmp;\r\npr_notice("disabling ILSEL set %d\n", irq);\r\naddr = mk_ilsel_addr(irq);\r\ntmp = __raw_readw(addr);\r\ntmp &= ~(0xf << mk_ilsel_shift(irq));\r\n__raw_writew(tmp, addr);\r\nclear_bit(irq, &ilsel_level_map);\r\n}

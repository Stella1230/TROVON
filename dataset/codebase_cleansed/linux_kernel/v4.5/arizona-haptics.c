static void arizona_haptics_work(struct work_struct *work)\r\n{\r\nstruct arizona_haptics *haptics = container_of(work,\r\nstruct arizona_haptics,\r\nwork);\r\nstruct arizona *arizona = haptics->arizona;\r\nint ret;\r\nif (!haptics->arizona->dapm) {\r\ndev_err(arizona->dev, "No DAPM context\n");\r\nreturn;\r\n}\r\nif (haptics->intensity) {\r\nret = regmap_update_bits(arizona->regmap,\r\nARIZONA_HAPTICS_PHASE_2_INTENSITY,\r\nARIZONA_PHASE2_INTENSITY_MASK,\r\nhaptics->intensity);\r\nif (ret != 0) {\r\ndev_err(arizona->dev, "Failed to set intensity: %d\n",\r\nret);\r\nreturn;\r\n}\r\nret = regmap_update_bits(arizona->regmap,\r\nARIZONA_HAPTICS_CONTROL_1,\r\nARIZONA_HAP_CTRL_MASK,\r\n1 << ARIZONA_HAP_CTRL_SHIFT);\r\nif (ret != 0) {\r\ndev_err(arizona->dev, "Failed to start haptics: %d\n",\r\nret);\r\nreturn;\r\n}\r\nret = snd_soc_dapm_enable_pin(arizona->dapm, "HAPTICS");\r\nif (ret != 0) {\r\ndev_err(arizona->dev, "Failed to start HAPTICS: %d\n",\r\nret);\r\nreturn;\r\n}\r\nret = snd_soc_dapm_sync(arizona->dapm);\r\nif (ret != 0) {\r\ndev_err(arizona->dev, "Failed to sync DAPM: %d\n",\r\nret);\r\nreturn;\r\n}\r\n} else {\r\nret = snd_soc_dapm_disable_pin(arizona->dapm, "HAPTICS");\r\nif (ret != 0) {\r\ndev_err(arizona->dev, "Failed to disable HAPTICS: %d\n",\r\nret);\r\nreturn;\r\n}\r\nret = snd_soc_dapm_sync(arizona->dapm);\r\nif (ret != 0) {\r\ndev_err(arizona->dev, "Failed to sync DAPM: %d\n",\r\nret);\r\nreturn;\r\n}\r\nret = regmap_update_bits(arizona->regmap,\r\nARIZONA_HAPTICS_CONTROL_1,\r\nARIZONA_HAP_CTRL_MASK, 0);\r\nif (ret != 0) {\r\ndev_err(arizona->dev, "Failed to stop haptics: %d\n",\r\nret);\r\nreturn;\r\n}\r\n}\r\n}\r\nstatic int arizona_haptics_play(struct input_dev *input, void *data,\r\nstruct ff_effect *effect)\r\n{\r\nstruct arizona_haptics *haptics = input_get_drvdata(input);\r\nstruct arizona *arizona = haptics->arizona;\r\nif (!arizona->dapm) {\r\ndev_err(arizona->dev, "No DAPM context\n");\r\nreturn -EBUSY;\r\n}\r\nif (effect->u.rumble.strong_magnitude) {\r\nif (arizona->pdata.hap_act) {\r\nhaptics->intensity =\r\neffect->u.rumble.strong_magnitude >> 9;\r\nif (effect->direction < 0x8000)\r\nhaptics->intensity += 0x7f;\r\n} else {\r\nhaptics->intensity =\r\neffect->u.rumble.strong_magnitude >> 8;\r\n}\r\n} else {\r\nhaptics->intensity = 0;\r\n}\r\nschedule_work(&haptics->work);\r\nreturn 0;\r\n}\r\nstatic void arizona_haptics_close(struct input_dev *input)\r\n{\r\nstruct arizona_haptics *haptics = input_get_drvdata(input);\r\ncancel_work_sync(&haptics->work);\r\nif (haptics->arizona->dapm)\r\nsnd_soc_dapm_disable_pin(haptics->arizona->dapm, "HAPTICS");\r\n}\r\nstatic int arizona_haptics_probe(struct platform_device *pdev)\r\n{\r\nstruct arizona *arizona = dev_get_drvdata(pdev->dev.parent);\r\nstruct arizona_haptics *haptics;\r\nint ret;\r\nhaptics = devm_kzalloc(&pdev->dev, sizeof(*haptics), GFP_KERNEL);\r\nif (!haptics)\r\nreturn -ENOMEM;\r\nhaptics->arizona = arizona;\r\nret = regmap_update_bits(arizona->regmap, ARIZONA_HAPTICS_CONTROL_1,\r\nARIZONA_HAP_ACT, arizona->pdata.hap_act);\r\nif (ret != 0) {\r\ndev_err(arizona->dev, "Failed to set haptics actuator: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nINIT_WORK(&haptics->work, arizona_haptics_work);\r\nhaptics->input_dev = devm_input_allocate_device(&pdev->dev);\r\nif (!haptics->input_dev) {\r\ndev_err(arizona->dev, "Failed to allocate input device\n");\r\nreturn -ENOMEM;\r\n}\r\ninput_set_drvdata(haptics->input_dev, haptics);\r\nhaptics->input_dev->name = "arizona:haptics";\r\nhaptics->input_dev->dev.parent = pdev->dev.parent;\r\nhaptics->input_dev->close = arizona_haptics_close;\r\n__set_bit(FF_RUMBLE, haptics->input_dev->ffbit);\r\nret = input_ff_create_memless(haptics->input_dev, NULL,\r\narizona_haptics_play);\r\nif (ret < 0) {\r\ndev_err(arizona->dev, "input_ff_create_memless() failed: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nret = input_register_device(haptics->input_dev);\r\nif (ret < 0) {\r\ndev_err(arizona->dev, "couldn't register input device: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nplatform_set_drvdata(pdev, haptics);\r\nreturn 0;\r\n}

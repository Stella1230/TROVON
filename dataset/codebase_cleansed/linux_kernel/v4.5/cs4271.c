static bool cs4271_volatile_reg(struct device *dev, unsigned int reg)\r\n{\r\nreturn reg == CS4271_CHIPID;\r\n}\r\nstatic int cs4271_set_dai_sysclk(struct snd_soc_dai *codec_dai,\r\nint clk_id, unsigned int freq, int dir)\r\n{\r\nstruct snd_soc_codec *codec = codec_dai->codec;\r\nstruct cs4271_private *cs4271 = snd_soc_codec_get_drvdata(codec);\r\ncs4271->mclk = freq;\r\nreturn 0;\r\n}\r\nstatic int cs4271_set_dai_fmt(struct snd_soc_dai *codec_dai,\r\nunsigned int format)\r\n{\r\nstruct snd_soc_codec *codec = codec_dai->codec;\r\nstruct cs4271_private *cs4271 = snd_soc_codec_get_drvdata(codec);\r\nunsigned int val = 0;\r\nint ret;\r\nswitch (format & SND_SOC_DAIFMT_MASTER_MASK) {\r\ncase SND_SOC_DAIFMT_CBS_CFS:\r\ncs4271->master = 0;\r\nbreak;\r\ncase SND_SOC_DAIFMT_CBM_CFM:\r\ncs4271->master = 1;\r\nval |= CS4271_MODE1_MASTER;\r\nbreak;\r\ndefault:\r\ndev_err(codec->dev, "Invalid DAI format\n");\r\nreturn -EINVAL;\r\n}\r\nswitch (format & SND_SOC_DAIFMT_FORMAT_MASK) {\r\ncase SND_SOC_DAIFMT_LEFT_J:\r\nval |= CS4271_MODE1_DAC_DIF_LJ;\r\nret = regmap_update_bits(cs4271->regmap, CS4271_ADCCTL,\r\nCS4271_ADCCTL_ADC_DIF_MASK, CS4271_ADCCTL_ADC_DIF_LJ);\r\nif (ret < 0)\r\nreturn ret;\r\nbreak;\r\ncase SND_SOC_DAIFMT_I2S:\r\nval |= CS4271_MODE1_DAC_DIF_I2S;\r\nret = regmap_update_bits(cs4271->regmap, CS4271_ADCCTL,\r\nCS4271_ADCCTL_ADC_DIF_MASK, CS4271_ADCCTL_ADC_DIF_I2S);\r\nif (ret < 0)\r\nreturn ret;\r\nbreak;\r\ndefault:\r\ndev_err(codec->dev, "Invalid DAI format\n");\r\nreturn -EINVAL;\r\n}\r\nret = regmap_update_bits(cs4271->regmap, CS4271_MODE1,\r\nCS4271_MODE1_DAC_DIF_MASK | CS4271_MODE1_MASTER, val);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int cs4271_set_deemph(struct snd_soc_codec *codec)\r\n{\r\nstruct cs4271_private *cs4271 = snd_soc_codec_get_drvdata(codec);\r\nint i, ret;\r\nint val = CS4271_DACCTL_DEM_DIS;\r\nif (cs4271->deemph) {\r\nval = 1;\r\nfor (i = 2; i < ARRAY_SIZE(cs4271_deemph); i++)\r\nif (abs(cs4271_deemph[i] - cs4271->rate) <\r\nabs(cs4271_deemph[val] - cs4271->rate))\r\nval = i;\r\nval <<= 4;\r\n}\r\nret = regmap_update_bits(cs4271->regmap, CS4271_DACCTL,\r\nCS4271_DACCTL_DEM_MASK, val);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int cs4271_get_deemph(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_kcontrol_codec(kcontrol);\r\nstruct cs4271_private *cs4271 = snd_soc_codec_get_drvdata(codec);\r\nucontrol->value.integer.value[0] = cs4271->deemph;\r\nreturn 0;\r\n}\r\nstatic int cs4271_put_deemph(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_kcontrol_codec(kcontrol);\r\nstruct cs4271_private *cs4271 = snd_soc_codec_get_drvdata(codec);\r\ncs4271->deemph = ucontrol->value.integer.value[0];\r\nreturn cs4271_set_deemph(codec);\r\n}\r\nstatic int cs4271_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nstruct cs4271_private *cs4271 = snd_soc_codec_get_drvdata(codec);\r\nint i, ret;\r\nunsigned int ratio, val;\r\nif (cs4271->enable_soft_reset) {\r\nif ((substream->stream == SNDRV_PCM_STREAM_PLAYBACK &&\r\n!dai->capture_active) ||\r\n(substream->stream == SNDRV_PCM_STREAM_CAPTURE &&\r\n!dai->playback_active)) {\r\nret = regmap_update_bits(cs4271->regmap, CS4271_MODE2,\r\nCS4271_MODE2_PDN,\r\nCS4271_MODE2_PDN);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_update_bits(cs4271->regmap, CS4271_MODE2,\r\nCS4271_MODE2_PDN, 0);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\n}\r\ncs4271->rate = params_rate(params);\r\nif (cs4271->rate < 50000)\r\nval = CS4271_MODE1_MODE_1X;\r\nelse if (cs4271->rate < 100000)\r\nval = CS4271_MODE1_MODE_2X;\r\nelse\r\nval = CS4271_MODE1_MODE_4X;\r\nratio = cs4271->mclk / cs4271->rate;\r\nfor (i = 0; i < CS4171_NR_RATIOS; i++)\r\nif ((cs4271_clk_tab[i].master == cs4271->master) &&\r\n(cs4271_clk_tab[i].speed_mode == val) &&\r\n(cs4271_clk_tab[i].ratio == ratio))\r\nbreak;\r\nif (i == CS4171_NR_RATIOS) {\r\ndev_err(codec->dev, "Invalid sample rate\n");\r\nreturn -EINVAL;\r\n}\r\nval |= cs4271_clk_tab[i].ratio_mask;\r\nret = regmap_update_bits(cs4271->regmap, CS4271_MODE1,\r\nCS4271_MODE1_MODE_MASK | CS4271_MODE1_DIV_MASK, val);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn cs4271_set_deemph(codec);\r\n}\r\nstatic int cs4271_mute_stream(struct snd_soc_dai *dai, int mute, int stream)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nstruct cs4271_private *cs4271 = snd_soc_codec_get_drvdata(codec);\r\nint ret;\r\nint val_a = 0;\r\nint val_b = 0;\r\nif (stream != SNDRV_PCM_STREAM_PLAYBACK)\r\nreturn 0;\r\nif (mute) {\r\nval_a = CS4271_VOLA_MUTE;\r\nval_b = CS4271_VOLB_MUTE;\r\n}\r\nret = regmap_update_bits(cs4271->regmap, CS4271_VOLA,\r\nCS4271_VOLA_MUTE, val_a);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_update_bits(cs4271->regmap, CS4271_VOLB,\r\nCS4271_VOLB_MUTE, val_b);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int cs4271_soc_suspend(struct snd_soc_codec *codec)\r\n{\r\nint ret;\r\nstruct cs4271_private *cs4271 = snd_soc_codec_get_drvdata(codec);\r\nret = regmap_update_bits(cs4271->regmap, CS4271_MODE2,\r\nCS4271_MODE2_PDN, CS4271_MODE2_PDN);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int cs4271_soc_resume(struct snd_soc_codec *codec)\r\n{\r\nint ret;\r\nstruct cs4271_private *cs4271 = snd_soc_codec_get_drvdata(codec);\r\nret = regcache_sync(cs4271->regmap);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_update_bits(cs4271->regmap, CS4271_MODE2,\r\nCS4271_MODE2_PDN, 0);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int cs4271_codec_probe(struct snd_soc_codec *codec)\r\n{\r\nstruct cs4271_private *cs4271 = snd_soc_codec_get_drvdata(codec);\r\nstruct cs4271_platform_data *cs4271plat = codec->dev->platform_data;\r\nint ret;\r\nbool amutec_eq_bmutec = false;\r\n#ifdef CONFIG_OF\r\nif (of_match_device(cs4271_dt_ids, codec->dev)) {\r\nif (of_get_property(codec->dev->of_node,\r\n"cirrus,amutec-eq-bmutec", NULL))\r\namutec_eq_bmutec = true;\r\nif (of_get_property(codec->dev->of_node,\r\n"cirrus,enable-soft-reset", NULL))\r\ncs4271->enable_soft_reset = true;\r\n}\r\n#endif\r\nif (cs4271plat) {\r\namutec_eq_bmutec = cs4271plat->amutec_eq_bmutec;\r\ncs4271->enable_soft_reset = cs4271plat->enable_soft_reset;\r\n}\r\nif (gpio_is_valid(cs4271->gpio_nreset)) {\r\ngpio_direction_output(cs4271->gpio_nreset, 0);\r\nmdelay(1);\r\ngpio_set_value(cs4271->gpio_nreset, 1);\r\nmdelay(1);\r\n}\r\nret = regmap_update_bits(cs4271->regmap, CS4271_MODE2,\r\nCS4271_MODE2_PDN | CS4271_MODE2_CPEN,\r\nCS4271_MODE2_PDN | CS4271_MODE2_CPEN);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_update_bits(cs4271->regmap, CS4271_MODE2,\r\nCS4271_MODE2_PDN, 0);\r\nif (ret < 0)\r\nreturn ret;\r\nudelay(85);\r\nif (amutec_eq_bmutec)\r\nregmap_update_bits(cs4271->regmap, CS4271_MODE2,\r\nCS4271_MODE2_MUTECAEQUB,\r\nCS4271_MODE2_MUTECAEQUB);\r\nreturn 0;\r\n}\r\nstatic int cs4271_codec_remove(struct snd_soc_codec *codec)\r\n{\r\nstruct cs4271_private *cs4271 = snd_soc_codec_get_drvdata(codec);\r\nif (gpio_is_valid(cs4271->gpio_nreset))\r\ngpio_set_value(cs4271->gpio_nreset, 0);\r\nreturn 0;\r\n}\r\nstatic int cs4271_common_probe(struct device *dev,\r\nstruct cs4271_private **c)\r\n{\r\nstruct cs4271_platform_data *cs4271plat = dev->platform_data;\r\nstruct cs4271_private *cs4271;\r\ncs4271 = devm_kzalloc(dev, sizeof(*cs4271), GFP_KERNEL);\r\nif (!cs4271)\r\nreturn -ENOMEM;\r\nif (of_match_device(cs4271_dt_ids, dev))\r\ncs4271->gpio_nreset =\r\nof_get_named_gpio(dev->of_node, "reset-gpio", 0);\r\nif (cs4271plat)\r\ncs4271->gpio_nreset = cs4271plat->gpio_nreset;\r\nif (gpio_is_valid(cs4271->gpio_nreset)) {\r\nint ret;\r\nret = devm_gpio_request(dev, cs4271->gpio_nreset,\r\n"CS4271 Reset");\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\n*c = cs4271;\r\nreturn 0;\r\n}\r\nint cs4271_probe(struct device *dev, struct regmap *regmap)\r\n{\r\nstruct cs4271_private *cs4271;\r\nint ret;\r\nif (IS_ERR(regmap))\r\nreturn PTR_ERR(regmap);\r\nret = cs4271_common_probe(dev, &cs4271);\r\nif (ret < 0)\r\nreturn ret;\r\ndev_set_drvdata(dev, cs4271);\r\ncs4271->regmap = regmap;\r\nreturn snd_soc_register_codec(dev, &soc_codec_dev_cs4271, &cs4271_dai,\r\n1);\r\n}

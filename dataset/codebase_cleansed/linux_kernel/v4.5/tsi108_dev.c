phys_addr_t get_csrbase(void)\r\n{\r\nstruct device_node *tsi;\r\nif (tsi108_csr_base != -1)\r\nreturn tsi108_csr_base;\r\ntsi = of_find_node_by_type(NULL, "tsi-bridge");\r\nif (tsi) {\r\nunsigned int size;\r\nconst void *prop = of_get_property(tsi, "reg", &size);\r\ntsi108_csr_base = of_translate_address(tsi, prop);\r\nof_node_put(tsi);\r\n};\r\nreturn tsi108_csr_base;\r\n}\r\nu32 get_vir_csrbase(void)\r\n{\r\nreturn (u32) (ioremap(get_csrbase(), 0x10000));\r\n}\r\nstatic int __init tsi108_eth_of_init(void)\r\n{\r\nstruct device_node *np;\r\nunsigned int i = 0;\r\nstruct platform_device *tsi_eth_dev;\r\nstruct resource res;\r\nint ret;\r\nfor_each_compatible_node(np, "network", "tsi108-ethernet") {\r\nstruct resource r[2];\r\nstruct device_node *phy, *mdio;\r\nhw_info tsi_eth_data;\r\nconst unsigned int *phy_id;\r\nconst void *mac_addr;\r\nconst phandle *ph;\r\nmemset(r, 0, sizeof(r));\r\nmemset(&tsi_eth_data, 0, sizeof(tsi_eth_data));\r\nret = of_address_to_resource(np, 0, &r[0]);\r\nDBG("%s: name:start->end = %s:%pR\n",\r\n__func__, r[0].name, &r[0]);\r\nif (ret)\r\ngoto err;\r\nr[1].name = "tx";\r\nr[1].start = irq_of_parse_and_map(np, 0);\r\nr[1].end = irq_of_parse_and_map(np, 0);\r\nr[1].flags = IORESOURCE_IRQ;\r\nDBG("%s: name:start->end = %s:%pR\n",\r\n__func__, r[1].name, &r[1]);\r\ntsi_eth_dev =\r\nplatform_device_register_simple("tsi-ethernet", i++, &r[0],\r\n1);\r\nif (IS_ERR(tsi_eth_dev)) {\r\nret = PTR_ERR(tsi_eth_dev);\r\ngoto err;\r\n}\r\nmac_addr = of_get_mac_address(np);\r\nif (mac_addr)\r\nmemcpy(tsi_eth_data.mac_addr, mac_addr, 6);\r\nph = of_get_property(np, "mdio-handle", NULL);\r\nmdio = of_find_node_by_phandle(*ph);\r\nret = of_address_to_resource(mdio, 0, &res);\r\nof_node_put(mdio);\r\nif (ret)\r\ngoto unreg;\r\nph = of_get_property(np, "phy-handle", NULL);\r\nphy = of_find_node_by_phandle(*ph);\r\nif (phy == NULL) {\r\nret = -ENODEV;\r\ngoto unreg;\r\n}\r\nphy_id = of_get_property(phy, "reg", NULL);\r\ntsi_eth_data.regs = r[0].start;\r\ntsi_eth_data.phyregs = res.start;\r\ntsi_eth_data.phy = *phy_id;\r\ntsi_eth_data.irq_num = irq_of_parse_and_map(np, 0);\r\nif (of_get_property(phy, "txc-rxc-delay-disable", NULL))\r\ntsi_eth_data.phy_type = TSI108_PHY_BCM54XX;\r\nof_node_put(phy);\r\nret =\r\nplatform_device_add_data(tsi_eth_dev, &tsi_eth_data,\r\nsizeof(hw_info));\r\nif (ret)\r\ngoto unreg;\r\n}\r\nreturn 0;\r\nunreg:\r\nplatform_device_unregister(tsi_eth_dev);\r\nerr:\r\nof_node_put(np);\r\nreturn ret;\r\n}

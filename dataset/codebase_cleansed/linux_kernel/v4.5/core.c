static int nxp_nci_open(struct nci_dev *ndev)\r\n{\r\nstruct nxp_nci_info *info = nci_get_drvdata(ndev);\r\nint r = 0;\r\nmutex_lock(&info->info_lock);\r\nif (info->mode != NXP_NCI_MODE_COLD) {\r\nr = -EBUSY;\r\ngoto open_exit;\r\n}\r\nif (info->phy_ops->set_mode)\r\nr = info->phy_ops->set_mode(info->phy_id, NXP_NCI_MODE_NCI);\r\ninfo->mode = NXP_NCI_MODE_NCI;\r\nopen_exit:\r\nmutex_unlock(&info->info_lock);\r\nreturn r;\r\n}\r\nstatic int nxp_nci_close(struct nci_dev *ndev)\r\n{\r\nstruct nxp_nci_info *info = nci_get_drvdata(ndev);\r\nint r = 0;\r\nmutex_lock(&info->info_lock);\r\nif (info->phy_ops->set_mode)\r\nr = info->phy_ops->set_mode(info->phy_id, NXP_NCI_MODE_COLD);\r\ninfo->mode = NXP_NCI_MODE_COLD;\r\nmutex_unlock(&info->info_lock);\r\nreturn r;\r\n}\r\nstatic int nxp_nci_send(struct nci_dev *ndev, struct sk_buff *skb)\r\n{\r\nstruct nxp_nci_info *info = nci_get_drvdata(ndev);\r\nint r;\r\nif (!info->phy_ops->write) {\r\nr = -ENOTSUPP;\r\ngoto send_exit;\r\n}\r\nif (info->mode != NXP_NCI_MODE_NCI) {\r\nr = -EINVAL;\r\ngoto send_exit;\r\n}\r\nr = info->phy_ops->write(info->phy_id, skb);\r\nif (r < 0)\r\nkfree_skb(skb);\r\nsend_exit:\r\nreturn r;\r\n}\r\nint nxp_nci_probe(void *phy_id, struct device *pdev,\r\nconst struct nxp_nci_phy_ops *phy_ops,\r\nunsigned int max_payload,\r\nstruct nci_dev **ndev)\r\n{\r\nstruct nxp_nci_info *info;\r\nint r;\r\ninfo = devm_kzalloc(pdev, sizeof(struct nxp_nci_info), GFP_KERNEL);\r\nif (!info) {\r\nr = -ENOMEM;\r\ngoto probe_exit;\r\n}\r\ninfo->phy_id = phy_id;\r\ninfo->pdev = pdev;\r\ninfo->phy_ops = phy_ops;\r\ninfo->max_payload = max_payload;\r\nINIT_WORK(&info->fw_info.work, nxp_nci_fw_work);\r\ninit_completion(&info->fw_info.cmd_completion);\r\nmutex_init(&info->info_lock);\r\nif (info->phy_ops->set_mode) {\r\nr = info->phy_ops->set_mode(info->phy_id, NXP_NCI_MODE_COLD);\r\nif (r < 0)\r\ngoto probe_exit;\r\n}\r\ninfo->mode = NXP_NCI_MODE_COLD;\r\ninfo->ndev = nci_allocate_device(&nxp_nci_ops, NXP_NCI_NFC_PROTOCOLS,\r\nNXP_NCI_HDR_LEN, 0);\r\nif (!info->ndev) {\r\nr = -ENOMEM;\r\ngoto probe_exit;\r\n}\r\nnci_set_parent_dev(info->ndev, pdev);\r\nnci_set_drvdata(info->ndev, info);\r\nr = nci_register_device(info->ndev);\r\nif (r < 0)\r\ngoto probe_exit_free_nci;\r\n*ndev = info->ndev;\r\ngoto probe_exit;\r\nprobe_exit_free_nci:\r\nnci_free_device(info->ndev);\r\nprobe_exit:\r\nreturn r;\r\n}\r\nvoid nxp_nci_remove(struct nci_dev *ndev)\r\n{\r\nstruct nxp_nci_info *info = nci_get_drvdata(ndev);\r\nif (info->mode == NXP_NCI_MODE_FW)\r\nnxp_nci_fw_work_complete(info, -ESHUTDOWN);\r\ncancel_work_sync(&info->fw_info.work);\r\nmutex_lock(&info->info_lock);\r\nif (info->phy_ops->set_mode)\r\ninfo->phy_ops->set_mode(info->phy_id, NXP_NCI_MODE_COLD);\r\nnci_unregister_device(ndev);\r\nnci_free_device(ndev);\r\nmutex_unlock(&info->info_lock);\r\n}

int regulator_is_enabled_regmap(struct regulator_dev *rdev)\r\n{\r\nunsigned int val;\r\nint ret;\r\nret = regmap_read(rdev->regmap, rdev->desc->enable_reg, &val);\r\nif (ret != 0)\r\nreturn ret;\r\nval &= rdev->desc->enable_mask;\r\nif (rdev->desc->enable_is_inverted) {\r\nif (rdev->desc->enable_val)\r\nreturn val != rdev->desc->enable_val;\r\nreturn val == 0;\r\n} else {\r\nif (rdev->desc->enable_val)\r\nreturn val == rdev->desc->enable_val;\r\nreturn val != 0;\r\n}\r\n}\r\nint regulator_enable_regmap(struct regulator_dev *rdev)\r\n{\r\nunsigned int val;\r\nif (rdev->desc->enable_is_inverted) {\r\nval = rdev->desc->disable_val;\r\n} else {\r\nval = rdev->desc->enable_val;\r\nif (!val)\r\nval = rdev->desc->enable_mask;\r\n}\r\nreturn regmap_update_bits(rdev->regmap, rdev->desc->enable_reg,\r\nrdev->desc->enable_mask, val);\r\n}\r\nint regulator_disable_regmap(struct regulator_dev *rdev)\r\n{\r\nunsigned int val;\r\nif (rdev->desc->enable_is_inverted) {\r\nval = rdev->desc->enable_val;\r\nif (!val)\r\nval = rdev->desc->enable_mask;\r\n} else {\r\nval = rdev->desc->disable_val;\r\n}\r\nreturn regmap_update_bits(rdev->regmap, rdev->desc->enable_reg,\r\nrdev->desc->enable_mask, val);\r\n}\r\nint regulator_get_voltage_sel_regmap(struct regulator_dev *rdev)\r\n{\r\nunsigned int val;\r\nint ret;\r\nret = regmap_read(rdev->regmap, rdev->desc->vsel_reg, &val);\r\nif (ret != 0)\r\nreturn ret;\r\nval &= rdev->desc->vsel_mask;\r\nval >>= ffs(rdev->desc->vsel_mask) - 1;\r\nreturn val;\r\n}\r\nint regulator_set_voltage_sel_regmap(struct regulator_dev *rdev, unsigned sel)\r\n{\r\nint ret;\r\nsel <<= ffs(rdev->desc->vsel_mask) - 1;\r\nret = regmap_update_bits(rdev->regmap, rdev->desc->vsel_reg,\r\nrdev->desc->vsel_mask, sel);\r\nif (ret)\r\nreturn ret;\r\nif (rdev->desc->apply_bit)\r\nret = regmap_update_bits(rdev->regmap, rdev->desc->apply_reg,\r\nrdev->desc->apply_bit,\r\nrdev->desc->apply_bit);\r\nreturn ret;\r\n}\r\nint regulator_map_voltage_iterate(struct regulator_dev *rdev,\r\nint min_uV, int max_uV)\r\n{\r\nint best_val = INT_MAX;\r\nint selector = 0;\r\nint i, ret;\r\nfor (i = 0; i < rdev->desc->n_voltages; i++) {\r\nret = rdev->desc->ops->list_voltage(rdev, i);\r\nif (ret < 0)\r\ncontinue;\r\nif (ret < best_val && ret >= min_uV && ret <= max_uV) {\r\nbest_val = ret;\r\nselector = i;\r\n}\r\n}\r\nif (best_val != INT_MAX)\r\nreturn selector;\r\nelse\r\nreturn -EINVAL;\r\n}\r\nint regulator_map_voltage_ascend(struct regulator_dev *rdev,\r\nint min_uV, int max_uV)\r\n{\r\nint i, ret;\r\nfor (i = 0; i < rdev->desc->n_voltages; i++) {\r\nret = rdev->desc->ops->list_voltage(rdev, i);\r\nif (ret < 0)\r\ncontinue;\r\nif (ret > max_uV)\r\nbreak;\r\nif (ret >= min_uV && ret <= max_uV)\r\nreturn i;\r\n}\r\nreturn -EINVAL;\r\n}\r\nint regulator_map_voltage_linear(struct regulator_dev *rdev,\r\nint min_uV, int max_uV)\r\n{\r\nint ret, voltage;\r\nif (rdev->desc->n_voltages == 1 && rdev->desc->uV_step == 0) {\r\nif (min_uV <= rdev->desc->min_uV && rdev->desc->min_uV <= max_uV)\r\nreturn 0;\r\nelse\r\nreturn -EINVAL;\r\n}\r\nif (!rdev->desc->uV_step) {\r\nBUG_ON(!rdev->desc->uV_step);\r\nreturn -EINVAL;\r\n}\r\nif (min_uV < rdev->desc->min_uV)\r\nmin_uV = rdev->desc->min_uV;\r\nret = DIV_ROUND_UP(min_uV - rdev->desc->min_uV, rdev->desc->uV_step);\r\nif (ret < 0)\r\nreturn ret;\r\nret += rdev->desc->linear_min_sel;\r\nvoltage = rdev->desc->ops->list_voltage(rdev, ret);\r\nif (voltage < min_uV || voltage > max_uV)\r\nreturn -EINVAL;\r\nreturn ret;\r\n}\r\nint regulator_map_voltage_linear_range(struct regulator_dev *rdev,\r\nint min_uV, int max_uV)\r\n{\r\nconst struct regulator_linear_range *range;\r\nint ret = -EINVAL;\r\nint voltage, i;\r\nif (!rdev->desc->n_linear_ranges) {\r\nBUG_ON(!rdev->desc->n_linear_ranges);\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; i < rdev->desc->n_linear_ranges; i++) {\r\nint linear_max_uV;\r\nrange = &rdev->desc->linear_ranges[i];\r\nlinear_max_uV = range->min_uV +\r\n(range->max_sel - range->min_sel) * range->uV_step;\r\nif (!(min_uV <= linear_max_uV && max_uV >= range->min_uV))\r\ncontinue;\r\nif (min_uV <= range->min_uV)\r\nmin_uV = range->min_uV;\r\nif (range->uV_step == 0) {\r\nret = 0;\r\n} else {\r\nret = DIV_ROUND_UP(min_uV - range->min_uV,\r\nrange->uV_step);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nret += range->min_sel;\r\nbreak;\r\n}\r\nif (i == rdev->desc->n_linear_ranges)\r\nreturn -EINVAL;\r\nvoltage = rdev->desc->ops->list_voltage(rdev, ret);\r\nif (voltage < min_uV || voltage > max_uV)\r\nreturn -EINVAL;\r\nreturn ret;\r\n}\r\nint regulator_list_voltage_linear(struct regulator_dev *rdev,\r\nunsigned int selector)\r\n{\r\nif (selector >= rdev->desc->n_voltages)\r\nreturn -EINVAL;\r\nif (selector < rdev->desc->linear_min_sel)\r\nreturn 0;\r\nselector -= rdev->desc->linear_min_sel;\r\nreturn rdev->desc->min_uV + (rdev->desc->uV_step * selector);\r\n}\r\nint regulator_list_voltage_linear_range(struct regulator_dev *rdev,\r\nunsigned int selector)\r\n{\r\nconst struct regulator_linear_range *range;\r\nint i;\r\nif (!rdev->desc->n_linear_ranges) {\r\nBUG_ON(!rdev->desc->n_linear_ranges);\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; i < rdev->desc->n_linear_ranges; i++) {\r\nrange = &rdev->desc->linear_ranges[i];\r\nif (!(selector >= range->min_sel &&\r\nselector <= range->max_sel))\r\ncontinue;\r\nselector -= range->min_sel;\r\nreturn range->min_uV + (range->uV_step * selector);\r\n}\r\nreturn -EINVAL;\r\n}\r\nint regulator_list_voltage_table(struct regulator_dev *rdev,\r\nunsigned int selector)\r\n{\r\nif (!rdev->desc->volt_table) {\r\nBUG_ON(!rdev->desc->volt_table);\r\nreturn -EINVAL;\r\n}\r\nif (selector >= rdev->desc->n_voltages)\r\nreturn -EINVAL;\r\nreturn rdev->desc->volt_table[selector];\r\n}\r\nint regulator_set_bypass_regmap(struct regulator_dev *rdev, bool enable)\r\n{\r\nunsigned int val;\r\nif (enable) {\r\nval = rdev->desc->bypass_val_on;\r\nif (!val)\r\nval = rdev->desc->bypass_mask;\r\n} else {\r\nval = rdev->desc->bypass_val_off;\r\n}\r\nreturn regmap_update_bits(rdev->regmap, rdev->desc->bypass_reg,\r\nrdev->desc->bypass_mask, val);\r\n}\r\nint regulator_get_bypass_regmap(struct regulator_dev *rdev, bool *enable)\r\n{\r\nunsigned int val;\r\nint ret;\r\nret = regmap_read(rdev->regmap, rdev->desc->bypass_reg, &val);\r\nif (ret != 0)\r\nreturn ret;\r\n*enable = val & rdev->desc->bypass_mask;\r\nreturn 0;\r\n}

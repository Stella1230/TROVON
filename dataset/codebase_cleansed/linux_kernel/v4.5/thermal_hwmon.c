static ssize_t\r\nname_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct thermal_hwmon_device *hwmon = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%s\n", hwmon->type);\r\n}\r\nstatic ssize_t\r\ntemp_input_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nint temperature;\r\nint ret;\r\nstruct thermal_hwmon_attr *hwmon_attr\r\n= container_of(attr, struct thermal_hwmon_attr, attr);\r\nstruct thermal_hwmon_temp *temp\r\n= container_of(hwmon_attr, struct thermal_hwmon_temp,\r\ntemp_input);\r\nstruct thermal_zone_device *tz = temp->tz;\r\nret = thermal_zone_get_temp(tz, &temperature);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, "%d\n", temperature);\r\n}\r\nstatic ssize_t\r\ntemp_crit_show(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct thermal_hwmon_attr *hwmon_attr\r\n= container_of(attr, struct thermal_hwmon_attr, attr);\r\nstruct thermal_hwmon_temp *temp\r\n= container_of(hwmon_attr, struct thermal_hwmon_temp,\r\ntemp_crit);\r\nstruct thermal_zone_device *tz = temp->tz;\r\nint temperature;\r\nint ret;\r\nret = tz->ops->get_trip_temp(tz, 0, &temperature);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, "%d\n", temperature);\r\n}\r\nstatic struct thermal_hwmon_device *\r\nthermal_hwmon_lookup_by_type(const struct thermal_zone_device *tz)\r\n{\r\nstruct thermal_hwmon_device *hwmon;\r\nmutex_lock(&thermal_hwmon_list_lock);\r\nlist_for_each_entry(hwmon, &thermal_hwmon_list, node)\r\nif (!strcmp(hwmon->type, tz->type)) {\r\nmutex_unlock(&thermal_hwmon_list_lock);\r\nreturn hwmon;\r\n}\r\nmutex_unlock(&thermal_hwmon_list_lock);\r\nreturn NULL;\r\n}\r\nstatic struct thermal_hwmon_temp *\r\nthermal_hwmon_lookup_temp(const struct thermal_hwmon_device *hwmon,\r\nconst struct thermal_zone_device *tz)\r\n{\r\nstruct thermal_hwmon_temp *temp;\r\nmutex_lock(&thermal_hwmon_list_lock);\r\nlist_for_each_entry(temp, &hwmon->tz_list, hwmon_node)\r\nif (temp->tz == tz) {\r\nmutex_unlock(&thermal_hwmon_list_lock);\r\nreturn temp;\r\n}\r\nmutex_unlock(&thermal_hwmon_list_lock);\r\nreturn NULL;\r\n}\r\nstatic bool thermal_zone_crit_temp_valid(struct thermal_zone_device *tz)\r\n{\r\nint temp;\r\nreturn tz->ops->get_crit_temp && !tz->ops->get_crit_temp(tz, &temp);\r\n}\r\nint thermal_add_hwmon_sysfs(struct thermal_zone_device *tz)\r\n{\r\nstruct thermal_hwmon_device *hwmon;\r\nstruct thermal_hwmon_temp *temp;\r\nint new_hwmon_device = 1;\r\nint result;\r\nhwmon = thermal_hwmon_lookup_by_type(tz);\r\nif (hwmon) {\r\nnew_hwmon_device = 0;\r\ngoto register_sys_interface;\r\n}\r\nhwmon = kzalloc(sizeof(*hwmon), GFP_KERNEL);\r\nif (!hwmon)\r\nreturn -ENOMEM;\r\nINIT_LIST_HEAD(&hwmon->tz_list);\r\nstrlcpy(hwmon->type, tz->type, THERMAL_NAME_LENGTH);\r\nhwmon->device = hwmon_device_register(NULL);\r\nif (IS_ERR(hwmon->device)) {\r\nresult = PTR_ERR(hwmon->device);\r\ngoto free_mem;\r\n}\r\ndev_set_drvdata(hwmon->device, hwmon);\r\nresult = device_create_file(hwmon->device, &dev_attr_name);\r\nif (result)\r\ngoto free_mem;\r\nregister_sys_interface:\r\ntemp = kzalloc(sizeof(*temp), GFP_KERNEL);\r\nif (!temp) {\r\nresult = -ENOMEM;\r\ngoto unregister_name;\r\n}\r\ntemp->tz = tz;\r\nhwmon->count++;\r\nsnprintf(temp->temp_input.name, sizeof(temp->temp_input.name),\r\n"temp%d_input", hwmon->count);\r\ntemp->temp_input.attr.attr.name = temp->temp_input.name;\r\ntemp->temp_input.attr.attr.mode = 0444;\r\ntemp->temp_input.attr.show = temp_input_show;\r\nsysfs_attr_init(&temp->temp_input.attr.attr);\r\nresult = device_create_file(hwmon->device, &temp->temp_input.attr);\r\nif (result)\r\ngoto free_temp_mem;\r\nif (thermal_zone_crit_temp_valid(tz)) {\r\nsnprintf(temp->temp_crit.name,\r\nsizeof(temp->temp_crit.name),\r\n"temp%d_crit", hwmon->count);\r\ntemp->temp_crit.attr.attr.name = temp->temp_crit.name;\r\ntemp->temp_crit.attr.attr.mode = 0444;\r\ntemp->temp_crit.attr.show = temp_crit_show;\r\nsysfs_attr_init(&temp->temp_crit.attr.attr);\r\nresult = device_create_file(hwmon->device,\r\n&temp->temp_crit.attr);\r\nif (result)\r\ngoto unregister_input;\r\n}\r\nmutex_lock(&thermal_hwmon_list_lock);\r\nif (new_hwmon_device)\r\nlist_add_tail(&hwmon->node, &thermal_hwmon_list);\r\nlist_add_tail(&temp->hwmon_node, &hwmon->tz_list);\r\nmutex_unlock(&thermal_hwmon_list_lock);\r\nreturn 0;\r\nunregister_input:\r\ndevice_remove_file(hwmon->device, &temp->temp_input.attr);\r\nfree_temp_mem:\r\nkfree(temp);\r\nunregister_name:\r\nif (new_hwmon_device) {\r\ndevice_remove_file(hwmon->device, &dev_attr_name);\r\nhwmon_device_unregister(hwmon->device);\r\n}\r\nfree_mem:\r\nif (new_hwmon_device)\r\nkfree(hwmon);\r\nreturn result;\r\n}\r\nvoid thermal_remove_hwmon_sysfs(struct thermal_zone_device *tz)\r\n{\r\nstruct thermal_hwmon_device *hwmon;\r\nstruct thermal_hwmon_temp *temp;\r\nhwmon = thermal_hwmon_lookup_by_type(tz);\r\nif (unlikely(!hwmon)) {\r\ndev_dbg(&tz->device, "hwmon device lookup failed!\n");\r\nreturn;\r\n}\r\ntemp = thermal_hwmon_lookup_temp(hwmon, tz);\r\nif (unlikely(!temp)) {\r\ndev_dbg(&tz->device, "temperature input lookup failed!\n");\r\nreturn;\r\n}\r\ndevice_remove_file(hwmon->device, &temp->temp_input.attr);\r\nif (thermal_zone_crit_temp_valid(tz))\r\ndevice_remove_file(hwmon->device, &temp->temp_crit.attr);\r\nmutex_lock(&thermal_hwmon_list_lock);\r\nlist_del(&temp->hwmon_node);\r\nkfree(temp);\r\nif (!list_empty(&hwmon->tz_list)) {\r\nmutex_unlock(&thermal_hwmon_list_lock);\r\nreturn;\r\n}\r\nlist_del(&hwmon->node);\r\nmutex_unlock(&thermal_hwmon_list_lock);\r\ndevice_remove_file(hwmon->device, &dev_attr_name);\r\nhwmon_device_unregister(hwmon->device);\r\nkfree(hwmon);\r\n}

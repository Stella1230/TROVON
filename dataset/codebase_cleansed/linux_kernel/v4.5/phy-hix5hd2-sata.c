static int hix5hd2_sata_phy_init(struct phy *phy)\r\n{\r\nstruct hix5hd2_priv *priv = phy_get_drvdata(phy);\r\nu32 val, data[2];\r\nint ret;\r\nif (priv->peri_ctrl) {\r\nret = of_property_read_u32_array(phy->dev.of_node,\r\n"hisilicon,power-reg",\r\n&data[0], 2);\r\nif (ret) {\r\ndev_err(&phy->dev, "Fail read hisilicon,power-reg\n");\r\nreturn ret;\r\n}\r\nregmap_update_bits(priv->peri_ctrl, data[0],\r\nBIT(data[1]), BIT(data[1]));\r\n}\r\nval = readl_relaxed(priv->base + SATA_PHY0_CTLL);\r\nval &= ~(MPLL_MULTIPLIER_MASK | REF_USE_PAD);\r\nval |= MPLL_MULTIPLIER_50M << MPLL_MULTIPLIER_SHIFT |\r\nREF_SSP_EN | PHY_RESET;\r\nwritel_relaxed(val, priv->base + SATA_PHY0_CTLL);\r\nmsleep(20);\r\nval &= ~PHY_RESET;\r\nwritel_relaxed(val, priv->base + SATA_PHY0_CTLL);\r\nval = readl_relaxed(priv->base + SATA_PORT_PHYCTL1);\r\nval &= ~AMPLITUDE_MASK;\r\nval |= AMPLITUDE_GEN3 << AMPLITUDE_GEN3_SHIFT |\r\nAMPLITUDE_GEN2 << AMPLITUDE_GEN2_SHIFT |\r\nAMPLITUDE_GEN1 << AMPLITUDE_GEN1_SHIFT;\r\nwritel_relaxed(val, priv->base + SATA_PORT_PHYCTL1);\r\nval = readl_relaxed(priv->base + SATA_PORT_PHYCTL2);\r\nval &= ~PREEMPH_MASK;\r\nval |= PREEMPH_GEN3 << PREEMPH_GEN3_SHIFT |\r\nPREEMPH_GEN2 << PREEMPH_GEN2_SHIFT |\r\nPREEMPH_GEN1 << PREEMPH_GEN1_SHIFT;\r\nwritel_relaxed(val, priv->base + SATA_PORT_PHYCTL2);\r\nval = readl_relaxed(priv->base + SATA_PORT_PHYCTL);\r\nval &= ~SPEED_MODE_MASK;\r\nval |= SPEED_MODE_GEN1 << HALF_RATE_SHIFT |\r\nSPEED_MODE_GEN1 << PHY_CONFIG_SHIFT |\r\nSPEED_MODE_GEN1 << GEN2_EN_SHIFT | SPEED_CTRL;\r\nwritel_relaxed(val, priv->base + SATA_PORT_PHYCTL);\r\nmsleep(20);\r\nval &= ~SPEED_MODE_MASK;\r\nval |= SPEED_MODE_GEN3 << HALF_RATE_SHIFT |\r\nSPEED_MODE_GEN3 << PHY_CONFIG_SHIFT |\r\nSPEED_MODE_GEN3 << GEN2_EN_SHIFT | SPEED_CTRL;\r\nwritel_relaxed(val, priv->base + SATA_PORT_PHYCTL);\r\nval &= ~(SPEED_MODE_MASK | SPEED_CTRL);\r\nval |= SPEED_MODE_GEN2 << HALF_RATE_SHIFT |\r\nSPEED_MODE_GEN2 << PHY_CONFIG_SHIFT |\r\nSPEED_MODE_GEN2 << GEN2_EN_SHIFT;\r\nwritel_relaxed(val, priv->base + SATA_PORT_PHYCTL);\r\nreturn 0;\r\n}\r\nstatic int hix5hd2_sata_phy_probe(struct platform_device *pdev)\r\n{\r\nstruct phy_provider *phy_provider;\r\nstruct device *dev = &pdev->dev;\r\nstruct resource *res;\r\nstruct phy *phy;\r\nstruct hix5hd2_priv *priv;\r\npriv = devm_kzalloc(dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -EINVAL;\r\npriv->base = devm_ioremap(dev, res->start, resource_size(res));\r\nif (!priv->base)\r\nreturn -ENOMEM;\r\npriv->peri_ctrl = syscon_regmap_lookup_by_phandle(dev->of_node,\r\n"hisilicon,peripheral-syscon");\r\nif (IS_ERR(priv->peri_ctrl))\r\npriv->peri_ctrl = NULL;\r\nphy = devm_phy_create(dev, NULL, &hix5hd2_sata_phy_ops);\r\nif (IS_ERR(phy)) {\r\ndev_err(dev, "failed to create PHY\n");\r\nreturn PTR_ERR(phy);\r\n}\r\nphy_set_drvdata(phy, priv);\r\nphy_provider = devm_of_phy_provider_register(dev, of_phy_simple_xlate);\r\nreturn PTR_ERR_OR_ZERO(phy_provider);\r\n}

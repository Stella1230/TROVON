static int rsi_copy_to_card(struct rsi_common *common,\r\nconst u8 *fw,\r\nu32 len,\r\nu32 num_blocks)\r\n{\r\nstruct rsi_hw *adapter = common->priv;\r\nstruct rsi_91x_usbdev *dev = (struct rsi_91x_usbdev *)adapter->rsi_dev;\r\nu32 indx, ii;\r\nu32 block_size = dev->tx_blk_size;\r\nu32 lsb_address;\r\nu32 base_address;\r\nbase_address = TA_LOAD_ADDRESS;\r\nfor (indx = 0, ii = 0; ii < num_blocks; ii++, indx += block_size) {\r\nlsb_address = base_address;\r\nif (rsi_usb_write_register_multiple(adapter,\r\nlsb_address,\r\n(u8 *)(fw + indx),\r\nblock_size)) {\r\nrsi_dbg(ERR_ZONE,\r\n"%s: Unable to load %s blk\n", __func__,\r\nFIRMWARE_RSI9113);\r\nreturn -EIO;\r\n}\r\nrsi_dbg(INIT_ZONE, "%s: loading block: %d\n", __func__, ii);\r\nbase_address += block_size;\r\n}\r\nif (len % block_size) {\r\nlsb_address = base_address;\r\nif (rsi_usb_write_register_multiple(adapter,\r\nlsb_address,\r\n(u8 *)(fw + indx),\r\nlen % block_size)) {\r\nrsi_dbg(ERR_ZONE,\r\n"%s: Unable to load %s blk\n", __func__,\r\nFIRMWARE_RSI9113);\r\nreturn -EIO;\r\n}\r\n}\r\nrsi_dbg(INIT_ZONE,\r\n"%s: Succesfully loaded %s instructions\n", __func__,\r\nFIRMWARE_RSI9113);\r\nrsi_dbg(INIT_ZONE, "%s: loaded firmware\n", __func__);\r\nreturn 0;\r\n}\r\nvoid rsi_usb_rx_thread(struct rsi_common *common)\r\n{\r\nstruct rsi_hw *adapter = common->priv;\r\nstruct rsi_91x_usbdev *dev = (struct rsi_91x_usbdev *)adapter->rsi_dev;\r\nint status;\r\ndo {\r\nrsi_wait_event(&dev->rx_thread.event, EVENT_WAIT_FOREVER);\r\nif (atomic_read(&dev->rx_thread.thread_done))\r\ngoto out;\r\nmutex_lock(&common->tx_rxlock);\r\nstatus = rsi_read_pkt(common, 0);\r\nif (status) {\r\nrsi_dbg(ERR_ZONE, "%s: Failed To read data", __func__);\r\nmutex_unlock(&common->tx_rxlock);\r\nreturn;\r\n}\r\nmutex_unlock(&common->tx_rxlock);\r\nrsi_reset_event(&dev->rx_thread.event);\r\nif (adapter->rx_urb_submit(adapter)) {\r\nrsi_dbg(ERR_ZONE,\r\n"%s: Failed in urb submission", __func__);\r\nreturn;\r\n}\r\n} while (1);\r\nout:\r\nrsi_dbg(INFO_ZONE, "%s: Terminated thread\n", __func__);\r\ncomplete_and_exit(&dev->rx_thread.completion, 0);\r\n}\r\nstatic int rsi_load_ta_instructions(struct rsi_common *common)\r\n{\r\nstruct rsi_hw *adapter = common->priv;\r\nstruct rsi_91x_usbdev *dev = (struct rsi_91x_usbdev *)adapter->rsi_dev;\r\nconst struct firmware *fw_entry = NULL;\r\nu32 block_size = dev->tx_blk_size;\r\nconst u8 *fw;\r\nu32 num_blocks, len;\r\nint status = 0;\r\nstatus = request_firmware(&fw_entry, FIRMWARE_RSI9113, adapter->device);\r\nif (status < 0) {\r\nrsi_dbg(ERR_ZONE, "%s Firmware file %s not found\n",\r\n__func__, FIRMWARE_RSI9113);\r\nreturn status;\r\n}\r\nfw = kmemdup(fw_entry->data, fw_entry->size, GFP_KERNEL);\r\nif (!fw) {\r\nstatus = -ENOMEM;\r\ngoto out;\r\n}\r\nlen = fw_entry->size;\r\nif (len % 4)\r\nlen += (4 - (len % 4));\r\nnum_blocks = (len / block_size);\r\nrsi_dbg(INIT_ZONE, "%s: Instruction size:%d\n", __func__, len);\r\nrsi_dbg(INIT_ZONE, "%s: num blocks: %d\n", __func__, num_blocks);\r\nstatus = rsi_copy_to_card(common, fw, len, num_blocks);\r\nkfree(fw);\r\nout:\r\nrelease_firmware(fw_entry);\r\nreturn status;\r\n}\r\nint rsi_usb_device_init(struct rsi_common *common)\r\n{\r\nif (rsi_load_ta_instructions(common))\r\nreturn -EIO;\r\nreturn 0;\r\n}

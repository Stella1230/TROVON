static int on20_read_regr( PIA *pi, int cont, int regr )\r\n{ int h,l, r ;\r\nr = (regr<<2) + 1 + cont;\r\nop(1); vl(r); op(0);\r\nswitch (pi->mode) {\r\ncase 0: w2(4); w2(6); l = r1();\r\nw2(4); w2(6); h = r1();\r\nw2(4); w2(6); w2(4); w2(6); w2(4);\r\nreturn j44(l,h);\r\ncase 1: w2(4); w2(0x26); r = r0();\r\nw2(4); w2(0x26); w2(4);\r\nreturn r;\r\n}\r\nreturn -1;\r\n}\r\nstatic void on20_write_regr( PIA *pi, int cont, int regr, int val )\r\n{ int r;\r\nr = (regr<<2) + 1 + cont;\r\nop(1); vl(r);\r\nop(0); vl(val);\r\nop(0); vl(val);\r\n}\r\nstatic void on20_connect ( PIA *pi)\r\n{ pi->saved_r0 = r0();\r\npi->saved_r2 = r2();\r\nw2(4);w0(0);w2(0xc);w2(4);w2(6);w2(4);w2(6);w2(4);\r\nif (pi->mode) { op(2); vl(8); op(2); vl(9); }\r\nelse { op(2); vl(0); op(2); vl(8); }\r\n}\r\nstatic void on20_disconnect ( PIA *pi )\r\n{ w2(4);w0(7);w2(4);w2(0xc);w2(4);\r\nw0(pi->saved_r0);\r\nw2(pi->saved_r2);\r\n}\r\nstatic void on20_read_block( PIA *pi, char * buf, int count )\r\n{ int k, l, h;\r\nop(1); vl(1); op(0);\r\nfor (k=0;k<count;k++)\r\nif (pi->mode) {\r\nw2(4); w2(0x26); buf[k] = r0();\r\n} else {\r\nw2(6); l = r1(); w2(4);\r\nw2(6); h = r1(); w2(4);\r\nbuf[k] = j44(l,h);\r\n}\r\nw2(4);\r\n}\r\nstatic void on20_write_block( PIA *pi, char * buf, int count )\r\n{ int k;\r\nop(1); vl(1); op(0);\r\nfor (k=0;k<count;k++) { w2(5); w0(buf[k]); w2(7); }\r\nw2(4);\r\n}\r\nstatic void on20_log_adapter( PIA *pi, char * scratch, int verbose )\r\n{ char *mode_string[2] = {"4-bit","8-bit"};\r\nprintk("%s: on20 %s, OnSpec 90c20 at 0x%x, ",\r\npi->device,ON20_VERSION,pi->port);\r\nprintk("mode %d (%s), delay %d\n",pi->mode,\r\nmode_string[pi->mode],pi->delay);\r\n}\r\nstatic int __init on20_init(void)\r\n{\r\nreturn paride_register(&on20);\r\n}\r\nstatic void __exit on20_exit(void)\r\n{\r\nparide_unregister(&on20);\r\n}

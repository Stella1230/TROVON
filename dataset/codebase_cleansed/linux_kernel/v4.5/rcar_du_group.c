u32 rcar_du_group_read(struct rcar_du_group *rgrp, u32 reg)\r\n{\r\nreturn rcar_du_read(rgrp->dev, rgrp->mmio_offset + reg);\r\n}\r\nvoid rcar_du_group_write(struct rcar_du_group *rgrp, u32 reg, u32 data)\r\n{\r\nrcar_du_write(rgrp->dev, rgrp->mmio_offset + reg, data);\r\n}\r\nstatic void rcar_du_group_setup_defr8(struct rcar_du_group *rgrp)\r\n{\r\nu32 defr8 = DEFR8_CODE | DEFR8_DEFE8;\r\nif (rgrp->dev->info->routes[RCAR_DU_OUTPUT_DPAD0].possible_crtcs > 1 &&\r\nrgrp->index == 0)\r\ndefr8 |= DEFR8_DRGBS_DU(rgrp->dev->dpad0_source);\r\nrcar_du_group_write(rgrp, DEFR8, defr8);\r\n}\r\nstatic void rcar_du_group_setup(struct rcar_du_group *rgrp)\r\n{\r\nrcar_du_group_write(rgrp, DEFR, DEFR_CODE | DEFR_DEFE);\r\nrcar_du_group_write(rgrp, DEFR2, DEFR2_CODE | DEFR2_DEFE2G);\r\nrcar_du_group_write(rgrp, DEFR3, DEFR3_CODE | DEFR3_DEFE3);\r\nrcar_du_group_write(rgrp, DEFR4, DEFR4_CODE);\r\nrcar_du_group_write(rgrp, DEFR5, DEFR5_CODE | DEFR5_DEFE5);\r\nif (rcar_du_has(rgrp->dev, RCAR_DU_FEATURE_EXT_CTRL_REGS)) {\r\nrcar_du_group_setup_defr8(rgrp);\r\nrcar_du_group_write(rgrp, DIDSR, DIDSR_CODE |\r\nDIDSR_LCDS_DCLKIN(2) |\r\nDIDSR_LCDS_DCLKIN(1) |\r\nDIDSR_LCDS_DCLKIN(0) |\r\nDIDSR_PDCS_CLK(2, 0) |\r\nDIDSR_PDCS_CLK(1, 0) |\r\nDIDSR_PDCS_CLK(0, 0));\r\n}\r\nrcar_du_group_write(rgrp, DORCR, DORCR_PG1D_DS1 | DORCR_DPRS);\r\nmutex_lock(&rgrp->lock);\r\nrcar_du_group_write(rgrp, DPTSR, (rgrp->dptsr_planes << 16) |\r\nrgrp->dptsr_planes);\r\nmutex_unlock(&rgrp->lock);\r\n}\r\nint rcar_du_group_get(struct rcar_du_group *rgrp)\r\n{\r\nif (rgrp->use_count)\r\ngoto done;\r\nrcar_du_group_setup(rgrp);\r\ndone:\r\nrgrp->use_count++;\r\nreturn 0;\r\n}\r\nvoid rcar_du_group_put(struct rcar_du_group *rgrp)\r\n{\r\n--rgrp->use_count;\r\n}\r\nstatic void __rcar_du_group_start_stop(struct rcar_du_group *rgrp, bool start)\r\n{\r\nrcar_du_group_write(rgrp, DSYSR,\r\n(rcar_du_group_read(rgrp, DSYSR) & ~(DSYSR_DRES | DSYSR_DEN)) |\r\n(start ? DSYSR_DEN : DSYSR_DRES));\r\n}\r\nvoid rcar_du_group_start_stop(struct rcar_du_group *rgrp, bool start)\r\n{\r\nif (start) {\r\nif (rgrp->used_crtcs++ != 0)\r\n__rcar_du_group_start_stop(rgrp, false);\r\n__rcar_du_group_start_stop(rgrp, true);\r\n} else {\r\nif (--rgrp->used_crtcs == 0)\r\n__rcar_du_group_start_stop(rgrp, false);\r\n}\r\n}\r\nvoid rcar_du_group_restart(struct rcar_du_group *rgrp)\r\n{\r\n__rcar_du_group_start_stop(rgrp, false);\r\n__rcar_du_group_start_stop(rgrp, true);\r\n}\r\nstatic int rcar_du_set_dpad0_routing(struct rcar_du_device *rcdu)\r\n{\r\nint ret;\r\nif (!rcar_du_has(rcdu, RCAR_DU_FEATURE_EXT_CTRL_REGS))\r\nreturn 0;\r\nret = clk_prepare_enable(rcdu->crtcs[0].clock);\r\nif (ret < 0)\r\nreturn ret;\r\nrcar_du_group_setup_defr8(&rcdu->groups[0]);\r\nclk_disable_unprepare(rcdu->crtcs[0].clock);\r\nreturn 0;\r\n}\r\nint rcar_du_group_set_routing(struct rcar_du_group *rgrp)\r\n{\r\nstruct rcar_du_crtc *crtc0 = &rgrp->dev->crtcs[rgrp->index * 2];\r\nu32 dorcr = rcar_du_group_read(rgrp, DORCR);\r\ndorcr &= ~(DORCR_PG2T | DORCR_DK2S | DORCR_PG2D_MASK);\r\nif (crtc0->outputs & BIT(RCAR_DU_OUTPUT_DPAD1))\r\ndorcr |= DORCR_PG2D_DS1;\r\nelse\r\ndorcr |= DORCR_PG2T | DORCR_DK2S | DORCR_PG2D_DS2;\r\nrcar_du_group_write(rgrp, DORCR, dorcr);\r\nreturn rcar_du_set_dpad0_routing(rgrp->dev);\r\n}

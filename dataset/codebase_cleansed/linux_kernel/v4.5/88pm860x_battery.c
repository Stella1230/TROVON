static int measure_12bit_voltage(struct pm860x_battery_info *info,\r\nint offset, int *data)\r\n{\r\nunsigned char buf[2];\r\nint ret;\r\nret = pm860x_bulk_read(info->i2c, offset, 2, buf);\r\nif (ret < 0)\r\nreturn ret;\r\n*data = ((buf[0] & 0xff) << 4) | (buf[1] & 0x0f);\r\n*data = ((*data & 0xfff) * 9 * 25) >> 9;\r\nreturn 0;\r\n}\r\nstatic int measure_vbatt(struct pm860x_battery_info *info, int state,\r\nint *data)\r\n{\r\nunsigned char buf[5];\r\nint ret;\r\nswitch (state) {\r\ncase OCV_MODE_ACTIVE:\r\nret = measure_12bit_voltage(info, PM8607_VBAT_MEAS1, data);\r\nif (ret)\r\nreturn ret;\r\n*data *= 3;\r\nbreak;\r\ncase OCV_MODE_SLEEP:\r\nret = pm860x_bulk_read(info->i2c, PM8607_LDO5, 5, buf);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ((buf[4] >> 6) << 10) | ((buf[3] >> 6) << 8)\r\n| ((buf[2] >> 6) << 6) | ((buf[1] >> 6) << 4)\r\n| (buf[0] >> 4);\r\n*data = ((*data & 0xff) * 27 * 25) >> 9;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int measure_current(struct pm860x_battery_info *info, int *data)\r\n{\r\nunsigned char buf[2];\r\nshort s;\r\nint ret;\r\nret = pm860x_bulk_read(info->i2c, PM8607_IBAT_MEAS1, 2, buf);\r\nif (ret < 0)\r\nreturn ret;\r\ns = ((buf[0] & 0xff) << 8) | (buf[1] & 0xff);\r\n*data = s >> 3;\r\nreturn 0;\r\n}\r\nstatic int set_charger_current(struct pm860x_battery_info *info, int data,\r\nint *old)\r\n{\r\nint ret;\r\nif (data < 50 || data > 1600 || !old)\r\nreturn -EINVAL;\r\ndata = ((data - 50) / 50) & 0x1f;\r\n*old = pm860x_reg_read(info->i2c, PM8607_CHG_CTRL2);\r\n*old = (*old & 0x1f) * 50 + 50;\r\nret = pm860x_set_bits(info->i2c, PM8607_CHG_CTRL2, 0x1f, data);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int read_ccnt(struct pm860x_battery_info *info, int offset,\r\nint *ccnt)\r\n{\r\nunsigned char buf[2];\r\nint ret;\r\nret = pm860x_set_bits(info->i2c, PM8607_CCNT, 7, offset & 7);\r\nif (ret < 0)\r\ngoto out;\r\nret = pm860x_bulk_read(info->i2c, PM8607_CCNT_MEAS1, 2, buf);\r\nif (ret < 0)\r\ngoto out;\r\n*ccnt = ((buf[0] & 0xff) << 8) | (buf[1] & 0xff);\r\nreturn 0;\r\nout:\r\nreturn ret;\r\n}\r\nstatic int calc_ccnt(struct pm860x_battery_info *info, struct ccnt *ccnt)\r\n{\r\nunsigned int sum;\r\nint ret;\r\nint data;\r\nret = read_ccnt(info, CCNT_POS1, &data);\r\nif (ret)\r\ngoto out;\r\nsum = data & 0xffff;\r\nret = read_ccnt(info, CCNT_POS2, &data);\r\nif (ret)\r\ngoto out;\r\nsum |= (data & 0xffff) << 16;\r\nccnt->pos += sum;\r\nret = read_ccnt(info, CCNT_NEG1, &data);\r\nif (ret)\r\ngoto out;\r\nsum = data & 0xffff;\r\nret = read_ccnt(info, CCNT_NEG2, &data);\r\nif (ret)\r\ngoto out;\r\nsum |= (data & 0xffff) << 16;\r\nsum = ~sum + 1;\r\nccnt->neg += sum;\r\nret = read_ccnt(info, CCNT_SPOS, &data);\r\nif (ret)\r\ngoto out;\r\nccnt->spos += data;\r\nret = read_ccnt(info, CCNT_SNEG, &data);\r\nif (ret)\r\ngoto out;\r\nccnt->total_chg = (int) ((ccnt->pos * 18236) >> 40);\r\nccnt->total_dischg = (int) ((ccnt->neg * 18236) >> 40);\r\nreturn 0;\r\nout:\r\nreturn ret;\r\n}\r\nstatic int clear_ccnt(struct pm860x_battery_info *info, struct ccnt *ccnt)\r\n{\r\nint data;\r\nmemset(ccnt, 0, sizeof(*ccnt));\r\nread_ccnt(info, CCNT_POS1, &data);\r\nread_ccnt(info, CCNT_POS2, &data);\r\nread_ccnt(info, CCNT_NEG1, &data);\r\nread_ccnt(info, CCNT_NEG2, &data);\r\nread_ccnt(info, CCNT_SPOS, &data);\r\nread_ccnt(info, CCNT_SNEG, &data);\r\nreturn 0;\r\n}\r\nstatic int calc_ocv(struct pm860x_battery_info *info, int *ocv)\r\n{\r\nint ret;\r\nint i;\r\nint data;\r\nint vbatt_avg;\r\nint vbatt_sum;\r\nint ibatt_avg;\r\nint ibatt_sum;\r\nif (!ocv)\r\nreturn -EINVAL;\r\nfor (i = 0, ibatt_sum = 0, vbatt_sum = 0; i < 10; i++) {\r\nret = measure_vbatt(info, OCV_MODE_ACTIVE, &data);\r\nif (ret)\r\ngoto out;\r\nvbatt_sum += data;\r\nret = measure_current(info, &data);\r\nif (ret)\r\ngoto out;\r\nibatt_sum += data;\r\n}\r\nvbatt_avg = vbatt_sum / 10;\r\nibatt_avg = ibatt_sum / 10;\r\nmutex_lock(&info->lock);\r\nif (info->present)\r\n*ocv = vbatt_avg - ibatt_avg * info->resistor / 1000;\r\nelse\r\n*ocv = vbatt_avg;\r\nmutex_unlock(&info->lock);\r\ndev_dbg(info->dev, "VBAT average:%d, OCV:%d\n", vbatt_avg, *ocv);\r\nreturn 0;\r\nout:\r\nreturn ret;\r\n}\r\nstatic int calc_soc(struct pm860x_battery_info *info, int state, int *soc)\r\n{\r\nint i;\r\nint ocv;\r\nint count;\r\nint ret = -EINVAL;\r\nif (!soc)\r\nreturn -EINVAL;\r\nswitch (state) {\r\ncase OCV_MODE_ACTIVE:\r\nret = calc_ocv(info, &ocv);\r\nbreak;\r\ncase OCV_MODE_SLEEP:\r\nret = measure_vbatt(info, OCV_MODE_SLEEP, &ocv);\r\nbreak;\r\n}\r\nif (ret)\r\nreturn ret;\r\ncount = ARRAY_SIZE(array_soc);\r\nif (ocv < array_soc[count - 1][0]) {\r\n*soc = 0;\r\nreturn 0;\r\n}\r\nfor (i = 0; i < count; i++) {\r\nif (ocv >= array_soc[i][0]) {\r\n*soc = array_soc[i][1];\r\nbreak;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic irqreturn_t pm860x_coulomb_handler(int irq, void *data)\r\n{\r\nstruct pm860x_battery_info *info = data;\r\ncalc_ccnt(info, &ccnt_data);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t pm860x_batt_handler(int irq, void *data)\r\n{\r\nstruct pm860x_battery_info *info = data;\r\nint ret;\r\nmutex_lock(&info->lock);\r\nret = pm860x_reg_read(info->i2c, PM8607_STATUS_2);\r\nif (ret & STATUS2_BAT) {\r\ninfo->present = 1;\r\ninfo->temp_type = PM860X_TEMP_TBAT;\r\n} else {\r\ninfo->present = 0;\r\ninfo->temp_type = PM860X_TEMP_TINT;\r\n}\r\nmutex_unlock(&info->lock);\r\nclear_ccnt(info, &ccnt_data);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void pm860x_init_battery(struct pm860x_battery_info *info)\r\n{\r\nunsigned char buf[2];\r\nint ret;\r\nint data;\r\nint bat_remove;\r\nint soc;\r\ndata = MEAS1_GP1;\r\nif (info->temp_type == PM860X_TEMP_TINT)\r\ndata |= MEAS1_TINT;\r\nret = pm860x_set_bits(info->i2c, PM8607_MEAS_EN1, data, data);\r\nif (ret)\r\ngoto out;\r\ndata = MEAS3_IBAT | MEAS3_BAT_DET | MEAS3_CC;\r\nret = pm860x_set_bits(info->i2c, PM8607_MEAS_EN3, data, data);\r\nif (ret)\r\ngoto out;\r\nret = pm860x_reg_write(info->i2c, PM8607_MEAS_OFF_TIME1, 0x82);\r\nif (ret)\r\ngoto out;\r\nret = pm860x_reg_write(info->i2c, PM8607_MEAS_OFF_TIME2, 0x6c);\r\nif (ret)\r\ngoto out;\r\nret = pm860x_set_bits(info->i2c, PM8607_GPADC_MISC1,\r\nGPMISC1_GPADC_EN, GPMISC1_GPADC_EN);\r\nif (ret < 0)\r\ngoto out;\r\nret = pm860x_set_bits(info->i2c, PM8607_CHG_CTRL6,\r\nCC6_BAT_DET_GPADC1, CC6_BAT_DET_GPADC1);\r\nif (ret < 0)\r\ngoto out;\r\nret = pm860x_set_bits(info->i2c, PM8607_CCNT, 7 << 3,\r\nCCNT_AVG_SEL);\r\nif (ret < 0)\r\ngoto out;\r\nret = pm860x_set_bits(info->i2c, PM8607_GP_BIAS2, 0xF << 4,\r\nGPBIAS2_GPADC1_SET);\r\nif (ret < 0)\r\ngoto out;\r\nmutex_lock(&info->lock);\r\nret = pm860x_reg_read(info->i2c, PM8607_STATUS_2);\r\nif (ret < 0) {\r\nmutex_unlock(&info->lock);\r\ngoto out;\r\n}\r\nif (ret & STATUS2_BAT) {\r\ninfo->present = 1;\r\ninfo->temp_type = PM860X_TEMP_TBAT;\r\n} else {\r\ninfo->present = 0;\r\ninfo->temp_type = PM860X_TEMP_TINT;\r\n}\r\nmutex_unlock(&info->lock);\r\ncalc_soc(info, OCV_MODE_ACTIVE, &soc);\r\ndata = pm860x_reg_read(info->i2c, PM8607_POWER_UP_LOG);\r\nbat_remove = data & BAT_WU_LOG;\r\ndev_dbg(info->dev, "battery wake up? %s\n",\r\nbat_remove != 0 ? "yes" : "no");\r\nif (bat_remove == 0) {\r\nbuf[0] = pm860x_reg_read(info->i2c, PM8607_RTC_MISC2);\r\nbuf[1] = pm860x_reg_read(info->i2c, PM8607_RTC1);\r\ndata = ((buf[1] & 0x3) << 5) | ((buf[0] >> 3) & 0x1F);\r\nif (data > soc + 15)\r\ninfo->start_soc = soc;\r\nelse if (data < soc - 15)\r\ninfo->start_soc = soc;\r\nelse\r\ninfo->start_soc = data;\r\ndev_dbg(info->dev, "soc_rtc %d, soc_ocv :%d\n", data, soc);\r\n} else {\r\npm860x_set_bits(info->i2c, PM8607_POWER_UP_LOG,\r\nBAT_WU_LOG, BAT_WU_LOG);\r\ninfo->start_soc = soc;\r\n}\r\ninfo->last_capacity = info->start_soc;\r\ndev_dbg(info->dev, "init soc : %d\n", info->last_capacity);\r\nout:\r\nreturn;\r\n}\r\nstatic void set_temp_threshold(struct pm860x_battery_info *info,\r\nint min, int max)\r\n{\r\nint data;\r\nif (min <= 0)\r\ndata = 0;\r\nelse\r\ndata = (min << 8) / 1800;\r\npm860x_reg_write(info->i2c, PM8607_GPADC1_HIGHTH, data);\r\ndev_dbg(info->dev, "TEMP_HIGHTH : min: %d, 0x%x\n", min, data);\r\nif (max <= 0)\r\ndata = 0xff;\r\nelse\r\ndata = (max << 8) / 1800;\r\npm860x_reg_write(info->i2c, PM8607_GPADC1_LOWTH, data);\r\ndev_dbg(info->dev, "TEMP_LOWTH:max : %d, 0x%x\n", max, data);\r\n}\r\nstatic int measure_temp(struct pm860x_battery_info *info, int *data)\r\n{\r\nint ret;\r\nint temp;\r\nint min;\r\nint max;\r\nif (info->temp_type == PM860X_TEMP_TINT) {\r\nret = measure_12bit_voltage(info, PM8607_TINT_MEAS1, data);\r\nif (ret)\r\nreturn ret;\r\n*data = (*data - 884) * 1000 / 3611;\r\n} else {\r\nret = measure_12bit_voltage(info, PM8607_GPADC1_MEAS1, data);\r\nif (ret)\r\nreturn ret;\r\n*data = (*data * 1000) / GPBIAS2_GPADC1_UA;\r\nif (*data > TBAT_NEG_25D) {\r\ntemp = -30;\r\nmax = TBAT_NEG_10D * GPBIAS2_GPADC1_UA / 1000;\r\nset_temp_threshold(info, 0, max);\r\n} else if (*data > TBAT_NEG_10D) {\r\ntemp = -15;\r\nmax = TBAT_NEG_10D * GPBIAS2_GPADC1_UA / 1000;\r\nset_temp_threshold(info, 0, max);\r\n} else if (*data > TBAT_0D) {\r\ntemp = -5;\r\nmin = TBAT_NEG_10D * GPBIAS2_GPADC1_UA / 1000;\r\nmax = TBAT_40D * GPBIAS2_GPADC1_UA / 1000;\r\nset_temp_threshold(info, min, max);\r\n} else if (*data > TBAT_10D) {\r\ntemp = 5;\r\nmin = TBAT_NEG_10D * GPBIAS2_GPADC1_UA / 1000;\r\nmax = TBAT_40D * GPBIAS2_GPADC1_UA / 1000;\r\nset_temp_threshold(info, min, max);\r\n} else if (*data > TBAT_20D) {\r\ntemp = 15;\r\nmin = TBAT_NEG_10D * GPBIAS2_GPADC1_UA / 1000;\r\nmax = TBAT_40D * GPBIAS2_GPADC1_UA / 1000;\r\nset_temp_threshold(info, min, max);\r\n} else if (*data > TBAT_30D) {\r\ntemp = 25;\r\nmin = TBAT_NEG_10D * GPBIAS2_GPADC1_UA / 1000;\r\nmax = TBAT_40D * GPBIAS2_GPADC1_UA / 1000;\r\nset_temp_threshold(info, min, max);\r\n} else if (*data > TBAT_40D) {\r\ntemp = 35;\r\nmin = TBAT_NEG_10D * GPBIAS2_GPADC1_UA / 1000;\r\nmax = TBAT_40D * GPBIAS2_GPADC1_UA / 1000;\r\nset_temp_threshold(info, min, max);\r\n} else {\r\nmin = TBAT_40D * GPBIAS2_GPADC1_UA / 1000;\r\nset_temp_threshold(info, min, 0);\r\ntemp = 45;\r\n}\r\ndev_dbg(info->dev, "temp_C:%d C,temp_mv:%d mv\n", temp, *data);\r\n*data = temp;\r\n}\r\nreturn 0;\r\n}\r\nstatic int calc_resistor(struct pm860x_battery_info *info)\r\n{\r\nint vbatt_sum1;\r\nint vbatt_sum2;\r\nint chg_current;\r\nint ibatt_sum1;\r\nint ibatt_sum2;\r\nint data;\r\nint ret;\r\nint i;\r\nret = measure_current(info, &data);\r\nif (ret || data < 0)\r\ngoto out;\r\nret = measure_vbatt(info, OCV_MODE_ACTIVE, &data);\r\nif (ret)\r\ngoto out;\r\nif (data < VBATT_RESISTOR_MIN || data > VBATT_RESISTOR_MAX)\r\ngoto out;\r\nif (set_charger_current(info, 500, &chg_current))\r\ngoto out;\r\nmsleep(500);\r\nfor (i = 0, vbatt_sum1 = 0, ibatt_sum1 = 0; i < 10; i++) {\r\nret = measure_vbatt(info, OCV_MODE_ACTIVE, &data);\r\nif (ret)\r\ngoto out_meas;\r\nvbatt_sum1 += data;\r\nret = measure_current(info, &data);\r\nif (ret)\r\ngoto out_meas;\r\nif (data < 0)\r\nibatt_sum1 = ibatt_sum1 - data;\r\nelse\r\nibatt_sum1 = ibatt_sum1 + data;\r\n}\r\nif (set_charger_current(info, 100, &ret))\r\ngoto out_meas;\r\nmsleep(500);\r\nfor (i = 0, vbatt_sum2 = 0, ibatt_sum2 = 0; i < 10; i++) {\r\nret = measure_vbatt(info, OCV_MODE_ACTIVE, &data);\r\nif (ret)\r\ngoto out_meas;\r\nvbatt_sum2 += data;\r\nret = measure_current(info, &data);\r\nif (ret)\r\ngoto out_meas;\r\nif (data < 0)\r\nibatt_sum2 = ibatt_sum2 - data;\r\nelse\r\nibatt_sum2 = ibatt_sum2 + data;\r\n}\r\nif (set_charger_current(info, chg_current, &ret))\r\ngoto out_meas;\r\nif ((vbatt_sum1 > vbatt_sum2) && (ibatt_sum1 > ibatt_sum2) &&\r\n(ibatt_sum2 > 0)) {\r\ndata = 1000 * (vbatt_sum1 - vbatt_sum2)\r\n/ (ibatt_sum1 - ibatt_sum2);\r\nif ((data - info->resistor > 0) &&\r\n(data - info->resistor < info->resistor))\r\ninfo->resistor = data;\r\nif ((info->resistor - data > 0) &&\r\n(info->resistor - data < data))\r\ninfo->resistor = data;\r\n}\r\nreturn 0;\r\nout_meas:\r\nset_charger_current(info, chg_current, &ret);\r\nout:\r\nreturn -EINVAL;\r\n}\r\nstatic int calc_capacity(struct pm860x_battery_info *info, int *cap)\r\n{\r\nint ret;\r\nint data;\r\nint ibat;\r\nint cap_ocv = 0;\r\nint cap_cc = 0;\r\nret = calc_ccnt(info, &ccnt_data);\r\nif (ret)\r\ngoto out;\r\nsoc:\r\ndata = info->max_capacity * info->start_soc / 100;\r\nif (ccnt_data.total_dischg - ccnt_data.total_chg <= data) {\r\ncap_cc =\r\ndata + ccnt_data.total_chg - ccnt_data.total_dischg;\r\n} else {\r\nclear_ccnt(info, &ccnt_data);\r\ncalc_soc(info, OCV_MODE_ACTIVE, &info->start_soc);\r\ndev_dbg(info->dev, "restart soc = %d !\n",\r\ninfo->start_soc);\r\ngoto soc;\r\n}\r\ncap_cc = cap_cc * 100 / info->max_capacity;\r\nif (cap_cc < 0)\r\ncap_cc = 0;\r\nelse if (cap_cc > 100)\r\ncap_cc = 100;\r\ndev_dbg(info->dev, "%s, last cap : %d", __func__,\r\ninfo->last_capacity);\r\nret = measure_current(info, &ibat);\r\nif (ret)\r\ngoto out;\r\nif (ibat < 0) {\r\nret = calc_soc(info, OCV_MODE_ACTIVE, &cap_ocv);\r\nif (ret)\r\ncap_ocv = info->last_capacity;\r\nret = measure_vbatt(info, OCV_MODE_ACTIVE, &data);\r\nif (ret)\r\ngoto out;\r\nif (data <= LOW_BAT_THRESHOLD) {\r\n*cap = min(cap_ocv, cap_cc);\r\n} else {\r\nif (cap_cc < 15 && cap_ocv - cap_cc > 10)\r\n*cap = cap_ocv;\r\nelse\r\n*cap = cap_cc;\r\n}\r\nif (*cap > info->last_capacity)\r\n*cap = info->last_capacity;\r\n} else {\r\n*cap = cap_cc;\r\n}\r\ninfo->last_capacity = *cap;\r\ndev_dbg(info->dev, "%s, cap_ocv:%d cap_cc:%d, cap:%d\n",\r\n(ibat < 0) ? "discharging" : "charging",\r\ncap_ocv, cap_cc, *cap);\r\npm860x_set_bits(info->i2c, PM8607_RTC_MISC2, RTC_SOC_5LSB,\r\n(*cap & 0x1F) << 3);\r\npm860x_set_bits(info->i2c, PM8607_RTC1, RTC_SOC_3MSB,\r\n((*cap >> 5) & 0x3));\r\nreturn 0;\r\nout:\r\nreturn ret;\r\n}\r\nstatic void pm860x_external_power_changed(struct power_supply *psy)\r\n{\r\nstruct pm860x_battery_info *info = dev_get_drvdata(psy->dev.parent);\r\ncalc_resistor(info);\r\n}\r\nstatic int pm860x_batt_get_prop(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct pm860x_battery_info *info = dev_get_drvdata(psy->dev.parent);\r\nint data;\r\nint ret;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_PRESENT:\r\nval->intval = info->present;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CAPACITY:\r\nret = calc_capacity(info, &data);\r\nif (ret)\r\nreturn ret;\r\nif (data < 0)\r\ndata = 0;\r\nelse if (data > 100)\r\ndata = 100;\r\nif (!info->present)\r\ndata = 100;\r\nval->intval = data;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TECHNOLOGY:\r\nval->intval = POWER_SUPPLY_TECHNOLOGY_LION;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nret = measure_vbatt(info, OCV_MODE_ACTIVE, &data);\r\nif (ret)\r\nreturn ret;\r\nval->intval = data * 1000;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_AVG:\r\nret = calc_ocv(info, &data);\r\nif (ret)\r\nreturn ret;\r\nval->intval = data * 1000;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CURRENT_NOW:\r\nret = measure_current(info, &data);\r\nif (ret)\r\nreturn ret;\r\nval->intval = data;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TEMP:\r\nif (info->present) {\r\nret = measure_temp(info, &data);\r\nif (ret)\r\nreturn ret;\r\ndata *= 10;\r\n} else {\r\ndata = 250;\r\n}\r\nval->intval = data;\r\nbreak;\r\ndefault:\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic int pm860x_batt_set_prop(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nconst union power_supply_propval *val)\r\n{\r\nstruct pm860x_battery_info *info = dev_get_drvdata(psy->dev.parent);\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_CHARGE_FULL:\r\nclear_ccnt(info, &ccnt_data);\r\ninfo->start_soc = 100;\r\ndev_dbg(info->dev, "chg done, update soc = %d\n",\r\ninfo->start_soc);\r\nbreak;\r\ndefault:\r\nreturn -EPERM;\r\n}\r\nreturn 0;\r\n}\r\nstatic int pm860x_battery_probe(struct platform_device *pdev)\r\n{\r\nstruct pm860x_chip *chip = dev_get_drvdata(pdev->dev.parent);\r\nstruct pm860x_battery_info *info;\r\nstruct pm860x_power_pdata *pdata;\r\nint ret;\r\ninfo = devm_kzalloc(&pdev->dev, sizeof(*info), GFP_KERNEL);\r\nif (!info)\r\nreturn -ENOMEM;\r\ninfo->irq_cc = platform_get_irq(pdev, 0);\r\nif (info->irq_cc <= 0) {\r\ndev_err(&pdev->dev, "No IRQ resource!\n");\r\nreturn -EINVAL;\r\n}\r\ninfo->irq_batt = platform_get_irq(pdev, 1);\r\nif (info->irq_batt <= 0) {\r\ndev_err(&pdev->dev, "No IRQ resource!\n");\r\nreturn -EINVAL;\r\n}\r\ninfo->chip = chip;\r\ninfo->i2c =\r\n(chip->id == CHIP_PM8607) ? chip->client : chip->companion;\r\ninfo->dev = &pdev->dev;\r\ninfo->status = POWER_SUPPLY_STATUS_UNKNOWN;\r\npdata = pdev->dev.platform_data;\r\nmutex_init(&info->lock);\r\nplatform_set_drvdata(pdev, info);\r\npm860x_init_battery(info);\r\nif (pdata && pdata->max_capacity)\r\ninfo->max_capacity = pdata->max_capacity;\r\nelse\r\ninfo->max_capacity = 1500;\r\nif (pdata && pdata->resistor)\r\ninfo->resistor = pdata->resistor;\r\nelse\r\ninfo->resistor = 300;\r\ninfo->battery = devm_power_supply_register(&pdev->dev,\r\n&pm860x_battery_desc,\r\nNULL);\r\nif (IS_ERR(info->battery))\r\nreturn PTR_ERR(info->battery);\r\ninfo->battery->dev.parent = &pdev->dev;\r\nret = devm_request_threaded_irq(chip->dev, info->irq_cc, NULL,\r\npm860x_coulomb_handler, IRQF_ONESHOT,\r\n"coulomb", info);\r\nif (ret < 0) {\r\ndev_err(chip->dev, "Failed to request IRQ: #%d: %d\n",\r\ninfo->irq_cc, ret);\r\nreturn ret;\r\n}\r\nret = devm_request_threaded_irq(chip->dev, info->irq_batt, NULL,\r\npm860x_batt_handler,\r\nIRQF_ONESHOT, "battery", info);\r\nif (ret < 0) {\r\ndev_err(chip->dev, "Failed to request IRQ: #%d: %d\n",\r\ninfo->irq_batt, ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int pm860x_battery_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct pm860x_chip *chip = dev_get_drvdata(pdev->dev.parent);\r\nif (device_may_wakeup(dev))\r\nchip->wakeup_flag |= 1 << PM8607_IRQ_CC;\r\nreturn 0;\r\n}\r\nstatic int pm860x_battery_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct pm860x_chip *chip = dev_get_drvdata(pdev->dev.parent);\r\nif (device_may_wakeup(dev))\r\nchip->wakeup_flag &= ~(1 << PM8607_IRQ_CC);\r\nreturn 0;\r\n}

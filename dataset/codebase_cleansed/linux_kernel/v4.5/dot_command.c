void ibmasm_receive_message(struct service_processor *sp, void *message, int message_size)\r\n{\r\nu32 size;\r\nstruct dot_command_header *header = (struct dot_command_header *)message;\r\nif (message_size == 0)\r\nreturn;\r\nsize = get_dot_command_size(message);\r\nif (size == 0)\r\nreturn;\r\nif (size > message_size)\r\nsize = message_size;\r\nswitch (header->type) {\r\ncase sp_event:\r\nibmasm_receive_event(sp, message, size);\r\nbreak;\r\ncase sp_command_response:\r\nibmasm_receive_command_response(sp, message, size);\r\nbreak;\r\ncase sp_heartbeat:\r\nibmasm_receive_heartbeat(sp, message, size);\r\nbreak;\r\ndefault:\r\ndev_err(sp->dev, "Received unknown message from service processor\n");\r\n}\r\n}\r\nint ibmasm_send_driver_vpd(struct service_processor *sp)\r\n{\r\nstruct command *command;\r\nstruct dot_command_header *header;\r\nu8 *vpd_command;\r\nu8 *vpd_data;\r\nint result = 0;\r\ncommand = ibmasm_new_command(sp, INIT_BUFFER_SIZE);\r\nif (command == NULL)\r\nreturn -ENOMEM;\r\nheader = (struct dot_command_header *)command->buffer;\r\nheader->type = sp_write;\r\nheader->command_size = 4;\r\nheader->data_size = 16;\r\nheader->status = 0;\r\nheader->reserved = 0;\r\nvpd_command = command->buffer + sizeof(struct dot_command_header);\r\nvpd_command[0] = 0x4;\r\nvpd_command[1] = 0x3;\r\nvpd_command[2] = 0x5;\r\nvpd_command[3] = 0xa;\r\nvpd_data = vpd_command + header->command_size;\r\nvpd_data[0] = 0;\r\nstrcat(vpd_data, IBMASM_DRIVER_VPD);\r\nvpd_data[10] = 0;\r\nvpd_data[15] = 0;\r\nibmasm_exec_command(sp, command);\r\nibmasm_wait_for_response(command, IBMASM_CMD_TIMEOUT_NORMAL);\r\nif (command->status != IBMASM_CMD_COMPLETE)\r\nresult = -ENODEV;\r\ncommand_put(command);\r\nreturn result;\r\n}\r\nint ibmasm_send_os_state(struct service_processor *sp, int os_state)\r\n{\r\nstruct command *cmd;\r\nstruct os_state_command *os_state_cmd;\r\nint result = 0;\r\ncmd = ibmasm_new_command(sp, sizeof(struct os_state_command));\r\nif (cmd == NULL)\r\nreturn -ENOMEM;\r\nos_state_cmd = (struct os_state_command *)cmd->buffer;\r\nos_state_cmd->header.type = sp_write;\r\nos_state_cmd->header.command_size = 3;\r\nos_state_cmd->header.data_size = 1;\r\nos_state_cmd->header.status = 0;\r\nos_state_cmd->command[0] = 4;\r\nos_state_cmd->command[1] = 3;\r\nos_state_cmd->command[2] = 6;\r\nos_state_cmd->data = os_state;\r\nibmasm_exec_command(sp, cmd);\r\nibmasm_wait_for_response(cmd, IBMASM_CMD_TIMEOUT_NORMAL);\r\nif (cmd->status != IBMASM_CMD_COMPLETE)\r\nresult = -ENODEV;\r\ncommand_put(cmd);\r\nreturn result;\r\n}

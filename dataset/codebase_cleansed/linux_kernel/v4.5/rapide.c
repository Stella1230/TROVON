static void rapide_setup_ports(struct ide_hw *hw, void __iomem *base,\r\nvoid __iomem *ctrl, unsigned int sz, int irq)\r\n{\r\nunsigned long port = (unsigned long)base;\r\nint i;\r\nfor (i = 0; i <= 7; i++) {\r\nhw->io_ports_array[i] = port;\r\nport += sz;\r\n}\r\nhw->io_ports.ctl_addr = (unsigned long)ctrl;\r\nhw->irq = irq;\r\n}\r\nstatic int rapide_probe(struct expansion_card *ec, const struct ecard_id *id)\r\n{\r\nvoid __iomem *base;\r\nstruct ide_host *host;\r\nint ret;\r\nstruct ide_hw hw, *hws[] = { &hw };\r\nret = ecard_request_resources(ec);\r\nif (ret)\r\ngoto out;\r\nbase = ecardm_iomap(ec, ECARD_RES_MEMC, 0, 0);\r\nif (!base) {\r\nret = -ENOMEM;\r\ngoto release;\r\n}\r\nmemset(&hw, 0, sizeof(hw));\r\nrapide_setup_ports(&hw, base, base + 0x818, 1 << 6, ec->irq);\r\nhw.dev = &ec->dev;\r\nret = ide_host_add(&rapide_port_info, hws, 1, &host);\r\nif (ret)\r\ngoto release;\r\necard_set_drvdata(ec, host);\r\ngoto out;\r\nrelease:\r\necard_release_resources(ec);\r\nout:\r\nreturn ret;\r\n}\r\nstatic void rapide_remove(struct expansion_card *ec)\r\n{\r\nstruct ide_host *host = ecard_get_drvdata(ec);\r\necard_set_drvdata(ec, NULL);\r\nide_host_remove(host);\r\necard_release_resources(ec);\r\n}\r\nstatic int __init rapide_init(void)\r\n{\r\nreturn ecard_register_driver(&rapide_driver);\r\n}\r\nstatic void __exit rapide_exit(void)\r\n{\r\necard_remove_driver(&rapide_driver);\r\n}

static int lpc32xx_clcd_setup(struct clcd_fb *fb)\r\n{\r\ndma_addr_t dma;\r\nfb->fb.screen_base = dma_alloc_writecombine(&fb->dev->dev,\r\nPANEL_SIZE, &dma, GFP_KERNEL);\r\nif (!fb->fb.screen_base) {\r\nprintk(KERN_ERR "CLCD: unable to map framebuffer\n");\r\nreturn -ENOMEM;\r\n}\r\nfb->fb.fix.smem_start = dma;\r\nfb->fb.fix.smem_len = PANEL_SIZE;\r\nfb->panel = &conn_lcd_panel;\r\nif (gpio_request(LCD_POWER_GPIO, "LCD power"))\r\nprintk(KERN_ERR "Error requesting gpio %u",\r\nLCD_POWER_GPIO);\r\nelse if (gpio_direction_output(LCD_POWER_GPIO, 1))\r\nprintk(KERN_ERR "Error setting gpio %u to output",\r\nLCD_POWER_GPIO);\r\nif (gpio_request(BKL_POWER_GPIO, "LCD backlight power"))\r\nprintk(KERN_ERR "Error requesting gpio %u",\r\nBKL_POWER_GPIO);\r\nelse if (gpio_direction_output(BKL_POWER_GPIO, 1))\r\nprintk(KERN_ERR "Error setting gpio %u to output",\r\nBKL_POWER_GPIO);\r\nreturn 0;\r\n}\r\nstatic int lpc32xx_clcd_mmap(struct clcd_fb *fb, struct vm_area_struct *vma)\r\n{\r\nreturn dma_mmap_writecombine(&fb->dev->dev, vma,\r\nfb->fb.screen_base, fb->fb.fix.smem_start,\r\nfb->fb.fix.smem_len);\r\n}\r\nstatic void lpc32xx_clcd_remove(struct clcd_fb *fb)\r\n{\r\ndma_free_writecombine(&fb->dev->dev, fb->fb.fix.smem_len,\r\nfb->fb.screen_base, fb->fb.fix.smem_start);\r\n}\r\nstatic void clcd_disable(struct clcd_fb *fb)\r\n{\r\ngpio_set_value(BKL_POWER_GPIO, 0);\r\ngpio_set_value(LCD_POWER_GPIO, 0);\r\n}\r\nstatic void clcd_enable(struct clcd_fb *fb)\r\n{\r\ngpio_set_value(BKL_POWER_GPIO, 1);\r\ngpio_set_value(LCD_POWER_GPIO, 1);\r\n}\r\nstatic int pl08x_get_signal(const struct pl08x_channel_data *cd)\r\n{\r\nreturn cd->min_signal;\r\n}\r\nstatic void pl08x_put_signal(const struct pl08x_channel_data *cd, int ch)\r\n{\r\n}\r\nstatic int mmc_handle_ios(struct device *dev, struct mmc_ios *ios)\r\n{\r\nif (ios->power_mode == MMC_POWER_OFF)\r\ngpio_set_value(MMC_PWR_ENABLE_GPIO, 0);\r\nelse\r\ngpio_set_value(MMC_PWR_ENABLE_GPIO, 1);\r\nreturn 0;\r\n}\r\nstatic void __init lpc3250_machine_init(void)\r\n{\r\nu32 tmp;\r\ntmp = __raw_readl(LPC32XX_CLKPWR_LCDCLK_CTRL) &\r\n~(LPC32XX_CLKPWR_LCDCTRL_LCDTYPE_MSK |\r\nLPC32XX_CLKPWR_LCDCTRL_PSCALE_MSK);\r\ntmp |= LPC32XX_CLKPWR_LCDCTRL_LCDTYPE_TFT16;\r\n__raw_writel(tmp, LPC32XX_CLKPWR_LCDCLK_CTRL);\r\nlpc32xx_serial_init();\r\n__raw_writel(LPC32XX_CLKPWR_TESTCLK2_SEL_MOSC |\r\nLPC32XX_CLKPWR_TESTCLK_TESTCLK2_EN,\r\nLPC32XX_CLKPWR_TEST_CLK_SEL);\r\nof_platform_populate(NULL, of_default_bus_match_table,\r\nlpc32xx_auxdata_lookup, NULL);\r\n}

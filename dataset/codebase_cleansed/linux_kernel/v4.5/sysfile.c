static inline int is_global_system_inode(int type)\r\n{\r\nreturn type >= OCFS2_FIRST_ONLINE_SYSTEM_INODE &&\r\ntype <= OCFS2_LAST_GLOBAL_SYSTEM_INODE;\r\n}\r\nstatic struct inode **get_local_system_inode(struct ocfs2_super *osb,\r\nint type,\r\nu32 slot)\r\n{\r\nint index;\r\nstruct inode **local_system_inodes, **free = NULL;\r\nBUG_ON(slot == OCFS2_INVALID_SLOT);\r\nBUG_ON(type < OCFS2_FIRST_LOCAL_SYSTEM_INODE ||\r\ntype > OCFS2_LAST_LOCAL_SYSTEM_INODE);\r\nspin_lock(&osb->osb_lock);\r\nlocal_system_inodes = osb->local_system_inodes;\r\nspin_unlock(&osb->osb_lock);\r\nif (unlikely(!local_system_inodes)) {\r\nlocal_system_inodes = kzalloc(sizeof(struct inode *) *\r\nNUM_LOCAL_SYSTEM_INODES *\r\nosb->max_slots,\r\nGFP_NOFS);\r\nif (!local_system_inodes) {\r\nmlog_errno(-ENOMEM);\r\nreturn NULL;\r\n}\r\nspin_lock(&osb->osb_lock);\r\nif (osb->local_system_inodes) {\r\nfree = local_system_inodes;\r\nlocal_system_inodes = osb->local_system_inodes;\r\n} else\r\nosb->local_system_inodes = local_system_inodes;\r\nspin_unlock(&osb->osb_lock);\r\nkfree(free);\r\n}\r\nindex = (slot * NUM_LOCAL_SYSTEM_INODES) +\r\n(type - OCFS2_FIRST_LOCAL_SYSTEM_INODE);\r\nreturn &local_system_inodes[index];\r\n}\r\nstruct inode *ocfs2_get_system_file_inode(struct ocfs2_super *osb,\r\nint type,\r\nu32 slot)\r\n{\r\nstruct inode *inode = NULL;\r\nstruct inode **arr = NULL;\r\nif (is_global_system_inode(type)) {\r\narr = &(osb->global_system_inodes[type]);\r\n} else\r\narr = get_local_system_inode(osb, type, slot);\r\nmutex_lock(&osb->system_file_mutex);\r\nif (arr && ((inode = *arr) != NULL)) {\r\ninode = igrab(inode);\r\nmutex_unlock(&osb->system_file_mutex);\r\nBUG_ON(!inode);\r\nreturn inode;\r\n}\r\ninode = _ocfs2_get_system_file_inode(osb, type, slot);\r\nif (arr && inode) {\r\n*arr = igrab(inode);\r\nBUG_ON(!*arr);\r\n}\r\nmutex_unlock(&osb->system_file_mutex);\r\nreturn inode;\r\n}\r\nstatic struct inode * _ocfs2_get_system_file_inode(struct ocfs2_super *osb,\r\nint type,\r\nu32 slot)\r\n{\r\nchar namebuf[40];\r\nstruct inode *inode = NULL;\r\nu64 blkno;\r\nint status = 0;\r\nocfs2_sprintf_system_inode_name(namebuf,\r\nsizeof(namebuf),\r\ntype, slot);\r\nstatus = ocfs2_lookup_ino_from_name(osb->sys_root_inode, namebuf,\r\nstrlen(namebuf), &blkno);\r\nif (status < 0) {\r\ngoto bail;\r\n}\r\ninode = ocfs2_iget(osb, blkno, OCFS2_FI_FLAG_SYSFILE, type);\r\nif (IS_ERR(inode)) {\r\nmlog_errno(PTR_ERR(inode));\r\ninode = NULL;\r\ngoto bail;\r\n}\r\n#ifdef CONFIG_DEBUG_LOCK_ALLOC\r\nif (type == LOCAL_USER_QUOTA_SYSTEM_INODE ||\r\ntype == LOCAL_GROUP_QUOTA_SYSTEM_INODE ||\r\ntype == JOURNAL_SYSTEM_INODE) {\r\nOCFS2_I(inode)->ip_inode_lockres.l_lockdep_map.key = NULL;\r\n} else {\r\nlockdep_init_map(&OCFS2_I(inode)->ip_inode_lockres.\r\nl_lockdep_map,\r\nocfs2_system_inodes[type].si_name,\r\n&ocfs2_sysfile_cluster_lock_key[type], 0);\r\n}\r\n#endif\r\nbail:\r\nreturn inode;\r\n}

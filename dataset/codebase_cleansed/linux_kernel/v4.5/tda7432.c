static inline struct tda7432 *to_state(struct v4l2_subdev *sd)\r\n{\r\nreturn container_of(sd, struct tda7432, sd);\r\n}\r\nstatic inline struct v4l2_subdev *to_sd(struct v4l2_ctrl *ctrl)\r\n{\r\nreturn &container_of(ctrl->handler, struct tda7432, hdl)->sd;\r\n}\r\nstatic int tda7432_write(struct v4l2_subdev *sd, int subaddr, int val)\r\n{\r\nstruct i2c_client *client = v4l2_get_subdevdata(sd);\r\nunsigned char buffer[2];\r\nv4l2_dbg(2, debug, sd, "In tda7432_write\n");\r\nv4l2_dbg(1, debug, sd, "Writing %d 0x%x\n", subaddr, val);\r\nbuffer[0] = subaddr;\r\nbuffer[1] = val;\r\nif (2 != i2c_master_send(client, buffer, 2)) {\r\nv4l2_err(sd, "I/O error, trying (write %d 0x%x)\n",\r\nsubaddr, val);\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tda7432_set(struct v4l2_subdev *sd)\r\n{\r\nstruct i2c_client *client = v4l2_get_subdevdata(sd);\r\nunsigned char buf[16];\r\nbuf[0] = TDA7432_IN;\r\nbuf[1] = TDA7432_STEREO_IN |\r\nTDA7432_BASS_SYM |\r\nTDA7432_BASS_NORM;\r\nbuf[2] = 0x3b;\r\nif (loudness)\r\nbuf[2] |= TDA7432_LD_ON;\r\nbuf[3] = TDA7432_TREBLE_0DB | (TDA7432_BASS_0DB << 4);\r\nbuf[4] = TDA7432_ATTEN_0DB;\r\nbuf[5] = TDA7432_ATTEN_0DB;\r\nbuf[6] = TDA7432_ATTEN_0DB;\r\nbuf[7] = TDA7432_ATTEN_0DB;\r\nbuf[8] = loudness;\r\nif (9 != i2c_master_send(client, buf, 9)) {\r\nv4l2_err(sd, "I/O error, trying tda7432_set\n");\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tda7432_log_status(struct v4l2_subdev *sd)\r\n{\r\nstruct tda7432 *state = to_state(sd);\r\nv4l2_ctrl_handler_log_status(&state->hdl, sd->name);\r\nreturn 0;\r\n}\r\nstatic int tda7432_s_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstruct v4l2_subdev *sd = to_sd(ctrl);\r\nstruct tda7432 *t = to_state(sd);\r\nu8 bass, treble, volume;\r\nu8 lf, lr, rf, rr;\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_AUDIO_MUTE:\r\nif (t->balance->val < 0) {\r\nrr = rf = -t->balance->val;\r\nlr = lf = TDA7432_ATTEN_0DB;\r\n} else if (t->balance->val > 0) {\r\nrr = rf = TDA7432_ATTEN_0DB;\r\nlr = lf = t->balance->val;\r\n} else {\r\nrr = rf = TDA7432_ATTEN_0DB;\r\nlr = lf = TDA7432_ATTEN_0DB;\r\n}\r\nif (t->mute->val) {\r\nlf |= TDA7432_MUTE;\r\nlr |= TDA7432_MUTE;\r\nrf |= TDA7432_MUTE;\r\nrr |= TDA7432_MUTE;\r\n}\r\ntda7432_write(sd, TDA7432_LF, lf);\r\ntda7432_write(sd, TDA7432_LR, lr);\r\ntda7432_write(sd, TDA7432_RF, rf);\r\ntda7432_write(sd, TDA7432_RR, rr);\r\nreturn 0;\r\ncase V4L2_CID_AUDIO_VOLUME:\r\nvolume = 0x6f - ctrl->val;\r\nif (loudness)\r\nvolume |= TDA7432_LD_ON;\r\ntda7432_write(sd, TDA7432_VL, volume);\r\nreturn 0;\r\ncase V4L2_CID_AUDIO_BASS:\r\nbass = t->bass->val;\r\ntreble = t->treble->val;\r\nif (bass >= 0x8)\r\nbass = 14 - (bass - 8);\r\nif (treble >= 0x8)\r\ntreble = 14 - (treble - 8);\r\ntda7432_write(sd, TDA7432_TN, 0x10 | (bass << 4) | treble);\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int tda7432_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct tda7432 *t;\r\nstruct v4l2_subdev *sd;\r\nv4l_info(client, "chip found @ 0x%02x (%s)\n",\r\nclient->addr << 1, client->adapter->name);\r\nt = devm_kzalloc(&client->dev, sizeof(*t), GFP_KERNEL);\r\nif (!t)\r\nreturn -ENOMEM;\r\nsd = &t->sd;\r\nv4l2_i2c_subdev_init(sd, client, &tda7432_ops);\r\nv4l2_ctrl_handler_init(&t->hdl, 5);\r\nv4l2_ctrl_new_std(&t->hdl, &tda7432_ctrl_ops,\r\nV4L2_CID_AUDIO_VOLUME, 0, maxvol ? 0x68 : 0x4f, 1, maxvol ? 0x5d : 0x47);\r\nt->mute = v4l2_ctrl_new_std(&t->hdl, &tda7432_ctrl_ops,\r\nV4L2_CID_AUDIO_MUTE, 0, 1, 1, 0);\r\nt->balance = v4l2_ctrl_new_std(&t->hdl, &tda7432_ctrl_ops,\r\nV4L2_CID_AUDIO_BALANCE, -31, 31, 1, 0);\r\nt->bass = v4l2_ctrl_new_std(&t->hdl, &tda7432_ctrl_ops,\r\nV4L2_CID_AUDIO_BASS, 0, 14, 1, 7);\r\nt->treble = v4l2_ctrl_new_std(&t->hdl, &tda7432_ctrl_ops,\r\nV4L2_CID_AUDIO_TREBLE, 0, 14, 1, 7);\r\nsd->ctrl_handler = &t->hdl;\r\nif (t->hdl.error) {\r\nint err = t->hdl.error;\r\nv4l2_ctrl_handler_free(&t->hdl);\r\nreturn err;\r\n}\r\nv4l2_ctrl_cluster(2, &t->bass);\r\nv4l2_ctrl_cluster(2, &t->mute);\r\nv4l2_ctrl_handler_setup(&t->hdl);\r\nif (loudness < 0 || loudness > 15) {\r\nv4l2_warn(sd, "loudness parameter must be between 0 and 15\n");\r\nif (loudness < 0)\r\nloudness = 0;\r\nif (loudness > 15)\r\nloudness = 15;\r\n}\r\ntda7432_set(sd);\r\nreturn 0;\r\n}\r\nstatic int tda7432_remove(struct i2c_client *client)\r\n{\r\nstruct v4l2_subdev *sd = i2c_get_clientdata(client);\r\nstruct tda7432 *t = to_state(sd);\r\ntda7432_set(sd);\r\nv4l2_device_unregister_subdev(sd);\r\nv4l2_ctrl_handler_free(&t->hdl);\r\nreturn 0;\r\n}

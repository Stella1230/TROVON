static bool ms5611_prom_is_valid(u16 *prom, size_t len)\r\n{\r\nint i, j;\r\nuint16_t crc = 0, crc_orig = prom[7] & 0x000F;\r\nprom[7] &= 0xFF00;\r\nfor (i = 0; i < len * 2; i++) {\r\nif (i % 2 == 1)\r\ncrc ^= prom[i >> 1] & 0x00FF;\r\nelse\r\ncrc ^= prom[i >> 1] >> 8;\r\nfor (j = 0; j < 8; j++) {\r\nif (crc & 0x8000)\r\ncrc = (crc << 1) ^ 0x3000;\r\nelse\r\ncrc <<= 1;\r\n}\r\n}\r\ncrc = (crc >> 12) & 0x000F;\r\nreturn crc_orig != 0x0000 && crc == crc_orig;\r\n}\r\nstatic int ms5611_read_prom(struct iio_dev *indio_dev)\r\n{\r\nint ret, i;\r\nstruct ms5611_state *st = iio_priv(indio_dev);\r\nfor (i = 0; i < MS5611_PROM_WORDS_NB; i++) {\r\nret = st->read_prom_word(&indio_dev->dev,\r\ni, &st->chip_info->prom[i]);\r\nif (ret < 0) {\r\ndev_err(&indio_dev->dev,\r\n"failed to read prom at %d\n", i);\r\nreturn ret;\r\n}\r\n}\r\nif (!ms5611_prom_is_valid(st->chip_info->prom, MS5611_PROM_WORDS_NB)) {\r\ndev_err(&indio_dev->dev, "PROM integrity check failed\n");\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ms5611_read_temp_and_pressure(struct iio_dev *indio_dev,\r\ns32 *temp, s32 *pressure)\r\n{\r\nint ret;\r\nstruct ms5611_state *st = iio_priv(indio_dev);\r\nret = st->read_adc_temp_and_pressure(&indio_dev->dev, temp, pressure);\r\nif (ret < 0) {\r\ndev_err(&indio_dev->dev,\r\n"failed to read temperature and pressure\n");\r\nreturn ret;\r\n}\r\nreturn st->chip_info->temp_and_pressure_compensate(st->chip_info,\r\ntemp, pressure);\r\n}\r\nstatic int ms5611_temp_and_pressure_compensate(struct ms5611_chip_info *chip_info,\r\ns32 *temp, s32 *pressure)\r\n{\r\ns32 t = *temp, p = *pressure;\r\ns64 off, sens, dt;\r\ndt = t - (chip_info->prom[5] << 8);\r\noff = ((s64)chip_info->prom[2] << 16) + ((chip_info->prom[4] * dt) >> 7);\r\nsens = ((s64)chip_info->prom[1] << 15) + ((chip_info->prom[3] * dt) >> 8);\r\nt = 2000 + ((chip_info->prom[6] * dt) >> 23);\r\nif (t < 2000) {\r\ns64 off2, sens2, t2;\r\nt2 = (dt * dt) >> 31;\r\noff2 = (5 * (t - 2000) * (t - 2000)) >> 1;\r\nsens2 = off2 >> 1;\r\nif (t < -1500) {\r\ns64 tmp = (t + 1500) * (t + 1500);\r\noff2 += 7 * tmp;\r\nsens2 += (11 * tmp) >> 1;\r\n}\r\nt -= t2;\r\noff -= off2;\r\nsens -= sens2;\r\n}\r\n*temp = t;\r\n*pressure = (((p * sens) >> 21) - off) >> 15;\r\nreturn 0;\r\n}\r\nstatic int ms5607_temp_and_pressure_compensate(struct ms5611_chip_info *chip_info,\r\ns32 *temp, s32 *pressure)\r\n{\r\ns32 t = *temp, p = *pressure;\r\ns64 off, sens, dt;\r\ndt = t - (chip_info->prom[5] << 8);\r\noff = ((s64)chip_info->prom[2] << 17) + ((chip_info->prom[4] * dt) >> 6);\r\nsens = ((s64)chip_info->prom[1] << 16) + ((chip_info->prom[3] * dt) >> 7);\r\nt = 2000 + ((chip_info->prom[6] * dt) >> 23);\r\nif (t < 2000) {\r\ns64 off2, sens2, t2;\r\nt2 = (dt * dt) >> 31;\r\noff2 = (61 * (t - 2000) * (t - 2000)) >> 4;\r\nsens2 = off2 << 1;\r\nif (t < -1500) {\r\ns64 tmp = (t + 1500) * (t + 1500);\r\noff2 += 15 * tmp;\r\nsens2 += (8 * tmp);\r\n}\r\nt -= t2;\r\noff -= off2;\r\nsens -= sens2;\r\n}\r\n*temp = t;\r\n*pressure = (((p * sens) >> 21) - off) >> 15;\r\nreturn 0;\r\n}\r\nstatic int ms5611_reset(struct iio_dev *indio_dev)\r\n{\r\nint ret;\r\nstruct ms5611_state *st = iio_priv(indio_dev);\r\nret = st->reset(&indio_dev->dev);\r\nif (ret < 0) {\r\ndev_err(&indio_dev->dev, "failed to reset device\n");\r\nreturn ret;\r\n}\r\nusleep_range(3000, 4000);\r\nreturn 0;\r\n}\r\nstatic int ms5611_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint *val, int *val2, long mask)\r\n{\r\nint ret;\r\ns32 temp, pressure;\r\nstruct ms5611_state *st = iio_priv(indio_dev);\r\nswitch (mask) {\r\ncase IIO_CHAN_INFO_PROCESSED:\r\nmutex_lock(&st->lock);\r\nret = ms5611_read_temp_and_pressure(indio_dev,\r\n&temp, &pressure);\r\nmutex_unlock(&st->lock);\r\nif (ret < 0)\r\nreturn ret;\r\nswitch (chan->type) {\r\ncase IIO_TEMP:\r\n*val = temp * 10;\r\nreturn IIO_VAL_INT;\r\ncase IIO_PRESSURE:\r\n*val = pressure / 1000;\r\n*val2 = (pressure % 1000) * 1000;\r\nreturn IIO_VAL_INT_PLUS_MICRO;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int ms5611_init(struct iio_dev *indio_dev)\r\n{\r\nint ret;\r\nret = ms5611_reset(indio_dev);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn ms5611_read_prom(indio_dev);\r\n}\r\nint ms5611_probe(struct iio_dev *indio_dev, struct device *dev, int type)\r\n{\r\nint ret;\r\nstruct ms5611_state *st = iio_priv(indio_dev);\r\nmutex_init(&st->lock);\r\nst->chip_info = &chip_info_tbl[type];\r\nindio_dev->dev.parent = dev;\r\nindio_dev->name = dev->driver->name;\r\nindio_dev->info = &ms5611_info;\r\nindio_dev->channels = ms5611_channels;\r\nindio_dev->num_channels = ARRAY_SIZE(ms5611_channels);\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nret = ms5611_init(indio_dev);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn devm_iio_device_register(dev, indio_dev);\r\n}

static inline const char *dvb_card_str(unsigned int c)\r\n{\r\nswitch (c) {\r\ncase STV0367_TDA18212_NIMA_1: return "STV0367_TDA18212_NIMA_1";\r\ncase STV0367_TDA18212_NIMA_2: return "STV0367_TDA18212_NIMA_2";\r\ncase STV0367_TDA18212_NIMB_1: return "STV0367_TDA18212_NIMB_1";\r\ncase STV0367_TDA18212_NIMB_2: return "STV0367_TDA18212_NIMB_2";\r\ncase STV0903_6110_LNB24_NIMA: return "STV0903_6110_LNB24_NIMA";\r\ncase STV0903_6110_LNB24_NIMB: return "STV0903_6110_LNB24_NIMB";\r\ndefault: return "unknown dvb frontend card";\r\n}\r\n}\r\nint c8sectpfe_frontend_attach(struct dvb_frontend **fe,\r\nstruct c8sectpfe *c8sectpfe,\r\nstruct channel_info *tsin, int chan_num)\r\n{\r\nstruct tda18212_config *tda18212;\r\nstruct stv6110x_devctl *fe2;\r\nstruct i2c_client *client;\r\nstruct i2c_board_info tda18212_info = {\r\n.type = "tda18212",\r\n.addr = 0x60,\r\n};\r\nif (!tsin)\r\nreturn -EINVAL;\r\nswitch (tsin->dvb_card) {\r\ncase STV0367_TDA18212_NIMA_1:\r\ncase STV0367_TDA18212_NIMA_2:\r\ncase STV0367_TDA18212_NIMB_1:\r\ncase STV0367_TDA18212_NIMB_2:\r\nif (tsin->dvb_card == STV0367_TDA18212_NIMA_1)\r\n*fe = dvb_attach(stv0367ter_attach,\r\n&stv0367_tda18212_config[0],\r\ntsin->i2c_adapter);\r\nelse if (tsin->dvb_card == STV0367_TDA18212_NIMB_1)\r\n*fe = dvb_attach(stv0367ter_attach,\r\n&stv0367_tda18212_config[1],\r\ntsin->i2c_adapter);\r\nelse\r\n*fe = dvb_attach(stv0367ter_attach,\r\n&stv0367_tda18212_config[2],\r\ntsin->i2c_adapter);\r\nif (!*fe) {\r\ndev_err(c8sectpfe->device,\r\n"%s: stv0367ter_attach failed for NIM card %s\n"\r\n, __func__, dvb_card_str(tsin->dvb_card));\r\nreturn -ENODEV;\r\n};\r\n(*fe)->ops.init(*fe);\r\ntda18212 = devm_kzalloc(c8sectpfe->device,\r\nsizeof(struct tda18212_config),\r\nGFP_KERNEL);\r\nif (!tda18212) {\r\ndev_err(c8sectpfe->device,\r\n"%s: devm_kzalloc failed\n", __func__);\r\nreturn -ENOMEM;\r\n}\r\nmemcpy(tda18212, &tda18212_conf,\r\nsizeof(struct tda18212_config));\r\ntda18212->fe = (*fe);\r\ntda18212_info.platform_data = tda18212;\r\nrequest_module("tda18212");\r\nclient = i2c_new_device(tsin->i2c_adapter, &tda18212_info);\r\nif (!client || !client->dev.driver) {\r\ndvb_frontend_detach(*fe);\r\nreturn -ENODEV;\r\n}\r\nif (!try_module_get(client->dev.driver->owner)) {\r\ni2c_unregister_device(client);\r\ndvb_frontend_detach(*fe);\r\nreturn -ENODEV;\r\n}\r\ntsin->i2c_client = client;\r\nbreak;\r\ncase STV0903_6110_LNB24_NIMA:\r\n*fe = dvb_attach(stv090x_attach, &stv090x_config,\r\ntsin->i2c_adapter, STV090x_DEMODULATOR_0);\r\nif (!*fe) {\r\ndev_err(c8sectpfe->device, "%s: stv090x_attach failed\n"\r\n"\tfor NIM card %s\n",\r\n__func__, dvb_card_str(tsin->dvb_card));\r\nreturn -ENODEV;\r\n}\r\nfe2 = dvb_attach(stv6110x_attach, *fe,\r\n&stv6110x_config, tsin->i2c_adapter);\r\nif (!fe2) {\r\ndev_err(c8sectpfe->device,\r\n"%s: stv6110x_attach failed for NIM card %s\n"\r\n, __func__, dvb_card_str(tsin->dvb_card));\r\nreturn -ENODEV;\r\n};\r\nstv090x_config.tuner_init = fe2->tuner_init;\r\nstv090x_config.tuner_set_mode = fe2->tuner_set_mode;\r\nstv090x_config.tuner_set_frequency = fe2->tuner_set_frequency;\r\nstv090x_config.tuner_get_frequency = fe2->tuner_get_frequency;\r\nstv090x_config.tuner_set_bandwidth = fe2->tuner_set_bandwidth;\r\nstv090x_config.tuner_get_bandwidth = fe2->tuner_get_bandwidth;\r\nstv090x_config.tuner_set_bbgain = fe2->tuner_set_bbgain;\r\nstv090x_config.tuner_get_bbgain = fe2->tuner_get_bbgain;\r\nstv090x_config.tuner_set_refclk = fe2->tuner_set_refclk;\r\nstv090x_config.tuner_get_status = fe2->tuner_get_status;\r\ndvb_attach(lnbh24_attach, *fe, tsin->i2c_adapter, 0, 0, 0x9);\r\nbreak;\r\ndefault:\r\ndev_err(c8sectpfe->device,\r\n"%s: DVB frontend card %s not yet supported\n",\r\n__func__, dvb_card_str(tsin->dvb_card));\r\nreturn -ENODEV;\r\n}\r\n(*fe)->id = chan_num;\r\ndev_info(c8sectpfe->device,\r\n"DVB frontend card %s successfully attached",\r\ndvb_card_str(tsin->dvb_card));\r\nreturn 0;\r\n}

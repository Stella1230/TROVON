static int pwm_regulator_get_voltage_sel(struct regulator_dev *rdev)\r\n{\r\nstruct pwm_regulator_data *drvdata = rdev_get_drvdata(rdev);\r\nreturn drvdata->state;\r\n}\r\nstatic int pwm_regulator_set_voltage_sel(struct regulator_dev *rdev,\r\nunsigned selector)\r\n{\r\nstruct pwm_regulator_data *drvdata = rdev_get_drvdata(rdev);\r\nunsigned int pwm_reg_period;\r\nint dutycycle;\r\nint ret;\r\npwm_reg_period = pwm_get_period(drvdata->pwm);\r\ndutycycle = (pwm_reg_period *\r\ndrvdata->duty_cycle_table[selector].dutycycle) / 100;\r\nret = pwm_config(drvdata->pwm, dutycycle, pwm_reg_period);\r\nif (ret) {\r\ndev_err(&rdev->dev, "Failed to configure PWM\n");\r\nreturn ret;\r\n}\r\ndrvdata->state = selector;\r\nreturn 0;\r\n}\r\nstatic int pwm_regulator_list_voltage(struct regulator_dev *rdev,\r\nunsigned selector)\r\n{\r\nstruct pwm_regulator_data *drvdata = rdev_get_drvdata(rdev);\r\nif (selector >= rdev->desc->n_voltages)\r\nreturn -EINVAL;\r\nreturn drvdata->duty_cycle_table[selector].uV;\r\n}\r\nstatic int pwm_regulator_enable(struct regulator_dev *dev)\r\n{\r\nstruct pwm_regulator_data *drvdata = rdev_get_drvdata(dev);\r\nreturn pwm_enable(drvdata->pwm);\r\n}\r\nstatic int pwm_regulator_disable(struct regulator_dev *dev)\r\n{\r\nstruct pwm_regulator_data *drvdata = rdev_get_drvdata(dev);\r\npwm_disable(drvdata->pwm);\r\nreturn 0;\r\n}\r\nstatic int pwm_regulator_is_enabled(struct regulator_dev *dev)\r\n{\r\nstruct pwm_regulator_data *drvdata = rdev_get_drvdata(dev);\r\nreturn pwm_is_enabled(drvdata->pwm);\r\n}\r\nstatic int pwm_voltage_to_duty_cycle_percentage(struct regulator_dev *rdev, int req_uV)\r\n{\r\nint min_uV = rdev->constraints->min_uV;\r\nint max_uV = rdev->constraints->max_uV;\r\nint diff = max_uV - min_uV;\r\nreturn 100 - (((req_uV * 100) - (min_uV * 100)) / diff);\r\n}\r\nstatic int pwm_regulator_get_voltage(struct regulator_dev *rdev)\r\n{\r\nstruct pwm_regulator_data *drvdata = rdev_get_drvdata(rdev);\r\nreturn drvdata->volt_uV;\r\n}\r\nstatic int pwm_regulator_set_voltage(struct regulator_dev *rdev,\r\nint min_uV, int max_uV,\r\nunsigned *selector)\r\n{\r\nstruct pwm_regulator_data *drvdata = rdev_get_drvdata(rdev);\r\nunsigned int ramp_delay = rdev->constraints->ramp_delay;\r\nunsigned int period = pwm_get_period(drvdata->pwm);\r\nint duty_cycle;\r\nint ret;\r\nduty_cycle = pwm_voltage_to_duty_cycle_percentage(rdev, min_uV);\r\nret = pwm_config(drvdata->pwm, (period / 100) * duty_cycle, period);\r\nif (ret) {\r\ndev_err(&rdev->dev, "Failed to configure PWM\n");\r\nreturn ret;\r\n}\r\nret = pwm_enable(drvdata->pwm);\r\nif (ret) {\r\ndev_err(&rdev->dev, "Failed to enable PWM\n");\r\nreturn ret;\r\n}\r\ndrvdata->volt_uV = min_uV;\r\nusleep_range(ramp_delay, ramp_delay + 1000);\r\nreturn 0;\r\n}\r\nstatic int pwm_regulator_init_table(struct platform_device *pdev,\r\nstruct pwm_regulator_data *drvdata)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct pwm_voltages *duty_cycle_table;\r\nunsigned int length = 0;\r\nint ret;\r\nof_find_property(np, "voltage-table", &length);\r\nif ((length < sizeof(*duty_cycle_table)) ||\r\n(length % sizeof(*duty_cycle_table))) {\r\ndev_err(&pdev->dev,\r\n"voltage-table length(%d) is invalid\n",\r\nlength);\r\nreturn -EINVAL;\r\n}\r\nduty_cycle_table = devm_kzalloc(&pdev->dev, length, GFP_KERNEL);\r\nif (!duty_cycle_table)\r\nreturn -ENOMEM;\r\nret = of_property_read_u32_array(np, "voltage-table",\r\n(u32 *)duty_cycle_table,\r\nlength / sizeof(u32));\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to read voltage-table\n");\r\nreturn ret;\r\n}\r\ndrvdata->duty_cycle_table = duty_cycle_table;\r\npwm_regulator_desc.ops = &pwm_regulator_voltage_table_ops;\r\npwm_regulator_desc.n_voltages = length / sizeof(*duty_cycle_table);\r\nreturn 0;\r\n}\r\nstatic int pwm_regulator_init_continuous(struct platform_device *pdev,\r\nstruct pwm_regulator_data *drvdata)\r\n{\r\npwm_regulator_desc.ops = &pwm_regulator_voltage_continuous_ops;\r\npwm_regulator_desc.continuous_voltage_range = true;\r\nreturn 0;\r\n}\r\nstatic int pwm_regulator_probe(struct platform_device *pdev)\r\n{\r\nconst struct regulator_init_data *init_data;\r\nstruct pwm_regulator_data *drvdata;\r\nstruct regulator_dev *regulator;\r\nstruct regulator_config config = { };\r\nstruct device_node *np = pdev->dev.of_node;\r\nint ret;\r\nif (!np) {\r\ndev_err(&pdev->dev, "Device Tree node missing\n");\r\nreturn -EINVAL;\r\n}\r\ndrvdata = devm_kzalloc(&pdev->dev, sizeof(*drvdata), GFP_KERNEL);\r\nif (!drvdata)\r\nreturn -ENOMEM;\r\nif (of_find_property(np, "voltage-table", NULL))\r\nret = pwm_regulator_init_table(pdev, drvdata);\r\nelse\r\nret = pwm_regulator_init_continuous(pdev, drvdata);\r\nif (ret)\r\nreturn ret;\r\ninit_data = of_get_regulator_init_data(&pdev->dev, np,\r\n&pwm_regulator_desc);\r\nif (!init_data)\r\nreturn -ENOMEM;\r\nconfig.of_node = np;\r\nconfig.dev = &pdev->dev;\r\nconfig.driver_data = drvdata;\r\nconfig.init_data = init_data;\r\ndrvdata->pwm = devm_pwm_get(&pdev->dev, NULL);\r\nif (IS_ERR(drvdata->pwm)) {\r\ndev_err(&pdev->dev, "Failed to get PWM\n");\r\nreturn PTR_ERR(drvdata->pwm);\r\n}\r\nregulator = devm_regulator_register(&pdev->dev,\r\n&pwm_regulator_desc, &config);\r\nif (IS_ERR(regulator)) {\r\ndev_err(&pdev->dev, "Failed to register regulator %s\n",\r\npwm_regulator_desc.name);\r\nreturn PTR_ERR(regulator);\r\n}\r\nreturn 0;\r\n}

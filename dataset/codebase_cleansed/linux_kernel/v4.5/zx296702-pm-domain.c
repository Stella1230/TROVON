static int normal_power_off(struct generic_pm_domain *domain)\r\n{\r\nstruct zx_pm_domain *zpd = (struct zx_pm_domain *)domain;\r\nunsigned long loop = 1000;\r\nu32 tmp;\r\ntmp = readl_relaxed(pcubase + PCU_DM_CLKEN);\r\ntmp &= ~BIT(zpd->bit);\r\nwritel_relaxed(tmp, pcubase + PCU_DM_CLKEN);\r\nudelay(5);\r\ntmp = readl_relaxed(pcubase + PCU_DM_ISOEN);\r\ntmp &= ~BIT(zpd->bit);\r\nwritel_relaxed(tmp | BIT(zpd->bit), pcubase + PCU_DM_ISOEN);\r\nudelay(5);\r\ntmp = readl_relaxed(pcubase + PCU_DM_RSTEN);\r\ntmp &= ~BIT(zpd->bit);\r\nwritel_relaxed(tmp, pcubase + PCU_DM_RSTEN);\r\nudelay(5);\r\ntmp = readl_relaxed(pcubase + PCU_DM_PWRDN);\r\ntmp &= ~BIT(zpd->bit);\r\nwritel_relaxed(tmp | BIT(zpd->bit), pcubase + PCU_DM_PWRDN);\r\ndo {\r\ntmp = readl_relaxed(pcubase + PCU_DM_ACK_SYNC) & BIT(zpd->bit);\r\n} while (--loop && !tmp);\r\nif (!loop) {\r\npr_err("Error: %s %s fail\n", __func__, domain->name);\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int normal_power_on(struct generic_pm_domain *domain)\r\n{\r\nstruct zx_pm_domain *zpd = (struct zx_pm_domain *)domain;\r\nunsigned long loop = 10000;\r\nu32 tmp;\r\ntmp = readl_relaxed(pcubase + PCU_DM_PWRDN);\r\ntmp &= ~BIT(zpd->bit);\r\nwritel_relaxed(tmp, pcubase + PCU_DM_PWRDN);\r\ndo {\r\ntmp = readl_relaxed(pcubase + PCU_DM_ACK_SYNC) & BIT(zpd->bit);\r\n} while (--loop && tmp);\r\nif (!loop) {\r\npr_err("Error: %s %s fail\n", __func__, domain->name);\r\nreturn -EIO;\r\n}\r\ntmp = readl_relaxed(pcubase + PCU_DM_RSTEN);\r\ntmp &= ~BIT(zpd->bit);\r\nwritel_relaxed(tmp | BIT(zpd->bit), pcubase + PCU_DM_RSTEN);\r\nudelay(5);\r\ntmp = readl_relaxed(pcubase + PCU_DM_ISOEN);\r\ntmp &= ~BIT(zpd->bit);\r\nwritel_relaxed(tmp, pcubase + PCU_DM_ISOEN);\r\nudelay(5);\r\ntmp = readl_relaxed(pcubase + PCU_DM_CLKEN);\r\ntmp &= ~BIT(zpd->bit);\r\nwritel_relaxed(tmp | BIT(zpd->bit), pcubase + PCU_DM_CLKEN);\r\nudelay(5);\r\nreturn 0;\r\n}\r\nstatic int zx296702_pd_probe(struct platform_device *pdev)\r\n{\r\nstruct genpd_onecell_data *genpd_data;\r\nstruct resource *res;\r\nint i;\r\ngenpd_data = devm_kzalloc(&pdev->dev, sizeof(*genpd_data), GFP_KERNEL);\r\nif (!genpd_data)\r\nreturn -ENOMEM;\r\ngenpd_data->domains = zx296702_pm_domains;\r\ngenpd_data->num_domains = ARRAY_SIZE(zx296702_pm_domains);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\ndev_err(&pdev->dev, "no memory resource defined\n");\r\nreturn -ENODEV;\r\n}\r\npcubase = devm_ioremap_resource(&pdev->dev, res);\r\nif (!pcubase) {\r\ndev_err(&pdev->dev, "ioremap fail.\n");\r\nreturn -EIO;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(zx296702_pm_domains); ++i)\r\npm_genpd_init(zx296702_pm_domains[i], NULL, false);\r\nof_genpd_add_provider_onecell(pdev->dev.of_node, genpd_data);\r\nreturn 0;\r\n}\r\nstatic int __init zx296702_pd_init(void)\r\n{\r\nreturn platform_driver_register(&zx296702_pd_driver);\r\n}

static void rm7k_sc_wback_inv(unsigned long addr, unsigned long size)\r\n{\r\nunsigned long end, a;\r\npr_debug("rm7k_sc_wback_inv[%08lx,%08lx]", addr, size);\r\nBUG_ON(size == 0);\r\nblast_scache_range(addr, addr + size);\r\nif (!rm7k_tcache_init)\r\nreturn;\r\na = addr & ~(tc_pagesize - 1);\r\nend = (addr + size - 1) & ~(tc_pagesize - 1);\r\nwhile(1) {\r\ninvalidate_tcache_page(a);\r\nif (a == end)\r\nbreak;\r\na += tc_pagesize;\r\n}\r\n}\r\nstatic void rm7k_sc_inv(unsigned long addr, unsigned long size)\r\n{\r\nunsigned long end, a;\r\npr_debug("rm7k_sc_inv[%08lx,%08lx]", addr, size);\r\nBUG_ON(size == 0);\r\nblast_inv_scache_range(addr, addr + size);\r\nif (!rm7k_tcache_init)\r\nreturn;\r\na = addr & ~(tc_pagesize - 1);\r\nend = (addr + size - 1) & ~(tc_pagesize - 1);\r\nwhile(1) {\r\ninvalidate_tcache_page(a);\r\nif (a == end)\r\nbreak;\r\na += tc_pagesize;\r\n}\r\n}\r\nstatic void blast_rm7k_tcache(void)\r\n{\r\nunsigned long start = CKSEG0ADDR(0);\r\nunsigned long end = start + tcache_size;\r\nwrite_c0_taglo(0);\r\nwhile (start < end) {\r\ncache_op(Page_Invalidate_T, start);\r\nstart += tc_pagesize;\r\n}\r\n}\r\nstatic void __rm7k_tc_enable(void)\r\n{\r\nint i;\r\nset_c0_config(RM7K_CONF_TE);\r\nwrite_c0_taglo(0);\r\nwrite_c0_taghi(0);\r\nfor (i = 0; i < tcache_size; i += tc_lsize)\r\ncache_op(Index_Store_Tag_T, CKSEG0ADDR(i));\r\n}\r\nstatic void rm7k_tc_enable(void)\r\n{\r\nif (read_c0_config() & RM7K_CONF_TE)\r\nreturn;\r\nBUG_ON(tcache_size == 0);\r\nrun_uncached(__rm7k_tc_enable);\r\n}\r\nstatic void __rm7k_sc_enable(void)\r\n{\r\nint i;\r\nset_c0_config(RM7K_CONF_SE);\r\nwrite_c0_taglo(0);\r\nwrite_c0_taghi(0);\r\nfor (i = 0; i < scache_size; i += sc_lsize)\r\ncache_op(Index_Store_Tag_SD, CKSEG0ADDR(i));\r\n}\r\nstatic void rm7k_sc_enable(void)\r\n{\r\nif (read_c0_config() & RM7K_CONF_SE)\r\nreturn;\r\npr_info("Enabling secondary cache...\n");\r\nrun_uncached(__rm7k_sc_enable);\r\nif (rm7k_tcache_init)\r\nrm7k_tc_enable();\r\n}\r\nstatic void rm7k_tc_disable(void)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nblast_rm7k_tcache();\r\nclear_c0_config(RM7K_CONF_TE);\r\nlocal_irq_save(flags);\r\n}\r\nstatic void rm7k_sc_disable(void)\r\n{\r\nclear_c0_config(RM7K_CONF_SE);\r\nif (rm7k_tcache_init)\r\nrm7k_tc_disable();\r\n}\r\nstatic void __probe_tcache(void)\r\n{\r\nunsigned long flags, addr, begin, end, pow2;\r\nbegin = (unsigned long) &_stext;\r\nbegin &= ~((8 * 1024 * 1024) - 1);\r\nend = begin + (8 * 1024 * 1024);\r\nlocal_irq_save(flags);\r\nset_c0_config(RM7K_CONF_TE);\r\npow2 = (256 * 1024);\r\nfor (addr = begin; addr <= end; addr = (begin + pow2)) {\r\nunsigned long *p = (unsigned long *) addr;\r\n__asm__ __volatile__("nop" : : "r" (*p));\r\npow2 <<= 1;\r\n}\r\nwrite_c0_taglo(0);\r\nwrite_c0_taghi(0);\r\ncache_op(Index_Store_Tag_T, begin);\r\npow2 = (512 * 1024);\r\nfor (addr = begin + (512 * 1024); addr <= end; addr = begin + pow2) {\r\ncache_op(Index_Load_Tag_T, addr);\r\nif (!read_c0_taglo())\r\nbreak;\r\npow2 <<= 1;\r\n}\r\naddr -= begin;\r\ntcache_size = addr;\r\nclear_c0_config(RM7K_CONF_TE);\r\nlocal_irq_restore(flags);\r\n}\r\nvoid rm7k_sc_init(void)\r\n{\r\nstruct cpuinfo_mips *c = &current_cpu_data;\r\nunsigned int config = read_c0_config();\r\nif ((config & RM7K_CONF_SC))\r\nreturn;\r\nc->scache.linesz = sc_lsize;\r\nc->scache.ways = 4;\r\nc->scache.waybit= __ffs(scache_size / c->scache.ways);\r\nc->scache.waysize = scache_size / c->scache.ways;\r\nc->scache.sets = scache_size / (c->scache.linesz * c->scache.ways);\r\nprintk(KERN_INFO "Secondary cache size %dK, linesize %d bytes.\n",\r\n(scache_size >> 10), sc_lsize);\r\nif (!(config & RM7K_CONF_SE))\r\nrm7k_sc_enable();\r\nbcops = &rm7k_sc_ops;\r\nrm7k_tcache_init = 0;\r\ntcache_size = 0;\r\nif (config & RM7K_CONF_TC)\r\nreturn;\r\nrun_uncached(__probe_tcache);\r\nrm7k_tc_enable();\r\nrm7k_tcache_init = 1;\r\nc->tcache.linesz = tc_lsize;\r\nc->tcache.ways = 1;\r\npr_info("Tertiary cache size %ldK.\n", (tcache_size >> 10));\r\n}

void btcx_riscmem_free(struct pci_dev *pci,\r\nstruct btcx_riscmem *risc)\r\n{\r\nif (NULL == risc->cpu)\r\nreturn;\r\nif (btcx_debug) {\r\nmemcnt--;\r\nprintk("btcx: riscmem free [%d] dma=%lx\n",\r\nmemcnt, (unsigned long)risc->dma);\r\n}\r\npci_free_consistent(pci, risc->size, risc->cpu, risc->dma);\r\nmemset(risc,0,sizeof(*risc));\r\n}\r\nint btcx_riscmem_alloc(struct pci_dev *pci,\r\nstruct btcx_riscmem *risc,\r\nunsigned int size)\r\n{\r\n__le32 *cpu;\r\ndma_addr_t dma = 0;\r\nif (NULL != risc->cpu && risc->size < size)\r\nbtcx_riscmem_free(pci,risc);\r\nif (NULL == risc->cpu) {\r\ncpu = pci_alloc_consistent(pci, size, &dma);\r\nif (NULL == cpu)\r\nreturn -ENOMEM;\r\nrisc->cpu = cpu;\r\nrisc->dma = dma;\r\nrisc->size = size;\r\nif (btcx_debug) {\r\nmemcnt++;\r\nprintk("btcx: riscmem alloc [%d] dma=%lx cpu=%p size=%d\n",\r\nmemcnt, (unsigned long)dma, cpu, size);\r\n}\r\n}\r\nmemset(risc->cpu,0,risc->size);\r\nreturn 0;\r\n}\r\nint\r\nbtcx_screen_clips(int swidth, int sheight, struct v4l2_rect *win,\r\nstruct v4l2_clip *clips, unsigned int n)\r\n{\r\nif (win->left < 0) {\r\nclips[n].c.left = 0;\r\nclips[n].c.top = 0;\r\nclips[n].c.width = -win->left;\r\nclips[n].c.height = win->height;\r\nn++;\r\n}\r\nif (win->left + win->width > swidth) {\r\nclips[n].c.left = swidth - win->left;\r\nclips[n].c.top = 0;\r\nclips[n].c.width = win->width - clips[n].c.left;\r\nclips[n].c.height = win->height;\r\nn++;\r\n}\r\nif (win->top < 0) {\r\nclips[n].c.left = 0;\r\nclips[n].c.top = 0;\r\nclips[n].c.width = win->width;\r\nclips[n].c.height = -win->top;\r\nn++;\r\n}\r\nif (win->top + win->height > sheight) {\r\nclips[n].c.left = 0;\r\nclips[n].c.top = sheight - win->top;\r\nclips[n].c.width = win->width;\r\nclips[n].c.height = win->height - clips[n].c.top;\r\nn++;\r\n}\r\nreturn n;\r\n}\r\nint\r\nbtcx_align(struct v4l2_rect *win, struct v4l2_clip *clips, unsigned int n, int mask)\r\n{\r\ns32 nx,nw,dx;\r\nunsigned int i;\r\nnx = (win->left + mask) & ~mask;\r\nnw = (win->width) & ~mask;\r\nif (nx + nw > win->left + win->width)\r\nnw -= mask+1;\r\ndx = nx - win->left;\r\nwin->left = nx;\r\nwin->width = nw;\r\nif (btcx_debug)\r\nprintk(KERN_DEBUG "btcx: window align %dx%d+%d+%d [dx=%d]\n",\r\nwin->width, win->height, win->left, win->top, dx);\r\nfor (i = 0; i < n; i++) {\r\nnx = (clips[i].c.left-dx) & ~mask;\r\nnw = (clips[i].c.width) & ~mask;\r\nif (nx + nw < clips[i].c.left-dx + clips[i].c.width)\r\nnw += mask+1;\r\nclips[i].c.left = nx;\r\nclips[i].c.width = nw;\r\nif (btcx_debug)\r\nprintk(KERN_DEBUG "btcx: clip align %dx%d+%d+%d\n",\r\nclips[i].c.width, clips[i].c.height,\r\nclips[i].c.left, clips[i].c.top);\r\n}\r\nreturn 0;\r\n}\r\nvoid\r\nbtcx_sort_clips(struct v4l2_clip *clips, unsigned int nclips)\r\n{\r\nint i,j,n;\r\nif (nclips < 2)\r\nreturn;\r\nfor (i = nclips-2; i >= 0; i--) {\r\nfor (n = 0, j = 0; j <= i; j++) {\r\nif (clips[j].c.left > clips[j+1].c.left) {\r\nswap(clips[j], clips[j + 1]);\r\nn++;\r\n}\r\n}\r\nif (0 == n)\r\nbreak;\r\n}\r\n}\r\nvoid\r\nbtcx_calc_skips(int line, int width, int *maxy,\r\nstruct btcx_skiplist *skips, unsigned int *nskips,\r\nconst struct v4l2_clip *clips, unsigned int nclips)\r\n{\r\nunsigned int clip,skip;\r\nint end, maxline;\r\nskip=0;\r\nmaxline = 9999;\r\nfor (clip = 0; clip < nclips; clip++) {\r\nif (clips[clip].c.left + clips[clip].c.width <= 0)\r\ncontinue;\r\nif (clips[clip].c.left > (signed)width)\r\nbreak;\r\nif (line > clips[clip].c.top+clips[clip].c.height-1)\r\ncontinue;\r\nif (line < clips[clip].c.top) {\r\nif (maxline > clips[clip].c.top-1)\r\nmaxline = clips[clip].c.top-1;\r\ncontinue;\r\n}\r\nif (maxline > clips[clip].c.top+clips[clip].c.height-1)\r\nmaxline = clips[clip].c.top+clips[clip].c.height-1;\r\nif (0 == skip || clips[clip].c.left > skips[skip-1].end) {\r\nskips[skip].start = clips[clip].c.left;\r\nif (skips[skip].start < 0)\r\nskips[skip].start = 0;\r\nskips[skip].end = clips[clip].c.left + clips[clip].c.width;\r\nif (skips[skip].end > width)\r\nskips[skip].end = width;\r\nskip++;\r\n} else {\r\nend = clips[clip].c.left + clips[clip].c.width;\r\nif (skips[skip-1].end < end)\r\nskips[skip-1].end = end;\r\nif (skips[skip-1].end > width)\r\nskips[skip-1].end = width;\r\n}\r\n}\r\n*nskips = skip;\r\n*maxy = maxline;\r\nif (btcx_debug) {\r\nprintk(KERN_DEBUG "btcx: skips line %d-%d:",line,maxline);\r\nfor (skip = 0; skip < *nskips; skip++) {\r\nprintk(" %d-%d",skips[skip].start,skips[skip].end);\r\n}\r\nprintk("\n");\r\n}\r\n}

void bacct_add_tsk(struct user_namespace *user_ns,\r\nstruct pid_namespace *pid_ns,\r\nstruct taskstats *stats, struct task_struct *tsk)\r\n{\r\nconst struct cred *tcred;\r\ncputime_t utime, stime, utimescaled, stimescaled;\r\nu64 delta;\r\nBUILD_BUG_ON(TS_COMM_LEN < TASK_COMM_LEN);\r\ndelta = ktime_get_ns() - tsk->start_time;\r\ndo_div(delta, NSEC_PER_USEC);\r\nstats->ac_etime = delta;\r\ndo_div(delta, USEC_PER_SEC);\r\nstats->ac_btime = get_seconds() - delta;\r\nif (thread_group_leader(tsk)) {\r\nstats->ac_exitcode = tsk->exit_code;\r\nif (tsk->flags & PF_FORKNOEXEC)\r\nstats->ac_flag |= AFORK;\r\n}\r\nif (tsk->flags & PF_SUPERPRIV)\r\nstats->ac_flag |= ASU;\r\nif (tsk->flags & PF_DUMPCORE)\r\nstats->ac_flag |= ACORE;\r\nif (tsk->flags & PF_SIGNALED)\r\nstats->ac_flag |= AXSIG;\r\nstats->ac_nice = task_nice(tsk);\r\nstats->ac_sched = tsk->policy;\r\nstats->ac_pid = task_pid_nr_ns(tsk, pid_ns);\r\nrcu_read_lock();\r\ntcred = __task_cred(tsk);\r\nstats->ac_uid = from_kuid_munged(user_ns, tcred->uid);\r\nstats->ac_gid = from_kgid_munged(user_ns, tcred->gid);\r\nstats->ac_ppid = pid_alive(tsk) ?\r\ntask_tgid_nr_ns(rcu_dereference(tsk->real_parent), pid_ns) : 0;\r\nrcu_read_unlock();\r\ntask_cputime(tsk, &utime, &stime);\r\nstats->ac_utime = cputime_to_usecs(utime);\r\nstats->ac_stime = cputime_to_usecs(stime);\r\ntask_cputime_scaled(tsk, &utimescaled, &stimescaled);\r\nstats->ac_utimescaled = cputime_to_usecs(utimescaled);\r\nstats->ac_stimescaled = cputime_to_usecs(stimescaled);\r\nstats->ac_minflt = tsk->min_flt;\r\nstats->ac_majflt = tsk->maj_flt;\r\nstrncpy(stats->ac_comm, tsk->comm, sizeof(stats->ac_comm));\r\n}\r\nvoid xacct_add_tsk(struct taskstats *stats, struct task_struct *p)\r\n{\r\nstruct mm_struct *mm;\r\nstats->coremem = p->acct_rss_mem1 * PAGE_SIZE / MB;\r\nstats->virtmem = p->acct_vm_mem1 * PAGE_SIZE / MB;\r\nmm = get_task_mm(p);\r\nif (mm) {\r\nstats->hiwater_rss = get_mm_hiwater_rss(mm) * PAGE_SIZE / KB;\r\nstats->hiwater_vm = get_mm_hiwater_vm(mm) * PAGE_SIZE / KB;\r\nmmput(mm);\r\n}\r\nstats->read_char = p->ioac.rchar & KB_MASK;\r\nstats->write_char = p->ioac.wchar & KB_MASK;\r\nstats->read_syscalls = p->ioac.syscr & KB_MASK;\r\nstats->write_syscalls = p->ioac.syscw & KB_MASK;\r\n#ifdef CONFIG_TASK_IO_ACCOUNTING\r\nstats->read_bytes = p->ioac.read_bytes & KB_MASK;\r\nstats->write_bytes = p->ioac.write_bytes & KB_MASK;\r\nstats->cancelled_write_bytes = p->ioac.cancelled_write_bytes & KB_MASK;\r\n#else\r\nstats->read_bytes = 0;\r\nstats->write_bytes = 0;\r\nstats->cancelled_write_bytes = 0;\r\n#endif\r\n}\r\nstatic void __acct_update_integrals(struct task_struct *tsk,\r\ncputime_t utime, cputime_t stime)\r\n{\r\nif (likely(tsk->mm)) {\r\ncputime_t time, dtime;\r\nstruct timeval value;\r\nunsigned long flags;\r\nu64 delta;\r\nlocal_irq_save(flags);\r\ntime = stime + utime;\r\ndtime = time - tsk->acct_timexpd;\r\njiffies_to_timeval(cputime_to_jiffies(dtime), &value);\r\ndelta = value.tv_sec;\r\ndelta = delta * USEC_PER_SEC + value.tv_usec;\r\nif (delta == 0)\r\ngoto out;\r\ntsk->acct_timexpd = time;\r\ntsk->acct_rss_mem1 += delta * get_mm_rss(tsk->mm);\r\ntsk->acct_vm_mem1 += delta * tsk->mm->total_vm;\r\nout:\r\nlocal_irq_restore(flags);\r\n}\r\n}\r\nvoid acct_update_integrals(struct task_struct *tsk)\r\n{\r\ncputime_t utime, stime;\r\ntask_cputime(tsk, &utime, &stime);\r\n__acct_update_integrals(tsk, utime, stime);\r\n}\r\nvoid acct_account_cputime(struct task_struct *tsk)\r\n{\r\n__acct_update_integrals(tsk, tsk->utime, tsk->stime);\r\n}\r\nvoid acct_clear_integrals(struct task_struct *tsk)\r\n{\r\ntsk->acct_timexpd = 0;\r\ntsk->acct_rss_mem1 = 0;\r\ntsk->acct_vm_mem1 = 0;\r\n}

efi_status_t __init handle_kernel_image(efi_system_table_t *sys_table_arg,\r\nunsigned long *image_addr,\r\nunsigned long *image_size,\r\nunsigned long *reserve_addr,\r\nunsigned long *reserve_size,\r\nunsigned long dram_base,\r\nefi_loaded_image_t *image)\r\n{\r\nefi_status_t status;\r\nunsigned long kernel_size, kernel_memsize = 0;\r\nunsigned long nr_pages;\r\nvoid *old_image_addr = (void *)*image_addr;\r\nunsigned long preferred_offset;\r\npreferred_offset = round_down(dram_base, SZ_2M) + TEXT_OFFSET;\r\nif (preferred_offset < dram_base)\r\npreferred_offset += SZ_2M;\r\nkernel_size = _edata - _text;\r\nif (*image_addr != preferred_offset) {\r\nkernel_memsize = kernel_size + (_end - _edata);\r\n*image_addr = *reserve_addr = preferred_offset;\r\nnr_pages = round_up(kernel_memsize, EFI_ALLOC_ALIGN) /\r\nEFI_PAGE_SIZE;\r\nstatus = efi_call_early(allocate_pages, EFI_ALLOCATE_ADDRESS,\r\nEFI_LOADER_DATA, nr_pages,\r\n(efi_physical_addr_t *)reserve_addr);\r\nif (status != EFI_SUCCESS) {\r\nkernel_memsize += TEXT_OFFSET;\r\nstatus = efi_low_alloc(sys_table_arg, kernel_memsize,\r\nSZ_2M, reserve_addr);\r\nif (status != EFI_SUCCESS) {\r\npr_efi_err(sys_table_arg, "Failed to relocate kernel\n");\r\nreturn status;\r\n}\r\n*image_addr = *reserve_addr + TEXT_OFFSET;\r\n}\r\nmemcpy((void *)*image_addr, old_image_addr, kernel_size);\r\n*reserve_size = kernel_memsize;\r\n}\r\nreturn EFI_SUCCESS;\r\n}

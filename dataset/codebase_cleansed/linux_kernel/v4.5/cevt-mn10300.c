static int next_event(unsigned long delta,\r\nstruct clock_event_device *evt)\r\n{\r\nunsigned int cpu = smp_processor_id();\r\nif (cpu == 0) {\r\nstop_jiffies_counter();\r\nreload_jiffies_counter(delta - 1);\r\n} else {\r\nstop_jiffies_counter1();\r\nreload_jiffies_counter1(delta - 1);\r\n}\r\nreturn 0;\r\n}\r\nstatic irqreturn_t timer_interrupt(int irq, void *dev_id)\r\n{\r\nstruct clock_event_device *cd;\r\nunsigned int cpu = smp_processor_id();\r\nif (cpu == 0)\r\nstop_jiffies_counter();\r\nelse\r\nstop_jiffies_counter1();\r\ncd = &per_cpu(mn10300_clockevent_device, cpu);\r\ncd->event_handler(cd);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void event_handler(struct clock_event_device *dev)\r\n{\r\n}\r\nstatic inline void setup_jiffies_interrupt(int irq,\r\nstruct irqaction *action)\r\n{\r\nu16 tmp;\r\nsetup_irq(irq, action);\r\nset_intr_level(irq, NUM2GxICR_LEVEL(CONFIG_TIMER_IRQ_LEVEL));\r\nGxICR(irq) |= GxICR_ENABLE | GxICR_DETECT | GxICR_REQUEST;\r\ntmp = GxICR(irq);\r\n}\r\nint __init init_clockevents(void)\r\n{\r\nstruct clock_event_device *cd;\r\nstruct irqaction *iact;\r\nunsigned int cpu = smp_processor_id();\r\ncd = &per_cpu(mn10300_clockevent_device, cpu);\r\nif (cpu == 0) {\r\nstop_jiffies_counter();\r\ncd->irq = TMJCIRQ;\r\n} else {\r\nstop_jiffies_counter1();\r\ncd->irq = TMJC1IRQ;\r\n}\r\ncd->name = "Timestamp";\r\ncd->features = CLOCK_EVT_FEAT_ONESHOT;\r\nclockevents_calc_mult_shift(cd, MN10300_JCCLK, 1);\r\ncd->max_delta_ns = clockevent_delta2ns(TMJCBR_MAX, cd);\r\ncd->min_delta_ns = clockevent_delta2ns(100, cd);\r\ncd->rating = 200;\r\ncd->cpumask = cpumask_of(smp_processor_id());\r\ncd->event_handler = event_handler;\r\ncd->set_next_event = next_event;\r\niact = &per_cpu(timer_irq, cpu);\r\niact->flags = IRQF_SHARED | IRQF_TIMER;\r\niact->handler = timer_interrupt;\r\nclockevents_register_device(cd);\r\n#if defined(CONFIG_SMP) && !defined(CONFIG_GENERIC_CLOCKEVENTS_BROADCAST)\r\n{\r\nstruct irq_data *data;\r\ndata = irq_get_irq_data(cd->irq);\r\ncpumask_copy(irq_data_get_affinity_mask(data), cpumask_of(cpu));\r\niact->flags |= IRQF_NOBALANCING;\r\n}\r\n#endif\r\nif (cpu == 0) {\r\nreload_jiffies_counter(MN10300_JC_PER_HZ - 1);\r\niact->name = "CPU0 Timer";\r\n} else {\r\nreload_jiffies_counter1(MN10300_JC_PER_HZ - 1);\r\niact->name = "CPU1 Timer";\r\n}\r\nsetup_jiffies_interrupt(cd->irq, iact);\r\nreturn 0;\r\n}

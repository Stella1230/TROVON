void dml_start_xfer(struct mmci_host *host, struct mmc_data *data)\r\n{\r\nu32 config;\r\nvoid __iomem *base = host->base + DML_OFFSET;\r\nif (data->flags & MMC_DATA_READ) {\r\nconfig = readl_relaxed(base + DML_CONFIG);\r\nconfig = (config & ~PRODUCER_CRCI_MSK) | PRODUCER_CRCI_X_SEL;\r\nconfig = (config & ~CONSUMER_CRCI_MSK) | CONSUMER_CRCI_DISABLE;\r\nwritel_relaxed(config, base + DML_CONFIG);\r\nwritel_relaxed(data->blksz, base + DML_PRODUCER_BAM_BLOCK_SIZE);\r\nwritel_relaxed(data->blocks * data->blksz,\r\nbase + DML_PRODUCER_BAM_TRANS_SIZE);\r\nconfig = readl_relaxed(base + DML_CONFIG);\r\nconfig |= PRODUCER_TRANS_END_EN;\r\nwritel_relaxed(config, base + DML_CONFIG);\r\nwritel_relaxed(1, base + DML_PRODUCER_START);\r\n} else {\r\nconfig = readl_relaxed(base + DML_CONFIG);\r\nconfig = (config & ~CONSUMER_CRCI_MSK) | CONSUMER_CRCI_X_SEL;\r\nconfig = (config & ~PRODUCER_CRCI_MSK) | PRODUCER_CRCI_DISABLE;\r\nwritel_relaxed(config, base + DML_CONFIG);\r\nconfig = readl_relaxed(base + DML_CONFIG);\r\nconfig &= ~PRODUCER_TRANS_END_EN;\r\nwritel_relaxed(config, base + DML_CONFIG);\r\nwritel_relaxed(1, base + DML_CONSUMER_START);\r\n}\r\nwmb();\r\n}\r\nstatic int of_get_dml_pipe_index(struct device_node *np, const char *name)\r\n{\r\nint index;\r\nstruct of_phandle_args dma_spec;\r\nindex = of_property_match_string(np, "dma-names", name);\r\nif (index < 0)\r\nreturn -ENODEV;\r\nif (of_parse_phandle_with_args(np, "dmas", "#dma-cells", index,\r\n&dma_spec))\r\nreturn -ENODEV;\r\nif (dma_spec.args_count)\r\nreturn dma_spec.args[0];\r\nreturn -ENODEV;\r\n}\r\nint dml_hw_init(struct mmci_host *host, struct device_node *np)\r\n{\r\nu32 config;\r\nvoid __iomem *base;\r\nint consumer_id, producer_id;\r\nconsumer_id = of_get_dml_pipe_index(np, "tx");\r\nproducer_id = of_get_dml_pipe_index(np, "rx");\r\nif (producer_id < 0 || consumer_id < 0)\r\nreturn -ENODEV;\r\nbase = host->base + DML_OFFSET;\r\nwritel_relaxed(1, base + DML_SW_RESET);\r\nconfig = (PRODUCER_CRCI_DISABLE | CONSUMER_CRCI_DISABLE);\r\nconfig &= ~BYPASS;\r\nconfig &= ~DIRECT_MODE;\r\nconfig &= ~INFINITE_CONS_TRANS;\r\nwritel_relaxed(config, base + DML_CONFIG);\r\nwritel_relaxed(PRODUCER_PIPE_LOGICAL_SIZE,\r\nbase + DML_PRODUCER_PIPE_LOGICAL_SIZE);\r\nwritel_relaxed(CONSUMER_PIPE_LOGICAL_SIZE,\r\nbase + DML_CONSUMER_PIPE_LOGICAL_SIZE);\r\nwritel_relaxed(producer_id | (consumer_id << CONSUMER_PIPE_ID_SHFT),\r\nbase + DML_PIPE_ID);\r\nmb();\r\nreturn 0;\r\n}

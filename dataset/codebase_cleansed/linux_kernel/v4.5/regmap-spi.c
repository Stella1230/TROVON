static void regmap_spi_complete(void *data)\r\n{\r\nstruct regmap_async_spi *async = data;\r\nregmap_async_complete_cb(&async->core, async->m.status);\r\n}\r\nstatic int regmap_spi_write(void *context, const void *data, size_t count)\r\n{\r\nstruct device *dev = context;\r\nstruct spi_device *spi = to_spi_device(dev);\r\nreturn spi_write(spi, data, count);\r\n}\r\nstatic int regmap_spi_gather_write(void *context,\r\nconst void *reg, size_t reg_len,\r\nconst void *val, size_t val_len)\r\n{\r\nstruct device *dev = context;\r\nstruct spi_device *spi = to_spi_device(dev);\r\nstruct spi_message m;\r\nstruct spi_transfer t[2] = { { .tx_buf = reg, .len = reg_len, },\r\n{ .tx_buf = val, .len = val_len, }, };\r\nspi_message_init(&m);\r\nspi_message_add_tail(&t[0], &m);\r\nspi_message_add_tail(&t[1], &m);\r\nreturn spi_sync(spi, &m);\r\n}\r\nstatic int regmap_spi_async_write(void *context,\r\nconst void *reg, size_t reg_len,\r\nconst void *val, size_t val_len,\r\nstruct regmap_async *a)\r\n{\r\nstruct regmap_async_spi *async = container_of(a,\r\nstruct regmap_async_spi,\r\ncore);\r\nstruct device *dev = context;\r\nstruct spi_device *spi = to_spi_device(dev);\r\nasync->t[0].tx_buf = reg;\r\nasync->t[0].len = reg_len;\r\nasync->t[1].tx_buf = val;\r\nasync->t[1].len = val_len;\r\nspi_message_init(&async->m);\r\nspi_message_add_tail(&async->t[0], &async->m);\r\nif (val)\r\nspi_message_add_tail(&async->t[1], &async->m);\r\nasync->m.complete = regmap_spi_complete;\r\nasync->m.context = async;\r\nreturn spi_async(spi, &async->m);\r\n}\r\nstatic struct regmap_async *regmap_spi_async_alloc(void)\r\n{\r\nstruct regmap_async_spi *async_spi;\r\nasync_spi = kzalloc(sizeof(*async_spi), GFP_KERNEL);\r\nif (!async_spi)\r\nreturn NULL;\r\nreturn &async_spi->core;\r\n}\r\nstatic int regmap_spi_read(void *context,\r\nconst void *reg, size_t reg_size,\r\nvoid *val, size_t val_size)\r\n{\r\nstruct device *dev = context;\r\nstruct spi_device *spi = to_spi_device(dev);\r\nreturn spi_write_then_read(spi, reg, reg_size, val, val_size);\r\n}\r\nstruct regmap *__regmap_init_spi(struct spi_device *spi,\r\nconst struct regmap_config *config,\r\nstruct lock_class_key *lock_key,\r\nconst char *lock_name)\r\n{\r\nreturn __regmap_init(&spi->dev, &regmap_spi, &spi->dev, config,\r\nlock_key, lock_name);\r\n}\r\nstruct regmap *__devm_regmap_init_spi(struct spi_device *spi,\r\nconst struct regmap_config *config,\r\nstruct lock_class_key *lock_key,\r\nconst char *lock_name)\r\n{\r\nreturn __devm_regmap_init(&spi->dev, &regmap_spi, &spi->dev, config,\r\nlock_key, lock_name);\r\n}

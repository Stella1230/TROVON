void vc4_hvs_dump_state(struct drm_device *dev)\r\n{\r\nstruct vc4_dev *vc4 = to_vc4_dev(dev);\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(hvs_regs); i++) {\r\nDRM_INFO("0x%04x (%s): 0x%08x\n",\r\nhvs_regs[i].reg, hvs_regs[i].name,\r\nHVS_READ(hvs_regs[i].reg));\r\n}\r\nDRM_INFO("HVS ctx:\n");\r\nfor (i = 0; i < 64; i += 4) {\r\nDRM_INFO("0x%08x (%s): 0x%08x 0x%08x 0x%08x 0x%08x\n",\r\ni * 4, i < HVS_BOOTLOADER_DLIST_END ? "B" : "D",\r\nreadl((u32 __iomem *)vc4->hvs->dlist + i + 0),\r\nreadl((u32 __iomem *)vc4->hvs->dlist + i + 1),\r\nreadl((u32 __iomem *)vc4->hvs->dlist + i + 2),\r\nreadl((u32 __iomem *)vc4->hvs->dlist + i + 3));\r\n}\r\n}\r\nint vc4_hvs_debugfs_regs(struct seq_file *m, void *unused)\r\n{\r\nstruct drm_info_node *node = (struct drm_info_node *)m->private;\r\nstruct drm_device *dev = node->minor->dev;\r\nstruct vc4_dev *vc4 = to_vc4_dev(dev);\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(hvs_regs); i++) {\r\nseq_printf(m, "%s (0x%04x): 0x%08x\n",\r\nhvs_regs[i].name, hvs_regs[i].reg,\r\nHVS_READ(hvs_regs[i].reg));\r\n}\r\nreturn 0;\r\n}\r\nstatic int vc4_hvs_bind(struct device *dev, struct device *master, void *data)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct drm_device *drm = dev_get_drvdata(master);\r\nstruct vc4_dev *vc4 = drm->dev_private;\r\nstruct vc4_hvs *hvs = NULL;\r\nhvs = devm_kzalloc(&pdev->dev, sizeof(*hvs), GFP_KERNEL);\r\nif (!hvs)\r\nreturn -ENOMEM;\r\nhvs->pdev = pdev;\r\nhvs->regs = vc4_ioremap_regs(pdev, 0);\r\nif (IS_ERR(hvs->regs))\r\nreturn PTR_ERR(hvs->regs);\r\nhvs->dlist = hvs->regs + SCALER_DLIST_START;\r\nvc4->hvs = hvs;\r\nreturn 0;\r\n}\r\nstatic void vc4_hvs_unbind(struct device *dev, struct device *master,\r\nvoid *data)\r\n{\r\nstruct drm_device *drm = dev_get_drvdata(master);\r\nstruct vc4_dev *vc4 = drm->dev_private;\r\nvc4->hvs = NULL;\r\n}\r\nstatic int vc4_hvs_dev_probe(struct platform_device *pdev)\r\n{\r\nreturn component_add(&pdev->dev, &vc4_hvs_ops);\r\n}\r\nstatic int vc4_hvs_dev_remove(struct platform_device *pdev)\r\n{\r\ncomponent_del(&pdev->dev, &vc4_hvs_ops);\r\nreturn 0;\r\n}

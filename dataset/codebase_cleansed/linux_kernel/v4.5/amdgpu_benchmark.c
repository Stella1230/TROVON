static int amdgpu_benchmark_do_move(struct amdgpu_device *adev, unsigned size,\r\nuint64_t saddr, uint64_t daddr, int n)\r\n{\r\nunsigned long start_jiffies;\r\nunsigned long end_jiffies;\r\nstruct fence *fence = NULL;\r\nint i, r;\r\nstart_jiffies = jiffies;\r\nfor (i = 0; i < n; i++) {\r\nstruct amdgpu_ring *ring = adev->mman.buffer_funcs_ring;\r\nr = amdgpu_copy_buffer(ring, saddr, daddr, size, NULL, &fence);\r\nif (r)\r\ngoto exit_do_move;\r\nr = fence_wait(fence, false);\r\nif (r)\r\ngoto exit_do_move;\r\nfence_put(fence);\r\n}\r\nend_jiffies = jiffies;\r\nr = jiffies_to_msecs(end_jiffies - start_jiffies);\r\nexit_do_move:\r\nif (fence)\r\nfence_put(fence);\r\nreturn r;\r\n}\r\nstatic void amdgpu_benchmark_log_results(int n, unsigned size,\r\nunsigned int time,\r\nunsigned sdomain, unsigned ddomain,\r\nchar *kind)\r\n{\r\nunsigned int throughput = (n * (size >> 10)) / time;\r\nDRM_INFO("amdgpu: %s %u bo moves of %u kB from"\r\n" %d to %d in %u ms, throughput: %u Mb/s or %u MB/s\n",\r\nkind, n, size >> 10, sdomain, ddomain, time,\r\nthroughput * 8, throughput);\r\n}\r\nstatic void amdgpu_benchmark_move(struct amdgpu_device *adev, unsigned size,\r\nunsigned sdomain, unsigned ddomain)\r\n{\r\nstruct amdgpu_bo *dobj = NULL;\r\nstruct amdgpu_bo *sobj = NULL;\r\nuint64_t saddr, daddr;\r\nint r, n;\r\nint time;\r\nn = AMDGPU_BENCHMARK_ITERATIONS;\r\nr = amdgpu_bo_create(adev, size, PAGE_SIZE, true, sdomain, 0, NULL,\r\nNULL, &sobj);\r\nif (r) {\r\ngoto out_cleanup;\r\n}\r\nr = amdgpu_bo_reserve(sobj, false);\r\nif (unlikely(r != 0))\r\ngoto out_cleanup;\r\nr = amdgpu_bo_pin(sobj, sdomain, &saddr);\r\namdgpu_bo_unreserve(sobj);\r\nif (r) {\r\ngoto out_cleanup;\r\n}\r\nr = amdgpu_bo_create(adev, size, PAGE_SIZE, true, ddomain, 0, NULL,\r\nNULL, &dobj);\r\nif (r) {\r\ngoto out_cleanup;\r\n}\r\nr = amdgpu_bo_reserve(dobj, false);\r\nif (unlikely(r != 0))\r\ngoto out_cleanup;\r\nr = amdgpu_bo_pin(dobj, ddomain, &daddr);\r\namdgpu_bo_unreserve(dobj);\r\nif (r) {\r\ngoto out_cleanup;\r\n}\r\nif (adev->mman.buffer_funcs) {\r\ntime = amdgpu_benchmark_do_move(adev, size, saddr, daddr, n);\r\nif (time < 0)\r\ngoto out_cleanup;\r\nif (time > 0)\r\namdgpu_benchmark_log_results(n, size, time,\r\nsdomain, ddomain, "dma");\r\n}\r\nout_cleanup:\r\nif (sobj) {\r\nr = amdgpu_bo_reserve(sobj, false);\r\nif (likely(r == 0)) {\r\namdgpu_bo_unpin(sobj);\r\namdgpu_bo_unreserve(sobj);\r\n}\r\namdgpu_bo_unref(&sobj);\r\n}\r\nif (dobj) {\r\nr = amdgpu_bo_reserve(dobj, false);\r\nif (likely(r == 0)) {\r\namdgpu_bo_unpin(dobj);\r\namdgpu_bo_unreserve(dobj);\r\n}\r\namdgpu_bo_unref(&dobj);\r\n}\r\nif (r) {\r\nDRM_ERROR("Error while benchmarking BO move.\n");\r\n}\r\n}\r\nvoid amdgpu_benchmark(struct amdgpu_device *adev, int test_number)\r\n{\r\nint i;\r\nint common_modes[AMDGPU_BENCHMARK_COMMON_MODES_N] = {\r\n640 * 480 * 4,\r\n720 * 480 * 4,\r\n800 * 600 * 4,\r\n848 * 480 * 4,\r\n1024 * 768 * 4,\r\n1152 * 768 * 4,\r\n1280 * 720 * 4,\r\n1280 * 800 * 4,\r\n1280 * 854 * 4,\r\n1280 * 960 * 4,\r\n1280 * 1024 * 4,\r\n1440 * 900 * 4,\r\n1400 * 1050 * 4,\r\n1680 * 1050 * 4,\r\n1600 * 1200 * 4,\r\n1920 * 1080 * 4,\r\n1920 * 1200 * 4\r\n};\r\nswitch (test_number) {\r\ncase 1:\r\namdgpu_benchmark_move(adev, 1024*1024, AMDGPU_GEM_DOMAIN_GTT,\r\nAMDGPU_GEM_DOMAIN_VRAM);\r\namdgpu_benchmark_move(adev, 1024*1024, AMDGPU_GEM_DOMAIN_VRAM,\r\nAMDGPU_GEM_DOMAIN_GTT);\r\nbreak;\r\ncase 2:\r\namdgpu_benchmark_move(adev, 1024*1024, AMDGPU_GEM_DOMAIN_VRAM,\r\nAMDGPU_GEM_DOMAIN_VRAM);\r\nbreak;\r\ncase 3:\r\nfor (i = 1; i <= 16384; i <<= 1)\r\namdgpu_benchmark_move(adev, i * AMDGPU_GPU_PAGE_SIZE,\r\nAMDGPU_GEM_DOMAIN_GTT,\r\nAMDGPU_GEM_DOMAIN_VRAM);\r\nbreak;\r\ncase 4:\r\nfor (i = 1; i <= 16384; i <<= 1)\r\namdgpu_benchmark_move(adev, i * AMDGPU_GPU_PAGE_SIZE,\r\nAMDGPU_GEM_DOMAIN_VRAM,\r\nAMDGPU_GEM_DOMAIN_GTT);\r\nbreak;\r\ncase 5:\r\nfor (i = 1; i <= 16384; i <<= 1)\r\namdgpu_benchmark_move(adev, i * AMDGPU_GPU_PAGE_SIZE,\r\nAMDGPU_GEM_DOMAIN_VRAM,\r\nAMDGPU_GEM_DOMAIN_VRAM);\r\nbreak;\r\ncase 6:\r\nfor (i = 0; i < AMDGPU_BENCHMARK_COMMON_MODES_N; i++)\r\namdgpu_benchmark_move(adev, common_modes[i],\r\nAMDGPU_GEM_DOMAIN_GTT,\r\nAMDGPU_GEM_DOMAIN_VRAM);\r\nbreak;\r\ncase 7:\r\nfor (i = 0; i < AMDGPU_BENCHMARK_COMMON_MODES_N; i++)\r\namdgpu_benchmark_move(adev, common_modes[i],\r\nAMDGPU_GEM_DOMAIN_VRAM,\r\nAMDGPU_GEM_DOMAIN_GTT);\r\nbreak;\r\ncase 8:\r\nfor (i = 0; i < AMDGPU_BENCHMARK_COMMON_MODES_N; i++)\r\namdgpu_benchmark_move(adev, common_modes[i],\r\nAMDGPU_GEM_DOMAIN_VRAM,\r\nAMDGPU_GEM_DOMAIN_VRAM);\r\nbreak;\r\ndefault:\r\nDRM_ERROR("Unknown benchmark\n");\r\n}\r\n}

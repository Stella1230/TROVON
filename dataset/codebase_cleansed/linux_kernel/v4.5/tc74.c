static int tc74_update_device(struct device *dev)\r\n{\r\nstruct tc74_data *data = dev_get_drvdata(dev);\r\nstruct i2c_client *client = data->client;\r\nint ret;\r\nret = mutex_lock_interruptible(&data->lock);\r\nif (ret)\r\nreturn ret;\r\nif (time_after(jiffies, data->next_update) || !data->valid) {\r\ns32 value;\r\nvalue = i2c_smbus_read_byte_data(client, TC74_REG_CONFIG);\r\nif (value < 0) {\r\ndev_dbg(&client->dev, "TC74_REG_CONFIG read err %d\n",\r\n(int)value);\r\nret = value;\r\ngoto ret_unlock;\r\n}\r\nif (!(value & BIT(6))) {\r\nret = -EAGAIN;\r\ngoto ret_unlock;\r\n}\r\nvalue = i2c_smbus_read_byte_data(client, TC74_REG_TEMP);\r\nif (value < 0) {\r\ndev_dbg(&client->dev, "TC74_REG_TEMP read err %d\n",\r\n(int)value);\r\nret = value;\r\ngoto ret_unlock;\r\n}\r\ndata->temp_input = value;\r\ndata->next_update = jiffies + HZ / 4;\r\ndata->valid = true;\r\n}\r\nret_unlock:\r\nmutex_unlock(&data->lock);\r\nreturn ret;\r\n}\r\nstatic ssize_t show_temp_input(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct tc74_data *data = dev_get_drvdata(dev);\r\nint ret;\r\nret = tc74_update_device(dev);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, "%d\n", data->temp_input * 1000);\r\n}\r\nstatic int tc74_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *dev_id)\r\n{\r\nstruct device *dev = &client->dev;\r\nstruct tc74_data *data;\r\nstruct device *hwmon_dev;\r\ns32 conf;\r\nif (!i2c_check_functionality(client->adapter, I2C_FUNC_SMBUS_BYTE_DATA))\r\nreturn -EOPNOTSUPP;\r\ndata = devm_kzalloc(dev, sizeof(struct tc74_data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\ndata->client = client;\r\nmutex_init(&data->lock);\r\nconf = i2c_smbus_read_byte_data(client, TC74_REG_CONFIG);\r\nif (conf < 0) {\r\ndev_err(dev, "unable to read config register\n");\r\nreturn conf;\r\n}\r\nif (conf & 0x3f) {\r\ndev_err(dev, "invalid config register value\n");\r\nreturn -ENODEV;\r\n}\r\nif (conf & BIT(7)) {\r\ns32 ret;\r\nconf &= ~BIT(7);\r\nret = i2c_smbus_write_byte_data(client, TC74_REG_CONFIG, conf);\r\nif (ret)\r\ndev_warn(dev, "unable to disable STANDBY\n");\r\n}\r\nhwmon_dev = devm_hwmon_device_register_with_groups(dev,\r\nclient->name,\r\ndata, tc74_groups);\r\nreturn PTR_ERR_OR_ZERO(hwmon_dev);\r\n}

static inline u32\r\ndblock_addr(const struct dblock *blk)\r\n{\r\nreturn le32_to_cpu(blk->addr);\r\n}\r\nstatic inline u32\r\ndblock_len(const struct dblock *blk)\r\n{\r\nreturn le16_to_cpu(blk->len);\r\n}\r\nstatic inline u32\r\npdr_id(const struct pdr *pdr)\r\n{\r\nreturn le32_to_cpu(pdr->id);\r\n}\r\nstatic inline u32\r\npdr_addr(const struct pdr *pdr)\r\n{\r\nreturn le32_to_cpu(pdr->addr);\r\n}\r\nstatic inline u32\r\npdr_len(const struct pdr *pdr)\r\n{\r\nreturn le32_to_cpu(pdr->len);\r\n}\r\nstatic inline u32\r\npdi_id(const struct pdi *pdi)\r\n{\r\nreturn le16_to_cpu(pdi->id);\r\n}\r\nstatic inline u32\r\npdi_len(const struct pdi *pdi)\r\n{\r\nreturn 2 * (le16_to_cpu(pdi->len) - 1);\r\n}\r\nstatic const struct pdr *\r\nhermes_find_pdr(const struct pdr *first_pdr, u32 record_id, const void *end)\r\n{\r\nconst struct pdr *pdr = first_pdr;\r\nend -= sizeof(struct pdr);\r\nwhile (((void *) pdr <= end) &&\r\n(pdr_id(pdr) != PDI_END)) {\r\nif (pdr_len(pdr) < 2)\r\nreturn NULL;\r\nif (pdr_id(pdr) == record_id)\r\nreturn pdr;\r\npdr = (struct pdr *) pdr->next;\r\n}\r\nreturn NULL;\r\n}\r\nstatic const struct pdi *\r\nhermes_find_pdi(const struct pdi *first_pdi, u32 record_id, const void *end)\r\n{\r\nconst struct pdi *pdi = first_pdi;\r\nend -= sizeof(struct pdi);\r\nwhile (((void *) pdi <= end) &&\r\n(pdi_id(pdi) != PDI_END)) {\r\nif (pdi_id(pdi) == record_id)\r\nreturn pdi;\r\npdi = (struct pdi *) &pdi->data[pdi_len(pdi)];\r\n}\r\nreturn NULL;\r\n}\r\nstatic int\r\nhermes_plug_pdi(struct hermes *hw, const struct pdr *first_pdr,\r\nconst struct pdi *pdi, const void *pdr_end)\r\n{\r\nconst struct pdr *pdr;\r\npdr = hermes_find_pdr(first_pdr, pdi_id(pdi), pdr_end);\r\nif (!pdr)\r\nreturn 0;\r\nif (pdi_len(pdi) != pdr_len(pdr))\r\nreturn -EINVAL;\r\nhw->ops->program(hw, pdi->data, pdr_addr(pdr), pdi_len(pdi));\r\nreturn 0;\r\n}\r\nint hermes_apply_pda(struct hermes *hw,\r\nconst char *first_pdr,\r\nconst void *pdr_end,\r\nconst __le16 *pda,\r\nconst void *pda_end)\r\n{\r\nint ret;\r\nconst struct pdi *pdi;\r\nconst struct pdr *pdr;\r\npdr = (const struct pdr *) first_pdr;\r\npda_end -= sizeof(struct pdi);\r\npdi = (const struct pdi *) (pda + 2);\r\nwhile (((void *) pdi <= pda_end) &&\r\n(pdi_id(pdi) != PDI_END)) {\r\nret = hermes_plug_pdi(hw, pdr, pdi, pdr_end);\r\nif (ret)\r\nreturn ret;\r\npdi = (const struct pdi *) &pdi->data[pdi_len(pdi)];\r\n}\r\nreturn 0;\r\n}\r\nsize_t\r\nhermes_blocks_length(const char *first_block, const void *end)\r\n{\r\nconst struct dblock *blk = (const struct dblock *) first_block;\r\nint total_len = 0;\r\nint len;\r\nend -= sizeof(*blk);\r\nwhile (((void *) blk <= end) &&\r\n(dblock_addr(blk) != BLOCK_END)) {\r\nlen = dblock_len(blk);\r\ntotal_len += sizeof(*blk) + len;\r\nblk = (struct dblock *) &blk->data[len];\r\n}\r\nreturn total_len;\r\n}\r\nint hermes_program(struct hermes *hw, const char *first_block, const void *end)\r\n{\r\nconst struct dblock *blk;\r\nu32 blkaddr;\r\nu32 blklen;\r\nint err = 0;\r\nblk = (const struct dblock *) first_block;\r\nif ((void *) blk > (end - sizeof(*blk)))\r\nreturn -EIO;\r\nblkaddr = dblock_addr(blk);\r\nblklen = dblock_len(blk);\r\nwhile ((blkaddr != BLOCK_END) &&\r\n(((void *) blk + blklen) <= end)) {\r\npr_debug(PFX "Programming block of length %d "\r\n"to address 0x%08x\n", blklen, blkaddr);\r\nerr = hw->ops->program(hw, blk->data, blkaddr, blklen);\r\nif (err)\r\nbreak;\r\nblk = (const struct dblock *) &blk->data[blklen];\r\nif ((void *) blk > (end - sizeof(*blk)))\r\nreturn -EIO;\r\nblkaddr = dblock_addr(blk);\r\nblklen = dblock_len(blk);\r\n}\r\nreturn err;\r\n}\r\nint hermes_apply_pda_with_defaults(struct hermes *hw,\r\nconst char *first_pdr,\r\nconst void *pdr_end,\r\nconst __le16 *pda,\r\nconst void *pda_end)\r\n{\r\nconst struct pdr *pdr = (const struct pdr *) first_pdr;\r\nconst struct pdi *first_pdi = (const struct pdi *) &pda[2];\r\nconst struct pdi *pdi;\r\nconst struct pdi *default_pdi = NULL;\r\nconst struct pdi *outdoor_pdi;\r\nint record_id;\r\npdr_end -= sizeof(struct pdr);\r\nwhile (((void *) pdr <= pdr_end) &&\r\n(pdr_id(pdr) != PDI_END)) {\r\nif (pdr_len(pdr) < 2)\r\nbreak;\r\nrecord_id = pdr_id(pdr);\r\npdi = hermes_find_pdi(first_pdi, record_id, pda_end);\r\nif (pdi)\r\npr_debug(PFX "Found record 0x%04x at %p\n",\r\nrecord_id, pdi);\r\nswitch (record_id) {\r\ncase 0x110:\r\ncase 0x120:\r\noutdoor_pdi = hermes_find_pdi(first_pdi, record_id + 1,\r\npda_end);\r\ndefault_pdi = NULL;\r\nif (outdoor_pdi) {\r\npdi = outdoor_pdi;\r\npr_debug(PFX\r\n"Using outdoor record 0x%04x at %p\n",\r\nrecord_id + 1, pdi);\r\n}\r\nbreak;\r\ncase 0x5:\r\ndefault_pdi = (struct pdi *) &DEFAULT_PDR(0x0005);\r\nbreak;\r\ncase 0x108:\r\ndefault_pdi = (struct pdi *) &DEFAULT_PDR(0x0108);\r\nbreak;\r\ncase 0x109:\r\ndefault_pdi = (struct pdi *) &DEFAULT_PDR(0x0109);\r\nbreak;\r\ncase 0x150:\r\ndefault_pdi = (struct pdi *) &DEFAULT_PDR(0x0150);\r\nbreak;\r\ncase 0x160:\r\ndefault_pdi = (struct pdi *) &DEFAULT_PDR(0x0160);\r\nbreak;\r\ncase 0x161:\r\ndefault_pdi = (struct pdi *) &DEFAULT_PDR(0x0161);\r\nbreak;\r\ndefault:\r\ndefault_pdi = NULL;\r\nbreak;\r\n}\r\nif (!pdi && default_pdi) {\r\npdi = default_pdi;\r\npr_debug(PFX "Using default record 0x%04x at %p\n",\r\nrecord_id, pdi);\r\n}\r\nif (pdi) {\r\nif ((pdi_len(pdi) == pdr_len(pdr)) &&\r\n((void *) pdi->data + pdi_len(pdi) < pda_end)) {\r\nhw->ops->program(hw, pdi->data, pdr_addr(pdr),\r\npdi_len(pdi));\r\n}\r\n}\r\npdr++;\r\n}\r\nreturn 0;\r\n}

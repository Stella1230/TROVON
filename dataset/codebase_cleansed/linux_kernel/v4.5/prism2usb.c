static int prism2sta_probe_usb(struct usb_interface *interface,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct usb_device *dev;\r\nwlandevice_t *wlandev = NULL;\r\nhfa384x_t *hw = NULL;\r\nint result = 0;\r\ndev = interface_to_usbdev(interface);\r\nwlandev = create_wlan();\r\nif (wlandev == NULL) {\r\ndev_err(&interface->dev, "Memory allocation failure.\n");\r\nresult = -EIO;\r\ngoto failed;\r\n}\r\nhw = wlandev->priv;\r\nif (wlan_setup(wlandev, &(interface->dev)) != 0) {\r\ndev_err(&interface->dev, "wlan_setup() failed.\n");\r\nresult = -EIO;\r\ngoto failed;\r\n}\r\nhfa384x_create(hw, dev);\r\nhw->wlandev = wlandev;\r\nSET_NETDEV_DEV(wlandev->netdev, &(interface->dev));\r\nif (prism2_doreset) {\r\nresult = hfa384x_corereset(hw,\r\nprism2_reset_holdtime,\r\nprism2_reset_settletime, 0);\r\nif (result != 0) {\r\nresult = -EIO;\r\ndev_err(&interface->dev,\r\n"hfa384x_corereset() failed.\n");\r\ngoto failed_reset;\r\n}\r\n}\r\nusb_get_dev(dev);\r\nwlandev->msdstate = WLAN_MSD_HWPRESENT;\r\nprism2_fwtry(dev, wlandev);\r\nprism2sta_ifstate(wlandev, P80211ENUM_ifstate_enable);\r\nif (register_wlandev(wlandev) != 0) {\r\ndev_err(&interface->dev, "register_wlandev() failed.\n");\r\nresult = -EIO;\r\ngoto failed_register;\r\n}\r\ngoto done;\r\nfailed_register:\r\nusb_put_dev(dev);\r\nfailed_reset:\r\nwlan_unsetup(wlandev);\r\nfailed:\r\nkfree(wlandev);\r\nkfree(hw);\r\nwlandev = NULL;\r\ndone:\r\nusb_set_intfdata(interface, wlandev);\r\nreturn result;\r\n}\r\nstatic void prism2sta_disconnect_usb(struct usb_interface *interface)\r\n{\r\nwlandevice_t *wlandev;\r\nwlandev = (wlandevice_t *)usb_get_intfdata(interface);\r\nif (wlandev != NULL) {\r\nLIST_HEAD(cleanlist);\r\nstruct list_head *entry;\r\nstruct list_head *temp;\r\nunsigned long flags;\r\nhfa384x_t *hw = wlandev->priv;\r\nif (!hw)\r\ngoto exit;\r\nspin_lock_irqsave(&hw->ctlxq.lock, flags);\r\np80211netdev_hwremoved(wlandev);\r\nlist_splice_init(&hw->ctlxq.reapable, &cleanlist);\r\nlist_splice_init(&hw->ctlxq.completing, &cleanlist);\r\nlist_splice_init(&hw->ctlxq.pending, &cleanlist);\r\nlist_splice_init(&hw->ctlxq.active, &cleanlist);\r\nspin_unlock_irqrestore(&hw->ctlxq.lock, flags);\r\nprism2sta_ifstate(wlandev, P80211ENUM_ifstate_disable);\r\ndel_singleshot_timer_sync(&hw->throttle);\r\ndel_singleshot_timer_sync(&hw->reqtimer);\r\ndel_singleshot_timer_sync(&hw->resptimer);\r\nusb_kill_urb(&hw->rx_urb);\r\nusb_kill_urb(&hw->tx_urb);\r\nusb_kill_urb(&hw->ctlx_urb);\r\ntasklet_kill(&hw->completion_bh);\r\ntasklet_kill(&hw->reaper_bh);\r\nflush_scheduled_work();\r\nlist_for_each(entry, &cleanlist) {\r\nhfa384x_usbctlx_t *ctlx;\r\nctlx = list_entry(entry, hfa384x_usbctlx_t, list);\r\ncomplete(&ctlx->done);\r\n}\r\nmsleep(100);\r\nlist_for_each_safe(entry, temp, &cleanlist) {\r\nhfa384x_usbctlx_t *ctlx;\r\nctlx = list_entry(entry, hfa384x_usbctlx_t, list);\r\nkfree(ctlx);\r\n}\r\nunregister_wlandev(wlandev);\r\nwlan_unsetup(wlandev);\r\nusb_put_dev(hw->usb);\r\nhfa384x_destroy(hw);\r\nkfree(hw);\r\nkfree(wlandev);\r\n}\r\nexit:\r\nusb_set_intfdata(interface, NULL);\r\n}\r\nstatic int prism2sta_suspend(struct usb_interface *interface,\r\npm_message_t message)\r\n{\r\nhfa384x_t *hw = NULL;\r\nwlandevice_t *wlandev;\r\nwlandev = (wlandevice_t *)usb_get_intfdata(interface);\r\nif (!wlandev)\r\nreturn -ENODEV;\r\nhw = wlandev->priv;\r\nif (!hw)\r\nreturn -ENODEV;\r\nprism2sta_ifstate(wlandev, P80211ENUM_ifstate_disable);\r\nusb_kill_urb(&hw->rx_urb);\r\nusb_kill_urb(&hw->tx_urb);\r\nusb_kill_urb(&hw->ctlx_urb);\r\nreturn 0;\r\n}\r\nstatic int prism2sta_resume(struct usb_interface *interface)\r\n{\r\nint result = 0;\r\nhfa384x_t *hw = NULL;\r\nwlandevice_t *wlandev;\r\nwlandev = (wlandevice_t *)usb_get_intfdata(interface);\r\nif (!wlandev)\r\nreturn -ENODEV;\r\nhw = wlandev->priv;\r\nif (!hw)\r\nreturn -ENODEV;\r\nif (prism2_doreset) {\r\nresult = hfa384x_corereset(hw,\r\nprism2_reset_holdtime,\r\nprism2_reset_settletime, 0);\r\nif (result != 0) {\r\nunregister_wlandev(wlandev);\r\nhfa384x_destroy(hw);\r\ndev_err(&interface->dev, "hfa384x_corereset() failed.\n");\r\nkfree(wlandev);\r\nkfree(hw);\r\nwlandev = NULL;\r\nreturn -ENODEV;\r\n}\r\n}\r\nprism2sta_ifstate(wlandev, P80211ENUM_ifstate_enable);\r\nreturn 0;\r\n}

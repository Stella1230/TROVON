void __init gpmc_smsc911x_init(struct omap_smsc911x_platform_data *gpmc_cfg)\r\n{\r\nstruct platform_device *pdev;\r\nunsigned long cs_mem_base;\r\nint ret;\r\nif (gpmc_cs_request(gpmc_cfg->cs, SZ_16M, &cs_mem_base) < 0) {\r\npr_err("Failed to request GPMC mem region\n");\r\nreturn;\r\n}\r\ngpmc_smsc911x_resources[0].start = cs_mem_base + 0x0;\r\ngpmc_smsc911x_resources[0].end = cs_mem_base + 0xff;\r\nif (gpio_request_one(gpmc_cfg->gpio_irq, GPIOF_IN, "smsc911x irq")) {\r\npr_err("Failed to request IRQ GPIO%d\n", gpmc_cfg->gpio_irq);\r\ngoto free1;\r\n}\r\ngpmc_smsc911x_resources[1].start = gpio_to_irq(gpmc_cfg->gpio_irq);\r\nif (gpio_is_valid(gpmc_cfg->gpio_reset)) {\r\nret = gpio_request_one(gpmc_cfg->gpio_reset,\r\nGPIOF_OUT_INIT_HIGH, "smsc911x reset");\r\nif (ret) {\r\npr_err("Failed to request reset GPIO%d\n",\r\ngpmc_cfg->gpio_reset);\r\ngoto free2;\r\n}\r\ngpio_set_value(gpmc_cfg->gpio_reset, 0);\r\nmsleep(100);\r\ngpio_set_value(gpmc_cfg->gpio_reset, 1);\r\n}\r\ngpmc_smsc911x_config.flags = gpmc_cfg->flags ? : SMSC911X_USE_16BIT;\r\npdev = platform_device_register_resndata(NULL, "smsc911x", gpmc_cfg->id,\r\ngpmc_smsc911x_resources, ARRAY_SIZE(gpmc_smsc911x_resources),\r\n&gpmc_smsc911x_config, sizeof(gpmc_smsc911x_config));\r\nif (IS_ERR(pdev)) {\r\npr_err("Unable to register platform device\n");\r\ngpio_free(gpmc_cfg->gpio_reset);\r\ngoto free2;\r\n}\r\nreturn;\r\nfree2:\r\ngpio_free(gpmc_cfg->gpio_irq);\r\nfree1:\r\ngpmc_cs_free(gpmc_cfg->cs);\r\npr_err("Could not initialize smsc911x device\n");\r\n}

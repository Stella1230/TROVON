static int a8293_set_voltage(struct dvb_frontend *fe,\r\nenum fe_sec_voltage fe_sec_voltage)\r\n{\r\nstruct a8293_dev *dev = fe->sec_priv;\r\nstruct i2c_client *client = dev->client;\r\nint ret;\r\nu8 reg0, reg1;\r\ndev_dbg(&client->dev, "fe_sec_voltage=%d\n", fe_sec_voltage);\r\nswitch (fe_sec_voltage) {\r\ncase SEC_VOLTAGE_OFF:\r\nreg0 = 0x10;\r\nbreak;\r\ncase SEC_VOLTAGE_13:\r\nreg0 = 0x31;\r\nbreak;\r\ncase SEC_VOLTAGE_18:\r\nreg0 = 0x38;\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\ngoto err;\r\n}\r\nif (reg0 != dev->reg[0]) {\r\nret = i2c_master_send(client, &reg0, 1);\r\nif (ret < 0)\r\ngoto err;\r\ndev->reg[0] = reg0;\r\n}\r\nreg1 = 0x82;\r\nif (reg1 != dev->reg[1]) {\r\nret = i2c_master_send(client, &reg1, 1);\r\nif (ret < 0)\r\ngoto err;\r\ndev->reg[1] = reg1;\r\n}\r\nusleep_range(1500, 50000);\r\nreturn 0;\r\nerr:\r\ndev_dbg(&client->dev, "failed=%d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int a8293_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct a8293_dev *dev;\r\nstruct a8293_platform_data *pdata = client->dev.platform_data;\r\nstruct dvb_frontend *fe = pdata->dvb_frontend;\r\nint ret;\r\nu8 buf[2];\r\ndev = kzalloc(sizeof(*dev), GFP_KERNEL);\r\nif (!dev) {\r\nret = -ENOMEM;\r\ngoto err;\r\n}\r\ndev->client = client;\r\nret = i2c_master_recv(client, buf, 2);\r\nif (ret < 0)\r\ngoto err_kfree;\r\nfe->ops.set_voltage = a8293_set_voltage;\r\nfe->sec_priv = dev;\r\ni2c_set_clientdata(client, dev);\r\ndev_info(&client->dev, "Allegro A8293 SEC successfully attached\n");\r\nreturn 0;\r\nerr_kfree:\r\nkfree(dev);\r\nerr:\r\ndev_dbg(&client->dev, "failed=%d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int a8293_remove(struct i2c_client *client)\r\n{\r\nstruct a8293_dev *dev = i2c_get_clientdata(client);\r\ndev_dbg(&client->dev, "\n");\r\nkfree(dev);\r\nreturn 0;\r\n}

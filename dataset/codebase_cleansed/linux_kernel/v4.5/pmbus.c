static void pmbus_find_sensor_groups(struct i2c_client *client,\r\nstruct pmbus_driver_info *info)\r\n{\r\nint page;\r\nif (pmbus_check_word_register(client, 0, PMBUS_READ_VIN))\r\ninfo->func[0] |= PMBUS_HAVE_VIN;\r\nif (pmbus_check_word_register(client, 0, PMBUS_READ_VCAP))\r\ninfo->func[0] |= PMBUS_HAVE_VCAP;\r\nif (pmbus_check_word_register(client, 0, PMBUS_READ_IIN))\r\ninfo->func[0] |= PMBUS_HAVE_IIN;\r\nif (pmbus_check_word_register(client, 0, PMBUS_READ_PIN))\r\ninfo->func[0] |= PMBUS_HAVE_PIN;\r\nif (info->func[0]\r\n&& pmbus_check_byte_register(client, 0, PMBUS_STATUS_INPUT))\r\ninfo->func[0] |= PMBUS_HAVE_STATUS_INPUT;\r\nif (pmbus_check_byte_register(client, 0, PMBUS_FAN_CONFIG_12) &&\r\npmbus_check_word_register(client, 0, PMBUS_READ_FAN_SPEED_1)) {\r\ninfo->func[0] |= PMBUS_HAVE_FAN12;\r\nif (pmbus_check_byte_register(client, 0, PMBUS_STATUS_FAN_12))\r\ninfo->func[0] |= PMBUS_HAVE_STATUS_FAN12;\r\n}\r\nif (pmbus_check_byte_register(client, 0, PMBUS_FAN_CONFIG_34) &&\r\npmbus_check_word_register(client, 0, PMBUS_READ_FAN_SPEED_3)) {\r\ninfo->func[0] |= PMBUS_HAVE_FAN34;\r\nif (pmbus_check_byte_register(client, 0, PMBUS_STATUS_FAN_34))\r\ninfo->func[0] |= PMBUS_HAVE_STATUS_FAN34;\r\n}\r\nif (pmbus_check_word_register(client, 0, PMBUS_READ_TEMPERATURE_1))\r\ninfo->func[0] |= PMBUS_HAVE_TEMP;\r\nif (pmbus_check_word_register(client, 0, PMBUS_READ_TEMPERATURE_2))\r\ninfo->func[0] |= PMBUS_HAVE_TEMP2;\r\nif (pmbus_check_word_register(client, 0, PMBUS_READ_TEMPERATURE_3))\r\ninfo->func[0] |= PMBUS_HAVE_TEMP3;\r\nif (info->func[0] & (PMBUS_HAVE_TEMP | PMBUS_HAVE_TEMP2\r\n| PMBUS_HAVE_TEMP3)\r\n&& pmbus_check_byte_register(client, 0,\r\nPMBUS_STATUS_TEMPERATURE))\r\ninfo->func[0] |= PMBUS_HAVE_STATUS_TEMP;\r\nfor (page = 0; page < info->pages; page++) {\r\nif (pmbus_check_word_register(client, page, PMBUS_READ_VOUT)) {\r\ninfo->func[page] |= PMBUS_HAVE_VOUT;\r\nif (pmbus_check_byte_register(client, page,\r\nPMBUS_STATUS_VOUT))\r\ninfo->func[page] |= PMBUS_HAVE_STATUS_VOUT;\r\n}\r\nif (pmbus_check_word_register(client, page, PMBUS_READ_IOUT)) {\r\ninfo->func[page] |= PMBUS_HAVE_IOUT;\r\nif (pmbus_check_byte_register(client, 0,\r\nPMBUS_STATUS_IOUT))\r\ninfo->func[page] |= PMBUS_HAVE_STATUS_IOUT;\r\n}\r\nif (pmbus_check_word_register(client, page, PMBUS_READ_POUT))\r\ninfo->func[page] |= PMBUS_HAVE_POUT;\r\n}\r\n}\r\nstatic int pmbus_identify(struct i2c_client *client,\r\nstruct pmbus_driver_info *info)\r\n{\r\nint ret = 0;\r\nif (!info->pages) {\r\nif (pmbus_check_byte_register(client, 0, PMBUS_PAGE)) {\r\nint page;\r\nfor (page = 1; page < PMBUS_PAGES; page++) {\r\nif (pmbus_set_page(client, page) < 0)\r\nbreak;\r\n}\r\npmbus_set_page(client, 0);\r\ninfo->pages = page;\r\n} else {\r\ninfo->pages = 1;\r\n}\r\n}\r\nif (pmbus_check_byte_register(client, 0, PMBUS_VOUT_MODE)) {\r\nint vout_mode;\r\nvout_mode = pmbus_read_byte_data(client, 0, PMBUS_VOUT_MODE);\r\nif (vout_mode >= 0 && vout_mode != 0xff) {\r\nswitch (vout_mode >> 5) {\r\ncase 0:\r\nbreak;\r\ncase 1:\r\ninfo->format[PSC_VOLTAGE_OUT] = vid;\r\ninfo->vrm_version = vr11;\r\nbreak;\r\ncase 2:\r\ninfo->format[PSC_VOLTAGE_OUT] = direct;\r\nbreak;\r\ndefault:\r\nret = -ENODEV;\r\ngoto abort;\r\n}\r\n}\r\n}\r\nif (info->format[PSC_VOLTAGE_OUT] == direct) {\r\nret = -ENODEV;\r\ngoto abort;\r\n}\r\npmbus_find_sensor_groups(client, info);\r\nabort:\r\nreturn ret;\r\n}\r\nstatic int pmbus_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct pmbus_driver_info *info;\r\ninfo = devm_kzalloc(&client->dev, sizeof(struct pmbus_driver_info),\r\nGFP_KERNEL);\r\nif (!info)\r\nreturn -ENOMEM;\r\ninfo->pages = id->driver_data;\r\ninfo->identify = pmbus_identify;\r\nreturn pmbus_do_probe(client, id, info);\r\n}

static inline void write_dpr(struct lynx_accel *accel, int offset, u32 regValue)\r\n{\r\nwritel(regValue, accel->dprBase + offset);\r\n}\r\nstatic inline u32 read_dpr(struct lynx_accel *accel, int offset)\r\n{\r\nreturn readl(accel->dprBase + offset);\r\n}\r\nstatic inline void write_dpPort(struct lynx_accel *accel, u32 data)\r\n{\r\nwritel(data, accel->dpPortBase);\r\n}\r\nvoid hw_de_init(struct lynx_accel *accel)\r\n{\r\nu32 reg, clr;\r\nwrite_dpr(accel, DE_MASKS, 0xFFFFFFFF);\r\nreg = FIELD_SET(0, DE_STRETCH_FORMAT, PATTERN_XY, NORMAL)|\r\nFIELD_VALUE(0, DE_STRETCH_FORMAT, PATTERN_Y, 0)|\r\nFIELD_VALUE(0, DE_STRETCH_FORMAT, PATTERN_X, 0)|\r\nFIELD_SET(0, DE_STRETCH_FORMAT, ADDRESSING, XY)|\r\nFIELD_VALUE(0, DE_STRETCH_FORMAT, SOURCE_HEIGHT, 3);\r\nclr = FIELD_CLEAR(DE_STRETCH_FORMAT, PATTERN_XY)&\r\nFIELD_CLEAR(DE_STRETCH_FORMAT, PATTERN_Y)&\r\nFIELD_CLEAR(DE_STRETCH_FORMAT, PATTERN_X)&\r\nFIELD_CLEAR(DE_STRETCH_FORMAT, ADDRESSING)&\r\nFIELD_CLEAR(DE_STRETCH_FORMAT, SOURCE_HEIGHT);\r\nwrite_dpr(accel, DE_STRETCH_FORMAT, (read_dpr(accel, DE_STRETCH_FORMAT) & clr) | reg);\r\nwrite_dpr(accel, DE_CLIP_TL, 0);\r\nwrite_dpr(accel, DE_CLIP_BR, 0);\r\nwrite_dpr(accel, DE_COLOR_COMPARE_MASK, 0);\r\nwrite_dpr(accel, DE_COLOR_COMPARE, 0);\r\nreg = FIELD_SET(0, DE_CONTROL, TRANSPARENCY, DISABLE)|\r\nFIELD_SET(0, DE_CONTROL, TRANSPARENCY_MATCH, OPAQUE)|\r\nFIELD_SET(0, DE_CONTROL, TRANSPARENCY_SELECT, SOURCE);\r\nclr = FIELD_CLEAR(DE_CONTROL, TRANSPARENCY)&\r\nFIELD_CLEAR(DE_CONTROL, TRANSPARENCY_MATCH)&\r\nFIELD_CLEAR(DE_CONTROL, TRANSPARENCY_SELECT);\r\nwrite_dpr(accel, DE_CONTROL, (read_dpr(accel, DE_CONTROL)&clr)|reg);\r\n}\r\nvoid hw_set2dformat(struct lynx_accel *accel, int fmt)\r\n{\r\nu32 reg;\r\nreg = read_dpr(accel, DE_STRETCH_FORMAT);\r\nreg = FIELD_VALUE(reg, DE_STRETCH_FORMAT, PIXEL_FORMAT, fmt);\r\nwrite_dpr(accel, DE_STRETCH_FORMAT, reg);\r\n}\r\nint hw_fillrect(struct lynx_accel *accel,\r\nu32 base, u32 pitch, u32 Bpp,\r\nu32 x, u32 y, u32 width, u32 height,\r\nu32 color, u32 rop)\r\n{\r\nu32 deCtrl;\r\nif (accel->de_wait() != 0) {\r\npr_debug("De engine always busy\n");\r\nreturn -1;\r\n}\r\nwrite_dpr(accel, DE_WINDOW_DESTINATION_BASE, base);\r\nwrite_dpr(accel, DE_PITCH,\r\nFIELD_VALUE(0, DE_PITCH, DESTINATION, pitch/Bpp)|\r\nFIELD_VALUE(0, DE_PITCH, SOURCE, pitch/Bpp));\r\nwrite_dpr(accel, DE_WINDOW_WIDTH,\r\nFIELD_VALUE(0, DE_WINDOW_WIDTH, DESTINATION, pitch/Bpp)|\r\nFIELD_VALUE(0, DE_WINDOW_WIDTH, SOURCE, pitch/Bpp));\r\nwrite_dpr(accel, DE_FOREGROUND, color);\r\nwrite_dpr(accel, DE_DESTINATION,\r\nFIELD_SET(0, DE_DESTINATION, WRAP, DISABLE)|\r\nFIELD_VALUE(0, DE_DESTINATION, X, x)|\r\nFIELD_VALUE(0, DE_DESTINATION, Y, y));\r\nwrite_dpr(accel, DE_DIMENSION,\r\nFIELD_VALUE(0, DE_DIMENSION, X, width)|\r\nFIELD_VALUE(0, DE_DIMENSION, Y_ET, height));\r\ndeCtrl =\r\nFIELD_SET(0, DE_CONTROL, STATUS, START)|\r\nFIELD_SET(0, DE_CONTROL, DIRECTION, LEFT_TO_RIGHT)|\r\nFIELD_SET(0, DE_CONTROL, LAST_PIXEL, ON)|\r\nFIELD_SET(0, DE_CONTROL, COMMAND, RECTANGLE_FILL)|\r\nFIELD_SET(0, DE_CONTROL, ROP_SELECT, ROP2)|\r\nFIELD_VALUE(0, DE_CONTROL, ROP, rop);\r\nwrite_dpr(accel, DE_CONTROL, deCtrl);\r\nreturn 0;\r\n}\r\nint hw_copyarea(\r\nstruct lynx_accel *accel,\r\nunsigned int sBase,\r\nunsigned int sPitch,\r\nunsigned int sx,\r\nunsigned int sy,\r\nunsigned int dBase,\r\nunsigned int dPitch,\r\nunsigned int Bpp,\r\nunsigned int dx,\r\nunsigned int dy,\r\nunsigned int width,\r\nunsigned int height,\r\nunsigned int rop2)\r\n{\r\nunsigned int nDirection, de_ctrl;\r\nint opSign;\r\nnDirection = LEFT_TO_RIGHT;\r\nopSign = 1;\r\nde_ctrl = 0;\r\nif (sBase == dBase && sPitch == dPitch) {\r\nif (sy < dy) {\r\nnDirection = BOTTOM_TO_TOP;\r\n} else if (sy > dy) {\r\nnDirection = TOP_TO_BOTTOM;\r\n} else {\r\nif (sx <= dx) {\r\nnDirection = RIGHT_TO_LEFT;\r\n} else {\r\nnDirection = LEFT_TO_RIGHT;\r\n}\r\n}\r\n}\r\nif ((nDirection == BOTTOM_TO_TOP) || (nDirection == RIGHT_TO_LEFT)) {\r\nsx += width - 1;\r\nsy += height - 1;\r\ndx += width - 1;\r\ndy += height - 1;\r\nopSign = (-1);\r\n}\r\nwrite_dpr(accel, DE_WINDOW_SOURCE_BASE, sBase);\r\nwrite_dpr(accel, DE_WINDOW_DESTINATION_BASE, dBase);\r\n{\r\nwrite_dpr(accel, DE_PITCH,\r\nFIELD_VALUE(0, DE_PITCH, DESTINATION, (dPitch/Bpp)) |\r\nFIELD_VALUE(0, DE_PITCH, SOURCE, (sPitch/Bpp)));\r\n}\r\nwrite_dpr(accel, DE_WINDOW_WIDTH,\r\nFIELD_VALUE(0, DE_WINDOW_WIDTH, DESTINATION, (dPitch/Bpp)) |\r\nFIELD_VALUE(0, DE_WINDOW_WIDTH, SOURCE, (sPitch/Bpp)));\r\nif (accel->de_wait() != 0)\r\nreturn -1;\r\n{\r\nwrite_dpr(accel, DE_SOURCE,\r\nFIELD_SET(0, DE_SOURCE, WRAP, DISABLE) |\r\nFIELD_VALUE(0, DE_SOURCE, X_K1, sx) |\r\nFIELD_VALUE(0, DE_SOURCE, Y_K2, sy));\r\nwrite_dpr(accel, DE_DESTINATION,\r\nFIELD_SET(0, DE_DESTINATION, WRAP, DISABLE) |\r\nFIELD_VALUE(0, DE_DESTINATION, X, dx) |\r\nFIELD_VALUE(0, DE_DESTINATION, Y, dy));\r\nwrite_dpr(accel, DE_DIMENSION,\r\nFIELD_VALUE(0, DE_DIMENSION, X, width) |\r\nFIELD_VALUE(0, DE_DIMENSION, Y_ET, height));\r\nde_ctrl = FIELD_VALUE(0, DE_CONTROL, ROP, rop2) |\r\nFIELD_SET(0, DE_CONTROL, ROP_SELECT, ROP2) |\r\nFIELD_SET(0, DE_CONTROL, COMMAND, BITBLT) |\r\n((nDirection == RIGHT_TO_LEFT) ?\r\nFIELD_SET(0, DE_CONTROL, DIRECTION, RIGHT_TO_LEFT)\r\n: FIELD_SET(0, DE_CONTROL, DIRECTION, LEFT_TO_RIGHT)) |\r\nFIELD_SET(0, DE_CONTROL, STATUS, START);\r\nwrite_dpr(accel, DE_CONTROL, de_ctrl);\r\n}\r\nreturn 0;\r\n}\r\nstatic unsigned int deGetTransparency(struct lynx_accel *accel)\r\n{\r\nunsigned int de_ctrl;\r\nde_ctrl = read_dpr(accel, DE_CONTROL);\r\nde_ctrl &=\r\nFIELD_MASK(DE_CONTROL_TRANSPARENCY_MATCH) |\r\nFIELD_MASK(DE_CONTROL_TRANSPARENCY_SELECT)|\r\nFIELD_MASK(DE_CONTROL_TRANSPARENCY);\r\nreturn de_ctrl;\r\n}\r\nint hw_imageblit(struct lynx_accel *accel,\r\nconst char *pSrcbuf,\r\nu32 srcDelta,\r\nu32 startBit,\r\nu32 dBase,\r\nu32 dPitch,\r\nu32 bytePerPixel,\r\nu32 dx,\r\nu32 dy,\r\nu32 width,\r\nu32 height,\r\nu32 fColor,\r\nu32 bColor,\r\nu32 rop2)\r\n{\r\nunsigned int ulBytesPerScan;\r\nunsigned int ul4BytesPerScan;\r\nunsigned int ulBytesRemain;\r\nunsigned int de_ctrl = 0;\r\nunsigned char ajRemain[4];\r\nint i, j;\r\nstartBit &= 7;\r\nulBytesPerScan = (width + startBit + 7) / 8;\r\nul4BytesPerScan = ulBytesPerScan & ~3;\r\nulBytesRemain = ulBytesPerScan & 3;\r\nif (accel->de_wait() != 0)\r\nreturn -1;\r\nwrite_dpr(accel, DE_WINDOW_SOURCE_BASE, 0);\r\nwrite_dpr(accel, DE_WINDOW_DESTINATION_BASE, dBase);\r\n{\r\nwrite_dpr(accel, DE_PITCH,\r\nFIELD_VALUE(0, DE_PITCH, DESTINATION, dPitch/bytePerPixel) |\r\nFIELD_VALUE(0, DE_PITCH, SOURCE, dPitch/bytePerPixel));\r\n}\r\nwrite_dpr(accel, DE_WINDOW_WIDTH,\r\nFIELD_VALUE(0, DE_WINDOW_WIDTH, DESTINATION, (dPitch/bytePerPixel)) |\r\nFIELD_VALUE(0, DE_WINDOW_WIDTH, SOURCE, (dPitch/bytePerPixel)));\r\nwrite_dpr(accel, DE_SOURCE,\r\nFIELD_SET(0, DE_SOURCE, WRAP, DISABLE) |\r\nFIELD_VALUE(0, DE_SOURCE, X_K1_MONO, startBit));\r\nwrite_dpr(accel, DE_DESTINATION,\r\nFIELD_SET(0, DE_DESTINATION, WRAP, DISABLE) |\r\nFIELD_VALUE(0, DE_DESTINATION, X, dx) |\r\nFIELD_VALUE(0, DE_DESTINATION, Y, dy));\r\nwrite_dpr(accel, DE_DIMENSION,\r\nFIELD_VALUE(0, DE_DIMENSION, X, width) |\r\nFIELD_VALUE(0, DE_DIMENSION, Y_ET, height));\r\nwrite_dpr(accel, DE_FOREGROUND, fColor);\r\nwrite_dpr(accel, DE_BACKGROUND, bColor);\r\nde_ctrl = FIELD_VALUE(0, DE_CONTROL, ROP, rop2) |\r\nFIELD_SET(0, DE_CONTROL, ROP_SELECT, ROP2) |\r\nFIELD_SET(0, DE_CONTROL, COMMAND, HOST_WRITE) |\r\nFIELD_SET(0, DE_CONTROL, HOST, MONO) |\r\nFIELD_SET(0, DE_CONTROL, STATUS, START);\r\nwrite_dpr(accel, DE_CONTROL, de_ctrl | deGetTransparency(accel));\r\nfor (i = 0; i < height; i++) {\r\nfor (j = 0; j < (ul4BytesPerScan/4); j++)\r\nwrite_dpPort(accel, *(unsigned int *)(pSrcbuf + (j * 4)));\r\nif (ulBytesRemain) {\r\nmemcpy(ajRemain, pSrcbuf+ul4BytesPerScan, ulBytesRemain);\r\nwrite_dpPort(accel, *(unsigned int *)ajRemain);\r\n}\r\npSrcbuf += srcDelta;\r\n}\r\nreturn 0;\r\n}

int read_log(struct tpm_bios_log *log)\r\n{\r\nstruct device_node *np;\r\nconst u32 *sizep;\r\nconst u64 *basep;\r\nif (log->bios_event_log != NULL) {\r\npr_err("%s: ERROR - Eventlog already initialized\n", __func__);\r\nreturn -EFAULT;\r\n}\r\nnp = of_find_node_by_name(NULL, "vtpm");\r\nif (!np) {\r\npr_err("%s: ERROR - IBMVTPM not supported\n", __func__);\r\nreturn -ENODEV;\r\n}\r\nsizep = of_get_property(np, "linux,sml-size", NULL);\r\nif (sizep == NULL) {\r\npr_err("%s: ERROR - SML size not found\n", __func__);\r\ngoto cleanup_eio;\r\n}\r\nif (*sizep == 0) {\r\npr_err("%s: ERROR - event log area empty\n", __func__);\r\ngoto cleanup_eio;\r\n}\r\nbasep = of_get_property(np, "linux,sml-base", NULL);\r\nif (basep == NULL) {\r\npr_err("%s: ERROR - SML not found\n", __func__);\r\ngoto cleanup_eio;\r\n}\r\nlog->bios_event_log = kmalloc(*sizep, GFP_KERNEL);\r\nif (!log->bios_event_log) {\r\npr_err("%s: ERROR - Not enough memory for BIOS measurements\n",\r\n__func__);\r\nof_node_put(np);\r\nreturn -ENOMEM;\r\n}\r\nlog->bios_event_log_end = log->bios_event_log + *sizep;\r\nmemcpy(log->bios_event_log, __va(*basep), *sizep);\r\nof_node_put(np);\r\nreturn 0;\r\ncleanup_eio:\r\nof_node_put(np);\r\nreturn -EIO;\r\n}

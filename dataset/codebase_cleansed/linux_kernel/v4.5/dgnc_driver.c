static void dgnc_cleanup_module(void)\r\n{\r\nint i;\r\nunsigned long flags;\r\nspin_lock_irqsave(&dgnc_poll_lock, flags);\r\ndgnc_poll_stop = 1;\r\nspin_unlock_irqrestore(&dgnc_poll_lock, flags);\r\ndel_timer_sync(&dgnc_poll_timer);\r\ndgnc_remove_driver_sysfiles(&dgnc_driver);\r\ndevice_destroy(dgnc_class, MKDEV(dgnc_Major, 0));\r\nclass_destroy(dgnc_class);\r\nunregister_chrdev(dgnc_Major, "dgnc");\r\nfor (i = 0; i < dgnc_NumBoards; ++i) {\r\ndgnc_remove_ports_sysfiles(dgnc_Board[i]);\r\ndgnc_tty_uninit(dgnc_Board[i]);\r\ndgnc_cleanup_board(dgnc_Board[i]);\r\n}\r\ndgnc_tty_post_uninit();\r\nif (dgnc_NumBoards)\r\npci_unregister_driver(&dgnc_driver);\r\n}\r\nstatic int __init dgnc_init_module(void)\r\n{\r\nint rc;\r\nrc = dgnc_start();\r\nif (rc < 0)\r\nreturn rc;\r\nrc = pci_register_driver(&dgnc_driver);\r\nif (rc < 0) {\r\nif (dgnc_NumBoards)\r\npci_unregister_driver(&dgnc_driver);\r\nelse\r\npr_warn("WARNING: dgnc driver load failed. No Digi Neo or Classic boards found.\n");\r\ndgnc_cleanup_module();\r\n} else {\r\ndgnc_create_driver_sysfiles(&dgnc_driver);\r\n}\r\nreturn rc;\r\n}\r\nstatic int dgnc_start(void)\r\n{\r\nint rc = 0;\r\nunsigned long flags;\r\nstruct device *dev;\r\ninit_timer(&dgnc_poll_timer);\r\nrc = register_chrdev(0, "dgnc", &dgnc_BoardFops);\r\nif (rc < 0) {\r\npr_err(DRVSTR ": Can't register dgnc driver device (%d)\n", rc);\r\nreturn rc;\r\n}\r\ndgnc_Major = rc;\r\ndgnc_class = class_create(THIS_MODULE, "dgnc_mgmt");\r\nif (IS_ERR(dgnc_class)) {\r\nrc = PTR_ERR(dgnc_class);\r\npr_err(DRVSTR ": Can't create dgnc_mgmt class (%d)\n", rc);\r\ngoto failed_class;\r\n}\r\ndev = device_create(dgnc_class, NULL,\r\nMKDEV(dgnc_Major, 0),\r\nNULL, "dgnc_mgmt");\r\nif (IS_ERR(dev)) {\r\nrc = PTR_ERR(dev);\r\npr_err(DRVSTR ": Can't create device (%d)\n", rc);\r\ngoto failed_device;\r\n}\r\nrc = dgnc_tty_preinit();\r\nif (rc < 0) {\r\npr_err(DRVSTR ": tty preinit - not enough memory (%d)\n", rc);\r\ngoto failed_tty;\r\n}\r\nspin_lock_irqsave(&dgnc_poll_lock, flags);\r\nsetup_timer(&dgnc_poll_timer, dgnc_poll_handler, 0);\r\ndgnc_poll_time = jiffies + dgnc_jiffies_from_ms(dgnc_poll_tick);\r\ndgnc_poll_timer.expires = dgnc_poll_time;\r\nspin_unlock_irqrestore(&dgnc_poll_lock, flags);\r\nadd_timer(&dgnc_poll_timer);\r\nreturn 0;\r\nfailed_tty:\r\ndevice_destroy(dgnc_class, MKDEV(dgnc_Major, 0));\r\nfailed_device:\r\nclass_destroy(dgnc_class);\r\nfailed_class:\r\nunregister_chrdev(dgnc_Major, "dgnc");\r\nreturn rc;\r\n}\r\nstatic int dgnc_init_one(struct pci_dev *pdev, const struct pci_device_id *ent)\r\n{\r\nint rc;\r\nrc = pci_enable_device(pdev);\r\nif (rc < 0) {\r\nrc = -EIO;\r\n} else {\r\nrc = dgnc_found_board(pdev, ent->driver_data);\r\nif (rc == 0)\r\ndgnc_NumBoards++;\r\n}\r\nreturn rc;\r\n}\r\nstatic void dgnc_cleanup_board(struct dgnc_board *brd)\r\n{\r\nint i = 0;\r\nif (!brd || brd->magic != DGNC_BOARD_MAGIC)\r\nreturn;\r\nswitch (brd->device) {\r\ncase PCI_DEVICE_CLASSIC_4_DID:\r\ncase PCI_DEVICE_CLASSIC_8_DID:\r\ncase PCI_DEVICE_CLASSIC_4_422_DID:\r\ncase PCI_DEVICE_CLASSIC_8_422_DID:\r\noutb(0, brd->iobase + 0x4c);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (brd->irq)\r\nfree_irq(brd->irq, brd);\r\ntasklet_kill(&brd->helper_tasklet);\r\nif (brd->re_map_membase) {\r\niounmap(brd->re_map_membase);\r\nbrd->re_map_membase = NULL;\r\n}\r\nif (brd->msgbuf_head) {\r\nunsigned long flags;\r\nspin_lock_irqsave(&dgnc_global_lock, flags);\r\nbrd->msgbuf = NULL;\r\ndev_dbg(&brd->pdev->dev, "%s\n", brd->msgbuf_head);\r\nkfree(brd->msgbuf_head);\r\nbrd->msgbuf_head = NULL;\r\nspin_unlock_irqrestore(&dgnc_global_lock, flags);\r\n}\r\nfor (i = 0; i < MAXPORTS ; i++) {\r\nif (brd->channels[i]) {\r\nkfree(brd->channels[i]->ch_rqueue);\r\nkfree(brd->channels[i]->ch_equeue);\r\nkfree(brd->channels[i]->ch_wqueue);\r\nkfree(brd->channels[i]);\r\nbrd->channels[i] = NULL;\r\n}\r\n}\r\ndgnc_Board[brd->boardnum] = NULL;\r\nkfree(brd);\r\n}\r\nstatic int dgnc_found_board(struct pci_dev *pdev, int id)\r\n{\r\nstruct dgnc_board *brd;\r\nunsigned int pci_irq;\r\nint i = 0;\r\nint rc = 0;\r\nunsigned long flags;\r\ndgnc_Board[dgnc_NumBoards] = kzalloc(sizeof(*brd), GFP_KERNEL);\r\nbrd = dgnc_Board[dgnc_NumBoards];\r\nif (!brd)\r\nreturn -ENOMEM;\r\nbrd->msgbuf_head = kcalloc(8192, sizeof(u8), GFP_KERNEL);\r\nbrd->msgbuf = brd->msgbuf_head;\r\nif (!brd->msgbuf) {\r\nkfree(brd);\r\nreturn -ENOMEM;\r\n}\r\nbrd->magic = DGNC_BOARD_MAGIC;\r\nbrd->boardnum = dgnc_NumBoards;\r\nbrd->vendor = dgnc_pci_tbl[id].vendor;\r\nbrd->device = dgnc_pci_tbl[id].device;\r\nbrd->pdev = pdev;\r\nbrd->pci_bus = pdev->bus->number;\r\nbrd->pci_slot = PCI_SLOT(pdev->devfn);\r\nbrd->name = dgnc_Ids[id].name;\r\nbrd->maxports = dgnc_Ids[id].maxports;\r\nif (dgnc_Ids[i].is_pci_express)\r\nbrd->bd_flags |= BD_IS_PCI_EXPRESS;\r\nbrd->dpastatus = BD_NOFEP;\r\ninit_waitqueue_head(&brd->state_wait);\r\nspin_lock_init(&brd->bd_lock);\r\nspin_lock_init(&brd->bd_intr_lock);\r\nbrd->state = BOARD_FOUND;\r\nfor (i = 0; i < MAXPORTS; i++)\r\nbrd->channels[i] = NULL;\r\npci_read_config_word(pdev, PCI_SUBSYSTEM_VENDOR_ID, &brd->subvendor);\r\npci_read_config_word(pdev, PCI_SUBSYSTEM_ID, &brd->subdevice);\r\npci_read_config_byte(pdev, PCI_REVISION_ID, &brd->rev);\r\npci_irq = pdev->irq;\r\nbrd->irq = pci_irq;\r\nswitch (brd->device) {\r\ncase PCI_DEVICE_CLASSIC_4_DID:\r\ncase PCI_DEVICE_CLASSIC_8_DID:\r\ncase PCI_DEVICE_CLASSIC_4_422_DID:\r\ncase PCI_DEVICE_CLASSIC_8_422_DID:\r\nbrd->dpatype = T_CLASSIC | T_PCIBUS;\r\nbrd->membase = pci_resource_start(pdev, 4);\r\nif (!brd->membase) {\r\ndev_err(&brd->pdev->dev,\r\n"Card has no PCI IO resources, failing.\n");\r\nreturn -ENODEV;\r\n}\r\nbrd->membase_end = pci_resource_end(pdev, 4);\r\nif (brd->membase & 1)\r\nbrd->membase &= ~3;\r\nelse\r\nbrd->membase &= ~15;\r\nbrd->iobase = pci_resource_start(pdev, 1);\r\nbrd->iobase_end = pci_resource_end(pdev, 1);\r\nbrd->iobase = ((unsigned int)(brd->iobase)) & 0xFFFE;\r\nbrd->bd_ops = &dgnc_cls_ops;\r\nbrd->bd_uart_offset = 0x8;\r\nbrd->bd_dividend = 921600;\r\ndgnc_do_remap(brd);\r\nbrd->bd_ops->vpd(brd);\r\noutb(0x43, brd->iobase + 0x4c);\r\nbreak;\r\ncase PCI_DEVICE_NEO_4_DID:\r\ncase PCI_DEVICE_NEO_8_DID:\r\ncase PCI_DEVICE_NEO_2DB9_DID:\r\ncase PCI_DEVICE_NEO_2DB9PRI_DID:\r\ncase PCI_DEVICE_NEO_2RJ45_DID:\r\ncase PCI_DEVICE_NEO_2RJ45PRI_DID:\r\ncase PCI_DEVICE_NEO_1_422_DID:\r\ncase PCI_DEVICE_NEO_1_422_485_DID:\r\ncase PCI_DEVICE_NEO_2_422_485_DID:\r\ncase PCI_DEVICE_NEO_EXPRESS_8_DID:\r\ncase PCI_DEVICE_NEO_EXPRESS_4_DID:\r\ncase PCI_DEVICE_NEO_EXPRESS_4RJ45_DID:\r\ncase PCI_DEVICE_NEO_EXPRESS_8RJ45_DID:\r\nif (brd->bd_flags & BD_IS_PCI_EXPRESS)\r\nbrd->dpatype = T_NEO_EXPRESS | T_PCIBUS;\r\nelse\r\nbrd->dpatype = T_NEO | T_PCIBUS;\r\nbrd->membase = pci_resource_start(pdev, 0);\r\nbrd->membase_end = pci_resource_end(pdev, 0);\r\nif (brd->membase & 1)\r\nbrd->membase &= ~3;\r\nelse\r\nbrd->membase &= ~15;\r\nbrd->bd_ops = &dgnc_neo_ops;\r\nbrd->bd_uart_offset = 0x200;\r\nbrd->bd_dividend = 921600;\r\ndgnc_do_remap(brd);\r\nif (brd->re_map_membase) {\r\nbrd->dvid = readb(brd->re_map_membase + 0x8D);\r\nbrd->bd_ops->vpd(brd);\r\n}\r\nbreak;\r\ndefault:\r\ndev_err(&brd->pdev->dev,\r\n"Didn't find any compatible Neo/Classic PCI boards.\n");\r\nreturn -ENXIO;\r\n}\r\nrc = dgnc_tty_register(brd);\r\nif (rc < 0) {\r\npr_err(DRVSTR ": Can't register tty devices (%d)\n", rc);\r\ngoto failed;\r\n}\r\nrc = dgnc_finalize_board_init(brd);\r\nif (rc < 0) {\r\npr_err(DRVSTR ": Can't finalize board init (%d)\n", rc);\r\ngoto failed;\r\n}\r\nrc = dgnc_tty_init(brd);\r\nif (rc < 0) {\r\npr_err(DRVSTR ": Can't init tty devices (%d)\n", rc);\r\ngoto failed;\r\n}\r\nbrd->state = BOARD_READY;\r\nbrd->dpastatus = BD_RUNNING;\r\ndgnc_create_ports_sysfiles(brd);\r\ntasklet_init(&brd->helper_tasklet,\r\nbrd->bd_ops->tasklet,\r\n(unsigned long)brd);\r\nspin_lock_irqsave(&dgnc_global_lock, flags);\r\nbrd->msgbuf = NULL;\r\ndev_dbg(&brd->pdev->dev, "%s\n", brd->msgbuf_head);\r\nkfree(brd->msgbuf_head);\r\nbrd->msgbuf_head = NULL;\r\nspin_unlock_irqrestore(&dgnc_global_lock, flags);\r\nwake_up_interruptible(&brd->state_wait);\r\nreturn 0;\r\nfailed:\r\ndgnc_tty_uninit(brd);\r\nbrd->state = BOARD_FAILED;\r\nbrd->dpastatus = BD_NOFEP;\r\nreturn -ENXIO;\r\n}\r\nstatic int dgnc_finalize_board_init(struct dgnc_board *brd)\r\n{\r\nint rc = 0;\r\nif (!brd || brd->magic != DGNC_BOARD_MAGIC)\r\nreturn -ENODEV;\r\nif (brd->irq) {\r\nrc = request_irq(brd->irq, brd->bd_ops->intr,\r\nIRQF_SHARED, "DGNC", brd);\r\nif (rc) {\r\ndev_err(&brd->pdev->dev,\r\n"Failed to hook IRQ %d\n", brd->irq);\r\nbrd->state = BOARD_FAILED;\r\nbrd->dpastatus = BD_NOFEP;\r\nrc = -ENODEV;\r\n}\r\n}\r\nreturn rc;\r\n}\r\nstatic void dgnc_do_remap(struct dgnc_board *brd)\r\n{\r\nif (!brd || brd->magic != DGNC_BOARD_MAGIC)\r\nreturn;\r\nbrd->re_map_membase = ioremap(brd->membase, 0x1000);\r\n}\r\nstatic void dgnc_poll_handler(ulong dummy)\r\n{\r\nstruct dgnc_board *brd;\r\nunsigned long flags;\r\nint i;\r\nunsigned long new_time;\r\nfor (i = 0; i < dgnc_NumBoards; i++) {\r\nbrd = dgnc_Board[i];\r\nspin_lock_irqsave(&brd->bd_lock, flags);\r\nif (brd->state == BOARD_FAILED) {\r\nspin_unlock_irqrestore(&brd->bd_lock, flags);\r\ncontinue;\r\n}\r\ntasklet_schedule(&brd->helper_tasklet);\r\nspin_unlock_irqrestore(&brd->bd_lock, flags);\r\n}\r\nspin_lock_irqsave(&dgnc_poll_lock, flags);\r\ndgnc_poll_time += dgnc_jiffies_from_ms(dgnc_poll_tick);\r\nnew_time = dgnc_poll_time - jiffies;\r\nif ((ulong)new_time >= 2 * dgnc_poll_tick)\r\ndgnc_poll_time = jiffies + dgnc_jiffies_from_ms(dgnc_poll_tick);\r\nsetup_timer(&dgnc_poll_timer, dgnc_poll_handler, 0);\r\ndgnc_poll_timer.expires = dgnc_poll_time;\r\nspin_unlock_irqrestore(&dgnc_poll_lock, flags);\r\nif (!dgnc_poll_stop)\r\nadd_timer(&dgnc_poll_timer);\r\n}

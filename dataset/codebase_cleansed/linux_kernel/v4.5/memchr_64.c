void *memchr(const void *s, int c, size_t n)\r\n{\r\nconst uint64_t *last_word_ptr;\r\nconst uint64_t *p;\r\nconst char *last_byte_ptr;\r\nuintptr_t s_int;\r\nuint64_t goal, before_mask, v, bits;\r\nchar *ret;\r\nif (__builtin_expect(n == 0, 0)) {\r\nreturn NULL;\r\n}\r\ns_int = (uintptr_t) s;\r\np = (const uint64_t *)(s_int & -8);\r\ngoal = copy_byte(c);\r\nbefore_mask = MASK(s_int);\r\nv = (*p | before_mask) ^ (goal & before_mask);\r\nlast_byte_ptr = (const char *)s + n - 1;\r\nlast_word_ptr = (const uint64_t *)((uintptr_t) last_byte_ptr & -8);\r\nwhile ((bits = __insn_v1cmpeq(v, goal)) == 0) {\r\nif (__builtin_expect(p == last_word_ptr, 0)) {\r\nreturn NULL;\r\n}\r\nv = *++p;\r\n}\r\nret = ((char *)p) + (CFZ(bits) >> 3);\r\nreturn (ret <= last_byte_ptr) ? ret : NULL;\r\n}

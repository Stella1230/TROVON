static unsigned long hypervisor_get_time(void)\r\n{\r\nunsigned long ret, time;\r\nint retries = 10000;\r\nretry:\r\nret = sun4v_tod_get(&time);\r\nif (ret == HV_EOK)\r\nreturn time;\r\nif (ret == HV_EWOULDBLOCK) {\r\nif (--retries > 0) {\r\nudelay(100);\r\ngoto retry;\r\n}\r\npr_warn("tod_get() timed out.\n");\r\nreturn 0;\r\n}\r\npr_warn("tod_get() not supported.\n");\r\nreturn 0;\r\n}\r\nstatic int sun4v_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nrtc_time_to_tm(hypervisor_get_time(), tm);\r\nreturn 0;\r\n}\r\nstatic int hypervisor_set_time(unsigned long secs)\r\n{\r\nunsigned long ret;\r\nint retries = 10000;\r\nretry:\r\nret = sun4v_tod_set(secs);\r\nif (ret == HV_EOK)\r\nreturn 0;\r\nif (ret == HV_EWOULDBLOCK) {\r\nif (--retries > 0) {\r\nudelay(100);\r\ngoto retry;\r\n}\r\npr_warn("tod_set() timed out.\n");\r\nreturn -EAGAIN;\r\n}\r\npr_warn("tod_set() not supported.\n");\r\nreturn -EOPNOTSUPP;\r\n}\r\nstatic int sun4v_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nunsigned long secs;\r\nint err;\r\nerr = rtc_tm_to_time(tm, &secs);\r\nif (err)\r\nreturn err;\r\nreturn hypervisor_set_time(secs);\r\n}\r\nstatic int __init sun4v_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct rtc_device *rtc;\r\nrtc = devm_rtc_device_register(&pdev->dev, "sun4v",\r\n&sun4v_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc))\r\nreturn PTR_ERR(rtc);\r\nplatform_set_drvdata(pdev, rtc);\r\nreturn 0;\r\n}

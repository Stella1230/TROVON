static void map_dma_mem(int bus_id, int dev_id, void *start, size_t len,\r\nu64 *real_bus_addr)\r\n{\r\ns64 result;\r\nu64 real_addr = ((u64)start) & 0x0fffffffffffffffUL;\r\nu64 real_end = real_addr + len;\r\nu64 map_start = real_addr & ~0xfff;\r\nu64 map_end = (real_end + 0xfff) & ~0xfff;\r\nu64 bus_addr = 0;\r\nu64 flags = 0xf800000000000000UL;\r\nresult = lv1_allocate_device_dma_region(bus_id, dev_id,\r\nmap_end - map_start, 12, 0,\r\n&bus_addr);\r\nif (result)\r\nlv1_panic(0);\r\nresult = lv1_map_device_dma_region(bus_id, dev_id, map_start,\r\nbus_addr, map_end - map_start,\r\nflags);\r\nif (result)\r\nlv1_panic(0);\r\n*real_bus_addr = bus_addr + real_addr - map_start;\r\n}\r\nstatic int unmap_dma_mem(int bus_id, int dev_id, u64 bus_addr, size_t len)\r\n{\r\ns64 result;\r\nu64 real_bus_addr;\r\nreal_bus_addr = bus_addr & ~0xfff;\r\nlen += bus_addr - real_bus_addr;\r\nlen = (len + 0xfff) & ~0xfff;\r\nresult = lv1_unmap_device_dma_region(bus_id, dev_id, real_bus_addr,\r\nlen);\r\nif (result)\r\nreturn result;\r\nreturn lv1_free_device_dma_region(bus_id, dev_id, real_bus_addr);\r\n}\r\nstatic void gelic_debug_init(void)\r\n{\r\ns64 result;\r\nu64 v2;\r\nu64 mac;\r\nu64 vlan_id;\r\nresult = lv1_open_device(GELIC_BUS_ID, GELIC_DEVICE_ID, 0);\r\nif (result)\r\nlv1_panic(0);\r\nmap_dma_mem(GELIC_BUS_ID, GELIC_DEVICE_ID, &dbg, sizeof(dbg),\r\n&bus_addr);\r\nmemset(&dbg, 0, sizeof(dbg));\r\ndbg.descr.buf_addr = bus_addr + offsetof(struct debug_block, pkt);\r\nwmb();\r\nresult = lv1_net_control(GELIC_BUS_ID, GELIC_DEVICE_ID,\r\nGELIC_LV1_GET_MAC_ADDRESS, 0, 0, 0,\r\n&mac, &v2);\r\nif (result)\r\nlv1_panic(0);\r\nmac <<= 16;\r\nh_eth = (struct ethhdr *)dbg.pkt;\r\nmemset(&h_eth->dest, 0xff, 6);\r\nmemcpy(&h_eth->src, &mac, 6);\r\nheader_size = sizeof(struct ethhdr);\r\nresult = lv1_net_control(GELIC_BUS_ID, GELIC_DEVICE_ID,\r\nGELIC_LV1_GET_VLAN_ID,\r\nGELIC_LV1_VLAN_TX_ETHERNET_0, 0, 0,\r\n&vlan_id, &v2);\r\nif (!result) {\r\nh_eth->type = 0x8100;\r\nheader_size += sizeof(struct vlantag);\r\nh_vlan = (struct vlantag *)(h_eth + 1);\r\nh_vlan->vlan = vlan_id;\r\nh_vlan->subtype = 0x0800;\r\nh_ip = (struct iphdr *)(h_vlan + 1);\r\n} else {\r\nh_eth->type = 0x0800;\r\nh_ip = (struct iphdr *)(h_eth + 1);\r\n}\r\nheader_size += sizeof(struct iphdr);\r\nh_ip->ver_len = 0x45;\r\nh_ip->ttl = 10;\r\nh_ip->proto = 0x11;\r\nh_ip->src = 0x00000000;\r\nh_ip->dest = 0xffffffff;\r\nheader_size += sizeof(struct udphdr);\r\nh_udp = (struct udphdr *)(h_ip + 1);\r\nh_udp->src = GELIC_DEBUG_PORT;\r\nh_udp->dest = GELIC_DEBUG_PORT;\r\npmsgc = pmsg = (char *)(h_udp + 1);\r\n}\r\nstatic void gelic_debug_shutdown(void)\r\n{\r\nif (bus_addr)\r\nunmap_dma_mem(GELIC_BUS_ID, GELIC_DEVICE_ID,\r\nbus_addr, sizeof(dbg));\r\nlv1_close_device(GELIC_BUS_ID, GELIC_DEVICE_ID);\r\n}\r\nstatic void gelic_sendbuf(int msgsize)\r\n{\r\nu16 *p;\r\nu32 sum;\r\nint i;\r\ndbg.descr.buf_size = header_size + msgsize;\r\nh_ip->total_length = msgsize + sizeof(struct udphdr) +\r\nsizeof(struct iphdr);\r\nh_udp->len = msgsize + sizeof(struct udphdr);\r\nh_ip->checksum = 0;\r\nsum = 0;\r\np = (u16 *)h_ip;\r\nfor (i = 0; i < 5; i++)\r\nsum += *p++;\r\nh_ip->checksum = ~(sum + (sum >> 16));\r\ndbg.descr.dmac_cmd_status = GELIC_DESCR_DMA_CMD_NO_CHKSUM |\r\nGELIC_DESCR_TX_DMA_FRAME_TAIL;\r\ndbg.descr.result_size = 0;\r\ndbg.descr.data_status = 0;\r\nwmb();\r\nlv1_net_start_tx_dma(GELIC_BUS_ID, GELIC_DEVICE_ID, bus_addr, 0);\r\nwhile ((dbg.descr.dmac_cmd_status & GELIC_DESCR_DMA_STAT_MASK) ==\r\nGELIC_DESCR_DMA_CARDOWNED)\r\ncpu_relax();\r\n}\r\nstatic void ps3gelic_udbg_putc(char ch)\r\n{\r\n*pmsgc++ = ch;\r\nif (ch == '\n' || (pmsgc-pmsg) >= GELIC_MAX_MESSAGE_SIZE) {\r\ngelic_sendbuf(pmsgc-pmsg);\r\npmsgc = pmsg;\r\n}\r\n}\r\nvoid __init udbg_init_ps3gelic(void)\r\n{\r\ngelic_debug_init();\r\nudbg_putc = ps3gelic_udbg_putc;\r\n}\r\nvoid udbg_shutdown_ps3gelic(void)\r\n{\r\nudbg_putc = NULL;\r\ngelic_debug_shutdown();\r\n}

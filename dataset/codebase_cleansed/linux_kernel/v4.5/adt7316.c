static ssize_t adt7316_show_enabled(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn sprintf(buf, "%d\n", !!(chip->config1 & ADT7316_EN));\r\n}\r\nstatic ssize_t _adt7316_store_enabled(struct adt7316_chip_info *chip,\r\nint enable)\r\n{\r\nu8 config1;\r\nint ret;\r\nif (enable)\r\nconfig1 = chip->config1 | ADT7316_EN;\r\nelse\r\nconfig1 = chip->config1 & ~ADT7316_EN;\r\nret = chip->bus.write(chip->bus.client, ADT7316_CONFIG1, config1);\r\nif (ret)\r\nreturn -EIO;\r\nchip->config1 = config1;\r\nreturn ret;\r\n}\r\nstatic ssize_t adt7316_store_enabled(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nint enable;\r\nif (buf[0] == '1')\r\nenable = 1;\r\nelse\r\nenable = 0;\r\nif (_adt7316_store_enabled(chip, enable) < 0)\r\nreturn -EIO;\r\nreturn len;\r\n}\r\nstatic ssize_t adt7316_show_select_ex_temp(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nif ((chip->id & ID_FAMILY_MASK) != ID_ADT75XX)\r\nreturn -EPERM;\r\nreturn sprintf(buf, "%d\n", !!(chip->config1 & ADT7516_SEL_EX_TEMP));\r\n}\r\nstatic ssize_t adt7316_store_select_ex_temp(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nu8 config1;\r\nint ret;\r\nif ((chip->id & ID_FAMILY_MASK) != ID_ADT75XX)\r\nreturn -EPERM;\r\nconfig1 = chip->config1 & (~ADT7516_SEL_EX_TEMP);\r\nif (buf[0] == '1')\r\nconfig1 |= ADT7516_SEL_EX_TEMP;\r\nret = chip->bus.write(chip->bus.client, ADT7316_CONFIG1, config1);\r\nif (ret)\r\nreturn -EIO;\r\nchip->config1 = config1;\r\nreturn len;\r\n}\r\nstatic ssize_t adt7316_show_mode(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nif (chip->config2 & ADT7316_AD_SINGLE_CH_MODE)\r\nreturn sprintf(buf, "single_channel\n");\r\nreturn sprintf(buf, "round_robin\n");\r\n}\r\nstatic ssize_t adt7316_store_mode(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nu8 config2;\r\nint ret;\r\nconfig2 = chip->config2 & (~ADT7316_AD_SINGLE_CH_MODE);\r\nif (!memcmp(buf, "single_channel", 14))\r\nconfig2 |= ADT7316_AD_SINGLE_CH_MODE;\r\nret = chip->bus.write(chip->bus.client, ADT7316_CONFIG2, config2);\r\nif (ret)\r\nreturn -EIO;\r\nchip->config2 = config2;\r\nreturn len;\r\n}\r\nstatic ssize_t adt7316_show_all_modes(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn sprintf(buf, "single_channel\nround_robin\n");\r\n}\r\nstatic ssize_t adt7316_show_ad_channel(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nif (!(chip->config2 & ADT7316_AD_SINGLE_CH_MODE))\r\nreturn -EPERM;\r\nswitch (chip->config2 & ADT7516_AD_SINGLE_CH_MASK) {\r\ncase ADT7316_AD_SINGLE_CH_VDD:\r\nreturn sprintf(buf, "0 - VDD\n");\r\ncase ADT7316_AD_SINGLE_CH_IN:\r\nreturn sprintf(buf, "1 - Internal Temperature\n");\r\ncase ADT7316_AD_SINGLE_CH_EX:\r\nif (((chip->id & ID_FAMILY_MASK) == ID_ADT75XX) &&\r\n(chip->config1 & ADT7516_SEL_AIN1_2_EX_TEMP_MASK) == 0)\r\nreturn sprintf(buf, "2 - AIN1\n");\r\nreturn sprintf(buf, "2 - External Temperature\n");\r\ncase ADT7516_AD_SINGLE_CH_AIN2:\r\nif ((chip->config1 & ADT7516_SEL_AIN1_2_EX_TEMP_MASK) == 0)\r\nreturn sprintf(buf, "3 - AIN2\n");\r\nreturn sprintf(buf, "N/A\n");\r\ncase ADT7516_AD_SINGLE_CH_AIN3:\r\nif (chip->config1 & ADT7516_SEL_AIN3)\r\nreturn sprintf(buf, "4 - AIN3\n");\r\nreturn sprintf(buf, "N/A\n");\r\ncase ADT7516_AD_SINGLE_CH_AIN4:\r\nreturn sprintf(buf, "5 - AIN4\n");\r\ndefault:\r\nreturn sprintf(buf, "N/A\n");\r\n}\r\n}\r\nstatic ssize_t adt7316_store_ad_channel(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nu8 config2;\r\nu8 data;\r\nint ret;\r\nif (!(chip->config2 & ADT7316_AD_SINGLE_CH_MODE))\r\nreturn -EPERM;\r\nret = kstrtou8(buf, 10, &data);\r\nif (ret)\r\nreturn -EINVAL;\r\nif ((chip->id & ID_FAMILY_MASK) == ID_ADT75XX) {\r\nif (data > 5)\r\nreturn -EINVAL;\r\nconfig2 = chip->config2 & (~ADT7516_AD_SINGLE_CH_MASK);\r\n} else {\r\nif (data > 2)\r\nreturn -EINVAL;\r\nconfig2 = chip->config2 & (~ADT7316_AD_SINGLE_CH_MASK);\r\n}\r\nconfig2 |= data;\r\nret = chip->bus.write(chip->bus.client, ADT7316_CONFIG2, config2);\r\nif (ret)\r\nreturn -EIO;\r\nchip->config2 = config2;\r\nreturn len;\r\n}\r\nstatic ssize_t adt7316_show_all_ad_channels(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nif (!(chip->config2 & ADT7316_AD_SINGLE_CH_MODE))\r\nreturn -EPERM;\r\nif ((chip->id & ID_FAMILY_MASK) == ID_ADT75XX)\r\nreturn sprintf(buf, "0 - VDD\n1 - Internal Temperature\n"\r\n"2 - External Temperature or AIN1\n"\r\n"3 - AIN2\n4 - AIN3\n5 - AIN4\n");\r\nelse\r\nreturn sprintf(buf, "0 - VDD\n1 - Internal Temperature\n"\r\n"2 - External Temperature\n");\r\n}\r\nstatic ssize_t adt7316_show_disable_averaging(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn sprintf(buf, "%d\n",\r\n!!(chip->config2 & ADT7316_DISABLE_AVERAGING));\r\n}\r\nstatic ssize_t adt7316_store_disable_averaging(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nu8 config2;\r\nint ret;\r\nconfig2 = chip->config2 & (~ADT7316_DISABLE_AVERAGING);\r\nif (buf[0] == '1')\r\nconfig2 |= ADT7316_DISABLE_AVERAGING;\r\nret = chip->bus.write(chip->bus.client, ADT7316_CONFIG2, config2);\r\nif (ret)\r\nreturn -EIO;\r\nchip->config2 = config2;\r\nreturn len;\r\n}\r\nstatic ssize_t adt7316_show_enable_smbus_timeout(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn sprintf(buf, "%d\n",\r\n!!(chip->config2 & ADT7316_EN_SMBUS_TIMEOUT));\r\n}\r\nstatic ssize_t adt7316_store_enable_smbus_timeout(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nu8 config2;\r\nint ret;\r\nconfig2 = chip->config2 & (~ADT7316_EN_SMBUS_TIMEOUT);\r\nif (buf[0] == '1')\r\nconfig2 |= ADT7316_EN_SMBUS_TIMEOUT;\r\nret = chip->bus.write(chip->bus.client, ADT7316_CONFIG2, config2);\r\nif (ret)\r\nreturn -EIO;\r\nchip->config2 = config2;\r\nreturn len;\r\n}\r\nstatic ssize_t adt7316_show_powerdown(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn sprintf(buf, "%d\n", !!(chip->config1 & ADT7316_PD));\r\n}\r\nstatic ssize_t adt7316_store_powerdown(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nu8 config1;\r\nint ret;\r\nconfig1 = chip->config1 & (~ADT7316_PD);\r\nif (buf[0] == '1')\r\nconfig1 |= ADT7316_PD;\r\nret = chip->bus.write(chip->bus.client, ADT7316_CONFIG1, config1);\r\nif (ret)\r\nreturn -EIO;\r\nchip->config1 = config1;\r\nreturn len;\r\n}\r\nstatic ssize_t adt7316_show_fast_ad_clock(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn sprintf(buf, "%d\n", !!(chip->config3 & ADT7316_ADCLK_22_5));\r\n}\r\nstatic ssize_t adt7316_store_fast_ad_clock(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nu8 config3;\r\nint ret;\r\nconfig3 = chip->config3 & (~ADT7316_ADCLK_22_5);\r\nif (buf[0] == '1')\r\nconfig3 |= ADT7316_ADCLK_22_5;\r\nret = chip->bus.write(chip->bus.client, ADT7316_CONFIG3, config3);\r\nif (ret)\r\nreturn -EIO;\r\nchip->config3 = config3;\r\nreturn len;\r\n}\r\nstatic ssize_t adt7316_show_da_high_resolution(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nif (chip->config3 & ADT7316_DA_HIGH_RESOLUTION) {\r\nif (chip->id == ID_ADT7316 || chip->id == ID_ADT7516)\r\nreturn sprintf(buf, "1 (12 bits)\n");\r\nelse if (chip->id == ID_ADT7317 || chip->id == ID_ADT7517)\r\nreturn sprintf(buf, "1 (10 bits)\n");\r\n}\r\nreturn sprintf(buf, "0 (8 bits)\n");\r\n}\r\nstatic ssize_t adt7316_store_da_high_resolution(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nu8 config3;\r\nint ret;\r\nchip->dac_bits = 8;\r\nif (buf[0] == '1') {\r\nconfig3 = chip->config3 | ADT7316_DA_HIGH_RESOLUTION;\r\nif (chip->id == ID_ADT7316 || chip->id == ID_ADT7516)\r\nchip->dac_bits = 12;\r\nelse if (chip->id == ID_ADT7317 || chip->id == ID_ADT7517)\r\nchip->dac_bits = 10;\r\n} else\r\nconfig3 = chip->config3 & (~ADT7316_DA_HIGH_RESOLUTION);\r\nret = chip->bus.write(chip->bus.client, ADT7316_CONFIG3, config3);\r\nif (ret)\r\nreturn -EIO;\r\nchip->config3 = config3;\r\nreturn len;\r\n}\r\nstatic ssize_t adt7316_show_AIN_internal_Vref(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nif ((chip->id & ID_FAMILY_MASK) != ID_ADT75XX)\r\nreturn -EPERM;\r\nreturn sprintf(buf, "%d\n",\r\n!!(chip->config3 & ADT7516_AIN_IN_VREF));\r\n}\r\nstatic ssize_t adt7316_store_AIN_internal_Vref(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nu8 config3;\r\nint ret;\r\nif ((chip->id & ID_FAMILY_MASK) != ID_ADT75XX)\r\nreturn -EPERM;\r\nif (buf[0] != '1')\r\nconfig3 = chip->config3 & (~ADT7516_AIN_IN_VREF);\r\nelse\r\nconfig3 = chip->config3 | ADT7516_AIN_IN_VREF;\r\nret = chip->bus.write(chip->bus.client, ADT7316_CONFIG3, config3);\r\nif (ret)\r\nreturn -EIO;\r\nchip->config3 = config3;\r\nreturn len;\r\n}\r\nstatic ssize_t adt7316_show_enable_prop_DACA(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn sprintf(buf, "%d\n",\r\n!!(chip->config3 & ADT7316_EN_IN_TEMP_PROP_DACA));\r\n}\r\nstatic ssize_t adt7316_store_enable_prop_DACA(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nu8 config3;\r\nint ret;\r\nconfig3 = chip->config3 & (~ADT7316_EN_IN_TEMP_PROP_DACA);\r\nif (buf[0] == '1')\r\nconfig3 |= ADT7316_EN_IN_TEMP_PROP_DACA;\r\nret = chip->bus.write(chip->bus.client, ADT7316_CONFIG3, config3);\r\nif (ret)\r\nreturn -EIO;\r\nchip->config3 = config3;\r\nreturn len;\r\n}\r\nstatic ssize_t adt7316_show_enable_prop_DACB(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn sprintf(buf, "%d\n",\r\n!!(chip->config3 & ADT7316_EN_EX_TEMP_PROP_DACB));\r\n}\r\nstatic ssize_t adt7316_store_enable_prop_DACB(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nu8 config3;\r\nint ret;\r\nconfig3 = chip->config3 & (~ADT7316_EN_EX_TEMP_PROP_DACB);\r\nif (buf[0] == '1')\r\nconfig3 |= ADT7316_EN_EX_TEMP_PROP_DACB;\r\nret = chip->bus.write(chip->bus.client, ADT7316_CONFIG3, config3);\r\nif (ret)\r\nreturn -EIO;\r\nchip->config3 = config3;\r\nreturn len;\r\n}\r\nstatic ssize_t adt7316_show_DAC_2Vref_ch_mask(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn sprintf(buf, "0x%x\n",\r\nchip->dac_config & ADT7316_DA_2VREF_CH_MASK);\r\n}\r\nstatic ssize_t adt7316_store_DAC_2Vref_ch_mask(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nu8 dac_config;\r\nu8 data;\r\nint ret;\r\nret = kstrtou8(buf, 16, &data);\r\nif (ret || data > ADT7316_DA_2VREF_CH_MASK)\r\nreturn -EINVAL;\r\ndac_config = chip->dac_config & (~ADT7316_DA_2VREF_CH_MASK);\r\ndac_config |= data;\r\nret = chip->bus.write(chip->bus.client, ADT7316_DAC_CONFIG, dac_config);\r\nif (ret)\r\nreturn -EIO;\r\nchip->dac_config = dac_config;\r\nreturn len;\r\n}\r\nstatic ssize_t adt7316_show_DAC_update_mode(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nif (!(chip->config3 & ADT7316_DA_EN_VIA_DAC_LDCA))\r\nreturn sprintf(buf, "manual\n");\r\nswitch (chip->dac_config & ADT7316_DA_EN_MODE_MASK) {\r\ncase ADT7316_DA_EN_MODE_SINGLE:\r\nreturn sprintf(buf,\r\n"0 - auto at any MSB DAC writing\n");\r\ncase ADT7316_DA_EN_MODE_AB_CD:\r\nreturn sprintf(buf,\r\n"1 - auto at MSB DAC AB and CD writing\n");\r\ncase ADT7316_DA_EN_MODE_ABCD:\r\nreturn sprintf(buf,\r\n"2 - auto at MSB DAC ABCD writing\n");\r\ndefault:\r\nreturn sprintf(buf, "3 - manual\n");\r\n}\r\n}\r\nstatic ssize_t adt7316_store_DAC_update_mode(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nu8 dac_config;\r\nu8 data;\r\nint ret;\r\nif (!(chip->config3 & ADT7316_DA_EN_VIA_DAC_LDCA))\r\nreturn -EPERM;\r\nret = kstrtou8(buf, 10, &data);\r\nif (ret || data > ADT7316_DA_EN_MODE_MASK)\r\nreturn -EINVAL;\r\ndac_config = chip->dac_config & (~ADT7316_DA_EN_MODE_MASK);\r\ndac_config |= data;\r\nret = chip->bus.write(chip->bus.client, ADT7316_DAC_CONFIG, dac_config);\r\nif (ret)\r\nreturn -EIO;\r\nchip->dac_config = dac_config;\r\nreturn len;\r\n}\r\nstatic ssize_t adt7316_show_all_DAC_update_modes(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nif (chip->config3 & ADT7316_DA_EN_VIA_DAC_LDCA)\r\nreturn sprintf(buf, "0 - auto at any MSB DAC writing\n"\r\n"1 - auto at MSB DAC AB and CD writing\n"\r\n"2 - auto at MSB DAC ABCD writing\n"\r\n"3 - manual\n");\r\nelse\r\nreturn sprintf(buf, "manual\n");\r\n}\r\nstatic ssize_t adt7316_store_update_DAC(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nu8 ldac_config;\r\nu8 data;\r\nint ret;\r\nif (chip->config3 & ADT7316_DA_EN_VIA_DAC_LDCA) {\r\nif ((chip->dac_config & ADT7316_DA_EN_MODE_MASK) !=\r\nADT7316_DA_EN_MODE_LDAC)\r\nreturn -EPERM;\r\nret = kstrtou8(buf, 16, &data);\r\nif (ret || data > ADT7316_LDAC_EN_DA_MASK)\r\nreturn -EINVAL;\r\nldac_config = chip->ldac_config & (~ADT7316_LDAC_EN_DA_MASK);\r\nldac_config |= data;\r\nret = chip->bus.write(chip->bus.client, ADT7316_LDAC_CONFIG,\r\nldac_config);\r\nif (ret)\r\nreturn -EIO;\r\n} else {\r\ngpio_set_value(chip->ldac_pin, 0);\r\ngpio_set_value(chip->ldac_pin, 1);\r\n}\r\nreturn len;\r\n}\r\nstatic ssize_t adt7316_show_DA_AB_Vref_bypass(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nif ((chip->id & ID_FAMILY_MASK) == ID_ADT75XX)\r\nreturn -EPERM;\r\nreturn sprintf(buf, "%d\n",\r\n!!(chip->dac_config & ADT7316_VREF_BYPASS_DAC_AB));\r\n}\r\nstatic ssize_t adt7316_store_DA_AB_Vref_bypass(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nu8 dac_config;\r\nint ret;\r\nif ((chip->id & ID_FAMILY_MASK) == ID_ADT75XX)\r\nreturn -EPERM;\r\ndac_config = chip->dac_config & (~ADT7316_VREF_BYPASS_DAC_AB);\r\nif (buf[0] == '1')\r\ndac_config |= ADT7316_VREF_BYPASS_DAC_AB;\r\nret = chip->bus.write(chip->bus.client, ADT7316_DAC_CONFIG, dac_config);\r\nif (ret)\r\nreturn -EIO;\r\nchip->dac_config = dac_config;\r\nreturn len;\r\n}\r\nstatic ssize_t adt7316_show_DA_CD_Vref_bypass(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nif ((chip->id & ID_FAMILY_MASK) == ID_ADT75XX)\r\nreturn -EPERM;\r\nreturn sprintf(buf, "%d\n",\r\n!!(chip->dac_config & ADT7316_VREF_BYPASS_DAC_CD));\r\n}\r\nstatic ssize_t adt7316_store_DA_CD_Vref_bypass(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nu8 dac_config;\r\nint ret;\r\nif ((chip->id & ID_FAMILY_MASK) == ID_ADT75XX)\r\nreturn -EPERM;\r\ndac_config = chip->dac_config & (~ADT7316_VREF_BYPASS_DAC_CD);\r\nif (buf[0] == '1')\r\ndac_config |= ADT7316_VREF_BYPASS_DAC_CD;\r\nret = chip->bus.write(chip->bus.client, ADT7316_DAC_CONFIG, dac_config);\r\nif (ret)\r\nreturn -EIO;\r\nchip->dac_config = dac_config;\r\nreturn len;\r\n}\r\nstatic ssize_t adt7316_show_DAC_internal_Vref(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nif ((chip->id & ID_FAMILY_MASK) == ID_ADT75XX)\r\nreturn sprintf(buf, "0x%x\n",\r\n(chip->dac_config & ADT7516_DAC_IN_VREF_MASK) >>\r\nADT7516_DAC_IN_VREF_OFFSET);\r\nelse\r\nreturn sprintf(buf, "%d\n",\r\n!!(chip->dac_config & ADT7316_DAC_IN_VREF));\r\n}\r\nstatic ssize_t adt7316_store_DAC_internal_Vref(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nu8 ldac_config;\r\nu8 data;\r\nint ret;\r\nif ((chip->id & ID_FAMILY_MASK) == ID_ADT75XX) {\r\nret = kstrtou8(buf, 16, &data);\r\nif (ret || data > 3)\r\nreturn -EINVAL;\r\nldac_config = chip->ldac_config & (~ADT7516_DAC_IN_VREF_MASK);\r\nif (data & 0x1)\r\nldac_config |= ADT7516_DAC_AB_IN_VREF;\r\nelse if (data & 0x2)\r\nldac_config |= ADT7516_DAC_CD_IN_VREF;\r\n} else {\r\nret = kstrtou8(buf, 16, &data);\r\nif (ret)\r\nreturn -EINVAL;\r\nldac_config = chip->ldac_config & (~ADT7316_DAC_IN_VREF);\r\nif (data)\r\nldac_config = chip->ldac_config | ADT7316_DAC_IN_VREF;\r\n}\r\nret = chip->bus.write(chip->bus.client, ADT7316_LDAC_CONFIG,\r\nldac_config);\r\nif (ret)\r\nreturn -EIO;\r\nchip->ldac_config = ldac_config;\r\nreturn len;\r\n}\r\nstatic ssize_t adt7316_show_ad(struct adt7316_chip_info *chip,\r\nint channel, char *buf)\r\n{\r\nu16 data;\r\nu8 msb, lsb;\r\nchar sign = ' ';\r\nint ret;\r\nif ((chip->config2 & ADT7316_AD_SINGLE_CH_MODE) &&\r\nchannel != (chip->config2 & ADT7516_AD_SINGLE_CH_MASK))\r\nreturn -EPERM;\r\nswitch (channel) {\r\ncase ADT7316_AD_SINGLE_CH_IN:\r\nret = chip->bus.read(chip->bus.client,\r\nADT7316_LSB_IN_TEMP_VDD, &lsb);\r\nif (ret)\r\nreturn -EIO;\r\nret = chip->bus.read(chip->bus.client,\r\nADT7316_AD_MSB_DATA_BASE + channel, &msb);\r\nif (ret)\r\nreturn -EIO;\r\ndata = msb << ADT7316_T_VALUE_FLOAT_OFFSET;\r\ndata |= lsb & ADT7316_LSB_IN_TEMP_MASK;\r\nbreak;\r\ncase ADT7316_AD_SINGLE_CH_VDD:\r\nret = chip->bus.read(chip->bus.client,\r\nADT7316_LSB_IN_TEMP_VDD, &lsb);\r\nif (ret)\r\nreturn -EIO;\r\nret = chip->bus.read(chip->bus.client,\r\nADT7316_AD_MSB_DATA_BASE + channel, &msb);\r\nif (ret)\r\nreturn -EIO;\r\ndata = msb << ADT7316_T_VALUE_FLOAT_OFFSET;\r\ndata |= (lsb & ADT7316_LSB_VDD_MASK) >> ADT7316_LSB_VDD_OFFSET;\r\nreturn sprintf(buf, "%d\n", data);\r\ndefault:\r\nret = chip->bus.read(chip->bus.client,\r\nADT7316_LSB_EX_TEMP_AIN, &lsb);\r\nif (ret)\r\nreturn -EIO;\r\nret = chip->bus.read(chip->bus.client,\r\nADT7316_AD_MSB_DATA_BASE + channel, &msb);\r\nif (ret)\r\nreturn -EIO;\r\ndata = msb << ADT7316_T_VALUE_FLOAT_OFFSET;\r\ndata |= lsb & (ADT7316_LSB_EX_TEMP_MASK <<\r\n(ADT7516_LSB_AIN_SHIFT * (channel -\r\n(ADT7316_MSB_EX_TEMP - ADT7316_AD_MSB_DATA_BASE))));\r\nif ((chip->id & ID_FAMILY_MASK) == ID_ADT75XX)\r\nreturn sprintf(buf, "%d\n", data);\r\nbreak;\r\n}\r\nif (data & ADT7316_T_VALUE_SIGN) {\r\ndata = (ADT7316_T_VALUE_SIGN << 1) - data;\r\nsign = '-';\r\n}\r\nreturn sprintf(buf, "%c%d.%.2d\n", sign,\r\n(data >> ADT7316_T_VALUE_FLOAT_OFFSET),\r\n(data & ADT7316_T_VALUE_FLOAT_MASK) * 25);\r\n}\r\nstatic ssize_t adt7316_show_VDD(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn adt7316_show_ad(chip, ADT7316_AD_SINGLE_CH_VDD, buf);\r\n}\r\nstatic ssize_t adt7316_show_in_temp(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn adt7316_show_ad(chip, ADT7316_AD_SINGLE_CH_IN, buf);\r\n}\r\nstatic ssize_t adt7316_show_ex_temp_AIN1(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn adt7316_show_ad(chip, ADT7316_AD_SINGLE_CH_EX, buf);\r\n}\r\nstatic ssize_t adt7316_show_AIN2(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn adt7316_show_ad(chip, ADT7516_AD_SINGLE_CH_AIN2, buf);\r\n}\r\nstatic ssize_t adt7316_show_AIN3(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn adt7316_show_ad(chip, ADT7516_AD_SINGLE_CH_AIN3, buf);\r\n}\r\nstatic ssize_t adt7316_show_AIN4(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn adt7316_show_ad(chip, ADT7516_AD_SINGLE_CH_AIN4, buf);\r\n}\r\nstatic ssize_t adt7316_show_temp_offset(struct adt7316_chip_info *chip,\r\nint offset_addr, char *buf)\r\n{\r\nint data;\r\nu8 val;\r\nint ret;\r\nret = chip->bus.read(chip->bus.client, offset_addr, &val);\r\nif (ret)\r\nreturn -EIO;\r\ndata = (int)val;\r\nif (val & 0x80)\r\ndata -= 256;\r\nreturn sprintf(buf, "%d\n", data);\r\n}\r\nstatic ssize_t adt7316_store_temp_offset(struct adt7316_chip_info *chip,\r\nint offset_addr, const char *buf, size_t len)\r\n{\r\nint data;\r\nu8 val;\r\nint ret;\r\nret = kstrtoint(buf, 10, &data);\r\nif (ret || data > 127 || data < -128)\r\nreturn -EINVAL;\r\nif (data < 0)\r\ndata += 256;\r\nval = (u8)data;\r\nret = chip->bus.write(chip->bus.client, offset_addr, val);\r\nif (ret)\r\nreturn -EIO;\r\nreturn len;\r\n}\r\nstatic ssize_t adt7316_show_in_temp_offset(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn adt7316_show_temp_offset(chip, ADT7316_IN_TEMP_OFFSET, buf);\r\n}\r\nstatic ssize_t adt7316_store_in_temp_offset(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn adt7316_store_temp_offset(chip, ADT7316_IN_TEMP_OFFSET, buf,\r\nlen);\r\n}\r\nstatic ssize_t adt7316_show_ex_temp_offset(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn adt7316_show_temp_offset(chip, ADT7316_EX_TEMP_OFFSET, buf);\r\n}\r\nstatic ssize_t adt7316_store_ex_temp_offset(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn adt7316_store_temp_offset(chip, ADT7316_EX_TEMP_OFFSET, buf,\r\nlen);\r\n}\r\nstatic ssize_t adt7316_show_in_analog_temp_offset(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn adt7316_show_temp_offset(chip,\r\nADT7316_IN_ANALOG_TEMP_OFFSET, buf);\r\n}\r\nstatic ssize_t adt7316_store_in_analog_temp_offset(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn adt7316_store_temp_offset(chip,\r\nADT7316_IN_ANALOG_TEMP_OFFSET, buf, len);\r\n}\r\nstatic ssize_t adt7316_show_ex_analog_temp_offset(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn adt7316_show_temp_offset(chip,\r\nADT7316_EX_ANALOG_TEMP_OFFSET, buf);\r\n}\r\nstatic ssize_t adt7316_store_ex_analog_temp_offset(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn adt7316_store_temp_offset(chip,\r\nADT7316_EX_ANALOG_TEMP_OFFSET, buf, len);\r\n}\r\nstatic ssize_t adt7316_show_DAC(struct adt7316_chip_info *chip,\r\nint channel, char *buf)\r\n{\r\nu16 data;\r\nu8 msb, lsb, offset;\r\nint ret;\r\nif (channel >= ADT7316_DA_MSB_DATA_REGS ||\r\n(channel == 0 &&\r\n(chip->config3 & ADT7316_EN_IN_TEMP_PROP_DACA)) ||\r\n(channel == 1 &&\r\n(chip->config3 & ADT7316_EN_EX_TEMP_PROP_DACB)))\r\nreturn -EPERM;\r\noffset = chip->dac_bits - 8;\r\nif (chip->dac_bits > 8) {\r\nret = chip->bus.read(chip->bus.client,\r\nADT7316_DA_DATA_BASE + channel * 2, &lsb);\r\nif (ret)\r\nreturn -EIO;\r\n}\r\nret = chip->bus.read(chip->bus.client,\r\nADT7316_DA_DATA_BASE + 1 + channel * 2, &msb);\r\nif (ret)\r\nreturn -EIO;\r\ndata = (msb << offset) + (lsb & ((1 << offset) - 1));\r\nreturn sprintf(buf, "%d\n", data);\r\n}\r\nstatic ssize_t adt7316_store_DAC(struct adt7316_chip_info *chip,\r\nint channel, const char *buf, size_t len)\r\n{\r\nu8 msb, lsb, offset;\r\nu16 data;\r\nint ret;\r\nif (channel >= ADT7316_DA_MSB_DATA_REGS ||\r\n(channel == 0 &&\r\n(chip->config3 & ADT7316_EN_IN_TEMP_PROP_DACA)) ||\r\n(channel == 1 &&\r\n(chip->config3 & ADT7316_EN_EX_TEMP_PROP_DACB)))\r\nreturn -EPERM;\r\noffset = chip->dac_bits - 8;\r\nret = kstrtou16(buf, 10, &data);\r\nif (ret || data >= (1 << chip->dac_bits))\r\nreturn -EINVAL;\r\nif (chip->dac_bits > 8) {\r\nlsb = data & (1 << offset);\r\nret = chip->bus.write(chip->bus.client,\r\nADT7316_DA_DATA_BASE + channel * 2, lsb);\r\nif (ret)\r\nreturn -EIO;\r\n}\r\nmsb = data >> offset;\r\nret = chip->bus.write(chip->bus.client,\r\nADT7316_DA_DATA_BASE + 1 + channel * 2, msb);\r\nif (ret)\r\nreturn -EIO;\r\nreturn len;\r\n}\r\nstatic ssize_t adt7316_show_DAC_A(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn adt7316_show_DAC(chip, 0, buf);\r\n}\r\nstatic ssize_t adt7316_store_DAC_A(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn adt7316_store_DAC(chip, 0, buf, len);\r\n}\r\nstatic ssize_t adt7316_show_DAC_B(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn adt7316_show_DAC(chip, 1, buf);\r\n}\r\nstatic ssize_t adt7316_store_DAC_B(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn adt7316_store_DAC(chip, 1, buf, len);\r\n}\r\nstatic ssize_t adt7316_show_DAC_C(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn adt7316_show_DAC(chip, 2, buf);\r\n}\r\nstatic ssize_t adt7316_store_DAC_C(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn adt7316_store_DAC(chip, 2, buf, len);\r\n}\r\nstatic ssize_t adt7316_show_DAC_D(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn adt7316_show_DAC(chip, 3, buf);\r\n}\r\nstatic ssize_t adt7316_store_DAC_D(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn adt7316_store_DAC(chip, 3, buf, len);\r\n}\r\nstatic ssize_t adt7316_show_device_id(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nu8 id;\r\nint ret;\r\nret = chip->bus.read(chip->bus.client, ADT7316_DEVICE_ID, &id);\r\nif (ret)\r\nreturn -EIO;\r\nreturn sprintf(buf, "%d\n", id);\r\n}\r\nstatic ssize_t adt7316_show_manufactorer_id(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nu8 id;\r\nint ret;\r\nret = chip->bus.read(chip->bus.client, ADT7316_MANUFACTURE_ID, &id);\r\nif (ret)\r\nreturn -EIO;\r\nreturn sprintf(buf, "%d\n", id);\r\n}\r\nstatic ssize_t adt7316_show_device_rev(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nu8 rev;\r\nint ret;\r\nret = chip->bus.read(chip->bus.client, ADT7316_DEVICE_REV, &rev);\r\nif (ret)\r\nreturn -EIO;\r\nreturn sprintf(buf, "%d\n", rev);\r\n}\r\nstatic ssize_t adt7316_show_bus_type(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nu8 stat;\r\nint ret;\r\nret = chip->bus.read(chip->bus.client, ADT7316_SPI_LOCK_STAT, &stat);\r\nif (ret)\r\nreturn -EIO;\r\nif (stat)\r\nreturn sprintf(buf, "spi\n");\r\nreturn sprintf(buf, "i2c\n");\r\n}\r\nstatic irqreturn_t adt7316_event_handler(int irq, void *private)\r\n{\r\nstruct iio_dev *indio_dev = private;\r\nstruct adt7316_chip_info *chip = iio_priv(indio_dev);\r\nu8 stat1, stat2;\r\nint ret;\r\ns64 time;\r\nret = chip->bus.read(chip->bus.client, ADT7316_INT_STAT1, &stat1);\r\nif (!ret) {\r\nif ((chip->id & ID_FAMILY_MASK) != ID_ADT75XX)\r\nstat1 &= 0x1F;\r\ntime = iio_get_time_ns();\r\nif (stat1 & BIT(0))\r\niio_push_event(indio_dev,\r\nIIO_UNMOD_EVENT_CODE(IIO_TEMP, 0,\r\nIIO_EV_TYPE_THRESH,\r\nIIO_EV_DIR_RISING),\r\ntime);\r\nif (stat1 & BIT(1))\r\niio_push_event(indio_dev,\r\nIIO_UNMOD_EVENT_CODE(IIO_TEMP, 0,\r\nIIO_EV_TYPE_THRESH,\r\nIIO_EV_DIR_FALLING),\r\ntime);\r\nif (stat1 & BIT(2))\r\niio_push_event(indio_dev,\r\nIIO_UNMOD_EVENT_CODE(IIO_TEMP, 1,\r\nIIO_EV_TYPE_THRESH,\r\nIIO_EV_DIR_RISING),\r\ntime);\r\nif (stat1 & BIT(3))\r\niio_push_event(indio_dev,\r\nIIO_UNMOD_EVENT_CODE(IIO_TEMP, 1,\r\nIIO_EV_TYPE_THRESH,\r\nIIO_EV_DIR_FALLING),\r\ntime);\r\nif (stat1 & BIT(5))\r\niio_push_event(indio_dev,\r\nIIO_UNMOD_EVENT_CODE(IIO_VOLTAGE, 1,\r\nIIO_EV_TYPE_THRESH,\r\nIIO_EV_DIR_EITHER),\r\ntime);\r\nif (stat1 & BIT(6))\r\niio_push_event(indio_dev,\r\nIIO_UNMOD_EVENT_CODE(IIO_VOLTAGE, 2,\r\nIIO_EV_TYPE_THRESH,\r\nIIO_EV_DIR_EITHER),\r\ntime);\r\nif (stat1 & BIT(7))\r\niio_push_event(indio_dev,\r\nIIO_UNMOD_EVENT_CODE(IIO_VOLTAGE, 3,\r\nIIO_EV_TYPE_THRESH,\r\nIIO_EV_DIR_EITHER),\r\ntime);\r\n}\r\nret = chip->bus.read(chip->bus.client, ADT7316_INT_STAT2, &stat2);\r\nif (!ret) {\r\nif (stat2 & ADT7316_INT_MASK2_VDD)\r\niio_push_event(indio_dev,\r\nIIO_UNMOD_EVENT_CODE(IIO_VOLTAGE,\r\n0,\r\nIIO_EV_TYPE_THRESH,\r\nIIO_EV_DIR_RISING),\r\niio_get_time_ns());\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic ssize_t adt7316_show_int_mask(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn sprintf(buf, "0x%x\n", chip->int_mask);\r\n}\r\nstatic ssize_t adt7316_set_int_mask(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nu16 data;\r\nint ret;\r\nu8 mask;\r\nret = kstrtou16(buf, 16, &data);\r\nif (ret || data >= ADT7316_VDD_INT_MASK + 1)\r\nreturn -EINVAL;\r\nif (data & ADT7316_VDD_INT_MASK)\r\nmask = 0;\r\nelse\r\nmask = ADT7316_INT_MASK2_VDD;\r\nret = chip->bus.write(chip->bus.client, ADT7316_INT_MASK2, mask);\r\nif (!ret) {\r\nchip->int_mask &= ~ADT7316_VDD_INT_MASK;\r\nchip->int_mask |= data & ADT7316_VDD_INT_MASK;\r\n}\r\nif (data & ADT7316_TEMP_AIN_INT_MASK) {\r\nif ((chip->id & ID_FAMILY_MASK) == ID_ADT73XX)\r\nmask = (~data) & ADT7316_TEMP_INT_MASK;\r\nelse\r\nmask = (~data) & ADT7316_TEMP_AIN_INT_MASK;\r\n}\r\nret = chip->bus.write(chip->bus.client, ADT7316_INT_MASK1, mask);\r\nchip->int_mask = mask;\r\nreturn len;\r\n}\r\nstatic inline ssize_t adt7316_show_ad_bound(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nu8 val;\r\nint data;\r\nint ret;\r\nif ((chip->id & ID_FAMILY_MASK) == ID_ADT73XX &&\r\nthis_attr->address > ADT7316_EX_TEMP_LOW)\r\nreturn -EPERM;\r\nret = chip->bus.read(chip->bus.client, this_attr->address, &val);\r\nif (ret)\r\nreturn -EIO;\r\ndata = (int)val;\r\nif (!((chip->id & ID_FAMILY_MASK) == ID_ADT75XX &&\r\n(chip->config1 & ADT7516_SEL_AIN1_2_EX_TEMP_MASK) == 0)) {\r\nif (data & 0x80)\r\ndata -= 256;\r\n}\r\nreturn sprintf(buf, "%d\n", data);\r\n}\r\nstatic inline ssize_t adt7316_set_ad_bound(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nint data;\r\nu8 val;\r\nint ret;\r\nif ((chip->id & ID_FAMILY_MASK) == ID_ADT73XX &&\r\nthis_attr->address > ADT7316_EX_TEMP_LOW)\r\nreturn -EPERM;\r\nret = kstrtoint(buf, 10, &data);\r\nif (ret)\r\nreturn -EINVAL;\r\nif ((chip->id & ID_FAMILY_MASK) == ID_ADT75XX &&\r\n(chip->config1 & ADT7516_SEL_AIN1_2_EX_TEMP_MASK) == 0) {\r\nif (data > 255 || data < 0)\r\nreturn -EINVAL;\r\n} else {\r\nif (data > 127 || data < -128)\r\nreturn -EINVAL;\r\nif (data < 0)\r\ndata += 256;\r\n}\r\nval = (u8)data;\r\nret = chip->bus.write(chip->bus.client, this_attr->address, val);\r\nif (ret)\r\nreturn -EIO;\r\nreturn len;\r\n}\r\nstatic ssize_t adt7316_show_int_enabled(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn sprintf(buf, "%d\n", !!(chip->config1 & ADT7316_INT_EN));\r\n}\r\nstatic ssize_t adt7316_set_int_enabled(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nu8 config1;\r\nint ret;\r\nconfig1 = chip->config1 & (~ADT7316_INT_EN);\r\nif (buf[0] == '1')\r\nconfig1 |= ADT7316_INT_EN;\r\nret = chip->bus.write(chip->bus.client, ADT7316_CONFIG1, config1);\r\nif (ret)\r\nreturn -EIO;\r\nchip->config1 = config1;\r\nreturn len;\r\n}\r\nstatic int adt7316_disable(struct device *dev)\r\n{\r\nstruct iio_dev *dev_info = dev_get_drvdata(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn _adt7316_store_enabled(chip, 0);\r\n}\r\nstatic int adt7316_enable(struct device *dev)\r\n{\r\nstruct iio_dev *dev_info = dev_get_drvdata(dev);\r\nstruct adt7316_chip_info *chip = iio_priv(dev_info);\r\nreturn _adt7316_store_enabled(chip, 1);\r\n}\r\nint adt7316_probe(struct device *dev, struct adt7316_bus *bus,\r\nconst char *name)\r\n{\r\nstruct adt7316_chip_info *chip;\r\nstruct iio_dev *indio_dev;\r\nunsigned short *adt7316_platform_data = dev->platform_data;\r\nint ret = 0;\r\nindio_dev = devm_iio_device_alloc(dev, sizeof(*chip));\r\nif (!indio_dev)\r\nreturn -ENOMEM;\r\nchip = iio_priv(indio_dev);\r\ndev_set_drvdata(dev, indio_dev);\r\nchip->bus = *bus;\r\nif (name[4] == '3')\r\nchip->id = ID_ADT7316 + (name[6] - '6');\r\nelse if (name[4] == '5')\r\nchip->id = ID_ADT7516 + (name[6] - '6');\r\nelse\r\nreturn -ENODEV;\r\nchip->ldac_pin = adt7316_platform_data[1];\r\nif (chip->ldac_pin) {\r\nchip->config3 |= ADT7316_DA_EN_VIA_DAC_LDCA;\r\nif ((chip->id & ID_FAMILY_MASK) == ID_ADT75XX)\r\nchip->config1 |= ADT7516_SEL_AIN3;\r\n}\r\nchip->int_mask = ADT7316_TEMP_INT_MASK | ADT7316_VDD_INT_MASK;\r\nif ((chip->id & ID_FAMILY_MASK) == ID_ADT75XX)\r\nchip->int_mask |= ADT7516_AIN_INT_MASK;\r\nindio_dev->dev.parent = dev;\r\nif ((chip->id & ID_FAMILY_MASK) == ID_ADT75XX)\r\nindio_dev->info = &adt7516_info;\r\nelse\r\nindio_dev->info = &adt7316_info;\r\nindio_dev->name = name;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nif (chip->bus.irq > 0) {\r\nif (adt7316_platform_data[0])\r\nchip->bus.irq_flags = adt7316_platform_data[0];\r\nret = devm_request_threaded_irq(dev, chip->bus.irq,\r\nNULL,\r\nadt7316_event_handler,\r\nchip->bus.irq_flags |\r\nIRQF_ONESHOT,\r\nindio_dev->name,\r\nindio_dev);\r\nif (ret)\r\nreturn ret;\r\nif (chip->bus.irq_flags & IRQF_TRIGGER_HIGH)\r\nchip->config1 |= ADT7316_INT_POLARITY;\r\n}\r\nret = chip->bus.write(chip->bus.client, ADT7316_CONFIG1, chip->config1);\r\nif (ret)\r\nreturn -EIO;\r\nret = chip->bus.write(chip->bus.client, ADT7316_CONFIG3, chip->config3);\r\nif (ret)\r\nreturn -EIO;\r\nret = devm_iio_device_register(dev, indio_dev);\r\nif (ret)\r\nreturn ret;\r\ndev_info(dev, "%s temperature sensor, ADC and DAC registered.\n",\r\nindio_dev->name);\r\nreturn 0;\r\n}

static int tps65217_config_charger(struct tps65217_charger *charger)\r\n{\r\nint ret;\r\ndev_dbg(charger->dev, "%s\n", __func__);\r\nret = tps65217_clear_bits(charger->tps, TPS65217_REG_CHGCONFIG1,\r\nTPS65217_CHGCONFIG1_NTC_TYPE,\r\nTPS65217_PROTECT_NONE);\r\nif (ret) {\r\ndev_err(charger->dev,\r\n"failed to set 100k NTC setting: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tps65217_enable_charging(struct tps65217_charger *charger)\r\n{\r\nint ret;\r\nif (charger->ac_online)\r\nreturn 0;\r\ndev_dbg(charger->dev, "%s: enable charging\n", __func__);\r\nret = tps65217_set_bits(charger->tps, TPS65217_REG_CHGCONFIG1,\r\nTPS65217_CHGCONFIG1_CHG_EN,\r\nTPS65217_CHGCONFIG1_CHG_EN,\r\nTPS65217_PROTECT_NONE);\r\nif (ret) {\r\ndev_err(charger->dev,\r\n"%s: Error in writing CHG_EN in reg 0x%x: %d\n",\r\n__func__, TPS65217_REG_CHGCONFIG1, ret);\r\nreturn ret;\r\n}\r\ncharger->ac_online = 1;\r\nreturn 0;\r\n}\r\nstatic int tps65217_ac_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct tps65217_charger *charger = power_supply_get_drvdata(psy);\r\nif (psp == POWER_SUPPLY_PROP_ONLINE) {\r\nval->intval = charger->ac_online;\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic irqreturn_t tps65217_charger_irq(int irq, void *dev)\r\n{\r\nint ret, val;\r\nstruct tps65217_charger *charger = dev;\r\ncharger->prev_ac_online = charger->ac_online;\r\nret = tps65217_reg_read(charger->tps, TPS65217_REG_STATUS, &val);\r\nif (ret < 0) {\r\ndev_err(charger->dev, "%s: Error in reading reg 0x%x\n",\r\n__func__, TPS65217_REG_STATUS);\r\nreturn IRQ_HANDLED;\r\n}\r\ndev_dbg(charger->dev, "%s: 0x%x\n", __func__, val);\r\nif (val & TPS65217_STATUS_ACPWR) {\r\nret = tps65217_enable_charging(charger);\r\nif (ret) {\r\ndev_err(charger->dev,\r\n"failed to enable charger: %d\n", ret);\r\nreturn IRQ_HANDLED;\r\n}\r\n} else {\r\ncharger->ac_online = 0;\r\n}\r\nif (charger->prev_ac_online != charger->ac_online)\r\npower_supply_changed(charger->ac);\r\nret = tps65217_reg_read(charger->tps, TPS65217_REG_CHGCONFIG0, &val);\r\nif (ret < 0) {\r\ndev_err(charger->dev, "%s: Error in reading reg 0x%x\n",\r\n__func__, TPS65217_REG_CHGCONFIG0);\r\nreturn IRQ_HANDLED;\r\n}\r\nif (val & TPS65217_CHGCONFIG0_ACTIVE)\r\ndev_dbg(charger->dev, "%s: charger is charging\n", __func__);\r\nelse\r\ndev_dbg(charger->dev,\r\n"%s: charger is NOT charging\n", __func__);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int tps65217_charger_poll_task(void *data)\r\n{\r\nset_freezable();\r\nwhile (!kthread_should_stop()) {\r\nschedule_timeout_interruptible(POLL_INTERVAL);\r\ntry_to_freeze();\r\ntps65217_charger_irq(-1, data);\r\n}\r\nreturn 0;\r\n}\r\nstatic int tps65217_charger_probe(struct platform_device *pdev)\r\n{\r\nstruct tps65217 *tps = dev_get_drvdata(pdev->dev.parent);\r\nstruct tps65217_charger *charger;\r\nint ret;\r\ndev_dbg(&pdev->dev, "%s\n", __func__);\r\ncharger = devm_kzalloc(&pdev->dev, sizeof(*charger), GFP_KERNEL);\r\nif (!charger)\r\nreturn -ENOMEM;\r\ncharger->tps = tps;\r\ncharger->dev = &pdev->dev;\r\ncharger->ac = devm_power_supply_register(&pdev->dev,\r\n&tps65217_charger_desc,\r\nNULL);\r\nif (IS_ERR(charger->ac)) {\r\ndev_err(&pdev->dev, "failed: power supply register\n");\r\nreturn PTR_ERR(charger->ac);\r\n}\r\nret = tps65217_config_charger(charger);\r\nif (ret < 0) {\r\ndev_err(charger->dev, "charger config failed, err %d\n", ret);\r\nreturn ret;\r\n}\r\ncharger->poll_task = kthread_run(tps65217_charger_poll_task,\r\ncharger, "ktps65217charger");\r\nif (IS_ERR(charger->poll_task)) {\r\nret = PTR_ERR(charger->poll_task);\r\ndev_err(charger->dev, "Unable to run kthread err %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tps65217_charger_remove(struct platform_device *pdev)\r\n{\r\nstruct tps65217_charger *charger = platform_get_drvdata(pdev);\r\nkthread_stop(charger->poll_task);\r\nreturn 0;\r\n}

static void shirq_irq_mask(struct irq_data *d)\r\n{\r\nstruct spear_shirq *shirq = irq_data_get_irq_chip_data(d);\r\nu32 val, shift = d->irq - shirq->virq_base + shirq->offset;\r\nu32 __iomem *reg = shirq->base + shirq->mask_reg;\r\nraw_spin_lock(&shirq_lock);\r\nval = readl(reg) & ~(0x1 << shift);\r\nwritel(val, reg);\r\nraw_spin_unlock(&shirq_lock);\r\n}\r\nstatic void shirq_irq_unmask(struct irq_data *d)\r\n{\r\nstruct spear_shirq *shirq = irq_data_get_irq_chip_data(d);\r\nu32 val, shift = d->irq - shirq->virq_base + shirq->offset;\r\nu32 __iomem *reg = shirq->base + shirq->mask_reg;\r\nraw_spin_lock(&shirq_lock);\r\nval = readl(reg) | (0x1 << shift);\r\nwritel(val, reg);\r\nraw_spin_unlock(&shirq_lock);\r\n}\r\nstatic void shirq_handler(struct irq_desc *desc)\r\n{\r\nstruct spear_shirq *shirq = irq_desc_get_handler_data(desc);\r\nu32 pend;\r\npend = readl(shirq->base + shirq->status_reg) & shirq->mask;\r\npend >>= shirq->offset;\r\nwhile (pend) {\r\nint irq = __ffs(pend);\r\npend &= ~(0x1 << irq);\r\ngeneric_handle_irq(shirq->virq_base + irq);\r\n}\r\n}\r\nstatic void __init spear_shirq_register(struct spear_shirq *shirq,\r\nint parent_irq)\r\n{\r\nint i;\r\nif (!shirq->irq_chip)\r\nreturn;\r\nirq_set_chained_handler_and_data(parent_irq, shirq_handler, shirq);\r\nfor (i = 0; i < shirq->nr_irqs; i++) {\r\nirq_set_chip_and_handler(shirq->virq_base + i,\r\nshirq->irq_chip, handle_simple_irq);\r\nirq_set_chip_data(shirq->virq_base + i, shirq);\r\n}\r\n}\r\nstatic int __init shirq_init(struct spear_shirq **shirq_blocks, int block_nr,\r\nstruct device_node *np)\r\n{\r\nint i, parent_irq, virq_base, hwirq = 0, nr_irqs = 0;\r\nstruct irq_domain *shirq_domain;\r\nvoid __iomem *base;\r\nbase = of_iomap(np, 0);\r\nif (!base) {\r\npr_err("%s: failed to map shirq registers\n", __func__);\r\nreturn -ENXIO;\r\n}\r\nfor (i = 0; i < block_nr; i++)\r\nnr_irqs += shirq_blocks[i]->nr_irqs;\r\nvirq_base = irq_alloc_descs(-1, 0, nr_irqs, 0);\r\nif (IS_ERR_VALUE(virq_base)) {\r\npr_err("%s: irq desc alloc failed\n", __func__);\r\ngoto err_unmap;\r\n}\r\nshirq_domain = irq_domain_add_legacy(np, nr_irqs, virq_base, 0,\r\n&irq_domain_simple_ops, NULL);\r\nif (WARN_ON(!shirq_domain)) {\r\npr_warn("%s: irq domain init failed\n", __func__);\r\ngoto err_free_desc;\r\n}\r\nfor (i = 0; i < block_nr; i++) {\r\nshirq_blocks[i]->base = base;\r\nshirq_blocks[i]->virq_base = irq_find_mapping(shirq_domain,\r\nhwirq);\r\nparent_irq = irq_of_parse_and_map(np, i);\r\nspear_shirq_register(shirq_blocks[i], parent_irq);\r\nhwirq += shirq_blocks[i]->nr_irqs;\r\n}\r\nreturn 0;\r\nerr_free_desc:\r\nirq_free_descs(virq_base, nr_irqs);\r\nerr_unmap:\r\niounmap(base);\r\nreturn -ENXIO;\r\n}\r\nstatic int __init spear300_shirq_of_init(struct device_node *np,\r\nstruct device_node *parent)\r\n{\r\nreturn shirq_init(spear300_shirq_blocks,\r\nARRAY_SIZE(spear300_shirq_blocks), np);\r\n}\r\nstatic int __init spear310_shirq_of_init(struct device_node *np,\r\nstruct device_node *parent)\r\n{\r\nreturn shirq_init(spear310_shirq_blocks,\r\nARRAY_SIZE(spear310_shirq_blocks), np);\r\n}\r\nstatic int __init spear320_shirq_of_init(struct device_node *np,\r\nstruct device_node *parent)\r\n{\r\nreturn shirq_init(spear320_shirq_blocks,\r\nARRAY_SIZE(spear320_shirq_blocks), np);\r\n}

int drm_create_iommu_mapping(struct drm_device *drm_dev)\r\n{\r\nstruct dma_iommu_mapping *mapping = NULL;\r\nstruct exynos_drm_private *priv = drm_dev->dev_private;\r\nstruct device *dev = drm_dev->dev;\r\nif (!priv->da_start)\r\npriv->da_start = EXYNOS_DEV_ADDR_START;\r\nif (!priv->da_space_size)\r\npriv->da_space_size = EXYNOS_DEV_ADDR_SIZE;\r\nmapping = arm_iommu_create_mapping(&platform_bus_type, priv->da_start,\r\npriv->da_space_size);\r\nif (IS_ERR(mapping))\r\nreturn PTR_ERR(mapping);\r\ndev->dma_parms = devm_kzalloc(dev, sizeof(*dev->dma_parms),\r\nGFP_KERNEL);\r\nif (!dev->dma_parms)\r\ngoto error;\r\ndma_set_max_seg_size(dev, 0xffffffffu);\r\ndev->archdata.mapping = mapping;\r\nreturn 0;\r\nerror:\r\narm_iommu_release_mapping(mapping);\r\nreturn -ENOMEM;\r\n}\r\nvoid drm_release_iommu_mapping(struct drm_device *drm_dev)\r\n{\r\nstruct device *dev = drm_dev->dev;\r\narm_iommu_release_mapping(dev->archdata.mapping);\r\n}\r\nint drm_iommu_attach_device(struct drm_device *drm_dev,\r\nstruct device *subdrv_dev)\r\n{\r\nstruct device *dev = drm_dev->dev;\r\nint ret;\r\nif (!dev->archdata.mapping)\r\nreturn 0;\r\nsubdrv_dev->dma_parms = devm_kzalloc(subdrv_dev,\r\nsizeof(*subdrv_dev->dma_parms),\r\nGFP_KERNEL);\r\nif (!subdrv_dev->dma_parms)\r\nreturn -ENOMEM;\r\ndma_set_max_seg_size(subdrv_dev, 0xffffffffu);\r\nif (subdrv_dev->archdata.mapping)\r\narm_iommu_detach_device(subdrv_dev);\r\nret = arm_iommu_attach_device(subdrv_dev, dev->archdata.mapping);\r\nif (ret < 0) {\r\nDRM_DEBUG_KMS("failed iommu attach.\n");\r\nreturn ret;\r\n}\r\nif (get_dma_ops(dev) == get_dma_ops(NULL))\r\nset_dma_ops(dev, get_dma_ops(subdrv_dev));\r\nreturn 0;\r\n}\r\nvoid drm_iommu_detach_device(struct drm_device *drm_dev,\r\nstruct device *subdrv_dev)\r\n{\r\nstruct device *dev = drm_dev->dev;\r\nstruct dma_iommu_mapping *mapping = dev->archdata.mapping;\r\nif (!mapping || !mapping->domain)\r\nreturn;\r\narm_iommu_detach_device(subdrv_dev);\r\n}

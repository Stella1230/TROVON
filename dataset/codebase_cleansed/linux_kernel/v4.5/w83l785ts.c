static ssize_t show_temp(struct device *dev, struct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct w83l785ts_data *data = w83l785ts_update_device(dev);\r\nreturn sprintf(buf, "%d\n", TEMP_FROM_REG(data->temp[attr->index]));\r\n}\r\nstatic int w83l785ts_detect(struct i2c_client *client,\r\nstruct i2c_board_info *info)\r\n{\r\nstruct i2c_adapter *adapter = client->adapter;\r\nu16 man_id;\r\nu8 chip_id;\r\nif (!i2c_check_functionality(adapter, I2C_FUNC_SMBUS_BYTE_DATA))\r\nreturn -ENODEV;\r\nif ((w83l785ts_read_value(client, W83L785TS_REG_CONFIG, 0) & 0x80)\r\n|| (w83l785ts_read_value(client, W83L785TS_REG_TYPE, 0) & 0xFC)) {\r\ndev_dbg(&adapter->dev,\r\n"W83L785TS-S detection failed at 0x%02x\n",\r\nclient->addr);\r\nreturn -ENODEV;\r\n}\r\nman_id = (w83l785ts_read_value(client, W83L785TS_REG_MAN_ID1, 0) << 8)\r\n+ w83l785ts_read_value(client, W83L785TS_REG_MAN_ID2, 0);\r\nchip_id = w83l785ts_read_value(client, W83L785TS_REG_CHIP_ID, 0);\r\nif (man_id != 0x5CA3\r\n|| chip_id != 0x70) {\r\ndev_dbg(&adapter->dev,\r\n"Unsupported chip (man_id=0x%04X, chip_id=0x%02X)\n",\r\nman_id, chip_id);\r\nreturn -ENODEV;\r\n}\r\nstrlcpy(info->type, "w83l785ts", I2C_NAME_SIZE);\r\nreturn 0;\r\n}\r\nstatic int w83l785ts_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct w83l785ts_data *data;\r\nstruct device *dev = &client->dev;\r\nint err;\r\ndata = devm_kzalloc(dev, sizeof(struct w83l785ts_data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(client, data);\r\nmutex_init(&data->update_lock);\r\nerr = device_create_file(dev, &sensor_dev_attr_temp1_input.dev_attr);\r\nif (err)\r\nreturn err;\r\nerr = device_create_file(dev, &sensor_dev_attr_temp1_max.dev_attr);\r\nif (err)\r\ngoto exit_remove;\r\ndata->hwmon_dev = hwmon_device_register(dev);\r\nif (IS_ERR(data->hwmon_dev)) {\r\nerr = PTR_ERR(data->hwmon_dev);\r\ngoto exit_remove;\r\n}\r\nreturn 0;\r\nexit_remove:\r\ndevice_remove_file(dev, &sensor_dev_attr_temp1_input.dev_attr);\r\ndevice_remove_file(dev, &sensor_dev_attr_temp1_max.dev_attr);\r\nreturn err;\r\n}\r\nstatic int w83l785ts_remove(struct i2c_client *client)\r\n{\r\nstruct w83l785ts_data *data = i2c_get_clientdata(client);\r\nhwmon_device_unregister(data->hwmon_dev);\r\ndevice_remove_file(&client->dev,\r\n&sensor_dev_attr_temp1_input.dev_attr);\r\ndevice_remove_file(&client->dev,\r\n&sensor_dev_attr_temp1_max.dev_attr);\r\nreturn 0;\r\n}\r\nstatic u8 w83l785ts_read_value(struct i2c_client *client, u8 reg, u8 defval)\r\n{\r\nint value, i;\r\nstruct device *dev;\r\nconst char *prefix;\r\nif (i2c_get_clientdata(client)) {\r\ndev = &client->dev;\r\nprefix = "";\r\n} else {\r\ndev = &client->adapter->dev;\r\nprefix = "w83l785ts: ";\r\n}\r\nfor (i = 1; i <= MAX_RETRIES; i++) {\r\nvalue = i2c_smbus_read_byte_data(client, reg);\r\nif (value >= 0) {\r\ndev_dbg(dev, "%sRead 0x%02x from register 0x%02x.\n",\r\nprefix, value, reg);\r\nreturn value;\r\n}\r\ndev_dbg(dev, "%sRead failed, will retry in %d.\n", prefix, i);\r\nmsleep(i);\r\n}\r\ndev_err(dev, "%sCouldn't read value from register 0x%02x.\n", prefix,\r\nreg);\r\nreturn defval;\r\n}\r\nstatic struct w83l785ts_data *w83l785ts_update_device(struct device *dev)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct w83l785ts_data *data = i2c_get_clientdata(client);\r\nmutex_lock(&data->update_lock);\r\nif (!data->valid || time_after(jiffies, data->last_updated + HZ * 2)) {\r\ndev_dbg(&client->dev, "Updating w83l785ts data.\n");\r\ndata->temp[0] = w83l785ts_read_value(client,\r\nW83L785TS_REG_TEMP, data->temp[0]);\r\ndata->temp[1] = w83l785ts_read_value(client,\r\nW83L785TS_REG_TEMP_OVER, data->temp[1]);\r\ndata->last_updated = jiffies;\r\ndata->valid = 1;\r\n}\r\nmutex_unlock(&data->update_lock);\r\nreturn data;\r\n}

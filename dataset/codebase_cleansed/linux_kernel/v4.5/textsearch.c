static inline struct ts_ops *lookup_ts_algo(const char *name)\r\n{\r\nstruct ts_ops *o;\r\nrcu_read_lock();\r\nlist_for_each_entry_rcu(o, &ts_ops, list) {\r\nif (!strcmp(name, o->name)) {\r\nif (!try_module_get(o->owner))\r\no = NULL;\r\nrcu_read_unlock();\r\nreturn o;\r\n}\r\n}\r\nrcu_read_unlock();\r\nreturn NULL;\r\n}\r\nint textsearch_register(struct ts_ops *ops)\r\n{\r\nint err = -EEXIST;\r\nstruct ts_ops *o;\r\nif (ops->name == NULL || ops->find == NULL || ops->init == NULL ||\r\nops->get_pattern == NULL || ops->get_pattern_len == NULL)\r\nreturn -EINVAL;\r\nspin_lock(&ts_mod_lock);\r\nlist_for_each_entry(o, &ts_ops, list) {\r\nif (!strcmp(ops->name, o->name))\r\ngoto errout;\r\n}\r\nlist_add_tail_rcu(&ops->list, &ts_ops);\r\nerr = 0;\r\nerrout:\r\nspin_unlock(&ts_mod_lock);\r\nreturn err;\r\n}\r\nint textsearch_unregister(struct ts_ops *ops)\r\n{\r\nint err = 0;\r\nstruct ts_ops *o;\r\nspin_lock(&ts_mod_lock);\r\nlist_for_each_entry(o, &ts_ops, list) {\r\nif (o == ops) {\r\nlist_del_rcu(&o->list);\r\ngoto out;\r\n}\r\n}\r\nerr = -ENOENT;\r\nout:\r\nspin_unlock(&ts_mod_lock);\r\nreturn err;\r\n}\r\nstatic unsigned int get_linear_data(unsigned int consumed, const u8 **dst,\r\nstruct ts_config *conf,\r\nstruct ts_state *state)\r\n{\r\nstruct ts_linear_state *st = (struct ts_linear_state *) state->cb;\r\nif (likely(consumed < st->len)) {\r\n*dst = st->data + consumed;\r\nreturn st->len - consumed;\r\n}\r\nreturn 0;\r\n}\r\nunsigned int textsearch_find_continuous(struct ts_config *conf,\r\nstruct ts_state *state,\r\nconst void *data, unsigned int len)\r\n{\r\nstruct ts_linear_state *st = (struct ts_linear_state *) state->cb;\r\nconf->get_next_block = get_linear_data;\r\nst->data = data;\r\nst->len = len;\r\nreturn textsearch_find(conf, state);\r\n}\r\nstruct ts_config *textsearch_prepare(const char *algo, const void *pattern,\r\nunsigned int len, gfp_t gfp_mask, int flags)\r\n{\r\nint err = -ENOENT;\r\nstruct ts_config *conf;\r\nstruct ts_ops *ops;\r\nif (len == 0)\r\nreturn ERR_PTR(-EINVAL);\r\nops = lookup_ts_algo(algo);\r\n#ifdef CONFIG_MODULES\r\nif (ops == NULL && flags & TS_AUTOLOAD) {\r\nrequest_module("ts_%s", algo);\r\nops = lookup_ts_algo(algo);\r\n}\r\n#endif\r\nif (ops == NULL)\r\ngoto errout;\r\nconf = ops->init(pattern, len, gfp_mask, flags);\r\nif (IS_ERR(conf)) {\r\nerr = PTR_ERR(conf);\r\ngoto errout;\r\n}\r\nconf->ops = ops;\r\nreturn conf;\r\nerrout:\r\nif (ops)\r\nmodule_put(ops->owner);\r\nreturn ERR_PTR(err);\r\n}\r\nvoid textsearch_destroy(struct ts_config *conf)\r\n{\r\nif (conf->ops) {\r\nif (conf->ops->destroy)\r\nconf->ops->destroy(conf);\r\nmodule_put(conf->ops->owner);\r\n}\r\nkfree(conf);\r\n}

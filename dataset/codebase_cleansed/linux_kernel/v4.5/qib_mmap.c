void qib_release_mmap_info(struct kref *ref)\r\n{\r\nstruct qib_mmap_info *ip =\r\ncontainer_of(ref, struct qib_mmap_info, ref);\r\nstruct qib_ibdev *dev = to_idev(ip->context->device);\r\nspin_lock_irq(&dev->pending_lock);\r\nlist_del(&ip->pending_mmaps);\r\nspin_unlock_irq(&dev->pending_lock);\r\nvfree(ip->obj);\r\nkfree(ip);\r\n}\r\nstatic void qib_vma_open(struct vm_area_struct *vma)\r\n{\r\nstruct qib_mmap_info *ip = vma->vm_private_data;\r\nkref_get(&ip->ref);\r\n}\r\nstatic void qib_vma_close(struct vm_area_struct *vma)\r\n{\r\nstruct qib_mmap_info *ip = vma->vm_private_data;\r\nkref_put(&ip->ref, qib_release_mmap_info);\r\n}\r\nint qib_mmap(struct ib_ucontext *context, struct vm_area_struct *vma)\r\n{\r\nstruct qib_ibdev *dev = to_idev(context->device);\r\nunsigned long offset = vma->vm_pgoff << PAGE_SHIFT;\r\nunsigned long size = vma->vm_end - vma->vm_start;\r\nstruct qib_mmap_info *ip, *pp;\r\nint ret = -EINVAL;\r\nspin_lock_irq(&dev->pending_lock);\r\nlist_for_each_entry_safe(ip, pp, &dev->pending_mmaps,\r\npending_mmaps) {\r\nif (context != ip->context || (__u64) offset != ip->offset)\r\ncontinue;\r\nif (size > ip->size)\r\nbreak;\r\nlist_del_init(&ip->pending_mmaps);\r\nspin_unlock_irq(&dev->pending_lock);\r\nret = remap_vmalloc_range(vma, ip->obj, 0);\r\nif (ret)\r\ngoto done;\r\nvma->vm_ops = &qib_vm_ops;\r\nvma->vm_private_data = ip;\r\nqib_vma_open(vma);\r\ngoto done;\r\n}\r\nspin_unlock_irq(&dev->pending_lock);\r\ndone:\r\nreturn ret;\r\n}\r\nstruct qib_mmap_info *qib_create_mmap_info(struct qib_ibdev *dev,\r\nu32 size,\r\nstruct ib_ucontext *context,\r\nvoid *obj) {\r\nstruct qib_mmap_info *ip;\r\nip = kmalloc(sizeof(*ip), GFP_KERNEL);\r\nif (!ip)\r\ngoto bail;\r\nsize = PAGE_ALIGN(size);\r\nspin_lock_irq(&dev->mmap_offset_lock);\r\nif (dev->mmap_offset == 0)\r\ndev->mmap_offset = PAGE_SIZE;\r\nip->offset = dev->mmap_offset;\r\ndev->mmap_offset += size;\r\nspin_unlock_irq(&dev->mmap_offset_lock);\r\nINIT_LIST_HEAD(&ip->pending_mmaps);\r\nip->size = size;\r\nip->context = context;\r\nip->obj = obj;\r\nkref_init(&ip->ref);\r\nbail:\r\nreturn ip;\r\n}\r\nvoid qib_update_mmap_info(struct qib_ibdev *dev, struct qib_mmap_info *ip,\r\nu32 size, void *obj)\r\n{\r\nsize = PAGE_ALIGN(size);\r\nspin_lock_irq(&dev->mmap_offset_lock);\r\nif (dev->mmap_offset == 0)\r\ndev->mmap_offset = PAGE_SIZE;\r\nip->offset = dev->mmap_offset;\r\ndev->mmap_offset += size;\r\nspin_unlock_irq(&dev->mmap_offset_lock);\r\nip->size = size;\r\nip->obj = obj;\r\n}

static int mlxsw_sp_port_pb_init(struct mlxsw_sp_port *mlxsw_sp_port)\r\n{\r\nchar pbmc_pl[MLXSW_REG_PBMC_LEN];\r\nint i;\r\nmlxsw_reg_pbmc_pack(pbmc_pl, mlxsw_sp_port->local_port,\r\n0xffff, 0xffff / 2);\r\nfor (i = 0; i < MLXSW_SP_PBS_LEN; i++) {\r\nconst struct mlxsw_sp_pb *pb;\r\npb = &mlxsw_sp_pbs[i];\r\nmlxsw_reg_pbmc_lossy_buffer_pack(pbmc_pl, pb->index, pb->size);\r\n}\r\nreturn mlxsw_reg_write(mlxsw_sp_port->mlxsw_sp->core,\r\nMLXSW_REG(pbmc), pbmc_pl);\r\n}\r\nstatic int mlxsw_sp_sb_pools_init(struct mlxsw_sp *mlxsw_sp)\r\n{\r\nchar sbpr_pl[MLXSW_REG_SBPR_LEN];\r\nint i;\r\nint err;\r\nfor (i = 0; i < MLXSW_SP_SB_POOLS_LEN; i++) {\r\nconst struct mlxsw_sp_sb_pool *pool;\r\npool = &mlxsw_sp_sb_pools[i];\r\nmlxsw_reg_sbpr_pack(sbpr_pl, pool->pool, pool->dir,\r\npool->mode, pool->size);\r\nerr = mlxsw_reg_write(mlxsw_sp->core, MLXSW_REG(sbpr), sbpr_pl);\r\nif (err)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mlxsw_sp_sb_cms_init(struct mlxsw_sp *mlxsw_sp, u8 local_port,\r\nconst struct mlxsw_sp_sb_cm *cms,\r\nsize_t cms_len)\r\n{\r\nchar sbcm_pl[MLXSW_REG_SBCM_LEN];\r\nint i;\r\nint err;\r\nfor (i = 0; i < cms_len; i++) {\r\nconst struct mlxsw_sp_sb_cm *cm;\r\ncm = &cms[i];\r\nmlxsw_reg_sbcm_pack(sbcm_pl, local_port, cm->u.pg, cm->dir,\r\ncm->min_buff, cm->max_buff, cm->pool);\r\nerr = mlxsw_reg_write(mlxsw_sp->core, MLXSW_REG(sbcm), sbcm_pl);\r\nif (err)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mlxsw_sp_port_sb_cms_init(struct mlxsw_sp_port *mlxsw_sp_port)\r\n{\r\nreturn mlxsw_sp_sb_cms_init(mlxsw_sp_port->mlxsw_sp,\r\nmlxsw_sp_port->local_port, mlxsw_sp_sb_cms,\r\nMLXSW_SP_SB_CMS_LEN);\r\n}\r\nstatic int mlxsw_sp_cpu_port_sb_cms_init(struct mlxsw_sp *mlxsw_sp)\r\n{\r\nreturn mlxsw_sp_sb_cms_init(mlxsw_sp, 0, mlxsw_sp_cpu_port_sb_cms,\r\nMLXSW_SP_CPU_PORT_SB_MCS_LEN);\r\n}\r\nstatic int mlxsw_sp_port_sb_pms_init(struct mlxsw_sp_port *mlxsw_sp_port)\r\n{\r\nchar sbpm_pl[MLXSW_REG_SBPM_LEN];\r\nint i;\r\nint err;\r\nfor (i = 0; i < MLXSW_SP_SB_PMS_LEN; i++) {\r\nconst struct mlxsw_sp_sb_pm *pm;\r\npm = &mlxsw_sp_sb_pms[i];\r\nmlxsw_reg_sbpm_pack(sbpm_pl, mlxsw_sp_port->local_port,\r\npm->pool, pm->dir,\r\npm->min_buff, pm->max_buff);\r\nerr = mlxsw_reg_write(mlxsw_sp_port->mlxsw_sp->core,\r\nMLXSW_REG(sbpm), sbpm_pl);\r\nif (err)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mlxsw_sp_sb_mms_init(struct mlxsw_sp *mlxsw_sp)\r\n{\r\nchar sbmm_pl[MLXSW_REG_SBMM_LEN];\r\nint i;\r\nint err;\r\nfor (i = 0; i < MLXSW_SP_SB_MMS_LEN; i++) {\r\nconst struct mlxsw_sp_sb_mm *mc;\r\nmc = &mlxsw_sp_sb_mms[i];\r\nmlxsw_reg_sbmm_pack(sbmm_pl, mc->prio, mc->min_buff,\r\nmc->max_buff, mc->pool);\r\nerr = mlxsw_reg_write(mlxsw_sp->core, MLXSW_REG(sbmm), sbmm_pl);\r\nif (err)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nint mlxsw_sp_buffers_init(struct mlxsw_sp *mlxsw_sp)\r\n{\r\nint err;\r\nerr = mlxsw_sp_sb_pools_init(mlxsw_sp);\r\nif (err)\r\nreturn err;\r\nerr = mlxsw_sp_cpu_port_sb_cms_init(mlxsw_sp);\r\nif (err)\r\nreturn err;\r\nerr = mlxsw_sp_sb_mms_init(mlxsw_sp);\r\nreturn err;\r\n}\r\nint mlxsw_sp_port_buffers_init(struct mlxsw_sp_port *mlxsw_sp_port)\r\n{\r\nint err;\r\nerr = mlxsw_sp_port_pb_init(mlxsw_sp_port);\r\nif (err)\r\nreturn err;\r\nerr = mlxsw_sp_port_sb_cms_init(mlxsw_sp_port);\r\nif (err)\r\nreturn err;\r\nerr = mlxsw_sp_port_sb_pms_init(mlxsw_sp_port);\r\nreturn err;\r\n}

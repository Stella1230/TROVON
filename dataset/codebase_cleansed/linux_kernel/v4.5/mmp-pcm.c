static int mmp_pcm_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct dma_chan *chan = snd_dmaengine_pcm_get_chan(substream);\r\nstruct dma_slave_config slave_config;\r\nint ret;\r\nret =\r\nsnd_dmaengine_pcm_prepare_slave_config(substream, params,\r\n&slave_config);\r\nif (ret)\r\nreturn ret;\r\nret = dmaengine_slave_config(chan, &slave_config);\r\nif (ret)\r\nreturn ret;\r\nsnd_pcm_set_runtime_buffer(substream, &substream->dma_buffer);\r\nreturn 0;\r\n}\r\nstatic bool filter(struct dma_chan *chan, void *param)\r\n{\r\nstruct mmp_dma_data *dma_data = param;\r\nbool found = false;\r\nchar *devname;\r\ndevname = kasprintf(GFP_KERNEL, "%s.%d", dma_data->dma_res->name,\r\ndma_data->ssp_id);\r\nif ((strcmp(dev_name(chan->device->dev), devname) == 0) &&\r\n(chan->chan_id == dma_data->dma_res->start)) {\r\nfound = true;\r\n}\r\nkfree(devname);\r\nreturn found;\r\n}\r\nstatic int mmp_pcm_open(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct platform_device *pdev = to_platform_device(rtd->platform->dev);\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nstruct mmp_dma_data dma_data;\r\nstruct resource *r;\r\nr = platform_get_resource(pdev, IORESOURCE_DMA, substream->stream);\r\nif (!r)\r\nreturn -EBUSY;\r\nsnd_soc_set_runtime_hwparams(substream,\r\n&mmp_pcm_hardware[substream->stream]);\r\ndma_data.dma_res = r;\r\ndma_data.ssp_id = cpu_dai->id;\r\nreturn snd_dmaengine_pcm_open_request_chan(substream, filter,\r\n&dma_data);\r\n}\r\nstatic int mmp_pcm_mmap(struct snd_pcm_substream *substream,\r\nstruct vm_area_struct *vma)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nunsigned long off = vma->vm_pgoff;\r\nvma->vm_page_prot = pgprot_noncached(vma->vm_page_prot);\r\nreturn remap_pfn_range(vma, vma->vm_start,\r\n__phys_to_pfn(runtime->dma_addr) + off,\r\nvma->vm_end - vma->vm_start, vma->vm_page_prot);\r\n}\r\nstatic void mmp_pcm_free_dma_buffers(struct snd_pcm *pcm)\r\n{\r\nstruct snd_pcm_substream *substream;\r\nstruct snd_dma_buffer *buf;\r\nint stream;\r\nstruct gen_pool *gpool;\r\ngpool = sram_get_gpool("asram");\r\nif (!gpool)\r\nreturn;\r\nfor (stream = 0; stream < 2; stream++) {\r\nsize_t size = mmp_pcm_hardware[stream].buffer_bytes_max;\r\nsubstream = pcm->streams[stream].substream;\r\nif (!substream)\r\ncontinue;\r\nbuf = &substream->dma_buffer;\r\nif (!buf->area)\r\ncontinue;\r\ngen_pool_free(gpool, (unsigned long)buf->area, size);\r\nbuf->area = NULL;\r\n}\r\nreturn;\r\n}\r\nstatic int mmp_pcm_preallocate_dma_buffer(struct snd_pcm_substream *substream,\r\nint stream)\r\n{\r\nstruct snd_dma_buffer *buf = &substream->dma_buffer;\r\nsize_t size = mmp_pcm_hardware[stream].buffer_bytes_max;\r\nstruct gen_pool *gpool;\r\nbuf->dev.type = SNDRV_DMA_TYPE_DEV;\r\nbuf->dev.dev = substream->pcm->card->dev;\r\nbuf->private_data = NULL;\r\ngpool = sram_get_gpool("asram");\r\nif (!gpool)\r\nreturn -ENOMEM;\r\nbuf->area = gen_pool_dma_alloc(gpool, size, &buf->addr);\r\nif (!buf->area)\r\nreturn -ENOMEM;\r\nbuf->bytes = size;\r\nreturn 0;\r\n}\r\nstatic int mmp_pcm_new(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct snd_pcm_substream *substream;\r\nstruct snd_pcm *pcm = rtd->pcm;\r\nint ret = 0, stream;\r\nfor (stream = 0; stream < 2; stream++) {\r\nsubstream = pcm->streams[stream].substream;\r\nret = mmp_pcm_preallocate_dma_buffer(substream, stream);\r\nif (ret)\r\ngoto err;\r\n}\r\nreturn 0;\r\nerr:\r\nmmp_pcm_free_dma_buffers(pcm);\r\nreturn ret;\r\n}\r\nstatic int mmp_pcm_probe(struct platform_device *pdev)\r\n{\r\nstruct mmp_audio_platdata *pdata = pdev->dev.platform_data;\r\nif (pdata) {\r\nmmp_pcm_hardware[SNDRV_PCM_STREAM_PLAYBACK].buffer_bytes_max =\r\npdata->buffer_max_playback;\r\nmmp_pcm_hardware[SNDRV_PCM_STREAM_PLAYBACK].period_bytes_max =\r\npdata->period_max_playback;\r\nmmp_pcm_hardware[SNDRV_PCM_STREAM_CAPTURE].buffer_bytes_max =\r\npdata->buffer_max_capture;\r\nmmp_pcm_hardware[SNDRV_PCM_STREAM_CAPTURE].period_bytes_max =\r\npdata->period_max_capture;\r\n}\r\nreturn devm_snd_soc_register_platform(&pdev->dev, &mmp_soc_platform);\r\n}

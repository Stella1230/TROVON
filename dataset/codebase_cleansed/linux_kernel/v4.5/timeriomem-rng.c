static int timeriomem_rng_data_present(struct hwrng *rng, int wait)\r\n{\r\nstruct timeriomem_rng_private_data *priv = to_rng_priv(rng);\r\nif (!wait || priv->present)\r\nreturn priv->present;\r\nwait_for_completion(&priv->completion);\r\nreturn 1;\r\n}\r\nstatic int timeriomem_rng_data_read(struct hwrng *rng, u32 *data)\r\n{\r\nstruct timeriomem_rng_private_data *priv = to_rng_priv(rng);\r\nunsigned long cur;\r\ns32 delay;\r\n*data = readl(priv->io_base);\r\ncur = jiffies;\r\ndelay = cur - priv->expires;\r\ndelay = priv->period - (delay % priv->period);\r\npriv->expires = cur + delay;\r\npriv->present = 0;\r\nreinit_completion(&priv->completion);\r\nmod_timer(&priv->timer, priv->expires);\r\nreturn 4;\r\n}\r\nstatic void timeriomem_rng_trigger(unsigned long data)\r\n{\r\nstruct timeriomem_rng_private_data *priv\r\n= (struct timeriomem_rng_private_data *)data;\r\npriv->present = 1;\r\ncomplete(&priv->completion);\r\n}\r\nstatic int timeriomem_rng_probe(struct platform_device *pdev)\r\n{\r\nstruct timeriomem_rng_data *pdata = pdev->dev.platform_data;\r\nstruct timeriomem_rng_private_data *priv;\r\nstruct resource *res;\r\nint err = 0;\r\nint period;\r\nif (!pdev->dev.of_node && !pdata) {\r\ndev_err(&pdev->dev, "timeriomem_rng_data is missing\n");\r\nreturn -EINVAL;\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENXIO;\r\nif (res->start % 4 != 0 || resource_size(res) != 4) {\r\ndev_err(&pdev->dev,\r\n"address must be four bytes wide and aligned\n");\r\nreturn -EINVAL;\r\n}\r\npriv = devm_kzalloc(&pdev->dev,\r\nsizeof(struct timeriomem_rng_private_data), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, priv);\r\nif (pdev->dev.of_node) {\r\nint i;\r\nif (!of_property_read_u32(pdev->dev.of_node,\r\n"period", &i))\r\nperiod = i;\r\nelse {\r\ndev_err(&pdev->dev, "missing period\n");\r\nreturn -EINVAL;\r\n}\r\n} else {\r\nperiod = pdata->period;\r\n}\r\npriv->period = usecs_to_jiffies(period);\r\nif (priv->period < 1) {\r\ndev_err(&pdev->dev, "period is less than one jiffy\n");\r\nreturn -EINVAL;\r\n}\r\npriv->expires = jiffies;\r\npriv->present = 1;\r\ninit_completion(&priv->completion);\r\ncomplete(&priv->completion);\r\nsetup_timer(&priv->timer, timeriomem_rng_trigger, (unsigned long)priv);\r\npriv->timeriomem_rng_ops.name = dev_name(&pdev->dev);\r\npriv->timeriomem_rng_ops.data_present = timeriomem_rng_data_present;\r\npriv->timeriomem_rng_ops.data_read = timeriomem_rng_data_read;\r\npriv->timeriomem_rng_ops.priv = (unsigned long)priv;\r\npriv->io_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(priv->io_base)) {\r\nerr = PTR_ERR(priv->io_base);\r\ngoto out_timer;\r\n}\r\nerr = hwrng_register(&priv->timeriomem_rng_ops);\r\nif (err) {\r\ndev_err(&pdev->dev, "problem registering\n");\r\ngoto out_timer;\r\n}\r\ndev_info(&pdev->dev, "32bits from 0x%p @ %dus\n",\r\npriv->io_base, period);\r\nreturn 0;\r\nout_timer:\r\ndel_timer_sync(&priv->timer);\r\nreturn err;\r\n}\r\nstatic int timeriomem_rng_remove(struct platform_device *pdev)\r\n{\r\nstruct timeriomem_rng_private_data *priv = platform_get_drvdata(pdev);\r\nhwrng_unregister(&priv->timeriomem_rng_ops);\r\ndel_timer_sync(&priv->timer);\r\nreturn 0;\r\n}

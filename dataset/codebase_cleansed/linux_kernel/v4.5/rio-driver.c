static const struct rio_device_id *rio_match_device(const struct rio_device_id\r\n*id,\r\nconst struct rio_dev *rdev)\r\n{\r\nwhile (id->vid || id->asm_vid) {\r\nif (((id->vid == RIO_ANY_ID) || (id->vid == rdev->vid)) &&\r\n((id->did == RIO_ANY_ID) || (id->did == rdev->did)) &&\r\n((id->asm_vid == RIO_ANY_ID)\r\n|| (id->asm_vid == rdev->asm_vid))\r\n&& ((id->asm_did == RIO_ANY_ID)\r\n|| (id->asm_did == rdev->asm_did)))\r\nreturn id;\r\nid++;\r\n}\r\nreturn NULL;\r\n}\r\nstruct rio_dev *rio_dev_get(struct rio_dev *rdev)\r\n{\r\nif (rdev)\r\nget_device(&rdev->dev);\r\nreturn rdev;\r\n}\r\nvoid rio_dev_put(struct rio_dev *rdev)\r\n{\r\nif (rdev)\r\nput_device(&rdev->dev);\r\n}\r\nstatic int rio_device_probe(struct device *dev)\r\n{\r\nstruct rio_driver *rdrv = to_rio_driver(dev->driver);\r\nstruct rio_dev *rdev = to_rio_dev(dev);\r\nint error = -ENODEV;\r\nconst struct rio_device_id *id;\r\nif (!rdev->driver && rdrv->probe) {\r\nif (!rdrv->id_table)\r\nreturn error;\r\nid = rio_match_device(rdrv->id_table, rdev);\r\nrio_dev_get(rdev);\r\nif (id)\r\nerror = rdrv->probe(rdev, id);\r\nif (error >= 0) {\r\nrdev->driver = rdrv;\r\nerror = 0;\r\n} else\r\nrio_dev_put(rdev);\r\n}\r\nreturn error;\r\n}\r\nstatic int rio_device_remove(struct device *dev)\r\n{\r\nstruct rio_dev *rdev = to_rio_dev(dev);\r\nstruct rio_driver *rdrv = rdev->driver;\r\nif (rdrv) {\r\nif (rdrv->remove)\r\nrdrv->remove(rdev);\r\nrdev->driver = NULL;\r\n}\r\nrio_dev_put(rdev);\r\nreturn 0;\r\n}\r\nint rio_register_driver(struct rio_driver *rdrv)\r\n{\r\nrdrv->driver.name = rdrv->name;\r\nrdrv->driver.bus = &rio_bus_type;\r\nreturn driver_register(&rdrv->driver);\r\n}\r\nvoid rio_unregister_driver(struct rio_driver *rdrv)\r\n{\r\ndriver_unregister(&rdrv->driver);\r\n}\r\nvoid rio_attach_device(struct rio_dev *rdev)\r\n{\r\nrdev->dev.bus = &rio_bus_type;\r\n}\r\nstatic int rio_match_bus(struct device *dev, struct device_driver *drv)\r\n{\r\nstruct rio_dev *rdev = to_rio_dev(dev);\r\nstruct rio_driver *rdrv = to_rio_driver(drv);\r\nconst struct rio_device_id *id = rdrv->id_table;\r\nconst struct rio_device_id *found_id;\r\nif (!id)\r\ngoto out;\r\nfound_id = rio_match_device(id, rdev);\r\nif (found_id)\r\nreturn 1;\r\nout:return 0;\r\n}\r\nstatic int rio_uevent(struct device *dev, struct kobj_uevent_env *env)\r\n{\r\nstruct rio_dev *rdev;\r\nif (!dev)\r\nreturn -ENODEV;\r\nrdev = to_rio_dev(dev);\r\nif (!rdev)\r\nreturn -ENODEV;\r\nif (add_uevent_var(env, "MODALIAS=rapidio:v%04Xd%04Xav%04Xad%04X",\r\nrdev->vid, rdev->did, rdev->asm_vid, rdev->asm_did))\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nstatic int __init rio_bus_init(void)\r\n{\r\nint ret;\r\nret = class_register(&rio_mport_class);\r\nif (!ret) {\r\nret = bus_register(&rio_bus_type);\r\nif (ret)\r\nclass_unregister(&rio_mport_class);\r\n}\r\nreturn ret;\r\n}

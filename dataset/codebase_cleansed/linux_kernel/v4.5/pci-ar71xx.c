static inline u32 ar71xx_pci_get_ble(int where, int size, int local)\r\n{\r\nu32 t;\r\nt = ar71xx_pci_ble_table[size & 3][where & 3];\r\nBUG_ON(t == 0xf);\r\nt <<= (local) ? 20 : 4;\r\nreturn t;\r\n}\r\nstatic inline u32 ar71xx_pci_bus_addr(struct pci_bus *bus, unsigned int devfn,\r\nint where)\r\n{\r\nu32 ret;\r\nif (!bus->number) {\r\nret = (1 << PCI_SLOT(devfn)) | (PCI_FUNC(devfn) << 8) |\r\n(where & ~3);\r\n} else {\r\nret = (bus->number << 16) | (PCI_SLOT(devfn) << 11) |\r\n(PCI_FUNC(devfn) << 8) | (where & ~3) | 1;\r\n}\r\nreturn ret;\r\n}\r\nstatic inline struct ar71xx_pci_controller *\r\npci_bus_to_ar71xx_controller(struct pci_bus *bus)\r\n{\r\nstruct pci_controller *hose;\r\nhose = (struct pci_controller *) bus->sysdata;\r\nreturn container_of(hose, struct ar71xx_pci_controller, pci_ctrl);\r\n}\r\nstatic int ar71xx_pci_check_error(struct ar71xx_pci_controller *apc, int quiet)\r\n{\r\nvoid __iomem *base = apc->cfg_base;\r\nu32 pci_err;\r\nu32 ahb_err;\r\npci_err = __raw_readl(base + AR71XX_PCI_REG_PCI_ERR) & 3;\r\nif (pci_err) {\r\nif (!quiet) {\r\nu32 addr;\r\naddr = __raw_readl(base + AR71XX_PCI_REG_PCI_ERR_ADDR);\r\npr_crit("ar71xx: %s bus error %d at addr 0x%x\n",\r\n"PCI", pci_err, addr);\r\n}\r\n__raw_writel(pci_err, base + AR71XX_PCI_REG_PCI_ERR);\r\n}\r\nahb_err = __raw_readl(base + AR71XX_PCI_REG_AHB_ERR) & 1;\r\nif (ahb_err) {\r\nif (!quiet) {\r\nu32 addr;\r\naddr = __raw_readl(base + AR71XX_PCI_REG_AHB_ERR_ADDR);\r\npr_crit("ar71xx: %s bus error %d at addr 0x%x\n",\r\n"AHB", ahb_err, addr);\r\n}\r\n__raw_writel(ahb_err, base + AR71XX_PCI_REG_AHB_ERR);\r\n}\r\nreturn !!(ahb_err | pci_err);\r\n}\r\nstatic inline void ar71xx_pci_local_write(struct ar71xx_pci_controller *apc,\r\nint where, int size, u32 value)\r\n{\r\nvoid __iomem *base = apc->cfg_base;\r\nu32 ad_cbe;\r\nvalue = value << (8 * (where & 3));\r\nad_cbe = AR71XX_PCI_CRP_CMD_WRITE | (where & ~3);\r\nad_cbe |= ar71xx_pci_get_ble(where, size, 1);\r\n__raw_writel(ad_cbe, base + AR71XX_PCI_REG_CRP_AD_CBE);\r\n__raw_writel(value, base + AR71XX_PCI_REG_CRP_WRDATA);\r\n}\r\nstatic inline int ar71xx_pci_set_cfgaddr(struct pci_bus *bus,\r\nunsigned int devfn,\r\nint where, int size, u32 cmd)\r\n{\r\nstruct ar71xx_pci_controller *apc = pci_bus_to_ar71xx_controller(bus);\r\nvoid __iomem *base = apc->cfg_base;\r\nu32 addr;\r\naddr = ar71xx_pci_bus_addr(bus, devfn, where);\r\n__raw_writel(addr, base + AR71XX_PCI_REG_CFG_AD);\r\n__raw_writel(cmd | ar71xx_pci_get_ble(where, size, 0),\r\nbase + AR71XX_PCI_REG_CFG_CBE);\r\nreturn ar71xx_pci_check_error(apc, 1);\r\n}\r\nstatic int ar71xx_pci_read_config(struct pci_bus *bus, unsigned int devfn,\r\nint where, int size, u32 *value)\r\n{\r\nstruct ar71xx_pci_controller *apc = pci_bus_to_ar71xx_controller(bus);\r\nvoid __iomem *base = apc->cfg_base;\r\nu32 data;\r\nint err;\r\nint ret;\r\nret = PCIBIOS_SUCCESSFUL;\r\ndata = ~0;\r\nerr = ar71xx_pci_set_cfgaddr(bus, devfn, where, size,\r\nAR71XX_PCI_CFG_CMD_READ);\r\nif (err)\r\nret = PCIBIOS_DEVICE_NOT_FOUND;\r\nelse\r\ndata = __raw_readl(base + AR71XX_PCI_REG_CFG_RDDATA);\r\n*value = (data >> (8 * (where & 3))) & ar71xx_pci_read_mask[size & 7];\r\nreturn ret;\r\n}\r\nstatic int ar71xx_pci_write_config(struct pci_bus *bus, unsigned int devfn,\r\nint where, int size, u32 value)\r\n{\r\nstruct ar71xx_pci_controller *apc = pci_bus_to_ar71xx_controller(bus);\r\nvoid __iomem *base = apc->cfg_base;\r\nint err;\r\nint ret;\r\nvalue = value << (8 * (where & 3));\r\nret = PCIBIOS_SUCCESSFUL;\r\nerr = ar71xx_pci_set_cfgaddr(bus, devfn, where, size,\r\nAR71XX_PCI_CFG_CMD_WRITE);\r\nif (err)\r\nret = PCIBIOS_DEVICE_NOT_FOUND;\r\nelse\r\n__raw_writel(value, base + AR71XX_PCI_REG_CFG_WRDATA);\r\nreturn ret;\r\n}\r\nstatic void ar71xx_pci_irq_handler(struct irq_desc *desc)\r\n{\r\nstruct ar71xx_pci_controller *apc;\r\nvoid __iomem *base = ath79_reset_base;\r\nu32 pending;\r\napc = irq_desc_get_handler_data(desc);\r\npending = __raw_readl(base + AR71XX_RESET_REG_PCI_INT_STATUS) &\r\n__raw_readl(base + AR71XX_RESET_REG_PCI_INT_ENABLE);\r\nif (pending & AR71XX_PCI_INT_DEV0)\r\ngeneric_handle_irq(apc->irq_base + 0);\r\nelse if (pending & AR71XX_PCI_INT_DEV1)\r\ngeneric_handle_irq(apc->irq_base + 1);\r\nelse if (pending & AR71XX_PCI_INT_DEV2)\r\ngeneric_handle_irq(apc->irq_base + 2);\r\nelse if (pending & AR71XX_PCI_INT_CORE)\r\ngeneric_handle_irq(apc->irq_base + 4);\r\nelse\r\nspurious_interrupt();\r\n}\r\nstatic void ar71xx_pci_irq_unmask(struct irq_data *d)\r\n{\r\nstruct ar71xx_pci_controller *apc;\r\nunsigned int irq;\r\nvoid __iomem *base = ath79_reset_base;\r\nu32 t;\r\napc = irq_data_get_irq_chip_data(d);\r\nirq = d->irq - apc->irq_base;\r\nt = __raw_readl(base + AR71XX_RESET_REG_PCI_INT_ENABLE);\r\n__raw_writel(t | (1 << irq), base + AR71XX_RESET_REG_PCI_INT_ENABLE);\r\n__raw_readl(base + AR71XX_RESET_REG_PCI_INT_ENABLE);\r\n}\r\nstatic void ar71xx_pci_irq_mask(struct irq_data *d)\r\n{\r\nstruct ar71xx_pci_controller *apc;\r\nunsigned int irq;\r\nvoid __iomem *base = ath79_reset_base;\r\nu32 t;\r\napc = irq_data_get_irq_chip_data(d);\r\nirq = d->irq - apc->irq_base;\r\nt = __raw_readl(base + AR71XX_RESET_REG_PCI_INT_ENABLE);\r\n__raw_writel(t & ~(1 << irq), base + AR71XX_RESET_REG_PCI_INT_ENABLE);\r\n__raw_readl(base + AR71XX_RESET_REG_PCI_INT_ENABLE);\r\n}\r\nstatic void ar71xx_pci_irq_init(struct ar71xx_pci_controller *apc)\r\n{\r\nvoid __iomem *base = ath79_reset_base;\r\nint i;\r\n__raw_writel(0, base + AR71XX_RESET_REG_PCI_INT_ENABLE);\r\n__raw_writel(0, base + AR71XX_RESET_REG_PCI_INT_STATUS);\r\nBUILD_BUG_ON(ATH79_PCI_IRQ_COUNT < AR71XX_PCI_IRQ_COUNT);\r\napc->irq_base = ATH79_PCI_IRQ_BASE;\r\nfor (i = apc->irq_base;\r\ni < apc->irq_base + AR71XX_PCI_IRQ_COUNT; i++) {\r\nirq_set_chip_and_handler(i, &ar71xx_pci_irq_chip,\r\nhandle_level_irq);\r\nirq_set_chip_data(i, apc);\r\n}\r\nirq_set_chained_handler_and_data(apc->irq, ar71xx_pci_irq_handler,\r\napc);\r\n}\r\nstatic void ar71xx_pci_reset(void)\r\n{\r\nath79_device_reset_set(AR71XX_RESET_PCI_BUS | AR71XX_RESET_PCI_CORE);\r\nmdelay(100);\r\nath79_device_reset_clear(AR71XX_RESET_PCI_BUS | AR71XX_RESET_PCI_CORE);\r\nmdelay(100);\r\nath79_ddr_set_pci_windows();\r\nmdelay(100);\r\n}\r\nstatic int ar71xx_pci_probe(struct platform_device *pdev)\r\n{\r\nstruct ar71xx_pci_controller *apc;\r\nstruct resource *res;\r\nu32 t;\r\napc = devm_kzalloc(&pdev->dev, sizeof(struct ar71xx_pci_controller),\r\nGFP_KERNEL);\r\nif (!apc)\r\nreturn -ENOMEM;\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM, "cfg_base");\r\napc->cfg_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(apc->cfg_base))\r\nreturn PTR_ERR(apc->cfg_base);\r\napc->irq = platform_get_irq(pdev, 0);\r\nif (apc->irq < 0)\r\nreturn -EINVAL;\r\nres = platform_get_resource_byname(pdev, IORESOURCE_IO, "io_base");\r\nif (!res)\r\nreturn -EINVAL;\r\napc->io_res.parent = res;\r\napc->io_res.name = "PCI IO space";\r\napc->io_res.start = res->start;\r\napc->io_res.end = res->end;\r\napc->io_res.flags = IORESOURCE_IO;\r\nres = platform_get_resource_byname(pdev, IORESOURCE_MEM, "mem_base");\r\nif (!res)\r\nreturn -EINVAL;\r\napc->mem_res.parent = res;\r\napc->mem_res.name = "PCI memory space";\r\napc->mem_res.start = res->start;\r\napc->mem_res.end = res->end;\r\napc->mem_res.flags = IORESOURCE_MEM;\r\nar71xx_pci_reset();\r\nt = PCI_COMMAND_MEMORY | PCI_COMMAND_MASTER | PCI_COMMAND_INVALIDATE\r\n| PCI_COMMAND_PARITY | PCI_COMMAND_SERR | PCI_COMMAND_FAST_BACK;\r\nar71xx_pci_local_write(apc, PCI_COMMAND, 4, t);\r\nar71xx_pci_check_error(apc, 1);\r\nar71xx_pci_irq_init(apc);\r\napc->pci_ctrl.pci_ops = &ar71xx_pci_ops;\r\napc->pci_ctrl.mem_resource = &apc->mem_res;\r\napc->pci_ctrl.io_resource = &apc->io_res;\r\nregister_pci_controller(&apc->pci_ctrl);\r\nreturn 0;\r\n}\r\nstatic int __init ar71xx_pci_init(void)\r\n{\r\nreturn platform_driver_register(&ar71xx_pci_driver);\r\n}

static int wm5102_sysclk_ev(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nstruct arizona *arizona = dev_get_drvdata(codec->dev->parent);\r\nstruct regmap *regmap = arizona->regmap;\r\nconst struct reg_default *patch = NULL;\r\nint i, patch_size;\r\nswitch (arizona->rev) {\r\ncase 0:\r\npatch = wm5102_sysclk_reva_patch;\r\npatch_size = ARRAY_SIZE(wm5102_sysclk_reva_patch);\r\nbreak;\r\ndefault:\r\npatch = wm5102_sysclk_revb_patch;\r\npatch_size = ARRAY_SIZE(wm5102_sysclk_revb_patch);\r\nbreak;\r\n}\r\nswitch (event) {\r\ncase SND_SOC_DAPM_POST_PMU:\r\nif (patch)\r\nfor (i = 0; i < patch_size; i++)\r\nregmap_write_async(regmap, patch[i].reg,\r\npatch[i].def);\r\nbreak;\r\ncase SND_SOC_DAPM_PRE_PMD:\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nreturn arizona_dvfs_sysclk_ev(w, kcontrol, event);\r\n}\r\nstatic int wm5102_adsp_power_ev(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_dapm_to_codec(w->dapm);\r\nstruct arizona *arizona = dev_get_drvdata(codec->dev->parent);\r\nunsigned int v;\r\nint ret;\r\nswitch (event) {\r\ncase SND_SOC_DAPM_PRE_PMU:\r\nret = regmap_read(arizona->regmap, ARIZONA_SYSTEM_CLOCK_1, &v);\r\nif (ret != 0) {\r\ndev_err(codec->dev,\r\n"Failed to read SYSCLK state: %d\n", ret);\r\nreturn -EIO;\r\n}\r\nv = (v & ARIZONA_SYSCLK_FREQ_MASK) >> ARIZONA_SYSCLK_FREQ_SHIFT;\r\nif (v >= 3) {\r\nret = arizona_dvfs_up(codec, ARIZONA_DVFS_ADSP1_RQ);\r\nif (ret) {\r\ndev_err(codec->dev,\r\n"Failed to raise DVFS: %d\n", ret);\r\nreturn ret;\r\n}\r\n}\r\nbreak;\r\ncase SND_SOC_DAPM_POST_PMD:\r\nret = arizona_dvfs_down(codec, ARIZONA_DVFS_ADSP1_RQ);\r\nif (ret)\r\ndev_warn(codec->dev,\r\n"Failed to lower DVFS: %d\n", ret);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn wm_adsp2_early_event(w, kcontrol, event);\r\n}\r\nstatic int wm5102_out_comp_coeff_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_kcontrol_codec(kcontrol);\r\nstruct arizona *arizona = dev_get_drvdata(codec->dev->parent);\r\nmutex_lock(&arizona->dac_comp_lock);\r\nput_unaligned_be16(arizona->dac_comp_coeff,\r\nucontrol->value.bytes.data);\r\nmutex_unlock(&arizona->dac_comp_lock);\r\nreturn 0;\r\n}\r\nstatic int wm5102_out_comp_coeff_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_kcontrol_codec(kcontrol);\r\nstruct arizona *arizona = dev_get_drvdata(codec->dev->parent);\r\nmutex_lock(&arizona->dac_comp_lock);\r\nmemcpy(&arizona->dac_comp_coeff, ucontrol->value.bytes.data,\r\nsizeof(arizona->dac_comp_coeff));\r\narizona->dac_comp_coeff = be16_to_cpu(arizona->dac_comp_coeff);\r\nmutex_unlock(&arizona->dac_comp_lock);\r\nreturn 0;\r\n}\r\nstatic int wm5102_out_comp_switch_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_kcontrol_codec(kcontrol);\r\nstruct arizona *arizona = dev_get_drvdata(codec->dev->parent);\r\nmutex_lock(&arizona->dac_comp_lock);\r\nucontrol->value.integer.value[0] = arizona->dac_comp_enabled;\r\nmutex_unlock(&arizona->dac_comp_lock);\r\nreturn 0;\r\n}\r\nstatic int wm5102_out_comp_switch_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_kcontrol_codec(kcontrol);\r\nstruct arizona *arizona = dev_get_drvdata(codec->dev->parent);\r\nmutex_lock(&arizona->dac_comp_lock);\r\narizona->dac_comp_enabled = ucontrol->value.integer.value[0];\r\nmutex_unlock(&arizona->dac_comp_lock);\r\nreturn 0;\r\n}\r\nstatic int wm5102_set_fll(struct snd_soc_codec *codec, int fll_id, int source,\r\nunsigned int Fref, unsigned int Fout)\r\n{\r\nstruct wm5102_priv *wm5102 = snd_soc_codec_get_drvdata(codec);\r\nswitch (fll_id) {\r\ncase WM5102_FLL1:\r\nreturn arizona_set_fll(&wm5102->fll[0], source, Fref, Fout);\r\ncase WM5102_FLL2:\r\nreturn arizona_set_fll(&wm5102->fll[1], source, Fref, Fout);\r\ncase WM5102_FLL1_REFCLK:\r\nreturn arizona_set_fll_refclk(&wm5102->fll[0], source, Fref,\r\nFout);\r\ncase WM5102_FLL2_REFCLK:\r\nreturn arizona_set_fll_refclk(&wm5102->fll[1], source, Fref,\r\nFout);\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic int wm5102_codec_probe(struct snd_soc_codec *codec)\r\n{\r\nstruct snd_soc_dapm_context *dapm = snd_soc_codec_get_dapm(codec);\r\nstruct wm5102_priv *priv = snd_soc_codec_get_drvdata(codec);\r\nint ret;\r\nret = wm_adsp2_codec_probe(&priv->core.adsp[0], codec);\r\nif (ret)\r\nreturn ret;\r\nret = snd_soc_add_codec_controls(codec,\r\narizona_adsp2_rate_controls, 1);\r\nif (ret)\r\ngoto err_adsp2_codec_probe;\r\narizona_init_spk(codec);\r\narizona_init_gpio(codec);\r\nsnd_soc_dapm_disable_pin(dapm, "HAPTICS");\r\npriv->core.arizona->dapm = dapm;\r\nreturn 0;\r\nerr_adsp2_codec_probe:\r\nwm_adsp2_codec_remove(&priv->core.adsp[0], codec);\r\nreturn ret;\r\n}\r\nstatic int wm5102_codec_remove(struct snd_soc_codec *codec)\r\n{\r\nstruct wm5102_priv *priv = snd_soc_codec_get_drvdata(codec);\r\nwm_adsp2_codec_remove(&priv->core.adsp[0], codec);\r\npriv->core.arizona->dapm = NULL;\r\nreturn 0;\r\n}\r\nstatic struct regmap *wm5102_get_regmap(struct device *dev)\r\n{\r\nstruct wm5102_priv *priv = dev_get_drvdata(dev);\r\nreturn priv->core.arizona->regmap;\r\n}\r\nstatic int wm5102_probe(struct platform_device *pdev)\r\n{\r\nstruct arizona *arizona = dev_get_drvdata(pdev->dev.parent);\r\nstruct wm5102_priv *wm5102;\r\nint i, ret;\r\nwm5102 = devm_kzalloc(&pdev->dev, sizeof(struct wm5102_priv),\r\nGFP_KERNEL);\r\nif (wm5102 == NULL)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, wm5102);\r\nmutex_init(&arizona->dac_comp_lock);\r\nwm5102->core.arizona = arizona;\r\nwm5102->core.num_inputs = 6;\r\narizona_init_dvfs(&wm5102->core);\r\nwm5102->core.adsp[0].part = "wm5102";\r\nwm5102->core.adsp[0].num = 1;\r\nwm5102->core.adsp[0].type = WMFW_ADSP2;\r\nwm5102->core.adsp[0].base = ARIZONA_DSP1_CONTROL_1;\r\nwm5102->core.adsp[0].dev = arizona->dev;\r\nwm5102->core.adsp[0].regmap = arizona->regmap;\r\nwm5102->core.adsp[0].mem = wm5102_dsp1_regions;\r\nwm5102->core.adsp[0].num_mems = ARRAY_SIZE(wm5102_dsp1_regions);\r\nret = wm_adsp2_init(&wm5102->core.adsp[0]);\r\nif (ret != 0)\r\nreturn ret;\r\nfor (i = 0; i < ARRAY_SIZE(wm5102->fll); i++)\r\nwm5102->fll[i].vco_mult = 1;\r\narizona_init_fll(arizona, 1, ARIZONA_FLL1_CONTROL_1 - 1,\r\nARIZONA_IRQ_FLL1_LOCK, ARIZONA_IRQ_FLL1_CLOCK_OK,\r\n&wm5102->fll[0]);\r\narizona_init_fll(arizona, 2, ARIZONA_FLL2_CONTROL_1 - 1,\r\nARIZONA_IRQ_FLL2_LOCK, ARIZONA_IRQ_FLL2_CLOCK_OK,\r\n&wm5102->fll[1]);\r\nregmap_update_bits(arizona->regmap, ARIZONA_SAMPLE_RATE_2,\r\nARIZONA_SAMPLE_RATE_2_MASK, 0x11);\r\nregmap_update_bits(arizona->regmap, ARIZONA_SAMPLE_RATE_3,\r\nARIZONA_SAMPLE_RATE_3_MASK, 0x12);\r\nfor (i = 0; i < ARRAY_SIZE(wm5102_dai); i++)\r\narizona_init_dai(&wm5102->core, i);\r\nfor (i = 0; i < ARRAY_SIZE(wm5102_digital_vu); i++)\r\nregmap_update_bits(arizona->regmap, wm5102_digital_vu[i],\r\nWM5102_DIG_VU, WM5102_DIG_VU);\r\npm_runtime_enable(&pdev->dev);\r\npm_runtime_idle(&pdev->dev);\r\nreturn snd_soc_register_codec(&pdev->dev, &soc_codec_dev_wm5102,\r\nwm5102_dai, ARRAY_SIZE(wm5102_dai));\r\n}\r\nstatic int wm5102_remove(struct platform_device *pdev)\r\n{\r\nsnd_soc_unregister_codec(&pdev->dev);\r\npm_runtime_disable(&pdev->dev);\r\nreturn 0;\r\n}

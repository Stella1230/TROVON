static int ns87410_pre_reset(struct ata_link *link, unsigned long deadline)\r\n{\r\nstruct ata_port *ap = link->ap;\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nstatic const struct pci_bits ns87410_enable_bits[] = {\r\n{ 0x43, 1, 0x08, 0x08 },\r\n{ 0x47, 1, 0x08, 0x08 }\r\n};\r\nif (!pci_test_config_bits(pdev, &ns87410_enable_bits[ap->port_no]))\r\nreturn -ENOENT;\r\nreturn ata_sff_prereset(link, deadline);\r\n}\r\nstatic void ns87410_set_piomode(struct ata_port *ap, struct ata_device *adev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nint port = 0x40 + 4 * ap->port_no;\r\nu8 idetcr, idefr;\r\nstruct ata_timing at;\r\nstatic const u8 activebits[15] = {\r\n0, 1, 2, 3, 4,\r\n5, 5, 6, 6, 6,\r\n6, 7, 7, 7, 7\r\n};\r\nstatic const u8 recoverbits[12] = {\r\n0, 1, 2, 3, 4, 5, 6, 6, 7, 7, 7, 7\r\n};\r\npci_read_config_byte(pdev, port + 3, &idefr);\r\nif (ata_pio_need_iordy(adev))\r\nidefr |= 0x04;\r\nelse\r\nidefr &= ~0x04;\r\nif (ata_timing_compute(adev, adev->pio_mode, &at, 30303, 1) < 0) {\r\ndev_err(&pdev->dev, "unknown mode %d\n", adev->pio_mode);\r\nreturn;\r\n}\r\nat.active = clamp_val(at.active, 2, 16) - 2;\r\nat.setup = clamp_val(at.setup, 1, 4) - 1;\r\nat.recover = clamp_val(at.recover, 1, 12) - 1;\r\nidetcr = (at.setup << 6) | (recoverbits[at.recover] << 3) | activebits[at.active];\r\npci_write_config_byte(pdev, port, idetcr);\r\npci_write_config_byte(pdev, port + 3, idefr);\r\nap->private_data = adev;\r\n}\r\nstatic unsigned int ns87410_qc_issue(struct ata_queued_cmd *qc)\r\n{\r\nstruct ata_port *ap = qc->ap;\r\nstruct ata_device *adev = qc->dev;\r\nif (adev->pio_mode && adev != ap->private_data)\r\nns87410_set_piomode(ap, adev);\r\nreturn ata_sff_qc_issue(qc);\r\n}\r\nstatic int ns87410_init_one(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nstatic const struct ata_port_info info = {\r\n.flags = ATA_FLAG_SLAVE_POSS,\r\n.pio_mask = ATA_PIO3,\r\n.port_ops = &ns87410_port_ops\r\n};\r\nconst struct ata_port_info *ppi[] = { &info, NULL };\r\nreturn ata_pci_sff_init_one(dev, ppi, &ns87410_sht, NULL, 0);\r\n}

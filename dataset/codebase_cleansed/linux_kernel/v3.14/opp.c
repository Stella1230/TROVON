static struct device_opp *find_device_opp(struct device *dev)\r\n{\r\nstruct device_opp *tmp_dev_opp, *dev_opp = ERR_PTR(-ENODEV);\r\nif (unlikely(IS_ERR_OR_NULL(dev))) {\r\npr_err("%s: Invalid parameters\n", __func__);\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nlist_for_each_entry_rcu(tmp_dev_opp, &dev_opp_list, node) {\r\nif (tmp_dev_opp->dev == dev) {\r\ndev_opp = tmp_dev_opp;\r\nbreak;\r\n}\r\n}\r\nreturn dev_opp;\r\n}\r\nunsigned long dev_pm_opp_get_voltage(struct dev_pm_opp *opp)\r\n{\r\nstruct dev_pm_opp *tmp_opp;\r\nunsigned long v = 0;\r\ntmp_opp = rcu_dereference(opp);\r\nif (unlikely(IS_ERR_OR_NULL(tmp_opp)) || !tmp_opp->available)\r\npr_err("%s: Invalid parameters\n", __func__);\r\nelse\r\nv = tmp_opp->u_volt;\r\nreturn v;\r\n}\r\nunsigned long dev_pm_opp_get_freq(struct dev_pm_opp *opp)\r\n{\r\nstruct dev_pm_opp *tmp_opp;\r\nunsigned long f = 0;\r\ntmp_opp = rcu_dereference(opp);\r\nif (unlikely(IS_ERR_OR_NULL(tmp_opp)) || !tmp_opp->available)\r\npr_err("%s: Invalid parameters\n", __func__);\r\nelse\r\nf = tmp_opp->rate;\r\nreturn f;\r\n}\r\nint dev_pm_opp_get_opp_count(struct device *dev)\r\n{\r\nstruct device_opp *dev_opp;\r\nstruct dev_pm_opp *temp_opp;\r\nint count = 0;\r\ndev_opp = find_device_opp(dev);\r\nif (IS_ERR(dev_opp)) {\r\nint r = PTR_ERR(dev_opp);\r\ndev_err(dev, "%s: device OPP not found (%d)\n", __func__, r);\r\nreturn r;\r\n}\r\nlist_for_each_entry_rcu(temp_opp, &dev_opp->opp_list, node) {\r\nif (temp_opp->available)\r\ncount++;\r\n}\r\nreturn count;\r\n}\r\nstruct dev_pm_opp *dev_pm_opp_find_freq_exact(struct device *dev,\r\nunsigned long freq,\r\nbool available)\r\n{\r\nstruct device_opp *dev_opp;\r\nstruct dev_pm_opp *temp_opp, *opp = ERR_PTR(-ERANGE);\r\ndev_opp = find_device_opp(dev);\r\nif (IS_ERR(dev_opp)) {\r\nint r = PTR_ERR(dev_opp);\r\ndev_err(dev, "%s: device OPP not found (%d)\n", __func__, r);\r\nreturn ERR_PTR(r);\r\n}\r\nlist_for_each_entry_rcu(temp_opp, &dev_opp->opp_list, node) {\r\nif (temp_opp->available == available &&\r\ntemp_opp->rate == freq) {\r\nopp = temp_opp;\r\nbreak;\r\n}\r\n}\r\nreturn opp;\r\n}\r\nstruct dev_pm_opp *dev_pm_opp_find_freq_ceil(struct device *dev,\r\nunsigned long *freq)\r\n{\r\nstruct device_opp *dev_opp;\r\nstruct dev_pm_opp *temp_opp, *opp = ERR_PTR(-ERANGE);\r\nif (!dev || !freq) {\r\ndev_err(dev, "%s: Invalid argument freq=%p\n", __func__, freq);\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\ndev_opp = find_device_opp(dev);\r\nif (IS_ERR(dev_opp))\r\nreturn ERR_CAST(dev_opp);\r\nlist_for_each_entry_rcu(temp_opp, &dev_opp->opp_list, node) {\r\nif (temp_opp->available && temp_opp->rate >= *freq) {\r\nopp = temp_opp;\r\n*freq = opp->rate;\r\nbreak;\r\n}\r\n}\r\nreturn opp;\r\n}\r\nstruct dev_pm_opp *dev_pm_opp_find_freq_floor(struct device *dev,\r\nunsigned long *freq)\r\n{\r\nstruct device_opp *dev_opp;\r\nstruct dev_pm_opp *temp_opp, *opp = ERR_PTR(-ERANGE);\r\nif (!dev || !freq) {\r\ndev_err(dev, "%s: Invalid argument freq=%p\n", __func__, freq);\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\ndev_opp = find_device_opp(dev);\r\nif (IS_ERR(dev_opp))\r\nreturn ERR_CAST(dev_opp);\r\nlist_for_each_entry_rcu(temp_opp, &dev_opp->opp_list, node) {\r\nif (temp_opp->available) {\r\nif (temp_opp->rate > *freq)\r\nbreak;\r\nelse\r\nopp = temp_opp;\r\n}\r\n}\r\nif (!IS_ERR(opp))\r\n*freq = opp->rate;\r\nreturn opp;\r\n}\r\nint dev_pm_opp_add(struct device *dev, unsigned long freq, unsigned long u_volt)\r\n{\r\nstruct device_opp *dev_opp = NULL;\r\nstruct dev_pm_opp *opp, *new_opp;\r\nstruct list_head *head;\r\nnew_opp = kzalloc(sizeof(*new_opp), GFP_KERNEL);\r\nif (!new_opp) {\r\ndev_warn(dev, "%s: Unable to create new OPP node\n", __func__);\r\nreturn -ENOMEM;\r\n}\r\nmutex_lock(&dev_opp_list_lock);\r\ndev_opp = find_device_opp(dev);\r\nif (IS_ERR(dev_opp)) {\r\ndev_opp = kzalloc(sizeof(struct device_opp), GFP_KERNEL);\r\nif (!dev_opp) {\r\nmutex_unlock(&dev_opp_list_lock);\r\nkfree(new_opp);\r\ndev_warn(dev,\r\n"%s: Unable to create device OPP structure\n",\r\n__func__);\r\nreturn -ENOMEM;\r\n}\r\ndev_opp->dev = dev;\r\nsrcu_init_notifier_head(&dev_opp->head);\r\nINIT_LIST_HEAD(&dev_opp->opp_list);\r\nlist_add_rcu(&dev_opp->node, &dev_opp_list);\r\n}\r\nnew_opp->dev_opp = dev_opp;\r\nnew_opp->rate = freq;\r\nnew_opp->u_volt = u_volt;\r\nnew_opp->available = true;\r\nhead = &dev_opp->opp_list;\r\nlist_for_each_entry_rcu(opp, &dev_opp->opp_list, node) {\r\nif (new_opp->rate < opp->rate)\r\nbreak;\r\nelse\r\nhead = &opp->node;\r\n}\r\nlist_add_rcu(&new_opp->node, head);\r\nmutex_unlock(&dev_opp_list_lock);\r\nsrcu_notifier_call_chain(&dev_opp->head, OPP_EVENT_ADD, new_opp);\r\nreturn 0;\r\n}\r\nstatic int opp_set_availability(struct device *dev, unsigned long freq,\r\nbool availability_req)\r\n{\r\nstruct device_opp *tmp_dev_opp, *dev_opp = ERR_PTR(-ENODEV);\r\nstruct dev_pm_opp *new_opp, *tmp_opp, *opp = ERR_PTR(-ENODEV);\r\nint r = 0;\r\nnew_opp = kmalloc(sizeof(*new_opp), GFP_KERNEL);\r\nif (!new_opp) {\r\ndev_warn(dev, "%s: Unable to create OPP\n", __func__);\r\nreturn -ENOMEM;\r\n}\r\nmutex_lock(&dev_opp_list_lock);\r\nlist_for_each_entry(tmp_dev_opp, &dev_opp_list, node) {\r\nif (dev == tmp_dev_opp->dev) {\r\ndev_opp = tmp_dev_opp;\r\nbreak;\r\n}\r\n}\r\nif (IS_ERR(dev_opp)) {\r\nr = PTR_ERR(dev_opp);\r\ndev_warn(dev, "%s: Device OPP not found (%d)\n", __func__, r);\r\ngoto unlock;\r\n}\r\nlist_for_each_entry(tmp_opp, &dev_opp->opp_list, node) {\r\nif (tmp_opp->rate == freq) {\r\nopp = tmp_opp;\r\nbreak;\r\n}\r\n}\r\nif (IS_ERR(opp)) {\r\nr = PTR_ERR(opp);\r\ngoto unlock;\r\n}\r\nif (opp->available == availability_req)\r\ngoto unlock;\r\n*new_opp = *opp;\r\nnew_opp->available = availability_req;\r\nlist_replace_rcu(&opp->node, &new_opp->node);\r\nmutex_unlock(&dev_opp_list_lock);\r\nkfree_rcu(opp, head);\r\nif (availability_req)\r\nsrcu_notifier_call_chain(&dev_opp->head, OPP_EVENT_ENABLE,\r\nnew_opp);\r\nelse\r\nsrcu_notifier_call_chain(&dev_opp->head, OPP_EVENT_DISABLE,\r\nnew_opp);\r\nreturn 0;\r\nunlock:\r\nmutex_unlock(&dev_opp_list_lock);\r\nkfree(new_opp);\r\nreturn r;\r\n}\r\nint dev_pm_opp_enable(struct device *dev, unsigned long freq)\r\n{\r\nreturn opp_set_availability(dev, freq, true);\r\n}\r\nint dev_pm_opp_disable(struct device *dev, unsigned long freq)\r\n{\r\nreturn opp_set_availability(dev, freq, false);\r\n}\r\nint dev_pm_opp_init_cpufreq_table(struct device *dev,\r\nstruct cpufreq_frequency_table **table)\r\n{\r\nstruct device_opp *dev_opp;\r\nstruct dev_pm_opp *opp;\r\nstruct cpufreq_frequency_table *freq_table;\r\nint i = 0;\r\nmutex_lock(&dev_opp_list_lock);\r\ndev_opp = find_device_opp(dev);\r\nif (IS_ERR(dev_opp)) {\r\nint r = PTR_ERR(dev_opp);\r\nmutex_unlock(&dev_opp_list_lock);\r\ndev_err(dev, "%s: Device OPP not found (%d)\n", __func__, r);\r\nreturn r;\r\n}\r\nfreq_table = kzalloc(sizeof(struct cpufreq_frequency_table) *\r\n(dev_pm_opp_get_opp_count(dev) + 1), GFP_KERNEL);\r\nif (!freq_table) {\r\nmutex_unlock(&dev_opp_list_lock);\r\ndev_warn(dev, "%s: Unable to allocate frequency table\n",\r\n__func__);\r\nreturn -ENOMEM;\r\n}\r\nlist_for_each_entry(opp, &dev_opp->opp_list, node) {\r\nif (opp->available) {\r\nfreq_table[i].driver_data = i;\r\nfreq_table[i].frequency = opp->rate / 1000;\r\ni++;\r\n}\r\n}\r\nmutex_unlock(&dev_opp_list_lock);\r\nfreq_table[i].driver_data = i;\r\nfreq_table[i].frequency = CPUFREQ_TABLE_END;\r\n*table = &freq_table[0];\r\nreturn 0;\r\n}\r\nvoid dev_pm_opp_free_cpufreq_table(struct device *dev,\r\nstruct cpufreq_frequency_table **table)\r\n{\r\nif (!table)\r\nreturn;\r\nkfree(*table);\r\n*table = NULL;\r\n}\r\nstruct srcu_notifier_head *dev_pm_opp_get_notifier(struct device *dev)\r\n{\r\nstruct device_opp *dev_opp = find_device_opp(dev);\r\nif (IS_ERR(dev_opp))\r\nreturn ERR_CAST(dev_opp);\r\nreturn &dev_opp->head;\r\n}\r\nint of_init_opp_table(struct device *dev)\r\n{\r\nconst struct property *prop;\r\nconst __be32 *val;\r\nint nr;\r\nprop = of_find_property(dev->of_node, "operating-points", NULL);\r\nif (!prop)\r\nreturn -ENODEV;\r\nif (!prop->value)\r\nreturn -ENODATA;\r\nnr = prop->length / sizeof(u32);\r\nif (nr % 2) {\r\ndev_err(dev, "%s: Invalid OPP list\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nval = prop->value;\r\nwhile (nr) {\r\nunsigned long freq = be32_to_cpup(val++) * 1000;\r\nunsigned long volt = be32_to_cpup(val++);\r\nif (dev_pm_opp_add(dev, freq, volt)) {\r\ndev_warn(dev, "%s: Failed to add OPP %ld\n",\r\n__func__, freq);\r\ncontinue;\r\n}\r\nnr -= 2;\r\n}\r\nreturn 0;\r\n}

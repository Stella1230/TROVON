int __init hp300_setup_serial_console(void)\r\n{\r\nint scode;\r\nstruct uart_port port;\r\nmemset(&port, 0, sizeof(port));\r\nif (hp300_uart_scode < 0 || hp300_uart_scode > DIO_SCMAX)\r\nreturn 0;\r\nif (DIO_SCINHOLE(hp300_uart_scode))\r\nreturn 0;\r\nscode = hp300_uart_scode;\r\nport.iotype = UPIO_MEM;\r\nport.flags = UPF_SKIP_TEST | UPF_SHARE_IRQ | UPF_BOOT_AUTOCONF;\r\nport.type = PORT_UNKNOWN;\r\nif (scode == 256) {\r\n#ifdef CONFIG_HPAPCI\r\nprintk(KERN_INFO "Serial console is HP APCI 1\n");\r\nport.uartclk = HPAPCI_BAUD_BASE * 16;\r\nport.mapbase = (FRODO_BASE + FRODO_APCI_OFFSET(1));\r\nport.membase = (char *)(port.mapbase + DIO_VIRADDRBASE);\r\nport.regshift = 2;\r\nadd_preferred_console("ttyS", port.line, "9600n8");\r\n#else\r\nprintk(KERN_WARNING "Serial console is APCI but support is disabled (CONFIG_HPAPCI)!\n");\r\nreturn 0;\r\n#endif\r\n} else {\r\n#ifdef CONFIG_HPDCA\r\nunsigned long pa = dio_scodetophysaddr(scode);\r\nif (!pa)\r\nreturn 0;\r\nprintk(KERN_INFO "Serial console is HP DCA at select code %d\n", scode);\r\nport.uartclk = HPDCA_BAUD_BASE * 16;\r\nport.mapbase = (pa + UART_OFFSET);\r\nport.membase = (char *)(port.mapbase + DIO_VIRADDRBASE);\r\nport.regshift = 1;\r\nport.irq = DIO_IPL(pa + DIO_VIRADDRBASE);\r\nout_8(pa + DIO_VIRADDRBASE + DCA_IC, DCA_IC_IE);\r\nif (DIO_ID(pa + DIO_VIRADDRBASE) & 0x80)\r\nadd_preferred_console("ttyS", port.line, "9600n8");\r\n#else\r\nprintk(KERN_WARNING "Serial console is DCA but support is disabled (CONFIG_HPDCA)!\n");\r\nreturn 0;\r\n#endif\r\n}\r\nif (early_serial_setup(&port) < 0)\r\nprintk(KERN_WARNING "hp300_setup_serial_console(): early_serial_setup() failed.\n");\r\nreturn 0;\r\n}\r\nstatic int hpdca_init_one(struct dio_dev *d,\r\nconst struct dio_device_id *ent)\r\n{\r\nstruct uart_8250_port uart;\r\nint line;\r\n#ifdef CONFIG_SERIAL_8250_CONSOLE\r\nif (hp300_uart_scode == d->scode) {\r\nreturn 0;\r\n}\r\n#endif\r\nmemset(&uart, 0, sizeof(uart));\r\nuart.port.iotype = UPIO_MEM;\r\nuart.port.flags = UPF_SKIP_TEST | UPF_SHARE_IRQ | UPF_BOOT_AUTOCONF;\r\nuart.port.irq = d->ipl;\r\nuart.port.uartclk = HPDCA_BAUD_BASE * 16;\r\nuart.port.mapbase = (d->resource.start + UART_OFFSET);\r\nuart.port.membase = (char *)(uart.port.mapbase + DIO_VIRADDRBASE);\r\nuart.port.regshift = 1;\r\nuart.port.dev = &d->dev;\r\nline = serial8250_register_8250_port(&uart);\r\nif (line < 0) {\r\nprintk(KERN_NOTICE "8250_hp300: register_serial() DCA scode %d"\r\n" irq %d failed\n", d->scode, uart.port.irq);\r\nreturn -ENOMEM;\r\n}\r\nout_8(d->resource.start + DIO_VIRADDRBASE + DCA_IC, DCA_IC_IE);\r\ndio_set_drvdata(d, (void *)line);\r\nout_8(d->resource.start + DIO_VIRADDRBASE + DCA_ID, 0xff);\r\nudelay(100);\r\nnum_ports++;\r\nreturn 0;\r\n}\r\nstatic int __init hp300_8250_init(void)\r\n{\r\nstatic int called;\r\n#ifdef CONFIG_HPAPCI\r\nint line;\r\nunsigned long base;\r\nstruct uart_8250_port uart;\r\nstruct hp300_port *port;\r\nint i;\r\n#endif\r\nif (called)\r\nreturn -ENODEV;\r\ncalled = 1;\r\nif (!MACH_IS_HP300)\r\nreturn -ENODEV;\r\n#ifdef CONFIG_HPDCA\r\ndio_register_driver(&hpdca_driver);\r\n#endif\r\n#ifdef CONFIG_HPAPCI\r\nif (hp300_model < HP_400) {\r\nif (!num_ports)\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nfor (i = 1; i < 4; i++) {\r\n#ifdef CONFIG_SERIAL_8250_CONSOLE\r\nif (i == 1)\r\ncontinue;\r\n#endif\r\nport = kmalloc(sizeof(struct hp300_port), GFP_KERNEL);\r\nif (!port)\r\nreturn -ENOMEM;\r\nmemset(&uart, 0, sizeof(uart));\r\nbase = (FRODO_BASE + FRODO_APCI_OFFSET(i));\r\nuart.port.iotype = UPIO_MEM;\r\nuart.port.flags = UPF_SKIP_TEST | UPF_SHARE_IRQ \\r\n| UPF_BOOT_AUTOCONF;\r\nuart.port.irq = 0;\r\nuart.port.uartclk = HPAPCI_BAUD_BASE * 16;\r\nuart.port.mapbase = base;\r\nuart.port.membase = (char *)(base + DIO_VIRADDRBASE);\r\nuart.port.regshift = 2;\r\nline = serial8250_register_8250_port(&uart);\r\nif (line < 0) {\r\nprintk(KERN_NOTICE "8250_hp300: register_serial() APCI"\r\n" %d irq %d failed\n", i, uart.port.irq);\r\nkfree(port);\r\ncontinue;\r\n}\r\nport->line = line;\r\nport->next = hp300_ports;\r\nhp300_ports = port;\r\nnum_ports++;\r\n}\r\n#endif\r\nif (!num_ports)\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nstatic void hpdca_remove_one(struct dio_dev *d)\r\n{\r\nint line;\r\nline = (int) dio_get_drvdata(d);\r\nif (d->resource.start) {\r\nout_8(d->resource.start + DIO_VIRADDRBASE + DCA_IC, 0);\r\n}\r\nserial8250_unregister_port(line);\r\n}\r\nstatic void __exit hp300_8250_exit(void)\r\n{\r\n#ifdef CONFIG_HPAPCI\r\nstruct hp300_port *port, *to_free;\r\nfor (port = hp300_ports; port; ) {\r\nserial8250_unregister_port(port->line);\r\nto_free = port;\r\nport = port->next;\r\nkfree(to_free);\r\n}\r\nhp300_ports = NULL;\r\n#endif\r\n#ifdef CONFIG_HPDCA\r\ndio_unregister_driver(&hpdca_driver);\r\n#endif\r\n}

static bool pcm1792a_accessible_reg(struct device *dev, unsigned int reg)\r\n{\r\nreturn reg >= 0x10 && reg <= 0x17;\r\n}\r\nstatic bool pcm1792a_writeable_reg(struct device *dev, unsigned register reg)\r\n{\r\nbool accessible;\r\naccessible = pcm1792a_accessible_reg(dev, reg);\r\nreturn accessible && reg != 0x16 && reg != 0x17;\r\n}\r\nstatic int pcm1792a_set_dai_fmt(struct snd_soc_dai *codec_dai,\r\nunsigned int format)\r\n{\r\nstruct snd_soc_codec *codec = codec_dai->codec;\r\nstruct pcm1792a_private *priv = snd_soc_codec_get_drvdata(codec);\r\npriv->format = format;\r\nreturn 0;\r\n}\r\nstatic int pcm1792a_digital_mute(struct snd_soc_dai *dai, int mute)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nstruct pcm1792a_private *priv = snd_soc_codec_get_drvdata(codec);\r\nint ret;\r\nret = regmap_update_bits(priv->regmap, PCM1792A_SOFT_MUTE,\r\nPCM1792A_MUTE_MASK, !!mute);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int pcm1792a_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nstruct pcm1792a_private *priv = snd_soc_codec_get_drvdata(codec);\r\nint val = 0, ret;\r\nint pcm_format = params_format(params);\r\npriv->rate = params_rate(params);\r\nswitch (priv->format & SND_SOC_DAIFMT_FORMAT_MASK) {\r\ncase SND_SOC_DAIFMT_RIGHT_J:\r\nif (pcm_format == SNDRV_PCM_FORMAT_S24_LE ||\r\npcm_format == SNDRV_PCM_FORMAT_S32_LE)\r\nval = 0x02;\r\nelse if (pcm_format == SNDRV_PCM_FORMAT_S16_LE)\r\nval = 0x00;\r\nbreak;\r\ncase SND_SOC_DAIFMT_I2S:\r\nif (pcm_format == SNDRV_PCM_FORMAT_S24_LE ||\r\npcm_format == SNDRV_PCM_FORMAT_S32_LE)\r\nval = 0x05;\r\nelse if (pcm_format == SNDRV_PCM_FORMAT_S16_LE)\r\nval = 0x04;\r\nbreak;\r\ndefault:\r\ndev_err(codec->dev, "Invalid DAI format\n");\r\nreturn -EINVAL;\r\n}\r\nval = val << PCM1792A_FMT_SHIFT | PCM1792A_ATLD_ENABLE;\r\nret = regmap_update_bits(priv->regmap, PCM1792A_FMT_CONTROL,\r\nPCM1792A_FMT_MASK | PCM1792A_ATLD_ENABLE, val);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int pcm1792a_spi_probe(struct spi_device *spi)\r\n{\r\nstruct pcm1792a_private *pcm1792a;\r\nint ret;\r\npcm1792a = devm_kzalloc(&spi->dev, sizeof(struct pcm1792a_private),\r\nGFP_KERNEL);\r\nif (!pcm1792a)\r\nreturn -ENOMEM;\r\nspi_set_drvdata(spi, pcm1792a);\r\npcm1792a->regmap = devm_regmap_init_spi(spi, &pcm1792a_regmap);\r\nif (IS_ERR(pcm1792a->regmap)) {\r\nret = PTR_ERR(pcm1792a->regmap);\r\ndev_err(&spi->dev, "Failed to register regmap: %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn snd_soc_register_codec(&spi->dev,\r\n&soc_codec_dev_pcm1792a, &pcm1792a_dai, 1);\r\n}\r\nstatic int pcm1792a_spi_remove(struct spi_device *spi)\r\n{\r\nsnd_soc_unregister_codec(&spi->dev);\r\nreturn 0;\r\n}

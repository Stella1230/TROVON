static struct fsfilt_operations *fsfilt_search_type(const char *type)\r\n{\r\nstruct fsfilt_operations *found;\r\nstruct list_head *p;\r\nlist_for_each(p, &fsfilt_types) {\r\nfound = list_entry(p, struct fsfilt_operations, fs_list);\r\nif (!strcmp(found->fs_type, type))\r\nreturn found;\r\n}\r\nreturn NULL;\r\n}\r\nint fsfilt_register_ops(struct fsfilt_operations *fs_ops)\r\n{\r\nstruct fsfilt_operations *found;\r\nfound = fsfilt_search_type(fs_ops->fs_type);\r\nif (found) {\r\nif (found != fs_ops) {\r\nCERROR("different operations for type %s\n",\r\nfs_ops->fs_type);\r\nreturn -EEXIST;\r\n}\r\n} else {\r\ntry_module_get(THIS_MODULE);\r\nlist_add(&fs_ops->fs_list, &fsfilt_types);\r\n}\r\nreturn 0;\r\n}\r\nvoid fsfilt_unregister_ops(struct fsfilt_operations *fs_ops)\r\n{\r\nstruct list_head *p;\r\nlist_for_each(p, &fsfilt_types) {\r\nstruct fsfilt_operations *found;\r\nfound = list_entry(p, typeof(*found), fs_list);\r\nif (found == fs_ops) {\r\nlist_del(p);\r\nmodule_put(THIS_MODULE);\r\nbreak;\r\n}\r\n}\r\n}\r\nstruct fsfilt_operations *fsfilt_get_ops(const char *type)\r\n{\r\nstruct fsfilt_operations *fs_ops;\r\nfs_ops = fsfilt_search_type(type);\r\nif (!fs_ops) {\r\nchar name[32];\r\nint rc;\r\nsnprintf(name, sizeof(name) - 1, "fsfilt_%s", type);\r\nname[sizeof(name) - 1] = '\0';\r\nrc = request_module("%s", name);\r\nif (!rc) {\r\nfs_ops = fsfilt_search_type(type);\r\nCDEBUG(D_INFO, "Loaded module '%s'\n", name);\r\nif (!fs_ops)\r\nrc = -ENOENT;\r\n}\r\nif (rc) {\r\nCERROR("Can't find %s interface\n", name);\r\nreturn ERR_PTR(rc < 0 ? rc : -rc);\r\n}\r\n}\r\ntry_module_get(fs_ops->fs_owner);\r\nreturn fs_ops;\r\n}\r\nvoid fsfilt_put_ops(struct fsfilt_operations *fs_ops)\r\n{\r\nmodule_put(fs_ops->fs_owner);\r\n}

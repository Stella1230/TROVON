int radeon_align_pitch(struct radeon_device *rdev, int width, int bpp, bool tiled)\r\n{\r\nint aligned = width;\r\nint align_large = (ASIC_IS_AVIVO(rdev)) || tiled;\r\nint pitch_mask = 0;\r\nswitch (bpp / 8) {\r\ncase 1:\r\npitch_mask = align_large ? 255 : 127;\r\nbreak;\r\ncase 2:\r\npitch_mask = align_large ? 127 : 31;\r\nbreak;\r\ncase 3:\r\ncase 4:\r\npitch_mask = align_large ? 63 : 15;\r\nbreak;\r\n}\r\naligned += pitch_mask;\r\naligned &= ~pitch_mask;\r\nreturn aligned;\r\n}\r\nstatic void radeonfb_destroy_pinned_object(struct drm_gem_object *gobj)\r\n{\r\nstruct radeon_bo *rbo = gem_to_radeon_bo(gobj);\r\nint ret;\r\nret = radeon_bo_reserve(rbo, false);\r\nif (likely(ret == 0)) {\r\nradeon_bo_kunmap(rbo);\r\nradeon_bo_unpin(rbo);\r\nradeon_bo_unreserve(rbo);\r\n}\r\ndrm_gem_object_unreference_unlocked(gobj);\r\n}\r\nstatic int radeonfb_create_pinned_object(struct radeon_fbdev *rfbdev,\r\nstruct drm_mode_fb_cmd2 *mode_cmd,\r\nstruct drm_gem_object **gobj_p)\r\n{\r\nstruct radeon_device *rdev = rfbdev->rdev;\r\nstruct drm_gem_object *gobj = NULL;\r\nstruct radeon_bo *rbo = NULL;\r\nbool fb_tiled = false;\r\nu32 tiling_flags = 0;\r\nint ret;\r\nint aligned_size, size;\r\nint height = mode_cmd->height;\r\nu32 bpp, depth;\r\ndrm_fb_get_bpp_depth(mode_cmd->pixel_format, &depth, &bpp);\r\nmode_cmd->pitches[0] = radeon_align_pitch(rdev, mode_cmd->width, bpp,\r\nfb_tiled) * ((bpp + 1) / 8);\r\nif (rdev->family >= CHIP_R600)\r\nheight = ALIGN(mode_cmd->height, 8);\r\nsize = mode_cmd->pitches[0] * height;\r\naligned_size = ALIGN(size, PAGE_SIZE);\r\nret = radeon_gem_object_create(rdev, aligned_size, 0,\r\nRADEON_GEM_DOMAIN_VRAM,\r\nfalse, true,\r\n&gobj);\r\nif (ret) {\r\nprintk(KERN_ERR "failed to allocate framebuffer (%d)\n",\r\naligned_size);\r\nreturn -ENOMEM;\r\n}\r\nrbo = gem_to_radeon_bo(gobj);\r\nif (fb_tiled)\r\ntiling_flags = RADEON_TILING_MACRO;\r\n#ifdef __BIG_ENDIAN\r\nswitch (bpp) {\r\ncase 32:\r\ntiling_flags |= RADEON_TILING_SWAP_32BIT;\r\nbreak;\r\ncase 16:\r\ntiling_flags |= RADEON_TILING_SWAP_16BIT;\r\ndefault:\r\nbreak;\r\n}\r\n#endif\r\nif (tiling_flags) {\r\nret = radeon_bo_set_tiling_flags(rbo,\r\ntiling_flags | RADEON_TILING_SURFACE,\r\nmode_cmd->pitches[0]);\r\nif (ret)\r\ndev_err(rdev->dev, "FB failed to set tiling flags\n");\r\n}\r\nret = radeon_bo_reserve(rbo, false);\r\nif (unlikely(ret != 0))\r\ngoto out_unref;\r\nret = radeon_bo_pin_restricted(rbo, RADEON_GEM_DOMAIN_VRAM,\r\nASIC_IS_AVIVO(rdev) ? 0 : 1 << 27,\r\nNULL);\r\nif (ret) {\r\nradeon_bo_unreserve(rbo);\r\ngoto out_unref;\r\n}\r\nif (fb_tiled)\r\nradeon_bo_check_tiling(rbo, 0, 0);\r\nret = radeon_bo_kmap(rbo, NULL);\r\nradeon_bo_unreserve(rbo);\r\nif (ret) {\r\ngoto out_unref;\r\n}\r\n*gobj_p = gobj;\r\nreturn 0;\r\nout_unref:\r\nradeonfb_destroy_pinned_object(gobj);\r\n*gobj_p = NULL;\r\nreturn ret;\r\n}\r\nstatic int radeonfb_create(struct drm_fb_helper *helper,\r\nstruct drm_fb_helper_surface_size *sizes)\r\n{\r\nstruct radeon_fbdev *rfbdev = (struct radeon_fbdev *)helper;\r\nstruct radeon_device *rdev = rfbdev->rdev;\r\nstruct fb_info *info;\r\nstruct drm_framebuffer *fb = NULL;\r\nstruct drm_mode_fb_cmd2 mode_cmd;\r\nstruct drm_gem_object *gobj = NULL;\r\nstruct radeon_bo *rbo = NULL;\r\nstruct device *device = &rdev->pdev->dev;\r\nint ret;\r\nunsigned long tmp;\r\nmode_cmd.width = sizes->surface_width;\r\nmode_cmd.height = sizes->surface_height;\r\nif ((sizes->surface_bpp == 24) && ASIC_IS_AVIVO(rdev))\r\nsizes->surface_bpp = 32;\r\nmode_cmd.pixel_format = drm_mode_legacy_fb_format(sizes->surface_bpp,\r\nsizes->surface_depth);\r\nret = radeonfb_create_pinned_object(rfbdev, &mode_cmd, &gobj);\r\nif (ret) {\r\nDRM_ERROR("failed to create fbcon object %d\n", ret);\r\nreturn ret;\r\n}\r\nrbo = gem_to_radeon_bo(gobj);\r\ninfo = framebuffer_alloc(0, device);\r\nif (info == NULL) {\r\nret = -ENOMEM;\r\ngoto out_unref;\r\n}\r\ninfo->par = rfbdev;\r\nret = radeon_framebuffer_init(rdev->ddev, &rfbdev->rfb, &mode_cmd, gobj);\r\nif (ret) {\r\nDRM_ERROR("failed to initialize framebuffer %d\n", ret);\r\ngoto out_unref;\r\n}\r\nfb = &rfbdev->rfb.base;\r\nrfbdev->helper.fb = fb;\r\nrfbdev->helper.fbdev = info;\r\nmemset_io(rbo->kptr, 0x0, radeon_bo_size(rbo));\r\nstrcpy(info->fix.id, "radeondrmfb");\r\ndrm_fb_helper_fill_fix(info, fb->pitches[0], fb->depth);\r\ninfo->flags = FBINFO_DEFAULT | FBINFO_CAN_FORCE_OUTPUT;\r\ninfo->fbops = &radeonfb_ops;\r\ntmp = radeon_bo_gpu_offset(rbo) - rdev->mc.vram_start;\r\ninfo->fix.smem_start = rdev->mc.aper_base + tmp;\r\ninfo->fix.smem_len = radeon_bo_size(rbo);\r\ninfo->screen_base = rbo->kptr;\r\ninfo->screen_size = radeon_bo_size(rbo);\r\ndrm_fb_helper_fill_var(info, &rfbdev->helper, sizes->fb_width, sizes->fb_height);\r\ninfo->apertures = alloc_apertures(1);\r\nif (!info->apertures) {\r\nret = -ENOMEM;\r\ngoto out_unref;\r\n}\r\ninfo->apertures->ranges[0].base = rdev->ddev->mode_config.fb_base;\r\ninfo->apertures->ranges[0].size = rdev->mc.aper_size;\r\nif (info->screen_base == NULL) {\r\nret = -ENOSPC;\r\ngoto out_unref;\r\n}\r\nret = fb_alloc_cmap(&info->cmap, 256, 0);\r\nif (ret) {\r\nret = -ENOMEM;\r\ngoto out_unref;\r\n}\r\nDRM_INFO("fb mappable at 0x%lX\n", info->fix.smem_start);\r\nDRM_INFO("vram apper at 0x%lX\n", (unsigned long)rdev->mc.aper_base);\r\nDRM_INFO("size %lu\n", (unsigned long)radeon_bo_size(rbo));\r\nDRM_INFO("fb depth is %d\n", fb->depth);\r\nDRM_INFO(" pitch is %d\n", fb->pitches[0]);\r\nvga_switcheroo_client_fb_set(rdev->ddev->pdev, info);\r\nreturn 0;\r\nout_unref:\r\nif (rbo) {\r\n}\r\nif (fb && ret) {\r\ndrm_gem_object_unreference(gobj);\r\ndrm_framebuffer_unregister_private(fb);\r\ndrm_framebuffer_cleanup(fb);\r\nkfree(fb);\r\n}\r\nreturn ret;\r\n}\r\nvoid radeon_fb_output_poll_changed(struct radeon_device *rdev)\r\n{\r\ndrm_fb_helper_hotplug_event(&rdev->mode_info.rfbdev->helper);\r\n}\r\nstatic int radeon_fbdev_destroy(struct drm_device *dev, struct radeon_fbdev *rfbdev)\r\n{\r\nstruct fb_info *info;\r\nstruct radeon_framebuffer *rfb = &rfbdev->rfb;\r\nif (rfbdev->helper.fbdev) {\r\ninfo = rfbdev->helper.fbdev;\r\nunregister_framebuffer(info);\r\nif (info->cmap.len)\r\nfb_dealloc_cmap(&info->cmap);\r\nframebuffer_release(info);\r\n}\r\nif (rfb->obj) {\r\nradeonfb_destroy_pinned_object(rfb->obj);\r\nrfb->obj = NULL;\r\n}\r\ndrm_fb_helper_fini(&rfbdev->helper);\r\ndrm_framebuffer_unregister_private(&rfb->base);\r\ndrm_framebuffer_cleanup(&rfb->base);\r\nreturn 0;\r\n}\r\nint radeon_fbdev_init(struct radeon_device *rdev)\r\n{\r\nstruct radeon_fbdev *rfbdev;\r\nint bpp_sel = 32;\r\nint ret;\r\nif (ASIC_IS_RN50(rdev) || rdev->mc.real_vram_size <= (32*1024*1024))\r\nbpp_sel = 8;\r\nrfbdev = kzalloc(sizeof(struct radeon_fbdev), GFP_KERNEL);\r\nif (!rfbdev)\r\nreturn -ENOMEM;\r\nrfbdev->rdev = rdev;\r\nrdev->mode_info.rfbdev = rfbdev;\r\nrfbdev->helper.funcs = &radeon_fb_helper_funcs;\r\nret = drm_fb_helper_init(rdev->ddev, &rfbdev->helper,\r\nrdev->num_crtc,\r\nRADEONFB_CONN_LIMIT);\r\nif (ret) {\r\nkfree(rfbdev);\r\nreturn ret;\r\n}\r\ndrm_fb_helper_single_add_all_connectors(&rfbdev->helper);\r\ndrm_helper_disable_unused_functions(rdev->ddev);\r\ndrm_fb_helper_initial_config(&rfbdev->helper, bpp_sel);\r\nreturn 0;\r\n}\r\nvoid radeon_fbdev_fini(struct radeon_device *rdev)\r\n{\r\nif (!rdev->mode_info.rfbdev)\r\nreturn;\r\nradeon_fbdev_destroy(rdev->ddev, rdev->mode_info.rfbdev);\r\nkfree(rdev->mode_info.rfbdev);\r\nrdev->mode_info.rfbdev = NULL;\r\n}\r\nvoid radeon_fbdev_set_suspend(struct radeon_device *rdev, int state)\r\n{\r\nfb_set_suspend(rdev->mode_info.rfbdev->helper.fbdev, state);\r\n}\r\nint radeon_fbdev_total_size(struct radeon_device *rdev)\r\n{\r\nstruct radeon_bo *robj;\r\nint size = 0;\r\nrobj = gem_to_radeon_bo(rdev->mode_info.rfbdev->rfb.obj);\r\nsize += radeon_bo_size(robj);\r\nreturn size;\r\n}\r\nbool radeon_fbdev_robj_is_fb(struct radeon_device *rdev, struct radeon_bo *robj)\r\n{\r\nif (robj == gem_to_radeon_bo(rdev->mode_info.rfbdev->rfb.obj))\r\nreturn true;\r\nreturn false;\r\n}

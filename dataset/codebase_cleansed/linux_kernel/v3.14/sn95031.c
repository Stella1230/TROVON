static void sn95031_enable_mic_bias(struct snd_soc_codec *codec)\r\n{\r\nsnd_soc_write(codec, SN95031_VAUD, BIT(2)|BIT(1)|BIT(0));\r\nsnd_soc_update_bits(codec, SN95031_MICBIAS, BIT(2), BIT(2));\r\n}\r\nstatic void configure_adc(struct snd_soc_codec *sn95031_codec, int val)\r\n{\r\nint value = snd_soc_read(sn95031_codec, SN95031_ADC1CNTL1);\r\nif (val) {\r\nvalue |= (SN95031_ADC_ENBL | SN95031_ADC_START);\r\nvalue &= (~SN95031_ADC_NO_LOOP);\r\n} else {\r\nvalue &= (~SN95031_ADC_START);\r\n}\r\nsnd_soc_write(sn95031_codec, SN95031_ADC1CNTL1, value);\r\n}\r\nstatic int find_free_channel(struct snd_soc_codec *sn95031_codec)\r\n{\r\nint i, value;\r\nvalue = snd_soc_read(sn95031_codec, SN95031_ADC1CNTL1);\r\nif ((value & SN95031_ADC_ENBL) == 0)\r\nreturn 0;\r\nfor (i = 0; i < SN95031_ADC_CHANLS_MAX; i++) {\r\nvalue = snd_soc_read(sn95031_codec,\r\nSN95031_ADC_CHNL_START_ADDR + i);\r\nif (value & SN95031_STOPBIT_MASK)\r\nbreak;\r\n}\r\nreturn (i == SN95031_ADC_CHANLS_MAX) ? (-EINVAL) : i;\r\n}\r\nstatic int sn95031_initialize_adc(struct snd_soc_codec *sn95031_codec)\r\n{\r\nint base_addr, chnl_addr;\r\nint value;\r\nint channel_index;\r\nchannel_index = find_free_channel(sn95031_codec);\r\nif (channel_index < 0) {\r\npr_err("No free ADC channels");\r\nreturn channel_index;\r\n}\r\nbase_addr = SN95031_ADC_CHNL_START_ADDR + channel_index;\r\nif (!(channel_index == 0 || channel_index == SN95031_ADC_LOOP_MAX)) {\r\nvalue = snd_soc_read(sn95031_codec, base_addr);\r\nsnd_soc_write(sn95031_codec, base_addr, value & 0xEF);\r\nbase_addr++;\r\nchannel_index++;\r\n}\r\nsnd_soc_write(sn95031_codec, base_addr,\r\nSN95031_AUDIO_DETECT_CODE | 0x10);\r\nchnl_addr = SN95031_ADC_DATA_START_ADDR + 2 * channel_index;\r\npr_debug("mid_initialize : %x", chnl_addr);\r\nconfigure_adc(sn95031_codec, 1);\r\nreturn chnl_addr;\r\n}\r\nstatic unsigned int sn95031_get_mic_bias(struct snd_soc_codec *codec)\r\n{\r\nu16 adc_adr = sn95031_initialize_adc(codec);\r\nu16 adc_val1, adc_val2;\r\nunsigned int mic_bias;\r\nsn95031_enable_mic_bias(codec);\r\nsnd_soc_write(codec, SN95031_ADC1CNTL3, 0x05);\r\nsnd_soc_write(codec, SN95031_ADC1CNTL3, 0x04);\r\nmsleep(1000);\r\nadc_val1 = snd_soc_read(codec, adc_adr);\r\nadc_adr++;\r\nadc_val2 = snd_soc_read(codec, adc_adr);\r\nmic_bias = (adc_val1 << 2) + (adc_val2 & 3);\r\nmic_bias = (mic_bias * SN95031_ADC_ONE_LSB_MULTIPLIER) / 1000;\r\npr_debug("mic bias = %dmV\n", mic_bias);\r\nreturn mic_bias;\r\n}\r\nstatic int sn95031_read(void *ctx, unsigned int reg, unsigned int *val)\r\n{\r\nu8 value = 0;\r\nint ret;\r\nret = intel_scu_ipc_ioread8(reg, &value);\r\nif (ret == 0)\r\n*val = value;\r\nreturn ret;\r\n}\r\nstatic int sn95031_write(void *ctx, unsigned int reg, unsigned int value)\r\n{\r\nreturn intel_scu_ipc_iowrite8(reg, value);\r\n}\r\nstatic int sn95031_set_vaud_bias(struct snd_soc_codec *codec,\r\nenum snd_soc_bias_level level)\r\n{\r\nswitch (level) {\r\ncase SND_SOC_BIAS_ON:\r\nbreak;\r\ncase SND_SOC_BIAS_PREPARE:\r\nif (codec->dapm.bias_level == SND_SOC_BIAS_STANDBY) {\r\npr_debug("vaud_bias powering up pll\n");\r\nsnd_soc_write(codec, SN95031_AUDPLLCTRL, BIT(5));\r\nsnd_soc_update_bits(codec, SN95031_PCM2C2,\r\nBIT(0), BIT(0));\r\n}\r\nbreak;\r\ncase SND_SOC_BIAS_STANDBY:\r\nif (codec->dapm.bias_level == SND_SOC_BIAS_OFF) {\r\npr_debug("vaud_bias power up rail\n");\r\nsnd_soc_write(codec, SN95031_VAUD,\r\nBIT(2)|BIT(1)|BIT(0));\r\nmsleep(1);\r\n} else if (codec->dapm.bias_level == SND_SOC_BIAS_PREPARE) {\r\npr_debug("vaud_bias power dn pcm\n");\r\nsnd_soc_update_bits(codec, SN95031_PCM2C2, BIT(0), 0);\r\nsnd_soc_write(codec, SN95031_AUDPLLCTRL, 0);\r\n}\r\nbreak;\r\ncase SND_SOC_BIAS_OFF:\r\npr_debug("vaud_bias _OFF doing rail shutdown\n");\r\nsnd_soc_write(codec, SN95031_VAUD, BIT(3));\r\nbreak;\r\n}\r\ncodec->dapm.bias_level = level;\r\nreturn 0;\r\n}\r\nstatic int sn95031_vhs_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nif (SND_SOC_DAPM_EVENT_ON(event)) {\r\npr_debug("VHS SND_SOC_DAPM_EVENT_ON doing rail startup now\n");\r\nsnd_soc_write(w->codec, SN95031_VHSP, 0x3D);\r\nsnd_soc_write(w->codec, SN95031_VHSN, 0x3F);\r\nmsleep(1);\r\n} else if (SND_SOC_DAPM_EVENT_OFF(event)) {\r\npr_debug("VHS SND_SOC_DAPM_EVENT_OFF doing rail shutdown\n");\r\nsnd_soc_write(w->codec, SN95031_VHSP, 0xC4);\r\nsnd_soc_write(w->codec, SN95031_VHSN, 0x04);\r\n}\r\nreturn 0;\r\n}\r\nstatic int sn95031_vihf_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *kcontrol, int event)\r\n{\r\nif (SND_SOC_DAPM_EVENT_ON(event)) {\r\npr_debug("VIHF SND_SOC_DAPM_EVENT_ON doing rail startup now\n");\r\nsnd_soc_write(w->codec, SN95031_VIHF, 0x27);\r\nmsleep(1);\r\n} else if (SND_SOC_DAPM_EVENT_OFF(event)) {\r\npr_debug("VIHF SND_SOC_DAPM_EVENT_OFF doing rail shutdown\n");\r\nsnd_soc_write(w->codec, SN95031_VIHF, 0x24);\r\n}\r\nreturn 0;\r\n}\r\nstatic int sn95031_dmic12_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *k, int event)\r\n{\r\nunsigned int ldo = 0, clk_dir = 0, data_dir = 0;\r\nif (SND_SOC_DAPM_EVENT_ON(event)) {\r\nldo = BIT(5)|BIT(4);\r\nclk_dir = BIT(0);\r\ndata_dir = BIT(7);\r\n}\r\nsnd_soc_update_bits(w->codec, SN95031_MICBIAS, BIT(5)|BIT(4), ldo);\r\nsnd_soc_update_bits(w->codec, SN95031_DMICBUF0123, BIT(0), clk_dir);\r\nsnd_soc_update_bits(w->codec, SN95031_DMICBUF0123, BIT(7), data_dir);\r\nreturn 0;\r\n}\r\nstatic int sn95031_dmic34_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *k, int event)\r\n{\r\nunsigned int ldo = 0, clk_dir = 0, data_dir = 0;\r\nif (SND_SOC_DAPM_EVENT_ON(event)) {\r\nldo = BIT(5)|BIT(4);\r\nclk_dir = BIT(2);\r\ndata_dir = BIT(1);\r\n}\r\nsnd_soc_update_bits(w->codec, SN95031_MICBIAS, BIT(5)|BIT(4), ldo);\r\nsnd_soc_update_bits(w->codec, SN95031_DMICBUF0123, BIT(2), clk_dir);\r\nsnd_soc_update_bits(w->codec, SN95031_DMICBUF45, BIT(1), data_dir);\r\nreturn 0;\r\n}\r\nstatic int sn95031_dmic56_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *k, int event)\r\n{\r\nunsigned int ldo = 0;\r\nif (SND_SOC_DAPM_EVENT_ON(event))\r\nldo = BIT(7)|BIT(6);\r\nsnd_soc_update_bits(w->codec, SN95031_MICBIAS, BIT(7)|BIT(6), ldo);\r\nreturn 0;\r\n}\r\nstatic int sn95031_pcm_hs_mute(struct snd_soc_dai *dai, int mute)\r\n{\r\nsnd_soc_update_bits(dai->codec,\r\nSN95031_HSLVOLCTRL, BIT(7), (!mute << 7));\r\nsnd_soc_update_bits(dai->codec,\r\nSN95031_HSRVOLCTRL, BIT(7), (!mute << 7));\r\nreturn 0;\r\n}\r\nstatic int sn95031_pcm_spkr_mute(struct snd_soc_dai *dai, int mute)\r\n{\r\nsnd_soc_update_bits(dai->codec,\r\nSN95031_IHFLVOLCTRL, BIT(7), (!mute << 7));\r\nsnd_soc_update_bits(dai->codec,\r\nSN95031_IHFRVOLCTRL, BIT(7), (!mute << 7));\r\nreturn 0;\r\n}\r\nstatic int sn95031_pcm_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params, struct snd_soc_dai *dai)\r\n{\r\nunsigned int format, rate;\r\nswitch (params_format(params)) {\r\ncase SNDRV_PCM_FORMAT_S16_LE:\r\nformat = BIT(4)|BIT(5);\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S24_LE:\r\nformat = 0;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nsnd_soc_update_bits(dai->codec, SN95031_PCM2C2,\r\nBIT(4)|BIT(5), format);\r\nswitch (params_rate(params)) {\r\ncase 48000:\r\npr_debug("RATE_48000\n");\r\nrate = 0;\r\nbreak;\r\ncase 44100:\r\npr_debug("RATE_44100\n");\r\nrate = BIT(7);\r\nbreak;\r\ndefault:\r\npr_err("ERR rate %d\n", params_rate(params));\r\nreturn -EINVAL;\r\n}\r\nsnd_soc_update_bits(dai->codec, SN95031_PCM1C1, BIT(7), rate);\r\nreturn 0;\r\n}\r\nstatic inline void sn95031_disable_jack_btn(struct snd_soc_codec *codec)\r\n{\r\nsnd_soc_write(codec, SN95031_BTNCTRL2, 0x00);\r\n}\r\nstatic inline void sn95031_enable_jack_btn(struct snd_soc_codec *codec)\r\n{\r\nsnd_soc_write(codec, SN95031_BTNCTRL1, 0x77);\r\nsnd_soc_write(codec, SN95031_BTNCTRL2, 0x01);\r\n}\r\nstatic int sn95031_get_headset_state(struct snd_soc_jack *mfld_jack)\r\n{\r\nint micbias = sn95031_get_mic_bias(mfld_jack->codec);\r\nint jack_type = snd_soc_jack_get_type(mfld_jack, micbias);\r\npr_debug("jack type detected = %d\n", jack_type);\r\nif (jack_type == SND_JACK_HEADSET)\r\nsn95031_enable_jack_btn(mfld_jack->codec);\r\nreturn jack_type;\r\n}\r\nvoid sn95031_jack_detection(struct mfld_jack_data *jack_data)\r\n{\r\nunsigned int status;\r\nunsigned int mask = SND_JACK_BTN_0 | SND_JACK_BTN_1 | SND_JACK_HEADSET;\r\npr_debug("interrupt id read in sram = 0x%x\n", jack_data->intr_id);\r\nif (jack_data->intr_id & 0x1) {\r\npr_debug("short_push detected\n");\r\nstatus = SND_JACK_HEADSET | SND_JACK_BTN_0;\r\n} else if (jack_data->intr_id & 0x2) {\r\npr_debug("long_push detected\n");\r\nstatus = SND_JACK_HEADSET | SND_JACK_BTN_1;\r\n} else if (jack_data->intr_id & 0x4) {\r\npr_debug("headset or headphones inserted\n");\r\nstatus = sn95031_get_headset_state(jack_data->mfld_jack);\r\n} else if (jack_data->intr_id & 0x8) {\r\npr_debug("headset or headphones removed\n");\r\nstatus = 0;\r\nsn95031_disable_jack_btn(jack_data->mfld_jack->codec);\r\n} else {\r\npr_err("unidentified interrupt\n");\r\nreturn;\r\n}\r\nsnd_soc_jack_report(jack_data->mfld_jack, status, mask);\r\nif ((status & SND_JACK_BTN_0) | (status & SND_JACK_BTN_1))\r\nsnd_soc_jack_report(jack_data->mfld_jack,\r\nSND_JACK_HEADSET, mask);\r\n}\r\nstatic int sn95031_codec_probe(struct snd_soc_codec *codec)\r\n{\r\npr_debug("codec_probe called\n");\r\nsnd_soc_codec_set_cache_io(codec, 0, 0, SND_SOC_REGMAP);\r\nsnd_soc_write(codec, SN95031_PCM2RXSLOT01, 0x10);\r\nsnd_soc_write(codec, SN95031_PCM2RXSLOT23, 0x32);\r\nsnd_soc_write(codec, SN95031_PCM2RXSLOT45, 0x54);\r\nsnd_soc_write(codec, SN95031_PCM2TXSLOT01, 0x10);\r\nsnd_soc_write(codec, SN95031_PCM2TXSLOT23, 0x32);\r\nsnd_soc_write(codec, SN95031_PCM1C1, 0x00);\r\nsnd_soc_write(codec, SN95031_PCM2C1, 0x01);\r\nsnd_soc_write(codec, SN95031_PCM2C2, 0x0A);\r\nsnd_soc_write(codec, SN95031_HSMIXER, BIT(0)|BIT(4));\r\nsnd_soc_write(codec, SN95031_SSR5, 0x80);\r\nsnd_soc_write(codec, SN95031_SSR6, 0x80);\r\nsnd_soc_write(codec, SN95031_VIB1C5, 0x00);\r\nsnd_soc_write(codec, SN95031_VIB2C5, 0x00);\r\nsnd_soc_write(codec, SN95031_VIB1C3, 0x00);\r\nsnd_soc_write(codec, SN95031_VIB2C3, 0x00);\r\nsnd_soc_write(codec, SN95031_SOFTMUTE, 0x3);\r\nsnd_soc_write(codec, SN95031_HSLVOLCTRL, 0x08);\r\nsnd_soc_write(codec, SN95031_HSRVOLCTRL, 0x08);\r\nsnd_soc_write(codec, SN95031_IHFLVOLCTRL, 0x08);\r\nsnd_soc_write(codec, SN95031_IHFRVOLCTRL, 0x08);\r\nsnd_soc_write(codec, SN95031_SSR2, 0x10);\r\nsnd_soc_write(codec, SN95031_SSR3, 0x40);\r\nsnd_soc_add_codec_controls(codec, sn95031_snd_controls,\r\nARRAY_SIZE(sn95031_snd_controls));\r\nreturn 0;\r\n}\r\nstatic int sn95031_codec_remove(struct snd_soc_codec *codec)\r\n{\r\npr_debug("codec_remove called\n");\r\nsn95031_set_vaud_bias(codec, SND_SOC_BIAS_OFF);\r\nreturn 0;\r\n}\r\nstatic int sn95031_device_probe(struct platform_device *pdev)\r\n{\r\nstruct regmap *regmap;\r\npr_debug("codec device probe called for %s\n", dev_name(&pdev->dev));\r\nregmap = devm_regmap_init(&pdev->dev, NULL, NULL, &sn95031_regmap);\r\nif (IS_ERR(regmap))\r\nreturn PTR_ERR(regmap);\r\nreturn snd_soc_register_codec(&pdev->dev, &sn95031_codec,\r\nsn95031_dais, ARRAY_SIZE(sn95031_dais));\r\n}\r\nstatic int sn95031_device_remove(struct platform_device *pdev)\r\n{\r\npr_debug("codec device remove called\n");\r\nsnd_soc_unregister_codec(&pdev->dev);\r\nreturn 0;\r\n}

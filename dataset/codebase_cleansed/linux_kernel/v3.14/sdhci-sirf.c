static unsigned int sdhci_sirf_get_max_clk(struct sdhci_host *host)\r\n{\r\nstruct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);\r\nstruct sdhci_sirf_priv *priv = sdhci_pltfm_priv(pltfm_host);\r\nreturn clk_get_rate(priv->clk);\r\n}\r\nstatic int sdhci_sirf_probe(struct platform_device *pdev)\r\n{\r\nstruct sdhci_host *host;\r\nstruct sdhci_pltfm_host *pltfm_host;\r\nstruct sdhci_sirf_priv *priv;\r\nstruct clk *clk;\r\nint gpio_cd;\r\nint ret;\r\nclk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(clk)) {\r\ndev_err(&pdev->dev, "unable to get clock");\r\nreturn PTR_ERR(clk);\r\n}\r\nif (pdev->dev.of_node)\r\ngpio_cd = of_get_named_gpio(pdev->dev.of_node, "cd-gpios", 0);\r\nelse\r\ngpio_cd = -EINVAL;\r\nhost = sdhci_pltfm_init(pdev, &sdhci_sirf_pdata, sizeof(struct sdhci_sirf_priv));\r\nif (IS_ERR(host))\r\nreturn PTR_ERR(host);\r\npltfm_host = sdhci_priv(host);\r\npriv = sdhci_pltfm_priv(pltfm_host);\r\npriv->clk = clk;\r\npriv->gpio_cd = gpio_cd;\r\nsdhci_get_of_property(pdev);\r\nret = clk_prepare_enable(priv->clk);\r\nif (ret)\r\ngoto err_clk_prepare;\r\nret = sdhci_add_host(host);\r\nif (ret)\r\ngoto err_sdhci_add;\r\nif (gpio_is_valid(priv->gpio_cd)) {\r\nret = mmc_gpio_request_cd(host->mmc, priv->gpio_cd, 0);\r\nif (ret) {\r\ndev_err(&pdev->dev, "card detect irq request failed: %d\n",\r\nret);\r\ngoto err_request_cd;\r\n}\r\n}\r\nreturn 0;\r\nerr_request_cd:\r\nsdhci_remove_host(host, 0);\r\nerr_sdhci_add:\r\nclk_disable_unprepare(priv->clk);\r\nerr_clk_prepare:\r\nsdhci_pltfm_free(pdev);\r\nreturn ret;\r\n}\r\nstatic int sdhci_sirf_remove(struct platform_device *pdev)\r\n{\r\nstruct sdhci_host *host = platform_get_drvdata(pdev);\r\nstruct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);\r\nstruct sdhci_sirf_priv *priv = sdhci_pltfm_priv(pltfm_host);\r\nsdhci_pltfm_unregister(pdev);\r\nif (gpio_is_valid(priv->gpio_cd))\r\nmmc_gpio_free_cd(host->mmc);\r\nclk_disable_unprepare(priv->clk);\r\nreturn 0;\r\n}\r\nstatic int sdhci_sirf_suspend(struct device *dev)\r\n{\r\nstruct sdhci_host *host = dev_get_drvdata(dev);\r\nstruct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);\r\nstruct sdhci_sirf_priv *priv = sdhci_pltfm_priv(pltfm_host);\r\nint ret;\r\nret = sdhci_suspend_host(host);\r\nif (ret)\r\nreturn ret;\r\nclk_disable(priv->clk);\r\nreturn 0;\r\n}\r\nstatic int sdhci_sirf_resume(struct device *dev)\r\n{\r\nstruct sdhci_host *host = dev_get_drvdata(dev);\r\nstruct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);\r\nstruct sdhci_sirf_priv *priv = sdhci_pltfm_priv(pltfm_host);\r\nint ret;\r\nret = clk_enable(priv->clk);\r\nif (ret) {\r\ndev_dbg(dev, "Resume: Error enabling clock\n");\r\nreturn ret;\r\n}\r\nreturn sdhci_resume_host(host);\r\n}

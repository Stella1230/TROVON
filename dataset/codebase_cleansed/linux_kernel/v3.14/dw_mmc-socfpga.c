static int dw_mci_socfpga_priv_init(struct dw_mci *host)\r\n{\r\nreturn 0;\r\n}\r\nstatic int dw_mci_socfpga_setup_clock(struct dw_mci *host)\r\n{\r\nstruct dw_mci_socfpga_priv_data *priv = host->priv;\r\nclk_disable_unprepare(host->ciu_clk);\r\nregmap_write(priv->sysreg, SYSMGR_SDMMCGRP_CTRL_OFFSET,\r\npriv->hs_timing);\r\nclk_prepare_enable(host->ciu_clk);\r\nhost->bus_hz /= (priv->ciu_div + 1);\r\nreturn 0;\r\n}\r\nstatic void dw_mci_socfpga_prepare_command(struct dw_mci *host, u32 *cmdr)\r\n{\r\nstruct dw_mci_socfpga_priv_data *priv = host->priv;\r\nif (priv->hs_timing & DRV_CLK_PHASE_SHIFT_SEL_MASK)\r\n*cmdr |= SDMMC_CMD_USE_HOLD_REG;\r\n}\r\nstatic int dw_mci_socfpga_parse_dt(struct dw_mci *host)\r\n{\r\nstruct dw_mci_socfpga_priv_data *priv;\r\nstruct device_node *np = host->dev->of_node;\r\nu32 timing[2];\r\nu32 div = 0;\r\nint ret;\r\npriv = devm_kzalloc(host->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv) {\r\ndev_err(host->dev, "mem alloc failed for private data\n");\r\nreturn -ENOMEM;\r\n}\r\npriv->sysreg = syscon_regmap_lookup_by_compatible("altr,sys-mgr");\r\nif (IS_ERR(priv->sysreg)) {\r\ndev_err(host->dev, "regmap for altr,sys-mgr lookup failed.\n");\r\nreturn PTR_ERR(priv->sysreg);\r\n}\r\nret = of_property_read_u32(np, "altr,dw-mshc-ciu-div", &div);\r\nif (ret)\r\ndev_info(host->dev, "No dw-mshc-ciu-div specified, assuming 1");\r\npriv->ciu_div = div;\r\nret = of_property_read_u32_array(np,\r\n"altr,dw-mshc-sdr-timing", timing, 2);\r\nif (ret)\r\nreturn ret;\r\npriv->hs_timing = SYSMGR_SDMMC_CTRL_SET(timing[0], timing[1]);\r\nhost->priv = priv;\r\nreturn 0;\r\n}\r\nstatic int dw_mci_socfpga_probe(struct platform_device *pdev)\r\n{\r\nconst struct dw_mci_drv_data *drv_data;\r\nconst struct of_device_id *match;\r\nmatch = of_match_node(dw_mci_socfpga_match, pdev->dev.of_node);\r\ndrv_data = match->data;\r\nreturn dw_mci_pltfm_register(pdev, drv_data);\r\n}

static void radeon_overscan_setup(struct drm_crtc *crtc,\r\nstruct drm_display_mode *mode)\r\n{\r\nstruct drm_device *dev = crtc->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);\r\nWREG32(RADEON_OVR_CLR + radeon_crtc->crtc_offset, 0);\r\nWREG32(RADEON_OVR_WID_LEFT_RIGHT + radeon_crtc->crtc_offset, 0);\r\nWREG32(RADEON_OVR_WID_TOP_BOTTOM + radeon_crtc->crtc_offset, 0);\r\n}\r\nstatic void radeon_legacy_rmx_mode_set(struct drm_crtc *crtc,\r\nstruct drm_display_mode *mode)\r\n{\r\nstruct drm_device *dev = crtc->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);\r\nint xres = mode->hdisplay;\r\nint yres = mode->vdisplay;\r\nbool hscale = true, vscale = true;\r\nint hsync_wid;\r\nint vsync_wid;\r\nint hsync_start;\r\nint blank_width;\r\nu32 scale, inc, crtc_more_cntl;\r\nu32 fp_horz_stretch, fp_vert_stretch, fp_horz_vert_active;\r\nu32 fp_h_sync_strt_wid, fp_crtc_h_total_disp;\r\nu32 fp_v_sync_strt_wid, fp_crtc_v_total_disp;\r\nstruct drm_display_mode *native_mode = &radeon_crtc->native_mode;\r\nfp_vert_stretch = RREG32(RADEON_FP_VERT_STRETCH) &\r\n(RADEON_VERT_STRETCH_RESERVED |\r\nRADEON_VERT_AUTO_RATIO_INC);\r\nfp_horz_stretch = RREG32(RADEON_FP_HORZ_STRETCH) &\r\n(RADEON_HORZ_FP_LOOP_STRETCH |\r\nRADEON_HORZ_AUTO_RATIO_INC);\r\ncrtc_more_cntl = 0;\r\nif ((rdev->family == CHIP_RS100) ||\r\n(rdev->family == CHIP_RS200)) {\r\ncrtc_more_cntl |= RADEON_CRTC_H_CUTOFF_ACTIVE_EN;\r\n}\r\nfp_crtc_h_total_disp = ((((mode->crtc_htotal / 8) - 1) & 0x3ff)\r\n| ((((mode->crtc_hdisplay / 8) - 1) & 0x1ff) << 16));\r\nhsync_wid = (mode->crtc_hsync_end - mode->crtc_hsync_start) / 8;\r\nif (!hsync_wid)\r\nhsync_wid = 1;\r\nhsync_start = mode->crtc_hsync_start - 8;\r\nfp_h_sync_strt_wid = ((hsync_start & 0x1fff)\r\n| ((hsync_wid & 0x3f) << 16)\r\n| ((mode->flags & DRM_MODE_FLAG_NHSYNC)\r\n? RADEON_CRTC_H_SYNC_POL\r\n: 0));\r\nfp_crtc_v_total_disp = (((mode->crtc_vtotal - 1) & 0xffff)\r\n| ((mode->crtc_vdisplay - 1) << 16));\r\nvsync_wid = mode->crtc_vsync_end - mode->crtc_vsync_start;\r\nif (!vsync_wid)\r\nvsync_wid = 1;\r\nfp_v_sync_strt_wid = (((mode->crtc_vsync_start - 1) & 0xfff)\r\n| ((vsync_wid & 0x1f) << 16)\r\n| ((mode->flags & DRM_MODE_FLAG_NVSYNC)\r\n? RADEON_CRTC_V_SYNC_POL\r\n: 0));\r\nfp_horz_vert_active = 0;\r\nif (native_mode->hdisplay == 0 ||\r\nnative_mode->vdisplay == 0) {\r\nhscale = false;\r\nvscale = false;\r\n} else {\r\nif (xres > native_mode->hdisplay)\r\nxres = native_mode->hdisplay;\r\nif (yres > native_mode->vdisplay)\r\nyres = native_mode->vdisplay;\r\nif (xres == native_mode->hdisplay)\r\nhscale = false;\r\nif (yres == native_mode->vdisplay)\r\nvscale = false;\r\n}\r\nswitch (radeon_crtc->rmx_type) {\r\ncase RMX_FULL:\r\ncase RMX_ASPECT:\r\nif (!hscale)\r\nfp_horz_stretch |= ((xres/8-1) << 16);\r\nelse {\r\ninc = (fp_horz_stretch & RADEON_HORZ_AUTO_RATIO_INC) ? 1 : 0;\r\nscale = ((xres + inc) * RADEON_HORZ_STRETCH_RATIO_MAX)\r\n/ native_mode->hdisplay + 1;\r\nfp_horz_stretch |= (((scale) & RADEON_HORZ_STRETCH_RATIO_MASK) |\r\nRADEON_HORZ_STRETCH_BLEND |\r\nRADEON_HORZ_STRETCH_ENABLE |\r\n((native_mode->hdisplay/8-1) << 16));\r\n}\r\nif (!vscale)\r\nfp_vert_stretch |= ((yres-1) << 12);\r\nelse {\r\ninc = (fp_vert_stretch & RADEON_VERT_AUTO_RATIO_INC) ? 1 : 0;\r\nscale = ((yres + inc) * RADEON_VERT_STRETCH_RATIO_MAX)\r\n/ native_mode->vdisplay + 1;\r\nfp_vert_stretch |= (((scale) & RADEON_VERT_STRETCH_RATIO_MASK) |\r\nRADEON_VERT_STRETCH_ENABLE |\r\nRADEON_VERT_STRETCH_BLEND |\r\n((native_mode->vdisplay-1) << 12));\r\n}\r\nbreak;\r\ncase RMX_CENTER:\r\nfp_horz_stretch |= ((xres/8-1) << 16);\r\nfp_vert_stretch |= ((yres-1) << 12);\r\ncrtc_more_cntl |= (RADEON_CRTC_AUTO_HORZ_CENTER_EN |\r\nRADEON_CRTC_AUTO_VERT_CENTER_EN);\r\nblank_width = (mode->crtc_hblank_end - mode->crtc_hblank_start) / 8;\r\nif (blank_width > 110)\r\nblank_width = 110;\r\nfp_crtc_h_total_disp = (((blank_width) & 0x3ff)\r\n| ((((mode->crtc_hdisplay / 8) - 1) & 0x1ff) << 16));\r\nhsync_wid = (mode->crtc_hsync_end - mode->crtc_hsync_start) / 8;\r\nif (!hsync_wid)\r\nhsync_wid = 1;\r\nfp_h_sync_strt_wid = ((((mode->crtc_hsync_start - mode->crtc_hblank_start) / 8) & 0x1fff)\r\n| ((hsync_wid & 0x3f) << 16)\r\n| ((mode->flags & DRM_MODE_FLAG_NHSYNC)\r\n? RADEON_CRTC_H_SYNC_POL\r\n: 0));\r\nfp_crtc_v_total_disp = (((mode->crtc_vblank_end - mode->crtc_vblank_start) & 0xffff)\r\n| ((mode->crtc_vdisplay - 1) << 16));\r\nvsync_wid = mode->crtc_vsync_end - mode->crtc_vsync_start;\r\nif (!vsync_wid)\r\nvsync_wid = 1;\r\nfp_v_sync_strt_wid = ((((mode->crtc_vsync_start - mode->crtc_vblank_start) & 0xfff)\r\n| ((vsync_wid & 0x1f) << 16)\r\n| ((mode->flags & DRM_MODE_FLAG_NVSYNC)\r\n? RADEON_CRTC_V_SYNC_POL\r\n: 0)));\r\nfp_horz_vert_active = (((native_mode->vdisplay) & 0xfff) |\r\n(((native_mode->hdisplay / 8) & 0x1ff) << 16));\r\nbreak;\r\ncase RMX_OFF:\r\ndefault:\r\nfp_horz_stretch |= ((xres/8-1) << 16);\r\nfp_vert_stretch |= ((yres-1) << 12);\r\nbreak;\r\n}\r\nWREG32(RADEON_FP_HORZ_STRETCH, fp_horz_stretch);\r\nWREG32(RADEON_FP_VERT_STRETCH, fp_vert_stretch);\r\nWREG32(RADEON_CRTC_MORE_CNTL, crtc_more_cntl);\r\nWREG32(RADEON_FP_HORZ_VERT_ACTIVE, fp_horz_vert_active);\r\nWREG32(RADEON_FP_H_SYNC_STRT_WID, fp_h_sync_strt_wid);\r\nWREG32(RADEON_FP_V_SYNC_STRT_WID, fp_v_sync_strt_wid);\r\nWREG32(RADEON_FP_CRTC_H_TOTAL_DISP, fp_crtc_h_total_disp);\r\nWREG32(RADEON_FP_CRTC_V_TOTAL_DISP, fp_crtc_v_total_disp);\r\n}\r\nstatic void radeon_pll_wait_for_read_update_complete(struct drm_device *dev)\r\n{\r\nstruct radeon_device *rdev = dev->dev_private;\r\nint i = 0;\r\nfor (i = 0;\r\n(i < 10000 &&\r\nRREG32_PLL(RADEON_PPLL_REF_DIV) & RADEON_PPLL_ATOMIC_UPDATE_R);\r\ni++);\r\n}\r\nstatic void radeon_pll_write_update(struct drm_device *dev)\r\n{\r\nstruct radeon_device *rdev = dev->dev_private;\r\nwhile (RREG32_PLL(RADEON_PPLL_REF_DIV) & RADEON_PPLL_ATOMIC_UPDATE_R);\r\nWREG32_PLL_P(RADEON_PPLL_REF_DIV,\r\nRADEON_PPLL_ATOMIC_UPDATE_W,\r\n~(RADEON_PPLL_ATOMIC_UPDATE_W));\r\n}\r\nstatic void radeon_pll2_wait_for_read_update_complete(struct drm_device *dev)\r\n{\r\nstruct radeon_device *rdev = dev->dev_private;\r\nint i = 0;\r\nfor (i = 0;\r\n(i < 10000 &&\r\nRREG32_PLL(RADEON_P2PLL_REF_DIV) & RADEON_P2PLL_ATOMIC_UPDATE_R);\r\ni++);\r\n}\r\nstatic void radeon_pll2_write_update(struct drm_device *dev)\r\n{\r\nstruct radeon_device *rdev = dev->dev_private;\r\nwhile (RREG32_PLL(RADEON_P2PLL_REF_DIV) & RADEON_P2PLL_ATOMIC_UPDATE_R);\r\nWREG32_PLL_P(RADEON_P2PLL_REF_DIV,\r\nRADEON_P2PLL_ATOMIC_UPDATE_W,\r\n~(RADEON_P2PLL_ATOMIC_UPDATE_W));\r\n}\r\nstatic uint8_t radeon_compute_pll_gain(uint16_t ref_freq, uint16_t ref_div,\r\nuint16_t fb_div)\r\n{\r\nunsigned int vcoFreq;\r\nif (!ref_div)\r\nreturn 1;\r\nvcoFreq = ((unsigned)ref_freq * fb_div) / ref_div;\r\nif (vcoFreq >= 30000)\r\nreturn 7;\r\nelse if (vcoFreq >= 18000)\r\nreturn 4;\r\nelse\r\nreturn 1;\r\n}\r\nstatic void radeon_crtc_dpms(struct drm_crtc *crtc, int mode)\r\n{\r\nstruct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);\r\nstruct drm_device *dev = crtc->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nuint32_t crtc_ext_cntl = 0;\r\nuint32_t mask;\r\nif (radeon_crtc->crtc_id)\r\nmask = (RADEON_CRTC2_DISP_DIS |\r\nRADEON_CRTC2_VSYNC_DIS |\r\nRADEON_CRTC2_HSYNC_DIS |\r\nRADEON_CRTC2_DISP_REQ_EN_B);\r\nelse\r\nmask = (RADEON_CRTC_DISPLAY_DIS |\r\nRADEON_CRTC_VSYNC_DIS |\r\nRADEON_CRTC_HSYNC_DIS);\r\nif (rdev->flags & RADEON_SINGLE_CRTC)\r\ncrtc_ext_cntl = RADEON_CRTC_CRT_ON;\r\nswitch (mode) {\r\ncase DRM_MODE_DPMS_ON:\r\nradeon_crtc->enabled = true;\r\nradeon_pm_compute_clocks(rdev);\r\nif (radeon_crtc->crtc_id)\r\nWREG32_P(RADEON_CRTC2_GEN_CNTL, RADEON_CRTC2_EN, ~(RADEON_CRTC2_EN | mask));\r\nelse {\r\nWREG32_P(RADEON_CRTC_GEN_CNTL, RADEON_CRTC_EN, ~(RADEON_CRTC_EN |\r\nRADEON_CRTC_DISP_REQ_EN_B));\r\nWREG32_P(RADEON_CRTC_EXT_CNTL, crtc_ext_cntl, ~(mask | crtc_ext_cntl));\r\n}\r\ndrm_vblank_post_modeset(dev, radeon_crtc->crtc_id);\r\nradeon_crtc_load_lut(crtc);\r\nbreak;\r\ncase DRM_MODE_DPMS_STANDBY:\r\ncase DRM_MODE_DPMS_SUSPEND:\r\ncase DRM_MODE_DPMS_OFF:\r\ndrm_vblank_pre_modeset(dev, radeon_crtc->crtc_id);\r\nif (radeon_crtc->crtc_id)\r\nWREG32_P(RADEON_CRTC2_GEN_CNTL, mask, ~(RADEON_CRTC2_EN | mask));\r\nelse {\r\nWREG32_P(RADEON_CRTC_GEN_CNTL, RADEON_CRTC_DISP_REQ_EN_B, ~(RADEON_CRTC_EN |\r\nRADEON_CRTC_DISP_REQ_EN_B));\r\nWREG32_P(RADEON_CRTC_EXT_CNTL, mask, ~(mask | crtc_ext_cntl));\r\n}\r\nradeon_crtc->enabled = false;\r\nradeon_pm_compute_clocks(rdev);\r\nbreak;\r\n}\r\n}\r\nint radeon_crtc_set_base(struct drm_crtc *crtc, int x, int y,\r\nstruct drm_framebuffer *old_fb)\r\n{\r\nreturn radeon_crtc_do_set_base(crtc, old_fb, x, y, 0);\r\n}\r\nint radeon_crtc_set_base_atomic(struct drm_crtc *crtc,\r\nstruct drm_framebuffer *fb,\r\nint x, int y, enum mode_set_atomic state)\r\n{\r\nreturn radeon_crtc_do_set_base(crtc, fb, x, y, 1);\r\n}\r\nint radeon_crtc_do_set_base(struct drm_crtc *crtc,\r\nstruct drm_framebuffer *fb,\r\nint x, int y, int atomic)\r\n{\r\nstruct drm_device *dev = crtc->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);\r\nstruct radeon_framebuffer *radeon_fb;\r\nstruct drm_framebuffer *target_fb;\r\nstruct drm_gem_object *obj;\r\nstruct radeon_bo *rbo;\r\nuint64_t base;\r\nuint32_t crtc_offset, crtc_offset_cntl, crtc_tile_x0_y0 = 0;\r\nuint32_t crtc_pitch, pitch_pixels;\r\nuint32_t tiling_flags;\r\nint format;\r\nuint32_t gen_cntl_reg, gen_cntl_val;\r\nint r;\r\nDRM_DEBUG_KMS("\n");\r\nif (!atomic && !crtc->fb) {\r\nDRM_DEBUG_KMS("No FB bound\n");\r\nreturn 0;\r\n}\r\nif (atomic) {\r\nradeon_fb = to_radeon_framebuffer(fb);\r\ntarget_fb = fb;\r\n}\r\nelse {\r\nradeon_fb = to_radeon_framebuffer(crtc->fb);\r\ntarget_fb = crtc->fb;\r\n}\r\nswitch (target_fb->bits_per_pixel) {\r\ncase 8:\r\nformat = 2;\r\nbreak;\r\ncase 15:\r\nformat = 3;\r\nbreak;\r\ncase 16:\r\nformat = 4;\r\nbreak;\r\ncase 24:\r\nformat = 5;\r\nbreak;\r\ncase 32:\r\nformat = 6;\r\nbreak;\r\ndefault:\r\nreturn false;\r\n}\r\nobj = radeon_fb->obj;\r\nrbo = gem_to_radeon_bo(obj);\r\nretry:\r\nr = radeon_bo_reserve(rbo, false);\r\nif (unlikely(r != 0))\r\nreturn r;\r\nr = radeon_bo_pin_restricted(rbo, RADEON_GEM_DOMAIN_VRAM, 1 << 27,\r\n&base);\r\nif (unlikely(r != 0)) {\r\nradeon_bo_unreserve(rbo);\r\nif (!atomic && fb && fb != crtc->fb) {\r\nstruct radeon_bo *old_rbo;\r\nunsigned long nsize, osize;\r\nold_rbo = gem_to_radeon_bo(to_radeon_framebuffer(fb)->obj);\r\nosize = radeon_bo_size(old_rbo);\r\nnsize = radeon_bo_size(rbo);\r\nif (nsize <= osize && !radeon_bo_reserve(old_rbo, false)) {\r\nradeon_bo_unpin(old_rbo);\r\nradeon_bo_unreserve(old_rbo);\r\nfb = NULL;\r\ngoto retry;\r\n}\r\n}\r\nreturn -EINVAL;\r\n}\r\nradeon_bo_get_tiling_flags(rbo, &tiling_flags, NULL);\r\nradeon_bo_unreserve(rbo);\r\nif (tiling_flags & RADEON_TILING_MICRO)\r\nDRM_ERROR("trying to scanout microtiled buffer\n");\r\nradeon_crtc->legacy_display_base_addr = rdev->mc.vram_start;\r\nbase -= radeon_crtc->legacy_display_base_addr;\r\ncrtc_offset_cntl = 0;\r\npitch_pixels = target_fb->pitches[0] / (target_fb->bits_per_pixel / 8);\r\ncrtc_pitch = (((pitch_pixels * target_fb->bits_per_pixel) +\r\n((target_fb->bits_per_pixel * 8) - 1)) /\r\n(target_fb->bits_per_pixel * 8));\r\ncrtc_pitch |= crtc_pitch << 16;\r\ncrtc_offset_cntl |= RADEON_CRTC_GUI_TRIG_OFFSET_LEFT_EN;\r\nif (tiling_flags & RADEON_TILING_MACRO) {\r\nif (ASIC_IS_R300(rdev))\r\ncrtc_offset_cntl |= (R300_CRTC_X_Y_MODE_EN |\r\nR300_CRTC_MICRO_TILE_BUFFER_DIS |\r\nR300_CRTC_MACRO_TILE_EN);\r\nelse\r\ncrtc_offset_cntl |= RADEON_CRTC_TILE_EN;\r\n} else {\r\nif (ASIC_IS_R300(rdev))\r\ncrtc_offset_cntl &= ~(R300_CRTC_X_Y_MODE_EN |\r\nR300_CRTC_MICRO_TILE_BUFFER_DIS |\r\nR300_CRTC_MACRO_TILE_EN);\r\nelse\r\ncrtc_offset_cntl &= ~RADEON_CRTC_TILE_EN;\r\n}\r\nif (tiling_flags & RADEON_TILING_MACRO) {\r\nif (ASIC_IS_R300(rdev)) {\r\ncrtc_tile_x0_y0 = x | (y << 16);\r\nbase &= ~0x7ff;\r\n} else {\r\nint byteshift = target_fb->bits_per_pixel >> 4;\r\nint tile_addr = (((y >> 3) * pitch_pixels + x) >> (8 - byteshift)) << 11;\r\nbase += tile_addr + ((x << byteshift) % 256) + ((y % 8) << 8);\r\ncrtc_offset_cntl |= (y % 16);\r\n}\r\n} else {\r\nint offset = y * pitch_pixels + x;\r\nswitch (target_fb->bits_per_pixel) {\r\ncase 8:\r\noffset *= 1;\r\nbreak;\r\ncase 15:\r\ncase 16:\r\noffset *= 2;\r\nbreak;\r\ncase 24:\r\noffset *= 3;\r\nbreak;\r\ncase 32:\r\noffset *= 4;\r\nbreak;\r\ndefault:\r\nreturn false;\r\n}\r\nbase += offset;\r\n}\r\nbase &= ~7;\r\nif (radeon_crtc->crtc_id == 1)\r\ngen_cntl_reg = RADEON_CRTC2_GEN_CNTL;\r\nelse\r\ngen_cntl_reg = RADEON_CRTC_GEN_CNTL;\r\ngen_cntl_val = RREG32(gen_cntl_reg);\r\ngen_cntl_val &= ~(0xf << 8);\r\ngen_cntl_val |= (format << 8);\r\ngen_cntl_val &= ~RADEON_CRTC_VSTAT_MODE_MASK;\r\nWREG32(gen_cntl_reg, gen_cntl_val);\r\ncrtc_offset = (u32)base;\r\nWREG32(RADEON_DISPLAY_BASE_ADDR + radeon_crtc->crtc_offset, radeon_crtc->legacy_display_base_addr);\r\nif (ASIC_IS_R300(rdev)) {\r\nif (radeon_crtc->crtc_id)\r\nWREG32(R300_CRTC2_TILE_X0_Y0, crtc_tile_x0_y0);\r\nelse\r\nWREG32(R300_CRTC_TILE_X0_Y0, crtc_tile_x0_y0);\r\n}\r\nWREG32(RADEON_CRTC_OFFSET_CNTL + radeon_crtc->crtc_offset, crtc_offset_cntl);\r\nWREG32(RADEON_CRTC_OFFSET + radeon_crtc->crtc_offset, crtc_offset);\r\nWREG32(RADEON_CRTC_PITCH + radeon_crtc->crtc_offset, crtc_pitch);\r\nif (!atomic && fb && fb != crtc->fb) {\r\nradeon_fb = to_radeon_framebuffer(fb);\r\nrbo = gem_to_radeon_bo(radeon_fb->obj);\r\nr = radeon_bo_reserve(rbo, false);\r\nif (unlikely(r != 0))\r\nreturn r;\r\nradeon_bo_unpin(rbo);\r\nradeon_bo_unreserve(rbo);\r\n}\r\nradeon_bandwidth_update(rdev);\r\nreturn 0;\r\n}\r\nstatic bool radeon_set_crtc_timing(struct drm_crtc *crtc, struct drm_display_mode *mode)\r\n{\r\nstruct drm_device *dev = crtc->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);\r\nstruct drm_encoder *encoder;\r\nint format;\r\nint hsync_start;\r\nint hsync_wid;\r\nint vsync_wid;\r\nuint32_t crtc_h_total_disp;\r\nuint32_t crtc_h_sync_strt_wid;\r\nuint32_t crtc_v_total_disp;\r\nuint32_t crtc_v_sync_strt_wid;\r\nbool is_tv = false;\r\nDRM_DEBUG_KMS("\n");\r\nlist_for_each_entry(encoder, &dev->mode_config.encoder_list, head) {\r\nif (encoder->crtc == crtc) {\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nif (radeon_encoder->active_device & ATOM_DEVICE_TV_SUPPORT) {\r\nis_tv = true;\r\nDRM_INFO("crtc %d is connected to a TV\n", radeon_crtc->crtc_id);\r\nbreak;\r\n}\r\n}\r\n}\r\nswitch (crtc->fb->bits_per_pixel) {\r\ncase 8:\r\nformat = 2;\r\nbreak;\r\ncase 15:\r\nformat = 3;\r\nbreak;\r\ncase 16:\r\nformat = 4;\r\nbreak;\r\ncase 24:\r\nformat = 5;\r\nbreak;\r\ncase 32:\r\nformat = 6;\r\nbreak;\r\ndefault:\r\nreturn false;\r\n}\r\ncrtc_h_total_disp = ((((mode->crtc_htotal / 8) - 1) & 0x3ff)\r\n| ((((mode->crtc_hdisplay / 8) - 1) & 0x1ff) << 16));\r\nhsync_wid = (mode->crtc_hsync_end - mode->crtc_hsync_start) / 8;\r\nif (!hsync_wid)\r\nhsync_wid = 1;\r\nhsync_start = mode->crtc_hsync_start - 8;\r\ncrtc_h_sync_strt_wid = ((hsync_start & 0x1fff)\r\n| ((hsync_wid & 0x3f) << 16)\r\n| ((mode->flags & DRM_MODE_FLAG_NHSYNC)\r\n? RADEON_CRTC_H_SYNC_POL\r\n: 0));\r\ncrtc_v_total_disp = (((mode->crtc_vtotal - 1) & 0xffff)\r\n| ((mode->crtc_vdisplay - 1) << 16));\r\nvsync_wid = mode->crtc_vsync_end - mode->crtc_vsync_start;\r\nif (!vsync_wid)\r\nvsync_wid = 1;\r\ncrtc_v_sync_strt_wid = (((mode->crtc_vsync_start - 1) & 0xfff)\r\n| ((vsync_wid & 0x1f) << 16)\r\n| ((mode->flags & DRM_MODE_FLAG_NVSYNC)\r\n? RADEON_CRTC_V_SYNC_POL\r\n: 0));\r\nif (radeon_crtc->crtc_id) {\r\nuint32_t crtc2_gen_cntl;\r\nuint32_t disp2_merge_cntl;\r\ncrtc2_gen_cntl = RREG32(RADEON_CRTC2_GEN_CNTL) & 0x00718080;\r\ncrtc2_gen_cntl |= ((format << 8)\r\n| RADEON_CRTC2_VSYNC_DIS\r\n| RADEON_CRTC2_HSYNC_DIS\r\n| RADEON_CRTC2_DISP_DIS\r\n| RADEON_CRTC2_DISP_REQ_EN_B\r\n| ((mode->flags & DRM_MODE_FLAG_DBLSCAN)\r\n? RADEON_CRTC2_DBL_SCAN_EN\r\n: 0)\r\n| ((mode->flags & DRM_MODE_FLAG_CSYNC)\r\n? RADEON_CRTC2_CSYNC_EN\r\n: 0)\r\n| ((mode->flags & DRM_MODE_FLAG_INTERLACE)\r\n? RADEON_CRTC2_INTERLACE_EN\r\n: 0));\r\nif ((rdev->family == CHIP_RS400) || (rdev->family == CHIP_RS480))\r\ncrtc2_gen_cntl |= RADEON_CRTC2_EN;\r\ndisp2_merge_cntl = RREG32(RADEON_DISP2_MERGE_CNTL);\r\ndisp2_merge_cntl &= ~RADEON_DISP2_RGB_OFFSET_EN;\r\nWREG32(RADEON_DISP2_MERGE_CNTL, disp2_merge_cntl);\r\nWREG32(RADEON_CRTC2_GEN_CNTL, crtc2_gen_cntl);\r\nWREG32(RADEON_FP_H2_SYNC_STRT_WID, crtc_h_sync_strt_wid);\r\nWREG32(RADEON_FP_V2_SYNC_STRT_WID, crtc_v_sync_strt_wid);\r\n} else {\r\nuint32_t crtc_gen_cntl;\r\nuint32_t crtc_ext_cntl;\r\nuint32_t disp_merge_cntl;\r\ncrtc_gen_cntl = RREG32(RADEON_CRTC_GEN_CNTL) & 0x00718000;\r\ncrtc_gen_cntl |= (RADEON_CRTC_EXT_DISP_EN\r\n| (format << 8)\r\n| RADEON_CRTC_DISP_REQ_EN_B\r\n| ((mode->flags & DRM_MODE_FLAG_DBLSCAN)\r\n? RADEON_CRTC_DBL_SCAN_EN\r\n: 0)\r\n| ((mode->flags & DRM_MODE_FLAG_CSYNC)\r\n? RADEON_CRTC_CSYNC_EN\r\n: 0)\r\n| ((mode->flags & DRM_MODE_FLAG_INTERLACE)\r\n? RADEON_CRTC_INTERLACE_EN\r\n: 0));\r\nif ((rdev->family == CHIP_RS400) || (rdev->family == CHIP_RS480))\r\ncrtc_gen_cntl |= RADEON_CRTC_EN;\r\ncrtc_ext_cntl = RREG32(RADEON_CRTC_EXT_CNTL);\r\ncrtc_ext_cntl |= (RADEON_XCRT_CNT_EN |\r\nRADEON_CRTC_VSYNC_DIS |\r\nRADEON_CRTC_HSYNC_DIS |\r\nRADEON_CRTC_DISPLAY_DIS);\r\ndisp_merge_cntl = RREG32(RADEON_DISP_MERGE_CNTL);\r\ndisp_merge_cntl &= ~RADEON_DISP_RGB_OFFSET_EN;\r\nWREG32(RADEON_DISP_MERGE_CNTL, disp_merge_cntl);\r\nWREG32(RADEON_CRTC_GEN_CNTL, crtc_gen_cntl);\r\nWREG32(RADEON_CRTC_EXT_CNTL, crtc_ext_cntl);\r\n}\r\nif (is_tv)\r\nradeon_legacy_tv_adjust_crtc_reg(encoder, &crtc_h_total_disp,\r\n&crtc_h_sync_strt_wid, &crtc_v_total_disp,\r\n&crtc_v_sync_strt_wid);\r\nWREG32(RADEON_CRTC_H_TOTAL_DISP + radeon_crtc->crtc_offset, crtc_h_total_disp);\r\nWREG32(RADEON_CRTC_H_SYNC_STRT_WID + radeon_crtc->crtc_offset, crtc_h_sync_strt_wid);\r\nWREG32(RADEON_CRTC_V_TOTAL_DISP + radeon_crtc->crtc_offset, crtc_v_total_disp);\r\nWREG32(RADEON_CRTC_V_SYNC_STRT_WID + radeon_crtc->crtc_offset, crtc_v_sync_strt_wid);\r\nreturn true;\r\n}\r\nstatic void radeon_set_pll(struct drm_crtc *crtc, struct drm_display_mode *mode)\r\n{\r\nstruct drm_device *dev = crtc->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);\r\nstruct drm_encoder *encoder;\r\nuint32_t feedback_div = 0;\r\nuint32_t frac_fb_div = 0;\r\nuint32_t reference_div = 0;\r\nuint32_t post_divider = 0;\r\nuint32_t freq = 0;\r\nuint8_t pll_gain;\r\nbool use_bios_divs = false;\r\nuint32_t pll_ref_div = 0;\r\nuint32_t pll_fb_post_div = 0;\r\nuint32_t htotal_cntl = 0;\r\nbool is_tv = false;\r\nstruct radeon_pll *pll;\r\nstruct {\r\nint divider;\r\nint bitvalue;\r\n} *post_div, post_divs[] = {\r\n{ 1, 0 },\r\n{ 2, 1 },\r\n{ 4, 2 },\r\n{ 8, 3 },\r\n{ 3, 4 },\r\n{ 16, 5 },\r\n{ 6, 6 },\r\n{ 12, 7 },\r\n{ 0, 0 }\r\n};\r\nif (radeon_crtc->crtc_id)\r\npll = &rdev->clock.p2pll;\r\nelse\r\npll = &rdev->clock.p1pll;\r\npll->flags = RADEON_PLL_LEGACY;\r\nif (mode->clock > 200000)\r\npll->flags |= RADEON_PLL_PREFER_HIGH_FB_DIV;\r\nelse\r\npll->flags |= RADEON_PLL_PREFER_LOW_REF_DIV;\r\nlist_for_each_entry(encoder, &dev->mode_config.encoder_list, head) {\r\nif (encoder->crtc == crtc) {\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nif (radeon_encoder->active_device & ATOM_DEVICE_TV_SUPPORT) {\r\nis_tv = true;\r\nbreak;\r\n}\r\nif (encoder->encoder_type != DRM_MODE_ENCODER_DAC)\r\npll->flags |= RADEON_PLL_NO_ODD_POST_DIV;\r\nif (encoder->encoder_type == DRM_MODE_ENCODER_LVDS) {\r\nif (!rdev->is_atom_bios) {\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct radeon_encoder_lvds *lvds = (struct radeon_encoder_lvds *)radeon_encoder->enc_priv;\r\nif (lvds) {\r\nif (lvds->use_bios_dividers) {\r\npll_ref_div = lvds->panel_ref_divider;\r\npll_fb_post_div = (lvds->panel_fb_divider |\r\n(lvds->panel_post_divider << 16));\r\nhtotal_cntl = 0;\r\nuse_bios_divs = true;\r\n}\r\n}\r\n}\r\npll->flags |= RADEON_PLL_USE_REF_DIV;\r\n}\r\n}\r\n}\r\nDRM_DEBUG_KMS("\n");\r\nif (!use_bios_divs) {\r\nradeon_compute_pll_legacy(pll, mode->clock,\r\n&freq, &feedback_div, &frac_fb_div,\r\n&reference_div, &post_divider);\r\nfor (post_div = &post_divs[0]; post_div->divider; ++post_div) {\r\nif (post_div->divider == post_divider)\r\nbreak;\r\n}\r\nif (!post_div->divider)\r\npost_div = &post_divs[0];\r\nDRM_DEBUG_KMS("dc=%u, fd=%d, rd=%d, pd=%d\n",\r\n(unsigned)freq,\r\nfeedback_div,\r\nreference_div,\r\npost_divider);\r\npll_ref_div = reference_div;\r\n#if defined(__powerpc__) && (0)\r\nif (info->MacModel == RADEON_MAC_IBOOK)\r\npll_fb_post_div = 0x000600ad;\r\nelse\r\n#endif\r\npll_fb_post_div = (feedback_div | (post_div->bitvalue << 16));\r\nhtotal_cntl = mode->htotal & 0x7;\r\n}\r\npll_gain = radeon_compute_pll_gain(pll->reference_freq,\r\npll_ref_div & 0x3ff,\r\npll_fb_post_div & 0x7ff);\r\nif (radeon_crtc->crtc_id) {\r\nuint32_t pixclks_cntl = ((RREG32_PLL(RADEON_PIXCLKS_CNTL) &\r\n~(RADEON_PIX2CLK_SRC_SEL_MASK)) |\r\nRADEON_PIX2CLK_SRC_SEL_P2PLLCLK);\r\nif (is_tv) {\r\nradeon_legacy_tv_adjust_pll2(encoder, &htotal_cntl,\r\n&pll_ref_div, &pll_fb_post_div,\r\n&pixclks_cntl);\r\n}\r\nWREG32_PLL_P(RADEON_PIXCLKS_CNTL,\r\nRADEON_PIX2CLK_SRC_SEL_CPUCLK,\r\n~(RADEON_PIX2CLK_SRC_SEL_MASK));\r\nWREG32_PLL_P(RADEON_P2PLL_CNTL,\r\nRADEON_P2PLL_RESET\r\n| RADEON_P2PLL_ATOMIC_UPDATE_EN\r\n| ((uint32_t)pll_gain << RADEON_P2PLL_PVG_SHIFT),\r\n~(RADEON_P2PLL_RESET\r\n| RADEON_P2PLL_ATOMIC_UPDATE_EN\r\n| RADEON_P2PLL_PVG_MASK));\r\nWREG32_PLL_P(RADEON_P2PLL_REF_DIV,\r\npll_ref_div,\r\n~RADEON_P2PLL_REF_DIV_MASK);\r\nWREG32_PLL_P(RADEON_P2PLL_DIV_0,\r\npll_fb_post_div,\r\n~RADEON_P2PLL_FB0_DIV_MASK);\r\nWREG32_PLL_P(RADEON_P2PLL_DIV_0,\r\npll_fb_post_div,\r\n~RADEON_P2PLL_POST0_DIV_MASK);\r\nradeon_pll2_write_update(dev);\r\nradeon_pll2_wait_for_read_update_complete(dev);\r\nWREG32_PLL(RADEON_HTOTAL2_CNTL, htotal_cntl);\r\nWREG32_PLL_P(RADEON_P2PLL_CNTL,\r\n0,\r\n~(RADEON_P2PLL_RESET\r\n| RADEON_P2PLL_SLEEP\r\n| RADEON_P2PLL_ATOMIC_UPDATE_EN));\r\nDRM_DEBUG_KMS("Wrote2: 0x%08x 0x%08x 0x%08x (0x%08x)\n",\r\n(unsigned)pll_ref_div,\r\n(unsigned)pll_fb_post_div,\r\n(unsigned)htotal_cntl,\r\nRREG32_PLL(RADEON_P2PLL_CNTL));\r\nDRM_DEBUG_KMS("Wrote2: rd=%u, fd=%u, pd=%u\n",\r\n(unsigned)pll_ref_div & RADEON_P2PLL_REF_DIV_MASK,\r\n(unsigned)pll_fb_post_div & RADEON_P2PLL_FB0_DIV_MASK,\r\n(unsigned)((pll_fb_post_div &\r\nRADEON_P2PLL_POST0_DIV_MASK) >> 16));\r\nmdelay(50);\r\nWREG32_PLL_P(RADEON_PIXCLKS_CNTL,\r\nRADEON_PIX2CLK_SRC_SEL_P2PLLCLK,\r\n~(RADEON_PIX2CLK_SRC_SEL_MASK));\r\nWREG32_PLL(RADEON_PIXCLKS_CNTL, pixclks_cntl);\r\n} else {\r\nuint32_t pixclks_cntl;\r\nif (is_tv) {\r\npixclks_cntl = RREG32_PLL(RADEON_PIXCLKS_CNTL);\r\nradeon_legacy_tv_adjust_pll1(encoder, &htotal_cntl, &pll_ref_div,\r\n&pll_fb_post_div, &pixclks_cntl);\r\n}\r\nif (rdev->flags & RADEON_IS_MOBILITY) {\r\nif ((pll_ref_div == (RREG32_PLL(RADEON_PPLL_REF_DIV) & RADEON_PPLL_REF_DIV_MASK)) &&\r\n(pll_fb_post_div == (RREG32_PLL(RADEON_PPLL_DIV_3) &\r\n(RADEON_PPLL_POST3_DIV_MASK | RADEON_PPLL_FB3_DIV_MASK)))) {\r\nWREG32_P(RADEON_CLOCK_CNTL_INDEX,\r\nRADEON_PLL_DIV_SEL,\r\n~(RADEON_PLL_DIV_SEL));\r\nr100_pll_errata_after_index(rdev);\r\nreturn;\r\n}\r\n}\r\nWREG32_PLL_P(RADEON_VCLK_ECP_CNTL,\r\nRADEON_VCLK_SRC_SEL_CPUCLK,\r\n~(RADEON_VCLK_SRC_SEL_MASK));\r\nWREG32_PLL_P(RADEON_PPLL_CNTL,\r\nRADEON_PPLL_RESET\r\n| RADEON_PPLL_ATOMIC_UPDATE_EN\r\n| RADEON_PPLL_VGA_ATOMIC_UPDATE_EN\r\n| ((uint32_t)pll_gain << RADEON_PPLL_PVG_SHIFT),\r\n~(RADEON_PPLL_RESET\r\n| RADEON_PPLL_ATOMIC_UPDATE_EN\r\n| RADEON_PPLL_VGA_ATOMIC_UPDATE_EN\r\n| RADEON_PPLL_PVG_MASK));\r\nWREG32_P(RADEON_CLOCK_CNTL_INDEX,\r\nRADEON_PLL_DIV_SEL,\r\n~(RADEON_PLL_DIV_SEL));\r\nr100_pll_errata_after_index(rdev);\r\nif (ASIC_IS_R300(rdev) ||\r\n(rdev->family == CHIP_RS300) ||\r\n(rdev->family == CHIP_RS400) ||\r\n(rdev->family == CHIP_RS480)) {\r\nif (pll_ref_div & R300_PPLL_REF_DIV_ACC_MASK) {\r\nWREG32_PLL_P(RADEON_PPLL_REF_DIV,\r\npll_ref_div,\r\n0);\r\n} else {\r\nWREG32_PLL_P(RADEON_PPLL_REF_DIV,\r\n(pll_ref_div << R300_PPLL_REF_DIV_ACC_SHIFT),\r\n~R300_PPLL_REF_DIV_ACC_MASK);\r\n}\r\n} else\r\nWREG32_PLL_P(RADEON_PPLL_REF_DIV,\r\npll_ref_div,\r\n~RADEON_PPLL_REF_DIV_MASK);\r\nWREG32_PLL_P(RADEON_PPLL_DIV_3,\r\npll_fb_post_div,\r\n~RADEON_PPLL_FB3_DIV_MASK);\r\nWREG32_PLL_P(RADEON_PPLL_DIV_3,\r\npll_fb_post_div,\r\n~RADEON_PPLL_POST3_DIV_MASK);\r\nradeon_pll_write_update(dev);\r\nradeon_pll_wait_for_read_update_complete(dev);\r\nWREG32_PLL(RADEON_HTOTAL_CNTL, htotal_cntl);\r\nWREG32_PLL_P(RADEON_PPLL_CNTL,\r\n0,\r\n~(RADEON_PPLL_RESET\r\n| RADEON_PPLL_SLEEP\r\n| RADEON_PPLL_ATOMIC_UPDATE_EN\r\n| RADEON_PPLL_VGA_ATOMIC_UPDATE_EN));\r\nDRM_DEBUG_KMS("Wrote: 0x%08x 0x%08x 0x%08x (0x%08x)\n",\r\npll_ref_div,\r\npll_fb_post_div,\r\n(unsigned)htotal_cntl,\r\nRREG32_PLL(RADEON_PPLL_CNTL));\r\nDRM_DEBUG_KMS("Wrote: rd=%d, fd=%d, pd=%d\n",\r\npll_ref_div & RADEON_PPLL_REF_DIV_MASK,\r\npll_fb_post_div & RADEON_PPLL_FB3_DIV_MASK,\r\n(pll_fb_post_div & RADEON_PPLL_POST3_DIV_MASK) >> 16);\r\nmdelay(50);\r\nWREG32_PLL_P(RADEON_VCLK_ECP_CNTL,\r\nRADEON_VCLK_SRC_SEL_PPLLCLK,\r\n~(RADEON_VCLK_SRC_SEL_MASK));\r\nif (is_tv)\r\nWREG32_PLL(RADEON_PIXCLKS_CNTL, pixclks_cntl);\r\n}\r\n}\r\nstatic bool radeon_crtc_mode_fixup(struct drm_crtc *crtc,\r\nconst struct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nif (!radeon_crtc_scaling_mode_fixup(crtc, mode, adjusted_mode))\r\nreturn false;\r\nreturn true;\r\n}\r\nstatic int radeon_crtc_mode_set(struct drm_crtc *crtc,\r\nstruct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode,\r\nint x, int y, struct drm_framebuffer *old_fb)\r\n{\r\nstruct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);\r\nradeon_crtc_set_base(crtc, x, y, old_fb);\r\nradeon_set_crtc_timing(crtc, adjusted_mode);\r\nradeon_set_pll(crtc, adjusted_mode);\r\nradeon_overscan_setup(crtc, adjusted_mode);\r\nif (radeon_crtc->crtc_id == 0) {\r\nradeon_legacy_rmx_mode_set(crtc, adjusted_mode);\r\n} else {\r\nif (radeon_crtc->rmx_type != RMX_OFF) {\r\nDRM_ERROR("Mode need scaling but only first crtc can do that.\n");\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void radeon_crtc_prepare(struct drm_crtc *crtc)\r\n{\r\nstruct drm_device *dev = crtc->dev;\r\nstruct drm_crtc *crtci;\r\nlist_for_each_entry(crtci, &dev->mode_config.crtc_list, head)\r\nradeon_crtc_dpms(crtci, DRM_MODE_DPMS_OFF);\r\n}\r\nstatic void radeon_crtc_commit(struct drm_crtc *crtc)\r\n{\r\nstruct drm_device *dev = crtc->dev;\r\nstruct drm_crtc *crtci;\r\nlist_for_each_entry(crtci, &dev->mode_config.crtc_list, head) {\r\nif (crtci->enabled)\r\nradeon_crtc_dpms(crtci, DRM_MODE_DPMS_ON);\r\n}\r\n}\r\nstatic void radeon_crtc_disable(struct drm_crtc *crtc)\r\n{\r\nradeon_crtc_dpms(crtc, DRM_MODE_DPMS_OFF);\r\nif (crtc->fb) {\r\nint r;\r\nstruct radeon_framebuffer *radeon_fb;\r\nstruct radeon_bo *rbo;\r\nradeon_fb = to_radeon_framebuffer(crtc->fb);\r\nrbo = gem_to_radeon_bo(radeon_fb->obj);\r\nr = radeon_bo_reserve(rbo, false);\r\nif (unlikely(r))\r\nDRM_ERROR("failed to reserve rbo before unpin\n");\r\nelse {\r\nradeon_bo_unpin(rbo);\r\nradeon_bo_unreserve(rbo);\r\n}\r\n}\r\n}\r\nvoid radeon_legacy_init_crtc(struct drm_device *dev,\r\nstruct radeon_crtc *radeon_crtc)\r\n{\r\nif (radeon_crtc->crtc_id == 1)\r\nradeon_crtc->crtc_offset = RADEON_CRTC2_H_TOTAL_DISP - RADEON_CRTC_H_TOTAL_DISP;\r\ndrm_crtc_helper_add(&radeon_crtc->base, &legacy_helper_funcs);\r\n}

static inline long do_strnlen_user(const char __user *src, unsigned long count, unsigned long max)\r\n{\r\nconst struct word_at_a_time constants = WORD_AT_A_TIME_CONSTANTS;\r\nlong align, res = 0;\r\nunsigned long c;\r\nif (max > count)\r\nmax = count;\r\nalign = (sizeof(long) - 1) & (unsigned long)src;\r\nsrc -= align;\r\nmax += align;\r\nif (unlikely(__get_user(c,(unsigned long __user *)src)))\r\nreturn 0;\r\nc |= aligned_byte_mask(align);\r\nfor (;;) {\r\nunsigned long data;\r\nif (has_zero(c, &data, &constants)) {\r\ndata = prep_zero_mask(c, data, &constants);\r\ndata = create_zero_mask(data);\r\nreturn res + find_zero(data) + 1 - align;\r\n}\r\nres += sizeof(unsigned long);\r\nif (unlikely(max < sizeof(unsigned long)))\r\nbreak;\r\nmax -= sizeof(unsigned long);\r\nif (unlikely(__get_user(c,(unsigned long __user *)(src+res))))\r\nreturn 0;\r\n}\r\nres -= align;\r\nif (res >= count)\r\nreturn count+1;\r\nreturn 0;\r\n}\r\nlong strnlen_user(const char __user *str, long count)\r\n{\r\nunsigned long max_addr, src_addr;\r\nif (unlikely(count <= 0))\r\nreturn 0;\r\nmax_addr = user_addr_max();\r\nsrc_addr = (unsigned long)str;\r\nif (likely(src_addr < max_addr)) {\r\nunsigned long max = max_addr - src_addr;\r\nreturn do_strnlen_user(str, count, max);\r\n}\r\nreturn 0;\r\n}\r\nlong strlen_user(const char __user *str)\r\n{\r\nunsigned long max_addr, src_addr;\r\nmax_addr = user_addr_max();\r\nsrc_addr = (unsigned long)str;\r\nif (likely(src_addr < max_addr)) {\r\nunsigned long max = max_addr - src_addr;\r\nreturn do_strnlen_user(str, ~0ul, max);\r\n}\r\nreturn 0;\r\n}

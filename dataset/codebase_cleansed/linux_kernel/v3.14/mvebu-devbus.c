static int get_timing_param_ps(struct devbus *devbus,\r\nstruct device_node *node,\r\nconst char *name,\r\nu32 *ticks)\r\n{\r\nu32 time_ps;\r\nint err;\r\nerr = of_property_read_u32(node, name, &time_ps);\r\nif (err < 0) {\r\ndev_err(devbus->dev, "%s has no '%s' property\n",\r\nname, node->full_name);\r\nreturn err;\r\n}\r\n*ticks = (time_ps + devbus->tick_ps - 1) / devbus->tick_ps;\r\ndev_dbg(devbus->dev, "%s: %u ps -> 0x%x\n",\r\nname, time_ps, *ticks);\r\nreturn 0;\r\n}\r\nstatic int devbus_set_timing_params(struct devbus *devbus,\r\nstruct device_node *node)\r\n{\r\nstruct devbus_read_params r;\r\nstruct devbus_write_params w;\r\nu32 value;\r\nint err;\r\ndev_dbg(devbus->dev, "Setting timing parameter, tick is %lu ps\n",\r\ndevbus->tick_ps);\r\nerr = of_property_read_u32(node, "devbus,bus-width", &r.bus_width);\r\nif (err < 0) {\r\ndev_err(devbus->dev,\r\n"%s has no 'devbus,bus-width' property\n",\r\nnode->full_name);\r\nreturn err;\r\n}\r\nr.bus_width /= 8;\r\nerr = get_timing_param_ps(devbus, node, "devbus,badr-skew-ps",\r\n&r.badr_skew);\r\nif (err < 0)\r\nreturn err;\r\nerr = get_timing_param_ps(devbus, node, "devbus,turn-off-ps",\r\n&r.turn_off);\r\nif (err < 0)\r\nreturn err;\r\nerr = get_timing_param_ps(devbus, node, "devbus,acc-first-ps",\r\n&r.acc_first);\r\nif (err < 0)\r\nreturn err;\r\nerr = get_timing_param_ps(devbus, node, "devbus,acc-next-ps",\r\n&r.acc_next);\r\nif (err < 0)\r\nreturn err;\r\nerr = get_timing_param_ps(devbus, node, "devbus,rd-setup-ps",\r\n&r.rd_setup);\r\nif (err < 0)\r\nreturn err;\r\nerr = get_timing_param_ps(devbus, node, "devbus,rd-hold-ps",\r\n&r.rd_hold);\r\nif (err < 0)\r\nreturn err;\r\nerr = of_property_read_u32(node, "devbus,sync-enable",\r\n&w.sync_enable);\r\nif (err < 0) {\r\ndev_err(devbus->dev,\r\n"%s has no 'devbus,sync-enable' property\n",\r\nnode->full_name);\r\nreturn err;\r\n}\r\nerr = get_timing_param_ps(devbus, node, "devbus,ale-wr-ps",\r\n&w.ale_wr);\r\nif (err < 0)\r\nreturn err;\r\nerr = get_timing_param_ps(devbus, node, "devbus,wr-low-ps",\r\n&w.wr_low);\r\nif (err < 0)\r\nreturn err;\r\nerr = get_timing_param_ps(devbus, node, "devbus,wr-high-ps",\r\n&w.wr_high);\r\nif (err < 0)\r\nreturn err;\r\nvalue = r.bus_width << DEV_WIDTH_BIT |\r\nr.badr_skew << BADR_SKEW_BIT |\r\nr.rd_hold << RD_HOLD_BIT |\r\nr.acc_next << ACC_NEXT_BIT |\r\nr.rd_setup << RD_SETUP_BIT |\r\nr.acc_first << ACC_FIRST_BIT |\r\nr.turn_off;\r\ndev_dbg(devbus->dev, "read parameters register 0x%p = 0x%x\n",\r\ndevbus->base + READ_PARAM_OFFSET,\r\nvalue);\r\nwritel(value, devbus->base + READ_PARAM_OFFSET);\r\nvalue = w.sync_enable << SYNC_ENABLE_BIT |\r\nw.wr_low << WR_LOW_BIT |\r\nw.wr_high << WR_HIGH_BIT |\r\nw.ale_wr;\r\ndev_dbg(devbus->dev, "write parameters register: 0x%p = 0x%x\n",\r\ndevbus->base + WRITE_PARAM_OFFSET,\r\nvalue);\r\nwritel(value, devbus->base + WRITE_PARAM_OFFSET);\r\nreturn 0;\r\n}\r\nstatic int mvebu_devbus_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct device_node *node = pdev->dev.of_node;\r\nstruct devbus *devbus;\r\nstruct resource *res;\r\nstruct clk *clk;\r\nunsigned long rate;\r\nint err;\r\ndevbus = devm_kzalloc(&pdev->dev, sizeof(struct devbus), GFP_KERNEL);\r\nif (!devbus)\r\nreturn -ENOMEM;\r\ndevbus->dev = dev;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ndevbus->base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(devbus->base))\r\nreturn PTR_ERR(devbus->base);\r\nclk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(clk))\r\nreturn PTR_ERR(clk);\r\nclk_prepare_enable(clk);\r\nrate = clk_get_rate(clk) / 1000;\r\ndevbus->tick_ps = 1000000000 / rate;\r\nerr = devbus_set_timing_params(devbus, node);\r\nif (err < 0)\r\nreturn err;\r\nerr = of_platform_populate(node, NULL, NULL, dev);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int __init mvebu_devbus_init(void)\r\n{\r\nreturn platform_driver_register(&mvebu_devbus_driver);\r\n}

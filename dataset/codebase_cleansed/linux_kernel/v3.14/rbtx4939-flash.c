static int rbtx4939_flash_remove(struct platform_device *dev)\r\n{\r\nstruct rbtx4939_flash_info *info;\r\ninfo = platform_get_drvdata(dev);\r\nif (!info)\r\nreturn 0;\r\nif (info->mtd) {\r\nstruct rbtx4939_flash_data *pdata = dev_get_platdata(&dev->dev);\r\nmtd_device_unregister(info->mtd);\r\nmap_destroy(info->mtd);\r\n}\r\nreturn 0;\r\n}\r\nstatic int rbtx4939_flash_probe(struct platform_device *dev)\r\n{\r\nstruct rbtx4939_flash_data *pdata;\r\nstruct rbtx4939_flash_info *info;\r\nstruct resource *res;\r\nconst char * const *probe_type;\r\nint err = 0;\r\nunsigned long size;\r\npdata = dev_get_platdata(&dev->dev);\r\nif (!pdata)\r\nreturn -ENODEV;\r\nres = platform_get_resource(dev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENODEV;\r\ninfo = devm_kzalloc(&dev->dev, sizeof(struct rbtx4939_flash_info),\r\nGFP_KERNEL);\r\nif (!info)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(dev, info);\r\nsize = resource_size(res);\r\npr_notice("rbtx4939 platform flash device: %pR\n", res);\r\nif (!devm_request_mem_region(&dev->dev, res->start, size,\r\ndev_name(&dev->dev)))\r\nreturn -EBUSY;\r\ninfo->map.name = dev_name(&dev->dev);\r\ninfo->map.phys = res->start;\r\ninfo->map.size = size;\r\ninfo->map.bankwidth = pdata->width;\r\ninfo->map.virt = devm_ioremap(&dev->dev, info->map.phys, size);\r\nif (!info->map.virt)\r\nreturn -EBUSY;\r\nif (pdata->map_init)\r\n(*pdata->map_init)(&info->map);\r\nelse\r\nsimple_map_init(&info->map);\r\nprobe_type = rom_probe_types;\r\nfor (; !info->mtd && *probe_type; probe_type++)\r\ninfo->mtd = do_map_probe(*probe_type, &info->map);\r\nif (!info->mtd) {\r\ndev_err(&dev->dev, "map_probe failed\n");\r\nerr = -ENXIO;\r\ngoto err_out;\r\n}\r\ninfo->mtd->owner = THIS_MODULE;\r\nerr = mtd_device_parse_register(info->mtd, NULL, NULL, pdata->parts,\r\npdata->nr_parts);\r\nif (err)\r\ngoto err_out;\r\nreturn 0;\r\nerr_out:\r\nrbtx4939_flash_remove(dev);\r\nreturn err;\r\n}\r\nstatic void rbtx4939_flash_shutdown(struct platform_device *dev)\r\n{\r\nstruct rbtx4939_flash_info *info = platform_get_drvdata(dev);\r\nif (mtd_suspend(info->mtd) == 0)\r\nmtd_resume(info->mtd);\r\n}

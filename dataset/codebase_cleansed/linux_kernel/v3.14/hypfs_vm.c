static int diag2fc(int size, char* query, void *addr)\r\n{\r\nunsigned long residual_cnt;\r\nunsigned long rc;\r\nstruct diag2fc_parm_list parm_list;\r\nmemcpy(parm_list.userid, query, NAME_LEN);\r\nASCEBC(parm_list.userid, NAME_LEN);\r\nparm_list.addr = (unsigned long) addr ;\r\nparm_list.size = size;\r\nparm_list.fmt = 0x02;\r\nmemset(parm_list.aci_grp, 0x40, NAME_LEN);\r\nrc = -1;\r\nasm volatile(\r\n" diag %0,%1,0x2fc\n"\r\n"0:\n"\r\nEX_TABLE(0b,0b)\r\n: "=d" (residual_cnt), "+d" (rc) : "0" (&parm_list) : "memory");\r\nif ((rc != 0 ) && (rc != -2))\r\nreturn rc;\r\nelse\r\nreturn -residual_cnt;\r\n}\r\nstatic void *diag2fc_store(char *query, unsigned int *count, int offset)\r\n{\r\nvoid *data;\r\nint size;\r\ndo {\r\nsize = diag2fc(0, query, NULL);\r\nif (size < 0)\r\nreturn ERR_PTR(-EACCES);\r\ndata = vmalloc(size + offset);\r\nif (!data)\r\nreturn ERR_PTR(-ENOMEM);\r\nif (diag2fc(size, query, data + offset) == 0)\r\nbreak;\r\nvfree(data);\r\n} while (1);\r\n*count = (size / sizeof(struct diag2fc_data));\r\nreturn data;\r\n}\r\nstatic void diag2fc_free(const void *data)\r\n{\r\nvfree(data);\r\n}\r\nstatic int hpyfs_vm_create_guest(struct dentry *systems_dir,\r\nstruct diag2fc_data *data)\r\n{\r\nchar guest_name[NAME_LEN + 1] = {};\r\nstruct dentry *guest_dir, *cpus_dir, *samples_dir, *mem_dir;\r\nint dedicated_flag, capped_value;\r\ncapped_value = (data->flags & 0x00000006) >> 1;\r\ndedicated_flag = (data->flags & 0x00000008) >> 3;\r\nmemcpy(guest_name, data->guest_name, NAME_LEN);\r\nEBCASC(guest_name, NAME_LEN);\r\nstrim(guest_name);\r\nguest_dir = hypfs_mkdir(systems_dir, guest_name);\r\nif (IS_ERR(guest_dir))\r\nreturn PTR_ERR(guest_dir);\r\nATTRIBUTE(guest_dir, "onlinetime_us", data->el_time);\r\ncpus_dir = hypfs_mkdir(guest_dir, "cpus");\r\nif (IS_ERR(cpus_dir))\r\nreturn PTR_ERR(cpus_dir);\r\nATTRIBUTE(cpus_dir, "cputime_us", data->used_cpu);\r\nATTRIBUTE(cpus_dir, "capped", capped_value);\r\nATTRIBUTE(cpus_dir, "dedicated", dedicated_flag);\r\nATTRIBUTE(cpus_dir, "count", data->vcpus);\r\nATTRIBUTE(cpus_dir, "weight_min", data->cpu_min);\r\nATTRIBUTE(cpus_dir, "weight_max", data->cpu_max);\r\nATTRIBUTE(cpus_dir, "weight_cur", data->cpu_shares);\r\nmem_dir = hypfs_mkdir(guest_dir, "mem");\r\nif (IS_ERR(mem_dir))\r\nreturn PTR_ERR(mem_dir);\r\nATTRIBUTE(mem_dir, "min_KiB", data->mem_min_kb);\r\nATTRIBUTE(mem_dir, "max_KiB", data->mem_max_kb);\r\nATTRIBUTE(mem_dir, "used_KiB", data->mem_used_kb);\r\nATTRIBUTE(mem_dir, "share_KiB", data->mem_share_kb);\r\nsamples_dir = hypfs_mkdir(guest_dir, "samples");\r\nif (IS_ERR(samples_dir))\r\nreturn PTR_ERR(samples_dir);\r\nATTRIBUTE(samples_dir, "cpu_using", data->cpu_use_samp);\r\nATTRIBUTE(samples_dir, "cpu_delay", data->cpu_delay_samp);\r\nATTRIBUTE(samples_dir, "mem_delay", data->page_wait_samp);\r\nATTRIBUTE(samples_dir, "idle", data->idle_samp);\r\nATTRIBUTE(samples_dir, "other", data->other_samp);\r\nATTRIBUTE(samples_dir, "total", data->total_samp);\r\nreturn 0;\r\n}\r\nint hypfs_vm_create_files(struct dentry *root)\r\n{\r\nstruct dentry *dir, *file;\r\nstruct diag2fc_data *data;\r\nunsigned int count = 0;\r\nint rc, i;\r\ndata = diag2fc_store(guest_query, &count, 0);\r\nif (IS_ERR(data))\r\nreturn PTR_ERR(data);\r\ndir = hypfs_mkdir(root, "hyp");\r\nif (IS_ERR(dir)) {\r\nrc = PTR_ERR(dir);\r\ngoto failed;\r\n}\r\nfile = hypfs_create_str(dir, "type", "z/VM Hypervisor");\r\nif (IS_ERR(file)) {\r\nrc = PTR_ERR(file);\r\ngoto failed;\r\n}\r\ndir = hypfs_mkdir(root, "cpus");\r\nif (IS_ERR(dir)) {\r\nrc = PTR_ERR(dir);\r\ngoto failed;\r\n}\r\nfile = hypfs_create_u64(dir, "count", data->lcpus);\r\nif (IS_ERR(file)) {\r\nrc = PTR_ERR(file);\r\ngoto failed;\r\n}\r\ndir = hypfs_mkdir(root, "systems");\r\nif (IS_ERR(dir)) {\r\nrc = PTR_ERR(dir);\r\ngoto failed;\r\n}\r\nfor (i = 0; i < count; i++) {\r\nrc = hpyfs_vm_create_guest(dir, &(data[i]));\r\nif (rc)\r\ngoto failed;\r\n}\r\ndiag2fc_free(data);\r\nreturn 0;\r\nfailed:\r\ndiag2fc_free(data);\r\nreturn rc;\r\n}\r\nstatic int dbfs_diag2fc_create(void **data, void **data_free_ptr, size_t *size)\r\n{\r\nstruct dbfs_d2fc *d2fc;\r\nunsigned int count;\r\nd2fc = diag2fc_store(guest_query, &count, sizeof(d2fc->hdr));\r\nif (IS_ERR(d2fc))\r\nreturn PTR_ERR(d2fc);\r\nget_tod_clock_ext(d2fc->hdr.tod_ext);\r\nd2fc->hdr.len = count * sizeof(struct diag2fc_data);\r\nd2fc->hdr.version = DBFS_D2FC_HDR_VERSION;\r\nd2fc->hdr.count = count;\r\nmemset(&d2fc->hdr.reserved, 0, sizeof(d2fc->hdr.reserved));\r\n*data = d2fc;\r\n*data_free_ptr = d2fc;\r\n*size = d2fc->hdr.len + sizeof(struct dbfs_d2fc_hdr);\r\nreturn 0;\r\n}\r\nint hypfs_vm_init(void)\r\n{\r\nif (!MACHINE_IS_VM)\r\nreturn 0;\r\nif (diag2fc(0, all_guests, NULL) > 0)\r\nguest_query = all_guests;\r\nelse if (diag2fc(0, local_guest, NULL) > 0)\r\nguest_query = local_guest;\r\nelse\r\nreturn -EACCES;\r\nreturn hypfs_dbfs_create_file(&dbfs_file_2fc);\r\n}\r\nvoid hypfs_vm_exit(void)\r\n{\r\nif (!MACHINE_IS_VM)\r\nreturn;\r\nhypfs_dbfs_remove_file(&dbfs_file_2fc);\r\n}

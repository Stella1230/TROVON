static void ixp4xx_spkr_control(unsigned int pin, unsigned int count)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&beep_lock, flags);\r\nif (count) {\r\ngpio_direction_output(pin, 0);\r\n*IXP4XX_OSRT2 = (count & ~IXP4XX_OST_RELOAD_MASK) | IXP4XX_OST_ENABLE;\r\n} else {\r\ngpio_direction_output(pin, 1);\r\ngpio_direction_input(pin);\r\n*IXP4XX_OSRT2 = 0;\r\n}\r\nspin_unlock_irqrestore(&beep_lock, flags);\r\n}\r\nstatic int ixp4xx_spkr_event(struct input_dev *dev, unsigned int type, unsigned int code, int value)\r\n{\r\nunsigned int pin = (unsigned int) input_get_drvdata(dev);\r\nunsigned int count = 0;\r\nif (type != EV_SND)\r\nreturn -1;\r\nswitch (code) {\r\ncase SND_BELL:\r\nif (value)\r\nvalue = 1000;\r\ncase SND_TONE:\r\nbreak;\r\ndefault:\r\nreturn -1;\r\n}\r\nif (value > 20 && value < 32767)\r\ncount = (IXP4XX_TIMER_FREQ / (value * 4)) - 1;\r\nixp4xx_spkr_control(pin, count);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t ixp4xx_spkr_interrupt(int irq, void *dev_id)\r\n{\r\nunsigned int pin = (unsigned int) dev_id;\r\n*IXP4XX_OSST = IXP4XX_OSST_TIMER_2_PEND;\r\ngpio_set_value(pin, !gpio_get_value(pin));\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int ixp4xx_spkr_probe(struct platform_device *dev)\r\n{\r\nstruct input_dev *input_dev;\r\nint err;\r\ninput_dev = input_allocate_device();\r\nif (!input_dev)\r\nreturn -ENOMEM;\r\ninput_set_drvdata(input_dev, (void *) dev->id);\r\ninput_dev->name = "ixp4xx beeper",\r\ninput_dev->phys = "ixp4xx/gpio";\r\ninput_dev->id.bustype = BUS_HOST;\r\ninput_dev->id.vendor = 0x001f;\r\ninput_dev->id.product = 0x0001;\r\ninput_dev->id.version = 0x0100;\r\ninput_dev->dev.parent = &dev->dev;\r\ninput_dev->evbit[0] = BIT_MASK(EV_SND);\r\ninput_dev->sndbit[0] = BIT_MASK(SND_BELL) | BIT_MASK(SND_TONE);\r\ninput_dev->event = ixp4xx_spkr_event;\r\nerr = gpio_request(dev->id, "ixp4-beeper");\r\nif (err)\r\ngoto err_free_device;\r\nerr = request_irq(IRQ_IXP4XX_TIMER2, &ixp4xx_spkr_interrupt,\r\nIRQF_NO_SUSPEND, "ixp4xx-beeper",\r\n(void *) dev->id);\r\nif (err)\r\ngoto err_free_gpio;\r\nerr = input_register_device(input_dev);\r\nif (err)\r\ngoto err_free_irq;\r\nplatform_set_drvdata(dev, input_dev);\r\nreturn 0;\r\nerr_free_irq:\r\nfree_irq(IRQ_IXP4XX_TIMER2, (void *)dev->id);\r\nerr_free_gpio:\r\ngpio_free(dev->id);\r\nerr_free_device:\r\ninput_free_device(input_dev);\r\nreturn err;\r\n}\r\nstatic int ixp4xx_spkr_remove(struct platform_device *dev)\r\n{\r\nstruct input_dev *input_dev = platform_get_drvdata(dev);\r\nunsigned int pin = (unsigned int) input_get_drvdata(input_dev);\r\ninput_unregister_device(input_dev);\r\ndisable_irq(IRQ_IXP4XX_TIMER2);\r\nixp4xx_spkr_control(pin, 0);\r\nfree_irq(IRQ_IXP4XX_TIMER2, (void *)dev->id);\r\ngpio_free(dev->id);\r\nreturn 0;\r\n}\r\nstatic void ixp4xx_spkr_shutdown(struct platform_device *dev)\r\n{\r\nstruct input_dev *input_dev = platform_get_drvdata(dev);\r\nunsigned int pin = (unsigned int) input_get_drvdata(input_dev);\r\ndisable_irq(IRQ_IXP4XX_TIMER2);\r\nixp4xx_spkr_control(pin, 0);\r\n}

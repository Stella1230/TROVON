static int rmobile_pd_power_down(struct generic_pm_domain *genpd)\r\n{\r\nstruct rmobile_pm_domain *rmobile_pd = to_rmobile_pd(genpd);\r\nunsigned int mask = 1 << rmobile_pd->bit_shift;\r\nif (rmobile_pd->suspend) {\r\nint ret = rmobile_pd->suspend();\r\nif (ret)\r\nreturn ret;\r\n}\r\nif (__raw_readl(PSTR) & mask) {\r\nunsigned int retry_count;\r\n__raw_writel(mask, SPDCR);\r\nfor (retry_count = PSTR_RETRIES; retry_count; retry_count--) {\r\nif (!(__raw_readl(SPDCR) & mask))\r\nbreak;\r\ncpu_relax();\r\n}\r\n}\r\nif (!rmobile_pd->no_debug)\r\npr_debug("%s: Power off, 0x%08x -> PSTR = 0x%08x\n",\r\ngenpd->name, mask, __raw_readl(PSTR));\r\nreturn 0;\r\n}\r\nstatic int __rmobile_pd_power_up(struct rmobile_pm_domain *rmobile_pd,\r\nbool do_resume)\r\n{\r\nunsigned int mask = 1 << rmobile_pd->bit_shift;\r\nunsigned int retry_count;\r\nint ret = 0;\r\nif (__raw_readl(PSTR) & mask)\r\ngoto out;\r\n__raw_writel(mask, SWUCR);\r\nfor (retry_count = 2 * PSTR_RETRIES; retry_count; retry_count--) {\r\nif (!(__raw_readl(SWUCR) & mask))\r\nbreak;\r\nif (retry_count > PSTR_RETRIES)\r\nudelay(PSTR_DELAY_US);\r\nelse\r\ncpu_relax();\r\n}\r\nif (!retry_count)\r\nret = -EIO;\r\nif (!rmobile_pd->no_debug)\r\npr_debug("%s: Power on, 0x%08x -> PSTR = 0x%08x\n",\r\nrmobile_pd->genpd.name, mask, __raw_readl(PSTR));\r\nout:\r\nif (ret == 0 && rmobile_pd->resume && do_resume)\r\nrmobile_pd->resume();\r\nreturn ret;\r\n}\r\nstatic int rmobile_pd_power_up(struct generic_pm_domain *genpd)\r\n{\r\nreturn __rmobile_pd_power_up(to_rmobile_pd(genpd), true);\r\n}\r\nstatic bool rmobile_pd_active_wakeup(struct device *dev)\r\n{\r\nbool (*active_wakeup)(struct device *dev);\r\nactive_wakeup = dev_gpd_data(dev)->ops.active_wakeup;\r\nreturn active_wakeup ? active_wakeup(dev) : true;\r\n}\r\nstatic int rmobile_pd_stop_dev(struct device *dev)\r\n{\r\nint (*stop)(struct device *dev);\r\nstop = dev_gpd_data(dev)->ops.stop;\r\nif (stop) {\r\nint ret = stop(dev);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn pm_clk_suspend(dev);\r\n}\r\nstatic int rmobile_pd_start_dev(struct device *dev)\r\n{\r\nint (*start)(struct device *dev);\r\nint ret;\r\nret = pm_clk_resume(dev);\r\nif (ret)\r\nreturn ret;\r\nstart = dev_gpd_data(dev)->ops.start;\r\nif (start)\r\nret = start(dev);\r\nreturn ret;\r\n}\r\nstatic void rmobile_init_pm_domain(struct rmobile_pm_domain *rmobile_pd)\r\n{\r\nstruct generic_pm_domain *genpd = &rmobile_pd->genpd;\r\nstruct dev_power_governor *gov = rmobile_pd->gov;\r\npm_genpd_init(genpd, gov ? : &simple_qos_governor, false);\r\ngenpd->dev_ops.stop = rmobile_pd_stop_dev;\r\ngenpd->dev_ops.start = rmobile_pd_start_dev;\r\ngenpd->dev_ops.active_wakeup = rmobile_pd_active_wakeup;\r\ngenpd->dev_irq_safe = true;\r\ngenpd->power_off = rmobile_pd_power_down;\r\ngenpd->power_on = rmobile_pd_power_up;\r\n__rmobile_pd_power_up(rmobile_pd, false);\r\n}\r\nvoid rmobile_init_domains(struct rmobile_pm_domain domains[], int num)\r\n{\r\nint j;\r\nfor (j = 0; j < num; j++)\r\nrmobile_init_pm_domain(&domains[j]);\r\n}\r\nvoid rmobile_add_device_to_domain_td(const char *domain_name,\r\nstruct platform_device *pdev,\r\nstruct gpd_timing_data *td)\r\n{\r\nstruct device *dev = &pdev->dev;\r\n__pm_genpd_name_add_device(domain_name, dev, td);\r\nif (pm_clk_no_clocks(dev))\r\npm_clk_add(dev, NULL);\r\n}\r\nvoid rmobile_add_devices_to_domains(struct pm_domain_device data[],\r\nint size)\r\n{\r\nstruct gpd_timing_data latencies = {\r\n.stop_latency_ns = DEFAULT_DEV_LATENCY_NS,\r\n.start_latency_ns = DEFAULT_DEV_LATENCY_NS,\r\n.save_state_latency_ns = DEFAULT_DEV_LATENCY_NS,\r\n.restore_state_latency_ns = DEFAULT_DEV_LATENCY_NS,\r\n};\r\nint j;\r\nfor (j = 0; j < size; j++)\r\nrmobile_add_device_to_domain_td(data[j].domain_name,\r\ndata[j].pdev, &latencies);\r\n}

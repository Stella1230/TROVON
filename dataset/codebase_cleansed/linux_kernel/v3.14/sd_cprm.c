static inline int get_rsp_type(u8 rsp_code, u8 *rsp_type, int *rsp_len)\r\n{\r\nif (!rsp_type || !rsp_len)\r\nreturn STATUS_FAIL;\r\nswitch (rsp_code) {\r\ncase 0x03:\r\n*rsp_type = SD_RSP_TYPE_R0;\r\n*rsp_len = 0;\r\nbreak;\r\ncase 0x04:\r\n*rsp_type = SD_RSP_TYPE_R1;\r\n*rsp_len = 6;\r\nbreak;\r\ncase 0x05:\r\n*rsp_type = SD_RSP_TYPE_R1b;\r\n*rsp_len = 6;\r\nbreak;\r\ncase 0x06:\r\n*rsp_type = SD_RSP_TYPE_R2;\r\n*rsp_len = 17;\r\nbreak;\r\ncase 0x07:\r\n*rsp_type = SD_RSP_TYPE_R3;\r\n*rsp_len = 6;\r\nbreak;\r\ndefault:\r\nreturn STATUS_FAIL;\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int ext_sd_send_cmd_get_rsp(struct rts51x_chip *chip, u8 cmd_idx,\r\nu32 arg, u8 rsp_type, u8 *rsp, int rsp_len,\r\nint special_check)\r\n{\r\nint retval;\r\nint timeout = 50;\r\nu16 reg_addr;\r\nu8 buf[17], stat;\r\nint len = 2;\r\nint rty_cnt = 0;\r\nRTS51X_DEBUGP("EXT SD/MMC CMD %d\n", cmd_idx);\r\nif (rsp_type == SD_RSP_TYPE_R1b)\r\ntimeout = 3000;\r\nRTY_SEND_CMD:\r\nrts51x_init_cmd(chip);\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_CMD0, 0xFF, 0x40 | cmd_idx);\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_CMD1, 0xFF, (u8) (arg >> 24));\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_CMD2, 0xFF, (u8) (arg >> 16));\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_CMD3, 0xFF, (u8) (arg >> 8));\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_CMD4, 0xFF, (u8) arg);\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_CFG2, 0xFF, rsp_type);\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, CARD_DATA_SOURCE,\r\n0x01, PINGPONG_BUFFER);\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_TRANSFER,\r\n0xFF, SD_TM_CMD_RSP | SD_TRANSFER_START);\r\nrts51x_add_cmd(chip, CHECK_REG_CMD, SD_TRANSFER, SD_TRANSFER_END,\r\nSD_TRANSFER_END);\r\nrts51x_add_cmd(chip, READ_REG_CMD, SD_STAT1, 0, 0);\r\nif (CHECK_USB(chip, USB_20)) {\r\nif (rsp_type == SD_RSP_TYPE_R2) {\r\nfor (reg_addr = PPBUF_BASE2;\r\nreg_addr < PPBUF_BASE2 + 16; reg_addr++) {\r\nrts51x_add_cmd(chip, READ_REG_CMD, reg_addr, 0,\r\n0);\r\n}\r\nlen = 19;\r\n} else if (rsp_type != SD_RSP_TYPE_R0) {\r\nfor (reg_addr = SD_CMD0; reg_addr <= SD_CMD4;\r\nreg_addr++) {\r\nrts51x_add_cmd(chip, READ_REG_CMD, reg_addr, 0,\r\n0);\r\n}\r\nlen = 8;\r\n} else {\r\nlen = 3;\r\n}\r\nrts51x_add_cmd(chip, READ_REG_CMD, SD_CMD5, 0, 0);\r\n} else {\r\nlen = 2;\r\n}\r\nretval = rts51x_send_cmd(chip, MODE_CR, 100);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, retval);\r\nretval = rts51x_get_rsp(chip, len, timeout);\r\nif (CHECK_SD_TRANS_FAIL(chip, retval)) {\r\nrts51x_clear_sd_error(chip);\r\nif (retval == STATUS_TIMEDOUT) {\r\nif (rsp_type & SD_WAIT_BUSY_END) {\r\nretval = sd_check_data0_status(chip);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, retval);\r\n}\r\n}\r\nTRACE_RET(chip, STATUS_FAIL);\r\n}\r\nif (rsp_type == SD_RSP_TYPE_R0)\r\nreturn STATUS_SUCCESS;\r\nif (CHECK_USB(chip, USB_20)) {\r\nrts51x_read_rsp_buf(chip, 2, buf, len - 2);\r\n} else {\r\nif (rsp_type == SD_RSP_TYPE_R2) {\r\nreg_addr = PPBUF_BASE2;\r\nlen = 16;\r\n} else {\r\nreg_addr = SD_CMD0;\r\nlen = 5;\r\n}\r\nretval =\r\nrts51x_seq_read_register(chip, reg_addr,\r\n(unsigned short)len, buf);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, retval);\r\nRTS51X_READ_REG(chip, SD_CMD5, buf + len);\r\n}\r\nstat = chip->rsp_buf[1];\r\nif ((buf[0] & 0xC0) != 0)\r\nTRACE_RET(chip, STATUS_FAIL);\r\nif (!(rsp_type & SD_NO_CHECK_CRC7)) {\r\nif (stat & SD_CRC7_ERR) {\r\nif (cmd_idx == WRITE_MULTIPLE_BLOCK)\r\nTRACE_RET(chip, STATUS_FAIL);\r\nif (rty_cnt < SD_MAX_RETRY_COUNT) {\r\nwait_timeout(20);\r\nrty_cnt++;\r\ngoto RTY_SEND_CMD;\r\n} else {\r\nTRACE_RET(chip, STATUS_FAIL);\r\n}\r\n}\r\n}\r\nif ((cmd_idx == SELECT_CARD) || (cmd_idx == APP_CMD) ||\r\n(cmd_idx == SEND_STATUS) || (cmd_idx == STOP_TRANSMISSION)) {\r\nif ((cmd_idx != STOP_TRANSMISSION) && (special_check == 0)) {\r\nif (buf[1] & 0x80)\r\nTRACE_RET(chip, STATUS_FAIL);\r\n}\r\nif (buf[1] & 0x7F)\r\nTRACE_RET(chip, STATUS_FAIL);\r\nif (buf[2] & 0xF8)\r\nTRACE_RET(chip, STATUS_FAIL);\r\nif (cmd_idx == SELECT_CARD) {\r\nif (rsp_type == SD_RSP_TYPE_R2) {\r\nif ((buf[3] & 0x1E) != 0x04)\r\nTRACE_RET(chip, STATUS_FAIL);\r\n} else if (rsp_type == SD_RSP_TYPE_R2) {\r\nif ((buf[3] & 0x1E) != 0x03)\r\nTRACE_RET(chip, STATUS_FAIL);\r\n}\r\n}\r\n}\r\nif (rsp && rsp_len)\r\nmemcpy(rsp, buf, rsp_len);\r\nreturn STATUS_SUCCESS;\r\n}\r\nstatic int ext_sd_get_rsp(struct rts51x_chip *chip, int len,\r\nu8 *rsp, u8 rsp_type)\r\n{\r\nint retval, rsp_len;\r\nu16 reg_addr;\r\nif (rsp_type == SD_RSP_TYPE_R0)\r\nreturn STATUS_SUCCESS;\r\nrts51x_init_cmd(chip);\r\nif (rsp_type == SD_RSP_TYPE_R2) {\r\nfor (reg_addr = PPBUF_BASE2; reg_addr < PPBUF_BASE2 + 16;\r\nreg_addr++) {\r\nrts51x_add_cmd(chip, READ_REG_CMD, reg_addr, 0xFF, 0);\r\n}\r\nrsp_len = 17;\r\n} else if (rsp_type != SD_RSP_TYPE_R0) {\r\nfor (reg_addr = SD_CMD0; reg_addr <= SD_CMD4; reg_addr++)\r\nrts51x_add_cmd(chip, READ_REG_CMD, reg_addr, 0xFF, 0);\r\nrsp_len = 6;\r\n}\r\nrts51x_add_cmd(chip, READ_REG_CMD, SD_CMD5, 0xFF, 0);\r\nretval = rts51x_send_cmd(chip, MODE_CR, 100);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, retval);\r\nretval = rts51x_get_rsp(chip, rsp_len, 100);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, retval);\r\nif (rsp) {\r\nint min_len = (rsp_len < len) ? rsp_len : len;\r\nmemcpy(rsp, rts51x_get_rsp_data(chip), min_len);\r\nRTS51X_DEBUGP("min_len = %d\n", min_len);\r\nRTS51X_DEBUGP("Response in cmd buf: 0x%x 0x%x 0x%x 0x%x\n",\r\nrsp[0], rsp[1], rsp[2], rsp[3]);\r\n}\r\nreturn STATUS_SUCCESS;\r\n}\r\nint ext_rts51x_sd_execute_no_data(struct rts51x_chip *chip, unsigned int lun,\r\nu8 cmd_idx, u8 standby, u8 acmd, u8 rsp_code,\r\nu32 arg)\r\n{\r\nstruct sd_info *sd_card = &(chip->sd_card);\r\nint retval, rsp_len;\r\nu8 rsp_type;\r\nretval = rts51x_sd_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\nif (sd_card->pre_cmd_err) {\r\nsd_card->pre_cmd_err = 0;\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_CHANGE);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nretval = get_rsp_type(rsp_code, &rsp_type, &rsp_len);\r\nif (retval != STATUS_SUCCESS) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nsd_card->last_rsp_type = rsp_type;\r\nretval = rts51x_sd_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\nrts51x_write_register(chip, SD_CFG1, 0x03, SD_BUS_WIDTH_4);\r\nif (standby) {\r\nretval = rts51x_sd_select_card(chip, 0);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_GOTO(chip, SD_Execute_Cmd_Failed);\r\n}\r\nif (acmd) {\r\nretval =\r\next_sd_send_cmd_get_rsp(chip, APP_CMD, sd_card->sd_addr,\r\nSD_RSP_TYPE_R1, NULL, 0, 0);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_GOTO(chip, SD_Execute_Cmd_Failed);\r\n}\r\nretval = ext_sd_send_cmd_get_rsp(chip, cmd_idx, arg, rsp_type,\r\nsd_card->rsp, rsp_len, 0);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_GOTO(chip, SD_Execute_Cmd_Failed);\r\nif (standby) {\r\nretval = rts51x_sd_select_card(chip, 1);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_GOTO(chip, SD_Execute_Cmd_Failed);\r\n}\r\nreturn TRANSPORT_GOOD;\r\nSD_Execute_Cmd_Failed:\r\nsd_card->pre_cmd_err = 1;\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_NO_SENSE);\r\nrts51x_release_sd_card(chip);\r\nrts51x_do_rts51x_reset_sd_card(chip);\r\nif (!(chip->card_ready & SD_CARD))\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nint ext_rts51x_sd_execute_read_data(struct rts51x_chip *chip, unsigned int lun,\r\nu8 cmd_idx, u8 cmd12, u8 standby,\r\nu8 acmd, u8 rsp_code, u32 arg, u32 data_len,\r\nvoid *data_buf, unsigned int buf_len, int use_sg)\r\n{\r\nstruct sd_info *sd_card = &(chip->sd_card);\r\nint retval, rsp_len, i;\r\nint cmd13_checkbit = 0, read_err = 0;\r\nu8 rsp_type, bus_width;\r\nif (sd_card->pre_cmd_err) {\r\nsd_card->pre_cmd_err = 0;\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_CHANGE);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nretval = rts51x_sd_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, STATUS_FAIL);\r\nretval = get_rsp_type(rsp_code, &rsp_type, &rsp_len);\r\nif (retval != STATUS_SUCCESS) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nsd_card->last_rsp_type = rsp_type;\r\nretval = rts51x_sd_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\nbus_width = SD_BUS_WIDTH_4;\r\nif (data_len < 512) {\r\nretval = ext_sd_send_cmd_get_rsp(chip, SET_BLOCKLEN, data_len,\r\nSD_RSP_TYPE_R1, NULL, 0, 0);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_GOTO(chip, SD_Execute_Read_Cmd_Failed);\r\n}\r\nif (standby) {\r\nretval = rts51x_sd_select_card(chip, 0);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_GOTO(chip, SD_Execute_Read_Cmd_Failed);\r\n}\r\nif (acmd) {\r\nretval =\r\next_sd_send_cmd_get_rsp(chip, APP_CMD, sd_card->sd_addr,\r\nSD_RSP_TYPE_R1, NULL, 0, 0);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_GOTO(chip, SD_Execute_Read_Cmd_Failed);\r\n}\r\nif (data_len <= 512) {\r\nint min_len;\r\nu8 *buf;\r\nu16 byte_cnt, blk_cnt;\r\nu8 cmd[5];\r\nunsigned int offset = 0;\r\nvoid *sg = NULL;\r\nbyte_cnt = (u16) (data_len & 0x3FF);\r\nblk_cnt = 1;\r\ncmd[0] = 0x40 | cmd_idx;\r\ncmd[1] = (u8) (arg >> 24);\r\ncmd[2] = (u8) (arg >> 16);\r\ncmd[3] = (u8) (arg >> 8);\r\ncmd[4] = (u8) arg;\r\nbuf = kmalloc(data_len, GFP_KERNEL);\r\nif (buf == NULL)\r\nTRACE_RET(chip, TRANSPORT_ERROR);\r\nretval = sd_read_data(chip, SD_TM_NORMAL_READ, cmd, 5, byte_cnt,\r\nblk_cnt, bus_width, buf, data_len, 2000);\r\nif (retval != STATUS_SUCCESS) {\r\nread_err = 1;\r\nkfree(buf);\r\nrts51x_write_register(chip, CARD_STOP,\r\nSD_STOP | SD_CLR_ERR,\r\nSD_STOP | SD_CLR_ERR);\r\nTRACE_GOTO(chip, SD_Execute_Read_Cmd_Failed);\r\n}\r\nmin_len = min(data_len, buf_len);\r\nif (use_sg)\r\nrts51x_access_sglist(buf, min_len, (void *)data_buf,\r\n&sg, &offset, TO_XFER_BUF);\r\nelse\r\nmemcpy(data_buf, buf, min_len);\r\nkfree(buf);\r\n} else if (!(data_len & 0x1FF)) {\r\nrts51x_init_cmd(chip);\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_BYTE_CNT_H, 0xFF, 0x02);\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_BYTE_CNT_L, 0xFF, 0x00);\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_BLOCK_CNT_H,\r\n0xFF, (u8) (data_len >> 17));\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_BLOCK_CNT_L,\r\n0xFF, (u8) ((data_len & 0x0001FE00) >> 9));\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_CMD0, 0xFF,\r\n0x40 | cmd_idx);\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_CMD1, 0xFF,\r\n(u8) (arg >> 24));\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_CMD2, 0xFF,\r\n(u8) (arg >> 16));\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_CMD3, 0xFF,\r\n(u8) (arg >> 8));\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_CMD4, 0xFF, (u8) arg);\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_CFG1, 0x03, bus_width);\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_CFG2, 0xFF, rsp_type);\r\nrts51x_trans_dma_enable(DMA_FROM_DEVICE, chip, data_len, DMA_512);\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_TRANSFER, 0xFF,\r\nSD_TM_AUTO_READ_2 | SD_TRANSFER_START);\r\nrts51x_add_cmd(chip, CHECK_REG_CMD, SD_TRANSFER,\r\nSD_TRANSFER_END, SD_TRANSFER_END);\r\nretval = rts51x_send_cmd(chip, MODE_CDIR, 100);\r\nif (retval != STATUS_SUCCESS) {\r\nread_err = 1;\r\nrts51x_ep0_write_register(chip, CARD_STOP,\r\nSD_STOP | SD_CLR_ERR,\r\nSD_STOP | SD_CLR_ERR);\r\nTRACE_GOTO(chip, SD_Execute_Read_Cmd_Failed);\r\n}\r\nretval =\r\nrts51x_transfer_data_rcc(chip, RCV_BULK_PIPE(chip),\r\ndata_buf, buf_len, use_sg, NULL,\r\n10000, STAGE_DI);\r\nif (retval != STATUS_SUCCESS) {\r\nread_err = 1;\r\nrts51x_ep0_write_register(chip, CARD_STOP,\r\nSD_STOP | SD_CLR_ERR,\r\nSD_STOP | SD_CLR_ERR);\r\nTRACE_GOTO(chip, SD_Execute_Read_Cmd_Failed);\r\n}\r\nretval = rts51x_get_rsp(chip, 1, 500);\r\nif (CHECK_SD_TRANS_FAIL(chip, retval)) {\r\nread_err = 1;\r\nrts51x_ep0_write_register(chip, CARD_STOP,\r\nSD_STOP | SD_CLR_ERR,\r\nSD_STOP | SD_CLR_ERR);\r\nTRACE_GOTO(chip, SD_Execute_Read_Cmd_Failed);\r\n}\r\n} else {\r\nTRACE_GOTO(chip, SD_Execute_Read_Cmd_Failed);\r\n}\r\nretval = ext_sd_get_rsp(chip, rsp_len, sd_card->rsp, rsp_type);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_GOTO(chip, SD_Execute_Read_Cmd_Failed);\r\nif (standby) {\r\nretval = rts51x_sd_select_card(chip, 1);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_GOTO(chip, SD_Execute_Read_Cmd_Failed);\r\n}\r\nif (cmd12) {\r\nretval = ext_sd_send_cmd_get_rsp(chip, STOP_TRANSMISSION,\r\n0, SD_RSP_TYPE_R1b, NULL, 0,\r\n0);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_GOTO(chip, SD_Execute_Read_Cmd_Failed);\r\n}\r\nif (data_len < 512) {\r\nretval = ext_sd_send_cmd_get_rsp(chip, SET_BLOCKLEN, 0x200,\r\nSD_RSP_TYPE_R1, NULL, 0, 0);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_GOTO(chip, SD_Execute_Read_Cmd_Failed);\r\nrts51x_write_register(chip, SD_BYTE_CNT_H, 0xFF, 0x02);\r\nrts51x_write_register(chip, SD_BYTE_CNT_L, 0xFF, 0x00);\r\n}\r\nif (standby || cmd12)\r\ncmd13_checkbit = 1;\r\nfor (i = 0; i < 3; i++) {\r\nretval =\r\next_sd_send_cmd_get_rsp(chip, SEND_STATUS, sd_card->sd_addr,\r\nSD_RSP_TYPE_R1, NULL, 0,\r\ncmd13_checkbit);\r\nif (retval == STATUS_SUCCESS)\r\nbreak;\r\n}\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_GOTO(chip, SD_Execute_Read_Cmd_Failed);\r\nreturn TRANSPORT_GOOD;\r\nSD_Execute_Read_Cmd_Failed:\r\nsd_card->pre_cmd_err = 1;\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_NO_SENSE);\r\nif (read_err)\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_UNRECOVER_READ_ERR);\r\nrts51x_release_sd_card(chip);\r\nrts51x_do_rts51x_reset_sd_card(chip);\r\nif (!(chip->card_ready & SD_CARD))\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nint ext_rts51x_sd_execute_write_data(struct rts51x_chip *chip, unsigned int lun,\r\nu8 cmd_idx, u8 cmd12, u8 standby, u8 acmd,\r\nu8 rsp_code, u32 arg, u32 data_len,\r\nvoid *data_buf, unsigned int buf_len, int use_sg)\r\n{\r\nstruct sd_info *sd_card = &(chip->sd_card);\r\nint retval, rsp_len;\r\nint cmd13_checkbit = 0, write_err = 0;\r\nu8 rsp_type;\r\nu32 i;\r\nif (sd_card->pre_cmd_err) {\r\nsd_card->pre_cmd_err = 0;\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_CHANGE);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nretval = rts51x_sd_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, STATUS_FAIL);\r\nretval = get_rsp_type(rsp_code, &rsp_type, &rsp_len);\r\nif (retval != STATUS_SUCCESS) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nsd_card->last_rsp_type = rsp_type;\r\nretval = rts51x_sd_switch_clock(chip);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\nrts51x_write_register(chip, SD_CFG1, 0x03, SD_BUS_WIDTH_4);\r\nif (data_len < 512) {\r\nretval = ext_sd_send_cmd_get_rsp(chip, SET_BLOCKLEN, data_len,\r\nSD_RSP_TYPE_R1, NULL, 0, 0);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_GOTO(chip, SD_Execute_Write_Cmd_Failed);\r\n}\r\nif (standby) {\r\nretval = rts51x_sd_select_card(chip, 0);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_GOTO(chip, SD_Execute_Write_Cmd_Failed);\r\n}\r\nif (acmd) {\r\nretval =\r\next_sd_send_cmd_get_rsp(chip, APP_CMD, sd_card->sd_addr,\r\nSD_RSP_TYPE_R1, NULL, 0, 0);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_GOTO(chip, SD_Execute_Write_Cmd_Failed);\r\n}\r\nretval = ext_sd_send_cmd_get_rsp(chip, cmd_idx, arg, rsp_type,\r\nsd_card->rsp, rsp_len, 0);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_GOTO(chip, SD_Execute_Write_Cmd_Failed);\r\nif (data_len <= 512) {\r\nu8 *buf;\r\nunsigned int offset = 0;\r\nvoid *sg = NULL;\r\nbuf = kmalloc(data_len, GFP_KERNEL);\r\nif (buf == NULL)\r\nTRACE_RET(chip, TRANSPORT_ERROR);\r\nif (use_sg)\r\nrts51x_access_sglist(buf, data_len, (void *)data_buf,\r\n&sg, &offset, FROM_XFER_BUF);\r\nelse\r\nmemcpy(buf, data_buf, data_len);\r\nif (data_len > 256) {\r\nrts51x_init_cmd(chip);\r\nfor (i = 0; i < 256; i++) {\r\nrts51x_add_cmd(chip, WRITE_REG_CMD,\r\n(u16) (PPBUF_BASE2 + i), 0xFF,\r\nbuf[i]);\r\n}\r\nretval = rts51x_send_cmd(chip, MODE_C, 250);\r\nif (retval != STATUS_SUCCESS) {\r\nkfree(buf);\r\nTRACE_GOTO(chip, SD_Execute_Write_Cmd_Failed);\r\n}\r\nrts51x_init_cmd(chip);\r\nfor (i = 256; i < data_len; i++) {\r\nrts51x_add_cmd(chip, WRITE_REG_CMD,\r\n(u16) (PPBUF_BASE2 + i), 0xFF,\r\nbuf[i]);\r\n}\r\nretval = rts51x_send_cmd(chip, MODE_C, 250);\r\nif (retval != STATUS_SUCCESS) {\r\nkfree(buf);\r\nTRACE_GOTO(chip, SD_Execute_Write_Cmd_Failed);\r\n}\r\n} else {\r\nrts51x_init_cmd(chip);\r\nfor (i = 0; i < data_len; i++) {\r\nrts51x_add_cmd(chip, WRITE_REG_CMD,\r\n(u16) (PPBUF_BASE2 + i), 0xFF,\r\nbuf[i]);\r\n}\r\nretval = rts51x_send_cmd(chip, MODE_C, 250);\r\nif (retval != STATUS_SUCCESS) {\r\nkfree(buf);\r\nTRACE_GOTO(chip, SD_Execute_Write_Cmd_Failed);\r\n}\r\n}\r\nkfree(buf);\r\nrts51x_init_cmd(chip);\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_BYTE_CNT_H, 0xFF,\r\n(u8) ((data_len >> 8) & 0x03));\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_BYTE_CNT_L, 0xFF,\r\n(u8) data_len);\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_BLOCK_CNT_H, 0xFF, 0x00);\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_BLOCK_CNT_L, 0xFF, 0x01);\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, CARD_DATA_SOURCE, 0x01,\r\nPINGPONG_BUFFER);\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_TRANSFER, 0xFF,\r\nSD_TM_AUTO_WRITE_3 | SD_TRANSFER_START);\r\nrts51x_add_cmd(chip, CHECK_REG_CMD, SD_TRANSFER,\r\nSD_TRANSFER_END, SD_TRANSFER_END);\r\nretval = rts51x_send_cmd(chip, MODE_CR, 100);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_GOTO(chip, SD_Execute_Write_Cmd_Failed);\r\nretval = rts51x_get_rsp(chip, 1, 250);\r\nif (CHECK_SD_TRANS_FAIL(chip, retval))\r\nTRACE_GOTO(chip, SD_Execute_Write_Cmd_Failed);\r\n} else if (!(data_len & 0x1FF)) {\r\nrts51x_init_cmd(chip);\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_BYTE_CNT_H, 0xFF, 0x02);\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_BYTE_CNT_L, 0xFF, 0x00);\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_BLOCK_CNT_H,\r\n0xFF, (u8) (data_len >> 17));\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_BLOCK_CNT_L,\r\n0xFF, (u8) ((data_len & 0x0001FE00) >> 9));\r\nrts51x_trans_dma_enable(DMA_TO_DEVICE, chip, data_len, DMA_512);\r\nrts51x_add_cmd(chip, WRITE_REG_CMD, SD_TRANSFER, 0xFF,\r\nSD_TM_AUTO_WRITE_3 | SD_TRANSFER_START);\r\nrts51x_add_cmd(chip, CHECK_REG_CMD, SD_TRANSFER,\r\nSD_TRANSFER_END, SD_TRANSFER_END);\r\nretval = rts51x_send_cmd(chip, MODE_CDOR, 100);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_GOTO(chip, SD_Execute_Write_Cmd_Failed);\r\nretval =\r\nrts51x_transfer_data_rcc(chip, SND_BULK_PIPE(chip),\r\ndata_buf, buf_len, use_sg, NULL,\r\n10000, STAGE_DO);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_GOTO(chip, SD_Execute_Write_Cmd_Failed);\r\nretval = rts51x_get_rsp(chip, 1, 10000);\r\nif (CHECK_SD_TRANS_FAIL(chip, retval))\r\nTRACE_GOTO(chip, SD_Execute_Write_Cmd_Failed);\r\n} else {\r\nTRACE_GOTO(chip, SD_Execute_Write_Cmd_Failed);\r\n}\r\nif (retval < 0) {\r\nwrite_err = 1;\r\nrts51x_write_register(chip, CARD_STOP, SD_STOP | SD_CLR_ERR,\r\nSD_STOP | SD_CLR_ERR);\r\nTRACE_GOTO(chip, SD_Execute_Write_Cmd_Failed);\r\n}\r\nif (standby) {\r\nretval = rts51x_sd_select_card(chip, 1);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_GOTO(chip, SD_Execute_Write_Cmd_Failed);\r\n}\r\nif (cmd12) {\r\nretval = ext_sd_send_cmd_get_rsp(chip, STOP_TRANSMISSION,\r\n0, SD_RSP_TYPE_R1b, NULL, 0,\r\n0);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_GOTO(chip, SD_Execute_Write_Cmd_Failed);\r\n}\r\nif (data_len < 512) {\r\nretval = ext_sd_send_cmd_get_rsp(chip, SET_BLOCKLEN, 0x200,\r\nSD_RSP_TYPE_R1, NULL, 0, 0);\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_GOTO(chip, SD_Execute_Write_Cmd_Failed);\r\nrts51x_write_register(chip, SD_BYTE_CNT_H, 0xFF, 0x02);\r\nrts51x_write_register(chip, SD_BYTE_CNT_L, 0xFF, 0x00);\r\n}\r\nif (cmd12 || standby) {\r\ncmd13_checkbit = 1;\r\n}\r\nfor (i = 0; i < 3; i++) {\r\nretval =\r\next_sd_send_cmd_get_rsp(chip, SEND_STATUS, sd_card->sd_addr,\r\nSD_RSP_TYPE_R1, NULL, 0,\r\ncmd13_checkbit);\r\nif (retval == STATUS_SUCCESS)\r\nbreak;\r\n}\r\nif (retval != STATUS_SUCCESS)\r\nTRACE_GOTO(chip, SD_Execute_Write_Cmd_Failed);\r\nreturn TRANSPORT_GOOD;\r\nSD_Execute_Write_Cmd_Failed:\r\nsd_card->pre_cmd_err = 1;\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_NO_SENSE);\r\nif (write_err)\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_WRITE_ERR);\r\nrts51x_release_sd_card(chip);\r\nrts51x_do_rts51x_reset_sd_card(chip);\r\nif (!(chip->card_ready & SD_CARD))\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nint rts51x_sd_pass_thru_mode(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &(chip->sd_card);\r\nunsigned int lun = SCSI_LUN(srb);\r\nint len;\r\nu8 buf[18] = {\r\n0x00,\r\n0x00,\r\n0x00,\r\n0x0E,\r\n0x00,\r\n0x00,\r\n0x00,\r\n0x00,\r\n0x53,\r\n0x44,\r\n0x20,\r\n0x43,\r\n0x61,\r\n0x72,\r\n0x64,\r\n0x00,\r\n0x00,\r\n0x00,\r\n};\r\nsd_card->pre_cmd_err = 0;\r\nif (!(CHK_BIT(chip->lun_mc, lun))) {\r\nSET_BIT(chip->lun_mc, lun);\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_CHANGE);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nif ((0x53 != srb->cmnd[2]) || (0x44 != srb->cmnd[3])\r\n|| (0x20 != srb->cmnd[4]) || (0x43 != srb->cmnd[5])\r\n|| (0x61 != srb->cmnd[6]) || (0x72 != srb->cmnd[7])\r\n|| (0x64 != srb->cmnd[8])) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nswitch (srb->cmnd[1] & 0x0F) {\r\ncase 0:\r\nsd_card->sd_pass_thru_en = 0;\r\nbreak;\r\ncase 1:\r\nsd_card->sd_pass_thru_en = 1;\r\nbreak;\r\ndefault:\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nbuf[5] = (1 == CHK_SD(sd_card)) ? 0x01 : 0x02;\r\nif (chip->card_wp & SD_CARD)\r\nbuf[5] |= 0x80;\r\nbuf[6] = (u8) (sd_card->sd_addr >> 16);\r\nbuf[7] = (u8) (sd_card->sd_addr >> 24);\r\nbuf[15] = chip->max_lun;\r\nlen = min_t(unsigned, 18, scsi_bufflen(srb));\r\nrts51x_set_xfer_buf(buf, len, srb);\r\nreturn TRANSPORT_GOOD;\r\n}\r\nint rts51x_sd_execute_no_data(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &(chip->sd_card);\r\nunsigned int lun = SCSI_LUN(srb);\r\nint retval;\r\nu8 cmd_idx, rsp_code;\r\nu8 standby = 0, acmd = 0;\r\nu32 arg;\r\nif (!sd_card->sd_pass_thru_en) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\ncmd_idx = srb->cmnd[2] & 0x3F;\r\nif (srb->cmnd[1] & 0x02)\r\nstandby = 1;\r\nif (srb->cmnd[1] & 0x01)\r\nacmd = 1;\r\narg = ((u32) srb->cmnd[3] << 24) | ((u32) srb->cmnd[4] << 16) |\r\n((u32) srb->cmnd[5] << 8) | srb->cmnd[6];\r\nrsp_code = srb->cmnd[10];\r\nretval =\r\next_rts51x_sd_execute_no_data(chip, lun, cmd_idx, standby, acmd, rsp_code,\r\narg);\r\nscsi_set_resid(srb, 0);\r\nreturn retval;\r\n}\r\nint rts51x_sd_execute_read_data(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &(chip->sd_card);\r\nint retval;\r\nunsigned int lun = SCSI_LUN(srb);\r\nu8 cmd_idx, rsp_code, send_cmd12 = 0, standby = 0, acmd = 0;\r\nu32 arg, data_len;\r\nif (!sd_card->sd_pass_thru_en) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\ncmd_idx = srb->cmnd[2] & 0x3F;\r\nif (srb->cmnd[1] & 0x04)\r\nsend_cmd12 = 1;\r\nif (srb->cmnd[1] & 0x02)\r\nstandby = 1;\r\nif (srb->cmnd[1] & 0x01)\r\nacmd = 1;\r\narg = ((u32) srb->cmnd[3] << 24) | ((u32) srb->cmnd[4] << 16) |\r\n((u32) srb->cmnd[5] << 8) | srb->cmnd[6];\r\ndata_len =\r\n((u32) srb->cmnd[7] << 16) | ((u32) srb->cmnd[8] << 8) |\r\nsrb->cmnd[9];\r\nrsp_code = srb->cmnd[10];\r\nretval =\r\next_rts51x_sd_execute_read_data(chip, lun, cmd_idx, send_cmd12, standby,\r\nacmd, rsp_code, arg, data_len,\r\nscsi_sglist(srb), scsi_bufflen(srb),\r\nscsi_sg_count(srb));\r\nscsi_set_resid(srb, 0);\r\nreturn retval;\r\n}\r\nint rts51x_sd_execute_write_data(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &(chip->sd_card);\r\nint retval;\r\nunsigned int lun = SCSI_LUN(srb);\r\nu8 cmd_idx, rsp_code, send_cmd12 = 0, standby = 0, acmd = 0;\r\nu32 data_len, arg;\r\nif (!sd_card->sd_pass_thru_en) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\ncmd_idx = srb->cmnd[2] & 0x3F;\r\nif (srb->cmnd[1] & 0x04)\r\nsend_cmd12 = 1;\r\nif (srb->cmnd[1] & 0x02)\r\nstandby = 1;\r\nif (srb->cmnd[1] & 0x01)\r\nacmd = 1;\r\ndata_len =\r\n((u32) srb->cmnd[7] << 16) | ((u32) srb->cmnd[8] << 8) |\r\nsrb->cmnd[9];\r\narg =\r\n((u32) srb->cmnd[3] << 24) | ((u32) srb->cmnd[4] << 16) |\r\n((u32) srb->cmnd[5] << 8) | srb->cmnd[6];\r\nrsp_code = srb->cmnd[10];\r\nretval =\r\next_rts51x_sd_execute_write_data(chip, lun, cmd_idx, send_cmd12, standby,\r\nacmd, rsp_code, arg, data_len,\r\nscsi_sglist(srb), scsi_bufflen(srb),\r\nscsi_sg_count(srb));\r\nscsi_set_resid(srb, 0);\r\nreturn retval;\r\n}\r\nint rts51x_sd_get_cmd_rsp(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &(chip->sd_card);\r\nunsigned int lun = SCSI_LUN(srb);\r\nint count;\r\nu16 data_len;\r\nif (!sd_card->sd_pass_thru_en) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nif (sd_card->pre_cmd_err) {\r\nsd_card->pre_cmd_err = 0;\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_CHANGE);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\ndata_len = ((u16) srb->cmnd[7] << 8) | srb->cmnd[8];\r\nif (sd_card->last_rsp_type == SD_RSP_TYPE_R0) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n} else if (sd_card->last_rsp_type == SD_RSP_TYPE_R2) {\r\ncount = (data_len < 17) ? data_len : 17;\r\n} else {\r\ncount = (data_len < 6) ? data_len : 6;\r\n}\r\nrts51x_set_xfer_buf(sd_card->rsp, count, srb);\r\nRTS51X_DEBUGP("Response length: %d\n", data_len);\r\nRTS51X_DEBUGP("Response: 0x%x 0x%x 0x%x 0x%x\n",\r\nsd_card->rsp[0], sd_card->rsp[1], sd_card->rsp[2],\r\nsd_card->rsp[3]);\r\nscsi_set_resid(srb, 0);\r\nreturn TRANSPORT_GOOD;\r\n}\r\nint rts51x_sd_hw_rst(struct scsi_cmnd *srb, struct rts51x_chip *chip)\r\n{\r\nstruct sd_info *sd_card = &(chip->sd_card);\r\nunsigned int lun = SCSI_LUN(srb);\r\nint retval;\r\nif (!sd_card->sd_pass_thru_en) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nif (sd_card->pre_cmd_err) {\r\nsd_card->pre_cmd_err = 0;\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_CHANGE);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nif ((0x53 != srb->cmnd[2]) || (0x44 != srb->cmnd[3])\r\n|| (0x20 != srb->cmnd[4]) || (0x43 != srb->cmnd[5])\r\n|| (0x61 != srb->cmnd[6]) || (0x72 != srb->cmnd[7])\r\n|| (0x64 != srb->cmnd[8])) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nswitch (srb->cmnd[1] & 0x0F) {\r\ncase 0:\r\nretval = rts51x_reset_sd_card(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\r\nsd_card->pre_cmd_err = 1;\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nbreak;\r\ncase 1:\r\nretval = reset_sd(chip);\r\nif (retval != STATUS_SUCCESS) {\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_NOT_PRESENT);\r\nsd_card->pre_cmd_err = 1;\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nbreak;\r\ndefault:\r\nrts51x_set_sense_type(chip, lun, SENSE_TYPE_MEDIA_INVALID_CMD_FIELD);\r\nTRACE_RET(chip, TRANSPORT_FAILED);\r\n}\r\nscsi_set_resid(srb, 0);\r\nreturn TRANSPORT_GOOD;\r\n}

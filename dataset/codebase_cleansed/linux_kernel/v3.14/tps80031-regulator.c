static inline struct device *to_tps80031_dev(struct regulator_dev *rdev)\r\n{\r\nreturn rdev_get_dev(rdev)->parent->parent;\r\n}\r\nstatic int tps80031_reg_is_enabled(struct regulator_dev *rdev)\r\n{\r\nstruct tps80031_regulator *ri = rdev_get_drvdata(rdev);\r\nstruct device *parent = to_tps80031_dev(rdev);\r\nu8 reg_val;\r\nint ret;\r\nif (ri->ext_ctrl_flag & TPS80031_EXT_PWR_REQ)\r\nreturn true;\r\nret = tps80031_read(parent, TPS80031_SLAVE_ID1, ri->rinfo->state_reg,\r\n&reg_val);\r\nif (ret < 0) {\r\ndev_err(&rdev->dev, "Reg 0x%02x read failed, err = %d\n",\r\nri->rinfo->state_reg, ret);\r\nreturn ret;\r\n}\r\nreturn ((reg_val & TPS80031_STATE_MASK) == TPS80031_STATE_ON);\r\n}\r\nstatic int tps80031_reg_enable(struct regulator_dev *rdev)\r\n{\r\nstruct tps80031_regulator *ri = rdev_get_drvdata(rdev);\r\nstruct device *parent = to_tps80031_dev(rdev);\r\nint ret;\r\nif (ri->ext_ctrl_flag & TPS80031_EXT_PWR_REQ)\r\nreturn 0;\r\nret = tps80031_update(parent, TPS80031_SLAVE_ID1, ri->rinfo->state_reg,\r\nTPS80031_STATE_ON, TPS80031_STATE_MASK);\r\nif (ret < 0) {\r\ndev_err(&rdev->dev, "Reg 0x%02x update failed, err = %d\n",\r\nri->rinfo->state_reg, ret);\r\nreturn ret;\r\n}\r\nreturn ret;\r\n}\r\nstatic int tps80031_reg_disable(struct regulator_dev *rdev)\r\n{\r\nstruct tps80031_regulator *ri = rdev_get_drvdata(rdev);\r\nstruct device *parent = to_tps80031_dev(rdev);\r\nint ret;\r\nif (ri->ext_ctrl_flag & TPS80031_EXT_PWR_REQ)\r\nreturn 0;\r\nret = tps80031_update(parent, TPS80031_SLAVE_ID1, ri->rinfo->state_reg,\r\nTPS80031_STATE_OFF, TPS80031_STATE_MASK);\r\nif (ret < 0)\r\ndev_err(&rdev->dev, "Reg 0x%02x update failed, err = %d\n",\r\nri->rinfo->state_reg, ret);\r\nreturn ret;\r\n}\r\nstatic int tps80031_dcdc_list_voltage(struct regulator_dev *rdev, unsigned sel)\r\n{\r\nstruct tps80031_regulator *ri = rdev_get_drvdata(rdev);\r\nint volt_index = ri->device_flags & 0x3;\r\nif (sel == 0)\r\nreturn 0;\r\nelse if (sel < 58)\r\nreturn regulator_list_voltage_linear(rdev, sel - 1);\r\nelse\r\nreturn tps80031_dcdc_voltages[volt_index][sel - 58] * 1000;\r\n}\r\nstatic int tps80031_dcdc_set_voltage_sel(struct regulator_dev *rdev,\r\nunsigned vsel)\r\n{\r\nstruct tps80031_regulator *ri = rdev_get_drvdata(rdev);\r\nstruct device *parent = to_tps80031_dev(rdev);\r\nint ret;\r\nu8 reg_val;\r\nif (ri->rinfo->force_reg) {\r\nret = tps80031_read(parent, ri->rinfo->volt_id,\r\nri->rinfo->force_reg, &reg_val);\r\nif (ret < 0) {\r\ndev_err(ri->dev, "reg 0x%02x read failed, e = %d\n",\r\nri->rinfo->force_reg, ret);\r\nreturn ret;\r\n}\r\nif (!(reg_val & SMPS_CMD_MASK)) {\r\nret = tps80031_update(parent, ri->rinfo->volt_id,\r\nri->rinfo->force_reg, vsel, SMPS_VSEL_MASK);\r\nif (ret < 0)\r\ndev_err(ri->dev,\r\n"reg 0x%02x update failed, e = %d\n",\r\nri->rinfo->force_reg, ret);\r\nreturn ret;\r\n}\r\n}\r\nret = tps80031_update(parent, ri->rinfo->volt_id,\r\nri->rinfo->volt_reg, vsel, SMPS_VSEL_MASK);\r\nif (ret < 0)\r\ndev_err(ri->dev, "reg 0x%02x update failed, e = %d\n",\r\nri->rinfo->volt_reg, ret);\r\nreturn ret;\r\n}\r\nstatic int tps80031_dcdc_get_voltage_sel(struct regulator_dev *rdev)\r\n{\r\nstruct tps80031_regulator *ri = rdev_get_drvdata(rdev);\r\nstruct device *parent = to_tps80031_dev(rdev);\r\nuint8_t vsel = 0;\r\nint ret;\r\nif (ri->rinfo->force_reg) {\r\nret = tps80031_read(parent, ri->rinfo->volt_id,\r\nri->rinfo->force_reg, &vsel);\r\nif (ret < 0) {\r\ndev_err(ri->dev, "reg 0x%02x read failed, e = %d\n",\r\nri->rinfo->force_reg, ret);\r\nreturn ret;\r\n}\r\nif (!(vsel & SMPS_CMD_MASK))\r\nreturn vsel & SMPS_VSEL_MASK;\r\n}\r\nret = tps80031_read(parent, ri->rinfo->volt_id,\r\nri->rinfo->volt_reg, &vsel);\r\nif (ret < 0) {\r\ndev_err(ri->dev, "reg 0x%02x read failed, e = %d\n",\r\nri->rinfo->volt_reg, ret);\r\nreturn ret;\r\n}\r\nreturn vsel & SMPS_VSEL_MASK;\r\n}\r\nstatic int tps80031_ldo_list_voltage(struct regulator_dev *rdev,\r\nunsigned int sel)\r\n{\r\nstruct tps80031_regulator *ri = rdev_get_drvdata(rdev);\r\nstruct device *parent = to_tps80031_dev(rdev);\r\nif ((ri->rinfo->desc.id == TPS80031_REGULATOR_LDO2) &&\r\n(ri->device_flags & TRACK_MODE_ENABLE)) {\r\nunsigned nvsel = (sel) & 0x1F;\r\nif (((tps80031_get_chip_info(parent) == TPS80031) ||\r\n((tps80031_get_chip_info(parent) == TPS80032) &&\r\n(tps80031_get_pmu_version(parent) == 0x0))) &&\r\n((nvsel == 0x0) || (nvsel >= 0x19 && nvsel <= 0x1F))) {\r\ndev_err(ri->dev,\r\n"Invalid sel %d in track mode LDO2\n",\r\nnvsel);\r\nreturn -EINVAL;\r\n}\r\n}\r\nreturn regulator_list_voltage_linear(rdev, sel);\r\n}\r\nstatic int tps80031_ldo_map_voltage(struct regulator_dev *rdev,\r\nint min_uV, int max_uV)\r\n{\r\nstruct tps80031_regulator *ri = rdev_get_drvdata(rdev);\r\nstruct device *parent = to_tps80031_dev(rdev);\r\nif ((ri->rinfo->desc.id == TPS80031_REGULATOR_LDO2) &&\r\n(ri->device_flags & TRACK_MODE_ENABLE)) {\r\nif (((tps80031_get_chip_info(parent) == TPS80031) ||\r\n((tps80031_get_chip_info(parent) == TPS80032) &&\r\n(tps80031_get_pmu_version(parent) == 0x0)))) {\r\nreturn regulator_map_voltage_iterate(rdev, min_uV,\r\nmax_uV);\r\n}\r\n}\r\nreturn regulator_map_voltage_linear(rdev, min_uV, max_uV);\r\n}\r\nstatic int tps80031_vbus_is_enabled(struct regulator_dev *rdev)\r\n{\r\nstruct tps80031_regulator *ri = rdev_get_drvdata(rdev);\r\nstruct device *parent = to_tps80031_dev(rdev);\r\nint ret = -EIO;\r\nuint8_t ctrl1 = 0;\r\nuint8_t ctrl3 = 0;\r\nret = tps80031_read(parent, TPS80031_SLAVE_ID2,\r\nTPS80031_CHARGERUSB_CTRL1, &ctrl1);\r\nif (ret < 0) {\r\ndev_err(ri->dev, "reg 0x%02x read failed, e = %d\n",\r\nTPS80031_CHARGERUSB_CTRL1, ret);\r\nreturn ret;\r\n}\r\nret = tps80031_read(parent, TPS80031_SLAVE_ID2,\r\nTPS80031_CHARGERUSB_CTRL3, &ctrl3);\r\nif (ret < 0) {\r\ndev_err(ri->dev, "reg 0x%02x read failed, e = %d\n",\r\nTPS80031_CHARGERUSB_CTRL3, ret);\r\nreturn ret;\r\n}\r\nif ((ctrl1 & OPA_MODE_EN) && (ctrl3 & BOOST_HW_PWR_EN))\r\nreturn 1;\r\nreturn ret;\r\n}\r\nstatic int tps80031_vbus_enable(struct regulator_dev *rdev)\r\n{\r\nstruct tps80031_regulator *ri = rdev_get_drvdata(rdev);\r\nstruct device *parent = to_tps80031_dev(rdev);\r\nint ret;\r\nret = tps80031_set_bits(parent, TPS80031_SLAVE_ID2,\r\nTPS80031_CHARGERUSB_CTRL1, OPA_MODE_EN);\r\nif (ret < 0) {\r\ndev_err(ri->dev, "reg 0x%02x read failed, e = %d\n",\r\nTPS80031_CHARGERUSB_CTRL1, ret);\r\nreturn ret;\r\n}\r\nret = tps80031_set_bits(parent, TPS80031_SLAVE_ID2,\r\nTPS80031_CHARGERUSB_CTRL3, BOOST_HW_PWR_EN);\r\nif (ret < 0) {\r\ndev_err(ri->dev, "reg 0x%02x read failed, e = %d\n",\r\nTPS80031_CHARGERUSB_CTRL3, ret);\r\nreturn ret;\r\n}\r\nreturn ret;\r\n}\r\nstatic int tps80031_vbus_disable(struct regulator_dev *rdev)\r\n{\r\nstruct tps80031_regulator *ri = rdev_get_drvdata(rdev);\r\nstruct device *parent = to_tps80031_dev(rdev);\r\nint ret = 0;\r\nif (ri->config_flags & TPS80031_VBUS_DISCHRG_EN_PDN) {\r\nret = tps80031_write(parent, TPS80031_SLAVE_ID2,\r\nUSB_VBUS_CTRL_SET, VBUS_DISCHRG);\r\nif (ret < 0) {\r\ndev_err(ri->dev, "reg 0x%02x write failed, e = %d\n",\r\nUSB_VBUS_CTRL_SET, ret);\r\nreturn ret;\r\n}\r\n}\r\nret = tps80031_clr_bits(parent, TPS80031_SLAVE_ID2,\r\nTPS80031_CHARGERUSB_CTRL1, OPA_MODE_EN);\r\nif (ret < 0) {\r\ndev_err(ri->dev, "reg 0x%02x clearbit failed, e = %d\n",\r\nTPS80031_CHARGERUSB_CTRL1, ret);\r\nreturn ret;\r\n}\r\nret = tps80031_clr_bits(parent, TPS80031_SLAVE_ID2,\r\nTPS80031_CHARGERUSB_CTRL3, BOOST_HW_PWR_EN);\r\nif (ret < 0) {\r\ndev_err(ri->dev, "reg 0x%02x clearbit failed, e = %d\n",\r\nTPS80031_CHARGERUSB_CTRL3, ret);\r\nreturn ret;\r\n}\r\nmdelay(DIV_ROUND_UP(ri->rinfo->desc.enable_time, 1000));\r\nif (ri->config_flags & TPS80031_VBUS_DISCHRG_EN_PDN) {\r\nret = tps80031_write(parent, TPS80031_SLAVE_ID2,\r\nUSB_VBUS_CTRL_CLR, VBUS_DISCHRG);\r\nif (ret < 0) {\r\ndev_err(ri->dev, "reg 0x%02x write failed, e = %d\n",\r\nUSB_VBUS_CTRL_CLR, ret);\r\nreturn ret;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic int tps80031_power_req_config(struct device *parent,\r\nstruct tps80031_regulator *ri,\r\nstruct tps80031_regulator_platform_data *tps80031_pdata)\r\n{\r\nint ret = 0;\r\nif (ri->rinfo->preq_bit < 0)\r\ngoto skip_pwr_req_config;\r\nret = tps80031_ext_power_req_config(parent, ri->ext_ctrl_flag,\r\nri->rinfo->preq_bit, ri->rinfo->state_reg,\r\nri->rinfo->trans_reg);\r\nif (ret < 0) {\r\ndev_err(ri->dev, "ext powerreq config failed, err = %d\n", ret);\r\nreturn ret;\r\n}\r\nskip_pwr_req_config:\r\nif (tps80031_pdata->ext_ctrl_flag & TPS80031_PWR_ON_ON_SLEEP) {\r\nret = tps80031_update(parent, TPS80031_SLAVE_ID1,\r\nri->rinfo->trans_reg, TPS80031_TRANS_SLEEP_ON,\r\nTPS80031_TRANS_SLEEP_MASK);\r\nif (ret < 0) {\r\ndev_err(ri->dev, "Reg 0x%02x update failed, e %d\n",\r\nri->rinfo->trans_reg, ret);\r\nreturn ret;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic int tps80031_regulator_config(struct device *parent,\r\nstruct tps80031_regulator *ri,\r\nstruct tps80031_regulator_platform_data *tps80031_pdata)\r\n{\r\nint ret = 0;\r\nswitch (ri->rinfo->desc.id) {\r\ncase TPS80031_REGULATOR_LDOUSB:\r\nif (ri->config_flags & (TPS80031_USBLDO_INPUT_VSYS |\r\nTPS80031_USBLDO_INPUT_PMID)) {\r\nunsigned val = 0;\r\nif (ri->config_flags & TPS80031_USBLDO_INPUT_VSYS)\r\nval = MISC2_LDOUSB_IN_VSYS;\r\nelse\r\nval = MISC2_LDOUSB_IN_PMID;\r\nret = tps80031_update(parent, TPS80031_SLAVE_ID1,\r\nTPS80031_MISC2, val,\r\nMISC2_LDOUSB_IN_MASK);\r\nif (ret < 0) {\r\ndev_err(ri->dev,\r\n"LDOUSB config failed, e= %d\n", ret);\r\nreturn ret;\r\n}\r\n}\r\nbreak;\r\ncase TPS80031_REGULATOR_LDO3:\r\nif (ri->config_flags & TPS80031_LDO3_OUTPUT_VIB) {\r\nret = tps80031_update(parent, TPS80031_SLAVE_ID1,\r\nTPS80031_MISC2, MISC2_LDO3_SEL_VIB_VAL,\r\nMISC2_LDO3_SEL_VIB_MASK);\r\nif (ret < 0) {\r\ndev_err(ri->dev,\r\n"LDO3 config failed, e = %d\n", ret);\r\nreturn ret;\r\n}\r\n}\r\nbreak;\r\ncase TPS80031_REGULATOR_VBUS:\r\nif (!(ri->config_flags & TPS80031_VBUS_SW_ONLY))\r\nri->rinfo->desc.ops = &tps80031_vbus_sw_ops;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nret = tps80031_update(parent, TPS80031_SLAVE_ID1, ri->rinfo->trans_reg,\r\nTPS80031_TRANS_ACTIVE_ON | TPS80031_TRANS_SLEEP_OFF |\r\nTPS80031_TRANS_OFF_OFF, TPS80031_TRANS_ACTIVE_MASK |\r\nTPS80031_TRANS_SLEEP_MASK | TPS80031_TRANS_OFF_MASK);\r\nif (ret < 0) {\r\ndev_err(ri->dev, "trans reg update failed, e %d\n", ret);\r\nreturn ret;\r\n}\r\nreturn ret;\r\n}\r\nstatic int check_smps_mode_mult(struct device *parent,\r\nstruct tps80031_regulator *ri)\r\n{\r\nint mult_offset;\r\nint ret;\r\nu8 smps_offset;\r\nu8 smps_mult;\r\nret = tps80031_read(parent, TPS80031_SLAVE_ID1,\r\nTPS80031_SMPS_OFFSET, &smps_offset);\r\nif (ret < 0) {\r\ndev_err(parent, "Error in reading smps offset register\n");\r\nreturn ret;\r\n}\r\nret = tps80031_read(parent, TPS80031_SLAVE_ID1,\r\nTPS80031_SMPS_MULT, &smps_mult);\r\nif (ret < 0) {\r\ndev_err(parent, "Error in reading smps mult register\n");\r\nreturn ret;\r\n}\r\nswitch (ri->rinfo->desc.id) {\r\ncase TPS80031_REGULATOR_VIO:\r\nmult_offset = SMPS_MULTOFFSET_VIO;\r\nbreak;\r\ncase TPS80031_REGULATOR_SMPS1:\r\nmult_offset = SMPS_MULTOFFSET_SMPS1;\r\nbreak;\r\ncase TPS80031_REGULATOR_SMPS2:\r\nmult_offset = SMPS_MULTOFFSET_SMPS2;\r\nbreak;\r\ncase TPS80031_REGULATOR_SMPS3:\r\nmult_offset = SMPS_MULTOFFSET_SMPS3;\r\nbreak;\r\ncase TPS80031_REGULATOR_SMPS4:\r\nmult_offset = SMPS_MULTOFFSET_SMPS4;\r\nbreak;\r\ncase TPS80031_REGULATOR_LDO2:\r\nri->device_flags = smps_mult & BIT(5) ? TRACK_MODE_ENABLE : 0;\r\nif (ri->device_flags & TRACK_MODE_ENABLE) {\r\nri->rinfo->desc.min_uV = 600000;\r\nri->rinfo->desc.uV_step = 12500;\r\nri->rinfo->desc.n_voltages = 57;\r\nri->rinfo->desc.vsel_mask = LDO_TRACK_VSEL_MASK;\r\n}\r\nreturn 0;\r\ndefault:\r\nreturn 0;\r\n}\r\nri->device_flags = (smps_offset & mult_offset) ? DCDC_OFFSET_EN : 0;\r\nri->device_flags |= (smps_mult & mult_offset) ? DCDC_EXTENDED_EN : 0;\r\nswitch (ri->device_flags) {\r\ncase 0:\r\nri->rinfo->desc.min_uV = 607700;\r\nri->rinfo->desc.uV_step = 12660;\r\nbreak;\r\ncase DCDC_OFFSET_EN:\r\nri->rinfo->desc.min_uV = 700000;\r\nri->rinfo->desc.uV_step = 12500;\r\nbreak;\r\ncase DCDC_EXTENDED_EN:\r\nri->rinfo->desc.min_uV = 1852000;\r\nri->rinfo->desc.uV_step = 38600;\r\nbreak;\r\ncase DCDC_OFFSET_EN | DCDC_EXTENDED_EN:\r\nri->rinfo->desc.min_uV = 2161000;\r\nri->rinfo->desc.uV_step = 38600;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tps80031_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct tps80031_platform_data *pdata;\r\nstruct tps80031_regulator_platform_data *tps_pdata;\r\nstruct tps80031_regulator *ri;\r\nstruct tps80031_regulator *pmic;\r\nstruct regulator_dev *rdev;\r\nstruct regulator_config config = { };\r\nstruct tps80031 *tps80031_mfd = dev_get_drvdata(pdev->dev.parent);\r\nint ret;\r\nint num;\r\npdata = dev_get_platdata(pdev->dev.parent);\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "No platform data\n");\r\nreturn -EINVAL;\r\n}\r\npmic = devm_kzalloc(&pdev->dev,\r\nTPS80031_REGULATOR_MAX * sizeof(*pmic), GFP_KERNEL);\r\nif (!pmic) {\r\ndev_err(&pdev->dev, "mem alloc for pmic failed\n");\r\nreturn -ENOMEM;\r\n}\r\nfor (num = 0; num < TPS80031_REGULATOR_MAX; ++num) {\r\ntps_pdata = pdata->regulator_pdata[num];\r\nri = &pmic[num];\r\nri->rinfo = &tps80031_rinfo[num];\r\nri->dev = &pdev->dev;\r\ncheck_smps_mode_mult(pdev->dev.parent, ri);\r\nconfig.dev = &pdev->dev;\r\nconfig.init_data = NULL;\r\nconfig.driver_data = ri;\r\nconfig.regmap = tps80031_mfd->regmap[ri->rinfo->volt_id];\r\nif (tps_pdata) {\r\nconfig.init_data = tps_pdata->reg_init_data;\r\nri->config_flags = tps_pdata->config_flags;\r\nri->ext_ctrl_flag = tps_pdata->ext_ctrl_flag;\r\nret = tps80031_regulator_config(pdev->dev.parent,\r\nri, tps_pdata);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev,\r\n"regulator config failed, e %d\n", ret);\r\nreturn ret;\r\n}\r\nret = tps80031_power_req_config(pdev->dev.parent,\r\nri, tps_pdata);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev,\r\n"pwr_req config failed, err %d\n", ret);\r\nreturn ret;\r\n}\r\n}\r\nrdev = devm_regulator_register(&pdev->dev, &ri->rinfo->desc,\r\n&config);\r\nif (IS_ERR(rdev)) {\r\ndev_err(&pdev->dev,\r\n"register regulator failed %s\n",\r\nri->rinfo->desc.name);\r\nreturn PTR_ERR(rdev);\r\n}\r\nri->rdev = rdev;\r\n}\r\nplatform_set_drvdata(pdev, pmic);\r\nreturn 0;\r\n}\r\nstatic int __init tps80031_regulator_init(void)\r\n{\r\nreturn platform_driver_register(&tps80031_regulator_driver);\r\n}\r\nstatic void __exit tps80031_regulator_exit(void)\r\n{\r\nplatform_driver_unregister(&tps80031_regulator_driver);\r\n}

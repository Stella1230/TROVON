static unsigned long vexpress_osc_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct vexpress_osc *osc = to_vexpress_osc(hw);\r\nu32 rate;\r\nvexpress_config_read(osc->func, 0, &rate);\r\nreturn rate;\r\n}\r\nstatic long vexpress_osc_round_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long *parent_rate)\r\n{\r\nstruct vexpress_osc *osc = to_vexpress_osc(hw);\r\nif (WARN_ON(osc->rate_min && rate < osc->rate_min))\r\nrate = osc->rate_min;\r\nif (WARN_ON(osc->rate_max && rate > osc->rate_max))\r\nrate = osc->rate_max;\r\nreturn rate;\r\n}\r\nstatic int vexpress_osc_set_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nstruct vexpress_osc *osc = to_vexpress_osc(hw);\r\nreturn vexpress_config_write(osc->func, 0, rate);\r\n}\r\nstruct clk * __init vexpress_osc_setup(struct device *dev)\r\n{\r\nstruct clk_init_data init;\r\nstruct vexpress_osc *osc = kzalloc(sizeof(*osc), GFP_KERNEL);\r\nif (!osc)\r\nreturn NULL;\r\nosc->func = vexpress_config_func_get_by_dev(dev);\r\nif (!osc->func) {\r\nkfree(osc);\r\nreturn NULL;\r\n}\r\ninit.name = dev_name(dev);\r\ninit.ops = &vexpress_osc_ops;\r\ninit.flags = CLK_IS_ROOT;\r\ninit.num_parents = 0;\r\nosc->hw.init = &init;\r\nreturn clk_register(NULL, &osc->hw);\r\n}\r\nvoid __init vexpress_osc_of_setup(struct device_node *node)\r\n{\r\nstruct clk_init_data init;\r\nstruct vexpress_osc *osc;\r\nstruct clk *clk;\r\nu32 range[2];\r\nosc = kzalloc(sizeof(*osc), GFP_KERNEL);\r\nif (!osc)\r\ngoto error;\r\nosc->func = vexpress_config_func_get_by_node(node);\r\nif (!osc->func) {\r\npr_err("Failed to obtain config func for node '%s'!\n",\r\nnode->full_name);\r\ngoto error;\r\n}\r\nif (of_property_read_u32_array(node, "freq-range", range,\r\nARRAY_SIZE(range)) == 0) {\r\nosc->rate_min = range[0];\r\nosc->rate_max = range[1];\r\n}\r\nof_property_read_string(node, "clock-output-names", &init.name);\r\nif (!init.name)\r\ninit.name = node->full_name;\r\ninit.ops = &vexpress_osc_ops;\r\ninit.flags = CLK_IS_ROOT;\r\ninit.num_parents = 0;\r\nosc->hw.init = &init;\r\nclk = clk_register(NULL, &osc->hw);\r\nif (IS_ERR(clk)) {\r\npr_err("Failed to register clock '%s'!\n", init.name);\r\ngoto error;\r\n}\r\nof_clk_add_provider(node, of_clk_src_simple_get, clk);\r\npr_debug("Registered clock '%s'\n", init.name);\r\nreturn;\r\nerror:\r\nif (osc->func)\r\nvexpress_config_func_put(osc->func);\r\nkfree(osc);\r\n}

void sirfsoc_rtc_iobrg_wait_sync(void)\r\n{\r\nwhile (readl_relaxed(sirfsoc_rtciobrg_base + SIRFSOC_CPUIOBRG_CTRL))\r\ncpu_relax();\r\n}\r\nvoid sirfsoc_rtc_iobrg_besyncing(void)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&rtciobrg_lock, flags);\r\nsirfsoc_rtc_iobrg_wait_sync();\r\nspin_unlock_irqrestore(&rtciobrg_lock, flags);\r\n}\r\nu32 __sirfsoc_rtc_iobrg_readl(u32 addr)\r\n{\r\nsirfsoc_rtc_iobrg_wait_sync();\r\nwritel_relaxed(0x00, sirfsoc_rtciobrg_base + SIRFSOC_CPUIOBRG_WRBE);\r\nwritel_relaxed(addr, sirfsoc_rtciobrg_base + SIRFSOC_CPUIOBRG_ADDR);\r\nwritel_relaxed(0x01, sirfsoc_rtciobrg_base + SIRFSOC_CPUIOBRG_CTRL);\r\nsirfsoc_rtc_iobrg_wait_sync();\r\nreturn readl_relaxed(sirfsoc_rtciobrg_base + SIRFSOC_CPUIOBRG_DATA);\r\n}\r\nu32 sirfsoc_rtc_iobrg_readl(u32 addr)\r\n{\r\nunsigned long flags, val;\r\nspin_lock_irqsave(&rtciobrg_lock, flags);\r\nval = __sirfsoc_rtc_iobrg_readl(addr);\r\nspin_unlock_irqrestore(&rtciobrg_lock, flags);\r\nreturn val;\r\n}\r\nvoid sirfsoc_rtc_iobrg_pre_writel(u32 val, u32 addr)\r\n{\r\nsirfsoc_rtc_iobrg_wait_sync();\r\nwritel_relaxed(0xf1, sirfsoc_rtciobrg_base + SIRFSOC_CPUIOBRG_WRBE);\r\nwritel_relaxed(addr, sirfsoc_rtciobrg_base + SIRFSOC_CPUIOBRG_ADDR);\r\nwritel_relaxed(val, sirfsoc_rtciobrg_base + SIRFSOC_CPUIOBRG_DATA);\r\n}\r\nvoid sirfsoc_rtc_iobrg_writel(u32 val, u32 addr)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&rtciobrg_lock, flags);\r\nsirfsoc_rtc_iobrg_pre_writel(val, addr);\r\nwritel_relaxed(0x01, sirfsoc_rtciobrg_base + SIRFSOC_CPUIOBRG_CTRL);\r\nsirfsoc_rtc_iobrg_wait_sync();\r\nspin_unlock_irqrestore(&rtciobrg_lock, flags);\r\n}\r\nstatic int sirfsoc_rtciobrg_probe(struct platform_device *op)\r\n{\r\nstruct device_node *np = op->dev.of_node;\r\nsirfsoc_rtciobrg_base = of_iomap(np, 0);\r\nif (!sirfsoc_rtciobrg_base)\r\npanic("unable to map rtc iobrg registers\n");\r\nreturn 0;\r\n}\r\nstatic int __init sirfsoc_rtciobrg_init(void)\r\n{\r\nreturn platform_driver_register(&sirfsoc_rtciobrg_driver);\r\n}

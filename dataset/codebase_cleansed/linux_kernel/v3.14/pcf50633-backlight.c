int pcf50633_bl_set_brightness_limit(struct pcf50633 *pcf, unsigned int limit)\r\n{\r\nstruct pcf50633_bl *pcf_bl = platform_get_drvdata(pcf->bl_pdev);\r\nif (!pcf_bl)\r\nreturn -ENODEV;\r\npcf_bl->brightness_limit = limit & 0x3f;\r\nbacklight_update_status(pcf_bl->bl);\r\nreturn 0;\r\n}\r\nstatic int pcf50633_bl_update_status(struct backlight_device *bl)\r\n{\r\nstruct pcf50633_bl *pcf_bl = bl_get_data(bl);\r\nunsigned int new_brightness;\r\nif (bl->props.state & (BL_CORE_SUSPENDED | BL_CORE_FBBLANK) ||\r\nbl->props.power != FB_BLANK_UNBLANK)\r\nnew_brightness = 0;\r\nelse if (bl->props.brightness < pcf_bl->brightness_limit)\r\nnew_brightness = bl->props.brightness;\r\nelse\r\nnew_brightness = pcf_bl->brightness_limit;\r\nif (pcf_bl->brightness == new_brightness)\r\nreturn 0;\r\nif (new_brightness) {\r\npcf50633_reg_write(pcf_bl->pcf, PCF50633_REG_LEDOUT,\r\nnew_brightness);\r\nif (!pcf_bl->brightness)\r\npcf50633_reg_write(pcf_bl->pcf, PCF50633_REG_LEDENA, 1);\r\n} else {\r\npcf50633_reg_write(pcf_bl->pcf, PCF50633_REG_LEDENA, 0);\r\n}\r\npcf_bl->brightness = new_brightness;\r\nreturn 0;\r\n}\r\nstatic int pcf50633_bl_get_brightness(struct backlight_device *bl)\r\n{\r\nstruct pcf50633_bl *pcf_bl = bl_get_data(bl);\r\nreturn pcf_bl->brightness;\r\n}\r\nstatic int pcf50633_bl_probe(struct platform_device *pdev)\r\n{\r\nstruct pcf50633_bl *pcf_bl;\r\nstruct device *parent = pdev->dev.parent;\r\nstruct pcf50633_platform_data *pcf50633_data = dev_get_platdata(parent);\r\nstruct pcf50633_bl_platform_data *pdata = pcf50633_data->backlight_data;\r\nstruct backlight_properties bl_props;\r\npcf_bl = devm_kzalloc(&pdev->dev, sizeof(*pcf_bl), GFP_KERNEL);\r\nif (!pcf_bl)\r\nreturn -ENOMEM;\r\nmemset(&bl_props, 0, sizeof(bl_props));\r\nbl_props.type = BACKLIGHT_RAW;\r\nbl_props.max_brightness = 0x3f;\r\nbl_props.power = FB_BLANK_UNBLANK;\r\nif (pdata) {\r\nbl_props.brightness = pdata->default_brightness;\r\npcf_bl->brightness_limit = pdata->default_brightness_limit;\r\n} else {\r\nbl_props.brightness = 0x3f;\r\npcf_bl->brightness_limit = 0x3f;\r\n}\r\npcf_bl->pcf = dev_to_pcf50633(pdev->dev.parent);\r\npcf_bl->bl = devm_backlight_device_register(&pdev->dev, pdev->name,\r\n&pdev->dev, pcf_bl,\r\n&pcf50633_bl_ops, &bl_props);\r\nif (IS_ERR(pcf_bl->bl))\r\nreturn PTR_ERR(pcf_bl->bl);\r\nplatform_set_drvdata(pdev, pcf_bl);\r\npcf50633_reg_write(pcf_bl->pcf, PCF50633_REG_LEDDIM, pdata->ramp_time);\r\npcf_bl->brightness = pcf_bl->bl->props.brightness + 1;\r\nbacklight_update_status(pcf_bl->bl);\r\nreturn 0;\r\n}

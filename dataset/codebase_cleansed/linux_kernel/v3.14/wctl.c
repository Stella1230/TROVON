bool WCTLbIsDuplicate (PSCache pCache, struct ieee80211_hdr *pMACHeader)\r\n{\r\nunsigned int uIndex;\r\nunsigned int ii;\r\nPSCacheEntry pCacheEntry;\r\nif (IS_FC_RETRY(pMACHeader)) {\r\nuIndex = pCache->uInPtr;\r\nfor (ii = 0; ii < DUPLICATE_RX_CACHE_LENGTH; ii++) {\r\npCacheEntry = &(pCache->asCacheEntry[uIndex]);\r\nif ((pCacheEntry->wFmSequence == pMACHeader->seq_ctrl) &&\r\nether_addr_equal(pCacheEntry->abyAddr2, pMACHeader->addr2) &&\r\n(LOBYTE(pCacheEntry->wFrameCtl) == LOBYTE(pMACHeader->frame_control))\r\n) {\r\nreturn true;\r\n}\r\nADD_ONE_WITH_WRAP_AROUND(uIndex, DUPLICATE_RX_CACHE_LENGTH);\r\n}\r\n}\r\npCacheEntry = &pCache->asCacheEntry[pCache->uInPtr];\r\npCacheEntry->wFmSequence = pMACHeader->seq_ctrl;\r\nmemcpy(&(pCacheEntry->abyAddr2[0]), &(pMACHeader->addr2[0]), ETH_ALEN);\r\npCacheEntry->wFrameCtl = pMACHeader->frame_control;\r\nADD_ONE_WITH_WRAP_AROUND(pCache->uInPtr, DUPLICATE_RX_CACHE_LENGTH);\r\nreturn false;\r\n}\r\nunsigned int WCTLuSearchDFCB(struct vnt_private *pDevice,\r\nstruct ieee80211_hdr *pMACHeader)\r\n{\r\nunsigned int ii;\r\nfor (ii = 0; ii < pDevice->cbDFCB; ii++) {\r\nif ((pDevice->sRxDFCB[ii].bInUse == true) &&\r\nether_addr_equal(pDevice->sRxDFCB[ii].abyAddr2,\r\npMACHeader->addr2)) {\r\nreturn ii;\r\n}\r\n}\r\nreturn pDevice->cbDFCB;\r\n}\r\nunsigned int WCTLuInsertDFCB(struct vnt_private *pDevice,\r\nstruct ieee80211_hdr *pMACHeader)\r\n{\r\nunsigned int ii;\r\nif (pDevice->cbFreeDFCB == 0)\r\nreturn(pDevice->cbDFCB);\r\nfor (ii = 0; ii < pDevice->cbDFCB; ii++) {\r\nif (pDevice->sRxDFCB[ii].bInUse == false) {\r\npDevice->cbFreeDFCB--;\r\npDevice->sRxDFCB[ii].uLifetime = pDevice->dwMaxReceiveLifetime;\r\npDevice->sRxDFCB[ii].bInUse = true;\r\npDevice->sRxDFCB[ii].wSequence = (pMACHeader->seq_ctrl >> 4);\r\npDevice->sRxDFCB[ii].wFragNum = (pMACHeader->seq_ctrl & 0x000F);\r\nmemcpy(&(pDevice->sRxDFCB[ii].abyAddr2[0]),\r\n&(pMACHeader->addr2[0]),\r\nETH_ALEN);\r\nreturn(ii);\r\n}\r\n}\r\nreturn(pDevice->cbDFCB);\r\n}\r\nbool WCTLbHandleFragment(struct vnt_private *pDevice, struct ieee80211_hdr *pMACHeader, unsigned int cbFrameLength, bool bWEP, bool bExtIV)\r\n{\r\nunsigned int uHeaderSize;\r\nif (bWEP == true) {\r\nuHeaderSize = 28;\r\nif (bExtIV)\r\nuHeaderSize +=4;\r\n}\r\nelse {\r\nuHeaderSize = 24;\r\n}\r\nif (IS_FIRST_FRAGMENT_PKT(pMACHeader)) {\r\npDevice->uCurrentDFCBIdx = WCTLuSearchDFCB(pDevice, pMACHeader);\r\nif (pDevice->uCurrentDFCBIdx < pDevice->cbDFCB) {\r\npDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].uLifetime = pDevice->dwMaxReceiveLifetime;\r\npDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].wSequence = (pMACHeader->seq_ctrl >> 4);\r\npDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].wFragNum = (pMACHeader->seq_ctrl & 0x000F);\r\n}\r\nelse {\r\npDevice->uCurrentDFCBIdx = WCTLuInsertDFCB(pDevice, pMACHeader);\r\nif (pDevice->uCurrentDFCBIdx == pDevice->cbDFCB) {\r\nreturn(false);\r\n}\r\n}\r\npDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].pbyRxBuffer = (u8 *) (pDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].skb->data + 8);\r\nmemcpy(pDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].pbyRxBuffer, pMACHeader, cbFrameLength);\r\npDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].cbFrameLength = cbFrameLength;\r\npDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].pbyRxBuffer += cbFrameLength;\r\npDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].wFragNum++;\r\nreturn(false);\r\n}\r\nelse {\r\npDevice->uCurrentDFCBIdx = WCTLuSearchDFCB(pDevice, pMACHeader);\r\nif (pDevice->uCurrentDFCBIdx != pDevice->cbDFCB) {\r\nif ((pDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].wSequence == (pMACHeader->seq_ctrl >> 4)) &&\r\n(pDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].wFragNum == (pMACHeader->seq_ctrl & 0x000F)) &&\r\n((pDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].cbFrameLength + cbFrameLength - uHeaderSize) < 2346)) {\r\nmemcpy(pDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].pbyRxBuffer, ((u8 *) (pMACHeader) + uHeaderSize), (cbFrameLength - uHeaderSize));\r\npDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].cbFrameLength += (cbFrameLength - uHeaderSize);\r\npDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].pbyRxBuffer += (cbFrameLength - uHeaderSize);\r\npDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].wFragNum++;\r\n}\r\nelse {\r\npDevice->cbFreeDFCB++;\r\npDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].bInUse = false;\r\nreturn(false);\r\n}\r\n}\r\nelse {\r\nreturn(false);\r\n}\r\nif (IS_LAST_FRAGMENT_PKT(pMACHeader)) {\r\npDevice->cbFreeDFCB++;\r\npDevice->sRxDFCB[pDevice->uCurrentDFCBIdx].bInUse = false;\r\nreturn(true);\r\n}\r\nreturn(false);\r\n}\r\n}

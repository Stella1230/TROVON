static int __init mx31_3ds_init_camera(void)\r\n{\r\nint dma, ret = -ENOMEM;\r\nstruct platform_device *pdev =\r\nimx31_alloc_mx3_camera(&mx31_3ds_camera_pdata);\r\nif (IS_ERR(pdev))\r\nreturn PTR_ERR(pdev);\r\nif (!mx3_camera_base)\r\ngoto err;\r\ndma = dma_declare_coherent_memory(&pdev->dev,\r\nmx3_camera_base, mx3_camera_base,\r\nMX31_3DS_CAMERA_BUF_SIZE,\r\nDMA_MEMORY_MAP | DMA_MEMORY_EXCLUSIVE);\r\nif (!(dma & DMA_MEMORY_MAP))\r\ngoto err;\r\nret = platform_device_add(pdev);\r\nif (ret)\r\nerr:\r\nplatform_device_put(pdev);\r\nreturn ret;\r\n}\r\nstatic int mx31_3ds_camera_power(struct device *dev, int on)\r\n{\r\npr_debug("%s: %s the camera\n", __func__, on ? "ENABLE" : "DISABLE");\r\ngpio_set_value(MX31_3DS_GPIO_CAMERA_PW, on ? 0 : 1);\r\nif (!on)\r\ngoto out;\r\ngpio_set_value(MX31_3DS_GPIO_CAMERA_RST, 0);\r\nmsleep(20);\r\ngpio_set_value(MX31_3DS_GPIO_CAMERA_RST, 1);\r\nmsleep(100);\r\nout:\r\nreturn 0;\r\n}\r\nstatic int mx31_3ds_sdhc1_init(struct device *dev,\r\nirq_handler_t detect_irq,\r\nvoid *data)\r\n{\r\nint ret;\r\nret = gpio_request_array(mx31_3ds_sdhc1_gpios,\r\nARRAY_SIZE(mx31_3ds_sdhc1_gpios));\r\nif (ret) {\r\npr_warning("Unable to request the SD/MMC GPIOs.\n");\r\nreturn ret;\r\n}\r\nret = request_irq(gpio_to_irq(IOMUX_TO_GPIO(MX31_PIN_GPIO3_1)),\r\ndetect_irq,\r\nIRQF_TRIGGER_FALLING | IRQF_TRIGGER_RISING,\r\n"sdhc1-detect", data);\r\nif (ret) {\r\npr_warning("Unable to request the SD/MMC card-detect IRQ.\n");\r\ngoto gpio_free;\r\n}\r\nreturn 0;\r\ngpio_free:\r\ngpio_free_array(mx31_3ds_sdhc1_gpios,\r\nARRAY_SIZE(mx31_3ds_sdhc1_gpios));\r\nreturn ret;\r\n}\r\nstatic void mx31_3ds_sdhc1_exit(struct device *dev, void *data)\r\n{\r\nfree_irq(gpio_to_irq(IOMUX_TO_GPIO(MX31_PIN_GPIO3_1)), data);\r\ngpio_free_array(mx31_3ds_sdhc1_gpios,\r\nARRAY_SIZE(mx31_3ds_sdhc1_gpios));\r\n}\r\nstatic void mx31_3ds_sdhc1_setpower(struct device *dev, unsigned int vdd)\r\n{\r\nif (vdd > 7)\r\ngpio_set_value(MX31_3DS_GPIO_SDHC1_BE, 1);\r\nelse\r\ngpio_set_value(MX31_3DS_GPIO_SDHC1_BE, 0);\r\n}\r\nstatic int mx31_3ds_usbotg_init(void)\r\n{\r\nint err;\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_DATA0, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_DATA1, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_DATA2, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_DATA3, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_DATA4, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_DATA5, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_DATA6, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_DATA7, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_CLK, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_DIR, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_NXT, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBOTG_STP, USB_PAD_CFG);\r\nerr = gpio_request(USBOTG_RST_B, "otgusb-reset");\r\nif (err) {\r\npr_err("Failed to request the USB OTG reset gpio\n");\r\nreturn err;\r\n}\r\nerr = gpio_direction_output(USBOTG_RST_B, 0);\r\nif (err) {\r\npr_err("Failed to drive the USB OTG reset gpio\n");\r\ngoto usbotg_free_reset;\r\n}\r\nmdelay(1);\r\ngpio_set_value(USBOTG_RST_B, 1);\r\nreturn 0;\r\nusbotg_free_reset:\r\ngpio_free(USBOTG_RST_B);\r\nreturn err;\r\n}\r\nstatic int mx31_3ds_otg_init(struct platform_device *pdev)\r\n{\r\nreturn mx31_initialize_usb_hw(pdev->id, MXC_EHCI_POWER_PINS_ENABLED);\r\n}\r\nstatic int mx31_3ds_host2_init(struct platform_device *pdev)\r\n{\r\nint err;\r\nmxc_iomux_set_pad(MX31_PIN_USBH2_CLK, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBH2_DIR, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBH2_NXT, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBH2_STP, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBH2_DATA0, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_USBH2_DATA1, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_PC_VS2, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_PC_BVD1, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_PC_BVD2, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_PC_RST, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_IOIS16, USB_PAD_CFG);\r\nmxc_iomux_set_pad(MX31_PIN_PC_RW_B, USB_PAD_CFG);\r\nerr = gpio_request(USBH2_RST_B, "usbh2-reset");\r\nif (err) {\r\npr_err("Failed to request the USB Host 2 reset gpio\n");\r\nreturn err;\r\n}\r\nerr = gpio_direction_output(USBH2_RST_B, 0);\r\nif (err) {\r\npr_err("Failed to drive the USB Host 2 reset gpio\n");\r\ngoto usbotg_free_reset;\r\n}\r\nmdelay(1);\r\ngpio_set_value(USBH2_RST_B, 1);\r\nmdelay(10);\r\nreturn mx31_initialize_usb_hw(pdev->id, MXC_EHCI_POWER_PINS_ENABLED);\r\nusbotg_free_reset:\r\ngpio_free(USBH2_RST_B);\r\nreturn err;\r\n}\r\nstatic int __init mx31_3ds_otg_mode(char *options)\r\n{\r\nif (!strcmp(options, "host"))\r\notg_mode_host = true;\r\nelse if (!strcmp(options, "device"))\r\notg_mode_host = false;\r\nelse\r\npr_info("otg_mode neither \"host\" nor \"device\". "\r\n"Defaulting to device\n");\r\nreturn 1;\r\n}\r\nstatic void __init mx31_3ds_init(void)\r\n{\r\nint ret;\r\nimx31_soc_init();\r\nmxc_iomux_set_gpr(MUX_PGP_CSPI_BB, true);\r\nmxc_iomux_setup_multiple_pins(mx31_3ds_pins, ARRAY_SIZE(mx31_3ds_pins),\r\n"mx31_3ds");\r\nimx31_add_imx_uart0(&uart_pdata);\r\nimx31_add_mxc_nand(&mx31_3ds_nand_board_info);\r\nimx31_add_spi_imx1(&spi1_pdata);\r\nmx31_3ds_spi_devs[0].irq = gpio_to_irq(IOMUX_TO_GPIO(MX31_PIN_GPIO1_3));\r\nspi_register_board_info(mx31_3ds_spi_devs,\r\nARRAY_SIZE(mx31_3ds_spi_devs));\r\nplatform_add_devices(devices, ARRAY_SIZE(devices));\r\nimx31_add_imx_keypad(&mx31_3ds_keymap_data);\r\nmx31_3ds_usbotg_init();\r\nif (otg_mode_host) {\r\notg_pdata.otg = imx_otg_ulpi_create(ULPI_OTG_DRVVBUS |\r\nULPI_OTG_DRVVBUS_EXT);\r\nif (otg_pdata.otg)\r\nimx31_add_mxc_ehci_otg(&otg_pdata);\r\n}\r\nusbh2_pdata.otg = imx_otg_ulpi_create(ULPI_OTG_DRVVBUS |\r\nULPI_OTG_DRVVBUS_EXT);\r\nif (usbh2_pdata.otg)\r\nimx31_add_mxc_ehci_hs(2, &usbh2_pdata);\r\nif (!otg_mode_host)\r\nimx31_add_fsl_usb2_udc(&usbotg_pdata);\r\nif (mxc_expio_init(MX31_CS5_BASE_ADDR, IOMUX_TO_GPIO(MX31_PIN_GPIO1_1)))\r\nprintk(KERN_WARNING "Init of the debug board failed, all "\r\n"devices on the debug board are unusable.\n");\r\nimx31_add_imx2_wdt();\r\nimx31_add_imx_i2c0(&mx31_3ds_i2c0_data);\r\nimx31_add_mxc_mmc(0, &sdhc1_pdata);\r\nimx31_add_spi_imx0(&spi0_pdata);\r\nimx31_add_ipu_core();\r\nimx31_add_mx3_sdc_fb(&mx3fb_pdata);\r\nret = gpio_request_array(mx31_3ds_camera_gpios,\r\nARRAY_SIZE(mx31_3ds_camera_gpios));\r\nif (ret) {\r\npr_err("Failed to request camera gpios");\r\niclink_ov2640.power = NULL;\r\n}\r\nmx31_3ds_init_camera();\r\nimx31_add_imx_ssi(0, &mx31_3ds_ssi_pdata);\r\nimx_add_platform_device("imx_mc13783", 0, NULL, 0, NULL, 0);\r\n}\r\nstatic void __init mx31_3ds_timer_init(void)\r\n{\r\nmx31_clocks_init(26000000);\r\n}\r\nstatic void __init mx31_3ds_reserve(void)\r\n{\r\nmx3_camera_base = arm_memblock_steal(MX31_3DS_CAMERA_BUF_SIZE,\r\nMX31_3DS_CAMERA_BUF_SIZE);\r\n}

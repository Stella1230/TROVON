static irqreturn_t handle_event(int irq, void *p)\r\n{\r\nstruct rproc *rproc = (struct rproc *)p;\r\nrproc_vq_interrupt(rproc, 0);\r\nrproc_vq_interrupt(rproc, 1);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t da8xx_rproc_callback(int irq, void *p)\r\n{\r\nstruct rproc *rproc = (struct rproc *)p;\r\nstruct da8xx_rproc *drproc = (struct da8xx_rproc *)rproc->priv;\r\nu32 chipsig;\r\nchipsig = readl(drproc->chipsig);\r\nif (chipsig & SYSCFG_CHIPSIG0) {\r\nwritel(SYSCFG_CHIPSIG0, drproc->chipsig + 4);\r\ndrproc->ack_fxn(drproc->irq_data);\r\nreturn IRQ_WAKE_THREAD;\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int da8xx_rproc_start(struct rproc *rproc)\r\n{\r\nstruct device *dev = rproc->dev.parent;\r\nstruct da8xx_rproc *drproc = (struct da8xx_rproc *)rproc->priv;\r\nstruct clk *dsp_clk = drproc->dsp_clk;\r\nif (rproc->bootaddr & 0x3ff) {\r\ndev_err(dev, "invalid boot address: must be aligned to 1KB\n");\r\nreturn -EINVAL;\r\n}\r\nwritel(rproc->bootaddr, drproc->bootreg);\r\nclk_enable(dsp_clk);\r\ndavinci_clk_reset_deassert(dsp_clk);\r\nreturn 0;\r\n}\r\nstatic int da8xx_rproc_stop(struct rproc *rproc)\r\n{\r\nstruct da8xx_rproc *drproc = rproc->priv;\r\nclk_disable(drproc->dsp_clk);\r\nreturn 0;\r\n}\r\nstatic void da8xx_rproc_kick(struct rproc *rproc, int vqid)\r\n{\r\nstruct da8xx_rproc *drproc = (struct da8xx_rproc *)rproc->priv;\r\nwritel(SYSCFG_CHIPSIG2, drproc->chipsig);\r\n}\r\nstatic int reset_assert(struct device *dev)\r\n{\r\nstruct clk *dsp_clk;\r\ndsp_clk = clk_get(dev, NULL);\r\nif (IS_ERR(dsp_clk)) {\r\ndev_err(dev, "clk_get error: %ld\n", PTR_ERR(dsp_clk));\r\nreturn PTR_ERR(dsp_clk);\r\n}\r\ndavinci_clk_reset_assert(dsp_clk);\r\nclk_put(dsp_clk);\r\nreturn 0;\r\n}\r\nstatic int da8xx_rproc_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct da8xx_rproc *drproc;\r\nstruct rproc *rproc;\r\nstruct irq_data *irq_data;\r\nstruct resource *bootreg_res;\r\nstruct resource *chipsig_res;\r\nstruct clk *dsp_clk;\r\nvoid __iomem *chipsig;\r\nvoid __iomem *bootreg;\r\nint irq;\r\nint ret;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\ndev_err(dev, "platform_get_irq(pdev, 0) error: %d\n", irq);\r\nreturn irq;\r\n}\r\nirq_data = irq_get_irq_data(irq);\r\nif (!irq_data) {\r\ndev_err(dev, "irq_get_irq_data(%d): NULL\n", irq);\r\nreturn -EINVAL;\r\n}\r\nbootreg_res = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!bootreg_res) {\r\ndev_err(dev,\r\n"platform_get_resource(IORESOURCE_MEM, 0): NULL\n");\r\nreturn -EADDRNOTAVAIL;\r\n}\r\nchipsig_res = platform_get_resource(pdev, IORESOURCE_MEM, 1);\r\nif (!chipsig_res) {\r\ndev_err(dev,\r\n"platform_get_resource(IORESOURCE_MEM, 1): NULL\n");\r\nreturn -EADDRNOTAVAIL;\r\n}\r\nbootreg = devm_ioremap_resource(dev, bootreg_res);\r\nif (IS_ERR(bootreg))\r\nreturn PTR_ERR(bootreg);\r\nchipsig = devm_ioremap_resource(dev, chipsig_res);\r\nif (IS_ERR(chipsig))\r\nreturn PTR_ERR(chipsig);\r\ndsp_clk = devm_clk_get(dev, NULL);\r\nif (IS_ERR(dsp_clk)) {\r\ndev_err(dev, "clk_get error: %ld\n", PTR_ERR(dsp_clk));\r\nreturn PTR_ERR(dsp_clk);\r\n}\r\nrproc = rproc_alloc(dev, "dsp", &da8xx_rproc_ops, da8xx_fw_name,\r\nsizeof(*drproc));\r\nif (!rproc)\r\nreturn -ENOMEM;\r\ndrproc = rproc->priv;\r\ndrproc->rproc = rproc;\r\nplatform_set_drvdata(pdev, rproc);\r\nret = devm_request_threaded_irq(dev, irq, da8xx_rproc_callback,\r\nhandle_event, 0, "da8xx-remoteproc",\r\nrproc);\r\nif (ret) {\r\ndev_err(dev, "devm_request_threaded_irq error: %d\n", ret);\r\ngoto free_rproc;\r\n}\r\nret = reset_assert(dev);\r\nif (ret)\r\ngoto free_rproc;\r\ndrproc->chipsig = chipsig;\r\ndrproc->bootreg = bootreg;\r\ndrproc->ack_fxn = irq_data->chip->irq_ack;\r\ndrproc->irq_data = irq_data;\r\ndrproc->irq = irq;\r\ndrproc->dsp_clk = dsp_clk;\r\nret = rproc_add(rproc);\r\nif (ret) {\r\ndev_err(dev, "rproc_add failed: %d\n", ret);\r\ngoto free_rproc;\r\n}\r\nreturn 0;\r\nfree_rproc:\r\nrproc_put(rproc);\r\nreturn ret;\r\n}\r\nstatic int da8xx_rproc_remove(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct rproc *rproc = platform_get_drvdata(pdev);\r\nstruct da8xx_rproc *drproc = (struct da8xx_rproc *)rproc->priv;\r\nreset_assert(dev);\r\ndisable_irq(drproc->irq);\r\ndevm_clk_put(dev, drproc->dsp_clk);\r\nrproc_del(rproc);\r\nrproc_put(rproc);\r\nreturn 0;\r\n}

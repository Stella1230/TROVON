ieee754dp ieee754dp_mul(ieee754dp x, ieee754dp y)\r\n{\r\nCOMPXDP;\r\nCOMPYDP;\r\nEXPLODEXDP;\r\nEXPLODEYDP;\r\nCLEARCX;\r\nFLUSHXDP;\r\nFLUSHYDP;\r\nswitch (CLPAIR(xc, yc)) {\r\ncase CLPAIR(IEEE754_CLASS_SNAN, IEEE754_CLASS_QNAN):\r\ncase CLPAIR(IEEE754_CLASS_QNAN, IEEE754_CLASS_SNAN):\r\ncase CLPAIR(IEEE754_CLASS_SNAN, IEEE754_CLASS_SNAN):\r\ncase CLPAIR(IEEE754_CLASS_ZERO, IEEE754_CLASS_SNAN):\r\ncase CLPAIR(IEEE754_CLASS_NORM, IEEE754_CLASS_SNAN):\r\ncase CLPAIR(IEEE754_CLASS_DNORM, IEEE754_CLASS_SNAN):\r\ncase CLPAIR(IEEE754_CLASS_INF, IEEE754_CLASS_SNAN):\r\ncase CLPAIR(IEEE754_CLASS_SNAN, IEEE754_CLASS_ZERO):\r\ncase CLPAIR(IEEE754_CLASS_SNAN, IEEE754_CLASS_NORM):\r\ncase CLPAIR(IEEE754_CLASS_SNAN, IEEE754_CLASS_DNORM):\r\ncase CLPAIR(IEEE754_CLASS_SNAN, IEEE754_CLASS_INF):\r\nSETCX(IEEE754_INVALID_OPERATION);\r\nreturn ieee754dp_nanxcpt(ieee754dp_indef(), "mul", x, y);\r\ncase CLPAIR(IEEE754_CLASS_ZERO, IEEE754_CLASS_QNAN):\r\ncase CLPAIR(IEEE754_CLASS_NORM, IEEE754_CLASS_QNAN):\r\ncase CLPAIR(IEEE754_CLASS_DNORM, IEEE754_CLASS_QNAN):\r\ncase CLPAIR(IEEE754_CLASS_INF, IEEE754_CLASS_QNAN):\r\nreturn y;\r\ncase CLPAIR(IEEE754_CLASS_QNAN, IEEE754_CLASS_QNAN):\r\ncase CLPAIR(IEEE754_CLASS_QNAN, IEEE754_CLASS_ZERO):\r\ncase CLPAIR(IEEE754_CLASS_QNAN, IEEE754_CLASS_NORM):\r\ncase CLPAIR(IEEE754_CLASS_QNAN, IEEE754_CLASS_DNORM):\r\ncase CLPAIR(IEEE754_CLASS_QNAN, IEEE754_CLASS_INF):\r\nreturn x;\r\ncase CLPAIR(IEEE754_CLASS_INF, IEEE754_CLASS_ZERO):\r\ncase CLPAIR(IEEE754_CLASS_ZERO, IEEE754_CLASS_INF):\r\nSETCX(IEEE754_INVALID_OPERATION);\r\nreturn ieee754dp_xcpt(ieee754dp_indef(), "mul", x, y);\r\ncase CLPAIR(IEEE754_CLASS_NORM, IEEE754_CLASS_INF):\r\ncase CLPAIR(IEEE754_CLASS_DNORM, IEEE754_CLASS_INF):\r\ncase CLPAIR(IEEE754_CLASS_INF, IEEE754_CLASS_NORM):\r\ncase CLPAIR(IEEE754_CLASS_INF, IEEE754_CLASS_DNORM):\r\ncase CLPAIR(IEEE754_CLASS_INF, IEEE754_CLASS_INF):\r\nreturn ieee754dp_inf(xs ^ ys);\r\ncase CLPAIR(IEEE754_CLASS_ZERO, IEEE754_CLASS_ZERO):\r\ncase CLPAIR(IEEE754_CLASS_ZERO, IEEE754_CLASS_NORM):\r\ncase CLPAIR(IEEE754_CLASS_ZERO, IEEE754_CLASS_DNORM):\r\ncase CLPAIR(IEEE754_CLASS_NORM, IEEE754_CLASS_ZERO):\r\ncase CLPAIR(IEEE754_CLASS_DNORM, IEEE754_CLASS_ZERO):\r\nreturn ieee754dp_zero(xs ^ ys);\r\ncase CLPAIR(IEEE754_CLASS_DNORM, IEEE754_CLASS_DNORM):\r\nDPDNORMX;\r\ncase CLPAIR(IEEE754_CLASS_NORM, IEEE754_CLASS_DNORM):\r\nDPDNORMY;\r\nbreak;\r\ncase CLPAIR(IEEE754_CLASS_DNORM, IEEE754_CLASS_NORM):\r\nDPDNORMX;\r\nbreak;\r\ncase CLPAIR(IEEE754_CLASS_NORM, IEEE754_CLASS_NORM):\r\nbreak;\r\n}\r\nassert(xm & DP_HIDDEN_BIT);\r\nassert(ym & DP_HIDDEN_BIT);\r\n{\r\nint re = xe + ye;\r\nint rs = xs ^ ys;\r\nu64 rm;\r\nxm <<= 64 - (DP_MBITS + 1);\r\nym <<= 64 - (DP_MBITS + 1);\r\n#define DPXMULT(x, y) ((u64)(x) * (u64)y)\r\n{\r\nunsigned lxm = xm;\r\nunsigned hxm = xm >> 32;\r\nunsigned lym = ym;\r\nunsigned hym = ym >> 32;\r\nu64 lrm;\r\nu64 hrm;\r\nlrm = DPXMULT(lxm, lym);\r\nhrm = DPXMULT(hxm, hym);\r\n{\r\nu64 t = DPXMULT(lxm, hym);\r\n{\r\nu64 at =\r\nlrm + (t << 32);\r\nhrm += at < lrm;\r\nlrm = at;\r\n}\r\nhrm = hrm + (t >> 32);\r\n}\r\n{\r\nu64 t = DPXMULT(hxm, lym);\r\n{\r\nu64 at =\r\nlrm + (t << 32);\r\nhrm += at < lrm;\r\nlrm = at;\r\n}\r\nhrm = hrm + (t >> 32);\r\n}\r\nrm = hrm | (lrm != 0);\r\n}\r\nif ((s64) rm < 0) {\r\nrm =\r\n(rm >> (64 - (DP_MBITS + 1 + 3))) |\r\n((rm << (DP_MBITS + 1 + 3)) != 0);\r\nre++;\r\n} else {\r\nrm =\r\n(rm >> (64 - (DP_MBITS + 1 + 3 + 1))) |\r\n((rm << (DP_MBITS + 1 + 3 + 1)) != 0);\r\n}\r\nassert(rm & (DP_HIDDEN_BIT << 3));\r\nDPNORMRET2(rs, re, rm, "mul", x, y);\r\n}\r\n}

static irqreturn_t ad799x_trigger_handler(int irq, void *p)\r\n{\r\nstruct iio_poll_func *pf = p;\r\nstruct iio_dev *indio_dev = pf->indio_dev;\r\nstruct ad799x_state *st = iio_priv(indio_dev);\r\nint b_sent;\r\nu8 cmd;\r\nswitch (st->id) {\r\ncase ad7991:\r\ncase ad7995:\r\ncase ad7999:\r\ncmd = st->config |\r\n(*indio_dev->active_scan_mask << AD799X_CHANNEL_SHIFT);\r\nbreak;\r\ncase ad7992:\r\ncase ad7993:\r\ncase ad7994:\r\ncmd = (*indio_dev->active_scan_mask << AD799X_CHANNEL_SHIFT) |\r\nAD7998_CONV_RES_REG;\r\nbreak;\r\ncase ad7997:\r\ncase ad7998:\r\ncmd = AD7997_8_READ_SEQUENCE | AD7998_CONV_RES_REG;\r\nbreak;\r\ndefault:\r\ncmd = 0;\r\n}\r\nb_sent = i2c_smbus_read_i2c_block_data(st->client,\r\ncmd, st->transfer_size, st->rx_buf);\r\nif (b_sent < 0)\r\ngoto out;\r\niio_push_to_buffers_with_timestamp(indio_dev, st->rx_buf,\r\niio_get_time_ns());\r\nout:\r\niio_trigger_notify_done(indio_dev->trig);\r\nreturn IRQ_HANDLED;\r\n}\r\nint ad799x_register_ring_funcs_and_init(struct iio_dev *indio_dev)\r\n{\r\nreturn iio_triggered_buffer_setup(indio_dev, NULL,\r\n&ad799x_trigger_handler, NULL);\r\n}\r\nvoid ad799x_ring_cleanup(struct iio_dev *indio_dev)\r\n{\r\niio_triggered_buffer_cleanup(indio_dev);\r\n}

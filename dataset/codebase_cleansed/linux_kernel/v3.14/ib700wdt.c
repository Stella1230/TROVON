static void ibwdt_ping(void)\r\n{\r\nint wd_margin = 15 - ((timeout + 1) / 2);\r\nspin_lock(&ibwdt_lock);\r\noutb_p(wd_margin, WDT_START);\r\nspin_unlock(&ibwdt_lock);\r\n}\r\nstatic void ibwdt_disable(void)\r\n{\r\nspin_lock(&ibwdt_lock);\r\noutb_p(0, WDT_STOP);\r\nspin_unlock(&ibwdt_lock);\r\n}\r\nstatic int ibwdt_set_heartbeat(int t)\r\n{\r\nif (t < 0 || t > 30)\r\nreturn -EINVAL;\r\ntimeout = t;\r\nreturn 0;\r\n}\r\nstatic ssize_t ibwdt_write(struct file *file, const char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nif (count) {\r\nif (!nowayout) {\r\nsize_t i;\r\nexpect_close = 0;\r\nfor (i = 0; i != count; i++) {\r\nchar c;\r\nif (get_user(c, buf + i))\r\nreturn -EFAULT;\r\nif (c == 'V')\r\nexpect_close = 42;\r\n}\r\n}\r\nibwdt_ping();\r\n}\r\nreturn count;\r\n}\r\nstatic long ibwdt_ioctl(struct file *file, unsigned int cmd, unsigned long arg)\r\n{\r\nint new_margin;\r\nvoid __user *argp = (void __user *)arg;\r\nint __user *p = argp;\r\nstatic const struct watchdog_info ident = {\r\n.options = WDIOF_KEEPALIVEPING | WDIOF_SETTIMEOUT\r\n| WDIOF_MAGICCLOSE,\r\n.firmware_version = 1,\r\n.identity = "IB700 WDT",\r\n};\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nif (copy_to_user(argp, &ident, sizeof(ident)))\r\nreturn -EFAULT;\r\nbreak;\r\ncase WDIOC_GETSTATUS:\r\ncase WDIOC_GETBOOTSTATUS:\r\nreturn put_user(0, p);\r\ncase WDIOC_SETOPTIONS:\r\n{\r\nint options, retval = -EINVAL;\r\nif (get_user(options, p))\r\nreturn -EFAULT;\r\nif (options & WDIOS_DISABLECARD) {\r\nibwdt_disable();\r\nretval = 0;\r\n}\r\nif (options & WDIOS_ENABLECARD) {\r\nibwdt_ping();\r\nretval = 0;\r\n}\r\nreturn retval;\r\n}\r\ncase WDIOC_KEEPALIVE:\r\nibwdt_ping();\r\nbreak;\r\ncase WDIOC_SETTIMEOUT:\r\nif (get_user(new_margin, p))\r\nreturn -EFAULT;\r\nif (ibwdt_set_heartbeat(new_margin))\r\nreturn -EINVAL;\r\nibwdt_ping();\r\ncase WDIOC_GETTIMEOUT:\r\nreturn put_user(timeout, p);\r\ndefault:\r\nreturn -ENOTTY;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ibwdt_open(struct inode *inode, struct file *file)\r\n{\r\nif (test_and_set_bit(0, &ibwdt_is_open))\r\nreturn -EBUSY;\r\nif (nowayout)\r\n__module_get(THIS_MODULE);\r\nibwdt_ping();\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic int ibwdt_close(struct inode *inode, struct file *file)\r\n{\r\nif (expect_close == 42) {\r\nibwdt_disable();\r\n} else {\r\npr_crit("WDT device closed unexpectedly. WDT will not stop!\n");\r\nibwdt_ping();\r\n}\r\nclear_bit(0, &ibwdt_is_open);\r\nexpect_close = 0;\r\nreturn 0;\r\n}\r\nstatic int ibwdt_probe(struct platform_device *dev)\r\n{\r\nint res;\r\n#if WDT_START != WDT_STOP\r\nif (!request_region(WDT_STOP, 1, "IB700 WDT")) {\r\npr_err("STOP method I/O %X is not available\n", WDT_STOP);\r\nres = -EIO;\r\ngoto out_nostopreg;\r\n}\r\n#endif\r\nif (!request_region(WDT_START, 1, "IB700 WDT")) {\r\npr_err("START method I/O %X is not available\n", WDT_START);\r\nres = -EIO;\r\ngoto out_nostartreg;\r\n}\r\nif (ibwdt_set_heartbeat(timeout)) {\r\nibwdt_set_heartbeat(WATCHDOG_TIMEOUT);\r\npr_info("timeout value must be 0<=x<=30, using %d\n", timeout);\r\n}\r\nres = misc_register(&ibwdt_miscdev);\r\nif (res) {\r\npr_err("failed to register misc device\n");\r\ngoto out_nomisc;\r\n}\r\nreturn 0;\r\nout_nomisc:\r\nrelease_region(WDT_START, 1);\r\nout_nostartreg:\r\n#if WDT_START != WDT_STOP\r\nrelease_region(WDT_STOP, 1);\r\n#endif\r\nout_nostopreg:\r\nreturn res;\r\n}\r\nstatic int ibwdt_remove(struct platform_device *dev)\r\n{\r\nmisc_deregister(&ibwdt_miscdev);\r\nrelease_region(WDT_START, 1);\r\n#if WDT_START != WDT_STOP\r\nrelease_region(WDT_STOP, 1);\r\n#endif\r\nreturn 0;\r\n}\r\nstatic void ibwdt_shutdown(struct platform_device *dev)\r\n{\r\nibwdt_disable();\r\n}\r\nstatic int __init ibwdt_init(void)\r\n{\r\nint err;\r\npr_info("WDT driver for IB700 single board computer initialising\n");\r\nerr = platform_driver_register(&ibwdt_driver);\r\nif (err)\r\nreturn err;\r\nibwdt_platform_device = platform_device_register_simple(DRV_NAME,\r\n-1, NULL, 0);\r\nif (IS_ERR(ibwdt_platform_device)) {\r\nerr = PTR_ERR(ibwdt_platform_device);\r\ngoto unreg_platform_driver;\r\n}\r\nreturn 0;\r\nunreg_platform_driver:\r\nplatform_driver_unregister(&ibwdt_driver);\r\nreturn err;\r\n}\r\nstatic void __exit ibwdt_exit(void)\r\n{\r\nplatform_device_unregister(ibwdt_platform_device);\r\nplatform_driver_unregister(&ibwdt_driver);\r\npr_info("Watchdog Module Unloaded\n");\r\n}

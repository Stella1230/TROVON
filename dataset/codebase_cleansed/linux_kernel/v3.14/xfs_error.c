int\r\nxfs_error_trap(int e)\r\n{\r\nint i;\r\nif (!e)\r\nreturn 0;\r\nfor (i = 0; i < XFS_ERROR_NTRAP; i++) {\r\nif (xfs_etrap[i] == 0)\r\nbreak;\r\nif (e != xfs_etrap[i])\r\ncontinue;\r\nxfs_notice(NULL, "%s: error %d", __func__, e);\r\nBUG();\r\nbreak;\r\n}\r\nreturn e;\r\n}\r\nint\r\nxfs_error_test(int error_tag, int *fsidp, char *expression,\r\nint line, char *file, unsigned long randfactor)\r\n{\r\nint i;\r\nint64_t fsid;\r\nif (prandom_u32() % randfactor)\r\nreturn 0;\r\nmemcpy(&fsid, fsidp, sizeof(xfs_fsid_t));\r\nfor (i = 0; i < XFS_NUM_INJECT_ERROR; i++) {\r\nif (xfs_etest[i] == error_tag && xfs_etest_fsid[i] == fsid) {\r\nxfs_warn(NULL,\r\n"Injecting error (%s) at file %s, line %d, on filesystem \"%s\"",\r\nexpression, file, line, xfs_etest_fsname[i]);\r\nreturn 1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint\r\nxfs_errortag_add(int error_tag, xfs_mount_t *mp)\r\n{\r\nint i;\r\nint len;\r\nint64_t fsid;\r\nmemcpy(&fsid, mp->m_fixedfsid, sizeof(xfs_fsid_t));\r\nfor (i = 0; i < XFS_NUM_INJECT_ERROR; i++) {\r\nif (xfs_etest_fsid[i] == fsid && xfs_etest[i] == error_tag) {\r\nxfs_warn(mp, "error tag #%d on", error_tag);\r\nreturn 0;\r\n}\r\n}\r\nfor (i = 0; i < XFS_NUM_INJECT_ERROR; i++) {\r\nif (xfs_etest[i] == 0) {\r\nxfs_warn(mp, "Turned on XFS error tag #%d",\r\nerror_tag);\r\nxfs_etest[i] = error_tag;\r\nxfs_etest_fsid[i] = fsid;\r\nlen = strlen(mp->m_fsname);\r\nxfs_etest_fsname[i] = kmem_alloc(len + 1, KM_SLEEP);\r\nstrcpy(xfs_etest_fsname[i], mp->m_fsname);\r\nxfs_error_test_active++;\r\nreturn 0;\r\n}\r\n}\r\nxfs_warn(mp, "error tag overflow, too many turned on");\r\nreturn 1;\r\n}\r\nint\r\nxfs_errortag_clearall(xfs_mount_t *mp, int loud)\r\n{\r\nint64_t fsid;\r\nint cleared = 0;\r\nint i;\r\nmemcpy(&fsid, mp->m_fixedfsid, sizeof(xfs_fsid_t));\r\nfor (i = 0; i < XFS_NUM_INJECT_ERROR; i++) {\r\nif ((fsid == 0LL || xfs_etest_fsid[i] == fsid) &&\r\nxfs_etest[i] != 0) {\r\ncleared = 1;\r\nxfs_warn(mp, "Clearing XFS error tag #%d",\r\nxfs_etest[i]);\r\nxfs_etest[i] = 0;\r\nxfs_etest_fsid[i] = 0LL;\r\nkmem_free(xfs_etest_fsname[i]);\r\nxfs_etest_fsname[i] = NULL;\r\nxfs_error_test_active--;\r\n}\r\n}\r\nif (loud || cleared)\r\nxfs_warn(mp, "Cleared all XFS error tags for filesystem");\r\nreturn 0;\r\n}\r\nvoid\r\nxfs_error_report(\r\nconst char *tag,\r\nint level,\r\nstruct xfs_mount *mp,\r\nconst char *filename,\r\nint linenum,\r\ninst_t *ra)\r\n{\r\nif (level <= xfs_error_level) {\r\nxfs_alert_tag(mp, XFS_PTAG_ERROR_REPORT,\r\n"Internal error %s at line %d of file %s. Caller 0x%p",\r\ntag, linenum, filename, ra);\r\nxfs_stack_trace();\r\n}\r\n}\r\nvoid\r\nxfs_corruption_error(\r\nconst char *tag,\r\nint level,\r\nstruct xfs_mount *mp,\r\nvoid *p,\r\nconst char *filename,\r\nint linenum,\r\ninst_t *ra)\r\n{\r\nif (level <= xfs_error_level)\r\nxfs_hex_dump(p, 64);\r\nxfs_error_report(tag, level, mp, filename, linenum, ra);\r\nxfs_alert(mp, "Corruption detected. Unmount and run xfs_repair");\r\n}

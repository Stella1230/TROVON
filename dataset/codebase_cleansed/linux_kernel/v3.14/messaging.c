void init_messaging(void)\r\n{\r\nHV_MsgState *state = &__get_cpu_var(msg_state);\r\nint rc = hv_register_message_state(state);\r\nif (rc != HV_OK)\r\npanic("hv_register_message_state: error %d", rc);\r\narch_local_irq_unmask(INT_INTCTRL_K);\r\n}\r\nvoid hv_message_intr(struct pt_regs *regs, int intnum)\r\n{\r\nint message[HV_MAX_MESSAGE_SIZE/sizeof(int)];\r\nHV_RcvMsgInfo rmi;\r\nint nmsgs = 0;\r\nstruct pt_regs *old_regs = set_irq_regs(regs);\r\nirq_enter();\r\n#ifdef CONFIG_DEBUG_STACKOVERFLOW\r\n{\r\nlong sp = stack_pointer - (long) current_thread_info();\r\nif (unlikely(sp < (sizeof(struct thread_info) + STACK_WARN))) {\r\npr_emerg("hv_message_intr: "\r\n"stack overflow: %ld\n",\r\nsp - sizeof(struct thread_info));\r\ndump_stack();\r\n}\r\n}\r\n#endif\r\nwhile (1) {\r\nrmi = hv_receive_message(__get_cpu_var(msg_state),\r\n(HV_VirtAddr) message,\r\nsizeof(message));\r\nif (rmi.msglen == 0)\r\nbreak;\r\nif (rmi.msglen < 0)\r\npanic("hv_receive_message failed: %d", rmi.msglen);\r\n++nmsgs;\r\nif (rmi.source == HV_MSG_TILE) {\r\nint tag;\r\nBUG_ON(rmi.msglen != sizeof(int));\r\ntag = message[0];\r\n#ifdef CONFIG_SMP\r\nevaluate_message(message[0]);\r\n#else\r\npanic("Received IPI message %d in UP mode", tag);\r\n#endif\r\n} else if (rmi.source == HV_MSG_INTR) {\r\nHV_IntrMsg *him = (HV_IntrMsg *)message;\r\nstruct hv_driver_cb *cb =\r\n(struct hv_driver_cb *)him->intarg;\r\ncb->callback(cb, him->intdata);\r\n__get_cpu_var(irq_stat).irq_hv_msg_count++;\r\n}\r\n}\r\nif (nmsgs == 0)\r\npanic("Message downcall invoked with no messages!");\r\nirq_exit();\r\nset_irq_regs(old_regs);\r\n}

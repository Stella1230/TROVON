static void udbg_uart_flush(void)\r\n{\r\nif (!udbg_uart_in)\r\nreturn;\r\nwhile ((udbg_uart_in(UART_LSR) & LSR_THRE) == 0)\r\ncpu_relax();\r\n}\r\nstatic void udbg_uart_putc(char c)\r\n{\r\nif (!udbg_uart_out)\r\nreturn;\r\nif (c == '\n')\r\nudbg_uart_putc('\r');\r\nudbg_uart_flush();\r\nudbg_uart_out(UART_THR, c);\r\n}\r\nstatic int udbg_uart_getc_poll(void)\r\n{\r\nif (!udbg_uart_in || !(udbg_uart_in(UART_LSR) & LSR_DR))\r\nreturn udbg_uart_in(UART_RBR);\r\nreturn -1;\r\n}\r\nstatic int udbg_uart_getc(void)\r\n{\r\nif (!udbg_uart_in)\r\nreturn -1;\r\nwhile (!(udbg_uart_in(UART_LSR) & LSR_DR))\r\ncpu_relax();\r\nreturn udbg_uart_in(UART_RBR);\r\n}\r\nstatic void udbg_use_uart(void)\r\n{\r\nudbg_putc = udbg_uart_putc;\r\nudbg_flush = udbg_uart_flush;\r\nudbg_getc = udbg_uart_getc;\r\nudbg_getc_poll = udbg_uart_getc_poll;\r\n}\r\nvoid udbg_uart_setup(unsigned int speed, unsigned int clock)\r\n{\r\nunsigned int dll, base_bauds;\r\nif (!udbg_uart_out)\r\nreturn;\r\nif (clock == 0)\r\nclock = 1843200;\r\nif (speed == 0)\r\nspeed = 9600;\r\nbase_bauds = clock / 16;\r\ndll = base_bauds / speed;\r\nudbg_uart_out(UART_LCR, 0x00);\r\nudbg_uart_out(UART_IER, 0xff);\r\nudbg_uart_out(UART_IER, 0x00);\r\nudbg_uart_out(UART_LCR, LCR_DLAB);\r\nudbg_uart_out(UART_DLL, dll & 0xff);\r\nudbg_uart_out(UART_DLM, dll >> 8);\r\nudbg_uart_out(UART_LCR, 0x3);\r\nudbg_uart_out(UART_MCR, 0x3);\r\nudbg_uart_out(UART_FCR, 0x7);\r\n}\r\nunsigned int udbg_probe_uart_speed(unsigned int clock)\r\n{\r\nunsigned int dll, dlm, divisor, prescaler, speed;\r\nu8 old_lcr;\r\nold_lcr = udbg_uart_in(UART_LCR);\r\nudbg_uart_out(UART_LCR, old_lcr | LCR_DLAB);\r\ndll = udbg_uart_in(UART_DLL);\r\ndlm = udbg_uart_in(UART_DLM);\r\ndivisor = dlm << 8 | dll;\r\nif (udbg_uart_in(UART_MCR) & 0x80)\r\nprescaler = 4;\r\nelse\r\nprescaler = 1;\r\nudbg_uart_out(UART_LCR, old_lcr);\r\nspeed = (clock / prescaler) / (divisor * 16);\r\nif (speed > (clock / 16))\r\nspeed = 9600;\r\nreturn speed;\r\n}\r\nstatic u8 udbg_uart_in_pio(unsigned int reg)\r\n{\r\nreturn inb(udbg_uart.pio_base + (reg * udbg_uart_stride));\r\n}\r\nstatic void udbg_uart_out_pio(unsigned int reg, u8 data)\r\n{\r\noutb(data, udbg_uart.pio_base + (reg * udbg_uart_stride));\r\n}\r\nvoid udbg_uart_init_pio(unsigned long port, unsigned int stride)\r\n{\r\nif (!port)\r\nreturn;\r\nudbg_uart.pio_base = port;\r\nudbg_uart_stride = stride;\r\nudbg_uart_in = udbg_uart_in_pio;\r\nudbg_uart_out = udbg_uart_out_pio;\r\nudbg_use_uart();\r\n}\r\nstatic u8 udbg_uart_in_mmio(unsigned int reg)\r\n{\r\nreturn in_8(udbg_uart.mmio_base + (reg * udbg_uart_stride));\r\n}\r\nstatic void udbg_uart_out_mmio(unsigned int reg, u8 data)\r\n{\r\nout_8(udbg_uart.mmio_base + (reg * udbg_uart_stride), data);\r\n}\r\nvoid udbg_uart_init_mmio(void __iomem *addr, unsigned int stride)\r\n{\r\nif (!addr)\r\nreturn;\r\nudbg_uart.mmio_base = addr;\r\nudbg_uart_stride = stride;\r\nudbg_uart_in = udbg_uart_in_mmio;\r\nudbg_uart_out = udbg_uart_out_mmio;\r\nudbg_use_uart();\r\n}\r\nstatic u8 udbg_uart_in_maple(unsigned int reg)\r\n{\r\nreturn real_readb(UDBG_UART_MAPLE_ADDR + reg);\r\n}\r\nstatic void udbg_uart_out_maple(unsigned int reg, u8 val)\r\n{\r\nreal_writeb(val, UDBG_UART_MAPLE_ADDR + reg);\r\n}\r\nvoid __init udbg_init_maple_realmode(void)\r\n{\r\nudbg_uart_in = udbg_uart_in_maple;\r\nudbg_uart_out = udbg_uart_out_maple;\r\nudbg_use_uart();\r\n}\r\nstatic u8 udbg_uart_in_pas(unsigned int reg)\r\n{\r\nreturn real_205_readb(UDBG_UART_PAS_ADDR + reg);\r\n}\r\nstatic void udbg_uart_out_pas(unsigned int reg, u8 val)\r\n{\r\nreal_205_writeb(val, UDBG_UART_PAS_ADDR + reg);\r\n}\r\nvoid __init udbg_init_pas_realmode(void)\r\n{\r\nudbg_uart_in = udbg_uart_in_pas;\r\nudbg_uart_out = udbg_uart_out_pas;\r\nudbg_use_uart();\r\n}\r\nstatic u8 udbg_uart_in_44x_as1(unsigned int reg)\r\n{\r\nreturn as1_readb((void __iomem *)PPC44x_EARLY_DEBUG_VIRTADDR + reg);\r\n}\r\nstatic void udbg_uart_out_44x_as1(unsigned int reg, u8 val)\r\n{\r\nas1_writeb(val, (void __iomem *)PPC44x_EARLY_DEBUG_VIRTADDR + reg);\r\n}\r\nvoid __init udbg_init_44x_as1(void)\r\n{\r\nudbg_uart_in = udbg_uart_in_44x_as1;\r\nudbg_uart_out = udbg_uart_out_44x_as1;\r\nudbg_use_uart();\r\n}\r\nstatic u8 udbg_uart_in_40x(unsigned int reg)\r\n{\r\nreturn real_readb((void __iomem *)CONFIG_PPC_EARLY_DEBUG_40x_PHYSADDR\r\n+ reg);\r\n}\r\nstatic void udbg_uart_out_40x(unsigned int reg, u8 val)\r\n{\r\nreal_writeb(val, (void __iomem *)CONFIG_PPC_EARLY_DEBUG_40x_PHYSADDR\r\n+ reg);\r\n}\r\nvoid __init udbg_init_40x_realmode(void)\r\n{\r\nudbg_uart_in = udbg_uart_in_40x;\r\nudbg_uart_out = udbg_uart_out_40x;\r\nudbg_use_uart();\r\n}\r\nvoid __init udbg_init_wsp(void)\r\n{\r\nudbg_uart_init_mmio((void *)WSP_UART_VIRT, 1);\r\nudbg_uart_setup(57600, 50000000);\r\n}

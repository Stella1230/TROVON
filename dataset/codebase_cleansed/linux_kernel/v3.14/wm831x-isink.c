static int wm831x_isink_enable(struct regulator_dev *rdev)\r\n{\r\nstruct wm831x_isink *isink = rdev_get_drvdata(rdev);\r\nstruct wm831x *wm831x = isink->wm831x;\r\nint ret;\r\nret = wm831x_set_bits(wm831x, isink->reg, WM831X_CS1_ENA,\r\nWM831X_CS1_ENA);\r\nif (ret != 0)\r\nreturn ret;\r\nret = wm831x_set_bits(wm831x, isink->reg, WM831X_CS1_DRIVE,\r\nWM831X_CS1_DRIVE);\r\nif (ret != 0)\r\nwm831x_set_bits(wm831x, isink->reg, WM831X_CS1_ENA, 0);\r\nreturn ret;\r\n}\r\nstatic int wm831x_isink_disable(struct regulator_dev *rdev)\r\n{\r\nstruct wm831x_isink *isink = rdev_get_drvdata(rdev);\r\nstruct wm831x *wm831x = isink->wm831x;\r\nint ret;\r\nret = wm831x_set_bits(wm831x, isink->reg, WM831X_CS1_DRIVE, 0);\r\nif (ret < 0)\r\nreturn ret;\r\nret = wm831x_set_bits(wm831x, isink->reg, WM831X_CS1_ENA, 0);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn ret;\r\n}\r\nstatic int wm831x_isink_is_enabled(struct regulator_dev *rdev)\r\n{\r\nstruct wm831x_isink *isink = rdev_get_drvdata(rdev);\r\nstruct wm831x *wm831x = isink->wm831x;\r\nint ret;\r\nret = wm831x_reg_read(wm831x, isink->reg);\r\nif (ret < 0)\r\nreturn ret;\r\nif ((ret & (WM831X_CS1_ENA | WM831X_CS1_DRIVE)) ==\r\n(WM831X_CS1_ENA | WM831X_CS1_DRIVE))\r\nreturn 1;\r\nelse\r\nreturn 0;\r\n}\r\nstatic int wm831x_isink_set_current(struct regulator_dev *rdev,\r\nint min_uA, int max_uA)\r\n{\r\nstruct wm831x_isink *isink = rdev_get_drvdata(rdev);\r\nstruct wm831x *wm831x = isink->wm831x;\r\nint ret, i;\r\nfor (i = 0; i < ARRAY_SIZE(wm831x_isinkv_values); i++) {\r\nint val = wm831x_isinkv_values[i];\r\nif (min_uA <= val && val <= max_uA) {\r\nret = wm831x_set_bits(wm831x, isink->reg,\r\nWM831X_CS1_ISEL_MASK, i);\r\nreturn ret;\r\n}\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int wm831x_isink_get_current(struct regulator_dev *rdev)\r\n{\r\nstruct wm831x_isink *isink = rdev_get_drvdata(rdev);\r\nstruct wm831x *wm831x = isink->wm831x;\r\nint ret;\r\nret = wm831x_reg_read(wm831x, isink->reg);\r\nif (ret < 0)\r\nreturn ret;\r\nret &= WM831X_CS1_ISEL_MASK;\r\nif (ret > WM831X_ISINK_MAX_ISEL)\r\nret = WM831X_ISINK_MAX_ISEL;\r\nreturn wm831x_isinkv_values[ret];\r\n}\r\nstatic irqreturn_t wm831x_isink_irq(int irq, void *data)\r\n{\r\nstruct wm831x_isink *isink = data;\r\nregulator_notifier_call_chain(isink->regulator,\r\nREGULATOR_EVENT_OVER_CURRENT,\r\nNULL);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int wm831x_isink_probe(struct platform_device *pdev)\r\n{\r\nstruct wm831x *wm831x = dev_get_drvdata(pdev->dev.parent);\r\nstruct wm831x_pdata *pdata = dev_get_platdata(wm831x->dev);\r\nstruct wm831x_isink *isink;\r\nint id = pdev->id % ARRAY_SIZE(pdata->isink);\r\nstruct regulator_config config = { };\r\nstruct resource *res;\r\nint ret, irq;\r\ndev_dbg(&pdev->dev, "Probing ISINK%d\n", id + 1);\r\nif (pdata == NULL || pdata->isink[id] == NULL)\r\nreturn -ENODEV;\r\nisink = devm_kzalloc(&pdev->dev, sizeof(struct wm831x_isink),\r\nGFP_KERNEL);\r\nif (isink == NULL) {\r\ndev_err(&pdev->dev, "Unable to allocate private data\n");\r\nreturn -ENOMEM;\r\n}\r\nisink->wm831x = wm831x;\r\nres = platform_get_resource(pdev, IORESOURCE_REG, 0);\r\nif (res == NULL) {\r\ndev_err(&pdev->dev, "No REG resource\n");\r\nret = -EINVAL;\r\ngoto err;\r\n}\r\nisink->reg = res->start;\r\nsnprintf(isink->name, sizeof(isink->name), "ISINK%d", id + 1);\r\nisink->desc.name = isink->name;\r\nisink->desc.id = id;\r\nisink->desc.ops = &wm831x_isink_ops;\r\nisink->desc.type = REGULATOR_CURRENT;\r\nisink->desc.owner = THIS_MODULE;\r\nconfig.dev = pdev->dev.parent;\r\nconfig.init_data = pdata->isink[id];\r\nconfig.driver_data = isink;\r\nisink->regulator = devm_regulator_register(&pdev->dev, &isink->desc,\r\n&config);\r\nif (IS_ERR(isink->regulator)) {\r\nret = PTR_ERR(isink->regulator);\r\ndev_err(wm831x->dev, "Failed to register ISINK%d: %d\n",\r\nid + 1, ret);\r\ngoto err;\r\n}\r\nirq = wm831x_irq(wm831x, platform_get_irq(pdev, 0));\r\nret = devm_request_threaded_irq(&pdev->dev, irq, NULL,\r\nwm831x_isink_irq,\r\nIRQF_TRIGGER_RISING, isink->name,\r\nisink);\r\nif (ret != 0) {\r\ndev_err(&pdev->dev, "Failed to request ISINK IRQ %d: %d\n",\r\nirq, ret);\r\ngoto err;\r\n}\r\nplatform_set_drvdata(pdev, isink);\r\nreturn 0;\r\nerr:\r\nreturn ret;\r\n}\r\nstatic int __init wm831x_isink_init(void)\r\n{\r\nint ret;\r\nret = platform_driver_register(&wm831x_isink_driver);\r\nif (ret != 0)\r\npr_err("Failed to register WM831x ISINK driver: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic void __exit wm831x_isink_exit(void)\r\n{\r\nplatform_driver_unregister(&wm831x_isink_driver);\r\n}

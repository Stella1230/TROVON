static int huawei_cdc_ncm_manage_power(struct usbnet *usbnet_dev, int on)\r\n{\r\nstruct huawei_cdc_ncm_state *drvstate = (void *)&usbnet_dev->data;\r\nint rv;\r\nif ((on && atomic_add_return(1, &drvstate->pmcount) == 1) ||\r\n(!on && atomic_dec_and_test(&drvstate->pmcount))) {\r\nrv = usb_autopm_get_interface(usbnet_dev->intf);\r\nusbnet_dev->intf->needs_remote_wakeup = on;\r\nif (!rv)\r\nusb_autopm_put_interface(usbnet_dev->intf);\r\n}\r\nreturn 0;\r\n}\r\nstatic int huawei_cdc_ncm_wdm_manage_power(struct usb_interface *intf,\r\nint status)\r\n{\r\nstruct usbnet *usbnet_dev = usb_get_intfdata(intf);\r\nif (!usbnet_dev)\r\nreturn 0;\r\nreturn huawei_cdc_ncm_manage_power(usbnet_dev, status);\r\n}\r\nstatic int huawei_cdc_ncm_bind(struct usbnet *usbnet_dev,\r\nstruct usb_interface *intf)\r\n{\r\nstruct cdc_ncm_ctx *ctx;\r\nstruct usb_driver *subdriver = ERR_PTR(-ENODEV);\r\nint ret = -ENODEV;\r\nstruct huawei_cdc_ncm_state *drvstate = (void *)&usbnet_dev->data;\r\nret = cdc_ncm_bind_common(usbnet_dev, intf, 1);\r\nif (ret)\r\ngoto err;\r\nctx = drvstate->ctx;\r\nif (usbnet_dev->status)\r\nsubdriver = usb_cdc_wdm_register(ctx->control,\r\n&usbnet_dev->status->desc,\r\n256,\r\nhuawei_cdc_ncm_wdm_manage_power);\r\nif (IS_ERR(subdriver)) {\r\nret = PTR_ERR(subdriver);\r\ncdc_ncm_unbind(usbnet_dev, intf);\r\ngoto err;\r\n}\r\nusbnet_dev->status = NULL;\r\ndrvstate->subdriver = subdriver;\r\nerr:\r\nreturn ret;\r\n}\r\nstatic void huawei_cdc_ncm_unbind(struct usbnet *usbnet_dev,\r\nstruct usb_interface *intf)\r\n{\r\nstruct huawei_cdc_ncm_state *drvstate = (void *)&usbnet_dev->data;\r\nstruct cdc_ncm_ctx *ctx = drvstate->ctx;\r\nif (drvstate->subdriver && drvstate->subdriver->disconnect)\r\ndrvstate->subdriver->disconnect(ctx->control);\r\ndrvstate->subdriver = NULL;\r\ncdc_ncm_unbind(usbnet_dev, intf);\r\n}\r\nstatic int huawei_cdc_ncm_suspend(struct usb_interface *intf,\r\npm_message_t message)\r\n{\r\nint ret = 0;\r\nstruct usbnet *usbnet_dev = usb_get_intfdata(intf);\r\nstruct huawei_cdc_ncm_state *drvstate = (void *)&usbnet_dev->data;\r\nstruct cdc_ncm_ctx *ctx = drvstate->ctx;\r\nif (ctx == NULL) {\r\nret = -ENODEV;\r\ngoto error;\r\n}\r\nret = usbnet_suspend(intf, message);\r\nif (ret < 0)\r\ngoto error;\r\nif (intf == ctx->control &&\r\ndrvstate->subdriver &&\r\ndrvstate->subdriver->suspend)\r\nret = drvstate->subdriver->suspend(intf, message);\r\nif (ret < 0)\r\nusbnet_resume(intf);\r\nerror:\r\nreturn ret;\r\n}\r\nstatic int huawei_cdc_ncm_resume(struct usb_interface *intf)\r\n{\r\nint ret = 0;\r\nstruct usbnet *usbnet_dev = usb_get_intfdata(intf);\r\nstruct huawei_cdc_ncm_state *drvstate = (void *)&usbnet_dev->data;\r\nbool callsub;\r\nstruct cdc_ncm_ctx *ctx = drvstate->ctx;\r\ncallsub =\r\n(intf == ctx->control &&\r\ndrvstate->subdriver &&\r\ndrvstate->subdriver->resume);\r\nif (callsub)\r\nret = drvstate->subdriver->resume(intf);\r\nif (ret < 0)\r\ngoto err;\r\nret = usbnet_resume(intf);\r\nif (ret < 0 && callsub)\r\ndrvstate->subdriver->suspend(intf, PMSG_SUSPEND);\r\nerr:\r\nreturn ret;\r\n}\r\nstatic int huawei_cdc_ncm_check_connect(struct usbnet *usbnet_dev)\r\n{\r\nstruct cdc_ncm_ctx *ctx;\r\nctx = (struct cdc_ncm_ctx *)usbnet_dev->data[0];\r\nif (ctx == NULL)\r\nreturn 1;\r\nreturn !ctx->connected;\r\n}

static inline void hybla_recalc_param (struct sock *sk)\r\n{\r\nstruct hybla *ca = inet_csk_ca(sk);\r\nca->rho_3ls = max_t(u32, tcp_sk(sk)->srtt / msecs_to_jiffies(rtt0), 8);\r\nca->rho = ca->rho_3ls >> 3;\r\nca->rho2_7ls = (ca->rho_3ls * ca->rho_3ls) << 1;\r\nca->rho2 = ca->rho2_7ls >> 7;\r\n}\r\nstatic void hybla_init(struct sock *sk)\r\n{\r\nstruct tcp_sock *tp = tcp_sk(sk);\r\nstruct hybla *ca = inet_csk_ca(sk);\r\nca->rho = 0;\r\nca->rho2 = 0;\r\nca->rho_3ls = 0;\r\nca->rho2_7ls = 0;\r\nca->snd_cwnd_cents = 0;\r\nca->hybla_en = true;\r\ntp->snd_cwnd = 2;\r\ntp->snd_cwnd_clamp = 65535;\r\nhybla_recalc_param(sk);\r\nca->minrtt = tp->srtt;\r\ntp->snd_cwnd = ca->rho;\r\n}\r\nstatic void hybla_state(struct sock *sk, u8 ca_state)\r\n{\r\nstruct hybla *ca = inet_csk_ca(sk);\r\nca->hybla_en = (ca_state == TCP_CA_Open);\r\n}\r\nstatic inline u32 hybla_fraction(u32 odds)\r\n{\r\nstatic const u32 fractions[] = {\r\n128, 139, 152, 165, 181, 197, 215, 234,\r\n};\r\nreturn (odds < ARRAY_SIZE(fractions)) ? fractions[odds] : 128;\r\n}\r\nstatic void hybla_cong_avoid(struct sock *sk, u32 ack, u32 acked,\r\nu32 in_flight)\r\n{\r\nstruct tcp_sock *tp = tcp_sk(sk);\r\nstruct hybla *ca = inet_csk_ca(sk);\r\nu32 increment, odd, rho_fractions;\r\nint is_slowstart = 0;\r\nif (tp->srtt < ca->minrtt){\r\nhybla_recalc_param(sk);\r\nca->minrtt = tp->srtt;\r\n}\r\nif (!tcp_is_cwnd_limited(sk, in_flight))\r\nreturn;\r\nif (!ca->hybla_en) {\r\ntcp_reno_cong_avoid(sk, ack, acked, in_flight);\r\nreturn;\r\n}\r\nif (ca->rho == 0)\r\nhybla_recalc_param(sk);\r\nrho_fractions = ca->rho_3ls - (ca->rho << 3);\r\nif (tp->snd_cwnd < tp->snd_ssthresh) {\r\nis_slowstart = 1;\r\nincrement = ((1 << min(ca->rho, 16U)) *\r\nhybla_fraction(rho_fractions)) - 128;\r\n} else {\r\nincrement = ca->rho2_7ls / tp->snd_cwnd;\r\nif (increment < 128)\r\ntp->snd_cwnd_cnt++;\r\n}\r\nodd = increment % 128;\r\ntp->snd_cwnd += increment >> 7;\r\nca->snd_cwnd_cents += odd;\r\nwhile (ca->snd_cwnd_cents >= 128) {\r\ntp->snd_cwnd++;\r\nca->snd_cwnd_cents -= 128;\r\ntp->snd_cwnd_cnt = 0;\r\n}\r\nif (increment == 0 && odd == 0 && tp->snd_cwnd_cnt >= tp->snd_cwnd) {\r\ntp->snd_cwnd++;\r\ntp->snd_cwnd_cnt = 0;\r\n}\r\nif (is_slowstart)\r\ntp->snd_cwnd = min(tp->snd_cwnd, tp->snd_ssthresh);\r\ntp->snd_cwnd = min_t(u32, tp->snd_cwnd, tp->snd_cwnd_clamp);\r\n}\r\nstatic int __init hybla_register(void)\r\n{\r\nBUILD_BUG_ON(sizeof(struct hybla) > ICSK_CA_PRIV_SIZE);\r\nreturn tcp_register_congestion_control(&tcp_hybla);\r\n}\r\nstatic void __exit hybla_unregister(void)\r\n{\r\ntcp_unregister_congestion_control(&tcp_hybla);\r\n}

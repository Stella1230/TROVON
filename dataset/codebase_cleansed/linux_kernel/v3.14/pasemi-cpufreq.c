static int get_astate_freq(int astate)\r\n{\r\nu32 ret;\r\nret = in_le32(sdcpwr_mapbase + SDCPWR_CFGA0_REG + (astate * 0x10));\r\nreturn ret & 0x3f;\r\n}\r\nstatic int get_cur_astate(int cpu)\r\n{\r\nu32 ret;\r\nret = in_le32(sdcpwr_mapbase + SDCPWR_PWST0_REG);\r\nret = (ret >> (cpu * 4)) & 0x7;\r\nreturn ret;\r\n}\r\nstatic int get_gizmo_latency(void)\r\n{\r\nu32 giztime, ret;\r\ngiztime = in_le32(sdcpwr_mapbase + SDCPWR_GIZTIME_REG);\r\nif (giztime & SDCPWR_GIZTIME_GR)\r\nret = (giztime & SDCPWR_GIZTIME_LONGLOCK) * 128000;\r\nelse\r\nret = (giztime & SDCPWR_GIZTIME_LONGLOCK) * 1000;\r\nreturn ret;\r\n}\r\nstatic void set_astate(int cpu, unsigned int astate)\r\n{\r\nunsigned long flags;\r\nif (unlikely(!sdcasr_mapbase))\r\nreturn;\r\nlocal_irq_save(flags);\r\nout_le32(sdcasr_mapbase + SDCASR_REG + SDCASR_REG_STRIDE*cpu, astate);\r\nlocal_irq_restore(flags);\r\n}\r\nint check_astate(void)\r\n{\r\nreturn get_cur_astate(hard_smp_processor_id());\r\n}\r\nvoid restore_astate(int cpu)\r\n{\r\nset_astate(cpu, current_astate);\r\n}\r\nstatic int pas_cpufreq_cpu_init(struct cpufreq_policy *policy)\r\n{\r\nconst u32 *max_freqp;\r\nu32 max_freq;\r\nint i, cur_astate;\r\nstruct resource res;\r\nstruct device_node *cpu, *dn;\r\nint err = -ENODEV;\r\ncpu = of_get_cpu_node(policy->cpu, NULL);\r\nif (!cpu)\r\ngoto out;\r\ndn = of_find_compatible_node(NULL, NULL, "1682m-sdc");\r\nif (!dn)\r\ndn = of_find_compatible_node(NULL, NULL,\r\n"pasemi,pwrficient-sdc");\r\nif (!dn)\r\ngoto out;\r\nerr = of_address_to_resource(dn, 0, &res);\r\nof_node_put(dn);\r\nif (err)\r\ngoto out;\r\nsdcasr_mapbase = ioremap(res.start + SDCASR_OFFSET, 0x2000);\r\nif (!sdcasr_mapbase) {\r\nerr = -EINVAL;\r\ngoto out;\r\n}\r\ndn = of_find_compatible_node(NULL, NULL, "1682m-gizmo");\r\nif (!dn)\r\ndn = of_find_compatible_node(NULL, NULL,\r\n"pasemi,pwrficient-gizmo");\r\nif (!dn) {\r\nerr = -ENODEV;\r\ngoto out_unmap_sdcasr;\r\n}\r\nerr = of_address_to_resource(dn, 0, &res);\r\nof_node_put(dn);\r\nif (err)\r\ngoto out_unmap_sdcasr;\r\nsdcpwr_mapbase = ioremap(res.start, 0x1000);\r\nif (!sdcpwr_mapbase) {\r\nerr = -EINVAL;\r\ngoto out_unmap_sdcasr;\r\n}\r\npr_debug("init cpufreq on CPU %d\n", policy->cpu);\r\nmax_freqp = of_get_property(cpu, "clock-frequency", NULL);\r\nif (!max_freqp) {\r\nerr = -EINVAL;\r\ngoto out_unmap_sdcpwr;\r\n}\r\nmax_freq = *max_freqp / 1000;\r\npr_debug("max clock-frequency is at %u kHz\n", max_freq);\r\npr_debug("initializing frequency table\n");\r\nfor (i=0; pas_freqs[i].frequency!=CPUFREQ_TABLE_END; i++) {\r\npas_freqs[i].frequency =\r\nget_astate_freq(pas_freqs[i].driver_data) * 100000;\r\npr_debug("%d: %d\n", i, pas_freqs[i].frequency);\r\n}\r\ncur_astate = get_cur_astate(policy->cpu);\r\npr_debug("current astate is at %d\n",cur_astate);\r\npolicy->cur = pas_freqs[cur_astate].frequency;\r\nppc_proc_freq = policy->cur * 1000ul;\r\nreturn cpufreq_generic_init(policy, pas_freqs, get_gizmo_latency());\r\nout_unmap_sdcpwr:\r\niounmap(sdcpwr_mapbase);\r\nout_unmap_sdcasr:\r\niounmap(sdcasr_mapbase);\r\nout:\r\nreturn err;\r\n}\r\nstatic int pas_cpufreq_cpu_exit(struct cpufreq_policy *policy)\r\n{\r\nif (system_state != SYSTEM_BOOTING)\r\nreturn 0;\r\nif (sdcasr_mapbase)\r\niounmap(sdcasr_mapbase);\r\nif (sdcpwr_mapbase)\r\niounmap(sdcpwr_mapbase);\r\ncpufreq_frequency_table_put_attr(policy->cpu);\r\nreturn 0;\r\n}\r\nstatic int pas_cpufreq_target(struct cpufreq_policy *policy,\r\nunsigned int pas_astate_new)\r\n{\r\nint i;\r\npr_debug("setting frequency for cpu %d to %d kHz, 1/%d of max frequency\n",\r\npolicy->cpu,\r\npas_freqs[pas_astate_new].frequency,\r\npas_freqs[pas_astate_new].driver_data);\r\ncurrent_astate = pas_astate_new;\r\nfor_each_online_cpu(i)\r\nset_astate(i, pas_astate_new);\r\nppc_proc_freq = pas_freqs[pas_astate_new].frequency * 1000ul;\r\nreturn 0;\r\n}\r\nstatic int __init pas_cpufreq_init(void)\r\n{\r\nif (!of_machine_is_compatible("PA6T-1682M") &&\r\n!of_machine_is_compatible("pasemi,pwrficient"))\r\nreturn -ENODEV;\r\nreturn cpufreq_register_driver(&pas_cpufreq_driver);\r\n}\r\nstatic void __exit pas_cpufreq_exit(void)\r\n{\r\ncpufreq_unregister_driver(&pas_cpufreq_driver);\r\n}

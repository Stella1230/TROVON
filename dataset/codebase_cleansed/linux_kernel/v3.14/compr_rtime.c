static int jffs2_rtime_compress(unsigned char *data_in,\r\nunsigned char *cpage_out,\r\nuint32_t *sourcelen, uint32_t *dstlen)\r\n{\r\nshort positions[256];\r\nint outpos = 0;\r\nint pos=0;\r\nmemset(positions,0,sizeof(positions));\r\nwhile (pos < (*sourcelen) && outpos <= (*dstlen)-2) {\r\nint backpos, runlen=0;\r\nunsigned char value;\r\nvalue = data_in[pos];\r\ncpage_out[outpos++] = data_in[pos++];\r\nbackpos = positions[value];\r\npositions[value]=pos;\r\nwhile ((backpos < pos) && (pos < (*sourcelen)) &&\r\n(data_in[pos]==data_in[backpos++]) && (runlen<255)) {\r\npos++;\r\nrunlen++;\r\n}\r\ncpage_out[outpos++] = runlen;\r\n}\r\nif (outpos >= pos) {\r\nreturn -1;\r\n}\r\n*sourcelen = pos;\r\n*dstlen = outpos;\r\nreturn 0;\r\n}\r\nstatic int jffs2_rtime_decompress(unsigned char *data_in,\r\nunsigned char *cpage_out,\r\nuint32_t srclen, uint32_t destlen)\r\n{\r\nshort positions[256];\r\nint outpos = 0;\r\nint pos=0;\r\nmemset(positions,0,sizeof(positions));\r\nwhile (outpos<destlen) {\r\nunsigned char value;\r\nint backoffs;\r\nint repeat;\r\nvalue = data_in[pos++];\r\ncpage_out[outpos++] = value;\r\nrepeat = data_in[pos++];\r\nbackoffs = positions[value];\r\npositions[value]=outpos;\r\nif (repeat) {\r\nif (backoffs + repeat >= outpos) {\r\nwhile(repeat) {\r\ncpage_out[outpos++] = cpage_out[backoffs++];\r\nrepeat--;\r\n}\r\n} else {\r\nmemcpy(&cpage_out[outpos],&cpage_out[backoffs],repeat);\r\noutpos+=repeat;\r\n}\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint jffs2_rtime_init(void)\r\n{\r\nreturn jffs2_register_compressor(&jffs2_rtime_comp);\r\n}\r\nvoid jffs2_rtime_exit(void)\r\n{\r\njffs2_unregister_compressor(&jffs2_rtime_comp);\r\n}

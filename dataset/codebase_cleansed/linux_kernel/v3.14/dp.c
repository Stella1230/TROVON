static u16\r\nnvbios_dp_table(struct nouveau_bios *bios, u8 *ver, u8 *hdr, u8 *cnt, u8 *len)\r\n{\r\nstruct bit_entry d;\r\nif (!bit_entry(bios, 'd', &d)) {\r\nif (d.version == 1 && d.length >= 2) {\r\nu16 data = nv_ro16(bios, d.offset);\r\nif (data) {\r\n*ver = nv_ro08(bios, data + 0x00);\r\nswitch (*ver) {\r\ncase 0x21:\r\ncase 0x30:\r\ncase 0x40:\r\n*hdr = nv_ro08(bios, data + 0x01);\r\n*len = nv_ro08(bios, data + 0x02);\r\n*cnt = nv_ro08(bios, data + 0x03);\r\nreturn data;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\n}\r\nreturn 0x0000;\r\n}\r\nstatic u16\r\nnvbios_dpout_entry(struct nouveau_bios *bios, u8 idx,\r\nu8 *ver, u8 *hdr, u8 *cnt, u8 *len)\r\n{\r\nu16 data = nvbios_dp_table(bios, ver, hdr, cnt, len);\r\nif (data && idx < *cnt) {\r\nu16 outp = nv_ro16(bios, data + *hdr + idx * *len);\r\nswitch (*ver * !!outp) {\r\ncase 0x21:\r\ncase 0x30:\r\n*hdr = nv_ro08(bios, data + 0x04);\r\n*len = nv_ro08(bios, data + 0x05);\r\n*cnt = nv_ro08(bios, outp + 0x04);\r\nbreak;\r\ncase 0x40:\r\n*hdr = nv_ro08(bios, data + 0x04);\r\n*cnt = 0;\r\n*len = 0;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn outp;\r\n}\r\n*ver = 0x00;\r\nreturn 0x0000;\r\n}\r\nu16\r\nnvbios_dpout_parse(struct nouveau_bios *bios, u8 idx,\r\nu8 *ver, u8 *hdr, u8 *cnt, u8 *len,\r\nstruct nvbios_dpout *info)\r\n{\r\nu16 data = nvbios_dpout_entry(bios, idx, ver, hdr, cnt, len);\r\nmemset(info, 0x00, sizeof(*info));\r\nif (data && *ver) {\r\ninfo->type = nv_ro16(bios, data + 0x00);\r\ninfo->mask = nv_ro16(bios, data + 0x02);\r\nswitch (*ver) {\r\ncase 0x21:\r\ncase 0x30:\r\ninfo->flags = nv_ro08(bios, data + 0x05);\r\ninfo->script[0] = nv_ro16(bios, data + 0x06);\r\ninfo->script[1] = nv_ro16(bios, data + 0x08);\r\ninfo->lnkcmp = nv_ro16(bios, data + 0x0a);\r\nif (*len >= 0x0f) {\r\ninfo->script[2] = nv_ro16(bios, data + 0x0c);\r\ninfo->script[3] = nv_ro16(bios, data + 0x0e);\r\n}\r\nif (*len >= 0x11)\r\ninfo->script[4] = nv_ro16(bios, data + 0x10);\r\nbreak;\r\ncase 0x40:\r\ninfo->flags = nv_ro08(bios, data + 0x04);\r\ninfo->script[0] = nv_ro16(bios, data + 0x05);\r\ninfo->script[1] = nv_ro16(bios, data + 0x07);\r\ninfo->lnkcmp = nv_ro16(bios, data + 0x09);\r\ninfo->script[2] = nv_ro16(bios, data + 0x0b);\r\ninfo->script[3] = nv_ro16(bios, data + 0x0d);\r\ninfo->script[4] = nv_ro16(bios, data + 0x0f);\r\nbreak;\r\ndefault:\r\ndata = 0x0000;\r\nbreak;\r\n}\r\n}\r\nreturn data;\r\n}\r\nu16\r\nnvbios_dpout_match(struct nouveau_bios *bios, u16 type, u16 mask,\r\nu8 *ver, u8 *hdr, u8 *cnt, u8 *len,\r\nstruct nvbios_dpout *info)\r\n{\r\nu16 data, idx = 0;\r\nwhile ((data = nvbios_dpout_parse(bios, idx++, ver, hdr, cnt, len, info)) || *ver) {\r\nif (data && info->type == type) {\r\nif ((info->mask & mask) == mask)\r\nbreak;\r\n}\r\n}\r\nreturn data;\r\n}\r\nstatic u16\r\nnvbios_dpcfg_entry(struct nouveau_bios *bios, u16 outp, u8 idx,\r\nu8 *ver, u8 *hdr, u8 *cnt, u8 *len)\r\n{\r\nif (*ver >= 0x40) {\r\noutp = nvbios_dp_table(bios, ver, hdr, cnt, len);\r\n*hdr = *hdr + (*len * * cnt);\r\n*len = nv_ro08(bios, outp + 0x06);\r\n*cnt = nv_ro08(bios, outp + 0x07);\r\n}\r\nif (idx < *cnt)\r\nreturn outp + *hdr + (idx * *len);\r\nreturn 0x0000;\r\n}\r\nu16\r\nnvbios_dpcfg_parse(struct nouveau_bios *bios, u16 outp, u8 idx,\r\nu8 *ver, u8 *hdr, u8 *cnt, u8 *len,\r\nstruct nvbios_dpcfg *info)\r\n{\r\nu16 data = nvbios_dpcfg_entry(bios, outp, idx, ver, hdr, cnt, len);\r\nif (data) {\r\nswitch (*ver) {\r\ncase 0x21:\r\ninfo->drv = nv_ro08(bios, data + 0x02);\r\ninfo->pre = nv_ro08(bios, data + 0x03);\r\ninfo->unk = nv_ro08(bios, data + 0x04);\r\nbreak;\r\ncase 0x30:\r\ncase 0x40:\r\ninfo->drv = nv_ro08(bios, data + 0x01);\r\ninfo->pre = nv_ro08(bios, data + 0x02);\r\ninfo->unk = nv_ro08(bios, data + 0x03);\r\nbreak;\r\ndefault:\r\ndata = 0x0000;\r\nbreak;\r\n}\r\n}\r\nreturn data;\r\n}\r\nu16\r\nnvbios_dpcfg_match(struct nouveau_bios *bios, u16 outp, u8 un, u8 vs, u8 pe,\r\nu8 *ver, u8 *hdr, u8 *cnt, u8 *len,\r\nstruct nvbios_dpcfg *info)\r\n{\r\nu8 idx = 0xff;\r\nu16 data;\r\nif (*ver >= 0x30) {\r\nconst u8 vsoff[] = { 0, 4, 7, 9 };\r\nidx = (un * 10) + vsoff[vs] + pe;\r\n} else {\r\nwhile ((data = nvbios_dpcfg_entry(bios, outp, idx,\r\nver, hdr, cnt, len))) {\r\nif (nv_ro08(bios, data + 0x00) == vs &&\r\nnv_ro08(bios, data + 0x01) == pe)\r\nbreak;\r\nidx++;\r\n}\r\n}\r\nreturn nvbios_dpcfg_parse(bios, outp, pe, ver, hdr, cnt, len, info);\r\n}

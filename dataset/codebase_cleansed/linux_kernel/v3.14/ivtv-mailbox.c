static int try_mailbox(struct ivtv *itv, struct ivtv_mailbox_data *mbdata, int mb)\r\n{\r\nu32 flags = readl(&mbdata->mbox[mb].flags);\r\nint is_free = flags == IVTV_MBOX_FREE || (flags & IVTV_MBOX_FIRMWARE_DONE);\r\nif (is_free && !test_and_set_bit(mb, &mbdata->busy)) {\r\nwrite_sync(IVTV_MBOX_DRIVER_BUSY, &mbdata->mbox[mb].flags);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int get_mailbox(struct ivtv *itv, struct ivtv_mailbox_data *mbdata, int flags)\r\n{\r\nunsigned long then = jiffies;\r\nint i, mb;\r\nint max_mbox = mbdata->max_mbox;\r\nint retries = 100;\r\nif ((flags & API_FAST_RESULT) == API_RESULT)\r\nmax_mbox = 1;\r\nfor (i = 0; i < retries; i++) {\r\nfor (mb = 1; mb <= max_mbox; mb++)\r\nif (try_mailbox(itv, mbdata, mb))\r\nreturn mb;\r\nif (!(flags & API_NO_WAIT_MB)) {\r\nif (time_after(jiffies,\r\nthen + msecs_to_jiffies(10*retries)))\r\nbreak;\r\nivtv_msleep_timeout(10, 0);\r\n}\r\n}\r\nreturn -ENODEV;\r\n}\r\nstatic void write_mailbox(volatile struct ivtv_mailbox __iomem *mbox, int cmd, int args, u32 data[])\r\n{\r\nint i;\r\nwrite_sync(cmd, &mbox->cmd);\r\nwrite_sync(IVTV_API_STD_TIMEOUT, &mbox->timeout);\r\nfor (i = 0; i < CX2341X_MBOX_MAX_DATA; i++)\r\nwrite_sync(data[i], &mbox->data[i]);\r\nwrite_sync(IVTV_MBOX_DRIVER_DONE | IVTV_MBOX_DRIVER_BUSY, &mbox->flags);\r\n}\r\nstatic void clear_all_mailboxes(struct ivtv *itv, struct ivtv_mailbox_data *mbdata)\r\n{\r\nint i;\r\nfor (i = 0; i <= mbdata->max_mbox; i++) {\r\nIVTV_DEBUG_WARN("Clearing mailbox %d: cmd 0x%08x flags 0x%08x\n",\r\ni, readl(&mbdata->mbox[i].cmd), readl(&mbdata->mbox[i].flags));\r\nwrite_sync(0, &mbdata->mbox[i].flags);\r\nclear_bit(i, &mbdata->busy);\r\n}\r\n}\r\nstatic int ivtv_api_call(struct ivtv *itv, int cmd, int args, u32 data[])\r\n{\r\nstruct ivtv_mailbox_data *mbdata = (cmd >= 128) ? &itv->enc_mbox : &itv->dec_mbox;\r\nvolatile struct ivtv_mailbox __iomem *mbox;\r\nint api_timeout = msecs_to_jiffies(1000);\r\nint flags, mb, i;\r\nunsigned long then;\r\nif (NULL == mbdata) {\r\nIVTV_ERR("No mailbox allocated\n");\r\nreturn -ENODEV;\r\n}\r\nif (args < 0 || args > CX2341X_MBOX_MAX_DATA ||\r\ncmd < 0 || cmd > 255 || api_info[cmd].name == NULL) {\r\nIVTV_ERR("Invalid MB call: cmd = 0x%02x, args = %d\n", cmd, args);\r\nreturn -EINVAL;\r\n}\r\nif (api_info[cmd].flags & API_HIGH_VOL) {\r\nIVTV_DEBUG_HI_MB("MB Call: %s\n", api_info[cmd].name);\r\n}\r\nelse {\r\nIVTV_DEBUG_MB("MB Call: %s\n", api_info[cmd].name);\r\n}\r\nfor (i = args; i < CX2341X_MBOX_MAX_DATA; i++)\r\ndata[i] = 0;\r\nif (itv->api_cache[cmd].last_jiffies &&\r\ntime_before(jiffies,\r\nitv->api_cache[cmd].last_jiffies +\r\nmsecs_to_jiffies(1800000)) &&\r\n!memcmp(data, itv->api_cache[cmd].data, sizeof(itv->api_cache[cmd].data))) {\r\nitv->api_cache[cmd].last_jiffies = jiffies;\r\nreturn 0;\r\n}\r\nflags = api_info[cmd].flags;\r\nif (flags & API_DMA) {\r\nfor (i = 0; i < 100; i++) {\r\nmb = i % (mbdata->max_mbox + 1);\r\nif (try_mailbox(itv, mbdata, mb)) {\r\nwrite_mailbox(&mbdata->mbox[mb], cmd, args, data);\r\nclear_bit(mb, &mbdata->busy);\r\nreturn 0;\r\n}\r\nIVTV_DEBUG_WARN("%s: mailbox %d not free %08x\n",\r\napi_info[cmd].name, mb, readl(&mbdata->mbox[mb].flags));\r\n}\r\nIVTV_WARN("Could not find free DMA mailbox for %s\n", api_info[cmd].name);\r\nclear_all_mailboxes(itv, mbdata);\r\nreturn -EBUSY;\r\n}\r\nif ((flags & API_FAST_RESULT) == API_FAST_RESULT)\r\napi_timeout = msecs_to_jiffies(100);\r\nmb = get_mailbox(itv, mbdata, flags);\r\nif (mb < 0) {\r\nIVTV_DEBUG_WARN("No free mailbox found (%s)\n", api_info[cmd].name);\r\nclear_all_mailboxes(itv, mbdata);\r\nreturn -EBUSY;\r\n}\r\nmbox = &mbdata->mbox[mb];\r\nwrite_mailbox(mbox, cmd, args, data);\r\nif (flags & API_CACHE) {\r\nmemcpy(itv->api_cache[cmd].data, data, sizeof(itv->api_cache[cmd].data));\r\nitv->api_cache[cmd].last_jiffies = jiffies;\r\n}\r\nif ((flags & API_RESULT) == 0) {\r\nclear_bit(mb, &mbdata->busy);\r\nreturn 0;\r\n}\r\nthen = jiffies;\r\nif (!(flags & API_NO_POLL)) {\r\nfor (i = 0; i < 100; i++) {\r\nif (readl(&mbox->flags) & IVTV_MBOX_FIRMWARE_DONE)\r\nbreak;\r\n}\r\n}\r\nwhile (!(readl(&mbox->flags) & IVTV_MBOX_FIRMWARE_DONE)) {\r\nif (time_after(jiffies, then + api_timeout)) {\r\nIVTV_DEBUG_WARN("Could not get result (%s)\n", api_info[cmd].name);\r\nwrite_sync(0, &mbox->flags);\r\nclear_bit(mb, &mbdata->busy);\r\nreturn -EIO;\r\n}\r\nif (flags & API_NO_WAIT_RES)\r\nmdelay(1);\r\nelse\r\nivtv_msleep_timeout(1, 0);\r\n}\r\nif (time_after(jiffies, then + msecs_to_jiffies(100)))\r\nIVTV_DEBUG_WARN("%s took %u jiffies\n",\r\napi_info[cmd].name,\r\njiffies_to_msecs(jiffies - then));\r\nfor (i = 0; i < CX2341X_MBOX_MAX_DATA; i++)\r\ndata[i] = readl(&mbox->data[i]);\r\nwrite_sync(0, &mbox->flags);\r\nclear_bit(mb, &mbdata->busy);\r\nreturn 0;\r\n}\r\nint ivtv_api(struct ivtv *itv, int cmd, int args, u32 data[])\r\n{\r\nint res = ivtv_api_call(itv, cmd, args, data);\r\nreturn (res == -EBUSY) ? ivtv_api_call(itv, cmd, args, data) : res;\r\n}\r\nint ivtv_api_func(void *priv, u32 cmd, int in, int out, u32 data[CX2341X_MBOX_MAX_DATA])\r\n{\r\nreturn ivtv_api(priv, cmd, in, data);\r\n}\r\nint ivtv_vapi_result(struct ivtv *itv, u32 data[CX2341X_MBOX_MAX_DATA], int cmd, int args, ...)\r\n{\r\nva_list ap;\r\nint i;\r\nva_start(ap, args);\r\nfor (i = 0; i < args; i++) {\r\ndata[i] = va_arg(ap, u32);\r\n}\r\nva_end(ap);\r\nreturn ivtv_api(itv, cmd, args, data);\r\n}\r\nint ivtv_vapi(struct ivtv *itv, int cmd, int args, ...)\r\n{\r\nu32 data[CX2341X_MBOX_MAX_DATA];\r\nva_list ap;\r\nint i;\r\nva_start(ap, args);\r\nfor (i = 0; i < args; i++) {\r\ndata[i] = va_arg(ap, u32);\r\n}\r\nva_end(ap);\r\nreturn ivtv_api(itv, cmd, args, data);\r\n}\r\nvoid ivtv_api_get_data(struct ivtv_mailbox_data *mbdata, int mb,\r\nint argc, u32 data[])\r\n{\r\nvolatile u32 __iomem *p = mbdata->mbox[mb].data;\r\nint i;\r\nfor (i = 0; i < argc; i++, p++)\r\ndata[i] = readl(p);\r\n}\r\nvoid ivtv_mailbox_cache_invalidate(struct ivtv *itv)\r\n{\r\nint i;\r\nfor (i = 0; i < 256; i++)\r\nitv->api_cache[i].last_jiffies = 0;\r\n}

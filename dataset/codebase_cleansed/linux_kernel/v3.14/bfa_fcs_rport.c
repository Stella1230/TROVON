static void\r\nbfa_fcs_rport_sm_uninit(struct bfa_fcs_rport_s *rport, enum rport_event event)\r\n{\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPSM_EVENT_PLOGI_SEND:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogi_sending);\r\nrport->plogi_retries = 0;\r\nbfa_fcs_rport_send_plogi(rport, NULL);\r\nbreak;\r\ncase RPSM_EVENT_PLOGI_RCVD:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogiacc_sending);\r\nbfa_fcs_rport_send_plogiacc(rport, NULL);\r\nbreak;\r\ncase RPSM_EVENT_PLOGI_COMP:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_hal_online);\r\nbfa_fcs_rport_hal_online(rport);\r\nbreak;\r\ncase RPSM_EVENT_ADDRESS_CHANGE:\r\ncase RPSM_EVENT_ADDRESS_DISC:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_nsdisc_sending);\r\nrport->ns_retries = 0;\r\nbfa_fcs_rport_send_nsdisc(rport, NULL);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_sm_plogi_sending(struct bfa_fcs_rport_s *rport,\r\nenum rport_event event)\r\n{\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPSM_EVENT_FCXP_SENT:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogi);\r\nbreak;\r\ncase RPSM_EVENT_DELETE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_uninit);\r\nbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\r\nbfa_fcs_rport_free(rport);\r\nbreak;\r\ncase RPSM_EVENT_PLOGI_RCVD:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogiacc_sending);\r\nbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\r\nbfa_fcs_rport_send_plogiacc(rport, NULL);\r\nbreak;\r\ncase RPSM_EVENT_SCN_OFFLINE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\r\nbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\r\nbfa_timer_start(rport->fcs->bfa, &rport->timer,\r\nbfa_fcs_rport_timeout, rport,\r\nbfa_fcs_rport_del_timeout);\r\nbreak;\r\ncase RPSM_EVENT_ADDRESS_CHANGE:\r\ncase RPSM_EVENT_FAB_SCN:\r\nbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\r\nWARN_ON(!(bfa_fcport_get_topology(rport->port->fcs->bfa) !=\r\nBFA_PORT_TOPOLOGY_LOOP));\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_nsdisc_sending);\r\nrport->ns_retries = 0;\r\nbfa_fcs_rport_send_nsdisc(rport, NULL);\r\nbreak;\r\ncase RPSM_EVENT_LOGO_IMP:\r\nrport->pid = 0;\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\r\nbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\r\nbfa_timer_start(rport->fcs->bfa, &rport->timer,\r\nbfa_fcs_rport_timeout, rport,\r\nbfa_fcs_rport_del_timeout);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_sm_plogiacc_sending(struct bfa_fcs_rport_s *rport,\r\nenum rport_event event)\r\n{\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPSM_EVENT_FCXP_SENT:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_fcs_online);\r\nbfa_fcs_rport_fcs_online_action(rport);\r\nbreak;\r\ncase RPSM_EVENT_DELETE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_uninit);\r\nbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\r\nbfa_fcs_rport_free(rport);\r\nbreak;\r\ncase RPSM_EVENT_PLOGI_RCVD:\r\ncase RPSM_EVENT_PLOGI_COMP:\r\ncase RPSM_EVENT_FAB_SCN:\r\nbreak;\r\ncase RPSM_EVENT_SCN_OFFLINE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\r\nbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\r\nbfa_timer_start(rport->fcs->bfa, &rport->timer,\r\nbfa_fcs_rport_timeout, rport,\r\nbfa_fcs_rport_del_timeout);\r\nbreak;\r\ncase RPSM_EVENT_ADDRESS_CHANGE:\r\nbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_nsdisc_sending);\r\nrport->ns_retries = 0;\r\nbfa_fcs_rport_send_nsdisc(rport, NULL);\r\nbreak;\r\ncase RPSM_EVENT_LOGO_IMP:\r\nrport->pid = 0;\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\r\nbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\r\nbfa_timer_start(rport->fcs->bfa, &rport->timer,\r\nbfa_fcs_rport_timeout, rport,\r\nbfa_fcs_rport_del_timeout);\r\nbreak;\r\ncase RPSM_EVENT_HCB_OFFLINE:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_sm_plogi_retry(struct bfa_fcs_rport_s *rport,\r\nenum rport_event event)\r\n{\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPSM_EVENT_TIMEOUT:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogi_sending);\r\nbfa_fcs_rport_send_plogi(rport, NULL);\r\nbreak;\r\ncase RPSM_EVENT_DELETE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_uninit);\r\nbfa_timer_stop(&rport->timer);\r\nbfa_fcs_rport_free(rport);\r\nbreak;\r\ncase RPSM_EVENT_PRLO_RCVD:\r\ncase RPSM_EVENT_LOGO_RCVD:\r\nbreak;\r\ncase RPSM_EVENT_PLOGI_RCVD:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogiacc_sending);\r\nbfa_timer_stop(&rport->timer);\r\nbfa_fcs_rport_send_plogiacc(rport, NULL);\r\nbreak;\r\ncase RPSM_EVENT_SCN_OFFLINE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\r\nbfa_timer_stop(&rport->timer);\r\nbfa_timer_start(rport->fcs->bfa, &rport->timer,\r\nbfa_fcs_rport_timeout, rport,\r\nbfa_fcs_rport_del_timeout);\r\nbreak;\r\ncase RPSM_EVENT_ADDRESS_CHANGE:\r\ncase RPSM_EVENT_FAB_SCN:\r\nbfa_timer_stop(&rport->timer);\r\nWARN_ON(!(bfa_fcport_get_topology(rport->port->fcs->bfa) !=\r\nBFA_PORT_TOPOLOGY_LOOP));\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_nsdisc_sending);\r\nrport->ns_retries = 0;\r\nbfa_fcs_rport_send_nsdisc(rport, NULL);\r\nbreak;\r\ncase RPSM_EVENT_LOGO_IMP:\r\nrport->pid = 0;\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\r\nbfa_timer_stop(&rport->timer);\r\nbfa_timer_start(rport->fcs->bfa, &rport->timer,\r\nbfa_fcs_rport_timeout, rport,\r\nbfa_fcs_rport_del_timeout);\r\nbreak;\r\ncase RPSM_EVENT_PLOGI_COMP:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_fcs_online);\r\nbfa_timer_stop(&rport->timer);\r\nbfa_fcs_rport_fcs_online_action(rport);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_sm_plogi(struct bfa_fcs_rport_s *rport, enum rport_event event)\r\n{\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPSM_EVENT_ACCEPTED:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_fcs_online);\r\nrport->plogi_retries = 0;\r\nbfa_fcs_rport_fcs_online_action(rport);\r\nbreak;\r\ncase RPSM_EVENT_LOGO_RCVD:\r\nbfa_fcs_rport_send_logo_acc(rport);\r\ncase RPSM_EVENT_PRLO_RCVD:\r\nif (rport->prlo == BFA_TRUE)\r\nbfa_fcs_rport_send_prlo_acc(rport);\r\nbfa_fcxp_discard(rport->fcxp);\r\ncase RPSM_EVENT_FAILED:\r\nif (rport->plogi_retries < BFA_FCS_RPORT_MAX_RETRIES) {\r\nrport->plogi_retries++;\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogi_retry);\r\nbfa_timer_start(rport->fcs->bfa, &rport->timer,\r\nbfa_fcs_rport_timeout, rport,\r\nBFA_FCS_RETRY_TIMEOUT);\r\n} else {\r\nbfa_stats(rport->port, rport_del_max_plogi_retry);\r\nrport->old_pid = rport->pid;\r\nrport->pid = 0;\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\r\nbfa_timer_start(rport->fcs->bfa, &rport->timer,\r\nbfa_fcs_rport_timeout, rport,\r\nbfa_fcs_rport_del_timeout);\r\n}\r\nbreak;\r\ncase RPSM_EVENT_SCN_ONLINE:\r\nbreak;\r\ncase RPSM_EVENT_SCN_OFFLINE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\r\nbfa_fcxp_discard(rport->fcxp);\r\nbfa_timer_start(rport->fcs->bfa, &rport->timer,\r\nbfa_fcs_rport_timeout, rport,\r\nbfa_fcs_rport_del_timeout);\r\nbreak;\r\ncase RPSM_EVENT_PLOGI_RETRY:\r\nrport->plogi_retries = 0;\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogi_retry);\r\nbfa_timer_start(rport->fcs->bfa, &rport->timer,\r\nbfa_fcs_rport_timeout, rport,\r\n(FC_RA_TOV * 1000));\r\nbreak;\r\ncase RPSM_EVENT_LOGO_IMP:\r\nrport->pid = 0;\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\r\nbfa_fcxp_discard(rport->fcxp);\r\nbfa_timer_start(rport->fcs->bfa, &rport->timer,\r\nbfa_fcs_rport_timeout, rport,\r\nbfa_fcs_rport_del_timeout);\r\nbreak;\r\ncase RPSM_EVENT_ADDRESS_CHANGE:\r\ncase RPSM_EVENT_FAB_SCN:\r\nbfa_fcxp_discard(rport->fcxp);\r\nWARN_ON(!(bfa_fcport_get_topology(rport->port->fcs->bfa) !=\r\nBFA_PORT_TOPOLOGY_LOOP));\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_nsdisc_sending);\r\nrport->ns_retries = 0;\r\nbfa_fcs_rport_send_nsdisc(rport, NULL);\r\nbreak;\r\ncase RPSM_EVENT_PLOGI_RCVD:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogiacc_sending);\r\nbfa_fcxp_discard(rport->fcxp);\r\nbfa_fcs_rport_send_plogiacc(rport, NULL);\r\nbreak;\r\ncase RPSM_EVENT_DELETE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_uninit);\r\nbfa_fcxp_discard(rport->fcxp);\r\nbfa_fcs_rport_free(rport);\r\nbreak;\r\ncase RPSM_EVENT_PLOGI_COMP:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_fcs_online);\r\nbfa_fcxp_discard(rport->fcxp);\r\nbfa_fcs_rport_fcs_online_action(rport);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_sm_fc4_fcs_online(struct bfa_fcs_rport_s *rport,\r\nenum rport_event event)\r\n{\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPSM_EVENT_FC4_FCS_ONLINE:\r\nif (rport->scsi_function == BFA_RPORT_INITIATOR) {\r\nif (!BFA_FCS_PID_IS_WKA(rport->pid))\r\nbfa_fcs_rpf_rport_online(rport);\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_online);\r\nbreak;\r\n}\r\nif (!rport->bfa_rport)\r\nrport->bfa_rport =\r\nbfa_rport_create(rport->fcs->bfa, rport);\r\nif (rport->bfa_rport) {\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_hal_online);\r\nbfa_fcs_rport_hal_online(rport);\r\n} else {\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logosend);\r\nbfa_fcs_rport_fcs_offline_action(rport);\r\n}\r\nbreak;\r\ncase RPSM_EVENT_PLOGI_RCVD:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_offline);\r\nrport->plogi_pending = BFA_TRUE;\r\nbfa_fcs_rport_fcs_offline_action(rport);\r\nbreak;\r\ncase RPSM_EVENT_PLOGI_COMP:\r\ncase RPSM_EVENT_LOGO_IMP:\r\ncase RPSM_EVENT_ADDRESS_CHANGE:\r\ncase RPSM_EVENT_FAB_SCN:\r\ncase RPSM_EVENT_SCN_OFFLINE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_offline);\r\nbfa_fcs_rport_fcs_offline_action(rport);\r\nbreak;\r\ncase RPSM_EVENT_LOGO_RCVD:\r\ncase RPSM_EVENT_PRLO_RCVD:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logorcv);\r\nbfa_fcs_rport_fcs_offline_action(rport);\r\nbreak;\r\ncase RPSM_EVENT_DELETE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logosend);\r\nbfa_fcs_rport_fcs_offline_action(rport);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\nbreak;\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_sm_hal_online(struct bfa_fcs_rport_s *rport,\r\nenum rport_event event)\r\n{\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPSM_EVENT_HCB_ONLINE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_online);\r\nbfa_fcs_rport_hal_online_action(rport);\r\nbreak;\r\ncase RPSM_EVENT_PLOGI_COMP:\r\nbreak;\r\ncase RPSM_EVENT_PRLO_RCVD:\r\ncase RPSM_EVENT_LOGO_RCVD:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logorcv);\r\nbfa_fcs_rport_fcs_offline_action(rport);\r\nbreak;\r\ncase RPSM_EVENT_FAB_SCN:\r\ncase RPSM_EVENT_LOGO_IMP:\r\ncase RPSM_EVENT_ADDRESS_CHANGE:\r\ncase RPSM_EVENT_SCN_OFFLINE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_offline);\r\nbfa_fcs_rport_fcs_offline_action(rport);\r\nbreak;\r\ncase RPSM_EVENT_PLOGI_RCVD:\r\nrport->plogi_pending = BFA_TRUE;\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_offline);\r\nbfa_fcs_rport_fcs_offline_action(rport);\r\nbreak;\r\ncase RPSM_EVENT_DELETE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logosend);\r\nbfa_fcs_rport_fcs_offline_action(rport);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_sm_online(struct bfa_fcs_rport_s *rport, enum rport_event event)\r\n{\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPSM_EVENT_FAB_SCN:\r\nif (bfa_fcs_fabric_is_switched(rport->port->fabric)) {\r\nbfa_sm_set_state(rport,\r\nbfa_fcs_rport_sm_nsquery_sending);\r\nrport->ns_retries = 0;\r\nbfa_fcs_rport_send_nsdisc(rport, NULL);\r\n} else {\r\nbfa_sm_set_state(rport,\r\nbfa_fcs_rport_sm_adisc_online_sending);\r\nbfa_fcs_rport_send_adisc(rport, NULL);\r\n}\r\nbreak;\r\ncase RPSM_EVENT_PLOGI_RCVD:\r\ncase RPSM_EVENT_LOGO_IMP:\r\ncase RPSM_EVENT_ADDRESS_CHANGE:\r\ncase RPSM_EVENT_SCN_OFFLINE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_offline);\r\nbfa_fcs_rport_hal_offline_action(rport);\r\nbreak;\r\ncase RPSM_EVENT_DELETE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logosend);\r\nbfa_fcs_rport_hal_offline_action(rport);\r\nbreak;\r\ncase RPSM_EVENT_LOGO_RCVD:\r\ncase RPSM_EVENT_PRLO_RCVD:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logorcv);\r\nbfa_fcs_rport_hal_offline_action(rport);\r\nbreak;\r\ncase RPSM_EVENT_SCN_ONLINE:\r\ncase RPSM_EVENT_PLOGI_COMP:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_sm_nsquery_sending(struct bfa_fcs_rport_s *rport,\r\nenum rport_event event)\r\n{\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPSM_EVENT_FCXP_SENT:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_nsquery);\r\nbreak;\r\ncase RPSM_EVENT_DELETE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logosend);\r\nbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\r\nbfa_fcs_rport_hal_offline_action(rport);\r\nbreak;\r\ncase RPSM_EVENT_FAB_SCN:\r\nbreak;\r\ncase RPSM_EVENT_LOGO_RCVD:\r\ncase RPSM_EVENT_PRLO_RCVD:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logorcv);\r\nbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\r\nbfa_fcs_rport_hal_offline_action(rport);\r\nbreak;\r\ncase RPSM_EVENT_LOGO_IMP:\r\ncase RPSM_EVENT_PLOGI_RCVD:\r\ncase RPSM_EVENT_ADDRESS_CHANGE:\r\ncase RPSM_EVENT_PLOGI_COMP:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_offline);\r\nbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\r\nbfa_fcs_rport_hal_offline_action(rport);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_sm_nsquery(struct bfa_fcs_rport_s *rport, enum rport_event event)\r\n{\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPSM_EVENT_ACCEPTED:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_adisc_online_sending);\r\nbfa_fcs_rport_send_adisc(rport, NULL);\r\nbreak;\r\ncase RPSM_EVENT_FAILED:\r\nrport->ns_retries++;\r\nif (rport->ns_retries < BFA_FCS_RPORT_MAX_RETRIES) {\r\nbfa_sm_set_state(rport,\r\nbfa_fcs_rport_sm_nsquery_sending);\r\nbfa_fcs_rport_send_nsdisc(rport, NULL);\r\n} else {\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_offline);\r\nbfa_fcs_rport_hal_offline_action(rport);\r\n}\r\nbreak;\r\ncase RPSM_EVENT_DELETE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logosend);\r\nbfa_fcxp_discard(rport->fcxp);\r\nbfa_fcs_rport_hal_offline_action(rport);\r\nbreak;\r\ncase RPSM_EVENT_FAB_SCN:\r\nbreak;\r\ncase RPSM_EVENT_LOGO_RCVD:\r\ncase RPSM_EVENT_PRLO_RCVD:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logorcv);\r\nbfa_fcxp_discard(rport->fcxp);\r\nbfa_fcs_rport_hal_offline_action(rport);\r\nbreak;\r\ncase RPSM_EVENT_PLOGI_COMP:\r\ncase RPSM_EVENT_ADDRESS_CHANGE:\r\ncase RPSM_EVENT_PLOGI_RCVD:\r\ncase RPSM_EVENT_LOGO_IMP:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_offline);\r\nbfa_fcxp_discard(rport->fcxp);\r\nbfa_fcs_rport_hal_offline_action(rport);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_sm_adisc_online_sending(struct bfa_fcs_rport_s *rport,\r\nenum rport_event event)\r\n{\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPSM_EVENT_FCXP_SENT:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_adisc_online);\r\nbreak;\r\ncase RPSM_EVENT_DELETE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logosend);\r\nbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\r\nbfa_fcs_rport_hal_offline_action(rport);\r\nbreak;\r\ncase RPSM_EVENT_LOGO_IMP:\r\ncase RPSM_EVENT_ADDRESS_CHANGE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_offline);\r\nbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\r\nbfa_fcs_rport_hal_offline_action(rport);\r\nbreak;\r\ncase RPSM_EVENT_LOGO_RCVD:\r\ncase RPSM_EVENT_PRLO_RCVD:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logorcv);\r\nbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\r\nbfa_fcs_rport_hal_offline_action(rport);\r\nbreak;\r\ncase RPSM_EVENT_FAB_SCN:\r\nbreak;\r\ncase RPSM_EVENT_PLOGI_RCVD:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_offline);\r\nbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\r\nbfa_fcs_rport_hal_offline_action(rport);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_sm_adisc_online(struct bfa_fcs_rport_s *rport,\r\nenum rport_event event)\r\n{\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPSM_EVENT_ACCEPTED:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_online);\r\nbreak;\r\ncase RPSM_EVENT_PLOGI_RCVD:\r\nbfa_fcxp_discard(rport->fcxp);\r\ncase RPSM_EVENT_FAILED:\r\ncase RPSM_EVENT_ADDRESS_CHANGE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_offline);\r\nbfa_fcs_rport_hal_offline_action(rport);\r\nbreak;\r\ncase RPSM_EVENT_DELETE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logosend);\r\nbfa_fcxp_discard(rport->fcxp);\r\nbfa_fcs_rport_hal_offline_action(rport);\r\nbreak;\r\ncase RPSM_EVENT_FAB_SCN:\r\nbreak;\r\ncase RPSM_EVENT_LOGO_IMP:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_offline);\r\nbfa_fcxp_discard(rport->fcxp);\r\nbfa_fcs_rport_hal_offline_action(rport);\r\nbreak;\r\ncase RPSM_EVENT_LOGO_RCVD:\r\ncase RPSM_EVENT_PRLO_RCVD:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logorcv);\r\nbfa_fcxp_discard(rport->fcxp);\r\nbfa_fcs_rport_hal_offline_action(rport);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_sm_adisc_offline_sending(struct bfa_fcs_rport_s *rport,\r\nenum rport_event event)\r\n{\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPSM_EVENT_FCXP_SENT:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_adisc_offline);\r\nbreak;\r\ncase RPSM_EVENT_DELETE:\r\ncase RPSM_EVENT_SCN_OFFLINE:\r\ncase RPSM_EVENT_LOGO_IMP:\r\ncase RPSM_EVENT_LOGO_RCVD:\r\ncase RPSM_EVENT_PRLO_RCVD:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\r\nbfa_fcxp_walloc_cancel(rport->fcs->bfa,\r\n&rport->fcxp_wqe);\r\nbfa_timer_start(rport->fcs->bfa, &rport->timer,\r\nbfa_fcs_rport_timeout, rport,\r\nbfa_fcs_rport_del_timeout);\r\nbreak;\r\ncase RPSM_EVENT_PLOGI_RCVD:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogiacc_sending);\r\nbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\r\nbfa_fcs_rport_send_plogiacc(rport, NULL);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_sm_adisc_offline(struct bfa_fcs_rport_s *rport,\r\nenum rport_event event)\r\n{\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPSM_EVENT_ACCEPTED:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_hal_online);\r\nbfa_fcs_rport_hal_online(rport);\r\nbreak;\r\ncase RPSM_EVENT_PLOGI_RCVD:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogiacc_sending);\r\nbfa_fcxp_discard(rport->fcxp);\r\nbfa_fcs_rport_send_plogiacc(rport, NULL);\r\nbreak;\r\ncase RPSM_EVENT_FAILED:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\r\nbfa_timer_start(rport->fcs->bfa, &rport->timer,\r\nbfa_fcs_rport_timeout, rport,\r\nbfa_fcs_rport_del_timeout);\r\nbreak;\r\ncase RPSM_EVENT_DELETE:\r\ncase RPSM_EVENT_SCN_OFFLINE:\r\ncase RPSM_EVENT_LOGO_IMP:\r\ncase RPSM_EVENT_LOGO_RCVD:\r\ncase RPSM_EVENT_PRLO_RCVD:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\r\nbfa_fcxp_discard(rport->fcxp);\r\nbfa_timer_start(rport->fcs->bfa, &rport->timer,\r\nbfa_fcs_rport_timeout, rport,\r\nbfa_fcs_rport_del_timeout);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_sm_fc4_logorcv(struct bfa_fcs_rport_s *rport,\r\nenum rport_event event)\r\n{\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPSM_EVENT_FC4_OFFLINE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_hcb_logorcv);\r\nbfa_fcs_rport_hal_offline(rport);\r\nbreak;\r\ncase RPSM_EVENT_DELETE:\r\nif (rport->pid && (rport->prlo == BFA_TRUE))\r\nbfa_fcs_rport_send_prlo_acc(rport);\r\nif (rport->pid && (rport->prlo == BFA_FALSE))\r\nbfa_fcs_rport_send_logo_acc(rport);\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_off_delete);\r\nbreak;\r\ncase RPSM_EVENT_SCN_ONLINE:\r\ncase RPSM_EVENT_SCN_OFFLINE:\r\ncase RPSM_EVENT_HCB_ONLINE:\r\ncase RPSM_EVENT_LOGO_RCVD:\r\ncase RPSM_EVENT_PRLO_RCVD:\r\ncase RPSM_EVENT_ADDRESS_CHANGE:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_sm_fc4_logosend(struct bfa_fcs_rport_s *rport,\r\nenum rport_event event)\r\n{\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPSM_EVENT_FC4_OFFLINE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_hcb_logosend);\r\nbfa_fcs_rport_hal_offline(rport);\r\nbreak;\r\ncase RPSM_EVENT_LOGO_RCVD:\r\nbfa_fcs_rport_send_logo_acc(rport);\r\ncase RPSM_EVENT_PRLO_RCVD:\r\nif (rport->prlo == BFA_TRUE)\r\nbfa_fcs_rport_send_prlo_acc(rport);\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_off_delete);\r\nbreak;\r\ncase RPSM_EVENT_HCB_ONLINE:\r\ncase RPSM_EVENT_DELETE:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_sm_fc4_offline(struct bfa_fcs_rport_s *rport,\r\nenum rport_event event)\r\n{\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPSM_EVENT_FC4_OFFLINE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_hcb_offline);\r\nbfa_fcs_rport_hal_offline(rport);\r\nbreak;\r\ncase RPSM_EVENT_SCN_ONLINE:\r\nbreak;\r\ncase RPSM_EVENT_LOGO_RCVD:\r\nbfa_fcs_rport_send_logo_acc(rport);\r\nbreak;\r\ncase RPSM_EVENT_PRLO_RCVD:\r\nbfa_fcs_rport_send_prlo_acc(rport);\r\nbreak;\r\ncase RPSM_EVENT_SCN_OFFLINE:\r\ncase RPSM_EVENT_HCB_ONLINE:\r\ncase RPSM_EVENT_FAB_SCN:\r\ncase RPSM_EVENT_LOGO_IMP:\r\ncase RPSM_EVENT_ADDRESS_CHANGE:\r\nbreak;\r\ncase RPSM_EVENT_DELETE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_logosend);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_sm_hcb_offline(struct bfa_fcs_rport_s *rport,\r\nenum rport_event event)\r\n{\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPSM_EVENT_HCB_OFFLINE:\r\nif (bfa_fcs_lport_is_online(rport->port) &&\r\n(rport->plogi_pending)) {\r\nrport->plogi_pending = BFA_FALSE;\r\nbfa_sm_set_state(rport,\r\nbfa_fcs_rport_sm_plogiacc_sending);\r\nbfa_fcs_rport_send_plogiacc(rport, NULL);\r\nbreak;\r\n}\r\ncase RPSM_EVENT_ADDRESS_CHANGE:\r\nif (!bfa_fcs_lport_is_online(rport->port)) {\r\nrport->pid = 0;\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\r\nbfa_timer_start(rport->fcs->bfa, &rport->timer,\r\nbfa_fcs_rport_timeout, rport,\r\nbfa_fcs_rport_del_timeout);\r\nbreak;\r\n}\r\nif (bfa_fcs_fabric_is_switched(rport->port->fabric)) {\r\nbfa_sm_set_state(rport,\r\nbfa_fcs_rport_sm_nsdisc_sending);\r\nrport->ns_retries = 0;\r\nbfa_fcs_rport_send_nsdisc(rport, NULL);\r\n} else if (bfa_fcport_get_topology(rport->port->fcs->bfa) ==\r\nBFA_PORT_TOPOLOGY_LOOP) {\r\nif (rport->scn_online) {\r\nbfa_sm_set_state(rport,\r\nbfa_fcs_rport_sm_adisc_offline_sending);\r\nbfa_fcs_rport_send_adisc(rport, NULL);\r\n} else {\r\nbfa_sm_set_state(rport,\r\nbfa_fcs_rport_sm_offline);\r\nbfa_timer_start(rport->fcs->bfa, &rport->timer,\r\nbfa_fcs_rport_timeout, rport,\r\nbfa_fcs_rport_del_timeout);\r\n}\r\n} else {\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogi_sending);\r\nrport->plogi_retries = 0;\r\nbfa_fcs_rport_send_plogi(rport, NULL);\r\n}\r\nbreak;\r\ncase RPSM_EVENT_DELETE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_uninit);\r\nbfa_fcs_rport_free(rport);\r\nbreak;\r\ncase RPSM_EVENT_SCN_ONLINE:\r\ncase RPSM_EVENT_SCN_OFFLINE:\r\ncase RPSM_EVENT_FAB_SCN:\r\ncase RPSM_EVENT_LOGO_RCVD:\r\ncase RPSM_EVENT_PRLO_RCVD:\r\ncase RPSM_EVENT_PLOGI_RCVD:\r\ncase RPSM_EVENT_LOGO_IMP:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_sm_hcb_logorcv(struct bfa_fcs_rport_s *rport,\r\nenum rport_event event)\r\n{\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPSM_EVENT_HCB_OFFLINE:\r\ncase RPSM_EVENT_ADDRESS_CHANGE:\r\nif (rport->pid && (rport->prlo == BFA_TRUE))\r\nbfa_fcs_rport_send_prlo_acc(rport);\r\nif (rport->pid && (rport->prlo == BFA_FALSE))\r\nbfa_fcs_rport_send_logo_acc(rport);\r\nif (bfa_fcs_lport_is_online(rport->port) &&\r\n(!BFA_FCS_PID_IS_WKA(rport->pid))) {\r\nif (bfa_fcs_fabric_is_switched(rport->port->fabric)) {\r\nbfa_sm_set_state(rport,\r\nbfa_fcs_rport_sm_nsdisc_sending);\r\nrport->ns_retries = 0;\r\nbfa_fcs_rport_send_nsdisc(rport, NULL);\r\n} else {\r\nbfa_sm_set_state(rport,\r\nbfa_fcs_rport_sm_plogi_sending);\r\nrport->plogi_retries = 0;\r\nbfa_fcs_rport_send_plogi(rport, NULL);\r\n}\r\n} else {\r\nif (!BFA_FCS_PID_IS_WKA(rport->pid))\r\nrport->pid = 0;\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\r\nbfa_timer_start(rport->fcs->bfa, &rport->timer,\r\nbfa_fcs_rport_timeout, rport,\r\nbfa_fcs_rport_del_timeout);\r\n}\r\nbreak;\r\ncase RPSM_EVENT_DELETE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_delete_pending);\r\nif (rport->pid && (rport->prlo == BFA_TRUE))\r\nbfa_fcs_rport_send_prlo_acc(rport);\r\nif (rport->pid && (rport->prlo == BFA_FALSE))\r\nbfa_fcs_rport_send_logo_acc(rport);\r\nbreak;\r\ncase RPSM_EVENT_LOGO_IMP:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_hcb_offline);\r\nbreak;\r\ncase RPSM_EVENT_SCN_ONLINE:\r\ncase RPSM_EVENT_SCN_OFFLINE:\r\ncase RPSM_EVENT_LOGO_RCVD:\r\ncase RPSM_EVENT_PRLO_RCVD:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_sm_hcb_logosend(struct bfa_fcs_rport_s *rport,\r\nenum rport_event event)\r\n{\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPSM_EVENT_HCB_OFFLINE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_logo_sending);\r\nbfa_fcs_rport_send_logo(rport, NULL);\r\nbreak;\r\ncase RPSM_EVENT_LOGO_RCVD:\r\nbfa_fcs_rport_send_logo_acc(rport);\r\ncase RPSM_EVENT_PRLO_RCVD:\r\nif (rport->prlo == BFA_TRUE)\r\nbfa_fcs_rport_send_prlo_acc(rport);\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_delete_pending);\r\nbreak;\r\ncase RPSM_EVENT_SCN_ONLINE:\r\ncase RPSM_EVENT_SCN_OFFLINE:\r\ncase RPSM_EVENT_ADDRESS_CHANGE:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_sm_logo_sending(struct bfa_fcs_rport_s *rport,\r\nenum rport_event event)\r\n{\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPSM_EVENT_FCXP_SENT:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_uninit);\r\nbfa_fcs_rport_free(rport);\r\nbreak;\r\ncase RPSM_EVENT_SCN_ONLINE:\r\ncase RPSM_EVENT_SCN_OFFLINE:\r\ncase RPSM_EVENT_FAB_SCN:\r\ncase RPSM_EVENT_ADDRESS_CHANGE:\r\nbreak;\r\ncase RPSM_EVENT_LOGO_RCVD:\r\nbfa_fcs_rport_send_logo_acc(rport);\r\ncase RPSM_EVENT_PRLO_RCVD:\r\nif (rport->prlo == BFA_TRUE)\r\nbfa_fcs_rport_send_prlo_acc(rport);\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_uninit);\r\nbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\r\nbfa_fcs_rport_free(rport);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_sm_offline(struct bfa_fcs_rport_s *rport, enum rport_event event)\r\n{\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPSM_EVENT_TIMEOUT:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_uninit);\r\nbfa_fcs_rport_free(rport);\r\nbreak;\r\ncase RPSM_EVENT_FAB_SCN:\r\ncase RPSM_EVENT_ADDRESS_CHANGE:\r\nbfa_timer_stop(&rport->timer);\r\nWARN_ON(!(bfa_fcport_get_topology(rport->port->fcs->bfa) !=\r\nBFA_PORT_TOPOLOGY_LOOP));\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_nsdisc_sending);\r\nrport->ns_retries = 0;\r\nbfa_fcs_rport_send_nsdisc(rport, NULL);\r\nbreak;\r\ncase RPSM_EVENT_DELETE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_uninit);\r\nbfa_timer_stop(&rport->timer);\r\nbfa_fcs_rport_free(rport);\r\nbreak;\r\ncase RPSM_EVENT_PLOGI_RCVD:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogiacc_sending);\r\nbfa_timer_stop(&rport->timer);\r\nbfa_fcs_rport_send_plogiacc(rport, NULL);\r\nbreak;\r\ncase RPSM_EVENT_LOGO_RCVD:\r\ncase RPSM_EVENT_PRLO_RCVD:\r\ncase RPSM_EVENT_LOGO_IMP:\r\ncase RPSM_EVENT_SCN_OFFLINE:\r\nbreak;\r\ncase RPSM_EVENT_PLOGI_COMP:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_fcs_online);\r\nbfa_timer_stop(&rport->timer);\r\nbfa_fcs_rport_fcs_online_action(rport);\r\nbreak;\r\ncase RPSM_EVENT_SCN_ONLINE:\r\nbfa_timer_stop(&rport->timer);\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogi_sending);\r\nbfa_fcs_rport_send_plogi(rport, NULL);\r\nbreak;\r\ncase RPSM_EVENT_PLOGI_SEND:\r\nbfa_timer_stop(&rport->timer);\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogi_sending);\r\nrport->plogi_retries = 0;\r\nbfa_fcs_rport_send_plogi(rport, NULL);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_sm_nsdisc_sending(struct bfa_fcs_rport_s *rport,\r\nenum rport_event event)\r\n{\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPSM_EVENT_FCXP_SENT:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_nsdisc_sent);\r\nbreak;\r\ncase RPSM_EVENT_DELETE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_uninit);\r\nbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\r\nbfa_fcs_rport_free(rport);\r\nbreak;\r\ncase RPSM_EVENT_PLOGI_RCVD:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogiacc_sending);\r\nbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\r\nbfa_fcs_rport_send_plogiacc(rport, NULL);\r\nbreak;\r\ncase RPSM_EVENT_FAB_SCN:\r\ncase RPSM_EVENT_LOGO_RCVD:\r\ncase RPSM_EVENT_PRLO_RCVD:\r\ncase RPSM_EVENT_PLOGI_SEND:\r\nbreak;\r\ncase RPSM_EVENT_ADDRESS_CHANGE:\r\nrport->ns_retries = 0;\r\nbreak;\r\ncase RPSM_EVENT_LOGO_IMP:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\r\nbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\r\nbfa_timer_start(rport->fcs->bfa, &rport->timer,\r\nbfa_fcs_rport_timeout, rport,\r\nbfa_fcs_rport_del_timeout);\r\nbreak;\r\ncase RPSM_EVENT_PLOGI_COMP:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_fcs_online);\r\nbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rport->fcxp_wqe);\r\nbfa_fcs_rport_fcs_online_action(rport);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_sm_nsdisc_retry(struct bfa_fcs_rport_s *rport,\r\nenum rport_event event)\r\n{\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPSM_EVENT_TIMEOUT:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_nsdisc_sending);\r\nbfa_fcs_rport_send_nsdisc(rport, NULL);\r\nbreak;\r\ncase RPSM_EVENT_FAB_SCN:\r\ncase RPSM_EVENT_ADDRESS_CHANGE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_nsdisc_sending);\r\nbfa_timer_stop(&rport->timer);\r\nrport->ns_retries = 0;\r\nbfa_fcs_rport_send_nsdisc(rport, NULL);\r\nbreak;\r\ncase RPSM_EVENT_DELETE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_uninit);\r\nbfa_timer_stop(&rport->timer);\r\nbfa_fcs_rport_free(rport);\r\nbreak;\r\ncase RPSM_EVENT_PLOGI_RCVD:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogiacc_sending);\r\nbfa_timer_stop(&rport->timer);\r\nbfa_fcs_rport_send_plogiacc(rport, NULL);\r\nbreak;\r\ncase RPSM_EVENT_LOGO_IMP:\r\nrport->pid = 0;\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\r\nbfa_timer_stop(&rport->timer);\r\nbfa_timer_start(rport->fcs->bfa, &rport->timer,\r\nbfa_fcs_rport_timeout, rport,\r\nbfa_fcs_rport_del_timeout);\r\nbreak;\r\ncase RPSM_EVENT_LOGO_RCVD:\r\nbfa_fcs_rport_send_logo_acc(rport);\r\nbreak;\r\ncase RPSM_EVENT_PRLO_RCVD:\r\nbfa_fcs_rport_send_prlo_acc(rport);\r\nbreak;\r\ncase RPSM_EVENT_PLOGI_COMP:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_fcs_online);\r\nbfa_timer_stop(&rport->timer);\r\nbfa_fcs_rport_fcs_online_action(rport);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_sm_nsdisc_sent(struct bfa_fcs_rport_s *rport,\r\nenum rport_event event)\r\n{\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPSM_EVENT_ACCEPTED:\r\ncase RPSM_EVENT_ADDRESS_CHANGE:\r\nif (rport->pid) {\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogi_sending);\r\nbfa_fcs_rport_send_plogi(rport, NULL);\r\n} else {\r\nbfa_sm_set_state(rport,\r\nbfa_fcs_rport_sm_nsdisc_sending);\r\nrport->ns_retries = 0;\r\nbfa_fcs_rport_send_nsdisc(rport, NULL);\r\n}\r\nbreak;\r\ncase RPSM_EVENT_FAILED:\r\nrport->ns_retries++;\r\nif (rport->ns_retries < BFA_FCS_RPORT_MAX_RETRIES) {\r\nbfa_sm_set_state(rport,\r\nbfa_fcs_rport_sm_nsdisc_sending);\r\nbfa_fcs_rport_send_nsdisc(rport, NULL);\r\n} else {\r\nrport->old_pid = rport->pid;\r\nrport->pid = 0;\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\r\nbfa_timer_start(rport->fcs->bfa, &rport->timer,\r\nbfa_fcs_rport_timeout, rport,\r\nbfa_fcs_rport_del_timeout);\r\n};\r\nbreak;\r\ncase RPSM_EVENT_DELETE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_uninit);\r\nbfa_fcxp_discard(rport->fcxp);\r\nbfa_fcs_rport_free(rport);\r\nbreak;\r\ncase RPSM_EVENT_PLOGI_RCVD:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_plogiacc_sending);\r\nbfa_fcxp_discard(rport->fcxp);\r\nbfa_fcs_rport_send_plogiacc(rport, NULL);\r\nbreak;\r\ncase RPSM_EVENT_LOGO_IMP:\r\nrport->pid = 0;\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_offline);\r\nbfa_fcxp_discard(rport->fcxp);\r\nbfa_timer_start(rport->fcs->bfa, &rport->timer,\r\nbfa_fcs_rport_timeout, rport,\r\nbfa_fcs_rport_del_timeout);\r\nbreak;\r\ncase RPSM_EVENT_PRLO_RCVD:\r\nbfa_fcs_rport_send_prlo_acc(rport);\r\nbreak;\r\ncase RPSM_EVENT_FAB_SCN:\r\nbreak;\r\ncase RPSM_EVENT_LOGO_RCVD:\r\nbfa_fcs_rport_send_logo_acc(rport);\r\nbreak;\r\ncase RPSM_EVENT_PLOGI_COMP:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_fc4_fcs_online);\r\nbfa_fcxp_discard(rport->fcxp);\r\nbfa_fcs_rport_fcs_online_action(rport);\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_sm_fc4_off_delete(struct bfa_fcs_rport_s *rport,\r\nenum rport_event event)\r\n{\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPSM_EVENT_FC4_OFFLINE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_delete_pending);\r\nbfa_fcs_rport_hal_offline(rport);\r\nbreak;\r\ncase RPSM_EVENT_DELETE:\r\ncase RPSM_EVENT_PLOGI_RCVD:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\nbreak;\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_sm_delete_pending(struct bfa_fcs_rport_s *rport,\r\nenum rport_event event)\r\n{\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPSM_EVENT_HCB_OFFLINE:\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_uninit);\r\nbfa_fcs_rport_free(rport);\r\nbreak;\r\ncase RPSM_EVENT_DELETE:\r\ncase RPSM_EVENT_LOGO_IMP:\r\ncase RPSM_EVENT_PLOGI_RCVD:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_send_plogi(void *rport_cbarg, struct bfa_fcxp_s *fcxp_alloced)\r\n{\r\nstruct bfa_fcs_rport_s *rport = rport_cbarg;\r\nstruct bfa_fcs_lport_s *port = rport->port;\r\nstruct fchs_s fchs;\r\nint len;\r\nstruct bfa_fcxp_s *fcxp;\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nfcxp = fcxp_alloced ? fcxp_alloced :\r\nbfa_fcs_fcxp_alloc(port->fcs, BFA_TRUE);\r\nif (!fcxp) {\r\nbfa_fcs_fcxp_alloc_wait(port->fcs->bfa, &rport->fcxp_wqe,\r\nbfa_fcs_rport_send_plogi, rport, BFA_TRUE);\r\nreturn;\r\n}\r\nrport->fcxp = fcxp;\r\nlen = fc_plogi_build(&fchs, bfa_fcxp_get_reqbuf(fcxp), rport->pid,\r\nbfa_fcs_lport_get_fcid(port), 0,\r\nport->port_cfg.pwwn, port->port_cfg.nwwn,\r\nbfa_fcport_get_maxfrsize(port->fcs->bfa),\r\nbfa_fcport_get_rx_bbcredit(port->fcs->bfa));\r\nbfa_fcxp_send(fcxp, NULL, port->fabric->vf_id, port->lp_tag, BFA_FALSE,\r\nFC_CLASS_3, len, &fchs, bfa_fcs_rport_plogi_response,\r\n(void *)rport, FC_MAX_PDUSZ, FC_ELS_TOV);\r\nrport->stats.plogis++;\r\nbfa_sm_send_event(rport, RPSM_EVENT_FCXP_SENT);\r\n}\r\nstatic void\r\nbfa_fcs_rport_plogi_response(void *fcsarg, struct bfa_fcxp_s *fcxp, void *cbarg,\r\nbfa_status_t req_status, u32 rsp_len,\r\nu32 resid_len, struct fchs_s *rsp_fchs)\r\n{\r\nstruct bfa_fcs_rport_s *rport = (struct bfa_fcs_rport_s *) cbarg;\r\nstruct fc_logi_s *plogi_rsp;\r\nstruct fc_ls_rjt_s *ls_rjt;\r\nstruct bfa_fcs_rport_s *twin;\r\nstruct list_head *qe;\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nif (req_status != BFA_STATUS_OK) {\r\nbfa_trc(rport->fcs, req_status);\r\nrport->stats.plogi_failed++;\r\nbfa_sm_send_event(rport, RPSM_EVENT_FAILED);\r\nreturn;\r\n}\r\nplogi_rsp = (struct fc_logi_s *) BFA_FCXP_RSP_PLD(fcxp);\r\nif (plogi_rsp->els_cmd.els_code != FC_ELS_ACC) {\r\nls_rjt = (struct fc_ls_rjt_s *) BFA_FCXP_RSP_PLD(fcxp);\r\nbfa_trc(rport->fcs, ls_rjt->reason_code);\r\nbfa_trc(rport->fcs, ls_rjt->reason_code_expl);\r\nif ((ls_rjt->reason_code == FC_LS_RJT_RSN_UNABLE_TO_PERF_CMD) &&\r\n(ls_rjt->reason_code_expl == FC_LS_RJT_EXP_INSUFF_RES)) {\r\nrport->stats.rjt_insuff_res++;\r\nbfa_sm_send_event(rport, RPSM_EVENT_PLOGI_RETRY);\r\nreturn;\r\n}\r\nrport->stats.plogi_rejects++;\r\nbfa_sm_send_event(rport, RPSM_EVENT_FAILED);\r\nreturn;\r\n}\r\nlist_for_each(qe, &rport->port->rport_q) {\r\ntwin = (struct bfa_fcs_rport_s *) qe;\r\nif (twin == rport)\r\ncontinue;\r\nif (!rport->pwwn && (plogi_rsp->port_name == twin->pwwn)) {\r\nbfa_trc(rport->fcs, twin->pid);\r\nbfa_trc(rport->fcs, rport->pid);\r\ntwin->stats.plogis += rport->stats.plogis;\r\ntwin->stats.plogi_rejects +=\r\nrport->stats.plogi_rejects;\r\ntwin->stats.plogi_timeouts +=\r\nrport->stats.plogi_timeouts;\r\ntwin->stats.plogi_failed +=\r\nrport->stats.plogi_failed;\r\ntwin->stats.plogi_rcvd += rport->stats.plogi_rcvd;\r\ntwin->stats.plogi_accs++;\r\nbfa_sm_send_event(rport, RPSM_EVENT_DELETE);\r\nbfa_fcs_rport_update(twin, plogi_rsp);\r\ntwin->pid = rsp_fchs->s_id;\r\nbfa_sm_send_event(twin, RPSM_EVENT_PLOGI_COMP);\r\nreturn;\r\n}\r\n}\r\nrport->stats.plogi_accs++;\r\nbfa_fcs_rport_update(rport, plogi_rsp);\r\nbfa_sm_send_event(rport, RPSM_EVENT_ACCEPTED);\r\n}\r\nstatic void\r\nbfa_fcs_rport_send_plogiacc(void *rport_cbarg, struct bfa_fcxp_s *fcxp_alloced)\r\n{\r\nstruct bfa_fcs_rport_s *rport = rport_cbarg;\r\nstruct bfa_fcs_lport_s *port = rport->port;\r\nstruct fchs_s fchs;\r\nint len;\r\nstruct bfa_fcxp_s *fcxp;\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->reply_oxid);\r\nfcxp = fcxp_alloced ? fcxp_alloced :\r\nbfa_fcs_fcxp_alloc(port->fcs, BFA_FALSE);\r\nif (!fcxp) {\r\nbfa_fcs_fcxp_alloc_wait(port->fcs->bfa, &rport->fcxp_wqe,\r\nbfa_fcs_rport_send_plogiacc, rport, BFA_FALSE);\r\nreturn;\r\n}\r\nrport->fcxp = fcxp;\r\nlen = fc_plogi_acc_build(&fchs, bfa_fcxp_get_reqbuf(fcxp),\r\nrport->pid, bfa_fcs_lport_get_fcid(port),\r\nrport->reply_oxid, port->port_cfg.pwwn,\r\nport->port_cfg.nwwn,\r\nbfa_fcport_get_maxfrsize(port->fcs->bfa),\r\nbfa_fcport_get_rx_bbcredit(port->fcs->bfa));\r\nbfa_fcxp_send(fcxp, NULL, port->fabric->vf_id, port->lp_tag, BFA_FALSE,\r\nFC_CLASS_3, len, &fchs, NULL, NULL, FC_MAX_PDUSZ, 0);\r\nbfa_sm_send_event(rport, RPSM_EVENT_FCXP_SENT);\r\n}\r\nstatic void\r\nbfa_fcs_rport_send_adisc(void *rport_cbarg, struct bfa_fcxp_s *fcxp_alloced)\r\n{\r\nstruct bfa_fcs_rport_s *rport = rport_cbarg;\r\nstruct bfa_fcs_lport_s *port = rport->port;\r\nstruct fchs_s fchs;\r\nint len;\r\nstruct bfa_fcxp_s *fcxp;\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nfcxp = fcxp_alloced ? fcxp_alloced :\r\nbfa_fcs_fcxp_alloc(port->fcs, BFA_TRUE);\r\nif (!fcxp) {\r\nbfa_fcs_fcxp_alloc_wait(port->fcs->bfa, &rport->fcxp_wqe,\r\nbfa_fcs_rport_send_adisc, rport, BFA_TRUE);\r\nreturn;\r\n}\r\nrport->fcxp = fcxp;\r\nlen = fc_adisc_build(&fchs, bfa_fcxp_get_reqbuf(fcxp), rport->pid,\r\nbfa_fcs_lport_get_fcid(port), 0,\r\nport->port_cfg.pwwn, port->port_cfg.nwwn);\r\nbfa_fcxp_send(fcxp, NULL, port->fabric->vf_id, port->lp_tag, BFA_FALSE,\r\nFC_CLASS_3, len, &fchs, bfa_fcs_rport_adisc_response,\r\nrport, FC_MAX_PDUSZ, FC_ELS_TOV);\r\nrport->stats.adisc_sent++;\r\nbfa_sm_send_event(rport, RPSM_EVENT_FCXP_SENT);\r\n}\r\nstatic void\r\nbfa_fcs_rport_adisc_response(void *fcsarg, struct bfa_fcxp_s *fcxp, void *cbarg,\r\nbfa_status_t req_status, u32 rsp_len,\r\nu32 resid_len, struct fchs_s *rsp_fchs)\r\n{\r\nstruct bfa_fcs_rport_s *rport = (struct bfa_fcs_rport_s *) cbarg;\r\nvoid *pld = bfa_fcxp_get_rspbuf(fcxp);\r\nstruct fc_ls_rjt_s *ls_rjt;\r\nif (req_status != BFA_STATUS_OK) {\r\nbfa_trc(rport->fcs, req_status);\r\nrport->stats.adisc_failed++;\r\nbfa_sm_send_event(rport, RPSM_EVENT_FAILED);\r\nreturn;\r\n}\r\nif (fc_adisc_rsp_parse((struct fc_adisc_s *)pld, rsp_len, rport->pwwn,\r\nrport->nwwn) == FC_PARSE_OK) {\r\nrport->stats.adisc_accs++;\r\nbfa_sm_send_event(rport, RPSM_EVENT_ACCEPTED);\r\nreturn;\r\n}\r\nrport->stats.adisc_rejects++;\r\nls_rjt = pld;\r\nbfa_trc(rport->fcs, ls_rjt->els_cmd.els_code);\r\nbfa_trc(rport->fcs, ls_rjt->reason_code);\r\nbfa_trc(rport->fcs, ls_rjt->reason_code_expl);\r\nbfa_sm_send_event(rport, RPSM_EVENT_FAILED);\r\n}\r\nstatic void\r\nbfa_fcs_rport_send_nsdisc(void *rport_cbarg, struct bfa_fcxp_s *fcxp_alloced)\r\n{\r\nstruct bfa_fcs_rport_s *rport = rport_cbarg;\r\nstruct bfa_fcs_lport_s *port = rport->port;\r\nstruct fchs_s fchs;\r\nstruct bfa_fcxp_s *fcxp;\r\nint len;\r\nbfa_cb_fcxp_send_t cbfn;\r\nbfa_trc(rport->fcs, rport->pid);\r\nfcxp = fcxp_alloced ? fcxp_alloced :\r\nbfa_fcs_fcxp_alloc(port->fcs, BFA_TRUE);\r\nif (!fcxp) {\r\nbfa_fcs_fcxp_alloc_wait(port->fcs->bfa, &rport->fcxp_wqe,\r\nbfa_fcs_rport_send_nsdisc, rport, BFA_TRUE);\r\nreturn;\r\n}\r\nrport->fcxp = fcxp;\r\nif (rport->pwwn) {\r\nlen = fc_gidpn_build(&fchs, bfa_fcxp_get_reqbuf(fcxp),\r\nbfa_fcs_lport_get_fcid(port), 0, rport->pwwn);\r\ncbfn = bfa_fcs_rport_gidpn_response;\r\n} else {\r\nlen = fc_gpnid_build(&fchs, bfa_fcxp_get_reqbuf(fcxp),\r\nbfa_fcs_lport_get_fcid(port), 0, rport->pid);\r\ncbfn = bfa_fcs_rport_gpnid_response;\r\n}\r\nbfa_fcxp_send(fcxp, NULL, port->fabric->vf_id, port->lp_tag, BFA_FALSE,\r\nFC_CLASS_3, len, &fchs, cbfn,\r\n(void *)rport, FC_MAX_PDUSZ, FC_FCCT_TOV);\r\nbfa_sm_send_event(rport, RPSM_EVENT_FCXP_SENT);\r\n}\r\nstatic void\r\nbfa_fcs_rport_gidpn_response(void *fcsarg, struct bfa_fcxp_s *fcxp, void *cbarg,\r\nbfa_status_t req_status, u32 rsp_len,\r\nu32 resid_len, struct fchs_s *rsp_fchs)\r\n{\r\nstruct bfa_fcs_rport_s *rport = (struct bfa_fcs_rport_s *) cbarg;\r\nstruct ct_hdr_s *cthdr;\r\nstruct fcgs_gidpn_resp_s *gidpn_rsp;\r\nstruct bfa_fcs_rport_s *twin;\r\nstruct list_head *qe;\r\nbfa_trc(rport->fcs, rport->pwwn);\r\ncthdr = (struct ct_hdr_s *) BFA_FCXP_RSP_PLD(fcxp);\r\ncthdr->cmd_rsp_code = be16_to_cpu(cthdr->cmd_rsp_code);\r\nif (cthdr->cmd_rsp_code == CT_RSP_ACCEPT) {\r\ngidpn_rsp = (struct fcgs_gidpn_resp_s *) (cthdr + 1);\r\nif (gidpn_rsp->dap == rport->pid) {\r\nbfa_sm_send_event(rport, RPSM_EVENT_ACCEPTED);\r\n} else {\r\nlist_for_each(qe, &rport->port->rport_q) {\r\ntwin = (struct bfa_fcs_rport_s *) qe;\r\nif (twin == rport)\r\ncontinue;\r\nif (gidpn_rsp->dap == twin->pid) {\r\nbfa_trc(rport->fcs, twin->pid);\r\nbfa_trc(rport->fcs, rport->pid);\r\ntwin->pid = 0;\r\nbfa_sm_send_event(twin,\r\nRPSM_EVENT_ADDRESS_CHANGE);\r\n}\r\n}\r\nrport->pid = gidpn_rsp->dap;\r\nbfa_sm_send_event(rport, RPSM_EVENT_ADDRESS_CHANGE);\r\n}\r\nreturn;\r\n}\r\nswitch (cthdr->reason_code) {\r\ncase CT_RSN_LOGICAL_BUSY:\r\nbfa_sm_send_event(rport, RPSM_EVENT_TIMEOUT);\r\nbreak;\r\ncase CT_RSN_UNABLE_TO_PERF:\r\nbfa_sm_send_event(rport, RPSM_EVENT_FAILED);\r\nbreak;\r\ndefault:\r\nbfa_sm_send_event(rport, RPSM_EVENT_FAILED);\r\nbreak;\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_gpnid_response(void *fcsarg, struct bfa_fcxp_s *fcxp, void *cbarg,\r\nbfa_status_t req_status, u32 rsp_len,\r\nu32 resid_len, struct fchs_s *rsp_fchs)\r\n{\r\nstruct bfa_fcs_rport_s *rport = (struct bfa_fcs_rport_s *) cbarg;\r\nstruct ct_hdr_s *cthdr;\r\nbfa_trc(rport->fcs, rport->pwwn);\r\ncthdr = (struct ct_hdr_s *) BFA_FCXP_RSP_PLD(fcxp);\r\ncthdr->cmd_rsp_code = be16_to_cpu(cthdr->cmd_rsp_code);\r\nif (cthdr->cmd_rsp_code == CT_RSP_ACCEPT) {\r\nbfa_sm_send_event(rport, RPSM_EVENT_ACCEPTED);\r\nreturn;\r\n}\r\nswitch (cthdr->reason_code) {\r\ncase CT_RSN_LOGICAL_BUSY:\r\nbfa_sm_send_event(rport, RPSM_EVENT_TIMEOUT);\r\nbreak;\r\ncase CT_RSN_UNABLE_TO_PERF:\r\nbfa_sm_send_event(rport, RPSM_EVENT_FAILED);\r\nbreak;\r\ndefault:\r\nbfa_sm_send_event(rport, RPSM_EVENT_FAILED);\r\nbreak;\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_send_logo(void *rport_cbarg, struct bfa_fcxp_s *fcxp_alloced)\r\n{\r\nstruct bfa_fcs_rport_s *rport = rport_cbarg;\r\nstruct bfa_fcs_lport_s *port;\r\nstruct fchs_s fchs;\r\nstruct bfa_fcxp_s *fcxp;\r\nu16 len;\r\nbfa_trc(rport->fcs, rport->pid);\r\nport = rport->port;\r\nfcxp = fcxp_alloced ? fcxp_alloced :\r\nbfa_fcs_fcxp_alloc(port->fcs, BFA_FALSE);\r\nif (!fcxp) {\r\nbfa_fcs_fcxp_alloc_wait(port->fcs->bfa, &rport->fcxp_wqe,\r\nbfa_fcs_rport_send_logo, rport, BFA_FALSE);\r\nreturn;\r\n}\r\nrport->fcxp = fcxp;\r\nlen = fc_logo_build(&fchs, bfa_fcxp_get_reqbuf(fcxp), rport->pid,\r\nbfa_fcs_lport_get_fcid(port), 0,\r\nbfa_fcs_lport_get_pwwn(port));\r\nbfa_fcxp_send(fcxp, NULL, port->fabric->vf_id, port->lp_tag, BFA_FALSE,\r\nFC_CLASS_3, len, &fchs, NULL,\r\nrport, FC_MAX_PDUSZ, FC_ELS_TOV);\r\nrport->stats.logos++;\r\nbfa_fcxp_discard(rport->fcxp);\r\nbfa_sm_send_event(rport, RPSM_EVENT_FCXP_SENT);\r\n}\r\nstatic void\r\nbfa_fcs_rport_send_logo_acc(void *rport_cbarg)\r\n{\r\nstruct bfa_fcs_rport_s *rport = rport_cbarg;\r\nstruct bfa_fcs_lport_s *port;\r\nstruct fchs_s fchs;\r\nstruct bfa_fcxp_s *fcxp;\r\nu16 len;\r\nbfa_trc(rport->fcs, rport->pid);\r\nport = rport->port;\r\nfcxp = bfa_fcs_fcxp_alloc(port->fcs, BFA_FALSE);\r\nif (!fcxp)\r\nreturn;\r\nrport->stats.logo_rcvd++;\r\nlen = fc_logo_acc_build(&fchs, bfa_fcxp_get_reqbuf(fcxp),\r\nrport->pid, bfa_fcs_lport_get_fcid(port),\r\nrport->reply_oxid);\r\nbfa_fcxp_send(fcxp, NULL, port->fabric->vf_id, port->lp_tag, BFA_FALSE,\r\nFC_CLASS_3, len, &fchs, NULL, NULL, FC_MAX_PDUSZ, 0);\r\n}\r\nstatic void\r\nbfa_fcs_rport_timeout(void *arg)\r\n{\r\nstruct bfa_fcs_rport_s *rport = (struct bfa_fcs_rport_s *) arg;\r\nrport->stats.plogi_timeouts++;\r\nbfa_stats(rport->port, rport_plogi_timeouts);\r\nbfa_sm_send_event(rport, RPSM_EVENT_TIMEOUT);\r\n}\r\nstatic void\r\nbfa_fcs_rport_process_prli(struct bfa_fcs_rport_s *rport,\r\nstruct fchs_s *rx_fchs, u16 len)\r\n{\r\nstruct bfa_fcxp_s *fcxp;\r\nstruct fchs_s fchs;\r\nstruct bfa_fcs_lport_s *port = rport->port;\r\nstruct fc_prli_s *prli;\r\nbfa_trc(port->fcs, rx_fchs->s_id);\r\nbfa_trc(port->fcs, rx_fchs->d_id);\r\nrport->stats.prli_rcvd++;\r\nprli = (struct fc_prli_s *) (rx_fchs + 1);\r\nif (prli->parampage.servparams.target) {\r\nbfa_trc(port->fcs, rx_fchs->s_id);\r\nrport->scsi_function = BFA_RPORT_TARGET;\r\n} else {\r\nbfa_trc(rport->fcs, prli->parampage.type);\r\nrport->scsi_function = BFA_RPORT_INITIATOR;\r\nbfa_fcs_itnim_is_initiator(rport->itnim);\r\n}\r\nfcxp = bfa_fcs_fcxp_alloc(port->fcs, BFA_FALSE);\r\nif (!fcxp)\r\nreturn;\r\nlen = fc_prli_acc_build(&fchs, bfa_fcxp_get_reqbuf(fcxp),\r\nrx_fchs->s_id, bfa_fcs_lport_get_fcid(port),\r\nrx_fchs->ox_id, port->port_cfg.roles);\r\nbfa_fcxp_send(fcxp, NULL, port->fabric->vf_id, port->lp_tag, BFA_FALSE,\r\nFC_CLASS_3, len, &fchs, NULL, NULL, FC_MAX_PDUSZ, 0);\r\n}\r\nstatic void\r\nbfa_fcs_rport_process_rpsc(struct bfa_fcs_rport_s *rport,\r\nstruct fchs_s *rx_fchs, u16 len)\r\n{\r\nstruct bfa_fcxp_s *fcxp;\r\nstruct fchs_s fchs;\r\nstruct bfa_fcs_lport_s *port = rport->port;\r\nstruct fc_rpsc_speed_info_s speeds;\r\nstruct bfa_port_attr_s pport_attr;\r\nbfa_trc(port->fcs, rx_fchs->s_id);\r\nbfa_trc(port->fcs, rx_fchs->d_id);\r\nrport->stats.rpsc_rcvd++;\r\nspeeds.port_speed_cap =\r\nRPSC_SPEED_CAP_1G | RPSC_SPEED_CAP_2G | RPSC_SPEED_CAP_4G |\r\nRPSC_SPEED_CAP_8G;\r\nbfa_fcport_get_attr(port->fcs->bfa, &pport_attr);\r\nspeeds.port_op_speed = fc_bfa_speed_to_rpsc_operspeed(pport_attr.speed);\r\nfcxp = bfa_fcs_fcxp_alloc(port->fcs, BFA_FALSE);\r\nif (!fcxp)\r\nreturn;\r\nlen = fc_rpsc_acc_build(&fchs, bfa_fcxp_get_reqbuf(fcxp),\r\nrx_fchs->s_id, bfa_fcs_lport_get_fcid(port),\r\nrx_fchs->ox_id, &speeds);\r\nbfa_fcxp_send(fcxp, NULL, port->fabric->vf_id, port->lp_tag, BFA_FALSE,\r\nFC_CLASS_3, len, &fchs, NULL, NULL, FC_MAX_PDUSZ, 0);\r\n}\r\nstatic void\r\nbfa_fcs_rport_process_adisc(struct bfa_fcs_rport_s *rport,\r\nstruct fchs_s *rx_fchs, u16 len)\r\n{\r\nstruct bfa_fcxp_s *fcxp;\r\nstruct fchs_s fchs;\r\nstruct bfa_fcs_lport_s *port = rport->port;\r\nstruct fc_adisc_s *adisc;\r\nbfa_trc(port->fcs, rx_fchs->s_id);\r\nbfa_trc(port->fcs, rx_fchs->d_id);\r\nrport->stats.adisc_rcvd++;\r\nadisc = (struct fc_adisc_s *) (rx_fchs + 1);\r\nif (bfa_fcs_itnim_get_online_state(rport->itnim) == BFA_STATUS_OK) {\r\nfcxp = bfa_fcs_fcxp_alloc(port->fcs, BFA_FALSE);\r\nif (!fcxp)\r\nreturn;\r\nlen = fc_adisc_acc_build(&fchs, bfa_fcxp_get_reqbuf(fcxp),\r\nrx_fchs->s_id, bfa_fcs_lport_get_fcid(port),\r\nrx_fchs->ox_id, port->port_cfg.pwwn,\r\nport->port_cfg.nwwn);\r\nbfa_fcxp_send(fcxp, NULL, port->fabric->vf_id, port->lp_tag,\r\nBFA_FALSE, FC_CLASS_3, len, &fchs, NULL, NULL,\r\nFC_MAX_PDUSZ, 0);\r\n} else {\r\nrport->stats.adisc_rejected++;\r\nbfa_fcs_rport_send_ls_rjt(rport, rx_fchs,\r\nFC_LS_RJT_RSN_UNABLE_TO_PERF_CMD,\r\nFC_LS_RJT_EXP_LOGIN_REQUIRED);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_hal_online(struct bfa_fcs_rport_s *rport)\r\n{\r\nstruct bfa_fcs_lport_s *port = rport->port;\r\nstruct bfa_rport_info_s rport_info;\r\nrport_info.pid = rport->pid;\r\nrport_info.local_pid = port->pid;\r\nrport_info.lp_tag = port->lp_tag;\r\nrport_info.vf_id = port->fabric->vf_id;\r\nrport_info.vf_en = port->fabric->is_vf;\r\nrport_info.fc_class = rport->fc_cos;\r\nrport_info.cisc = rport->cisc;\r\nrport_info.max_frmsz = rport->maxfrsize;\r\nbfa_rport_online(rport->bfa_rport, &rport_info);\r\n}\r\nstatic void\r\nbfa_fcs_rport_hal_offline(struct bfa_fcs_rport_s *rport)\r\n{\r\nif (rport->bfa_rport)\r\nbfa_sm_send_event(rport->bfa_rport, BFA_RPORT_SM_OFFLINE);\r\nelse\r\nbfa_cb_rport_offline(rport);\r\n}\r\nstatic struct bfa_fcs_rport_s *\r\nbfa_fcs_rport_alloc(struct bfa_fcs_lport_s *port, wwn_t pwwn, u32 rpid)\r\n{\r\nstruct bfa_fcs_s *fcs = port->fcs;\r\nstruct bfa_fcs_rport_s *rport;\r\nstruct bfad_rport_s *rport_drv;\r\nif (fcs->num_rport_logins >= bfa_fcs_rport_max_logins) {\r\nbfa_trc(fcs, rpid);\r\nreturn NULL;\r\n}\r\nif (bfa_fcb_rport_alloc(fcs->bfad, &rport, &rport_drv)\r\n!= BFA_STATUS_OK) {\r\nbfa_trc(fcs, rpid);\r\nreturn NULL;\r\n}\r\nrport->port = port;\r\nrport->fcs = fcs;\r\nrport->rp_drv = rport_drv;\r\nrport->pid = rpid;\r\nrport->pwwn = pwwn;\r\nrport->old_pid = 0;\r\nrport->bfa_rport = NULL;\r\nWARN_ON(!bfa_fcs_lport_is_initiator(port));\r\nif (bfa_fcs_lport_is_initiator(port)) {\r\nrport->itnim = bfa_fcs_itnim_create(rport);\r\nif (!rport->itnim) {\r\nbfa_trc(fcs, rpid);\r\nkfree(rport_drv);\r\nreturn NULL;\r\n}\r\n}\r\nbfa_fcs_lport_add_rport(port, rport);\r\nfcs->num_rport_logins++;\r\nbfa_sm_set_state(rport, bfa_fcs_rport_sm_uninit);\r\nif (!BFA_FCS_PID_IS_WKA(rport->pid))\r\nbfa_fcs_rpf_init(rport);\r\nreturn rport;\r\n}\r\nstatic void\r\nbfa_fcs_rport_free(struct bfa_fcs_rport_s *rport)\r\n{\r\nstruct bfa_fcs_lport_s *port = rport->port;\r\nstruct bfa_fcs_s *fcs = port->fcs;\r\nrport->plogi_pending = BFA_FALSE;\r\nif (bfa_fcs_lport_is_initiator(port)) {\r\nbfa_fcs_itnim_delete(rport->itnim);\r\nif (rport->pid != 0 && !BFA_FCS_PID_IS_WKA(rport->pid))\r\nbfa_fcs_rpf_rport_offline(rport);\r\n}\r\nif (rport->bfa_rport) {\r\nbfa_sm_send_event(rport->bfa_rport, BFA_RPORT_SM_DELETE);\r\nrport->bfa_rport = NULL;\r\n}\r\nbfa_fcs_lport_del_rport(port, rport);\r\nfcs->num_rport_logins--;\r\nkfree(rport->rp_drv);\r\n}\r\nstatic void\r\nbfa_fcs_rport_aen_post(struct bfa_fcs_rport_s *rport,\r\nenum bfa_rport_aen_event event,\r\nstruct bfa_rport_aen_data_s *data)\r\n{\r\nstruct bfa_fcs_lport_s *port = rport->port;\r\nstruct bfad_s *bfad = (struct bfad_s *)port->fcs->bfad;\r\nstruct bfa_aen_entry_s *aen_entry;\r\nbfad_get_aen_entry(bfad, aen_entry);\r\nif (!aen_entry)\r\nreturn;\r\nif (event == BFA_RPORT_AEN_QOS_PRIO)\r\naen_entry->aen_data.rport.priv.qos = data->priv.qos;\r\nelse if (event == BFA_RPORT_AEN_QOS_FLOWID)\r\naen_entry->aen_data.rport.priv.qos = data->priv.qos;\r\naen_entry->aen_data.rport.vf_id = rport->port->fabric->vf_id;\r\naen_entry->aen_data.rport.ppwwn = bfa_fcs_lport_get_pwwn(\r\nbfa_fcs_get_base_port(rport->fcs));\r\naen_entry->aen_data.rport.lpwwn = bfa_fcs_lport_get_pwwn(rport->port);\r\naen_entry->aen_data.rport.rpwwn = rport->pwwn;\r\nbfad_im_post_vendor_event(aen_entry, bfad, ++rport->fcs->fcs_aen_seq,\r\nBFA_AEN_CAT_RPORT, event);\r\n}\r\nstatic void\r\nbfa_fcs_rport_fcs_online_action(struct bfa_fcs_rport_s *rport)\r\n{\r\nif ((!rport->pid) || (!rport->pwwn)) {\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_sm_fault(rport->fcs, rport->pid);\r\n}\r\nbfa_sm_send_event(rport->itnim, BFA_FCS_ITNIM_SM_FCS_ONLINE);\r\n}\r\nstatic void\r\nbfa_fcs_rport_hal_online_action(struct bfa_fcs_rport_s *rport)\r\n{\r\nstruct bfa_fcs_lport_s *port = rport->port;\r\nstruct bfad_s *bfad = (struct bfad_s *)port->fcs->bfad;\r\nchar lpwwn_buf[BFA_STRING_32];\r\nchar rpwwn_buf[BFA_STRING_32];\r\nrport->stats.onlines++;\r\nif ((!rport->pid) || (!rport->pwwn)) {\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_sm_fault(rport->fcs, rport->pid);\r\n}\r\nif (bfa_fcs_lport_is_initiator(port)) {\r\nbfa_fcs_itnim_brp_online(rport->itnim);\r\nif (!BFA_FCS_PID_IS_WKA(rport->pid))\r\nbfa_fcs_rpf_rport_online(rport);\r\n};\r\nwwn2str(lpwwn_buf, bfa_fcs_lport_get_pwwn(port));\r\nwwn2str(rpwwn_buf, rport->pwwn);\r\nif (!BFA_FCS_PID_IS_WKA(rport->pid)) {\r\nBFA_LOG(KERN_INFO, bfad, bfa_log_level,\r\n"Remote port (WWN = %s) online for logical port (WWN = %s)\n",\r\nrpwwn_buf, lpwwn_buf);\r\nbfa_fcs_rport_aen_post(rport, BFA_RPORT_AEN_ONLINE, NULL);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_fcs_offline_action(struct bfa_fcs_rport_s *rport)\r\n{\r\nif (!BFA_FCS_PID_IS_WKA(rport->pid))\r\nbfa_fcs_rpf_rport_offline(rport);\r\nbfa_fcs_itnim_rport_offline(rport->itnim);\r\n}\r\nstatic void\r\nbfa_fcs_rport_hal_offline_action(struct bfa_fcs_rport_s *rport)\r\n{\r\nstruct bfa_fcs_lport_s *port = rport->port;\r\nstruct bfad_s *bfad = (struct bfad_s *)port->fcs->bfad;\r\nchar lpwwn_buf[BFA_STRING_32];\r\nchar rpwwn_buf[BFA_STRING_32];\r\nif (!rport->bfa_rport) {\r\nbfa_fcs_rport_fcs_offline_action(rport);\r\nreturn;\r\n}\r\nrport->stats.offlines++;\r\nwwn2str(lpwwn_buf, bfa_fcs_lport_get_pwwn(port));\r\nwwn2str(rpwwn_buf, rport->pwwn);\r\nif (!BFA_FCS_PID_IS_WKA(rport->pid)) {\r\nif (bfa_fcs_lport_is_online(rport->port) == BFA_TRUE) {\r\nBFA_LOG(KERN_ERR, bfad, bfa_log_level,\r\n"Remote port (WWN = %s) connectivity lost for "\r\n"logical port (WWN = %s)\n",\r\nrpwwn_buf, lpwwn_buf);\r\nbfa_fcs_rport_aen_post(rport,\r\nBFA_RPORT_AEN_DISCONNECT, NULL);\r\n} else {\r\nBFA_LOG(KERN_INFO, bfad, bfa_log_level,\r\n"Remote port (WWN = %s) offlined by "\r\n"logical port (WWN = %s)\n",\r\nrpwwn_buf, lpwwn_buf);\r\nbfa_fcs_rport_aen_post(rport,\r\nBFA_RPORT_AEN_OFFLINE, NULL);\r\n}\r\n}\r\nif (bfa_fcs_lport_is_initiator(port)) {\r\nbfa_fcs_itnim_rport_offline(rport->itnim);\r\nif (!BFA_FCS_PID_IS_WKA(rport->pid))\r\nbfa_fcs_rpf_rport_offline(rport);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_update(struct bfa_fcs_rport_s *rport, struct fc_logi_s *plogi)\r\n{\r\nbfa_fcs_lport_t *port = rport->port;\r\nrport->pwwn = plogi->port_name;\r\nrport->nwwn = plogi->node_name;\r\nrport->fc_cos = 0;\r\nif (plogi->class3.class_valid)\r\nrport->fc_cos = FC_CLASS_3;\r\nif (plogi->class2.class_valid)\r\nrport->fc_cos |= FC_CLASS_2;\r\nrport->cisc = plogi->csp.cisc;\r\nif (be16_to_cpu(plogi->class3.rxsz) < be16_to_cpu(plogi->csp.rxsz))\r\nrport->maxfrsize = be16_to_cpu(plogi->class3.rxsz);\r\nelse\r\nrport->maxfrsize = be16_to_cpu(plogi->csp.rxsz);\r\nbfa_trc(port->fcs, be16_to_cpu(plogi->csp.bbcred));\r\nbfa_trc(port->fcs, port->fabric->bb_credit);\r\nif ((!bfa_fcs_fabric_is_switched(port->fabric)) &&\r\n(be16_to_cpu(plogi->csp.bbcred) < port->fabric->bb_credit)) {\r\nbfa_trc(port->fcs, be16_to_cpu(plogi->csp.bbcred));\r\nbfa_trc(port->fcs, port->fabric->bb_credit);\r\nport->fabric->bb_credit = be16_to_cpu(plogi->csp.bbcred);\r\nbfa_fcport_set_tx_bbcredit(port->fcs->bfa,\r\nport->fabric->bb_credit);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_process_logo(struct bfa_fcs_rport_s *rport, struct fchs_s *fchs)\r\n{\r\nrport->reply_oxid = fchs->ox_id;\r\nbfa_trc(rport->fcs, rport->reply_oxid);\r\nrport->prlo = BFA_FALSE;\r\nrport->stats.logo_rcvd++;\r\nbfa_sm_send_event(rport, RPSM_EVENT_LOGO_RCVD);\r\n}\r\nstruct bfa_fcs_rport_s *\r\nbfa_fcs_rport_create(struct bfa_fcs_lport_s *port, u32 rpid)\r\n{\r\nstruct bfa_fcs_rport_s *rport;\r\nbfa_trc(port->fcs, rpid);\r\nrport = bfa_fcs_rport_alloc(port, WWN_NULL, rpid);\r\nif (!rport)\r\nreturn NULL;\r\nbfa_sm_send_event(rport, RPSM_EVENT_PLOGI_SEND);\r\nreturn rport;\r\n}\r\nstruct bfa_fcs_rport_s *\r\nbfa_fcs_rport_create_by_wwn(struct bfa_fcs_lport_s *port, wwn_t rpwwn)\r\n{\r\nstruct bfa_fcs_rport_s *rport;\r\nbfa_trc(port->fcs, rpwwn);\r\nrport = bfa_fcs_rport_alloc(port, rpwwn, 0);\r\nif (!rport)\r\nreturn NULL;\r\nbfa_sm_send_event(rport, RPSM_EVENT_ADDRESS_DISC);\r\nreturn rport;\r\n}\r\nvoid\r\nbfa_fcs_rport_start(struct bfa_fcs_lport_s *port, struct fchs_s *fchs,\r\nstruct fc_logi_s *plogi)\r\n{\r\nstruct bfa_fcs_rport_s *rport;\r\nrport = bfa_fcs_rport_alloc(port, WWN_NULL, fchs->s_id);\r\nif (!rport)\r\nreturn;\r\nbfa_fcs_rport_update(rport, plogi);\r\nbfa_sm_send_event(rport, RPSM_EVENT_PLOGI_COMP);\r\n}\r\nvoid\r\nbfa_fcs_rport_plogi_create(struct bfa_fcs_lport_s *port, struct fchs_s *fchs,\r\nstruct fc_logi_s *plogi)\r\n{\r\nstruct bfa_fcs_rport_s *rport;\r\nrport = bfa_fcs_rport_alloc(port, plogi->port_name, fchs->s_id);\r\nif (!rport)\r\nreturn;\r\nbfa_fcs_rport_update(rport, plogi);\r\nrport->reply_oxid = fchs->ox_id;\r\nbfa_trc(rport->fcs, rport->reply_oxid);\r\nrport->stats.plogi_rcvd++;\r\nbfa_sm_send_event(rport, RPSM_EVENT_PLOGI_RCVD);\r\n}\r\nvoid\r\nbfa_fcs_rport_plogi(struct bfa_fcs_rport_s *rport, struct fchs_s *rx_fchs,\r\nstruct fc_logi_s *plogi)\r\n{\r\nbfa_fcs_rport_update(rport, plogi);\r\nrport->reply_oxid = rx_fchs->ox_id;\r\nbfa_trc(rport->fcs, rport->reply_oxid);\r\nrport->pid = rx_fchs->s_id;\r\nbfa_trc(rport->fcs, rport->pid);\r\nrport->stats.plogi_rcvd++;\r\nbfa_sm_send_event(rport, RPSM_EVENT_PLOGI_RCVD);\r\n}\r\nvoid\r\nbfa_fcs_rport_scn(struct bfa_fcs_rport_s *rport)\r\n{\r\nrport->stats.rscns++;\r\nbfa_sm_send_event(rport, RPSM_EVENT_FAB_SCN);\r\n}\r\nvoid\r\nbfa_cb_rport_online(void *cbarg)\r\n{\r\nstruct bfa_fcs_rport_s *rport = (struct bfa_fcs_rport_s *) cbarg;\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_sm_send_event(rport, RPSM_EVENT_HCB_ONLINE);\r\n}\r\nvoid\r\nbfa_cb_rport_offline(void *cbarg)\r\n{\r\nstruct bfa_fcs_rport_s *rport = (struct bfa_fcs_rport_s *) cbarg;\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_sm_send_event(rport, RPSM_EVENT_HCB_OFFLINE);\r\n}\r\nvoid\r\nbfa_cb_rport_qos_scn_flowid(void *cbarg,\r\nstruct bfa_rport_qos_attr_s old_qos_attr,\r\nstruct bfa_rport_qos_attr_s new_qos_attr)\r\n{\r\nstruct bfa_fcs_rport_s *rport = (struct bfa_fcs_rport_s *) cbarg;\r\nstruct bfa_rport_aen_data_s aen_data;\r\nbfa_trc(rport->fcs, rport->pwwn);\r\naen_data.priv.qos = new_qos_attr;\r\nbfa_fcs_rport_aen_post(rport, BFA_RPORT_AEN_QOS_FLOWID, &aen_data);\r\n}\r\nvoid\r\nbfa_cb_rport_scn_online(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcs_s *fcs = &((struct bfad_s *)bfa->bfad)->bfa_fcs;\r\nstruct bfa_fcs_lport_s *port = bfa_fcs_get_base_port(fcs);\r\nstruct bfa_fcs_rport_s *rp;\r\nstruct list_head *qe;\r\nlist_for_each(qe, &port->rport_q) {\r\nrp = (struct bfa_fcs_rport_s *) qe;\r\nbfa_sm_send_event(rp, RPSM_EVENT_SCN_ONLINE);\r\nrp->scn_online = BFA_TRUE;\r\n}\r\nif (bfa_fcs_lport_is_online(port))\r\nbfa_fcs_lport_lip_scn_online(port);\r\n}\r\nvoid\r\nbfa_cb_rport_scn_no_dev(void *rport)\r\n{\r\nstruct bfa_fcs_rport_s *rp = rport;\r\nbfa_sm_send_event(rp, RPSM_EVENT_SCN_OFFLINE);\r\nrp->scn_online = BFA_FALSE;\r\n}\r\nvoid\r\nbfa_cb_rport_scn_offline(struct bfa_s *bfa)\r\n{\r\nstruct bfa_fcs_s *fcs = &((struct bfad_s *)bfa->bfad)->bfa_fcs;\r\nstruct bfa_fcs_lport_s *port = bfa_fcs_get_base_port(fcs);\r\nstruct bfa_fcs_rport_s *rp;\r\nstruct list_head *qe;\r\nlist_for_each(qe, &port->rport_q) {\r\nrp = (struct bfa_fcs_rport_s *) qe;\r\nbfa_sm_send_event(rp, RPSM_EVENT_SCN_OFFLINE);\r\nrp->scn_online = BFA_FALSE;\r\n}\r\n}\r\nvoid\r\nbfa_cb_rport_qos_scn_prio(void *cbarg,\r\nstruct bfa_rport_qos_attr_s old_qos_attr,\r\nstruct bfa_rport_qos_attr_s new_qos_attr)\r\n{\r\nstruct bfa_fcs_rport_s *rport = (struct bfa_fcs_rport_s *) cbarg;\r\nstruct bfa_rport_aen_data_s aen_data;\r\nbfa_trc(rport->fcs, rport->pwwn);\r\naen_data.priv.qos = new_qos_attr;\r\nbfa_fcs_rport_aen_post(rport, BFA_RPORT_AEN_QOS_PRIO, &aen_data);\r\n}\r\nvoid\r\nbfa_fcs_rport_uf_recv(struct bfa_fcs_rport_s *rport,\r\nstruct fchs_s *fchs, u16 len)\r\n{\r\nstruct bfa_fcs_lport_s *port = rport->port;\r\nstruct fc_els_cmd_s *els_cmd;\r\nbfa_trc(rport->fcs, fchs->s_id);\r\nbfa_trc(rport->fcs, fchs->d_id);\r\nbfa_trc(rport->fcs, fchs->type);\r\nif (fchs->type != FC_TYPE_ELS)\r\nreturn;\r\nels_cmd = (struct fc_els_cmd_s *) (fchs + 1);\r\nbfa_trc(rport->fcs, els_cmd->els_code);\r\nswitch (els_cmd->els_code) {\r\ncase FC_ELS_LOGO:\r\nbfa_stats(port, plogi_rcvd);\r\nbfa_fcs_rport_process_logo(rport, fchs);\r\nbreak;\r\ncase FC_ELS_ADISC:\r\nbfa_stats(port, adisc_rcvd);\r\nbfa_fcs_rport_process_adisc(rport, fchs, len);\r\nbreak;\r\ncase FC_ELS_PRLO:\r\nbfa_stats(port, prlo_rcvd);\r\nif (bfa_fcs_lport_is_initiator(port))\r\nbfa_fcs_fcpim_uf_recv(rport->itnim, fchs, len);\r\nbreak;\r\ncase FC_ELS_PRLI:\r\nbfa_stats(port, prli_rcvd);\r\nbfa_fcs_rport_process_prli(rport, fchs, len);\r\nbreak;\r\ncase FC_ELS_RPSC:\r\nbfa_stats(port, rpsc_rcvd);\r\nbfa_fcs_rport_process_rpsc(rport, fchs, len);\r\nbreak;\r\ndefault:\r\nbfa_stats(port, un_handled_els_rcvd);\r\nbfa_fcs_rport_send_ls_rjt(rport, fchs,\r\nFC_LS_RJT_RSN_CMD_NOT_SUPP,\r\nFC_LS_RJT_EXP_NO_ADDL_INFO);\r\nbreak;\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rport_send_prlo_acc(struct bfa_fcs_rport_s *rport)\r\n{\r\nstruct bfa_fcs_lport_s *port = rport->port;\r\nstruct fchs_s fchs;\r\nstruct bfa_fcxp_s *fcxp;\r\nint len;\r\nbfa_trc(rport->fcs, rport->pid);\r\nfcxp = bfa_fcs_fcxp_alloc(port->fcs, BFA_FALSE);\r\nif (!fcxp)\r\nreturn;\r\nlen = fc_prlo_acc_build(&fchs, bfa_fcxp_get_reqbuf(fcxp),\r\nrport->pid, bfa_fcs_lport_get_fcid(port),\r\nrport->reply_oxid, 0);\r\nbfa_fcxp_send(fcxp, rport->bfa_rport, port->fabric->vf_id,\r\nport->lp_tag, BFA_FALSE, FC_CLASS_3, len, &fchs,\r\nNULL, NULL, FC_MAX_PDUSZ, 0);\r\n}\r\nstatic void\r\nbfa_fcs_rport_send_ls_rjt(struct bfa_fcs_rport_s *rport, struct fchs_s *rx_fchs,\r\nu8 reason_code, u8 reason_code_expl)\r\n{\r\nstruct bfa_fcs_lport_s *port = rport->port;\r\nstruct fchs_s fchs;\r\nstruct bfa_fcxp_s *fcxp;\r\nint len;\r\nbfa_trc(rport->fcs, rx_fchs->s_id);\r\nfcxp = bfa_fcs_fcxp_alloc(rport->fcs, BFA_FALSE);\r\nif (!fcxp)\r\nreturn;\r\nlen = fc_ls_rjt_build(&fchs, bfa_fcxp_get_reqbuf(fcxp),\r\nrx_fchs->s_id, bfa_fcs_lport_get_fcid(port),\r\nrx_fchs->ox_id, reason_code, reason_code_expl);\r\nbfa_fcxp_send(fcxp, NULL, port->fabric->vf_id, port->lp_tag,\r\nBFA_FALSE, FC_CLASS_3, len, &fchs, NULL, NULL,\r\nFC_MAX_PDUSZ, 0);\r\n}\r\nint\r\nbfa_fcs_rport_get_state(struct bfa_fcs_rport_s *rport)\r\n{\r\nreturn bfa_sm_to_state(rport_sm_table, rport->sm);\r\n}\r\nvoid\r\nbfa_fcs_rport_set_del_timeout(u8 rport_tmo)\r\n{\r\nif (rport_tmo > 0)\r\nbfa_fcs_rport_del_timeout = rport_tmo * 1000;\r\n}\r\nvoid\r\nbfa_fcs_rport_prlo(struct bfa_fcs_rport_s *rport, __be16 ox_id)\r\n{\r\nbfa_trc(rport->fcs, rport->pid);\r\nrport->prlo = BFA_TRUE;\r\nrport->reply_oxid = ox_id;\r\nbfa_sm_send_event(rport, RPSM_EVENT_PRLO_RCVD);\r\n}\r\nvoid\r\nbfa_fcs_rport_set_max_logins(u32 max_logins)\r\n{\r\nif (max_logins > 0)\r\nbfa_fcs_rport_max_logins = max_logins;\r\n}\r\nvoid\r\nbfa_fcs_rport_get_attr(struct bfa_fcs_rport_s *rport,\r\nstruct bfa_rport_attr_s *rport_attr)\r\n{\r\nstruct bfa_rport_qos_attr_s qos_attr;\r\nstruct bfa_fcs_lport_s *port = rport->port;\r\nbfa_port_speed_t rport_speed = rport->rpf.rpsc_speed;\r\nstruct bfa_port_attr_s port_attr;\r\nbfa_fcport_get_attr(rport->fcs->bfa, &port_attr);\r\nmemset(rport_attr, 0, sizeof(struct bfa_rport_attr_s));\r\nmemset(&qos_attr, 0, sizeof(struct bfa_rport_qos_attr_s));\r\nrport_attr->pid = rport->pid;\r\nrport_attr->pwwn = rport->pwwn;\r\nrport_attr->nwwn = rport->nwwn;\r\nrport_attr->cos_supported = rport->fc_cos;\r\nrport_attr->df_sz = rport->maxfrsize;\r\nrport_attr->state = bfa_fcs_rport_get_state(rport);\r\nrport_attr->fc_cos = rport->fc_cos;\r\nrport_attr->cisc = rport->cisc;\r\nrport_attr->scsi_function = rport->scsi_function;\r\nrport_attr->curr_speed = rport->rpf.rpsc_speed;\r\nrport_attr->assigned_speed = rport->rpf.assigned_speed;\r\nif (rport->bfa_rport) {\r\nqos_attr.qos_priority = rport->bfa_rport->qos_attr.qos_priority;\r\nqos_attr.qos_flow_id =\r\ncpu_to_be32(rport->bfa_rport->qos_attr.qos_flow_id);\r\n}\r\nrport_attr->qos_attr = qos_attr;\r\nrport_attr->trl_enforced = BFA_FALSE;\r\nif (bfa_fcport_is_ratelim(port->fcs->bfa) &&\r\n(rport->scsi_function == BFA_RPORT_TARGET)) {\r\nif (rport_speed == BFA_PORT_SPEED_UNKNOWN)\r\nrport_speed =\r\nbfa_fcport_get_ratelim_speed(rport->fcs->bfa);\r\nif ((bfa_fcs_lport_get_rport_max_speed(port) !=\r\nBFA_PORT_SPEED_UNKNOWN) && (rport_speed < port_attr.speed))\r\nrport_attr->trl_enforced = BFA_TRUE;\r\n}\r\n}\r\nstruct bfa_fcs_rport_s *\r\nbfa_fcs_rport_lookup(struct bfa_fcs_lport_s *port, wwn_t rpwwn)\r\n{\r\nstruct bfa_fcs_rport_s *rport;\r\nrport = bfa_fcs_lport_get_rport_by_pwwn(port, rpwwn);\r\nif (rport == NULL) {\r\n}\r\nreturn rport;\r\n}\r\nstruct bfa_fcs_rport_s *\r\nbfa_fcs_rport_lookup_by_nwwn(struct bfa_fcs_lport_s *port, wwn_t rnwwn)\r\n{\r\nstruct bfa_fcs_rport_s *rport;\r\nrport = bfa_fcs_lport_get_rport_by_nwwn(port, rnwwn);\r\nif (rport == NULL) {\r\n}\r\nreturn rport;\r\n}\r\nstatic void\r\nbfa_fcs_rpf_sm_uninit(struct bfa_fcs_rpf_s *rpf, enum rpf_event event)\r\n{\r\nstruct bfa_fcs_rport_s *rport = rpf->rport;\r\nstruct bfa_fcs_fabric_s *fabric = &rport->fcs->fabric;\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPFSM_EVENT_RPORT_ONLINE:\r\nif ((!BFA_FCS_PID_IS_WKA(rport->pid)) &&\r\n((rport->port->fabric->lps->brcd_switch) ||\r\n(bfa_fcs_fabric_get_switch_oui(fabric) ==\r\nBFA_FCS_BRCD_SWITCH_OUI))) {\r\nbfa_sm_set_state(rpf, bfa_fcs_rpf_sm_rpsc_sending);\r\nrpf->rpsc_retries = 0;\r\nbfa_fcs_rpf_send_rpsc2(rpf, NULL);\r\n}\r\nbreak;\r\ncase RPFSM_EVENT_RPORT_OFFLINE:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rpf_sm_rpsc_sending(struct bfa_fcs_rpf_s *rpf, enum rpf_event event)\r\n{\r\nstruct bfa_fcs_rport_s *rport = rpf->rport;\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPFSM_EVENT_FCXP_SENT:\r\nbfa_sm_set_state(rpf, bfa_fcs_rpf_sm_rpsc);\r\nbreak;\r\ncase RPFSM_EVENT_RPORT_OFFLINE:\r\nbfa_sm_set_state(rpf, bfa_fcs_rpf_sm_offline);\r\nbfa_fcxp_walloc_cancel(rport->fcs->bfa, &rpf->fcxp_wqe);\r\nrpf->rpsc_retries = 0;\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rpf_sm_rpsc(struct bfa_fcs_rpf_s *rpf, enum rpf_event event)\r\n{\r\nstruct bfa_fcs_rport_s *rport = rpf->rport;\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPFSM_EVENT_RPSC_COMP:\r\nbfa_sm_set_state(rpf, bfa_fcs_rpf_sm_online);\r\nif (rpf->rpsc_speed != BFA_PORT_SPEED_UNKNOWN)\r\nbfa_rport_speed(rport->bfa_rport, rpf->rpsc_speed);\r\nelse if (rpf->assigned_speed != BFA_PORT_SPEED_UNKNOWN)\r\nbfa_rport_speed(rport->bfa_rport, rpf->assigned_speed);\r\nbreak;\r\ncase RPFSM_EVENT_RPSC_FAIL:\r\nbfa_sm_set_state(rpf, bfa_fcs_rpf_sm_online);\r\nbreak;\r\ncase RPFSM_EVENT_RPSC_ERROR:\r\nif (rpf->rpsc_retries++ < BFA_FCS_RPF_RETRIES) {\r\nbfa_timer_start(rport->fcs->bfa, &rpf->timer,\r\nbfa_fcs_rpf_timeout, rpf,\r\nBFA_FCS_RPF_RETRY_TIMEOUT);\r\nbfa_sm_set_state(rpf, bfa_fcs_rpf_sm_rpsc_retry);\r\n} else {\r\nbfa_sm_set_state(rpf, bfa_fcs_rpf_sm_online);\r\n}\r\nbreak;\r\ncase RPFSM_EVENT_RPORT_OFFLINE:\r\nbfa_sm_set_state(rpf, bfa_fcs_rpf_sm_offline);\r\nbfa_fcxp_discard(rpf->fcxp);\r\nrpf->rpsc_retries = 0;\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rpf_sm_rpsc_retry(struct bfa_fcs_rpf_s *rpf, enum rpf_event event)\r\n{\r\nstruct bfa_fcs_rport_s *rport = rpf->rport;\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPFSM_EVENT_TIMEOUT:\r\nbfa_sm_set_state(rpf, bfa_fcs_rpf_sm_rpsc_sending);\r\nbfa_fcs_rpf_send_rpsc2(rpf, NULL);\r\nbreak;\r\ncase RPFSM_EVENT_RPORT_OFFLINE:\r\nbfa_timer_stop(&rpf->timer);\r\nbfa_sm_set_state(rpf, bfa_fcs_rpf_sm_offline);\r\nrpf->rpsc_retries = 0;\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rpf_sm_online(struct bfa_fcs_rpf_s *rpf, enum rpf_event event)\r\n{\r\nstruct bfa_fcs_rport_s *rport = rpf->rport;\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPFSM_EVENT_RPORT_OFFLINE:\r\nbfa_sm_set_state(rpf, bfa_fcs_rpf_sm_offline);\r\nrpf->rpsc_retries = 0;\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nstatic void\r\nbfa_fcs_rpf_sm_offline(struct bfa_fcs_rpf_s *rpf, enum rpf_event event)\r\n{\r\nstruct bfa_fcs_rport_s *rport = rpf->rport;\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_trc(rport->fcs, event);\r\nswitch (event) {\r\ncase RPFSM_EVENT_RPORT_ONLINE:\r\nbfa_sm_set_state(rpf, bfa_fcs_rpf_sm_rpsc_sending);\r\nbfa_fcs_rpf_send_rpsc2(rpf, NULL);\r\nbreak;\r\ncase RPFSM_EVENT_RPORT_OFFLINE:\r\nbreak;\r\ndefault:\r\nbfa_sm_fault(rport->fcs, event);\r\n}\r\n}\r\nvoid\r\nbfa_fcs_rpf_init(struct bfa_fcs_rport_s *rport)\r\n{\r\nstruct bfa_fcs_rpf_s *rpf = &rport->rpf;\r\nbfa_trc(rport->fcs, rport->pid);\r\nrpf->rport = rport;\r\nbfa_sm_set_state(rpf, bfa_fcs_rpf_sm_uninit);\r\n}\r\nvoid\r\nbfa_fcs_rpf_rport_online(struct bfa_fcs_rport_s *rport)\r\n{\r\nbfa_trc(rport->fcs, rport->pid);\r\nif (__fcs_min_cfg(rport->port->fcs))\r\nreturn;\r\nif (bfa_fcs_fabric_is_switched(rport->port->fabric))\r\nbfa_sm_send_event(&rport->rpf, RPFSM_EVENT_RPORT_ONLINE);\r\n}\r\nvoid\r\nbfa_fcs_rpf_rport_offline(struct bfa_fcs_rport_s *rport)\r\n{\r\nbfa_trc(rport->fcs, rport->pid);\r\nif (__fcs_min_cfg(rport->port->fcs))\r\nreturn;\r\nrport->rpf.rpsc_speed = 0;\r\nbfa_sm_send_event(&rport->rpf, RPFSM_EVENT_RPORT_OFFLINE);\r\n}\r\nstatic void\r\nbfa_fcs_rpf_timeout(void *arg)\r\n{\r\nstruct bfa_fcs_rpf_s *rpf = (struct bfa_fcs_rpf_s *) arg;\r\nstruct bfa_fcs_rport_s *rport = rpf->rport;\r\nbfa_trc(rport->fcs, rport->pid);\r\nbfa_sm_send_event(rpf, RPFSM_EVENT_TIMEOUT);\r\n}\r\nstatic void\r\nbfa_fcs_rpf_send_rpsc2(void *rpf_cbarg, struct bfa_fcxp_s *fcxp_alloced)\r\n{\r\nstruct bfa_fcs_rpf_s *rpf = (struct bfa_fcs_rpf_s *)rpf_cbarg;\r\nstruct bfa_fcs_rport_s *rport = rpf->rport;\r\nstruct bfa_fcs_lport_s *port = rport->port;\r\nstruct fchs_s fchs;\r\nint len;\r\nstruct bfa_fcxp_s *fcxp;\r\nbfa_trc(rport->fcs, rport->pwwn);\r\nfcxp = fcxp_alloced ? fcxp_alloced :\r\nbfa_fcs_fcxp_alloc(port->fcs, BFA_TRUE);\r\nif (!fcxp) {\r\nbfa_fcs_fcxp_alloc_wait(port->fcs->bfa, &rpf->fcxp_wqe,\r\nbfa_fcs_rpf_send_rpsc2, rpf, BFA_TRUE);\r\nreturn;\r\n}\r\nrpf->fcxp = fcxp;\r\nlen = fc_rpsc2_build(&fchs, bfa_fcxp_get_reqbuf(fcxp), rport->pid,\r\nbfa_fcs_lport_get_fcid(port), &rport->pid, 1);\r\nbfa_fcxp_send(fcxp, NULL, port->fabric->vf_id, port->lp_tag, BFA_FALSE,\r\nFC_CLASS_3, len, &fchs, bfa_fcs_rpf_rpsc2_response,\r\nrpf, FC_MAX_PDUSZ, FC_ELS_TOV);\r\nrport->stats.rpsc_sent++;\r\nbfa_sm_send_event(rpf, RPFSM_EVENT_FCXP_SENT);\r\n}\r\nstatic void\r\nbfa_fcs_rpf_rpsc2_response(void *fcsarg, struct bfa_fcxp_s *fcxp, void *cbarg,\r\nbfa_status_t req_status, u32 rsp_len,\r\nu32 resid_len, struct fchs_s *rsp_fchs)\r\n{\r\nstruct bfa_fcs_rpf_s *rpf = (struct bfa_fcs_rpf_s *) cbarg;\r\nstruct bfa_fcs_rport_s *rport = rpf->rport;\r\nstruct fc_ls_rjt_s *ls_rjt;\r\nstruct fc_rpsc2_acc_s *rpsc2_acc;\r\nu16 num_ents;\r\nbfa_trc(rport->fcs, req_status);\r\nif (req_status != BFA_STATUS_OK) {\r\nbfa_trc(rport->fcs, req_status);\r\nif (req_status == BFA_STATUS_ETIMER)\r\nrport->stats.rpsc_failed++;\r\nbfa_sm_send_event(rpf, RPFSM_EVENT_RPSC_ERROR);\r\nreturn;\r\n}\r\nrpsc2_acc = (struct fc_rpsc2_acc_s *) BFA_FCXP_RSP_PLD(fcxp);\r\nif (rpsc2_acc->els_cmd == FC_ELS_ACC) {\r\nrport->stats.rpsc_accs++;\r\nnum_ents = be16_to_cpu(rpsc2_acc->num_pids);\r\nbfa_trc(rport->fcs, num_ents);\r\nif (num_ents > 0) {\r\nWARN_ON(be32_to_cpu(rpsc2_acc->port_info[0].pid) !=\r\nbfa_ntoh3b(rport->pid));\r\nbfa_trc(rport->fcs,\r\nbe32_to_cpu(rpsc2_acc->port_info[0].pid));\r\nbfa_trc(rport->fcs,\r\nbe16_to_cpu(rpsc2_acc->port_info[0].speed));\r\nbfa_trc(rport->fcs,\r\nbe16_to_cpu(rpsc2_acc->port_info[0].index));\r\nbfa_trc(rport->fcs,\r\nrpsc2_acc->port_info[0].type);\r\nif (rpsc2_acc->port_info[0].speed == 0) {\r\nbfa_sm_send_event(rpf, RPFSM_EVENT_RPSC_ERROR);\r\nreturn;\r\n}\r\nrpf->rpsc_speed = fc_rpsc_operspeed_to_bfa_speed(\r\nbe16_to_cpu(rpsc2_acc->port_info[0].speed));\r\nbfa_sm_send_event(rpf, RPFSM_EVENT_RPSC_COMP);\r\n}\r\n} else {\r\nls_rjt = (struct fc_ls_rjt_s *) BFA_FCXP_RSP_PLD(fcxp);\r\nbfa_trc(rport->fcs, ls_rjt->reason_code);\r\nbfa_trc(rport->fcs, ls_rjt->reason_code_expl);\r\nrport->stats.rpsc_rejects++;\r\nif (ls_rjt->reason_code == FC_LS_RJT_RSN_CMD_NOT_SUPP)\r\nbfa_sm_send_event(rpf, RPFSM_EVENT_RPSC_FAIL);\r\nelse\r\nbfa_sm_send_event(rpf, RPFSM_EVENT_RPSC_ERROR);\r\n}\r\n}

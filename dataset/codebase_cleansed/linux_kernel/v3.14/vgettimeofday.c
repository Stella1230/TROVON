static inline cycles_t get_cycles_inline(void)\r\n{\r\nunsigned int high = __insn_mfspr(SPR_CYCLE_HIGH);\r\nunsigned int low = __insn_mfspr(SPR_CYCLE_LOW);\r\nunsigned int high2 = __insn_mfspr(SPR_CYCLE_HIGH);\r\nwhile (unlikely(high != high2)) {\r\nlow = __insn_mfspr(SPR_CYCLE_LOW);\r\nhigh = high2;\r\nhigh2 = __insn_mfspr(SPR_CYCLE_HIGH);\r\n}\r\nreturn (((cycles_t)high) << 32) | low;\r\n}\r\ninline unsigned long get_datapage(void)\r\n{\r\nunsigned long ret;\r\nasm volatile ("lnk %0" : "=r"(ret));\r\nret &= ~(PAGE_SIZE - 1);\r\nret += PAGE_SIZE;\r\nreturn ret;\r\n}\r\nint __vdso_gettimeofday(struct timeval *tv, struct timezone *tz)\r\n{\r\ncycles_t cycles;\r\nunsigned long count, sec, ns;\r\nvolatile struct vdso_data *vdso_data;\r\nvdso_data = (struct vdso_data *)get_datapage();\r\nif (unlikely(tz != NULL)) {\r\nwhile (1) {\r\ncount = vdso_data->tz_update_count;\r\nif (count & 1)\r\ncontinue;\r\ntz->tz_minuteswest = vdso_data->tz_minuteswest;\r\ntz->tz_dsttime = vdso_data->tz_dsttime;\r\nif (count == vdso_data->tz_update_count)\r\nbreak;\r\n}\r\n}\r\nif (unlikely(tv == NULL))\r\nreturn 0;\r\nwhile (1) {\r\ncount = vdso_data->tb_update_count;\r\nif (count & 1)\r\ncontinue;\r\ncycles = (get_cycles() - vdso_data->xtime_tod_stamp);\r\nns = (cycles * vdso_data->mult) >> vdso_data->shift;\r\nsec = vdso_data->xtime_clock_sec;\r\nns += vdso_data->xtime_clock_nsec;\r\nif (ns >= NSEC_PER_SEC) {\r\nns -= NSEC_PER_SEC;\r\nsec += 1;\r\n}\r\nif (count == vdso_data->tb_update_count)\r\nbreak;\r\n}\r\ntv->tv_sec = sec;\r\ntv->tv_usec = ns / 1000;\r\nreturn 0;\r\n}

static void atmel_pwm_bl_set_gpio_on(struct atmel_pwm_bl *pwmbl, int on)\r\n{\r\nif (!gpio_is_valid(pwmbl->gpio_on))\r\nreturn;\r\ngpio_set_value(pwmbl->gpio_on, on ^ pwmbl->pdata->on_active_low);\r\n}\r\nstatic int atmel_pwm_bl_set_intensity(struct backlight_device *bd)\r\n{\r\nstruct atmel_pwm_bl *pwmbl = bl_get_data(bd);\r\nint intensity = bd->props.brightness;\r\nint pwm_duty;\r\nif (bd->props.power != FB_BLANK_UNBLANK)\r\nintensity = 0;\r\nif (bd->props.fb_blank != FB_BLANK_UNBLANK)\r\nintensity = 0;\r\nif (pwmbl->pdata->pwm_active_low)\r\npwm_duty = pwmbl->pdata->pwm_duty_min + intensity;\r\nelse\r\npwm_duty = pwmbl->pdata->pwm_duty_max - intensity;\r\nif (pwm_duty > pwmbl->pdata->pwm_duty_max)\r\npwm_duty = pwmbl->pdata->pwm_duty_max;\r\nif (pwm_duty < pwmbl->pdata->pwm_duty_min)\r\npwm_duty = pwmbl->pdata->pwm_duty_min;\r\nif (!intensity) {\r\natmel_pwm_bl_set_gpio_on(pwmbl, 0);\r\npwm_channel_writel(&pwmbl->pwmc, PWM_CUPD, pwm_duty);\r\npwm_channel_disable(&pwmbl->pwmc);\r\n} else {\r\npwm_channel_enable(&pwmbl->pwmc);\r\npwm_channel_writel(&pwmbl->pwmc, PWM_CUPD, pwm_duty);\r\natmel_pwm_bl_set_gpio_on(pwmbl, 1);\r\n}\r\nreturn 0;\r\n}\r\nstatic int atmel_pwm_bl_get_intensity(struct backlight_device *bd)\r\n{\r\nstruct atmel_pwm_bl *pwmbl = bl_get_data(bd);\r\nu32 cdty;\r\nu32 intensity;\r\ncdty = pwm_channel_readl(&pwmbl->pwmc, PWM_CDTY);\r\nif (pwmbl->pdata->pwm_active_low)\r\nintensity = cdty - pwmbl->pdata->pwm_duty_min;\r\nelse\r\nintensity = pwmbl->pdata->pwm_duty_max - cdty;\r\nreturn intensity & 0xffff;\r\n}\r\nstatic int atmel_pwm_bl_init_pwm(struct atmel_pwm_bl *pwmbl)\r\n{\r\nunsigned long pwm_rate = pwmbl->pwmc.mck;\r\nunsigned long prescale = DIV_ROUND_UP(pwm_rate,\r\n(pwmbl->pdata->pwm_frequency *\r\npwmbl->pdata->pwm_compare_max)) - 1;\r\nprescale = fls(prescale);\r\nif (prescale > 0xf)\r\nprescale = 0xf;\r\npwm_channel_writel(&pwmbl->pwmc, PWM_CMR, prescale);\r\npwm_channel_writel(&pwmbl->pwmc, PWM_CDTY,\r\npwmbl->pdata->pwm_duty_min +\r\npwmbl->bldev->props.brightness);\r\npwm_channel_writel(&pwmbl->pwmc, PWM_CPRD,\r\npwmbl->pdata->pwm_compare_max);\r\ndev_info(&pwmbl->pdev->dev, "Atmel PWM backlight driver (%lu Hz)\n",\r\npwmbl->pwmc.mck / pwmbl->pdata->pwm_compare_max /\r\n(1 << prescale));\r\nreturn pwm_channel_enable(&pwmbl->pwmc);\r\n}\r\nstatic int atmel_pwm_bl_probe(struct platform_device *pdev)\r\n{\r\nstruct backlight_properties props;\r\nconst struct atmel_pwm_bl_platform_data *pdata;\r\nstruct backlight_device *bldev;\r\nstruct atmel_pwm_bl *pwmbl;\r\nunsigned long flags;\r\nint retval;\r\npdata = dev_get_platdata(&pdev->dev);\r\nif (!pdata)\r\nreturn -ENODEV;\r\nif (pdata->pwm_compare_max < pdata->pwm_duty_max ||\r\npdata->pwm_duty_min > pdata->pwm_duty_max ||\r\npdata->pwm_frequency == 0)\r\nreturn -EINVAL;\r\npwmbl = devm_kzalloc(&pdev->dev, sizeof(struct atmel_pwm_bl),\r\nGFP_KERNEL);\r\nif (!pwmbl)\r\nreturn -ENOMEM;\r\npwmbl->pdev = pdev;\r\npwmbl->pdata = pdata;\r\npwmbl->gpio_on = pdata->gpio_on;\r\nretval = pwm_channel_alloc(pdata->pwm_channel, &pwmbl->pwmc);\r\nif (retval)\r\nreturn retval;\r\nif (gpio_is_valid(pwmbl->gpio_on)) {\r\nif (pdata->on_active_low)\r\nflags = GPIOF_OUT_INIT_HIGH;\r\nelse\r\nflags = GPIOF_OUT_INIT_LOW;\r\nretval = devm_gpio_request_one(&pdev->dev, pwmbl->gpio_on,\r\nflags, "gpio_atmel_pwm_bl");\r\nif (retval)\r\ngoto err_free_pwm;\r\n}\r\nmemset(&props, 0, sizeof(struct backlight_properties));\r\nprops.type = BACKLIGHT_RAW;\r\nprops.max_brightness = pdata->pwm_duty_max - pdata->pwm_duty_min;\r\nbldev = devm_backlight_device_register(&pdev->dev, "atmel-pwm-bl",\r\n&pdev->dev, pwmbl, &atmel_pwm_bl_ops,\r\n&props);\r\nif (IS_ERR(bldev)) {\r\nretval = PTR_ERR(bldev);\r\ngoto err_free_pwm;\r\n}\r\npwmbl->bldev = bldev;\r\nplatform_set_drvdata(pdev, pwmbl);\r\nbldev->props.power = FB_BLANK_UNBLANK;\r\nbldev->props.brightness = bldev->props.max_brightness / 2;\r\nretval = atmel_pwm_bl_init_pwm(pwmbl);\r\nif (retval)\r\ngoto err_free_pwm;\r\natmel_pwm_bl_set_intensity(bldev);\r\nreturn 0;\r\nerr_free_pwm:\r\npwm_channel_free(&pwmbl->pwmc);\r\nreturn retval;\r\n}\r\nstatic int atmel_pwm_bl_remove(struct platform_device *pdev)\r\n{\r\nstruct atmel_pwm_bl *pwmbl = platform_get_drvdata(pdev);\r\natmel_pwm_bl_set_gpio_on(pwmbl, 0);\r\npwm_channel_disable(&pwmbl->pwmc);\r\npwm_channel_free(&pwmbl->pwmc);\r\nreturn 0;\r\n}

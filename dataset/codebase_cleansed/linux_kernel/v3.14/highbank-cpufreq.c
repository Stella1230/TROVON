static int hb_voltage_change(unsigned int freq)\r\n{\r\nu32 msg[HB_CPUFREQ_IPC_LEN] = {HB_CPUFREQ_CHANGE_NOTE, freq / 1000000};\r\nreturn pl320_ipc_transmit(msg);\r\n}\r\nstatic int hb_cpufreq_clk_notify(struct notifier_block *nb,\r\nunsigned long action, void *hclk)\r\n{\r\nstruct clk_notifier_data *clk_data = hclk;\r\nint i = 0;\r\nif (action == PRE_RATE_CHANGE) {\r\nif (clk_data->new_rate > clk_data->old_rate)\r\nwhile (hb_voltage_change(clk_data->new_rate))\r\nif (i++ > HB_CPUFREQ_VOLT_RETRIES)\r\nreturn NOTIFY_BAD;\r\n} else if (action == POST_RATE_CHANGE) {\r\nif (clk_data->new_rate < clk_data->old_rate)\r\nwhile (hb_voltage_change(clk_data->new_rate))\r\nif (i++ > HB_CPUFREQ_VOLT_RETRIES)\r\nreturn NOTIFY_BAD;\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int hb_cpufreq_driver_init(void)\r\n{\r\nstruct platform_device_info devinfo = { .name = "cpufreq-cpu0", };\r\nstruct device *cpu_dev;\r\nstruct clk *cpu_clk;\r\nstruct device_node *np;\r\nint ret;\r\nif ((!of_machine_is_compatible("calxeda,highbank")) &&\r\n(!of_machine_is_compatible("calxeda,ecx-2000")))\r\nreturn -ENODEV;\r\ncpu_dev = get_cpu_device(0);\r\nif (!cpu_dev) {\r\npr_err("failed to get highbank cpufreq device\n");\r\nreturn -ENODEV;\r\n}\r\nnp = of_node_get(cpu_dev->of_node);\r\nif (!np) {\r\npr_err("failed to find highbank cpufreq node\n");\r\nreturn -ENOENT;\r\n}\r\ncpu_clk = clk_get(cpu_dev, NULL);\r\nif (IS_ERR(cpu_clk)) {\r\nret = PTR_ERR(cpu_clk);\r\npr_err("failed to get cpu0 clock: %d\n", ret);\r\ngoto out_put_node;\r\n}\r\nret = clk_notifier_register(cpu_clk, &hb_cpufreq_clk_nb);\r\nif (ret) {\r\npr_err("failed to register clk notifier: %d\n", ret);\r\ngoto out_put_node;\r\n}\r\nplatform_device_register_full(&devinfo);\r\nout_put_node:\r\nof_node_put(np);\r\nreturn ret;\r\n}

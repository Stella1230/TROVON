unsigned long bfin_get_addr_from_rp(unsigned long *ptr,\r\nunsigned long relval,\r\nunsigned long flags,\r\nunsigned long *persistent)\r\n{\r\nunsigned short *usptr = (unsigned short *)ptr;\r\nint type = (relval >> 26) & 7;\r\nunsigned long val;\r\nswitch (type) {\r\ncase FLAT_BFIN_RELOC_TYPE_16_BIT:\r\ncase FLAT_BFIN_RELOC_TYPE_16H_BIT:\r\nusptr = (unsigned short *)ptr;\r\npr_debug("*usptr = %x", get_unaligned(usptr));\r\nval = get_unaligned(usptr);\r\nval += *persistent;\r\nbreak;\r\ncase FLAT_BFIN_RELOC_TYPE_32_BIT:\r\npr_debug("*ptr = %lx", get_unaligned(ptr));\r\nval = get_unaligned(ptr);\r\nbreak;\r\ndefault:\r\npr_debug("BINFMT_FLAT: Unknown relocation type %x\n", type);\r\nreturn 0;\r\n}\r\nif (relval & (1 << 29))\r\nreturn val + current->mm->context.end_brk;\r\nif ((flags & FLAT_FLAG_GOTPIC) == 0)\r\nval = htonl(val);\r\nreturn val;\r\n}\r\nvoid bfin_put_addr_at_rp(unsigned long *ptr, unsigned long addr,\r\nunsigned long relval)\r\n{\r\nunsigned short *usptr = (unsigned short *)ptr;\r\nint type = (relval >> 26) & 7;\r\nswitch (type) {\r\ncase FLAT_BFIN_RELOC_TYPE_16_BIT:\r\nput_unaligned(addr, usptr);\r\npr_debug("new value %x at %p", get_unaligned(usptr), usptr);\r\nbreak;\r\ncase FLAT_BFIN_RELOC_TYPE_16H_BIT:\r\nput_unaligned(addr >> 16, usptr);\r\npr_debug("new value %x", get_unaligned(usptr));\r\nbreak;\r\ncase FLAT_BFIN_RELOC_TYPE_32_BIT:\r\nput_unaligned(addr, ptr);\r\npr_debug("new ptr =%lx", get_unaligned(ptr));\r\nbreak;\r\n}\r\n}

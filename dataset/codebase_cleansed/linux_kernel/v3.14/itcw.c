struct tcw *itcw_get_tcw(struct itcw *itcw)\r\n{\r\nreturn itcw->tcw;\r\n}\r\nsize_t itcw_calc_size(int intrg, int max_tidaws, int intrg_max_tidaws)\r\n{\r\nsize_t len;\r\nint cross_count;\r\nlen = sizeof(struct itcw);\r\nlen += sizeof(struct tcw) + TCCB_MAX_SIZE +\r\nsizeof(struct tsb) +\r\nmax_tidaws * sizeof(struct tidaw);\r\nif (intrg) {\r\nlen += sizeof(struct tcw) + TCCB_MAX_SIZE +\r\nsizeof(struct tsb) +\r\nintrg_max_tidaws * sizeof(struct tidaw);\r\n}\r\nlen += 63 + 7;\r\nif (max_tidaws) {\r\ncross_count = 1 + ((max_tidaws * sizeof(struct tidaw) - 1)\r\n>> PAGE_SHIFT);\r\nlen += cross_count * sizeof(struct tidaw);\r\n}\r\nif (intrg_max_tidaws) {\r\ncross_count = 1 + ((intrg_max_tidaws * sizeof(struct tidaw) - 1)\r\n>> PAGE_SHIFT);\r\nlen += cross_count * sizeof(struct tidaw);\r\n}\r\nreturn len;\r\n}\r\nstatic inline void *fit_chunk(addr_t *start, addr_t end, size_t len,\r\nint align, int check_4k)\r\n{\r\naddr_t addr;\r\naddr = ALIGN(*start, align);\r\nif (check_4k && CROSS4K(addr, len)) {\r\naddr = ALIGN(addr, 4096);\r\naddr = ALIGN(addr, align);\r\n}\r\nif (addr + len > end)\r\nreturn ERR_PTR(-ENOSPC);\r\n*start = addr + len;\r\nreturn (void *) addr;\r\n}\r\nstruct itcw *itcw_init(void *buffer, size_t size, int op, int intrg,\r\nint max_tidaws, int intrg_max_tidaws)\r\n{\r\nstruct itcw *itcw;\r\nvoid *chunk;\r\naddr_t start;\r\naddr_t end;\r\nint cross_count;\r\nstart = (addr_t) buffer;\r\nend = start + size;\r\nif (end > (1 << 31))\r\nreturn ERR_PTR(-EINVAL);\r\nmemset(buffer, 0, size);\r\nchunk = fit_chunk(&start, end, sizeof(struct itcw), 1, 0);\r\nif (IS_ERR(chunk))\r\nreturn chunk;\r\nitcw = chunk;\r\ncross_count = 0;\r\nif (max_tidaws)\r\ncross_count = 1 + ((max_tidaws * sizeof(struct tidaw) - 1)\r\n>> PAGE_SHIFT);\r\nitcw->max_tidaws = max_tidaws + cross_count;\r\ncross_count = 0;\r\nif (intrg_max_tidaws)\r\ncross_count = 1 + ((intrg_max_tidaws * sizeof(struct tidaw) - 1)\r\n>> PAGE_SHIFT);\r\nitcw->intrg_max_tidaws = intrg_max_tidaws + cross_count;\r\nchunk = fit_chunk(&start, end, sizeof(struct tcw), 64, 0);\r\nif (IS_ERR(chunk))\r\nreturn chunk;\r\nitcw->tcw = chunk;\r\ntcw_init(itcw->tcw, (op == ITCW_OP_READ) ? 1 : 0,\r\n(op == ITCW_OP_WRITE) ? 1 : 0);\r\nif (intrg) {\r\nchunk = fit_chunk(&start, end, sizeof(struct tcw), 64, 0);\r\nif (IS_ERR(chunk))\r\nreturn chunk;\r\nitcw->intrg_tcw = chunk;\r\ntcw_init(itcw->intrg_tcw, 1, 0);\r\ntcw_set_intrg(itcw->tcw, itcw->intrg_tcw);\r\n}\r\nif (max_tidaws > 0) {\r\nchunk = fit_chunk(&start, end, sizeof(struct tidaw) *\r\nitcw->max_tidaws, 16, 0);\r\nif (IS_ERR(chunk))\r\nreturn chunk;\r\ntcw_set_data(itcw->tcw, chunk, 1);\r\n}\r\nif (intrg && (intrg_max_tidaws > 0)) {\r\nchunk = fit_chunk(&start, end, sizeof(struct tidaw) *\r\nitcw->intrg_max_tidaws, 16, 0);\r\nif (IS_ERR(chunk))\r\nreturn chunk;\r\ntcw_set_data(itcw->intrg_tcw, chunk, 1);\r\n}\r\nchunk = fit_chunk(&start, end, sizeof(struct tsb), 8, 0);\r\nif (IS_ERR(chunk))\r\nreturn chunk;\r\ntsb_init(chunk);\r\ntcw_set_tsb(itcw->tcw, chunk);\r\nif (intrg) {\r\nchunk = fit_chunk(&start, end, sizeof(struct tsb), 8, 0);\r\nif (IS_ERR(chunk))\r\nreturn chunk;\r\ntsb_init(chunk);\r\ntcw_set_tsb(itcw->intrg_tcw, chunk);\r\n}\r\nchunk = fit_chunk(&start, end, TCCB_MAX_SIZE, 8, 0);\r\nif (IS_ERR(chunk))\r\nreturn chunk;\r\ntccb_init(chunk, TCCB_MAX_SIZE, TCCB_SAC_DEFAULT);\r\ntcw_set_tccb(itcw->tcw, chunk);\r\nif (intrg) {\r\nchunk = fit_chunk(&start, end, TCCB_MAX_SIZE, 8, 0);\r\nif (IS_ERR(chunk))\r\nreturn chunk;\r\ntccb_init(chunk, TCCB_MAX_SIZE, TCCB_SAC_INTRG);\r\ntcw_set_tccb(itcw->intrg_tcw, chunk);\r\ntccb_add_dcw(chunk, TCCB_MAX_SIZE, DCW_CMD_INTRG, 0, NULL,\r\nsizeof(struct dcw_intrg_data), 0);\r\ntcw_finalize(itcw->intrg_tcw, 0);\r\n}\r\nreturn itcw;\r\n}\r\nstruct dcw *itcw_add_dcw(struct itcw *itcw, u8 cmd, u8 flags, void *cd,\r\nu8 cd_count, u32 count)\r\n{\r\nreturn tccb_add_dcw(tcw_get_tccb(itcw->tcw), TCCB_MAX_SIZE, cmd,\r\nflags, cd, cd_count, count);\r\n}\r\nstruct tidaw *itcw_add_tidaw(struct itcw *itcw, u8 flags, void *addr, u32 count)\r\n{\r\nstruct tidaw *following;\r\nif (itcw->num_tidaws >= itcw->max_tidaws)\r\nreturn ERR_PTR(-ENOSPC);\r\nfollowing = ((struct tidaw *) tcw_get_data(itcw->tcw))\r\n+ itcw->num_tidaws + 1;\r\nif (itcw->num_tidaws && !((unsigned long) following & ~PAGE_MASK)) {\r\ntcw_add_tidaw(itcw->tcw, itcw->num_tidaws++,\r\nTIDAW_FLAGS_TTIC, following, 0);\r\nif (itcw->num_tidaws >= itcw->max_tidaws)\r\nreturn ERR_PTR(-ENOSPC);\r\n}\r\nreturn tcw_add_tidaw(itcw->tcw, itcw->num_tidaws++, flags, addr, count);\r\n}\r\nvoid itcw_set_data(struct itcw *itcw, void *addr, int use_tidal)\r\n{\r\ntcw_set_data(itcw->tcw, addr, use_tidal);\r\n}\r\nvoid itcw_finalize(struct itcw *itcw)\r\n{\r\ntcw_finalize(itcw->tcw, itcw->num_tidaws);\r\n}

static int lov_llog_origin_add(const struct lu_env *env,\r\nstruct llog_ctxt *ctxt,\r\nstruct llog_rec_hdr *rec,\r\nstruct lov_stripe_md *lsm,\r\nstruct llog_cookie *logcookies, int numcookies)\r\n{\r\nstruct obd_device *obd = ctxt->loc_obd;\r\nstruct lov_obd *lov = &obd->u.lov;\r\nint i, rc = 0, cookies = 0;\r\nLASSERTF(logcookies && numcookies >= lsm->lsm_stripe_count,\r\n"logcookies %p, numcookies %d lsm->lsm_stripe_count %d \n",\r\nlogcookies, numcookies, lsm->lsm_stripe_count);\r\nfor (i = 0; i < lsm->lsm_stripe_count; i++) {\r\nstruct lov_oinfo *loi = lsm->lsm_oinfo[i];\r\nstruct obd_device *child =\r\nlov->lov_tgts[loi->loi_ost_idx]->ltd_exp->exp_obd;\r\nstruct llog_ctxt *cctxt = llog_get_context(child, ctxt->loc_idx);\r\nswitch (rec->lrh_type) {\r\ncase MDS_UNLINK_REC: {\r\nstruct llog_unlink_rec *lur = (struct llog_unlink_rec *)rec;\r\nlur->lur_oid = ostid_id(&loi->loi_oi);\r\nlur->lur_oseq = (__u32)ostid_seq(&loi->loi_oi);\r\nbreak;\r\n}\r\ncase MDS_SETATTR64_REC: {\r\nstruct llog_setattr64_rec *lsr = (struct llog_setattr64_rec *)rec;\r\nlsr->lsr_oi = loi->loi_oi;\r\nbreak;\r\n}\r\ndefault:\r\nbreak;\r\n}\r\nif (OBD_FAIL_CHECK(OBD_FAIL_MDS_FAIL_LOV_LOG_ADD)) {\r\nllog_ctxt_put(cctxt);\r\ncctxt = NULL;\r\n}\r\nrc = llog_obd_add(env, cctxt, rec, NULL, logcookies + cookies,\r\nnumcookies - cookies);\r\nllog_ctxt_put(cctxt);\r\nif (rc < 0) {\r\nCERROR("Can't add llog (rc = %d) for stripe %d\n",\r\nrc, cookies);\r\nmemset(logcookies + cookies, 0,\r\nsizeof(struct llog_cookie));\r\nrc = 1;\r\n}\r\ncookies += rc;\r\n}\r\nreturn cookies;\r\n}\r\nstatic int lov_llog_origin_connect(struct llog_ctxt *ctxt,\r\nstruct llog_logid *logid,\r\nstruct llog_gen *gen,\r\nstruct obd_uuid *uuid)\r\n{\r\nstruct obd_device *obd = ctxt->loc_obd;\r\nstruct lov_obd *lov = &obd->u.lov;\r\nint i, rc = 0, err = 0;\r\nobd_getref(obd);\r\nfor (i = 0; i < lov->desc.ld_tgt_count; i++) {\r\nstruct obd_device *child;\r\nstruct llog_ctxt *cctxt;\r\nif (!lov->lov_tgts[i] || !lov->lov_tgts[i]->ltd_active)\r\ncontinue;\r\nif (uuid && !obd_uuid_equals(uuid, &lov->lov_tgts[i]->ltd_uuid))\r\ncontinue;\r\nCDEBUG(D_CONFIG, "connect %d/%d\n", i, lov->desc.ld_tgt_count);\r\nchild = lov->lov_tgts[i]->ltd_exp->exp_obd;\r\ncctxt = llog_get_context(child, ctxt->loc_idx);\r\nrc = llog_connect(cctxt, logid, gen, uuid);\r\nllog_ctxt_put(cctxt);\r\nif (rc) {\r\nCERROR("error osc_llog_connect tgt %d (%d)\n", i, rc);\r\nif (!err)\r\nerr = rc;\r\n}\r\n}\r\nobd_putref(obd);\r\nreturn err;\r\n}\r\nstatic int lov_llog_repl_cancel(const struct lu_env *env,\r\nstruct llog_ctxt *ctxt,\r\nstruct lov_stripe_md *lsm,\r\nint count, struct llog_cookie *cookies,\r\nint flags)\r\n{\r\nstruct lov_obd *lov;\r\nstruct obd_device *obd = ctxt->loc_obd;\r\nint rc = 0, i;\r\nLASSERT(lsm != NULL);\r\nLASSERT(count == lsm->lsm_stripe_count);\r\nlov = &obd->u.lov;\r\nobd_getref(obd);\r\nfor (i = 0; i < count; i++, cookies++) {\r\nstruct lov_oinfo *loi = lsm->lsm_oinfo[i];\r\nstruct obd_device *child =\r\nlov->lov_tgts[loi->loi_ost_idx]->ltd_exp->exp_obd;\r\nstruct llog_ctxt *cctxt =\r\nllog_get_context(child, ctxt->loc_idx);\r\nint err;\r\nerr = llog_cancel(env, cctxt, NULL, 1, cookies, flags);\r\nllog_ctxt_put(cctxt);\r\nif (err && lov->lov_tgts[loi->loi_ost_idx]->ltd_active) {\r\nCERROR("%s: objid "DOSTID" subobj "DOSTID\r\n" on OST idx %d: rc = %d\n",\r\nobd->obd_name, POSTID(&lsm->lsm_oi),\r\nPOSTID(&loi->loi_oi), loi->loi_ost_idx, err);\r\nif (!rc)\r\nrc = err;\r\n}\r\n}\r\nobd_putref(obd);\r\nreturn rc;\r\n}\r\nint lov_llog_init(struct obd_device *obd, struct obd_llog_group *olg,\r\nstruct obd_device *disk_obd, int *index)\r\n{\r\nstruct lov_obd *lov = &obd->u.lov;\r\nstruct obd_device *child;\r\nint i, rc = 0;\r\nLASSERT(olg == &obd->obd_olg);\r\nrc = llog_setup(NULL, obd, olg, LLOG_MDS_OST_ORIG_CTXT, disk_obd,\r\n&lov_mds_ost_orig_logops);\r\nif (rc)\r\nreturn rc;\r\nrc = llog_setup(NULL, obd, olg, LLOG_SIZE_REPL_CTXT, disk_obd,\r\n&lov_size_repl_logops);\r\nif (rc)\r\nGOTO(err_cleanup, rc);\r\nobd_getref(obd);\r\nfor (i = 0; i < lov->desc.ld_tgt_count; i++) {\r\nif (!lov->lov_tgts[i])\r\ncontinue;\r\nif (index && i != *index)\r\ncontinue;\r\nchild = lov->lov_tgts[i]->ltd_obd;\r\nrc = obd_llog_init(child, &child->obd_olg, disk_obd, &i);\r\nif (rc)\r\nCERROR("error osc_llog_init idx %d osc '%s' tgt '%s' "\r\n"(rc=%d)\n", i, child->obd_name,\r\ndisk_obd->obd_name, rc);\r\nrc = 0;\r\n}\r\nobd_putref(obd);\r\nGOTO(err_cleanup, rc);\r\nerr_cleanup:\r\nif (rc) {\r\nstruct llog_ctxt *ctxt =\r\nllog_get_context(obd, LLOG_SIZE_REPL_CTXT);\r\nif (ctxt)\r\nllog_cleanup(NULL, ctxt);\r\nctxt = llog_get_context(obd, LLOG_MDS_OST_ORIG_CTXT);\r\nif (ctxt)\r\nllog_cleanup(NULL, ctxt);\r\n}\r\nreturn rc;\r\n}\r\nint lov_llog_finish(struct obd_device *obd, int count)\r\n{\r\nstruct llog_ctxt *ctxt;\r\nctxt = llog_get_context(obd, LLOG_MDS_OST_ORIG_CTXT);\r\nif (ctxt)\r\nllog_cleanup(NULL, ctxt);\r\nctxt = llog_get_context(obd, LLOG_SIZE_REPL_CTXT);\r\nif (ctxt)\r\nllog_cleanup(NULL, ctxt);\r\nreturn 0;\r\n}

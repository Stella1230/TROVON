static inline int __of_pci_pci_compare(struct device_node *node,\r\nunsigned int data)\r\n{\r\nint devfn;\r\ndevfn = of_pci_get_devfn(node);\r\nif (devfn < 0)\r\nreturn 0;\r\nreturn devfn == data;\r\n}\r\nstruct device_node *of_pci_find_child_device(struct device_node *parent,\r\nunsigned int devfn)\r\n{\r\nstruct device_node *node, *node2;\r\nfor_each_child_of_node(parent, node) {\r\nif (__of_pci_pci_compare(node, devfn))\r\nreturn node;\r\nif (!strcmp(node->name, "multifunc-device")) {\r\nfor_each_child_of_node(node, node2) {\r\nif (__of_pci_pci_compare(node2, devfn)) {\r\nof_node_put(node);\r\nreturn node2;\r\n}\r\n}\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nint of_pci_get_devfn(struct device_node *np)\r\n{\r\nunsigned int size;\r\nconst __be32 *reg;\r\nreg = of_get_property(np, "reg", &size);\r\nif (!reg || size < 5 * sizeof(__be32))\r\nreturn -EINVAL;\r\nreturn (be32_to_cpup(reg) >> 8) & 0xff;\r\n}\r\nint of_pci_parse_bus_range(struct device_node *node, struct resource *res)\r\n{\r\nconst __be32 *values;\r\nint len;\r\nvalues = of_get_property(node, "bus-range", &len);\r\nif (!values || len < sizeof(*values) * 2)\r\nreturn -EINVAL;\r\nres->name = node->name;\r\nres->start = be32_to_cpup(values++);\r\nres->end = be32_to_cpup(values);\r\nres->flags = IORESOURCE_BUS;\r\nreturn 0;\r\n}\r\nint of_pci_msi_chip_add(struct msi_chip *chip)\r\n{\r\nif (!of_property_read_bool(chip->of_node, "msi-controller"))\r\nreturn -EINVAL;\r\nmutex_lock(&of_pci_msi_chip_mutex);\r\nlist_add(&chip->list, &of_pci_msi_chip_list);\r\nmutex_unlock(&of_pci_msi_chip_mutex);\r\nreturn 0;\r\n}\r\nvoid of_pci_msi_chip_remove(struct msi_chip *chip)\r\n{\r\nmutex_lock(&of_pci_msi_chip_mutex);\r\nlist_del(&chip->list);\r\nmutex_unlock(&of_pci_msi_chip_mutex);\r\n}\r\nstruct msi_chip *of_pci_find_msi_chip_by_node(struct device_node *of_node)\r\n{\r\nstruct msi_chip *c;\r\nmutex_lock(&of_pci_msi_chip_mutex);\r\nlist_for_each_entry(c, &of_pci_msi_chip_list, list) {\r\nif (c->of_node == of_node) {\r\nmutex_unlock(&of_pci_msi_chip_mutex);\r\nreturn c;\r\n}\r\n}\r\nmutex_unlock(&of_pci_msi_chip_mutex);\r\nreturn NULL;\r\n}

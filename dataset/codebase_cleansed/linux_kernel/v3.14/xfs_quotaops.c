STATIC int\r\nxfs_quota_type(int type)\r\n{\r\nswitch (type) {\r\ncase USRQUOTA:\r\nreturn XFS_DQ_USER;\r\ncase GRPQUOTA:\r\nreturn XFS_DQ_GROUP;\r\ndefault:\r\nreturn XFS_DQ_PROJ;\r\n}\r\n}\r\nSTATIC int\r\nxfs_fs_get_xstate(\r\nstruct super_block *sb,\r\nstruct fs_quota_stat *fqs)\r\n{\r\nstruct xfs_mount *mp = XFS_M(sb);\r\nif (!XFS_IS_QUOTA_RUNNING(mp))\r\nreturn -ENOSYS;\r\nreturn -xfs_qm_scall_getqstat(mp, fqs);\r\n}\r\nSTATIC int\r\nxfs_fs_get_xstatev(\r\nstruct super_block *sb,\r\nstruct fs_quota_statv *fqs)\r\n{\r\nstruct xfs_mount *mp = XFS_M(sb);\r\nif (!XFS_IS_QUOTA_RUNNING(mp))\r\nreturn -ENOSYS;\r\nreturn -xfs_qm_scall_getqstatv(mp, fqs);\r\n}\r\nSTATIC int\r\nxfs_fs_set_xstate(\r\nstruct super_block *sb,\r\nunsigned int uflags,\r\nint op)\r\n{\r\nstruct xfs_mount *mp = XFS_M(sb);\r\nunsigned int flags = 0;\r\nif (sb->s_flags & MS_RDONLY)\r\nreturn -EROFS;\r\nif (op != Q_XQUOTARM && !XFS_IS_QUOTA_RUNNING(mp))\r\nreturn -ENOSYS;\r\nif (uflags & FS_QUOTA_UDQ_ACCT)\r\nflags |= XFS_UQUOTA_ACCT;\r\nif (uflags & FS_QUOTA_PDQ_ACCT)\r\nflags |= XFS_PQUOTA_ACCT;\r\nif (uflags & FS_QUOTA_GDQ_ACCT)\r\nflags |= XFS_GQUOTA_ACCT;\r\nif (uflags & FS_QUOTA_UDQ_ENFD)\r\nflags |= XFS_UQUOTA_ENFD;\r\nif (uflags & FS_QUOTA_GDQ_ENFD)\r\nflags |= XFS_GQUOTA_ENFD;\r\nif (uflags & FS_QUOTA_PDQ_ENFD)\r\nflags |= XFS_PQUOTA_ENFD;\r\nswitch (op) {\r\ncase Q_XQUOTAON:\r\nreturn -xfs_qm_scall_quotaon(mp, flags);\r\ncase Q_XQUOTAOFF:\r\nif (!XFS_IS_QUOTA_ON(mp))\r\nreturn -EINVAL;\r\nreturn -xfs_qm_scall_quotaoff(mp, flags);\r\ncase Q_XQUOTARM:\r\nif (XFS_IS_QUOTA_ON(mp))\r\nreturn -EINVAL;\r\nreturn -xfs_qm_scall_trunc_qfiles(mp, flags);\r\n}\r\nreturn -EINVAL;\r\n}\r\nSTATIC int\r\nxfs_fs_get_dqblk(\r\nstruct super_block *sb,\r\nstruct kqid qid,\r\nstruct fs_disk_quota *fdq)\r\n{\r\nstruct xfs_mount *mp = XFS_M(sb);\r\nif (!XFS_IS_QUOTA_RUNNING(mp))\r\nreturn -ENOSYS;\r\nif (!XFS_IS_QUOTA_ON(mp))\r\nreturn -ESRCH;\r\nreturn -xfs_qm_scall_getquota(mp, from_kqid(&init_user_ns, qid),\r\nxfs_quota_type(qid.type), fdq);\r\n}\r\nSTATIC int\r\nxfs_fs_set_dqblk(\r\nstruct super_block *sb,\r\nstruct kqid qid,\r\nstruct fs_disk_quota *fdq)\r\n{\r\nstruct xfs_mount *mp = XFS_M(sb);\r\nif (sb->s_flags & MS_RDONLY)\r\nreturn -EROFS;\r\nif (!XFS_IS_QUOTA_RUNNING(mp))\r\nreturn -ENOSYS;\r\nif (!XFS_IS_QUOTA_ON(mp))\r\nreturn -ESRCH;\r\nreturn -xfs_qm_scall_setqlim(mp, from_kqid(&init_user_ns, qid),\r\nxfs_quota_type(qid.type), fdq);\r\n}

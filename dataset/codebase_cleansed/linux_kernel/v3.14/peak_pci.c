static inline void pita_set_scl_highz(struct peak_pciec_card *card)\r\n{\r\nu8 gp_outen = readb(card->cfg_base + PITA_GPOEN) & ~PITA_GPIN_SCL;\r\nwriteb(gp_outen, card->cfg_base + PITA_GPOEN);\r\n}\r\nstatic inline void pita_set_sda_highz(struct peak_pciec_card *card)\r\n{\r\nu8 gp_outen = readb(card->cfg_base + PITA_GPOEN) & ~PITA_GPIN_SDA;\r\nwriteb(gp_outen, card->cfg_base + PITA_GPOEN);\r\n}\r\nstatic void peak_pciec_init_pita_gpio(struct peak_pciec_card *card)\r\n{\r\npita_set_scl_highz(card);\r\npita_set_sda_highz(card);\r\n}\r\nstatic void pita_setsda(void *data, int state)\r\n{\r\nstruct peak_pciec_card *card = (struct peak_pciec_card *)data;\r\nu8 gp_out, gp_outen;\r\ngp_out = readb(card->cfg_base + PITA_GPOUT) & ~PITA_GPIN_SDA;\r\nwriteb(gp_out, card->cfg_base + PITA_GPOUT);\r\ngp_outen = readb(card->cfg_base + PITA_GPOEN);\r\nif (state)\r\ngp_outen &= ~PITA_GPIN_SDA;\r\nelse\r\ngp_outen |= PITA_GPIN_SDA;\r\nwriteb(gp_outen, card->cfg_base + PITA_GPOEN);\r\n}\r\nstatic void pita_setscl(void *data, int state)\r\n{\r\nstruct peak_pciec_card *card = (struct peak_pciec_card *)data;\r\nu8 gp_out, gp_outen;\r\ngp_out = readb(card->cfg_base + PITA_GPOUT) & ~PITA_GPIN_SCL;\r\nwriteb(gp_out, card->cfg_base + PITA_GPOUT);\r\ngp_outen = readb(card->cfg_base + PITA_GPOEN);\r\nif (state)\r\ngp_outen &= ~PITA_GPIN_SCL;\r\nelse\r\ngp_outen |= PITA_GPIN_SCL;\r\nwriteb(gp_outen, card->cfg_base + PITA_GPOEN);\r\n}\r\nstatic int pita_getsda(void *data)\r\n{\r\nstruct peak_pciec_card *card = (struct peak_pciec_card *)data;\r\npita_set_sda_highz(card);\r\nreturn (readb(card->cfg_base + PITA_GPIN) & PITA_GPIN_SDA) ? 1 : 0;\r\n}\r\nstatic int pita_getscl(void *data)\r\n{\r\nstruct peak_pciec_card *card = (struct peak_pciec_card *)data;\r\npita_set_scl_highz(card);\r\nreturn (readb(card->cfg_base + PITA_GPIN) & PITA_GPIN_SCL) ? 1 : 0;\r\n}\r\nstatic int peak_pciec_write_pca9553(struct peak_pciec_card *card,\r\nu8 offset, u8 data)\r\n{\r\nu8 buffer[2] = {\r\noffset,\r\ndata\r\n};\r\nstruct i2c_msg msg = {\r\n.addr = PCA9553_1_SLAVEADDR,\r\n.len = 2,\r\n.buf = buffer,\r\n};\r\nint ret;\r\nif ((offset == 5) && (data == card->led_cache))\r\nreturn 0;\r\nret = i2c_transfer(&card->led_chip, &msg, 1);\r\nif (ret < 0)\r\nreturn ret;\r\nif (offset == 5)\r\ncard->led_cache = data;\r\nreturn 0;\r\n}\r\nstatic void peak_pciec_led_work(struct work_struct *work)\r\n{\r\nstruct peak_pciec_card *card =\r\ncontainer_of(work, struct peak_pciec_card, led_work.work);\r\nstruct net_device *netdev;\r\nu8 new_led = card->led_cache;\r\nint i, up_count = 0;\r\nfor (i = 0; i < card->chan_count; i++) {\r\nnew_led &= ~PCA9553_LED_MASK(i);\r\nnew_led |= PCA9553_LED_ON(i);\r\nnetdev = card->channel[i].netdev;\r\nif (!netdev || !(netdev->flags & IFF_UP))\r\ncontinue;\r\nup_count++;\r\nnew_led &= ~PCA9553_LED_MASK(i);\r\nnew_led |= PCA9553_LED_SLOW(i);\r\nif (netdev->stats.rx_bytes != card->channel[i].prev_rx_bytes) {\r\ncard->channel[i].prev_rx_bytes = netdev->stats.rx_bytes;\r\nnew_led &= ~PCA9553_LED_MASK(i);\r\nnew_led |= PCA9553_LED_FAST(i);\r\n}\r\nif (netdev->stats.tx_bytes != card->channel[i].prev_tx_bytes) {\r\ncard->channel[i].prev_tx_bytes = netdev->stats.tx_bytes;\r\nnew_led &= ~PCA9553_LED_MASK(i);\r\nnew_led |= PCA9553_LED_FAST(i);\r\n}\r\n}\r\npeak_pciec_write_pca9553(card, 5, new_led);\r\nif (up_count)\r\nschedule_delayed_work(&card->led_work, HZ);\r\n}\r\nstatic void peak_pciec_set_leds(struct peak_pciec_card *card, u8 led_mask, u8 s)\r\n{\r\nu8 new_led = card->led_cache;\r\nint i;\r\nfor (i = 0; i < card->chan_count; i++)\r\nif (led_mask & PCA9553_LED(i)) {\r\nnew_led &= ~PCA9553_LED_MASK(i);\r\nnew_led |= PCA9553_LED_STATE(s, i);\r\n}\r\npeak_pciec_write_pca9553(card, 5, new_led);\r\n}\r\nstatic void peak_pciec_start_led_work(struct peak_pciec_card *card)\r\n{\r\nschedule_delayed_work(&card->led_work, HZ);\r\n}\r\nstatic void peak_pciec_stop_led_work(struct peak_pciec_card *card)\r\n{\r\ncancel_delayed_work_sync(&card->led_work);\r\n}\r\nstatic int peak_pciec_init_leds(struct peak_pciec_card *card)\r\n{\r\nint err;\r\nerr = peak_pciec_write_pca9553(card, 1, 44 / 1);\r\nif (err)\r\nreturn err;\r\nerr = peak_pciec_write_pca9553(card, 2, 0x80);\r\nif (err)\r\nreturn err;\r\nerr = peak_pciec_write_pca9553(card, 3, 44 / 5);\r\nif (err)\r\nreturn err;\r\nerr = peak_pciec_write_pca9553(card, 4, 0x80);\r\nif (err)\r\nreturn err;\r\nreturn peak_pciec_write_pca9553(card, 5, PCA9553_LS0_INIT);\r\n}\r\nstatic void peak_pciec_leds_exit(struct peak_pciec_card *card)\r\n{\r\npeak_pciec_write_pca9553(card, 5, PCA9553_LED_OFF_ALL);\r\n}\r\nstatic void peak_pciec_write_reg(const struct sja1000_priv *priv,\r\nint port, u8 val)\r\n{\r\nstruct peak_pci_chan *chan = priv->priv;\r\nstruct peak_pciec_card *card = chan->pciec_card;\r\nint c = (priv->reg_base - card->reg_base) / PEAK_PCI_CHAN_SIZE;\r\nif (port == SJA1000_MOD)\r\nswitch (val) {\r\ncase MOD_RM:\r\npeak_pciec_set_leds(card, PCA9553_LED(c), PCA9553_ON);\r\nbreak;\r\ncase 0x00:\r\npeak_pciec_set_leds(card, PCA9553_LED(c), PCA9553_SLOW);\r\npeak_pciec_start_led_work(card);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\npeak_pci_write_reg(priv, port, val);\r\n}\r\nstatic int peak_pciec_probe(struct pci_dev *pdev, struct net_device *dev)\r\n{\r\nstruct sja1000_priv *priv = netdev_priv(dev);\r\nstruct peak_pci_chan *chan = priv->priv;\r\nstruct peak_pciec_card *card;\r\nint err;\r\nif (chan->prev_dev) {\r\nstruct sja1000_priv *prev_priv = netdev_priv(chan->prev_dev);\r\nstruct peak_pci_chan *prev_chan = prev_priv->priv;\r\ncard = prev_chan->pciec_card;\r\nif (!card)\r\nreturn -ENODEV;\r\n} else {\r\ncard = kzalloc(sizeof(struct peak_pciec_card), GFP_KERNEL);\r\nif (!card)\r\nreturn -ENOMEM;\r\ncard->cfg_base = chan->cfg_base;\r\ncard->reg_base = priv->reg_base;\r\ncard->led_chip.owner = THIS_MODULE;\r\ncard->led_chip.dev.parent = &pdev->dev;\r\ncard->led_chip.algo_data = &card->i2c_bit;\r\nstrncpy(card->led_chip.name, "peak_i2c",\r\nsizeof(card->led_chip.name));\r\ncard->i2c_bit = peak_pciec_i2c_bit_ops;\r\ncard->i2c_bit.udelay = 10;\r\ncard->i2c_bit.timeout = HZ;\r\ncard->i2c_bit.data = card;\r\npeak_pciec_init_pita_gpio(card);\r\nerr = i2c_bit_add_bus(&card->led_chip);\r\nif (err) {\r\ndev_err(&pdev->dev, "i2c init failed\n");\r\ngoto pciec_init_err_1;\r\n}\r\nerr = peak_pciec_init_leds(card);\r\nif (err) {\r\ndev_err(&pdev->dev, "leds hardware init failed\n");\r\ngoto pciec_init_err_2;\r\n}\r\nINIT_DELAYED_WORK(&card->led_work, peak_pciec_led_work);\r\npriv->write_reg = peak_pciec_write_reg;\r\n}\r\nchan->pciec_card = card;\r\ncard->channel[card->chan_count++].netdev = dev;\r\nreturn 0;\r\npciec_init_err_2:\r\ni2c_del_adapter(&card->led_chip);\r\npciec_init_err_1:\r\npeak_pciec_init_pita_gpio(card);\r\nkfree(card);\r\nreturn err;\r\n}\r\nstatic void peak_pciec_remove(struct peak_pciec_card *card)\r\n{\r\npeak_pciec_stop_led_work(card);\r\npeak_pciec_leds_exit(card);\r\ni2c_del_adapter(&card->led_chip);\r\npeak_pciec_init_pita_gpio(card);\r\nkfree(card);\r\n}\r\nstatic inline int peak_pciec_probe(struct pci_dev *pdev, struct net_device *dev)\r\n{\r\nreturn -ENODEV;\r\n}\r\nstatic inline void peak_pciec_remove(struct peak_pciec_card *card)\r\n{\r\n}\r\nstatic u8 peak_pci_read_reg(const struct sja1000_priv *priv, int port)\r\n{\r\nreturn readb(priv->reg_base + (port << 2));\r\n}\r\nstatic void peak_pci_write_reg(const struct sja1000_priv *priv,\r\nint port, u8 val)\r\n{\r\nwriteb(val, priv->reg_base + (port << 2));\r\n}\r\nstatic void peak_pci_post_irq(const struct sja1000_priv *priv)\r\n{\r\nstruct peak_pci_chan *chan = priv->priv;\r\nu16 icr;\r\nicr = readw(chan->cfg_base + PITA_ICR);\r\nif (icr & chan->icr_mask)\r\nwritew(chan->icr_mask, chan->cfg_base + PITA_ICR);\r\n}\r\nstatic int peak_pci_probe(struct pci_dev *pdev, const struct pci_device_id *ent)\r\n{\r\nstruct sja1000_priv *priv;\r\nstruct peak_pci_chan *chan;\r\nstruct net_device *dev;\r\nvoid __iomem *cfg_base, *reg_base;\r\nu16 sub_sys_id, icr;\r\nint i, err, channels;\r\nerr = pci_enable_device(pdev);\r\nif (err)\r\nreturn err;\r\nerr = pci_request_regions(pdev, DRV_NAME);\r\nif (err)\r\ngoto failure_disable_pci;\r\nerr = pci_read_config_word(pdev, 0x2e, &sub_sys_id);\r\nif (err)\r\ngoto failure_release_regions;\r\ndev_dbg(&pdev->dev, "probing device %04x:%04x:%04x\n",\r\npdev->vendor, pdev->device, sub_sys_id);\r\nerr = pci_write_config_word(pdev, 0x44, 0);\r\nif (err)\r\ngoto failure_release_regions;\r\nif (sub_sys_id >= 12)\r\nchannels = 4;\r\nelse if (sub_sys_id >= 10)\r\nchannels = 3;\r\nelse if (sub_sys_id >= 4)\r\nchannels = 2;\r\nelse\r\nchannels = 1;\r\ncfg_base = pci_iomap(pdev, 0, PEAK_PCI_CFG_SIZE);\r\nif (!cfg_base) {\r\ndev_err(&pdev->dev, "failed to map PCI resource #0\n");\r\nerr = -ENOMEM;\r\ngoto failure_release_regions;\r\n}\r\nreg_base = pci_iomap(pdev, 1, PEAK_PCI_CHAN_SIZE * channels);\r\nif (!reg_base) {\r\ndev_err(&pdev->dev, "failed to map PCI resource #1\n");\r\nerr = -ENOMEM;\r\ngoto failure_unmap_cfg_base;\r\n}\r\nwritew(0x0005, cfg_base + PITA_GPIOICR + 2);\r\nwriteb(0x00, cfg_base + PITA_GPIOICR);\r\nwriteb(0x05, cfg_base + PITA_MISC + 3);\r\nmdelay(5);\r\nwriteb(0x04, cfg_base + PITA_MISC + 3);\r\nicr = readw(cfg_base + PITA_ICR + 2);\r\nfor (i = 0; i < channels; i++) {\r\ndev = alloc_sja1000dev(sizeof(struct peak_pci_chan));\r\nif (!dev) {\r\nerr = -ENOMEM;\r\ngoto failure_remove_channels;\r\n}\r\npriv = netdev_priv(dev);\r\nchan = priv->priv;\r\nchan->cfg_base = cfg_base;\r\npriv->reg_base = reg_base + i * PEAK_PCI_CHAN_SIZE;\r\npriv->read_reg = peak_pci_read_reg;\r\npriv->write_reg = peak_pci_write_reg;\r\npriv->post_irq = peak_pci_post_irq;\r\npriv->can.clock.freq = PEAK_PCI_CAN_CLOCK;\r\npriv->ocr = PEAK_PCI_OCR;\r\npriv->cdr = PEAK_PCI_CDR;\r\nif (channels == 1 || i > 0)\r\npriv->cdr |= CDR_CLK_OFF;\r\npriv->irq_flags = IRQF_SHARED;\r\ndev->irq = pdev->irq;\r\nchan->icr_mask = peak_pci_icr_masks[i];\r\nicr |= chan->icr_mask;\r\nSET_NETDEV_DEV(dev, &pdev->dev);\r\nchan->prev_dev = pci_get_drvdata(pdev);\r\npci_set_drvdata(pdev, dev);\r\nif (pdev->device == PEAK_PCIEC_DEVICE_ID) {\r\nerr = peak_pciec_probe(pdev, dev);\r\nif (err) {\r\ndev_err(&pdev->dev,\r\n"failed to probe device (err %d)\n",\r\nerr);\r\ngoto failure_free_dev;\r\n}\r\n}\r\nerr = register_sja1000dev(dev);\r\nif (err) {\r\ndev_err(&pdev->dev, "failed to register device\n");\r\ngoto failure_free_dev;\r\n}\r\ndev_info(&pdev->dev,\r\n"%s at reg_base=0x%p cfg_base=0x%p irq=%d\n",\r\ndev->name, priv->reg_base, chan->cfg_base, dev->irq);\r\n}\r\nwritew(icr, cfg_base + PITA_ICR + 2);\r\nreturn 0;\r\nfailure_free_dev:\r\npci_set_drvdata(pdev, chan->prev_dev);\r\nfree_sja1000dev(dev);\r\nfailure_remove_channels:\r\nwritew(0x0, cfg_base + PITA_ICR + 2);\r\nchan = NULL;\r\nfor (dev = pci_get_drvdata(pdev); dev; dev = chan->prev_dev) {\r\nunregister_sja1000dev(dev);\r\nfree_sja1000dev(dev);\r\npriv = netdev_priv(dev);\r\nchan = priv->priv;\r\n}\r\nif (chan && chan->pciec_card)\r\npeak_pciec_remove(chan->pciec_card);\r\npci_iounmap(pdev, reg_base);\r\nfailure_unmap_cfg_base:\r\npci_iounmap(pdev, cfg_base);\r\nfailure_release_regions:\r\npci_release_regions(pdev);\r\nfailure_disable_pci:\r\npci_disable_device(pdev);\r\nreturn err;\r\n}\r\nstatic void peak_pci_remove(struct pci_dev *pdev)\r\n{\r\nstruct net_device *dev = pci_get_drvdata(pdev);\r\nstruct sja1000_priv *priv = netdev_priv(dev);\r\nstruct peak_pci_chan *chan = priv->priv;\r\nvoid __iomem *cfg_base = chan->cfg_base;\r\nvoid __iomem *reg_base = priv->reg_base;\r\nwritew(0x0, cfg_base + PITA_ICR + 2);\r\nwhile (1) {\r\ndev_info(&pdev->dev, "removing device %s\n", dev->name);\r\nunregister_sja1000dev(dev);\r\nfree_sja1000dev(dev);\r\ndev = chan->prev_dev;\r\nif (!dev) {\r\nif (chan->pciec_card)\r\npeak_pciec_remove(chan->pciec_card);\r\nbreak;\r\n}\r\npriv = netdev_priv(dev);\r\nchan = priv->priv;\r\n}\r\npci_iounmap(pdev, reg_base);\r\npci_iounmap(pdev, cfg_base);\r\npci_release_regions(pdev);\r\npci_disable_device(pdev);\r\n}

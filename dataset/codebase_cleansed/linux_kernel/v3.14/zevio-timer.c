static int zevio_timer_set_event(unsigned long delta,\r\nstruct clock_event_device *dev)\r\n{\r\nstruct zevio_timer *timer = container_of(dev, struct zevio_timer,\r\nclkevt);\r\nwritel(delta, timer->timer1 + IO_CURRENT_VAL);\r\nwritel(CNTL_RUN_TIMER | CNTL_DEC | CNTL_MATCH(TIMER_MATCH),\r\ntimer->timer1 + IO_CONTROL);\r\nreturn 0;\r\n}\r\nstatic void zevio_timer_set_mode(enum clock_event_mode mode,\r\nstruct clock_event_device *dev)\r\n{\r\nstruct zevio_timer *timer = container_of(dev, struct zevio_timer,\r\nclkevt);\r\nswitch (mode) {\r\ncase CLOCK_EVT_MODE_RESUME:\r\ncase CLOCK_EVT_MODE_ONESHOT:\r\nwritel(TIMER_INTR_MSK, timer->interrupt_regs + IO_INTR_MSK);\r\nwritel(TIMER_INTR_ALL, timer->interrupt_regs + IO_INTR_ACK);\r\nbreak;\r\ncase CLOCK_EVT_MODE_SHUTDOWN:\r\ncase CLOCK_EVT_MODE_UNUSED:\r\nwritel(0, timer->interrupt_regs + IO_INTR_MSK);\r\nwritel(TIMER_INTR_ALL, timer->interrupt_regs + IO_INTR_ACK);\r\nwritel(CNTL_STOP_TIMER, timer->timer1 + IO_CONTROL);\r\nbreak;\r\ncase CLOCK_EVT_MODE_PERIODIC:\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic irqreturn_t zevio_timer_interrupt(int irq, void *dev_id)\r\n{\r\nstruct zevio_timer *timer = dev_id;\r\nu32 intr;\r\nintr = readl(timer->interrupt_regs + IO_INTR_ACK);\r\nif (!(intr & TIMER_INTR_MSK))\r\nreturn IRQ_NONE;\r\nwritel(TIMER_INTR_MSK, timer->interrupt_regs + IO_INTR_ACK);\r\nwritel(CNTL_STOP_TIMER, timer->timer1 + IO_CONTROL);\r\nif (timer->clkevt.event_handler)\r\ntimer->clkevt.event_handler(&timer->clkevt);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __init zevio_timer_add(struct device_node *node)\r\n{\r\nstruct zevio_timer *timer;\r\nstruct resource res;\r\nint irqnr, ret;\r\ntimer = kzalloc(sizeof(*timer), GFP_KERNEL);\r\nif (!timer)\r\nreturn -ENOMEM;\r\ntimer->base = of_iomap(node, 0);\r\nif (!timer->base) {\r\nret = -EINVAL;\r\ngoto error_free;\r\n}\r\ntimer->timer1 = timer->base + IO_TIMER1;\r\ntimer->timer2 = timer->base + IO_TIMER2;\r\ntimer->clk = of_clk_get(node, 0);\r\nif (IS_ERR(timer->clk)) {\r\nret = PTR_ERR(timer->clk);\r\npr_err("Timer clock not found! (error %d)\n", ret);\r\ngoto error_unmap;\r\n}\r\ntimer->interrupt_regs = of_iomap(node, 1);\r\nirqnr = irq_of_parse_and_map(node, 0);\r\nof_address_to_resource(node, 0, &res);\r\nscnprintf(timer->clocksource_name, sizeof(timer->clocksource_name),\r\n"%llx.%s_clocksource",\r\n(unsigned long long)res.start, node->name);\r\nscnprintf(timer->clockevent_name, sizeof(timer->clockevent_name),\r\n"%llx.%s_clockevent",\r\n(unsigned long long)res.start, node->name);\r\nif (timer->interrupt_regs && irqnr) {\r\ntimer->clkevt.name = timer->clockevent_name;\r\ntimer->clkevt.set_next_event = zevio_timer_set_event;\r\ntimer->clkevt.set_mode = zevio_timer_set_mode;\r\ntimer->clkevt.rating = 200;\r\ntimer->clkevt.cpumask = cpu_all_mask;\r\ntimer->clkevt.features = CLOCK_EVT_FEAT_ONESHOT;\r\ntimer->clkevt.irq = irqnr;\r\nwritel(CNTL_STOP_TIMER, timer->timer1 + IO_CONTROL);\r\nwritel(0, timer->timer1 + IO_DIVIDER);\r\nwritel(0, timer->interrupt_regs + IO_INTR_MSK);\r\nwritel(TIMER_INTR_ALL, timer->interrupt_regs + IO_INTR_ACK);\r\nwritel(0, timer->base + IO_MATCH(TIMER_MATCH));\r\ntimer->clkevt_irq.name = timer->clockevent_name;\r\ntimer->clkevt_irq.handler = zevio_timer_interrupt;\r\ntimer->clkevt_irq.dev_id = timer;\r\ntimer->clkevt_irq.flags = IRQF_TIMER | IRQF_IRQPOLL;\r\nsetup_irq(irqnr, &timer->clkevt_irq);\r\nclockevents_config_and_register(&timer->clkevt,\r\nclk_get_rate(timer->clk), 0x0001, 0xffff);\r\npr_info("Added %s as clockevent\n", timer->clockevent_name);\r\n}\r\nwritel(CNTL_STOP_TIMER, timer->timer2 + IO_CONTROL);\r\nwritel(0, timer->timer2 + IO_CURRENT_VAL);\r\nwritel(0, timer->timer2 + IO_DIVIDER);\r\nwritel(CNTL_RUN_TIMER | CNTL_FOREVER | CNTL_INC,\r\ntimer->timer2 + IO_CONTROL);\r\nclocksource_mmio_init(timer->timer2 + IO_CURRENT_VAL,\r\ntimer->clocksource_name,\r\nclk_get_rate(timer->clk),\r\n200, 16,\r\nclocksource_mmio_readw_up);\r\npr_info("Added %s as clocksource\n", timer->clocksource_name);\r\nreturn 0;\r\nerror_unmap:\r\niounmap(timer->base);\r\nerror_free:\r\nkfree(timer);\r\nreturn ret;\r\n}

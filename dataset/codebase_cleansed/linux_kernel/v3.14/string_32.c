char *strcpy(char *dest, const char *src)\r\n{\r\nint d0, d1, d2;\r\nasm volatile("1:\tlodsb\n\t"\r\n"stosb\n\t"\r\n"testb %%al,%%al\n\t"\r\n"jne 1b"\r\n: "=&S" (d0), "=&D" (d1), "=&a" (d2)\r\n: "0" (src), "1" (dest) : "memory");\r\nreturn dest;\r\n}\r\nchar *strncpy(char *dest, const char *src, size_t count)\r\n{\r\nint d0, d1, d2, d3;\r\nasm volatile("1:\tdecl %2\n\t"\r\n"js 2f\n\t"\r\n"lodsb\n\t"\r\n"stosb\n\t"\r\n"testb %%al,%%al\n\t"\r\n"jne 1b\n\t"\r\n"rep\n\t"\r\n"stosb\n"\r\n"2:"\r\n: "=&S" (d0), "=&D" (d1), "=&c" (d2), "=&a" (d3)\r\n: "0" (src), "1" (dest), "2" (count) : "memory");\r\nreturn dest;\r\n}\r\nchar *strcat(char *dest, const char *src)\r\n{\r\nint d0, d1, d2, d3;\r\nasm volatile("repne\n\t"\r\n"scasb\n\t"\r\n"decl %1\n"\r\n"1:\tlodsb\n\t"\r\n"stosb\n\t"\r\n"testb %%al,%%al\n\t"\r\n"jne 1b"\r\n: "=&S" (d0), "=&D" (d1), "=&a" (d2), "=&c" (d3)\r\n: "0" (src), "1" (dest), "2" (0), "3" (0xffffffffu) : "memory");\r\nreturn dest;\r\n}\r\nchar *strncat(char *dest, const char *src, size_t count)\r\n{\r\nint d0, d1, d2, d3;\r\nasm volatile("repne\n\t"\r\n"scasb\n\t"\r\n"decl %1\n\t"\r\n"movl %8,%3\n"\r\n"1:\tdecl %3\n\t"\r\n"js 2f\n\t"\r\n"lodsb\n\t"\r\n"stosb\n\t"\r\n"testb %%al,%%al\n\t"\r\n"jne 1b\n"\r\n"2:\txorl %2,%2\n\t"\r\n"stosb"\r\n: "=&S" (d0), "=&D" (d1), "=&a" (d2), "=&c" (d3)\r\n: "0" (src), "1" (dest), "2" (0), "3" (0xffffffffu), "g" (count)\r\n: "memory");\r\nreturn dest;\r\n}\r\nint strcmp(const char *cs, const char *ct)\r\n{\r\nint d0, d1;\r\nint res;\r\nasm volatile("1:\tlodsb\n\t"\r\n"scasb\n\t"\r\n"jne 2f\n\t"\r\n"testb %%al,%%al\n\t"\r\n"jne 1b\n\t"\r\n"xorl %%eax,%%eax\n\t"\r\n"jmp 3f\n"\r\n"2:\tsbbl %%eax,%%eax\n\t"\r\n"orb $1,%%al\n"\r\n"3:"\r\n: "=a" (res), "=&S" (d0), "=&D" (d1)\r\n: "1" (cs), "2" (ct)\r\n: "memory");\r\nreturn res;\r\n}\r\nint strncmp(const char *cs, const char *ct, size_t count)\r\n{\r\nint res;\r\nint d0, d1, d2;\r\nasm volatile("1:\tdecl %3\n\t"\r\n"js 2f\n\t"\r\n"lodsb\n\t"\r\n"scasb\n\t"\r\n"jne 3f\n\t"\r\n"testb %%al,%%al\n\t"\r\n"jne 1b\n"\r\n"2:\txorl %%eax,%%eax\n\t"\r\n"jmp 4f\n"\r\n"3:\tsbbl %%eax,%%eax\n\t"\r\n"orb $1,%%al\n"\r\n"4:"\r\n: "=a" (res), "=&S" (d0), "=&D" (d1), "=&c" (d2)\r\n: "1" (cs), "2" (ct), "3" (count)\r\n: "memory");\r\nreturn res;\r\n}\r\nchar *strchr(const char *s, int c)\r\n{\r\nint d0;\r\nchar *res;\r\nasm volatile("movb %%al,%%ah\n"\r\n"1:\tlodsb\n\t"\r\n"cmpb %%ah,%%al\n\t"\r\n"je 2f\n\t"\r\n"testb %%al,%%al\n\t"\r\n"jne 1b\n\t"\r\n"movl $1,%1\n"\r\n"2:\tmovl %1,%0\n\t"\r\n"decl %0"\r\n: "=a" (res), "=&S" (d0)\r\n: "1" (s), "0" (c)\r\n: "memory");\r\nreturn res;\r\n}\r\nsize_t strlen(const char *s)\r\n{\r\nint d0;\r\nsize_t res;\r\nasm volatile("repne\n\t"\r\n"scasb"\r\n: "=c" (res), "=&D" (d0)\r\n: "1" (s), "a" (0), "0" (0xffffffffu)\r\n: "memory");\r\nreturn ~res - 1;\r\n}\r\nvoid *memchr(const void *cs, int c, size_t count)\r\n{\r\nint d0;\r\nvoid *res;\r\nif (!count)\r\nreturn NULL;\r\nasm volatile("repne\n\t"\r\n"scasb\n\t"\r\n"je 1f\n\t"\r\n"movl $1,%0\n"\r\n"1:\tdecl %0"\r\n: "=D" (res), "=&c" (d0)\r\n: "a" (c), "0" (cs), "1" (count)\r\n: "memory");\r\nreturn res;\r\n}\r\nvoid *memscan(void *addr, int c, size_t size)\r\n{\r\nif (!size)\r\nreturn addr;\r\nasm volatile("repnz; scasb\n\t"\r\n"jnz 1f\n\t"\r\n"dec %%edi\n"\r\n"1:"\r\n: "=D" (addr), "=c" (size)\r\n: "0" (addr), "1" (size), "a" (c)\r\n: "memory");\r\nreturn addr;\r\n}\r\nsize_t strnlen(const char *s, size_t count)\r\n{\r\nint d0;\r\nint res;\r\nasm volatile("movl %2,%0\n\t"\r\n"jmp 2f\n"\r\n"1:\tcmpb $0,(%0)\n\t"\r\n"je 3f\n\t"\r\n"incl %0\n"\r\n"2:\tdecl %1\n\t"\r\n"cmpl $-1,%1\n\t"\r\n"jne 1b\n"\r\n"3:\tsubl %2,%0"\r\n: "=a" (res), "=&d" (d0)\r\n: "c" (s), "1" (count)\r\n: "memory");\r\nreturn res;\r\n}

static int\r\nxfs_dir2_sf_entsize(\r\nstruct xfs_dir2_sf_hdr *hdr,\r\nint len)\r\n{\r\nint count = sizeof(struct xfs_dir2_sf_entry);\r\ncount += len;\r\ncount += hdr->i8count ? sizeof(xfs_dir2_ino8_t) :\r\nsizeof(xfs_dir2_ino4_t);\r\nreturn count;\r\n}\r\nstatic int\r\nxfs_dir3_sf_entsize(\r\nstruct xfs_dir2_sf_hdr *hdr,\r\nint len)\r\n{\r\nreturn xfs_dir2_sf_entsize(hdr, len) + sizeof(__uint8_t);\r\n}\r\nstatic struct xfs_dir2_sf_entry *\r\nxfs_dir2_sf_nextentry(\r\nstruct xfs_dir2_sf_hdr *hdr,\r\nstruct xfs_dir2_sf_entry *sfep)\r\n{\r\nreturn (struct xfs_dir2_sf_entry *)\r\n((char *)sfep + xfs_dir2_sf_entsize(hdr, sfep->namelen));\r\n}\r\nstatic struct xfs_dir2_sf_entry *\r\nxfs_dir3_sf_nextentry(\r\nstruct xfs_dir2_sf_hdr *hdr,\r\nstruct xfs_dir2_sf_entry *sfep)\r\n{\r\nreturn (struct xfs_dir2_sf_entry *)\r\n((char *)sfep + xfs_dir3_sf_entsize(hdr, sfep->namelen));\r\n}\r\nstatic __uint8_t\r\nxfs_dir2_sfe_get_ftype(\r\nstruct xfs_dir2_sf_entry *sfep)\r\n{\r\nreturn XFS_DIR3_FT_UNKNOWN;\r\n}\r\nstatic void\r\nxfs_dir2_sfe_put_ftype(\r\nstruct xfs_dir2_sf_entry *sfep,\r\n__uint8_t ftype)\r\n{\r\nASSERT(ftype < XFS_DIR3_FT_MAX);\r\n}\r\nstatic __uint8_t\r\nxfs_dir3_sfe_get_ftype(\r\nstruct xfs_dir2_sf_entry *sfep)\r\n{\r\n__uint8_t ftype;\r\nftype = sfep->name[sfep->namelen];\r\nif (ftype >= XFS_DIR3_FT_MAX)\r\nreturn XFS_DIR3_FT_UNKNOWN;\r\nreturn ftype;\r\n}\r\nstatic void\r\nxfs_dir3_sfe_put_ftype(\r\nstruct xfs_dir2_sf_entry *sfep,\r\n__uint8_t ftype)\r\n{\r\nASSERT(ftype < XFS_DIR3_FT_MAX);\r\nsfep->name[sfep->namelen] = ftype;\r\n}\r\nstatic xfs_ino_t\r\nxfs_dir2_sf_get_ino(\r\nstruct xfs_dir2_sf_hdr *hdr,\r\nxfs_dir2_inou_t *from)\r\n{\r\nif (hdr->i8count)\r\nreturn get_unaligned_be64(&from->i8.i) & 0x00ffffffffffffffULL;\r\nelse\r\nreturn get_unaligned_be32(&from->i4.i);\r\n}\r\nstatic void\r\nxfs_dir2_sf_put_ino(\r\nstruct xfs_dir2_sf_hdr *hdr,\r\nxfs_dir2_inou_t *to,\r\nxfs_ino_t ino)\r\n{\r\nASSERT((ino & 0xff00000000000000ULL) == 0);\r\nif (hdr->i8count)\r\nput_unaligned_be64(ino, &to->i8.i);\r\nelse\r\nput_unaligned_be32(ino, &to->i4.i);\r\n}\r\nstatic xfs_ino_t\r\nxfs_dir2_sf_get_parent_ino(\r\nstruct xfs_dir2_sf_hdr *hdr)\r\n{\r\nreturn xfs_dir2_sf_get_ino(hdr, &hdr->parent);\r\n}\r\nstatic void\r\nxfs_dir2_sf_put_parent_ino(\r\nstruct xfs_dir2_sf_hdr *hdr,\r\nxfs_ino_t ino)\r\n{\r\nxfs_dir2_sf_put_ino(hdr, &hdr->parent, ino);\r\n}\r\nstatic xfs_ino_t\r\nxfs_dir2_sfe_get_ino(\r\nstruct xfs_dir2_sf_hdr *hdr,\r\nstruct xfs_dir2_sf_entry *sfep)\r\n{\r\nreturn xfs_dir2_sf_get_ino(hdr,\r\n(xfs_dir2_inou_t *)&sfep->name[sfep->namelen]);\r\n}\r\nstatic void\r\nxfs_dir2_sfe_put_ino(\r\nstruct xfs_dir2_sf_hdr *hdr,\r\nstruct xfs_dir2_sf_entry *sfep,\r\nxfs_ino_t ino)\r\n{\r\nxfs_dir2_sf_put_ino(hdr,\r\n(xfs_dir2_inou_t *)&sfep->name[sfep->namelen], ino);\r\n}\r\nstatic xfs_ino_t\r\nxfs_dir3_sfe_get_ino(\r\nstruct xfs_dir2_sf_hdr *hdr,\r\nstruct xfs_dir2_sf_entry *sfep)\r\n{\r\nreturn xfs_dir2_sf_get_ino(hdr,\r\n(xfs_dir2_inou_t *)&sfep->name[sfep->namelen + 1]);\r\n}\r\nstatic void\r\nxfs_dir3_sfe_put_ino(\r\nstruct xfs_dir2_sf_hdr *hdr,\r\nstruct xfs_dir2_sf_entry *sfep,\r\nxfs_ino_t ino)\r\n{\r\nxfs_dir2_sf_put_ino(hdr,\r\n(xfs_dir2_inou_t *)&sfep->name[sfep->namelen + 1], ino);\r\n}\r\nstatic int\r\nxfs_dir2_data_entsize(\r\nint n)\r\n{\r\nreturn XFS_DIR2_DATA_ENTSIZE(n);\r\n}\r\nstatic int\r\nxfs_dir3_data_entsize(\r\nint n)\r\n{\r\nreturn XFS_DIR3_DATA_ENTSIZE(n);\r\n}\r\nstatic __uint8_t\r\nxfs_dir2_data_get_ftype(\r\nstruct xfs_dir2_data_entry *dep)\r\n{\r\nreturn XFS_DIR3_FT_UNKNOWN;\r\n}\r\nstatic void\r\nxfs_dir2_data_put_ftype(\r\nstruct xfs_dir2_data_entry *dep,\r\n__uint8_t ftype)\r\n{\r\nASSERT(ftype < XFS_DIR3_FT_MAX);\r\n}\r\nstatic __uint8_t\r\nxfs_dir3_data_get_ftype(\r\nstruct xfs_dir2_data_entry *dep)\r\n{\r\n__uint8_t ftype = dep->name[dep->namelen];\r\nASSERT(ftype < XFS_DIR3_FT_MAX);\r\nif (ftype >= XFS_DIR3_FT_MAX)\r\nreturn XFS_DIR3_FT_UNKNOWN;\r\nreturn ftype;\r\n}\r\nstatic void\r\nxfs_dir3_data_put_ftype(\r\nstruct xfs_dir2_data_entry *dep,\r\n__uint8_t type)\r\n{\r\nASSERT(type < XFS_DIR3_FT_MAX);\r\nASSERT(dep->namelen != 0);\r\ndep->name[dep->namelen] = type;\r\n}\r\nstatic __be16 *\r\nxfs_dir2_data_entry_tag_p(\r\nstruct xfs_dir2_data_entry *dep)\r\n{\r\nreturn (__be16 *)((char *)dep +\r\nxfs_dir2_data_entsize(dep->namelen) - sizeof(__be16));\r\n}\r\nstatic __be16 *\r\nxfs_dir3_data_entry_tag_p(\r\nstruct xfs_dir2_data_entry *dep)\r\n{\r\nreturn (__be16 *)((char *)dep +\r\nxfs_dir3_data_entsize(dep->namelen) - sizeof(__be16));\r\n}\r\nstatic struct xfs_dir2_data_entry *\r\nxfs_dir2_data_dot_entry_p(\r\nstruct xfs_dir2_data_hdr *hdr)\r\n{\r\nreturn (struct xfs_dir2_data_entry *)\r\n((char *)hdr + sizeof(struct xfs_dir2_data_hdr));\r\n}\r\nstatic struct xfs_dir2_data_entry *\r\nxfs_dir2_data_dotdot_entry_p(\r\nstruct xfs_dir2_data_hdr *hdr)\r\n{\r\nreturn (struct xfs_dir2_data_entry *)\r\n((char *)hdr + sizeof(struct xfs_dir2_data_hdr) +\r\nXFS_DIR2_DATA_ENTSIZE(1));\r\n}\r\nstatic struct xfs_dir2_data_entry *\r\nxfs_dir2_data_first_entry_p(\r\nstruct xfs_dir2_data_hdr *hdr)\r\n{\r\nreturn (struct xfs_dir2_data_entry *)\r\n((char *)hdr + sizeof(struct xfs_dir2_data_hdr) +\r\nXFS_DIR2_DATA_ENTSIZE(1) +\r\nXFS_DIR2_DATA_ENTSIZE(2));\r\n}\r\nstatic struct xfs_dir2_data_entry *\r\nxfs_dir2_ftype_data_dotdot_entry_p(\r\nstruct xfs_dir2_data_hdr *hdr)\r\n{\r\nreturn (struct xfs_dir2_data_entry *)\r\n((char *)hdr + sizeof(struct xfs_dir2_data_hdr) +\r\nXFS_DIR3_DATA_ENTSIZE(1));\r\n}\r\nstatic struct xfs_dir2_data_entry *\r\nxfs_dir2_ftype_data_first_entry_p(\r\nstruct xfs_dir2_data_hdr *hdr)\r\n{\r\nreturn (struct xfs_dir2_data_entry *)\r\n((char *)hdr + sizeof(struct xfs_dir2_data_hdr) +\r\nXFS_DIR3_DATA_ENTSIZE(1) +\r\nXFS_DIR3_DATA_ENTSIZE(2));\r\n}\r\nstatic struct xfs_dir2_data_entry *\r\nxfs_dir3_data_dot_entry_p(\r\nstruct xfs_dir2_data_hdr *hdr)\r\n{\r\nreturn (struct xfs_dir2_data_entry *)\r\n((char *)hdr + sizeof(struct xfs_dir3_data_hdr));\r\n}\r\nstatic struct xfs_dir2_data_entry *\r\nxfs_dir3_data_dotdot_entry_p(\r\nstruct xfs_dir2_data_hdr *hdr)\r\n{\r\nreturn (struct xfs_dir2_data_entry *)\r\n((char *)hdr + sizeof(struct xfs_dir3_data_hdr) +\r\nXFS_DIR3_DATA_ENTSIZE(1));\r\n}\r\nstatic struct xfs_dir2_data_entry *\r\nxfs_dir3_data_first_entry_p(\r\nstruct xfs_dir2_data_hdr *hdr)\r\n{\r\nreturn (struct xfs_dir2_data_entry *)\r\n((char *)hdr + sizeof(struct xfs_dir3_data_hdr) +\r\nXFS_DIR3_DATA_ENTSIZE(1) +\r\nXFS_DIR3_DATA_ENTSIZE(2));\r\n}\r\nstatic struct xfs_dir2_data_free *\r\nxfs_dir2_data_bestfree_p(struct xfs_dir2_data_hdr *hdr)\r\n{\r\nreturn hdr->bestfree;\r\n}\r\nstatic struct xfs_dir2_data_free *\r\nxfs_dir3_data_bestfree_p(struct xfs_dir2_data_hdr *hdr)\r\n{\r\nreturn ((struct xfs_dir3_data_hdr *)hdr)->best_free;\r\n}\r\nstatic struct xfs_dir2_data_entry *\r\nxfs_dir2_data_entry_p(struct xfs_dir2_data_hdr *hdr)\r\n{\r\nreturn (struct xfs_dir2_data_entry *)\r\n((char *)hdr + sizeof(struct xfs_dir2_data_hdr));\r\n}\r\nstatic struct xfs_dir2_data_unused *\r\nxfs_dir2_data_unused_p(struct xfs_dir2_data_hdr *hdr)\r\n{\r\nreturn (struct xfs_dir2_data_unused *)\r\n((char *)hdr + sizeof(struct xfs_dir2_data_hdr));\r\n}\r\nstatic struct xfs_dir2_data_entry *\r\nxfs_dir3_data_entry_p(struct xfs_dir2_data_hdr *hdr)\r\n{\r\nreturn (struct xfs_dir2_data_entry *)\r\n((char *)hdr + sizeof(struct xfs_dir3_data_hdr));\r\n}\r\nstatic struct xfs_dir2_data_unused *\r\nxfs_dir3_data_unused_p(struct xfs_dir2_data_hdr *hdr)\r\n{\r\nreturn (struct xfs_dir2_data_unused *)\r\n((char *)hdr + sizeof(struct xfs_dir3_data_hdr));\r\n}\r\nstatic int\r\nxfs_dir2_max_leaf_ents(struct xfs_mount *mp)\r\n{\r\nreturn (mp->m_dirblksize - sizeof(struct xfs_dir2_leaf_hdr)) /\r\n(uint)sizeof(struct xfs_dir2_leaf_entry);\r\n}\r\nstatic struct xfs_dir2_leaf_entry *\r\nxfs_dir2_leaf_ents_p(struct xfs_dir2_leaf *lp)\r\n{\r\nreturn lp->__ents;\r\n}\r\nstatic int\r\nxfs_dir3_max_leaf_ents(struct xfs_mount *mp)\r\n{\r\nreturn (mp->m_dirblksize - sizeof(struct xfs_dir3_leaf_hdr)) /\r\n(uint)sizeof(struct xfs_dir2_leaf_entry);\r\n}\r\nstatic struct xfs_dir2_leaf_entry *\r\nxfs_dir3_leaf_ents_p(struct xfs_dir2_leaf *lp)\r\n{\r\nreturn ((struct xfs_dir3_leaf *)lp)->__ents;\r\n}\r\nstatic void\r\nxfs_dir2_leaf_hdr_from_disk(\r\nstruct xfs_dir3_icleaf_hdr *to,\r\nstruct xfs_dir2_leaf *from)\r\n{\r\nto->forw = be32_to_cpu(from->hdr.info.forw);\r\nto->back = be32_to_cpu(from->hdr.info.back);\r\nto->magic = be16_to_cpu(from->hdr.info.magic);\r\nto->count = be16_to_cpu(from->hdr.count);\r\nto->stale = be16_to_cpu(from->hdr.stale);\r\nASSERT(to->magic == XFS_DIR2_LEAF1_MAGIC ||\r\nto->magic == XFS_DIR2_LEAFN_MAGIC);\r\n}\r\nstatic void\r\nxfs_dir2_leaf_hdr_to_disk(\r\nstruct xfs_dir2_leaf *to,\r\nstruct xfs_dir3_icleaf_hdr *from)\r\n{\r\nASSERT(from->magic == XFS_DIR2_LEAF1_MAGIC ||\r\nfrom->magic == XFS_DIR2_LEAFN_MAGIC);\r\nto->hdr.info.forw = cpu_to_be32(from->forw);\r\nto->hdr.info.back = cpu_to_be32(from->back);\r\nto->hdr.info.magic = cpu_to_be16(from->magic);\r\nto->hdr.count = cpu_to_be16(from->count);\r\nto->hdr.stale = cpu_to_be16(from->stale);\r\n}\r\nstatic void\r\nxfs_dir3_leaf_hdr_from_disk(\r\nstruct xfs_dir3_icleaf_hdr *to,\r\nstruct xfs_dir2_leaf *from)\r\n{\r\nstruct xfs_dir3_leaf_hdr *hdr3 = (struct xfs_dir3_leaf_hdr *)from;\r\nto->forw = be32_to_cpu(hdr3->info.hdr.forw);\r\nto->back = be32_to_cpu(hdr3->info.hdr.back);\r\nto->magic = be16_to_cpu(hdr3->info.hdr.magic);\r\nto->count = be16_to_cpu(hdr3->count);\r\nto->stale = be16_to_cpu(hdr3->stale);\r\nASSERT(to->magic == XFS_DIR3_LEAF1_MAGIC ||\r\nto->magic == XFS_DIR3_LEAFN_MAGIC);\r\n}\r\nstatic void\r\nxfs_dir3_leaf_hdr_to_disk(\r\nstruct xfs_dir2_leaf *to,\r\nstruct xfs_dir3_icleaf_hdr *from)\r\n{\r\nstruct xfs_dir3_leaf_hdr *hdr3 = (struct xfs_dir3_leaf_hdr *)to;\r\nASSERT(from->magic == XFS_DIR3_LEAF1_MAGIC ||\r\nfrom->magic == XFS_DIR3_LEAFN_MAGIC);\r\nhdr3->info.hdr.forw = cpu_to_be32(from->forw);\r\nhdr3->info.hdr.back = cpu_to_be32(from->back);\r\nhdr3->info.hdr.magic = cpu_to_be16(from->magic);\r\nhdr3->count = cpu_to_be16(from->count);\r\nhdr3->stale = cpu_to_be16(from->stale);\r\n}\r\nstatic struct xfs_da_node_entry *\r\nxfs_da2_node_tree_p(struct xfs_da_intnode *dap)\r\n{\r\nreturn dap->__btree;\r\n}\r\nstatic struct xfs_da_node_entry *\r\nxfs_da3_node_tree_p(struct xfs_da_intnode *dap)\r\n{\r\nreturn ((struct xfs_da3_intnode *)dap)->__btree;\r\n}\r\nstatic void\r\nxfs_da2_node_hdr_from_disk(\r\nstruct xfs_da3_icnode_hdr *to,\r\nstruct xfs_da_intnode *from)\r\n{\r\nASSERT(from->hdr.info.magic == cpu_to_be16(XFS_DA_NODE_MAGIC));\r\nto->forw = be32_to_cpu(from->hdr.info.forw);\r\nto->back = be32_to_cpu(from->hdr.info.back);\r\nto->magic = be16_to_cpu(from->hdr.info.magic);\r\nto->count = be16_to_cpu(from->hdr.__count);\r\nto->level = be16_to_cpu(from->hdr.__level);\r\n}\r\nstatic void\r\nxfs_da2_node_hdr_to_disk(\r\nstruct xfs_da_intnode *to,\r\nstruct xfs_da3_icnode_hdr *from)\r\n{\r\nASSERT(from->magic == XFS_DA_NODE_MAGIC);\r\nto->hdr.info.forw = cpu_to_be32(from->forw);\r\nto->hdr.info.back = cpu_to_be32(from->back);\r\nto->hdr.info.magic = cpu_to_be16(from->magic);\r\nto->hdr.__count = cpu_to_be16(from->count);\r\nto->hdr.__level = cpu_to_be16(from->level);\r\n}\r\nstatic void\r\nxfs_da3_node_hdr_from_disk(\r\nstruct xfs_da3_icnode_hdr *to,\r\nstruct xfs_da_intnode *from)\r\n{\r\nstruct xfs_da3_node_hdr *hdr3 = (struct xfs_da3_node_hdr *)from;\r\nASSERT(from->hdr.info.magic == cpu_to_be16(XFS_DA3_NODE_MAGIC));\r\nto->forw = be32_to_cpu(hdr3->info.hdr.forw);\r\nto->back = be32_to_cpu(hdr3->info.hdr.back);\r\nto->magic = be16_to_cpu(hdr3->info.hdr.magic);\r\nto->count = be16_to_cpu(hdr3->__count);\r\nto->level = be16_to_cpu(hdr3->__level);\r\n}\r\nstatic void\r\nxfs_da3_node_hdr_to_disk(\r\nstruct xfs_da_intnode *to,\r\nstruct xfs_da3_icnode_hdr *from)\r\n{\r\nstruct xfs_da3_node_hdr *hdr3 = (struct xfs_da3_node_hdr *)to;\r\nASSERT(from->magic == XFS_DA3_NODE_MAGIC);\r\nhdr3->info.hdr.forw = cpu_to_be32(from->forw);\r\nhdr3->info.hdr.back = cpu_to_be32(from->back);\r\nhdr3->info.hdr.magic = cpu_to_be16(from->magic);\r\nhdr3->__count = cpu_to_be16(from->count);\r\nhdr3->__level = cpu_to_be16(from->level);\r\n}\r\nstatic int\r\nxfs_dir2_free_max_bests(struct xfs_mount *mp)\r\n{\r\nreturn (mp->m_dirblksize - sizeof(struct xfs_dir2_free_hdr)) /\r\nsizeof(xfs_dir2_data_off_t);\r\n}\r\nstatic __be16 *\r\nxfs_dir2_free_bests_p(struct xfs_dir2_free *free)\r\n{\r\nreturn (__be16 *)((char *)free + sizeof(struct xfs_dir2_free_hdr));\r\n}\r\nstatic xfs_dir2_db_t\r\nxfs_dir2_db_to_fdb(struct xfs_mount *mp, xfs_dir2_db_t db)\r\n{\r\nreturn XFS_DIR2_FREE_FIRSTDB(mp) + db / xfs_dir2_free_max_bests(mp);\r\n}\r\nstatic int\r\nxfs_dir2_db_to_fdindex(struct xfs_mount *mp, xfs_dir2_db_t db)\r\n{\r\nreturn db % xfs_dir2_free_max_bests(mp);\r\n}\r\nstatic int\r\nxfs_dir3_free_max_bests(struct xfs_mount *mp)\r\n{\r\nreturn (mp->m_dirblksize - sizeof(struct xfs_dir3_free_hdr)) /\r\nsizeof(xfs_dir2_data_off_t);\r\n}\r\nstatic __be16 *\r\nxfs_dir3_free_bests_p(struct xfs_dir2_free *free)\r\n{\r\nreturn (__be16 *)((char *)free + sizeof(struct xfs_dir3_free_hdr));\r\n}\r\nstatic xfs_dir2_db_t\r\nxfs_dir3_db_to_fdb(struct xfs_mount *mp, xfs_dir2_db_t db)\r\n{\r\nreturn XFS_DIR2_FREE_FIRSTDB(mp) + db / xfs_dir3_free_max_bests(mp);\r\n}\r\nstatic int\r\nxfs_dir3_db_to_fdindex(struct xfs_mount *mp, xfs_dir2_db_t db)\r\n{\r\nreturn db % xfs_dir3_free_max_bests(mp);\r\n}\r\nstatic void\r\nxfs_dir2_free_hdr_from_disk(\r\nstruct xfs_dir3_icfree_hdr *to,\r\nstruct xfs_dir2_free *from)\r\n{\r\nto->magic = be32_to_cpu(from->hdr.magic);\r\nto->firstdb = be32_to_cpu(from->hdr.firstdb);\r\nto->nvalid = be32_to_cpu(from->hdr.nvalid);\r\nto->nused = be32_to_cpu(from->hdr.nused);\r\nASSERT(to->magic == XFS_DIR2_FREE_MAGIC);\r\n}\r\nstatic void\r\nxfs_dir2_free_hdr_to_disk(\r\nstruct xfs_dir2_free *to,\r\nstruct xfs_dir3_icfree_hdr *from)\r\n{\r\nASSERT(from->magic == XFS_DIR2_FREE_MAGIC);\r\nto->hdr.magic = cpu_to_be32(from->magic);\r\nto->hdr.firstdb = cpu_to_be32(from->firstdb);\r\nto->hdr.nvalid = cpu_to_be32(from->nvalid);\r\nto->hdr.nused = cpu_to_be32(from->nused);\r\n}\r\nstatic void\r\nxfs_dir3_free_hdr_from_disk(\r\nstruct xfs_dir3_icfree_hdr *to,\r\nstruct xfs_dir2_free *from)\r\n{\r\nstruct xfs_dir3_free_hdr *hdr3 = (struct xfs_dir3_free_hdr *)from;\r\nto->magic = be32_to_cpu(hdr3->hdr.magic);\r\nto->firstdb = be32_to_cpu(hdr3->firstdb);\r\nto->nvalid = be32_to_cpu(hdr3->nvalid);\r\nto->nused = be32_to_cpu(hdr3->nused);\r\nASSERT(to->magic == XFS_DIR3_FREE_MAGIC);\r\n}\r\nstatic void\r\nxfs_dir3_free_hdr_to_disk(\r\nstruct xfs_dir2_free *to,\r\nstruct xfs_dir3_icfree_hdr *from)\r\n{\r\nstruct xfs_dir3_free_hdr *hdr3 = (struct xfs_dir3_free_hdr *)to;\r\nASSERT(from->magic == XFS_DIR3_FREE_MAGIC);\r\nhdr3->hdr.magic = cpu_to_be32(from->magic);\r\nhdr3->firstdb = cpu_to_be32(from->firstdb);\r\nhdr3->nvalid = cpu_to_be32(from->nvalid);\r\nhdr3->nused = cpu_to_be32(from->nused);\r\n}\r\nconst struct xfs_dir_ops *\r\nxfs_dir_get_ops(\r\nstruct xfs_mount *mp,\r\nstruct xfs_inode *dp)\r\n{\r\nif (dp)\r\nreturn dp->d_ops;\r\nif (mp->m_dir_inode_ops)\r\nreturn mp->m_dir_inode_ops;\r\nif (xfs_sb_version_hascrc(&mp->m_sb))\r\nreturn &xfs_dir3_ops;\r\nif (xfs_sb_version_hasftype(&mp->m_sb))\r\nreturn &xfs_dir2_ftype_ops;\r\nreturn &xfs_dir2_ops;\r\n}\r\nconst struct xfs_dir_ops *\r\nxfs_nondir_get_ops(\r\nstruct xfs_mount *mp,\r\nstruct xfs_inode *dp)\r\n{\r\nif (dp)\r\nreturn dp->d_ops;\r\nif (mp->m_nondir_inode_ops)\r\nreturn mp->m_nondir_inode_ops;\r\nif (xfs_sb_version_hascrc(&mp->m_sb))\r\nreturn &xfs_dir3_nondir_ops;\r\nreturn &xfs_dir2_nondir_ops;\r\n}

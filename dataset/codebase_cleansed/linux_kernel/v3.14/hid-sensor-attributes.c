static int pow_10(unsigned power)\r\n{\r\nint i;\r\nint ret = 1;\r\nfor (i = 0; i < power; ++i)\r\nret = ret * 10;\r\nreturn ret;\r\n}\r\nstatic void simple_div(int dividend, int divisor, int *whole,\r\nint *micro_frac)\r\n{\r\nint rem;\r\nint exp = 0;\r\n*micro_frac = 0;\r\nif (divisor == 0) {\r\n*whole = 0;\r\nreturn;\r\n}\r\n*whole = dividend/divisor;\r\nrem = dividend % divisor;\r\nif (rem) {\r\nwhile (rem <= divisor) {\r\nrem *= 10;\r\nexp++;\r\n}\r\n*micro_frac = (rem / divisor) * pow_10(6-exp);\r\n}\r\n}\r\nstatic void split_micro_fraction(unsigned int no, int exp, int *val1, int *val2)\r\n{\r\n*val1 = no/pow_10(exp);\r\n*val2 = no%pow_10(exp) * pow_10(6-exp);\r\n}\r\nstatic void convert_from_vtf_format(u32 value, int size, int exp,\r\nint *val1, int *val2)\r\n{\r\nint sign = 1;\r\nif (value & BIT(size*8 - 1)) {\r\nvalue = ((1LL << (size * 8)) - value);\r\nsign = -1;\r\n}\r\nexp = hid_sensor_convert_exponent(exp);\r\nif (exp >= 0) {\r\n*val1 = sign * value * pow_10(exp);\r\n*val2 = 0;\r\n} else {\r\nsplit_micro_fraction(value, -exp, val1, val2);\r\nif (*val1)\r\n*val1 = sign * (*val1);\r\nelse\r\n*val2 = sign * (*val2);\r\n}\r\n}\r\nstatic u32 convert_to_vtf_format(int size, int exp, int val1, int val2)\r\n{\r\nu32 value;\r\nint sign = 1;\r\nif (val1 < 0 || val2 < 0)\r\nsign = -1;\r\nexp = hid_sensor_convert_exponent(exp);\r\nif (exp < 0) {\r\nvalue = abs(val1) * pow_10(-exp);\r\nvalue += abs(val2) / pow_10(6+exp);\r\n} else\r\nvalue = abs(val1) / pow_10(exp);\r\nif (sign < 0)\r\nvalue = ((1LL << (size * 8)) - value);\r\nreturn value;\r\n}\r\nint hid_sensor_read_samp_freq_value(struct hid_sensor_common *st,\r\nint *val1, int *val2)\r\n{\r\ns32 value;\r\nint ret;\r\nret = sensor_hub_get_feature(st->hsdev,\r\nst->poll.report_id,\r\nst->poll.index, &value);\r\nif (ret < 0 || value < 0) {\r\n*val1 = *val2 = 0;\r\nreturn -EINVAL;\r\n} else {\r\nif (st->poll.units == HID_USAGE_SENSOR_UNITS_MILLISECOND)\r\nsimple_div(1000, value, val1, val2);\r\nelse if (st->poll.units == HID_USAGE_SENSOR_UNITS_SECOND)\r\nsimple_div(1, value, val1, val2);\r\nelse {\r\n*val1 = *val2 = 0;\r\nreturn -EINVAL;\r\n}\r\n}\r\nreturn IIO_VAL_INT_PLUS_MICRO;\r\n}\r\nint hid_sensor_write_samp_freq_value(struct hid_sensor_common *st,\r\nint val1, int val2)\r\n{\r\ns32 value;\r\nint ret;\r\nif (val1 < 0 || val2 < 0)\r\nret = -EINVAL;\r\nvalue = val1 * pow_10(6) + val2;\r\nif (value) {\r\nif (st->poll.units == HID_USAGE_SENSOR_UNITS_MILLISECOND)\r\nvalue = pow_10(9)/value;\r\nelse if (st->poll.units == HID_USAGE_SENSOR_UNITS_SECOND)\r\nvalue = pow_10(6)/value;\r\nelse\r\nvalue = 0;\r\n}\r\nret = sensor_hub_set_feature(st->hsdev,\r\nst->poll.report_id,\r\nst->poll.index, value);\r\nif (ret < 0 || value < 0)\r\nret = -EINVAL;\r\nreturn ret;\r\n}\r\nint hid_sensor_read_raw_hyst_value(struct hid_sensor_common *st,\r\nint *val1, int *val2)\r\n{\r\ns32 value;\r\nint ret;\r\nret = sensor_hub_get_feature(st->hsdev,\r\nst->sensitivity.report_id,\r\nst->sensitivity.index, &value);\r\nif (ret < 0 || value < 0) {\r\n*val1 = *val2 = 0;\r\nreturn -EINVAL;\r\n} else {\r\nconvert_from_vtf_format(value, st->sensitivity.size,\r\nst->sensitivity.unit_expo,\r\nval1, val2);\r\n}\r\nreturn IIO_VAL_INT_PLUS_MICRO;\r\n}\r\nint hid_sensor_write_raw_hyst_value(struct hid_sensor_common *st,\r\nint val1, int val2)\r\n{\r\ns32 value;\r\nint ret;\r\nvalue = convert_to_vtf_format(st->sensitivity.size,\r\nst->sensitivity.unit_expo,\r\nval1, val2);\r\nret = sensor_hub_set_feature(st->hsdev,\r\nst->sensitivity.report_id,\r\nst->sensitivity.index, value);\r\nif (ret < 0 || value < 0)\r\nret = -EINVAL;\r\nreturn ret;\r\n}\r\nint hid_sensor_parse_common_attributes(struct hid_sensor_hub_device *hsdev,\r\nu32 usage_id,\r\nstruct hid_sensor_common *st)\r\n{\r\nsensor_hub_input_get_attribute_info(hsdev,\r\nHID_FEATURE_REPORT, usage_id,\r\nHID_USAGE_SENSOR_PROP_REPORT_INTERVAL,\r\n&st->poll);\r\nsensor_hub_input_get_attribute_info(hsdev,\r\nHID_FEATURE_REPORT, usage_id,\r\nHID_USAGE_SENSOR_PROP_REPORT_STATE,\r\n&st->report_state);\r\nsensor_hub_input_get_attribute_info(hsdev,\r\nHID_FEATURE_REPORT, usage_id,\r\nHID_USAGE_SENSOR_PROY_POWER_STATE,\r\n&st->power_state);\r\nsensor_hub_input_get_attribute_info(hsdev,\r\nHID_FEATURE_REPORT, usage_id,\r\nHID_USAGE_SENSOR_PROP_SENSITIVITY_ABS,\r\n&st->sensitivity);\r\nhid_dbg(hsdev->hdev, "common attributes: %x:%x, %x:%x, %x:%x %x:%x\n",\r\nst->poll.index, st->poll.report_id,\r\nst->report_state.index, st->report_state.report_id,\r\nst->power_state.index, st->power_state.report_id,\r\nst->sensitivity.index, st->sensitivity.report_id);\r\nreturn 0;\r\n}

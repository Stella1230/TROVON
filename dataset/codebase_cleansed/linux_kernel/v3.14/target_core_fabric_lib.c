u8 sas_get_fabric_proto_ident(struct se_portal_group *se_tpg)\r\n{\r\nreturn 0x6;\r\n}\r\nu32 sas_get_pr_transport_id(\r\nstruct se_portal_group *se_tpg,\r\nstruct se_node_acl *se_nacl,\r\nstruct t10_pr_registration *pr_reg,\r\nint *format_code,\r\nunsigned char *buf)\r\n{\r\nunsigned char *ptr;\r\nint ret;\r\nbuf[0] = 0x06;\r\nptr = &se_nacl->initiatorname[4];\r\nret = hex2bin(&buf[4], ptr, 8);\r\nif (ret < 0)\r\npr_debug("sas transport_id: invalid hex string\n");\r\nreturn 24;\r\n}\r\nu32 sas_get_pr_transport_id_len(\r\nstruct se_portal_group *se_tpg,\r\nstruct se_node_acl *se_nacl,\r\nstruct t10_pr_registration *pr_reg,\r\nint *format_code)\r\n{\r\n*format_code = 0;\r\nreturn 24;\r\n}\r\nchar *sas_parse_pr_out_transport_id(\r\nstruct se_portal_group *se_tpg,\r\nconst char *buf,\r\nu32 *out_tid_len,\r\nchar **port_nexus_ptr)\r\n{\r\n*port_nexus_ptr = NULL;\r\n*out_tid_len = 24;\r\nreturn (char *)&buf[4];\r\n}\r\nu8 fc_get_fabric_proto_ident(struct se_portal_group *se_tpg)\r\n{\r\nreturn 0x0;\r\n}\r\nu32 fc_get_pr_transport_id_len(\r\nstruct se_portal_group *se_tpg,\r\nstruct se_node_acl *se_nacl,\r\nstruct t10_pr_registration *pr_reg,\r\nint *format_code)\r\n{\r\n*format_code = 0;\r\nreturn 24;\r\n}\r\nu32 fc_get_pr_transport_id(\r\nstruct se_portal_group *se_tpg,\r\nstruct se_node_acl *se_nacl,\r\nstruct t10_pr_registration *pr_reg,\r\nint *format_code,\r\nunsigned char *buf)\r\n{\r\nunsigned char *ptr;\r\nint i, ret;\r\nu32 off = 8;\r\nptr = &se_nacl->initiatorname[0];\r\nfor (i = 0; i < 24; ) {\r\nif (!strncmp(&ptr[i], ":", 1)) {\r\ni++;\r\ncontinue;\r\n}\r\nret = hex2bin(&buf[off++], &ptr[i], 1);\r\nif (ret < 0)\r\npr_debug("fc transport_id: invalid hex string\n");\r\ni += 2;\r\n}\r\nreturn 24;\r\n}\r\nchar *fc_parse_pr_out_transport_id(\r\nstruct se_portal_group *se_tpg,\r\nconst char *buf,\r\nu32 *out_tid_len,\r\nchar **port_nexus_ptr)\r\n{\r\n*port_nexus_ptr = NULL;\r\n*out_tid_len = 24;\r\nreturn (char *)&buf[8];\r\n}\r\nu8 iscsi_get_fabric_proto_ident(struct se_portal_group *se_tpg)\r\n{\r\nreturn 0x5;\r\n}\r\nu32 iscsi_get_pr_transport_id(\r\nstruct se_portal_group *se_tpg,\r\nstruct se_node_acl *se_nacl,\r\nstruct t10_pr_registration *pr_reg,\r\nint *format_code,\r\nunsigned char *buf)\r\n{\r\nu32 off = 4, padding = 0;\r\nu16 len = 0;\r\nspin_lock_irq(&se_nacl->nacl_sess_lock);\r\nbuf[0] = 0x05;\r\nlen = sprintf(&buf[off], "%s", se_nacl->initiatorname);\r\nlen++;\r\nif ((*format_code == 1) && (pr_reg->isid_present_at_reg)) {\r\nbuf[0] |= 0x40;\r\nbuf[off+len] = 0x2c; off++;\r\nbuf[off+len] = 0x69; off++;\r\nbuf[off+len] = 0x2c; off++;\r\nbuf[off+len] = 0x30; off++;\r\nbuf[off+len] = 0x78; off++;\r\nlen += 5;\r\nbuf[off+len] = pr_reg->pr_reg_isid[0]; off++;\r\nbuf[off+len] = pr_reg->pr_reg_isid[1]; off++;\r\nbuf[off+len] = pr_reg->pr_reg_isid[2]; off++;\r\nbuf[off+len] = pr_reg->pr_reg_isid[3]; off++;\r\nbuf[off+len] = pr_reg->pr_reg_isid[4]; off++;\r\nbuf[off+len] = pr_reg->pr_reg_isid[5]; off++;\r\nbuf[off+len] = '\0'; off++;\r\nlen += 7;\r\n}\r\nspin_unlock_irq(&se_nacl->nacl_sess_lock);\r\npadding = ((-len) & 3);\r\nif (padding != 0)\r\nlen += padding;\r\nbuf[2] = ((len >> 8) & 0xff);\r\nbuf[3] = (len & 0xff);\r\nlen += 4;\r\nreturn len;\r\n}\r\nu32 iscsi_get_pr_transport_id_len(\r\nstruct se_portal_group *se_tpg,\r\nstruct se_node_acl *se_nacl,\r\nstruct t10_pr_registration *pr_reg,\r\nint *format_code)\r\n{\r\nu32 len = 0, padding = 0;\r\nspin_lock_irq(&se_nacl->nacl_sess_lock);\r\nlen = strlen(se_nacl->initiatorname);\r\nlen++;\r\nif (pr_reg->isid_present_at_reg) {\r\nlen += 5;\r\nlen += 7;\r\n*format_code = 1;\r\n} else\r\n*format_code = 0;\r\nspin_unlock_irq(&se_nacl->nacl_sess_lock);\r\npadding = ((-len) & 3);\r\nif (padding != 0)\r\nlen += padding;\r\nlen += 4;\r\nreturn len;\r\n}\r\nchar *iscsi_parse_pr_out_transport_id(\r\nstruct se_portal_group *se_tpg,\r\nconst char *buf,\r\nu32 *out_tid_len,\r\nchar **port_nexus_ptr)\r\n{\r\nchar *p;\r\nu32 tid_len, padding;\r\nint i;\r\nu16 add_len;\r\nu8 format_code = (buf[0] & 0xc0);\r\nif ((format_code != 0x00) && (format_code != 0x40)) {\r\npr_err("Illegal format code: 0x%02x for iSCSI"\r\n" Initiator Transport ID\n", format_code);\r\nreturn NULL;\r\n}\r\nif (out_tid_len != NULL) {\r\nadd_len = ((buf[2] >> 8) & 0xff);\r\nadd_len |= (buf[3] & 0xff);\r\ntid_len = strlen(&buf[4]);\r\ntid_len += 4;\r\ntid_len += 1;\r\npadding = ((-tid_len) & 3);\r\nif (padding != 0)\r\ntid_len += padding;\r\nif ((add_len + 4) != tid_len) {\r\npr_debug("LIO-Target Extracted add_len: %hu "\r\n"does not match calculated tid_len: %u,"\r\n" using tid_len instead\n", add_len+4, tid_len);\r\n*out_tid_len = tid_len;\r\n} else\r\n*out_tid_len = (add_len + 4);\r\n}\r\nif (format_code == 0x40) {\r\np = strstr(&buf[4], ",i,0x");\r\nif (!p) {\r\npr_err("Unable to locate \",i,0x\" separator"\r\n" for Initiator port identifier: %s\n",\r\n&buf[4]);\r\nreturn NULL;\r\n}\r\n*p = '\0';\r\np += 5;\r\n*port_nexus_ptr = p;\r\nfor (i = 0; i < 12; i++) {\r\nif (isdigit(*p)) {\r\np++;\r\ncontinue;\r\n}\r\n*p = tolower(*p);\r\np++;\r\n}\r\n}\r\nreturn (char *)&buf[4];\r\n}

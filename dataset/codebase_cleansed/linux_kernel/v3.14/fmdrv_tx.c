int fm_tx_set_stereo_mono(struct fmdev *fmdev, u16 mode)\r\n{\r\nu16 payload;\r\nint ret;\r\nif (fmdev->tx_data.aud_mode == mode)\r\nreturn 0;\r\nfmdbg("stereo mode: %d\n", mode);\r\npayload = (1 - mode);\r\nret = fmc_send_cmd(fmdev, MONO_SET, REG_WR, &payload,\r\nsizeof(payload), NULL, NULL);\r\nif (ret < 0)\r\nreturn ret;\r\nfmdev->tx_data.aud_mode = mode;\r\nreturn ret;\r\n}\r\nstatic int set_rds_text(struct fmdev *fmdev, u8 *rds_text)\r\n{\r\nu16 payload;\r\nint ret;\r\nret = fmc_send_cmd(fmdev, RDS_DATA_SET, REG_WR, rds_text,\r\nstrlen(rds_text), NULL, NULL);\r\nif (ret < 0)\r\nreturn ret;\r\npayload = (u16)0x1;\r\nret = fmc_send_cmd(fmdev, DISPLAY_MODE, REG_WR, &payload,\r\nsizeof(payload), NULL, NULL);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int set_rds_data_mode(struct fmdev *fmdev, u8 mode)\r\n{\r\nu16 payload;\r\nint ret;\r\npayload = (u16)0xcafe;\r\nret = fmc_send_cmd(fmdev, PI_SET, REG_WR, &payload,\r\nsizeof(payload), NULL, NULL);\r\nif (ret < 0)\r\nreturn ret;\r\npayload = (u16)0xa;\r\nret = fmc_send_cmd(fmdev, DI_SET, REG_WR, &payload,\r\nsizeof(payload), NULL, NULL);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int set_rds_len(struct fmdev *fmdev, u8 type, u16 len)\r\n{\r\nu16 payload;\r\nint ret;\r\nlen |= type << 8;\r\npayload = len;\r\nret = fmc_send_cmd(fmdev, RDS_CONFIG_DATA_SET, REG_WR, &payload,\r\nsizeof(payload), NULL, NULL);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nint fm_tx_set_rds_mode(struct fmdev *fmdev, u8 rds_en_dis)\r\n{\r\nu16 payload;\r\nint ret;\r\nu8 rds_text[] = "Zoom2\n";\r\nfmdbg("rds_en_dis:%d(E:%d, D:%d)\n", rds_en_dis,\r\nFM_RDS_ENABLE, FM_RDS_DISABLE);\r\nif (rds_en_dis == FM_RDS_ENABLE) {\r\nset_rds_len(fmdev, 0, strlen(rds_text));\r\nset_rds_text(fmdev, rds_text);\r\nset_rds_data_mode(fmdev, 0x0);\r\n}\r\nif (rds_en_dis == FM_RDS_ENABLE)\r\npayload = 0x01;\r\nelse\r\npayload = 0x00;\r\nret = fmc_send_cmd(fmdev, RDS_DATA_ENB, REG_WR, &payload,\r\nsizeof(payload), NULL, NULL);\r\nif (ret < 0)\r\nreturn ret;\r\nif (rds_en_dis == FM_RDS_ENABLE) {\r\nset_rds_len(fmdev, 0, strlen(rds_text));\r\nset_rds_text(fmdev, rds_text);\r\n}\r\nfmdev->tx_data.rds.flag = rds_en_dis;\r\nreturn 0;\r\n}\r\nint fm_tx_set_radio_text(struct fmdev *fmdev, u8 *rds_text, u8 rds_type)\r\n{\r\nu16 payload;\r\nint ret;\r\nif (fmdev->curr_fmmode != FM_MODE_TX)\r\nreturn -EPERM;\r\nfm_tx_set_rds_mode(fmdev, 0);\r\nset_rds_len(fmdev, rds_type, strlen(rds_text));\r\nset_rds_text(fmdev, rds_text);\r\nset_rds_data_mode(fmdev, 0x0);\r\npayload = 1;\r\nret = fmc_send_cmd(fmdev, RDS_DATA_ENB, REG_WR, &payload,\r\nsizeof(payload), NULL, NULL);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nint fm_tx_set_af(struct fmdev *fmdev, u32 af)\r\n{\r\nu16 payload;\r\nint ret;\r\nif (fmdev->curr_fmmode != FM_MODE_TX)\r\nreturn -EPERM;\r\nfmdbg("AF: %d\n", af);\r\naf = (af - 87500) / 100;\r\npayload = (u16)af;\r\nret = fmc_send_cmd(fmdev, TA_SET, REG_WR, &payload,\r\nsizeof(payload), NULL, NULL);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nint fm_tx_set_region(struct fmdev *fmdev, u8 region)\r\n{\r\nu16 payload;\r\nint ret;\r\nif (region != FM_BAND_EUROPE_US && region != FM_BAND_JAPAN) {\r\nfmerr("Invalid band\n");\r\nreturn -EINVAL;\r\n}\r\npayload = (u16)region;\r\nret = fmc_send_cmd(fmdev, TX_BAND_SET, REG_WR, &payload,\r\nsizeof(payload), NULL, NULL);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nint fm_tx_set_mute_mode(struct fmdev *fmdev, u8 mute_mode_toset)\r\n{\r\nu16 payload;\r\nint ret;\r\nfmdbg("tx: mute mode %d\n", mute_mode_toset);\r\npayload = mute_mode_toset;\r\nret = fmc_send_cmd(fmdev, MUTE, REG_WR, &payload,\r\nsizeof(payload), NULL, NULL);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int set_audio_io(struct fmdev *fmdev)\r\n{\r\nstruct fmtx_data *tx = &fmdev->tx_data;\r\nu16 payload;\r\nint ret;\r\npayload = tx->audio_io;\r\nret = fmc_send_cmd(fmdev, AUDIO_IO_SET, REG_WR, &payload,\r\nsizeof(payload), NULL, NULL);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int enable_xmit(struct fmdev *fmdev, u8 new_xmit_state)\r\n{\r\nstruct fmtx_data *tx = &fmdev->tx_data;\r\nunsigned long timeleft;\r\nu16 payload;\r\nint ret;\r\npayload = FM_POW_ENB_EVENT;\r\nret = fmc_send_cmd(fmdev, INT_MASK_SET, REG_WR, &payload,\r\nsizeof(payload), NULL, NULL);\r\nif (ret < 0)\r\nreturn ret;\r\npayload = new_xmit_state;\r\nret = fmc_send_cmd(fmdev, POWER_ENB_SET, REG_WR, &payload,\r\nsizeof(payload), NULL, NULL);\r\nif (ret < 0)\r\nreturn ret;\r\ninit_completion(&fmdev->maintask_comp);\r\ntimeleft = wait_for_completion_timeout(&fmdev->maintask_comp,\r\nFM_DRV_TX_TIMEOUT);\r\nif (!timeleft) {\r\nfmerr("Timeout(%d sec),didn't get tune ended interrupt\n",\r\njiffies_to_msecs(FM_DRV_TX_TIMEOUT) / 1000);\r\nreturn -ETIMEDOUT;\r\n}\r\nset_bit(FM_CORE_TX_XMITING, &fmdev->flag);\r\ntx->xmit_state = new_xmit_state;\r\nreturn 0;\r\n}\r\nint fm_tx_set_pwr_lvl(struct fmdev *fmdev, u8 new_pwr_lvl)\r\n{\r\nu16 payload;\r\nstruct fmtx_data *tx = &fmdev->tx_data;\r\nint ret;\r\nif (fmdev->curr_fmmode != FM_MODE_TX)\r\nreturn -EPERM;\r\nfmdbg("tx: pwr_level_to_set %ld\n", (long int)new_pwr_lvl);\r\nif (!test_bit(FM_CORE_READY, &fmdev->flag)) {\r\ntx->pwr_lvl = new_pwr_lvl;\r\nreturn 0;\r\n}\r\npayload = (FM_PWR_LVL_HIGH - new_pwr_lvl);\r\nret = fmc_send_cmd(fmdev, POWER_LEV_SET, REG_WR, &payload,\r\nsizeof(payload), NULL, NULL);\r\nif (ret < 0)\r\nreturn ret;\r\ntx->pwr_lvl = new_pwr_lvl;\r\nreturn 0;\r\n}\r\nint fm_tx_set_preemph_filter(struct fmdev *fmdev, u32 preemphasis)\r\n{\r\nstruct fmtx_data *tx = &fmdev->tx_data;\r\nu16 payload;\r\nint ret;\r\nif (fmdev->curr_fmmode != FM_MODE_TX)\r\nreturn -EPERM;\r\nswitch (preemphasis) {\r\ncase V4L2_PREEMPHASIS_DISABLED:\r\npayload = FM_TX_PREEMPH_OFF;\r\nbreak;\r\ncase V4L2_PREEMPHASIS_50_uS:\r\npayload = FM_TX_PREEMPH_50US;\r\nbreak;\r\ncase V4L2_PREEMPHASIS_75_uS:\r\npayload = FM_TX_PREEMPH_75US;\r\nbreak;\r\n}\r\nret = fmc_send_cmd(fmdev, PREMPH_SET, REG_WR, &payload,\r\nsizeof(payload), NULL, NULL);\r\nif (ret < 0)\r\nreturn ret;\r\ntx->preemph = payload;\r\nreturn ret;\r\n}\r\nint fm_tx_get_tune_cap_val(struct fmdev *fmdev)\r\n{\r\nu16 curr_val;\r\nu32 resp_len;\r\nint ret;\r\nif (fmdev->curr_fmmode != FM_MODE_TX)\r\nreturn -EPERM;\r\nret = fmc_send_cmd(fmdev, READ_FMANT_TUNE_VALUE, REG_RD,\r\nNULL, sizeof(curr_val), &curr_val, &resp_len);\r\nif (ret < 0)\r\nreturn ret;\r\ncurr_val = be16_to_cpu(curr_val);\r\nreturn curr_val;\r\n}\r\nint fm_tx_set_freq(struct fmdev *fmdev, u32 freq_to_set)\r\n{\r\nstruct fmtx_data *tx = &fmdev->tx_data;\r\nu16 payload, chanl_index;\r\nint ret;\r\nif (test_bit(FM_CORE_TX_XMITING, &fmdev->flag)) {\r\nenable_xmit(fmdev, 0);\r\nclear_bit(FM_CORE_TX_XMITING, &fmdev->flag);\r\n}\r\npayload = (FM_FR_EVENT | FM_BL_EVENT);\r\nret = fmc_send_cmd(fmdev, INT_MASK_SET, REG_WR, &payload,\r\nsizeof(payload), NULL, NULL);\r\nif (ret < 0)\r\nreturn ret;\r\ntx->tx_frq = (unsigned long)freq_to_set;\r\nfmdbg("tx: freq_to_set %ld\n", (long int)tx->tx_frq);\r\nchanl_index = freq_to_set / 10;\r\npayload = chanl_index;\r\nret = fmc_send_cmd(fmdev, CHANL_SET, REG_WR, &payload,\r\nsizeof(payload), NULL, NULL);\r\nif (ret < 0)\r\nreturn ret;\r\nfm_tx_set_pwr_lvl(fmdev, tx->pwr_lvl);\r\nfm_tx_set_preemph_filter(fmdev, tx->preemph);\r\ntx->audio_io = 0x01;\r\nset_audio_io(fmdev);\r\nenable_xmit(fmdev, 0x01);\r\ntx->aud_mode = FM_STEREO_MODE;\r\ntx->rds.flag = FM_RDS_DISABLE;\r\nreturn 0;\r\n}

static inline void dsp_save_state(u32 *state)\r\n{\r\n__asm__ __volatile__ (\r\n"mrrc p0, 0, %0, %1, c0\n"\r\n: "=r" (state[0]), "=r" (state[1]));\r\n}\r\nstatic inline void dsp_load_state(u32 *state)\r\n{\r\n__asm__ __volatile__ (\r\n"mcrr p0, 0, %0, %1, c0\n"\r\n: : "r" (state[0]), "r" (state[1]));\r\n}\r\nstatic int dsp_do(struct notifier_block *self, unsigned long cmd, void *t)\r\n{\r\nstruct thread_info *thread = t;\r\nswitch (cmd) {\r\ncase THREAD_NOTIFY_FLUSH:\r\nthread->cpu_context.extra[0] = 0;\r\nthread->cpu_context.extra[1] = 0;\r\nbreak;\r\ncase THREAD_NOTIFY_SWITCH:\r\ndsp_save_state(current_thread_info()->cpu_context.extra);\r\ndsp_load_state(thread->cpu_context.extra);\r\nbreak;\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int iwmmxt_do(struct notifier_block *self, unsigned long cmd, void *t)\r\n{\r\nstruct thread_info *thread = t;\r\nswitch (cmd) {\r\ncase THREAD_NOTIFY_FLUSH:\r\ncase THREAD_NOTIFY_EXIT:\r\niwmmxt_task_release(thread);\r\nbreak;\r\ncase THREAD_NOTIFY_SWITCH:\r\niwmmxt_task_switch(thread);\r\nbreak;\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic u32 __init xscale_cp_access_read(void)\r\n{\r\nu32 value;\r\n__asm__ __volatile__ (\r\n"mrc p15, 0, %0, c15, c1, 0\n\t"\r\n: "=r" (value));\r\nreturn value;\r\n}\r\nstatic void __init xscale_cp_access_write(u32 value)\r\n{\r\nu32 temp;\r\n__asm__ __volatile__ (\r\n"mcr p15, 0, %1, c15, c1, 0\n\t"\r\n"mrc p15, 0, %0, c15, c1, 0\n\t"\r\n"mov %0, %0\n\t"\r\n"sub pc, pc, #4\n\t"\r\n: "=r" (temp) : "r" (value));\r\n}\r\nstatic int __init cpu_has_iwmmxt(void)\r\n{\r\nu32 lo;\r\nu32 hi;\r\n__asm__ __volatile__ (\r\n"mcrr p0, 0, %2, %3, c0\n"\r\n"mrrc p0, 0, %0, %1, c0\n"\r\n: "=r" (lo), "=r" (hi)\r\n: "r" (0), "r" (0x100));\r\nreturn !!hi;\r\n}\r\nstatic int __init xscale_cp0_init(void)\r\n{\r\nu32 cp_access;\r\ncp_access = xscale_cp_access_read() & ~3;\r\nxscale_cp_access_write(cp_access | 1);\r\nif (cpu_has_iwmmxt()) {\r\n#ifndef CONFIG_IWMMXT\r\nprintk(KERN_WARNING "CAUTION: XScale iWMMXt coprocessor "\r\n"detected, but kernel support is missing.\n");\r\n#else\r\nprintk(KERN_INFO "XScale iWMMXt coprocessor detected.\n");\r\nelf_hwcap |= HWCAP_IWMMXT;\r\nthread_register_notifier(&iwmmxt_notifier_block);\r\n#endif\r\n} else {\r\nprintk(KERN_INFO "XScale DSP coprocessor detected.\n");\r\nthread_register_notifier(&dsp_notifier_block);\r\ncp_access |= 1;\r\n}\r\nxscale_cp_access_write(cp_access);\r\nreturn 0;\r\n}

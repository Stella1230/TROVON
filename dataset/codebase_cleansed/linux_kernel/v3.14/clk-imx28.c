int mxs_saif_clkmux_select(unsigned int clkmux)\r\n{\r\nif (clkmux > 0x3)\r\nreturn -EINVAL;\r\nwritel_relaxed(0x3 << BP_SAIF_CLKMUX, DIGCTRL + CLR);\r\nwritel_relaxed(clkmux << BP_SAIF_CLKMUX, DIGCTRL + SET);\r\nreturn 0;\r\n}\r\nstatic void __init clk_misc_init(void)\r\n{\r\nu32 val;\r\nwritel_relaxed(1 << BP_CPU_INTERRUPT_WAIT, CPU + SET);\r\nwritel_relaxed(1 << BP_ENET_DIV_TIME, ENET + SET);\r\nwritel_relaxed(0x3 << BP_CLKSEQ_BYPASS_SAIF0, CLKSEQ + CLR);\r\nval = readl_relaxed(SAIF0);\r\nval |= 1 << BP_SAIF_DIV_FRAC_EN;\r\nwritel_relaxed(val, SAIF0);\r\nval = readl_relaxed(SAIF1);\r\nval |= 1 << BP_SAIF_DIV_FRAC_EN;\r\nwritel_relaxed(val, SAIF1);\r\nval = readl_relaxed(ENET);\r\nval &= ~(1 << BP_ENET_SLEEP);\r\nwritel_relaxed(val, ENET);\r\nwritel_relaxed(0xf << BP_CLKSEQ_BYPASS_SSP0, CLKSEQ + CLR);\r\nval = readl_relaxed(FRAC0);\r\nval &= ~((0x3f << BP_FRAC0_IO0FRAC) | (0x3f << BP_FRAC0_IO1FRAC));\r\nval |= (30 << BP_FRAC0_IO0FRAC) | (30 << BP_FRAC0_IO1FRAC);\r\nwritel_relaxed(val, FRAC0);\r\n}\r\nstatic void __init mx28_clocks_init(struct device_node *np)\r\n{\r\nstruct device_node *dcnp;\r\nu32 i;\r\ndcnp = of_find_compatible_node(NULL, NULL, "fsl,imx28-digctl");\r\ndigctrl = of_iomap(dcnp, 0);\r\nWARN_ON(!digctrl);\r\nof_node_put(dcnp);\r\nclkctrl = of_iomap(np, 0);\r\nWARN_ON(!clkctrl);\r\nclk_misc_init();\r\nclks[ref_xtal] = mxs_clk_fixed("ref_xtal", 24000000);\r\nclks[pll0] = mxs_clk_pll("pll0", "ref_xtal", PLL0CTRL0, 17, 480000000);\r\nclks[pll1] = mxs_clk_pll("pll1", "ref_xtal", PLL1CTRL0, 17, 480000000);\r\nclks[pll2] = mxs_clk_pll("pll2", "ref_xtal", PLL2CTRL0, 23, 50000000);\r\nclks[ref_cpu] = mxs_clk_ref("ref_cpu", "pll0", FRAC0, 0);\r\nclks[ref_emi] = mxs_clk_ref("ref_emi", "pll0", FRAC0, 1);\r\nclks[ref_io1] = mxs_clk_ref("ref_io1", "pll0", FRAC0, 2);\r\nclks[ref_io0] = mxs_clk_ref("ref_io0", "pll0", FRAC0, 3);\r\nclks[ref_pix] = mxs_clk_ref("ref_pix", "pll0", FRAC1, 0);\r\nclks[ref_hsadc] = mxs_clk_ref("ref_hsadc", "pll0", FRAC1, 1);\r\nclks[ref_gpmi] = mxs_clk_ref("ref_gpmi", "pll0", FRAC1, 2);\r\nclks[saif0_sel] = mxs_clk_mux("saif0_sel", CLKSEQ, 0, 1, sel_pll0, ARRAY_SIZE(sel_pll0));\r\nclks[saif1_sel] = mxs_clk_mux("saif1_sel", CLKSEQ, 1, 1, sel_pll0, ARRAY_SIZE(sel_pll0));\r\nclks[gpmi_sel] = mxs_clk_mux("gpmi_sel", CLKSEQ, 2, 1, sel_gpmi, ARRAY_SIZE(sel_gpmi));\r\nclks[ssp0_sel] = mxs_clk_mux("ssp0_sel", CLKSEQ, 3, 1, sel_io0, ARRAY_SIZE(sel_io0));\r\nclks[ssp1_sel] = mxs_clk_mux("ssp1_sel", CLKSEQ, 4, 1, sel_io0, ARRAY_SIZE(sel_io0));\r\nclks[ssp2_sel] = mxs_clk_mux("ssp2_sel", CLKSEQ, 5, 1, sel_io1, ARRAY_SIZE(sel_io1));\r\nclks[ssp3_sel] = mxs_clk_mux("ssp3_sel", CLKSEQ, 6, 1, sel_io1, ARRAY_SIZE(sel_io1));\r\nclks[emi_sel] = mxs_clk_mux("emi_sel", CLKSEQ, 7, 1, emi_sels, ARRAY_SIZE(emi_sels));\r\nclks[etm_sel] = mxs_clk_mux("etm_sel", CLKSEQ, 8, 1, sel_cpu, ARRAY_SIZE(sel_cpu));\r\nclks[lcdif_sel] = mxs_clk_mux("lcdif_sel", CLKSEQ, 14, 1, sel_pix, ARRAY_SIZE(sel_pix));\r\nclks[cpu] = mxs_clk_mux("cpu", CLKSEQ, 18, 1, cpu_sels, ARRAY_SIZE(cpu_sels));\r\nclks[ptp_sel] = mxs_clk_mux("ptp_sel", ENET, 19, 1, ptp_sels, ARRAY_SIZE(ptp_sels));\r\nclks[cpu_pll] = mxs_clk_div("cpu_pll", "ref_cpu", CPU, 0, 6, 28);\r\nclks[cpu_xtal] = mxs_clk_div("cpu_xtal", "ref_xtal", CPU, 16, 10, 29);\r\nclks[hbus] = mxs_clk_div("hbus", "cpu", HBUS, 0, 5, 31);\r\nclks[xbus] = mxs_clk_div("xbus", "ref_xtal", XBUS, 0, 10, 31);\r\nclks[ssp0_div] = mxs_clk_div("ssp0_div", "ssp0_sel", SSP0, 0, 9, 29);\r\nclks[ssp1_div] = mxs_clk_div("ssp1_div", "ssp1_sel", SSP1, 0, 9, 29);\r\nclks[ssp2_div] = mxs_clk_div("ssp2_div", "ssp2_sel", SSP2, 0, 9, 29);\r\nclks[ssp3_div] = mxs_clk_div("ssp3_div", "ssp3_sel", SSP3, 0, 9, 29);\r\nclks[gpmi_div] = mxs_clk_div("gpmi_div", "gpmi_sel", GPMI, 0, 10, 29);\r\nclks[emi_pll] = mxs_clk_div("emi_pll", "ref_emi", EMI, 0, 6, 28);\r\nclks[emi_xtal] = mxs_clk_div("emi_xtal", "ref_xtal", EMI, 8, 4, 29);\r\nclks[lcdif_div] = mxs_clk_div("lcdif_div", "lcdif_sel", LCDIF, 0, 13, 29);\r\nclks[etm_div] = mxs_clk_div("etm_div", "etm_sel", ETM, 0, 7, 29);\r\nclks[ptp] = mxs_clk_div("ptp", "ptp_sel", ENET, 21, 6, 27);\r\nclks[saif0_div] = mxs_clk_frac("saif0_div", "saif0_sel", SAIF0, 0, 16, 29);\r\nclks[saif1_div] = mxs_clk_frac("saif1_div", "saif1_sel", SAIF1, 0, 16, 29);\r\nclks[clk32k_div] = mxs_clk_fixed_factor("clk32k_div", "ref_xtal", 1, 750);\r\nclks[rtc] = mxs_clk_fixed_factor("rtc", "ref_xtal", 1, 768);\r\nclks[lradc] = mxs_clk_fixed_factor("lradc", "clk32k", 1, 16);\r\nclks[spdif_div] = mxs_clk_fixed_factor("spdif_div", "pll0", 1, 4);\r\nclks[clk32k] = mxs_clk_gate("clk32k", "clk32k_div", XTAL, 26);\r\nclks[pwm] = mxs_clk_gate("pwm", "ref_xtal", XTAL, 29);\r\nclks[uart] = mxs_clk_gate("uart", "ref_xtal", XTAL, 31);\r\nclks[ssp0] = mxs_clk_gate("ssp0", "ssp0_div", SSP0, 31);\r\nclks[ssp1] = mxs_clk_gate("ssp1", "ssp1_div", SSP1, 31);\r\nclks[ssp2] = mxs_clk_gate("ssp2", "ssp2_div", SSP2, 31);\r\nclks[ssp3] = mxs_clk_gate("ssp3", "ssp3_div", SSP3, 31);\r\nclks[gpmi] = mxs_clk_gate("gpmi", "gpmi_div", GPMI, 31);\r\nclks[spdif] = mxs_clk_gate("spdif", "spdif_div", SPDIF, 31);\r\nclks[emi] = mxs_clk_gate("emi", "emi_sel", EMI, 31);\r\nclks[saif0] = mxs_clk_gate("saif0", "saif0_div", SAIF0, 31);\r\nclks[saif1] = mxs_clk_gate("saif1", "saif1_div", SAIF1, 31);\r\nclks[lcdif] = mxs_clk_gate("lcdif", "lcdif_div", LCDIF, 31);\r\nclks[etm] = mxs_clk_gate("etm", "etm_div", ETM, 31);\r\nclks[fec] = mxs_clk_gate("fec", "hbus", ENET, 30);\r\nclks[can0] = mxs_clk_gate("can0", "ref_xtal", FLEXCAN, 30);\r\nclks[can1] = mxs_clk_gate("can1", "ref_xtal", FLEXCAN, 28);\r\nclks[usb0] = mxs_clk_gate("usb0", "usb0_phy", DIGCTRL, 2);\r\nclks[usb1] = mxs_clk_gate("usb1", "usb1_phy", DIGCTRL, 16);\r\nclks[usb0_phy] = clk_register_gate(NULL, "usb0_phy", "pll0", 0, PLL0CTRL0, 18, 0, &mxs_lock);\r\nclks[usb1_phy] = clk_register_gate(NULL, "usb1_phy", "pll1", 0, PLL1CTRL0, 18, 0, &mxs_lock);\r\nclks[enet_out] = clk_register_gate(NULL, "enet_out", "pll2", 0, ENET, 18, 0, &mxs_lock);\r\nfor (i = 0; i < ARRAY_SIZE(clks); i++)\r\nif (IS_ERR(clks[i])) {\r\npr_err("i.MX28 clk %d: register failed with %ld\n",\r\ni, PTR_ERR(clks[i]));\r\nreturn;\r\n}\r\nclk_data.clks = clks;\r\nclk_data.clk_num = ARRAY_SIZE(clks);\r\nof_clk_add_provider(np, of_clk_src_onecell_get, &clk_data);\r\nclk_register_clkdev(clks[enet_out], NULL, "enet_out");\r\nfor (i = 0; i < ARRAY_SIZE(clks_init_on); i++)\r\nclk_prepare_enable(clks[clks_init_on[i]]);\r\n}

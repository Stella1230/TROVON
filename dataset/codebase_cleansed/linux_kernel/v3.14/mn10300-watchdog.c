int __init check_watchdog(void)\r\n{\r\nirq_cpustat_t tmp[1];\r\nprintk(KERN_INFO "Testing Watchdog... ");\r\nmemcpy(tmp, irq_stat, sizeof(tmp));\r\nlocal_irq_enable();\r\nmdelay((10 * 1000) / watchdog_hz);\r\nlocal_irq_disable();\r\nif (nmi_count(0) - tmp[0].__nmi_count <= 5) {\r\nprintk(KERN_WARNING "CPU#%d: Watchdog appears to be stuck!\n",\r\n0);\r\nreturn -1;\r\n}\r\nprintk(KERN_INFO "OK.\n");\r\nwatchdog_hz = 1;\r\nreturn 0;\r\n}\r\nstatic int __init setup_watchdog(char *str)\r\n{\r\nunsigned tmp;\r\nint opt;\r\nu8 ctr;\r\nget_option(&str, &opt);\r\nif (opt != 1)\r\nreturn 0;\r\nwatchdog = opt;\r\nif (watchdog) {\r\nset_intr_stub(EXCEP_WDT, watchdog_handler);\r\nctr = WDCTR_WDCK_65536th;\r\nWDCTR = WDCTR_WDRST | ctr;\r\nWDCTR = ctr;\r\ntmp = WDCTR;\r\ntmp = __muldiv64u(1 << (16 + ctr * 2), 1000000, MN10300_WDCLK);\r\ntmp = 1000000000 / tmp;\r\nwatchdog_hz = (tmp + 500) / 1000;\r\n}\r\nreturn 1;\r\n}\r\nvoid __init watchdog_go(void)\r\n{\r\nu8 wdt;\r\nif (watchdog) {\r\nprintk(KERN_INFO "Watchdog: running at %uHz\n", watchdog_hz);\r\nwdt = WDCTR & ~WDCTR_WDCNE;\r\nWDCTR = wdt | WDCTR_WDRST;\r\nwdt = WDCTR;\r\nWDCTR = wdt | WDCTR_WDCNE;\r\nwdt = WDCTR;\r\ncheck_watchdog();\r\n}\r\n}\r\nstatic void watchdog_dump_register(void *dummy)\r\n{\r\nprintk(KERN_ERR "--- Register Dump (CPU%d) ---\n", CPUID);\r\nshow_registers(current_frame());\r\n}\r\nasmlinkage\r\nvoid watchdog_interrupt(struct pt_regs *regs, enum exception_code excep)\r\n{\r\nint sum, cpu;\r\nint irq = NMIIRQ;\r\nu8 wdt, tmp;\r\nwdt = WDCTR & ~WDCTR_WDCNE;\r\nWDCTR = wdt;\r\ntmp = WDCTR;\r\nNMICR = NMICR_WDIF;\r\nnmi_count(smp_processor_id())++;\r\nkstat_incr_irqs_this_cpu(irq, irq_to_desc(irq));\r\nfor_each_online_cpu(cpu) {\r\nsum = irq_stat[cpu].__irq_count;\r\nif ((last_irq_sums[cpu] == sum)\r\n#if defined(CONFIG_GDBSTUB) && defined(CONFIG_SMP)\r\n&& !(CHK_GDBSTUB_BUSY()\r\n|| atomic_read(&cpu_doing_single_step))\r\n#endif\r\n) {\r\nwatchdog_alert_counter[cpu]++;\r\nif (watchdog_alert_counter[cpu] == 5 * watchdog_hz) {\r\nspin_lock(&watchdog_print_lock);\r\nbust_spinlocks(1);\r\nprintk(KERN_ERR\r\n"NMI Watchdog detected LOCKUP on CPU%d,"\r\n" pc %08lx, registers:\n",\r\ncpu, regs->pc);\r\n#ifdef CONFIG_SMP\r\nprintk(KERN_ERR\r\n"--- Register Dump (CPU%d) ---\n",\r\nCPUID);\r\n#endif\r\nshow_registers(regs);\r\n#ifdef CONFIG_SMP\r\nsmp_nmi_call_function(watchdog_dump_register,\r\nNULL, 1);\r\n#endif\r\nprintk(KERN_NOTICE "console shuts up ...\n");\r\nconsole_silent();\r\nspin_unlock(&watchdog_print_lock);\r\nbust_spinlocks(0);\r\n#ifdef CONFIG_GDBSTUB\r\nif (CHK_GDBSTUB_BUSY_AND_ACTIVE())\r\ngdbstub_exception(regs, excep);\r\nelse\r\ngdbstub_intercept(regs, excep);\r\n#endif\r\ndo_exit(SIGSEGV);\r\n}\r\n} else {\r\nlast_irq_sums[cpu] = sum;\r\nwatchdog_alert_counter[cpu] = 0;\r\n}\r\n}\r\nWDCTR = wdt | WDCTR_WDRST;\r\ntmp = WDCTR;\r\nWDCTR = wdt | WDCTR_WDCNE;\r\ntmp = WDCTR;\r\n}

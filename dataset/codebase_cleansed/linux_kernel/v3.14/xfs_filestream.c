STATIC void\r\nxfs_filestreams_trace(\r\nxfs_mount_t *mp,\r\nint type,\r\nconst char *func,\r\nint line,\r\n__psunsigned_t arg0,\r\n__psunsigned_t arg1,\r\n__psunsigned_t arg2,\r\n__psunsigned_t arg3,\r\n__psunsigned_t arg4,\r\n__psunsigned_t arg5)\r\n{\r\nktrace_enter(xfs_filestreams_trace_buf,\r\n(void *)(__psint_t)(type | (line << 16)),\r\n(void *)func,\r\n(void *)(__psunsigned_t)current_pid(),\r\n(void *)mp,\r\n(void *)(__psunsigned_t)arg0,\r\n(void *)(__psunsigned_t)arg1,\r\n(void *)(__psunsigned_t)arg2,\r\n(void *)(__psunsigned_t)arg3,\r\n(void *)(__psunsigned_t)arg4,\r\n(void *)(__psunsigned_t)arg5,\r\nNULL, NULL, NULL, NULL, NULL, NULL);\r\n}\r\nstatic int\r\nxfs_filestream_peek_ag(\r\nxfs_mount_t *mp,\r\nxfs_agnumber_t agno)\r\n{\r\nstruct xfs_perag *pag;\r\nint ret;\r\npag = xfs_perag_get(mp, agno);\r\nret = atomic_read(&pag->pagf_fstrms);\r\nxfs_perag_put(pag);\r\nreturn ret;\r\n}\r\nstatic int\r\nxfs_filestream_get_ag(\r\nxfs_mount_t *mp,\r\nxfs_agnumber_t agno)\r\n{\r\nstruct xfs_perag *pag;\r\nint ret;\r\npag = xfs_perag_get(mp, agno);\r\nret = atomic_inc_return(&pag->pagf_fstrms);\r\nxfs_perag_put(pag);\r\nreturn ret;\r\n}\r\nstatic void\r\nxfs_filestream_put_ag(\r\nxfs_mount_t *mp,\r\nxfs_agnumber_t agno)\r\n{\r\nstruct xfs_perag *pag;\r\npag = xfs_perag_get(mp, agno);\r\natomic_dec(&pag->pagf_fstrms);\r\nxfs_perag_put(pag);\r\n}\r\nstatic int\r\n_xfs_filestream_pick_ag(\r\nxfs_mount_t *mp,\r\nxfs_agnumber_t startag,\r\nxfs_agnumber_t *agp,\r\nint flags,\r\nxfs_extlen_t minlen)\r\n{\r\nint streams, max_streams;\r\nint err, trylock, nscan;\r\nxfs_extlen_t longest, free, minfree, maxfree = 0;\r\nxfs_agnumber_t ag, max_ag = NULLAGNUMBER;\r\nstruct xfs_perag *pag;\r\nminfree = mp->m_sb.sb_agblocks / 50;\r\nag = startag;\r\n*agp = NULLAGNUMBER;\r\ntrylock = XFS_ALLOC_FLAG_TRYLOCK;\r\nfor (nscan = 0; 1; nscan++) {\r\npag = xfs_perag_get(mp, ag);\r\nTRACE_AG_SCAN(mp, ag, atomic_read(&pag->pagf_fstrms));\r\nif (!pag->pagf_init) {\r\nerr = xfs_alloc_pagf_init(mp, NULL, ag, trylock);\r\nif (err && !trylock) {\r\nxfs_perag_put(pag);\r\nreturn err;\r\n}\r\n}\r\nif (!pag->pagf_init)\r\ngoto next_ag;\r\nif (pag->pagf_freeblks > maxfree) {\r\nmaxfree = pag->pagf_freeblks;\r\nmax_streams = atomic_read(&pag->pagf_fstrms);\r\nmax_ag = ag;\r\n}\r\nif (xfs_filestream_get_ag(mp, ag) > 1) {\r\nxfs_filestream_put_ag(mp, ag);\r\ngoto next_ag;\r\n}\r\nlongest = xfs_alloc_longest_free_extent(mp, pag);\r\nif (((minlen && longest >= minlen) ||\r\n(!minlen && pag->pagf_freeblks >= minfree)) &&\r\n(!pag->pagf_metadata || !(flags & XFS_PICK_USERDATA) ||\r\n(flags & XFS_PICK_LOWSPACE))) {\r\nfree = pag->pagf_freeblks;\r\nstreams = atomic_read(&pag->pagf_fstrms);\r\nxfs_perag_put(pag);\r\n*agp = ag;\r\nbreak;\r\n}\r\nxfs_filestream_put_ag(mp, ag);\r\nnext_ag:\r\nxfs_perag_put(pag);\r\nif (++ag >= mp->m_sb.sb_agcount)\r\nag = 0;\r\nif (ag != startag)\r\ncontinue;\r\nif (trylock != 0) {\r\ntrylock = 0;\r\ncontinue;\r\n}\r\nif (!(flags & XFS_PICK_LOWSPACE)) {\r\nflags |= XFS_PICK_LOWSPACE;\r\ncontinue;\r\n}\r\nif (max_ag != NULLAGNUMBER) {\r\nxfs_filestream_get_ag(mp, max_ag);\r\nTRACE_AG_PICK1(mp, max_ag, maxfree);\r\nstreams = max_streams;\r\nfree = maxfree;\r\n*agp = max_ag;\r\nbreak;\r\n}\r\nTRACE_AG_PICK1(mp, max_ag, maxfree);\r\n*agp = 0;\r\nreturn 0;\r\n}\r\nTRACE_AG_PICK2(mp, startag, *agp, streams, free, nscan, flags);\r\nreturn 0;\r\n}\r\nstatic int\r\n_xfs_filestream_update_ag(\r\nxfs_inode_t *ip,\r\nxfs_inode_t *pip,\r\nxfs_agnumber_t ag)\r\n{\r\nint err = 0;\r\nxfs_mount_t *mp;\r\nxfs_mru_cache_t *cache;\r\nfstrm_item_t *item;\r\nxfs_agnumber_t old_ag;\r\nxfs_inode_t *old_pip;\r\nASSERT(ip && ((S_ISREG(ip->i_d.di_mode) && pip &&\r\nS_ISDIR(pip->i_d.di_mode)) ||\r\n(S_ISDIR(ip->i_d.di_mode) && !pip)));\r\nmp = ip->i_mount;\r\ncache = mp->m_filestream;\r\nitem = xfs_mru_cache_lookup(cache, ip->i_ino);\r\nif (item) {\r\nASSERT(item->ip == ip);\r\nold_ag = item->ag;\r\nitem->ag = ag;\r\nold_pip = item->pip;\r\nitem->pip = pip;\r\nxfs_mru_cache_done(cache);\r\nif (ag != old_ag) {\r\nxfs_filestream_put_ag(mp, old_ag);\r\nxfs_filestream_get_ag(mp, ag);\r\n}\r\nif (pip && pip != old_pip) {\r\nIRELE(old_pip);\r\nIHOLD(pip);\r\n}\r\nTRACE_UPDATE(mp, ip, old_ag, xfs_filestream_peek_ag(mp, old_ag),\r\nag, xfs_filestream_peek_ag(mp, ag));\r\nreturn 0;\r\n}\r\nitem = kmem_zone_zalloc(item_zone, KM_MAYFAIL);\r\nif (!item)\r\nreturn ENOMEM;\r\nitem->ag = ag;\r\nitem->ip = ip;\r\nitem->pip = pip;\r\nerr = xfs_mru_cache_insert(cache, ip->i_ino, item);\r\nif (err) {\r\nkmem_zone_free(item_zone, item);\r\nreturn err;\r\n}\r\nxfs_filestream_get_ag(mp, ag);\r\nIHOLD(ip);\r\nif (pip)\r\nIHOLD(pip);\r\nTRACE_UPDATE(mp, ip, ag, xfs_filestream_peek_ag(mp, ag),\r\nag, xfs_filestream_peek_ag(mp, ag));\r\nreturn 0;\r\n}\r\nSTATIC void\r\nxfs_fstrm_free_func(\r\nunsigned long ino,\r\nvoid *data)\r\n{\r\nfstrm_item_t *item = (fstrm_item_t *)data;\r\nxfs_inode_t *ip = item->ip;\r\nASSERT(ip->i_ino == ino);\r\nxfs_iflags_clear(ip, XFS_IFILESTREAM);\r\nxfs_filestream_put_ag(ip->i_mount, item->ag);\r\nTRACE_FREE(ip->i_mount, ip, item->pip, item->ag,\r\nxfs_filestream_peek_ag(ip->i_mount, item->ag));\r\nIRELE(ip);\r\nif (item->pip)\r\nIRELE(item->pip);\r\nkmem_zone_free(item_zone, item);\r\n}\r\nint\r\nxfs_filestream_init(void)\r\n{\r\nitem_zone = kmem_zone_init(sizeof(fstrm_item_t), "fstrm_item");\r\nif (!item_zone)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nvoid\r\nxfs_filestream_uninit(void)\r\n{\r\nkmem_zone_destroy(item_zone);\r\n}\r\nint\r\nxfs_filestream_mount(\r\nxfs_mount_t *mp)\r\n{\r\nint err;\r\nunsigned int lifetime, grp_count;\r\nlifetime = xfs_fstrm_centisecs * 10;\r\ngrp_count = 10;\r\nerr = xfs_mru_cache_create(&mp->m_filestream, lifetime, grp_count,\r\nxfs_fstrm_free_func);\r\nreturn err;\r\n}\r\nvoid\r\nxfs_filestream_unmount(\r\nxfs_mount_t *mp)\r\n{\r\nxfs_mru_cache_destroy(mp->m_filestream);\r\n}\r\nxfs_agnumber_t\r\nxfs_filestream_lookup_ag(\r\nxfs_inode_t *ip)\r\n{\r\nxfs_mru_cache_t *cache;\r\nfstrm_item_t *item;\r\nxfs_agnumber_t ag;\r\nint ref;\r\nif (!S_ISREG(ip->i_d.di_mode) && !S_ISDIR(ip->i_d.di_mode)) {\r\nASSERT(0);\r\nreturn NULLAGNUMBER;\r\n}\r\ncache = ip->i_mount->m_filestream;\r\nitem = xfs_mru_cache_lookup(cache, ip->i_ino);\r\nif (!item) {\r\nTRACE_LOOKUP(ip->i_mount, ip, NULL, NULLAGNUMBER, 0);\r\nreturn NULLAGNUMBER;\r\n}\r\nASSERT(ip == item->ip);\r\nag = item->ag;\r\nref = xfs_filestream_peek_ag(ip->i_mount, ag);\r\nxfs_mru_cache_done(cache);\r\nTRACE_LOOKUP(ip->i_mount, ip, item->pip, ag, ref);\r\nreturn ag;\r\n}\r\nint\r\nxfs_filestream_associate(\r\nxfs_inode_t *pip,\r\nxfs_inode_t *ip)\r\n{\r\nxfs_mount_t *mp;\r\nxfs_mru_cache_t *cache;\r\nfstrm_item_t *item;\r\nxfs_agnumber_t ag, rotorstep, startag;\r\nint err = 0;\r\nASSERT(S_ISDIR(pip->i_d.di_mode));\r\nASSERT(S_ISREG(ip->i_d.di_mode));\r\nif (!S_ISDIR(pip->i_d.di_mode) || !S_ISREG(ip->i_d.di_mode))\r\nreturn -EINVAL;\r\nmp = pip->i_mount;\r\ncache = mp->m_filestream;\r\nif (!xfs_ilock_nowait(pip, XFS_IOLOCK_EXCL))\r\nreturn 1;\r\nitem = xfs_mru_cache_lookup(cache, pip->i_ino);\r\nif (item) {\r\nASSERT(item->ip == pip);\r\nag = item->ag;\r\nxfs_mru_cache_done(cache);\r\nTRACE_LOOKUP(mp, pip, pip, ag, xfs_filestream_peek_ag(mp, ag));\r\nerr = _xfs_filestream_update_ag(ip, pip, ag);\r\ngoto exit;\r\n}\r\nif (mp->m_flags & XFS_MOUNT_32BITINODES) {\r\nrotorstep = xfs_rotorstep;\r\nstartag = (mp->m_agfrotor / rotorstep) % mp->m_sb.sb_agcount;\r\nmp->m_agfrotor = (mp->m_agfrotor + 1) %\r\n(mp->m_sb.sb_agcount * rotorstep);\r\n} else\r\nstartag = XFS_INO_TO_AGNO(mp, pip->i_ino);\r\nerr = _xfs_filestream_pick_ag(mp, startag, &ag, 0, 0);\r\nif (err || ag == NULLAGNUMBER)\r\ngoto exit_did_pick;\r\nerr = _xfs_filestream_update_ag(pip, NULL, ag);\r\nif (err)\r\ngoto exit_did_pick;\r\nerr = _xfs_filestream_update_ag(ip, pip, ag);\r\nif (err)\r\ngoto exit_did_pick;\r\nTRACE_ASSOCIATE(mp, ip, pip, ag, xfs_filestream_peek_ag(mp, ag));\r\nexit_did_pick:\r\nif (ag != NULLAGNUMBER)\r\nxfs_filestream_put_ag(mp, ag);\r\nexit:\r\nxfs_iunlock(pip, XFS_IOLOCK_EXCL);\r\nreturn -err;\r\n}\r\nint\r\nxfs_filestream_new_ag(\r\nstruct xfs_bmalloca *ap,\r\nxfs_agnumber_t *agp)\r\n{\r\nint flags, err;\r\nxfs_inode_t *ip, *pip = NULL;\r\nxfs_mount_t *mp;\r\nxfs_mru_cache_t *cache;\r\nxfs_extlen_t minlen;\r\nfstrm_item_t *dir, *file;\r\nxfs_agnumber_t ag = NULLAGNUMBER;\r\nip = ap->ip;\r\nmp = ip->i_mount;\r\ncache = mp->m_filestream;\r\nminlen = ap->length;\r\n*agp = NULLAGNUMBER;\r\nfile = xfs_mru_cache_remove(cache, ip->i_ino);\r\nif (file) {\r\nASSERT(ip == file->ip);\r\npip = file->pip;\r\nag = file->ag;\r\ndir = xfs_mru_cache_lookup(cache, pip->i_ino);\r\nif (dir) {\r\nASSERT(pip == dir->ip);\r\nif (dir->ag != file->ag) {\r\nxfs_filestream_put_ag(mp, file->ag);\r\nxfs_filestream_get_ag(mp, dir->ag);\r\n*agp = file->ag = dir->ag;\r\n}\r\nxfs_mru_cache_done(cache);\r\n}\r\nerr = xfs_mru_cache_insert(cache, ip->i_ino, file);\r\nif (err) {\r\nxfs_fstrm_free_func(ip->i_ino, file);\r\nreturn err;\r\n}\r\nif (*agp != NULLAGNUMBER) {\r\nTRACE_MOVEAG(mp, ip, pip,\r\nag, xfs_filestream_peek_ag(mp, ag),\r\n*agp, xfs_filestream_peek_ag(mp, *agp));\r\nreturn 0;\r\n}\r\n}\r\nif (pip)\r\nxfs_ilock(pip, XFS_IOLOCK_EXCL | XFS_IOLOCK_PARENT);\r\nag = (ag == NULLAGNUMBER) ? 0 : (ag + 1) % mp->m_sb.sb_agcount;\r\nflags = (ap->userdata ? XFS_PICK_USERDATA : 0) |\r\n(ap->flist->xbf_low ? XFS_PICK_LOWSPACE : 0);\r\nerr = _xfs_filestream_pick_ag(mp, ag, agp, flags, minlen);\r\nif (err || *agp == NULLAGNUMBER)\r\ngoto exit;\r\nif (!pip) {\r\nTRACE_ORPHAN(mp, ip, *agp);\r\ngoto exit;\r\n}\r\nerr = _xfs_filestream_update_ag(pip, NULL, *agp);\r\nif (err)\r\ngoto exit;\r\nerr = _xfs_filestream_update_ag(ip, pip, *agp);\r\nif (err)\r\ngoto exit;\r\nTRACE_MOVEAG(mp, ip, pip, NULLAGNUMBER, 0,\r\n*agp, xfs_filestream_peek_ag(mp, *agp));\r\nexit:\r\nif (*agp != NULLAGNUMBER)\r\nxfs_filestream_put_ag(mp, *agp);\r\nelse\r\n*agp = 0;\r\nif (pip)\r\nxfs_iunlock(pip, XFS_IOLOCK_EXCL);\r\nreturn err;\r\n}\r\nvoid\r\nxfs_filestream_deassociate(\r\nxfs_inode_t *ip)\r\n{\r\nxfs_mru_cache_t *cache = ip->i_mount->m_filestream;\r\nxfs_mru_cache_delete(cache, ip->i_ino);\r\n}

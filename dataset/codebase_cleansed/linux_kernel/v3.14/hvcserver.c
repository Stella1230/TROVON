static int hvcs_convert(long to_convert)\r\n{\r\nswitch (to_convert) {\r\ncase H_SUCCESS:\r\nreturn 0;\r\ncase H_PARAMETER:\r\nreturn -EINVAL;\r\ncase H_HARDWARE:\r\nreturn -EIO;\r\ncase H_BUSY:\r\ncase H_LONG_BUSY_ORDER_1_MSEC:\r\ncase H_LONG_BUSY_ORDER_10_MSEC:\r\ncase H_LONG_BUSY_ORDER_100_MSEC:\r\ncase H_LONG_BUSY_ORDER_1_SEC:\r\ncase H_LONG_BUSY_ORDER_10_SEC:\r\ncase H_LONG_BUSY_ORDER_100_SEC:\r\nreturn -EBUSY;\r\ncase H_FUNCTION:\r\ndefault:\r\nreturn -EPERM;\r\n}\r\n}\r\nint hvcs_free_partner_info(struct list_head *head)\r\n{\r\nstruct hvcs_partner_info *pi;\r\nstruct list_head *element;\r\nif (!head)\r\nreturn -EINVAL;\r\nwhile (!list_empty(head)) {\r\nelement = head->next;\r\npi = list_entry(element, struct hvcs_partner_info, node);\r\nlist_del(element);\r\nkfree(pi);\r\n}\r\nreturn 0;\r\n}\r\nstatic int hvcs_next_partner(uint32_t unit_address,\r\nunsigned long last_p_partition_ID,\r\nunsigned long last_p_unit_address, unsigned long *pi_buff)\r\n{\r\nlong retval;\r\nretval = plpar_hcall_norets(H_VTERM_PARTNER_INFO, unit_address,\r\nlast_p_partition_ID,\r\nlast_p_unit_address, virt_to_phys(pi_buff));\r\nreturn hvcs_convert(retval);\r\n}\r\nint hvcs_get_partner_info(uint32_t unit_address, struct list_head *head,\r\nunsigned long *pi_buff)\r\n{\r\nunsigned long last_p_partition_ID;\r\nunsigned long last_p_unit_address;\r\nstruct hvcs_partner_info *next_partner_info = NULL;\r\nint more = 1;\r\nint retval;\r\nmemset(pi_buff, 0x00, PAGE_SIZE);\r\nif (!head || !pi_buff)\r\nreturn -EINVAL;\r\nlast_p_partition_ID = last_p_unit_address = ~0UL;\r\nINIT_LIST_HEAD(head);\r\ndo {\r\nretval = hvcs_next_partner(unit_address, last_p_partition_ID,\r\nlast_p_unit_address, pi_buff);\r\nif (retval) {\r\nif (!list_empty(head))\r\nreturn 0;\r\nreturn retval;\r\n}\r\nlast_p_partition_ID = pi_buff[0];\r\nlast_p_unit_address = pi_buff[1];\r\nif (last_p_partition_ID == ~0UL\r\n&& last_p_unit_address == ~0UL)\r\nbreak;\r\nnext_partner_info = kmalloc(sizeof(struct hvcs_partner_info),\r\nGFP_ATOMIC);\r\nif (!next_partner_info) {\r\nprintk(KERN_WARNING "HVCONSOLE: kmalloc() failed to"\r\n" allocate partner info struct.\n");\r\nhvcs_free_partner_info(head);\r\nreturn -ENOMEM;\r\n}\r\nnext_partner_info->unit_address\r\n= (unsigned int)last_p_unit_address;\r\nnext_partner_info->partition_ID\r\n= (unsigned int)last_p_partition_ID;\r\nstrlcpy(&next_partner_info->location_code[0],\r\n(char *)&pi_buff[2],\r\nsizeof(next_partner_info->location_code));\r\nlist_add_tail(&(next_partner_info->node), head);\r\nnext_partner_info = NULL;\r\n} while (more);\r\nreturn 0;\r\n}\r\nint hvcs_register_connection( uint32_t unit_address,\r\nuint32_t p_partition_ID, uint32_t p_unit_address)\r\n{\r\nlong retval;\r\nretval = plpar_hcall_norets(H_REGISTER_VTERM, unit_address,\r\np_partition_ID, p_unit_address);\r\nreturn hvcs_convert(retval);\r\n}\r\nint hvcs_free_connection(uint32_t unit_address)\r\n{\r\nlong retval;\r\nretval = plpar_hcall_norets(H_FREE_VTERM, unit_address);\r\nreturn hvcs_convert(retval);\r\n}

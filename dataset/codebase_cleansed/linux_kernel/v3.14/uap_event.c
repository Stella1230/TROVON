struct mwifiex_sta_node *\r\nmwifiex_get_sta_entry(struct mwifiex_private *priv, u8 *mac)\r\n{\r\nstruct mwifiex_sta_node *node;\r\nif (!mac)\r\nreturn NULL;\r\nlist_for_each_entry(node, &priv->sta_list, list) {\r\nif (!memcmp(node->mac_addr, mac, ETH_ALEN))\r\nreturn node;\r\n}\r\nreturn NULL;\r\n}\r\nstatic struct mwifiex_sta_node *\r\nmwifiex_add_sta_entry(struct mwifiex_private *priv, u8 *mac)\r\n{\r\nstruct mwifiex_sta_node *node;\r\nunsigned long flags;\r\nif (!mac)\r\nreturn NULL;\r\nspin_lock_irqsave(&priv->sta_list_spinlock, flags);\r\nnode = mwifiex_get_sta_entry(priv, mac);\r\nif (node)\r\ngoto done;\r\nnode = kzalloc(sizeof(struct mwifiex_sta_node), GFP_ATOMIC);\r\nif (!node)\r\ngoto done;\r\nmemcpy(node->mac_addr, mac, ETH_ALEN);\r\nlist_add_tail(&node->list, &priv->sta_list);\r\ndone:\r\nspin_unlock_irqrestore(&priv->sta_list_spinlock, flags);\r\nreturn node;\r\n}\r\nstatic void\r\nmwifiex_set_sta_ht_cap(struct mwifiex_private *priv, const u8 *ies,\r\nint ies_len, struct mwifiex_sta_node *node)\r\n{\r\nconst struct ieee80211_ht_cap *ht_cap;\r\nif (!ies)\r\nreturn;\r\nht_cap = (void *)cfg80211_find_ie(WLAN_EID_HT_CAPABILITY, ies, ies_len);\r\nif (ht_cap) {\r\nnode->is_11n_enabled = 1;\r\nnode->max_amsdu = le16_to_cpu(ht_cap->cap_info) &\r\nIEEE80211_HT_CAP_MAX_AMSDU ?\r\nMWIFIEX_TX_DATA_BUF_SIZE_8K :\r\nMWIFIEX_TX_DATA_BUF_SIZE_4K;\r\n} else {\r\nnode->is_11n_enabled = 0;\r\n}\r\nreturn;\r\n}\r\nstatic void mwifiex_del_sta_entry(struct mwifiex_private *priv, u8 *mac)\r\n{\r\nstruct mwifiex_sta_node *node;\r\nunsigned long flags;\r\nspin_lock_irqsave(&priv->sta_list_spinlock, flags);\r\nnode = mwifiex_get_sta_entry(priv, mac);\r\nif (node) {\r\nlist_del(&node->list);\r\nkfree(node);\r\n}\r\nspin_unlock_irqrestore(&priv->sta_list_spinlock, flags);\r\nreturn;\r\n}\r\nstatic void mwifiex_del_all_sta_list(struct mwifiex_private *priv)\r\n{\r\nstruct mwifiex_sta_node *node, *tmp;\r\nunsigned long flags;\r\nspin_lock_irqsave(&priv->sta_list_spinlock, flags);\r\nlist_for_each_entry_safe(node, tmp, &priv->sta_list, list) {\r\nlist_del(&node->list);\r\nkfree(node);\r\n}\r\nINIT_LIST_HEAD(&priv->sta_list);\r\nspin_unlock_irqrestore(&priv->sta_list_spinlock, flags);\r\nreturn;\r\n}\r\nint mwifiex_process_uap_event(struct mwifiex_private *priv)\r\n{\r\nstruct mwifiex_adapter *adapter = priv->adapter;\r\nint len, i;\r\nu32 eventcause = adapter->event_cause;\r\nstruct station_info sinfo;\r\nstruct mwifiex_assoc_event *event;\r\nstruct mwifiex_sta_node *node;\r\nu8 *deauth_mac;\r\nstruct host_cmd_ds_11n_batimeout *ba_timeout;\r\nu16 ctrl;\r\nswitch (eventcause) {\r\ncase EVENT_UAP_STA_ASSOC:\r\nmemset(&sinfo, 0, sizeof(sinfo));\r\nevent = (struct mwifiex_assoc_event *)\r\n(adapter->event_body + MWIFIEX_UAP_EVENT_EXTRA_HEADER);\r\nif (le16_to_cpu(event->type) == TLV_TYPE_UAP_MGMT_FRAME) {\r\nlen = -1;\r\nif (ieee80211_is_assoc_req(event->frame_control))\r\nlen = 0;\r\nelse if (ieee80211_is_reassoc_req(event->frame_control))\r\nlen = ETH_ALEN;\r\nif (len != -1) {\r\nsinfo.filled = STATION_INFO_ASSOC_REQ_IES;\r\nsinfo.assoc_req_ies = &event->data[len];\r\nlen = (u8 *)sinfo.assoc_req_ies -\r\n(u8 *)&event->frame_control;\r\nsinfo.assoc_req_ies_len =\r\nle16_to_cpu(event->len) - (u16)len;\r\n}\r\n}\r\ncfg80211_new_sta(priv->netdev, event->sta_addr, &sinfo,\r\nGFP_KERNEL);\r\nnode = mwifiex_add_sta_entry(priv, event->sta_addr);\r\nif (!node) {\r\ndev_warn(adapter->dev,\r\n"could not create station entry!\n");\r\nreturn -1;\r\n}\r\nif (!priv->ap_11n_enabled)\r\nbreak;\r\nmwifiex_set_sta_ht_cap(priv, sinfo.assoc_req_ies,\r\nsinfo.assoc_req_ies_len, node);\r\nfor (i = 0; i < MAX_NUM_TID; i++) {\r\nif (node->is_11n_enabled)\r\nnode->ampdu_sta[i] =\r\npriv->aggr_prio_tbl[i].ampdu_user;\r\nelse\r\nnode->ampdu_sta[i] = BA_STREAM_NOT_ALLOWED;\r\n}\r\nmemset(node->rx_seq, 0xff, sizeof(node->rx_seq));\r\nbreak;\r\ncase EVENT_UAP_STA_DEAUTH:\r\ndeauth_mac = adapter->event_body +\r\nMWIFIEX_UAP_EVENT_EXTRA_HEADER;\r\ncfg80211_del_sta(priv->netdev, deauth_mac, GFP_KERNEL);\r\nif (priv->ap_11n_enabled) {\r\nmwifiex_11n_del_rx_reorder_tbl_by_ta(priv, deauth_mac);\r\nmwifiex_del_tx_ba_stream_tbl_by_ra(priv, deauth_mac);\r\n}\r\nmwifiex_del_sta_entry(priv, deauth_mac);\r\nbreak;\r\ncase EVENT_UAP_BSS_IDLE:\r\npriv->media_connected = false;\r\nif (netif_carrier_ok(priv->netdev))\r\nnetif_carrier_off(priv->netdev);\r\nmwifiex_stop_net_dev_queue(priv->netdev, adapter);\r\nmwifiex_clean_txrx(priv);\r\nmwifiex_del_all_sta_list(priv);\r\nbreak;\r\ncase EVENT_UAP_BSS_ACTIVE:\r\npriv->media_connected = true;\r\nif (!netif_carrier_ok(priv->netdev))\r\nnetif_carrier_on(priv->netdev);\r\nmwifiex_wake_up_net_dev_queue(priv->netdev, adapter);\r\nbreak;\r\ncase EVENT_UAP_BSS_START:\r\ndev_dbg(adapter->dev, "AP EVENT: event id: %#x\n", eventcause);\r\nmemcpy(priv->netdev->dev_addr, adapter->event_body + 2,\r\nETH_ALEN);\r\nbreak;\r\ncase EVENT_UAP_MIC_COUNTERMEASURES:\r\ndev_dbg(adapter->dev, "AP EVENT: event id: %#x\n", eventcause);\r\nbreak;\r\ncase EVENT_AMSDU_AGGR_CTRL:\r\nctrl = le16_to_cpu(*(__le16 *)adapter->event_body);\r\ndev_dbg(adapter->dev, "event: AMSDU_AGGR_CTRL %d\n", ctrl);\r\nif (priv->media_connected) {\r\nadapter->tx_buf_size =\r\nmin_t(u16, adapter->curr_tx_buf_size, ctrl);\r\ndev_dbg(adapter->dev, "event: tx_buf_size %d\n",\r\nadapter->tx_buf_size);\r\n}\r\nbreak;\r\ncase EVENT_ADDBA:\r\ndev_dbg(adapter->dev, "event: ADDBA Request\n");\r\nif (priv->media_connected)\r\nmwifiex_send_cmd_async(priv, HostCmd_CMD_11N_ADDBA_RSP,\r\nHostCmd_ACT_GEN_SET, 0,\r\nadapter->event_body);\r\nbreak;\r\ncase EVENT_DELBA:\r\ndev_dbg(adapter->dev, "event: DELBA Request\n");\r\nif (priv->media_connected)\r\nmwifiex_11n_delete_ba_stream(priv, adapter->event_body);\r\nbreak;\r\ncase EVENT_BA_STREAM_TIEMOUT:\r\ndev_dbg(adapter->dev, "event: BA Stream timeout\n");\r\nif (priv->media_connected) {\r\nba_timeout = (void *)adapter->event_body;\r\nmwifiex_11n_ba_stream_timeout(priv, ba_timeout);\r\n}\r\nbreak;\r\ndefault:\r\ndev_dbg(adapter->dev, "event: unknown event id: %#x\n",\r\neventcause);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nvoid mwifiex_uap_del_sta_data(struct mwifiex_private *priv,\r\nstruct mwifiex_sta_node *node)\r\n{\r\nif (priv->ap_11n_enabled && node->is_11n_enabled) {\r\nmwifiex_11n_del_rx_reorder_tbl_by_ta(priv, node->mac_addr);\r\nmwifiex_del_tx_ba_stream_tbl_by_ra(priv, node->mac_addr);\r\n}\r\nmwifiex_del_sta_entry(priv, node->mac_addr);\r\nreturn;\r\n}

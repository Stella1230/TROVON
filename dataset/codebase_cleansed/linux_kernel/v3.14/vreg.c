struct vreg *vreg_get(struct device *dev, const char *id)\r\n{\r\nint n;\r\nfor (n = 0; n < ARRAY_SIZE(vregs); n++) {\r\nif (!strcmp(vregs[n].name, id))\r\nreturn vregs + n;\r\n}\r\nreturn ERR_PTR(-ENOENT);\r\n}\r\nvoid vreg_put(struct vreg *vreg)\r\n{\r\n}\r\nint vreg_enable(struct vreg *vreg)\r\n{\r\nunsigned id = vreg->id;\r\nunsigned enable = 1;\r\nif (vreg->refcnt == 0)\r\nvreg->status = msm_proc_comm(PCOM_VREG_SWITCH, &id, &enable);\r\nif ((vreg->refcnt < UINT_MAX) && (!vreg->status))\r\nvreg->refcnt++;\r\nreturn vreg->status;\r\n}\r\nint vreg_disable(struct vreg *vreg)\r\n{\r\nunsigned id = vreg->id;\r\nunsigned enable = 0;\r\nif (!vreg->refcnt)\r\nreturn 0;\r\nif (vreg->refcnt == 1)\r\nvreg->status = msm_proc_comm(PCOM_VREG_SWITCH, &id, &enable);\r\nif (!vreg->status)\r\nvreg->refcnt--;\r\nreturn vreg->status;\r\n}\r\nint vreg_set_level(struct vreg *vreg, unsigned mv)\r\n{\r\nunsigned id = vreg->id;\r\nvreg->status = msm_proc_comm(PCOM_VREG_SET_LEVEL, &id, &mv);\r\nreturn vreg->status;\r\n}\r\nstatic int vreg_debug_set(void *data, u64 val)\r\n{\r\nstruct vreg *vreg = data;\r\nswitch (val) {\r\ncase 0:\r\nvreg_disable(vreg);\r\nbreak;\r\ncase 1:\r\nvreg_enable(vreg);\r\nbreak;\r\ndefault:\r\nvreg_set_level(vreg, val);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int vreg_debug_get(void *data, u64 *val)\r\n{\r\nstruct vreg *vreg = data;\r\nif (!vreg->status)\r\n*val = 0;\r\nelse\r\n*val = 1;\r\nreturn 0;\r\n}\r\nstatic int vreg_debug_count_set(void *data, u64 val)\r\n{\r\nstruct vreg *vreg = data;\r\nif (val > UINT_MAX)\r\nval = UINT_MAX;\r\nvreg->refcnt = val;\r\nreturn 0;\r\n}\r\nstatic int vreg_debug_count_get(void *data, u64 *val)\r\n{\r\nstruct vreg *vreg = data;\r\n*val = vreg->refcnt;\r\nreturn 0;\r\n}\r\nstatic int __init vreg_debug_init(void)\r\n{\r\nstruct dentry *dent;\r\nint n;\r\nchar name[32];\r\nconst char *refcnt_name = "_refcnt";\r\ndent = debugfs_create_dir("vreg", 0);\r\nif (IS_ERR(dent))\r\nreturn 0;\r\nfor (n = 0; n < ARRAY_SIZE(vregs); n++) {\r\n(void) debugfs_create_file(vregs[n].name, 0644,\r\ndent, vregs + n, &vreg_fops);\r\nstrlcpy(name, vregs[n].name, sizeof(name));\r\nstrlcat(name, refcnt_name, sizeof(name));\r\n(void) debugfs_create_file(name, 0644,\r\ndent, vregs + n, &vreg_count_fops);\r\n}\r\nreturn 0;\r\n}

static unsigned int sel_netnode_hashfn_ipv4(__be32 addr)\r\n{\r\nreturn (addr & (SEL_NETNODE_HASH_SIZE - 1));\r\n}\r\nstatic unsigned int sel_netnode_hashfn_ipv6(const struct in6_addr *addr)\r\n{\r\nreturn (addr->s6_addr32[3] & (SEL_NETNODE_HASH_SIZE - 1));\r\n}\r\nstatic struct sel_netnode *sel_netnode_find(const void *addr, u16 family)\r\n{\r\nunsigned int idx;\r\nstruct sel_netnode *node;\r\nswitch (family) {\r\ncase PF_INET:\r\nidx = sel_netnode_hashfn_ipv4(*(__be32 *)addr);\r\nbreak;\r\ncase PF_INET6:\r\nidx = sel_netnode_hashfn_ipv6(addr);\r\nbreak;\r\ndefault:\r\nBUG();\r\nreturn NULL;\r\n}\r\nlist_for_each_entry_rcu(node, &sel_netnode_hash[idx].list, list)\r\nif (node->nsec.family == family)\r\nswitch (family) {\r\ncase PF_INET:\r\nif (node->nsec.addr.ipv4 == *(__be32 *)addr)\r\nreturn node;\r\nbreak;\r\ncase PF_INET6:\r\nif (ipv6_addr_equal(&node->nsec.addr.ipv6,\r\naddr))\r\nreturn node;\r\nbreak;\r\n}\r\nreturn NULL;\r\n}\r\nstatic void sel_netnode_insert(struct sel_netnode *node)\r\n{\r\nunsigned int idx;\r\nswitch (node->nsec.family) {\r\ncase PF_INET:\r\nidx = sel_netnode_hashfn_ipv4(node->nsec.addr.ipv4);\r\nbreak;\r\ncase PF_INET6:\r\nidx = sel_netnode_hashfn_ipv6(&node->nsec.addr.ipv6);\r\nbreak;\r\ndefault:\r\nBUG();\r\nreturn;\r\n}\r\nlist_add_rcu(&node->list, &sel_netnode_hash[idx].list);\r\nif (sel_netnode_hash[idx].size == SEL_NETNODE_HASH_BKT_LIMIT) {\r\nstruct sel_netnode *tail;\r\ntail = list_entry(\r\nrcu_dereference_protected(sel_netnode_hash[idx].list.prev,\r\nlockdep_is_held(&sel_netnode_lock)),\r\nstruct sel_netnode, list);\r\nlist_del_rcu(&tail->list);\r\nkfree_rcu(tail, rcu);\r\n} else\r\nsel_netnode_hash[idx].size++;\r\n}\r\nstatic int sel_netnode_sid_slow(void *addr, u16 family, u32 *sid)\r\n{\r\nint ret = -ENOMEM;\r\nstruct sel_netnode *node;\r\nstruct sel_netnode *new = NULL;\r\nspin_lock_bh(&sel_netnode_lock);\r\nnode = sel_netnode_find(addr, family);\r\nif (node != NULL) {\r\n*sid = node->nsec.sid;\r\nspin_unlock_bh(&sel_netnode_lock);\r\nreturn 0;\r\n}\r\nnew = kzalloc(sizeof(*new), GFP_ATOMIC);\r\nif (new == NULL)\r\ngoto out;\r\nswitch (family) {\r\ncase PF_INET:\r\nret = security_node_sid(PF_INET,\r\naddr, sizeof(struct in_addr), sid);\r\nnew->nsec.addr.ipv4 = *(__be32 *)addr;\r\nbreak;\r\ncase PF_INET6:\r\nret = security_node_sid(PF_INET6,\r\naddr, sizeof(struct in6_addr), sid);\r\nnew->nsec.addr.ipv6 = *(struct in6_addr *)addr;\r\nbreak;\r\ndefault:\r\nBUG();\r\nret = -EINVAL;\r\n}\r\nif (ret != 0)\r\ngoto out;\r\nnew->nsec.family = family;\r\nnew->nsec.sid = *sid;\r\nsel_netnode_insert(new);\r\nout:\r\nspin_unlock_bh(&sel_netnode_lock);\r\nif (unlikely(ret)) {\r\nprintk(KERN_WARNING\r\n"SELinux: failure in sel_netnode_sid_slow(),"\r\n" unable to determine network node label\n");\r\nkfree(new);\r\n}\r\nreturn ret;\r\n}\r\nint sel_netnode_sid(void *addr, u16 family, u32 *sid)\r\n{\r\nstruct sel_netnode *node;\r\nrcu_read_lock();\r\nnode = sel_netnode_find(addr, family);\r\nif (node != NULL) {\r\n*sid = node->nsec.sid;\r\nrcu_read_unlock();\r\nreturn 0;\r\n}\r\nrcu_read_unlock();\r\nreturn sel_netnode_sid_slow(addr, family, sid);\r\n}\r\nstatic void sel_netnode_flush(void)\r\n{\r\nunsigned int idx;\r\nstruct sel_netnode *node, *node_tmp;\r\nspin_lock_bh(&sel_netnode_lock);\r\nfor (idx = 0; idx < SEL_NETNODE_HASH_SIZE; idx++) {\r\nlist_for_each_entry_safe(node, node_tmp,\r\n&sel_netnode_hash[idx].list, list) {\r\nlist_del_rcu(&node->list);\r\nkfree_rcu(node, rcu);\r\n}\r\nsel_netnode_hash[idx].size = 0;\r\n}\r\nspin_unlock_bh(&sel_netnode_lock);\r\n}\r\nstatic int sel_netnode_avc_callback(u32 event)\r\n{\r\nif (event == AVC_CALLBACK_RESET) {\r\nsel_netnode_flush();\r\nsynchronize_net();\r\n}\r\nreturn 0;\r\n}\r\nstatic __init int sel_netnode_init(void)\r\n{\r\nint iter;\r\nint ret;\r\nif (!selinux_enabled)\r\nreturn 0;\r\nfor (iter = 0; iter < SEL_NETNODE_HASH_SIZE; iter++) {\r\nINIT_LIST_HEAD(&sel_netnode_hash[iter].list);\r\nsel_netnode_hash[iter].size = 0;\r\n}\r\nret = avc_add_callback(sel_netnode_avc_callback, AVC_CALLBACK_RESET);\r\nif (ret != 0)\r\npanic("avc_add_callback() failed, error %d\n", ret);\r\nreturn ret;\r\n}

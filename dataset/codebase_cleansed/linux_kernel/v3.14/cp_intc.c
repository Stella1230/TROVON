static inline unsigned int cp_intc_read(unsigned offset)\r\n{\r\nreturn __raw_readl(davinci_intc_base + offset);\r\n}\r\nstatic inline void cp_intc_write(unsigned long value, unsigned offset)\r\n{\r\n__raw_writel(value, davinci_intc_base + offset);\r\n}\r\nstatic void cp_intc_ack_irq(struct irq_data *d)\r\n{\r\ncp_intc_write(d->hwirq, CP_INTC_SYS_STAT_IDX_CLR);\r\n}\r\nstatic void cp_intc_mask_irq(struct irq_data *d)\r\n{\r\ncp_intc_write(1, CP_INTC_HOST_ENABLE_IDX_CLR);\r\ncp_intc_write(d->hwirq, CP_INTC_SYS_ENABLE_IDX_CLR);\r\ncp_intc_write(1, CP_INTC_HOST_ENABLE_IDX_SET);\r\n}\r\nstatic void cp_intc_unmask_irq(struct irq_data *d)\r\n{\r\ncp_intc_write(d->hwirq, CP_INTC_SYS_ENABLE_IDX_SET);\r\n}\r\nstatic int cp_intc_set_irq_type(struct irq_data *d, unsigned int flow_type)\r\n{\r\nunsigned reg = BIT_WORD(d->hwirq);\r\nunsigned mask = BIT_MASK(d->hwirq);\r\nunsigned polarity = cp_intc_read(CP_INTC_SYS_POLARITY(reg));\r\nunsigned type = cp_intc_read(CP_INTC_SYS_TYPE(reg));\r\nswitch (flow_type) {\r\ncase IRQ_TYPE_EDGE_RISING:\r\npolarity |= mask;\r\ntype |= mask;\r\nbreak;\r\ncase IRQ_TYPE_EDGE_FALLING:\r\npolarity &= ~mask;\r\ntype |= mask;\r\nbreak;\r\ncase IRQ_TYPE_LEVEL_HIGH:\r\npolarity |= mask;\r\ntype &= ~mask;\r\nbreak;\r\ncase IRQ_TYPE_LEVEL_LOW:\r\npolarity &= ~mask;\r\ntype &= ~mask;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ncp_intc_write(polarity, CP_INTC_SYS_POLARITY(reg));\r\ncp_intc_write(type, CP_INTC_SYS_TYPE(reg));\r\nreturn 0;\r\n}\r\nstatic int cp_intc_set_wake(struct irq_data *d, unsigned int on)\r\n{\r\nreturn 0;\r\n}\r\nstatic int cp_intc_host_map(struct irq_domain *h, unsigned int virq,\r\nirq_hw_number_t hw)\r\n{\r\npr_debug("cp_intc_host_map(%d, 0x%lx)\n", virq, hw);\r\nirq_set_chip(virq, &cp_intc_irq_chip);\r\nset_irq_flags(virq, IRQF_VALID | IRQF_PROBE);\r\nirq_set_handler(virq, handle_edge_irq);\r\nreturn 0;\r\n}\r\nint __init cp_intc_of_init(struct device_node *node, struct device_node *parent)\r\n{\r\nu32 num_irq = davinci_soc_info.intc_irq_num;\r\nu8 *irq_prio = davinci_soc_info.intc_irq_prios;\r\nu32 *host_map = davinci_soc_info.intc_host_map;\r\nunsigned num_reg = BITS_TO_LONGS(num_irq);\r\nint i, irq_base;\r\ndavinci_intc_type = DAVINCI_INTC_TYPE_CP_INTC;\r\nif (node) {\r\ndavinci_intc_base = of_iomap(node, 0);\r\nif (of_property_read_u32(node, "ti,intc-size", &num_irq))\r\npr_warn("unable to get intc-size, default to %d\n",\r\nnum_irq);\r\n} else {\r\ndavinci_intc_base = ioremap(davinci_soc_info.intc_base, SZ_8K);\r\n}\r\nif (WARN_ON(!davinci_intc_base))\r\nreturn -EINVAL;\r\ncp_intc_write(0, CP_INTC_GLOBAL_ENABLE);\r\ncp_intc_write(0, CP_INTC_HOST_ENABLE(0));\r\nfor (i = 0; i < num_reg; i++)\r\ncp_intc_write(~0, CP_INTC_SYS_ENABLE_CLR(i));\r\ncp_intc_write(0, CP_INTC_CTRL);\r\ncp_intc_write(0, CP_INTC_HOST_CTRL);\r\nfor (i = 0; i < num_reg; i++)\r\ncp_intc_write(~0, CP_INTC_SYS_STAT_CLR(i));\r\ncp_intc_write(1, CP_INTC_HOST_ENABLE_IDX_SET);\r\nnum_reg = (num_irq + 3) >> 2;\r\nif (irq_prio) {\r\nunsigned j, k;\r\nu32 val;\r\nfor (k = i = 0; i < num_reg; i++) {\r\nfor (val = j = 0; j < 4; j++, k++) {\r\nval >>= 8;\r\nif (k < num_irq)\r\nval |= irq_prio[k] << 24;\r\n}\r\ncp_intc_write(val, CP_INTC_CHAN_MAP(i));\r\n}\r\n} else {\r\nfor (i = 0; i < num_reg; i++)\r\ncp_intc_write(0x0f0f0f0f, CP_INTC_CHAN_MAP(i));\r\n}\r\nif (host_map)\r\nfor (i = 0; host_map[i] != -1; i++)\r\ncp_intc_write(host_map[i], CP_INTC_HOST_MAP(i));\r\nirq_base = irq_alloc_descs(-1, 0, num_irq, 0);\r\nif (irq_base < 0) {\r\npr_warn("Couldn't allocate IRQ numbers\n");\r\nirq_base = 0;\r\n}\r\ncp_intc_domain = irq_domain_add_legacy(node, num_irq,\r\nirq_base, 0, &cp_intc_host_ops, NULL);\r\nif (!cp_intc_domain) {\r\npr_err("cp_intc: failed to allocate irq host!\n");\r\nreturn -EINVAL;\r\n}\r\ncp_intc_write(1, CP_INTC_GLOBAL_ENABLE);\r\nreturn 0;\r\n}\r\nvoid __init cp_intc_init(void)\r\n{\r\ncp_intc_of_init(NULL, NULL);\r\n}

static int da9210_set_current_limit(struct regulator_dev *rdev, int min_uA,\r\nint max_uA)\r\n{\r\nstruct da9210 *chip = rdev_get_drvdata(rdev);\r\nunsigned int sel;\r\nint i;\r\nfor (i = ARRAY_SIZE(da9210_buck_limits)-1; i >= 0; i--) {\r\nif (min_uA <= da9210_buck_limits[i] &&\r\nmax_uA >= da9210_buck_limits[i]) {\r\nsel = i;\r\nsel = sel << DA9210_BUCK_ILIM_SHIFT;\r\nreturn regmap_update_bits(chip->regmap,\r\nDA9210_REG_BUCK_ILIM,\r\nDA9210_BUCK_ILIM_MASK, sel);\r\n}\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int da9210_get_current_limit(struct regulator_dev *rdev)\r\n{\r\nstruct da9210 *chip = rdev_get_drvdata(rdev);\r\nunsigned int data;\r\nunsigned int sel;\r\nint ret;\r\nret = regmap_read(chip->regmap, DA9210_REG_BUCK_ILIM, &data);\r\nif (ret < 0)\r\nreturn ret;\r\nsel = (data & DA9210_BUCK_ILIM_MASK) >> DA9210_BUCK_ILIM_SHIFT;\r\nreturn da9210_buck_limits[sel];\r\n}\r\nstatic int da9210_i2c_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct da9210 *chip;\r\nstruct device *dev = &i2c->dev;\r\nstruct da9210_pdata *pdata = dev_get_platdata(dev);\r\nstruct regulator_dev *rdev = NULL;\r\nstruct regulator_config config = { };\r\nint error;\r\nchip = devm_kzalloc(&i2c->dev, sizeof(struct da9210), GFP_KERNEL);\r\nif (NULL == chip) {\r\ndev_err(&i2c->dev,\r\n"Cannot kzalloc memory for regulator structure\n");\r\nreturn -ENOMEM;\r\n}\r\nchip->regmap = devm_regmap_init_i2c(i2c, &da9210_regmap_config);\r\nif (IS_ERR(chip->regmap)) {\r\nerror = PTR_ERR(chip->regmap);\r\ndev_err(&i2c->dev, "Failed to allocate register map: %d\n",\r\nerror);\r\nreturn error;\r\n}\r\nconfig.dev = &i2c->dev;\r\nconfig.init_data = pdata ? &pdata->da9210_constraints :\r\nof_get_regulator_init_data(dev, dev->of_node);\r\nconfig.driver_data = chip;\r\nconfig.regmap = chip->regmap;\r\nconfig.of_node = dev->of_node;\r\nrdev = devm_regulator_register(&i2c->dev, &da9210_reg, &config);\r\nif (IS_ERR(rdev)) {\r\ndev_err(&i2c->dev, "Failed to register DA9210 regulator\n");\r\nreturn PTR_ERR(rdev);\r\n}\r\nchip->rdev = rdev;\r\ni2c_set_clientdata(i2c, chip);\r\nreturn 0;\r\n}

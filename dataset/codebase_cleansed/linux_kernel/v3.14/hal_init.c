static void rtl871x_load_fw_cb(const struct firmware *firmware, void *context)\r\n{\r\nstruct _adapter *padapter = context;\r\ncomplete(&padapter->rtl8712_fw_ready);\r\nif (!firmware) {\r\nstruct usb_device *udev = padapter->dvobjpriv.pusbdev;\r\nstruct usb_interface *pusb_intf = padapter->pusb_intf;\r\ndev_err(&udev->dev, "r8712u: Firmware request failed\n");\r\npadapter->fw_found = false;\r\nusb_put_dev(udev);\r\nusb_set_intfdata(pusb_intf, NULL);\r\nreturn;\r\n}\r\npadapter->fw = firmware;\r\npadapter->fw_found = true;\r\nregister_netdev(padapter->pnetdev);\r\n}\r\nint rtl871x_load_fw(struct _adapter *padapter)\r\n{\r\nstruct device *dev = &padapter->dvobjpriv.pusbdev->dev;\r\nint rc;\r\ninit_completion(&padapter->rtl8712_fw_ready);\r\ndev_info(dev, "r8712u: Loading firmware from \"%s\"\n", firmware_file);\r\nrc = request_firmware_nowait(THIS_MODULE, 1, firmware_file, dev,\r\nGFP_KERNEL, padapter, rtl871x_load_fw_cb);\r\nif (rc)\r\ndev_err(dev, "r8712u: Firmware request error %d\n", rc);\r\nreturn rc;\r\n}\r\nstatic u32 rtl871x_open_fw(struct _adapter *padapter, const u8 **ppmappedfw)\r\n{\r\nconst struct firmware **praw = &padapter->fw;\r\nif (padapter->fw->size > 200000) {\r\ndev_err(&padapter->pnetdev->dev, "r8172u: Badfw->size of %d\n",\r\n(int)padapter->fw->size);\r\nreturn 0;\r\n}\r\n*ppmappedfw = (u8 *)((*praw)->data);\r\nreturn (*praw)->size;\r\n}\r\nstatic void fill_fwpriv(struct _adapter *padapter, struct fw_priv *pfwpriv)\r\n{\r\nstruct dvobj_priv *pdvobj = (struct dvobj_priv *)&padapter->dvobjpriv;\r\nstruct registry_priv *pregpriv = &padapter->registrypriv;\r\nmemset(pfwpriv, 0, sizeof(struct fw_priv));\r\npfwpriv->hci_sel = RTL8712_HCI_TYPE_72USB;\r\npfwpriv->usb_ep_num = (u8)pdvobj->nr_endpoint;\r\npfwpriv->bw_40MHz_en = pregpriv->cbw40_enable;\r\nswitch (pregpriv->rf_config) {\r\ncase RTL8712_RF_1T1R:\r\npfwpriv->rf_config = RTL8712_RFC_1T1R;\r\nbreak;\r\ncase RTL8712_RF_2T2R:\r\npfwpriv->rf_config = RTL8712_RFC_2T2R;\r\nbreak;\r\ncase RTL8712_RF_1T2R:\r\ndefault:\r\npfwpriv->rf_config = RTL8712_RFC_1T2R;\r\n}\r\npfwpriv->mp_mode = (pregpriv->mp_mode == 1) ? 1 : 0;\r\npfwpriv->vcsType = pregpriv->vrtl_carrier_sense;\r\npfwpriv->vcsMode = pregpriv->vcs_type;\r\npfwpriv->turboMode = ((pregpriv->wifi_test == 1) ? 0 : 1);\r\npfwpriv->lowPowerMode = pregpriv->low_power;\r\n}\r\nstatic void update_fwhdr(struct fw_hdr *pfwhdr, const u8 *pmappedfw)\r\n{\r\npfwhdr->signature = le16_to_cpu(*(u16 *)pmappedfw);\r\npfwhdr->version = le16_to_cpu(*(u16 *)(pmappedfw+2));\r\npfwhdr->dmem_size = le32_to_cpu(*(uint *)(pmappedfw+4));\r\npfwhdr->img_IMEM_size = le32_to_cpu(*(uint *)(pmappedfw+8));\r\npfwhdr->img_SRAM_size = le32_to_cpu(*(uint *)(pmappedfw+12));\r\npfwhdr->fw_priv_sz = le32_to_cpu(*(uint *)(pmappedfw+16));\r\n}\r\nstatic u8 chk_fwhdr(struct fw_hdr *pfwhdr, u32 ulfilelength)\r\n{\r\nu32 fwhdrsz, fw_sz;\r\nu8 intf, rfconf;\r\nif ((pfwhdr->signature != 0x8712) && (pfwhdr->signature != 0x8192))\r\nreturn _FAIL;\r\nintf = (u8)((pfwhdr->version&0x3000) >> 12);\r\nrfconf = (u8)((pfwhdr->version&0xC000) >> 14);\r\nif (pfwhdr->fw_priv_sz != sizeof(struct fw_priv))\r\nreturn _FAIL;\r\nfwhdrsz = FIELD_OFFSET(struct fw_hdr, fwpriv) + pfwhdr->fw_priv_sz;\r\nfw_sz = fwhdrsz + pfwhdr->img_IMEM_size + pfwhdr->img_SRAM_size +\r\npfwhdr->dmem_size;\r\nif (fw_sz != ulfilelength)\r\nreturn _FAIL;\r\nreturn _SUCCESS;\r\n}\r\nstatic u8 rtl8712_dl_fw(struct _adapter *padapter)\r\n{\r\nsint i;\r\nu8 tmp8, tmp8_a;\r\nu16 tmp16;\r\nu32 maxlen = 0, tmp32;\r\nuint dump_imem_sz, imem_sz, dump_emem_sz, emem_sz;\r\nstruct fw_hdr fwhdr;\r\nu32 ulfilelength;\r\nconst u8 *pmappedfw = NULL;\r\nu8 *ptmpchar = NULL, *ppayload, *ptr;\r\nstruct tx_desc *ptx_desc;\r\nu32 txdscp_sz = sizeof(struct tx_desc);\r\nu8 ret = _FAIL;\r\nulfilelength = rtl871x_open_fw(padapter, &pmappedfw);\r\nif (pmappedfw && (ulfilelength > 0)) {\r\nupdate_fwhdr(&fwhdr, pmappedfw);\r\nif (chk_fwhdr(&fwhdr, ulfilelength) == _FAIL)\r\nreturn ret;\r\nfill_fwpriv(padapter, &fwhdr.fwpriv);\r\nmaxlen = (fwhdr.img_IMEM_size > fwhdr.img_SRAM_size) ?\r\nfwhdr.img_IMEM_size : fwhdr.img_SRAM_size;\r\nmaxlen += txdscp_sz;\r\nptmpchar = _malloc(maxlen + FWBUFF_ALIGN_SZ);\r\nif (ptmpchar == NULL)\r\nreturn ret;\r\nptx_desc = (struct tx_desc *)(ptmpchar + FWBUFF_ALIGN_SZ -\r\n((addr_t)(ptmpchar) & (FWBUFF_ALIGN_SZ - 1)));\r\nppayload = (u8 *)(ptx_desc) + txdscp_sz;\r\nptr = (u8 *)pmappedfw + FIELD_OFFSET(struct fw_hdr, fwpriv) +\r\nfwhdr.fw_priv_sz;\r\nimem_sz = fwhdr.img_IMEM_size;\r\ndo {\r\nmemset(ptx_desc, 0, TXDESC_SIZE);\r\nif (imem_sz > MAX_DUMP_FWSZ)\r\ndump_imem_sz = MAX_DUMP_FWSZ;\r\nelse {\r\ndump_imem_sz = imem_sz;\r\nptx_desc->txdw0 |= cpu_to_le32(BIT(28));\r\n}\r\nptx_desc->txdw0 |= cpu_to_le32(dump_imem_sz &\r\n0x0000ffff);\r\nmemcpy(ppayload, ptr, dump_imem_sz);\r\nr8712_write_mem(padapter, RTL8712_DMA_VOQ,\r\ndump_imem_sz + TXDESC_SIZE,\r\n(u8 *)ptx_desc);\r\nptr += dump_imem_sz;\r\nimem_sz -= dump_imem_sz;\r\n} while (imem_sz > 0);\r\ni = 10;\r\ntmp16 = r8712_read16(padapter, TCR);\r\nwhile (((tmp16 & _IMEM_CODE_DONE) == 0) && (i > 0)) {\r\nudelay(10);\r\ntmp16 = r8712_read16(padapter, TCR);\r\ni--;\r\n}\r\nif (i == 0 || (tmp16 & _IMEM_CHK_RPT) == 0)\r\ngoto exit_fail;\r\nemem_sz = fwhdr.img_SRAM_size;\r\ndo {\r\nmemset(ptx_desc, 0, TXDESC_SIZE);\r\nif (emem_sz > MAX_DUMP_FWSZ)\r\ndump_emem_sz = MAX_DUMP_FWSZ;\r\nelse {\r\ndump_emem_sz = emem_sz;\r\nptx_desc->txdw0 |= cpu_to_le32(BIT(28));\r\n}\r\nptx_desc->txdw0 |= cpu_to_le32(dump_emem_sz &\r\n0x0000ffff);\r\nmemcpy(ppayload, ptr, dump_emem_sz);\r\nr8712_write_mem(padapter, RTL8712_DMA_VOQ,\r\ndump_emem_sz+TXDESC_SIZE, (u8 *)ptx_desc);\r\nptr += dump_emem_sz;\r\nemem_sz -= dump_emem_sz;\r\n} while (emem_sz > 0);\r\ni = 5;\r\ntmp16 = r8712_read16(padapter, TCR);\r\nwhile (((tmp16 & _EMEM_CODE_DONE) == 0) && (i > 0)) {\r\nudelay(10);\r\ntmp16 = r8712_read16(padapter, TCR);\r\ni--;\r\n}\r\nif (i == 0 || (tmp16 & _EMEM_CHK_RPT) == 0)\r\ngoto exit_fail;\r\ntmp8 = r8712_read8(padapter, SYS_CLKR);\r\nr8712_write8(padapter, SYS_CLKR, tmp8|BIT(2));\r\ntmp8_a = r8712_read8(padapter, SYS_CLKR);\r\nif (tmp8_a != (tmp8|BIT(2)))\r\ngoto exit_fail;\r\ntmp8 = r8712_read8(padapter, SYS_FUNC_EN + 1);\r\nr8712_write8(padapter, SYS_FUNC_EN+1, tmp8|BIT(2));\r\ntmp8_a = r8712_read8(padapter, SYS_FUNC_EN + 1);\r\nif (tmp8_a != (tmp8|BIT(2)))\r\ngoto exit_fail;\r\ntmp32 = r8712_read32(padapter, TCR);\r\ni = 100;\r\ntmp16 = r8712_read16(padapter, TCR);\r\nwhile (((tmp16 & _IMEM_RDY) == 0) && (i > 0)) {\r\nmsleep(20);\r\ntmp16 = r8712_read16(padapter, TCR);\r\ni--;\r\n}\r\nif (i == 0) {\r\nr8712_write16(padapter, 0x10250348, 0xc000);\r\nr8712_write16(padapter, 0x10250348, 0xc001);\r\nr8712_write16(padapter, 0x10250348, 0x2000);\r\nr8712_write16(padapter, 0x10250348, 0x2001);\r\nr8712_write16(padapter, 0x10250348, 0x2002);\r\nr8712_write16(padapter, 0x10250348, 0x2003);\r\ngoto exit_fail;\r\n}\r\nmemset(ptx_desc, 0, TXDESC_SIZE);\r\nptx_desc->txdw0 |= cpu_to_le32(fwhdr.fw_priv_sz&0x0000ffff);\r\nptx_desc->txdw0 |= cpu_to_le32(BIT(28));\r\nmemcpy(ppayload, &fwhdr.fwpriv, fwhdr.fw_priv_sz);\r\nr8712_write_mem(padapter, RTL8712_DMA_VOQ,\r\nfwhdr.fw_priv_sz + TXDESC_SIZE, (u8 *)ptx_desc);\r\ni = 100;\r\ntmp16 = r8712_read16(padapter, TCR);\r\nwhile (((tmp16 & _DMEM_CODE_DONE) == 0) && (i > 0)) {\r\nmsleep(20);\r\ntmp16 = r8712_read16(padapter, TCR);\r\ni--;\r\n}\r\nif (i == 0)\r\ngoto exit_fail;\r\ntmp8 = r8712_read8(padapter, 0x1025000A);\r\nif (tmp8 & BIT(4))\r\ni = 60;\r\nelse\r\ni = 30;\r\ntmp16 = r8712_read16(padapter, TCR);\r\nwhile (((tmp16 & _FWRDY) == 0) && (i > 0)) {\r\nmsleep(100);\r\ntmp16 = r8712_read16(padapter, TCR);\r\ni--;\r\n}\r\nif (i == 0)\r\ngoto exit_fail;\r\n} else\r\ngoto exit_fail;\r\nret = _SUCCESS;\r\nexit_fail:\r\nkfree(ptmpchar);\r\nreturn ret;\r\n}\r\nuint rtl8712_hal_init(struct _adapter *padapter)\r\n{\r\nu32 val32;\r\nint i;\r\nif (rtl8712_dl_fw(padapter) != _SUCCESS)\r\nreturn _FAIL;\r\nnetdev_info(padapter->pnetdev, "1 RCR=0x%x\n",\r\nr8712_read32(padapter, RCR));\r\nval32 = r8712_read32(padapter, RCR);\r\nr8712_write32(padapter, RCR, (val32 | BIT(26)));\r\nnetdev_info(padapter->pnetdev, "2 RCR=0x%x\n",\r\nr8712_read32(padapter, RCR));\r\nval32 = r8712_read32(padapter, RCR);\r\nr8712_write32(padapter, RCR, (val32|BIT(25)));\r\nval32 = 0;\r\nval32 = r8712_read32(padapter, 0x10250040);\r\nr8712_write32(padapter, 0x10250040, (val32&0x00FFFFFF));\r\nr8712_write8(padapter, 0x102500B5, r8712_read8(padapter, 0x102500B5) |\r\nBIT(0));\r\nr8712_write8(padapter, 0x102500BD, r8712_read8(padapter, 0x102500BD) |\r\nBIT(7));\r\nr8712_write8(padapter, 0x102500D9, 1);\r\nr8712_write8(padapter, 0x1025FE5B, 0x04);\r\nr8712_write8(padapter, 0x1025fe5C, r8712_read8(padapter, 0x1025fe5C)\r\n| BIT(7));\r\nfor (i = 0; i < 6; i++)\r\npadapter->eeprompriv.mac_addr[i] = r8712_read8(padapter,\r\nMACID + i);\r\nreturn _SUCCESS;\r\n}\r\nuint rtl8712_hal_deinit(struct _adapter *padapter)\r\n{\r\nr8712_write8(padapter, RF_CTRL, 0x00);\r\nmsleep(20);\r\nr8712_write8(padapter, SYS_CLKR+1, 0x38);\r\nr8712_write8(padapter, SYS_FUNC_EN+1, 0x70);\r\nr8712_write8(padapter, PMC_FSM, 0x06);\r\nr8712_write8(padapter, SYS_ISO_CTRL, 0xF9);\r\nr8712_write8(padapter, SYS_ISO_CTRL+1, 0xe8);\r\nr8712_write8(padapter, AFE_PLL_CTRL, 0x00);\r\nr8712_write8(padapter, LDOA15_CTRL, 0x54);\r\nr8712_write8(padapter, SYS_FUNC_EN+1, 0x50);\r\nr8712_write8(padapter, LDOV12D_CTRL, 0x24);\r\nr8712_write8(padapter, AFE_MISC, 0x30);\r\nr8712_write8(padapter, SPS0_CTRL, 0x56);\r\nr8712_write8(padapter, SPS0_CTRL+1, 0x43);\r\nreturn _SUCCESS;\r\n}\r\nuint rtl871x_hal_init(struct _adapter *padapter)\r\n{\r\npadapter->hw_init_completed = false;\r\nif (padapter->halpriv.hal_bus_init == NULL)\r\nreturn _FAIL;\r\nelse {\r\nif (padapter->halpriv.hal_bus_init(padapter) != _SUCCESS)\r\nreturn _FAIL;\r\n}\r\nif (rtl8712_hal_init(padapter) == _SUCCESS)\r\npadapter->hw_init_completed = true;\r\nelse {\r\npadapter->hw_init_completed = false;\r\nreturn _FAIL;\r\n}\r\nreturn _SUCCESS;\r\n}

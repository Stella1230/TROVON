static void spear_adc_set_status(struct spear_adc_info *info, u32 val)\r\n{\r\n__raw_writel(val, &info->adc_base_spear6xx->status);\r\n}\r\nstatic void spear_adc_set_clk(struct spear_adc_info *info, u32 val)\r\n{\r\nu32 clk_high, clk_low, count;\r\nu32 apb_clk = clk_get_rate(info->clk);\r\ncount = (apb_clk + val - 1) / val;\r\nclk_low = count / 2;\r\nclk_high = count - clk_low;\r\ninfo->current_clk = apb_clk / count;\r\n__raw_writel(CLK_LOW(clk_low) | CLK_HIGH(clk_high),\r\n&info->adc_base_spear6xx->clk);\r\n}\r\nstatic void spear_adc_set_ctrl(struct spear_adc_info *info, int n,\r\nu32 val)\r\n{\r\n__raw_writel(val, &info->adc_base_spear6xx->ch_ctrl[n]);\r\n}\r\nstatic u32 spear_adc_get_average(struct spear_adc_info *info)\r\n{\r\nif (of_device_is_compatible(info->np, "st,spear600-adc")) {\r\nreturn __raw_readl(&info->adc_base_spear6xx->average.msb) &\r\nDATA_MASK;\r\n} else {\r\nreturn __raw_readl(&info->adc_base_spear3xx->average) &\r\nDATA_MASK;\r\n}\r\n}\r\nstatic void spear_adc_set_scanrate(struct spear_adc_info *info, u32 rate)\r\n{\r\nif (of_device_is_compatible(info->np, "st,spear600-adc")) {\r\n__raw_writel(SCAN_RATE_LO(rate),\r\n&info->adc_base_spear6xx->scan_rate_lo);\r\n__raw_writel(SCAN_RATE_HI(rate),\r\n&info->adc_base_spear6xx->scan_rate_hi);\r\n} else {\r\n__raw_writel(rate, &info->adc_base_spear3xx->scan_rate);\r\n}\r\n}\r\nstatic int spear_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint *val,\r\nint *val2,\r\nlong mask)\r\n{\r\nstruct spear_adc_info *info = iio_priv(indio_dev);\r\nu32 status;\r\nswitch (mask) {\r\ncase IIO_CHAN_INFO_RAW:\r\nmutex_lock(&indio_dev->mlock);\r\nstatus = CHANNEL_NUM(chan->channel) |\r\nAVG_SAMPLE(info->avg_samples) |\r\nSTART_CONVERSION | ADC_ENABLE;\r\nif (info->vref_external == 0)\r\nstatus |= VREF_INTERNAL;\r\nspear_adc_set_status(info, status);\r\nwait_for_completion(&info->completion);\r\n*val = info->value;\r\nmutex_unlock(&indio_dev->mlock);\r\nreturn IIO_VAL_INT;\r\ncase IIO_CHAN_INFO_SCALE:\r\n*val = info->vref_external;\r\n*val2 = DATA_BITS;\r\nreturn IIO_VAL_FRACTIONAL_LOG2;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic irqreturn_t spear_adc_isr(int irq, void *dev_id)\r\n{\r\nstruct spear_adc_info *info = (struct spear_adc_info *)dev_id;\r\ninfo->value = spear_adc_get_average(info);\r\ncomplete(&info->completion);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int spear_adc_configure(struct spear_adc_info *info)\r\n{\r\nint i;\r\nspear_adc_set_status(info, 0);\r\n__raw_writel(0, &info->adc_base_spear6xx->clk);\r\nfor (i = 0; i < 8; i++)\r\nspear_adc_set_ctrl(info, i, 0);\r\nspear_adc_set_scanrate(info, 0);\r\nspear_adc_set_clk(info, info->sampling_freq);\r\nreturn 0;\r\n}\r\nstatic ssize_t spear_adc_read_frequency(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct spear_adc_info *info = iio_priv(indio_dev);\r\nreturn sprintf(buf, "%d\n", info->current_clk);\r\n}\r\nstatic ssize_t spear_adc_write_frequency(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct spear_adc_info *info = iio_priv(indio_dev);\r\nu32 clk_high, clk_low, count;\r\nu32 apb_clk = clk_get_rate(info->clk);\r\nunsigned long lval;\r\nint ret;\r\nret = kstrtoul(buf, 10, &lval);\r\nif (ret)\r\nreturn ret;\r\nmutex_lock(&indio_dev->mlock);\r\nif ((lval < CLK_MIN) || (lval > CLK_MAX)) {\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\ncount = (apb_clk + lval - 1) / lval;\r\nclk_low = count / 2;\r\nclk_high = count - clk_low;\r\ninfo->current_clk = apb_clk / count;\r\nspear_adc_set_clk(info, lval);\r\nout:\r\nmutex_unlock(&indio_dev->mlock);\r\nreturn ret ? ret : len;\r\n}\r\nstatic int spear_adc_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct device *dev = &pdev->dev;\r\nstruct spear_adc_info *info;\r\nstruct iio_dev *iodev = NULL;\r\nint ret = -ENODEV;\r\nint irq;\r\niodev = devm_iio_device_alloc(dev, sizeof(struct spear_adc_info));\r\nif (!iodev) {\r\ndev_err(dev, "failed allocating iio device\n");\r\nreturn -ENOMEM;\r\n}\r\ninfo = iio_priv(iodev);\r\ninfo->np = np;\r\ninfo->adc_base_spear6xx = of_iomap(np, 0);\r\nif (!info->adc_base_spear6xx) {\r\ndev_err(dev, "failed mapping memory\n");\r\nreturn -ENOMEM;\r\n}\r\ninfo->adc_base_spear3xx =\r\n(struct adc_regs_spear3xx __iomem *)info->adc_base_spear6xx;\r\ninfo->clk = clk_get(dev, NULL);\r\nif (IS_ERR(info->clk)) {\r\ndev_err(dev, "failed getting clock\n");\r\ngoto errout1;\r\n}\r\nret = clk_prepare_enable(info->clk);\r\nif (ret) {\r\ndev_err(dev, "failed enabling clock\n");\r\ngoto errout2;\r\n}\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq <= 0) {\r\ndev_err(dev, "failed getting interrupt resource\n");\r\nret = -EINVAL;\r\ngoto errout3;\r\n}\r\nret = devm_request_irq(dev, irq, spear_adc_isr, 0, MOD_NAME, info);\r\nif (ret < 0) {\r\ndev_err(dev, "failed requesting interrupt\n");\r\ngoto errout3;\r\n}\r\nif (of_property_read_u32(np, "sampling-frequency",\r\n&info->sampling_freq)) {\r\ndev_err(dev, "sampling-frequency missing in DT\n");\r\nret = -EINVAL;\r\ngoto errout3;\r\n}\r\nof_property_read_u32(np, "average-samples", &info->avg_samples);\r\nof_property_read_u32(np, "vref-external", &info->vref_external);\r\nspear_adc_configure(info);\r\nplatform_set_drvdata(pdev, iodev);\r\ninit_completion(&info->completion);\r\niodev->name = MOD_NAME;\r\niodev->dev.parent = dev;\r\niodev->info = &spear_adc_iio_info;\r\niodev->modes = INDIO_DIRECT_MODE;\r\niodev->channels = spear_adc_iio_channels;\r\niodev->num_channels = ARRAY_SIZE(spear_adc_iio_channels);\r\nret = iio_device_register(iodev);\r\nif (ret)\r\ngoto errout3;\r\ndev_info(dev, "SPEAR ADC driver loaded, IRQ %d\n", irq);\r\nreturn 0;\r\nerrout3:\r\nclk_disable_unprepare(info->clk);\r\nerrout2:\r\nclk_put(info->clk);\r\nerrout1:\r\niounmap(info->adc_base_spear6xx);\r\nreturn ret;\r\n}\r\nstatic int spear_adc_remove(struct platform_device *pdev)\r\n{\r\nstruct iio_dev *iodev = platform_get_drvdata(pdev);\r\nstruct spear_adc_info *info = iio_priv(iodev);\r\niio_device_unregister(iodev);\r\nclk_disable_unprepare(info->clk);\r\nclk_put(info->clk);\r\niounmap(info->adc_base_spear6xx);\r\nreturn 0;\r\n}

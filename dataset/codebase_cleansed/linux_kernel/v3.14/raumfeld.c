static void w1_enable_external_pullup(int enable)\r\n{\r\ngpio_set_value(GPIO_W1_PULLUP_ENABLE, enable);\r\nmsleep(100);\r\n}\r\nstatic void __init raumfeld_w1_init(void)\r\n{\r\nint ret = gpio_request(GPIO_W1_PULLUP_ENABLE,\r\n"W1 external pullup enable");\r\nif (ret < 0)\r\npr_warning("Unable to request GPIO_W1_PULLUP_ENABLE\n");\r\nelse\r\ngpio_direction_output(GPIO_W1_PULLUP_ENABLE, 0);\r\nplatform_device_register(&raumfeld_w1_gpio_device);\r\n}\r\nstatic void __init raumfeld_lcd_init(void)\r\n{\r\nint ret;\r\nret = gpio_request(GPIO_TFT_VA_EN, "display VA enable");\r\nif (ret < 0)\r\npr_warning("Unable to request GPIO_TFT_VA_EN\n");\r\nelse\r\ngpio_direction_output(GPIO_TFT_VA_EN, 1);\r\nmsleep(100);\r\nret = gpio_request(GPIO_DISPLAY_ENABLE, "display enable");\r\nif (ret < 0)\r\npr_warning("Unable to request GPIO_DISPLAY_ENABLE\n");\r\nelse\r\ngpio_direction_output(GPIO_DISPLAY_ENABLE, 1);\r\nif ((system_rev & 0xff) == 2) {\r\nplatform_device_register(&raumfeld_lt3593_device);\r\n} else {\r\nmfp_cfg_t raumfeld_pwm_pin_config = GPIO17_PWM0_OUT;\r\npxa3xx_mfp_config(&raumfeld_pwm_pin_config, 1);\r\nplatform_device_register(&raumfeld_pwm_backlight_device);\r\n}\r\npxa_set_fb_info(NULL, &raumfeld_sharp_lcd_info);\r\nplatform_device_register(&pxa3xx_device_gcu);\r\n}\r\nstatic int raumfeld_mci_init(struct device *dev, irq_handler_t isr, void *data)\r\n{\r\ngpio_set_value(GPIO_W2W_RESET, 1);\r\ngpio_set_value(GPIO_W2W_PDN, 1);\r\nreturn 0;\r\n}\r\nstatic void raumfeld_mci_exit(struct device *dev, void *data)\r\n{\r\ngpio_set_value(GPIO_W2W_RESET, 0);\r\ngpio_set_value(GPIO_W2W_PDN, 0);\r\n}\r\nstatic int power_supply_init(struct device *dev)\r\n{\r\nreturn 0;\r\n}\r\nstatic void power_supply_exit(struct device *dev)\r\n{\r\n}\r\nstatic int raumfeld_is_ac_online(void)\r\n{\r\nreturn !gpio_get_value(GPIO_CHARGE_DC_OK);\r\n}\r\nstatic int raumfeld_is_usb_online(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic void raumfeld_power_signal_charged(void)\r\n{\r\nstruct power_supply *psy =\r\npower_supply_get_by_name(raumfeld_power_supplicants[0]);\r\nif (psy)\r\npower_supply_set_battery_charged(psy);\r\n}\r\nstatic int raumfeld_power_resume(void)\r\n{\r\nif (!gpio_get_value(GPIO_CHARGE_DONE))\r\nraumfeld_power_signal_charged();\r\nreturn 0;\r\n}\r\nstatic irqreturn_t charge_done_irq(int irq, void *dev_id)\r\n{\r\nraumfeld_power_signal_charged();\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void __init raumfeld_power_init(void)\r\n{\r\nint ret;\r\nret = gpio_request(GPIO_CHRG_PEN2, "CHRG_PEN2");\r\nif (ret < 0)\r\npr_warning("Unable to request GPIO_CHRG_PEN2\n");\r\nelse\r\ngpio_direction_output(GPIO_CHRG_PEN2, 1);\r\nret = gpio_request(GPIO_CHARGE_DC_OK, "CABLE_DC_OK");\r\nif (ret < 0)\r\npr_warning("Unable to request GPIO_CHARGE_DC_OK\n");\r\nret = gpio_request(GPIO_CHARGE_USB_SUSP, "CHARGE_USB_SUSP");\r\nif (ret < 0)\r\npr_warning("Unable to request GPIO_CHARGE_USB_SUSP\n");\r\nelse\r\ngpio_direction_output(GPIO_CHARGE_USB_SUSP, 0);\r\npower_supply_resources[0].start = gpio_to_irq(GPIO_CHARGE_DC_OK);\r\npower_supply_resources[0].end = gpio_to_irq(GPIO_CHARGE_DC_OK);\r\nret = request_irq(gpio_to_irq(GPIO_CHARGE_DONE),\r\n&charge_done_irq, IORESOURCE_IRQ_LOWEDGE,\r\n"charge_done", NULL);\r\nif (ret < 0)\r\nprintk(KERN_ERR "%s: unable to register irq %d\n", __func__,\r\nGPIO_CHARGE_DONE);\r\nelse\r\nplatform_device_register(&raumfeld_power_supply);\r\n}\r\nstatic void __init raumfeld_audio_init(void)\r\n{\r\nint ret;\r\nret = gpio_request(GPIO_CODEC_RESET, "cs4270 reset");\r\nif (ret < 0)\r\npr_warning("unable to request GPIO_CODEC_RESET\n");\r\nelse\r\ngpio_direction_output(GPIO_CODEC_RESET, 1);\r\nret = gpio_request(GPIO_SPDIF_RESET, "ak4104 s/pdif reset");\r\nif (ret < 0)\r\npr_warning("unable to request GPIO_SPDIF_RESET\n");\r\nelse\r\ngpio_direction_output(GPIO_SPDIF_RESET, 1);\r\nret = gpio_request(GPIO_MCLK_RESET, "MCLK reset");\r\nif (ret < 0)\r\npr_warning("unable to request GPIO_MCLK_RESET\n");\r\nelse\r\ngpio_direction_output(GPIO_MCLK_RESET, 1);\r\nplatform_add_devices(ARRAY_AND_SIZE(audio_regulator_devices));\r\n}\r\nstatic void __init raumfeld_common_init(void)\r\n{\r\nint ret;\r\nif ((system_rev & 0xff) > 1) {\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(gpio_keys_button); i++)\r\nif (!strcmp(gpio_keys_button[i].desc, "on_off button"))\r\ngpio_keys_button[i].active_low = 1;\r\n}\r\nenable_irq_wake(IRQ_WAKEUP0);\r\npxa3xx_set_nand_info(&raumfeld_nand_info);\r\npxa3xx_set_i2c_power_info(NULL);\r\npxa_set_ohci_info(&raumfeld_ohci_info);\r\npxa_set_mci_info(&raumfeld_mci_platform_data);\r\npxa_set_i2c_info(NULL);\r\npxa_set_ffuart_info(NULL);\r\nret = gpio_request(GPIO_W2W_RESET, "Wi2Wi reset");\r\nif (ret < 0)\r\npr_warning("Unable to request GPIO_W2W_RESET\n");\r\nelse\r\ngpio_direction_output(GPIO_W2W_RESET, 0);\r\nret = gpio_request(GPIO_W2W_PDN, "Wi2Wi powerup");\r\nif (ret < 0)\r\npr_warning("Unable to request GPIO_W2W_PDN\n");\r\nelse\r\ngpio_direction_output(GPIO_W2W_PDN, 0);\r\nret = gpio_request(GPIO_SHUTDOWN_SUPPLY, "supply shutdown");\r\nif (ret < 0)\r\npr_warning("Unable to request GPIO_SHUTDOWN_SUPPLY\n");\r\nelse\r\ngpio_direction_output(GPIO_SHUTDOWN_SUPPLY, 0);\r\nplatform_add_devices(ARRAY_AND_SIZE(raumfeld_common_devices));\r\ni2c_register_board_info(1, &raumfeld_pwri2c_board_info, 1);\r\n}\r\nstatic void __init raumfeld_controller_init(void)\r\n{\r\nint ret;\r\npxa3xx_mfp_config(ARRAY_AND_SIZE(raumfeld_controller_pin_config));\r\nplatform_device_register(&rotary_encoder_device);\r\nspi_register_board_info(ARRAY_AND_SIZE(controller_spi_devices));\r\ni2c_register_board_info(0, &raumfeld_controller_i2c_board_info, 1);\r\nret = gpio_request(GPIO_SHUTDOWN_BATT, "battery shutdown");\r\nif (ret < 0)\r\npr_warning("Unable to request GPIO_SHUTDOWN_BATT\n");\r\nelse\r\ngpio_direction_output(GPIO_SHUTDOWN_BATT, 0);\r\nraumfeld_common_init();\r\nraumfeld_power_init();\r\nraumfeld_lcd_init();\r\nraumfeld_w1_init();\r\n}\r\nstatic void __init raumfeld_connector_init(void)\r\n{\r\npxa3xx_mfp_config(ARRAY_AND_SIZE(raumfeld_connector_pin_config));\r\nspi_register_board_info(ARRAY_AND_SIZE(connector_spi_devices));\r\ni2c_register_board_info(0, &raumfeld_connector_i2c_board_info, 1);\r\nplatform_device_register(&smc91x_device);\r\nraumfeld_audio_init();\r\nraumfeld_common_init();\r\n}\r\nstatic void __init raumfeld_speaker_init(void)\r\n{\r\npxa3xx_mfp_config(ARRAY_AND_SIZE(raumfeld_speaker_pin_config));\r\nspi_register_board_info(ARRAY_AND_SIZE(speaker_spi_devices));\r\ni2c_register_board_info(0, &raumfeld_connector_i2c_board_info, 1);\r\nplatform_device_register(&smc91x_device);\r\nplatform_device_register(&rotary_encoder_device);\r\nraumfeld_audio_init();\r\nraumfeld_common_init();\r\n}

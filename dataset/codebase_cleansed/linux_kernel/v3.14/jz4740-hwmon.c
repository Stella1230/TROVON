static ssize_t jz4740_hwmon_show_name(struct device *dev,\r\nstruct device_attribute *dev_attr, char *buf)\r\n{\r\nreturn sprintf(buf, "jz4740\n");\r\n}\r\nstatic irqreturn_t jz4740_hwmon_irq(int irq, void *data)\r\n{\r\nstruct jz4740_hwmon *hwmon = data;\r\ncomplete(&hwmon->read_completion);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic ssize_t jz4740_hwmon_read_adcin(struct device *dev,\r\nstruct device_attribute *dev_attr, char *buf)\r\n{\r\nstruct jz4740_hwmon *hwmon = dev_get_drvdata(dev);\r\nstruct completion *completion = &hwmon->read_completion;\r\nlong t;\r\nunsigned long val;\r\nint ret;\r\nmutex_lock(&hwmon->lock);\r\nreinit_completion(completion);\r\nenable_irq(hwmon->irq);\r\nhwmon->cell->enable(to_platform_device(dev));\r\nt = wait_for_completion_interruptible_timeout(completion, HZ);\r\nif (t > 0) {\r\nval = readw(hwmon->base) & 0xfff;\r\nval = (val * 3300) >> 12;\r\nret = sprintf(buf, "%lu\n", val);\r\n} else {\r\nret = t ? t : -ETIMEDOUT;\r\n}\r\nhwmon->cell->disable(to_platform_device(dev));\r\ndisable_irq(hwmon->irq);\r\nmutex_unlock(&hwmon->lock);\r\nreturn ret;\r\n}\r\nstatic int jz4740_hwmon_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct jz4740_hwmon *hwmon;\r\nhwmon = devm_kzalloc(&pdev->dev, sizeof(*hwmon), GFP_KERNEL);\r\nif (!hwmon)\r\nreturn -ENOMEM;\r\nhwmon->cell = mfd_get_cell(pdev);\r\nhwmon->irq = platform_get_irq(pdev, 0);\r\nif (hwmon->irq < 0) {\r\ndev_err(&pdev->dev, "Failed to get platform irq: %d\n",\r\nhwmon->irq);\r\nreturn hwmon->irq;\r\n}\r\nhwmon->mem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!hwmon->mem) {\r\ndev_err(&pdev->dev, "Failed to get platform mmio resource\n");\r\nreturn -ENOENT;\r\n}\r\nhwmon->mem = devm_request_mem_region(&pdev->dev, hwmon->mem->start,\r\nresource_size(hwmon->mem), pdev->name);\r\nif (!hwmon->mem) {\r\ndev_err(&pdev->dev, "Failed to request mmio memory region\n");\r\nreturn -EBUSY;\r\n}\r\nhwmon->base = devm_ioremap_nocache(&pdev->dev, hwmon->mem->start,\r\nresource_size(hwmon->mem));\r\nif (!hwmon->base) {\r\ndev_err(&pdev->dev, "Failed to ioremap mmio memory\n");\r\nreturn -EBUSY;\r\n}\r\ninit_completion(&hwmon->read_completion);\r\nmutex_init(&hwmon->lock);\r\nplatform_set_drvdata(pdev, hwmon);\r\nret = devm_request_irq(&pdev->dev, hwmon->irq, jz4740_hwmon_irq, 0,\r\npdev->name, hwmon);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to request irq: %d\n", ret);\r\nreturn ret;\r\n}\r\ndisable_irq(hwmon->irq);\r\nret = sysfs_create_group(&pdev->dev.kobj, &jz4740_hwmon_attr_group);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to create sysfs group: %d\n", ret);\r\nreturn ret;\r\n}\r\nhwmon->hwmon = hwmon_device_register(&pdev->dev);\r\nif (IS_ERR(hwmon->hwmon)) {\r\nret = PTR_ERR(hwmon->hwmon);\r\ngoto err_remove_file;\r\n}\r\nreturn 0;\r\nerr_remove_file:\r\nsysfs_remove_group(&pdev->dev.kobj, &jz4740_hwmon_attr_group);\r\nreturn ret;\r\n}\r\nstatic int jz4740_hwmon_remove(struct platform_device *pdev)\r\n{\r\nstruct jz4740_hwmon *hwmon = platform_get_drvdata(pdev);\r\nhwmon_device_unregister(hwmon->hwmon);\r\nsysfs_remove_group(&pdev->dev.kobj, &jz4740_hwmon_attr_group);\r\nreturn 0;\r\n}

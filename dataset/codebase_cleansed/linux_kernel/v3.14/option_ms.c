static int option_rezero(struct us_data *us)\r\n{\r\nconst unsigned char rezero_msg[] = {\r\n0x55, 0x53, 0x42, 0x43, 0x78, 0x56, 0x34, 0x12,\r\n0x01, 0x00, 0x00, 0x00, 0x80, 0x00, 0x06, 0x01,\r\n0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00\r\n};\r\nchar *buffer;\r\nint result;\r\nusb_stor_dbg(us, "Option MS: %s\n", "DEVICE MODE SWITCH");\r\nbuffer = kzalloc(RESPONSE_LEN, GFP_KERNEL);\r\nif (buffer == NULL)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nmemcpy(buffer, rezero_msg, sizeof(rezero_msg));\r\nresult = usb_stor_bulk_transfer_buf(us,\r\nus->send_bulk_pipe,\r\nbuffer, sizeof(rezero_msg), NULL);\r\nif (result != USB_STOR_XFER_GOOD) {\r\nresult = USB_STOR_XFER_ERROR;\r\ngoto out;\r\n}\r\nusb_stor_bulk_transfer_buf(us,\r\nus->recv_bulk_pipe,\r\nbuffer, RESPONSE_LEN, NULL);\r\nusb_stor_bulk_transfer_buf(us,\r\nus->recv_bulk_pipe,\r\nbuffer, 13, NULL);\r\nresult = USB_STOR_XFER_GOOD;\r\nout:\r\nkfree(buffer);\r\nreturn result;\r\n}\r\nstatic int option_inquiry(struct us_data *us)\r\n{\r\nconst unsigned char inquiry_msg[] = {\r\n0x55, 0x53, 0x42, 0x43, 0x12, 0x34, 0x56, 0x78,\r\n0x24, 0x00, 0x00, 0x00, 0x80, 0x00, 0x06, 0x12,\r\n0x00, 0x00, 0x00, 0x24, 0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00\r\n};\r\nchar *buffer;\r\nint result;\r\nusb_stor_dbg(us, "Option MS: %s\n", "device inquiry for vendor name");\r\nbuffer = kzalloc(0x24, GFP_KERNEL);\r\nif (buffer == NULL)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nmemcpy(buffer, inquiry_msg, sizeof(inquiry_msg));\r\nresult = usb_stor_bulk_transfer_buf(us,\r\nus->send_bulk_pipe,\r\nbuffer, sizeof(inquiry_msg), NULL);\r\nif (result != USB_STOR_XFER_GOOD) {\r\nresult = USB_STOR_XFER_ERROR;\r\ngoto out;\r\n}\r\nresult = usb_stor_bulk_transfer_buf(us,\r\nus->recv_bulk_pipe,\r\nbuffer, 0x24, NULL);\r\nif (result != USB_STOR_XFER_GOOD) {\r\nresult = USB_STOR_XFER_ERROR;\r\ngoto out;\r\n}\r\nresult = memcmp(buffer+8, "Option", 6);\r\nif (result != 0)\r\nresult = memcmp(buffer+8, "ZCOPTION", 8);\r\nusb_stor_bulk_transfer_buf(us,\r\nus->recv_bulk_pipe,\r\nbuffer, 13, NULL);\r\nout:\r\nkfree(buffer);\r\nreturn result;\r\n}\r\nint option_ms_init(struct us_data *us)\r\n{\r\nint result;\r\nusb_stor_dbg(us, "Option MS: %s\n", "option_ms_init called");\r\nresult = option_inquiry(us);\r\nif (result != 0) {\r\nusb_stor_dbg(us, "Option MS: %s\n",\r\n"vendor is not Option or not determinable, no action taken");\r\nreturn 0;\r\n} else\r\nusb_stor_dbg(us, "Option MS: %s\n",\r\n"this is a genuine Option device, proceeding");\r\nif (option_zero_cd == ZCD_FORCE_MODEM) {\r\nusb_stor_dbg(us, "Option MS: %s\n", "Forcing Modem Mode");\r\nresult = option_rezero(us);\r\nif (result != USB_STOR_XFER_GOOD)\r\nusb_stor_dbg(us, "Option MS: %s\n",\r\n"Failed to switch to modem mode");\r\nreturn -EIO;\r\n} else if (option_zero_cd == ZCD_ALLOW_MS) {\r\nusb_stor_dbg(us, "Option MS: %s\n",\r\n"Allowing Mass Storage Mode if device requests it");\r\n}\r\nreturn 0;\r\n}

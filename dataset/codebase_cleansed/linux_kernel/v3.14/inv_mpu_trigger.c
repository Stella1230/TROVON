static void inv_scan_query(struct iio_dev *indio_dev)\r\n{\r\nstruct inv_mpu6050_state *st = iio_priv(indio_dev);\r\nst->chip_config.gyro_fifo_enable =\r\ntest_bit(INV_MPU6050_SCAN_GYRO_X,\r\nindio_dev->active_scan_mask) ||\r\ntest_bit(INV_MPU6050_SCAN_GYRO_Y,\r\nindio_dev->active_scan_mask) ||\r\ntest_bit(INV_MPU6050_SCAN_GYRO_Z,\r\nindio_dev->active_scan_mask);\r\nst->chip_config.accl_fifo_enable =\r\ntest_bit(INV_MPU6050_SCAN_ACCL_X,\r\nindio_dev->active_scan_mask) ||\r\ntest_bit(INV_MPU6050_SCAN_ACCL_Y,\r\nindio_dev->active_scan_mask) ||\r\ntest_bit(INV_MPU6050_SCAN_ACCL_Z,\r\nindio_dev->active_scan_mask);\r\n}\r\nstatic int inv_mpu6050_set_enable(struct iio_dev *indio_dev, bool enable)\r\n{\r\nstruct inv_mpu6050_state *st = iio_priv(indio_dev);\r\nint result;\r\nif (enable) {\r\nresult = inv_mpu6050_set_power_itg(st, true);\r\nif (result)\r\nreturn result;\r\ninv_scan_query(indio_dev);\r\nif (st->chip_config.gyro_fifo_enable) {\r\nresult = inv_mpu6050_switch_engine(st, true,\r\nINV_MPU6050_BIT_PWR_GYRO_STBY);\r\nif (result)\r\nreturn result;\r\n}\r\nif (st->chip_config.accl_fifo_enable) {\r\nresult = inv_mpu6050_switch_engine(st, true,\r\nINV_MPU6050_BIT_PWR_ACCL_STBY);\r\nif (result)\r\nreturn result;\r\n}\r\nresult = inv_reset_fifo(indio_dev);\r\nif (result)\r\nreturn result;\r\n} else {\r\nresult = inv_mpu6050_write_reg(st, st->reg->fifo_en, 0);\r\nif (result)\r\nreturn result;\r\nresult = inv_mpu6050_write_reg(st, st->reg->int_enable, 0);\r\nif (result)\r\nreturn result;\r\nresult = inv_mpu6050_write_reg(st, st->reg->user_ctrl, 0);\r\nif (result)\r\nreturn result;\r\nresult = inv_mpu6050_switch_engine(st, false,\r\nINV_MPU6050_BIT_PWR_GYRO_STBY);\r\nif (result)\r\nreturn result;\r\nresult = inv_mpu6050_switch_engine(st, false,\r\nINV_MPU6050_BIT_PWR_ACCL_STBY);\r\nif (result)\r\nreturn result;\r\nresult = inv_mpu6050_set_power_itg(st, false);\r\nif (result)\r\nreturn result;\r\n}\r\nst->chip_config.enable = enable;\r\nreturn 0;\r\n}\r\nstatic int inv_mpu_data_rdy_trigger_set_state(struct iio_trigger *trig,\r\nbool state)\r\n{\r\nreturn inv_mpu6050_set_enable(iio_trigger_get_drvdata(trig), state);\r\n}\r\nint inv_mpu6050_probe_trigger(struct iio_dev *indio_dev)\r\n{\r\nint ret;\r\nstruct inv_mpu6050_state *st = iio_priv(indio_dev);\r\nst->trig = iio_trigger_alloc("%s-dev%d",\r\nindio_dev->name,\r\nindio_dev->id);\r\nif (st->trig == NULL) {\r\nret = -ENOMEM;\r\ngoto error_ret;\r\n}\r\nret = request_irq(st->client->irq, &iio_trigger_generic_data_rdy_poll,\r\nIRQF_TRIGGER_RISING,\r\n"inv_mpu",\r\nst->trig);\r\nif (ret)\r\ngoto error_free_trig;\r\nst->trig->dev.parent = &st->client->dev;\r\nst->trig->ops = &inv_mpu_trigger_ops;\r\niio_trigger_set_drvdata(st->trig, indio_dev);\r\nret = iio_trigger_register(st->trig);\r\nif (ret)\r\ngoto error_free_irq;\r\nindio_dev->trig = st->trig;\r\nreturn 0;\r\nerror_free_irq:\r\nfree_irq(st->client->irq, st->trig);\r\nerror_free_trig:\r\niio_trigger_free(st->trig);\r\nerror_ret:\r\nreturn ret;\r\n}\r\nvoid inv_mpu6050_remove_trigger(struct inv_mpu6050_state *st)\r\n{\r\niio_trigger_unregister(st->trig);\r\nfree_irq(st->client->irq, st->trig);\r\niio_trigger_free(st->trig);\r\n}

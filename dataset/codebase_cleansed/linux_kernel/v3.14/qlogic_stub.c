static struct Scsi_Host *qlogic_detect(struct scsi_host_template *host,\r\nstruct pcmcia_device *link, int qbase, int qlirq)\r\n{\r\nint qltyp;\r\nint qinitid;\r\nstruct Scsi_Host *shost;\r\nstruct qlogicfas408_priv *priv;\r\nqltyp = qlogicfas408_get_chip_type(qbase, INT_TYPE);\r\nqinitid = host->this_id;\r\nif (qinitid < 0)\r\nqinitid = 7;\r\nqlogicfas408_setup(qbase, qinitid, INT_TYPE);\r\nhost->name = qlogic_name;\r\nshost = scsi_host_alloc(host, sizeof(struct qlogicfas408_priv));\r\nif (!shost)\r\ngoto err;\r\nshost->io_port = qbase;\r\nshost->n_io_port = 16;\r\nshost->dma_channel = -1;\r\nif (qlirq != -1)\r\nshost->irq = qlirq;\r\npriv = get_priv_by_host(shost);\r\npriv->qlirq = qlirq;\r\npriv->qbase = qbase;\r\npriv->qinitid = qinitid;\r\npriv->shost = shost;\r\npriv->int_type = INT_TYPE;\r\nif (request_irq(qlirq, qlogicfas408_ihandl, 0, qlogic_name, shost))\r\ngoto free_scsi_host;\r\nsprintf(priv->qinfo,\r\n"Qlogicfas Driver version 0.46, chip %02X at %03X, IRQ %d, TPdma:%d",\r\nqltyp, qbase, qlirq, QL_TURBO_PDMA);\r\nif (scsi_add_host(shost, NULL))\r\ngoto free_interrupt;\r\nscsi_scan_host(shost);\r\nreturn shost;\r\nfree_interrupt:\r\nfree_irq(qlirq, shost);\r\nfree_scsi_host:\r\nscsi_host_put(shost);\r\nerr:\r\nreturn NULL;\r\n}\r\nstatic int qlogic_probe(struct pcmcia_device *link)\r\n{\r\nscsi_info_t *info;\r\ndev_dbg(&link->dev, "qlogic_attach()\n");\r\ninfo = kzalloc(sizeof(*info), GFP_KERNEL);\r\nif (!info)\r\nreturn -ENOMEM;\r\ninfo->p_dev = link;\r\nlink->priv = info;\r\nlink->config_flags |= CONF_ENABLE_IRQ | CONF_AUTO_SET_IO;\r\nlink->config_regs = PRESENT_OPTION;\r\nreturn qlogic_config(link);\r\n}\r\nstatic void qlogic_detach(struct pcmcia_device *link)\r\n{\r\ndev_dbg(&link->dev, "qlogic_detach\n");\r\nqlogic_release(link);\r\nkfree(link->priv);\r\n}\r\nstatic int qlogic_config_check(struct pcmcia_device *p_dev, void *priv_data)\r\n{\r\np_dev->io_lines = 10;\r\np_dev->resource[0]->flags &= ~IO_DATA_PATH_WIDTH;\r\np_dev->resource[0]->flags |= IO_DATA_PATH_WIDTH_AUTO;\r\nif (p_dev->resource[0]->start == 0)\r\nreturn -ENODEV;\r\nreturn pcmcia_request_io(p_dev);\r\n}\r\nstatic int qlogic_config(struct pcmcia_device * link)\r\n{\r\nscsi_info_t *info = link->priv;\r\nint ret;\r\nstruct Scsi_Host *host;\r\ndev_dbg(&link->dev, "qlogic_config\n");\r\nret = pcmcia_loop_config(link, qlogic_config_check, NULL);\r\nif (ret)\r\ngoto failed;\r\nif (!link->irq)\r\ngoto failed;\r\nret = pcmcia_enable_device(link);\r\nif (ret)\r\ngoto failed;\r\nif ((info->manf_id == MANFID_MACNICA) || (info->manf_id == MANFID_PIONEER) || (info->manf_id == 0x0098)) {\r\noutb(0xb4, link->resource[0]->start + 0xd);\r\noutb(0x24, link->resource[0]->start + 0x9);\r\noutb(0x04, link->resource[0]->start + 0xd);\r\n}\r\nif (resource_size(link->resource[0]) == 32)\r\nhost = qlogic_detect(&qlogicfas_driver_template, link,\r\nlink->resource[0]->start + 16, link->irq);\r\nelse\r\nhost = qlogic_detect(&qlogicfas_driver_template, link,\r\nlink->resource[0]->start, link->irq);\r\nif (!host) {\r\nprintk(KERN_INFO "%s: no SCSI devices found\n", qlogic_name);\r\ngoto failed;\r\n}\r\ninfo->host = host;\r\nreturn 0;\r\nfailed:\r\npcmcia_disable_device(link);\r\nreturn -ENODEV;\r\n}\r\nstatic void qlogic_release(struct pcmcia_device *link)\r\n{\r\nscsi_info_t *info = link->priv;\r\ndev_dbg(&link->dev, "qlogic_release\n");\r\nscsi_remove_host(info->host);\r\nfree_irq(link->irq, info->host);\r\npcmcia_disable_device(link);\r\nscsi_host_put(info->host);\r\n}\r\nstatic int qlogic_resume(struct pcmcia_device *link)\r\n{\r\nscsi_info_t *info = link->priv;\r\npcmcia_enable_device(link);\r\nif ((info->manf_id == MANFID_MACNICA) ||\r\n(info->manf_id == MANFID_PIONEER) ||\r\n(info->manf_id == 0x0098)) {\r\noutb(0x80, link->resource[0]->start + 0xd);\r\noutb(0x24, link->resource[0]->start + 0x9);\r\noutb(0x04, link->resource[0]->start + 0xd);\r\n}\r\nqlogicfas408_bus_reset(NULL);\r\nreturn 0;\r\n}\r\nstatic int __init init_qlogic_cs(void)\r\n{\r\nreturn pcmcia_register_driver(&qlogic_cs_driver);\r\n}\r\nstatic void __exit exit_qlogic_cs(void)\r\n{\r\npcmcia_unregister_driver(&qlogic_cs_driver);\r\n}

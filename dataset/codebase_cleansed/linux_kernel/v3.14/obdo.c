void obdo_set_parent_fid(struct obdo *dst, const struct lu_fid *parent)\r\n{\r\ndst->o_parent_oid = fid_oid(parent);\r\ndst->o_parent_seq = fid_seq(parent);\r\ndst->o_parent_ver = fid_ver(parent);\r\ndst->o_valid |= OBD_MD_FLGENER | OBD_MD_FLFID;\r\n}\r\nvoid obdo_from_inode(struct obdo *dst, struct inode *src, obd_flag valid)\r\n{\r\nobd_flag newvalid = 0;\r\nif (valid & (OBD_MD_FLCTIME | OBD_MD_FLMTIME))\r\nCDEBUG(D_INODE, "valid %x, new time %lu/%lu\n",\r\nvalid, LTIME_S(src->i_mtime),\r\nLTIME_S(src->i_ctime));\r\nif (valid & OBD_MD_FLATIME) {\r\ndst->o_atime = LTIME_S(src->i_atime);\r\nnewvalid |= OBD_MD_FLATIME;\r\n}\r\nif (valid & OBD_MD_FLMTIME) {\r\ndst->o_mtime = LTIME_S(src->i_mtime);\r\nnewvalid |= OBD_MD_FLMTIME;\r\n}\r\nif (valid & OBD_MD_FLCTIME) {\r\ndst->o_ctime = LTIME_S(src->i_ctime);\r\nnewvalid |= OBD_MD_FLCTIME;\r\n}\r\nif (valid & OBD_MD_FLSIZE) {\r\ndst->o_size = i_size_read(src);\r\nnewvalid |= OBD_MD_FLSIZE;\r\n}\r\nif (valid & OBD_MD_FLBLOCKS) {\r\ndst->o_blocks = src->i_blocks;\r\nnewvalid |= OBD_MD_FLBLOCKS;\r\n}\r\nif (valid & OBD_MD_FLBLKSZ) {\r\ndst->o_blksize = ll_inode_blksize(src);\r\nnewvalid |= OBD_MD_FLBLKSZ;\r\n}\r\nif (valid & OBD_MD_FLTYPE) {\r\ndst->o_mode = (dst->o_mode & S_IALLUGO) |\r\n(src->i_mode & S_IFMT);\r\nnewvalid |= OBD_MD_FLTYPE;\r\n}\r\nif (valid & OBD_MD_FLMODE) {\r\ndst->o_mode = (dst->o_mode & S_IFMT) |\r\n(src->i_mode & S_IALLUGO);\r\nnewvalid |= OBD_MD_FLMODE;\r\n}\r\nif (valid & OBD_MD_FLUID) {\r\ndst->o_uid = from_kuid(&init_user_ns, src->i_uid);\r\nnewvalid |= OBD_MD_FLUID;\r\n}\r\nif (valid & OBD_MD_FLGID) {\r\ndst->o_gid = from_kgid(&init_user_ns, src->i_gid);\r\nnewvalid |= OBD_MD_FLGID;\r\n}\r\nif (valid & OBD_MD_FLFLAGS) {\r\ndst->o_flags = ll_inode_flags(src);\r\nnewvalid |= OBD_MD_FLFLAGS;\r\n}\r\ndst->o_valid |= newvalid;\r\n}\r\nvoid obdo_cpy_md(struct obdo *dst, struct obdo *src, obd_flag valid)\r\n{\r\nCDEBUG(D_INODE, "src obdo "DOSTID" valid "LPX64", dst obdo "DOSTID"\n",\r\nPOSTID(&src->o_oi), src->o_valid, POSTID(&dst->o_oi));\r\nif (valid & OBD_MD_FLATIME)\r\ndst->o_atime = src->o_atime;\r\nif (valid & OBD_MD_FLMTIME)\r\ndst->o_mtime = src->o_mtime;\r\nif (valid & OBD_MD_FLCTIME)\r\ndst->o_ctime = src->o_ctime;\r\nif (valid & OBD_MD_FLSIZE)\r\ndst->o_size = src->o_size;\r\nif (valid & OBD_MD_FLBLOCKS)\r\ndst->o_blocks = src->o_blocks;\r\nif (valid & OBD_MD_FLBLKSZ)\r\ndst->o_blksize = src->o_blksize;\r\nif (valid & OBD_MD_FLTYPE)\r\ndst->o_mode = (dst->o_mode & ~S_IFMT) | (src->o_mode & S_IFMT);\r\nif (valid & OBD_MD_FLMODE)\r\ndst->o_mode = (dst->o_mode & S_IFMT) | (src->o_mode & ~S_IFMT);\r\nif (valid & OBD_MD_FLUID)\r\ndst->o_uid = src->o_uid;\r\nif (valid & OBD_MD_FLGID)\r\ndst->o_gid = src->o_gid;\r\nif (valid & OBD_MD_FLFLAGS)\r\ndst->o_flags = src->o_flags;\r\nif (valid & OBD_MD_FLFID) {\r\ndst->o_parent_seq = src->o_parent_seq;\r\ndst->o_parent_ver = src->o_parent_ver;\r\n}\r\nif (valid & OBD_MD_FLGENER)\r\ndst->o_parent_oid = src->o_parent_oid;\r\nif (valid & OBD_MD_FLHANDLE)\r\ndst->o_handle = src->o_handle;\r\nif (valid & OBD_MD_FLCOOKIE)\r\ndst->o_lcookie = src->o_lcookie;\r\ndst->o_valid |= valid;\r\n}\r\nint obdo_cmp_md(struct obdo *dst, struct obdo *src, obd_flag compare)\r\n{\r\nint res = 0;\r\nif ( compare & OBD_MD_FLATIME )\r\nres = (res || (dst->o_atime != src->o_atime));\r\nif ( compare & OBD_MD_FLMTIME )\r\nres = (res || (dst->o_mtime != src->o_mtime));\r\nif ( compare & OBD_MD_FLCTIME )\r\nres = (res || (dst->o_ctime != src->o_ctime));\r\nif ( compare & OBD_MD_FLSIZE )\r\nres = (res || (dst->o_size != src->o_size));\r\nif ( compare & OBD_MD_FLBLOCKS )\r\nres = (res || (dst->o_blocks != src->o_blocks));\r\nif ( compare & OBD_MD_FLBLKSZ )\r\nres = (res || (dst->o_blksize != src->o_blksize));\r\nif ( compare & OBD_MD_FLTYPE )\r\nres = (res || (((dst->o_mode ^ src->o_mode) & S_IFMT) != 0));\r\nif ( compare & OBD_MD_FLMODE )\r\nres = (res || (((dst->o_mode ^ src->o_mode) & ~S_IFMT) != 0));\r\nif ( compare & OBD_MD_FLUID )\r\nres = (res || (dst->o_uid != src->o_uid));\r\nif ( compare & OBD_MD_FLGID )\r\nres = (res || (dst->o_gid != src->o_gid));\r\nif ( compare & OBD_MD_FLFLAGS )\r\nres = (res || (dst->o_flags != src->o_flags));\r\nif ( compare & OBD_MD_FLNLINK )\r\nres = (res || (dst->o_nlink != src->o_nlink));\r\nif ( compare & OBD_MD_FLFID ) {\r\nres = (res || (dst->o_parent_seq != src->o_parent_seq));\r\nres = (res || (dst->o_parent_ver != src->o_parent_ver));\r\n}\r\nif ( compare & OBD_MD_FLGENER )\r\nres = (res || (dst->o_parent_oid != src->o_parent_oid));\r\nreturn res;\r\n}\r\nvoid obdo_to_ioobj(struct obdo *oa, struct obd_ioobj *ioobj)\r\n{\r\nioobj->ioo_oid = oa->o_oi;\r\nif (unlikely(!(oa->o_valid & OBD_MD_FLGROUP)))\r\nostid_set_seq_mdt0(&ioobj->ioo_oid);\r\nioobj->ioo_max_brw = 0;\r\n}\r\nvoid obdo_from_iattr(struct obdo *oa, struct iattr *attr, unsigned int ia_valid)\r\n{\r\nif (ia_valid & ATTR_ATIME) {\r\noa->o_atime = LTIME_S(attr->ia_atime);\r\noa->o_valid |= OBD_MD_FLATIME;\r\n}\r\nif (ia_valid & ATTR_MTIME) {\r\noa->o_mtime = LTIME_S(attr->ia_mtime);\r\noa->o_valid |= OBD_MD_FLMTIME;\r\n}\r\nif (ia_valid & ATTR_CTIME) {\r\noa->o_ctime = LTIME_S(attr->ia_ctime);\r\noa->o_valid |= OBD_MD_FLCTIME;\r\n}\r\nif (ia_valid & ATTR_SIZE) {\r\noa->o_size = attr->ia_size;\r\noa->o_valid |= OBD_MD_FLSIZE;\r\n}\r\nif (ia_valid & ATTR_MODE) {\r\noa->o_mode = attr->ia_mode;\r\noa->o_valid |= OBD_MD_FLTYPE | OBD_MD_FLMODE;\r\nif (!in_group_p(make_kgid(&init_user_ns, oa->o_gid)) &&\r\n!cfs_capable(CFS_CAP_FSETID))\r\noa->o_mode &= ~S_ISGID;\r\n}\r\nif (ia_valid & ATTR_UID) {\r\noa->o_uid = from_kuid(&init_user_ns, attr->ia_uid);\r\noa->o_valid |= OBD_MD_FLUID;\r\n}\r\nif (ia_valid & ATTR_GID) {\r\noa->o_gid = from_kgid(&init_user_ns, attr->ia_gid);\r\noa->o_valid |= OBD_MD_FLGID;\r\n}\r\n}\r\nvoid iattr_from_obdo(struct iattr *attr, struct obdo *oa, obd_flag valid)\r\n{\r\nvalid &= oa->o_valid;\r\nif (valid & (OBD_MD_FLCTIME | OBD_MD_FLMTIME))\r\nCDEBUG(D_INODE, "valid "LPX64", new time "LPU64"/"LPU64"\n",\r\noa->o_valid, oa->o_mtime, oa->o_ctime);\r\nattr->ia_valid = 0;\r\nif (valid & OBD_MD_FLATIME) {\r\nLTIME_S(attr->ia_atime) = oa->o_atime;\r\nattr->ia_valid |= ATTR_ATIME;\r\n}\r\nif (valid & OBD_MD_FLMTIME) {\r\nLTIME_S(attr->ia_mtime) = oa->o_mtime;\r\nattr->ia_valid |= ATTR_MTIME;\r\n}\r\nif (valid & OBD_MD_FLCTIME) {\r\nLTIME_S(attr->ia_ctime) = oa->o_ctime;\r\nattr->ia_valid |= ATTR_CTIME;\r\n}\r\nif (valid & OBD_MD_FLSIZE) {\r\nattr->ia_size = oa->o_size;\r\nattr->ia_valid |= ATTR_SIZE;\r\n}\r\n#if 0\r\nif (valid & OBD_MD_FLTYPE) {\r\nattr->ia_mode = (attr->ia_mode & ~S_IFMT)|(oa->o_mode & S_IFMT);\r\nattr->ia_valid |= ATTR_MODE;\r\n}\r\n#endif\r\nif (valid & OBD_MD_FLMODE) {\r\nattr->ia_mode = (attr->ia_mode & S_IFMT)|(oa->o_mode & ~S_IFMT);\r\nattr->ia_valid |= ATTR_MODE;\r\nif (!in_group_p(make_kgid(&init_user_ns, oa->o_gid)) &&\r\n!cfs_capable(CFS_CAP_FSETID))\r\nattr->ia_mode &= ~S_ISGID;\r\n}\r\nif (valid & OBD_MD_FLUID) {\r\nattr->ia_uid = make_kuid(&init_user_ns, oa->o_uid);\r\nattr->ia_valid |= ATTR_UID;\r\n}\r\nif (valid & OBD_MD_FLGID) {\r\nattr->ia_gid = make_kgid(&init_user_ns, oa->o_gid);\r\nattr->ia_valid |= ATTR_GID;\r\n}\r\n}\r\nvoid md_from_obdo(struct md_op_data *op_data, struct obdo *oa, obd_flag valid)\r\n{\r\niattr_from_obdo(&op_data->op_attr, oa, valid);\r\nif (valid & OBD_MD_FLBLOCKS) {\r\nop_data->op_attr_blocks = oa->o_blocks;\r\nop_data->op_attr.ia_valid |= ATTR_BLOCKS;\r\n}\r\nif (valid & OBD_MD_FLFLAGS) {\r\n((struct ll_iattr *)&op_data->op_attr)->ia_attr_flags =\r\noa->o_flags;\r\nop_data->op_attr.ia_valid |= ATTR_ATTR_FLAG;\r\n}\r\n}\r\nvoid obdo_from_md(struct obdo *oa, struct md_op_data *op_data,\r\nunsigned int valid)\r\n{\r\nobdo_from_iattr(oa, &op_data->op_attr, valid);\r\nif (valid & ATTR_BLOCKS) {\r\noa->o_blocks = op_data->op_attr_blocks;\r\noa->o_valid |= OBD_MD_FLBLOCKS;\r\n}\r\nif (valid & ATTR_ATTR_FLAG) {\r\noa->o_flags =\r\n((struct ll_iattr *)&op_data->op_attr)->ia_attr_flags;\r\noa->o_valid |= OBD_MD_FLFLAGS;\r\n}\r\n}\r\nvoid obdo_cpu_to_le(struct obdo *dobdo, struct obdo *sobdo)\r\n{\r\ndobdo->o_size = cpu_to_le64(sobdo->o_size);\r\ndobdo->o_mtime = cpu_to_le64(sobdo->o_mtime);\r\ndobdo->o_atime = cpu_to_le64(sobdo->o_atime);\r\ndobdo->o_ctime = cpu_to_le64(sobdo->o_ctime);\r\ndobdo->o_blocks = cpu_to_le64(sobdo->o_blocks);\r\ndobdo->o_mode = cpu_to_le32(sobdo->o_mode);\r\ndobdo->o_uid = cpu_to_le32(sobdo->o_uid);\r\ndobdo->o_gid = cpu_to_le32(sobdo->o_gid);\r\ndobdo->o_flags = cpu_to_le32(sobdo->o_flags);\r\ndobdo->o_nlink = cpu_to_le32(sobdo->o_nlink);\r\ndobdo->o_blksize = cpu_to_le32(sobdo->o_blksize);\r\ndobdo->o_valid = cpu_to_le64(sobdo->o_valid);\r\n}\r\nvoid obdo_le_to_cpu(struct obdo *dobdo, struct obdo *sobdo)\r\n{\r\ndobdo->o_size = le64_to_cpu(sobdo->o_size);\r\ndobdo->o_mtime = le64_to_cpu(sobdo->o_mtime);\r\ndobdo->o_atime = le64_to_cpu(sobdo->o_atime);\r\ndobdo->o_ctime = le64_to_cpu(sobdo->o_ctime);\r\ndobdo->o_blocks = le64_to_cpu(sobdo->o_blocks);\r\ndobdo->o_mode = le32_to_cpu(sobdo->o_mode);\r\ndobdo->o_uid = le32_to_cpu(sobdo->o_uid);\r\ndobdo->o_gid = le32_to_cpu(sobdo->o_gid);\r\ndobdo->o_flags = le32_to_cpu(sobdo->o_flags);\r\ndobdo->o_nlink = le32_to_cpu(sobdo->o_nlink);\r\ndobdo->o_blksize = le32_to_cpu(sobdo->o_blksize);\r\ndobdo->o_valid = le64_to_cpu(sobdo->o_valid);\r\n}

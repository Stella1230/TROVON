__sum16 csum_ipv6_magic(const struct in6_addr *saddr,\r\nconst struct in6_addr *daddr,\r\n__u32 len, unsigned short proto,\r\n__wsum csum)\r\n{\r\nint carry;\r\n__u32 ulen;\r\n__u32 uproto;\r\n__u32 sum = (__force u32)csum;\r\nsum += (__force u32)saddr->s6_addr32[0];\r\ncarry = (sum < (__force u32)saddr->s6_addr32[0]);\r\nsum += carry;\r\nsum += (__force u32)saddr->s6_addr32[1];\r\ncarry = (sum < (__force u32)saddr->s6_addr32[1]);\r\nsum += carry;\r\nsum += (__force u32)saddr->s6_addr32[2];\r\ncarry = (sum < (__force u32)saddr->s6_addr32[2]);\r\nsum += carry;\r\nsum += (__force u32)saddr->s6_addr32[3];\r\ncarry = (sum < (__force u32)saddr->s6_addr32[3]);\r\nsum += carry;\r\nsum += (__force u32)daddr->s6_addr32[0];\r\ncarry = (sum < (__force u32)daddr->s6_addr32[0]);\r\nsum += carry;\r\nsum += (__force u32)daddr->s6_addr32[1];\r\ncarry = (sum < (__force u32)daddr->s6_addr32[1]);\r\nsum += carry;\r\nsum += (__force u32)daddr->s6_addr32[2];\r\ncarry = (sum < (__force u32)daddr->s6_addr32[2]);\r\nsum += carry;\r\nsum += (__force u32)daddr->s6_addr32[3];\r\ncarry = (sum < (__force u32)daddr->s6_addr32[3]);\r\nsum += carry;\r\nulen = (__force u32)htonl((__u32) len);\r\nsum += ulen;\r\ncarry = (sum < ulen);\r\nsum += carry;\r\nuproto = (__force u32)htonl(proto);\r\nsum += uproto;\r\ncarry = (sum < uproto);\r\nsum += carry;\r\nreturn csum_fold((__force __wsum)sum);\r\n}\r\nint udp6_csum_init(struct sk_buff *skb, struct udphdr *uh, int proto)\r\n{\r\nint err;\r\nUDP_SKB_CB(skb)->partial_cov = 0;\r\nUDP_SKB_CB(skb)->cscov = skb->len;\r\nif (proto == IPPROTO_UDPLITE) {\r\nerr = udplite_checksum_init(skb, uh);\r\nif (err)\r\nreturn err;\r\n}\r\nif (uh->check == 0) {\r\nLIMIT_NETDEBUG(KERN_INFO "IPv6: udp checksum is 0\n");\r\nreturn 1;\r\n}\r\nif (skb->ip_summed == CHECKSUM_COMPLETE &&\r\n!csum_ipv6_magic(&ipv6_hdr(skb)->saddr, &ipv6_hdr(skb)->daddr,\r\nskb->len, proto, skb->csum))\r\nskb->ip_summed = CHECKSUM_UNNECESSARY;\r\nif (!skb_csum_unnecessary(skb))\r\nskb->csum = ~csum_unfold(csum_ipv6_magic(&ipv6_hdr(skb)->saddr,\r\n&ipv6_hdr(skb)->daddr,\r\nskb->len, proto, 0));\r\nreturn 0;\r\n}

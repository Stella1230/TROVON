static void\r\nvxfs_typdump(struct vxfs_typed *typ)\r\n{\r\nprintk(KERN_DEBUG "type=%Lu ", typ->vt_hdr >> VXFS_TYPED_TYPESHIFT);\r\nprintk("offset=%Lx ", typ->vt_hdr & VXFS_TYPED_OFFSETMASK);\r\nprintk("block=%x ", typ->vt_block);\r\nprintk("size=%x\n", typ->vt_size);\r\n}\r\nstatic daddr_t\r\nvxfs_bmap_ext4(struct inode *ip, long bn)\r\n{\r\nstruct super_block *sb = ip->i_sb;\r\nstruct vxfs_inode_info *vip = VXFS_INO(ip);\r\nunsigned long bsize = sb->s_blocksize;\r\nu32 indsize = vip->vii_ext4.ve4_indsize;\r\nint i;\r\nif (indsize > sb->s_blocksize)\r\ngoto fail_size;\r\nfor (i = 0; i < VXFS_NDADDR; i++) {\r\nstruct direct *d = vip->vii_ext4.ve4_direct + i;\r\nif (bn >= 0 && bn < d->size)\r\nreturn (bn + d->extent);\r\nbn -= d->size;\r\n}\r\nif ((bn / (indsize * indsize * bsize / 4)) == 0) {\r\nstruct buffer_head *buf;\r\ndaddr_t bno;\r\nu32 *indir;\r\nbuf = sb_bread(sb, vip->vii_ext4.ve4_indir[0]);\r\nif (!buf || !buffer_mapped(buf))\r\ngoto fail_buf;\r\nindir = (u32 *)buf->b_data;\r\nbno = indir[(bn/indsize) % (indsize*bn)] + (bn%indsize);\r\nbrelse(buf);\r\nreturn bno;\r\n} else\r\nprintk(KERN_WARNING "no matching indir?");\r\nreturn 0;\r\nfail_size:\r\nprintk("vxfs: indirect extent too big!\n");\r\nfail_buf:\r\nreturn 0;\r\n}\r\nstatic daddr_t\r\nvxfs_bmap_indir(struct inode *ip, long indir, int size, long block)\r\n{\r\nstruct buffer_head *bp = NULL;\r\ndaddr_t pblock = 0;\r\nint i;\r\nfor (i = 0; i < size * VXFS_TYPED_PER_BLOCK(ip->i_sb); i++) {\r\nstruct vxfs_typed *typ;\r\nint64_t off;\r\nbp = sb_bread(ip->i_sb,\r\nindir + (i / VXFS_TYPED_PER_BLOCK(ip->i_sb)));\r\nif (!bp || !buffer_mapped(bp))\r\nreturn 0;\r\ntyp = ((struct vxfs_typed *)bp->b_data) +\r\n(i % VXFS_TYPED_PER_BLOCK(ip->i_sb));\r\noff = (typ->vt_hdr & VXFS_TYPED_OFFSETMASK);\r\nif (block < off) {\r\nbrelse(bp);\r\ncontinue;\r\n}\r\nswitch ((u_int32_t)(typ->vt_hdr >> VXFS_TYPED_TYPESHIFT)) {\r\ncase VXFS_TYPED_INDIRECT:\r\npblock = vxfs_bmap_indir(ip, typ->vt_block,\r\ntyp->vt_size, block - off);\r\nif (pblock == -2)\r\nbreak;\r\ngoto out;\r\ncase VXFS_TYPED_DATA:\r\nif ((block - off) >= typ->vt_size)\r\nbreak;\r\npblock = (typ->vt_block + block - off);\r\ngoto out;\r\ncase VXFS_TYPED_INDIRECT_DEV4:\r\ncase VXFS_TYPED_DATA_DEV4: {\r\nstruct vxfs_typed_dev4 *typ4 =\r\n(struct vxfs_typed_dev4 *)typ;\r\nprintk(KERN_INFO "\n\nTYPED_DEV4 detected!\n");\r\nprintk(KERN_INFO "block: %Lu\tsize: %Ld\tdev: %d\n",\r\n(unsigned long long) typ4->vd4_block,\r\n(unsigned long long) typ4->vd4_size,\r\ntyp4->vd4_dev);\r\ngoto fail;\r\n}\r\ndefault:\r\nBUG();\r\n}\r\nbrelse(bp);\r\n}\r\nfail:\r\npblock = 0;\r\nout:\r\nbrelse(bp);\r\nreturn (pblock);\r\n}\r\nstatic daddr_t\r\nvxfs_bmap_typed(struct inode *ip, long iblock)\r\n{\r\nstruct vxfs_inode_info *vip = VXFS_INO(ip);\r\ndaddr_t pblock = 0;\r\nint i;\r\nfor (i = 0; i < VXFS_NTYPED; i++) {\r\nstruct vxfs_typed *typ = vip->vii_org.typed + i;\r\nint64_t off = (typ->vt_hdr & VXFS_TYPED_OFFSETMASK);\r\n#ifdef DIAGNOSTIC\r\nvxfs_typdump(typ);\r\n#endif\r\nif (iblock < off)\r\ncontinue;\r\nswitch ((u_int32_t)(typ->vt_hdr >> VXFS_TYPED_TYPESHIFT)) {\r\ncase VXFS_TYPED_INDIRECT:\r\npblock = vxfs_bmap_indir(ip, typ->vt_block,\r\ntyp->vt_size, iblock - off);\r\nif (pblock == -2)\r\nbreak;\r\nreturn (pblock);\r\ncase VXFS_TYPED_DATA:\r\nif ((iblock - off) < typ->vt_size)\r\nreturn (typ->vt_block + iblock - off);\r\nbreak;\r\ncase VXFS_TYPED_INDIRECT_DEV4:\r\ncase VXFS_TYPED_DATA_DEV4: {\r\nstruct vxfs_typed_dev4 *typ4 =\r\n(struct vxfs_typed_dev4 *)typ;\r\nprintk(KERN_INFO "\n\nTYPED_DEV4 detected!\n");\r\nprintk(KERN_INFO "block: %Lu\tsize: %Ld\tdev: %d\n",\r\n(unsigned long long) typ4->vd4_block,\r\n(unsigned long long) typ4->vd4_size,\r\ntyp4->vd4_dev);\r\nreturn 0;\r\n}\r\ndefault:\r\nBUG();\r\n}\r\n}\r\nreturn 0;\r\n}\r\ndaddr_t\r\nvxfs_bmap1(struct inode *ip, long iblock)\r\n{\r\nstruct vxfs_inode_info *vip = VXFS_INO(ip);\r\nif (VXFS_ISEXT4(vip))\r\nreturn vxfs_bmap_ext4(ip, iblock);\r\nif (VXFS_ISTYPED(vip))\r\nreturn vxfs_bmap_typed(ip, iblock);\r\nif (VXFS_ISNONE(vip))\r\ngoto unsupp;\r\nif (VXFS_ISIMMED(vip))\r\ngoto unsupp;\r\nprintk(KERN_WARNING "vxfs: inode %ld has no valid orgtype (%x)\n",\r\nip->i_ino, vip->vii_orgtype);\r\nBUG();\r\nunsupp:\r\nprintk(KERN_WARNING "vxfs: inode %ld has an unsupported orgtype (%x)\n",\r\nip->i_ino, vip->vii_orgtype);\r\nreturn 0;\r\n}

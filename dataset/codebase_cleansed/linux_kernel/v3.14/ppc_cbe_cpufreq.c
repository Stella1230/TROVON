static int set_pmode(unsigned int cpu, unsigned int slow_mode)\r\n{\r\nint rc;\r\nif (cbe_cpufreq_has_pmi)\r\nrc = cbe_cpufreq_set_pmode_pmi(cpu, slow_mode);\r\nelse\r\nrc = cbe_cpufreq_set_pmode(cpu, slow_mode);\r\npr_debug("register contains slow mode %d\n", cbe_cpufreq_get_pmode(cpu));\r\nreturn rc;\r\n}\r\nstatic int cbe_cpufreq_cpu_init(struct cpufreq_policy *policy)\r\n{\r\nconst u32 *max_freqp;\r\nu32 max_freq;\r\nint i, cur_pmode;\r\nstruct device_node *cpu;\r\ncpu = of_get_cpu_node(policy->cpu, NULL);\r\nif (!cpu)\r\nreturn -ENODEV;\r\npr_debug("init cpufreq on CPU %d\n", policy->cpu);\r\nif (!cbe_get_cpu_pmd_regs(policy->cpu) ||\r\n!cbe_get_cpu_mic_tm_regs(policy->cpu)) {\r\npr_info("invalid CBE regs pointers for cpufreq\n");\r\nreturn -EINVAL;\r\n}\r\nmax_freqp = of_get_property(cpu, "clock-frequency", NULL);\r\nof_node_put(cpu);\r\nif (!max_freqp)\r\nreturn -EINVAL;\r\nmax_freq = *max_freqp / 1000;\r\npr_debug("max clock-frequency is at %u kHz\n", max_freq);\r\npr_debug("initializing frequency table\n");\r\nfor (i=0; cbe_freqs[i].frequency!=CPUFREQ_TABLE_END; i++) {\r\ncbe_freqs[i].frequency = max_freq / cbe_freqs[i].driver_data;\r\npr_debug("%d: %d\n", i, cbe_freqs[i].frequency);\r\n}\r\npolicy->cpuinfo.transition_latency = 25000;\r\ncur_pmode = cbe_cpufreq_get_pmode(policy->cpu);\r\npr_debug("current pmode is at %d\n",cur_pmode);\r\npolicy->cur = cbe_freqs[cur_pmode].frequency;\r\n#ifdef CONFIG_SMP\r\ncpumask_copy(policy->cpus, cpu_sibling_mask(policy->cpu));\r\n#endif\r\nreturn cpufreq_table_validate_and_show(policy, cbe_freqs);\r\n}\r\nstatic int cbe_cpufreq_target(struct cpufreq_policy *policy,\r\nunsigned int cbe_pmode_new)\r\n{\r\npr_debug("setting frequency for cpu %d to %d kHz, " \\r\n"1/%d of max frequency\n",\r\npolicy->cpu,\r\ncbe_freqs[cbe_pmode_new].frequency,\r\ncbe_freqs[cbe_pmode_new].driver_data);\r\nreturn set_pmode(policy->cpu, cbe_pmode_new);\r\n}\r\nstatic int __init cbe_cpufreq_init(void)\r\n{\r\nif (!machine_is(cell))\r\nreturn -ENODEV;\r\nreturn cpufreq_register_driver(&cbe_cpufreq_driver);\r\n}\r\nstatic void __exit cbe_cpufreq_exit(void)\r\n{\r\ncpufreq_unregister_driver(&cbe_cpufreq_driver);\r\n}

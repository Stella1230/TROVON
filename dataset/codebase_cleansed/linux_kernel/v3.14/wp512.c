static void wp512_process_buffer(struct wp512_ctx *wctx) {\r\nint i, r;\r\nu64 K[8];\r\nu64 block[8];\r\nu64 state[8];\r\nu64 L[8];\r\nconst __be64 *buffer = (const __be64 *)wctx->buffer;\r\nfor (i = 0; i < 8; i++)\r\nblock[i] = be64_to_cpu(buffer[i]);\r\nstate[0] = block[0] ^ (K[0] = wctx->hash[0]);\r\nstate[1] = block[1] ^ (K[1] = wctx->hash[1]);\r\nstate[2] = block[2] ^ (K[2] = wctx->hash[2]);\r\nstate[3] = block[3] ^ (K[3] = wctx->hash[3]);\r\nstate[4] = block[4] ^ (K[4] = wctx->hash[4]);\r\nstate[5] = block[5] ^ (K[5] = wctx->hash[5]);\r\nstate[6] = block[6] ^ (K[6] = wctx->hash[6]);\r\nstate[7] = block[7] ^ (K[7] = wctx->hash[7]);\r\nfor (r = 0; r < WHIRLPOOL_ROUNDS; r++) {\r\nL[0] = C0[(int)(K[0] >> 56) ] ^\r\nC1[(int)(K[7] >> 48) & 0xff] ^\r\nC2[(int)(K[6] >> 40) & 0xff] ^\r\nC3[(int)(K[5] >> 32) & 0xff] ^\r\nC4[(int)(K[4] >> 24) & 0xff] ^\r\nC5[(int)(K[3] >> 16) & 0xff] ^\r\nC6[(int)(K[2] >> 8) & 0xff] ^\r\nC7[(int)(K[1] ) & 0xff] ^\r\nrc[r];\r\nL[1] = C0[(int)(K[1] >> 56) ] ^\r\nC1[(int)(K[0] >> 48) & 0xff] ^\r\nC2[(int)(K[7] >> 40) & 0xff] ^\r\nC3[(int)(K[6] >> 32) & 0xff] ^\r\nC4[(int)(K[5] >> 24) & 0xff] ^\r\nC5[(int)(K[4] >> 16) & 0xff] ^\r\nC6[(int)(K[3] >> 8) & 0xff] ^\r\nC7[(int)(K[2] ) & 0xff];\r\nL[2] = C0[(int)(K[2] >> 56) ] ^\r\nC1[(int)(K[1] >> 48) & 0xff] ^\r\nC2[(int)(K[0] >> 40) & 0xff] ^\r\nC3[(int)(K[7] >> 32) & 0xff] ^\r\nC4[(int)(K[6] >> 24) & 0xff] ^\r\nC5[(int)(K[5] >> 16) & 0xff] ^\r\nC6[(int)(K[4] >> 8) & 0xff] ^\r\nC7[(int)(K[3] ) & 0xff];\r\nL[3] = C0[(int)(K[3] >> 56) ] ^\r\nC1[(int)(K[2] >> 48) & 0xff] ^\r\nC2[(int)(K[1] >> 40) & 0xff] ^\r\nC3[(int)(K[0] >> 32) & 0xff] ^\r\nC4[(int)(K[7] >> 24) & 0xff] ^\r\nC5[(int)(K[6] >> 16) & 0xff] ^\r\nC6[(int)(K[5] >> 8) & 0xff] ^\r\nC7[(int)(K[4] ) & 0xff];\r\nL[4] = C0[(int)(K[4] >> 56) ] ^\r\nC1[(int)(K[3] >> 48) & 0xff] ^\r\nC2[(int)(K[2] >> 40) & 0xff] ^\r\nC3[(int)(K[1] >> 32) & 0xff] ^\r\nC4[(int)(K[0] >> 24) & 0xff] ^\r\nC5[(int)(K[7] >> 16) & 0xff] ^\r\nC6[(int)(K[6] >> 8) & 0xff] ^\r\nC7[(int)(K[5] ) & 0xff];\r\nL[5] = C0[(int)(K[5] >> 56) ] ^\r\nC1[(int)(K[4] >> 48) & 0xff] ^\r\nC2[(int)(K[3] >> 40) & 0xff] ^\r\nC3[(int)(K[2] >> 32) & 0xff] ^\r\nC4[(int)(K[1] >> 24) & 0xff] ^\r\nC5[(int)(K[0] >> 16) & 0xff] ^\r\nC6[(int)(K[7] >> 8) & 0xff] ^\r\nC7[(int)(K[6] ) & 0xff];\r\nL[6] = C0[(int)(K[6] >> 56) ] ^\r\nC1[(int)(K[5] >> 48) & 0xff] ^\r\nC2[(int)(K[4] >> 40) & 0xff] ^\r\nC3[(int)(K[3] >> 32) & 0xff] ^\r\nC4[(int)(K[2] >> 24) & 0xff] ^\r\nC5[(int)(K[1] >> 16) & 0xff] ^\r\nC6[(int)(K[0] >> 8) & 0xff] ^\r\nC7[(int)(K[7] ) & 0xff];\r\nL[7] = C0[(int)(K[7] >> 56) ] ^\r\nC1[(int)(K[6] >> 48) & 0xff] ^\r\nC2[(int)(K[5] >> 40) & 0xff] ^\r\nC3[(int)(K[4] >> 32) & 0xff] ^\r\nC4[(int)(K[3] >> 24) & 0xff] ^\r\nC5[(int)(K[2] >> 16) & 0xff] ^\r\nC6[(int)(K[1] >> 8) & 0xff] ^\r\nC7[(int)(K[0] ) & 0xff];\r\nK[0] = L[0];\r\nK[1] = L[1];\r\nK[2] = L[2];\r\nK[3] = L[3];\r\nK[4] = L[4];\r\nK[5] = L[5];\r\nK[6] = L[6];\r\nK[7] = L[7];\r\nL[0] = C0[(int)(state[0] >> 56) ] ^\r\nC1[(int)(state[7] >> 48) & 0xff] ^\r\nC2[(int)(state[6] >> 40) & 0xff] ^\r\nC3[(int)(state[5] >> 32) & 0xff] ^\r\nC4[(int)(state[4] >> 24) & 0xff] ^\r\nC5[(int)(state[3] >> 16) & 0xff] ^\r\nC6[(int)(state[2] >> 8) & 0xff] ^\r\nC7[(int)(state[1] ) & 0xff] ^\r\nK[0];\r\nL[1] = C0[(int)(state[1] >> 56) ] ^\r\nC1[(int)(state[0] >> 48) & 0xff] ^\r\nC2[(int)(state[7] >> 40) & 0xff] ^\r\nC3[(int)(state[6] >> 32) & 0xff] ^\r\nC4[(int)(state[5] >> 24) & 0xff] ^\r\nC5[(int)(state[4] >> 16) & 0xff] ^\r\nC6[(int)(state[3] >> 8) & 0xff] ^\r\nC7[(int)(state[2] ) & 0xff] ^\r\nK[1];\r\nL[2] = C0[(int)(state[2] >> 56) ] ^\r\nC1[(int)(state[1] >> 48) & 0xff] ^\r\nC2[(int)(state[0] >> 40) & 0xff] ^\r\nC3[(int)(state[7] >> 32) & 0xff] ^\r\nC4[(int)(state[6] >> 24) & 0xff] ^\r\nC5[(int)(state[5] >> 16) & 0xff] ^\r\nC6[(int)(state[4] >> 8) & 0xff] ^\r\nC7[(int)(state[3] ) & 0xff] ^\r\nK[2];\r\nL[3] = C0[(int)(state[3] >> 56) ] ^\r\nC1[(int)(state[2] >> 48) & 0xff] ^\r\nC2[(int)(state[1] >> 40) & 0xff] ^\r\nC3[(int)(state[0] >> 32) & 0xff] ^\r\nC4[(int)(state[7] >> 24) & 0xff] ^\r\nC5[(int)(state[6] >> 16) & 0xff] ^\r\nC6[(int)(state[5] >> 8) & 0xff] ^\r\nC7[(int)(state[4] ) & 0xff] ^\r\nK[3];\r\nL[4] = C0[(int)(state[4] >> 56) ] ^\r\nC1[(int)(state[3] >> 48) & 0xff] ^\r\nC2[(int)(state[2] >> 40) & 0xff] ^\r\nC3[(int)(state[1] >> 32) & 0xff] ^\r\nC4[(int)(state[0] >> 24) & 0xff] ^\r\nC5[(int)(state[7] >> 16) & 0xff] ^\r\nC6[(int)(state[6] >> 8) & 0xff] ^\r\nC7[(int)(state[5] ) & 0xff] ^\r\nK[4];\r\nL[5] = C0[(int)(state[5] >> 56) ] ^\r\nC1[(int)(state[4] >> 48) & 0xff] ^\r\nC2[(int)(state[3] >> 40) & 0xff] ^\r\nC3[(int)(state[2] >> 32) & 0xff] ^\r\nC4[(int)(state[1] >> 24) & 0xff] ^\r\nC5[(int)(state[0] >> 16) & 0xff] ^\r\nC6[(int)(state[7] >> 8) & 0xff] ^\r\nC7[(int)(state[6] ) & 0xff] ^\r\nK[5];\r\nL[6] = C0[(int)(state[6] >> 56) ] ^\r\nC1[(int)(state[5] >> 48) & 0xff] ^\r\nC2[(int)(state[4] >> 40) & 0xff] ^\r\nC3[(int)(state[3] >> 32) & 0xff] ^\r\nC4[(int)(state[2] >> 24) & 0xff] ^\r\nC5[(int)(state[1] >> 16) & 0xff] ^\r\nC6[(int)(state[0] >> 8) & 0xff] ^\r\nC7[(int)(state[7] ) & 0xff] ^\r\nK[6];\r\nL[7] = C0[(int)(state[7] >> 56) ] ^\r\nC1[(int)(state[6] >> 48) & 0xff] ^\r\nC2[(int)(state[5] >> 40) & 0xff] ^\r\nC3[(int)(state[4] >> 32) & 0xff] ^\r\nC4[(int)(state[3] >> 24) & 0xff] ^\r\nC5[(int)(state[2] >> 16) & 0xff] ^\r\nC6[(int)(state[1] >> 8) & 0xff] ^\r\nC7[(int)(state[0] ) & 0xff] ^\r\nK[7];\r\nstate[0] = L[0];\r\nstate[1] = L[1];\r\nstate[2] = L[2];\r\nstate[3] = L[3];\r\nstate[4] = L[4];\r\nstate[5] = L[5];\r\nstate[6] = L[6];\r\nstate[7] = L[7];\r\n}\r\nwctx->hash[0] ^= state[0] ^ block[0];\r\nwctx->hash[1] ^= state[1] ^ block[1];\r\nwctx->hash[2] ^= state[2] ^ block[2];\r\nwctx->hash[3] ^= state[3] ^ block[3];\r\nwctx->hash[4] ^= state[4] ^ block[4];\r\nwctx->hash[5] ^= state[5] ^ block[5];\r\nwctx->hash[6] ^= state[6] ^ block[6];\r\nwctx->hash[7] ^= state[7] ^ block[7];\r\n}\r\nstatic int wp512_init(struct shash_desc *desc) {\r\nstruct wp512_ctx *wctx = shash_desc_ctx(desc);\r\nint i;\r\nmemset(wctx->bitLength, 0, 32);\r\nwctx->bufferBits = wctx->bufferPos = 0;\r\nwctx->buffer[0] = 0;\r\nfor (i = 0; i < 8; i++) {\r\nwctx->hash[i] = 0L;\r\n}\r\nreturn 0;\r\n}\r\nstatic int wp512_update(struct shash_desc *desc, const u8 *source,\r\nunsigned int len)\r\n{\r\nstruct wp512_ctx *wctx = shash_desc_ctx(desc);\r\nint sourcePos = 0;\r\nunsigned int bits_len = len * 8;\r\nint sourceGap = (8 - ((int)bits_len & 7)) & 7;\r\nint bufferRem = wctx->bufferBits & 7;\r\nint i;\r\nu32 b, carry;\r\nu8 *buffer = wctx->buffer;\r\nu8 *bitLength = wctx->bitLength;\r\nint bufferBits = wctx->bufferBits;\r\nint bufferPos = wctx->bufferPos;\r\nu64 value = bits_len;\r\nfor (i = 31, carry = 0; i >= 0 && (carry != 0 || value != 0ULL); i--) {\r\ncarry += bitLength[i] + ((u32)value & 0xff);\r\nbitLength[i] = (u8)carry;\r\ncarry >>= 8;\r\nvalue >>= 8;\r\n}\r\nwhile (bits_len > 8) {\r\nb = ((source[sourcePos] << sourceGap) & 0xff) |\r\n((source[sourcePos + 1] & 0xff) >> (8 - sourceGap));\r\nbuffer[bufferPos++] |= (u8)(b >> bufferRem);\r\nbufferBits += 8 - bufferRem;\r\nif (bufferBits == WP512_BLOCK_SIZE * 8) {\r\nwp512_process_buffer(wctx);\r\nbufferBits = bufferPos = 0;\r\n}\r\nbuffer[bufferPos] = b << (8 - bufferRem);\r\nbufferBits += bufferRem;\r\nbits_len -= 8;\r\nsourcePos++;\r\n}\r\nif (bits_len > 0) {\r\nb = (source[sourcePos] << sourceGap) & 0xff;\r\nbuffer[bufferPos] |= b >> bufferRem;\r\n} else {\r\nb = 0;\r\n}\r\nif (bufferRem + bits_len < 8) {\r\nbufferBits += bits_len;\r\n} else {\r\nbufferPos++;\r\nbufferBits += 8 - bufferRem;\r\nbits_len -= 8 - bufferRem;\r\nif (bufferBits == WP512_BLOCK_SIZE * 8) {\r\nwp512_process_buffer(wctx);\r\nbufferBits = bufferPos = 0;\r\n}\r\nbuffer[bufferPos] = b << (8 - bufferRem);\r\nbufferBits += (int)bits_len;\r\n}\r\nwctx->bufferBits = bufferBits;\r\nwctx->bufferPos = bufferPos;\r\nreturn 0;\r\n}\r\nstatic int wp512_final(struct shash_desc *desc, u8 *out)\r\n{\r\nstruct wp512_ctx *wctx = shash_desc_ctx(desc);\r\nint i;\r\nu8 *buffer = wctx->buffer;\r\nu8 *bitLength = wctx->bitLength;\r\nint bufferBits = wctx->bufferBits;\r\nint bufferPos = wctx->bufferPos;\r\n__be64 *digest = (__be64 *)out;\r\nbuffer[bufferPos] |= 0x80U >> (bufferBits & 7);\r\nbufferPos++;\r\nif (bufferPos > WP512_BLOCK_SIZE - WP512_LENGTHBYTES) {\r\nif (bufferPos < WP512_BLOCK_SIZE) {\r\nmemset(&buffer[bufferPos], 0, WP512_BLOCK_SIZE - bufferPos);\r\n}\r\nwp512_process_buffer(wctx);\r\nbufferPos = 0;\r\n}\r\nif (bufferPos < WP512_BLOCK_SIZE - WP512_LENGTHBYTES) {\r\nmemset(&buffer[bufferPos], 0,\r\n(WP512_BLOCK_SIZE - WP512_LENGTHBYTES) - bufferPos);\r\n}\r\nbufferPos = WP512_BLOCK_SIZE - WP512_LENGTHBYTES;\r\nmemcpy(&buffer[WP512_BLOCK_SIZE - WP512_LENGTHBYTES],\r\nbitLength, WP512_LENGTHBYTES);\r\nwp512_process_buffer(wctx);\r\nfor (i = 0; i < WP512_DIGEST_SIZE/8; i++)\r\ndigest[i] = cpu_to_be64(wctx->hash[i]);\r\nwctx->bufferBits = bufferBits;\r\nwctx->bufferPos = bufferPos;\r\nreturn 0;\r\n}\r\nstatic int wp384_final(struct shash_desc *desc, u8 *out)\r\n{\r\nu8 D[64];\r\nwp512_final(desc, D);\r\nmemcpy (out, D, WP384_DIGEST_SIZE);\r\nmemset (D, 0, WP512_DIGEST_SIZE);\r\nreturn 0;\r\n}\r\nstatic int wp256_final(struct shash_desc *desc, u8 *out)\r\n{\r\nu8 D[64];\r\nwp512_final(desc, D);\r\nmemcpy (out, D, WP256_DIGEST_SIZE);\r\nmemset (D, 0, WP512_DIGEST_SIZE);\r\nreturn 0;\r\n}\r\nstatic int __init wp512_mod_init(void)\r\n{\r\nreturn crypto_register_shashes(wp_algs, ARRAY_SIZE(wp_algs));\r\n}\r\nstatic void __exit wp512_mod_fini(void)\r\n{\r\ncrypto_unregister_shashes(wp_algs, ARRAY_SIZE(wp_algs));\r\n}

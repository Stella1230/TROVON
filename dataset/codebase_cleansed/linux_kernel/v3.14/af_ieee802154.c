struct net_device *ieee802154_get_dev(struct net *net,\r\nstruct ieee802154_addr *addr)\r\n{\r\nstruct net_device *dev = NULL;\r\nstruct net_device *tmp;\r\nu16 pan_id, short_addr;\r\nswitch (addr->addr_type) {\r\ncase IEEE802154_ADDR_LONG:\r\nrcu_read_lock();\r\ndev = dev_getbyhwaddr_rcu(net, ARPHRD_IEEE802154, addr->hwaddr);\r\nif (dev)\r\ndev_hold(dev);\r\nrcu_read_unlock();\r\nbreak;\r\ncase IEEE802154_ADDR_SHORT:\r\nif (addr->pan_id == 0xffff ||\r\naddr->short_addr == IEEE802154_ADDR_UNDEF ||\r\naddr->short_addr == 0xffff)\r\nbreak;\r\nrtnl_lock();\r\nfor_each_netdev(net, tmp) {\r\nif (tmp->type != ARPHRD_IEEE802154)\r\ncontinue;\r\npan_id = ieee802154_mlme_ops(tmp)->get_pan_id(tmp);\r\nshort_addr =\r\nieee802154_mlme_ops(tmp)->get_short_addr(tmp);\r\nif (pan_id == addr->pan_id &&\r\nshort_addr == addr->short_addr) {\r\ndev = tmp;\r\ndev_hold(dev);\r\nbreak;\r\n}\r\n}\r\nrtnl_unlock();\r\nbreak;\r\ndefault:\r\npr_warning("Unsupported ieee802154 address type: %d\n",\r\naddr->addr_type);\r\nbreak;\r\n}\r\nreturn dev;\r\n}\r\nstatic int ieee802154_sock_release(struct socket *sock)\r\n{\r\nstruct sock *sk = sock->sk;\r\nif (sk) {\r\nsock->sk = NULL;\r\nsk->sk_prot->close(sk, 0);\r\n}\r\nreturn 0;\r\n}\r\nstatic int ieee802154_sock_sendmsg(struct kiocb *iocb, struct socket *sock,\r\nstruct msghdr *msg, size_t len)\r\n{\r\nstruct sock *sk = sock->sk;\r\nreturn sk->sk_prot->sendmsg(iocb, sk, msg, len);\r\n}\r\nstatic int ieee802154_sock_bind(struct socket *sock, struct sockaddr *uaddr,\r\nint addr_len)\r\n{\r\nstruct sock *sk = sock->sk;\r\nif (sk->sk_prot->bind)\r\nreturn sk->sk_prot->bind(sk, uaddr, addr_len);\r\nreturn sock_no_bind(sock, uaddr, addr_len);\r\n}\r\nstatic int ieee802154_sock_connect(struct socket *sock, struct sockaddr *uaddr,\r\nint addr_len, int flags)\r\n{\r\nstruct sock *sk = sock->sk;\r\nif (addr_len < sizeof(uaddr->sa_family))\r\nreturn -EINVAL;\r\nif (uaddr->sa_family == AF_UNSPEC)\r\nreturn sk->sk_prot->disconnect(sk, flags);\r\nreturn sk->sk_prot->connect(sk, uaddr, addr_len);\r\n}\r\nstatic int ieee802154_dev_ioctl(struct sock *sk, struct ifreq __user *arg,\r\nunsigned int cmd)\r\n{\r\nstruct ifreq ifr;\r\nint ret = -ENOIOCTLCMD;\r\nstruct net_device *dev;\r\nif (copy_from_user(&ifr, arg, sizeof(struct ifreq)))\r\nreturn -EFAULT;\r\nifr.ifr_name[IFNAMSIZ-1] = 0;\r\ndev_load(sock_net(sk), ifr.ifr_name);\r\ndev = dev_get_by_name(sock_net(sk), ifr.ifr_name);\r\nif (!dev)\r\nreturn -ENODEV;\r\nif (dev->type == ARPHRD_IEEE802154 && dev->netdev_ops->ndo_do_ioctl)\r\nret = dev->netdev_ops->ndo_do_ioctl(dev, &ifr, cmd);\r\nif (!ret && copy_to_user(arg, &ifr, sizeof(struct ifreq)))\r\nret = -EFAULT;\r\ndev_put(dev);\r\nreturn ret;\r\n}\r\nstatic int ieee802154_sock_ioctl(struct socket *sock, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nstruct sock *sk = sock->sk;\r\nswitch (cmd) {\r\ncase SIOCGSTAMP:\r\nreturn sock_get_timestamp(sk, (struct timeval __user *)arg);\r\ncase SIOCGSTAMPNS:\r\nreturn sock_get_timestampns(sk, (struct timespec __user *)arg);\r\ncase SIOCGIFADDR:\r\ncase SIOCSIFADDR:\r\nreturn ieee802154_dev_ioctl(sk, (struct ifreq __user *)arg,\r\ncmd);\r\ndefault:\r\nif (!sk->sk_prot->ioctl)\r\nreturn -ENOIOCTLCMD;\r\nreturn sk->sk_prot->ioctl(sk, cmd, arg);\r\n}\r\n}\r\nstatic int ieee802154_create(struct net *net, struct socket *sock,\r\nint protocol, int kern)\r\n{\r\nstruct sock *sk;\r\nint rc;\r\nstruct proto *proto;\r\nconst struct proto_ops *ops;\r\nif (!net_eq(net, &init_net))\r\nreturn -EAFNOSUPPORT;\r\nswitch (sock->type) {\r\ncase SOCK_RAW:\r\nproto = &ieee802154_raw_prot;\r\nops = &ieee802154_raw_ops;\r\nbreak;\r\ncase SOCK_DGRAM:\r\nproto = &ieee802154_dgram_prot;\r\nops = &ieee802154_dgram_ops;\r\nbreak;\r\ndefault:\r\nrc = -ESOCKTNOSUPPORT;\r\ngoto out;\r\n}\r\nrc = -ENOMEM;\r\nsk = sk_alloc(net, PF_IEEE802154, GFP_KERNEL, proto);\r\nif (!sk)\r\ngoto out;\r\nrc = 0;\r\nsock->ops = ops;\r\nsock_init_data(sock, sk);\r\nsk->sk_family = PF_IEEE802154;\r\nsock_set_flag(sk, SOCK_ZAPPED);\r\nif (sk->sk_prot->hash)\r\nsk->sk_prot->hash(sk);\r\nif (sk->sk_prot->init) {\r\nrc = sk->sk_prot->init(sk);\r\nif (rc)\r\nsk_common_release(sk);\r\n}\r\nout:\r\nreturn rc;\r\n}\r\nstatic int ieee802154_rcv(struct sk_buff *skb, struct net_device *dev,\r\nstruct packet_type *pt, struct net_device *orig_dev)\r\n{\r\nif (!netif_running(dev))\r\ngoto drop;\r\npr_debug("got frame, type %d, dev %p\n", dev->type, dev);\r\n#ifdef DEBUG\r\nprint_hex_dump_bytes("ieee802154_rcv ", DUMP_PREFIX_NONE, skb->data, skb->len);\r\n#endif\r\nif (!net_eq(dev_net(dev), &init_net))\r\ngoto drop;\r\nieee802154_raw_deliver(dev, skb);\r\nif (dev->type != ARPHRD_IEEE802154)\r\ngoto drop;\r\nif (skb->pkt_type != PACKET_OTHERHOST)\r\nreturn ieee802154_dgram_deliver(dev, skb);\r\ndrop:\r\nkfree_skb(skb);\r\nreturn NET_RX_DROP;\r\n}\r\nstatic int __init af_ieee802154_init(void)\r\n{\r\nint rc = -EINVAL;\r\nrc = proto_register(&ieee802154_raw_prot, 1);\r\nif (rc)\r\ngoto out;\r\nrc = proto_register(&ieee802154_dgram_prot, 1);\r\nif (rc)\r\ngoto err_dgram;\r\nrc = sock_register(&ieee802154_family_ops);\r\nif (rc)\r\ngoto err_sock;\r\ndev_add_pack(&ieee802154_packet_type);\r\nrc = 0;\r\ngoto out;\r\nerr_sock:\r\nproto_unregister(&ieee802154_dgram_prot);\r\nerr_dgram:\r\nproto_unregister(&ieee802154_raw_prot);\r\nout:\r\nreturn rc;\r\n}\r\nstatic void __exit af_ieee802154_remove(void)\r\n{\r\ndev_remove_pack(&ieee802154_packet_type);\r\nsock_unregister(PF_IEEE802154);\r\nproto_unregister(&ieee802154_dgram_prot);\r\nproto_unregister(&ieee802154_raw_prot);\r\n}

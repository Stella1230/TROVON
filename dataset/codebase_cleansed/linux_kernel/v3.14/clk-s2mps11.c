static struct s2mps11_clk *to_s2mps11_clk(struct clk_hw *hw)\r\n{\r\nreturn container_of(hw, struct s2mps11_clk, hw);\r\n}\r\nstatic int s2mps11_clk_prepare(struct clk_hw *hw)\r\n{\r\nstruct s2mps11_clk *s2mps11 = to_s2mps11_clk(hw);\r\nint ret;\r\nret = regmap_update_bits(s2mps11->iodev->regmap_pmic,\r\nS2MPS11_REG_RTC_CTRL,\r\ns2mps11->mask, s2mps11->mask);\r\nif (!ret)\r\ns2mps11->enabled = true;\r\nreturn ret;\r\n}\r\nstatic void s2mps11_clk_unprepare(struct clk_hw *hw)\r\n{\r\nstruct s2mps11_clk *s2mps11 = to_s2mps11_clk(hw);\r\nint ret;\r\nret = regmap_update_bits(s2mps11->iodev->regmap_pmic, S2MPS11_REG_RTC_CTRL,\r\ns2mps11->mask, ~s2mps11->mask);\r\nif (!ret)\r\ns2mps11->enabled = false;\r\n}\r\nstatic int s2mps11_clk_is_enabled(struct clk_hw *hw)\r\n{\r\nstruct s2mps11_clk *s2mps11 = to_s2mps11_clk(hw);\r\nreturn s2mps11->enabled;\r\n}\r\nstatic unsigned long s2mps11_clk_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct s2mps11_clk *s2mps11 = to_s2mps11_clk(hw);\r\nif (s2mps11->enabled)\r\nreturn 32768;\r\nelse\r\nreturn 0;\r\n}\r\nstatic struct device_node *s2mps11_clk_parse_dt(struct platform_device *pdev)\r\n{\r\nstruct sec_pmic_dev *iodev = dev_get_drvdata(pdev->dev.parent);\r\nstruct device_node *clk_np;\r\nint i;\r\nif (!iodev->dev->of_node)\r\nreturn NULL;\r\nclk_np = of_find_node_by_name(iodev->dev->of_node, "clocks");\r\nif (!clk_np) {\r\ndev_err(&pdev->dev, "could not find clock sub-node\n");\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nclk_table = devm_kzalloc(&pdev->dev, sizeof(struct clk *) *\r\nS2MPS11_CLKS_NUM, GFP_KERNEL);\r\nif (!clk_table)\r\nreturn ERR_PTR(-ENOMEM);\r\nfor (i = 0; i < S2MPS11_CLKS_NUM; i++)\r\nof_property_read_string_index(clk_np, "clock-output-names", i,\r\n&s2mps11_clks_init[i].name);\r\nreturn clk_np;\r\n}\r\nstatic int s2mps11_clk_probe(struct platform_device *pdev)\r\n{\r\nstruct sec_pmic_dev *iodev = dev_get_drvdata(pdev->dev.parent);\r\nstruct s2mps11_clk *s2mps11_clks, *s2mps11_clk;\r\nstruct device_node *clk_np = NULL;\r\nint i, ret = 0;\r\nu32 val;\r\ns2mps11_clks = devm_kzalloc(&pdev->dev, sizeof(*s2mps11_clk) *\r\nS2MPS11_CLKS_NUM, GFP_KERNEL);\r\nif (!s2mps11_clks)\r\nreturn -ENOMEM;\r\ns2mps11_clk = s2mps11_clks;\r\nclk_np = s2mps11_clk_parse_dt(pdev);\r\nif (IS_ERR(clk_np))\r\nreturn PTR_ERR(clk_np);\r\nfor (i = 0; i < S2MPS11_CLKS_NUM; i++, s2mps11_clk++) {\r\ns2mps11_clk->iodev = iodev;\r\ns2mps11_clk->hw.init = &s2mps11_clks_init[i];\r\ns2mps11_clk->mask = 1 << i;\r\nret = regmap_read(s2mps11_clk->iodev->regmap_pmic,\r\nS2MPS11_REG_RTC_CTRL, &val);\r\nif (ret < 0)\r\ngoto err_reg;\r\ns2mps11_clk->enabled = val & s2mps11_clk->mask;\r\ns2mps11_clk->clk = devm_clk_register(&pdev->dev,\r\n&s2mps11_clk->hw);\r\nif (IS_ERR(s2mps11_clk->clk)) {\r\ndev_err(&pdev->dev, "Fail to register : %s\n",\r\ns2mps11_name(s2mps11_clk));\r\nret = PTR_ERR(s2mps11_clk->clk);\r\ngoto err_reg;\r\n}\r\ns2mps11_clk->lookup = devm_kzalloc(&pdev->dev,\r\nsizeof(struct clk_lookup), GFP_KERNEL);\r\nif (!s2mps11_clk->lookup) {\r\nret = -ENOMEM;\r\ngoto err_lup;\r\n}\r\ns2mps11_clk->lookup->con_id = s2mps11_name(s2mps11_clk);\r\ns2mps11_clk->lookup->clk = s2mps11_clk->clk;\r\nclkdev_add(s2mps11_clk->lookup);\r\n}\r\nif (clk_table) {\r\nfor (i = 0; i < S2MPS11_CLKS_NUM; i++)\r\nclk_table[i] = s2mps11_clks[i].clk;\r\nclk_data.clks = clk_table;\r\nclk_data.clk_num = S2MPS11_CLKS_NUM;\r\nof_clk_add_provider(clk_np, of_clk_src_onecell_get, &clk_data);\r\n}\r\nplatform_set_drvdata(pdev, s2mps11_clks);\r\nreturn ret;\r\nerr_lup:\r\ndevm_clk_unregister(&pdev->dev, s2mps11_clk->clk);\r\nerr_reg:\r\nwhile (s2mps11_clk > s2mps11_clks) {\r\nif (s2mps11_clk->lookup) {\r\nclkdev_drop(s2mps11_clk->lookup);\r\ndevm_clk_unregister(&pdev->dev, s2mps11_clk->clk);\r\n}\r\ns2mps11_clk--;\r\n}\r\nreturn ret;\r\n}\r\nstatic int s2mps11_clk_remove(struct platform_device *pdev)\r\n{\r\nstruct s2mps11_clk *s2mps11_clks = platform_get_drvdata(pdev);\r\nint i;\r\nfor (i = 0; i < S2MPS11_CLKS_NUM; i++)\r\nclkdev_drop(s2mps11_clks[i].lookup);\r\nreturn 0;\r\n}\r\nstatic int __init s2mps11_clk_init(void)\r\n{\r\nreturn platform_driver_register(&s2mps11_clk_driver);\r\n}\r\nstatic void __init s2mps11_clk_cleanup(void)\r\n{\r\nplatform_driver_unregister(&s2mps11_clk_driver);\r\n}

u32 rv740_get_decoded_reference_divider(u32 encoded_ref)\r\n{\r\nu32 ref = 0;\r\nswitch (encoded_ref) {\r\ncase 0:\r\nref = 1;\r\nbreak;\r\ncase 16:\r\nref = 2;\r\nbreak;\r\ncase 17:\r\nref = 3;\r\nbreak;\r\ncase 18:\r\nref = 2;\r\nbreak;\r\ncase 19:\r\nref = 3;\r\nbreak;\r\ncase 20:\r\nref = 4;\r\nbreak;\r\ncase 21:\r\nref = 5;\r\nbreak;\r\ndefault:\r\nDRM_ERROR("Invalid encoded Reference Divider\n");\r\nref = 0;\r\nbreak;\r\n}\r\nreturn ref;\r\n}\r\nu32 rv740_get_dll_speed(bool is_gddr5, u32 memory_clock)\r\n{\r\nint i;\r\nu32 factor;\r\nu16 data_rate;\r\nif (is_gddr5)\r\nfactor = 4;\r\nelse\r\nfactor = 2;\r\ndata_rate = (u16)(memory_clock * factor / 1000);\r\nif (data_rate < dll_speed_table[0].max) {\r\nfor (i = 0; i < 16; i++) {\r\nif (data_rate > dll_speed_table[i].min &&\r\ndata_rate <= dll_speed_table[i].max)\r\nreturn dll_speed_table[i].dll_speed;\r\n}\r\n}\r\nDRM_DEBUG_KMS("Target MCLK greater than largest MCLK in DLL speed table\n");\r\nreturn 0x0f;\r\n}\r\nint rv740_populate_sclk_value(struct radeon_device *rdev, u32 engine_clock,\r\nRV770_SMC_SCLK_VALUE *sclk)\r\n{\r\nstruct rv7xx_power_info *pi = rv770_get_pi(rdev);\r\nstruct atom_clock_dividers dividers;\r\nu32 spll_func_cntl = pi->clk_regs.rv770.cg_spll_func_cntl;\r\nu32 spll_func_cntl_2 = pi->clk_regs.rv770.cg_spll_func_cntl_2;\r\nu32 spll_func_cntl_3 = pi->clk_regs.rv770.cg_spll_func_cntl_3;\r\nu32 cg_spll_spread_spectrum = pi->clk_regs.rv770.cg_spll_spread_spectrum;\r\nu32 cg_spll_spread_spectrum_2 = pi->clk_regs.rv770.cg_spll_spread_spectrum_2;\r\nu64 tmp;\r\nu32 reference_clock = rdev->clock.spll.reference_freq;\r\nu32 reference_divider;\r\nu32 fbdiv;\r\nint ret;\r\nret = radeon_atom_get_clock_dividers(rdev, COMPUTE_ENGINE_PLL_PARAM,\r\nengine_clock, false, &dividers);\r\nif (ret)\r\nreturn ret;\r\nreference_divider = 1 + dividers.ref_div;\r\ntmp = (u64) engine_clock * reference_divider * dividers.post_div * 16384;\r\ndo_div(tmp, reference_clock);\r\nfbdiv = (u32) tmp;\r\nspll_func_cntl &= ~(SPLL_PDIV_A_MASK | SPLL_REF_DIV_MASK);\r\nspll_func_cntl |= SPLL_REF_DIV(dividers.ref_div);\r\nspll_func_cntl |= SPLL_PDIV_A(dividers.post_div);\r\nspll_func_cntl_2 &= ~SCLK_MUX_SEL_MASK;\r\nspll_func_cntl_2 |= SCLK_MUX_SEL(2);\r\nspll_func_cntl_3 &= ~SPLL_FB_DIV_MASK;\r\nspll_func_cntl_3 |= SPLL_FB_DIV(fbdiv);\r\nspll_func_cntl_3 |= SPLL_DITHEN;\r\nif (pi->sclk_ss) {\r\nstruct radeon_atom_ss ss;\r\nu32 vco_freq = engine_clock * dividers.post_div;\r\nif (radeon_atombios_get_asic_ss_info(rdev, &ss,\r\nASIC_INTERNAL_ENGINE_SS, vco_freq)) {\r\nu32 clk_s = reference_clock * 5 / (reference_divider * ss.rate);\r\nu32 clk_v = 4 * ss.percentage * fbdiv / (clk_s * 10000);\r\ncg_spll_spread_spectrum &= ~CLK_S_MASK;\r\ncg_spll_spread_spectrum |= CLK_S(clk_s);\r\ncg_spll_spread_spectrum |= SSEN;\r\ncg_spll_spread_spectrum_2 &= ~CLK_V_MASK;\r\ncg_spll_spread_spectrum_2 |= CLK_V(clk_v);\r\n}\r\n}\r\nsclk->sclk_value = cpu_to_be32(engine_clock);\r\nsclk->vCG_SPLL_FUNC_CNTL = cpu_to_be32(spll_func_cntl);\r\nsclk->vCG_SPLL_FUNC_CNTL_2 = cpu_to_be32(spll_func_cntl_2);\r\nsclk->vCG_SPLL_FUNC_CNTL_3 = cpu_to_be32(spll_func_cntl_3);\r\nsclk->vCG_SPLL_SPREAD_SPECTRUM = cpu_to_be32(cg_spll_spread_spectrum);\r\nsclk->vCG_SPLL_SPREAD_SPECTRUM_2 = cpu_to_be32(cg_spll_spread_spectrum_2);\r\nreturn 0;\r\n}\r\nint rv740_populate_mclk_value(struct radeon_device *rdev,\r\nu32 engine_clock, u32 memory_clock,\r\nRV7XX_SMC_MCLK_VALUE *mclk)\r\n{\r\nstruct rv7xx_power_info *pi = rv770_get_pi(rdev);\r\nu32 mpll_ad_func_cntl = pi->clk_regs.rv770.mpll_ad_func_cntl;\r\nu32 mpll_ad_func_cntl_2 = pi->clk_regs.rv770.mpll_ad_func_cntl_2;\r\nu32 mpll_dq_func_cntl = pi->clk_regs.rv770.mpll_dq_func_cntl;\r\nu32 mpll_dq_func_cntl_2 = pi->clk_regs.rv770.mpll_dq_func_cntl_2;\r\nu32 mclk_pwrmgt_cntl = pi->clk_regs.rv770.mclk_pwrmgt_cntl;\r\nu32 dll_cntl = pi->clk_regs.rv770.dll_cntl;\r\nu32 mpll_ss1 = pi->clk_regs.rv770.mpll_ss1;\r\nu32 mpll_ss2 = pi->clk_regs.rv770.mpll_ss2;\r\nstruct atom_clock_dividers dividers;\r\nu32 ibias;\r\nu32 dll_speed;\r\nint ret;\r\nret = radeon_atom_get_clock_dividers(rdev, COMPUTE_MEMORY_PLL_PARAM,\r\nmemory_clock, false, &dividers);\r\nif (ret)\r\nreturn ret;\r\nibias = rv770_map_clkf_to_ibias(rdev, dividers.whole_fb_div);\r\nmpll_ad_func_cntl &= ~(CLKR_MASK |\r\nYCLK_POST_DIV_MASK |\r\nCLKF_MASK |\r\nCLKFRAC_MASK |\r\nIBIAS_MASK);\r\nmpll_ad_func_cntl |= CLKR(dividers.ref_div);\r\nmpll_ad_func_cntl |= YCLK_POST_DIV(dividers.post_div);\r\nmpll_ad_func_cntl |= CLKF(dividers.whole_fb_div);\r\nmpll_ad_func_cntl |= CLKFRAC(dividers.frac_fb_div);\r\nmpll_ad_func_cntl |= IBIAS(ibias);\r\nif (dividers.vco_mode)\r\nmpll_ad_func_cntl_2 |= VCO_MODE;\r\nelse\r\nmpll_ad_func_cntl_2 &= ~VCO_MODE;\r\nif (pi->mem_gddr5) {\r\nmpll_dq_func_cntl &= ~(CLKR_MASK |\r\nYCLK_POST_DIV_MASK |\r\nCLKF_MASK |\r\nCLKFRAC_MASK |\r\nIBIAS_MASK);\r\nmpll_dq_func_cntl |= CLKR(dividers.ref_div);\r\nmpll_dq_func_cntl |= YCLK_POST_DIV(dividers.post_div);\r\nmpll_dq_func_cntl |= CLKF(dividers.whole_fb_div);\r\nmpll_dq_func_cntl |= CLKFRAC(dividers.frac_fb_div);\r\nmpll_dq_func_cntl |= IBIAS(ibias);\r\nif (dividers.vco_mode)\r\nmpll_dq_func_cntl_2 |= VCO_MODE;\r\nelse\r\nmpll_dq_func_cntl_2 &= ~VCO_MODE;\r\n}\r\nif (pi->mclk_ss) {\r\nstruct radeon_atom_ss ss;\r\nu32 vco_freq = memory_clock * dividers.post_div;\r\nif (radeon_atombios_get_asic_ss_info(rdev, &ss,\r\nASIC_INTERNAL_MEMORY_SS, vco_freq)) {\r\nu32 reference_clock = rdev->clock.mpll.reference_freq;\r\nu32 decoded_ref = rv740_get_decoded_reference_divider(dividers.ref_div);\r\nu32 clk_s = reference_clock * 5 / (decoded_ref * ss.rate);\r\nu32 clk_v = 0x40000 * ss.percentage *\r\n(dividers.whole_fb_div + (dividers.frac_fb_div / 8)) / (clk_s * 10000);\r\nmpll_ss1 &= ~CLKV_MASK;\r\nmpll_ss1 |= CLKV(clk_v);\r\nmpll_ss2 &= ~CLKS_MASK;\r\nmpll_ss2 |= CLKS(clk_s);\r\n}\r\n}\r\ndll_speed = rv740_get_dll_speed(pi->mem_gddr5,\r\nmemory_clock);\r\nmclk_pwrmgt_cntl &= ~DLL_SPEED_MASK;\r\nmclk_pwrmgt_cntl |= DLL_SPEED(dll_speed);\r\nmclk->mclk770.mclk_value = cpu_to_be32(memory_clock);\r\nmclk->mclk770.vMPLL_AD_FUNC_CNTL = cpu_to_be32(mpll_ad_func_cntl);\r\nmclk->mclk770.vMPLL_AD_FUNC_CNTL_2 = cpu_to_be32(mpll_ad_func_cntl_2);\r\nmclk->mclk770.vMPLL_DQ_FUNC_CNTL = cpu_to_be32(mpll_dq_func_cntl);\r\nmclk->mclk770.vMPLL_DQ_FUNC_CNTL_2 = cpu_to_be32(mpll_dq_func_cntl_2);\r\nmclk->mclk770.vMCLK_PWRMGT_CNTL = cpu_to_be32(mclk_pwrmgt_cntl);\r\nmclk->mclk770.vDLL_CNTL = cpu_to_be32(dll_cntl);\r\nmclk->mclk770.vMPLL_SS = cpu_to_be32(mpll_ss1);\r\nmclk->mclk770.vMPLL_SS2 = cpu_to_be32(mpll_ss2);\r\nreturn 0;\r\n}\r\nvoid rv740_read_clock_registers(struct radeon_device *rdev)\r\n{\r\nstruct rv7xx_power_info *pi = rv770_get_pi(rdev);\r\npi->clk_regs.rv770.cg_spll_func_cntl =\r\nRREG32(CG_SPLL_FUNC_CNTL);\r\npi->clk_regs.rv770.cg_spll_func_cntl_2 =\r\nRREG32(CG_SPLL_FUNC_CNTL_2);\r\npi->clk_regs.rv770.cg_spll_func_cntl_3 =\r\nRREG32(CG_SPLL_FUNC_CNTL_3);\r\npi->clk_regs.rv770.cg_spll_spread_spectrum =\r\nRREG32(CG_SPLL_SPREAD_SPECTRUM);\r\npi->clk_regs.rv770.cg_spll_spread_spectrum_2 =\r\nRREG32(CG_SPLL_SPREAD_SPECTRUM_2);\r\npi->clk_regs.rv770.mpll_ad_func_cntl =\r\nRREG32(MPLL_AD_FUNC_CNTL);\r\npi->clk_regs.rv770.mpll_ad_func_cntl_2 =\r\nRREG32(MPLL_AD_FUNC_CNTL_2);\r\npi->clk_regs.rv770.mpll_dq_func_cntl =\r\nRREG32(MPLL_DQ_FUNC_CNTL);\r\npi->clk_regs.rv770.mpll_dq_func_cntl_2 =\r\nRREG32(MPLL_DQ_FUNC_CNTL_2);\r\npi->clk_regs.rv770.mclk_pwrmgt_cntl =\r\nRREG32(MCLK_PWRMGT_CNTL);\r\npi->clk_regs.rv770.dll_cntl = RREG32(DLL_CNTL);\r\npi->clk_regs.rv770.mpll_ss1 = RREG32(MPLL_SS1);\r\npi->clk_regs.rv770.mpll_ss2 = RREG32(MPLL_SS2);\r\n}\r\nint rv740_populate_smc_acpi_state(struct radeon_device *rdev,\r\nRV770_SMC_STATETABLE *table)\r\n{\r\nstruct rv7xx_power_info *pi = rv770_get_pi(rdev);\r\nu32 mpll_ad_func_cntl = pi->clk_regs.rv770.mpll_ad_func_cntl;\r\nu32 mpll_ad_func_cntl_2 = pi->clk_regs.rv770.mpll_ad_func_cntl_2;\r\nu32 mpll_dq_func_cntl = pi->clk_regs.rv770.mpll_dq_func_cntl;\r\nu32 mpll_dq_func_cntl_2 = pi->clk_regs.rv770.mpll_dq_func_cntl_2;\r\nu32 spll_func_cntl = pi->clk_regs.rv770.cg_spll_func_cntl;\r\nu32 spll_func_cntl_2 = pi->clk_regs.rv770.cg_spll_func_cntl_2;\r\nu32 spll_func_cntl_3 = pi->clk_regs.rv770.cg_spll_func_cntl_3;\r\nu32 mclk_pwrmgt_cntl = pi->clk_regs.rv770.mclk_pwrmgt_cntl;\r\nu32 dll_cntl = pi->clk_regs.rv770.dll_cntl;\r\ntable->ACPIState = table->initialState;\r\ntable->ACPIState.flags &= ~PPSMC_SWSTATE_FLAG_DC;\r\nif (pi->acpi_vddc) {\r\nrv770_populate_vddc_value(rdev, pi->acpi_vddc,\r\n&table->ACPIState.levels[0].vddc);\r\ntable->ACPIState.levels[0].gen2PCIE =\r\npi->pcie_gen2 ?\r\npi->acpi_pcie_gen2 : 0;\r\ntable->ACPIState.levels[0].gen2XSP =\r\npi->acpi_pcie_gen2;\r\n} else {\r\nrv770_populate_vddc_value(rdev, pi->min_vddc_in_table,\r\n&table->ACPIState.levels[0].vddc);\r\ntable->ACPIState.levels[0].gen2PCIE = 0;\r\n}\r\nmpll_ad_func_cntl_2 |= BIAS_GEN_PDNB | RESET_EN;\r\nmpll_dq_func_cntl_2 |= BYPASS | BIAS_GEN_PDNB | RESET_EN;\r\nmclk_pwrmgt_cntl |= (MRDCKA0_RESET |\r\nMRDCKA1_RESET |\r\nMRDCKB0_RESET |\r\nMRDCKB1_RESET |\r\nMRDCKC0_RESET |\r\nMRDCKC1_RESET |\r\nMRDCKD0_RESET |\r\nMRDCKD1_RESET);\r\ndll_cntl |= (MRDCKA0_BYPASS |\r\nMRDCKA1_BYPASS |\r\nMRDCKB0_BYPASS |\r\nMRDCKB1_BYPASS |\r\nMRDCKC0_BYPASS |\r\nMRDCKC1_BYPASS |\r\nMRDCKD0_BYPASS |\r\nMRDCKD1_BYPASS);\r\nspll_func_cntl |= SPLL_RESET | SPLL_SLEEP | SPLL_BYPASS_EN;\r\nspll_func_cntl_2 &= ~SCLK_MUX_SEL_MASK;\r\nspll_func_cntl_2 |= SCLK_MUX_SEL(4);\r\ntable->ACPIState.levels[0].mclk.mclk770.vMPLL_AD_FUNC_CNTL = cpu_to_be32(mpll_ad_func_cntl);\r\ntable->ACPIState.levels[0].mclk.mclk770.vMPLL_AD_FUNC_CNTL_2 = cpu_to_be32(mpll_ad_func_cntl_2);\r\ntable->ACPIState.levels[0].mclk.mclk770.vMPLL_DQ_FUNC_CNTL = cpu_to_be32(mpll_dq_func_cntl);\r\ntable->ACPIState.levels[0].mclk.mclk770.vMPLL_DQ_FUNC_CNTL_2 = cpu_to_be32(mpll_dq_func_cntl_2);\r\ntable->ACPIState.levels[0].mclk.mclk770.vMCLK_PWRMGT_CNTL = cpu_to_be32(mclk_pwrmgt_cntl);\r\ntable->ACPIState.levels[0].mclk.mclk770.vDLL_CNTL = cpu_to_be32(dll_cntl);\r\ntable->ACPIState.levels[0].mclk.mclk770.mclk_value = 0;\r\ntable->ACPIState.levels[0].sclk.vCG_SPLL_FUNC_CNTL = cpu_to_be32(spll_func_cntl);\r\ntable->ACPIState.levels[0].sclk.vCG_SPLL_FUNC_CNTL_2 = cpu_to_be32(spll_func_cntl_2);\r\ntable->ACPIState.levels[0].sclk.vCG_SPLL_FUNC_CNTL_3 = cpu_to_be32(spll_func_cntl_3);\r\ntable->ACPIState.levels[0].sclk.sclk_value = 0;\r\ntable->ACPIState.levels[1] = table->ACPIState.levels[0];\r\ntable->ACPIState.levels[2] = table->ACPIState.levels[0];\r\nrv770_populate_mvdd_value(rdev, 0, &table->ACPIState.levels[0].mvdd);\r\nreturn 0;\r\n}\r\nvoid rv740_enable_mclk_spread_spectrum(struct radeon_device *rdev,\r\nbool enable)\r\n{\r\nif (enable)\r\nWREG32_P(MPLL_CNTL_MODE, SS_SSEN, ~SS_SSEN);\r\nelse\r\nWREG32_P(MPLL_CNTL_MODE, 0, ~SS_SSEN);\r\n}\r\nu8 rv740_get_mclk_frequency_ratio(u32 memory_clock)\r\n{\r\nu8 mc_para_index;\r\nif ((memory_clock < 10000) || (memory_clock > 47500))\r\nmc_para_index = 0x00;\r\nelse\r\nmc_para_index = (u8)((memory_clock - 10000) / 2500);\r\nreturn mc_para_index;\r\n}

static unsigned int solo_eeprom_reg_read(struct solo_dev *solo_dev)\r\n{\r\nreturn solo_reg_read(solo_dev, SOLO_EEPROM_CTRL) & EE_DATA_READ;\r\n}\r\nstatic void solo_eeprom_reg_write(struct solo_dev *solo_dev, u32 data)\r\n{\r\nsolo_reg_write(solo_dev, SOLO_EEPROM_CTRL, data);\r\neeprom_delay();\r\n}\r\nstatic void solo_eeprom_cmd(struct solo_dev *solo_dev, int cmd)\r\n{\r\nint i;\r\nsolo_eeprom_reg_write(solo_dev, SOLO_EEPROM_ACCESS_EN);\r\nsolo_eeprom_reg_write(solo_dev, SOLO_EEPROM_ENABLE);\r\nfor (i = 4 + ADDR_LEN; i >= 0; i--) {\r\nint dataval = (cmd & (1 << i)) ? EE_DATA_WRITE : 0;\r\nsolo_eeprom_reg_write(solo_dev, SOLO_EEPROM_ENABLE | dataval);\r\nsolo_eeprom_reg_write(solo_dev, SOLO_EEPROM_ENABLE |\r\nEE_SHIFT_CLK | dataval);\r\n}\r\nsolo_eeprom_reg_write(solo_dev, SOLO_EEPROM_ENABLE);\r\n}\r\nunsigned int solo_eeprom_ewen(struct solo_dev *solo_dev, int w_en)\r\n{\r\nint ewen_cmd = (w_en ? 0x3f : 0) | (EE_EWEN_CMD << ADDR_LEN);\r\nunsigned int retval = 0;\r\nint i;\r\nsolo_eeprom_cmd(solo_dev, ewen_cmd);\r\nfor (i = 0; i < 16; i++) {\r\nsolo_eeprom_reg_write(solo_dev, SOLO_EEPROM_ENABLE |\r\nEE_SHIFT_CLK);\r\nretval = (retval << 1) | solo_eeprom_reg_read(solo_dev);\r\nsolo_eeprom_reg_write(solo_dev, SOLO_EEPROM_ENABLE);\r\nretval = (retval << 1) | solo_eeprom_reg_read(solo_dev);\r\n}\r\nsolo_eeprom_reg_write(solo_dev, ~EE_CS);\r\nretval = (retval << 1) | solo_eeprom_reg_read(solo_dev);\r\nreturn retval;\r\n}\r\nunsigned short solo_eeprom_read(struct solo_dev *solo_dev, int loc)\r\n{\r\nint read_cmd = loc | (EE_READ_CMD << ADDR_LEN);\r\nunsigned short retval = 0;\r\nint i;\r\nsolo_eeprom_cmd(solo_dev, read_cmd);\r\nfor (i = 0; i < 16; i++) {\r\nsolo_eeprom_reg_write(solo_dev, SOLO_EEPROM_ENABLE |\r\nEE_SHIFT_CLK);\r\nretval = (retval << 1) | solo_eeprom_reg_read(solo_dev);\r\nsolo_eeprom_reg_write(solo_dev, SOLO_EEPROM_ENABLE);\r\n}\r\nsolo_eeprom_reg_write(solo_dev, ~EE_CS);\r\nreturn retval;\r\n}\r\nint solo_eeprom_write(struct solo_dev *solo_dev, int loc,\r\nunsigned short data)\r\n{\r\nint write_cmd = loc | (EE_WRITE_CMD << ADDR_LEN);\r\nunsigned int retval;\r\nint i;\r\nsolo_eeprom_cmd(solo_dev, write_cmd);\r\nfor (i = 15; i >= 0; i--) {\r\nunsigned int dataval = (data >> i) & 1;\r\nsolo_eeprom_reg_write(solo_dev, EE_ENB);\r\nsolo_eeprom_reg_write(solo_dev,\r\nEE_ENB | (dataval << 1) | EE_SHIFT_CLK);\r\n}\r\nsolo_eeprom_reg_write(solo_dev, EE_ENB);\r\nsolo_eeprom_reg_write(solo_dev, ~EE_CS);\r\nsolo_eeprom_reg_write(solo_dev, EE_ENB);\r\nfor (i = retval = 0; i < 10000 && !retval; i++)\r\nretval = solo_eeprom_reg_read(solo_dev);\r\nsolo_eeprom_reg_write(solo_dev, ~EE_CS);\r\nreturn !retval;\r\n}

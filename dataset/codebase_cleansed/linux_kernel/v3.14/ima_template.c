static int __init ima_template_setup(char *str)\r\n{\r\nstruct ima_template_desc *template_desc;\r\nint template_len = strlen(str);\r\ntemplate_desc = lookup_template_desc(str);\r\nif (!template_desc)\r\nreturn 1;\r\nif (template_len == 3 && strcmp(str, IMA_TEMPLATE_IMA_NAME) == 0 &&\r\nima_hash_algo != HASH_ALGO_SHA1 && ima_hash_algo != HASH_ALGO_MD5) {\r\npr_err("IMA: template does not support hash alg\n");\r\nreturn 1;\r\n}\r\nima_template = template_desc;\r\nreturn 1;\r\n}\r\nstatic struct ima_template_desc *lookup_template_desc(const char *name)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(defined_templates); i++) {\r\nif (strcmp(defined_templates[i].name, name) == 0)\r\nreturn defined_templates + i;\r\n}\r\nreturn NULL;\r\n}\r\nstatic struct ima_template_field *lookup_template_field(const char *field_id)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(supported_fields); i++)\r\nif (strncmp(supported_fields[i].field_id, field_id,\r\nIMA_TEMPLATE_FIELD_ID_MAX_LEN) == 0)\r\nreturn &supported_fields[i];\r\nreturn NULL;\r\n}\r\nstatic int template_fmt_size(const char *template_fmt)\r\n{\r\nchar c;\r\nint template_fmt_len = strlen(template_fmt);\r\nint i = 0, j = 0;\r\nwhile (i < template_fmt_len) {\r\nc = template_fmt[i];\r\nif (c == '|')\r\nj++;\r\ni++;\r\n}\r\nreturn j + 1;\r\n}\r\nstatic int template_desc_init_fields(const char *template_fmt,\r\nstruct ima_template_field ***fields,\r\nint *num_fields)\r\n{\r\nchar *c, *template_fmt_copy, *template_fmt_ptr;\r\nint template_num_fields = template_fmt_size(template_fmt);\r\nint i, result = 0;\r\nif (template_num_fields > IMA_TEMPLATE_NUM_FIELDS_MAX)\r\nreturn -EINVAL;\r\ntemplate_fmt_copy = kstrdup(template_fmt, GFP_KERNEL);\r\nif (template_fmt_copy == NULL)\r\nreturn -ENOMEM;\r\n*fields = kzalloc(template_num_fields * sizeof(*fields), GFP_KERNEL);\r\nif (*fields == NULL) {\r\nresult = -ENOMEM;\r\ngoto out;\r\n}\r\ntemplate_fmt_ptr = template_fmt_copy;\r\nfor (i = 0; (c = strsep(&template_fmt_ptr, "|")) != NULL &&\r\ni < template_num_fields; i++) {\r\nstruct ima_template_field *f = lookup_template_field(c);\r\nif (!f) {\r\nresult = -ENOENT;\r\ngoto out;\r\n}\r\n(*fields)[i] = f;\r\n}\r\n*num_fields = i;\r\nout:\r\nif (result < 0) {\r\nkfree(*fields);\r\n*fields = NULL;\r\n}\r\nkfree(template_fmt_copy);\r\nreturn result;\r\n}\r\nstatic int init_defined_templates(void)\r\n{\r\nint i = 0;\r\nint result = 0;\r\nfor (i = 0; i < ARRAY_SIZE(defined_templates); i++) {\r\nstruct ima_template_desc *template = &defined_templates[i];\r\nresult = template_desc_init_fields(template->fmt,\r\n&(template->fields),\r\n&(template->num_fields));\r\nif (result < 0)\r\nreturn result;\r\n}\r\nreturn result;\r\n}\r\nstruct ima_template_desc *ima_template_desc_current(void)\r\n{\r\nif (!ima_template)\r\nima_template =\r\nlookup_template_desc(CONFIG_IMA_DEFAULT_TEMPLATE);\r\nreturn ima_template;\r\n}\r\nint ima_init_template(void)\r\n{\r\nint result;\r\nresult = init_defined_templates();\r\nif (result < 0)\r\nreturn result;\r\nreturn 0;\r\n}

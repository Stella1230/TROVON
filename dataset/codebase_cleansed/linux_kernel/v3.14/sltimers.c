irqreturn_t mcfslt_profile_tick(int irq, void *dummy)\r\n{\r\n__raw_writel(MCFSLT_SSR_BE | MCFSLT_SSR_TE, PA(MCFSLT_SSR));\r\nif (current->pid)\r\nprofile_tick(CPU_PROFILING);\r\nreturn IRQ_HANDLED;\r\n}\r\nvoid mcfslt_profile_init(void)\r\n{\r\nprintk(KERN_INFO "PROFILE: lodging TIMER 1 @ %dHz as profile timer\n",\r\nPROFILEHZ);\r\nsetup_irq(MCF_IRQ_PROFILER, &mcfslt_profile_irq);\r\n__raw_writel(MCF_BUSCLK / PROFILEHZ - 1, PA(MCFSLT_STCNT));\r\n__raw_writel(MCFSLT_SCR_RUN | MCFSLT_SCR_IEN | MCFSLT_SCR_TEN,\r\nPA(MCFSLT_SCR));\r\n}\r\nstatic irqreturn_t mcfslt_tick(int irq, void *dummy)\r\n{\r\n__raw_writel(MCFSLT_SSR_BE | MCFSLT_SSR_TE, TA(MCFSLT_SSR));\r\nmcfslt_cnt += mcfslt_cycles_per_jiffy;\r\nreturn timer_interrupt(irq, dummy);\r\n}\r\nstatic cycle_t mcfslt_read_clk(struct clocksource *cs)\r\n{\r\nunsigned long flags;\r\nu32 cycles, scnt;\r\nlocal_irq_save(flags);\r\nscnt = __raw_readl(TA(MCFSLT_SCNT));\r\ncycles = mcfslt_cnt;\r\nif (__raw_readl(TA(MCFSLT_SSR)) & MCFSLT_SSR_TE) {\r\ncycles += mcfslt_cycles_per_jiffy;\r\nscnt = __raw_readl(TA(MCFSLT_SCNT));\r\n}\r\nlocal_irq_restore(flags);\r\nreturn cycles + ((mcfslt_cycles_per_jiffy - 1) - scnt);\r\n}\r\nvoid hw_timer_init(irq_handler_t handler)\r\n{\r\nmcfslt_cycles_per_jiffy = MCF_BUSCLK / HZ;\r\n__raw_writel(mcfslt_cycles_per_jiffy - 1, TA(MCFSLT_STCNT));\r\n__raw_writel(MCFSLT_SCR_RUN | MCFSLT_SCR_IEN | MCFSLT_SCR_TEN,\r\nTA(MCFSLT_SCR));\r\nmcfslt_cnt = mcfslt_cycles_per_jiffy;\r\ntimer_interrupt = handler;\r\nsetup_irq(MCF_IRQ_TIMER, &mcfslt_timer_irq);\r\nclocksource_register_hz(&mcfslt_clk, MCF_BUSCLK);\r\n#ifdef CONFIG_HIGHPROFILE\r\nmcfslt_profile_init();\r\n#endif\r\n}

static int lm4857_get_mode(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_codec *codec = snd_kcontrol_chip(kcontrol);\r\nstruct lm4857 *lm4857 = snd_soc_codec_get_drvdata(codec);\r\nucontrol->value.integer.value[0] = lm4857->mode;\r\nreturn 0;\r\n}\r\nstatic int lm4857_set_mode(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_codec *codec = snd_kcontrol_chip(kcontrol);\r\nstruct lm4857 *lm4857 = snd_soc_codec_get_drvdata(codec);\r\nuint8_t value = ucontrol->value.integer.value[0];\r\nlm4857->mode = value;\r\nif (codec->dapm.bias_level == SND_SOC_BIAS_ON)\r\nregmap_update_bits(lm4857->regmap, LM4857_CTRL, 0x0F, value + 6);\r\nreturn 1;\r\n}\r\nstatic int lm4857_set_bias_level(struct snd_soc_codec *codec,\r\nenum snd_soc_bias_level level)\r\n{\r\nstruct lm4857 *lm4857 = snd_soc_codec_get_drvdata(codec);\r\nswitch (level) {\r\ncase SND_SOC_BIAS_ON:\r\nregmap_update_bits(lm4857->regmap, LM4857_CTRL, 0x0F,\r\nlm4857->mode + 6);\r\nbreak;\r\ncase SND_SOC_BIAS_STANDBY:\r\nregmap_update_bits(lm4857->regmap, LM4857_CTRL, 0x0F, 0);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\ncodec->dapm.bias_level = level;\r\nreturn 0;\r\n}\r\nstatic int lm4857_i2c_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct lm4857 *lm4857;\r\nlm4857 = devm_kzalloc(&i2c->dev, sizeof(*lm4857), GFP_KERNEL);\r\nif (!lm4857)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(i2c, lm4857);\r\nlm4857->regmap = devm_regmap_init_i2c(i2c, &lm4857_regmap_config);\r\nif (IS_ERR(lm4857->regmap))\r\nreturn PTR_ERR(lm4857->regmap);\r\nreturn snd_soc_register_codec(&i2c->dev, &soc_codec_dev_lm4857, NULL, 0);\r\n}\r\nstatic int lm4857_i2c_remove(struct i2c_client *i2c)\r\n{\r\nsnd_soc_unregister_codec(&i2c->dev);\r\nreturn 0;\r\n}

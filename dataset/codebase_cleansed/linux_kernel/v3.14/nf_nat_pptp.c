static void pptp_nat_expected(struct nf_conn *ct,\r\nstruct nf_conntrack_expect *exp)\r\n{\r\nstruct net *net = nf_ct_net(ct);\r\nconst struct nf_conn *master = ct->master;\r\nstruct nf_conntrack_expect *other_exp;\r\nstruct nf_conntrack_tuple t;\r\nconst struct nf_ct_pptp_master *ct_pptp_info;\r\nconst struct nf_nat_pptp *nat_pptp_info;\r\nstruct nf_nat_range range;\r\nct_pptp_info = nfct_help_data(master);\r\nnat_pptp_info = &nfct_nat(master)->help.nat_pptp_info;\r\nif (exp->dir == IP_CT_DIR_ORIGINAL) {\r\npr_debug("we are PNS->PAC\n");\r\nt.src.l3num = AF_INET;\r\nt.src.u3.ip = master->tuplehash[!exp->dir].tuple.src.u3.ip;\r\nt.src.u.gre.key = ct_pptp_info->pac_call_id;\r\nt.dst.u3.ip = master->tuplehash[!exp->dir].tuple.dst.u3.ip;\r\nt.dst.u.gre.key = ct_pptp_info->pns_call_id;\r\nt.dst.protonum = IPPROTO_GRE;\r\n} else {\r\npr_debug("we are PAC->PNS\n");\r\nt.src.l3num = AF_INET;\r\nt.src.u3.ip = master->tuplehash[!exp->dir].tuple.src.u3.ip;\r\nt.src.u.gre.key = nat_pptp_info->pns_call_id;\r\nt.dst.u3.ip = master->tuplehash[!exp->dir].tuple.dst.u3.ip;\r\nt.dst.u.gre.key = nat_pptp_info->pac_call_id;\r\nt.dst.protonum = IPPROTO_GRE;\r\n}\r\npr_debug("trying to unexpect other dir: ");\r\nnf_ct_dump_tuple_ip(&t);\r\nother_exp = nf_ct_expect_find_get(net, nf_ct_zone(ct), &t);\r\nif (other_exp) {\r\nnf_ct_unexpect_related(other_exp);\r\nnf_ct_expect_put(other_exp);\r\npr_debug("success\n");\r\n} else {\r\npr_debug("not found!\n");\r\n}\r\nBUG_ON(ct->status & IPS_NAT_DONE_MASK);\r\nrange.flags = NF_NAT_RANGE_MAP_IPS;\r\nrange.min_addr = range.max_addr\r\n= ct->master->tuplehash[!exp->dir].tuple.dst.u3;\r\nif (exp->dir == IP_CT_DIR_ORIGINAL) {\r\nrange.flags |= NF_NAT_RANGE_PROTO_SPECIFIED;\r\nrange.min_proto = range.max_proto = exp->saved_proto;\r\n}\r\nnf_nat_setup_info(ct, &range, NF_NAT_MANIP_SRC);\r\nrange.flags = NF_NAT_RANGE_MAP_IPS;\r\nrange.min_addr = range.max_addr\r\n= ct->master->tuplehash[!exp->dir].tuple.src.u3;\r\nif (exp->dir == IP_CT_DIR_REPLY) {\r\nrange.flags |= NF_NAT_RANGE_PROTO_SPECIFIED;\r\nrange.min_proto = range.max_proto = exp->saved_proto;\r\n}\r\nnf_nat_setup_info(ct, &range, NF_NAT_MANIP_DST);\r\n}\r\nstatic int\r\npptp_outbound_pkt(struct sk_buff *skb,\r\nstruct nf_conn *ct,\r\nenum ip_conntrack_info ctinfo,\r\nunsigned int protoff,\r\nstruct PptpControlHeader *ctlh,\r\nunion pptp_ctrl_union *pptpReq)\r\n{\r\nstruct nf_ct_pptp_master *ct_pptp_info;\r\nstruct nf_nat_pptp *nat_pptp_info;\r\nu_int16_t msg;\r\n__be16 new_callid;\r\nunsigned int cid_off;\r\nct_pptp_info = nfct_help_data(ct);\r\nnat_pptp_info = &nfct_nat(ct)->help.nat_pptp_info;\r\nnew_callid = ct_pptp_info->pns_call_id;\r\nswitch (msg = ntohs(ctlh->messageType)) {\r\ncase PPTP_OUT_CALL_REQUEST:\r\ncid_off = offsetof(union pptp_ctrl_union, ocreq.callID);\r\nnat_pptp_info->pns_call_id = ct_pptp_info->pns_call_id;\r\nnew_callid = ct->tuplehash[IP_CT_DIR_REPLY].tuple.dst.u.tcp.port;\r\nct_pptp_info->pns_call_id = new_callid;\r\nbreak;\r\ncase PPTP_IN_CALL_REPLY:\r\ncid_off = offsetof(union pptp_ctrl_union, icack.callID);\r\nbreak;\r\ncase PPTP_CALL_CLEAR_REQUEST:\r\ncid_off = offsetof(union pptp_ctrl_union, clrreq.callID);\r\nbreak;\r\ndefault:\r\npr_debug("unknown outbound packet 0x%04x:%s\n", msg,\r\nmsg <= PPTP_MSG_MAX ? pptp_msg_name[msg] :\r\npptp_msg_name[0]);\r\ncase PPTP_SET_LINK_INFO:\r\ncase PPTP_START_SESSION_REQUEST:\r\ncase PPTP_START_SESSION_REPLY:\r\ncase PPTP_STOP_SESSION_REQUEST:\r\ncase PPTP_STOP_SESSION_REPLY:\r\ncase PPTP_ECHO_REQUEST:\r\ncase PPTP_ECHO_REPLY:\r\nreturn NF_ACCEPT;\r\n}\r\npr_debug("altering call id from 0x%04x to 0x%04x\n",\r\nntohs(REQ_CID(pptpReq, cid_off)), ntohs(new_callid));\r\nif (nf_nat_mangle_tcp_packet(skb, ct, ctinfo, protoff,\r\ncid_off + sizeof(struct pptp_pkt_hdr) +\r\nsizeof(struct PptpControlHeader),\r\nsizeof(new_callid), (char *)&new_callid,\r\nsizeof(new_callid)) == 0)\r\nreturn NF_DROP;\r\nreturn NF_ACCEPT;\r\n}\r\nstatic void\r\npptp_exp_gre(struct nf_conntrack_expect *expect_orig,\r\nstruct nf_conntrack_expect *expect_reply)\r\n{\r\nconst struct nf_conn *ct = expect_orig->master;\r\nstruct nf_ct_pptp_master *ct_pptp_info;\r\nstruct nf_nat_pptp *nat_pptp_info;\r\nct_pptp_info = nfct_help_data(ct);\r\nnat_pptp_info = &nfct_nat(ct)->help.nat_pptp_info;\r\nnat_pptp_info->pac_call_id = ct_pptp_info->pac_call_id;\r\nexpect_orig->saved_proto.gre.key = ct_pptp_info->pns_call_id;\r\nexpect_orig->tuple.src.u.gre.key = nat_pptp_info->pns_call_id;\r\nexpect_orig->tuple.dst.u.gre.key = ct_pptp_info->pac_call_id;\r\nexpect_orig->dir = IP_CT_DIR_ORIGINAL;\r\nexpect_reply->saved_proto.gre.key = nat_pptp_info->pns_call_id;\r\nexpect_reply->tuple.src.u.gre.key = nat_pptp_info->pac_call_id;\r\nexpect_reply->tuple.dst.u.gre.key = ct_pptp_info->pns_call_id;\r\nexpect_reply->dir = IP_CT_DIR_REPLY;\r\n}\r\nstatic int\r\npptp_inbound_pkt(struct sk_buff *skb,\r\nstruct nf_conn *ct,\r\nenum ip_conntrack_info ctinfo,\r\nunsigned int protoff,\r\nstruct PptpControlHeader *ctlh,\r\nunion pptp_ctrl_union *pptpReq)\r\n{\r\nconst struct nf_nat_pptp *nat_pptp_info;\r\nu_int16_t msg;\r\n__be16 new_pcid;\r\nunsigned int pcid_off;\r\nnat_pptp_info = &nfct_nat(ct)->help.nat_pptp_info;\r\nnew_pcid = nat_pptp_info->pns_call_id;\r\nswitch (msg = ntohs(ctlh->messageType)) {\r\ncase PPTP_OUT_CALL_REPLY:\r\npcid_off = offsetof(union pptp_ctrl_union, ocack.peersCallID);\r\nbreak;\r\ncase PPTP_IN_CALL_CONNECT:\r\npcid_off = offsetof(union pptp_ctrl_union, iccon.peersCallID);\r\nbreak;\r\ncase PPTP_IN_CALL_REQUEST:\r\nreturn NF_ACCEPT;\r\ncase PPTP_WAN_ERROR_NOTIFY:\r\npcid_off = offsetof(union pptp_ctrl_union, wanerr.peersCallID);\r\nbreak;\r\ncase PPTP_CALL_DISCONNECT_NOTIFY:\r\npcid_off = offsetof(union pptp_ctrl_union, disc.callID);\r\nbreak;\r\ncase PPTP_SET_LINK_INFO:\r\npcid_off = offsetof(union pptp_ctrl_union, setlink.peersCallID);\r\nbreak;\r\ndefault:\r\npr_debug("unknown inbound packet %s\n",\r\nmsg <= PPTP_MSG_MAX ? pptp_msg_name[msg] :\r\npptp_msg_name[0]);\r\ncase PPTP_START_SESSION_REQUEST:\r\ncase PPTP_START_SESSION_REPLY:\r\ncase PPTP_STOP_SESSION_REQUEST:\r\ncase PPTP_STOP_SESSION_REPLY:\r\ncase PPTP_ECHO_REQUEST:\r\ncase PPTP_ECHO_REPLY:\r\nreturn NF_ACCEPT;\r\n}\r\npr_debug("altering peer call id from 0x%04x to 0x%04x\n",\r\nntohs(REQ_CID(pptpReq, pcid_off)), ntohs(new_pcid));\r\nif (nf_nat_mangle_tcp_packet(skb, ct, ctinfo, protoff,\r\npcid_off + sizeof(struct pptp_pkt_hdr) +\r\nsizeof(struct PptpControlHeader),\r\nsizeof(new_pcid), (char *)&new_pcid,\r\nsizeof(new_pcid)) == 0)\r\nreturn NF_DROP;\r\nreturn NF_ACCEPT;\r\n}\r\nstatic int __init nf_nat_helper_pptp_init(void)\r\n{\r\nnf_nat_need_gre();\r\nBUG_ON(nf_nat_pptp_hook_outbound != NULL);\r\nRCU_INIT_POINTER(nf_nat_pptp_hook_outbound, pptp_outbound_pkt);\r\nBUG_ON(nf_nat_pptp_hook_inbound != NULL);\r\nRCU_INIT_POINTER(nf_nat_pptp_hook_inbound, pptp_inbound_pkt);\r\nBUG_ON(nf_nat_pptp_hook_exp_gre != NULL);\r\nRCU_INIT_POINTER(nf_nat_pptp_hook_exp_gre, pptp_exp_gre);\r\nBUG_ON(nf_nat_pptp_hook_expectfn != NULL);\r\nRCU_INIT_POINTER(nf_nat_pptp_hook_expectfn, pptp_nat_expected);\r\nreturn 0;\r\n}\r\nstatic void __exit nf_nat_helper_pptp_fini(void)\r\n{\r\nRCU_INIT_POINTER(nf_nat_pptp_hook_expectfn, NULL);\r\nRCU_INIT_POINTER(nf_nat_pptp_hook_exp_gre, NULL);\r\nRCU_INIT_POINTER(nf_nat_pptp_hook_inbound, NULL);\r\nRCU_INIT_POINTER(nf_nat_pptp_hook_outbound, NULL);\r\nsynchronize_rcu();\r\n}

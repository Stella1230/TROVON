static void udbg_scc_putc(char c)\r\n{\r\nif (sccc) {\r\nwhile ((in_8(sccc) & SCC_TXRDY) == 0)\r\n;\r\nout_8(sccd, c);\r\nif (c == '\n')\r\nudbg_scc_putc('\r');\r\n}\r\n}\r\nstatic int udbg_scc_getc_poll(void)\r\n{\r\nif (sccc) {\r\nif ((in_8(sccc) & SCC_RXRDY) != 0)\r\nreturn in_8(sccd);\r\nelse\r\nreturn -1;\r\n}\r\nreturn -1;\r\n}\r\nstatic int udbg_scc_getc(void)\r\n{\r\nif (sccc) {\r\nwhile ((in_8(sccc) & SCC_RXRDY) == 0)\r\n;\r\nreturn in_8(sccd);\r\n}\r\nreturn -1;\r\n}\r\nvoid udbg_scc_init(int force_scc)\r\n{\r\nconst u32 *reg;\r\nunsigned long addr;\r\nstruct device_node *stdout = NULL, *escc = NULL, *macio = NULL;\r\nstruct device_node *ch, *ch_def = NULL, *ch_a = NULL;\r\nconst char *path;\r\nint i, x;\r\nescc = of_find_node_by_name(NULL, "escc");\r\nif (escc == NULL)\r\ngoto bail;\r\nmacio = of_get_parent(escc);\r\nif (macio == NULL)\r\ngoto bail;\r\npath = of_get_property(of_chosen, "linux,stdout-path", NULL);\r\nif (path != NULL)\r\nstdout = of_find_node_by_path(path);\r\nfor (ch = NULL; (ch = of_get_next_child(escc, ch)) != NULL;) {\r\nif (ch == stdout)\r\nch_def = of_node_get(ch);\r\nif (strcmp(ch->name, "ch-a") == 0)\r\nch_a = of_node_get(ch);\r\n}\r\nif (ch_def == NULL && !force_scc)\r\ngoto bail;\r\nch = ch_def ? ch_def : ch_a;\r\nreg = of_get_property(escc, "reg", NULL);\r\nif (reg == NULL)\r\ngoto bail;\r\naddr = reg[0];\r\nreg = of_get_property(macio, "assigned-addresses", NULL);\r\nif (reg == NULL)\r\ngoto bail;\r\naddr += reg[2];\r\npmac_call_feature(PMAC_FTR_SCC_ENABLE, ch,\r\nPMAC_SCC_ASYNC | PMAC_SCC_FLAG_XMON, 1);\r\nif (ch == ch_a)\r\naddr += 0x20;\r\nsccc = ioremap(addr & PAGE_MASK, PAGE_SIZE) ;\r\nsccc += addr & ~PAGE_MASK;\r\nsccd = sccc + 0x10;\r\nmb();\r\nfor (i = 20000; i != 0; --i)\r\nx = in_8(sccc);\r\nout_8(sccc, 0x09);\r\nout_8(sccc, 0xc0);\r\nif (ch_def != NULL) {\r\nout_8(sccc, 13);\r\nscc_inittab[1] = in_8(sccc);\r\nout_8(sccc, 12);\r\nscc_inittab[3] = in_8(sccc);\r\n} else if (of_machine_is_compatible("RackMac1,1")\r\n|| of_machine_is_compatible("RackMac1,2")\r\n|| of_machine_is_compatible("MacRISC4")) {\r\nscc_inittab[1] = 0;\r\nscc_inittab[3] = 0;\r\n} else {\r\nscc_inittab[1] = 0;\r\nscc_inittab[3] = 1;\r\n}\r\nfor (i = 0; i < sizeof(scc_inittab); ++i)\r\nout_8(sccc, scc_inittab[i]);\r\nudbg_putc = udbg_scc_putc;\r\nudbg_getc = udbg_scc_getc;\r\nudbg_getc_poll = udbg_scc_getc_poll;\r\nudbg_puts("Hello World !\n");\r\nbail:\r\nof_node_put(macio);\r\nof_node_put(escc);\r\nof_node_put(stdout);\r\nof_node_put(ch_def);\r\nof_node_put(ch_a);\r\n}\r\nstatic void udbg_real_scc_putc(char c)\r\n{\r\nwhile ((real_readb(sccc) & SCC_TXRDY) == 0)\r\n;\r\nreal_writeb(c, sccd);\r\nif (c == '\n')\r\nudbg_real_scc_putc('\r');\r\n}\r\nvoid __init udbg_init_pmac_realmode(void)\r\n{\r\nsccc = (volatile u8 __iomem *)0x80013020ul;\r\nsccd = (volatile u8 __iomem *)0x80013030ul;\r\nudbg_putc = udbg_real_scc_putc;\r\nudbg_getc = NULL;\r\nudbg_getc_poll = NULL;\r\n}

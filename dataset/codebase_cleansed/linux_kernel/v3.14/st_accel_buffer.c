int st_accel_trig_set_state(struct iio_trigger *trig, bool state)\r\n{\r\nstruct iio_dev *indio_dev = iio_trigger_get_drvdata(trig);\r\nreturn st_sensors_set_dataready_irq(indio_dev, state);\r\n}\r\nstatic int st_accel_buffer_preenable(struct iio_dev *indio_dev)\r\n{\r\nreturn st_sensors_set_enable(indio_dev, true);\r\n}\r\nstatic int st_accel_buffer_postenable(struct iio_dev *indio_dev)\r\n{\r\nint err;\r\nstruct st_sensor_data *adata = iio_priv(indio_dev);\r\nadata->buffer_data = kmalloc(indio_dev->scan_bytes, GFP_KERNEL);\r\nif (adata->buffer_data == NULL) {\r\nerr = -ENOMEM;\r\ngoto allocate_memory_error;\r\n}\r\nerr = st_sensors_set_axis_enable(indio_dev,\r\n(u8)indio_dev->active_scan_mask[0]);\r\nif (err < 0)\r\ngoto st_accel_buffer_postenable_error;\r\nerr = iio_triggered_buffer_postenable(indio_dev);\r\nif (err < 0)\r\ngoto st_accel_buffer_postenable_error;\r\nreturn err;\r\nst_accel_buffer_postenable_error:\r\nkfree(adata->buffer_data);\r\nallocate_memory_error:\r\nreturn err;\r\n}\r\nstatic int st_accel_buffer_predisable(struct iio_dev *indio_dev)\r\n{\r\nint err;\r\nstruct st_sensor_data *adata = iio_priv(indio_dev);\r\nerr = iio_triggered_buffer_predisable(indio_dev);\r\nif (err < 0)\r\ngoto st_accel_buffer_predisable_error;\r\nerr = st_sensors_set_axis_enable(indio_dev, ST_SENSORS_ENABLE_ALL_AXIS);\r\nif (err < 0)\r\ngoto st_accel_buffer_predisable_error;\r\nerr = st_sensors_set_enable(indio_dev, false);\r\nst_accel_buffer_predisable_error:\r\nkfree(adata->buffer_data);\r\nreturn err;\r\n}\r\nint st_accel_allocate_ring(struct iio_dev *indio_dev)\r\n{\r\nreturn iio_triggered_buffer_setup(indio_dev, &iio_pollfunc_store_time,\r\n&st_sensors_trigger_handler, &st_accel_buffer_setup_ops);\r\n}\r\nvoid st_accel_deallocate_ring(struct iio_dev *indio_dev)\r\n{\r\niio_triggered_buffer_cleanup(indio_dev);\r\n}

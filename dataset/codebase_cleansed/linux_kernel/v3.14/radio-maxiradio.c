static inline struct maxiradio *to_maxiradio(struct v4l2_device *v4l2_dev)\r\n{\r\nreturn container_of(v4l2_dev, struct maxiradio, v4l2_dev);\r\n}\r\nstatic void maxiradio_tea575x_set_pins(struct snd_tea575x *tea, u8 pins)\r\n{\r\nstruct maxiradio *dev = tea->private_data;\r\nu8 bits = 0;\r\nbits |= (pins & TEA575X_DATA) ? data : 0;\r\nbits |= (pins & TEA575X_CLK) ? clk : 0;\r\nbits |= (pins & TEA575X_WREN) ? wren : 0;\r\nbits |= power;\r\noutb(bits, dev->io);\r\n}\r\nstatic u8 maxiradio_tea575x_get_pins(struct snd_tea575x *tea)\r\n{\r\nstruct maxiradio *dev = tea->private_data;\r\nu8 bits = inb(dev->io);\r\nreturn ((bits & data) ? TEA575X_DATA : 0) |\r\n((bits & mo_st) ? TEA575X_MOST : 0);\r\n}\r\nstatic void maxiradio_tea575x_set_direction(struct snd_tea575x *tea, bool output)\r\n{\r\n}\r\nstatic int maxiradio_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *ent)\r\n{\r\nstruct maxiradio *dev;\r\nstruct v4l2_device *v4l2_dev;\r\nint retval = -ENOMEM;\r\ndev = kzalloc(sizeof(*dev), GFP_KERNEL);\r\nif (dev == NULL) {\r\ndev_err(&pdev->dev, "not enough memory\n");\r\nreturn -ENOMEM;\r\n}\r\nv4l2_dev = &dev->v4l2_dev;\r\nv4l2_device_set_name(v4l2_dev, "maxiradio", &maxiradio_instance);\r\nretval = v4l2_device_register(&pdev->dev, v4l2_dev);\r\nif (retval < 0) {\r\nv4l2_err(v4l2_dev, "Could not register v4l2_device\n");\r\ngoto errfr;\r\n}\r\ndev->tea.private_data = dev;\r\ndev->tea.ops = &maxiradio_tea_ops;\r\ndev->tea.cannot_read_data = true;\r\ndev->tea.v4l2_dev = v4l2_dev;\r\ndev->tea.radio_nr = radio_nr;\r\nstrlcpy(dev->tea.card, "Maxi Radio FM2000", sizeof(dev->tea.card));\r\nsnprintf(dev->tea.bus_info, sizeof(dev->tea.bus_info),\r\n"PCI:%s", pci_name(pdev));\r\nretval = -ENODEV;\r\nif (!request_region(pci_resource_start(pdev, 0),\r\npci_resource_len(pdev, 0), v4l2_dev->name)) {\r\ndev_err(&pdev->dev, "can't reserve I/O ports\n");\r\ngoto err_hdl;\r\n}\r\nif (pci_enable_device(pdev))\r\ngoto err_out_free_region;\r\ndev->io = pci_resource_start(pdev, 0);\r\nif (snd_tea575x_init(&dev->tea, THIS_MODULE)) {\r\nprintk(KERN_ERR "radio-maxiradio: Unable to detect TEA575x tuner\n");\r\ngoto err_out_free_region;\r\n}\r\nreturn 0;\r\nerr_out_free_region:\r\nrelease_region(pci_resource_start(pdev, 0), pci_resource_len(pdev, 0));\r\nerr_hdl:\r\nv4l2_device_unregister(v4l2_dev);\r\nerrfr:\r\nkfree(dev);\r\nreturn retval;\r\n}\r\nstatic void maxiradio_remove(struct pci_dev *pdev)\r\n{\r\nstruct v4l2_device *v4l2_dev = dev_get_drvdata(&pdev->dev);\r\nstruct maxiradio *dev = to_maxiradio(v4l2_dev);\r\nsnd_tea575x_exit(&dev->tea);\r\noutb(0, dev->io);\r\nv4l2_device_unregister(v4l2_dev);\r\nrelease_region(pci_resource_start(pdev, 0), pci_resource_len(pdev, 0));\r\n}

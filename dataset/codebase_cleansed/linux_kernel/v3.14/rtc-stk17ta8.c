static int stk17ta8_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct rtc_plat_data *pdata = platform_get_drvdata(pdev);\r\nvoid __iomem *ioaddr = pdata->ioaddr;\r\nu8 flags;\r\nflags = readb(pdata->ioaddr + RTC_FLAGS);\r\nwriteb(flags | RTC_WRITE, pdata->ioaddr + RTC_FLAGS);\r\nwriteb(bin2bcd(tm->tm_year % 100), ioaddr + RTC_YEAR);\r\nwriteb(bin2bcd(tm->tm_mon + 1), ioaddr + RTC_MONTH);\r\nwriteb(bin2bcd(tm->tm_wday) & RTC_DAY_MASK, ioaddr + RTC_DAY);\r\nwriteb(bin2bcd(tm->tm_mday), ioaddr + RTC_DATE);\r\nwriteb(bin2bcd(tm->tm_hour), ioaddr + RTC_HOURS);\r\nwriteb(bin2bcd(tm->tm_min), ioaddr + RTC_MINUTES);\r\nwriteb(bin2bcd(tm->tm_sec) & RTC_SECONDS_MASK, ioaddr + RTC_SECONDS);\r\nwriteb(bin2bcd((tm->tm_year + 1900) / 100), ioaddr + RTC_CENTURY);\r\nwriteb(flags & ~RTC_WRITE, pdata->ioaddr + RTC_FLAGS);\r\nreturn 0;\r\n}\r\nstatic int stk17ta8_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct rtc_plat_data *pdata = platform_get_drvdata(pdev);\r\nvoid __iomem *ioaddr = pdata->ioaddr;\r\nunsigned int year, month, day, hour, minute, second, week;\r\nunsigned int century;\r\nu8 flags;\r\nif (pdata->last_jiffies == jiffies)\r\nmsleep(1);\r\npdata->last_jiffies = jiffies;\r\nflags = readb(pdata->ioaddr + RTC_FLAGS);\r\nwriteb(flags | RTC_READ, ioaddr + RTC_FLAGS);\r\nsecond = readb(ioaddr + RTC_SECONDS) & RTC_SECONDS_MASK;\r\nminute = readb(ioaddr + RTC_MINUTES);\r\nhour = readb(ioaddr + RTC_HOURS);\r\nday = readb(ioaddr + RTC_DATE);\r\nweek = readb(ioaddr + RTC_DAY) & RTC_DAY_MASK;\r\nmonth = readb(ioaddr + RTC_MONTH);\r\nyear = readb(ioaddr + RTC_YEAR);\r\ncentury = readb(ioaddr + RTC_CENTURY);\r\nwriteb(flags & ~RTC_READ, ioaddr + RTC_FLAGS);\r\ntm->tm_sec = bcd2bin(second);\r\ntm->tm_min = bcd2bin(minute);\r\ntm->tm_hour = bcd2bin(hour);\r\ntm->tm_mday = bcd2bin(day);\r\ntm->tm_wday = bcd2bin(week);\r\ntm->tm_mon = bcd2bin(month) - 1;\r\ntm->tm_year = bcd2bin(year) + bcd2bin(century) * 100 - 1900;\r\nif (rtc_valid_tm(tm) < 0) {\r\ndev_err(dev, "retrieved date/time is not valid.\n");\r\nrtc_time_to_tm(0, tm);\r\n}\r\nreturn 0;\r\n}\r\nstatic void stk17ta8_rtc_update_alarm(struct rtc_plat_data *pdata)\r\n{\r\nvoid __iomem *ioaddr = pdata->ioaddr;\r\nunsigned long irqflags;\r\nu8 flags;\r\nspin_lock_irqsave(&pdata->lock, irqflags);\r\nflags = readb(ioaddr + RTC_FLAGS);\r\nwriteb(flags | RTC_WRITE, ioaddr + RTC_FLAGS);\r\nwriteb(pdata->alrm_mday < 0 || (pdata->irqen & RTC_UF) ?\r\n0x80 : bin2bcd(pdata->alrm_mday),\r\nioaddr + RTC_DATE_ALARM);\r\nwriteb(pdata->alrm_hour < 0 || (pdata->irqen & RTC_UF) ?\r\n0x80 : bin2bcd(pdata->alrm_hour),\r\nioaddr + RTC_HOURS_ALARM);\r\nwriteb(pdata->alrm_min < 0 || (pdata->irqen & RTC_UF) ?\r\n0x80 : bin2bcd(pdata->alrm_min),\r\nioaddr + RTC_MINUTES_ALARM);\r\nwriteb(pdata->alrm_sec < 0 || (pdata->irqen & RTC_UF) ?\r\n0x80 : bin2bcd(pdata->alrm_sec),\r\nioaddr + RTC_SECONDS_ALARM);\r\nwriteb(pdata->irqen ? RTC_INTS_AIE : 0, ioaddr + RTC_INTERRUPTS);\r\nreadb(ioaddr + RTC_FLAGS);\r\nwriteb(flags & ~RTC_WRITE, ioaddr + RTC_FLAGS);\r\nspin_unlock_irqrestore(&pdata->lock, irqflags);\r\n}\r\nstatic int stk17ta8_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct rtc_plat_data *pdata = platform_get_drvdata(pdev);\r\nif (pdata->irq <= 0)\r\nreturn -EINVAL;\r\npdata->alrm_mday = alrm->time.tm_mday;\r\npdata->alrm_hour = alrm->time.tm_hour;\r\npdata->alrm_min = alrm->time.tm_min;\r\npdata->alrm_sec = alrm->time.tm_sec;\r\nif (alrm->enabled)\r\npdata->irqen |= RTC_AF;\r\nstk17ta8_rtc_update_alarm(pdata);\r\nreturn 0;\r\n}\r\nstatic int stk17ta8_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct rtc_plat_data *pdata = platform_get_drvdata(pdev);\r\nif (pdata->irq <= 0)\r\nreturn -EINVAL;\r\nalrm->time.tm_mday = pdata->alrm_mday < 0 ? 0 : pdata->alrm_mday;\r\nalrm->time.tm_hour = pdata->alrm_hour < 0 ? 0 : pdata->alrm_hour;\r\nalrm->time.tm_min = pdata->alrm_min < 0 ? 0 : pdata->alrm_min;\r\nalrm->time.tm_sec = pdata->alrm_sec < 0 ? 0 : pdata->alrm_sec;\r\nalrm->enabled = (pdata->irqen & RTC_AF) ? 1 : 0;\r\nreturn 0;\r\n}\r\nstatic irqreturn_t stk17ta8_rtc_interrupt(int irq, void *dev_id)\r\n{\r\nstruct platform_device *pdev = dev_id;\r\nstruct rtc_plat_data *pdata = platform_get_drvdata(pdev);\r\nvoid __iomem *ioaddr = pdata->ioaddr;\r\nunsigned long events = 0;\r\nspin_lock(&pdata->lock);\r\nif (readb(ioaddr + RTC_FLAGS) & RTC_FLAGS_AF) {\r\nevents = RTC_IRQF;\r\nif (readb(ioaddr + RTC_SECONDS_ALARM) & 0x80)\r\nevents |= RTC_UF;\r\nelse\r\nevents |= RTC_AF;\r\nif (likely(pdata->rtc))\r\nrtc_update_irq(pdata->rtc, 1, events);\r\n}\r\nspin_unlock(&pdata->lock);\r\nreturn events ? IRQ_HANDLED : IRQ_NONE;\r\n}\r\nstatic int stk17ta8_rtc_alarm_irq_enable(struct device *dev,\r\nunsigned int enabled)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct rtc_plat_data *pdata = platform_get_drvdata(pdev);\r\nif (pdata->irq <= 0)\r\nreturn -EINVAL;\r\nif (enabled)\r\npdata->irqen |= RTC_AF;\r\nelse\r\npdata->irqen &= ~RTC_AF;\r\nstk17ta8_rtc_update_alarm(pdata);\r\nreturn 0;\r\n}\r\nstatic ssize_t stk17ta8_nvram_read(struct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *attr, char *buf,\r\nloff_t pos, size_t size)\r\n{\r\nstruct device *dev = container_of(kobj, struct device, kobj);\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct rtc_plat_data *pdata = platform_get_drvdata(pdev);\r\nvoid __iomem *ioaddr = pdata->ioaddr;\r\nssize_t count;\r\nfor (count = 0; size > 0 && pos < RTC_OFFSET; count++, size--)\r\n*buf++ = readb(ioaddr + pos++);\r\nreturn count;\r\n}\r\nstatic ssize_t stk17ta8_nvram_write(struct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *attr, char *buf,\r\nloff_t pos, size_t size)\r\n{\r\nstruct device *dev = container_of(kobj, struct device, kobj);\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct rtc_plat_data *pdata = platform_get_drvdata(pdev);\r\nvoid __iomem *ioaddr = pdata->ioaddr;\r\nssize_t count;\r\nfor (count = 0; size > 0 && pos < RTC_OFFSET; count++, size--)\r\nwriteb(*buf++, ioaddr + pos++);\r\nreturn count;\r\n}\r\nstatic int stk17ta8_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nunsigned int cal;\r\nunsigned int flags;\r\nstruct rtc_plat_data *pdata;\r\nvoid __iomem *ioaddr;\r\nint ret = 0;\r\npdata = devm_kzalloc(&pdev->dev, sizeof(*pdata), GFP_KERNEL);\r\nif (!pdata)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nioaddr = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(ioaddr))\r\nreturn PTR_ERR(ioaddr);\r\npdata->ioaddr = ioaddr;\r\npdata->irq = platform_get_irq(pdev, 0);\r\ncal = readb(ioaddr + RTC_CALIBRATION);\r\nif (cal & RTC_STOP) {\r\ncal &= RTC_CAL_MASK;\r\nflags = readb(ioaddr + RTC_FLAGS);\r\nwriteb(flags | RTC_WRITE, ioaddr + RTC_FLAGS);\r\nwriteb(cal, ioaddr + RTC_CALIBRATION);\r\nwriteb(flags & ~RTC_WRITE, ioaddr + RTC_FLAGS);\r\n}\r\nif (readb(ioaddr + RTC_FLAGS) & RTC_FLAGS_PF)\r\ndev_warn(&pdev->dev, "voltage-low detected.\n");\r\nspin_lock_init(&pdata->lock);\r\npdata->last_jiffies = jiffies;\r\nplatform_set_drvdata(pdev, pdata);\r\nif (pdata->irq > 0) {\r\nwriteb(0, ioaddr + RTC_INTERRUPTS);\r\nif (devm_request_irq(&pdev->dev, pdata->irq,\r\nstk17ta8_rtc_interrupt,\r\nIRQF_SHARED,\r\npdev->name, pdev) < 0) {\r\ndev_warn(&pdev->dev, "interrupt not available.\n");\r\npdata->irq = 0;\r\n}\r\n}\r\npdata->rtc = devm_rtc_device_register(&pdev->dev, pdev->name,\r\n&stk17ta8_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(pdata->rtc))\r\nreturn PTR_ERR(pdata->rtc);\r\nret = sysfs_create_bin_file(&pdev->dev.kobj, &stk17ta8_nvram_attr);\r\nreturn ret;\r\n}\r\nstatic int stk17ta8_rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct rtc_plat_data *pdata = platform_get_drvdata(pdev);\r\nsysfs_remove_bin_file(&pdev->dev.kobj, &stk17ta8_nvram_attr);\r\nif (pdata->irq > 0)\r\nwriteb(0, pdata->ioaddr + RTC_INTERRUPTS);\r\nreturn 0;\r\n}

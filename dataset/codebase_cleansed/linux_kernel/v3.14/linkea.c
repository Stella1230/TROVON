int linkea_data_new(struct linkea_data *ldata, struct lu_buf *buf)\r\n{\r\nldata->ld_buf = lu_buf_check_and_alloc(buf, PAGE_CACHE_SIZE);\r\nif (ldata->ld_buf->lb_buf == NULL)\r\nreturn -ENOMEM;\r\nldata->ld_leh = ldata->ld_buf->lb_buf;\r\nldata->ld_leh->leh_magic = LINK_EA_MAGIC;\r\nldata->ld_leh->leh_len = sizeof(struct link_ea_header);\r\nldata->ld_leh->leh_reccount = 0;\r\nreturn 0;\r\n}\r\nint linkea_init(struct linkea_data *ldata)\r\n{\r\nstruct link_ea_header *leh;\r\nLASSERT(ldata->ld_buf != NULL);\r\nleh = ldata->ld_buf->lb_buf;\r\nif (leh->leh_magic == __swab32(LINK_EA_MAGIC)) {\r\nleh->leh_magic = LINK_EA_MAGIC;\r\nleh->leh_reccount = __swab32(leh->leh_reccount);\r\nleh->leh_len = __swab64(leh->leh_len);\r\n}\r\nif (leh->leh_magic != LINK_EA_MAGIC)\r\nreturn -EINVAL;\r\nif (leh->leh_reccount == 0)\r\nreturn -ENODATA;\r\nldata->ld_leh = leh;\r\nreturn 0;\r\n}\r\nstatic int linkea_entry_pack(struct link_ea_entry *lee,\r\nconst struct lu_name *lname,\r\nconst struct lu_fid *pfid)\r\n{\r\nstruct lu_fid tmpfid;\r\nint reclen;\r\nfid_cpu_to_be(&tmpfid, pfid);\r\nif (OBD_FAIL_CHECK(OBD_FAIL_LFSCK_LINKEA_CRASH))\r\ntmpfid.f_ver = ~0;\r\nmemcpy(&lee->lee_parent_fid, &tmpfid, sizeof(tmpfid));\r\nmemcpy(lee->lee_name, lname->ln_name, lname->ln_namelen);\r\nreclen = sizeof(struct link_ea_entry) + lname->ln_namelen;\r\nlee->lee_reclen[0] = (reclen >> 8) & 0xff;\r\nlee->lee_reclen[1] = reclen & 0xff;\r\nreturn reclen;\r\n}\r\nvoid linkea_entry_unpack(const struct link_ea_entry *lee, int *reclen,\r\nstruct lu_name *lname, struct lu_fid *pfid)\r\n{\r\n*reclen = (lee->lee_reclen[0] << 8) | lee->lee_reclen[1];\r\nmemcpy(pfid, &lee->lee_parent_fid, sizeof(*pfid));\r\nfid_be_to_cpu(pfid, pfid);\r\nlname->ln_name = lee->lee_name;\r\nlname->ln_namelen = *reclen - sizeof(struct link_ea_entry);\r\n}\r\nint linkea_add_buf(struct linkea_data *ldata, const struct lu_name *lname,\r\nconst struct lu_fid *pfid)\r\n{\r\nLASSERT(ldata->ld_leh != NULL);\r\nif (lname == NULL || pfid == NULL)\r\nreturn -EINVAL;\r\nldata->ld_reclen = lname->ln_namelen + sizeof(struct link_ea_entry);\r\nif (ldata->ld_leh->leh_len + ldata->ld_reclen >\r\nldata->ld_buf->lb_len) {\r\nif (lu_buf_check_and_grow(ldata->ld_buf,\r\nldata->ld_leh->leh_len +\r\nldata->ld_reclen) < 0)\r\nreturn -ENOMEM;\r\n}\r\nldata->ld_leh = ldata->ld_buf->lb_buf;\r\nldata->ld_lee = ldata->ld_buf->lb_buf + ldata->ld_leh->leh_len;\r\nldata->ld_reclen = linkea_entry_pack(ldata->ld_lee, lname, pfid);\r\nldata->ld_leh->leh_len += ldata->ld_reclen;\r\nldata->ld_leh->leh_reccount++;\r\nCDEBUG(D_INODE, "New link_ea name '%.*s' is added\n",\r\nlname->ln_namelen, lname->ln_name);\r\nreturn 0;\r\n}\r\nvoid linkea_del_buf(struct linkea_data *ldata, const struct lu_name *lname)\r\n{\r\nLASSERT(ldata->ld_leh != NULL && ldata->ld_lee != NULL);\r\nldata->ld_leh->leh_reccount--;\r\nldata->ld_leh->leh_len -= ldata->ld_reclen;\r\nmemmove(ldata->ld_lee, (char *)ldata->ld_lee + ldata->ld_reclen,\r\n(char *)ldata->ld_leh + ldata->ld_leh->leh_len -\r\n(char *)ldata->ld_lee);\r\nCDEBUG(D_INODE, "Old link_ea name '%.*s' is removed\n",\r\nlname->ln_namelen, lname->ln_name);\r\n}\r\nint linkea_links_find(struct linkea_data *ldata, const struct lu_name *lname,\r\nconst struct lu_fid *pfid)\r\n{\r\nstruct lu_name tmpname;\r\nstruct lu_fid tmpfid;\r\nint count;\r\nLASSERT(ldata->ld_leh != NULL);\r\nldata->ld_lee = (struct link_ea_entry *)(ldata->ld_leh + 1);\r\nfor (count = 0; count < ldata->ld_leh->leh_reccount; count++) {\r\nlinkea_entry_unpack(ldata->ld_lee, &ldata->ld_reclen,\r\n&tmpname, &tmpfid);\r\nif (tmpname.ln_namelen == lname->ln_namelen &&\r\nlu_fid_eq(&tmpfid, pfid) &&\r\n(strncmp(tmpname.ln_name, lname->ln_name,\r\ntmpname.ln_namelen) == 0))\r\nbreak;\r\nldata->ld_lee = (struct link_ea_entry *)((char *)ldata->ld_lee +\r\nldata->ld_reclen);\r\n}\r\nif (count == ldata->ld_leh->leh_reccount) {\r\nCDEBUG(D_INODE, "Old link_ea name '%.*s' not found\n",\r\nlname->ln_namelen, lname->ln_name);\r\nldata->ld_lee = NULL;\r\nreturn -ENOENT;\r\n}\r\nreturn 0;\r\n}

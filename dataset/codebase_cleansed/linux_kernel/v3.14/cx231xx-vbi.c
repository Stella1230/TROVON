static inline void print_err_status(struct cx231xx *dev, int packet, int status)\r\n{\r\nchar *errmsg = "Unknown";\r\nswitch (status) {\r\ncase -ENOENT:\r\nerrmsg = "unlinked synchronuously";\r\nbreak;\r\ncase -ECONNRESET:\r\nerrmsg = "unlinked asynchronuously";\r\nbreak;\r\ncase -ENOSR:\r\nerrmsg = "Buffer error (overrun)";\r\nbreak;\r\ncase -EPIPE:\r\nerrmsg = "Stalled (device not responding)";\r\nbreak;\r\ncase -EOVERFLOW:\r\nerrmsg = "Babble (bad cable?)";\r\nbreak;\r\ncase -EPROTO:\r\nerrmsg = "Bit-stuff error (bad cable?)";\r\nbreak;\r\ncase -EILSEQ:\r\nerrmsg = "CRC/Timeout (could be anything)";\r\nbreak;\r\ncase -ETIME:\r\nerrmsg = "Device does not respond";\r\nbreak;\r\n}\r\nif (packet < 0) {\r\ncx231xx_err("URB status %d [%s].\n", status,\r\nerrmsg);\r\n} else {\r\ncx231xx_err("URB packet %d, status %d [%s].\n",\r\npacket, status, errmsg);\r\n}\r\n}\r\nstatic inline int cx231xx_isoc_vbi_copy(struct cx231xx *dev, struct urb *urb)\r\n{\r\nstruct cx231xx_dmaqueue *dma_q = urb->context;\r\nint rc = 1;\r\nunsigned char *p_buffer;\r\nu32 bytes_parsed = 0, buffer_size = 0;\r\nu8 sav_eav = 0;\r\nif (!dev)\r\nreturn 0;\r\nif (dev->state & DEV_DISCONNECTED)\r\nreturn 0;\r\nif (urb->status < 0) {\r\nprint_err_status(dev, -1, urb->status);\r\nif (urb->status == -ENOENT)\r\nreturn 0;\r\n}\r\np_buffer = urb->transfer_buffer;\r\nbuffer_size = urb->actual_length;\r\nif (buffer_size > 0) {\r\nbytes_parsed = 0;\r\nif (dma_q->is_partial_line) {\r\nsav_eav = dma_q->last_sav;\r\n} else {\r\nsav_eav = cx231xx_find_boundary_SAV_EAV(p_buffer,\r\ndma_q->partial_buf,\r\n&bytes_parsed);\r\n}\r\nsav_eav &= 0xF0;\r\nif (sav_eav) {\r\nbytes_parsed += cx231xx_get_vbi_line(dev, dma_q,\r\nsav_eav,\r\np_buffer + bytes_parsed,\r\nbuffer_size - bytes_parsed);\r\n}\r\ndma_q->is_partial_line = 0;\r\nwhile (bytes_parsed < buffer_size) {\r\nu32 bytes_used = 0;\r\nsav_eav = cx231xx_find_next_SAV_EAV(\r\np_buffer + bytes_parsed,\r\nbuffer_size - bytes_parsed,\r\n&bytes_used);\r\nbytes_parsed += bytes_used;\r\nsav_eav &= 0xF0;\r\nif (sav_eav && (bytes_parsed < buffer_size)) {\r\nbytes_parsed += cx231xx_get_vbi_line(dev,\r\ndma_q, sav_eav,\r\np_buffer+bytes_parsed,\r\nbuffer_size-bytes_parsed);\r\n}\r\n}\r\nmemcpy(dma_q->partial_buf, p_buffer + buffer_size - 4, 4);\r\nbytes_parsed = 0;\r\n}\r\nreturn rc;\r\n}\r\nstatic int\r\nvbi_buffer_setup(struct videobuf_queue *vq, unsigned int *count,\r\nunsigned int *size)\r\n{\r\nstruct cx231xx_fh *fh = vq->priv_data;\r\nstruct cx231xx *dev = fh->dev;\r\nu32 height = 0;\r\nheight = ((dev->norm & V4L2_STD_625_50) ?\r\nPAL_VBI_LINES : NTSC_VBI_LINES);\r\n*size = (dev->width * height * 2 * 2);\r\nif (0 == *count)\r\n*count = CX231XX_DEF_VBI_BUF;\r\nif (*count < CX231XX_MIN_BUF)\r\n*count = CX231XX_MIN_BUF;\r\nreturn 0;\r\n}\r\nstatic void free_buffer(struct videobuf_queue *vq, struct cx231xx_buffer *buf)\r\n{\r\nstruct cx231xx_fh *fh = vq->priv_data;\r\nstruct cx231xx *dev = fh->dev;\r\nunsigned long flags = 0;\r\nif (in_interrupt())\r\nBUG();\r\nspin_lock_irqsave(&dev->vbi_mode.slock, flags);\r\nif (dev->vbi_mode.bulk_ctl.buf == buf)\r\ndev->vbi_mode.bulk_ctl.buf = NULL;\r\nspin_unlock_irqrestore(&dev->vbi_mode.slock, flags);\r\nvideobuf_vmalloc_free(&buf->vb);\r\nbuf->vb.state = VIDEOBUF_NEEDS_INIT;\r\n}\r\nstatic int\r\nvbi_buffer_prepare(struct videobuf_queue *vq, struct videobuf_buffer *vb,\r\nenum v4l2_field field)\r\n{\r\nstruct cx231xx_fh *fh = vq->priv_data;\r\nstruct cx231xx_buffer *buf =\r\ncontainer_of(vb, struct cx231xx_buffer, vb);\r\nstruct cx231xx *dev = fh->dev;\r\nint rc = 0, urb_init = 0;\r\nu32 height = 0;\r\nheight = ((dev->norm & V4L2_STD_625_50) ?\r\nPAL_VBI_LINES : NTSC_VBI_LINES);\r\nbuf->vb.size = ((dev->width << 1) * height * 2);\r\nif (0 != buf->vb.baddr && buf->vb.bsize < buf->vb.size)\r\nreturn -EINVAL;\r\nbuf->vb.width = dev->width;\r\nbuf->vb.height = height;\r\nbuf->vb.field = field;\r\nbuf->vb.field = V4L2_FIELD_SEQ_TB;\r\nif (VIDEOBUF_NEEDS_INIT == buf->vb.state) {\r\nrc = videobuf_iolock(vq, &buf->vb, NULL);\r\nif (rc < 0)\r\ngoto fail;\r\n}\r\nif (!dev->vbi_mode.bulk_ctl.num_bufs)\r\nurb_init = 1;\r\nif (urb_init) {\r\nrc = cx231xx_init_vbi_isoc(dev, CX231XX_NUM_VBI_PACKETS,\r\nCX231XX_NUM_VBI_BUFS,\r\ndev->vbi_mode.alt_max_pkt_size[0],\r\ncx231xx_isoc_vbi_copy);\r\nif (rc < 0)\r\ngoto fail;\r\n}\r\nbuf->vb.state = VIDEOBUF_PREPARED;\r\nreturn 0;\r\nfail:\r\nfree_buffer(vq, buf);\r\nreturn rc;\r\n}\r\nstatic void\r\nvbi_buffer_queue(struct videobuf_queue *vq, struct videobuf_buffer *vb)\r\n{\r\nstruct cx231xx_buffer *buf =\r\ncontainer_of(vb, struct cx231xx_buffer, vb);\r\nstruct cx231xx_fh *fh = vq->priv_data;\r\nstruct cx231xx *dev = fh->dev;\r\nstruct cx231xx_dmaqueue *vidq = &dev->vbi_mode.vidq;\r\nbuf->vb.state = VIDEOBUF_QUEUED;\r\nlist_add_tail(&buf->vb.queue, &vidq->active);\r\n}\r\nstatic void vbi_buffer_release(struct videobuf_queue *vq,\r\nstruct videobuf_buffer *vb)\r\n{\r\nstruct cx231xx_buffer *buf =\r\ncontainer_of(vb, struct cx231xx_buffer, vb);\r\nfree_buffer(vq, buf);\r\n}\r\nstatic void cx231xx_irq_vbi_callback(struct urb *urb)\r\n{\r\nstruct cx231xx_dmaqueue *dma_q = urb->context;\r\nstruct cx231xx_video_mode *vmode =\r\ncontainer_of(dma_q, struct cx231xx_video_mode, vidq);\r\nstruct cx231xx *dev = container_of(vmode, struct cx231xx, vbi_mode);\r\nswitch (urb->status) {\r\ncase 0:\r\ncase -ETIMEDOUT:\r\nbreak;\r\ncase -ECONNRESET:\r\ncase -ENOENT:\r\ncase -ESHUTDOWN:\r\nreturn;\r\ndefault:\r\ncx231xx_err("urb completition error %d.\n",\r\nurb->status);\r\nbreak;\r\n}\r\nspin_lock(&dev->vbi_mode.slock);\r\ndev->vbi_mode.bulk_ctl.bulk_copy(dev, urb);\r\nspin_unlock(&dev->vbi_mode.slock);\r\nurb->status = 0;\r\nurb->status = usb_submit_urb(urb, GFP_ATOMIC);\r\nif (urb->status) {\r\ncx231xx_err("urb resubmit failed (error=%i)\n",\r\nurb->status);\r\n}\r\n}\r\nvoid cx231xx_uninit_vbi_isoc(struct cx231xx *dev)\r\n{\r\nstruct urb *urb;\r\nint i;\r\ncx231xx_info("called cx231xx_uninit_vbi_isoc\n");\r\ndev->vbi_mode.bulk_ctl.nfields = -1;\r\nfor (i = 0; i < dev->vbi_mode.bulk_ctl.num_bufs; i++) {\r\nurb = dev->vbi_mode.bulk_ctl.urb[i];\r\nif (urb) {\r\nif (!irqs_disabled())\r\nusb_kill_urb(urb);\r\nelse\r\nusb_unlink_urb(urb);\r\nif (dev->vbi_mode.bulk_ctl.transfer_buffer[i]) {\r\nkfree(dev->vbi_mode.bulk_ctl.\r\ntransfer_buffer[i]);\r\ndev->vbi_mode.bulk_ctl.transfer_buffer[i] =\r\nNULL;\r\n}\r\nusb_free_urb(urb);\r\ndev->vbi_mode.bulk_ctl.urb[i] = NULL;\r\n}\r\ndev->vbi_mode.bulk_ctl.transfer_buffer[i] = NULL;\r\n}\r\nkfree(dev->vbi_mode.bulk_ctl.urb);\r\nkfree(dev->vbi_mode.bulk_ctl.transfer_buffer);\r\ndev->vbi_mode.bulk_ctl.urb = NULL;\r\ndev->vbi_mode.bulk_ctl.transfer_buffer = NULL;\r\ndev->vbi_mode.bulk_ctl.num_bufs = 0;\r\ncx231xx_capture_start(dev, 0, Vbi);\r\n}\r\nint cx231xx_init_vbi_isoc(struct cx231xx *dev, int max_packets,\r\nint num_bufs, int max_pkt_size,\r\nint (*bulk_copy) (struct cx231xx *dev,\r\nstruct urb *urb))\r\n{\r\nstruct cx231xx_dmaqueue *dma_q = &dev->vbi_mode.vidq;\r\nint i;\r\nint sb_size, pipe;\r\nstruct urb *urb;\r\nint rc;\r\ncx231xx_info("called cx231xx_vbi_isoc\n");\r\ncx231xx_uninit_vbi_isoc(dev);\r\nusb_clear_halt(dev->udev,\r\nusb_rcvbulkpipe(dev->udev,\r\ndev->vbi_mode.end_point_addr));\r\ndev->vbi_mode.bulk_ctl.bulk_copy = bulk_copy;\r\ndev->vbi_mode.bulk_ctl.num_bufs = num_bufs;\r\ndma_q->pos = 0;\r\ndma_q->is_partial_line = 0;\r\ndma_q->last_sav = 0;\r\ndma_q->current_field = -1;\r\ndma_q->bytes_left_in_line = dev->width << 1;\r\ndma_q->lines_per_field = ((dev->norm & V4L2_STD_625_50) ?\r\nPAL_VBI_LINES : NTSC_VBI_LINES);\r\ndma_q->lines_completed = 0;\r\nfor (i = 0; i < 8; i++)\r\ndma_q->partial_buf[i] = 0;\r\ndev->vbi_mode.bulk_ctl.urb = kzalloc(sizeof(void *) * num_bufs,\r\nGFP_KERNEL);\r\nif (!dev->vbi_mode.bulk_ctl.urb) {\r\ncx231xx_errdev("cannot alloc memory for usb buffers\n");\r\nreturn -ENOMEM;\r\n}\r\ndev->vbi_mode.bulk_ctl.transfer_buffer =\r\nkzalloc(sizeof(void *) * num_bufs, GFP_KERNEL);\r\nif (!dev->vbi_mode.bulk_ctl.transfer_buffer) {\r\ncx231xx_errdev("cannot allocate memory for usbtransfer\n");\r\nkfree(dev->vbi_mode.bulk_ctl.urb);\r\nreturn -ENOMEM;\r\n}\r\ndev->vbi_mode.bulk_ctl.max_pkt_size = max_pkt_size;\r\ndev->vbi_mode.bulk_ctl.buf = NULL;\r\nsb_size = max_packets * dev->vbi_mode.bulk_ctl.max_pkt_size;\r\nfor (i = 0; i < dev->vbi_mode.bulk_ctl.num_bufs; i++) {\r\nurb = usb_alloc_urb(0, GFP_KERNEL);\r\nif (!urb) {\r\ncx231xx_err("cannot alloc bulk_ctl.urb %i\n", i);\r\ncx231xx_uninit_vbi_isoc(dev);\r\nreturn -ENOMEM;\r\n}\r\ndev->vbi_mode.bulk_ctl.urb[i] = urb;\r\nurb->transfer_flags = 0;\r\ndev->vbi_mode.bulk_ctl.transfer_buffer[i] =\r\nkzalloc(sb_size, GFP_KERNEL);\r\nif (!dev->vbi_mode.bulk_ctl.transfer_buffer[i]) {\r\ncx231xx_err("unable to allocate %i bytes for transfer"\r\n" buffer %i%s\n", sb_size, i,\r\nin_interrupt() ? " while in int" : "");\r\ncx231xx_uninit_vbi_isoc(dev);\r\nreturn -ENOMEM;\r\n}\r\npipe = usb_rcvbulkpipe(dev->udev, dev->vbi_mode.end_point_addr);\r\nusb_fill_bulk_urb(urb, dev->udev, pipe,\r\ndev->vbi_mode.bulk_ctl.transfer_buffer[i],\r\nsb_size, cx231xx_irq_vbi_callback, dma_q);\r\n}\r\ninit_waitqueue_head(&dma_q->wq);\r\nfor (i = 0; i < dev->vbi_mode.bulk_ctl.num_bufs; i++) {\r\nrc = usb_submit_urb(dev->vbi_mode.bulk_ctl.urb[i], GFP_ATOMIC);\r\nif (rc) {\r\ncx231xx_err("submit of urb %i failed (error=%i)\n", i,\r\nrc);\r\ncx231xx_uninit_vbi_isoc(dev);\r\nreturn rc;\r\n}\r\n}\r\ncx231xx_capture_start(dev, 1, Vbi);\r\nreturn 0;\r\n}\r\nu32 cx231xx_get_vbi_line(struct cx231xx *dev, struct cx231xx_dmaqueue *dma_q,\r\nu8 sav_eav, u8 *p_buffer, u32 buffer_size)\r\n{\r\nu32 bytes_copied = 0;\r\nint current_field = -1;\r\nswitch (sav_eav) {\r\ncase SAV_VBI_FIELD1:\r\ncurrent_field = 1;\r\nbreak;\r\ncase SAV_VBI_FIELD2:\r\ncurrent_field = 2;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (current_field < 0)\r\nreturn bytes_copied;\r\ndma_q->last_sav = sav_eav;\r\nbytes_copied =\r\ncx231xx_copy_vbi_line(dev, dma_q, p_buffer, buffer_size,\r\ncurrent_field);\r\nreturn bytes_copied;\r\n}\r\nstatic inline void vbi_buffer_filled(struct cx231xx *dev,\r\nstruct cx231xx_dmaqueue *dma_q,\r\nstruct cx231xx_buffer *buf)\r\n{\r\nbuf->vb.state = VIDEOBUF_DONE;\r\nbuf->vb.field_count++;\r\nv4l2_get_timestamp(&buf->vb.ts);\r\ndev->vbi_mode.bulk_ctl.buf = NULL;\r\nlist_del(&buf->vb.queue);\r\nwake_up(&buf->vb.done);\r\n}\r\nu32 cx231xx_copy_vbi_line(struct cx231xx *dev, struct cx231xx_dmaqueue *dma_q,\r\nu8 *p_line, u32 length, int field_number)\r\n{\r\nu32 bytes_to_copy;\r\nstruct cx231xx_buffer *buf;\r\nu32 _line_size = dev->width * 2;\r\nif (dma_q->current_field == -1) {\r\ncx231xx_reset_vbi_buffer(dev, dma_q);\r\n}\r\nif (dma_q->current_field != field_number)\r\ndma_q->lines_completed = 0;\r\nbuf = dev->vbi_mode.bulk_ctl.buf;\r\ndma_q->current_field = field_number;\r\nbytes_to_copy = dma_q->bytes_left_in_line;\r\nif (bytes_to_copy > length)\r\nbytes_to_copy = length;\r\nif (dma_q->lines_completed >= dma_q->lines_per_field) {\r\ndma_q->bytes_left_in_line -= bytes_to_copy;\r\ndma_q->is_partial_line =\r\n(dma_q->bytes_left_in_line == 0) ? 0 : 1;\r\nreturn 0;\r\n}\r\ndma_q->is_partial_line = 1;\r\nif (!buf) {\r\ndma_q->bytes_left_in_line -= bytes_to_copy;\r\ndma_q->is_partial_line =\r\n(dma_q->bytes_left_in_line == 0) ? 0 : 1;\r\nreturn bytes_to_copy;\r\n}\r\ncx231xx_do_vbi_copy(dev, dma_q, p_line, bytes_to_copy);\r\ndma_q->pos += bytes_to_copy;\r\ndma_q->bytes_left_in_line -= bytes_to_copy;\r\nif (dma_q->bytes_left_in_line == 0) {\r\ndma_q->bytes_left_in_line = _line_size;\r\ndma_q->lines_completed++;\r\ndma_q->is_partial_line = 0;\r\nif (cx231xx_is_vbi_buffer_done(dev, dma_q) && buf) {\r\nvbi_buffer_filled(dev, dma_q, buf);\r\ndma_q->pos = 0;\r\ndma_q->lines_completed = 0;\r\ncx231xx_reset_vbi_buffer(dev, dma_q);\r\n}\r\n}\r\nreturn bytes_to_copy;\r\n}\r\nstatic inline void get_next_vbi_buf(struct cx231xx_dmaqueue *dma_q,\r\nstruct cx231xx_buffer **buf)\r\n{\r\nstruct cx231xx_video_mode *vmode =\r\ncontainer_of(dma_q, struct cx231xx_video_mode, vidq);\r\nstruct cx231xx *dev = container_of(vmode, struct cx231xx, vbi_mode);\r\nchar *outp;\r\nif (list_empty(&dma_q->active)) {\r\ncx231xx_err("No active queue to serve\n");\r\ndev->vbi_mode.bulk_ctl.buf = NULL;\r\n*buf = NULL;\r\nreturn;\r\n}\r\n*buf = list_entry(dma_q->active.next, struct cx231xx_buffer, vb.queue);\r\noutp = videobuf_to_vmalloc(&(*buf)->vb);\r\nmemset(outp, 0, (*buf)->vb.size);\r\ndev->vbi_mode.bulk_ctl.buf = *buf;\r\nreturn;\r\n}\r\nvoid cx231xx_reset_vbi_buffer(struct cx231xx *dev,\r\nstruct cx231xx_dmaqueue *dma_q)\r\n{\r\nstruct cx231xx_buffer *buf;\r\nbuf = dev->vbi_mode.bulk_ctl.buf;\r\nif (buf == NULL) {\r\nget_next_vbi_buf(dma_q, &buf);\r\ndma_q->pos = 0;\r\ndma_q->current_field = -1;\r\n}\r\ndma_q->bytes_left_in_line = dev->width << 1;\r\ndma_q->lines_completed = 0;\r\n}\r\nint cx231xx_do_vbi_copy(struct cx231xx *dev, struct cx231xx_dmaqueue *dma_q,\r\nu8 *p_buffer, u32 bytes_to_copy)\r\n{\r\nu8 *p_out_buffer = NULL;\r\nu32 current_line_bytes_copied = 0;\r\nstruct cx231xx_buffer *buf;\r\nu32 _line_size = dev->width << 1;\r\nvoid *startwrite;\r\nint offset, lencopy;\r\nbuf = dev->vbi_mode.bulk_ctl.buf;\r\nif (buf == NULL)\r\nreturn -EINVAL;\r\np_out_buffer = videobuf_to_vmalloc(&buf->vb);\r\nif (dma_q->bytes_left_in_line != _line_size) {\r\ncurrent_line_bytes_copied =\r\n_line_size - dma_q->bytes_left_in_line;\r\n}\r\noffset = (dma_q->lines_completed * _line_size) +\r\ncurrent_line_bytes_copied;\r\nif (dma_q->current_field == 2) {\r\noffset += (dev->width * 2 * dma_q->lines_per_field);\r\n}\r\nstartwrite = p_out_buffer + offset;\r\nlencopy = dma_q->bytes_left_in_line > bytes_to_copy ?\r\nbytes_to_copy : dma_q->bytes_left_in_line;\r\nmemcpy(startwrite, p_buffer, lencopy);\r\nreturn 0;\r\n}\r\nu8 cx231xx_is_vbi_buffer_done(struct cx231xx *dev,\r\nstruct cx231xx_dmaqueue *dma_q)\r\n{\r\nu32 height = 0;\r\nheight = ((dev->norm & V4L2_STD_625_50) ?\r\nPAL_VBI_LINES : NTSC_VBI_LINES);\r\nif (dma_q->lines_completed == height && dma_q->current_field == 2)\r\nreturn 1;\r\nelse\r\nreturn 0;\r\n}

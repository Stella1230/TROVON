static void rx51_ext_control(struct snd_soc_dapm_context *dapm)\r\n{\r\nint hp = 0, hs = 0, tvout = 0;\r\nswitch (rx51_jack_func) {\r\ncase RX51_JACK_TVOUT:\r\ntvout = 1;\r\nhp = 1;\r\nbreak;\r\ncase RX51_JACK_HS:\r\nhs = 1;\r\ncase RX51_JACK_HP:\r\nhp = 1;\r\nbreak;\r\n}\r\nif (rx51_spk_func)\r\nsnd_soc_dapm_enable_pin(dapm, "Ext Spk");\r\nelse\r\nsnd_soc_dapm_disable_pin(dapm, "Ext Spk");\r\nif (rx51_dmic_func)\r\nsnd_soc_dapm_enable_pin(dapm, "DMic");\r\nelse\r\nsnd_soc_dapm_disable_pin(dapm, "DMic");\r\nif (hp)\r\nsnd_soc_dapm_enable_pin(dapm, "Headphone Jack");\r\nelse\r\nsnd_soc_dapm_disable_pin(dapm, "Headphone Jack");\r\nif (hs)\r\nsnd_soc_dapm_enable_pin(dapm, "HS Mic");\r\nelse\r\nsnd_soc_dapm_disable_pin(dapm, "HS Mic");\r\ngpio_set_value(RX51_TVOUT_SEL_GPIO, tvout);\r\nsnd_soc_dapm_sync(dapm);\r\n}\r\nstatic int rx51_startup(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_card *card = rtd->card;\r\nsnd_pcm_hw_constraint_minmax(runtime,\r\nSNDRV_PCM_HW_PARAM_CHANNELS, 2, 2);\r\nrx51_ext_control(&card->dapm);\r\nreturn 0;\r\n}\r\nstatic int rx51_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nreturn snd_soc_dai_set_sysclk(codec_dai, 0, 19200000,\r\nSND_SOC_CLOCK_IN);\r\n}\r\nstatic int rx51_get_spk(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nucontrol->value.integer.value[0] = rx51_spk_func;\r\nreturn 0;\r\n}\r\nstatic int rx51_set_spk(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_card *card = snd_kcontrol_chip(kcontrol);\r\nif (rx51_spk_func == ucontrol->value.integer.value[0])\r\nreturn 0;\r\nrx51_spk_func = ucontrol->value.integer.value[0];\r\nrx51_ext_control(&card->dapm);\r\nreturn 1;\r\n}\r\nstatic int rx51_spk_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *k, int event)\r\n{\r\nif (SND_SOC_DAPM_EVENT_ON(event))\r\ngpio_set_value_cansleep(RX51_SPEAKER_AMP_TWL_GPIO, 1);\r\nelse\r\ngpio_set_value_cansleep(RX51_SPEAKER_AMP_TWL_GPIO, 0);\r\nreturn 0;\r\n}\r\nstatic int rx51_hp_event(struct snd_soc_dapm_widget *w,\r\nstruct snd_kcontrol *k, int event)\r\n{\r\nstruct snd_soc_codec *codec = w->dapm->codec;\r\nif (SND_SOC_DAPM_EVENT_ON(event))\r\ntpa6130a2_stereo_enable(codec, 1);\r\nelse\r\ntpa6130a2_stereo_enable(codec, 0);\r\nreturn 0;\r\n}\r\nstatic int rx51_get_input(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nucontrol->value.integer.value[0] = rx51_dmic_func;\r\nreturn 0;\r\n}\r\nstatic int rx51_set_input(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_card *card = snd_kcontrol_chip(kcontrol);\r\nif (rx51_dmic_func == ucontrol->value.integer.value[0])\r\nreturn 0;\r\nrx51_dmic_func = ucontrol->value.integer.value[0];\r\nrx51_ext_control(&card->dapm);\r\nreturn 1;\r\n}\r\nstatic int rx51_get_jack(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nucontrol->value.integer.value[0] = rx51_jack_func;\r\nreturn 0;\r\n}\r\nstatic int rx51_set_jack(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_card *card = snd_kcontrol_chip(kcontrol);\r\nif (rx51_jack_func == ucontrol->value.integer.value[0])\r\nreturn 0;\r\nrx51_jack_func = ucontrol->value.integer.value[0];\r\nrx51_ext_control(&card->dapm);\r\nreturn 1;\r\n}\r\nstatic int rx51_aic34_init(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct snd_soc_codec *codec = rtd->codec;\r\nstruct snd_soc_dapm_context *dapm = &codec->dapm;\r\nint err;\r\nsnd_soc_dapm_nc_pin(dapm, "MIC3L");\r\nsnd_soc_dapm_nc_pin(dapm, "MIC3R");\r\nsnd_soc_dapm_nc_pin(dapm, "LINE1R");\r\nerr = snd_soc_add_card_controls(rtd->card, aic34_rx51_controls,\r\nARRAY_SIZE(aic34_rx51_controls));\r\nif (err < 0)\r\nreturn err;\r\nsnd_soc_dapm_new_controls(dapm, aic34_dapm_widgets,\r\nARRAY_SIZE(aic34_dapm_widgets));\r\nsnd_soc_dapm_add_routes(dapm, audio_map, ARRAY_SIZE(audio_map));\r\nerr = tpa6130a2_add_controls(codec);\r\nif (err < 0)\r\nreturn err;\r\nsnd_soc_limit_volume(codec, "TPA6130A2 Headphone Playback Volume", 42);\r\nerr = omap_mcbsp_st_add_controls(rtd);\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_soc_jack_new(codec, "AV Jack",\r\nSND_JACK_HEADSET | SND_JACK_VIDEOOUT,\r\n&rx51_av_jack);\r\nif (err)\r\nreturn err;\r\nerr = snd_soc_jack_add_gpios(&rx51_av_jack,\r\nARRAY_SIZE(rx51_av_jack_gpios),\r\nrx51_av_jack_gpios);\r\nreturn err;\r\n}\r\nstatic int rx51_aic34b_init(struct snd_soc_dapm_context *dapm)\r\n{\r\nint err;\r\nerr = snd_soc_add_card_controls(dapm->card, aic34_rx51_controlsb,\r\nARRAY_SIZE(aic34_rx51_controlsb));\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_soc_dapm_new_controls(dapm, aic34_dapm_widgetsb,\r\nARRAY_SIZE(aic34_dapm_widgetsb));\r\nif (err < 0)\r\nreturn 0;\r\nreturn snd_soc_dapm_add_routes(dapm, audio_mapb,\r\nARRAY_SIZE(audio_mapb));\r\n}\r\nstatic int __init rx51_soc_init(void)\r\n{\r\nint err;\r\nif (!machine_is_nokia_rx51() && !of_machine_is_compatible("nokia,omap3-n900"))\r\nreturn -ENODEV;\r\nerr = gpio_request_one(RX51_TVOUT_SEL_GPIO,\r\nGPIOF_DIR_OUT | GPIOF_INIT_LOW, "tvout_sel");\r\nif (err)\r\ngoto err_gpio_tvout_sel;\r\nerr = gpio_request_one(RX51_ECI_SW_GPIO,\r\nGPIOF_DIR_OUT | GPIOF_INIT_HIGH, "eci_sw");\r\nif (err)\r\ngoto err_gpio_eci_sw;\r\nrx51_snd_device = platform_device_alloc("soc-audio", -1);\r\nif (!rx51_snd_device) {\r\nerr = -ENOMEM;\r\ngoto err1;\r\n}\r\nplatform_set_drvdata(rx51_snd_device, &rx51_sound_card);\r\nerr = platform_device_add(rx51_snd_device);\r\nif (err)\r\ngoto err2;\r\nreturn 0;\r\nerr2:\r\nplatform_device_put(rx51_snd_device);\r\nerr1:\r\ngpio_free(RX51_ECI_SW_GPIO);\r\nerr_gpio_eci_sw:\r\ngpio_free(RX51_TVOUT_SEL_GPIO);\r\nerr_gpio_tvout_sel:\r\nreturn err;\r\n}\r\nstatic void __exit rx51_soc_exit(void)\r\n{\r\nsnd_soc_jack_free_gpios(&rx51_av_jack, ARRAY_SIZE(rx51_av_jack_gpios),\r\nrx51_av_jack_gpios);\r\nplatform_device_unregister(rx51_snd_device);\r\ngpio_free(RX51_ECI_SW_GPIO);\r\ngpio_free(RX51_TVOUT_SEL_GPIO);\r\n}

STATIC bool\r\nxfs_dir3_leaf1_check(\r\nstruct xfs_inode *dp,\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_dir2_leaf *leaf = bp->b_addr;\r\nstruct xfs_dir3_icleaf_hdr leafhdr;\r\ndp->d_ops->leaf_hdr_from_disk(&leafhdr, leaf);\r\nif (leafhdr.magic == XFS_DIR3_LEAF1_MAGIC) {\r\nstruct xfs_dir3_leaf_hdr *leaf3 = bp->b_addr;\r\nif (be64_to_cpu(leaf3->info.blkno) != bp->b_bn)\r\nreturn false;\r\n} else if (leafhdr.magic != XFS_DIR2_LEAF1_MAGIC)\r\nreturn false;\r\nreturn xfs_dir3_leaf_check_int(dp->i_mount, dp, &leafhdr, leaf);\r\n}\r\nbool\r\nxfs_dir3_leaf_check_int(\r\nstruct xfs_mount *mp,\r\nstruct xfs_inode *dp,\r\nstruct xfs_dir3_icleaf_hdr *hdr,\r\nstruct xfs_dir2_leaf *leaf)\r\n{\r\nstruct xfs_dir2_leaf_entry *ents;\r\nxfs_dir2_leaf_tail_t *ltp;\r\nint stale;\r\nint i;\r\nconst struct xfs_dir_ops *ops;\r\nstruct xfs_dir3_icleaf_hdr leafhdr;\r\nops = xfs_dir_get_ops(mp, dp);\r\nif (!hdr) {\r\nops->leaf_hdr_from_disk(&leafhdr, leaf);\r\nhdr = &leafhdr;\r\n}\r\nents = ops->leaf_ents_p(leaf);\r\nltp = xfs_dir2_leaf_tail_p(mp, leaf);\r\nif (hdr->count > ops->leaf_max_ents(mp))\r\nreturn false;\r\nif ((hdr->magic == XFS_DIR2_LEAF1_MAGIC ||\r\nhdr->magic == XFS_DIR3_LEAF1_MAGIC) &&\r\n(char *)&ents[hdr->count] > (char *)xfs_dir2_leaf_bests_p(ltp))\r\nreturn false;\r\nfor (i = stale = 0; i < hdr->count; i++) {\r\nif (i + 1 < hdr->count) {\r\nif (be32_to_cpu(ents[i].hashval) >\r\nbe32_to_cpu(ents[i + 1].hashval))\r\nreturn false;\r\n}\r\nif (ents[i].address == cpu_to_be32(XFS_DIR2_NULL_DATAPTR))\r\nstale++;\r\n}\r\nif (hdr->stale != stale)\r\nreturn false;\r\nreturn true;\r\n}\r\nstatic bool\r\nxfs_dir3_leaf_verify(\r\nstruct xfs_buf *bp,\r\n__uint16_t magic)\r\n{\r\nstruct xfs_mount *mp = bp->b_target->bt_mount;\r\nstruct xfs_dir2_leaf *leaf = bp->b_addr;\r\nASSERT(magic == XFS_DIR2_LEAF1_MAGIC || magic == XFS_DIR2_LEAFN_MAGIC);\r\nif (xfs_sb_version_hascrc(&mp->m_sb)) {\r\nstruct xfs_dir3_leaf_hdr *leaf3 = bp->b_addr;\r\n__uint16_t magic3;\r\nmagic3 = (magic == XFS_DIR2_LEAF1_MAGIC) ? XFS_DIR3_LEAF1_MAGIC\r\n: XFS_DIR3_LEAFN_MAGIC;\r\nif (leaf3->info.hdr.magic != cpu_to_be16(magic3))\r\nreturn false;\r\nif (!uuid_equal(&leaf3->info.uuid, &mp->m_sb.sb_uuid))\r\nreturn false;\r\nif (be64_to_cpu(leaf3->info.blkno) != bp->b_bn)\r\nreturn false;\r\n} else {\r\nif (leaf->hdr.info.magic != cpu_to_be16(magic))\r\nreturn false;\r\n}\r\nreturn xfs_dir3_leaf_check_int(mp, NULL, NULL, leaf);\r\n}\r\nstatic void\r\n__read_verify(\r\nstruct xfs_buf *bp,\r\n__uint16_t magic)\r\n{\r\nstruct xfs_mount *mp = bp->b_target->bt_mount;\r\nif ((xfs_sb_version_hascrc(&mp->m_sb) &&\r\n!xfs_verify_cksum(bp->b_addr, BBTOB(bp->b_length),\r\nXFS_DIR3_LEAF_CRC_OFF)) ||\r\n!xfs_dir3_leaf_verify(bp, magic)) {\r\nXFS_CORRUPTION_ERROR(__func__, XFS_ERRLEVEL_LOW, mp, bp->b_addr);\r\nxfs_buf_ioerror(bp, EFSCORRUPTED);\r\n}\r\n}\r\nstatic void\r\n__write_verify(\r\nstruct xfs_buf *bp,\r\n__uint16_t magic)\r\n{\r\nstruct xfs_mount *mp = bp->b_target->bt_mount;\r\nstruct xfs_buf_log_item *bip = bp->b_fspriv;\r\nstruct xfs_dir3_leaf_hdr *hdr3 = bp->b_addr;\r\nif (!xfs_dir3_leaf_verify(bp, magic)) {\r\nXFS_CORRUPTION_ERROR(__func__, XFS_ERRLEVEL_LOW, mp, bp->b_addr);\r\nxfs_buf_ioerror(bp, EFSCORRUPTED);\r\nreturn;\r\n}\r\nif (!xfs_sb_version_hascrc(&mp->m_sb))\r\nreturn;\r\nif (bip)\r\nhdr3->info.lsn = cpu_to_be64(bip->bli_item.li_lsn);\r\nxfs_update_cksum(bp->b_addr, BBTOB(bp->b_length), XFS_DIR3_LEAF_CRC_OFF);\r\n}\r\nstatic void\r\nxfs_dir3_leaf1_read_verify(\r\nstruct xfs_buf *bp)\r\n{\r\n__read_verify(bp, XFS_DIR2_LEAF1_MAGIC);\r\n}\r\nstatic void\r\nxfs_dir3_leaf1_write_verify(\r\nstruct xfs_buf *bp)\r\n{\r\n__write_verify(bp, XFS_DIR2_LEAF1_MAGIC);\r\n}\r\nstatic void\r\nxfs_dir3_leafn_read_verify(\r\nstruct xfs_buf *bp)\r\n{\r\n__read_verify(bp, XFS_DIR2_LEAFN_MAGIC);\r\n}\r\nstatic void\r\nxfs_dir3_leafn_write_verify(\r\nstruct xfs_buf *bp)\r\n{\r\n__write_verify(bp, XFS_DIR2_LEAFN_MAGIC);\r\n}\r\nstatic int\r\nxfs_dir3_leaf_read(\r\nstruct xfs_trans *tp,\r\nstruct xfs_inode *dp,\r\nxfs_dablk_t fbno,\r\nxfs_daddr_t mappedbno,\r\nstruct xfs_buf **bpp)\r\n{\r\nint err;\r\nerr = xfs_da_read_buf(tp, dp, fbno, mappedbno, bpp,\r\nXFS_DATA_FORK, &xfs_dir3_leaf1_buf_ops);\r\nif (!err && tp)\r\nxfs_trans_buf_set_type(tp, *bpp, XFS_BLFT_DIR_LEAF1_BUF);\r\nreturn err;\r\n}\r\nint\r\nxfs_dir3_leafn_read(\r\nstruct xfs_trans *tp,\r\nstruct xfs_inode *dp,\r\nxfs_dablk_t fbno,\r\nxfs_daddr_t mappedbno,\r\nstruct xfs_buf **bpp)\r\n{\r\nint err;\r\nerr = xfs_da_read_buf(tp, dp, fbno, mappedbno, bpp,\r\nXFS_DATA_FORK, &xfs_dir3_leafn_buf_ops);\r\nif (!err && tp)\r\nxfs_trans_buf_set_type(tp, *bpp, XFS_BLFT_DIR_LEAFN_BUF);\r\nreturn err;\r\n}\r\nstatic void\r\nxfs_dir3_leaf_init(\r\nstruct xfs_mount *mp,\r\nstruct xfs_trans *tp,\r\nstruct xfs_buf *bp,\r\nxfs_ino_t owner,\r\n__uint16_t type)\r\n{\r\nstruct xfs_dir2_leaf *leaf = bp->b_addr;\r\nASSERT(type == XFS_DIR2_LEAF1_MAGIC || type == XFS_DIR2_LEAFN_MAGIC);\r\nif (xfs_sb_version_hascrc(&mp->m_sb)) {\r\nstruct xfs_dir3_leaf_hdr *leaf3 = bp->b_addr;\r\nmemset(leaf3, 0, sizeof(*leaf3));\r\nleaf3->info.hdr.magic = (type == XFS_DIR2_LEAF1_MAGIC)\r\n? cpu_to_be16(XFS_DIR3_LEAF1_MAGIC)\r\n: cpu_to_be16(XFS_DIR3_LEAFN_MAGIC);\r\nleaf3->info.blkno = cpu_to_be64(bp->b_bn);\r\nleaf3->info.owner = cpu_to_be64(owner);\r\nuuid_copy(&leaf3->info.uuid, &mp->m_sb.sb_uuid);\r\n} else {\r\nmemset(leaf, 0, sizeof(*leaf));\r\nleaf->hdr.info.magic = cpu_to_be16(type);\r\n}\r\nif (type == XFS_DIR2_LEAF1_MAGIC) {\r\nstruct xfs_dir2_leaf_tail *ltp;\r\nltp = xfs_dir2_leaf_tail_p(mp, leaf);\r\nltp->bestcount = 0;\r\nbp->b_ops = &xfs_dir3_leaf1_buf_ops;\r\nxfs_trans_buf_set_type(tp, bp, XFS_BLFT_DIR_LEAF1_BUF);\r\n} else {\r\nbp->b_ops = &xfs_dir3_leafn_buf_ops;\r\nxfs_trans_buf_set_type(tp, bp, XFS_BLFT_DIR_LEAFN_BUF);\r\n}\r\n}\r\nint\r\nxfs_dir3_leaf_get_buf(\r\nxfs_da_args_t *args,\r\nxfs_dir2_db_t bno,\r\nstruct xfs_buf **bpp,\r\n__uint16_t magic)\r\n{\r\nstruct xfs_inode *dp = args->dp;\r\nstruct xfs_trans *tp = args->trans;\r\nstruct xfs_mount *mp = dp->i_mount;\r\nstruct xfs_buf *bp;\r\nint error;\r\nASSERT(magic == XFS_DIR2_LEAF1_MAGIC || magic == XFS_DIR2_LEAFN_MAGIC);\r\nASSERT(bno >= XFS_DIR2_LEAF_FIRSTDB(mp) &&\r\nbno < XFS_DIR2_FREE_FIRSTDB(mp));\r\nerror = xfs_da_get_buf(tp, dp, xfs_dir2_db_to_da(mp, bno), -1, &bp,\r\nXFS_DATA_FORK);\r\nif (error)\r\nreturn error;\r\nxfs_dir3_leaf_init(mp, tp, bp, dp->i_ino, magic);\r\nxfs_dir3_leaf_log_header(tp, dp, bp);\r\nif (magic == XFS_DIR2_LEAF1_MAGIC)\r\nxfs_dir3_leaf_log_tail(tp, bp);\r\n*bpp = bp;\r\nreturn 0;\r\n}\r\nint\r\nxfs_dir2_block_to_leaf(\r\nxfs_da_args_t *args,\r\nstruct xfs_buf *dbp)\r\n{\r\n__be16 *bestsp;\r\nxfs_dablk_t blkno;\r\nxfs_dir2_data_hdr_t *hdr;\r\nxfs_dir2_leaf_entry_t *blp;\r\nxfs_dir2_block_tail_t *btp;\r\nxfs_inode_t *dp;\r\nint error;\r\nstruct xfs_buf *lbp;\r\nxfs_dir2_db_t ldb;\r\nxfs_dir2_leaf_t *leaf;\r\nxfs_dir2_leaf_tail_t *ltp;\r\nxfs_mount_t *mp;\r\nint needlog;\r\nint needscan;\r\nxfs_trans_t *tp;\r\nstruct xfs_dir2_data_free *bf;\r\nstruct xfs_dir2_leaf_entry *ents;\r\nstruct xfs_dir3_icleaf_hdr leafhdr;\r\ntrace_xfs_dir2_block_to_leaf(args);\r\ndp = args->dp;\r\nmp = dp->i_mount;\r\ntp = args->trans;\r\nif ((error = xfs_da_grow_inode(args, &blkno))) {\r\nreturn error;\r\n}\r\nldb = xfs_dir2_da_to_db(mp, blkno);\r\nASSERT(ldb == XFS_DIR2_LEAF_FIRSTDB(mp));\r\nerror = xfs_dir3_leaf_get_buf(args, ldb, &lbp, XFS_DIR2_LEAF1_MAGIC);\r\nif (error)\r\nreturn error;\r\nleaf = lbp->b_addr;\r\nhdr = dbp->b_addr;\r\nxfs_dir3_data_check(dp, dbp);\r\nbtp = xfs_dir2_block_tail_p(mp, hdr);\r\nblp = xfs_dir2_block_leaf_p(btp);\r\nbf = dp->d_ops->data_bestfree_p(hdr);\r\nents = dp->d_ops->leaf_ents_p(leaf);\r\ndp->d_ops->leaf_hdr_from_disk(&leafhdr, leaf);\r\nleafhdr.count = be32_to_cpu(btp->count);\r\nleafhdr.stale = be32_to_cpu(btp->stale);\r\ndp->d_ops->leaf_hdr_to_disk(leaf, &leafhdr);\r\nxfs_dir3_leaf_log_header(tp, dp, lbp);\r\nmemcpy(ents, blp, be32_to_cpu(btp->count) * sizeof(xfs_dir2_leaf_entry_t));\r\nxfs_dir3_leaf_log_ents(tp, dp, lbp, 0, leafhdr.count - 1);\r\nneedscan = 0;\r\nneedlog = 1;\r\nxfs_dir2_data_make_free(tp, dp, dbp,\r\n(xfs_dir2_data_aoff_t)((char *)blp - (char *)hdr),\r\n(xfs_dir2_data_aoff_t)((char *)hdr + mp->m_dirblksize -\r\n(char *)blp),\r\n&needlog, &needscan);\r\ndbp->b_ops = &xfs_dir3_data_buf_ops;\r\nxfs_trans_buf_set_type(tp, dbp, XFS_BLFT_DIR_DATA_BUF);\r\nif (hdr->magic == cpu_to_be32(XFS_DIR2_BLOCK_MAGIC))\r\nhdr->magic = cpu_to_be32(XFS_DIR2_DATA_MAGIC);\r\nelse\r\nhdr->magic = cpu_to_be32(XFS_DIR3_DATA_MAGIC);\r\nif (needscan)\r\nxfs_dir2_data_freescan(dp, hdr, &needlog);\r\nltp = xfs_dir2_leaf_tail_p(mp, leaf);\r\nltp->bestcount = cpu_to_be32(1);\r\nbestsp = xfs_dir2_leaf_bests_p(ltp);\r\nbestsp[0] = bf[0].length;\r\nif (needlog)\r\nxfs_dir2_data_log_header(tp, dp, dbp);\r\nxfs_dir3_leaf_check(dp, lbp);\r\nxfs_dir3_data_check(dp, dbp);\r\nxfs_dir3_leaf_log_bests(tp, lbp, 0, 0);\r\nreturn 0;\r\n}\r\nSTATIC void\r\nxfs_dir3_leaf_find_stale(\r\nstruct xfs_dir3_icleaf_hdr *leafhdr,\r\nstruct xfs_dir2_leaf_entry *ents,\r\nint index,\r\nint *lowstale,\r\nint *highstale)\r\n{\r\nfor (*lowstale = index - 1; *lowstale >= 0; --*lowstale) {\r\nif (ents[*lowstale].address ==\r\ncpu_to_be32(XFS_DIR2_NULL_DATAPTR))\r\nbreak;\r\n}\r\nfor (*highstale = index; *highstale < leafhdr->count; ++*highstale) {\r\nif (ents[*highstale].address ==\r\ncpu_to_be32(XFS_DIR2_NULL_DATAPTR))\r\nbreak;\r\nif (*lowstale >= 0 && index - *lowstale <= *highstale - index)\r\nbreak;\r\n}\r\n}\r\nstruct xfs_dir2_leaf_entry *\r\nxfs_dir3_leaf_find_entry(\r\nstruct xfs_dir3_icleaf_hdr *leafhdr,\r\nstruct xfs_dir2_leaf_entry *ents,\r\nint index,\r\nint compact,\r\nint lowstale,\r\nint highstale,\r\nint *lfloglow,\r\nint *lfloghigh)\r\n{\r\nif (!leafhdr->stale) {\r\nxfs_dir2_leaf_entry_t *lep;\r\nlep = &ents[index];\r\nif (index < leafhdr->count)\r\nmemmove(lep + 1, lep,\r\n(leafhdr->count - index) * sizeof(*lep));\r\n*lfloglow = index;\r\n*lfloghigh = leafhdr->count++;\r\nreturn lep;\r\n}\r\nif (compact == 0)\r\nxfs_dir3_leaf_find_stale(leafhdr, ents, index,\r\n&lowstale, &highstale);\r\nif (lowstale >= 0 &&\r\n(highstale == leafhdr->count ||\r\nindex - lowstale - 1 < highstale - index)) {\r\nASSERT(index - lowstale - 1 >= 0);\r\nASSERT(ents[lowstale].address ==\r\ncpu_to_be32(XFS_DIR2_NULL_DATAPTR));\r\nif (index - lowstale - 1 > 0) {\r\nmemmove(&ents[lowstale], &ents[lowstale + 1],\r\n(index - lowstale - 1) *\r\nsizeof(xfs_dir2_leaf_entry_t));\r\n}\r\n*lfloglow = MIN(lowstale, *lfloglow);\r\n*lfloghigh = MAX(index - 1, *lfloghigh);\r\nleafhdr->stale--;\r\nreturn &ents[index - 1];\r\n}\r\nASSERT(highstale - index >= 0);\r\nASSERT(ents[highstale].address == cpu_to_be32(XFS_DIR2_NULL_DATAPTR));\r\nif (highstale - index > 0) {\r\nmemmove(&ents[index + 1], &ents[index],\r\n(highstale - index) * sizeof(xfs_dir2_leaf_entry_t));\r\n}\r\n*lfloglow = MIN(index, *lfloglow);\r\n*lfloghigh = MAX(highstale, *lfloghigh);\r\nleafhdr->stale--;\r\nreturn &ents[index];\r\n}\r\nint\r\nxfs_dir2_leaf_addname(\r\nxfs_da_args_t *args)\r\n{\r\n__be16 *bestsp;\r\nint compact;\r\nxfs_dir2_data_hdr_t *hdr;\r\nstruct xfs_buf *dbp;\r\nxfs_dir2_data_entry_t *dep;\r\nxfs_inode_t *dp;\r\nxfs_dir2_data_unused_t *dup;\r\nint error;\r\nint grown;\r\nint highstale;\r\nint i;\r\nint index;\r\nstruct xfs_buf *lbp;\r\nxfs_dir2_leaf_t *leaf;\r\nint length;\r\nxfs_dir2_leaf_entry_t *lep;\r\nint lfloglow;\r\nint lfloghigh;\r\nint lowstale;\r\nxfs_dir2_leaf_tail_t *ltp;\r\nxfs_mount_t *mp;\r\nint needbytes;\r\nint needlog;\r\nint needscan;\r\n__be16 *tagp;\r\nxfs_trans_t *tp;\r\nxfs_dir2_db_t use_block;\r\nstruct xfs_dir2_data_free *bf;\r\nstruct xfs_dir2_leaf_entry *ents;\r\nstruct xfs_dir3_icleaf_hdr leafhdr;\r\ntrace_xfs_dir2_leaf_addname(args);\r\ndp = args->dp;\r\ntp = args->trans;\r\nmp = dp->i_mount;\r\nerror = xfs_dir3_leaf_read(tp, dp, mp->m_dirleafblk, -1, &lbp);\r\nif (error)\r\nreturn error;\r\nindex = xfs_dir2_leaf_search_hash(args, lbp);\r\nleaf = lbp->b_addr;\r\nltp = xfs_dir2_leaf_tail_p(mp, leaf);\r\nents = dp->d_ops->leaf_ents_p(leaf);\r\ndp->d_ops->leaf_hdr_from_disk(&leafhdr, leaf);\r\nbestsp = xfs_dir2_leaf_bests_p(ltp);\r\nlength = dp->d_ops->data_entsize(args->namelen);\r\nfor (use_block = -1, lep = &ents[index];\r\nindex < leafhdr.count && be32_to_cpu(lep->hashval) == args->hashval;\r\nindex++, lep++) {\r\nif (be32_to_cpu(lep->address) == XFS_DIR2_NULL_DATAPTR)\r\ncontinue;\r\ni = xfs_dir2_dataptr_to_db(mp, be32_to_cpu(lep->address));\r\nASSERT(i < be32_to_cpu(ltp->bestcount));\r\nASSERT(bestsp[i] != cpu_to_be16(NULLDATAOFF));\r\nif (be16_to_cpu(bestsp[i]) >= length) {\r\nuse_block = i;\r\nbreak;\r\n}\r\n}\r\nif (use_block == -1) {\r\nfor (i = 0; i < be32_to_cpu(ltp->bestcount); i++) {\r\nif (bestsp[i] == cpu_to_be16(NULLDATAOFF) &&\r\nuse_block == -1)\r\nuse_block = i;\r\nelse if (be16_to_cpu(bestsp[i]) >= length) {\r\nuse_block = i;\r\nbreak;\r\n}\r\n}\r\n}\r\nneedbytes = 0;\r\nif (!leafhdr.stale)\r\nneedbytes += sizeof(xfs_dir2_leaf_entry_t);\r\nif (use_block == -1)\r\nneedbytes += sizeof(xfs_dir2_data_off_t);\r\nif (use_block != -1 && bestsp[use_block] == cpu_to_be16(NULLDATAOFF))\r\nuse_block = -1;\r\nif ((char *)bestsp - (char *)&ents[leafhdr.count] < needbytes &&\r\nleafhdr.stale > 1)\r\ncompact = 1;\r\nelse if ((char *)bestsp - (char *)&ents[leafhdr.count] < needbytes) {\r\nif ((args->op_flags & XFS_DA_OP_JUSTCHECK) ||\r\nargs->total == 0) {\r\nxfs_trans_brelse(tp, lbp);\r\nreturn XFS_ERROR(ENOSPC);\r\n}\r\nerror = xfs_dir2_leaf_to_node(args, lbp);\r\nif (error)\r\nreturn error;\r\nreturn xfs_dir2_node_addname(args);\r\n}\r\nelse\r\ncompact = 0;\r\nif (args->op_flags & XFS_DA_OP_JUSTCHECK) {\r\nxfs_trans_brelse(tp, lbp);\r\nreturn use_block == -1 ? XFS_ERROR(ENOSPC) : 0;\r\n}\r\nif (args->total == 0 && use_block == -1) {\r\nxfs_trans_brelse(tp, lbp);\r\nreturn XFS_ERROR(ENOSPC);\r\n}\r\nif (compact) {\r\nxfs_dir3_leaf_compact_x1(&leafhdr, ents, &index, &lowstale,\r\n&highstale, &lfloglow, &lfloghigh);\r\n}\r\nelse if (leafhdr.stale) {\r\nlfloglow = leafhdr.count;\r\nlfloghigh = -1;\r\n}\r\nif (use_block == -1) {\r\nif ((error = xfs_dir2_grow_inode(args, XFS_DIR2_DATA_SPACE,\r\n&use_block))) {\r\nxfs_trans_brelse(tp, lbp);\r\nreturn error;\r\n}\r\nif ((error = xfs_dir3_data_init(args, use_block, &dbp))) {\r\nxfs_trans_brelse(tp, lbp);\r\nreturn error;\r\n}\r\nif (use_block >= be32_to_cpu(ltp->bestcount)) {\r\nbestsp--;\r\nmemmove(&bestsp[0], &bestsp[1],\r\nbe32_to_cpu(ltp->bestcount) * sizeof(bestsp[0]));\r\nbe32_add_cpu(&ltp->bestcount, 1);\r\nxfs_dir3_leaf_log_tail(tp, lbp);\r\nxfs_dir3_leaf_log_bests(tp, lbp, 0, be32_to_cpu(ltp->bestcount) - 1);\r\n}\r\nelse\r\nxfs_dir3_leaf_log_bests(tp, lbp, use_block, use_block);\r\nhdr = dbp->b_addr;\r\nbf = dp->d_ops->data_bestfree_p(hdr);\r\nbestsp[use_block] = bf[0].length;\r\ngrown = 1;\r\n} else {\r\nerror = xfs_dir3_data_read(tp, dp,\r\nxfs_dir2_db_to_da(mp, use_block),\r\n-1, &dbp);\r\nif (error) {\r\nxfs_trans_brelse(tp, lbp);\r\nreturn error;\r\n}\r\nhdr = dbp->b_addr;\r\nbf = dp->d_ops->data_bestfree_p(hdr);\r\ngrown = 0;\r\n}\r\ndup = (xfs_dir2_data_unused_t *)\r\n((char *)hdr + be16_to_cpu(bf[0].offset));\r\nASSERT(be16_to_cpu(dup->length) >= length);\r\nneedscan = needlog = 0;\r\nxfs_dir2_data_use_free(tp, dp, dbp, dup,\r\n(xfs_dir2_data_aoff_t)((char *)dup - (char *)hdr), length,\r\n&needlog, &needscan);\r\ndep = (xfs_dir2_data_entry_t *)dup;\r\ndep->inumber = cpu_to_be64(args->inumber);\r\ndep->namelen = args->namelen;\r\nmemcpy(dep->name, args->name, dep->namelen);\r\ndp->d_ops->data_put_ftype(dep, args->filetype);\r\ntagp = dp->d_ops->data_entry_tag_p(dep);\r\n*tagp = cpu_to_be16((char *)dep - (char *)hdr);\r\nif (needscan)\r\nxfs_dir2_data_freescan(dp, hdr, &needlog);\r\nif (needlog)\r\nxfs_dir2_data_log_header(tp, dp, dbp);\r\nxfs_dir2_data_log_entry(tp, dp, dbp, dep);\r\nif (be16_to_cpu(bestsp[use_block]) != be16_to_cpu(bf[0].length)) {\r\nbestsp[use_block] = bf[0].length;\r\nif (!grown)\r\nxfs_dir3_leaf_log_bests(tp, lbp, use_block, use_block);\r\n}\r\nlep = xfs_dir3_leaf_find_entry(&leafhdr, ents, index, compact, lowstale,\r\nhighstale, &lfloglow, &lfloghigh);\r\nlep->hashval = cpu_to_be32(args->hashval);\r\nlep->address = cpu_to_be32(xfs_dir2_db_off_to_dataptr(mp, use_block,\r\nbe16_to_cpu(*tagp)));\r\ndp->d_ops->leaf_hdr_to_disk(leaf, &leafhdr);\r\nxfs_dir3_leaf_log_header(tp, dp, lbp);\r\nxfs_dir3_leaf_log_ents(tp, dp, lbp, lfloglow, lfloghigh);\r\nxfs_dir3_leaf_check(dp, lbp);\r\nxfs_dir3_data_check(dp, dbp);\r\nreturn 0;\r\n}\r\nvoid\r\nxfs_dir3_leaf_compact(\r\nxfs_da_args_t *args,\r\nstruct xfs_dir3_icleaf_hdr *leafhdr,\r\nstruct xfs_buf *bp)\r\n{\r\nint from;\r\nxfs_dir2_leaf_t *leaf;\r\nint loglow;\r\nint to;\r\nstruct xfs_dir2_leaf_entry *ents;\r\nstruct xfs_inode *dp = args->dp;\r\nleaf = bp->b_addr;\r\nif (!leafhdr->stale)\r\nreturn;\r\nents = dp->d_ops->leaf_ents_p(leaf);\r\nfor (from = to = 0, loglow = -1; from < leafhdr->count; from++) {\r\nif (ents[from].address == cpu_to_be32(XFS_DIR2_NULL_DATAPTR))\r\ncontinue;\r\nif (from > to) {\r\nif (loglow == -1)\r\nloglow = to;\r\nents[to] = ents[from];\r\n}\r\nto++;\r\n}\r\nASSERT(leafhdr->stale == from - to);\r\nleafhdr->count -= leafhdr->stale;\r\nleafhdr->stale = 0;\r\ndp->d_ops->leaf_hdr_to_disk(leaf, leafhdr);\r\nxfs_dir3_leaf_log_header(args->trans, dp, bp);\r\nif (loglow != -1)\r\nxfs_dir3_leaf_log_ents(args->trans, dp, bp, loglow, to - 1);\r\n}\r\nvoid\r\nxfs_dir3_leaf_compact_x1(\r\nstruct xfs_dir3_icleaf_hdr *leafhdr,\r\nstruct xfs_dir2_leaf_entry *ents,\r\nint *indexp,\r\nint *lowstalep,\r\nint *highstalep,\r\nint *lowlogp,\r\nint *highlogp)\r\n{\r\nint from;\r\nint highstale;\r\nint index;\r\nint keepstale;\r\nint lowstale;\r\nint newindex=0;\r\nint to;\r\nASSERT(leafhdr->stale > 1);\r\nindex = *indexp;\r\nxfs_dir3_leaf_find_stale(leafhdr, ents, index, &lowstale, &highstale);\r\nif (lowstale >= 0 &&\r\n(highstale == leafhdr->count ||\r\nindex - lowstale <= highstale - index))\r\nkeepstale = lowstale;\r\nelse\r\nkeepstale = highstale;\r\nfor (from = to = 0; from < leafhdr->count; from++) {\r\nif (index == from)\r\nnewindex = to;\r\nif (from != keepstale &&\r\nents[from].address == cpu_to_be32(XFS_DIR2_NULL_DATAPTR)) {\r\nif (from == to)\r\n*lowlogp = to;\r\ncontinue;\r\n}\r\nif (from == keepstale)\r\nlowstale = highstale = to;\r\nif (from > to)\r\nents[to] = ents[from];\r\nto++;\r\n}\r\nASSERT(from > to);\r\nif (index == from)\r\nnewindex = to;\r\n*indexp = newindex;\r\nleafhdr->count -= from - to;\r\nleafhdr->stale = 1;\r\nif (lowstale >= newindex)\r\nlowstale = -1;\r\nelse\r\nhighstale = leafhdr->count;\r\n*highlogp = leafhdr->count - 1;\r\n*lowstalep = lowstale;\r\n*highstalep = highstale;\r\n}\r\nstatic void\r\nxfs_dir3_leaf_log_bests(\r\nxfs_trans_t *tp,\r\nstruct xfs_buf *bp,\r\nint first,\r\nint last)\r\n{\r\n__be16 *firstb;\r\n__be16 *lastb;\r\nstruct xfs_dir2_leaf *leaf = bp->b_addr;\r\nxfs_dir2_leaf_tail_t *ltp;\r\nASSERT(leaf->hdr.info.magic == cpu_to_be16(XFS_DIR2_LEAF1_MAGIC) ||\r\nleaf->hdr.info.magic == cpu_to_be16(XFS_DIR3_LEAF1_MAGIC));\r\nltp = xfs_dir2_leaf_tail_p(tp->t_mountp, leaf);\r\nfirstb = xfs_dir2_leaf_bests_p(ltp) + first;\r\nlastb = xfs_dir2_leaf_bests_p(ltp) + last;\r\nxfs_trans_log_buf(tp, bp, (uint)((char *)firstb - (char *)leaf),\r\n(uint)((char *)lastb - (char *)leaf + sizeof(*lastb) - 1));\r\n}\r\nvoid\r\nxfs_dir3_leaf_log_ents(\r\nstruct xfs_trans *tp,\r\nstruct xfs_inode *dp,\r\nstruct xfs_buf *bp,\r\nint first,\r\nint last)\r\n{\r\nxfs_dir2_leaf_entry_t *firstlep;\r\nxfs_dir2_leaf_entry_t *lastlep;\r\nstruct xfs_dir2_leaf *leaf = bp->b_addr;\r\nstruct xfs_dir2_leaf_entry *ents;\r\nASSERT(leaf->hdr.info.magic == cpu_to_be16(XFS_DIR2_LEAF1_MAGIC) ||\r\nleaf->hdr.info.magic == cpu_to_be16(XFS_DIR3_LEAF1_MAGIC) ||\r\nleaf->hdr.info.magic == cpu_to_be16(XFS_DIR2_LEAFN_MAGIC) ||\r\nleaf->hdr.info.magic == cpu_to_be16(XFS_DIR3_LEAFN_MAGIC));\r\nents = dp->d_ops->leaf_ents_p(leaf);\r\nfirstlep = &ents[first];\r\nlastlep = &ents[last];\r\nxfs_trans_log_buf(tp, bp, (uint)((char *)firstlep - (char *)leaf),\r\n(uint)((char *)lastlep - (char *)leaf + sizeof(*lastlep) - 1));\r\n}\r\nvoid\r\nxfs_dir3_leaf_log_header(\r\nstruct xfs_trans *tp,\r\nstruct xfs_inode *dp,\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_dir2_leaf *leaf = bp->b_addr;\r\nASSERT(leaf->hdr.info.magic == cpu_to_be16(XFS_DIR2_LEAF1_MAGIC) ||\r\nleaf->hdr.info.magic == cpu_to_be16(XFS_DIR3_LEAF1_MAGIC) ||\r\nleaf->hdr.info.magic == cpu_to_be16(XFS_DIR2_LEAFN_MAGIC) ||\r\nleaf->hdr.info.magic == cpu_to_be16(XFS_DIR3_LEAFN_MAGIC));\r\nxfs_trans_log_buf(tp, bp, (uint)((char *)&leaf->hdr - (char *)leaf),\r\ndp->d_ops->leaf_hdr_size - 1);\r\n}\r\nSTATIC void\r\nxfs_dir3_leaf_log_tail(\r\nstruct xfs_trans *tp,\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_dir2_leaf *leaf = bp->b_addr;\r\nxfs_dir2_leaf_tail_t *ltp;\r\nstruct xfs_mount *mp = tp->t_mountp;\r\nASSERT(leaf->hdr.info.magic == cpu_to_be16(XFS_DIR2_LEAF1_MAGIC) ||\r\nleaf->hdr.info.magic == cpu_to_be16(XFS_DIR3_LEAF1_MAGIC) ||\r\nleaf->hdr.info.magic == cpu_to_be16(XFS_DIR2_LEAFN_MAGIC) ||\r\nleaf->hdr.info.magic == cpu_to_be16(XFS_DIR3_LEAFN_MAGIC));\r\nltp = xfs_dir2_leaf_tail_p(mp, leaf);\r\nxfs_trans_log_buf(tp, bp, (uint)((char *)ltp - (char *)leaf),\r\n(uint)(mp->m_dirblksize - 1));\r\n}\r\nint\r\nxfs_dir2_leaf_lookup(\r\nxfs_da_args_t *args)\r\n{\r\nstruct xfs_buf *dbp;\r\nxfs_dir2_data_entry_t *dep;\r\nxfs_inode_t *dp;\r\nint error;\r\nint index;\r\nstruct xfs_buf *lbp;\r\nxfs_dir2_leaf_t *leaf;\r\nxfs_dir2_leaf_entry_t *lep;\r\nxfs_trans_t *tp;\r\nstruct xfs_dir2_leaf_entry *ents;\r\ntrace_xfs_dir2_leaf_lookup(args);\r\nif ((error = xfs_dir2_leaf_lookup_int(args, &lbp, &index, &dbp))) {\r\nreturn error;\r\n}\r\ntp = args->trans;\r\ndp = args->dp;\r\nxfs_dir3_leaf_check(dp, lbp);\r\nleaf = lbp->b_addr;\r\nents = dp->d_ops->leaf_ents_p(leaf);\r\nlep = &ents[index];\r\ndep = (xfs_dir2_data_entry_t *)\r\n((char *)dbp->b_addr +\r\nxfs_dir2_dataptr_to_off(dp->i_mount, be32_to_cpu(lep->address)));\r\nargs->inumber = be64_to_cpu(dep->inumber);\r\nargs->filetype = dp->d_ops->data_get_ftype(dep);\r\nerror = xfs_dir_cilookup_result(args, dep->name, dep->namelen);\r\nxfs_trans_brelse(tp, dbp);\r\nxfs_trans_brelse(tp, lbp);\r\nreturn XFS_ERROR(error);\r\n}\r\nstatic int\r\nxfs_dir2_leaf_lookup_int(\r\nxfs_da_args_t *args,\r\nstruct xfs_buf **lbpp,\r\nint *indexp,\r\nstruct xfs_buf **dbpp)\r\n{\r\nxfs_dir2_db_t curdb = -1;\r\nstruct xfs_buf *dbp = NULL;\r\nxfs_dir2_data_entry_t *dep;\r\nxfs_inode_t *dp;\r\nint error;\r\nint index;\r\nstruct xfs_buf *lbp;\r\nxfs_dir2_leaf_entry_t *lep;\r\nxfs_dir2_leaf_t *leaf;\r\nxfs_mount_t *mp;\r\nxfs_dir2_db_t newdb;\r\nxfs_trans_t *tp;\r\nxfs_dir2_db_t cidb = -1;\r\nenum xfs_dacmp cmp;\r\nstruct xfs_dir2_leaf_entry *ents;\r\nstruct xfs_dir3_icleaf_hdr leafhdr;\r\ndp = args->dp;\r\ntp = args->trans;\r\nmp = dp->i_mount;\r\nerror = xfs_dir3_leaf_read(tp, dp, mp->m_dirleafblk, -1, &lbp);\r\nif (error)\r\nreturn error;\r\n*lbpp = lbp;\r\nleaf = lbp->b_addr;\r\nxfs_dir3_leaf_check(dp, lbp);\r\nents = dp->d_ops->leaf_ents_p(leaf);\r\ndp->d_ops->leaf_hdr_from_disk(&leafhdr, leaf);\r\nindex = xfs_dir2_leaf_search_hash(args, lbp);\r\nfor (lep = &ents[index];\r\nindex < leafhdr.count && be32_to_cpu(lep->hashval) == args->hashval;\r\nlep++, index++) {\r\nif (be32_to_cpu(lep->address) == XFS_DIR2_NULL_DATAPTR)\r\ncontinue;\r\nnewdb = xfs_dir2_dataptr_to_db(mp, be32_to_cpu(lep->address));\r\nif (newdb != curdb) {\r\nif (dbp)\r\nxfs_trans_brelse(tp, dbp);\r\nerror = xfs_dir3_data_read(tp, dp,\r\nxfs_dir2_db_to_da(mp, newdb),\r\n-1, &dbp);\r\nif (error) {\r\nxfs_trans_brelse(tp, lbp);\r\nreturn error;\r\n}\r\ncurdb = newdb;\r\n}\r\ndep = (xfs_dir2_data_entry_t *)((char *)dbp->b_addr +\r\nxfs_dir2_dataptr_to_off(mp, be32_to_cpu(lep->address)));\r\ncmp = mp->m_dirnameops->compname(args, dep->name, dep->namelen);\r\nif (cmp != XFS_CMP_DIFFERENT && cmp != args->cmpresult) {\r\nargs->cmpresult = cmp;\r\n*indexp = index;\r\nif (cmp == XFS_CMP_EXACT) {\r\n*dbpp = dbp;\r\nreturn 0;\r\n}\r\ncidb = curdb;\r\n}\r\n}\r\nASSERT(args->op_flags & XFS_DA_OP_OKNOENT);\r\nif (args->cmpresult == XFS_CMP_CASE) {\r\nASSERT(cidb != -1);\r\nif (cidb != curdb) {\r\nxfs_trans_brelse(tp, dbp);\r\nerror = xfs_dir3_data_read(tp, dp,\r\nxfs_dir2_db_to_da(mp, cidb),\r\n-1, &dbp);\r\nif (error) {\r\nxfs_trans_brelse(tp, lbp);\r\nreturn error;\r\n}\r\n}\r\n*dbpp = dbp;\r\nreturn 0;\r\n}\r\nASSERT(cidb == -1);\r\nif (dbp)\r\nxfs_trans_brelse(tp, dbp);\r\nxfs_trans_brelse(tp, lbp);\r\nreturn XFS_ERROR(ENOENT);\r\n}\r\nint\r\nxfs_dir2_leaf_removename(\r\nxfs_da_args_t *args)\r\n{\r\n__be16 *bestsp;\r\nxfs_dir2_data_hdr_t *hdr;\r\nxfs_dir2_db_t db;\r\nstruct xfs_buf *dbp;\r\nxfs_dir2_data_entry_t *dep;\r\nxfs_inode_t *dp;\r\nint error;\r\nxfs_dir2_db_t i;\r\nint index;\r\nstruct xfs_buf *lbp;\r\nxfs_dir2_leaf_t *leaf;\r\nxfs_dir2_leaf_entry_t *lep;\r\nxfs_dir2_leaf_tail_t *ltp;\r\nxfs_mount_t *mp;\r\nint needlog;\r\nint needscan;\r\nxfs_dir2_data_off_t oldbest;\r\nxfs_trans_t *tp;\r\nstruct xfs_dir2_data_free *bf;\r\nstruct xfs_dir2_leaf_entry *ents;\r\nstruct xfs_dir3_icleaf_hdr leafhdr;\r\ntrace_xfs_dir2_leaf_removename(args);\r\nif ((error = xfs_dir2_leaf_lookup_int(args, &lbp, &index, &dbp))) {\r\nreturn error;\r\n}\r\ndp = args->dp;\r\ntp = args->trans;\r\nmp = dp->i_mount;\r\nleaf = lbp->b_addr;\r\nhdr = dbp->b_addr;\r\nxfs_dir3_data_check(dp, dbp);\r\nbf = dp->d_ops->data_bestfree_p(hdr);\r\ndp->d_ops->leaf_hdr_from_disk(&leafhdr, leaf);\r\nents = dp->d_ops->leaf_ents_p(leaf);\r\nlep = &ents[index];\r\ndb = xfs_dir2_dataptr_to_db(mp, be32_to_cpu(lep->address));\r\ndep = (xfs_dir2_data_entry_t *)\r\n((char *)hdr + xfs_dir2_dataptr_to_off(mp, be32_to_cpu(lep->address)));\r\nneedscan = needlog = 0;\r\noldbest = be16_to_cpu(bf[0].length);\r\nltp = xfs_dir2_leaf_tail_p(mp, leaf);\r\nbestsp = xfs_dir2_leaf_bests_p(ltp);\r\nASSERT(be16_to_cpu(bestsp[db]) == oldbest);\r\nxfs_dir2_data_make_free(tp, dp, dbp,\r\n(xfs_dir2_data_aoff_t)((char *)dep - (char *)hdr),\r\ndp->d_ops->data_entsize(dep->namelen), &needlog, &needscan);\r\nleafhdr.stale++;\r\ndp->d_ops->leaf_hdr_to_disk(leaf, &leafhdr);\r\nxfs_dir3_leaf_log_header(tp, dp, lbp);\r\nlep->address = cpu_to_be32(XFS_DIR2_NULL_DATAPTR);\r\nxfs_dir3_leaf_log_ents(tp, dp, lbp, index, index);\r\nif (needscan)\r\nxfs_dir2_data_freescan(dp, hdr, &needlog);\r\nif (needlog)\r\nxfs_dir2_data_log_header(tp, dp, dbp);\r\nif (be16_to_cpu(bf[0].length) != oldbest) {\r\nbestsp[db] = bf[0].length;\r\nxfs_dir3_leaf_log_bests(tp, lbp, db, db);\r\n}\r\nxfs_dir3_data_check(dp, dbp);\r\nif (be16_to_cpu(bf[0].length) ==\r\nmp->m_dirblksize - dp->d_ops->data_entry_offset) {\r\nASSERT(db != mp->m_dirdatablk);\r\nif ((error = xfs_dir2_shrink_inode(args, db, dbp))) {\r\nif (error == ENOSPC && args->total == 0)\r\nerror = 0;\r\nxfs_dir3_leaf_check(dp, lbp);\r\nreturn error;\r\n}\r\ndbp = NULL;\r\nif (db == be32_to_cpu(ltp->bestcount) - 1) {\r\nfor (i = db - 1; i > 0; i--) {\r\nif (bestsp[i] != cpu_to_be16(NULLDATAOFF))\r\nbreak;\r\n}\r\nmemmove(&bestsp[db - i], bestsp,\r\n(be32_to_cpu(ltp->bestcount) - (db - i)) * sizeof(*bestsp));\r\nbe32_add_cpu(&ltp->bestcount, -(db - i));\r\nxfs_dir3_leaf_log_tail(tp, lbp);\r\nxfs_dir3_leaf_log_bests(tp, lbp, 0, be32_to_cpu(ltp->bestcount) - 1);\r\n} else\r\nbestsp[db] = cpu_to_be16(NULLDATAOFF);\r\n}\r\nelse if (db != mp->m_dirdatablk)\r\ndbp = NULL;\r\nxfs_dir3_leaf_check(dp, lbp);\r\nreturn xfs_dir2_leaf_to_block(args, lbp, dbp);\r\n}\r\nint\r\nxfs_dir2_leaf_replace(\r\nxfs_da_args_t *args)\r\n{\r\nstruct xfs_buf *dbp;\r\nxfs_dir2_data_entry_t *dep;\r\nxfs_inode_t *dp;\r\nint error;\r\nint index;\r\nstruct xfs_buf *lbp;\r\nxfs_dir2_leaf_t *leaf;\r\nxfs_dir2_leaf_entry_t *lep;\r\nxfs_trans_t *tp;\r\nstruct xfs_dir2_leaf_entry *ents;\r\ntrace_xfs_dir2_leaf_replace(args);\r\nif ((error = xfs_dir2_leaf_lookup_int(args, &lbp, &index, &dbp))) {\r\nreturn error;\r\n}\r\ndp = args->dp;\r\nleaf = lbp->b_addr;\r\nents = dp->d_ops->leaf_ents_p(leaf);\r\nlep = &ents[index];\r\ndep = (xfs_dir2_data_entry_t *)\r\n((char *)dbp->b_addr +\r\nxfs_dir2_dataptr_to_off(dp->i_mount, be32_to_cpu(lep->address)));\r\nASSERT(args->inumber != be64_to_cpu(dep->inumber));\r\ndep->inumber = cpu_to_be64(args->inumber);\r\ndp->d_ops->data_put_ftype(dep, args->filetype);\r\ntp = args->trans;\r\nxfs_dir2_data_log_entry(tp, dp, dbp, dep);\r\nxfs_dir3_leaf_check(dp, lbp);\r\nxfs_trans_brelse(tp, lbp);\r\nreturn 0;\r\n}\r\nint\r\nxfs_dir2_leaf_search_hash(\r\nxfs_da_args_t *args,\r\nstruct xfs_buf *lbp)\r\n{\r\nxfs_dahash_t hash=0;\r\nxfs_dahash_t hashwant;\r\nint high;\r\nint low;\r\nxfs_dir2_leaf_t *leaf;\r\nxfs_dir2_leaf_entry_t *lep;\r\nint mid=0;\r\nstruct xfs_dir2_leaf_entry *ents;\r\nstruct xfs_dir3_icleaf_hdr leafhdr;\r\nleaf = lbp->b_addr;\r\nents = args->dp->d_ops->leaf_ents_p(leaf);\r\nargs->dp->d_ops->leaf_hdr_from_disk(&leafhdr, leaf);\r\nfor (lep = ents, low = 0, high = leafhdr.count - 1,\r\nhashwant = args->hashval;\r\nlow <= high; ) {\r\nmid = (low + high) >> 1;\r\nif ((hash = be32_to_cpu(lep[mid].hashval)) == hashwant)\r\nbreak;\r\nif (hash < hashwant)\r\nlow = mid + 1;\r\nelse\r\nhigh = mid - 1;\r\n}\r\nif (hash == hashwant) {\r\nwhile (mid > 0 && be32_to_cpu(lep[mid - 1].hashval) == hashwant) {\r\nmid--;\r\n}\r\n}\r\nelse if (hash < hashwant)\r\nmid++;\r\nreturn mid;\r\n}\r\nint\r\nxfs_dir2_leaf_trim_data(\r\nxfs_da_args_t *args,\r\nstruct xfs_buf *lbp,\r\nxfs_dir2_db_t db)\r\n{\r\n__be16 *bestsp;\r\nstruct xfs_buf *dbp;\r\nxfs_inode_t *dp;\r\nint error;\r\nxfs_dir2_leaf_t *leaf;\r\nxfs_dir2_leaf_tail_t *ltp;\r\nxfs_mount_t *mp;\r\nxfs_trans_t *tp;\r\ndp = args->dp;\r\nmp = dp->i_mount;\r\ntp = args->trans;\r\nerror = xfs_dir3_data_read(tp, dp, xfs_dir2_db_to_da(mp, db), -1, &dbp);\r\nif (error)\r\nreturn error;\r\nleaf = lbp->b_addr;\r\nltp = xfs_dir2_leaf_tail_p(mp, leaf);\r\n#ifdef DEBUG\r\n{\r\nstruct xfs_dir2_data_hdr *hdr = dbp->b_addr;\r\nstruct xfs_dir2_data_free *bf = dp->d_ops->data_bestfree_p(hdr);\r\nASSERT(hdr->magic == cpu_to_be32(XFS_DIR2_DATA_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR3_DATA_MAGIC));\r\nASSERT(be16_to_cpu(bf[0].length) ==\r\nmp->m_dirblksize - dp->d_ops->data_entry_offset);\r\nASSERT(db == be32_to_cpu(ltp->bestcount) - 1);\r\n}\r\n#endif\r\nif ((error = xfs_dir2_shrink_inode(args, db, dbp))) {\r\nASSERT(error != ENOSPC);\r\nxfs_trans_brelse(tp, dbp);\r\nreturn error;\r\n}\r\nbestsp = xfs_dir2_leaf_bests_p(ltp);\r\nbe32_add_cpu(&ltp->bestcount, -1);\r\nmemmove(&bestsp[1], &bestsp[0], be32_to_cpu(ltp->bestcount) * sizeof(*bestsp));\r\nxfs_dir3_leaf_log_tail(tp, lbp);\r\nxfs_dir3_leaf_log_bests(tp, lbp, 0, be32_to_cpu(ltp->bestcount) - 1);\r\nreturn 0;\r\n}\r\nstatic inline size_t\r\nxfs_dir3_leaf_size(\r\nstruct xfs_dir3_icleaf_hdr *hdr,\r\nint counts)\r\n{\r\nint entries;\r\nint hdrsize;\r\nentries = hdr->count - hdr->stale;\r\nif (hdr->magic == XFS_DIR2_LEAF1_MAGIC ||\r\nhdr->magic == XFS_DIR2_LEAFN_MAGIC)\r\nhdrsize = sizeof(struct xfs_dir2_leaf_hdr);\r\nelse\r\nhdrsize = sizeof(struct xfs_dir3_leaf_hdr);\r\nreturn hdrsize + entries * sizeof(xfs_dir2_leaf_entry_t)\r\n+ counts * sizeof(xfs_dir2_data_off_t)\r\n+ sizeof(xfs_dir2_leaf_tail_t);\r\n}\r\nint\r\nxfs_dir2_node_to_leaf(\r\nxfs_da_state_t *state)\r\n{\r\nxfs_da_args_t *args;\r\nxfs_inode_t *dp;\r\nint error;\r\nstruct xfs_buf *fbp;\r\nxfs_fileoff_t fo;\r\nxfs_dir2_free_t *free;\r\nstruct xfs_buf *lbp;\r\nxfs_dir2_leaf_tail_t *ltp;\r\nxfs_dir2_leaf_t *leaf;\r\nxfs_mount_t *mp;\r\nint rval;\r\nxfs_trans_t *tp;\r\nstruct xfs_dir3_icleaf_hdr leafhdr;\r\nstruct xfs_dir3_icfree_hdr freehdr;\r\nif (state->path.active > 1)\r\nreturn 0;\r\nargs = state->args;\r\ntrace_xfs_dir2_node_to_leaf(args);\r\nmp = state->mp;\r\ndp = args->dp;\r\ntp = args->trans;\r\nif ((error = xfs_bmap_last_offset(tp, dp, &fo, XFS_DATA_FORK))) {\r\nreturn error;\r\n}\r\nfo -= mp->m_dirblkfsbs;\r\nwhile (fo > mp->m_dirfreeblk) {\r\nif ((error = xfs_dir2_node_trim_free(args, fo, &rval))) {\r\nreturn error;\r\n}\r\nif (rval)\r\nfo -= mp->m_dirblkfsbs;\r\nelse\r\nreturn 0;\r\n}\r\nif ((error = xfs_bmap_last_before(tp, dp, &fo, XFS_DATA_FORK))) {\r\nreturn error;\r\n}\r\nif (XFS_FSB_TO_B(mp, fo) > XFS_DIR2_LEAF_OFFSET + mp->m_dirblksize)\r\nreturn 0;\r\nlbp = state->path.blk[0].bp;\r\nleaf = lbp->b_addr;\r\ndp->d_ops->leaf_hdr_from_disk(&leafhdr, leaf);\r\nASSERT(leafhdr.magic == XFS_DIR2_LEAFN_MAGIC ||\r\nleafhdr.magic == XFS_DIR3_LEAFN_MAGIC);\r\nerror = xfs_dir2_free_read(tp, dp, mp->m_dirfreeblk, &fbp);\r\nif (error)\r\nreturn error;\r\nfree = fbp->b_addr;\r\ndp->d_ops->free_hdr_from_disk(&freehdr, free);\r\nASSERT(!freehdr.firstdb);\r\nif (xfs_dir3_leaf_size(&leafhdr, freehdr.nvalid) > mp->m_dirblksize) {\r\nxfs_trans_brelse(tp, fbp);\r\nreturn 0;\r\n}\r\nif (leafhdr.stale)\r\nxfs_dir3_leaf_compact(args, &leafhdr, lbp);\r\nlbp->b_ops = &xfs_dir3_leaf1_buf_ops;\r\nxfs_trans_buf_set_type(tp, lbp, XFS_BLFT_DIR_LEAF1_BUF);\r\nleafhdr.magic = (leafhdr.magic == XFS_DIR2_LEAFN_MAGIC)\r\n? XFS_DIR2_LEAF1_MAGIC\r\n: XFS_DIR3_LEAF1_MAGIC;\r\nltp = xfs_dir2_leaf_tail_p(mp, leaf);\r\nltp->bestcount = cpu_to_be32(freehdr.nvalid);\r\nmemcpy(xfs_dir2_leaf_bests_p(ltp), dp->d_ops->free_bests_p(free),\r\nfreehdr.nvalid * sizeof(xfs_dir2_data_off_t));\r\ndp->d_ops->leaf_hdr_to_disk(leaf, &leafhdr);\r\nxfs_dir3_leaf_log_header(tp, dp, lbp);\r\nxfs_dir3_leaf_log_bests(tp, lbp, 0, be32_to_cpu(ltp->bestcount) - 1);\r\nxfs_dir3_leaf_log_tail(tp, lbp);\r\nxfs_dir3_leaf_check(dp, lbp);\r\nerror = xfs_dir2_shrink_inode(args, XFS_DIR2_FREE_FIRSTDB(mp), fbp);\r\nif (error) {\r\nASSERT(error != ENOSPC);\r\nreturn error;\r\n}\r\nfbp = NULL;\r\nerror = xfs_dir2_leaf_to_block(args, lbp, NULL);\r\nstate->path.blk[0].bp = NULL;\r\nreturn error;\r\n}

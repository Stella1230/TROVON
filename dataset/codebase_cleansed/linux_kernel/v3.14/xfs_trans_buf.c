STATIC struct xfs_buf *\r\nxfs_trans_buf_item_match(\r\nstruct xfs_trans *tp,\r\nstruct xfs_buftarg *target,\r\nstruct xfs_buf_map *map,\r\nint nmaps)\r\n{\r\nstruct xfs_log_item_desc *lidp;\r\nstruct xfs_buf_log_item *blip;\r\nint len = 0;\r\nint i;\r\nfor (i = 0; i < nmaps; i++)\r\nlen += map[i].bm_len;\r\nlist_for_each_entry(lidp, &tp->t_items, lid_trans) {\r\nblip = (struct xfs_buf_log_item *)lidp->lid_item;\r\nif (blip->bli_item.li_type == XFS_LI_BUF &&\r\nblip->bli_buf->b_target == target &&\r\nXFS_BUF_ADDR(blip->bli_buf) == map[0].bm_bn &&\r\nblip->bli_buf->b_length == len) {\r\nASSERT(blip->bli_buf->b_map_count == nmaps);\r\nreturn blip->bli_buf;\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nSTATIC void\r\n_xfs_trans_bjoin(\r\nstruct xfs_trans *tp,\r\nstruct xfs_buf *bp,\r\nint reset_recur)\r\n{\r\nstruct xfs_buf_log_item *bip;\r\nASSERT(bp->b_transp == NULL);\r\nxfs_buf_item_init(bp, tp->t_mountp);\r\nbip = bp->b_fspriv;\r\nASSERT(!(bip->bli_flags & XFS_BLI_STALE));\r\nASSERT(!(bip->__bli_format.blf_flags & XFS_BLF_CANCEL));\r\nASSERT(!(bip->bli_flags & XFS_BLI_LOGGED));\r\nif (reset_recur)\r\nbip->bli_recur = 0;\r\natomic_inc(&bip->bli_refcount);\r\nxfs_trans_add_item(tp, &bip->bli_item);\r\nbp->b_transp = tp;\r\n}\r\nvoid\r\nxfs_trans_bjoin(\r\nstruct xfs_trans *tp,\r\nstruct xfs_buf *bp)\r\n{\r\n_xfs_trans_bjoin(tp, bp, 0);\r\ntrace_xfs_trans_bjoin(bp->b_fspriv);\r\n}\r\nstruct xfs_buf *\r\nxfs_trans_get_buf_map(\r\nstruct xfs_trans *tp,\r\nstruct xfs_buftarg *target,\r\nstruct xfs_buf_map *map,\r\nint nmaps,\r\nxfs_buf_flags_t flags)\r\n{\r\nxfs_buf_t *bp;\r\nxfs_buf_log_item_t *bip;\r\nif (!tp)\r\nreturn xfs_buf_get_map(target, map, nmaps, flags);\r\nbp = xfs_trans_buf_item_match(tp, target, map, nmaps);\r\nif (bp != NULL) {\r\nASSERT(xfs_buf_islocked(bp));\r\nif (XFS_FORCED_SHUTDOWN(tp->t_mountp)) {\r\nxfs_buf_stale(bp);\r\nXFS_BUF_DONE(bp);\r\n}\r\nASSERT(bp->b_transp == tp);\r\nbip = bp->b_fspriv;\r\nASSERT(bip != NULL);\r\nASSERT(atomic_read(&bip->bli_refcount) > 0);\r\nbip->bli_recur++;\r\ntrace_xfs_trans_get_buf_recur(bip);\r\nreturn (bp);\r\n}\r\nbp = xfs_buf_get_map(target, map, nmaps, flags);\r\nif (bp == NULL) {\r\nreturn NULL;\r\n}\r\nASSERT(!bp->b_error);\r\n_xfs_trans_bjoin(tp, bp, 1);\r\ntrace_xfs_trans_get_buf(bp->b_fspriv);\r\nreturn (bp);\r\n}\r\nxfs_buf_t *\r\nxfs_trans_getsb(xfs_trans_t *tp,\r\nstruct xfs_mount *mp,\r\nint flags)\r\n{\r\nxfs_buf_t *bp;\r\nxfs_buf_log_item_t *bip;\r\nif (tp == NULL) {\r\nreturn (xfs_getsb(mp, flags));\r\n}\r\nbp = mp->m_sb_bp;\r\nif (bp->b_transp == tp) {\r\nbip = bp->b_fspriv;\r\nASSERT(bip != NULL);\r\nASSERT(atomic_read(&bip->bli_refcount) > 0);\r\nbip->bli_recur++;\r\ntrace_xfs_trans_getsb_recur(bip);\r\nreturn (bp);\r\n}\r\nbp = xfs_getsb(mp, flags);\r\nif (bp == NULL)\r\nreturn NULL;\r\n_xfs_trans_bjoin(tp, bp, 1);\r\ntrace_xfs_trans_getsb(bp->b_fspriv);\r\nreturn (bp);\r\n}\r\nint\r\nxfs_trans_read_buf_map(\r\nstruct xfs_mount *mp,\r\nstruct xfs_trans *tp,\r\nstruct xfs_buftarg *target,\r\nstruct xfs_buf_map *map,\r\nint nmaps,\r\nxfs_buf_flags_t flags,\r\nstruct xfs_buf **bpp,\r\nconst struct xfs_buf_ops *ops)\r\n{\r\nxfs_buf_t *bp;\r\nxfs_buf_log_item_t *bip;\r\nint error;\r\n*bpp = NULL;\r\nif (!tp) {\r\nbp = xfs_buf_read_map(target, map, nmaps, flags, ops);\r\nif (!bp)\r\nreturn (flags & XBF_TRYLOCK) ?\r\nEAGAIN : XFS_ERROR(ENOMEM);\r\nif (bp->b_error) {\r\nerror = bp->b_error;\r\nxfs_buf_ioerror_alert(bp, __func__);\r\nXFS_BUF_UNDONE(bp);\r\nxfs_buf_stale(bp);\r\nxfs_buf_relse(bp);\r\nreturn error;\r\n}\r\n#ifdef DEBUG\r\nif (xfs_do_error) {\r\nif (xfs_error_target == target) {\r\nif (((xfs_req_num++) % xfs_error_mod) == 0) {\r\nxfs_buf_relse(bp);\r\nxfs_debug(mp, "Returning error!");\r\nreturn XFS_ERROR(EIO);\r\n}\r\n}\r\n}\r\n#endif\r\nif (XFS_FORCED_SHUTDOWN(mp))\r\ngoto shutdown_abort;\r\n*bpp = bp;\r\nreturn 0;\r\n}\r\nbp = xfs_trans_buf_item_match(tp, target, map, nmaps);\r\nif (bp != NULL) {\r\nASSERT(xfs_buf_islocked(bp));\r\nASSERT(bp->b_transp == tp);\r\nASSERT(bp->b_fspriv != NULL);\r\nASSERT(!bp->b_error);\r\nif (!(XFS_BUF_ISDONE(bp))) {\r\ntrace_xfs_trans_read_buf_io(bp, _RET_IP_);\r\nASSERT(!XFS_BUF_ISASYNC(bp));\r\nASSERT(bp->b_iodone == NULL);\r\nXFS_BUF_READ(bp);\r\nbp->b_ops = ops;\r\nif (XFS_FORCED_SHUTDOWN(mp)) {\r\ntrace_xfs_bdstrat_shut(bp, _RET_IP_);\r\nxfs_bioerror_relse(bp);\r\n} else {\r\nxfs_buf_iorequest(bp);\r\n}\r\nerror = xfs_buf_iowait(bp);\r\nif (error) {\r\nxfs_buf_ioerror_alert(bp, __func__);\r\nxfs_buf_relse(bp);\r\nif (tp->t_flags & XFS_TRANS_DIRTY)\r\nxfs_force_shutdown(tp->t_mountp,\r\nSHUTDOWN_META_IO_ERROR);\r\nreturn error;\r\n}\r\n}\r\nif (XFS_FORCED_SHUTDOWN(mp)) {\r\ntrace_xfs_trans_read_buf_shut(bp, _RET_IP_);\r\n*bpp = NULL;\r\nreturn XFS_ERROR(EIO);\r\n}\r\nbip = bp->b_fspriv;\r\nbip->bli_recur++;\r\nASSERT(atomic_read(&bip->bli_refcount) > 0);\r\ntrace_xfs_trans_read_buf_recur(bip);\r\n*bpp = bp;\r\nreturn 0;\r\n}\r\nbp = xfs_buf_read_map(target, map, nmaps, flags, ops);\r\nif (bp == NULL) {\r\n*bpp = NULL;\r\nreturn (flags & XBF_TRYLOCK) ?\r\n0 : XFS_ERROR(ENOMEM);\r\n}\r\nif (bp->b_error) {\r\nerror = bp->b_error;\r\nxfs_buf_stale(bp);\r\nXFS_BUF_DONE(bp);\r\nxfs_buf_ioerror_alert(bp, __func__);\r\nif (tp->t_flags & XFS_TRANS_DIRTY)\r\nxfs_force_shutdown(tp->t_mountp, SHUTDOWN_META_IO_ERROR);\r\nxfs_buf_relse(bp);\r\nreturn error;\r\n}\r\n#ifdef DEBUG\r\nif (xfs_do_error && !(tp->t_flags & XFS_TRANS_DIRTY)) {\r\nif (xfs_error_target == target) {\r\nif (((xfs_req_num++) % xfs_error_mod) == 0) {\r\nxfs_force_shutdown(tp->t_mountp,\r\nSHUTDOWN_META_IO_ERROR);\r\nxfs_buf_relse(bp);\r\nxfs_debug(mp, "Returning trans error!");\r\nreturn XFS_ERROR(EIO);\r\n}\r\n}\r\n}\r\n#endif\r\nif (XFS_FORCED_SHUTDOWN(mp))\r\ngoto shutdown_abort;\r\n_xfs_trans_bjoin(tp, bp, 1);\r\ntrace_xfs_trans_read_buf(bp->b_fspriv);\r\n*bpp = bp;\r\nreturn 0;\r\nshutdown_abort:\r\ntrace_xfs_trans_read_buf_shut(bp, _RET_IP_);\r\nxfs_buf_relse(bp);\r\n*bpp = NULL;\r\nreturn XFS_ERROR(EIO);\r\n}\r\nvoid\r\nxfs_trans_brelse(xfs_trans_t *tp,\r\nxfs_buf_t *bp)\r\n{\r\nxfs_buf_log_item_t *bip;\r\nif (tp == NULL) {\r\nASSERT(bp->b_transp == NULL);\r\nxfs_buf_relse(bp);\r\nreturn;\r\n}\r\nASSERT(bp->b_transp == tp);\r\nbip = bp->b_fspriv;\r\nASSERT(bip->bli_item.li_type == XFS_LI_BUF);\r\nASSERT(!(bip->bli_flags & XFS_BLI_STALE));\r\nASSERT(!(bip->__bli_format.blf_flags & XFS_BLF_CANCEL));\r\nASSERT(atomic_read(&bip->bli_refcount) > 0);\r\ntrace_xfs_trans_brelse(bip);\r\nif (bip->bli_recur > 0) {\r\nbip->bli_recur--;\r\nreturn;\r\n}\r\nif (bip->bli_item.li_desc->lid_flags & XFS_LID_DIRTY)\r\nreturn;\r\nif (bip->bli_flags & XFS_BLI_STALE)\r\nreturn;\r\nASSERT(!(bip->bli_flags & XFS_BLI_LOGGED));\r\nxfs_trans_del_item(&bip->bli_item);\r\nif (bip->bli_flags & XFS_BLI_HOLD) {\r\nbip->bli_flags &= ~XFS_BLI_HOLD;\r\n}\r\natomic_dec(&bip->bli_refcount);\r\nif (!xfs_buf_item_dirty(bip)) {\r\nASSERT(atomic_read(&bip->bli_refcount) == 0);\r\nASSERT(!(bip->bli_item.li_flags & XFS_LI_IN_AIL));\r\nASSERT(!(bip->bli_flags & XFS_BLI_INODE_ALLOC_BUF));\r\nxfs_buf_item_relse(bp);\r\n}\r\nbp->b_transp = NULL;\r\nxfs_buf_relse(bp);\r\n}\r\nvoid\r\nxfs_trans_bhold(xfs_trans_t *tp,\r\nxfs_buf_t *bp)\r\n{\r\nxfs_buf_log_item_t *bip = bp->b_fspriv;\r\nASSERT(bp->b_transp == tp);\r\nASSERT(bip != NULL);\r\nASSERT(!(bip->bli_flags & XFS_BLI_STALE));\r\nASSERT(!(bip->__bli_format.blf_flags & XFS_BLF_CANCEL));\r\nASSERT(atomic_read(&bip->bli_refcount) > 0);\r\nbip->bli_flags |= XFS_BLI_HOLD;\r\ntrace_xfs_trans_bhold(bip);\r\n}\r\nvoid\r\nxfs_trans_bhold_release(xfs_trans_t *tp,\r\nxfs_buf_t *bp)\r\n{\r\nxfs_buf_log_item_t *bip = bp->b_fspriv;\r\nASSERT(bp->b_transp == tp);\r\nASSERT(bip != NULL);\r\nASSERT(!(bip->bli_flags & XFS_BLI_STALE));\r\nASSERT(!(bip->__bli_format.blf_flags & XFS_BLF_CANCEL));\r\nASSERT(atomic_read(&bip->bli_refcount) > 0);\r\nASSERT(bip->bli_flags & XFS_BLI_HOLD);\r\nbip->bli_flags &= ~XFS_BLI_HOLD;\r\ntrace_xfs_trans_bhold_release(bip);\r\n}\r\nvoid\r\nxfs_trans_log_buf(xfs_trans_t *tp,\r\nxfs_buf_t *bp,\r\nuint first,\r\nuint last)\r\n{\r\nxfs_buf_log_item_t *bip = bp->b_fspriv;\r\nASSERT(bp->b_transp == tp);\r\nASSERT(bip != NULL);\r\nASSERT(first <= last && last < BBTOB(bp->b_length));\r\nASSERT(bp->b_iodone == NULL ||\r\nbp->b_iodone == xfs_buf_iodone_callbacks);\r\nXFS_BUF_DONE(bp);\r\nASSERT(atomic_read(&bip->bli_refcount) > 0);\r\nbp->b_iodone = xfs_buf_iodone_callbacks;\r\nbip->bli_item.li_cb = xfs_buf_iodone;\r\ntrace_xfs_trans_log_buf(bip);\r\nif (bip->bli_flags & XFS_BLI_STALE) {\r\nbip->bli_flags &= ~XFS_BLI_STALE;\r\nASSERT(XFS_BUF_ISSTALE(bp));\r\nXFS_BUF_UNSTALE(bp);\r\nbip->__bli_format.blf_flags &= ~XFS_BLF_CANCEL;\r\n}\r\ntp->t_flags |= XFS_TRANS_DIRTY;\r\nbip->bli_item.li_desc->lid_flags |= XFS_LID_DIRTY;\r\nbip->bli_flags |= XFS_BLI_DIRTY | XFS_BLI_LOGGED;\r\nif (!(bip->bli_flags & XFS_BLI_ORDERED))\r\nxfs_buf_item_log(bip, first, last);\r\n}\r\nvoid\r\nxfs_trans_binval(\r\nxfs_trans_t *tp,\r\nxfs_buf_t *bp)\r\n{\r\nxfs_buf_log_item_t *bip = bp->b_fspriv;\r\nint i;\r\nASSERT(bp->b_transp == tp);\r\nASSERT(bip != NULL);\r\nASSERT(atomic_read(&bip->bli_refcount) > 0);\r\ntrace_xfs_trans_binval(bip);\r\nif (bip->bli_flags & XFS_BLI_STALE) {\r\nASSERT(XFS_BUF_ISSTALE(bp));\r\nASSERT(!(bip->bli_flags & (XFS_BLI_LOGGED | XFS_BLI_DIRTY)));\r\nASSERT(!(bip->__bli_format.blf_flags & XFS_BLF_INODE_BUF));\r\nASSERT(!(bip->__bli_format.blf_flags & XFS_BLFT_MASK));\r\nASSERT(bip->__bli_format.blf_flags & XFS_BLF_CANCEL);\r\nASSERT(bip->bli_item.li_desc->lid_flags & XFS_LID_DIRTY);\r\nASSERT(tp->t_flags & XFS_TRANS_DIRTY);\r\nreturn;\r\n}\r\nxfs_buf_stale(bp);\r\nbip->bli_flags |= XFS_BLI_STALE;\r\nbip->bli_flags &= ~(XFS_BLI_INODE_BUF | XFS_BLI_LOGGED | XFS_BLI_DIRTY);\r\nbip->__bli_format.blf_flags &= ~XFS_BLF_INODE_BUF;\r\nbip->__bli_format.blf_flags |= XFS_BLF_CANCEL;\r\nbip->__bli_format.blf_flags &= ~XFS_BLFT_MASK;\r\nfor (i = 0; i < bip->bli_format_count; i++) {\r\nmemset(bip->bli_formats[i].blf_data_map, 0,\r\n(bip->bli_formats[i].blf_map_size * sizeof(uint)));\r\n}\r\nbip->bli_item.li_desc->lid_flags |= XFS_LID_DIRTY;\r\ntp->t_flags |= XFS_TRANS_DIRTY;\r\n}\r\nvoid\r\nxfs_trans_inode_buf(\r\nxfs_trans_t *tp,\r\nxfs_buf_t *bp)\r\n{\r\nxfs_buf_log_item_t *bip = bp->b_fspriv;\r\nASSERT(bp->b_transp == tp);\r\nASSERT(bip != NULL);\r\nASSERT(atomic_read(&bip->bli_refcount) > 0);\r\nbip->bli_flags |= XFS_BLI_INODE_BUF;\r\nxfs_trans_buf_set_type(tp, bp, XFS_BLFT_DINO_BUF);\r\n}\r\nvoid\r\nxfs_trans_stale_inode_buf(\r\nxfs_trans_t *tp,\r\nxfs_buf_t *bp)\r\n{\r\nxfs_buf_log_item_t *bip = bp->b_fspriv;\r\nASSERT(bp->b_transp == tp);\r\nASSERT(bip != NULL);\r\nASSERT(atomic_read(&bip->bli_refcount) > 0);\r\nbip->bli_flags |= XFS_BLI_STALE_INODE;\r\nbip->bli_item.li_cb = xfs_buf_iodone;\r\nxfs_trans_buf_set_type(tp, bp, XFS_BLFT_DINO_BUF);\r\n}\r\nvoid\r\nxfs_trans_inode_alloc_buf(\r\nxfs_trans_t *tp,\r\nxfs_buf_t *bp)\r\n{\r\nxfs_buf_log_item_t *bip = bp->b_fspriv;\r\nASSERT(bp->b_transp == tp);\r\nASSERT(bip != NULL);\r\nASSERT(atomic_read(&bip->bli_refcount) > 0);\r\nbip->bli_flags |= XFS_BLI_INODE_ALLOC_BUF;\r\nxfs_trans_buf_set_type(tp, bp, XFS_BLFT_DINO_BUF);\r\n}\r\nvoid\r\nxfs_trans_ordered_buf(\r\nstruct xfs_trans *tp,\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_buf_log_item *bip = bp->b_fspriv;\r\nASSERT(bp->b_transp == tp);\r\nASSERT(bip != NULL);\r\nASSERT(atomic_read(&bip->bli_refcount) > 0);\r\nbip->bli_flags |= XFS_BLI_ORDERED;\r\ntrace_xfs_buf_item_ordered(bip);\r\n}\r\nvoid\r\nxfs_trans_buf_set_type(\r\nstruct xfs_trans *tp,\r\nstruct xfs_buf *bp,\r\nenum xfs_blft type)\r\n{\r\nstruct xfs_buf_log_item *bip = bp->b_fspriv;\r\nif (!tp)\r\nreturn;\r\nASSERT(bp->b_transp == tp);\r\nASSERT(bip != NULL);\r\nASSERT(atomic_read(&bip->bli_refcount) > 0);\r\nxfs_blft_to_flags(&bip->__bli_format, type);\r\n}\r\nvoid\r\nxfs_trans_buf_copy_type(\r\nstruct xfs_buf *dst_bp,\r\nstruct xfs_buf *src_bp)\r\n{\r\nstruct xfs_buf_log_item *sbip = src_bp->b_fspriv;\r\nstruct xfs_buf_log_item *dbip = dst_bp->b_fspriv;\r\nenum xfs_blft type;\r\ntype = xfs_blft_from_flags(&sbip->__bli_format);\r\nxfs_blft_to_flags(&dbip->__bli_format, type);\r\n}\r\nvoid\r\nxfs_trans_dquot_buf(\r\nxfs_trans_t *tp,\r\nxfs_buf_t *bp,\r\nuint type)\r\n{\r\nstruct xfs_buf_log_item *bip = bp->b_fspriv;\r\nASSERT(type == XFS_BLF_UDQUOT_BUF ||\r\ntype == XFS_BLF_PDQUOT_BUF ||\r\ntype == XFS_BLF_GDQUOT_BUF);\r\nbip->__bli_format.blf_flags |= type;\r\nswitch (type) {\r\ncase XFS_BLF_UDQUOT_BUF:\r\ntype = XFS_BLFT_UDQUOT_BUF;\r\nbreak;\r\ncase XFS_BLF_PDQUOT_BUF:\r\ntype = XFS_BLFT_PDQUOT_BUF;\r\nbreak;\r\ncase XFS_BLF_GDQUOT_BUF:\r\ntype = XFS_BLFT_GDQUOT_BUF;\r\nbreak;\r\ndefault:\r\ntype = XFS_BLFT_UNKNOWN_BUF;\r\nbreak;\r\n}\r\nxfs_trans_buf_set_type(tp, bp, type);\r\n}

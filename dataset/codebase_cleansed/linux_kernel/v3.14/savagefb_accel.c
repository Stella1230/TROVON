int savagefb_sync(struct fb_info *info)\r\n{\r\nstruct savagefb_par *par = info->par;\r\npar->SavageWaitIdle(par);\r\nreturn 0;\r\n}\r\nvoid savagefb_copyarea(struct fb_info *info, const struct fb_copyarea *region)\r\n{\r\nstruct savagefb_par *par = info->par;\r\nint sx = region->sx, dx = region->dx;\r\nint sy = region->sy, dy = region->dy;\r\nint cmd;\r\nif (!region->width || !region->height)\r\nreturn;\r\npar->bci_ptr = 0;\r\ncmd = BCI_CMD_RECT | BCI_CMD_DEST_GBD | BCI_CMD_SRC_GBD;\r\nBCI_CMD_SET_ROP(cmd, savagefb_rop[0]);\r\nif (dx <= sx) {\r\ncmd |= BCI_CMD_RECT_XP;\r\n} else {\r\nsx += region->width - 1;\r\ndx += region->width - 1;\r\n}\r\nif (dy <= sy) {\r\ncmd |= BCI_CMD_RECT_YP;\r\n} else {\r\nsy += region->height - 1;\r\ndy += region->height - 1;\r\n}\r\npar->SavageWaitFifo(par,4);\r\nBCI_SEND(cmd);\r\nBCI_SEND(BCI_X_Y(sx, sy));\r\nBCI_SEND(BCI_X_Y(dx, dy));\r\nBCI_SEND(BCI_W_H(region->width, region->height));\r\n}\r\nvoid savagefb_fillrect(struct fb_info *info, const struct fb_fillrect *rect)\r\n{\r\nstruct savagefb_par *par = info->par;\r\nint cmd, color;\r\nif (!rect->width || !rect->height)\r\nreturn;\r\nif (info->fix.visual == FB_VISUAL_PSEUDOCOLOR)\r\ncolor = rect->color;\r\nelse\r\ncolor = ((u32 *)info->pseudo_palette)[rect->color];\r\ncmd = BCI_CMD_RECT | BCI_CMD_RECT_XP | BCI_CMD_RECT_YP |\r\nBCI_CMD_DEST_GBD | BCI_CMD_SRC_SOLID |\r\nBCI_CMD_SEND_COLOR;\r\npar->bci_ptr = 0;\r\nBCI_CMD_SET_ROP(cmd, savagefb_rop[rect->rop]);\r\npar->SavageWaitFifo(par,4);\r\nBCI_SEND(cmd);\r\nBCI_SEND(color);\r\nBCI_SEND( BCI_X_Y(rect->dx, rect->dy) );\r\nBCI_SEND( BCI_W_H(rect->width, rect->height) );\r\n}\r\nvoid savagefb_imageblit(struct fb_info *info, const struct fb_image *image)\r\n{\r\nstruct savagefb_par *par = info->par;\r\nint fg, bg, size, i, width;\r\nint cmd;\r\nu32 *src = (u32 *) image->data;\r\nif (!image->width || !image->height)\r\nreturn;\r\nif (image->depth != 1) {\r\ncfb_imageblit(info, image);\r\nreturn;\r\n}\r\nif (info->fix.visual == FB_VISUAL_PSEUDOCOLOR) {\r\nfg = image->fg_color;\r\nbg = image->bg_color;\r\n} else {\r\nfg = ((u32 *)info->pseudo_palette)[image->fg_color];\r\nbg = ((u32 *)info->pseudo_palette)[image->bg_color];\r\n}\r\ncmd = BCI_CMD_RECT | BCI_CMD_RECT_XP | BCI_CMD_RECT_YP |\r\nBCI_CMD_CLIP_LR | BCI_CMD_DEST_GBD | BCI_CMD_SRC_MONO |\r\nBCI_CMD_SEND_COLOR;\r\npar->bci_ptr = 0;\r\nBCI_CMD_SET_ROP(cmd, savagefb_rop[0]);\r\nwidth = (image->width + 31) & ~31;\r\nsize = (width * image->height)/8;\r\nsize >>= 2;\r\npar->SavageWaitFifo(par, size + 5);\r\nBCI_SEND(cmd);\r\nBCI_SEND(BCI_CLIP_LR(image->dx, image->dx + image->width - 1));\r\nBCI_SEND(fg);\r\nBCI_SEND(bg);\r\nBCI_SEND(BCI_X_Y(image->dx, image->dy));\r\nBCI_SEND(BCI_W_H(width, image->height));\r\nfor (i = 0; i < size; i++)\r\nBCI_SEND(src[i]);\r\n}

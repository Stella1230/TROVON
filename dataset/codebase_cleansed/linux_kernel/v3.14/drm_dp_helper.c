static int\r\ni2c_algo_dp_aux_transaction(struct i2c_adapter *adapter, int mode,\r\nuint8_t write_byte, uint8_t *read_byte)\r\n{\r\nstruct i2c_algo_dp_aux_data *algo_data = adapter->algo_data;\r\nint ret;\r\nret = (*algo_data->aux_ch)(adapter, mode,\r\nwrite_byte, read_byte);\r\nreturn ret;\r\n}\r\nstatic int\r\ni2c_algo_dp_aux_address(struct i2c_adapter *adapter, u16 address, bool reading)\r\n{\r\nstruct i2c_algo_dp_aux_data *algo_data = adapter->algo_data;\r\nint mode = MODE_I2C_START;\r\nint ret;\r\nif (reading)\r\nmode |= MODE_I2C_READ;\r\nelse\r\nmode |= MODE_I2C_WRITE;\r\nalgo_data->address = address;\r\nalgo_data->running = true;\r\nret = i2c_algo_dp_aux_transaction(adapter, mode, 0, NULL);\r\nreturn ret;\r\n}\r\nstatic void\r\ni2c_algo_dp_aux_stop(struct i2c_adapter *adapter, bool reading)\r\n{\r\nstruct i2c_algo_dp_aux_data *algo_data = adapter->algo_data;\r\nint mode = MODE_I2C_STOP;\r\nif (reading)\r\nmode |= MODE_I2C_READ;\r\nelse\r\nmode |= MODE_I2C_WRITE;\r\nif (algo_data->running) {\r\n(void) i2c_algo_dp_aux_transaction(adapter, mode, 0, NULL);\r\nalgo_data->running = false;\r\n}\r\n}\r\nstatic int\r\ni2c_algo_dp_aux_put_byte(struct i2c_adapter *adapter, u8 byte)\r\n{\r\nstruct i2c_algo_dp_aux_data *algo_data = adapter->algo_data;\r\nint ret;\r\nif (!algo_data->running)\r\nreturn -EIO;\r\nret = i2c_algo_dp_aux_transaction(adapter, MODE_I2C_WRITE, byte, NULL);\r\nreturn ret;\r\n}\r\nstatic int\r\ni2c_algo_dp_aux_get_byte(struct i2c_adapter *adapter, u8 *byte_ret)\r\n{\r\nstruct i2c_algo_dp_aux_data *algo_data = adapter->algo_data;\r\nint ret;\r\nif (!algo_data->running)\r\nreturn -EIO;\r\nret = i2c_algo_dp_aux_transaction(adapter, MODE_I2C_READ, 0, byte_ret);\r\nreturn ret;\r\n}\r\nstatic int\r\ni2c_algo_dp_aux_xfer(struct i2c_adapter *adapter,\r\nstruct i2c_msg *msgs,\r\nint num)\r\n{\r\nint ret = 0;\r\nbool reading = false;\r\nint m;\r\nint b;\r\nfor (m = 0; m < num; m++) {\r\nu16 len = msgs[m].len;\r\nu8 *buf = msgs[m].buf;\r\nreading = (msgs[m].flags & I2C_M_RD) != 0;\r\nret = i2c_algo_dp_aux_address(adapter, msgs[m].addr, reading);\r\nif (ret < 0)\r\nbreak;\r\nif (reading) {\r\nfor (b = 0; b < len; b++) {\r\nret = i2c_algo_dp_aux_get_byte(adapter, &buf[b]);\r\nif (ret < 0)\r\nbreak;\r\n}\r\n} else {\r\nfor (b = 0; b < len; b++) {\r\nret = i2c_algo_dp_aux_put_byte(adapter, buf[b]);\r\nif (ret < 0)\r\nbreak;\r\n}\r\n}\r\nif (ret < 0)\r\nbreak;\r\n}\r\nif (ret >= 0)\r\nret = num;\r\ni2c_algo_dp_aux_stop(adapter, reading);\r\nDRM_DEBUG_KMS("dp_aux_xfer return %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic u32\r\ni2c_algo_dp_aux_functionality(struct i2c_adapter *adapter)\r\n{\r\nreturn I2C_FUNC_I2C | I2C_FUNC_SMBUS_EMUL |\r\nI2C_FUNC_SMBUS_READ_BLOCK_DATA |\r\nI2C_FUNC_SMBUS_BLOCK_PROC_CALL |\r\nI2C_FUNC_10BIT_ADDR;\r\n}\r\nstatic void\r\ni2c_dp_aux_reset_bus(struct i2c_adapter *adapter)\r\n{\r\n(void) i2c_algo_dp_aux_address(adapter, 0, false);\r\n(void) i2c_algo_dp_aux_stop(adapter, false);\r\n}\r\nstatic int\r\ni2c_dp_aux_prepare_bus(struct i2c_adapter *adapter)\r\n{\r\nadapter->algo = &i2c_dp_aux_algo;\r\nadapter->retries = 3;\r\ni2c_dp_aux_reset_bus(adapter);\r\nreturn 0;\r\n}\r\nint\r\ni2c_dp_aux_add_bus(struct i2c_adapter *adapter)\r\n{\r\nint error;\r\nerror = i2c_dp_aux_prepare_bus(adapter);\r\nif (error)\r\nreturn error;\r\nerror = i2c_add_adapter(adapter);\r\nreturn error;\r\n}\r\nstatic u8 dp_link_status(const u8 link_status[DP_LINK_STATUS_SIZE], int r)\r\n{\r\nreturn link_status[r - DP_LANE0_1_STATUS];\r\n}\r\nstatic u8 dp_get_lane_status(const u8 link_status[DP_LINK_STATUS_SIZE],\r\nint lane)\r\n{\r\nint i = DP_LANE0_1_STATUS + (lane >> 1);\r\nint s = (lane & 1) * 4;\r\nu8 l = dp_link_status(link_status, i);\r\nreturn (l >> s) & 0xf;\r\n}\r\nbool drm_dp_channel_eq_ok(const u8 link_status[DP_LINK_STATUS_SIZE],\r\nint lane_count)\r\n{\r\nu8 lane_align;\r\nu8 lane_status;\r\nint lane;\r\nlane_align = dp_link_status(link_status,\r\nDP_LANE_ALIGN_STATUS_UPDATED);\r\nif ((lane_align & DP_INTERLANE_ALIGN_DONE) == 0)\r\nreturn false;\r\nfor (lane = 0; lane < lane_count; lane++) {\r\nlane_status = dp_get_lane_status(link_status, lane);\r\nif ((lane_status & DP_CHANNEL_EQ_BITS) != DP_CHANNEL_EQ_BITS)\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nbool drm_dp_clock_recovery_ok(const u8 link_status[DP_LINK_STATUS_SIZE],\r\nint lane_count)\r\n{\r\nint lane;\r\nu8 lane_status;\r\nfor (lane = 0; lane < lane_count; lane++) {\r\nlane_status = dp_get_lane_status(link_status, lane);\r\nif ((lane_status & DP_LANE_CR_DONE) == 0)\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nu8 drm_dp_get_adjust_request_voltage(const u8 link_status[DP_LINK_STATUS_SIZE],\r\nint lane)\r\n{\r\nint i = DP_ADJUST_REQUEST_LANE0_1 + (lane >> 1);\r\nint s = ((lane & 1) ?\r\nDP_ADJUST_VOLTAGE_SWING_LANE1_SHIFT :\r\nDP_ADJUST_VOLTAGE_SWING_LANE0_SHIFT);\r\nu8 l = dp_link_status(link_status, i);\r\nreturn ((l >> s) & 0x3) << DP_TRAIN_VOLTAGE_SWING_SHIFT;\r\n}\r\nu8 drm_dp_get_adjust_request_pre_emphasis(const u8 link_status[DP_LINK_STATUS_SIZE],\r\nint lane)\r\n{\r\nint i = DP_ADJUST_REQUEST_LANE0_1 + (lane >> 1);\r\nint s = ((lane & 1) ?\r\nDP_ADJUST_PRE_EMPHASIS_LANE1_SHIFT :\r\nDP_ADJUST_PRE_EMPHASIS_LANE0_SHIFT);\r\nu8 l = dp_link_status(link_status, i);\r\nreturn ((l >> s) & 0x3) << DP_TRAIN_PRE_EMPHASIS_SHIFT;\r\n}\r\nvoid drm_dp_link_train_clock_recovery_delay(const u8 dpcd[DP_RECEIVER_CAP_SIZE]) {\r\nif (dpcd[DP_TRAINING_AUX_RD_INTERVAL] == 0)\r\nudelay(100);\r\nelse\r\nmdelay(dpcd[DP_TRAINING_AUX_RD_INTERVAL] * 4);\r\n}\r\nvoid drm_dp_link_train_channel_eq_delay(const u8 dpcd[DP_RECEIVER_CAP_SIZE]) {\r\nif (dpcd[DP_TRAINING_AUX_RD_INTERVAL] == 0)\r\nudelay(400);\r\nelse\r\nmdelay(dpcd[DP_TRAINING_AUX_RD_INTERVAL] * 4);\r\n}\r\nu8 drm_dp_link_rate_to_bw_code(int link_rate)\r\n{\r\nswitch (link_rate) {\r\ncase 162000:\r\ndefault:\r\nreturn DP_LINK_BW_1_62;\r\ncase 270000:\r\nreturn DP_LINK_BW_2_7;\r\ncase 540000:\r\nreturn DP_LINK_BW_5_4;\r\n}\r\n}\r\nint drm_dp_bw_code_to_link_rate(u8 link_bw)\r\n{\r\nswitch (link_bw) {\r\ncase DP_LINK_BW_1_62:\r\ndefault:\r\nreturn 162000;\r\ncase DP_LINK_BW_2_7:\r\nreturn 270000;\r\ncase DP_LINK_BW_5_4:\r\nreturn 540000;\r\n}\r\n}

static inline int lpcr_rmls(unsigned long rma_size)\r\n{\r\nswitch (rma_size) {\r\ncase 32ul << 20:\r\nif (cpu_has_feature(CPU_FTR_ARCH_206))\r\nreturn 8;\r\nreturn -1;\r\ncase 64ul << 20:\r\nreturn 3;\r\ncase 128ul << 20:\r\nreturn 7;\r\ncase 256ul << 20:\r\nreturn 4;\r\ncase 1ul << 30:\r\nreturn 2;\r\ncase 16ul << 30:\r\nreturn 1;\r\ncase 256ul << 30:\r\nreturn 0;\r\ndefault:\r\nreturn -1;\r\n}\r\n}\r\nstatic int __init early_parse_rma_size(char *p)\r\n{\r\nunsigned long kvm_rma_size;\r\npr_debug("%s(%s)\n", __func__, p);\r\nif (!p)\r\nreturn -EINVAL;\r\nkvm_rma_size = memparse(p, &p);\r\nif (lpcr_rmls(kvm_rma_size) < 0) {\r\npr_err("RMA size of 0x%lx not supported\n", kvm_rma_size);\r\nreturn -EINVAL;\r\n}\r\nkvm_rma_pages = kvm_rma_size >> PAGE_SHIFT;\r\nreturn 0;\r\n}\r\nstruct kvm_rma_info *kvm_alloc_rma()\r\n{\r\nstruct page *page;\r\nstruct kvm_rma_info *ri;\r\nri = kmalloc(sizeof(struct kvm_rma_info), GFP_KERNEL);\r\nif (!ri)\r\nreturn NULL;\r\npage = kvm_alloc_cma(kvm_rma_pages, kvm_rma_pages);\r\nif (!page)\r\ngoto err_out;\r\natomic_set(&ri->use_count, 1);\r\nri->base_pfn = page_to_pfn(page);\r\nreturn ri;\r\nerr_out:\r\nkfree(ri);\r\nreturn NULL;\r\n}\r\nvoid kvm_release_rma(struct kvm_rma_info *ri)\r\n{\r\nif (atomic_dec_and_test(&ri->use_count)) {\r\nkvm_release_cma(pfn_to_page(ri->base_pfn), kvm_rma_pages);\r\nkfree(ri);\r\n}\r\n}\r\nstatic int __init early_parse_kvm_cma_resv(char *p)\r\n{\r\npr_debug("%s(%s)\n", __func__, p);\r\nif (!p)\r\nreturn -EINVAL;\r\nreturn kstrtoul(p, 0, &kvm_cma_resv_ratio);\r\n}\r\nstruct page *kvm_alloc_hpt(unsigned long nr_pages)\r\n{\r\nunsigned long align_pages = HPT_ALIGN_PAGES;\r\nif (!cpu_has_feature(CPU_FTR_ARCH_206))\r\nalign_pages = nr_pages;\r\nreturn kvm_alloc_cma(nr_pages, align_pages);\r\n}\r\nvoid kvm_release_hpt(struct page *page, unsigned long nr_pages)\r\n{\r\nkvm_release_cma(page, nr_pages);\r\n}\r\nvoid __init kvm_cma_reserve(void)\r\n{\r\nunsigned long align_size;\r\nstruct memblock_region *reg;\r\nphys_addr_t selected_size = 0;\r\nfor_each_memblock(memory, reg)\r\nselected_size += memblock_region_memory_end_pfn(reg) -\r\nmemblock_region_memory_base_pfn(reg);\r\nselected_size = (selected_size * kvm_cma_resv_ratio / 100) << PAGE_SHIFT;\r\nif (selected_size) {\r\npr_debug("%s: reserving %ld MiB for global area\n", __func__,\r\n(unsigned long)selected_size / SZ_1M);\r\nif (!cpu_has_feature(CPU_FTR_ARCH_206))\r\nalign_size = __rounddown_pow_of_two(selected_size);\r\nelse\r\nalign_size = HPT_ALIGN_PAGES << PAGE_SHIFT;\r\nalign_size = max(kvm_rma_pages << PAGE_SHIFT, align_size);\r\nkvm_cma_declare_contiguous(selected_size, align_size);\r\n}\r\n}

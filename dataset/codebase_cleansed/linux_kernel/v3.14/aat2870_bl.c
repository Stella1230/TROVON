static inline int aat2870_brightness(struct aat2870_bl_driver_data *aat2870_bl,\r\nint brightness)\r\n{\r\nstruct backlight_device *bd = aat2870_bl->bd;\r\nint val;\r\nval = brightness * (aat2870_bl->max_current - 1);\r\nval /= bd->props.max_brightness;\r\nreturn val;\r\n}\r\nstatic inline int aat2870_bl_enable(struct aat2870_bl_driver_data *aat2870_bl)\r\n{\r\nstruct aat2870_data *aat2870\r\n= dev_get_drvdata(aat2870_bl->pdev->dev.parent);\r\nreturn aat2870->write(aat2870, AAT2870_BL_CH_EN,\r\n(u8)aat2870_bl->channels);\r\n}\r\nstatic inline int aat2870_bl_disable(struct aat2870_bl_driver_data *aat2870_bl)\r\n{\r\nstruct aat2870_data *aat2870\r\n= dev_get_drvdata(aat2870_bl->pdev->dev.parent);\r\nreturn aat2870->write(aat2870, AAT2870_BL_CH_EN, 0x0);\r\n}\r\nstatic int aat2870_bl_get_brightness(struct backlight_device *bd)\r\n{\r\nreturn bd->props.brightness;\r\n}\r\nstatic int aat2870_bl_update_status(struct backlight_device *bd)\r\n{\r\nstruct aat2870_bl_driver_data *aat2870_bl = bl_get_data(bd);\r\nstruct aat2870_data *aat2870 =\r\ndev_get_drvdata(aat2870_bl->pdev->dev.parent);\r\nint brightness = bd->props.brightness;\r\nint ret;\r\nif ((brightness < 0) || (bd->props.max_brightness < brightness)) {\r\ndev_err(&bd->dev, "invalid brightness, %d\n", brightness);\r\nreturn -EINVAL;\r\n}\r\ndev_dbg(&bd->dev, "brightness=%d, power=%d, state=%d\n",\r\nbd->props.brightness, bd->props.power, bd->props.state);\r\nif ((bd->props.power != FB_BLANK_UNBLANK) ||\r\n(bd->props.state & BL_CORE_FBBLANK) ||\r\n(bd->props.state & BL_CORE_SUSPENDED))\r\nbrightness = 0;\r\nret = aat2870->write(aat2870, AAT2870_BLM,\r\n(u8)aat2870_brightness(aat2870_bl, brightness));\r\nif (ret < 0)\r\nreturn ret;\r\nif (brightness == 0) {\r\nret = aat2870_bl_disable(aat2870_bl);\r\nif (ret < 0)\r\nreturn ret;\r\n} else if (aat2870_bl->brightness == 0) {\r\nret = aat2870_bl_enable(aat2870_bl);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\naat2870_bl->brightness = brightness;\r\nreturn 0;\r\n}\r\nstatic int aat2870_bl_check_fb(struct backlight_device *bd, struct fb_info *fi)\r\n{\r\nreturn 1;\r\n}\r\nstatic int aat2870_bl_probe(struct platform_device *pdev)\r\n{\r\nstruct aat2870_bl_platform_data *pdata = dev_get_platdata(&pdev->dev);\r\nstruct aat2870_bl_driver_data *aat2870_bl;\r\nstruct backlight_device *bd;\r\nstruct backlight_properties props;\r\nint ret = 0;\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "No platform data\n");\r\nret = -ENXIO;\r\ngoto out;\r\n}\r\nif (pdev->id != AAT2870_ID_BL) {\r\ndev_err(&pdev->dev, "Invalid device ID, %d\n", pdev->id);\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\naat2870_bl = devm_kzalloc(&pdev->dev,\r\nsizeof(struct aat2870_bl_driver_data),\r\nGFP_KERNEL);\r\nif (!aat2870_bl) {\r\ndev_err(&pdev->dev,\r\n"Failed to allocate memory for aat2870 backlight\n");\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nmemset(&props, 0, sizeof(struct backlight_properties));\r\nprops.type = BACKLIGHT_RAW;\r\nbd = devm_backlight_device_register(&pdev->dev, "aat2870-backlight",\r\n&pdev->dev, aat2870_bl, &aat2870_bl_ops,\r\n&props);\r\nif (IS_ERR(bd)) {\r\ndev_err(&pdev->dev,\r\n"Failed allocate memory for backlight device\n");\r\nret = PTR_ERR(bd);\r\ngoto out;\r\n}\r\naat2870_bl->pdev = pdev;\r\nplatform_set_drvdata(pdev, aat2870_bl);\r\naat2870_bl->bd = bd;\r\nif (pdata->channels > 0)\r\naat2870_bl->channels = pdata->channels;\r\nelse\r\naat2870_bl->channels = AAT2870_BL_CH_ALL;\r\nif (pdata->max_current > 0)\r\naat2870_bl->max_current = pdata->max_current;\r\nelse\r\naat2870_bl->max_current = AAT2870_CURRENT_27_9;\r\nif (pdata->max_brightness > 0)\r\nbd->props.max_brightness = pdata->max_brightness;\r\nelse\r\nbd->props.max_brightness = 255;\r\naat2870_bl->brightness = 0;\r\nbd->props.power = FB_BLANK_UNBLANK;\r\nbd->props.brightness = bd->props.max_brightness;\r\nret = aat2870_bl_update_status(bd);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Failed to initialize\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\nout:\r\nreturn ret;\r\n}\r\nstatic int aat2870_bl_remove(struct platform_device *pdev)\r\n{\r\nstruct aat2870_bl_driver_data *aat2870_bl = platform_get_drvdata(pdev);\r\nstruct backlight_device *bd = aat2870_bl->bd;\r\nbd->props.power = FB_BLANK_POWERDOWN;\r\nbd->props.brightness = 0;\r\nbacklight_update_status(bd);\r\nreturn 0;\r\n}\r\nstatic int __init aat2870_bl_init(void)\r\n{\r\nreturn platform_driver_register(&aat2870_bl_driver);\r\n}\r\nstatic void __exit aat2870_bl_exit(void)\r\n{\r\nplatform_driver_unregister(&aat2870_bl_driver);\r\n}

static void clk_gate_endisable(struct clk_hw *hw, int enable)\r\n{\r\nstruct clk_gate *gate = to_clk_gate(hw);\r\nint set = gate->flags & CLK_GATE_SET_TO_DISABLE ? 1 : 0;\r\nunsigned long flags = 0;\r\nu32 reg;\r\nset ^= enable;\r\nif (gate->lock)\r\nspin_lock_irqsave(gate->lock, flags);\r\nif (gate->flags & CLK_GATE_HIWORD_MASK) {\r\nreg = BIT(gate->bit_idx + 16);\r\nif (set)\r\nreg |= BIT(gate->bit_idx);\r\n} else {\r\nreg = clk_readl(gate->reg);\r\nif (set)\r\nreg |= BIT(gate->bit_idx);\r\nelse\r\nreg &= ~BIT(gate->bit_idx);\r\n}\r\nclk_writel(reg, gate->reg);\r\nif (gate->lock)\r\nspin_unlock_irqrestore(gate->lock, flags);\r\n}\r\nstatic int clk_gate_enable(struct clk_hw *hw)\r\n{\r\nclk_gate_endisable(hw, 1);\r\nreturn 0;\r\n}\r\nstatic void clk_gate_disable(struct clk_hw *hw)\r\n{\r\nclk_gate_endisable(hw, 0);\r\n}\r\nstatic int clk_gate_is_enabled(struct clk_hw *hw)\r\n{\r\nu32 reg;\r\nstruct clk_gate *gate = to_clk_gate(hw);\r\nreg = clk_readl(gate->reg);\r\nif (gate->flags & CLK_GATE_SET_TO_DISABLE)\r\nreg ^= BIT(gate->bit_idx);\r\nreg &= BIT(gate->bit_idx);\r\nreturn reg ? 1 : 0;\r\n}\r\nstruct clk *clk_register_gate(struct device *dev, const char *name,\r\nconst char *parent_name, unsigned long flags,\r\nvoid __iomem *reg, u8 bit_idx,\r\nu8 clk_gate_flags, spinlock_t *lock)\r\n{\r\nstruct clk_gate *gate;\r\nstruct clk *clk;\r\nstruct clk_init_data init;\r\nif (clk_gate_flags & CLK_GATE_HIWORD_MASK) {\r\nif (bit_idx > 16) {\r\npr_err("gate bit exceeds LOWORD field\n");\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\n}\r\ngate = kzalloc(sizeof(struct clk_gate), GFP_KERNEL);\r\nif (!gate) {\r\npr_err("%s: could not allocate gated clk\n", __func__);\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\ninit.name = name;\r\ninit.ops = &clk_gate_ops;\r\ninit.flags = flags | CLK_IS_BASIC;\r\ninit.parent_names = (parent_name ? &parent_name: NULL);\r\ninit.num_parents = (parent_name ? 1 : 0);\r\ngate->reg = reg;\r\ngate->bit_idx = bit_idx;\r\ngate->flags = clk_gate_flags;\r\ngate->lock = lock;\r\ngate->hw.init = &init;\r\nclk = clk_register(dev, &gate->hw);\r\nif (IS_ERR(clk))\r\nkfree(gate);\r\nreturn clk;\r\n}

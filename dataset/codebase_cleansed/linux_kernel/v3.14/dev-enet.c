static __init void bcm63xx_enetdmac_regs_init(void)\r\n{\r\nif (BCMCPU_IS_6345())\r\nbcm63xx_regs_enetdmac = bcm6345_regs_enetdmac;\r\nelse\r\nbcm63xx_regs_enetdmac = bcm6348_regs_enetdmac;\r\n}\r\nstatic __init void bcm63xx_enetdmac_regs_init(void) { }\r\nstatic int __init register_shared(void)\r\n{\r\nint ret, chan_count;\r\nif (shared_device_registered)\r\nreturn 0;\r\nbcm63xx_enetdmac_regs_init();\r\nshared_res[0].start = bcm63xx_regset_address(RSET_ENETDMA);\r\nshared_res[0].end = shared_res[0].start;\r\nif (BCMCPU_IS_6345())\r\nshared_res[0].end += (RSET_6345_ENETDMA_SIZE) - 1;\r\nelse\r\nshared_res[0].end += (RSET_ENETDMA_SIZE) - 1;\r\nif (BCMCPU_IS_6328() || BCMCPU_IS_6362() || BCMCPU_IS_6368())\r\nchan_count = 32;\r\nelse if (BCMCPU_IS_6345())\r\nchan_count = 8;\r\nelse\r\nchan_count = 16;\r\nshared_res[1].start = bcm63xx_regset_address(RSET_ENETDMAC);\r\nshared_res[1].end = shared_res[1].start;\r\nshared_res[1].end += RSET_ENETDMAC_SIZE(chan_count) - 1;\r\nshared_res[2].start = bcm63xx_regset_address(RSET_ENETDMAS);\r\nshared_res[2].end = shared_res[2].start;\r\nshared_res[2].end += RSET_ENETDMAS_SIZE(chan_count) - 1;\r\nret = platform_device_register(&bcm63xx_enet_shared_device);\r\nif (ret)\r\nreturn ret;\r\nshared_device_registered = 1;\r\nreturn 0;\r\n}\r\nint __init bcm63xx_enet_register(int unit,\r\nconst struct bcm63xx_enet_platform_data *pd)\r\n{\r\nstruct platform_device *pdev;\r\nstruct bcm63xx_enet_platform_data *dpd;\r\nint ret;\r\nif (unit > 1)\r\nreturn -ENODEV;\r\nif (unit == 1 && (BCMCPU_IS_6338() || BCMCPU_IS_6345()))\r\nreturn -ENODEV;\r\nret = register_shared();\r\nif (ret)\r\nreturn ret;\r\nif (unit == 0) {\r\nenet0_res[0].start = bcm63xx_regset_address(RSET_ENET0);\r\nenet0_res[0].end = enet0_res[0].start;\r\nenet0_res[0].end += RSET_ENET_SIZE - 1;\r\nenet0_res[1].start = bcm63xx_get_irq_number(IRQ_ENET0);\r\nenet0_res[2].start = bcm63xx_get_irq_number(IRQ_ENET0_RXDMA);\r\nenet0_res[3].start = bcm63xx_get_irq_number(IRQ_ENET0_TXDMA);\r\npdev = &bcm63xx_enet0_device;\r\n} else {\r\nenet1_res[0].start = bcm63xx_regset_address(RSET_ENET1);\r\nenet1_res[0].end = enet1_res[0].start;\r\nenet1_res[0].end += RSET_ENET_SIZE - 1;\r\nenet1_res[1].start = bcm63xx_get_irq_number(IRQ_ENET1);\r\nenet1_res[2].start = bcm63xx_get_irq_number(IRQ_ENET1_RXDMA);\r\nenet1_res[3].start = bcm63xx_get_irq_number(IRQ_ENET1_TXDMA);\r\npdev = &bcm63xx_enet1_device;\r\n}\r\ndpd = pdev->dev.platform_data;\r\nmemcpy(dpd, pd, sizeof(*pd));\r\nif (dpd->use_internal_phy) {\r\nif (unit == 1)\r\nreturn -ENODEV;\r\ndpd->phy_id = 1;\r\ndpd->has_phy_interrupt = 1;\r\ndpd->phy_interrupt = bcm63xx_get_irq_number(IRQ_ENET_PHY);\r\n}\r\ndpd->dma_chan_en_mask = ENETDMAC_CHANCFG_EN_MASK;\r\ndpd->dma_chan_int_mask = ENETDMAC_IR_PKTDONE_MASK;\r\nif (BCMCPU_IS_6345()) {\r\ndpd->dma_chan_en_mask |= ENETDMAC_CHANCFG_CHAINING_MASK;\r\ndpd->dma_chan_en_mask |= ENETDMAC_CHANCFG_WRAP_EN_MASK;\r\ndpd->dma_chan_en_mask |= ENETDMAC_CHANCFG_FLOWC_EN_MASK;\r\ndpd->dma_chan_int_mask |= ENETDMA_IR_BUFDONE_MASK;\r\ndpd->dma_chan_int_mask |= ENETDMA_IR_NOTOWNER_MASK;\r\ndpd->dma_chan_width = ENETDMA_6345_CHAN_WIDTH;\r\ndpd->dma_desc_shift = ENETDMA_6345_DESC_SHIFT;\r\n} else {\r\ndpd->dma_has_sram = true;\r\ndpd->dma_chan_width = ENETDMA_CHAN_WIDTH;\r\n}\r\nret = platform_device_register(pdev);\r\nif (ret)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nint __init\r\nbcm63xx_enetsw_register(const struct bcm63xx_enetsw_platform_data *pd)\r\n{\r\nint ret;\r\nif (!BCMCPU_IS_6328() && !BCMCPU_IS_6362() && !BCMCPU_IS_6368())\r\nreturn -ENODEV;\r\nret = register_shared();\r\nif (ret)\r\nreturn ret;\r\nenetsw_res[0].start = bcm63xx_regset_address(RSET_ENETSW);\r\nenetsw_res[0].end = enetsw_res[0].start;\r\nenetsw_res[0].end += RSET_ENETSW_SIZE - 1;\r\nenetsw_res[1].start = bcm63xx_get_irq_number(IRQ_ENETSW_RXDMA0);\r\nenetsw_res[2].start = bcm63xx_get_irq_number(IRQ_ENETSW_TXDMA0);\r\nif (!enetsw_res[2].start)\r\nenetsw_res[2].start = -1;\r\nmemcpy(bcm63xx_enetsw_device.dev.platform_data, pd, sizeof(*pd));\r\nif (BCMCPU_IS_6328())\r\nenetsw_pd.num_ports = ENETSW_PORTS_6328;\r\nelse if (BCMCPU_IS_6362() || BCMCPU_IS_6368())\r\nenetsw_pd.num_ports = ENETSW_PORTS_6368;\r\nenetsw_pd.dma_has_sram = true;\r\nenetsw_pd.dma_chan_width = ENETDMA_CHAN_WIDTH;\r\nenetsw_pd.dma_chan_en_mask = ENETDMAC_CHANCFG_EN_MASK;\r\nenetsw_pd.dma_chan_int_mask = ENETDMAC_IR_PKTDONE_MASK;\r\nret = platform_device_register(&bcm63xx_enetsw_device);\r\nif (ret)\r\nreturn ret;\r\nreturn 0;\r\n}

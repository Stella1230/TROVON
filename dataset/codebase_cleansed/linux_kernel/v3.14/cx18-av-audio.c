static int set_audclk_freq(struct cx18 *cx, u32 freq)\r\n{\r\nstruct cx18_av_state *state = &cx->av_state;\r\nif (freq != 32000 && freq != 44100 && freq != 48000)\r\nreturn -EINVAL;\r\nif (state->aud_input > CX18_AV_AUDIO_SERIAL2) {\r\nswitch (freq) {\r\ncase 32000:\r\ncx18_av_write4(cx, 0x108, 0x200d040f);\r\ncx18_av_write4(cx, 0x10c, 0x002be2fe);\r\ncx18_av_write4(cx, 0x110, 0x0176740c);\r\ncx18_av_write4(cx, 0x900, 0x0801f77f);\r\ncx18_av_write4(cx, 0x904, 0x0801f77f);\r\ncx18_av_write4(cx, 0x90c, 0x0801f77f);\r\ncx18_av_write(cx, 0x127, 0x60);\r\ncx18_av_write4(cx, 0x12c, 0x11202fff);\r\ncx18_av_write4(cx, 0x128, 0xa00d2ef8);\r\nbreak;\r\ncase 44100:\r\ncx18_av_write4(cx, 0x108, 0x180e040f);\r\ncx18_av_write4(cx, 0x10c, 0x002be2fe);\r\ncx18_av_write4(cx, 0x110, 0x0062a1f2);\r\ncx18_av_write4(cx, 0x900, 0x08016d59);\r\ncx18_av_write4(cx, 0x904, 0x08016d59);\r\ncx18_av_write4(cx, 0x90c, 0x08016d59);\r\ncx18_av_write(cx, 0x127, 0x58);\r\ncx18_av_write4(cx, 0x12c, 0x112092ff);\r\ncx18_av_write4(cx, 0x128, 0xa01d4bf8);\r\nbreak;\r\ncase 48000:\r\ncx18_av_write4(cx, 0x108, 0x160e040f);\r\ncx18_av_write4(cx, 0x10c, 0x002be2fe);\r\ncx18_av_write4(cx, 0x110, 0x005227ad);\r\ncx18_av_write4(cx, 0x900, 0x08014faa);\r\ncx18_av_write4(cx, 0x904, 0x08014faa);\r\ncx18_av_write4(cx, 0x90c, 0x08014faa);\r\ncx18_av_write(cx, 0x127, 0x56);\r\ncx18_av_write4(cx, 0x12c, 0x11205fff);\r\ncx18_av_write4(cx, 0x128, 0xa01193f8);\r\nbreak;\r\n}\r\n} else {\r\nswitch (freq) {\r\ncase 32000:\r\ncx18_av_write4(cx, 0x108, 0x300d040f);\r\ncx18_av_write4(cx, 0x10c, 0x002be2fe);\r\ncx18_av_write4(cx, 0x110, 0x0176740c);\r\ncx18_av_write4(cx, 0x8f8, 0x08010000);\r\ncx18_av_write4(cx, 0x900, 0x08020000);\r\ncx18_av_write4(cx, 0x904, 0x08020000);\r\ncx18_av_write4(cx, 0x90c, 0x08020000);\r\ncx18_av_write(cx, 0x127, 0x70);\r\ncx18_av_write4(cx, 0x12c, 0x11201fff);\r\ncx18_av_write4(cx, 0x128, 0xa00d2ef8);\r\nbreak;\r\ncase 44100:\r\ncx18_av_write4(cx, 0x108, 0x240e040f);\r\ncx18_av_write4(cx, 0x10c, 0x002be2fe);\r\ncx18_av_write4(cx, 0x110, 0x0062a1f2);\r\ncx18_av_write4(cx, 0x8f8, 0x080160cd);\r\ncx18_av_write4(cx, 0x900, 0x08017385);\r\ncx18_av_write4(cx, 0x904, 0x08017385);\r\ncx18_av_write4(cx, 0x90c, 0x08017385);\r\ncx18_av_write(cx, 0x127, 0x64);\r\ncx18_av_write4(cx, 0x12c, 0x112061ff);\r\ncx18_av_write4(cx, 0x128, 0xa01d4bf8);\r\nbreak;\r\ncase 48000:\r\ncx18_av_write4(cx, 0x108, 0x200d040f);\r\ncx18_av_write4(cx, 0x10c, 0x002be2fe);\r\ncx18_av_write4(cx, 0x110, 0x0176740c);\r\ncx18_av_write4(cx, 0x8f8, 0x08018000);\r\ncx18_av_write4(cx, 0x900, 0x08015555);\r\ncx18_av_write4(cx, 0x904, 0x08015555);\r\ncx18_av_write4(cx, 0x90c, 0x08015555);\r\ncx18_av_write(cx, 0x127, 0x60);\r\ncx18_av_write4(cx, 0x12c, 0x11203fff);\r\ncx18_av_write4(cx, 0x128, 0xa01193f8);\r\nbreak;\r\n}\r\n}\r\nstate->audclk_freq = freq;\r\nreturn 0;\r\n}\r\nvoid cx18_av_audio_set_path(struct cx18 *cx)\r\n{\r\nstruct cx18_av_state *state = &cx->av_state;\r\nu8 v;\r\nv = cx18_av_read(cx, 0x803) & ~0x10;\r\ncx18_av_write_expect(cx, 0x803, v, v, 0x1f);\r\nv = cx18_av_read(cx, 0x810) | 0x01;\r\ncx18_av_write_expect(cx, 0x810, v, v, 0x0f);\r\ncx18_av_write(cx, 0x8d3, 0x1f);\r\nif (state->aud_input <= CX18_AV_AUDIO_SERIAL2) {\r\ncx18_av_write4(cx, 0x8d0, 0x01011012);\r\n} else {\r\ncx18_av_write4(cx, 0x8d0, 0x1f063870);\r\n}\r\nset_audclk_freq(cx, state->audclk_freq);\r\nv = cx18_av_read(cx, 0x810) & ~0x01;\r\ncx18_av_write_expect(cx, 0x810, v, v, 0x0f);\r\nif (state->aud_input > CX18_AV_AUDIO_SERIAL2) {\r\nv = cx18_av_read(cx, 0x803) | 0x10;\r\ncx18_av_write_expect(cx, 0x803, v, v, 0x1f);\r\n}\r\n}\r\nstatic void set_volume(struct cx18 *cx, int volume)\r\n{\r\nint vol = volume >> 9;\r\nif (vol <= 23)\r\nvol = 0;\r\nelse\r\nvol -= 23;\r\ncx18_av_write(cx, 0x8d4, 228 - (vol * 2));\r\n}\r\nstatic void set_bass(struct cx18 *cx, int bass)\r\n{\r\ncx18_av_and_or(cx, 0x8d9, ~0x3f, 48 - (bass * 48 / 0xffff));\r\n}\r\nstatic void set_treble(struct cx18 *cx, int treble)\r\n{\r\ncx18_av_and_or(cx, 0x8db, ~0x3f, 48 - (treble * 48 / 0xffff));\r\n}\r\nstatic void set_balance(struct cx18 *cx, int balance)\r\n{\r\nint bal = balance >> 8;\r\nif (bal > 0x80) {\r\ncx18_av_and_or(cx, 0x8d5, 0x7f, 0x80);\r\ncx18_av_and_or(cx, 0x8d5, ~0x7f, bal & 0x7f);\r\n} else {\r\ncx18_av_and_or(cx, 0x8d5, 0x7f, 0x00);\r\ncx18_av_and_or(cx, 0x8d5, ~0x7f, 0x80 - bal);\r\n}\r\n}\r\nstatic void set_mute(struct cx18 *cx, int mute)\r\n{\r\nstruct cx18_av_state *state = &cx->av_state;\r\nu8 v;\r\nif (state->aud_input > CX18_AV_AUDIO_SERIAL2) {\r\nv = cx18_av_read(cx, 0x803);\r\nif (mute) {\r\nv &= ~0x10;\r\ncx18_av_write_expect(cx, 0x803, v, v, 0x1f);\r\ncx18_av_write(cx, 0x8d3, 0x1f);\r\n} else {\r\nv |= 0x10;\r\ncx18_av_write_expect(cx, 0x803, v, v, 0x1f);\r\n}\r\n} else {\r\ncx18_av_and_or(cx, 0x8d3, ~0x2, mute ? 0x02 : 0x00);\r\n}\r\n}\r\nint cx18_av_s_clock_freq(struct v4l2_subdev *sd, u32 freq)\r\n{\r\nstruct cx18 *cx = v4l2_get_subdevdata(sd);\r\nstruct cx18_av_state *state = &cx->av_state;\r\nint retval;\r\nu8 v;\r\nif (state->aud_input > CX18_AV_AUDIO_SERIAL2) {\r\nv = cx18_av_read(cx, 0x803) & ~0x10;\r\ncx18_av_write_expect(cx, 0x803, v, v, 0x1f);\r\ncx18_av_write(cx, 0x8d3, 0x1f);\r\n}\r\nv = cx18_av_read(cx, 0x810) | 0x1;\r\ncx18_av_write_expect(cx, 0x810, v, v, 0x0f);\r\nretval = set_audclk_freq(cx, freq);\r\nv = cx18_av_read(cx, 0x810) & ~0x1;\r\ncx18_av_write_expect(cx, 0x810, v, v, 0x0f);\r\nif (state->aud_input > CX18_AV_AUDIO_SERIAL2) {\r\nv = cx18_av_read(cx, 0x803) | 0x10;\r\ncx18_av_write_expect(cx, 0x803, v, v, 0x1f);\r\n}\r\nreturn retval;\r\n}\r\nstatic int cx18_av_audio_s_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstruct v4l2_subdev *sd = to_sd(ctrl);\r\nstruct cx18 *cx = v4l2_get_subdevdata(sd);\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_AUDIO_VOLUME:\r\nset_volume(cx, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_AUDIO_BASS:\r\nset_bass(cx, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_AUDIO_TREBLE:\r\nset_treble(cx, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_AUDIO_BALANCE:\r\nset_balance(cx, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_AUDIO_MUTE:\r\nset_mute(cx, ctrl->val);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}

static int dsp_get_byte(void __iomem *port, u8 *val)\r\n{\r\nint loops = 1000;\r\nwhile (!(ioread8(port + DSP_PORT_DATA_AVAIL) & 0x80)) {\r\nif (!loops--)\r\nreturn -EIO;\r\ncpu_relax();\r\n}\r\n*val = ioread8(port + DSP_PORT_READ);\r\nreturn 0;\r\n}\r\nstatic int dsp_reset(void __iomem *port)\r\n{\r\nu8 val;\r\niowrite8(1, port + DSP_PORT_RESET);\r\nudelay(10);\r\niowrite8(0, port + DSP_PORT_RESET);\r\nif (dsp_get_byte(port, &val) < 0 || val != DSP_SIGNATURE)\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nstatic int dsp_command(void __iomem *port, u8 cmd)\r\n{\r\nint loops = 1000;\r\nwhile (ioread8(port + DSP_PORT_STATUS) & 0x80) {\r\nif (!loops--)\r\nreturn -EIO;\r\ncpu_relax();\r\n}\r\niowrite8(cmd, port + DSP_PORT_COMMAND);\r\nreturn 0;\r\n}\r\nstatic int dsp_get_version(void __iomem *port, u8 *major, u8 *minor)\r\n{\r\nint err;\r\nerr = dsp_command(port, DSP_COMMAND_GET_VERSION);\r\nif (err < 0)\r\nreturn err;\r\nerr = dsp_get_byte(port, major);\r\nif (err < 0)\r\nreturn err;\r\nerr = dsp_get_byte(port, minor);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int wss_detect(void __iomem *wss_port)\r\n{\r\nif ((ioread8(wss_port + WSS_PORT_SIGNATURE) & 0x3f) != WSS_SIGNATURE)\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nstatic void wss_set_config(void __iomem *wss_port, u8 wss_config)\r\n{\r\niowrite8(wss_config, wss_port + WSS_PORT_CONFIG);\r\n}\r\nstatic int snd_galaxy_match(struct device *dev, unsigned int n)\r\n{\r\nif (!enable[n])\r\nreturn 0;\r\nswitch (port[n]) {\r\ncase SNDRV_AUTO_PORT:\r\ndev_err(dev, "please specify port\n");\r\nreturn 0;\r\ncase 0x220:\r\nconfig[n] |= GALAXY_CONFIG_SBA_220;\r\nbreak;\r\ncase 0x240:\r\nconfig[n] |= GALAXY_CONFIG_SBA_240;\r\nbreak;\r\ncase 0x260:\r\nconfig[n] |= GALAXY_CONFIG_SBA_260;\r\nbreak;\r\ncase 0x280:\r\nconfig[n] |= GALAXY_CONFIG_SBA_280;\r\nbreak;\r\ndefault:\r\ndev_err(dev, "invalid port %#lx\n", port[n]);\r\nreturn 0;\r\n}\r\nswitch (wss_port[n]) {\r\ncase SNDRV_AUTO_PORT:\r\ndev_err(dev, "please specify wss_port\n");\r\nreturn 0;\r\ncase 0x530:\r\nconfig[n] |= GALAXY_CONFIG_WSS_ENABLE | GALAXY_CONFIG_WSSA_530;\r\nbreak;\r\ncase 0x604:\r\nconfig[n] |= GALAXY_CONFIG_WSS_ENABLE | GALAXY_CONFIG_WSSA_604;\r\nbreak;\r\ncase 0xe80:\r\nconfig[n] |= GALAXY_CONFIG_WSS_ENABLE | GALAXY_CONFIG_WSSA_E80;\r\nbreak;\r\ncase 0xf40:\r\nconfig[n] |= GALAXY_CONFIG_WSS_ENABLE | GALAXY_CONFIG_WSSA_F40;\r\nbreak;\r\ndefault:\r\ndev_err(dev, "invalid WSS port %#lx\n", wss_port[n]);\r\nreturn 0;\r\n}\r\nswitch (irq[n]) {\r\ncase SNDRV_AUTO_IRQ:\r\ndev_err(dev, "please specify irq\n");\r\nreturn 0;\r\ncase 7:\r\nwss_config[n] |= WSS_CONFIG_IRQ_7;\r\nbreak;\r\ncase 2:\r\nirq[n] = 9;\r\ncase 9:\r\nwss_config[n] |= WSS_CONFIG_IRQ_9;\r\nbreak;\r\ncase 10:\r\nwss_config[n] |= WSS_CONFIG_IRQ_10;\r\nbreak;\r\ncase 11:\r\nwss_config[n] |= WSS_CONFIG_IRQ_11;\r\nbreak;\r\ndefault:\r\ndev_err(dev, "invalid IRQ %d\n", irq[n]);\r\nreturn 0;\r\n}\r\nswitch (dma1[n]) {\r\ncase SNDRV_AUTO_DMA:\r\ndev_err(dev, "please specify dma1\n");\r\nreturn 0;\r\ncase 0:\r\nwss_config[n] |= WSS_CONFIG_DMA_0;\r\nbreak;\r\ncase 1:\r\nwss_config[n] |= WSS_CONFIG_DMA_1;\r\nbreak;\r\ncase 3:\r\nwss_config[n] |= WSS_CONFIG_DMA_3;\r\nbreak;\r\ndefault:\r\ndev_err(dev, "invalid playback DMA %d\n", dma1[n]);\r\nreturn 0;\r\n}\r\nif (dma2[n] == SNDRV_AUTO_DMA || dma2[n] == dma1[n]) {\r\ndma2[n] = -1;\r\ngoto mpu;\r\n}\r\nwss_config[n] |= WSS_CONFIG_DUPLEX;\r\nswitch (dma2[n]) {\r\ncase 0:\r\nbreak;\r\ncase 1:\r\nif (dma1[n] == 0)\r\nbreak;\r\ndefault:\r\ndev_err(dev, "invalid capture DMA %d\n", dma2[n]);\r\nreturn 0;\r\n}\r\nmpu:\r\nswitch (mpu_port[n]) {\r\ncase SNDRV_AUTO_PORT:\r\ndev_warn(dev, "mpu_port not specified; not using MPU-401\n");\r\nmpu_port[n] = -1;\r\ngoto fm;\r\ncase 0x300:\r\nconfig[n] |= GALAXY_CONFIG_MPU_ENABLE | GALAXY_CONFIG_MPUA_300;\r\nbreak;\r\ncase 0x330:\r\nconfig[n] |= GALAXY_CONFIG_MPU_ENABLE | GALAXY_CONFIG_MPUA_330;\r\nbreak;\r\ndefault:\r\ndev_err(dev, "invalid MPU port %#lx\n", mpu_port[n]);\r\nreturn 0;\r\n}\r\nswitch (mpu_irq[n]) {\r\ncase SNDRV_AUTO_IRQ:\r\ndev_warn(dev, "mpu_irq not specified: using polling mode\n");\r\nmpu_irq[n] = -1;\r\nbreak;\r\ncase 2:\r\nmpu_irq[n] = 9;\r\ncase 9:\r\nconfig[n] |= GALAXY_CONFIG_MPUIRQ_2;\r\nbreak;\r\n#ifdef AZT1605\r\ncase 3:\r\nconfig[n] |= GALAXY_CONFIG_MPUIRQ_3;\r\nbreak;\r\n#endif\r\ncase 5:\r\nconfig[n] |= GALAXY_CONFIG_MPUIRQ_5;\r\nbreak;\r\ncase 7:\r\nconfig[n] |= GALAXY_CONFIG_MPUIRQ_7;\r\nbreak;\r\n#ifdef AZT2316\r\ncase 10:\r\nconfig[n] |= GALAXY_CONFIG_MPUIRQ_10;\r\nbreak;\r\n#endif\r\ndefault:\r\ndev_err(dev, "invalid MPU IRQ %d\n", mpu_irq[n]);\r\nreturn 0;\r\n}\r\nif (mpu_irq[n] == irq[n]) {\r\ndev_err(dev, "cannot share IRQ between WSS and MPU-401\n");\r\nreturn 0;\r\n}\r\nfm:\r\nswitch (fm_port[n]) {\r\ncase SNDRV_AUTO_PORT:\r\ndev_warn(dev, "fm_port not specified: not using OPL3\n");\r\nfm_port[n] = -1;\r\nbreak;\r\ncase 0x388:\r\nbreak;\r\ndefault:\r\ndev_err(dev, "illegal FM port %#lx\n", fm_port[n]);\r\nreturn 0;\r\n}\r\nconfig[n] |= GALAXY_CONFIG_GAME_ENABLE;\r\nreturn 1;\r\n}\r\nstatic int galaxy_init(struct snd_galaxy *galaxy, u8 *type)\r\n{\r\nu8 major;\r\nu8 minor;\r\nint err;\r\nerr = dsp_reset(galaxy->port);\r\nif (err < 0)\r\nreturn err;\r\nerr = dsp_get_version(galaxy->port, &major, &minor);\r\nif (err < 0)\r\nreturn err;\r\nif (major != GALAXY_DSP_MAJOR || minor != GALAXY_DSP_MINOR)\r\nreturn -ENODEV;\r\nerr = dsp_command(galaxy->port, DSP_COMMAND_GALAXY_8);\r\nif (err < 0)\r\nreturn err;\r\nerr = dsp_command(galaxy->port, GALAXY_COMMAND_GET_TYPE);\r\nif (err < 0)\r\nreturn err;\r\nerr = dsp_get_byte(galaxy->port, type);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int galaxy_set_mode(struct snd_galaxy *galaxy, u8 mode)\r\n{\r\nint err;\r\nerr = dsp_command(galaxy->port, DSP_COMMAND_GALAXY_9);\r\nif (err < 0)\r\nreturn err;\r\nerr = dsp_command(galaxy->port, mode);\r\nif (err < 0)\r\nreturn err;\r\n#ifdef AZT1605\r\nerr = dsp_reset(galaxy->port);\r\nif (err < 0)\r\nreturn err;\r\n#endif\r\nreturn 0;\r\n}\r\nstatic void galaxy_set_config(struct snd_galaxy *galaxy, u32 config)\r\n{\r\nu8 tmp = ioread8(galaxy->config_port + CONFIG_PORT_SET);\r\nint i;\r\niowrite8(tmp | 0x80, galaxy->config_port + CONFIG_PORT_SET);\r\nfor (i = 0; i < GALAXY_CONFIG_SIZE; i++) {\r\niowrite8(config, galaxy->config_port + i);\r\nconfig >>= 8;\r\n}\r\niowrite8(tmp & 0x7f, galaxy->config_port + CONFIG_PORT_SET);\r\nmsleep(10);\r\n}\r\nstatic void galaxy_config(struct snd_galaxy *galaxy, u32 config)\r\n{\r\nint i;\r\nfor (i = GALAXY_CONFIG_SIZE; i; i--) {\r\nu8 tmp = ioread8(galaxy->config_port + i - 1);\r\ngalaxy->config = (galaxy->config << 8) | tmp;\r\n}\r\nconfig |= galaxy->config & GALAXY_CONFIG_MASK;\r\ngalaxy_set_config(galaxy, config);\r\n}\r\nstatic int galaxy_wss_config(struct snd_galaxy *galaxy, u8 wss_config)\r\n{\r\nint err;\r\nerr = wss_detect(galaxy->wss_port);\r\nif (err < 0)\r\nreturn err;\r\nwss_set_config(galaxy->wss_port, wss_config);\r\nerr = galaxy_set_mode(galaxy, GALAXY_MODE_WSS);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic void snd_galaxy_free(struct snd_card *card)\r\n{\r\nstruct snd_galaxy *galaxy = card->private_data;\r\nif (galaxy->wss_port) {\r\nwss_set_config(galaxy->wss_port, 0);\r\nioport_unmap(galaxy->wss_port);\r\nrelease_and_free_resource(galaxy->res_wss_port);\r\n}\r\nif (galaxy->config_port) {\r\ngalaxy_set_config(galaxy, galaxy->config);\r\nioport_unmap(galaxy->config_port);\r\nrelease_and_free_resource(galaxy->res_config_port);\r\n}\r\nif (galaxy->port) {\r\nioport_unmap(galaxy->port);\r\nrelease_and_free_resource(galaxy->res_port);\r\n}\r\n}\r\nstatic int snd_galaxy_probe(struct device *dev, unsigned int n)\r\n{\r\nstruct snd_galaxy *galaxy;\r\nstruct snd_wss *chip;\r\nstruct snd_card *card;\r\nu8 type;\r\nint err;\r\nerr = snd_card_create(index[n], id[n], THIS_MODULE, sizeof *galaxy,\r\n&card);\r\nif (err < 0)\r\nreturn err;\r\nsnd_card_set_dev(card, dev);\r\ncard->private_free = snd_galaxy_free;\r\ngalaxy = card->private_data;\r\ngalaxy->res_port = request_region(port[n], 16, DRV_NAME);\r\nif (!galaxy->res_port) {\r\ndev_err(dev, "could not grab ports %#lx-%#lx\n", port[n],\r\nport[n] + 15);\r\nerr = -EBUSY;\r\ngoto error;\r\n}\r\ngalaxy->port = ioport_map(port[n], 16);\r\nerr = galaxy_init(galaxy, &type);\r\nif (err < 0) {\r\ndev_err(dev, "did not find a Sound Galaxy at %#lx\n", port[n]);\r\ngoto error;\r\n}\r\ndev_info(dev, "Sound Galaxy (type %d) found at %#lx\n", type, port[n]);\r\ngalaxy->res_config_port = request_region(port[n] + GALAXY_PORT_CONFIG,\r\n16, DRV_NAME);\r\nif (!galaxy->res_config_port) {\r\ndev_err(dev, "could not grab ports %#lx-%#lx\n",\r\nport[n] + GALAXY_PORT_CONFIG,\r\nport[n] + GALAXY_PORT_CONFIG + 15);\r\nerr = -EBUSY;\r\ngoto error;\r\n}\r\ngalaxy->config_port = ioport_map(port[n] + GALAXY_PORT_CONFIG, 16);\r\ngalaxy_config(galaxy, config[n]);\r\ngalaxy->res_wss_port = request_region(wss_port[n], 4, DRV_NAME);\r\nif (!galaxy->res_wss_port) {\r\ndev_err(dev, "could not grab ports %#lx-%#lx\n", wss_port[n],\r\nwss_port[n] + 3);\r\nerr = -EBUSY;\r\ngoto error;\r\n}\r\ngalaxy->wss_port = ioport_map(wss_port[n], 4);\r\nerr = galaxy_wss_config(galaxy, wss_config[n]);\r\nif (err < 0) {\r\ndev_err(dev, "could not configure WSS\n");\r\ngoto error;\r\n}\r\nstrcpy(card->driver, DRV_NAME);\r\nstrcpy(card->shortname, DRV_NAME);\r\nsprintf(card->longname, "%s at %#lx/%#lx, irq %d, dma %d/%d",\r\ncard->shortname, port[n], wss_port[n], irq[n], dma1[n],\r\ndma2[n]);\r\nerr = snd_wss_create(card, wss_port[n] + 4, -1, irq[n], dma1[n],\r\ndma2[n], WSS_HW_DETECT, 0, &chip);\r\nif (err < 0)\r\ngoto error;\r\nerr = snd_wss_pcm(chip, 0, NULL);\r\nif (err < 0)\r\ngoto error;\r\nerr = snd_wss_mixer(chip);\r\nif (err < 0)\r\ngoto error;\r\nerr = snd_wss_timer(chip, 0, NULL);\r\nif (err < 0)\r\ngoto error;\r\nif (mpu_port[n] >= 0) {\r\nerr = snd_mpu401_uart_new(card, 0, MPU401_HW_MPU401,\r\nmpu_port[n], 0, mpu_irq[n], NULL);\r\nif (err < 0)\r\ngoto error;\r\n}\r\nif (fm_port[n] >= 0) {\r\nstruct snd_opl3 *opl3;\r\nerr = snd_opl3_create(card, fm_port[n], fm_port[n] + 2,\r\nOPL3_HW_AUTO, 0, &opl3);\r\nif (err < 0) {\r\ndev_err(dev, "no OPL device at %#lx\n", fm_port[n]);\r\ngoto error;\r\n}\r\nerr = snd_opl3_timer_new(opl3, 1, 2);\r\nif (err < 0)\r\ngoto error;\r\nerr = snd_opl3_hwdep_new(opl3, 0, 1, NULL);\r\nif (err < 0)\r\ngoto error;\r\n}\r\nerr = snd_card_register(card);\r\nif (err < 0)\r\ngoto error;\r\ndev_set_drvdata(dev, card);\r\nreturn 0;\r\nerror:\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\nstatic int snd_galaxy_remove(struct device *dev, unsigned int n)\r\n{\r\nsnd_card_free(dev_get_drvdata(dev));\r\nreturn 0;\r\n}\r\nstatic int __init alsa_card_galaxy_init(void)\r\n{\r\nreturn isa_register_driver(&snd_galaxy_driver, SNDRV_CARDS);\r\n}\r\nstatic void __exit alsa_card_galaxy_exit(void)\r\n{\r\nisa_unregister_driver(&snd_galaxy_driver);\r\n}

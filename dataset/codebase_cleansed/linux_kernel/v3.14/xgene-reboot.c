static void xgene_restart(char str, const char *cmd)\r\n{\r\nstruct xgene_reboot_context *ctx = xgene_restart_ctx;\r\nunsigned long timeout;\r\nif (ctx)\r\nwritel(ctx->mask, ctx->csr);\r\ntimeout = jiffies + HZ;\r\nwhile (time_before(jiffies, timeout))\r\ncpu_relax();\r\ndev_emerg(&ctx->pdev->dev, "Unable to restart system\n");\r\n}\r\nstatic int xgene_reboot_probe(struct platform_device *pdev)\r\n{\r\nstruct xgene_reboot_context *ctx;\r\nctx = devm_kzalloc(&pdev->dev, sizeof(*ctx), GFP_KERNEL);\r\nif (!ctx) {\r\ndev_err(&pdev->dev, "out of memory for context\n");\r\nreturn -ENODEV;\r\n}\r\nctx->csr = of_iomap(pdev->dev.of_node, 0);\r\nif (!ctx->csr) {\r\ndevm_kfree(&pdev->dev, ctx);\r\ndev_err(&pdev->dev, "can not map resource\n");\r\nreturn -ENODEV;\r\n}\r\nif (of_property_read_u32(pdev->dev.of_node, "mask", &ctx->mask))\r\nctx->mask = 0xFFFFFFFF;\r\nctx->pdev = pdev;\r\narm_pm_restart = xgene_restart;\r\nxgene_restart_ctx = ctx;\r\nreturn 0;\r\n}\r\nstatic int __init xgene_reboot_init(void)\r\n{\r\nreturn platform_driver_register(&xgene_reboot_driver);\r\n}

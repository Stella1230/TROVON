acpi_status\r\nacpi_hw_derive_pci_id(struct acpi_pci_id *pci_id,\r\nacpi_handle root_pci_device, acpi_handle pci_region)\r\n{\r\nacpi_status status;\r\nstruct acpi_pci_device *list_head = NULL;\r\nACPI_FUNCTION_TRACE(hw_derive_pci_id);\r\nif (!pci_id) {\r\nreturn_ACPI_STATUS(AE_BAD_PARAMETER);\r\n}\r\nstatus =\r\nacpi_hw_build_pci_list(root_pci_device, pci_region, &list_head);\r\nif (ACPI_SUCCESS(status)) {\r\nstatus = acpi_hw_process_pci_list(pci_id, list_head);\r\n}\r\nacpi_hw_delete_pci_list(list_head);\r\nreturn_ACPI_STATUS(status);\r\n}\r\nstatic acpi_status\r\nacpi_hw_build_pci_list(acpi_handle root_pci_device,\r\nacpi_handle pci_region,\r\nstruct acpi_pci_device **return_list_head)\r\n{\r\nacpi_handle current_device;\r\nacpi_handle parent_device;\r\nacpi_status status;\r\nstruct acpi_pci_device *list_element;\r\nstruct acpi_pci_device *list_head = NULL;\r\ncurrent_device = pci_region;\r\nwhile (1) {\r\nstatus = acpi_get_parent(current_device, &parent_device);\r\nif (ACPI_FAILURE(status)) {\r\nreturn (status);\r\n}\r\nif (parent_device == root_pci_device) {\r\n*return_list_head = list_head;\r\nreturn (AE_OK);\r\n}\r\nlist_element = ACPI_ALLOCATE(sizeof(struct acpi_pci_device));\r\nif (!list_element) {\r\nreturn (AE_NO_MEMORY);\r\n}\r\nlist_element->next = list_head;\r\nlist_element->device = parent_device;\r\nlist_head = list_element;\r\ncurrent_device = parent_device;\r\n}\r\n}\r\nstatic acpi_status\r\nacpi_hw_process_pci_list(struct acpi_pci_id *pci_id,\r\nstruct acpi_pci_device *list_head)\r\n{\r\nacpi_status status = AE_OK;\r\nstruct acpi_pci_device *info;\r\nu16 bus_number;\r\nu8 is_bridge = TRUE;\r\nACPI_FUNCTION_NAME(hw_process_pci_list);\r\nACPI_DEBUG_PRINT((ACPI_DB_OPREGION,\r\n"Input PciId: Seg %4.4X Bus %4.4X Dev %4.4X Func %4.4X\n",\r\npci_id->segment, pci_id->bus, pci_id->device,\r\npci_id->function));\r\nbus_number = pci_id->bus;\r\ninfo = list_head;\r\nwhile (info) {\r\nstatus = acpi_hw_get_pci_device_info(pci_id, info->device,\r\n&bus_number, &is_bridge);\r\nif (ACPI_FAILURE(status)) {\r\nreturn (status);\r\n}\r\ninfo = info->next;\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_OPREGION,\r\n"Output PciId: Seg %4.4X Bus %4.4X Dev %4.4X Func %4.4X "\r\n"Status %X BusNumber %X IsBridge %X\n",\r\npci_id->segment, pci_id->bus, pci_id->device,\r\npci_id->function, status, bus_number, is_bridge));\r\nreturn (AE_OK);\r\n}\r\nstatic void acpi_hw_delete_pci_list(struct acpi_pci_device *list_head)\r\n{\r\nstruct acpi_pci_device *next;\r\nstruct acpi_pci_device *previous;\r\nnext = list_head;\r\nwhile (next) {\r\nprevious = next;\r\nnext = previous->next;\r\nACPI_FREE(previous);\r\n}\r\n}\r\nstatic acpi_status\r\nacpi_hw_get_pci_device_info(struct acpi_pci_id *pci_id,\r\nacpi_handle pci_device,\r\nu16 *bus_number, u8 *is_bridge)\r\n{\r\nacpi_status status;\r\nacpi_object_type object_type;\r\nu64 return_value;\r\nu64 pci_value;\r\nstatus = acpi_get_type(pci_device, &object_type);\r\nif (ACPI_FAILURE(status)) {\r\nreturn (status);\r\n}\r\nif (object_type != ACPI_TYPE_DEVICE) {\r\nreturn (AE_OK);\r\n}\r\nstatus = acpi_ut_evaluate_numeric_object(METHOD_NAME__ADR,\r\npci_device, &return_value);\r\nif (ACPI_FAILURE(status)) {\r\nreturn (AE_OK);\r\n}\r\npci_id->device = ACPI_HIWORD(ACPI_LODWORD(return_value));\r\npci_id->function = ACPI_LOWORD(ACPI_LODWORD(return_value));\r\nif (*is_bridge) {\r\npci_id->bus = *bus_number;\r\n}\r\n*is_bridge = FALSE;\r\nstatus = acpi_os_read_pci_configuration(pci_id,\r\nPCI_CFG_HEADER_TYPE_REG,\r\n&pci_value, 8);\r\nif (ACPI_FAILURE(status)) {\r\nreturn (status);\r\n}\r\npci_value &= PCI_HEADER_TYPE_MASK;\r\nif ((pci_value != PCI_TYPE_BRIDGE) &&\r\n(pci_value != PCI_TYPE_CARDBUS_BRIDGE)) {\r\nreturn (AE_OK);\r\n}\r\nstatus = acpi_os_read_pci_configuration(pci_id,\r\nPCI_CFG_PRIMARY_BUS_NUMBER_REG,\r\n&pci_value, 8);\r\nif (ACPI_FAILURE(status)) {\r\nreturn (status);\r\n}\r\n*is_bridge = TRUE;\r\npci_id->bus = (u16)pci_value;\r\nstatus = acpi_os_read_pci_configuration(pci_id,\r\nPCI_CFG_SECONDARY_BUS_NUMBER_REG,\r\n&pci_value, 8);\r\nif (ACPI_FAILURE(status)) {\r\nreturn (status);\r\n}\r\n*bus_number = (u16)pci_value;\r\nreturn (AE_OK);\r\n}

static ssize_t manager_name_show(struct omap_overlay_manager *mgr, char *buf)\r\n{\r\nreturn snprintf(buf, PAGE_SIZE, "%s\n", mgr->name);\r\n}\r\nstatic ssize_t manager_display_show(struct omap_overlay_manager *mgr, char *buf)\r\n{\r\nstruct omap_dss_device *dssdev = mgr->get_device(mgr);\r\nreturn snprintf(buf, PAGE_SIZE, "%s\n", dssdev ?\r\ndssdev->name : "<none>");\r\n}\r\nint match(struct omap_dss_device *dssdev, void *data)\r\n{\r\nconst char *str = data;\r\nreturn sysfs_streq(dssdev->name, str);\r\n}\r\nstatic ssize_t manager_default_color_show(struct omap_overlay_manager *mgr,\r\nchar *buf)\r\n{\r\nstruct omap_overlay_manager_info info;\r\nmgr->get_manager_info(mgr, &info);\r\nreturn snprintf(buf, PAGE_SIZE, "%#x\n", info.default_color);\r\n}\r\nstatic ssize_t manager_default_color_store(struct omap_overlay_manager *mgr,\r\nconst char *buf, size_t size)\r\n{\r\nstruct omap_overlay_manager_info info;\r\nu32 color;\r\nint r;\r\nr = kstrtouint(buf, 0, &color);\r\nif (r)\r\nreturn r;\r\nmgr->get_manager_info(mgr, &info);\r\ninfo.default_color = color;\r\nr = mgr->set_manager_info(mgr, &info);\r\nif (r)\r\nreturn r;\r\nr = mgr->apply(mgr);\r\nif (r)\r\nreturn r;\r\nreturn size;\r\n}\r\nstatic ssize_t manager_trans_key_type_show(struct omap_overlay_manager *mgr,\r\nchar *buf)\r\n{\r\nenum omap_dss_trans_key_type key_type;\r\nstruct omap_overlay_manager_info info;\r\nmgr->get_manager_info(mgr, &info);\r\nkey_type = info.trans_key_type;\r\nBUG_ON(key_type >= ARRAY_SIZE(trans_key_type_str));\r\nreturn snprintf(buf, PAGE_SIZE, "%s\n", trans_key_type_str[key_type]);\r\n}\r\nstatic ssize_t manager_trans_key_type_store(struct omap_overlay_manager *mgr,\r\nconst char *buf, size_t size)\r\n{\r\nenum omap_dss_trans_key_type key_type;\r\nstruct omap_overlay_manager_info info;\r\nint r;\r\nfor (key_type = OMAP_DSS_COLOR_KEY_GFX_DST;\r\nkey_type < ARRAY_SIZE(trans_key_type_str); key_type++) {\r\nif (sysfs_streq(buf, trans_key_type_str[key_type]))\r\nbreak;\r\n}\r\nif (key_type == ARRAY_SIZE(trans_key_type_str))\r\nreturn -EINVAL;\r\nmgr->get_manager_info(mgr, &info);\r\ninfo.trans_key_type = key_type;\r\nr = mgr->set_manager_info(mgr, &info);\r\nif (r)\r\nreturn r;\r\nr = mgr->apply(mgr);\r\nif (r)\r\nreturn r;\r\nreturn size;\r\n}\r\nstatic ssize_t manager_trans_key_value_show(struct omap_overlay_manager *mgr,\r\nchar *buf)\r\n{\r\nstruct omap_overlay_manager_info info;\r\nmgr->get_manager_info(mgr, &info);\r\nreturn snprintf(buf, PAGE_SIZE, "%#x\n", info.trans_key);\r\n}\r\nstatic ssize_t manager_trans_key_value_store(struct omap_overlay_manager *mgr,\r\nconst char *buf, size_t size)\r\n{\r\nstruct omap_overlay_manager_info info;\r\nu32 key_value;\r\nint r;\r\nr = kstrtouint(buf, 0, &key_value);\r\nif (r)\r\nreturn r;\r\nmgr->get_manager_info(mgr, &info);\r\ninfo.trans_key = key_value;\r\nr = mgr->set_manager_info(mgr, &info);\r\nif (r)\r\nreturn r;\r\nr = mgr->apply(mgr);\r\nif (r)\r\nreturn r;\r\nreturn size;\r\n}\r\nstatic ssize_t manager_trans_key_enabled_show(struct omap_overlay_manager *mgr,\r\nchar *buf)\r\n{\r\nstruct omap_overlay_manager_info info;\r\nmgr->get_manager_info(mgr, &info);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", info.trans_enabled);\r\n}\r\nstatic ssize_t manager_trans_key_enabled_store(struct omap_overlay_manager *mgr,\r\nconst char *buf, size_t size)\r\n{\r\nstruct omap_overlay_manager_info info;\r\nbool enable;\r\nint r;\r\nr = strtobool(buf, &enable);\r\nif (r)\r\nreturn r;\r\nmgr->get_manager_info(mgr, &info);\r\ninfo.trans_enabled = enable;\r\nr = mgr->set_manager_info(mgr, &info);\r\nif (r)\r\nreturn r;\r\nr = mgr->apply(mgr);\r\nif (r)\r\nreturn r;\r\nreturn size;\r\n}\r\nstatic ssize_t manager_alpha_blending_enabled_show(\r\nstruct omap_overlay_manager *mgr, char *buf)\r\n{\r\nstruct omap_overlay_manager_info info;\r\nif(!dss_has_feature(FEAT_ALPHA_FIXED_ZORDER))\r\nreturn -ENODEV;\r\nmgr->get_manager_info(mgr, &info);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n",\r\ninfo.partial_alpha_enabled);\r\n}\r\nstatic ssize_t manager_alpha_blending_enabled_store(\r\nstruct omap_overlay_manager *mgr,\r\nconst char *buf, size_t size)\r\n{\r\nstruct omap_overlay_manager_info info;\r\nbool enable;\r\nint r;\r\nif(!dss_has_feature(FEAT_ALPHA_FIXED_ZORDER))\r\nreturn -ENODEV;\r\nr = strtobool(buf, &enable);\r\nif (r)\r\nreturn r;\r\nmgr->get_manager_info(mgr, &info);\r\ninfo.partial_alpha_enabled = enable;\r\nr = mgr->set_manager_info(mgr, &info);\r\nif (r)\r\nreturn r;\r\nr = mgr->apply(mgr);\r\nif (r)\r\nreturn r;\r\nreturn size;\r\n}\r\nstatic ssize_t manager_cpr_enable_show(struct omap_overlay_manager *mgr,\r\nchar *buf)\r\n{\r\nstruct omap_overlay_manager_info info;\r\nmgr->get_manager_info(mgr, &info);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", info.cpr_enable);\r\n}\r\nstatic ssize_t manager_cpr_enable_store(struct omap_overlay_manager *mgr,\r\nconst char *buf, size_t size)\r\n{\r\nstruct omap_overlay_manager_info info;\r\nint r;\r\nbool enable;\r\nif (!dss_has_feature(FEAT_CPR))\r\nreturn -ENODEV;\r\nr = strtobool(buf, &enable);\r\nif (r)\r\nreturn r;\r\nmgr->get_manager_info(mgr, &info);\r\nif (info.cpr_enable == enable)\r\nreturn size;\r\ninfo.cpr_enable = enable;\r\nr = mgr->set_manager_info(mgr, &info);\r\nif (r)\r\nreturn r;\r\nr = mgr->apply(mgr);\r\nif (r)\r\nreturn r;\r\nreturn size;\r\n}\r\nstatic ssize_t manager_cpr_coef_show(struct omap_overlay_manager *mgr,\r\nchar *buf)\r\n{\r\nstruct omap_overlay_manager_info info;\r\nmgr->get_manager_info(mgr, &info);\r\nreturn snprintf(buf, PAGE_SIZE,\r\n"%d %d %d %d %d %d %d %d %d\n",\r\ninfo.cpr_coefs.rr,\r\ninfo.cpr_coefs.rg,\r\ninfo.cpr_coefs.rb,\r\ninfo.cpr_coefs.gr,\r\ninfo.cpr_coefs.gg,\r\ninfo.cpr_coefs.gb,\r\ninfo.cpr_coefs.br,\r\ninfo.cpr_coefs.bg,\r\ninfo.cpr_coefs.bb);\r\n}\r\nstatic ssize_t manager_cpr_coef_store(struct omap_overlay_manager *mgr,\r\nconst char *buf, size_t size)\r\n{\r\nstruct omap_overlay_manager_info info;\r\nstruct omap_dss_cpr_coefs coefs;\r\nint r, i;\r\ns16 *arr;\r\nif (!dss_has_feature(FEAT_CPR))\r\nreturn -ENODEV;\r\nif (sscanf(buf, "%hd %hd %hd %hd %hd %hd %hd %hd %hd",\r\n&coefs.rr, &coefs.rg, &coefs.rb,\r\n&coefs.gr, &coefs.gg, &coefs.gb,\r\n&coefs.br, &coefs.bg, &coefs.bb) != 9)\r\nreturn -EINVAL;\r\narr = (s16[]){ coefs.rr, coefs.rg, coefs.rb,\r\ncoefs.gr, coefs.gg, coefs.gb,\r\ncoefs.br, coefs.bg, coefs.bb };\r\nfor (i = 0; i < 9; ++i) {\r\nif (arr[i] < -512 || arr[i] > 511)\r\nreturn -EINVAL;\r\n}\r\nmgr->get_manager_info(mgr, &info);\r\ninfo.cpr_coefs = coefs;\r\nr = mgr->set_manager_info(mgr, &info);\r\nif (r)\r\nreturn r;\r\nr = mgr->apply(mgr);\r\nif (r)\r\nreturn r;\r\nreturn size;\r\n}\r\nstatic ssize_t manager_attr_show(struct kobject *kobj, struct attribute *attr,\r\nchar *buf)\r\n{\r\nstruct omap_overlay_manager *manager;\r\nstruct manager_attribute *manager_attr;\r\nmanager = container_of(kobj, struct omap_overlay_manager, kobj);\r\nmanager_attr = container_of(attr, struct manager_attribute, attr);\r\nif (!manager_attr->show)\r\nreturn -ENOENT;\r\nreturn manager_attr->show(manager, buf);\r\n}\r\nstatic ssize_t manager_attr_store(struct kobject *kobj, struct attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nstruct omap_overlay_manager *manager;\r\nstruct manager_attribute *manager_attr;\r\nmanager = container_of(kobj, struct omap_overlay_manager, kobj);\r\nmanager_attr = container_of(attr, struct manager_attribute, attr);\r\nif (!manager_attr->store)\r\nreturn -ENOENT;\r\nreturn manager_attr->store(manager, buf, size);\r\n}\r\nint dss_manager_kobj_init(struct omap_overlay_manager *mgr,\r\nstruct platform_device *pdev)\r\n{\r\nreturn kobject_init_and_add(&mgr->kobj, &manager_ktype,\r\n&pdev->dev.kobj, "manager%d", mgr->id);\r\n}\r\nvoid dss_manager_kobj_uninit(struct omap_overlay_manager *mgr)\r\n{\r\nkobject_del(&mgr->kobj);\r\nkobject_put(&mgr->kobj);\r\nmemset(&mgr->kobj, 0, sizeof(mgr->kobj));\r\n}

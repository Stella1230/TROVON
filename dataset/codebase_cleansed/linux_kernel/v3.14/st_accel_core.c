static int st_accel_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *ch, int *val,\r\nint *val2, long mask)\r\n{\r\nint err;\r\nstruct st_sensor_data *adata = iio_priv(indio_dev);\r\nswitch (mask) {\r\ncase IIO_CHAN_INFO_RAW:\r\nerr = st_sensors_read_info_raw(indio_dev, ch, val);\r\nif (err < 0)\r\ngoto read_error;\r\nreturn IIO_VAL_INT;\r\ncase IIO_CHAN_INFO_SCALE:\r\n*val = 0;\r\n*val2 = adata->current_fullscale->gain;\r\nreturn IIO_VAL_INT_PLUS_MICRO;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nread_error:\r\nreturn err;\r\n}\r\nstatic int st_accel_write_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan, int val, int val2, long mask)\r\n{\r\nint err;\r\nswitch (mask) {\r\ncase IIO_CHAN_INFO_SCALE:\r\nerr = st_sensors_set_fullscale_by_gain(indio_dev, val2);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn err;\r\n}\r\nint st_accel_common_probe(struct iio_dev *indio_dev,\r\nstruct st_sensors_platform_data *plat_data)\r\n{\r\nstruct st_sensor_data *adata = iio_priv(indio_dev);\r\nint irq = adata->get_irq_data_ready(indio_dev);\r\nint err;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nindio_dev->info = &accel_info;\r\nerr = st_sensors_check_device_support(indio_dev,\r\nARRAY_SIZE(st_accel_sensors), st_accel_sensors);\r\nif (err < 0)\r\nreturn err;\r\nadata->num_data_channels = ST_ACCEL_NUMBER_DATA_CHANNELS;\r\nadata->multiread_bit = adata->sensor->multi_read_bit;\r\nindio_dev->channels = adata->sensor->ch;\r\nindio_dev->num_channels = ST_SENSORS_NUMBER_ALL_CHANNELS;\r\nadata->current_fullscale = (struct st_sensor_fullscale_avl *)\r\n&adata->sensor->fs.fs_avl[0];\r\nadata->odr = adata->sensor->odr.odr_avl[0].hz;\r\nif (!plat_data)\r\nplat_data =\r\n(struct st_sensors_platform_data *)&default_accel_pdata;\r\nerr = st_sensors_init_sensor(indio_dev, plat_data);\r\nif (err < 0)\r\nreturn err;\r\nerr = st_accel_allocate_ring(indio_dev);\r\nif (err < 0)\r\nreturn err;\r\nif (irq > 0) {\r\nerr = st_sensors_allocate_trigger(indio_dev,\r\nST_ACCEL_TRIGGER_OPS);\r\nif (err < 0)\r\ngoto st_accel_probe_trigger_error;\r\n}\r\nerr = iio_device_register(indio_dev);\r\nif (err)\r\ngoto st_accel_device_register_error;\r\nreturn 0;\r\nst_accel_device_register_error:\r\nif (irq > 0)\r\nst_sensors_deallocate_trigger(indio_dev);\r\nst_accel_probe_trigger_error:\r\nst_accel_deallocate_ring(indio_dev);\r\nreturn err;\r\n}\r\nvoid st_accel_common_remove(struct iio_dev *indio_dev)\r\n{\r\nstruct st_sensor_data *adata = iio_priv(indio_dev);\r\niio_device_unregister(indio_dev);\r\nif (adata->get_irq_data_ready(indio_dev) > 0)\r\nst_sensors_deallocate_trigger(indio_dev);\r\nst_accel_deallocate_ring(indio_dev);\r\n}

static int lz4hc_init(struct crypto_tfm *tfm)\r\n{\r\nstruct lz4hc_ctx *ctx = crypto_tfm_ctx(tfm);\r\nctx->lz4hc_comp_mem = vmalloc(LZ4HC_MEM_COMPRESS);\r\nif (!ctx->lz4hc_comp_mem)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nstatic void lz4hc_exit(struct crypto_tfm *tfm)\r\n{\r\nstruct lz4hc_ctx *ctx = crypto_tfm_ctx(tfm);\r\nvfree(ctx->lz4hc_comp_mem);\r\n}\r\nstatic int lz4hc_compress_crypto(struct crypto_tfm *tfm, const u8 *src,\r\nunsigned int slen, u8 *dst, unsigned int *dlen)\r\n{\r\nstruct lz4hc_ctx *ctx = crypto_tfm_ctx(tfm);\r\nsize_t tmp_len = *dlen;\r\nint err;\r\nerr = lz4hc_compress(src, slen, dst, &tmp_len, ctx->lz4hc_comp_mem);\r\nif (err < 0)\r\nreturn -EINVAL;\r\n*dlen = tmp_len;\r\nreturn 0;\r\n}\r\nstatic int lz4hc_decompress_crypto(struct crypto_tfm *tfm, const u8 *src,\r\nunsigned int slen, u8 *dst, unsigned int *dlen)\r\n{\r\nint err;\r\nsize_t tmp_len = *dlen;\r\nsize_t __slen = slen;\r\nerr = lz4_decompress(src, &__slen, dst, tmp_len);\r\nif (err < 0)\r\nreturn -EINVAL;\r\n*dlen = tmp_len;\r\nreturn err;\r\n}\r\nstatic int __init lz4hc_mod_init(void)\r\n{\r\nreturn crypto_register_alg(&alg_lz4hc);\r\n}\r\nstatic void __exit lz4hc_mod_fini(void)\r\n{\r\ncrypto_unregister_alg(&alg_lz4hc);\r\n}

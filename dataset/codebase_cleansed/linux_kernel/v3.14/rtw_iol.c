struct xmit_frame *rtw_IOL_accquire_xmit_frame(struct adapter *adapter)\r\n{\r\nstruct xmit_frame *xmit_frame;\r\nstruct xmit_buf *xmitbuf;\r\nstruct pkt_attrib *pattrib;\r\nstruct xmit_priv *pxmitpriv = &(adapter->xmitpriv);\r\nxmit_frame = rtw_alloc_xmitframe(pxmitpriv);\r\nif (xmit_frame == NULL) {\r\nDBG_88E("%s rtw_alloc_xmitframe return null\n", __func__);\r\ngoto exit;\r\n}\r\nxmitbuf = rtw_alloc_xmitbuf(pxmitpriv);\r\nif (xmitbuf == NULL) {\r\nDBG_88E("%s rtw_alloc_xmitbuf return null\n", __func__);\r\nrtw_free_xmitframe(pxmitpriv, xmit_frame);\r\nxmit_frame = NULL;\r\ngoto exit;\r\n}\r\nxmit_frame->frame_tag = MGNT_FRAMETAG;\r\nxmit_frame->pxmitbuf = xmitbuf;\r\nxmit_frame->buf_addr = xmitbuf->pbuf;\r\nxmitbuf->priv_data = xmit_frame;\r\npattrib = &xmit_frame->attrib;\r\nupdate_mgntframe_attrib(adapter, pattrib);\r\npattrib->qsel = 0x10;\r\npattrib->subtype = WIFI_BEACON;\r\npattrib->pktlen = 0;\r\npattrib->last_txcmdsz = 0;\r\nexit:\r\nreturn xmit_frame;\r\n}\r\nint rtw_IOL_append_cmds(struct xmit_frame *xmit_frame, u8 *IOL_cmds, u32 cmd_len)\r\n{\r\nstruct pkt_attrib *pattrib = &xmit_frame->attrib;\r\nu16 buf_offset;\r\nu32 ori_len;\r\nbuf_offset = TXDESC_OFFSET;\r\nori_len = buf_offset+pattrib->pktlen;\r\nif (ori_len + cmd_len + 8 > MAX_XMITBUF_SZ) {\r\nDBG_88E("%s %u is large than MAX_XMITBUF_SZ:%u, can't accommodate new cmds\n",\r\n__func__ , ori_len + cmd_len + 8, MAX_XMITBUF_SZ);\r\nreturn _FAIL;\r\n}\r\nmemcpy(xmit_frame->buf_addr + buf_offset + pattrib->pktlen, IOL_cmds, cmd_len);\r\npattrib->pktlen += cmd_len;\r\npattrib->last_txcmdsz += cmd_len;\r\nreturn _SUCCESS;\r\n}\r\nbool rtw_IOL_applied(struct adapter *adapter)\r\n{\r\nif (1 == adapter->registrypriv.fw_iol)\r\nreturn true;\r\nif ((2 == adapter->registrypriv.fw_iol) && (!adapter_to_dvobj(adapter)->ishighspeed))\r\nreturn true;\r\nreturn false;\r\n}\r\nint rtw_IOL_exec_cmds_sync(struct adapter *adapter, struct xmit_frame *xmit_frame, u32 max_wating_ms, u32 bndy_cnt)\r\n{\r\nreturn rtw_hal_iol_cmd(adapter, xmit_frame, max_wating_ms, bndy_cnt);\r\n}\r\nint rtw_IOL_append_LLT_cmd(struct xmit_frame *xmit_frame, u8 page_boundary)\r\n{\r\nreturn _SUCCESS;\r\n}\r\nint _rtw_IOL_append_WB_cmd(struct xmit_frame *xmit_frame, u16 addr, u8 value, u8 mask)\r\n{\r\nstruct ioreg_cfg cmd = {8, IOREG_CMD_WB_REG, 0x0, 0x0, 0x0};\r\ncmd.address = cpu_to_le16(addr);\r\ncmd.data = cpu_to_le32(value);\r\nif (mask != 0xFF) {\r\ncmd.length = 12;\r\ncmd.mask = cpu_to_le32(mask);\r\n}\r\nreturn rtw_IOL_append_cmds(xmit_frame, (u8 *)&cmd, cmd.length);\r\n}\r\nint _rtw_IOL_append_WW_cmd(struct xmit_frame *xmit_frame, u16 addr, u16 value, u16 mask)\r\n{\r\nstruct ioreg_cfg cmd = {8, IOREG_CMD_WW_REG, 0x0, 0x0, 0x0};\r\ncmd.address = cpu_to_le16(addr);\r\ncmd.data = cpu_to_le32(value);\r\nif (mask != 0xFFFF) {\r\ncmd.length = 12;\r\ncmd.mask = cpu_to_le32(mask);\r\n}\r\nreturn rtw_IOL_append_cmds(xmit_frame, (u8 *)&cmd, cmd.length);\r\n}\r\nint _rtw_IOL_append_WD_cmd(struct xmit_frame *xmit_frame, u16 addr, u32 value, u32 mask)\r\n{\r\nstruct ioreg_cfg cmd = {8, IOREG_CMD_WD_REG, 0x0, 0x0, 0x0};\r\ncmd.address = cpu_to_le16(addr);\r\ncmd.data = cpu_to_le32(value);\r\nif (mask != 0xFFFFFFFF) {\r\ncmd.length = 12;\r\ncmd.mask = cpu_to_le32(mask);\r\n}\r\nreturn rtw_IOL_append_cmds(xmit_frame, (u8 *)&cmd, cmd.length);\r\n}\r\nint _rtw_IOL_append_WRF_cmd(struct xmit_frame *xmit_frame, u8 rf_path, u16 addr, u32 value, u32 mask)\r\n{\r\nstruct ioreg_cfg cmd = {8, IOREG_CMD_W_RF, 0x0, 0x0, 0x0};\r\ncmd.address = cpu_to_le16((rf_path<<8) | ((addr) & 0xFF));\r\ncmd.data = cpu_to_le32(value);\r\nif (mask != 0x000FFFFF) {\r\ncmd.length = 12;\r\ncmd.mask = cpu_to_le32(mask);\r\n}\r\nreturn rtw_IOL_append_cmds(xmit_frame, (u8 *)&cmd, cmd.length);\r\n}\r\nint rtw_IOL_append_DELAY_US_cmd(struct xmit_frame *xmit_frame, u16 us)\r\n{\r\nstruct ioreg_cfg cmd = {4, IOREG_CMD_DELAY_US, 0x0, 0x0, 0x0};\r\ncmd.address = cpu_to_le16(us);\r\nreturn rtw_IOL_append_cmds(xmit_frame, (u8 *)&cmd, 4);\r\n}\r\nint rtw_IOL_append_DELAY_MS_cmd(struct xmit_frame *xmit_frame, u16 ms)\r\n{\r\nstruct ioreg_cfg cmd = {4, IOREG_CMD_DELAY_US, 0x0, 0x0, 0x0};\r\ncmd.address = cpu_to_le16(ms);\r\nreturn rtw_IOL_append_cmds(xmit_frame, (u8 *)&cmd, 4);\r\n}\r\nint rtw_IOL_append_END_cmd(struct xmit_frame *xmit_frame)\r\n{\r\nstruct ioreg_cfg cmd = {4, IOREG_CMD_END, cpu_to_le16(0xFFFF), cpu_to_le32(0xFF), 0x0};\r\nreturn rtw_IOL_append_cmds(xmit_frame, (u8 *)&cmd, 4);\r\n}\r\nu8 rtw_IOL_cmd_boundary_handle(struct xmit_frame *pxmit_frame)\r\n{\r\nu8 is_cmd_bndy = false;\r\nif (((pxmit_frame->attrib.pktlen+32)%256) + 8 >= 256) {\r\nrtw_IOL_append_END_cmd(pxmit_frame);\r\npxmit_frame->attrib.pktlen = ((((pxmit_frame->attrib.pktlen+32)/256)+1)*256);\r\npxmit_frame->attrib.last_txcmdsz = pxmit_frame->attrib.pktlen;\r\nis_cmd_bndy = true;\r\n}\r\nreturn is_cmd_bndy;\r\n}\r\nvoid rtw_IOL_cmd_buf_dump(struct adapter *Adapter, int buf_len, u8 *pbuf)\r\n{\r\nint i;\r\nint j = 1;\r\npr_info("###### %s ######\n", __func__);\r\nfor (i = 0; i < buf_len; i++) {\r\nprintk("%02x-", *(pbuf+i));\r\nif (j%32 == 0)\r\nprintk("\n");\r\nj++;\r\n}\r\nprintk("\n");\r\npr_info("=============ioreg_cmd len=%d===============\n", buf_len);\r\n}

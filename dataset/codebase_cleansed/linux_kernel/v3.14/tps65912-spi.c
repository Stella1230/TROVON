static int tps65912_spi_write(struct tps65912 *tps65912, u8 addr,\r\nint bytes, void *src)\r\n{\r\nstruct spi_device *spi = tps65912->control_data;\r\nu8 *data = (u8 *) src;\r\nint ret;\r\nunsigned long spi_data = 1 << 23 | addr << 15 | *data;\r\nstruct spi_transfer xfer;\r\nstruct spi_message msg;\r\nu32 tx_buf, rx_buf;\r\ntx_buf = spi_data;\r\nrx_buf = 0;\r\nxfer.tx_buf = &tx_buf;\r\nxfer.rx_buf = NULL;\r\nxfer.len = sizeof(unsigned long);\r\nxfer.bits_per_word = 24;\r\nspi_message_init(&msg);\r\nspi_message_add_tail(&xfer, &msg);\r\nret = spi_sync(spi, &msg);\r\nreturn ret;\r\n}\r\nstatic int tps65912_spi_read(struct tps65912 *tps65912, u8 addr,\r\nint bytes, void *dest)\r\n{\r\nstruct spi_device *spi = tps65912->control_data;\r\nunsigned long spi_data = 0 << 23 | addr << 15;\r\nstruct spi_transfer xfer;\r\nstruct spi_message msg;\r\nint ret;\r\nu8 *data = (u8 *) dest;\r\nu32 tx_buf, rx_buf;\r\ntx_buf = spi_data;\r\nrx_buf = 0;\r\nxfer.tx_buf = &tx_buf;\r\nxfer.rx_buf = &rx_buf;\r\nxfer.len = sizeof(unsigned long);\r\nxfer.bits_per_word = 24;\r\nspi_message_init(&msg);\r\nspi_message_add_tail(&xfer, &msg);\r\nif (spi == NULL)\r\nreturn 0;\r\nret = spi_sync(spi, &msg);\r\nif (ret == 0)\r\n*data = (u8) (rx_buf & 0xFF);\r\nreturn ret;\r\n}\r\nstatic int tps65912_spi_probe(struct spi_device *spi)\r\n{\r\nstruct tps65912 *tps65912;\r\ntps65912 = devm_kzalloc(&spi->dev,\r\nsizeof(struct tps65912), GFP_KERNEL);\r\nif (tps65912 == NULL)\r\nreturn -ENOMEM;\r\ntps65912->dev = &spi->dev;\r\ntps65912->control_data = spi;\r\ntps65912->read = tps65912_spi_read;\r\ntps65912->write = tps65912_spi_write;\r\nspi_set_drvdata(spi, tps65912);\r\nreturn tps65912_device_init(tps65912);\r\n}\r\nstatic int tps65912_spi_remove(struct spi_device *spi)\r\n{\r\nstruct tps65912 *tps65912 = spi_get_drvdata(spi);\r\ntps65912_device_exit(tps65912);\r\nreturn 0;\r\n}\r\nstatic int __init tps65912_spi_init(void)\r\n{\r\nint ret;\r\nret = spi_register_driver(&tps65912_spi_driver);\r\nif (ret != 0)\r\npr_err("Failed to register TPS65912 SPI driver: %d\n", ret);\r\nreturn 0;\r\n}\r\nstatic void __exit tps65912_spi_exit(void)\r\n{\r\nspi_unregister_driver(&tps65912_spi_driver);\r\n}

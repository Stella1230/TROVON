notrace unsigned int debug_smp_processor_id(void)\r\n{\r\nint this_cpu = raw_smp_processor_id();\r\nif (likely(preempt_count()))\r\ngoto out;\r\nif (irqs_disabled())\r\ngoto out;\r\nif (cpumask_equal(tsk_cpus_allowed(current), cpumask_of(this_cpu)))\r\ngoto out;\r\nif (system_state != SYSTEM_RUNNING)\r\ngoto out;\r\npreempt_disable_notrace();\r\nif (!printk_ratelimit())\r\ngoto out_enable;\r\nprintk(KERN_ERR "BUG: using smp_processor_id() in preemptible [%08x] "\r\n"code: %s/%d\n",\r\npreempt_count() - 1, current->comm, current->pid);\r\nprint_symbol("caller is %s\n", (long)__builtin_return_address(0));\r\ndump_stack();\r\nout_enable:\r\npreempt_enable_no_resched_notrace();\r\nout:\r\nreturn this_cpu;\r\n}

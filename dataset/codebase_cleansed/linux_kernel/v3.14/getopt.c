int ncp_getopt(const char *caller, char **options, const struct ncp_option *opts,\r\nchar **optopt, char **optarg, unsigned long *value)\r\n{\r\nchar *token;\r\nchar *val;\r\ndo {\r\nif ((token = strsep(options, ",")) == NULL)\r\nreturn 0;\r\n} while (*token == '\0');\r\nif (optopt)\r\n*optopt = token;\r\nif ((val = strchr (token, '=')) != NULL) {\r\n*val++ = 0;\r\n}\r\n*optarg = val;\r\nfor (; opts->name; opts++) {\r\nif (!strcmp(opts->name, token)) {\r\nif (!val) {\r\nif (opts->has_arg & OPT_NOPARAM) {\r\nreturn opts->val;\r\n}\r\nprintk(KERN_INFO "%s: the %s option requires an argument\n",\r\ncaller, token);\r\nreturn -EINVAL;\r\n}\r\nif (opts->has_arg & OPT_INT) {\r\nchar* v;\r\n*value = simple_strtoul(val, &v, 0);\r\nif (!*v) {\r\nreturn opts->val;\r\n}\r\nprintk(KERN_INFO "%s: invalid numeric value in %s=%s\n",\r\ncaller, token, val);\r\nreturn -EDOM;\r\n}\r\nif (opts->has_arg & OPT_STRING) {\r\nreturn opts->val;\r\n}\r\nprintk(KERN_INFO "%s: unexpected argument %s to the %s option\n",\r\ncaller, val, token);\r\nreturn -EINVAL;\r\n}\r\n}\r\nprintk(KERN_INFO "%s: Unrecognized mount option %s\n", caller, token);\r\nreturn -EOPNOTSUPP;\r\n}

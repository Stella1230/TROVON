int adis_update_scan_mode(struct iio_dev *indio_dev,\r\nconst unsigned long *scan_mask)\r\n{\r\nstruct adis *adis = iio_device_get_drvdata(indio_dev);\r\nconst struct iio_chan_spec *chan;\r\nunsigned int scan_count;\r\nunsigned int i, j;\r\n__be16 *tx, *rx;\r\nkfree(adis->xfer);\r\nkfree(adis->buffer);\r\nscan_count = indio_dev->scan_bytes / 2;\r\nadis->xfer = kcalloc(scan_count + 1, sizeof(*adis->xfer), GFP_KERNEL);\r\nif (!adis->xfer)\r\nreturn -ENOMEM;\r\nadis->buffer = kzalloc(indio_dev->scan_bytes * 2, GFP_KERNEL);\r\nif (!adis->buffer)\r\nreturn -ENOMEM;\r\nrx = adis->buffer;\r\ntx = rx + indio_dev->scan_bytes;\r\nspi_message_init(&adis->msg);\r\nfor (j = 0; j <= scan_count; j++) {\r\nadis->xfer[j].bits_per_word = 8;\r\nif (j != scan_count)\r\nadis->xfer[j].cs_change = 1;\r\nadis->xfer[j].len = 2;\r\nadis->xfer[j].delay_usecs = adis->data->read_delay;\r\nif (j < scan_count)\r\nadis->xfer[j].tx_buf = &tx[j];\r\nif (j >= 1)\r\nadis->xfer[j].rx_buf = &rx[j - 1];\r\nspi_message_add_tail(&adis->xfer[j], &adis->msg);\r\n}\r\nchan = indio_dev->channels;\r\nfor (i = 0; i < indio_dev->num_channels; i++, chan++) {\r\nif (!test_bit(chan->scan_index, scan_mask))\r\ncontinue;\r\nif (chan->scan_type.storagebits == 32)\r\n*tx++ = cpu_to_be16((chan->address + 2) << 8);\r\n*tx++ = cpu_to_be16(chan->address << 8);\r\n}\r\nreturn 0;\r\n}\r\nstatic irqreturn_t adis_trigger_handler(int irq, void *p)\r\n{\r\nstruct iio_poll_func *pf = p;\r\nstruct iio_dev *indio_dev = pf->indio_dev;\r\nstruct adis *adis = iio_device_get_drvdata(indio_dev);\r\nint ret;\r\nif (!adis->buffer)\r\nreturn -ENOMEM;\r\nif (adis->data->has_paging) {\r\nmutex_lock(&adis->txrx_lock);\r\nif (adis->current_page != 0) {\r\nadis->tx[0] = ADIS_WRITE_REG(ADIS_REG_PAGE_ID);\r\nadis->tx[1] = 0;\r\nspi_write(adis->spi, adis->tx, 2);\r\n}\r\n}\r\nret = spi_sync(adis->spi, &adis->msg);\r\nif (ret)\r\ndev_err(&adis->spi->dev, "Failed to read data: %d", ret);\r\nif (adis->data->has_paging) {\r\nadis->current_page = 0;\r\nmutex_unlock(&adis->txrx_lock);\r\n}\r\niio_push_to_buffers_with_timestamp(indio_dev, adis->buffer,\r\npf->timestamp);\r\niio_trigger_notify_done(indio_dev->trig);\r\nreturn IRQ_HANDLED;\r\n}\r\nint adis_setup_buffer_and_trigger(struct adis *adis, struct iio_dev *indio_dev,\r\nirqreturn_t (*trigger_handler)(int, void *))\r\n{\r\nint ret;\r\nif (!trigger_handler)\r\ntrigger_handler = adis_trigger_handler;\r\nret = iio_triggered_buffer_setup(indio_dev, &iio_pollfunc_store_time,\r\ntrigger_handler, NULL);\r\nif (ret)\r\nreturn ret;\r\nif (adis->spi->irq) {\r\nret = adis_probe_trigger(adis, indio_dev);\r\nif (ret)\r\ngoto error_buffer_cleanup;\r\n}\r\nreturn 0;\r\nerror_buffer_cleanup:\r\niio_triggered_buffer_cleanup(indio_dev);\r\nreturn ret;\r\n}\r\nvoid adis_cleanup_buffer_and_trigger(struct adis *adis,\r\nstruct iio_dev *indio_dev)\r\n{\r\nif (adis->spi->irq)\r\nadis_remove_trigger(adis);\r\nkfree(adis->buffer);\r\nkfree(adis->xfer);\r\niio_triggered_buffer_cleanup(indio_dev);\r\n}

static void f300_set_line(struct cx23885_dev *dev, u32 line, u8 lvl)\r\n{\r\ncx23885_gpio_enable(dev, line, 1);\r\nif (lvl == 1)\r\ncx23885_gpio_set(dev, line);\r\nelse\r\ncx23885_gpio_clear(dev, line);\r\n}\r\nstatic u8 f300_get_line(struct cx23885_dev *dev, u32 line)\r\n{\r\ncx23885_gpio_enable(dev, line, 0);\r\nreturn cx23885_gpio_get(dev, line);\r\n}\r\nstatic void f300_send_byte(struct cx23885_dev *dev, u8 dta)\r\n{\r\nu8 i;\r\nfor (i = 0; i < 8; i++) {\r\nf300_set_line(dev, F300_CLK, 0);\r\nudelay(30);\r\nf300_set_line(dev, F300_DATA, (dta & 0x80) >> 7);\r\nudelay(30);\r\ndta <<= 1;\r\nf300_set_line(dev, F300_CLK, 1);\r\nudelay(30);\r\n}\r\n}\r\nstatic u8 f300_get_byte(struct cx23885_dev *dev)\r\n{\r\nu8 i, dta = 0;\r\nfor (i = 0; i < 8; i++) {\r\nf300_set_line(dev, F300_CLK, 0);\r\nudelay(30);\r\ndta <<= 1;\r\nf300_set_line(dev, F300_CLK, 1);\r\nudelay(30);\r\ndta |= f300_get_line(dev, F300_DATA);\r\n}\r\nreturn dta;\r\n}\r\nstatic u8 f300_xfer(struct dvb_frontend *fe, u8 *buf)\r\n{\r\nstruct cx23885_tsport *port = fe->dvb->priv;\r\nstruct cx23885_dev *dev = port->dev;\r\nu8 i, temp, ret = 0;\r\ntemp = buf[0];\r\nfor (i = 0; i < buf[0]; i++)\r\ntemp += buf[i + 1];\r\ntemp = (~temp + 1);\r\nbuf[1 + buf[0]] = temp;\r\nf300_set_line(dev, F300_RESET, 1);\r\nf300_set_line(dev, F300_CLK, 1);\r\nudelay(30);\r\nf300_set_line(dev, F300_DATA, 1);\r\nmsleep(1);\r\nf300_set_line(dev, F300_RESET, 0);\r\nmsleep(1);\r\nf300_send_byte(dev, 0xe0);\r\nmsleep(1);\r\ntemp = buf[0];\r\ntemp += 2;\r\nfor (i = 0; i < temp; i++)\r\nf300_send_byte(dev, buf[i]);\r\nf300_set_line(dev, F300_RESET, 1);\r\nf300_set_line(dev, F300_DATA, 1);\r\ntemp = 0;\r\nfor (i = 0; ((i < 8) & (temp == 0)); i++) {\r\nmsleep(1);\r\nif (f300_get_line(dev, F300_BUSY) == 0)\r\ntemp = 1;\r\n}\r\nif (i > 7) {\r\nprintk(KERN_ERR "%s: timeout, the slave no response\n",\r\n__func__);\r\nret = 1;\r\n} else {\r\nf300_set_line(dev, F300_RESET, 0);\r\nmsleep(1);\r\nf300_send_byte(dev, 0xe1);\r\nmsleep(1);\r\ntemp = f300_get_byte(dev);\r\nif (temp > 14)\r\ntemp = 14;\r\nfor (i = 0; i < (temp + 1); i++)\r\nf300_get_byte(dev);\r\nf300_set_line(dev, F300_RESET, 1);\r\nf300_set_line(dev, F300_DATA, 1);\r\n}\r\nreturn ret;\r\n}\r\nint f300_set_voltage(struct dvb_frontend *fe, fe_sec_voltage_t voltage)\r\n{\r\nu8 buf[16];\r\nbuf[0] = 0x05;\r\nbuf[1] = 0x38;\r\nbuf[2] = 0x01;\r\nswitch (voltage) {\r\ncase SEC_VOLTAGE_13:\r\nbuf[3] = 0x01;\r\nbuf[4] = 0x02;\r\nbuf[5] = 0x00;\r\nbreak;\r\ncase SEC_VOLTAGE_18:\r\nbuf[3] = 0x01;\r\nbuf[4] = 0x02;\r\nbuf[5] = 0x01;\r\nbreak;\r\ncase SEC_VOLTAGE_OFF:\r\nbuf[3] = 0x00;\r\nbuf[4] = 0x00;\r\nbuf[5] = 0x00;\r\nbreak;\r\n}\r\nreturn f300_xfer(fe, buf);\r\n}

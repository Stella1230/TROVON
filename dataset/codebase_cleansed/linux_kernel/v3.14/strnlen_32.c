size_t strnlen(const char *s, size_t count)\r\n{\r\nconst uintptr_t s_int = (uintptr_t) s;\r\nconst uint32_t *p = (const uint32_t *)(s_int & -4);\r\nsize_t bytes_read = sizeof(*p) - (s_int & (sizeof(*p) - 1));\r\nsize_t len;\r\nuint32_t v, bits;\r\nif (count == 0)\r\nreturn 0;\r\nv = *p | ((1 << ((s_int << 3) & 31)) - 1);\r\nwhile ((bits = __insn_seqb(v, 0)) == 0) {\r\nif (bytes_read >= count) {\r\nreturn count;\r\n}\r\nv = *++p;\r\nbytes_read += sizeof(v);\r\n}\r\nlen = ((const char *) p) + (__insn_ctz(bits) >> 3) - s;\r\nreturn (len < count ? len : count);\r\n}

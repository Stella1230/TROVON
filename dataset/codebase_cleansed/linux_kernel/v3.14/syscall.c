static int collect_syscall(struct task_struct *target, long *callno,\r\nunsigned long args[6], unsigned int maxargs,\r\nunsigned long *sp, unsigned long *pc)\r\n{\r\nstruct pt_regs *regs = task_pt_regs(target);\r\nif (unlikely(!regs))\r\nreturn -EAGAIN;\r\n*sp = user_stack_pointer(regs);\r\n*pc = instruction_pointer(regs);\r\n*callno = syscall_get_nr(target, regs);\r\nif (*callno != -1L && maxargs > 0)\r\nsyscall_get_arguments(target, regs, 0, maxargs, args);\r\nreturn 0;\r\n}\r\nint task_current_syscall(struct task_struct *target, long *callno,\r\nunsigned long args[6], unsigned int maxargs,\r\nunsigned long *sp, unsigned long *pc)\r\n{\r\nlong state;\r\nunsigned long ncsw;\r\nif (unlikely(maxargs > 6))\r\nreturn -EINVAL;\r\nif (target == current)\r\nreturn collect_syscall(target, callno, args, maxargs, sp, pc);\r\nstate = target->state;\r\nif (unlikely(!state))\r\nreturn -EAGAIN;\r\nncsw = wait_task_inactive(target, state);\r\nif (unlikely(!ncsw) ||\r\nunlikely(collect_syscall(target, callno, args, maxargs, sp, pc)) ||\r\nunlikely(wait_task_inactive(target, state) != ncsw))\r\nreturn -EAGAIN;\r\nreturn 0;\r\n}

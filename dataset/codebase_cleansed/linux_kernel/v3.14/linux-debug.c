void libcfs_run_debug_log_upcall(char *file)\r\n{\r\nchar *argv[3];\r\nint rc;\r\nchar *envp[] = {\r\n"HOME=/",\r\n"PATH=/sbin:/bin:/usr/sbin:/usr/bin",\r\nNULL};\r\nargv[0] = lnet_debug_log_upcall;\r\nLASSERTF(file != NULL, "called on a null filename\n");\r\nargv[1] = file;\r\nargv[2] = NULL;\r\nrc = USERMODEHELPER(argv[0], argv, envp);\r\nif (rc < 0 && rc != -ENOENT) {\r\nCERROR("Error %d invoking LNET debug log upcall %s %s; "\r\n"check /proc/sys/lnet/debug_log_upcall\n",\r\nrc, argv[0], argv[1]);\r\n} else {\r\nCDEBUG(D_HA, "Invoked LNET debug log upcall %s %s\n",\r\nargv[0], argv[1]);\r\n}\r\n}\r\nvoid libcfs_run_upcall(char **argv)\r\n{\r\nint rc;\r\nint argc;\r\nchar *envp[] = {\r\n"HOME=/",\r\n"PATH=/sbin:/bin:/usr/sbin:/usr/bin",\r\nNULL};\r\nargv[0] = lnet_upcall;\r\nargc = 1;\r\nwhile (argv[argc] != NULL)\r\nargc++;\r\nLASSERT(argc >= 2);\r\nrc = USERMODEHELPER(argv[0], argv, envp);\r\nif (rc < 0 && rc != -ENOENT) {\r\nCERROR("Error %d invoking LNET upcall %s %s%s%s%s%s%s%s%s; "\r\n"check /proc/sys/lnet/upcall\n",\r\nrc, argv[0], argv[1],\r\nargc < 3 ? "" : ",", argc < 3 ? "" : argv[2],\r\nargc < 4 ? "" : ",", argc < 4 ? "" : argv[3],\r\nargc < 5 ? "" : ",", argc < 5 ? "" : argv[4],\r\nargc < 6 ? "" : ",...");\r\n} else {\r\nCDEBUG(D_HA, "Invoked LNET upcall %s %s%s%s%s%s%s%s%s\n",\r\nargv[0], argv[1],\r\nargc < 3 ? "" : ",", argc < 3 ? "" : argv[2],\r\nargc < 4 ? "" : ",", argc < 4 ? "" : argv[3],\r\nargc < 5 ? "" : ",", argc < 5 ? "" : argv[4],\r\nargc < 6 ? "" : ",...");\r\n}\r\n}\r\nvoid libcfs_run_lbug_upcall(struct libcfs_debug_msg_data *msgdata)\r\n{\r\nchar *argv[6];\r\nchar buf[32];\r\nsnprintf(buf, sizeof(buf), "%d", msgdata->msg_line);\r\nargv[1] = "LBUG";\r\nargv[2] = (char *)msgdata->msg_file;\r\nargv[3] = (char *)msgdata->msg_fn;\r\nargv[4] = buf;\r\nargv[5] = NULL;\r\nlibcfs_run_upcall (argv);\r\n}\r\nvoid lbug_with_loc(struct libcfs_debug_msg_data *msgdata)\r\n{\r\nlibcfs_catastrophe = 1;\r\nlibcfs_debug_msg(msgdata, "LBUG\n");\r\nif (in_interrupt()) {\r\npanic("LBUG in interrupt.\n");\r\n}\r\ndump_stack();\r\nif (!libcfs_panic_on_lbug)\r\nlibcfs_debug_dumplog();\r\nlibcfs_run_lbug_upcall(msgdata);\r\nif (libcfs_panic_on_lbug)\r\npanic("LBUG");\r\nset_task_state(current, TASK_UNINTERRUPTIBLE);\r\nwhile (1)\r\nschedule();\r\n}\r\nstatic int panic_notifier(struct notifier_block *self, unsigned long unused1,\r\nvoid *unused2)\r\n{\r\nif (libcfs_panic_in_progress)\r\nreturn 0;\r\nlibcfs_panic_in_progress = 1;\r\nmb();\r\nreturn 0;\r\n}\r\nvoid libcfs_register_panic_notifier(void)\r\n{\r\natomic_notifier_chain_register(&panic_notifier_list, &libcfs_panic_notifier);\r\n}\r\nvoid libcfs_unregister_panic_notifier(void)\r\n{\r\natomic_notifier_chain_unregister(&panic_notifier_list, &libcfs_panic_notifier);\r\n}

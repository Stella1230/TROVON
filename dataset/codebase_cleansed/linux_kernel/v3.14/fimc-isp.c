const struct fimc_fmt *fimc_isp_find_format(const u32 *pixelformat,\r\nconst u32 *mbus_code, int index)\r\n{\r\nconst struct fimc_fmt *fmt, *def_fmt = NULL;\r\nunsigned int i;\r\nint id = 0;\r\nif (index >= (int)ARRAY_SIZE(fimc_isp_formats))\r\nreturn NULL;\r\nfor (i = 0; i < ARRAY_SIZE(fimc_isp_formats); ++i) {\r\nfmt = &fimc_isp_formats[i];\r\nif (pixelformat && fmt->fourcc == *pixelformat)\r\nreturn fmt;\r\nif (mbus_code && fmt->mbus_code == *mbus_code)\r\nreturn fmt;\r\nif (index == id)\r\ndef_fmt = fmt;\r\nid++;\r\n}\r\nreturn def_fmt;\r\n}\r\nvoid fimc_isp_irq_handler(struct fimc_is *is)\r\n{\r\nis->i2h_cmd.args[0] = mcuctl_read(is, MCUCTL_REG_ISSR(20));\r\nis->i2h_cmd.args[1] = mcuctl_read(is, MCUCTL_REG_ISSR(21));\r\nfimc_is_fw_clear_irq1(is, FIMC_IS_INT_FRAME_DONE_ISP);\r\nwake_up(&is->irq_queue);\r\n}\r\nstatic int fimc_is_link_setup(struct media_entity *entity,\r\nconst struct media_pad *local,\r\nconst struct media_pad *remote, u32 flags)\r\n{\r\nreturn 0;\r\n}\r\nstatic int fimc_is_subdev_enum_mbus_code(struct v4l2_subdev *sd,\r\nstruct v4l2_subdev_fh *fh,\r\nstruct v4l2_subdev_mbus_code_enum *code)\r\n{\r\nconst struct fimc_fmt *fmt;\r\nfmt = fimc_isp_find_format(NULL, NULL, code->index);\r\nif (!fmt)\r\nreturn -EINVAL;\r\ncode->code = fmt->mbus_code;\r\nreturn 0;\r\n}\r\nstatic int fimc_isp_subdev_get_fmt(struct v4l2_subdev *sd,\r\nstruct v4l2_subdev_fh *fh,\r\nstruct v4l2_subdev_format *fmt)\r\n{\r\nstruct fimc_isp *isp = v4l2_get_subdevdata(sd);\r\nstruct v4l2_mbus_framefmt *mf = &fmt->format;\r\nif (fmt->which == V4L2_SUBDEV_FORMAT_TRY) {\r\n*mf = *v4l2_subdev_get_try_format(fh, fmt->pad);\r\nreturn 0;\r\n}\r\nmf->colorspace = V4L2_COLORSPACE_SRGB;\r\nmutex_lock(&isp->subdev_lock);\r\nif (fmt->pad == FIMC_ISP_SD_PAD_SINK) {\r\n*mf = isp->sink_fmt;\r\n} else {\r\n*mf = isp->src_fmt;\r\nif (fmt->pad == FIMC_ISP_SD_PAD_SRC_FIFO) {\r\nmf->colorspace = V4L2_COLORSPACE_JPEG;\r\nmf->code = V4L2_MBUS_FMT_YUV10_1X30;\r\n}\r\n}\r\nmutex_unlock(&isp->subdev_lock);\r\nisp_dbg(1, sd, "%s: pad%d: fmt: 0x%x, %dx%d\n", __func__,\r\nfmt->pad, mf->code, mf->width, mf->height);\r\nreturn 0;\r\n}\r\nstatic void __isp_subdev_try_format(struct fimc_isp *isp,\r\nstruct v4l2_subdev_fh *fh,\r\nstruct v4l2_subdev_format *fmt)\r\n{\r\nstruct v4l2_mbus_framefmt *mf = &fmt->format;\r\nstruct v4l2_mbus_framefmt *format;\r\nmf->colorspace = V4L2_COLORSPACE_SRGB;\r\nif (fmt->pad == FIMC_ISP_SD_PAD_SINK) {\r\nv4l_bound_align_image(&mf->width, FIMC_ISP_SINK_WIDTH_MIN,\r\nFIMC_ISP_SINK_WIDTH_MAX, 0,\r\n&mf->height, FIMC_ISP_SINK_HEIGHT_MIN,\r\nFIMC_ISP_SINK_HEIGHT_MAX, 0, 0);\r\nmf->code = V4L2_MBUS_FMT_SGRBG10_1X10;\r\n} else {\r\nif (fmt->which == V4L2_SUBDEV_FORMAT_TRY)\r\nformat = v4l2_subdev_get_try_format(fh,\r\nFIMC_ISP_SD_PAD_SINK);\r\nelse\r\nformat = &isp->sink_fmt;\r\nmf->width = format->width - FIMC_ISP_CAC_MARGIN_WIDTH;\r\nmf->height = format->height - FIMC_ISP_CAC_MARGIN_HEIGHT;\r\nif (fmt->pad == FIMC_ISP_SD_PAD_SRC_FIFO) {\r\nmf->code = V4L2_MBUS_FMT_YUV10_1X30;\r\nmf->colorspace = V4L2_COLORSPACE_JPEG;\r\n} else {\r\nmf->code = format->code;\r\n}\r\n}\r\n}\r\nstatic int fimc_isp_subdev_set_fmt(struct v4l2_subdev *sd,\r\nstruct v4l2_subdev_fh *fh,\r\nstruct v4l2_subdev_format *fmt)\r\n{\r\nstruct fimc_isp *isp = v4l2_get_subdevdata(sd);\r\nstruct fimc_is *is = fimc_isp_to_is(isp);\r\nstruct v4l2_mbus_framefmt *mf = &fmt->format;\r\nint ret = 0;\r\nisp_dbg(1, sd, "%s: pad%d: code: 0x%x, %dx%d\n",\r\n__func__, fmt->pad, mf->code, mf->width, mf->height);\r\nmutex_lock(&isp->subdev_lock);\r\n__isp_subdev_try_format(isp, fh, fmt);\r\nif (fmt->which == V4L2_SUBDEV_FORMAT_TRY) {\r\nmf = v4l2_subdev_get_try_format(fh, fmt->pad);\r\n*mf = fmt->format;\r\nif (fmt->pad == FIMC_ISP_SD_PAD_SINK) {\r\nstruct v4l2_subdev_format format = *fmt;\r\nunsigned int pad;\r\nfor (pad = FIMC_ISP_SD_PAD_SRC_FIFO;\r\npad < FIMC_ISP_SD_PADS_NUM; pad++) {\r\nformat.pad = pad;\r\n__isp_subdev_try_format(isp, fh, &format);\r\nmf = v4l2_subdev_get_try_format(fh, pad);\r\n*mf = format.format;\r\n}\r\n}\r\n} else {\r\nif (sd->entity.stream_count == 0) {\r\nif (fmt->pad == FIMC_ISP_SD_PAD_SINK) {\r\nstruct v4l2_subdev_format format = *fmt;\r\nisp->sink_fmt = *mf;\r\nformat.pad = FIMC_ISP_SD_PAD_SRC_DMA;\r\n__isp_subdev_try_format(isp, fh, &format);\r\nisp->src_fmt = format.format;\r\n__is_set_frame_size(is, &isp->src_fmt);\r\n} else {\r\nisp->src_fmt = *mf;\r\n}\r\n} else {\r\nret = -EBUSY;\r\n}\r\n}\r\nmutex_unlock(&isp->subdev_lock);\r\nreturn ret;\r\n}\r\nstatic int fimc_isp_subdev_s_stream(struct v4l2_subdev *sd, int on)\r\n{\r\nstruct fimc_isp *isp = v4l2_get_subdevdata(sd);\r\nstruct fimc_is *is = fimc_isp_to_is(isp);\r\nint ret;\r\nisp_dbg(1, sd, "%s: on: %d\n", __func__, on);\r\nif (!test_bit(IS_ST_INIT_DONE, &is->state))\r\nreturn -EBUSY;\r\nfimc_is_mem_barrier();\r\nif (on) {\r\nif (__get_pending_param_count(is)) {\r\nret = fimc_is_itf_s_param(is, true);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nisp_dbg(1, sd, "changing mode to %d\n", is->config_index);\r\nret = fimc_is_itf_mode_change(is);\r\nif (ret)\r\nreturn -EINVAL;\r\nclear_bit(IS_ST_STREAM_ON, &is->state);\r\nfimc_is_hw_stream_on(is);\r\nret = fimc_is_wait_event(is, IS_ST_STREAM_ON, 1,\r\nFIMC_IS_CONFIG_TIMEOUT);\r\nif (ret < 0) {\r\nv4l2_err(sd, "stream on timeout\n");\r\nreturn ret;\r\n}\r\n} else {\r\nclear_bit(IS_ST_STREAM_OFF, &is->state);\r\nfimc_is_hw_stream_off(is);\r\nret = fimc_is_wait_event(is, IS_ST_STREAM_OFF, 1,\r\nFIMC_IS_CONFIG_TIMEOUT);\r\nif (ret < 0) {\r\nv4l2_err(sd, "stream off timeout\n");\r\nreturn ret;\r\n}\r\nis->setfile.sub_index = 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int fimc_isp_subdev_s_power(struct v4l2_subdev *sd, int on)\r\n{\r\nstruct fimc_isp *isp = v4l2_get_subdevdata(sd);\r\nstruct fimc_is *is = fimc_isp_to_is(isp);\r\nint ret = 0;\r\npr_debug("on: %d\n", on);\r\nif (on) {\r\nret = pm_runtime_get_sync(&is->pdev->dev);\r\nif (ret < 0)\r\nreturn ret;\r\nset_bit(IS_ST_PWR_ON, &is->state);\r\nret = fimc_is_start_firmware(is);\r\nif (ret < 0) {\r\nv4l2_err(sd, "firmware booting failed\n");\r\npm_runtime_put(&is->pdev->dev);\r\nreturn ret;\r\n}\r\nset_bit(IS_ST_PWR_SUBIP_ON, &is->state);\r\nret = fimc_is_hw_initialize(is);\r\n} else {\r\nif (!test_bit(IS_ST_PWR_ON, &is->state)) {\r\nfimc_is_hw_close_sensor(is, 0);\r\nret = fimc_is_wait_event(is, IS_ST_OPEN_SENSOR, 0,\r\nFIMC_IS_CONFIG_TIMEOUT);\r\nif (ret < 0) {\r\nv4l2_err(sd, "sensor close timeout\n");\r\nreturn ret;\r\n}\r\n}\r\nif (test_bit(IS_ST_PWR_SUBIP_ON, &is->state)) {\r\nfimc_is_hw_subip_power_off(is);\r\nret = fimc_is_wait_event(is, IS_ST_PWR_SUBIP_ON, 0,\r\nFIMC_IS_CONFIG_TIMEOUT);\r\nif (ret < 0) {\r\nv4l2_err(sd, "sub-IP power off timeout\n");\r\nreturn ret;\r\n}\r\n}\r\nfimc_is_cpu_set_power(is, 0);\r\npm_runtime_put_sync(&is->pdev->dev);\r\nclear_bit(IS_ST_PWR_ON, &is->state);\r\nclear_bit(IS_ST_INIT_DONE, &is->state);\r\nis->state = 0;\r\nis->config[is->config_index].p_region_index[0] = 0;\r\nis->config[is->config_index].p_region_index[1] = 0;\r\nset_bit(IS_ST_IDLE, &is->state);\r\nwmb();\r\n}\r\nreturn ret;\r\n}\r\nstatic int fimc_isp_subdev_open(struct v4l2_subdev *sd,\r\nstruct v4l2_subdev_fh *fh)\r\n{\r\nstruct v4l2_mbus_framefmt fmt;\r\nstruct v4l2_mbus_framefmt *format;\r\nformat = v4l2_subdev_get_try_format(fh, FIMC_ISP_SD_PAD_SINK);\r\nfmt.colorspace = V4L2_COLORSPACE_SRGB;\r\nfmt.code = fimc_isp_formats[0].mbus_code;\r\nfmt.width = DEFAULT_PREVIEW_STILL_WIDTH + FIMC_ISP_CAC_MARGIN_WIDTH;\r\nfmt.height = DEFAULT_PREVIEW_STILL_HEIGHT + FIMC_ISP_CAC_MARGIN_HEIGHT;\r\nfmt.field = V4L2_FIELD_NONE;\r\n*format = fmt;\r\nformat = v4l2_subdev_get_try_format(fh, FIMC_ISP_SD_PAD_SRC_FIFO);\r\nfmt.width = DEFAULT_PREVIEW_STILL_WIDTH;\r\nfmt.height = DEFAULT_PREVIEW_STILL_HEIGHT;\r\n*format = fmt;\r\nformat = v4l2_subdev_get_try_format(fh, FIMC_ISP_SD_PAD_SRC_DMA);\r\n*format = fmt;\r\nreturn 0;\r\n}\r\nstatic int __ctrl_set_white_balance(struct fimc_is *is, int value)\r\n{\r\nswitch (value) {\r\ncase V4L2_WHITE_BALANCE_AUTO:\r\n__is_set_isp_awb(is, ISP_AWB_COMMAND_AUTO, 0);\r\nbreak;\r\ncase V4L2_WHITE_BALANCE_DAYLIGHT:\r\n__is_set_isp_awb(is, ISP_AWB_COMMAND_ILLUMINATION,\r\nISP_AWB_ILLUMINATION_DAYLIGHT);\r\nbreak;\r\ncase V4L2_WHITE_BALANCE_CLOUDY:\r\n__is_set_isp_awb(is, ISP_AWB_COMMAND_ILLUMINATION,\r\nISP_AWB_ILLUMINATION_CLOUDY);\r\nbreak;\r\ncase V4L2_WHITE_BALANCE_INCANDESCENT:\r\n__is_set_isp_awb(is, ISP_AWB_COMMAND_ILLUMINATION,\r\nISP_AWB_ILLUMINATION_TUNGSTEN);\r\nbreak;\r\ncase V4L2_WHITE_BALANCE_FLUORESCENT:\r\n__is_set_isp_awb(is, ISP_AWB_COMMAND_ILLUMINATION,\r\nISP_AWB_ILLUMINATION_FLUORESCENT);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __ctrl_set_aewb_lock(struct fimc_is *is,\r\nstruct v4l2_ctrl *ctrl)\r\n{\r\nbool awb_lock = ctrl->val & V4L2_LOCK_WHITE_BALANCE;\r\nbool ae_lock = ctrl->val & V4L2_LOCK_EXPOSURE;\r\nstruct isp_param *isp = &is->is_p_region->parameter.isp;\r\nint cmd, ret;\r\ncmd = ae_lock ? ISP_AA_COMMAND_STOP : ISP_AA_COMMAND_START;\r\nisp->aa.cmd = cmd;\r\nisp->aa.target = ISP_AA_TARGET_AE;\r\nfimc_is_set_param_bit(is, PARAM_ISP_AA);\r\nis->af.ae_lock_state = ae_lock;\r\nwmb();\r\nret = fimc_is_itf_s_param(is, false);\r\nif (ret < 0)\r\nreturn ret;\r\ncmd = awb_lock ? ISP_AA_COMMAND_STOP : ISP_AA_COMMAND_START;\r\nisp->aa.cmd = cmd;\r\nisp->aa.target = ISP_AA_TARGET_AE;\r\nfimc_is_set_param_bit(is, PARAM_ISP_AA);\r\nis->af.awb_lock_state = awb_lock;\r\nwmb();\r\nreturn fimc_is_itf_s_param(is, false);\r\n}\r\nstatic int __ctrl_set_iso(struct fimc_is *is, int value)\r\n{\r\nunsigned int idx, iso;\r\nif (value == V4L2_ISO_SENSITIVITY_AUTO) {\r\n__is_set_isp_iso(is, ISP_ISO_COMMAND_AUTO, 0);\r\nreturn 0;\r\n}\r\nidx = is->isp.ctrls.iso->val;\r\nif (idx >= ARRAY_SIZE(iso_qmenu))\r\nreturn -EINVAL;\r\niso = iso_qmenu[idx];\r\n__is_set_isp_iso(is, ISP_ISO_COMMAND_MANUAL, iso);\r\nreturn 0;\r\n}\r\nstatic int __ctrl_set_metering(struct fimc_is *is, unsigned int value)\r\n{\r\nunsigned int val;\r\nswitch (value) {\r\ncase V4L2_EXPOSURE_METERING_AVERAGE:\r\nval = ISP_METERING_COMMAND_AVERAGE;\r\nbreak;\r\ncase V4L2_EXPOSURE_METERING_CENTER_WEIGHTED:\r\nval = ISP_METERING_COMMAND_CENTER;\r\nbreak;\r\ncase V4L2_EXPOSURE_METERING_SPOT:\r\nval = ISP_METERING_COMMAND_SPOT;\r\nbreak;\r\ncase V4L2_EXPOSURE_METERING_MATRIX:\r\nval = ISP_METERING_COMMAND_MATRIX;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n__is_set_isp_metering(is, IS_METERING_CONFIG_CMD, val);\r\nreturn 0;\r\n}\r\nstatic int __ctrl_set_afc(struct fimc_is *is, int value)\r\n{\r\nswitch (value) {\r\ncase V4L2_CID_POWER_LINE_FREQUENCY_DISABLED:\r\n__is_set_isp_afc(is, ISP_AFC_COMMAND_DISABLE, 0);\r\nbreak;\r\ncase V4L2_CID_POWER_LINE_FREQUENCY_50HZ:\r\n__is_set_isp_afc(is, ISP_AFC_COMMAND_MANUAL, 50);\r\nbreak;\r\ncase V4L2_CID_POWER_LINE_FREQUENCY_60HZ:\r\n__is_set_isp_afc(is, ISP_AFC_COMMAND_MANUAL, 60);\r\nbreak;\r\ncase V4L2_CID_POWER_LINE_FREQUENCY_AUTO:\r\n__is_set_isp_afc(is, ISP_AFC_COMMAND_AUTO, 0);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __ctrl_set_image_effect(struct fimc_is *is, int value)\r\n{\r\nstatic const u8 effects[][2] = {\r\n{ V4L2_COLORFX_NONE, ISP_IMAGE_EFFECT_DISABLE },\r\n{ V4L2_COLORFX_BW, ISP_IMAGE_EFFECT_MONOCHROME },\r\n{ V4L2_COLORFX_SEPIA, ISP_IMAGE_EFFECT_SEPIA },\r\n{ V4L2_COLORFX_NEGATIVE, ISP_IMAGE_EFFECT_NEGATIVE_MONO },\r\n{ 16 , ISP_IMAGE_EFFECT_NEGATIVE_COLOR },\r\n};\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(effects); i++) {\r\nif (effects[i][0] != value)\r\ncontinue;\r\n__is_set_isp_effect(is, effects[i][1]);\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int fimc_is_s_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstruct fimc_isp *isp = ctrl_to_fimc_isp(ctrl);\r\nstruct fimc_is *is = fimc_isp_to_is(isp);\r\nbool set_param = true;\r\nint ret = 0;\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_CONTRAST:\r\n__is_set_isp_adjust(is, ISP_ADJUST_COMMAND_MANUAL_CONTRAST,\r\nctrl->val);\r\nbreak;\r\ncase V4L2_CID_SATURATION:\r\n__is_set_isp_adjust(is, ISP_ADJUST_COMMAND_MANUAL_SATURATION,\r\nctrl->val);\r\nbreak;\r\ncase V4L2_CID_SHARPNESS:\r\n__is_set_isp_adjust(is, ISP_ADJUST_COMMAND_MANUAL_SHARPNESS,\r\nctrl->val);\r\nbreak;\r\ncase V4L2_CID_EXPOSURE_ABSOLUTE:\r\n__is_set_isp_adjust(is, ISP_ADJUST_COMMAND_MANUAL_EXPOSURE,\r\nctrl->val);\r\nbreak;\r\ncase V4L2_CID_BRIGHTNESS:\r\n__is_set_isp_adjust(is, ISP_ADJUST_COMMAND_MANUAL_BRIGHTNESS,\r\nctrl->val);\r\nbreak;\r\ncase V4L2_CID_HUE:\r\n__is_set_isp_adjust(is, ISP_ADJUST_COMMAND_MANUAL_HUE,\r\nctrl->val);\r\nbreak;\r\ncase V4L2_CID_EXPOSURE_METERING:\r\nret = __ctrl_set_metering(is, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_AUTO_N_PRESET_WHITE_BALANCE:\r\nret = __ctrl_set_white_balance(is, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_3A_LOCK:\r\nret = __ctrl_set_aewb_lock(is, ctrl);\r\nset_param = false;\r\nbreak;\r\ncase V4L2_CID_ISO_SENSITIVITY_AUTO:\r\nret = __ctrl_set_iso(is, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_POWER_LINE_FREQUENCY:\r\nret = __ctrl_set_afc(is, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_COLORFX:\r\n__ctrl_set_image_effect(is, ctrl->val);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nif (ret < 0) {\r\nv4l2_err(&isp->subdev, "Failed to set control: %s (%d)\n",\r\nctrl->name, ctrl->val);\r\nreturn ret;\r\n}\r\nif (set_param && test_bit(IS_ST_STREAM_ON, &is->state))\r\nreturn fimc_is_itf_s_param(is, true);\r\nreturn 0;\r\n}\r\nstatic void __isp_subdev_set_default_format(struct fimc_isp *isp)\r\n{\r\nstruct fimc_is *is = fimc_isp_to_is(isp);\r\nisp->sink_fmt.width = DEFAULT_PREVIEW_STILL_WIDTH +\r\nFIMC_ISP_CAC_MARGIN_WIDTH;\r\nisp->sink_fmt.height = DEFAULT_PREVIEW_STILL_HEIGHT +\r\nFIMC_ISP_CAC_MARGIN_HEIGHT;\r\nisp->sink_fmt.code = V4L2_MBUS_FMT_SGRBG10_1X10;\r\nisp->src_fmt.width = DEFAULT_PREVIEW_STILL_WIDTH;\r\nisp->src_fmt.height = DEFAULT_PREVIEW_STILL_HEIGHT;\r\nisp->src_fmt.code = V4L2_MBUS_FMT_SGRBG10_1X10;\r\n__is_set_frame_size(is, &isp->src_fmt);\r\n}\r\nint fimc_isp_subdev_create(struct fimc_isp *isp)\r\n{\r\nconst struct v4l2_ctrl_ops *ops = &fimc_isp_ctrl_ops;\r\nstruct v4l2_ctrl_handler *handler = &isp->ctrls.handler;\r\nstruct v4l2_subdev *sd = &isp->subdev;\r\nstruct fimc_isp_ctrls *ctrls = &isp->ctrls;\r\nint ret;\r\nmutex_init(&isp->subdev_lock);\r\nv4l2_subdev_init(sd, &fimc_is_subdev_ops);\r\nsd->owner = THIS_MODULE;\r\nsd->grp_id = GRP_ID_FIMC_IS;\r\nsd->flags |= V4L2_SUBDEV_FL_HAS_DEVNODE;\r\nsnprintf(sd->name, sizeof(sd->name), "FIMC-IS-ISP");\r\nisp->subdev_pads[FIMC_ISP_SD_PAD_SINK].flags = MEDIA_PAD_FL_SINK;\r\nisp->subdev_pads[FIMC_ISP_SD_PAD_SRC_FIFO].flags = MEDIA_PAD_FL_SOURCE;\r\nisp->subdev_pads[FIMC_ISP_SD_PAD_SRC_DMA].flags = MEDIA_PAD_FL_SOURCE;\r\nret = media_entity_init(&sd->entity, FIMC_ISP_SD_PADS_NUM,\r\nisp->subdev_pads, 0);\r\nif (ret)\r\nreturn ret;\r\nv4l2_ctrl_handler_init(handler, 20);\r\nctrls->saturation = v4l2_ctrl_new_std(handler, ops, V4L2_CID_SATURATION,\r\n-2, 2, 1, 0);\r\nctrls->brightness = v4l2_ctrl_new_std(handler, ops, V4L2_CID_BRIGHTNESS,\r\n-4, 4, 1, 0);\r\nctrls->contrast = v4l2_ctrl_new_std(handler, ops, V4L2_CID_CONTRAST,\r\n-2, 2, 1, 0);\r\nctrls->sharpness = v4l2_ctrl_new_std(handler, ops, V4L2_CID_SHARPNESS,\r\n-2, 2, 1, 0);\r\nctrls->hue = v4l2_ctrl_new_std(handler, ops, V4L2_CID_HUE,\r\n-2, 2, 1, 0);\r\nctrls->auto_wb = v4l2_ctrl_new_std_menu(handler, ops,\r\nV4L2_CID_AUTO_N_PRESET_WHITE_BALANCE,\r\n8, ~0x14e, V4L2_WHITE_BALANCE_AUTO);\r\nctrls->exposure = v4l2_ctrl_new_std(handler, ops,\r\nV4L2_CID_EXPOSURE_ABSOLUTE,\r\n-4, 4, 1, 0);\r\nctrls->exp_metering = v4l2_ctrl_new_std_menu(handler, ops,\r\nV4L2_CID_EXPOSURE_METERING, 3,\r\n~0xf, V4L2_EXPOSURE_METERING_AVERAGE);\r\nv4l2_ctrl_new_std_menu(handler, ops, V4L2_CID_POWER_LINE_FREQUENCY,\r\nV4L2_CID_POWER_LINE_FREQUENCY_AUTO, 0,\r\nV4L2_CID_POWER_LINE_FREQUENCY_AUTO);\r\nctrls->auto_iso = v4l2_ctrl_new_std_menu(handler, ops,\r\nV4L2_CID_ISO_SENSITIVITY_AUTO, 1, 0,\r\nV4L2_ISO_SENSITIVITY_AUTO);\r\nctrls->iso = v4l2_ctrl_new_int_menu(handler, ops,\r\nV4L2_CID_ISO_SENSITIVITY, ARRAY_SIZE(iso_qmenu) - 1,\r\nARRAY_SIZE(iso_qmenu)/2 - 1, iso_qmenu);\r\nctrls->aewb_lock = v4l2_ctrl_new_std(handler, ops,\r\nV4L2_CID_3A_LOCK, 0, 0x3, 0, 0);\r\nctrls->colorfx = v4l2_ctrl_new_std_menu(handler, ops, V4L2_CID_COLORFX,\r\nV4L2_COLORFX_SET_CBCR + 1, ~0x1000f, V4L2_COLORFX_NONE);\r\nif (handler->error) {\r\nmedia_entity_cleanup(&sd->entity);\r\nreturn handler->error;\r\n}\r\nv4l2_ctrl_auto_cluster(2, &ctrls->auto_iso,\r\nV4L2_ISO_SENSITIVITY_MANUAL, false);\r\nsd->ctrl_handler = handler;\r\nsd->internal_ops = &fimc_is_subdev_internal_ops;\r\nsd->entity.ops = &fimc_is_subdev_media_ops;\r\nv4l2_set_subdevdata(sd, isp);\r\n__isp_subdev_set_default_format(isp);\r\nreturn 0;\r\n}\r\nvoid fimc_isp_subdev_destroy(struct fimc_isp *isp)\r\n{\r\nstruct v4l2_subdev *sd = &isp->subdev;\r\nv4l2_device_unregister_subdev(sd);\r\nmedia_entity_cleanup(&sd->entity);\r\nv4l2_ctrl_handler_free(&isp->ctrls.handler);\r\nv4l2_set_subdevdata(sd, NULL);\r\n}

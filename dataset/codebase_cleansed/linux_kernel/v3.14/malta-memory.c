fw_memblock_t * __init fw_getmdesc(void)\r\n{\r\nchar *memsize_str, *ptr;\r\nunsigned int memsize;\r\nstatic char cmdline[COMMAND_LINE_SIZE] __initdata;\r\nlong val;\r\nint tmp;\r\nmemsize_str = fw_getenv("memsize");\r\nif (!memsize_str) {\r\npr_warn("memsize not set in YAMON, set to default (32Mb)\n");\r\nphysical_memsize = 0x02000000;\r\n} else {\r\ntmp = kstrtol(memsize_str, 0, &val);\r\nphysical_memsize = (unsigned long)val;\r\n}\r\n#ifdef CONFIG_CPU_BIG_ENDIAN\r\nphysical_memsize -= PAGE_SIZE;\r\n#endif\r\nstrcpy(cmdline, arcs_cmdline);\r\nptr = strstr(cmdline, "memsize=");\r\nif (ptr && (ptr != cmdline) && (*(ptr - 1) != ' '))\r\nptr = strstr(ptr, " memsize=");\r\nif (ptr)\r\nmemsize = memparse(ptr + 8, &ptr);\r\nelse\r\nmemsize = physical_memsize;\r\nmemset(mdesc, 0, sizeof(mdesc));\r\nmdesc[0].type = fw_dontuse;\r\nmdesc[0].base = 0x00000000;\r\nmdesc[0].size = 0x00001000;\r\nmdesc[1].type = fw_code;\r\nmdesc[1].base = 0x00001000;\r\nmdesc[1].size = 0x000ef000;\r\nmdesc[2].type = fw_dontuse;\r\nmdesc[2].base = 0x000f0000;\r\nmdesc[2].size = 0x00010000;\r\nmdesc[3].type = fw_dontuse;\r\nmdesc[3].base = 0x00100000;\r\nmdesc[3].size = CPHYSADDR(PFN_ALIGN((unsigned long)&_end)) -\r\nmdesc[3].base;\r\nmdesc[4].type = fw_free;\r\nmdesc[4].base = CPHYSADDR(PFN_ALIGN(&_end));\r\nmdesc[4].size = memsize - mdesc[4].base;\r\nreturn &mdesc[0];\r\n}\r\nstatic int __init fw_memtype_classify(unsigned int type)\r\n{\r\nswitch (type) {\r\ncase fw_free:\r\nreturn BOOT_MEM_RAM;\r\ncase fw_code:\r\nreturn BOOT_MEM_ROM_DATA;\r\ndefault:\r\nreturn BOOT_MEM_RESERVED;\r\n}\r\n}\r\nvoid __init fw_meminit(void)\r\n{\r\nfw_memblock_t *p;\r\np = fw_getmdesc();\r\nwhile (p->size) {\r\nlong type;\r\nunsigned long base, size;\r\ntype = fw_memtype_classify(p->type);\r\nbase = p->base;\r\nsize = p->size;\r\nadd_memory_region(base, size, type);\r\np++;\r\n}\r\n}\r\nvoid __init prom_free_prom_memory(void)\r\n{\r\nunsigned long addr;\r\nint i;\r\nfor (i = 0; i < boot_mem_map.nr_map; i++) {\r\nif (boot_mem_map.map[i].type != BOOT_MEM_ROM_DATA)\r\ncontinue;\r\naddr = boot_mem_map.map[i].addr;\r\nfree_init_pages("YAMON memory",\r\naddr, addr + boot_mem_map.map[i].size);\r\n}\r\n}

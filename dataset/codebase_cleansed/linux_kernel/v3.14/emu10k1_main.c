void snd_emu10k1_voice_init(struct snd_emu10k1 *emu, int ch)\r\n{\r\nsnd_emu10k1_ptr_write(emu, DCYSUSV, ch, 0);\r\nsnd_emu10k1_ptr_write(emu, IP, ch, 0);\r\nsnd_emu10k1_ptr_write(emu, VTFT, ch, 0xffff);\r\nsnd_emu10k1_ptr_write(emu, CVCF, ch, 0xffff);\r\nsnd_emu10k1_ptr_write(emu, PTRX, ch, 0);\r\nsnd_emu10k1_ptr_write(emu, CPF, ch, 0);\r\nsnd_emu10k1_ptr_write(emu, CCR, ch, 0);\r\nsnd_emu10k1_ptr_write(emu, PSST, ch, 0);\r\nsnd_emu10k1_ptr_write(emu, DSL, ch, 0x10);\r\nsnd_emu10k1_ptr_write(emu, CCCA, ch, 0);\r\nsnd_emu10k1_ptr_write(emu, Z1, ch, 0);\r\nsnd_emu10k1_ptr_write(emu, Z2, ch, 0);\r\nsnd_emu10k1_ptr_write(emu, FXRT, ch, 0x32100000);\r\nsnd_emu10k1_ptr_write(emu, ATKHLDM, ch, 0);\r\nsnd_emu10k1_ptr_write(emu, DCYSUSM, ch, 0);\r\nsnd_emu10k1_ptr_write(emu, IFATN, ch, 0xffff);\r\nsnd_emu10k1_ptr_write(emu, PEFE, ch, 0);\r\nsnd_emu10k1_ptr_write(emu, FMMOD, ch, 0);\r\nsnd_emu10k1_ptr_write(emu, TREMFRQ, ch, 24);\r\nsnd_emu10k1_ptr_write(emu, FM2FRQ2, ch, 24);\r\nsnd_emu10k1_ptr_write(emu, TEMPENV, ch, 0);\r\nsnd_emu10k1_ptr_write(emu, LFOVAL2, ch, 0);\r\nsnd_emu10k1_ptr_write(emu, LFOVAL1, ch, 0);\r\nsnd_emu10k1_ptr_write(emu, ATKHLDV, ch, 0);\r\nsnd_emu10k1_ptr_write(emu, ENVVOL, ch, 0);\r\nsnd_emu10k1_ptr_write(emu, ENVVAL, ch, 0);\r\nif (emu->audigy) {\r\nsnd_emu10k1_ptr_write(emu, 0x4c, ch, 0);\r\nsnd_emu10k1_ptr_write(emu, 0x4d, ch, 0);\r\nsnd_emu10k1_ptr_write(emu, 0x4e, ch, 0);\r\nsnd_emu10k1_ptr_write(emu, 0x4f, ch, 0);\r\nsnd_emu10k1_ptr_write(emu, A_FXRT1, ch, 0x03020100);\r\nsnd_emu10k1_ptr_write(emu, A_FXRT2, ch, 0x3f3f3f3f);\r\nsnd_emu10k1_ptr_write(emu, A_SENDAMOUNTS, ch, 0);\r\n}\r\n}\r\nstatic int snd_emu10k1_init(struct snd_emu10k1 *emu, int enable_ir, int resume)\r\n{\r\nunsigned int silent_page;\r\nint ch;\r\nu32 tmp;\r\noutl(HCFG_LOCKSOUNDCACHE | HCFG_LOCKTANKCACHE_MASK |\r\nHCFG_MUTEBUTTONENABLE, emu->port + HCFG);\r\nsnd_emu10k1_ptr_write(emu, MICBS, 0, ADCBS_BUFSIZE_NONE);\r\nsnd_emu10k1_ptr_write(emu, MICBA, 0, 0);\r\nsnd_emu10k1_ptr_write(emu, FXBS, 0, ADCBS_BUFSIZE_NONE);\r\nsnd_emu10k1_ptr_write(emu, FXBA, 0, 0);\r\nsnd_emu10k1_ptr_write(emu, ADCBS, 0, ADCBS_BUFSIZE_NONE);\r\nsnd_emu10k1_ptr_write(emu, ADCBA, 0, 0);\r\noutl(0, emu->port + INTE);\r\nsnd_emu10k1_ptr_write(emu, CLIEL, 0, 0);\r\nsnd_emu10k1_ptr_write(emu, CLIEH, 0, 0);\r\nsnd_emu10k1_ptr_write(emu, SOLEL, 0, 0);\r\nsnd_emu10k1_ptr_write(emu, SOLEH, 0, 0);\r\nif (emu->audigy) {\r\nsnd_emu10k1_ptr_write(emu, SPBYPASS, 0, SPBYPASS_FORMAT);\r\nsnd_emu10k1_ptr_write(emu, AC97SLOT, 0, AC97SLOT_REAR_RIGHT |\r\nAC97SLOT_REAR_LEFT);\r\n}\r\nfor (ch = 0; ch < NUM_G; ch++)\r\nsnd_emu10k1_voice_init(emu, ch);\r\nsnd_emu10k1_ptr_write(emu, SPCS0, 0, emu->spdif_bits[0]);\r\nsnd_emu10k1_ptr_write(emu, SPCS1, 0, emu->spdif_bits[1]);\r\nsnd_emu10k1_ptr_write(emu, SPCS2, 0, emu->spdif_bits[2]);\r\nif (emu->card_capabilities->ca0151_chip) {\r\ntmp = snd_emu10k1_ptr_read(emu, A_SPDIF_SAMPLERATE, 0);\r\ntmp &= 0xfffff1ff;\r\ntmp |= (0x2<<9);\r\nsnd_emu10k1_ptr_write(emu, A_SPDIF_SAMPLERATE, 0, tmp);\r\nsnd_emu10k1_ptr20_write(emu, SRCSel, 0, 0x14);\r\nsnd_emu10k1_ptr20_write(emu, SRCMULTI_ENABLE, 0, 0xFFFFFFFF);\r\noutl(0x0201, emu->port + HCFG2);\r\nsnd_emu10k1_ptr20_write(emu, CAPTURE_P16V_SOURCE, 0, 0x78e4);\r\n}\r\nif (emu->card_capabilities->ca0108_chip) {\r\nsnd_printk(KERN_INFO "Audigy2 value: Special config.\n");\r\ntmp = snd_emu10k1_ptr_read(emu, A_SPDIF_SAMPLERATE, 0);\r\ntmp &= 0xfffff1ff;\r\ntmp |= (0x2<<9);\r\nsnd_emu10k1_ptr_write(emu, A_SPDIF_SAMPLERATE, 0, tmp);\r\noutl(0x600000, emu->port + 0x20);\r\noutl(0x14, emu->port + 0x24);\r\noutl(0x7b0000, emu->port + 0x20);\r\noutl(0xFF000000, emu->port + 0x24);\r\noutl(0x7a0000, emu->port + 0x20);\r\noutl(0xFF000000, emu->port + 0x24);\r\ntmp = inl(emu->port + A_IOCFG) & ~0x8;\r\noutl(tmp, emu->port + A_IOCFG);\r\n}\r\nif (emu->card_capabilities->spi_dac) {\r\nint size, n;\r\nsize = ARRAY_SIZE(spi_dac_init);\r\nfor (n = 0; n < size; n++)\r\nsnd_emu10k1_spi_write(emu, spi_dac_init[n]);\r\nsnd_emu10k1_ptr20_write(emu, 0x60, 0, 0x10);\r\noutl(0x76, emu->port + A_IOCFG);\r\n}\r\nif (emu->card_capabilities->i2c_adc) {\r\nint size, n;\r\nsnd_emu10k1_ptr20_write(emu, P17V_I2S_SRC_SEL, 0, 0x2020205f);\r\ntmp = inl(emu->port + A_IOCFG);\r\noutl(tmp | 0x4, emu->port + A_IOCFG);\r\ntmp = inl(emu->port + A_IOCFG);\r\nsize = ARRAY_SIZE(i2c_adc_init);\r\nfor (n = 0; n < size; n++)\r\nsnd_emu10k1_i2c_write(emu, i2c_adc_init[n][0], i2c_adc_init[n][1]);\r\nfor (n = 0; n < 4; n++) {\r\nemu->i2c_capture_volume[n][0] = 0xcf;\r\nemu->i2c_capture_volume[n][1] = 0xcf;\r\n}\r\n}\r\nsnd_emu10k1_ptr_write(emu, PTB, 0, emu->ptb_pages.addr);\r\nsnd_emu10k1_ptr_write(emu, TCB, 0, 0);\r\nsnd_emu10k1_ptr_write(emu, TCBS, 0, 4);\r\nsilent_page = (emu->silent_page.addr << 1) | MAP_PTI_MASK;\r\nfor (ch = 0; ch < NUM_G; ch++) {\r\nsnd_emu10k1_ptr_write(emu, MAPA, ch, silent_page);\r\nsnd_emu10k1_ptr_write(emu, MAPB, ch, silent_page);\r\n}\r\nif (emu->card_capabilities->emu_model) {\r\noutl(HCFG_AUTOMUTE_ASYNC |\r\nHCFG_EMU32_SLAVE |\r\nHCFG_AUDIOENABLE, emu->port + HCFG);\r\n} else if (emu->audigy) {\r\nif (emu->revision == 4)\r\noutl(HCFG_AUDIOENABLE |\r\nHCFG_AC3ENABLE_CDSPDIF |\r\nHCFG_AC3ENABLE_GPSPDIF |\r\nHCFG_AUTOMUTE | HCFG_JOYENABLE, emu->port + HCFG);\r\nelse\r\noutl(HCFG_AUTOMUTE | HCFG_JOYENABLE, emu->port + HCFG);\r\n} else if (emu->model == 0x20 ||\r\nemu->model == 0xc400 ||\r\n(emu->model == 0x21 && emu->revision < 6))\r\noutl(HCFG_LOCKTANKCACHE_MASK | HCFG_AUTOMUTE, emu->port + HCFG);\r\nelse\r\noutl(HCFG_LOCKTANKCACHE_MASK | HCFG_AUTOMUTE | HCFG_JOYENABLE, emu->port + HCFG);\r\nif (enable_ir) {\r\nif (emu->card_capabilities->emu_model) {\r\n;\r\n} else if (emu->card_capabilities->i2c_adc) {\r\n;\r\n} else if (emu->audigy) {\r\nunsigned int reg = inl(emu->port + A_IOCFG);\r\noutl(reg | A_IOCFG_GPOUT2, emu->port + A_IOCFG);\r\nudelay(500);\r\noutl(reg | A_IOCFG_GPOUT1 | A_IOCFG_GPOUT2, emu->port + A_IOCFG);\r\nudelay(100);\r\noutl(reg, emu->port + A_IOCFG);\r\n} else {\r\nunsigned int reg = inl(emu->port + HCFG);\r\noutl(reg | HCFG_GPOUT2, emu->port + HCFG);\r\nudelay(500);\r\noutl(reg | HCFG_GPOUT1 | HCFG_GPOUT2, emu->port + HCFG);\r\nudelay(100);\r\noutl(reg, emu->port + HCFG);\r\n}\r\n}\r\nif (emu->card_capabilities->emu_model) {\r\n;\r\n} else if (emu->card_capabilities->i2c_adc) {\r\n;\r\n} else if (emu->audigy) {\r\nunsigned int reg = inl(emu->port + A_IOCFG);\r\noutl(reg | A_IOCFG_GPOUT0, emu->port + A_IOCFG);\r\n}\r\nreturn 0;\r\n}\r\nstatic void snd_emu10k1_audio_enable(struct snd_emu10k1 *emu)\r\n{\r\noutl(inl(emu->port + HCFG) | HCFG_AUDIOENABLE, emu->port + HCFG);\r\nif (emu->card_capabilities->emu_model) {\r\n;\r\n} else if (emu->card_capabilities->i2c_adc) {\r\n;\r\n} else if (emu->audigy) {\r\noutl(inl(emu->port + A_IOCFG) & ~0x44, emu->port + A_IOCFG);\r\nif (emu->card_capabilities->ca0151_chip) {\r\noutl(inl(emu->port + A_IOCFG) | 0x0040, emu->port + A_IOCFG);\r\n} else if (emu->card_capabilities->ca0108_chip) {\r\noutl(inl(emu->port + A_IOCFG) | 0x0060, emu->port + A_IOCFG);\r\n} else {\r\noutl(inl(emu->port + A_IOCFG) | 0x0080, emu->port + A_IOCFG);\r\n}\r\n}\r\n#if 0\r\n{\r\nunsigned int tmp;\r\nemu->tos_link = 0;\r\ntmp = inl(emu->port + HCFG);\r\nif (tmp & (HCFG_GPINPUT0 | HCFG_GPINPUT1)) {\r\noutl(tmp|0x800, emu->port + HCFG);\r\nudelay(50);\r\nif (tmp != (inl(emu->port + HCFG) & ~0x800)) {\r\nemu->tos_link = 1;\r\noutl(tmp, emu->port + HCFG);\r\n}\r\n}\r\n}\r\n#endif\r\nsnd_emu10k1_intr_enable(emu, INTE_PCIERRORENABLE);\r\n}\r\nint snd_emu10k1_done(struct snd_emu10k1 *emu)\r\n{\r\nint ch;\r\noutl(0, emu->port + INTE);\r\nfor (ch = 0; ch < NUM_G; ch++)\r\nsnd_emu10k1_ptr_write(emu, DCYSUSV, ch, 0);\r\nfor (ch = 0; ch < NUM_G; ch++) {\r\nsnd_emu10k1_ptr_write(emu, VTFT, ch, 0);\r\nsnd_emu10k1_ptr_write(emu, CVCF, ch, 0);\r\nsnd_emu10k1_ptr_write(emu, PTRX, ch, 0);\r\nsnd_emu10k1_ptr_write(emu, CPF, ch, 0);\r\n}\r\nsnd_emu10k1_ptr_write(emu, MICBS, 0, 0);\r\nsnd_emu10k1_ptr_write(emu, MICBA, 0, 0);\r\nsnd_emu10k1_ptr_write(emu, FXBS, 0, 0);\r\nsnd_emu10k1_ptr_write(emu, FXBA, 0, 0);\r\nsnd_emu10k1_ptr_write(emu, FXWC, 0, 0);\r\nsnd_emu10k1_ptr_write(emu, ADCBS, 0, ADCBS_BUFSIZE_NONE);\r\nsnd_emu10k1_ptr_write(emu, ADCBA, 0, 0);\r\nsnd_emu10k1_ptr_write(emu, TCBS, 0, TCBS_BUFFSIZE_16K);\r\nsnd_emu10k1_ptr_write(emu, TCB, 0, 0);\r\nif (emu->audigy)\r\nsnd_emu10k1_ptr_write(emu, A_DBG, 0, A_DBG_SINGLE_STEP);\r\nelse\r\nsnd_emu10k1_ptr_write(emu, DBG, 0, EMU10K1_DBG_SINGLE_STEP);\r\nsnd_emu10k1_ptr_write(emu, CLIEL, 0, 0);\r\nsnd_emu10k1_ptr_write(emu, CLIEH, 0, 0);\r\nsnd_emu10k1_ptr_write(emu, SOLEL, 0, 0);\r\nsnd_emu10k1_ptr_write(emu, SOLEH, 0, 0);\r\noutl(HCFG_LOCKSOUNDCACHE | HCFG_LOCKTANKCACHE_MASK | HCFG_MUTEBUTTONENABLE, emu->port + HCFG);\r\nsnd_emu10k1_ptr_write(emu, PTB, 0, 0);\r\nreturn 0;\r\n}\r\nstatic void snd_emu10k1_ecard_write(struct snd_emu10k1 *emu, unsigned int value)\r\n{\r\nunsigned short count;\r\nunsigned int data;\r\nunsigned long hc_port;\r\nunsigned int hc_value;\r\nhc_port = emu->port + HCFG;\r\nhc_value = inl(hc_port) & ~(HOOKN_BIT | HANDN_BIT | PULSEN_BIT);\r\noutl(hc_value, hc_port);\r\nfor (count = 0; count < EC_NUM_CONTROL_BITS; count++) {\r\ndata = ((value & 0x1) ? PULSEN_BIT : 0);\r\nvalue >>= 1;\r\noutl(hc_value | data, hc_port);\r\noutl(hc_value | data | HANDN_BIT, hc_port);\r\noutl(hc_value | data, hc_port);\r\n}\r\noutl(hc_value | HOOKN_BIT, hc_port);\r\noutl(hc_value, hc_port);\r\n}\r\nstatic void snd_emu10k1_ecard_setadcgain(struct snd_emu10k1 *emu,\r\nunsigned short gain)\r\n{\r\nunsigned int bit;\r\nsnd_emu10k1_ecard_write(emu, emu->ecard_ctrl & ~EC_TRIM_CSN);\r\nsnd_emu10k1_ecard_write(emu, emu->ecard_ctrl & ~EC_TRIM_CSN);\r\nfor (bit = (1 << 15); bit; bit >>= 1) {\r\nunsigned int value;\r\nvalue = emu->ecard_ctrl & ~(EC_TRIM_CSN | EC_TRIM_SDATA);\r\nif (gain & bit)\r\nvalue |= EC_TRIM_SDATA;\r\nsnd_emu10k1_ecard_write(emu, value);\r\nsnd_emu10k1_ecard_write(emu, value | EC_TRIM_SCLK);\r\nsnd_emu10k1_ecard_write(emu, value);\r\n}\r\nsnd_emu10k1_ecard_write(emu, emu->ecard_ctrl);\r\n}\r\nstatic int snd_emu10k1_ecard_init(struct snd_emu10k1 *emu)\r\n{\r\nunsigned int hc_value;\r\nemu->ecard_ctrl = EC_RAW_RUN_MODE |\r\nEC_SPDIF0_SELECT(EC_DEFAULT_SPDIF0_SEL) |\r\nEC_SPDIF1_SELECT(EC_DEFAULT_SPDIF1_SEL);\r\nhc_value = inl(emu->port + HCFG);\r\noutl(hc_value | HCFG_AUDIOENABLE | HCFG_CODECFORMAT_I2S, emu->port + HCFG);\r\ninl(emu->port + HCFG);\r\nsnd_emu10k1_ecard_write(emu, EC_ADCCAL | EC_LEDN | EC_TRIM_CSN);\r\nsnd_emu10k1_ecard_write(emu, EC_DACCAL | EC_LEDN | EC_TRIM_CSN);\r\nsnd_emu10k1_wait(emu, 48000);\r\nsnd_emu10k1_ecard_write(emu, EC_ADCCAL | EC_LEDN | EC_TRIM_CSN);\r\nsnd_emu10k1_ecard_write(emu, emu->ecard_ctrl);\r\nsnd_emu10k1_ecard_setadcgain(emu, EC_DEFAULT_ADC_GAIN);\r\nreturn 0;\r\n}\r\nstatic int snd_emu10k1_cardbus_init(struct snd_emu10k1 *emu)\r\n{\r\nunsigned long special_port;\r\nunsigned int value;\r\nspecial_port = emu->port + 0x38;\r\nvalue = inl(special_port);\r\noutl(0x00d00000, special_port);\r\nvalue = inl(special_port);\r\noutl(0x00d00001, special_port);\r\nvalue = inl(special_port);\r\noutl(0x00d0005f, special_port);\r\nvalue = inl(special_port);\r\noutl(0x00d0007f, special_port);\r\nvalue = inl(special_port);\r\noutl(0x0090007f, special_port);\r\nvalue = inl(special_port);\r\nsnd_emu10k1_ptr20_write(emu, TINA2_VOLUME, 0, 0xfefefefe);\r\nmsleep(200);\r\nreturn 0;\r\n}\r\nstatic int snd_emu1010_load_firmware(struct snd_emu10k1 *emu,\r\nconst struct firmware *fw_entry)\r\n{\r\nint n, i;\r\nint reg;\r\nint value;\r\nunsigned int write_post;\r\nunsigned long flags;\r\nif (!fw_entry)\r\nreturn -EIO;\r\nspin_lock_irqsave(&emu->emu_lock, flags);\r\noutl(0x00, emu->port + A_IOCFG);\r\nwrite_post = inl(emu->port + A_IOCFG);\r\nudelay(100);\r\noutl(0x80, emu->port + A_IOCFG);\r\nwrite_post = inl(emu->port + A_IOCFG);\r\nudelay(100);\r\nfor (n = 0; n < fw_entry->size; n++) {\r\nvalue = fw_entry->data[n];\r\nfor (i = 0; i < 8; i++) {\r\nreg = 0x80;\r\nif (value & 0x1)\r\nreg = reg | 0x20;\r\nvalue = value >> 1;\r\noutl(reg, emu->port + A_IOCFG);\r\nwrite_post = inl(emu->port + A_IOCFG);\r\noutl(reg | 0x40, emu->port + A_IOCFG);\r\nwrite_post = inl(emu->port + A_IOCFG);\r\n}\r\n}\r\noutl(0x10, emu->port + A_IOCFG);\r\nwrite_post = inl(emu->port + A_IOCFG);\r\nspin_unlock_irqrestore(&emu->emu_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int emu1010_firmware_thread(void *data)\r\n{\r\nstruct snd_emu10k1 *emu = data;\r\nu32 tmp, tmp2, reg;\r\nint err;\r\nfor (;;) {\r\nmsleep_interruptible(1000);\r\nif (kthread_should_stop())\r\nbreak;\r\n#ifdef CONFIG_PM_SLEEP\r\nif (emu->suspend)\r\ncontinue;\r\n#endif\r\nsnd_emu1010_fpga_read(emu, EMU_HANA_IRQ_STATUS, &tmp);\r\nsnd_emu1010_fpga_read(emu, EMU_HANA_OPTION_CARDS, &reg);\r\nif (reg & EMU_HANA_OPTION_DOCK_OFFLINE) {\r\nsnd_printk(KERN_INFO "emu1010: Loading Audio Dock Firmware\n");\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_FPGA_CONFIG, EMU_HANA_FPGA_CONFIG_AUDIODOCK);\r\nif (!emu->dock_fw) {\r\nconst char *filename = NULL;\r\nswitch (emu->card_capabilities->emu_model) {\r\ncase EMU_MODEL_EMU1010:\r\nfilename = DOCK_FILENAME;\r\nbreak;\r\ncase EMU_MODEL_EMU1010B:\r\nfilename = MICRO_DOCK_FILENAME;\r\nbreak;\r\ncase EMU_MODEL_EMU1616:\r\nfilename = MICRO_DOCK_FILENAME;\r\nbreak;\r\n}\r\nif (filename) {\r\nerr = request_firmware(&emu->dock_fw,\r\nfilename,\r\n&emu->pci->dev);\r\nif (err)\r\ncontinue;\r\n}\r\n}\r\nif (emu->dock_fw) {\r\nerr = snd_emu1010_load_firmware(emu, emu->dock_fw);\r\nif (err)\r\ncontinue;\r\n}\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_FPGA_CONFIG, 0);\r\nsnd_emu1010_fpga_read(emu, EMU_HANA_IRQ_STATUS, &reg);\r\nsnd_printk(KERN_INFO "emu1010: EMU_HANA+DOCK_IRQ_STATUS = 0x%x\n", reg);\r\nsnd_emu1010_fpga_read(emu, EMU_HANA_ID, &reg);\r\nsnd_printk(KERN_INFO "emu1010: EMU_HANA+DOCK_ID = 0x%x\n", reg);\r\nif ((reg & 0x1f) != 0x15) {\r\nsnd_printk(KERN_INFO "emu1010: Loading Audio Dock Firmware file failed, reg = 0x%x\n", reg);\r\ncontinue;\r\n}\r\nsnd_printk(KERN_INFO "emu1010: Audio Dock Firmware loaded\n");\r\nsnd_emu1010_fpga_read(emu, EMU_DOCK_MAJOR_REV, &tmp);\r\nsnd_emu1010_fpga_read(emu, EMU_DOCK_MINOR_REV, &tmp2);\r\nsnd_printk(KERN_INFO "Audio Dock ver: %u.%u\n",\r\ntmp, tmp2);\r\nmsleep(10);\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_UNMUTE, EMU_UNMUTE);\r\n}\r\n}\r\nsnd_printk(KERN_INFO "emu1010: firmware thread stopping\n");\r\nreturn 0;\r\n}\r\nstatic int snd_emu10k1_emu1010_init(struct snd_emu10k1 *emu)\r\n{\r\nunsigned int i;\r\nu32 tmp, tmp2, reg;\r\nint err;\r\nsnd_printk(KERN_INFO "emu1010: Special config.\n");\r\noutl(0x0005a00c, emu->port + HCFG);\r\noutl(0x0005a004, emu->port + HCFG);\r\noutl(0x0005a000, emu->port + HCFG);\r\noutl(0x0005a000, emu->port + HCFG);\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_DOCK_PWR, 0);\r\nsnd_emu1010_fpga_read(emu, EMU_HANA_ID, &reg);\r\nsnd_printdd("reg1 = 0x%x\n", reg);\r\nif ((reg & 0x3f) == 0x15) {\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_FPGA_CONFIG, 0x02);\r\n}\r\nsnd_emu1010_fpga_read(emu, EMU_HANA_ID, &reg);\r\nsnd_printdd("reg2 = 0x%x\n", reg);\r\nif ((reg & 0x3f) == 0x15) {\r\nsnd_printk(KERN_INFO "emu1010: FPGA failed to return to programming mode\n");\r\nreturn -ENODEV;\r\n}\r\nsnd_printk(KERN_INFO "emu1010: EMU_HANA_ID = 0x%x\n", reg);\r\nif (!emu->firmware) {\r\nconst char *filename;\r\nswitch (emu->card_capabilities->emu_model) {\r\ncase EMU_MODEL_EMU1010:\r\nfilename = HANA_FILENAME;\r\nbreak;\r\ncase EMU_MODEL_EMU1010B:\r\nfilename = EMU1010B_FILENAME;\r\nbreak;\r\ncase EMU_MODEL_EMU1616:\r\nfilename = EMU1010_NOTEBOOK_FILENAME;\r\nbreak;\r\ncase EMU_MODEL_EMU0404:\r\nfilename = EMU0404_FILENAME;\r\nbreak;\r\ndefault:\r\nreturn -ENODEV;\r\n}\r\nerr = request_firmware(&emu->firmware, filename, &emu->pci->dev);\r\nif (err != 0) {\r\nsnd_printk(KERN_ERR "emu1010: firmware: %s not found. Err = %d\n", filename, err);\r\nreturn err;\r\n}\r\nsnd_printk(KERN_INFO "emu1010: firmware file = %s, size = 0x%zx\n",\r\nfilename, emu->firmware->size);\r\n}\r\nerr = snd_emu1010_load_firmware(emu, emu->firmware);\r\nif (err != 0) {\r\nsnd_printk(KERN_INFO "emu1010: Loading Firmware failed\n");\r\nreturn err;\r\n}\r\nsnd_emu1010_fpga_read(emu, EMU_HANA_ID, &reg);\r\nif ((reg & 0x3f) != 0x15) {\r\nsnd_printk(KERN_INFO "emu1010: Loading Hana Firmware file failed, reg = 0x%x\n", reg);\r\nreturn -ENODEV;\r\n}\r\nsnd_printk(KERN_INFO "emu1010: Hana Firmware loaded\n");\r\nsnd_emu1010_fpga_read(emu, EMU_HANA_MAJOR_REV, &tmp);\r\nsnd_emu1010_fpga_read(emu, EMU_HANA_MINOR_REV, &tmp2);\r\nsnd_printk(KERN_INFO "emu1010: Hana version: %u.%u\n", tmp, tmp2);\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_DOCK_PWR, EMU_HANA_DOCK_PWR_ON);\r\nsnd_emu1010_fpga_read(emu, EMU_HANA_OPTION_CARDS, &reg);\r\nsnd_printk(KERN_INFO "emu1010: Card options = 0x%x\n", reg);\r\nsnd_emu1010_fpga_read(emu, EMU_HANA_OPTION_CARDS, &reg);\r\nsnd_printk(KERN_INFO "emu1010: Card options = 0x%x\n", reg);\r\nsnd_emu1010_fpga_read(emu, EMU_HANA_OPTICAL_TYPE, &tmp);\r\nemu->emu1010.optical_in = 1;\r\nemu->emu1010.optical_out = 1;\r\ntmp = 0;\r\ntmp = (emu->emu1010.optical_in ? EMU_HANA_OPTICAL_IN_ADAT : 0) |\r\n(emu->emu1010.optical_out ? EMU_HANA_OPTICAL_OUT_ADAT : 0);\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_OPTICAL_TYPE, tmp);\r\nsnd_emu1010_fpga_read(emu, EMU_HANA_ADC_PADS, &tmp);\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_ADC_PADS, 0x00);\r\nemu->emu1010.adc_pads = 0x00;\r\nsnd_emu1010_fpga_read(emu, EMU_HANA_DOCK_MISC, &tmp);\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_DOCK_MISC, 0x30);\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_DOCK_LEDS_2, 0x12);\r\nsnd_emu1010_fpga_read(emu, EMU_HANA_DAC_PADS, &tmp);\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_DAC_PADS, 0x0f);\r\nemu->emu1010.dac_pads = 0x0f;\r\nsnd_emu1010_fpga_read(emu, EMU_HANA_DOCK_MISC, &tmp);\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_DOCK_MISC, 0x30);\r\nsnd_emu1010_fpga_read(emu, EMU_HANA_SPDIF_MODE, &tmp);\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_SPDIF_MODE, 0x10);\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_MIDI_IN, 0x19);\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_MIDI_OUT, 0x0c);\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_IRQ_ENABLE, 0x00);\r\nsnd_emu1010_fpga_read(emu, EMU_HANA_OPTION_CARDS, &reg);\r\nsnd_printk(KERN_INFO "emu1010: Card options3 = 0x%x\n", reg);\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_DEFCLOCK, 0x00);\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_WCLOCK, EMU_HANA_WCLOCK_INT_48K);\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_DOCK_LEDS_2, 0x12);\r\n#if 0\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_0, EMU_SRC_HAMOA_ADC_LEFT1);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_1, EMU_SRC_HAMOA_ADC_RIGHT1);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_4, EMU_SRC_HAMOA_ADC_LEFT2);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_5, EMU_SRC_HAMOA_ADC_RIGHT2);\r\n#endif\r\n#if 0\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_0, EMU_SRC_HAMOA_ADC_LEFT1);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_1, EMU_SRC_HAMOA_ADC_RIGHT1);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_2, EMU_SRC_HAMOA_ADC_LEFT2);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_3, EMU_SRC_HAMOA_ADC_RIGHT2);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_4, EMU_SRC_HAMOA_ADC_LEFT3);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_5, EMU_SRC_HAMOA_ADC_RIGHT3);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_6, EMU_SRC_HAMOA_ADC_LEFT4);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_7, EMU_SRC_HAMOA_ADC_RIGHT4);\r\n#endif\r\n#if 1\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_0, EMU_SRC_DOCK_MIC_A1);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_1, EMU_SRC_DOCK_MIC_B1);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_2, EMU_SRC_HAMOA_ADC_LEFT2);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_3, EMU_SRC_HAMOA_ADC_LEFT2);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_4, EMU_SRC_DOCK_ADC1_LEFT1);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_5, EMU_SRC_DOCK_ADC1_RIGHT1);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_6, EMU_SRC_DOCK_ADC2_LEFT1);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_7, EMU_SRC_DOCK_ADC2_RIGHT1);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_8, EMU_SRC_DOCK_MIC_A1);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_9, EMU_SRC_DOCK_MIC_B1);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_A, EMU_SRC_HAMOA_ADC_LEFT2);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_B, EMU_SRC_HAMOA_ADC_LEFT2);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_C, EMU_SRC_DOCK_ADC1_LEFT1);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_D, EMU_SRC_DOCK_ADC1_RIGHT1);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_E, EMU_SRC_DOCK_ADC2_LEFT1);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_F, EMU_SRC_DOCK_ADC2_RIGHT1);\r\n#endif\r\n#if 0\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_4, EMU_SRC_HANA_ADAT);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_5, EMU_SRC_HANA_ADAT + 1);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_6, EMU_SRC_HANA_ADAT + 2);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_7, EMU_SRC_HANA_ADAT + 3);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_8, EMU_SRC_HANA_ADAT + 4);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_9, EMU_SRC_HANA_ADAT + 5);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_A, EMU_SRC_HANA_ADAT + 6);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_B, EMU_SRC_HANA_ADAT + 7);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_C, EMU_SRC_DOCK_MIC_A1);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_D, EMU_SRC_DOCK_MIC_B1);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_E, EMU_SRC_HAMOA_ADC_LEFT2);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE2_EMU32_F, EMU_SRC_HAMOA_ADC_LEFT2);\r\n#endif\r\nfor (i = 0; i < 0x20; i++) {\r\nsnd_emu1010_fpga_link_dst_src_write(emu, 0x0100 + i, EMU_SRC_SILENCE);\r\n}\r\nfor (i = 0; i < 4; i++) {\r\nsnd_emu1010_fpga_link_dst_src_write(emu, 0x0200 + i, EMU_SRC_SILENCE);\r\n}\r\nfor (i = 0; i < 7; i++) {\r\nsnd_emu1010_fpga_link_dst_src_write(emu, 0x0300 + i, EMU_SRC_SILENCE);\r\n}\r\nfor (i = 0; i < 7; i++) {\r\nsnd_emu1010_fpga_link_dst_src_write(emu, EMU_DST_HANA_ADAT + i, EMU_SRC_SILENCE);\r\n}\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE_I2S0_LEFT, EMU_SRC_DOCK_ADC1_LEFT1);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE_I2S0_RIGHT, EMU_SRC_DOCK_ADC1_RIGHT1);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE_I2S1_LEFT, EMU_SRC_DOCK_ADC2_LEFT1);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE_I2S1_RIGHT, EMU_SRC_DOCK_ADC2_RIGHT1);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE_I2S2_LEFT, EMU_SRC_DOCK_ADC3_LEFT1);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_ALICE_I2S2_RIGHT, EMU_SRC_DOCK_ADC3_RIGHT1);\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_UNMUTE, 0x01);\r\nsnd_emu1010_fpga_read(emu, EMU_HANA_OPTION_CARDS, &tmp);\r\noutl(0x0000a000, emu->port + HCFG);\r\noutl(0x0000a001, emu->port + HCFG);\r\nsnd_emu1010_fpga_read(emu, EMU_HANA_OPTION_CARDS, &tmp);\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_MIDI_IN, 0x19);\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_MIDI_OUT, 0x0c);\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_MIDI_IN, 0x19);\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_MIDI_OUT, 0x0c);\r\nsnd_emu1010_fpga_read(emu, EMU_HANA_SPDIF_MODE, &tmp);\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_SPDIF_MODE, 0x10);\r\nif (!emu->emu1010.firmware_thread) {\r\nemu->emu1010.firmware_thread =\r\nkthread_create(emu1010_firmware_thread, emu,\r\n"emu1010_firmware");\r\nwake_up_process(emu->emu1010.firmware_thread);\r\n}\r\n#if 0\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_HAMOA_DAC_LEFT1, EMU_SRC_ALICE_EMU32B + 2);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_HAMOA_DAC_RIGHT1, EMU_SRC_ALICE_EMU32B + 3);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_HANA_SPDIF_LEFT1, EMU_SRC_ALICE_EMU32A + 2);\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_HANA_SPDIF_RIGHT1, EMU_SRC_ALICE_EMU32A + 3);\r\n#endif\r\nif (emu->card_capabilities->emu_model == EMU_MODEL_EMU1616) {\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_DOCK_DAC1_LEFT1, EMU_SRC_ALICE_EMU32A + 0);\r\nemu->emu1010.output_source[0] = 17;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_DOCK_DAC1_RIGHT1, EMU_SRC_ALICE_EMU32A + 1);\r\nemu->emu1010.output_source[1] = 18;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_DOCK_DAC2_LEFT1, EMU_SRC_ALICE_EMU32A + 2);\r\nemu->emu1010.output_source[2] = 19;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_DOCK_DAC2_RIGHT1, EMU_SRC_ALICE_EMU32A + 3);\r\nemu->emu1010.output_source[3] = 20;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_DOCK_DAC3_LEFT1, EMU_SRC_ALICE_EMU32A + 4);\r\nemu->emu1010.output_source[4] = 21;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_DOCK_DAC3_RIGHT1, EMU_SRC_ALICE_EMU32A + 5);\r\nemu->emu1010.output_source[5] = 22;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_MANA_DAC_LEFT, EMU_SRC_ALICE_EMU32A + 0);\r\nemu->emu1010.output_source[16] = 17;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_MANA_DAC_RIGHT, EMU_SRC_ALICE_EMU32A + 1);\r\nemu->emu1010.output_source[17] = 18;\r\n} else {\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_DOCK_DAC1_LEFT1, EMU_SRC_ALICE_EMU32A + 0);\r\nemu->emu1010.output_source[0] = 21;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_DOCK_DAC1_RIGHT1, EMU_SRC_ALICE_EMU32A + 1);\r\nemu->emu1010.output_source[1] = 22;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_DOCK_DAC2_LEFT1, EMU_SRC_ALICE_EMU32A + 2);\r\nemu->emu1010.output_source[2] = 23;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_DOCK_DAC2_RIGHT1, EMU_SRC_ALICE_EMU32A + 3);\r\nemu->emu1010.output_source[3] = 24;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_DOCK_DAC3_LEFT1, EMU_SRC_ALICE_EMU32A + 4);\r\nemu->emu1010.output_source[4] = 25;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_DOCK_DAC3_RIGHT1, EMU_SRC_ALICE_EMU32A + 5);\r\nemu->emu1010.output_source[5] = 26;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_DOCK_DAC4_LEFT1, EMU_SRC_ALICE_EMU32A + 6);\r\nemu->emu1010.output_source[6] = 27;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_DOCK_DAC4_RIGHT1, EMU_SRC_ALICE_EMU32A + 7);\r\nemu->emu1010.output_source[7] = 28;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_DOCK_PHONES_LEFT1, EMU_SRC_ALICE_EMU32A + 0);\r\nemu->emu1010.output_source[8] = 21;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_DOCK_PHONES_RIGHT1, EMU_SRC_ALICE_EMU32A + 1);\r\nemu->emu1010.output_source[9] = 22;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_DOCK_SPDIF_LEFT1, EMU_SRC_ALICE_EMU32A + 0);\r\nemu->emu1010.output_source[10] = 21;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_DOCK_SPDIF_RIGHT1, EMU_SRC_ALICE_EMU32A + 1);\r\nemu->emu1010.output_source[11] = 22;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_HANA_SPDIF_LEFT1, EMU_SRC_ALICE_EMU32A + 0);\r\nemu->emu1010.output_source[12] = 21;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_HANA_SPDIF_RIGHT1, EMU_SRC_ALICE_EMU32A + 1);\r\nemu->emu1010.output_source[13] = 22;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_HAMOA_DAC_LEFT1, EMU_SRC_ALICE_EMU32A + 0);\r\nemu->emu1010.output_source[14] = 21;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_HAMOA_DAC_RIGHT1, EMU_SRC_ALICE_EMU32A + 1);\r\nemu->emu1010.output_source[15] = 22;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_HANA_ADAT, EMU_SRC_ALICE_EMU32A + 0);\r\nemu->emu1010.output_source[16] = 21;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_HANA_ADAT + 1, EMU_SRC_ALICE_EMU32A + 1);\r\nemu->emu1010.output_source[17] = 22;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_HANA_ADAT + 2, EMU_SRC_ALICE_EMU32A + 2);\r\nemu->emu1010.output_source[18] = 23;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_HANA_ADAT + 3, EMU_SRC_ALICE_EMU32A + 3);\r\nemu->emu1010.output_source[19] = 24;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_HANA_ADAT + 4, EMU_SRC_ALICE_EMU32A + 4);\r\nemu->emu1010.output_source[20] = 25;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_HANA_ADAT + 5, EMU_SRC_ALICE_EMU32A + 5);\r\nemu->emu1010.output_source[21] = 26;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_HANA_ADAT + 6, EMU_SRC_ALICE_EMU32A + 6);\r\nemu->emu1010.output_source[22] = 27;\r\nsnd_emu1010_fpga_link_dst_src_write(emu,\r\nEMU_DST_HANA_ADAT + 7, EMU_SRC_ALICE_EMU32A + 7);\r\nemu->emu1010.output_source[23] = 28;\r\n}\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_UNMUTE, 0x0);\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_DEFCLOCK, 0x0);\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_WCLOCK, EMU_HANA_WCLOCK_INT_48K);\r\nemu->emu1010.internal_clock = 1;\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_DOCK_LEDS_2, 0x12);\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_UNMUTE, 0x1);\r\nreturn 0;\r\n}\r\nstatic int snd_emu10k1_free(struct snd_emu10k1 *emu)\r\n{\r\nif (emu->port) {\r\nsnd_emu10k1_fx8010_tram_setup(emu, 0);\r\nsnd_emu10k1_done(emu);\r\nsnd_emu10k1_free_efx(emu);\r\n}\r\nif (emu->card_capabilities->emu_model == EMU_MODEL_EMU1010) {\r\nsnd_emu1010_fpga_write(emu, EMU_HANA_DOCK_PWR, 0);\r\n}\r\nif (emu->emu1010.firmware_thread)\r\nkthread_stop(emu->emu1010.firmware_thread);\r\nif (emu->firmware)\r\nrelease_firmware(emu->firmware);\r\nif (emu->dock_fw)\r\nrelease_firmware(emu->dock_fw);\r\nif (emu->irq >= 0)\r\nfree_irq(emu->irq, emu);\r\nif (emu->reserved_page) {\r\nsnd_emu10k1_synth_free(emu,\r\n(struct snd_util_memblk *)emu->reserved_page);\r\nemu->reserved_page = NULL;\r\n}\r\nif (emu->memhdr)\r\nsnd_util_memhdr_free(emu->memhdr);\r\nif (emu->silent_page.area)\r\nsnd_dma_free_pages(&emu->silent_page);\r\nif (emu->ptb_pages.area)\r\nsnd_dma_free_pages(&emu->ptb_pages);\r\nvfree(emu->page_ptr_table);\r\nvfree(emu->page_addr_table);\r\n#ifdef CONFIG_PM_SLEEP\r\nfree_pm_buffer(emu);\r\n#endif\r\nif (emu->port)\r\npci_release_regions(emu->pci);\r\nif (emu->card_capabilities->ca0151_chip)\r\nsnd_p16v_free(emu);\r\npci_disable_device(emu->pci);\r\nkfree(emu);\r\nreturn 0;\r\n}\r\nstatic int snd_emu10k1_dev_free(struct snd_device *device)\r\n{\r\nstruct snd_emu10k1 *emu = device->device_data;\r\nreturn snd_emu10k1_free(emu);\r\n}\r\nint snd_emu10k1_create(struct snd_card *card,\r\nstruct pci_dev *pci,\r\nunsigned short extin_mask,\r\nunsigned short extout_mask,\r\nlong max_cache_bytes,\r\nint enable_ir,\r\nuint subsystem,\r\nstruct snd_emu10k1 **remu)\r\n{\r\nstruct snd_emu10k1 *emu;\r\nint idx, err;\r\nint is_audigy;\r\nunsigned int silent_page;\r\nconst struct snd_emu_chip_details *c;\r\nstatic struct snd_device_ops ops = {\r\n.dev_free = snd_emu10k1_dev_free,\r\n};\r\n*remu = NULL;\r\nerr = pci_enable_device(pci);\r\nif (err < 0)\r\nreturn err;\r\nemu = kzalloc(sizeof(*emu), GFP_KERNEL);\r\nif (emu == NULL) {\r\npci_disable_device(pci);\r\nreturn -ENOMEM;\r\n}\r\nemu->card = card;\r\nspin_lock_init(&emu->reg_lock);\r\nspin_lock_init(&emu->emu_lock);\r\nspin_lock_init(&emu->spi_lock);\r\nspin_lock_init(&emu->i2c_lock);\r\nspin_lock_init(&emu->voice_lock);\r\nspin_lock_init(&emu->synth_lock);\r\nspin_lock_init(&emu->memblk_lock);\r\nmutex_init(&emu->fx8010.lock);\r\nINIT_LIST_HEAD(&emu->mapped_link_head);\r\nINIT_LIST_HEAD(&emu->mapped_order_link_head);\r\nemu->pci = pci;\r\nemu->irq = -1;\r\nemu->synth = NULL;\r\nemu->get_synth_voice = NULL;\r\nemu->revision = pci->revision;\r\npci_read_config_dword(pci, PCI_SUBSYSTEM_VENDOR_ID, &emu->serial);\r\npci_read_config_word(pci, PCI_SUBSYSTEM_ID, &emu->model);\r\nsnd_printdd("vendor = 0x%x, device = 0x%x, subsystem_vendor_id = 0x%x, subsystem_id = 0x%x\n", pci->vendor, pci->device, emu->serial, emu->model);\r\nfor (c = emu_chip_details; c->vendor; c++) {\r\nif (c->vendor == pci->vendor && c->device == pci->device) {\r\nif (subsystem) {\r\nif (c->subsystem && (c->subsystem == subsystem))\r\nbreak;\r\nelse\r\ncontinue;\r\n} else {\r\nif (c->subsystem && (c->subsystem != emu->serial))\r\ncontinue;\r\nif (c->revision && c->revision != emu->revision)\r\ncontinue;\r\n}\r\nbreak;\r\n}\r\n}\r\nif (c->vendor == 0) {\r\nsnd_printk(KERN_ERR "emu10k1: Card not recognised\n");\r\nkfree(emu);\r\npci_disable_device(pci);\r\nreturn -ENOENT;\r\n}\r\nemu->card_capabilities = c;\r\nif (c->subsystem && !subsystem)\r\nsnd_printdd("Sound card name = %s\n", c->name);\r\nelse if (subsystem)\r\nsnd_printdd("Sound card name = %s, "\r\n"vendor = 0x%x, device = 0x%x, subsystem = 0x%x. "\r\n"Forced to subsystem = 0x%x\n", c->name,\r\npci->vendor, pci->device, emu->serial, c->subsystem);\r\nelse\r\nsnd_printdd("Sound card name = %s, "\r\n"vendor = 0x%x, device = 0x%x, subsystem = 0x%x.\n",\r\nc->name, pci->vendor, pci->device,\r\nemu->serial);\r\nif (!*card->id && c->id) {\r\nint i, n = 0;\r\nstrlcpy(card->id, c->id, sizeof(card->id));\r\nfor (;;) {\r\nfor (i = 0; i < snd_ecards_limit; i++) {\r\nif (snd_cards[i] && !strcmp(snd_cards[i]->id, card->id))\r\nbreak;\r\n}\r\nif (i >= snd_ecards_limit)\r\nbreak;\r\nn++;\r\nif (n >= SNDRV_CARDS)\r\nbreak;\r\nsnprintf(card->id, sizeof(card->id), "%s_%d", c->id, n);\r\n}\r\n}\r\nis_audigy = emu->audigy = c->emu10k2_chip;\r\nemu->dma_mask = is_audigy ? AUDIGY_DMA_MASK : EMU10K1_DMA_MASK;\r\nif (pci_set_dma_mask(pci, emu->dma_mask) < 0 ||\r\npci_set_consistent_dma_mask(pci, emu->dma_mask) < 0) {\r\nsnd_printk(KERN_ERR "architecture does not support PCI busmaster DMA with mask 0x%lx\n", emu->dma_mask);\r\nkfree(emu);\r\npci_disable_device(pci);\r\nreturn -ENXIO;\r\n}\r\nif (is_audigy)\r\nemu->gpr_base = A_FXGPREGBASE;\r\nelse\r\nemu->gpr_base = FXGPREGBASE;\r\nerr = pci_request_regions(pci, "EMU10K1");\r\nif (err < 0) {\r\nkfree(emu);\r\npci_disable_device(pci);\r\nreturn err;\r\n}\r\nemu->port = pci_resource_start(pci, 0);\r\nemu->max_cache_pages = max_cache_bytes >> PAGE_SHIFT;\r\nif (snd_dma_alloc_pages(SNDRV_DMA_TYPE_DEV, snd_dma_pci_data(pci),\r\n32 * 1024, &emu->ptb_pages) < 0) {\r\nerr = -ENOMEM;\r\ngoto error;\r\n}\r\nemu->page_ptr_table = vmalloc(emu->max_cache_pages * sizeof(void *));\r\nemu->page_addr_table = vmalloc(emu->max_cache_pages *\r\nsizeof(unsigned long));\r\nif (emu->page_ptr_table == NULL || emu->page_addr_table == NULL) {\r\nerr = -ENOMEM;\r\ngoto error;\r\n}\r\nif (snd_dma_alloc_pages(SNDRV_DMA_TYPE_DEV, snd_dma_pci_data(pci),\r\nEMUPAGESIZE, &emu->silent_page) < 0) {\r\nerr = -ENOMEM;\r\ngoto error;\r\n}\r\nemu->memhdr = snd_util_memhdr_new(emu->max_cache_pages * PAGE_SIZE);\r\nif (emu->memhdr == NULL) {\r\nerr = -ENOMEM;\r\ngoto error;\r\n}\r\nemu->memhdr->block_extra_size = sizeof(struct snd_emu10k1_memblk) -\r\nsizeof(struct snd_util_memblk);\r\npci_set_master(pci);\r\nemu->fx8010.fxbus_mask = 0x303f;\r\nif (extin_mask == 0)\r\nextin_mask = 0x3fcf;\r\nif (extout_mask == 0)\r\nextout_mask = 0x7fff;\r\nemu->fx8010.extin_mask = extin_mask;\r\nemu->fx8010.extout_mask = extout_mask;\r\nemu->enable_ir = enable_ir;\r\nif (emu->card_capabilities->ca_cardbus_chip) {\r\nerr = snd_emu10k1_cardbus_init(emu);\r\nif (err < 0)\r\ngoto error;\r\n}\r\nif (emu->card_capabilities->ecard) {\r\nerr = snd_emu10k1_ecard_init(emu);\r\nif (err < 0)\r\ngoto error;\r\n} else if (emu->card_capabilities->emu_model) {\r\nerr = snd_emu10k1_emu1010_init(emu);\r\nif (err < 0) {\r\nsnd_emu10k1_free(emu);\r\nreturn err;\r\n}\r\n} else {\r\nsnd_emu10k1_ptr_write(emu, AC97SLOT, 0,\r\nAC97SLOT_CNTR|AC97SLOT_LFE);\r\n}\r\nemu->fx8010.itram_size = (16 * 1024)/2;\r\nemu->fx8010.etram_pages.area = NULL;\r\nemu->fx8010.etram_pages.bytes = 0;\r\nif (request_irq(pci->irq, snd_emu10k1_interrupt, IRQF_SHARED,\r\nKBUILD_MODNAME, emu)) {\r\nerr = -EBUSY;\r\ngoto error;\r\n}\r\nemu->irq = pci->irq;\r\nemu->spdif_bits[0] = emu->spdif_bits[1] =\r\nemu->spdif_bits[2] = SPCS_CLKACCY_1000PPM | SPCS_SAMPLERATE_48 |\r\nSPCS_CHANNELNUM_LEFT | SPCS_SOURCENUM_UNSPEC |\r\nSPCS_GENERATIONSTATUS | 0x00001200 |\r\n0x00000000 | SPCS_EMPHASIS_NONE | SPCS_COPYRIGHT;\r\nemu->reserved_page = (struct snd_emu10k1_memblk *)\r\nsnd_emu10k1_synth_alloc(emu, 4096);\r\nif (emu->reserved_page)\r\nemu->reserved_page->map_locked = 1;\r\nmemset(emu->silent_page.area, 0, PAGE_SIZE);\r\nsilent_page = emu->silent_page.addr << 1;\r\nfor (idx = 0; idx < MAXPAGES; idx++)\r\n((u32 *)emu->ptb_pages.area)[idx] = cpu_to_le32(silent_page | idx);\r\nfor (idx = 0; idx < NUM_G; idx++) {\r\nemu->voices[idx].emu = emu;\r\nemu->voices[idx].number = idx;\r\n}\r\nerr = snd_emu10k1_init(emu, enable_ir, 0);\r\nif (err < 0)\r\ngoto error;\r\n#ifdef CONFIG_PM_SLEEP\r\nerr = alloc_pm_buffer(emu);\r\nif (err < 0)\r\ngoto error;\r\n#endif\r\nerr = snd_emu10k1_init_efx(emu);\r\nif (err < 0)\r\ngoto error;\r\nsnd_emu10k1_audio_enable(emu);\r\nerr = snd_device_new(card, SNDRV_DEV_LOWLEVEL, emu, &ops);\r\nif (err < 0)\r\ngoto error;\r\n#ifdef CONFIG_PROC_FS\r\nsnd_emu10k1_proc_init(emu);\r\n#endif\r\nsnd_card_set_dev(card, &pci->dev);\r\n*remu = emu;\r\nreturn 0;\r\nerror:\r\nsnd_emu10k1_free(emu);\r\nreturn err;\r\n}\r\nstatic int alloc_pm_buffer(struct snd_emu10k1 *emu)\r\n{\r\nint size;\r\nsize = ARRAY_SIZE(saved_regs);\r\nif (emu->audigy)\r\nsize += ARRAY_SIZE(saved_regs_audigy);\r\nemu->saved_ptr = vmalloc(4 * NUM_G * size);\r\nif (!emu->saved_ptr)\r\nreturn -ENOMEM;\r\nif (snd_emu10k1_efx_alloc_pm_buffer(emu) < 0)\r\nreturn -ENOMEM;\r\nif (emu->card_capabilities->ca0151_chip &&\r\nsnd_p16v_alloc_pm_buffer(emu) < 0)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nstatic void free_pm_buffer(struct snd_emu10k1 *emu)\r\n{\r\nvfree(emu->saved_ptr);\r\nsnd_emu10k1_efx_free_pm_buffer(emu);\r\nif (emu->card_capabilities->ca0151_chip)\r\nsnd_p16v_free_pm_buffer(emu);\r\n}\r\nvoid snd_emu10k1_suspend_regs(struct snd_emu10k1 *emu)\r\n{\r\nint i;\r\nunsigned char *reg;\r\nunsigned int *val;\r\nval = emu->saved_ptr;\r\nfor (reg = saved_regs; *reg != 0xff; reg++)\r\nfor (i = 0; i < NUM_G; i++, val++)\r\n*val = snd_emu10k1_ptr_read(emu, *reg, i);\r\nif (emu->audigy) {\r\nfor (reg = saved_regs_audigy; *reg != 0xff; reg++)\r\nfor (i = 0; i < NUM_G; i++, val++)\r\n*val = snd_emu10k1_ptr_read(emu, *reg, i);\r\n}\r\nif (emu->audigy)\r\nemu->saved_a_iocfg = inl(emu->port + A_IOCFG);\r\nemu->saved_hcfg = inl(emu->port + HCFG);\r\n}\r\nvoid snd_emu10k1_resume_init(struct snd_emu10k1 *emu)\r\n{\r\nif (emu->card_capabilities->ca_cardbus_chip)\r\nsnd_emu10k1_cardbus_init(emu);\r\nif (emu->card_capabilities->ecard)\r\nsnd_emu10k1_ecard_init(emu);\r\nelse if (emu->card_capabilities->emu_model)\r\nsnd_emu10k1_emu1010_init(emu);\r\nelse\r\nsnd_emu10k1_ptr_write(emu, AC97SLOT, 0, AC97SLOT_CNTR|AC97SLOT_LFE);\r\nsnd_emu10k1_init(emu, emu->enable_ir, 1);\r\n}\r\nvoid snd_emu10k1_resume_regs(struct snd_emu10k1 *emu)\r\n{\r\nint i;\r\nunsigned char *reg;\r\nunsigned int *val;\r\nsnd_emu10k1_audio_enable(emu);\r\nif (emu->audigy)\r\noutl(emu->saved_a_iocfg, emu->port + A_IOCFG);\r\noutl(emu->saved_hcfg, emu->port + HCFG);\r\nval = emu->saved_ptr;\r\nfor (reg = saved_regs; *reg != 0xff; reg++)\r\nfor (i = 0; i < NUM_G; i++, val++)\r\nsnd_emu10k1_ptr_write(emu, *reg, i, *val);\r\nif (emu->audigy) {\r\nfor (reg = saved_regs_audigy; *reg != 0xff; reg++)\r\nfor (i = 0; i < NUM_G; i++, val++)\r\nsnd_emu10k1_ptr_write(emu, *reg, i, *val);\r\n}\r\n}

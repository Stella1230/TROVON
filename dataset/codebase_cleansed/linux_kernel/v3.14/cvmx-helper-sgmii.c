static int __cvmx_helper_sgmii_hardware_init_one_time(int interface, int index)\r\n{\r\nconst uint64_t clock_mhz = cvmx_sysinfo_get()->cpu_clock_hz / 1000000;\r\nunion cvmx_pcsx_miscx_ctl_reg pcs_misc_ctl_reg;\r\nunion cvmx_pcsx_linkx_timer_count_reg pcsx_linkx_timer_count_reg;\r\nunion cvmx_gmxx_prtx_cfg gmxx_prtx_cfg;\r\ngmxx_prtx_cfg.u64 = cvmx_read_csr(CVMX_GMXX_PRTX_CFG(index, interface));\r\ngmxx_prtx_cfg.s.en = 0;\r\ncvmx_write_csr(CVMX_GMXX_PRTX_CFG(index, interface), gmxx_prtx_cfg.u64);\r\npcs_misc_ctl_reg.u64 =\r\ncvmx_read_csr(CVMX_PCSX_MISCX_CTL_REG(index, interface));\r\npcsx_linkx_timer_count_reg.u64 =\r\ncvmx_read_csr(CVMX_PCSX_LINKX_TIMER_COUNT_REG(index, interface));\r\nif (pcs_misc_ctl_reg.s.mode) {\r\npcsx_linkx_timer_count_reg.s.count =\r\n(10000ull * clock_mhz) >> 10;\r\n} else {\r\npcsx_linkx_timer_count_reg.s.count =\r\n(1600ull * clock_mhz) >> 10;\r\n}\r\ncvmx_write_csr(CVMX_PCSX_LINKX_TIMER_COUNT_REG(index, interface),\r\npcsx_linkx_timer_count_reg.u64);\r\nif (pcs_misc_ctl_reg.s.mode) {\r\nunion cvmx_pcsx_anx_adv_reg pcsx_anx_adv_reg;\r\npcsx_anx_adv_reg.u64 =\r\ncvmx_read_csr(CVMX_PCSX_ANX_ADV_REG(index, interface));\r\npcsx_anx_adv_reg.s.rem_flt = 0;\r\npcsx_anx_adv_reg.s.pause = 3;\r\npcsx_anx_adv_reg.s.hfd = 1;\r\npcsx_anx_adv_reg.s.fd = 1;\r\ncvmx_write_csr(CVMX_PCSX_ANX_ADV_REG(index, interface),\r\npcsx_anx_adv_reg.u64);\r\n} else {\r\nunion cvmx_pcsx_miscx_ctl_reg pcsx_miscx_ctl_reg;\r\npcsx_miscx_ctl_reg.u64 =\r\ncvmx_read_csr(CVMX_PCSX_MISCX_CTL_REG(index, interface));\r\nif (pcsx_miscx_ctl_reg.s.mac_phy) {\r\nunion cvmx_pcsx_sgmx_an_adv_reg pcsx_sgmx_an_adv_reg;\r\npcsx_sgmx_an_adv_reg.u64 =\r\ncvmx_read_csr(CVMX_PCSX_SGMX_AN_ADV_REG\r\n(index, interface));\r\npcsx_sgmx_an_adv_reg.s.link = 1;\r\npcsx_sgmx_an_adv_reg.s.dup = 1;\r\npcsx_sgmx_an_adv_reg.s.speed = 2;\r\ncvmx_write_csr(CVMX_PCSX_SGMX_AN_ADV_REG\r\n(index, interface),\r\npcsx_sgmx_an_adv_reg.u64);\r\n} else {\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int __cvmx_helper_sgmii_hardware_init_link(int interface, int index)\r\n{\r\nunion cvmx_pcsx_mrx_control_reg control_reg;\r\ncontrol_reg.u64 =\r\ncvmx_read_csr(CVMX_PCSX_MRX_CONTROL_REG(index, interface));\r\nif (cvmx_sysinfo_get()->board_type != CVMX_BOARD_TYPE_SIM) {\r\ncontrol_reg.s.reset = 1;\r\ncvmx_write_csr(CVMX_PCSX_MRX_CONTROL_REG(index, interface),\r\ncontrol_reg.u64);\r\nif (CVMX_WAIT_FOR_FIELD64\r\n(CVMX_PCSX_MRX_CONTROL_REG(index, interface),\r\nunion cvmx_pcsx_mrx_control_reg, reset, ==, 0, 10000)) {\r\ncvmx_dprintf("SGMII%d: Timeout waiting for port %d "\r\n"to finish reset\n",\r\ninterface, index);\r\nreturn -1;\r\n}\r\n}\r\ncontrol_reg.s.rst_an = 1;\r\ncontrol_reg.s.an_en = 1;\r\ncontrol_reg.s.pwr_dn = 0;\r\ncvmx_write_csr(CVMX_PCSX_MRX_CONTROL_REG(index, interface),\r\ncontrol_reg.u64);\r\nif ((cvmx_sysinfo_get()->board_type != CVMX_BOARD_TYPE_SIM) &&\r\nCVMX_WAIT_FOR_FIELD64(CVMX_PCSX_MRX_STATUS_REG(index, interface),\r\nunion cvmx_pcsx_mrx_status_reg, an_cpt, ==, 1,\r\n10000)) {\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __cvmx_helper_sgmii_hardware_init_link_speed(int interface,\r\nint index,\r\ncvmx_helper_link_info_t\r\nlink_info)\r\n{\r\nint is_enabled;\r\nunion cvmx_gmxx_prtx_cfg gmxx_prtx_cfg;\r\nunion cvmx_pcsx_miscx_ctl_reg pcsx_miscx_ctl_reg;\r\ngmxx_prtx_cfg.u64 = cvmx_read_csr(CVMX_GMXX_PRTX_CFG(index, interface));\r\nis_enabled = gmxx_prtx_cfg.s.en;\r\ngmxx_prtx_cfg.s.en = 0;\r\ncvmx_write_csr(CVMX_GMXX_PRTX_CFG(index, interface), gmxx_prtx_cfg.u64);\r\nif (CVMX_WAIT_FOR_FIELD64\r\n(CVMX_GMXX_PRTX_CFG(index, interface), union cvmx_gmxx_prtx_cfg,\r\nrx_idle, ==, 1, 10000)\r\n|| CVMX_WAIT_FOR_FIELD64(CVMX_GMXX_PRTX_CFG(index, interface),\r\nunion cvmx_gmxx_prtx_cfg, tx_idle, ==, 1,\r\n10000)) {\r\ncvmx_dprintf\r\n("SGMII%d: Timeout waiting for port %d to be idle\n",\r\ninterface, index);\r\nreturn -1;\r\n}\r\ngmxx_prtx_cfg.u64 = cvmx_read_csr(CVMX_GMXX_PRTX_CFG(index, interface));\r\npcsx_miscx_ctl_reg.u64 =\r\ncvmx_read_csr(CVMX_PCSX_MISCX_CTL_REG(index, interface));\r\npcsx_miscx_ctl_reg.s.gmxeno = !link_info.s.link_up;\r\nif (link_info.s.link_up)\r\ngmxx_prtx_cfg.s.duplex = link_info.s.full_duplex;\r\nswitch (link_info.s.speed) {\r\ncase 10:\r\ngmxx_prtx_cfg.s.speed = 0;\r\ngmxx_prtx_cfg.s.speed_msb = 1;\r\ngmxx_prtx_cfg.s.slottime = 0;\r\npcsx_miscx_ctl_reg.s.samp_pt = 25;\r\ncvmx_write_csr(CVMX_GMXX_TXX_SLOT(index, interface), 64);\r\ncvmx_write_csr(CVMX_GMXX_TXX_BURST(index, interface), 0);\r\nbreak;\r\ncase 100:\r\ngmxx_prtx_cfg.s.speed = 0;\r\ngmxx_prtx_cfg.s.speed_msb = 0;\r\ngmxx_prtx_cfg.s.slottime = 0;\r\npcsx_miscx_ctl_reg.s.samp_pt = 0x5;\r\ncvmx_write_csr(CVMX_GMXX_TXX_SLOT(index, interface), 64);\r\ncvmx_write_csr(CVMX_GMXX_TXX_BURST(index, interface), 0);\r\nbreak;\r\ncase 1000:\r\ngmxx_prtx_cfg.s.speed = 1;\r\ngmxx_prtx_cfg.s.speed_msb = 0;\r\ngmxx_prtx_cfg.s.slottime = 1;\r\npcsx_miscx_ctl_reg.s.samp_pt = 1;\r\ncvmx_write_csr(CVMX_GMXX_TXX_SLOT(index, interface), 512);\r\ncvmx_write_csr(CVMX_GMXX_TXX_BURST(index, interface), 8192);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\ncvmx_write_csr(CVMX_PCSX_MISCX_CTL_REG(index, interface),\r\npcsx_miscx_ctl_reg.u64);\r\ncvmx_write_csr(CVMX_GMXX_PRTX_CFG(index, interface), gmxx_prtx_cfg.u64);\r\ngmxx_prtx_cfg.u64 = cvmx_read_csr(CVMX_GMXX_PRTX_CFG(index, interface));\r\ngmxx_prtx_cfg.s.en = is_enabled;\r\ncvmx_write_csr(CVMX_GMXX_PRTX_CFG(index, interface), gmxx_prtx_cfg.u64);\r\nreturn 0;\r\n}\r\nstatic int __cvmx_helper_sgmii_hardware_init(int interface, int num_ports)\r\n{\r\nint index;\r\n__cvmx_helper_setup_gmx(interface, num_ports);\r\nfor (index = 0; index < num_ports; index++) {\r\nint ipd_port = cvmx_helper_get_ipd_port(interface, index);\r\n__cvmx_helper_sgmii_hardware_init_one_time(interface, index);\r\n__cvmx_helper_sgmii_link_set(ipd_port,\r\n__cvmx_helper_sgmii_link_get\r\n(ipd_port));\r\n}\r\nreturn 0;\r\n}\r\nint __cvmx_helper_sgmii_enumerate(int interface)\r\n{\r\nreturn 4;\r\n}\r\nint __cvmx_helper_sgmii_probe(int interface)\r\n{\r\nunion cvmx_gmxx_inf_mode mode;\r\nmode.u64 = cvmx_read_csr(CVMX_GMXX_INF_MODE(interface));\r\nmode.s.en = 1;\r\ncvmx_write_csr(CVMX_GMXX_INF_MODE(interface), mode.u64);\r\nreturn __cvmx_helper_sgmii_enumerate(interface);\r\n}\r\nint __cvmx_helper_sgmii_enable(int interface)\r\n{\r\nint num_ports = cvmx_helper_ports_on_interface(interface);\r\nint index;\r\n__cvmx_helper_sgmii_hardware_init(interface, num_ports);\r\nfor (index = 0; index < num_ports; index++) {\r\nunion cvmx_gmxx_prtx_cfg gmxx_prtx_cfg;\r\ngmxx_prtx_cfg.u64 =\r\ncvmx_read_csr(CVMX_GMXX_PRTX_CFG(index, interface));\r\ngmxx_prtx_cfg.s.en = 1;\r\ncvmx_write_csr(CVMX_GMXX_PRTX_CFG(index, interface),\r\ngmxx_prtx_cfg.u64);\r\n__cvmx_interrupt_pcsx_intx_en_reg_enable(index, interface);\r\n}\r\n__cvmx_interrupt_pcsxx_int_en_reg_enable(interface);\r\n__cvmx_interrupt_gmxx_enable(interface);\r\nreturn 0;\r\n}\r\ncvmx_helper_link_info_t __cvmx_helper_sgmii_link_get(int ipd_port)\r\n{\r\ncvmx_helper_link_info_t result;\r\nunion cvmx_pcsx_miscx_ctl_reg pcs_misc_ctl_reg;\r\nint interface = cvmx_helper_get_interface_num(ipd_port);\r\nint index = cvmx_helper_get_interface_index_num(ipd_port);\r\nunion cvmx_pcsx_mrx_control_reg pcsx_mrx_control_reg;\r\nresult.u64 = 0;\r\nif (cvmx_sysinfo_get()->board_type == CVMX_BOARD_TYPE_SIM) {\r\nresult.s.link_up = 1;\r\nresult.s.full_duplex = 1;\r\nresult.s.speed = 1000;\r\nreturn result;\r\n}\r\npcsx_mrx_control_reg.u64 =\r\ncvmx_read_csr(CVMX_PCSX_MRX_CONTROL_REG(index, interface));\r\nif (pcsx_mrx_control_reg.s.loopbck1) {\r\nresult.s.link_up = 1;\r\nresult.s.full_duplex = 1;\r\nresult.s.speed = 1000;\r\nreturn result;\r\n}\r\npcs_misc_ctl_reg.u64 =\r\ncvmx_read_csr(CVMX_PCSX_MISCX_CTL_REG(index, interface));\r\nif (pcs_misc_ctl_reg.s.mode) {\r\n} else {\r\nunion cvmx_pcsx_miscx_ctl_reg pcsx_miscx_ctl_reg;\r\npcsx_miscx_ctl_reg.u64 =\r\ncvmx_read_csr(CVMX_PCSX_MISCX_CTL_REG(index, interface));\r\nif (pcsx_miscx_ctl_reg.s.mac_phy) {\r\nunion cvmx_pcsx_mrx_status_reg pcsx_mrx_status_reg;\r\nunion cvmx_pcsx_anx_results_reg pcsx_anx_results_reg;\r\npcsx_mrx_status_reg.u64 =\r\ncvmx_read_csr(CVMX_PCSX_MRX_STATUS_REG\r\n(index, interface));\r\nif (pcsx_mrx_status_reg.s.lnk_st == 0) {\r\nif (__cvmx_helper_sgmii_hardware_init_link\r\n(interface, index) != 0)\r\nreturn result;\r\n}\r\npcsx_anx_results_reg.u64 =\r\ncvmx_read_csr(CVMX_PCSX_ANX_RESULTS_REG\r\n(index, interface));\r\nif (pcsx_anx_results_reg.s.an_cpt) {\r\nresult.s.full_duplex =\r\npcsx_anx_results_reg.s.dup;\r\nresult.s.link_up =\r\npcsx_anx_results_reg.s.link_ok;\r\nswitch (pcsx_anx_results_reg.s.spd) {\r\ncase 0:\r\nresult.s.speed = 10;\r\nbreak;\r\ncase 1:\r\nresult.s.speed = 100;\r\nbreak;\r\ncase 2:\r\nresult.s.speed = 1000;\r\nbreak;\r\ndefault:\r\nresult.s.speed = 0;\r\nresult.s.link_up = 0;\r\nbreak;\r\n}\r\n} else {\r\nresult.s.speed = 0;\r\nresult.s.link_up = 0;\r\n}\r\n} else {\r\nresult = __cvmx_helper_board_link_get(ipd_port);\r\n}\r\n}\r\nreturn result;\r\n}\r\nint __cvmx_helper_sgmii_link_set(int ipd_port,\r\ncvmx_helper_link_info_t link_info)\r\n{\r\nint interface = cvmx_helper_get_interface_num(ipd_port);\r\nint index = cvmx_helper_get_interface_index_num(ipd_port);\r\n__cvmx_helper_sgmii_hardware_init_link(interface, index);\r\nreturn __cvmx_helper_sgmii_hardware_init_link_speed(interface, index,\r\nlink_info);\r\n}\r\nint __cvmx_helper_sgmii_configure_loopback(int ipd_port, int enable_internal,\r\nint enable_external)\r\n{\r\nint interface = cvmx_helper_get_interface_num(ipd_port);\r\nint index = cvmx_helper_get_interface_index_num(ipd_port);\r\nunion cvmx_pcsx_mrx_control_reg pcsx_mrx_control_reg;\r\nunion cvmx_pcsx_miscx_ctl_reg pcsx_miscx_ctl_reg;\r\npcsx_mrx_control_reg.u64 =\r\ncvmx_read_csr(CVMX_PCSX_MRX_CONTROL_REG(index, interface));\r\npcsx_mrx_control_reg.s.loopbck1 = enable_internal;\r\ncvmx_write_csr(CVMX_PCSX_MRX_CONTROL_REG(index, interface),\r\npcsx_mrx_control_reg.u64);\r\npcsx_miscx_ctl_reg.u64 =\r\ncvmx_read_csr(CVMX_PCSX_MISCX_CTL_REG(index, interface));\r\npcsx_miscx_ctl_reg.s.loopbck2 = enable_external;\r\ncvmx_write_csr(CVMX_PCSX_MISCX_CTL_REG(index, interface),\r\npcsx_miscx_ctl_reg.u64);\r\n__cvmx_helper_sgmii_hardware_init_link(interface, index);\r\nreturn 0;\r\n}

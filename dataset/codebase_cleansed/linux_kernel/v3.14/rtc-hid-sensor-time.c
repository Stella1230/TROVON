static int hid_time_proc_event(struct hid_sensor_hub_device *hsdev,\r\nunsigned usage_id, void *priv)\r\n{\r\nunsigned long flags;\r\nstruct hid_time_state *time_state = platform_get_drvdata(priv);\r\nspin_lock_irqsave(&time_state->lock_last_time, flags);\r\ntime_state->last_time = time_state->time_buf;\r\nspin_unlock_irqrestore(&time_state->lock_last_time, flags);\r\ncomplete(&time_state->comp_last_time);\r\nreturn 0;\r\n}\r\nstatic u32 hid_time_value(size_t raw_len, char *raw_data)\r\n{\r\nswitch (raw_len) {\r\ncase 1:\r\nreturn *(u8 *)raw_data;\r\ncase 2:\r\nreturn *(u16 *)raw_data;\r\ncase 4:\r\nreturn *(u32 *)raw_data;\r\ndefault:\r\nreturn (u32)(~0U);\r\n}\r\n}\r\nstatic int hid_time_capture_sample(struct hid_sensor_hub_device *hsdev,\r\nunsigned usage_id, size_t raw_len,\r\nchar *raw_data, void *priv)\r\n{\r\nstruct hid_time_state *time_state = platform_get_drvdata(priv);\r\nstruct rtc_time *time_buf = &time_state->time_buf;\r\nswitch (usage_id) {\r\ncase HID_USAGE_SENSOR_TIME_YEAR:\r\nif (raw_len == 1) {\r\ntime_buf->tm_year = *(u8 *)raw_data;\r\nif (time_buf->tm_year < 70)\r\ntime_buf->tm_year += 100;\r\n} else\r\ntime_buf->tm_year =\r\n(int)hid_time_value(raw_len, raw_data)-1900;\r\nbreak;\r\ncase HID_USAGE_SENSOR_TIME_MONTH:\r\ntime_buf->tm_mon = (int)hid_time_value(raw_len, raw_data)-1;\r\nbreak;\r\ncase HID_USAGE_SENSOR_TIME_DAY:\r\ntime_buf->tm_mday = (int)hid_time_value(raw_len, raw_data);\r\nbreak;\r\ncase HID_USAGE_SENSOR_TIME_HOUR:\r\ntime_buf->tm_hour = (int)hid_time_value(raw_len, raw_data);\r\nbreak;\r\ncase HID_USAGE_SENSOR_TIME_MINUTE:\r\ntime_buf->tm_min = (int)hid_time_value(raw_len, raw_data);\r\nbreak;\r\ncase HID_USAGE_SENSOR_TIME_SECOND:\r\ntime_buf->tm_sec = (int)hid_time_value(raw_len, raw_data);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic const char *hid_time_attrib_name(u32 attrib_id)\r\n{\r\nstatic const char unknown[] = "unknown";\r\nunsigned i;\r\nfor (i = 0; i < TIME_RTC_CHANNEL_MAX; ++i) {\r\nif (hid_time_addresses[i] == attrib_id)\r\nreturn hid_time_channel_names[i];\r\n}\r\nreturn unknown;\r\n}\r\nstatic int hid_time_parse_report(struct platform_device *pdev,\r\nstruct hid_sensor_hub_device *hsdev,\r\nunsigned usage_id,\r\nstruct hid_time_state *time_state)\r\n{\r\nint report_id, i;\r\nfor (i = 0; i < TIME_RTC_CHANNEL_MAX; ++i)\r\nif (sensor_hub_input_get_attribute_info(hsdev,\r\nHID_INPUT_REPORT, usage_id,\r\nhid_time_addresses[i],\r\n&time_state->info[i]) < 0)\r\nreturn -EINVAL;\r\nreport_id = time_state->info[0].report_id;\r\nif (report_id < 0) {\r\ndev_err(&pdev->dev, "bad report ID!\n");\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; i < TIME_RTC_CHANNEL_MAX; ++i) {\r\nif (time_state->info[i].report_id != report_id) {\r\ndev_err(&pdev->dev,\r\n"not all needed attributes inside the same report!\n");\r\nreturn -EINVAL;\r\n}\r\nif (time_state->info[i].size == 3 ||\r\ntime_state->info[i].size > 4) {\r\ndev_err(&pdev->dev,\r\n"attribute '%s' not 8, 16 or 32 bits wide!\n",\r\nhid_time_attrib_name(\r\ntime_state->info[i].attrib_id));\r\nreturn -EINVAL;\r\n}\r\nif (time_state->info[i].units !=\r\nHID_USAGE_SENSOR_UNITS_NOT_SPECIFIED &&\r\n!(time_state->info[i].attrib_id ==\r\nHID_USAGE_SENSOR_TIME_SECOND &&\r\ntime_state->info[i].units ==\r\nHID_USAGE_SENSOR_UNITS_SECOND)) {\r\ndev_err(&pdev->dev,\r\n"attribute '%s' hasn't a unit of type 'none'!\n",\r\nhid_time_attrib_name(\r\ntime_state->info[i].attrib_id));\r\nreturn -EINVAL;\r\n}\r\nif (time_state->info[i].unit_expo) {\r\ndev_err(&pdev->dev,\r\n"attribute '%s' hasn't a unit exponent of 1!\n",\r\nhid_time_attrib_name(\r\ntime_state->info[i].attrib_id));\r\nreturn -EINVAL;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int hid_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nunsigned long flags;\r\nstruct hid_time_state *time_state =\r\nplatform_get_drvdata(to_platform_device(dev));\r\nint ret;\r\nreinit_completion(&time_state->comp_last_time);\r\nsensor_hub_input_attr_get_raw_value(time_state->common_attributes.hsdev,\r\nHID_USAGE_SENSOR_TIME, hid_time_addresses[0],\r\ntime_state->info[0].report_id);\r\nret = wait_for_completion_killable_timeout(\r\n&time_state->comp_last_time, HZ*6);\r\nif (ret > 0) {\r\nspin_lock_irqsave(&time_state->lock_last_time, flags);\r\n*tm = time_state->last_time;\r\nspin_unlock_irqrestore(&time_state->lock_last_time, flags);\r\nreturn 0;\r\n}\r\nif (!ret)\r\nreturn -EIO;\r\nreturn ret;\r\n}\r\nstatic int hid_time_probe(struct platform_device *pdev)\r\n{\r\nint ret = 0;\r\nstruct hid_sensor_hub_device *hsdev = dev_get_platdata(&pdev->dev);\r\nstruct hid_time_state *time_state = devm_kzalloc(&pdev->dev,\r\nsizeof(struct hid_time_state), GFP_KERNEL);\r\nif (time_state == NULL)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, time_state);\r\nspin_lock_init(&time_state->lock_last_time);\r\ninit_completion(&time_state->comp_last_time);\r\ntime_state->common_attributes.hsdev = hsdev;\r\ntime_state->common_attributes.pdev = pdev;\r\nret = hid_sensor_parse_common_attributes(hsdev,\r\nHID_USAGE_SENSOR_TIME,\r\n&time_state->common_attributes);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to setup common attributes!\n");\r\nreturn ret;\r\n}\r\nret = hid_time_parse_report(pdev, hsdev, HID_USAGE_SENSOR_TIME,\r\ntime_state);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to setup attributes!\n");\r\nreturn ret;\r\n}\r\ntime_state->callbacks.send_event = hid_time_proc_event;\r\ntime_state->callbacks.capture_sample = hid_time_capture_sample;\r\ntime_state->callbacks.pdev = pdev;\r\nret = sensor_hub_register_callback(hsdev, HID_USAGE_SENSOR_TIME,\r\n&time_state->callbacks);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "register callback failed!\n");\r\nreturn ret;\r\n}\r\nret = sensor_hub_device_open(hsdev);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to open sensor hub device!\n");\r\ngoto err_open;\r\n}\r\nhid_device_io_start(hsdev->hdev);\r\ntime_state->rtc = devm_rtc_device_register(&pdev->dev,\r\n"hid-sensor-time", &hid_time_rtc_ops,\r\nTHIS_MODULE);\r\nif (IS_ERR_OR_NULL(time_state->rtc)) {\r\nhid_device_io_stop(hsdev->hdev);\r\nret = time_state->rtc ? PTR_ERR(time_state->rtc) : -ENODEV;\r\ntime_state->rtc = NULL;\r\ndev_err(&pdev->dev, "rtc device register failed!\n");\r\ngoto err_rtc;\r\n}\r\nreturn ret;\r\nerr_rtc:\r\nsensor_hub_device_close(hsdev);\r\nerr_open:\r\nsensor_hub_remove_callback(hsdev, HID_USAGE_SENSOR_TIME);\r\nreturn ret;\r\n}\r\nstatic int hid_time_remove(struct platform_device *pdev)\r\n{\r\nstruct hid_sensor_hub_device *hsdev = dev_get_platdata(&pdev->dev);\r\nsensor_hub_device_close(hsdev);\r\nsensor_hub_remove_callback(hsdev, HID_USAGE_SENSOR_TIME);\r\nreturn 0;\r\n}

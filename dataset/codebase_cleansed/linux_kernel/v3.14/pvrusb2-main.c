static void pvr_setup_attach(struct pvr2_context *pvr)\r\n{\r\npvr2_v4l2_create(pvr);\r\n#ifdef CONFIG_VIDEO_PVRUSB2_DVB\r\npvr2_dvb_create(pvr);\r\n#endif\r\n#ifdef CONFIG_VIDEO_PVRUSB2_SYSFS\r\npvr2_sysfs_create(pvr,class_ptr);\r\n#endif\r\n}\r\nstatic int pvr_probe(struct usb_interface *intf,\r\nconst struct usb_device_id *devid)\r\n{\r\nstruct pvr2_context *pvr;\r\npvr = pvr2_context_create(intf,devid,pvr_setup_attach);\r\nif (!pvr) {\r\npvr2_trace(PVR2_TRACE_ERROR_LEGS,\r\n"Failed to create hdw handler");\r\nreturn -ENOMEM;\r\n}\r\npvr2_trace(PVR2_TRACE_INIT,"pvr_probe(pvr=%p)",pvr);\r\nusb_set_intfdata(intf, pvr);\r\nreturn 0;\r\n}\r\nstatic void pvr_disconnect(struct usb_interface *intf)\r\n{\r\nstruct pvr2_context *pvr = usb_get_intfdata(intf);\r\npvr2_trace(PVR2_TRACE_INIT,"pvr_disconnect(pvr=%p) BEGIN",pvr);\r\nusb_set_intfdata (intf, NULL);\r\npvr2_context_disconnect(pvr);\r\npvr2_trace(PVR2_TRACE_INIT,"pvr_disconnect(pvr=%p) DONE",pvr);\r\n}\r\nstatic int __init pvr_init(void)\r\n{\r\nint ret;\r\npvr2_trace(PVR2_TRACE_INIT,"pvr_init");\r\nret = pvr2_context_global_init();\r\nif (ret != 0) {\r\npvr2_trace(PVR2_TRACE_INIT,"pvr_init failure code=%d",ret);\r\nreturn ret;\r\n}\r\n#ifdef CONFIG_VIDEO_PVRUSB2_SYSFS\r\nclass_ptr = pvr2_sysfs_class_create();\r\n#endif\r\nret = usb_register(&pvr_driver);\r\nif (ret == 0)\r\nprintk(KERN_INFO "pvrusb2: " DRIVER_VERSION ":"\r\nDRIVER_DESC "\n");\r\nif (pvrusb2_debug)\r\nprintk(KERN_INFO "pvrusb2: Debug mask is %d (0x%x)\n",\r\npvrusb2_debug,pvrusb2_debug);\r\npvr2_trace(PVR2_TRACE_INIT,"pvr_init complete");\r\nreturn ret;\r\n}\r\nstatic void __exit pvr_exit(void)\r\n{\r\npvr2_trace(PVR2_TRACE_INIT,"pvr_exit");\r\nusb_deregister(&pvr_driver);\r\npvr2_context_global_done();\r\n#ifdef CONFIG_VIDEO_PVRUSB2_SYSFS\r\npvr2_sysfs_class_destroy(class_ptr);\r\n#endif\r\npvr2_trace(PVR2_TRACE_INIT,"pvr_exit complete");\r\n}

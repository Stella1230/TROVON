static void start_fw_load(struct i2c_client *client)\r\n{\r\ncx25840_write(client, 0x800, 0x00);\r\ncx25840_write(client, 0x801, 0x00);\r\ncx25840_write(client, 0x803, 0x0b);\r\ncx25840_write(client, 0x000, 0x20);\r\n}\r\nstatic void end_fw_load(struct i2c_client *client)\r\n{\r\ncx25840_write(client, 0x000, 0x00);\r\ncx25840_write(client, 0x803, 0x03);\r\n}\r\nstatic const char *get_fw_name(struct i2c_client *client)\r\n{\r\nstruct cx25840_state *state = to_state(i2c_get_clientdata(client));\r\nif (firmware[0])\r\nreturn firmware;\r\nif (is_cx2388x(state))\r\nreturn CX2388x_FIRMWARE;\r\nif (is_cx231xx(state))\r\nreturn CX231xx_FIRMWARE;\r\nreturn CX25840_FIRMWARE;\r\n}\r\nstatic int check_fw_load(struct i2c_client *client, int size)\r\n{\r\nint s = cx25840_read(client, 0x801) << 8;\r\ns |= cx25840_read(client, 0x800);\r\nif (size != s) {\r\nv4l_err(client, "firmware %s load failed\n",\r\nget_fw_name(client));\r\nreturn -EINVAL;\r\n}\r\nv4l_info(client, "loaded %s firmware (%d bytes)\n",\r\nget_fw_name(client), size);\r\nreturn 0;\r\n}\r\nstatic int fw_write(struct i2c_client *client, const u8 *data, int size)\r\n{\r\nif (i2c_master_send(client, data, size) < size) {\r\nv4l_err(client, "firmware load i2c failure\n");\r\nreturn -ENOSYS;\r\n}\r\nreturn 0;\r\n}\r\nint cx25840_loadfw(struct i2c_client *client)\r\n{\r\nstruct cx25840_state *state = to_state(i2c_get_clientdata(client));\r\nconst struct firmware *fw = NULL;\r\nu8 buffer[FWSEND];\r\nconst u8 *ptr;\r\nconst char *fwname = get_fw_name(client);\r\nint size, retval;\r\nint MAX_BUF_SIZE = FWSEND;\r\nu32 gpio_oe = 0, gpio_da = 0;\r\nif (is_cx2388x(state)) {\r\ngpio_oe = cx25840_read(client, 0x160);\r\ngpio_da = cx25840_read(client, 0x164);\r\n}\r\nif (is_cx231xx(state) && MAX_BUF_SIZE > 16) {\r\nv4l_err(client, " Firmware download size changed to 16 bytes max length\n");\r\nMAX_BUF_SIZE = 16;\r\n}\r\nif (request_firmware(&fw, fwname, FWDEV(client)) != 0) {\r\nv4l_err(client, "unable to open firmware %s\n", fwname);\r\nreturn -EINVAL;\r\n}\r\nstart_fw_load(client);\r\nbuffer[0] = 0x08;\r\nbuffer[1] = 0x02;\r\nsize = fw->size;\r\nptr = fw->data;\r\nwhile (size > 0) {\r\nint len = min(MAX_BUF_SIZE - 2, size);\r\nmemcpy(buffer + 2, ptr, len);\r\nretval = fw_write(client, buffer, len + 2);\r\nif (retval < 0) {\r\nrelease_firmware(fw);\r\nreturn retval;\r\n}\r\nsize -= len;\r\nptr += len;\r\n}\r\nend_fw_load(client);\r\nsize = fw->size;\r\nrelease_firmware(fw);\r\nif (is_cx2388x(state)) {\r\ncx25840_write(client, 0x160, gpio_oe);\r\ncx25840_write(client, 0x164, gpio_da);\r\n}\r\nreturn check_fw_load(client, size);\r\n}

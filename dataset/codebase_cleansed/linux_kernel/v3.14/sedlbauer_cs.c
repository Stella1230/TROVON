static int sedlbauer_probe(struct pcmcia_device *link)\r\n{\r\nlocal_info_t *local;\r\ndev_dbg(&link->dev, "sedlbauer_attach()\n");\r\nlocal = kzalloc(sizeof(local_info_t), GFP_KERNEL);\r\nif (!local) return -ENOMEM;\r\nlocal->cardnr = -1;\r\nlocal->p_dev = link;\r\nlink->priv = local;\r\nreturn sedlbauer_config(link);\r\n}\r\nstatic void sedlbauer_detach(struct pcmcia_device *link)\r\n{\r\ndev_dbg(&link->dev, "sedlbauer_detach(0x%p)\n", link);\r\n((local_info_t *)link->priv)->stop = 1;\r\nsedlbauer_release(link);\r\nkfree(link->priv);\r\n}\r\nstatic int sedlbauer_config_check(struct pcmcia_device *p_dev, void *priv_data)\r\n{\r\nif (p_dev->config_index == 0)\r\nreturn -EINVAL;\r\np_dev->io_lines = 3;\r\nreturn pcmcia_request_io(p_dev);\r\n}\r\nstatic int sedlbauer_config(struct pcmcia_device *link)\r\n{\r\nint ret;\r\nIsdnCard_t icard;\r\ndev_dbg(&link->dev, "sedlbauer_config(0x%p)\n", link);\r\nlink->config_flags |= CONF_ENABLE_IRQ | CONF_AUTO_CHECK_VCC |\r\nCONF_AUTO_SET_VPP | CONF_AUTO_AUDIO | CONF_AUTO_SET_IO;\r\nret = pcmcia_loop_config(link, sedlbauer_config_check, NULL);\r\nif (ret)\r\ngoto failed;\r\nret = pcmcia_enable_device(link);\r\nif (ret)\r\ngoto failed;\r\nicard.para[0] = link->irq;\r\nicard.para[1] = link->resource[0]->start;\r\nicard.protocol = protocol;\r\nicard.typ = ISDN_CTYPE_SEDLBAUER_PCMCIA;\r\nret = hisax_init_pcmcia(link,\r\n&(((local_info_t *)link->priv)->stop), &icard);\r\nif (ret < 0) {\r\nprintk(KERN_ERR "sedlbauer_cs: failed to initialize SEDLBAUER PCMCIA %d with %pR\n",\r\nret, link->resource[0]);\r\nsedlbauer_release(link);\r\nreturn -ENODEV;\r\n} else\r\n((local_info_t *)link->priv)->cardnr = ret;\r\nreturn 0;\r\nfailed:\r\nsedlbauer_release(link);\r\nreturn -ENODEV;\r\n}\r\nstatic void sedlbauer_release(struct pcmcia_device *link)\r\n{\r\nlocal_info_t *local = link->priv;\r\ndev_dbg(&link->dev, "sedlbauer_release(0x%p)\n", link);\r\nif (local) {\r\nif (local->cardnr >= 0) {\r\nHiSax_closecard(local->cardnr);\r\n}\r\n}\r\npcmcia_disable_device(link);\r\n}\r\nstatic int sedlbauer_suspend(struct pcmcia_device *link)\r\n{\r\nlocal_info_t *dev = link->priv;\r\ndev->stop = 1;\r\nreturn 0;\r\n}\r\nstatic int sedlbauer_resume(struct pcmcia_device *link)\r\n{\r\nlocal_info_t *dev = link->priv;\r\ndev->stop = 0;\r\nreturn 0;\r\n}

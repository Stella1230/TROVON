static int ab8500_pwm_config(struct pwm_chip *chip, struct pwm_device *pwm,\r\nint duty_ns, int period_ns)\r\n{\r\nint ret = 0;\r\nunsigned int higher_val, lower_val;\r\nu8 reg;\r\nlower_val = duty_ns & 0x00FF;\r\nhigher_val = ((duty_ns & 0x0300) >> 8);\r\nreg = AB8500_PWM_OUT_CTRL1_REG + ((chip->base - 1) * 2);\r\nret = abx500_set_register_interruptible(chip->dev, AB8500_MISC,\r\nreg, (u8)lower_val);\r\nif (ret < 0)\r\nreturn ret;\r\nret = abx500_set_register_interruptible(chip->dev, AB8500_MISC,\r\n(reg + 1), (u8)higher_val);\r\nreturn ret;\r\n}\r\nstatic int ab8500_pwm_enable(struct pwm_chip *chip, struct pwm_device *pwm)\r\n{\r\nint ret;\r\nret = abx500_mask_and_set_register_interruptible(chip->dev,\r\nAB8500_MISC, AB8500_PWM_OUT_CTRL7_REG,\r\n1 << (chip->base - 1), ENABLE_PWM);\r\nif (ret < 0)\r\ndev_err(chip->dev, "%s: Failed to enable PWM, Error %d\n",\r\npwm->label, ret);\r\nreturn ret;\r\n}\r\nstatic void ab8500_pwm_disable(struct pwm_chip *chip, struct pwm_device *pwm)\r\n{\r\nint ret;\r\nret = abx500_mask_and_set_register_interruptible(chip->dev,\r\nAB8500_MISC, AB8500_PWM_OUT_CTRL7_REG,\r\n1 << (chip->base - 1), DISABLE_PWM);\r\nif (ret < 0)\r\ndev_err(chip->dev, "%s: Failed to disable PWM, Error %d\n",\r\npwm->label, ret);\r\nreturn;\r\n}\r\nstatic int ab8500_pwm_probe(struct platform_device *pdev)\r\n{\r\nstruct ab8500_pwm_chip *ab8500;\r\nint err;\r\nab8500 = devm_kzalloc(&pdev->dev, sizeof(*ab8500), GFP_KERNEL);\r\nif (ab8500 == NULL) {\r\ndev_err(&pdev->dev, "failed to allocate memory\n");\r\nreturn -ENOMEM;\r\n}\r\nab8500->chip.dev = &pdev->dev;\r\nab8500->chip.ops = &ab8500_pwm_ops;\r\nab8500->chip.base = pdev->id;\r\nab8500->chip.npwm = 1;\r\nerr = pwmchip_add(&ab8500->chip);\r\nif (err < 0)\r\nreturn err;\r\ndev_dbg(&pdev->dev, "pwm probe successful\n");\r\nplatform_set_drvdata(pdev, ab8500);\r\nreturn 0;\r\n}\r\nstatic int ab8500_pwm_remove(struct platform_device *pdev)\r\n{\r\nstruct ab8500_pwm_chip *ab8500 = platform_get_drvdata(pdev);\r\nint err;\r\nerr = pwmchip_remove(&ab8500->chip);\r\nif (err < 0)\r\nreturn err;\r\ndev_dbg(&pdev->dev, "pwm driver removed\n");\r\nreturn 0;\r\n}

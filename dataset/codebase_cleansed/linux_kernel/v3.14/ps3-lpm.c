static struct device *sbd_core(void)\r\n{\r\nBUG_ON(!lpm_priv || !lpm_priv->sbd);\r\nreturn &lpm_priv->sbd->core;\r\n}\r\nvoid ps3_set_bookmark(u64 bookmark)\r\n{\r\nasm volatile("nop;nop;nop;nop;nop;nop;nop;nop;nop;");\r\nmtspr(SPRN_BKMK, bookmark);\r\nasm volatile("nop;nop;nop;nop;nop;nop;nop;nop;nop;");\r\n}\r\nvoid ps3_set_pm_bookmark(u64 tag, u64 incident, u64 th_id)\r\n{\r\nu64 bookmark;\r\nbookmark = (get_tb() & 0x00000000FFFFFFFFULL) |\r\nPS3_PM_BOOKMARK_TAG_KERNEL;\r\nbookmark = ((tag << 56) & PS3_PM_BOOKMARK_TAG_MASK_LO) |\r\n(incident << 48) | (th_id << 32) | bookmark;\r\nps3_set_bookmark(bookmark);\r\n}\r\nu32 ps3_read_phys_ctr(u32 cpu, u32 phys_ctr)\r\n{\r\nint result;\r\nu64 counter0415;\r\nu64 counter2637;\r\nif (phys_ctr >= NR_PHYS_CTRS) {\r\ndev_dbg(sbd_core(), "%s:%u: phys_ctr too big: %u\n", __func__,\r\n__LINE__, phys_ctr);\r\nreturn 0;\r\n}\r\nresult = lv1_set_lpm_counter(lpm_priv->lpm_id, 0, 0, 0, 0, &counter0415,\r\n&counter2637);\r\nif (result) {\r\ndev_err(sbd_core(), "%s:%u: lv1_set_lpm_counter failed: "\r\n"phys_ctr %u, %s\n", __func__, __LINE__, phys_ctr,\r\nps3_result(result));\r\nreturn 0;\r\n}\r\nswitch (phys_ctr) {\r\ncase 0:\r\nreturn counter0415 >> 32;\r\ncase 1:\r\nreturn counter0415 & PS3_PM_COUNTER_MASK_LO;\r\ncase 2:\r\nreturn counter2637 >> 32;\r\ncase 3:\r\nreturn counter2637 & PS3_PM_COUNTER_MASK_LO;\r\ndefault:\r\nBUG();\r\n}\r\nreturn 0;\r\n}\r\nvoid ps3_write_phys_ctr(u32 cpu, u32 phys_ctr, u32 val)\r\n{\r\nu64 counter0415;\r\nu64 counter0415_mask;\r\nu64 counter2637;\r\nu64 counter2637_mask;\r\nint result;\r\nif (phys_ctr >= NR_PHYS_CTRS) {\r\ndev_dbg(sbd_core(), "%s:%u: phys_ctr too big: %u\n", __func__,\r\n__LINE__, phys_ctr);\r\nreturn;\r\n}\r\nswitch (phys_ctr) {\r\ncase 0:\r\ncounter0415 = (u64)val << 32;\r\ncounter0415_mask = PS3_PM_COUNTER_MASK_HI;\r\ncounter2637 = 0x0;\r\ncounter2637_mask = 0x0;\r\nbreak;\r\ncase 1:\r\ncounter0415 = (u64)val;\r\ncounter0415_mask = PS3_PM_COUNTER_MASK_LO;\r\ncounter2637 = 0x0;\r\ncounter2637_mask = 0x0;\r\nbreak;\r\ncase 2:\r\ncounter0415 = 0x0;\r\ncounter0415_mask = 0x0;\r\ncounter2637 = (u64)val << 32;\r\ncounter2637_mask = PS3_PM_COUNTER_MASK_HI;\r\nbreak;\r\ncase 3:\r\ncounter0415 = 0x0;\r\ncounter0415_mask = 0x0;\r\ncounter2637 = (u64)val;\r\ncounter2637_mask = PS3_PM_COUNTER_MASK_LO;\r\nbreak;\r\ndefault:\r\nBUG();\r\n}\r\nresult = lv1_set_lpm_counter(lpm_priv->lpm_id,\r\ncounter0415, counter0415_mask,\r\ncounter2637, counter2637_mask,\r\n&counter0415, &counter2637);\r\nif (result)\r\ndev_err(sbd_core(), "%s:%u: lv1_set_lpm_counter failed: "\r\n"phys_ctr %u, val %u, %s\n", __func__, __LINE__,\r\nphys_ctr, val, ps3_result(result));\r\n}\r\nu32 ps3_read_ctr(u32 cpu, u32 ctr)\r\n{\r\nu32 val;\r\nu32 phys_ctr = ctr & (NR_PHYS_CTRS - 1);\r\nval = ps3_read_phys_ctr(cpu, phys_ctr);\r\nif (ps3_get_ctr_size(cpu, phys_ctr) == 16)\r\nval = (ctr < NR_PHYS_CTRS) ? (val >> 16) : (val & 0xffff);\r\nreturn val;\r\n}\r\nvoid ps3_write_ctr(u32 cpu, u32 ctr, u32 val)\r\n{\r\nu32 phys_ctr;\r\nu32 phys_val;\r\nphys_ctr = ctr & (NR_PHYS_CTRS - 1);\r\nif (ps3_get_ctr_size(cpu, phys_ctr) == 16) {\r\nphys_val = ps3_read_phys_ctr(cpu, phys_ctr);\r\nif (ctr < NR_PHYS_CTRS)\r\nval = (val << 16) | (phys_val & 0xffff);\r\nelse\r\nval = (val & 0xffff) | (phys_val & 0xffff0000);\r\n}\r\nps3_write_phys_ctr(cpu, phys_ctr, val);\r\n}\r\nu32 ps3_read_pm07_control(u32 cpu, u32 ctr)\r\n{\r\nreturn 0;\r\n}\r\nvoid ps3_write_pm07_control(u32 cpu, u32 ctr, u32 val)\r\n{\r\nint result;\r\nstatic const u64 mask = 0xFFFFFFFFFFFFFFFFULL;\r\nu64 old_value;\r\nif (ctr >= NR_CTRS) {\r\ndev_dbg(sbd_core(), "%s:%u: ctr too big: %u\n", __func__,\r\n__LINE__, ctr);\r\nreturn;\r\n}\r\nresult = lv1_set_lpm_counter_control(lpm_priv->lpm_id, ctr, val, mask,\r\n&old_value);\r\nif (result)\r\ndev_err(sbd_core(), "%s:%u: lv1_set_lpm_counter_control "\r\n"failed: ctr %u, %s\n", __func__, __LINE__, ctr,\r\nps3_result(result));\r\n}\r\nu32 ps3_read_pm(u32 cpu, enum pm_reg_name reg)\r\n{\r\nint result = 0;\r\nu64 val = 0;\r\nswitch (reg) {\r\ncase pm_control:\r\nreturn lpm_priv->shadow.pm_control;\r\ncase trace_address:\r\nreturn CBE_PM_TRACE_BUF_EMPTY;\r\ncase pm_start_stop:\r\nreturn lpm_priv->shadow.pm_start_stop;\r\ncase pm_interval:\r\nresult = lv1_set_lpm_interval(lpm_priv->lpm_id, 0, 0, &val);\r\nif (result) {\r\nval = 0;\r\ndev_dbg(sbd_core(), "%s:%u: lv1 set_inteval failed: "\r\n"reg %u, %s\n", __func__, __LINE__, reg,\r\nps3_result(result));\r\n}\r\nreturn (u32)val;\r\ncase group_control:\r\nreturn lpm_priv->shadow.group_control;\r\ncase debug_bus_control:\r\nreturn lpm_priv->shadow.debug_bus_control;\r\ncase pm_status:\r\nresult = lv1_get_lpm_interrupt_status(lpm_priv->lpm_id,\r\n&val);\r\nif (result) {\r\nval = 0;\r\ndev_dbg(sbd_core(), "%s:%u: lv1 get_lpm_status failed: "\r\n"reg %u, %s\n", __func__, __LINE__, reg,\r\nps3_result(result));\r\n}\r\nreturn (u32)val;\r\ncase ext_tr_timer:\r\nreturn 0;\r\ndefault:\r\ndev_dbg(sbd_core(), "%s:%u: unknown reg: %d\n", __func__,\r\n__LINE__, reg);\r\nBUG();\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nvoid ps3_write_pm(u32 cpu, enum pm_reg_name reg, u32 val)\r\n{\r\nint result = 0;\r\nu64 dummy;\r\nswitch (reg) {\r\ncase group_control:\r\nif (val != lpm_priv->shadow.group_control)\r\nresult = lv1_set_lpm_group_control(lpm_priv->lpm_id,\r\nval,\r\nPS3_WRITE_PM_MASK,\r\n&dummy);\r\nlpm_priv->shadow.group_control = val;\r\nbreak;\r\ncase debug_bus_control:\r\nif (val != lpm_priv->shadow.debug_bus_control)\r\nresult = lv1_set_lpm_debug_bus_control(lpm_priv->lpm_id,\r\nval,\r\nPS3_WRITE_PM_MASK,\r\n&dummy);\r\nlpm_priv->shadow.debug_bus_control = val;\r\nbreak;\r\ncase pm_control:\r\nif (use_start_stop_bookmark)\r\nval |= (PS3_PM_CONTROL_PPU_TH0_BOOKMARK |\r\nPS3_PM_CONTROL_PPU_TH1_BOOKMARK);\r\nif (val != lpm_priv->shadow.pm_control)\r\nresult = lv1_set_lpm_general_control(lpm_priv->lpm_id,\r\nval,\r\nPS3_WRITE_PM_MASK,\r\n0, 0, &dummy,\r\n&dummy);\r\nlpm_priv->shadow.pm_control = val;\r\nbreak;\r\ncase pm_interval:\r\nresult = lv1_set_lpm_interval(lpm_priv->lpm_id, val,\r\nPS3_WRITE_PM_MASK, &dummy);\r\nbreak;\r\ncase pm_start_stop:\r\nif (val != lpm_priv->shadow.pm_start_stop)\r\nresult = lv1_set_lpm_trigger_control(lpm_priv->lpm_id,\r\nval,\r\nPS3_WRITE_PM_MASK,\r\n&dummy);\r\nlpm_priv->shadow.pm_start_stop = val;\r\nbreak;\r\ncase trace_address:\r\ncase ext_tr_timer:\r\ncase pm_status:\r\nbreak;\r\ndefault:\r\ndev_dbg(sbd_core(), "%s:%u: unknown reg: %d\n", __func__,\r\n__LINE__, reg);\r\nBUG();\r\nbreak;\r\n}\r\nif (result)\r\ndev_err(sbd_core(), "%s:%u: lv1 set_control failed: "\r\n"reg %u, %s\n", __func__, __LINE__, reg,\r\nps3_result(result));\r\n}\r\nu32 ps3_get_ctr_size(u32 cpu, u32 phys_ctr)\r\n{\r\nu32 pm_ctrl;\r\nif (phys_ctr >= NR_PHYS_CTRS) {\r\ndev_dbg(sbd_core(), "%s:%u: phys_ctr too big: %u\n", __func__,\r\n__LINE__, phys_ctr);\r\nreturn 0;\r\n}\r\npm_ctrl = ps3_read_pm(cpu, pm_control);\r\nreturn (pm_ctrl & CBE_PM_16BIT_CTR(phys_ctr)) ? 16 : 32;\r\n}\r\nvoid ps3_set_ctr_size(u32 cpu, u32 phys_ctr, u32 ctr_size)\r\n{\r\nu32 pm_ctrl;\r\nif (phys_ctr >= NR_PHYS_CTRS) {\r\ndev_dbg(sbd_core(), "%s:%u: phys_ctr too big: %u\n", __func__,\r\n__LINE__, phys_ctr);\r\nreturn;\r\n}\r\npm_ctrl = ps3_read_pm(cpu, pm_control);\r\nswitch (ctr_size) {\r\ncase 16:\r\npm_ctrl |= CBE_PM_16BIT_CTR(phys_ctr);\r\nps3_write_pm(cpu, pm_control, pm_ctrl);\r\nbreak;\r\ncase 32:\r\npm_ctrl &= ~CBE_PM_16BIT_CTR(phys_ctr);\r\nps3_write_pm(cpu, pm_control, pm_ctrl);\r\nbreak;\r\ndefault:\r\nBUG();\r\n}\r\n}\r\nstatic u64 pm_translate_signal_group_number_on_island2(u64 subgroup)\r\n{\r\nif (subgroup == 2)\r\nsubgroup = 3;\r\nif (subgroup <= 6)\r\nreturn PM_ISLAND2_BASE_SIGNAL_GROUP_NUMBER + subgroup;\r\nelse if (subgroup == 7)\r\nreturn PM_ISLAND2_SIGNAL_GROUP_NUMBER1;\r\nelse\r\nreturn PM_ISLAND2_SIGNAL_GROUP_NUMBER2;\r\n}\r\nstatic u64 pm_translate_signal_group_number_on_island3(u64 subgroup)\r\n{\r\nswitch (subgroup) {\r\ncase 2:\r\ncase 3:\r\ncase 4:\r\nsubgroup += 2;\r\nbreak;\r\ncase 5:\r\nsubgroup = 8;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn PM_ISLAND3_BASE_SIGNAL_GROUP_NUMBER + subgroup;\r\n}\r\nstatic u64 pm_translate_signal_group_number_on_island4(u64 subgroup)\r\n{\r\nreturn PM_ISLAND4_BASE_SIGNAL_GROUP_NUMBER + subgroup;\r\n}\r\nstatic u64 pm_translate_signal_group_number_on_island5(u64 subgroup)\r\n{\r\nswitch (subgroup) {\r\ncase 3:\r\nsubgroup = 4;\r\nbreak;\r\ncase 4:\r\nsubgroup = 6;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn PM_ISLAND5_BASE_SIGNAL_GROUP_NUMBER + subgroup;\r\n}\r\nstatic u64 pm_translate_signal_group_number_on_island6(u64 subgroup,\r\nu64 subsubgroup)\r\n{\r\nswitch (subgroup) {\r\ncase 3:\r\ncase 4:\r\ncase 5:\r\nsubgroup += 1;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nswitch (subsubgroup) {\r\ncase 4:\r\ncase 5:\r\ncase 6:\r\nsubsubgroup += 2;\r\nbreak;\r\ncase 7:\r\ncase 8:\r\ncase 9:\r\ncase 10:\r\nsubsubgroup += 4;\r\nbreak;\r\ncase 11:\r\ncase 12:\r\ncase 13:\r\nsubsubgroup += 5;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (subgroup <= 5)\r\nreturn (PM_ISLAND6_BASE_SIGNAL_GROUP_NUMBER + subgroup);\r\nelse\r\nreturn (PM_ISLAND6_BASE_SIGNAL_GROUP_NUMBER + subgroup\r\n+ subsubgroup - 1);\r\n}\r\nstatic u64 pm_translate_signal_group_number_on_island7(u64 subgroup)\r\n{\r\nreturn PM_ISLAND7_BASE_SIGNAL_GROUP_NUMBER + subgroup;\r\n}\r\nstatic u64 pm_translate_signal_group_number_on_island8(u64 subgroup)\r\n{\r\nreturn PM_ISLAND8_BASE_SIGNAL_GROUP_NUMBER + subgroup;\r\n}\r\nstatic u64 pm_signal_group_to_ps3_lv1_signal_group(u64 group)\r\n{\r\nu64 island;\r\nu64 subgroup;\r\nu64 subsubgroup;\r\nsubgroup = 0;\r\nsubsubgroup = 0;\r\nisland = 0;\r\nif (group < 1000) {\r\nif (group < 100) {\r\nif (20 <= group && group < 30) {\r\nisland = 2;\r\nsubgroup = group - 20;\r\n} else if (30 <= group && group < 40) {\r\nisland = 3;\r\nsubgroup = group - 30;\r\n} else if (40 <= group && group < 50) {\r\nisland = 4;\r\nsubgroup = group - 40;\r\n} else if (50 <= group && group < 60) {\r\nisland = 5;\r\nsubgroup = group - 50;\r\n} else if (60 <= group && group < 70) {\r\nisland = 6;\r\nsubgroup = group - 60;\r\n} else if (70 <= group && group < 80) {\r\nisland = 7;\r\nsubgroup = group - 70;\r\n} else if (80 <= group && group < 90) {\r\nisland = 8;\r\nsubgroup = group - 80;\r\n}\r\n} else if (200 <= group && group < 300) {\r\nisland = 2;\r\nsubgroup = group - 200;\r\n} else if (600 <= group && group < 700) {\r\nisland = 6;\r\nsubgroup = 5;\r\nsubsubgroup = group - 650;\r\n}\r\n} else if (6000 <= group && group < 7000) {\r\nisland = 6;\r\nsubgroup = 5;\r\nsubsubgroup = group - 6500;\r\n}\r\nswitch (island) {\r\ncase 2:\r\nreturn pm_translate_signal_group_number_on_island2(subgroup);\r\ncase 3:\r\nreturn pm_translate_signal_group_number_on_island3(subgroup);\r\ncase 4:\r\nreturn pm_translate_signal_group_number_on_island4(subgroup);\r\ncase 5:\r\nreturn pm_translate_signal_group_number_on_island5(subgroup);\r\ncase 6:\r\nreturn pm_translate_signal_group_number_on_island6(subgroup,\r\nsubsubgroup);\r\ncase 7:\r\nreturn pm_translate_signal_group_number_on_island7(subgroup);\r\ncase 8:\r\nreturn pm_translate_signal_group_number_on_island8(subgroup);\r\ndefault:\r\ndev_dbg(sbd_core(), "%s:%u: island not found: %llu\n", __func__,\r\n__LINE__, group);\r\nBUG();\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic u64 pm_bus_word_to_ps3_lv1_bus_word(u8 word)\r\n{\r\nswitch (word) {\r\ncase 1:\r\nreturn 0xF000;\r\ncase 2:\r\nreturn 0x0F00;\r\ncase 4:\r\nreturn 0x00F0;\r\ncase 8:\r\ndefault:\r\nreturn 0x000F;\r\n}\r\n}\r\nstatic int __ps3_set_signal(u64 lv1_signal_group, u64 bus_select,\r\nu64 signal_select, u64 attr1, u64 attr2, u64 attr3)\r\n{\r\nint ret;\r\nret = lv1_set_lpm_signal(lpm_priv->lpm_id, lv1_signal_group, bus_select,\r\nsignal_select, attr1, attr2, attr3);\r\nif (ret)\r\ndev_err(sbd_core(),\r\n"%s:%u: error:%d 0x%llx 0x%llx 0x%llx 0x%llx 0x%llx 0x%llx\n",\r\n__func__, __LINE__, ret, lv1_signal_group, bus_select,\r\nsignal_select, attr1, attr2, attr3);\r\nreturn ret;\r\n}\r\nint ps3_set_signal(u64 signal_group, u8 signal_bit, u16 sub_unit,\r\nu8 bus_word)\r\n{\r\nint ret;\r\nu64 lv1_signal_group;\r\nu64 bus_select;\r\nu64 signal_select;\r\nu64 attr1, attr2, attr3;\r\nif (signal_group == 0)\r\nreturn __ps3_set_signal(0, 0, 0, 0, 0, 0);\r\nlv1_signal_group =\r\npm_signal_group_to_ps3_lv1_signal_group(signal_group);\r\nbus_select = pm_bus_word_to_ps3_lv1_bus_word(bus_word);\r\nswitch (signal_group) {\r\ncase PM_SIG_GROUP_SPU_TRIGGER:\r\nsignal_select = 1;\r\nsignal_select = signal_select << (63 - signal_bit);\r\nbreak;\r\ncase PM_SIG_GROUP_SPU_EVENT:\r\nsignal_select = 1;\r\nsignal_select = (signal_select << (63 - signal_bit)) | 0x3;\r\nbreak;\r\ndefault:\r\nsignal_select = 0;\r\nbreak;\r\n}\r\nattr1 = 1;\r\nif (PM_SIG_GROUP_SPU <= signal_group &&\r\nsignal_group < PM_SIG_GROUP_MFC_MAX)\r\nattr2 = sub_unit;\r\nelse\r\nattr2 = lpm_priv->pu_id;\r\nattr3 = 0;\r\nret = __ps3_set_signal(lv1_signal_group, bus_select, signal_select,\r\nattr1, attr2, attr3);\r\nif (ret)\r\ndev_err(sbd_core(), "%s:%u: __ps3_set_signal failed: %d\n",\r\n__func__, __LINE__, ret);\r\nreturn ret;\r\n}\r\nu32 ps3_get_hw_thread_id(int cpu)\r\n{\r\nreturn get_hard_smp_processor_id(cpu);\r\n}\r\nvoid ps3_enable_pm(u32 cpu)\r\n{\r\nint result;\r\nu64 tmp;\r\nint insert_bookmark = 0;\r\nlpm_priv->tb_count = 0;\r\nif (use_start_stop_bookmark) {\r\nif (!(lpm_priv->shadow.pm_start_stop &\r\n(PS3_PM_START_STOP_START_MASK\r\n| PS3_PM_START_STOP_STOP_MASK))) {\r\nresult = lv1_set_lpm_trigger_control(lpm_priv->lpm_id,\r\n(PS3_PM_START_STOP_PPU_TH0_BOOKMARK_START |\r\nPS3_PM_START_STOP_PPU_TH1_BOOKMARK_START |\r\nPS3_PM_START_STOP_PPU_TH0_BOOKMARK_STOP |\r\nPS3_PM_START_STOP_PPU_TH1_BOOKMARK_STOP),\r\n0xFFFFFFFFFFFFFFFFULL, &tmp);\r\nif (result)\r\ndev_err(sbd_core(), "%s:%u: "\r\n"lv1_set_lpm_trigger_control failed: "\r\n"%s\n", __func__, __LINE__,\r\nps3_result(result));\r\ninsert_bookmark = !result;\r\n}\r\n}\r\nresult = lv1_start_lpm(lpm_priv->lpm_id);\r\nif (result)\r\ndev_err(sbd_core(), "%s:%u: lv1_start_lpm failed: %s\n",\r\n__func__, __LINE__, ps3_result(result));\r\nif (use_start_stop_bookmark && !result && insert_bookmark)\r\nps3_set_bookmark(get_tb() | PS3_PM_BOOKMARK_START);\r\n}\r\nvoid ps3_disable_pm(u32 cpu)\r\n{\r\nint result;\r\nu64 tmp;\r\nps3_set_bookmark(get_tb() | PS3_PM_BOOKMARK_STOP);\r\nresult = lv1_stop_lpm(lpm_priv->lpm_id, &tmp);\r\nif (result) {\r\nif(result != LV1_WRONG_STATE)\r\ndev_err(sbd_core(), "%s:%u: lv1_stop_lpm failed: %s\n",\r\n__func__, __LINE__, ps3_result(result));\r\nreturn;\r\n}\r\nlpm_priv->tb_count = tmp;\r\ndev_dbg(sbd_core(), "%s:%u: tb_count %llu (%llxh)\n", __func__, __LINE__,\r\nlpm_priv->tb_count, lpm_priv->tb_count);\r\n}\r\nint ps3_lpm_copy_tb(unsigned long offset, void *buf, unsigned long count,\r\nunsigned long *bytes_copied)\r\n{\r\nint result;\r\n*bytes_copied = 0;\r\nif (!lpm_priv->tb_cache)\r\nreturn -EPERM;\r\nif (offset >= lpm_priv->tb_count)\r\nreturn 0;\r\ncount = min_t(u64, count, lpm_priv->tb_count - offset);\r\nwhile (*bytes_copied < count) {\r\nconst unsigned long request = count - *bytes_copied;\r\nu64 tmp;\r\nresult = lv1_copy_lpm_trace_buffer(lpm_priv->lpm_id, offset,\r\nrequest, &tmp);\r\nif (result) {\r\ndev_dbg(sbd_core(), "%s:%u: 0x%lx bytes at 0x%lx\n",\r\n__func__, __LINE__, request, offset);\r\ndev_err(sbd_core(), "%s:%u: lv1_copy_lpm_trace_buffer "\r\n"failed: %s\n", __func__, __LINE__,\r\nps3_result(result));\r\nreturn result == LV1_WRONG_STATE ? -EBUSY : -EINVAL;\r\n}\r\nmemcpy(buf, lpm_priv->tb_cache, tmp);\r\nbuf += tmp;\r\n*bytes_copied += tmp;\r\noffset += tmp;\r\n}\r\ndev_dbg(sbd_core(), "%s:%u: copied %lxh bytes\n", __func__, __LINE__,\r\n*bytes_copied);\r\nreturn 0;\r\n}\r\nint ps3_lpm_copy_tb_to_user(unsigned long offset, void __user *buf,\r\nunsigned long count, unsigned long *bytes_copied)\r\n{\r\nint result;\r\n*bytes_copied = 0;\r\nif (!lpm_priv->tb_cache)\r\nreturn -EPERM;\r\nif (offset >= lpm_priv->tb_count)\r\nreturn 0;\r\ncount = min_t(u64, count, lpm_priv->tb_count - offset);\r\nwhile (*bytes_copied < count) {\r\nconst unsigned long request = count - *bytes_copied;\r\nu64 tmp;\r\nresult = lv1_copy_lpm_trace_buffer(lpm_priv->lpm_id, offset,\r\nrequest, &tmp);\r\nif (result) {\r\ndev_dbg(sbd_core(), "%s:%u: 0x%lx bytes at 0x%lx\n",\r\n__func__, __LINE__, request, offset);\r\ndev_err(sbd_core(), "%s:%u: lv1_copy_lpm_trace_buffer "\r\n"failed: %s\n", __func__, __LINE__,\r\nps3_result(result));\r\nreturn result == LV1_WRONG_STATE ? -EBUSY : -EINVAL;\r\n}\r\nresult = copy_to_user(buf, lpm_priv->tb_cache, tmp);\r\nif (result) {\r\ndev_dbg(sbd_core(), "%s:%u: 0x%llx bytes at 0x%p\n",\r\n__func__, __LINE__, tmp, buf);\r\ndev_err(sbd_core(), "%s:%u: copy_to_user failed: %d\n",\r\n__func__, __LINE__, result);\r\nreturn -EFAULT;\r\n}\r\nbuf += tmp;\r\n*bytes_copied += tmp;\r\noffset += tmp;\r\n}\r\ndev_dbg(sbd_core(), "%s:%u: copied %lxh bytes\n", __func__, __LINE__,\r\n*bytes_copied);\r\nreturn 0;\r\n}\r\nu32 ps3_get_and_clear_pm_interrupts(u32 cpu)\r\n{\r\nreturn ps3_read_pm(cpu, pm_status);\r\n}\r\nvoid ps3_enable_pm_interrupts(u32 cpu, u32 thread, u32 mask)\r\n{\r\nif (mask)\r\nps3_write_pm(cpu, pm_status, mask);\r\n}\r\nvoid ps3_disable_pm_interrupts(u32 cpu)\r\n{\r\nps3_get_and_clear_pm_interrupts(cpu);\r\nps3_write_pm(cpu, pm_status, 0);\r\n}\r\nint ps3_lpm_open(enum ps3_lpm_tb_type tb_type, void *tb_cache,\r\nu64 tb_cache_size)\r\n{\r\nint result;\r\nu64 tb_size;\r\nBUG_ON(!lpm_priv);\r\nBUG_ON(tb_type != PS3_LPM_TB_TYPE_NONE\r\n&& tb_type != PS3_LPM_TB_TYPE_INTERNAL);\r\nif (tb_type == PS3_LPM_TB_TYPE_NONE && tb_cache)\r\ndev_dbg(sbd_core(), "%s:%u: bad in vals\n", __func__, __LINE__);\r\nif (!atomic_add_unless(&lpm_priv->open, 1, 1)) {\r\ndev_dbg(sbd_core(), "%s:%u: busy\n", __func__, __LINE__);\r\nreturn -EBUSY;\r\n}\r\nif (tb_type == PS3_LPM_TB_TYPE_NONE) {\r\nlpm_priv->tb_cache_size = 0;\r\nlpm_priv->tb_cache_internal = NULL;\r\nlpm_priv->tb_cache = NULL;\r\n} else if (tb_cache) {\r\nif (tb_cache != (void *)_ALIGN_UP((unsigned long)tb_cache, 128)\r\n|| tb_cache_size != _ALIGN_UP(tb_cache_size, 128)) {\r\ndev_err(sbd_core(), "%s:%u: unaligned tb_cache\n",\r\n__func__, __LINE__);\r\nresult = -EINVAL;\r\ngoto fail_align;\r\n}\r\nlpm_priv->tb_cache_size = tb_cache_size;\r\nlpm_priv->tb_cache_internal = NULL;\r\nlpm_priv->tb_cache = tb_cache;\r\n} else {\r\nlpm_priv->tb_cache_size = PS3_LPM_DEFAULT_TB_CACHE_SIZE;\r\nlpm_priv->tb_cache_internal = kzalloc(\r\nlpm_priv->tb_cache_size + 127, GFP_KERNEL);\r\nif (!lpm_priv->tb_cache_internal) {\r\ndev_err(sbd_core(), "%s:%u: alloc internal tb_cache "\r\n"failed\n", __func__, __LINE__);\r\nresult = -ENOMEM;\r\ngoto fail_malloc;\r\n}\r\nlpm_priv->tb_cache = (void *)_ALIGN_UP(\r\n(unsigned long)lpm_priv->tb_cache_internal, 128);\r\n}\r\nresult = lv1_construct_lpm(lpm_priv->node_id, tb_type, 0, 0,\r\nps3_mm_phys_to_lpar(__pa(lpm_priv->tb_cache)),\r\nlpm_priv->tb_cache_size, &lpm_priv->lpm_id,\r\n&lpm_priv->outlet_id, &tb_size);\r\nif (result) {\r\ndev_err(sbd_core(), "%s:%u: lv1_construct_lpm failed: %s\n",\r\n__func__, __LINE__, ps3_result(result));\r\nresult = -EINVAL;\r\ngoto fail_construct;\r\n}\r\nlpm_priv->shadow.pm_control = PS3_LPM_SHADOW_REG_INIT;\r\nlpm_priv->shadow.pm_start_stop = PS3_LPM_SHADOW_REG_INIT;\r\nlpm_priv->shadow.group_control = PS3_LPM_SHADOW_REG_INIT;\r\nlpm_priv->shadow.debug_bus_control = PS3_LPM_SHADOW_REG_INIT;\r\ndev_dbg(sbd_core(), "%s:%u: lpm_id 0x%llx, outlet_id 0x%llx, "\r\n"tb_size 0x%llx\n", __func__, __LINE__, lpm_priv->lpm_id,\r\nlpm_priv->outlet_id, tb_size);\r\nreturn 0;\r\nfail_construct:\r\nkfree(lpm_priv->tb_cache_internal);\r\nlpm_priv->tb_cache_internal = NULL;\r\nfail_malloc:\r\nfail_align:\r\natomic_dec(&lpm_priv->open);\r\nreturn result;\r\n}\r\nint ps3_lpm_close(void)\r\n{\r\ndev_dbg(sbd_core(), "%s:%u\n", __func__, __LINE__);\r\nlv1_destruct_lpm(lpm_priv->lpm_id);\r\nlpm_priv->lpm_id = 0;\r\nkfree(lpm_priv->tb_cache_internal);\r\nlpm_priv->tb_cache_internal = NULL;\r\natomic_dec(&lpm_priv->open);\r\nreturn 0;\r\n}\r\nstatic int ps3_lpm_probe(struct ps3_system_bus_device *dev)\r\n{\r\ndev_dbg(&dev->core, " -> %s:%u\n", __func__, __LINE__);\r\nif (lpm_priv) {\r\ndev_info(&dev->core, "%s:%u: called twice\n",\r\n__func__, __LINE__);\r\nreturn -EBUSY;\r\n}\r\nlpm_priv = kzalloc(sizeof(*lpm_priv), GFP_KERNEL);\r\nif (!lpm_priv)\r\nreturn -ENOMEM;\r\nlpm_priv->sbd = dev;\r\nlpm_priv->node_id = dev->lpm.node_id;\r\nlpm_priv->pu_id = dev->lpm.pu_id;\r\nlpm_priv->rights = dev->lpm.rights;\r\ndev_info(&dev->core, " <- %s:%u:\n", __func__, __LINE__);\r\nreturn 0;\r\n}\r\nstatic int ps3_lpm_remove(struct ps3_system_bus_device *dev)\r\n{\r\ndev_dbg(&dev->core, " -> %s:%u:\n", __func__, __LINE__);\r\nps3_lpm_close();\r\nkfree(lpm_priv);\r\nlpm_priv = NULL;\r\ndev_info(&dev->core, " <- %s:%u:\n", __func__, __LINE__);\r\nreturn 0;\r\n}\r\nstatic int __init ps3_lpm_init(void)\r\n{\r\npr_debug("%s:%d:\n", __func__, __LINE__);\r\nreturn ps3_system_bus_driver_register(&ps3_lpm_driver);\r\n}\r\nstatic void __exit ps3_lpm_exit(void)\r\n{\r\npr_debug("%s:%d:\n", __func__, __LINE__);\r\nps3_system_bus_driver_unregister(&ps3_lpm_driver);\r\n}

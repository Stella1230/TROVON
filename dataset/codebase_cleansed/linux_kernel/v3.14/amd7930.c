static __inline__ void amd7930_idle(struct snd_amd7930 *amd)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&amd->lock, flags);\r\nsbus_writeb(AMR_INIT, amd->regs + AMD7930_CR);\r\nsbus_writeb(0, amd->regs + AMD7930_DR);\r\nspin_unlock_irqrestore(&amd->lock, flags);\r\n}\r\nstatic __inline__ void amd7930_enable_ints(struct snd_amd7930 *amd)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&amd->lock, flags);\r\nsbus_writeb(AMR_INIT, amd->regs + AMD7930_CR);\r\nsbus_writeb(AM_INIT_ACTIVE, amd->regs + AMD7930_DR);\r\nspin_unlock_irqrestore(&amd->lock, flags);\r\n}\r\nstatic __inline__ void amd7930_disable_ints(struct snd_amd7930 *amd)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&amd->lock, flags);\r\nsbus_writeb(AMR_INIT, amd->regs + AMD7930_CR);\r\nsbus_writeb(AM_INIT_ACTIVE | AM_INIT_DISABLE_INTS, amd->regs + AMD7930_DR);\r\nspin_unlock_irqrestore(&amd->lock, flags);\r\n}\r\nstatic void __amd7930_write_map(struct snd_amd7930 *amd)\r\n{\r\nstruct amd7930_map *map = &amd->map;\r\nsbus_writeb(AMR_MAP_GX, amd->regs + AMD7930_CR);\r\nsbus_writeb(((map->gx >> 0) & 0xff), amd->regs + AMD7930_DR);\r\nsbus_writeb(((map->gx >> 8) & 0xff), amd->regs + AMD7930_DR);\r\nsbus_writeb(AMR_MAP_GR, amd->regs + AMD7930_CR);\r\nsbus_writeb(((map->gr >> 0) & 0xff), amd->regs + AMD7930_DR);\r\nsbus_writeb(((map->gr >> 8) & 0xff), amd->regs + AMD7930_DR);\r\nsbus_writeb(AMR_MAP_STGR, amd->regs + AMD7930_CR);\r\nsbus_writeb(((map->stgr >> 0) & 0xff), amd->regs + AMD7930_DR);\r\nsbus_writeb(((map->stgr >> 8) & 0xff), amd->regs + AMD7930_DR);\r\nsbus_writeb(AMR_MAP_GER, amd->regs + AMD7930_CR);\r\nsbus_writeb(((map->ger >> 0) & 0xff), amd->regs + AMD7930_DR);\r\nsbus_writeb(((map->ger >> 8) & 0xff), amd->regs + AMD7930_DR);\r\nsbus_writeb(AMR_MAP_MMR1, amd->regs + AMD7930_CR);\r\nsbus_writeb(map->mmr1, amd->regs + AMD7930_DR);\r\nsbus_writeb(AMR_MAP_MMR2, amd->regs + AMD7930_CR);\r\nsbus_writeb(map->mmr2, amd->regs + AMD7930_DR);\r\n}\r\nstatic void __amd7930_update_map(struct snd_amd7930 *amd)\r\n{\r\nstruct amd7930_map *map = &amd->map;\r\nint level;\r\nmap->gx = gx_coeff[amd->rgain];\r\nmap->stgr = gx_coeff[amd->mgain];\r\nlevel = (amd->pgain * (256 + ARRAY_SIZE(ger_coeff))) >> 8;\r\nif (level >= 256) {\r\nmap->ger = ger_coeff[level - 256];\r\nmap->gr = gx_coeff[255];\r\n} else {\r\nmap->ger = ger_coeff[0];\r\nmap->gr = gx_coeff[level];\r\n}\r\n__amd7930_write_map(amd);\r\n}\r\nstatic irqreturn_t snd_amd7930_interrupt(int irq, void *dev_id)\r\n{\r\nstruct snd_amd7930 *amd = dev_id;\r\nunsigned int elapsed;\r\nu8 ir;\r\nspin_lock(&amd->lock);\r\nelapsed = 0;\r\nir = sbus_readb(amd->regs + AMD7930_IR);\r\nif (ir & AMR_IR_BBUF) {\r\nu8 byte;\r\nif (amd->flags & AMD7930_FLAG_PLAYBACK) {\r\nif (amd->p_left > 0) {\r\nbyte = *(amd->p_cur++);\r\namd->p_left--;\r\nsbus_writeb(byte, amd->regs + AMD7930_BBTB);\r\nif (amd->p_left == 0)\r\nelapsed |= AMD7930_FLAG_PLAYBACK;\r\n} else\r\nsbus_writeb(0, amd->regs + AMD7930_BBTB);\r\n} else if (amd->flags & AMD7930_FLAG_CAPTURE) {\r\nbyte = sbus_readb(amd->regs + AMD7930_BBRB);\r\nif (amd->c_left > 0) {\r\n*(amd->c_cur++) = byte;\r\namd->c_left--;\r\nif (amd->c_left == 0)\r\nelapsed |= AMD7930_FLAG_CAPTURE;\r\n}\r\n}\r\n}\r\nspin_unlock(&amd->lock);\r\nif (elapsed & AMD7930_FLAG_PLAYBACK)\r\nsnd_pcm_period_elapsed(amd->playback_substream);\r\nelse\r\nsnd_pcm_period_elapsed(amd->capture_substream);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int snd_amd7930_trigger(struct snd_amd7930 *amd, unsigned int flag, int cmd)\r\n{\r\nunsigned long flags;\r\nint result = 0;\r\nspin_lock_irqsave(&amd->lock, flags);\r\nif (cmd == SNDRV_PCM_TRIGGER_START) {\r\nif (!(amd->flags & flag)) {\r\namd->flags |= flag;\r\nsbus_writeb(AMR_MUX_MCR4, amd->regs + AMD7930_CR);\r\nsbus_writeb(AM_MUX_MCR4_ENABLE_INTS, amd->regs + AMD7930_DR);\r\n}\r\n} else if (cmd == SNDRV_PCM_TRIGGER_STOP) {\r\nif (amd->flags & flag) {\r\namd->flags &= ~flag;\r\nsbus_writeb(AMR_MUX_MCR4, amd->regs + AMD7930_CR);\r\nsbus_writeb(0, amd->regs + AMD7930_DR);\r\n}\r\n} else {\r\nresult = -EINVAL;\r\n}\r\nspin_unlock_irqrestore(&amd->lock, flags);\r\nreturn result;\r\n}\r\nstatic int snd_amd7930_playback_trigger(struct snd_pcm_substream *substream,\r\nint cmd)\r\n{\r\nstruct snd_amd7930 *amd = snd_pcm_substream_chip(substream);\r\nreturn snd_amd7930_trigger(amd, AMD7930_FLAG_PLAYBACK, cmd);\r\n}\r\nstatic int snd_amd7930_capture_trigger(struct snd_pcm_substream *substream,\r\nint cmd)\r\n{\r\nstruct snd_amd7930 *amd = snd_pcm_substream_chip(substream);\r\nreturn snd_amd7930_trigger(amd, AMD7930_FLAG_CAPTURE, cmd);\r\n}\r\nstatic int snd_amd7930_playback_prepare(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_amd7930 *amd = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nunsigned int size = snd_pcm_lib_buffer_bytes(substream);\r\nunsigned long flags;\r\nu8 new_mmr1;\r\nspin_lock_irqsave(&amd->lock, flags);\r\namd->flags |= AMD7930_FLAG_PLAYBACK;\r\namd->p_orig = amd->p_cur = runtime->dma_area;\r\namd->p_left = size;\r\nnew_mmr1 = amd->map.mmr1;\r\nif (runtime->format == SNDRV_PCM_FORMAT_A_LAW)\r\nnew_mmr1 |= AM_MAP_MMR1_ALAW;\r\nelse\r\nnew_mmr1 &= ~AM_MAP_MMR1_ALAW;\r\nif (new_mmr1 != amd->map.mmr1) {\r\namd->map.mmr1 = new_mmr1;\r\n__amd7930_update_map(amd);\r\n}\r\nspin_unlock_irqrestore(&amd->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int snd_amd7930_capture_prepare(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_amd7930 *amd = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nunsigned int size = snd_pcm_lib_buffer_bytes(substream);\r\nunsigned long flags;\r\nu8 new_mmr1;\r\nspin_lock_irqsave(&amd->lock, flags);\r\namd->flags |= AMD7930_FLAG_CAPTURE;\r\namd->c_orig = amd->c_cur = runtime->dma_area;\r\namd->c_left = size;\r\nnew_mmr1 = amd->map.mmr1;\r\nif (runtime->format == SNDRV_PCM_FORMAT_A_LAW)\r\nnew_mmr1 |= AM_MAP_MMR1_ALAW;\r\nelse\r\nnew_mmr1 &= ~AM_MAP_MMR1_ALAW;\r\nif (new_mmr1 != amd->map.mmr1) {\r\namd->map.mmr1 = new_mmr1;\r\n__amd7930_update_map(amd);\r\n}\r\nspin_unlock_irqrestore(&amd->lock, flags);\r\nreturn 0;\r\n}\r\nstatic snd_pcm_uframes_t snd_amd7930_playback_pointer(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_amd7930 *amd = snd_pcm_substream_chip(substream);\r\nsize_t ptr;\r\nif (!(amd->flags & AMD7930_FLAG_PLAYBACK))\r\nreturn 0;\r\nptr = amd->p_cur - amd->p_orig;\r\nreturn bytes_to_frames(substream->runtime, ptr);\r\n}\r\nstatic snd_pcm_uframes_t snd_amd7930_capture_pointer(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_amd7930 *amd = snd_pcm_substream_chip(substream);\r\nsize_t ptr;\r\nif (!(amd->flags & AMD7930_FLAG_CAPTURE))\r\nreturn 0;\r\nptr = amd->c_cur - amd->c_orig;\r\nreturn bytes_to_frames(substream->runtime, ptr);\r\n}\r\nstatic int snd_amd7930_playback_open(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_amd7930 *amd = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\namd->playback_substream = substream;\r\nruntime->hw = snd_amd7930_pcm_hw;\r\nreturn 0;\r\n}\r\nstatic int snd_amd7930_capture_open(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_amd7930 *amd = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\namd->capture_substream = substream;\r\nruntime->hw = snd_amd7930_pcm_hw;\r\nreturn 0;\r\n}\r\nstatic int snd_amd7930_playback_close(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_amd7930 *amd = snd_pcm_substream_chip(substream);\r\namd->playback_substream = NULL;\r\nreturn 0;\r\n}\r\nstatic int snd_amd7930_capture_close(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_amd7930 *amd = snd_pcm_substream_chip(substream);\r\namd->capture_substream = NULL;\r\nreturn 0;\r\n}\r\nstatic int snd_amd7930_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *hw_params)\r\n{\r\nreturn snd_pcm_lib_malloc_pages(substream, params_buffer_bytes(hw_params));\r\n}\r\nstatic int snd_amd7930_hw_free(struct snd_pcm_substream *substream)\r\n{\r\nreturn snd_pcm_lib_free_pages(substream);\r\n}\r\nstatic int snd_amd7930_pcm(struct snd_amd7930 *amd)\r\n{\r\nstruct snd_pcm *pcm;\r\nint err;\r\nif ((err = snd_pcm_new(amd->card,\r\n"sun_amd7930",\r\n0,\r\n1,\r\n1, &pcm)) < 0)\r\nreturn err;\r\nsnd_pcm_set_ops(pcm, SNDRV_PCM_STREAM_PLAYBACK, &snd_amd7930_playback_ops);\r\nsnd_pcm_set_ops(pcm, SNDRV_PCM_STREAM_CAPTURE, &snd_amd7930_capture_ops);\r\npcm->private_data = amd;\r\npcm->info_flags = 0;\r\nstrcpy(pcm->name, amd->card->shortname);\r\namd->pcm = pcm;\r\nsnd_pcm_lib_preallocate_pages_for_all(pcm, SNDRV_DMA_TYPE_CONTINUOUS,\r\nsnd_dma_continuous_data(GFP_KERNEL),\r\n64*1024, 64*1024);\r\nreturn 0;\r\n}\r\nstatic int snd_amd7930_info_volume(struct snd_kcontrol *kctl, struct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\r\nuinfo->count = 1;\r\nuinfo->value.integer.min = 0;\r\nuinfo->value.integer.max = 255;\r\nreturn 0;\r\n}\r\nstatic int snd_amd7930_get_volume(struct snd_kcontrol *kctl, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_amd7930 *amd = snd_kcontrol_chip(kctl);\r\nint type = kctl->private_value;\r\nint *swval;\r\nswitch (type) {\r\ncase VOLUME_MONITOR:\r\nswval = &amd->mgain;\r\nbreak;\r\ncase VOLUME_CAPTURE:\r\nswval = &amd->rgain;\r\nbreak;\r\ncase VOLUME_PLAYBACK:\r\ndefault:\r\nswval = &amd->pgain;\r\nbreak;\r\n}\r\nucontrol->value.integer.value[0] = *swval;\r\nreturn 0;\r\n}\r\nstatic int snd_amd7930_put_volume(struct snd_kcontrol *kctl, struct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_amd7930 *amd = snd_kcontrol_chip(kctl);\r\nunsigned long flags;\r\nint type = kctl->private_value;\r\nint *swval, change;\r\nswitch (type) {\r\ncase VOLUME_MONITOR:\r\nswval = &amd->mgain;\r\nbreak;\r\ncase VOLUME_CAPTURE:\r\nswval = &amd->rgain;\r\nbreak;\r\ncase VOLUME_PLAYBACK:\r\ndefault:\r\nswval = &amd->pgain;\r\nbreak;\r\n}\r\nspin_lock_irqsave(&amd->lock, flags);\r\nif (*swval != ucontrol->value.integer.value[0]) {\r\n*swval = ucontrol->value.integer.value[0] & 0xff;\r\n__amd7930_update_map(amd);\r\nchange = 1;\r\n} else\r\nchange = 0;\r\nspin_unlock_irqrestore(&amd->lock, flags);\r\nreturn change;\r\n}\r\nstatic int snd_amd7930_mixer(struct snd_amd7930 *amd)\r\n{\r\nstruct snd_card *card;\r\nint idx, err;\r\nif (snd_BUG_ON(!amd || !amd->card))\r\nreturn -EINVAL;\r\ncard = amd->card;\r\nstrcpy(card->mixername, card->shortname);\r\nfor (idx = 0; idx < ARRAY_SIZE(amd7930_controls); idx++) {\r\nif ((err = snd_ctl_add(card,\r\nsnd_ctl_new1(&amd7930_controls[idx], amd))) < 0)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int snd_amd7930_free(struct snd_amd7930 *amd)\r\n{\r\nstruct platform_device *op = amd->op;\r\namd7930_idle(amd);\r\nif (amd->irq)\r\nfree_irq(amd->irq, amd);\r\nif (amd->regs)\r\nof_iounmap(&op->resource[0], amd->regs,\r\nresource_size(&op->resource[0]));\r\nkfree(amd);\r\nreturn 0;\r\n}\r\nstatic int snd_amd7930_dev_free(struct snd_device *device)\r\n{\r\nstruct snd_amd7930 *amd = device->device_data;\r\nreturn snd_amd7930_free(amd);\r\n}\r\nstatic int snd_amd7930_create(struct snd_card *card,\r\nstruct platform_device *op,\r\nint irq, int dev,\r\nstruct snd_amd7930 **ramd)\r\n{\r\nstruct snd_amd7930 *amd;\r\nunsigned long flags;\r\nint err;\r\n*ramd = NULL;\r\namd = kzalloc(sizeof(*amd), GFP_KERNEL);\r\nif (amd == NULL)\r\nreturn -ENOMEM;\r\nspin_lock_init(&amd->lock);\r\namd->card = card;\r\namd->op = op;\r\namd->regs = of_ioremap(&op->resource[0], 0,\r\nresource_size(&op->resource[0]), "amd7930");\r\nif (!amd->regs) {\r\nsnd_printk(KERN_ERR\r\n"amd7930-%d: Unable to map chip registers.\n", dev);\r\nreturn -EIO;\r\n}\r\namd7930_idle(amd);\r\nif (request_irq(irq, snd_amd7930_interrupt,\r\nIRQF_SHARED, "amd7930", amd)) {\r\nsnd_printk(KERN_ERR "amd7930-%d: Unable to grab IRQ %d\n",\r\ndev, irq);\r\nsnd_amd7930_free(amd);\r\nreturn -EBUSY;\r\n}\r\namd->irq = irq;\r\namd7930_enable_ints(amd);\r\nspin_lock_irqsave(&amd->lock, flags);\r\namd->rgain = 128;\r\namd->pgain = 200;\r\namd->mgain = 0;\r\nmemset(&amd->map, 0, sizeof(amd->map));\r\namd->map.mmr1 = (AM_MAP_MMR1_GX | AM_MAP_MMR1_GER |\r\nAM_MAP_MMR1_GR | AM_MAP_MMR1_STG);\r\namd->map.mmr2 = (AM_MAP_MMR2_LS | AM_MAP_MMR2_AINB);\r\n__amd7930_update_map(amd);\r\nsbus_writeb(AMR_MUX_MCR1, amd->regs + AMD7930_CR);\r\nsbus_writeb(AM_MUX_CHANNEL_Ba | (AM_MUX_CHANNEL_Bb << 4),\r\namd->regs + AMD7930_DR);\r\nspin_unlock_irqrestore(&amd->lock, flags);\r\nif ((err = snd_device_new(card, SNDRV_DEV_LOWLEVEL,\r\namd, &snd_amd7930_dev_ops)) < 0) {\r\nsnd_amd7930_free(amd);\r\nreturn err;\r\n}\r\n*ramd = amd;\r\nreturn 0;\r\n}\r\nstatic int amd7930_sbus_probe(struct platform_device *op)\r\n{\r\nstruct resource *rp = &op->resource[0];\r\nstatic int dev_num;\r\nstruct snd_card *card;\r\nstruct snd_amd7930 *amd;\r\nint err, irq;\r\nirq = op->archdata.irqs[0];\r\nif (dev_num >= SNDRV_CARDS)\r\nreturn -ENODEV;\r\nif (!enable[dev_num]) {\r\ndev_num++;\r\nreturn -ENOENT;\r\n}\r\nerr = snd_card_create(index[dev_num], id[dev_num], THIS_MODULE, 0,\r\n&card);\r\nif (err < 0)\r\nreturn err;\r\nstrcpy(card->driver, "AMD7930");\r\nstrcpy(card->shortname, "Sun AMD7930");\r\nsprintf(card->longname, "%s at 0x%02lx:0x%08Lx, irq %d",\r\ncard->shortname,\r\nrp->flags & 0xffL,\r\n(unsigned long long)rp->start,\r\nirq);\r\nif ((err = snd_amd7930_create(card, op,\r\nirq, dev_num, &amd)) < 0)\r\ngoto out_err;\r\nif ((err = snd_amd7930_pcm(amd)) < 0)\r\ngoto out_err;\r\nif ((err = snd_amd7930_mixer(amd)) < 0)\r\ngoto out_err;\r\nif ((err = snd_card_register(card)) < 0)\r\ngoto out_err;\r\namd->next = amd7930_list;\r\namd7930_list = amd;\r\ndev_num++;\r\nreturn 0;\r\nout_err:\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\nstatic int __init amd7930_init(void)\r\n{\r\nreturn platform_driver_register(&amd7930_sbus_driver);\r\n}\r\nstatic void __exit amd7930_exit(void)\r\n{\r\nstruct snd_amd7930 *p = amd7930_list;\r\nwhile (p != NULL) {\r\nstruct snd_amd7930 *next = p->next;\r\nsnd_card_free(p->card);\r\np = next;\r\n}\r\namd7930_list = NULL;\r\nplatform_driver_unregister(&amd7930_sbus_driver);\r\n}

int __init mx27_clocks_init(unsigned long fref)\r\n{\r\nint i;\r\nstruct device_node *np;\r\nclk[dummy] = imx_clk_fixed("dummy", 0);\r\nclk[ckih] = imx_clk_fixed("ckih", fref);\r\nclk[ckil] = imx_clk_fixed("ckil", 32768);\r\nclk[fpm] = imx_clk_fixed_factor("fpm", "ckil", 1024, 1);\r\nclk[ckih_div1p5] = imx_clk_fixed_factor("ckih_div1p5", "ckih", 2, 3);\r\nclk[mpll_osc_sel] = imx_clk_mux("mpll_osc_sel", CCM_CSCR, 4, 1,\r\nmpll_osc_sel_clks,\r\nARRAY_SIZE(mpll_osc_sel_clks));\r\nclk[mpll_sel] = imx_clk_mux("mpll_sel", CCM_CSCR, 16, 1, mpll_sel_clks,\r\nARRAY_SIZE(mpll_sel_clks));\r\nclk[mpll] = imx_clk_pllv1("mpll", "mpll_sel", CCM_MPCTL0);\r\nclk[spll] = imx_clk_pllv1("spll", "ckih", CCM_SPCTL0);\r\nclk[spll_gate] = imx_clk_gate("spll_gate", "spll", CCM_CSCR, 1);\r\nclk[mpll_main2] = imx_clk_fixed_factor("mpll_main2", "mpll", 2, 3);\r\nif (mx27_revision() >= IMX_CHIP_REVISION_2_0) {\r\nclk[ahb] = imx_clk_divider("ahb", "mpll_main2", CCM_CSCR, 8, 2);\r\nclk[ipg] = imx_clk_fixed_factor("ipg", "ahb", 1, 2);\r\n} else {\r\nclk[ahb] = imx_clk_divider("ahb", "mpll_main2", CCM_CSCR, 9, 4);\r\nclk[ipg] = imx_clk_divider("ipg", "ahb", CCM_CSCR, 8, 1);\r\n}\r\nclk[nfc_div] = imx_clk_divider("nfc_div", "ahb", CCM_PCDR0, 6, 4);\r\nclk[per1_div] = imx_clk_divider("per1_div", "mpll_main2", CCM_PCDR1, 0, 6);\r\nclk[per2_div] = imx_clk_divider("per2_div", "mpll_main2", CCM_PCDR1, 8, 6);\r\nclk[per3_div] = imx_clk_divider("per3_div", "mpll_main2", CCM_PCDR1, 16, 6);\r\nclk[per4_div] = imx_clk_divider("per4_div", "mpll_main2", CCM_PCDR1, 24, 6);\r\nclk[vpu_sel] = imx_clk_mux("vpu_sel", CCM_CSCR, 21, 1, vpu_sel_clks, ARRAY_SIZE(vpu_sel_clks));\r\nclk[vpu_div] = imx_clk_divider("vpu_div", "vpu_sel", CCM_PCDR0, 10, 6);\r\nclk[usb_div] = imx_clk_divider("usb_div", "spll_gate", CCM_CSCR, 28, 3);\r\nclk[cpu_sel] = imx_clk_mux("cpu_sel", CCM_CSCR, 15, 1, cpu_sel_clks, ARRAY_SIZE(cpu_sel_clks));\r\nclk[clko_sel] = imx_clk_mux("clko_sel", CCM_CCSR, 0, 5, clko_sel_clks, ARRAY_SIZE(clko_sel_clks));\r\nif (mx27_revision() >= IMX_CHIP_REVISION_2_0)\r\nclk[cpu_div] = imx_clk_divider("cpu_div", "cpu_sel", CCM_CSCR, 12, 2);\r\nelse\r\nclk[cpu_div] = imx_clk_divider("cpu_div", "cpu_sel", CCM_CSCR, 13, 3);\r\nclk[clko_div] = imx_clk_divider("clko_div", "clko_sel", CCM_PCDR0, 22, 3);\r\nclk[ssi1_sel] = imx_clk_mux("ssi1_sel", CCM_CSCR, 22, 1, ssi_sel_clks, ARRAY_SIZE(ssi_sel_clks));\r\nclk[ssi2_sel] = imx_clk_mux("ssi2_sel", CCM_CSCR, 23, 1, ssi_sel_clks, ARRAY_SIZE(ssi_sel_clks));\r\nclk[ssi1_div] = imx_clk_divider("ssi1_div", "ssi1_sel", CCM_PCDR0, 16, 6);\r\nclk[ssi2_div] = imx_clk_divider("ssi2_div", "ssi2_sel", CCM_PCDR0, 26, 6);\r\nclk[clko_en] = imx_clk_gate("clko_en", "clko_div", CCM_PCCR0, 0);\r\nclk[ssi2_ipg_gate] = imx_clk_gate("ssi2_ipg_gate", "ipg", CCM_PCCR0, 0);\r\nclk[ssi1_ipg_gate] = imx_clk_gate("ssi1_ipg_gate", "ipg", CCM_PCCR0, 1);\r\nclk[slcdc_ipg_gate] = imx_clk_gate("slcdc_ipg_gate", "ipg", CCM_PCCR0, 2);\r\nclk[sdhc3_ipg_gate] = imx_clk_gate("sdhc3_ipg_gate", "ipg", CCM_PCCR0, 3);\r\nclk[sdhc2_ipg_gate] = imx_clk_gate("sdhc2_ipg_gate", "ipg", CCM_PCCR0, 4);\r\nclk[sdhc1_ipg_gate] = imx_clk_gate("sdhc1_ipg_gate", "ipg", CCM_PCCR0, 5);\r\nclk[scc_ipg_gate] = imx_clk_gate("scc_ipg_gate", "ipg", CCM_PCCR0, 6);\r\nclk[sahara_ipg_gate] = imx_clk_gate("sahara_ipg_gate", "ipg", CCM_PCCR0, 7);\r\nclk[rtc_ipg_gate] = imx_clk_gate("rtc_ipg_gate", "ipg", CCM_PCCR0, 9);\r\nclk[pwm_ipg_gate] = imx_clk_gate("pwm_ipg_gate", "ipg", CCM_PCCR0, 11);\r\nclk[owire_ipg_gate] = imx_clk_gate("owire_ipg_gate", "ipg", CCM_PCCR0, 12);\r\nclk[lcdc_ipg_gate] = imx_clk_gate("lcdc_ipg_gate", "ipg", CCM_PCCR0, 14);\r\nclk[kpp_ipg_gate] = imx_clk_gate("kpp_ipg_gate", "ipg", CCM_PCCR0, 15);\r\nclk[iim_ipg_gate] = imx_clk_gate("iim_ipg_gate", "ipg", CCM_PCCR0, 16);\r\nclk[i2c2_ipg_gate] = imx_clk_gate("i2c2_ipg_gate", "ipg", CCM_PCCR0, 17);\r\nclk[i2c1_ipg_gate] = imx_clk_gate("i2c1_ipg_gate", "ipg", CCM_PCCR0, 18);\r\nclk[gpt6_ipg_gate] = imx_clk_gate("gpt6_ipg_gate", "ipg", CCM_PCCR0, 19);\r\nclk[gpt5_ipg_gate] = imx_clk_gate("gpt5_ipg_gate", "ipg", CCM_PCCR0, 20);\r\nclk[gpt4_ipg_gate] = imx_clk_gate("gpt4_ipg_gate", "ipg", CCM_PCCR0, 21);\r\nclk[gpt3_ipg_gate] = imx_clk_gate("gpt3_ipg_gate", "ipg", CCM_PCCR0, 22);\r\nclk[gpt2_ipg_gate] = imx_clk_gate("gpt2_ipg_gate", "ipg", CCM_PCCR0, 23);\r\nclk[gpt1_ipg_gate] = imx_clk_gate("gpt1_ipg_gate", "ipg", CCM_PCCR0, 24);\r\nclk[gpio_ipg_gate] = imx_clk_gate("gpio_ipg_gate", "ipg", CCM_PCCR0, 25);\r\nclk[fec_ipg_gate] = imx_clk_gate("fec_ipg_gate", "ipg", CCM_PCCR0, 26);\r\nclk[emma_ipg_gate] = imx_clk_gate("emma_ipg_gate", "ipg", CCM_PCCR0, 27);\r\nclk[dma_ipg_gate] = imx_clk_gate("dma_ipg_gate", "ipg", CCM_PCCR0, 28);\r\nclk[cspi3_ipg_gate] = imx_clk_gate("cspi3_ipg_gate", "ipg", CCM_PCCR0, 29);\r\nclk[cspi2_ipg_gate] = imx_clk_gate("cspi2_ipg_gate", "ipg", CCM_PCCR0, 30);\r\nclk[cspi1_ipg_gate] = imx_clk_gate("cspi1_ipg_gate", "ipg", CCM_PCCR0, 31);\r\nclk[nfc_baud_gate] = imx_clk_gate("nfc_baud_gate", "nfc_div", CCM_PCCR1, 3);\r\nclk[ssi2_baud_gate] = imx_clk_gate("ssi2_baud_gate", "ssi2_div", CCM_PCCR1, 4);\r\nclk[ssi1_baud_gate] = imx_clk_gate("ssi1_baud_gate", "ssi1_div", CCM_PCCR1, 5);\r\nclk[vpu_baud_gate] = imx_clk_gate("vpu_baud_gate", "vpu_div", CCM_PCCR1, 6);\r\nclk[per4_gate] = imx_clk_gate("per4_gate", "per4_div", CCM_PCCR1, 7);\r\nclk[per3_gate] = imx_clk_gate("per3_gate", "per3_div", CCM_PCCR1, 8);\r\nclk[per2_gate] = imx_clk_gate("per2_gate", "per2_div", CCM_PCCR1, 9);\r\nclk[per1_gate] = imx_clk_gate("per1_gate", "per1_div", CCM_PCCR1, 10);\r\nclk[usb_ahb_gate] = imx_clk_gate("usb_ahb_gate", "ahb", CCM_PCCR1, 11);\r\nclk[slcdc_ahb_gate] = imx_clk_gate("slcdc_ahb_gate", "ahb", CCM_PCCR1, 12);\r\nclk[sahara_ahb_gate] = imx_clk_gate("sahara_ahb_gate", "ahb", CCM_PCCR1, 13);\r\nclk[lcdc_ahb_gate] = imx_clk_gate("lcdc_ahb_gate", "ahb", CCM_PCCR1, 15);\r\nclk[vpu_ahb_gate] = imx_clk_gate("vpu_ahb_gate", "ahb", CCM_PCCR1, 16);\r\nclk[fec_ahb_gate] = imx_clk_gate("fec_ahb_gate", "ahb", CCM_PCCR1, 17);\r\nclk[emma_ahb_gate] = imx_clk_gate("emma_ahb_gate", "ahb", CCM_PCCR1, 18);\r\nclk[emi_ahb_gate] = imx_clk_gate("emi_ahb_gate", "ahb", CCM_PCCR1, 19);\r\nclk[dma_ahb_gate] = imx_clk_gate("dma_ahb_gate", "ahb", CCM_PCCR1, 20);\r\nclk[csi_ahb_gate] = imx_clk_gate("csi_ahb_gate", "ahb", CCM_PCCR1, 21);\r\nclk[brom_ahb_gate] = imx_clk_gate("brom_ahb_gate", "ahb", CCM_PCCR1, 22);\r\nclk[ata_ahb_gate] = imx_clk_gate("ata_ahb_gate", "ahb", CCM_PCCR1, 23);\r\nclk[wdog_ipg_gate] = imx_clk_gate("wdog_ipg_gate", "ipg", CCM_PCCR1, 24);\r\nclk[usb_ipg_gate] = imx_clk_gate("usb_ipg_gate", "ipg", CCM_PCCR1, 25);\r\nclk[uart6_ipg_gate] = imx_clk_gate("uart6_ipg_gate", "ipg", CCM_PCCR1, 26);\r\nclk[uart5_ipg_gate] = imx_clk_gate("uart5_ipg_gate", "ipg", CCM_PCCR1, 27);\r\nclk[uart4_ipg_gate] = imx_clk_gate("uart4_ipg_gate", "ipg", CCM_PCCR1, 28);\r\nclk[uart3_ipg_gate] = imx_clk_gate("uart3_ipg_gate", "ipg", CCM_PCCR1, 29);\r\nclk[uart2_ipg_gate] = imx_clk_gate("uart2_ipg_gate", "ipg", CCM_PCCR1, 30);\r\nclk[uart1_ipg_gate] = imx_clk_gate("uart1_ipg_gate", "ipg", CCM_PCCR1, 31);\r\nfor (i = 0; i < ARRAY_SIZE(clk); i++)\r\nif (IS_ERR(clk[i]))\r\npr_err("i.MX27 clk %d: register failed with %ld\n",\r\ni, PTR_ERR(clk[i]));\r\nnp = of_find_compatible_node(NULL, NULL, "fsl,imx27-ccm");\r\nif (np) {\r\nclk_data.clks = clk;\r\nclk_data.clk_num = ARRAY_SIZE(clk);\r\nof_clk_add_provider(np, of_clk_src_onecell_get, &clk_data);\r\n}\r\nclk_register_clkdev(clk[uart1_ipg_gate], "ipg", "imx21-uart.0");\r\nclk_register_clkdev(clk[per1_gate], "per", "imx21-uart.0");\r\nclk_register_clkdev(clk[uart2_ipg_gate], "ipg", "imx21-uart.1");\r\nclk_register_clkdev(clk[per1_gate], "per", "imx21-uart.1");\r\nclk_register_clkdev(clk[uart3_ipg_gate], "ipg", "imx21-uart.2");\r\nclk_register_clkdev(clk[per1_gate], "per", "imx21-uart.2");\r\nclk_register_clkdev(clk[uart4_ipg_gate], "ipg", "imx21-uart.3");\r\nclk_register_clkdev(clk[per1_gate], "per", "imx21-uart.3");\r\nclk_register_clkdev(clk[uart5_ipg_gate], "ipg", "imx21-uart.4");\r\nclk_register_clkdev(clk[per1_gate], "per", "imx21-uart.4");\r\nclk_register_clkdev(clk[uart6_ipg_gate], "ipg", "imx21-uart.5");\r\nclk_register_clkdev(clk[per1_gate], "per", "imx21-uart.5");\r\nclk_register_clkdev(clk[gpt1_ipg_gate], "ipg", "imx-gpt.0");\r\nclk_register_clkdev(clk[per1_gate], "per", "imx-gpt.0");\r\nclk_register_clkdev(clk[gpt2_ipg_gate], "ipg", "imx-gpt.1");\r\nclk_register_clkdev(clk[per1_gate], "per", "imx-gpt.1");\r\nclk_register_clkdev(clk[gpt3_ipg_gate], "ipg", "imx-gpt.2");\r\nclk_register_clkdev(clk[per1_gate], "per", "imx-gpt.2");\r\nclk_register_clkdev(clk[gpt4_ipg_gate], "ipg", "imx-gpt.3");\r\nclk_register_clkdev(clk[per1_gate], "per", "imx-gpt.3");\r\nclk_register_clkdev(clk[gpt5_ipg_gate], "ipg", "imx-gpt.4");\r\nclk_register_clkdev(clk[per1_gate], "per", "imx-gpt.4");\r\nclk_register_clkdev(clk[gpt6_ipg_gate], "ipg", "imx-gpt.5");\r\nclk_register_clkdev(clk[per1_gate], "per", "imx-gpt.5");\r\nclk_register_clkdev(clk[pwm_ipg_gate], NULL, "mxc_pwm.0");\r\nclk_register_clkdev(clk[per2_gate], "per", "imx21-mmc.0");\r\nclk_register_clkdev(clk[sdhc1_ipg_gate], "ipg", "imx21-mmc.0");\r\nclk_register_clkdev(clk[per2_gate], "per", "imx21-mmc.1");\r\nclk_register_clkdev(clk[sdhc2_ipg_gate], "ipg", "imx21-mmc.1");\r\nclk_register_clkdev(clk[per2_gate], "per", "imx21-mmc.2");\r\nclk_register_clkdev(clk[sdhc2_ipg_gate], "ipg", "imx21-mmc.2");\r\nclk_register_clkdev(clk[per2_gate], "per", "imx27-cspi.0");\r\nclk_register_clkdev(clk[cspi1_ipg_gate], "ipg", "imx27-cspi.0");\r\nclk_register_clkdev(clk[per2_gate], "per", "imx27-cspi.1");\r\nclk_register_clkdev(clk[cspi2_ipg_gate], "ipg", "imx27-cspi.1");\r\nclk_register_clkdev(clk[per2_gate], "per", "imx27-cspi.2");\r\nclk_register_clkdev(clk[cspi3_ipg_gate], "ipg", "imx27-cspi.2");\r\nclk_register_clkdev(clk[per3_gate], "per", "imx21-fb.0");\r\nclk_register_clkdev(clk[lcdc_ipg_gate], "ipg", "imx21-fb.0");\r\nclk_register_clkdev(clk[lcdc_ahb_gate], "ahb", "imx21-fb.0");\r\nclk_register_clkdev(clk[csi_ahb_gate], "ahb", "imx27-camera.0");\r\nclk_register_clkdev(clk[per4_gate], "per", "imx27-camera.0");\r\nclk_register_clkdev(clk[usb_div], "per", "imx-udc-mx27");\r\nclk_register_clkdev(clk[usb_ipg_gate], "ipg", "imx-udc-mx27");\r\nclk_register_clkdev(clk[usb_ahb_gate], "ahb", "imx-udc-mx27");\r\nclk_register_clkdev(clk[usb_div], "per", "mxc-ehci.0");\r\nclk_register_clkdev(clk[usb_ipg_gate], "ipg", "mxc-ehci.0");\r\nclk_register_clkdev(clk[usb_ahb_gate], "ahb", "mxc-ehci.0");\r\nclk_register_clkdev(clk[usb_div], "per", "mxc-ehci.1");\r\nclk_register_clkdev(clk[usb_ipg_gate], "ipg", "mxc-ehci.1");\r\nclk_register_clkdev(clk[usb_ahb_gate], "ahb", "mxc-ehci.1");\r\nclk_register_clkdev(clk[usb_div], "per", "mxc-ehci.2");\r\nclk_register_clkdev(clk[usb_ipg_gate], "ipg", "mxc-ehci.2");\r\nclk_register_clkdev(clk[usb_ahb_gate], "ahb", "mxc-ehci.2");\r\nclk_register_clkdev(clk[ssi1_ipg_gate], NULL, "imx-ssi.0");\r\nclk_register_clkdev(clk[ssi2_ipg_gate], NULL, "imx-ssi.1");\r\nclk_register_clkdev(clk[nfc_baud_gate], NULL, "imx27-nand.0");\r\nclk_register_clkdev(clk[vpu_baud_gate], "per", "coda-imx27.0");\r\nclk_register_clkdev(clk[vpu_ahb_gate], "ahb", "coda-imx27.0");\r\nclk_register_clkdev(clk[dma_ahb_gate], "ahb", "imx27-dma");\r\nclk_register_clkdev(clk[dma_ipg_gate], "ipg", "imx27-dma");\r\nclk_register_clkdev(clk[fec_ipg_gate], "ipg", "imx27-fec.0");\r\nclk_register_clkdev(clk[fec_ahb_gate], "ahb", "imx27-fec.0");\r\nclk_register_clkdev(clk[wdog_ipg_gate], NULL, "imx2-wdt.0");\r\nclk_register_clkdev(clk[i2c1_ipg_gate], NULL, "imx21-i2c.0");\r\nclk_register_clkdev(clk[i2c2_ipg_gate], NULL, "imx21-i2c.1");\r\nclk_register_clkdev(clk[owire_ipg_gate], NULL, "mxc_w1.0");\r\nclk_register_clkdev(clk[kpp_ipg_gate], NULL, "imx-keypad");\r\nclk_register_clkdev(clk[emma_ahb_gate], "emma-ahb", "imx27-camera.0");\r\nclk_register_clkdev(clk[emma_ipg_gate], "emma-ipg", "imx27-camera.0");\r\nclk_register_clkdev(clk[emma_ahb_gate], "ahb", "m2m-emmaprp.0");\r\nclk_register_clkdev(clk[emma_ipg_gate], "ipg", "m2m-emmaprp.0");\r\nclk_register_clkdev(clk[iim_ipg_gate], "iim", NULL);\r\nclk_register_clkdev(clk[gpio_ipg_gate], "gpio", NULL);\r\nclk_register_clkdev(clk[brom_ahb_gate], "brom", NULL);\r\nclk_register_clkdev(clk[ata_ahb_gate], "ata", NULL);\r\nclk_register_clkdev(clk[rtc_ipg_gate], NULL, "imx21-rtc");\r\nclk_register_clkdev(clk[scc_ipg_gate], "scc", NULL);\r\nclk_register_clkdev(clk[cpu_div], NULL, "cpu0");\r\nclk_register_clkdev(clk[emi_ahb_gate], "emi_ahb" , NULL);\r\nmxc_timer_init(MX27_IO_ADDRESS(MX27_GPT1_BASE_ADDR), MX27_INT_GPT1);\r\nclk_prepare_enable(clk[emi_ahb_gate]);\r\nimx_print_silicon_rev("i.MX27", mx27_revision());\r\nreturn 0;\r\n}\r\nint __init mx27_clocks_init_dt(void)\r\n{\r\nstruct device_node *np;\r\nu32 fref = 26000000;\r\nfor_each_compatible_node(np, NULL, "fixed-clock") {\r\nif (!of_device_is_compatible(np, "fsl,imx-osc26m"))\r\ncontinue;\r\nif (!of_property_read_u32(np, "clock-frequency", &fref))\r\nbreak;\r\n}\r\nreturn mx27_clocks_init(fref);\r\n}

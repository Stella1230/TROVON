static int ls1x_pll_clk_enable(struct clk_hw *hw)\r\n{\r\nreturn 0;\r\n}\r\nstatic void ls1x_pll_clk_disable(struct clk_hw *hw)\r\n{\r\n}\r\nstatic unsigned long ls1x_pll_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nu32 pll, rate;\r\npll = __raw_readl(LS1X_CLK_PLL_FREQ);\r\nrate = ((12 + (pll & 0x3f)) * 1000000) +\r\n((((pll >> 8) & 0x3ff) * 1000000) >> 10);\r\nrate *= OSC;\r\nrate >>= 1;\r\nreturn rate;\r\n}\r\nstatic struct clk * __init clk_register_pll(struct device *dev,\r\nconst char *name, const char *parent_name, unsigned long flags)\r\n{\r\nstruct clk_hw *hw;\r\nstruct clk *clk;\r\nstruct clk_init_data init;\r\nhw = kzalloc(sizeof(struct clk_hw), GFP_KERNEL);\r\nif (!hw) {\r\npr_err("%s: could not allocate clk_hw\n", __func__);\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\ninit.name = name;\r\ninit.ops = &ls1x_pll_clk_ops;\r\ninit.flags = flags | CLK_IS_BASIC;\r\ninit.parent_names = (parent_name ? &parent_name : NULL);\r\ninit.num_parents = (parent_name ? 1 : 0);\r\nhw->init = &init;\r\nclk = clk_register(dev, hw);\r\nif (IS_ERR(clk))\r\nkfree(hw);\r\nreturn clk;\r\n}\r\nvoid __init ls1x_clk_init(void)\r\n{\r\nstruct clk *clk;\r\nclk = clk_register_pll(NULL, "pll_clk", NULL, CLK_IS_ROOT);\r\nclk_prepare_enable(clk);\r\nclk = clk_register_divider(NULL, "cpu_clk", "pll_clk",\r\nCLK_SET_RATE_PARENT, LS1X_CLK_PLL_DIV, DIV_CPU_SHIFT,\r\nDIV_CPU_WIDTH, CLK_DIVIDER_ONE_BASED, &_lock);\r\nclk_prepare_enable(clk);\r\nclk_register_clkdev(clk, "cpu", NULL);\r\nclk = clk_register_divider(NULL, "dc_clk", "pll_clk",\r\nCLK_SET_RATE_PARENT, LS1X_CLK_PLL_DIV, DIV_DC_SHIFT,\r\nDIV_DC_WIDTH, CLK_DIVIDER_ONE_BASED, &_lock);\r\nclk_prepare_enable(clk);\r\nclk_register_clkdev(clk, "dc", NULL);\r\nclk = clk_register_divider(NULL, "ahb_clk", "pll_clk",\r\nCLK_SET_RATE_PARENT, LS1X_CLK_PLL_DIV, DIV_DDR_SHIFT,\r\nDIV_DDR_WIDTH, CLK_DIVIDER_ONE_BASED, &_lock);\r\nclk_prepare_enable(clk);\r\nclk_register_clkdev(clk, "ahb", NULL);\r\nclk_register_clkdev(clk, "stmmaceth", NULL);\r\nclk = clk_register_fixed_factor(NULL, "apb_clk", "ahb_clk", 0, 1, 2);\r\nclk_prepare_enable(clk);\r\nclk_register_clkdev(clk, "apb", NULL);\r\nclk_register_clkdev(clk, "serial8250", NULL);\r\n}

static void fs_update(u32 pe_bits, int md_bits, u32 sdiv_bits,\r\nu32 disable_div_by_3, u32 standby)\r\n{\r\nu32 val;\r\nval = ((sdiv_bits << QAM_FS_SDIV_SHIFT) |\r\n((md_bits & QAM_FS_MD_MASK) << QAM_FS_MD_SHIFT) |\r\n(pe_bits << QAM_FS_PE_SHIFT) |\r\nQAM_FS_ENABLE_OUTPUT |\r\nstandby |\r\ndisable_div_by_3);\r\nasic_write(val, fs432x4b4_usb_ctl);\r\nasic_write(val | QAM_FS_ENABLE_PROGRAM, fs432x4b4_usb_ctl);\r\nasic_write(val | QAM_FS_ENABLE_PROGRAM | QAM_FS_CHOOSE_FS,\r\nfs432x4b4_usb_ctl);\r\n}\r\nstatic void usb_eye_configure(u32 set, u32 clear)\r\n{\r\nu32 old;\r\nold = asic_read(crt_spare);\r\nold |= set;\r\nold &= ~clear;\r\nasic_write(old, crt_spare);\r\n}\r\nstatic void platform_configure_usb(void)\r\n{\r\nu32 bcm1_usb2_ctl_value;\r\nenum asic_type asic_type;\r\nunsigned long flags;\r\nspin_lock_irqsave(&usb_regs_lock, flags);\r\nusb_users++;\r\nif (usb_users != 1) {\r\nspin_unlock_irqrestore(&usb_regs_lock, flags);\r\nreturn;\r\n}\r\nasic_type = platform_get_asic();\r\nswitch (asic_type) {\r\ncase ASIC_ZEUS:\r\nfs_update(0x0000, -15, 0x02, 0, 0);\r\nbcm1_usb2_ctl_value = BCM1_USB2_CTL_EHCI_PRT_PWR_ACTIVE_HIGH |\r\nBCM1_USB2_CTL_APP_PRT_OVRCUR_IN_ACTIVE_HIGH;\r\nbreak;\r\ncase ASIC_CRONUS:\r\ncase ASIC_CRONUSLITE:\r\nusb_eye_configure(0, CRT_SPARE_USB_DIVIDE_BY_9);\r\nfs_update(0x8000, -14, 0x03, QAM_FS_DISABLE_DIVIDE_BY_3,\r\nQAM_FS_DISABLE_DIGITAL_STANDBY);\r\nbcm1_usb2_ctl_value = BCM1_USB2_CTL_EHCI_PRT_PWR_ACTIVE_HIGH |\r\nBCM1_USB2_CTL_APP_PRT_OVRCUR_IN_ACTIVE_HIGH;\r\nbreak;\r\ncase ASIC_CALLIOPE:\r\nfs_update(0x0000, -15, 0x02, QAM_FS_DISABLE_DIVIDE_BY_3,\r\nQAM_FS_DISABLE_DIGITAL_STANDBY);\r\nswitch (platform_get_family()) {\r\ncase FAMILY_1500VZE:\r\nbreak;\r\ncase FAMILY_1500VZF:\r\nusb_eye_configure(CRT_SPARE_PORT2_SHIFT_JK |\r\nCRT_SPARE_PORT1_SHIFT_JK |\r\nCRT_SPARE_PORT2_FAST_EDGE |\r\nCRT_SPARE_PORT1_FAST_EDGE, 0);\r\nbreak;\r\ndefault:\r\nusb_eye_configure(CRT_SPARE_PORT2_SHIFT_JK |\r\nCRT_SPARE_PORT1_SHIFT_JK, 0);\r\nbreak;\r\n}\r\nbcm1_usb2_ctl_value = BCM1_USB2_CTL_BISTOK |\r\nBCM1_USB2_CTL_EHCI_PRT_PWR_ACTIVE_HIGH |\r\nBCM1_USB2_CTL_APP_PRT_OVRCUR_IN_ACTIVE_HIGH;\r\nbreak;\r\ncase ASIC_GAIA:\r\nfs_update(0x8000, -14, 0x03, QAM_FS_DISABLE_DIVIDE_BY_3,\r\nQAM_FS_DISABLE_DIGITAL_STANDBY);\r\nbcm1_usb2_ctl_value = BCM1_USB2_CTL_BISTOK |\r\nBCM1_USB2_CTL_EHCI_PRT_PWR_ACTIVE_HIGH |\r\nBCM1_USB2_CTL_APP_PRT_OVRCUR_IN_ACTIVE_HIGH;\r\nbreak;\r\ndefault:\r\npr_err("Unknown ASIC type: %d\n", asic_type);\r\nbcm1_usb2_ctl_value = 0;\r\nbreak;\r\n}\r\nasic_write(0, usb2_strap);\r\nasic_write(bcm1_usb2_ctl_value, usb2_control);\r\nasic_write(USB_STBUS_OBC_STORE32_LOAD32, usb2_stbus_obc);\r\nasic_write(USB2_STBUS_MESS_SIZE_2, usb2_stbus_mess_size);\r\nasic_write(USB2_STBUS_CHUNK_SIZE_2, usb2_stbus_chunk_size);\r\nspin_unlock_irqrestore(&usb_regs_lock, flags);\r\n}\r\nstatic void platform_unconfigure_usb(void)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&usb_regs_lock, flags);\r\nusb_users--;\r\nif (usb_users == 0)\r\nasic_write(USB2_STRAP_HFREQ_SELECT, usb2_strap);\r\nspin_unlock_irqrestore(&usb_regs_lock, flags);\r\n}\r\nvoid platform_configure_usb_ehci()\r\n{\r\nplatform_configure_usb();\r\n}\r\nvoid platform_configure_usb_ohci()\r\n{\r\nplatform_configure_usb();\r\n}\r\nvoid platform_unconfigure_usb_ehci()\r\n{\r\nplatform_unconfigure_usb();\r\n}\r\nvoid platform_unconfigure_usb_ohci()\r\n{\r\nplatform_unconfigure_usb();\r\n}\r\nint __init platform_usb_devices_init(struct platform_device **ehci_dev,\r\nstruct platform_device **ohci_dev)\r\n{\r\n*ehci_dev = &ehci_device;\r\nehci_resources[0].start = asic_reg_phys_addr(ehci_hcapbase);\r\nehci_resources[0].end += ehci_resources[0].start;\r\n*ohci_dev = &ohci_device;\r\nohci_resources[0].start = asic_reg_phys_addr(ohci_hc_revision);\r\nohci_resources[0].end += ohci_resources[0].start;\r\nreturn 0;\r\n}

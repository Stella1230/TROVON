static int rngapi_reset(struct crypto_rng *tfm, u8 *seed, unsigned int slen)\r\n{\r\nu8 *buf = NULL;\r\nint err;\r\nif (!seed && slen) {\r\nbuf = kmalloc(slen, GFP_KERNEL);\r\nif (!buf)\r\nreturn -ENOMEM;\r\nget_random_bytes(buf, slen);\r\nseed = buf;\r\n}\r\nerr = crypto_rng_alg(tfm)->rng_reset(tfm, seed, slen);\r\nkfree(buf);\r\nreturn err;\r\n}\r\nstatic int crypto_init_rng_ops(struct crypto_tfm *tfm, u32 type, u32 mask)\r\n{\r\nstruct rng_alg *alg = &tfm->__crt_alg->cra_rng;\r\nstruct rng_tfm *ops = &tfm->crt_rng;\r\nops->rng_gen_random = alg->rng_make_random;\r\nops->rng_reset = rngapi_reset;\r\nreturn 0;\r\n}\r\nstatic int crypto_rng_report(struct sk_buff *skb, struct crypto_alg *alg)\r\n{\r\nstruct crypto_report_rng rrng;\r\nsnprintf(rrng.type, CRYPTO_MAX_ALG_NAME, "%s", "rng");\r\nrrng.seedsize = alg->cra_rng.seedsize;\r\nif (nla_put(skb, CRYPTOCFGA_REPORT_RNG,\r\nsizeof(struct crypto_report_rng), &rrng))\r\ngoto nla_put_failure;\r\nreturn 0;\r\nnla_put_failure:\r\nreturn -EMSGSIZE;\r\n}\r\nstatic int crypto_rng_report(struct sk_buff *skb, struct crypto_alg *alg)\r\n{\r\nreturn -ENOSYS;\r\n}\r\nstatic void crypto_rng_show(struct seq_file *m, struct crypto_alg *alg)\r\n{\r\nseq_printf(m, "type : rng\n");\r\nseq_printf(m, "seedsize : %u\n", alg->cra_rng.seedsize);\r\n}\r\nstatic unsigned int crypto_rng_ctxsize(struct crypto_alg *alg, u32 type,\r\nu32 mask)\r\n{\r\nreturn alg->cra_ctxsize;\r\n}\r\nint crypto_get_default_rng(void)\r\n{\r\nstruct crypto_rng *rng;\r\nint err;\r\nmutex_lock(&crypto_default_rng_lock);\r\nif (!crypto_default_rng) {\r\nrng = crypto_alloc_rng("stdrng", 0, 0);\r\nerr = PTR_ERR(rng);\r\nif (IS_ERR(rng))\r\ngoto unlock;\r\nerr = crypto_rng_reset(rng, NULL, crypto_rng_seedsize(rng));\r\nif (err) {\r\ncrypto_free_rng(rng);\r\ngoto unlock;\r\n}\r\ncrypto_default_rng = rng;\r\n}\r\ncrypto_default_rng_refcnt++;\r\nerr = 0;\r\nunlock:\r\nmutex_unlock(&crypto_default_rng_lock);\r\nreturn err;\r\n}\r\nvoid crypto_put_default_rng(void)\r\n{\r\nmutex_lock(&crypto_default_rng_lock);\r\nif (!--crypto_default_rng_refcnt) {\r\ncrypto_free_rng(crypto_default_rng);\r\ncrypto_default_rng = NULL;\r\n}\r\nmutex_unlock(&crypto_default_rng_lock);\r\n}

u8 r8712_usb_hal_bus_init(struct _adapter *padapter)\r\n{\r\nu8 val8 = 0;\r\nu8 ret = _SUCCESS;\r\nint PollingCnt = 20;\r\nstruct registry_priv *pregistrypriv = &padapter->registrypriv;\r\nif (pregistrypriv->chip_version == RTL8712_FPGA) {\r\nval8 = 0x01;\r\nr8712_write8(padapter, SYS_CLKR, val8);\r\nval8 = r8712_read8(padapter, SPS1_CTRL);\r\nval8 = val8 | 0x01;\r\nr8712_write8(padapter, SPS1_CTRL, val8);\r\nval8 = r8712_read8(padapter, AFE_MISC);\r\nval8 = val8 | 0x01;\r\nr8712_write8(padapter, AFE_MISC, val8);\r\nval8 = r8712_read8(padapter, LDOA15_CTRL);\r\nval8 = val8 | 0x01;\r\nr8712_write8(padapter, LDOA15_CTRL, val8);\r\nval8 = r8712_read8(padapter, SPS1_CTRL);\r\nval8 = val8 | 0x02;\r\nr8712_write8(padapter, SPS1_CTRL, val8);\r\nval8 = r8712_read8(padapter, AFE_MISC);\r\nval8 = val8 | 0x02;\r\nr8712_write8(padapter, AFE_MISC, val8);\r\nval8 = r8712_read8(padapter, SYS_ISO_CTRL + 1);\r\nval8 = val8 | 0x08;\r\nr8712_write8(padapter, SYS_ISO_CTRL + 1, val8);\r\nval8 = r8712_read8(padapter, SYS_ISO_CTRL + 1);\r\nval8 = val8 & 0xEF;\r\nr8712_write8(padapter, SYS_ISO_CTRL + 1, val8);\r\nval8 = r8712_read8(padapter, AFE_XTAL_CTRL + 1);\r\nval8 = val8 & 0xFB;\r\nr8712_write8(padapter, AFE_XTAL_CTRL + 1, val8);\r\nval8 = r8712_read8(padapter, AFE_PLL_CTRL);\r\nval8 = val8 | 0x01;\r\nr8712_write8(padapter, AFE_PLL_CTRL, val8);\r\nval8 = 0xEE;\r\nr8712_write8(padapter, SYS_ISO_CTRL, val8);\r\nval8 = r8712_read8(padapter, SYS_CLKR + 1);\r\nval8 = val8 | 0x08;\r\nr8712_write8(padapter, SYS_CLKR + 1, val8);\r\nval8 = r8712_read8(padapter, SYS_FUNC_EN + 1);\r\nval8 = val8 | 0x08;\r\nr8712_write8(padapter, SYS_FUNC_EN + 1, val8);\r\nval8 = val8 | 0x80;\r\nr8712_write8(padapter, SYS_FUNC_EN + 1, val8);\r\nval8 = r8712_read8(padapter, SYS_CLKR + 1);\r\nval8 = (val8 | 0x80) & 0xBF;\r\nr8712_write8(padapter, SYS_CLKR + 1, val8);\r\nval8 = 0xFC;\r\nr8712_write8(padapter, CR, val8);\r\nval8 = 0x37;\r\nr8712_write8(padapter, CR + 1, val8);\r\nr8712_write8(padapter, 0x102500ab, r8712_read8(padapter,\r\n0x102500ab) | BIT(6) | BIT(7));\r\nr8712_write8(padapter, 0x10250008, r8712_read8(padapter,\r\n0x10250008) & 0xfffffffb);\r\n} else if (pregistrypriv->chip_version == RTL8712_1stCUT) {\r\nr8712_write8(padapter, SPS0_CTRL + 1, 0x53);\r\nr8712_write8(padapter, SPS0_CTRL, 0x57);\r\nval8 = r8712_read8(padapter, AFE_MISC);\r\nr8712_write8(padapter, AFE_MISC, (val8 | AFE_MISC_BGEN |\r\nAFE_MISC_MBEN));\r\nval8 = r8712_read8(padapter, LDOA15_CTRL);\r\nr8712_write8(padapter, LDOA15_CTRL, (val8 | LDA15_EN));\r\nval8 = r8712_read8(padapter, SPS1_CTRL);\r\nr8712_write8(padapter, SPS1_CTRL, (val8 | SPS1_LDEN));\r\nmsleep(20);\r\nval8 = r8712_read8(padapter, SPS1_CTRL);\r\nr8712_write8(padapter, SPS1_CTRL, (val8 | SPS1_SWEN));\r\nr8712_write32(padapter, SPS1_CTRL, 0x00a7b267);\r\nval8 = r8712_read8(padapter, SYS_ISO_CTRL + 1);\r\nr8712_write8(padapter, SYS_ISO_CTRL + 1, (val8 | 0x08));\r\nval8 = r8712_read8(padapter, SYS_FUNC_EN + 1);\r\nr8712_write8(padapter, SYS_FUNC_EN + 1, (val8 | 0x20));\r\nval8 = r8712_read8(padapter, SYS_ISO_CTRL + 1);\r\nr8712_write8(padapter, SYS_ISO_CTRL + 1, (val8 & 0x6F));\r\nval8 = r8712_read8(padapter, AFE_XTAL_CTRL + 1);\r\nr8712_write8(padapter, AFE_XTAL_CTRL + 1, (val8 & 0xfb));\r\nval8 = r8712_read8(padapter, AFE_PLL_CTRL);\r\nr8712_write8(padapter, AFE_PLL_CTRL, (val8 | 0x11));\r\nval8 = r8712_read8(padapter, SYS_ISO_CTRL);\r\nr8712_write8(padapter, SYS_ISO_CTRL, (val8 & 0xEE));\r\nval8 = r8712_read8(padapter, SYS_CLKR);\r\nr8712_write8(padapter, SYS_CLKR, val8 & (~SYS_CLKSEL));\r\nval8 = r8712_read8(padapter, SYS_CLKR);\r\nval8 = r8712_read8(padapter, SYS_CLKR + 1);\r\nr8712_write8(padapter, SYS_CLKR + 1, (val8 | 0x18));\r\nr8712_write8(padapter, PMC_FSM, 0x02);\r\nval8 = r8712_read8(padapter, SYS_FUNC_EN + 1);\r\nr8712_write8(padapter, SYS_FUNC_EN + 1, (val8 | 0x08));\r\nval8 = r8712_read8(padapter, SYS_FUNC_EN + 1);\r\nr8712_write8(padapter, SYS_FUNC_EN + 1, (val8 | 0x80));\r\nval8 = r8712_read8(padapter, SYS_CLKR + 1);\r\nr8712_write8(padapter, SYS_CLKR + 1, (val8 | 0x80) & 0xBF);\r\nr8712_write8(padapter, CR, 0xFC);\r\nr8712_write8(padapter, CR + 1, 0x37);\r\nval8 = r8712_read8(padapter, 0x1025FE5c);\r\nr8712_write8(padapter, 0x1025FE5c, (val8|BIT(7)));\r\nval8 = r8712_read8(padapter, 0x102500ab);\r\nr8712_write8(padapter, 0x102500ab, (val8|BIT(6)|BIT(7)));\r\nval8 = r8712_read8(padapter, SYS_CLKR);\r\nr8712_write8(padapter, SYS_CLKR, val8&(~CPU_CLKSEL));\r\n} else if (pregistrypriv->chip_version == RTL8712_2ndCUT ||\r\npregistrypriv->chip_version == RTL8712_3rdCUT) {\r\nr8712_write8(padapter, 0x37, 0xb0);\r\nmsleep(20);\r\nr8712_write8(padapter, 0x37, 0x30);\r\nval8 = r8712_read8(padapter, SYS_CLKR + 1);\r\nif (val8 & 0x80) {\r\nval8 &= 0x3f;\r\nr8712_write8(padapter, SYS_CLKR + 1, val8);\r\n}\r\nval8 = r8712_read8(padapter, SYS_FUNC_EN + 1);\r\nval8 &= 0x73;\r\nr8712_write8(padapter, SYS_FUNC_EN + 1, val8);\r\nmsleep(20);\r\nr8712_write8(padapter, SPS0_CTRL + 1, 0x53);\r\nr8712_write8(padapter, SPS0_CTRL, 0x57);\r\nval8 = r8712_read8(padapter, AFE_MISC);\r\nr8712_write8(padapter, AFE_MISC, (val8 | AFE_MISC_BGEN));\r\nr8712_write8(padapter, AFE_MISC, (val8 | AFE_MISC_BGEN |\r\nAFE_MISC_MBEN | AFE_MISC_I32_EN));\r\nval8 = r8712_read8(padapter, LDOA15_CTRL);\r\nr8712_write8(padapter, LDOA15_CTRL, (val8 | LDA15_EN));\r\nval8 = r8712_read8(padapter, LDOV12D_CTRL);\r\nr8712_write8(padapter, LDOV12D_CTRL, (val8 | LDV12_EN));\r\nval8 = r8712_read8(padapter, SYS_ISO_CTRL + 1);\r\nr8712_write8(padapter, SYS_ISO_CTRL + 1, (val8 | 0x08));\r\nval8 = r8712_read8(padapter, SYS_FUNC_EN + 1);\r\nr8712_write8(padapter, SYS_FUNC_EN + 1, (val8 | 0x20));\r\nval8 = r8712_read8(padapter, SYS_ISO_CTRL + 1);\r\nr8712_write8(padapter, SYS_ISO_CTRL + 1, (val8 & 0x68));\r\nval8 = r8712_read8(padapter, AFE_XTAL_CTRL + 1);\r\nr8712_write8(padapter, AFE_XTAL_CTRL + 1, (val8 & 0xfb));\r\nval8 = r8712_read8(padapter, AFE_PLL_CTRL);\r\nr8712_write8(padapter, AFE_PLL_CTRL, (val8 | 0x11));\r\nudelay(500);\r\nr8712_write8(padapter, AFE_PLL_CTRL, (val8 | 0x51));\r\nudelay(500);\r\nr8712_write8(padapter, AFE_PLL_CTRL, (val8 | 0x11));\r\nudelay(500);\r\nval8 = r8712_read8(padapter, SYS_ISO_CTRL);\r\nr8712_write8(padapter, SYS_ISO_CTRL, (val8 & 0xEE));\r\nr8712_write8(padapter, SYS_CLKR, 0x00);\r\nval8 = r8712_read8(padapter, SYS_CLKR);\r\nr8712_write8(padapter, SYS_CLKR, (val8 | 0xa0));\r\nval8 = r8712_read8(padapter, SYS_CLKR + 1);\r\nr8712_write8(padapter, SYS_CLKR + 1, (val8 | 0x18));\r\nr8712_write8(padapter, PMC_FSM, 0x02);\r\nval8 = r8712_read8(padapter, SYS_FUNC_EN + 1);\r\nr8712_write8(padapter, SYS_FUNC_EN + 1, (val8 | 0x08));\r\nval8 = r8712_read8(padapter, SYS_FUNC_EN + 1);\r\nr8712_write8(padapter, SYS_FUNC_EN + 1, (val8 | 0x80));\r\nval8 = r8712_read8(padapter, SYS_CLKR + 1);\r\nr8712_write8(padapter, SYS_CLKR + 1, (val8 | 0x80) & 0xBF);\r\nr8712_write8(padapter, CR, 0xFC);\r\nr8712_write8(padapter, CR + 1, 0x37);\r\nval8 = r8712_read8(padapter, 0x1025FE5c);\r\nr8712_write8(padapter, 0x1025FE5c, (val8 | BIT(7)));\r\nval8 = r8712_read8(padapter, SYS_CLKR);\r\nr8712_write8(padapter, SYS_CLKR, val8 & (~CPU_CLKSEL));\r\nr8712_write8(padapter, 0x1025fe1c, 0x80);\r\ndo {\r\nval8 = r8712_read8(padapter, TCR);\r\nif ((val8 & _TXDMA_INIT_VALUE) == _TXDMA_INIT_VALUE)\r\nbreak;\r\nudelay(5);\r\n} while (PollingCnt--);\r\nif (PollingCnt <= 0) {\r\nval8 = r8712_read8(padapter, CR);\r\nr8712_write8(padapter, CR, val8&(~_TXDMA_EN));\r\nudelay(2);\r\nr8712_write8(padapter, CR, val8|_TXDMA_EN);\r\n}\r\n} else\r\nret = _FAIL;\r\nreturn ret;\r\n}\r\nunsigned int r8712_usb_inirp_init(struct _adapter *padapter)\r\n{\r\nu8 i;\r\nstruct recv_buf *precvbuf;\r\nstruct intf_hdl *pintfhdl = &padapter->pio_queue->intf;\r\nstruct recv_priv *precvpriv = &(padapter->recvpriv);\r\nprecvpriv->ff_hwaddr = RTL8712_DMA_RX0FF;\r\nprecvbuf = (struct recv_buf *)precvpriv->precv_buf;\r\nfor (i = 0; i < NR_RECVBUFF; i++) {\r\nif (r8712_usb_read_port(pintfhdl, precvpriv->ff_hwaddr, 0,\r\n(unsigned char *)precvbuf) == false)\r\nreturn _FAIL;\r\nprecvbuf++;\r\nprecvpriv->free_recv_buf_queue_cnt--;\r\n}\r\nreturn _SUCCESS;\r\n}\r\nunsigned int r8712_usb_inirp_deinit(struct _adapter *padapter)\r\n{\r\nr8712_usb_read_port_cancel(padapter);\r\nreturn _SUCCESS;\r\n}

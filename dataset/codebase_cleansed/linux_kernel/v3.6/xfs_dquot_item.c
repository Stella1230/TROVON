static inline struct xfs_dq_logitem *DQUOT_ITEM(struct xfs_log_item *lip)\r\n{\r\nreturn container_of(lip, struct xfs_dq_logitem, qli_item);\r\n}\r\nSTATIC uint\r\nxfs_qm_dquot_logitem_size(\r\nstruct xfs_log_item *lip)\r\n{\r\nreturn 2;\r\n}\r\nSTATIC void\r\nxfs_qm_dquot_logitem_format(\r\nstruct xfs_log_item *lip,\r\nstruct xfs_log_iovec *logvec)\r\n{\r\nstruct xfs_dq_logitem *qlip = DQUOT_ITEM(lip);\r\nlogvec->i_addr = &qlip->qli_format;\r\nlogvec->i_len = sizeof(xfs_dq_logformat_t);\r\nlogvec->i_type = XLOG_REG_TYPE_QFORMAT;\r\nlogvec++;\r\nlogvec->i_addr = &qlip->qli_dquot->q_core;\r\nlogvec->i_len = sizeof(xfs_disk_dquot_t);\r\nlogvec->i_type = XLOG_REG_TYPE_DQUOT;\r\nqlip->qli_format.qlf_size = 2;\r\n}\r\nSTATIC void\r\nxfs_qm_dquot_logitem_pin(\r\nstruct xfs_log_item *lip)\r\n{\r\nstruct xfs_dquot *dqp = DQUOT_ITEM(lip)->qli_dquot;\r\nASSERT(XFS_DQ_IS_LOCKED(dqp));\r\natomic_inc(&dqp->q_pincount);\r\n}\r\nSTATIC void\r\nxfs_qm_dquot_logitem_unpin(\r\nstruct xfs_log_item *lip,\r\nint remove)\r\n{\r\nstruct xfs_dquot *dqp = DQUOT_ITEM(lip)->qli_dquot;\r\nASSERT(atomic_read(&dqp->q_pincount) > 0);\r\nif (atomic_dec_and_test(&dqp->q_pincount))\r\nwake_up(&dqp->q_pinwait);\r\n}\r\nSTATIC xfs_lsn_t\r\nxfs_qm_dquot_logitem_committed(\r\nstruct xfs_log_item *lip,\r\nxfs_lsn_t lsn)\r\n{\r\nreturn lsn;\r\n}\r\nvoid\r\nxfs_qm_dqunpin_wait(\r\nstruct xfs_dquot *dqp)\r\n{\r\nASSERT(XFS_DQ_IS_LOCKED(dqp));\r\nif (atomic_read(&dqp->q_pincount) == 0)\r\nreturn;\r\nxfs_log_force(dqp->q_mount, 0);\r\nwait_event(dqp->q_pinwait, (atomic_read(&dqp->q_pincount) == 0));\r\n}\r\nSTATIC uint\r\nxfs_qm_dquot_logitem_push(\r\nstruct xfs_log_item *lip,\r\nstruct list_head *buffer_list)\r\n{\r\nstruct xfs_dquot *dqp = DQUOT_ITEM(lip)->qli_dquot;\r\nstruct xfs_buf *bp = NULL;\r\nuint rval = XFS_ITEM_SUCCESS;\r\nint error;\r\nif (atomic_read(&dqp->q_pincount) > 0)\r\nreturn XFS_ITEM_PINNED;\r\nif (!xfs_dqlock_nowait(dqp))\r\nreturn XFS_ITEM_LOCKED;\r\nif (atomic_read(&dqp->q_pincount) > 0) {\r\nrval = XFS_ITEM_PINNED;\r\ngoto out_unlock;\r\n}\r\nif (!xfs_dqflock_nowait(dqp)) {\r\nrval = XFS_ITEM_FLUSHING;\r\ngoto out_unlock;\r\n}\r\nspin_unlock(&lip->li_ailp->xa_lock);\r\nerror = xfs_qm_dqflush(dqp, &bp);\r\nif (error) {\r\nxfs_warn(dqp->q_mount, "%s: push error %d on dqp %p",\r\n__func__, error, dqp);\r\n} else {\r\nif (!xfs_buf_delwri_queue(bp, buffer_list))\r\nrval = XFS_ITEM_FLUSHING;\r\nxfs_buf_relse(bp);\r\n}\r\nspin_lock(&lip->li_ailp->xa_lock);\r\nout_unlock:\r\nxfs_dqunlock(dqp);\r\nreturn rval;\r\n}\r\nSTATIC void\r\nxfs_qm_dquot_logitem_unlock(\r\nstruct xfs_log_item *lip)\r\n{\r\nstruct xfs_dquot *dqp = DQUOT_ITEM(lip)->qli_dquot;\r\nASSERT(XFS_DQ_IS_LOCKED(dqp));\r\ndqp->q_transp = NULL;\r\nxfs_dqunlock(dqp);\r\n}\r\nSTATIC void\r\nxfs_qm_dquot_logitem_committing(\r\nstruct xfs_log_item *lip,\r\nxfs_lsn_t lsn)\r\n{\r\n}\r\nvoid\r\nxfs_qm_dquot_logitem_init(\r\nstruct xfs_dquot *dqp)\r\n{\r\nstruct xfs_dq_logitem *lp = &dqp->q_logitem;\r\nxfs_log_item_init(dqp->q_mount, &lp->qli_item, XFS_LI_DQUOT,\r\n&xfs_dquot_item_ops);\r\nlp->qli_dquot = dqp;\r\nlp->qli_format.qlf_type = XFS_LI_DQUOT;\r\nlp->qli_format.qlf_id = be32_to_cpu(dqp->q_core.d_id);\r\nlp->qli_format.qlf_blkno = dqp->q_blkno;\r\nlp->qli_format.qlf_len = 1;\r\nlp->qli_format.qlf_boffset = (__uint32_t)dqp->q_bufoffset;\r\n}\r\nstatic inline struct xfs_qoff_logitem *QOFF_ITEM(struct xfs_log_item *lip)\r\n{\r\nreturn container_of(lip, struct xfs_qoff_logitem, qql_item);\r\n}\r\nSTATIC uint\r\nxfs_qm_qoff_logitem_size(\r\nstruct xfs_log_item *lip)\r\n{\r\nreturn 1;\r\n}\r\nSTATIC void\r\nxfs_qm_qoff_logitem_format(\r\nstruct xfs_log_item *lip,\r\nstruct xfs_log_iovec *log_vector)\r\n{\r\nstruct xfs_qoff_logitem *qflip = QOFF_ITEM(lip);\r\nASSERT(qflip->qql_format.qf_type == XFS_LI_QUOTAOFF);\r\nlog_vector->i_addr = &qflip->qql_format;\r\nlog_vector->i_len = sizeof(xfs_qoff_logitem_t);\r\nlog_vector->i_type = XLOG_REG_TYPE_QUOTAOFF;\r\nqflip->qql_format.qf_size = 1;\r\n}\r\nSTATIC void\r\nxfs_qm_qoff_logitem_pin(\r\nstruct xfs_log_item *lip)\r\n{\r\n}\r\nSTATIC void\r\nxfs_qm_qoff_logitem_unpin(\r\nstruct xfs_log_item *lip,\r\nint remove)\r\n{\r\n}\r\nSTATIC uint\r\nxfs_qm_qoff_logitem_push(\r\nstruct xfs_log_item *lip,\r\nstruct list_head *buffer_list)\r\n{\r\nreturn XFS_ITEM_LOCKED;\r\n}\r\nSTATIC void\r\nxfs_qm_qoff_logitem_unlock(\r\nstruct xfs_log_item *lip)\r\n{\r\n}\r\nSTATIC xfs_lsn_t\r\nxfs_qm_qoff_logitem_committed(\r\nstruct xfs_log_item *lip,\r\nxfs_lsn_t lsn)\r\n{\r\nreturn lsn;\r\n}\r\nSTATIC xfs_lsn_t\r\nxfs_qm_qoffend_logitem_committed(\r\nstruct xfs_log_item *lip,\r\nxfs_lsn_t lsn)\r\n{\r\nstruct xfs_qoff_logitem *qfe = QOFF_ITEM(lip);\r\nstruct xfs_qoff_logitem *qfs = qfe->qql_start_lip;\r\nstruct xfs_ail *ailp = qfs->qql_item.li_ailp;\r\nspin_lock(&ailp->xa_lock);\r\nxfs_trans_ail_delete(ailp, &qfs->qql_item, SHUTDOWN_LOG_IO_ERROR);\r\nkmem_free(qfs);\r\nkmem_free(qfe);\r\nreturn (xfs_lsn_t)-1;\r\n}\r\nSTATIC void\r\nxfs_qm_qoff_logitem_committing(\r\nstruct xfs_log_item *lip,\r\nxfs_lsn_t commit_lsn)\r\n{\r\n}\r\nstruct xfs_qoff_logitem *\r\nxfs_qm_qoff_logitem_init(\r\nstruct xfs_mount *mp,\r\nstruct xfs_qoff_logitem *start,\r\nuint flags)\r\n{\r\nstruct xfs_qoff_logitem *qf;\r\nqf = kmem_zalloc(sizeof(struct xfs_qoff_logitem), KM_SLEEP);\r\nxfs_log_item_init(mp, &qf->qql_item, XFS_LI_QUOTAOFF, start ?\r\n&xfs_qm_qoffend_logitem_ops : &xfs_qm_qoff_logitem_ops);\r\nqf->qql_item.li_mountp = mp;\r\nqf->qql_format.qf_type = XFS_LI_QUOTAOFF;\r\nqf->qql_format.qf_flags = flags;\r\nqf->qql_start_lip = start;\r\nreturn qf;\r\n}

static bool ak4535_volatile(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase AK4535_STATUS:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic int ak4535_set_dai_sysclk(struct snd_soc_dai *codec_dai,\r\nint clk_id, unsigned int freq, int dir)\r\n{\r\nstruct snd_soc_codec *codec = codec_dai->codec;\r\nstruct ak4535_priv *ak4535 = snd_soc_codec_get_drvdata(codec);\r\nak4535->sysclk = freq;\r\nreturn 0;\r\n}\r\nstatic int ak4535_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nstruct ak4535_priv *ak4535 = snd_soc_codec_get_drvdata(codec);\r\nu8 mode2 = snd_soc_read(codec, AK4535_MODE2) & ~(0x3 << 5);\r\nint rate = params_rate(params), fs = 256;\r\nif (rate)\r\nfs = ak4535->sysclk / rate;\r\nswitch (fs) {\r\ncase 1024:\r\nmode2 |= (0x2 << 5);\r\nbreak;\r\ncase 512:\r\nmode2 |= (0x1 << 5);\r\nbreak;\r\ncase 256:\r\nbreak;\r\n}\r\nsnd_soc_write(codec, AK4535_MODE2, mode2);\r\nreturn 0;\r\n}\r\nstatic int ak4535_set_dai_fmt(struct snd_soc_dai *codec_dai,\r\nunsigned int fmt)\r\n{\r\nstruct snd_soc_codec *codec = codec_dai->codec;\r\nu8 mode1 = 0;\r\nswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\r\ncase SND_SOC_DAIFMT_I2S:\r\nmode1 = 0x0002;\r\nbreak;\r\ncase SND_SOC_DAIFMT_LEFT_J:\r\nmode1 = 0x0001;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nmode1 |= 0x4;\r\nsnd_soc_write(codec, AK4535_MODE1, mode1);\r\nreturn 0;\r\n}\r\nstatic int ak4535_mute(struct snd_soc_dai *dai, int mute)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nu16 mute_reg = snd_soc_read(codec, AK4535_DAC);\r\nif (!mute)\r\nsnd_soc_write(codec, AK4535_DAC, mute_reg & ~0x20);\r\nelse\r\nsnd_soc_write(codec, AK4535_DAC, mute_reg | 0x20);\r\nreturn 0;\r\n}\r\nstatic int ak4535_set_bias_level(struct snd_soc_codec *codec,\r\nenum snd_soc_bias_level level)\r\n{\r\nswitch (level) {\r\ncase SND_SOC_BIAS_ON:\r\nsnd_soc_update_bits(codec, AK4535_DAC, 0x20, 0);\r\nbreak;\r\ncase SND_SOC_BIAS_PREPARE:\r\nsnd_soc_update_bits(codec, AK4535_DAC, 0x20, 0x20);\r\nbreak;\r\ncase SND_SOC_BIAS_STANDBY:\r\nsnd_soc_update_bits(codec, AK4535_PM1, 0x80, 0x80);\r\nsnd_soc_update_bits(codec, AK4535_PM2, 0x80, 0);\r\nbreak;\r\ncase SND_SOC_BIAS_OFF:\r\nsnd_soc_update_bits(codec, AK4535_PM1, 0x80, 0);\r\nbreak;\r\n}\r\ncodec->dapm.bias_level = level;\r\nreturn 0;\r\n}\r\nstatic int ak4535_suspend(struct snd_soc_codec *codec)\r\n{\r\nak4535_set_bias_level(codec, SND_SOC_BIAS_OFF);\r\nreturn 0;\r\n}\r\nstatic int ak4535_resume(struct snd_soc_codec *codec)\r\n{\r\nsnd_soc_cache_sync(codec);\r\nak4535_set_bias_level(codec, SND_SOC_BIAS_STANDBY);\r\nreturn 0;\r\n}\r\nstatic int ak4535_probe(struct snd_soc_codec *codec)\r\n{\r\nstruct ak4535_priv *ak4535 = snd_soc_codec_get_drvdata(codec);\r\nint ret;\r\ncodec->control_data = ak4535->regmap;\r\nret = snd_soc_codec_set_cache_io(codec, 8, 8, SND_SOC_REGMAP);\r\nif (ret < 0) {\r\ndev_err(codec->dev, "Failed to set cache I/O: %d\n", ret);\r\nreturn ret;\r\n}\r\nak4535_set_bias_level(codec, SND_SOC_BIAS_STANDBY);\r\nsnd_soc_add_codec_controls(codec, ak4535_snd_controls,\r\nARRAY_SIZE(ak4535_snd_controls));\r\nreturn 0;\r\n}\r\nstatic int ak4535_remove(struct snd_soc_codec *codec)\r\n{\r\nak4535_set_bias_level(codec, SND_SOC_BIAS_OFF);\r\nreturn 0;\r\n}\r\nstatic __devinit int ak4535_i2c_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct ak4535_priv *ak4535;\r\nint ret;\r\nak4535 = devm_kzalloc(&i2c->dev, sizeof(struct ak4535_priv),\r\nGFP_KERNEL);\r\nif (ak4535 == NULL)\r\nreturn -ENOMEM;\r\nak4535->regmap = regmap_init_i2c(i2c, &ak4535_regmap);\r\nif (IS_ERR(ak4535->regmap)) {\r\nret = PTR_ERR(ak4535->regmap);\r\ndev_err(&i2c->dev, "Failed to init regmap: %d\n", ret);\r\nreturn ret;\r\n}\r\ni2c_set_clientdata(i2c, ak4535);\r\nret = snd_soc_register_codec(&i2c->dev,\r\n&soc_codec_dev_ak4535, &ak4535_dai, 1);\r\nif (ret != 0)\r\nregmap_exit(ak4535->regmap);\r\nreturn ret;\r\n}\r\nstatic __devexit int ak4535_i2c_remove(struct i2c_client *client)\r\n{\r\nstruct ak4535_priv *ak4535 = i2c_get_clientdata(client);\r\nsnd_soc_unregister_codec(&client->dev);\r\nregmap_exit(ak4535->regmap);\r\nreturn 0;\r\n}

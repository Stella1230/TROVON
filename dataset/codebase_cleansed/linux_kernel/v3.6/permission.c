int key_task_permission(const key_ref_t key_ref, const struct cred *cred,\r\nkey_perm_t perm)\r\n{\r\nstruct key *key;\r\nkey_perm_t kperm;\r\nint ret;\r\nkey = key_ref_to_ptr(key_ref);\r\nif (key->user->user_ns != cred->user_ns)\r\ngoto use_other_perms;\r\nif (key->uid == cred->fsuid) {\r\nkperm = key->perm >> 16;\r\ngoto use_these_perms;\r\n}\r\nif (key->gid != -1 && key->perm & KEY_GRP_ALL) {\r\nif (key->gid == cred->fsgid) {\r\nkperm = key->perm >> 8;\r\ngoto use_these_perms;\r\n}\r\nret = groups_search(cred->group_info,\r\nmake_kgid(current_user_ns(), key->gid));\r\nif (ret) {\r\nkperm = key->perm >> 8;\r\ngoto use_these_perms;\r\n}\r\n}\r\nuse_other_perms:\r\nkperm = key->perm;\r\nuse_these_perms:\r\nif (is_key_possessed(key_ref))\r\nkperm |= key->perm >> 24;\r\nkperm = kperm & perm & KEY_ALL;\r\nif (kperm != perm)\r\nreturn -EACCES;\r\nreturn security_key_permission(key_ref, cred, perm);\r\n}\r\nint key_validate(const struct key *key)\r\n{\r\nunsigned long flags = key->flags;\r\nif (flags & (1 << KEY_FLAG_INVALIDATED))\r\nreturn -ENOKEY;\r\nif (flags & ((1 << KEY_FLAG_REVOKED) |\r\n(1 << KEY_FLAG_DEAD)))\r\nreturn -EKEYREVOKED;\r\nif (key->expiry) {\r\nstruct timespec now = current_kernel_time();\r\nif (now.tv_sec >= key->expiry)\r\nreturn -EKEYEXPIRED;\r\n}\r\nreturn 0;\r\n}

struct spu_gang *alloc_spu_gang(void)\r\n{\r\nstruct spu_gang *gang;\r\ngang = kzalloc(sizeof *gang, GFP_KERNEL);\r\nif (!gang)\r\ngoto out;\r\nkref_init(&gang->kref);\r\nmutex_init(&gang->mutex);\r\nmutex_init(&gang->aff_mutex);\r\nINIT_LIST_HEAD(&gang->list);\r\nINIT_LIST_HEAD(&gang->aff_list_head);\r\nout:\r\nreturn gang;\r\n}\r\nstatic void destroy_spu_gang(struct kref *kref)\r\n{\r\nstruct spu_gang *gang;\r\ngang = container_of(kref, struct spu_gang, kref);\r\nWARN_ON(gang->contexts || !list_empty(&gang->list));\r\nkfree(gang);\r\n}\r\nstruct spu_gang *get_spu_gang(struct spu_gang *gang)\r\n{\r\nkref_get(&gang->kref);\r\nreturn gang;\r\n}\r\nint put_spu_gang(struct spu_gang *gang)\r\n{\r\nreturn kref_put(&gang->kref, &destroy_spu_gang);\r\n}\r\nvoid spu_gang_add_ctx(struct spu_gang *gang, struct spu_context *ctx)\r\n{\r\nmutex_lock(&gang->mutex);\r\nctx->gang = get_spu_gang(gang);\r\nlist_add(&ctx->gang_list, &gang->list);\r\ngang->contexts++;\r\nmutex_unlock(&gang->mutex);\r\n}\r\nvoid spu_gang_remove_ctx(struct spu_gang *gang, struct spu_context *ctx)\r\n{\r\nmutex_lock(&gang->mutex);\r\nWARN_ON(ctx->gang != gang);\r\nif (!list_empty(&ctx->aff_list)) {\r\nlist_del_init(&ctx->aff_list);\r\ngang->aff_flags &= ~AFF_OFFSETS_SET;\r\n}\r\nlist_del_init(&ctx->gang_list);\r\ngang->contexts--;\r\nmutex_unlock(&gang->mutex);\r\nput_spu_gang(gang);\r\n}

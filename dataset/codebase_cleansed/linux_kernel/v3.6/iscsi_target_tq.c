static void iscsi_add_ts_to_active_list(struct iscsi_thread_set *ts)\r\n{\r\nspin_lock(&active_ts_lock);\r\nlist_add_tail(&ts->ts_list, &active_ts_list);\r\niscsit_global->active_ts++;\r\nspin_unlock(&active_ts_lock);\r\n}\r\nextern void iscsi_add_ts_to_inactive_list(struct iscsi_thread_set *ts)\r\n{\r\nspin_lock(&inactive_ts_lock);\r\nlist_add_tail(&ts->ts_list, &inactive_ts_list);\r\niscsit_global->inactive_ts++;\r\nspin_unlock(&inactive_ts_lock);\r\n}\r\nstatic void iscsi_del_ts_from_active_list(struct iscsi_thread_set *ts)\r\n{\r\nspin_lock(&active_ts_lock);\r\nlist_del(&ts->ts_list);\r\niscsit_global->active_ts--;\r\nspin_unlock(&active_ts_lock);\r\n}\r\nstatic struct iscsi_thread_set *iscsi_get_ts_from_inactive_list(void)\r\n{\r\nstruct iscsi_thread_set *ts;\r\nspin_lock(&inactive_ts_lock);\r\nif (list_empty(&inactive_ts_list)) {\r\nspin_unlock(&inactive_ts_lock);\r\nreturn NULL;\r\n}\r\nlist_for_each_entry(ts, &inactive_ts_list, ts_list)\r\nbreak;\r\nlist_del(&ts->ts_list);\r\niscsit_global->inactive_ts--;\r\nspin_unlock(&inactive_ts_lock);\r\nreturn ts;\r\n}\r\nextern int iscsi_allocate_thread_sets(u32 thread_pair_count)\r\n{\r\nint allocated_thread_pair_count = 0, i, thread_id;\r\nstruct iscsi_thread_set *ts = NULL;\r\nfor (i = 0; i < thread_pair_count; i++) {\r\nts = kzalloc(sizeof(struct iscsi_thread_set), GFP_KERNEL);\r\nif (!ts) {\r\npr_err("Unable to allocate memory for"\r\n" thread set.\n");\r\nreturn allocated_thread_pair_count;\r\n}\r\nspin_lock(&ts_bitmap_lock);\r\nthread_id = bitmap_find_free_region(iscsit_global->ts_bitmap,\r\niscsit_global->ts_bitmap_count, get_order(1));\r\nspin_unlock(&ts_bitmap_lock);\r\nif (thread_id < 0) {\r\npr_err("bitmap_find_free_region() failed for"\r\n" thread_set_bitmap\n");\r\nkfree(ts);\r\nreturn allocated_thread_pair_count;\r\n}\r\nts->thread_id = thread_id;\r\nts->status = ISCSI_THREAD_SET_FREE;\r\nINIT_LIST_HEAD(&ts->ts_list);\r\nspin_lock_init(&ts->ts_state_lock);\r\ninit_completion(&ts->rx_post_start_comp);\r\ninit_completion(&ts->tx_post_start_comp);\r\ninit_completion(&ts->rx_restart_comp);\r\ninit_completion(&ts->tx_restart_comp);\r\ninit_completion(&ts->rx_start_comp);\r\ninit_completion(&ts->tx_start_comp);\r\nts->create_threads = 1;\r\nts->tx_thread = kthread_run(iscsi_target_tx_thread, ts, "%s",\r\nISCSI_TX_THREAD_NAME);\r\nif (IS_ERR(ts->tx_thread)) {\r\ndump_stack();\r\npr_err("Unable to start iscsi_target_tx_thread\n");\r\nbreak;\r\n}\r\nts->rx_thread = kthread_run(iscsi_target_rx_thread, ts, "%s",\r\nISCSI_RX_THREAD_NAME);\r\nif (IS_ERR(ts->rx_thread)) {\r\nkthread_stop(ts->tx_thread);\r\npr_err("Unable to start iscsi_target_rx_thread\n");\r\nbreak;\r\n}\r\nts->create_threads = 0;\r\niscsi_add_ts_to_inactive_list(ts);\r\nallocated_thread_pair_count++;\r\n}\r\npr_debug("Spawned %d thread set(s) (%d total threads).\n",\r\nallocated_thread_pair_count, allocated_thread_pair_count * 2);\r\nreturn allocated_thread_pair_count;\r\n}\r\nextern void iscsi_deallocate_thread_sets(void)\r\n{\r\nu32 released_count = 0;\r\nstruct iscsi_thread_set *ts = NULL;\r\nwhile ((ts = iscsi_get_ts_from_inactive_list())) {\r\nspin_lock_bh(&ts->ts_state_lock);\r\nts->status = ISCSI_THREAD_SET_DIE;\r\nspin_unlock_bh(&ts->ts_state_lock);\r\nif (ts->rx_thread) {\r\nsend_sig(SIGINT, ts->rx_thread, 1);\r\nkthread_stop(ts->rx_thread);\r\n}\r\nif (ts->tx_thread) {\r\nsend_sig(SIGINT, ts->tx_thread, 1);\r\nkthread_stop(ts->tx_thread);\r\n}\r\nspin_lock(&ts_bitmap_lock);\r\nbitmap_release_region(iscsit_global->ts_bitmap,\r\nts->thread_id, get_order(1));\r\nspin_unlock(&ts_bitmap_lock);\r\nreleased_count++;\r\nkfree(ts);\r\n}\r\nif (released_count)\r\npr_debug("Stopped %d thread set(s) (%d total threads)."\r\n"\n", released_count, released_count * 2);\r\n}\r\nstatic void iscsi_deallocate_extra_thread_sets(void)\r\n{\r\nu32 orig_count, released_count = 0;\r\nstruct iscsi_thread_set *ts = NULL;\r\norig_count = TARGET_THREAD_SET_COUNT;\r\nwhile ((iscsit_global->inactive_ts + 1) > orig_count) {\r\nts = iscsi_get_ts_from_inactive_list();\r\nif (!ts)\r\nbreak;\r\nspin_lock_bh(&ts->ts_state_lock);\r\nts->status = ISCSI_THREAD_SET_DIE;\r\nspin_unlock_bh(&ts->ts_state_lock);\r\nif (ts->rx_thread) {\r\nsend_sig(SIGINT, ts->rx_thread, 1);\r\nkthread_stop(ts->rx_thread);\r\n}\r\nif (ts->tx_thread) {\r\nsend_sig(SIGINT, ts->tx_thread, 1);\r\nkthread_stop(ts->tx_thread);\r\n}\r\nspin_lock(&ts_bitmap_lock);\r\nbitmap_release_region(iscsit_global->ts_bitmap,\r\nts->thread_id, get_order(1));\r\nspin_unlock(&ts_bitmap_lock);\r\nreleased_count++;\r\nkfree(ts);\r\n}\r\nif (released_count) {\r\npr_debug("Stopped %d thread set(s) (%d total threads)."\r\n"\n", released_count, released_count * 2);\r\n}\r\n}\r\nvoid iscsi_activate_thread_set(struct iscsi_conn *conn, struct iscsi_thread_set *ts)\r\n{\r\niscsi_add_ts_to_active_list(ts);\r\nspin_lock_bh(&ts->ts_state_lock);\r\nconn->thread_set = ts;\r\nts->conn = conn;\r\nspin_unlock_bh(&ts->ts_state_lock);\r\ncomplete(&ts->rx_start_comp);\r\nwait_for_completion(&ts->rx_post_start_comp);\r\n}\r\nstruct iscsi_thread_set *iscsi_get_thread_set(void)\r\n{\r\nint allocate_ts = 0;\r\nstruct completion comp;\r\nstruct iscsi_thread_set *ts = NULL;\r\nget_set:\r\nts = iscsi_get_ts_from_inactive_list();\r\nif (!ts) {\r\nif (allocate_ts == 2)\r\niscsi_allocate_thread_sets(1);\r\ninit_completion(&comp);\r\nwait_for_completion_timeout(&comp, 1 * HZ);\r\nallocate_ts++;\r\ngoto get_set;\r\n}\r\nts->delay_inactive = 1;\r\nts->signal_sent = 0;\r\nts->thread_count = 2;\r\ninit_completion(&ts->rx_restart_comp);\r\ninit_completion(&ts->tx_restart_comp);\r\nreturn ts;\r\n}\r\nvoid iscsi_set_thread_clear(struct iscsi_conn *conn, u8 thread_clear)\r\n{\r\nstruct iscsi_thread_set *ts = NULL;\r\nif (!conn->thread_set) {\r\npr_err("struct iscsi_conn->thread_set is NULL\n");\r\nreturn;\r\n}\r\nts = conn->thread_set;\r\nspin_lock_bh(&ts->ts_state_lock);\r\nts->thread_clear &= ~thread_clear;\r\nif ((thread_clear & ISCSI_CLEAR_RX_THREAD) &&\r\n(ts->blocked_threads & ISCSI_BLOCK_RX_THREAD))\r\ncomplete(&ts->rx_restart_comp);\r\nelse if ((thread_clear & ISCSI_CLEAR_TX_THREAD) &&\r\n(ts->blocked_threads & ISCSI_BLOCK_TX_THREAD))\r\ncomplete(&ts->tx_restart_comp);\r\nspin_unlock_bh(&ts->ts_state_lock);\r\n}\r\nvoid iscsi_set_thread_set_signal(struct iscsi_conn *conn, u8 signal_sent)\r\n{\r\nstruct iscsi_thread_set *ts = NULL;\r\nif (!conn->thread_set) {\r\npr_err("struct iscsi_conn->thread_set is NULL\n");\r\nreturn;\r\n}\r\nts = conn->thread_set;\r\nspin_lock_bh(&ts->ts_state_lock);\r\nts->signal_sent |= signal_sent;\r\nspin_unlock_bh(&ts->ts_state_lock);\r\n}\r\nint iscsi_release_thread_set(struct iscsi_conn *conn)\r\n{\r\nint thread_called = 0;\r\nstruct iscsi_thread_set *ts = NULL;\r\nif (!conn || !conn->thread_set) {\r\npr_err("connection or thread set pointer is NULL\n");\r\nBUG();\r\n}\r\nts = conn->thread_set;\r\nspin_lock_bh(&ts->ts_state_lock);\r\nts->status = ISCSI_THREAD_SET_RESET;\r\nif (!strncmp(current->comm, ISCSI_RX_THREAD_NAME,\r\nstrlen(ISCSI_RX_THREAD_NAME)))\r\nthread_called = ISCSI_RX_THREAD;\r\nelse if (!strncmp(current->comm, ISCSI_TX_THREAD_NAME,\r\nstrlen(ISCSI_TX_THREAD_NAME)))\r\nthread_called = ISCSI_TX_THREAD;\r\nif (ts->rx_thread && (thread_called == ISCSI_TX_THREAD) &&\r\n(ts->thread_clear & ISCSI_CLEAR_RX_THREAD)) {\r\nif (!(ts->signal_sent & ISCSI_SIGNAL_RX_THREAD)) {\r\nsend_sig(SIGINT, ts->rx_thread, 1);\r\nts->signal_sent |= ISCSI_SIGNAL_RX_THREAD;\r\n}\r\nts->blocked_threads |= ISCSI_BLOCK_RX_THREAD;\r\nspin_unlock_bh(&ts->ts_state_lock);\r\nwait_for_completion(&ts->rx_restart_comp);\r\nspin_lock_bh(&ts->ts_state_lock);\r\nts->blocked_threads &= ~ISCSI_BLOCK_RX_THREAD;\r\n}\r\nif (ts->tx_thread && (thread_called == ISCSI_RX_THREAD) &&\r\n(ts->thread_clear & ISCSI_CLEAR_TX_THREAD)) {\r\nif (!(ts->signal_sent & ISCSI_SIGNAL_TX_THREAD)) {\r\nsend_sig(SIGINT, ts->tx_thread, 1);\r\nts->signal_sent |= ISCSI_SIGNAL_TX_THREAD;\r\n}\r\nts->blocked_threads |= ISCSI_BLOCK_TX_THREAD;\r\nspin_unlock_bh(&ts->ts_state_lock);\r\nwait_for_completion(&ts->tx_restart_comp);\r\nspin_lock_bh(&ts->ts_state_lock);\r\nts->blocked_threads &= ~ISCSI_BLOCK_TX_THREAD;\r\n}\r\nts->conn = NULL;\r\nts->status = ISCSI_THREAD_SET_FREE;\r\nspin_unlock_bh(&ts->ts_state_lock);\r\nreturn 0;\r\n}\r\nint iscsi_thread_set_force_reinstatement(struct iscsi_conn *conn)\r\n{\r\nstruct iscsi_thread_set *ts;\r\nif (!conn->thread_set)\r\nreturn -1;\r\nts = conn->thread_set;\r\nspin_lock_bh(&ts->ts_state_lock);\r\nif (ts->status != ISCSI_THREAD_SET_ACTIVE) {\r\nspin_unlock_bh(&ts->ts_state_lock);\r\nreturn -1;\r\n}\r\nif (ts->tx_thread && (!(ts->signal_sent & ISCSI_SIGNAL_TX_THREAD))) {\r\nsend_sig(SIGINT, ts->tx_thread, 1);\r\nts->signal_sent |= ISCSI_SIGNAL_TX_THREAD;\r\n}\r\nif (ts->rx_thread && (!(ts->signal_sent & ISCSI_SIGNAL_RX_THREAD))) {\r\nsend_sig(SIGINT, ts->rx_thread, 1);\r\nts->signal_sent |= ISCSI_SIGNAL_RX_THREAD;\r\n}\r\nspin_unlock_bh(&ts->ts_state_lock);\r\nreturn 0;\r\n}\r\nstatic void iscsi_check_to_add_additional_sets(void)\r\n{\r\nint thread_sets_add;\r\nspin_lock(&inactive_ts_lock);\r\nthread_sets_add = iscsit_global->inactive_ts;\r\nspin_unlock(&inactive_ts_lock);\r\nif (thread_sets_add == 1)\r\niscsi_allocate_thread_sets(1);\r\n}\r\nstatic int iscsi_signal_thread_pre_handler(struct iscsi_thread_set *ts)\r\n{\r\nspin_lock_bh(&ts->ts_state_lock);\r\nif ((ts->status == ISCSI_THREAD_SET_DIE) || signal_pending(current)) {\r\nspin_unlock_bh(&ts->ts_state_lock);\r\nreturn -1;\r\n}\r\nspin_unlock_bh(&ts->ts_state_lock);\r\nreturn 0;\r\n}\r\nstruct iscsi_conn *iscsi_rx_thread_pre_handler(struct iscsi_thread_set *ts)\r\n{\r\nint ret;\r\nspin_lock_bh(&ts->ts_state_lock);\r\nif (ts->create_threads) {\r\nspin_unlock_bh(&ts->ts_state_lock);\r\ngoto sleep;\r\n}\r\nflush_signals(current);\r\nif (ts->delay_inactive && (--ts->thread_count == 0)) {\r\nspin_unlock_bh(&ts->ts_state_lock);\r\niscsi_del_ts_from_active_list(ts);\r\nif (!iscsit_global->in_shutdown)\r\niscsi_deallocate_extra_thread_sets();\r\niscsi_add_ts_to_inactive_list(ts);\r\nspin_lock_bh(&ts->ts_state_lock);\r\n}\r\nif ((ts->status == ISCSI_THREAD_SET_RESET) &&\r\n(ts->thread_clear & ISCSI_CLEAR_RX_THREAD))\r\ncomplete(&ts->rx_restart_comp);\r\nts->thread_clear &= ~ISCSI_CLEAR_RX_THREAD;\r\nspin_unlock_bh(&ts->ts_state_lock);\r\nsleep:\r\nret = wait_for_completion_interruptible(&ts->rx_start_comp);\r\nif (ret != 0)\r\nreturn NULL;\r\nif (iscsi_signal_thread_pre_handler(ts) < 0)\r\nreturn NULL;\r\nif (!ts->conn) {\r\npr_err("struct iscsi_thread_set->conn is NULL for"\r\n" thread_id: %d, going back to sleep\n", ts->thread_id);\r\ngoto sleep;\r\n}\r\niscsi_check_to_add_additional_sets();\r\nts->thread_clear |= ISCSI_CLEAR_RX_THREAD;\r\ncomplete(&ts->tx_start_comp);\r\nwait_for_completion(&ts->tx_post_start_comp);\r\nreturn ts->conn;\r\n}\r\nstruct iscsi_conn *iscsi_tx_thread_pre_handler(struct iscsi_thread_set *ts)\r\n{\r\nint ret;\r\nspin_lock_bh(&ts->ts_state_lock);\r\nif (ts->create_threads) {\r\nspin_unlock_bh(&ts->ts_state_lock);\r\ngoto sleep;\r\n}\r\nflush_signals(current);\r\nif (ts->delay_inactive && (--ts->thread_count == 0)) {\r\nspin_unlock_bh(&ts->ts_state_lock);\r\niscsi_del_ts_from_active_list(ts);\r\nif (!iscsit_global->in_shutdown)\r\niscsi_deallocate_extra_thread_sets();\r\niscsi_add_ts_to_inactive_list(ts);\r\nspin_lock_bh(&ts->ts_state_lock);\r\n}\r\nif ((ts->status == ISCSI_THREAD_SET_RESET) &&\r\n(ts->thread_clear & ISCSI_CLEAR_TX_THREAD))\r\ncomplete(&ts->tx_restart_comp);\r\nts->thread_clear &= ~ISCSI_CLEAR_TX_THREAD;\r\nspin_unlock_bh(&ts->ts_state_lock);\r\nsleep:\r\nret = wait_for_completion_interruptible(&ts->tx_start_comp);\r\nif (ret != 0)\r\nreturn NULL;\r\nif (iscsi_signal_thread_pre_handler(ts) < 0)\r\nreturn NULL;\r\nif (!ts->conn) {\r\npr_err("struct iscsi_thread_set->conn is NULL for "\r\n" thread_id: %d, going back to sleep\n",\r\nts->thread_id);\r\ngoto sleep;\r\n}\r\niscsi_check_to_add_additional_sets();\r\nts->thread_clear |= ISCSI_CLEAR_TX_THREAD;\r\ncomplete(&ts->tx_post_start_comp);\r\ncomplete(&ts->rx_post_start_comp);\r\nspin_lock_bh(&ts->ts_state_lock);\r\nts->status = ISCSI_THREAD_SET_ACTIVE;\r\nspin_unlock_bh(&ts->ts_state_lock);\r\nreturn ts->conn;\r\n}\r\nint iscsi_thread_set_init(void)\r\n{\r\nint size;\r\niscsit_global->ts_bitmap_count = ISCSI_TS_BITMAP_BITS;\r\nsize = BITS_TO_LONGS(iscsit_global->ts_bitmap_count) * sizeof(long);\r\niscsit_global->ts_bitmap = kzalloc(size, GFP_KERNEL);\r\nif (!iscsit_global->ts_bitmap) {\r\npr_err("Unable to allocate iscsit_global->ts_bitmap\n");\r\nreturn -ENOMEM;\r\n}\r\nreturn 0;\r\n}\r\nvoid iscsi_thread_set_free(void)\r\n{\r\nkfree(iscsit_global->ts_bitmap);\r\n}

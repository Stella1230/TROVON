void snd_opl4_synth_reset(struct snd_opl4 *opl4)\r\n{\r\nunsigned long flags;\r\nint i;\r\nspin_lock_irqsave(&opl4->reg_lock, flags);\r\nfor (i = 0; i < OPL4_MAX_VOICES; i++)\r\nsnd_opl4_write(opl4, OPL4_REG_MISC + i, OPL4_DAMP_BIT);\r\nspin_unlock_irqrestore(&opl4->reg_lock, flags);\r\nINIT_LIST_HEAD(&opl4->off_voices);\r\nINIT_LIST_HEAD(&opl4->on_voices);\r\nmemset(opl4->voices, 0, sizeof(opl4->voices));\r\nfor (i = 0; i < OPL4_MAX_VOICES; i++) {\r\nopl4->voices[i].number = i;\r\nlist_add_tail(&opl4->voices[i].list, &opl4->off_voices);\r\n}\r\nsnd_midi_channel_set_clear(opl4->chset);\r\n}\r\nvoid snd_opl4_synth_shutdown(struct snd_opl4 *opl4)\r\n{\r\nunsigned long flags;\r\nint i;\r\nspin_lock_irqsave(&opl4->reg_lock, flags);\r\nfor (i = 0; i < OPL4_MAX_VOICES; i++)\r\nsnd_opl4_write(opl4, OPL4_REG_MISC + i,\r\nopl4->voices[i].reg_misc & ~OPL4_KEY_ON_BIT);\r\nspin_unlock_irqrestore(&opl4->reg_lock, flags);\r\n}\r\nstatic void snd_opl4_do_for_note(struct snd_opl4 *opl4, int note, struct snd_midi_channel *chan,\r\nvoid (*func)(struct snd_opl4 *opl4, struct opl4_voice *voice))\r\n{\r\nint i;\r\nunsigned long flags;\r\nstruct opl4_voice *voice;\r\nspin_lock_irqsave(&opl4->reg_lock, flags);\r\nfor (i = 0; i < OPL4_MAX_VOICES; i++) {\r\nvoice = &opl4->voices[i];\r\nif (voice->chan == chan && voice->note == note) {\r\nfunc(opl4, voice);\r\n}\r\n}\r\nspin_unlock_irqrestore(&opl4->reg_lock, flags);\r\n}\r\nstatic void snd_opl4_do_for_channel(struct snd_opl4 *opl4,\r\nstruct snd_midi_channel *chan,\r\nvoid (*func)(struct snd_opl4 *opl4, struct opl4_voice *voice))\r\n{\r\nint i;\r\nunsigned long flags;\r\nstruct opl4_voice *voice;\r\nspin_lock_irqsave(&opl4->reg_lock, flags);\r\nfor (i = 0; i < OPL4_MAX_VOICES; i++) {\r\nvoice = &opl4->voices[i];\r\nif (voice->chan == chan) {\r\nfunc(opl4, voice);\r\n}\r\n}\r\nspin_unlock_irqrestore(&opl4->reg_lock, flags);\r\n}\r\nstatic void snd_opl4_do_for_all(struct snd_opl4 *opl4,\r\nvoid (*func)(struct snd_opl4 *opl4, struct opl4_voice *voice))\r\n{\r\nint i;\r\nunsigned long flags;\r\nstruct opl4_voice *voice;\r\nspin_lock_irqsave(&opl4->reg_lock, flags);\r\nfor (i = 0; i < OPL4_MAX_VOICES; i++) {\r\nvoice = &opl4->voices[i];\r\nif (voice->chan)\r\nfunc(opl4, voice);\r\n}\r\nspin_unlock_irqrestore(&opl4->reg_lock, flags);\r\n}\r\nstatic void snd_opl4_update_volume(struct snd_opl4 *opl4, struct opl4_voice *voice)\r\n{\r\nint att;\r\natt = voice->sound->tone_attenuate;\r\natt += snd_opl4_volume_table[opl4->chset->gs_master_volume & 0x7f];\r\natt += snd_opl4_volume_table[voice->chan->gm_volume & 0x7f];\r\natt += snd_opl4_volume_table[voice->chan->gm_expression & 0x7f];\r\natt += snd_opl4_volume_table[voice->velocity];\r\natt = 0x7f - (0x7f - att) * (voice->sound->volume_factor) / 0xfe - volume_boost;\r\nif (att < 0)\r\natt = 0;\r\nelse if (att > 0x7e)\r\natt = 0x7e;\r\nsnd_opl4_write(opl4, OPL4_REG_LEVEL + voice->number,\r\n(att << 1) | voice->level_direct);\r\nvoice->level_direct = 0;\r\n}\r\nstatic void snd_opl4_update_pan(struct snd_opl4 *opl4, struct opl4_voice *voice)\r\n{\r\nint pan = voice->sound->panpot;\r\nif (!voice->chan->drum_channel)\r\npan += (voice->chan->control[MIDI_CTL_MSB_PAN] - 0x40) >> 3;\r\nif (pan < -7)\r\npan = -7;\r\nelse if (pan > 7)\r\npan = 7;\r\nvoice->reg_misc = (voice->reg_misc & ~OPL4_PAN_POT_MASK)\r\n| (pan & OPL4_PAN_POT_MASK);\r\nsnd_opl4_write(opl4, OPL4_REG_MISC + voice->number, voice->reg_misc);\r\n}\r\nstatic void snd_opl4_update_vibrato_depth(struct snd_opl4 *opl4,\r\nstruct opl4_voice *voice)\r\n{\r\nint depth;\r\nif (voice->chan->drum_channel)\r\nreturn;\r\ndepth = (7 - voice->sound->vibrato)\r\n* (voice->chan->control[MIDI_CTL_VIBRATO_DEPTH] & 0x7f);\r\ndepth = (depth >> 7) + voice->sound->vibrato;\r\nvoice->reg_lfo_vibrato &= ~OPL4_VIBRATO_DEPTH_MASK;\r\nvoice->reg_lfo_vibrato |= depth & OPL4_VIBRATO_DEPTH_MASK;\r\nsnd_opl4_write(opl4, OPL4_REG_LFO_VIBRATO + voice->number,\r\nvoice->reg_lfo_vibrato);\r\n}\r\nstatic void snd_opl4_update_pitch(struct snd_opl4 *opl4,\r\nstruct opl4_voice *voice)\r\n{\r\nstruct snd_midi_channel *chan = voice->chan;\r\nint note, pitch, octave;\r\nnote = chan->drum_channel ? 60 : voice->note;\r\npitch = ((note - 60) << 7) * voice->sound->key_scaling / 100 + (60 << 7);\r\npitch += voice->sound->pitch_offset;\r\nif (!chan->drum_channel)\r\npitch += chan->gm_rpn_coarse_tuning;\r\npitch += chan->gm_rpn_fine_tuning >> 7;\r\npitch += chan->midi_pitchbend * chan->gm_rpn_pitch_bend_range / 0x2000;\r\nif (pitch < 0)\r\npitch = 0;\r\nelse if (pitch >= 0x6000)\r\npitch = 0x5fff;\r\noctave = pitch / 0x600 - 8;\r\npitch = snd_opl4_pitch_map[pitch % 0x600];\r\nsnd_opl4_write(opl4, OPL4_REG_OCTAVE + voice->number,\r\n(octave << 4) | ((pitch >> 7) & OPL4_F_NUMBER_HIGH_MASK));\r\nvoice->reg_f_number = (voice->reg_f_number & OPL4_TONE_NUMBER_BIT8)\r\n| ((pitch << 1) & OPL4_F_NUMBER_LOW_MASK);\r\nsnd_opl4_write(opl4, OPL4_REG_F_NUMBER + voice->number, voice->reg_f_number);\r\n}\r\nstatic void snd_opl4_update_tone_parameters(struct snd_opl4 *opl4,\r\nstruct opl4_voice *voice)\r\n{\r\nsnd_opl4_write(opl4, OPL4_REG_ATTACK_DECAY1 + voice->number,\r\nvoice->sound->reg_attack_decay1);\r\nsnd_opl4_write(opl4, OPL4_REG_LEVEL_DECAY2 + voice->number,\r\nvoice->sound->reg_level_decay2);\r\nsnd_opl4_write(opl4, OPL4_REG_RELEASE_CORRECTION + voice->number,\r\nvoice->sound->reg_release_correction);\r\nsnd_opl4_write(opl4, OPL4_REG_TREMOLO + voice->number,\r\nvoice->sound->reg_tremolo);\r\n}\r\nstatic struct opl4_voice *snd_opl4_get_voice(struct snd_opl4 *opl4)\r\n{\r\nif (!list_empty(&opl4->off_voices))\r\nreturn list_entry(opl4->off_voices.next, struct opl4_voice, list);\r\nsnd_BUG_ON(list_empty(&opl4->on_voices));\r\nreturn list_entry(opl4->on_voices.next, struct opl4_voice, list);\r\n}\r\nstatic void snd_opl4_wait_for_wave_headers(struct snd_opl4 *opl4)\r\n{\r\nint timeout = 200;\r\nwhile ((inb(opl4->fm_port) & OPL4_STATUS_LOAD) && --timeout > 0)\r\nudelay(10);\r\n}\r\nvoid snd_opl4_note_on(void *private_data, int note, int vel, struct snd_midi_channel *chan)\r\n{\r\nstruct snd_opl4 *opl4 = private_data;\r\nconst struct opl4_region_ptr *regions;\r\nstruct opl4_voice *voice[2];\r\nconst struct opl4_sound *sound[2];\r\nint voices = 0, i;\r\nunsigned long flags;\r\ni = chan->drum_channel ? 0x80 : (chan->midi_program & 0x7f);\r\nregions = &snd_yrw801_regions[i];\r\nfor (i = 0; i < regions->count; i++) {\r\nif (note >= regions->regions[i].key_min &&\r\nnote <= regions->regions[i].key_max) {\r\nsound[voices] = &regions->regions[i].sound;\r\nif (++voices >= 2)\r\nbreak;\r\n}\r\n}\r\nspin_lock_irqsave(&opl4->reg_lock, flags);\r\nfor (i = 0; i < voices; i++) {\r\nvoice[i] = snd_opl4_get_voice(opl4);\r\nlist_del(&voice[i]->list);\r\nlist_add_tail(&voice[i]->list, &opl4->on_voices);\r\nvoice[i]->chan = chan;\r\nvoice[i]->note = note;\r\nvoice[i]->velocity = vel & 0x7f;\r\nvoice[i]->sound = sound[i];\r\n}\r\nfor (i = 0; i < voices; i++) {\r\nvoice[i]->reg_f_number =\r\n(sound[i]->tone >> 8) & OPL4_TONE_NUMBER_BIT8;\r\nsnd_opl4_write(opl4, OPL4_REG_F_NUMBER + voice[i]->number,\r\nvoice[i]->reg_f_number);\r\nsnd_opl4_write(opl4, OPL4_REG_TONE_NUMBER + voice[i]->number,\r\nsound[i]->tone & 0xff);\r\n}\r\nfor (i = 0; i < voices; i++) {\r\nvoice[i]->reg_misc = OPL4_LFO_RESET_BIT;\r\nsnd_opl4_update_pan(opl4, voice[i]);\r\nsnd_opl4_update_pitch(opl4, voice[i]);\r\nvoice[i]->level_direct = OPL4_LEVEL_DIRECT_BIT;\r\nsnd_opl4_update_volume(opl4, voice[i]);\r\n}\r\nspin_unlock_irqrestore(&opl4->reg_lock, flags);\r\nsnd_opl4_wait_for_wave_headers(opl4);\r\nspin_lock_irqsave(&opl4->reg_lock, flags);\r\nfor (i = 0; i < voices; i++) {\r\nsnd_opl4_update_tone_parameters(opl4, voice[i]);\r\nvoice[i]->reg_lfo_vibrato = voice[i]->sound->reg_lfo_vibrato;\r\nsnd_opl4_update_vibrato_depth(opl4, voice[i]);\r\n}\r\nfor (i = 0; i < voices; i++) {\r\nvoice[i]->reg_misc =\r\n(voice[i]->reg_misc & 0x1f) | OPL4_KEY_ON_BIT;\r\nsnd_opl4_write(opl4, OPL4_REG_MISC + voice[i]->number,\r\nvoice[i]->reg_misc);\r\n}\r\nspin_unlock_irqrestore(&opl4->reg_lock, flags);\r\n}\r\nstatic void snd_opl4_voice_off(struct snd_opl4 *opl4, struct opl4_voice *voice)\r\n{\r\nlist_del(&voice->list);\r\nlist_add_tail(&voice->list, &opl4->off_voices);\r\nvoice->reg_misc &= ~OPL4_KEY_ON_BIT;\r\nsnd_opl4_write(opl4, OPL4_REG_MISC + voice->number, voice->reg_misc);\r\n}\r\nvoid snd_opl4_note_off(void *private_data, int note, int vel, struct snd_midi_channel *chan)\r\n{\r\nstruct snd_opl4 *opl4 = private_data;\r\nsnd_opl4_do_for_note(opl4, note, chan, snd_opl4_voice_off);\r\n}\r\nstatic void snd_opl4_terminate_voice(struct snd_opl4 *opl4, struct opl4_voice *voice)\r\n{\r\nlist_del(&voice->list);\r\nlist_add_tail(&voice->list, &opl4->off_voices);\r\nvoice->reg_misc = (voice->reg_misc & ~OPL4_KEY_ON_BIT) | OPL4_DAMP_BIT;\r\nsnd_opl4_write(opl4, OPL4_REG_MISC + voice->number, voice->reg_misc);\r\n}\r\nvoid snd_opl4_terminate_note(void *private_data, int note, struct snd_midi_channel *chan)\r\n{\r\nstruct snd_opl4 *opl4 = private_data;\r\nsnd_opl4_do_for_note(opl4, note, chan, snd_opl4_terminate_voice);\r\n}\r\nvoid snd_opl4_control(void *private_data, int type, struct snd_midi_channel *chan)\r\n{\r\nstruct snd_opl4 *opl4 = private_data;\r\nswitch (type) {\r\ncase MIDI_CTL_MSB_MODWHEEL:\r\nchan->control[MIDI_CTL_VIBRATO_DEPTH] = chan->control[MIDI_CTL_MSB_MODWHEEL];\r\nsnd_opl4_do_for_channel(opl4, chan, snd_opl4_update_vibrato_depth);\r\nbreak;\r\ncase MIDI_CTL_MSB_MAIN_VOLUME:\r\nsnd_opl4_do_for_channel(opl4, chan, snd_opl4_update_volume);\r\nbreak;\r\ncase MIDI_CTL_MSB_PAN:\r\nsnd_opl4_do_for_channel(opl4, chan, snd_opl4_update_pan);\r\nbreak;\r\ncase MIDI_CTL_MSB_EXPRESSION:\r\nsnd_opl4_do_for_channel(opl4, chan, snd_opl4_update_volume);\r\nbreak;\r\ncase MIDI_CTL_VIBRATO_RATE:\r\nbreak;\r\ncase MIDI_CTL_VIBRATO_DEPTH:\r\nsnd_opl4_do_for_channel(opl4, chan, snd_opl4_update_vibrato_depth);\r\nbreak;\r\ncase MIDI_CTL_VIBRATO_DELAY:\r\nbreak;\r\ncase MIDI_CTL_E1_REVERB_DEPTH:\r\nbreak;\r\ncase MIDI_CTL_PITCHBEND:\r\nsnd_opl4_do_for_channel(opl4, chan, snd_opl4_update_pitch);\r\nbreak;\r\n}\r\n}\r\nvoid snd_opl4_sysex(void *private_data, unsigned char *buf, int len,\r\nint parsed, struct snd_midi_channel_set *chset)\r\n{\r\nstruct snd_opl4 *opl4 = private_data;\r\nif (parsed == SNDRV_MIDI_SYSEX_GS_MASTER_VOLUME)\r\nsnd_opl4_do_for_all(opl4, snd_opl4_update_volume);\r\n}

static int jornada_lcd_get_power(struct lcd_device *dev)\r\n{\r\nif (PPSR & PPC_LDD2)\r\nreturn FB_BLANK_UNBLANK;\r\nelse\r\nreturn FB_BLANK_POWERDOWN;\r\n}\r\nstatic int jornada_lcd_get_contrast(struct lcd_device *dev)\r\n{\r\nint ret;\r\nif (jornada_lcd_get_power(dev) != FB_BLANK_UNBLANK)\r\nreturn 0;\r\njornada_ssp_start();\r\nif (jornada_ssp_byte(GETCONTRAST) != TXDUMMY) {\r\npr_err("get contrast failed\n");\r\njornada_ssp_end();\r\nreturn -ETIMEDOUT;\r\n} else {\r\nret = jornada_ssp_byte(TXDUMMY);\r\njornada_ssp_end();\r\nreturn ret;\r\n}\r\n}\r\nstatic int jornada_lcd_set_contrast(struct lcd_device *dev, int value)\r\n{\r\nint ret;\r\njornada_ssp_start();\r\nret = jornada_ssp_byte(SETCONTRAST);\r\nif (jornada_ssp_byte(value) != TXDUMMY) {\r\npr_err("set contrast failed\n");\r\njornada_ssp_end();\r\nreturn -ETIMEDOUT;\r\n}\r\njornada_ssp_end();\r\nreturn 0;\r\n}\r\nstatic int jornada_lcd_set_power(struct lcd_device *dev, int power)\r\n{\r\nif (power != FB_BLANK_UNBLANK) {\r\nPPSR &= ~PPC_LDD2;\r\nPPDR |= PPC_LDD2;\r\n} else\r\nPPSR |= PPC_LDD2;\r\nreturn 0;\r\n}\r\nstatic int jornada_lcd_probe(struct platform_device *pdev)\r\n{\r\nstruct lcd_device *lcd_device;\r\nint ret;\r\nlcd_device = lcd_device_register(S1D_DEVICENAME, &pdev->dev, NULL, &jornada_lcd_props);\r\nif (IS_ERR(lcd_device)) {\r\nret = PTR_ERR(lcd_device);\r\npr_err("failed to register device\n");\r\nreturn ret;\r\n}\r\nplatform_set_drvdata(pdev, lcd_device);\r\njornada_lcd_set_contrast(lcd_device, LCD_DEF_CONTRAST);\r\njornada_lcd_set_power(lcd_device, FB_BLANK_UNBLANK);\r\nmsleep(100);\r\nreturn 0;\r\n}\r\nstatic int jornada_lcd_remove(struct platform_device *pdev)\r\n{\r\nstruct lcd_device *lcd_device = platform_get_drvdata(pdev);\r\nlcd_device_unregister(lcd_device);\r\nreturn 0;\r\n}

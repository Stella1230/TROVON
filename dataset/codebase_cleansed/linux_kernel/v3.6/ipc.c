static void audit_cb(struct audit_buffer *ab, void *va)\r\n{\r\nstruct common_audit_data *sa = va;\r\naudit_log_format(ab, " target=");\r\naudit_log_untrustedstring(ab, sa->aad->target);\r\n}\r\nstatic int aa_audit_ptrace(struct aa_profile *profile,\r\nstruct aa_profile *target, int error)\r\n{\r\nstruct common_audit_data sa;\r\nstruct apparmor_audit_data aad = {0,};\r\nsa.type = LSM_AUDIT_DATA_NONE;\r\nsa.aad = &aad;\r\naad.op = OP_PTRACE;\r\naad.target = target;\r\naad.error = error;\r\nreturn aa_audit(AUDIT_APPARMOR_AUTO, profile, GFP_ATOMIC, &sa,\r\naudit_cb);\r\n}\r\nint aa_may_ptrace(struct task_struct *tracer_task, struct aa_profile *tracer,\r\nstruct aa_profile *tracee, unsigned int mode)\r\n{\r\nif (unconfined(tracer) || tracer == tracee)\r\nreturn 0;\r\nreturn aa_capable(tracer_task, tracer, CAP_SYS_PTRACE, 1);\r\n}\r\nint aa_ptrace(struct task_struct *tracer, struct task_struct *tracee,\r\nunsigned int mode)\r\n{\r\nstruct aa_profile *tracer_p;\r\nconst struct cred *cred = get_task_cred(tracer);\r\nint error = 0;\r\ntracer_p = aa_cred_profile(cred);\r\nif (!unconfined(tracer_p)) {\r\nconst struct cred *lcred = get_task_cred(tracee);\r\nstruct aa_profile *tracee_p = aa_cred_profile(lcred);\r\nerror = aa_may_ptrace(tracer, tracer_p, tracee_p, mode);\r\nerror = aa_audit_ptrace(tracer_p, tracee_p, error);\r\nput_cred(lcred);\r\n}\r\nput_cred(cred);\r\nreturn error;\r\n}

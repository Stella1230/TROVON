u64 ipath_snap_cntr(struct ipath_devdata *dd, ipath_creg creg)\r\n{\r\nu32 val, reg64 = 0;\r\nu64 val64;\r\nunsigned long t0, t1;\r\nu64 ret;\r\nt0 = jiffies;\r\nif (!(dd->ipath_flags & IPATH_32BITCOUNTERS) &&\r\n(creg == dd->ipath_cregs->cr_wordsendcnt ||\r\ncreg == dd->ipath_cregs->cr_wordrcvcnt ||\r\ncreg == dd->ipath_cregs->cr_pktsendcnt ||\r\ncreg == dd->ipath_cregs->cr_pktrcvcnt)) {\r\nval64 = ipath_read_creg(dd, creg);\r\nval = val64 == ~0ULL ? ~0U : 0;\r\nreg64 = 1;\r\n} else\r\nval64 = val = ipath_read_creg32(dd, creg);\r\nt1 = jiffies;\r\nif (time_before(t0 + HZ, t1) && val == -1) {\r\nipath_dev_err(dd, "Error! Read counter 0x%x timed out\n",\r\ncreg);\r\nret = 0ULL;\r\ngoto bail;\r\n}\r\nif (reg64) {\r\nret = val64;\r\ngoto bail;\r\n}\r\nif (creg == dd->ipath_cregs->cr_wordsendcnt) {\r\nif (val != dd->ipath_lastsword) {\r\ndd->ipath_sword += val - dd->ipath_lastsword;\r\ndd->ipath_lastsword = val;\r\n}\r\nval64 = dd->ipath_sword;\r\n} else if (creg == dd->ipath_cregs->cr_wordrcvcnt) {\r\nif (val != dd->ipath_lastrword) {\r\ndd->ipath_rword += val - dd->ipath_lastrword;\r\ndd->ipath_lastrword = val;\r\n}\r\nval64 = dd->ipath_rword;\r\n} else if (creg == dd->ipath_cregs->cr_pktsendcnt) {\r\nif (val != dd->ipath_lastspkts) {\r\ndd->ipath_spkts += val - dd->ipath_lastspkts;\r\ndd->ipath_lastspkts = val;\r\n}\r\nval64 = dd->ipath_spkts;\r\n} else if (creg == dd->ipath_cregs->cr_pktrcvcnt) {\r\nif (val != dd->ipath_lastrpkts) {\r\ndd->ipath_rpkts += val - dd->ipath_lastrpkts;\r\ndd->ipath_lastrpkts = val;\r\n}\r\nval64 = dd->ipath_rpkts;\r\n} else if (creg == dd->ipath_cregs->cr_ibsymbolerrcnt) {\r\nif (dd->ibdeltainprog)\r\nval64 -= val64 - dd->ibsymsnap;\r\nval64 -= dd->ibsymdelta;\r\n} else if (creg == dd->ipath_cregs->cr_iblinkerrrecovcnt) {\r\nif (dd->ibdeltainprog)\r\nval64 -= val64 - dd->iblnkerrsnap;\r\nval64 -= dd->iblnkerrdelta;\r\n} else\r\nval64 = (u64) val;\r\nret = val64;\r\nbail:\r\nreturn ret;\r\n}\r\nstatic void ipath_qcheck(struct ipath_devdata *dd)\r\n{\r\nstatic u64 last_tot_hdrqfull;\r\nstruct ipath_portdata *pd = dd->ipath_pd[0];\r\nsize_t blen = 0;\r\nchar buf[128];\r\nu32 hdrqtail;\r\n*buf = 0;\r\nif (pd->port_hdrqfull != dd->ipath_p0_hdrqfull) {\r\nblen = snprintf(buf, sizeof buf, "port 0 hdrqfull %u",\r\npd->port_hdrqfull -\r\ndd->ipath_p0_hdrqfull);\r\ndd->ipath_p0_hdrqfull = pd->port_hdrqfull;\r\n}\r\nif (ipath_stats.sps_etidfull != dd->ipath_last_tidfull) {\r\nblen += snprintf(buf + blen, sizeof buf - blen,\r\n"%srcvegrfull %llu",\r\nblen ? ", " : "",\r\n(unsigned long long)\r\n(ipath_stats.sps_etidfull -\r\ndd->ipath_last_tidfull));\r\ndd->ipath_last_tidfull = ipath_stats.sps_etidfull;\r\n}\r\nif ((ipath_debug & (__IPATH_PKTDBG | __IPATH_DBG)) &&\r\nipath_stats.sps_hdrqfull != last_tot_hdrqfull) {\r\nblen += snprintf(buf + blen, sizeof buf - blen,\r\n"%shdrqfull %llu (all ports)",\r\nblen ? ", " : "",\r\n(unsigned long long)\r\n(ipath_stats.sps_hdrqfull -\r\nlast_tot_hdrqfull));\r\nlast_tot_hdrqfull = ipath_stats.sps_hdrqfull;\r\n}\r\nif (blen)\r\nipath_dbg("%s\n", buf);\r\nhdrqtail = ipath_get_hdrqtail(pd);\r\nif (pd->port_head != hdrqtail) {\r\nif (dd->ipath_lastport0rcv_cnt ==\r\nipath_stats.sps_port0pkts) {\r\nipath_cdbg(PKT, "missing rcv interrupts? "\r\n"port0 hd=%x tl=%x; port0pkts %llx; write"\r\n" hd (w/intr)\n",\r\npd->port_head, hdrqtail,\r\n(unsigned long long)\r\nipath_stats.sps_port0pkts);\r\nipath_write_ureg(dd, ur_rcvhdrhead, hdrqtail |\r\ndd->ipath_rhdrhead_intr_off, pd->port_port);\r\n}\r\ndd->ipath_lastport0rcv_cnt = ipath_stats.sps_port0pkts;\r\n}\r\n}\r\nstatic void ipath_chk_errormask(struct ipath_devdata *dd)\r\n{\r\nstatic u32 fixed;\r\nu32 ctrl;\r\nunsigned long errormask;\r\nunsigned long hwerrs;\r\nif (!dd->ipath_errormask || !(dd->ipath_flags & IPATH_INITTED))\r\nreturn;\r\nerrormask = ipath_read_kreg64(dd, dd->ipath_kregs->kr_errormask);\r\nif (errormask == dd->ipath_errormask)\r\nreturn;\r\nfixed++;\r\nhwerrs = ipath_read_kreg64(dd, dd->ipath_kregs->kr_hwerrstatus);\r\nctrl = ipath_read_kreg32(dd, dd->ipath_kregs->kr_control);\r\nipath_write_kreg(dd, dd->ipath_kregs->kr_errormask,\r\ndd->ipath_errormask);\r\nif ((hwerrs & dd->ipath_hwerrmask) ||\r\n(ctrl & INFINIPATH_C_FREEZEMODE)) {\r\nipath_write_kreg(dd, dd->ipath_kregs->kr_hwerrclear, 0ULL);\r\nipath_write_kreg(dd, dd->ipath_kregs->kr_errorclear, 0ULL);\r\nipath_write_kreg(dd, dd->ipath_kregs->kr_intclear, 0ULL);\r\ndev_info(&dd->pcidev->dev,\r\n"errormask fixed(%u) %lx -> %lx, ctrl %x hwerr %lx\n",\r\nfixed, errormask, (unsigned long)dd->ipath_errormask,\r\nctrl, hwerrs);\r\n} else\r\nipath_dbg("errormask fixed(%u) %lx -> %lx, no freeze\n",\r\nfixed, errormask,\r\n(unsigned long)dd->ipath_errormask);\r\n}\r\nvoid ipath_get_faststats(unsigned long opaque)\r\n{\r\nstruct ipath_devdata *dd = (struct ipath_devdata *) opaque;\r\nint i;\r\nstatic unsigned cnt;\r\nunsigned long flags;\r\nu64 traffic_wds;\r\nif (!dd->ipath_kregbase || !(dd->ipath_flags & IPATH_INITTED) ||\r\nipath_diag_inuse)\r\ngoto done;\r\ntraffic_wds = ipath_snap_cntr(dd, dd->ipath_cregs->cr_wordsendcnt) +\r\nipath_snap_cntr(dd, dd->ipath_cregs->cr_wordrcvcnt);\r\nspin_lock_irqsave(&dd->ipath_eep_st_lock, flags);\r\ntraffic_wds -= dd->ipath_traffic_wds;\r\ndd->ipath_traffic_wds += traffic_wds;\r\nif (traffic_wds >= IPATH_TRAFFIC_ACTIVE_THRESHOLD)\r\natomic_add(5, &dd->ipath_active_time);\r\nspin_unlock_irqrestore(&dd->ipath_eep_st_lock, flags);\r\nif (dd->ipath_flags & IPATH_32BITCOUNTERS) {\r\nipath_snap_cntr(dd, dd->ipath_cregs->cr_pktsendcnt);\r\nipath_snap_cntr(dd, dd->ipath_cregs->cr_pktrcvcnt);\r\n}\r\nipath_qcheck(dd);\r\nif (dd->ipath_lasterror)\r\ndd->ipath_lasterror = 0;\r\nif (dd->ipath_lasthwerror)\r\ndd->ipath_lasthwerror = 0;\r\nif (dd->ipath_maskederrs\r\n&& time_after(jiffies, dd->ipath_unmasktime)) {\r\nchar ebuf[256];\r\nint iserr;\r\niserr = ipath_decode_err(dd, ebuf, sizeof ebuf,\r\ndd->ipath_maskederrs);\r\nif (dd->ipath_maskederrs &\r\n~(INFINIPATH_E_RRCVEGRFULL | INFINIPATH_E_RRCVHDRFULL |\r\nINFINIPATH_E_PKTERRS))\r\nipath_dev_err(dd, "Re-enabling masked errors "\r\n"(%s)\n", ebuf);\r\nelse {\r\nif (iserr)\r\nipath_dbg(\r\n"Re-enabling queue full errors (%s)\n",\r\nebuf);\r\nelse\r\nipath_cdbg(ERRPKT, "Re-enabling packet"\r\n" problem interrupt (%s)\n", ebuf);\r\n}\r\ndd->ipath_errormask |= dd->ipath_maskederrs;\r\nipath_write_kreg(dd, dd->ipath_kregs->kr_errormask,\r\ndd->ipath_errormask);\r\ndd->ipath_maskederrs = 0;\r\n}\r\nif ((++cnt & 0x10)) {\r\nfor (i = (int) dd->ipath_cfgports; --i >= 0; ) {\r\nstruct ipath_portdata *pd = dd->ipath_pd[i];\r\nif (pd && pd->port_lastrcvhdrqtail != -1)\r\npd->port_lastrcvhdrqtail = -1;\r\n}\r\n}\r\nipath_chk_errormask(dd);\r\ndone:\r\nmod_timer(&dd->ipath_stats_timer, jiffies + HZ * 5);\r\n}

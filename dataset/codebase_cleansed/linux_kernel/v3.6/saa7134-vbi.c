static void task_init(struct saa7134_dev *dev, struct saa7134_buf *buf,\r\nint task)\r\n{\r\nstruct saa7134_tvnorm *norm = dev->tvnorm;\r\nsaa_writeb(SAA7134_VBI_H_START1(task), norm->h_start & 0xff);\r\nsaa_writeb(SAA7134_VBI_H_START2(task), norm->h_start >> 8);\r\nsaa_writeb(SAA7134_VBI_H_STOP1(task), norm->h_stop & 0xff);\r\nsaa_writeb(SAA7134_VBI_H_STOP2(task), norm->h_stop >> 8);\r\nsaa_writeb(SAA7134_VBI_V_START1(task), norm->vbi_v_start_0 & 0xff);\r\nsaa_writeb(SAA7134_VBI_V_START2(task), norm->vbi_v_start_0 >> 8);\r\nsaa_writeb(SAA7134_VBI_V_STOP1(task), norm->vbi_v_stop_0 & 0xff);\r\nsaa_writeb(SAA7134_VBI_V_STOP2(task), norm->vbi_v_stop_0 >> 8);\r\nsaa_writeb(SAA7134_VBI_H_SCALE_INC1(task), VBI_SCALE & 0xff);\r\nsaa_writeb(SAA7134_VBI_H_SCALE_INC2(task), VBI_SCALE >> 8);\r\nsaa_writeb(SAA7134_VBI_PHASE_OFFSET_LUMA(task), 0x00);\r\nsaa_writeb(SAA7134_VBI_PHASE_OFFSET_CHROMA(task), 0x00);\r\nsaa_writeb(SAA7134_VBI_H_LEN1(task), buf->vb.width & 0xff);\r\nsaa_writeb(SAA7134_VBI_H_LEN2(task), buf->vb.width >> 8);\r\nsaa_writeb(SAA7134_VBI_V_LEN1(task), buf->vb.height & 0xff);\r\nsaa_writeb(SAA7134_VBI_V_LEN2(task), buf->vb.height >> 8);\r\nsaa_andorb(SAA7134_DATA_PATH(task), 0xc0, 0x00);\r\n}\r\nstatic int buffer_activate(struct saa7134_dev *dev,\r\nstruct saa7134_buf *buf,\r\nstruct saa7134_buf *next)\r\n{\r\nunsigned long control,base;\r\ndprintk("buffer_activate [%p]\n",buf);\r\nbuf->vb.state = VIDEOBUF_ACTIVE;\r\nbuf->top_seen = 0;\r\ntask_init(dev,buf,TASK_A);\r\ntask_init(dev,buf,TASK_B);\r\nsaa_writeb(SAA7134_OFMT_DATA_A, 0x06);\r\nsaa_writeb(SAA7134_OFMT_DATA_B, 0x06);\r\nbase = saa7134_buffer_base(buf);\r\ncontrol = SAA7134_RS_CONTROL_BURST_16 |\r\nSAA7134_RS_CONTROL_ME |\r\n(buf->pt->dma >> 12);\r\nsaa_writel(SAA7134_RS_BA1(2),base);\r\nsaa_writel(SAA7134_RS_BA2(2),base + buf->vb.size/2);\r\nsaa_writel(SAA7134_RS_PITCH(2),buf->vb.width);\r\nsaa_writel(SAA7134_RS_CONTROL(2),control);\r\nsaa_writel(SAA7134_RS_BA1(3),base);\r\nsaa_writel(SAA7134_RS_BA2(3),base + buf->vb.size/2);\r\nsaa_writel(SAA7134_RS_PITCH(3),buf->vb.width);\r\nsaa_writel(SAA7134_RS_CONTROL(3),control);\r\nsaa7134_set_dmabits(dev);\r\nmod_timer(&dev->vbi_q.timeout, jiffies+BUFFER_TIMEOUT);\r\nreturn 0;\r\n}\r\nstatic int buffer_prepare(struct videobuf_queue *q,\r\nstruct videobuf_buffer *vb,\r\nenum v4l2_field field)\r\n{\r\nstruct saa7134_fh *fh = q->priv_data;\r\nstruct saa7134_dev *dev = fh->dev;\r\nstruct saa7134_buf *buf = container_of(vb,struct saa7134_buf,vb);\r\nstruct saa7134_tvnorm *norm = dev->tvnorm;\r\nunsigned int lines, llength, size;\r\nint err;\r\nlines = norm->vbi_v_stop_0 - norm->vbi_v_start_0 +1;\r\nif (lines > VBI_LINE_COUNT)\r\nlines = VBI_LINE_COUNT;\r\nllength = VBI_LINE_LENGTH;\r\nsize = lines * llength * 2;\r\nif (0 != buf->vb.baddr && buf->vb.bsize < size)\r\nreturn -EINVAL;\r\nif (buf->vb.size != size)\r\nsaa7134_dma_free(q,buf);\r\nif (VIDEOBUF_NEEDS_INIT == buf->vb.state) {\r\nstruct videobuf_dmabuf *dma=videobuf_to_dma(&buf->vb);\r\nbuf->vb.width = llength;\r\nbuf->vb.height = lines;\r\nbuf->vb.size = size;\r\nbuf->pt = &fh->pt_vbi;\r\nerr = videobuf_iolock(q,&buf->vb,NULL);\r\nif (err)\r\ngoto oops;\r\nerr = saa7134_pgtable_build(dev->pci,buf->pt,\r\ndma->sglist,\r\ndma->sglen,\r\nsaa7134_buffer_startpage(buf));\r\nif (err)\r\ngoto oops;\r\n}\r\nbuf->vb.state = VIDEOBUF_PREPARED;\r\nbuf->activate = buffer_activate;\r\nbuf->vb.field = field;\r\nreturn 0;\r\noops:\r\nsaa7134_dma_free(q,buf);\r\nreturn err;\r\n}\r\nstatic int\r\nbuffer_setup(struct videobuf_queue *q, unsigned int *count, unsigned int *size)\r\n{\r\nstruct saa7134_fh *fh = q->priv_data;\r\nstruct saa7134_dev *dev = fh->dev;\r\nint llength,lines;\r\nlines = dev->tvnorm->vbi_v_stop_0 - dev->tvnorm->vbi_v_start_0 +1;\r\nllength = VBI_LINE_LENGTH;\r\n*size = lines * llength * 2;\r\nif (0 == *count)\r\n*count = vbibufs;\r\n*count = saa7134_buffer_count(*size,*count);\r\nreturn 0;\r\n}\r\nstatic void buffer_queue(struct videobuf_queue *q, struct videobuf_buffer *vb)\r\n{\r\nstruct saa7134_fh *fh = q->priv_data;\r\nstruct saa7134_dev *dev = fh->dev;\r\nstruct saa7134_buf *buf = container_of(vb,struct saa7134_buf,vb);\r\nsaa7134_buffer_queue(dev,&dev->vbi_q,buf);\r\n}\r\nstatic void buffer_release(struct videobuf_queue *q, struct videobuf_buffer *vb)\r\n{\r\nstruct saa7134_buf *buf = container_of(vb,struct saa7134_buf,vb);\r\nsaa7134_dma_free(q,buf);\r\n}\r\nint saa7134_vbi_init1(struct saa7134_dev *dev)\r\n{\r\nINIT_LIST_HEAD(&dev->vbi_q.queue);\r\ninit_timer(&dev->vbi_q.timeout);\r\ndev->vbi_q.timeout.function = saa7134_buffer_timeout;\r\ndev->vbi_q.timeout.data = (unsigned long)(&dev->vbi_q);\r\ndev->vbi_q.dev = dev;\r\nif (vbibufs < 2)\r\nvbibufs = 2;\r\nif (vbibufs > VIDEO_MAX_FRAME)\r\nvbibufs = VIDEO_MAX_FRAME;\r\nreturn 0;\r\n}\r\nint saa7134_vbi_fini(struct saa7134_dev *dev)\r\n{\r\nreturn 0;\r\n}\r\nvoid saa7134_irq_vbi_done(struct saa7134_dev *dev, unsigned long status)\r\n{\r\nspin_lock(&dev->slock);\r\nif (dev->vbi_q.curr) {\r\ndev->vbi_fieldcount++;\r\nif ((status & 0x10) == 0x00) {\r\ndev->vbi_q.curr->top_seen = 1;\r\ngoto done;\r\n}\r\nif (!dev->vbi_q.curr->top_seen)\r\ngoto done;\r\ndev->vbi_q.curr->vb.field_count = dev->vbi_fieldcount;\r\nsaa7134_buffer_finish(dev,&dev->vbi_q,VIDEOBUF_DONE);\r\n}\r\nsaa7134_buffer_next(dev,&dev->vbi_q);\r\ndone:\r\nspin_unlock(&dev->slock);\r\n}

int machine_kexec_prepare(struct kimage *image)\r\n{\r\nvoid *control_code_buffer;\r\nconst unsigned long *func;\r\nfunc = (unsigned long *)&relocate_new_kernel;\r\ncontrol_code_buffer = page_address(image->control_code_page);\r\nmemcpy((void *)control_code_buffer, (const void *)func[0],\r\nrelocate_new_kernel_size);\r\nflush_icache_range((unsigned long)control_code_buffer,\r\n(unsigned long)control_code_buffer + relocate_new_kernel_size);\r\nia64_kimage = image;\r\nreturn 0;\r\n}\r\nvoid machine_kexec_cleanup(struct kimage *image)\r\n{\r\n}\r\nstatic void ia64_machine_kexec(struct unw_frame_info *info, void *arg)\r\n{\r\nstruct kimage *image = arg;\r\nrelocate_new_kernel_t rnk;\r\nvoid *pal_addr = efi_get_pal_addr();\r\nunsigned long code_addr = (unsigned long)page_address(image->control_code_page);\r\nint ii;\r\nu64 fp, gp;\r\nia64_fptr_t *init_handler = (ia64_fptr_t *)ia64_os_init_on_kdump;\r\nBUG_ON(!image);\r\nif (image->type == KEXEC_TYPE_CRASH) {\r\ncrash_save_this_cpu();\r\ncurrent->thread.ksp = (__u64)info->sw - 16;\r\nfp = ia64_tpa(init_handler->fp);\r\ngp = ia64_tpa(ia64_getreg(_IA64_REG_GP));\r\nia64_sal_set_vectors(SAL_VECTOR_OS_INIT, fp, gp, 0, fp, gp, 0);\r\n} else {\r\nia64_sal_set_vectors(SAL_VECTOR_OS_INIT, 0, 0, 0, 0, 0, 0);\r\n}\r\nia64_sal_set_vectors(SAL_VECTOR_OS_MCA, 0, 0, 0, 0, 0, 0);\r\nlocal_irq_disable();\r\nia64_setreg(_IA64_REG_CR_PMV, 1 << 16);\r\nia64_setreg(_IA64_REG_CR_CMCV, 1 << 16);\r\nia64_set_itv(1 << 16);\r\nia64_set_lrr0(1 << 16);\r\nia64_set_lrr1(1 << 16);\r\nfor (ii = 0; ii < 16; ii++)\r\nia64_eoi();\r\nia64_setreg(_IA64_REG_CR_TPR, 0);\r\nia64_srlz_d();\r\nwhile (ia64_get_ivr() != IA64_SPURIOUS_INT_VECTOR)\r\nia64_eoi();\r\nplatform_kernel_launch_event();\r\nrnk = (relocate_new_kernel_t)&code_addr;\r\n(*rnk)(image->head, image->start, ia64_boot_param,\r\nGRANULEROUNDDOWN((unsigned long) pal_addr));\r\nBUG();\r\n}\r\nvoid machine_kexec(struct kimage *image)\r\n{\r\nBUG_ON(!image);\r\nunw_init_running(ia64_machine_kexec, image);\r\nfor(;;);\r\n}\r\nvoid arch_crash_save_vmcoreinfo(void)\r\n{\r\n#if defined(CONFIG_DISCONTIGMEM) || defined(CONFIG_SPARSEMEM)\r\nVMCOREINFO_SYMBOL(pgdat_list);\r\nVMCOREINFO_LENGTH(pgdat_list, MAX_NUMNODES);\r\n#endif\r\n#ifdef CONFIG_NUMA\r\nVMCOREINFO_SYMBOL(node_memblk);\r\nVMCOREINFO_LENGTH(node_memblk, NR_NODE_MEMBLKS);\r\nVMCOREINFO_STRUCT_SIZE(node_memblk_s);\r\nVMCOREINFO_OFFSET(node_memblk_s, start_paddr);\r\nVMCOREINFO_OFFSET(node_memblk_s, size);\r\n#endif\r\n#ifdef CONFIG_PGTABLE_3\r\nVMCOREINFO_CONFIG(PGTABLE_3);\r\n#elif defined(CONFIG_PGTABLE_4)\r\nVMCOREINFO_CONFIG(PGTABLE_4);\r\n#endif\r\n}\r\nunsigned long paddr_vmcoreinfo_note(void)\r\n{\r\nreturn ia64_tpa((unsigned long)(char *)&vmcoreinfo_note);\r\n}

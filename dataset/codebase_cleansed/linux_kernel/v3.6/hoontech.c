static void __devinit snd_ice1712_stdsp24_gpio_write(struct snd_ice1712 *ice, unsigned char byte)\r\n{\r\nbyte |= ICE1712_STDSP24_CLOCK_BIT;\r\nudelay(100);\r\nsnd_ice1712_write(ice, ICE1712_IREG_GPIO_DATA, byte);\r\nbyte &= ~ICE1712_STDSP24_CLOCK_BIT;\r\nudelay(100);\r\nsnd_ice1712_write(ice, ICE1712_IREG_GPIO_DATA, byte);\r\nbyte |= ICE1712_STDSP24_CLOCK_BIT;\r\nudelay(100);\r\nsnd_ice1712_write(ice, ICE1712_IREG_GPIO_DATA, byte);\r\n}\r\nstatic void __devinit snd_ice1712_stdsp24_darear(struct snd_ice1712 *ice, int activate)\r\n{\r\nstruct hoontech_spec *spec = ice->spec;\r\nmutex_lock(&ice->gpio_mutex);\r\nICE1712_STDSP24_0_DAREAR(spec->boxbits, activate);\r\nsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[0]);\r\nmutex_unlock(&ice->gpio_mutex);\r\n}\r\nstatic void __devinit snd_ice1712_stdsp24_mute(struct snd_ice1712 *ice, int activate)\r\n{\r\nstruct hoontech_spec *spec = ice->spec;\r\nmutex_lock(&ice->gpio_mutex);\r\nICE1712_STDSP24_3_MUTE(spec->boxbits, activate);\r\nsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[3]);\r\nmutex_unlock(&ice->gpio_mutex);\r\n}\r\nstatic void __devinit snd_ice1712_stdsp24_insel(struct snd_ice1712 *ice, int activate)\r\n{\r\nstruct hoontech_spec *spec = ice->spec;\r\nmutex_lock(&ice->gpio_mutex);\r\nICE1712_STDSP24_3_INSEL(spec->boxbits, activate);\r\nsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[3]);\r\nmutex_unlock(&ice->gpio_mutex);\r\n}\r\nstatic void __devinit snd_ice1712_stdsp24_box_channel(struct snd_ice1712 *ice, int box, int chn, int activate)\r\n{\r\nstruct hoontech_spec *spec = ice->spec;\r\nmutex_lock(&ice->gpio_mutex);\r\nICE1712_STDSP24_0_BOX(spec->boxbits, box);\r\nsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[0]);\r\nif (chn == 3)\r\nICE1712_STDSP24_2_CHN4(spec->boxbits, 0);\r\nICE1712_STDSP24_2_MIDI1(spec->boxbits, activate);\r\nsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[2]);\r\nsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[3]);\r\nICE1712_STDSP24_1_CHN1(spec->boxbits, 1);\r\nICE1712_STDSP24_1_CHN2(spec->boxbits, 1);\r\nICE1712_STDSP24_1_CHN3(spec->boxbits, 1);\r\nICE1712_STDSP24_2_CHN4(spec->boxbits, 1);\r\nsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[1]);\r\nsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[2]);\r\nudelay(100);\r\nif (chn == 3) {\r\nICE1712_STDSP24_2_CHN4(spec->boxbits, 0);\r\nsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[2]);\r\n} else {\r\nswitch (chn) {\r\ncase 0: ICE1712_STDSP24_1_CHN1(spec->boxbits, 0); break;\r\ncase 1: ICE1712_STDSP24_1_CHN2(spec->boxbits, 0); break;\r\ncase 2: ICE1712_STDSP24_1_CHN3(spec->boxbits, 0); break;\r\n}\r\nsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[1]);\r\n}\r\nudelay(100);\r\nICE1712_STDSP24_1_CHN1(spec->boxbits, 1);\r\nICE1712_STDSP24_1_CHN2(spec->boxbits, 1);\r\nICE1712_STDSP24_1_CHN3(spec->boxbits, 1);\r\nICE1712_STDSP24_2_CHN4(spec->boxbits, 1);\r\nsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[1]);\r\nsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[2]);\r\nudelay(100);\r\nICE1712_STDSP24_2_MIDI1(spec->boxbits, 0);\r\nsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[2]);\r\nmutex_unlock(&ice->gpio_mutex);\r\n}\r\nstatic void __devinit snd_ice1712_stdsp24_box_midi(struct snd_ice1712 *ice, int box, int master)\r\n{\r\nstruct hoontech_spec *spec = ice->spec;\r\nmutex_lock(&ice->gpio_mutex);\r\nICE1712_STDSP24_0_BOX(spec->boxbits, box);\r\nsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[0]);\r\nICE1712_STDSP24_2_MIDIIN(spec->boxbits, 1);\r\nICE1712_STDSP24_2_MIDI1(spec->boxbits, master);\r\nsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[2]);\r\nsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[3]);\r\nudelay(100);\r\nICE1712_STDSP24_2_MIDIIN(spec->boxbits, 0);\r\nsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[2]);\r\nmdelay(10);\r\nICE1712_STDSP24_2_MIDIIN(spec->boxbits, 1);\r\nsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[2]);\r\nmutex_unlock(&ice->gpio_mutex);\r\n}\r\nstatic void __devinit snd_ice1712_stdsp24_midi2(struct snd_ice1712 *ice, int activate)\r\n{\r\nstruct hoontech_spec *spec = ice->spec;\r\nmutex_lock(&ice->gpio_mutex);\r\nICE1712_STDSP24_3_MIDI2(spec->boxbits, activate);\r\nsnd_ice1712_stdsp24_gpio_write(ice, spec->boxbits[3]);\r\nmutex_unlock(&ice->gpio_mutex);\r\n}\r\nstatic int __devinit snd_ice1712_hoontech_init(struct snd_ice1712 *ice)\r\n{\r\nstruct hoontech_spec *spec;\r\nint box, chn;\r\nice->num_total_dacs = 8;\r\nice->num_total_adcs = 8;\r\nspec = kzalloc(sizeof(*spec), GFP_KERNEL);\r\nif (!spec)\r\nreturn -ENOMEM;\r\nice->spec = spec;\r\nICE1712_STDSP24_SET_ADDR(spec->boxbits, 0);\r\nICE1712_STDSP24_CLOCK(spec->boxbits, 0, 1);\r\nICE1712_STDSP24_0_BOX(spec->boxbits, 0);\r\nICE1712_STDSP24_0_DAREAR(spec->boxbits, 0);\r\nICE1712_STDSP24_SET_ADDR(spec->boxbits, 1);\r\nICE1712_STDSP24_CLOCK(spec->boxbits, 1, 1);\r\nICE1712_STDSP24_1_CHN1(spec->boxbits, 1);\r\nICE1712_STDSP24_1_CHN2(spec->boxbits, 1);\r\nICE1712_STDSP24_1_CHN3(spec->boxbits, 1);\r\nICE1712_STDSP24_SET_ADDR(spec->boxbits, 2);\r\nICE1712_STDSP24_CLOCK(spec->boxbits, 2, 1);\r\nICE1712_STDSP24_2_CHN4(spec->boxbits, 1);\r\nICE1712_STDSP24_2_MIDIIN(spec->boxbits, 1);\r\nICE1712_STDSP24_2_MIDI1(spec->boxbits, 0);\r\nICE1712_STDSP24_SET_ADDR(spec->boxbits, 3);\r\nICE1712_STDSP24_CLOCK(spec->boxbits, 3, 1);\r\nICE1712_STDSP24_3_MIDI2(spec->boxbits, 0);\r\nICE1712_STDSP24_3_MUTE(spec->boxbits, 1);\r\nICE1712_STDSP24_3_INSEL(spec->boxbits, 0);\r\nspec->config = 0;\r\nspec->boxconfig[0] = ICE1712_STDSP24_BOX_CHN1 |\r\nICE1712_STDSP24_BOX_CHN2 |\r\nICE1712_STDSP24_BOX_CHN3 |\r\nICE1712_STDSP24_BOX_CHN4 |\r\nICE1712_STDSP24_BOX_MIDI1 |\r\nICE1712_STDSP24_BOX_MIDI2;\r\nspec->boxconfig[1] =\r\nspec->boxconfig[2] =\r\nspec->boxconfig[3] = 0;\r\nsnd_ice1712_stdsp24_darear(ice,\r\n(spec->config & ICE1712_STDSP24_DAREAR) ? 1 : 0);\r\nsnd_ice1712_stdsp24_mute(ice,\r\n(spec->config & ICE1712_STDSP24_MUTE) ? 1 : 0);\r\nsnd_ice1712_stdsp24_insel(ice,\r\n(spec->config & ICE1712_STDSP24_INSEL) ? 1 : 0);\r\nfor (box = 0; box < 4; box++) {\r\nif (spec->boxconfig[box] & ICE1712_STDSP24_BOX_MIDI2)\r\nsnd_ice1712_stdsp24_midi2(ice, 1);\r\nfor (chn = 0; chn < 4; chn++)\r\nsnd_ice1712_stdsp24_box_channel(ice, box, chn,\r\n(spec->boxconfig[box] & (1 << chn)) ? 1 : 0);\r\nif (spec->boxconfig[box] & ICE1712_STDSP24_BOX_MIDI1)\r\nsnd_ice1712_stdsp24_box_midi(ice, box, 1);\r\n}\r\nreturn 0;\r\n}\r\nstatic void stdsp24_ak4524_lock(struct snd_akm4xxx *ak, int chip)\r\n{\r\nstruct snd_ice1712 *ice = ak->private_data[0];\r\nunsigned char tmp;\r\nsnd_ice1712_save_gpio_status(ice);\r\ntmp = ICE1712_STDSP24_SERIAL_DATA |\r\nICE1712_STDSP24_SERIAL_CLOCK |\r\nICE1712_STDSP24_AK4524_CS;\r\nsnd_ice1712_write(ice, ICE1712_IREG_GPIO_DIRECTION,\r\nice->gpio.direction | tmp);\r\nsnd_ice1712_write(ice, ICE1712_IREG_GPIO_WRITE_MASK, ~tmp);\r\n}\r\nstatic int __devinit snd_ice1712_value_init(struct snd_ice1712 *ice)\r\n{\r\nstatic struct snd_akm4xxx akm_stdsp24_mv __devinitdata = {\r\n.num_adcs = 2,\r\n.num_dacs = 2,\r\n.type = SND_AK4524,\r\n.ops = {\r\n.lock = stdsp24_ak4524_lock\r\n}\r\n};\r\nstatic struct snd_ak4xxx_private akm_stdsp24_mv_priv __devinitdata = {\r\n.caddr = 2,\r\n.cif = 1,\r\n.data_mask = ICE1712_STDSP24_SERIAL_DATA,\r\n.clk_mask = ICE1712_STDSP24_SERIAL_CLOCK,\r\n.cs_mask = ICE1712_STDSP24_AK4524_CS,\r\n.cs_addr = ICE1712_STDSP24_AK4524_CS,\r\n.cs_none = 0,\r\n.add_flags = 0,\r\n};\r\nint err;\r\nstruct snd_akm4xxx *ak;\r\nice->num_total_dacs = 2;\r\nice->num_total_adcs = 2;\r\nak = ice->akm = kmalloc(sizeof(struct snd_akm4xxx), GFP_KERNEL);\r\nif (! ak)\r\nreturn -ENOMEM;\r\nice->akm_codecs = 1;\r\nerr = snd_ice1712_akm4xxx_init(ak, &akm_stdsp24_mv, &akm_stdsp24_mv_priv, ice);\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_ice1712_akm4xxx_build_controls(ice);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int __devinit snd_ice1712_ez8_init(struct snd_ice1712 *ice)\r\n{\r\nice->gpio.write_mask = ice->eeprom.gpiomask;\r\nice->gpio.direction = ice->eeprom.gpiodir;\r\nsnd_ice1712_write(ice, ICE1712_IREG_GPIO_WRITE_MASK, ice->eeprom.gpiomask);\r\nsnd_ice1712_write(ice, ICE1712_IREG_GPIO_DIRECTION, ice->eeprom.gpiodir);\r\nsnd_ice1712_write(ice, ICE1712_IREG_GPIO_DATA, ice->eeprom.gpiostate);\r\nreturn 0;\r\n}

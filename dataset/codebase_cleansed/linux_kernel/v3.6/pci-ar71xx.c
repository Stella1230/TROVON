static inline u32 ar71xx_pci_get_ble(int where, int size, int local)\r\n{\r\nu32 t;\r\nt = ar71xx_pci_ble_table[size & 3][where & 3];\r\nBUG_ON(t == 0xf);\r\nt <<= (local) ? 20 : 4;\r\nreturn t;\r\n}\r\nstatic inline u32 ar71xx_pci_bus_addr(struct pci_bus *bus, unsigned int devfn,\r\nint where)\r\n{\r\nu32 ret;\r\nif (!bus->number) {\r\nret = (1 << PCI_SLOT(devfn)) | (PCI_FUNC(devfn) << 8) |\r\n(where & ~3);\r\n} else {\r\nret = (bus->number << 16) | (PCI_SLOT(devfn) << 11) |\r\n(PCI_FUNC(devfn) << 8) | (where & ~3) | 1;\r\n}\r\nreturn ret;\r\n}\r\nstatic int ar71xx_pci_check_error(int quiet)\r\n{\r\nvoid __iomem *base = ar71xx_pcicfg_base;\r\nu32 pci_err;\r\nu32 ahb_err;\r\npci_err = __raw_readl(base + AR71XX_PCI_REG_PCI_ERR) & 3;\r\nif (pci_err) {\r\nif (!quiet) {\r\nu32 addr;\r\naddr = __raw_readl(base + AR71XX_PCI_REG_PCI_ERR_ADDR);\r\npr_crit("ar71xx: %s bus error %d at addr 0x%x\n",\r\n"PCI", pci_err, addr);\r\n}\r\n__raw_writel(pci_err, base + AR71XX_PCI_REG_PCI_ERR);\r\n}\r\nahb_err = __raw_readl(base + AR71XX_PCI_REG_AHB_ERR) & 1;\r\nif (ahb_err) {\r\nif (!quiet) {\r\nu32 addr;\r\naddr = __raw_readl(base + AR71XX_PCI_REG_AHB_ERR_ADDR);\r\npr_crit("ar71xx: %s bus error %d at addr 0x%x\n",\r\n"AHB", ahb_err, addr);\r\n}\r\n__raw_writel(ahb_err, base + AR71XX_PCI_REG_AHB_ERR);\r\n}\r\nreturn !!(ahb_err | pci_err);\r\n}\r\nstatic inline void ar71xx_pci_local_write(int where, int size, u32 value)\r\n{\r\nvoid __iomem *base = ar71xx_pcicfg_base;\r\nu32 ad_cbe;\r\nvalue = value << (8 * (where & 3));\r\nad_cbe = AR71XX_PCI_CRP_CMD_WRITE | (where & ~3);\r\nad_cbe |= ar71xx_pci_get_ble(where, size, 1);\r\n__raw_writel(ad_cbe, base + AR71XX_PCI_REG_CRP_AD_CBE);\r\n__raw_writel(value, base + AR71XX_PCI_REG_CRP_WRDATA);\r\n}\r\nstatic inline int ar71xx_pci_set_cfgaddr(struct pci_bus *bus,\r\nunsigned int devfn,\r\nint where, int size, u32 cmd)\r\n{\r\nvoid __iomem *base = ar71xx_pcicfg_base;\r\nu32 addr;\r\naddr = ar71xx_pci_bus_addr(bus, devfn, where);\r\n__raw_writel(addr, base + AR71XX_PCI_REG_CFG_AD);\r\n__raw_writel(cmd | ar71xx_pci_get_ble(where, size, 0),\r\nbase + AR71XX_PCI_REG_CFG_CBE);\r\nreturn ar71xx_pci_check_error(1);\r\n}\r\nstatic int ar71xx_pci_read_config(struct pci_bus *bus, unsigned int devfn,\r\nint where, int size, u32 *value)\r\n{\r\nvoid __iomem *base = ar71xx_pcicfg_base;\r\nunsigned long flags;\r\nu32 data;\r\nint err;\r\nint ret;\r\nret = PCIBIOS_SUCCESSFUL;\r\ndata = ~0;\r\nspin_lock_irqsave(&ar71xx_pci_lock, flags);\r\nerr = ar71xx_pci_set_cfgaddr(bus, devfn, where, size,\r\nAR71XX_PCI_CFG_CMD_READ);\r\nif (err)\r\nret = PCIBIOS_DEVICE_NOT_FOUND;\r\nelse\r\ndata = __raw_readl(base + AR71XX_PCI_REG_CFG_RDDATA);\r\nspin_unlock_irqrestore(&ar71xx_pci_lock, flags);\r\n*value = (data >> (8 * (where & 3))) & ar71xx_pci_read_mask[size & 7];\r\nreturn ret;\r\n}\r\nstatic int ar71xx_pci_write_config(struct pci_bus *bus, unsigned int devfn,\r\nint where, int size, u32 value)\r\n{\r\nvoid __iomem *base = ar71xx_pcicfg_base;\r\nunsigned long flags;\r\nint err;\r\nint ret;\r\nvalue = value << (8 * (where & 3));\r\nret = PCIBIOS_SUCCESSFUL;\r\nspin_lock_irqsave(&ar71xx_pci_lock, flags);\r\nerr = ar71xx_pci_set_cfgaddr(bus, devfn, where, size,\r\nAR71XX_PCI_CFG_CMD_WRITE);\r\nif (err)\r\nret = PCIBIOS_DEVICE_NOT_FOUND;\r\nelse\r\n__raw_writel(value, base + AR71XX_PCI_REG_CFG_WRDATA);\r\nspin_unlock_irqrestore(&ar71xx_pci_lock, flags);\r\nreturn ret;\r\n}\r\nstatic void ar71xx_pci_irq_handler(unsigned int irq, struct irq_desc *desc)\r\n{\r\nvoid __iomem *base = ath79_reset_base;\r\nu32 pending;\r\npending = __raw_readl(base + AR71XX_RESET_REG_PCI_INT_STATUS) &\r\n__raw_readl(base + AR71XX_RESET_REG_PCI_INT_ENABLE);\r\nif (pending & AR71XX_PCI_INT_DEV0)\r\ngeneric_handle_irq(ATH79_PCI_IRQ(0));\r\nelse if (pending & AR71XX_PCI_INT_DEV1)\r\ngeneric_handle_irq(ATH79_PCI_IRQ(1));\r\nelse if (pending & AR71XX_PCI_INT_DEV2)\r\ngeneric_handle_irq(ATH79_PCI_IRQ(2));\r\nelse if (pending & AR71XX_PCI_INT_CORE)\r\ngeneric_handle_irq(ATH79_PCI_IRQ(4));\r\nelse\r\nspurious_interrupt();\r\n}\r\nstatic void ar71xx_pci_irq_unmask(struct irq_data *d)\r\n{\r\nunsigned int irq = d->irq - ATH79_PCI_IRQ_BASE;\r\nvoid __iomem *base = ath79_reset_base;\r\nu32 t;\r\nt = __raw_readl(base + AR71XX_RESET_REG_PCI_INT_ENABLE);\r\n__raw_writel(t | (1 << irq), base + AR71XX_RESET_REG_PCI_INT_ENABLE);\r\n__raw_readl(base + AR71XX_RESET_REG_PCI_INT_ENABLE);\r\n}\r\nstatic void ar71xx_pci_irq_mask(struct irq_data *d)\r\n{\r\nunsigned int irq = d->irq - ATH79_PCI_IRQ_BASE;\r\nvoid __iomem *base = ath79_reset_base;\r\nu32 t;\r\nt = __raw_readl(base + AR71XX_RESET_REG_PCI_INT_ENABLE);\r\n__raw_writel(t & ~(1 << irq), base + AR71XX_RESET_REG_PCI_INT_ENABLE);\r\n__raw_readl(base + AR71XX_RESET_REG_PCI_INT_ENABLE);\r\n}\r\nstatic __init void ar71xx_pci_irq_init(void)\r\n{\r\nvoid __iomem *base = ath79_reset_base;\r\nint i;\r\n__raw_writel(0, base + AR71XX_RESET_REG_PCI_INT_ENABLE);\r\n__raw_writel(0, base + AR71XX_RESET_REG_PCI_INT_STATUS);\r\nBUILD_BUG_ON(ATH79_PCI_IRQ_COUNT < AR71XX_PCI_IRQ_COUNT);\r\nfor (i = ATH79_PCI_IRQ_BASE;\r\ni < ATH79_PCI_IRQ_BASE + AR71XX_PCI_IRQ_COUNT; i++)\r\nirq_set_chip_and_handler(i, &ar71xx_pci_irq_chip,\r\nhandle_level_irq);\r\nirq_set_chained_handler(ATH79_CPU_IRQ_IP2, ar71xx_pci_irq_handler);\r\n}\r\nstatic __init void ar71xx_pci_reset(void)\r\n{\r\nvoid __iomem *ddr_base = ath79_ddr_base;\r\nath79_device_reset_set(AR71XX_RESET_PCI_BUS | AR71XX_RESET_PCI_CORE);\r\nmdelay(100);\r\nath79_device_reset_clear(AR71XX_RESET_PCI_BUS | AR71XX_RESET_PCI_CORE);\r\nmdelay(100);\r\n__raw_writel(AR71XX_PCI_WIN0_OFFS, ddr_base + AR71XX_DDR_REG_PCI_WIN0);\r\n__raw_writel(AR71XX_PCI_WIN1_OFFS, ddr_base + AR71XX_DDR_REG_PCI_WIN1);\r\n__raw_writel(AR71XX_PCI_WIN2_OFFS, ddr_base + AR71XX_DDR_REG_PCI_WIN2);\r\n__raw_writel(AR71XX_PCI_WIN3_OFFS, ddr_base + AR71XX_DDR_REG_PCI_WIN3);\r\n__raw_writel(AR71XX_PCI_WIN4_OFFS, ddr_base + AR71XX_DDR_REG_PCI_WIN4);\r\n__raw_writel(AR71XX_PCI_WIN5_OFFS, ddr_base + AR71XX_DDR_REG_PCI_WIN5);\r\n__raw_writel(AR71XX_PCI_WIN6_OFFS, ddr_base + AR71XX_DDR_REG_PCI_WIN6);\r\n__raw_writel(AR71XX_PCI_WIN7_OFFS, ddr_base + AR71XX_DDR_REG_PCI_WIN7);\r\nmdelay(100);\r\n}\r\n__init int ar71xx_pcibios_init(void)\r\n{\r\nu32 t;\r\nar71xx_pcicfg_base = ioremap(AR71XX_PCI_CFG_BASE, AR71XX_PCI_CFG_SIZE);\r\nif (ar71xx_pcicfg_base == NULL)\r\nreturn -ENOMEM;\r\nar71xx_pci_reset();\r\nt = PCI_COMMAND_MEMORY | PCI_COMMAND_MASTER | PCI_COMMAND_INVALIDATE\r\n| PCI_COMMAND_PARITY | PCI_COMMAND_SERR | PCI_COMMAND_FAST_BACK;\r\nar71xx_pci_local_write(PCI_COMMAND, 4, t);\r\nar71xx_pci_check_error(1);\r\nar71xx_pci_irq_init();\r\nregister_pci_controller(&ar71xx_pci_controller);\r\nreturn 0;\r\n}

static void\r\nmcp_sa11x0_set_telecom_divisor(struct mcp *mcp, unsigned int divisor)\r\n{\r\nstruct mcp_sa11x0 *m = priv(mcp);\r\ndivisor /= 32;\r\nm->mccr0 &= ~0x00007f00;\r\nm->mccr0 |= divisor << 8;\r\nwritel_relaxed(m->mccr0, MCCR0(m));\r\n}\r\nstatic void\r\nmcp_sa11x0_set_audio_divisor(struct mcp *mcp, unsigned int divisor)\r\n{\r\nstruct mcp_sa11x0 *m = priv(mcp);\r\ndivisor /= 32;\r\nm->mccr0 &= ~0x0000007f;\r\nm->mccr0 |= divisor;\r\nwritel_relaxed(m->mccr0, MCCR0(m));\r\n}\r\nstatic void\r\nmcp_sa11x0_write(struct mcp *mcp, unsigned int reg, unsigned int val)\r\n{\r\nstruct mcp_sa11x0 *m = priv(mcp);\r\nint ret = -ETIME;\r\nint i;\r\nwritel_relaxed(reg << 17 | MCDR2_Wr | (val & 0xffff), MCDR2(m));\r\nfor (i = 0; i < 2; i++) {\r\nudelay(mcp->rw_timeout);\r\nif (readl_relaxed(MCSR(m)) & MCSR_CWC) {\r\nret = 0;\r\nbreak;\r\n}\r\n}\r\nif (ret < 0)\r\nprintk(KERN_WARNING "mcp: write timed out\n");\r\n}\r\nstatic unsigned int\r\nmcp_sa11x0_read(struct mcp *mcp, unsigned int reg)\r\n{\r\nstruct mcp_sa11x0 *m = priv(mcp);\r\nint ret = -ETIME;\r\nint i;\r\nwritel_relaxed(reg << 17 | MCDR2_Rd, MCDR2(m));\r\nfor (i = 0; i < 2; i++) {\r\nudelay(mcp->rw_timeout);\r\nif (readl_relaxed(MCSR(m)) & MCSR_CRC) {\r\nret = readl_relaxed(MCDR2(m)) & 0xffff;\r\nbreak;\r\n}\r\n}\r\nif (ret < 0)\r\nprintk(KERN_WARNING "mcp: read timed out\n");\r\nreturn ret;\r\n}\r\nstatic void mcp_sa11x0_enable(struct mcp *mcp)\r\n{\r\nstruct mcp_sa11x0 *m = priv(mcp);\r\nwritel(-1, MCSR(m));\r\nm->mccr0 |= MCCR0_MCE;\r\nwritel_relaxed(m->mccr0, MCCR0(m));\r\n}\r\nstatic void mcp_sa11x0_disable(struct mcp *mcp)\r\n{\r\nstruct mcp_sa11x0 *m = priv(mcp);\r\nm->mccr0 &= ~MCCR0_MCE;\r\nwritel_relaxed(m->mccr0, MCCR0(m));\r\n}\r\nstatic int mcp_sa11x0_probe(struct platform_device *dev)\r\n{\r\nstruct mcp_plat_data *data = dev->dev.platform_data;\r\nstruct resource *mem0, *mem1;\r\nstruct mcp_sa11x0 *m;\r\nstruct mcp *mcp;\r\nint ret;\r\nif (!data)\r\nreturn -ENODEV;\r\nmem0 = platform_get_resource(dev, IORESOURCE_MEM, 0);\r\nmem1 = platform_get_resource(dev, IORESOURCE_MEM, 1);\r\nif (!mem0 || !mem1)\r\nreturn -ENXIO;\r\nif (!request_mem_region(mem0->start, resource_size(mem0),\r\nDRIVER_NAME)) {\r\nret = -EBUSY;\r\ngoto err_mem0;\r\n}\r\nif (!request_mem_region(mem1->start, resource_size(mem1),\r\nDRIVER_NAME)) {\r\nret = -EBUSY;\r\ngoto err_mem1;\r\n}\r\nmcp = mcp_host_alloc(&dev->dev, sizeof(struct mcp_sa11x0));\r\nif (!mcp) {\r\nret = -ENOMEM;\r\ngoto err_alloc;\r\n}\r\nmcp->owner = THIS_MODULE;\r\nmcp->ops = &mcp_sa11x0;\r\nmcp->sclk_rate = data->sclk_rate;\r\nm = priv(mcp);\r\nm->mccr0 = data->mccr0 | 0x7f7f;\r\nm->mccr1 = data->mccr1;\r\nm->base0 = ioremap(mem0->start, resource_size(mem0));\r\nm->base1 = ioremap(mem1->start, resource_size(mem1));\r\nif (!m->base0 || !m->base1) {\r\nret = -ENOMEM;\r\ngoto err_ioremap;\r\n}\r\nplatform_set_drvdata(dev, mcp);\r\nwritel_relaxed(-1, MCSR(m));\r\nwritel_relaxed(m->mccr1, MCCR1(m));\r\nwritel_relaxed(m->mccr0, MCCR0(m));\r\nmcp->rw_timeout = (64 * 3 * 1000000 + mcp->sclk_rate - 1) /\r\nmcp->sclk_rate;\r\nret = mcp_host_add(mcp, data->codec_pdata);\r\nif (ret == 0)\r\nreturn 0;\r\nplatform_set_drvdata(dev, NULL);\r\nerr_ioremap:\r\niounmap(m->base1);\r\niounmap(m->base0);\r\nmcp_host_free(mcp);\r\nerr_alloc:\r\nrelease_mem_region(mem1->start, resource_size(mem1));\r\nerr_mem1:\r\nrelease_mem_region(mem0->start, resource_size(mem0));\r\nerr_mem0:\r\nreturn ret;\r\n}\r\nstatic int mcp_sa11x0_remove(struct platform_device *dev)\r\n{\r\nstruct mcp *mcp = platform_get_drvdata(dev);\r\nstruct mcp_sa11x0 *m = priv(mcp);\r\nstruct resource *mem0, *mem1;\r\nif (m->mccr0 & MCCR0_MCE)\r\ndev_warn(&dev->dev,\r\n"device left active (missing disable call?)\n");\r\nmem0 = platform_get_resource(dev, IORESOURCE_MEM, 0);\r\nmem1 = platform_get_resource(dev, IORESOURCE_MEM, 1);\r\nplatform_set_drvdata(dev, NULL);\r\nmcp_host_del(mcp);\r\niounmap(m->base1);\r\niounmap(m->base0);\r\nmcp_host_free(mcp);\r\nrelease_mem_region(mem1->start, resource_size(mem1));\r\nrelease_mem_region(mem0->start, resource_size(mem0));\r\nreturn 0;\r\n}\r\nstatic int mcp_sa11x0_suspend(struct device *dev)\r\n{\r\nstruct mcp_sa11x0 *m = priv(dev_get_drvdata(dev));\r\nif (m->mccr0 & MCCR0_MCE)\r\ndev_warn(dev, "device left active (missing disable call?)\n");\r\nwritel(m->mccr0 & ~MCCR0_MCE, MCCR0(m));\r\nreturn 0;\r\n}\r\nstatic int mcp_sa11x0_resume(struct device *dev)\r\n{\r\nstruct mcp_sa11x0 *m = priv(dev_get_drvdata(dev));\r\nwritel_relaxed(m->mccr1, MCCR1(m));\r\nwritel_relaxed(m->mccr0, MCCR0(m));\r\nreturn 0;\r\n}

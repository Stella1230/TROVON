int sysv68_partition(struct parsed_partitions *state)\r\n{\r\nint i, slices;\r\nint slot = 1;\r\nSector sect;\r\nunsigned char *data;\r\nstruct dkblk0 *b;\r\nstruct slice *slice;\r\nchar tmp[64];\r\ndata = read_part_sector(state, 0, &sect);\r\nif (!data)\r\nreturn -1;\r\nb = (struct dkblk0 *)data;\r\nif (memcmp(b->dk_vid.vid_mac, "MOTOROLA", sizeof(b->dk_vid.vid_mac))) {\r\nput_dev_sector(sect);\r\nreturn 0;\r\n}\r\nslices = be16_to_cpu(b->dk_ios.ios_slccnt);\r\ni = be32_to_cpu(b->dk_ios.ios_slcblk);\r\nput_dev_sector(sect);\r\ndata = read_part_sector(state, i, &sect);\r\nif (!data)\r\nreturn -1;\r\nslices -= 1;\r\nsnprintf(tmp, sizeof(tmp), "sysV68: %s(s%u)", state->name, slices);\r\nstrlcat(state->pp_buf, tmp, PAGE_SIZE);\r\nslice = (struct slice *)data;\r\nfor (i = 0; i < slices; i++, slice++) {\r\nif (slot == state->limit)\r\nbreak;\r\nif (be32_to_cpu(slice->nblocks)) {\r\nput_partition(state, slot,\r\nbe32_to_cpu(slice->blkoff),\r\nbe32_to_cpu(slice->nblocks));\r\nsnprintf(tmp, sizeof(tmp), "(s%u)", i);\r\nstrlcat(state->pp_buf, tmp, PAGE_SIZE);\r\n}\r\nslot++;\r\n}\r\nstrlcat(state->pp_buf, "\n", PAGE_SIZE);\r\nput_dev_sector(sect);\r\nreturn 1;\r\n}

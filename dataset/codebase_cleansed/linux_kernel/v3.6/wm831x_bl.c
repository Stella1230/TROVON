static int wm831x_backlight_set(struct backlight_device *bl, int brightness)\r\n{\r\nstruct wm831x_backlight_data *data = bl_get_data(bl);\r\nstruct wm831x *wm831x = data->wm831x;\r\nint power_up = !data->current_brightness && brightness;\r\nint power_down = data->current_brightness && !brightness;\r\nint ret;\r\nif (power_up) {\r\nret = wm831x_set_bits(wm831x, data->isink_reg,\r\nWM831X_CS1_ENA, WM831X_CS1_ENA);\r\nif (ret < 0)\r\ngoto err;\r\nret = wm831x_set_bits(wm831x, WM831X_DCDC_ENABLE,\r\nWM831X_DC4_ENA, WM831X_DC4_ENA);\r\nif (ret < 0)\r\ngoto err;\r\n}\r\nif (power_down) {\r\nret = wm831x_set_bits(wm831x, WM831X_DCDC_ENABLE,\r\nWM831X_DC4_ENA, 0);\r\nif (ret < 0)\r\ngoto err;\r\nret = wm831x_set_bits(wm831x, data->isink_reg,\r\nWM831X_CS1_DRIVE | WM831X_CS1_ENA, 0);\r\nif (ret < 0)\r\ngoto err;\r\n}\r\nret = wm831x_set_bits(wm831x, data->isink_reg,\r\nWM831X_CS1_ISEL_MASK, brightness);\r\nif (ret < 0)\r\ngoto err;\r\nif (power_up) {\r\nret = wm831x_set_bits(wm831x, data->isink_reg,\r\nWM831X_CS1_DRIVE, WM831X_CS1_DRIVE);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\ndata->current_brightness = brightness;\r\nreturn 0;\r\nerr:\r\nif (power_up || power_down) {\r\nwm831x_set_bits(wm831x, WM831X_DCDC_ENABLE, WM831X_DC4_ENA, 0);\r\nwm831x_set_bits(wm831x, data->isink_reg, WM831X_CS1_ENA, 0);\r\n}\r\nreturn ret;\r\n}\r\nstatic int wm831x_backlight_update_status(struct backlight_device *bl)\r\n{\r\nint brightness = bl->props.brightness;\r\nif (bl->props.power != FB_BLANK_UNBLANK)\r\nbrightness = 0;\r\nif (bl->props.fb_blank != FB_BLANK_UNBLANK)\r\nbrightness = 0;\r\nif (bl->props.state & BL_CORE_SUSPENDED)\r\nbrightness = 0;\r\nreturn wm831x_backlight_set(bl, brightness);\r\n}\r\nstatic int wm831x_backlight_get_brightness(struct backlight_device *bl)\r\n{\r\nstruct wm831x_backlight_data *data = bl_get_data(bl);\r\nreturn data->current_brightness;\r\n}\r\nstatic int wm831x_backlight_probe(struct platform_device *pdev)\r\n{\r\nstruct wm831x *wm831x = dev_get_drvdata(pdev->dev.parent);\r\nstruct wm831x_pdata *wm831x_pdata;\r\nstruct wm831x_backlight_pdata *pdata;\r\nstruct wm831x_backlight_data *data;\r\nstruct backlight_device *bl;\r\nstruct backlight_properties props;\r\nint ret, i, max_isel, isink_reg, dcdc_cfg;\r\nif (pdev->dev.parent->platform_data) {\r\nwm831x_pdata = pdev->dev.parent->platform_data;\r\npdata = wm831x_pdata->backlight;\r\n} else {\r\npdata = NULL;\r\n}\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "No platform data supplied\n");\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; i < WM831X_ISINK_MAX_ISEL; i++) {\r\nif (wm831x_isinkv_values[i] > pdata->max_uA)\r\nbreak;\r\n}\r\nif (i == 0) {\r\ndev_err(&pdev->dev, "Invalid max_uA: %duA\n", pdata->max_uA);\r\nreturn -EINVAL;\r\n}\r\nmax_isel = i - 1;\r\nif (pdata->max_uA != wm831x_isinkv_values[max_isel])\r\ndev_warn(&pdev->dev,\r\n"Maximum current is %duA not %duA as requested\n",\r\nwm831x_isinkv_values[max_isel], pdata->max_uA);\r\nswitch (pdata->isink) {\r\ncase 1:\r\nisink_reg = WM831X_CURRENT_SINK_1;\r\ndcdc_cfg = 0;\r\nbreak;\r\ncase 2:\r\nisink_reg = WM831X_CURRENT_SINK_2;\r\ndcdc_cfg = WM831X_DC4_FBSRC;\r\nbreak;\r\ndefault:\r\ndev_err(&pdev->dev, "Invalid ISINK %d\n", pdata->isink);\r\nreturn -EINVAL;\r\n}\r\nret = wm831x_reg_unlock(wm831x);\r\nif (ret < 0)\r\nreturn ret;\r\nret = wm831x_set_bits(wm831x, WM831X_DC4_CONTROL, WM831X_DC4_FBSRC,\r\ndcdc_cfg);\r\nwm831x_reg_lock(wm831x);\r\nif (ret < 0)\r\nreturn ret;\r\ndata = devm_kzalloc(&pdev->dev, sizeof(*data), GFP_KERNEL);\r\nif (data == NULL)\r\nreturn -ENOMEM;\r\ndata->wm831x = wm831x;\r\ndata->current_brightness = 0;\r\ndata->isink_reg = isink_reg;\r\nmemset(&props, 0, sizeof(props));\r\nprops.type = BACKLIGHT_RAW;\r\nprops.max_brightness = max_isel;\r\nbl = backlight_device_register("wm831x", &pdev->dev, data,\r\n&wm831x_backlight_ops, &props);\r\nif (IS_ERR(bl)) {\r\ndev_err(&pdev->dev, "failed to register backlight\n");\r\nreturn PTR_ERR(bl);\r\n}\r\nbl->props.brightness = max_isel;\r\nplatform_set_drvdata(pdev, bl);\r\nwm831x_set_bits(wm831x, WM831X_DCDC_ENABLE, WM831X_DC4_ENA, 0);\r\nbacklight_update_status(bl);\r\nreturn 0;\r\n}\r\nstatic int wm831x_backlight_remove(struct platform_device *pdev)\r\n{\r\nstruct backlight_device *bl = platform_get_drvdata(pdev);\r\nbacklight_device_unregister(bl);\r\nreturn 0;\r\n}

static int ohci_platform_reset(struct usb_hcd *hcd)\r\n{\r\nstruct platform_device *pdev = to_platform_device(hcd->self.controller);\r\nstruct usb_ohci_pdata *pdata = pdev->dev.platform_data;\r\nstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\r\nint err;\r\nif (pdata->big_endian_desc)\r\nohci->flags |= OHCI_QUIRK_BE_DESC;\r\nif (pdata->big_endian_mmio)\r\nohci->flags |= OHCI_QUIRK_BE_MMIO;\r\nif (pdata->no_big_frame_no)\r\nohci->flags |= OHCI_QUIRK_FRAME_NO;\r\nohci_hcd_init(ohci);\r\nerr = ohci_init(ohci);\r\nreturn err;\r\n}\r\nstatic int ohci_platform_start(struct usb_hcd *hcd)\r\n{\r\nstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\r\nint err;\r\nerr = ohci_run(ohci);\r\nif (err < 0) {\r\nohci_err(ohci, "can't start\n");\r\nohci_stop(hcd);\r\n}\r\nreturn err;\r\n}\r\nstatic int __devinit ohci_platform_probe(struct platform_device *dev)\r\n{\r\nstruct usb_hcd *hcd;\r\nstruct resource *res_mem;\r\nint irq;\r\nint err = -ENOMEM;\r\nBUG_ON(!dev->dev.platform_data);\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\nirq = platform_get_irq(dev, 0);\r\nif (irq < 0) {\r\npr_err("no irq provided");\r\nreturn irq;\r\n}\r\nres_mem = platform_get_resource(dev, IORESOURCE_MEM, 0);\r\nif (!res_mem) {\r\npr_err("no memory recourse provided");\r\nreturn -ENXIO;\r\n}\r\nhcd = usb_create_hcd(&ohci_platform_hc_driver, &dev->dev,\r\ndev_name(&dev->dev));\r\nif (!hcd)\r\nreturn -ENOMEM;\r\nhcd->rsrc_start = res_mem->start;\r\nhcd->rsrc_len = resource_size(res_mem);\r\nif (!request_mem_region(hcd->rsrc_start, hcd->rsrc_len, hcd_name)) {\r\npr_err("controller already in use");\r\nerr = -EBUSY;\r\ngoto err_put_hcd;\r\n}\r\nhcd->regs = ioremap_nocache(hcd->rsrc_start, hcd->rsrc_len);\r\nif (!hcd->regs)\r\ngoto err_release_region;\r\nerr = usb_add_hcd(hcd, irq, IRQF_SHARED);\r\nif (err)\r\ngoto err_iounmap;\r\nplatform_set_drvdata(dev, hcd);\r\nreturn err;\r\nerr_iounmap:\r\niounmap(hcd->regs);\r\nerr_release_region:\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nerr_put_hcd:\r\nusb_put_hcd(hcd);\r\nreturn err;\r\n}\r\nstatic int __devexit ohci_platform_remove(struct platform_device *dev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(dev);\r\nusb_remove_hcd(hcd);\r\niounmap(hcd->regs);\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nusb_put_hcd(hcd);\r\nplatform_set_drvdata(dev, NULL);\r\nreturn 0;\r\n}\r\nstatic int ohci_platform_suspend(struct device *dev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int ohci_platform_resume(struct device *dev)\r\n{\r\nstruct usb_hcd *hcd = dev_get_drvdata(dev);\r\nohci_finish_controller_resume(hcd);\r\nreturn 0;\r\n}

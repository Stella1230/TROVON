int i1480_rceb_check(const struct i1480 *i1480, const struct uwb_rceb *rceb,\r\nconst char *cmd, u8 context, u8 expected_type,\r\nunsigned expected_event)\r\n{\r\nint result = 0;\r\nstruct device *dev = i1480->dev;\r\nif (rceb->bEventContext != context) {\r\nif (cmd)\r\ndev_err(dev, "%s: unexpected context id 0x%02x "\r\n"(expected 0x%02x)\n", cmd,\r\nrceb->bEventContext, context);\r\nresult = -EINVAL;\r\n}\r\nif (rceb->bEventType != expected_type) {\r\nif (cmd)\r\ndev_err(dev, "%s: unexpected event type 0x%02x "\r\n"(expected 0x%02x)\n", cmd,\r\nrceb->bEventType, expected_type);\r\nresult = -EINVAL;\r\n}\r\nif (le16_to_cpu(rceb->wEvent) != expected_event) {\r\nif (cmd)\r\ndev_err(dev, "%s: unexpected event 0x%04x "\r\n"(expected 0x%04x)\n", cmd,\r\nle16_to_cpu(rceb->wEvent), expected_event);\r\nresult = -EINVAL;\r\n}\r\nreturn result;\r\n}\r\nssize_t i1480_cmd(struct i1480 *i1480, const char *cmd_name, size_t cmd_size,\r\nsize_t reply_size)\r\n{\r\nssize_t result;\r\nstruct uwb_rceb *reply = i1480->evt_buf;\r\nstruct uwb_rccb *cmd = i1480->cmd_buf;\r\nu16 expected_event = reply->wEvent;\r\nu8 expected_type = reply->bEventType;\r\nu8 context;\r\ninit_completion(&i1480->evt_complete);\r\ni1480->evt_result = -EINPROGRESS;\r\ndo {\r\nget_random_bytes(&context, 1);\r\n} while (context == 0x00 || context == 0xff);\r\ncmd->bCommandContext = context;\r\nresult = i1480->cmd(i1480, cmd_name, cmd_size);\r\nif (result < 0)\r\ngoto error;\r\nresult = wait_for_completion_interruptible_timeout(\r\n&i1480->evt_complete, HZ);\r\nif (result == 0) {\r\nresult = -ETIMEDOUT;\r\ngoto error;\r\n}\r\nif (result < 0)\r\ngoto error;\r\nresult = i1480->evt_result;\r\nif (result < 0) {\r\ndev_err(i1480->dev, "%s: command reply reception failed: %zd\n",\r\ncmd_name, result);\r\ngoto error;\r\n}\r\nif (i1480_rceb_check(i1480, i1480->evt_buf, NULL,\r\n0, 0xfd, 0x0022) == 0) {\r\nresult = i1480->wait_init_done(i1480);\r\nif (result < 0)\r\ngoto error;\r\nresult = i1480->evt_result;\r\n}\r\nif (result != reply_size) {\r\ndev_err(i1480->dev, "%s returned only %zu bytes, %zu expected\n",\r\ncmd_name, result, reply_size);\r\nresult = -EINVAL;\r\ngoto error;\r\n}\r\nresult = i1480_rceb_check(i1480, i1480->evt_buf, cmd_name, context,\r\nexpected_type, expected_event);\r\nerror:\r\nreturn result;\r\n}\r\nstatic\r\nint i1480_print_state(struct i1480 *i1480)\r\n{\r\nint result;\r\nu32 *buf = (u32 *) i1480->cmd_buf;\r\nresult = i1480->read(i1480, 0x80080000, 2 * sizeof(*buf));\r\nif (result < 0) {\r\ndev_err(i1480->dev, "cannot read U & L states: %d\n", result);\r\ngoto error;\r\n}\r\ndev_info(i1480->dev, "state U 0x%08x, L 0x%08x\n", buf[0], buf[1]);\r\nerror:\r\nreturn result;\r\n}\r\nint i1480_fw_upload(struct i1480 *i1480)\r\n{\r\nint result;\r\nresult = i1480_pre_fw_upload(i1480);\r\nif (result < 0 && result != -ENOENT) {\r\ni1480_print_state(i1480);\r\ngoto error;\r\n}\r\nresult = i1480_mac_fw_upload(i1480);\r\nif (result < 0) {\r\nif (result == -ENOENT)\r\ndev_err(i1480->dev, "Cannot locate MAC FW file '%s'\n",\r\ni1480->mac_fw_name);\r\nelse\r\ni1480_print_state(i1480);\r\ngoto error;\r\n}\r\nresult = i1480_phy_fw_upload(i1480);\r\nif (result < 0 && result != -ENOENT) {\r\ni1480_print_state(i1480);\r\ngoto error_rc_release;\r\n}\r\ndev_info(i1480->dev, "firmware uploaded successfully\n");\r\nerror_rc_release:\r\nif (i1480->rc_release)\r\ni1480->rc_release(i1480);\r\nresult = 0;\r\nerror:\r\nreturn result;\r\n}

static void intc_irq_mask(struct irq_data *d)\r\n{\r\nunsigned int irq = d->irq;\r\nif ((irq >= MCFINT_VECBASE) && (irq <= MCFINT_VECMAX)) {\r\nu32 v;\r\nirq -= MCFINT_VECBASE;\r\nv = 0x8 << intc_irqmap[irq].index;\r\nwritel(v, MCF_MBAR + intc_irqmap[irq].icr);\r\n}\r\n}\r\nstatic void intc_irq_unmask(struct irq_data *d)\r\n{\r\nunsigned int irq = d->irq;\r\nif ((irq >= MCFINT_VECBASE) && (irq <= MCFINT_VECMAX)) {\r\nu32 v;\r\nirq -= MCFINT_VECBASE;\r\nv = 0xd << intc_irqmap[irq].index;\r\nwritel(v, MCF_MBAR + intc_irqmap[irq].icr);\r\n}\r\n}\r\nstatic void intc_irq_ack(struct irq_data *d)\r\n{\r\nunsigned int irq = d->irq;\r\nif ((irq >= MCFINT_VECBASE) && (irq <= MCFINT_VECMAX)) {\r\nirq -= MCFINT_VECBASE;\r\nif (intc_irqmap[irq].ack) {\r\nu32 v;\r\nv = readl(MCF_MBAR + intc_irqmap[irq].icr);\r\nv &= (0x7 << intc_irqmap[irq].index);\r\nv |= (0x8 << intc_irqmap[irq].index);\r\nwritel(v, MCF_MBAR + intc_irqmap[irq].icr);\r\n}\r\n}\r\n}\r\nstatic int intc_irq_set_type(struct irq_data *d, unsigned int type)\r\n{\r\nunsigned int irq = d->irq;\r\nif ((irq >= MCFINT_VECBASE) && (irq <= MCFINT_VECMAX)) {\r\nirq -= MCFINT_VECBASE;\r\nif (intc_irqmap[irq].ack) {\r\nu32 v;\r\nv = readl(MCF_MBAR + MCFSIM_PITR);\r\nif (type == IRQ_TYPE_EDGE_FALLING)\r\nv &= ~(0x1 << (32 - irq));\r\nelse\r\nv |= (0x1 << (32 - irq));\r\nwritel(v, MCF_MBAR + MCFSIM_PITR);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void intc_external_irq(unsigned int irq, struct irq_desc *desc)\r\n{\r\nirq_desc_get_chip(desc)->irq_ack(&desc->irq_data);\r\nhandle_simple_irq(irq, desc);\r\n}\r\nvoid __init init_IRQ(void)\r\n{\r\nint irq, edge;\r\nwritel(0x88888888, MCF_MBAR + MCFSIM_ICR1);\r\nwritel(0x88888888, MCF_MBAR + MCFSIM_ICR2);\r\nwritel(0x88888888, MCF_MBAR + MCFSIM_ICR3);\r\nwritel(0x88888888, MCF_MBAR + MCFSIM_ICR4);\r\nfor (irq = 0; (irq < NR_IRQS); irq++) {\r\nirq_set_chip(irq, &intc_irq_chip);\r\nedge = 0;\r\nif ((irq >= MCFINT_VECBASE) && (irq <= MCFINT_VECMAX))\r\nedge = intc_irqmap[irq - MCFINT_VECBASE].ack;\r\nif (edge) {\r\nirq_set_irq_type(irq, IRQ_TYPE_EDGE_RISING);\r\nirq_set_handler(irq, intc_external_irq);\r\n} else {\r\nirq_set_irq_type(irq, IRQ_TYPE_LEVEL_HIGH);\r\nirq_set_handler(irq, handle_level_irq);\r\n}\r\n}\r\n}

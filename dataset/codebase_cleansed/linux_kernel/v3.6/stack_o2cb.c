static inline int mode_to_o2dlm(int mode)\r\n{\r\nBUG_ON(mode > LKM_MAXMODE);\r\nreturn mode;\r\n}\r\nstatic int flags_to_o2dlm(u32 flags)\r\n{\r\nint o2dlm_flags = 0;\r\nmap_flag(DLM_LKF_NOQUEUE, LKM_NOQUEUE);\r\nmap_flag(DLM_LKF_CANCEL, LKM_CANCEL);\r\nmap_flag(DLM_LKF_CONVERT, LKM_CONVERT);\r\nmap_flag(DLM_LKF_VALBLK, LKM_VALBLK);\r\nmap_flag(DLM_LKF_IVVALBLK, LKM_INVVALBLK);\r\nmap_flag(DLM_LKF_ORPHAN, LKM_ORPHAN);\r\nmap_flag(DLM_LKF_FORCEUNLOCK, LKM_FORCE);\r\nmap_flag(DLM_LKF_TIMEOUT, LKM_TIMEOUT);\r\nmap_flag(DLM_LKF_LOCAL, LKM_LOCAL);\r\nBUG_ON(flags != 0);\r\nreturn o2dlm_flags;\r\n}\r\nstatic int dlm_status_to_errno(enum dlm_status status)\r\n{\r\nBUG_ON(status < 0 || status >= ARRAY_SIZE(status_map));\r\nreturn status_map[status];\r\n}\r\nstatic void o2dlm_lock_ast_wrapper(void *astarg)\r\n{\r\nstruct ocfs2_dlm_lksb *lksb = astarg;\r\nlksb->lksb_conn->cc_proto->lp_lock_ast(lksb);\r\n}\r\nstatic void o2dlm_blocking_ast_wrapper(void *astarg, int level)\r\n{\r\nstruct ocfs2_dlm_lksb *lksb = astarg;\r\nlksb->lksb_conn->cc_proto->lp_blocking_ast(lksb, level);\r\n}\r\nstatic void o2dlm_unlock_ast_wrapper(void *astarg, enum dlm_status status)\r\n{\r\nstruct ocfs2_dlm_lksb *lksb = astarg;\r\nint error = dlm_status_to_errno(status);\r\nif (status == DLM_CANCELGRANT)\r\nreturn;\r\nlksb->lksb_conn->cc_proto->lp_unlock_ast(lksb, error);\r\n}\r\nstatic int o2cb_dlm_lock(struct ocfs2_cluster_connection *conn,\r\nint mode,\r\nstruct ocfs2_dlm_lksb *lksb,\r\nu32 flags,\r\nvoid *name,\r\nunsigned int namelen)\r\n{\r\nenum dlm_status status;\r\nint o2dlm_mode = mode_to_o2dlm(mode);\r\nint o2dlm_flags = flags_to_o2dlm(flags);\r\nint ret;\r\nstatus = dlmlock(conn->cc_lockspace, o2dlm_mode, &lksb->lksb_o2dlm,\r\no2dlm_flags, name, namelen,\r\no2dlm_lock_ast_wrapper, lksb,\r\no2dlm_blocking_ast_wrapper);\r\nret = dlm_status_to_errno(status);\r\nreturn ret;\r\n}\r\nstatic int o2cb_dlm_unlock(struct ocfs2_cluster_connection *conn,\r\nstruct ocfs2_dlm_lksb *lksb,\r\nu32 flags)\r\n{\r\nenum dlm_status status;\r\nint o2dlm_flags = flags_to_o2dlm(flags);\r\nint ret;\r\nstatus = dlmunlock(conn->cc_lockspace, &lksb->lksb_o2dlm,\r\no2dlm_flags, o2dlm_unlock_ast_wrapper, lksb);\r\nret = dlm_status_to_errno(status);\r\nreturn ret;\r\n}\r\nstatic int o2cb_dlm_lock_status(struct ocfs2_dlm_lksb *lksb)\r\n{\r\nreturn dlm_status_to_errno(lksb->lksb_o2dlm.status);\r\n}\r\nstatic int o2cb_dlm_lvb_valid(struct ocfs2_dlm_lksb *lksb)\r\n{\r\nreturn 1;\r\n}\r\nstatic void *o2cb_dlm_lvb(struct ocfs2_dlm_lksb *lksb)\r\n{\r\nreturn (void *)(lksb->lksb_o2dlm.lvb);\r\n}\r\nstatic void o2cb_dump_lksb(struct ocfs2_dlm_lksb *lksb)\r\n{\r\ndlm_print_one_lock(lksb->lksb_o2dlm.lockid);\r\n}\r\nstatic int o2cb_cluster_check(void)\r\n{\r\nu8 node_num;\r\nint i;\r\nunsigned long hbmap[BITS_TO_LONGS(O2NM_MAX_NODES)];\r\nunsigned long netmap[BITS_TO_LONGS(O2NM_MAX_NODES)];\r\nnode_num = o2nm_this_node();\r\nif (node_num == O2NM_MAX_NODES) {\r\nprintk(KERN_ERR "o2cb: This node has not been configured.\n");\r\nreturn -EINVAL;\r\n}\r\n#define O2CB_MAP_STABILIZE_COUNT 60\r\nfor (i = 0; i < O2CB_MAP_STABILIZE_COUNT; ++i) {\r\no2hb_fill_node_map(hbmap, sizeof(hbmap));\r\nif (!test_bit(node_num, hbmap)) {\r\nprintk(KERN_ERR "o2cb: %s heartbeat has not been "\r\n"started.\n", (o2hb_global_heartbeat_active() ?\r\n"Global" : "Local"));\r\nreturn -EINVAL;\r\n}\r\no2net_fill_node_map(netmap, sizeof(netmap));\r\nset_bit(node_num, netmap);\r\nif (!memcmp(hbmap, netmap, sizeof(hbmap)))\r\nreturn 0;\r\nif (i < O2CB_MAP_STABILIZE_COUNT)\r\nmsleep(1000);\r\n}\r\nprintk(KERN_ERR "o2cb: This node could not connect to nodes:");\r\ni = -1;\r\nwhile ((i = find_next_bit(hbmap, O2NM_MAX_NODES,\r\ni + 1)) < O2NM_MAX_NODES) {\r\nif (!test_bit(i, netmap))\r\nprintk(" %u", i);\r\n}\r\nprintk(".\n");\r\nreturn -ENOTCONN;\r\n}\r\nstatic void o2dlm_eviction_cb(int node_num, void *data)\r\n{\r\nstruct ocfs2_cluster_connection *conn = data;\r\nprintk(KERN_NOTICE "o2cb: o2dlm has evicted node %d from domain %.*s\n",\r\nnode_num, conn->cc_namelen, conn->cc_name);\r\nconn->cc_recovery_handler(node_num, conn->cc_recovery_data);\r\n}\r\nstatic int o2cb_cluster_connect(struct ocfs2_cluster_connection *conn)\r\n{\r\nint rc = 0;\r\nu32 dlm_key;\r\nstruct dlm_ctxt *dlm;\r\nstruct o2dlm_private *priv;\r\nstruct dlm_protocol_version fs_version;\r\nBUG_ON(conn == NULL);\r\nBUG_ON(conn->cc_proto == NULL);\r\nrc = o2cb_cluster_check();\r\nif (rc) {\r\nprintk(KERN_ERR "o2cb: Cluster check failed. Fix errors "\r\n"before retrying.\n");\r\ngoto out;\r\n}\r\npriv = kzalloc(sizeof(struct o2dlm_private), GFP_KERNEL);\r\nif (!priv) {\r\nrc = -ENOMEM;\r\ngoto out_free;\r\n}\r\ndlm_setup_eviction_cb(&priv->op_eviction_cb, o2dlm_eviction_cb,\r\nconn);\r\nconn->cc_private = priv;\r\ndlm_key = crc32_le(0, conn->cc_name, conn->cc_namelen);\r\nfs_version.pv_major = conn->cc_version.pv_major;\r\nfs_version.pv_minor = conn->cc_version.pv_minor;\r\ndlm = dlm_register_domain(conn->cc_name, dlm_key, &fs_version);\r\nif (IS_ERR(dlm)) {\r\nrc = PTR_ERR(dlm);\r\nmlog_errno(rc);\r\ngoto out_free;\r\n}\r\nconn->cc_version.pv_major = fs_version.pv_major;\r\nconn->cc_version.pv_minor = fs_version.pv_minor;\r\nconn->cc_lockspace = dlm;\r\ndlm_register_eviction_cb(dlm, &priv->op_eviction_cb);\r\nout_free:\r\nif (rc && conn->cc_private)\r\nkfree(conn->cc_private);\r\nout:\r\nreturn rc;\r\n}\r\nstatic int o2cb_cluster_disconnect(struct ocfs2_cluster_connection *conn)\r\n{\r\nstruct dlm_ctxt *dlm = conn->cc_lockspace;\r\nstruct o2dlm_private *priv = conn->cc_private;\r\ndlm_unregister_eviction_cb(&priv->op_eviction_cb);\r\nconn->cc_private = NULL;\r\nkfree(priv);\r\ndlm_unregister_domain(dlm);\r\nconn->cc_lockspace = NULL;\r\nreturn 0;\r\n}\r\nstatic int o2cb_cluster_this_node(unsigned int *node)\r\n{\r\nint node_num;\r\nnode_num = o2nm_this_node();\r\nif (node_num == O2NM_INVALID_NODE_NUM)\r\nreturn -ENOENT;\r\nif (node_num >= O2NM_MAX_NODES)\r\nreturn -EOVERFLOW;\r\n*node = node_num;\r\nreturn 0;\r\n}\r\nstatic int __init o2cb_stack_init(void)\r\n{\r\nreturn ocfs2_stack_glue_register(&o2cb_stack);\r\n}\r\nstatic void __exit o2cb_stack_exit(void)\r\n{\r\nocfs2_stack_glue_unregister(&o2cb_stack);\r\n}

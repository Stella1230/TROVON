static uint32_t radeon_encoder_clones(struct drm_encoder *encoder)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct drm_encoder *clone_encoder;\r\nuint32_t index_mask = 0;\r\nint count;\r\nif (rdev->family >= CHIP_R600)\r\nreturn index_mask;\r\nif (radeon_encoder->devices & ATOM_DEVICE_LCD_SUPPORT)\r\nreturn index_mask;\r\nif (radeon_encoder->devices & ATOM_DEVICE_DFP2_SUPPORT)\r\nreturn index_mask;\r\ncount = -1;\r\nlist_for_each_entry(clone_encoder, &dev->mode_config.encoder_list, head) {\r\nstruct radeon_encoder *radeon_clone = to_radeon_encoder(clone_encoder);\r\ncount++;\r\nif (clone_encoder == encoder)\r\ncontinue;\r\nif (radeon_clone->devices & (ATOM_DEVICE_LCD_SUPPORT))\r\ncontinue;\r\nif (radeon_clone->devices & ATOM_DEVICE_DFP2_SUPPORT)\r\ncontinue;\r\nelse\r\nindex_mask |= (1 << count);\r\n}\r\nreturn index_mask;\r\n}\r\nvoid radeon_setup_encoder_clones(struct drm_device *dev)\r\n{\r\nstruct drm_encoder *encoder;\r\nlist_for_each_entry(encoder, &dev->mode_config.encoder_list, head) {\r\nencoder->possible_clones = radeon_encoder_clones(encoder);\r\n}\r\n}\r\nuint32_t\r\nradeon_get_encoder_enum(struct drm_device *dev, uint32_t supported_device, uint8_t dac)\r\n{\r\nstruct radeon_device *rdev = dev->dev_private;\r\nuint32_t ret = 0;\r\nswitch (supported_device) {\r\ncase ATOM_DEVICE_CRT1_SUPPORT:\r\ncase ATOM_DEVICE_TV1_SUPPORT:\r\ncase ATOM_DEVICE_TV2_SUPPORT:\r\ncase ATOM_DEVICE_CRT2_SUPPORT:\r\ncase ATOM_DEVICE_CV_SUPPORT:\r\nswitch (dac) {\r\ncase 1:\r\nif ((rdev->family == CHIP_RS300) ||\r\n(rdev->family == CHIP_RS400) ||\r\n(rdev->family == CHIP_RS480))\r\nret = ENCODER_INTERNAL_DAC2_ENUM_ID1;\r\nelse if (ASIC_IS_AVIVO(rdev))\r\nret = ENCODER_INTERNAL_KLDSCP_DAC1_ENUM_ID1;\r\nelse\r\nret = ENCODER_INTERNAL_DAC1_ENUM_ID1;\r\nbreak;\r\ncase 2:\r\nif (ASIC_IS_AVIVO(rdev))\r\nret = ENCODER_INTERNAL_KLDSCP_DAC2_ENUM_ID1;\r\nelse {\r\nret = ENCODER_INTERNAL_DAC2_ENUM_ID1;\r\n}\r\nbreak;\r\ncase 3:\r\nif (ASIC_IS_AVIVO(rdev))\r\nret = ENCODER_INTERNAL_KLDSCP_DVO1_ENUM_ID1;\r\nelse\r\nret = ENCODER_INTERNAL_DVO1_ENUM_ID1;\r\nbreak;\r\n}\r\nbreak;\r\ncase ATOM_DEVICE_LCD1_SUPPORT:\r\nif (ASIC_IS_AVIVO(rdev))\r\nret = ENCODER_INTERNAL_LVTM1_ENUM_ID1;\r\nelse\r\nret = ENCODER_INTERNAL_LVDS_ENUM_ID1;\r\nbreak;\r\ncase ATOM_DEVICE_DFP1_SUPPORT:\r\nif ((rdev->family == CHIP_RS300) ||\r\n(rdev->family == CHIP_RS400) ||\r\n(rdev->family == CHIP_RS480))\r\nret = ENCODER_INTERNAL_DVO1_ENUM_ID1;\r\nelse if (ASIC_IS_AVIVO(rdev))\r\nret = ENCODER_INTERNAL_KLDSCP_TMDS1_ENUM_ID1;\r\nelse\r\nret = ENCODER_INTERNAL_TMDS1_ENUM_ID1;\r\nbreak;\r\ncase ATOM_DEVICE_LCD2_SUPPORT:\r\ncase ATOM_DEVICE_DFP2_SUPPORT:\r\nif ((rdev->family == CHIP_RS600) ||\r\n(rdev->family == CHIP_RS690) ||\r\n(rdev->family == CHIP_RS740))\r\nret = ENCODER_INTERNAL_DDI_ENUM_ID1;\r\nelse if (ASIC_IS_AVIVO(rdev))\r\nret = ENCODER_INTERNAL_KLDSCP_DVO1_ENUM_ID1;\r\nelse\r\nret = ENCODER_INTERNAL_DVO1_ENUM_ID1;\r\nbreak;\r\ncase ATOM_DEVICE_DFP3_SUPPORT:\r\nret = ENCODER_INTERNAL_LVTM1_ENUM_ID1;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nvoid\r\nradeon_link_encoder_connector(struct drm_device *dev)\r\n{\r\nstruct drm_connector *connector;\r\nstruct radeon_connector *radeon_connector;\r\nstruct drm_encoder *encoder;\r\nstruct radeon_encoder *radeon_encoder;\r\nlist_for_each_entry(connector, &dev->mode_config.connector_list, head) {\r\nradeon_connector = to_radeon_connector(connector);\r\nlist_for_each_entry(encoder, &dev->mode_config.encoder_list, head) {\r\nradeon_encoder = to_radeon_encoder(encoder);\r\nif (radeon_encoder->devices & radeon_connector->devices)\r\ndrm_mode_connector_attach_encoder(connector, encoder);\r\n}\r\n}\r\n}\r\nvoid radeon_encoder_set_active_device(struct drm_encoder *encoder)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct drm_connector *connector;\r\nlist_for_each_entry(connector, &dev->mode_config.connector_list, head) {\r\nif (connector->encoder == encoder) {\r\nstruct radeon_connector *radeon_connector = to_radeon_connector(connector);\r\nradeon_encoder->active_device = radeon_encoder->devices & radeon_connector->devices;\r\nDRM_DEBUG_KMS("setting active device to %08x from %08x %08x for encoder %d\n",\r\nradeon_encoder->active_device, radeon_encoder->devices,\r\nradeon_connector->devices, encoder->encoder_type);\r\n}\r\n}\r\n}\r\nstruct drm_connector *\r\nradeon_get_connector_for_encoder(struct drm_encoder *encoder)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct drm_connector *connector;\r\nstruct radeon_connector *radeon_connector;\r\nlist_for_each_entry(connector, &dev->mode_config.connector_list, head) {\r\nradeon_connector = to_radeon_connector(connector);\r\nif (radeon_encoder->active_device & radeon_connector->devices)\r\nreturn connector;\r\n}\r\nreturn NULL;\r\n}\r\nstruct drm_connector *\r\nradeon_get_connector_for_encoder_init(struct drm_encoder *encoder)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct drm_connector *connector;\r\nstruct radeon_connector *radeon_connector;\r\nlist_for_each_entry(connector, &dev->mode_config.connector_list, head) {\r\nradeon_connector = to_radeon_connector(connector);\r\nif (radeon_encoder->devices & radeon_connector->devices)\r\nreturn connector;\r\n}\r\nreturn NULL;\r\n}\r\nstruct drm_encoder *radeon_get_external_encoder(struct drm_encoder *encoder)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct drm_encoder *other_encoder;\r\nstruct radeon_encoder *other_radeon_encoder;\r\nif (radeon_encoder->is_ext_encoder)\r\nreturn NULL;\r\nlist_for_each_entry(other_encoder, &dev->mode_config.encoder_list, head) {\r\nif (other_encoder == encoder)\r\ncontinue;\r\nother_radeon_encoder = to_radeon_encoder(other_encoder);\r\nif (other_radeon_encoder->is_ext_encoder &&\r\n(radeon_encoder->devices & other_radeon_encoder->devices))\r\nreturn other_encoder;\r\n}\r\nreturn NULL;\r\n}\r\nu16 radeon_encoder_get_dp_bridge_encoder_id(struct drm_encoder *encoder)\r\n{\r\nstruct drm_encoder *other_encoder = radeon_get_external_encoder(encoder);\r\nif (other_encoder) {\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(other_encoder);\r\nswitch (radeon_encoder->encoder_id) {\r\ncase ENCODER_OBJECT_ID_TRAVIS:\r\ncase ENCODER_OBJECT_ID_NUTMEG:\r\nreturn radeon_encoder->encoder_id;\r\ndefault:\r\nreturn ENCODER_OBJECT_ID_NONE;\r\n}\r\n}\r\nreturn ENCODER_OBJECT_ID_NONE;\r\n}\r\nvoid radeon_panel_mode_fixup(struct drm_encoder *encoder,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct drm_display_mode *native_mode = &radeon_encoder->native_mode;\r\nunsigned hblank = native_mode->htotal - native_mode->hdisplay;\r\nunsigned vblank = native_mode->vtotal - native_mode->vdisplay;\r\nunsigned hover = native_mode->hsync_start - native_mode->hdisplay;\r\nunsigned vover = native_mode->vsync_start - native_mode->vdisplay;\r\nunsigned hsync_width = native_mode->hsync_end - native_mode->hsync_start;\r\nunsigned vsync_width = native_mode->vsync_end - native_mode->vsync_start;\r\nadjusted_mode->clock = native_mode->clock;\r\nadjusted_mode->flags = native_mode->flags;\r\nif (ASIC_IS_AVIVO(rdev)) {\r\nadjusted_mode->hdisplay = native_mode->hdisplay;\r\nadjusted_mode->vdisplay = native_mode->vdisplay;\r\n}\r\nadjusted_mode->htotal = native_mode->hdisplay + hblank;\r\nadjusted_mode->hsync_start = native_mode->hdisplay + hover;\r\nadjusted_mode->hsync_end = adjusted_mode->hsync_start + hsync_width;\r\nadjusted_mode->vtotal = native_mode->vdisplay + vblank;\r\nadjusted_mode->vsync_start = native_mode->vdisplay + vover;\r\nadjusted_mode->vsync_end = adjusted_mode->vsync_start + vsync_width;\r\ndrm_mode_set_crtcinfo(adjusted_mode, CRTC_INTERLACE_HALVE_V);\r\nif (ASIC_IS_AVIVO(rdev)) {\r\nadjusted_mode->crtc_hdisplay = native_mode->hdisplay;\r\nadjusted_mode->crtc_vdisplay = native_mode->vdisplay;\r\n}\r\nadjusted_mode->crtc_htotal = adjusted_mode->crtc_hdisplay + hblank;\r\nadjusted_mode->crtc_hsync_start = adjusted_mode->crtc_hdisplay + hover;\r\nadjusted_mode->crtc_hsync_end = adjusted_mode->crtc_hsync_start + hsync_width;\r\nadjusted_mode->crtc_vtotal = adjusted_mode->crtc_vdisplay + vblank;\r\nadjusted_mode->crtc_vsync_start = adjusted_mode->crtc_vdisplay + vover;\r\nadjusted_mode->crtc_vsync_end = adjusted_mode->crtc_vsync_start + vsync_width;\r\n}\r\nbool radeon_dig_monitor_is_duallink(struct drm_encoder *encoder,\r\nu32 pixel_clock)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct drm_connector *connector;\r\nstruct radeon_connector *radeon_connector;\r\nstruct radeon_connector_atom_dig *dig_connector;\r\nconnector = radeon_get_connector_for_encoder(encoder);\r\nif (!connector)\r\nconnector = radeon_get_connector_for_encoder_init(encoder);\r\nradeon_connector = to_radeon_connector(connector);\r\nswitch (connector->connector_type) {\r\ncase DRM_MODE_CONNECTOR_DVII:\r\ncase DRM_MODE_CONNECTOR_HDMIB:\r\nif (radeon_connector->use_digital) {\r\nif (ASIC_IS_DCE6(rdev) && drm_detect_hdmi_monitor(radeon_connector->edid)) {\r\nif (pixel_clock > 340000)\r\nreturn true;\r\nelse\r\nreturn false;\r\n} else {\r\nif (pixel_clock > 165000)\r\nreturn true;\r\nelse\r\nreturn false;\r\n}\r\n} else\r\nreturn false;\r\ncase DRM_MODE_CONNECTOR_DVID:\r\ncase DRM_MODE_CONNECTOR_HDMIA:\r\ncase DRM_MODE_CONNECTOR_DisplayPort:\r\ndig_connector = radeon_connector->con_priv;\r\nif ((dig_connector->dp_sink_type == CONNECTOR_OBJECT_ID_DISPLAYPORT) ||\r\n(dig_connector->dp_sink_type == CONNECTOR_OBJECT_ID_eDP))\r\nreturn false;\r\nelse {\r\nif (ASIC_IS_DCE6(rdev) && drm_detect_hdmi_monitor(radeon_connector->edid)) {\r\nif (pixel_clock > 340000)\r\nreturn true;\r\nelse\r\nreturn false;\r\n} else {\r\nif (pixel_clock > 165000)\r\nreturn true;\r\nelse\r\nreturn false;\r\n}\r\n}\r\ndefault:\r\nreturn false;\r\n}\r\n}

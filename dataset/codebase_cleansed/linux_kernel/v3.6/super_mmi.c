static void qnx6_mmi_copy_sb(struct qnx6_super_block *qsb,\r\nstruct qnx6_mmi_super_block *sb)\r\n{\r\nqsb->sb_magic = sb->sb_magic;\r\nqsb->sb_checksum = sb->sb_checksum;\r\nqsb->sb_serial = sb->sb_serial;\r\nqsb->sb_blocksize = sb->sb_blocksize;\r\nqsb->sb_num_inodes = sb->sb_num_inodes;\r\nqsb->sb_free_inodes = sb->sb_free_inodes;\r\nqsb->sb_num_blocks = sb->sb_num_blocks;\r\nqsb->sb_free_blocks = sb->sb_free_blocks;\r\nmemcpy(&qsb->Inode, &sb->Inode, sizeof(sb->Inode));\r\nmemcpy(&qsb->Bitmap, &sb->Bitmap, sizeof(sb->Bitmap));\r\nmemcpy(&qsb->Longfile, &sb->Longfile, sizeof(sb->Longfile));\r\n}\r\nstruct qnx6_super_block *qnx6_mmi_fill_super(struct super_block *s, int silent)\r\n{\r\nstruct buffer_head *bh1, *bh2 = NULL;\r\nstruct qnx6_mmi_super_block *sb1, *sb2;\r\nstruct qnx6_super_block *qsb = NULL;\r\nstruct qnx6_sb_info *sbi;\r\n__u64 offset;\r\nbh1 = sb_bread(s, 0);\r\nif (!bh1) {\r\nprintk(KERN_ERR "qnx6: Unable to read first mmi superblock\n");\r\nreturn NULL;\r\n}\r\nsb1 = (struct qnx6_mmi_super_block *)bh1->b_data;\r\nsbi = QNX6_SB(s);\r\nif (fs32_to_cpu(sbi, sb1->sb_magic) != QNX6_SUPER_MAGIC) {\r\nif (!silent) {\r\nprintk(KERN_ERR "qnx6: wrong signature (magic) in"\r\n" superblock #1.\n");\r\ngoto out;\r\n}\r\n}\r\nif (fs32_to_cpu(sbi, sb1->sb_checksum) !=\r\ncrc32_be(0, (char *)(bh1->b_data + 8), 504)) {\r\nprintk(KERN_ERR "qnx6: superblock #1 checksum error\n");\r\ngoto out;\r\n}\r\noffset = fs32_to_cpu(sbi, sb1->sb_num_blocks) + QNX6_SUPERBLOCK_AREA /\r\nfs32_to_cpu(sbi, sb1->sb_blocksize);\r\nif (!sb_set_blocksize(s, fs32_to_cpu(sbi, sb1->sb_blocksize))) {\r\nprintk(KERN_ERR "qnx6: unable to set blocksize\n");\r\ngoto out;\r\n}\r\nbrelse(bh1);\r\nbh1 = sb_bread(s, 0);\r\nif (!bh1)\r\ngoto out;\r\nsb1 = (struct qnx6_mmi_super_block *)bh1->b_data;\r\nbh2 = sb_bread(s, offset);\r\nif (!bh2) {\r\nprintk(KERN_ERR "qnx6: unable to read the second superblock\n");\r\ngoto out;\r\n}\r\nsb2 = (struct qnx6_mmi_super_block *)bh2->b_data;\r\nif (fs32_to_cpu(sbi, sb2->sb_magic) != QNX6_SUPER_MAGIC) {\r\nif (!silent)\r\nprintk(KERN_ERR "qnx6: wrong signature (magic) in"\r\n" superblock #2.\n");\r\ngoto out;\r\n}\r\nif (fs32_to_cpu(sbi, sb2->sb_checksum)\r\n!= crc32_be(0, (char *)(bh2->b_data + 8), 504)) {\r\nprintk(KERN_ERR "qnx6: superblock #1 checksum error\n");\r\ngoto out;\r\n}\r\nqsb = kmalloc(sizeof(*qsb), GFP_KERNEL);\r\nif (!qsb) {\r\nprintk(KERN_ERR "qnx6: unable to allocate memory.\n");\r\ngoto out;\r\n}\r\nif (fs64_to_cpu(sbi, sb1->sb_serial) >\r\nfs64_to_cpu(sbi, sb2->sb_serial)) {\r\nqnx6_mmi_copy_sb(qsb, sb1);\r\n#ifdef CONFIG_QNX6FS_DEBUG\r\nqnx6_superblock_debug(qsb, s);\r\n#endif\r\nmemcpy(bh1->b_data, qsb, sizeof(struct qnx6_super_block));\r\nsbi->sb_buf = bh1;\r\nsbi->sb = (struct qnx6_super_block *)bh1->b_data;\r\nbrelse(bh2);\r\nprintk(KERN_INFO "qnx6: superblock #1 active\n");\r\n} else {\r\nqnx6_mmi_copy_sb(qsb, sb2);\r\n#ifdef CONFIG_QNX6FS_DEBUG\r\nqnx6_superblock_debug(qsb, s);\r\n#endif\r\nmemcpy(bh2->b_data, qsb, sizeof(struct qnx6_super_block));\r\nsbi->sb_buf = bh2;\r\nsbi->sb = (struct qnx6_super_block *)bh2->b_data;\r\nbrelse(bh1);\r\nprintk(KERN_INFO "qnx6: superblock #2 active\n");\r\n}\r\nkfree(qsb);\r\nsbi->s_blks_off = QNX6_SUPERBLOCK_AREA / s->s_blocksize;\r\nreturn sbi->sb;\r\nout:\r\nif (bh1 != NULL)\r\nbrelse(bh1);\r\nif (bh2 != NULL)\r\nbrelse(bh2);\r\nreturn NULL;\r\n}

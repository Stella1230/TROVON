static void intel_chipset_set_brightness(int intensity)\r\n{\r\noutb(0x04 | (intensity << 4), 0xb3);\r\noutb(0xbf, 0xb2);\r\n}\r\nstatic int intel_chipset_send_intensity(struct backlight_device *bd)\r\n{\r\nint intensity = bd->props.brightness;\r\nif (debug)\r\npr_debug("setting brightness to %d\n", intensity);\r\nintel_chipset_set_brightness(intensity);\r\nreturn 0;\r\n}\r\nstatic int intel_chipset_get_intensity(struct backlight_device *bd)\r\n{\r\nint intensity;\r\noutb(0x03, 0xb3);\r\noutb(0xbf, 0xb2);\r\nintensity = inb(0xb3) >> 4;\r\nif (debug)\r\npr_debug("read brightness of %d\n", intensity);\r\nreturn intensity;\r\n}\r\nstatic void nvidia_chipset_set_brightness(int intensity)\r\n{\r\noutb(0x04 | (intensity << 4), 0x52f);\r\noutb(0xbf, 0x52e);\r\n}\r\nstatic int nvidia_chipset_send_intensity(struct backlight_device *bd)\r\n{\r\nint intensity = bd->props.brightness;\r\nif (debug)\r\npr_debug("setting brightness to %d\n", intensity);\r\nnvidia_chipset_set_brightness(intensity);\r\nreturn 0;\r\n}\r\nstatic int nvidia_chipset_get_intensity(struct backlight_device *bd)\r\n{\r\nint intensity;\r\noutb(0x03, 0x52f);\r\noutb(0xbf, 0x52e);\r\nintensity = inb(0x52f) >> 4;\r\nif (debug)\r\npr_debug("read brightness of %d\n", intensity);\r\nreturn intensity;\r\n}\r\nstatic int __devinit apple_bl_add(struct acpi_device *dev)\r\n{\r\nstruct backlight_properties props;\r\nstruct pci_dev *host;\r\nint intensity;\r\nhost = pci_get_bus_and_slot(0, 0);\r\nif (!host) {\r\npr_err("unable to find PCI host\n");\r\nreturn -ENODEV;\r\n}\r\nif (host->vendor == PCI_VENDOR_ID_INTEL)\r\nhw_data = &intel_chipset_data;\r\nelse if (host->vendor == PCI_VENDOR_ID_NVIDIA)\r\nhw_data = &nvidia_chipset_data;\r\npci_dev_put(host);\r\nif (!hw_data) {\r\npr_err("unknown hardware\n");\r\nreturn -ENODEV;\r\n}\r\nintensity = hw_data->backlight_ops.get_brightness(NULL);\r\nif (!intensity) {\r\nhw_data->set_brightness(1);\r\nif (!hw_data->backlight_ops.get_brightness(NULL))\r\nreturn -ENODEV;\r\nhw_data->set_brightness(0);\r\n}\r\nif (!request_region(hw_data->iostart, hw_data->iolen,\r\n"Apple backlight"))\r\nreturn -ENXIO;\r\nmemset(&props, 0, sizeof(struct backlight_properties));\r\nprops.type = BACKLIGHT_PLATFORM;\r\nprops.max_brightness = 15;\r\napple_backlight_device = backlight_device_register("apple_backlight",\r\nNULL, NULL, &hw_data->backlight_ops, &props);\r\nif (IS_ERR(apple_backlight_device)) {\r\nrelease_region(hw_data->iostart, hw_data->iolen);\r\nreturn PTR_ERR(apple_backlight_device);\r\n}\r\napple_backlight_device->props.brightness =\r\nhw_data->backlight_ops.get_brightness(apple_backlight_device);\r\nbacklight_update_status(apple_backlight_device);\r\nreturn 0;\r\n}\r\nstatic int __devexit apple_bl_remove(struct acpi_device *dev, int type)\r\n{\r\nbacklight_device_unregister(apple_backlight_device);\r\nrelease_region(hw_data->iostart, hw_data->iolen);\r\nhw_data = NULL;\r\nreturn 0;\r\n}\r\nint apple_bl_register(void)\r\n{\r\nif (atomic_xchg(&apple_bl_registered, 1) == 0)\r\nreturn acpi_bus_register_driver(&apple_bl_driver);\r\nreturn 0;\r\n}\r\nvoid apple_bl_unregister(void)\r\n{\r\nif (atomic_xchg(&apple_bl_registered, 0) == 1)\r\nacpi_bus_unregister_driver(&apple_bl_driver);\r\n}\r\nstatic int __init apple_bl_init(void)\r\n{\r\nreturn apple_bl_register();\r\n}\r\nstatic void __exit apple_bl_exit(void)\r\n{\r\napple_bl_unregister();\r\n}

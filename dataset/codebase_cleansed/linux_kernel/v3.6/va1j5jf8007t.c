static int va1j5jf8007t_read_snr(struct dvb_frontend *fe, u16 *snr)\r\n{\r\nstruct va1j5jf8007t_state *state;\r\nu8 addr;\r\nint i;\r\nu8 write_buf[1], read_buf[1];\r\nstruct i2c_msg msgs[2];\r\ns32 word, x, y;\r\nstate = fe->demodulator_priv;\r\naddr = state->config->demod_address;\r\nword = 0;\r\nfor (i = 0; i < 3; i++) {\r\nwrite_buf[0] = 0x8b + i;\r\nmsgs[0].addr = addr;\r\nmsgs[0].flags = 0;\r\nmsgs[0].len = sizeof(write_buf);\r\nmsgs[0].buf = write_buf;\r\nmsgs[1].addr = addr;\r\nmsgs[1].flags = I2C_M_RD;\r\nmsgs[1].len = sizeof(read_buf);\r\nmsgs[1].buf = read_buf;\r\nif (i2c_transfer(state->adap, msgs, 2) != 2)\r\nreturn -EREMOTEIO;\r\nword <<= 8;\r\nword |= read_buf[0];\r\n}\r\nif (!word)\r\nreturn -EIO;\r\nx = 10 * (intlog10(0x540000 * 100 / word) - (2 << 24));\r\ny = (24ll << 46) / 1000000;\r\ny = ((s64)y * x >> 30) - (16ll << 40) / 10000;\r\ny = ((s64)y * x >> 29) + (398ll << 35) / 10000;\r\ny = ((s64)y * x >> 30) + (5491ll << 29) / 10000;\r\ny = ((s64)y * x >> 30) + (30965ll << 23) / 10000;\r\n*snr = y >> 15;\r\nreturn 0;\r\n}\r\nstatic int va1j5jf8007t_get_frontend_algo(struct dvb_frontend *fe)\r\n{\r\nreturn DVBFE_ALGO_HW;\r\n}\r\nstatic int\r\nva1j5jf8007t_read_status(struct dvb_frontend *fe, fe_status_t *status)\r\n{\r\nstruct va1j5jf8007t_state *state;\r\nstate = fe->demodulator_priv;\r\nswitch (state->tune_state) {\r\ncase VA1J5JF8007T_IDLE:\r\ncase VA1J5JF8007T_SET_FREQUENCY:\r\ncase VA1J5JF8007T_CHECK_FREQUENCY:\r\n*status = 0;\r\nreturn 0;\r\ncase VA1J5JF8007T_SET_MODULATION:\r\ncase VA1J5JF8007T_CHECK_MODULATION:\r\ncase VA1J5JF8007T_ABORT:\r\n*status |= FE_HAS_SIGNAL;\r\nreturn 0;\r\ncase VA1J5JF8007T_TRACK:\r\n*status |= FE_HAS_SIGNAL | FE_HAS_CARRIER | FE_HAS_LOCK;\r\nreturn 0;\r\n}\r\nBUG();\r\n}\r\nstatic u8 va1j5jf8007t_lookup_cb(u32 frequency)\r\n{\r\nint i;\r\nconst struct va1j5jf8007t_cb_map *map;\r\nfor (i = 0; i < ARRAY_SIZE(va1j5jf8007t_cb_maps); i++) {\r\nmap = &va1j5jf8007t_cb_maps[i];\r\nif (frequency < map->frequency)\r\nreturn map->cb;\r\n}\r\nreturn 0xe4;\r\n}\r\nstatic int va1j5jf8007t_set_frequency(struct va1j5jf8007t_state *state)\r\n{\r\nu32 frequency;\r\nu16 word;\r\nu8 buf[6];\r\nstruct i2c_msg msg;\r\nfrequency = state->fe.dtv_property_cache.frequency;\r\nword = (frequency + 71428) / 142857 + 399;\r\nbuf[0] = 0xfe;\r\nbuf[1] = 0xc2;\r\nbuf[2] = word >> 8;\r\nbuf[3] = word;\r\nbuf[4] = 0x80;\r\nbuf[5] = va1j5jf8007t_lookup_cb(frequency);\r\nmsg.addr = state->config->demod_address;\r\nmsg.flags = 0;\r\nmsg.len = sizeof(buf);\r\nmsg.buf = buf;\r\nif (i2c_transfer(state->adap, &msg, 1) != 1)\r\nreturn -EREMOTEIO;\r\nreturn 0;\r\n}\r\nstatic int\r\nva1j5jf8007t_check_frequency(struct va1j5jf8007t_state *state, int *lock)\r\n{\r\nu8 addr;\r\nu8 write_buf[2], read_buf[1];\r\nstruct i2c_msg msgs[2];\r\naddr = state->config->demod_address;\r\nwrite_buf[0] = 0xfe;\r\nwrite_buf[1] = 0xc3;\r\nmsgs[0].addr = addr;\r\nmsgs[0].flags = 0;\r\nmsgs[0].len = sizeof(write_buf);\r\nmsgs[0].buf = write_buf;\r\nmsgs[1].addr = addr;\r\nmsgs[1].flags = I2C_M_RD;\r\nmsgs[1].len = sizeof(read_buf);\r\nmsgs[1].buf = read_buf;\r\nif (i2c_transfer(state->adap, msgs, 2) != 2)\r\nreturn -EREMOTEIO;\r\n*lock = read_buf[0] & 0x40;\r\nreturn 0;\r\n}\r\nstatic int va1j5jf8007t_set_modulation(struct va1j5jf8007t_state *state)\r\n{\r\nu8 buf[2];\r\nstruct i2c_msg msg;\r\nbuf[0] = 0x01;\r\nbuf[1] = 0x40;\r\nmsg.addr = state->config->demod_address;\r\nmsg.flags = 0;\r\nmsg.len = sizeof(buf);\r\nmsg.buf = buf;\r\nif (i2c_transfer(state->adap, &msg, 1) != 1)\r\nreturn -EREMOTEIO;\r\nreturn 0;\r\n}\r\nstatic int va1j5jf8007t_check_modulation(struct va1j5jf8007t_state *state,\r\nint *lock, int *retry)\r\n{\r\nu8 addr;\r\nu8 write_buf[1], read_buf[1];\r\nstruct i2c_msg msgs[2];\r\naddr = state->config->demod_address;\r\nwrite_buf[0] = 0x80;\r\nmsgs[0].addr = addr;\r\nmsgs[0].flags = 0;\r\nmsgs[0].len = sizeof(write_buf);\r\nmsgs[0].buf = write_buf;\r\nmsgs[1].addr = addr;\r\nmsgs[1].flags = I2C_M_RD;\r\nmsgs[1].len = sizeof(read_buf);\r\nmsgs[1].buf = read_buf;\r\nif (i2c_transfer(state->adap, msgs, 2) != 2)\r\nreturn -EREMOTEIO;\r\n*lock = !(read_buf[0] & 0x10);\r\n*retry = read_buf[0] & 0x80;\r\nreturn 0;\r\n}\r\nstatic int\r\nva1j5jf8007t_tune(struct dvb_frontend *fe,\r\nbool re_tune,\r\nunsigned int mode_flags, unsigned int *delay,\r\nfe_status_t *status)\r\n{\r\nstruct va1j5jf8007t_state *state;\r\nint ret;\r\nint lock = 0, retry = 0;\r\nstate = fe->demodulator_priv;\r\nif (re_tune)\r\nstate->tune_state = VA1J5JF8007T_SET_FREQUENCY;\r\nswitch (state->tune_state) {\r\ncase VA1J5JF8007T_IDLE:\r\n*delay = 3 * HZ;\r\n*status = 0;\r\nreturn 0;\r\ncase VA1J5JF8007T_SET_FREQUENCY:\r\nret = va1j5jf8007t_set_frequency(state);\r\nif (ret < 0)\r\nreturn ret;\r\nstate->tune_state = VA1J5JF8007T_CHECK_FREQUENCY;\r\n*delay = 0;\r\n*status = 0;\r\nreturn 0;\r\ncase VA1J5JF8007T_CHECK_FREQUENCY:\r\nret = va1j5jf8007t_check_frequency(state, &lock);\r\nif (ret < 0)\r\nreturn ret;\r\nif (!lock) {\r\n*delay = (HZ + 999) / 1000;\r\n*status = 0;\r\nreturn 0;\r\n}\r\nstate->tune_state = VA1J5JF8007T_SET_MODULATION;\r\n*delay = 0;\r\n*status = FE_HAS_SIGNAL;\r\nreturn 0;\r\ncase VA1J5JF8007T_SET_MODULATION:\r\nret = va1j5jf8007t_set_modulation(state);\r\nif (ret < 0)\r\nreturn ret;\r\nstate->tune_state = VA1J5JF8007T_CHECK_MODULATION;\r\n*delay = 0;\r\n*status = FE_HAS_SIGNAL;\r\nreturn 0;\r\ncase VA1J5JF8007T_CHECK_MODULATION:\r\nret = va1j5jf8007t_check_modulation(state, &lock, &retry);\r\nif (ret < 0)\r\nreturn ret;\r\nif (!lock) {\r\nif (!retry) {\r\nstate->tune_state = VA1J5JF8007T_ABORT;\r\n*delay = 3 * HZ;\r\n*status = FE_HAS_SIGNAL;\r\nreturn 0;\r\n}\r\n*delay = (HZ + 999) / 1000;\r\n*status = FE_HAS_SIGNAL;\r\nreturn 0;\r\n}\r\nstate->tune_state = VA1J5JF8007T_TRACK;\r\ncase VA1J5JF8007T_TRACK:\r\n*delay = 3 * HZ;\r\n*status = FE_HAS_SIGNAL | FE_HAS_CARRIER | FE_HAS_LOCK;\r\nreturn 0;\r\ncase VA1J5JF8007T_ABORT:\r\n*delay = 3 * HZ;\r\n*status = FE_HAS_SIGNAL;\r\nreturn 0;\r\n}\r\nBUG();\r\n}\r\nstatic int va1j5jf8007t_init_frequency(struct va1j5jf8007t_state *state)\r\n{\r\nu8 buf[7];\r\nstruct i2c_msg msg;\r\nbuf[0] = 0xfe;\r\nbuf[1] = 0xc2;\r\nbuf[2] = 0x01;\r\nbuf[3] = 0x8f;\r\nbuf[4] = 0xc1;\r\nbuf[5] = 0x80;\r\nbuf[6] = 0x80;\r\nmsg.addr = state->config->demod_address;\r\nmsg.flags = 0;\r\nmsg.len = sizeof(buf);\r\nmsg.buf = buf;\r\nif (i2c_transfer(state->adap, &msg, 1) != 1)\r\nreturn -EREMOTEIO;\r\nreturn 0;\r\n}\r\nstatic int va1j5jf8007t_set_sleep(struct va1j5jf8007t_state *state, int sleep)\r\n{\r\nu8 buf[2];\r\nstruct i2c_msg msg;\r\nbuf[0] = 0x03;\r\nbuf[1] = sleep ? 0x90 : 0x80;\r\nmsg.addr = state->config->demod_address;\r\nmsg.flags = 0;\r\nmsg.len = sizeof(buf);\r\nmsg.buf = buf;\r\nif (i2c_transfer(state->adap, &msg, 1) != 1)\r\nreturn -EREMOTEIO;\r\nreturn 0;\r\n}\r\nstatic int va1j5jf8007t_sleep(struct dvb_frontend *fe)\r\n{\r\nstruct va1j5jf8007t_state *state;\r\nint ret;\r\nstate = fe->demodulator_priv;\r\nret = va1j5jf8007t_init_frequency(state);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn va1j5jf8007t_set_sleep(state, 1);\r\n}\r\nstatic int va1j5jf8007t_init(struct dvb_frontend *fe)\r\n{\r\nstruct va1j5jf8007t_state *state;\r\nstate = fe->demodulator_priv;\r\nstate->tune_state = VA1J5JF8007T_IDLE;\r\nreturn va1j5jf8007t_set_sleep(state, 0);\r\n}\r\nstatic void va1j5jf8007t_release(struct dvb_frontend *fe)\r\n{\r\nstruct va1j5jf8007t_state *state;\r\nstate = fe->demodulator_priv;\r\nkfree(state);\r\n}\r\nint va1j5jf8007t_prepare(struct dvb_frontend *fe)\r\n{\r\nstruct va1j5jf8007t_state *state;\r\nconst u8 (*bufs)[2];\r\nint size;\r\nu8 buf[2];\r\nstruct i2c_msg msg;\r\nint i;\r\nstate = fe->demodulator_priv;\r\nswitch (state->config->frequency) {\r\ncase VA1J5JF8007T_20MHZ:\r\nbufs = va1j5jf8007t_20mhz_prepare_bufs;\r\nsize = ARRAY_SIZE(va1j5jf8007t_20mhz_prepare_bufs);\r\nbreak;\r\ncase VA1J5JF8007T_25MHZ:\r\nbufs = va1j5jf8007t_25mhz_prepare_bufs;\r\nsize = ARRAY_SIZE(va1j5jf8007t_25mhz_prepare_bufs);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nmsg.addr = state->config->demod_address;\r\nmsg.flags = 0;\r\nmsg.len = sizeof(buf);\r\nmsg.buf = buf;\r\nfor (i = 0; i < size; i++) {\r\nmemcpy(buf, bufs[i], sizeof(buf));\r\nif (i2c_transfer(state->adap, &msg, 1) != 1)\r\nreturn -EREMOTEIO;\r\n}\r\nreturn va1j5jf8007t_init_frequency(state);\r\n}\r\nstruct dvb_frontend *\r\nva1j5jf8007t_attach(const struct va1j5jf8007t_config *config,\r\nstruct i2c_adapter *adap)\r\n{\r\nstruct va1j5jf8007t_state *state;\r\nstruct dvb_frontend *fe;\r\nu8 buf[2];\r\nstruct i2c_msg msg;\r\nstate = kzalloc(sizeof(struct va1j5jf8007t_state), GFP_KERNEL);\r\nif (!state)\r\nreturn NULL;\r\nstate->config = config;\r\nstate->adap = adap;\r\nfe = &state->fe;\r\nmemcpy(&fe->ops, &va1j5jf8007t_ops, sizeof(struct dvb_frontend_ops));\r\nfe->demodulator_priv = state;\r\nbuf[0] = 0x01;\r\nbuf[1] = 0x80;\r\nmsg.addr = state->config->demod_address;\r\nmsg.flags = 0;\r\nmsg.len = sizeof(buf);\r\nmsg.buf = buf;\r\nif (i2c_transfer(state->adap, &msg, 1) != 1) {\r\nkfree(state);\r\nreturn NULL;\r\n}\r\nreturn fe;\r\n}

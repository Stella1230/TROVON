static void ath5k_ahb_read_cachesize(struct ath_common *common, int *csz)\r\n{\r\n*csz = L1_CACHE_BYTES >> 2;\r\n}\r\nstatic bool\r\nath5k_ahb_eeprom_read(struct ath_common *common, u32 off, u16 *data)\r\n{\r\nstruct ath5k_hw *ah = common->priv;\r\nstruct platform_device *pdev = to_platform_device(ah->dev);\r\nstruct ar231x_board_config *bcfg = pdev->dev.platform_data;\r\nu16 *eeprom, *eeprom_end;\r\nbcfg = pdev->dev.platform_data;\r\neeprom = (u16 *) bcfg->radio;\r\neeprom_end = ((void *) bcfg->config) + BOARD_CONFIG_BUFSZ;\r\neeprom += off;\r\nif (eeprom > eeprom_end)\r\nreturn false;\r\n*data = *eeprom;\r\nreturn true;\r\n}\r\nint ath5k_hw_read_srev(struct ath5k_hw *ah)\r\n{\r\nstruct platform_device *pdev = to_platform_device(ah->dev);\r\nstruct ar231x_board_config *bcfg = pdev->dev.platform_data;\r\nah->ah_mac_srev = bcfg->devid;\r\nreturn 0;\r\n}\r\nstatic int ath5k_ahb_eeprom_read_mac(struct ath5k_hw *ah, u8 *mac)\r\n{\r\nstruct platform_device *pdev = to_platform_device(ah->dev);\r\nstruct ar231x_board_config *bcfg = pdev->dev.platform_data;\r\nu8 *cfg_mac;\r\nif (to_platform_device(ah->dev)->id == 0)\r\ncfg_mac = bcfg->config->wlan0_mac;\r\nelse\r\ncfg_mac = bcfg->config->wlan1_mac;\r\nmemcpy(mac, cfg_mac, ETH_ALEN);\r\nreturn 0;\r\n}\r\nstatic int ath_ahb_probe(struct platform_device *pdev)\r\n{\r\nstruct ar231x_board_config *bcfg = pdev->dev.platform_data;\r\nstruct ath5k_hw *ah;\r\nstruct ieee80211_hw *hw;\r\nstruct resource *res;\r\nvoid __iomem *mem;\r\nint irq;\r\nint ret = 0;\r\nu32 reg;\r\nif (!pdev->dev.platform_data) {\r\ndev_err(&pdev->dev, "no platform data specified\n");\r\nret = -EINVAL;\r\ngoto err_out;\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (res == NULL) {\r\ndev_err(&pdev->dev, "no memory resource found\n");\r\nret = -ENXIO;\r\ngoto err_out;\r\n}\r\nmem = ioremap_nocache(res->start, resource_size(res));\r\nif (mem == NULL) {\r\ndev_err(&pdev->dev, "ioremap failed\n");\r\nret = -ENOMEM;\r\ngoto err_out;\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_IRQ, 0);\r\nif (res == NULL) {\r\ndev_err(&pdev->dev, "no IRQ resource found\n");\r\nret = -ENXIO;\r\ngoto err_iounmap;\r\n}\r\nirq = res->start;\r\nhw = ieee80211_alloc_hw(sizeof(struct ath5k_hw), &ath5k_hw_ops);\r\nif (hw == NULL) {\r\ndev_err(&pdev->dev, "no memory for ieee80211_hw\n");\r\nret = -ENOMEM;\r\ngoto err_iounmap;\r\n}\r\nah = hw->priv;\r\nah->hw = hw;\r\nah->dev = &pdev->dev;\r\nah->iobase = mem;\r\nah->irq = irq;\r\nah->devid = bcfg->devid;\r\nif (bcfg->devid >= AR5K_SREV_AR2315_R6) {\r\nreg = ioread32((void __iomem *) AR5K_AR2315_AHB_ARB_CTL);\r\nreg |= AR5K_AR2315_AHB_ARB_CTL_WLAN;\r\niowrite32(reg, (void __iomem *) AR5K_AR2315_AHB_ARB_CTL);\r\nreg = ioread32((void __iomem *) AR5K_AR2315_BYTESWAP);\r\nreg |= AR5K_AR2315_BYTESWAP_WMAC;\r\niowrite32(reg, (void __iomem *) AR5K_AR2315_BYTESWAP);\r\n} else {\r\nreg = ioread32((void __iomem *) AR5K_AR5312_ENABLE);\r\nif (to_platform_device(ah->dev)->id == 0)\r\nreg |= AR5K_AR5312_ENABLE_WLAN0;\r\nelse\r\nreg |= AR5K_AR5312_ENABLE_WLAN1;\r\niowrite32(reg, (void __iomem *) AR5K_AR5312_ENABLE);\r\nif (to_platform_device(ah->dev)->id == 0 &&\r\n(bcfg->config->flags & (BD_WLAN0 | BD_WLAN1)) ==\r\n(BD_WLAN1 | BD_WLAN0))\r\nah->ah_capabilities.cap_needs_2GHz_ovr = true;\r\nelse\r\nah->ah_capabilities.cap_needs_2GHz_ovr = false;\r\n}\r\nret = ath5k_init_ah(ah, &ath_ahb_bus_ops);\r\nif (ret != 0) {\r\ndev_err(&pdev->dev, "failed to attach device, err=%d\n", ret);\r\nret = -ENODEV;\r\ngoto err_free_hw;\r\n}\r\nplatform_set_drvdata(pdev, hw);\r\nreturn 0;\r\nerr_free_hw:\r\nieee80211_free_hw(hw);\r\nplatform_set_drvdata(pdev, NULL);\r\nerr_iounmap:\r\niounmap(mem);\r\nerr_out:\r\nreturn ret;\r\n}\r\nstatic int ath_ahb_remove(struct platform_device *pdev)\r\n{\r\nstruct ar231x_board_config *bcfg = pdev->dev.platform_data;\r\nstruct ieee80211_hw *hw = platform_get_drvdata(pdev);\r\nstruct ath5k_hw *ah;\r\nu32 reg;\r\nif (!hw)\r\nreturn 0;\r\nah = hw->priv;\r\nif (bcfg->devid >= AR5K_SREV_AR2315_R6) {\r\nreg = ioread32((void __iomem *) AR5K_AR2315_AHB_ARB_CTL);\r\nreg &= ~AR5K_AR2315_AHB_ARB_CTL_WLAN;\r\niowrite32(reg, (void __iomem *) AR5K_AR2315_AHB_ARB_CTL);\r\n} else {\r\nreg = ioread32((void __iomem *) AR5K_AR5312_ENABLE);\r\nif (to_platform_device(ah->dev)->id == 0)\r\nreg &= ~AR5K_AR5312_ENABLE_WLAN0;\r\nelse\r\nreg &= ~AR5K_AR5312_ENABLE_WLAN1;\r\niowrite32(reg, (void __iomem *) AR5K_AR5312_ENABLE);\r\n}\r\nath5k_deinit_ah(ah);\r\niounmap(ah->iobase);\r\nplatform_set_drvdata(pdev, NULL);\r\nieee80211_free_hw(hw);\r\nreturn 0;\r\n}\r\nstatic int __init\r\nath5k_ahb_init(void)\r\n{\r\nreturn platform_driver_register(&ath_ahb_driver);\r\n}\r\nstatic void __exit\r\nath5k_ahb_exit(void)\r\n{\r\nplatform_driver_unregister(&ath_ahb_driver);\r\n}

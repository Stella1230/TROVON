static char *acpi_ex_allocate_name_string(u32 prefix_count, u32 num_name_segs)\r\n{\r\nchar *temp_ptr;\r\nchar *name_string;\r\nu32 size_needed;\r\nACPI_FUNCTION_TRACE(ex_allocate_name_string);\r\nif (prefix_count == ACPI_UINT32_MAX) {\r\nsize_needed = 1 + (ACPI_NAME_SIZE * num_name_segs) + 2 + 1;\r\n} else {\r\nsize_needed =\r\nprefix_count + (ACPI_NAME_SIZE * num_name_segs) + 2 + 1;\r\n}\r\nname_string = ACPI_ALLOCATE(size_needed);\r\nif (!name_string) {\r\nACPI_ERROR((AE_INFO,\r\n"Could not allocate size %u", size_needed));\r\nreturn_PTR(NULL);\r\n}\r\ntemp_ptr = name_string;\r\nif (prefix_count == ACPI_UINT32_MAX) {\r\n*temp_ptr++ = AML_ROOT_PREFIX;\r\n} else {\r\nwhile (prefix_count--) {\r\n*temp_ptr++ = AML_PARENT_PREFIX;\r\n}\r\n}\r\nif (num_name_segs > 2) {\r\n*temp_ptr++ = AML_MULTI_NAME_PREFIX_OP;\r\n*temp_ptr++ = (char)num_name_segs;\r\n} else if (2 == num_name_segs) {\r\n*temp_ptr++ = AML_DUAL_NAME_PREFIX;\r\n}\r\n*temp_ptr = 0;\r\nreturn_PTR(name_string);\r\n}\r\nstatic acpi_status acpi_ex_name_segment(u8 ** in_aml_address, char *name_string)\r\n{\r\nchar *aml_address = (void *)*in_aml_address;\r\nacpi_status status = AE_OK;\r\nu32 index;\r\nchar char_buf[5];\r\nACPI_FUNCTION_TRACE(ex_name_segment);\r\nchar_buf[0] = *aml_address;\r\nif ('0' <= char_buf[0] && char_buf[0] <= '9') {\r\nACPI_ERROR((AE_INFO, "Invalid leading digit: %c", char_buf[0]));\r\nreturn_ACPI_STATUS(AE_CTRL_PENDING);\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_LOAD, "Bytes from stream:\n"));\r\nfor (index = 0; (index < ACPI_NAME_SIZE)\r\n&& (acpi_ut_valid_acpi_char(*aml_address, 0)); index++) {\r\nchar_buf[index] = *aml_address++;\r\nACPI_DEBUG_PRINT((ACPI_DB_LOAD, "%c\n", char_buf[index]));\r\n}\r\nif (index == 4) {\r\nchar_buf[4] = '\0';\r\nif (name_string) {\r\nACPI_STRCAT(name_string, char_buf);\r\nACPI_DEBUG_PRINT((ACPI_DB_NAMES,\r\n"Appended to - %s\n", name_string));\r\n} else {\r\nACPI_DEBUG_PRINT((ACPI_DB_NAMES,\r\n"No Name string - %s\n", char_buf));\r\n}\r\n} else if (index == 0) {\r\nACPI_DEBUG_PRINT((ACPI_DB_INFO,\r\n"Leading character is not alpha: %02Xh (not a name)\n",\r\nchar_buf[0]));\r\nstatus = AE_CTRL_PENDING;\r\n} else {\r\nstatus = AE_AML_BAD_NAME;\r\nACPI_ERROR((AE_INFO,\r\n"Bad character 0x%02x in name, at %p",\r\n*aml_address, aml_address));\r\n}\r\n*in_aml_address = ACPI_CAST_PTR(u8, aml_address);\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status\r\nacpi_ex_get_name_string(acpi_object_type data_type,\r\nu8 * in_aml_address,\r\nchar **out_name_string, u32 * out_name_length)\r\n{\r\nacpi_status status = AE_OK;\r\nu8 *aml_address = in_aml_address;\r\nchar *name_string = NULL;\r\nu32 num_segments;\r\nu32 prefix_count = 0;\r\nu8 has_prefix = FALSE;\r\nACPI_FUNCTION_TRACE_PTR(ex_get_name_string, aml_address);\r\nif (ACPI_TYPE_LOCAL_REGION_FIELD == data_type ||\r\nACPI_TYPE_LOCAL_BANK_FIELD == data_type ||\r\nACPI_TYPE_LOCAL_INDEX_FIELD == data_type) {\r\nname_string = acpi_ex_allocate_name_string(0, 1);\r\nif (!name_string) {\r\nstatus = AE_NO_MEMORY;\r\n} else {\r\nstatus =\r\nacpi_ex_name_segment(&aml_address, name_string);\r\n}\r\n} else {\r\nswitch (*aml_address) {\r\ncase AML_ROOT_PREFIX:\r\nACPI_DEBUG_PRINT((ACPI_DB_LOAD,\r\n"RootPrefix(\\) at %p\n",\r\naml_address));\r\naml_address++;\r\nprefix_count = ACPI_UINT32_MAX;\r\nhas_prefix = TRUE;\r\nbreak;\r\ncase AML_PARENT_PREFIX:\r\ndo {\r\nACPI_DEBUG_PRINT((ACPI_DB_LOAD,\r\n"ParentPrefix (^) at %p\n",\r\naml_address));\r\naml_address++;\r\nprefix_count++;\r\n} while (*aml_address == AML_PARENT_PREFIX);\r\nhas_prefix = TRUE;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nswitch (*aml_address) {\r\ncase AML_DUAL_NAME_PREFIX:\r\nACPI_DEBUG_PRINT((ACPI_DB_LOAD,\r\n"DualNamePrefix at %p\n",\r\naml_address));\r\naml_address++;\r\nname_string =\r\nacpi_ex_allocate_name_string(prefix_count, 2);\r\nif (!name_string) {\r\nstatus = AE_NO_MEMORY;\r\nbreak;\r\n}\r\nhas_prefix = TRUE;\r\nstatus =\r\nacpi_ex_name_segment(&aml_address, name_string);\r\nif (ACPI_SUCCESS(status)) {\r\nstatus =\r\nacpi_ex_name_segment(&aml_address,\r\nname_string);\r\n}\r\nbreak;\r\ncase AML_MULTI_NAME_PREFIX_OP:\r\nACPI_DEBUG_PRINT((ACPI_DB_LOAD,\r\n"MultiNamePrefix at %p\n",\r\naml_address));\r\naml_address++;\r\nnum_segments = *aml_address;\r\nname_string =\r\nacpi_ex_allocate_name_string(prefix_count,\r\nnum_segments);\r\nif (!name_string) {\r\nstatus = AE_NO_MEMORY;\r\nbreak;\r\n}\r\naml_address++;\r\nhas_prefix = TRUE;\r\nwhile (num_segments &&\r\n(status =\r\nacpi_ex_name_segment(&aml_address,\r\nname_string)) == AE_OK) {\r\nnum_segments--;\r\n}\r\nbreak;\r\ncase 0:\r\nif (prefix_count == ACPI_UINT32_MAX) {\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC,\r\n"NameSeg is \"\\\" followed by NULL\n"));\r\n}\r\naml_address++;\r\nname_string =\r\nacpi_ex_allocate_name_string(prefix_count, 0);\r\nif (!name_string) {\r\nstatus = AE_NO_MEMORY;\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\nname_string =\r\nacpi_ex_allocate_name_string(prefix_count, 1);\r\nif (!name_string) {\r\nstatus = AE_NO_MEMORY;\r\nbreak;\r\n}\r\nstatus =\r\nacpi_ex_name_segment(&aml_address, name_string);\r\nbreak;\r\n}\r\n}\r\nif (AE_CTRL_PENDING == status && has_prefix) {\r\nACPI_ERROR((AE_INFO, "Malformed Name at %p", name_string));\r\nstatus = AE_AML_BAD_NAME;\r\n}\r\nif (ACPI_FAILURE(status)) {\r\nif (name_string) {\r\nACPI_FREE(name_string);\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}\r\n*out_name_string = name_string;\r\n*out_name_length = (u32) (aml_address - in_aml_address);\r\nreturn_ACPI_STATUS(status);\r\n}

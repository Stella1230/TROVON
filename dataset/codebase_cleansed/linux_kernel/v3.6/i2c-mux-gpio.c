static void i2c_mux_gpio_set(const struct gpiomux *mux, unsigned val)\r\n{\r\nint i;\r\nfor (i = 0; i < mux->data.n_gpios; i++)\r\ngpio_set_value(mux->data.gpios[i], val & (1 << i));\r\n}\r\nstatic int i2c_mux_gpio_select(struct i2c_adapter *adap, void *data, u32 chan)\r\n{\r\nstruct gpiomux *mux = data;\r\ni2c_mux_gpio_set(mux, mux->data.values[chan]);\r\nreturn 0;\r\n}\r\nstatic int i2c_mux_gpio_deselect(struct i2c_adapter *adap, void *data, u32 chan)\r\n{\r\nstruct gpiomux *mux = data;\r\ni2c_mux_gpio_set(mux, mux->data.idle);\r\nreturn 0;\r\n}\r\nstatic int __devinit i2c_mux_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct gpiomux *mux;\r\nstruct i2c_mux_gpio_platform_data *pdata;\r\nstruct i2c_adapter *parent;\r\nint (*deselect) (struct i2c_adapter *, void *, u32);\r\nunsigned initial_state;\r\nint i, ret;\r\npdata = pdev->dev.platform_data;\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "Missing platform data\n");\r\nreturn -ENODEV;\r\n}\r\nparent = i2c_get_adapter(pdata->parent);\r\nif (!parent) {\r\ndev_err(&pdev->dev, "Parent adapter (%d) not found\n",\r\npdata->parent);\r\nreturn -ENODEV;\r\n}\r\nmux = kzalloc(sizeof(*mux), GFP_KERNEL);\r\nif (!mux) {\r\nret = -ENOMEM;\r\ngoto alloc_failed;\r\n}\r\nmux->parent = parent;\r\nmux->data = *pdata;\r\nmux->adap = kzalloc(sizeof(struct i2c_adapter *) * pdata->n_values,\r\nGFP_KERNEL);\r\nif (!mux->adap) {\r\nret = -ENOMEM;\r\ngoto alloc_failed2;\r\n}\r\nif (pdata->idle != I2C_MUX_GPIO_NO_IDLE) {\r\ninitial_state = pdata->idle;\r\ndeselect = i2c_mux_gpio_deselect;\r\n} else {\r\ninitial_state = pdata->values[0];\r\ndeselect = NULL;\r\n}\r\nfor (i = 0; i < pdata->n_gpios; i++) {\r\nret = gpio_request(pdata->gpios[i], "i2c-mux-gpio");\r\nif (ret)\r\ngoto err_request_gpio;\r\ngpio_direction_output(pdata->gpios[i],\r\ninitial_state & (1 << i));\r\n}\r\nfor (i = 0; i < pdata->n_values; i++) {\r\nu32 nr = pdata->base_nr ? (pdata->base_nr + i) : 0;\r\nmux->adap[i] = i2c_add_mux_adapter(parent, &pdev->dev, mux, nr, i,\r\ni2c_mux_gpio_select, deselect);\r\nif (!mux->adap[i]) {\r\nret = -ENODEV;\r\ndev_err(&pdev->dev, "Failed to add adapter %d\n", i);\r\ngoto add_adapter_failed;\r\n}\r\n}\r\ndev_info(&pdev->dev, "%d port mux on %s adapter\n",\r\npdata->n_values, parent->name);\r\nplatform_set_drvdata(pdev, mux);\r\nreturn 0;\r\nadd_adapter_failed:\r\nfor (; i > 0; i--)\r\ni2c_del_mux_adapter(mux->adap[i - 1]);\r\ni = pdata->n_gpios;\r\nerr_request_gpio:\r\nfor (; i > 0; i--)\r\ngpio_free(pdata->gpios[i - 1]);\r\nkfree(mux->adap);\r\nalloc_failed2:\r\nkfree(mux);\r\nalloc_failed:\r\ni2c_put_adapter(parent);\r\nreturn ret;\r\n}\r\nstatic int __devexit i2c_mux_gpio_remove(struct platform_device *pdev)\r\n{\r\nstruct gpiomux *mux = platform_get_drvdata(pdev);\r\nint i;\r\nfor (i = 0; i < mux->data.n_values; i++)\r\ni2c_del_mux_adapter(mux->adap[i]);\r\nfor (i = 0; i < mux->data.n_gpios; i++)\r\ngpio_free(mux->data.gpios[i]);\r\nplatform_set_drvdata(pdev, NULL);\r\ni2c_put_adapter(mux->parent);\r\nkfree(mux->adap);\r\nkfree(mux);\r\nreturn 0;\r\n}

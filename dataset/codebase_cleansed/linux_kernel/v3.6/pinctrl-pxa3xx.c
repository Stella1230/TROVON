static int pxa3xx_get_groups_count(struct pinctrl_dev *pctrldev)\r\n{\r\nstruct pxa3xx_pinmux_info *info = pinctrl_dev_get_drvdata(pctrldev);\r\nreturn info->num_grps;\r\n}\r\nstatic const char *pxa3xx_get_group_name(struct pinctrl_dev *pctrldev,\r\nunsigned selector)\r\n{\r\nstruct pxa3xx_pinmux_info *info = pinctrl_dev_get_drvdata(pctrldev);\r\nreturn info->grps[selector].name;\r\n}\r\nstatic int pxa3xx_get_group_pins(struct pinctrl_dev *pctrldev,\r\nunsigned selector,\r\nconst unsigned **pins,\r\nunsigned *num_pins)\r\n{\r\nstruct pxa3xx_pinmux_info *info = pinctrl_dev_get_drvdata(pctrldev);\r\n*pins = info->grps[selector].pins;\r\n*num_pins = info->grps[selector].npins;\r\nreturn 0;\r\n}\r\nstatic int pxa3xx_pmx_get_funcs_count(struct pinctrl_dev *pctrldev)\r\n{\r\nstruct pxa3xx_pinmux_info *info = pinctrl_dev_get_drvdata(pctrldev);\r\nreturn info->num_funcs;\r\n}\r\nstatic const char *pxa3xx_pmx_get_func_name(struct pinctrl_dev *pctrldev,\r\nunsigned func)\r\n{\r\nstruct pxa3xx_pinmux_info *info = pinctrl_dev_get_drvdata(pctrldev);\r\nreturn info->funcs[func].name;\r\n}\r\nstatic int pxa3xx_pmx_get_groups(struct pinctrl_dev *pctrldev, unsigned func,\r\nconst char * const **groups,\r\nunsigned * const num_groups)\r\n{\r\nstruct pxa3xx_pinmux_info *info = pinctrl_dev_get_drvdata(pctrldev);\r\n*groups = info->funcs[func].groups;\r\n*num_groups = info->funcs[func].num_groups;\r\nreturn 0;\r\n}\r\nstatic int match_mux(struct pxa3xx_mfp_pin *mfp, unsigned mux)\r\n{\r\nint i;\r\nfor (i = 0; i < PXA3xx_MAX_MUX; i++) {\r\nif (mfp->func[i] == mux)\r\nbreak;\r\n}\r\nif (i >= PXA3xx_MAX_MUX)\r\nreturn -EINVAL;\r\nreturn i;\r\n}\r\nstatic int match_group_mux(struct pxa3xx_pin_group *grp,\r\nstruct pxa3xx_pinmux_info *info,\r\nunsigned mux)\r\n{\r\nint i, pin, ret = 0;\r\nfor (i = 0; i < grp->npins; i++) {\r\npin = grp->pins[i];\r\nret = match_mux(&info->mfp[pin], mux);\r\nif (ret < 0) {\r\ndev_err(info->dev, "Can't find mux %d on pin%d\n",\r\nmux, pin);\r\nbreak;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic int pxa3xx_pmx_enable(struct pinctrl_dev *pctrldev, unsigned func,\r\nunsigned group)\r\n{\r\nstruct pxa3xx_pinmux_info *info = pinctrl_dev_get_drvdata(pctrldev);\r\nstruct pxa3xx_pin_group *pin_grp = &info->grps[group];\r\nunsigned int data;\r\nint i, mfpr, pin, pin_func;\r\nif (!pin_grp->npins ||\r\n(match_group_mux(pin_grp, info, pin_grp->mux) < 0)) {\r\ndev_err(info->dev, "Failed to set the pin group: %d\n", group);\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; i < pin_grp->npins; i++) {\r\npin = pin_grp->pins[i];\r\npin_func = match_mux(&info->mfp[pin], pin_grp->mux);\r\nmfpr = info->mfp[pin].mfpr;\r\ndata = readl_relaxed(info->virt_base + mfpr);\r\ndata &= ~MFPR_FUNC_MASK;\r\ndata |= pin_func;\r\nwritel_relaxed(data, info->virt_base + mfpr);\r\n}\r\nreturn 0;\r\n}\r\nstatic int pxa3xx_pmx_request_gpio(struct pinctrl_dev *pctrldev,\r\nstruct pinctrl_gpio_range *range,\r\nunsigned pin)\r\n{\r\nstruct pxa3xx_pinmux_info *info = pinctrl_dev_get_drvdata(pctrldev);\r\nunsigned int data;\r\nint pin_func, mfpr;\r\npin_func = match_mux(&info->mfp[pin], PXA3xx_MUX_GPIO);\r\nif (pin_func < 0) {\r\ndev_err(info->dev, "No GPIO function on pin%d (%s)\n",\r\npin, info->pads[pin].name);\r\nreturn -EINVAL;\r\n}\r\nmfpr = info->mfp[pin].mfpr;\r\ndata = readl_relaxed(info->virt_base + mfpr) & ~MFPR_FUNC_MASK;\r\ndata |= pin_func;\r\nwritel_relaxed(data, info->virt_base + mfpr);\r\nreturn 0;\r\n}\r\nint pxa3xx_pinctrl_register(struct platform_device *pdev,\r\nstruct pxa3xx_pinmux_info *info)\r\n{\r\nstruct pinctrl_desc *desc;\r\nstruct resource *res;\r\nint ret = 0;\r\nif (!info || !info->cputype)\r\nreturn -EINVAL;\r\ndesc = info->desc;\r\ndesc->pins = info->pads;\r\ndesc->npins = info->num_pads;\r\ndesc->pctlops = &pxa3xx_pctrl_ops;\r\ndesc->pmxops = &pxa3xx_pmx_ops;\r\ninfo->dev = &pdev->dev;\r\npxa3xx_pinctrl_gpio_range.npins = info->num_gpio;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENOENT;\r\ninfo->phy_base = res->start;\r\ninfo->phy_size = resource_size(res);\r\ninfo->virt_base = ioremap(info->phy_base, info->phy_size);\r\nif (!info->virt_base)\r\nreturn -ENOMEM;\r\ninfo->pctrl = pinctrl_register(desc, &pdev->dev, info);\r\nif (!info->pctrl) {\r\ndev_err(&pdev->dev, "failed to register PXA pinmux driver\n");\r\nret = -EINVAL;\r\ngoto err;\r\n}\r\npinctrl_add_gpio_range(info->pctrl, &pxa3xx_pinctrl_gpio_range);\r\nplatform_set_drvdata(pdev, info);\r\nreturn 0;\r\nerr:\r\niounmap(info->virt_base);\r\nreturn ret;\r\n}\r\nint pxa3xx_pinctrl_unregister(struct platform_device *pdev)\r\n{\r\nstruct pxa3xx_pinmux_info *info = platform_get_drvdata(pdev);\r\npinctrl_unregister(info->pctrl);\r\niounmap(info->virt_base);\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn 0;\r\n}\r\nstatic int __init pxa3xx_pinctrl_init(void)\r\n{\r\npr_info("pxa3xx-pinctrl: PXA3xx pinctrl driver initializing\n");\r\nreturn 0;\r\n}\r\nstatic void __exit pxa3xx_pinctrl_exit(void)\r\n{\r\n}

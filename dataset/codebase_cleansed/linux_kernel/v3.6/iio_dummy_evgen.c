static void iio_dummy_event_irqmask(struct irq_data *d)\r\n{\r\nstruct irq_chip *chip = irq_data_get_irq_chip(d);\r\nstruct iio_dummy_eventgen *evgen =\r\ncontainer_of(chip, struct iio_dummy_eventgen, chip);\r\nevgen->enabled[d->irq - evgen->base] = false;\r\n}\r\nstatic void iio_dummy_event_irqunmask(struct irq_data *d)\r\n{\r\nstruct irq_chip *chip = irq_data_get_irq_chip(d);\r\nstruct iio_dummy_eventgen *evgen =\r\ncontainer_of(chip, struct iio_dummy_eventgen, chip);\r\nevgen->enabled[d->irq - evgen->base] = true;\r\n}\r\nstatic int iio_dummy_evgen_create(void)\r\n{\r\nint ret, i;\r\niio_evgen = kzalloc(sizeof(*iio_evgen), GFP_KERNEL);\r\nif (iio_evgen == NULL)\r\nreturn -ENOMEM;\r\niio_evgen->base = irq_alloc_descs(-1, 0, IIO_EVENTGEN_NO, 0);\r\nif (iio_evgen->base < 0) {\r\nret = iio_evgen->base;\r\nkfree(iio_evgen);\r\nreturn ret;\r\n}\r\niio_evgen->chip.name = iio_evgen_name;\r\niio_evgen->chip.irq_mask = &iio_dummy_event_irqmask;\r\niio_evgen->chip.irq_unmask = &iio_dummy_event_irqunmask;\r\nfor (i = 0; i < IIO_EVENTGEN_NO; i++) {\r\nirq_set_chip(iio_evgen->base + i, &iio_evgen->chip);\r\nirq_set_handler(iio_evgen->base + i, &handle_simple_irq);\r\nirq_modify_status(iio_evgen->base + i,\r\nIRQ_NOREQUEST | IRQ_NOAUTOEN,\r\nIRQ_NOPROBE);\r\n}\r\nmutex_init(&iio_evgen->lock);\r\nreturn 0;\r\n}\r\nint iio_dummy_evgen_get_irq(void)\r\n{\r\nint i, ret = 0;\r\nif (iio_evgen == NULL)\r\nreturn -ENODEV;\r\nmutex_lock(&iio_evgen->lock);\r\nfor (i = 0; i < IIO_EVENTGEN_NO; i++)\r\nif (iio_evgen->inuse[i] == false) {\r\nret = iio_evgen->base + i;\r\niio_evgen->inuse[i] = true;\r\nbreak;\r\n}\r\nmutex_unlock(&iio_evgen->lock);\r\nif (i == IIO_EVENTGEN_NO)\r\nreturn -ENOMEM;\r\nreturn ret;\r\n}\r\nint iio_dummy_evgen_release_irq(int irq)\r\n{\r\nmutex_lock(&iio_evgen->lock);\r\niio_evgen->inuse[irq - iio_evgen->base] = false;\r\nmutex_unlock(&iio_evgen->lock);\r\nreturn 0;\r\n}\r\nstatic void iio_dummy_evgen_free(void)\r\n{\r\nirq_free_descs(iio_evgen->base, IIO_EVENTGEN_NO);\r\nkfree(iio_evgen);\r\n}\r\nstatic void iio_evgen_release(struct device *dev)\r\n{\r\niio_dummy_evgen_free();\r\n}\r\nstatic ssize_t iio_evgen_poke(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nif (iio_evgen->enabled[this_attr->address])\r\nhandle_nested_irq(iio_evgen->base + this_attr->address);\r\nreturn len;\r\n}\r\nstatic __init int iio_dummy_evgen_init(void)\r\n{\r\nint ret = iio_dummy_evgen_create();\r\nif (ret < 0)\r\nreturn ret;\r\ndevice_initialize(&iio_evgen_dev);\r\ndev_set_name(&iio_evgen_dev, "iio_evgen");\r\nreturn device_add(&iio_evgen_dev);\r\n}\r\nstatic __exit void iio_dummy_evgen_exit(void)\r\n{\r\ndevice_unregister(&iio_evgen_dev);\r\n}

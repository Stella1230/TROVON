static int\r\nmk_conf_addr(struct pci_bus *pbus, unsigned int device_fn, int where,\r\nunsigned long *pci_addr, u8 *type1)\r\n{\r\nu8 bus = pbus->number;\r\n*type1 = (bus == 0) ? 0 : 1;\r\n*pci_addr = (bus << 16) | (device_fn << 8) | (where) |\r\nPOLARIS_DENSE_CONFIG_BASE;\r\nDBG_CFG(("mk_conf_addr(bus=%d ,device_fn=0x%x, where=0x%x,"\r\n" returning address 0x%p\n"\r\nbus, device_fn, where, *pci_addr));\r\nreturn 0;\r\n}\r\nstatic int\r\npolaris_read_config(struct pci_bus *bus, unsigned int devfn, int where,\r\nint size, u32 *value)\r\n{\r\nunsigned long addr;\r\nunsigned char type1;\r\nif (mk_conf_addr(bus, devfn, where, &addr, &type1))\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nswitch (size) {\r\ncase 1:\r\n*value = __kernel_ldbu(*(vucp)addr);\r\nbreak;\r\ncase 2:\r\n*value = __kernel_ldwu(*(vusp)addr);\r\nbreak;\r\ncase 4:\r\n*value = *(vuip)addr;\r\nbreak;\r\n}\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int\r\npolaris_write_config(struct pci_bus *bus, unsigned int devfn, int where,\r\nint size, u32 value)\r\n{\r\nunsigned long addr;\r\nunsigned char type1;\r\nif (mk_conf_addr(bus, devfn, where, &addr, &type1))\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nswitch (size) {\r\ncase 1:\r\n__kernel_stb(value, *(vucp)addr);\r\nmb();\r\n__kernel_ldbu(*(vucp)addr);\r\nbreak;\r\ncase 2:\r\n__kernel_stw(value, *(vusp)addr);\r\nmb();\r\n__kernel_ldwu(*(vusp)addr);\r\nbreak;\r\ncase 4:\r\n*(vuip)addr = value;\r\nmb();\r\n*(vuip)addr;\r\nbreak;\r\n}\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nvoid __init\r\npolaris_init_arch(void)\r\n{\r\nstruct pci_controller *hose;\r\n#if 0\r\nprintk("polaris_init_arch(): trusting firmware for setup\n");\r\n#endif\r\npci_isa_hose = hose = alloc_pci_controller();\r\nhose->io_space = &ioport_resource;\r\nhose->mem_space = &iomem_resource;\r\nhose->index = 0;\r\nhose->sparse_mem_base = 0;\r\nhose->dense_mem_base = POLARIS_DENSE_MEM_BASE - IDENT_ADDR;\r\nhose->sparse_io_base = 0;\r\nhose->dense_io_base = POLARIS_DENSE_IO_BASE - IDENT_ADDR;\r\nhose->sg_isa = hose->sg_pci = NULL;\r\n__direct_map_base = 0x80000000;\r\n__direct_map_size = 0x80000000;\r\n}\r\nstatic inline void\r\npolaris_pci_clr_err(void)\r\n{\r\n*(vusp)POLARIS_W_STATUS;\r\n*(vusp)POLARIS_W_STATUS = 0x7800;\r\nmb();\r\n*(vusp)POLARIS_W_STATUS;\r\n}\r\nvoid\r\npolaris_machine_check(unsigned long vector, unsigned long la_ptr)\r\n{\r\nmb();\r\nmb();\r\ndraina();\r\npolaris_pci_clr_err();\r\nwrmces(0x7);\r\nmb();\r\nprocess_mcheck_info(vector, la_ptr, "POLARIS",\r\nmcheck_expected(0));\r\n}

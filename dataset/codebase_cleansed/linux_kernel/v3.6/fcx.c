struct tcw *tcw_get_intrg(struct tcw *tcw)\r\n{\r\nreturn (struct tcw *) ((addr_t) tcw->intrg);\r\n}\r\nvoid *tcw_get_data(struct tcw *tcw)\r\n{\r\nif (tcw->r)\r\nreturn (void *) ((addr_t) tcw->input);\r\nif (tcw->w)\r\nreturn (void *) ((addr_t) tcw->output);\r\nreturn NULL;\r\n}\r\nstruct tccb *tcw_get_tccb(struct tcw *tcw)\r\n{\r\nreturn (struct tccb *) ((addr_t) tcw->tccb);\r\n}\r\nstruct tsb *tcw_get_tsb(struct tcw *tcw)\r\n{\r\nreturn (struct tsb *) ((addr_t) tcw->tsb);\r\n}\r\nvoid tcw_init(struct tcw *tcw, int r, int w)\r\n{\r\nmemset(tcw, 0, sizeof(struct tcw));\r\ntcw->format = TCW_FORMAT_DEFAULT;\r\ntcw->flags = TCW_FLAGS_TIDAW_FORMAT(TCW_TIDAW_FORMAT_DEFAULT);\r\nif (r)\r\ntcw->r = 1;\r\nif (w)\r\ntcw->w = 1;\r\n}\r\nstatic inline size_t tca_size(struct tccb *tccb)\r\n{\r\nreturn tccb->tcah.tcal - 12;\r\n}\r\nstatic u32 calc_dcw_count(struct tccb *tccb)\r\n{\r\nint offset;\r\nstruct dcw *dcw;\r\nu32 count = 0;\r\nsize_t size;\r\nsize = tca_size(tccb);\r\nfor (offset = 0; offset < size;) {\r\ndcw = (struct dcw *) &tccb->tca[offset];\r\ncount += dcw->count;\r\nif (!(dcw->flags & DCW_FLAGS_CC))\r\nbreak;\r\noffset += sizeof(struct dcw) + ALIGN((int) dcw->cd_count, 4);\r\n}\r\nreturn count;\r\n}\r\nstatic u32 calc_cbc_size(struct tidaw *tidaw, int num)\r\n{\r\nint i;\r\nu32 cbc_data;\r\nu32 cbc_count = 0;\r\nu64 data_count = 0;\r\nfor (i = 0; i < num; i++) {\r\nif (tidaw[i].flags & TIDAW_FLAGS_LAST)\r\nbreak;\r\ndata_count += tidaw[i].count;\r\nif (tidaw[i].flags & TIDAW_FLAGS_INSERT_CBC) {\r\ncbc_data = 4 + ALIGN(data_count, 4) - data_count;\r\ncbc_count += cbc_data;\r\ndata_count += cbc_data;\r\n}\r\n}\r\nreturn cbc_count;\r\n}\r\nvoid tcw_finalize(struct tcw *tcw, int num_tidaws)\r\n{\r\nstruct tidaw *tidaw;\r\nstruct tccb *tccb;\r\nstruct tccb_tcat *tcat;\r\nu32 count;\r\ntidaw = tcw_get_data(tcw);\r\nif (num_tidaws > 0)\r\ntidaw[num_tidaws - 1].flags |= TIDAW_FLAGS_LAST;\r\ntccb = tcw_get_tccb(tcw);\r\ntcat = (struct tccb_tcat *) &tccb->tca[tca_size(tccb)];\r\nmemset(tcat, 0, sizeof(*tcat));\r\ncount = calc_dcw_count(tccb);\r\nif (tcw->w && (tcw->flags & TCW_FLAGS_OUTPUT_TIDA))\r\ncount += calc_cbc_size(tidaw, num_tidaws);\r\nif (tcw->r)\r\ntcw->input_count = count;\r\nelse if (tcw->w)\r\ntcw->output_count = count;\r\ntcat->count = ALIGN(count, 4) + 4;\r\ntcw->tccbl = (sizeof(struct tccb) + tca_size(tccb) +\r\nsizeof(struct tccb_tcat) - 20) >> 2;\r\n}\r\nvoid tcw_set_intrg(struct tcw *tcw, struct tcw *intrg_tcw)\r\n{\r\ntcw->intrg = (u32) ((addr_t) intrg_tcw);\r\n}\r\nvoid tcw_set_data(struct tcw *tcw, void *data, int use_tidal)\r\n{\r\nif (tcw->r) {\r\ntcw->input = (u64) ((addr_t) data);\r\nif (use_tidal)\r\ntcw->flags |= TCW_FLAGS_INPUT_TIDA;\r\n} else if (tcw->w) {\r\ntcw->output = (u64) ((addr_t) data);\r\nif (use_tidal)\r\ntcw->flags |= TCW_FLAGS_OUTPUT_TIDA;\r\n}\r\n}\r\nvoid tcw_set_tccb(struct tcw *tcw, struct tccb *tccb)\r\n{\r\ntcw->tccb = (u64) ((addr_t) tccb);\r\n}\r\nvoid tcw_set_tsb(struct tcw *tcw, struct tsb *tsb)\r\n{\r\ntcw->tsb = (u64) ((addr_t) tsb);\r\n}\r\nvoid tccb_init(struct tccb *tccb, size_t size, u32 sac)\r\n{\r\nmemset(tccb, 0, size);\r\ntccb->tcah.format = TCCB_FORMAT_DEFAULT;\r\ntccb->tcah.sac = sac;\r\ntccb->tcah.tcal = 12;\r\n}\r\nvoid tsb_init(struct tsb *tsb)\r\n{\r\nmemset(tsb, 0, sizeof(*tsb));\r\n}\r\nstruct dcw *tccb_add_dcw(struct tccb *tccb, size_t tccb_size, u8 cmd, u8 flags,\r\nvoid *cd, u8 cd_count, u32 count)\r\n{\r\nstruct dcw *dcw;\r\nint size;\r\nint tca_offset;\r\ntca_offset = tca_size(tccb);\r\nsize = ALIGN(sizeof(struct dcw) + cd_count, 4);\r\nif (sizeof(struct tccb_tcah) + tca_offset + size +\r\nsizeof(struct tccb_tcat) > tccb_size)\r\nreturn ERR_PTR(-ENOSPC);\r\ndcw = (struct dcw *) &tccb->tca[tca_offset];\r\nmemset(dcw, 0, size);\r\ndcw->cmd = cmd;\r\ndcw->flags = flags;\r\ndcw->count = count;\r\ndcw->cd_count = cd_count;\r\nif (cd)\r\nmemcpy(&dcw->cd[0], cd, cd_count);\r\ntccb->tcah.tcal += size;\r\nreturn dcw;\r\n}\r\nstruct tidaw *tcw_add_tidaw(struct tcw *tcw, int num_tidaws, u8 flags,\r\nvoid *addr, u32 count)\r\n{\r\nstruct tidaw *tidaw;\r\ntidaw = ((struct tidaw *) tcw_get_data(tcw)) + num_tidaws;\r\nmemset(tidaw, 0, sizeof(struct tidaw));\r\ntidaw->flags = flags;\r\ntidaw->count = count;\r\ntidaw->addr = (u64) ((addr_t) addr);\r\nreturn tidaw;\r\n}

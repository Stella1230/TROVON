static void mm_outsw(unsigned long addr, void *buf, u32 len)\r\n{\r\nunsigned short *bp = (unsigned short *)buf;\r\nfor (; len > 0; len--, bp++)\r\n*(volatile u16 *)addr = bswap(*bp);\r\n}\r\nstatic void mm_insw(unsigned long addr, void *buf, u32 len)\r\n{\r\nunsigned short *bp = (unsigned short *)buf;\r\nfor (; len > 0; len--, bp++)\r\n*bp = bswap(*(volatile u16 *)addr);\r\n}\r\nstatic void h8300_input_data(ide_drive_t *drive, struct ide_cmd *cmd,\r\nvoid *buf, unsigned int len)\r\n{\r\nmm_insw(drive->hwif->io_ports.data_addr, buf, (len + 1) / 2);\r\n}\r\nstatic void h8300_output_data(ide_drive_t *drive, struct ide_cmd *cmd,\r\nvoid *buf, unsigned int len)\r\n{\r\nmm_outsw(drive->hwif->io_ports.data_addr, buf, (len + 1) / 2);\r\n}\r\nstatic inline void hw_setup(struct ide_hw *hw)\r\n{\r\nint i;\r\nmemset(hw, 0, sizeof(*hw));\r\nfor (i = 0; i <= 7; i++)\r\nhw->io_ports_array[i] = CONFIG_H8300_IDE_BASE + H8300_IDE_GAP*i;\r\nhw->io_ports.ctl_addr = CONFIG_H8300_IDE_ALT;\r\nhw->irq = EXT_IRQ0 + CONFIG_H8300_IDE_IRQ;\r\n}\r\nstatic int __init h8300_ide_init(void)\r\n{\r\nstruct ide_hw hw, *hws[] = { &hw };\r\nprintk(KERN_INFO DRV_NAME ": H8/300 generic IDE interface\n");\r\nif (!request_region(CONFIG_H8300_IDE_BASE, H8300_IDE_GAP*8, "ide-h8300"))\r\ngoto out_busy;\r\nif (!request_region(CONFIG_H8300_IDE_ALT, H8300_IDE_GAP, "ide-h8300")) {\r\nrelease_region(CONFIG_H8300_IDE_BASE, H8300_IDE_GAP*8);\r\ngoto out_busy;\r\n}\r\nhw_setup(&hw);\r\nreturn ide_host_add(&h8300_port_info, hws, 1, NULL);\r\nout_busy:\r\nprintk(KERN_ERR "ide-h8300: IDE I/F resource already used.\n");\r\nreturn -EBUSY;\r\n}

static unsigned int sc520_freq_get_cpu_frequency(unsigned int cpu)\r\n{\r\nu8 clockspeed_reg = *cpuctl;\r\nswitch (clockspeed_reg & 0x03) {\r\ndefault:\r\nprintk(KERN_ERR PFX "error: cpuctl register has unexpected "\r\n"value %02x\n", clockspeed_reg);\r\ncase 0x01:\r\nreturn 100000;\r\ncase 0x02:\r\nreturn 133000;\r\n}\r\n}\r\nstatic void sc520_freq_set_cpu_state(unsigned int state)\r\n{\r\nstruct cpufreq_freqs freqs;\r\nu8 clockspeed_reg;\r\nfreqs.old = sc520_freq_get_cpu_frequency(0);\r\nfreqs.new = sc520_freq_table[state].frequency;\r\nfreqs.cpu = 0;\r\ncpufreq_notify_transition(&freqs, CPUFREQ_PRECHANGE);\r\npr_debug("attempting to set frequency to %i kHz\n",\r\nsc520_freq_table[state].frequency);\r\nlocal_irq_disable();\r\nclockspeed_reg = *cpuctl & ~0x03;\r\n*cpuctl = clockspeed_reg | sc520_freq_table[state].index;\r\nlocal_irq_enable();\r\ncpufreq_notify_transition(&freqs, CPUFREQ_POSTCHANGE);\r\n}\r\nstatic int sc520_freq_verify(struct cpufreq_policy *policy)\r\n{\r\nreturn cpufreq_frequency_table_verify(policy, &sc520_freq_table[0]);\r\n}\r\nstatic int sc520_freq_target(struct cpufreq_policy *policy,\r\nunsigned int target_freq,\r\nunsigned int relation)\r\n{\r\nunsigned int newstate = 0;\r\nif (cpufreq_frequency_table_target(policy, sc520_freq_table,\r\ntarget_freq, relation, &newstate))\r\nreturn -EINVAL;\r\nsc520_freq_set_cpu_state(newstate);\r\nreturn 0;\r\n}\r\nstatic int sc520_freq_cpu_init(struct cpufreq_policy *policy)\r\n{\r\nstruct cpuinfo_x86 *c = &cpu_data(0);\r\nint result;\r\nif (c->x86_vendor != X86_VENDOR_AMD ||\r\nc->x86 != 4 || c->x86_model != 9)\r\nreturn -ENODEV;\r\npolicy->cpuinfo.transition_latency = 1000000;\r\npolicy->cur = sc520_freq_get_cpu_frequency(0);\r\nresult = cpufreq_frequency_table_cpuinfo(policy, sc520_freq_table);\r\nif (result)\r\nreturn result;\r\ncpufreq_frequency_table_get_attr(sc520_freq_table, policy->cpu);\r\nreturn 0;\r\n}\r\nstatic int sc520_freq_cpu_exit(struct cpufreq_policy *policy)\r\n{\r\ncpufreq_frequency_table_put_attr(policy->cpu);\r\nreturn 0;\r\n}\r\nstatic int __init sc520_freq_init(void)\r\n{\r\nint err;\r\nif (!x86_match_cpu(sc520_ids))\r\nreturn -ENODEV;\r\ncpuctl = ioremap((unsigned long)(MMCR_BASE + OFFS_CPUCTL), 1);\r\nif (!cpuctl) {\r\nprintk(KERN_ERR "sc520_freq: error: failed to remap memory\n");\r\nreturn -ENOMEM;\r\n}\r\nerr = cpufreq_register_driver(&sc520_freq_driver);\r\nif (err)\r\niounmap(cpuctl);\r\nreturn err;\r\n}\r\nstatic void __exit sc520_freq_exit(void)\r\n{\r\ncpufreq_unregister_driver(&sc520_freq_driver);\r\niounmap(cpuctl);\r\n}

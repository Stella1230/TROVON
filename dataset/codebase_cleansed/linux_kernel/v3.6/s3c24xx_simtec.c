static int speaker_gain_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nucontrol->value.integer.value[0] = spk_gain;\r\nreturn 0;\r\n}\r\nstatic void speaker_gain_set(int value)\r\n{\r\ngpio_set_value_cansleep(pdata->amp_gain[0], value & 1);\r\ngpio_set_value_cansleep(pdata->amp_gain[1], value >> 1);\r\n}\r\nstatic int speaker_gain_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nint value = ucontrol->value.integer.value[0];\r\nspk_gain = value;\r\nif (!spk_unmute)\r\nspeaker_gain_set(value);\r\nreturn 0;\r\n}\r\nstatic void spk_unmute_state(int to)\r\n{\r\npr_debug("%s: to=%d\n", __func__, to);\r\nspk_unmute = to;\r\ngpio_set_value(pdata->amp_gpio, to);\r\nif (to && pdata->amp_gain[0] > 0)\r\nspeaker_gain_set(spk_gain);\r\n}\r\nstatic int speaker_unmute_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nucontrol->value.integer.value[0] = spk_unmute;\r\nreturn 0;\r\n}\r\nstatic int speaker_unmute_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nspk_unmute_state(ucontrol->value.integer.value[0]);\r\nreturn 0;\r\n}\r\nvoid simtec_audio_init(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct snd_soc_card *card = rtd->card;\r\nif (pdata->amp_gpio > 0) {\r\npr_debug("%s: adding amp routes\n", __func__);\r\nsnd_soc_add_card_controls(card, amp_unmute_controls,\r\nARRAY_SIZE(amp_unmute_controls));\r\n}\r\nif (pdata->amp_gain[0] > 0) {\r\npr_debug("%s: adding amp controls\n", __func__);\r\nsnd_soc_add_card_controls(card, amp_gain_controls,\r\nARRAY_SIZE(amp_gain_controls));\r\n}\r\n}\r\nstatic int simtec_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nint ret;\r\nret = snd_soc_dai_set_fmt(cpu_dai, SND_SOC_DAIFMT_I2S |\r\nSND_SOC_DAIFMT_NB_NF |\r\nSND_SOC_DAIFMT_CBM_CFM);\r\nif (ret) {\r\npr_err("%s: failed set cpu dai format\n", __func__);\r\nreturn ret;\r\n}\r\nret = snd_soc_dai_set_fmt(codec_dai, SND_SOC_DAIFMT_I2S |\r\nSND_SOC_DAIFMT_NB_NF |\r\nSND_SOC_DAIFMT_CBM_CFM);\r\nif (ret) {\r\npr_err("%s: failed set codec dai format\n", __func__);\r\nreturn ret;\r\n}\r\nret = snd_soc_dai_set_sysclk(codec_dai, 0,\r\nCODEC_CLOCK, SND_SOC_CLOCK_IN);\r\nif (ret) {\r\npr_err( "%s: failed setting codec sysclk\n", __func__);\r\nreturn ret;\r\n}\r\nif (pdata->use_mpllin) {\r\nret = snd_soc_dai_set_sysclk(cpu_dai, S3C24XX_CLKSRC_MPLL,\r\n0, SND_SOC_CLOCK_OUT);\r\nif (ret) {\r\npr_err("%s: failed to set MPLLin as clksrc\n",\r\n__func__);\r\nreturn ret;\r\n}\r\n}\r\nif (pdata->output_cdclk) {\r\nint cdclk_scale;\r\ncdclk_scale = clk_get_rate(xtal_clk) / CODEC_CLOCK;\r\ncdclk_scale--;\r\nret = snd_soc_dai_set_clkdiv(cpu_dai, S3C24XX_DIV_PRESCALER,\r\ncdclk_scale);\r\n}\r\nreturn 0;\r\n}\r\nstatic int simtec_call_startup(struct s3c24xx_audio_simtec_pdata *pd)\r\n{\r\nif (pd->startup)\r\npd->startup();\r\nreturn 0;\r\n}\r\nstatic int attach_gpio_amp(struct device *dev,\r\nstruct s3c24xx_audio_simtec_pdata *pd)\r\n{\r\nint ret;\r\nif (pdata->amp_gain[0] > 0) {\r\nret = gpio_request(pd->amp_gain[0], "gpio-amp-gain0");\r\nif (ret) {\r\ndev_err(dev, "cannot get amp gpio gain0\n");\r\nreturn ret;\r\n}\r\nret = gpio_request(pd->amp_gain[1], "gpio-amp-gain1");\r\nif (ret) {\r\ndev_err(dev, "cannot get amp gpio gain1\n");\r\ngpio_free(pdata->amp_gain[0]);\r\nreturn ret;\r\n}\r\ngpio_direction_output(pd->amp_gain[0], 0);\r\ngpio_direction_output(pd->amp_gain[1], 0);\r\n}\r\nif (pdata->amp_gpio > 0) {\r\nret = gpio_request(pd->amp_gpio, "gpio-amp");\r\nif (ret) {\r\ndev_err(dev, "cannot get amp gpio %d (%d)\n",\r\npd->amp_gpio, ret);\r\ngoto err_amp;\r\n}\r\nspk_unmute_state(0);\r\n}\r\nreturn 0;\r\nerr_amp:\r\nif (pd->amp_gain[0] > 0) {\r\ngpio_free(pd->amp_gain[0]);\r\ngpio_free(pd->amp_gain[1]);\r\n}\r\nreturn ret;\r\n}\r\nstatic void detach_gpio_amp(struct s3c24xx_audio_simtec_pdata *pd)\r\n{\r\nif (pd->amp_gain[0] > 0) {\r\ngpio_free(pd->amp_gain[0]);\r\ngpio_free(pd->amp_gain[1]);\r\n}\r\nif (pd->amp_gpio > 0)\r\ngpio_free(pd->amp_gpio);\r\n}\r\nstatic int simtec_audio_resume(struct device *dev)\r\n{\r\nsimtec_call_startup(pdata);\r\nreturn 0;\r\n}\r\nint __devinit simtec_audio_core_probe(struct platform_device *pdev,\r\nstruct snd_soc_card *card)\r\n{\r\nstruct platform_device *snd_dev;\r\nint ret;\r\ncard->dai_link->ops = &simtec_snd_ops;\r\npdata = pdev->dev.platform_data;\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "no platform data supplied\n");\r\nreturn -EINVAL;\r\n}\r\nsimtec_call_startup(pdata);\r\nxtal_clk = clk_get(&pdev->dev, "xtal");\r\nif (IS_ERR(xtal_clk)) {\r\ndev_err(&pdev->dev, "could not get clkout0\n");\r\nreturn -EINVAL;\r\n}\r\ndev_info(&pdev->dev, "xtal rate is %ld\n", clk_get_rate(xtal_clk));\r\nret = attach_gpio_amp(&pdev->dev, pdata);\r\nif (ret)\r\ngoto err_clk;\r\nsnd_dev = platform_device_alloc("soc-audio", -1);\r\nif (!snd_dev) {\r\ndev_err(&pdev->dev, "failed to alloc soc-audio devicec\n");\r\nret = -ENOMEM;\r\ngoto err_gpio;\r\n}\r\nplatform_set_drvdata(snd_dev, card);\r\nret = platform_device_add(snd_dev);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to add soc-audio dev\n");\r\ngoto err_pdev;\r\n}\r\nplatform_set_drvdata(pdev, snd_dev);\r\nreturn 0;\r\nerr_pdev:\r\nplatform_device_put(snd_dev);\r\nerr_gpio:\r\ndetach_gpio_amp(pdata);\r\nerr_clk:\r\nclk_put(xtal_clk);\r\nreturn ret;\r\n}\r\nint __devexit simtec_audio_remove(struct platform_device *pdev)\r\n{\r\nstruct platform_device *snd_dev = platform_get_drvdata(pdev);\r\nplatform_device_unregister(snd_dev);\r\ndetach_gpio_amp(pdata);\r\nclk_put(xtal_clk);\r\nreturn 0;\r\n}

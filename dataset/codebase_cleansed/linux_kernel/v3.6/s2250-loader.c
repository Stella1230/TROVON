static void s2250loader_delete(struct kref *kref)\r\n{\r\npdevice_extension_t s = to_s2250loader_dev_common(kref);\r\ns2250_dev_table[s->minor] = NULL;\r\nkfree(s);\r\n}\r\nstatic int s2250loader_probe(struct usb_interface *interface,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct usb_device *usbdev;\r\nint minor, ret;\r\npdevice_extension_t s = NULL;\r\nconst struct firmware *fw;\r\nusbdev = usb_get_dev(interface_to_usbdev(interface));\r\nif (!usbdev) {\r\nprintk(KERN_ERR "Enter s2250loader_probe failed\n");\r\nreturn -1;\r\n}\r\nprintk(KERN_INFO "Enter s2250loader_probe 2.6 kernel\n");\r\nprintk(KERN_INFO "vendor id 0x%x, device id 0x%x devnum:%d\n",\r\nusbdev->descriptor.idVendor, usbdev->descriptor.idProduct,\r\nusbdev->devnum);\r\nif (usbdev->descriptor.bNumConfigurations != 1) {\r\nprintk(KERN_ERR "can't handle multiple config\n");\r\nreturn -1;\r\n}\r\nmutex_lock(&s2250_dev_table_mutex);\r\nfor (minor = 0; minor < MAX_DEVICES; minor++) {\r\nif (s2250_dev_table[minor] == NULL)\r\nbreak;\r\n}\r\nif (minor < 0 || minor >= MAX_DEVICES) {\r\nprintk(KERN_ERR "Invalid minor: %d\n", minor);\r\ngoto failed;\r\n}\r\ns = kmalloc(sizeof(device_extension_t), GFP_KERNEL);\r\nif (s == NULL) {\r\nprintk(KERN_ERR "Out of memory\n");\r\ngoto failed;\r\n}\r\ns2250_dev_table[minor] = s;\r\nprintk(KERN_INFO "s2250loader_probe: Device %d on Bus %d Minor %d\n",\r\nusbdev->devnum, usbdev->bus->busnum, minor);\r\nmemset(s, 0, sizeof(device_extension_t));\r\ns->usbdev = usbdev;\r\nprintk(KERN_INFO "loading 2250 loader\n");\r\nkref_init(&(s->kref));\r\nmutex_unlock(&s2250_dev_table_mutex);\r\nif (request_firmware(&fw, S2250_LOADER_FIRMWARE, &usbdev->dev)) {\r\nprintk(KERN_ERR\r\n"s2250: unable to load firmware from file \"%s\"\n",\r\nS2250_LOADER_FIRMWARE);\r\ngoto failed2;\r\n}\r\nret = usb_cypress_load_firmware(usbdev, fw, CYPRESS_FX2);\r\nrelease_firmware(fw);\r\nif (0 != ret) {\r\nprintk(KERN_ERR "loader download failed\n");\r\ngoto failed2;\r\n}\r\nif (request_firmware(&fw, S2250_FIRMWARE, &usbdev->dev)) {\r\nprintk(KERN_ERR\r\n"s2250: unable to load firmware from file \"%s\"\n",\r\nS2250_FIRMWARE);\r\ngoto failed2;\r\n}\r\nret = usb_cypress_load_firmware(usbdev, fw, CYPRESS_FX2);\r\nrelease_firmware(fw);\r\nif (0 != ret) {\r\nprintk(KERN_ERR "firmware_s2250 download failed\n");\r\ngoto failed2;\r\n}\r\nusb_set_intfdata(interface, s);\r\nreturn 0;\r\nfailed:\r\nmutex_unlock(&s2250_dev_table_mutex);\r\nfailed2:\r\nif (s)\r\nkref_put(&(s->kref), s2250loader_delete);\r\nprintk(KERN_ERR "probe failed\n");\r\nreturn -1;\r\n}\r\nstatic void s2250loader_disconnect(struct usb_interface *interface)\r\n{\r\npdevice_extension_t s;\r\nprintk(KERN_INFO "s2250: disconnect\n");\r\ns = usb_get_intfdata(interface);\r\nusb_set_intfdata(interface, NULL);\r\nkref_put(&(s->kref), s2250loader_delete);\r\n}

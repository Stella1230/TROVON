static int lm25066_read_word_data(struct i2c_client *client, int page, int reg)\r\n{\r\nconst struct pmbus_driver_info *info = pmbus_get_driver_info(client);\r\nconst struct lm25066_data *data = to_lm25066_data(info);\r\nint ret;\r\nif (page > 1)\r\nreturn -ENXIO;\r\nif (page == 1) {\r\nswitch (reg) {\r\ncase PMBUS_READ_VOUT:\r\nret = pmbus_read_word_data(client, 0,\r\nLM25066_READ_VAUX);\r\nif (ret < 0)\r\nbreak;\r\nswitch (data->id) {\r\ncase lm25066:\r\nret = DIV_ROUND_CLOSEST(ret * 2832, 45400);\r\nbreak;\r\ncase lm5064:\r\nret = DIV_ROUND_CLOSEST(ret * 70, 453);\r\nbreak;\r\ncase lm5066:\r\nret = DIV_ROUND_CLOSEST(ret * 725, 2180);\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\nret = -ENXIO;\r\nbreak;\r\n}\r\ngoto done;\r\n}\r\nswitch (reg) {\r\ncase PMBUS_READ_IIN:\r\nret = pmbus_read_word_data(client, 0, LM25066_MFR_READ_IIN);\r\nbreak;\r\ncase PMBUS_READ_PIN:\r\nret = pmbus_read_word_data(client, 0, LM25066_MFR_READ_PIN);\r\nbreak;\r\ncase PMBUS_IIN_OC_WARN_LIMIT:\r\nret = pmbus_read_word_data(client, 0,\r\nLM25066_MFR_IIN_OC_WARN_LIMIT);\r\nbreak;\r\ncase PMBUS_PIN_OP_WARN_LIMIT:\r\nret = pmbus_read_word_data(client, 0,\r\nLM25066_MFR_PIN_OP_WARN_LIMIT);\r\nbreak;\r\ncase PMBUS_VIRT_READ_VIN_AVG:\r\nret = pmbus_read_word_data(client, 0, LM25066_READ_AVG_VIN);\r\nbreak;\r\ncase PMBUS_VIRT_READ_VOUT_AVG:\r\nret = pmbus_read_word_data(client, 0, LM25066_READ_AVG_VOUT);\r\nbreak;\r\ncase PMBUS_VIRT_READ_IIN_AVG:\r\nret = pmbus_read_word_data(client, 0, LM25066_READ_AVG_IIN);\r\nbreak;\r\ncase PMBUS_VIRT_READ_PIN_AVG:\r\nret = pmbus_read_word_data(client, 0, LM25066_READ_AVG_PIN);\r\nbreak;\r\ncase PMBUS_VIRT_READ_PIN_MAX:\r\nret = pmbus_read_word_data(client, 0, LM25066_READ_PIN_PEAK);\r\nbreak;\r\ncase PMBUS_VIRT_RESET_PIN_HISTORY:\r\nret = 0;\r\nbreak;\r\ndefault:\r\nret = -ENODATA;\r\nbreak;\r\n}\r\ndone:\r\nreturn ret;\r\n}\r\nstatic int lm25066_write_word_data(struct i2c_client *client, int page, int reg,\r\nu16 word)\r\n{\r\nint ret;\r\nif (page > 1)\r\nreturn -ENXIO;\r\nswitch (reg) {\r\ncase PMBUS_IIN_OC_WARN_LIMIT:\r\nret = pmbus_write_word_data(client, 0,\r\nLM25066_MFR_IIN_OC_WARN_LIMIT,\r\nword);\r\nbreak;\r\ncase PMBUS_PIN_OP_WARN_LIMIT:\r\nret = pmbus_write_word_data(client, 0,\r\nLM25066_MFR_PIN_OP_WARN_LIMIT,\r\nword);\r\nbreak;\r\ncase PMBUS_VIRT_RESET_PIN_HISTORY:\r\nret = pmbus_write_byte(client, 0, LM25066_CLEAR_PIN_PEAK);\r\nbreak;\r\ndefault:\r\nret = -ENODATA;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int lm25066_write_byte(struct i2c_client *client, int page, u8 value)\r\n{\r\nif (page > 1)\r\nreturn -ENXIO;\r\nif (page <= 0)\r\nreturn pmbus_write_byte(client, page, value);\r\nreturn 0;\r\n}\r\nstatic int lm25066_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nint config;\r\nstruct lm25066_data *data;\r\nstruct pmbus_driver_info *info;\r\nif (!i2c_check_functionality(client->adapter,\r\nI2C_FUNC_SMBUS_READ_BYTE_DATA))\r\nreturn -ENODEV;\r\ndata = devm_kzalloc(&client->dev, sizeof(struct lm25066_data),\r\nGFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\nconfig = i2c_smbus_read_byte_data(client, LM25066_DEVICE_SETUP);\r\nif (config < 0)\r\nreturn config;\r\ndata->id = id->driver_data;\r\ninfo = &data->info;\r\ninfo->pages = 2;\r\ninfo->format[PSC_VOLTAGE_IN] = direct;\r\ninfo->format[PSC_VOLTAGE_OUT] = direct;\r\ninfo->format[PSC_CURRENT_IN] = direct;\r\ninfo->format[PSC_TEMPERATURE] = direct;\r\ninfo->format[PSC_POWER] = direct;\r\ninfo->m[PSC_TEMPERATURE] = 16;\r\ninfo->b[PSC_TEMPERATURE] = 0;\r\ninfo->R[PSC_TEMPERATURE] = 0;\r\ninfo->func[0] = PMBUS_HAVE_VIN | PMBUS_HAVE_VOUT\r\n| PMBUS_HAVE_STATUS_VOUT | PMBUS_HAVE_PIN | PMBUS_HAVE_IIN\r\n| PMBUS_HAVE_STATUS_INPUT | PMBUS_HAVE_TEMP | PMBUS_HAVE_STATUS_TEMP;\r\ninfo->func[1] = PMBUS_HAVE_VOUT;\r\ninfo->read_word_data = lm25066_read_word_data;\r\ninfo->write_word_data = lm25066_write_word_data;\r\ninfo->write_byte = lm25066_write_byte;\r\nswitch (id->driver_data) {\r\ncase lm25066:\r\ninfo->m[PSC_VOLTAGE_IN] = 22070;\r\ninfo->b[PSC_VOLTAGE_IN] = 0;\r\ninfo->R[PSC_VOLTAGE_IN] = -2;\r\ninfo->m[PSC_VOLTAGE_OUT] = 22070;\r\ninfo->b[PSC_VOLTAGE_OUT] = 0;\r\ninfo->R[PSC_VOLTAGE_OUT] = -2;\r\nif (config & LM25066_DEV_SETUP_CL) {\r\ninfo->m[PSC_CURRENT_IN] = 6852;\r\ninfo->b[PSC_CURRENT_IN] = 0;\r\ninfo->R[PSC_CURRENT_IN] = -2;\r\ninfo->m[PSC_POWER] = 369;\r\ninfo->b[PSC_POWER] = 0;\r\ninfo->R[PSC_POWER] = -2;\r\n} else {\r\ninfo->m[PSC_CURRENT_IN] = 13661;\r\ninfo->b[PSC_CURRENT_IN] = 0;\r\ninfo->R[PSC_CURRENT_IN] = -2;\r\ninfo->m[PSC_POWER] = 736;\r\ninfo->b[PSC_POWER] = 0;\r\ninfo->R[PSC_POWER] = -2;\r\n}\r\nbreak;\r\ncase lm5064:\r\ninfo->m[PSC_VOLTAGE_IN] = 22075;\r\ninfo->b[PSC_VOLTAGE_IN] = 0;\r\ninfo->R[PSC_VOLTAGE_IN] = -2;\r\ninfo->m[PSC_VOLTAGE_OUT] = 22075;\r\ninfo->b[PSC_VOLTAGE_OUT] = 0;\r\ninfo->R[PSC_VOLTAGE_OUT] = -2;\r\nif (config & LM25066_DEV_SETUP_CL) {\r\ninfo->m[PSC_CURRENT_IN] = 6713;\r\ninfo->b[PSC_CURRENT_IN] = 0;\r\ninfo->R[PSC_CURRENT_IN] = -2;\r\ninfo->m[PSC_POWER] = 3619;\r\ninfo->b[PSC_POWER] = 0;\r\ninfo->R[PSC_POWER] = -3;\r\n} else {\r\ninfo->m[PSC_CURRENT_IN] = 13426;\r\ninfo->b[PSC_CURRENT_IN] = 0;\r\ninfo->R[PSC_CURRENT_IN] = -2;\r\ninfo->m[PSC_POWER] = 7238;\r\ninfo->b[PSC_POWER] = 0;\r\ninfo->R[PSC_POWER] = -3;\r\n}\r\nbreak;\r\ncase lm5066:\r\ninfo->m[PSC_VOLTAGE_IN] = 4587;\r\ninfo->b[PSC_VOLTAGE_IN] = 0;\r\ninfo->R[PSC_VOLTAGE_IN] = -2;\r\ninfo->m[PSC_VOLTAGE_OUT] = 4587;\r\ninfo->b[PSC_VOLTAGE_OUT] = 0;\r\ninfo->R[PSC_VOLTAGE_OUT] = -2;\r\nif (config & LM25066_DEV_SETUP_CL) {\r\ninfo->m[PSC_CURRENT_IN] = 10753;\r\ninfo->b[PSC_CURRENT_IN] = 0;\r\ninfo->R[PSC_CURRENT_IN] = -2;\r\ninfo->m[PSC_POWER] = 1204;\r\ninfo->b[PSC_POWER] = 0;\r\ninfo->R[PSC_POWER] = -3;\r\n} else {\r\ninfo->m[PSC_CURRENT_IN] = 5405;\r\ninfo->b[PSC_CURRENT_IN] = 0;\r\ninfo->R[PSC_CURRENT_IN] = -2;\r\ninfo->m[PSC_POWER] = 605;\r\ninfo->b[PSC_POWER] = 0;\r\ninfo->R[PSC_POWER] = -3;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -ENODEV;\r\n}\r\nreturn pmbus_do_probe(client, id, info);\r\n}

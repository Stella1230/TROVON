int uflash_devinit(struct platform_device *op, struct device_node *dp)\r\n{\r\nstruct uflash_dev *up;\r\nif (op->resource[1].flags) {\r\nprintk(KERN_ERR PFX "Unsupported device at %s, 0x%llx\n",\r\ndp->full_name, (unsigned long long)op->resource[0].start);\r\nreturn -ENODEV;\r\n}\r\nup = kzalloc(sizeof(struct uflash_dev), GFP_KERNEL);\r\nif (!up) {\r\nprintk(KERN_ERR PFX "Cannot allocate struct uflash_dev\n");\r\nreturn -ENOMEM;\r\n}\r\nmemcpy(&up->map, &uflash_map_templ, sizeof(uflash_map_templ));\r\nup->map.size = resource_size(&op->resource[0]);\r\nup->name = of_get_property(dp, "model", NULL);\r\nif (up->name && 0 < strlen(up->name))\r\nup->map.name = (char *)up->name;\r\nup->map.phys = op->resource[0].start;\r\nup->map.virt = of_ioremap(&op->resource[0], 0, up->map.size,\r\nDRIVER_NAME);\r\nif (!up->map.virt) {\r\nprintk(KERN_ERR PFX "Failed to map device.\n");\r\nkfree(up);\r\nreturn -EINVAL;\r\n}\r\nsimple_map_init(&up->map);\r\nup->mtd = do_map_probe("cfi_probe", &up->map);\r\nif (!up->mtd) {\r\nof_iounmap(&op->resource[0], up->map.virt, up->map.size);\r\nkfree(up);\r\nreturn -ENXIO;\r\n}\r\nup->mtd->owner = THIS_MODULE;\r\nmtd_device_register(up->mtd, NULL, 0);\r\ndev_set_drvdata(&op->dev, up);\r\nreturn 0;\r\n}\r\nstatic int __devinit uflash_probe(struct platform_device *op)\r\n{\r\nstruct device_node *dp = op->dev.of_node;\r\nif (!of_find_property(dp, "user", NULL))\r\nreturn -ENODEV;\r\nreturn uflash_devinit(op, dp);\r\n}\r\nstatic int __devexit uflash_remove(struct platform_device *op)\r\n{\r\nstruct uflash_dev *up = dev_get_drvdata(&op->dev);\r\nif (up->mtd) {\r\nmtd_device_unregister(up->mtd);\r\nmap_destroy(up->mtd);\r\n}\r\nif (up->map.virt) {\r\nof_iounmap(&op->resource[0], up->map.virt, up->map.size);\r\nup->map.virt = NULL;\r\n}\r\nkfree(up);\r\nreturn 0;\r\n}

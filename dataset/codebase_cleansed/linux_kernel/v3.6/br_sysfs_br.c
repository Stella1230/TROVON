static ssize_t store_bridge_parm(struct device *d,\r\nconst char *buf, size_t len,\r\nint (*set)(struct net_bridge *, unsigned long))\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nchar *endp;\r\nunsigned long val;\r\nint err;\r\nif (!capable(CAP_NET_ADMIN))\r\nreturn -EPERM;\r\nval = simple_strtoul(buf, &endp, 0);\r\nif (endp == buf)\r\nreturn -EINVAL;\r\nerr = (*set)(br, val);\r\nreturn err ? err : len;\r\n}\r\nstatic ssize_t show_forward_delay(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nreturn sprintf(buf, "%lu\n", jiffies_to_clock_t(br->forward_delay));\r\n}\r\nstatic ssize_t store_forward_delay(struct device *d,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nreturn store_bridge_parm(d, buf, len, br_set_forward_delay);\r\n}\r\nstatic ssize_t show_hello_time(struct device *d, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn sprintf(buf, "%lu\n",\r\njiffies_to_clock_t(to_bridge(d)->hello_time));\r\n}\r\nstatic ssize_t store_hello_time(struct device *d,\r\nstruct device_attribute *attr, const char *buf,\r\nsize_t len)\r\n{\r\nreturn store_bridge_parm(d, buf, len, br_set_hello_time);\r\n}\r\nstatic ssize_t show_max_age(struct device *d, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn sprintf(buf, "%lu\n",\r\njiffies_to_clock_t(to_bridge(d)->max_age));\r\n}\r\nstatic ssize_t store_max_age(struct device *d, struct device_attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nreturn store_bridge_parm(d, buf, len, br_set_max_age);\r\n}\r\nstatic ssize_t show_ageing_time(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nreturn sprintf(buf, "%lu\n", jiffies_to_clock_t(br->ageing_time));\r\n}\r\nstatic int set_ageing_time(struct net_bridge *br, unsigned long val)\r\n{\r\nbr->ageing_time = clock_t_to_jiffies(val);\r\nreturn 0;\r\n}\r\nstatic ssize_t store_ageing_time(struct device *d,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nreturn store_bridge_parm(d, buf, len, set_ageing_time);\r\n}\r\nstatic ssize_t show_stp_state(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nreturn sprintf(buf, "%d\n", br->stp_enabled);\r\n}\r\nstatic ssize_t store_stp_state(struct device *d,\r\nstruct device_attribute *attr, const char *buf,\r\nsize_t len)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nchar *endp;\r\nunsigned long val;\r\nif (!capable(CAP_NET_ADMIN))\r\nreturn -EPERM;\r\nval = simple_strtoul(buf, &endp, 0);\r\nif (endp == buf)\r\nreturn -EINVAL;\r\nif (!rtnl_trylock())\r\nreturn restart_syscall();\r\nbr_stp_set_enabled(br, val);\r\nrtnl_unlock();\r\nreturn len;\r\n}\r\nstatic ssize_t show_group_fwd_mask(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nreturn sprintf(buf, "%#x\n", br->group_fwd_mask);\r\n}\r\nstatic ssize_t store_group_fwd_mask(struct device *d,\r\nstruct device_attribute *attr, const char *buf,\r\nsize_t len)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nchar *endp;\r\nunsigned long val;\r\nif (!capable(CAP_NET_ADMIN))\r\nreturn -EPERM;\r\nval = simple_strtoul(buf, &endp, 0);\r\nif (endp == buf)\r\nreturn -EINVAL;\r\nif (val & BR_GROUPFWD_RESTRICTED)\r\nreturn -EINVAL;\r\nbr->group_fwd_mask = val;\r\nreturn len;\r\n}\r\nstatic ssize_t show_priority(struct device *d, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nreturn sprintf(buf, "%d\n",\r\n(br->bridge_id.prio[0] << 8) | br->bridge_id.prio[1]);\r\n}\r\nstatic int set_priority(struct net_bridge *br, unsigned long val)\r\n{\r\nbr_stp_set_bridge_priority(br, (u16) val);\r\nreturn 0;\r\n}\r\nstatic ssize_t store_priority(struct device *d, struct device_attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nreturn store_bridge_parm(d, buf, len, set_priority);\r\n}\r\nstatic ssize_t show_root_id(struct device *d, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn br_show_bridge_id(buf, &to_bridge(d)->designated_root);\r\n}\r\nstatic ssize_t show_bridge_id(struct device *d, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn br_show_bridge_id(buf, &to_bridge(d)->bridge_id);\r\n}\r\nstatic ssize_t show_root_port(struct device *d, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn sprintf(buf, "%d\n", to_bridge(d)->root_port);\r\n}\r\nstatic ssize_t show_root_path_cost(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "%d\n", to_bridge(d)->root_path_cost);\r\n}\r\nstatic ssize_t show_topology_change(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "%d\n", to_bridge(d)->topology_change);\r\n}\r\nstatic ssize_t show_topology_change_detected(struct device *d,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nreturn sprintf(buf, "%d\n", br->topology_change_detected);\r\n}\r\nstatic ssize_t show_hello_timer(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nreturn sprintf(buf, "%ld\n", br_timer_value(&br->hello_timer));\r\n}\r\nstatic ssize_t show_tcn_timer(struct device *d, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nreturn sprintf(buf, "%ld\n", br_timer_value(&br->tcn_timer));\r\n}\r\nstatic ssize_t show_topology_change_timer(struct device *d,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nreturn sprintf(buf, "%ld\n", br_timer_value(&br->topology_change_timer));\r\n}\r\nstatic ssize_t show_gc_timer(struct device *d, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nreturn sprintf(buf, "%ld\n", br_timer_value(&br->gc_timer));\r\n}\r\nstatic ssize_t show_group_addr(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nreturn sprintf(buf, "%x:%x:%x:%x:%x:%x\n",\r\nbr->group_addr[0], br->group_addr[1],\r\nbr->group_addr[2], br->group_addr[3],\r\nbr->group_addr[4], br->group_addr[5]);\r\n}\r\nstatic ssize_t store_group_addr(struct device *d,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nunsigned int new_addr[6];\r\nint i;\r\nif (!capable(CAP_NET_ADMIN))\r\nreturn -EPERM;\r\nif (sscanf(buf, "%x:%x:%x:%x:%x:%x",\r\n&new_addr[0], &new_addr[1], &new_addr[2],\r\n&new_addr[3], &new_addr[4], &new_addr[5]) != 6)\r\nreturn -EINVAL;\r\nfor (i = 0; i < 5; i++)\r\nif (new_addr[i] != br_group_address[i])\r\nreturn -EINVAL;\r\nif (new_addr[5] & ~0xf)\r\nreturn -EINVAL;\r\nif (new_addr[5] == 1 ||\r\nnew_addr[5] == 2 ||\r\nnew_addr[5] == 3)\r\nreturn -EINVAL;\r\nspin_lock_bh(&br->lock);\r\nfor (i = 0; i < 6; i++)\r\nbr->group_addr[i] = new_addr[i];\r\nspin_unlock_bh(&br->lock);\r\nreturn len;\r\n}\r\nstatic ssize_t store_flush(struct device *d,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nif (!capable(CAP_NET_ADMIN))\r\nreturn -EPERM;\r\nbr_fdb_flush(br);\r\nreturn len;\r\n}\r\nstatic ssize_t show_multicast_router(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nreturn sprintf(buf, "%d\n", br->multicast_router);\r\n}\r\nstatic ssize_t store_multicast_router(struct device *d,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nreturn store_bridge_parm(d, buf, len, br_multicast_set_router);\r\n}\r\nstatic ssize_t show_multicast_snooping(struct device *d,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nreturn sprintf(buf, "%d\n", !br->multicast_disabled);\r\n}\r\nstatic ssize_t store_multicast_snooping(struct device *d,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nreturn store_bridge_parm(d, buf, len, br_multicast_toggle);\r\n}\r\nstatic ssize_t show_multicast_querier(struct device *d,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nreturn sprintf(buf, "%d\n", br->multicast_querier);\r\n}\r\nstatic ssize_t store_multicast_querier(struct device *d,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nreturn store_bridge_parm(d, buf, len, br_multicast_set_querier);\r\n}\r\nstatic ssize_t show_hash_elasticity(struct device *d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nreturn sprintf(buf, "%u\n", br->hash_elasticity);\r\n}\r\nstatic int set_elasticity(struct net_bridge *br, unsigned long val)\r\n{\r\nbr->hash_elasticity = val;\r\nreturn 0;\r\n}\r\nstatic ssize_t store_hash_elasticity(struct device *d,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nreturn store_bridge_parm(d, buf, len, set_elasticity);\r\n}\r\nstatic ssize_t show_hash_max(struct device *d, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nreturn sprintf(buf, "%u\n", br->hash_max);\r\n}\r\nstatic ssize_t store_hash_max(struct device *d, struct device_attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nreturn store_bridge_parm(d, buf, len, br_multicast_set_hash_max);\r\n}\r\nstatic ssize_t show_multicast_last_member_count(struct device *d,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nreturn sprintf(buf, "%u\n", br->multicast_last_member_count);\r\n}\r\nstatic int set_last_member_count(struct net_bridge *br, unsigned long val)\r\n{\r\nbr->multicast_last_member_count = val;\r\nreturn 0;\r\n}\r\nstatic ssize_t store_multicast_last_member_count(struct device *d,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nreturn store_bridge_parm(d, buf, len, set_last_member_count);\r\n}\r\nstatic ssize_t show_multicast_startup_query_count(\r\nstruct device *d, struct device_attribute *attr, char *buf)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nreturn sprintf(buf, "%u\n", br->multicast_startup_query_count);\r\n}\r\nstatic int set_startup_query_count(struct net_bridge *br, unsigned long val)\r\n{\r\nbr->multicast_startup_query_count = val;\r\nreturn 0;\r\n}\r\nstatic ssize_t store_multicast_startup_query_count(\r\nstruct device *d, struct device_attribute *attr, const char *buf,\r\nsize_t len)\r\n{\r\nreturn store_bridge_parm(d, buf, len, set_startup_query_count);\r\n}\r\nstatic ssize_t show_multicast_last_member_interval(\r\nstruct device *d, struct device_attribute *attr, char *buf)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nreturn sprintf(buf, "%lu\n",\r\njiffies_to_clock_t(br->multicast_last_member_interval));\r\n}\r\nstatic int set_last_member_interval(struct net_bridge *br, unsigned long val)\r\n{\r\nbr->multicast_last_member_interval = clock_t_to_jiffies(val);\r\nreturn 0;\r\n}\r\nstatic ssize_t store_multicast_last_member_interval(\r\nstruct device *d, struct device_attribute *attr, const char *buf,\r\nsize_t len)\r\n{\r\nreturn store_bridge_parm(d, buf, len, set_last_member_interval);\r\n}\r\nstatic ssize_t show_multicast_membership_interval(\r\nstruct device *d, struct device_attribute *attr, char *buf)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nreturn sprintf(buf, "%lu\n",\r\njiffies_to_clock_t(br->multicast_membership_interval));\r\n}\r\nstatic int set_membership_interval(struct net_bridge *br, unsigned long val)\r\n{\r\nbr->multicast_membership_interval = clock_t_to_jiffies(val);\r\nreturn 0;\r\n}\r\nstatic ssize_t store_multicast_membership_interval(\r\nstruct device *d, struct device_attribute *attr, const char *buf,\r\nsize_t len)\r\n{\r\nreturn store_bridge_parm(d, buf, len, set_membership_interval);\r\n}\r\nstatic ssize_t show_multicast_querier_interval(struct device *d,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nreturn sprintf(buf, "%lu\n",\r\njiffies_to_clock_t(br->multicast_querier_interval));\r\n}\r\nstatic int set_querier_interval(struct net_bridge *br, unsigned long val)\r\n{\r\nbr->multicast_querier_interval = clock_t_to_jiffies(val);\r\nreturn 0;\r\n}\r\nstatic ssize_t store_multicast_querier_interval(struct device *d,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nreturn store_bridge_parm(d, buf, len, set_querier_interval);\r\n}\r\nstatic ssize_t show_multicast_query_interval(struct device *d,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nreturn sprintf(buf, "%lu\n",\r\njiffies_to_clock_t(br->multicast_query_interval));\r\n}\r\nstatic int set_query_interval(struct net_bridge *br, unsigned long val)\r\n{\r\nbr->multicast_query_interval = clock_t_to_jiffies(val);\r\nreturn 0;\r\n}\r\nstatic ssize_t store_multicast_query_interval(struct device *d,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nreturn store_bridge_parm(d, buf, len, set_query_interval);\r\n}\r\nstatic ssize_t show_multicast_query_response_interval(\r\nstruct device *d, struct device_attribute *attr, char *buf)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nreturn sprintf(\r\nbuf, "%lu\n",\r\njiffies_to_clock_t(br->multicast_query_response_interval));\r\n}\r\nstatic int set_query_response_interval(struct net_bridge *br, unsigned long val)\r\n{\r\nbr->multicast_query_response_interval = clock_t_to_jiffies(val);\r\nreturn 0;\r\n}\r\nstatic ssize_t store_multicast_query_response_interval(\r\nstruct device *d, struct device_attribute *attr, const char *buf,\r\nsize_t len)\r\n{\r\nreturn store_bridge_parm(d, buf, len, set_query_response_interval);\r\n}\r\nstatic ssize_t show_multicast_startup_query_interval(\r\nstruct device *d, struct device_attribute *attr, char *buf)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nreturn sprintf(\r\nbuf, "%lu\n",\r\njiffies_to_clock_t(br->multicast_startup_query_interval));\r\n}\r\nstatic int set_startup_query_interval(struct net_bridge *br, unsigned long val)\r\n{\r\nbr->multicast_startup_query_interval = clock_t_to_jiffies(val);\r\nreturn 0;\r\n}\r\nstatic ssize_t store_multicast_startup_query_interval(\r\nstruct device *d, struct device_attribute *attr, const char *buf,\r\nsize_t len)\r\n{\r\nreturn store_bridge_parm(d, buf, len, set_startup_query_interval);\r\n}\r\nstatic ssize_t show_nf_call_iptables(\r\nstruct device *d, struct device_attribute *attr, char *buf)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nreturn sprintf(buf, "%u\n", br->nf_call_iptables);\r\n}\r\nstatic int set_nf_call_iptables(struct net_bridge *br, unsigned long val)\r\n{\r\nbr->nf_call_iptables = val ? true : false;\r\nreturn 0;\r\n}\r\nstatic ssize_t store_nf_call_iptables(\r\nstruct device *d, struct device_attribute *attr, const char *buf,\r\nsize_t len)\r\n{\r\nreturn store_bridge_parm(d, buf, len, set_nf_call_iptables);\r\n}\r\nstatic ssize_t show_nf_call_ip6tables(\r\nstruct device *d, struct device_attribute *attr, char *buf)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nreturn sprintf(buf, "%u\n", br->nf_call_ip6tables);\r\n}\r\nstatic int set_nf_call_ip6tables(struct net_bridge *br, unsigned long val)\r\n{\r\nbr->nf_call_ip6tables = val ? true : false;\r\nreturn 0;\r\n}\r\nstatic ssize_t store_nf_call_ip6tables(\r\nstruct device *d, struct device_attribute *attr, const char *buf,\r\nsize_t len)\r\n{\r\nreturn store_bridge_parm(d, buf, len, set_nf_call_ip6tables);\r\n}\r\nstatic ssize_t show_nf_call_arptables(\r\nstruct device *d, struct device_attribute *attr, char *buf)\r\n{\r\nstruct net_bridge *br = to_bridge(d);\r\nreturn sprintf(buf, "%u\n", br->nf_call_arptables);\r\n}\r\nstatic int set_nf_call_arptables(struct net_bridge *br, unsigned long val)\r\n{\r\nbr->nf_call_arptables = val ? true : false;\r\nreturn 0;\r\n}\r\nstatic ssize_t store_nf_call_arptables(\r\nstruct device *d, struct device_attribute *attr, const char *buf,\r\nsize_t len)\r\n{\r\nreturn store_bridge_parm(d, buf, len, set_nf_call_arptables);\r\n}\r\nstatic ssize_t brforward_read(struct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *bin_attr,\r\nchar *buf, loff_t off, size_t count)\r\n{\r\nstruct device *dev = to_dev(kobj);\r\nstruct net_bridge *br = to_bridge(dev);\r\nint n;\r\nif (off % sizeof(struct __fdb_entry) != 0)\r\nreturn -EINVAL;\r\nn = br_fdb_fillbuf(br, buf,\r\ncount / sizeof(struct __fdb_entry),\r\noff / sizeof(struct __fdb_entry));\r\nif (n > 0)\r\nn *= sizeof(struct __fdb_entry);\r\nreturn n;\r\n}\r\nint br_sysfs_addbr(struct net_device *dev)\r\n{\r\nstruct kobject *brobj = &dev->dev.kobj;\r\nstruct net_bridge *br = netdev_priv(dev);\r\nint err;\r\nerr = sysfs_create_group(brobj, &bridge_group);\r\nif (err) {\r\npr_info("%s: can't create group %s/%s\n",\r\n__func__, dev->name, bridge_group.name);\r\ngoto out1;\r\n}\r\nerr = sysfs_create_bin_file(brobj, &bridge_forward);\r\nif (err) {\r\npr_info("%s: can't create attribute file %s/%s\n",\r\n__func__, dev->name, bridge_forward.attr.name);\r\ngoto out2;\r\n}\r\nbr->ifobj = kobject_create_and_add(SYSFS_BRIDGE_PORT_SUBDIR, brobj);\r\nif (!br->ifobj) {\r\npr_info("%s: can't add kobject (directory) %s/%s\n",\r\n__func__, dev->name, SYSFS_BRIDGE_PORT_SUBDIR);\r\ngoto out3;\r\n}\r\nreturn 0;\r\nout3:\r\nsysfs_remove_bin_file(&dev->dev.kobj, &bridge_forward);\r\nout2:\r\nsysfs_remove_group(&dev->dev.kobj, &bridge_group);\r\nout1:\r\nreturn err;\r\n}\r\nvoid br_sysfs_delbr(struct net_device *dev)\r\n{\r\nstruct kobject *kobj = &dev->dev.kobj;\r\nstruct net_bridge *br = netdev_priv(dev);\r\nkobject_put(br->ifobj);\r\nsysfs_remove_bin_file(kobj, &bridge_forward);\r\nsysfs_remove_group(kobj, &bridge_group);\r\n}

bool\r\nnvc0_vram_flags_valid(struct drm_device *dev, u32 tile_flags)\r\n{\r\nu8 memtype = (tile_flags & NOUVEAU_GEM_TILE_LAYOUT_MASK) >> 8;\r\nreturn likely((types[memtype] == 1));\r\n}\r\nint\r\nnvc0_vram_new(struct drm_device *dev, u64 size, u32 align, u32 ncmin,\r\nu32 type, struct nouveau_mem **pmem)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_mm *mm = &dev_priv->engine.vram.mm;\r\nstruct nouveau_mm_node *r;\r\nstruct nouveau_mem *mem;\r\nint ret;\r\nsize >>= 12;\r\nalign >>= 12;\r\nncmin >>= 12;\r\nmem = kzalloc(sizeof(*mem), GFP_KERNEL);\r\nif (!mem)\r\nreturn -ENOMEM;\r\nINIT_LIST_HEAD(&mem->regions);\r\nmem->dev = dev_priv->dev;\r\nmem->memtype = (type & 0xff);\r\nmem->size = size;\r\nmutex_lock(&mm->mutex);\r\ndo {\r\nret = nouveau_mm_get(mm, 1, size, ncmin, align, &r);\r\nif (ret) {\r\nmutex_unlock(&mm->mutex);\r\nnv50_vram_del(dev, &mem);\r\nreturn ret;\r\n}\r\nlist_add_tail(&r->rl_entry, &mem->regions);\r\nsize -= r->length;\r\n} while (size);\r\nmutex_unlock(&mm->mutex);\r\nr = list_first_entry(&mem->regions, struct nouveau_mm_node, rl_entry);\r\nmem->offset = (u64)r->offset << 12;\r\n*pmem = mem;\r\nreturn 0;\r\n}\r\nint\r\nnvc0_vram_init(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_vram_engine *vram = &dev_priv->engine.vram;\r\nconst u32 rsvd_head = ( 256 * 1024) >> 12;\r\nconst u32 rsvd_tail = (1024 * 1024) >> 12;\r\nu32 parts = nv_rd32(dev, 0x022438);\r\nu32 pmask = nv_rd32(dev, 0x022554);\r\nu32 bsize = nv_rd32(dev, 0x10f20c);\r\nu32 offset, length;\r\nbool uniform = true;\r\nint ret, part;\r\nNV_DEBUG(dev, "0x100800: 0x%08x\n", nv_rd32(dev, 0x100800));\r\nNV_DEBUG(dev, "parts 0x%08x mask 0x%08x\n", parts, pmask);\r\ndev_priv->vram_type = nouveau_mem_vbios_type(dev);\r\ndev_priv->vram_rank_B = !!(nv_rd32(dev, 0x10f200) & 0x00000004);\r\nfor (part = 0; part < parts; part++) {\r\nif (!(pmask & (1 << part))) {\r\nu32 psize = nv_rd32(dev, 0x11020c + (part * 0x1000));\r\nif (psize != bsize) {\r\nif (psize < bsize)\r\nbsize = psize;\r\nuniform = false;\r\n}\r\nNV_DEBUG(dev, "%d: mem_amount 0x%08x\n", part, psize);\r\ndev_priv->vram_size += (u64)psize << 20;\r\n}\r\n}\r\nif (uniform) {\r\noffset = rsvd_head;\r\nlength = (dev_priv->vram_size >> 12) - rsvd_head - rsvd_tail;\r\nreturn nouveau_mm_init(&vram->mm, offset, length, 1);\r\n}\r\nret = nouveau_mm_init(&vram->mm, rsvd_head, (bsize << 8) * parts, 1);\r\nif (ret)\r\nreturn ret;\r\noffset = (0x0200000000ULL >> 12) + (bsize << 8);\r\nlength = (dev_priv->vram_size >> 12) - (bsize << 8) - rsvd_tail;\r\nret = nouveau_mm_init(&vram->mm, offset, length, 0);\r\nif (ret) {\r\nnouveau_mm_fini(&vram->mm);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}

static void auok1901_init(struct auok190xfb_par *par)\r\n{\r\nstruct auok190x_board *board = par->board;\r\nu16 init_param = 0;\r\ninit_param |= AUOK190X_INIT_INVERSE_WHITE;\r\ninit_param |= AUOK190X_INIT_FORMAT0;\r\ninit_param |= AUOK1901_INIT_RESOLUTION(par->resolution);\r\ninit_param |= AUOK190X_INIT_SHIFT_LEFT;\r\nauok190x_send_cmdargs(par, AUOK190X_CMD_INIT, 1, &init_param);\r\nboard->wait_for_rdy(par);\r\n}\r\nstatic void auok1901_update_region(struct auok190xfb_par *par, int mode,\r\nu16 y1, u16 y2)\r\n{\r\nstruct device *dev = par->info->device;\r\nunsigned char *buf = (unsigned char *)par->info->screen_base;\r\nint xres = par->info->var.xres;\r\nu16 args[5];\r\npm_runtime_get_sync(dev);\r\nmutex_lock(&(par->io_lock));\r\ny1 &= 0xfffe;\r\ny2 &= 0xfffe;\r\ndev_dbg(dev, "update (x,y,w,h,mode)=(%d,%d,%d,%d,%d)\n",\r\n1, y1+1, xres, y2-y1, mode);\r\nargs[0] = AUOK1901_DMA_ROTATE90(par->rotation) | 1;\r\nargs[1] = y1 + 1;\r\nargs[2] = xres;\r\nargs[3] = y2 - y1;\r\nbuf += y1 * xres;\r\nauok190x_send_cmdargs_pixels_nowait(par, AUOK1901_CMD_DMA_START, 4,\r\nargs, ((y2 - y1) * xres)/2,\r\n(u16 *) buf);\r\nauok190x_send_command_nowait(par, AUOK190X_CMD_DATA_STOP);\r\nargs[0] = mode | AUOK1901_DDMA_ROTATE180(par->rotation);\r\nargs[1] = 1;\r\nargs[2] = y1 + 1;\r\nargs[3] = xres;\r\nargs[4] = y2 - y1;\r\nauok190x_send_cmdargs_nowait(par, AUOK1901_CMD_DDMA_START, 5, args);\r\npar->update_cnt++;\r\nmutex_unlock(&(par->io_lock));\r\npm_runtime_mark_last_busy(dev);\r\npm_runtime_put_autosuspend(dev);\r\n}\r\nstatic void auok1901fb_dpy_update_pages(struct auok190xfb_par *par,\r\nu16 y1, u16 y2)\r\n{\r\nint mode;\r\nif (par->update_mode < 0) {\r\nmode = AUOK190X_UPDATE_MODE(1);\r\npar->last_mode = -1;\r\n} else {\r\nmode = AUOK190X_UPDATE_MODE(par->update_mode);\r\npar->last_mode = par->update_mode;\r\n}\r\nif (par->flash)\r\nmode |= AUOK190X_UPDATE_NONFLASH;\r\nauok1901_update_region(par, mode, y1, y2);\r\n}\r\nstatic void auok1901fb_dpy_update(struct auok190xfb_par *par)\r\n{\r\nint mode;\r\npar->board->wait_for_rdy(par);\r\nif (par->update_mode < 0) {\r\nmode = AUOK190X_UPDATE_MODE(0);\r\npar->last_mode = -1;\r\n} else {\r\nmode = AUOK190X_UPDATE_MODE(par->update_mode);\r\npar->last_mode = par->update_mode;\r\n}\r\nif (par->flash)\r\nmode |= AUOK190X_UPDATE_NONFLASH;\r\nauok1901_update_region(par, mode, 0, par->info->var.yres);\r\npar->update_cnt = 0;\r\n}\r\nstatic bool auok1901fb_need_refresh(struct auok190xfb_par *par)\r\n{\r\nreturn (par->update_cnt > 10);\r\n}\r\nstatic int __devinit auok1901fb_probe(struct platform_device *pdev)\r\n{\r\nstruct auok190x_init_data init;\r\nstruct auok190x_board *board;\r\nboard = pdev->dev.platform_data;\r\nif (!board)\r\nreturn -EINVAL;\r\ninit.id = "auo_k1901fb";\r\ninit.board = board;\r\ninit.update_partial = auok1901fb_dpy_update_pages;\r\ninit.update_all = auok1901fb_dpy_update;\r\ninit.need_refresh = auok1901fb_need_refresh;\r\ninit.init = auok1901_init;\r\nreturn auok190x_common_probe(pdev, &init);\r\n}\r\nstatic int __devexit auok1901fb_remove(struct platform_device *pdev)\r\n{\r\nreturn auok190x_common_remove(pdev);\r\n}

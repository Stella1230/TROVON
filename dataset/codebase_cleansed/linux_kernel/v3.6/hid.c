static int __init do_config(struct usb_configuration *c)\r\n{\r\nstruct hidg_func_node *e;\r\nint func = 0, status = 0;\r\nif (gadget_is_otg(c->cdev->gadget)) {\r\nc->descriptors = otg_desc;\r\nc->bmAttributes |= USB_CONFIG_ATT_WAKEUP;\r\n}\r\nlist_for_each_entry(e, &hidg_func_list, node) {\r\nstatus = hidg_bind_config(c, e->func, func++);\r\nif (status)\r\nbreak;\r\n}\r\nreturn status;\r\n}\r\nstatic int __init hid_bind(struct usb_composite_dev *cdev)\r\n{\r\nstruct usb_gadget *gadget = cdev->gadget;\r\nstruct list_head *tmp;\r\nint status, gcnum, funcs = 0;\r\nlist_for_each(tmp, &hidg_func_list)\r\nfuncs++;\r\nif (!funcs)\r\nreturn -ENODEV;\r\nstatus = ghid_setup(cdev->gadget, funcs);\r\nif (status < 0)\r\nreturn status;\r\ngcnum = usb_gadget_controller_number(gadget);\r\nif (gcnum >= 0)\r\ndevice_desc.bcdDevice = cpu_to_le16(0x0300 | gcnum);\r\nelse\r\ndevice_desc.bcdDevice = cpu_to_le16(0x0300 | 0x0099);\r\nsnprintf(manufacturer, sizeof manufacturer, "%s %s with %s",\r\ninit_utsname()->sysname, init_utsname()->release,\r\ngadget->name);\r\nstatus = usb_string_id(cdev);\r\nif (status < 0)\r\nreturn status;\r\nstrings_dev[STRING_MANUFACTURER_IDX].id = status;\r\ndevice_desc.iManufacturer = status;\r\nstatus = usb_string_id(cdev);\r\nif (status < 0)\r\nreturn status;\r\nstrings_dev[STRING_PRODUCT_IDX].id = status;\r\ndevice_desc.iProduct = status;\r\nstatus = usb_add_config(cdev, &config_driver, do_config);\r\nif (status < 0)\r\nreturn status;\r\ndev_info(&gadget->dev, DRIVER_DESC ", version: " DRIVER_VERSION "\n");\r\nreturn 0;\r\n}\r\nstatic int __exit hid_unbind(struct usb_composite_dev *cdev)\r\n{\r\nghid_cleanup();\r\nreturn 0;\r\n}\r\nstatic int __init hidg_plat_driver_probe(struct platform_device *pdev)\r\n{\r\nstruct hidg_func_descriptor *func = pdev->dev.platform_data;\r\nstruct hidg_func_node *entry;\r\nif (!func) {\r\ndev_err(&pdev->dev, "Platform data missing\n");\r\nreturn -ENODEV;\r\n}\r\nentry = kzalloc(sizeof(*entry), GFP_KERNEL);\r\nif (!entry)\r\nreturn -ENOMEM;\r\nentry->func = func;\r\nlist_add_tail(&entry->node, &hidg_func_list);\r\nreturn 0;\r\n}\r\nstatic int __devexit hidg_plat_driver_remove(struct platform_device *pdev)\r\n{\r\nstruct hidg_func_node *e, *n;\r\nlist_for_each_entry_safe(e, n, &hidg_func_list, node) {\r\nlist_del(&e->node);\r\nkfree(e);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init hidg_init(void)\r\n{\r\nint status;\r\nstatus = platform_driver_probe(&hidg_plat_driver,\r\nhidg_plat_driver_probe);\r\nif (status < 0)\r\nreturn status;\r\nstatus = usb_composite_probe(&hidg_driver, hid_bind);\r\nif (status < 0)\r\nplatform_driver_unregister(&hidg_plat_driver);\r\nreturn status;\r\n}\r\nstatic void __exit hidg_cleanup(void)\r\n{\r\nplatform_driver_unregister(&hidg_plat_driver);\r\nusb_composite_unregister(&hidg_driver);\r\n}

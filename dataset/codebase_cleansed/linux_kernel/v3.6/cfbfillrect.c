static void\r\nbitfill_aligned(struct fb_info *p, unsigned long __iomem *dst, int dst_idx,\r\nunsigned long pat, unsigned n, int bits, u32 bswapmask)\r\n{\r\nunsigned long first, last;\r\nif (!n)\r\nreturn;\r\nfirst = fb_shifted_pixels_mask_long(p, dst_idx, bswapmask);\r\nlast = ~fb_shifted_pixels_mask_long(p, (dst_idx+n) % bits, bswapmask);\r\nif (dst_idx+n <= bits) {\r\nif (last)\r\nfirst &= last;\r\nFB_WRITEL(comp(pat, FB_READL(dst), first), dst);\r\n} else {\r\nif (first!= ~0UL) {\r\nFB_WRITEL(comp(pat, FB_READL(dst), first), dst);\r\ndst++;\r\nn -= bits - dst_idx;\r\n}\r\nn /= bits;\r\nwhile (n >= 8) {\r\nFB_WRITEL(pat, dst++);\r\nFB_WRITEL(pat, dst++);\r\nFB_WRITEL(pat, dst++);\r\nFB_WRITEL(pat, dst++);\r\nFB_WRITEL(pat, dst++);\r\nFB_WRITEL(pat, dst++);\r\nFB_WRITEL(pat, dst++);\r\nFB_WRITEL(pat, dst++);\r\nn -= 8;\r\n}\r\nwhile (n--)\r\nFB_WRITEL(pat, dst++);\r\nif (last)\r\nFB_WRITEL(comp(pat, FB_READL(dst), last), dst);\r\n}\r\n}\r\nstatic void\r\nbitfill_unaligned(struct fb_info *p, unsigned long __iomem *dst, int dst_idx,\r\nunsigned long pat, int left, int right, unsigned n, int bits)\r\n{\r\nunsigned long first, last;\r\nif (!n)\r\nreturn;\r\nfirst = FB_SHIFT_HIGH(p, ~0UL, dst_idx);\r\nlast = ~(FB_SHIFT_HIGH(p, ~0UL, (dst_idx+n) % bits));\r\nif (dst_idx+n <= bits) {\r\nif (last)\r\nfirst &= last;\r\nFB_WRITEL(comp(pat, FB_READL(dst), first), dst);\r\n} else {\r\nif (first) {\r\nFB_WRITEL(comp(pat, FB_READL(dst), first), dst);\r\ndst++;\r\npat = pat << left | pat >> right;\r\nn -= bits - dst_idx;\r\n}\r\nn /= bits;\r\nwhile (n >= 4) {\r\nFB_WRITEL(pat, dst++);\r\npat = pat << left | pat >> right;\r\nFB_WRITEL(pat, dst++);\r\npat = pat << left | pat >> right;\r\nFB_WRITEL(pat, dst++);\r\npat = pat << left | pat >> right;\r\nFB_WRITEL(pat, dst++);\r\npat = pat << left | pat >> right;\r\nn -= 4;\r\n}\r\nwhile (n--) {\r\nFB_WRITEL(pat, dst++);\r\npat = pat << left | pat >> right;\r\n}\r\nif (last)\r\nFB_WRITEL(comp(pat, FB_READL(dst), last), dst);\r\n}\r\n}\r\nstatic void\r\nbitfill_aligned_rev(struct fb_info *p, unsigned long __iomem *dst,\r\nint dst_idx, unsigned long pat, unsigned n, int bits,\r\nu32 bswapmask)\r\n{\r\nunsigned long val = pat, dat;\r\nunsigned long first, last;\r\nif (!n)\r\nreturn;\r\nfirst = fb_shifted_pixels_mask_long(p, dst_idx, bswapmask);\r\nlast = ~fb_shifted_pixels_mask_long(p, (dst_idx+n) % bits, bswapmask);\r\nif (dst_idx+n <= bits) {\r\nif (last)\r\nfirst &= last;\r\ndat = FB_READL(dst);\r\nFB_WRITEL(comp(dat ^ val, dat, first), dst);\r\n} else {\r\nif (first!=0UL) {\r\ndat = FB_READL(dst);\r\nFB_WRITEL(comp(dat ^ val, dat, first), dst);\r\ndst++;\r\nn -= bits - dst_idx;\r\n}\r\nn /= bits;\r\nwhile (n >= 8) {\r\nFB_WRITEL(FB_READL(dst) ^ val, dst);\r\ndst++;\r\nFB_WRITEL(FB_READL(dst) ^ val, dst);\r\ndst++;\r\nFB_WRITEL(FB_READL(dst) ^ val, dst);\r\ndst++;\r\nFB_WRITEL(FB_READL(dst) ^ val, dst);\r\ndst++;\r\nFB_WRITEL(FB_READL(dst) ^ val, dst);\r\ndst++;\r\nFB_WRITEL(FB_READL(dst) ^ val, dst);\r\ndst++;\r\nFB_WRITEL(FB_READL(dst) ^ val, dst);\r\ndst++;\r\nFB_WRITEL(FB_READL(dst) ^ val, dst);\r\ndst++;\r\nn -= 8;\r\n}\r\nwhile (n--) {\r\nFB_WRITEL(FB_READL(dst) ^ val, dst);\r\ndst++;\r\n}\r\nif (last) {\r\ndat = FB_READL(dst);\r\nFB_WRITEL(comp(dat ^ val, dat, last), dst);\r\n}\r\n}\r\n}\r\nstatic void\r\nbitfill_unaligned_rev(struct fb_info *p, unsigned long __iomem *dst,\r\nint dst_idx, unsigned long pat, int left, int right,\r\nunsigned n, int bits)\r\n{\r\nunsigned long first, last, dat;\r\nif (!n)\r\nreturn;\r\nfirst = FB_SHIFT_HIGH(p, ~0UL, dst_idx);\r\nlast = ~(FB_SHIFT_HIGH(p, ~0UL, (dst_idx+n) % bits));\r\nif (dst_idx+n <= bits) {\r\nif (last)\r\nfirst &= last;\r\ndat = FB_READL(dst);\r\nFB_WRITEL(comp(dat ^ pat, dat, first), dst);\r\n} else {\r\nif (first != 0UL) {\r\ndat = FB_READL(dst);\r\nFB_WRITEL(comp(dat ^ pat, dat, first), dst);\r\ndst++;\r\npat = pat << left | pat >> right;\r\nn -= bits - dst_idx;\r\n}\r\nn /= bits;\r\nwhile (n >= 4) {\r\nFB_WRITEL(FB_READL(dst) ^ pat, dst);\r\ndst++;\r\npat = pat << left | pat >> right;\r\nFB_WRITEL(FB_READL(dst) ^ pat, dst);\r\ndst++;\r\npat = pat << left | pat >> right;\r\nFB_WRITEL(FB_READL(dst) ^ pat, dst);\r\ndst++;\r\npat = pat << left | pat >> right;\r\nFB_WRITEL(FB_READL(dst) ^ pat, dst);\r\ndst++;\r\npat = pat << left | pat >> right;\r\nn -= 4;\r\n}\r\nwhile (n--) {\r\nFB_WRITEL(FB_READL(dst) ^ pat, dst);\r\ndst++;\r\npat = pat << left | pat >> right;\r\n}\r\nif (last) {\r\ndat = FB_READL(dst);\r\nFB_WRITEL(comp(dat ^ pat, dat, last), dst);\r\n}\r\n}\r\n}\r\nvoid cfb_fillrect(struct fb_info *p, const struct fb_fillrect *rect)\r\n{\r\nunsigned long pat, pat2, fg;\r\nunsigned long width = rect->width, height = rect->height;\r\nint bits = BITS_PER_LONG, bytes = bits >> 3;\r\nu32 bpp = p->var.bits_per_pixel;\r\nunsigned long __iomem *dst;\r\nint dst_idx, left;\r\nif (p->state != FBINFO_STATE_RUNNING)\r\nreturn;\r\nif (p->fix.visual == FB_VISUAL_TRUECOLOR ||\r\np->fix.visual == FB_VISUAL_DIRECTCOLOR )\r\nfg = ((u32 *) (p->pseudo_palette))[rect->color];\r\nelse\r\nfg = rect->color;\r\npat = pixel_to_pat(bpp, fg);\r\ndst = (unsigned long __iomem *)((unsigned long)p->screen_base & ~(bytes-1));\r\ndst_idx = ((unsigned long)p->screen_base & (bytes - 1))*8;\r\ndst_idx += rect->dy*p->fix.line_length*8+rect->dx*bpp;\r\nleft = bits % bpp;\r\nif (p->fbops->fb_sync)\r\np->fbops->fb_sync(p);\r\nif (!left) {\r\nu32 bswapmask = fb_compute_bswapmask(p);\r\nvoid (*fill_op32)(struct fb_info *p,\r\nunsigned long __iomem *dst, int dst_idx,\r\nunsigned long pat, unsigned n, int bits,\r\nu32 bswapmask) = NULL;\r\nswitch (rect->rop) {\r\ncase ROP_XOR:\r\nfill_op32 = bitfill_aligned_rev;\r\nbreak;\r\ncase ROP_COPY:\r\nfill_op32 = bitfill_aligned;\r\nbreak;\r\ndefault:\r\nprintk( KERN_ERR "cfb_fillrect(): unknown rop, defaulting to ROP_COPY\n");\r\nfill_op32 = bitfill_aligned;\r\nbreak;\r\n}\r\nwhile (height--) {\r\ndst += dst_idx >> (ffs(bits) - 1);\r\ndst_idx &= (bits - 1);\r\nfill_op32(p, dst, dst_idx, pat, width*bpp, bits,\r\nbswapmask);\r\ndst_idx += p->fix.line_length*8;\r\n}\r\n} else {\r\nint right, r;\r\nvoid (*fill_op)(struct fb_info *p, unsigned long __iomem *dst,\r\nint dst_idx, unsigned long pat, int left,\r\nint right, unsigned n, int bits) = NULL;\r\n#ifdef __LITTLE_ENDIAN\r\nright = left;\r\nleft = bpp - right;\r\n#else\r\nright = bpp - left;\r\n#endif\r\nswitch (rect->rop) {\r\ncase ROP_XOR:\r\nfill_op = bitfill_unaligned_rev;\r\nbreak;\r\ncase ROP_COPY:\r\nfill_op = bitfill_unaligned;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "cfb_fillrect(): unknown rop, defaulting to ROP_COPY\n");\r\nfill_op = bitfill_unaligned;\r\nbreak;\r\n}\r\nwhile (height--) {\r\ndst += dst_idx / bits;\r\ndst_idx &= (bits - 1);\r\nr = dst_idx % bpp;\r\npat2 = le_long_to_cpu(rolx(cpu_to_le_long(pat), r, bpp));\r\nfill_op(p, dst, dst_idx, pat2, left, right,\r\nwidth*bpp, bits);\r\ndst_idx += p->fix.line_length*8;\r\n}\r\n}\r\n}

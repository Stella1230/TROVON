static inline u32 ltq_calc_bar11mask(void)\r\n{\r\nu32 mem, bar11mask;\r\nmem = num_physpages * PAGE_SIZE;\r\nbar11mask = (0x0ffffff0 & ~((1 << (fls(mem) - 1)) - 1)) | 8;\r\nreturn bar11mask;\r\n}\r\nstatic int __devinit ltq_pci_startup(struct platform_device *pdev)\r\n{\r\nstruct device_node *node = pdev->dev.of_node;\r\nconst __be32 *req_mask, *bus_clk;\r\nu32 temp_buffer;\r\nclk_pci = clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(clk_pci)) {\r\ndev_err(&pdev->dev, "failed to get pci clock\n");\r\nreturn PTR_ERR(clk_pci);\r\n}\r\nclk_external = clk_get(&pdev->dev, "external");\r\nif (IS_ERR(clk_external)) {\r\nclk_put(clk_pci);\r\ndev_err(&pdev->dev, "failed to get external pci clock\n");\r\nreturn PTR_ERR(clk_external);\r\n}\r\nbus_clk = of_get_property(node, "lantiq,bus-clock", NULL);\r\nif (bus_clk)\r\nclk_set_rate(clk_pci, *bus_clk);\r\nclk_enable(clk_pci);\r\nif (of_find_property(node, "lantiq,external-clock", NULL))\r\nclk_enable(clk_external);\r\nelse\r\nclk_disable(clk_external);\r\nreset_gpio = of_get_named_gpio(node, "gpio-reset", 0);\r\nif (gpio_is_valid(reset_gpio))\r\ndevm_gpio_request(&pdev->dev, reset_gpio, "pci-reset");\r\nltq_pci_w32(0xa, PCI_CR_CLK_CTRL);\r\nltq_pci_w32(ltq_pci_r32(PCI_CR_PCI_MOD) & ~(1 << 24), PCI_CR_PCI_MOD);\r\nwmb();\r\nltq_pci_cfg_w32(ltq_pci_cfg_r32(PCI_CS_STS_CMD) | 7, PCI_CS_STS_CMD);\r\ntemp_buffer = ltq_pci_r32(PCI_CR_PC_ARB);\r\nreq_mask = of_get_property(node, "req-mask", NULL);\r\nif (req_mask)\r\ntemp_buffer &= ~((*req_mask & 0xf) << 16);\r\nelse\r\ntemp_buffer &= ~0xf0000;\r\ntemp_buffer |= (1 << INTERNAL_ARB_ENABLE_BIT);\r\ntemp_buffer &= (~(3 << PCI_MASTER0_REQ_MASK_2BITS));\r\ntemp_buffer &= (~(3 << PCI_MASTER1_REQ_MASK_2BITS));\r\ntemp_buffer &= (~(3 << PCI_MASTER2_REQ_MASK_2BITS));\r\nltq_pci_w32(temp_buffer, PCI_CR_PC_ARB);\r\nwmb();\r\nltq_pci_w32(0x18000000, PCI_CR_FCI_ADDR_MAP0);\r\nltq_pci_w32(0x18400000, PCI_CR_FCI_ADDR_MAP1);\r\nltq_pci_w32(0x18800000, PCI_CR_FCI_ADDR_MAP2);\r\nltq_pci_w32(0x18c00000, PCI_CR_FCI_ADDR_MAP3);\r\nltq_pci_w32(0x19000000, PCI_CR_FCI_ADDR_MAP4);\r\nltq_pci_w32(0x19400000, PCI_CR_FCI_ADDR_MAP5);\r\nltq_pci_w32(0x19800000, PCI_CR_FCI_ADDR_MAP6);\r\nltq_pci_w32(0x19c00000, PCI_CR_FCI_ADDR_MAP7);\r\nltq_pci_w32(0x1ae00000, PCI_CR_FCI_ADDR_MAP11hg);\r\nltq_pci_w32(ltq_calc_bar11mask(), PCI_CR_BAR11MASK);\r\nltq_pci_w32(0, PCI_CR_PCI_ADDR_MAP11);\r\nltq_pci_w32(0, PCI_CS_BASE_ADDR1);\r\nltq_pci_w32(ltq_pci_r32(PCI_CR_PCI_EOI) | 3, PCI_CR_PCI_EOI);\r\nwmb();\r\nltq_pci_w32(ltq_pci_r32(PCI_CR_BAR12MASK) | 0x80000000,\r\nPCI_CR_BAR12MASK);\r\nltq_pci_w32(ltq_pci_r32(PCI_CR_BAR13MASK) | 0x80000000,\r\nPCI_CR_BAR13MASK);\r\nltq_pci_w32(0x303, PCI_CR_FCI_BURST_LENGTH);\r\nltq_pci_w32(ltq_pci_r32(PCI_CR_PCI_MOD) | (1 << 24), PCI_CR_PCI_MOD);\r\nwmb();\r\nltq_ebu_w32(ltq_ebu_r32(LTQ_EBU_PCC_CON) | 0xc, LTQ_EBU_PCC_CON);\r\nltq_ebu_w32(ltq_ebu_r32(LTQ_EBU_PCC_IEN) | 0x10, LTQ_EBU_PCC_IEN);\r\nif (gpio_is_valid(reset_gpio)) {\r\n__gpio_set_value(reset_gpio, 0);\r\nwmb();\r\nmdelay(1);\r\n__gpio_set_value(reset_gpio, 1);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devinit ltq_pci_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res_cfg, *res_bridge;\r\npci_clear_flags(PCI_PROBE_ONLY);\r\nres_cfg = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nres_bridge = platform_get_resource(pdev, IORESOURCE_MEM, 1);\r\nif (!res_cfg || !res_bridge) {\r\ndev_err(&pdev->dev, "missing memory reources\n");\r\nreturn -EINVAL;\r\n}\r\nltq_pci_membase = devm_request_and_ioremap(&pdev->dev, res_bridge);\r\nltq_pci_mapped_cfg = devm_request_and_ioremap(&pdev->dev, res_cfg);\r\nif (!ltq_pci_membase || !ltq_pci_mapped_cfg) {\r\ndev_err(&pdev->dev, "failed to remap resources\n");\r\nreturn -ENOMEM;\r\n}\r\nltq_pci_startup(pdev);\r\npci_load_of_ranges(&pci_controller, pdev->dev.of_node);\r\nregister_pci_controller(&pci_controller);\r\nreturn 0;\r\n}\r\nint __init pcibios_init(void)\r\n{\r\nint ret = platform_driver_register(&ltq_pci_driver);\r\nif (ret)\r\npr_info("pci-xway: Error registering platform driver!");\r\nreturn ret;\r\n}

static void dell_wmi_notify(u32 value, void *context)\r\n{\r\nstruct acpi_buffer response = { ACPI_ALLOCATE_BUFFER, NULL };\r\nunion acpi_object *obj;\r\nacpi_status status;\r\nstatus = wmi_get_event_data(value, &response);\r\nif (status != AE_OK) {\r\npr_info("bad event status 0x%x\n", status);\r\nreturn;\r\n}\r\nobj = (union acpi_object *)response.pointer;\r\nif (obj && obj->type == ACPI_TYPE_BUFFER) {\r\nconst struct key_entry *key;\r\nint reported_key;\r\nu16 *buffer_entry = (u16 *)obj->buffer.pointer;\r\nif (dell_new_hk_type && (buffer_entry[1] != 0x10)) {\r\npr_info("Received unknown WMI event (0x%x)\n",\r\nbuffer_entry[1]);\r\nkfree(obj);\r\nreturn;\r\n}\r\nif (dell_new_hk_type || buffer_entry[1] == 0x0)\r\nreported_key = (int)buffer_entry[2];\r\nelse\r\nreported_key = (int)buffer_entry[1] & 0xffff;\r\nkey = sparse_keymap_entry_from_scancode(dell_wmi_input_dev,\r\nreported_key);\r\nif (!key) {\r\npr_info("Unknown key %x pressed\n", reported_key);\r\n} else if ((key->keycode == KEY_BRIGHTNESSUP ||\r\nkey->keycode == KEY_BRIGHTNESSDOWN) && acpi_video) {\r\n;\r\n} else {\r\nsparse_keymap_report_entry(dell_wmi_input_dev, key,\r\n1, true);\r\n}\r\n}\r\nkfree(obj);\r\n}\r\nstatic const struct key_entry * __init dell_wmi_prepare_new_keymap(void)\r\n{\r\nint hotkey_num = (dell_bios_hotkey_table->header.length - 4) /\r\nsizeof(struct dell_bios_keymap_entry);\r\nstruct key_entry *keymap;\r\nint i;\r\nkeymap = kcalloc(hotkey_num + 1, sizeof(struct key_entry), GFP_KERNEL);\r\nif (!keymap)\r\nreturn NULL;\r\nfor (i = 0; i < hotkey_num; i++) {\r\nconst struct dell_bios_keymap_entry *bios_entry =\r\n&dell_bios_hotkey_table->keymap[i];\r\nkeymap[i].type = KE_KEY;\r\nkeymap[i].code = bios_entry->scancode;\r\nkeymap[i].keycode = bios_entry->keycode < 256 ?\r\nbios_to_linux_keycode[bios_entry->keycode] :\r\nKEY_RESERVED;\r\n}\r\nkeymap[hotkey_num].type = KE_END;\r\nreturn keymap;\r\n}\r\nstatic int __init dell_wmi_input_setup(void)\r\n{\r\nint err;\r\ndell_wmi_input_dev = input_allocate_device();\r\nif (!dell_wmi_input_dev)\r\nreturn -ENOMEM;\r\ndell_wmi_input_dev->name = "Dell WMI hotkeys";\r\ndell_wmi_input_dev->phys = "wmi/input0";\r\ndell_wmi_input_dev->id.bustype = BUS_HOST;\r\nif (dell_new_hk_type) {\r\nconst struct key_entry *keymap = dell_wmi_prepare_new_keymap();\r\nif (!keymap) {\r\nerr = -ENOMEM;\r\ngoto err_free_dev;\r\n}\r\nerr = sparse_keymap_setup(dell_wmi_input_dev, keymap, NULL);\r\nkfree(keymap);\r\n} else {\r\nerr = sparse_keymap_setup(dell_wmi_input_dev,\r\ndell_wmi_legacy_keymap, NULL);\r\n}\r\nif (err)\r\ngoto err_free_dev;\r\nerr = input_register_device(dell_wmi_input_dev);\r\nif (err)\r\ngoto err_free_keymap;\r\nreturn 0;\r\nerr_free_keymap:\r\nsparse_keymap_free(dell_wmi_input_dev);\r\nerr_free_dev:\r\ninput_free_device(dell_wmi_input_dev);\r\nreturn err;\r\n}\r\nstatic void dell_wmi_input_destroy(void)\r\n{\r\nsparse_keymap_free(dell_wmi_input_dev);\r\ninput_unregister_device(dell_wmi_input_dev);\r\n}\r\nstatic void __init find_hk_type(const struct dmi_header *dm, void *dummy)\r\n{\r\nif (dm->type == 0xb2 && dm->length > 6) {\r\ndell_new_hk_type = true;\r\ndell_bios_hotkey_table =\r\ncontainer_of(dm, struct dell_bios_hotkey_table, header);\r\n}\r\n}\r\nstatic int __init dell_wmi_init(void)\r\n{\r\nint err;\r\nacpi_status status;\r\nif (!wmi_has_guid(DELL_EVENT_GUID)) {\r\npr_warn("No known WMI GUID found\n");\r\nreturn -ENODEV;\r\n}\r\ndmi_walk(find_hk_type, NULL);\r\nacpi_video = acpi_video_backlight_support();\r\nerr = dell_wmi_input_setup();\r\nif (err)\r\nreturn err;\r\nstatus = wmi_install_notify_handler(DELL_EVENT_GUID,\r\ndell_wmi_notify, NULL);\r\nif (ACPI_FAILURE(status)) {\r\ndell_wmi_input_destroy();\r\npr_err("Unable to register notify handler - %d\n", status);\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit dell_wmi_exit(void)\r\n{\r\nwmi_remove_notify_handler(DELL_EVENT_GUID);\r\ndell_wmi_input_destroy();\r\n}

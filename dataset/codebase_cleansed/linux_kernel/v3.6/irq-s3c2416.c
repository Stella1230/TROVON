static inline void s3c2416_irq_demux(unsigned int irq, unsigned int len)\r\n{\r\nunsigned int subsrc, submsk;\r\nunsigned int end;\r\nsubsrc = __raw_readl(S3C2410_SUBSRCPND);\r\nsubmsk = __raw_readl(S3C2410_INTSUBMSK);\r\nsubsrc &= ~submsk;\r\nsubsrc >>= (irq - S3C2410_IRQSUB(0));\r\nsubsrc &= (1 << len)-1;\r\nend = len + irq;\r\nfor (; irq < end && subsrc; irq++) {\r\nif (subsrc & 1)\r\ngeneric_handle_irq(irq);\r\nsubsrc >>= 1;\r\n}\r\n}\r\nstatic void s3c2416_irq_demux_wdtac97(unsigned int irq, struct irq_desc *desc)\r\n{\r\ns3c2416_irq_demux(IRQ_S3C2443_WDT, 4);\r\n}\r\nstatic void s3c2416_irq_wdtac97_mask(struct irq_data *data)\r\n{\r\ns3c_irqsub_mask(data->irq, INTMSK_WDTAC97, SUBMSK_WDTAC97);\r\n}\r\nstatic void s3c2416_irq_wdtac97_unmask(struct irq_data *data)\r\n{\r\ns3c_irqsub_unmask(data->irq, INTMSK_WDTAC97);\r\n}\r\nstatic void s3c2416_irq_wdtac97_ack(struct irq_data *data)\r\n{\r\ns3c_irqsub_maskack(data->irq, INTMSK_WDTAC97, SUBMSK_WDTAC97);\r\n}\r\nstatic void s3c2416_irq_demux_lcd(unsigned int irq, struct irq_desc *desc)\r\n{\r\ns3c2416_irq_demux(IRQ_S3C2443_LCD1, 4);\r\n}\r\nstatic void s3c2416_irq_lcd_mask(struct irq_data *data)\r\n{\r\ns3c_irqsub_mask(data->irq, INTMSK_LCD, SUBMSK_LCD);\r\n}\r\nstatic void s3c2416_irq_lcd_unmask(struct irq_data *data)\r\n{\r\ns3c_irqsub_unmask(data->irq, INTMSK_LCD);\r\n}\r\nstatic void s3c2416_irq_lcd_ack(struct irq_data *data)\r\n{\r\ns3c_irqsub_maskack(data->irq, INTMSK_LCD, SUBMSK_LCD);\r\n}\r\nstatic void s3c2416_irq_demux_dma(unsigned int irq, struct irq_desc *desc)\r\n{\r\ns3c2416_irq_demux(IRQ_S3C2443_DMA0, 6);\r\n}\r\nstatic void s3c2416_irq_dma_mask(struct irq_data *data)\r\n{\r\ns3c_irqsub_mask(data->irq, INTMSK_DMA, SUBMSK_DMA);\r\n}\r\nstatic void s3c2416_irq_dma_unmask(struct irq_data *data)\r\n{\r\ns3c_irqsub_unmask(data->irq, INTMSK_DMA);\r\n}\r\nstatic void s3c2416_irq_dma_ack(struct irq_data *data)\r\n{\r\ns3c_irqsub_maskack(data->irq, INTMSK_DMA, SUBMSK_DMA);\r\n}\r\nstatic void s3c2416_irq_demux_uart3(unsigned int irq, struct irq_desc *desc)\r\n{\r\ns3c2416_irq_demux(IRQ_S3C2443_RX3, 3);\r\n}\r\nstatic void s3c2416_irq_uart3_mask(struct irq_data *data)\r\n{\r\ns3c_irqsub_mask(data->irq, INTMSK_UART3, SUBMSK_UART3);\r\n}\r\nstatic void s3c2416_irq_uart3_unmask(struct irq_data *data)\r\n{\r\ns3c_irqsub_unmask(data->irq, INTMSK_UART3);\r\n}\r\nstatic void s3c2416_irq_uart3_ack(struct irq_data *data)\r\n{\r\ns3c_irqsub_maskack(data->irq, INTMSK_UART3, SUBMSK_UART3);\r\n}\r\nstatic inline void s3c2416_irq_ack_second(struct irq_data *data)\r\n{\r\nunsigned long bitval = 1UL << (data->irq - IRQ_S3C2416_2D);\r\n__raw_writel(bitval, S3C2416_SRCPND2);\r\n__raw_writel(bitval, S3C2416_INTPND2);\r\n}\r\nstatic void s3c2416_irq_mask_second(struct irq_data *data)\r\n{\r\nunsigned long bitval = 1UL << (data->irq - IRQ_S3C2416_2D);\r\nunsigned long mask;\r\nmask = __raw_readl(S3C2416_INTMSK2);\r\nmask |= bitval;\r\n__raw_writel(mask, S3C2416_INTMSK2);\r\n}\r\nstatic void s3c2416_irq_unmask_second(struct irq_data *data)\r\n{\r\nunsigned long bitval = 1UL << (data->irq - IRQ_S3C2416_2D);\r\nunsigned long mask;\r\nmask = __raw_readl(S3C2416_INTMSK2);\r\nmask &= ~bitval;\r\n__raw_writel(mask, S3C2416_INTMSK2);\r\n}\r\nstatic int __init s3c2416_add_sub(unsigned int base,\r\nvoid (*demux)(unsigned int,\r\nstruct irq_desc *),\r\nstruct irq_chip *chip,\r\nunsigned int start, unsigned int end)\r\n{\r\nunsigned int irqno;\r\nirq_set_chip_and_handler(base, &s3c_irq_level_chip, handle_level_irq);\r\nirq_set_chained_handler(base, demux);\r\nfor (irqno = start; irqno <= end; irqno++) {\r\nirq_set_chip_and_handler(irqno, chip, handle_level_irq);\r\nset_irq_flags(irqno, IRQF_VALID);\r\n}\r\nreturn 0;\r\n}\r\nstatic void __init s3c2416_irq_add_second(void)\r\n{\r\nunsigned long pend;\r\nunsigned long last;\r\nint irqno;\r\nint i;\r\nlast = 0;\r\nfor (i = 0; i < 4; i++) {\r\npend = __raw_readl(S3C2416_INTPND2);\r\nif (pend == 0 || pend == last)\r\nbreak;\r\n__raw_writel(pend, S3C2416_SRCPND2);\r\n__raw_writel(pend, S3C2416_INTPND2);\r\nprintk(KERN_INFO "irq: clearing pending status %08x\n",\r\n(int)pend);\r\nlast = pend;\r\n}\r\nfor (irqno = IRQ_S3C2416_2D; irqno <= IRQ_S3C2416_I2S1; irqno++) {\r\nswitch (irqno) {\r\ncase IRQ_S3C2416_RESERVED2:\r\ncase IRQ_S3C2416_RESERVED3:\r\nbreak;\r\ndefault:\r\nirq_set_chip_and_handler(irqno, &s3c2416_irq_second,\r\nhandle_edge_irq);\r\nset_irq_flags(irqno, IRQF_VALID);\r\n}\r\n}\r\n}\r\nstatic int __init s3c2416_irq_add(struct device *dev,\r\nstruct subsys_interface *sif)\r\n{\r\nprintk(KERN_INFO "S3C2416: IRQ Support\n");\r\ns3c2416_add_sub(IRQ_LCD, s3c2416_irq_demux_lcd, &s3c2416_irq_lcd,\r\nIRQ_S3C2443_LCD2, IRQ_S3C2443_LCD4);\r\ns3c2416_add_sub(IRQ_S3C2443_DMA, s3c2416_irq_demux_dma,\r\n&s3c2416_irq_dma, IRQ_S3C2443_DMA0, IRQ_S3C2443_DMA5);\r\ns3c2416_add_sub(IRQ_S3C2443_UART3, s3c2416_irq_demux_uart3,\r\n&s3c2416_irq_uart3,\r\nIRQ_S3C2443_RX3, IRQ_S3C2443_ERR3);\r\ns3c2416_add_sub(IRQ_WDT, s3c2416_irq_demux_wdtac97,\r\n&s3c2416_irq_wdtac97,\r\nIRQ_S3C2443_WDT, IRQ_S3C2443_AC97);\r\ns3c2416_irq_add_second();\r\nreturn 0;\r\n}\r\nstatic int __init s3c2416_irq_init(void)\r\n{\r\nreturn subsys_interface_register(&s3c2416_irq_interface);\r\n}\r\nint s3c2416_irq_suspend(void)\r\n{\r\ns3c_pm_do_save(irq_save, ARRAY_SIZE(irq_save));\r\nreturn 0;\r\n}\r\nvoid s3c2416_irq_resume(void)\r\n{\r\ns3c_pm_do_restore(irq_save, ARRAY_SIZE(irq_save));\r\n}

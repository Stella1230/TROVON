static ssize_t show_version(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", bgrt_tab->version);\r\n}\r\nstatic ssize_t show_status(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", bgrt_tab->status);\r\n}\r\nstatic ssize_t show_type(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", bgrt_tab->image_type);\r\n}\r\nstatic ssize_t show_xoffset(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", bgrt_tab->image_offset_x);\r\n}\r\nstatic ssize_t show_yoffset(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", bgrt_tab->image_offset_y);\r\n}\r\nstatic ssize_t show_image(struct file *file, struct kobject *kobj,\r\nstruct bin_attribute *attr, char *buf, loff_t off, size_t count)\r\n{\r\nint size = attr->size;\r\nvoid __iomem *image = attr->private;\r\nif (off >= size) {\r\ncount = 0;\r\n} else {\r\nif (off + count > size)\r\ncount = size - off;\r\nmemcpy_fromio(buf, image+off, count);\r\n}\r\nreturn count;\r\n}\r\nstatic int __init bgrt_init(void)\r\n{\r\nacpi_status status;\r\nint ret;\r\nvoid __iomem *bgrt;\r\nif (acpi_disabled)\r\nreturn -ENODEV;\r\nstatus = acpi_get_table("BGRT", 0,\r\n(struct acpi_table_header **)&bgrt_tab);\r\nif (ACPI_FAILURE(status))\r\nreturn -ENODEV;\r\nsysfs_bin_attr_init(&image_attr);\r\nbgrt = ioremap(bgrt_tab->image_address, sizeof(struct bmp_header));\r\nif (!bgrt) {\r\nret = -EINVAL;\r\ngoto out_err;\r\n}\r\nmemcpy_fromio(&bmp_header, bgrt, sizeof(bmp_header));\r\nimage_attr.size = bmp_header.size;\r\niounmap(bgrt);\r\nimage_attr.private = ioremap(bgrt_tab->image_address, image_attr.size);\r\nif (!image_attr.private) {\r\nret = -EINVAL;\r\ngoto out_err;\r\n}\r\nbgrt_kobj = kobject_create_and_add("bgrt", acpi_kobj);\r\nif (!bgrt_kobj) {\r\nret = -EINVAL;\r\ngoto out_iounmap;\r\n}\r\nret = sysfs_create_group(bgrt_kobj, &bgrt_attribute_group);\r\nif (ret)\r\ngoto out_kobject;\r\nret = sysfs_create_bin_file(bgrt_kobj, &image_attr);\r\nif (ret)\r\ngoto out_group;\r\nreturn 0;\r\nout_group:\r\nsysfs_remove_group(bgrt_kobj, &bgrt_attribute_group);\r\nout_kobject:\r\nkobject_put(bgrt_kobj);\r\nout_iounmap:\r\niounmap(image_attr.private);\r\nout_err:\r\nreturn ret;\r\n}\r\nstatic void __exit bgrt_exit(void)\r\n{\r\niounmap(image_attr.private);\r\nsysfs_remove_group(bgrt_kobj, &bgrt_attribute_group);\r\nsysfs_remove_bin_file(bgrt_kobj, &image_attr);\r\n}

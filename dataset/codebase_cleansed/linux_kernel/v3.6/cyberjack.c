static int cyberjack_startup(struct usb_serial *serial)\r\n{\r\nstruct cyberjack_private *priv;\r\nint i;\r\npriv = kmalloc(sizeof(struct cyberjack_private), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nspin_lock_init(&priv->lock);\r\npriv->rdtodo = 0;\r\npriv->wrfilled = 0;\r\npriv->wrsent = 0;\r\nusb_set_serial_port_data(serial->port[0], priv);\r\ninit_waitqueue_head(&serial->port[0]->write_wait);\r\nfor (i = 0; i < serial->num_ports; ++i) {\r\nint result;\r\nresult = usb_submit_urb(serial->port[i]->interrupt_in_urb,\r\nGFP_KERNEL);\r\nif (result)\r\ndev_err(&serial->dev->dev,\r\n"usb_submit_urb(read int) failed\n");\r\ndbg("%s - usb_submit_urb(int urb)", __func__);\r\n}\r\nreturn 0;\r\n}\r\nstatic void cyberjack_disconnect(struct usb_serial *serial)\r\n{\r\nint i;\r\nfor (i = 0; i < serial->num_ports; ++i)\r\nusb_kill_urb(serial->port[i]->interrupt_in_urb);\r\n}\r\nstatic void cyberjack_release(struct usb_serial *serial)\r\n{\r\nint i;\r\nfor (i = 0; i < serial->num_ports; ++i) {\r\nkfree(usb_get_serial_port_data(serial->port[i]));\r\n}\r\n}\r\nstatic int cyberjack_open(struct tty_struct *tty,\r\nstruct usb_serial_port *port)\r\n{\r\nstruct cyberjack_private *priv;\r\nunsigned long flags;\r\nint result = 0;\r\ndbg("%s - usb_clear_halt", __func__);\r\nusb_clear_halt(port->serial->dev, port->write_urb->pipe);\r\npriv = usb_get_serial_port_data(port);\r\nspin_lock_irqsave(&priv->lock, flags);\r\npriv->rdtodo = 0;\r\npriv->wrfilled = 0;\r\npriv->wrsent = 0;\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\nreturn result;\r\n}\r\nstatic void cyberjack_close(struct usb_serial_port *port)\r\n{\r\nif (port->serial->dev) {\r\nusb_kill_urb(port->write_urb);\r\nusb_kill_urb(port->read_urb);\r\n}\r\n}\r\nstatic int cyberjack_write(struct tty_struct *tty,\r\nstruct usb_serial_port *port, const unsigned char *buf, int count)\r\n{\r\nstruct cyberjack_private *priv = usb_get_serial_port_data(port);\r\nunsigned long flags;\r\nint result;\r\nint wrexpected;\r\nif (count == 0) {\r\ndbg("%s - write request of 0 bytes", __func__);\r\nreturn 0;\r\n}\r\nif (!test_and_clear_bit(0, &port->write_urbs_free)) {\r\ndbg("%s - already writing", __func__);\r\nreturn 0;\r\n}\r\nspin_lock_irqsave(&priv->lock, flags);\r\nif (count+priv->wrfilled > sizeof(priv->wrbuf)) {\r\npriv->wrfilled = 0;\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\nset_bit(0, &port->write_urbs_free);\r\nreturn 0;\r\n}\r\nmemcpy(priv->wrbuf + priv->wrfilled, buf, count);\r\nusb_serial_debug_data(debug, &port->dev, __func__, count,\r\npriv->wrbuf + priv->wrfilled);\r\npriv->wrfilled += count;\r\nif (priv->wrfilled >= 3) {\r\nwrexpected = ((int)priv->wrbuf[2]<<8)+priv->wrbuf[1]+3;\r\ndbg("%s - expected data: %d", __func__, wrexpected);\r\n} else\r\nwrexpected = sizeof(priv->wrbuf);\r\nif (priv->wrfilled >= wrexpected) {\r\nint length;\r\ndbg("%s - transmitting data (frame 1)", __func__);\r\nlength = (wrexpected > port->bulk_out_size) ?\r\nport->bulk_out_size : wrexpected;\r\nmemcpy(port->write_urb->transfer_buffer, priv->wrbuf, length);\r\npriv->wrsent = length;\r\nport->write_urb->transfer_buffer_length = length;\r\nresult = usb_submit_urb(port->write_urb, GFP_ATOMIC);\r\nif (result) {\r\ndev_err(&port->dev,\r\n"%s - failed submitting write urb, error %d",\r\n__func__, result);\r\npriv->wrfilled = 0;\r\npriv->wrsent = 0;\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\nset_bit(0, &port->write_urbs_free);\r\nreturn 0;\r\n}\r\ndbg("%s - priv->wrsent=%d", __func__, priv->wrsent);\r\ndbg("%s - priv->wrfilled=%d", __func__, priv->wrfilled);\r\nif (priv->wrsent >= priv->wrfilled) {\r\ndbg("%s - buffer cleaned", __func__);\r\nmemset(priv->wrbuf, 0, sizeof(priv->wrbuf));\r\npriv->wrfilled = 0;\r\npriv->wrsent = 0;\r\n}\r\n}\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\nreturn count;\r\n}\r\nstatic int cyberjack_write_room(struct tty_struct *tty)\r\n{\r\nreturn CYBERJACK_LOCAL_BUF_SIZE;\r\n}\r\nstatic void cyberjack_read_int_callback(struct urb *urb)\r\n{\r\nstruct usb_serial_port *port = urb->context;\r\nstruct cyberjack_private *priv = usb_get_serial_port_data(port);\r\nunsigned char *data = urb->transfer_buffer;\r\nint status = urb->status;\r\nint result;\r\nif (status)\r\nreturn;\r\nusb_serial_debug_data(debug, &port->dev, __func__,\r\nurb->actual_length, data);\r\nif (urb->actual_length == 4 && data[0] == 0x01) {\r\nshort old_rdtodo;\r\nunsigned short size = ((unsigned short)data[3]<<8)+data[2]+3;\r\nspin_lock(&priv->lock);\r\nold_rdtodo = priv->rdtodo;\r\nif (old_rdtodo + size < old_rdtodo) {\r\ndbg("To many bulk_in urbs to do.");\r\nspin_unlock(&priv->lock);\r\ngoto resubmit;\r\n}\r\npriv->rdtodo += size;\r\ndbg("%s - rdtodo: %d", __func__, priv->rdtodo);\r\nspin_unlock(&priv->lock);\r\nif (!old_rdtodo) {\r\nresult = usb_submit_urb(port->read_urb, GFP_ATOMIC);\r\nif (result)\r\ndev_err(&port->dev, "%s - failed resubmitting "\r\n"read urb, error %d\n",\r\n__func__, result);\r\ndbg("%s - usb_submit_urb(read urb)", __func__);\r\n}\r\n}\r\nresubmit:\r\nresult = usb_submit_urb(port->interrupt_in_urb, GFP_ATOMIC);\r\nif (result)\r\ndev_err(&port->dev, "usb_submit_urb(read int) failed\n");\r\ndbg("%s - usb_submit_urb(int urb)", __func__);\r\n}\r\nstatic void cyberjack_read_bulk_callback(struct urb *urb)\r\n{\r\nstruct usb_serial_port *port = urb->context;\r\nstruct cyberjack_private *priv = usb_get_serial_port_data(port);\r\nstruct tty_struct *tty;\r\nunsigned char *data = urb->transfer_buffer;\r\nshort todo;\r\nint result;\r\nint status = urb->status;\r\nusb_serial_debug_data(debug, &port->dev, __func__,\r\nurb->actual_length, data);\r\nif (status) {\r\ndbg("%s - nonzero read bulk status received: %d",\r\n__func__, status);\r\nreturn;\r\n}\r\ntty = tty_port_tty_get(&port->port);\r\nif (!tty) {\r\ndbg("%s - ignoring since device not open", __func__);\r\nreturn;\r\n}\r\nif (urb->actual_length) {\r\ntty_insert_flip_string(tty, data, urb->actual_length);\r\ntty_flip_buffer_push(tty);\r\n}\r\ntty_kref_put(tty);\r\nspin_lock(&priv->lock);\r\npriv->rdtodo -= urb->actual_length;\r\nif (priv->rdtodo < 0)\r\npriv->rdtodo = 0;\r\ntodo = priv->rdtodo;\r\nspin_unlock(&priv->lock);\r\ndbg("%s - rdtodo: %d", __func__, todo);\r\nif (todo ) {\r\nresult = usb_submit_urb(port->read_urb, GFP_ATOMIC);\r\nif (result)\r\ndev_err(&port->dev, "%s - failed resubmitting read "\r\n"urb, error %d\n", __func__, result);\r\ndbg("%s - usb_submit_urb(read urb)", __func__);\r\n}\r\n}\r\nstatic void cyberjack_write_bulk_callback(struct urb *urb)\r\n{\r\nstruct usb_serial_port *port = urb->context;\r\nstruct cyberjack_private *priv = usb_get_serial_port_data(port);\r\nint status = urb->status;\r\nset_bit(0, &port->write_urbs_free);\r\nif (status) {\r\ndbg("%s - nonzero write bulk status received: %d",\r\n__func__, status);\r\nreturn;\r\n}\r\nspin_lock(&priv->lock);\r\nif (priv->wrfilled) {\r\nint length, blksize, result;\r\ndbg("%s - transmitting data (frame n)", __func__);\r\nlength = ((priv->wrfilled - priv->wrsent) > port->bulk_out_size) ?\r\nport->bulk_out_size : (priv->wrfilled - priv->wrsent);\r\nmemcpy(port->write_urb->transfer_buffer,\r\npriv->wrbuf + priv->wrsent, length);\r\npriv->wrsent += length;\r\nport->write_urb->transfer_buffer_length = length;\r\nresult = usb_submit_urb(port->write_urb, GFP_ATOMIC);\r\nif (result) {\r\ndev_err(&port->dev,\r\n"%s - failed submitting write urb, error %d\n",\r\n__func__, result);\r\npriv->wrfilled = 0;\r\npriv->wrsent = 0;\r\ngoto exit;\r\n}\r\ndbg("%s - priv->wrsent=%d", __func__, priv->wrsent);\r\ndbg("%s - priv->wrfilled=%d", __func__, priv->wrfilled);\r\nblksize = ((int)priv->wrbuf[2]<<8)+priv->wrbuf[1]+3;\r\nif (priv->wrsent >= priv->wrfilled ||\r\npriv->wrsent >= blksize) {\r\ndbg("%s - buffer cleaned", __func__);\r\nmemset(priv->wrbuf, 0, sizeof(priv->wrbuf));\r\npriv->wrfilled = 0;\r\npriv->wrsent = 0;\r\n}\r\n}\r\nexit:\r\nspin_unlock(&priv->lock);\r\nusb_serial_port_softint(port);\r\n}

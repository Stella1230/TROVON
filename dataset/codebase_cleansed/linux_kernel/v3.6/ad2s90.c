static int ad2s90_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint *val,\r\nint *val2,\r\nlong m)\r\n{\r\nint ret;\r\nstruct ad2s90_state *st = iio_priv(indio_dev);\r\nmutex_lock(&st->lock);\r\nret = spi_read(st->sdev, st->rx, 2);\r\nif (ret)\r\ngoto error_ret;\r\n*val = (((u16)(st->rx[0])) << 4) | ((st->rx[1] & 0xF0) >> 4);\r\nerror_ret:\r\nmutex_unlock(&st->lock);\r\nreturn IIO_VAL_INT;\r\n}\r\nstatic int __devinit ad2s90_probe(struct spi_device *spi)\r\n{\r\nstruct iio_dev *indio_dev;\r\nstruct ad2s90_state *st;\r\nint ret = 0;\r\nindio_dev = iio_device_alloc(sizeof(*st));\r\nif (indio_dev == NULL) {\r\nret = -ENOMEM;\r\ngoto error_ret;\r\n}\r\nst = iio_priv(indio_dev);\r\nspi_set_drvdata(spi, indio_dev);\r\nmutex_init(&st->lock);\r\nst->sdev = spi;\r\nindio_dev->dev.parent = &spi->dev;\r\nindio_dev->info = &ad2s90_info;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nindio_dev->channels = &ad2s90_chan;\r\nindio_dev->num_channels = 1;\r\nindio_dev->name = spi_get_device_id(spi)->name;\r\nret = iio_device_register(indio_dev);\r\nif (ret)\r\ngoto error_free_dev;\r\nspi->max_speed_hz = 830000;\r\nspi->mode = SPI_MODE_3;\r\nspi_setup(spi);\r\nreturn 0;\r\nerror_free_dev:\r\niio_device_free(indio_dev);\r\nerror_ret:\r\nreturn ret;\r\n}\r\nstatic int __devexit ad2s90_remove(struct spi_device *spi)\r\n{\r\niio_device_unregister(spi_get_drvdata(spi));\r\niio_device_free(spi_get_drvdata(spi));\r\nreturn 0;\r\n}

static int progearbl_set_intensity(struct backlight_device *bd)\r\n{\r\nint intensity = bd->props.brightness;\r\nif (bd->props.power != FB_BLANK_UNBLANK)\r\nintensity = 0;\r\nif (bd->props.fb_blank != FB_BLANK_UNBLANK)\r\nintensity = 0;\r\npci_write_config_byte(pmu_dev, PMU_LPCR, intensity + HW_LEVEL_MIN);\r\nreturn 0;\r\n}\r\nstatic int progearbl_get_intensity(struct backlight_device *bd)\r\n{\r\nu8 intensity;\r\npci_read_config_byte(pmu_dev, PMU_LPCR, &intensity);\r\nreturn intensity - HW_LEVEL_MIN;\r\n}\r\nstatic int progearbl_probe(struct platform_device *pdev)\r\n{\r\nstruct backlight_properties props;\r\nu8 temp;\r\nstruct backlight_device *progear_backlight_device;\r\nint ret;\r\npmu_dev = pci_get_device(PCI_VENDOR_ID_AL, PCI_DEVICE_ID_AL_M7101, NULL);\r\nif (!pmu_dev) {\r\npr_err("ALI M7101 PMU not found.\n");\r\nreturn -ENODEV;\r\n}\r\nsb_dev = pci_get_device(PCI_VENDOR_ID_AL, PCI_DEVICE_ID_AL_M1533, NULL);\r\nif (!sb_dev) {\r\npr_err("ALI 1533 SB not found.\n");\r\nret = -ENODEV;\r\ngoto put_pmu;\r\n}\r\npci_read_config_byte(sb_dev, SB_MPS1, &temp);\r\npci_write_config_byte(sb_dev, SB_MPS1, temp | 0x20);\r\nmemset(&props, 0, sizeof(struct backlight_properties));\r\nprops.type = BACKLIGHT_RAW;\r\nprops.max_brightness = HW_LEVEL_MAX - HW_LEVEL_MIN;\r\nprogear_backlight_device = backlight_device_register("progear-bl",\r\n&pdev->dev, NULL,\r\n&progearbl_ops,\r\n&props);\r\nif (IS_ERR(progear_backlight_device)) {\r\nret = PTR_ERR(progear_backlight_device);\r\ngoto put_sb;\r\n}\r\nplatform_set_drvdata(pdev, progear_backlight_device);\r\nprogear_backlight_device->props.power = FB_BLANK_UNBLANK;\r\nprogear_backlight_device->props.brightness = HW_LEVEL_MAX - HW_LEVEL_MIN;\r\nprogearbl_set_intensity(progear_backlight_device);\r\nreturn 0;\r\nput_sb:\r\npci_dev_put(sb_dev);\r\nput_pmu:\r\npci_dev_put(pmu_dev);\r\nreturn ret;\r\n}\r\nstatic int progearbl_remove(struct platform_device *pdev)\r\n{\r\nstruct backlight_device *bd = platform_get_drvdata(pdev);\r\nbacklight_device_unregister(bd);\r\nreturn 0;\r\n}\r\nstatic int __init progearbl_init(void)\r\n{\r\nint ret = platform_driver_register(&progearbl_driver);\r\nif (ret)\r\nreturn ret;\r\nprogearbl_device = platform_device_register_simple("progear-bl", -1,\r\nNULL, 0);\r\nif (IS_ERR(progearbl_device)) {\r\nplatform_driver_unregister(&progearbl_driver);\r\nreturn PTR_ERR(progearbl_device);\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit progearbl_exit(void)\r\n{\r\npci_dev_put(pmu_dev);\r\npci_dev_put(sb_dev);\r\nplatform_device_unregister(progearbl_device);\r\nplatform_driver_unregister(&progearbl_driver);\r\n}

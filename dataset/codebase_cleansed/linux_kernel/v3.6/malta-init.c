char *prom_getenv(char *envname)\r\n{\r\nint i, index=0;\r\ni = strlen(envname);\r\nwhile (prom_envp(index)) {\r\nif(strncmp(envname, prom_envp(index), i) == 0) {\r\nreturn(prom_envp(index+1));\r\n}\r\nindex += 2;\r\n}\r\nreturn NULL;\r\n}\r\nstatic inline unsigned char str2hexnum(unsigned char c)\r\n{\r\nif (c >= '0' && c <= '9')\r\nreturn c - '0';\r\nif (c >= 'a' && c <= 'f')\r\nreturn c - 'a' + 10;\r\nreturn 0;\r\n}\r\nstatic inline void str2eaddr(unsigned char *ea, unsigned char *str)\r\n{\r\nint i;\r\nfor (i = 0; i < 6; i++) {\r\nunsigned char num;\r\nif((*str == '.') || (*str == ':'))\r\nstr++;\r\nnum = str2hexnum(*str++) << 4;\r\nnum |= (str2hexnum(*str++));\r\nea[i] = num;\r\n}\r\n}\r\nint get_ethernet_addr(char *ethernet_addr)\r\n{\r\nchar *ethaddr_str;\r\nethaddr_str = prom_getenv("ethaddr");\r\nif (!ethaddr_str) {\r\nprintk("ethaddr not set in boot prom\n");\r\nreturn -1;\r\n}\r\nstr2eaddr(ethernet_addr, ethaddr_str);\r\nif (init_debug > 1) {\r\nint i;\r\nprintk("get_ethernet_addr: ");\r\nfor (i=0; i<5; i++)\r\nprintk("%02x:", (unsigned char)*(ethernet_addr+i));\r\nprintk("%02x\n", *(ethernet_addr+i));\r\n}\r\nreturn 0;\r\n}\r\nstatic void __init console_config(void)\r\n{\r\nchar console_string[40];\r\nint baud = 0;\r\nchar parity = '\0', bits = '\0', flow = '\0';\r\nchar *s;\r\nif ((strstr(prom_getcmdline(), "console=")) == NULL) {\r\ns = prom_getenv("modetty0");\r\nif (s) {\r\nwhile (*s >= '0' && *s <= '9')\r\nbaud = baud*10 + *s++ - '0';\r\nif (*s == ',') s++;\r\nif (*s) parity = *s++;\r\nif (*s == ',') s++;\r\nif (*s) bits = *s++;\r\nif (*s == ',') s++;\r\nif (*s == 'h') flow = 'r';\r\n}\r\nif (baud == 0)\r\nbaud = 38400;\r\nif (parity != 'n' && parity != 'o' && parity != 'e')\r\nparity = 'n';\r\nif (bits != '7' && bits != '8')\r\nbits = '8';\r\nif (flow == '\0')\r\nflow = 'r';\r\nsprintf(console_string, " console=ttyS0,%d%c%c%c", baud, parity, bits, flow);\r\nstrcat(prom_getcmdline(), console_string);\r\npr_info("Config serial console:%s\n", console_string);\r\n}\r\n}\r\nstatic void __init mips_nmi_setup(void)\r\n{\r\nvoid *base;\r\nextern char except_vec_nmi;\r\nbase = cpu_has_veic ?\r\n(void *)(CAC_BASE + 0xa80) :\r\n(void *)(CAC_BASE + 0x380);\r\nmemcpy(base, &except_vec_nmi, 0x80);\r\nflush_icache_range((unsigned long)base, (unsigned long)base + 0x80);\r\n}\r\nstatic void __init mips_ejtag_setup(void)\r\n{\r\nvoid *base;\r\nextern char except_vec_ejtag_debug;\r\nbase = cpu_has_veic ?\r\n(void *)(CAC_BASE + 0xa00) :\r\n(void *)(CAC_BASE + 0x300);\r\nmemcpy(base, &except_vec_ejtag_debug, 0x80);\r\nflush_icache_range((unsigned long)base, (unsigned long)base + 0x80);\r\n}\r\nvoid __init prom_init(void)\r\n{\r\nprom_argc = fw_arg0;\r\n_prom_argv = (int *) fw_arg1;\r\n_prom_envp = (int *) fw_arg2;\r\nmips_display_message("LINUX");\r\n_pcictrl_bonito = (unsigned long)ioremap(BONITO_REG_BASE, BONITO_REG_SIZE);\r\nmips_revision_corid = MIPS_REVISION_CORID;\r\nif (mips_revision_corid == MIPS_REVISION_CORID_CORE_EMUL) {\r\nif (BONITO_PCIDID == 0x0001df53 ||\r\nBONITO_PCIDID == 0x0003df53)\r\nmips_revision_corid = MIPS_REVISION_CORID_CORE_EMUL_BON;\r\nelse\r\nmips_revision_corid = MIPS_REVISION_CORID_CORE_EMUL_MSC;\r\n}\r\nmips_revision_sconid = MIPS_REVISION_SCONID;\r\nif (mips_revision_sconid == MIPS_REVISION_SCON_OTHER) {\r\nswitch (mips_revision_corid) {\r\ncase MIPS_REVISION_CORID_QED_RM5261:\r\ncase MIPS_REVISION_CORID_CORE_LV:\r\ncase MIPS_REVISION_CORID_CORE_FPGA:\r\ncase MIPS_REVISION_CORID_CORE_FPGAR2:\r\nmips_revision_sconid = MIPS_REVISION_SCON_GT64120;\r\nbreak;\r\ncase MIPS_REVISION_CORID_CORE_EMUL_BON:\r\ncase MIPS_REVISION_CORID_BONITO64:\r\ncase MIPS_REVISION_CORID_CORE_20K:\r\nmips_revision_sconid = MIPS_REVISION_SCON_BONITO;\r\nbreak;\r\ncase MIPS_REVISION_CORID_CORE_MSC:\r\ncase MIPS_REVISION_CORID_CORE_FPGA2:\r\ncase MIPS_REVISION_CORID_CORE_24K:\r\nmips_revision_sconid = MIPS_REVISION_SCON_SOCIT;\r\nbreak;\r\ncase MIPS_REVISION_CORID_CORE_FPGA3:\r\ncase MIPS_REVISION_CORID_CORE_FPGA4:\r\ncase MIPS_REVISION_CORID_CORE_FPGA5:\r\ncase MIPS_REVISION_CORID_CORE_EMUL_MSC:\r\ndefault:\r\nmips_revision_sconid = MIPS_REVISION_SCON_ROCIT;\r\nbreak;\r\n}\r\n}\r\nswitch (mips_revision_sconid) {\r\nu32 start, map, mask, data;\r\ncase MIPS_REVISION_SCON_GT64120:\r\n_pcictrl_gt64120 = (unsigned long)ioremap(MIPS_GT_BASE, 0x2000);\r\n#ifdef CONFIG_CPU_LITTLE_ENDIAN\r\nGT_WRITE(GT_PCI0_CMD_OFS, GT_PCI0_CMD_MBYTESWAP_BIT |\r\nGT_PCI0_CMD_SBYTESWAP_BIT);\r\n#else\r\nGT_WRITE(GT_PCI0_CMD_OFS, 0);\r\n#endif\r\nstart = GT_READ(GT_PCI0IOLD_OFS);\r\nmap = GT_READ(GT_PCI0IOREMAP_OFS);\r\nif ((start & map) != 0) {\r\nmap &= ~start;\r\nGT_WRITE(GT_PCI0IOREMAP_OFS, map);\r\n}\r\nset_io_port_base(MALTA_GT_PORT_BASE);\r\nbreak;\r\ncase MIPS_REVISION_SCON_BONITO:\r\n_pcictrl_bonito_pcicfg = (unsigned long)ioremap(BONITO_PCICFG_BASE, BONITO_PCICFG_SIZE);\r\nBONITO_PCIMEMBASECFG = BONITO_PCIMEMBASECFG &\r\n~(BONITO_PCIMEMBASECFG_MEMBASE0_CACHED |\r\nBONITO_PCIMEMBASECFG_MEMBASE1_CACHED);\r\n#ifdef CONFIG_CPU_LITTLE_ENDIAN\r\nBONITO_BONGENCFG = BONITO_BONGENCFG &\r\n~(BONITO_BONGENCFG_MSTRBYTESWAP |\r\nBONITO_BONGENCFG_BYTESWAP);\r\n#else\r\nBONITO_BONGENCFG = BONITO_BONGENCFG |\r\nBONITO_BONGENCFG_MSTRBYTESWAP |\r\nBONITO_BONGENCFG_BYTESWAP;\r\n#endif\r\nset_io_port_base(MALTA_BONITO_PORT_BASE);\r\nbreak;\r\ncase MIPS_REVISION_SCON_SOCIT:\r\ncase MIPS_REVISION_SCON_ROCIT:\r\n_pcictrl_msc = (unsigned long)ioremap(MIPS_MSC01_PCI_REG_BASE, 0x2000);\r\nmips_pci_controller:\r\nmb();\r\nMSC_READ(MSC01_PCI_CFG, data);\r\nMSC_WRITE(MSC01_PCI_CFG, data & ~MSC01_PCI_CFG_EN_BIT);\r\nwmb();\r\n#ifdef CONFIG_CPU_LITTLE_ENDIAN\r\nMSC_WRITE(MSC01_PCI_SWAP, MSC01_PCI_SWAP_NOSWAP);\r\n#else\r\nMSC_WRITE(MSC01_PCI_SWAP,\r\nMSC01_PCI_SWAP_BYTESWAP << MSC01_PCI_SWAP_IO_SHF |\r\nMSC01_PCI_SWAP_BYTESWAP << MSC01_PCI_SWAP_MEM_SHF |\r\nMSC01_PCI_SWAP_BYTESWAP << MSC01_PCI_SWAP_BAR0_SHF);\r\n#endif\r\nMSC_READ(MSC01_PCI_BAR0, mask);\r\nMSC_WRITE(MSC01_PCI_P2SCMSKL, mask & MSC01_PCI_BAR0_SIZE_MSK);\r\nif ((data & MSC01_PCI_CFG_MAXRTRY_MSK) ==\r\nMSC01_PCI_CFG_MAXRTRY_MSK)\r\ndata = (data & ~(MSC01_PCI_CFG_MAXRTRY_MSK <<\r\nMSC01_PCI_CFG_MAXRTRY_SHF)) |\r\n((MSC01_PCI_CFG_MAXRTRY_MSK - 1) <<\r\nMSC01_PCI_CFG_MAXRTRY_SHF);\r\nwmb();\r\nMSC_WRITE(MSC01_PCI_CFG, data);\r\nmb();\r\nset_io_port_base(MALTA_MSC_PORT_BASE);\r\nbreak;\r\ncase MIPS_REVISION_SCON_SOCITSC:\r\ncase MIPS_REVISION_SCON_SOCITSCP:\r\n_pcictrl_msc = (unsigned long)ioremap(MIPS_SOCITSC_PCI_REG_BASE, 0x2000);\r\ngoto mips_pci_controller;\r\ndefault:\r\nmips_display_message("SC Error");\r\nwhile (1);\r\n}\r\nboard_nmi_handler_setup = mips_nmi_setup;\r\nboard_ejtag_handler_setup = mips_ejtag_setup;\r\nprom_init_cmdline();\r\nprom_meminit();\r\n#ifdef CONFIG_SERIAL_8250_CONSOLE\r\nconsole_config();\r\n#endif\r\nif (gcmp_probe(GCMP_BASE_ADDR, GCMP_ADDRSPACE_SZ))\r\nif (!register_cmp_smp_ops())\r\nreturn;\r\nif (!register_vsmp_smp_ops())\r\nreturn;\r\n#ifdef CONFIG_MIPS_MT_SMTC\r\nregister_smp_ops(&msmtc_smp_ops);\r\n#endif\r\n}

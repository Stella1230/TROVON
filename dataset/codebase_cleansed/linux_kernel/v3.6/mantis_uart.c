int mantis_uart_read(struct mantis_pci *mantis, u8 *data)\r\n{\r\nstruct mantis_hwconfig *config = mantis->hwconfig;\r\nu32 stat = 0, i;\r\nfor (i = 0; i < (config->bytes + 1); i++) {\r\nstat = mmread(MANTIS_UART_STAT);\r\nif (stat & MANTIS_UART_RXFIFO_FULL) {\r\ndprintk(MANTIS_ERROR, 1, "RX Fifo FULL");\r\n}\r\ndata[i] = mmread(MANTIS_UART_RXD) & 0x3f;\r\ndprintk(MANTIS_DEBUG, 1, "Reading ... <%02x>", data[i] & 0x3f);\r\nif (data[i] & (1 << 7)) {\r\ndprintk(MANTIS_ERROR, 1, "UART framing error");\r\nreturn -EINVAL;\r\n}\r\nif (data[i] & (1 << 6)) {\r\ndprintk(MANTIS_ERROR, 1, "UART parity error");\r\nreturn -EINVAL;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void mantis_uart_work(struct work_struct *work)\r\n{\r\nstruct mantis_pci *mantis = container_of(work, struct mantis_pci, uart_work);\r\nstruct mantis_hwconfig *config = mantis->hwconfig;\r\nu8 buf[16];\r\nint i;\r\nmantis_uart_read(mantis, buf);\r\nfor (i = 0; i < (config->bytes + 1); i++)\r\ndprintk(MANTIS_INFO, 1, "UART BUF:%d <%02x> ", i, buf[i]);\r\ndprintk(MANTIS_DEBUG, 0, "\n");\r\n}\r\nstatic int mantis_uart_setup(struct mantis_pci *mantis,\r\nstruct mantis_uart_params *params)\r\n{\r\nu32 reg;\r\nmmwrite((mmread(MANTIS_UART_CTL) | (params->parity & 0x3)), MANTIS_UART_CTL);\r\nreg = mmread(MANTIS_UART_BAUD);\r\nswitch (params->baud_rate) {\r\ncase MANTIS_BAUD_9600:\r\nreg |= 0xd8;\r\nbreak;\r\ncase MANTIS_BAUD_19200:\r\nreg |= 0x6c;\r\nbreak;\r\ncase MANTIS_BAUD_38400:\r\nreg |= 0x36;\r\nbreak;\r\ncase MANTIS_BAUD_57600:\r\nreg |= 0x23;\r\nbreak;\r\ncase MANTIS_BAUD_115200:\r\nreg |= 0x11;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nmmwrite(reg, MANTIS_UART_BAUD);\r\nreturn 0;\r\n}\r\nint mantis_uart_init(struct mantis_pci *mantis)\r\n{\r\nstruct mantis_hwconfig *config = mantis->hwconfig;\r\nstruct mantis_uart_params params;\r\nparams.baud_rate = config->baud_rate;\r\nparams.parity = config->parity;\r\ndprintk(MANTIS_INFO, 1, "Initializing UART @ %sbps parity:%s",\r\nrates[params.baud_rate].string,\r\nparity[params.parity].string);\r\ninit_waitqueue_head(&mantis->uart_wq);\r\nspin_lock_init(&mantis->uart_lock);\r\nINIT_WORK(&mantis->uart_work, mantis_uart_work);\r\nmmwrite(mmread(MANTIS_UART_CTL) & 0xffef, MANTIS_UART_CTL);\r\nmantis_uart_setup(mantis, &params);\r\nmmwrite((mmread(MANTIS_UART_BAUD) | (config->bytes << 8)), MANTIS_UART_BAUD);\r\nmmwrite((mmread(MANTIS_UART_CTL) | MANTIS_UART_RXFLUSH), MANTIS_UART_CTL);\r\nmmwrite(mmread(MANTIS_INT_MASK) | 0x800, MANTIS_INT_MASK);\r\nmmwrite(mmread(MANTIS_UART_CTL) | MANTIS_UART_RXINT, MANTIS_UART_CTL);\r\nschedule_work(&mantis->uart_work);\r\ndprintk(MANTIS_DEBUG, 1, "UART successfully initialized");\r\nreturn 0;\r\n}\r\nvoid mantis_uart_exit(struct mantis_pci *mantis)\r\n{\r\nmmwrite(mmread(MANTIS_UART_CTL) & 0xffef, MANTIS_UART_CTL);\r\nflush_work_sync(&mantis->uart_work);\r\n}

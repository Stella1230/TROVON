unsigned long __init rtas_get_boot_time(void)\r\n{\r\nint ret[8];\r\nint error;\r\nunsigned int wait_time;\r\nu64 max_wait_tb;\r\nmax_wait_tb = get_tb() + tb_ticks_per_usec * 1000 * MAX_RTC_WAIT;\r\ndo {\r\nerror = rtas_call(rtas_token("get-time-of-day"), 0, 8, ret);\r\nwait_time = rtas_busy_delay_time(error);\r\nif (wait_time) {\r\nudelay(wait_time*1000);\r\n}\r\n} while (wait_time && (get_tb() < max_wait_tb));\r\nif (error != 0) {\r\nprintk_ratelimited(KERN_WARNING\r\n"error: reading the clock failed (%d)\n",\r\nerror);\r\nreturn 0;\r\n}\r\nreturn mktime(ret[0], ret[1], ret[2], ret[3], ret[4], ret[5]);\r\n}\r\nvoid rtas_get_rtc_time(struct rtc_time *rtc_tm)\r\n{\r\nint ret[8];\r\nint error;\r\nunsigned int wait_time;\r\nu64 max_wait_tb;\r\nmax_wait_tb = get_tb() + tb_ticks_per_usec * 1000 * MAX_RTC_WAIT;\r\ndo {\r\nerror = rtas_call(rtas_token("get-time-of-day"), 0, 8, ret);\r\nwait_time = rtas_busy_delay_time(error);\r\nif (wait_time) {\r\nif (in_interrupt()) {\r\nmemset(rtc_tm, 0, sizeof(struct rtc_time));\r\nprintk_ratelimited(KERN_WARNING\r\n"error: reading clock "\r\n"would delay interrupt\n");\r\nreturn;\r\n}\r\nmsleep(wait_time);\r\n}\r\n} while (wait_time && (get_tb() < max_wait_tb));\r\nif (error != 0) {\r\nprintk_ratelimited(KERN_WARNING\r\n"error: reading the clock failed (%d)\n",\r\nerror);\r\nreturn;\r\n}\r\nrtc_tm->tm_sec = ret[5];\r\nrtc_tm->tm_min = ret[4];\r\nrtc_tm->tm_hour = ret[3];\r\nrtc_tm->tm_mday = ret[2];\r\nrtc_tm->tm_mon = ret[1] - 1;\r\nrtc_tm->tm_year = ret[0] - 1900;\r\n}\r\nint rtas_set_rtc_time(struct rtc_time *tm)\r\n{\r\nint error, wait_time;\r\nu64 max_wait_tb;\r\nmax_wait_tb = get_tb() + tb_ticks_per_usec * 1000 * MAX_RTC_WAIT;\r\ndo {\r\nerror = rtas_call(rtas_token("set-time-of-day"), 7, 1, NULL,\r\ntm->tm_year + 1900, tm->tm_mon + 1,\r\ntm->tm_mday, tm->tm_hour, tm->tm_min,\r\ntm->tm_sec, 0);\r\nwait_time = rtas_busy_delay_time(error);\r\nif (wait_time) {\r\nif (in_interrupt())\r\nreturn 1;\r\nmsleep(wait_time);\r\n}\r\n} while (wait_time && (get_tb() < max_wait_tb));\r\nif (error != 0)\r\nprintk_ratelimited(KERN_WARNING\r\n"error: setting the clock failed (%d)\n",\r\nerror);\r\nreturn 0;\r\n}

static int __init no_initrd(char *str)\r\n{\r\nmount_initrd = 0;\r\nreturn 1;\r\n}\r\nstatic int __init do_linuxrc(void *_shell)\r\n{\r\nstatic const char *argv[] = { "linuxrc", NULL, };\r\nextern const char *envp_init[];\r\nconst char *shell = _shell;\r\nsys_close(old_fd);sys_close(root_fd);\r\nsys_setsid();\r\nreturn kernel_execve(shell, argv, envp_init);\r\n}\r\nstatic void __init handle_initrd(void)\r\n{\r\nint error;\r\nint pid;\r\nreal_root_dev = new_encode_dev(ROOT_DEV);\r\ncreate_dev("/dev/root.old", Root_RAM0);\r\nmount_block_root("/dev/root.old", root_mountflags & ~MS_RDONLY);\r\nsys_mkdir("/old", 0700);\r\nroot_fd = sys_open("/", 0, 0);\r\nold_fd = sys_open("/old", 0, 0);\r\nsys_chdir("/root");\r\nsys_mount(".", "/", NULL, MS_MOVE, NULL);\r\nsys_chroot(".");\r\ncurrent->flags |= PF_FREEZER_SKIP;\r\npid = kernel_thread(do_linuxrc, "/linuxrc", SIGCHLD);\r\nif (pid > 0)\r\nwhile (pid != sys_wait4(-1, NULL, 0, NULL))\r\nyield();\r\ncurrent->flags &= ~PF_FREEZER_SKIP;\r\nsys_fchdir(old_fd);\r\nsys_mount("/", ".", NULL, MS_MOVE, NULL);\r\nsys_fchdir(root_fd);\r\nsys_chroot(".");\r\nsys_close(old_fd);\r\nsys_close(root_fd);\r\nif (new_decode_dev(real_root_dev) == Root_RAM0) {\r\nsys_chdir("/old");\r\nreturn;\r\n}\r\nROOT_DEV = new_decode_dev(real_root_dev);\r\nmount_root();\r\nprintk(KERN_NOTICE "Trying to move old root to /initrd ... ");\r\nerror = sys_mount("/old", "/root/initrd", NULL, MS_MOVE, NULL);\r\nif (!error)\r\nprintk("okay\n");\r\nelse {\r\nint fd = sys_open("/dev/root.old", O_RDWR, 0);\r\nif (error == -ENOENT)\r\nprintk("/initrd does not exist. Ignored.\n");\r\nelse\r\nprintk("failed\n");\r\nprintk(KERN_NOTICE "Unmounting old root\n");\r\nsys_umount("/old", MNT_DETACH);\r\nprintk(KERN_NOTICE "Trying to free ramdisk memory ... ");\r\nif (fd < 0) {\r\nerror = fd;\r\n} else {\r\nerror = sys_ioctl(fd, BLKFLSBUF, 0);\r\nsys_close(fd);\r\n}\r\nprintk(!error ? "okay\n" : "failed\n");\r\n}\r\n}\r\nint __init initrd_load(void)\r\n{\r\nif (mount_initrd) {\r\ncreate_dev("/dev/ram", Root_RAM0);\r\nif (rd_load_image("/initrd.image") && ROOT_DEV != Root_RAM0) {\r\nsys_unlink("/initrd.image");\r\nhandle_initrd();\r\nreturn 1;\r\n}\r\n}\r\nsys_unlink("/initrd.image");\r\nreturn 0;\r\n}

static void w90p910_keypad_scan_matrix(struct w90p910_keypad *keypad,\r\nunsigned int status)\r\n{\r\nstruct input_dev *input_dev = keypad->input_dev;\r\nunsigned int row = KGET_RAW(status);\r\nunsigned int col = KGET_COLUMN(status);\r\nunsigned int code = MATRIX_SCAN_CODE(row, col, W90P910_ROW_SHIFT);\r\nunsigned int key = keypad->keymap[code];\r\ninput_event(input_dev, EV_MSC, MSC_SCAN, code);\r\ninput_report_key(input_dev, key, 1);\r\ninput_sync(input_dev);\r\ninput_event(input_dev, EV_MSC, MSC_SCAN, code);\r\ninput_report_key(input_dev, key, 0);\r\ninput_sync(input_dev);\r\n}\r\nstatic irqreturn_t w90p910_keypad_irq_handler(int irq, void *dev_id)\r\n{\r\nstruct w90p910_keypad *keypad = dev_id;\r\nunsigned int kstatus, val;\r\nkstatus = __raw_readl(keypad->mmio_base + KPI_STATUS);\r\nval = INTTR | IS1KEY;\r\nif (kstatus & val)\r\nw90p910_keypad_scan_matrix(keypad, kstatus);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int w90p910_keypad_open(struct input_dev *dev)\r\n{\r\nstruct w90p910_keypad *keypad = input_get_drvdata(dev);\r\nconst struct w90p910_keypad_platform_data *pdata = keypad->pdata;\r\nunsigned int val, config;\r\nclk_enable(keypad->clk);\r\nval = __raw_readl(keypad->mmio_base + KPI_CONF);\r\nval |= (KPSEL | ENKP);\r\nval &= ~(KSIZE0 | KSIZE1);\r\nconfig = pdata->prescale | (pdata->debounce << DEBOUNCE_BIT);\r\nval |= config;\r\n__raw_writel(val, keypad->mmio_base + KPI_CONF);\r\nreturn 0;\r\n}\r\nstatic void w90p910_keypad_close(struct input_dev *dev)\r\n{\r\nstruct w90p910_keypad *keypad = input_get_drvdata(dev);\r\nclk_disable(keypad->clk);\r\n}\r\nstatic int __devinit w90p910_keypad_probe(struct platform_device *pdev)\r\n{\r\nconst struct w90p910_keypad_platform_data *pdata =\r\npdev->dev.platform_data;\r\nconst struct matrix_keymap_data *keymap_data;\r\nstruct w90p910_keypad *keypad;\r\nstruct input_dev *input_dev;\r\nstruct resource *res;\r\nint irq;\r\nint error;\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "no platform data defined\n");\r\nreturn -EINVAL;\r\n}\r\nkeymap_data = pdata->keymap_data;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\ndev_err(&pdev->dev, "failed to get keypad irq\n");\r\nreturn -ENXIO;\r\n}\r\nkeypad = kzalloc(sizeof(struct w90p910_keypad), GFP_KERNEL);\r\ninput_dev = input_allocate_device();\r\nif (!keypad || !input_dev) {\r\ndev_err(&pdev->dev, "failed to allocate driver data\n");\r\nerror = -ENOMEM;\r\ngoto failed_free;\r\n}\r\nkeypad->pdata = pdata;\r\nkeypad->input_dev = input_dev;\r\nkeypad->irq = irq;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (res == NULL) {\r\ndev_err(&pdev->dev, "failed to get I/O memory\n");\r\nerror = -ENXIO;\r\ngoto failed_free;\r\n}\r\nres = request_mem_region(res->start, resource_size(res), pdev->name);\r\nif (res == NULL) {\r\ndev_err(&pdev->dev, "failed to request I/O memory\n");\r\nerror = -EBUSY;\r\ngoto failed_free;\r\n}\r\nkeypad->mmio_base = ioremap(res->start, resource_size(res));\r\nif (keypad->mmio_base == NULL) {\r\ndev_err(&pdev->dev, "failed to remap I/O memory\n");\r\nerror = -ENXIO;\r\ngoto failed_free_res;\r\n}\r\nkeypad->clk = clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(keypad->clk)) {\r\ndev_err(&pdev->dev, "failed to get keypad clock\n");\r\nerror = PTR_ERR(keypad->clk);\r\ngoto failed_free_io;\r\n}\r\nmfp_set_groupi(&pdev->dev);\r\ninput_dev->name = pdev->name;\r\ninput_dev->id.bustype = BUS_HOST;\r\ninput_dev->open = w90p910_keypad_open;\r\ninput_dev->close = w90p910_keypad_close;\r\ninput_dev->dev.parent = &pdev->dev;\r\nerror = matrix_keypad_build_keymap(keymap_data, NULL,\r\nW90P910_NUM_ROWS, W90P910_NUM_COLS,\r\nkeypad->keymap, input_dev);\r\nif (error) {\r\ndev_err(&pdev->dev, "failed to build keymap\n");\r\ngoto failed_put_clk;\r\n}\r\nerror = request_irq(keypad->irq, w90p910_keypad_irq_handler,\r\n0, pdev->name, keypad);\r\nif (error) {\r\ndev_err(&pdev->dev, "failed to request IRQ\n");\r\ngoto failed_put_clk;\r\n}\r\n__set_bit(EV_REP, input_dev->evbit);\r\ninput_set_capability(input_dev, EV_MSC, MSC_SCAN);\r\ninput_set_drvdata(input_dev, keypad);\r\nerror = input_register_device(input_dev);\r\nif (error) {\r\ndev_err(&pdev->dev, "failed to register input device\n");\r\ngoto failed_free_irq;\r\n}\r\nplatform_set_drvdata(pdev, keypad);\r\nreturn 0;\r\nfailed_free_irq:\r\nfree_irq(irq, pdev);\r\nfailed_put_clk:\r\nclk_put(keypad->clk);\r\nfailed_free_io:\r\niounmap(keypad->mmio_base);\r\nfailed_free_res:\r\nrelease_mem_region(res->start, resource_size(res));\r\nfailed_free:\r\ninput_free_device(input_dev);\r\nkfree(keypad);\r\nreturn error;\r\n}\r\nstatic int __devexit w90p910_keypad_remove(struct platform_device *pdev)\r\n{\r\nstruct w90p910_keypad *keypad = platform_get_drvdata(pdev);\r\nstruct resource *res;\r\nfree_irq(keypad->irq, pdev);\r\nclk_put(keypad->clk);\r\ninput_unregister_device(keypad->input_dev);\r\niounmap(keypad->mmio_base);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nrelease_mem_region(res->start, resource_size(res));\r\nplatform_set_drvdata(pdev, NULL);\r\nkfree(keypad);\r\nreturn 0;\r\n}

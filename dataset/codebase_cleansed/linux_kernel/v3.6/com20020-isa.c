static int __init com20020isa_probe(struct net_device *dev)\r\n{\r\nint ioaddr;\r\nunsigned long airqmask;\r\nstruct arcnet_local *lp = netdev_priv(dev);\r\nint err;\r\nBUGLVL(D_NORMAL) printk(VERSION);\r\nioaddr = dev->base_addr;\r\nif (!ioaddr) {\r\nBUGMSG(D_NORMAL, "No autoprobe (yet) for IO mapped cards; you "\r\n"must specify the base address!\n");\r\nreturn -ENODEV;\r\n}\r\nif (!request_region(ioaddr, ARCNET_TOTAL_SIZE, "arcnet (COM20020)")) {\r\nBUGMSG(D_NORMAL, "IO region %xh-%xh already allocated.\n",\r\nioaddr, ioaddr + ARCNET_TOTAL_SIZE - 1);\r\nreturn -ENXIO;\r\n}\r\nif (ASTATUS() == 0xFF) {\r\nBUGMSG(D_NORMAL, "IO address %x empty\n", ioaddr);\r\nerr = -ENODEV;\r\ngoto out;\r\n}\r\nif (com20020_check(dev)) {\r\nerr = -ENODEV;\r\ngoto out;\r\n}\r\nif (!dev->irq) {\r\nBUGMSG(D_INIT_REASONS, "intmask was %02Xh\n", inb(_INTMASK));\r\noutb(0, _INTMASK);\r\nairqmask = probe_irq_on();\r\noutb(NORXflag, _INTMASK);\r\nudelay(1);\r\noutb(0, _INTMASK);\r\ndev->irq = probe_irq_off(airqmask);\r\nif ((int)dev->irq <= 0) {\r\nBUGMSG(D_INIT_REASONS, "Autoprobe IRQ failed first time\n");\r\nairqmask = probe_irq_on();\r\noutb(NORXflag, _INTMASK);\r\nudelay(5);\r\noutb(0, _INTMASK);\r\ndev->irq = probe_irq_off(airqmask);\r\nif ((int)dev->irq <= 0) {\r\nBUGMSG(D_NORMAL, "Autoprobe IRQ failed.\n");\r\nerr = -ENODEV;\r\ngoto out;\r\n}\r\n}\r\n}\r\nlp->card_name = "ISA COM20020";\r\nif ((err = com20020_found(dev, 0)) != 0)\r\ngoto out;\r\nreturn 0;\r\nout:\r\nrelease_region(ioaddr, ARCNET_TOTAL_SIZE);\r\nreturn err;\r\n}\r\nstatic int __init com20020_init(void)\r\n{\r\nstruct net_device *dev;\r\nstruct arcnet_local *lp;\r\ndev = alloc_arcdev(device);\r\nif (!dev)\r\nreturn -ENOMEM;\r\nif (node && node != 0xff)\r\ndev->dev_addr[0] = node;\r\ndev->netdev_ops = &com20020_netdev_ops;\r\nlp = netdev_priv(dev);\r\nlp->backplane = backplane;\r\nlp->clockp = clockp & 7;\r\nlp->clockm = clockm & 3;\r\nlp->timeout = timeout & 3;\r\nlp->hw.owner = THIS_MODULE;\r\ndev->base_addr = io;\r\ndev->irq = irq;\r\nif (dev->irq == 2)\r\ndev->irq = 9;\r\nif (com20020isa_probe(dev)) {\r\nfree_netdev(dev);\r\nreturn -EIO;\r\n}\r\nmy_dev = dev;\r\nreturn 0;\r\n}\r\nstatic void __exit com20020_exit(void)\r\n{\r\nunregister_netdev(my_dev);\r\nfree_irq(my_dev->irq, my_dev);\r\nrelease_region(my_dev->base_addr, ARCNET_TOTAL_SIZE);\r\nfree_netdev(my_dev);\r\n}\r\nstatic int __init com20020isa_setup(char *s)\r\n{\r\nint ints[8];\r\ns = get_options(s, 8, ints);\r\nif (!ints[0])\r\nreturn 1;\r\nswitch (ints[0]) {\r\ndefault:\r\nprintk("com90xx: Too many arguments.\n");\r\ncase 6:\r\ntimeout = ints[6];\r\ncase 5:\r\nclockp = ints[5];\r\ncase 4:\r\nbackplane = ints[4];\r\ncase 3:\r\nnode = ints[3];\r\ncase 2:\r\nirq = ints[2];\r\ncase 1:\r\nio = ints[1];\r\n}\r\nif (*s)\r\nsnprintf(device, sizeof(device), "%s", s);\r\nreturn 1;\r\n}

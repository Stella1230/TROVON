void __init nr_loopback_init(void)\r\n{\r\nskb_queue_head_init(&loopback_queue);\r\n}\r\nstatic inline int nr_loopback_running(void)\r\n{\r\nreturn timer_pending(&loopback_timer);\r\n}\r\nint nr_loopback_queue(struct sk_buff *skb)\r\n{\r\nstruct sk_buff *skbn;\r\nif ((skbn = alloc_skb(skb->len, GFP_ATOMIC)) != NULL) {\r\nskb_copy_from_linear_data(skb, skb_put(skbn, skb->len), skb->len);\r\nskb_reset_transport_header(skbn);\r\nskb_queue_tail(&loopback_queue, skbn);\r\nif (!nr_loopback_running())\r\nmod_timer(&loopback_timer, jiffies + 10);\r\n}\r\nkfree_skb(skb);\r\nreturn 1;\r\n}\r\nstatic void nr_loopback_timer(unsigned long param)\r\n{\r\nstruct sk_buff *skb;\r\nax25_address *nr_dest;\r\nstruct net_device *dev;\r\nif ((skb = skb_dequeue(&loopback_queue)) != NULL) {\r\nnr_dest = (ax25_address *)(skb->data + 7);\r\ndev = nr_dev_get(nr_dest);\r\nif (dev == NULL || nr_rx_frame(skb, dev) == 0)\r\nkfree_skb(skb);\r\nif (dev != NULL)\r\ndev_put(dev);\r\nif (!skb_queue_empty(&loopback_queue) && !nr_loopback_running())\r\nmod_timer(&loopback_timer, jiffies + 10);\r\n}\r\n}\r\nvoid __exit nr_loopback_clear(void)\r\n{\r\ndel_timer_sync(&loopback_timer);\r\nskb_queue_purge(&loopback_queue);\r\n}

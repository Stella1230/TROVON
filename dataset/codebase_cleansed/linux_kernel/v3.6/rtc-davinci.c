static inline void rtcif_write(struct davinci_rtc *davinci_rtc,\r\nu32 val, u32 addr)\r\n{\r\nwritel(val, davinci_rtc->base + addr);\r\n}\r\nstatic inline u32 rtcif_read(struct davinci_rtc *davinci_rtc, u32 addr)\r\n{\r\nreturn readl(davinci_rtc->base + addr);\r\n}\r\nstatic inline void rtcif_wait(struct davinci_rtc *davinci_rtc)\r\n{\r\nwhile (rtcif_read(davinci_rtc, PRTCIF_CTLR) & PRTCIF_CTLR_BUSY)\r\ncpu_relax();\r\n}\r\nstatic inline void rtcss_write(struct davinci_rtc *davinci_rtc,\r\nunsigned long val, u8 addr)\r\n{\r\nrtcif_wait(davinci_rtc);\r\nrtcif_write(davinci_rtc, PRTCIF_CTLR_BENL_LSB | addr, PRTCIF_CTLR);\r\nrtcif_write(davinci_rtc, val, PRTCIF_LDATA);\r\nrtcif_wait(davinci_rtc);\r\n}\r\nstatic inline u8 rtcss_read(struct davinci_rtc *davinci_rtc, u8 addr)\r\n{\r\nrtcif_wait(davinci_rtc);\r\nrtcif_write(davinci_rtc, PRTCIF_CTLR_DIR | PRTCIF_CTLR_BENL_LSB | addr,\r\nPRTCIF_CTLR);\r\nrtcif_wait(davinci_rtc);\r\nreturn rtcif_read(davinci_rtc, PRTCIF_LDATA);\r\n}\r\nstatic inline void davinci_rtcss_calendar_wait(struct davinci_rtc *davinci_rtc)\r\n{\r\nwhile (rtcss_read(davinci_rtc, PRTCSS_RTC_CCTRL) &\r\nPRTCSS_RTC_CCTRL_CALBUSY)\r\ncpu_relax();\r\n}\r\nstatic irqreturn_t davinci_rtc_interrupt(int irq, void *class_dev)\r\n{\r\nstruct davinci_rtc *davinci_rtc = class_dev;\r\nunsigned long events = 0;\r\nu32 irq_flg;\r\nu8 alm_irq, tmr_irq;\r\nu8 rtc_ctrl, rtc_cctrl;\r\nint ret = IRQ_NONE;\r\nirq_flg = rtcif_read(davinci_rtc, PRTCIF_INTFLG) &\r\nPRTCIF_INTFLG_RTCSS;\r\nalm_irq = rtcss_read(davinci_rtc, PRTCSS_RTC_CCTRL) &\r\nPRTCSS_RTC_CCTRL_ALMFLG;\r\ntmr_irq = rtcss_read(davinci_rtc, PRTCSS_RTC_CTRL) &\r\nPRTCSS_RTC_CTRL_TMRFLG;\r\nif (irq_flg) {\r\nif (alm_irq) {\r\nevents |= RTC_IRQF | RTC_AF;\r\nrtc_cctrl = rtcss_read(davinci_rtc, PRTCSS_RTC_CCTRL);\r\nrtc_cctrl |= PRTCSS_RTC_CCTRL_ALMFLG;\r\nrtcss_write(davinci_rtc, rtc_cctrl, PRTCSS_RTC_CCTRL);\r\n} else if (tmr_irq) {\r\nevents |= RTC_IRQF | RTC_PF;\r\nrtc_ctrl = rtcss_read(davinci_rtc, PRTCSS_RTC_CTRL);\r\nrtc_ctrl |= PRTCSS_RTC_CTRL_TMRFLG;\r\nrtcss_write(davinci_rtc, rtc_ctrl, PRTCSS_RTC_CTRL);\r\n}\r\nrtcif_write(davinci_rtc, PRTCIF_INTFLG_RTCSS,\r\nPRTCIF_INTFLG);\r\nrtc_update_irq(davinci_rtc->rtc, 1, events);\r\nret = IRQ_HANDLED;\r\n}\r\nreturn ret;\r\n}\r\nstatic int\r\ndavinci_rtc_ioctl(struct device *dev, unsigned int cmd, unsigned long arg)\r\n{\r\nstruct davinci_rtc *davinci_rtc = dev_get_drvdata(dev);\r\nu8 rtc_ctrl;\r\nunsigned long flags;\r\nint ret = 0;\r\nspin_lock_irqsave(&davinci_rtc_lock, flags);\r\nrtc_ctrl = rtcss_read(davinci_rtc, PRTCSS_RTC_CTRL);\r\nswitch (cmd) {\r\ncase RTC_WIE_ON:\r\nrtc_ctrl |= PRTCSS_RTC_CTRL_WEN | PRTCSS_RTC_CTRL_WDTFLG;\r\nbreak;\r\ncase RTC_WIE_OFF:\r\nrtc_ctrl &= ~PRTCSS_RTC_CTRL_WEN;\r\nbreak;\r\ndefault:\r\nret = -ENOIOCTLCMD;\r\n}\r\nrtcss_write(davinci_rtc, rtc_ctrl, PRTCSS_RTC_CTRL);\r\nspin_unlock_irqrestore(&davinci_rtc_lock, flags);\r\nreturn ret;\r\n}\r\nstatic int convertfromdays(u16 days, struct rtc_time *tm)\r\n{\r\nint tmp_days, year, mon;\r\nfor (year = 2000;; year++) {\r\ntmp_days = rtc_year_days(1, 12, year);\r\nif (days >= tmp_days)\r\ndays -= tmp_days;\r\nelse {\r\nfor (mon = 0;; mon++) {\r\ntmp_days = rtc_month_days(mon, year);\r\nif (days >= tmp_days) {\r\ndays -= tmp_days;\r\n} else {\r\ntm->tm_year = year - 1900;\r\ntm->tm_mon = mon;\r\ntm->tm_mday = days + 1;\r\nbreak;\r\n}\r\n}\r\nbreak;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int convert2days(u16 *days, struct rtc_time *tm)\r\n{\r\nint i;\r\n*days = 0;\r\nif (tm->tm_year < 100 || tm->tm_year > 199)\r\nreturn -EINVAL;\r\nfor (i = 2000; i < 1900 + tm->tm_year; i++)\r\n*days += rtc_year_days(1, 12, i);\r\n*days += rtc_year_days(tm->tm_mday, tm->tm_mon, 1900 + tm->tm_year);\r\nreturn 0;\r\n}\r\nstatic int davinci_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct davinci_rtc *davinci_rtc = dev_get_drvdata(dev);\r\nu16 days = 0;\r\nu8 day0, day1;\r\nunsigned long flags;\r\nspin_lock_irqsave(&davinci_rtc_lock, flags);\r\ndavinci_rtcss_calendar_wait(davinci_rtc);\r\ntm->tm_sec = bcd2bin(rtcss_read(davinci_rtc, PRTCSS_RTC_SEC));\r\ndavinci_rtcss_calendar_wait(davinci_rtc);\r\ntm->tm_min = bcd2bin(rtcss_read(davinci_rtc, PRTCSS_RTC_MIN));\r\ndavinci_rtcss_calendar_wait(davinci_rtc);\r\ntm->tm_hour = bcd2bin(rtcss_read(davinci_rtc, PRTCSS_RTC_HOUR));\r\ndavinci_rtcss_calendar_wait(davinci_rtc);\r\nday0 = rtcss_read(davinci_rtc, PRTCSS_RTC_DAY0);\r\ndavinci_rtcss_calendar_wait(davinci_rtc);\r\nday1 = rtcss_read(davinci_rtc, PRTCSS_RTC_DAY1);\r\nspin_unlock_irqrestore(&davinci_rtc_lock, flags);\r\ndays |= day1;\r\ndays <<= 8;\r\ndays |= day0;\r\nif (convertfromdays(days, tm) < 0)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int davinci_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct davinci_rtc *davinci_rtc = dev_get_drvdata(dev);\r\nu16 days;\r\nu8 rtc_cctrl;\r\nunsigned long flags;\r\nif (convert2days(&days, tm) < 0)\r\nreturn -EINVAL;\r\nspin_lock_irqsave(&davinci_rtc_lock, flags);\r\ndavinci_rtcss_calendar_wait(davinci_rtc);\r\nrtcss_write(davinci_rtc, bin2bcd(tm->tm_sec), PRTCSS_RTC_SEC);\r\ndavinci_rtcss_calendar_wait(davinci_rtc);\r\nrtcss_write(davinci_rtc, bin2bcd(tm->tm_min), PRTCSS_RTC_MIN);\r\ndavinci_rtcss_calendar_wait(davinci_rtc);\r\nrtcss_write(davinci_rtc, bin2bcd(tm->tm_hour), PRTCSS_RTC_HOUR);\r\ndavinci_rtcss_calendar_wait(davinci_rtc);\r\nrtcss_write(davinci_rtc, days & 0xFF, PRTCSS_RTC_DAY0);\r\ndavinci_rtcss_calendar_wait(davinci_rtc);\r\nrtcss_write(davinci_rtc, (days & 0xFF00) >> 8, PRTCSS_RTC_DAY1);\r\nrtc_cctrl = rtcss_read(davinci_rtc, PRTCSS_RTC_CCTRL);\r\nrtc_cctrl |= PRTCSS_RTC_CCTRL_CAEN;\r\nrtcss_write(davinci_rtc, rtc_cctrl, PRTCSS_RTC_CCTRL);\r\nspin_unlock_irqrestore(&davinci_rtc_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int davinci_rtc_alarm_irq_enable(struct device *dev,\r\nunsigned int enabled)\r\n{\r\nstruct davinci_rtc *davinci_rtc = dev_get_drvdata(dev);\r\nunsigned long flags;\r\nu8 rtc_cctrl = rtcss_read(davinci_rtc, PRTCSS_RTC_CCTRL);\r\nspin_lock_irqsave(&davinci_rtc_lock, flags);\r\nif (enabled)\r\nrtc_cctrl |= PRTCSS_RTC_CCTRL_DAEN |\r\nPRTCSS_RTC_CCTRL_HAEN |\r\nPRTCSS_RTC_CCTRL_MAEN |\r\nPRTCSS_RTC_CCTRL_ALMFLG |\r\nPRTCSS_RTC_CCTRL_AIEN;\r\nelse\r\nrtc_cctrl &= ~PRTCSS_RTC_CCTRL_AIEN;\r\ndavinci_rtcss_calendar_wait(davinci_rtc);\r\nrtcss_write(davinci_rtc, rtc_cctrl, PRTCSS_RTC_CCTRL);\r\nspin_unlock_irqrestore(&davinci_rtc_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int davinci_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alm)\r\n{\r\nstruct davinci_rtc *davinci_rtc = dev_get_drvdata(dev);\r\nu16 days = 0;\r\nu8 day0, day1;\r\nunsigned long flags;\r\nspin_lock_irqsave(&davinci_rtc_lock, flags);\r\ndavinci_rtcss_calendar_wait(davinci_rtc);\r\nalm->time.tm_min = bcd2bin(rtcss_read(davinci_rtc, PRTCSS_RTC_AMIN));\r\ndavinci_rtcss_calendar_wait(davinci_rtc);\r\nalm->time.tm_hour = bcd2bin(rtcss_read(davinci_rtc, PRTCSS_RTC_AHOUR));\r\ndavinci_rtcss_calendar_wait(davinci_rtc);\r\nday0 = rtcss_read(davinci_rtc, PRTCSS_RTC_ADAY0);\r\ndavinci_rtcss_calendar_wait(davinci_rtc);\r\nday1 = rtcss_read(davinci_rtc, PRTCSS_RTC_ADAY1);\r\nspin_unlock_irqrestore(&davinci_rtc_lock, flags);\r\ndays |= day1;\r\ndays <<= 8;\r\ndays |= day0;\r\nif (convertfromdays(days, &alm->time) < 0)\r\nreturn -EINVAL;\r\nalm->pending = !!(rtcss_read(davinci_rtc,\r\nPRTCSS_RTC_CCTRL) &\r\nPRTCSS_RTC_CCTRL_AIEN);\r\nalm->enabled = alm->pending && device_may_wakeup(dev);\r\nreturn 0;\r\n}\r\nstatic int davinci_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alm)\r\n{\r\nstruct davinci_rtc *davinci_rtc = dev_get_drvdata(dev);\r\nunsigned long flags;\r\nu16 days;\r\nif (alm->time.tm_mday <= 0 && alm->time.tm_mon < 0\r\n&& alm->time.tm_year < 0) {\r\nstruct rtc_time tm;\r\nunsigned long now, then;\r\ndavinci_rtc_read_time(dev, &tm);\r\nrtc_tm_to_time(&tm, &now);\r\nalm->time.tm_mday = tm.tm_mday;\r\nalm->time.tm_mon = tm.tm_mon;\r\nalm->time.tm_year = tm.tm_year;\r\nrtc_tm_to_time(&alm->time, &then);\r\nif (then < now) {\r\nrtc_time_to_tm(now + 24 * 60 * 60, &tm);\r\nalm->time.tm_mday = tm.tm_mday;\r\nalm->time.tm_mon = tm.tm_mon;\r\nalm->time.tm_year = tm.tm_year;\r\n}\r\n}\r\nif (convert2days(&days, &alm->time) < 0)\r\nreturn -EINVAL;\r\nspin_lock_irqsave(&davinci_rtc_lock, flags);\r\ndavinci_rtcss_calendar_wait(davinci_rtc);\r\nrtcss_write(davinci_rtc, bin2bcd(alm->time.tm_min), PRTCSS_RTC_AMIN);\r\ndavinci_rtcss_calendar_wait(davinci_rtc);\r\nrtcss_write(davinci_rtc, bin2bcd(alm->time.tm_hour), PRTCSS_RTC_AHOUR);\r\ndavinci_rtcss_calendar_wait(davinci_rtc);\r\nrtcss_write(davinci_rtc, days & 0xFF, PRTCSS_RTC_ADAY0);\r\ndavinci_rtcss_calendar_wait(davinci_rtc);\r\nrtcss_write(davinci_rtc, (days & 0xFF00) >> 8, PRTCSS_RTC_ADAY1);\r\nspin_unlock_irqrestore(&davinci_rtc_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int __init davinci_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct davinci_rtc *davinci_rtc;\r\nstruct resource *res, *mem;\r\nint ret = 0;\r\ndavinci_rtc = kzalloc(sizeof(struct davinci_rtc), GFP_KERNEL);\r\nif (!davinci_rtc) {\r\ndev_dbg(dev, "could not allocate memory for private data\n");\r\nreturn -ENOMEM;\r\n}\r\ndavinci_rtc->irq = platform_get_irq(pdev, 0);\r\nif (davinci_rtc->irq < 0) {\r\ndev_err(dev, "no RTC irq\n");\r\nret = davinci_rtc->irq;\r\ngoto fail1;\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\ndev_err(dev, "no mem resource\n");\r\nret = -EINVAL;\r\ngoto fail1;\r\n}\r\ndavinci_rtc->pbase = res->start;\r\ndavinci_rtc->base_size = resource_size(res);\r\nmem = request_mem_region(davinci_rtc->pbase, davinci_rtc->base_size,\r\npdev->name);\r\nif (!mem) {\r\ndev_err(dev, "RTC registers at %08x are not free\n",\r\ndavinci_rtc->pbase);\r\nret = -EBUSY;\r\ngoto fail1;\r\n}\r\ndavinci_rtc->base = ioremap(davinci_rtc->pbase, davinci_rtc->base_size);\r\nif (!davinci_rtc->base) {\r\ndev_err(dev, "unable to ioremap MEM resource\n");\r\nret = -ENOMEM;\r\ngoto fail2;\r\n}\r\nplatform_set_drvdata(pdev, davinci_rtc);\r\ndavinci_rtc->rtc = rtc_device_register(pdev->name, &pdev->dev,\r\n&davinci_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(davinci_rtc->rtc)) {\r\ndev_err(dev, "unable to register RTC device, err %ld\n",\r\nPTR_ERR(davinci_rtc->rtc));\r\ngoto fail3;\r\n}\r\nrtcif_write(davinci_rtc, PRTCIF_INTFLG_RTCSS, PRTCIF_INTFLG);\r\nrtcif_write(davinci_rtc, 0, PRTCIF_INTEN);\r\nrtcss_write(davinci_rtc, 0, PRTCSS_RTC_INTC_EXTENA1);\r\nrtcss_write(davinci_rtc, 0, PRTCSS_RTC_CTRL);\r\nrtcss_write(davinci_rtc, 0, PRTCSS_RTC_CCTRL);\r\nret = request_irq(davinci_rtc->irq, davinci_rtc_interrupt,\r\n0, "davinci_rtc", davinci_rtc);\r\nif (ret < 0) {\r\ndev_err(dev, "unable to register davinci RTC interrupt\n");\r\ngoto fail4;\r\n}\r\nrtcif_write(davinci_rtc, PRTCIF_INTEN_RTCSS, PRTCIF_INTEN);\r\nrtcss_write(davinci_rtc, PRTCSS_RTC_INTC_EXTENA1_MASK,\r\nPRTCSS_RTC_INTC_EXTENA1);\r\nrtcss_write(davinci_rtc, PRTCSS_RTC_CCTRL_CAEN, PRTCSS_RTC_CCTRL);\r\ndevice_init_wakeup(&pdev->dev, 0);\r\nreturn 0;\r\nfail4:\r\nrtc_device_unregister(davinci_rtc->rtc);\r\nfail3:\r\nplatform_set_drvdata(pdev, NULL);\r\niounmap(davinci_rtc->base);\r\nfail2:\r\nrelease_mem_region(davinci_rtc->pbase, davinci_rtc->base_size);\r\nfail1:\r\nkfree(davinci_rtc);\r\nreturn ret;\r\n}\r\nstatic int __devexit davinci_rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct davinci_rtc *davinci_rtc = platform_get_drvdata(pdev);\r\ndevice_init_wakeup(&pdev->dev, 0);\r\nrtcif_write(davinci_rtc, 0, PRTCIF_INTEN);\r\nfree_irq(davinci_rtc->irq, davinci_rtc);\r\nrtc_device_unregister(davinci_rtc->rtc);\r\niounmap(davinci_rtc->base);\r\nrelease_mem_region(davinci_rtc->pbase, davinci_rtc->base_size);\r\nplatform_set_drvdata(pdev, NULL);\r\nkfree(davinci_rtc);\r\nreturn 0;\r\n}\r\nstatic int __init rtc_init(void)\r\n{\r\nreturn platform_driver_probe(&davinci_rtc_driver, davinci_rtc_probe);\r\n}\r\nstatic void __exit rtc_exit(void)\r\n{\r\nplatform_driver_unregister(&davinci_rtc_driver);\r\n}

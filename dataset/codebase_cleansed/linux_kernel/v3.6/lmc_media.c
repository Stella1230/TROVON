static void\r\nlmc_dummy_set_1 (lmc_softc_t * const sc, int a)\r\n{\r\n}\r\nstatic void\r\nlmc_dummy_set2_1 (lmc_softc_t * const sc, lmc_ctl_t * a)\r\n{\r\n}\r\nstatic void\r\nlmc_hssi_init (lmc_softc_t * const sc)\r\n{\r\nsc->ictl.cardtype = LMC_CTL_CARDTYPE_LMC5200;\r\nlmc_gpio_mkoutput (sc, LMC_GEP_HSSI_CLOCK);\r\n}\r\nstatic void\r\nlmc_hssi_default (lmc_softc_t * const sc)\r\n{\r\nsc->lmc_miireg16 = LMC_MII16_LED_ALL;\r\nsc->lmc_media->set_link_status (sc, LMC_LINK_DOWN);\r\nsc->lmc_media->set_clock_source (sc, LMC_CTL_CLOCK_SOURCE_EXT);\r\nsc->lmc_media->set_crc_length (sc, LMC_CTL_CRC_LENGTH_16);\r\n}\r\nstatic void\r\nlmc_hssi_set_status (lmc_softc_t * const sc, lmc_ctl_t * ctl)\r\n{\r\nif (ctl == NULL)\r\n{\r\nsc->lmc_media->set_clock_source (sc, sc->ictl.clock_source);\r\nlmc_set_protocol (sc, NULL);\r\nreturn;\r\n}\r\nif (ctl->clock_source && !sc->ictl.clock_source)\r\n{\r\nsc->lmc_media->set_clock_source (sc, LMC_CTL_CLOCK_SOURCE_INT);\r\nsc->lmc_timing = LMC_CTL_CLOCK_SOURCE_INT;\r\n}\r\nelse if (!ctl->clock_source && sc->ictl.clock_source)\r\n{\r\nsc->lmc_timing = LMC_CTL_CLOCK_SOURCE_EXT;\r\nsc->lmc_media->set_clock_source (sc, LMC_CTL_CLOCK_SOURCE_EXT);\r\n}\r\nlmc_set_protocol (sc, ctl);\r\n}\r\nstatic void\r\nlmc_hssi_set_clock (lmc_softc_t * const sc, int ie)\r\n{\r\nint old;\r\nold = sc->ictl.clock_source;\r\nif (ie == LMC_CTL_CLOCK_SOURCE_EXT)\r\n{\r\nsc->lmc_gpio |= LMC_GEP_HSSI_CLOCK;\r\nLMC_CSR_WRITE (sc, csr_gp, sc->lmc_gpio);\r\nsc->ictl.clock_source = LMC_CTL_CLOCK_SOURCE_EXT;\r\nif(old != ie)\r\nprintk (LMC_PRINTF_FMT ": clock external\n", LMC_PRINTF_ARGS);\r\n}\r\nelse\r\n{\r\nsc->lmc_gpio &= ~(LMC_GEP_HSSI_CLOCK);\r\nLMC_CSR_WRITE (sc, csr_gp, sc->lmc_gpio);\r\nsc->ictl.clock_source = LMC_CTL_CLOCK_SOURCE_INT;\r\nif(old != ie)\r\nprintk (LMC_PRINTF_FMT ": clock internal\n", LMC_PRINTF_ARGS);\r\n}\r\n}\r\nstatic int\r\nlmc_hssi_get_link_status (lmc_softc_t * const sc)\r\n{\r\nreturn lmc_ssi_get_link_status(sc);\r\n}\r\nstatic void\r\nlmc_hssi_set_link_status (lmc_softc_t * const sc, int state)\r\n{\r\nif (state == LMC_LINK_UP)\r\nsc->lmc_miireg16 |= LMC_MII16_HSSI_TA;\r\nelse\r\nsc->lmc_miireg16 &= ~LMC_MII16_HSSI_TA;\r\nlmc_mii_writereg (sc, 0, 16, sc->lmc_miireg16);\r\n}\r\nstatic void\r\nlmc_hssi_set_crc_length (lmc_softc_t * const sc, int state)\r\n{\r\nif (state == LMC_CTL_CRC_LENGTH_32)\r\n{\r\nsc->lmc_miireg16 |= LMC_MII16_HSSI_CRC;\r\nsc->ictl.crc_length = LMC_CTL_CRC_LENGTH_32;\r\n}\r\nelse\r\n{\r\nsc->lmc_miireg16 &= ~LMC_MII16_HSSI_CRC;\r\nsc->ictl.crc_length = LMC_CTL_CRC_LENGTH_16;\r\n}\r\nlmc_mii_writereg (sc, 0, 16, sc->lmc_miireg16);\r\n}\r\nstatic void\r\nlmc_hssi_watchdog (lmc_softc_t * const sc)\r\n{\r\n}\r\nstatic void\r\nlmc_ds3_set_100ft (lmc_softc_t * const sc, int ie)\r\n{\r\nif (ie == LMC_CTL_CABLE_LENGTH_GT_100FT)\r\n{\r\nsc->lmc_miireg16 &= ~LMC_MII16_DS3_ZERO;\r\nsc->ictl.cable_length = LMC_CTL_CABLE_LENGTH_GT_100FT;\r\n}\r\nelse if (ie == LMC_CTL_CABLE_LENGTH_LT_100FT)\r\n{\r\nsc->lmc_miireg16 |= LMC_MII16_DS3_ZERO;\r\nsc->ictl.cable_length = LMC_CTL_CABLE_LENGTH_LT_100FT;\r\n}\r\nlmc_mii_writereg (sc, 0, 16, sc->lmc_miireg16);\r\n}\r\nstatic void\r\nlmc_ds3_default (lmc_softc_t * const sc)\r\n{\r\nsc->lmc_miireg16 = LMC_MII16_LED_ALL;\r\nsc->lmc_media->set_link_status (sc, LMC_LINK_DOWN);\r\nsc->lmc_media->set_cable_length (sc, LMC_CTL_CABLE_LENGTH_LT_100FT);\r\nsc->lmc_media->set_scrambler (sc, LMC_CTL_OFF);\r\nsc->lmc_media->set_crc_length (sc, LMC_CTL_CRC_LENGTH_16);\r\n}\r\nstatic void\r\nlmc_ds3_set_status (lmc_softc_t * const sc, lmc_ctl_t * ctl)\r\n{\r\nif (ctl == NULL)\r\n{\r\nsc->lmc_media->set_cable_length (sc, sc->ictl.cable_length);\r\nsc->lmc_media->set_scrambler (sc, sc->ictl.scrambler_onoff);\r\nlmc_set_protocol (sc, NULL);\r\nreturn;\r\n}\r\nif (ctl->cable_length && !sc->ictl.cable_length)\r\nlmc_ds3_set_100ft (sc, LMC_CTL_CABLE_LENGTH_GT_100FT);\r\nelse if (!ctl->cable_length && sc->ictl.cable_length)\r\nlmc_ds3_set_100ft (sc, LMC_CTL_CABLE_LENGTH_LT_100FT);\r\nif (ctl->scrambler_onoff && !sc->ictl.scrambler_onoff)\r\nlmc_ds3_set_scram (sc, LMC_CTL_ON);\r\nelse if (!ctl->scrambler_onoff && sc->ictl.scrambler_onoff)\r\nlmc_ds3_set_scram (sc, LMC_CTL_OFF);\r\nlmc_set_protocol (sc, ctl);\r\n}\r\nstatic void\r\nlmc_ds3_init (lmc_softc_t * const sc)\r\n{\r\nint i;\r\nsc->ictl.cardtype = LMC_CTL_CARDTYPE_LMC5245;\r\nfor (i = 0; i < 21; i++)\r\n{\r\nlmc_mii_writereg (sc, 0, 17, i);\r\nlmc_mii_writereg (sc, 0, 18, 0);\r\n}\r\nlmc_mii_writereg (sc, 0, 17, 1);\r\nlmc_mii_writereg (sc, 0, 18, 0x25);\r\nlmc_mii_writereg (sc, 0, 17, 5);\r\nlmc_mii_writereg (sc, 0, 18, 0x80);\r\nlmc_mii_writereg (sc, 0, 17, 14);\r\nlmc_mii_writereg (sc, 0, 18, 0x30);\r\nfor (i = 0; i < 21; i++)\r\n{\r\nlmc_mii_writereg (sc, 0, 17, i);\r\nlmc_mii_readreg (sc, 0, 18);\r\n}\r\n}\r\nstatic void\r\nlmc_ds3_set_scram (lmc_softc_t * const sc, int ie)\r\n{\r\nif (ie == LMC_CTL_ON)\r\n{\r\nsc->lmc_miireg16 |= LMC_MII16_DS3_SCRAM;\r\nsc->ictl.scrambler_onoff = LMC_CTL_ON;\r\n}\r\nelse\r\n{\r\nsc->lmc_miireg16 &= ~LMC_MII16_DS3_SCRAM;\r\nsc->ictl.scrambler_onoff = LMC_CTL_OFF;\r\n}\r\nlmc_mii_writereg (sc, 0, 16, sc->lmc_miireg16);\r\n}\r\nstatic int\r\nlmc_ds3_get_link_status (lmc_softc_t * const sc)\r\n{\r\nu16 link_status, link_status_11;\r\nint ret = 1;\r\nlmc_mii_writereg (sc, 0, 17, 7);\r\nlink_status = lmc_mii_readreg (sc, 0, 18);\r\nlmc_led_on(sc, LMC_DS3_LED2);\r\nif ((link_status & LMC_FRAMER_REG0_DLOS) ||\r\n(link_status & LMC_FRAMER_REG0_OOFS)){\r\nret = 0;\r\nif(sc->last_led_err[3] != 1){\r\nu16 r1;\r\nlmc_mii_writereg (sc, 0, 17, 01);\r\nr1 = lmc_mii_readreg (sc, 0, 18);\r\nr1 &= 0xfe;\r\nlmc_mii_writereg(sc, 0, 18, r1);\r\nprintk(KERN_WARNING "%s: Red Alarm - Loss of Signal or Loss of Framing\n", sc->name);\r\n}\r\nlmc_led_on(sc, LMC_DS3_LED3);\r\nsc->last_led_err[3] = 1;\r\n}\r\nelse {\r\nlmc_led_off(sc, LMC_DS3_LED3);\r\nif(sc->last_led_err[3] == 1){\r\nu16 r1;\r\nlmc_mii_writereg (sc, 0, 17, 01);\r\nr1 = lmc_mii_readreg (sc, 0, 18);\r\nr1 |= 0x01;\r\nlmc_mii_writereg(sc, 0, 18, r1);\r\n}\r\nsc->last_led_err[3] = 0;\r\n}\r\nlmc_mii_writereg(sc, 0, 17, 0x10);\r\nlink_status_11 = lmc_mii_readreg(sc, 0, 18);\r\nif((link_status & LMC_FRAMER_REG0_AIS) ||\r\n(link_status_11 & LMC_FRAMER_REG10_XBIT)) {\r\nret = 0;\r\nif(sc->last_led_err[0] != 1){\r\nprintk(KERN_WARNING "%s: AIS Alarm or XBit Error\n", sc->name);\r\nprintk(KERN_WARNING "%s: Remote end has loss of signal or framing\n", sc->name);\r\n}\r\nlmc_led_on(sc, LMC_DS3_LED0);\r\nsc->last_led_err[0] = 1;\r\n}\r\nelse {\r\nlmc_led_off(sc, LMC_DS3_LED0);\r\nsc->last_led_err[0] = 0;\r\n}\r\nlmc_mii_writereg (sc, 0, 17, 9);\r\nlink_status = lmc_mii_readreg (sc, 0, 18);\r\nif(link_status & LMC_FRAMER_REG9_RBLUE){\r\nret = 0;\r\nif(sc->last_led_err[1] != 1){\r\nprintk(KERN_WARNING "%s: Blue Alarm - Receiving all 1's\n", sc->name);\r\n}\r\nlmc_led_on(sc, LMC_DS3_LED1);\r\nsc->last_led_err[1] = 1;\r\n}\r\nelse {\r\nlmc_led_off(sc, LMC_DS3_LED1);\r\nsc->last_led_err[1] = 0;\r\n}\r\nreturn ret;\r\n}\r\nstatic void\r\nlmc_ds3_set_crc_length (lmc_softc_t * const sc, int state)\r\n{\r\nif (state == LMC_CTL_CRC_LENGTH_32)\r\n{\r\nsc->lmc_miireg16 |= LMC_MII16_DS3_CRC;\r\nsc->ictl.crc_length = LMC_CTL_CRC_LENGTH_32;\r\n}\r\nelse\r\n{\r\nsc->lmc_miireg16 &= ~LMC_MII16_DS3_CRC;\r\nsc->ictl.crc_length = LMC_CTL_CRC_LENGTH_16;\r\n}\r\nlmc_mii_writereg (sc, 0, 16, sc->lmc_miireg16);\r\n}\r\nstatic void\r\nlmc_ds3_watchdog (lmc_softc_t * const sc)\r\n{\r\n}\r\nstatic void lmc_ssi_init(lmc_softc_t * const sc)\r\n{\r\nu16 mii17;\r\nint cable;\r\nsc->ictl.cardtype = LMC_CTL_CARDTYPE_LMC1000;\r\nmii17 = lmc_mii_readreg(sc, 0, 17);\r\ncable = (mii17 & LMC_MII17_SSI_CABLE_MASK) >> LMC_MII17_SSI_CABLE_SHIFT;\r\nsc->ictl.cable_type = cable;\r\nlmc_gpio_mkoutput(sc, LMC_GEP_SSI_TXCLOCK);\r\n}\r\nstatic void\r\nlmc_ssi_default (lmc_softc_t * const sc)\r\n{\r\nsc->lmc_miireg16 = LMC_MII16_LED_ALL;\r\nlmc_gpio_mkoutput (sc, LMC_GEP_SSI_TXCLOCK);\r\nsc->lmc_media->set_link_status (sc, LMC_LINK_DOWN);\r\nsc->lmc_media->set_clock_source (sc, LMC_CTL_CLOCK_SOURCE_EXT);\r\nsc->lmc_media->set_speed (sc, NULL);\r\nsc->lmc_media->set_crc_length (sc, LMC_CTL_CRC_LENGTH_16);\r\n}\r\nstatic void\r\nlmc_ssi_set_status (lmc_softc_t * const sc, lmc_ctl_t * ctl)\r\n{\r\nif (ctl == NULL)\r\n{\r\nsc->lmc_media->set_clock_source (sc, sc->ictl.clock_source);\r\nsc->lmc_media->set_speed (sc, &sc->ictl);\r\nlmc_set_protocol (sc, NULL);\r\nreturn;\r\n}\r\nif (ctl->clock_source == LMC_CTL_CLOCK_SOURCE_INT\r\n&& sc->ictl.clock_source == LMC_CTL_CLOCK_SOURCE_EXT)\r\n{\r\nsc->lmc_media->set_clock_source (sc, LMC_CTL_CLOCK_SOURCE_INT);\r\nsc->lmc_timing = LMC_CTL_CLOCK_SOURCE_INT;\r\n}\r\nelse if (ctl->clock_source == LMC_CTL_CLOCK_SOURCE_EXT\r\n&& sc->ictl.clock_source == LMC_CTL_CLOCK_SOURCE_INT)\r\n{\r\nsc->lmc_media->set_clock_source (sc, LMC_CTL_CLOCK_SOURCE_EXT);\r\nsc->lmc_timing = LMC_CTL_CLOCK_SOURCE_EXT;\r\n}\r\nif (ctl->clock_rate != sc->ictl.clock_rate)\r\nsc->lmc_media->set_speed (sc, ctl);\r\nlmc_set_protocol (sc, ctl);\r\n}\r\nstatic void\r\nlmc_ssi_set_clock (lmc_softc_t * const sc, int ie)\r\n{\r\nint old;\r\nold = ie;\r\nif (ie == LMC_CTL_CLOCK_SOURCE_EXT)\r\n{\r\nsc->lmc_gpio &= ~(LMC_GEP_SSI_TXCLOCK);\r\nLMC_CSR_WRITE (sc, csr_gp, sc->lmc_gpio);\r\nsc->ictl.clock_source = LMC_CTL_CLOCK_SOURCE_EXT;\r\nif(ie != old)\r\nprintk (LMC_PRINTF_FMT ": clock external\n", LMC_PRINTF_ARGS);\r\n}\r\nelse\r\n{\r\nsc->lmc_gpio |= LMC_GEP_SSI_TXCLOCK;\r\nLMC_CSR_WRITE (sc, csr_gp, sc->lmc_gpio);\r\nsc->ictl.clock_source = LMC_CTL_CLOCK_SOURCE_INT;\r\nif(ie != old)\r\nprintk (LMC_PRINTF_FMT ": clock internal\n", LMC_PRINTF_ARGS);\r\n}\r\n}\r\nstatic void\r\nlmc_ssi_set_speed (lmc_softc_t * const sc, lmc_ctl_t * ctl)\r\n{\r\nlmc_ctl_t *ictl = &sc->ictl;\r\nlmc_av9110_t *av;\r\nif (ctl == NULL)\r\n{\r\nav = &ictl->cardspec.ssi;\r\nictl->clock_rate = 1500000;\r\nav->f = ictl->clock_rate;\r\nav->n = 120;\r\nav->m = 100;\r\nav->v = 1;\r\nav->x = 1;\r\nav->r = 2;\r\nwrite_av9110 (sc, av->n, av->m, av->v, av->x, av->r);\r\nreturn;\r\n}\r\nav = &ctl->cardspec.ssi;\r\nif (av->f == 0)\r\nreturn;\r\nictl->clock_rate = av->f;\r\nictl->cardspec.ssi = *av;\r\nwrite_av9110 (sc, av->n, av->m, av->v, av->x, av->r);\r\n}\r\nstatic int\r\nlmc_ssi_get_link_status (lmc_softc_t * const sc)\r\n{\r\nu16 link_status;\r\nu32 ticks;\r\nint ret = 1;\r\nint hw_hdsk = 1;\r\nlink_status = lmc_mii_readreg (sc, 0, 16);\r\nticks = LMC_CSR_READ (sc, csr_gp_timer);\r\nticks = 0x0000ffff - (ticks & 0x0000ffff);\r\nlmc_led_on (sc, LMC_MII16_LED0);\r\nif (sc->lmc_timing == LMC_CTL_CLOCK_SOURCE_INT) {\r\nlmc_led_off(sc, LMC_MII16_LED3);\r\n}\r\nelse if (ticks == 0 ) {\r\nret = 0;\r\nif (sc->last_led_err[3] != 1) {\r\nsc->extra_stats.tx_lossOfClockCnt++;\r\nprintk(KERN_WARNING "%s: Lost Clock, Link Down\n", sc->name);\r\n}\r\nsc->last_led_err[3] = 1;\r\nlmc_led_on (sc, LMC_MII16_LED3);\r\n}\r\nelse {\r\nif(sc->last_led_err[3] == 1)\r\nprintk(KERN_WARNING "%s: Clock Returned\n", sc->name);\r\nsc->last_led_err[3] = 0;\r\nlmc_led_off (sc, LMC_MII16_LED3);\r\n}\r\nif ((link_status & LMC_MII16_SSI_DSR) == 0) {\r\nret = 0;\r\nhw_hdsk = 0;\r\n}\r\n#ifdef CONFIG_LMC_IGNORE_HARDWARE_HANDSHAKE\r\nif ((link_status & (LMC_MII16_SSI_CTS | LMC_MII16_SSI_DCD)) == 0){\r\nret = 0;\r\nhw_hdsk = 0;\r\n}\r\n#endif\r\nif(hw_hdsk == 0){\r\nif(sc->last_led_err[1] != 1)\r\nprintk(KERN_WARNING "%s: DSR not asserted\n", sc->name);\r\nsc->last_led_err[1] = 1;\r\nlmc_led_off(sc, LMC_MII16_LED1);\r\n}\r\nelse {\r\nif(sc->last_led_err[1] != 0)\r\nprintk(KERN_WARNING "%s: DSR now asserted\n", sc->name);\r\nsc->last_led_err[1] = 0;\r\nlmc_led_on(sc, LMC_MII16_LED1);\r\n}\r\nif(ret == 1) {\r\nlmc_led_on(sc, LMC_MII16_LED2);\r\n}\r\nreturn ret;\r\n}\r\nstatic void\r\nlmc_ssi_set_link_status (lmc_softc_t * const sc, int state)\r\n{\r\nif (state == LMC_LINK_UP)\r\n{\r\nsc->lmc_miireg16 |= (LMC_MII16_SSI_DTR | LMC_MII16_SSI_RTS);\r\nprintk (LMC_PRINTF_FMT ": asserting DTR and RTS\n", LMC_PRINTF_ARGS);\r\n}\r\nelse\r\n{\r\nsc->lmc_miireg16 &= ~(LMC_MII16_SSI_DTR | LMC_MII16_SSI_RTS);\r\nprintk (LMC_PRINTF_FMT ": deasserting DTR and RTS\n", LMC_PRINTF_ARGS);\r\n}\r\nlmc_mii_writereg (sc, 0, 16, sc->lmc_miireg16);\r\n}\r\nstatic void\r\nlmc_ssi_set_crc_length (lmc_softc_t * const sc, int state)\r\n{\r\nif (state == LMC_CTL_CRC_LENGTH_32)\r\n{\r\nsc->lmc_miireg16 |= LMC_MII16_SSI_CRC;\r\nsc->ictl.crc_length = LMC_CTL_CRC_LENGTH_32;\r\nsc->lmc_crcSize = LMC_CTL_CRC_BYTESIZE_4;\r\n}\r\nelse\r\n{\r\nsc->lmc_miireg16 &= ~LMC_MII16_SSI_CRC;\r\nsc->ictl.crc_length = LMC_CTL_CRC_LENGTH_16;\r\nsc->lmc_crcSize = LMC_CTL_CRC_BYTESIZE_2;\r\n}\r\nlmc_mii_writereg (sc, 0, 16, sc->lmc_miireg16);\r\n}\r\nstatic inline void\r\nwrite_av9110_bit (lmc_softc_t * sc, int c)\r\n{\r\nsc->lmc_gpio &= ~(LMC_GEP_CLK);\r\nif (c & 0x01)\r\nsc->lmc_gpio |= LMC_GEP_DATA;\r\nelse\r\nsc->lmc_gpio &= ~(LMC_GEP_DATA);\r\nLMC_CSR_WRITE (sc, csr_gp, sc->lmc_gpio);\r\nsc->lmc_gpio |= LMC_GEP_CLK;\r\nLMC_CSR_WRITE (sc, csr_gp, sc->lmc_gpio);\r\nsc->lmc_gpio &= ~(LMC_GEP_CLK);\r\nLMC_CSR_WRITE (sc, csr_gp, sc->lmc_gpio);\r\n}\r\nstatic void write_av9110(lmc_softc_t *sc, u32 n, u32 m, u32 v, u32 x, u32 r)\r\n{\r\nint i;\r\n#if 0\r\nprintk (LMC_PRINTF_FMT ": speed %u, %d %d %d %d %d\n",\r\nLMC_PRINTF_ARGS, sc->ictl.clock_rate, n, m, v, x, r);\r\n#endif\r\nsc->lmc_gpio |= LMC_GEP_SSI_GENERATOR;\r\nsc->lmc_gpio &= ~(LMC_GEP_DATA | LMC_GEP_CLK);\r\nLMC_CSR_WRITE (sc, csr_gp, sc->lmc_gpio);\r\nlmc_gpio_mkoutput (sc, (LMC_GEP_DATA | LMC_GEP_CLK\r\n| LMC_GEP_SSI_GENERATOR));\r\nsc->lmc_gpio &= ~(LMC_GEP_SSI_GENERATOR);\r\nLMC_CSR_WRITE (sc, csr_gp, sc->lmc_gpio);\r\nfor (i = 0; i < 7; i++)\r\nwrite_av9110_bit (sc, n >> i);\r\nfor (i = 0; i < 7; i++)\r\nwrite_av9110_bit (sc, m >> i);\r\nfor (i = 0; i < 1; i++)\r\nwrite_av9110_bit (sc, v >> i);\r\nfor (i = 0; i < 2; i++)\r\nwrite_av9110_bit (sc, x >> i);\r\nfor (i = 0; i < 2; i++)\r\nwrite_av9110_bit (sc, r >> i);\r\nfor (i = 0; i < 5; i++)\r\nwrite_av9110_bit (sc, 0x17 >> i);\r\nlmc_gpio_mkinput (sc,\r\n(LMC_GEP_DATA | LMC_GEP_CLK\r\n| LMC_GEP_SSI_GENERATOR));\r\n}\r\nstatic void lmc_ssi_watchdog(lmc_softc_t * const sc)\r\n{\r\nu16 mii17 = lmc_mii_readreg(sc, 0, 17);\r\nif (((mii17 >> 3) & 7) == 7)\r\nlmc_led_off(sc, LMC_MII16_LED2);\r\nelse\r\nlmc_led_on(sc, LMC_MII16_LED2);\r\n}\r\nstatic void\r\nlmc_t1_write (lmc_softc_t * const sc, int a, int d)\r\n{\r\nlmc_mii_writereg (sc, 0, 17, a);\r\nlmc_mii_writereg (sc, 0, 18, d);\r\n}\r\nstatic void\r\nlmc_t1_init (lmc_softc_t * const sc)\r\n{\r\nu16 mii16;\r\nint i;\r\nsc->ictl.cardtype = LMC_CTL_CARDTYPE_LMC1200;\r\nmii16 = lmc_mii_readreg (sc, 0, 16);\r\nmii16 &= ~LMC_MII16_T1_RST;\r\nlmc_mii_writereg (sc, 0, 16, mii16 | LMC_MII16_T1_RST);\r\nlmc_mii_writereg (sc, 0, 16, mii16);\r\nsc->lmc_miireg16 = mii16;\r\nlmc_t1_set_circuit_type(sc, LMC_CTL_CIRCUIT_TYPE_T1);\r\nmii16 = sc->lmc_miireg16;\r\nlmc_t1_write (sc, 0x01, 0x1B);\r\nlmc_t1_write (sc, 0x02, 0x42);\r\nlmc_t1_write (sc, 0x14, 0x00);\r\nlmc_t1_write (sc, 0x15, 0x00);\r\nlmc_t1_write (sc, 0x18, 0xFF);\r\nlmc_t1_write (sc, 0x19, 0x30);\r\nlmc_t1_write (sc, 0x1A, 0x0F);\r\nlmc_t1_write (sc, 0x20, 0x41);\r\nlmc_t1_write (sc, 0x22, 0x76);\r\nlmc_t1_write (sc, 0x40, 0x03);\r\nlmc_t1_write (sc, 0x45, 0x00);\r\nlmc_t1_write (sc, 0x46, 0x05);\r\nlmc_t1_write (sc, 0x68, 0x40);\r\nlmc_t1_write (sc, 0x70, 0x0D);\r\nlmc_t1_write (sc, 0x71, 0x05);\r\nlmc_t1_write (sc, 0x72, 0x0B);\r\nlmc_t1_write (sc, 0x73, 0x00);\r\nlmc_t1_write (sc, 0x74, 0x00);\r\nlmc_t1_write (sc, 0x75, 0x00);\r\nlmc_t1_write (sc, 0x76, 0x00);\r\nlmc_t1_write (sc, 0x77, 0x00);\r\nlmc_t1_write (sc, 0x90, 0x05);\r\nlmc_t1_write (sc, 0x91, 0x05);\r\nlmc_t1_write (sc, 0xA6, 0x00);\r\nlmc_t1_write (sc, 0xB1, 0x00);\r\nlmc_t1_write (sc, 0xD0, 0x47);\r\nlmc_t1_write (sc, 0xD1, 0x70);\r\nlmc_t1_write (sc, 0xD4, 0x30);\r\nfor (i = 0; i < 32; i++)\r\n{\r\nlmc_t1_write (sc, 0x0E0 + i, 0x00);\r\nlmc_t1_write (sc, 0x100 + i, 0x00);\r\nlmc_t1_write (sc, 0x180 + i, 0x00);\r\n}\r\nfor (i = 1; i < 25; i++)\r\n{\r\nlmc_t1_write (sc, 0x0E0 + i, 0x0D);\r\n}\r\nmii16 |= LMC_MII16_T1_XOE;\r\nlmc_mii_writereg (sc, 0, 16, mii16);\r\nsc->lmc_miireg16 = mii16;\r\n}\r\nstatic void\r\nlmc_t1_default (lmc_softc_t * const sc)\r\n{\r\nsc->lmc_miireg16 = LMC_MII16_LED_ALL;\r\nsc->lmc_media->set_link_status (sc, LMC_LINK_DOWN);\r\nsc->lmc_media->set_circuit_type (sc, LMC_CTL_CIRCUIT_TYPE_T1);\r\nsc->lmc_media->set_crc_length (sc, LMC_CTL_CRC_LENGTH_16);\r\nsc->ictl.clock_source = LMC_CTL_CLOCK_SOURCE_INT;\r\n}\r\nstatic void\r\nlmc_t1_set_status (lmc_softc_t * const sc, lmc_ctl_t * ctl)\r\n{\r\nif (ctl == NULL)\r\n{\r\nsc->lmc_media->set_circuit_type (sc, sc->ictl.circuit_type);\r\nlmc_set_protocol (sc, NULL);\r\nreturn;\r\n}\r\nif (ctl->circuit_type == LMC_CTL_CIRCUIT_TYPE_T1\r\n&& sc->ictl.circuit_type ==\r\nLMC_CTL_CIRCUIT_TYPE_E1) sc->lmc_media->set_circuit_type (sc,\r\nLMC_CTL_CIRCUIT_TYPE_E1);\r\nelse if (ctl->circuit_type == LMC_CTL_CIRCUIT_TYPE_E1\r\n&& sc->ictl.circuit_type == LMC_CTL_CIRCUIT_TYPE_T1)\r\nsc->lmc_media->set_circuit_type (sc, LMC_CTL_CIRCUIT_TYPE_T1);\r\nlmc_set_protocol (sc, ctl);\r\n}\r\nstatic int\r\nlmc_t1_get_link_status (lmc_softc_t * const sc)\r\n{\r\nu16 link_status;\r\nint ret = 1;\r\nlmc_trace(sc->lmc_device, "lmc_t1_get_link_status in");\r\nlmc_led_on(sc, LMC_DS3_LED2);\r\nlmc_mii_writereg (sc, 0, 17, T1FRAMER_ALARM1_STATUS);\r\nlink_status = lmc_mii_readreg (sc, 0, 18);\r\nif (link_status & T1F_RAIS) {\r\nret = 0;\r\nif(sc->last_led_err[1] != 1){\r\nprintk(KERN_WARNING "%s: Receive AIS/Blue Alarm. Far end in RED alarm\n", sc->name);\r\n}\r\nlmc_led_on(sc, LMC_DS3_LED1);\r\nsc->last_led_err[1] = 1;\r\n}\r\nelse {\r\nif(sc->last_led_err[1] != 0){\r\nprintk(KERN_WARNING "%s: End AIS/Blue Alarm\n", sc->name);\r\n}\r\nlmc_led_off (sc, LMC_DS3_LED1);\r\nsc->last_led_err[1] = 0;\r\n}\r\nif (link_status & T1F_RMYEL) {\r\nret = 0;\r\nif(sc->last_led_err[0] != 1){\r\nprintk(KERN_WARNING "%s: Receive Yellow AIS Alarm\n", sc->name);\r\n}\r\nlmc_led_on(sc, LMC_DS3_LED0);\r\nsc->last_led_err[0] = 1;\r\n}\r\nelse {\r\nif(sc->last_led_err[0] != 0){\r\nprintk(KERN_WARNING "%s: End of Yellow AIS Alarm\n", sc->name);\r\n}\r\nlmc_led_off(sc, LMC_DS3_LED0);\r\nsc->last_led_err[0] = 0;\r\n}\r\nif(link_status & T1F_RLOF){\r\nret = 0;\r\nif(sc->last_led_err[3] != 1){\r\nprintk(KERN_WARNING "%s: Local Red Alarm: Loss of Framing\n", sc->name);\r\n}\r\nlmc_led_on(sc, LMC_DS3_LED3);\r\nsc->last_led_err[3] = 1;\r\n}\r\nelse {\r\nif(sc->last_led_err[3] != 0){\r\nprintk(KERN_WARNING "%s: End Red Alarm (LOF)\n", sc->name);\r\n}\r\nif( ! (link_status & T1F_RLOS))\r\nlmc_led_off(sc, LMC_DS3_LED3);\r\nsc->last_led_err[3] = 0;\r\n}\r\nif(link_status & T1F_RLOS){\r\nret = 0;\r\nif(sc->last_led_err[2] != 1){\r\nprintk(KERN_WARNING "%s: Local Red Alarm: Loss of Signal\n", sc->name);\r\n}\r\nlmc_led_on(sc, LMC_DS3_LED3);\r\nsc->last_led_err[2] = 1;\r\n}\r\nelse {\r\nif(sc->last_led_err[2] != 0){\r\nprintk(KERN_WARNING "%s: End Red Alarm (LOS)\n", sc->name);\r\n}\r\nif( ! (link_status & T1F_RLOF))\r\nlmc_led_off(sc, LMC_DS3_LED3);\r\nsc->last_led_err[2] = 0;\r\n}\r\nsc->lmc_xinfo.t1_alarm1_status = link_status;\r\nlmc_mii_writereg (sc, 0, 17, T1FRAMER_ALARM2_STATUS);\r\nsc->lmc_xinfo.t1_alarm2_status = lmc_mii_readreg (sc, 0, 18);\r\nlmc_trace(sc->lmc_device, "lmc_t1_get_link_status out");\r\nreturn ret;\r\n}\r\nstatic void\r\nlmc_t1_set_circuit_type (lmc_softc_t * const sc, int ie)\r\n{\r\nif (ie == LMC_CTL_CIRCUIT_TYPE_T1) {\r\nsc->lmc_miireg16 |= LMC_MII16_T1_Z;\r\nsc->ictl.circuit_type = LMC_CTL_CIRCUIT_TYPE_T1;\r\nprintk(KERN_INFO "%s: In T1 Mode\n", sc->name);\r\n}\r\nelse {\r\nsc->lmc_miireg16 &= ~LMC_MII16_T1_Z;\r\nsc->ictl.circuit_type = LMC_CTL_CIRCUIT_TYPE_E1;\r\nprintk(KERN_INFO "%s: In E1 Mode\n", sc->name);\r\n}\r\nlmc_mii_writereg (sc, 0, 16, sc->lmc_miireg16);\r\n}\r\nstatic void\r\nlmc_t1_set_crc_length (lmc_softc_t * const sc, int state)\r\n{\r\nif (state == LMC_CTL_CRC_LENGTH_32)\r\n{\r\nsc->lmc_miireg16 |= LMC_MII16_T1_CRC;\r\nsc->ictl.crc_length = LMC_CTL_CRC_LENGTH_32;\r\nsc->lmc_crcSize = LMC_CTL_CRC_BYTESIZE_4;\r\n}\r\nelse\r\n{\r\nsc->lmc_miireg16 &= ~LMC_MII16_T1_CRC;\r\nsc->ictl.crc_length = LMC_CTL_CRC_LENGTH_16;\r\nsc->lmc_crcSize = LMC_CTL_CRC_BYTESIZE_2;\r\n}\r\nlmc_mii_writereg (sc, 0, 16, sc->lmc_miireg16);\r\n}\r\nstatic void\r\nlmc_t1_set_clock (lmc_softc_t * const sc, int ie)\r\n{\r\nint old;\r\nold = ie;\r\nif (ie == LMC_CTL_CLOCK_SOURCE_EXT)\r\n{\r\nsc->lmc_gpio &= ~(LMC_GEP_SSI_TXCLOCK);\r\nLMC_CSR_WRITE (sc, csr_gp, sc->lmc_gpio);\r\nsc->ictl.clock_source = LMC_CTL_CLOCK_SOURCE_EXT;\r\nif(old != ie)\r\nprintk (LMC_PRINTF_FMT ": clock external\n", LMC_PRINTF_ARGS);\r\n}\r\nelse\r\n{\r\nsc->lmc_gpio |= LMC_GEP_SSI_TXCLOCK;\r\nLMC_CSR_WRITE (sc, csr_gp, sc->lmc_gpio);\r\nsc->ictl.clock_source = LMC_CTL_CLOCK_SOURCE_INT;\r\nif(old != ie)\r\nprintk (LMC_PRINTF_FMT ": clock internal\n", LMC_PRINTF_ARGS);\r\n}\r\n}\r\nstatic void\r\nlmc_t1_watchdog (lmc_softc_t * const sc)\r\n{\r\n}\r\nstatic void\r\nlmc_set_protocol (lmc_softc_t * const sc, lmc_ctl_t * ctl)\r\n{\r\nif (!ctl)\r\nsc->ictl.keepalive_onoff = LMC_CTL_ON;\r\n}

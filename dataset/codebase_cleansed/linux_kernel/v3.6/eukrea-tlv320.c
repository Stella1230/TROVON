static int eukrea_tlv320_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nint ret;\r\nret = snd_soc_dai_set_fmt(cpu_dai, SND_SOC_DAIFMT_I2S |\r\nSND_SOC_DAIFMT_NB_NF |\r\nSND_SOC_DAIFMT_CBM_CFM);\r\nif (ret) {\r\npr_err("%s: failed set cpu dai format\n", __func__);\r\nreturn ret;\r\n}\r\nret = snd_soc_dai_set_fmt(codec_dai, SND_SOC_DAIFMT_I2S |\r\nSND_SOC_DAIFMT_NB_NF |\r\nSND_SOC_DAIFMT_CBM_CFM);\r\nif (ret) {\r\npr_err("%s: failed set codec dai format\n", __func__);\r\nreturn ret;\r\n}\r\nret = snd_soc_dai_set_sysclk(codec_dai, 0,\r\nCODEC_CLOCK, SND_SOC_CLOCK_OUT);\r\nif (ret) {\r\npr_err("%s: failed setting codec sysclk\n", __func__);\r\nreturn ret;\r\n}\r\nsnd_soc_dai_set_tdm_slot(cpu_dai, 0xffffffc, 0xffffffc, 2, 0);\r\nret = snd_soc_dai_set_sysclk(cpu_dai, IMX_SSP_SYS_CLK, 0,\r\nSND_SOC_CLOCK_IN);\r\nif (ret) {\r\npr_err("can't set CPU system clock IMX_SSP_SYS_CLK\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init eukrea_tlv320_init(void)\r\n{\r\nint ret;\r\nint int_port = 0, ext_port;\r\nif (machine_is_eukrea_cpuimx27()) {\r\nimx_audmux_v1_configure_port(MX27_AUDMUX_HPCR1_SSI0,\r\nIMX_AUDMUX_V1_PCR_SYN |\r\nIMX_AUDMUX_V1_PCR_TFSDIR |\r\nIMX_AUDMUX_V1_PCR_TCLKDIR |\r\nIMX_AUDMUX_V1_PCR_RFSDIR |\r\nIMX_AUDMUX_V1_PCR_RCLKDIR |\r\nIMX_AUDMUX_V1_PCR_TFCSEL(MX27_AUDMUX_HPCR3_SSI_PINS_4) |\r\nIMX_AUDMUX_V1_PCR_RFCSEL(MX27_AUDMUX_HPCR3_SSI_PINS_4) |\r\nIMX_AUDMUX_V1_PCR_RXDSEL(MX27_AUDMUX_HPCR3_SSI_PINS_4)\r\n);\r\nimx_audmux_v1_configure_port(MX27_AUDMUX_HPCR3_SSI_PINS_4,\r\nIMX_AUDMUX_V1_PCR_SYN |\r\nIMX_AUDMUX_V1_PCR_RXDSEL(MX27_AUDMUX_HPCR1_SSI0)\r\n);\r\n} else if (machine_is_eukrea_cpuimx25sd() ||\r\nmachine_is_eukrea_cpuimx35sd() ||\r\nmachine_is_eukrea_cpuimx51sd()) {\r\next_port = machine_is_eukrea_cpuimx25sd() ? 4 : 3;\r\nimx_audmux_v2_configure_port(int_port,\r\nIMX_AUDMUX_V2_PTCR_SYN |\r\nIMX_AUDMUX_V2_PTCR_TFSDIR |\r\nIMX_AUDMUX_V2_PTCR_TFSEL(ext_port) |\r\nIMX_AUDMUX_V2_PTCR_TCLKDIR |\r\nIMX_AUDMUX_V2_PTCR_TCSEL(ext_port),\r\nIMX_AUDMUX_V2_PDCR_RXDSEL(ext_port)\r\n);\r\nimx_audmux_v2_configure_port(ext_port,\r\nIMX_AUDMUX_V2_PTCR_SYN,\r\nIMX_AUDMUX_V2_PDCR_RXDSEL(int_port)\r\n);\r\n} else {\r\nreturn 0;\r\n}\r\neukrea_tlv320_snd_device = platform_device_alloc("soc-audio", -1);\r\nif (!eukrea_tlv320_snd_device)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(eukrea_tlv320_snd_device, &eukrea_tlv320);\r\nret = platform_device_add(eukrea_tlv320_snd_device);\r\nif (ret) {\r\nprintk(KERN_ERR "ASoC: Platform device allocation failed\n");\r\nplatform_device_put(eukrea_tlv320_snd_device);\r\n}\r\nreturn ret;\r\n}\r\nstatic void __exit eukrea_tlv320_exit(void)\r\n{\r\nplatform_device_unregister(eukrea_tlv320_snd_device);\r\n}

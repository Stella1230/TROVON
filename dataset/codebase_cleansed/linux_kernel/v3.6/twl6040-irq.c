static inline\r\nstruct twl6040_irq_data *irq_to_twl6040_irq(struct twl6040 *twl6040,\r\nint irq)\r\n{\r\nreturn &twl6040_irqs[irq - twl6040->irq_base];\r\n}\r\nstatic void twl6040_irq_lock(struct irq_data *data)\r\n{\r\nstruct twl6040 *twl6040 = irq_data_get_irq_chip_data(data);\r\nmutex_lock(&twl6040->irq_mutex);\r\n}\r\nstatic void twl6040_irq_sync_unlock(struct irq_data *data)\r\n{\r\nstruct twl6040 *twl6040 = irq_data_get_irq_chip_data(data);\r\nif (twl6040->irq_masks_cur != twl6040->irq_masks_cache) {\r\ntwl6040->irq_masks_cache = twl6040->irq_masks_cur;\r\ntwl6040_reg_write(twl6040, TWL6040_REG_INTMR,\r\ntwl6040->irq_masks_cur);\r\n}\r\nmutex_unlock(&twl6040->irq_mutex);\r\n}\r\nstatic void twl6040_irq_enable(struct irq_data *data)\r\n{\r\nstruct twl6040 *twl6040 = irq_data_get_irq_chip_data(data);\r\nstruct twl6040_irq_data *irq_data = irq_to_twl6040_irq(twl6040,\r\ndata->irq);\r\ntwl6040->irq_masks_cur &= ~irq_data->mask;\r\n}\r\nstatic void twl6040_irq_disable(struct irq_data *data)\r\n{\r\nstruct twl6040 *twl6040 = irq_data_get_irq_chip_data(data);\r\nstruct twl6040_irq_data *irq_data = irq_to_twl6040_irq(twl6040,\r\ndata->irq);\r\ntwl6040->irq_masks_cur |= irq_data->mask;\r\n}\r\nstatic irqreturn_t twl6040_irq_thread(int irq, void *data)\r\n{\r\nstruct twl6040 *twl6040 = data;\r\nu8 intid;\r\nint i;\r\nintid = twl6040_reg_read(twl6040, TWL6040_REG_INTID);\r\nfor (i = ARRAY_SIZE(twl6040_irqs) - 1; i >= 0; i--) {\r\nif (twl6040->irq_masks_cur & twl6040_irqs[i].mask)\r\nintid &= ~twl6040_irqs[i].status;\r\nif (intid & twl6040_irqs[i].status)\r\nhandle_nested_irq(twl6040->irq_base + i);\r\n}\r\ntwl6040_reg_write(twl6040, TWL6040_REG_INTID, intid);\r\nreturn IRQ_HANDLED;\r\n}\r\nint twl6040_irq_init(struct twl6040 *twl6040)\r\n{\r\nstruct device_node *node = twl6040->dev->of_node;\r\nint i, nr_irqs, irq_base, ret;\r\nu8 val;\r\nmutex_init(&twl6040->irq_mutex);\r\ntwl6040->irq_masks_cur = TWL6040_ALLINT_MSK;\r\ntwl6040->irq_masks_cache = TWL6040_ALLINT_MSK;\r\ntwl6040_reg_write(twl6040, TWL6040_REG_INTMR, TWL6040_ALLINT_MSK);\r\nnr_irqs = ARRAY_SIZE(twl6040_irqs);\r\nirq_base = irq_alloc_descs(-1, 0, nr_irqs, 0);\r\nif (IS_ERR_VALUE(irq_base)) {\r\ndev_err(twl6040->dev, "Fail to allocate IRQ descs\n");\r\nreturn irq_base;\r\n}\r\ntwl6040->irq_base = irq_base;\r\nirq_domain_add_legacy(node, ARRAY_SIZE(twl6040_irqs), irq_base, 0,\r\n&irq_domain_simple_ops, NULL);\r\nfor (i = irq_base; i < irq_base + nr_irqs; i++) {\r\nirq_set_chip_data(i, twl6040);\r\nirq_set_chip_and_handler(i, &twl6040_irq_chip,\r\nhandle_level_irq);\r\nirq_set_nested_thread(i, 1);\r\n#ifdef CONFIG_ARM\r\nset_irq_flags(i, IRQF_VALID);\r\n#else\r\nirq_set_noprobe(i);\r\n#endif\r\n}\r\nret = request_threaded_irq(twl6040->irq, NULL, twl6040_irq_thread,\r\nIRQF_ONESHOT, "twl6040", twl6040);\r\nif (ret) {\r\ndev_err(twl6040->dev, "failed to request IRQ %d: %d\n",\r\ntwl6040->irq, ret);\r\nreturn ret;\r\n}\r\nval = twl6040_reg_read(twl6040, TWL6040_REG_INTID);\r\ntwl6040_clear_bits(twl6040, TWL6040_REG_ACCCTL, TWL6040_INTCLRMODE);\r\nreturn 0;\r\n}\r\nvoid twl6040_irq_exit(struct twl6040 *twl6040)\r\n{\r\nfree_irq(twl6040->irq, twl6040);\r\n}

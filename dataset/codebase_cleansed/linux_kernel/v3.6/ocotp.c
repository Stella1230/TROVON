const u32 *mxs_get_ocotp(void)\r\n{\r\nvoid __iomem *ocotp_base = MXS_IO_ADDRESS(MXS_OCOTP_BASE_ADDR);\r\nint timeout = 0x400;\r\nsize_t i;\r\nstatic int once = 0;\r\nif (once)\r\nreturn ocotp_words;\r\nmutex_lock(&ocotp_mutex);\r\n__mxs_clrl(BM_OCOTP_CTRL_ERROR, ocotp_base);\r\nwhile ((__raw_readl(ocotp_base) &\r\n(BM_OCOTP_CTRL_BUSY | BM_OCOTP_CTRL_ERROR)) && --timeout)\r\ncpu_relax();\r\nif (unlikely(!timeout))\r\ngoto error_unlock;\r\n__mxs_setl(BM_OCOTP_CTRL_RD_BANK_OPEN, ocotp_base);\r\nudelay(1);\r\ntimeout = 0x400;\r\nwhile ((__raw_readl(ocotp_base) & BM_OCOTP_CTRL_BUSY) && --timeout)\r\ncpu_relax();\r\nif (unlikely(!timeout))\r\ngoto error_unlock;\r\nfor (i = 0; i < OCOTP_WORD_COUNT; i++)\r\nocotp_words[i] = __raw_readl(ocotp_base + OCOTP_WORD_OFFSET +\r\ni * 0x10);\r\n__mxs_clrl(BM_OCOTP_CTRL_RD_BANK_OPEN, ocotp_base);\r\nonce = 1;\r\nmutex_unlock(&ocotp_mutex);\r\nreturn ocotp_words;\r\nerror_unlock:\r\nmutex_unlock(&ocotp_mutex);\r\npr_err("%s: timeout in reading OCOTP\n", __func__);\r\nreturn NULL;\r\n}

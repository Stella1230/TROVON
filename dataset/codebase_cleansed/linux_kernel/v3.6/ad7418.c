static void ad7418_init_client(struct i2c_client *client)\r\n{\r\nstruct ad7418_data *data = i2c_get_clientdata(client);\r\nint reg = i2c_smbus_read_byte_data(client, AD7418_REG_CONF);\r\nif (reg < 0) {\r\ndev_err(&client->dev, "cannot read configuration register\n");\r\n} else {\r\ndev_info(&client->dev, "configuring for mode 1\n");\r\ni2c_smbus_write_byte_data(client, AD7418_REG_CONF, reg & 0xfe);\r\nif (data->type == ad7417 || data->type == ad7418)\r\ni2c_smbus_write_byte_data(client,\r\nAD7418_REG_CONF2, 0x00);\r\n}\r\n}\r\nstatic struct ad7418_data *ad7418_update_device(struct device *dev)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct ad7418_data *data = i2c_get_clientdata(client);\r\nmutex_lock(&data->lock);\r\nif (time_after(jiffies, data->last_updated + HZ + HZ / 2)\r\n|| !data->valid) {\r\nu8 cfg;\r\nint i, ch;\r\ncfg = i2c_smbus_read_byte_data(client, AD7418_REG_CONF);\r\ncfg &= 0x1F;\r\ni2c_smbus_write_byte_data(client, AD7418_REG_CONF,\r\ncfg | AD7418_CH_TEMP);\r\nudelay(30);\r\nfor (i = 0; i < 3; i++) {\r\ndata->temp[i] =\r\ni2c_smbus_read_word_swapped(client,\r\nAD7418_REG_TEMP[i]);\r\n}\r\nfor (i = 0, ch = 4; i < data->adc_max; i++, ch--) {\r\ni2c_smbus_write_byte_data(client,\r\nAD7418_REG_CONF,\r\ncfg | AD7418_REG_ADC_CH(ch));\r\nudelay(15);\r\ndata->in[data->adc_max - 1 - i] =\r\ni2c_smbus_read_word_swapped(client,\r\nAD7418_REG_ADC);\r\n}\r\ni2c_smbus_write_word_swapped(client, AD7418_REG_CONF, cfg);\r\ndata->last_updated = jiffies;\r\ndata->valid = 1;\r\n}\r\nmutex_unlock(&data->lock);\r\nreturn data;\r\n}\r\nstatic ssize_t show_temp(struct device *dev, struct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct ad7418_data *data = ad7418_update_device(dev);\r\nreturn sprintf(buf, "%d\n",\r\nLM75_TEMP_FROM_REG(data->temp[attr->index]));\r\n}\r\nstatic ssize_t show_adc(struct device *dev, struct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct ad7418_data *data = ad7418_update_device(dev);\r\nreturn sprintf(buf, "%d\n",\r\n((data->in[attr->index] >> 6) * 2500 + 512) / 1024);\r\n}\r\nstatic ssize_t set_temp(struct device *dev, struct device_attribute *devattr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct ad7418_data *data = i2c_get_clientdata(client);\r\nlong temp;\r\nint ret = kstrtol(buf, 10, &temp);\r\nif (ret < 0)\r\nreturn ret;\r\nmutex_lock(&data->lock);\r\ndata->temp[attr->index] = LM75_TEMP_TO_REG(temp);\r\ni2c_smbus_write_word_swapped(client,\r\nAD7418_REG_TEMP[attr->index],\r\ndata->temp[attr->index]);\r\nmutex_unlock(&data->lock);\r\nreturn count;\r\n}\r\nstatic int ad7418_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct i2c_adapter *adapter = client->adapter;\r\nstruct ad7418_data *data;\r\nint err;\r\nif (!i2c_check_functionality(adapter, I2C_FUNC_SMBUS_BYTE_DATA |\r\nI2C_FUNC_SMBUS_WORD_DATA)) {\r\nerr = -EOPNOTSUPP;\r\ngoto exit;\r\n}\r\ndata = kzalloc(sizeof(struct ad7418_data), GFP_KERNEL);\r\nif (!data) {\r\nerr = -ENOMEM;\r\ngoto exit;\r\n}\r\ni2c_set_clientdata(client, data);\r\nmutex_init(&data->lock);\r\ndata->type = id->driver_data;\r\nswitch (data->type) {\r\ncase ad7416:\r\ndata->adc_max = 0;\r\ndata->attrs.attrs = ad7416_attributes;\r\nbreak;\r\ncase ad7417:\r\ndata->adc_max = 4;\r\ndata->attrs.attrs = ad7417_attributes;\r\nbreak;\r\ncase ad7418:\r\ndata->adc_max = 1;\r\ndata->attrs.attrs = ad7418_attributes;\r\nbreak;\r\n}\r\ndev_info(&client->dev, "%s chip found\n", client->name);\r\nad7418_init_client(client);\r\nerr = sysfs_create_group(&client->dev.kobj, &data->attrs);\r\nif (err)\r\ngoto exit_free;\r\ndata->hwmon_dev = hwmon_device_register(&client->dev);\r\nif (IS_ERR(data->hwmon_dev)) {\r\nerr = PTR_ERR(data->hwmon_dev);\r\ngoto exit_remove;\r\n}\r\nreturn 0;\r\nexit_remove:\r\nsysfs_remove_group(&client->dev.kobj, &data->attrs);\r\nexit_free:\r\nkfree(data);\r\nexit:\r\nreturn err;\r\n}\r\nstatic int ad7418_remove(struct i2c_client *client)\r\n{\r\nstruct ad7418_data *data = i2c_get_clientdata(client);\r\nhwmon_device_unregister(data->hwmon_dev);\r\nsysfs_remove_group(&client->dev.kobj, &data->attrs);\r\nkfree(data);\r\nreturn 0;\r\n}

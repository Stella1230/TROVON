acpi_status\r\nacpi_ds_load2_begin_op(struct acpi_walk_state *walk_state,\r\nunion acpi_parse_object **out_op)\r\n{\r\nunion acpi_parse_object *op;\r\nstruct acpi_namespace_node *node;\r\nacpi_status status;\r\nacpi_object_type object_type;\r\nchar *buffer_ptr;\r\nu32 flags;\r\nACPI_FUNCTION_TRACE(ds_load2_begin_op);\r\nop = walk_state->op;\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH, "Op=%p State=%p\n", op,\r\nwalk_state));\r\nif (op) {\r\nif ((walk_state->control_state) &&\r\n(walk_state->control_state->common.state ==\r\nACPI_CONTROL_CONDITIONAL_EXECUTING)) {\r\nstatus = acpi_ds_exec_begin_op(walk_state, out_op);\r\nreturn_ACPI_STATUS(status);\r\n}\r\nif ((!(walk_state->op_info->flags & AML_NSOPCODE) &&\r\n(walk_state->opcode != AML_INT_NAMEPATH_OP)) ||\r\n(!(walk_state->op_info->flags & AML_NAMED))) {\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nif (walk_state->opcode == AML_INT_NAMEPATH_OP) {\r\nbuffer_ptr = op->common.value.string;\r\nif (!buffer_ptr) {\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\n} else {\r\nbuffer_ptr = ACPI_CAST_PTR(char, &op->named.name);\r\n}\r\n} else {\r\nbuffer_ptr =\r\nacpi_ps_get_next_namestring(&walk_state->parser_state);\r\n}\r\nobject_type = walk_state->op_info->object_type;\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"State=%p Op=%p Type=%X\n", walk_state, op,\r\nobject_type));\r\nswitch (walk_state->opcode) {\r\ncase AML_FIELD_OP:\r\ncase AML_BANK_FIELD_OP:\r\ncase AML_INDEX_FIELD_OP:\r\nnode = NULL;\r\nstatus = AE_OK;\r\nbreak;\r\ncase AML_INT_NAMEPATH_OP:\r\nstatus =\r\nacpi_ns_lookup(walk_state->scope_info, buffer_ptr,\r\nobject_type, ACPI_IMODE_EXECUTE,\r\nACPI_NS_SEARCH_PARENT, walk_state, &(node));\r\nbreak;\r\ncase AML_SCOPE_OP:\r\nif (op && (op->named.node == acpi_gbl_root_node)) {\r\nnode = op->named.node;\r\nstatus =\r\nacpi_ds_scope_stack_push(node, object_type,\r\nwalk_state);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\n} else {\r\nstatus =\r\nacpi_ns_lookup(walk_state->scope_info, buffer_ptr,\r\nobject_type, ACPI_IMODE_EXECUTE,\r\nACPI_NS_SEARCH_PARENT, walk_state,\r\n&(node));\r\nif (ACPI_FAILURE(status)) {\r\n#ifdef ACPI_ASL_COMPILER\r\nif (status == AE_NOT_FOUND) {\r\nstatus = AE_OK;\r\n} else {\r\nACPI_ERROR_NAMESPACE(buffer_ptr,\r\nstatus);\r\n}\r\n#else\r\nACPI_ERROR_NAMESPACE(buffer_ptr, status);\r\n#endif\r\nreturn_ACPI_STATUS(status);\r\n}\r\n}\r\nswitch (node->type) {\r\ncase ACPI_TYPE_ANY:\r\ncase ACPI_TYPE_LOCAL_SCOPE:\r\ncase ACPI_TYPE_DEVICE:\r\ncase ACPI_TYPE_POWER:\r\ncase ACPI_TYPE_PROCESSOR:\r\ncase ACPI_TYPE_THERMAL:\r\nbreak;\r\ncase ACPI_TYPE_INTEGER:\r\ncase ACPI_TYPE_STRING:\r\ncase ACPI_TYPE_BUFFER:\r\nACPI_WARNING((AE_INFO,\r\n"Type override - [%4.4s] had invalid type (%s) "\r\n"for Scope operator, changed to type ANY\n",\r\nacpi_ut_get_node_name(node),\r\nacpi_ut_get_type_name(node->type)));\r\nnode->type = ACPI_TYPE_ANY;\r\nwalk_state->scope_info->common.value = ACPI_TYPE_ANY;\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"Invalid type (%s) for target of "\r\n"Scope operator [%4.4s] (Cannot override)",\r\nacpi_ut_get_type_name(node->type),\r\nacpi_ut_get_node_name(node)));\r\nreturn (AE_AML_OPERAND_TYPE);\r\n}\r\nbreak;\r\ndefault:\r\nif (op && op->common.node) {\r\nnode = op->common.node;\r\nif (acpi_ns_opens_scope(object_type)) {\r\nstatus =\r\nacpi_ds_scope_stack_push(node, object_type,\r\nwalk_state);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\n}\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nif (walk_state->deferred_node) {\r\nnode = walk_state->deferred_node;\r\nstatus = AE_OK;\r\nbreak;\r\n}\r\nflags = ACPI_NS_NO_UPSEARCH;\r\nif (walk_state->pass_number == ACPI_IMODE_EXECUTE) {\r\nflags |= ACPI_NS_ERROR_IF_FOUND;\r\nif (!\r\n(walk_state->\r\nparse_flags & ACPI_PARSE_MODULE_LEVEL)) {\r\nflags |= ACPI_NS_TEMPORARY;\r\n}\r\n}\r\nstatus =\r\nacpi_ns_lookup(walk_state->scope_info, buffer_ptr,\r\nobject_type, ACPI_IMODE_LOAD_PASS2, flags,\r\nwalk_state, &node);\r\nif (ACPI_SUCCESS(status) && (flags & ACPI_NS_TEMPORARY)) {\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"***New Node [%4.4s] %p is temporary\n",\r\nacpi_ut_get_node_name(node), node));\r\n}\r\nbreak;\r\n}\r\nif (ACPI_FAILURE(status)) {\r\nACPI_ERROR_NAMESPACE(buffer_ptr, status);\r\nreturn_ACPI_STATUS(status);\r\n}\r\nif (!op) {\r\nop = acpi_ps_alloc_op(walk_state->opcode);\r\nif (!op) {\r\nreturn_ACPI_STATUS(AE_NO_MEMORY);\r\n}\r\nif (node) {\r\nop->named.name = node->name.integer;\r\n}\r\n*out_op = op;\r\n}\r\nop->common.node = node;\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status acpi_ds_load2_end_op(struct acpi_walk_state *walk_state)\r\n{\r\nunion acpi_parse_object *op;\r\nacpi_status status = AE_OK;\r\nacpi_object_type object_type;\r\nstruct acpi_namespace_node *node;\r\nunion acpi_parse_object *arg;\r\nstruct acpi_namespace_node *new_node;\r\n#ifndef ACPI_NO_METHOD_EXECUTION\r\nu32 i;\r\nu8 region_space;\r\n#endif\r\nACPI_FUNCTION_TRACE(ds_load2_end_op);\r\nop = walk_state->op;\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH, "Opcode [%s] Op %p State %p\n",\r\nwalk_state->op_info->name, op, walk_state));\r\nif (!(walk_state->op_info->flags & AML_NSOBJECT)) {\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nif (op->common.aml_opcode == AML_SCOPE_OP) {\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"Ending scope Op=%p State=%p\n", op,\r\nwalk_state));\r\n}\r\nobject_type = walk_state->op_info->object_type;\r\nnode = op->common.node;\r\nwalk_state->operands[0] = (void *)node;\r\nwalk_state->num_operands = 1;\r\nif (acpi_ns_opens_scope(object_type) &&\r\n(op->common.aml_opcode != AML_INT_METHODCALL_OP)) {\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"(%s) Popping scope for Op %p\n",\r\nacpi_ut_get_type_name(object_type), op));\r\nstatus = acpi_ds_scope_stack_pop(walk_state);\r\nif (ACPI_FAILURE(status)) {\r\ngoto cleanup;\r\n}\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"Create-Load [%s] State=%p Op=%p NamedObj=%p\n",\r\nacpi_ps_get_opcode_name(op->common.aml_opcode),\r\nwalk_state, op, node));\r\narg = op->common.value.arg;\r\nswitch (walk_state->op_info->type) {\r\n#ifndef ACPI_NO_METHOD_EXECUTION\r\ncase AML_TYPE_CREATE_FIELD:\r\nstatus = acpi_ds_create_buffer_field(op, walk_state);\r\nbreak;\r\ncase AML_TYPE_NAMED_FIELD:\r\nif (walk_state->method_node) {\r\nstatus = acpi_ds_init_field_objects(op, walk_state);\r\n}\r\nswitch (op->common.aml_opcode) {\r\ncase AML_INDEX_FIELD_OP:\r\nstatus =\r\nacpi_ds_create_index_field(op,\r\n(acpi_handle) arg->\r\ncommon.node, walk_state);\r\nbreak;\r\ncase AML_BANK_FIELD_OP:\r\nstatus =\r\nacpi_ds_create_bank_field(op, arg->common.node,\r\nwalk_state);\r\nbreak;\r\ncase AML_FIELD_OP:\r\nstatus =\r\nacpi_ds_create_field(op, arg->common.node,\r\nwalk_state);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ncase AML_TYPE_NAMED_SIMPLE:\r\nstatus = acpi_ds_create_operands(walk_state, arg);\r\nif (ACPI_FAILURE(status)) {\r\ngoto cleanup;\r\n}\r\nswitch (op->common.aml_opcode) {\r\ncase AML_PROCESSOR_OP:\r\nstatus = acpi_ex_create_processor(walk_state);\r\nbreak;\r\ncase AML_POWER_RES_OP:\r\nstatus = acpi_ex_create_power_resource(walk_state);\r\nbreak;\r\ncase AML_MUTEX_OP:\r\nstatus = acpi_ex_create_mutex(walk_state);\r\nbreak;\r\ncase AML_EVENT_OP:\r\nstatus = acpi_ex_create_event(walk_state);\r\nbreak;\r\ncase AML_ALIAS_OP:\r\nstatus = acpi_ex_create_alias(walk_state);\r\nbreak;\r\ndefault:\r\nstatus = AE_OK;\r\ngoto cleanup;\r\n}\r\nfor (i = 1; i < walk_state->num_operands; i++) {\r\nacpi_ut_remove_reference(walk_state->operands[i]);\r\nwalk_state->operands[i] = NULL;\r\n}\r\nbreak;\r\n#endif\r\ncase AML_TYPE_NAMED_COMPLEX:\r\nswitch (op->common.aml_opcode) {\r\n#ifndef ACPI_NO_METHOD_EXECUTION\r\ncase AML_REGION_OP:\r\ncase AML_DATA_REGION_OP:\r\nif (op->common.aml_opcode == AML_REGION_OP) {\r\nregion_space = (acpi_adr_space_type)\r\n((op->common.value.arg)->common.value.\r\ninteger);\r\n} else {\r\nregion_space = ACPI_ADR_SPACE_DATA_TABLE;\r\n}\r\nif (walk_state->method_node) {\r\nstatus =\r\nacpi_ex_create_region(op->named.data,\r\nop->named.length,\r\nregion_space,\r\nwalk_state);\r\nif (ACPI_FAILURE(status)) {\r\nreturn (status);\r\n}\r\nacpi_ex_exit_interpreter();\r\n}\r\nstatus =\r\nacpi_ev_initialize_region\r\n(acpi_ns_get_attached_object(node), FALSE);\r\nif (walk_state->method_node) {\r\nacpi_ex_enter_interpreter();\r\n}\r\nif (ACPI_FAILURE(status)) {\r\nif (AE_NOT_EXIST == status) {\r\nstatus = AE_OK;\r\n}\r\n}\r\nbreak;\r\ncase AML_NAME_OP:\r\nstatus = acpi_ds_create_node(walk_state, node, op);\r\nbreak;\r\ncase AML_METHOD_OP:\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"LOADING-Method: State=%p Op=%p NamedObj=%p\n",\r\nwalk_state, op, op->named.node));\r\nif (!acpi_ns_get_attached_object(op->named.node)) {\r\nwalk_state->operands[0] =\r\nACPI_CAST_PTR(void, op->named.node);\r\nwalk_state->num_operands = 1;\r\nstatus =\r\nacpi_ds_create_operands(walk_state,\r\nop->common.value.\r\narg);\r\nif (ACPI_SUCCESS(status)) {\r\nstatus =\r\nacpi_ex_create_method(op->named.\r\ndata,\r\nop->named.\r\nlength,\r\nwalk_state);\r\n}\r\nwalk_state->operands[0] = NULL;\r\nwalk_state->num_operands = 0;\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\n}\r\nbreak;\r\n#endif\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ncase AML_CLASS_INTERNAL:\r\nbreak;\r\ncase AML_CLASS_METHOD_CALL:\r\nACPI_DEBUG_PRINT((ACPI_DB_DISPATCH,\r\n"RESOLVING-MethodCall: State=%p Op=%p NamedObj=%p\n",\r\nwalk_state, op, node));\r\nstatus =\r\nacpi_ns_lookup(walk_state->scope_info,\r\narg->common.value.string, ACPI_TYPE_ANY,\r\nACPI_IMODE_LOAD_PASS2,\r\nACPI_NS_SEARCH_PARENT |\r\nACPI_NS_DONT_OPEN_SCOPE, walk_state,\r\n&(new_node));\r\nif (ACPI_SUCCESS(status)) {\r\nif (new_node->type != ACPI_TYPE_METHOD) {\r\nstatus = AE_AML_OPERAND_TYPE;\r\n}\r\nop->common.node = new_node;\r\n} else {\r\nACPI_ERROR_NAMESPACE(arg->common.value.string, status);\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\ncleanup:\r\nwalk_state->operands[0] = NULL;\r\nwalk_state->num_operands = 0;\r\nreturn_ACPI_STATUS(status);\r\n}

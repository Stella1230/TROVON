static void delay(int delay)\r\n{\r\nwhile (delay--);\r\n}\r\nstatic void send_bit(unsigned char bit)\r\n{\r\nscl_lo;\r\ndelay(TXX);\r\nif (bit)\r\nsda_hi;\r\nelse\r\nsda_lo;\r\ndelay(TXX);\r\nscl_hi;\r\ndelay(TXX);\r\n}\r\nstatic void send_ack(void)\r\n{\r\nsend_bit(0);\r\n}\r\nstatic void send_byte(unsigned char byte)\r\n{\r\nint i = 0;\r\nfor (i = 7; i >= 0; i--)\r\nsend_bit((byte >> i) & 0x01);\r\n}\r\nstatic void send_start(void)\r\n{\r\nsda_hi;\r\ndelay(TXX);\r\nscl_hi;\r\ndelay(TXX);\r\nsda_lo;\r\ndelay(TXX);\r\n}\r\nstatic void send_stop(void)\r\n{\r\nsda_lo;\r\ndelay(TXX);\r\nscl_hi;\r\ndelay(TXX);\r\nsda_hi;\r\ndelay(TXX);\r\n}\r\nstatic void do_idle(void)\r\n{\r\nsda_hi;\r\nscl_hi;\r\nvcc_off;\r\n}\r\nstatic int recv_bit(void)\r\n{\r\nint status;\r\nscl_lo;\r\ndelay(TXX);\r\nsda_hi;\r\ndelay(TXX);\r\nscl_hi;\r\ndelay(TXX);\r\nreturn 1;\r\n}\r\nstatic unsigned char recv_byte(void) {\r\nint i;\r\nunsigned char byte=0;\r\nfor (i=7;i>=0;i--)\r\nbyte |= (recv_bit() << i);\r\nreturn byte;\r\n}\r\nstatic int recv_ack(void)\r\n{\r\nunsigned int ack;\r\nack = (unsigned int)recv_bit();\r\nscl_lo;\r\nif (ack) {\r\ndo_idle();\r\nprintk(KERN_ERR "Error reading the Atmel 24C32/24C64 EEPROM\n");\r\nreturn -1;\r\n}\r\nreturn ack;\r\n}\r\nint read_eeprom(char *buffer, int eeprom_size, int size)\r\n{\r\nint i = 0, err;\r\nsend_start();\r\nsend_byte(W_HEADER);\r\nrecv_ack();\r\nif (eeprom_size > 2048) {\r\nsend_byte(0x00);\r\nrecv_ack();\r\n}\r\nsend_start();\r\nsend_byte(R_HEADER);\r\nerr = recv_ack();\r\nif (err == -1)\r\nreturn err;\r\nfor (i = 0; i < size; i++) {\r\n*buffer++ = recv_byte();\r\nsend_ack();\r\n}\r\nsend_stop();\r\n}

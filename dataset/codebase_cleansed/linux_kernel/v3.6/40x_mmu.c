void __init MMU_init_hw(void)\r\n{\r\nmtspr(SPRN_ZPR, 0x10000000);\r\nflush_instruction_cache();\r\nmtspr(SPRN_DCWR, 0x00000000);\r\nmtspr(SPRN_DCCR, 0xFFFF0000);\r\nmtspr(SPRN_ICCR, 0xFFFF0000);\r\n}\r\nunsigned long __init mmu_mapin_ram(unsigned long top)\r\n{\r\nunsigned long v, s, mapped;\r\nphys_addr_t p;\r\nv = KERNELBASE;\r\np = 0;\r\ns = total_lowmem;\r\nif (__map_without_ltlbs)\r\nreturn 0;\r\nwhile (s >= LARGE_PAGE_SIZE_16M) {\r\npmd_t *pmdp;\r\nunsigned long val = p | _PMD_SIZE_16M | _PAGE_EXEC | _PAGE_HWWRITE;\r\npmdp = pmd_offset(pud_offset(pgd_offset_k(v), v), v);\r\npmd_val(*pmdp++) = val;\r\npmd_val(*pmdp++) = val;\r\npmd_val(*pmdp++) = val;\r\npmd_val(*pmdp++) = val;\r\nv += LARGE_PAGE_SIZE_16M;\r\np += LARGE_PAGE_SIZE_16M;\r\ns -= LARGE_PAGE_SIZE_16M;\r\n}\r\nwhile (s >= LARGE_PAGE_SIZE_4M) {\r\npmd_t *pmdp;\r\nunsigned long val = p | _PMD_SIZE_4M | _PAGE_EXEC | _PAGE_HWWRITE;\r\npmdp = pmd_offset(pud_offset(pgd_offset_k(v), v), v);\r\npmd_val(*pmdp) = val;\r\nv += LARGE_PAGE_SIZE_4M;\r\np += LARGE_PAGE_SIZE_4M;\r\ns -= LARGE_PAGE_SIZE_4M;\r\n}\r\nmapped = total_lowmem - s;\r\nmemblock_set_current_limit(mapped);\r\nreturn mapped;\r\n}\r\nvoid setup_initial_memory_limit(phys_addr_t first_memblock_base,\r\nphys_addr_t first_memblock_size)\r\n{\r\nBUG_ON(first_memblock_base != 0);\r\nmemblock_set_current_limit(min_t(u64, first_memblock_size, 0x00800000));\r\n}

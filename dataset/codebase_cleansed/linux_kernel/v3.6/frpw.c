static int frpw_read_regr( PIA *pi, int cont, int regr )\r\n{ int h,l,r;\r\nr = regr + cont_map[cont];\r\nw2(4);\r\nw0(r); cec4;\r\nw2(6); l = r1();\r\nw2(4); h = r1();\r\nw2(4);\r\nreturn j44(l,h);\r\n}\r\nstatic void frpw_write_regr( PIA *pi, int cont, int regr, int val)\r\n{ int r;\r\nr = regr + cont_map[cont];\r\nw2(4); w0(r); cec4;\r\nw0(val);\r\nw2(5);w2(7);w2(5);w2(4);\r\n}\r\nstatic void frpw_read_block_int( PIA *pi, char * buf, int count, int regr )\r\n{ int h, l, k, ph;\r\nswitch(pi->mode) {\r\ncase 0: w2(4); w0(regr); cec4;\r\nfor (k=0;k<count;k++) {\r\nw2(6); l = r1();\r\nw2(4); h = r1();\r\nbuf[k] = j44(l,h);\r\n}\r\nw2(4);\r\nbreak;\r\ncase 1: ph = 2;\r\nw2(4); w0(regr + 0xc0); cec4;\r\nw0(0xff);\r\nfor (k=0;k<count;k++) {\r\nw2(0xa4 + ph);\r\nbuf[k] = r0();\r\nph = 2 - ph;\r\n}\r\nw2(0xac); w2(0xa4); w2(4);\r\nbreak;\r\ncase 2: w2(4); w0(regr + 0x80); cec4;\r\nfor (k=0;k<count;k++) buf[k] = r4();\r\nw2(0xac); w2(0xa4);\r\nw2(4);\r\nbreak;\r\ncase 3: w2(4); w0(regr + 0x80); cec4;\r\nfor (k=0;k<count-2;k++) buf[k] = r4();\r\nw2(0xac); w2(0xa4);\r\nbuf[count-2] = r4();\r\nbuf[count-1] = r4();\r\nw2(4);\r\nbreak;\r\ncase 4: w2(4); w0(regr + 0x80); cec4;\r\nfor (k=0;k<(count/2)-1;k++) ((u16 *)buf)[k] = r4w();\r\nw2(0xac); w2(0xa4);\r\nbuf[count-2] = r4();\r\nbuf[count-1] = r4();\r\nw2(4);\r\nbreak;\r\ncase 5: w2(4); w0(regr + 0x80); cec4;\r\nfor (k=0;k<(count/4)-1;k++) ((u32 *)buf)[k] = r4l();\r\nbuf[count-4] = r4();\r\nbuf[count-3] = r4();\r\nw2(0xac); w2(0xa4);\r\nbuf[count-2] = r4();\r\nbuf[count-1] = r4();\r\nw2(4);\r\nbreak;\r\n}\r\n}\r\nstatic void frpw_read_block( PIA *pi, char * buf, int count)\r\n{ frpw_read_block_int(pi,buf,count,0x08);\r\n}\r\nstatic void frpw_write_block( PIA *pi, char * buf, int count )\r\n{ int k;\r\nswitch(pi->mode) {\r\ncase 0:\r\ncase 1:\r\ncase 2: w2(4); w0(8); cec4; w2(5);\r\nfor (k=0;k<count;k++) {\r\nw0(buf[k]);\r\nw2(7);w2(5);\r\n}\r\nw2(4);\r\nbreak;\r\ncase 3: w2(4); w0(0xc8); cec4; w2(5);\r\nfor (k=0;k<count;k++) w4(buf[k]);\r\nw2(4);\r\nbreak;\r\ncase 4: w2(4); w0(0xc8); cec4; w2(5);\r\nfor (k=0;k<count/2;k++) w4w(((u16 *)buf)[k]);\r\nw2(4);\r\nbreak;\r\ncase 5: w2(4); w0(0xc8); cec4; w2(5);\r\nfor (k=0;k<count/4;k++) w4l(((u32 *)buf)[k]);\r\nw2(4);\r\nbreak;\r\n}\r\n}\r\nstatic void frpw_connect ( PIA *pi )\r\n{ pi->saved_r0 = r0();\r\npi->saved_r2 = r2();\r\nw2(4);\r\n}\r\nstatic void frpw_disconnect ( PIA *pi )\r\n{ w2(4); w0(0x20); cec4;\r\nw0(pi->saved_r0);\r\nw2(pi->saved_r2);\r\n}\r\nstatic int frpw_test_pnp ( PIA *pi )\r\n{ int olddelay, a, b;\r\n#ifdef FRPW_HARD_RESET\r\nw0(0); w2(8); udelay(50); w2(0xc);\r\nmdelay(1500);\r\n#endif\r\nolddelay = pi->delay;\r\npi->delay = 10;\r\npi->saved_r0 = r0();\r\npi->saved_r2 = r2();\r\nw2(4); w0(4); w2(6); w2(7);\r\na = r1() & 0xff; w2(4); b = r1() & 0xff;\r\nw2(0xc); w2(0xe); w2(4);\r\npi->delay = olddelay;\r\nw0(pi->saved_r0);\r\nw2(pi->saved_r2);\r\nreturn ((~a&0x40) && (b&0x40));\r\n}\r\nstatic int frpw_test_proto( PIA *pi, char * scratch, int verbose )\r\n{ int j, k, r;\r\nint e[2] = {0,0};\r\nif ((pi->private>>1) != pi->port)\r\npi->private = frpw_test_pnp(pi) + 2*pi->port;\r\nif (((pi->private%2) == 0) && (pi->mode > 2)) {\r\nif (verbose)\r\nprintk("%s: frpw: Xilinx does not support mode %d\n",\r\npi->device, pi->mode);\r\nreturn 1;\r\n}\r\nif (((pi->private%2) == 1) && (pi->mode == 2)) {\r\nif (verbose)\r\nprintk("%s: frpw: ASIC does not support mode 2\n",\r\npi->device);\r\nreturn 1;\r\n}\r\nfrpw_connect(pi);\r\nfor (j=0;j<2;j++) {\r\nfrpw_write_regr(pi,0,6,0xa0+j*0x10);\r\nfor (k=0;k<256;k++) {\r\nfrpw_write_regr(pi,0,2,k^0xaa);\r\nfrpw_write_regr(pi,0,3,k^0x55);\r\nif (frpw_read_regr(pi,0,2) != (k^0xaa)) e[j]++;\r\n}\r\n}\r\nfrpw_disconnect(pi);\r\nfrpw_connect(pi);\r\nfrpw_read_block_int(pi,scratch,512,0x10);\r\nr = 0;\r\nfor (k=0;k<128;k++) if (scratch[k] != k) r++;\r\nfrpw_disconnect(pi);\r\nif (verbose) {\r\nprintk("%s: frpw: port 0x%x, chip %ld, mode %d, test=(%d,%d,%d)\n",\r\npi->device,pi->port,(pi->private%2),pi->mode,e[0],e[1],r);\r\n}\r\nreturn (r || (e[0] && e[1]));\r\n}\r\nstatic void frpw_log_adapter( PIA *pi, char * scratch, int verbose )\r\n{ char *mode_string[6] = {"4-bit","8-bit","EPP",\r\n"EPP-8","EPP-16","EPP-32"};\r\nprintk("%s: frpw %s, Freecom (%s) adapter at 0x%x, ", pi->device,\r\nFRPW_VERSION,((pi->private%2) == 0)?"Xilinx":"ASIC",pi->port);\r\nprintk("mode %d (%s), delay %d\n",pi->mode,\r\nmode_string[pi->mode],pi->delay);\r\n}\r\nstatic int __init frpw_init(void)\r\n{\r\nreturn paride_register(&frpw);\r\n}\r\nstatic void __exit frpw_exit(void)\r\n{\r\nparide_unregister(&frpw);\r\n}

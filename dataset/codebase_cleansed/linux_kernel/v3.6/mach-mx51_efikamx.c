static void __init mx51_efikamx_board_id(void)\r\n{\r\nint id;\r\nmsleep(150);\r\ngpio_request(EFIKAMX_PCBID0, "pcbid0");\r\ngpio_direction_input(EFIKAMX_PCBID0);\r\ngpio_request(EFIKAMX_PCBID1, "pcbid1");\r\ngpio_direction_input(EFIKAMX_PCBID1);\r\ngpio_request(EFIKAMX_PCBID2, "pcbid2");\r\ngpio_direction_input(EFIKAMX_PCBID2);\r\nid = gpio_get_value(EFIKAMX_PCBID0) ? 1 : 0;\r\nid |= (gpio_get_value(EFIKAMX_PCBID1) ? 1 : 0) << 1;\r\nid |= (gpio_get_value(EFIKAMX_PCBID2) ? 1 : 0) << 2;\r\nswitch (id) {\r\ncase 7:\r\nsystem_rev = 0x11;\r\nbreak;\r\ncase 6:\r\nsystem_rev = 0x12;\r\nbreak;\r\ncase 5:\r\nsystem_rev = 0x13;\r\nbreak;\r\ncase 4:\r\nsystem_rev = 0x14;\r\nbreak;\r\ndefault:\r\nsystem_rev = 0x10;\r\nbreak;\r\n}\r\nif ((system_rev == 0x10)\r\n|| (system_rev == 0x12)\r\n|| (system_rev == 0x14)) {\r\nprintk(KERN_WARNING\r\n"EfikaMX: Unsupported board revision 1.%u!\n",\r\nsystem_rev & 0xf);\r\n}\r\n}\r\nstatic void mx51_efikamx_restart(char mode, const char *cmd)\r\n{\r\nif (system_rev == 0x11)\r\ngpio_direction_output(EFIKAMX_RESET1_1, 0);\r\nelse\r\ngpio_direction_output(EFIKAMX_RESET, 0);\r\n}\r\nstatic void mx51_efikamx_power_off(void)\r\n{\r\nif (!IS_ERR(coincell))\r\nregulator_disable(coincell);\r\nif (!IS_ERR(pwgt1) && !IS_ERR(pwgt2)) {\r\nregulator_disable(pwgt2);\r\nregulator_disable(pwgt1);\r\n}\r\ngpio_direction_output(EFIKAMX_POWEROFF, 1);\r\n}\r\nstatic int __init mx51_efikamx_power_init(void)\r\n{\r\npwgt1 = regulator_get(NULL, "pwgt1");\r\npwgt2 = regulator_get(NULL, "pwgt2");\r\nif (!IS_ERR(pwgt1) && !IS_ERR(pwgt2)) {\r\nregulator_enable(pwgt1);\r\nregulator_enable(pwgt2);\r\n}\r\ngpio_request(EFIKAMX_POWEROFF, "poweroff");\r\npm_power_off = mx51_efikamx_power_off;\r\ncoincell = regulator_get(NULL, "coincell");\r\nif (!IS_ERR(coincell)) {\r\nregulator_set_voltage(coincell, 3000000, 3000000);\r\nregulator_enable(coincell);\r\n}\r\nregulator_has_full_constraints();\r\nreturn 0;\r\n}\r\nstatic void __init mx51_efikamx_init_late(void)\r\n{\r\nimx51_init_late();\r\nmx51_efikamx_power_init();\r\n}\r\nstatic void __init mx51_efikamx_init(void)\r\n{\r\nimx51_soc_init();\r\nmxc_iomux_v3_setup_multiple_pads(mx51efikamx_pads,\r\nARRAY_SIZE(mx51efikamx_pads));\r\nefika_board_common_init();\r\nmx51_efikamx_board_id();\r\nif (system_rev < 0x12) {\r\nimx51_add_sdhci_esdhc_imx(0, NULL);\r\nimx51_add_sdhci_esdhc_imx(1, &sd_pdata);\r\nmx51_efikamx_leds[2].default_trigger = "mmc1";\r\n} else\r\nimx51_add_sdhci_esdhc_imx(0, &sd_pdata);\r\ngpio_led_register_device(-1, &mx51_efikamx_leds_data);\r\nimx_add_gpio_keys(&mx51_efikamx_powerkey_data);\r\nif (system_rev == 0x11) {\r\ngpio_request(EFIKAMX_RESET1_1, "reset");\r\ngpio_direction_output(EFIKAMX_RESET1_1, 1);\r\n} else {\r\ngpio_request(EFIKAMX_RESET, "reset");\r\ngpio_direction_output(EFIKAMX_RESET, 1);\r\n}\r\ngpio_request(EFIKA_WLAN_EN, "wlan_en");\r\ngpio_direction_output(EFIKA_WLAN_EN, 0);\r\nmsleep(10);\r\ngpio_request(EFIKA_WLAN_RESET, "wlan_rst");\r\ngpio_direction_output(EFIKA_WLAN_RESET, 0);\r\nmsleep(10);\r\ngpio_set_value(EFIKA_WLAN_RESET, 1);\r\n}\r\nstatic void __init mx51_efikamx_timer_init(void)\r\n{\r\nmx51_clocks_init(32768, 24000000, 22579200, 24576000);\r\n}

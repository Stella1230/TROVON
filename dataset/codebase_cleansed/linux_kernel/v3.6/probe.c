void __cpuinit cpu_probe(void)\r\n{\r\nunsigned long pvr, prr, cvr;\r\nunsigned long size;\r\nstatic unsigned long sizes[16] = {\r\n[1] = (1 << 12),\r\n[2] = (1 << 13),\r\n[4] = (1 << 14),\r\n[8] = (1 << 15),\r\n[9] = (1 << 16)\r\n};\r\npvr = (__raw_readl(CCN_PVR) >> 8) & 0xffffff;\r\nprr = (__raw_readl(CCN_PRR) >> 4) & 0xff;\r\ncvr = (__raw_readl(CCN_CVR));\r\nboot_cpu_data.icache.way_incr = (1 << 13);\r\nboot_cpu_data.icache.entry_shift = 5;\r\nboot_cpu_data.icache.sets = 256;\r\nboot_cpu_data.icache.ways = 1;\r\nboot_cpu_data.icache.linesz = L1_CACHE_BYTES;\r\nboot_cpu_data.dcache.way_incr = (1 << 14);\r\nboot_cpu_data.dcache.entry_shift = 5;\r\nboot_cpu_data.dcache.sets = 512;\r\nboot_cpu_data.dcache.ways = 1;\r\nboot_cpu_data.dcache.linesz = L1_CACHE_BYTES;\r\nboot_cpu_data.cut_major = boot_cpu_data.cut_minor = -1;\r\nif (((pvr >> 16) & 0xff) == 0x10) {\r\nboot_cpu_data.family = CPU_FAMILY_SH4A;\r\nif ((cvr & 0x10000000) == 0) {\r\nboot_cpu_data.flags |= CPU_HAS_DSP;\r\nboot_cpu_data.family = CPU_FAMILY_SH4AL_DSP;\r\n}\r\nboot_cpu_data.flags |= CPU_HAS_LLSC | CPU_HAS_PERF_COUNTER;\r\nboot_cpu_data.cut_major = pvr & 0x7f;\r\nboot_cpu_data.icache.ways = 4;\r\nboot_cpu_data.dcache.ways = 4;\r\n} else {\r\nboot_cpu_data.flags |= CPU_HAS_PTEA | CPU_HAS_FPU;\r\nboot_cpu_data.family = CPU_FAMILY_SH4;\r\n}\r\nif ((cvr & 0x20000000))\r\nboot_cpu_data.flags |= CPU_HAS_FPU;\r\npvr &= 0xffff;\r\nswitch (pvr) {\r\ncase 0x205:\r\nboot_cpu_data.type = CPU_SH7750;\r\nboot_cpu_data.flags |= CPU_HAS_P2_FLUSH_BUG |\r\nCPU_HAS_PERF_COUNTER;\r\nbreak;\r\ncase 0x206:\r\nboot_cpu_data.type = CPU_SH7750S;\r\nboot_cpu_data.flags |= CPU_HAS_P2_FLUSH_BUG |\r\nCPU_HAS_PERF_COUNTER;\r\nbreak;\r\ncase 0x1100:\r\nboot_cpu_data.type = CPU_SH7751;\r\nbreak;\r\ncase 0x2001:\r\ncase 0x2004:\r\nboot_cpu_data.type = CPU_SH7770;\r\nbreak;\r\ncase 0x2006:\r\ncase 0x200A:\r\nif (prr == 0x61)\r\nboot_cpu_data.type = CPU_SH7781;\r\nelse if (prr == 0xa1)\r\nboot_cpu_data.type = CPU_SH7763;\r\nelse\r\nboot_cpu_data.type = CPU_SH7780;\r\nbreak;\r\ncase 0x3000:\r\ncase 0x3003:\r\ncase 0x3009:\r\nboot_cpu_data.type = CPU_SH7343;\r\nbreak;\r\ncase 0x3004:\r\ncase 0x3007:\r\nboot_cpu_data.type = CPU_SH7785;\r\nbreak;\r\ncase 0x4004:\r\ncase 0x4005:\r\nboot_cpu_data.type = CPU_SH7786;\r\nboot_cpu_data.flags |= CPU_HAS_PTEAEX | CPU_HAS_L2_CACHE;\r\nbreak;\r\ncase 0x3008:\r\nswitch (prr) {\r\ncase 0x50:\r\ncase 0x51:\r\nboot_cpu_data.type = CPU_SH7723;\r\nboot_cpu_data.flags |= CPU_HAS_L2_CACHE;\r\nbreak;\r\ncase 0x70:\r\nboot_cpu_data.type = CPU_SH7366;\r\nbreak;\r\ncase 0xa0:\r\ncase 0xa1:\r\nboot_cpu_data.type = CPU_SH7722;\r\nbreak;\r\n}\r\nbreak;\r\ncase 0x300b:\r\nswitch (prr) {\r\ncase 0x20:\r\nboot_cpu_data.type = CPU_SH7724;\r\nboot_cpu_data.flags |= CPU_HAS_L2_CACHE;\r\nbreak;\r\ncase 0x10:\r\ncase 0x11:\r\nboot_cpu_data.type = CPU_SH7757;\r\nbreak;\r\ncase 0xd0:\r\ncase 0x40:\r\nboot_cpu_data.type = CPU_SH7372;\r\nbreak;\r\ncase 0xE0:\r\nboot_cpu_data.type = CPU_SH7734;\r\nbreak;\r\n}\r\nbreak;\r\ncase 0x4000:\r\ncase 0x4001:\r\nboot_cpu_data.type = CPU_SHX3;\r\nbreak;\r\ncase 0x700:\r\nboot_cpu_data.type = CPU_SH4_501;\r\nboot_cpu_data.flags &= ~CPU_HAS_FPU;\r\nboot_cpu_data.icache.ways = 2;\r\nboot_cpu_data.dcache.ways = 2;\r\nbreak;\r\ncase 0x600:\r\nboot_cpu_data.type = CPU_SH4_202;\r\nboot_cpu_data.icache.ways = 2;\r\nboot_cpu_data.dcache.ways = 2;\r\nbreak;\r\ncase 0x500 ... 0x501:\r\nswitch (prr) {\r\ncase 0x10:\r\nboot_cpu_data.type = CPU_SH7750R;\r\nbreak;\r\ncase 0x11:\r\nboot_cpu_data.type = CPU_SH7751R;\r\nbreak;\r\ncase 0x50 ... 0x5f:\r\nboot_cpu_data.type = CPU_SH7760;\r\nbreak;\r\n}\r\nboot_cpu_data.icache.ways = 2;\r\nboot_cpu_data.dcache.ways = 2;\r\nbreak;\r\n}\r\nif (boot_cpu_data.icache.ways > 1) {\r\nsize = sizes[(cvr >> 20) & 0xf];\r\nboot_cpu_data.icache.way_incr = (size >> 1);\r\nboot_cpu_data.icache.sets = (size >> 6);\r\n}\r\nif (boot_cpu_data.dcache.ways > 1) {\r\nsize = sizes[(cvr >> 16) & 0xf];\r\nboot_cpu_data.dcache.way_incr = (size >> 1);\r\nboot_cpu_data.dcache.sets = (size >> 6);\r\n}\r\nif (boot_cpu_data.flags & CPU_HAS_L2_CACHE) {\r\nif ((cvr & 0xf) == 0)\r\nboot_cpu_data.flags &= ~CPU_HAS_L2_CACHE;\r\nelse {\r\ncvr ^= 0xf;\r\nsize = (cvr & 0xf) << 17;\r\nboot_cpu_data.scache.way_incr = (1 << 16);\r\nboot_cpu_data.scache.entry_shift = 5;\r\nboot_cpu_data.scache.ways = 4;\r\nboot_cpu_data.scache.linesz = L1_CACHE_BYTES;\r\nboot_cpu_data.scache.entry_mask =\r\n(boot_cpu_data.scache.way_incr -\r\nboot_cpu_data.scache.linesz);\r\nboot_cpu_data.scache.sets = size /\r\n(boot_cpu_data.scache.linesz *\r\nboot_cpu_data.scache.ways);\r\nboot_cpu_data.scache.way_size =\r\n(boot_cpu_data.scache.sets *\r\nboot_cpu_data.scache.linesz);\r\n}\r\n}\r\n}

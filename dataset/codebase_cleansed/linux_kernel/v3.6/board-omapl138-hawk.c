static __init void omapl138_hawk_config_emac(void)\r\n{\r\nvoid __iomem *cfgchip3 = DA8XX_SYSCFG0_VIRT(DA8XX_CFGCHIP3_REG);\r\nint ret;\r\nu32 val;\r\nstruct davinci_soc_info *soc_info = &davinci_soc_info;\r\nval = __raw_readl(cfgchip3);\r\nval &= ~BIT(8);\r\nret = davinci_cfg_reg_list(omapl138_hawk_mii_pins);\r\nif (ret) {\r\npr_warning("%s: cpgmac/mii mux setup failed: %d\n",\r\n__func__, ret);\r\nreturn;\r\n}\r\n__raw_writel(val, cfgchip3);\r\npr_info("EMAC: MII PHY configured\n");\r\nsoc_info->emac_pdata->phy_id = HAWKBOARD_PHY_ID;\r\nret = da8xx_register_emac();\r\nif (ret)\r\npr_warning("%s: emac registration failed: %d\n",\r\n__func__, ret);\r\n}\r\nstatic int da850_hawk_mmc_get_ro(int index)\r\n{\r\nreturn gpio_get_value(DA850_HAWK_MMCSD_WP_PIN);\r\n}\r\nstatic int da850_hawk_mmc_get_cd(int index)\r\n{\r\nreturn !gpio_get_value(DA850_HAWK_MMCSD_CD_PIN);\r\n}\r\nstatic __init void omapl138_hawk_mmc_init(void)\r\n{\r\nint ret;\r\nret = davinci_cfg_reg_list(hawk_mmcsd0_pins);\r\nif (ret) {\r\npr_warning("%s: MMC/SD0 mux setup failed: %d\n",\r\n__func__, ret);\r\nreturn;\r\n}\r\nret = gpio_request_one(DA850_HAWK_MMCSD_CD_PIN,\r\nGPIOF_DIR_IN, "MMC CD");\r\nif (ret < 0) {\r\npr_warning("%s: can not open GPIO %d\n",\r\n__func__, DA850_HAWK_MMCSD_CD_PIN);\r\nreturn;\r\n}\r\nret = gpio_request_one(DA850_HAWK_MMCSD_WP_PIN,\r\nGPIOF_DIR_IN, "MMC WP");\r\nif (ret < 0) {\r\npr_warning("%s: can not open GPIO %d\n",\r\n__func__, DA850_HAWK_MMCSD_WP_PIN);\r\ngoto mmc_setup_wp_fail;\r\n}\r\nret = da8xx_register_mmcsd0(&da850_mmc_config);\r\nif (ret) {\r\npr_warning("%s: MMC/SD0 registration failed: %d\n",\r\n__func__, ret);\r\ngoto mmc_setup_mmcsd_fail;\r\n}\r\nreturn;\r\nmmc_setup_mmcsd_fail:\r\ngpio_free(DA850_HAWK_MMCSD_WP_PIN);\r\nmmc_setup_wp_fail:\r\ngpio_free(DA850_HAWK_MMCSD_CD_PIN);\r\n}\r\nstatic int hawk_usb_set_power(unsigned port, int on)\r\n{\r\ngpio_set_value(DA850_USB1_VBUS_PIN, on);\r\nreturn 0;\r\n}\r\nstatic int hawk_usb_get_power(unsigned port)\r\n{\r\nreturn gpio_get_value(DA850_USB1_VBUS_PIN);\r\n}\r\nstatic int hawk_usb_get_oci(unsigned port)\r\n{\r\nreturn !gpio_get_value(DA850_USB1_OC_PIN);\r\n}\r\nstatic int hawk_usb_ocic_notify(da8xx_ocic_handler_t handler)\r\n{\r\nint irq = gpio_to_irq(DA850_USB1_OC_PIN);\r\nint error = 0;\r\nif (handler != NULL) {\r\nhawk_usb_ocic_handler = handler;\r\nerror = request_irq(irq, omapl138_hawk_usb_ocic_irq,\r\nIRQF_DISABLED | IRQF_TRIGGER_RISING |\r\nIRQF_TRIGGER_FALLING,\r\n"OHCI over-current indicator", NULL);\r\nif (error)\r\npr_err("%s: could not request IRQ to watch "\r\n"over-current indicator changes\n", __func__);\r\n} else {\r\nfree_irq(irq, NULL);\r\n}\r\nreturn error;\r\n}\r\nstatic irqreturn_t omapl138_hawk_usb_ocic_irq(int irq, void *dev_id)\r\n{\r\nhawk_usb_ocic_handler(&omapl138_hawk_usb11_pdata, 1);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic __init void omapl138_hawk_usb_init(void)\r\n{\r\nint ret;\r\nu32 cfgchip2;\r\nret = davinci_cfg_reg_list(da850_hawk_usb11_pins);\r\nif (ret) {\r\npr_warning("%s: USB 1.1 PinMux setup failed: %d\n",\r\n__func__, ret);\r\nreturn;\r\n}\r\ncfgchip2 = __raw_readl(DA8XX_SYSCFG0_VIRT(DA8XX_CFGCHIP2_REG));\r\ncfgchip2 &= ~CFGCHIP2_REFFREQ;\r\ncfgchip2 |= CFGCHIP2_REFFREQ_24MHZ;\r\n__raw_writel(cfgchip2, DA8XX_SYSCFG0_VIRT(DA8XX_CFGCHIP2_REG));\r\nret = gpio_request_one(DA850_USB1_VBUS_PIN,\r\nGPIOF_DIR_OUT, "USB1 VBUS");\r\nif (ret < 0) {\r\npr_err("%s: failed to request GPIO for USB 1.1 port "\r\n"power control: %d\n", __func__, ret);\r\nreturn;\r\n}\r\nret = gpio_request_one(DA850_USB1_OC_PIN,\r\nGPIOF_DIR_IN, "USB1 OC");\r\nif (ret < 0) {\r\npr_err("%s: failed to request GPIO for USB 1.1 port "\r\n"over-current indicator: %d\n", __func__, ret);\r\ngoto usb11_setup_oc_fail;\r\n}\r\nret = da8xx_register_usb11(&omapl138_hawk_usb11_pdata);\r\nif (ret) {\r\npr_warning("%s: USB 1.1 registration failed: %d\n",\r\n__func__, ret);\r\ngoto usb11_setup_fail;\r\n}\r\nreturn;\r\nusb11_setup_fail:\r\ngpio_free(DA850_USB1_OC_PIN);\r\nusb11_setup_oc_fail:\r\ngpio_free(DA850_USB1_VBUS_PIN);\r\n}\r\nstatic __init void omapl138_hawk_init(void)\r\n{\r\nint ret;\r\ndavinci_serial_init(&omapl138_hawk_uart_config);\r\nomapl138_hawk_config_emac();\r\nret = da850_register_edma(da850_edma_rsv);\r\nif (ret)\r\npr_warning("%s: EDMA registration failed: %d\n",\r\n__func__, ret);\r\nomapl138_hawk_mmc_init();\r\nomapl138_hawk_usb_init();\r\nret = da8xx_register_watchdog();\r\nif (ret)\r\npr_warning("omapl138_hawk_init: "\r\n"watchdog registration failed: %d\n",\r\nret);\r\n}\r\nstatic int __init omapl138_hawk_console_init(void)\r\n{\r\nif (!machine_is_omapl138_hawkboard())\r\nreturn 0;\r\nreturn add_preferred_console("ttyS", 2, "115200");\r\n}\r\nstatic void __init omapl138_hawk_map_io(void)\r\n{\r\nda850_init();\r\n}

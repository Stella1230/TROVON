void\r\nWPA_ClearRSN(\r\nPKnownBSS pBSSList\r\n)\r\n{\r\nint ii;\r\npBSSList->byGKType = WPA_TKIP;\r\nfor (ii=0; ii < 4; ii ++)\r\npBSSList->abyPKType[ii] = WPA_TKIP;\r\npBSSList->wPKCount = 0;\r\nfor (ii=0; ii < 4; ii ++)\r\npBSSList->abyAuthType[ii] = WPA_AUTH_IEEE802_1X;\r\npBSSList->wAuthCount = 0;\r\npBSSList->byDefaultK_as_PK = 0;\r\npBSSList->byReplayIdx = 0;\r\npBSSList->sRSNCapObj.bRSNCapExist = FALSE;\r\npBSSList->sRSNCapObj.wRSNCap = 0;\r\npBSSList->bWPAValid = FALSE;\r\n}\r\nvoid\r\nWPA_ParseRSN(\r\nPKnownBSS pBSSList,\r\nPWLAN_IE_RSN_EXT pRSN\r\n)\r\n{\r\nPWLAN_IE_RSN_AUTH pIE_RSN_Auth = NULL;\r\nint i, j, m, n = 0;\r\nPBYTE pbyCaps;\r\nWPA_ClearRSN(pBSSList);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"WPA_ParseRSN: [%d]\n", pRSN->len);\r\nif ((pRSN->len >= 6)\r\n&& (pRSN->byElementID == WLAN_EID_RSN_WPA) && !memcmp(pRSN->abyOUI, abyOUI01, 4)\r\n&& (pRSN->wVersion == 1)) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"Legal RSN\n");\r\nif (pRSN->len >= 10)\r\n{\r\nif ( !memcmp(pRSN->abyMulticast, abyOUI01, 4))\r\npBSSList->byGKType = WPA_WEP40;\r\nelse if ( !memcmp(pRSN->abyMulticast, abyOUI02, 4))\r\npBSSList->byGKType = WPA_TKIP;\r\nelse if ( !memcmp(pRSN->abyMulticast, abyOUI03, 4))\r\npBSSList->byGKType = WPA_AESWRAP;\r\nelse if ( !memcmp(pRSN->abyMulticast, abyOUI04, 4))\r\npBSSList->byGKType = WPA_AESCCMP;\r\nelse if ( !memcmp(pRSN->abyMulticast, abyOUI05, 4))\r\npBSSList->byGKType = WPA_WEP104;\r\nelse\r\npBSSList->byGKType = WPA_NONE;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"byGKType: %x\n", pBSSList->byGKType);\r\n}\r\nif (pRSN->len >= 12)\r\n{\r\nj = 0;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"wPKCount: %d, sizeof(pBSSList->abyPKType): %zu\n", pRSN->wPKCount, sizeof(pBSSList->abyPKType));\r\nfor (i = 0; (i < pRSN->wPKCount) &&\r\n(j < ARRAY_SIZE(pBSSList->abyPKType)); i++) {\r\nif(pRSN->len >= 12+i*4+4) {\r\nif ( !memcmp(pRSN->PKSList[i].abyOUI, abyOUI00, 4))\r\npBSSList->abyPKType[j++] = WPA_NONE;\r\nelse if ( !memcmp(pRSN->PKSList[i].abyOUI, abyOUI02, 4))\r\npBSSList->abyPKType[j++] = WPA_TKIP;\r\nelse if ( !memcmp(pRSN->PKSList[i].abyOUI, abyOUI03, 4))\r\npBSSList->abyPKType[j++] = WPA_AESWRAP;\r\nelse if ( !memcmp(pRSN->PKSList[i].abyOUI, abyOUI04, 4))\r\npBSSList->abyPKType[j++] = WPA_AESCCMP;\r\nelse\r\n;\r\n}\r\nelse\r\nbreak;\r\n}\r\npBSSList->wPKCount = (WORD)j;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"wPKCount: %d\n", pBSSList->wPKCount);\r\n}\r\nm = pRSN->wPKCount;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"m: %d\n", m);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"14+m*4: %d\n", 14+m*4);\r\nif (pRSN->len >= 14+m*4) {\r\npIE_RSN_Auth = (PWLAN_IE_RSN_AUTH) pRSN->PKSList[m].abyOUI;\r\nj = 0;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"wAuthCount: %d, sizeof(pBSSList->abyAuthType): %zu\n",\r\npIE_RSN_Auth->wAuthCount, sizeof(pBSSList->abyAuthType));\r\nfor (i = 0; (i < pIE_RSN_Auth->wAuthCount) &&\r\n(j < ARRAY_SIZE(pBSSList->abyAuthType)); i++) {\r\nif(pRSN->len >= 14+4+(m+i)*4) {\r\nif ( !memcmp(pIE_RSN_Auth->AuthKSList[i].abyOUI, abyOUI01, 4))\r\npBSSList->abyAuthType[j++] = WPA_AUTH_IEEE802_1X;\r\nelse if ( !memcmp(pIE_RSN_Auth->AuthKSList[i].abyOUI, abyOUI02, 4))\r\npBSSList->abyAuthType[j++] = WPA_AUTH_PSK;\r\nelse\r\n;\r\n}\r\nelse\r\nbreak;\r\n}\r\nif(j > 0)\r\npBSSList->wAuthCount = (WORD)j;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"wAuthCount: %d\n", pBSSList->wAuthCount);\r\n}\r\nif (pIE_RSN_Auth != NULL) {\r\nn = pIE_RSN_Auth->wAuthCount;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"n: %d\n", n);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"14+4+(m+n)*4: %d\n", 14+4+(m+n)*4);\r\nif(pRSN->len+2 >= 14+4+(m+n)*4) {\r\npbyCaps = (PBYTE)pIE_RSN_Auth->AuthKSList[n].abyOUI;\r\npBSSList->byDefaultK_as_PK = (*pbyCaps) & WPA_GROUPFLAG;\r\npBSSList->byReplayIdx = 2 << ((*pbyCaps >> WPA_REPLAYBITSSHIFT) & WPA_REPLAYBITS);\r\npBSSList->sRSNCapObj.bRSNCapExist = TRUE;\r\npBSSList->sRSNCapObj.wRSNCap = *(PWORD)pbyCaps;\r\n}\r\n}\r\npBSSList->bWPAValid = TRUE;\r\n}\r\n}\r\nBOOL\r\nWPA_SearchRSN(\r\nBYTE byCmd,\r\nBYTE byEncrypt,\r\nPKnownBSS pBSSList\r\n)\r\n{\r\nint ii;\r\nBYTE byPKType = WPA_NONE;\r\nif (pBSSList->bWPAValid == FALSE)\r\nreturn FALSE;\r\nswitch(byCmd) {\r\ncase 0:\r\nif (byEncrypt != pBSSList->byGKType)\r\nreturn FALSE;\r\nif (pBSSList->wPKCount > 0) {\r\nfor (ii = 0; ii < pBSSList->wPKCount; ii ++) {\r\nif (pBSSList->abyPKType[ii] == WPA_AESCCMP)\r\nbyPKType = WPA_AESCCMP;\r\nelse if ((pBSSList->abyPKType[ii] == WPA_TKIP) && (byPKType != WPA_AESCCMP))\r\nbyPKType = WPA_TKIP;\r\nelse if ((pBSSList->abyPKType[ii] == WPA_WEP40) && (byPKType != WPA_AESCCMP) && (byPKType != WPA_TKIP))\r\nbyPKType = WPA_WEP40;\r\nelse if ((pBSSList->abyPKType[ii] == WPA_WEP104) && (byPKType != WPA_AESCCMP) && (byPKType != WPA_TKIP))\r\nbyPKType = WPA_WEP104;\r\n}\r\nif (byEncrypt != byPKType)\r\nreturn FALSE;\r\n}\r\nreturn TRUE;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn FALSE;\r\n}\r\nBOOL\r\nWPAb_Is_RSN(\r\nPWLAN_IE_RSN_EXT pRSN\r\n)\r\n{\r\nif (pRSN == NULL)\r\nreturn FALSE;\r\nif ((pRSN->len >= 6) &&\r\n(pRSN->byElementID == WLAN_EID_RSN_WPA) && !memcmp(pRSN->abyOUI, abyOUI01, 4) &&\r\n(pRSN->wVersion == 1)) {\r\nreturn TRUE;\r\n}\r\nelse\r\nreturn FALSE;\r\n}

static int titan_ht_config_read_dword(struct pci_bus *bus, unsigned int devfn,\r\nint offset, u32 *val)\r\n{\r\nvolatile uint32_t address;\r\nint busno;\r\nbusno = bus->number;\r\naddress = (busno << 16) | (devfn << 8) | (offset & 0xfc) | 0x80000000;\r\nif (busno != 0)\r\naddress |= 1;\r\n*(volatile int32_t *) 0xfb0000f0 |= 0x2;\r\nudelay(30);\r\n*(volatile int32_t *) 0xfb0006f8 = address;\r\n*(val) = *(volatile int32_t *) 0xfb0006fc;\r\nudelay(30);\r\n* (volatile int32_t *) 0xfb0000f0 |= 0x2;\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int titan_ht_config_read(struct pci_bus *bus, unsigned int devfn,\r\nint offset, int size, u32 *val)\r\n{\r\nuint32_t dword;\r\ntitan_ht_config_read_dword(bus, devfn, offset, &dword);\r\ndword >>= ((offset & 3) << 3);\r\ndword &= (0xffffffffU >> ((4 - size) << 8));\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic inline int titan_ht_config_write_dword(struct pci_bus *bus,\r\nunsigned int devfn, int offset, u32 val)\r\n{\r\nvolatile uint32_t address;\r\nint busno;\r\nbusno = bus->number;\r\naddress = (busno << 16) | (devfn << 8) | (offset & 0xfc) | 0x80000000;\r\nif (busno != 0)\r\naddress |= 1;\r\n*(volatile int32_t *) 0xfb0000f0 |= 0x2;\r\nudelay(30);\r\n*(volatile int32_t *) 0xfb0006f8 = address;\r\n*(volatile int32_t *) 0xfb0006fc = val;\r\nudelay(30);\r\n*(volatile int32_t *) 0xfb0000f0 |= 0x2;\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int titan_ht_config_write(struct pci_bus *bus, unsigned int devfn,\r\nint offset, int size, u32 val)\r\n{\r\nuint32_t val1, val2, mask;\r\ntitan_ht_config_read_dword(bus, devfn, offset, &val2);\r\nval1 = val << ((offset & 3) << 3);\r\nmask = ~(0xffffffffU >> ((4 - size) << 8));\r\nval2 &= ~(mask << ((offset & 3) << 8));\r\ntitan_ht_config_write_dword(bus, devfn, offset, val1 | val2);\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}

static int\r\nnv10_fifo_context_new(struct nouveau_channel *chan, int engine)\r\n{\r\nstruct drm_device *dev = chan->dev;\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nv10_fifo_priv *priv = nv_engine(dev, engine);\r\nstruct nv10_fifo_chan *fctx;\r\nunsigned long flags;\r\nint ret;\r\nfctx = chan->engctx[engine] = kzalloc(sizeof(*fctx), GFP_KERNEL);\r\nif (!fctx)\r\nreturn -ENOMEM;\r\nchan->user = ioremap(pci_resource_start(dev->pdev, 0) +\r\nNV03_USER(chan->id), PAGE_SIZE);\r\nif (!chan->user) {\r\nret = -ENOMEM;\r\ngoto error;\r\n}\r\nret = nouveau_gpuobj_new_fake(dev, dev_priv->ramfc->pinst +\r\nchan->id * 32, ~0, 32,\r\nNVOBJ_FLAG_ZERO_FREE, &fctx->ramfc);\r\nif (ret)\r\ngoto error;\r\nnv_wo32(fctx->ramfc, 0x00, chan->pushbuf_base);\r\nnv_wo32(fctx->ramfc, 0x04, chan->pushbuf_base);\r\nnv_wo32(fctx->ramfc, 0x08, 0x00000000);\r\nnv_wo32(fctx->ramfc, 0x0c, chan->pushbuf->pinst >> 4);\r\nnv_wo32(fctx->ramfc, 0x10, 0x00000000);\r\nnv_wo32(fctx->ramfc, 0x14, NV_PFIFO_CACHE1_DMA_FETCH_TRIG_128_BYTES |\r\nNV_PFIFO_CACHE1_DMA_FETCH_SIZE_128_BYTES |\r\n#ifdef __BIG_ENDIAN\r\nNV_PFIFO_CACHE1_BIG_ENDIAN |\r\n#endif\r\nNV_PFIFO_CACHE1_DMA_FETCH_MAX_REQS_8);\r\nnv_wo32(fctx->ramfc, 0x18, 0x00000000);\r\nnv_wo32(fctx->ramfc, 0x1c, 0x00000000);\r\nspin_lock_irqsave(&dev_priv->context_switch_lock, flags);\r\nnv_mask(dev, NV04_PFIFO_MODE, (1 << chan->id), (1 << chan->id));\r\nspin_unlock_irqrestore(&dev_priv->context_switch_lock, flags);\r\nerror:\r\nif (ret)\r\npriv->base.base.context_del(chan, engine);\r\nreturn ret;\r\n}\r\nint\r\nnv10_fifo_create(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nv10_fifo_priv *priv;\r\npriv = kzalloc(sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->base.base.destroy = nv04_fifo_destroy;\r\npriv->base.base.init = nv04_fifo_init;\r\npriv->base.base.fini = nv04_fifo_fini;\r\npriv->base.base.context_new = nv10_fifo_context_new;\r\npriv->base.base.context_del = nv04_fifo_context_del;\r\npriv->base.channels = 31;\r\npriv->ramfc_desc = nv10_ramfc;\r\ndev_priv->eng[NVOBJ_ENGINE_FIFO] = &priv->base.base;\r\nnouveau_irq_register(dev, 8, nv04_fifo_isr);\r\nreturn 0;\r\n}

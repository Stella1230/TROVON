static void evergreen_hdmi_update_ACR(struct drm_encoder *encoder, uint32_t clock)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct radeon_hdmi_acr acr = r600_hdmi_acr(clock);\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct radeon_encoder_atom_dig *dig = radeon_encoder->enc_priv;\r\nuint32_t offset = dig->afmt->offset;\r\nWREG32(HDMI_ACR_32_0 + offset, HDMI_ACR_CTS_32(acr.cts_32khz));\r\nWREG32(HDMI_ACR_32_1 + offset, acr.n_32khz);\r\nWREG32(HDMI_ACR_44_0 + offset, HDMI_ACR_CTS_44(acr.cts_44_1khz));\r\nWREG32(HDMI_ACR_44_1 + offset, acr.n_44_1khz);\r\nWREG32(HDMI_ACR_48_0 + offset, HDMI_ACR_CTS_48(acr.cts_48khz));\r\nWREG32(HDMI_ACR_48_1 + offset, acr.n_48khz);\r\n}\r\nstatic void evergreen_hdmi_infoframe_checksum(uint8_t packetType,\r\nuint8_t versionNumber,\r\nuint8_t length,\r\nuint8_t *frame)\r\n{\r\nint i;\r\nframe[0] = packetType + versionNumber + length;\r\nfor (i = 1; i <= length; i++)\r\nframe[0] += frame[i];\r\nframe[0] = 0x100 - frame[0];\r\n}\r\nstatic void evergreen_hdmi_videoinfoframe(\r\nstruct drm_encoder *encoder,\r\nuint8_t color_format,\r\nint active_information_present,\r\nuint8_t active_format_aspect_ratio,\r\nuint8_t scan_information,\r\nuint8_t colorimetry,\r\nuint8_t ex_colorimetry,\r\nuint8_t quantization,\r\nint ITC,\r\nuint8_t picture_aspect_ratio,\r\nuint8_t video_format_identification,\r\nuint8_t pixel_repetition,\r\nuint8_t non_uniform_picture_scaling,\r\nuint8_t bar_info_data_valid,\r\nuint16_t top_bar,\r\nuint16_t bottom_bar,\r\nuint16_t left_bar,\r\nuint16_t right_bar\r\n)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct radeon_encoder_atom_dig *dig = radeon_encoder->enc_priv;\r\nuint32_t offset = dig->afmt->offset;\r\nuint8_t frame[14];\r\nframe[0x0] = 0;\r\nframe[0x1] =\r\n(scan_information & 0x3) |\r\n((bar_info_data_valid & 0x3) << 2) |\r\n((active_information_present & 0x1) << 4) |\r\n((color_format & 0x3) << 5);\r\nframe[0x2] =\r\n(active_format_aspect_ratio & 0xF) |\r\n((picture_aspect_ratio & 0x3) << 4) |\r\n((colorimetry & 0x3) << 6);\r\nframe[0x3] =\r\n(non_uniform_picture_scaling & 0x3) |\r\n((quantization & 0x3) << 2) |\r\n((ex_colorimetry & 0x7) << 4) |\r\n((ITC & 0x1) << 7);\r\nframe[0x4] = (video_format_identification & 0x7F);\r\nframe[0x5] = (pixel_repetition & 0xF);\r\nframe[0x6] = (top_bar & 0xFF);\r\nframe[0x7] = (top_bar >> 8);\r\nframe[0x8] = (bottom_bar & 0xFF);\r\nframe[0x9] = (bottom_bar >> 8);\r\nframe[0xA] = (left_bar & 0xFF);\r\nframe[0xB] = (left_bar >> 8);\r\nframe[0xC] = (right_bar & 0xFF);\r\nframe[0xD] = (right_bar >> 8);\r\nevergreen_hdmi_infoframe_checksum(0x82, 0x02, 0x0D, frame);\r\nframe[0x0] += 2;\r\nWREG32(AFMT_AVI_INFO0 + offset,\r\nframe[0x0] | (frame[0x1] << 8) | (frame[0x2] << 16) | (frame[0x3] << 24));\r\nWREG32(AFMT_AVI_INFO1 + offset,\r\nframe[0x4] | (frame[0x5] << 8) | (frame[0x6] << 16) | (frame[0x7] << 24));\r\nWREG32(AFMT_AVI_INFO2 + offset,\r\nframe[0x8] | (frame[0x9] << 8) | (frame[0xA] << 16) | (frame[0xB] << 24));\r\nWREG32(AFMT_AVI_INFO3 + offset,\r\nframe[0xC] | (frame[0xD] << 8));\r\n}\r\nvoid evergreen_hdmi_setmode(struct drm_encoder *encoder, struct drm_display_mode *mode)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct radeon_encoder_atom_dig *dig = radeon_encoder->enc_priv;\r\nuint32_t offset;\r\nif (!dig->afmt->enabled)\r\nreturn;\r\noffset = dig->afmt->offset;\r\nr600_audio_set_clock(encoder, mode->clock);\r\nWREG32(HDMI_VBI_PACKET_CONTROL + offset,\r\nHDMI_NULL_SEND);\r\nWREG32(AFMT_AUDIO_CRC_CONTROL + offset, 0x1000);\r\nWREG32(HDMI_AUDIO_PACKET_CONTROL + offset,\r\nHDMI_AUDIO_DELAY_EN(1) |\r\nHDMI_AUDIO_PACKETS_PER_LINE(3));\r\nWREG32(AFMT_AUDIO_PACKET_CONTROL + offset,\r\nAFMT_AUDIO_SAMPLE_SEND |\r\nAFMT_60958_CS_UPDATE);\r\nWREG32(HDMI_ACR_PACKET_CONTROL + offset,\r\nHDMI_ACR_AUTO_SEND |\r\nHDMI_ACR_SOURCE);\r\nWREG32(HDMI_VBI_PACKET_CONTROL + offset,\r\nHDMI_NULL_SEND |\r\nHDMI_GC_SEND |\r\nHDMI_GC_CONT);\r\nWREG32(HDMI_INFOFRAME_CONTROL0 + offset,\r\nHDMI_AVI_INFO_SEND |\r\nHDMI_AVI_INFO_CONT |\r\nHDMI_AUDIO_INFO_SEND |\r\nHDMI_AUDIO_INFO_CONT);\r\nWREG32(AFMT_INFOFRAME_CONTROL0 + offset,\r\nAFMT_AUDIO_INFO_UPDATE);\r\nWREG32(HDMI_INFOFRAME_CONTROL1 + offset,\r\nHDMI_AVI_INFO_LINE(2) |\r\nHDMI_AUDIO_INFO_LINE(2));\r\nWREG32(HDMI_GC + offset, 0);\r\nevergreen_hdmi_videoinfoframe(encoder, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0, 0,\r\n0, 0, 0, 0, 0, 0);\r\nevergreen_hdmi_update_ACR(encoder, mode->clock);\r\nWREG32(AFMT_RAMP_CONTROL0 + offset, 0x00FFFFFF);\r\nWREG32(AFMT_RAMP_CONTROL1 + offset, 0x007FFFFF);\r\nWREG32(AFMT_RAMP_CONTROL2 + offset, 0x00000001);\r\nWREG32(AFMT_RAMP_CONTROL3 + offset, 0x00000001);\r\n}

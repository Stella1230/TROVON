static void tifm_7xx1_dummy_eject(struct tifm_adapter *fm,\r\nstruct tifm_dev *sock)\r\n{\r\n}\r\nstatic void tifm_7xx1_eject(struct tifm_adapter *fm, struct tifm_dev *sock)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&fm->lock, flags);\r\nfm->socket_change_set |= 1 << sock->socket_id;\r\ntifm_queue_work(&fm->media_switcher);\r\nspin_unlock_irqrestore(&fm->lock, flags);\r\n}\r\nstatic irqreturn_t tifm_7xx1_isr(int irq, void *dev_id)\r\n{\r\nstruct tifm_adapter *fm = dev_id;\r\nstruct tifm_dev *sock;\r\nunsigned int irq_status, cnt;\r\nspin_lock(&fm->lock);\r\nirq_status = readl(fm->addr + FM_INTERRUPT_STATUS);\r\nif (irq_status == 0 || irq_status == (~0)) {\r\nspin_unlock(&fm->lock);\r\nreturn IRQ_NONE;\r\n}\r\nif (irq_status & TIFM_IRQ_ENABLE) {\r\nwritel(TIFM_IRQ_ENABLE, fm->addr + FM_CLEAR_INTERRUPT_ENABLE);\r\nfor (cnt = 0; cnt < fm->num_sockets; cnt++) {\r\nsock = fm->sockets[cnt];\r\nif (sock) {\r\nif ((irq_status >> cnt) & TIFM_IRQ_FIFOMASK(1))\r\nsock->data_event(sock);\r\nif ((irq_status >> cnt) & TIFM_IRQ_CARDMASK(1))\r\nsock->card_event(sock);\r\n}\r\n}\r\nfm->socket_change_set |= irq_status\r\n& ((1 << fm->num_sockets) - 1);\r\n}\r\nwritel(irq_status, fm->addr + FM_INTERRUPT_STATUS);\r\nif (fm->finish_me)\r\ncomplete_all(fm->finish_me);\r\nelse if (!fm->socket_change_set)\r\nwritel(TIFM_IRQ_ENABLE, fm->addr + FM_SET_INTERRUPT_ENABLE);\r\nelse\r\ntifm_queue_work(&fm->media_switcher);\r\nspin_unlock(&fm->lock);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic unsigned char tifm_7xx1_toggle_sock_power(char __iomem *sock_addr)\r\n{\r\nunsigned int s_state;\r\nint cnt;\r\nwritel(0x0e00, sock_addr + SOCK_CONTROL);\r\nfor (cnt = 16; cnt <= 256; cnt <<= 1) {\r\nif (!(TIFM_SOCK_STATE_POWERED\r\n& readl(sock_addr + SOCK_PRESENT_STATE)))\r\nbreak;\r\nmsleep(cnt);\r\n}\r\ns_state = readl(sock_addr + SOCK_PRESENT_STATE);\r\nif (!(TIFM_SOCK_STATE_OCCUPIED & s_state))\r\nreturn 0;\r\nwritel(readl(sock_addr + SOCK_CONTROL) | TIFM_CTRL_LED,\r\nsock_addr + SOCK_CONTROL);\r\nif (((readl(sock_addr + SOCK_PRESENT_STATE) >> 4) & 7)\r\n== TIFM_TYPE_XD)\r\nmsleep(40);\r\nwritel((s_state & TIFM_CTRL_POWER_MASK) | 0x0c00,\r\nsock_addr + SOCK_CONTROL);\r\nmsleep(20);\r\nfor (cnt = 16; cnt <= 256; cnt <<= 1) {\r\nif ((TIFM_SOCK_STATE_POWERED\r\n& readl(sock_addr + SOCK_PRESENT_STATE)))\r\nbreak;\r\nmsleep(cnt);\r\n}\r\nwritel(readl(sock_addr + SOCK_CONTROL) & (~TIFM_CTRL_LED),\r\nsock_addr + SOCK_CONTROL);\r\nreturn (readl(sock_addr + SOCK_PRESENT_STATE) >> 4) & 7;\r\n}\r\ninline static void tifm_7xx1_sock_power_off(char __iomem *sock_addr)\r\n{\r\nwritel((~TIFM_CTRL_POWER_MASK) & readl(sock_addr + SOCK_CONTROL),\r\nsock_addr + SOCK_CONTROL);\r\n}\r\ninline static char __iomem *\r\ntifm_7xx1_sock_addr(char __iomem *base_addr, unsigned int sock_num)\r\n{\r\nreturn base_addr + ((sock_num + 1) << 10);\r\n}\r\nstatic void tifm_7xx1_switch_media(struct work_struct *work)\r\n{\r\nstruct tifm_adapter *fm = container_of(work, struct tifm_adapter,\r\nmedia_switcher);\r\nstruct tifm_dev *sock;\r\nchar __iomem *sock_addr;\r\nunsigned long flags;\r\nunsigned char media_id;\r\nunsigned int socket_change_set, cnt;\r\nspin_lock_irqsave(&fm->lock, flags);\r\nsocket_change_set = fm->socket_change_set;\r\nfm->socket_change_set = 0;\r\ndev_dbg(fm->dev.parent, "checking media set %x\n",\r\nsocket_change_set);\r\nif (!socket_change_set) {\r\nspin_unlock_irqrestore(&fm->lock, flags);\r\nreturn;\r\n}\r\nfor (cnt = 0; cnt < fm->num_sockets; cnt++) {\r\nif (!(socket_change_set & (1 << cnt)))\r\ncontinue;\r\nsock = fm->sockets[cnt];\r\nif (sock) {\r\nprintk(KERN_INFO\r\n"%s : demand removing card from socket %u:%u\n",\r\ndev_name(&fm->dev), fm->id, cnt);\r\nfm->sockets[cnt] = NULL;\r\nsock_addr = sock->addr;\r\nspin_unlock_irqrestore(&fm->lock, flags);\r\ndevice_unregister(&sock->dev);\r\nspin_lock_irqsave(&fm->lock, flags);\r\ntifm_7xx1_sock_power_off(sock_addr);\r\nwritel(0x0e00, sock_addr + SOCK_CONTROL);\r\n}\r\nspin_unlock_irqrestore(&fm->lock, flags);\r\nmedia_id = tifm_7xx1_toggle_sock_power(\r\ntifm_7xx1_sock_addr(fm->addr, cnt));\r\nsock = tifm_alloc_device(fm, cnt, media_id);\r\nif (sock) {\r\nsock->addr = tifm_7xx1_sock_addr(fm->addr, cnt);\r\nif (!device_register(&sock->dev)) {\r\nspin_lock_irqsave(&fm->lock, flags);\r\nif (!fm->sockets[cnt]) {\r\nfm->sockets[cnt] = sock;\r\nsock = NULL;\r\n}\r\nspin_unlock_irqrestore(&fm->lock, flags);\r\n}\r\nif (sock)\r\ntifm_free_device(&sock->dev);\r\n}\r\nspin_lock_irqsave(&fm->lock, flags);\r\n}\r\nwritel(TIFM_IRQ_FIFOMASK(socket_change_set)\r\n| TIFM_IRQ_CARDMASK(socket_change_set),\r\nfm->addr + FM_CLEAR_INTERRUPT_ENABLE);\r\nwritel(TIFM_IRQ_FIFOMASK(socket_change_set)\r\n| TIFM_IRQ_CARDMASK(socket_change_set),\r\nfm->addr + FM_SET_INTERRUPT_ENABLE);\r\nwritel(TIFM_IRQ_ENABLE, fm->addr + FM_SET_INTERRUPT_ENABLE);\r\nspin_unlock_irqrestore(&fm->lock, flags);\r\n}\r\nstatic int tifm_7xx1_suspend(struct pci_dev *dev, pm_message_t state)\r\n{\r\nstruct tifm_adapter *fm = pci_get_drvdata(dev);\r\nint cnt;\r\ndev_dbg(&dev->dev, "suspending host\n");\r\nfor (cnt = 0; cnt < fm->num_sockets; cnt++) {\r\nif (fm->sockets[cnt])\r\ntifm_7xx1_sock_power_off(fm->sockets[cnt]->addr);\r\n}\r\npci_save_state(dev);\r\npci_enable_wake(dev, pci_choose_state(dev, state), 0);\r\npci_disable_device(dev);\r\npci_set_power_state(dev, pci_choose_state(dev, state));\r\nreturn 0;\r\n}\r\nstatic int tifm_7xx1_resume(struct pci_dev *dev)\r\n{\r\nstruct tifm_adapter *fm = pci_get_drvdata(dev);\r\nint rc;\r\nunsigned int good_sockets = 0, bad_sockets = 0;\r\nunsigned long flags;\r\nunsigned char new_ids[fm->num_sockets];\r\nDECLARE_COMPLETION_ONSTACK(finish_resume);\r\npci_set_power_state(dev, PCI_D0);\r\npci_restore_state(dev);\r\nrc = pci_enable_device(dev);\r\nif (rc)\r\nreturn rc;\r\npci_set_master(dev);\r\ndev_dbg(&dev->dev, "resuming host\n");\r\nfor (rc = 0; rc < fm->num_sockets; rc++)\r\nnew_ids[rc] = tifm_7xx1_toggle_sock_power(\r\ntifm_7xx1_sock_addr(fm->addr, rc));\r\nspin_lock_irqsave(&fm->lock, flags);\r\nfor (rc = 0; rc < fm->num_sockets; rc++) {\r\nif (fm->sockets[rc]) {\r\nif (fm->sockets[rc]->type == new_ids[rc])\r\ngood_sockets |= 1 << rc;\r\nelse\r\nbad_sockets |= 1 << rc;\r\n}\r\n}\r\nwritel(TIFM_IRQ_ENABLE | TIFM_IRQ_SOCKMASK((1 << fm->num_sockets) - 1),\r\nfm->addr + FM_SET_INTERRUPT_ENABLE);\r\ndev_dbg(&dev->dev, "change sets on resume: good %x, bad %x\n",\r\ngood_sockets, bad_sockets);\r\nfm->socket_change_set = 0;\r\nif (good_sockets) {\r\nfm->finish_me = &finish_resume;\r\nspin_unlock_irqrestore(&fm->lock, flags);\r\nrc = wait_for_completion_timeout(&finish_resume, HZ);\r\ndev_dbg(&dev->dev, "wait returned %d\n", rc);\r\nwritel(TIFM_IRQ_FIFOMASK(good_sockets)\r\n| TIFM_IRQ_CARDMASK(good_sockets),\r\nfm->addr + FM_CLEAR_INTERRUPT_ENABLE);\r\nwritel(TIFM_IRQ_FIFOMASK(good_sockets)\r\n| TIFM_IRQ_CARDMASK(good_sockets),\r\nfm->addr + FM_SET_INTERRUPT_ENABLE);\r\nspin_lock_irqsave(&fm->lock, flags);\r\nfm->finish_me = NULL;\r\nfm->socket_change_set ^= good_sockets & fm->socket_change_set;\r\n}\r\nfm->socket_change_set |= bad_sockets;\r\nif (fm->socket_change_set)\r\ntifm_queue_work(&fm->media_switcher);\r\nspin_unlock_irqrestore(&fm->lock, flags);\r\nwritel(TIFM_IRQ_ENABLE,\r\nfm->addr + FM_SET_INTERRUPT_ENABLE);\r\nreturn 0;\r\n}\r\nstatic int tifm_7xx1_dummy_has_ms_pif(struct tifm_adapter *fm,\r\nstruct tifm_dev *sock)\r\n{\r\nreturn 0;\r\n}\r\nstatic int tifm_7xx1_has_ms_pif(struct tifm_adapter *fm, struct tifm_dev *sock)\r\n{\r\nif (((fm->num_sockets == 4) && (sock->socket_id == 2))\r\n|| ((fm->num_sockets == 2) && (sock->socket_id == 0)))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int tifm_7xx1_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *dev_id)\r\n{\r\nstruct tifm_adapter *fm;\r\nint pci_dev_busy = 0;\r\nint rc;\r\nrc = pci_set_dma_mask(dev, DMA_BIT_MASK(32));\r\nif (rc)\r\nreturn rc;\r\nrc = pci_enable_device(dev);\r\nif (rc)\r\nreturn rc;\r\npci_set_master(dev);\r\nrc = pci_request_regions(dev, DRIVER_NAME);\r\nif (rc) {\r\npci_dev_busy = 1;\r\ngoto err_out;\r\n}\r\npci_intx(dev, 1);\r\nfm = tifm_alloc_adapter(dev->device == PCI_DEVICE_ID_TI_XX21_XX11_FM\r\n? 4 : 2, &dev->dev);\r\nif (!fm) {\r\nrc = -ENOMEM;\r\ngoto err_out_int;\r\n}\r\nINIT_WORK(&fm->media_switcher, tifm_7xx1_switch_media);\r\nfm->eject = tifm_7xx1_eject;\r\nfm->has_ms_pif = tifm_7xx1_has_ms_pif;\r\npci_set_drvdata(dev, fm);\r\nfm->addr = pci_ioremap_bar(dev, 0);\r\nif (!fm->addr)\r\ngoto err_out_free;\r\nrc = request_irq(dev->irq, tifm_7xx1_isr, IRQF_SHARED, DRIVER_NAME, fm);\r\nif (rc)\r\ngoto err_out_unmap;\r\nrc = tifm_add_adapter(fm);\r\nif (rc)\r\ngoto err_out_irq;\r\nwritel(TIFM_IRQ_ENABLE | TIFM_IRQ_SOCKMASK((1 << fm->num_sockets) - 1),\r\nfm->addr + FM_CLEAR_INTERRUPT_ENABLE);\r\nwritel(TIFM_IRQ_ENABLE | TIFM_IRQ_SOCKMASK((1 << fm->num_sockets) - 1),\r\nfm->addr + FM_SET_INTERRUPT_ENABLE);\r\nreturn 0;\r\nerr_out_irq:\r\nfree_irq(dev->irq, fm);\r\nerr_out_unmap:\r\niounmap(fm->addr);\r\nerr_out_free:\r\npci_set_drvdata(dev, NULL);\r\ntifm_free_adapter(fm);\r\nerr_out_int:\r\npci_intx(dev, 0);\r\npci_release_regions(dev);\r\nerr_out:\r\nif (!pci_dev_busy)\r\npci_disable_device(dev);\r\nreturn rc;\r\n}\r\nstatic void tifm_7xx1_remove(struct pci_dev *dev)\r\n{\r\nstruct tifm_adapter *fm = pci_get_drvdata(dev);\r\nint cnt;\r\nfm->eject = tifm_7xx1_dummy_eject;\r\nfm->has_ms_pif = tifm_7xx1_dummy_has_ms_pif;\r\nwritel(TIFM_IRQ_SETALL, fm->addr + FM_CLEAR_INTERRUPT_ENABLE);\r\nmmiowb();\r\nfree_irq(dev->irq, fm);\r\ntifm_remove_adapter(fm);\r\nfor (cnt = 0; cnt < fm->num_sockets; cnt++)\r\ntifm_7xx1_sock_power_off(tifm_7xx1_sock_addr(fm->addr, cnt));\r\npci_set_drvdata(dev, NULL);\r\niounmap(fm->addr);\r\npci_intx(dev, 0);\r\npci_release_regions(dev);\r\npci_disable_device(dev);\r\ntifm_free_adapter(fm);\r\n}\r\nstatic int __init tifm_7xx1_init(void)\r\n{\r\nreturn pci_register_driver(&tifm_7xx1_driver);\r\n}\r\nstatic void __exit tifm_7xx1_exit(void)\r\n{\r\npci_unregister_driver(&tifm_7xx1_driver);\r\n}

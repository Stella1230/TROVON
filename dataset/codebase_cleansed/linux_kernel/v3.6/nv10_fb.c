void\r\nnv10_fb_init_tile_region(struct drm_device *dev, int i, uint32_t addr,\r\nuint32_t size, uint32_t pitch, uint32_t flags)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_tile_reg *tile = &dev_priv->tile.reg[i];\r\ntile->addr = 0x80000000 | addr;\r\ntile->limit = max(1u, addr + size) - 1;\r\ntile->pitch = pitch;\r\n}\r\nvoid\r\nnv10_fb_free_tile_region(struct drm_device *dev, int i)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_tile_reg *tile = &dev_priv->tile.reg[i];\r\ntile->addr = tile->limit = tile->pitch = tile->zcomp = 0;\r\n}\r\nvoid\r\nnv10_fb_set_tile_region(struct drm_device *dev, int i)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_tile_reg *tile = &dev_priv->tile.reg[i];\r\nnv_wr32(dev, NV10_PFB_TLIMIT(i), tile->limit);\r\nnv_wr32(dev, NV10_PFB_TSIZE(i), tile->pitch);\r\nnv_wr32(dev, NV10_PFB_TILE(i), tile->addr);\r\n}\r\nint\r\nnv1a_fb_vram_init(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct pci_dev *bridge;\r\nuint32_t mem, mib;\r\nbridge = pci_get_bus_and_slot(0, PCI_DEVFN(0, 1));\r\nif (!bridge) {\r\nNV_ERROR(dev, "no bridge device\n");\r\nreturn 0;\r\n}\r\nif (dev_priv->chipset == 0x1a) {\r\npci_read_config_dword(bridge, 0x7c, &mem);\r\nmib = ((mem >> 6) & 31) + 1;\r\n} else {\r\npci_read_config_dword(bridge, 0x84, &mem);\r\nmib = ((mem >> 4) & 127) + 1;\r\n}\r\ndev_priv->vram_size = mib * 1024 * 1024;\r\nreturn 0;\r\n}\r\nint\r\nnv10_fb_vram_init(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nu32 fifo_data = nv_rd32(dev, NV04_PFB_FIFO_DATA);\r\nu32 cfg0 = nv_rd32(dev, 0x100200);\r\ndev_priv->vram_size = fifo_data & NV10_PFB_FIFO_DATA_RAM_AMOUNT_MB_MASK;\r\nif (cfg0 & 0x00000001)\r\ndev_priv->vram_type = NV_MEM_TYPE_DDR1;\r\nelse\r\ndev_priv->vram_type = NV_MEM_TYPE_SDRAM;\r\nreturn 0;\r\n}\r\nint\r\nnv10_fb_init(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_fb_engine *pfb = &dev_priv->engine.fb;\r\nint i;\r\npfb->num_tiles = NV10_PFB_TILE__SIZE;\r\nfor (i = 0; i < pfb->num_tiles; i++)\r\npfb->set_tile_region(dev, i);\r\nreturn 0;\r\n}\r\nvoid\r\nnv10_fb_takedown(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_fb_engine *pfb = &dev_priv->engine.fb;\r\nint i;\r\nfor (i = 0; i < pfb->num_tiles; i++)\r\npfb->free_tile_region(dev, i);\r\n}

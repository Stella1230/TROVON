static int ltv350qv_write_reg(struct ltv350qv *lcd, u8 reg, u16 val)\r\n{\r\nstruct spi_message msg;\r\nstruct spi_transfer index_xfer = {\r\n.len = 3,\r\n.cs_change = 1,\r\n};\r\nstruct spi_transfer value_xfer = {\r\n.len = 3,\r\n};\r\nspi_message_init(&msg);\r\nlcd->buffer[0] = LTV_OPC_INDEX;\r\nlcd->buffer[1] = 0x00;\r\nlcd->buffer[2] = reg & 0x7f;\r\nindex_xfer.tx_buf = lcd->buffer;\r\nspi_message_add_tail(&index_xfer, &msg);\r\nlcd->buffer[4] = LTV_OPC_DATA;\r\nlcd->buffer[5] = val >> 8;\r\nlcd->buffer[6] = val;\r\nvalue_xfer.tx_buf = lcd->buffer + 4;\r\nspi_message_add_tail(&value_xfer, &msg);\r\nreturn spi_sync(lcd->spi, &msg);\r\n}\r\nstatic int ltv350qv_power_on(struct ltv350qv *lcd)\r\n{\r\nint ret;\r\nif (ltv350qv_write_reg(lcd, LTV_PWRCTL1, 0x0000))\r\ngoto err;\r\nmsleep(15);\r\nif (ltv350qv_write_reg(lcd, LTV_PWRCTL1, LTV_VCOM_DISABLE))\r\ngoto err;\r\nif (ltv350qv_write_reg(lcd, LTV_PWRCTL2, LTV_VCOML_ENABLE))\r\ngoto err_power1;\r\nif (ltv350qv_write_reg(lcd, LTV_PWRCTL1,\r\nLTV_VCOM_DISABLE | LTV_DRIVE_CURRENT(5)\r\n| LTV_SUPPLY_CURRENT(5)))\r\ngoto err_power2;\r\nmsleep(55);\r\nret = ltv350qv_write_reg(lcd, LTV_IFCTL,\r\nLTV_NMD | LTV_REV | LTV_NL(0x1d));\r\nret |= ltv350qv_write_reg(lcd, LTV_DATACTL,\r\nLTV_DS_SAME | LTV_CHS_480\r\n| LTV_DF_RGB | LTV_RGB_BGR);\r\nret |= ltv350qv_write_reg(lcd, LTV_ENTRY_MODE,\r\nLTV_VSPL_ACTIVE_LOW\r\n| LTV_HSPL_ACTIVE_LOW\r\n| LTV_DPL_SAMPLE_RISING\r\n| LTV_EPL_ACTIVE_LOW\r\n| LTV_SS_RIGHT_TO_LEFT);\r\nret |= ltv350qv_write_reg(lcd, LTV_GATECTL1, LTV_CLW(3));\r\nret |= ltv350qv_write_reg(lcd, LTV_GATECTL2,\r\nLTV_NW_INV_1LINE | LTV_FWI(3));\r\nret |= ltv350qv_write_reg(lcd, LTV_VBP, 0x000a);\r\nret |= ltv350qv_write_reg(lcd, LTV_HBP, 0x0021);\r\nret |= ltv350qv_write_reg(lcd, LTV_SOTCTL, LTV_SDT(3) | LTV_EQ(0));\r\nret |= ltv350qv_write_reg(lcd, LTV_GAMMA(0), 0x0103);\r\nret |= ltv350qv_write_reg(lcd, LTV_GAMMA(1), 0x0301);\r\nret |= ltv350qv_write_reg(lcd, LTV_GAMMA(2), 0x1f0f);\r\nret |= ltv350qv_write_reg(lcd, LTV_GAMMA(3), 0x1f0f);\r\nret |= ltv350qv_write_reg(lcd, LTV_GAMMA(4), 0x0707);\r\nret |= ltv350qv_write_reg(lcd, LTV_GAMMA(5), 0x0307);\r\nret |= ltv350qv_write_reg(lcd, LTV_GAMMA(6), 0x0707);\r\nret |= ltv350qv_write_reg(lcd, LTV_GAMMA(7), 0x0000);\r\nret |= ltv350qv_write_reg(lcd, LTV_GAMMA(8), 0x0004);\r\nret |= ltv350qv_write_reg(lcd, LTV_GAMMA(9), 0x0000);\r\nif (ret)\r\ngoto err_settings;\r\nmsleep(20);\r\nret = ltv350qv_write_reg(lcd, LTV_PWRCTL1,\r\nLTV_VCOM_DISABLE | LTV_VCOMOUT_ENABLE\r\n| LTV_POWER_ON | LTV_DRIVE_CURRENT(5)\r\n| LTV_SUPPLY_CURRENT(5));\r\nret |= ltv350qv_write_reg(lcd, LTV_GATECTL2,\r\nLTV_NW_INV_1LINE | LTV_DSC | LTV_FWI(3));\r\nif (ret)\r\ngoto err_disp_on;\r\nreturn 0;\r\nerr_disp_on:\r\nltv350qv_write_reg(lcd, LTV_PWRCTL1,\r\nLTV_VCOM_DISABLE | LTV_DRIVE_CURRENT(5)\r\n| LTV_SUPPLY_CURRENT(5));\r\nltv350qv_write_reg(lcd, LTV_GATECTL2,\r\nLTV_NW_INV_1LINE | LTV_FWI(3));\r\nerr_settings:\r\nerr_power2:\r\nerr_power1:\r\nltv350qv_write_reg(lcd, LTV_PWRCTL2, 0x0000);\r\nmsleep(1);\r\nerr:\r\nltv350qv_write_reg(lcd, LTV_PWRCTL1, LTV_VCOM_DISABLE);\r\nreturn -EIO;\r\n}\r\nstatic int ltv350qv_power_off(struct ltv350qv *lcd)\r\n{\r\nint ret;\r\nret = ltv350qv_write_reg(lcd, LTV_PWRCTL1,\r\nLTV_VCOM_DISABLE\r\n| LTV_DRIVE_CURRENT(5)\r\n| LTV_SUPPLY_CURRENT(5));\r\nret |= ltv350qv_write_reg(lcd, LTV_GATECTL2,\r\nLTV_NW_INV_1LINE | LTV_FWI(3));\r\nret |= ltv350qv_write_reg(lcd, LTV_PWRCTL2, 0x0000);\r\nmsleep(1);\r\nret |= ltv350qv_write_reg(lcd, LTV_PWRCTL1, LTV_VCOM_DISABLE);\r\nif (ret)\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic int ltv350qv_power(struct ltv350qv *lcd, int power)\r\n{\r\nint ret = 0;\r\nif (POWER_IS_ON(power) && !POWER_IS_ON(lcd->power))\r\nret = ltv350qv_power_on(lcd);\r\nelse if (!POWER_IS_ON(power) && POWER_IS_ON(lcd->power))\r\nret = ltv350qv_power_off(lcd);\r\nif (!ret)\r\nlcd->power = power;\r\nreturn ret;\r\n}\r\nstatic int ltv350qv_set_power(struct lcd_device *ld, int power)\r\n{\r\nstruct ltv350qv *lcd = lcd_get_data(ld);\r\nreturn ltv350qv_power(lcd, power);\r\n}\r\nstatic int ltv350qv_get_power(struct lcd_device *ld)\r\n{\r\nstruct ltv350qv *lcd = lcd_get_data(ld);\r\nreturn lcd->power;\r\n}\r\nstatic int __devinit ltv350qv_probe(struct spi_device *spi)\r\n{\r\nstruct ltv350qv *lcd;\r\nstruct lcd_device *ld;\r\nint ret;\r\nlcd = devm_kzalloc(&spi->dev, sizeof(struct ltv350qv), GFP_KERNEL);\r\nif (!lcd)\r\nreturn -ENOMEM;\r\nlcd->spi = spi;\r\nlcd->power = FB_BLANK_POWERDOWN;\r\nlcd->buffer = devm_kzalloc(&spi->dev, 8, GFP_KERNEL);\r\nif (!lcd->buffer)\r\nreturn -ENOMEM;\r\nld = lcd_device_register("ltv350qv", &spi->dev, lcd, &ltv_ops);\r\nif (IS_ERR(ld))\r\nreturn PTR_ERR(ld);\r\nlcd->ld = ld;\r\nret = ltv350qv_power(lcd, FB_BLANK_UNBLANK);\r\nif (ret)\r\ngoto out_unregister;\r\ndev_set_drvdata(&spi->dev, lcd);\r\nreturn 0;\r\nout_unregister:\r\nlcd_device_unregister(ld);\r\nreturn ret;\r\n}\r\nstatic int __devexit ltv350qv_remove(struct spi_device *spi)\r\n{\r\nstruct ltv350qv *lcd = dev_get_drvdata(&spi->dev);\r\nltv350qv_power(lcd, FB_BLANK_POWERDOWN);\r\nlcd_device_unregister(lcd->ld);\r\nreturn 0;\r\n}\r\nstatic int ltv350qv_suspend(struct spi_device *spi, pm_message_t state)\r\n{\r\nstruct ltv350qv *lcd = dev_get_drvdata(&spi->dev);\r\nreturn ltv350qv_power(lcd, FB_BLANK_POWERDOWN);\r\n}\r\nstatic int ltv350qv_resume(struct spi_device *spi)\r\n{\r\nstruct ltv350qv *lcd = dev_get_drvdata(&spi->dev);\r\nreturn ltv350qv_power(lcd, FB_BLANK_UNBLANK);\r\n}\r\nstatic void ltv350qv_shutdown(struct spi_device *spi)\r\n{\r\nstruct ltv350qv *lcd = dev_get_drvdata(&spi->dev);\r\nltv350qv_power(lcd, FB_BLANK_POWERDOWN);\r\n}

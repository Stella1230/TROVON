static inline bool check_lvds_chip(int device_id_subaddr, int device_id)\r\n{\r\nreturn lvds_register_read(device_id_subaddr) == device_id;\r\n}\r\nvoid __devinit viafb_init_lcd_size(void)\r\n{\r\nDEBUG_MSG(KERN_INFO "viafb_init_lcd_size()\n");\r\nfp_id_to_vindex(viafb_lcd_panel_id);\r\nviaparinfo->lvds_setting_info2->lcd_panel_hres =\r\nviaparinfo->lvds_setting_info->lcd_panel_hres;\r\nviaparinfo->lvds_setting_info2->lcd_panel_vres =\r\nviaparinfo->lvds_setting_info->lcd_panel_vres;\r\nviaparinfo->lvds_setting_info2->device_lcd_dualedge =\r\nviaparinfo->lvds_setting_info->device_lcd_dualedge;\r\nviaparinfo->lvds_setting_info2->LCDDithering =\r\nviaparinfo->lvds_setting_info->LCDDithering;\r\n}\r\nstatic bool lvds_identify_integratedlvds(void)\r\n{\r\nif (viafb_display_hardware_layout == HW_LAYOUT_LCD_EXTERNAL_LCD2) {\r\nif (viaparinfo->chip_info->lvds_chip_info.lvds_chip_name) {\r\nviaparinfo->chip_info->lvds_chip_info2.lvds_chip_name =\r\nINTEGRATED_LVDS;\r\nDEBUG_MSG(KERN_INFO "Support two dual channel LVDS! "\r\n"(Internal LVDS + External LVDS)\n");\r\n} else {\r\nviaparinfo->chip_info->lvds_chip_info.lvds_chip_name =\r\nINTEGRATED_LVDS;\r\nDEBUG_MSG(KERN_INFO "Not found external LVDS, "\r\n"so can't support two dual channel LVDS!\n");\r\n}\r\n} else if (viafb_display_hardware_layout == HW_LAYOUT_LCD1_LCD2) {\r\nviaparinfo->chip_info->lvds_chip_info.lvds_chip_name =\r\nINTEGRATED_LVDS;\r\nviaparinfo->chip_info->lvds_chip_info2.lvds_chip_name =\r\nINTEGRATED_LVDS;\r\nDEBUG_MSG(KERN_INFO "Support two single channel LVDS! "\r\n"(Internal LVDS + Internal LVDS)\n");\r\n} else if (viafb_display_hardware_layout != HW_LAYOUT_DVI_ONLY) {\r\nif (!viaparinfo->chip_info->lvds_chip_info.lvds_chip_name) {\r\nviaparinfo->chip_info->lvds_chip_info.lvds_chip_name =\r\nINTEGRATED_LVDS;\r\nDEBUG_MSG(KERN_INFO "Found Integrated LVDS!\n");\r\n}\r\n} else {\r\nviaparinfo->chip_info->lvds_chip_info.lvds_chip_name =\r\nNON_LVDS_TRANSMITTER;\r\nDEBUG_MSG(KERN_INFO "Do not support LVDS!\n");\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nbool __devinit viafb_lvds_trasmitter_identify(void)\r\n{\r\nif (viafb_lvds_identify_vt1636(VIA_PORT_31)) {\r\nviaparinfo->chip_info->lvds_chip_info.i2c_port = VIA_PORT_31;\r\nDEBUG_MSG(KERN_INFO\r\n"Found VIA VT1636 LVDS on port i2c 0x31\n");\r\n} else {\r\nif (viafb_lvds_identify_vt1636(VIA_PORT_2C)) {\r\nviaparinfo->chip_info->lvds_chip_info.i2c_port =\r\nVIA_PORT_2C;\r\nDEBUG_MSG(KERN_INFO\r\n"Found VIA VT1636 LVDS on port gpio 0x2c\n");\r\n}\r\n}\r\nif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_CX700)\r\nlvds_identify_integratedlvds();\r\nif (viaparinfo->chip_info->lvds_chip_info.lvds_chip_name)\r\nreturn true;\r\nviaparinfo->chip_info->lvds_chip_info.lvds_chip_name = VT1631_LVDS;\r\nviaparinfo->chip_info->lvds_chip_info.lvds_chip_slave_addr =\r\nVT1631_LVDS_I2C_ADDR;\r\nif (check_lvds_chip(VT1631_DEVICE_ID_REG, VT1631_DEVICE_ID)) {\r\nDEBUG_MSG(KERN_INFO "\n VT1631 LVDS ! \n");\r\nDEBUG_MSG(KERN_INFO "\n %2d",\r\nviaparinfo->chip_info->lvds_chip_info.lvds_chip_name);\r\nDEBUG_MSG(KERN_INFO "\n %2d",\r\nviaparinfo->chip_info->lvds_chip_info.lvds_chip_name);\r\nreturn true;\r\n}\r\nviaparinfo->chip_info->lvds_chip_info.lvds_chip_name =\r\nNON_LVDS_TRANSMITTER;\r\nviaparinfo->chip_info->lvds_chip_info.lvds_chip_slave_addr =\r\nVT1631_LVDS_I2C_ADDR;\r\nreturn false;\r\n}\r\nstatic void __devinit fp_id_to_vindex(int panel_id)\r\n{\r\nDEBUG_MSG(KERN_INFO "fp_get_panel_id()\n");\r\nif (panel_id > LCD_PANEL_ID_MAXIMUM)\r\nviafb_lcd_panel_id = panel_id =\r\nviafb_read_reg(VIACR, CR3F) & 0x0F;\r\nswitch (panel_id) {\r\ncase 0x0:\r\nviaparinfo->lvds_setting_info->lcd_panel_hres = 640;\r\nviaparinfo->lvds_setting_info->lcd_panel_vres = 480;\r\nviaparinfo->lvds_setting_info->device_lcd_dualedge = 0;\r\nviaparinfo->lvds_setting_info->LCDDithering = 1;\r\nbreak;\r\ncase 0x1:\r\nviaparinfo->lvds_setting_info->lcd_panel_hres = 800;\r\nviaparinfo->lvds_setting_info->lcd_panel_vres = 600;\r\nviaparinfo->lvds_setting_info->device_lcd_dualedge = 0;\r\nviaparinfo->lvds_setting_info->LCDDithering = 1;\r\nbreak;\r\ncase 0x2:\r\nviaparinfo->lvds_setting_info->lcd_panel_hres = 1024;\r\nviaparinfo->lvds_setting_info->lcd_panel_vres = 768;\r\nviaparinfo->lvds_setting_info->device_lcd_dualedge = 0;\r\nviaparinfo->lvds_setting_info->LCDDithering = 1;\r\nbreak;\r\ncase 0x3:\r\nviaparinfo->lvds_setting_info->lcd_panel_hres = 1280;\r\nviaparinfo->lvds_setting_info->lcd_panel_vres = 768;\r\nviaparinfo->lvds_setting_info->device_lcd_dualedge = 0;\r\nviaparinfo->lvds_setting_info->LCDDithering = 1;\r\nbreak;\r\ncase 0x4:\r\nviaparinfo->lvds_setting_info->lcd_panel_hres = 1280;\r\nviaparinfo->lvds_setting_info->lcd_panel_vres = 1024;\r\nviaparinfo->lvds_setting_info->device_lcd_dualedge = 1;\r\nviaparinfo->lvds_setting_info->LCDDithering = 1;\r\nbreak;\r\ncase 0x5:\r\nviaparinfo->lvds_setting_info->lcd_panel_hres = 1400;\r\nviaparinfo->lvds_setting_info->lcd_panel_vres = 1050;\r\nviaparinfo->lvds_setting_info->device_lcd_dualedge = 1;\r\nviaparinfo->lvds_setting_info->LCDDithering = 1;\r\nbreak;\r\ncase 0x6:\r\nviaparinfo->lvds_setting_info->lcd_panel_hres = 1600;\r\nviaparinfo->lvds_setting_info->lcd_panel_vres = 1200;\r\nviaparinfo->lvds_setting_info->device_lcd_dualedge = 1;\r\nviaparinfo->lvds_setting_info->LCDDithering = 1;\r\nbreak;\r\ncase 0x8:\r\nviaparinfo->lvds_setting_info->lcd_panel_hres = 800;\r\nviaparinfo->lvds_setting_info->lcd_panel_vres = 480;\r\nviaparinfo->lvds_setting_info->device_lcd_dualedge = 0;\r\nviaparinfo->lvds_setting_info->LCDDithering = 1;\r\nbreak;\r\ncase 0x9:\r\nviaparinfo->lvds_setting_info->lcd_panel_hres = 1024;\r\nviaparinfo->lvds_setting_info->lcd_panel_vres = 768;\r\nviaparinfo->lvds_setting_info->device_lcd_dualedge = 1;\r\nviaparinfo->lvds_setting_info->LCDDithering = 1;\r\nbreak;\r\ncase 0xA:\r\nviaparinfo->lvds_setting_info->lcd_panel_hres = 1024;\r\nviaparinfo->lvds_setting_info->lcd_panel_vres = 768;\r\nviaparinfo->lvds_setting_info->device_lcd_dualedge = 0;\r\nviaparinfo->lvds_setting_info->LCDDithering = 0;\r\nbreak;\r\ncase 0xB:\r\nviaparinfo->lvds_setting_info->lcd_panel_hres = 1024;\r\nviaparinfo->lvds_setting_info->lcd_panel_vres = 768;\r\nviaparinfo->lvds_setting_info->device_lcd_dualedge = 1;\r\nviaparinfo->lvds_setting_info->LCDDithering = 0;\r\nbreak;\r\ncase 0xC:\r\nviaparinfo->lvds_setting_info->lcd_panel_hres = 1280;\r\nviaparinfo->lvds_setting_info->lcd_panel_vres = 768;\r\nviaparinfo->lvds_setting_info->device_lcd_dualedge = 0;\r\nviaparinfo->lvds_setting_info->LCDDithering = 0;\r\nbreak;\r\ncase 0xD:\r\nviaparinfo->lvds_setting_info->lcd_panel_hres = 1280;\r\nviaparinfo->lvds_setting_info->lcd_panel_vres = 1024;\r\nviaparinfo->lvds_setting_info->device_lcd_dualedge = 1;\r\nviaparinfo->lvds_setting_info->LCDDithering = 0;\r\nbreak;\r\ncase 0xE:\r\nviaparinfo->lvds_setting_info->lcd_panel_hres = 1400;\r\nviaparinfo->lvds_setting_info->lcd_panel_vres = 1050;\r\nviaparinfo->lvds_setting_info->device_lcd_dualedge = 1;\r\nviaparinfo->lvds_setting_info->LCDDithering = 0;\r\nbreak;\r\ncase 0xF:\r\nviaparinfo->lvds_setting_info->lcd_panel_hres = 1600;\r\nviaparinfo->lvds_setting_info->lcd_panel_vres = 1200;\r\nviaparinfo->lvds_setting_info->device_lcd_dualedge = 1;\r\nviaparinfo->lvds_setting_info->LCDDithering = 0;\r\nbreak;\r\ncase 0x10:\r\nviaparinfo->lvds_setting_info->lcd_panel_hres = 1366;\r\nviaparinfo->lvds_setting_info->lcd_panel_vres = 768;\r\nviaparinfo->lvds_setting_info->device_lcd_dualedge = 0;\r\nviaparinfo->lvds_setting_info->LCDDithering = 0;\r\nbreak;\r\ncase 0x11:\r\nviaparinfo->lvds_setting_info->lcd_panel_hres = 1024;\r\nviaparinfo->lvds_setting_info->lcd_panel_vres = 600;\r\nviaparinfo->lvds_setting_info->device_lcd_dualedge = 0;\r\nviaparinfo->lvds_setting_info->LCDDithering = 1;\r\nbreak;\r\ncase 0x12:\r\nviaparinfo->lvds_setting_info->lcd_panel_hres = 1280;\r\nviaparinfo->lvds_setting_info->lcd_panel_vres = 768;\r\nviaparinfo->lvds_setting_info->device_lcd_dualedge = 1;\r\nviaparinfo->lvds_setting_info->LCDDithering = 1;\r\nbreak;\r\ncase 0x13:\r\nviaparinfo->lvds_setting_info->lcd_panel_hres = 1280;\r\nviaparinfo->lvds_setting_info->lcd_panel_vres = 800;\r\nviaparinfo->lvds_setting_info->device_lcd_dualedge = 0;\r\nviaparinfo->lvds_setting_info->LCDDithering = 1;\r\nbreak;\r\ncase 0x14:\r\nviaparinfo->lvds_setting_info->lcd_panel_hres = 1360;\r\nviaparinfo->lvds_setting_info->lcd_panel_vres = 768;\r\nviaparinfo->lvds_setting_info->device_lcd_dualedge = 0;\r\nviaparinfo->lvds_setting_info->LCDDithering = 0;\r\nbreak;\r\ncase 0x15:\r\nviaparinfo->lvds_setting_info->lcd_panel_hres = 1280;\r\nviaparinfo->lvds_setting_info->lcd_panel_vres = 768;\r\nviaparinfo->lvds_setting_info->device_lcd_dualedge = 1;\r\nviaparinfo->lvds_setting_info->LCDDithering = 0;\r\nbreak;\r\ncase 0x16:\r\nviaparinfo->lvds_setting_info->lcd_panel_hres = 480;\r\nviaparinfo->lvds_setting_info->lcd_panel_vres = 640;\r\nviaparinfo->lvds_setting_info->device_lcd_dualedge = 0;\r\nviaparinfo->lvds_setting_info->LCDDithering = 1;\r\nbreak;\r\ncase 0x17:\r\nviaparinfo->lvds_setting_info->lcd_panel_hres = 1200;\r\nviaparinfo->lvds_setting_info->lcd_panel_vres = 900;\r\nviaparinfo->lvds_setting_info->device_lcd_dualedge = 0;\r\nviaparinfo->lvds_setting_info->LCDDithering = 0;\r\nbreak;\r\ndefault:\r\nviaparinfo->lvds_setting_info->lcd_panel_hres = 800;\r\nviaparinfo->lvds_setting_info->lcd_panel_vres = 600;\r\nviaparinfo->lvds_setting_info->device_lcd_dualedge = 0;\r\nviaparinfo->lvds_setting_info->LCDDithering = 1;\r\n}\r\n}\r\nstatic int lvds_register_read(int index)\r\n{\r\nu8 data;\r\nviafb_i2c_readbyte(VIA_PORT_2C,\r\n(u8) viaparinfo->chip_info->lvds_chip_info.lvds_chip_slave_addr,\r\n(u8) index, &data);\r\nreturn data;\r\n}\r\nstatic void load_lcd_scaling(int set_hres, int set_vres, int panel_hres,\r\nint panel_vres)\r\n{\r\nint reg_value = 0;\r\nint viafb_load_reg_num;\r\nstruct io_register *reg = NULL;\r\nDEBUG_MSG(KERN_INFO "load_lcd_scaling()!!\n");\r\nviafb_write_reg_mask(CR79, VIACR, 0x07, BIT0 + BIT1 + BIT2);\r\nif (set_hres < panel_hres) {\r\nswitch (viaparinfo->chip_info->gfx_chip_name) {\r\ncase UNICHROME_CLE266:\r\ncase UNICHROME_K400:\r\nreg_value =\r\nCLE266_LCD_HOR_SCF_FORMULA(set_hres, panel_hres);\r\nviafb_load_reg_num =\r\nlcd_scaling_factor_CLE.lcd_hor_scaling_factor.\r\nreg_num;\r\nreg = lcd_scaling_factor_CLE.lcd_hor_scaling_factor.reg;\r\nviafb_load_reg(reg_value,\r\nviafb_load_reg_num, reg, VIACR);\r\nbreak;\r\ncase UNICHROME_K800:\r\ncase UNICHROME_PM800:\r\ncase UNICHROME_CN700:\r\ncase UNICHROME_CX700:\r\ncase UNICHROME_K8M890:\r\ncase UNICHROME_P4M890:\r\ncase UNICHROME_P4M900:\r\ncase UNICHROME_CN750:\r\ncase UNICHROME_VX800:\r\ncase UNICHROME_VX855:\r\ncase UNICHROME_VX900:\r\nreg_value =\r\nK800_LCD_HOR_SCF_FORMULA(set_hres, panel_hres);\r\nviafb_write_reg_mask(CRA2, VIACR, 0xC0, BIT7 + BIT6);\r\nviafb_load_reg_num =\r\nlcd_scaling_factor.lcd_hor_scaling_factor.reg_num;\r\nreg = lcd_scaling_factor.lcd_hor_scaling_factor.reg;\r\nviafb_load_reg(reg_value,\r\nviafb_load_reg_num, reg, VIACR);\r\nbreak;\r\n}\r\nDEBUG_MSG(KERN_INFO "Horizontal Scaling value = %d", reg_value);\r\n} else {\r\nviafb_write_reg_mask(CRA2, VIACR, 0x00, BIT7);\r\n}\r\nif (set_vres < panel_vres) {\r\nswitch (viaparinfo->chip_info->gfx_chip_name) {\r\ncase UNICHROME_CLE266:\r\ncase UNICHROME_K400:\r\nreg_value =\r\nCLE266_LCD_VER_SCF_FORMULA(set_vres, panel_vres);\r\nviafb_load_reg_num =\r\nlcd_scaling_factor_CLE.lcd_ver_scaling_factor.\r\nreg_num;\r\nreg = lcd_scaling_factor_CLE.lcd_ver_scaling_factor.reg;\r\nviafb_load_reg(reg_value,\r\nviafb_load_reg_num, reg, VIACR);\r\nbreak;\r\ncase UNICHROME_K800:\r\ncase UNICHROME_PM800:\r\ncase UNICHROME_CN700:\r\ncase UNICHROME_CX700:\r\ncase UNICHROME_K8M890:\r\ncase UNICHROME_P4M890:\r\ncase UNICHROME_P4M900:\r\ncase UNICHROME_CN750:\r\ncase UNICHROME_VX800:\r\ncase UNICHROME_VX855:\r\ncase UNICHROME_VX900:\r\nreg_value =\r\nK800_LCD_VER_SCF_FORMULA(set_vres, panel_vres);\r\nviafb_write_reg_mask(CRA2, VIACR, 0x08, BIT3);\r\nviafb_load_reg_num =\r\nlcd_scaling_factor.lcd_ver_scaling_factor.reg_num;\r\nreg = lcd_scaling_factor.lcd_ver_scaling_factor.reg;\r\nviafb_load_reg(reg_value,\r\nviafb_load_reg_num, reg, VIACR);\r\nbreak;\r\n}\r\nDEBUG_MSG(KERN_INFO "Vertical Scaling value = %d", reg_value);\r\n} else {\r\nviafb_write_reg_mask(CRA2, VIACR, 0x00, BIT3);\r\n}\r\n}\r\nstatic void via_pitch_alignment_patch_lcd(int iga_path, int hres, int bpp)\r\n{\r\nunsigned char cr13, cr35, cr65, cr66, cr67;\r\nunsigned long dwScreenPitch = 0;\r\nunsigned long dwPitch;\r\ndwPitch = hres * (bpp >> 3);\r\nif (dwPitch & 0x1F) {\r\ndwScreenPitch = ((dwPitch + 31) & ~31) >> 3;\r\nif (iga_path == IGA2) {\r\nif (bpp > 8) {\r\ncr66 = (unsigned char)(dwScreenPitch & 0xFF);\r\nviafb_write_reg(CR66, VIACR, cr66);\r\ncr67 = viafb_read_reg(VIACR, CR67) & 0xFC;\r\ncr67 |=\r\n(unsigned\r\nchar)((dwScreenPitch & 0x300) >> 8);\r\nviafb_write_reg(CR67, VIACR, cr67);\r\n}\r\ncr67 = viafb_read_reg(VIACR, CR67) & 0xF3;\r\ncr67 |= (unsigned char)((dwScreenPitch & 0x600) >> 7);\r\nviafb_write_reg(CR67, VIACR, cr67);\r\ncr65 = (unsigned char)((dwScreenPitch >> 1) & 0xFF);\r\ncr65 += 2;\r\nviafb_write_reg(CR65, VIACR, cr65);\r\n} else {\r\nif (bpp > 8) {\r\ncr13 = (unsigned char)(dwScreenPitch & 0xFF);\r\nviafb_write_reg(CR13, VIACR, cr13);\r\ncr35 = viafb_read_reg(VIACR, CR35) & 0x1F;\r\ncr35 |=\r\n(unsigned\r\nchar)((dwScreenPitch & 0x700) >> 3);\r\nviafb_write_reg(CR35, VIACR, cr35);\r\n}\r\n}\r\n}\r\n}\r\nstatic void lcd_patch_skew_dvp0(struct lvds_setting_information\r\n*plvds_setting_info,\r\nstruct lvds_chip_information *plvds_chip_info)\r\n{\r\nif (VT1636_LVDS == plvds_chip_info->lvds_chip_name) {\r\nswitch (viaparinfo->chip_info->gfx_chip_name) {\r\ncase UNICHROME_P4M900:\r\nviafb_vt1636_patch_skew_on_vt3364(plvds_setting_info,\r\nplvds_chip_info);\r\nbreak;\r\ncase UNICHROME_P4M890:\r\nviafb_vt1636_patch_skew_on_vt3327(plvds_setting_info,\r\nplvds_chip_info);\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void lcd_patch_skew_dvp1(struct lvds_setting_information\r\n*plvds_setting_info,\r\nstruct lvds_chip_information *plvds_chip_info)\r\n{\r\nif (VT1636_LVDS == plvds_chip_info->lvds_chip_name) {\r\nswitch (viaparinfo->chip_info->gfx_chip_name) {\r\ncase UNICHROME_CX700:\r\nviafb_vt1636_patch_skew_on_vt3324(plvds_setting_info,\r\nplvds_chip_info);\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void lcd_patch_skew(struct lvds_setting_information\r\n*plvds_setting_info, struct lvds_chip_information *plvds_chip_info)\r\n{\r\nDEBUG_MSG(KERN_INFO "lcd_patch_skew\n");\r\nswitch (plvds_chip_info->output_interface) {\r\ncase INTERFACE_DVP0:\r\nlcd_patch_skew_dvp0(plvds_setting_info, plvds_chip_info);\r\nbreak;\r\ncase INTERFACE_DVP1:\r\nlcd_patch_skew_dvp1(plvds_setting_info, plvds_chip_info);\r\nbreak;\r\ncase INTERFACE_DFP_LOW:\r\nif (UNICHROME_P4M900 == viaparinfo->chip_info->gfx_chip_name) {\r\nviafb_write_reg_mask(CR99, VIACR, 0x08,\r\nBIT0 + BIT1 + BIT2 + BIT3);\r\n}\r\nbreak;\r\n}\r\n}\r\nvoid viafb_lcd_set_mode(const struct fb_var_screeninfo *var, u16 cxres,\r\nu16 cyres, struct lvds_setting_information *plvds_setting_info,\r\nstruct lvds_chip_information *plvds_chip_info)\r\n{\r\nint set_iga = plvds_setting_info->iga_path;\r\nint mode_bpp = var->bits_per_pixel;\r\nint set_hres = cxres ? cxres : var->xres;\r\nint set_vres = cyres ? cyres : var->yres;\r\nint panel_hres = plvds_setting_info->lcd_panel_hres;\r\nint panel_vres = plvds_setting_info->lcd_panel_vres;\r\nu32 clock;\r\nstruct display_timing timing;\r\nstruct fb_var_screeninfo panel_var;\r\nconst struct fb_videomode *mode_crt_table, *panel_crt_table;\r\nDEBUG_MSG(KERN_INFO "viafb_lcd_set_mode!!\n");\r\nmode_crt_table = viafb_get_best_mode(set_hres, set_vres, 60);\r\npanel_crt_table = viafb_get_best_mode(panel_hres, panel_vres, 60);\r\nviafb_fill_var_timing_info(&panel_var, panel_crt_table);\r\nDEBUG_MSG(KERN_INFO "bellow viafb_lcd_set_mode!!\n");\r\nif (VT1636_LVDS == plvds_chip_info->lvds_chip_name)\r\nviafb_init_lvds_vt1636(plvds_setting_info, plvds_chip_info);\r\nclock = PICOS2KHZ(panel_crt_table->pixclock) * 1000;\r\nplvds_setting_info->vclk = clock;\r\nif (set_iga == IGA2 && (set_hres < panel_hres || set_vres < panel_vres)\r\n&& plvds_setting_info->display_method == LCD_EXPANDSION) {\r\ntiming = var_to_timing(&panel_var, panel_hres, panel_vres);\r\nload_lcd_scaling(set_hres, set_vres, panel_hres, panel_vres);\r\n} else {\r\ntiming = var_to_timing(&panel_var, set_hres, set_vres);\r\nif (set_iga == IGA2)\r\nvia_write_reg_mask(VIACR, 0x79, 0x00,\r\nBIT0 + BIT1 + BIT2);\r\n}\r\nif (set_iga == IGA1)\r\nvia_set_primary_timing(&timing);\r\nelse if (set_iga == IGA2)\r\nvia_set_secondary_timing(&timing);\r\nviafb_load_fetch_count_reg(set_hres, mode_bpp / 8, set_iga);\r\nif ((viaparinfo->chip_info->gfx_chip_name != UNICHROME_CLE266)\r\n&& (viaparinfo->chip_info->gfx_chip_name != UNICHROME_K400))\r\nviafb_load_FIFO_reg(set_iga, set_hres, set_vres);\r\nfill_lcd_format();\r\nviafb_set_vclock(clock, set_iga);\r\nlcd_patch_skew(plvds_setting_info, plvds_chip_info);\r\nif ((viaparinfo->chip_info->gfx_chip_name == UNICHROME_K800)\r\n|| (UNICHROME_K8M890 == viaparinfo->chip_info->gfx_chip_name))\r\nviafb_write_reg_mask(CR6A, VIACR, 0x01, BIT0);\r\nvia_pitch_alignment_patch_lcd(plvds_setting_info->iga_path, set_hres,\r\nvar->bits_per_pixel);\r\n}\r\nstatic void integrated_lvds_disable(struct lvds_setting_information\r\n*plvds_setting_info,\r\nstruct lvds_chip_information *plvds_chip_info)\r\n{\r\nbool turn_off_first_powersequence = false;\r\nbool turn_off_second_powersequence = false;\r\nif (INTERFACE_LVDS0LVDS1 == plvds_chip_info->output_interface)\r\nturn_off_first_powersequence = true;\r\nif (INTERFACE_LVDS0 == plvds_chip_info->output_interface)\r\nturn_off_first_powersequence = true;\r\nif (INTERFACE_LVDS1 == plvds_chip_info->output_interface)\r\nturn_off_second_powersequence = true;\r\nif (turn_off_second_powersequence) {\r\nviafb_write_reg_mask(CRD4, VIACR, 0, BIT1);\r\nviafb_write_reg_mask(CRD3, VIACR, 0xC0, BIT6 + BIT7);\r\n}\r\nif (turn_off_first_powersequence) {\r\nviafb_write_reg_mask(CR6A, VIACR, 0, BIT3);\r\nviafb_write_reg_mask(CR91, VIACR, 0xC0, BIT6 + BIT7);\r\n}\r\nswitch (plvds_chip_info->output_interface) {\r\ncase INTERFACE_LVDS0:\r\n{\r\nviafb_write_reg_mask(CRD2, VIACR, 0x80, BIT7);\r\nbreak;\r\n}\r\ncase INTERFACE_LVDS1:\r\n{\r\nviafb_write_reg_mask(CRD2, VIACR, 0x40, BIT6);\r\nbreak;\r\n}\r\ncase INTERFACE_LVDS0LVDS1:\r\n{\r\nviafb_write_reg_mask(CRD2, VIACR, 0xC0, BIT6 + BIT7);\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void integrated_lvds_enable(struct lvds_setting_information\r\n*plvds_setting_info,\r\nstruct lvds_chip_information *plvds_chip_info)\r\n{\r\nDEBUG_MSG(KERN_INFO "integrated_lvds_enable, out_interface:%d\n",\r\nplvds_chip_info->output_interface);\r\nif (plvds_setting_info->lcd_mode == LCD_SPWG)\r\nviafb_write_reg_mask(CRD2, VIACR, 0x00, BIT0 + BIT1);\r\nelse\r\nviafb_write_reg_mask(CRD2, VIACR, 0x03, BIT0 + BIT1);\r\nswitch (plvds_chip_info->output_interface) {\r\ncase INTERFACE_LVDS0LVDS1:\r\ncase INTERFACE_LVDS0:\r\nviafb_write_reg_mask(CR91, VIACR, 0, BIT0);\r\nviafb_write_reg_mask(CR91, VIACR, 0, BIT6 + BIT7);\r\nviafb_write_reg_mask(CR6A, VIACR, 0x08, BIT3);\r\nbreak;\r\ncase INTERFACE_LVDS1:\r\nviafb_write_reg_mask(CRD3, VIACR, 0, BIT0);\r\nviafb_write_reg_mask(CRD3, VIACR, 0, BIT6 + BIT7);\r\nviafb_write_reg_mask(CRD4, VIACR, 0x02, BIT1);\r\nbreak;\r\n}\r\nswitch (plvds_chip_info->output_interface) {\r\ncase INTERFACE_LVDS0:\r\n{\r\nviafb_write_reg_mask(CRD2, VIACR, 0, BIT7);\r\nbreak;\r\n}\r\ncase INTERFACE_LVDS1:\r\n{\r\nviafb_write_reg_mask(CRD2, VIACR, 0, BIT6);\r\nbreak;\r\n}\r\ncase INTERFACE_LVDS0LVDS1:\r\n{\r\nviafb_write_reg_mask(CRD2, VIACR, 0, BIT6 + BIT7);\r\nbreak;\r\n}\r\n}\r\n}\r\nvoid viafb_lcd_disable(void)\r\n{\r\nif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_CLE266) {\r\nlcd_powersequence_off();\r\nviafb_write_reg_mask(SR1E, VIASR, 0x00, 0x30);\r\n} else if (viaparinfo->chip_info->gfx_chip_name == UNICHROME_CX700) {\r\nif (viafb_LCD2_ON\r\n&& (INTEGRATED_LVDS ==\r\nviaparinfo->chip_info->lvds_chip_info2.lvds_chip_name))\r\nintegrated_lvds_disable(viaparinfo->lvds_setting_info,\r\n&viaparinfo->chip_info->lvds_chip_info2);\r\nif (INTEGRATED_LVDS ==\r\nviaparinfo->chip_info->lvds_chip_info.lvds_chip_name)\r\nintegrated_lvds_disable(viaparinfo->lvds_setting_info,\r\n&viaparinfo->chip_info->lvds_chip_info);\r\nif (VT1636_LVDS == viaparinfo->chip_info->\r\nlvds_chip_info.lvds_chip_name)\r\nviafb_disable_lvds_vt1636(viaparinfo->lvds_setting_info,\r\n&viaparinfo->chip_info->lvds_chip_info);\r\n} else if (VT1636_LVDS ==\r\nviaparinfo->chip_info->lvds_chip_info.lvds_chip_name) {\r\nviafb_disable_lvds_vt1636(viaparinfo->lvds_setting_info,\r\n&viaparinfo->chip_info->lvds_chip_info);\r\n} else {\r\nviafb_write_reg_mask(SR3D, VIASR, 0x00, 0x20);\r\nviafb_write_reg_mask(CR91, VIACR, 0x80, 0x80);\r\n}\r\nviafb_write_reg_mask(CR79, VIACR, 0x00, 0x01);\r\nviafb_write_reg_mask(CR6B, VIACR, 0x00, 0x08);\r\n}\r\nstatic void set_lcd_output_path(int set_iga, int output_interface)\r\n{\r\nswitch (output_interface) {\r\ncase INTERFACE_DFP:\r\nif ((UNICHROME_K8M890 == viaparinfo->chip_info->gfx_chip_name)\r\n|| (UNICHROME_P4M890 ==\r\nviaparinfo->chip_info->gfx_chip_name))\r\nviafb_write_reg_mask(CR97, VIACR, 0x84,\r\nBIT7 + BIT2 + BIT1 + BIT0);\r\ncase INTERFACE_DVP0:\r\ncase INTERFACE_DVP1:\r\ncase INTERFACE_DFP_HIGH:\r\ncase INTERFACE_DFP_LOW:\r\nif (set_iga == IGA2)\r\nviafb_write_reg(CR91, VIACR, 0x00);\r\nbreak;\r\n}\r\n}\r\nvoid viafb_lcd_enable(void)\r\n{\r\nviafb_write_reg_mask(CR6B, VIACR, 0x00, BIT3);\r\nviafb_write_reg_mask(CR6A, VIACR, 0x08, BIT3);\r\nset_lcd_output_path(viaparinfo->lvds_setting_info->iga_path,\r\nviaparinfo->chip_info->lvds_chip_info.output_interface);\r\nif (viafb_LCD2_ON)\r\nset_lcd_output_path(viaparinfo->lvds_setting_info2->iga_path,\r\nviaparinfo->chip_info->\r\nlvds_chip_info2.output_interface);\r\nif (viaparinfo->chip_info->gfx_chip_name == UNICHROME_CLE266) {\r\nviafb_write_reg_mask(SR1E, VIASR, 0x30, 0x30);\r\nlcd_powersequence_on();\r\n} else if (viaparinfo->chip_info->gfx_chip_name == UNICHROME_CX700) {\r\nif (viafb_LCD2_ON && (INTEGRATED_LVDS ==\r\nviaparinfo->chip_info->lvds_chip_info2.lvds_chip_name))\r\nintegrated_lvds_enable(viaparinfo->lvds_setting_info2, \\r\n&viaparinfo->chip_info->lvds_chip_info2);\r\nif (INTEGRATED_LVDS ==\r\nviaparinfo->chip_info->lvds_chip_info.lvds_chip_name)\r\nintegrated_lvds_enable(viaparinfo->lvds_setting_info,\r\n&viaparinfo->chip_info->lvds_chip_info);\r\nif (VT1636_LVDS == viaparinfo->chip_info->\r\nlvds_chip_info.lvds_chip_name)\r\nviafb_enable_lvds_vt1636(viaparinfo->\r\nlvds_setting_info, &viaparinfo->chip_info->\r\nlvds_chip_info);\r\n} else if (VT1636_LVDS ==\r\nviaparinfo->chip_info->lvds_chip_info.lvds_chip_name) {\r\nviafb_enable_lvds_vt1636(viaparinfo->lvds_setting_info,\r\n&viaparinfo->chip_info->lvds_chip_info);\r\n} else {\r\nviafb_write_reg_mask(SR3D, VIASR, 0x20, 0x20);\r\nviafb_write_reg_mask(CR91, VIACR, 0x00, 0x80);\r\nviafb_write_reg_mask(CR6A, VIACR, 0x48, 0x48);\r\n}\r\n}\r\nstatic void lcd_powersequence_off(void)\r\n{\r\nint i, mask, data;\r\nviafb_write_reg_mask(CR91, VIACR, 0x11, 0x11);\r\nfor (i = 0; i < 3; i++) {\r\nmask = PowerSequenceOff[0][i];\r\ndata = PowerSequenceOff[1][i] & mask;\r\nviafb_write_reg_mask(CR91, VIACR, (u8) data, (u8) mask);\r\nudelay(PowerSequenceOff[2][i]);\r\n}\r\nviafb_write_reg_mask(CR6A, VIACR, 0x00, 0x08);\r\n}\r\nstatic void lcd_powersequence_on(void)\r\n{\r\nint i, mask, data;\r\nviafb_write_reg_mask(CR91, VIACR, 0x11, 0x11);\r\nviafb_write_reg_mask(CR6A, VIACR, 0x08, 0x08);\r\nfor (i = 0; i < 3; i++) {\r\nmask = PowerSequenceOn[0][i];\r\ndata = PowerSequenceOn[1][i] & mask;\r\nviafb_write_reg_mask(CR91, VIACR, (u8) data, (u8) mask);\r\nudelay(PowerSequenceOn[2][i]);\r\n}\r\nudelay(1);\r\n}\r\nstatic void fill_lcd_format(void)\r\n{\r\nu8 bdithering = 0, bdual = 0;\r\nif (viaparinfo->lvds_setting_info->device_lcd_dualedge)\r\nbdual = BIT4;\r\nif (viaparinfo->lvds_setting_info->LCDDithering)\r\nbdithering = BIT0;\r\nviafb_write_reg_mask(CR88, VIACR, (bdithering | bdual), BIT4 + BIT0);\r\n}\r\nstatic void check_diport_of_integrated_lvds(\r\nstruct lvds_chip_information *plvds_chip_info,\r\nstruct lvds_setting_information\r\n*plvds_setting_info)\r\n{\r\nswitch (viafb_display_hardware_layout) {\r\ncase HW_LAYOUT_LCD_ONLY:\r\n{\r\nif (plvds_setting_info->device_lcd_dualedge) {\r\nplvds_chip_info->output_interface =\r\nINTERFACE_LVDS0LVDS1;\r\n} else {\r\nplvds_chip_info->output_interface =\r\nINTERFACE_LVDS0;\r\n}\r\nbreak;\r\n}\r\ncase HW_LAYOUT_DVI_ONLY:\r\n{\r\nplvds_chip_info->output_interface = INTERFACE_NONE;\r\nbreak;\r\n}\r\ncase HW_LAYOUT_LCD1_LCD2:\r\ncase HW_LAYOUT_LCD_EXTERNAL_LCD2:\r\n{\r\nplvds_chip_info->output_interface =\r\nINTERFACE_LVDS0LVDS1;\r\nbreak;\r\n}\r\ncase HW_LAYOUT_LCD_DVI:\r\n{\r\nplvds_chip_info->output_interface = INTERFACE_LVDS1;\r\nbreak;\r\n}\r\ndefault:\r\n{\r\nplvds_chip_info->output_interface = INTERFACE_LVDS1;\r\nbreak;\r\n}\r\n}\r\nDEBUG_MSG(KERN_INFO\r\n"Display Hardware Layout: 0x%x, LCD DI Port: 0x%x\n",\r\nviafb_display_hardware_layout,\r\nplvds_chip_info->output_interface);\r\n}\r\nvoid __devinit viafb_init_lvds_output_interface(struct lvds_chip_information\r\n*plvds_chip_info,\r\nstruct lvds_setting_information\r\n*plvds_setting_info)\r\n{\r\nif (INTERFACE_NONE != plvds_chip_info->output_interface) {\r\nreturn;\r\n}\r\nswitch (plvds_chip_info->lvds_chip_name) {\r\ncase VT1636_LVDS:\r\nswitch (viaparinfo->chip_info->gfx_chip_name) {\r\ncase UNICHROME_CX700:\r\nplvds_chip_info->output_interface = INTERFACE_DVP1;\r\nbreak;\r\ncase UNICHROME_CN700:\r\nplvds_chip_info->output_interface = INTERFACE_DFP_LOW;\r\nbreak;\r\ndefault:\r\nplvds_chip_info->output_interface = INTERFACE_DVP0;\r\nbreak;\r\n}\r\nbreak;\r\ncase INTEGRATED_LVDS:\r\ncheck_diport_of_integrated_lvds(plvds_chip_info,\r\nplvds_setting_info);\r\nbreak;\r\ndefault:\r\nswitch (viaparinfo->chip_info->gfx_chip_name) {\r\ncase UNICHROME_K8M890:\r\ncase UNICHROME_P4M900:\r\ncase UNICHROME_P4M890:\r\nplvds_chip_info->output_interface = INTERFACE_DFP_LOW;\r\nbreak;\r\ndefault:\r\nplvds_chip_info->output_interface = INTERFACE_DFP;\r\nbreak;\r\n}\r\nbreak;\r\n}\r\n}\r\nbool viafb_lcd_get_mobile_state(bool *mobile)\r\n{\r\nunsigned char __iomem *romptr, *tableptr, *biosptr;\r\nu8 core_base;\r\nconst u32 romaddr = 0x000C0000;\r\nu16 start_pattern;\r\nbiosptr = ioremap(romaddr, 0x10000);\r\nstart_pattern = readw(biosptr);\r\nif (start_pattern == 0xAA55) {\r\nromptr = biosptr + 0x1B;\r\ntableptr = biosptr + readw(romptr);\r\nromptr = tableptr + 18;\r\nromptr = biosptr + readw(romptr);\r\nromptr += 41;\r\ncore_base = readb(romptr);\r\nif (core_base & 0x8)\r\n*mobile = false;\r\nelse\r\n*mobile = true;\r\niounmap(biosptr);\r\nreturn true;\r\n} else {\r\niounmap(biosptr);\r\nreturn false;\r\n}\r\n}

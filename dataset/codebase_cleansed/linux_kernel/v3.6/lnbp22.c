static int lnbp22_set_voltage(struct dvb_frontend *fe, fe_sec_voltage_t voltage)\r\n{\r\nstruct lnbp22 *lnbp22 = (struct lnbp22 *)fe->sec_priv;\r\nstruct i2c_msg msg = {\r\n.addr = 0x08,\r\n.flags = 0,\r\n.buf = (char *)&lnbp22->config,\r\n.len = sizeof(lnbp22->config),\r\n};\r\ndprintk(1, "%s: %d (18V=%d 13V=%d)\n", __func__, voltage,\r\nSEC_VOLTAGE_18, SEC_VOLTAGE_13);\r\nlnbp22->config[3] = 0x60;\r\nswitch (voltage) {\r\ncase SEC_VOLTAGE_OFF:\r\nbreak;\r\ncase SEC_VOLTAGE_13:\r\nlnbp22->config[3] |= LNBP22_EN;\r\nbreak;\r\ncase SEC_VOLTAGE_18:\r\nlnbp22->config[3] |= (LNBP22_EN | LNBP22_VSEL);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n};\r\ndprintk(1, "%s: 0x%02x)\n", __func__, lnbp22->config[3]);\r\nreturn (i2c_transfer(lnbp22->i2c, &msg, 1) == 1) ? 0 : -EIO;\r\n}\r\nstatic int lnbp22_enable_high_lnb_voltage(struct dvb_frontend *fe, long arg)\r\n{\r\nstruct lnbp22 *lnbp22 = (struct lnbp22 *) fe->sec_priv;\r\nstruct i2c_msg msg = {\r\n.addr = 0x08,\r\n.flags = 0,\r\n.buf = (char *)&lnbp22->config,\r\n.len = sizeof(lnbp22->config),\r\n};\r\ndprintk(1, "%s: %d\n", __func__, (int)arg);\r\nif (arg)\r\nlnbp22->config[3] |= LNBP22_LLC;\r\nelse\r\nlnbp22->config[3] &= ~LNBP22_LLC;\r\nreturn (i2c_transfer(lnbp22->i2c, &msg, 1) == 1) ? 0 : -EIO;\r\n}\r\nstatic void lnbp22_release(struct dvb_frontend *fe)\r\n{\r\ndprintk(1, "%s\n", __func__);\r\nlnbp22_set_voltage(fe, SEC_VOLTAGE_OFF);\r\nkfree(fe->sec_priv);\r\nfe->sec_priv = NULL;\r\n}\r\nstruct dvb_frontend *lnbp22_attach(struct dvb_frontend *fe,\r\nstruct i2c_adapter *i2c)\r\n{\r\nstruct lnbp22 *lnbp22 = kmalloc(sizeof(struct lnbp22), GFP_KERNEL);\r\nif (!lnbp22)\r\nreturn NULL;\r\nlnbp22->config[0] = 0x00;\r\nlnbp22->config[1] = 0x28;\r\nlnbp22->config[2] = 0x48;\r\nlnbp22->config[3] = 0x60;\r\nlnbp22->i2c = i2c;\r\nfe->sec_priv = lnbp22;\r\nif (lnbp22_set_voltage(fe, SEC_VOLTAGE_OFF)) {\r\ndprintk(0, "%s LNBP22 not found\n", __func__);\r\nkfree(lnbp22);\r\nfe->sec_priv = NULL;\r\nreturn NULL;\r\n}\r\nfe->ops.release_sec = lnbp22_release;\r\nfe->ops.set_voltage = lnbp22_set_voltage;\r\nfe->ops.enable_high_lnb_voltage = lnbp22_enable_high_lnb_voltage;\r\nreturn fe;\r\n}

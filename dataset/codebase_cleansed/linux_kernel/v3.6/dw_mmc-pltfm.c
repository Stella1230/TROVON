static int dw_mci_pltfm_probe(struct platform_device *pdev)\r\n{\r\nstruct dw_mci *host;\r\nstruct resource *regs;\r\nint ret;\r\nhost = kzalloc(sizeof(struct dw_mci), GFP_KERNEL);\r\nif (!host)\r\nreturn -ENOMEM;\r\nregs = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!regs) {\r\nret = -ENXIO;\r\ngoto err_free;\r\n}\r\nhost->irq = platform_get_irq(pdev, 0);\r\nif (host->irq < 0) {\r\nret = host->irq;\r\ngoto err_free;\r\n}\r\nhost->dev = pdev->dev;\r\nhost->irq_flags = 0;\r\nhost->pdata = pdev->dev.platform_data;\r\nret = -ENOMEM;\r\nhost->regs = ioremap(regs->start, resource_size(regs));\r\nif (!host->regs)\r\ngoto err_free;\r\nplatform_set_drvdata(pdev, host);\r\nret = dw_mci_probe(host);\r\nif (ret)\r\ngoto err_out;\r\nreturn ret;\r\nerr_out:\r\niounmap(host->regs);\r\nerr_free:\r\nkfree(host);\r\nreturn ret;\r\n}\r\nstatic int __exit dw_mci_pltfm_remove(struct platform_device *pdev)\r\n{\r\nstruct dw_mci *host = platform_get_drvdata(pdev);\r\nplatform_set_drvdata(pdev, NULL);\r\ndw_mci_remove(host);\r\niounmap(host->regs);\r\nkfree(host);\r\nreturn 0;\r\n}\r\nstatic int dw_mci_pltfm_suspend(struct device *dev)\r\n{\r\nint ret;\r\nstruct dw_mci *host = dev_get_drvdata(dev);\r\nret = dw_mci_suspend(host);\r\nif (ret)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int dw_mci_pltfm_resume(struct device *dev)\r\n{\r\nint ret;\r\nstruct dw_mci *host = dev_get_drvdata(dev);\r\nret = dw_mci_resume(host);\r\nif (ret)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int __init dw_mci_init(void)\r\n{\r\nreturn platform_driver_probe(&dw_mci_pltfm_driver, dw_mci_pltfm_probe);\r\n}\r\nstatic void __exit dw_mci_exit(void)\r\n{\r\nplatform_driver_unregister(&dw_mci_pltfm_driver);\r\n}

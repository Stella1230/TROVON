static irqreturn_t powerbutton_irq(int irq, void *_pwr)\r\n{\r\nstruct input_dev *pwr = _pwr;\r\nint err;\r\nu8 value;\r\nerr = twl_i2c_read_u8(TWL4030_MODULE_PM_MASTER, &value,\r\nSTS_HW_CONDITIONS);\r\nif (!err) {\r\ninput_report_key(pwr, KEY_POWER, value & PWR_PWRON_IRQ);\r\ninput_sync(pwr);\r\n} else {\r\ndev_err(pwr->dev.parent, "twl4030: i2c error %d while reading"\r\n" TWL4030 PM_MASTER STS_HW_CONDITIONS register\n", err);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __init twl4030_pwrbutton_probe(struct platform_device *pdev)\r\n{\r\nstruct input_dev *pwr;\r\nint irq = platform_get_irq(pdev, 0);\r\nint err;\r\npwr = input_allocate_device();\r\nif (!pwr) {\r\ndev_dbg(&pdev->dev, "Can't allocate power button\n");\r\nreturn -ENOMEM;\r\n}\r\npwr->evbit[0] = BIT_MASK(EV_KEY);\r\npwr->keybit[BIT_WORD(KEY_POWER)] = BIT_MASK(KEY_POWER);\r\npwr->name = "twl4030_pwrbutton";\r\npwr->phys = "twl4030_pwrbutton/input0";\r\npwr->dev.parent = &pdev->dev;\r\nerr = request_threaded_irq(irq, NULL, powerbutton_irq,\r\nIRQF_TRIGGER_FALLING | IRQF_TRIGGER_RISING,\r\n"twl4030_pwrbutton", pwr);\r\nif (err < 0) {\r\ndev_dbg(&pdev->dev, "Can't get IRQ for pwrbutton: %d\n", err);\r\ngoto free_input_dev;\r\n}\r\nerr = input_register_device(pwr);\r\nif (err) {\r\ndev_dbg(&pdev->dev, "Can't register power button: %d\n", err);\r\ngoto free_irq;\r\n}\r\nplatform_set_drvdata(pdev, pwr);\r\nreturn 0;\r\nfree_irq:\r\nfree_irq(irq, pwr);\r\nfree_input_dev:\r\ninput_free_device(pwr);\r\nreturn err;\r\n}\r\nstatic int __exit twl4030_pwrbutton_remove(struct platform_device *pdev)\r\n{\r\nstruct input_dev *pwr = platform_get_drvdata(pdev);\r\nint irq = platform_get_irq(pdev, 0);\r\nfree_irq(irq, pwr);\r\ninput_unregister_device(pwr);\r\nreturn 0;\r\n}\r\nstatic int __init twl4030_pwrbutton_init(void)\r\n{\r\nreturn platform_driver_probe(&twl4030_pwrbutton_driver,\r\ntwl4030_pwrbutton_probe);\r\n}\r\nstatic void __exit twl4030_pwrbutton_exit(void)\r\n{\r\nplatform_driver_unregister(&twl4030_pwrbutton_driver);\r\n}

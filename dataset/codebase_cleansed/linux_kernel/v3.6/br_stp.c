void br_log_state(const struct net_bridge_port *p)\r\n{\r\nbr_info(p->br, "port %u(%s) entered %s state\n",\r\n(unsigned int) p->port_no, p->dev->name,\r\nbr_port_state_names[p->state]);\r\n}\r\nstruct net_bridge_port *br_get_port(struct net_bridge *br, u16 port_no)\r\n{\r\nstruct net_bridge_port *p;\r\nlist_for_each_entry_rcu(p, &br->port_list, list) {\r\nif (p->port_no == port_no)\r\nreturn p;\r\n}\r\nreturn NULL;\r\n}\r\nstatic int br_should_become_root_port(const struct net_bridge_port *p,\r\nu16 root_port)\r\n{\r\nstruct net_bridge *br;\r\nstruct net_bridge_port *rp;\r\nint t;\r\nbr = p->br;\r\nif (p->state == BR_STATE_DISABLED ||\r\nbr_is_designated_port(p))\r\nreturn 0;\r\nif (memcmp(&br->bridge_id, &p->designated_root, 8) <= 0)\r\nreturn 0;\r\nif (!root_port)\r\nreturn 1;\r\nrp = br_get_port(br, root_port);\r\nt = memcmp(&p->designated_root, &rp->designated_root, 8);\r\nif (t < 0)\r\nreturn 1;\r\nelse if (t > 0)\r\nreturn 0;\r\nif (p->designated_cost + p->path_cost <\r\nrp->designated_cost + rp->path_cost)\r\nreturn 1;\r\nelse if (p->designated_cost + p->path_cost >\r\nrp->designated_cost + rp->path_cost)\r\nreturn 0;\r\nt = memcmp(&p->designated_bridge, &rp->designated_bridge, 8);\r\nif (t < 0)\r\nreturn 1;\r\nelse if (t > 0)\r\nreturn 0;\r\nif (p->designated_port < rp->designated_port)\r\nreturn 1;\r\nelse if (p->designated_port > rp->designated_port)\r\nreturn 0;\r\nif (p->port_id < rp->port_id)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic void br_root_selection(struct net_bridge *br)\r\n{\r\nstruct net_bridge_port *p;\r\nu16 root_port = 0;\r\nlist_for_each_entry(p, &br->port_list, list) {\r\nif (br_should_become_root_port(p, root_port))\r\nroot_port = p->port_no;\r\n}\r\nbr->root_port = root_port;\r\nif (!root_port) {\r\nbr->designated_root = br->bridge_id;\r\nbr->root_path_cost = 0;\r\n} else {\r\np = br_get_port(br, root_port);\r\nbr->designated_root = p->designated_root;\r\nbr->root_path_cost = p->designated_cost + p->path_cost;\r\n}\r\n}\r\nvoid br_become_root_bridge(struct net_bridge *br)\r\n{\r\nbr->max_age = br->bridge_max_age;\r\nbr->hello_time = br->bridge_hello_time;\r\nbr->forward_delay = br->bridge_forward_delay;\r\nbr_topology_change_detection(br);\r\ndel_timer(&br->tcn_timer);\r\nif (br->dev->flags & IFF_UP) {\r\nbr_config_bpdu_generation(br);\r\nmod_timer(&br->hello_timer, jiffies + br->hello_time);\r\n}\r\n}\r\nvoid br_transmit_config(struct net_bridge_port *p)\r\n{\r\nstruct br_config_bpdu bpdu;\r\nstruct net_bridge *br;\r\nif (timer_pending(&p->hold_timer)) {\r\np->config_pending = 1;\r\nreturn;\r\n}\r\nbr = p->br;\r\nbpdu.topology_change = br->topology_change;\r\nbpdu.topology_change_ack = p->topology_change_ack;\r\nbpdu.root = br->designated_root;\r\nbpdu.root_path_cost = br->root_path_cost;\r\nbpdu.bridge_id = br->bridge_id;\r\nbpdu.port_id = p->port_id;\r\nif (br_is_root_bridge(br))\r\nbpdu.message_age = 0;\r\nelse {\r\nstruct net_bridge_port *root\r\n= br_get_port(br, br->root_port);\r\nbpdu.message_age = (jiffies - root->designated_age)\r\n+ MESSAGE_AGE_INCR;\r\n}\r\nbpdu.max_age = br->max_age;\r\nbpdu.hello_time = br->hello_time;\r\nbpdu.forward_delay = br->forward_delay;\r\nif (bpdu.message_age < br->max_age) {\r\nbr_send_config_bpdu(p, &bpdu);\r\np->topology_change_ack = 0;\r\np->config_pending = 0;\r\nmod_timer(&p->hold_timer,\r\nround_jiffies(jiffies + BR_HOLD_TIME));\r\n}\r\n}\r\nstatic void br_record_config_information(struct net_bridge_port *p,\r\nconst struct br_config_bpdu *bpdu)\r\n{\r\np->designated_root = bpdu->root;\r\np->designated_cost = bpdu->root_path_cost;\r\np->designated_bridge = bpdu->bridge_id;\r\np->designated_port = bpdu->port_id;\r\np->designated_age = jiffies - bpdu->message_age;\r\nmod_timer(&p->message_age_timer, jiffies\r\n+ (p->br->max_age - bpdu->message_age));\r\n}\r\nstatic void br_record_config_timeout_values(struct net_bridge *br,\r\nconst struct br_config_bpdu *bpdu)\r\n{\r\nbr->max_age = bpdu->max_age;\r\nbr->hello_time = bpdu->hello_time;\r\nbr->forward_delay = bpdu->forward_delay;\r\nbr->topology_change = bpdu->topology_change;\r\n}\r\nvoid br_transmit_tcn(struct net_bridge *br)\r\n{\r\nbr_send_tcn_bpdu(br_get_port(br, br->root_port));\r\n}\r\nstatic int br_should_become_designated_port(const struct net_bridge_port *p)\r\n{\r\nstruct net_bridge *br;\r\nint t;\r\nbr = p->br;\r\nif (br_is_designated_port(p))\r\nreturn 1;\r\nif (memcmp(&p->designated_root, &br->designated_root, 8))\r\nreturn 1;\r\nif (br->root_path_cost < p->designated_cost)\r\nreturn 1;\r\nelse if (br->root_path_cost > p->designated_cost)\r\nreturn 0;\r\nt = memcmp(&br->bridge_id, &p->designated_bridge, 8);\r\nif (t < 0)\r\nreturn 1;\r\nelse if (t > 0)\r\nreturn 0;\r\nif (p->port_id < p->designated_port)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic void br_designated_port_selection(struct net_bridge *br)\r\n{\r\nstruct net_bridge_port *p;\r\nlist_for_each_entry(p, &br->port_list, list) {\r\nif (p->state != BR_STATE_DISABLED &&\r\nbr_should_become_designated_port(p))\r\nbr_become_designated_port(p);\r\n}\r\n}\r\nstatic int br_supersedes_port_info(const struct net_bridge_port *p,\r\nconst struct br_config_bpdu *bpdu)\r\n{\r\nint t;\r\nt = memcmp(&bpdu->root, &p->designated_root, 8);\r\nif (t < 0)\r\nreturn 1;\r\nelse if (t > 0)\r\nreturn 0;\r\nif (bpdu->root_path_cost < p->designated_cost)\r\nreturn 1;\r\nelse if (bpdu->root_path_cost > p->designated_cost)\r\nreturn 0;\r\nt = memcmp(&bpdu->bridge_id, &p->designated_bridge, 8);\r\nif (t < 0)\r\nreturn 1;\r\nelse if (t > 0)\r\nreturn 0;\r\nif (memcmp(&bpdu->bridge_id, &p->br->bridge_id, 8))\r\nreturn 1;\r\nif (bpdu->port_id <= p->designated_port)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic void br_topology_change_acknowledged(struct net_bridge *br)\r\n{\r\nbr->topology_change_detected = 0;\r\ndel_timer(&br->tcn_timer);\r\n}\r\nvoid br_topology_change_detection(struct net_bridge *br)\r\n{\r\nint isroot = br_is_root_bridge(br);\r\nif (br->stp_enabled != BR_KERNEL_STP)\r\nreturn;\r\nbr_info(br, "topology change detected, %s\n",\r\nisroot ? "propagating" : "sending tcn bpdu");\r\nif (isroot) {\r\nbr->topology_change = 1;\r\nmod_timer(&br->topology_change_timer, jiffies\r\n+ br->bridge_forward_delay + br->bridge_max_age);\r\n} else if (!br->topology_change_detected) {\r\nbr_transmit_tcn(br);\r\nmod_timer(&br->tcn_timer, jiffies + br->bridge_hello_time);\r\n}\r\nbr->topology_change_detected = 1;\r\n}\r\nvoid br_config_bpdu_generation(struct net_bridge *br)\r\n{\r\nstruct net_bridge_port *p;\r\nlist_for_each_entry(p, &br->port_list, list) {\r\nif (p->state != BR_STATE_DISABLED &&\r\nbr_is_designated_port(p))\r\nbr_transmit_config(p);\r\n}\r\n}\r\nstatic void br_reply(struct net_bridge_port *p)\r\n{\r\nbr_transmit_config(p);\r\n}\r\nvoid br_configuration_update(struct net_bridge *br)\r\n{\r\nbr_root_selection(br);\r\nbr_designated_port_selection(br);\r\n}\r\nvoid br_become_designated_port(struct net_bridge_port *p)\r\n{\r\nstruct net_bridge *br;\r\nbr = p->br;\r\np->designated_root = br->designated_root;\r\np->designated_cost = br->root_path_cost;\r\np->designated_bridge = br->bridge_id;\r\np->designated_port = p->port_id;\r\n}\r\nstatic void br_make_blocking(struct net_bridge_port *p)\r\n{\r\nif (p->state != BR_STATE_DISABLED &&\r\np->state != BR_STATE_BLOCKING) {\r\nif (p->state == BR_STATE_FORWARDING ||\r\np->state == BR_STATE_LEARNING)\r\nbr_topology_change_detection(p->br);\r\np->state = BR_STATE_BLOCKING;\r\nbr_log_state(p);\r\nbr_ifinfo_notify(RTM_NEWLINK, p);\r\ndel_timer(&p->forward_delay_timer);\r\n}\r\n}\r\nstatic void br_make_forwarding(struct net_bridge_port *p)\r\n{\r\nstruct net_bridge *br = p->br;\r\nif (p->state != BR_STATE_BLOCKING)\r\nreturn;\r\nif (br->stp_enabled == BR_NO_STP || br->forward_delay == 0) {\r\np->state = BR_STATE_FORWARDING;\r\nbr_topology_change_detection(br);\r\ndel_timer(&p->forward_delay_timer);\r\n} else if (br->stp_enabled == BR_KERNEL_STP)\r\np->state = BR_STATE_LISTENING;\r\nelse\r\np->state = BR_STATE_LEARNING;\r\nbr_multicast_enable_port(p);\r\nbr_log_state(p);\r\nbr_ifinfo_notify(RTM_NEWLINK, p);\r\nif (br->forward_delay != 0)\r\nmod_timer(&p->forward_delay_timer, jiffies + br->forward_delay);\r\n}\r\nvoid br_port_state_selection(struct net_bridge *br)\r\n{\r\nstruct net_bridge_port *p;\r\nunsigned int liveports = 0;\r\nlist_for_each_entry(p, &br->port_list, list) {\r\nif (p->state == BR_STATE_DISABLED)\r\ncontinue;\r\nif (br->stp_enabled != BR_USER_STP) {\r\nif (p->port_no == br->root_port) {\r\np->config_pending = 0;\r\np->topology_change_ack = 0;\r\nbr_make_forwarding(p);\r\n} else if (br_is_designated_port(p)) {\r\ndel_timer(&p->message_age_timer);\r\nbr_make_forwarding(p);\r\n} else {\r\np->config_pending = 0;\r\np->topology_change_ack = 0;\r\nbr_make_blocking(p);\r\n}\r\n}\r\nif (p->state == BR_STATE_FORWARDING)\r\n++liveports;\r\n}\r\nif (liveports == 0)\r\nnetif_carrier_off(br->dev);\r\nelse\r\nnetif_carrier_on(br->dev);\r\n}\r\nstatic void br_topology_change_acknowledge(struct net_bridge_port *p)\r\n{\r\np->topology_change_ack = 1;\r\nbr_transmit_config(p);\r\n}\r\nvoid br_received_config_bpdu(struct net_bridge_port *p,\r\nconst struct br_config_bpdu *bpdu)\r\n{\r\nstruct net_bridge *br;\r\nint was_root;\r\nbr = p->br;\r\nwas_root = br_is_root_bridge(br);\r\nif (br_supersedes_port_info(p, bpdu)) {\r\nbr_record_config_information(p, bpdu);\r\nbr_configuration_update(br);\r\nbr_port_state_selection(br);\r\nif (!br_is_root_bridge(br) && was_root) {\r\ndel_timer(&br->hello_timer);\r\nif (br->topology_change_detected) {\r\ndel_timer(&br->topology_change_timer);\r\nbr_transmit_tcn(br);\r\nmod_timer(&br->tcn_timer,\r\njiffies + br->bridge_hello_time);\r\n}\r\n}\r\nif (p->port_no == br->root_port) {\r\nbr_record_config_timeout_values(br, bpdu);\r\nbr_config_bpdu_generation(br);\r\nif (bpdu->topology_change_ack)\r\nbr_topology_change_acknowledged(br);\r\n}\r\n} else if (br_is_designated_port(p)) {\r\nbr_reply(p);\r\n}\r\n}\r\nvoid br_received_tcn_bpdu(struct net_bridge_port *p)\r\n{\r\nif (br_is_designated_port(p)) {\r\nbr_info(p->br, "port %u(%s) received tcn bpdu\n",\r\n(unsigned int) p->port_no, p->dev->name);\r\nbr_topology_change_detection(p->br);\r\nbr_topology_change_acknowledge(p);\r\n}\r\n}\r\nint br_set_hello_time(struct net_bridge *br, unsigned long val)\r\n{\r\nunsigned long t = clock_t_to_jiffies(val);\r\nif (t < BR_MIN_HELLO_TIME || t > BR_MAX_HELLO_TIME)\r\nreturn -ERANGE;\r\nspin_lock_bh(&br->lock);\r\nbr->bridge_hello_time = t;\r\nif (br_is_root_bridge(br))\r\nbr->hello_time = br->bridge_hello_time;\r\nspin_unlock_bh(&br->lock);\r\nreturn 0;\r\n}\r\nint br_set_max_age(struct net_bridge *br, unsigned long val)\r\n{\r\nunsigned long t = clock_t_to_jiffies(val);\r\nif (t < BR_MIN_MAX_AGE || t > BR_MAX_MAX_AGE)\r\nreturn -ERANGE;\r\nspin_lock_bh(&br->lock);\r\nbr->bridge_max_age = t;\r\nif (br_is_root_bridge(br))\r\nbr->max_age = br->bridge_max_age;\r\nspin_unlock_bh(&br->lock);\r\nreturn 0;\r\n}\r\nint br_set_forward_delay(struct net_bridge *br, unsigned long val)\r\n{\r\nunsigned long t = clock_t_to_jiffies(val);\r\nif (br->stp_enabled != BR_NO_STP &&\r\n(t < BR_MIN_FORWARD_DELAY || t > BR_MAX_FORWARD_DELAY))\r\nreturn -ERANGE;\r\nspin_lock_bh(&br->lock);\r\nbr->bridge_forward_delay = t;\r\nif (br_is_root_bridge(br))\r\nbr->forward_delay = br->bridge_forward_delay;\r\nspin_unlock_bh(&br->lock);\r\nreturn 0;\r\n}

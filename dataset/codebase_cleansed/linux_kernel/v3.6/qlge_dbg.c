static u32 ql_read_other_func_reg(struct ql_adapter *qdev,\r\nu32 reg)\r\n{\r\nu32 register_to_read;\r\nu32 reg_val;\r\nunsigned int status = 0;\r\nregister_to_read = MPI_NIC_REG_BLOCK\r\n| MPI_NIC_READ\r\n| (qdev->alt_func << MPI_NIC_FUNCTION_SHIFT)\r\n| reg;\r\nstatus = ql_read_mpi_reg(qdev, register_to_read, &reg_val);\r\nif (status != 0)\r\nreturn 0xffffffff;\r\nreturn reg_val;\r\n}\r\nstatic int ql_write_other_func_reg(struct ql_adapter *qdev,\r\nu32 reg, u32 reg_val)\r\n{\r\nu32 register_to_read;\r\nint status = 0;\r\nregister_to_read = MPI_NIC_REG_BLOCK\r\n| MPI_NIC_READ\r\n| (qdev->alt_func << MPI_NIC_FUNCTION_SHIFT)\r\n| reg;\r\nstatus = ql_write_mpi_reg(qdev, register_to_read, reg_val);\r\nreturn status;\r\n}\r\nstatic int ql_wait_other_func_reg_rdy(struct ql_adapter *qdev, u32 reg,\r\nu32 bit, u32 err_bit)\r\n{\r\nu32 temp;\r\nint count = 10;\r\nwhile (count) {\r\ntemp = ql_read_other_func_reg(qdev, reg);\r\nif (temp & err_bit)\r\nreturn -1;\r\nelse if (temp & bit)\r\nreturn 0;\r\nmdelay(10);\r\ncount--;\r\n}\r\nreturn -1;\r\n}\r\nstatic int ql_read_other_func_serdes_reg(struct ql_adapter *qdev, u32 reg,\r\nu32 *data)\r\n{\r\nint status;\r\nstatus = ql_wait_other_func_reg_rdy(qdev, XG_SERDES_ADDR / 4,\r\nXG_SERDES_ADDR_RDY, 0);\r\nif (status)\r\ngoto exit;\r\nql_write_other_func_reg(qdev, XG_SERDES_ADDR/4, reg | PROC_ADDR_R);\r\nstatus = ql_wait_other_func_reg_rdy(qdev, XG_SERDES_ADDR / 4,\r\nXG_SERDES_ADDR_RDY, 0);\r\nif (status)\r\ngoto exit;\r\n*data = ql_read_other_func_reg(qdev, (XG_SERDES_DATA / 4));\r\nexit:\r\nreturn status;\r\n}\r\nstatic int ql_read_serdes_reg(struct ql_adapter *qdev, u32 reg, u32 * data)\r\n{\r\nint status;\r\nstatus = ql_wait_reg_rdy(qdev, XG_SERDES_ADDR, XG_SERDES_ADDR_RDY, 0);\r\nif (status)\r\ngoto exit;\r\nql_write32(qdev, XG_SERDES_ADDR, reg | PROC_ADDR_R);\r\nstatus = ql_wait_reg_rdy(qdev, XG_SERDES_ADDR, XG_SERDES_ADDR_RDY, 0);\r\nif (status)\r\ngoto exit;\r\n*data = ql_read32(qdev, XG_SERDES_DATA);\r\nexit:\r\nreturn status;\r\n}\r\nstatic void ql_get_both_serdes(struct ql_adapter *qdev, u32 addr,\r\nu32 *direct_ptr, u32 *indirect_ptr,\r\nunsigned int direct_valid, unsigned int indirect_valid)\r\n{\r\nunsigned int status;\r\nstatus = 1;\r\nif (direct_valid)\r\nstatus = ql_read_serdes_reg(qdev, addr, direct_ptr);\r\nif (status)\r\n*direct_ptr = 0xDEADBEEF;\r\nstatus = 1;\r\nif (indirect_valid)\r\nstatus = ql_read_other_func_serdes_reg(\r\nqdev, addr, indirect_ptr);\r\nif (status)\r\n*indirect_ptr = 0xDEADBEEF;\r\n}\r\nstatic int ql_get_serdes_regs(struct ql_adapter *qdev,\r\nstruct ql_mpi_coredump *mpi_coredump)\r\n{\r\nint status;\r\nunsigned int xfi_direct_valid, xfi_indirect_valid, xaui_direct_valid;\r\nunsigned int xaui_indirect_valid, i;\r\nu32 *direct_ptr, temp;\r\nu32 *indirect_ptr;\r\nxfi_direct_valid = xfi_indirect_valid = 0;\r\nxaui_direct_valid = xaui_indirect_valid = 1;\r\nif (qdev->func & 1) {\r\nstatus = ql_read_other_func_serdes_reg(qdev,\r\nXG_SERDES_XAUI_HSS_PCS_START, &temp);\r\nif (status)\r\ntemp = XG_SERDES_ADDR_XAUI_PWR_DOWN;\r\nif ((temp & XG_SERDES_ADDR_XAUI_PWR_DOWN) ==\r\nXG_SERDES_ADDR_XAUI_PWR_DOWN)\r\nxaui_indirect_valid = 0;\r\nstatus = ql_read_serdes_reg(qdev,\r\nXG_SERDES_XAUI_HSS_PCS_START, &temp);\r\nif (status)\r\ntemp = XG_SERDES_ADDR_XAUI_PWR_DOWN;\r\nif ((temp & XG_SERDES_ADDR_XAUI_PWR_DOWN) ==\r\nXG_SERDES_ADDR_XAUI_PWR_DOWN)\r\nxaui_direct_valid = 0;\r\n} else {\r\nstatus = ql_read_other_func_serdes_reg(qdev,\r\nXG_SERDES_XAUI_HSS_PCS_START, &temp);\r\nif (status)\r\ntemp = XG_SERDES_ADDR_XAUI_PWR_DOWN;\r\nif ((temp & XG_SERDES_ADDR_XAUI_PWR_DOWN) ==\r\nXG_SERDES_ADDR_XAUI_PWR_DOWN)\r\nxaui_indirect_valid = 0;\r\nstatus = ql_read_serdes_reg(qdev,\r\nXG_SERDES_XAUI_HSS_PCS_START, &temp);\r\nif (status)\r\ntemp = XG_SERDES_ADDR_XAUI_PWR_DOWN;\r\nif ((temp & XG_SERDES_ADDR_XAUI_PWR_DOWN) ==\r\nXG_SERDES_ADDR_XAUI_PWR_DOWN)\r\nxaui_direct_valid = 0;\r\n}\r\nstatus = ql_read_serdes_reg(qdev, XG_SERDES_ADDR_STS, &temp);\r\nif (status)\r\ntemp = 0;\r\nif ((temp & XG_SERDES_ADDR_XFI1_PWR_UP) ==\r\nXG_SERDES_ADDR_XFI1_PWR_UP) {\r\nif (qdev->func & 1)\r\nxfi_indirect_valid = 1;\r\nelse\r\nxfi_direct_valid = 1;\r\n}\r\nif ((temp & XG_SERDES_ADDR_XFI2_PWR_UP) ==\r\nXG_SERDES_ADDR_XFI2_PWR_UP) {\r\nif (qdev->func & 1)\r\nxfi_direct_valid = 1;\r\nelse\r\nxfi_indirect_valid = 1;\r\n}\r\nif (qdev->func & 1) {\r\ndirect_ptr = mpi_coredump->serdes2_xaui_an;\r\nindirect_ptr = mpi_coredump->serdes_xaui_an;\r\n} else {\r\ndirect_ptr = mpi_coredump->serdes_xaui_an;\r\nindirect_ptr = mpi_coredump->serdes2_xaui_an;\r\n}\r\nfor (i = 0; i <= 0x000000034; i += 4, direct_ptr++, indirect_ptr++)\r\nql_get_both_serdes(qdev, i, direct_ptr, indirect_ptr,\r\nxaui_direct_valid, xaui_indirect_valid);\r\nif (qdev->func & 1) {\r\ndirect_ptr =\r\nmpi_coredump->serdes2_xaui_hss_pcs;\r\nindirect_ptr =\r\nmpi_coredump->serdes_xaui_hss_pcs;\r\n} else {\r\ndirect_ptr =\r\nmpi_coredump->serdes_xaui_hss_pcs;\r\nindirect_ptr =\r\nmpi_coredump->serdes2_xaui_hss_pcs;\r\n}\r\nfor (i = 0x800; i <= 0x880; i += 4, direct_ptr++, indirect_ptr++)\r\nql_get_both_serdes(qdev, i, direct_ptr, indirect_ptr,\r\nxaui_direct_valid, xaui_indirect_valid);\r\nif (qdev->func & 1) {\r\ndirect_ptr = mpi_coredump->serdes2_xfi_an;\r\nindirect_ptr = mpi_coredump->serdes_xfi_an;\r\n} else {\r\ndirect_ptr = mpi_coredump->serdes_xfi_an;\r\nindirect_ptr = mpi_coredump->serdes2_xfi_an;\r\n}\r\nfor (i = 0x1000; i <= 0x1034; i += 4, direct_ptr++, indirect_ptr++)\r\nql_get_both_serdes(qdev, i, direct_ptr, indirect_ptr,\r\nxfi_direct_valid, xfi_indirect_valid);\r\nif (qdev->func & 1) {\r\ndirect_ptr = mpi_coredump->serdes2_xfi_train;\r\nindirect_ptr =\r\nmpi_coredump->serdes_xfi_train;\r\n} else {\r\ndirect_ptr = mpi_coredump->serdes_xfi_train;\r\nindirect_ptr =\r\nmpi_coredump->serdes2_xfi_train;\r\n}\r\nfor (i = 0x1050; i <= 0x107c; i += 4, direct_ptr++, indirect_ptr++)\r\nql_get_both_serdes(qdev, i, direct_ptr, indirect_ptr,\r\nxfi_direct_valid, xfi_indirect_valid);\r\nif (qdev->func & 1) {\r\ndirect_ptr =\r\nmpi_coredump->serdes2_xfi_hss_pcs;\r\nindirect_ptr =\r\nmpi_coredump->serdes_xfi_hss_pcs;\r\n} else {\r\ndirect_ptr =\r\nmpi_coredump->serdes_xfi_hss_pcs;\r\nindirect_ptr =\r\nmpi_coredump->serdes2_xfi_hss_pcs;\r\n}\r\nfor (i = 0x1800; i <= 0x1838; i += 4, direct_ptr++, indirect_ptr++)\r\nql_get_both_serdes(qdev, i, direct_ptr, indirect_ptr,\r\nxfi_direct_valid, xfi_indirect_valid);\r\nif (qdev->func & 1) {\r\ndirect_ptr =\r\nmpi_coredump->serdes2_xfi_hss_tx;\r\nindirect_ptr =\r\nmpi_coredump->serdes_xfi_hss_tx;\r\n} else {\r\ndirect_ptr = mpi_coredump->serdes_xfi_hss_tx;\r\nindirect_ptr =\r\nmpi_coredump->serdes2_xfi_hss_tx;\r\n}\r\nfor (i = 0x1c00; i <= 0x1c1f; i++, direct_ptr++, indirect_ptr++)\r\nql_get_both_serdes(qdev, i, direct_ptr, indirect_ptr,\r\nxfi_direct_valid, xfi_indirect_valid);\r\nif (qdev->func & 1) {\r\ndirect_ptr =\r\nmpi_coredump->serdes2_xfi_hss_rx;\r\nindirect_ptr =\r\nmpi_coredump->serdes_xfi_hss_rx;\r\n} else {\r\ndirect_ptr = mpi_coredump->serdes_xfi_hss_rx;\r\nindirect_ptr =\r\nmpi_coredump->serdes2_xfi_hss_rx;\r\n}\r\nfor (i = 0x1c40; i <= 0x1c5f; i++, direct_ptr++, indirect_ptr++)\r\nql_get_both_serdes(qdev, i, direct_ptr, indirect_ptr,\r\nxfi_direct_valid, xfi_indirect_valid);\r\nif (qdev->func & 1) {\r\ndirect_ptr =\r\nmpi_coredump->serdes2_xfi_hss_pll;\r\nindirect_ptr =\r\nmpi_coredump->serdes_xfi_hss_pll;\r\n} else {\r\ndirect_ptr =\r\nmpi_coredump->serdes_xfi_hss_pll;\r\nindirect_ptr =\r\nmpi_coredump->serdes2_xfi_hss_pll;\r\n}\r\nfor (i = 0x1e00; i <= 0x1e1f; i++, direct_ptr++, indirect_ptr++)\r\nql_get_both_serdes(qdev, i, direct_ptr, indirect_ptr,\r\nxfi_direct_valid, xfi_indirect_valid);\r\nreturn 0;\r\n}\r\nstatic int ql_read_other_func_xgmac_reg(struct ql_adapter *qdev, u32 reg,\r\nu32 *data)\r\n{\r\nint status = 0;\r\nstatus = ql_wait_other_func_reg_rdy(qdev, XGMAC_ADDR / 4,\r\nXGMAC_ADDR_RDY, XGMAC_ADDR_XME);\r\nif (status)\r\ngoto exit;\r\nql_write_other_func_reg(qdev, XGMAC_ADDR / 4, reg | XGMAC_ADDR_R);\r\nstatus = ql_wait_other_func_reg_rdy(qdev, XGMAC_ADDR / 4,\r\nXGMAC_ADDR_RDY, XGMAC_ADDR_XME);\r\nif (status)\r\ngoto exit;\r\n*data = ql_read_other_func_reg(qdev, XGMAC_DATA / 4);\r\nexit:\r\nreturn status;\r\n}\r\nstatic int ql_get_xgmac_regs(struct ql_adapter *qdev, u32 * buf,\r\nunsigned int other_function)\r\n{\r\nint status = 0;\r\nint i;\r\nfor (i = PAUSE_SRC_LO; i < XGMAC_REGISTER_END; i += 4, buf++) {\r\nif ((i == 0x00000114) ||\r\n(i == 0x00000118) ||\r\n(i == 0x0000013c) ||\r\n(i == 0x00000140) ||\r\n(i > 0x00000150 && i < 0x000001fc) ||\r\n(i > 0x00000278 && i < 0x000002a0) ||\r\n(i > 0x000002c0 && i < 0x000002cf) ||\r\n(i > 0x000002dc && i < 0x000002f0) ||\r\n(i > 0x000003c8 && i < 0x00000400) ||\r\n(i > 0x00000400 && i < 0x00000410) ||\r\n(i > 0x00000410 && i < 0x00000420) ||\r\n(i > 0x00000420 && i < 0x00000430) ||\r\n(i > 0x00000430 && i < 0x00000440) ||\r\n(i > 0x00000440 && i < 0x00000450) ||\r\n(i > 0x00000450 && i < 0x00000500) ||\r\n(i > 0x0000054c && i < 0x00000568) ||\r\n(i > 0x000005c8 && i < 0x00000600)) {\r\nif (other_function)\r\nstatus =\r\nql_read_other_func_xgmac_reg(qdev, i, buf);\r\nelse\r\nstatus = ql_read_xgmac_reg(qdev, i, buf);\r\nif (status)\r\n*buf = 0xdeadbeef;\r\nbreak;\r\n}\r\n}\r\nreturn status;\r\n}\r\nstatic int ql_get_ets_regs(struct ql_adapter *qdev, u32 * buf)\r\n{\r\nint status = 0;\r\nint i;\r\nfor (i = 0; i < 8; i++, buf++) {\r\nql_write32(qdev, NIC_ETS, i << 29 | 0x08000000);\r\n*buf = ql_read32(qdev, NIC_ETS);\r\n}\r\nfor (i = 0; i < 2; i++, buf++) {\r\nql_write32(qdev, CNA_ETS, i << 29 | 0x08000000);\r\n*buf = ql_read32(qdev, CNA_ETS);\r\n}\r\nreturn status;\r\n}\r\nstatic void ql_get_intr_states(struct ql_adapter *qdev, u32 * buf)\r\n{\r\nint i;\r\nfor (i = 0; i < qdev->rx_ring_count; i++, buf++) {\r\nql_write32(qdev, INTR_EN,\r\nqdev->intr_context[i].intr_read_mask);\r\n*buf = ql_read32(qdev, INTR_EN);\r\n}\r\n}\r\nstatic int ql_get_cam_entries(struct ql_adapter *qdev, u32 * buf)\r\n{\r\nint i, status;\r\nu32 value[3];\r\nstatus = ql_sem_spinlock(qdev, SEM_MAC_ADDR_MASK);\r\nif (status)\r\nreturn status;\r\nfor (i = 0; i < 16; i++) {\r\nstatus = ql_get_mac_addr_reg(qdev,\r\nMAC_ADDR_TYPE_CAM_MAC, i, value);\r\nif (status) {\r\nnetif_err(qdev, drv, qdev->ndev,\r\n"Failed read of mac index register\n");\r\ngoto err;\r\n}\r\n*buf++ = value[0];\r\n*buf++ = value[1];\r\n*buf++ = value[2];\r\n}\r\nfor (i = 0; i < 32; i++) {\r\nstatus = ql_get_mac_addr_reg(qdev,\r\nMAC_ADDR_TYPE_MULTI_MAC, i, value);\r\nif (status) {\r\nnetif_err(qdev, drv, qdev->ndev,\r\n"Failed read of mac index register\n");\r\ngoto err;\r\n}\r\n*buf++ = value[0];\r\n*buf++ = value[1];\r\n}\r\nerr:\r\nql_sem_unlock(qdev, SEM_MAC_ADDR_MASK);\r\nreturn status;\r\n}\r\nstatic int ql_get_routing_entries(struct ql_adapter *qdev, u32 * buf)\r\n{\r\nint status;\r\nu32 value, i;\r\nstatus = ql_sem_spinlock(qdev, SEM_RT_IDX_MASK);\r\nif (status)\r\nreturn status;\r\nfor (i = 0; i < 16; i++) {\r\nstatus = ql_get_routing_reg(qdev, i, &value);\r\nif (status) {\r\nnetif_err(qdev, drv, qdev->ndev,\r\n"Failed read of routing index register\n");\r\ngoto err;\r\n} else {\r\n*buf++ = value;\r\n}\r\n}\r\nerr:\r\nql_sem_unlock(qdev, SEM_RT_IDX_MASK);\r\nreturn status;\r\n}\r\nstatic int ql_get_mpi_shadow_regs(struct ql_adapter *qdev, u32 * buf)\r\n{\r\nu32 i;\r\nint status;\r\nfor (i = 0; i < MPI_CORE_SH_REGS_CNT; i++, buf++) {\r\nstatus = ql_write_mpi_reg(qdev, RISC_124,\r\n(SHADOW_OFFSET | i << SHADOW_REG_SHIFT));\r\nif (status)\r\ngoto end;\r\nstatus = ql_read_mpi_reg(qdev, RISC_127, buf);\r\nif (status)\r\ngoto end;\r\n}\r\nend:\r\nreturn status;\r\n}\r\nstatic int ql_get_mpi_regs(struct ql_adapter *qdev, u32 * buf,\r\nu32 offset, u32 count)\r\n{\r\nint i, status = 0;\r\nfor (i = 0; i < count; i++, buf++) {\r\nstatus = ql_read_mpi_reg(qdev, offset + i, buf);\r\nif (status)\r\nreturn status;\r\n}\r\nreturn status;\r\n}\r\nstatic unsigned int *ql_get_probe(struct ql_adapter *qdev, u32 clock,\r\nu32 valid, u32 *buf)\r\n{\r\nu32 module, mux_sel, probe, lo_val, hi_val;\r\nfor (module = 0; module < PRB_MX_ADDR_MAX_MODS; module++) {\r\nif (!((valid >> module) & 1))\r\ncontinue;\r\nfor (mux_sel = 0; mux_sel < PRB_MX_ADDR_MAX_MUX; mux_sel++) {\r\nprobe = clock\r\n| PRB_MX_ADDR_ARE\r\n| mux_sel\r\n| (module << PRB_MX_ADDR_MOD_SEL_SHIFT);\r\nql_write32(qdev, PRB_MX_ADDR, probe);\r\nlo_val = ql_read32(qdev, PRB_MX_DATA);\r\nif (mux_sel == 0) {\r\n*buf = probe;\r\nbuf++;\r\n}\r\nprobe |= PRB_MX_ADDR_UP;\r\nql_write32(qdev, PRB_MX_ADDR, probe);\r\nhi_val = ql_read32(qdev, PRB_MX_DATA);\r\n*buf = lo_val;\r\nbuf++;\r\n*buf = hi_val;\r\nbuf++;\r\n}\r\n}\r\nreturn buf;\r\n}\r\nstatic int ql_get_probe_dump(struct ql_adapter *qdev, unsigned int *buf)\r\n{\r\nql_write_mpi_reg(qdev, MPI_TEST_FUNC_PRB_CTL, MPI_TEST_FUNC_PRB_EN);\r\nbuf = ql_get_probe(qdev, PRB_MX_ADDR_SYS_CLOCK,\r\nPRB_MX_ADDR_VALID_SYS_MOD, buf);\r\nbuf = ql_get_probe(qdev, PRB_MX_ADDR_PCI_CLOCK,\r\nPRB_MX_ADDR_VALID_PCI_MOD, buf);\r\nbuf = ql_get_probe(qdev, PRB_MX_ADDR_XGM_CLOCK,\r\nPRB_MX_ADDR_VALID_XGM_MOD, buf);\r\nbuf = ql_get_probe(qdev, PRB_MX_ADDR_FC_CLOCK,\r\nPRB_MX_ADDR_VALID_FC_MOD, buf);\r\nreturn 0;\r\n}\r\nstatic int ql_get_routing_index_registers(struct ql_adapter *qdev, u32 *buf)\r\n{\r\nint status;\r\nu32 type, index, index_max;\r\nu32 result_index;\r\nu32 result_data;\r\nu32 val;\r\nstatus = ql_sem_spinlock(qdev, SEM_RT_IDX_MASK);\r\nif (status)\r\nreturn status;\r\nfor (type = 0; type < 4; type++) {\r\nif (type < 2)\r\nindex_max = 8;\r\nelse\r\nindex_max = 16;\r\nfor (index = 0; index < index_max; index++) {\r\nval = RT_IDX_RS\r\n| (type << RT_IDX_TYPE_SHIFT)\r\n| (index << RT_IDX_IDX_SHIFT);\r\nql_write32(qdev, RT_IDX, val);\r\nresult_index = 0;\r\nwhile ((result_index & RT_IDX_MR) == 0)\r\nresult_index = ql_read32(qdev, RT_IDX);\r\nresult_data = ql_read32(qdev, RT_DATA);\r\n*buf = type;\r\nbuf++;\r\n*buf = index;\r\nbuf++;\r\n*buf = result_index;\r\nbuf++;\r\n*buf = result_data;\r\nbuf++;\r\n}\r\n}\r\nql_sem_unlock(qdev, SEM_RT_IDX_MASK);\r\nreturn status;\r\n}\r\nstatic void ql_get_mac_protocol_registers(struct ql_adapter *qdev, u32 *buf)\r\n{\r\nu32 result_index, result_data;\r\nu32 type;\r\nu32 index;\r\nu32 offset;\r\nu32 val;\r\nu32 initial_val = MAC_ADDR_RS;\r\nu32 max_index;\r\nu32 max_offset;\r\nfor (type = 0; type < MAC_ADDR_TYPE_COUNT; type++) {\r\nswitch (type) {\r\ncase 0:\r\ninitial_val |= MAC_ADDR_ADR;\r\nmax_index = MAC_ADDR_MAX_CAM_ENTRIES;\r\nmax_offset = MAC_ADDR_MAX_CAM_WCOUNT;\r\nbreak;\r\ncase 1:\r\nmax_index = MAC_ADDR_MAX_CAM_WCOUNT;\r\nmax_offset = MAC_ADDR_MAX_CAM_WCOUNT;\r\nbreak;\r\ncase 2:\r\ncase 3:\r\nmax_index = MAC_ADDR_MAX_CAM_WCOUNT;\r\nmax_offset = MAC_ADDR_MAX_CAM_WCOUNT;\r\nbreak;\r\ncase 4:\r\nmax_index = MAC_ADDR_MAX_FC_MAC_ENTRIES;\r\nmax_offset = MAC_ADDR_MAX_FC_MAC_WCOUNT;\r\nbreak;\r\ncase 5:\r\nmax_index = MAC_ADDR_MAX_MGMT_MAC_ENTRIES;\r\nmax_offset = MAC_ADDR_MAX_MGMT_MAC_WCOUNT;\r\nbreak;\r\ncase 6:\r\nmax_index = MAC_ADDR_MAX_MGMT_VLAN_ENTRIES;\r\nmax_offset = MAC_ADDR_MAX_MGMT_VLAN_WCOUNT;\r\nbreak;\r\ncase 7:\r\nmax_index = MAC_ADDR_MAX_MGMT_V4_ENTRIES;\r\nmax_offset = MAC_ADDR_MAX_MGMT_V4_WCOUNT;\r\nbreak;\r\ncase 8:\r\nmax_index = MAC_ADDR_MAX_MGMT_V6_ENTRIES;\r\nmax_offset = MAC_ADDR_MAX_MGMT_V6_WCOUNT;\r\nbreak;\r\ncase 9:\r\nmax_index = MAC_ADDR_MAX_MGMT_TU_DP_ENTRIES;\r\nmax_offset = MAC_ADDR_MAX_MGMT_TU_DP_WCOUNT;\r\nbreak;\r\ndefault:\r\npr_err("Bad type!!! 0x%08x\n", type);\r\nmax_index = 0;\r\nmax_offset = 0;\r\nbreak;\r\n}\r\nfor (index = 0; index < max_index; index++) {\r\nfor (offset = 0; offset < max_offset; offset++) {\r\nval = initial_val\r\n| (type << MAC_ADDR_TYPE_SHIFT)\r\n| (index << MAC_ADDR_IDX_SHIFT)\r\n| (offset);\r\nql_write32(qdev, MAC_ADDR_IDX, val);\r\nresult_index = 0;\r\nwhile ((result_index & MAC_ADDR_MR) == 0) {\r\nresult_index = ql_read32(qdev,\r\nMAC_ADDR_IDX);\r\n}\r\nresult_data = ql_read32(qdev, MAC_ADDR_DATA);\r\n*buf = result_index;\r\nbuf++;\r\n*buf = result_data;\r\nbuf++;\r\n}\r\n}\r\n}\r\n}\r\nstatic void ql_get_sem_registers(struct ql_adapter *qdev, u32 *buf)\r\n{\r\nu32 func_num, reg, reg_val;\r\nint status;\r\nfor (func_num = 0; func_num < MAX_SEMAPHORE_FUNCTIONS ; func_num++) {\r\nreg = MPI_NIC_REG_BLOCK\r\n| (func_num << MPI_NIC_FUNCTION_SHIFT)\r\n| (SEM / 4);\r\nstatus = ql_read_mpi_reg(qdev, reg, &reg_val);\r\n*buf = reg_val;\r\nif (!status)\r\n*buf = 0xdeadbeef;\r\nbuf++;\r\n}\r\n}\r\nstatic void ql_build_coredump_seg_header(\r\nstruct mpi_coredump_segment_header *seg_hdr,\r\nu32 seg_number, u32 seg_size, u8 *desc)\r\n{\r\nmemset(seg_hdr, 0, sizeof(struct mpi_coredump_segment_header));\r\nseg_hdr->cookie = MPI_COREDUMP_COOKIE;\r\nseg_hdr->segNum = seg_number;\r\nseg_hdr->segSize = seg_size;\r\nmemcpy(seg_hdr->description, desc, (sizeof(seg_hdr->description)) - 1);\r\n}\r\nint ql_core_dump(struct ql_adapter *qdev, struct ql_mpi_coredump *mpi_coredump)\r\n{\r\nint status;\r\nint i;\r\nif (!mpi_coredump) {\r\nnetif_err(qdev, drv, qdev->ndev, "No memory available\n");\r\nreturn -ENOMEM;\r\n}\r\nql_sem_spinlock(qdev, SEM_PROC_REG_MASK);\r\nstatus = ql_pause_mpi_risc(qdev);\r\nif (status) {\r\nnetif_err(qdev, drv, qdev->ndev,\r\n"Failed RISC pause. Status = 0x%.08x\n", status);\r\ngoto err;\r\n}\r\nmemset(&(mpi_coredump->mpi_global_header), 0,\r\nsizeof(struct mpi_coredump_global_header));\r\nmpi_coredump->mpi_global_header.cookie = MPI_COREDUMP_COOKIE;\r\nmpi_coredump->mpi_global_header.headerSize =\r\nsizeof(struct mpi_coredump_global_header);\r\nmpi_coredump->mpi_global_header.imageSize =\r\nsizeof(struct ql_mpi_coredump);\r\nmemcpy(mpi_coredump->mpi_global_header.idString, "MPI Coredump",\r\nsizeof(mpi_coredump->mpi_global_header.idString));\r\nql_build_coredump_seg_header(&mpi_coredump->nic_regs_seg_hdr,\r\nNIC1_CONTROL_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header) +\r\nsizeof(mpi_coredump->nic_regs), "NIC1 Registers");\r\nql_build_coredump_seg_header(&mpi_coredump->nic2_regs_seg_hdr,\r\nNIC2_CONTROL_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header) +\r\nsizeof(mpi_coredump->nic2_regs), "NIC2 Registers");\r\nql_build_coredump_seg_header(&mpi_coredump->xgmac1_seg_hdr,\r\nNIC1_XGMAC_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header) +\r\nsizeof(mpi_coredump->xgmac1), "NIC1 XGMac Registers");\r\nql_build_coredump_seg_header(&mpi_coredump->xgmac2_seg_hdr,\r\nNIC2_XGMAC_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header) +\r\nsizeof(mpi_coredump->xgmac2), "NIC2 XGMac Registers");\r\nif (qdev->func & 1) {\r\nfor (i = 0; i < NIC_REGS_DUMP_WORD_COUNT; i++)\r\nmpi_coredump->nic2_regs[i] =\r\nql_read32(qdev, i * sizeof(u32));\r\nfor (i = 0; i < NIC_REGS_DUMP_WORD_COUNT; i++)\r\nmpi_coredump->nic_regs[i] =\r\nql_read_other_func_reg(qdev, (i * sizeof(u32)) / 4);\r\nql_get_xgmac_regs(qdev, &mpi_coredump->xgmac2[0], 0);\r\nql_get_xgmac_regs(qdev, &mpi_coredump->xgmac1[0], 1);\r\n} else {\r\nfor (i = 0; i < NIC_REGS_DUMP_WORD_COUNT; i++)\r\nmpi_coredump->nic_regs[i] =\r\nql_read32(qdev, i * sizeof(u32));\r\nfor (i = 0; i < NIC_REGS_DUMP_WORD_COUNT; i++)\r\nmpi_coredump->nic2_regs[i] =\r\nql_read_other_func_reg(qdev, (i * sizeof(u32)) / 4);\r\nql_get_xgmac_regs(qdev, &mpi_coredump->xgmac1[0], 0);\r\nql_get_xgmac_regs(qdev, &mpi_coredump->xgmac2[0], 1);\r\n}\r\nql_build_coredump_seg_header(&mpi_coredump->xaui_an_hdr,\r\nXAUI_AN_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header) +\r\nsizeof(mpi_coredump->serdes_xaui_an),\r\n"XAUI AN Registers");\r\nql_build_coredump_seg_header(&mpi_coredump->xaui_hss_pcs_hdr,\r\nXAUI_HSS_PCS_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header) +\r\nsizeof(mpi_coredump->serdes_xaui_hss_pcs),\r\n"XAUI HSS PCS Registers");\r\nql_build_coredump_seg_header(&mpi_coredump->xfi_an_hdr, XFI_AN_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header) +\r\nsizeof(mpi_coredump->serdes_xfi_an),\r\n"XFI AN Registers");\r\nql_build_coredump_seg_header(&mpi_coredump->xfi_train_hdr,\r\nXFI_TRAIN_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header) +\r\nsizeof(mpi_coredump->serdes_xfi_train),\r\n"XFI TRAIN Registers");\r\nql_build_coredump_seg_header(&mpi_coredump->xfi_hss_pcs_hdr,\r\nXFI_HSS_PCS_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header) +\r\nsizeof(mpi_coredump->serdes_xfi_hss_pcs),\r\n"XFI HSS PCS Registers");\r\nql_build_coredump_seg_header(&mpi_coredump->xfi_hss_tx_hdr,\r\nXFI_HSS_TX_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header) +\r\nsizeof(mpi_coredump->serdes_xfi_hss_tx),\r\n"XFI HSS TX Registers");\r\nql_build_coredump_seg_header(&mpi_coredump->xfi_hss_rx_hdr,\r\nXFI_HSS_RX_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header) +\r\nsizeof(mpi_coredump->serdes_xfi_hss_rx),\r\n"XFI HSS RX Registers");\r\nql_build_coredump_seg_header(&mpi_coredump->xfi_hss_pll_hdr,\r\nXFI_HSS_PLL_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header) +\r\nsizeof(mpi_coredump->serdes_xfi_hss_pll),\r\n"XFI HSS PLL Registers");\r\nql_build_coredump_seg_header(&mpi_coredump->xaui2_an_hdr,\r\nXAUI2_AN_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header) +\r\nsizeof(mpi_coredump->serdes2_xaui_an),\r\n"XAUI2 AN Registers");\r\nql_build_coredump_seg_header(&mpi_coredump->xaui2_hss_pcs_hdr,\r\nXAUI2_HSS_PCS_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header) +\r\nsizeof(mpi_coredump->serdes2_xaui_hss_pcs),\r\n"XAUI2 HSS PCS Registers");\r\nql_build_coredump_seg_header(&mpi_coredump->xfi2_an_hdr,\r\nXFI2_AN_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header) +\r\nsizeof(mpi_coredump->serdes2_xfi_an),\r\n"XFI2 AN Registers");\r\nql_build_coredump_seg_header(&mpi_coredump->xfi2_train_hdr,\r\nXFI2_TRAIN_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header) +\r\nsizeof(mpi_coredump->serdes2_xfi_train),\r\n"XFI2 TRAIN Registers");\r\nql_build_coredump_seg_header(&mpi_coredump->xfi2_hss_pcs_hdr,\r\nXFI2_HSS_PCS_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header) +\r\nsizeof(mpi_coredump->serdes2_xfi_hss_pcs),\r\n"XFI2 HSS PCS Registers");\r\nql_build_coredump_seg_header(&mpi_coredump->xfi2_hss_tx_hdr,\r\nXFI2_HSS_TX_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header) +\r\nsizeof(mpi_coredump->serdes2_xfi_hss_tx),\r\n"XFI2 HSS TX Registers");\r\nql_build_coredump_seg_header(&mpi_coredump->xfi2_hss_rx_hdr,\r\nXFI2_HSS_RX_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header) +\r\nsizeof(mpi_coredump->serdes2_xfi_hss_rx),\r\n"XFI2 HSS RX Registers");\r\nql_build_coredump_seg_header(&mpi_coredump->xfi2_hss_pll_hdr,\r\nXFI2_HSS_PLL_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header) +\r\nsizeof(mpi_coredump->serdes2_xfi_hss_pll),\r\n"XFI2 HSS PLL Registers");\r\nstatus = ql_get_serdes_regs(qdev, mpi_coredump);\r\nif (status) {\r\nnetif_err(qdev, drv, qdev->ndev,\r\n"Failed Dump of Serdes Registers. Status = 0x%.08x\n",\r\nstatus);\r\ngoto err;\r\n}\r\nql_build_coredump_seg_header(&mpi_coredump->core_regs_seg_hdr,\r\nCORE_SEG_NUM,\r\nsizeof(mpi_coredump->core_regs_seg_hdr) +\r\nsizeof(mpi_coredump->mpi_core_regs) +\r\nsizeof(mpi_coredump->mpi_core_sh_regs),\r\n"Core Registers");\r\nstatus = ql_get_mpi_regs(qdev, &mpi_coredump->mpi_core_regs[0],\r\nMPI_CORE_REGS_ADDR, MPI_CORE_REGS_CNT);\r\nif (status)\r\ngoto err;\r\nstatus = ql_get_mpi_shadow_regs(qdev,\r\n&mpi_coredump->mpi_core_sh_regs[0]);\r\nif (status)\r\ngoto err;\r\nql_build_coredump_seg_header(&mpi_coredump->test_logic_regs_seg_hdr,\r\nTEST_LOGIC_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->test_logic_regs),\r\n"Test Logic Regs");\r\nstatus = ql_get_mpi_regs(qdev, &mpi_coredump->test_logic_regs[0],\r\nTEST_REGS_ADDR, TEST_REGS_CNT);\r\nif (status)\r\ngoto err;\r\nql_build_coredump_seg_header(&mpi_coredump->rmii_regs_seg_hdr,\r\nRMII_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->rmii_regs),\r\n"RMII Registers");\r\nstatus = ql_get_mpi_regs(qdev, &mpi_coredump->rmii_regs[0],\r\nRMII_REGS_ADDR, RMII_REGS_CNT);\r\nif (status)\r\ngoto err;\r\nql_build_coredump_seg_header(&mpi_coredump->fcmac1_regs_seg_hdr,\r\nFCMAC1_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->fcmac1_regs),\r\n"FCMAC1 Registers");\r\nstatus = ql_get_mpi_regs(qdev, &mpi_coredump->fcmac1_regs[0],\r\nFCMAC1_REGS_ADDR, FCMAC_REGS_CNT);\r\nif (status)\r\ngoto err;\r\nql_build_coredump_seg_header(&mpi_coredump->fcmac2_regs_seg_hdr,\r\nFCMAC2_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->fcmac2_regs),\r\n"FCMAC2 Registers");\r\nstatus = ql_get_mpi_regs(qdev, &mpi_coredump->fcmac2_regs[0],\r\nFCMAC2_REGS_ADDR, FCMAC_REGS_CNT);\r\nif (status)\r\ngoto err;\r\nql_build_coredump_seg_header(&mpi_coredump->fc1_mbx_regs_seg_hdr,\r\nFC1_MBOX_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->fc1_mbx_regs),\r\n"FC1 MBox Regs");\r\nstatus = ql_get_mpi_regs(qdev, &mpi_coredump->fc1_mbx_regs[0],\r\nFC1_MBX_REGS_ADDR, FC_MBX_REGS_CNT);\r\nif (status)\r\ngoto err;\r\nql_build_coredump_seg_header(&mpi_coredump->ide_regs_seg_hdr,\r\nIDE_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->ide_regs),\r\n"IDE Registers");\r\nstatus = ql_get_mpi_regs(qdev, &mpi_coredump->ide_regs[0],\r\nIDE_REGS_ADDR, IDE_REGS_CNT);\r\nif (status)\r\ngoto err;\r\nql_build_coredump_seg_header(&mpi_coredump->nic1_mbx_regs_seg_hdr,\r\nNIC1_MBOX_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->nic1_mbx_regs),\r\n"NIC1 MBox Regs");\r\nstatus = ql_get_mpi_regs(qdev, &mpi_coredump->nic1_mbx_regs[0],\r\nNIC1_MBX_REGS_ADDR, NIC_MBX_REGS_CNT);\r\nif (status)\r\ngoto err;\r\nql_build_coredump_seg_header(&mpi_coredump->smbus_regs_seg_hdr,\r\nSMBUS_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->smbus_regs),\r\n"SMBus Registers");\r\nstatus = ql_get_mpi_regs(qdev, &mpi_coredump->smbus_regs[0],\r\nSMBUS_REGS_ADDR, SMBUS_REGS_CNT);\r\nif (status)\r\ngoto err;\r\nql_build_coredump_seg_header(&mpi_coredump->fc2_mbx_regs_seg_hdr,\r\nFC2_MBOX_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->fc2_mbx_regs),\r\n"FC2 MBox Regs");\r\nstatus = ql_get_mpi_regs(qdev, &mpi_coredump->fc2_mbx_regs[0],\r\nFC2_MBX_REGS_ADDR, FC_MBX_REGS_CNT);\r\nif (status)\r\ngoto err;\r\nql_build_coredump_seg_header(&mpi_coredump->nic2_mbx_regs_seg_hdr,\r\nNIC2_MBOX_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->nic2_mbx_regs),\r\n"NIC2 MBox Regs");\r\nstatus = ql_get_mpi_regs(qdev, &mpi_coredump->nic2_mbx_regs[0],\r\nNIC2_MBX_REGS_ADDR, NIC_MBX_REGS_CNT);\r\nif (status)\r\ngoto err;\r\nql_build_coredump_seg_header(&mpi_coredump->i2c_regs_seg_hdr,\r\nI2C_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->i2c_regs),\r\n"I2C Registers");\r\nstatus = ql_get_mpi_regs(qdev, &mpi_coredump->i2c_regs[0],\r\nI2C_REGS_ADDR, I2C_REGS_CNT);\r\nif (status)\r\ngoto err;\r\nql_build_coredump_seg_header(&mpi_coredump->memc_regs_seg_hdr,\r\nMEMC_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->memc_regs),\r\n"MEMC Registers");\r\nstatus = ql_get_mpi_regs(qdev, &mpi_coredump->memc_regs[0],\r\nMEMC_REGS_ADDR, MEMC_REGS_CNT);\r\nif (status)\r\ngoto err;\r\nql_build_coredump_seg_header(&mpi_coredump->pbus_regs_seg_hdr,\r\nPBUS_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->pbus_regs),\r\n"PBUS Registers");\r\nstatus = ql_get_mpi_regs(qdev, &mpi_coredump->pbus_regs[0],\r\nPBUS_REGS_ADDR, PBUS_REGS_CNT);\r\nif (status)\r\ngoto err;\r\nql_build_coredump_seg_header(&mpi_coredump->mde_regs_seg_hdr,\r\nMDE_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->mde_regs),\r\n"MDE Registers");\r\nstatus = ql_get_mpi_regs(qdev, &mpi_coredump->mde_regs[0],\r\nMDE_REGS_ADDR, MDE_REGS_CNT);\r\nif (status)\r\ngoto err;\r\nql_build_coredump_seg_header(&mpi_coredump->misc_nic_seg_hdr,\r\nMISC_NIC_INFO_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->misc_nic_info),\r\n"MISC NIC INFO");\r\nmpi_coredump->misc_nic_info.rx_ring_count = qdev->rx_ring_count;\r\nmpi_coredump->misc_nic_info.tx_ring_count = qdev->tx_ring_count;\r\nmpi_coredump->misc_nic_info.intr_count = qdev->intr_count;\r\nmpi_coredump->misc_nic_info.function = qdev->func;\r\nql_build_coredump_seg_header(&mpi_coredump->intr_states_seg_hdr,\r\nINTR_STATES_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->intr_states),\r\n"INTR States");\r\nql_get_intr_states(qdev, &mpi_coredump->intr_states[0]);\r\nql_build_coredump_seg_header(&mpi_coredump->cam_entries_seg_hdr,\r\nCAM_ENTRIES_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->cam_entries),\r\n"CAM Entries");\r\nstatus = ql_get_cam_entries(qdev, &mpi_coredump->cam_entries[0]);\r\nif (status)\r\ngoto err;\r\nql_build_coredump_seg_header(&mpi_coredump->nic_routing_words_seg_hdr,\r\nROUTING_WORDS_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->nic_routing_words),\r\n"Routing Words");\r\nstatus = ql_get_routing_entries(qdev,\r\n&mpi_coredump->nic_routing_words[0]);\r\nif (status)\r\ngoto err;\r\nql_build_coredump_seg_header(&mpi_coredump->ets_seg_hdr,\r\nETS_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->ets),\r\n"ETS Registers");\r\nstatus = ql_get_ets_regs(qdev, &mpi_coredump->ets[0]);\r\nif (status)\r\ngoto err;\r\nql_build_coredump_seg_header(&mpi_coredump->probe_dump_seg_hdr,\r\nPROBE_DUMP_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->probe_dump),\r\n"Probe Dump");\r\nql_get_probe_dump(qdev, &mpi_coredump->probe_dump[0]);\r\nql_build_coredump_seg_header(&mpi_coredump->routing_reg_seg_hdr,\r\nROUTING_INDEX_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->routing_regs),\r\n"Routing Regs");\r\nstatus = ql_get_routing_index_registers(qdev,\r\n&mpi_coredump->routing_regs[0]);\r\nif (status)\r\ngoto err;\r\nql_build_coredump_seg_header(&mpi_coredump->mac_prot_reg_seg_hdr,\r\nMAC_PROTOCOL_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->mac_prot_regs),\r\n"MAC Prot Regs");\r\nql_get_mac_protocol_registers(qdev, &mpi_coredump->mac_prot_regs[0]);\r\nql_build_coredump_seg_header(&mpi_coredump->sem_regs_seg_hdr,\r\nSEM_REGS_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header) +\r\nsizeof(mpi_coredump->sem_regs), "Sem Registers");\r\nql_get_sem_registers(qdev, &mpi_coredump->sem_regs[0]);\r\nql_write_mpi_reg(qdev, MPI_TEST_FUNC_RST_STS, MPI_TEST_FUNC_RST_FRC);\r\nstatus = ql_unpause_mpi_risc(qdev);\r\nif (status) {\r\nnetif_err(qdev, drv, qdev->ndev,\r\n"Failed RISC unpause. Status = 0x%.08x\n", status);\r\ngoto err;\r\n}\r\nstatus = ql_hard_reset_mpi_risc(qdev);\r\nif (status) {\r\nnetif_err(qdev, drv, qdev->ndev,\r\n"Failed RISC reset. Status = 0x%.08x\n", status);\r\ngoto err;\r\n}\r\nql_build_coredump_seg_header(&mpi_coredump->code_ram_seg_hdr,\r\nWCS_RAM_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->code_ram),\r\n"WCS RAM");\r\nstatus = ql_dump_risc_ram_area(qdev, &mpi_coredump->code_ram[0],\r\nCODE_RAM_ADDR, CODE_RAM_CNT);\r\nif (status) {\r\nnetif_err(qdev, drv, qdev->ndev,\r\n"Failed Dump of CODE RAM. Status = 0x%.08x\n",\r\nstatus);\r\ngoto err;\r\n}\r\nql_build_coredump_seg_header(&mpi_coredump->memc_ram_seg_hdr,\r\nMEMC_RAM_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->memc_ram),\r\n"MEMC RAM");\r\nstatus = ql_dump_risc_ram_area(qdev, &mpi_coredump->memc_ram[0],\r\nMEMC_RAM_ADDR, MEMC_RAM_CNT);\r\nif (status) {\r\nnetif_err(qdev, drv, qdev->ndev,\r\n"Failed Dump of MEMC RAM. Status = 0x%.08x\n",\r\nstatus);\r\ngoto err;\r\n}\r\nerr:\r\nql_sem_unlock(qdev, SEM_PROC_REG_MASK);\r\nreturn status;\r\n}\r\nstatic void ql_get_core_dump(struct ql_adapter *qdev)\r\n{\r\nif (!ql_own_firmware(qdev)) {\r\nnetif_err(qdev, drv, qdev->ndev, "Don't own firmware!\n");\r\nreturn;\r\n}\r\nif (!netif_running(qdev->ndev)) {\r\nnetif_err(qdev, ifup, qdev->ndev,\r\n"Force Coredump can only be done from interface that is up\n");\r\nreturn;\r\n}\r\nql_queue_fw_error(qdev);\r\n}\r\nvoid ql_gen_reg_dump(struct ql_adapter *qdev,\r\nstruct ql_reg_dump *mpi_coredump)\r\n{\r\nint i, status;\r\nmemset(&(mpi_coredump->mpi_global_header), 0,\r\nsizeof(struct mpi_coredump_global_header));\r\nmpi_coredump->mpi_global_header.cookie = MPI_COREDUMP_COOKIE;\r\nmpi_coredump->mpi_global_header.headerSize =\r\nsizeof(struct mpi_coredump_global_header);\r\nmpi_coredump->mpi_global_header.imageSize =\r\nsizeof(struct ql_reg_dump);\r\nmemcpy(mpi_coredump->mpi_global_header.idString, "MPI Coredump",\r\nsizeof(mpi_coredump->mpi_global_header.idString));\r\nql_build_coredump_seg_header(&mpi_coredump->misc_nic_seg_hdr,\r\nMISC_NIC_INFO_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->misc_nic_info),\r\n"MISC NIC INFO");\r\nmpi_coredump->misc_nic_info.rx_ring_count = qdev->rx_ring_count;\r\nmpi_coredump->misc_nic_info.tx_ring_count = qdev->tx_ring_count;\r\nmpi_coredump->misc_nic_info.intr_count = qdev->intr_count;\r\nmpi_coredump->misc_nic_info.function = qdev->func;\r\nql_build_coredump_seg_header(&mpi_coredump->nic_regs_seg_hdr,\r\nNIC1_CONTROL_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->nic_regs),\r\n"NIC Registers");\r\nfor (i = 0; i < 64; i++)\r\nmpi_coredump->nic_regs[i] = ql_read32(qdev, i * sizeof(u32));\r\nql_build_coredump_seg_header(&mpi_coredump->intr_states_seg_hdr,\r\nINTR_STATES_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->intr_states),\r\n"INTR States");\r\nql_get_intr_states(qdev, &mpi_coredump->intr_states[0]);\r\nql_build_coredump_seg_header(&mpi_coredump->cam_entries_seg_hdr,\r\nCAM_ENTRIES_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->cam_entries),\r\n"CAM Entries");\r\nstatus = ql_get_cam_entries(qdev, &mpi_coredump->cam_entries[0]);\r\nif (status)\r\nreturn;\r\nql_build_coredump_seg_header(&mpi_coredump->nic_routing_words_seg_hdr,\r\nROUTING_WORDS_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->nic_routing_words),\r\n"Routing Words");\r\nstatus = ql_get_routing_entries(qdev,\r\n&mpi_coredump->nic_routing_words[0]);\r\nif (status)\r\nreturn;\r\nql_build_coredump_seg_header(&mpi_coredump->ets_seg_hdr,\r\nETS_SEG_NUM,\r\nsizeof(struct mpi_coredump_segment_header)\r\n+ sizeof(mpi_coredump->ets),\r\n"ETS Registers");\r\nstatus = ql_get_ets_regs(qdev, &mpi_coredump->ets[0]);\r\nif (status)\r\nreturn;\r\n}\r\nvoid ql_get_dump(struct ql_adapter *qdev, void *buff)\r\n{\r\nif (!test_bit(QL_FRC_COREDUMP, &qdev->flags)) {\r\nif (!ql_core_dump(qdev, buff))\r\nql_soft_reset_mpi_risc(qdev);\r\nelse\r\nnetif_err(qdev, drv, qdev->ndev, "coredump failed!\n");\r\n} else {\r\nql_gen_reg_dump(qdev, buff);\r\nql_get_core_dump(qdev);\r\n}\r\n}\r\nvoid ql_mpi_core_to_log(struct work_struct *work)\r\n{\r\nstruct ql_adapter *qdev =\r\ncontainer_of(work, struct ql_adapter, mpi_core_to_log.work);\r\nu32 *tmp, count;\r\nint i;\r\ncount = sizeof(struct ql_mpi_coredump) / sizeof(u32);\r\ntmp = (u32 *)qdev->mpi_coredump;\r\nnetif_printk(qdev, drv, KERN_DEBUG, qdev->ndev,\r\n"Core is dumping to log file!\n");\r\nfor (i = 0; i < count; i += 8) {\r\npr_err("%.08x: %.08x %.08x %.08x %.08x %.08x "\r\n"%.08x %.08x %.08x\n", i,\r\ntmp[i + 0],\r\ntmp[i + 1],\r\ntmp[i + 2],\r\ntmp[i + 3],\r\ntmp[i + 4],\r\ntmp[i + 5],\r\ntmp[i + 6],\r\ntmp[i + 7]);\r\nmsleep(5);\r\n}\r\n}\r\nstatic void ql_dump_intr_states(struct ql_adapter *qdev)\r\n{\r\nint i;\r\nu32 value;\r\nfor (i = 0; i < qdev->intr_count; i++) {\r\nql_write32(qdev, INTR_EN, qdev->intr_context[i].intr_read_mask);\r\nvalue = ql_read32(qdev, INTR_EN);\r\npr_err("%s: Interrupt %d is %s\n",\r\nqdev->ndev->name, i,\r\n(value & INTR_EN_EN ? "enabled" : "disabled"));\r\n}\r\n}\r\nvoid ql_dump_xgmac_control_regs(struct ql_adapter *qdev)\r\n{\r\nif (ql_sem_spinlock(qdev, qdev->xg_sem_mask)) {\r\npr_err("%s: Couldn't get xgmac sem\n", __func__);\r\nreturn;\r\n}\r\nDUMP_XGMAC(qdev, PAUSE_SRC_LO);\r\nDUMP_XGMAC(qdev, PAUSE_SRC_HI);\r\nDUMP_XGMAC(qdev, GLOBAL_CFG);\r\nDUMP_XGMAC(qdev, TX_CFG);\r\nDUMP_XGMAC(qdev, RX_CFG);\r\nDUMP_XGMAC(qdev, FLOW_CTL);\r\nDUMP_XGMAC(qdev, PAUSE_OPCODE);\r\nDUMP_XGMAC(qdev, PAUSE_TIMER);\r\nDUMP_XGMAC(qdev, PAUSE_FRM_DEST_LO);\r\nDUMP_XGMAC(qdev, PAUSE_FRM_DEST_HI);\r\nDUMP_XGMAC(qdev, MAC_TX_PARAMS);\r\nDUMP_XGMAC(qdev, MAC_RX_PARAMS);\r\nDUMP_XGMAC(qdev, MAC_SYS_INT);\r\nDUMP_XGMAC(qdev, MAC_SYS_INT_MASK);\r\nDUMP_XGMAC(qdev, MAC_MGMT_INT);\r\nDUMP_XGMAC(qdev, MAC_MGMT_IN_MASK);\r\nDUMP_XGMAC(qdev, EXT_ARB_MODE);\r\nql_sem_unlock(qdev, qdev->xg_sem_mask);\r\n}\r\nstatic void ql_dump_ets_regs(struct ql_adapter *qdev)\r\n{\r\n}\r\nstatic void ql_dump_cam_entries(struct ql_adapter *qdev)\r\n{\r\nint i;\r\nu32 value[3];\r\ni = ql_sem_spinlock(qdev, SEM_MAC_ADDR_MASK);\r\nif (i)\r\nreturn;\r\nfor (i = 0; i < 4; i++) {\r\nif (ql_get_mac_addr_reg(qdev, MAC_ADDR_TYPE_CAM_MAC, i, value)) {\r\npr_err("%s: Failed read of mac index register\n",\r\n__func__);\r\nreturn;\r\n} else {\r\nif (value[0])\r\npr_err("%s: CAM index %d CAM Lookup Lower = 0x%.08x:%.08x, Output = 0x%.08x\n",\r\nqdev->ndev->name, i, value[1], value[0],\r\nvalue[2]);\r\n}\r\n}\r\nfor (i = 0; i < 32; i++) {\r\nif (ql_get_mac_addr_reg\r\n(qdev, MAC_ADDR_TYPE_MULTI_MAC, i, value)) {\r\npr_err("%s: Failed read of mac index register\n",\r\n__func__);\r\nreturn;\r\n} else {\r\nif (value[0])\r\npr_err("%s: MCAST index %d CAM Lookup Lower = 0x%.08x:%.08x\n",\r\nqdev->ndev->name, i, value[1], value[0]);\r\n}\r\n}\r\nql_sem_unlock(qdev, SEM_MAC_ADDR_MASK);\r\n}\r\nvoid ql_dump_routing_entries(struct ql_adapter *qdev)\r\n{\r\nint i;\r\nu32 value;\r\ni = ql_sem_spinlock(qdev, SEM_RT_IDX_MASK);\r\nif (i)\r\nreturn;\r\nfor (i = 0; i < 16; i++) {\r\nvalue = 0;\r\nif (ql_get_routing_reg(qdev, i, &value)) {\r\npr_err("%s: Failed read of routing index register\n",\r\n__func__);\r\nreturn;\r\n} else {\r\nif (value)\r\npr_err("%s: Routing Mask %d = 0x%.08x\n",\r\nqdev->ndev->name, i, value);\r\n}\r\n}\r\nql_sem_unlock(qdev, SEM_RT_IDX_MASK);\r\n}\r\nvoid ql_dump_regs(struct ql_adapter *qdev)\r\n{\r\npr_err("reg dump for function #%d\n", qdev->func);\r\nDUMP_REG(qdev, SYS);\r\nDUMP_REG(qdev, RST_FO);\r\nDUMP_REG(qdev, FSC);\r\nDUMP_REG(qdev, CSR);\r\nDUMP_REG(qdev, ICB_RID);\r\nDUMP_REG(qdev, ICB_L);\r\nDUMP_REG(qdev, ICB_H);\r\nDUMP_REG(qdev, CFG);\r\nDUMP_REG(qdev, BIOS_ADDR);\r\nDUMP_REG(qdev, STS);\r\nDUMP_REG(qdev, INTR_EN);\r\nDUMP_REG(qdev, INTR_MASK);\r\nDUMP_REG(qdev, ISR1);\r\nDUMP_REG(qdev, ISR2);\r\nDUMP_REG(qdev, ISR3);\r\nDUMP_REG(qdev, ISR4);\r\nDUMP_REG(qdev, REV_ID);\r\nDUMP_REG(qdev, FRC_ECC_ERR);\r\nDUMP_REG(qdev, ERR_STS);\r\nDUMP_REG(qdev, RAM_DBG_ADDR);\r\nDUMP_REG(qdev, RAM_DBG_DATA);\r\nDUMP_REG(qdev, ECC_ERR_CNT);\r\nDUMP_REG(qdev, SEM);\r\nDUMP_REG(qdev, GPIO_1);\r\nDUMP_REG(qdev, GPIO_2);\r\nDUMP_REG(qdev, GPIO_3);\r\nDUMP_REG(qdev, XGMAC_ADDR);\r\nDUMP_REG(qdev, XGMAC_DATA);\r\nDUMP_REG(qdev, NIC_ETS);\r\nDUMP_REG(qdev, CNA_ETS);\r\nDUMP_REG(qdev, FLASH_ADDR);\r\nDUMP_REG(qdev, FLASH_DATA);\r\nDUMP_REG(qdev, CQ_STOP);\r\nDUMP_REG(qdev, PAGE_TBL_RID);\r\nDUMP_REG(qdev, WQ_PAGE_TBL_LO);\r\nDUMP_REG(qdev, WQ_PAGE_TBL_HI);\r\nDUMP_REG(qdev, CQ_PAGE_TBL_LO);\r\nDUMP_REG(qdev, CQ_PAGE_TBL_HI);\r\nDUMP_REG(qdev, COS_DFLT_CQ1);\r\nDUMP_REG(qdev, COS_DFLT_CQ2);\r\nDUMP_REG(qdev, SPLT_HDR);\r\nDUMP_REG(qdev, FC_PAUSE_THRES);\r\nDUMP_REG(qdev, NIC_PAUSE_THRES);\r\nDUMP_REG(qdev, FC_ETHERTYPE);\r\nDUMP_REG(qdev, FC_RCV_CFG);\r\nDUMP_REG(qdev, NIC_RCV_CFG);\r\nDUMP_REG(qdev, FC_COS_TAGS);\r\nDUMP_REG(qdev, NIC_COS_TAGS);\r\nDUMP_REG(qdev, MGMT_RCV_CFG);\r\nDUMP_REG(qdev, XG_SERDES_ADDR);\r\nDUMP_REG(qdev, XG_SERDES_DATA);\r\nDUMP_REG(qdev, PRB_MX_ADDR);\r\nDUMP_REG(qdev, PRB_MX_DATA);\r\nql_dump_intr_states(qdev);\r\nql_dump_xgmac_control_regs(qdev);\r\nql_dump_ets_regs(qdev);\r\nql_dump_cam_entries(qdev);\r\nql_dump_routing_entries(qdev);\r\n}\r\nvoid ql_dump_stat(struct ql_adapter *qdev)\r\n{\r\npr_err("%s: Enter\n", __func__);\r\nDUMP_STAT(qdev, tx_pkts);\r\nDUMP_STAT(qdev, tx_bytes);\r\nDUMP_STAT(qdev, tx_mcast_pkts);\r\nDUMP_STAT(qdev, tx_bcast_pkts);\r\nDUMP_STAT(qdev, tx_ucast_pkts);\r\nDUMP_STAT(qdev, tx_ctl_pkts);\r\nDUMP_STAT(qdev, tx_pause_pkts);\r\nDUMP_STAT(qdev, tx_64_pkt);\r\nDUMP_STAT(qdev, tx_65_to_127_pkt);\r\nDUMP_STAT(qdev, tx_128_to_255_pkt);\r\nDUMP_STAT(qdev, tx_256_511_pkt);\r\nDUMP_STAT(qdev, tx_512_to_1023_pkt);\r\nDUMP_STAT(qdev, tx_1024_to_1518_pkt);\r\nDUMP_STAT(qdev, tx_1519_to_max_pkt);\r\nDUMP_STAT(qdev, tx_undersize_pkt);\r\nDUMP_STAT(qdev, tx_oversize_pkt);\r\nDUMP_STAT(qdev, rx_bytes);\r\nDUMP_STAT(qdev, rx_bytes_ok);\r\nDUMP_STAT(qdev, rx_pkts);\r\nDUMP_STAT(qdev, rx_pkts_ok);\r\nDUMP_STAT(qdev, rx_bcast_pkts);\r\nDUMP_STAT(qdev, rx_mcast_pkts);\r\nDUMP_STAT(qdev, rx_ucast_pkts);\r\nDUMP_STAT(qdev, rx_undersize_pkts);\r\nDUMP_STAT(qdev, rx_oversize_pkts);\r\nDUMP_STAT(qdev, rx_jabber_pkts);\r\nDUMP_STAT(qdev, rx_undersize_fcerr_pkts);\r\nDUMP_STAT(qdev, rx_drop_events);\r\nDUMP_STAT(qdev, rx_fcerr_pkts);\r\nDUMP_STAT(qdev, rx_align_err);\r\nDUMP_STAT(qdev, rx_symbol_err);\r\nDUMP_STAT(qdev, rx_mac_err);\r\nDUMP_STAT(qdev, rx_ctl_pkts);\r\nDUMP_STAT(qdev, rx_pause_pkts);\r\nDUMP_STAT(qdev, rx_64_pkts);\r\nDUMP_STAT(qdev, rx_65_to_127_pkts);\r\nDUMP_STAT(qdev, rx_128_255_pkts);\r\nDUMP_STAT(qdev, rx_256_511_pkts);\r\nDUMP_STAT(qdev, rx_512_to_1023_pkts);\r\nDUMP_STAT(qdev, rx_1024_to_1518_pkts);\r\nDUMP_STAT(qdev, rx_1519_to_max_pkts);\r\nDUMP_STAT(qdev, rx_len_err_pkts);\r\n}\r\nvoid ql_dump_qdev(struct ql_adapter *qdev)\r\n{\r\nint i;\r\nDUMP_QDEV_FIELD(qdev, "%lx", flags);\r\nDUMP_QDEV_FIELD(qdev, "%p", vlgrp);\r\nDUMP_QDEV_FIELD(qdev, "%p", pdev);\r\nDUMP_QDEV_FIELD(qdev, "%p", ndev);\r\nDUMP_QDEV_FIELD(qdev, "%d", chip_rev_id);\r\nDUMP_QDEV_FIELD(qdev, "%p", reg_base);\r\nDUMP_QDEV_FIELD(qdev, "%p", doorbell_area);\r\nDUMP_QDEV_FIELD(qdev, "%d", doorbell_area_size);\r\nDUMP_QDEV_FIELD(qdev, "%x", msg_enable);\r\nDUMP_QDEV_FIELD(qdev, "%p", rx_ring_shadow_reg_area);\r\nDUMP_QDEV_DMA_FIELD(qdev, rx_ring_shadow_reg_dma);\r\nDUMP_QDEV_FIELD(qdev, "%p", tx_ring_shadow_reg_area);\r\nDUMP_QDEV_DMA_FIELD(qdev, tx_ring_shadow_reg_dma);\r\nDUMP_QDEV_FIELD(qdev, "%d", intr_count);\r\nif (qdev->msi_x_entry)\r\nfor (i = 0; i < qdev->intr_count; i++) {\r\nDUMP_QDEV_ARRAY(qdev, "%d", msi_x_entry, i, vector);\r\nDUMP_QDEV_ARRAY(qdev, "%d", msi_x_entry, i, entry);\r\n}\r\nfor (i = 0; i < qdev->intr_count; i++) {\r\nDUMP_QDEV_ARRAY(qdev, "%p", intr_context, i, qdev);\r\nDUMP_QDEV_ARRAY(qdev, "%d", intr_context, i, intr);\r\nDUMP_QDEV_ARRAY(qdev, "%d", intr_context, i, hooked);\r\nDUMP_QDEV_ARRAY(qdev, "0x%08x", intr_context, i, intr_en_mask);\r\nDUMP_QDEV_ARRAY(qdev, "0x%08x", intr_context, i, intr_dis_mask);\r\nDUMP_QDEV_ARRAY(qdev, "0x%08x", intr_context, i, intr_read_mask);\r\n}\r\nDUMP_QDEV_FIELD(qdev, "%d", tx_ring_count);\r\nDUMP_QDEV_FIELD(qdev, "%d", rx_ring_count);\r\nDUMP_QDEV_FIELD(qdev, "%d", ring_mem_size);\r\nDUMP_QDEV_FIELD(qdev, "%p", ring_mem);\r\nDUMP_QDEV_FIELD(qdev, "%d", intr_count);\r\nDUMP_QDEV_FIELD(qdev, "%p", tx_ring);\r\nDUMP_QDEV_FIELD(qdev, "%d", rss_ring_count);\r\nDUMP_QDEV_FIELD(qdev, "%p", rx_ring);\r\nDUMP_QDEV_FIELD(qdev, "%d", default_rx_queue);\r\nDUMP_QDEV_FIELD(qdev, "0x%08x", xg_sem_mask);\r\nDUMP_QDEV_FIELD(qdev, "0x%08x", port_link_up);\r\nDUMP_QDEV_FIELD(qdev, "0x%08x", port_init);\r\n}\r\nvoid ql_dump_wqicb(struct wqicb *wqicb)\r\n{\r\npr_err("Dumping wqicb stuff...\n");\r\npr_err("wqicb->len = 0x%x\n", le16_to_cpu(wqicb->len));\r\npr_err("wqicb->flags = %x\n", le16_to_cpu(wqicb->flags));\r\npr_err("wqicb->cq_id_rss = %d\n",\r\nle16_to_cpu(wqicb->cq_id_rss));\r\npr_err("wqicb->rid = 0x%x\n", le16_to_cpu(wqicb->rid));\r\npr_err("wqicb->wq_addr = 0x%llx\n",\r\n(unsigned long long) le64_to_cpu(wqicb->addr));\r\npr_err("wqicb->wq_cnsmr_idx_addr = 0x%llx\n",\r\n(unsigned long long) le64_to_cpu(wqicb->cnsmr_idx_addr));\r\n}\r\nvoid ql_dump_tx_ring(struct tx_ring *tx_ring)\r\n{\r\nif (tx_ring == NULL)\r\nreturn;\r\npr_err("===================== Dumping tx_ring %d ===============\n",\r\ntx_ring->wq_id);\r\npr_err("tx_ring->base = %p\n", tx_ring->wq_base);\r\npr_err("tx_ring->base_dma = 0x%llx\n",\r\n(unsigned long long) tx_ring->wq_base_dma);\r\npr_err("tx_ring->cnsmr_idx_sh_reg, addr = 0x%p, value = %d\n",\r\ntx_ring->cnsmr_idx_sh_reg,\r\ntx_ring->cnsmr_idx_sh_reg\r\n? ql_read_sh_reg(tx_ring->cnsmr_idx_sh_reg) : 0);\r\npr_err("tx_ring->size = %d\n", tx_ring->wq_size);\r\npr_err("tx_ring->len = %d\n", tx_ring->wq_len);\r\npr_err("tx_ring->prod_idx_db_reg = %p\n", tx_ring->prod_idx_db_reg);\r\npr_err("tx_ring->valid_db_reg = %p\n", tx_ring->valid_db_reg);\r\npr_err("tx_ring->prod_idx = %d\n", tx_ring->prod_idx);\r\npr_err("tx_ring->cq_id = %d\n", tx_ring->cq_id);\r\npr_err("tx_ring->wq_id = %d\n", tx_ring->wq_id);\r\npr_err("tx_ring->q = %p\n", tx_ring->q);\r\npr_err("tx_ring->tx_count = %d\n", atomic_read(&tx_ring->tx_count));\r\n}\r\nvoid ql_dump_ricb(struct ricb *ricb)\r\n{\r\nint i;\r\npr_err("===================== Dumping ricb ===============\n");\r\npr_err("Dumping ricb stuff...\n");\r\npr_err("ricb->base_cq = %d\n", ricb->base_cq & 0x1f);\r\npr_err("ricb->flags = %s%s%s%s%s%s%s%s%s\n",\r\nricb->base_cq & RSS_L4K ? "RSS_L4K " : "",\r\nricb->flags & RSS_L6K ? "RSS_L6K " : "",\r\nricb->flags & RSS_LI ? "RSS_LI " : "",\r\nricb->flags & RSS_LB ? "RSS_LB " : "",\r\nricb->flags & RSS_LM ? "RSS_LM " : "",\r\nricb->flags & RSS_RI4 ? "RSS_RI4 " : "",\r\nricb->flags & RSS_RT4 ? "RSS_RT4 " : "",\r\nricb->flags & RSS_RI6 ? "RSS_RI6 " : "",\r\nricb->flags & RSS_RT6 ? "RSS_RT6 " : "");\r\npr_err("ricb->mask = 0x%.04x\n", le16_to_cpu(ricb->mask));\r\nfor (i = 0; i < 16; i++)\r\npr_err("ricb->hash_cq_id[%d] = 0x%.08x\n", i,\r\nle32_to_cpu(ricb->hash_cq_id[i]));\r\nfor (i = 0; i < 10; i++)\r\npr_err("ricb->ipv6_hash_key[%d] = 0x%.08x\n", i,\r\nle32_to_cpu(ricb->ipv6_hash_key[i]));\r\nfor (i = 0; i < 4; i++)\r\npr_err("ricb->ipv4_hash_key[%d] = 0x%.08x\n", i,\r\nle32_to_cpu(ricb->ipv4_hash_key[i]));\r\n}\r\nvoid ql_dump_cqicb(struct cqicb *cqicb)\r\n{\r\npr_err("Dumping cqicb stuff...\n");\r\npr_err("cqicb->msix_vect = %d\n", cqicb->msix_vect);\r\npr_err("cqicb->flags = %x\n", cqicb->flags);\r\npr_err("cqicb->len = %d\n", le16_to_cpu(cqicb->len));\r\npr_err("cqicb->addr = 0x%llx\n",\r\n(unsigned long long) le64_to_cpu(cqicb->addr));\r\npr_err("cqicb->prod_idx_addr = 0x%llx\n",\r\n(unsigned long long) le64_to_cpu(cqicb->prod_idx_addr));\r\npr_err("cqicb->pkt_delay = 0x%.04x\n",\r\nle16_to_cpu(cqicb->pkt_delay));\r\npr_err("cqicb->irq_delay = 0x%.04x\n",\r\nle16_to_cpu(cqicb->irq_delay));\r\npr_err("cqicb->lbq_addr = 0x%llx\n",\r\n(unsigned long long) le64_to_cpu(cqicb->lbq_addr));\r\npr_err("cqicb->lbq_buf_size = 0x%.04x\n",\r\nle16_to_cpu(cqicb->lbq_buf_size));\r\npr_err("cqicb->lbq_len = 0x%.04x\n",\r\nle16_to_cpu(cqicb->lbq_len));\r\npr_err("cqicb->sbq_addr = 0x%llx\n",\r\n(unsigned long long) le64_to_cpu(cqicb->sbq_addr));\r\npr_err("cqicb->sbq_buf_size = 0x%.04x\n",\r\nle16_to_cpu(cqicb->sbq_buf_size));\r\npr_err("cqicb->sbq_len = 0x%.04x\n",\r\nle16_to_cpu(cqicb->sbq_len));\r\n}\r\nvoid ql_dump_rx_ring(struct rx_ring *rx_ring)\r\n{\r\nif (rx_ring == NULL)\r\nreturn;\r\npr_err("===================== Dumping rx_ring %d ===============\n",\r\nrx_ring->cq_id);\r\npr_err("Dumping rx_ring %d, type = %s%s%s\n",\r\nrx_ring->cq_id, rx_ring->type == DEFAULT_Q ? "DEFAULT" : "",\r\nrx_ring->type == TX_Q ? "OUTBOUND COMPLETIONS" : "",\r\nrx_ring->type == RX_Q ? "INBOUND_COMPLETIONS" : "");\r\npr_err("rx_ring->cqicb = %p\n", &rx_ring->cqicb);\r\npr_err("rx_ring->cq_base = %p\n", rx_ring->cq_base);\r\npr_err("rx_ring->cq_base_dma = %llx\n",\r\n(unsigned long long) rx_ring->cq_base_dma);\r\npr_err("rx_ring->cq_size = %d\n", rx_ring->cq_size);\r\npr_err("rx_ring->cq_len = %d\n", rx_ring->cq_len);\r\npr_err("rx_ring->prod_idx_sh_reg, addr = 0x%p, value = %d\n",\r\nrx_ring->prod_idx_sh_reg,\r\nrx_ring->prod_idx_sh_reg\r\n? ql_read_sh_reg(rx_ring->prod_idx_sh_reg) : 0);\r\npr_err("rx_ring->prod_idx_sh_reg_dma = %llx\n",\r\n(unsigned long long) rx_ring->prod_idx_sh_reg_dma);\r\npr_err("rx_ring->cnsmr_idx_db_reg = %p\n",\r\nrx_ring->cnsmr_idx_db_reg);\r\npr_err("rx_ring->cnsmr_idx = %d\n", rx_ring->cnsmr_idx);\r\npr_err("rx_ring->curr_entry = %p\n", rx_ring->curr_entry);\r\npr_err("rx_ring->valid_db_reg = %p\n", rx_ring->valid_db_reg);\r\npr_err("rx_ring->lbq_base = %p\n", rx_ring->lbq_base);\r\npr_err("rx_ring->lbq_base_dma = %llx\n",\r\n(unsigned long long) rx_ring->lbq_base_dma);\r\npr_err("rx_ring->lbq_base_indirect = %p\n",\r\nrx_ring->lbq_base_indirect);\r\npr_err("rx_ring->lbq_base_indirect_dma = %llx\n",\r\n(unsigned long long) rx_ring->lbq_base_indirect_dma);\r\npr_err("rx_ring->lbq = %p\n", rx_ring->lbq);\r\npr_err("rx_ring->lbq_len = %d\n", rx_ring->lbq_len);\r\npr_err("rx_ring->lbq_size = %d\n", rx_ring->lbq_size);\r\npr_err("rx_ring->lbq_prod_idx_db_reg = %p\n",\r\nrx_ring->lbq_prod_idx_db_reg);\r\npr_err("rx_ring->lbq_prod_idx = %d\n", rx_ring->lbq_prod_idx);\r\npr_err("rx_ring->lbq_curr_idx = %d\n", rx_ring->lbq_curr_idx);\r\npr_err("rx_ring->lbq_clean_idx = %d\n", rx_ring->lbq_clean_idx);\r\npr_err("rx_ring->lbq_free_cnt = %d\n", rx_ring->lbq_free_cnt);\r\npr_err("rx_ring->lbq_buf_size = %d\n", rx_ring->lbq_buf_size);\r\npr_err("rx_ring->sbq_base = %p\n", rx_ring->sbq_base);\r\npr_err("rx_ring->sbq_base_dma = %llx\n",\r\n(unsigned long long) rx_ring->sbq_base_dma);\r\npr_err("rx_ring->sbq_base_indirect = %p\n",\r\nrx_ring->sbq_base_indirect);\r\npr_err("rx_ring->sbq_base_indirect_dma = %llx\n",\r\n(unsigned long long) rx_ring->sbq_base_indirect_dma);\r\npr_err("rx_ring->sbq = %p\n", rx_ring->sbq);\r\npr_err("rx_ring->sbq_len = %d\n", rx_ring->sbq_len);\r\npr_err("rx_ring->sbq_size = %d\n", rx_ring->sbq_size);\r\npr_err("rx_ring->sbq_prod_idx_db_reg addr = %p\n",\r\nrx_ring->sbq_prod_idx_db_reg);\r\npr_err("rx_ring->sbq_prod_idx = %d\n", rx_ring->sbq_prod_idx);\r\npr_err("rx_ring->sbq_curr_idx = %d\n", rx_ring->sbq_curr_idx);\r\npr_err("rx_ring->sbq_clean_idx = %d\n", rx_ring->sbq_clean_idx);\r\npr_err("rx_ring->sbq_free_cnt = %d\n", rx_ring->sbq_free_cnt);\r\npr_err("rx_ring->sbq_buf_size = %d\n", rx_ring->sbq_buf_size);\r\npr_err("rx_ring->cq_id = %d\n", rx_ring->cq_id);\r\npr_err("rx_ring->irq = %d\n", rx_ring->irq);\r\npr_err("rx_ring->cpu = %d\n", rx_ring->cpu);\r\npr_err("rx_ring->qdev = %p\n", rx_ring->qdev);\r\n}\r\nvoid ql_dump_hw_cb(struct ql_adapter *qdev, int size, u32 bit, u16 q_id)\r\n{\r\nvoid *ptr;\r\npr_err("%s: Enter\n", __func__);\r\nptr = kmalloc(size, GFP_ATOMIC);\r\nif (ptr == NULL)\r\nreturn;\r\nif (ql_write_cfg(qdev, ptr, size, bit, q_id)) {\r\npr_err("%s: Failed to upload control block!\n", __func__);\r\ngoto fail_it;\r\n}\r\nswitch (bit) {\r\ncase CFG_DRQ:\r\nql_dump_wqicb((struct wqicb *)ptr);\r\nbreak;\r\ncase CFG_DCQ:\r\nql_dump_cqicb((struct cqicb *)ptr);\r\nbreak;\r\ncase CFG_DR:\r\nql_dump_ricb((struct ricb *)ptr);\r\nbreak;\r\ndefault:\r\npr_err("%s: Invalid bit value = %x\n", __func__, bit);\r\nbreak;\r\n}\r\nfail_it:\r\nkfree(ptr);\r\n}\r\nvoid ql_dump_tx_desc(struct tx_buf_desc *tbd)\r\n{\r\npr_err("tbd->addr = 0x%llx\n",\r\nle64_to_cpu((u64) tbd->addr));\r\npr_err("tbd->len = %d\n",\r\nle32_to_cpu(tbd->len & TX_DESC_LEN_MASK));\r\npr_err("tbd->flags = %s %s\n",\r\ntbd->len & TX_DESC_C ? "C" : ".",\r\ntbd->len & TX_DESC_E ? "E" : ".");\r\ntbd++;\r\npr_err("tbd->addr = 0x%llx\n",\r\nle64_to_cpu((u64) tbd->addr));\r\npr_err("tbd->len = %d\n",\r\nle32_to_cpu(tbd->len & TX_DESC_LEN_MASK));\r\npr_err("tbd->flags = %s %s\n",\r\ntbd->len & TX_DESC_C ? "C" : ".",\r\ntbd->len & TX_DESC_E ? "E" : ".");\r\ntbd++;\r\npr_err("tbd->addr = 0x%llx\n",\r\nle64_to_cpu((u64) tbd->addr));\r\npr_err("tbd->len = %d\n",\r\nle32_to_cpu(tbd->len & TX_DESC_LEN_MASK));\r\npr_err("tbd->flags = %s %s\n",\r\ntbd->len & TX_DESC_C ? "C" : ".",\r\ntbd->len & TX_DESC_E ? "E" : ".");\r\n}\r\nvoid ql_dump_ob_mac_iocb(struct ob_mac_iocb_req *ob_mac_iocb)\r\n{\r\nstruct ob_mac_tso_iocb_req *ob_mac_tso_iocb =\r\n(struct ob_mac_tso_iocb_req *)ob_mac_iocb;\r\nstruct tx_buf_desc *tbd;\r\nu16 frame_len;\r\npr_err("%s\n", __func__);\r\npr_err("opcode = %s\n",\r\n(ob_mac_iocb->opcode == OPCODE_OB_MAC_IOCB) ? "MAC" : "TSO");\r\npr_err("flags1 = %s %s %s %s %s\n",\r\nob_mac_tso_iocb->flags1 & OB_MAC_TSO_IOCB_OI ? "OI" : "",\r\nob_mac_tso_iocb->flags1 & OB_MAC_TSO_IOCB_I ? "I" : "",\r\nob_mac_tso_iocb->flags1 & OB_MAC_TSO_IOCB_D ? "D" : "",\r\nob_mac_tso_iocb->flags1 & OB_MAC_TSO_IOCB_IP4 ? "IP4" : "",\r\nob_mac_tso_iocb->flags1 & OB_MAC_TSO_IOCB_IP6 ? "IP6" : "");\r\npr_err("flags2 = %s %s %s\n",\r\nob_mac_tso_iocb->flags2 & OB_MAC_TSO_IOCB_LSO ? "LSO" : "",\r\nob_mac_tso_iocb->flags2 & OB_MAC_TSO_IOCB_UC ? "UC" : "",\r\nob_mac_tso_iocb->flags2 & OB_MAC_TSO_IOCB_TC ? "TC" : "");\r\npr_err("flags3 = %s %s %s\n",\r\nob_mac_tso_iocb->flags3 & OB_MAC_TSO_IOCB_IC ? "IC" : "",\r\nob_mac_tso_iocb->flags3 & OB_MAC_TSO_IOCB_DFP ? "DFP" : "",\r\nob_mac_tso_iocb->flags3 & OB_MAC_TSO_IOCB_V ? "V" : "");\r\npr_err("tid = %x\n", ob_mac_iocb->tid);\r\npr_err("txq_idx = %d\n", ob_mac_iocb->txq_idx);\r\npr_err("vlan_tci = %x\n", ob_mac_tso_iocb->vlan_tci);\r\nif (ob_mac_iocb->opcode == OPCODE_OB_MAC_TSO_IOCB) {\r\npr_err("frame_len = %d\n",\r\nle32_to_cpu(ob_mac_tso_iocb->frame_len));\r\npr_err("mss = %d\n",\r\nle16_to_cpu(ob_mac_tso_iocb->mss));\r\npr_err("prot_hdr_len = %d\n",\r\nle16_to_cpu(ob_mac_tso_iocb->total_hdrs_len));\r\npr_err("hdr_offset = 0x%.04x\n",\r\nle16_to_cpu(ob_mac_tso_iocb->net_trans_offset));\r\nframe_len = le32_to_cpu(ob_mac_tso_iocb->frame_len);\r\n} else {\r\npr_err("frame_len = %d\n",\r\nle16_to_cpu(ob_mac_iocb->frame_len));\r\nframe_len = le16_to_cpu(ob_mac_iocb->frame_len);\r\n}\r\ntbd = &ob_mac_iocb->tbd[0];\r\nql_dump_tx_desc(tbd);\r\n}\r\nvoid ql_dump_ob_mac_rsp(struct ob_mac_iocb_rsp *ob_mac_rsp)\r\n{\r\npr_err("%s\n", __func__);\r\npr_err("opcode = %d\n", ob_mac_rsp->opcode);\r\npr_err("flags = %s %s %s %s %s %s %s\n",\r\nob_mac_rsp->flags1 & OB_MAC_IOCB_RSP_OI ? "OI" : ".",\r\nob_mac_rsp->flags1 & OB_MAC_IOCB_RSP_I ? "I" : ".",\r\nob_mac_rsp->flags1 & OB_MAC_IOCB_RSP_E ? "E" : ".",\r\nob_mac_rsp->flags1 & OB_MAC_IOCB_RSP_S ? "S" : ".",\r\nob_mac_rsp->flags1 & OB_MAC_IOCB_RSP_L ? "L" : ".",\r\nob_mac_rsp->flags1 & OB_MAC_IOCB_RSP_P ? "P" : ".",\r\nob_mac_rsp->flags2 & OB_MAC_IOCB_RSP_B ? "B" : ".");\r\npr_err("tid = %x\n", ob_mac_rsp->tid);\r\n}\r\nvoid ql_dump_ib_mac_rsp(struct ib_mac_iocb_rsp *ib_mac_rsp)\r\n{\r\npr_err("%s\n", __func__);\r\npr_err("opcode = 0x%x\n", ib_mac_rsp->opcode);\r\npr_err("flags1 = %s%s%s%s%s%s\n",\r\nib_mac_rsp->flags1 & IB_MAC_IOCB_RSP_OI ? "OI " : "",\r\nib_mac_rsp->flags1 & IB_MAC_IOCB_RSP_I ? "I " : "",\r\nib_mac_rsp->flags1 & IB_MAC_IOCB_RSP_TE ? "TE " : "",\r\nib_mac_rsp->flags1 & IB_MAC_IOCB_RSP_NU ? "NU " : "",\r\nib_mac_rsp->flags1 & IB_MAC_IOCB_RSP_IE ? "IE " : "",\r\nib_mac_rsp->flags1 & IB_MAC_IOCB_RSP_B ? "B " : "");\r\nif (ib_mac_rsp->flags1 & IB_MAC_IOCB_RSP_M_MASK)\r\npr_err("%s%s%s Multicast\n",\r\n(ib_mac_rsp->flags1 & IB_MAC_IOCB_RSP_M_MASK) ==\r\nIB_MAC_IOCB_RSP_M_HASH ? "Hash" : "",\r\n(ib_mac_rsp->flags1 & IB_MAC_IOCB_RSP_M_MASK) ==\r\nIB_MAC_IOCB_RSP_M_REG ? "Registered" : "",\r\n(ib_mac_rsp->flags1 & IB_MAC_IOCB_RSP_M_MASK) ==\r\nIB_MAC_IOCB_RSP_M_PROM ? "Promiscuous" : "");\r\npr_err("flags2 = %s%s%s%s%s\n",\r\n(ib_mac_rsp->flags2 & IB_MAC_IOCB_RSP_P) ? "P " : "",\r\n(ib_mac_rsp->flags2 & IB_MAC_IOCB_RSP_V) ? "V " : "",\r\n(ib_mac_rsp->flags2 & IB_MAC_IOCB_RSP_U) ? "U " : "",\r\n(ib_mac_rsp->flags2 & IB_MAC_IOCB_RSP_T) ? "T " : "",\r\n(ib_mac_rsp->flags2 & IB_MAC_IOCB_RSP_FO) ? "FO " : "");\r\nif (ib_mac_rsp->flags2 & IB_MAC_IOCB_RSP_ERR_MASK)\r\npr_err("%s%s%s%s%s error\n",\r\n(ib_mac_rsp->flags2 & IB_MAC_IOCB_RSP_ERR_MASK) ==\r\nIB_MAC_IOCB_RSP_ERR_OVERSIZE ? "oversize" : "",\r\n(ib_mac_rsp->flags2 & IB_MAC_IOCB_RSP_ERR_MASK) ==\r\nIB_MAC_IOCB_RSP_ERR_UNDERSIZE ? "undersize" : "",\r\n(ib_mac_rsp->flags2 & IB_MAC_IOCB_RSP_ERR_MASK) ==\r\nIB_MAC_IOCB_RSP_ERR_PREAMBLE ? "preamble" : "",\r\n(ib_mac_rsp->flags2 & IB_MAC_IOCB_RSP_ERR_MASK) ==\r\nIB_MAC_IOCB_RSP_ERR_FRAME_LEN ? "frame length" : "",\r\n(ib_mac_rsp->flags2 & IB_MAC_IOCB_RSP_ERR_MASK) ==\r\nIB_MAC_IOCB_RSP_ERR_CRC ? "CRC" : "");\r\npr_err("flags3 = %s%s\n",\r\nib_mac_rsp->flags3 & IB_MAC_IOCB_RSP_DS ? "DS " : "",\r\nib_mac_rsp->flags3 & IB_MAC_IOCB_RSP_DL ? "DL " : "");\r\nif (ib_mac_rsp->flags3 & IB_MAC_IOCB_RSP_RSS_MASK)\r\npr_err("RSS flags = %s%s%s%s\n",\r\n((ib_mac_rsp->flags3 & IB_MAC_IOCB_RSP_RSS_MASK) ==\r\nIB_MAC_IOCB_RSP_M_IPV4) ? "IPv4 RSS" : "",\r\n((ib_mac_rsp->flags3 & IB_MAC_IOCB_RSP_RSS_MASK) ==\r\nIB_MAC_IOCB_RSP_M_IPV6) ? "IPv6 RSS " : "",\r\n((ib_mac_rsp->flags3 & IB_MAC_IOCB_RSP_RSS_MASK) ==\r\nIB_MAC_IOCB_RSP_M_TCP_V4) ? "TCP/IPv4 RSS" : "",\r\n((ib_mac_rsp->flags3 & IB_MAC_IOCB_RSP_RSS_MASK) ==\r\nIB_MAC_IOCB_RSP_M_TCP_V6) ? "TCP/IPv6 RSS" : "");\r\npr_err("data_len = %d\n",\r\nle32_to_cpu(ib_mac_rsp->data_len));\r\npr_err("data_addr = 0x%llx\n",\r\n(unsigned long long) le64_to_cpu(ib_mac_rsp->data_addr));\r\nif (ib_mac_rsp->flags3 & IB_MAC_IOCB_RSP_RSS_MASK)\r\npr_err("rss = %x\n",\r\nle32_to_cpu(ib_mac_rsp->rss));\r\nif (ib_mac_rsp->flags2 & IB_MAC_IOCB_RSP_V)\r\npr_err("vlan_id = %x\n",\r\nle16_to_cpu(ib_mac_rsp->vlan_id));\r\npr_err("flags4 = %s%s%s\n",\r\nib_mac_rsp->flags4 & IB_MAC_IOCB_RSP_HV ? "HV " : "",\r\nib_mac_rsp->flags4 & IB_MAC_IOCB_RSP_HS ? "HS " : "",\r\nib_mac_rsp->flags4 & IB_MAC_IOCB_RSP_HL ? "HL " : "");\r\nif (ib_mac_rsp->flags4 & IB_MAC_IOCB_RSP_HV) {\r\npr_err("hdr length = %d\n",\r\nle32_to_cpu(ib_mac_rsp->hdr_len));\r\npr_err("hdr addr = 0x%llx\n",\r\n(unsigned long long) le64_to_cpu(ib_mac_rsp->hdr_addr));\r\n}\r\n}\r\nvoid ql_dump_all(struct ql_adapter *qdev)\r\n{\r\nint i;\r\nQL_DUMP_REGS(qdev);\r\nQL_DUMP_QDEV(qdev);\r\nfor (i = 0; i < qdev->tx_ring_count; i++) {\r\nQL_DUMP_TX_RING(&qdev->tx_ring[i]);\r\nQL_DUMP_WQICB((struct wqicb *)&qdev->tx_ring[i]);\r\n}\r\nfor (i = 0; i < qdev->rx_ring_count; i++) {\r\nQL_DUMP_RX_RING(&qdev->rx_ring[i]);\r\nQL_DUMP_CQICB((struct cqicb *)&qdev->rx_ring[i]);\r\n}\r\n}

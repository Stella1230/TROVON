static inline u_char\r\nreadreg(unsigned int ale, unsigned long adr, u_char off)\r\n{\r\nregister u_int ret;\r\nunsigned int *po = (unsigned int *) adr;\r\n*po = (GCS_2 | PO_WRITE | off);\r\n__WAITI20__(po);\r\n*po = (ale | PO_READ);\r\n__WAITI20__(po);\r\nret = *po;\r\nreturn ((unsigned char) ret);\r\n}\r\nstatic inline void\r\nreadfifo(unsigned int ale, unsigned long adr, u_char off, u_char *data, int size)\r\n{\r\nint i;\r\nfor (i = 0; i < size; i++)\r\n*data++ = readreg(ale, adr, off);\r\n}\r\nstatic inline void\r\nwritereg(unsigned int ale, unsigned long adr, u_char off, u_char data)\r\n{\r\nunsigned int *po = (unsigned int *) adr;\r\n*po = (GCS_2 | PO_WRITE | off);\r\n__WAITI20__(po);\r\n*po = (ale | PO_WRITE | data);\r\n__WAITI20__(po);\r\n}\r\nstatic inline void\r\nwritefifo(unsigned int ale, unsigned long adr, u_char off, u_char *data, int size)\r\n{\r\nint i;\r\nfor (i = 0; i < size; i++)\r\nwritereg(ale, adr, off, *data++);\r\n}\r\nstatic u_char\r\nReadISAC(struct IsdnCardState *cs, u_char offset)\r\n{\r\nreturn (readreg(cs->hw.ax.isac_ale, cs->hw.ax.isac_adr, offset));\r\n}\r\nstatic void\r\nWriteISAC(struct IsdnCardState *cs, u_char offset, u_char value)\r\n{\r\nwritereg(cs->hw.ax.isac_ale, cs->hw.ax.isac_adr, offset, value);\r\n}\r\nstatic void\r\nReadISACfifo(struct IsdnCardState *cs, u_char *data, int size)\r\n{\r\nreadfifo(cs->hw.ax.isac_ale, cs->hw.ax.isac_adr, 0, data, size);\r\n}\r\nstatic void\r\nWriteISACfifo(struct IsdnCardState *cs, u_char *data, int size)\r\n{\r\nwritefifo(cs->hw.ax.isac_ale, cs->hw.ax.isac_adr, 0, data, size);\r\n}\r\nstatic u_char\r\nReadJADE(struct IsdnCardState *cs, int jade, u_char offset)\r\n{\r\nreturn (readreg(cs->hw.ax.jade_ale, cs->hw.ax.jade_adr, offset + (jade == -1 ? 0 : (jade ? 0xC0 : 0x80))));\r\n}\r\nstatic void\r\nWriteJADE(struct IsdnCardState *cs, int jade, u_char offset, u_char value)\r\n{\r\nwritereg(cs->hw.ax.jade_ale, cs->hw.ax.jade_adr, offset + (jade == -1 ? 0 : (jade ? 0xC0 : 0x80)), value);\r\n}\r\nstatic irqreturn_t\r\nbkm_interrupt(int intno, void *dev_id)\r\n{\r\nstruct IsdnCardState *cs = dev_id;\r\nu_char val = 0;\r\nu_long flags;\r\nI20_REGISTER_FILE *pI20_Regs;\r\nspin_lock_irqsave(&cs->lock, flags);\r\npI20_Regs = (I20_REGISTER_FILE *) (cs->hw.ax.base);\r\nif (pI20_Regs->i20IntStatus & intISDN) {\r\npI20_Regs->i20IntStatus = intISDN;\r\npI20_Regs->i20IntCtrl &= ~intISDN;\r\nval = readreg(cs->hw.ax.jade_ale, cs->hw.ax.jade_adr, jade_HDLC_ISR + 0x80);\r\nif (val) {\r\njade_int_main(cs, val, 0);\r\n}\r\nval = readreg(cs->hw.ax.jade_ale, cs->hw.ax.jade_adr, jade_HDLC_ISR + 0xC0);\r\nif (val) {\r\njade_int_main(cs, val, 1);\r\n}\r\nval = readreg(cs->hw.ax.isac_ale, cs->hw.ax.isac_adr, ISAC_ISTA);\r\nif (val) {\r\nisac_interrupt(cs, val);\r\n}\r\npI20_Regs->i20IntCtrl |= intISDN;\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn IRQ_HANDLED;\r\n} else {\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn IRQ_NONE;\r\n}\r\n}\r\nstatic void\r\nrelease_io_bkm(struct IsdnCardState *cs)\r\n{\r\nif (cs->hw.ax.base) {\r\niounmap((void *) cs->hw.ax.base);\r\ncs->hw.ax.base = 0;\r\n}\r\n}\r\nstatic void\r\nenable_bkm_int(struct IsdnCardState *cs, unsigned bEnable)\r\n{\r\nif (cs->typ == ISDN_CTYPE_BKM_A4T) {\r\nI20_REGISTER_FILE *pI20_Regs = (I20_REGISTER_FILE *) (cs->hw.ax.base);\r\nif (bEnable)\r\npI20_Regs->i20IntCtrl |= (intISDN | intPCI);\r\nelse\r\npI20_Regs->i20IntCtrl &= ~(intISDN | intPCI);\r\n}\r\n}\r\nstatic void\r\nreset_bkm(struct IsdnCardState *cs)\r\n{\r\nif (cs->typ == ISDN_CTYPE_BKM_A4T) {\r\nI20_REGISTER_FILE *pI20_Regs = (I20_REGISTER_FILE *) (cs->hw.ax.base);\r\npI20_Regs->i20SysControl = 0xFF;\r\nmdelay(10);\r\npI20_Regs->i20SysControl = sysRESET | 0xFF;\r\nmdelay(10);\r\npI20_Regs->i20SysControl = sysRESET | sysCFG;\r\npI20_Regs->i20GuestControl = guestWAIT_CFG |\r\ng_A4T_JADE_RES |\r\ng_A4T_ISAR_RES |\r\ng_A4T_ISAC_RES |\r\ng_A4T_JADE_BOOTR |\r\ng_A4T_ISAR_BOOTR;\r\nmdelay(10);\r\npI20_Regs->i20GuestControl &= ~(g_A4T_ISAC_RES |\r\ng_A4T_JADE_RES |\r\ng_A4T_ISAR_RES);\r\nmdelay(10);\r\n}\r\n}\r\nstatic int\r\nBKM_card_msg(struct IsdnCardState *cs, int mt, void *arg)\r\n{\r\nu_long flags;\r\nswitch (mt) {\r\ncase CARD_RESET:\r\nspin_lock_irqsave(&cs->lock, flags);\r\nenable_bkm_int(cs, 0);\r\nreset_bkm(cs);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn (0);\r\ncase CARD_RELEASE:\r\nspin_lock_irqsave(&cs->lock, flags);\r\nenable_bkm_int(cs, 0);\r\nreset_bkm(cs);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nrelease_io_bkm(cs);\r\nreturn (0);\r\ncase CARD_INIT:\r\nspin_lock_irqsave(&cs->lock, flags);\r\nclear_pending_isac_ints(cs);\r\nclear_pending_jade_ints(cs);\r\ninitisac(cs);\r\ninitjade(cs);\r\nenable_bkm_int(cs, 1);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn (0);\r\ncase CARD_TEST:\r\nreturn (0);\r\n}\r\nreturn (0);\r\n}\r\nstatic int __devinit a4t_pci_probe(struct pci_dev *dev_a4t,\r\nstruct IsdnCardState *cs,\r\nu_int *found,\r\nu_int *pci_memaddr)\r\n{\r\nu16 sub_sys;\r\nu16 sub_vendor;\r\nsub_vendor = dev_a4t->subsystem_vendor;\r\nsub_sys = dev_a4t->subsystem_device;\r\nif ((sub_sys == PCI_DEVICE_ID_BERKOM_A4T) && (sub_vendor == PCI_VENDOR_ID_BERKOM)) {\r\nif (pci_enable_device(dev_a4t))\r\nreturn (0);\r\n*found = 1;\r\n*pci_memaddr = pci_resource_start(dev_a4t, 0);\r\ncs->irq = dev_a4t->irq;\r\nreturn (1);\r\n}\r\nreturn (-1);\r\n}\r\nstatic int __devinit a4t_cs_init(struct IsdnCard *card,\r\nstruct IsdnCardState *cs,\r\nu_int pci_memaddr)\r\n{\r\nI20_REGISTER_FILE *pI20_Regs;\r\nif (!cs->irq) {\r\nprintk(KERN_WARNING "HiSax: Telekom A4T: No IRQ\n");\r\nreturn (0);\r\n}\r\ncs->hw.ax.base = (long) ioremap(pci_memaddr, 4096);\r\npI20_Regs = (I20_REGISTER_FILE *) (cs->hw.ax.base);\r\nif ((pI20_Regs->i20IntStatus & 0x8EFFFFFF) != 0) {\r\nprintk(KERN_WARNING "HiSax: Telekom A4T address "\r\n"%lx-%lx suspicious\n",\r\ncs->hw.ax.base, cs->hw.ax.base + 4096);\r\niounmap((void *) cs->hw.ax.base);\r\ncs->hw.ax.base = 0;\r\nreturn (0);\r\n}\r\ncs->hw.ax.isac_adr = cs->hw.ax.base + PO_OFFSET;\r\ncs->hw.ax.jade_adr = cs->hw.ax.base + PO_OFFSET;\r\ncs->hw.ax.isac_ale = GCS_1;\r\ncs->hw.ax.jade_ale = GCS_3;\r\nprintk(KERN_INFO "HiSax: Telekom A4T: Card configured at "\r\n"0x%lX IRQ %d\n",\r\ncs->hw.ax.base, cs->irq);\r\nsetup_isac(cs);\r\ncs->readisac = &ReadISAC;\r\ncs->writeisac = &WriteISAC;\r\ncs->readisacfifo = &ReadISACfifo;\r\ncs->writeisacfifo = &WriteISACfifo;\r\ncs->BC_Read_Reg = &ReadJADE;\r\ncs->BC_Write_Reg = &WriteJADE;\r\ncs->BC_Send_Data = &jade_fill_fifo;\r\ncs->cardmsg = &BKM_card_msg;\r\ncs->irq_func = &bkm_interrupt;\r\ncs->irq_flags |= IRQF_SHARED;\r\nISACVersion(cs, "Telekom A4T:");\r\nJadeVersion(cs, "Telekom A4T:");\r\nreturn (1);\r\n}\r\nint __devinit\r\nsetup_bkm_a4t(struct IsdnCard *card)\r\n{\r\nstruct IsdnCardState *cs = card->cs;\r\nchar tmp[64];\r\nu_int pci_memaddr = 0, found = 0;\r\nint ret;\r\nstrcpy(tmp, bkm_a4t_revision);\r\nprintk(KERN_INFO "HiSax: T-Berkom driver Rev. %s\n", HiSax_getrev(tmp));\r\nif (cs->typ == ISDN_CTYPE_BKM_A4T) {\r\ncs->subtyp = BKM_A4T;\r\n} else\r\nreturn (0);\r\nwhile ((dev_a4t = hisax_find_pci_device(PCI_VENDOR_ID_ZORAN,\r\nPCI_DEVICE_ID_ZORAN_36120, dev_a4t))) {\r\nret = a4t_pci_probe(dev_a4t, cs, &found, &pci_memaddr);\r\nif (!ret)\r\nreturn (0);\r\nif (ret > 0)\r\nbreak;\r\n}\r\nif (!found) {\r\nprintk(KERN_WARNING "HiSax: Telekom A4T: Card not found\n");\r\nreturn (0);\r\n}\r\nif (!pci_memaddr) {\r\nprintk(KERN_WARNING "HiSax: Telekom A4T: "\r\n"No Memory base address\n");\r\nreturn (0);\r\n}\r\nreturn a4t_cs_init(card, cs, pci_memaddr);\r\n}

static void atakbd_interrupt(unsigned char scancode, char down)\r\n{\r\nif (scancode < 0x72) {\r\nscancode = atakbd_keycode[scancode];\r\nif (scancode == KEY_CAPSLOCK) {\r\ninput_report_key(atakbd_dev, scancode, 1);\r\ninput_report_key(atakbd_dev, scancode, 0);\r\ninput_sync(atakbd_dev);\r\n} else {\r\ninput_report_key(atakbd_dev, scancode, down);\r\ninput_sync(atakbd_dev);\r\n}\r\n} else\r\nprintk(KERN_INFO "atakbd: unhandled scancode %x\n", scancode);\r\nreturn;\r\n}\r\nstatic int __init atakbd_init(void)\r\n{\r\nint i, error;\r\nif (!MACH_IS_ATARI || !ATARIHW_PRESENT(ST_MFP))\r\nreturn -ENODEV;\r\nerror = atari_keyb_init();\r\nif (error)\r\nreturn error;\r\natakbd_dev = input_allocate_device();\r\nif (!atakbd_dev)\r\nreturn -ENOMEM;\r\natakbd_dev->name = "Atari Keyboard";\r\natakbd_dev->phys = "atakbd/input0";\r\natakbd_dev->id.bustype = BUS_HOST;\r\natakbd_dev->id.vendor = 0x0001;\r\natakbd_dev->id.product = 0x0001;\r\natakbd_dev->id.version = 0x0100;\r\natakbd_dev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_REP);\r\natakbd_dev->keycode = atakbd_keycode;\r\natakbd_dev->keycodesize = sizeof(unsigned char);\r\natakbd_dev->keycodemax = ARRAY_SIZE(atakbd_keycode);\r\nfor (i = 1; i < 0x72; i++) {\r\nset_bit(atakbd_keycode[i], atakbd_dev->keybit);\r\n}\r\nerror = input_register_device(atakbd_dev);\r\nif (error) {\r\ninput_free_device(atakbd_dev);\r\nreturn error;\r\n}\r\natari_input_keyboard_interrupt_hook = atakbd_interrupt;\r\nreturn 0;\r\n}\r\nstatic void __exit atakbd_exit(void)\r\n{\r\natari_input_keyboard_interrupt_hook = NULL;\r\ninput_unregister_device(atakbd_dev);\r\n}

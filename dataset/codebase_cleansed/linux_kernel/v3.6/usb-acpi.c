static int usb_acpi_check_upc(struct usb_device *udev, acpi_handle handle)\r\n{\r\nacpi_status status;\r\nstruct acpi_buffer buffer = { ACPI_ALLOCATE_BUFFER, NULL };\r\nunion acpi_object *upc;\r\nint ret = 0;\r\nstatus = acpi_evaluate_object(handle, "_UPC", NULL, &buffer);\r\nif (ACPI_FAILURE(status))\r\nreturn -ENODEV;\r\nupc = buffer.pointer;\r\nif (!upc || (upc->type != ACPI_TYPE_PACKAGE)\r\n|| upc->package.count != 4) {\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nif (upc->package.elements[0].integer.value)\r\nudev->removable = USB_DEVICE_REMOVABLE;\r\nelse\r\nudev->removable = USB_DEVICE_FIXED;\r\nout:\r\nkfree(upc);\r\nreturn ret;\r\n}\r\nstatic int usb_acpi_check_pld(struct usb_device *udev, acpi_handle handle)\r\n{\r\nacpi_status status;\r\nstruct acpi_pld pld;\r\nstatus = acpi_get_physical_device_location(handle, &pld);\r\nif (ACPI_FAILURE(status))\r\nreturn -ENODEV;\r\nif (pld.user_visible)\r\nudev->removable = USB_DEVICE_REMOVABLE;\r\nelse\r\nudev->removable = USB_DEVICE_FIXED;\r\nreturn 0;\r\n}\r\nstatic int usb_acpi_find_device(struct device *dev, acpi_handle *handle)\r\n{\r\nstruct usb_device *udev;\r\nstruct device *parent;\r\nacpi_handle *parent_handle;\r\nif (!is_usb_device(dev))\r\nreturn -ENODEV;\r\nudev = to_usb_device(dev);\r\nparent = dev->parent;\r\nparent_handle = DEVICE_ACPI_HANDLE(parent);\r\nif (!parent_handle)\r\nreturn -ENODEV;\r\n*handle = acpi_get_child(parent_handle, udev->portnum);\r\nif (!*handle)\r\nreturn -ENODEV;\r\nif (usb_acpi_check_pld(udev, *handle) != 0)\r\nusb_acpi_check_upc(udev, *handle);\r\nreturn 0;\r\n}\r\nint usb_acpi_register(void)\r\n{\r\nreturn register_acpi_bus_type(&usb_acpi_bus);\r\n}\r\nvoid usb_acpi_unregister(void)\r\n{\r\nunregister_acpi_bus_type(&usb_acpi_bus);\r\n}

static inline void ep93xx_i2s_write_reg(struct ep93xx_i2s_info *info,\r\nunsigned reg, unsigned val)\r\n{\r\n__raw_writel(val, info->regs + reg);\r\n}\r\nstatic inline unsigned ep93xx_i2s_read_reg(struct ep93xx_i2s_info *info,\r\nunsigned reg)\r\n{\r\nreturn __raw_readl(info->regs + reg);\r\n}\r\nstatic void ep93xx_i2s_enable(struct ep93xx_i2s_info *info, int stream)\r\n{\r\nunsigned base_reg;\r\nint i;\r\nif ((ep93xx_i2s_read_reg(info, EP93XX_I2S_TX0EN) & 0x1) == 0 &&\r\n(ep93xx_i2s_read_reg(info, EP93XX_I2S_RX0EN) & 0x1) == 0) {\r\nclk_enable(info->mclk);\r\nclk_enable(info->sclk);\r\nclk_enable(info->lrclk);\r\nep93xx_i2s_write_reg(info, EP93XX_I2S_GLCTRL, 1);\r\n}\r\nif (stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nbase_reg = EP93XX_I2S_TX0EN;\r\nelse\r\nbase_reg = EP93XX_I2S_RX0EN;\r\nfor (i = 0; i < 3; i++)\r\nep93xx_i2s_write_reg(info, base_reg + (i * 4), 1);\r\n}\r\nstatic void ep93xx_i2s_disable(struct ep93xx_i2s_info *info, int stream)\r\n{\r\nunsigned base_reg;\r\nint i;\r\nif (stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nbase_reg = EP93XX_I2S_TX0EN;\r\nelse\r\nbase_reg = EP93XX_I2S_RX0EN;\r\nfor (i = 0; i < 3; i++)\r\nep93xx_i2s_write_reg(info, base_reg + (i * 4), 0);\r\nif ((ep93xx_i2s_read_reg(info, EP93XX_I2S_TX0EN) & 0x1) == 0 &&\r\n(ep93xx_i2s_read_reg(info, EP93XX_I2S_RX0EN) & 0x1) == 0) {\r\nep93xx_i2s_write_reg(info, EP93XX_I2S_GLCTRL, 0);\r\nclk_disable(info->lrclk);\r\nclk_disable(info->sclk);\r\nclk_disable(info->mclk);\r\n}\r\n}\r\nstatic int ep93xx_i2s_startup(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct ep93xx_i2s_info *info = snd_soc_dai_get_drvdata(dai);\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nsnd_soc_dai_set_dma_data(cpu_dai, substream,\r\n&info->dma_params[substream->stream]);\r\nreturn 0;\r\n}\r\nstatic void ep93xx_i2s_shutdown(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct ep93xx_i2s_info *info = snd_soc_dai_get_drvdata(dai);\r\nep93xx_i2s_disable(info, substream->stream);\r\n}\r\nstatic int ep93xx_i2s_set_dai_fmt(struct snd_soc_dai *cpu_dai,\r\nunsigned int fmt)\r\n{\r\nstruct ep93xx_i2s_info *info = snd_soc_dai_get_drvdata(cpu_dai);\r\nunsigned int clk_cfg, lin_ctrl;\r\nclk_cfg = ep93xx_i2s_read_reg(info, EP93XX_I2S_RXCLKCFG);\r\nlin_ctrl = ep93xx_i2s_read_reg(info, EP93XX_I2S_RXLINCTRLDATA);\r\nswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\r\ncase SND_SOC_DAIFMT_I2S:\r\nclk_cfg |= EP93XX_I2S_CLKCFG_REL;\r\nlin_ctrl &= ~EP93XX_I2S_LINCTRLDATA_R_JUST;\r\nbreak;\r\ncase SND_SOC_DAIFMT_LEFT_J:\r\nclk_cfg &= ~EP93XX_I2S_CLKCFG_REL;\r\nlin_ctrl &= ~EP93XX_I2S_LINCTRLDATA_R_JUST;\r\nbreak;\r\ncase SND_SOC_DAIFMT_RIGHT_J:\r\nclk_cfg &= ~EP93XX_I2S_CLKCFG_REL;\r\nlin_ctrl |= EP93XX_I2S_LINCTRLDATA_R_JUST;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {\r\ncase SND_SOC_DAIFMT_CBS_CFS:\r\nclk_cfg |= EP93XX_I2S_CLKCFG_MASTER;\r\nbreak;\r\ncase SND_SOC_DAIFMT_CBM_CFM:\r\nclk_cfg &= ~EP93XX_I2S_CLKCFG_MASTER;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (fmt & SND_SOC_DAIFMT_INV_MASK) {\r\ncase SND_SOC_DAIFMT_NB_NF:\r\nclk_cfg &= ~(EP93XX_I2S_CLKCFG_CKP | EP93XX_I2S_CLKCFG_REL);\r\nbreak;\r\ncase SND_SOC_DAIFMT_NB_IF:\r\nclk_cfg &= ~EP93XX_I2S_CLKCFG_CKP;\r\nclk_cfg |= EP93XX_I2S_CLKCFG_REL;\r\nbreak;\r\ncase SND_SOC_DAIFMT_IB_NF:\r\nclk_cfg |= EP93XX_I2S_CLKCFG_CKP;\r\nclk_cfg &= ~EP93XX_I2S_CLKCFG_REL;\r\nbreak;\r\ncase SND_SOC_DAIFMT_IB_IF:\r\nclk_cfg |= EP93XX_I2S_CLKCFG_CKP | EP93XX_I2S_CLKCFG_REL;\r\nbreak;\r\n}\r\nep93xx_i2s_write_reg(info, EP93XX_I2S_RXCLKCFG, clk_cfg);\r\nep93xx_i2s_write_reg(info, EP93XX_I2S_TXCLKCFG, clk_cfg);\r\nep93xx_i2s_write_reg(info, EP93XX_I2S_RXLINCTRLDATA, lin_ctrl);\r\nep93xx_i2s_write_reg(info, EP93XX_I2S_TXLINCTRLDATA, lin_ctrl);\r\nreturn 0;\r\n}\r\nstatic int ep93xx_i2s_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct ep93xx_i2s_info *info = snd_soc_dai_get_drvdata(dai);\r\nunsigned word_len, div, sdiv, lrdiv;\r\nint err;\r\nswitch (params_format(params)) {\r\ncase SNDRV_PCM_FORMAT_S16_LE:\r\nword_len = EP93XX_I2S_WRDLEN_16;\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S24_LE:\r\nword_len = EP93XX_I2S_WRDLEN_24;\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S32_LE:\r\nword_len = EP93XX_I2S_WRDLEN_32;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nep93xx_i2s_write_reg(info, EP93XX_I2S_TXWRDLEN, word_len);\r\nelse\r\nep93xx_i2s_write_reg(info, EP93XX_I2S_RXWRDLEN, word_len);\r\ndiv = clk_get_rate(info->mclk) / params_rate(params);\r\nsdiv = 4;\r\nif (div > (256 + 512) / 2) {\r\nlrdiv = 128;\r\n} else {\r\nlrdiv = 64;\r\nif (div < (128 + 256) / 2)\r\nsdiv = 2;\r\n}\r\nerr = clk_set_rate(info->sclk, clk_get_rate(info->mclk) / sdiv);\r\nif (err)\r\nreturn err;\r\nerr = clk_set_rate(info->lrclk, clk_get_rate(info->sclk) / lrdiv);\r\nif (err)\r\nreturn err;\r\nep93xx_i2s_enable(info, substream->stream);\r\nreturn 0;\r\n}\r\nstatic int ep93xx_i2s_set_sysclk(struct snd_soc_dai *cpu_dai, int clk_id,\r\nunsigned int freq, int dir)\r\n{\r\nstruct ep93xx_i2s_info *info = snd_soc_dai_get_drvdata(cpu_dai);\r\nif (dir == SND_SOC_CLOCK_IN || clk_id != 0)\r\nreturn -EINVAL;\r\nreturn clk_set_rate(info->mclk, freq);\r\n}\r\nstatic int ep93xx_i2s_suspend(struct snd_soc_dai *dai)\r\n{\r\nstruct ep93xx_i2s_info *info = snd_soc_dai_get_drvdata(dai);\r\nif (!dai->active)\r\nreturn 0;\r\nep93xx_i2s_disable(info, SNDRV_PCM_STREAM_PLAYBACK);\r\nep93xx_i2s_disable(info, SNDRV_PCM_STREAM_CAPTURE);\r\nreturn 0;\r\n}\r\nstatic int ep93xx_i2s_resume(struct snd_soc_dai *dai)\r\n{\r\nstruct ep93xx_i2s_info *info = snd_soc_dai_get_drvdata(dai);\r\nif (!dai->active)\r\nreturn 0;\r\nep93xx_i2s_enable(info, SNDRV_PCM_STREAM_PLAYBACK);\r\nep93xx_i2s_enable(info, SNDRV_PCM_STREAM_CAPTURE);\r\nreturn 0;\r\n}\r\nstatic int ep93xx_i2s_probe(struct platform_device *pdev)\r\n{\r\nstruct ep93xx_i2s_info *info;\r\nstruct resource *res;\r\nint err;\r\ninfo = devm_kzalloc(&pdev->dev, sizeof(*info), GFP_KERNEL);\r\nif (!info)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENODEV;\r\ninfo->regs = devm_request_and_ioremap(&pdev->dev, res);\r\nif (!info->regs)\r\nreturn -ENXIO;\r\ninfo->mclk = clk_get(&pdev->dev, "mclk");\r\nif (IS_ERR(info->mclk)) {\r\nerr = PTR_ERR(info->mclk);\r\ngoto fail;\r\n}\r\ninfo->sclk = clk_get(&pdev->dev, "sclk");\r\nif (IS_ERR(info->sclk)) {\r\nerr = PTR_ERR(info->sclk);\r\ngoto fail_put_mclk;\r\n}\r\ninfo->lrclk = clk_get(&pdev->dev, "lrclk");\r\nif (IS_ERR(info->lrclk)) {\r\nerr = PTR_ERR(info->lrclk);\r\ngoto fail_put_sclk;\r\n}\r\ndev_set_drvdata(&pdev->dev, info);\r\ninfo->dma_params = ep93xx_i2s_dma_params;\r\nerr = snd_soc_register_dai(&pdev->dev, &ep93xx_i2s_dai);\r\nif (err)\r\ngoto fail_put_lrclk;\r\nreturn 0;\r\nfail_put_lrclk:\r\ndev_set_drvdata(&pdev->dev, NULL);\r\nclk_put(info->lrclk);\r\nfail_put_sclk:\r\nclk_put(info->sclk);\r\nfail_put_mclk:\r\nclk_put(info->mclk);\r\nfail:\r\nreturn err;\r\n}\r\nstatic int __devexit ep93xx_i2s_remove(struct platform_device *pdev)\r\n{\r\nstruct ep93xx_i2s_info *info = dev_get_drvdata(&pdev->dev);\r\nsnd_soc_unregister_dai(&pdev->dev);\r\ndev_set_drvdata(&pdev->dev, NULL);\r\nclk_put(info->lrclk);\r\nclk_put(info->sclk);\r\nclk_put(info->mclk);\r\nreturn 0;\r\n}

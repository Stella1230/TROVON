static void ir_handle_key(struct bttv *btv)\r\n{\r\nstruct bttv_ir *ir = btv->remote;\r\nu32 gpio,data;\r\ngpio = bttv_gpio_read(&btv->c);\r\nif (ir->polling) {\r\nif (ir->last_gpio == gpio)\r\nreturn;\r\nir->last_gpio = gpio;\r\n}\r\ndata = ir_extract_bits(gpio, ir->mask_keycode);\r\ndprintk("irq gpio=0x%x code=%d | %s%s%s\n",\r\ngpio, data,\r\nir->polling ? "poll" : "irq",\r\n(gpio & ir->mask_keydown) ? " down" : "",\r\n(gpio & ir->mask_keyup) ? " up" : "");\r\nif ((ir->mask_keydown && (gpio & ir->mask_keydown)) ||\r\n(ir->mask_keyup && !(gpio & ir->mask_keyup))) {\r\nrc_keydown_notimeout(ir->dev, data, 0);\r\n} else {\r\nif (btv->c.type == BTTV_BOARD_WINFAST2000)\r\nrc_keydown_notimeout(ir->dev, data, 0);\r\nrc_keyup(ir->dev);\r\n}\r\n}\r\nstatic void ir_enltv_handle_key(struct bttv *btv)\r\n{\r\nstruct bttv_ir *ir = btv->remote;\r\nu32 gpio, data, keyup;\r\ngpio = bttv_gpio_read(&btv->c);\r\ndata = ir_extract_bits(gpio, ir->mask_keycode);\r\nkeyup = (gpio & ir->mask_keyup) ? 1 << 31 : 0;\r\nif ((ir->last_gpio & 0x7f) != data) {\r\ndprintk("gpio=0x%x code=%d | %s\n",\r\ngpio, data,\r\n(gpio & ir->mask_keyup) ? " up" : "up/down");\r\nrc_keydown_notimeout(ir->dev, data, 0);\r\nif (keyup)\r\nrc_keyup(ir->dev);\r\n} else {\r\nif ((ir->last_gpio & 1 << 31) == keyup)\r\nreturn;\r\ndprintk("(cnt) gpio=0x%x code=%d | %s\n",\r\ngpio, data,\r\n(gpio & ir->mask_keyup) ? " up" : "down");\r\nif (keyup)\r\nrc_keyup(ir->dev);\r\nelse\r\nrc_keydown_notimeout(ir->dev, data, 0);\r\n}\r\nir->last_gpio = data | keyup;\r\n}\r\nvoid bttv_input_irq(struct bttv *btv)\r\n{\r\nstruct bttv_ir *ir = btv->remote;\r\nif (ir->rc5_gpio)\r\nbttv_rc5_irq(btv);\r\nelse if (!ir->polling)\r\nir_handle_key(btv);\r\n}\r\nstatic void bttv_input_timer(unsigned long data)\r\n{\r\nstruct bttv *btv = (struct bttv*)data;\r\nstruct bttv_ir *ir = btv->remote;\r\nif (btv->c.type == BTTV_BOARD_ENLTV_FM_2)\r\nir_enltv_handle_key(btv);\r\nelse\r\nir_handle_key(btv);\r\nmod_timer(&ir->timer, jiffies + msecs_to_jiffies(ir->polling));\r\n}\r\nstatic u32 bttv_rc5_decode(unsigned int code)\r\n{\r\nunsigned int org_code = code;\r\nunsigned int pair;\r\nunsigned int rc5 = 0;\r\nint i;\r\nfor (i = 0; i < 14; ++i) {\r\npair = code & 0x3;\r\ncode >>= 2;\r\nrc5 <<= 1;\r\nswitch (pair) {\r\ncase 0:\r\ncase 2:\r\nbreak;\r\ncase 1:\r\nrc5 |= 1;\r\nbreak;\r\ncase 3:\r\ndprintk("rc5_decode(%x) bad code\n",\r\norg_code);\r\nreturn 0;\r\n}\r\n}\r\ndprintk("code=%x, rc5=%x, start=%x, toggle=%x, address=%x, "\r\n"instr=%x\n", rc5, org_code, RC5_START(rc5),\r\nRC5_TOGGLE(rc5), RC5_ADDR(rc5), RC5_INSTR(rc5));\r\nreturn rc5;\r\n}\r\nstatic void bttv_rc5_timer_end(unsigned long data)\r\n{\r\nstruct bttv_ir *ir = (struct bttv_ir *)data;\r\nstruct timeval tv;\r\nu32 gap;\r\nu32 rc5 = 0;\r\ndo_gettimeofday(&tv);\r\nif (tv.tv_sec - ir->base_time.tv_sec > 1) {\r\ngap = 200000;\r\n} else {\r\ngap = 1000000 * (tv.tv_sec - ir->base_time.tv_sec) +\r\ntv.tv_usec - ir->base_time.tv_usec;\r\n}\r\nir->active = false;\r\nif (gap < 28000) {\r\ndprintk("spurious timer_end\n");\r\nreturn;\r\n}\r\nif (ir->last_bit < 20) {\r\ndprintk("short code: %x\n", ir->code);\r\n} else {\r\nir->code = (ir->code << ir->shift_by) | 1;\r\nrc5 = bttv_rc5_decode(ir->code);\r\nif (RC5_START(rc5) != ir->start) {\r\npr_info(DEVNAME ":"\r\n" rc5 start bits invalid: %u\n", RC5_START(rc5));\r\n} else if (RC5_ADDR(rc5) == ir->addr) {\r\nu32 toggle = RC5_TOGGLE(rc5);\r\nu32 instr = RC5_INSTR(rc5);\r\nrc_keydown(ir->dev, instr, toggle);\r\ndprintk("instruction %x, toggle %x\n",\r\ninstr, toggle);\r\n}\r\n}\r\n}\r\nstatic int bttv_rc5_irq(struct bttv *btv)\r\n{\r\nstruct bttv_ir *ir = btv->remote;\r\nstruct timeval tv;\r\nu32 gpio;\r\nu32 gap;\r\nunsigned long current_jiffies;\r\ngpio = bttv_gpio_read(&btv->c);\r\ncurrent_jiffies = jiffies;\r\ndo_gettimeofday(&tv);\r\nif (tv.tv_sec - ir->base_time.tv_sec > 1) {\r\ngap = 200000;\r\n} else {\r\ngap = 1000000 * (tv.tv_sec - ir->base_time.tv_sec) +\r\ntv.tv_usec - ir->base_time.tv_usec;\r\n}\r\ndprintk("RC5 IRQ: gap %d us for %s\n",\r\ngap, (gpio & 0x20) ? "mark" : "space");\r\nif (!(gpio & 0x20))\r\nreturn 0;\r\nif (ir->active) {\r\nif (ir->last_bit < 28) {\r\nir->last_bit = (gap - ir_rc5_remote_gap / 2) /\r\nir_rc5_remote_gap;\r\nir->code |= 1 << ir->last_bit;\r\n}\r\n} else {\r\nir->active = true;\r\nir->code = 0;\r\nir->base_time = tv;\r\nir->last_bit = 0;\r\nmod_timer(&ir->timer, current_jiffies + msecs_to_jiffies(30));\r\n}\r\nbttv_gpio_write(&btv->c, gpio & ~(1 << 4));\r\nbttv_gpio_write(&btv->c, gpio | (1 << 4));\r\nreturn 1;\r\n}\r\nstatic void bttv_ir_start(struct bttv *btv, struct bttv_ir *ir)\r\n{\r\nif (ir->polling) {\r\nsetup_timer(&ir->timer, bttv_input_timer, (unsigned long)btv);\r\nir->timer.expires = jiffies + msecs_to_jiffies(1000);\r\nadd_timer(&ir->timer);\r\n} else if (ir->rc5_gpio) {\r\nsetup_timer(&ir->timer, bttv_rc5_timer_end, (unsigned long)ir);\r\nir->shift_by = 1;\r\nir->start = 3;\r\nir->addr = 0x0;\r\nir->rc5_remote_gap = ir_rc5_remote_gap;\r\n}\r\n}\r\nstatic void bttv_ir_stop(struct bttv *btv)\r\n{\r\nif (btv->remote->polling)\r\ndel_timer_sync(&btv->remote->timer);\r\nif (btv->remote->rc5_gpio) {\r\nu32 gpio;\r\ndel_timer_sync(&btv->remote->timer);\r\ngpio = bttv_gpio_read(&btv->c);\r\nbttv_gpio_write(&btv->c, gpio & ~(1 << 4));\r\n}\r\n}\r\nstatic int get_key_pv951(struct IR_i2c *ir, u32 *ir_key, u32 *ir_raw)\r\n{\r\nunsigned char b;\r\nif (1 != i2c_master_recv(ir->c, &b, 1)) {\r\ndprintk("read error\n");\r\nreturn -EIO;\r\n}\r\nif (b==0xaa)\r\nreturn 0;\r\ndprintk("key %02x\n", b);\r\n*ir_key = b;\r\n*ir_raw = b;\r\nreturn 1;\r\n}\r\nvoid __devinit init_bttv_i2c_ir(struct bttv *btv)\r\n{\r\nconst unsigned short addr_list[] = {\r\n0x1a, 0x18, 0x64, 0x30, 0x71,\r\nI2C_CLIENT_END\r\n};\r\nstruct i2c_board_info info;\r\nif (0 != btv->i2c_rc)\r\nreturn;\r\nmemset(&info, 0, sizeof(struct i2c_board_info));\r\nmemset(&btv->init_data, 0, sizeof(btv->init_data));\r\nstrlcpy(info.type, "ir_video", I2C_NAME_SIZE);\r\nswitch (btv->c.type) {\r\ncase BTTV_BOARD_PV951:\r\nbtv->init_data.name = "PV951";\r\nbtv->init_data.get_key = get_key_pv951;\r\nbtv->init_data.ir_codes = RC_MAP_PV951;\r\ninfo.addr = 0x4b;\r\nbreak;\r\ndefault:\r\ni2c_new_probed_device(&btv->c.i2c_adap, &info, addr_list, NULL);\r\nreturn;\r\n}\r\nif (btv->init_data.name)\r\ninfo.platform_data = &btv->init_data;\r\ni2c_new_device(&btv->c.i2c_adap, &info);\r\nreturn;\r\n}\r\nint __devexit fini_bttv_i2c(struct bttv *btv)\r\n{\r\nif (0 != btv->i2c_rc)\r\nreturn 0;\r\nreturn i2c_del_adapter(&btv->c.i2c_adap);\r\n}\r\nint bttv_input_init(struct bttv *btv)\r\n{\r\nstruct bttv_ir *ir;\r\nchar *ir_codes = NULL;\r\nstruct rc_dev *rc;\r\nint err = -ENOMEM;\r\nif (!btv->has_remote)\r\nreturn -ENODEV;\r\nir = kzalloc(sizeof(*ir),GFP_KERNEL);\r\nrc = rc_allocate_device();\r\nif (!ir || !rc)\r\ngoto err_out_free;\r\nswitch (btv->c.type) {\r\ncase BTTV_BOARD_AVERMEDIA:\r\ncase BTTV_BOARD_AVPHONE98:\r\ncase BTTV_BOARD_AVERMEDIA98:\r\nir_codes = RC_MAP_AVERMEDIA;\r\nir->mask_keycode = 0xf88000;\r\nir->mask_keydown = 0x010000;\r\nir->polling = 50;\r\nbreak;\r\ncase BTTV_BOARD_AVDVBT_761:\r\ncase BTTV_BOARD_AVDVBT_771:\r\nir_codes = RC_MAP_AVERMEDIA_DVBT;\r\nir->mask_keycode = 0x0f00c0;\r\nir->mask_keydown = 0x000020;\r\nir->polling = 50;\r\nbreak;\r\ncase BTTV_BOARD_PXELVWPLTVPAK:\r\nir_codes = RC_MAP_PIXELVIEW;\r\nir->mask_keycode = 0x003e00;\r\nir->mask_keyup = 0x010000;\r\nir->polling = 50;\r\nbreak;\r\ncase BTTV_BOARD_PV_M4900:\r\ncase BTTV_BOARD_PV_BT878P_9B:\r\ncase BTTV_BOARD_PV_BT878P_PLUS:\r\nir_codes = RC_MAP_PIXELVIEW;\r\nir->mask_keycode = 0x001f00;\r\nir->mask_keyup = 0x008000;\r\nir->polling = 50;\r\nbreak;\r\ncase BTTV_BOARD_WINFAST2000:\r\nir_codes = RC_MAP_WINFAST;\r\nir->mask_keycode = 0x1f8;\r\nbreak;\r\ncase BTTV_BOARD_MAGICTVIEW061:\r\ncase BTTV_BOARD_MAGICTVIEW063:\r\nir_codes = RC_MAP_WINFAST;\r\nir->mask_keycode = 0x0008e000;\r\nir->mask_keydown = 0x00200000;\r\nbreak;\r\ncase BTTV_BOARD_APAC_VIEWCOMP:\r\nir_codes = RC_MAP_APAC_VIEWCOMP;\r\nir->mask_keycode = 0x001f00;\r\nir->mask_keyup = 0x008000;\r\nir->polling = 50;\r\nbreak;\r\ncase BTTV_BOARD_ASKEY_CPH03X:\r\ncase BTTV_BOARD_CONCEPTRONIC_CTVFMI2:\r\ncase BTTV_BOARD_CONTVFMI:\r\nir_codes = RC_MAP_PIXELVIEW;\r\nir->mask_keycode = 0x001F00;\r\nir->mask_keyup = 0x006000;\r\nir->polling = 50;\r\nbreak;\r\ncase BTTV_BOARD_NEBULA_DIGITV:\r\nir_codes = RC_MAP_NEBULA;\r\nir->rc5_gpio = true;\r\nbreak;\r\ncase BTTV_BOARD_MACHTV_MAGICTV:\r\nir_codes = RC_MAP_APAC_VIEWCOMP;\r\nir->mask_keycode = 0x001F00;\r\nir->mask_keyup = 0x004000;\r\nir->polling = 50;\r\nbreak;\r\ncase BTTV_BOARD_KOZUMI_KTV_01C:\r\nir_codes = RC_MAP_PCTV_SEDNA;\r\nir->mask_keycode = 0x001f00;\r\nir->mask_keyup = 0x006000;\r\nir->polling = 50;\r\nbreak;\r\ncase BTTV_BOARD_ENLTV_FM_2:\r\nir_codes = RC_MAP_ENCORE_ENLTV2;\r\nir->mask_keycode = 0x00fd00;\r\nir->mask_keyup = 0x000080;\r\nir->polling = 1;\r\nir->last_gpio = ir_extract_bits(bttv_gpio_read(&btv->c),\r\nir->mask_keycode);\r\nbreak;\r\n}\r\nif (NULL == ir_codes) {\r\ndprintk("Ooops: IR config error [card=%d]\n", btv->c.type);\r\nerr = -ENODEV;\r\ngoto err_out_free;\r\n}\r\nif (ir->rc5_gpio) {\r\nu32 gpio;\r\nbttv_gpio_inout(&btv->c, (1 << 4), 1 << 4);\r\ngpio = bttv_gpio_read(&btv->c);\r\nbttv_gpio_write(&btv->c, gpio & ~(1 << 4));\r\nbttv_gpio_write(&btv->c, gpio | (1 << 4));\r\n} else {\r\nbttv_gpio_inout(&btv->c, ir->mask_keycode | ir->mask_keydown, 0);\r\n}\r\nir->dev = rc;\r\nsnprintf(ir->name, sizeof(ir->name), "bttv IR (card=%d)",\r\nbtv->c.type);\r\nsnprintf(ir->phys, sizeof(ir->phys), "pci-%s/ir0",\r\npci_name(btv->c.pci));\r\nrc->input_name = ir->name;\r\nrc->input_phys = ir->phys;\r\nrc->input_id.bustype = BUS_PCI;\r\nrc->input_id.version = 1;\r\nif (btv->c.pci->subsystem_vendor) {\r\nrc->input_id.vendor = btv->c.pci->subsystem_vendor;\r\nrc->input_id.product = btv->c.pci->subsystem_device;\r\n} else {\r\nrc->input_id.vendor = btv->c.pci->vendor;\r\nrc->input_id.product = btv->c.pci->device;\r\n}\r\nrc->dev.parent = &btv->c.pci->dev;\r\nrc->map_name = ir_codes;\r\nrc->driver_name = MODULE_NAME;\r\nbtv->remote = ir;\r\nbttv_ir_start(btv, ir);\r\nerr = rc_register_device(rc);\r\nif (err)\r\ngoto err_out_stop;\r\nreturn 0;\r\nerr_out_stop:\r\nbttv_ir_stop(btv);\r\nbtv->remote = NULL;\r\nerr_out_free:\r\nrc_free_device(rc);\r\nkfree(ir);\r\nreturn err;\r\n}\r\nvoid bttv_input_fini(struct bttv *btv)\r\n{\r\nif (btv->remote == NULL)\r\nreturn;\r\nbttv_ir_stop(btv);\r\nrc_unregister_device(btv->remote->dev);\r\nkfree(btv->remote);\r\nbtv->remote = NULL;\r\n}

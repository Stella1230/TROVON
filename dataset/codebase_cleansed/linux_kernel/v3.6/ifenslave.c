int main(int argc, char *argv[])\r\n{\r\nchar **spp, *master_ifname, *slave_ifname;\r\nint c, i, rv;\r\nint res = 0;\r\nint exclusive = 0;\r\nwhile ((c = getopt_long(argc, argv, "acdfhuvV", longopts, 0)) != EOF) {\r\nswitch (c) {\r\ncase 'a': opt_a++; exclusive++; break;\r\ncase 'c': opt_c++; exclusive++; break;\r\ncase 'd': opt_d++; exclusive++; break;\r\ncase 'f': opt_f++; exclusive++; break;\r\ncase 'h': opt_h++; exclusive++; break;\r\ncase 'u': opt_u++; exclusive++; break;\r\ncase 'v': opt_v++; break;\r\ncase 'V': opt_V++; exclusive++; break;\r\ncase '?':\r\nfprintf(stderr, "%s", usage_msg);\r\nres = 2;\r\ngoto out;\r\n}\r\n}\r\nif (exclusive > 1) {\r\nfprintf(stderr, "%s", usage_msg);\r\nres = 2;\r\ngoto out;\r\n}\r\nif (opt_v || opt_V) {\r\nprintf("%s", version);\r\nif (opt_V) {\r\nres = 0;\r\ngoto out;\r\n}\r\n}\r\nif (opt_u) {\r\nprintf("%s", usage_msg);\r\nres = 0;\r\ngoto out;\r\n}\r\nif (opt_h) {\r\nprintf("%s", usage_msg);\r\nprintf("%s", help_msg);\r\nres = 0;\r\ngoto out;\r\n}\r\nif ((skfd = socket(AF_INET, SOCK_DGRAM, 0)) < 0) {\r\nperror("socket");\r\nres = 1;\r\ngoto out;\r\n}\r\nif (opt_a) {\r\nif (optind == argc) {\r\nif_print((char *)NULL);\r\ngoto out;\r\n} else {\r\nfprintf(stderr, "%s", usage_msg);\r\nres = 2;\r\ngoto out;\r\n}\r\n}\r\nspp = argv + optind;\r\nmaster_ifname = *spp++;\r\nif (master_ifname == NULL) {\r\nfprintf(stderr, "%s", usage_msg);\r\nres = 2;\r\ngoto out;\r\n}\r\nres = get_drv_info(master_ifname);\r\nif (res) {\r\nfprintf(stderr,\r\n"Master '%s': Error: handshake with driver failed. "\r\n"Aborting\n",\r\nmaster_ifname);\r\ngoto out;\r\n}\r\nslave_ifname = *spp++;\r\nif (slave_ifname == NULL) {\r\nif (opt_d || opt_c) {\r\nfprintf(stderr, "%s", usage_msg);\r\nres = 2;\r\ngoto out;\r\n}\r\nif_print(master_ifname);\r\ngoto out;\r\n}\r\nres = get_if_settings(master_ifname, master_ifra);\r\nif (res) {\r\nfprintf(stderr,\r\n"Master '%s': Error: get settings failed: %s. "\r\n"Aborting\n",\r\nmaster_ifname, strerror(res));\r\ngoto out;\r\n}\r\nif (!(master_flags.ifr_flags & IFF_MASTER)) {\r\nfprintf(stderr,\r\n"Illegal operation; the specified interface '%s' "\r\n"is not a master. Aborting\n",\r\nmaster_ifname);\r\nres = 1;\r\ngoto out;\r\n}\r\nif (!(master_flags.ifr_flags & IFF_UP)) {\r\nfprintf(stderr,\r\n"Illegal operation; the specified master interface "\r\n"'%s' is not up.\n",\r\nmaster_ifname);\r\nres = 1;\r\ngoto out;\r\n}\r\nif (!opt_c && !opt_d) {\r\nsa_family_t master_family = master_hwaddr.ifr_hwaddr.sa_family;\r\nunsigned char *hwaddr =\r\n(unsigned char *)master_hwaddr.ifr_hwaddr.sa_data;\r\nif (master_family != 1 && !opt_f) {\r\nfprintf(stderr,\r\n"Illegal operation: The specified master "\r\n"interface '%s' is not ethernet-like.\n "\r\n"This program is designed to work with "\r\n"ethernet-like network interfaces.\n "\r\n"Use the '-f' option to force the "\r\n"operation.\n",\r\nmaster_ifname);\r\nres = 1;\r\ngoto out;\r\n}\r\nfor (i = 0; i < 6; i++) {\r\nif (hwaddr[i] != 0) {\r\nhwaddr_set = 1;\r\nbreak;\r\n}\r\n}\r\nif (hwaddr_set) {\r\nv_print("current hardware address of master '%s' "\r\n"is %2.2x:%2.2x:%2.2x:%2.2x:%2.2x:%2.2x, "\r\n"type %d\n",\r\nmaster_ifname,\r\nhwaddr[0], hwaddr[1],\r\nhwaddr[2], hwaddr[3],\r\nhwaddr[4], hwaddr[5],\r\nmaster_family);\r\n}\r\n}\r\nif (opt_c) {\r\nres = get_slave_flags(slave_ifname);\r\nif (res) {\r\nfprintf(stderr,\r\n"Slave '%s': Error: get flags failed. "\r\n"Aborting\n",\r\nslave_ifname);\r\ngoto out;\r\n}\r\nres = change_active(master_ifname, slave_ifname);\r\nif (res) {\r\nfprintf(stderr,\r\n"Master '%s', Slave '%s': Error: "\r\n"Change active failed\n",\r\nmaster_ifname, slave_ifname);\r\n}\r\n} else {\r\ndo {\r\nif (opt_d) {\r\nrv = get_slave_flags(slave_ifname);\r\nif (rv) {\r\nfprintf(stderr,\r\n"Slave '%s': Error: get flags "\r\n"failed. Skipping\n",\r\nslave_ifname);\r\nres = rv;\r\ncontinue;\r\n}\r\nrv = release(master_ifname, slave_ifname);\r\nif (rv) {\r\nfprintf(stderr,\r\n"Master '%s', Slave '%s': Error: "\r\n"Release failed\n",\r\nmaster_ifname, slave_ifname);\r\nres = rv;\r\n}\r\n} else {\r\nrv = get_if_settings(slave_ifname, slave_ifra);\r\nif (rv) {\r\nfprintf(stderr,\r\n"Slave '%s': Error: get "\r\n"settings failed: %s. "\r\n"Skipping\n",\r\nslave_ifname, strerror(rv));\r\nres = rv;\r\ncontinue;\r\n}\r\nrv = enslave(master_ifname, slave_ifname);\r\nif (rv) {\r\nfprintf(stderr,\r\n"Master '%s', Slave '%s': Error: "\r\n"Enslave failed\n",\r\nmaster_ifname, slave_ifname);\r\nres = rv;\r\n}\r\n}\r\n} while ((slave_ifname = *spp++) != NULL);\r\n}\r\nout:\r\nif (skfd >= 0) {\r\nclose(skfd);\r\n}\r\nreturn res;\r\n}\r\nstatic int if_getconfig(char *ifname)\r\n{\r\nstruct ifreq ifr;\r\nint metric, mtu;\r\nstruct sockaddr dstaddr, broadaddr, netmask;\r\nunsigned char *hwaddr;\r\nstrcpy(ifr.ifr_name, ifname);\r\nif (ioctl(skfd, SIOCGIFFLAGS, &ifr) < 0)\r\nreturn -1;\r\nmif_flags = ifr.ifr_flags;\r\nprintf("The result of SIOCGIFFLAGS on %s is %x.\n",\r\nifname, ifr.ifr_flags);\r\nstrcpy(ifr.ifr_name, ifname);\r\nif (ioctl(skfd, SIOCGIFADDR, &ifr) < 0)\r\nreturn -1;\r\nprintf("The result of SIOCGIFADDR is %2.2x.%2.2x.%2.2x.%2.2x.\n",\r\nifr.ifr_addr.sa_data[0], ifr.ifr_addr.sa_data[1],\r\nifr.ifr_addr.sa_data[2], ifr.ifr_addr.sa_data[3]);\r\nstrcpy(ifr.ifr_name, ifname);\r\nif (ioctl(skfd, SIOCGIFHWADDR, &ifr) < 0)\r\nreturn -1;\r\nhwaddr = (unsigned char *)ifr.ifr_hwaddr.sa_data;\r\nprintf("The result of SIOCGIFHWADDR is type %d "\r\n"%2.2x:%2.2x:%2.2x:%2.2x:%2.2x:%2.2x.\n",\r\nifr.ifr_hwaddr.sa_family, hwaddr[0], hwaddr[1],\r\nhwaddr[2], hwaddr[3], hwaddr[4], hwaddr[5]);\r\nstrcpy(ifr.ifr_name, ifname);\r\nif (ioctl(skfd, SIOCGIFMETRIC, &ifr) < 0) {\r\nmetric = 0;\r\n} else\r\nmetric = ifr.ifr_metric;\r\nprintf("The result of SIOCGIFMETRIC is %d\n", metric);\r\nstrcpy(ifr.ifr_name, ifname);\r\nif (ioctl(skfd, SIOCGIFMTU, &ifr) < 0)\r\nmtu = 0;\r\nelse\r\nmtu = ifr.ifr_mtu;\r\nprintf("The result of SIOCGIFMTU is %d\n", mtu);\r\nstrcpy(ifr.ifr_name, ifname);\r\nif (ioctl(skfd, SIOCGIFDSTADDR, &ifr) < 0) {\r\nmemset(&dstaddr, 0, sizeof(struct sockaddr));\r\n} else\r\ndstaddr = ifr.ifr_dstaddr;\r\nstrcpy(ifr.ifr_name, ifname);\r\nif (ioctl(skfd, SIOCGIFBRDADDR, &ifr) < 0) {\r\nmemset(&broadaddr, 0, sizeof(struct sockaddr));\r\n} else\r\nbroadaddr = ifr.ifr_broadaddr;\r\nstrcpy(ifr.ifr_name, ifname);\r\nif (ioctl(skfd, SIOCGIFNETMASK, &ifr) < 0) {\r\nmemset(&netmask, 0, sizeof(struct sockaddr));\r\n} else\r\nnetmask = ifr.ifr_netmask;\r\nreturn 0;\r\n}\r\nstatic void if_print(char *ifname)\r\n{\r\nchar buff[1024];\r\nstruct ifconf ifc;\r\nstruct ifreq *ifr;\r\nint i;\r\nif (ifname == (char *)NULL) {\r\nifc.ifc_len = sizeof(buff);\r\nifc.ifc_buf = buff;\r\nif (ioctl(skfd, SIOCGIFCONF, &ifc) < 0) {\r\nperror("SIOCGIFCONF failed");\r\nreturn;\r\n}\r\nifr = ifc.ifc_req;\r\nfor (i = ifc.ifc_len / sizeof(struct ifreq); --i >= 0; ifr++) {\r\nif (if_getconfig(ifr->ifr_name) < 0) {\r\nfprintf(stderr,\r\n"%s: unknown interface.\n",\r\nifr->ifr_name);\r\ncontinue;\r\n}\r\nif (((mif_flags & IFF_UP) == 0) && !opt_a) continue;\r\n}\r\n} else {\r\nif (if_getconfig(ifname) < 0) {\r\nfprintf(stderr,\r\n"%s: unknown interface.\n", ifname);\r\n}\r\n}\r\n}\r\nstatic int get_drv_info(char *master_ifname)\r\n{\r\nstruct ifreq ifr;\r\nstruct ethtool_drvinfo info;\r\nchar *endptr;\r\nmemset(&ifr, 0, sizeof(ifr));\r\nstrncpy(ifr.ifr_name, master_ifname, IFNAMSIZ);\r\nifr.ifr_data = (caddr_t)&info;\r\ninfo.cmd = ETHTOOL_GDRVINFO;\r\nstrncpy(info.driver, "ifenslave", 32);\r\nsnprintf(info.fw_version, 32, "%d", BOND_ABI_VERSION);\r\nif (ioctl(skfd, SIOCETHTOOL, &ifr) < 0) {\r\nif (errno == EOPNOTSUPP) {\r\ngoto out;\r\n}\r\nsaved_errno = errno;\r\nv_print("Master '%s': Error: get bonding info failed %s\n",\r\nmaster_ifname, strerror(saved_errno));\r\nreturn 1;\r\n}\r\nabi_ver = strtoul(info.fw_version, &endptr, 0);\r\nif (*endptr) {\r\nv_print("Master '%s': Error: got invalid string as an ABI "\r\n"version from the bonding module\n",\r\nmaster_ifname);\r\nreturn 1;\r\n}\r\nout:\r\nv_print("ABI ver is %d\n", abi_ver);\r\nreturn 0;\r\n}\r\nstatic int change_active(char *master_ifname, char *slave_ifname)\r\n{\r\nstruct ifreq ifr;\r\nint res = 0;\r\nif (!(slave_flags.ifr_flags & IFF_SLAVE)) {\r\nfprintf(stderr,\r\n"Illegal operation: The specified slave interface "\r\n"'%s' is not a slave\n",\r\nslave_ifname);\r\nreturn 1;\r\n}\r\nstrncpy(ifr.ifr_name, master_ifname, IFNAMSIZ);\r\nstrncpy(ifr.ifr_slave, slave_ifname, IFNAMSIZ);\r\nif ((ioctl(skfd, SIOCBONDCHANGEACTIVE, &ifr) < 0) &&\r\n(ioctl(skfd, BOND_CHANGE_ACTIVE_OLD, &ifr) < 0)) {\r\nsaved_errno = errno;\r\nv_print("Master '%s': Error: SIOCBONDCHANGEACTIVE failed: "\r\n"%s\n",\r\nmaster_ifname, strerror(saved_errno));\r\nres = 1;\r\n}\r\nreturn res;\r\n}\r\nstatic int enslave(char *master_ifname, char *slave_ifname)\r\n{\r\nstruct ifreq ifr;\r\nint res = 0;\r\nif (slave_flags.ifr_flags & IFF_SLAVE) {\r\nfprintf(stderr,\r\n"Illegal operation: The specified slave interface "\r\n"'%s' is already a slave\n",\r\nslave_ifname);\r\nreturn 1;\r\n}\r\nres = set_if_down(slave_ifname, slave_flags.ifr_flags);\r\nif (res) {\r\nfprintf(stderr,\r\n"Slave '%s': Error: bring interface down failed\n",\r\nslave_ifname);\r\nreturn res;\r\n}\r\nif (abi_ver < 2) {\r\nset_if_addr(master_ifname, slave_ifname);\r\n} else {\r\nres = clear_if_addr(slave_ifname);\r\nif (res) {\r\nfprintf(stderr,\r\n"Slave '%s': Error: clear address failed\n",\r\nslave_ifname);\r\nreturn res;\r\n}\r\n}\r\nif (master_mtu.ifr_mtu != slave_mtu.ifr_mtu) {\r\nres = set_slave_mtu(slave_ifname, master_mtu.ifr_mtu);\r\nif (res) {\r\nfprintf(stderr,\r\n"Slave '%s': Error: set MTU failed\n",\r\nslave_ifname);\r\nreturn res;\r\n}\r\n}\r\nif (hwaddr_set) {\r\nif (abi_ver < 1) {\r\nres = set_slave_hwaddr(slave_ifname,\r\n&(master_hwaddr.ifr_hwaddr));\r\nif (res) {\r\nfprintf(stderr,\r\n"Slave '%s': Error: set hw address "\r\n"failed\n",\r\nslave_ifname);\r\ngoto undo_mtu;\r\n}\r\nres = set_if_up(slave_ifname, slave_flags.ifr_flags);\r\nif (res) {\r\nfprintf(stderr,\r\n"Slave '%s': Error: bring interface "\r\n"down failed\n",\r\nslave_ifname);\r\ngoto undo_slave_mac;\r\n}\r\n}\r\n} else {\r\nif (abi_ver < 1) {\r\nres = set_if_down(master_ifname, master_flags.ifr_flags);\r\nif (res) {\r\nfprintf(stderr,\r\n"Master '%s': Error: bring interface "\r\n"down failed\n",\r\nmaster_ifname);\r\ngoto undo_mtu;\r\n}\r\n}\r\nres = set_master_hwaddr(master_ifname,\r\n&(slave_hwaddr.ifr_hwaddr));\r\nif (res) {\r\nfprintf(stderr,\r\n"Master '%s': Error: set hw address "\r\n"failed\n",\r\nmaster_ifname);\r\ngoto undo_mtu;\r\n}\r\nif (abi_ver < 1) {\r\nres = set_if_up(master_ifname, master_flags.ifr_flags);\r\nif (res) {\r\nfprintf(stderr,\r\n"Master '%s': Error: bring interface "\r\n"up failed\n",\r\nmaster_ifname);\r\ngoto undo_master_mac;\r\n}\r\n}\r\nhwaddr_set = 1;\r\n}\r\nstrncpy(ifr.ifr_name, master_ifname, IFNAMSIZ);\r\nstrncpy(ifr.ifr_slave, slave_ifname, IFNAMSIZ);\r\nif ((ioctl(skfd, SIOCBONDENSLAVE, &ifr) < 0) &&\r\n(ioctl(skfd, BOND_ENSLAVE_OLD, &ifr) < 0)) {\r\nsaved_errno = errno;\r\nv_print("Master '%s': Error: SIOCBONDENSLAVE failed: %s\n",\r\nmaster_ifname, strerror(saved_errno));\r\nres = 1;\r\n}\r\nif (res) {\r\ngoto undo_master_mac;\r\n}\r\nreturn 0;\r\nundo_master_mac:\r\nset_master_hwaddr(master_ifname, &(master_hwaddr.ifr_hwaddr));\r\nhwaddr_set = 0;\r\ngoto undo_mtu;\r\nundo_slave_mac:\r\nset_slave_hwaddr(slave_ifname, &(slave_hwaddr.ifr_hwaddr));\r\nundo_mtu:\r\nset_slave_mtu(slave_ifname, slave_mtu.ifr_mtu);\r\nreturn res;\r\n}\r\nstatic int release(char *master_ifname, char *slave_ifname)\r\n{\r\nstruct ifreq ifr;\r\nint res = 0;\r\nif (!(slave_flags.ifr_flags & IFF_SLAVE)) {\r\nfprintf(stderr,\r\n"Illegal operation: The specified slave interface "\r\n"'%s' is not a slave\n",\r\nslave_ifname);\r\nreturn 1;\r\n}\r\nstrncpy(ifr.ifr_name, master_ifname, IFNAMSIZ);\r\nstrncpy(ifr.ifr_slave, slave_ifname, IFNAMSIZ);\r\nif ((ioctl(skfd, SIOCBONDRELEASE, &ifr) < 0) &&\r\n(ioctl(skfd, BOND_RELEASE_OLD, &ifr) < 0)) {\r\nsaved_errno = errno;\r\nv_print("Master '%s': Error: SIOCBONDRELEASE failed: %s\n",\r\nmaster_ifname, strerror(saved_errno));\r\nreturn 1;\r\n} else if (abi_ver < 1) {\r\nres = set_if_down(slave_ifname, slave_flags.ifr_flags);\r\nif (res) {\r\nfprintf(stderr,\r\n"Slave '%s': Error: bring interface "\r\n"down failed\n",\r\nslave_ifname);\r\n}\r\n}\r\nset_slave_mtu(slave_ifname, 1500);\r\nreturn res;\r\n}\r\nstatic int get_if_settings(char *ifname, struct dev_ifr ifra[])\r\n{\r\nint i;\r\nint res = 0;\r\nfor (i = 0; ifra[i].req_ifr; i++) {\r\nstrncpy(ifra[i].req_ifr->ifr_name, ifname, IFNAMSIZ);\r\nres = ioctl(skfd, ifra[i].req_type, ifra[i].req_ifr);\r\nif (res < 0) {\r\nsaved_errno = errno;\r\nv_print("Interface '%s': Error: %s failed: %s\n",\r\nifname, ifra[i].req_name,\r\nstrerror(saved_errno));\r\nreturn saved_errno;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int get_slave_flags(char *slave_ifname)\r\n{\r\nint res = 0;\r\nstrncpy(slave_flags.ifr_name, slave_ifname, IFNAMSIZ);\r\nres = ioctl(skfd, SIOCGIFFLAGS, &slave_flags);\r\nif (res < 0) {\r\nsaved_errno = errno;\r\nv_print("Slave '%s': Error: SIOCGIFFLAGS failed: %s\n",\r\nslave_ifname, strerror(saved_errno));\r\n} else {\r\nv_print("Slave %s: flags %04X.\n",\r\nslave_ifname, slave_flags.ifr_flags);\r\n}\r\nreturn res;\r\n}\r\nstatic int set_master_hwaddr(char *master_ifname, struct sockaddr *hwaddr)\r\n{\r\nunsigned char *addr = (unsigned char *)hwaddr->sa_data;\r\nstruct ifreq ifr;\r\nint res = 0;\r\nstrncpy(ifr.ifr_name, master_ifname, IFNAMSIZ);\r\nmemcpy(&(ifr.ifr_hwaddr), hwaddr, sizeof(struct sockaddr));\r\nres = ioctl(skfd, SIOCSIFHWADDR, &ifr);\r\nif (res < 0) {\r\nsaved_errno = errno;\r\nv_print("Master '%s': Error: SIOCSIFHWADDR failed: %s\n",\r\nmaster_ifname, strerror(saved_errno));\r\nreturn res;\r\n} else {\r\nv_print("Master '%s': hardware address set to "\r\n"%2.2x:%2.2x:%2.2x:%2.2x:%2.2x:%2.2x.\n",\r\nmaster_ifname, addr[0], addr[1], addr[2],\r\naddr[3], addr[4], addr[5]);\r\n}\r\nreturn res;\r\n}\r\nstatic int set_slave_hwaddr(char *slave_ifname, struct sockaddr *hwaddr)\r\n{\r\nunsigned char *addr = (unsigned char *)hwaddr->sa_data;\r\nstruct ifreq ifr;\r\nint res = 0;\r\nstrncpy(ifr.ifr_name, slave_ifname, IFNAMSIZ);\r\nmemcpy(&(ifr.ifr_hwaddr), hwaddr, sizeof(struct sockaddr));\r\nres = ioctl(skfd, SIOCSIFHWADDR, &ifr);\r\nif (res < 0) {\r\nsaved_errno = errno;\r\nv_print("Slave '%s': Error: SIOCSIFHWADDR failed: %s\n",\r\nslave_ifname, strerror(saved_errno));\r\nif (saved_errno == EBUSY) {\r\nv_print(" The device is busy: it must be idle "\r\n"before running this command.\n");\r\n} else if (saved_errno == EOPNOTSUPP) {\r\nv_print(" The device does not support setting "\r\n"the MAC address.\n"\r\n" Your kernel likely does not support slave "\r\n"devices.\n");\r\n} else if (saved_errno == EINVAL) {\r\nv_print(" The device's address type does not match "\r\n"the master's address type.\n");\r\n}\r\nreturn res;\r\n} else {\r\nv_print("Slave '%s': hardware address set to "\r\n"%2.2x:%2.2x:%2.2x:%2.2x:%2.2x:%2.2x.\n",\r\nslave_ifname, addr[0], addr[1], addr[2],\r\naddr[3], addr[4], addr[5]);\r\n}\r\nreturn res;\r\n}\r\nstatic int set_slave_mtu(char *slave_ifname, int mtu)\r\n{\r\nstruct ifreq ifr;\r\nint res = 0;\r\nifr.ifr_mtu = mtu;\r\nstrncpy(ifr.ifr_name, slave_ifname, IFNAMSIZ);\r\nres = ioctl(skfd, SIOCSIFMTU, &ifr);\r\nif (res < 0) {\r\nsaved_errno = errno;\r\nv_print("Slave '%s': Error: SIOCSIFMTU failed: %s\n",\r\nslave_ifname, strerror(saved_errno));\r\n} else {\r\nv_print("Slave '%s': MTU set to %d.\n", slave_ifname, mtu);\r\n}\r\nreturn res;\r\n}\r\nstatic int set_if_flags(char *ifname, short flags)\r\n{\r\nstruct ifreq ifr;\r\nint res = 0;\r\nifr.ifr_flags = flags;\r\nstrncpy(ifr.ifr_name, ifname, IFNAMSIZ);\r\nres = ioctl(skfd, SIOCSIFFLAGS, &ifr);\r\nif (res < 0) {\r\nsaved_errno = errno;\r\nv_print("Interface '%s': Error: SIOCSIFFLAGS failed: %s\n",\r\nifname, strerror(saved_errno));\r\n} else {\r\nv_print("Interface '%s': flags set to %04X.\n", ifname, flags);\r\n}\r\nreturn res;\r\n}\r\nstatic int set_if_up(char *ifname, short flags)\r\n{\r\nreturn set_if_flags(ifname, flags | IFF_UP);\r\n}\r\nstatic int set_if_down(char *ifname, short flags)\r\n{\r\nreturn set_if_flags(ifname, flags & ~IFF_UP);\r\n}\r\nstatic int clear_if_addr(char *ifname)\r\n{\r\nstruct ifreq ifr;\r\nint res = 0;\r\nstrncpy(ifr.ifr_name, ifname, IFNAMSIZ);\r\nifr.ifr_addr.sa_family = AF_INET;\r\nmemset(ifr.ifr_addr.sa_data, 0, sizeof(ifr.ifr_addr.sa_data));\r\nres = ioctl(skfd, SIOCSIFADDR, &ifr);\r\nif (res < 0) {\r\nsaved_errno = errno;\r\nv_print("Interface '%s': Error: SIOCSIFADDR failed: %s\n",\r\nifname, strerror(saved_errno));\r\n} else {\r\nv_print("Interface '%s': address cleared\n", ifname);\r\n}\r\nreturn res;\r\n}\r\nstatic int set_if_addr(char *master_ifname, char *slave_ifname)\r\n{\r\nstruct ifreq ifr;\r\nint res;\r\nunsigned char *ipaddr;\r\nint i;\r\nstruct {\r\nchar *req_name;\r\nchar *desc;\r\nint g_ioctl;\r\nint s_ioctl;\r\n} ifra[] = {\r\n{"IFADDR", "addr", SIOCGIFADDR, SIOCSIFADDR},\r\n{"DSTADDR", "destination addr", SIOCGIFDSTADDR, SIOCSIFDSTADDR},\r\n{"BRDADDR", "broadcast addr", SIOCGIFBRDADDR, SIOCSIFBRDADDR},\r\n{"NETMASK", "netmask", SIOCGIFNETMASK, SIOCSIFNETMASK},\r\n{NULL, NULL, 0, 0},\r\n};\r\nfor (i = 0; ifra[i].req_name; i++) {\r\nstrncpy(ifr.ifr_name, master_ifname, IFNAMSIZ);\r\nres = ioctl(skfd, ifra[i].g_ioctl, &ifr);\r\nif (res < 0) {\r\nint saved_errno = errno;\r\nv_print("Interface '%s': Error: SIOCG%s failed: %s\n",\r\nmaster_ifname, ifra[i].req_name,\r\nstrerror(saved_errno));\r\nifr.ifr_addr.sa_family = AF_INET;\r\nmemset(ifr.ifr_addr.sa_data, 0,\r\nsizeof(ifr.ifr_addr.sa_data));\r\n}\r\nstrncpy(ifr.ifr_name, slave_ifname, IFNAMSIZ);\r\nres = ioctl(skfd, ifra[i].s_ioctl, &ifr);\r\nif (res < 0) {\r\nint saved_errno = errno;\r\nv_print("Interface '%s': Error: SIOCS%s failed: %s\n",\r\nslave_ifname, ifra[i].req_name,\r\nstrerror(saved_errno));\r\n}\r\nipaddr = (unsigned char *)ifr.ifr_addr.sa_data;\r\nv_print("Interface '%s': set IP %s to %d.%d.%d.%d\n",\r\nslave_ifname, ifra[i].desc,\r\nipaddr[0], ipaddr[1], ipaddr[2], ipaddr[3]);\r\n}\r\nreturn 0;\r\n}

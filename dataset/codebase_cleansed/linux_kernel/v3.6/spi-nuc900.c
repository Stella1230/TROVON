static inline struct nuc900_spi *to_hw(struct spi_device *sdev)\r\n{\r\nreturn spi_master_get_devdata(sdev->master);\r\n}\r\nstatic void nuc900_slave_select(struct spi_device *spi, unsigned int ssr)\r\n{\r\nstruct nuc900_spi *hw = to_hw(spi);\r\nunsigned int val;\r\nunsigned int cs = spi->mode & SPI_CS_HIGH ? 1 : 0;\r\nunsigned int cpol = spi->mode & SPI_CPOL ? 1 : 0;\r\nunsigned long flags;\r\nspin_lock_irqsave(&hw->lock, flags);\r\nval = __raw_readl(hw->regs + USI_SSR);\r\nif (!cs)\r\nval &= ~SELECTLEV;\r\nelse\r\nval |= SELECTLEV;\r\nif (!ssr)\r\nval &= ~SELECTSLAVE;\r\nelse\r\nval |= SELECTSLAVE;\r\n__raw_writel(val, hw->regs + USI_SSR);\r\nval = __raw_readl(hw->regs + USI_CNT);\r\nif (!cpol)\r\nval &= ~SELECTPOL;\r\nelse\r\nval |= SELECTPOL;\r\n__raw_writel(val, hw->regs + USI_CNT);\r\nspin_unlock_irqrestore(&hw->lock, flags);\r\n}\r\nstatic void nuc900_spi_chipsel(struct spi_device *spi, int value)\r\n{\r\nswitch (value) {\r\ncase BITBANG_CS_INACTIVE:\r\nnuc900_slave_select(spi, 0);\r\nbreak;\r\ncase BITBANG_CS_ACTIVE:\r\nnuc900_slave_select(spi, 1);\r\nbreak;\r\n}\r\n}\r\nstatic void nuc900_spi_setup_txnum(struct nuc900_spi *hw,\r\nunsigned int txnum)\r\n{\r\nunsigned int val;\r\nunsigned long flags;\r\nspin_lock_irqsave(&hw->lock, flags);\r\nval = __raw_readl(hw->regs + USI_CNT);\r\nif (!txnum)\r\nval &= ~TXNUM;\r\nelse\r\nval |= txnum << 0x08;\r\n__raw_writel(val, hw->regs + USI_CNT);\r\nspin_unlock_irqrestore(&hw->lock, flags);\r\n}\r\nstatic void nuc900_spi_setup_txbitlen(struct nuc900_spi *hw,\r\nunsigned int txbitlen)\r\n{\r\nunsigned int val;\r\nunsigned long flags;\r\nspin_lock_irqsave(&hw->lock, flags);\r\nval = __raw_readl(hw->regs + USI_CNT);\r\nval |= (txbitlen << 0x03);\r\n__raw_writel(val, hw->regs + USI_CNT);\r\nspin_unlock_irqrestore(&hw->lock, flags);\r\n}\r\nstatic void nuc900_spi_gobusy(struct nuc900_spi *hw)\r\n{\r\nunsigned int val;\r\nunsigned long flags;\r\nspin_lock_irqsave(&hw->lock, flags);\r\nval = __raw_readl(hw->regs + USI_CNT);\r\nval |= GOBUSY;\r\n__raw_writel(val, hw->regs + USI_CNT);\r\nspin_unlock_irqrestore(&hw->lock, flags);\r\n}\r\nstatic int nuc900_spi_setupxfer(struct spi_device *spi,\r\nstruct spi_transfer *t)\r\n{\r\nreturn 0;\r\n}\r\nstatic int nuc900_spi_setup(struct spi_device *spi)\r\n{\r\nreturn 0;\r\n}\r\nstatic inline unsigned int hw_txbyte(struct nuc900_spi *hw, int count)\r\n{\r\nreturn hw->tx ? hw->tx[count] : 0;\r\n}\r\nstatic int nuc900_spi_txrx(struct spi_device *spi, struct spi_transfer *t)\r\n{\r\nstruct nuc900_spi *hw = to_hw(spi);\r\nhw->tx = t->tx_buf;\r\nhw->rx = t->rx_buf;\r\nhw->len = t->len;\r\nhw->count = 0;\r\n__raw_writel(hw_txbyte(hw, 0x0), hw->regs + USI_TX0);\r\nnuc900_spi_gobusy(hw);\r\nwait_for_completion(&hw->done);\r\nreturn hw->count;\r\n}\r\nstatic irqreturn_t nuc900_spi_irq(int irq, void *dev)\r\n{\r\nstruct nuc900_spi *hw = dev;\r\nunsigned int status;\r\nunsigned int count = hw->count;\r\nstatus = __raw_readl(hw->regs + USI_CNT);\r\n__raw_writel(status, hw->regs + USI_CNT);\r\nif (status & ENFLG) {\r\nhw->count++;\r\nif (hw->rx)\r\nhw->rx[count] = __raw_readl(hw->regs + USI_RX0);\r\ncount++;\r\nif (count < hw->len) {\r\n__raw_writel(hw_txbyte(hw, count), hw->regs + USI_TX0);\r\nnuc900_spi_gobusy(hw);\r\n} else {\r\ncomplete(&hw->done);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\ncomplete(&hw->done);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void nuc900_tx_edge(struct nuc900_spi *hw, unsigned int edge)\r\n{\r\nunsigned int val;\r\nunsigned long flags;\r\nspin_lock_irqsave(&hw->lock, flags);\r\nval = __raw_readl(hw->regs + USI_CNT);\r\nif (edge)\r\nval |= TXNEG;\r\nelse\r\nval &= ~TXNEG;\r\n__raw_writel(val, hw->regs + USI_CNT);\r\nspin_unlock_irqrestore(&hw->lock, flags);\r\n}\r\nstatic void nuc900_rx_edge(struct nuc900_spi *hw, unsigned int edge)\r\n{\r\nunsigned int val;\r\nunsigned long flags;\r\nspin_lock_irqsave(&hw->lock, flags);\r\nval = __raw_readl(hw->regs + USI_CNT);\r\nif (edge)\r\nval |= RXNEG;\r\nelse\r\nval &= ~RXNEG;\r\n__raw_writel(val, hw->regs + USI_CNT);\r\nspin_unlock_irqrestore(&hw->lock, flags);\r\n}\r\nstatic void nuc900_send_first(struct nuc900_spi *hw, unsigned int lsb)\r\n{\r\nunsigned int val;\r\nunsigned long flags;\r\nspin_lock_irqsave(&hw->lock, flags);\r\nval = __raw_readl(hw->regs + USI_CNT);\r\nif (lsb)\r\nval |= LSB;\r\nelse\r\nval &= ~LSB;\r\n__raw_writel(val, hw->regs + USI_CNT);\r\nspin_unlock_irqrestore(&hw->lock, flags);\r\n}\r\nstatic void nuc900_set_sleep(struct nuc900_spi *hw, unsigned int sleep)\r\n{\r\nunsigned int val;\r\nunsigned long flags;\r\nspin_lock_irqsave(&hw->lock, flags);\r\nval = __raw_readl(hw->regs + USI_CNT);\r\nif (sleep)\r\nval |= (sleep << 12);\r\nelse\r\nval &= ~(0x0f << 12);\r\n__raw_writel(val, hw->regs + USI_CNT);\r\nspin_unlock_irqrestore(&hw->lock, flags);\r\n}\r\nstatic void nuc900_enable_int(struct nuc900_spi *hw)\r\n{\r\nunsigned int val;\r\nunsigned long flags;\r\nspin_lock_irqsave(&hw->lock, flags);\r\nval = __raw_readl(hw->regs + USI_CNT);\r\nval |= ENINT;\r\n__raw_writel(val, hw->regs + USI_CNT);\r\nspin_unlock_irqrestore(&hw->lock, flags);\r\n}\r\nstatic void nuc900_set_divider(struct nuc900_spi *hw)\r\n{\r\n__raw_writel(hw->pdata->divider, hw->regs + USI_DIV);\r\n}\r\nstatic void nuc900_init_spi(struct nuc900_spi *hw)\r\n{\r\nclk_enable(hw->clk);\r\nspin_lock_init(&hw->lock);\r\nnuc900_tx_edge(hw, hw->pdata->txneg);\r\nnuc900_rx_edge(hw, hw->pdata->rxneg);\r\nnuc900_send_first(hw, hw->pdata->lsb);\r\nnuc900_set_sleep(hw, hw->pdata->sleep);\r\nnuc900_spi_setup_txbitlen(hw, hw->pdata->txbitlen);\r\nnuc900_spi_setup_txnum(hw, hw->pdata->txnum);\r\nnuc900_set_divider(hw);\r\nnuc900_enable_int(hw);\r\n}\r\nstatic int __devinit nuc900_spi_probe(struct platform_device *pdev)\r\n{\r\nstruct nuc900_spi *hw;\r\nstruct spi_master *master;\r\nint err = 0;\r\nmaster = spi_alloc_master(&pdev->dev, sizeof(struct nuc900_spi));\r\nif (master == NULL) {\r\ndev_err(&pdev->dev, "No memory for spi_master\n");\r\nerr = -ENOMEM;\r\ngoto err_nomem;\r\n}\r\nhw = spi_master_get_devdata(master);\r\nhw->master = spi_master_get(master);\r\nhw->pdata = pdev->dev.platform_data;\r\nhw->dev = &pdev->dev;\r\nif (hw->pdata == NULL) {\r\ndev_err(&pdev->dev, "No platform data supplied\n");\r\nerr = -ENOENT;\r\ngoto err_pdata;\r\n}\r\nplatform_set_drvdata(pdev, hw);\r\ninit_completion(&hw->done);\r\nmaster->mode_bits = SPI_MODE_0;\r\nmaster->num_chipselect = hw->pdata->num_cs;\r\nmaster->bus_num = hw->pdata->bus_num;\r\nhw->bitbang.master = hw->master;\r\nhw->bitbang.setup_transfer = nuc900_spi_setupxfer;\r\nhw->bitbang.chipselect = nuc900_spi_chipsel;\r\nhw->bitbang.txrx_bufs = nuc900_spi_txrx;\r\nhw->bitbang.master->setup = nuc900_spi_setup;\r\nhw->res = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (hw->res == NULL) {\r\ndev_err(&pdev->dev, "Cannot get IORESOURCE_MEM\n");\r\nerr = -ENOENT;\r\ngoto err_pdata;\r\n}\r\nhw->ioarea = request_mem_region(hw->res->start,\r\nresource_size(hw->res), pdev->name);\r\nif (hw->ioarea == NULL) {\r\ndev_err(&pdev->dev, "Cannot reserve region\n");\r\nerr = -ENXIO;\r\ngoto err_pdata;\r\n}\r\nhw->regs = ioremap(hw->res->start, resource_size(hw->res));\r\nif (hw->regs == NULL) {\r\ndev_err(&pdev->dev, "Cannot map IO\n");\r\nerr = -ENXIO;\r\ngoto err_iomap;\r\n}\r\nhw->irq = platform_get_irq(pdev, 0);\r\nif (hw->irq < 0) {\r\ndev_err(&pdev->dev, "No IRQ specified\n");\r\nerr = -ENOENT;\r\ngoto err_irq;\r\n}\r\nerr = request_irq(hw->irq, nuc900_spi_irq, 0, pdev->name, hw);\r\nif (err) {\r\ndev_err(&pdev->dev, "Cannot claim IRQ\n");\r\ngoto err_irq;\r\n}\r\nhw->clk = clk_get(&pdev->dev, "spi");\r\nif (IS_ERR(hw->clk)) {\r\ndev_err(&pdev->dev, "No clock for device\n");\r\nerr = PTR_ERR(hw->clk);\r\ngoto err_clk;\r\n}\r\nmfp_set_groupg(&pdev->dev, NULL);\r\nnuc900_init_spi(hw);\r\nerr = spi_bitbang_start(&hw->bitbang);\r\nif (err) {\r\ndev_err(&pdev->dev, "Failed to register SPI master\n");\r\ngoto err_register;\r\n}\r\nreturn 0;\r\nerr_register:\r\nclk_disable(hw->clk);\r\nclk_put(hw->clk);\r\nerr_clk:\r\nfree_irq(hw->irq, hw);\r\nerr_irq:\r\niounmap(hw->regs);\r\nerr_iomap:\r\nrelease_mem_region(hw->res->start, resource_size(hw->res));\r\nkfree(hw->ioarea);\r\nerr_pdata:\r\nspi_master_put(hw->master);\r\nerr_nomem:\r\nreturn err;\r\n}\r\nstatic int __devexit nuc900_spi_remove(struct platform_device *dev)\r\n{\r\nstruct nuc900_spi *hw = platform_get_drvdata(dev);\r\nfree_irq(hw->irq, hw);\r\nplatform_set_drvdata(dev, NULL);\r\nspi_bitbang_stop(&hw->bitbang);\r\nclk_disable(hw->clk);\r\nclk_put(hw->clk);\r\niounmap(hw->regs);\r\nrelease_mem_region(hw->res->start, resource_size(hw->res));\r\nkfree(hw->ioarea);\r\nspi_master_put(hw->master);\r\nreturn 0;\r\n}

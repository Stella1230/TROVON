static long ps3_hpte_insert(unsigned long hpte_group, unsigned long va,\r\nunsigned long pa, unsigned long rflags, unsigned long vflags,\r\nint psize, int ssize)\r\n{\r\nint result;\r\nu64 hpte_v, hpte_r;\r\nu64 inserted_index;\r\nu64 evicted_v, evicted_r;\r\nu64 hpte_v_array[4], hpte_rs;\r\nunsigned long flags;\r\nlong ret = -1;\r\nvflags &= ~HPTE_V_SECONDARY;\r\nhpte_v = hpte_encode_v(va, psize, ssize) | vflags | HPTE_V_VALID;\r\nhpte_r = hpte_encode_r(ps3_mm_phys_to_lpar(pa), psize) | rflags;\r\nspin_lock_irqsave(&ps3_htab_lock, flags);\r\nresult = lv1_insert_htab_entry(PS3_LPAR_VAS_ID_CURRENT, hpte_group,\r\nhpte_v, hpte_r,\r\nHPTE_V_BOLTED, 0,\r\n&inserted_index,\r\n&evicted_v, &evicted_r);\r\nif (result) {\r\npr_info("%s:result=%d va=%lx pa=%lx ix=%lx v=%llx r=%llx\n",\r\n__func__, result, va, pa, hpte_group, hpte_v, hpte_r);\r\nBUG();\r\n}\r\nresult = lv1_read_htab_entries(PS3_LPAR_VAS_ID_CURRENT,\r\ninserted_index & ~0x3UL,\r\n&hpte_v_array[0], &hpte_v_array[1],\r\n&hpte_v_array[2], &hpte_v_array[3],\r\n&hpte_rs);\r\nBUG_ON(result);\r\nif (hpte_v_array[inserted_index % 4] & HPTE_V_SECONDARY)\r\nret = (inserted_index & 7) | (1 << 3);\r\nelse\r\nret = inserted_index & 7;\r\nspin_unlock_irqrestore(&ps3_htab_lock, flags);\r\nreturn ret;\r\n}\r\nstatic long ps3_hpte_remove(unsigned long hpte_group)\r\n{\r\npanic("ps3_hpte_remove() not implemented");\r\nreturn 0;\r\n}\r\nstatic long ps3_hpte_updatepp(unsigned long slot, unsigned long newpp,\r\nunsigned long va, int psize, int ssize, int local)\r\n{\r\nint result;\r\nu64 hpte_v, want_v, hpte_rs;\r\nu64 hpte_v_array[4];\r\nunsigned long flags;\r\nlong ret;\r\nwant_v = hpte_encode_v(va, psize, ssize);\r\nspin_lock_irqsave(&ps3_htab_lock, flags);\r\nresult = lv1_read_htab_entries(PS3_LPAR_VAS_ID_CURRENT, slot & ~0x3UL,\r\n&hpte_v_array[0], &hpte_v_array[1],\r\n&hpte_v_array[2], &hpte_v_array[3],\r\n&hpte_rs);\r\nif (result) {\r\npr_info("%s: res=%d read va=%lx slot=%lx psize=%d\n",\r\n__func__, result, va, slot, psize);\r\nBUG();\r\n}\r\nhpte_v = hpte_v_array[slot % 4];\r\nif (!HPTE_V_COMPARE(hpte_v, want_v) || !(hpte_v & HPTE_V_VALID)) {\r\nret = -1;\r\n} else {\r\nresult = lv1_write_htab_entry(PS3_LPAR_VAS_ID_CURRENT,\r\nslot, 0, 0);\r\nret = -1;\r\n}\r\nspin_unlock_irqrestore(&ps3_htab_lock, flags);\r\nreturn ret;\r\n}\r\nstatic void ps3_hpte_updateboltedpp(unsigned long newpp, unsigned long ea,\r\nint psize, int ssize)\r\n{\r\npanic("ps3_hpte_updateboltedpp() not implemented");\r\n}\r\nstatic void ps3_hpte_invalidate(unsigned long slot, unsigned long va,\r\nint psize, int ssize, int local)\r\n{\r\nunsigned long flags;\r\nint result;\r\nspin_lock_irqsave(&ps3_htab_lock, flags);\r\nresult = lv1_write_htab_entry(PS3_LPAR_VAS_ID_CURRENT, slot, 0, 0);\r\nif (result) {\r\npr_info("%s: res=%d va=%lx slot=%lx psize=%d\n",\r\n__func__, result, va, slot, psize);\r\nBUG();\r\n}\r\nspin_unlock_irqrestore(&ps3_htab_lock, flags);\r\n}\r\nstatic void ps3_hpte_clear(void)\r\n{\r\nunsigned long hpte_count = (1UL << ppc64_pft_size) >> 4;\r\nu64 i;\r\nfor (i = 0; i < hpte_count; i++)\r\nlv1_write_htab_entry(PS3_LPAR_VAS_ID_CURRENT, i, 0, 0);\r\nps3_mm_shutdown();\r\nps3_mm_vas_destroy();\r\n}\r\nvoid __init ps3_hpte_init(unsigned long htab_size)\r\n{\r\nppc_md.hpte_invalidate = ps3_hpte_invalidate;\r\nppc_md.hpte_updatepp = ps3_hpte_updatepp;\r\nppc_md.hpte_updateboltedpp = ps3_hpte_updateboltedpp;\r\nppc_md.hpte_insert = ps3_hpte_insert;\r\nppc_md.hpte_remove = ps3_hpte_remove;\r\nppc_md.hpte_clear_all = ps3_hpte_clear;\r\nppc64_pft_size = __ilog2(htab_size);\r\n}

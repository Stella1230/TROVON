static void s3c_irq_demux_vic_timer(unsigned int irq, struct irq_desc *desc)\r\n{\r\nstruct irq_chip *chip = irq_get_chip(irq);\r\nchained_irq_enter(chip, desc);\r\ngeneric_handle_irq((int)desc->irq_data.handler_data);\r\nchained_irq_exit(chip, desc);\r\n}\r\nstatic void s3c_irq_timer_ack(struct irq_data *d)\r\n{\r\nstruct irq_chip_generic *gc = irq_data_get_irq_chip_data(d);\r\nu32 mask = (1 << 5) << (d->irq - gc->irq_base);\r\nirq_reg_writel(mask | gc->mask_cache, gc->reg_base);\r\n}\r\nvoid __init s3c_init_vic_timer_irq(unsigned int num, unsigned int timer_irq)\r\n{\r\nunsigned int pirq[5] = { IRQ_TIMER0_VIC, IRQ_TIMER1_VIC, IRQ_TIMER2_VIC,\r\nIRQ_TIMER3_VIC, IRQ_TIMER4_VIC };\r\nstruct irq_chip_generic *s3c_tgc;\r\nstruct irq_chip_type *ct;\r\nunsigned int i;\r\n#ifdef CONFIG_ARCH_EXYNOS\r\nif (soc_is_exynos5250()) {\r\npirq[0] = EXYNOS5_IRQ_TIMER0_VIC;\r\npirq[1] = EXYNOS5_IRQ_TIMER1_VIC;\r\npirq[2] = EXYNOS5_IRQ_TIMER2_VIC;\r\npirq[3] = EXYNOS5_IRQ_TIMER3_VIC;\r\npirq[4] = EXYNOS5_IRQ_TIMER4_VIC;\r\n} else {\r\npirq[0] = EXYNOS4_IRQ_TIMER0_VIC;\r\npirq[1] = EXYNOS4_IRQ_TIMER1_VIC;\r\npirq[2] = EXYNOS4_IRQ_TIMER2_VIC;\r\npirq[3] = EXYNOS4_IRQ_TIMER3_VIC;\r\npirq[4] = EXYNOS4_IRQ_TIMER4_VIC;\r\n}\r\n#endif\r\ns3c_tgc = irq_alloc_generic_chip("s3c-timer", 1, timer_irq,\r\nS3C64XX_TINT_CSTAT, handle_level_irq);\r\nif (!s3c_tgc) {\r\npr_err("%s: irq_alloc_generic_chip for IRQ %d failed\n",\r\n__func__, timer_irq);\r\nreturn;\r\n}\r\nct = s3c_tgc->chip_types;\r\nct->chip.irq_mask = irq_gc_mask_clr_bit;\r\nct->chip.irq_unmask = irq_gc_mask_set_bit;\r\nct->chip.irq_ack = s3c_irq_timer_ack;\r\nirq_setup_generic_chip(s3c_tgc, IRQ_MSK(num), IRQ_GC_INIT_MASK_CACHE,\r\nIRQ_NOREQUEST | IRQ_NOPROBE, 0);\r\ns3c_tgc->mask_cache &= 0x1f;\r\nfor (i = 0; i < num; i++, timer_irq++) {\r\nirq_set_chained_handler(pirq[i], s3c_irq_demux_vic_timer);\r\nirq_set_handler_data(pirq[i], (void *)timer_irq);\r\n}\r\n}

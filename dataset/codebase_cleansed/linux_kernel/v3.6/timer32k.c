static inline void omap_32k_timer_write(int val, int reg)\r\n{\r\nomap_writew(val, OMAP1_32K_TIMER_BASE + reg);\r\n}\r\nstatic inline unsigned long omap_32k_timer_read(int reg)\r\n{\r\nreturn omap_readl(OMAP1_32K_TIMER_BASE + reg) & 0xffffff;\r\n}\r\nstatic inline void omap_32k_timer_start(unsigned long load_val)\r\n{\r\nif (!load_val)\r\nload_val = 1;\r\nomap_32k_timer_write(load_val, OMAP1_32K_TIMER_TVR);\r\nomap_32k_timer_write(0x0f, OMAP1_32K_TIMER_CR);\r\n}\r\nstatic inline void omap_32k_timer_stop(void)\r\n{\r\nomap_32k_timer_write(0x0, OMAP1_32K_TIMER_CR);\r\n}\r\nstatic int omap_32k_timer_set_next_event(unsigned long delta,\r\nstruct clock_event_device *dev)\r\n{\r\nomap_32k_timer_start(delta);\r\nreturn 0;\r\n}\r\nstatic void omap_32k_timer_set_mode(enum clock_event_mode mode,\r\nstruct clock_event_device *evt)\r\n{\r\nomap_32k_timer_stop();\r\nswitch (mode) {\r\ncase CLOCK_EVT_MODE_PERIODIC:\r\nomap_32k_timer_start(OMAP_32K_TIMER_TICK_PERIOD);\r\nbreak;\r\ncase CLOCK_EVT_MODE_ONESHOT:\r\ncase CLOCK_EVT_MODE_UNUSED:\r\ncase CLOCK_EVT_MODE_SHUTDOWN:\r\nbreak;\r\ncase CLOCK_EVT_MODE_RESUME:\r\nbreak;\r\n}\r\n}\r\nstatic irqreturn_t omap_32k_timer_interrupt(int irq, void *dev_id)\r\n{\r\nstruct clock_event_device *evt = &clockevent_32k_timer;\r\nomap_32k_timer_ack_irq();\r\nevt->event_handler(evt);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic __init void omap_init_32k_timer(void)\r\n{\r\nsetup_irq(INT_OS_TIMER, &omap_32k_timer_irq);\r\nclockevent_32k_timer.mult = div_sc(OMAP_32K_TICKS_PER_SEC,\r\nNSEC_PER_SEC,\r\nclockevent_32k_timer.shift);\r\nclockevent_32k_timer.max_delta_ns =\r\nclockevent_delta2ns(0xfffffffe, &clockevent_32k_timer);\r\nclockevent_32k_timer.min_delta_ns =\r\nclockevent_delta2ns(1, &clockevent_32k_timer);\r\nclockevent_32k_timer.cpumask = cpumask_of(0);\r\nclockevents_register_device(&clockevent_32k_timer);\r\n}\r\nint __init omap_32k_timer_init(void)\r\n{\r\nint ret = -ENODEV;\r\nif (cpu_is_omap16xx()) {\r\nvoid __iomem *base;\r\nstruct clk *sync32k_ick;\r\nbase = ioremap(OMAP1_32KSYNC_TIMER_BASE, SZ_1K);\r\nif (!base) {\r\npr_err("32k_counter: failed to map base addr\n");\r\nreturn -ENODEV;\r\n}\r\nsync32k_ick = clk_get(NULL, "omap_32ksync_ick");\r\nif (!IS_ERR(sync32k_ick))\r\nclk_enable(sync32k_ick);\r\nret = omap_init_clocksource_32k(base);\r\n}\r\nif (!ret)\r\nomap_init_32k_timer();\r\nreturn ret;\r\n}

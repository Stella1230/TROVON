static int ttm_agp_bind(struct ttm_tt *ttm, struct ttm_mem_reg *bo_mem)\r\n{\r\nstruct ttm_agp_backend *agp_be = container_of(ttm, struct ttm_agp_backend, ttm);\r\nstruct drm_mm_node *node = bo_mem->mm_node;\r\nstruct agp_memory *mem;\r\nint ret, cached = (bo_mem->placement & TTM_PL_FLAG_CACHED);\r\nunsigned i;\r\nmem = agp_allocate_memory(agp_be->bridge, ttm->num_pages, AGP_USER_MEMORY);\r\nif (unlikely(mem == NULL))\r\nreturn -ENOMEM;\r\nmem->page_count = 0;\r\nfor (i = 0; i < ttm->num_pages; i++) {\r\nstruct page *page = ttm->pages[i];\r\nif (!page)\r\npage = ttm->dummy_read_page;\r\nmem->pages[mem->page_count++] = page;\r\n}\r\nagp_be->mem = mem;\r\nmem->is_flushed = 1;\r\nmem->type = (cached) ? AGP_USER_CACHED_MEMORY : AGP_USER_MEMORY;\r\nret = agp_bind_memory(mem, node->start);\r\nif (ret)\r\npr_err("AGP Bind memory failed\n");\r\nreturn ret;\r\n}\r\nstatic int ttm_agp_unbind(struct ttm_tt *ttm)\r\n{\r\nstruct ttm_agp_backend *agp_be = container_of(ttm, struct ttm_agp_backend, ttm);\r\nif (agp_be->mem) {\r\nif (agp_be->mem->is_bound)\r\nreturn agp_unbind_memory(agp_be->mem);\r\nagp_free_memory(agp_be->mem);\r\nagp_be->mem = NULL;\r\n}\r\nreturn 0;\r\n}\r\nstatic void ttm_agp_destroy(struct ttm_tt *ttm)\r\n{\r\nstruct ttm_agp_backend *agp_be = container_of(ttm, struct ttm_agp_backend, ttm);\r\nif (agp_be->mem)\r\nttm_agp_unbind(ttm);\r\nttm_tt_fini(ttm);\r\nkfree(agp_be);\r\n}\r\nstruct ttm_tt *ttm_agp_tt_create(struct ttm_bo_device *bdev,\r\nstruct agp_bridge_data *bridge,\r\nunsigned long size, uint32_t page_flags,\r\nstruct page *dummy_read_page)\r\n{\r\nstruct ttm_agp_backend *agp_be;\r\nagp_be = kmalloc(sizeof(*agp_be), GFP_KERNEL);\r\nif (!agp_be)\r\nreturn NULL;\r\nagp_be->mem = NULL;\r\nagp_be->bridge = bridge;\r\nagp_be->ttm.func = &ttm_agp_func;\r\nif (ttm_tt_init(&agp_be->ttm, bdev, size, page_flags, dummy_read_page)) {\r\nreturn NULL;\r\n}\r\nreturn &agp_be->ttm;\r\n}\r\nint ttm_agp_tt_populate(struct ttm_tt *ttm)\r\n{\r\nif (ttm->state != tt_unpopulated)\r\nreturn 0;\r\nreturn ttm_pool_populate(ttm);\r\n}\r\nvoid ttm_agp_tt_unpopulate(struct ttm_tt *ttm)\r\n{\r\nttm_pool_unpopulate(ttm);\r\n}

static void ip_vs_read_cpu_stats(struct ip_vs_stats_user *sum,\r\nstruct ip_vs_cpu_stats *stats)\r\n{\r\nint i;\r\nfor_each_possible_cpu(i) {\r\nstruct ip_vs_cpu_stats *s = per_cpu_ptr(stats, i);\r\nunsigned int start;\r\n__u64 inbytes, outbytes;\r\nif (i) {\r\nsum->conns += s->ustats.conns;\r\nsum->inpkts += s->ustats.inpkts;\r\nsum->outpkts += s->ustats.outpkts;\r\ndo {\r\nstart = u64_stats_fetch_begin(&s->syncp);\r\ninbytes = s->ustats.inbytes;\r\noutbytes = s->ustats.outbytes;\r\n} while (u64_stats_fetch_retry(&s->syncp, start));\r\nsum->inbytes += inbytes;\r\nsum->outbytes += outbytes;\r\n} else {\r\nsum->conns = s->ustats.conns;\r\nsum->inpkts = s->ustats.inpkts;\r\nsum->outpkts = s->ustats.outpkts;\r\ndo {\r\nstart = u64_stats_fetch_begin(&s->syncp);\r\nsum->inbytes = s->ustats.inbytes;\r\nsum->outbytes = s->ustats.outbytes;\r\n} while (u64_stats_fetch_retry(&s->syncp, start));\r\n}\r\n}\r\n}\r\nstatic void estimation_timer(unsigned long arg)\r\n{\r\nstruct ip_vs_estimator *e;\r\nstruct ip_vs_stats *s;\r\nu32 n_conns;\r\nu32 n_inpkts, n_outpkts;\r\nu64 n_inbytes, n_outbytes;\r\nu32 rate;\r\nstruct net *net = (struct net *)arg;\r\nstruct netns_ipvs *ipvs;\r\nipvs = net_ipvs(net);\r\nspin_lock(&ipvs->est_lock);\r\nlist_for_each_entry(e, &ipvs->est_list, list) {\r\ns = container_of(e, struct ip_vs_stats, est);\r\nspin_lock(&s->lock);\r\nip_vs_read_cpu_stats(&s->ustats, s->cpustats);\r\nn_conns = s->ustats.conns;\r\nn_inpkts = s->ustats.inpkts;\r\nn_outpkts = s->ustats.outpkts;\r\nn_inbytes = s->ustats.inbytes;\r\nn_outbytes = s->ustats.outbytes;\r\nrate = (n_conns - e->last_conns) << 9;\r\ne->last_conns = n_conns;\r\ne->cps += ((long)rate - (long)e->cps) >> 2;\r\nrate = (n_inpkts - e->last_inpkts) << 9;\r\ne->last_inpkts = n_inpkts;\r\ne->inpps += ((long)rate - (long)e->inpps) >> 2;\r\nrate = (n_outpkts - e->last_outpkts) << 9;\r\ne->last_outpkts = n_outpkts;\r\ne->outpps += ((long)rate - (long)e->outpps) >> 2;\r\nrate = (n_inbytes - e->last_inbytes) << 4;\r\ne->last_inbytes = n_inbytes;\r\ne->inbps += ((long)rate - (long)e->inbps) >> 2;\r\nrate = (n_outbytes - e->last_outbytes) << 4;\r\ne->last_outbytes = n_outbytes;\r\ne->outbps += ((long)rate - (long)e->outbps) >> 2;\r\nspin_unlock(&s->lock);\r\n}\r\nspin_unlock(&ipvs->est_lock);\r\nmod_timer(&ipvs->est_timer, jiffies + 2*HZ);\r\n}\r\nvoid ip_vs_start_estimator(struct net *net, struct ip_vs_stats *stats)\r\n{\r\nstruct netns_ipvs *ipvs = net_ipvs(net);\r\nstruct ip_vs_estimator *est = &stats->est;\r\nINIT_LIST_HEAD(&est->list);\r\nspin_lock_bh(&ipvs->est_lock);\r\nlist_add(&est->list, &ipvs->est_list);\r\nspin_unlock_bh(&ipvs->est_lock);\r\n}\r\nvoid ip_vs_stop_estimator(struct net *net, struct ip_vs_stats *stats)\r\n{\r\nstruct netns_ipvs *ipvs = net_ipvs(net);\r\nstruct ip_vs_estimator *est = &stats->est;\r\nspin_lock_bh(&ipvs->est_lock);\r\nlist_del(&est->list);\r\nspin_unlock_bh(&ipvs->est_lock);\r\n}\r\nvoid ip_vs_zero_estimator(struct ip_vs_stats *stats)\r\n{\r\nstruct ip_vs_estimator *est = &stats->est;\r\nstruct ip_vs_stats_user *u = &stats->ustats;\r\nest->last_inbytes = u->inbytes;\r\nest->last_outbytes = u->outbytes;\r\nest->last_conns = u->conns;\r\nest->last_inpkts = u->inpkts;\r\nest->last_outpkts = u->outpkts;\r\nest->cps = 0;\r\nest->inpps = 0;\r\nest->outpps = 0;\r\nest->inbps = 0;\r\nest->outbps = 0;\r\n}\r\nvoid ip_vs_read_estimator(struct ip_vs_stats_user *dst,\r\nstruct ip_vs_stats *stats)\r\n{\r\nstruct ip_vs_estimator *e = &stats->est;\r\ndst->cps = (e->cps + 0x1FF) >> 10;\r\ndst->inpps = (e->inpps + 0x1FF) >> 10;\r\ndst->outpps = (e->outpps + 0x1FF) >> 10;\r\ndst->inbps = (e->inbps + 0xF) >> 5;\r\ndst->outbps = (e->outbps + 0xF) >> 5;\r\n}\r\nint __net_init ip_vs_estimator_net_init(struct net *net)\r\n{\r\nstruct netns_ipvs *ipvs = net_ipvs(net);\r\nINIT_LIST_HEAD(&ipvs->est_list);\r\nspin_lock_init(&ipvs->est_lock);\r\nsetup_timer(&ipvs->est_timer, estimation_timer, (unsigned long)net);\r\nmod_timer(&ipvs->est_timer, jiffies + 2 * HZ);\r\nreturn 0;\r\n}\r\nvoid __net_exit ip_vs_estimator_net_cleanup(struct net *net)\r\n{\r\ndel_timer_sync(&net_ipvs(net)->est_timer);\r\n}

void dump_mem(char *prompt, void *p, int l)\r\n{\r\npr_info("%s dumping %s (%d bytes):\n",\r\nPCAN_USB_DRIVER_NAME, prompt ? prompt : "memory", l);\r\nprint_hex_dump(KERN_INFO, PCAN_USB_DRIVER_NAME " ", DUMP_PREFIX_NONE,\r\nDUMP_WIDTH, 1, p, l, false);\r\n}\r\nvoid peak_usb_init_time_ref(struct peak_time_ref *time_ref,\r\nstruct peak_usb_adapter *adapter)\r\n{\r\nif (time_ref) {\r\nmemset(time_ref, 0, sizeof(struct peak_time_ref));\r\ntime_ref->adapter = adapter;\r\n}\r\n}\r\nstatic void peak_usb_add_us(struct timeval *tv, u32 delta_us)\r\n{\r\nu32 delta_s = delta_us / 1000000;\r\ndelta_us -= delta_s * 1000000;\r\ntv->tv_usec += delta_us;\r\nif (tv->tv_usec >= 1000000) {\r\ntv->tv_usec -= 1000000;\r\ndelta_s++;\r\n}\r\ntv->tv_sec += delta_s;\r\n}\r\nvoid peak_usb_update_ts_now(struct peak_time_ref *time_ref, u32 ts_now)\r\n{\r\ntime_ref->ts_dev_2 = ts_now;\r\nif (time_ref->tv_host.tv_sec > 0) {\r\nu32 delta_ts = time_ref->ts_dev_2 - time_ref->ts_dev_1;\r\nif (time_ref->ts_dev_2 < time_ref->ts_dev_1)\r\ndelta_ts &= (1 << time_ref->adapter->ts_used_bits) - 1;\r\ntime_ref->ts_total += delta_ts;\r\n}\r\n}\r\nvoid peak_usb_set_ts_now(struct peak_time_ref *time_ref, u32 ts_now)\r\n{\r\nif (time_ref->tv_host_0.tv_sec == 0) {\r\ntime_ref->tv_host_0 = ktime_to_timeval(ktime_get());\r\ntime_ref->tv_host.tv_sec = 0;\r\n} else {\r\nif (time_ref->tv_host.tv_sec != 0) {\r\nu32 delta_s = time_ref->tv_host.tv_sec\r\n- time_ref->tv_host_0.tv_sec;\r\nif (delta_s > 4200) {\r\ntime_ref->tv_host_0 = time_ref->tv_host;\r\ntime_ref->ts_total = 0;\r\n}\r\n}\r\ntime_ref->tv_host = ktime_to_timeval(ktime_get());\r\ntime_ref->tick_count++;\r\n}\r\ntime_ref->ts_dev_1 = time_ref->ts_dev_2;\r\npeak_usb_update_ts_now(time_ref, ts_now);\r\n}\r\nvoid peak_usb_get_ts_tv(struct peak_time_ref *time_ref, u32 ts,\r\nstruct timeval *tv)\r\n{\r\nif (time_ref->tv_host.tv_sec > 0) {\r\nu64 delta_us;\r\ndelta_us = ts - time_ref->ts_dev_2;\r\nif (ts < time_ref->ts_dev_2)\r\ndelta_us &= (1 << time_ref->adapter->ts_used_bits) - 1;\r\ndelta_us += time_ref->ts_total;\r\ndelta_us *= time_ref->adapter->us_per_ts_scale;\r\ndelta_us >>= time_ref->adapter->us_per_ts_shift;\r\n*tv = time_ref->tv_host_0;\r\npeak_usb_add_us(tv, (u32)delta_us);\r\n} else {\r\n*tv = ktime_to_timeval(ktime_get());\r\n}\r\n}\r\nstatic void peak_usb_read_bulk_callback(struct urb *urb)\r\n{\r\nstruct peak_usb_device *dev = urb->context;\r\nstruct net_device *netdev;\r\nint err;\r\nnetdev = dev->netdev;\r\nif (!netif_device_present(netdev))\r\nreturn;\r\nswitch (urb->status) {\r\ncase 0:\r\nbreak;\r\ncase -EILSEQ:\r\ncase -ENOENT:\r\ncase -ECONNRESET:\r\ncase -ESHUTDOWN:\r\nreturn;\r\ndefault:\r\nif (net_ratelimit())\r\nnetdev_err(netdev,\r\n"Rx urb aborted (%d)\n", urb->status);\r\ngoto resubmit_urb;\r\n}\r\nif ((urb->actual_length > 0) && (dev->adapter->dev_decode_buf)) {\r\nif (dev->state & PCAN_USB_STATE_STARTED) {\r\nerr = dev->adapter->dev_decode_buf(dev, urb);\r\nif (err)\r\ndump_mem("received usb message",\r\nurb->transfer_buffer,\r\nurb->transfer_buffer_length);\r\n}\r\n}\r\nresubmit_urb:\r\nusb_fill_bulk_urb(urb, dev->udev,\r\nusb_rcvbulkpipe(dev->udev, dev->ep_msg_in),\r\nurb->transfer_buffer, dev->adapter->rx_buffer_size,\r\npeak_usb_read_bulk_callback, dev);\r\nusb_anchor_urb(urb, &dev->rx_submitted);\r\nerr = usb_submit_urb(urb, GFP_ATOMIC);\r\nif (!err)\r\nreturn;\r\nusb_unanchor_urb(urb);\r\nif (err == -ENODEV)\r\nnetif_device_detach(netdev);\r\nelse\r\nnetdev_err(netdev, "failed resubmitting read bulk urb: %d\n",\r\nerr);\r\n}\r\nstatic void peak_usb_write_bulk_callback(struct urb *urb)\r\n{\r\nstruct peak_tx_urb_context *context = urb->context;\r\nstruct peak_usb_device *dev;\r\nstruct net_device *netdev;\r\nBUG_ON(!context);\r\ndev = context->dev;\r\nnetdev = dev->netdev;\r\natomic_dec(&dev->active_tx_urbs);\r\nif (!netif_device_present(netdev))\r\nreturn;\r\nswitch (urb->status) {\r\ncase 0:\r\nnetdev->stats.tx_packets++;\r\nnetdev->stats.tx_bytes += context->dlc;\r\nnetdev->trans_start = jiffies;\r\nbreak;\r\ndefault:\r\nif (net_ratelimit())\r\nnetdev_err(netdev, "Tx urb aborted (%d)\n",\r\nurb->status);\r\ncase -EPROTO:\r\ncase -ENOENT:\r\ncase -ECONNRESET:\r\ncase -ESHUTDOWN:\r\nbreak;\r\n}\r\ncan_get_echo_skb(netdev, context->echo_index);\r\ncontext->echo_index = PCAN_USB_MAX_TX_URBS;\r\nif (!urb->status)\r\nnetif_wake_queue(netdev);\r\n}\r\nstatic netdev_tx_t peak_usb_ndo_start_xmit(struct sk_buff *skb,\r\nstruct net_device *netdev)\r\n{\r\nstruct peak_usb_device *dev = netdev_priv(netdev);\r\nstruct peak_tx_urb_context *context = NULL;\r\nstruct net_device_stats *stats = &netdev->stats;\r\nstruct can_frame *cf = (struct can_frame *)skb->data;\r\nstruct urb *urb;\r\nu8 *obuf;\r\nint i, err;\r\nsize_t size = dev->adapter->tx_buffer_size;\r\nif (can_dropped_invalid_skb(netdev, skb))\r\nreturn NETDEV_TX_OK;\r\nfor (i = 0; i < PCAN_USB_MAX_TX_URBS; i++)\r\nif (dev->tx_contexts[i].echo_index == PCAN_USB_MAX_TX_URBS) {\r\ncontext = dev->tx_contexts + i;\r\nbreak;\r\n}\r\nif (!context) {\r\nreturn NETDEV_TX_BUSY;\r\n}\r\nurb = context->urb;\r\nobuf = urb->transfer_buffer;\r\nerr = dev->adapter->dev_encode_msg(dev, skb, obuf, &size);\r\nif (err) {\r\nif (net_ratelimit())\r\nnetdev_err(netdev, "packet dropped\n");\r\ndev_kfree_skb(skb);\r\nstats->tx_dropped++;\r\nreturn NETDEV_TX_OK;\r\n}\r\ncontext->echo_index = i;\r\ncontext->dlc = cf->can_dlc;\r\nusb_anchor_urb(urb, &dev->tx_submitted);\r\ncan_put_echo_skb(skb, netdev, context->echo_index);\r\natomic_inc(&dev->active_tx_urbs);\r\nerr = usb_submit_urb(urb, GFP_ATOMIC);\r\nif (err) {\r\ncan_free_echo_skb(netdev, context->echo_index);\r\nusb_unanchor_urb(urb);\r\ncontext->echo_index = PCAN_USB_MAX_TX_URBS;\r\natomic_dec(&dev->active_tx_urbs);\r\nswitch (err) {\r\ncase -ENODEV:\r\nnetif_device_detach(netdev);\r\nbreak;\r\ndefault:\r\nnetdev_warn(netdev, "tx urb submitting failed err=%d\n",\r\nerr);\r\ncase -ENOENT:\r\nstats->tx_dropped++;\r\n}\r\n} else {\r\nnetdev->trans_start = jiffies;\r\nif (atomic_read(&dev->active_tx_urbs) >= PCAN_USB_MAX_TX_URBS)\r\nnetif_stop_queue(netdev);\r\n}\r\nreturn NETDEV_TX_OK;\r\n}\r\nstatic int peak_usb_start(struct peak_usb_device *dev)\r\n{\r\nstruct net_device *netdev = dev->netdev;\r\nint err, i;\r\nfor (i = 0; i < PCAN_USB_MAX_RX_URBS; i++) {\r\nstruct urb *urb;\r\nu8 *buf;\r\nurb = usb_alloc_urb(0, GFP_KERNEL);\r\nif (!urb) {\r\nnetdev_err(netdev, "No memory left for URBs\n");\r\nerr = -ENOMEM;\r\nbreak;\r\n}\r\nbuf = kmalloc(dev->adapter->rx_buffer_size, GFP_KERNEL);\r\nif (!buf) {\r\nnetdev_err(netdev, "No memory left for USB buffer\n");\r\nusb_free_urb(urb);\r\nerr = -ENOMEM;\r\nbreak;\r\n}\r\nusb_fill_bulk_urb(urb, dev->udev,\r\nusb_rcvbulkpipe(dev->udev, dev->ep_msg_in),\r\nbuf, dev->adapter->rx_buffer_size,\r\npeak_usb_read_bulk_callback, dev);\r\nurb->transfer_flags |= URB_FREE_BUFFER;\r\nusb_anchor_urb(urb, &dev->rx_submitted);\r\nerr = usb_submit_urb(urb, GFP_KERNEL);\r\nif (err) {\r\nif (err == -ENODEV)\r\nnetif_device_detach(dev->netdev);\r\nusb_unanchor_urb(urb);\r\nkfree(buf);\r\nusb_free_urb(urb);\r\nbreak;\r\n}\r\nusb_free_urb(urb);\r\n}\r\nif (i < PCAN_USB_MAX_RX_URBS) {\r\nif (i == 0) {\r\nnetdev_err(netdev, "couldn't setup any rx URB\n");\r\nreturn err;\r\n}\r\nnetdev_warn(netdev, "rx performance may be slow\n");\r\n}\r\nfor (i = 0; i < PCAN_USB_MAX_TX_URBS; i++) {\r\nstruct peak_tx_urb_context *context;\r\nstruct urb *urb;\r\nu8 *buf;\r\nurb = usb_alloc_urb(0, GFP_KERNEL);\r\nif (!urb) {\r\nnetdev_err(netdev, "No memory left for URBs\n");\r\nerr = -ENOMEM;\r\nbreak;\r\n}\r\nbuf = kmalloc(dev->adapter->tx_buffer_size, GFP_KERNEL);\r\nif (!buf) {\r\nnetdev_err(netdev, "No memory left for USB buffer\n");\r\nusb_free_urb(urb);\r\nerr = -ENOMEM;\r\nbreak;\r\n}\r\ncontext = dev->tx_contexts + i;\r\ncontext->dev = dev;\r\ncontext->urb = urb;\r\nusb_fill_bulk_urb(urb, dev->udev,\r\nusb_sndbulkpipe(dev->udev, dev->ep_msg_out),\r\nbuf, dev->adapter->tx_buffer_size,\r\npeak_usb_write_bulk_callback, context);\r\nurb->transfer_flags |= URB_FREE_BUFFER;\r\n}\r\nif (i < PCAN_USB_MAX_TX_URBS) {\r\nif (i == 0) {\r\nnetdev_err(netdev, "couldn't setup any tx URB\n");\r\nreturn err;\r\n}\r\nnetdev_warn(netdev, "tx performance may be slow\n");\r\n}\r\nif (dev->adapter->dev_start) {\r\nerr = dev->adapter->dev_start(dev);\r\nif (err)\r\ngoto failed;\r\n}\r\ndev->state |= PCAN_USB_STATE_STARTED;\r\nif (dev->adapter->dev_set_bus) {\r\nerr = dev->adapter->dev_set_bus(dev, 1);\r\nif (err)\r\ngoto failed;\r\n}\r\ndev->can.state = CAN_STATE_ERROR_ACTIVE;\r\nreturn 0;\r\nfailed:\r\nif (err == -ENODEV)\r\nnetif_device_detach(dev->netdev);\r\nnetdev_warn(netdev, "couldn't submit control: %d\n", err);\r\nreturn err;\r\n}\r\nstatic int peak_usb_ndo_open(struct net_device *netdev)\r\n{\r\nstruct peak_usb_device *dev = netdev_priv(netdev);\r\nint err;\r\nerr = open_candev(netdev);\r\nif (err)\r\nreturn err;\r\nerr = peak_usb_start(dev);\r\nif (err) {\r\nnetdev_err(netdev, "couldn't start device: %d\n", err);\r\nclose_candev(netdev);\r\nreturn err;\r\n}\r\ndev->open_time = jiffies;\r\nnetif_start_queue(netdev);\r\nreturn 0;\r\n}\r\nstatic void peak_usb_unlink_all_urbs(struct peak_usb_device *dev)\r\n{\r\nint i;\r\nusb_kill_anchored_urbs(&dev->rx_submitted);\r\nfor (i = 0; i < PCAN_USB_MAX_TX_URBS; i++) {\r\nstruct urb *urb = dev->tx_contexts[i].urb;\r\nif (!urb ||\r\ndev->tx_contexts[i].echo_index != PCAN_USB_MAX_TX_URBS) {\r\ncontinue;\r\n}\r\nusb_free_urb(urb);\r\ndev->tx_contexts[i].urb = NULL;\r\n}\r\nusb_kill_anchored_urbs(&dev->tx_submitted);\r\natomic_set(&dev->active_tx_urbs, 0);\r\n}\r\nstatic int peak_usb_ndo_stop(struct net_device *netdev)\r\n{\r\nstruct peak_usb_device *dev = netdev_priv(netdev);\r\ndev->state &= ~PCAN_USB_STATE_STARTED;\r\nnetif_stop_queue(netdev);\r\npeak_usb_unlink_all_urbs(dev);\r\nif (dev->adapter->dev_stop)\r\ndev->adapter->dev_stop(dev);\r\nclose_candev(netdev);\r\ndev->open_time = 0;\r\ndev->can.state = CAN_STATE_STOPPED;\r\nif (dev->adapter->dev_set_bus) {\r\nint err = dev->adapter->dev_set_bus(dev, 0);\r\nif (err)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nvoid peak_usb_restart_complete(struct peak_usb_device *dev)\r\n{\r\ndev->can.state = CAN_STATE_ERROR_ACTIVE;\r\nnetif_wake_queue(dev->netdev);\r\n}\r\nvoid peak_usb_async_complete(struct urb *urb)\r\n{\r\nkfree(urb->transfer_buffer);\r\nusb_free_urb(urb);\r\n}\r\nstatic int peak_usb_restart(struct peak_usb_device *dev)\r\n{\r\nstruct urb *urb;\r\nint err;\r\nu8 *buf;\r\nif (!dev->adapter->dev_restart_async) {\r\npeak_usb_restart_complete(dev);\r\nreturn 0;\r\n}\r\nurb = usb_alloc_urb(0, GFP_ATOMIC);\r\nif (!urb) {\r\nnetdev_err(dev->netdev, "no memory left for urb\n");\r\nreturn -ENOMEM;\r\n}\r\nbuf = kmalloc(PCAN_USB_MAX_CMD_LEN, GFP_ATOMIC);\r\nif (!buf) {\r\nnetdev_err(dev->netdev, "no memory left for async cmd\n");\r\nusb_free_urb(urb);\r\nreturn -ENOMEM;\r\n}\r\nerr = dev->adapter->dev_restart_async(dev, urb, buf);\r\nif (!err)\r\nreturn 0;\r\nkfree(buf);\r\nusb_free_urb(urb);\r\nreturn err;\r\n}\r\nstatic int peak_usb_set_mode(struct net_device *netdev, enum can_mode mode)\r\n{\r\nstruct peak_usb_device *dev = netdev_priv(netdev);\r\nint err = 0;\r\nif (!dev->open_time)\r\nreturn -EINVAL;\r\nswitch (mode) {\r\ncase CAN_MODE_START:\r\nerr = peak_usb_restart(dev);\r\nif (err)\r\nnetdev_err(netdev, "couldn't start device (err %d)\n",\r\nerr);\r\nbreak;\r\ndefault:\r\nreturn -EOPNOTSUPP;\r\n}\r\nreturn err;\r\n}\r\nstatic int peak_usb_set_bittiming(struct net_device *netdev)\r\n{\r\nstruct peak_usb_device *dev = netdev_priv(netdev);\r\nstruct can_bittiming *bt = &dev->can.bittiming;\r\nif (dev->adapter->dev_set_bittiming) {\r\nint err = dev->adapter->dev_set_bittiming(dev, bt);\r\nif (err)\r\nnetdev_info(netdev, "couldn't set bitrate (err %d)\n",\r\nerr);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int peak_usb_create_dev(struct peak_usb_adapter *peak_usb_adapter,\r\nstruct usb_interface *intf, int ctrl_idx)\r\n{\r\nstruct usb_device *usb_dev = interface_to_usbdev(intf);\r\nint sizeof_candev = peak_usb_adapter->sizeof_dev_private;\r\nstruct peak_usb_device *dev;\r\nstruct net_device *netdev;\r\nint i, err;\r\nu16 tmp16;\r\nif (sizeof_candev < sizeof(struct peak_usb_device))\r\nsizeof_candev = sizeof(struct peak_usb_device);\r\nnetdev = alloc_candev(sizeof_candev, PCAN_USB_MAX_TX_URBS);\r\nif (!netdev) {\r\ndev_err(&intf->dev, "%s: couldn't alloc candev\n",\r\nPCAN_USB_DRIVER_NAME);\r\nreturn -ENOMEM;\r\n}\r\ndev = netdev_priv(netdev);\r\ndev->cmd_buf = kmalloc(PCAN_USB_MAX_CMD_LEN, GFP_KERNEL);\r\nif (!dev->cmd_buf) {\r\ndev_err(&intf->dev, "%s: couldn't alloc cmd buffer\n",\r\nPCAN_USB_DRIVER_NAME);\r\nerr = -ENOMEM;\r\ngoto lbl_set_intf_data;\r\n}\r\ndev->udev = usb_dev;\r\ndev->netdev = netdev;\r\ndev->adapter = peak_usb_adapter;\r\ndev->ctrl_idx = ctrl_idx;\r\ndev->state = PCAN_USB_STATE_CONNECTED;\r\ndev->ep_msg_in = peak_usb_adapter->ep_msg_in;\r\ndev->ep_msg_out = peak_usb_adapter->ep_msg_out[ctrl_idx];\r\ndev->can.clock = peak_usb_adapter->clock;\r\ndev->can.bittiming_const = &peak_usb_adapter->bittiming_const;\r\ndev->can.do_set_bittiming = peak_usb_set_bittiming;\r\ndev->can.do_set_mode = peak_usb_set_mode;\r\ndev->can.ctrlmode_supported = CAN_CTRLMODE_3_SAMPLES |\r\nCAN_CTRLMODE_LISTENONLY;\r\nnetdev->netdev_ops = &peak_usb_netdev_ops;\r\nnetdev->flags |= IFF_ECHO;\r\ninit_usb_anchor(&dev->rx_submitted);\r\ninit_usb_anchor(&dev->tx_submitted);\r\natomic_set(&dev->active_tx_urbs, 0);\r\nfor (i = 0; i < PCAN_USB_MAX_TX_URBS; i++)\r\ndev->tx_contexts[i].echo_index = PCAN_USB_MAX_TX_URBS;\r\ndev->prev_siblings = usb_get_intfdata(intf);\r\nusb_set_intfdata(intf, dev);\r\nSET_NETDEV_DEV(netdev, &intf->dev);\r\nerr = register_candev(netdev);\r\nif (err) {\r\ndev_err(&intf->dev, "couldn't register CAN device: %d\n", err);\r\ngoto lbl_free_cmd_buf;\r\n}\r\nif (dev->prev_siblings)\r\n(dev->prev_siblings)->next_siblings = dev;\r\ntmp16 = le16_to_cpu(usb_dev->descriptor.bcdDevice);\r\ndev->device_rev = tmp16 >> 8;\r\nif (dev->adapter->dev_init) {\r\nerr = dev->adapter->dev_init(dev);\r\nif (err)\r\ngoto lbl_free_cmd_buf;\r\n}\r\nif (dev->adapter->dev_set_bus) {\r\nerr = dev->adapter->dev_set_bus(dev, 0);\r\nif (err)\r\ngoto lbl_free_cmd_buf;\r\n}\r\nif (dev->adapter->dev_get_device_id)\r\ndev->adapter->dev_get_device_id(dev, &dev->device_number);\r\nnetdev_info(netdev, "attached to %s channel %u (device %u)\n",\r\npeak_usb_adapter->name, ctrl_idx, dev->device_number);\r\nreturn 0;\r\nlbl_free_cmd_buf:\r\nkfree(dev->cmd_buf);\r\nlbl_set_intf_data:\r\nusb_set_intfdata(intf, dev->prev_siblings);\r\nfree_candev(netdev);\r\nreturn err;\r\n}\r\nstatic void peak_usb_disconnect(struct usb_interface *intf)\r\n{\r\nstruct peak_usb_device *dev;\r\nfor (dev = usb_get_intfdata(intf); dev; dev = dev->prev_siblings) {\r\nstruct net_device *netdev = dev->netdev;\r\nchar name[IFNAMSIZ];\r\ndev->state &= ~PCAN_USB_STATE_CONNECTED;\r\nstrncpy(name, netdev->name, IFNAMSIZ);\r\nunregister_netdev(netdev);\r\nfree_candev(netdev);\r\nkfree(dev->cmd_buf);\r\ndev->next_siblings = NULL;\r\nif (dev->adapter->dev_free)\r\ndev->adapter->dev_free(dev);\r\ndev_info(&intf->dev, "%s removed\n", name);\r\n}\r\nusb_set_intfdata(intf, NULL);\r\n}\r\nstatic int peak_usb_probe(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct usb_device *usb_dev = interface_to_usbdev(intf);\r\nstruct peak_usb_adapter *peak_usb_adapter, **pp;\r\nint i, err = -ENOMEM;\r\nusb_dev = interface_to_usbdev(intf);\r\nfor (pp = peak_usb_adapters_list; *pp; pp++)\r\nif ((*pp)->device_id == usb_dev->descriptor.idProduct)\r\nbreak;\r\npeak_usb_adapter = *pp;\r\nif (!peak_usb_adapter) {\r\npr_err("%s: didn't find device id. 0x%x in devices list\n",\r\nPCAN_USB_DRIVER_NAME, usb_dev->descriptor.idProduct);\r\nreturn -ENODEV;\r\n}\r\nif (peak_usb_adapter->intf_probe) {\r\nerr = peak_usb_adapter->intf_probe(intf);\r\nif (err)\r\nreturn err;\r\n}\r\nfor (i = 0; i < peak_usb_adapter->ctrl_count; i++) {\r\nerr = peak_usb_create_dev(peak_usb_adapter, intf, i);\r\nif (err) {\r\npeak_usb_disconnect(intf);\r\nbreak;\r\n}\r\n}\r\nreturn err;\r\n}\r\nstatic int __init peak_usb_init(void)\r\n{\r\nint err;\r\nerr = usb_register(&peak_usb_driver);\r\nif (err)\r\npr_err("%s: usb_register failed (err %d)\n",\r\nPCAN_USB_DRIVER_NAME, err);\r\nreturn err;\r\n}\r\nstatic int peak_usb_do_device_exit(struct device *d, void *arg)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(d);\r\nstruct peak_usb_device *dev;\r\nfor (dev = usb_get_intfdata(intf); dev; dev = dev->prev_siblings) {\r\nstruct net_device *netdev = dev->netdev;\r\nif (netif_device_present(netdev))\r\nif (dev->adapter->dev_exit)\r\ndev->adapter->dev_exit(dev);\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit peak_usb_exit(void)\r\n{\r\nint err;\r\nerr = driver_for_each_device(&peak_usb_driver.drvwrap.driver, NULL,\r\nNULL, peak_usb_do_device_exit);\r\nif (err)\r\npr_err("%s: failed to stop all can devices (err %d)\n",\r\nPCAN_USB_DRIVER_NAME, err);\r\nusb_deregister(&peak_usb_driver);\r\npr_info("%s: PCAN-USB interfaces driver unloaded\n",\r\nPCAN_USB_DRIVER_NAME);\r\n}

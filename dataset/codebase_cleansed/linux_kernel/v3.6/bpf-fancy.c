int main(int argc, char **argv)\r\n{\r\nstruct bpf_labels l;\r\nstatic const char msg1[] = "Please type something: ";\r\nstatic const char msg2[] = "You typed: ";\r\nchar buf[256];\r\nstruct sock_filter filter[] = {\r\nLOAD_SYSCALL_NR,\r\nSYSCALL(__NR_exit, ALLOW),\r\nSYSCALL(__NR_exit_group, ALLOW),\r\nSYSCALL(__NR_write, JUMP(&l, write_fd)),\r\nSYSCALL(__NR_read, JUMP(&l, read)),\r\nDENY,\r\nLABEL(&l, read),\r\nARG(0),\r\nJNE(STDIN_FILENO, DENY),\r\nARG(1),\r\nJNE((unsigned long)buf, DENY),\r\nARG(2),\r\nJGE(sizeof(buf), DENY),\r\nALLOW,\r\nLABEL(&l, write_fd),\r\nARG(0),\r\nJEQ(STDOUT_FILENO, JUMP(&l, write_buf)),\r\nJEQ(STDERR_FILENO, JUMP(&l, write_buf)),\r\nDENY,\r\nLABEL(&l, write_buf),\r\nARG(1),\r\nJEQ((unsigned long)msg1, JUMP(&l, msg1_len)),\r\nJEQ((unsigned long)msg2, JUMP(&l, msg2_len)),\r\nJEQ((unsigned long)buf, JUMP(&l, buf_len)),\r\nDENY,\r\nLABEL(&l, msg1_len),\r\nARG(2),\r\nJLT(sizeof(msg1), ALLOW),\r\nDENY,\r\nLABEL(&l, msg2_len),\r\nARG(2),\r\nJLT(sizeof(msg2), ALLOW),\r\nDENY,\r\nLABEL(&l, buf_len),\r\nARG(2),\r\nJLT(sizeof(buf), ALLOW),\r\nDENY,\r\n};\r\nstruct sock_fprog prog = {\r\n.filter = filter,\r\n.len = (unsigned short)(sizeof(filter)/sizeof(filter[0])),\r\n};\r\nssize_t bytes;\r\nbpf_resolve_jumps(&l, filter, sizeof(filter)/sizeof(*filter));\r\nif (prctl(PR_SET_NO_NEW_PRIVS, 1, 0, 0, 0)) {\r\nperror("prctl(NO_NEW_PRIVS)");\r\nreturn 1;\r\n}\r\nif (prctl(PR_SET_SECCOMP, SECCOMP_MODE_FILTER, &prog)) {\r\nperror("prctl(SECCOMP)");\r\nreturn 1;\r\n}\r\nsyscall(__NR_write, STDOUT_FILENO, msg1, strlen(msg1));\r\nbytes = syscall(__NR_read, STDIN_FILENO, buf, sizeof(buf)-1);\r\nbytes = (bytes > 0 ? bytes : 0);\r\nsyscall(__NR_write, STDERR_FILENO, msg2, strlen(msg2));\r\nsyscall(__NR_write, STDERR_FILENO, buf, bytes);\r\nsyscall(__NR_write, STDERR_FILENO, msg2, strlen(msg2)+2);\r\nreturn 0;\r\n}

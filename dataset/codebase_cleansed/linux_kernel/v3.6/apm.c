int query_apm_bios(void)\r\n{\r\nstruct biosregs ireg, oreg;\r\ninitregs(&ireg);\r\nireg.ah = 0x53;\r\nintcall(0x15, &ireg, &oreg);\r\nif (oreg.flags & X86_EFLAGS_CF)\r\nreturn -1;\r\nif (oreg.bx != 0x504d)\r\nreturn -1;\r\nif (!(oreg.cx & 0x02))\r\nreturn -1;\r\nireg.al = 0x04;\r\nintcall(0x15, &ireg, NULL);\r\nireg.al = 0x03;\r\nintcall(0x15, &ireg, &oreg);\r\nboot_params.apm_bios_info.cseg = oreg.ax;\r\nboot_params.apm_bios_info.offset = oreg.ebx;\r\nboot_params.apm_bios_info.cseg_16 = oreg.cx;\r\nboot_params.apm_bios_info.dseg = oreg.dx;\r\nboot_params.apm_bios_info.cseg_len = oreg.si;\r\nboot_params.apm_bios_info.cseg_16_len = oreg.hsi;\r\nboot_params.apm_bios_info.dseg_len = oreg.di;\r\nif (oreg.flags & X86_EFLAGS_CF)\r\nreturn -1;\r\nireg.al = 0x00;\r\nintcall(0x15, &ireg, &oreg);\r\nif ((oreg.eflags & X86_EFLAGS_CF) || oreg.bx != 0x504d) {\r\nireg.al = 0x04;\r\nintcall(0x15, &ireg, NULL);\r\nreturn -1;\r\n}\r\nboot_params.apm_bios_info.version = oreg.ax;\r\nboot_params.apm_bios_info.flags = oreg.cx;\r\nreturn 0;\r\n}

static inline const char *eeh_pcid_name(struct pci_dev *pdev)\r\n{\r\nif (pdev && pdev->dev.driver)\r\nreturn pdev->dev.driver->name;\r\nreturn "";\r\n}\r\nstatic void eeh_disable_irq(struct pci_dev *dev)\r\n{\r\nstruct eeh_dev *edev = pci_dev_to_eeh_dev(dev);\r\nif (dev->msi_enabled || dev->msix_enabled)\r\nreturn;\r\nif (!irq_has_action(dev->irq))\r\nreturn;\r\nedev->mode |= EEH_MODE_IRQ_DISABLED;\r\ndisable_irq_nosync(dev->irq);\r\n}\r\nstatic void eeh_enable_irq(struct pci_dev *dev)\r\n{\r\nstruct eeh_dev *edev = pci_dev_to_eeh_dev(dev);\r\nif ((edev->mode) & EEH_MODE_IRQ_DISABLED) {\r\nedev->mode &= ~EEH_MODE_IRQ_DISABLED;\r\nenable_irq(dev->irq);\r\n}\r\n}\r\nstatic int eeh_report_error(struct pci_dev *dev, void *userdata)\r\n{\r\nenum pci_ers_result rc, *res = userdata;\r\nstruct pci_driver *driver = dev->driver;\r\ndev->error_state = pci_channel_io_frozen;\r\nif (!driver)\r\nreturn 0;\r\neeh_disable_irq(dev);\r\nif (!driver->err_handler ||\r\n!driver->err_handler->error_detected)\r\nreturn 0;\r\nrc = driver->err_handler->error_detected(dev, pci_channel_io_frozen);\r\nif (rc == PCI_ERS_RESULT_NEED_RESET) *res = rc;\r\nif (*res == PCI_ERS_RESULT_NONE) *res = rc;\r\nreturn 0;\r\n}\r\nstatic int eeh_report_mmio_enabled(struct pci_dev *dev, void *userdata)\r\n{\r\nenum pci_ers_result rc, *res = userdata;\r\nstruct pci_driver *driver = dev->driver;\r\nif (!driver ||\r\n!driver->err_handler ||\r\n!driver->err_handler->mmio_enabled)\r\nreturn 0;\r\nrc = driver->err_handler->mmio_enabled(dev);\r\nif (rc == PCI_ERS_RESULT_NEED_RESET) *res = rc;\r\nif (*res == PCI_ERS_RESULT_NONE) *res = rc;\r\nreturn 0;\r\n}\r\nstatic int eeh_report_reset(struct pci_dev *dev, void *userdata)\r\n{\r\nenum pci_ers_result rc, *res = userdata;\r\nstruct pci_driver *driver = dev->driver;\r\nif (!driver)\r\nreturn 0;\r\ndev->error_state = pci_channel_io_normal;\r\neeh_enable_irq(dev);\r\nif (!driver->err_handler ||\r\n!driver->err_handler->slot_reset)\r\nreturn 0;\r\nrc = driver->err_handler->slot_reset(dev);\r\nif ((*res == PCI_ERS_RESULT_NONE) ||\r\n(*res == PCI_ERS_RESULT_RECOVERED)) *res = rc;\r\nif (*res == PCI_ERS_RESULT_DISCONNECT &&\r\nrc == PCI_ERS_RESULT_NEED_RESET) *res = rc;\r\nreturn 0;\r\n}\r\nstatic int eeh_report_resume(struct pci_dev *dev, void *userdata)\r\n{\r\nstruct pci_driver *driver = dev->driver;\r\ndev->error_state = pci_channel_io_normal;\r\nif (!driver)\r\nreturn 0;\r\neeh_enable_irq(dev);\r\nif (!driver->err_handler ||\r\n!driver->err_handler->resume)\r\nreturn 0;\r\ndriver->err_handler->resume(dev);\r\nreturn 0;\r\n}\r\nstatic int eeh_report_failure(struct pci_dev *dev, void *userdata)\r\n{\r\nstruct pci_driver *driver = dev->driver;\r\ndev->error_state = pci_channel_io_perm_failure;\r\nif (!driver)\r\nreturn 0;\r\neeh_disable_irq(dev);\r\nif (!driver->err_handler ||\r\n!driver->err_handler->error_detected)\r\nreturn 0;\r\ndriver->err_handler->error_detected(dev, pci_channel_io_perm_failure);\r\nreturn 0;\r\n}\r\nstatic int eeh_reset_device(struct eeh_dev *edev, struct pci_bus *bus)\r\n{\r\nstruct device_node *dn;\r\nint cnt, rc;\r\ncnt = edev->freeze_count;\r\nif (bus)\r\npcibios_remove_pci_devices(bus);\r\nrc = eeh_reset_pe(edev);\r\nif (rc)\r\nreturn rc;\r\ndn = eeh_dev_to_of_node(edev);\r\nif (!pcibios_find_pci_bus(dn) && of_node_to_eeh_dev(dn->parent))\r\ndn = dn->parent->child;\r\nwhile (dn) {\r\nstruct eeh_dev *pedev = of_node_to_eeh_dev(dn);\r\nif (edev->pe_config_addr == pedev->pe_config_addr) {\r\neeh_ops->configure_bridge(dn);\r\neeh_restore_bars(pedev);\r\n}\r\ndn = dn->sibling;\r\n}\r\nif (bus) {\r\nssleep(5);\r\npcibios_add_pci_devices(bus);\r\n}\r\nedev->freeze_count = cnt;\r\nreturn 0;\r\n}\r\nstruct eeh_dev *handle_eeh_events(struct eeh_event *event)\r\n{\r\nstruct device_node *frozen_dn;\r\nstruct eeh_dev *frozen_edev;\r\nstruct pci_bus *frozen_bus;\r\nint rc = 0;\r\nenum pci_ers_result result = PCI_ERS_RESULT_NONE;\r\nconst char *location, *pci_str, *drv_str, *bus_pci_str, *bus_drv_str;\r\nfrozen_dn = eeh_find_device_pe(eeh_dev_to_of_node(event->edev));\r\nif (!frozen_dn) {\r\nlocation = of_get_property(eeh_dev_to_of_node(event->edev), "ibm,loc-code", NULL);\r\nlocation = location ? location : "unknown";\r\nprintk(KERN_ERR "EEH: Error: Cannot find partition endpoint "\r\n"for location=%s pci addr=%s\n",\r\nlocation, eeh_pci_name(eeh_dev_to_pci_dev(event->edev)));\r\nreturn NULL;\r\n}\r\nfrozen_bus = pcibios_find_pci_bus(frozen_dn);\r\nlocation = of_get_property(frozen_dn, "ibm,loc-code", NULL);\r\nlocation = location ? location : "unknown";\r\nif (!frozen_bus)\r\nfrozen_bus = pcibios_find_pci_bus(frozen_dn->parent);\r\nif (!frozen_bus) {\r\nprintk(KERN_ERR "EEH: Cannot find PCI bus "\r\n"for location=%s dn=%s\n",\r\nlocation, frozen_dn->full_name);\r\nreturn NULL;\r\n}\r\nfrozen_edev = of_node_to_eeh_dev(frozen_dn);\r\nfrozen_edev->freeze_count++;\r\npci_str = eeh_pci_name(eeh_dev_to_pci_dev(event->edev));\r\ndrv_str = eeh_pcid_name(eeh_dev_to_pci_dev(event->edev));\r\nif (frozen_edev->freeze_count > EEH_MAX_ALLOWED_FREEZES)\r\ngoto excess_failures;\r\nprintk(KERN_WARNING\r\n"EEH: This PCI device has failed %d times in the last hour:\n",\r\nfrozen_edev->freeze_count);\r\nif (frozen_edev->pdev) {\r\nbus_pci_str = pci_name(frozen_edev->pdev);\r\nbus_drv_str = eeh_pcid_name(frozen_edev->pdev);\r\nprintk(KERN_WARNING\r\n"EEH: Bus location=%s driver=%s pci addr=%s\n",\r\nlocation, bus_drv_str, bus_pci_str);\r\n}\r\nprintk(KERN_WARNING\r\n"EEH: Device location=%s driver=%s pci addr=%s\n",\r\nlocation, drv_str, pci_str);\r\npci_walk_bus(frozen_bus, eeh_report_error, &result);\r\nrc = eeh_ops->wait_state(eeh_dev_to_of_node(frozen_edev), MAX_WAIT_FOR_RECOVERY*1000);\r\nif (rc < 0 || rc == EEH_STATE_NOT_SUPPORT) {\r\nprintk(KERN_WARNING "EEH: Permanent failure\n");\r\ngoto hard_fail;\r\n}\r\neeh_slot_error_detail(frozen_edev, EEH_LOG_TEMP);\r\nif (result == PCI_ERS_RESULT_NONE) {\r\nrc = eeh_reset_device(frozen_edev, frozen_bus);\r\nif (rc) {\r\nprintk(KERN_WARNING "EEH: Unable to reset, rc=%d\n", rc);\r\ngoto hard_fail;\r\n}\r\n}\r\nif (result == PCI_ERS_RESULT_CAN_RECOVER) {\r\nrc = eeh_pci_enable(frozen_edev, EEH_OPT_THAW_MMIO);\r\nif (rc < 0)\r\ngoto hard_fail;\r\nif (rc) {\r\nresult = PCI_ERS_RESULT_NEED_RESET;\r\n} else {\r\nresult = PCI_ERS_RESULT_NONE;\r\npci_walk_bus(frozen_bus, eeh_report_mmio_enabled, &result);\r\n}\r\n}\r\nif (result == PCI_ERS_RESULT_CAN_RECOVER) {\r\nrc = eeh_pci_enable(frozen_edev, EEH_OPT_THAW_DMA);\r\nif (rc < 0)\r\ngoto hard_fail;\r\nif (rc)\r\nresult = PCI_ERS_RESULT_NEED_RESET;\r\nelse\r\nresult = PCI_ERS_RESULT_RECOVERED;\r\n}\r\nif (result == PCI_ERS_RESULT_DISCONNECT) {\r\nprintk(KERN_WARNING "EEH: Device driver gave up\n");\r\ngoto hard_fail;\r\n}\r\nif (result == PCI_ERS_RESULT_NEED_RESET) {\r\nrc = eeh_reset_device(frozen_edev, NULL);\r\nif (rc) {\r\nprintk(KERN_WARNING "EEH: Cannot reset, rc=%d\n", rc);\r\ngoto hard_fail;\r\n}\r\nresult = PCI_ERS_RESULT_NONE;\r\npci_walk_bus(frozen_bus, eeh_report_reset, &result);\r\n}\r\nif ((result != PCI_ERS_RESULT_RECOVERED) &&\r\n(result != PCI_ERS_RESULT_NONE)) {\r\nprintk(KERN_WARNING "EEH: Not recovered\n");\r\ngoto hard_fail;\r\n}\r\npci_walk_bus(frozen_bus, eeh_report_resume, NULL);\r\nreturn frozen_edev;\r\nexcess_failures:\r\nprintk(KERN_ERR\r\n"EEH: PCI device at location=%s driver=%s pci addr=%s\n"\r\n"has failed %d times in the last hour "\r\n"and has been permanently disabled.\n"\r\n"Please try reseating this device or replacing it.\n",\r\nlocation, drv_str, pci_str, frozen_edev->freeze_count);\r\ngoto perm_error;\r\nhard_fail:\r\nprintk(KERN_ERR\r\n"EEH: Unable to recover from failure of PCI device "\r\n"at location=%s driver=%s pci addr=%s\n"\r\n"Please try reseating this device or replacing it.\n",\r\nlocation, drv_str, pci_str);\r\nperm_error:\r\neeh_slot_error_detail(frozen_edev, EEH_LOG_PERM);\r\npci_walk_bus(frozen_bus, eeh_report_failure, NULL);\r\npcibios_remove_pci_devices(frozen_bus);\r\nreturn NULL;\r\n}

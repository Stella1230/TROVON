static irqreturn_t pcap_rtc_irq(int irq, void *_pcap_rtc)\r\n{\r\nstruct pcap_rtc *pcap_rtc = _pcap_rtc;\r\nunsigned long rtc_events;\r\nif (irq == pcap_to_irq(pcap_rtc->pcap, PCAP_IRQ_1HZ))\r\nrtc_events = RTC_IRQF | RTC_UF;\r\nelse if (irq == pcap_to_irq(pcap_rtc->pcap, PCAP_IRQ_TODA))\r\nrtc_events = RTC_IRQF | RTC_AF;\r\nelse\r\nrtc_events = 0;\r\nrtc_update_irq(pcap_rtc->rtc, 1, rtc_events);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int pcap_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct pcap_rtc *pcap_rtc = platform_get_drvdata(pdev);\r\nstruct rtc_time *tm = &alrm->time;\r\nunsigned long secs;\r\nu32 tod;\r\nu32 days;\r\nezx_pcap_read(pcap_rtc->pcap, PCAP_REG_RTC_TODA, &tod);\r\nsecs = tod & PCAP_RTC_TOD_MASK;\r\nezx_pcap_read(pcap_rtc->pcap, PCAP_REG_RTC_DAYA, &days);\r\nsecs += (days & PCAP_RTC_DAY_MASK) * SEC_PER_DAY;\r\nrtc_time_to_tm(secs, tm);\r\nreturn 0;\r\n}\r\nstatic int pcap_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct pcap_rtc *pcap_rtc = platform_get_drvdata(pdev);\r\nstruct rtc_time *tm = &alrm->time;\r\nunsigned long secs;\r\nu32 tod, days;\r\nrtc_tm_to_time(tm, &secs);\r\ntod = secs % SEC_PER_DAY;\r\nezx_pcap_write(pcap_rtc->pcap, PCAP_REG_RTC_TODA, tod);\r\ndays = secs / SEC_PER_DAY;\r\nezx_pcap_write(pcap_rtc->pcap, PCAP_REG_RTC_DAYA, days);\r\nreturn 0;\r\n}\r\nstatic int pcap_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct pcap_rtc *pcap_rtc = platform_get_drvdata(pdev);\r\nunsigned long secs;\r\nu32 tod, days;\r\nezx_pcap_read(pcap_rtc->pcap, PCAP_REG_RTC_TOD, &tod);\r\nsecs = tod & PCAP_RTC_TOD_MASK;\r\nezx_pcap_read(pcap_rtc->pcap, PCAP_REG_RTC_DAY, &days);\r\nsecs += (days & PCAP_RTC_DAY_MASK) * SEC_PER_DAY;\r\nrtc_time_to_tm(secs, tm);\r\nreturn rtc_valid_tm(tm);\r\n}\r\nstatic int pcap_rtc_set_mmss(struct device *dev, unsigned long secs)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct pcap_rtc *pcap_rtc = platform_get_drvdata(pdev);\r\nu32 tod, days;\r\ntod = secs % SEC_PER_DAY;\r\nezx_pcap_write(pcap_rtc->pcap, PCAP_REG_RTC_TOD, tod);\r\ndays = secs / SEC_PER_DAY;\r\nezx_pcap_write(pcap_rtc->pcap, PCAP_REG_RTC_DAY, days);\r\nreturn 0;\r\n}\r\nstatic int pcap_rtc_irq_enable(struct device *dev, int pirq, unsigned int en)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct pcap_rtc *pcap_rtc = platform_get_drvdata(pdev);\r\nif (en)\r\nenable_irq(pcap_to_irq(pcap_rtc->pcap, pirq));\r\nelse\r\ndisable_irq(pcap_to_irq(pcap_rtc->pcap, pirq));\r\nreturn 0;\r\n}\r\nstatic int pcap_rtc_alarm_irq_enable(struct device *dev, unsigned int en)\r\n{\r\nreturn pcap_rtc_irq_enable(dev, PCAP_IRQ_TODA, en);\r\n}\r\nstatic int __devinit pcap_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct pcap_rtc *pcap_rtc;\r\nint timer_irq, alarm_irq;\r\nint err = -ENOMEM;\r\npcap_rtc = kmalloc(sizeof(struct pcap_rtc), GFP_KERNEL);\r\nif (!pcap_rtc)\r\nreturn err;\r\npcap_rtc->pcap = dev_get_drvdata(pdev->dev.parent);\r\nplatform_set_drvdata(pdev, pcap_rtc);\r\npcap_rtc->rtc = rtc_device_register("pcap", &pdev->dev,\r\n&pcap_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(pcap_rtc->rtc)) {\r\nerr = PTR_ERR(pcap_rtc->rtc);\r\ngoto fail_rtc;\r\n}\r\ntimer_irq = pcap_to_irq(pcap_rtc->pcap, PCAP_IRQ_1HZ);\r\nalarm_irq = pcap_to_irq(pcap_rtc->pcap, PCAP_IRQ_TODA);\r\nerr = request_irq(timer_irq, pcap_rtc_irq, 0, "RTC Timer", pcap_rtc);\r\nif (err)\r\ngoto fail_timer;\r\nerr = request_irq(alarm_irq, pcap_rtc_irq, 0, "RTC Alarm", pcap_rtc);\r\nif (err)\r\ngoto fail_alarm;\r\nreturn 0;\r\nfail_alarm:\r\nfree_irq(timer_irq, pcap_rtc);\r\nfail_timer:\r\nrtc_device_unregister(pcap_rtc->rtc);\r\nfail_rtc:\r\nplatform_set_drvdata(pdev, NULL);\r\nkfree(pcap_rtc);\r\nreturn err;\r\n}\r\nstatic int __devexit pcap_rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct pcap_rtc *pcap_rtc = platform_get_drvdata(pdev);\r\nfree_irq(pcap_to_irq(pcap_rtc->pcap, PCAP_IRQ_1HZ), pcap_rtc);\r\nfree_irq(pcap_to_irq(pcap_rtc->pcap, PCAP_IRQ_TODA), pcap_rtc);\r\nrtc_device_unregister(pcap_rtc->rtc);\r\nkfree(pcap_rtc);\r\nreturn 0;\r\n}\r\nstatic int __init rtc_pcap_init(void)\r\n{\r\nreturn platform_driver_probe(&pcap_rtc_driver, pcap_rtc_probe);\r\n}\r\nstatic void __exit rtc_pcap_exit(void)\r\n{\r\nplatform_driver_unregister(&pcap_rtc_driver);\r\n}

static int\r\nisdn_tty_try_read(modem_info *info, struct sk_buff *skb)\r\n{\r\nint c;\r\nint len;\r\nstruct tty_struct *tty;\r\nchar last;\r\nif (!info->online)\r\nreturn 0;\r\ntty = info->port.tty;\r\nif (!tty)\r\nreturn 0;\r\nif (!(info->mcr & UART_MCR_RTS))\r\nreturn 0;\r\nlen = skb->len\r\n#ifdef CONFIG_ISDN_AUDIO\r\n+ ISDN_AUDIO_SKB_DLECOUNT(skb)\r\n#endif\r\n;\r\nc = tty_buffer_request_room(tty, len);\r\nif (c < len)\r\nreturn 0;\r\n#ifdef CONFIG_ISDN_AUDIO\r\nif (ISDN_AUDIO_SKB_DLECOUNT(skb)) {\r\nint l = skb->len;\r\nunsigned char *dp = skb->data;\r\nwhile (--l) {\r\nif (*dp == DLE)\r\ntty_insert_flip_char(tty, DLE, 0);\r\ntty_insert_flip_char(tty, *dp++, 0);\r\n}\r\nif (*dp == DLE)\r\ntty_insert_flip_char(tty, DLE, 0);\r\nlast = *dp;\r\n} else {\r\n#endif\r\nif (len > 1)\r\ntty_insert_flip_string(tty, skb->data, len - 1);\r\nlast = skb->data[len - 1];\r\n#ifdef CONFIG_ISDN_AUDIO\r\n}\r\n#endif\r\nif (info->emu.mdmreg[REG_CPPP] & BIT_CPPP)\r\ntty_insert_flip_char(tty, last, 0xFF);\r\nelse\r\ntty_insert_flip_char(tty, last, TTY_NORMAL);\r\ntty_flip_buffer_push(tty);\r\nkfree_skb(skb);\r\nreturn 1;\r\n}\r\nvoid\r\nisdn_tty_readmodem(void)\r\n{\r\nint resched = 0;\r\nint midx;\r\nint i;\r\nint r;\r\nstruct tty_struct *tty;\r\nmodem_info *info;\r\nfor (i = 0; i < ISDN_MAX_CHANNELS; i++) {\r\nmidx = dev->m_idx[i];\r\nif (midx < 0)\r\ncontinue;\r\ninfo = &dev->mdm.info[midx];\r\nif (!info->online)\r\ncontinue;\r\nr = 0;\r\n#ifdef CONFIG_ISDN_AUDIO\r\nisdn_audio_eval_dtmf(info);\r\nif ((info->vonline & 1) && (info->emu.vpar[1]))\r\nisdn_audio_eval_silence(info);\r\n#endif\r\ntty = info->port.tty;\r\nif (tty) {\r\nif (info->mcr & UART_MCR_RTS) {\r\nif (!(info->emu.mdmreg[REG_CPPP] & BIT_CPPP))\r\nr = isdn_readbchan_tty(info->isdn_driver, info->isdn_channel, tty, 0);\r\nelse\r\nr = isdn_readbchan_tty(info->isdn_driver, info->isdn_channel, tty, 1);\r\nif (r)\r\ntty_flip_buffer_push(tty);\r\n} else\r\nr = 1;\r\n} else\r\nr = 1;\r\nif (r) {\r\ninfo->rcvsched = 0;\r\nresched = 1;\r\n} else\r\ninfo->rcvsched = 1;\r\n}\r\nif (!resched)\r\nisdn_timer_ctrl(ISDN_TIMER_MODEMREAD, 0);\r\n}\r\nint\r\nisdn_tty_rcv_skb(int i, int di, int channel, struct sk_buff *skb)\r\n{\r\nulong flags;\r\nint midx;\r\n#ifdef CONFIG_ISDN_AUDIO\r\nint ifmt;\r\n#endif\r\nmodem_info *info;\r\nif ((midx = dev->m_idx[i]) < 0) {\r\nreturn 0;\r\n}\r\ninfo = &dev->mdm.info[midx];\r\n#ifdef CONFIG_ISDN_AUDIO\r\nifmt = 1;\r\nif ((info->vonline) && (!info->emu.vpar[4]))\r\nisdn_audio_calc_dtmf(info, skb->data, skb->len, ifmt);\r\nif ((info->vonline & 1) && (info->emu.vpar[1]))\r\nisdn_audio_calc_silence(info, skb->data, skb->len, ifmt);\r\n#endif\r\nif ((info->online < 2)\r\n#ifdef CONFIG_ISDN_AUDIO\r\n&& (!(info->vonline & 1))\r\n#endif\r\n) {\r\nkfree_skb(skb);\r\nreturn 1;\r\n}\r\nif (info->emu.mdmreg[REG_T70] & BIT_T70) {\r\nif (info->emu.mdmreg[REG_T70] & BIT_T70_EXT) {\r\nif (skb->data[0] == 3)\r\nskb_pull(skb, 4);\r\nelse\r\nif (skb->data[0] == 1)\r\nskb_pull(skb, 2);\r\n} else\r\nif ((skb->data[0] == 1) && ((skb->data[1] == 0) || (skb->data[1] == 1)))\r\nskb_pull(skb, 4);\r\n}\r\n#ifdef CONFIG_ISDN_AUDIO\r\nISDN_AUDIO_SKB_DLECOUNT(skb) = 0;\r\nISDN_AUDIO_SKB_LOCK(skb) = 0;\r\nif (info->vonline & 1) {\r\nswitch (info->emu.vpar[3]) {\r\ncase 2:\r\ncase 3:\r\ncase 4:\r\nskb_trim(skb, isdn_audio_xlaw2adpcm(info->adpcmr,\r\nifmt,\r\nskb->data,\r\nskb->data,\r\nskb->len));\r\nbreak;\r\ncase 5:\r\nif (!ifmt)\r\nisdn_audio_ulaw2alaw(skb->data, skb->len);\r\nbreak;\r\ncase 6:\r\nif (ifmt)\r\nisdn_audio_alaw2ulaw(skb->data, skb->len);\r\nbreak;\r\n}\r\nISDN_AUDIO_SKB_DLECOUNT(skb) =\r\nisdn_tty_countDLE(skb->data, skb->len);\r\n}\r\n#ifdef CONFIG_ISDN_TTY_FAX\r\nelse {\r\nif (info->faxonline & 2) {\r\nisdn_tty_fax_bitorder(info, skb);\r\nISDN_AUDIO_SKB_DLECOUNT(skb) =\r\nisdn_tty_countDLE(skb->data, skb->len);\r\n}\r\n}\r\n#endif\r\n#endif\r\nspin_lock_irqsave(&info->readlock, flags);\r\nif (skb_queue_empty(&dev->drv[di]->rpqueue[channel]))\r\nif (isdn_tty_try_read(info, skb)) {\r\nspin_unlock_irqrestore(&info->readlock, flags);\r\nreturn 1;\r\n}\r\n__skb_queue_tail(&dev->drv[di]->rpqueue[channel], skb);\r\ndev->drv[di]->rcvcount[channel] +=\r\n(skb->len\r\n#ifdef CONFIG_ISDN_AUDIO\r\n+ ISDN_AUDIO_SKB_DLECOUNT(skb)\r\n#endif\r\n);\r\nspin_unlock_irqrestore(&info->readlock, flags);\r\nif ((dev->modempoll) && (info->rcvsched))\r\nisdn_timer_ctrl(ISDN_TIMER_MODEMREAD, 1);\r\nreturn 1;\r\n}\r\nstatic void\r\nisdn_tty_cleanup_xmit(modem_info *info)\r\n{\r\nskb_queue_purge(&info->xmit_queue);\r\n#ifdef CONFIG_ISDN_AUDIO\r\nskb_queue_purge(&info->dtmf_queue);\r\n#endif\r\n}\r\nstatic void\r\nisdn_tty_tint(modem_info *info)\r\n{\r\nstruct sk_buff *skb = skb_dequeue(&info->xmit_queue);\r\nint len, slen;\r\nif (!skb)\r\nreturn;\r\nlen = skb->len;\r\nif ((slen = isdn_writebuf_skb_stub(info->isdn_driver,\r\ninfo->isdn_channel, 1, skb)) == len) {\r\nstruct tty_struct *tty = info->port.tty;\r\ninfo->send_outstanding++;\r\ninfo->msr &= ~UART_MSR_CTS;\r\ninfo->lsr &= ~UART_LSR_TEMT;\r\ntty_wakeup(tty);\r\nreturn;\r\n}\r\nif (slen < 0) {\r\ndev_kfree_skb(skb);\r\nreturn;\r\n}\r\nskb_queue_head(&info->xmit_queue, skb);\r\n}\r\nstatic int\r\nisdn_tty_countDLE(unsigned char *buf, int len)\r\n{\r\nint count = 0;\r\nwhile (len--)\r\nif (*buf++ == DLE)\r\ncount++;\r\nreturn count;\r\n}\r\nstatic int\r\nisdn_tty_handleDLEdown(modem_info *info, atemu *m, int len)\r\n{\r\nunsigned char *p = &info->port.xmit_buf[info->xmit_count];\r\nint count = 0;\r\nwhile (len > 0) {\r\nif (m->lastDLE) {\r\nm->lastDLE = 0;\r\nswitch (*p) {\r\ncase DLE:\r\nif (len > 1)\r\nmemmove(p, p + 1, len - 1);\r\np--;\r\ncount++;\r\nbreak;\r\ncase ETX:\r\ninfo->vonline |= 4;\r\nreturn count;\r\ncase DC4:\r\ninfo->vonline &= ~1;\r\n#ifdef ISDN_DEBUG_MODEM_VOICE\r\nprintk(KERN_DEBUG\r\n"DLEdown: got DLE-DC4, send DLE-ETX on ttyI%d\n",\r\ninfo->line);\r\n#endif\r\nisdn_tty_at_cout("\020\003", info);\r\nif (!info->vonline) {\r\n#ifdef ISDN_DEBUG_MODEM_VOICE\r\nprintk(KERN_DEBUG\r\n"DLEdown: send VCON on ttyI%d\n",\r\ninfo->line);\r\n#endif\r\nisdn_tty_at_cout("\r\nVCON\r\n", info);\r\n}\r\ncase 'q':\r\ncase 's':\r\nif (len > 1)\r\nmemmove(p, p + 1, len - 1);\r\np--;\r\nbreak;\r\n}\r\n} else {\r\nif (*p == DLE)\r\nm->lastDLE = 1;\r\nelse\r\ncount++;\r\n}\r\np++;\r\nlen--;\r\n}\r\nif (len < 0) {\r\nprintk(KERN_WARNING "isdn_tty: len<0 in DLEdown\n");\r\nreturn 0;\r\n}\r\nreturn count;\r\n}\r\nstatic int\r\nisdn_tty_end_vrx(const char *buf, int c)\r\n{\r\nchar ch;\r\nwhile (c--) {\r\nch = *buf;\r\nif ((ch != 0x11) && (ch != 0x13))\r\nreturn 1;\r\nbuf++;\r\n}\r\nreturn 0;\r\n}\r\nstatic void\r\nisdn_tty_senddown(modem_info *info)\r\n{\r\nint buflen;\r\nint skb_res;\r\n#ifdef CONFIG_ISDN_AUDIO\r\nint audio_len;\r\n#endif\r\nstruct sk_buff *skb;\r\n#ifdef CONFIG_ISDN_AUDIO\r\nif (info->vonline & 4) {\r\ninfo->vonline &= ~6;\r\nif (!info->vonline) {\r\n#ifdef ISDN_DEBUG_MODEM_VOICE\r\nprintk(KERN_DEBUG\r\n"senddown: send VCON on ttyI%d\n",\r\ninfo->line);\r\n#endif\r\nisdn_tty_at_cout("\r\nVCON\r\n", info);\r\n}\r\n}\r\n#endif\r\nif (!(buflen = info->xmit_count))\r\nreturn;\r\nif ((info->emu.mdmreg[REG_CTS] & BIT_CTS) != 0)\r\ninfo->msr &= ~UART_MSR_CTS;\r\ninfo->lsr &= ~UART_LSR_TEMT;\r\natomic_inc(&info->xmit_lock);\r\nif (!(atomic_dec_and_test(&info->xmit_lock)))\r\nreturn;\r\nif (info->isdn_driver < 0) {\r\ninfo->xmit_count = 0;\r\nreturn;\r\n}\r\nskb_res = dev->drv[info->isdn_driver]->interface->hl_hdrlen + 4;\r\n#ifdef CONFIG_ISDN_AUDIO\r\nif (info->vonline & 2)\r\naudio_len = buflen * voice_cf[info->emu.vpar[3]];\r\nelse\r\naudio_len = 0;\r\nskb = dev_alloc_skb(skb_res + buflen + audio_len);\r\n#else\r\nskb = dev_alloc_skb(skb_res + buflen);\r\n#endif\r\nif (!skb) {\r\nprintk(KERN_WARNING\r\n"isdn_tty: Out of memory in ttyI%d senddown\n",\r\ninfo->line);\r\nreturn;\r\n}\r\nskb_reserve(skb, skb_res);\r\nmemcpy(skb_put(skb, buflen), info->port.xmit_buf, buflen);\r\ninfo->xmit_count = 0;\r\n#ifdef CONFIG_ISDN_AUDIO\r\nif (info->vonline & 2) {\r\nint ifmt = 1;\r\nswitch (info->emu.vpar[3]) {\r\ncase 2:\r\ncase 3:\r\ncase 4:\r\naudio_len = isdn_audio_adpcm2xlaw(info->adpcms,\r\nifmt,\r\nskb->data,\r\nskb_put(skb, audio_len),\r\nbuflen);\r\nskb_pull(skb, buflen);\r\nskb_trim(skb, audio_len);\r\nbreak;\r\ncase 5:\r\nif (!ifmt)\r\nisdn_audio_alaw2ulaw(skb->data,\r\nbuflen);\r\nbreak;\r\ncase 6:\r\nif (ifmt)\r\nisdn_audio_ulaw2alaw(skb->data,\r\nbuflen);\r\nbreak;\r\n}\r\n}\r\n#endif\r\nif (info->emu.mdmreg[REG_T70] & BIT_T70) {\r\nif (info->emu.mdmreg[REG_T70] & BIT_T70_EXT)\r\nmemcpy(skb_push(skb, 2), "\1\0", 2);\r\nelse\r\nmemcpy(skb_push(skb, 4), "\1\0\1\0", 4);\r\n}\r\nskb_queue_tail(&info->xmit_queue, skb);\r\n}\r\nstatic void\r\nisdn_tty_modem_do_ncarrier(unsigned long data)\r\n{\r\nmodem_info *info = (modem_info *) data;\r\nisdn_tty_modem_result(RESULT_NO_CARRIER, info);\r\n}\r\nstatic void\r\nisdn_tty_modem_ncarrier(modem_info *info)\r\n{\r\nif (info->ncarrier) {\r\ninfo->nc_timer.expires = jiffies + HZ;\r\nadd_timer(&info->nc_timer);\r\n}\r\n}\r\nstatic int\r\nisdn_calc_usage(int si, int l2)\r\n{\r\nint usg = ISDN_USAGE_MODEM;\r\n#ifdef CONFIG_ISDN_AUDIO\r\nif (si == 1) {\r\nswitch (l2) {\r\ncase ISDN_PROTO_L2_MODEM:\r\nusg = ISDN_USAGE_MODEM;\r\nbreak;\r\n#ifdef CONFIG_ISDN_TTY_FAX\r\ncase ISDN_PROTO_L2_FAX:\r\nusg = ISDN_USAGE_FAX;\r\nbreak;\r\n#endif\r\ncase ISDN_PROTO_L2_TRANS:\r\ndefault:\r\nusg = ISDN_USAGE_VOICE;\r\nbreak;\r\n}\r\n}\r\n#endif\r\nreturn (usg);\r\n}\r\nstatic void\r\nisdn_tty_dial(char *n, modem_info *info, atemu *m)\r\n{\r\nint usg = ISDN_USAGE_MODEM;\r\nint si = 7;\r\nint l2 = m->mdmreg[REG_L2PROT];\r\nu_long flags;\r\nisdn_ctrl cmd;\r\nint i;\r\nint j;\r\nfor (j = 7; j >= 0; j--)\r\nif (m->mdmreg[REG_SI1] & (1 << j)) {\r\nsi = bit2si[j];\r\nbreak;\r\n}\r\nusg = isdn_calc_usage(si, l2);\r\n#ifdef CONFIG_ISDN_AUDIO\r\nif ((si == 1) &&\r\n(l2 != ISDN_PROTO_L2_MODEM)\r\n#ifdef CONFIG_ISDN_TTY_FAX\r\n&& (l2 != ISDN_PROTO_L2_FAX)\r\n#endif\r\n) {\r\nl2 = ISDN_PROTO_L2_TRANS;\r\nusg = ISDN_USAGE_VOICE;\r\n}\r\n#endif\r\nm->mdmreg[REG_SI1I] = si2bit[si];\r\nspin_lock_irqsave(&dev->lock, flags);\r\ni = isdn_get_free_channel(usg, l2, m->mdmreg[REG_L3PROT], -1, -1, m->msn);\r\nif (i < 0) {\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nisdn_tty_modem_result(RESULT_NO_DIALTONE, info);\r\n} else {\r\ninfo->isdn_driver = dev->drvmap[i];\r\ninfo->isdn_channel = dev->chanmap[i];\r\ninfo->drv_index = i;\r\ndev->m_idx[i] = info->line;\r\ndev->usage[i] |= ISDN_USAGE_OUTGOING;\r\ninfo->last_dir = 1;\r\nstrcpy(info->last_num, n);\r\nisdn_info_update();\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\ncmd.driver = info->isdn_driver;\r\ncmd.arg = info->isdn_channel;\r\ncmd.command = ISDN_CMD_CLREAZ;\r\nisdn_command(&cmd);\r\nstrcpy(cmd.parm.num, isdn_map_eaz2msn(m->msn, info->isdn_driver));\r\ncmd.driver = info->isdn_driver;\r\ncmd.command = ISDN_CMD_SETEAZ;\r\nisdn_command(&cmd);\r\ncmd.driver = info->isdn_driver;\r\ncmd.command = ISDN_CMD_SETL2;\r\ninfo->last_l2 = l2;\r\ncmd.arg = info->isdn_channel + (l2 << 8);\r\nisdn_command(&cmd);\r\ncmd.driver = info->isdn_driver;\r\ncmd.command = ISDN_CMD_SETL3;\r\ncmd.arg = info->isdn_channel + (m->mdmreg[REG_L3PROT] << 8);\r\n#ifdef CONFIG_ISDN_TTY_FAX\r\nif (l2 == ISDN_PROTO_L2_FAX) {\r\ncmd.parm.fax = info->fax;\r\ninfo->fax->direction = ISDN_TTY_FAX_CONN_OUT;\r\n}\r\n#endif\r\nisdn_command(&cmd);\r\ncmd.driver = info->isdn_driver;\r\ncmd.arg = info->isdn_channel;\r\nsprintf(cmd.parm.setup.phone, "%s", n);\r\nsprintf(cmd.parm.setup.eazmsn, "%s",\r\nisdn_map_eaz2msn(m->msn, info->isdn_driver));\r\ncmd.parm.setup.si1 = si;\r\ncmd.parm.setup.si2 = m->mdmreg[REG_SI2];\r\ncmd.command = ISDN_CMD_DIAL;\r\ninfo->dialing = 1;\r\ninfo->emu.carrierwait = 0;\r\nstrcpy(dev->num[i], n);\r\nisdn_info_update();\r\nisdn_command(&cmd);\r\nisdn_timer_ctrl(ISDN_TIMER_CARRIER, 1);\r\n}\r\n}\r\nvoid\r\nisdn_tty_modem_hup(modem_info *info, int local)\r\n{\r\nisdn_ctrl cmd;\r\nint di, ch;\r\nif (!info)\r\nreturn;\r\ndi = info->isdn_driver;\r\nch = info->isdn_channel;\r\nif (di < 0 || ch < 0)\r\nreturn;\r\ninfo->isdn_driver = -1;\r\ninfo->isdn_channel = -1;\r\n#ifdef ISDN_DEBUG_MODEM_HUP\r\nprintk(KERN_DEBUG "Mhup ttyI%d\n", info->line);\r\n#endif\r\ninfo->rcvsched = 0;\r\nisdn_tty_flush_buffer(info->port.tty);\r\nif (info->online) {\r\ninfo->last_lhup = local;\r\ninfo->online = 0;\r\nisdn_tty_modem_result(RESULT_NO_CARRIER, info);\r\n}\r\n#ifdef CONFIG_ISDN_AUDIO\r\ninfo->vonline = 0;\r\n#ifdef CONFIG_ISDN_TTY_FAX\r\ninfo->faxonline = 0;\r\ninfo->fax->phase = ISDN_FAX_PHASE_IDLE;\r\n#endif\r\ninfo->emu.vpar[4] = 0;\r\ninfo->emu.vpar[5] = 8;\r\nkfree(info->dtmf_state);\r\ninfo->dtmf_state = NULL;\r\nkfree(info->silence_state);\r\ninfo->silence_state = NULL;\r\nkfree(info->adpcms);\r\ninfo->adpcms = NULL;\r\nkfree(info->adpcmr);\r\ninfo->adpcmr = NULL;\r\n#endif\r\nif ((info->msr & UART_MSR_RI) &&\r\n(info->emu.mdmreg[REG_RUNG] & BIT_RUNG))\r\nisdn_tty_modem_result(RESULT_RUNG, info);\r\ninfo->msr &= ~(UART_MSR_DCD | UART_MSR_RI);\r\ninfo->lsr |= UART_LSR_TEMT;\r\nif (local) {\r\ncmd.driver = di;\r\ncmd.command = ISDN_CMD_HANGUP;\r\ncmd.arg = ch;\r\nisdn_command(&cmd);\r\n}\r\nisdn_all_eaz(di, ch);\r\ninfo->emu.mdmreg[REG_RINGCNT] = 0;\r\nisdn_free_channel(di, ch, 0);\r\nif (info->drv_index >= 0) {\r\ndev->m_idx[info->drv_index] = -1;\r\ninfo->drv_index = -1;\r\n}\r\n}\r\nint\r\nisdn_tty_capi_facility(capi_msg *cm) {\r\nreturn (-1);\r\n}\r\nstatic void\r\nisdn_tty_suspend(char *id, modem_info *info, atemu *m)\r\n{\r\nisdn_ctrl cmd;\r\nint l;\r\nif (!info)\r\nreturn;\r\n#ifdef ISDN_DEBUG_MODEM_SERVICES\r\nprintk(KERN_DEBUG "Msusp ttyI%d\n", info->line);\r\n#endif\r\nl = strlen(id);\r\nif ((info->isdn_driver >= 0)) {\r\ncmd.parm.cmsg.Length = l + 18;\r\ncmd.parm.cmsg.Command = CAPI_FACILITY;\r\ncmd.parm.cmsg.Subcommand = CAPI_REQ;\r\ncmd.parm.cmsg.adr.Controller = info->isdn_driver + 1;\r\ncmd.parm.cmsg.para[0] = 3;\r\ncmd.parm.cmsg.para[1] = 0;\r\ncmd.parm.cmsg.para[2] = l + 3;\r\ncmd.parm.cmsg.para[3] = 4;\r\ncmd.parm.cmsg.para[4] = 0;\r\ncmd.parm.cmsg.para[5] = l;\r\nstrncpy(&cmd.parm.cmsg.para[6], id, l);\r\ncmd.command = CAPI_PUT_MESSAGE;\r\ncmd.driver = info->isdn_driver;\r\ncmd.arg = info->isdn_channel;\r\nisdn_command(&cmd);\r\n}\r\n}\r\nstatic void\r\nisdn_tty_resume(char *id, modem_info *info, atemu *m)\r\n{\r\nint usg = ISDN_USAGE_MODEM;\r\nint si = 7;\r\nint l2 = m->mdmreg[REG_L2PROT];\r\nisdn_ctrl cmd;\r\nulong flags;\r\nint i;\r\nint j;\r\nint l;\r\nl = strlen(id);\r\nfor (j = 7; j >= 0; j--)\r\nif (m->mdmreg[REG_SI1] & (1 << j)) {\r\nsi = bit2si[j];\r\nbreak;\r\n}\r\nusg = isdn_calc_usage(si, l2);\r\n#ifdef CONFIG_ISDN_AUDIO\r\nif ((si == 1) &&\r\n(l2 != ISDN_PROTO_L2_MODEM)\r\n#ifdef CONFIG_ISDN_TTY_FAX\r\n&& (l2 != ISDN_PROTO_L2_FAX)\r\n#endif\r\n) {\r\nl2 = ISDN_PROTO_L2_TRANS;\r\nusg = ISDN_USAGE_VOICE;\r\n}\r\n#endif\r\nm->mdmreg[REG_SI1I] = si2bit[si];\r\nspin_lock_irqsave(&dev->lock, flags);\r\ni = isdn_get_free_channel(usg, l2, m->mdmreg[REG_L3PROT], -1, -1, m->msn);\r\nif (i < 0) {\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nisdn_tty_modem_result(RESULT_NO_DIALTONE, info);\r\n} else {\r\ninfo->isdn_driver = dev->drvmap[i];\r\ninfo->isdn_channel = dev->chanmap[i];\r\ninfo->drv_index = i;\r\ndev->m_idx[i] = info->line;\r\ndev->usage[i] |= ISDN_USAGE_OUTGOING;\r\ninfo->last_dir = 1;\r\nisdn_info_update();\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\ncmd.driver = info->isdn_driver;\r\ncmd.arg = info->isdn_channel;\r\ncmd.command = ISDN_CMD_CLREAZ;\r\nisdn_command(&cmd);\r\nstrcpy(cmd.parm.num, isdn_map_eaz2msn(m->msn, info->isdn_driver));\r\ncmd.driver = info->isdn_driver;\r\ncmd.command = ISDN_CMD_SETEAZ;\r\nisdn_command(&cmd);\r\ncmd.driver = info->isdn_driver;\r\ncmd.command = ISDN_CMD_SETL2;\r\ninfo->last_l2 = l2;\r\ncmd.arg = info->isdn_channel + (l2 << 8);\r\nisdn_command(&cmd);\r\ncmd.driver = info->isdn_driver;\r\ncmd.command = ISDN_CMD_SETL3;\r\ncmd.arg = info->isdn_channel + (m->mdmreg[REG_L3PROT] << 8);\r\nisdn_command(&cmd);\r\ncmd.driver = info->isdn_driver;\r\ncmd.arg = info->isdn_channel;\r\ncmd.parm.cmsg.Length = l + 18;\r\ncmd.parm.cmsg.Command = CAPI_FACILITY;\r\ncmd.parm.cmsg.Subcommand = CAPI_REQ;\r\ncmd.parm.cmsg.adr.Controller = info->isdn_driver + 1;\r\ncmd.parm.cmsg.para[0] = 3;\r\ncmd.parm.cmsg.para[1] = 0;\r\ncmd.parm.cmsg.para[2] = l + 3;\r\ncmd.parm.cmsg.para[3] = 5;\r\ncmd.parm.cmsg.para[4] = 0;\r\ncmd.parm.cmsg.para[5] = l;\r\nstrncpy(&cmd.parm.cmsg.para[6], id, l);\r\ncmd.command = CAPI_PUT_MESSAGE;\r\ninfo->dialing = 1;\r\nisdn_info_update();\r\nisdn_command(&cmd);\r\nisdn_timer_ctrl(ISDN_TIMER_CARRIER, 1);\r\n}\r\n}\r\nstatic void\r\nisdn_tty_send_msg(modem_info *info, atemu *m, char *msg)\r\n{\r\nint usg = ISDN_USAGE_MODEM;\r\nint si = 7;\r\nint l2 = m->mdmreg[REG_L2PROT];\r\nisdn_ctrl cmd;\r\nulong flags;\r\nint i;\r\nint j;\r\nint l;\r\nl = strlen(msg);\r\nif (!l) {\r\nisdn_tty_modem_result(RESULT_ERROR, info);\r\nreturn;\r\n}\r\nfor (j = 7; j >= 0; j--)\r\nif (m->mdmreg[REG_SI1] & (1 << j)) {\r\nsi = bit2si[j];\r\nbreak;\r\n}\r\nusg = isdn_calc_usage(si, l2);\r\n#ifdef CONFIG_ISDN_AUDIO\r\nif ((si == 1) &&\r\n(l2 != ISDN_PROTO_L2_MODEM)\r\n#ifdef CONFIG_ISDN_TTY_FAX\r\n&& (l2 != ISDN_PROTO_L2_FAX)\r\n#endif\r\n) {\r\nl2 = ISDN_PROTO_L2_TRANS;\r\nusg = ISDN_USAGE_VOICE;\r\n}\r\n#endif\r\nm->mdmreg[REG_SI1I] = si2bit[si];\r\nspin_lock_irqsave(&dev->lock, flags);\r\ni = isdn_get_free_channel(usg, l2, m->mdmreg[REG_L3PROT], -1, -1, m->msn);\r\nif (i < 0) {\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nisdn_tty_modem_result(RESULT_NO_DIALTONE, info);\r\n} else {\r\ninfo->isdn_driver = dev->drvmap[i];\r\ninfo->isdn_channel = dev->chanmap[i];\r\ninfo->drv_index = i;\r\ndev->m_idx[i] = info->line;\r\ndev->usage[i] |= ISDN_USAGE_OUTGOING;\r\ninfo->last_dir = 1;\r\nisdn_info_update();\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\ncmd.driver = info->isdn_driver;\r\ncmd.arg = info->isdn_channel;\r\ncmd.command = ISDN_CMD_CLREAZ;\r\nisdn_command(&cmd);\r\nstrcpy(cmd.parm.num, isdn_map_eaz2msn(m->msn, info->isdn_driver));\r\ncmd.driver = info->isdn_driver;\r\ncmd.command = ISDN_CMD_SETEAZ;\r\nisdn_command(&cmd);\r\ncmd.driver = info->isdn_driver;\r\ncmd.command = ISDN_CMD_SETL2;\r\ninfo->last_l2 = l2;\r\ncmd.arg = info->isdn_channel + (l2 << 8);\r\nisdn_command(&cmd);\r\ncmd.driver = info->isdn_driver;\r\ncmd.command = ISDN_CMD_SETL3;\r\ncmd.arg = info->isdn_channel + (m->mdmreg[REG_L3PROT] << 8);\r\nisdn_command(&cmd);\r\ncmd.driver = info->isdn_driver;\r\ncmd.arg = info->isdn_channel;\r\ncmd.parm.cmsg.Length = l + 14;\r\ncmd.parm.cmsg.Command = CAPI_MANUFACTURER;\r\ncmd.parm.cmsg.Subcommand = CAPI_REQ;\r\ncmd.parm.cmsg.adr.Controller = info->isdn_driver + 1;\r\ncmd.parm.cmsg.para[0] = l + 1;\r\nstrncpy(&cmd.parm.cmsg.para[1], msg, l);\r\ncmd.parm.cmsg.para[l + 1] = 0xd;\r\ncmd.command = CAPI_PUT_MESSAGE;\r\nisdn_command(&cmd);\r\n}\r\n}\r\nstatic inline int\r\nisdn_tty_paranoia_check(modem_info *info, char *name, const char *routine)\r\n{\r\n#ifdef MODEM_PARANOIA_CHECK\r\nif (!info) {\r\nprintk(KERN_WARNING "isdn_tty: null info_struct for %s in %s\n",\r\nname, routine);\r\nreturn 1;\r\n}\r\nif (info->magic != ISDN_ASYNC_MAGIC) {\r\nprintk(KERN_WARNING "isdn_tty: bad magic for modem struct %s in %s\n",\r\nname, routine);\r\nreturn 1;\r\n}\r\n#endif\r\nreturn 0;\r\n}\r\nstatic void\r\nisdn_tty_change_speed(modem_info *info)\r\n{\r\nstruct tty_port *port = &info->port;\r\nuint cflag,\r\ncval,\r\nquot;\r\nint i;\r\nif (!port->tty || !port->tty->termios)\r\nreturn;\r\ncflag = port->tty->termios->c_cflag;\r\nquot = i = cflag & CBAUD;\r\nif (i & CBAUDEX) {\r\ni &= ~CBAUDEX;\r\nif (i < 1 || i > 2)\r\nport->tty->termios->c_cflag &= ~CBAUDEX;\r\nelse\r\ni += 15;\r\n}\r\nif (quot) {\r\ninfo->mcr |= UART_MCR_DTR;\r\nisdn_tty_modem_ncarrier(info);\r\n} else {\r\ninfo->mcr &= ~UART_MCR_DTR;\r\nif (info->emu.mdmreg[REG_DTRHUP] & BIT_DTRHUP) {\r\n#ifdef ISDN_DEBUG_MODEM_HUP\r\nprintk(KERN_DEBUG "Mhup in changespeed\n");\r\n#endif\r\nif (info->online)\r\ninfo->ncarrier = 1;\r\nisdn_tty_modem_reset_regs(info, 0);\r\nisdn_tty_modem_hup(info, 1);\r\n}\r\nreturn;\r\n}\r\ncval = cflag & (CSIZE | CSTOPB);\r\ncval >>= 4;\r\nif (cflag & PARENB)\r\ncval |= UART_LCR_PARITY;\r\nif (!(cflag & PARODD))\r\ncval |= UART_LCR_EPAR;\r\nif (cflag & CRTSCTS) {\r\nport->flags |= ASYNC_CTS_FLOW;\r\n} else\r\nport->flags &= ~ASYNC_CTS_FLOW;\r\nif (cflag & CLOCAL)\r\nport->flags &= ~ASYNC_CHECK_CD;\r\nelse {\r\nport->flags |= ASYNC_CHECK_CD;\r\n}\r\n}\r\nstatic int\r\nisdn_tty_startup(modem_info *info)\r\n{\r\nif (info->port.flags & ASYNC_INITIALIZED)\r\nreturn 0;\r\nisdn_lock_drivers();\r\n#ifdef ISDN_DEBUG_MODEM_OPEN\r\nprintk(KERN_DEBUG "starting up ttyi%d ...\n", info->line);\r\n#endif\r\ninfo->mcr = UART_MCR_DTR | UART_MCR_RTS | UART_MCR_OUT2;\r\nif (info->port.tty)\r\nclear_bit(TTY_IO_ERROR, &info->port.tty->flags);\r\nisdn_tty_change_speed(info);\r\ninfo->port.flags |= ASYNC_INITIALIZED;\r\ninfo->msr |= (UART_MSR_DSR | UART_MSR_CTS);\r\ninfo->send_outstanding = 0;\r\nreturn 0;\r\n}\r\nstatic void\r\nisdn_tty_shutdown(modem_info *info)\r\n{\r\nif (!(info->port.flags & ASYNC_INITIALIZED))\r\nreturn;\r\n#ifdef ISDN_DEBUG_MODEM_OPEN\r\nprintk(KERN_DEBUG "Shutting down isdnmodem port %d ....\n", info->line);\r\n#endif\r\nisdn_unlock_drivers();\r\ninfo->msr &= ~UART_MSR_RI;\r\nif (!info->port.tty || (info->port.tty->termios->c_cflag & HUPCL)) {\r\ninfo->mcr &= ~(UART_MCR_DTR | UART_MCR_RTS);\r\nif (info->emu.mdmreg[REG_DTRHUP] & BIT_DTRHUP) {\r\nisdn_tty_modem_reset_regs(info, 0);\r\n#ifdef ISDN_DEBUG_MODEM_HUP\r\nprintk(KERN_DEBUG "Mhup in isdn_tty_shutdown\n");\r\n#endif\r\nisdn_tty_modem_hup(info, 1);\r\n}\r\n}\r\nif (info->port.tty)\r\nset_bit(TTY_IO_ERROR, &info->port.tty->flags);\r\ninfo->port.flags &= ~ASYNC_INITIALIZED;\r\n}\r\nstatic int\r\nisdn_tty_write(struct tty_struct *tty, const u_char *buf, int count)\r\n{\r\nint c;\r\nint total = 0;\r\nmodem_info *info = (modem_info *) tty->driver_data;\r\natemu *m = &info->emu;\r\nif (isdn_tty_paranoia_check(info, tty->name, "isdn_tty_write"))\r\nreturn 0;\r\natomic_inc(&info->xmit_lock);\r\nwhile (1) {\r\nc = count;\r\nif (c > info->xmit_size - info->xmit_count)\r\nc = info->xmit_size - info->xmit_count;\r\nif (info->isdn_driver >= 0 && c > dev->drv[info->isdn_driver]->maxbufsize)\r\nc = dev->drv[info->isdn_driver]->maxbufsize;\r\nif (c <= 0)\r\nbreak;\r\nif ((info->online > 1)\r\n#ifdef CONFIG_ISDN_AUDIO\r\n|| (info->vonline & 3)\r\n#endif\r\n) {\r\n#ifdef CONFIG_ISDN_AUDIO\r\nif (!info->vonline)\r\n#endif\r\nisdn_tty_check_esc(buf, m->mdmreg[REG_ESC], c,\r\n&(m->pluscount),\r\n&(m->lastplus));\r\nmemcpy(&info->port.xmit_buf[info->xmit_count], buf, c);\r\n#ifdef CONFIG_ISDN_AUDIO\r\nif (info->vonline) {\r\nint cc = isdn_tty_handleDLEdown(info, m, c);\r\nif (info->vonline & 2) {\r\nif (!cc) {\r\ntty_wakeup(tty);\r\ninfo->msr |= UART_MSR_CTS;\r\ninfo->lsr |= UART_LSR_TEMT;\r\n}\r\ninfo->xmit_count += cc;\r\n}\r\nif ((info->vonline & 3) == 1) {\r\nif (isdn_tty_end_vrx(buf, c)) {\r\ninfo->vonline &= ~1;\r\n#ifdef ISDN_DEBUG_MODEM_VOICE\r\nprintk(KERN_DEBUG\r\n"got !^Q/^S, send DLE-ETX,VCON on ttyI%d\n",\r\ninfo->line);\r\n#endif\r\nisdn_tty_at_cout("\020\003\r\nVCON\r\n", info);\r\n}\r\n}\r\n} else\r\nif (TTY_IS_FCLASS1(info)) {\r\nint cc = isdn_tty_handleDLEdown(info, m, c);\r\nif (info->vonline & 4) {\r\nisdn_ctrl c;\r\nc.command = ISDN_CMD_FAXCMD;\r\nc.driver = info->isdn_driver;\r\nc.arg = info->isdn_channel;\r\nc.parm.aux.cmd = ISDN_FAX_CLASS1_CTRL;\r\nc.parm.aux.subcmd = ETX;\r\nisdn_command(&c);\r\n}\r\ninfo->vonline = 0;\r\n#ifdef ISDN_DEBUG_MODEM_VOICE\r\nprintk(KERN_DEBUG "fax dle cc/c %d/%d\n", cc, c);\r\n#endif\r\ninfo->xmit_count += cc;\r\n} else\r\n#endif\r\ninfo->xmit_count += c;\r\n} else {\r\ninfo->msr |= UART_MSR_CTS;\r\ninfo->lsr |= UART_LSR_TEMT;\r\nif (info->dialing) {\r\ninfo->dialing = 0;\r\n#ifdef ISDN_DEBUG_MODEM_HUP\r\nprintk(KERN_DEBUG "Mhup in isdn_tty_write\n");\r\n#endif\r\nisdn_tty_modem_result(RESULT_NO_CARRIER, info);\r\nisdn_tty_modem_hup(info, 1);\r\n} else\r\nc = isdn_tty_edit_at(buf, c, info);\r\n}\r\nbuf += c;\r\ncount -= c;\r\ntotal += c;\r\n}\r\natomic_dec(&info->xmit_lock);\r\nif ((info->xmit_count) || !skb_queue_empty(&info->xmit_queue)) {\r\nif (m->mdmreg[REG_DXMT] & BIT_DXMT) {\r\nisdn_tty_senddown(info);\r\nisdn_tty_tint(info);\r\n}\r\nisdn_timer_ctrl(ISDN_TIMER_MODEMXMIT, 1);\r\n}\r\nreturn total;\r\n}\r\nstatic int\r\nisdn_tty_write_room(struct tty_struct *tty)\r\n{\r\nmodem_info *info = (modem_info *) tty->driver_data;\r\nint ret;\r\nif (isdn_tty_paranoia_check(info, tty->name, "isdn_tty_write_room"))\r\nreturn 0;\r\nif (!info->online)\r\nreturn info->xmit_size;\r\nret = info->xmit_size - info->xmit_count;\r\nreturn (ret < 0) ? 0 : ret;\r\n}\r\nstatic int\r\nisdn_tty_chars_in_buffer(struct tty_struct *tty)\r\n{\r\nmodem_info *info = (modem_info *) tty->driver_data;\r\nif (isdn_tty_paranoia_check(info, tty->name, "isdn_tty_chars_in_buffer"))\r\nreturn 0;\r\nif (!info->online)\r\nreturn 0;\r\nreturn (info->xmit_count);\r\n}\r\nstatic void\r\nisdn_tty_flush_buffer(struct tty_struct *tty)\r\n{\r\nmodem_info *info;\r\nif (!tty) {\r\nreturn;\r\n}\r\ninfo = (modem_info *) tty->driver_data;\r\nif (isdn_tty_paranoia_check(info, tty->name, "isdn_tty_flush_buffer")) {\r\nreturn;\r\n}\r\nisdn_tty_cleanup_xmit(info);\r\ninfo->xmit_count = 0;\r\ntty_wakeup(tty);\r\n}\r\nstatic void\r\nisdn_tty_flush_chars(struct tty_struct *tty)\r\n{\r\nmodem_info *info = (modem_info *) tty->driver_data;\r\nif (isdn_tty_paranoia_check(info, tty->name, "isdn_tty_flush_chars"))\r\nreturn;\r\nif ((info->xmit_count) || !skb_queue_empty(&info->xmit_queue))\r\nisdn_timer_ctrl(ISDN_TIMER_MODEMXMIT, 1);\r\n}\r\nstatic void\r\nisdn_tty_throttle(struct tty_struct *tty)\r\n{\r\nmodem_info *info = (modem_info *) tty->driver_data;\r\nif (isdn_tty_paranoia_check(info, tty->name, "isdn_tty_throttle"))\r\nreturn;\r\nif (I_IXOFF(tty))\r\ninfo->x_char = STOP_CHAR(tty);\r\ninfo->mcr &= ~UART_MCR_RTS;\r\n}\r\nstatic void\r\nisdn_tty_unthrottle(struct tty_struct *tty)\r\n{\r\nmodem_info *info = (modem_info *) tty->driver_data;\r\nif (isdn_tty_paranoia_check(info, tty->name, "isdn_tty_unthrottle"))\r\nreturn;\r\nif (I_IXOFF(tty)) {\r\nif (info->x_char)\r\ninfo->x_char = 0;\r\nelse\r\ninfo->x_char = START_CHAR(tty);\r\n}\r\ninfo->mcr |= UART_MCR_RTS;\r\n}\r\nstatic int\r\nisdn_tty_get_lsr_info(modem_info *info, uint __user *value)\r\n{\r\nu_char status;\r\nuint result;\r\nstatus = info->lsr;\r\nresult = ((status & UART_LSR_TEMT) ? TIOCSER_TEMT : 0);\r\nreturn put_user(result, value);\r\n}\r\nstatic int\r\nisdn_tty_tiocmget(struct tty_struct *tty)\r\n{\r\nmodem_info *info = (modem_info *) tty->driver_data;\r\nu_char control, status;\r\nif (isdn_tty_paranoia_check(info, tty->name, __func__))\r\nreturn -ENODEV;\r\nif (tty->flags & (1 << TTY_IO_ERROR))\r\nreturn -EIO;\r\nmutex_lock(&modem_info_mutex);\r\n#ifdef ISDN_DEBUG_MODEM_IOCTL\r\nprintk(KERN_DEBUG "ttyI%d ioctl TIOCMGET\n", info->line);\r\n#endif\r\ncontrol = info->mcr;\r\nstatus = info->msr;\r\nmutex_unlock(&modem_info_mutex);\r\nreturn ((control & UART_MCR_RTS) ? TIOCM_RTS : 0)\r\n| ((control & UART_MCR_DTR) ? TIOCM_DTR : 0)\r\n| ((status & UART_MSR_DCD) ? TIOCM_CAR : 0)\r\n| ((status & UART_MSR_RI) ? TIOCM_RNG : 0)\r\n| ((status & UART_MSR_DSR) ? TIOCM_DSR : 0)\r\n| ((status & UART_MSR_CTS) ? TIOCM_CTS : 0);\r\n}\r\nstatic int\r\nisdn_tty_tiocmset(struct tty_struct *tty,\r\nunsigned int set, unsigned int clear)\r\n{\r\nmodem_info *info = (modem_info *) tty->driver_data;\r\nif (isdn_tty_paranoia_check(info, tty->name, __func__))\r\nreturn -ENODEV;\r\nif (tty->flags & (1 << TTY_IO_ERROR))\r\nreturn -EIO;\r\n#ifdef ISDN_DEBUG_MODEM_IOCTL\r\nprintk(KERN_DEBUG "ttyI%d ioctl TIOCMxxx: %x %x\n", info->line, set, clear);\r\n#endif\r\nmutex_lock(&modem_info_mutex);\r\nif (set & TIOCM_RTS)\r\ninfo->mcr |= UART_MCR_RTS;\r\nif (set & TIOCM_DTR) {\r\ninfo->mcr |= UART_MCR_DTR;\r\nisdn_tty_modem_ncarrier(info);\r\n}\r\nif (clear & TIOCM_RTS)\r\ninfo->mcr &= ~UART_MCR_RTS;\r\nif (clear & TIOCM_DTR) {\r\ninfo->mcr &= ~UART_MCR_DTR;\r\nif (info->emu.mdmreg[REG_DTRHUP] & BIT_DTRHUP) {\r\nisdn_tty_modem_reset_regs(info, 0);\r\n#ifdef ISDN_DEBUG_MODEM_HUP\r\nprintk(KERN_DEBUG "Mhup in TIOCMSET\n");\r\n#endif\r\nif (info->online)\r\ninfo->ncarrier = 1;\r\nisdn_tty_modem_hup(info, 1);\r\n}\r\n}\r\nmutex_unlock(&modem_info_mutex);\r\nreturn 0;\r\n}\r\nstatic int\r\nisdn_tty_ioctl(struct tty_struct *tty, uint cmd, ulong arg)\r\n{\r\nmodem_info *info = (modem_info *) tty->driver_data;\r\nint retval;\r\nif (isdn_tty_paranoia_check(info, tty->name, "isdn_tty_ioctl"))\r\nreturn -ENODEV;\r\nif (tty->flags & (1 << TTY_IO_ERROR))\r\nreturn -EIO;\r\nswitch (cmd) {\r\ncase TCSBRK:\r\n#ifdef ISDN_DEBUG_MODEM_IOCTL\r\nprintk(KERN_DEBUG "ttyI%d ioctl TCSBRK\n", info->line);\r\n#endif\r\nretval = tty_check_change(tty);\r\nif (retval)\r\nreturn retval;\r\ntty_wait_until_sent(tty, 0);\r\nreturn 0;\r\ncase TCSBRKP:\r\n#ifdef ISDN_DEBUG_MODEM_IOCTL\r\nprintk(KERN_DEBUG "ttyI%d ioctl TCSBRKP\n", info->line);\r\n#endif\r\nretval = tty_check_change(tty);\r\nif (retval)\r\nreturn retval;\r\ntty_wait_until_sent(tty, 0);\r\nreturn 0;\r\ncase TIOCSERGETLSR:\r\n#ifdef ISDN_DEBUG_MODEM_IOCTL\r\nprintk(KERN_DEBUG "ttyI%d ioctl TIOCSERGETLSR\n", info->line);\r\n#endif\r\nreturn isdn_tty_get_lsr_info(info, (uint __user *) arg);\r\ndefault:\r\n#ifdef ISDN_DEBUG_MODEM_IOCTL\r\nprintk(KERN_DEBUG "UNKNOWN ioctl 0x%08x on ttyi%d\n", cmd, info->line);\r\n#endif\r\nreturn -ENOIOCTLCMD;\r\n}\r\nreturn 0;\r\n}\r\nstatic void\r\nisdn_tty_set_termios(struct tty_struct *tty, struct ktermios *old_termios)\r\n{\r\nmodem_info *info = (modem_info *) tty->driver_data;\r\nif (!old_termios)\r\nisdn_tty_change_speed(info);\r\nelse {\r\nif (tty->termios->c_cflag == old_termios->c_cflag &&\r\ntty->termios->c_ispeed == old_termios->c_ispeed &&\r\ntty->termios->c_ospeed == old_termios->c_ospeed)\r\nreturn;\r\nisdn_tty_change_speed(info);\r\nif ((old_termios->c_cflag & CRTSCTS) &&\r\n!(tty->termios->c_cflag & CRTSCTS))\r\ntty->hw_stopped = 0;\r\n}\r\n}\r\nstatic int\r\nisdn_tty_open(struct tty_struct *tty, struct file *filp)\r\n{\r\nstruct tty_port *port;\r\nmodem_info *info;\r\nint retval;\r\ninfo = &dev->mdm.info[tty->index];\r\nif (isdn_tty_paranoia_check(info, tty->name, "isdn_tty_open"))\r\nreturn -ENODEV;\r\nport = &info->port;\r\n#ifdef ISDN_DEBUG_MODEM_OPEN\r\nprintk(KERN_DEBUG "isdn_tty_open %s, count = %d\n", tty->name,\r\nport->count);\r\n#endif\r\nport->count++;\r\ntty->driver_data = info;\r\nport->tty = tty;\r\ntty->port = port;\r\nretval = isdn_tty_startup(info);\r\nif (retval) {\r\n#ifdef ISDN_DEBUG_MODEM_OPEN\r\nprintk(KERN_DEBUG "isdn_tty_open return after startup\n");\r\n#endif\r\nreturn retval;\r\n}\r\nretval = tty_port_block_til_ready(port, tty, filp);\r\nif (retval) {\r\n#ifdef ISDN_DEBUG_MODEM_OPEN\r\nprintk(KERN_DEBUG "isdn_tty_open return after isdn_tty_block_til_ready \n");\r\n#endif\r\nreturn retval;\r\n}\r\n#ifdef ISDN_DEBUG_MODEM_OPEN\r\nprintk(KERN_DEBUG "isdn_tty_open ttyi%d successful...\n", info->line);\r\n#endif\r\ndev->modempoll++;\r\n#ifdef ISDN_DEBUG_MODEM_OPEN\r\nprintk(KERN_DEBUG "isdn_tty_open normal exit\n");\r\n#endif\r\nreturn 0;\r\n}\r\nstatic void\r\nisdn_tty_close(struct tty_struct *tty, struct file *filp)\r\n{\r\nmodem_info *info = (modem_info *) tty->driver_data;\r\nstruct tty_port *port = &info->port;\r\nulong timeout;\r\nif (!info || isdn_tty_paranoia_check(info, tty->name, "isdn_tty_close"))\r\nreturn;\r\nif (tty_hung_up_p(filp)) {\r\n#ifdef ISDN_DEBUG_MODEM_OPEN\r\nprintk(KERN_DEBUG "isdn_tty_close return after tty_hung_up_p\n");\r\n#endif\r\nreturn;\r\n}\r\nif ((tty->count == 1) && (port->count != 1)) {\r\nprintk(KERN_ERR "isdn_tty_close: bad port count; tty->count is 1, "\r\n"info->count is %d\n", port->count);\r\nport->count = 1;\r\n}\r\nif (--port->count < 0) {\r\nprintk(KERN_ERR "isdn_tty_close: bad port count for ttyi%d: %d\n",\r\ninfo->line, port->count);\r\nport->count = 0;\r\n}\r\nif (port->count) {\r\n#ifdef ISDN_DEBUG_MODEM_OPEN\r\nprintk(KERN_DEBUG "isdn_tty_close after info->count != 0\n");\r\n#endif\r\nreturn;\r\n}\r\nport->flags |= ASYNC_CLOSING;\r\ntty->closing = 1;\r\nif (port->flags & ASYNC_INITIALIZED) {\r\ntty_wait_until_sent_from_close(tty, 3000);\r\ntimeout = jiffies + HZ;\r\nwhile (!(info->lsr & UART_LSR_TEMT)) {\r\nschedule_timeout_interruptible(20);\r\nif (time_after(jiffies, timeout))\r\nbreak;\r\n}\r\n}\r\ndev->modempoll--;\r\nisdn_tty_shutdown(info);\r\nisdn_tty_flush_buffer(tty);\r\ntty_ldisc_flush(tty);\r\nport->tty = NULL;\r\ninfo->ncarrier = 0;\r\ntty_port_close_end(port, tty);\r\n#ifdef ISDN_DEBUG_MODEM_OPEN\r\nprintk(KERN_DEBUG "isdn_tty_close normal exit\n");\r\n#endif\r\n}\r\nstatic void\r\nisdn_tty_hangup(struct tty_struct *tty)\r\n{\r\nmodem_info *info = (modem_info *) tty->driver_data;\r\nstruct tty_port *port = &info->port;\r\nif (isdn_tty_paranoia_check(info, tty->name, "isdn_tty_hangup"))\r\nreturn;\r\nisdn_tty_shutdown(info);\r\nport->count = 0;\r\nport->flags &= ~ASYNC_NORMAL_ACTIVE;\r\nport->tty = NULL;\r\nwake_up_interruptible(&port->open_wait);\r\n}\r\nstatic void\r\nisdn_tty_reset_profile(atemu *m)\r\n{\r\nm->profile[0] = 0;\r\nm->profile[1] = 0;\r\nm->profile[2] = 43;\r\nm->profile[3] = 13;\r\nm->profile[4] = 10;\r\nm->profile[5] = 8;\r\nm->profile[6] = 3;\r\nm->profile[7] = 60;\r\nm->profile[8] = 2;\r\nm->profile[9] = 6;\r\nm->profile[10] = 7;\r\nm->profile[11] = 70;\r\nm->profile[12] = 0x45;\r\nm->profile[13] = 4;\r\nm->profile[14] = ISDN_PROTO_L2_X75I;\r\nm->profile[15] = ISDN_PROTO_L3_TRANS;\r\nm->profile[16] = ISDN_SERIAL_XMIT_SIZE / 16;\r\nm->profile[17] = ISDN_MODEM_WINSIZE;\r\nm->profile[18] = 4;\r\nm->profile[19] = 0;\r\nm->profile[20] = 0;\r\nm->profile[23] = 0;\r\nm->pmsn[0] = '\0';\r\nm->plmsn[0] = '\0';\r\n}\r\nstatic void\r\nisdn_tty_modem_reset_vpar(atemu *m)\r\n{\r\nm->vpar[0] = 2;\r\nm->vpar[1] = 0;\r\nm->vpar[2] = 70;\r\nm->vpar[3] = 2;\r\nm->vpar[4] = 0;\r\nm->vpar[5] = 8;\r\n}\r\nstatic void\r\nisdn_tty_modem_reset_faxpar(modem_info *info)\r\n{\r\nT30_s *f = info->fax;\r\nf->code = 0;\r\nf->phase = ISDN_FAX_PHASE_IDLE;\r\nf->direction = 0;\r\nf->resolution = 1;\r\nf->rate = 5;\r\nf->width = 0;\r\nf->length = 0;\r\nf->compression = 0;\r\nf->ecm = 0;\r\nf->binary = 0;\r\nf->scantime = 0;\r\nmemset(&f->id[0], 32, FAXIDLEN - 1);\r\nf->id[FAXIDLEN - 1] = 0;\r\nf->badlin = 0;\r\nf->badmul = 0;\r\nf->bor = 0;\r\nf->nbc = 0;\r\nf->cq = 0;\r\nf->cr = 0;\r\nf->ctcrty = 0;\r\nf->minsp = 0;\r\nf->phcto = 30;\r\nf->rel = 0;\r\nmemset(&f->pollid[0], 32, FAXIDLEN - 1);\r\nf->pollid[FAXIDLEN - 1] = 0;\r\n}\r\nstatic void\r\nisdn_tty_modem_reset_regs(modem_info *info, int force)\r\n{\r\natemu *m = &info->emu;\r\nif ((m->mdmreg[REG_DTRR] & BIT_DTRR) || force) {\r\nmemcpy(m->mdmreg, m->profile, ISDN_MODEM_NUMREG);\r\nmemcpy(m->msn, m->pmsn, ISDN_MSNLEN);\r\nmemcpy(m->lmsn, m->plmsn, ISDN_LMSNLEN);\r\ninfo->xmit_size = m->mdmreg[REG_PSIZE] * 16;\r\n}\r\n#ifdef CONFIG_ISDN_AUDIO\r\nisdn_tty_modem_reset_vpar(m);\r\n#endif\r\n#ifdef CONFIG_ISDN_TTY_FAX\r\nisdn_tty_modem_reset_faxpar(info);\r\n#endif\r\nm->mdmcmdl = 0;\r\n}\r\nstatic void\r\nmodem_write_profile(atemu *m)\r\n{\r\nmemcpy(m->profile, m->mdmreg, ISDN_MODEM_NUMREG);\r\nmemcpy(m->pmsn, m->msn, ISDN_MSNLEN);\r\nmemcpy(m->plmsn, m->lmsn, ISDN_LMSNLEN);\r\nif (dev->profd)\r\nsend_sig(SIGIO, dev->profd, 1);\r\n}\r\nstatic int isdn_tty_carrier_raised(struct tty_port *port)\r\n{\r\nmodem_info *info = container_of(port, modem_info, port);\r\nreturn info->msr & UART_MSR_DCD;\r\n}\r\nint\r\nisdn_tty_modem_init(void)\r\n{\r\nisdn_modem_t *m;\r\nint i, retval;\r\nmodem_info *info;\r\nm = &dev->mdm;\r\nm->tty_modem = alloc_tty_driver(ISDN_MAX_CHANNELS);\r\nif (!m->tty_modem)\r\nreturn -ENOMEM;\r\nm->tty_modem->name = "ttyI";\r\nm->tty_modem->major = ISDN_TTY_MAJOR;\r\nm->tty_modem->minor_start = 0;\r\nm->tty_modem->type = TTY_DRIVER_TYPE_SERIAL;\r\nm->tty_modem->subtype = SERIAL_TYPE_NORMAL;\r\nm->tty_modem->init_termios = tty_std_termios;\r\nm->tty_modem->init_termios.c_cflag = B9600 | CS8 | CREAD | HUPCL | CLOCAL;\r\nm->tty_modem->flags = TTY_DRIVER_REAL_RAW | TTY_DRIVER_DYNAMIC_DEV;\r\nm->tty_modem->driver_name = "isdn_tty";\r\ntty_set_operations(m->tty_modem, &modem_ops);\r\nretval = tty_register_driver(m->tty_modem);\r\nif (retval) {\r\nprintk(KERN_WARNING "isdn_tty: Couldn't register modem-device\n");\r\ngoto err;\r\n}\r\nfor (i = 0; i < ISDN_MAX_CHANNELS; i++) {\r\ninfo = &m->info[i];\r\n#ifdef CONFIG_ISDN_TTY_FAX\r\nif (!(info->fax = kmalloc(sizeof(T30_s), GFP_KERNEL))) {\r\nprintk(KERN_ERR "Could not allocate fax t30-buffer\n");\r\nretval = -ENOMEM;\r\ngoto err_unregister;\r\n}\r\n#endif\r\ntty_port_init(&info->port);\r\ninfo->port.ops = &isdn_tty_port_ops;\r\nspin_lock_init(&info->readlock);\r\nsprintf(info->last_cause, "0000");\r\nsprintf(info->last_num, "none");\r\ninfo->last_dir = 0;\r\ninfo->last_lhup = 1;\r\ninfo->last_l2 = -1;\r\ninfo->last_si = 0;\r\nisdn_tty_reset_profile(&info->emu);\r\nisdn_tty_modem_reset_regs(info, 1);\r\ninfo->magic = ISDN_ASYNC_MAGIC;\r\ninfo->line = i;\r\ninfo->x_char = 0;\r\ninfo->isdn_driver = -1;\r\ninfo->isdn_channel = -1;\r\ninfo->drv_index = -1;\r\ninfo->xmit_size = ISDN_SERIAL_XMIT_SIZE;\r\ninit_timer(&info->nc_timer);\r\ninfo->nc_timer.function = isdn_tty_modem_do_ncarrier;\r\ninfo->nc_timer.data = (unsigned long) info;\r\nskb_queue_head_init(&info->xmit_queue);\r\n#ifdef CONFIG_ISDN_AUDIO\r\nskb_queue_head_init(&info->dtmf_queue);\r\n#endif\r\ninfo->port.xmit_buf = kmalloc(ISDN_SERIAL_XMIT_MAX + 5,\r\nGFP_KERNEL);\r\nif (!info->port.xmit_buf) {\r\nprintk(KERN_ERR "Could not allocate modem xmit-buffer\n");\r\nretval = -ENOMEM;\r\ngoto err_unregister;\r\n}\r\ninfo->port.xmit_buf += 4;\r\n}\r\nreturn 0;\r\nerr_unregister:\r\nfor (i--; i >= 0; i--) {\r\ninfo = &m->info[i];\r\n#ifdef CONFIG_ISDN_TTY_FAX\r\nkfree(info->fax);\r\n#endif\r\nkfree(info->port.xmit_buf - 4);\r\n}\r\ntty_unregister_driver(m->tty_modem);\r\nerr:\r\nput_tty_driver(m->tty_modem);\r\nm->tty_modem = NULL;\r\nreturn retval;\r\n}\r\nvoid\r\nisdn_tty_exit(void)\r\n{\r\nmodem_info *info;\r\nint i;\r\nfor (i = 0; i < ISDN_MAX_CHANNELS; i++) {\r\ninfo = &dev->mdm.info[i];\r\nisdn_tty_cleanup_xmit(info);\r\n#ifdef CONFIG_ISDN_TTY_FAX\r\nkfree(info->fax);\r\n#endif\r\nkfree(info->port.xmit_buf - 4);\r\n}\r\ntty_unregister_driver(dev->mdm.tty_modem);\r\nput_tty_driver(dev->mdm.tty_modem);\r\ndev->mdm.tty_modem = NULL;\r\n}\r\nstatic int\r\nisdn_tty_match_icall(char *cid, atemu *emu, int di)\r\n{\r\n#ifdef ISDN_DEBUG_MODEM_ICALL\r\nprintk(KERN_DEBUG "m_fi: msn=%s lmsn=%s mmsn=%s mreg[SI1]=%d mreg[SI2]=%d\n",\r\nemu->msn, emu->lmsn, isdn_map_eaz2msn(emu->msn, di),\r\nemu->mdmreg[REG_SI1], emu->mdmreg[REG_SI2]);\r\n#endif\r\nif (strlen(emu->lmsn)) {\r\nchar *p = emu->lmsn;\r\nchar *q;\r\nint tmp;\r\nint ret = 0;\r\nwhile (1) {\r\nif ((q = strchr(p, ';')))\r\n*q = '\0';\r\nif ((tmp = isdn_msncmp(cid, isdn_map_eaz2msn(p, di))) > ret)\r\nret = tmp;\r\n#ifdef ISDN_DEBUG_MODEM_ICALL\r\nprintk(KERN_DEBUG "m_fi: lmsnX=%s mmsn=%s -> tmp=%d\n",\r\np, isdn_map_eaz2msn(emu->msn, di), tmp);\r\n#endif\r\nif (q) {\r\n*q = ';';\r\np = q;\r\np++;\r\n}\r\nif (!tmp)\r\nreturn 0;\r\nif (!q)\r\nbreak;\r\n}\r\nreturn ret;\r\n} else {\r\nint tmp;\r\ntmp = isdn_msncmp(cid, isdn_map_eaz2msn(emu->msn, di));\r\n#ifdef ISDN_DEBUG_MODEM_ICALL\r\nprintk(KERN_DEBUG "m_fi: mmsn=%s -> tmp=%d\n",\r\nisdn_map_eaz2msn(emu->msn, di), tmp);\r\n#endif\r\nreturn tmp;\r\n}\r\n}\r\nint\r\nisdn_tty_find_icall(int di, int ch, setup_parm *setup)\r\n{\r\nchar *eaz;\r\nint i;\r\nint wret;\r\nint idx;\r\nint si1;\r\nint si2;\r\nchar *nr;\r\nulong flags;\r\nif (!setup->phone[0]) {\r\nnr = "0";\r\nprintk(KERN_INFO "isdn_tty: Incoming call without OAD, assuming '0'\n");\r\n} else\r\nnr = setup->phone;\r\nsi1 = (int) setup->si1;\r\nsi2 = (int) setup->si2;\r\nif (!setup->eazmsn[0]) {\r\nprintk(KERN_WARNING "isdn_tty: Incoming call without CPN, assuming '0'\n");\r\neaz = "0";\r\n} else\r\neaz = setup->eazmsn;\r\n#ifdef ISDN_DEBUG_MODEM_ICALL\r\nprintk(KERN_DEBUG "m_fi: eaz=%s si1=%d si2=%d\n", eaz, si1, si2);\r\n#endif\r\nwret = 0;\r\nspin_lock_irqsave(&dev->lock, flags);\r\nfor (i = 0; i < ISDN_MAX_CHANNELS; i++) {\r\nmodem_info *info = &dev->mdm.info[i];\r\nif (info->port.count == 0)\r\ncontinue;\r\nif ((info->emu.mdmreg[REG_SI1] & si2bit[si1]) &&\r\n(info->emu.mdmreg[REG_SI2] == si2)) {\r\nidx = isdn_dc2minor(di, ch);\r\n#ifdef ISDN_DEBUG_MODEM_ICALL\r\nprintk(KERN_DEBUG "m_fi: match1 wret=%d\n", wret);\r\nprintk(KERN_DEBUG "m_fi: idx=%d flags=%08lx drv=%d ch=%d usg=%d\n", idx,\r\ninfo->port.flags, info->isdn_driver,\r\ninfo->isdn_channel, dev->usage[idx]);\r\n#endif\r\nif (\r\n#ifndef FIX_FILE_TRANSFER\r\n(info->port.flags & ASYNC_NORMAL_ACTIVE) &&\r\n#endif\r\n(info->isdn_driver == -1) &&\r\n(info->isdn_channel == -1) &&\r\n(USG_NONE(dev->usage[idx]))) {\r\nint matchret;\r\nif ((matchret = isdn_tty_match_icall(eaz, &info->emu, di)) > wret)\r\nwret = matchret;\r\nif (!matchret) {\r\ninfo->isdn_driver = di;\r\ninfo->isdn_channel = ch;\r\ninfo->drv_index = idx;\r\ndev->m_idx[idx] = info->line;\r\ndev->usage[idx] &= ISDN_USAGE_EXCLUSIVE;\r\ndev->usage[idx] |= isdn_calc_usage(si1, info->emu.mdmreg[REG_L2PROT]);\r\nstrcpy(dev->num[idx], nr);\r\nstrcpy(info->emu.cpn, eaz);\r\ninfo->emu.mdmreg[REG_SI1I] = si2bit[si1];\r\ninfo->emu.mdmreg[REG_PLAN] = setup->plan;\r\ninfo->emu.mdmreg[REG_SCREEN] = setup->screen;\r\nisdn_info_update();\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nprintk(KERN_INFO "isdn_tty: call from %s, -> RING on ttyI%d\n", nr,\r\ninfo->line);\r\ninfo->msr |= UART_MSR_RI;\r\nisdn_tty_modem_result(RESULT_RING, info);\r\nisdn_timer_ctrl(ISDN_TIMER_MODEMRING, 1);\r\nreturn 1;\r\n}\r\n}\r\n}\r\n}\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nprintk(KERN_INFO "isdn_tty: call from %s -> %s %s\n", nr, eaz,\r\n((dev->drv[di]->flags & DRV_FLAG_REJBUS) && (wret != 2)) ? "rejected" : "ignored");\r\nreturn (wret == 2) ? 3 : 0;\r\n}\r\nint\r\nisdn_tty_stat_callback(int i, isdn_ctrl *c)\r\n{\r\nint mi;\r\nmodem_info *info;\r\nchar *e;\r\nif (i < 0)\r\nreturn 0;\r\nif ((mi = dev->m_idx[i]) >= 0) {\r\ninfo = &dev->mdm.info[mi];\r\nswitch (c->command) {\r\ncase ISDN_STAT_CINF:\r\nprintk(KERN_DEBUG "CHARGEINFO on ttyI%d: %ld %s\n", info->line, c->arg, c->parm.num);\r\ninfo->emu.charge = (unsigned) simple_strtoul(c->parm.num, &e, 10);\r\nif (e == (char *)c->parm.num)\r\ninfo->emu.charge = 0;\r\nbreak;\r\ncase ISDN_STAT_BSENT:\r\n#ifdef ISDN_TTY_STAT_DEBUG\r\nprintk(KERN_DEBUG "tty_STAT_BSENT ttyI%d\n", info->line);\r\n#endif\r\nif ((info->isdn_driver == c->driver) &&\r\n(info->isdn_channel == c->arg)) {\r\ninfo->msr |= UART_MSR_CTS;\r\nif (info->send_outstanding)\r\nif (!(--info->send_outstanding))\r\ninfo->lsr |= UART_LSR_TEMT;\r\nisdn_tty_tint(info);\r\nreturn 1;\r\n}\r\nbreak;\r\ncase ISDN_STAT_CAUSE:\r\n#ifdef ISDN_TTY_STAT_DEBUG\r\nprintk(KERN_DEBUG "tty_STAT_CAUSE ttyI%d\n", info->line);\r\n#endif\r\nstrncpy(info->last_cause, c->parm.num, 5);\r\nreturn 1;\r\ncase ISDN_STAT_DISPLAY:\r\n#ifdef ISDN_TTY_STAT_DEBUG\r\nprintk(KERN_DEBUG "tty_STAT_DISPLAY ttyI%d\n", info->line);\r\n#endif\r\nif ((info->emu.mdmreg[REG_DISPLAY] & BIT_DISPLAY) &&\r\n!(info->emu.mdmreg[REG_RESPNUM] & BIT_RESPNUM)) {\r\nisdn_tty_at_cout("\r\n", info);\r\nisdn_tty_at_cout("DISPLAY: ", info);\r\nisdn_tty_at_cout(c->parm.display, info);\r\nisdn_tty_at_cout("\r\n", info);\r\n}\r\nreturn 1;\r\ncase ISDN_STAT_DCONN:\r\n#ifdef ISDN_TTY_STAT_DEBUG\r\nprintk(KERN_DEBUG "tty_STAT_DCONN ttyI%d\n", info->line);\r\n#endif\r\nif (TTY_IS_ACTIVE(info)) {\r\nif (info->dialing == 1) {\r\ninfo->dialing = 2;\r\nreturn 1;\r\n}\r\n}\r\nbreak;\r\ncase ISDN_STAT_DHUP:\r\n#ifdef ISDN_TTY_STAT_DEBUG\r\nprintk(KERN_DEBUG "tty_STAT_DHUP ttyI%d\n", info->line);\r\n#endif\r\nif (TTY_IS_ACTIVE(info)) {\r\nif (info->dialing == 1)\r\nisdn_tty_modem_result(RESULT_BUSY, info);\r\nif (info->dialing > 1)\r\nisdn_tty_modem_result(RESULT_NO_CARRIER, info);\r\ninfo->dialing = 0;\r\n#ifdef ISDN_DEBUG_MODEM_HUP\r\nprintk(KERN_DEBUG "Mhup in ISDN_STAT_DHUP\n");\r\n#endif\r\nisdn_tty_modem_hup(info, 0);\r\nreturn 1;\r\n}\r\nbreak;\r\ncase ISDN_STAT_BCONN:\r\n#ifdef ISDN_TTY_STAT_DEBUG\r\nprintk(KERN_DEBUG "tty_STAT_BCONN ttyI%d\n", info->line);\r\n#endif\r\nif (info->port.blocked_open &&\r\n(info->emu.mdmreg[REG_DCD] & BIT_DCD)) {\r\nwake_up_interruptible(&info->port.open_wait);\r\n}\r\nif (TTY_IS_ACTIVE(info) ||\r\n(info->port.blocked_open &&\r\n(info->emu.mdmreg[REG_DCD] & BIT_DCD))) {\r\ninfo->msr |= UART_MSR_DCD;\r\ninfo->emu.charge = 0;\r\nif (info->dialing & 0xf)\r\ninfo->last_dir = 1;\r\nelse\r\ninfo->last_dir = 0;\r\ninfo->dialing = 0;\r\ninfo->rcvsched = 1;\r\nif (USG_MODEM(dev->usage[i])) {\r\nif (info->emu.mdmreg[REG_L2PROT] == ISDN_PROTO_L2_MODEM) {\r\nstrcpy(info->emu.connmsg, c->parm.num);\r\nisdn_tty_modem_result(RESULT_CONNECT, info);\r\n} else\r\nisdn_tty_modem_result(RESULT_CONNECT64000, info);\r\n}\r\nif (USG_VOICE(dev->usage[i]))\r\nisdn_tty_modem_result(RESULT_VCON, info);\r\nreturn 1;\r\n}\r\nbreak;\r\ncase ISDN_STAT_BHUP:\r\n#ifdef ISDN_TTY_STAT_DEBUG\r\nprintk(KERN_DEBUG "tty_STAT_BHUP ttyI%d\n", info->line);\r\n#endif\r\nif (TTY_IS_ACTIVE(info)) {\r\n#ifdef ISDN_DEBUG_MODEM_HUP\r\nprintk(KERN_DEBUG "Mhup in ISDN_STAT_BHUP\n");\r\n#endif\r\nisdn_tty_modem_hup(info, 0);\r\nreturn 1;\r\n}\r\nbreak;\r\ncase ISDN_STAT_NODCH:\r\n#ifdef ISDN_TTY_STAT_DEBUG\r\nprintk(KERN_DEBUG "tty_STAT_NODCH ttyI%d\n", info->line);\r\n#endif\r\nif (TTY_IS_ACTIVE(info)) {\r\nif (info->dialing) {\r\ninfo->dialing = 0;\r\ninfo->last_l2 = -1;\r\ninfo->last_si = 0;\r\nsprintf(info->last_cause, "0000");\r\nisdn_tty_modem_result(RESULT_NO_DIALTONE, info);\r\n}\r\nisdn_tty_modem_hup(info, 0);\r\nreturn 1;\r\n}\r\nbreak;\r\ncase ISDN_STAT_UNLOAD:\r\n#ifdef ISDN_TTY_STAT_DEBUG\r\nprintk(KERN_DEBUG "tty_STAT_UNLOAD ttyI%d\n", info->line);\r\n#endif\r\nfor (i = 0; i < ISDN_MAX_CHANNELS; i++) {\r\ninfo = &dev->mdm.info[i];\r\nif (info->isdn_driver == c->driver) {\r\nif (info->online)\r\nisdn_tty_modem_hup(info, 1);\r\n}\r\n}\r\nreturn 1;\r\n#ifdef CONFIG_ISDN_TTY_FAX\r\ncase ISDN_STAT_FAXIND:\r\nif (TTY_IS_ACTIVE(info)) {\r\nisdn_tty_fax_command(info, c);\r\n}\r\nbreak;\r\n#endif\r\n#ifdef CONFIG_ISDN_AUDIO\r\ncase ISDN_STAT_AUDIO:\r\nif (TTY_IS_ACTIVE(info)) {\r\nswitch (c->parm.num[0]) {\r\ncase ISDN_AUDIO_DTMF:\r\nif (info->vonline) {\r\nisdn_audio_put_dle_code(info,\r\nc->parm.num[1]);\r\n}\r\nbreak;\r\n}\r\n}\r\nbreak;\r\n#endif\r\n}\r\n}\r\nreturn 0;\r\n}\r\nvoid\r\nisdn_tty_at_cout(char *msg, modem_info *info)\r\n{\r\nstruct tty_struct *tty;\r\natemu *m = &info->emu;\r\nchar *p;\r\nchar c;\r\nu_long flags;\r\nstruct sk_buff *skb = NULL;\r\nchar *sp = NULL;\r\nint l;\r\nif (!msg) {\r\nprintk(KERN_WARNING "isdn_tty: Null-Message in isdn_tty_at_cout\n");\r\nreturn;\r\n}\r\nl = strlen(msg);\r\nspin_lock_irqsave(&info->readlock, flags);\r\ntty = info->port.tty;\r\nif ((info->port.flags & ASYNC_CLOSING) || (!tty)) {\r\nspin_unlock_irqrestore(&info->readlock, flags);\r\nreturn;\r\n}\r\nif (info->online && ((tty_buffer_request_room(tty, l) < l) ||\r\n!skb_queue_empty(&dev->drv[info->isdn_driver]->rpqueue[info->isdn_channel]))) {\r\nskb = alloc_skb(l, GFP_ATOMIC);\r\nif (!skb) {\r\nspin_unlock_irqrestore(&info->readlock, flags);\r\nreturn;\r\n}\r\nsp = skb_put(skb, l);\r\n#ifdef CONFIG_ISDN_AUDIO\r\nISDN_AUDIO_SKB_DLECOUNT(skb) = 0;\r\nISDN_AUDIO_SKB_LOCK(skb) = 0;\r\n#endif\r\n}\r\nfor (p = msg; *p; p++) {\r\nswitch (*p) {\r\ncase '\r':\r\nc = m->mdmreg[REG_CR];\r\nbreak;\r\ncase '\n':\r\nc = m->mdmreg[REG_LF];\r\nbreak;\r\ncase '\b':\r\nc = m->mdmreg[REG_BS];\r\nbreak;\r\ndefault:\r\nc = *p;\r\n}\r\nif (skb) {\r\n*sp++ = c;\r\n} else {\r\nif (tty_insert_flip_char(tty, c, TTY_NORMAL) == 0)\r\nbreak;\r\n}\r\n}\r\nif (skb) {\r\n__skb_queue_tail(&dev->drv[info->isdn_driver]->rpqueue[info->isdn_channel], skb);\r\ndev->drv[info->isdn_driver]->rcvcount[info->isdn_channel] += skb->len;\r\nspin_unlock_irqrestore(&info->readlock, flags);\r\nif (dev->modempoll && info->rcvsched)\r\nisdn_timer_ctrl(ISDN_TIMER_MODEMREAD, 1);\r\n} else {\r\nspin_unlock_irqrestore(&info->readlock, flags);\r\ntty_flip_buffer_push(tty);\r\n}\r\n}\r\nstatic void\r\nisdn_tty_on_hook(modem_info *info)\r\n{\r\nif (info->isdn_channel >= 0) {\r\n#ifdef ISDN_DEBUG_MODEM_HUP\r\nprintk(KERN_DEBUG "Mhup in isdn_tty_on_hook\n");\r\n#endif\r\nisdn_tty_modem_hup(info, 1);\r\n}\r\n}\r\nstatic void\r\nisdn_tty_off_hook(void)\r\n{\r\nprintk(KERN_DEBUG "isdn_tty_off_hook\n");\r\n}\r\nstatic void\r\nisdn_tty_check_esc(const u_char *p, u_char plus, int count, int *pluscount,\r\nu_long *lastplus)\r\n{\r\nif (plus > 127)\r\nreturn;\r\nif (count > 3) {\r\np += count - 3;\r\ncount = 3;\r\n*pluscount = 0;\r\n}\r\nwhile (count > 0) {\r\nif (*(p++) == plus) {\r\nif ((*pluscount)++) {\r\nif (time_after(jiffies, *lastplus + PLUSWAIT1))\r\n*pluscount = 1;\r\n} else {\r\nif (time_before(jiffies, *lastplus + PLUSWAIT2))\r\n*pluscount = 0;\r\n}\r\nif ((*pluscount == 3) && (count == 1))\r\nisdn_timer_ctrl(ISDN_TIMER_MODEMPLUS, 1);\r\nif (*pluscount > 3)\r\n*pluscount = 1;\r\n} else\r\n*pluscount = 0;\r\n*lastplus = jiffies;\r\ncount--;\r\n}\r\n}\r\nstatic void\r\nisdn_tty_modem_result(int code, modem_info *info)\r\n{\r\natemu *m = &info->emu;\r\nstatic char *msg[] =\r\n{"OK", "CONNECT", "RING", "NO CARRIER", "ERROR",\r\n"CONNECT 64000", "NO DIALTONE", "BUSY", "NO ANSWER",\r\n"RINGING", "NO MSN/EAZ", "VCON", "RUNG"};\r\nchar s[ISDN_MSNLEN + 10];\r\nswitch (code) {\r\ncase RESULT_RING:\r\nm->mdmreg[REG_RINGCNT]++;\r\nif (m->mdmreg[REG_RINGCNT] == m->mdmreg[REG_RINGATA])\r\nisdn_tty_cmd_ATA(info);\r\nbreak;\r\ncase RESULT_NO_CARRIER:\r\n#ifdef ISDN_DEBUG_MODEM_HUP\r\nprintk(KERN_DEBUG "modem_result: NO CARRIER %d %d\n",\r\n(info->port.flags & ASYNC_CLOSING),\r\n(!info->port.tty));\r\n#endif\r\nm->mdmreg[REG_RINGCNT] = 0;\r\ndel_timer(&info->nc_timer);\r\ninfo->ncarrier = 0;\r\nif ((info->port.flags & ASYNC_CLOSING) || (!info->port.tty))\r\nreturn;\r\n#ifdef CONFIG_ISDN_AUDIO\r\nif (info->vonline & 1) {\r\n#ifdef ISDN_DEBUG_MODEM_VOICE\r\nprintk(KERN_DEBUG "res3: send DLE-ETX on ttyI%d\n",\r\ninfo->line);\r\n#endif\r\nisdn_tty_at_cout("\020\003", info);\r\n}\r\nif (info->vonline & 2) {\r\n#ifdef ISDN_DEBUG_MODEM_VOICE\r\nprintk(KERN_DEBUG "res3: send DLE-DC4 on ttyI%d\n",\r\ninfo->line);\r\n#endif\r\nisdn_tty_at_cout("\020\024", info);\r\n}\r\n#endif\r\nbreak;\r\ncase RESULT_CONNECT:\r\ncase RESULT_CONNECT64000:\r\nsprintf(info->last_cause, "0000");\r\nif (!info->online)\r\ninfo->online = 2;\r\nbreak;\r\ncase RESULT_VCON:\r\n#ifdef ISDN_DEBUG_MODEM_VOICE\r\nprintk(KERN_DEBUG "res3: send VCON on ttyI%d\n",\r\ninfo->line);\r\n#endif\r\nsprintf(info->last_cause, "0000");\r\nif (!info->online)\r\ninfo->online = 1;\r\nbreak;\r\n}\r\nif (m->mdmreg[REG_RESP] & BIT_RESP) {\r\nif (m->mdmreg[REG_RESPNUM] & BIT_RESPNUM) {\r\nsprintf(s, "\r\n%d\r\n", code);\r\nisdn_tty_at_cout(s, info);\r\n} else {\r\nif (code == RESULT_RING) {\r\nif ((m->mdmreg[REG_RUNG] & BIT_RUNG) &&\r\n(m->mdmreg[REG_RINGCNT] > 1))\r\nreturn;\r\nif (!(m->mdmreg[REG_CIDONCE] & BIT_CIDONCE)) {\r\nisdn_tty_at_cout("\r\nCALLER NUMBER: ", info);\r\nisdn_tty_at_cout(dev->num[info->drv_index], info);\r\nif (m->mdmreg[REG_CDN] & BIT_CDN) {\r\nisdn_tty_at_cout("\r\nCALLED NUMBER: ", info);\r\nisdn_tty_at_cout(info->emu.cpn, info);\r\n}\r\n}\r\n}\r\nisdn_tty_at_cout("\r\n", info);\r\nisdn_tty_at_cout(msg[code], info);\r\nswitch (code) {\r\ncase RESULT_CONNECT:\r\nswitch (m->mdmreg[REG_L2PROT]) {\r\ncase ISDN_PROTO_L2_MODEM:\r\nisdn_tty_at_cout(" ", info);\r\nisdn_tty_at_cout(m->connmsg, info);\r\nbreak;\r\n}\r\nbreak;\r\ncase RESULT_RING:\r\nif ((m->mdmreg[REG_CPN] & BIT_CPN)) {\r\nsprintf(s, "/%s", m->cpn);\r\nisdn_tty_at_cout(s, info);\r\n}\r\nif ((m->mdmreg[REG_CIDONCE] & BIT_CIDONCE) &&\r\n(m->mdmreg[REG_RINGCNT] == 1)) {\r\nisdn_tty_at_cout("\r\n", info);\r\nisdn_tty_at_cout("CALLER NUMBER: ", info);\r\nisdn_tty_at_cout(dev->num[info->drv_index], info);\r\nif (m->mdmreg[REG_CDN] & BIT_CDN) {\r\nisdn_tty_at_cout("\r\nCALLED NUMBER: ", info);\r\nisdn_tty_at_cout(info->emu.cpn, info);\r\n}\r\n}\r\nbreak;\r\ncase RESULT_NO_CARRIER:\r\ncase RESULT_NO_DIALTONE:\r\ncase RESULT_BUSY:\r\ncase RESULT_NO_ANSWER:\r\nm->mdmreg[REG_RINGCNT] = 0;\r\nif (m->mdmreg[REG_RESPXT] & BIT_RESPXT) {\r\nsprintf(s, "/%s", info->last_cause);\r\nisdn_tty_at_cout(s, info);\r\n}\r\nbreak;\r\ncase RESULT_CONNECT64000:\r\nswitch (m->mdmreg[REG_L2PROT]) {\r\ncase ISDN_PROTO_L2_X75I:\r\ncase ISDN_PROTO_L2_X75UI:\r\ncase ISDN_PROTO_L2_X75BUI:\r\nisdn_tty_at_cout("/X.75", info);\r\nbreak;\r\ncase ISDN_PROTO_L2_HDLC:\r\nisdn_tty_at_cout("/HDLC", info);\r\nbreak;\r\ncase ISDN_PROTO_L2_V11096:\r\nisdn_tty_at_cout("/V110/9600", info);\r\nbreak;\r\ncase ISDN_PROTO_L2_V11019:\r\nisdn_tty_at_cout("/V110/19200", info);\r\nbreak;\r\ncase ISDN_PROTO_L2_V11038:\r\nisdn_tty_at_cout("/V110/38400", info);\r\nbreak;\r\n}\r\nif (m->mdmreg[REG_T70] & BIT_T70) {\r\nisdn_tty_at_cout("/T.70", info);\r\nif (m->mdmreg[REG_T70] & BIT_T70_EXT)\r\nisdn_tty_at_cout("+", info);\r\n}\r\nbreak;\r\n}\r\nisdn_tty_at_cout("\r\n", info);\r\n}\r\n}\r\nif (code == RESULT_NO_CARRIER) {\r\nif ((info->port.flags & ASYNC_CLOSING) || (!info->port.tty))\r\nreturn;\r\nif (info->port.flags & ASYNC_CHECK_CD)\r\ntty_hangup(info->port.tty);\r\n}\r\n}\r\nstatic void\r\nisdn_tty_show_profile(int ridx, modem_info *info)\r\n{\r\nchar v[6];\r\nsprintf(v, "\r\n%d", info->emu.mdmreg[ridx]);\r\nisdn_tty_at_cout(v, info);\r\n}\r\nstatic void\r\nisdn_tty_get_msnstr(char *n, char **p)\r\n{\r\nint limit = ISDN_MSNLEN - 1;\r\nwhile (((*p[0] >= '0' && *p[0] <= '9') ||\r\n(*p[0] == ',') || (*p[0] == ':')) &&\r\n(limit--))\r\n*n++ = *p[0]++;\r\n*n = '\0';\r\n}\r\nstatic void\r\nisdn_tty_getdial(char *p, char *q, int cnt)\r\n{\r\nint first = 1;\r\nint limit = ISDN_MSNLEN - 1;\r\nwhile (strchr(" 0123456789,#.*WPTSR-", *p) && *p && --cnt > 0) {\r\nif ((*p >= '0' && *p <= '9') || ((*p == 'S') && first) ||\r\n((*p == 'R') && first) ||\r\n(*p == '*') || (*p == '#')) {\r\n*q++ = *p;\r\nlimit--;\r\n}\r\nif (!limit)\r\nbreak;\r\np++;\r\nfirst = 0;\r\n}\r\n*q = 0;\r\n}\r\nstatic void\r\nisdn_tty_report(modem_info *info)\r\n{\r\natemu *m = &info->emu;\r\nchar s[80];\r\nisdn_tty_at_cout("\r\nStatistics of last connection:\r\n\r\n", info);\r\nsprintf(s, " Remote Number: %s\r\n", info->last_num);\r\nisdn_tty_at_cout(s, info);\r\nsprintf(s, " Direction: %s\r\n", info->last_dir ? "outgoing" : "incoming");\r\nisdn_tty_at_cout(s, info);\r\nisdn_tty_at_cout(" Layer-2 Protocol: ", info);\r\nswitch (info->last_l2) {\r\ncase ISDN_PROTO_L2_X75I:\r\nisdn_tty_at_cout("X.75i", info);\r\nbreak;\r\ncase ISDN_PROTO_L2_X75UI:\r\nisdn_tty_at_cout("X.75ui", info);\r\nbreak;\r\ncase ISDN_PROTO_L2_X75BUI:\r\nisdn_tty_at_cout("X.75bui", info);\r\nbreak;\r\ncase ISDN_PROTO_L2_HDLC:\r\nisdn_tty_at_cout("HDLC", info);\r\nbreak;\r\ncase ISDN_PROTO_L2_V11096:\r\nisdn_tty_at_cout("V.110 9600 Baud", info);\r\nbreak;\r\ncase ISDN_PROTO_L2_V11019:\r\nisdn_tty_at_cout("V.110 19200 Baud", info);\r\nbreak;\r\ncase ISDN_PROTO_L2_V11038:\r\nisdn_tty_at_cout("V.110 38400 Baud", info);\r\nbreak;\r\ncase ISDN_PROTO_L2_TRANS:\r\nisdn_tty_at_cout("transparent", info);\r\nbreak;\r\ncase ISDN_PROTO_L2_MODEM:\r\nisdn_tty_at_cout("modem", info);\r\nbreak;\r\ncase ISDN_PROTO_L2_FAX:\r\nisdn_tty_at_cout("fax", info);\r\nbreak;\r\ndefault:\r\nisdn_tty_at_cout("unknown", info);\r\nbreak;\r\n}\r\nif (m->mdmreg[REG_T70] & BIT_T70) {\r\nisdn_tty_at_cout("/T.70", info);\r\nif (m->mdmreg[REG_T70] & BIT_T70_EXT)\r\nisdn_tty_at_cout("+", info);\r\n}\r\nisdn_tty_at_cout("\r\n", info);\r\nisdn_tty_at_cout(" Service: ", info);\r\nswitch (info->last_si) {\r\ncase 1:\r\nisdn_tty_at_cout("audio\r\n", info);\r\nbreak;\r\ncase 5:\r\nisdn_tty_at_cout("btx\r\n", info);\r\nbreak;\r\ncase 7:\r\nisdn_tty_at_cout("data\r\n", info);\r\nbreak;\r\ndefault:\r\nsprintf(s, "%d\r\n", info->last_si);\r\nisdn_tty_at_cout(s, info);\r\nbreak;\r\n}\r\nsprintf(s, " Hangup location: %s\r\n", info->last_lhup ? "local" : "remote");\r\nisdn_tty_at_cout(s, info);\r\nsprintf(s, " Last cause: %s\r\n", info->last_cause);\r\nisdn_tty_at_cout(s, info);\r\n}\r\nstatic int\r\nisdn_tty_cmd_ATand(char **p, modem_info *info)\r\n{\r\natemu *m = &info->emu;\r\nint i;\r\nchar rb[100];\r\n#define MAXRB (sizeof(rb) - 1)\r\nswitch (*p[0]) {\r\ncase 'B':\r\np[0]++;\r\ni = isdn_getnum(p);\r\nif ((i < 0) || (i > ISDN_SERIAL_XMIT_MAX))\r\nPARSE_ERROR1;\r\n#ifdef CONFIG_ISDN_AUDIO\r\nif ((m->mdmreg[REG_SI1] & 1) && (i > VBUF))\r\nPARSE_ERROR1;\r\n#endif\r\nm->mdmreg[REG_PSIZE] = i / 16;\r\ninfo->xmit_size = m->mdmreg[REG_PSIZE] * 16;\r\nswitch (m->mdmreg[REG_L2PROT]) {\r\ncase ISDN_PROTO_L2_V11096:\r\ncase ISDN_PROTO_L2_V11019:\r\ncase ISDN_PROTO_L2_V11038:\r\ninfo->xmit_size /= 10;\r\n}\r\nbreak;\r\ncase 'C':\r\np[0]++;\r\nswitch (isdn_getnum(p)) {\r\ncase 0:\r\nm->mdmreg[REG_DCD] &= ~BIT_DCD;\r\nbreak;\r\ncase 1:\r\nm->mdmreg[REG_DCD] |= BIT_DCD;\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1\r\n}\r\nbreak;\r\ncase 'D':\r\np[0]++;\r\nswitch (isdn_getnum(p)) {\r\ncase 0:\r\nm->mdmreg[REG_DTRHUP] &= ~BIT_DTRHUP;\r\nm->mdmreg[REG_DTRR] &= ~BIT_DTRR;\r\nbreak;\r\ncase 2:\r\nm->mdmreg[REG_DTRHUP] |= BIT_DTRHUP;\r\nm->mdmreg[REG_DTRR] &= ~BIT_DTRR;\r\nbreak;\r\ncase 3:\r\nm->mdmreg[REG_DTRHUP] |= BIT_DTRHUP;\r\nm->mdmreg[REG_DTRR] |= BIT_DTRR;\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1\r\n}\r\nbreak;\r\ncase 'E':\r\np[0]++;\r\nisdn_tty_get_msnstr(m->msn, p);\r\nbreak;\r\ncase 'F':\r\np[0]++;\r\nif (info->msr & UART_MSR_DCD)\r\nPARSE_ERROR1;\r\nisdn_tty_reset_profile(m);\r\nisdn_tty_modem_reset_regs(info, 1);\r\nbreak;\r\n#ifdef DUMMY_HAYES_AT\r\ncase 'K':\r\np[0]++;\r\nisdn_getnum(p);\r\nbreak;\r\n#endif\r\ncase 'L':\r\np[0]++;\r\ni = 0;\r\nwhile (*p[0] && (strchr("0123456789,-*[]?;", *p[0])) &&\r\n(i < ISDN_LMSNLEN - 1))\r\nm->lmsn[i++] = *p[0]++;\r\nm->lmsn[i] = '\0';\r\nbreak;\r\ncase 'R':\r\np[0]++;\r\ni = isdn_getnum(p);\r\nswitch (i) {\r\ncase 0:\r\nm->mdmreg[REG_L2PROT] = ISDN_PROTO_L2_X75I;\r\nm->mdmreg[REG_SI2] = 0;\r\ninfo->xmit_size = m->mdmreg[REG_PSIZE] * 16;\r\nbreak;\r\ncase 9600:\r\nm->mdmreg[REG_L2PROT] = ISDN_PROTO_L2_V11096;\r\nm->mdmreg[REG_SI2] = 197;\r\ninfo->xmit_size = m->mdmreg[REG_PSIZE] * 16 / 10;\r\nbreak;\r\ncase 19200:\r\nm->mdmreg[REG_L2PROT] = ISDN_PROTO_L2_V11019;\r\nm->mdmreg[REG_SI2] = 199;\r\ninfo->xmit_size = m->mdmreg[REG_PSIZE] * 16 / 10;\r\nbreak;\r\ncase 38400:\r\nm->mdmreg[REG_L2PROT] = ISDN_PROTO_L2_V11038;\r\nm->mdmreg[REG_SI2] = 198;\r\ninfo->xmit_size = m->mdmreg[REG_PSIZE] * 16 / 10;\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nm->mdmreg[REG_T70] &= ~(BIT_T70 | BIT_T70_EXT);\r\nm->mdmreg[REG_SI1] |= 4;\r\nbreak;\r\ncase 'S':\r\np[0]++;\r\ni = isdn_getnum(p);\r\nif ((i > 0) && (i < 9))\r\nm->mdmreg[REG_WSIZE] = i;\r\nelse\r\nPARSE_ERROR1;\r\nbreak;\r\ncase 'V':\r\np[0]++;\r\nisdn_tty_at_cout("\r\n", info);\r\nfor (i = 0; i < ISDN_MODEM_NUMREG; i++) {\r\nsprintf(rb, "S%02d=%03d%s", i,\r\nm->mdmreg[i], ((i + 1) % 10) ? " " : "\r\n");\r\nisdn_tty_at_cout(rb, info);\r\n}\r\nsprintf(rb, "\r\nEAZ/MSN: %.50s\r\n",\r\nstrlen(m->msn) ? m->msn : "None");\r\nisdn_tty_at_cout(rb, info);\r\nif (strlen(m->lmsn)) {\r\nisdn_tty_at_cout("\r\nListen: ", info);\r\nisdn_tty_at_cout(m->lmsn, info);\r\nisdn_tty_at_cout("\r\n", info);\r\n}\r\nbreak;\r\ncase 'W':\r\np[0]++;\r\nswitch (*p[0]) {\r\ncase '0':\r\np[0]++;\r\nmodem_write_profile(m);\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nbreak;\r\ncase 'X':\r\np[0]++;\r\nswitch (isdn_getnum(p)) {\r\ncase 0:\r\nm->mdmreg[REG_T70] &= ~(BIT_T70 | BIT_T70_EXT);\r\ninfo->xmit_size = m->mdmreg[REG_PSIZE] * 16;\r\nbreak;\r\ncase 1:\r\nm->mdmreg[REG_T70] |= BIT_T70;\r\nm->mdmreg[REG_T70] &= ~BIT_T70_EXT;\r\nm->mdmreg[REG_L2PROT] = ISDN_PROTO_L2_X75I;\r\ninfo->xmit_size = 112;\r\nm->mdmreg[REG_SI1] = 4;\r\nm->mdmreg[REG_SI2] = 0;\r\nbreak;\r\ncase 2:\r\nm->mdmreg[REG_T70] |= (BIT_T70 | BIT_T70_EXT);\r\nm->mdmreg[REG_L2PROT] = ISDN_PROTO_L2_X75I;\r\ninfo->xmit_size = 112;\r\nm->mdmreg[REG_SI1] = 4;\r\nm->mdmreg[REG_SI2] = 0;\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nisdn_tty_check_ats(int mreg, int mval, modem_info *info, atemu *m)\r\n{\r\nswitch (mreg) {\r\ncase REG_L2PROT:\r\nif (mval > ISDN_PROTO_L2_MAX)\r\nreturn 1;\r\nbreak;\r\ncase REG_PSIZE:\r\nif ((mval * 16) > ISDN_SERIAL_XMIT_MAX)\r\nreturn 1;\r\n#ifdef CONFIG_ISDN_AUDIO\r\nif ((m->mdmreg[REG_SI1] & 1) && (mval > VBUFX))\r\nreturn 1;\r\n#endif\r\ninfo->xmit_size = mval * 16;\r\nswitch (m->mdmreg[REG_L2PROT]) {\r\ncase ISDN_PROTO_L2_V11096:\r\ncase ISDN_PROTO_L2_V11019:\r\ncase ISDN_PROTO_L2_V11038:\r\ninfo->xmit_size /= 10;\r\n}\r\nbreak;\r\ncase REG_SI1I:\r\ncase REG_PLAN:\r\ncase REG_SCREEN:\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nisdn_tty_cmd_ATS(char **p, modem_info *info)\r\n{\r\natemu *m = &info->emu;\r\nint bitpos;\r\nint mreg;\r\nint mval;\r\nint bval;\r\nmreg = isdn_getnum(p);\r\nif (mreg < 0 || mreg >= ISDN_MODEM_NUMREG)\r\nPARSE_ERROR1;\r\nswitch (*p[0]) {\r\ncase '=':\r\np[0]++;\r\nmval = isdn_getnum(p);\r\nif (mval < 0 || mval > 255)\r\nPARSE_ERROR1;\r\nif (isdn_tty_check_ats(mreg, mval, info, m))\r\nPARSE_ERROR1;\r\nm->mdmreg[mreg] = mval;\r\nbreak;\r\ncase '.':\r\np[0]++;\r\nbitpos = isdn_getnum(p);\r\nif ((bitpos < 0) || (bitpos > 7))\r\nPARSE_ERROR1;\r\nswitch (*p[0]) {\r\ncase '=':\r\np[0]++;\r\nbval = isdn_getnum(p);\r\nif (bval < 0 || bval > 1)\r\nPARSE_ERROR1;\r\nif (bval)\r\nmval = m->mdmreg[mreg] | (1 << bitpos);\r\nelse\r\nmval = m->mdmreg[mreg] & ~(1 << bitpos);\r\nif (isdn_tty_check_ats(mreg, mval, info, m))\r\nPARSE_ERROR1;\r\nm->mdmreg[mreg] = mval;\r\nbreak;\r\ncase '?':\r\np[0]++;\r\nisdn_tty_at_cout("\r\n", info);\r\nisdn_tty_at_cout((m->mdmreg[mreg] & (1 << bitpos)) ? "1" : "0",\r\ninfo);\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nbreak;\r\ncase '?':\r\np[0]++;\r\nisdn_tty_show_profile(mreg, info);\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic void\r\nisdn_tty_cmd_ATA(modem_info *info)\r\n{\r\natemu *m = &info->emu;\r\nisdn_ctrl cmd;\r\nint l2;\r\nif (info->msr & UART_MSR_RI) {\r\ninfo->last_dir = 0;\r\nstrcpy(info->last_num, dev->num[info->drv_index]);\r\nm->mdmreg[REG_RINGCNT] = 0;\r\ninfo->msr &= ~UART_MSR_RI;\r\nl2 = m->mdmreg[REG_L2PROT];\r\n#ifdef CONFIG_ISDN_AUDIO\r\nif ((m->mdmreg[REG_SI1] & m->mdmreg[REG_SI1I]) != m->mdmreg[REG_SI1]) {\r\nif (m->mdmreg[REG_SI1I] == 1) {\r\nif ((l2 != ISDN_PROTO_L2_MODEM) && (l2 != ISDN_PROTO_L2_FAX))\r\nl2 = ISDN_PROTO_L2_TRANS;\r\n} else\r\nl2 = ISDN_PROTO_L2_X75I;\r\n}\r\n#endif\r\ncmd.driver = info->isdn_driver;\r\ncmd.command = ISDN_CMD_SETL2;\r\ncmd.arg = info->isdn_channel + (l2 << 8);\r\ninfo->last_l2 = l2;\r\nisdn_command(&cmd);\r\ncmd.driver = info->isdn_driver;\r\ncmd.command = ISDN_CMD_SETL3;\r\ncmd.arg = info->isdn_channel + (m->mdmreg[REG_L3PROT] << 8);\r\n#ifdef CONFIG_ISDN_TTY_FAX\r\nif (l2 == ISDN_PROTO_L2_FAX) {\r\ncmd.parm.fax = info->fax;\r\ninfo->fax->direction = ISDN_TTY_FAX_CONN_IN;\r\n}\r\n#endif\r\nisdn_command(&cmd);\r\ncmd.driver = info->isdn_driver;\r\ncmd.arg = info->isdn_channel;\r\ncmd.command = ISDN_CMD_ACCEPTD;\r\ninfo->dialing = 16;\r\ninfo->emu.carrierwait = 0;\r\nisdn_command(&cmd);\r\nisdn_timer_ctrl(ISDN_TIMER_CARRIER, 1);\r\n} else\r\nisdn_tty_modem_result(RESULT_NO_ANSWER, info);\r\n}\r\nstatic int\r\nisdn_tty_cmd_PLUSF(char **p, modem_info *info)\r\n{\r\natemu *m = &info->emu;\r\nchar rs[20];\r\nif (!strncmp(p[0], "CLASS", 5)) {\r\np[0] += 5;\r\nswitch (*p[0]) {\r\ncase '?':\r\np[0]++;\r\nsprintf(rs, "\r\n%d",\r\n(m->mdmreg[REG_SI1] & 1) ? 8 : 0);\r\n#ifdef CONFIG_ISDN_TTY_FAX\r\nif (TTY_IS_FCLASS2(info))\r\nsprintf(rs, "\r\n2");\r\nelse if (TTY_IS_FCLASS1(info))\r\nsprintf(rs, "\r\n1");\r\n#endif\r\nisdn_tty_at_cout(rs, info);\r\nbreak;\r\ncase '=':\r\np[0]++;\r\nswitch (*p[0]) {\r\ncase '0':\r\np[0]++;\r\nm->mdmreg[REG_L2PROT] = ISDN_PROTO_L2_X75I;\r\nm->mdmreg[REG_L3PROT] = ISDN_PROTO_L3_TRANS;\r\nm->mdmreg[REG_SI1] = 4;\r\ninfo->xmit_size =\r\nm->mdmreg[REG_PSIZE] * 16;\r\nbreak;\r\n#ifdef CONFIG_ISDN_TTY_FAX\r\ncase '1':\r\np[0]++;\r\nif (!(dev->global_features &\r\nISDN_FEATURE_L3_FCLASS1))\r\nPARSE_ERROR1;\r\nm->mdmreg[REG_SI1] = 1;\r\nm->mdmreg[REG_L2PROT] = ISDN_PROTO_L2_FAX;\r\nm->mdmreg[REG_L3PROT] = ISDN_PROTO_L3_FCLASS1;\r\ninfo->xmit_size =\r\nm->mdmreg[REG_PSIZE] * 16;\r\nbreak;\r\ncase '2':\r\np[0]++;\r\nif (!(dev->global_features &\r\nISDN_FEATURE_L3_FCLASS2))\r\nPARSE_ERROR1;\r\nm->mdmreg[REG_SI1] = 1;\r\nm->mdmreg[REG_L2PROT] = ISDN_PROTO_L2_FAX;\r\nm->mdmreg[REG_L3PROT] = ISDN_PROTO_L3_FCLASS2;\r\ninfo->xmit_size =\r\nm->mdmreg[REG_PSIZE] * 16;\r\nbreak;\r\n#endif\r\ncase '8':\r\np[0]++;\r\nm->mdmreg[REG_L2PROT] = ISDN_PROTO_L2_X75I;\r\nm->mdmreg[REG_L3PROT] = ISDN_PROTO_L3_TRANS;\r\nm->mdmreg[REG_SI1] = 5;\r\ninfo->xmit_size = VBUF;\r\nbreak;\r\ncase '?':\r\np[0]++;\r\nstrcpy(rs, "\r\n0,");\r\n#ifdef CONFIG_ISDN_TTY_FAX\r\nif (dev->global_features &\r\nISDN_FEATURE_L3_FCLASS1)\r\nstrcat(rs, "1,");\r\nif (dev->global_features &\r\nISDN_FEATURE_L3_FCLASS2)\r\nstrcat(rs, "2,");\r\n#endif\r\nstrcat(rs, "8");\r\nisdn_tty_at_cout(rs, info);\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nreturn 0;\r\n}\r\n#ifdef CONFIG_ISDN_TTY_FAX\r\nreturn (isdn_tty_cmd_PLUSF_FAX(p, info));\r\n#else\r\nPARSE_ERROR1;\r\n#endif\r\n}\r\nstatic int\r\nisdn_tty_cmd_PLUSV(char **p, modem_info *info)\r\n{\r\natemu *m = &info->emu;\r\nisdn_ctrl cmd;\r\nstatic char *vcmd[] =\r\n{"NH", "IP", "LS", "RX", "SD", "SM", "TX", "DD", NULL};\r\nint i;\r\nint par1;\r\nint par2;\r\nchar rs[20];\r\ni = 0;\r\nwhile (vcmd[i]) {\r\nif (!strncmp(vcmd[i], p[0], 2)) {\r\np[0] += 2;\r\nbreak;\r\n}\r\ni++;\r\n}\r\nswitch (i) {\r\ncase 0:\r\nswitch (*p[0]) {\r\ncase '?':\r\np[0]++;\r\nisdn_tty_at_cout("\r\n1", info);\r\nbreak;\r\ncase '=':\r\np[0]++;\r\nswitch (*p[0]) {\r\ncase '1':\r\np[0]++;\r\nbreak;\r\ncase '?':\r\np[0]++;\r\nisdn_tty_at_cout("\r\n1", info);\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nbreak;\r\ncase 1:\r\nisdn_tty_modem_reset_vpar(m);\r\nbreak;\r\ncase 2:\r\nswitch (*p[0]) {\r\ncase '?':\r\np[0]++;\r\nsprintf(rs, "\r\n%d", m->vpar[0]);\r\nisdn_tty_at_cout(rs, info);\r\nbreak;\r\ncase '=':\r\np[0]++;\r\nswitch (*p[0]) {\r\ncase '0':\r\np[0]++;\r\nm->vpar[0] = 0;\r\nbreak;\r\ncase '2':\r\np[0]++;\r\nm->vpar[0] = 2;\r\nbreak;\r\ncase '?':\r\np[0]++;\r\nisdn_tty_at_cout("\r\n0,2", info);\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nbreak;\r\ncase 3:\r\nif (!m->vpar[0])\r\nPARSE_ERROR1;\r\nif (info->online != 1) {\r\nisdn_tty_modem_result(RESULT_NO_ANSWER, info);\r\nreturn 1;\r\n}\r\ninfo->dtmf_state = isdn_audio_dtmf_init(info->dtmf_state);\r\nif (!info->dtmf_state) {\r\nprintk(KERN_WARNING "isdn_tty: Couldn't malloc dtmf state\n");\r\nPARSE_ERROR1;\r\n}\r\ninfo->silence_state = isdn_audio_silence_init(info->silence_state);\r\nif (!info->silence_state) {\r\nprintk(KERN_WARNING "isdn_tty: Couldn't malloc silence state\n");\r\nPARSE_ERROR1;\r\n}\r\nif (m->vpar[3] < 5) {\r\ninfo->adpcmr = isdn_audio_adpcm_init(info->adpcmr, m->vpar[3]);\r\nif (!info->adpcmr) {\r\nprintk(KERN_WARNING "isdn_tty: Couldn't malloc adpcm state\n");\r\nPARSE_ERROR1;\r\n}\r\n}\r\n#ifdef ISDN_DEBUG_AT\r\nprintk(KERN_DEBUG "AT: +VRX\n");\r\n#endif\r\ninfo->vonline |= 1;\r\nisdn_tty_modem_result(RESULT_CONNECT, info);\r\nreturn 0;\r\nbreak;\r\ncase 4:\r\nswitch (*p[0]) {\r\ncase '?':\r\np[0]++;\r\nsprintf(rs, "\r\n<%d>,<%d>",\r\nm->vpar[1],\r\nm->vpar[2]);\r\nisdn_tty_at_cout(rs, info);\r\nbreak;\r\ncase '=':\r\np[0]++;\r\nif ((*p[0] >= '0') && (*p[0] <= '9')) {\r\npar1 = isdn_getnum(p);\r\nif ((par1 < 0) || (par1 > 31))\r\nPARSE_ERROR1;\r\nif (*p[0] != ',')\r\nPARSE_ERROR1;\r\np[0]++;\r\npar2 = isdn_getnum(p);\r\nif ((par2 < 0) || (par2 > 255))\r\nPARSE_ERROR1;\r\nm->vpar[1] = par1;\r\nm->vpar[2] = par2;\r\nbreak;\r\n} else\r\nif (*p[0] == '?') {\r\np[0]++;\r\nisdn_tty_at_cout("\r\n<0-31>,<0-255>",\r\ninfo);\r\nbreak;\r\n} else\r\nPARSE_ERROR1;\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nbreak;\r\ncase 5:\r\nswitch (*p[0]) {\r\ncase '?':\r\np[0]++;\r\nsprintf(rs, "\r\n<%d>,<%d><8000>",\r\nm->vpar[3],\r\nm->vpar[1]);\r\nisdn_tty_at_cout(rs, info);\r\nbreak;\r\ncase '=':\r\np[0]++;\r\nswitch (*p[0]) {\r\ncase '2':\r\ncase '3':\r\ncase '4':\r\ncase '5':\r\ncase '6':\r\npar1 = isdn_getnum(p);\r\nif ((par1 < 2) || (par1 > 6))\r\nPARSE_ERROR1;\r\nm->vpar[3] = par1;\r\nbreak;\r\ncase '?':\r\np[0]++;\r\nisdn_tty_at_cout("\r\n2;ADPCM;2;0;(8000)\r\n",\r\ninfo);\r\nisdn_tty_at_cout("3;ADPCM;3;0;(8000)\r\n",\r\ninfo);\r\nisdn_tty_at_cout("4;ADPCM;4;0;(8000)\r\n",\r\ninfo);\r\nisdn_tty_at_cout("5;ALAW;8;0;(8000)\r\n",\r\ninfo);\r\nisdn_tty_at_cout("6;ULAW;8;0;(8000)\r\n",\r\ninfo);\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nbreak;\r\ncase 6:\r\nif (!m->vpar[0])\r\nPARSE_ERROR1;\r\nif (info->online != 1) {\r\nisdn_tty_modem_result(RESULT_NO_ANSWER, info);\r\nreturn 1;\r\n}\r\ninfo->dtmf_state = isdn_audio_dtmf_init(info->dtmf_state);\r\nif (!info->dtmf_state) {\r\nprintk(KERN_WARNING "isdn_tty: Couldn't malloc dtmf state\n");\r\nPARSE_ERROR1;\r\n}\r\nif (m->vpar[3] < 5) {\r\ninfo->adpcms = isdn_audio_adpcm_init(info->adpcms, m->vpar[3]);\r\nif (!info->adpcms) {\r\nprintk(KERN_WARNING "isdn_tty: Couldn't malloc adpcm state\n");\r\nPARSE_ERROR1;\r\n}\r\n}\r\n#ifdef ISDN_DEBUG_AT\r\nprintk(KERN_DEBUG "AT: +VTX\n");\r\n#endif\r\nm->lastDLE = 0;\r\ninfo->vonline |= 2;\r\nisdn_tty_modem_result(RESULT_CONNECT, info);\r\nreturn 0;\r\nbreak;\r\ncase 7:\r\nswitch (*p[0]) {\r\ncase '?':\r\np[0]++;\r\nsprintf(rs, "\r\n<%d>,<%d>",\r\nm->vpar[4],\r\nm->vpar[5]);\r\nisdn_tty_at_cout(rs, info);\r\nbreak;\r\ncase '=':\r\np[0]++;\r\nif ((*p[0] >= '0') && (*p[0] <= '9')) {\r\nif (info->online != 1)\r\nPARSE_ERROR1;\r\npar1 = isdn_getnum(p);\r\nif ((par1 < 0) || (par1 > 15))\r\nPARSE_ERROR1;\r\nif (*p[0] != ',')\r\nPARSE_ERROR1;\r\np[0]++;\r\npar2 = isdn_getnum(p);\r\nif ((par2 < 0) || (par2 > 255))\r\nPARSE_ERROR1;\r\nm->vpar[4] = par1;\r\nm->vpar[5] = par2;\r\ncmd.driver = info->isdn_driver;\r\ncmd.command = ISDN_CMD_AUDIO;\r\ncmd.arg = info->isdn_channel + (ISDN_AUDIO_SETDD << 8);\r\ncmd.parm.num[0] = par1;\r\ncmd.parm.num[1] = par2;\r\nisdn_command(&cmd);\r\nbreak;\r\n} else\r\nif (*p[0] == '?') {\r\np[0]++;\r\nisdn_tty_at_cout("\r\n<0-15>,<0-255>",\r\ninfo);\r\nbreak;\r\n} else\r\nPARSE_ERROR1;\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nreturn 0;\r\n}\r\nstatic void\r\nisdn_tty_parse_at(modem_info *info)\r\n{\r\natemu *m = &info->emu;\r\nchar *p;\r\nchar ds[ISDN_MSNLEN];\r\n#ifdef ISDN_DEBUG_AT\r\nprintk(KERN_DEBUG "AT: '%s'\n", m->mdmcmd);\r\n#endif\r\nfor (p = &m->mdmcmd[2]; *p;) {\r\nswitch (*p) {\r\ncase ' ':\r\np++;\r\nbreak;\r\ncase 'A':\r\np++;\r\nisdn_tty_cmd_ATA(info);\r\nreturn;\r\nbreak;\r\ncase 'D':\r\nif (info->msr & UART_MSR_DCD)\r\nPARSE_ERROR;\r\nif (info->msr & UART_MSR_RI) {\r\nisdn_tty_modem_result(RESULT_NO_CARRIER, info);\r\nreturn;\r\n}\r\nisdn_tty_getdial(++p, ds, sizeof ds);\r\np += strlen(p);\r\nif (!strlen(m->msn))\r\nisdn_tty_modem_result(RESULT_NO_MSN_EAZ, info);\r\nelse if (strlen(ds))\r\nisdn_tty_dial(ds, info, m);\r\nelse\r\nPARSE_ERROR;\r\nreturn;\r\ncase 'E':\r\np++;\r\nswitch (isdn_getnum(&p)) {\r\ncase 0:\r\nm->mdmreg[REG_ECHO] &= ~BIT_ECHO;\r\nbreak;\r\ncase 1:\r\nm->mdmreg[REG_ECHO] |= BIT_ECHO;\r\nbreak;\r\ndefault:\r\nPARSE_ERROR;\r\n}\r\nbreak;\r\ncase 'H':\r\np++;\r\nswitch (*p) {\r\ncase '0':\r\np++;\r\nisdn_tty_on_hook(info);\r\nbreak;\r\ncase '1':\r\np++;\r\nisdn_tty_off_hook();\r\nbreak;\r\ndefault:\r\nisdn_tty_on_hook(info);\r\nbreak;\r\n}\r\nbreak;\r\ncase 'I':\r\np++;\r\nisdn_tty_at_cout("\r\nLinux ISDN", info);\r\nswitch (*p) {\r\ncase '0':\r\ncase '1':\r\np++;\r\nbreak;\r\ncase '2':\r\np++;\r\nisdn_tty_report(info);\r\nbreak;\r\ncase '3':\r\np++;\r\nsnprintf(ds, sizeof(ds), "\r\n%d", info->emu.charge);\r\nisdn_tty_at_cout(ds, info);\r\nbreak;\r\ndefault:;\r\n}\r\nbreak;\r\n#ifdef DUMMY_HAYES_AT\r\ncase 'L':\r\ncase 'M':\r\np++;\r\nisdn_getnum(&p);\r\nbreak;\r\n#endif\r\ncase 'O':\r\np++;\r\nif (info->msr & UART_MSR_DCD)\r\nisdn_tty_modem_result((m->mdmreg[REG_L2PROT] == ISDN_PROTO_L2_MODEM) ? RESULT_CONNECT : RESULT_CONNECT64000, info);\r\nelse\r\nisdn_tty_modem_result(RESULT_NO_CARRIER, info);\r\nreturn;\r\ncase 'Q':\r\np++;\r\nswitch (isdn_getnum(&p)) {\r\ncase 0:\r\nm->mdmreg[REG_RESP] |= BIT_RESP;\r\nbreak;\r\ncase 1:\r\nm->mdmreg[REG_RESP] &= ~BIT_RESP;\r\nbreak;\r\ndefault:\r\nPARSE_ERROR;\r\n}\r\nbreak;\r\ncase 'S':\r\np++;\r\nif (isdn_tty_cmd_ATS(&p, info))\r\nreturn;\r\nbreak;\r\ncase 'V':\r\np++;\r\nswitch (isdn_getnum(&p)) {\r\ncase 0:\r\nm->mdmreg[REG_RESP] |= BIT_RESPNUM;\r\nbreak;\r\ncase 1:\r\nm->mdmreg[REG_RESP] &= ~BIT_RESPNUM;\r\nbreak;\r\ndefault:\r\nPARSE_ERROR;\r\n}\r\nbreak;\r\ncase 'Z':\r\np++;\r\nif (info->msr & UART_MSR_DCD) {\r\ninfo->online = 0;\r\nisdn_tty_on_hook(info);\r\n}\r\nisdn_tty_modem_reset_regs(info, 1);\r\nbreak;\r\ncase '+':\r\np++;\r\nswitch (*p) {\r\n#ifdef CONFIG_ISDN_AUDIO\r\ncase 'F':\r\np++;\r\nif (isdn_tty_cmd_PLUSF(&p, info))\r\nreturn;\r\nbreak;\r\ncase 'V':\r\nif ((!(m->mdmreg[REG_SI1] & 1)) ||\r\n(m->mdmreg[REG_L2PROT] == ISDN_PROTO_L2_MODEM))\r\nPARSE_ERROR;\r\np++;\r\nif (isdn_tty_cmd_PLUSV(&p, info))\r\nreturn;\r\nbreak;\r\n#endif\r\ncase 'S':\r\np++;\r\nisdn_tty_get_msnstr(ds, &p);\r\nisdn_tty_suspend(ds, info, m);\r\nbreak;\r\ncase 'R':\r\np++;\r\nisdn_tty_get_msnstr(ds, &p);\r\nisdn_tty_resume(ds, info, m);\r\nbreak;\r\ncase 'M':\r\np++;\r\nisdn_tty_send_msg(info, m, p);\r\nbreak;\r\ndefault:\r\nPARSE_ERROR;\r\n}\r\nbreak;\r\ncase '&':\r\np++;\r\nif (isdn_tty_cmd_ATand(&p, info))\r\nreturn;\r\nbreak;\r\ndefault:\r\nPARSE_ERROR;\r\n}\r\n}\r\n#ifdef CONFIG_ISDN_AUDIO\r\nif (!info->vonline)\r\n#endif\r\nisdn_tty_modem_result(RESULT_OK, info);\r\n}\r\nstatic int\r\nisdn_tty_edit_at(const char *p, int count, modem_info *info)\r\n{\r\natemu *m = &info->emu;\r\nint total = 0;\r\nu_char c;\r\nchar eb[2];\r\nint cnt;\r\nfor (cnt = count; cnt > 0; p++, cnt--) {\r\nc = *p;\r\ntotal++;\r\nif (c == m->mdmreg[REG_CR] || c == m->mdmreg[REG_LF]) {\r\nm->mdmcmd[m->mdmcmdl] = 0;\r\nif (m->mdmreg[REG_ECHO] & BIT_ECHO) {\r\neb[0] = c;\r\neb[1] = 0;\r\nisdn_tty_at_cout(eb, info);\r\n}\r\nif ((m->mdmcmdl >= 2) && (!(strncmp(m->mdmcmd, "AT", 2))))\r\nisdn_tty_parse_at(info);\r\nm->mdmcmdl = 0;\r\ncontinue;\r\n}\r\nif (c == m->mdmreg[REG_BS] && m->mdmreg[REG_BS] < 128) {\r\nif ((m->mdmcmdl > 2) || (!m->mdmcmdl)) {\r\nif (m->mdmcmdl)\r\nm->mdmcmdl--;\r\nif (m->mdmreg[REG_ECHO] & BIT_ECHO)\r\nisdn_tty_at_cout("\b", info);\r\n}\r\ncontinue;\r\n}\r\nif (cmdchar(c)) {\r\nif (m->mdmreg[REG_ECHO] & BIT_ECHO) {\r\neb[0] = c;\r\neb[1] = 0;\r\nisdn_tty_at_cout(eb, info);\r\n}\r\nif (m->mdmcmdl < 255) {\r\nc = my_toupper(c);\r\nswitch (m->mdmcmdl) {\r\ncase 1:\r\nif (c == 'T') {\r\nm->mdmcmd[m->mdmcmdl] = c;\r\nm->mdmcmd[++m->mdmcmdl] = 0;\r\nbreak;\r\n} else\r\nm->mdmcmdl = 0;\r\ncase 0:\r\nif (c == 'A') {\r\nm->mdmcmd[m->mdmcmdl] = c;\r\nm->mdmcmd[++m->mdmcmdl] = 0;\r\n}\r\nbreak;\r\ndefault:\r\nm->mdmcmd[m->mdmcmdl] = c;\r\nm->mdmcmd[++m->mdmcmdl] = 0;\r\n}\r\n}\r\n}\r\n}\r\nreturn total;\r\n}\r\nvoid\r\nisdn_tty_modem_escape(void)\r\n{\r\nint ton = 0;\r\nint i;\r\nint midx;\r\nfor (i = 0; i < ISDN_MAX_CHANNELS; i++)\r\nif (USG_MODEM(dev->usage[i]) && (midx = dev->m_idx[i]) >= 0) {\r\nmodem_info *info = &dev->mdm.info[midx];\r\nif (info->online) {\r\nton = 1;\r\nif ((info->emu.pluscount == 3) &&\r\ntime_after(jiffies,\r\ninfo->emu.lastplus + PLUSWAIT2)) {\r\ninfo->emu.pluscount = 0;\r\ninfo->online = 0;\r\nisdn_tty_modem_result(RESULT_OK, info);\r\n}\r\n}\r\n}\r\nisdn_timer_ctrl(ISDN_TIMER_MODEMPLUS, ton);\r\n}\r\nvoid\r\nisdn_tty_modem_ring(void)\r\n{\r\nint ton = 0;\r\nint i;\r\nfor (i = 0; i < ISDN_MAX_CHANNELS; i++) {\r\nmodem_info *info = &dev->mdm.info[i];\r\nif (info->msr & UART_MSR_RI) {\r\nton = 1;\r\nisdn_tty_modem_result(RESULT_RING, info);\r\n}\r\n}\r\nisdn_timer_ctrl(ISDN_TIMER_MODEMRING, ton);\r\n}\r\nvoid\r\nisdn_tty_modem_xmit(void)\r\n{\r\nint ton = 1;\r\nint i;\r\nfor (i = 0; i < ISDN_MAX_CHANNELS; i++) {\r\nmodem_info *info = &dev->mdm.info[i];\r\nif (info->online) {\r\nton = 1;\r\nisdn_tty_senddown(info);\r\nisdn_tty_tint(info);\r\n}\r\n}\r\nisdn_timer_ctrl(ISDN_TIMER_MODEMXMIT, ton);\r\n}\r\nvoid\r\nisdn_tty_carrier_timeout(void)\r\n{\r\nint ton = 0;\r\nint i;\r\nfor (i = 0; i < ISDN_MAX_CHANNELS; i++) {\r\nmodem_info *info = &dev->mdm.info[i];\r\nif (!info->dialing)\r\ncontinue;\r\nif (info->emu.carrierwait++ > info->emu.mdmreg[REG_WAITC]) {\r\ninfo->dialing = 0;\r\nisdn_tty_modem_result(RESULT_NO_CARRIER, info);\r\nisdn_tty_modem_hup(info, 1);\r\n} else\r\nton = 1;\r\n}\r\nisdn_timer_ctrl(ISDN_TIMER_CARRIER, ton);\r\n}

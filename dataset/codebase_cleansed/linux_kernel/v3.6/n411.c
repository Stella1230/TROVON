static void n411_set_ctl(struct hecubafb_par *par, unsigned char bit, unsigned\r\nchar state)\r\n{\r\nswitch (bit) {\r\ncase HCB_CD_BIT:\r\nif (state)\r\nctl &= ~(HCB_CD_BIT);\r\nelse\r\nctl |= HCB_CD_BIT;\r\nbreak;\r\ncase HCB_DS_BIT:\r\nif (state)\r\nctl &= ~(HCB_DS_BIT);\r\nelse\r\nctl |= HCB_DS_BIT;\r\nbreak;\r\n}\r\noutb(ctl, cio_addr);\r\n}\r\nstatic unsigned char n411_get_ctl(struct hecubafb_par *par)\r\n{\r\nreturn inb(c2io_addr);\r\n}\r\nstatic void n411_set_data(struct hecubafb_par *par, unsigned char value)\r\n{\r\noutb(value, dio_addr);\r\n}\r\nstatic void n411_wait_for_ack(struct hecubafb_par *par, int clear)\r\n{\r\nint timeout;\r\nunsigned char tmp;\r\ntimeout = 500;\r\ndo {\r\ntmp = n411_get_ctl(par);\r\nif ((tmp & HCB_ACK_BIT) && (!clear))\r\nreturn;\r\nelse if (!(tmp & HCB_ACK_BIT) && (clear))\r\nreturn;\r\nudelay(1);\r\n} while (timeout--);\r\nprintk(KERN_ERR "timed out waiting for ack\n");\r\n}\r\nstatic int n411_init_control(struct hecubafb_par *par)\r\n{\r\nunsigned char tmp;\r\nctl = HCB_WUP_BIT | HCB_RW_BIT | HCB_CD_BIT ;\r\nn411_set_ctl(par, HCB_DS_BIT, 1);\r\ntmp = n411_get_ctl(par);\r\nif (tmp & HCB_ACK_BIT) {\r\nprintk(KERN_ERR "Fail because ACK is already low\n");\r\nreturn -ENXIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int n411_init_board(struct hecubafb_par *par)\r\n{\r\nint retval;\r\nretval = n411_init_control(par);\r\nif (retval)\r\nreturn retval;\r\npar->send_command(par, APOLLO_INIT_DISPLAY);\r\npar->send_data(par, 0x81);\r\nudelay(1000);\r\nif (!nosplash) {\r\npar->send_command(par, APOLLO_ERASE_DISPLAY);\r\npar->send_data(par, splashval);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init n411_init(void)\r\n{\r\nint ret;\r\nif (!dio_addr || !cio_addr || !c2io_addr) {\r\nprintk(KERN_WARNING "no IO addresses supplied\n");\r\nreturn -EINVAL;\r\n}\r\nrequest_module("hecubafb");\r\nn411_device = platform_device_alloc("hecubafb", -1);\r\nif (!n411_device)\r\nreturn -ENOMEM;\r\nplatform_device_add_data(n411_device, &n411_board, sizeof(n411_board));\r\nret = platform_device_add(n411_device);\r\nif (ret)\r\nplatform_device_put(n411_device);\r\nreturn ret;\r\n}\r\nstatic void __exit n411_exit(void)\r\n{\r\nplatform_device_unregister(n411_device);\r\n}

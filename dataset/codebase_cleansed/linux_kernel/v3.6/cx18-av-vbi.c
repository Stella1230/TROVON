static int odd_parity(u8 c)\r\n{\r\nc ^= (c >> 4);\r\nc ^= (c >> 2);\r\nc ^= (c >> 1);\r\nreturn c & 1;\r\n}\r\nstatic int decode_vps(u8 *dst, u8 *p)\r\n{\r\nstatic const u8 biphase_tbl[] = {\r\n0xf0, 0x78, 0x70, 0xf0, 0xb4, 0x3c, 0x34, 0xb4,\r\n0xb0, 0x38, 0x30, 0xb0, 0xf0, 0x78, 0x70, 0xf0,\r\n0xd2, 0x5a, 0x52, 0xd2, 0x96, 0x1e, 0x16, 0x96,\r\n0x92, 0x1a, 0x12, 0x92, 0xd2, 0x5a, 0x52, 0xd2,\r\n0xd0, 0x58, 0x50, 0xd0, 0x94, 0x1c, 0x14, 0x94,\r\n0x90, 0x18, 0x10, 0x90, 0xd0, 0x58, 0x50, 0xd0,\r\n0xf0, 0x78, 0x70, 0xf0, 0xb4, 0x3c, 0x34, 0xb4,\r\n0xb0, 0x38, 0x30, 0xb0, 0xf0, 0x78, 0x70, 0xf0,\r\n0xe1, 0x69, 0x61, 0xe1, 0xa5, 0x2d, 0x25, 0xa5,\r\n0xa1, 0x29, 0x21, 0xa1, 0xe1, 0x69, 0x61, 0xe1,\r\n0xc3, 0x4b, 0x43, 0xc3, 0x87, 0x0f, 0x07, 0x87,\r\n0x83, 0x0b, 0x03, 0x83, 0xc3, 0x4b, 0x43, 0xc3,\r\n0xc1, 0x49, 0x41, 0xc1, 0x85, 0x0d, 0x05, 0x85,\r\n0x81, 0x09, 0x01, 0x81, 0xc1, 0x49, 0x41, 0xc1,\r\n0xe1, 0x69, 0x61, 0xe1, 0xa5, 0x2d, 0x25, 0xa5,\r\n0xa1, 0x29, 0x21, 0xa1, 0xe1, 0x69, 0x61, 0xe1,\r\n0xe0, 0x68, 0x60, 0xe0, 0xa4, 0x2c, 0x24, 0xa4,\r\n0xa0, 0x28, 0x20, 0xa0, 0xe0, 0x68, 0x60, 0xe0,\r\n0xc2, 0x4a, 0x42, 0xc2, 0x86, 0x0e, 0x06, 0x86,\r\n0x82, 0x0a, 0x02, 0x82, 0xc2, 0x4a, 0x42, 0xc2,\r\n0xc0, 0x48, 0x40, 0xc0, 0x84, 0x0c, 0x04, 0x84,\r\n0x80, 0x08, 0x00, 0x80, 0xc0, 0x48, 0x40, 0xc0,\r\n0xe0, 0x68, 0x60, 0xe0, 0xa4, 0x2c, 0x24, 0xa4,\r\n0xa0, 0x28, 0x20, 0xa0, 0xe0, 0x68, 0x60, 0xe0,\r\n0xf0, 0x78, 0x70, 0xf0, 0xb4, 0x3c, 0x34, 0xb4,\r\n0xb0, 0x38, 0x30, 0xb0, 0xf0, 0x78, 0x70, 0xf0,\r\n0xd2, 0x5a, 0x52, 0xd2, 0x96, 0x1e, 0x16, 0x96,\r\n0x92, 0x1a, 0x12, 0x92, 0xd2, 0x5a, 0x52, 0xd2,\r\n0xd0, 0x58, 0x50, 0xd0, 0x94, 0x1c, 0x14, 0x94,\r\n0x90, 0x18, 0x10, 0x90, 0xd0, 0x58, 0x50, 0xd0,\r\n0xf0, 0x78, 0x70, 0xf0, 0xb4, 0x3c, 0x34, 0xb4,\r\n0xb0, 0x38, 0x30, 0xb0, 0xf0, 0x78, 0x70, 0xf0,\r\n};\r\nu8 c, err = 0;\r\nint i;\r\nfor (i = 0; i < 2 * 13; i += 2) {\r\nerr |= biphase_tbl[p[i]] | biphase_tbl[p[i + 1]];\r\nc = (biphase_tbl[p[i + 1]] & 0xf) |\r\n((biphase_tbl[p[i]] & 0xf) << 4);\r\ndst[i / 2] = c;\r\n}\r\nreturn err & 0xf0;\r\n}\r\nint cx18_av_g_sliced_fmt(struct v4l2_subdev *sd, struct v4l2_sliced_vbi_format *svbi)\r\n{\r\nstruct cx18 *cx = v4l2_get_subdevdata(sd);\r\nstruct cx18_av_state *state = &cx->av_state;\r\nstatic const u16 lcr2vbi[] = {\r\n0, V4L2_SLICED_TELETEXT_B, 0,\r\n0, V4L2_SLICED_WSS_625, 0,\r\nV4L2_SLICED_CAPTION_525,\r\n0, 0, V4L2_SLICED_VPS, 0, 0,\r\n0, 0, 0, 0\r\n};\r\nint is_pal = !(state->std & V4L2_STD_525_60);\r\nint i;\r\nmemset(svbi, 0, sizeof(*svbi));\r\nif ((cx18_av_read(cx, 0x404) & 0x10) == 0)\r\nreturn 0;\r\nif (is_pal) {\r\nfor (i = 7; i <= 23; i++) {\r\nu8 v = cx18_av_read(cx, 0x424 + i - 7);\r\nsvbi->service_lines[0][i] = lcr2vbi[v >> 4];\r\nsvbi->service_lines[1][i] = lcr2vbi[v & 0xf];\r\nsvbi->service_set |= svbi->service_lines[0][i] |\r\nsvbi->service_lines[1][i];\r\n}\r\n} else {\r\nfor (i = 10; i <= 21; i++) {\r\nu8 v = cx18_av_read(cx, 0x424 + i - 10);\r\nsvbi->service_lines[0][i] = lcr2vbi[v >> 4];\r\nsvbi->service_lines[1][i] = lcr2vbi[v & 0xf];\r\nsvbi->service_set |= svbi->service_lines[0][i] |\r\nsvbi->service_lines[1][i];\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint cx18_av_s_raw_fmt(struct v4l2_subdev *sd, struct v4l2_vbi_format *fmt)\r\n{\r\nstruct cx18 *cx = v4l2_get_subdevdata(sd);\r\nstruct cx18_av_state *state = &cx->av_state;\r\ncx18_av_std_setup(cx);\r\ncx18_av_write(cx, 0x47f, state->slicer_line_delay);\r\ncx18_av_write(cx, 0x404, 0x2e);\r\nreturn 0;\r\n}\r\nint cx18_av_s_sliced_fmt(struct v4l2_subdev *sd, struct v4l2_sliced_vbi_format *svbi)\r\n{\r\nstruct cx18 *cx = v4l2_get_subdevdata(sd);\r\nstruct cx18_av_state *state = &cx->av_state;\r\nint is_pal = !(state->std & V4L2_STD_525_60);\r\nint i, x;\r\nu8 lcr[24];\r\nfor (x = 0; x <= 23; x++)\r\nlcr[x] = 0x00;\r\ncx18_av_std_setup(cx);\r\ncx18_av_write(cx, 0x404, 0x32);\r\ncx18_av_write(cx, 0x406, 0x13);\r\ncx18_av_write(cx, 0x47f, state->slicer_line_delay);\r\nif (is_pal) {\r\nfor (i = 0; i <= 6; i++)\r\nsvbi->service_lines[0][i] =\r\nsvbi->service_lines[1][i] = 0;\r\n} else {\r\nfor (i = 0; i <= 9; i++)\r\nsvbi->service_lines[0][i] =\r\nsvbi->service_lines[1][i] = 0;\r\nfor (i = 22; i <= 23; i++)\r\nsvbi->service_lines[0][i] =\r\nsvbi->service_lines[1][i] = 0;\r\n}\r\nfor (i = 7; i <= 23; i++) {\r\nfor (x = 0; x <= 1; x++) {\r\nswitch (svbi->service_lines[1-x][i]) {\r\ncase V4L2_SLICED_TELETEXT_B:\r\nlcr[i] |= 1 << (4 * x);\r\nbreak;\r\ncase V4L2_SLICED_WSS_625:\r\nlcr[i] |= 4 << (4 * x);\r\nbreak;\r\ncase V4L2_SLICED_CAPTION_525:\r\nlcr[i] |= 6 << (4 * x);\r\nbreak;\r\ncase V4L2_SLICED_VPS:\r\nlcr[i] |= 9 << (4 * x);\r\nbreak;\r\n}\r\n}\r\n}\r\nif (is_pal) {\r\nfor (x = 1, i = 0x424; i <= 0x434; i++, x++)\r\ncx18_av_write(cx, i, lcr[6 + x]);\r\n} else {\r\nfor (x = 1, i = 0x424; i <= 0x430; i++, x++)\r\ncx18_av_write(cx, i, lcr[9 + x]);\r\nfor (i = 0x431; i <= 0x434; i++)\r\ncx18_av_write(cx, i, 0);\r\n}\r\ncx18_av_write(cx, 0x43c, 0x16);\r\ncx18_av_write(cx, 0x474, is_pal ? 38 : 26);\r\nreturn 0;\r\n}\r\nint cx18_av_decode_vbi_line(struct v4l2_subdev *sd,\r\nstruct v4l2_decode_vbi_line *vbi)\r\n{\r\nstruct cx18 *cx = v4l2_get_subdevdata(sd);\r\nstruct cx18_av_state *state = &cx->av_state;\r\nstruct vbi_anc_data *anc = (struct vbi_anc_data *)vbi->p;\r\nu8 *p;\r\nint did, sdid, l, err = 0;\r\nif (anc->preamble[0] ||\r\nanc->preamble[1] != 0xff || anc->preamble[2] != 0xff ||\r\n(anc->did != sliced_vbi_did[0] &&\r\nanc->did != sliced_vbi_did[1])) {\r\nvbi->line = vbi->type = 0;\r\nreturn 0;\r\n}\r\ndid = anc->did;\r\nsdid = anc->sdid & 0xf;\r\nl = anc->idid[0] & 0x3f;\r\nl += state->slicer_line_offset;\r\np = anc->payload;\r\nswitch (sdid) {\r\ncase 1:\r\nsdid = V4L2_SLICED_TELETEXT_B;\r\nbreak;\r\ncase 4:\r\nsdid = V4L2_SLICED_WSS_625;\r\nbreak;\r\ncase 6:\r\nsdid = V4L2_SLICED_CAPTION_525;\r\nerr = !odd_parity(p[0]) || !odd_parity(p[1]);\r\nbreak;\r\ncase 9:\r\nsdid = V4L2_SLICED_VPS;\r\nif (decode_vps(p, p) != 0)\r\nerr = 1;\r\nbreak;\r\ndefault:\r\nsdid = 0;\r\nerr = 1;\r\nbreak;\r\n}\r\nvbi->type = err ? 0 : sdid;\r\nvbi->line = err ? 0 : l;\r\nvbi->is_second_field = err ? 0 : (did == sliced_vbi_did[1]);\r\nvbi->p = p;\r\nreturn 0;\r\n}

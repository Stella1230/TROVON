static int __init init_autcpu12_sram (void)\r\n{\r\nint err, save0, save1;\r\nautcpu12_sram_map.virt = ioremap(0x12000000, SZ_128K);\r\nif (!autcpu12_sram_map.virt) {\r\nprintk("Failed to ioremap autcpu12 NV-RAM space\n");\r\nerr = -EIO;\r\ngoto out;\r\n}\r\nsimple_map_init(&autcpu_sram_map);\r\nsave0 = map_read32(&autcpu12_sram_map,0);\r\nsave1 = map_read32(&autcpu12_sram_map,0x10000);\r\nmap_write32(&autcpu12_sram_map,~save0,0x10000);\r\nif ( map_read32(&autcpu12_sram_map,0) != save0) {\r\nmap_write32(&autcpu12_sram_map,save0,0x0);\r\ngoto map;\r\n}\r\nmap_write32(&autcpu12_sram_map,save1,0x10000);\r\nautcpu12_sram_map.size = SZ_128K;\r\nmap:\r\nsram_mtd = do_map_probe("map_ram", &autcpu12_sram_map);\r\nif (!sram_mtd) {\r\nprintk("NV-RAM probe failed\n");\r\nerr = -ENXIO;\r\ngoto out_ioremap;\r\n}\r\nsram_mtd->owner = THIS_MODULE;\r\nsram_mtd->erasesize = 16;\r\nif (mtd_device_register(sram_mtd, NULL, 0)) {\r\nprintk("NV-RAM device addition failed\n");\r\nerr = -ENOMEM;\r\ngoto out_probe;\r\n}\r\nprintk("NV-RAM device size %ldKiB registered on AUTCPU12\n",autcpu12_sram_map.size/SZ_1K);\r\nreturn 0;\r\nout_probe:\r\nmap_destroy(sram_mtd);\r\nsram_mtd = 0;\r\nout_ioremap:\r\niounmap((void *)autcpu12_sram_map.virt);\r\nout:\r\nreturn err;\r\n}\r\nstatic void __exit cleanup_autcpu12_maps(void)\r\n{\r\nif (sram_mtd) {\r\nmtd_device_unregister(sram_mtd);\r\nmap_destroy(sram_mtd);\r\niounmap((void *)autcpu12_sram_map.virt);\r\n}\r\n}

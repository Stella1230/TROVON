int\r\nnv50_fbcon_fillrect(struct fb_info *info, const struct fb_fillrect *rect)\r\n{\r\nstruct nouveau_fbdev *nfbdev = info->par;\r\nstruct drm_device *dev = nfbdev->dev;\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_channel *chan = dev_priv->channel;\r\nint ret;\r\nret = RING_SPACE(chan, rect->rop == ROP_COPY ? 7 : 11);\r\nif (ret)\r\nreturn ret;\r\nif (rect->rop != ROP_COPY) {\r\nBEGIN_NV04(chan, NvSub2D, 0x02ac, 1);\r\nOUT_RING(chan, 1);\r\n}\r\nBEGIN_NV04(chan, NvSub2D, 0x0588, 1);\r\nif (info->fix.visual == FB_VISUAL_TRUECOLOR ||\r\ninfo->fix.visual == FB_VISUAL_DIRECTCOLOR)\r\nOUT_RING(chan, ((uint32_t *)info->pseudo_palette)[rect->color]);\r\nelse\r\nOUT_RING(chan, rect->color);\r\nBEGIN_NV04(chan, NvSub2D, 0x0600, 4);\r\nOUT_RING(chan, rect->dx);\r\nOUT_RING(chan, rect->dy);\r\nOUT_RING(chan, rect->dx + rect->width);\r\nOUT_RING(chan, rect->dy + rect->height);\r\nif (rect->rop != ROP_COPY) {\r\nBEGIN_NV04(chan, NvSub2D, 0x02ac, 1);\r\nOUT_RING(chan, 3);\r\n}\r\nFIRE_RING(chan);\r\nreturn 0;\r\n}\r\nint\r\nnv50_fbcon_copyarea(struct fb_info *info, const struct fb_copyarea *region)\r\n{\r\nstruct nouveau_fbdev *nfbdev = info->par;\r\nstruct drm_device *dev = nfbdev->dev;\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_channel *chan = dev_priv->channel;\r\nint ret;\r\nret = RING_SPACE(chan, 12);\r\nif (ret)\r\nreturn ret;\r\nBEGIN_NV04(chan, NvSub2D, 0x0110, 1);\r\nOUT_RING(chan, 0);\r\nBEGIN_NV04(chan, NvSub2D, 0x08b0, 4);\r\nOUT_RING(chan, region->dx);\r\nOUT_RING(chan, region->dy);\r\nOUT_RING(chan, region->width);\r\nOUT_RING(chan, region->height);\r\nBEGIN_NV04(chan, NvSub2D, 0x08d0, 4);\r\nOUT_RING(chan, 0);\r\nOUT_RING(chan, region->sx);\r\nOUT_RING(chan, 0);\r\nOUT_RING(chan, region->sy);\r\nFIRE_RING(chan);\r\nreturn 0;\r\n}\r\nint\r\nnv50_fbcon_imageblit(struct fb_info *info, const struct fb_image *image)\r\n{\r\nstruct nouveau_fbdev *nfbdev = info->par;\r\nstruct drm_device *dev = nfbdev->dev;\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_channel *chan = dev_priv->channel;\r\nuint32_t width, dwords, *data = (uint32_t *)image->data;\r\nuint32_t mask = ~(~0 >> (32 - info->var.bits_per_pixel));\r\nuint32_t *palette = info->pseudo_palette;\r\nint ret;\r\nif (image->depth != 1)\r\nreturn -ENODEV;\r\nret = RING_SPACE(chan, 11);\r\nif (ret)\r\nreturn ret;\r\nwidth = ALIGN(image->width, 32);\r\ndwords = (width * image->height) >> 5;\r\nBEGIN_NV04(chan, NvSub2D, 0x0814, 2);\r\nif (info->fix.visual == FB_VISUAL_TRUECOLOR ||\r\ninfo->fix.visual == FB_VISUAL_DIRECTCOLOR) {\r\nOUT_RING(chan, palette[image->bg_color] | mask);\r\nOUT_RING(chan, palette[image->fg_color] | mask);\r\n} else {\r\nOUT_RING(chan, image->bg_color);\r\nOUT_RING(chan, image->fg_color);\r\n}\r\nBEGIN_NV04(chan, NvSub2D, 0x0838, 2);\r\nOUT_RING(chan, image->width);\r\nOUT_RING(chan, image->height);\r\nBEGIN_NV04(chan, NvSub2D, 0x0850, 4);\r\nOUT_RING(chan, 0);\r\nOUT_RING(chan, image->dx);\r\nOUT_RING(chan, 0);\r\nOUT_RING(chan, image->dy);\r\nwhile (dwords) {\r\nint push = dwords > 2047 ? 2047 : dwords;\r\nret = RING_SPACE(chan, push + 1);\r\nif (ret)\r\nreturn ret;\r\ndwords -= push;\r\nBEGIN_NI04(chan, NvSub2D, 0x0860, push);\r\nOUT_RINGp(chan, data, push);\r\ndata += push;\r\n}\r\nFIRE_RING(chan);\r\nreturn 0;\r\n}\r\nint\r\nnv50_fbcon_accel_init(struct fb_info *info)\r\n{\r\nstruct nouveau_fbdev *nfbdev = info->par;\r\nstruct drm_device *dev = nfbdev->dev;\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_channel *chan = dev_priv->channel;\r\nstruct nouveau_framebuffer *fb = &nfbdev->nouveau_fb;\r\nint ret, format;\r\nswitch (info->var.bits_per_pixel) {\r\ncase 8:\r\nformat = 0xf3;\r\nbreak;\r\ncase 15:\r\nformat = 0xf8;\r\nbreak;\r\ncase 16:\r\nformat = 0xe8;\r\nbreak;\r\ncase 32:\r\nswitch (info->var.transp.length) {\r\ncase 0:\r\ncase 8:\r\nformat = 0xe6;\r\nbreak;\r\ncase 2:\r\nformat = 0xd1;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nret = nouveau_gpuobj_gr_new(dev_priv->channel, Nv2D, 0x502d);\r\nif (ret)\r\nreturn ret;\r\nret = RING_SPACE(chan, 59);\r\nif (ret) {\r\nnouveau_fbcon_gpu_lockup(info);\r\nreturn ret;\r\n}\r\nBEGIN_NV04(chan, NvSub2D, 0x0000, 1);\r\nOUT_RING(chan, Nv2D);\r\nBEGIN_NV04(chan, NvSub2D, 0x0184, 3);\r\nOUT_RING(chan, chan->vram_handle);\r\nOUT_RING(chan, chan->vram_handle);\r\nOUT_RING(chan, chan->vram_handle);\r\nBEGIN_NV04(chan, NvSub2D, 0x0290, 1);\r\nOUT_RING(chan, 0);\r\nBEGIN_NV04(chan, NvSub2D, 0x0888, 1);\r\nOUT_RING(chan, 1);\r\nBEGIN_NV04(chan, NvSub2D, 0x02ac, 1);\r\nOUT_RING(chan, 3);\r\nBEGIN_NV04(chan, NvSub2D, 0x02a0, 1);\r\nOUT_RING(chan, 0x55);\r\nBEGIN_NV04(chan, NvSub2D, 0x08c0, 4);\r\nOUT_RING(chan, 0);\r\nOUT_RING(chan, 1);\r\nOUT_RING(chan, 0);\r\nOUT_RING(chan, 1);\r\nBEGIN_NV04(chan, NvSub2D, 0x0580, 2);\r\nOUT_RING(chan, 4);\r\nOUT_RING(chan, format);\r\nBEGIN_NV04(chan, NvSub2D, 0x02e8, 2);\r\nOUT_RING(chan, 2);\r\nOUT_RING(chan, 1);\r\nBEGIN_NV04(chan, NvSub2D, 0x0804, 1);\r\nOUT_RING(chan, format);\r\nBEGIN_NV04(chan, NvSub2D, 0x0800, 1);\r\nOUT_RING(chan, 1);\r\nBEGIN_NV04(chan, NvSub2D, 0x0808, 3);\r\nOUT_RING(chan, 0);\r\nOUT_RING(chan, 0);\r\nOUT_RING(chan, 1);\r\nBEGIN_NV04(chan, NvSub2D, 0x081c, 1);\r\nOUT_RING(chan, 1);\r\nBEGIN_NV04(chan, NvSub2D, 0x0840, 4);\r\nOUT_RING(chan, 0);\r\nOUT_RING(chan, 1);\r\nOUT_RING(chan, 0);\r\nOUT_RING(chan, 1);\r\nBEGIN_NV04(chan, NvSub2D, 0x0200, 2);\r\nOUT_RING(chan, format);\r\nOUT_RING(chan, 1);\r\nBEGIN_NV04(chan, NvSub2D, 0x0214, 5);\r\nOUT_RING(chan, info->fix.line_length);\r\nOUT_RING(chan, info->var.xres_virtual);\r\nOUT_RING(chan, info->var.yres_virtual);\r\nOUT_RING(chan, upper_32_bits(fb->vma.offset));\r\nOUT_RING(chan, lower_32_bits(fb->vma.offset));\r\nBEGIN_NV04(chan, NvSub2D, 0x0230, 2);\r\nOUT_RING(chan, format);\r\nOUT_RING(chan, 1);\r\nBEGIN_NV04(chan, NvSub2D, 0x0244, 5);\r\nOUT_RING(chan, info->fix.line_length);\r\nOUT_RING(chan, info->var.xres_virtual);\r\nOUT_RING(chan, info->var.yres_virtual);\r\nOUT_RING(chan, upper_32_bits(fb->vma.offset));\r\nOUT_RING(chan, lower_32_bits(fb->vma.offset));\r\nreturn 0;\r\n}

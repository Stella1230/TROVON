asmlinkage void debug_stub(void)\r\n{\r\nunsigned long hsr0;\r\nint type = 0;\r\nstatic u8 inited = 0;\r\nif (!inited) {\r\ndebug_stub_init();\r\ntype = -1;\r\ninited = 1;\r\n}\r\nhsr0 = __get_HSR(0);\r\nif (hsr0 & HSR0_ETMD)\r\n__set_HSR(0, hsr0 & ~HSR0_ETMD);\r\n__debug_status.dcr &= ~DCR_SE;\r\nif (__debug_frame->pc == (unsigned long) __break_hijack_kernel_event_breaks_here) {\r\n*__debug_frame = *__frame;\r\n__frame = __debug_frame->next_frame;\r\n__debug_status.brr = (__debug_frame->tbr & TBR_TT) << 12;\r\n__debug_status.brr |= BRR_EB;\r\n}\r\nif (__debug_frame->pc == (unsigned long) __debug_bug_trap + 4) {\r\n__debug_frame->pc = __debug_frame->lr;\r\ntype = __debug_frame->gr8;\r\n}\r\n#ifdef CONFIG_GDBSTUB\r\ngdbstub(type);\r\n#endif\r\nif (hsr0 & HSR0_ETMD)\r\n__set_HSR(0, __get_HSR(0) | HSR0_ETMD);\r\n}\r\nstatic void __init debug_stub_init(void)\r\n{\r\n__set_IRR(6, 0xff000000);\r\n__set_IITMR(1, 0x20000000);\r\nasm volatile(" movgs gr0,ibar0 \n"\r\n" movgs gr0,ibar1 \n"\r\n" movgs gr0,ibar2 \n"\r\n" movgs gr0,ibar3 \n"\r\n" movgs gr0,dbar0 \n"\r\n" movgs gr0,dbmr00 \n"\r\n" movgs gr0,dbmr01 \n"\r\n" movgs gr0,dbdr00 \n"\r\n" movgs gr0,dbdr01 \n"\r\n" movgs gr0,dbar1 \n"\r\n" movgs gr0,dbmr10 \n"\r\n" movgs gr0,dbmr11 \n"\r\n" movgs gr0,dbdr10 \n"\r\n" movgs gr0,dbdr11 \n"\r\n);\r\nif (__debug_frame->pc == (unsigned long) __debug_stub_init_break)\r\n__debug_frame->pc = (unsigned long) start_kernel;\r\n__debug_status.dcr = DCR_EBE;\r\n#ifdef CONFIG_GDBSTUB\r\ngdbstub_init();\r\n#endif\r\n__clr_MASK_all();\r\n__clr_MASK(15);\r\n__clr_RC(15);\r\n}\r\nvoid debug_stub_exit(int status)\r\n{\r\n#ifdef CONFIG_GDBSTUB\r\ngdbstub_exit(status);\r\n#endif\r\n}\r\nvoid debug_to_serial(const char *p, int n)\r\n{\r\nchar ch;\r\nfor (; n > 0; n--) {\r\nch = *p++;\r\nFLOWCTL_SET0(DTR);\r\nLSR_WAIT_FOR0(THRE);\r\nif (ch == 0x0a) {\r\n__UART0(TX) = 0x0d;\r\nmb();\r\nLSR_WAIT_FOR0(THRE);\r\n}\r\n__UART0(TX) = ch;\r\nmb();\r\nFLOWCTL_CLEAR0(DTR);\r\n}\r\n}\r\nvoid debug_to_serial2(const char *fmt, ...)\r\n{\r\nva_list va;\r\nchar buf[64];\r\nint n;\r\nva_start(va, fmt);\r\nn = vsprintf(buf, fmt, va);\r\nva_end(va);\r\ndebug_to_serial(buf, n);\r\n}\r\nvoid __init console_set_baud(unsigned baud)\r\n{\r\nunsigned value, high, low;\r\nu8 lcr;\r\nvalue = __serial_clock_speed_HZ / 16 / baud;\r\nhigh = __serial_clock_speed_HZ / 16 / value;\r\nlow = __serial_clock_speed_HZ / 16 / (value + 1);\r\nif (low + (high - low) / 2 > baud)\r\nvalue++;\r\nlcr = __UART0(LCR);\r\n__UART0(LCR) |= UART_LCR_DLAB;\r\nmb();\r\n__UART0(DLL) = value & 0xff;\r\n__UART0(DLM) = (value >> 8) & 0xff;\r\nmb();\r\n__UART0(LCR) = lcr;\r\nmb();\r\n}\r\nint __init console_get_baud(void)\r\n{\r\nunsigned value;\r\nu8 lcr;\r\nlcr = __UART0(LCR);\r\n__UART0(LCR) |= UART_LCR_DLAB;\r\nmb();\r\nvalue = __UART0(DLM) << 8;\r\nvalue |= __UART0(DLL);\r\n__UART0(LCR) = lcr;\r\nmb();\r\nreturn value;\r\n}\r\nvoid __debug_bug_printk(const char *file, unsigned line)\r\n{\r\nprintk("kernel BUG at %s:%d!\n", file, line);\r\n}

u64\r\nnvc0_software_crtc(struct nouveau_channel *chan, int crtc)\r\n{\r\nstruct nvc0_software_chan *pch = chan->engctx[NVOBJ_ENGINE_SW];\r\nreturn pch->dispc_vma[crtc].offset;\r\n}\r\nstatic int\r\nnvc0_software_context_new(struct nouveau_channel *chan, int engine)\r\n{\r\nstruct drm_device *dev = chan->dev;\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nvc0_software_priv *psw = nv_engine(dev, NVOBJ_ENGINE_SW);\r\nstruct nvc0_software_chan *pch;\r\nint ret = 0, i;\r\npch = kzalloc(sizeof(*pch), GFP_KERNEL);\r\nif (!pch)\r\nreturn -ENOMEM;\r\nnouveau_software_context_new(&pch->base);\r\nchan->engctx[engine] = pch;\r\nfor (i = 0; !ret && i < dev->mode_config.num_crtc; i++) {\r\nstruct nouveau_bo *bo;\r\nif (dev_priv->card_type >= NV_D0)\r\nbo = nvd0_display_crtc_sema(dev, i);\r\nelse\r\nbo = nv50_display(dev)->crtc[i].sem.bo;\r\nret = nouveau_bo_vma_add(bo, chan->vm, &pch->dispc_vma[i]);\r\n}\r\nif (ret)\r\npsw->base.base.context_del(chan, engine);\r\nreturn ret;\r\n}\r\nstatic void\r\nnvc0_software_context_del(struct nouveau_channel *chan, int engine)\r\n{\r\nstruct drm_device *dev = chan->dev;\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nvc0_software_chan *pch = chan->engctx[engine];\r\nint i;\r\nif (dev_priv->card_type >= NV_D0) {\r\nfor (i = 0; i < dev->mode_config.num_crtc; i++) {\r\nstruct nouveau_bo *bo = nvd0_display_crtc_sema(dev, i);\r\nnouveau_bo_vma_del(bo, &pch->dispc_vma[i]);\r\n}\r\n} else\r\nif (dev_priv->card_type >= NV_50) {\r\nstruct nv50_display *disp = nv50_display(dev);\r\nfor (i = 0; i < dev->mode_config.num_crtc; i++) {\r\nstruct nv50_display_crtc *dispc = &disp->crtc[i];\r\nnouveau_bo_vma_del(dispc->sem.bo, &pch->dispc_vma[i]);\r\n}\r\n}\r\nchan->engctx[engine] = NULL;\r\nkfree(pch);\r\n}\r\nstatic int\r\nnvc0_software_object_new(struct nouveau_channel *chan, int engine,\r\nu32 handle, u16 class)\r\n{\r\nreturn 0;\r\n}\r\nstatic int\r\nnvc0_software_init(struct drm_device *dev, int engine)\r\n{\r\nreturn 0;\r\n}\r\nstatic int\r\nnvc0_software_fini(struct drm_device *dev, int engine, bool suspend)\r\n{\r\nreturn 0;\r\n}\r\nstatic void\r\nnvc0_software_destroy(struct drm_device *dev, int engine)\r\n{\r\nstruct nvc0_software_priv *psw = nv_engine(dev, engine);\r\nNVOBJ_ENGINE_DEL(dev, SW);\r\nkfree(psw);\r\n}\r\nint\r\nnvc0_software_create(struct drm_device *dev)\r\n{\r\nstruct nvc0_software_priv *psw = kzalloc(sizeof(*psw), GFP_KERNEL);\r\nif (!psw)\r\nreturn -ENOMEM;\r\npsw->base.base.destroy = nvc0_software_destroy;\r\npsw->base.base.init = nvc0_software_init;\r\npsw->base.base.fini = nvc0_software_fini;\r\npsw->base.base.context_new = nvc0_software_context_new;\r\npsw->base.base.context_del = nvc0_software_context_del;\r\npsw->base.base.object_new = nvc0_software_object_new;\r\nnouveau_software_create(&psw->base);\r\nNVOBJ_ENGINE_ADD(dev, SW, &psw->base.base);\r\nNVOBJ_CLASS(dev, 0x906e, SW);\r\nreturn 0;\r\n}

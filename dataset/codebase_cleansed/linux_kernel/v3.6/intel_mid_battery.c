static int pmic_scu_ipc_battery_cc_read(u32 *value)\r\n{\r\nreturn intel_scu_ipc_command(IPCMSG_BATTERY, IPC_CMD_CC_RD,\r\nNULL, 0, value, 1);\r\n}\r\nstatic int pmic_scu_ipc_battery_property_get(struct battery_property *prop)\r\n{\r\nu32 data[3];\r\nu8 *p = (u8 *)&data[1];\r\nint err = intel_scu_ipc_command(IPCMSG_BATTERY,\r\nIPC_CMD_BATTERY_PROPERTY, NULL, 0, data, 3);\r\nprop->capacity = data[0];\r\nprop->crnt = *p++;\r\nprop->volt = *p++;\r\nprop->prot = *p++;\r\nprop->prot2 = *p++;\r\nprop->timer = *p++;\r\nreturn err;\r\n}\r\nstatic int pmic_scu_ipc_set_charger(int charger)\r\n{\r\nreturn intel_scu_ipc_simple_command(IPCMSG_BATTERY, charger);\r\n}\r\nstatic void pmic_battery_log_event(enum batt_event event)\r\n{\r\nprintk(KERN_WARNING "pmic-battery: ");\r\nswitch (event) {\r\ncase BATT_EVENT_BATOVP_EXCPT:\r\nprintk(KERN_CONT "battery overvoltage condition\n");\r\nbreak;\r\ncase BATT_EVENT_USBOVP_EXCPT:\r\nprintk(KERN_CONT "usb charger overvoltage condition\n");\r\nbreak;\r\ncase BATT_EVENT_TEMP_EXCPT:\r\nprintk(KERN_CONT "high battery temperature condition\n");\r\nbreak;\r\ncase BATT_EVENT_DCLMT_EXCPT:\r\nprintk(KERN_CONT "over battery charge current condition\n");\r\nbreak;\r\ndefault:\r\nprintk(KERN_CONT "charger/battery exception %d\n", event);\r\nbreak;\r\n}\r\n}\r\nstatic void pmic_battery_read_status(struct pmic_power_module_info *pbi)\r\n{\r\nunsigned int update_time_intrvl;\r\nunsigned int chrg_val;\r\nu32 ccval;\r\nu8 r8;\r\nstruct battery_property batt_prop;\r\nint batt_present = 0;\r\nint usb_present = 0;\r\nint batt_exception = 0;\r\nif (pbi->update_time && time_before(jiffies, pbi->update_time +\r\nmsecs_to_jiffies(delay_time)))\r\nreturn;\r\nupdate_time_intrvl = jiffies_to_msecs(jiffies - pbi->update_time);\r\npbi->update_time = jiffies;\r\nif (pmic_scu_ipc_battery_cc_read(&ccval)) {\r\ndev_warn(pbi->dev, "%s(): ipc config cmd failed\n",\r\n__func__);\r\nreturn;\r\n}\r\nif (intel_scu_ipc_ioread8(PMIC_BATT_CHR_SCHRGINT_ADDR, &r8)) {\r\ndev_warn(pbi->dev, "%s(): ipc pmic read failed\n",\r\n__func__);\r\nreturn;\r\n}\r\nif (r8 & PMIC_BATT_CHR_SBATDET_MASK) {\r\npbi->batt_is_present = PMIC_BATT_PRESENT;\r\nbatt_present = 1;\r\n} else {\r\npbi->batt_is_present = PMIC_BATT_NOT_PRESENT;\r\npbi->batt_health = POWER_SUPPLY_HEALTH_UNKNOWN;\r\npbi->batt_status = POWER_SUPPLY_STATUS_UNKNOWN;\r\n}\r\nif (batt_present) {\r\nif (r8 & PMIC_BATT_CHR_SBATOVP_MASK) {\r\npbi->batt_health = POWER_SUPPLY_HEALTH_OVERVOLTAGE;\r\npbi->batt_status = POWER_SUPPLY_STATUS_NOT_CHARGING;\r\npmic_battery_log_event(BATT_EVENT_BATOVP_EXCPT);\r\nbatt_exception = 1;\r\n} else if (r8 & PMIC_BATT_CHR_STEMP_MASK) {\r\npbi->batt_health = POWER_SUPPLY_HEALTH_OVERHEAT;\r\npbi->batt_status = POWER_SUPPLY_STATUS_NOT_CHARGING;\r\npmic_battery_log_event(BATT_EVENT_TEMP_EXCPT);\r\nbatt_exception = 1;\r\n} else {\r\npbi->batt_health = POWER_SUPPLY_HEALTH_GOOD;\r\nif (r8 & PMIC_BATT_CHR_SDCLMT_MASK) {\r\npmic_battery_log_event(BATT_EVENT_DCLMT_EXCPT);\r\n}\r\n}\r\n}\r\nif (r8 & PMIC_BATT_CHR_SUSBDET_MASK) {\r\npbi->usb_is_present = PMIC_USB_PRESENT;\r\nusb_present = 1;\r\n} else {\r\npbi->usb_is_present = PMIC_USB_NOT_PRESENT;\r\npbi->usb_health = POWER_SUPPLY_HEALTH_UNKNOWN;\r\n}\r\nif (usb_present) {\r\nif (r8 & PMIC_BATT_CHR_SUSBOVP_MASK) {\r\npbi->usb_health = POWER_SUPPLY_HEALTH_OVERVOLTAGE;\r\npmic_battery_log_event(BATT_EVENT_USBOVP_EXCPT);\r\n} else {\r\npbi->usb_health = POWER_SUPPLY_HEALTH_GOOD;\r\n}\r\n}\r\nchrg_val = ccval & PMIC_BATT_ADC_ACCCHRGVAL_MASK;\r\nif (!pbi->is_dev_info_updated) {\r\nif (pmic_scu_ipc_battery_property_get(&batt_prop)) {\r\ndev_warn(pbi->dev, "%s(): ipc config cmd failed\n",\r\n__func__);\r\nreturn;\r\n}\r\npbi->batt_prev_charge_full = batt_prop.capacity;\r\n}\r\nif (batt_present && !batt_exception) {\r\nif (r8 & PMIC_BATT_CHR_SCOMP_MASK) {\r\npbi->batt_status = POWER_SUPPLY_STATUS_FULL;\r\npbi->batt_prev_charge_full = chrg_val;\r\n} else if (ccval & PMIC_BATT_ADC_ACCCHRG_MASK) {\r\npbi->batt_status = POWER_SUPPLY_STATUS_DISCHARGING;\r\n} else {\r\npbi->batt_status = POWER_SUPPLY_STATUS_CHARGING;\r\n}\r\n}\r\nif (pbi->is_dev_info_updated && batt_present && !batt_exception) {\r\nif (pbi->batt_status == POWER_SUPPLY_STATUS_DISCHARGING) {\r\nif (pbi->batt_charge_now - chrg_val) {\r\npbi->batt_charge_rate = ((pbi->batt_charge_now -\r\nchrg_val) * 1000 * 60) /\r\nupdate_time_intrvl;\r\n}\r\n} else if (pbi->batt_status == POWER_SUPPLY_STATUS_CHARGING) {\r\nif (chrg_val - pbi->batt_charge_now) {\r\npbi->batt_charge_rate = ((chrg_val -\r\npbi->batt_charge_now) * 1000 * 60) /\r\nupdate_time_intrvl;\r\n}\r\n} else\r\npbi->batt_charge_rate = 0;\r\n} else {\r\npbi->batt_charge_rate = -1;\r\n}\r\nif (batt_present && !batt_exception)\r\npbi->batt_charge_now = chrg_val;\r\nelse\r\npbi->batt_charge_now = -1;\r\npbi->is_dev_info_updated = PMIC_BATT_DRV_INFO_UPDATED;\r\n}\r\nstatic int pmic_usb_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct pmic_power_module_info *pbi = container_of(psy,\r\nstruct pmic_power_module_info, usb);\r\npmic_battery_read_status(pbi);\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_PRESENT:\r\nval->intval = pbi->usb_is_present;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_HEALTH:\r\nval->intval = pbi->usb_health;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic inline unsigned long mAStouAh(unsigned long v)\r\n{\r\nreturn (v * 1000) / 3600;\r\n}\r\nstatic int pmic_battery_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct pmic_power_module_info *pbi = container_of(psy,\r\nstruct pmic_power_module_info, batt);\r\npmic_battery_read_status(pbi);\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nval->intval = pbi->batt_status;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_HEALTH:\r\nval->intval = pbi->batt_health;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_PRESENT:\r\nval->intval = pbi->batt_is_present;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_NOW:\r\nval->intval = mAStouAh(pbi->batt_charge_now);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_FULL:\r\nval->intval = mAStouAh(pbi->batt_prev_charge_full);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic void pmic_battery_monitor(struct work_struct *work)\r\n{\r\nstruct pmic_power_module_info *pbi = container_of(work,\r\nstruct pmic_power_module_info, monitor_battery.work);\r\npmic_battery_read_status(pbi);\r\nqueue_delayed_work(pbi->monitor_wqueue, &pbi->monitor_battery, HZ * 10);\r\n}\r\nstatic int pmic_battery_set_charger(struct pmic_power_module_info *pbi,\r\nenum batt_charge_type chrg)\r\n{\r\nint retval;\r\nswitch (chrg) {\r\ncase BATT_USBOTG_500MA_CHARGE:\r\nretval = pmic_scu_ipc_set_charger(PMIC_BATT_CHR_IPC_FCHRG_SUBID);\r\nbreak;\r\ncase BATT_USBOTG_TRICKLE_CHARGE:\r\nretval = pmic_scu_ipc_set_charger(PMIC_BATT_CHR_IPC_TCHRG_SUBID);\r\nbreak;\r\ndefault:\r\ndev_warn(pbi->dev, "%s(): out of range usb charger "\r\n"charge detected\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nif (retval) {\r\ndev_warn(pbi->dev, "%s(): ipc pmic read failed\n",\r\n__func__);\r\nreturn retval;\r\n}\r\nreturn 0;\r\n}\r\nstatic irqreturn_t pmic_battery_interrupt_handler(int id, void *dev)\r\n{\r\nstruct pmic_power_module_info *pbi = dev;\r\nschedule_work(&pbi->handler);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void pmic_battery_handle_intrpt(struct work_struct *work)\r\n{\r\nstruct pmic_power_module_info *pbi = container_of(work,\r\nstruct pmic_power_module_info, handler);\r\nenum batt_charge_type chrg;\r\nu8 r8;\r\nif (intel_scu_ipc_ioread8(PMIC_BATT_CHR_SCHRGINT_ADDR, &r8)) {\r\ndev_warn(pbi->dev, "%s(): ipc pmic read failed\n",\r\n__func__);\r\nreturn;\r\n}\r\nif (r8 & PMIC_BATT_CHR_SBATDET_MASK) {\r\npbi->batt_is_present = PMIC_BATT_PRESENT;\r\n} else {\r\npbi->batt_is_present = PMIC_BATT_NOT_PRESENT;\r\npbi->batt_health = POWER_SUPPLY_HEALTH_UNKNOWN;\r\npbi->batt_status = POWER_SUPPLY_STATUS_UNKNOWN;\r\nreturn;\r\n}\r\nif (r8 & PMIC_BATT_CHR_EXCPT_MASK) {\r\npbi->batt_health = POWER_SUPPLY_HEALTH_UNKNOWN;\r\npbi->batt_status = POWER_SUPPLY_STATUS_NOT_CHARGING;\r\npbi->usb_health = POWER_SUPPLY_HEALTH_UNKNOWN;\r\npmic_battery_log_event(BATT_EVENT_EXCPT);\r\nreturn;\r\n} else {\r\npbi->batt_health = POWER_SUPPLY_HEALTH_GOOD;\r\npbi->usb_health = POWER_SUPPLY_HEALTH_GOOD;\r\n}\r\nif (r8 & PMIC_BATT_CHR_SCOMP_MASK) {\r\nu32 ccval;\r\npbi->batt_status = POWER_SUPPLY_STATUS_FULL;\r\nif (pmic_scu_ipc_battery_cc_read(&ccval)) {\r\ndev_warn(pbi->dev, "%s(): ipc config cmd "\r\n"failed\n", __func__);\r\nreturn;\r\n}\r\npbi->batt_prev_charge_full = ccval &\r\nPMIC_BATT_ADC_ACCCHRGVAL_MASK;\r\nreturn;\r\n}\r\nif (r8 & PMIC_BATT_CHR_SUSBDET_MASK) {\r\npbi->usb_is_present = PMIC_USB_PRESENT;\r\n} else {\r\npbi->usb_is_present = PMIC_USB_NOT_PRESENT;\r\npbi->usb_health = POWER_SUPPLY_HEALTH_UNKNOWN;\r\nreturn;\r\n}\r\n#if 0\r\nretval = langwell_udc_maxpower(&power);\r\nif (retval) {\r\ndev_warn(pbi->dev,\r\n"%s(): usb otg power query failed with error code %d\n",\r\n__func__, retval);\r\nreturn;\r\n}\r\nif (power >= 500)\r\nchrg = BATT_USBOTG_500MA_CHARGE;\r\nelse\r\n#endif\r\nchrg = BATT_USBOTG_TRICKLE_CHARGE;\r\nif (pmic_battery_set_charger(pbi, chrg)) {\r\ndev_warn(pbi->dev,\r\n"%s(): failed to set up battery charging\n", __func__);\r\nreturn;\r\n}\r\ndev_dbg(pbi->dev,\r\n"pmic-battery: %s() - setting up battery charger successful\n",\r\n__func__);\r\n}\r\nstatic __devinit int probe(int irq, struct device *dev)\r\n{\r\nint retval = 0;\r\nstruct pmic_power_module_info *pbi;\r\ndev_dbg(dev, "pmic-battery: found pmic battery device\n");\r\npbi = kzalloc(sizeof(*pbi), GFP_KERNEL);\r\nif (!pbi) {\r\ndev_err(dev, "%s(): memory allocation failed\n",\r\n__func__);\r\nreturn -ENOMEM;\r\n}\r\npbi->dev = dev;\r\npbi->irq = irq;\r\ndev_set_drvdata(dev, pbi);\r\nINIT_WORK(&pbi->handler, pmic_battery_handle_intrpt);\r\nINIT_DELAYED_WORK(&pbi->monitor_battery, pmic_battery_monitor);\r\npbi->monitor_wqueue =\r\ncreate_singlethread_workqueue(dev_name(dev));\r\nif (!pbi->monitor_wqueue) {\r\ndev_err(dev, "%s(): wqueue init failed\n", __func__);\r\nretval = -ESRCH;\r\ngoto wqueue_failed;\r\n}\r\nretval = request_irq(pbi->irq, pmic_battery_interrupt_handler,\r\n0, DRIVER_NAME, pbi);\r\nif (retval) {\r\ndev_err(dev, "%s(): cannot get IRQ\n", __func__);\r\ngoto requestirq_failed;\r\n}\r\npbi->batt.name = "pmic-batt";\r\npbi->batt.type = POWER_SUPPLY_TYPE_BATTERY;\r\npbi->batt.properties = pmic_battery_props;\r\npbi->batt.num_properties = ARRAY_SIZE(pmic_battery_props);\r\npbi->batt.get_property = pmic_battery_get_property;\r\nretval = power_supply_register(dev, &pbi->batt);\r\nif (retval) {\r\ndev_err(dev,\r\n"%s(): failed to register pmic battery device with power supply subsystem\n",\r\n__func__);\r\ngoto power_reg_failed;\r\n}\r\ndev_dbg(dev, "pmic-battery: %s() - pmic battery device "\r\n"registration with power supply subsystem successful\n",\r\n__func__);\r\nqueue_delayed_work(pbi->monitor_wqueue, &pbi->monitor_battery, HZ * 1);\r\npbi->usb.name = "pmic-usb";\r\npbi->usb.type = POWER_SUPPLY_TYPE_USB;\r\npbi->usb.properties = pmic_usb_props;\r\npbi->usb.num_properties = ARRAY_SIZE(pmic_usb_props);\r\npbi->usb.get_property = pmic_usb_get_property;\r\nretval = power_supply_register(dev, &pbi->usb);\r\nif (retval) {\r\ndev_err(dev,\r\n"%s(): failed to register pmic usb device with power supply subsystem\n",\r\n__func__);\r\ngoto power_reg_failed_1;\r\n}\r\nif (debug)\r\nprintk(KERN_INFO "pmic-battery: %s() - pmic usb device "\r\n"registration with power supply subsystem successful\n",\r\n__func__);\r\nreturn retval;\r\npower_reg_failed_1:\r\npower_supply_unregister(&pbi->batt);\r\npower_reg_failed:\r\ncancel_delayed_work_sync(&pbi->monitor_battery);\r\nrequestirq_failed:\r\ndestroy_workqueue(pbi->monitor_wqueue);\r\nwqueue_failed:\r\nkfree(pbi);\r\nreturn retval;\r\n}\r\nstatic int __devinit platform_pmic_battery_probe(struct platform_device *pdev)\r\n{\r\nreturn probe(pdev->id, &pdev->dev);\r\n}\r\nstatic int __devexit platform_pmic_battery_remove(struct platform_device *pdev)\r\n{\r\nstruct pmic_power_module_info *pbi = dev_get_drvdata(&pdev->dev);\r\nfree_irq(pbi->irq, pbi);\r\ncancel_delayed_work_sync(&pbi->monitor_battery);\r\ndestroy_workqueue(pbi->monitor_wqueue);\r\npower_supply_unregister(&pbi->usb);\r\npower_supply_unregister(&pbi->batt);\r\ncancel_work_sync(&pbi->handler);\r\nkfree(pbi);\r\nreturn 0;\r\n}

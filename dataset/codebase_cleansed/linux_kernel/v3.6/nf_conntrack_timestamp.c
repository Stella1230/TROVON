static int nf_conntrack_tstamp_init_sysctl(struct net *net)\r\n{\r\nstruct ctl_table *table;\r\ntable = kmemdup(tstamp_sysctl_table, sizeof(tstamp_sysctl_table),\r\nGFP_KERNEL);\r\nif (!table)\r\ngoto out;\r\ntable[0].data = &net->ct.sysctl_tstamp;\r\nnet->ct.tstamp_sysctl_header = register_net_sysctl(net, "net/netfilter",\r\ntable);\r\nif (!net->ct.tstamp_sysctl_header) {\r\nprintk(KERN_ERR "nf_ct_tstamp: can't register to sysctl.\n");\r\ngoto out_register;\r\n}\r\nreturn 0;\r\nout_register:\r\nkfree(table);\r\nout:\r\nreturn -ENOMEM;\r\n}\r\nstatic void nf_conntrack_tstamp_fini_sysctl(struct net *net)\r\n{\r\nstruct ctl_table *table;\r\ntable = net->ct.tstamp_sysctl_header->ctl_table_arg;\r\nunregister_net_sysctl_table(net->ct.tstamp_sysctl_header);\r\nkfree(table);\r\n}\r\nstatic int nf_conntrack_tstamp_init_sysctl(struct net *net)\r\n{\r\nreturn 0;\r\n}\r\nstatic void nf_conntrack_tstamp_fini_sysctl(struct net *net)\r\n{\r\n}\r\nint nf_conntrack_tstamp_init(struct net *net)\r\n{\r\nint ret;\r\nnet->ct.sysctl_tstamp = nf_ct_tstamp;\r\nif (net_eq(net, &init_net)) {\r\nret = nf_ct_extend_register(&tstamp_extend);\r\nif (ret < 0) {\r\nprintk(KERN_ERR "nf_ct_tstamp: Unable to register "\r\n"extension\n");\r\ngoto out_extend_register;\r\n}\r\n}\r\nret = nf_conntrack_tstamp_init_sysctl(net);\r\nif (ret < 0)\r\ngoto out_sysctl;\r\nreturn 0;\r\nout_sysctl:\r\nif (net_eq(net, &init_net))\r\nnf_ct_extend_unregister(&tstamp_extend);\r\nout_extend_register:\r\nreturn ret;\r\n}\r\nvoid nf_conntrack_tstamp_fini(struct net *net)\r\n{\r\nnf_conntrack_tstamp_fini_sysctl(net);\r\nif (net_eq(net, &init_net))\r\nnf_ct_extend_unregister(&tstamp_extend);\r\n}

static void cy82c693_set_dma_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nconst u8 mode = drive->dma_mode;\r\nu8 single = (mode & 0x10) >> 4, index = 0, data = 0;\r\nindex = hwif->channel ? CY82_INDEX_CHANNEL1 : CY82_INDEX_CHANNEL0;\r\ndata = (mode & 3) | (single << 2);\r\noutb(index, CY82_INDEX_PORT);\r\noutb(data, CY82_DATA_PORT);\r\ndata = BUSMASTER_TIMEOUT;\r\noutb(CY82_INDEX_TIMEOUT, CY82_INDEX_PORT);\r\noutb(data, CY82_DATA_PORT);\r\n}\r\nstatic void cy82c693_set_pio_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nint bus_speed = ide_pci_clk ? ide_pci_clk : 33;\r\nconst unsigned long T = 1000000 / bus_speed;\r\nunsigned int addrCtrl;\r\nstruct ide_timing t;\r\nu8 time_16, time_8;\r\nif (drive->dn > 1) {\r\ndev = pci_get_slot(dev->bus, dev->devfn+1);\r\nif (!dev) {\r\nprintk(KERN_ERR "%s: tune_drive: "\r\n"Cannot find secondary interface!\n",\r\ndrive->name);\r\nreturn;\r\n}\r\n}\r\nide_timing_compute(drive, drive->pio_mode, &t, T, 1);\r\ntime_16 = clamp_val(t.recover - 1, 0, 15) |\r\n(clamp_val(t.active - 1, 0, 15) << 4);\r\ntime_8 = clamp_val(t.act8b - 1, 0, 15) |\r\n(clamp_val(t.rec8b - 1, 0, 15) << 4);\r\nif ((drive->dn & 1) == 0) {\r\npci_read_config_dword(dev, CY82_IDE_ADDRSETUP, &addrCtrl);\r\naddrCtrl &= (~0xF);\r\naddrCtrl |= clamp_val(t.setup - 1, 0, 15);\r\npci_write_config_dword(dev, CY82_IDE_ADDRSETUP, addrCtrl);\r\npci_write_config_byte(dev, CY82_IDE_MASTER_IOR, time_16);\r\npci_write_config_byte(dev, CY82_IDE_MASTER_IOW, time_16);\r\npci_write_config_byte(dev, CY82_IDE_MASTER_8BIT, time_8);\r\n} else {\r\npci_read_config_dword(dev, CY82_IDE_ADDRSETUP, &addrCtrl);\r\naddrCtrl &= (~0xF0);\r\naddrCtrl |= (clamp_val(t.setup - 1, 0, 15) << 4);\r\npci_write_config_dword(dev, CY82_IDE_ADDRSETUP, addrCtrl);\r\npci_write_config_byte(dev, CY82_IDE_SLAVE_IOR, time_16);\r\npci_write_config_byte(dev, CY82_IDE_SLAVE_IOW, time_16);\r\npci_write_config_byte(dev, CY82_IDE_SLAVE_8BIT, time_8);\r\n}\r\nif (drive->dn > 1)\r\npci_dev_put(dev);\r\n}\r\nstatic void __devinit init_iops_cy82c693(ide_hwif_t *hwif)\r\n{\r\nstatic ide_hwif_t *primary;\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nif (PCI_FUNC(dev->devfn) == 1)\r\nprimary = hwif;\r\nelse {\r\nhwif->mate = primary;\r\nhwif->channel = 1;\r\n}\r\n}\r\nstatic int __devinit cy82c693_init_one(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nstruct pci_dev *dev2;\r\nint ret = -ENODEV;\r\nif ((dev->class >> 8) == PCI_CLASS_STORAGE_IDE &&\r\nPCI_FUNC(dev->devfn) == 1) {\r\ndev2 = pci_get_slot(dev->bus, dev->devfn + 1);\r\nret = ide_pci_init_two(dev, dev2, &cy82c693_chipset, NULL);\r\nif (ret)\r\npci_dev_put(dev2);\r\n}\r\nreturn ret;\r\n}\r\nstatic void __devexit cy82c693_remove(struct pci_dev *dev)\r\n{\r\nstruct ide_host *host = pci_get_drvdata(dev);\r\nstruct pci_dev *dev2 = host->dev[1] ? to_pci_dev(host->dev[1]) : NULL;\r\nide_pci_remove(dev);\r\npci_dev_put(dev2);\r\n}\r\nstatic int __init cy82c693_ide_init(void)\r\n{\r\nreturn ide_pci_register_driver(&cy82c693_pci_driver);\r\n}\r\nstatic void __exit cy82c693_ide_exit(void)\r\n{\r\npci_unregister_driver(&cy82c693_pci_driver);\r\n}

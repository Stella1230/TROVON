int iio_simple_dummy_read_event_config(struct iio_dev *indio_dev,\r\nu64 event_code)\r\n{\r\nstruct iio_dummy_state *st = iio_priv(indio_dev);\r\nreturn st->event_en;\r\n}\r\nint iio_simple_dummy_write_event_config(struct iio_dev *indio_dev,\r\nu64 event_code,\r\nint state)\r\n{\r\nstruct iio_dummy_state *st = iio_priv(indio_dev);\r\nswitch (IIO_EVENT_CODE_EXTRACT_CHAN_TYPE(event_code)) {\r\ncase IIO_VOLTAGE:\r\nswitch (IIO_EVENT_CODE_EXTRACT_TYPE(event_code)) {\r\ncase IIO_EV_TYPE_THRESH:\r\nif (IIO_EVENT_CODE_EXTRACT_DIR(event_code) ==\r\nIIO_EV_DIR_RISING)\r\nst->event_en = state;\r\nelse\r\nreturn -EINVAL;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nint iio_simple_dummy_read_event_value(struct iio_dev *indio_dev,\r\nu64 event_code,\r\nint *val)\r\n{\r\nstruct iio_dummy_state *st = iio_priv(indio_dev);\r\n*val = st->event_val;\r\nreturn 0;\r\n}\r\nint iio_simple_dummy_write_event_value(struct iio_dev *indio_dev,\r\nu64 event_code,\r\nint val)\r\n{\r\nstruct iio_dummy_state *st = iio_priv(indio_dev);\r\nst->event_val = val;\r\nreturn 0;\r\n}\r\nstatic irqreturn_t iio_simple_dummy_event_handler(int irq, void *private)\r\n{\r\nstruct iio_dev *indio_dev = private;\r\niio_push_event(indio_dev,\r\nIIO_EVENT_CODE(IIO_VOLTAGE, 0, 0,\r\nIIO_EV_DIR_RISING,\r\nIIO_EV_TYPE_THRESH, 0, 0, 0),\r\niio_get_time_ns());\r\nreturn IRQ_HANDLED;\r\n}\r\nint iio_simple_dummy_events_register(struct iio_dev *indio_dev)\r\n{\r\nstruct iio_dummy_state *st = iio_priv(indio_dev);\r\nint ret;\r\nst->event_irq = iio_dummy_evgen_get_irq();\r\nif (st->event_irq < 0) {\r\nret = st->event_irq;\r\ngoto error_ret;\r\n}\r\nret = request_threaded_irq(st->event_irq,\r\nNULL,\r\n&iio_simple_dummy_event_handler,\r\nIRQF_ONESHOT,\r\n"iio_simple_event",\r\nindio_dev);\r\nif (ret < 0)\r\ngoto error_free_evgen;\r\nreturn 0;\r\nerror_free_evgen:\r\niio_dummy_evgen_release_irq(st->event_irq);\r\nerror_ret:\r\nreturn ret;\r\n}\r\nint iio_simple_dummy_events_unregister(struct iio_dev *indio_dev)\r\n{\r\nstruct iio_dummy_state *st = iio_priv(indio_dev);\r\nfree_irq(st->event_irq, indio_dev);\r\niio_dummy_evgen_release_irq(st->event_irq);\r\nreturn 0;\r\n}

static int srp_host_setup(struct transport_container *tc, struct device *dev,\r\nstruct device *cdev)\r\n{\r\nstruct Scsi_Host *shost = dev_to_shost(dev);\r\nstruct srp_host_attrs *srp_host = to_srp_host_attrs(shost);\r\natomic_set(&srp_host->next_port_id, 0);\r\nreturn 0;\r\n}\r\nstatic ssize_t\r\nshow_srp_rport_id(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct srp_rport *rport = transport_class_to_srp_rport(dev);\r\nreturn sprintf(buf, SRP_PID_FMT "\n", SRP_PID(rport));\r\n}\r\nstatic ssize_t\r\nshow_srp_rport_roles(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct srp_rport *rport = transport_class_to_srp_rport(dev);\r\nint i;\r\nchar *name = NULL;\r\nfor (i = 0; i < ARRAY_SIZE(srp_rport_role_names); i++)\r\nif (srp_rport_role_names[i].value == rport->roles) {\r\nname = srp_rport_role_names[i].name;\r\nbreak;\r\n}\r\nreturn sprintf(buf, "%s\n", name ? : "unknown");\r\n}\r\nstatic void srp_rport_release(struct device *dev)\r\n{\r\nstruct srp_rport *rport = dev_to_rport(dev);\r\nput_device(dev->parent);\r\nkfree(rport);\r\n}\r\nstatic int scsi_is_srp_rport(const struct device *dev)\r\n{\r\nreturn dev->release == srp_rport_release;\r\n}\r\nstatic int srp_rport_match(struct attribute_container *cont,\r\nstruct device *dev)\r\n{\r\nstruct Scsi_Host *shost;\r\nstruct srp_internal *i;\r\nif (!scsi_is_srp_rport(dev))\r\nreturn 0;\r\nshost = dev_to_shost(dev->parent);\r\nif (!shost->transportt)\r\nreturn 0;\r\nif (shost->transportt->host_attrs.ac.class != &srp_host_class.class)\r\nreturn 0;\r\ni = to_srp_internal(shost->transportt);\r\nreturn &i->rport_attr_cont.ac == cont;\r\n}\r\nstatic int srp_host_match(struct attribute_container *cont, struct device *dev)\r\n{\r\nstruct Scsi_Host *shost;\r\nstruct srp_internal *i;\r\nif (!scsi_is_host_device(dev))\r\nreturn 0;\r\nshost = dev_to_shost(dev);\r\nif (!shost->transportt)\r\nreturn 0;\r\nif (shost->transportt->host_attrs.ac.class != &srp_host_class.class)\r\nreturn 0;\r\ni = to_srp_internal(shost->transportt);\r\nreturn &i->t.host_attrs.ac == cont;\r\n}\r\nstruct srp_rport *srp_rport_add(struct Scsi_Host *shost,\r\nstruct srp_rport_identifiers *ids)\r\n{\r\nstruct srp_rport *rport;\r\nstruct device *parent = &shost->shost_gendev;\r\nint id, ret;\r\nrport = kzalloc(sizeof(*rport), GFP_KERNEL);\r\nif (!rport)\r\nreturn ERR_PTR(-ENOMEM);\r\ndevice_initialize(&rport->dev);\r\nrport->dev.parent = get_device(parent);\r\nrport->dev.release = srp_rport_release;\r\nmemcpy(rport->port_id, ids->port_id, sizeof(rport->port_id));\r\nrport->roles = ids->roles;\r\nid = atomic_inc_return(&to_srp_host_attrs(shost)->next_port_id);\r\ndev_set_name(&rport->dev, "port-%d:%d", shost->host_no, id);\r\ntransport_setup_device(&rport->dev);\r\nret = device_add(&rport->dev);\r\nif (ret) {\r\ntransport_destroy_device(&rport->dev);\r\nput_device(&rport->dev);\r\nreturn ERR_PTR(ret);\r\n}\r\nif (shost->active_mode & MODE_TARGET &&\r\nids->roles == SRP_RPORT_ROLE_INITIATOR) {\r\nret = srp_tgt_it_nexus_create(shost, (unsigned long)rport,\r\nrport->port_id);\r\nif (ret) {\r\ndevice_del(&rport->dev);\r\ntransport_destroy_device(&rport->dev);\r\nput_device(&rport->dev);\r\nreturn ERR_PTR(ret);\r\n}\r\n}\r\ntransport_add_device(&rport->dev);\r\ntransport_configure_device(&rport->dev);\r\nreturn rport;\r\n}\r\nvoid srp_rport_del(struct srp_rport *rport)\r\n{\r\nstruct device *dev = &rport->dev;\r\nstruct Scsi_Host *shost = dev_to_shost(dev->parent);\r\nif (shost->active_mode & MODE_TARGET &&\r\nrport->roles == SRP_RPORT_ROLE_INITIATOR)\r\nsrp_tgt_it_nexus_destroy(shost, (unsigned long)rport);\r\ntransport_remove_device(dev);\r\ndevice_del(dev);\r\ntransport_destroy_device(dev);\r\nput_device(dev);\r\n}\r\nstatic int do_srp_rport_del(struct device *dev, void *data)\r\n{\r\nif (scsi_is_srp_rport(dev))\r\nsrp_rport_del(dev_to_rport(dev));\r\nreturn 0;\r\n}\r\nvoid srp_remove_host(struct Scsi_Host *shost)\r\n{\r\ndevice_for_each_child(&shost->shost_gendev, NULL, do_srp_rport_del);\r\n}\r\nstatic int srp_tsk_mgmt_response(struct Scsi_Host *shost, u64 nexus, u64 tm_id,\r\nint result)\r\n{\r\nstruct srp_internal *i = to_srp_internal(shost->transportt);\r\nreturn i->f->tsk_mgmt_response(shost, nexus, tm_id, result);\r\n}\r\nstatic int srp_it_nexus_response(struct Scsi_Host *shost, u64 nexus, int result)\r\n{\r\nstruct srp_internal *i = to_srp_internal(shost->transportt);\r\nreturn i->f->it_nexus_response(shost, nexus, result);\r\n}\r\nstruct scsi_transport_template *\r\nsrp_attach_transport(struct srp_function_template *ft)\r\n{\r\nint count;\r\nstruct srp_internal *i;\r\ni = kzalloc(sizeof(*i), GFP_KERNEL);\r\nif (!i)\r\nreturn NULL;\r\ni->t.tsk_mgmt_response = srp_tsk_mgmt_response;\r\ni->t.it_nexus_response = srp_it_nexus_response;\r\ni->t.host_size = sizeof(struct srp_host_attrs);\r\ni->t.host_attrs.ac.attrs = &i->host_attrs[0];\r\ni->t.host_attrs.ac.class = &srp_host_class.class;\r\ni->t.host_attrs.ac.match = srp_host_match;\r\ni->host_attrs[0] = NULL;\r\ntransport_container_register(&i->t.host_attrs);\r\ni->rport_attr_cont.ac.attrs = &i->rport_attrs[0];\r\ni->rport_attr_cont.ac.class = &srp_rport_class.class;\r\ni->rport_attr_cont.ac.match = srp_rport_match;\r\ntransport_container_register(&i->rport_attr_cont);\r\ncount = 0;\r\nSETUP_RPORT_ATTRIBUTE_RD(port_id);\r\nSETUP_RPORT_ATTRIBUTE_RD(roles);\r\ni->rport_attrs[count] = NULL;\r\ni->f = ft;\r\nreturn &i->t;\r\n}\r\nvoid srp_release_transport(struct scsi_transport_template *t)\r\n{\r\nstruct srp_internal *i = to_srp_internal(t);\r\ntransport_container_unregister(&i->t.host_attrs);\r\ntransport_container_unregister(&i->rport_attr_cont);\r\nkfree(i);\r\n}\r\nstatic __init int srp_transport_init(void)\r\n{\r\nint ret;\r\nret = transport_class_register(&srp_host_class);\r\nif (ret)\r\nreturn ret;\r\nret = transport_class_register(&srp_rport_class);\r\nif (ret)\r\ngoto unregister_host_class;\r\nreturn 0;\r\nunregister_host_class:\r\ntransport_class_unregister(&srp_host_class);\r\nreturn ret;\r\n}\r\nstatic void __exit srp_transport_exit(void)\r\n{\r\ntransport_class_unregister(&srp_host_class);\r\ntransport_class_unregister(&srp_rport_class);\r\n}

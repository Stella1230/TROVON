static int rts51x_bulk_transport(struct us_data *us, u8 lun,\r\nu8 *cmd, int cmd_len, u8 *buf, int buf_len,\r\nenum dma_data_direction dir, int *act_len)\r\n{\r\nstruct bulk_cb_wrap *bcb = (struct bulk_cb_wrap *)us->iobuf;\r\nstruct bulk_cs_wrap *bcs = (struct bulk_cs_wrap *)us->iobuf;\r\nint result;\r\nunsigned int residue;\r\nunsigned int cswlen;\r\nunsigned int cbwlen = US_BULK_CB_WRAP_LEN;\r\nbcb->Signature = cpu_to_le32(US_BULK_CB_SIGN);\r\nbcb->DataTransferLength = cpu_to_le32(buf_len);\r\nbcb->Flags = (dir == DMA_FROM_DEVICE) ? US_BULK_FLAG_IN : 0;\r\nbcb->Tag = ++us->tag;\r\nbcb->Lun = lun;\r\nbcb->Length = cmd_len;\r\nmemset(bcb->CDB, 0, sizeof(bcb->CDB));\r\nmemcpy(bcb->CDB, cmd, bcb->Length);\r\nresult = usb_stor_bulk_transfer_buf(us, us->send_bulk_pipe,\r\nbcb, cbwlen, NULL);\r\nif (result != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nif (buf && buf_len) {\r\nunsigned int pipe = (dir == DMA_FROM_DEVICE) ?\r\nus->recv_bulk_pipe : us->send_bulk_pipe;\r\nresult = usb_stor_bulk_transfer_buf(us, pipe,\r\nbuf, buf_len, NULL);\r\nif (result == USB_STOR_XFER_ERROR)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\n}\r\nresult = usb_stor_bulk_transfer_buf(us, us->recv_bulk_pipe,\r\nbcs, US_BULK_CS_WRAP_LEN, &cswlen);\r\nif (result != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nif (bcs->Signature != cpu_to_le32(US_BULK_CS_SIGN)) {\r\nUS_DEBUGP("Signature mismatch: got %08X, expecting %08X\n",\r\nle32_to_cpu(bcs->Signature), US_BULK_CS_SIGN);\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\n}\r\nresidue = bcs->Residue;\r\nif (bcs->Tag != us->tag)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nif (residue)\r\nresidue = residue < buf_len ? residue : buf_len;\r\nif (act_len)\r\n*act_len = buf_len - residue;\r\nswitch (bcs->Status) {\r\ncase US_BULK_STAT_OK:\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\ncase US_BULK_STAT_FAIL:\r\nreturn USB_STOR_TRANSPORT_FAILED;\r\ncase US_BULK_STAT_PHASE:\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\n}\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\n}\r\nstatic int rts51x_bulk_transport_special(struct us_data *us, u8 lun,\r\nu8 *cmd, int cmd_len, u8 *buf, int buf_len,\r\nenum dma_data_direction dir, int *act_len)\r\n{\r\nstruct bulk_cb_wrap *bcb = (struct bulk_cb_wrap *) us->iobuf;\r\nstruct bulk_cs_wrap *bcs = (struct bulk_cs_wrap *) us->iobuf;\r\nint result;\r\nunsigned int cswlen;\r\nunsigned int cbwlen = US_BULK_CB_WRAP_LEN;\r\nbcb->Signature = cpu_to_le32(US_BULK_CB_SIGN);\r\nbcb->DataTransferLength = cpu_to_le32(buf_len);\r\nbcb->Flags = (dir == DMA_FROM_DEVICE) ? US_BULK_FLAG_IN : 0;\r\nbcb->Tag = ++us->tag;\r\nbcb->Lun = lun;\r\nbcb->Length = cmd_len;\r\nmemset(bcb->CDB, 0, sizeof(bcb->CDB));\r\nmemcpy(bcb->CDB, cmd, bcb->Length);\r\nresult = usb_stor_bulk_transfer_buf(us, us->send_bulk_pipe,\r\nbcb, cbwlen, NULL);\r\nif (result != USB_STOR_XFER_GOOD)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nif (buf && buf_len) {\r\nunsigned int pipe = (dir == DMA_FROM_DEVICE) ?\r\nus->recv_bulk_pipe : us->send_bulk_pipe;\r\nresult = usb_stor_bulk_transfer_buf(us, pipe,\r\nbuf, buf_len, NULL);\r\nif (result == USB_STOR_XFER_ERROR)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\n}\r\nresult = usb_bulk_msg(us->pusb_dev, us->recv_bulk_pipe, bcs,\r\nUS_BULK_CS_WRAP_LEN, &cswlen, 250);\r\nreturn result;\r\n}\r\nstatic int rts51x_get_max_lun(struct us_data *us)\r\n{\r\nint result;\r\nus->iobuf[0] = 0;\r\nresult = usb_stor_control_msg(us, us->recv_ctrl_pipe,\r\nUS_BULK_GET_MAX_LUN,\r\nUSB_DIR_IN | USB_TYPE_CLASS |\r\nUSB_RECIP_INTERFACE,\r\n0, us->ifnum, us->iobuf, 1, 10 * HZ);\r\nUS_DEBUGP("GetMaxLUN command result is %d, data is %d\n",\r\nresult, us->iobuf[0]);\r\nif (result > 0)\r\nreturn us->iobuf[0];\r\nreturn 0;\r\n}\r\nstatic int rts51x_read_mem(struct us_data *us, u16 addr, u8 *data, u16 len)\r\n{\r\nint retval;\r\nu8 cmnd[12] = { 0 };\r\nu8 *buf;\r\nbuf = kmalloc(len, GFP_NOIO);\r\nif (buf == NULL)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nUS_DEBUGP("%s, addr = 0x%x, len = %d\n", __func__, addr, len);\r\ncmnd[0] = 0xF0;\r\ncmnd[1] = 0x0D;\r\ncmnd[2] = (u8) (addr >> 8);\r\ncmnd[3] = (u8) addr;\r\ncmnd[4] = (u8) (len >> 8);\r\ncmnd[5] = (u8) len;\r\nretval = rts51x_bulk_transport(us, 0, cmnd, 12,\r\nbuf, len, DMA_FROM_DEVICE, NULL);\r\nif (retval != USB_STOR_TRANSPORT_GOOD) {\r\nkfree(buf);\r\nreturn -EIO;\r\n}\r\nmemcpy(data, buf, len);\r\nkfree(buf);\r\nreturn 0;\r\n}\r\nstatic int rts51x_write_mem(struct us_data *us, u16 addr, u8 *data, u16 len)\r\n{\r\nint retval;\r\nu8 cmnd[12] = { 0 };\r\nu8 *buf;\r\nbuf = kmemdup(data, len, GFP_NOIO);\r\nif (buf == NULL)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nUS_DEBUGP("%s, addr = 0x%x, len = %d\n", __func__, addr, len);\r\ncmnd[0] = 0xF0;\r\ncmnd[1] = 0x0E;\r\ncmnd[2] = (u8) (addr >> 8);\r\ncmnd[3] = (u8) addr;\r\ncmnd[4] = (u8) (len >> 8);\r\ncmnd[5] = (u8) len;\r\nretval = rts51x_bulk_transport(us, 0, cmnd, 12,\r\nbuf, len, DMA_TO_DEVICE, NULL);\r\nkfree(buf);\r\nif (retval != USB_STOR_TRANSPORT_GOOD)\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic int rts51x_read_status(struct us_data *us,\r\nu8 lun, u8 *status, int len, int *actlen)\r\n{\r\nint retval;\r\nu8 cmnd[12] = { 0 };\r\nu8 *buf;\r\nbuf = kmalloc(len, GFP_NOIO);\r\nif (buf == NULL)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nUS_DEBUGP("%s, lun = %d\n", __func__, lun);\r\ncmnd[0] = 0xF0;\r\ncmnd[1] = 0x09;\r\nretval = rts51x_bulk_transport(us, lun, cmnd, 12,\r\nbuf, len, DMA_FROM_DEVICE, actlen);\r\nif (retval != USB_STOR_TRANSPORT_GOOD) {\r\nkfree(buf);\r\nreturn -EIO;\r\n}\r\nmemcpy(status, buf, len);\r\nkfree(buf);\r\nreturn 0;\r\n}\r\nstatic int rts51x_check_status(struct us_data *us, u8 lun)\r\n{\r\nstruct rts51x_chip *chip = (struct rts51x_chip *)(us->extra);\r\nint retval;\r\nu8 buf[16];\r\nretval = rts51x_read_status(us, lun, buf, 16, &(chip->status_len));\r\nif (retval < 0)\r\nreturn -EIO;\r\nUS_DEBUGP("chip->status_len = %d\n", chip->status_len);\r\nchip->status[lun].vid = ((u16) buf[0] << 8) | buf[1];\r\nchip->status[lun].pid = ((u16) buf[2] << 8) | buf[3];\r\nchip->status[lun].cur_lun = buf[4];\r\nchip->status[lun].card_type = buf[5];\r\nchip->status[lun].total_lun = buf[6];\r\nchip->status[lun].fw_ver = ((u16) buf[7] << 8) | buf[8];\r\nchip->status[lun].phy_exist = buf[9];\r\nchip->status[lun].multi_flag = buf[10];\r\nchip->status[lun].multi_card = buf[11];\r\nchip->status[lun].log_exist = buf[12];\r\nif (chip->status_len == 16) {\r\nchip->status[lun].detailed_type.detailed_type1 = buf[13];\r\nchip->status[lun].function[0] = buf[14];\r\nchip->status[lun].function[1] = buf[15];\r\n}\r\nreturn 0;\r\n}\r\nstatic int enable_oscillator(struct us_data *us)\r\n{\r\nint retval;\r\nu8 value;\r\nretval = rts51x_read_mem(us, 0xFE77, &value, 1);\r\nif (retval < 0)\r\nreturn -EIO;\r\nvalue |= 0x04;\r\nretval = rts51x_write_mem(us, 0xFE77, &value, 1);\r\nif (retval < 0)\r\nreturn -EIO;\r\nretval = rts51x_read_mem(us, 0xFE77, &value, 1);\r\nif (retval < 0)\r\nreturn -EIO;\r\nif (!(value & 0x04))\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic int __do_config_autodelink(struct us_data *us, u8 *data, u16 len)\r\n{\r\nint retval;\r\nu8 cmnd[12] = {0};\r\nu8 *buf;\r\nUS_DEBUGP("%s, addr = 0xfe47, len = %d\n", __FUNCTION__, len);\r\nbuf = kmemdup(data, len, GFP_NOIO);\r\nif (!buf)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\ncmnd[0] = 0xF0;\r\ncmnd[1] = 0x0E;\r\ncmnd[2] = 0xfe;\r\ncmnd[3] = 0x47;\r\ncmnd[4] = (u8)(len >> 8);\r\ncmnd[5] = (u8)len;\r\nretval = rts51x_bulk_transport_special(us, 0, cmnd, 12, buf, len, DMA_TO_DEVICE, NULL);\r\nkfree(buf);\r\nif (retval != USB_STOR_TRANSPORT_GOOD) {\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int do_config_autodelink(struct us_data *us, int enable, int force)\r\n{\r\nint retval;\r\nu8 value;\r\nretval = rts51x_read_mem(us, 0xFE47, &value, 1);\r\nif (retval < 0)\r\nreturn -EIO;\r\nif (enable) {\r\nif (force)\r\nvalue |= 0x03;\r\nelse\r\nvalue |= 0x01;\r\n} else {\r\nvalue &= ~0x03;\r\n}\r\nUS_DEBUGP("In %s,set 0xfe47 to 0x%x\n", __func__, value);\r\nretval = __do_config_autodelink(us, &value, 1);\r\nif (retval < 0)\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic int config_autodelink_after_power_on(struct us_data *us)\r\n{\r\nstruct rts51x_chip *chip = (struct rts51x_chip *)(us->extra);\r\nint retval;\r\nu8 value;\r\nUS_DEBUGP("%s: <---\n", __func__);\r\nif (!CHK_AUTO_DELINK(chip))\r\nreturn 0;\r\nretval = rts51x_read_mem(us, 0xFE47, &value, 1);\r\nif (retval < 0)\r\nreturn -EIO;\r\nif (auto_delink_en) {\r\nCLR_BIT(value, 0);\r\nCLR_BIT(value, 1);\r\nSET_BIT(value, 2);\r\nif (CHECK_ID(chip, 0x0138, 0x3882))\r\nCLR_BIT(value, 2);\r\nSET_BIT(value, 7);\r\nretval = __do_config_autodelink(us, &value, 1);\r\nif (retval < 0)\r\nreturn -EIO;\r\nretval = enable_oscillator(us);\r\nif (retval == 0)\r\n(void)do_config_autodelink(us, 1, 0);\r\n} else {\r\nSET_BIT(value, 2);\r\nif (CHECK_ID(chip, 0x0138, 0x3882))\r\nCLR_BIT(value, 2);\r\nif (CHECK_ID(chip, 0x0159, 0x5889) ||\r\nCHECK_ID(chip, 0x0138, 0x3880)) {\r\nCLR_BIT(value, 0);\r\nCLR_BIT(value, 7);\r\n}\r\nretval = __do_config_autodelink(us, &value, 1);\r\nif (retval < 0)\r\nreturn -EIO;\r\nif (CHECK_ID(chip, 0x0159, 0x5888)) {\r\nvalue = 0xFF;\r\nretval = rts51x_write_mem(us, 0xFE79, &value, 1);\r\nif (retval < 0)\r\nreturn -EIO;\r\nvalue = 0x01;\r\nretval = rts51x_write_mem(us, 0x48, &value, 1);\r\nif (retval < 0)\r\nreturn -EIO;\r\n}\r\n}\r\nUS_DEBUGP("%s: --->\n", __func__);\r\nreturn 0;\r\n}\r\nstatic int config_autodelink_before_power_down(struct us_data *us)\r\n{\r\nstruct rts51x_chip *chip = (struct rts51x_chip *)(us->extra);\r\nint retval;\r\nu8 value;\r\nUS_DEBUGP("%s: <---\n", __func__);\r\nif (!CHK_AUTO_DELINK(chip))\r\nreturn 0;\r\nif (auto_delink_en) {\r\nretval = rts51x_read_mem(us, 0xFE77, &value, 1);\r\nif (retval < 0)\r\nreturn -EIO;\r\nSET_BIT(value, 2);\r\nretval = rts51x_write_mem(us, 0xFE77, &value, 1);\r\nif (retval < 0)\r\nreturn -EIO;\r\nif (CHECK_ID(chip, 0x0159, 0x5888)) {\r\nvalue = 0x01;\r\nretval = rts51x_write_mem(us, 0x48, &value, 1);\r\nif (retval < 0)\r\nreturn -EIO;\r\n}\r\nretval = rts51x_read_mem(us, 0xFE47, &value, 1);\r\nif (retval < 0)\r\nreturn -EIO;\r\nSET_BIT(value, 0);\r\nif (CHECK_ID(chip, 0x0138, 0x3882))\r\nSET_BIT(value, 2);\r\nretval = rts51x_write_mem(us, 0xFE77, &value, 1);\r\nif (retval < 0)\r\nreturn -EIO;\r\n} else {\r\nif (CHECK_ID(chip, 0x0159, 0x5889) ||\r\nCHECK_ID(chip, 0x0138, 0x3880) ||\r\nCHECK_ID(chip, 0x0138, 0x3882)) {\r\nretval = rts51x_read_mem(us, 0xFE47, &value, 1);\r\nif (retval < 0)\r\nreturn -EIO;\r\nif (CHECK_ID(chip, 0x0159, 0x5889) ||\r\nCHECK_ID(chip, 0x0138, 0x3880)) {\r\nSET_BIT(value, 0);\r\nSET_BIT(value, 7);\r\n}\r\nif (CHECK_ID(chip, 0x0138, 0x3882))\r\nSET_BIT(value, 2);\r\nretval = __do_config_autodelink(us, &value, 1);\r\nif (retval < 0)\r\nreturn -EIO;\r\n}\r\nif (CHECK_ID(chip, 0x0159, 0x5888)) {\r\nvalue = 0x01;\r\nretval = rts51x_write_mem(us, 0x48, &value, 1);\r\nif (retval < 0)\r\nreturn -EIO;\r\n}\r\n}\r\nUS_DEBUGP("%s: --->\n", __func__);\r\nreturn 0;\r\n}\r\nstatic void fw5895_init(struct us_data *us)\r\n{\r\nstruct rts51x_chip *chip = (struct rts51x_chip *)(us->extra);\r\nint retval;\r\nu8 val;\r\nUS_DEBUGP("%s: <---\n", __func__);\r\nif ((PRODUCT_ID(chip) != 0x0158) || (FW_VERSION(chip) != 0x5895)) {\r\nUS_DEBUGP("Not the specified device, return immediately!\n");\r\n} else {\r\nretval = rts51x_read_mem(us, 0xFD6F, &val, 1);\r\nif (retval == STATUS_SUCCESS && (val & 0x1F) == 0) {\r\nval = 0x1F;\r\nretval = rts51x_write_mem(us, 0xFD70, &val, 1);\r\nif (retval != STATUS_SUCCESS)\r\nUS_DEBUGP("Write memory fail\n");\r\n} else {\r\nUS_DEBUGP("Read memory fail, OR (val & 0x1F) != 0\n");\r\n}\r\n}\r\nUS_DEBUGP("%s: --->\n", __func__);\r\n}\r\nstatic void fw5895_set_mmc_wp(struct us_data *us)\r\n{\r\nstruct rts51x_chip *chip = (struct rts51x_chip *)(us->extra);\r\nint retval;\r\nu8 buf[13];\r\nUS_DEBUGP("%s: <---\n", __func__);\r\nif ((PRODUCT_ID(chip) != 0x0158) || (FW_VERSION(chip) != 0x5895)) {\r\nUS_DEBUGP("Not the specified device, return immediately!\n");\r\n} else {\r\nretval = rts51x_read_mem(us, 0xFD6F, buf, 1);\r\nif (retval == STATUS_SUCCESS && (buf[0] & 0x24) == 0x24) {\r\nretval = rts51x_read_mem(us, 0xD04E, buf, 1);\r\nif (retval == STATUS_SUCCESS) {\r\nbuf[0] |= 0x04;\r\nretval = rts51x_write_mem(us, 0xFD70, buf, 1);\r\nif (retval != STATUS_SUCCESS)\r\nUS_DEBUGP("Write memory fail\n");\r\n} else {\r\nUS_DEBUGP("Read memory fail\n");\r\n}\r\n} else {\r\nUS_DEBUGP("Read memory fail, OR (buf[0]&0x24)!=0x24\n");\r\n}\r\n}\r\nUS_DEBUGP("%s: --->\n", __func__);\r\n}\r\nstatic void rts51x_modi_suspend_timer(struct rts51x_chip *chip)\r\n{\r\nUS_DEBUGP("%s: <---, state:%d\n", __func__, rts51x_get_stat(chip));\r\nchip->timer_expires = jiffies + msecs_to_jiffies(1000*ss_delay);\r\nmod_timer(&chip->rts51x_suspend_timer, chip->timer_expires);\r\nUS_DEBUGP("%s: --->\n", __func__);\r\n}\r\nstatic void rts51x_suspend_timer_fn(unsigned long data)\r\n{\r\nstruct rts51x_chip *chip = (struct rts51x_chip *)data;\r\nstruct us_data *us = chip->us;\r\nUS_DEBUGP("%s: <---\n", __func__);\r\nswitch (rts51x_get_stat(chip)) {\r\ncase RTS51X_STAT_INIT:\r\ncase RTS51X_STAT_RUN:\r\nrts51x_modi_suspend_timer(chip);\r\nbreak;\r\ncase RTS51X_STAT_IDLE:\r\ncase RTS51X_STAT_SS:\r\nUS_DEBUGP("%s: RTS51X_STAT_SS, intf->pm_usage_cnt:%d,"\r\n"power.usage:%d\n", __func__,\r\natomic_read(&us->pusb_intf->pm_usage_cnt),\r\natomic_read(&us->pusb_intf->dev.power.usage_count));\r\nif (atomic_read(&us->pusb_intf->pm_usage_cnt) > 0) {\r\nUS_DEBUGP("%s: Ready to enter SS state.\n",\r\n__func__);\r\nrts51x_set_stat(chip, RTS51X_STAT_SS);\r\npm_suspend_ignore_children(&us->pusb_intf->dev, true);\r\nusb_autopm_put_interface_async(us->pusb_intf);\r\nUS_DEBUGP("%s: RTS51X_STAT_SS 01,"\r\n"intf->pm_usage_cnt:%d, power.usage:%d\n",\r\n__func__,\r\natomic_read(&us->pusb_intf->pm_usage_cnt),\r\natomic_read(\r\n&us->pusb_intf->dev.power.usage_count));\r\n}\r\nbreak;\r\ndefault:\r\nUS_DEBUGP("%s: Unknonwn state !!!\n", __func__);\r\nbreak;\r\n}\r\nUS_DEBUGP("%s: --->\n", __func__);\r\n}\r\nstatic inline int working_scsi(struct scsi_cmnd *srb)\r\n{\r\nif ((srb->cmnd[0] == TEST_UNIT_READY) ||\r\n(srb->cmnd[0] == ALLOW_MEDIUM_REMOVAL)) {\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic void rts51x_invoke_transport(struct scsi_cmnd *srb, struct us_data *us)\r\n{\r\nstruct rts51x_chip *chip = (struct rts51x_chip *)(us->extra);\r\nstatic int card_first_show = 1;\r\nstatic u8 media_not_present[] = { 0x70, 0, 0x02, 0, 0, 0, 0,\r\n10, 0, 0, 0, 0, 0x3A, 0, 0, 0, 0, 0\r\n};\r\nstatic u8 invalid_cmd_field[] = { 0x70, 0, 0x05, 0, 0, 0, 0,\r\n10, 0, 0, 0, 0, 0x24, 0, 0, 0, 0, 0\r\n};\r\nint ret;\r\nUS_DEBUGP("%s: <---\n", __func__);\r\nif (working_scsi(srb)) {\r\nUS_DEBUGP("%s: working scsi, intf->pm_usage_cnt:%d,"\r\n"power.usage:%d\n", __func__,\r\natomic_read(&us->pusb_intf->pm_usage_cnt),\r\natomic_read(&us->pusb_intf->dev.power.usage_count));\r\nif (atomic_read(&us->pusb_intf->pm_usage_cnt) <= 0) {\r\nret = usb_autopm_get_interface(us->pusb_intf);\r\nUS_DEBUGP("%s: working scsi, ret=%d\n", __func__, ret);\r\n}\r\nif (rts51x_get_stat(chip) != RTS51X_STAT_RUN)\r\nrts51x_set_stat(chip, RTS51X_STAT_RUN);\r\nchip->proto_handler_backup(srb, us);\r\n} else {\r\nif (rts51x_get_stat(chip) == RTS51X_STAT_SS) {\r\nUS_DEBUGP("%s: NOT working scsi\n", __func__);\r\nif ((srb->cmnd[0] == TEST_UNIT_READY) &&\r\n(chip->pwr_state == US_SUSPEND)) {\r\nif (TST_LUN_READY(chip, srb->device->lun)) {\r\nsrb->result = SAM_STAT_GOOD;\r\n} else {\r\nsrb->result = SAM_STAT_CHECK_CONDITION;\r\nmemcpy(srb->sense_buffer,\r\nmedia_not_present,\r\nUS_SENSE_SIZE);\r\n}\r\nUS_DEBUGP("%s: TEST_UNIT_READY--->\n",\r\n__func__);\r\ngoto out;\r\n}\r\nif (srb->cmnd[0] == ALLOW_MEDIUM_REMOVAL) {\r\nint prevent = srb->cmnd[4] & 0x1;\r\nif (prevent) {\r\nsrb->result = SAM_STAT_CHECK_CONDITION;\r\nmemcpy(srb->sense_buffer,\r\ninvalid_cmd_field,\r\nUS_SENSE_SIZE);\r\n} else {\r\nsrb->result = SAM_STAT_GOOD;\r\n}\r\nUS_DEBUGP("%s: ALLOW_MEDIUM_REMOVAL--->\n",\r\n__func__);\r\ngoto out;\r\n}\r\n} else {\r\nUS_DEBUGP("%s: NOT working scsi, not SS\n", __func__);\r\nchip->proto_handler_backup(srb, us);\r\nif (srb->cmnd[0] == TEST_UNIT_READY) {\r\nif (srb->result == SAM_STAT_GOOD) {\r\nSET_LUN_READY(chip, srb->device->lun);\r\nif (card_first_show) {\r\ncard_first_show = 0;\r\nfw5895_set_mmc_wp(us);\r\n}\r\n} else {\r\nCLR_LUN_READY(chip, srb->device->lun);\r\ncard_first_show = 1;\r\n}\r\n}\r\nif (rts51x_get_stat(chip) != RTS51X_STAT_IDLE)\r\nrts51x_set_stat(chip, RTS51X_STAT_IDLE);\r\n}\r\n}\r\nout:\r\nUS_DEBUGP("%s: state:%d\n", __func__, rts51x_get_stat(chip));\r\nif (rts51x_get_stat(chip) == RTS51X_STAT_RUN)\r\nrts51x_modi_suspend_timer(chip);\r\nUS_DEBUGP("%s: --->\n", __func__);\r\n}\r\nstatic int realtek_cr_autosuspend_setup(struct us_data *us)\r\n{\r\nstruct rts51x_chip *chip;\r\nstruct rts51x_status *status = NULL;\r\nu8 buf[16];\r\nint retval;\r\nchip = (struct rts51x_chip *)us->extra;\r\nchip->support_auto_delink = 0;\r\nchip->pwr_state = US_RESUME;\r\nchip->lun_ready = 0;\r\nrts51x_set_stat(chip, RTS51X_STAT_INIT);\r\nretval = rts51x_read_status(us, 0, buf, 16, &(chip->status_len));\r\nif (retval != STATUS_SUCCESS) {\r\nUS_DEBUGP("Read status fail\n");\r\nreturn -EIO;\r\n}\r\nstatus = chip->status;\r\nstatus->vid = ((u16) buf[0] << 8) | buf[1];\r\nstatus->pid = ((u16) buf[2] << 8) | buf[3];\r\nstatus->cur_lun = buf[4];\r\nstatus->card_type = buf[5];\r\nstatus->total_lun = buf[6];\r\nstatus->fw_ver = ((u16) buf[7] << 8) | buf[8];\r\nstatus->phy_exist = buf[9];\r\nstatus->multi_flag = buf[10];\r\nstatus->multi_card = buf[11];\r\nstatus->log_exist = buf[12];\r\nif (chip->status_len == 16) {\r\nstatus->detailed_type.detailed_type1 = buf[13];\r\nstatus->function[0] = buf[14];\r\nstatus->function[1] = buf[15];\r\n}\r\nchip = (struct rts51x_chip *)(us->extra);\r\nchip->proto_handler_backup = us->proto_handler;\r\npm_runtime_set_autosuspend_delay(&us->pusb_dev->dev, 0);\r\nus->proto_handler = rts51x_invoke_transport;\r\nchip->timer_expires = 0;\r\nsetup_timer(&chip->rts51x_suspend_timer, rts51x_suspend_timer_fn,\r\n(unsigned long)chip);\r\nfw5895_init(us);\r\nusb_enable_autosuspend(us->pusb_dev);\r\nreturn 0;\r\n}\r\nstatic void realtek_cr_destructor(void *extra)\r\n{\r\nstruct rts51x_chip *chip = (struct rts51x_chip *)extra;\r\nUS_DEBUGP("%s: <---\n", __func__);\r\nif (!chip)\r\nreturn;\r\n#ifdef CONFIG_REALTEK_AUTOPM\r\nif (ss_en) {\r\ndel_timer(&chip->rts51x_suspend_timer);\r\nchip->timer_expires = 0;\r\n}\r\n#endif\r\nkfree(chip->status);\r\n}\r\nstatic int realtek_cr_suspend(struct usb_interface *iface, pm_message_t message)\r\n{\r\nstruct us_data *us = usb_get_intfdata(iface);\r\nUS_DEBUGP("%s: <---\n", __func__);\r\nmutex_lock(&us->dev_mutex);\r\nconfig_autodelink_before_power_down(us);\r\nmutex_unlock(&us->dev_mutex);\r\nUS_DEBUGP("%s: --->\n", __func__);\r\nreturn 0;\r\n}\r\nstatic int realtek_cr_resume(struct usb_interface *iface)\r\n{\r\nstruct us_data *us = usb_get_intfdata(iface);\r\nUS_DEBUGP("%s: <---\n", __func__);\r\nfw5895_init(us);\r\nconfig_autodelink_after_power_on(us);\r\nUS_DEBUGP("%s: --->\n", __func__);\r\nreturn 0;\r\n}\r\nstatic int init_realtek_cr(struct us_data *us)\r\n{\r\nstruct rts51x_chip *chip;\r\nint size, i, retval;\r\nchip = kzalloc(sizeof(struct rts51x_chip), GFP_KERNEL);\r\nif (!chip)\r\nreturn -ENOMEM;\r\nus->extra = chip;\r\nus->extra_destructor = realtek_cr_destructor;\r\nus->max_lun = chip->max_lun = rts51x_get_max_lun(us);\r\nUS_DEBUGP("chip->max_lun = %d\n", chip->max_lun);\r\nsize = (chip->max_lun + 1) * sizeof(struct rts51x_status);\r\nchip->status = kzalloc(size, GFP_KERNEL);\r\nif (!chip->status)\r\ngoto INIT_FAIL;\r\nfor (i = 0; i <= (int)(chip->max_lun); i++) {\r\nretval = rts51x_check_status(us, (u8) i);\r\nif (retval < 0)\r\ngoto INIT_FAIL;\r\n}\r\nif (CHECK_FW_VER(chip, 0x5888) || CHECK_FW_VER(chip, 0x5889) ||\r\nCHECK_FW_VER(chip, 0x5901))\r\nSET_AUTO_DELINK(chip);\r\nif (STATUS_LEN(chip) == 16) {\r\nif (SUPPORT_AUTO_DELINK(chip))\r\nSET_AUTO_DELINK(chip);\r\n}\r\n#ifdef CONFIG_REALTEK_AUTOPM\r\nif (ss_en) {\r\nchip->us = us;\r\nrealtek_cr_autosuspend_setup(us);\r\n}\r\n#endif\r\nUS_DEBUGP("chip->flag = 0x%x\n", chip->flag);\r\n(void)config_autodelink_after_power_on(us);\r\nreturn 0;\r\nINIT_FAIL:\r\nif (us->extra) {\r\nkfree(chip->status);\r\nkfree(us->extra);\r\nus->extra = NULL;\r\n}\r\nreturn -EIO;\r\n}\r\nstatic int realtek_cr_probe(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct us_data *us;\r\nint result;\r\nUS_DEBUGP("Probe Realtek Card Reader!\n");\r\nresult = usb_stor_probe1(&us, intf, id,\r\n(id - realtek_cr_ids) +\r\nrealtek_cr_unusual_dev_list);\r\nif (result)\r\nreturn result;\r\nresult = usb_stor_probe2(us);\r\nreturn result;\r\n}

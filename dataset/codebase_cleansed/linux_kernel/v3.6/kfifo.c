static inline unsigned int kfifo_unused(struct __kfifo *fifo)\r\n{\r\nreturn (fifo->mask + 1) - (fifo->in - fifo->out);\r\n}\r\nint __kfifo_alloc(struct __kfifo *fifo, unsigned int size,\r\nsize_t esize, gfp_t gfp_mask)\r\n{\r\nif (!is_power_of_2(size))\r\nsize = rounddown_pow_of_two(size);\r\nfifo->in = 0;\r\nfifo->out = 0;\r\nfifo->esize = esize;\r\nif (size < 2) {\r\nfifo->data = NULL;\r\nfifo->mask = 0;\r\nreturn -EINVAL;\r\n}\r\nfifo->data = kmalloc(size * esize, gfp_mask);\r\nif (!fifo->data) {\r\nfifo->mask = 0;\r\nreturn -ENOMEM;\r\n}\r\nfifo->mask = size - 1;\r\nreturn 0;\r\n}\r\nvoid __kfifo_free(struct __kfifo *fifo)\r\n{\r\nkfree(fifo->data);\r\nfifo->in = 0;\r\nfifo->out = 0;\r\nfifo->esize = 0;\r\nfifo->data = NULL;\r\nfifo->mask = 0;\r\n}\r\nint __kfifo_init(struct __kfifo *fifo, void *buffer,\r\nunsigned int size, size_t esize)\r\n{\r\nsize /= esize;\r\nif (!is_power_of_2(size))\r\nsize = rounddown_pow_of_two(size);\r\nfifo->in = 0;\r\nfifo->out = 0;\r\nfifo->esize = esize;\r\nfifo->data = buffer;\r\nif (size < 2) {\r\nfifo->mask = 0;\r\nreturn -EINVAL;\r\n}\r\nfifo->mask = size - 1;\r\nreturn 0;\r\n}\r\nstatic void kfifo_copy_in(struct __kfifo *fifo, const void *src,\r\nunsigned int len, unsigned int off)\r\n{\r\nunsigned int size = fifo->mask + 1;\r\nunsigned int esize = fifo->esize;\r\nunsigned int l;\r\noff &= fifo->mask;\r\nif (esize != 1) {\r\noff *= esize;\r\nsize *= esize;\r\nlen *= esize;\r\n}\r\nl = min(len, size - off);\r\nmemcpy(fifo->data + off, src, l);\r\nmemcpy(fifo->data, src + l, len - l);\r\nsmp_wmb();\r\n}\r\nunsigned int __kfifo_in(struct __kfifo *fifo,\r\nconst void *buf, unsigned int len)\r\n{\r\nunsigned int l;\r\nl = kfifo_unused(fifo);\r\nif (len > l)\r\nlen = l;\r\nkfifo_copy_in(fifo, buf, len, fifo->in);\r\nfifo->in += len;\r\nreturn len;\r\n}\r\nstatic void kfifo_copy_out(struct __kfifo *fifo, void *dst,\r\nunsigned int len, unsigned int off)\r\n{\r\nunsigned int size = fifo->mask + 1;\r\nunsigned int esize = fifo->esize;\r\nunsigned int l;\r\noff &= fifo->mask;\r\nif (esize != 1) {\r\noff *= esize;\r\nsize *= esize;\r\nlen *= esize;\r\n}\r\nl = min(len, size - off);\r\nmemcpy(dst, fifo->data + off, l);\r\nmemcpy(dst + l, fifo->data, len - l);\r\nsmp_wmb();\r\n}\r\nunsigned int __kfifo_out_peek(struct __kfifo *fifo,\r\nvoid *buf, unsigned int len)\r\n{\r\nunsigned int l;\r\nl = fifo->in - fifo->out;\r\nif (len > l)\r\nlen = l;\r\nkfifo_copy_out(fifo, buf, len, fifo->out);\r\nreturn len;\r\n}\r\nunsigned int __kfifo_out(struct __kfifo *fifo,\r\nvoid *buf, unsigned int len)\r\n{\r\nlen = __kfifo_out_peek(fifo, buf, len);\r\nfifo->out += len;\r\nreturn len;\r\n}\r\nstatic unsigned long kfifo_copy_from_user(struct __kfifo *fifo,\r\nconst void __user *from, unsigned int len, unsigned int off,\r\nunsigned int *copied)\r\n{\r\nunsigned int size = fifo->mask + 1;\r\nunsigned int esize = fifo->esize;\r\nunsigned int l;\r\nunsigned long ret;\r\noff &= fifo->mask;\r\nif (esize != 1) {\r\noff *= esize;\r\nsize *= esize;\r\nlen *= esize;\r\n}\r\nl = min(len, size - off);\r\nret = copy_from_user(fifo->data + off, from, l);\r\nif (unlikely(ret))\r\nret = DIV_ROUND_UP(ret + len - l, esize);\r\nelse {\r\nret = copy_from_user(fifo->data, from + l, len - l);\r\nif (unlikely(ret))\r\nret = DIV_ROUND_UP(ret, esize);\r\n}\r\nsmp_wmb();\r\n*copied = len - ret;\r\nreturn ret;\r\n}\r\nint __kfifo_from_user(struct __kfifo *fifo, const void __user *from,\r\nunsigned long len, unsigned int *copied)\r\n{\r\nunsigned int l;\r\nunsigned long ret;\r\nunsigned int esize = fifo->esize;\r\nint err;\r\nif (esize != 1)\r\nlen /= esize;\r\nl = kfifo_unused(fifo);\r\nif (len > l)\r\nlen = l;\r\nret = kfifo_copy_from_user(fifo, from, len, fifo->in, copied);\r\nif (unlikely(ret)) {\r\nlen -= ret;\r\nerr = -EFAULT;\r\n} else\r\nerr = 0;\r\nfifo->in += len;\r\nreturn err;\r\n}\r\nstatic unsigned long kfifo_copy_to_user(struct __kfifo *fifo, void __user *to,\r\nunsigned int len, unsigned int off, unsigned int *copied)\r\n{\r\nunsigned int l;\r\nunsigned long ret;\r\nunsigned int size = fifo->mask + 1;\r\nunsigned int esize = fifo->esize;\r\noff &= fifo->mask;\r\nif (esize != 1) {\r\noff *= esize;\r\nsize *= esize;\r\nlen *= esize;\r\n}\r\nl = min(len, size - off);\r\nret = copy_to_user(to, fifo->data + off, l);\r\nif (unlikely(ret))\r\nret = DIV_ROUND_UP(ret + len - l, esize);\r\nelse {\r\nret = copy_to_user(to + l, fifo->data, len - l);\r\nif (unlikely(ret))\r\nret = DIV_ROUND_UP(ret, esize);\r\n}\r\nsmp_wmb();\r\n*copied = len - ret;\r\nreturn ret;\r\n}\r\nint __kfifo_to_user(struct __kfifo *fifo, void __user *to,\r\nunsigned long len, unsigned int *copied)\r\n{\r\nunsigned int l;\r\nunsigned long ret;\r\nunsigned int esize = fifo->esize;\r\nint err;\r\nif (esize != 1)\r\nlen /= esize;\r\nl = fifo->in - fifo->out;\r\nif (len > l)\r\nlen = l;\r\nret = kfifo_copy_to_user(fifo, to, len, fifo->out, copied);\r\nif (unlikely(ret)) {\r\nlen -= ret;\r\nerr = -EFAULT;\r\n} else\r\nerr = 0;\r\nfifo->out += len;\r\nreturn err;\r\n}\r\nstatic int setup_sgl_buf(struct scatterlist *sgl, void *buf,\r\nint nents, unsigned int len)\r\n{\r\nint n;\r\nunsigned int l;\r\nunsigned int off;\r\nstruct page *page;\r\nif (!nents)\r\nreturn 0;\r\nif (!len)\r\nreturn 0;\r\nn = 0;\r\npage = virt_to_page(buf);\r\noff = offset_in_page(buf);\r\nl = 0;\r\nwhile (len >= l + PAGE_SIZE - off) {\r\nstruct page *npage;\r\nl += PAGE_SIZE;\r\nbuf += PAGE_SIZE;\r\nnpage = virt_to_page(buf);\r\nif (page_to_phys(page) != page_to_phys(npage) - l) {\r\nsg_set_page(sgl, page, l - off, off);\r\nsgl = sg_next(sgl);\r\nif (++n == nents || sgl == NULL)\r\nreturn n;\r\npage = npage;\r\nlen -= l - off;\r\nl = off = 0;\r\n}\r\n}\r\nsg_set_page(sgl, page, len, off);\r\nreturn n + 1;\r\n}\r\nstatic unsigned int setup_sgl(struct __kfifo *fifo, struct scatterlist *sgl,\r\nint nents, unsigned int len, unsigned int off)\r\n{\r\nunsigned int size = fifo->mask + 1;\r\nunsigned int esize = fifo->esize;\r\nunsigned int l;\r\nunsigned int n;\r\noff &= fifo->mask;\r\nif (esize != 1) {\r\noff *= esize;\r\nsize *= esize;\r\nlen *= esize;\r\n}\r\nl = min(len, size - off);\r\nn = setup_sgl_buf(sgl, fifo->data + off, nents, l);\r\nn += setup_sgl_buf(sgl + n, fifo->data, nents - n, len - l);\r\nreturn n;\r\n}\r\nunsigned int __kfifo_dma_in_prepare(struct __kfifo *fifo,\r\nstruct scatterlist *sgl, int nents, unsigned int len)\r\n{\r\nunsigned int l;\r\nl = kfifo_unused(fifo);\r\nif (len > l)\r\nlen = l;\r\nreturn setup_sgl(fifo, sgl, nents, len, fifo->in);\r\n}\r\nunsigned int __kfifo_dma_out_prepare(struct __kfifo *fifo,\r\nstruct scatterlist *sgl, int nents, unsigned int len)\r\n{\r\nunsigned int l;\r\nl = fifo->in - fifo->out;\r\nif (len > l)\r\nlen = l;\r\nreturn setup_sgl(fifo, sgl, nents, len, fifo->out);\r\n}\r\nunsigned int __kfifo_max_r(unsigned int len, size_t recsize)\r\n{\r\nunsigned int max = (1 << (recsize << 3)) - 1;\r\nif (len > max)\r\nreturn max;\r\nreturn len;\r\n}\r\nstatic unsigned int __kfifo_peek_n(struct __kfifo *fifo, size_t recsize)\r\n{\r\nunsigned int l;\r\nunsigned int mask = fifo->mask;\r\nunsigned char *data = fifo->data;\r\nl = __KFIFO_PEEK(data, fifo->out, mask);\r\nif (--recsize)\r\nl |= __KFIFO_PEEK(data, fifo->out + 1, mask) << 8;\r\nreturn l;\r\n}\r\nstatic void __kfifo_poke_n(struct __kfifo *fifo, unsigned int n, size_t recsize)\r\n{\r\nunsigned int mask = fifo->mask;\r\nunsigned char *data = fifo->data;\r\n__KFIFO_POKE(data, fifo->in, mask, n);\r\nif (recsize > 1)\r\n__KFIFO_POKE(data, fifo->in + 1, mask, n >> 8);\r\n}\r\nunsigned int __kfifo_len_r(struct __kfifo *fifo, size_t recsize)\r\n{\r\nreturn __kfifo_peek_n(fifo, recsize);\r\n}\r\nunsigned int __kfifo_in_r(struct __kfifo *fifo, const void *buf,\r\nunsigned int len, size_t recsize)\r\n{\r\nif (len + recsize > kfifo_unused(fifo))\r\nreturn 0;\r\n__kfifo_poke_n(fifo, len, recsize);\r\nkfifo_copy_in(fifo, buf, len, fifo->in + recsize);\r\nfifo->in += len + recsize;\r\nreturn len;\r\n}\r\nstatic unsigned int kfifo_out_copy_r(struct __kfifo *fifo,\r\nvoid *buf, unsigned int len, size_t recsize, unsigned int *n)\r\n{\r\n*n = __kfifo_peek_n(fifo, recsize);\r\nif (len > *n)\r\nlen = *n;\r\nkfifo_copy_out(fifo, buf, len, fifo->out + recsize);\r\nreturn len;\r\n}\r\nunsigned int __kfifo_out_peek_r(struct __kfifo *fifo, void *buf,\r\nunsigned int len, size_t recsize)\r\n{\r\nunsigned int n;\r\nif (fifo->in == fifo->out)\r\nreturn 0;\r\nreturn kfifo_out_copy_r(fifo, buf, len, recsize, &n);\r\n}\r\nunsigned int __kfifo_out_r(struct __kfifo *fifo, void *buf,\r\nunsigned int len, size_t recsize)\r\n{\r\nunsigned int n;\r\nif (fifo->in == fifo->out)\r\nreturn 0;\r\nlen = kfifo_out_copy_r(fifo, buf, len, recsize, &n);\r\nfifo->out += n + recsize;\r\nreturn len;\r\n}\r\nvoid __kfifo_skip_r(struct __kfifo *fifo, size_t recsize)\r\n{\r\nunsigned int n;\r\nn = __kfifo_peek_n(fifo, recsize);\r\nfifo->out += n + recsize;\r\n}\r\nint __kfifo_from_user_r(struct __kfifo *fifo, const void __user *from,\r\nunsigned long len, unsigned int *copied, size_t recsize)\r\n{\r\nunsigned long ret;\r\nlen = __kfifo_max_r(len, recsize);\r\nif (len + recsize > kfifo_unused(fifo)) {\r\n*copied = 0;\r\nreturn 0;\r\n}\r\n__kfifo_poke_n(fifo, len, recsize);\r\nret = kfifo_copy_from_user(fifo, from, len, fifo->in + recsize, copied);\r\nif (unlikely(ret)) {\r\n*copied = 0;\r\nreturn -EFAULT;\r\n}\r\nfifo->in += len + recsize;\r\nreturn 0;\r\n}\r\nint __kfifo_to_user_r(struct __kfifo *fifo, void __user *to,\r\nunsigned long len, unsigned int *copied, size_t recsize)\r\n{\r\nunsigned long ret;\r\nunsigned int n;\r\nif (fifo->in == fifo->out) {\r\n*copied = 0;\r\nreturn 0;\r\n}\r\nn = __kfifo_peek_n(fifo, recsize);\r\nif (len > n)\r\nlen = n;\r\nret = kfifo_copy_to_user(fifo, to, len, fifo->out + recsize, copied);\r\nif (unlikely(ret)) {\r\n*copied = 0;\r\nreturn -EFAULT;\r\n}\r\nfifo->out += n + recsize;\r\nreturn 0;\r\n}\r\nunsigned int __kfifo_dma_in_prepare_r(struct __kfifo *fifo,\r\nstruct scatterlist *sgl, int nents, unsigned int len, size_t recsize)\r\n{\r\nif (!nents)\r\nBUG();\r\nlen = __kfifo_max_r(len, recsize);\r\nif (len + recsize > kfifo_unused(fifo))\r\nreturn 0;\r\nreturn setup_sgl(fifo, sgl, nents, len, fifo->in + recsize);\r\n}\r\nvoid __kfifo_dma_in_finish_r(struct __kfifo *fifo,\r\nunsigned int len, size_t recsize)\r\n{\r\nlen = __kfifo_max_r(len, recsize);\r\n__kfifo_poke_n(fifo, len, recsize);\r\nfifo->in += len + recsize;\r\n}\r\nunsigned int __kfifo_dma_out_prepare_r(struct __kfifo *fifo,\r\nstruct scatterlist *sgl, int nents, unsigned int len, size_t recsize)\r\n{\r\nif (!nents)\r\nBUG();\r\nlen = __kfifo_max_r(len, recsize);\r\nif (len + recsize > fifo->in - fifo->out)\r\nreturn 0;\r\nreturn setup_sgl(fifo, sgl, nents, len, fifo->out + recsize);\r\n}\r\nvoid __kfifo_dma_out_finish_r(struct __kfifo *fifo, size_t recsize)\r\n{\r\nunsigned int len;\r\nlen = __kfifo_peek_n(fifo, recsize);\r\nfifo->out += len + recsize;\r\n}

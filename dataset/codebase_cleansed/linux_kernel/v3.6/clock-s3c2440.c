static unsigned long s3c2440_camif_upll_round(struct clk *clk,\r\nunsigned long rate)\r\n{\r\nunsigned long parent_rate = clk_get_rate(clk->parent);\r\nint div;\r\nif (rate > parent_rate)\r\nreturn parent_rate;\r\ndiv = (parent_rate / rate) / 2;\r\nif (div < 1)\r\ndiv = 1;\r\nelse if (div > 16)\r\ndiv = 16;\r\nreturn parent_rate / (div * 2);\r\n}\r\nstatic int s3c2440_camif_upll_setrate(struct clk *clk, unsigned long rate)\r\n{\r\nunsigned long parent_rate = clk_get_rate(clk->parent);\r\nunsigned long camdivn = __raw_readl(S3C2440_CAMDIVN);\r\nrate = s3c2440_camif_upll_round(clk, rate);\r\ncamdivn &= ~(S3C2440_CAMDIVN_CAMCLK_SEL | S3C2440_CAMDIVN_CAMCLK_MASK);\r\nif (rate != parent_rate) {\r\ncamdivn |= S3C2440_CAMDIVN_CAMCLK_SEL;\r\ncamdivn |= (((parent_rate / rate) / 2) - 1);\r\n}\r\n__raw_writel(camdivn, S3C2440_CAMDIVN);\r\nreturn 0;\r\n}\r\nstatic unsigned long s3c2440_fclk_n_getrate(struct clk *clk)\r\n{\r\nunsigned long ucon0, ucon1, ucon2, divisor;\r\nucon0 = __raw_readl(S3C24XX_VA_UART0 + S3C2410_UCON);\r\nucon1 = __raw_readl(S3C24XX_VA_UART1 + S3C2410_UCON);\r\nucon2 = __raw_readl(S3C24XX_VA_UART2 + S3C2410_UCON);\r\nucon0 &= S3C2440_UCON0_DIVMASK;\r\nucon1 &= S3C2440_UCON1_DIVMASK;\r\nucon2 &= S3C2440_UCON2_DIVMASK;\r\nif (ucon0 != 0)\r\ndivisor = (ucon0 >> S3C2440_UCON_DIVSHIFT) + 6;\r\nelse if (ucon1 != 0)\r\ndivisor = (ucon1 >> S3C2440_UCON_DIVSHIFT) + 21;\r\nelse if (ucon2 != 0)\r\ndivisor = (ucon2 >> S3C2440_UCON_DIVSHIFT) + 36;\r\nelse\r\ndivisor = 9;\r\nreturn clk_get_rate(clk->parent) / divisor;\r\n}\r\nstatic int s3c2440_clk_add(struct device *dev, struct subsys_interface *sif)\r\n{\r\nstruct clk *clock_upll;\r\nstruct clk *clock_h;\r\nstruct clk *clock_p;\r\nclock_p = clk_get(NULL, "pclk");\r\nclock_h = clk_get(NULL, "hclk");\r\nclock_upll = clk_get(NULL, "upll");\r\nif (IS_ERR(clock_p) || IS_ERR(clock_h) || IS_ERR(clock_upll)) {\r\nprintk(KERN_ERR "S3C2440: Failed to get parent clocks\n");\r\nreturn -EINVAL;\r\n}\r\ns3c2440_clk_cam.parent = clock_h;\r\ns3c2440_clk_ac97.parent = clock_p;\r\ns3c2440_clk_cam_upll.parent = clock_upll;\r\ns3c24xx_register_clock(&s3c2440_clk_fclk_n);\r\ns3c24xx_register_clock(&s3c2440_clk_ac97);\r\ns3c24xx_register_clock(&s3c2440_clk_cam);\r\ns3c24xx_register_clock(&s3c2440_clk_cam_upll);\r\nclkdev_add_table(s3c2440_clk_lookup, ARRAY_SIZE(s3c2440_clk_lookup));\r\nclk_disable(&s3c2440_clk_ac97);\r\nclk_disable(&s3c2440_clk_cam);\r\nreturn 0;\r\n}\r\nstatic __init int s3c24xx_clk_init(void)\r\n{\r\nreturn subsys_interface_register(&s3c2440_clk_interface);\r\n}

static ssize_t legacy_show(struct kobject *kobj, struct attribute *attr,\r\nchar *buf)\r\n{\r\nstruct legacy_slot *slot = container_of(kobj, typeof(*slot), kobj);\r\nstrcpy(buf, "1\n");\r\nreturn 2;\r\n}\r\nstatic void remove_callback(void *data)\r\n{\r\npci_stop_and_remove_bus_device((struct pci_dev *)data);\r\n}\r\nstatic ssize_t legacy_store(struct kobject *kobj, struct attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nstruct legacy_slot *slot = container_of(kobj, typeof(*slot), kobj);\r\nunsigned long val;\r\nif (strict_strtoul(buf, 0, &val) < 0)\r\nreturn -EINVAL;\r\nif (val)\r\npci_rescan_bus(slot->dev->bus);\r\nelse\r\nsysfs_schedule_callback(&slot->dev->dev.kobj, remove_callback,\r\nslot->dev, THIS_MODULE);\r\nreturn len;\r\n}\r\nstatic void legacy_release(struct kobject *kobj)\r\n{\r\nstruct legacy_slot *slot = container_of(kobj, typeof(*slot), kobj);\r\npci_dev_put(slot->dev);\r\nkfree(slot);\r\n}\r\nstatic int legacy_add_slot(struct pci_dev *pdev)\r\n{\r\nstruct legacy_slot *slot = kzalloc(sizeof(*slot), GFP_KERNEL);\r\nif (!slot)\r\nreturn -ENOMEM;\r\nif (kobject_init_and_add(&slot->kobj, &legacy_ktype,\r\n&pci_slots_kset->kobj, "%s",\r\ndev_name(&pdev->dev))) {\r\ndev_warn(&pdev->dev, "Failed to created legacy fake slot\n");\r\nreturn -EINVAL;\r\n}\r\nslot->dev = pci_dev_get(pdev);\r\nlist_add(&slot->list, &legacy_list);\r\nreturn 0;\r\n}\r\nstatic int legacy_notify(struct notifier_block *nb,\r\nunsigned long action, void *data)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(data);\r\nif (action == BUS_NOTIFY_ADD_DEVICE) {\r\nlegacy_add_slot(pdev);\r\n} else if (action == BUS_NOTIFY_DEL_DEVICE) {\r\nstruct legacy_slot *slot;\r\nlist_for_each_entry(slot, &legacy_list, list)\r\nif (slot->dev == pdev)\r\ngoto found;\r\ndev_warn(&pdev->dev, "Missing legacy fake slot?");\r\nreturn -ENODEV;\r\nfound:\r\nkobject_del(&slot->kobj);\r\nlist_del(&slot->list);\r\nkobject_put(&slot->kobj);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init init_legacy(void)\r\n{\r\nstruct pci_dev *pdev = NULL;\r\nfor_each_pci_dev(pdev)\r\nlegacy_add_slot(pdev);\r\nbus_register_notifier(&pci_bus_type, &legacy_notifier);\r\nreturn 0;\r\n}\r\nstatic void __exit remove_legacy(void)\r\n{\r\nstruct legacy_slot *slot, *tmp;\r\nbus_unregister_notifier(&pci_bus_type, &legacy_notifier);\r\nlist_for_each_entry_safe(slot, tmp, &legacy_list, list) {\r\nlist_del(&slot->list);\r\nkobject_del(&slot->kobj);\r\nkobject_put(&slot->kobj);\r\n}\r\n}

static int backend_bus_id(char bus_id[XEN_BUS_ID_SIZE], const char *nodename)\r\n{\r\nint domid, err;\r\nconst char *devid, *type, *frontend;\r\nunsigned int typelen;\r\ntype = strchr(nodename, '/');\r\nif (!type)\r\nreturn -EINVAL;\r\ntype++;\r\ntypelen = strcspn(type, "/");\r\nif (!typelen || type[typelen] != '/')\r\nreturn -EINVAL;\r\ndevid = strrchr(nodename, '/') + 1;\r\nerr = xenbus_gather(XBT_NIL, nodename, "frontend-id", "%i", &domid,\r\n"frontend", NULL, &frontend,\r\nNULL);\r\nif (err)\r\nreturn err;\r\nif (strlen(frontend) == 0)\r\nerr = -ERANGE;\r\nif (!err && !xenbus_exists(XBT_NIL, frontend, ""))\r\nerr = -ENOENT;\r\nkfree(frontend);\r\nif (err)\r\nreturn err;\r\nif (snprintf(bus_id, XEN_BUS_ID_SIZE, "%.*s-%i-%s",\r\ntypelen, type, domid, devid) >= XEN_BUS_ID_SIZE)\r\nreturn -ENOSPC;\r\nreturn 0;\r\n}\r\nstatic int xenbus_uevent_backend(struct device *dev,\r\nstruct kobj_uevent_env *env)\r\n{\r\nstruct xenbus_device *xdev;\r\nstruct xenbus_driver *drv;\r\nstruct xen_bus_type *bus;\r\nDPRINTK("");\r\nif (dev == NULL)\r\nreturn -ENODEV;\r\nxdev = to_xenbus_device(dev);\r\nbus = container_of(xdev->dev.bus, struct xen_bus_type, bus);\r\nif (add_uevent_var(env, "MODALIAS=xen-backend:%s", xdev->devicetype))\r\nreturn -ENOMEM;\r\nif (add_uevent_var(env, "XENBUS_TYPE=%s", xdev->devicetype))\r\nreturn -ENOMEM;\r\nif (add_uevent_var(env, "XENBUS_PATH=%s", xdev->nodename))\r\nreturn -ENOMEM;\r\nif (add_uevent_var(env, "XENBUS_BASE_PATH=%s", bus->root))\r\nreturn -ENOMEM;\r\nif (dev->driver) {\r\ndrv = to_xenbus_driver(dev->driver);\r\nif (drv && drv->uevent)\r\nreturn drv->uevent(xdev, env);\r\n}\r\nreturn 0;\r\n}\r\nstatic int xenbus_probe_backend_unit(struct xen_bus_type *bus,\r\nconst char *dir,\r\nconst char *type,\r\nconst char *name)\r\n{\r\nchar *nodename;\r\nint err;\r\nnodename = kasprintf(GFP_KERNEL, "%s/%s", dir, name);\r\nif (!nodename)\r\nreturn -ENOMEM;\r\nDPRINTK("%s\n", nodename);\r\nerr = xenbus_probe_node(bus, type, nodename);\r\nkfree(nodename);\r\nreturn err;\r\n}\r\nstatic int xenbus_probe_backend(struct xen_bus_type *bus, const char *type,\r\nconst char *domid)\r\n{\r\nchar *nodename;\r\nint err = 0;\r\nchar **dir;\r\nunsigned int i, dir_n = 0;\r\nDPRINTK("");\r\nnodename = kasprintf(GFP_KERNEL, "%s/%s/%s", bus->root, type, domid);\r\nif (!nodename)\r\nreturn -ENOMEM;\r\ndir = xenbus_directory(XBT_NIL, nodename, "", &dir_n);\r\nif (IS_ERR(dir)) {\r\nkfree(nodename);\r\nreturn PTR_ERR(dir);\r\n}\r\nfor (i = 0; i < dir_n; i++) {\r\nerr = xenbus_probe_backend_unit(bus, nodename, type, dir[i]);\r\nif (err)\r\nbreak;\r\n}\r\nkfree(dir);\r\nkfree(nodename);\r\nreturn err;\r\n}\r\nstatic void frontend_changed(struct xenbus_watch *watch,\r\nconst char **vec, unsigned int len)\r\n{\r\nxenbus_otherend_changed(watch, vec, len, 0);\r\n}\r\nstatic void backend_changed(struct xenbus_watch *watch,\r\nconst char **vec, unsigned int len)\r\n{\r\nDPRINTK("");\r\nxenbus_dev_changed(vec[XS_WATCH_PATH], &xenbus_backend);\r\n}\r\nstatic int read_frontend_details(struct xenbus_device *xendev)\r\n{\r\nreturn xenbus_read_otherend_details(xendev, "frontend-id", "frontend");\r\n}\r\nint xenbus_dev_is_online(struct xenbus_device *dev)\r\n{\r\nint rc, val;\r\nrc = xenbus_scanf(XBT_NIL, dev->nodename, "online", "%d", &val);\r\nif (rc != 1)\r\nval = 0;\r\nreturn val;\r\n}\r\nint xenbus_register_backend(struct xenbus_driver *drv)\r\n{\r\ndrv->read_otherend_details = read_frontend_details;\r\nreturn xenbus_register_driver_common(drv, &xenbus_backend);\r\n}\r\nstatic int backend_probe_and_watch(struct notifier_block *notifier,\r\nunsigned long event,\r\nvoid *data)\r\n{\r\nxenbus_probe_devices(&xenbus_backend);\r\nregister_xenbus_watch(&be_watch);\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int __init xenbus_probe_backend_init(void)\r\n{\r\nstatic struct notifier_block xenstore_notifier = {\r\n.notifier_call = backend_probe_and_watch\r\n};\r\nint err;\r\nDPRINTK("");\r\nerr = bus_register(&xenbus_backend.bus);\r\nif (err)\r\nreturn err;\r\nregister_xenstore_notifier(&xenstore_notifier);\r\nreturn 0;\r\n}

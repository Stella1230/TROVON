void cvmx_spi_get_callbacks(cvmx_spi_callbacks_t *callbacks)\r\n{\r\nmemcpy(callbacks, &cvmx_spi_callbacks, sizeof(cvmx_spi_callbacks));\r\n}\r\nvoid cvmx_spi_set_callbacks(cvmx_spi_callbacks_t *new_callbacks)\r\n{\r\nmemcpy(&cvmx_spi_callbacks, new_callbacks, sizeof(cvmx_spi_callbacks));\r\n}\r\nint cvmx_spi_start_interface(int interface, cvmx_spi_mode_t mode, int timeout,\r\nint num_ports)\r\n{\r\nint res = -1;\r\nif (!(OCTEON_IS_MODEL(OCTEON_CN38XX) || OCTEON_IS_MODEL(OCTEON_CN58XX)))\r\nreturn res;\r\nINVOKE_CB(cvmx_spi_callbacks.reset_cb, interface, mode);\r\nINVOKE_CB(cvmx_spi_callbacks.calendar_setup_cb, interface, mode,\r\nnum_ports);\r\nINVOKE_CB(cvmx_spi_callbacks.clock_detect_cb, interface, mode, timeout);\r\nINVOKE_CB(cvmx_spi_callbacks.training_cb, interface, mode, timeout);\r\nINVOKE_CB(cvmx_spi_callbacks.calendar_sync_cb, interface, mode,\r\ntimeout);\r\nINVOKE_CB(cvmx_spi_callbacks.interface_up_cb, interface, mode);\r\nreturn res;\r\n}\r\nint cvmx_spi_restart_interface(int interface, cvmx_spi_mode_t mode, int timeout)\r\n{\r\nint res = -1;\r\nif (!(OCTEON_IS_MODEL(OCTEON_CN38XX) || OCTEON_IS_MODEL(OCTEON_CN58XX)))\r\nreturn res;\r\ncvmx_dprintf("SPI%d: Restart %s\n", interface, modes[mode]);\r\nINVOKE_CB(cvmx_spi_callbacks.reset_cb, interface, mode);\r\nINVOKE_CB(cvmx_spi_callbacks.clock_detect_cb, interface, mode, timeout);\r\nINVOKE_CB(cvmx_spi_callbacks.training_cb, interface, mode, timeout);\r\nINVOKE_CB(cvmx_spi_callbacks.calendar_sync_cb, interface, mode,\r\ntimeout);\r\nINVOKE_CB(cvmx_spi_callbacks.interface_up_cb, interface, mode);\r\nreturn res;\r\n}\r\nint cvmx_spi_reset_cb(int interface, cvmx_spi_mode_t mode)\r\n{\r\nunion cvmx_spxx_dbg_deskew_ctl spxx_dbg_deskew_ctl;\r\nunion cvmx_spxx_clk_ctl spxx_clk_ctl;\r\nunion cvmx_spxx_bist_stat spxx_bist_stat;\r\nunion cvmx_spxx_int_msk spxx_int_msk;\r\nunion cvmx_stxx_int_msk stxx_int_msk;\r\nunion cvmx_spxx_trn4_ctl spxx_trn4_ctl;\r\nint index;\r\nuint64_t MS = cvmx_sysinfo_get()->cpu_clock_hz / 1000;\r\nspxx_int_msk.u64 = cvmx_read_csr(CVMX_SPXX_INT_MSK(interface));\r\ncvmx_write_csr(CVMX_SPXX_INT_MSK(interface), 0);\r\nstxx_int_msk.u64 = cvmx_read_csr(CVMX_STXX_INT_MSK(interface));\r\ncvmx_write_csr(CVMX_STXX_INT_MSK(interface), 0);\r\ncvmx_write_csr(CVMX_SRXX_COM_CTL(interface), 0);\r\ncvmx_write_csr(CVMX_STXX_COM_CTL(interface), 0);\r\nspxx_clk_ctl.u64 = 0;\r\nspxx_clk_ctl.s.runbist = 1;\r\ncvmx_write_csr(CVMX_SPXX_CLK_CTL(interface), spxx_clk_ctl.u64);\r\ncvmx_wait(10 * MS);\r\nspxx_bist_stat.u64 = cvmx_read_csr(CVMX_SPXX_BIST_STAT(interface));\r\nif (spxx_bist_stat.s.stat0)\r\ncvmx_dprintf\r\n("ERROR SPI%d: BIST failed on receive datapath FIFO\n",\r\ninterface);\r\nif (spxx_bist_stat.s.stat1)\r\ncvmx_dprintf("ERROR SPI%d: BIST failed on RX calendar table\n",\r\ninterface);\r\nif (spxx_bist_stat.s.stat2)\r\ncvmx_dprintf("ERROR SPI%d: BIST failed on TX calendar table\n",\r\ninterface);\r\nfor (index = 0; index < 32; index++) {\r\nunion cvmx_srxx_spi4_calx srxx_spi4_calx;\r\nunion cvmx_stxx_spi4_calx stxx_spi4_calx;\r\nsrxx_spi4_calx.u64 = 0;\r\nsrxx_spi4_calx.s.oddpar = 1;\r\ncvmx_write_csr(CVMX_SRXX_SPI4_CALX(index, interface),\r\nsrxx_spi4_calx.u64);\r\nstxx_spi4_calx.u64 = 0;\r\nstxx_spi4_calx.s.oddpar = 1;\r\ncvmx_write_csr(CVMX_STXX_SPI4_CALX(index, interface),\r\nstxx_spi4_calx.u64);\r\n}\r\ncvmx_write_csr(CVMX_SPXX_INT_REG(interface),\r\ncvmx_read_csr(CVMX_SPXX_INT_REG(interface)));\r\ncvmx_write_csr(CVMX_SPXX_INT_MSK(interface), spxx_int_msk.u64);\r\ncvmx_write_csr(CVMX_STXX_INT_REG(interface),\r\ncvmx_read_csr(CVMX_STXX_INT_REG(interface)));\r\ncvmx_write_csr(CVMX_STXX_INT_MSK(interface), stxx_int_msk.u64);\r\nspxx_clk_ctl.u64 = 0;\r\nspxx_clk_ctl.s.seetrn = 0;\r\nspxx_clk_ctl.s.clkdly = 0x10;\r\nspxx_clk_ctl.s.runbist = 0;\r\nspxx_clk_ctl.s.statdrv = 0;\r\nspxx_clk_ctl.s.statrcv = 1;\r\nspxx_clk_ctl.s.sndtrn = 0;\r\nspxx_clk_ctl.s.drptrn = 0;\r\nspxx_clk_ctl.s.rcvtrn = 0;\r\nspxx_clk_ctl.s.srxdlck = 0;\r\ncvmx_write_csr(CVMX_SPXX_CLK_CTL(interface), spxx_clk_ctl.u64);\r\ncvmx_wait(100 * MS);\r\nspxx_clk_ctl.s.srxdlck = 1;\r\ncvmx_write_csr(CVMX_SPXX_CLK_CTL(interface), spxx_clk_ctl.u64);\r\ncvmx_wait(100 * MS);\r\nspxx_trn4_ctl.s.trntest = 0;\r\nspxx_trn4_ctl.s.jitter = 1;\r\nspxx_trn4_ctl.s.clr_boot = 1;\r\nspxx_trn4_ctl.s.set_boot = 0;\r\nif (OCTEON_IS_MODEL(OCTEON_CN58XX))\r\nspxx_trn4_ctl.s.maxdist = 3;\r\nelse\r\nspxx_trn4_ctl.s.maxdist = 8;\r\nspxx_trn4_ctl.s.macro_en = 1;\r\nspxx_trn4_ctl.s.mux_en = 1;\r\ncvmx_write_csr(CVMX_SPXX_TRN4_CTL(interface), spxx_trn4_ctl.u64);\r\nspxx_dbg_deskew_ctl.u64 = 0;\r\ncvmx_write_csr(CVMX_SPXX_DBG_DESKEW_CTL(interface),\r\nspxx_dbg_deskew_ctl.u64);\r\nreturn 0;\r\n}\r\nint cvmx_spi_calendar_setup_cb(int interface, cvmx_spi_mode_t mode,\r\nint num_ports)\r\n{\r\nint port;\r\nint index;\r\nif (mode & CVMX_SPI_MODE_RX_HALFPLEX) {\r\nunion cvmx_srxx_com_ctl srxx_com_ctl;\r\nunion cvmx_srxx_spi4_stat srxx_spi4_stat;\r\nsrxx_com_ctl.u64 = 0;\r\nsrxx_com_ctl.s.prts = num_ports - 1;\r\nsrxx_com_ctl.s.st_en = 0;\r\nsrxx_com_ctl.s.inf_en = 0;\r\ncvmx_write_csr(CVMX_SRXX_COM_CTL(interface), srxx_com_ctl.u64);\r\nport = 0;\r\nindex = 0;\r\nwhile (port < num_ports) {\r\nunion cvmx_srxx_spi4_calx srxx_spi4_calx;\r\nsrxx_spi4_calx.u64 = 0;\r\nsrxx_spi4_calx.s.prt0 = port++;\r\nsrxx_spi4_calx.s.prt1 = port++;\r\nsrxx_spi4_calx.s.prt2 = port++;\r\nsrxx_spi4_calx.s.prt3 = port++;\r\nsrxx_spi4_calx.s.oddpar =\r\n~(cvmx_dpop(srxx_spi4_calx.u64) & 1);\r\ncvmx_write_csr(CVMX_SRXX_SPI4_CALX(index, interface),\r\nsrxx_spi4_calx.u64);\r\nindex++;\r\n}\r\nsrxx_spi4_stat.u64 = 0;\r\nsrxx_spi4_stat.s.len = num_ports;\r\nsrxx_spi4_stat.s.m = 1;\r\ncvmx_write_csr(CVMX_SRXX_SPI4_STAT(interface),\r\nsrxx_spi4_stat.u64);\r\n}\r\nif (mode & CVMX_SPI_MODE_TX_HALFPLEX) {\r\nunion cvmx_stxx_arb_ctl stxx_arb_ctl;\r\nunion cvmx_gmxx_tx_spi_max gmxx_tx_spi_max;\r\nunion cvmx_gmxx_tx_spi_thresh gmxx_tx_spi_thresh;\r\nunion cvmx_gmxx_tx_spi_ctl gmxx_tx_spi_ctl;\r\nunion cvmx_stxx_spi4_stat stxx_spi4_stat;\r\nunion cvmx_stxx_spi4_dat stxx_spi4_dat;\r\nstxx_arb_ctl.u64 = 0;\r\nstxx_arb_ctl.s.igntpa = 0;\r\nstxx_arb_ctl.s.mintrn = 0;\r\ncvmx_write_csr(CVMX_STXX_ARB_CTL(interface), stxx_arb_ctl.u64);\r\ngmxx_tx_spi_max.u64 = 0;\r\ngmxx_tx_spi_max.s.max1 = 8;\r\ngmxx_tx_spi_max.s.max2 = 4;\r\ngmxx_tx_spi_max.s.slice = 0;\r\ncvmx_write_csr(CVMX_GMXX_TX_SPI_MAX(interface),\r\ngmxx_tx_spi_max.u64);\r\ngmxx_tx_spi_thresh.u64 = 0;\r\ngmxx_tx_spi_thresh.s.thresh = 4;\r\ncvmx_write_csr(CVMX_GMXX_TX_SPI_THRESH(interface),\r\ngmxx_tx_spi_thresh.u64);\r\ngmxx_tx_spi_ctl.u64 = 0;\r\ngmxx_tx_spi_ctl.s.tpa_clr = 0;\r\ngmxx_tx_spi_ctl.s.cont_pkt = 0;\r\ncvmx_write_csr(CVMX_GMXX_TX_SPI_CTL(interface),\r\ngmxx_tx_spi_ctl.u64);\r\nstxx_spi4_dat.u64 = 0;\r\nstxx_spi4_dat.s.alpha = 32;\r\nstxx_spi4_dat.s.max_t = 0xFFFF;\r\ncvmx_write_csr(CVMX_STXX_SPI4_DAT(interface),\r\nstxx_spi4_dat.u64);\r\nport = 0;\r\nindex = 0;\r\nwhile (port < num_ports) {\r\nunion cvmx_stxx_spi4_calx stxx_spi4_calx;\r\nstxx_spi4_calx.u64 = 0;\r\nstxx_spi4_calx.s.prt0 = port++;\r\nstxx_spi4_calx.s.prt1 = port++;\r\nstxx_spi4_calx.s.prt2 = port++;\r\nstxx_spi4_calx.s.prt3 = port++;\r\nstxx_spi4_calx.s.oddpar =\r\n~(cvmx_dpop(stxx_spi4_calx.u64) & 1);\r\ncvmx_write_csr(CVMX_STXX_SPI4_CALX(index, interface),\r\nstxx_spi4_calx.u64);\r\nindex++;\r\n}\r\nstxx_spi4_stat.u64 = 0;\r\nstxx_spi4_stat.s.len = num_ports;\r\nstxx_spi4_stat.s.m = 1;\r\ncvmx_write_csr(CVMX_STXX_SPI4_STAT(interface),\r\nstxx_spi4_stat.u64);\r\n}\r\nreturn 0;\r\n}\r\nint cvmx_spi_clock_detect_cb(int interface, cvmx_spi_mode_t mode, int timeout)\r\n{\r\nint clock_transitions;\r\nunion cvmx_spxx_clk_stat stat;\r\nuint64_t timeout_time;\r\nuint64_t MS = cvmx_sysinfo_get()->cpu_clock_hz / 1000;\r\ncvmx_dprintf("SPI%d: Waiting to see TsClk...\n", interface);\r\ntimeout_time = cvmx_get_cycle() + 1000ull * MS * timeout;\r\nclock_transitions = 100;\r\ndo {\r\nstat.u64 = cvmx_read_csr(CVMX_SPXX_CLK_STAT(interface));\r\nif (stat.s.s4clk0 && stat.s.s4clk1 && clock_transitions) {\r\nclock_transitions--;\r\ncvmx_write_csr(CVMX_SPXX_CLK_STAT(interface), stat.u64);\r\nstat.s.s4clk0 = 0;\r\nstat.s.s4clk1 = 0;\r\n}\r\nif (cvmx_get_cycle() > timeout_time) {\r\ncvmx_dprintf("SPI%d: Timeout\n", interface);\r\nreturn -1;\r\n}\r\n} while (stat.s.s4clk0 == 0 || stat.s.s4clk1 == 0);\r\ncvmx_dprintf("SPI%d: Waiting to see RsClk...\n", interface);\r\ntimeout_time = cvmx_get_cycle() + 1000ull * MS * timeout;\r\nclock_transitions = 100;\r\ndo {\r\nstat.u64 = cvmx_read_csr(CVMX_SPXX_CLK_STAT(interface));\r\nif (stat.s.d4clk0 && stat.s.d4clk1 && clock_transitions) {\r\nclock_transitions--;\r\ncvmx_write_csr(CVMX_SPXX_CLK_STAT(interface), stat.u64);\r\nstat.s.d4clk0 = 0;\r\nstat.s.d4clk1 = 0;\r\n}\r\nif (cvmx_get_cycle() > timeout_time) {\r\ncvmx_dprintf("SPI%d: Timeout\n", interface);\r\nreturn -1;\r\n}\r\n} while (stat.s.d4clk0 == 0 || stat.s.d4clk1 == 0);\r\nreturn 0;\r\n}\r\nint cvmx_spi_training_cb(int interface, cvmx_spi_mode_t mode, int timeout)\r\n{\r\nunion cvmx_spxx_trn4_ctl spxx_trn4_ctl;\r\nunion cvmx_spxx_clk_stat stat;\r\nuint64_t MS = cvmx_sysinfo_get()->cpu_clock_hz / 1000;\r\nuint64_t timeout_time = cvmx_get_cycle() + 1000ull * MS * timeout;\r\nint rx_training_needed;\r\nunion cvmx_spxx_clk_ctl spxx_clk_ctl;\r\nspxx_clk_ctl.u64 = 0;\r\nspxx_clk_ctl.s.seetrn = 0;\r\nspxx_clk_ctl.s.clkdly = 0x10;\r\nspxx_clk_ctl.s.runbist = 0;\r\nspxx_clk_ctl.s.statdrv = 0;\r\nspxx_clk_ctl.s.statrcv = 1;\r\nspxx_clk_ctl.s.sndtrn = 1;\r\nspxx_clk_ctl.s.drptrn = 1;\r\nspxx_clk_ctl.s.rcvtrn = 1;\r\nspxx_clk_ctl.s.srxdlck = 1;\r\ncvmx_write_csr(CVMX_SPXX_CLK_CTL(interface), spxx_clk_ctl.u64);\r\ncvmx_wait(1000 * MS);\r\nspxx_trn4_ctl.u64 = cvmx_read_csr(CVMX_SPXX_TRN4_CTL(interface));\r\nspxx_trn4_ctl.s.clr_boot = 1;\r\ncvmx_write_csr(CVMX_SPXX_TRN4_CTL(interface), spxx_trn4_ctl.u64);\r\ncvmx_dprintf("SPI%d: Waiting for training\n", interface);\r\ncvmx_wait(1000 * MS);\r\ntimeout_time = cvmx_get_cycle() + 1000ull * MS * 600;\r\nrx_training_needed = 500;\r\ndo {\r\nstat.u64 = cvmx_read_csr(CVMX_SPXX_CLK_STAT(interface));\r\nif (stat.s.srxtrn && rx_training_needed) {\r\nrx_training_needed--;\r\ncvmx_write_csr(CVMX_SPXX_CLK_STAT(interface), stat.u64);\r\nstat.s.srxtrn = 0;\r\n}\r\nif (cvmx_get_cycle() > timeout_time) {\r\ncvmx_dprintf("SPI%d: Timeout\n", interface);\r\nreturn -1;\r\n}\r\n} while (stat.s.srxtrn == 0);\r\nreturn 0;\r\n}\r\nint cvmx_spi_calendar_sync_cb(int interface, cvmx_spi_mode_t mode, int timeout)\r\n{\r\nuint64_t MS = cvmx_sysinfo_get()->cpu_clock_hz / 1000;\r\nif (mode & CVMX_SPI_MODE_RX_HALFPLEX) {\r\nunion cvmx_srxx_com_ctl srxx_com_ctl;\r\ncvmx_dprintf\r\n("SPI%d: Rx is synchronized, start sending calendar data\n",\r\ninterface);\r\nsrxx_com_ctl.u64 = cvmx_read_csr(CVMX_SRXX_COM_CTL(interface));\r\nsrxx_com_ctl.s.inf_en = 1;\r\nsrxx_com_ctl.s.st_en = 1;\r\ncvmx_write_csr(CVMX_SRXX_COM_CTL(interface), srxx_com_ctl.u64);\r\n}\r\nif (mode & CVMX_SPI_MODE_TX_HALFPLEX) {\r\nunion cvmx_spxx_clk_stat stat;\r\nuint64_t timeout_time;\r\nunion cvmx_stxx_com_ctl stxx_com_ctl;\r\nstxx_com_ctl.u64 = 0;\r\nstxx_com_ctl.s.st_en = 1;\r\ncvmx_write_csr(CVMX_STXX_COM_CTL(interface), stxx_com_ctl.u64);\r\ncvmx_dprintf("SPI%d: Waiting to sync on STX[%d] STAT\n",\r\ninterface, interface);\r\ntimeout_time = cvmx_get_cycle() + 1000ull * MS * timeout;\r\ndo {\r\nstat.u64 = cvmx_read_csr(CVMX_SPXX_CLK_STAT(interface));\r\nif (cvmx_get_cycle() > timeout_time) {\r\ncvmx_dprintf("SPI%d: Timeout\n", interface);\r\nreturn -1;\r\n}\r\n} while (stat.s.stxcal == 0);\r\n}\r\nreturn 0;\r\n}\r\nint cvmx_spi_interface_up_cb(int interface, cvmx_spi_mode_t mode)\r\n{\r\nunion cvmx_gmxx_rxx_frm_min gmxx_rxx_frm_min;\r\nunion cvmx_gmxx_rxx_frm_max gmxx_rxx_frm_max;\r\nunion cvmx_gmxx_rxx_jabber gmxx_rxx_jabber;\r\nif (mode & CVMX_SPI_MODE_RX_HALFPLEX) {\r\nunion cvmx_srxx_com_ctl srxx_com_ctl;\r\nsrxx_com_ctl.u64 = cvmx_read_csr(CVMX_SRXX_COM_CTL(interface));\r\nsrxx_com_ctl.s.inf_en = 1;\r\ncvmx_write_csr(CVMX_SRXX_COM_CTL(interface), srxx_com_ctl.u64);\r\ncvmx_dprintf("SPI%d: Rx is now up\n", interface);\r\n}\r\nif (mode & CVMX_SPI_MODE_TX_HALFPLEX) {\r\nunion cvmx_stxx_com_ctl stxx_com_ctl;\r\nstxx_com_ctl.u64 = cvmx_read_csr(CVMX_STXX_COM_CTL(interface));\r\nstxx_com_ctl.s.inf_en = 1;\r\ncvmx_write_csr(CVMX_STXX_COM_CTL(interface), stxx_com_ctl.u64);\r\ncvmx_dprintf("SPI%d: Tx is now up\n", interface);\r\n}\r\ngmxx_rxx_frm_min.u64 = 0;\r\ngmxx_rxx_frm_min.s.len = 64;\r\ncvmx_write_csr(CVMX_GMXX_RXX_FRM_MIN(0, interface),\r\ngmxx_rxx_frm_min.u64);\r\ngmxx_rxx_frm_max.u64 = 0;\r\ngmxx_rxx_frm_max.s.len = 64 * 1024 - 4;\r\ncvmx_write_csr(CVMX_GMXX_RXX_FRM_MAX(0, interface),\r\ngmxx_rxx_frm_max.u64);\r\ngmxx_rxx_jabber.u64 = 0;\r\ngmxx_rxx_jabber.s.cnt = 64 * 1024 - 4;\r\ncvmx_write_csr(CVMX_GMXX_RXX_JABBER(0, interface), gmxx_rxx_jabber.u64);\r\nreturn 0;\r\n}

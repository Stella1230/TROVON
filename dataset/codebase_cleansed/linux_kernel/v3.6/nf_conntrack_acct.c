unsigned int\r\nseq_print_acct(struct seq_file *s, const struct nf_conn *ct, int dir)\r\n{\r\nstruct nf_conn_counter *acct;\r\nacct = nf_conn_acct_find(ct);\r\nif (!acct)\r\nreturn 0;\r\nreturn seq_printf(s, "packets=%llu bytes=%llu ",\r\n(unsigned long long)atomic64_read(&acct[dir].packets),\r\n(unsigned long long)atomic64_read(&acct[dir].bytes));\r\n}\r\nstatic int nf_conntrack_acct_init_sysctl(struct net *net)\r\n{\r\nstruct ctl_table *table;\r\ntable = kmemdup(acct_sysctl_table, sizeof(acct_sysctl_table),\r\nGFP_KERNEL);\r\nif (!table)\r\ngoto out;\r\ntable[0].data = &net->ct.sysctl_acct;\r\nnet->ct.acct_sysctl_header = register_net_sysctl(net, "net/netfilter",\r\ntable);\r\nif (!net->ct.acct_sysctl_header) {\r\nprintk(KERN_ERR "nf_conntrack_acct: can't register to sysctl.\n");\r\ngoto out_register;\r\n}\r\nreturn 0;\r\nout_register:\r\nkfree(table);\r\nout:\r\nreturn -ENOMEM;\r\n}\r\nstatic void nf_conntrack_acct_fini_sysctl(struct net *net)\r\n{\r\nstruct ctl_table *table;\r\ntable = net->ct.acct_sysctl_header->ctl_table_arg;\r\nunregister_net_sysctl_table(net->ct.acct_sysctl_header);\r\nkfree(table);\r\n}\r\nstatic int nf_conntrack_acct_init_sysctl(struct net *net)\r\n{\r\nreturn 0;\r\n}\r\nstatic void nf_conntrack_acct_fini_sysctl(struct net *net)\r\n{\r\n}\r\nint nf_conntrack_acct_init(struct net *net)\r\n{\r\nint ret;\r\nnet->ct.sysctl_acct = nf_ct_acct;\r\nif (net_eq(net, &init_net)) {\r\nret = nf_ct_extend_register(&acct_extend);\r\nif (ret < 0) {\r\nprintk(KERN_ERR "nf_conntrack_acct: Unable to register extension\n");\r\ngoto out_extend_register;\r\n}\r\n}\r\nret = nf_conntrack_acct_init_sysctl(net);\r\nif (ret < 0)\r\ngoto out_sysctl;\r\nreturn 0;\r\nout_sysctl:\r\nif (net_eq(net, &init_net))\r\nnf_ct_extend_unregister(&acct_extend);\r\nout_extend_register:\r\nreturn ret;\r\n}\r\nvoid nf_conntrack_acct_fini(struct net *net)\r\n{\r\nnf_conntrack_acct_fini_sysctl(net);\r\nif (net_eq(net, &init_net))\r\nnf_ct_extend_unregister(&acct_extend);\r\n}

int cvmx_helper_get_number_of_interfaces(void)\r\n{\r\nif (OCTEON_IS_MODEL(OCTEON_CN56XX) || OCTEON_IS_MODEL(OCTEON_CN52XX))\r\nreturn 4;\r\nelse\r\nreturn 3;\r\n}\r\nint cvmx_helper_ports_on_interface(int interface)\r\n{\r\nreturn interface_port_count[interface];\r\n}\r\ncvmx_helper_interface_mode_t cvmx_helper_interface_get_mode(int interface)\r\n{\r\nunion cvmx_gmxx_inf_mode mode;\r\nif (interface == 2)\r\nreturn CVMX_HELPER_INTERFACE_MODE_NPI;\r\nif (interface == 3) {\r\nif (OCTEON_IS_MODEL(OCTEON_CN56XX)\r\n|| OCTEON_IS_MODEL(OCTEON_CN52XX))\r\nreturn CVMX_HELPER_INTERFACE_MODE_LOOP;\r\nelse\r\nreturn CVMX_HELPER_INTERFACE_MODE_DISABLED;\r\n}\r\nif (interface == 0\r\n&& cvmx_sysinfo_get()->board_type == CVMX_BOARD_TYPE_CN3005_EVB_HS5\r\n&& cvmx_sysinfo_get()->board_rev_major == 1) {\r\nreturn CVMX_HELPER_INTERFACE_MODE_GMII;\r\n}\r\nif ((interface == 1)\r\n&& (OCTEON_IS_MODEL(OCTEON_CN31XX) || OCTEON_IS_MODEL(OCTEON_CN30XX)\r\n|| OCTEON_IS_MODEL(OCTEON_CN50XX)\r\n|| OCTEON_IS_MODEL(OCTEON_CN52XX)))\r\nreturn CVMX_HELPER_INTERFACE_MODE_DISABLED;\r\nmode.u64 = cvmx_read_csr(CVMX_GMXX_INF_MODE(interface));\r\nif (OCTEON_IS_MODEL(OCTEON_CN56XX) || OCTEON_IS_MODEL(OCTEON_CN52XX)) {\r\nswitch (mode.cn56xx.mode) {\r\ncase 0:\r\nreturn CVMX_HELPER_INTERFACE_MODE_DISABLED;\r\ncase 1:\r\nreturn CVMX_HELPER_INTERFACE_MODE_XAUI;\r\ncase 2:\r\nreturn CVMX_HELPER_INTERFACE_MODE_SGMII;\r\ncase 3:\r\nreturn CVMX_HELPER_INTERFACE_MODE_PICMG;\r\ndefault:\r\nreturn CVMX_HELPER_INTERFACE_MODE_DISABLED;\r\n}\r\n} else {\r\nif (!mode.s.en)\r\nreturn CVMX_HELPER_INTERFACE_MODE_DISABLED;\r\nif (mode.s.type) {\r\nif (OCTEON_IS_MODEL(OCTEON_CN38XX)\r\n|| OCTEON_IS_MODEL(OCTEON_CN58XX))\r\nreturn CVMX_HELPER_INTERFACE_MODE_SPI;\r\nelse\r\nreturn CVMX_HELPER_INTERFACE_MODE_GMII;\r\n} else\r\nreturn CVMX_HELPER_INTERFACE_MODE_RGMII;\r\n}\r\n}\r\nstatic int __cvmx_helper_port_setup_ipd(int ipd_port)\r\n{\r\nunion cvmx_pip_prt_cfgx port_config;\r\nunion cvmx_pip_prt_tagx tag_config;\r\nport_config.u64 = cvmx_read_csr(CVMX_PIP_PRT_CFGX(ipd_port));\r\ntag_config.u64 = cvmx_read_csr(CVMX_PIP_PRT_TAGX(ipd_port));\r\nport_config.s.qos = ipd_port & 0x7;\r\nport_config.s.mode = CVMX_HELPER_INPUT_PORT_SKIP_MODE;\r\ntag_config.s.ip6_src_flag = CVMX_HELPER_INPUT_TAG_IPV6_SRC_IP;\r\ntag_config.s.ip6_dst_flag = CVMX_HELPER_INPUT_TAG_IPV6_DST_IP;\r\ntag_config.s.ip6_sprt_flag = CVMX_HELPER_INPUT_TAG_IPV6_SRC_PORT;\r\ntag_config.s.ip6_dprt_flag = CVMX_HELPER_INPUT_TAG_IPV6_DST_PORT;\r\ntag_config.s.ip6_nxth_flag = CVMX_HELPER_INPUT_TAG_IPV6_NEXT_HEADER;\r\ntag_config.s.ip4_src_flag = CVMX_HELPER_INPUT_TAG_IPV4_SRC_IP;\r\ntag_config.s.ip4_dst_flag = CVMX_HELPER_INPUT_TAG_IPV4_DST_IP;\r\ntag_config.s.ip4_sprt_flag = CVMX_HELPER_INPUT_TAG_IPV4_SRC_PORT;\r\ntag_config.s.ip4_dprt_flag = CVMX_HELPER_INPUT_TAG_IPV4_DST_PORT;\r\ntag_config.s.ip4_pctl_flag = CVMX_HELPER_INPUT_TAG_IPV4_PROTOCOL;\r\ntag_config.s.inc_prt_flag = CVMX_HELPER_INPUT_TAG_INPUT_PORT;\r\ntag_config.s.tcp6_tag_type = CVMX_HELPER_INPUT_TAG_TYPE;\r\ntag_config.s.tcp4_tag_type = CVMX_HELPER_INPUT_TAG_TYPE;\r\ntag_config.s.ip6_tag_type = CVMX_HELPER_INPUT_TAG_TYPE;\r\ntag_config.s.ip4_tag_type = CVMX_HELPER_INPUT_TAG_TYPE;\r\ntag_config.s.non_tag_type = CVMX_HELPER_INPUT_TAG_TYPE;\r\ntag_config.s.grp = 0;\r\ncvmx_pip_config_port(ipd_port, port_config, tag_config);\r\nif (cvmx_override_ipd_port_setup)\r\ncvmx_override_ipd_port_setup(ipd_port);\r\nreturn 0;\r\n}\r\nint cvmx_helper_interface_enumerate(int interface)\r\n{\r\nswitch (cvmx_helper_interface_get_mode(interface)) {\r\ncase CVMX_HELPER_INTERFACE_MODE_DISABLED:\r\ncase CVMX_HELPER_INTERFACE_MODE_PCIE:\r\ninterface_port_count[interface] = 0;\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_XAUI:\r\ninterface_port_count[interface] =\r\n__cvmx_helper_xaui_enumerate(interface);\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_RGMII:\r\ncase CVMX_HELPER_INTERFACE_MODE_GMII:\r\ninterface_port_count[interface] =\r\n__cvmx_helper_rgmii_enumerate(interface);\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_SPI:\r\ninterface_port_count[interface] =\r\n__cvmx_helper_spi_enumerate(interface);\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_SGMII:\r\ncase CVMX_HELPER_INTERFACE_MODE_PICMG:\r\ninterface_port_count[interface] =\r\n__cvmx_helper_sgmii_enumerate(interface);\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_NPI:\r\ninterface_port_count[interface] =\r\n__cvmx_helper_npi_enumerate(interface);\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_LOOP:\r\ninterface_port_count[interface] =\r\n__cvmx_helper_loop_enumerate(interface);\r\nbreak;\r\n}\r\ninterface_port_count[interface] =\r\n__cvmx_helper_board_interface_probe(interface,\r\ninterface_port_count\r\n[interface]);\r\nCVMX_SYNCWS;\r\nreturn 0;\r\n}\r\nint cvmx_helper_interface_probe(int interface)\r\n{\r\ncvmx_helper_interface_enumerate(interface);\r\nswitch (cvmx_helper_interface_get_mode(interface)) {\r\ncase CVMX_HELPER_INTERFACE_MODE_DISABLED:\r\ncase CVMX_HELPER_INTERFACE_MODE_PCIE:\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_XAUI:\r\n__cvmx_helper_xaui_probe(interface);\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_RGMII:\r\ncase CVMX_HELPER_INTERFACE_MODE_GMII:\r\n__cvmx_helper_rgmii_probe(interface);\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_SPI:\r\n__cvmx_helper_spi_probe(interface);\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_SGMII:\r\ncase CVMX_HELPER_INTERFACE_MODE_PICMG:\r\n__cvmx_helper_sgmii_probe(interface);\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_NPI:\r\n__cvmx_helper_npi_probe(interface);\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_LOOP:\r\n__cvmx_helper_loop_probe(interface);\r\nbreak;\r\n}\r\nCVMX_SYNCWS;\r\nreturn 0;\r\n}\r\nstatic int __cvmx_helper_interface_setup_ipd(int interface)\r\n{\r\nint ipd_port = cvmx_helper_get_ipd_port(interface, 0);\r\nint num_ports = interface_port_count[interface];\r\nwhile (num_ports--) {\r\n__cvmx_helper_port_setup_ipd(ipd_port);\r\nipd_port++;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __cvmx_helper_global_setup_ipd(void)\r\n{\r\ncvmx_ipd_config(CVMX_FPA_PACKET_POOL_SIZE / 8,\r\nCVMX_HELPER_FIRST_MBUFF_SKIP / 8,\r\nCVMX_HELPER_NOT_FIRST_MBUFF_SKIP / 8,\r\n(CVMX_HELPER_FIRST_MBUFF_SKIP + 8) / 128,\r\n(CVMX_HELPER_NOT_FIRST_MBUFF_SKIP + 8) / 128,\r\nCVMX_FPA_WQE_POOL,\r\nCVMX_IPD_OPC_MODE_STT,\r\nCVMX_HELPER_ENABLE_BACK_PRESSURE);\r\nreturn 0;\r\n}\r\nstatic int __cvmx_helper_interface_setup_pko(int interface)\r\n{\r\nuint64_t priorities[16] =\r\n{ 8, 7, 6, 5, 4, 3, 2, 1, 8, 7, 6, 5, 4, 3, 2, 1 };\r\nint ipd_port = cvmx_helper_get_ipd_port(interface, 0);\r\nint num_ports = interface_port_count[interface];\r\nwhile (num_ports--) {\r\nif (cvmx_override_pko_queue_priority)\r\ncvmx_override_pko_queue_priority(ipd_port, priorities);\r\ncvmx_pko_config_port(ipd_port,\r\ncvmx_pko_get_base_queue_per_core(ipd_port,\r\n0),\r\ncvmx_pko_get_num_queues(ipd_port),\r\npriorities);\r\nipd_port++;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __cvmx_helper_global_setup_pko(void)\r\n{\r\nunion cvmx_iob_fau_timeout fau_to;\r\nfau_to.u64 = 0;\r\nfau_to.s.tout_val = 0xfff;\r\nfau_to.s.tout_enb = 0;\r\ncvmx_write_csr(CVMX_IOB_FAU_TIMEOUT, fau_to.u64);\r\nreturn 0;\r\n}\r\nstatic int __cvmx_helper_global_setup_backpressure(void)\r\n{\r\n#if CVMX_HELPER_DISABLE_RGMII_BACKPRESSURE\r\nint num_interfaces = cvmx_helper_get_number_of_interfaces();\r\nint interface;\r\nfor (interface = 0; interface < num_interfaces; interface++) {\r\nswitch (cvmx_helper_interface_get_mode(interface)) {\r\ncase CVMX_HELPER_INTERFACE_MODE_DISABLED:\r\ncase CVMX_HELPER_INTERFACE_MODE_PCIE:\r\ncase CVMX_HELPER_INTERFACE_MODE_NPI:\r\ncase CVMX_HELPER_INTERFACE_MODE_LOOP:\r\ncase CVMX_HELPER_INTERFACE_MODE_XAUI:\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_RGMII:\r\ncase CVMX_HELPER_INTERFACE_MODE_GMII:\r\ncase CVMX_HELPER_INTERFACE_MODE_SPI:\r\ncase CVMX_HELPER_INTERFACE_MODE_SGMII:\r\ncase CVMX_HELPER_INTERFACE_MODE_PICMG:\r\ncvmx_gmx_set_backpressure_override(interface, 0xf);\r\nbreak;\r\n}\r\n}\r\n#endif\r\nreturn 0;\r\n}\r\nstatic int __cvmx_helper_packet_hardware_enable(int interface)\r\n{\r\nint result = 0;\r\nswitch (cvmx_helper_interface_get_mode(interface)) {\r\ncase CVMX_HELPER_INTERFACE_MODE_DISABLED:\r\ncase CVMX_HELPER_INTERFACE_MODE_PCIE:\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_XAUI:\r\nresult = __cvmx_helper_xaui_enable(interface);\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_RGMII:\r\ncase CVMX_HELPER_INTERFACE_MODE_GMII:\r\nresult = __cvmx_helper_rgmii_enable(interface);\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_SPI:\r\nresult = __cvmx_helper_spi_enable(interface);\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_SGMII:\r\ncase CVMX_HELPER_INTERFACE_MODE_PICMG:\r\nresult = __cvmx_helper_sgmii_enable(interface);\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_NPI:\r\nresult = __cvmx_helper_npi_enable(interface);\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_LOOP:\r\nresult = __cvmx_helper_loop_enable(interface);\r\nbreak;\r\n}\r\nresult |= __cvmx_helper_board_hardware_enable(interface);\r\nreturn result;\r\n}\r\nint __cvmx_helper_errata_fix_ipd_ptr_alignment(void)\r\n{\r\n#define FIX_IPD_FIRST_BUFF_PAYLOAD_BYTES \\r\n(CVMX_FPA_PACKET_POOL_SIZE-8-CVMX_HELPER_FIRST_MBUFF_SKIP)\r\n#define FIX_IPD_NON_FIRST_BUFF_PAYLOAD_BYTES \\r\n(CVMX_FPA_PACKET_POOL_SIZE-8-CVMX_HELPER_NOT_FIRST_MBUFF_SKIP)\r\n#define FIX_IPD_OUTPORT 0\r\n#define INTERFACE(port) (port >> 4)\r\n#define INDEX(port) (port & 0xf)\r\nuint64_t *p64;\r\ncvmx_pko_command_word0_t pko_command;\r\nunion cvmx_buf_ptr g_buffer, pkt_buffer;\r\ncvmx_wqe_t *work;\r\nint size, num_segs = 0, wqe_pcnt, pkt_pcnt;\r\nunion cvmx_gmxx_prtx_cfg gmx_cfg;\r\nint retry_cnt;\r\nint retry_loop_cnt;\r\nint i;\r\ncvmx_helper_link_info_t link_info;\r\nuint64_t prtx_cfg =\r\ncvmx_read_csr(CVMX_GMXX_PRTX_CFG\r\n(INDEX(FIX_IPD_OUTPORT), INTERFACE(FIX_IPD_OUTPORT)));\r\nuint64_t tx_ptr_en =\r\ncvmx_read_csr(CVMX_ASXX_TX_PRT_EN(INTERFACE(FIX_IPD_OUTPORT)));\r\nuint64_t rx_ptr_en =\r\ncvmx_read_csr(CVMX_ASXX_RX_PRT_EN(INTERFACE(FIX_IPD_OUTPORT)));\r\nuint64_t rxx_jabber =\r\ncvmx_read_csr(CVMX_GMXX_RXX_JABBER\r\n(INDEX(FIX_IPD_OUTPORT), INTERFACE(FIX_IPD_OUTPORT)));\r\nuint64_t frame_max =\r\ncvmx_read_csr(CVMX_GMXX_RXX_FRM_MAX\r\n(INDEX(FIX_IPD_OUTPORT), INTERFACE(FIX_IPD_OUTPORT)));\r\ncvmx_helper_rgmii_internal_loopback(FIX_IPD_OUTPORT);\r\ncvmx_write_csr(CVMX_ASXX_RX_PRT_EN(INTERFACE(FIX_IPD_OUTPORT)), 0);\r\ncvmx_wait(100000000ull);\r\nfor (retry_loop_cnt = 0; retry_loop_cnt < 10; retry_loop_cnt++) {\r\nretry_cnt = 100000;\r\nwqe_pcnt = cvmx_read_csr(CVMX_IPD_PTR_COUNT);\r\npkt_pcnt = (wqe_pcnt >> 7) & 0x7f;\r\nwqe_pcnt &= 0x7f;\r\nnum_segs = (2 + pkt_pcnt - wqe_pcnt) & 3;\r\nif (num_segs == 0)\r\ngoto fix_ipd_exit;\r\nnum_segs += 1;\r\nsize =\r\nFIX_IPD_FIRST_BUFF_PAYLOAD_BYTES +\r\n((num_segs - 1) * FIX_IPD_NON_FIRST_BUFF_PAYLOAD_BYTES) -\r\n(FIX_IPD_NON_FIRST_BUFF_PAYLOAD_BYTES / 2);\r\ncvmx_write_csr(CVMX_ASXX_PRT_LOOP(INTERFACE(FIX_IPD_OUTPORT)),\r\n1 << INDEX(FIX_IPD_OUTPORT));\r\nCVMX_SYNC;\r\ng_buffer.u64 = 0;\r\ng_buffer.s.addr =\r\ncvmx_ptr_to_phys(cvmx_fpa_alloc(CVMX_FPA_WQE_POOL));\r\nif (g_buffer.s.addr == 0) {\r\ncvmx_dprintf("WARNING: FIX_IPD_PTR_ALIGNMENT "\r\n"buffer allocation failure.\n");\r\ngoto fix_ipd_exit;\r\n}\r\ng_buffer.s.pool = CVMX_FPA_WQE_POOL;\r\ng_buffer.s.size = num_segs;\r\npkt_buffer.u64 = 0;\r\npkt_buffer.s.addr =\r\ncvmx_ptr_to_phys(cvmx_fpa_alloc(CVMX_FPA_PACKET_POOL));\r\nif (pkt_buffer.s.addr == 0) {\r\ncvmx_dprintf("WARNING: FIX_IPD_PTR_ALIGNMENT "\r\n"buffer allocation failure.\n");\r\ngoto fix_ipd_exit;\r\n}\r\npkt_buffer.s.i = 1;\r\npkt_buffer.s.pool = CVMX_FPA_PACKET_POOL;\r\npkt_buffer.s.size = FIX_IPD_FIRST_BUFF_PAYLOAD_BYTES;\r\np64 = (uint64_t *) cvmx_phys_to_ptr(pkt_buffer.s.addr);\r\np64[0] = 0xffffffffffff0000ull;\r\np64[1] = 0x08004510ull;\r\np64[2] = ((uint64_t) (size - 14) << 48) | 0x5ae740004000ull;\r\np64[3] = 0x3a5fc0a81073c0a8ull;\r\nfor (i = 0; i < num_segs; i++) {\r\nif (i > 0)\r\npkt_buffer.s.size =\r\nFIX_IPD_NON_FIRST_BUFF_PAYLOAD_BYTES;\r\nif (i == (num_segs - 1))\r\npkt_buffer.s.i = 0;\r\n*(uint64_t *) cvmx_phys_to_ptr(g_buffer.s.addr +\r\n8 * i) = pkt_buffer.u64;\r\n}\r\npko_command.u64 = 0;\r\npko_command.s.segs = num_segs;\r\npko_command.s.total_bytes = size;\r\npko_command.s.dontfree = 0;\r\npko_command.s.gather = 1;\r\ngmx_cfg.u64 =\r\ncvmx_read_csr(CVMX_GMXX_PRTX_CFG\r\n(INDEX(FIX_IPD_OUTPORT),\r\nINTERFACE(FIX_IPD_OUTPORT)));\r\ngmx_cfg.s.en = 1;\r\ncvmx_write_csr(CVMX_GMXX_PRTX_CFG\r\n(INDEX(FIX_IPD_OUTPORT),\r\nINTERFACE(FIX_IPD_OUTPORT)), gmx_cfg.u64);\r\ncvmx_write_csr(CVMX_ASXX_TX_PRT_EN(INTERFACE(FIX_IPD_OUTPORT)),\r\n1 << INDEX(FIX_IPD_OUTPORT));\r\ncvmx_write_csr(CVMX_ASXX_RX_PRT_EN(INTERFACE(FIX_IPD_OUTPORT)),\r\n1 << INDEX(FIX_IPD_OUTPORT));\r\ncvmx_write_csr(CVMX_GMXX_RXX_JABBER\r\n(INDEX(FIX_IPD_OUTPORT),\r\nINTERFACE(FIX_IPD_OUTPORT)), 65392 - 14 - 4);\r\ncvmx_write_csr(CVMX_GMXX_RXX_FRM_MAX\r\n(INDEX(FIX_IPD_OUTPORT),\r\nINTERFACE(FIX_IPD_OUTPORT)), 65392 - 14 - 4);\r\ncvmx_pko_send_packet_prepare(FIX_IPD_OUTPORT,\r\ncvmx_pko_get_base_queue\r\n(FIX_IPD_OUTPORT),\r\nCVMX_PKO_LOCK_CMD_QUEUE);\r\ncvmx_pko_send_packet_finish(FIX_IPD_OUTPORT,\r\ncvmx_pko_get_base_queue\r\n(FIX_IPD_OUTPORT), pko_command,\r\ng_buffer, CVMX_PKO_LOCK_CMD_QUEUE);\r\nCVMX_SYNC;\r\ndo {\r\nwork = cvmx_pow_work_request_sync(CVMX_POW_WAIT);\r\nretry_cnt--;\r\n} while ((work == NULL) && (retry_cnt > 0));\r\nif (!retry_cnt)\r\ncvmx_dprintf("WARNING: FIX_IPD_PTR_ALIGNMENT "\r\n"get_work() timeout occurred.\n");\r\nif (work)\r\ncvmx_helper_free_packet_data(work);\r\n}\r\nfix_ipd_exit:\r\ncvmx_write_csr(CVMX_GMXX_PRTX_CFG\r\n(INDEX(FIX_IPD_OUTPORT), INTERFACE(FIX_IPD_OUTPORT)),\r\nprtx_cfg);\r\ncvmx_write_csr(CVMX_ASXX_TX_PRT_EN(INTERFACE(FIX_IPD_OUTPORT)),\r\ntx_ptr_en);\r\ncvmx_write_csr(CVMX_ASXX_RX_PRT_EN(INTERFACE(FIX_IPD_OUTPORT)),\r\nrx_ptr_en);\r\ncvmx_write_csr(CVMX_GMXX_RXX_JABBER\r\n(INDEX(FIX_IPD_OUTPORT), INTERFACE(FIX_IPD_OUTPORT)),\r\nrxx_jabber);\r\ncvmx_write_csr(CVMX_GMXX_RXX_FRM_MAX\r\n(INDEX(FIX_IPD_OUTPORT), INTERFACE(FIX_IPD_OUTPORT)),\r\nframe_max);\r\ncvmx_write_csr(CVMX_ASXX_PRT_LOOP(INTERFACE(FIX_IPD_OUTPORT)), 0);\r\nlink_info.u64 = 0;\r\ncvmx_helper_link_set(FIX_IPD_OUTPORT, link_info);\r\ncvmx_helper_link_autoconf(FIX_IPD_OUTPORT);\r\nCVMX_SYNC;\r\nif (num_segs)\r\ncvmx_dprintf("WARNING: FIX_IPD_PTR_ALIGNMENT failed.\n");\r\nreturn !!num_segs;\r\n}\r\nint cvmx_helper_ipd_and_packet_input_enable(void)\r\n{\r\nint num_interfaces;\r\nint interface;\r\ncvmx_ipd_enable();\r\nnum_interfaces = cvmx_helper_get_number_of_interfaces();\r\nfor (interface = 0; interface < num_interfaces; interface++) {\r\nif (cvmx_helper_ports_on_interface(interface) > 0)\r\n__cvmx_helper_packet_hardware_enable(interface);\r\n}\r\ncvmx_pko_enable();\r\nif ((OCTEON_IS_MODEL(OCTEON_CN31XX_PASS1)\r\n|| OCTEON_IS_MODEL(OCTEON_CN30XX_PASS1))\r\n&& (cvmx_sysinfo_get()->board_type != CVMX_BOARD_TYPE_SIM))\r\n__cvmx_helper_errata_fix_ipd_ptr_alignment();\r\nreturn 0;\r\n}\r\nint cvmx_helper_initialize_packet_io_global(void)\r\n{\r\nint result = 0;\r\nint interface;\r\nunion cvmx_l2c_cfg l2c_cfg;\r\nunion cvmx_smix_en smix_en;\r\nconst int num_interfaces = cvmx_helper_get_number_of_interfaces();\r\nif (OCTEON_IS_MODEL(OCTEON_CN52XX_PASS1_0))\r\n__cvmx_helper_errata_qlm_disable_2nd_order_cdr(1);\r\nl2c_cfg.u64 = cvmx_read_csr(CVMX_L2C_CFG);\r\nl2c_cfg.s.lrf_arb_mode = 0;\r\nl2c_cfg.s.rfb_arb_mode = 0;\r\ncvmx_write_csr(CVMX_L2C_CFG, l2c_cfg.u64);\r\nsmix_en.u64 = cvmx_read_csr(CVMX_SMIX_EN(0));\r\nif (!smix_en.s.en) {\r\nsmix_en.s.en = 1;\r\ncvmx_write_csr(CVMX_SMIX_EN(0), smix_en.u64);\r\n}\r\nif (!OCTEON_IS_MODEL(OCTEON_CN3XXX) &&\r\n!OCTEON_IS_MODEL(OCTEON_CN58XX) &&\r\n!OCTEON_IS_MODEL(OCTEON_CN50XX)) {\r\nsmix_en.u64 = cvmx_read_csr(CVMX_SMIX_EN(1));\r\nif (!smix_en.s.en) {\r\nsmix_en.s.en = 1;\r\ncvmx_write_csr(CVMX_SMIX_EN(1), smix_en.u64);\r\n}\r\n}\r\ncvmx_pko_initialize_global();\r\nfor (interface = 0; interface < num_interfaces; interface++) {\r\nresult |= cvmx_helper_interface_probe(interface);\r\nif (cvmx_helper_ports_on_interface(interface) > 0)\r\ncvmx_dprintf("Interface %d has %d ports (%s)\n",\r\ninterface,\r\ncvmx_helper_ports_on_interface(interface),\r\ncvmx_helper_interface_mode_to_string\r\n(cvmx_helper_interface_get_mode\r\n(interface)));\r\nresult |= __cvmx_helper_interface_setup_ipd(interface);\r\nresult |= __cvmx_helper_interface_setup_pko(interface);\r\n}\r\nresult |= __cvmx_helper_global_setup_ipd();\r\nresult |= __cvmx_helper_global_setup_pko();\r\nresult |= __cvmx_helper_global_setup_backpressure();\r\n#if CVMX_HELPER_ENABLE_IPD\r\nresult |= cvmx_helper_ipd_and_packet_input_enable();\r\n#endif\r\nreturn result;\r\n}\r\nint cvmx_helper_initialize_packet_io_local(void)\r\n{\r\nreturn cvmx_pko_initialize_local();\r\n}\r\ncvmx_helper_link_info_t cvmx_helper_link_autoconf(int ipd_port)\r\n{\r\ncvmx_helper_link_info_t link_info;\r\nint interface = cvmx_helper_get_interface_num(ipd_port);\r\nint index = cvmx_helper_get_interface_index_num(ipd_port);\r\nif (index >= cvmx_helper_ports_on_interface(interface)) {\r\nlink_info.u64 = 0;\r\nreturn link_info;\r\n}\r\nlink_info = cvmx_helper_link_get(ipd_port);\r\nif (link_info.u64 == port_link_info[ipd_port].u64)\r\nreturn link_info;\r\ncvmx_helper_link_set(ipd_port, link_info);\r\nreturn port_link_info[ipd_port];\r\n}\r\ncvmx_helper_link_info_t cvmx_helper_link_get(int ipd_port)\r\n{\r\ncvmx_helper_link_info_t result;\r\nint interface = cvmx_helper_get_interface_num(ipd_port);\r\nint index = cvmx_helper_get_interface_index_num(ipd_port);\r\nresult.u64 = 0;\r\nif (index >= cvmx_helper_ports_on_interface(interface))\r\nreturn result;\r\nswitch (cvmx_helper_interface_get_mode(interface)) {\r\ncase CVMX_HELPER_INTERFACE_MODE_DISABLED:\r\ncase CVMX_HELPER_INTERFACE_MODE_PCIE:\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_XAUI:\r\nresult = __cvmx_helper_xaui_link_get(ipd_port);\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_GMII:\r\nif (index == 0)\r\nresult = __cvmx_helper_rgmii_link_get(ipd_port);\r\nelse {\r\nresult.s.full_duplex = 1;\r\nresult.s.link_up = 1;\r\nresult.s.speed = 1000;\r\n}\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_RGMII:\r\nresult = __cvmx_helper_rgmii_link_get(ipd_port);\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_SPI:\r\nresult = __cvmx_helper_spi_link_get(ipd_port);\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_SGMII:\r\ncase CVMX_HELPER_INTERFACE_MODE_PICMG:\r\nresult = __cvmx_helper_sgmii_link_get(ipd_port);\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_NPI:\r\ncase CVMX_HELPER_INTERFACE_MODE_LOOP:\r\nbreak;\r\n}\r\nreturn result;\r\n}\r\nint cvmx_helper_link_set(int ipd_port, cvmx_helper_link_info_t link_info)\r\n{\r\nint result = -1;\r\nint interface = cvmx_helper_get_interface_num(ipd_port);\r\nint index = cvmx_helper_get_interface_index_num(ipd_port);\r\nif (index >= cvmx_helper_ports_on_interface(interface))\r\nreturn -1;\r\nswitch (cvmx_helper_interface_get_mode(interface)) {\r\ncase CVMX_HELPER_INTERFACE_MODE_DISABLED:\r\ncase CVMX_HELPER_INTERFACE_MODE_PCIE:\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_XAUI:\r\nresult = __cvmx_helper_xaui_link_set(ipd_port, link_info);\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_RGMII:\r\ncase CVMX_HELPER_INTERFACE_MODE_GMII:\r\nresult = __cvmx_helper_rgmii_link_set(ipd_port, link_info);\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_SPI:\r\nresult = __cvmx_helper_spi_link_set(ipd_port, link_info);\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_SGMII:\r\ncase CVMX_HELPER_INTERFACE_MODE_PICMG:\r\nresult = __cvmx_helper_sgmii_link_set(ipd_port, link_info);\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_NPI:\r\ncase CVMX_HELPER_INTERFACE_MODE_LOOP:\r\nbreak;\r\n}\r\nif (result == 0)\r\nport_link_info[ipd_port].u64 = link_info.u64;\r\nreturn result;\r\n}\r\nint cvmx_helper_configure_loopback(int ipd_port, int enable_internal,\r\nint enable_external)\r\n{\r\nint result = -1;\r\nint interface = cvmx_helper_get_interface_num(ipd_port);\r\nint index = cvmx_helper_get_interface_index_num(ipd_port);\r\nif (index >= cvmx_helper_ports_on_interface(interface))\r\nreturn -1;\r\nswitch (cvmx_helper_interface_get_mode(interface)) {\r\ncase CVMX_HELPER_INTERFACE_MODE_DISABLED:\r\ncase CVMX_HELPER_INTERFACE_MODE_PCIE:\r\ncase CVMX_HELPER_INTERFACE_MODE_SPI:\r\ncase CVMX_HELPER_INTERFACE_MODE_NPI:\r\ncase CVMX_HELPER_INTERFACE_MODE_LOOP:\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_XAUI:\r\nresult =\r\n__cvmx_helper_xaui_configure_loopback(ipd_port,\r\nenable_internal,\r\nenable_external);\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_RGMII:\r\ncase CVMX_HELPER_INTERFACE_MODE_GMII:\r\nresult =\r\n__cvmx_helper_rgmii_configure_loopback(ipd_port,\r\nenable_internal,\r\nenable_external);\r\nbreak;\r\ncase CVMX_HELPER_INTERFACE_MODE_SGMII:\r\ncase CVMX_HELPER_INTERFACE_MODE_PICMG:\r\nresult =\r\n__cvmx_helper_sgmii_configure_loopback(ipd_port,\r\nenable_internal,\r\nenable_external);\r\nbreak;\r\n}\r\nreturn result;\r\n}

static int\r\nmthd_flip(struct nouveau_channel *chan, u32 class, u32 mthd, u32 data)\r\n{\r\nstruct nouveau_page_flip_state state;\r\nif (!nouveau_finish_page_flip(chan, &state)) {\r\nnv_set_crtc_base(chan->dev, state.crtc, state.offset +\r\nstate.y * state.pitch +\r\nstate.x * state.bpp / 8);\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nnv04_software_context_new(struct nouveau_channel *chan, int engine)\r\n{\r\nstruct nv04_software_chan *pch;\r\npch = kzalloc(sizeof(*pch), GFP_KERNEL);\r\nif (!pch)\r\nreturn -ENOMEM;\r\nnouveau_software_context_new(&pch->base);\r\nchan->engctx[engine] = pch;\r\nreturn 0;\r\n}\r\nstatic void\r\nnv04_software_context_del(struct nouveau_channel *chan, int engine)\r\n{\r\nstruct nv04_software_chan *pch = chan->engctx[engine];\r\nchan->engctx[engine] = NULL;\r\nkfree(pch);\r\n}\r\nstatic int\r\nnv04_software_object_new(struct nouveau_channel *chan, int engine,\r\nu32 handle, u16 class)\r\n{\r\nstruct drm_device *dev = chan->dev;\r\nstruct nouveau_gpuobj *obj = NULL;\r\nint ret;\r\nret = nouveau_gpuobj_new(dev, chan, 16, 16, 0, &obj);\r\nif (ret)\r\nreturn ret;\r\nobj->engine = 0;\r\nobj->class = class;\r\nret = nouveau_ramht_insert(chan, handle, obj);\r\nnouveau_gpuobj_ref(NULL, &obj);\r\nreturn ret;\r\n}\r\nstatic int\r\nnv04_software_init(struct drm_device *dev, int engine)\r\n{\r\nreturn 0;\r\n}\r\nstatic int\r\nnv04_software_fini(struct drm_device *dev, int engine, bool suspend)\r\n{\r\nreturn 0;\r\n}\r\nstatic void\r\nnv04_software_destroy(struct drm_device *dev, int engine)\r\n{\r\nstruct nv04_software_priv *psw = nv_engine(dev, engine);\r\nNVOBJ_ENGINE_DEL(dev, SW);\r\nkfree(psw);\r\n}\r\nint\r\nnv04_software_create(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nv04_software_priv *psw;\r\npsw = kzalloc(sizeof(*psw), GFP_KERNEL);\r\nif (!psw)\r\nreturn -ENOMEM;\r\npsw->base.base.destroy = nv04_software_destroy;\r\npsw->base.base.init = nv04_software_init;\r\npsw->base.base.fini = nv04_software_fini;\r\npsw->base.base.context_new = nv04_software_context_new;\r\npsw->base.base.context_del = nv04_software_context_del;\r\npsw->base.base.object_new = nv04_software_object_new;\r\nnouveau_software_create(&psw->base);\r\nNVOBJ_ENGINE_ADD(dev, SW, &psw->base.base);\r\nif (dev_priv->card_type <= NV_04) {\r\nNVOBJ_CLASS(dev, 0x006e, SW);\r\nNVOBJ_MTHD (dev, 0x006e, 0x0150, nv04_fence_mthd);\r\nNVOBJ_MTHD (dev, 0x006e, 0x0500, mthd_flip);\r\n} else {\r\nNVOBJ_CLASS(dev, 0x016e, SW);\r\nNVOBJ_MTHD (dev, 0x016e, 0x0500, mthd_flip);\r\n}\r\nreturn 0;\r\n}

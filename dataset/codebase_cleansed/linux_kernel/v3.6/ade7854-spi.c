static int ade7854_spi_write_reg_8(struct device *dev,\r\nu16 reg_address,\r\nu8 value)\r\n{\r\nint ret;\r\nstruct spi_message msg;\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7854_state *st = iio_priv(indio_dev);\r\nstruct spi_transfer xfer = {\r\n.tx_buf = st->tx,\r\n.bits_per_word = 8,\r\n.len = 4,\r\n};\r\nmutex_lock(&st->buf_lock);\r\nst->tx[0] = ADE7854_WRITE_REG;\r\nst->tx[1] = (reg_address >> 8) & 0xFF;\r\nst->tx[2] = reg_address & 0xFF;\r\nst->tx[3] = value & 0xFF;\r\nspi_message_init(&msg);\r\nspi_message_add_tail(&xfer, &msg);\r\nret = spi_sync(st->spi, &msg);\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic int ade7854_spi_write_reg_16(struct device *dev,\r\nu16 reg_address,\r\nu16 value)\r\n{\r\nint ret;\r\nstruct spi_message msg;\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7854_state *st = iio_priv(indio_dev);\r\nstruct spi_transfer xfer = {\r\n.tx_buf = st->tx,\r\n.bits_per_word = 8,\r\n.len = 5,\r\n};\r\nmutex_lock(&st->buf_lock);\r\nst->tx[0] = ADE7854_WRITE_REG;\r\nst->tx[1] = (reg_address >> 8) & 0xFF;\r\nst->tx[2] = reg_address & 0xFF;\r\nst->tx[3] = (value >> 8) & 0xFF;\r\nst->tx[4] = value & 0xFF;\r\nspi_message_init(&msg);\r\nspi_message_add_tail(&xfer, &msg);\r\nret = spi_sync(st->spi, &msg);\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic int ade7854_spi_write_reg_24(struct device *dev,\r\nu16 reg_address,\r\nu32 value)\r\n{\r\nint ret;\r\nstruct spi_message msg;\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7854_state *st = iio_priv(indio_dev);\r\nstruct spi_transfer xfer = {\r\n.tx_buf = st->tx,\r\n.bits_per_word = 8,\r\n.len = 6,\r\n};\r\nmutex_lock(&st->buf_lock);\r\nst->tx[0] = ADE7854_WRITE_REG;\r\nst->tx[1] = (reg_address >> 8) & 0xFF;\r\nst->tx[2] = reg_address & 0xFF;\r\nst->tx[3] = (value >> 16) & 0xFF;\r\nst->tx[4] = (value >> 8) & 0xFF;\r\nst->tx[5] = value & 0xFF;\r\nspi_message_init(&msg);\r\nspi_message_add_tail(&xfer, &msg);\r\nret = spi_sync(st->spi, &msg);\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic int ade7854_spi_write_reg_32(struct device *dev,\r\nu16 reg_address,\r\nu32 value)\r\n{\r\nint ret;\r\nstruct spi_message msg;\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7854_state *st = iio_priv(indio_dev);\r\nstruct spi_transfer xfer = {\r\n.tx_buf = st->tx,\r\n.bits_per_word = 8,\r\n.len = 7,\r\n};\r\nmutex_lock(&st->buf_lock);\r\nst->tx[0] = ADE7854_WRITE_REG;\r\nst->tx[1] = (reg_address >> 8) & 0xFF;\r\nst->tx[2] = reg_address & 0xFF;\r\nst->tx[3] = (value >> 24) & 0xFF;\r\nst->tx[4] = (value >> 16) & 0xFF;\r\nst->tx[5] = (value >> 8) & 0xFF;\r\nst->tx[6] = value & 0xFF;\r\nspi_message_init(&msg);\r\nspi_message_add_tail(&xfer, &msg);\r\nret = spi_sync(st->spi, &msg);\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic int ade7854_spi_read_reg_8(struct device *dev,\r\nu16 reg_address,\r\nu8 *val)\r\n{\r\nstruct spi_message msg;\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7854_state *st = iio_priv(indio_dev);\r\nint ret;\r\nstruct spi_transfer xfers[] = {\r\n{\r\n.tx_buf = st->tx,\r\n.bits_per_word = 8,\r\n.len = 3,\r\n}, {\r\n.rx_buf = st->rx,\r\n.bits_per_word = 8,\r\n.len = 1,\r\n}\r\n};\r\nmutex_lock(&st->buf_lock);\r\nst->tx[0] = ADE7854_READ_REG;\r\nst->tx[1] = (reg_address >> 8) & 0xFF;\r\nst->tx[2] = reg_address & 0xFF;\r\nspi_message_init(&msg);\r\nspi_message_add_tail(&xfers[0], &msg);\r\nspi_message_add_tail(&xfers[1], &msg);\r\nret = spi_sync(st->spi, &msg);\r\nif (ret) {\r\ndev_err(&st->spi->dev, "problem when reading 8 bit register 0x%02X",\r\nreg_address);\r\ngoto error_ret;\r\n}\r\n*val = st->rx[0];\r\nerror_ret:\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic int ade7854_spi_read_reg_16(struct device *dev,\r\nu16 reg_address,\r\nu16 *val)\r\n{\r\nstruct spi_message msg;\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7854_state *st = iio_priv(indio_dev);\r\nint ret;\r\nstruct spi_transfer xfers[] = {\r\n{\r\n.tx_buf = st->tx,\r\n.bits_per_word = 8,\r\n.len = 3,\r\n}, {\r\n.rx_buf = st->rx,\r\n.bits_per_word = 8,\r\n.len = 2,\r\n}\r\n};\r\nmutex_lock(&st->buf_lock);\r\nst->tx[0] = ADE7854_READ_REG;\r\nst->tx[1] = (reg_address >> 8) & 0xFF;\r\nst->tx[2] = reg_address & 0xFF;\r\nspi_message_init(&msg);\r\nspi_message_add_tail(&xfers[0], &msg);\r\nspi_message_add_tail(&xfers[1], &msg);\r\nret = spi_sync(st->spi, &msg);\r\nif (ret) {\r\ndev_err(&st->spi->dev, "problem when reading 16 bit register 0x%02X",\r\nreg_address);\r\ngoto error_ret;\r\n}\r\n*val = be16_to_cpup((const __be16 *)st->rx);\r\nerror_ret:\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic int ade7854_spi_read_reg_24(struct device *dev,\r\nu16 reg_address,\r\nu32 *val)\r\n{\r\nstruct spi_message msg;\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7854_state *st = iio_priv(indio_dev);\r\nint ret;\r\nstruct spi_transfer xfers[] = {\r\n{\r\n.tx_buf = st->tx,\r\n.bits_per_word = 8,\r\n.len = 3,\r\n}, {\r\n.rx_buf = st->rx,\r\n.bits_per_word = 8,\r\n.len = 3,\r\n}\r\n};\r\nmutex_lock(&st->buf_lock);\r\nst->tx[0] = ADE7854_READ_REG;\r\nst->tx[1] = (reg_address >> 8) & 0xFF;\r\nst->tx[2] = reg_address & 0xFF;\r\nspi_message_init(&msg);\r\nspi_message_add_tail(&xfers[0], &msg);\r\nspi_message_add_tail(&xfers[1], &msg);\r\nret = spi_sync(st->spi, &msg);\r\nif (ret) {\r\ndev_err(&st->spi->dev, "problem when reading 24 bit register 0x%02X",\r\nreg_address);\r\ngoto error_ret;\r\n}\r\n*val = (st->rx[0] << 16) | (st->rx[1] << 8) | st->rx[2];\r\nerror_ret:\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic int ade7854_spi_read_reg_32(struct device *dev,\r\nu16 reg_address,\r\nu32 *val)\r\n{\r\nstruct spi_message msg;\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7854_state *st = iio_priv(indio_dev);\r\nint ret;\r\nstruct spi_transfer xfers[] = {\r\n{\r\n.tx_buf = st->tx,\r\n.bits_per_word = 8,\r\n.len = 3,\r\n}, {\r\n.rx_buf = st->rx,\r\n.bits_per_word = 8,\r\n.len = 4,\r\n}\r\n};\r\nmutex_lock(&st->buf_lock);\r\nst->tx[0] = ADE7854_READ_REG;\r\nst->tx[1] = (reg_address >> 8) & 0xFF;\r\nst->tx[2] = reg_address & 0xFF;\r\nspi_message_init(&msg);\r\nspi_message_add_tail(&xfers[0], &msg);\r\nspi_message_add_tail(&xfers[1], &msg);\r\nret = spi_sync(st->spi, &msg);\r\nif (ret) {\r\ndev_err(&st->spi->dev, "problem when reading 32 bit register 0x%02X",\r\nreg_address);\r\ngoto error_ret;\r\n}\r\n*val = be32_to_cpup((const __be32 *)st->rx);\r\nerror_ret:\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic int __devinit ade7854_spi_probe(struct spi_device *spi)\r\n{\r\nint ret;\r\nstruct ade7854_state *st;\r\nstruct iio_dev *indio_dev;\r\nindio_dev = iio_device_alloc(sizeof(*st));\r\nif (indio_dev == NULL)\r\nreturn -ENOMEM;\r\nst = iio_priv(indio_dev);\r\nspi_set_drvdata(spi, indio_dev);\r\nst->read_reg_8 = ade7854_spi_read_reg_8;\r\nst->read_reg_16 = ade7854_spi_read_reg_16;\r\nst->read_reg_24 = ade7854_spi_read_reg_24;\r\nst->read_reg_32 = ade7854_spi_read_reg_32;\r\nst->write_reg_8 = ade7854_spi_write_reg_8;\r\nst->write_reg_16 = ade7854_spi_write_reg_16;\r\nst->write_reg_24 = ade7854_spi_write_reg_24;\r\nst->write_reg_32 = ade7854_spi_write_reg_32;\r\nst->irq = spi->irq;\r\nst->spi = spi;\r\nret = ade7854_probe(indio_dev, &spi->dev);\r\nif (ret)\r\niio_device_free(indio_dev);\r\nreturn 0;\r\n}\r\nstatic int ade7854_spi_remove(struct spi_device *spi)\r\n{\r\nade7854_remove(spi_get_drvdata(spi));\r\nreturn 0;\r\n}

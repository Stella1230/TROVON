static int i2c_mux_master_xfer(struct i2c_adapter *adap,\r\nstruct i2c_msg msgs[], int num)\r\n{\r\nstruct i2c_mux_priv *priv = adap->algo_data;\r\nstruct i2c_adapter *parent = priv->parent;\r\nint ret;\r\nret = priv->select(parent, priv->mux_priv, priv->chan_id);\r\nif (ret >= 0)\r\nret = parent->algo->master_xfer(parent, msgs, num);\r\nif (priv->deselect)\r\npriv->deselect(parent, priv->mux_priv, priv->chan_id);\r\nreturn ret;\r\n}\r\nstatic int i2c_mux_smbus_xfer(struct i2c_adapter *adap,\r\nu16 addr, unsigned short flags,\r\nchar read_write, u8 command,\r\nint size, union i2c_smbus_data *data)\r\n{\r\nstruct i2c_mux_priv *priv = adap->algo_data;\r\nstruct i2c_adapter *parent = priv->parent;\r\nint ret;\r\nret = priv->select(parent, priv->mux_priv, priv->chan_id);\r\nif (ret >= 0)\r\nret = parent->algo->smbus_xfer(parent, addr, flags,\r\nread_write, command, size, data);\r\nif (priv->deselect)\r\npriv->deselect(parent, priv->mux_priv, priv->chan_id);\r\nreturn ret;\r\n}\r\nstatic u32 i2c_mux_functionality(struct i2c_adapter *adap)\r\n{\r\nstruct i2c_mux_priv *priv = adap->algo_data;\r\nstruct i2c_adapter *parent = priv->parent;\r\nreturn parent->algo->functionality(parent);\r\n}\r\nstruct i2c_adapter *i2c_add_mux_adapter(struct i2c_adapter *parent,\r\nstruct device *mux_dev,\r\nvoid *mux_priv, u32 force_nr, u32 chan_id,\r\nint (*select) (struct i2c_adapter *,\r\nvoid *, u32),\r\nint (*deselect) (struct i2c_adapter *,\r\nvoid *, u32))\r\n{\r\nstruct i2c_mux_priv *priv;\r\nint ret;\r\npriv = kzalloc(sizeof(struct i2c_mux_priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn NULL;\r\npriv->parent = parent;\r\npriv->mux_priv = mux_priv;\r\npriv->chan_id = chan_id;\r\npriv->select = select;\r\npriv->deselect = deselect;\r\nif (parent->algo->master_xfer)\r\npriv->algo.master_xfer = i2c_mux_master_xfer;\r\nif (parent->algo->smbus_xfer)\r\npriv->algo.smbus_xfer = i2c_mux_smbus_xfer;\r\npriv->algo.functionality = i2c_mux_functionality;\r\nsnprintf(priv->adap.name, sizeof(priv->adap.name),\r\n"i2c-%d-mux (chan_id %d)", i2c_adapter_id(parent), chan_id);\r\npriv->adap.owner = THIS_MODULE;\r\npriv->adap.algo = &priv->algo;\r\npriv->adap.algo_data = priv;\r\npriv->adap.dev.parent = &parent->dev;\r\nif (mux_dev->of_node) {\r\nstruct device_node *child;\r\nu32 reg;\r\nfor_each_child_of_node(mux_dev->of_node, child) {\r\nret = of_property_read_u32(child, "reg", &reg);\r\nif (ret)\r\ncontinue;\r\nif (chan_id == reg) {\r\npriv->adap.dev.of_node = child;\r\nbreak;\r\n}\r\n}\r\n}\r\nif (force_nr) {\r\npriv->adap.nr = force_nr;\r\nret = i2c_add_numbered_adapter(&priv->adap);\r\n} else {\r\nret = i2c_add_adapter(&priv->adap);\r\n}\r\nif (ret < 0) {\r\ndev_err(&parent->dev,\r\n"failed to add mux-adapter (error=%d)\n",\r\nret);\r\nkfree(priv);\r\nreturn NULL;\r\n}\r\ndev_info(&parent->dev, "Added multiplexed i2c bus %d\n",\r\ni2c_adapter_id(&priv->adap));\r\nof_i2c_register_devices(&priv->adap);\r\nreturn &priv->adap;\r\n}\r\nint i2c_del_mux_adapter(struct i2c_adapter *adap)\r\n{\r\nstruct i2c_mux_priv *priv = adap->algo_data;\r\nint ret;\r\nret = i2c_del_adapter(adap);\r\nif (ret < 0)\r\nreturn ret;\r\nkfree(priv);\r\nreturn 0;\r\n}

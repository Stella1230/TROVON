static inline struct xfs_inode_log_item *INODE_ITEM(struct xfs_log_item *lip)\r\n{\r\nreturn container_of(lip, struct xfs_inode_log_item, ili_item);\r\n}\r\nSTATIC uint\r\nxfs_inode_item_size(\r\nstruct xfs_log_item *lip)\r\n{\r\nstruct xfs_inode_log_item *iip = INODE_ITEM(lip);\r\nstruct xfs_inode *ip = iip->ili_inode;\r\nuint nvecs = 2;\r\nswitch (ip->i_d.di_format) {\r\ncase XFS_DINODE_FMT_EXTENTS:\r\nif ((iip->ili_fields & XFS_ILOG_DEXT) &&\r\nip->i_d.di_nextents > 0 &&\r\nip->i_df.if_bytes > 0)\r\nnvecs++;\r\nbreak;\r\ncase XFS_DINODE_FMT_BTREE:\r\nif ((iip->ili_fields & XFS_ILOG_DBROOT) &&\r\nip->i_df.if_broot_bytes > 0)\r\nnvecs++;\r\nbreak;\r\ncase XFS_DINODE_FMT_LOCAL:\r\nif ((iip->ili_fields & XFS_ILOG_DDATA) &&\r\nip->i_df.if_bytes > 0)\r\nnvecs++;\r\nbreak;\r\ncase XFS_DINODE_FMT_DEV:\r\ncase XFS_DINODE_FMT_UUID:\r\nbreak;\r\ndefault:\r\nASSERT(0);\r\nbreak;\r\n}\r\nif (!XFS_IFORK_Q(ip))\r\nreturn nvecs;\r\nswitch (ip->i_d.di_aformat) {\r\ncase XFS_DINODE_FMT_EXTENTS:\r\nif ((iip->ili_fields & XFS_ILOG_AEXT) &&\r\nip->i_d.di_anextents > 0 &&\r\nip->i_afp->if_bytes > 0)\r\nnvecs++;\r\nbreak;\r\ncase XFS_DINODE_FMT_BTREE:\r\nif ((iip->ili_fields & XFS_ILOG_ABROOT) &&\r\nip->i_afp->if_broot_bytes > 0)\r\nnvecs++;\r\nbreak;\r\ncase XFS_DINODE_FMT_LOCAL:\r\nif ((iip->ili_fields & XFS_ILOG_ADATA) &&\r\nip->i_afp->if_bytes > 0)\r\nnvecs++;\r\nbreak;\r\ndefault:\r\nASSERT(0);\r\nbreak;\r\n}\r\nreturn nvecs;\r\n}\r\nSTATIC void\r\nxfs_inode_item_format_extents(\r\nstruct xfs_inode *ip,\r\nstruct xfs_log_iovec *vecp,\r\nint whichfork,\r\nint type)\r\n{\r\nxfs_bmbt_rec_t *ext_buffer;\r\next_buffer = kmem_alloc(XFS_IFORK_SIZE(ip, whichfork), KM_SLEEP);\r\nif (whichfork == XFS_DATA_FORK)\r\nip->i_itemp->ili_extents_buf = ext_buffer;\r\nelse\r\nip->i_itemp->ili_aextents_buf = ext_buffer;\r\nvecp->i_addr = ext_buffer;\r\nvecp->i_len = xfs_iextents_copy(ip, ext_buffer, whichfork);\r\nvecp->i_type = type;\r\n}\r\nSTATIC void\r\nxfs_inode_item_format(\r\nstruct xfs_log_item *lip,\r\nstruct xfs_log_iovec *vecp)\r\n{\r\nstruct xfs_inode_log_item *iip = INODE_ITEM(lip);\r\nstruct xfs_inode *ip = iip->ili_inode;\r\nuint nvecs;\r\nsize_t data_bytes;\r\nxfs_mount_t *mp;\r\nvecp->i_addr = &iip->ili_format;\r\nvecp->i_len = sizeof(xfs_inode_log_format_t);\r\nvecp->i_type = XLOG_REG_TYPE_IFORMAT;\r\nvecp++;\r\nnvecs = 1;\r\nvecp->i_addr = &ip->i_d;\r\nvecp->i_len = sizeof(struct xfs_icdinode);\r\nvecp->i_type = XLOG_REG_TYPE_ICORE;\r\nvecp++;\r\nnvecs++;\r\nmp = ip->i_mount;\r\nASSERT(ip->i_d.di_version == 1 || xfs_sb_version_hasnlink(&mp->m_sb));\r\nif (ip->i_d.di_version == 1) {\r\nif (!xfs_sb_version_hasnlink(&mp->m_sb)) {\r\nASSERT(ip->i_d.di_nlink <= XFS_MAXLINK_1);\r\nip->i_d.di_onlink = ip->i_d.di_nlink;\r\n} else {\r\nip->i_d.di_version = 2;\r\nip->i_d.di_onlink = 0;\r\nmemset(&(ip->i_d.di_pad[0]), 0, sizeof(ip->i_d.di_pad));\r\n}\r\n}\r\nswitch (ip->i_d.di_format) {\r\ncase XFS_DINODE_FMT_EXTENTS:\r\niip->ili_fields &=\r\n~(XFS_ILOG_DDATA | XFS_ILOG_DBROOT |\r\nXFS_ILOG_DEV | XFS_ILOG_UUID);\r\nif ((iip->ili_fields & XFS_ILOG_DEXT) &&\r\nip->i_d.di_nextents > 0 &&\r\nip->i_df.if_bytes > 0) {\r\nASSERT(ip->i_df.if_u1.if_extents != NULL);\r\nASSERT(ip->i_df.if_bytes / sizeof(xfs_bmbt_rec_t) > 0);\r\nASSERT(iip->ili_extents_buf == NULL);\r\n#ifdef XFS_NATIVE_HOST\r\nif (ip->i_d.di_nextents == ip->i_df.if_bytes /\r\n(uint)sizeof(xfs_bmbt_rec_t)) {\r\nvecp->i_addr = ip->i_df.if_u1.if_extents;\r\nvecp->i_len = ip->i_df.if_bytes;\r\nvecp->i_type = XLOG_REG_TYPE_IEXT;\r\n} else\r\n#endif\r\n{\r\nxfs_inode_item_format_extents(ip, vecp,\r\nXFS_DATA_FORK, XLOG_REG_TYPE_IEXT);\r\n}\r\nASSERT(vecp->i_len <= ip->i_df.if_bytes);\r\niip->ili_format.ilf_dsize = vecp->i_len;\r\nvecp++;\r\nnvecs++;\r\n} else {\r\niip->ili_fields &= ~XFS_ILOG_DEXT;\r\n}\r\nbreak;\r\ncase XFS_DINODE_FMT_BTREE:\r\niip->ili_fields &=\r\n~(XFS_ILOG_DDATA | XFS_ILOG_DEXT |\r\nXFS_ILOG_DEV | XFS_ILOG_UUID);\r\nif ((iip->ili_fields & XFS_ILOG_DBROOT) &&\r\nip->i_df.if_broot_bytes > 0) {\r\nASSERT(ip->i_df.if_broot != NULL);\r\nvecp->i_addr = ip->i_df.if_broot;\r\nvecp->i_len = ip->i_df.if_broot_bytes;\r\nvecp->i_type = XLOG_REG_TYPE_IBROOT;\r\nvecp++;\r\nnvecs++;\r\niip->ili_format.ilf_dsize = ip->i_df.if_broot_bytes;\r\n} else {\r\nASSERT(!(iip->ili_fields &\r\nXFS_ILOG_DBROOT));\r\n#ifdef XFS_TRANS_DEBUG\r\nif (iip->ili_root_size > 0) {\r\nASSERT(iip->ili_root_size ==\r\nip->i_df.if_broot_bytes);\r\nASSERT(memcmp(iip->ili_orig_root,\r\nip->i_df.if_broot,\r\niip->ili_root_size) == 0);\r\n} else {\r\nASSERT(ip->i_df.if_broot_bytes == 0);\r\n}\r\n#endif\r\niip->ili_fields &= ~XFS_ILOG_DBROOT;\r\n}\r\nbreak;\r\ncase XFS_DINODE_FMT_LOCAL:\r\niip->ili_fields &=\r\n~(XFS_ILOG_DEXT | XFS_ILOG_DBROOT |\r\nXFS_ILOG_DEV | XFS_ILOG_UUID);\r\nif ((iip->ili_fields & XFS_ILOG_DDATA) &&\r\nip->i_df.if_bytes > 0) {\r\nASSERT(ip->i_df.if_u1.if_data != NULL);\r\nASSERT(ip->i_d.di_size > 0);\r\nvecp->i_addr = ip->i_df.if_u1.if_data;\r\ndata_bytes = roundup(ip->i_df.if_bytes, 4);\r\nASSERT((ip->i_df.if_real_bytes == 0) ||\r\n(ip->i_df.if_real_bytes == data_bytes));\r\nvecp->i_len = (int)data_bytes;\r\nvecp->i_type = XLOG_REG_TYPE_ILOCAL;\r\nvecp++;\r\nnvecs++;\r\niip->ili_format.ilf_dsize = (unsigned)data_bytes;\r\n} else {\r\niip->ili_fields &= ~XFS_ILOG_DDATA;\r\n}\r\nbreak;\r\ncase XFS_DINODE_FMT_DEV:\r\niip->ili_fields &=\r\n~(XFS_ILOG_DDATA | XFS_ILOG_DBROOT |\r\nXFS_ILOG_DEXT | XFS_ILOG_UUID);\r\nif (iip->ili_fields & XFS_ILOG_DEV) {\r\niip->ili_format.ilf_u.ilfu_rdev =\r\nip->i_df.if_u2.if_rdev;\r\n}\r\nbreak;\r\ncase XFS_DINODE_FMT_UUID:\r\niip->ili_fields &=\r\n~(XFS_ILOG_DDATA | XFS_ILOG_DBROOT |\r\nXFS_ILOG_DEXT | XFS_ILOG_DEV);\r\nif (iip->ili_fields & XFS_ILOG_UUID) {\r\niip->ili_format.ilf_u.ilfu_uuid =\r\nip->i_df.if_u2.if_uuid;\r\n}\r\nbreak;\r\ndefault:\r\nASSERT(0);\r\nbreak;\r\n}\r\nif (!XFS_IFORK_Q(ip)) {\r\niip->ili_fields &=\r\n~(XFS_ILOG_ADATA | XFS_ILOG_ABROOT | XFS_ILOG_AEXT);\r\ngoto out;\r\n}\r\nswitch (ip->i_d.di_aformat) {\r\ncase XFS_DINODE_FMT_EXTENTS:\r\niip->ili_fields &=\r\n~(XFS_ILOG_ADATA | XFS_ILOG_ABROOT);\r\nif ((iip->ili_fields & XFS_ILOG_AEXT) &&\r\nip->i_d.di_anextents > 0 &&\r\nip->i_afp->if_bytes > 0) {\r\nASSERT(ip->i_afp->if_bytes / sizeof(xfs_bmbt_rec_t) ==\r\nip->i_d.di_anextents);\r\nASSERT(ip->i_afp->if_u1.if_extents != NULL);\r\n#ifdef XFS_NATIVE_HOST\r\nvecp->i_addr = ip->i_afp->if_u1.if_extents;\r\nvecp->i_len = ip->i_afp->if_bytes;\r\nvecp->i_type = XLOG_REG_TYPE_IATTR_EXT;\r\n#else\r\nASSERT(iip->ili_aextents_buf == NULL);\r\nxfs_inode_item_format_extents(ip, vecp,\r\nXFS_ATTR_FORK, XLOG_REG_TYPE_IATTR_EXT);\r\n#endif\r\niip->ili_format.ilf_asize = vecp->i_len;\r\nvecp++;\r\nnvecs++;\r\n} else {\r\niip->ili_fields &= ~XFS_ILOG_AEXT;\r\n}\r\nbreak;\r\ncase XFS_DINODE_FMT_BTREE:\r\niip->ili_fields &=\r\n~(XFS_ILOG_ADATA | XFS_ILOG_AEXT);\r\nif ((iip->ili_fields & XFS_ILOG_ABROOT) &&\r\nip->i_afp->if_broot_bytes > 0) {\r\nASSERT(ip->i_afp->if_broot != NULL);\r\nvecp->i_addr = ip->i_afp->if_broot;\r\nvecp->i_len = ip->i_afp->if_broot_bytes;\r\nvecp->i_type = XLOG_REG_TYPE_IATTR_BROOT;\r\nvecp++;\r\nnvecs++;\r\niip->ili_format.ilf_asize = ip->i_afp->if_broot_bytes;\r\n} else {\r\niip->ili_fields &= ~XFS_ILOG_ABROOT;\r\n}\r\nbreak;\r\ncase XFS_DINODE_FMT_LOCAL:\r\niip->ili_fields &=\r\n~(XFS_ILOG_AEXT | XFS_ILOG_ABROOT);\r\nif ((iip->ili_fields & XFS_ILOG_ADATA) &&\r\nip->i_afp->if_bytes > 0) {\r\nASSERT(ip->i_afp->if_u1.if_data != NULL);\r\nvecp->i_addr = ip->i_afp->if_u1.if_data;\r\ndata_bytes = roundup(ip->i_afp->if_bytes, 4);\r\nASSERT((ip->i_afp->if_real_bytes == 0) ||\r\n(ip->i_afp->if_real_bytes == data_bytes));\r\nvecp->i_len = (int)data_bytes;\r\nvecp->i_type = XLOG_REG_TYPE_IATTR_LOCAL;\r\nvecp++;\r\nnvecs++;\r\niip->ili_format.ilf_asize = (unsigned)data_bytes;\r\n} else {\r\niip->ili_fields &= ~XFS_ILOG_ADATA;\r\n}\r\nbreak;\r\ndefault:\r\nASSERT(0);\r\nbreak;\r\n}\r\nout:\r\niip->ili_format.ilf_fields = XFS_ILOG_CORE |\r\n(iip->ili_fields & ~XFS_ILOG_TIMESTAMP);\r\niip->ili_format.ilf_size = nvecs;\r\n}\r\nSTATIC void\r\nxfs_inode_item_pin(\r\nstruct xfs_log_item *lip)\r\n{\r\nstruct xfs_inode *ip = INODE_ITEM(lip)->ili_inode;\r\nASSERT(xfs_isilocked(ip, XFS_ILOCK_EXCL));\r\ntrace_xfs_inode_pin(ip, _RET_IP_);\r\natomic_inc(&ip->i_pincount);\r\n}\r\nSTATIC void\r\nxfs_inode_item_unpin(\r\nstruct xfs_log_item *lip,\r\nint remove)\r\n{\r\nstruct xfs_inode *ip = INODE_ITEM(lip)->ili_inode;\r\ntrace_xfs_inode_unpin(ip, _RET_IP_);\r\nASSERT(atomic_read(&ip->i_pincount) > 0);\r\nif (atomic_dec_and_test(&ip->i_pincount))\r\nwake_up_bit(&ip->i_flags, __XFS_IPINNED_BIT);\r\n}\r\nSTATIC uint\r\nxfs_inode_item_push(\r\nstruct xfs_log_item *lip,\r\nstruct list_head *buffer_list)\r\n{\r\nstruct xfs_inode_log_item *iip = INODE_ITEM(lip);\r\nstruct xfs_inode *ip = iip->ili_inode;\r\nstruct xfs_buf *bp = NULL;\r\nuint rval = XFS_ITEM_SUCCESS;\r\nint error;\r\nif (xfs_ipincount(ip) > 0)\r\nreturn XFS_ITEM_PINNED;\r\nif (!xfs_ilock_nowait(ip, XFS_ILOCK_SHARED))\r\nreturn XFS_ITEM_LOCKED;\r\nif (xfs_ipincount(ip) > 0) {\r\nrval = XFS_ITEM_PINNED;\r\ngoto out_unlock;\r\n}\r\nif (ip->i_flags & XFS_ISTALE) {\r\nrval = XFS_ITEM_PINNED;\r\ngoto out_unlock;\r\n}\r\nif (!xfs_iflock_nowait(ip)) {\r\nrval = XFS_ITEM_FLUSHING;\r\ngoto out_unlock;\r\n}\r\nASSERT(iip->ili_fields != 0 || XFS_FORCED_SHUTDOWN(ip->i_mount));\r\nASSERT(iip->ili_logged == 0 || XFS_FORCED_SHUTDOWN(ip->i_mount));\r\nspin_unlock(&lip->li_ailp->xa_lock);\r\nerror = xfs_iflush(ip, &bp);\r\nif (!error) {\r\nif (!xfs_buf_delwri_queue(bp, buffer_list))\r\nrval = XFS_ITEM_FLUSHING;\r\nxfs_buf_relse(bp);\r\n}\r\nspin_lock(&lip->li_ailp->xa_lock);\r\nout_unlock:\r\nxfs_iunlock(ip, XFS_ILOCK_SHARED);\r\nreturn rval;\r\n}\r\nSTATIC void\r\nxfs_inode_item_unlock(\r\nstruct xfs_log_item *lip)\r\n{\r\nstruct xfs_inode_log_item *iip = INODE_ITEM(lip);\r\nstruct xfs_inode *ip = iip->ili_inode;\r\nunsigned short lock_flags;\r\nASSERT(ip->i_itemp != NULL);\r\nASSERT(xfs_isilocked(ip, XFS_ILOCK_EXCL));\r\nif (iip->ili_extents_buf != NULL) {\r\nASSERT(ip->i_d.di_format == XFS_DINODE_FMT_EXTENTS);\r\nASSERT(ip->i_d.di_nextents > 0);\r\nASSERT(iip->ili_fields & XFS_ILOG_DEXT);\r\nASSERT(ip->i_df.if_bytes > 0);\r\nkmem_free(iip->ili_extents_buf);\r\niip->ili_extents_buf = NULL;\r\n}\r\nif (iip->ili_aextents_buf != NULL) {\r\nASSERT(ip->i_d.di_aformat == XFS_DINODE_FMT_EXTENTS);\r\nASSERT(ip->i_d.di_anextents > 0);\r\nASSERT(iip->ili_fields & XFS_ILOG_AEXT);\r\nASSERT(ip->i_afp->if_bytes > 0);\r\nkmem_free(iip->ili_aextents_buf);\r\niip->ili_aextents_buf = NULL;\r\n}\r\nlock_flags = iip->ili_lock_flags;\r\niip->ili_lock_flags = 0;\r\nif (lock_flags)\r\nxfs_iunlock(ip, lock_flags);\r\n}\r\nSTATIC xfs_lsn_t\r\nxfs_inode_item_committed(\r\nstruct xfs_log_item *lip,\r\nxfs_lsn_t lsn)\r\n{\r\nstruct xfs_inode_log_item *iip = INODE_ITEM(lip);\r\nstruct xfs_inode *ip = iip->ili_inode;\r\nif (xfs_iflags_test(ip, XFS_ISTALE)) {\r\nxfs_inode_item_unpin(lip, 0);\r\nreturn -1;\r\n}\r\nreturn lsn;\r\n}\r\nSTATIC void\r\nxfs_inode_item_committing(\r\nstruct xfs_log_item *lip,\r\nxfs_lsn_t lsn)\r\n{\r\nINODE_ITEM(lip)->ili_last_lsn = lsn;\r\n}\r\nvoid\r\nxfs_inode_item_init(\r\nstruct xfs_inode *ip,\r\nstruct xfs_mount *mp)\r\n{\r\nstruct xfs_inode_log_item *iip;\r\nASSERT(ip->i_itemp == NULL);\r\niip = ip->i_itemp = kmem_zone_zalloc(xfs_ili_zone, KM_SLEEP);\r\niip->ili_inode = ip;\r\nxfs_log_item_init(mp, &iip->ili_item, XFS_LI_INODE,\r\n&xfs_inode_item_ops);\r\niip->ili_format.ilf_type = XFS_LI_INODE;\r\niip->ili_format.ilf_ino = ip->i_ino;\r\niip->ili_format.ilf_blkno = ip->i_imap.im_blkno;\r\niip->ili_format.ilf_len = ip->i_imap.im_len;\r\niip->ili_format.ilf_boffset = ip->i_imap.im_boffset;\r\n}\r\nvoid\r\nxfs_inode_item_destroy(\r\nxfs_inode_t *ip)\r\n{\r\n#ifdef XFS_TRANS_DEBUG\r\nif (ip->i_itemp->ili_root_size != 0) {\r\nkmem_free(ip->i_itemp->ili_orig_root);\r\n}\r\n#endif\r\nkmem_zone_free(xfs_ili_zone, ip->i_itemp);\r\n}\r\nvoid\r\nxfs_iflush_done(\r\nstruct xfs_buf *bp,\r\nstruct xfs_log_item *lip)\r\n{\r\nstruct xfs_inode_log_item *iip;\r\nstruct xfs_log_item *blip;\r\nstruct xfs_log_item *next;\r\nstruct xfs_log_item *prev;\r\nstruct xfs_ail *ailp = lip->li_ailp;\r\nint need_ail = 0;\r\nblip = bp->b_fspriv;\r\nprev = NULL;\r\nwhile (blip != NULL) {\r\nif (lip->li_cb != xfs_iflush_done) {\r\nprev = blip;\r\nblip = blip->li_bio_list;\r\ncontinue;\r\n}\r\nnext = blip->li_bio_list;\r\nif (!prev) {\r\nbp->b_fspriv = next;\r\n} else {\r\nprev->li_bio_list = next;\r\n}\r\nblip->li_bio_list = lip->li_bio_list;\r\nlip->li_bio_list = blip;\r\niip = INODE_ITEM(blip);\r\nif (iip->ili_logged && blip->li_lsn == iip->ili_flush_lsn)\r\nneed_ail++;\r\nblip = next;\r\n}\r\niip = INODE_ITEM(lip);\r\nif (iip->ili_logged && lip->li_lsn == iip->ili_flush_lsn)\r\nneed_ail++;\r\nif (need_ail) {\r\nstruct xfs_log_item *log_items[need_ail];\r\nint i = 0;\r\nspin_lock(&ailp->xa_lock);\r\nfor (blip = lip; blip; blip = blip->li_bio_list) {\r\niip = INODE_ITEM(blip);\r\nif (iip->ili_logged &&\r\nblip->li_lsn == iip->ili_flush_lsn) {\r\nlog_items[i++] = blip;\r\n}\r\nASSERT(i <= need_ail);\r\n}\r\nxfs_trans_ail_delete_bulk(ailp, log_items, i,\r\nSHUTDOWN_CORRUPT_INCORE);\r\n}\r\nfor (blip = lip; blip; blip = next) {\r\nnext = blip->li_bio_list;\r\nblip->li_bio_list = NULL;\r\niip = INODE_ITEM(blip);\r\niip->ili_logged = 0;\r\niip->ili_last_fields = 0;\r\nxfs_ifunlock(iip->ili_inode);\r\n}\r\n}\r\nvoid\r\nxfs_iflush_abort(\r\nxfs_inode_t *ip,\r\nbool stale)\r\n{\r\nxfs_inode_log_item_t *iip = ip->i_itemp;\r\nif (iip) {\r\nstruct xfs_ail *ailp = iip->ili_item.li_ailp;\r\nif (iip->ili_item.li_flags & XFS_LI_IN_AIL) {\r\nspin_lock(&ailp->xa_lock);\r\nif (iip->ili_item.li_flags & XFS_LI_IN_AIL) {\r\nxfs_trans_ail_delete(ailp, &iip->ili_item,\r\nstale ?\r\nSHUTDOWN_LOG_IO_ERROR :\r\nSHUTDOWN_CORRUPT_INCORE);\r\n} else\r\nspin_unlock(&ailp->xa_lock);\r\n}\r\niip->ili_logged = 0;\r\niip->ili_last_fields = 0;\r\niip->ili_fields = 0;\r\n}\r\nxfs_ifunlock(ip);\r\n}\r\nvoid\r\nxfs_istale_done(\r\nstruct xfs_buf *bp,\r\nstruct xfs_log_item *lip)\r\n{\r\nxfs_iflush_abort(INODE_ITEM(lip)->ili_inode, true);\r\n}\r\nint\r\nxfs_inode_item_format_convert(\r\nxfs_log_iovec_t *buf,\r\nxfs_inode_log_format_t *in_f)\r\n{\r\nif (buf->i_len == sizeof(xfs_inode_log_format_32_t)) {\r\nxfs_inode_log_format_32_t *in_f32 = buf->i_addr;\r\nin_f->ilf_type = in_f32->ilf_type;\r\nin_f->ilf_size = in_f32->ilf_size;\r\nin_f->ilf_fields = in_f32->ilf_fields;\r\nin_f->ilf_asize = in_f32->ilf_asize;\r\nin_f->ilf_dsize = in_f32->ilf_dsize;\r\nin_f->ilf_ino = in_f32->ilf_ino;\r\nmemcpy(in_f->ilf_u.ilfu_uuid.__u_bits,\r\nin_f32->ilf_u.ilfu_uuid.__u_bits,\r\nsizeof(uuid_t));\r\nin_f->ilf_blkno = in_f32->ilf_blkno;\r\nin_f->ilf_len = in_f32->ilf_len;\r\nin_f->ilf_boffset = in_f32->ilf_boffset;\r\nreturn 0;\r\n} else if (buf->i_len == sizeof(xfs_inode_log_format_64_t)){\r\nxfs_inode_log_format_64_t *in_f64 = buf->i_addr;\r\nin_f->ilf_type = in_f64->ilf_type;\r\nin_f->ilf_size = in_f64->ilf_size;\r\nin_f->ilf_fields = in_f64->ilf_fields;\r\nin_f->ilf_asize = in_f64->ilf_asize;\r\nin_f->ilf_dsize = in_f64->ilf_dsize;\r\nin_f->ilf_ino = in_f64->ilf_ino;\r\nmemcpy(in_f->ilf_u.ilfu_uuid.__u_bits,\r\nin_f64->ilf_u.ilfu_uuid.__u_bits,\r\nsizeof(uuid_t));\r\nin_f->ilf_blkno = in_f64->ilf_blkno;\r\nin_f->ilf_len = in_f64->ilf_len;\r\nin_f->ilf_boffset = in_f64->ilf_boffset;\r\nreturn 0;\r\n}\r\nreturn EFSCORRUPTED;\r\n}

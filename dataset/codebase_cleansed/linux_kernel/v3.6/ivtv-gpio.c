void ivtv_reset_ir_gpio(struct ivtv *itv)\r\n{\r\nint curdir, curout;\r\nif (itv->card->type != IVTV_CARD_PVR_150)\r\nreturn;\r\nIVTV_DEBUG_INFO("Resetting PVR150 IR\n");\r\ncurout = read_reg(IVTV_REG_GPIO_OUT);\r\ncurdir = read_reg(IVTV_REG_GPIO_DIR);\r\ncurdir |= 0x80;\r\nwrite_reg(curdir, IVTV_REG_GPIO_DIR);\r\ncurout = (curout & ~0xF) | 1;\r\nwrite_reg(curout, IVTV_REG_GPIO_OUT);\r\nschedule_timeout_interruptible(msecs_to_jiffies(1));\r\ncurout |= 2;\r\nwrite_reg(curout, IVTV_REG_GPIO_OUT);\r\ncurdir &= ~0x80;\r\nwrite_reg(curdir, IVTV_REG_GPIO_DIR);\r\n}\r\nint ivtv_reset_tuner_gpio(void *dev, int component, int cmd, int value)\r\n{\r\nstruct i2c_algo_bit_data *algo = dev;\r\nstruct ivtv *itv = algo->data;\r\nu32 curout;\r\nif (cmd != XC2028_TUNER_RESET)\r\nreturn 0;\r\nIVTV_DEBUG_INFO("Resetting tuner\n");\r\ncurout = read_reg(IVTV_REG_GPIO_OUT);\r\ncurout &= ~(1 << itv->card->xceive_pin);\r\nwrite_reg(curout, IVTV_REG_GPIO_OUT);\r\nschedule_timeout_interruptible(msecs_to_jiffies(1));\r\ncurout |= 1 << itv->card->xceive_pin;\r\nwrite_reg(curout, IVTV_REG_GPIO_OUT);\r\nschedule_timeout_interruptible(msecs_to_jiffies(1));\r\nreturn 0;\r\n}\r\nstatic inline struct ivtv *sd_to_ivtv(struct v4l2_subdev *sd)\r\n{\r\nreturn container_of(sd, struct ivtv, sd_gpio);\r\n}\r\nstatic inline struct v4l2_subdev *to_sd(struct v4l2_ctrl *ctrl)\r\n{\r\nreturn &container_of(ctrl->handler, struct ivtv, hdl_gpio)->sd_gpio;\r\n}\r\nstatic int subdev_s_clock_freq(struct v4l2_subdev *sd, u32 freq)\r\n{\r\nstruct ivtv *itv = sd_to_ivtv(sd);\r\nu16 mask, data;\r\nmask = itv->card->gpio_audio_freq.mask;\r\nswitch (freq) {\r\ncase 32000:\r\ndata = itv->card->gpio_audio_freq.f32000;\r\nbreak;\r\ncase 44100:\r\ndata = itv->card->gpio_audio_freq.f44100;\r\nbreak;\r\ncase 48000:\r\ndefault:\r\ndata = itv->card->gpio_audio_freq.f48000;\r\nbreak;\r\n}\r\nif (mask)\r\nwrite_reg((read_reg(IVTV_REG_GPIO_OUT) & ~mask) | (data & mask), IVTV_REG_GPIO_OUT);\r\nreturn 0;\r\n}\r\nstatic int subdev_g_tuner(struct v4l2_subdev *sd, struct v4l2_tuner *vt)\r\n{\r\nstruct ivtv *itv = sd_to_ivtv(sd);\r\nu16 mask;\r\nmask = itv->card->gpio_audio_detect.mask;\r\nif (mask == 0 || (read_reg(IVTV_REG_GPIO_IN) & mask))\r\nvt->rxsubchans = V4L2_TUNER_SUB_STEREO |\r\nV4L2_TUNER_SUB_LANG1 | V4L2_TUNER_SUB_LANG2;\r\nelse\r\nvt->rxsubchans = V4L2_TUNER_SUB_MONO;\r\nreturn 0;\r\n}\r\nstatic int subdev_s_tuner(struct v4l2_subdev *sd, struct v4l2_tuner *vt)\r\n{\r\nstruct ivtv *itv = sd_to_ivtv(sd);\r\nu16 mask, data;\r\nmask = itv->card->gpio_audio_mode.mask;\r\nswitch (vt->audmode) {\r\ncase V4L2_TUNER_MODE_LANG1:\r\ndata = itv->card->gpio_audio_mode.lang1;\r\nbreak;\r\ncase V4L2_TUNER_MODE_LANG2:\r\ndata = itv->card->gpio_audio_mode.lang2;\r\nbreak;\r\ncase V4L2_TUNER_MODE_MONO:\r\ndata = itv->card->gpio_audio_mode.mono;\r\nbreak;\r\ncase V4L2_TUNER_MODE_STEREO:\r\ncase V4L2_TUNER_MODE_LANG1_LANG2:\r\ndefault:\r\ndata = itv->card->gpio_audio_mode.stereo;\r\nbreak;\r\n}\r\nif (mask)\r\nwrite_reg((read_reg(IVTV_REG_GPIO_OUT) & ~mask) | (data & mask), IVTV_REG_GPIO_OUT);\r\nreturn 0;\r\n}\r\nstatic int subdev_s_radio(struct v4l2_subdev *sd)\r\n{\r\nstruct ivtv *itv = sd_to_ivtv(sd);\r\nu16 mask, data;\r\nmask = itv->card->gpio_audio_input.mask;\r\ndata = itv->card->gpio_audio_input.radio;\r\nif (mask)\r\nwrite_reg((read_reg(IVTV_REG_GPIO_OUT) & ~mask) | (data & mask), IVTV_REG_GPIO_OUT);\r\nreturn 0;\r\n}\r\nstatic int subdev_s_audio_routing(struct v4l2_subdev *sd,\r\nu32 input, u32 output, u32 config)\r\n{\r\nstruct ivtv *itv = sd_to_ivtv(sd);\r\nu16 mask, data;\r\nif (input > 2)\r\nreturn -EINVAL;\r\nmask = itv->card->gpio_audio_input.mask;\r\nswitch (input) {\r\ncase 0:\r\ndata = itv->card->gpio_audio_input.tuner;\r\nbreak;\r\ncase 1:\r\ndata = itv->card->gpio_audio_input.linein;\r\nbreak;\r\ncase 2:\r\ndefault:\r\ndata = itv->card->gpio_audio_input.radio;\r\nbreak;\r\n}\r\nif (mask)\r\nwrite_reg((read_reg(IVTV_REG_GPIO_OUT) & ~mask) | (data & mask), IVTV_REG_GPIO_OUT);\r\nreturn 0;\r\n}\r\nstatic int subdev_s_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstruct v4l2_subdev *sd = to_sd(ctrl);\r\nstruct ivtv *itv = sd_to_ivtv(sd);\r\nu16 mask, data;\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_AUDIO_MUTE:\r\nmask = itv->card->gpio_audio_mute.mask;\r\ndata = ctrl->val ? itv->card->gpio_audio_mute.mute : 0;\r\nif (mask)\r\nwrite_reg((read_reg(IVTV_REG_GPIO_OUT) & ~mask) |\r\n(data & mask), IVTV_REG_GPIO_OUT);\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int subdev_log_status(struct v4l2_subdev *sd)\r\n{\r\nstruct ivtv *itv = sd_to_ivtv(sd);\r\nIVTV_INFO("GPIO status: DIR=0x%04x OUT=0x%04x IN=0x%04x\n",\r\nread_reg(IVTV_REG_GPIO_DIR), read_reg(IVTV_REG_GPIO_OUT),\r\nread_reg(IVTV_REG_GPIO_IN));\r\nv4l2_ctrl_handler_log_status(&itv->hdl_gpio, sd->name);\r\nreturn 0;\r\n}\r\nstatic int subdev_s_video_routing(struct v4l2_subdev *sd,\r\nu32 input, u32 output, u32 config)\r\n{\r\nstruct ivtv *itv = sd_to_ivtv(sd);\r\nu16 mask, data;\r\nif (input > 2)\r\nreturn -EINVAL;\r\nmask = itv->card->gpio_video_input.mask;\r\nif (input == 0)\r\ndata = itv->card->gpio_video_input.tuner;\r\nelse if (input == 1)\r\ndata = itv->card->gpio_video_input.composite;\r\nelse\r\ndata = itv->card->gpio_video_input.svideo;\r\nif (mask)\r\nwrite_reg((read_reg(IVTV_REG_GPIO_OUT) & ~mask) | (data & mask), IVTV_REG_GPIO_OUT);\r\nreturn 0;\r\n}\r\nint ivtv_gpio_init(struct ivtv *itv)\r\n{\r\nu16 pin = 0;\r\nif (itv->card->xceive_pin)\r\npin = 1 << itv->card->xceive_pin;\r\nif ((itv->card->gpio_init.direction | pin) == 0)\r\nreturn 0;\r\nIVTV_DEBUG_INFO("GPIO initial dir: %08x out: %08x\n",\r\nread_reg(IVTV_REG_GPIO_DIR), read_reg(IVTV_REG_GPIO_OUT));\r\nwrite_reg(itv->card->gpio_init.initial_value | pin, IVTV_REG_GPIO_OUT);\r\nwrite_reg(itv->card->gpio_init.direction | pin, IVTV_REG_GPIO_DIR);\r\nv4l2_subdev_init(&itv->sd_gpio, &subdev_ops);\r\nsnprintf(itv->sd_gpio.name, sizeof(itv->sd_gpio.name), "%s-gpio", itv->v4l2_dev.name);\r\nitv->sd_gpio.grp_id = IVTV_HW_GPIO;\r\nv4l2_ctrl_handler_init(&itv->hdl_gpio, 1);\r\nv4l2_ctrl_new_std(&itv->hdl_gpio, &gpio_ctrl_ops,\r\nV4L2_CID_AUDIO_MUTE, 0, 1, 1, 0);\r\nif (itv->hdl_gpio.error)\r\nreturn itv->hdl_gpio.error;\r\nitv->sd_gpio.ctrl_handler = &itv->hdl_gpio;\r\nv4l2_ctrl_handler_setup(&itv->hdl_gpio);\r\nreturn v4l2_device_register_subdev(&itv->v4l2_dev, &itv->sd_gpio);\r\n}

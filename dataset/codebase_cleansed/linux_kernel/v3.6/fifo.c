static int wait_for_partner(struct inode* inode, unsigned int *cnt)\r\n{\r\nint cur = *cnt;\r\nwhile (cur == *cnt) {\r\npipe_wait(inode->i_pipe);\r\nif (signal_pending(current))\r\nbreak;\r\n}\r\nreturn cur == *cnt ? -ERESTARTSYS : 0;\r\n}\r\nstatic void wake_up_partner(struct inode* inode)\r\n{\r\nwake_up_interruptible(&inode->i_pipe->wait);\r\n}\r\nstatic int fifo_open(struct inode *inode, struct file *filp)\r\n{\r\nstruct pipe_inode_info *pipe;\r\nint ret;\r\nmutex_lock(&inode->i_mutex);\r\npipe = inode->i_pipe;\r\nif (!pipe) {\r\nret = -ENOMEM;\r\npipe = alloc_pipe_info(inode);\r\nif (!pipe)\r\ngoto err_nocleanup;\r\ninode->i_pipe = pipe;\r\n}\r\nfilp->f_version = 0;\r\nfilp->f_mode &= (FMODE_READ | FMODE_WRITE);\r\nswitch (filp->f_mode) {\r\ncase FMODE_READ:\r\nfilp->f_op = &read_pipefifo_fops;\r\npipe->r_counter++;\r\nif (pipe->readers++ == 0)\r\nwake_up_partner(inode);\r\nif (!pipe->writers) {\r\nif ((filp->f_flags & O_NONBLOCK)) {\r\nfilp->f_version = pipe->w_counter;\r\n} else {\r\nif (wait_for_partner(inode, &pipe->w_counter))\r\ngoto err_rd;\r\n}\r\n}\r\nbreak;\r\ncase FMODE_WRITE:\r\nret = -ENXIO;\r\nif ((filp->f_flags & O_NONBLOCK) && !pipe->readers)\r\ngoto err;\r\nfilp->f_op = &write_pipefifo_fops;\r\npipe->w_counter++;\r\nif (!pipe->writers++)\r\nwake_up_partner(inode);\r\nif (!pipe->readers) {\r\nif (wait_for_partner(inode, &pipe->r_counter))\r\ngoto err_wr;\r\n}\r\nbreak;\r\ncase FMODE_READ | FMODE_WRITE:\r\nfilp->f_op = &rdwr_pipefifo_fops;\r\npipe->readers++;\r\npipe->writers++;\r\npipe->r_counter++;\r\npipe->w_counter++;\r\nif (pipe->readers == 1 || pipe->writers == 1)\r\nwake_up_partner(inode);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\ngoto err;\r\n}\r\nmutex_unlock(&inode->i_mutex);\r\nreturn 0;\r\nerr_rd:\r\nif (!--pipe->readers)\r\nwake_up_interruptible(&pipe->wait);\r\nret = -ERESTARTSYS;\r\ngoto err;\r\nerr_wr:\r\nif (!--pipe->writers)\r\nwake_up_interruptible(&pipe->wait);\r\nret = -ERESTARTSYS;\r\ngoto err;\r\nerr:\r\nif (!pipe->readers && !pipe->writers)\r\nfree_pipe_info(inode);\r\nerr_nocleanup:\r\nmutex_unlock(&inode->i_mutex);\r\nreturn ret;\r\n}

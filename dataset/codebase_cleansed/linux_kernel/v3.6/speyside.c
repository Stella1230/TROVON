static int speyside_set_bias_level(struct snd_soc_card *card,\r\nstruct snd_soc_dapm_context *dapm,\r\nenum snd_soc_bias_level level)\r\n{\r\nstruct snd_soc_dai *codec_dai = card->rtd[0].codec_dai;\r\nint ret;\r\nif (dapm->dev != codec_dai->dev)\r\nreturn 0;\r\nswitch (level) {\r\ncase SND_SOC_BIAS_STANDBY:\r\nret = snd_soc_dai_set_sysclk(codec_dai, WM8996_SYSCLK_MCLK2,\r\n32768, SND_SOC_CLOCK_IN);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_pll(codec_dai, WM8996_FLL_MCLK2,\r\n0, 0, 0);\r\nif (ret < 0) {\r\npr_err("Failed to stop FLL\n");\r\nreturn ret;\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int speyside_set_bias_level_post(struct snd_soc_card *card,\r\nstruct snd_soc_dapm_context *dapm,\r\nenum snd_soc_bias_level level)\r\n{\r\nstruct snd_soc_dai *codec_dai = card->rtd[0].codec_dai;\r\nint ret;\r\nif (dapm->dev != codec_dai->dev)\r\nreturn 0;\r\nswitch (level) {\r\ncase SND_SOC_BIAS_PREPARE:\r\nif (card->dapm.bias_level == SND_SOC_BIAS_STANDBY) {\r\nret = snd_soc_dai_set_pll(codec_dai, 0,\r\nWM8996_FLL_MCLK2,\r\n32768, MCLK_AUDIO_RATE);\r\nif (ret < 0) {\r\npr_err("Failed to start FLL\n");\r\nreturn ret;\r\n}\r\nret = snd_soc_dai_set_sysclk(codec_dai,\r\nWM8996_SYSCLK_FLL,\r\nMCLK_AUDIO_RATE,\r\nSND_SOC_CLOCK_IN);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\ncard->dapm.bias_level = level;\r\nreturn 0;\r\n}\r\nstatic int speyside_get_micbias(struct snd_soc_dapm_widget *source,\r\nstruct snd_soc_dapm_widget *sink)\r\n{\r\nif (speyside_jack_polarity && (strcmp(source->name, "MICB1") == 0))\r\nreturn 1;\r\nif (!speyside_jack_polarity && (strcmp(source->name, "MICB2") == 0))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic void speyside_set_polarity(struct snd_soc_codec *codec,\r\nint polarity)\r\n{\r\nspeyside_jack_polarity = !polarity;\r\ngpio_direction_output(WM8996_HPSEL_GPIO, speyside_jack_polarity);\r\nsnd_soc_dapm_sync(&codec->dapm);\r\n}\r\nstatic int speyside_wm8996_init(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct snd_soc_dai *dai = rtd->codec_dai;\r\nstruct snd_soc_codec *codec = rtd->codec;\r\nint ret;\r\nret = snd_soc_dai_set_sysclk(dai, WM8996_SYSCLK_MCLK2, 32768, 0);\r\nif (ret < 0)\r\nreturn ret;\r\nret = gpio_request(WM8996_HPSEL_GPIO, "HP_SEL");\r\nif (ret != 0)\r\npr_err("Failed to request HP_SEL GPIO: %d\n", ret);\r\ngpio_direction_output(WM8996_HPSEL_GPIO, speyside_jack_polarity);\r\nret = snd_soc_jack_new(codec, "Headset",\r\nSND_JACK_LINEOUT | SND_JACK_HEADSET |\r\nSND_JACK_BTN_0,\r\n&speyside_headset);\r\nif (ret)\r\nreturn ret;\r\nret = snd_soc_jack_add_pins(&speyside_headset,\r\nARRAY_SIZE(speyside_headset_pins),\r\nspeyside_headset_pins);\r\nif (ret)\r\nreturn ret;\r\nwm8996_detect(codec, &speyside_headset, speyside_set_polarity);\r\nreturn 0;\r\n}\r\nstatic int speyside_late_probe(struct snd_soc_card *card)\r\n{\r\nsnd_soc_dapm_ignore_suspend(&card->dapm, "Headphone");\r\nsnd_soc_dapm_ignore_suspend(&card->dapm, "Headset Mic");\r\nsnd_soc_dapm_ignore_suspend(&card->dapm, "Main AMIC");\r\nsnd_soc_dapm_ignore_suspend(&card->dapm, "Main DMIC");\r\nsnd_soc_dapm_ignore_suspend(&card->dapm, "Main Speaker");\r\nsnd_soc_dapm_ignore_suspend(&card->dapm, "WM1250 Output");\r\nsnd_soc_dapm_ignore_suspend(&card->dapm, "WM1250 Input");\r\nreturn 0;\r\n}\r\nstatic int speyside_wm9081_init(struct snd_soc_dapm_context *dapm)\r\n{\r\nreturn snd_soc_codec_set_sysclk(dapm->codec, WM9081_SYSCLK_MCLK, 0,\r\nMCLK_AUDIO_RATE, 0);\r\n}\r\nstatic __devinit int speyside_probe(struct platform_device *pdev)\r\n{\r\nstruct snd_soc_card *card = &speyside;\r\nint ret;\r\ncard->dev = &pdev->dev;\r\nret = snd_soc_register_card(card);\r\nif (ret) {\r\ndev_err(&pdev->dev, "snd_soc_register_card() failed: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devexit speyside_remove(struct platform_device *pdev)\r\n{\r\nstruct snd_soc_card *card = platform_get_drvdata(pdev);\r\nsnd_soc_unregister_card(card);\r\nreturn 0;\r\n}

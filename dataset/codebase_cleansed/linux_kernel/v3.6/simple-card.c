static int asoc_simple_card_dai_init(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct asoc_simple_card_info *cinfo = asoc_simple_get_card_info(rtd);\r\nstruct asoc_simple_dai_init_info *iinfo = cinfo->init;\r\nstruct snd_soc_dai *codec = rtd->codec_dai;\r\nstruct snd_soc_dai *cpu = rtd->cpu_dai;\r\nunsigned int cpu_daifmt = iinfo->fmt | iinfo->cpu_daifmt;\r\nunsigned int codec_daifmt = iinfo->fmt | iinfo->codec_daifmt;\r\nint ret;\r\nif (codec_daifmt) {\r\nret = snd_soc_dai_set_fmt(codec, codec_daifmt);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nif (iinfo->sysclk) {\r\nret = snd_soc_dai_set_sysclk(codec, 0, iinfo->sysclk, 0);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nif (cpu_daifmt) {\r\nret = snd_soc_dai_set_fmt(cpu, cpu_daifmt);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int asoc_simple_card_probe(struct platform_device *pdev)\r\n{\r\nstruct asoc_simple_card_info *cinfo = pdev->dev.platform_data;\r\nif (!cinfo) {\r\ndev_err(&pdev->dev, "no info for asoc-simple-card\n");\r\nreturn -EINVAL;\r\n}\r\nif (!cinfo->name ||\r\n!cinfo->card ||\r\n!cinfo->cpu_dai ||\r\n!cinfo->codec ||\r\n!cinfo->platform ||\r\n!cinfo->codec_dai) {\r\ndev_err(&pdev->dev, "insufficient asoc_simple_card_info settings\n");\r\nreturn -EINVAL;\r\n}\r\ncinfo->snd_link.name = cinfo->name;\r\ncinfo->snd_link.stream_name = cinfo->name;\r\ncinfo->snd_link.cpu_dai_name = cinfo->cpu_dai;\r\ncinfo->snd_link.platform_name = cinfo->platform;\r\ncinfo->snd_link.codec_name = cinfo->codec;\r\ncinfo->snd_link.codec_dai_name = cinfo->codec_dai;\r\nif (cinfo->init)\r\ncinfo->snd_link.init = asoc_simple_card_dai_init;\r\ncinfo->snd_card.name = cinfo->card;\r\ncinfo->snd_card.owner = THIS_MODULE;\r\ncinfo->snd_card.dai_link = &cinfo->snd_link;\r\ncinfo->snd_card.num_links = 1;\r\ncinfo->snd_card.dev = &pdev->dev;\r\nreturn snd_soc_register_card(&cinfo->snd_card);\r\n}\r\nstatic int asoc_simple_card_remove(struct platform_device *pdev)\r\n{\r\nstruct asoc_simple_card_info *cinfo = pdev->dev.platform_data;\r\nreturn snd_soc_unregister_card(&cinfo->snd_card);\r\n}

void rtl92cu_dm_dynamic_txpower(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_phy *rtlphy = &(rtlpriv->phy);\r\nstruct rtl_mac *mac = rtl_mac(rtl_priv(hw));\r\nlong undecorated_smoothed_pwdb;\r\nif (!rtlpriv->dm.dynamic_txpower_enable)\r\nreturn;\r\nif (rtlpriv->dm.dm_flag & HAL_DM_HIPWR_DISABLE) {\r\nrtlpriv->dm.dynamic_txhighpower_lvl = TXHIGHPWRLEVEL_NORMAL;\r\nreturn;\r\n}\r\nif ((mac->link_state < MAC80211_LINKED) &&\r\n(rtlpriv->dm.entry_min_undecoratedsmoothed_pwdb == 0)) {\r\nRT_TRACE(rtlpriv, COMP_POWER, DBG_TRACE,\r\n"Not connected to any\n");\r\nrtlpriv->dm.dynamic_txhighpower_lvl = TXHIGHPWRLEVEL_NORMAL;\r\nrtlpriv->dm.last_dtp_lvl = TXHIGHPWRLEVEL_NORMAL;\r\nreturn;\r\n}\r\nif (mac->link_state >= MAC80211_LINKED) {\r\nif (mac->opmode == NL80211_IFTYPE_ADHOC) {\r\nundecorated_smoothed_pwdb =\r\nrtlpriv->dm.entry_min_undecoratedsmoothed_pwdb;\r\nRT_TRACE(rtlpriv, COMP_POWER, DBG_LOUD,\r\n"AP Client PWDB = 0x%lx\n",\r\nundecorated_smoothed_pwdb);\r\n} else {\r\nundecorated_smoothed_pwdb =\r\nrtlpriv->dm.undecorated_smoothed_pwdb;\r\nRT_TRACE(rtlpriv, COMP_POWER, DBG_LOUD,\r\n"STA Default Port PWDB = 0x%lx\n",\r\nundecorated_smoothed_pwdb);\r\n}\r\n} else {\r\nundecorated_smoothed_pwdb =\r\nrtlpriv->dm.entry_min_undecoratedsmoothed_pwdb;\r\nRT_TRACE(rtlpriv, COMP_POWER, DBG_LOUD,\r\n"AP Ext Port PWDB = 0x%lx\n",\r\nundecorated_smoothed_pwdb);\r\n}\r\nif (undecorated_smoothed_pwdb >= TX_POWER_NEAR_FIELD_THRESH_LVL2) {\r\nrtlpriv->dm.dynamic_txhighpower_lvl = TXHIGHPWRLEVEL_LEVEL1;\r\nRT_TRACE(rtlpriv, COMP_POWER, DBG_LOUD,\r\n"TXHIGHPWRLEVEL_LEVEL1 (TxPwr=0x0)\n");\r\n} else if ((undecorated_smoothed_pwdb <\r\n(TX_POWER_NEAR_FIELD_THRESH_LVL2 - 3)) &&\r\n(undecorated_smoothed_pwdb >=\r\nTX_POWER_NEAR_FIELD_THRESH_LVL1)) {\r\nrtlpriv->dm.dynamic_txhighpower_lvl = TXHIGHPWRLEVEL_LEVEL1;\r\nRT_TRACE(rtlpriv, COMP_POWER, DBG_LOUD,\r\n"TXHIGHPWRLEVEL_LEVEL1 (TxPwr=0x10)\n");\r\n} else if (undecorated_smoothed_pwdb <\r\n(TX_POWER_NEAR_FIELD_THRESH_LVL1 - 5)) {\r\nrtlpriv->dm.dynamic_txhighpower_lvl = TXHIGHPWRLEVEL_NORMAL;\r\nRT_TRACE(rtlpriv, COMP_POWER, DBG_LOUD,\r\n"TXHIGHPWRLEVEL_NORMAL\n");\r\n}\r\nif ((rtlpriv->dm.dynamic_txhighpower_lvl != rtlpriv->dm.last_dtp_lvl)) {\r\nRT_TRACE(rtlpriv, COMP_POWER, DBG_LOUD,\r\n"PHY_SetTxPowerLevel8192S() Channel = %d\n",\r\nrtlphy->current_channel);\r\nrtl92c_phy_set_txpower_level(hw, rtlphy->current_channel);\r\n}\r\nrtlpriv->dm.last_dtp_lvl = rtlpriv->dm.dynamic_txhighpower_lvl;\r\n}

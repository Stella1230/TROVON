static void pre_exec(void *d)\r\n{\r\nstruct dog_data *data = d;\r\ndup2(data->stdin, 0);\r\ndup2(data->stdout, 1);\r\ndup2(data->stdout, 2);\r\nclose(data->stdin);\r\nclose(data->stdout);\r\nclose(data->close_me[0]);\r\nclose(data->close_me[1]);\r\n}\r\nint start_watchdog(int *in_fd_ret, int *out_fd_ret, char *sock)\r\n{\r\nstruct dog_data data;\r\nint in_fds[2], out_fds[2], pid, n, err;\r\nchar pid_buf[sizeof("nnnnnnn\0")], c;\r\nchar *pid_args[] = { "/usr/bin/uml_watchdog", "-pid", pid_buf, NULL };\r\nchar *mconsole_args[] = { "/usr/bin/uml_watchdog", "-mconsole", NULL,\r\nNULL };\r\nchar **args = NULL;\r\nerr = os_pipe(in_fds, 1, 0);\r\nif (err < 0) {\r\nprintk("harddog_open - os_pipe failed, err = %d\n", -err);\r\ngoto out;\r\n}\r\nerr = os_pipe(out_fds, 1, 0);\r\nif (err < 0) {\r\nprintk("harddog_open - os_pipe failed, err = %d\n", -err);\r\ngoto out_close_in;\r\n}\r\ndata.stdin = out_fds[0];\r\ndata.stdout = in_fds[1];\r\ndata.close_me[0] = out_fds[1];\r\ndata.close_me[1] = in_fds[0];\r\nif (sock != NULL) {\r\nmconsole_args[2] = sock;\r\nargs = mconsole_args;\r\n}\r\nelse {\r\nsprintf(pid_buf, "%d", os_getpid());\r\nargs = pid_args;\r\n}\r\npid = run_helper(pre_exec, &data, args);\r\nclose(out_fds[0]);\r\nclose(in_fds[1]);\r\nif (pid < 0) {\r\nerr = -pid;\r\nprintk("harddog_open - run_helper failed, errno = %d\n", -err);\r\ngoto out_close_out;\r\n}\r\nn = read(in_fds[0], &c, sizeof(c));\r\nif (n == 0) {\r\nprintk("harddog_open - EOF on watchdog pipe\n");\r\nhelper_wait(pid);\r\nerr = -EIO;\r\ngoto out_close_out;\r\n}\r\nelse if (n < 0) {\r\nprintk("harddog_open - read of watchdog pipe failed, "\r\n"err = %d\n", errno);\r\nhelper_wait(pid);\r\nerr = n;\r\ngoto out_close_out;\r\n}\r\n*in_fd_ret = in_fds[0];\r\n*out_fd_ret = out_fds[1];\r\nreturn 0;\r\nout_close_in:\r\nclose(in_fds[0]);\r\nclose(in_fds[1]);\r\nout_close_out:\r\nclose(out_fds[0]);\r\nclose(out_fds[1]);\r\nout:\r\nreturn err;\r\n}\r\nvoid stop_watchdog(int in_fd, int out_fd)\r\n{\r\nclose(in_fd);\r\nclose(out_fd);\r\n}\r\nint ping_watchdog(int fd)\r\n{\r\nint n;\r\nchar c = '\n';\r\nn = write(fd, &c, sizeof(c));\r\nif (n != sizeof(c)) {\r\nprintk("ping_watchdog - write failed, ret = %d, err = %d\n",\r\nn, errno);\r\nif (n < 0)\r\nreturn n;\r\nreturn -EIO;\r\n}\r\nreturn 1;\r\n}

s32 ixgbe_dcb_config_rx_arbiter_82598(struct ixgbe_hw *hw,\r\nu16 *refill,\r\nu16 *max,\r\nu8 *prio_type)\r\n{\r\nu32 reg = 0;\r\nu32 credit_refill = 0;\r\nu32 credit_max = 0;\r\nu8 i = 0;\r\nreg = IXGBE_READ_REG(hw, IXGBE_RUPPBMR) | IXGBE_RUPPBMR_MQA;\r\nIXGBE_WRITE_REG(hw, IXGBE_RUPPBMR, reg);\r\nreg = IXGBE_READ_REG(hw, IXGBE_RMCS);\r\nreg &= ~IXGBE_RMCS_ARBDIS;\r\nreg |= IXGBE_RMCS_RRM;\r\nreg |= IXGBE_RMCS_DFP;\r\nIXGBE_WRITE_REG(hw, IXGBE_RMCS, reg);\r\nfor (i = 0; i < MAX_TRAFFIC_CLASS; i++) {\r\ncredit_refill = refill[i];\r\ncredit_max = max[i];\r\nreg = credit_refill | (credit_max << IXGBE_RT2CR_MCL_SHIFT);\r\nif (prio_type[i] == prio_link)\r\nreg |= IXGBE_RT2CR_LSP;\r\nIXGBE_WRITE_REG(hw, IXGBE_RT2CR(i), reg);\r\n}\r\nreg = IXGBE_READ_REG(hw, IXGBE_RDRXCTL);\r\nreg |= IXGBE_RDRXCTL_RDMTS_1_2;\r\nreg |= IXGBE_RDRXCTL_MPBEN;\r\nreg |= IXGBE_RDRXCTL_MCEN;\r\nIXGBE_WRITE_REG(hw, IXGBE_RDRXCTL, reg);\r\nreg = IXGBE_READ_REG(hw, IXGBE_RXCTRL);\r\nreg &= ~IXGBE_RXCTRL_DMBYPS;\r\nIXGBE_WRITE_REG(hw, IXGBE_RXCTRL, reg);\r\nreturn 0;\r\n}\r\ns32 ixgbe_dcb_config_tx_desc_arbiter_82598(struct ixgbe_hw *hw,\r\nu16 *refill,\r\nu16 *max,\r\nu8 *bwg_id,\r\nu8 *prio_type)\r\n{\r\nu32 reg, max_credits;\r\nu8 i;\r\nreg = IXGBE_READ_REG(hw, IXGBE_DPMCS);\r\nreg &= ~IXGBE_DPMCS_ARBDIS;\r\nreg |= (IXGBE_DPMCS_TDPAC | IXGBE_DPMCS_TRM);\r\nreg |= IXGBE_DPMCS_TSOEF;\r\nreg |= (0x4 << IXGBE_DPMCS_MTSOS_SHIFT);\r\nIXGBE_WRITE_REG(hw, IXGBE_DPMCS, reg);\r\nfor (i = 0; i < MAX_TRAFFIC_CLASS; i++) {\r\nmax_credits = max[i];\r\nreg = max_credits << IXGBE_TDTQ2TCCR_MCL_SHIFT;\r\nreg |= refill[i];\r\nreg |= (u32)(bwg_id[i]) << IXGBE_TDTQ2TCCR_BWG_SHIFT;\r\nif (prio_type[i] == prio_group)\r\nreg |= IXGBE_TDTQ2TCCR_GSP;\r\nif (prio_type[i] == prio_link)\r\nreg |= IXGBE_TDTQ2TCCR_LSP;\r\nIXGBE_WRITE_REG(hw, IXGBE_TDTQ2TCCR(i), reg);\r\n}\r\nreturn 0;\r\n}\r\ns32 ixgbe_dcb_config_tx_data_arbiter_82598(struct ixgbe_hw *hw,\r\nu16 *refill,\r\nu16 *max,\r\nu8 *bwg_id,\r\nu8 *prio_type)\r\n{\r\nu32 reg;\r\nu8 i;\r\nreg = IXGBE_READ_REG(hw, IXGBE_PDPMCS);\r\nreg &= ~IXGBE_PDPMCS_ARBDIS;\r\nreg |= (IXGBE_PDPMCS_TPPAC | IXGBE_PDPMCS_TRM);\r\nIXGBE_WRITE_REG(hw, IXGBE_PDPMCS, reg);\r\nfor (i = 0; i < MAX_TRAFFIC_CLASS; i++) {\r\nreg = refill[i];\r\nreg |= (u32)(max[i]) << IXGBE_TDPT2TCCR_MCL_SHIFT;\r\nreg |= (u32)(bwg_id[i]) << IXGBE_TDPT2TCCR_BWG_SHIFT;\r\nif (prio_type[i] == prio_group)\r\nreg |= IXGBE_TDPT2TCCR_GSP;\r\nif (prio_type[i] == prio_link)\r\nreg |= IXGBE_TDPT2TCCR_LSP;\r\nIXGBE_WRITE_REG(hw, IXGBE_TDPT2TCCR(i), reg);\r\n}\r\nreg = IXGBE_READ_REG(hw, IXGBE_DTXCTL);\r\nreg |= IXGBE_DTXCTL_ENDBUBD;\r\nIXGBE_WRITE_REG(hw, IXGBE_DTXCTL, reg);\r\nreturn 0;\r\n}\r\ns32 ixgbe_dcb_config_pfc_82598(struct ixgbe_hw *hw, u8 pfc_en)\r\n{\r\nu32 fcrtl, reg;\r\nu8 i;\r\nreg = IXGBE_READ_REG(hw, IXGBE_RMCS);\r\nreg &= ~IXGBE_RMCS_TFCE_802_3X;\r\nreg |= IXGBE_RMCS_TFCE_PRIORITY;\r\nIXGBE_WRITE_REG(hw, IXGBE_RMCS, reg);\r\nreg = IXGBE_READ_REG(hw, IXGBE_FCTRL);\r\nreg &= ~(IXGBE_FCTRL_RPFCE | IXGBE_FCTRL_RFCE);\r\nif (pfc_en)\r\nreg |= IXGBE_FCTRL_RPFCE;\r\nIXGBE_WRITE_REG(hw, IXGBE_FCTRL, reg);\r\nfcrtl = (hw->fc.low_water << 10) | IXGBE_FCRTL_XONE;\r\nfor (i = 0; i < MAX_TRAFFIC_CLASS; i++) {\r\nif (!(pfc_en & (1 << i))) {\r\nIXGBE_WRITE_REG(hw, IXGBE_FCRTL(i), 0);\r\nIXGBE_WRITE_REG(hw, IXGBE_FCRTH(i), 0);\r\ncontinue;\r\n}\r\nreg = (hw->fc.high_water[i] << 10) | IXGBE_FCRTH_FCEN;\r\nIXGBE_WRITE_REG(hw, IXGBE_FCRTL(i), fcrtl);\r\nIXGBE_WRITE_REG(hw, IXGBE_FCRTH(i), reg);\r\n}\r\nreg = hw->fc.pause_time * 0x00010001;\r\nfor (i = 0; i < (MAX_TRAFFIC_CLASS / 2); i++)\r\nIXGBE_WRITE_REG(hw, IXGBE_FCTTV(i), reg);\r\nIXGBE_WRITE_REG(hw, IXGBE_FCRTV, hw->fc.pause_time / 2);\r\nreturn 0;\r\n}\r\nstatic s32 ixgbe_dcb_config_tc_stats_82598(struct ixgbe_hw *hw)\r\n{\r\nu32 reg = 0;\r\nu8 i = 0;\r\nu8 j = 0;\r\nfor (i = 0, j = 0; i < 15 && j < 8; i = i + 2, j++) {\r\nreg = IXGBE_READ_REG(hw, IXGBE_RQSMR(i));\r\nreg |= ((0x1010101) * j);\r\nIXGBE_WRITE_REG(hw, IXGBE_RQSMR(i), reg);\r\nreg = IXGBE_READ_REG(hw, IXGBE_RQSMR(i + 1));\r\nreg |= ((0x1010101) * j);\r\nIXGBE_WRITE_REG(hw, IXGBE_RQSMR(i + 1), reg);\r\n}\r\nfor (i = 0; i < 8; i++) {\r\nreg = IXGBE_READ_REG(hw, IXGBE_TQSMR(i));\r\nreg |= ((0x1010101) * i);\r\nIXGBE_WRITE_REG(hw, IXGBE_TQSMR(i), reg);\r\n}\r\nreturn 0;\r\n}\r\ns32 ixgbe_dcb_hw_config_82598(struct ixgbe_hw *hw, u8 pfc_en, u16 *refill,\r\nu16 *max, u8 *bwg_id, u8 *prio_type)\r\n{\r\nixgbe_dcb_config_rx_arbiter_82598(hw, refill, max, prio_type);\r\nixgbe_dcb_config_tx_desc_arbiter_82598(hw, refill, max,\r\nbwg_id, prio_type);\r\nixgbe_dcb_config_tx_data_arbiter_82598(hw, refill, max,\r\nbwg_id, prio_type);\r\nixgbe_dcb_config_pfc_82598(hw, pfc_en);\r\nixgbe_dcb_config_tc_stats_82598(hw);\r\nreturn 0;\r\n}

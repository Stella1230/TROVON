static int\r\nprism54_probe(struct pci_dev *pdev, const struct pci_device_id *id)\r\n{\r\nstruct net_device *ndev;\r\nu8 latency_tmr;\r\nu32 mem_addr;\r\nislpci_private *priv;\r\nint rvalue;\r\nif (pci_enable_device(pdev)) {\r\nprintk(KERN_ERR "%s: pci_enable_device() failed.\n", DRV_NAME);\r\nreturn -ENODEV;\r\n}\r\npci_read_config_byte(pdev, PCI_LATENCY_TIMER, &latency_tmr);\r\n#if VERBOSE > SHOW_ERROR_MESSAGES\r\nDEBUG(SHOW_TRACING, "latency timer: %x\n", latency_tmr);\r\n#endif\r\nif (latency_tmr < PCIDEVICE_LATENCY_TIMER_MIN) {\r\npci_write_config_byte(pdev, PCI_LATENCY_TIMER,\r\nPCIDEVICE_LATENCY_TIMER_VAL);\r\n}\r\nif (pci_set_dma_mask(pdev, DMA_BIT_MASK(32))) {\r\nprintk(KERN_ERR "%s: 32-bit PCI DMA not supported", DRV_NAME);\r\ngoto do_pci_disable_device;\r\n}\r\nif ( init_pcitm >= 0 ) {\r\npci_write_config_byte(pdev, 0x40, (u8)init_pcitm);\r\npci_write_config_byte(pdev, 0x41, (u8)init_pcitm);\r\n} else {\r\nprintk(KERN_INFO "PCI TRDY/RETRY unchanged\n");\r\n}\r\nrvalue = pci_request_regions(pdev, DRV_NAME);\r\nif (rvalue) {\r\nprintk(KERN_ERR "%s: pci_request_regions failure (rc=%d)\n",\r\nDRV_NAME, rvalue);\r\ngoto do_pci_disable_device;\r\n}\r\nrvalue = pci_read_config_dword(pdev, PCI_BASE_ADDRESS_0, &mem_addr);\r\nif (rvalue || !mem_addr) {\r\nprintk(KERN_ERR "%s: PCI device memory region not configured; fix your BIOS or CardBus bridge/drivers\n",\r\nDRV_NAME);\r\ngoto do_pci_release_regions;\r\n}\r\nDEBUG(SHOW_TRACING, "%s: pci_set_master(pdev)\n", DRV_NAME);\r\npci_set_master(pdev);\r\npci_try_set_mwi(pdev);\r\nif (!(ndev = islpci_setup(pdev))) {\r\nprintk(KERN_ERR "%s: could not configure network device\n",\r\nDRV_NAME);\r\ngoto do_pci_clear_mwi;\r\n}\r\npriv = netdev_priv(ndev);\r\nislpci_set_state(priv, PRV_STATE_PREBOOT);\r\nisl38xx_disable_interrupts(priv->device_base);\r\nrvalue = request_irq(pdev->irq, islpci_interrupt,\r\nIRQF_SHARED, ndev->name, priv);\r\nif (rvalue) {\r\nprintk(KERN_ERR "%s: could not install IRQ handler\n",\r\nndev->name);\r\ngoto do_unregister_netdev;\r\n}\r\nreturn 0;\r\ndo_unregister_netdev:\r\nunregister_netdev(ndev);\r\nislpci_free_memory(priv);\r\npci_set_drvdata(pdev, NULL);\r\nfree_netdev(ndev);\r\npriv = NULL;\r\ndo_pci_clear_mwi:\r\npci_clear_mwi(pdev);\r\ndo_pci_release_regions:\r\npci_release_regions(pdev);\r\ndo_pci_disable_device:\r\npci_disable_device(pdev);\r\nreturn -EIO;\r\n}\r\nstatic void\r\nprism54_remove(struct pci_dev *pdev)\r\n{\r\nstruct net_device *ndev = pci_get_drvdata(pdev);\r\nislpci_private *priv = ndev ? netdev_priv(ndev) : NULL;\r\nBUG_ON(!priv);\r\nif (!__in_cleanup_module) {\r\nprintk(KERN_DEBUG "%s: hot unplug detected\n", ndev->name);\r\nislpci_set_state(priv, PRV_STATE_OFF);\r\n}\r\nprintk(KERN_DEBUG "%s: removing device\n", ndev->name);\r\nunregister_netdev(ndev);\r\nif (islpci_get_state(priv) != PRV_STATE_OFF) {\r\nisl38xx_disable_interrupts(priv->device_base);\r\nislpci_set_state(priv, PRV_STATE_OFF);\r\n}\r\nfree_irq(pdev->irq, priv);\r\nislpci_free_memory(priv);\r\npci_set_drvdata(pdev, NULL);\r\nfree_netdev(ndev);\r\npriv = NULL;\r\npci_clear_mwi(pdev);\r\npci_release_regions(pdev);\r\npci_disable_device(pdev);\r\n}\r\nstatic int\r\nprism54_suspend(struct pci_dev *pdev, pm_message_t state)\r\n{\r\nstruct net_device *ndev = pci_get_drvdata(pdev);\r\nislpci_private *priv = ndev ? netdev_priv(ndev) : NULL;\r\nBUG_ON(!priv);\r\npci_save_state(pdev);\r\nisl38xx_disable_interrupts(priv->device_base);\r\nislpci_set_state(priv, PRV_STATE_OFF);\r\nnetif_stop_queue(ndev);\r\nnetif_device_detach(ndev);\r\nreturn 0;\r\n}\r\nstatic int\r\nprism54_resume(struct pci_dev *pdev)\r\n{\r\nstruct net_device *ndev = pci_get_drvdata(pdev);\r\nislpci_private *priv = ndev ? netdev_priv(ndev) : NULL;\r\nint err;\r\nBUG_ON(!priv);\r\nprintk(KERN_NOTICE "%s: got resume request\n", ndev->name);\r\nerr = pci_enable_device(pdev);\r\nif (err) {\r\nprintk(KERN_ERR "%s: pci_enable_device failed on resume\n",\r\nndev->name);\r\nreturn err;\r\n}\r\npci_restore_state(pdev);\r\nislpci_reset(priv, 1);\r\nnetif_device_attach(ndev);\r\nnetif_start_queue(ndev);\r\nreturn 0;\r\n}\r\nstatic int __init\r\nprism54_module_init(void)\r\n{\r\nprintk(KERN_INFO "Loaded %s driver, version %s\n",\r\nDRV_NAME, DRV_VERSION);\r\n__bug_on_wrong_struct_sizes ();\r\nreturn pci_register_driver(&prism54_driver);\r\n}\r\nstatic void __exit\r\nprism54_module_exit(void)\r\n{\r\n__in_cleanup_module = 1;\r\npci_unregister_driver(&prism54_driver);\r\nprintk(KERN_INFO "Unloaded %s driver\n", DRV_NAME);\r\n__in_cleanup_module = 0;\r\n}

void __flush_icache_range(unsigned long start, unsigned long end)\r\n{\r\ninvalidate_icache((const void *)start, end - start, PAGE_SIZE);\r\n}\r\nstatic inline void force_load(char *p)\r\n{\r\n*(volatile char *)p;\r\n}\r\nvoid finv_buffer_remote(void *buffer, size_t size, int hfh)\r\n{\r\nchar *p, *base;\r\nsize_t step_size, load_count;\r\n#ifdef __tilegx__\r\nconst unsigned long STRIPE_WIDTH = 512;\r\n#else\r\nconst unsigned long STRIPE_WIDTH = 8192;\r\n#endif\r\n#ifdef __tilegx__\r\nuint_reg_t old_dstream_pf = __insn_mfspr(SPR_DSTREAM_PF);\r\n__insn_mtspr(SPR_DSTREAM_PF, 0);\r\n#endif\r\n__finv_buffer(buffer, size);\r\n__insn_mf();\r\nif (hfh) {\r\nstep_size = L2_CACHE_BYTES;\r\n#ifdef __tilegx__\r\nload_count = (size + L2_CACHE_BYTES - 1) / L2_CACHE_BYTES;\r\n#else\r\nload_count = (STRIPE_WIDTH / L2_CACHE_BYTES) *\r\n(1 << CHIP_LOG_NUM_MSHIMS());\r\n#endif\r\n} else {\r\nstep_size = STRIPE_WIDTH;\r\nload_count = (1 << CHIP_LOG_NUM_MSHIMS());\r\n}\r\np = (char *)buffer + size - 1;\r\nforce_load(p);\r\np -= step_size;\r\np = (char *)((unsigned long)p | (step_size - 1));\r\nbase = p - (step_size * (load_count - 2));\r\nif ((unsigned long)base < (unsigned long)buffer)\r\nbase = buffer;\r\n#pragma unroll 8\r\nfor (; p >= base; p -= step_size)\r\nforce_load(p);\r\np = (char *)buffer + size - 1;\r\n__insn_inv(p);\r\np -= step_size;\r\np = (char *)((unsigned long)p | (step_size - 1));\r\nfor (; p >= base; p -= step_size)\r\n__insn_inv(p);\r\n__insn_mf();\r\n#ifdef __tilegx__\r\n__insn_mtspr(SPR_DSTREAM_PF, old_dstream_pf);\r\n#endif\r\n}

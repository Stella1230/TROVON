static int snd_rawmidi_ioctl_params_compat(struct snd_rawmidi_file *rfile,\r\nstruct snd_rawmidi_params32 __user *src)\r\n{\r\nstruct snd_rawmidi_params params;\r\nunsigned int val;\r\nif (rfile->output == NULL)\r\nreturn -EINVAL;\r\nif (get_user(params.stream, &src->stream) ||\r\nget_user(params.buffer_size, &src->buffer_size) ||\r\nget_user(params.avail_min, &src->avail_min) ||\r\nget_user(val, &src->no_active_sensing))\r\nreturn -EFAULT;\r\nparams.no_active_sensing = val;\r\nswitch (params.stream) {\r\ncase SNDRV_RAWMIDI_STREAM_OUTPUT:\r\nreturn snd_rawmidi_output_params(rfile->output, &params);\r\ncase SNDRV_RAWMIDI_STREAM_INPUT:\r\nreturn snd_rawmidi_input_params(rfile->input, &params);\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int snd_rawmidi_ioctl_status_compat(struct snd_rawmidi_file *rfile,\r\nstruct snd_rawmidi_status32 __user *src)\r\n{\r\nint err;\r\nstruct snd_rawmidi_status status;\r\nif (rfile->output == NULL)\r\nreturn -EINVAL;\r\nif (get_user(status.stream, &src->stream))\r\nreturn -EFAULT;\r\nswitch (status.stream) {\r\ncase SNDRV_RAWMIDI_STREAM_OUTPUT:\r\nerr = snd_rawmidi_output_status(rfile->output, &status);\r\nbreak;\r\ncase SNDRV_RAWMIDI_STREAM_INPUT:\r\nerr = snd_rawmidi_input_status(rfile->input, &status);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (err < 0)\r\nreturn err;\r\nif (put_user(status.tstamp.tv_sec, &src->tstamp.tv_sec) ||\r\nput_user(status.tstamp.tv_nsec, &src->tstamp.tv_nsec) ||\r\nput_user(status.avail, &src->avail) ||\r\nput_user(status.xruns, &src->xruns))\r\nreturn -EFAULT;\r\nreturn 0;\r\n}\r\nstatic long snd_rawmidi_ioctl_compat(struct file *file, unsigned int cmd, unsigned long arg)\r\n{\r\nstruct snd_rawmidi_file *rfile;\r\nvoid __user *argp = compat_ptr(arg);\r\nrfile = file->private_data;\r\nswitch (cmd) {\r\ncase SNDRV_RAWMIDI_IOCTL_PVERSION:\r\ncase SNDRV_RAWMIDI_IOCTL_INFO:\r\ncase SNDRV_RAWMIDI_IOCTL_DROP:\r\ncase SNDRV_RAWMIDI_IOCTL_DRAIN:\r\nreturn snd_rawmidi_ioctl(file, cmd, (unsigned long)argp);\r\ncase SNDRV_RAWMIDI_IOCTL_PARAMS32:\r\nreturn snd_rawmidi_ioctl_params_compat(rfile, argp);\r\ncase SNDRV_RAWMIDI_IOCTL_STATUS32:\r\nreturn snd_rawmidi_ioctl_status_compat(rfile, argp);\r\n}\r\nreturn -ENOIOCTLCMD;\r\n}

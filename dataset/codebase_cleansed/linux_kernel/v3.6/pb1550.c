const char *get_system_type(void)\r\n{\r\nreturn "PB1550";\r\n}\r\nvoid __init board_setup(void)\r\n{\r\nu32 pin_func;\r\nbcsr_init(PB1550_BCSR_PHYS_ADDR,\r\nPB1550_BCSR_PHYS_ADDR + PB1550_BCSR_HEXLED_OFS);\r\nalchemy_gpio2_enable();\r\npin_func = au_readl(SYS_PINFUNC);\r\nau_sync();\r\npin_func |= SYS_PF_MUST_BE_SET | SYS_PF_PSC1_S1;\r\nau_writel(pin_func, SYS_PINFUNC);\r\nbcsr_write(BCSR_PCMCIA, 0);\r\nprintk(KERN_INFO "AMD Alchemy Pb1550 Board\n");\r\n}\r\nstatic int pb1550_map_pci_irq(const struct pci_dev *d, u8 slot, u8 pin)\r\n{\r\nif ((slot < 12) || (slot > 13) || pin == 0)\r\nreturn -1;\r\nif (slot == 12) {\r\nswitch (pin) {\r\ncase 1: return AU1500_PCI_INTB;\r\ncase 2: return AU1500_PCI_INTC;\r\ncase 3: return AU1500_PCI_INTD;\r\ncase 4: return AU1500_PCI_INTA;\r\n}\r\n}\r\nif (slot == 13) {\r\nswitch (pin) {\r\ncase 1: return AU1500_PCI_INTA;\r\ncase 2: return AU1500_PCI_INTB;\r\ncase 3: return AU1500_PCI_INTC;\r\ncase 4: return AU1500_PCI_INTD;\r\n}\r\n}\r\nreturn -1;\r\n}\r\nstatic void __init pb1550_nand_setup(void)\r\n{\r\nint boot_swapboot = (au_readl(MEM_STSTAT) & (0x7 << 1)) |\r\n((bcsr_read(BCSR_STATUS) >> 6) & 0x1);\r\nswitch (boot_swapboot) {\r\ncase 0:\r\ncase 2:\r\ncase 8:\r\ncase 0xC:\r\ncase 0xD:\r\npb1550_nand_pd.devwidth = 1;\r\ncase 1:\r\ncase 9:\r\ncase 3:\r\ncase 0xE:\r\ncase 0xF:\r\nplatform_device_register(&pb1550_nand_dev);\r\n}\r\n}\r\nstatic int __init pb1550_dev_init(void)\r\n{\r\nint swapped;\r\nirq_set_irq_type(AU1550_GPIO0_INT, IRQF_TRIGGER_LOW);\r\nirq_set_irq_type(AU1550_GPIO1_INT, IRQF_TRIGGER_LOW);\r\nirq_set_irq_type(AU1550_GPIO201_205_INT, IRQF_TRIGGER_HIGH);\r\nalchemy_gpio2_enable_int(201);\r\nalchemy_gpio2_enable_int(202);\r\ndb1x_register_pcmcia_socket(\r\nAU1000_PCMCIA_ATTR_PHYS_ADDR,\r\nAU1000_PCMCIA_ATTR_PHYS_ADDR + 0x000400000 - 1,\r\nAU1000_PCMCIA_MEM_PHYS_ADDR,\r\nAU1000_PCMCIA_MEM_PHYS_ADDR + 0x000400000 - 1,\r\nAU1000_PCMCIA_IO_PHYS_ADDR,\r\nAU1000_PCMCIA_IO_PHYS_ADDR + 0x000010000 - 1,\r\nAU1550_GPIO201_205_INT, AU1550_GPIO0_INT, 0, 0, 0);\r\ndb1x_register_pcmcia_socket(\r\nAU1000_PCMCIA_ATTR_PHYS_ADDR + 0x008000000,\r\nAU1000_PCMCIA_ATTR_PHYS_ADDR + 0x008400000 - 1,\r\nAU1000_PCMCIA_MEM_PHYS_ADDR + 0x008000000,\r\nAU1000_PCMCIA_MEM_PHYS_ADDR + 0x008400000 - 1,\r\nAU1000_PCMCIA_IO_PHYS_ADDR + 0x008000000,\r\nAU1000_PCMCIA_IO_PHYS_ADDR + 0x008010000 - 1,\r\nAU1550_GPIO201_205_INT, AU1550_GPIO1_INT, 0, 0, 1);\r\ngpio_direction_input(206);\r\npb1550_nand_setup();\r\nswapped = bcsr_read(BCSR_STATUS) & BCSR_STATUS_PB1550_SWAPBOOT;\r\ndb1x_register_norflash(128 * 1024 * 1024, 4, swapped);\r\nplatform_device_register(&pb1550_pci_host);\r\nplatform_device_register(&pb1550_i2c_dev);\r\nreturn 0;\r\n}

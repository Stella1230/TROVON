static int idepnp_probe(struct pnp_dev *dev, const struct pnp_device_id *dev_id)\r\n{\r\nstruct ide_host *host;\r\nunsigned long base, ctl;\r\nint rc;\r\nstruct ide_hw hw, *hws[] = { &hw };\r\nprintk(KERN_INFO DRV_NAME ": generic PnP IDE interface\n");\r\nif (!(pnp_port_valid(dev, 0) && pnp_port_valid(dev, 1) && pnp_irq_valid(dev, 0)))\r\nreturn -1;\r\nbase = pnp_port_start(dev, 0);\r\nctl = pnp_port_start(dev, 1);\r\nif (!request_region(base, 8, DRV_NAME)) {\r\nprintk(KERN_ERR "%s: I/O resource 0x%lX-0x%lX not free.\n",\r\nDRV_NAME, base, base + 7);\r\nreturn -EBUSY;\r\n}\r\nif (!request_region(ctl, 1, DRV_NAME)) {\r\nprintk(KERN_ERR "%s: I/O resource 0x%lX not free.\n",\r\nDRV_NAME, ctl);\r\nrelease_region(base, 8);\r\nreturn -EBUSY;\r\n}\r\nmemset(&hw, 0, sizeof(hw));\r\nide_std_init_ports(&hw, base, ctl);\r\nhw.irq = pnp_irq(dev, 0);\r\nrc = ide_host_add(&ide_pnp_port_info, hws, 1, &host);\r\nif (rc)\r\ngoto out;\r\npnp_set_drvdata(dev, host);\r\nreturn 0;\r\nout:\r\nrelease_region(ctl, 1);\r\nrelease_region(base, 8);\r\nreturn rc;\r\n}\r\nstatic void idepnp_remove(struct pnp_dev *dev)\r\n{\r\nstruct ide_host *host = pnp_get_drvdata(dev);\r\nide_host_remove(host);\r\nrelease_region(pnp_port_start(dev, 1), 1);\r\nrelease_region(pnp_port_start(dev, 0), 8);\r\n}\r\nstatic int __init pnpide_init(void)\r\n{\r\nreturn pnp_register_driver(&idepnp_driver);\r\n}\r\nstatic void __exit pnpide_exit(void)\r\n{\r\npnp_unregister_driver(&idepnp_driver);\r\n}

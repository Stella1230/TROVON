static int\r\nlpfc_debugfs_disc_trc_data(struct lpfc_vport *vport, char *buf, int size)\r\n{\r\nint i, index, len, enable;\r\nuint32_t ms;\r\nstruct lpfc_debugfs_trc *dtp;\r\nchar *buffer;\r\nbuffer = kmalloc(LPFC_DEBUG_TRC_ENTRY_SIZE, GFP_KERNEL);\r\nif (!buffer)\r\nreturn 0;\r\nenable = lpfc_debugfs_enable;\r\nlpfc_debugfs_enable = 0;\r\nlen = 0;\r\nindex = (atomic_read(&vport->disc_trc_cnt) + 1) &\r\n(lpfc_debugfs_max_disc_trc - 1);\r\nfor (i = index; i < lpfc_debugfs_max_disc_trc; i++) {\r\ndtp = vport->disc_trc + i;\r\nif (!dtp->fmt)\r\ncontinue;\r\nms = jiffies_to_msecs(dtp->jif - lpfc_debugfs_start_time);\r\nsnprintf(buffer,\r\nLPFC_DEBUG_TRC_ENTRY_SIZE, "%010d:%010d ms:%s\n",\r\ndtp->seq_cnt, ms, dtp->fmt);\r\nlen += snprintf(buf+len, size-len, buffer,\r\ndtp->data1, dtp->data2, dtp->data3);\r\n}\r\nfor (i = 0; i < index; i++) {\r\ndtp = vport->disc_trc + i;\r\nif (!dtp->fmt)\r\ncontinue;\r\nms = jiffies_to_msecs(dtp->jif - lpfc_debugfs_start_time);\r\nsnprintf(buffer,\r\nLPFC_DEBUG_TRC_ENTRY_SIZE, "%010d:%010d ms:%s\n",\r\ndtp->seq_cnt, ms, dtp->fmt);\r\nlen += snprintf(buf+len, size-len, buffer,\r\ndtp->data1, dtp->data2, dtp->data3);\r\n}\r\nlpfc_debugfs_enable = enable;\r\nkfree(buffer);\r\nreturn len;\r\n}\r\nstatic int\r\nlpfc_debugfs_slow_ring_trc_data(struct lpfc_hba *phba, char *buf, int size)\r\n{\r\nint i, index, len, enable;\r\nuint32_t ms;\r\nstruct lpfc_debugfs_trc *dtp;\r\nchar *buffer;\r\nbuffer = kmalloc(LPFC_DEBUG_TRC_ENTRY_SIZE, GFP_KERNEL);\r\nif (!buffer)\r\nreturn 0;\r\nenable = lpfc_debugfs_enable;\r\nlpfc_debugfs_enable = 0;\r\nlen = 0;\r\nindex = (atomic_read(&phba->slow_ring_trc_cnt) + 1) &\r\n(lpfc_debugfs_max_slow_ring_trc - 1);\r\nfor (i = index; i < lpfc_debugfs_max_slow_ring_trc; i++) {\r\ndtp = phba->slow_ring_trc + i;\r\nif (!dtp->fmt)\r\ncontinue;\r\nms = jiffies_to_msecs(dtp->jif - lpfc_debugfs_start_time);\r\nsnprintf(buffer,\r\nLPFC_DEBUG_TRC_ENTRY_SIZE, "%010d:%010d ms:%s\n",\r\ndtp->seq_cnt, ms, dtp->fmt);\r\nlen += snprintf(buf+len, size-len, buffer,\r\ndtp->data1, dtp->data2, dtp->data3);\r\n}\r\nfor (i = 0; i < index; i++) {\r\ndtp = phba->slow_ring_trc + i;\r\nif (!dtp->fmt)\r\ncontinue;\r\nms = jiffies_to_msecs(dtp->jif - lpfc_debugfs_start_time);\r\nsnprintf(buffer,\r\nLPFC_DEBUG_TRC_ENTRY_SIZE, "%010d:%010d ms:%s\n",\r\ndtp->seq_cnt, ms, dtp->fmt);\r\nlen += snprintf(buf+len, size-len, buffer,\r\ndtp->data1, dtp->data2, dtp->data3);\r\n}\r\nlpfc_debugfs_enable = enable;\r\nkfree(buffer);\r\nreturn len;\r\n}\r\nstatic int\r\nlpfc_debugfs_hbqinfo_data(struct lpfc_hba *phba, char *buf, int size)\r\n{\r\nint len = 0;\r\nint cnt, i, j, found, posted, low;\r\nuint32_t phys, raw_index, getidx;\r\nstruct lpfc_hbq_init *hip;\r\nstruct hbq_s *hbqs;\r\nstruct lpfc_hbq_entry *hbqe;\r\nstruct lpfc_dmabuf *d_buf;\r\nstruct hbq_dmabuf *hbq_buf;\r\nif (phba->sli_rev != 3)\r\nreturn 0;\r\ncnt = LPFC_HBQINFO_SIZE;\r\nspin_lock_irq(&phba->hbalock);\r\ni = lpfc_sli_hbq_count();\r\nif (i > 1) {\r\nlpfc_debugfs_last_hbq++;\r\nif (lpfc_debugfs_last_hbq >= i)\r\nlpfc_debugfs_last_hbq = 0;\r\n}\r\nelse\r\nlpfc_debugfs_last_hbq = 0;\r\ni = lpfc_debugfs_last_hbq;\r\nlen += snprintf(buf+len, size-len, "HBQ %d Info\n", i);\r\nhbqs = &phba->hbqs[i];\r\nposted = 0;\r\nlist_for_each_entry(d_buf, &hbqs->hbq_buffer_list, list)\r\nposted++;\r\nhip = lpfc_hbq_defs[i];\r\nlen += snprintf(buf+len, size-len,\r\n"idx:%d prof:%d rn:%d bufcnt:%d icnt:%d acnt:%d posted %d\n",\r\nhip->hbq_index, hip->profile, hip->rn,\r\nhip->buffer_count, hip->init_count, hip->add_count, posted);\r\nraw_index = phba->hbq_get[i];\r\ngetidx = le32_to_cpu(raw_index);\r\nlen += snprintf(buf+len, size-len,\r\n"entrys:%d bufcnt:%d Put:%d nPut:%d localGet:%d hbaGet:%d\n",\r\nhbqs->entry_count, hbqs->buffer_count, hbqs->hbqPutIdx,\r\nhbqs->next_hbqPutIdx, hbqs->local_hbqGetIdx, getidx);\r\nhbqe = (struct lpfc_hbq_entry *) phba->hbqs[i].hbq_virt;\r\nfor (j=0; j<hbqs->entry_count; j++) {\r\nlen += snprintf(buf+len, size-len,\r\n"%03d: %08x %04x %05x ", j,\r\nle32_to_cpu(hbqe->bde.addrLow),\r\nle32_to_cpu(hbqe->bde.tus.w),\r\nle32_to_cpu(hbqe->buffer_tag));\r\ni = 0;\r\nfound = 0;\r\nlow = hbqs->hbqPutIdx - posted;\r\nif (low >= 0) {\r\nif ((j >= hbqs->hbqPutIdx) || (j < low)) {\r\nlen += snprintf(buf+len, size-len, "Unused\n");\r\ngoto skipit;\r\n}\r\n}\r\nelse {\r\nif ((j >= hbqs->hbqPutIdx) &&\r\n(j < (hbqs->entry_count+low))) {\r\nlen += snprintf(buf+len, size-len, "Unused\n");\r\ngoto skipit;\r\n}\r\n}\r\nlist_for_each_entry(d_buf, &hbqs->hbq_buffer_list, list) {\r\nhbq_buf = container_of(d_buf, struct hbq_dmabuf, dbuf);\r\nphys = ((uint64_t)hbq_buf->dbuf.phys & 0xffffffff);\r\nif (phys == le32_to_cpu(hbqe->bde.addrLow)) {\r\nlen += snprintf(buf+len, size-len,\r\n"Buf%d: %p %06x\n", i,\r\nhbq_buf->dbuf.virt, hbq_buf->tag);\r\nfound = 1;\r\nbreak;\r\n}\r\ni++;\r\n}\r\nif (!found) {\r\nlen += snprintf(buf+len, size-len, "No DMAinfo?\n");\r\n}\r\nskipit:\r\nhbqe++;\r\nif (len > LPFC_HBQINFO_SIZE - 54)\r\nbreak;\r\n}\r\nspin_unlock_irq(&phba->hbalock);\r\nreturn len;\r\n}\r\nstatic int\r\nlpfc_debugfs_dumpHBASlim_data(struct lpfc_hba *phba, char *buf, int size)\r\n{\r\nint len = 0;\r\nint i, off;\r\nuint32_t *ptr;\r\nchar *buffer;\r\nbuffer = kmalloc(1024, GFP_KERNEL);\r\nif (!buffer)\r\nreturn 0;\r\noff = 0;\r\nspin_lock_irq(&phba->hbalock);\r\nlen += snprintf(buf+len, size-len, "HBA SLIM\n");\r\nlpfc_memcpy_from_slim(buffer,\r\nphba->MBslimaddr + lpfc_debugfs_last_hba_slim_off, 1024);\r\nptr = (uint32_t *)&buffer[0];\r\noff = lpfc_debugfs_last_hba_slim_off;\r\nlpfc_debugfs_last_hba_slim_off += 1024;\r\nif (lpfc_debugfs_last_hba_slim_off >= 4096)\r\nlpfc_debugfs_last_hba_slim_off = 0;\r\ni = 1024;\r\nwhile (i > 0) {\r\nlen += snprintf(buf+len, size-len,\r\n"%08x: %08x %08x %08x %08x %08x %08x %08x %08x\n",\r\noff, *ptr, *(ptr+1), *(ptr+2), *(ptr+3), *(ptr+4),\r\n*(ptr+5), *(ptr+6), *(ptr+7));\r\nptr += 8;\r\ni -= (8 * sizeof(uint32_t));\r\noff += (8 * sizeof(uint32_t));\r\n}\r\nspin_unlock_irq(&phba->hbalock);\r\nkfree(buffer);\r\nreturn len;\r\n}\r\nstatic int\r\nlpfc_debugfs_dumpHostSlim_data(struct lpfc_hba *phba, char *buf, int size)\r\n{\r\nint len = 0;\r\nint i, off;\r\nuint32_t word0, word1, word2, word3;\r\nuint32_t *ptr;\r\nstruct lpfc_pgp *pgpp;\r\nstruct lpfc_sli *psli = &phba->sli;\r\nstruct lpfc_sli_ring *pring;\r\noff = 0;\r\nspin_lock_irq(&phba->hbalock);\r\nlen += snprintf(buf+len, size-len, "SLIM Mailbox\n");\r\nptr = (uint32_t *)phba->slim2p.virt;\r\ni = sizeof(MAILBOX_t);\r\nwhile (i > 0) {\r\nlen += snprintf(buf+len, size-len,\r\n"%08x: %08x %08x %08x %08x %08x %08x %08x %08x\n",\r\noff, *ptr, *(ptr+1), *(ptr+2), *(ptr+3), *(ptr+4),\r\n*(ptr+5), *(ptr+6), *(ptr+7));\r\nptr += 8;\r\ni -= (8 * sizeof(uint32_t));\r\noff += (8 * sizeof(uint32_t));\r\n}\r\nlen += snprintf(buf+len, size-len, "SLIM PCB\n");\r\nptr = (uint32_t *)phba->pcb;\r\ni = sizeof(PCB_t);\r\nwhile (i > 0) {\r\nlen += snprintf(buf+len, size-len,\r\n"%08x: %08x %08x %08x %08x %08x %08x %08x %08x\n",\r\noff, *ptr, *(ptr+1), *(ptr+2), *(ptr+3), *(ptr+4),\r\n*(ptr+5), *(ptr+6), *(ptr+7));\r\nptr += 8;\r\ni -= (8 * sizeof(uint32_t));\r\noff += (8 * sizeof(uint32_t));\r\n}\r\nfor (i = 0; i < 4; i++) {\r\npgpp = &phba->port_gp[i];\r\npring = &psli->ring[i];\r\nlen += snprintf(buf+len, size-len,\r\n"Ring %d: CMD GetInx:%d (Max:%d Next:%d "\r\n"Local:%d flg:x%x) RSP PutInx:%d Max:%d\n",\r\ni, pgpp->cmdGetInx, pring->numCiocb,\r\npring->next_cmdidx, pring->local_getidx,\r\npring->flag, pgpp->rspPutInx, pring->numRiocb);\r\n}\r\nif (phba->sli_rev <= LPFC_SLI_REV3) {\r\nword0 = readl(phba->HAregaddr);\r\nword1 = readl(phba->CAregaddr);\r\nword2 = readl(phba->HSregaddr);\r\nword3 = readl(phba->HCregaddr);\r\nlen += snprintf(buf+len, size-len, "HA:%08x CA:%08x HS:%08x "\r\n"HC:%08x\n", word0, word1, word2, word3);\r\n}\r\nspin_unlock_irq(&phba->hbalock);\r\nreturn len;\r\n}\r\nstatic int\r\nlpfc_debugfs_nodelist_data(struct lpfc_vport *vport, char *buf, int size)\r\n{\r\nint len = 0;\r\nint cnt;\r\nstruct Scsi_Host *shost = lpfc_shost_from_vport(vport);\r\nstruct lpfc_nodelist *ndlp;\r\nunsigned char *statep, *name;\r\ncnt = (LPFC_NODELIST_SIZE / LPFC_NODELIST_ENTRY_SIZE);\r\nspin_lock_irq(shost->host_lock);\r\nlist_for_each_entry(ndlp, &vport->fc_nodes, nlp_listp) {\r\nif (!cnt) {\r\nlen += snprintf(buf+len, size-len,\r\n"Missing Nodelist Entries\n");\r\nbreak;\r\n}\r\ncnt--;\r\nswitch (ndlp->nlp_state) {\r\ncase NLP_STE_UNUSED_NODE:\r\nstatep = "UNUSED";\r\nbreak;\r\ncase NLP_STE_PLOGI_ISSUE:\r\nstatep = "PLOGI ";\r\nbreak;\r\ncase NLP_STE_ADISC_ISSUE:\r\nstatep = "ADISC ";\r\nbreak;\r\ncase NLP_STE_REG_LOGIN_ISSUE:\r\nstatep = "REGLOG";\r\nbreak;\r\ncase NLP_STE_PRLI_ISSUE:\r\nstatep = "PRLI ";\r\nbreak;\r\ncase NLP_STE_UNMAPPED_NODE:\r\nstatep = "UNMAP ";\r\nbreak;\r\ncase NLP_STE_MAPPED_NODE:\r\nstatep = "MAPPED";\r\nbreak;\r\ncase NLP_STE_NPR_NODE:\r\nstatep = "NPR ";\r\nbreak;\r\ndefault:\r\nstatep = "UNKNOWN";\r\n}\r\nlen += snprintf(buf+len, size-len, "%s DID:x%06x ",\r\nstatep, ndlp->nlp_DID);\r\nname = (unsigned char *)&ndlp->nlp_portname;\r\nlen += snprintf(buf+len, size-len,\r\n"WWPN %02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x ",\r\n*name, *(name+1), *(name+2), *(name+3),\r\n*(name+4), *(name+5), *(name+6), *(name+7));\r\nname = (unsigned char *)&ndlp->nlp_nodename;\r\nlen += snprintf(buf+len, size-len,\r\n"WWNN %02x:%02x:%02x:%02x:%02x:%02x:%02x:%02x ",\r\n*name, *(name+1), *(name+2), *(name+3),\r\n*(name+4), *(name+5), *(name+6), *(name+7));\r\nlen += snprintf(buf+len, size-len, "RPI:%03d flag:x%08x ",\r\nndlp->nlp_rpi, ndlp->nlp_flag);\r\nif (!ndlp->nlp_type)\r\nlen += snprintf(buf+len, size-len, "UNKNOWN_TYPE ");\r\nif (ndlp->nlp_type & NLP_FC_NODE)\r\nlen += snprintf(buf+len, size-len, "FC_NODE ");\r\nif (ndlp->nlp_type & NLP_FABRIC)\r\nlen += snprintf(buf+len, size-len, "FABRIC ");\r\nif (ndlp->nlp_type & NLP_FCP_TARGET)\r\nlen += snprintf(buf+len, size-len, "FCP_TGT sid:%d ",\r\nndlp->nlp_sid);\r\nif (ndlp->nlp_type & NLP_FCP_INITIATOR)\r\nlen += snprintf(buf+len, size-len, "FCP_INITIATOR ");\r\nlen += snprintf(buf+len, size-len, "usgmap:%x ",\r\nndlp->nlp_usg_map);\r\nlen += snprintf(buf+len, size-len, "refcnt:%x",\r\natomic_read(&ndlp->kref.refcount));\r\nlen += snprintf(buf+len, size-len, "\n");\r\n}\r\nspin_unlock_irq(shost->host_lock);\r\nreturn len;\r\n}\r\ninline void\r\nlpfc_debugfs_disc_trc(struct lpfc_vport *vport, int mask, char *fmt,\r\nuint32_t data1, uint32_t data2, uint32_t data3)\r\n{\r\n#ifdef CONFIG_SCSI_LPFC_DEBUG_FS\r\nstruct lpfc_debugfs_trc *dtp;\r\nint index;\r\nif (!(lpfc_debugfs_mask_disc_trc & mask))\r\nreturn;\r\nif (!lpfc_debugfs_enable || !lpfc_debugfs_max_disc_trc ||\r\n!vport || !vport->disc_trc)\r\nreturn;\r\nindex = atomic_inc_return(&vport->disc_trc_cnt) &\r\n(lpfc_debugfs_max_disc_trc - 1);\r\ndtp = vport->disc_trc + index;\r\ndtp->fmt = fmt;\r\ndtp->data1 = data1;\r\ndtp->data2 = data2;\r\ndtp->data3 = data3;\r\ndtp->seq_cnt = atomic_inc_return(&lpfc_debugfs_seq_trc_cnt);\r\ndtp->jif = jiffies;\r\n#endif\r\nreturn;\r\n}\r\ninline void\r\nlpfc_debugfs_slow_ring_trc(struct lpfc_hba *phba, char *fmt,\r\nuint32_t data1, uint32_t data2, uint32_t data3)\r\n{\r\n#ifdef CONFIG_SCSI_LPFC_DEBUG_FS\r\nstruct lpfc_debugfs_trc *dtp;\r\nint index;\r\nif (!lpfc_debugfs_enable || !lpfc_debugfs_max_slow_ring_trc ||\r\n!phba || !phba->slow_ring_trc)\r\nreturn;\r\nindex = atomic_inc_return(&phba->slow_ring_trc_cnt) &\r\n(lpfc_debugfs_max_slow_ring_trc - 1);\r\ndtp = phba->slow_ring_trc + index;\r\ndtp->fmt = fmt;\r\ndtp->data1 = data1;\r\ndtp->data2 = data2;\r\ndtp->data3 = data3;\r\ndtp->seq_cnt = atomic_inc_return(&lpfc_debugfs_seq_trc_cnt);\r\ndtp->jif = jiffies;\r\n#endif\r\nreturn;\r\n}\r\nstatic int\r\nlpfc_debugfs_disc_trc_open(struct inode *inode, struct file *file)\r\n{\r\nstruct lpfc_vport *vport = inode->i_private;\r\nstruct lpfc_debug *debug;\r\nint size;\r\nint rc = -ENOMEM;\r\nif (!lpfc_debugfs_max_disc_trc) {\r\nrc = -ENOSPC;\r\ngoto out;\r\n}\r\ndebug = kmalloc(sizeof(*debug), GFP_KERNEL);\r\nif (!debug)\r\ngoto out;\r\nsize = (lpfc_debugfs_max_disc_trc * LPFC_DEBUG_TRC_ENTRY_SIZE);\r\nsize = PAGE_ALIGN(size);\r\ndebug->buffer = kmalloc(size, GFP_KERNEL);\r\nif (!debug->buffer) {\r\nkfree(debug);\r\ngoto out;\r\n}\r\ndebug->len = lpfc_debugfs_disc_trc_data(vport, debug->buffer, size);\r\nfile->private_data = debug;\r\nrc = 0;\r\nout:\r\nreturn rc;\r\n}\r\nstatic int\r\nlpfc_debugfs_slow_ring_trc_open(struct inode *inode, struct file *file)\r\n{\r\nstruct lpfc_hba *phba = inode->i_private;\r\nstruct lpfc_debug *debug;\r\nint size;\r\nint rc = -ENOMEM;\r\nif (!lpfc_debugfs_max_slow_ring_trc) {\r\nrc = -ENOSPC;\r\ngoto out;\r\n}\r\ndebug = kmalloc(sizeof(*debug), GFP_KERNEL);\r\nif (!debug)\r\ngoto out;\r\nsize = (lpfc_debugfs_max_slow_ring_trc * LPFC_DEBUG_TRC_ENTRY_SIZE);\r\nsize = PAGE_ALIGN(size);\r\ndebug->buffer = kmalloc(size, GFP_KERNEL);\r\nif (!debug->buffer) {\r\nkfree(debug);\r\ngoto out;\r\n}\r\ndebug->len = lpfc_debugfs_slow_ring_trc_data(phba, debug->buffer, size);\r\nfile->private_data = debug;\r\nrc = 0;\r\nout:\r\nreturn rc;\r\n}\r\nstatic int\r\nlpfc_debugfs_hbqinfo_open(struct inode *inode, struct file *file)\r\n{\r\nstruct lpfc_hba *phba = inode->i_private;\r\nstruct lpfc_debug *debug;\r\nint rc = -ENOMEM;\r\ndebug = kmalloc(sizeof(*debug), GFP_KERNEL);\r\nif (!debug)\r\ngoto out;\r\ndebug->buffer = kmalloc(LPFC_HBQINFO_SIZE, GFP_KERNEL);\r\nif (!debug->buffer) {\r\nkfree(debug);\r\ngoto out;\r\n}\r\ndebug->len = lpfc_debugfs_hbqinfo_data(phba, debug->buffer,\r\nLPFC_HBQINFO_SIZE);\r\nfile->private_data = debug;\r\nrc = 0;\r\nout:\r\nreturn rc;\r\n}\r\nstatic int\r\nlpfc_debugfs_dumpHBASlim_open(struct inode *inode, struct file *file)\r\n{\r\nstruct lpfc_hba *phba = inode->i_private;\r\nstruct lpfc_debug *debug;\r\nint rc = -ENOMEM;\r\ndebug = kmalloc(sizeof(*debug), GFP_KERNEL);\r\nif (!debug)\r\ngoto out;\r\ndebug->buffer = kmalloc(LPFC_DUMPHBASLIM_SIZE, GFP_KERNEL);\r\nif (!debug->buffer) {\r\nkfree(debug);\r\ngoto out;\r\n}\r\ndebug->len = lpfc_debugfs_dumpHBASlim_data(phba, debug->buffer,\r\nLPFC_DUMPHBASLIM_SIZE);\r\nfile->private_data = debug;\r\nrc = 0;\r\nout:\r\nreturn rc;\r\n}\r\nstatic int\r\nlpfc_debugfs_dumpHostSlim_open(struct inode *inode, struct file *file)\r\n{\r\nstruct lpfc_hba *phba = inode->i_private;\r\nstruct lpfc_debug *debug;\r\nint rc = -ENOMEM;\r\ndebug = kmalloc(sizeof(*debug), GFP_KERNEL);\r\nif (!debug)\r\ngoto out;\r\ndebug->buffer = kmalloc(LPFC_DUMPHOSTSLIM_SIZE, GFP_KERNEL);\r\nif (!debug->buffer) {\r\nkfree(debug);\r\ngoto out;\r\n}\r\ndebug->len = lpfc_debugfs_dumpHostSlim_data(phba, debug->buffer,\r\nLPFC_DUMPHOSTSLIM_SIZE);\r\nfile->private_data = debug;\r\nrc = 0;\r\nout:\r\nreturn rc;\r\n}\r\nstatic int\r\nlpfc_debugfs_dumpData_open(struct inode *inode, struct file *file)\r\n{\r\nstruct lpfc_debug *debug;\r\nint rc = -ENOMEM;\r\nif (!_dump_buf_data)\r\nreturn -EBUSY;\r\ndebug = kmalloc(sizeof(*debug), GFP_KERNEL);\r\nif (!debug)\r\ngoto out;\r\nprintk(KERN_ERR "9059 BLKGRD: %s: _dump_buf_data=0x%p\n",\r\n__func__, _dump_buf_data);\r\ndebug->buffer = _dump_buf_data;\r\nif (!debug->buffer) {\r\nkfree(debug);\r\ngoto out;\r\n}\r\ndebug->len = (1 << _dump_buf_data_order) << PAGE_SHIFT;\r\nfile->private_data = debug;\r\nrc = 0;\r\nout:\r\nreturn rc;\r\n}\r\nstatic int\r\nlpfc_debugfs_dumpDif_open(struct inode *inode, struct file *file)\r\n{\r\nstruct lpfc_debug *debug;\r\nint rc = -ENOMEM;\r\nif (!_dump_buf_dif)\r\nreturn -EBUSY;\r\ndebug = kmalloc(sizeof(*debug), GFP_KERNEL);\r\nif (!debug)\r\ngoto out;\r\nprintk(KERN_ERR "9060 BLKGRD: %s: _dump_buf_dif=0x%p file=%s\n",\r\n__func__, _dump_buf_dif, file->f_dentry->d_name.name);\r\ndebug->buffer = _dump_buf_dif;\r\nif (!debug->buffer) {\r\nkfree(debug);\r\ngoto out;\r\n}\r\ndebug->len = (1 << _dump_buf_dif_order) << PAGE_SHIFT;\r\nfile->private_data = debug;\r\nrc = 0;\r\nout:\r\nreturn rc;\r\n}\r\nstatic ssize_t\r\nlpfc_debugfs_dumpDataDif_write(struct file *file, const char __user *buf,\r\nsize_t nbytes, loff_t *ppos)\r\n{\r\nspin_lock(&_dump_buf_lock);\r\nmemset((void *)_dump_buf_data, 0,\r\n((1 << PAGE_SHIFT) << _dump_buf_data_order));\r\nmemset((void *)_dump_buf_dif, 0,\r\n((1 << PAGE_SHIFT) << _dump_buf_dif_order));\r\n_dump_buf_done = 0;\r\nspin_unlock(&_dump_buf_lock);\r\nreturn nbytes;\r\n}\r\nstatic ssize_t\r\nlpfc_debugfs_dif_err_read(struct file *file, char __user *buf,\r\nsize_t nbytes, loff_t *ppos)\r\n{\r\nstruct dentry *dent = file->f_dentry;\r\nstruct lpfc_hba *phba = file->private_data;\r\nchar cbuf[32];\r\nuint64_t tmp = 0;\r\nint cnt = 0;\r\nif (dent == phba->debug_writeGuard)\r\ncnt = snprintf(cbuf, 32, "%u\n", phba->lpfc_injerr_wgrd_cnt);\r\nelse if (dent == phba->debug_writeApp)\r\ncnt = snprintf(cbuf, 32, "%u\n", phba->lpfc_injerr_wapp_cnt);\r\nelse if (dent == phba->debug_writeRef)\r\ncnt = snprintf(cbuf, 32, "%u\n", phba->lpfc_injerr_wref_cnt);\r\nelse if (dent == phba->debug_readGuard)\r\ncnt = snprintf(cbuf, 32, "%u\n", phba->lpfc_injerr_rgrd_cnt);\r\nelse if (dent == phba->debug_readApp)\r\ncnt = snprintf(cbuf, 32, "%u\n", phba->lpfc_injerr_rapp_cnt);\r\nelse if (dent == phba->debug_readRef)\r\ncnt = snprintf(cbuf, 32, "%u\n", phba->lpfc_injerr_rref_cnt);\r\nelse if (dent == phba->debug_InjErrNPortID)\r\ncnt = snprintf(cbuf, 32, "0x%06x\n", phba->lpfc_injerr_nportid);\r\nelse if (dent == phba->debug_InjErrWWPN) {\r\nmemcpy(&tmp, &phba->lpfc_injerr_wwpn, sizeof(struct lpfc_name));\r\ntmp = cpu_to_be64(tmp);\r\ncnt = snprintf(cbuf, 32, "0x%016llx\n", tmp);\r\n} else if (dent == phba->debug_InjErrLBA) {\r\nif (phba->lpfc_injerr_lba == (sector_t)(-1))\r\ncnt = snprintf(cbuf, 32, "off\n");\r\nelse\r\ncnt = snprintf(cbuf, 32, "0x%llx\n",\r\n(uint64_t) phba->lpfc_injerr_lba);\r\n} else\r\nlpfc_printf_log(phba, KERN_ERR, LOG_INIT,\r\n"0547 Unknown debugfs error injection entry\n");\r\nreturn simple_read_from_buffer(buf, nbytes, ppos, &cbuf, cnt);\r\n}\r\nstatic ssize_t\r\nlpfc_debugfs_dif_err_write(struct file *file, const char __user *buf,\r\nsize_t nbytes, loff_t *ppos)\r\n{\r\nstruct dentry *dent = file->f_dentry;\r\nstruct lpfc_hba *phba = file->private_data;\r\nchar dstbuf[32];\r\nuint64_t tmp = 0;\r\nint size;\r\nmemset(dstbuf, 0, 32);\r\nsize = (nbytes < 32) ? nbytes : 32;\r\nif (copy_from_user(dstbuf, buf, size))\r\nreturn 0;\r\nif (dent == phba->debug_InjErrLBA) {\r\nif ((buf[0] == 'o') && (buf[1] == 'f') && (buf[2] == 'f'))\r\ntmp = (uint64_t)(-1);\r\n}\r\nif ((tmp == 0) && (kstrtoull(dstbuf, 0, &tmp)))\r\nreturn 0;\r\nif (dent == phba->debug_writeGuard)\r\nphba->lpfc_injerr_wgrd_cnt = (uint32_t)tmp;\r\nelse if (dent == phba->debug_writeApp)\r\nphba->lpfc_injerr_wapp_cnt = (uint32_t)tmp;\r\nelse if (dent == phba->debug_writeRef)\r\nphba->lpfc_injerr_wref_cnt = (uint32_t)tmp;\r\nelse if (dent == phba->debug_readGuard)\r\nphba->lpfc_injerr_rgrd_cnt = (uint32_t)tmp;\r\nelse if (dent == phba->debug_readApp)\r\nphba->lpfc_injerr_rapp_cnt = (uint32_t)tmp;\r\nelse if (dent == phba->debug_readRef)\r\nphba->lpfc_injerr_rref_cnt = (uint32_t)tmp;\r\nelse if (dent == phba->debug_InjErrLBA)\r\nphba->lpfc_injerr_lba = (sector_t)tmp;\r\nelse if (dent == phba->debug_InjErrNPortID)\r\nphba->lpfc_injerr_nportid = (uint32_t)(tmp & Mask_DID);\r\nelse if (dent == phba->debug_InjErrWWPN) {\r\ntmp = cpu_to_be64(tmp);\r\nmemcpy(&phba->lpfc_injerr_wwpn, &tmp, sizeof(struct lpfc_name));\r\n} else\r\nlpfc_printf_log(phba, KERN_ERR, LOG_INIT,\r\n"0548 Unknown debugfs error injection entry\n");\r\nreturn nbytes;\r\n}\r\nstatic int\r\nlpfc_debugfs_dif_err_release(struct inode *inode, struct file *file)\r\n{\r\nreturn 0;\r\n}\r\nstatic int\r\nlpfc_debugfs_nodelist_open(struct inode *inode, struct file *file)\r\n{\r\nstruct lpfc_vport *vport = inode->i_private;\r\nstruct lpfc_debug *debug;\r\nint rc = -ENOMEM;\r\ndebug = kmalloc(sizeof(*debug), GFP_KERNEL);\r\nif (!debug)\r\ngoto out;\r\ndebug->buffer = kmalloc(LPFC_NODELIST_SIZE, GFP_KERNEL);\r\nif (!debug->buffer) {\r\nkfree(debug);\r\ngoto out;\r\n}\r\ndebug->len = lpfc_debugfs_nodelist_data(vport, debug->buffer,\r\nLPFC_NODELIST_SIZE);\r\nfile->private_data = debug;\r\nrc = 0;\r\nout:\r\nreturn rc;\r\n}\r\nstatic loff_t\r\nlpfc_debugfs_lseek(struct file *file, loff_t off, int whence)\r\n{\r\nstruct lpfc_debug *debug;\r\nloff_t pos = -1;\r\ndebug = file->private_data;\r\nswitch (whence) {\r\ncase 0:\r\npos = off;\r\nbreak;\r\ncase 1:\r\npos = file->f_pos + off;\r\nbreak;\r\ncase 2:\r\npos = debug->len - off;\r\n}\r\nreturn (pos < 0 || pos > debug->len) ? -EINVAL : (file->f_pos = pos);\r\n}\r\nstatic ssize_t\r\nlpfc_debugfs_read(struct file *file, char __user *buf,\r\nsize_t nbytes, loff_t *ppos)\r\n{\r\nstruct lpfc_debug *debug = file->private_data;\r\nreturn simple_read_from_buffer(buf, nbytes, ppos, debug->buffer,\r\ndebug->len);\r\n}\r\nstatic int\r\nlpfc_debugfs_release(struct inode *inode, struct file *file)\r\n{\r\nstruct lpfc_debug *debug = file->private_data;\r\nkfree(debug->buffer);\r\nkfree(debug);\r\nreturn 0;\r\n}\r\nstatic int\r\nlpfc_debugfs_dumpDataDif_release(struct inode *inode, struct file *file)\r\n{\r\nstruct lpfc_debug *debug = file->private_data;\r\ndebug->buffer = NULL;\r\nkfree(debug);\r\nreturn 0;\r\n}\r\nstatic int lpfc_idiag_cmd_get(const char __user *buf, size_t nbytes,\r\nstruct lpfc_idiag_cmd *idiag_cmd)\r\n{\r\nchar mybuf[64];\r\nchar *pbuf, *step_str;\r\nint i;\r\nsize_t bsize;\r\nif (!access_ok(VERIFY_READ, buf, nbytes))\r\nreturn -EFAULT;\r\nmemset(mybuf, 0, sizeof(mybuf));\r\nmemset(idiag_cmd, 0, sizeof(*idiag_cmd));\r\nbsize = min(nbytes, (sizeof(mybuf)-1));\r\nif (copy_from_user(mybuf, buf, bsize))\r\nreturn -EFAULT;\r\npbuf = &mybuf[0];\r\nstep_str = strsep(&pbuf, "\t ");\r\nif (!step_str)\r\nreturn -EINVAL;\r\nidiag_cmd->opcode = simple_strtol(step_str, NULL, 0);\r\nif (idiag_cmd->opcode == 0)\r\nreturn -EINVAL;\r\nfor (i = 0; i < LPFC_IDIAG_CMD_DATA_SIZE; i++) {\r\nstep_str = strsep(&pbuf, "\t ");\r\nif (!step_str)\r\nreturn i;\r\nidiag_cmd->data[i] = simple_strtol(step_str, NULL, 0);\r\n}\r\nreturn i;\r\n}\r\nstatic int\r\nlpfc_idiag_open(struct inode *inode, struct file *file)\r\n{\r\nstruct lpfc_debug *debug;\r\ndebug = kmalloc(sizeof(*debug), GFP_KERNEL);\r\nif (!debug)\r\nreturn -ENOMEM;\r\ndebug->i_private = inode->i_private;\r\ndebug->buffer = NULL;\r\nfile->private_data = debug;\r\nreturn 0;\r\n}\r\nstatic int\r\nlpfc_idiag_release(struct inode *inode, struct file *file)\r\n{\r\nstruct lpfc_debug *debug = file->private_data;\r\nkfree(debug->buffer);\r\nkfree(debug);\r\nreturn 0;\r\n}\r\nstatic int\r\nlpfc_idiag_cmd_release(struct inode *inode, struct file *file)\r\n{\r\nstruct lpfc_debug *debug = file->private_data;\r\nif (debug->op == LPFC_IDIAG_OP_WR) {\r\nswitch (idiag.cmd.opcode) {\r\ncase LPFC_IDIAG_CMD_PCICFG_WR:\r\ncase LPFC_IDIAG_CMD_PCICFG_ST:\r\ncase LPFC_IDIAG_CMD_PCICFG_CL:\r\ncase LPFC_IDIAG_CMD_QUEACC_WR:\r\ncase LPFC_IDIAG_CMD_QUEACC_ST:\r\ncase LPFC_IDIAG_CMD_QUEACC_CL:\r\nmemset(&idiag, 0, sizeof(idiag));\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nkfree(debug->buffer);\r\nkfree(debug);\r\nreturn 0;\r\n}\r\nstatic ssize_t\r\nlpfc_idiag_pcicfg_read(struct file *file, char __user *buf, size_t nbytes,\r\nloff_t *ppos)\r\n{\r\nstruct lpfc_debug *debug = file->private_data;\r\nstruct lpfc_hba *phba = (struct lpfc_hba *)debug->i_private;\r\nint offset_label, offset, len = 0, index = LPFC_PCI_CFG_RD_SIZE;\r\nint where, count;\r\nchar *pbuffer;\r\nstruct pci_dev *pdev;\r\nuint32_t u32val;\r\nuint16_t u16val;\r\nuint8_t u8val;\r\npdev = phba->pcidev;\r\nif (!pdev)\r\nreturn 0;\r\ndebug->op = LPFC_IDIAG_OP_RD;\r\nif (!debug->buffer)\r\ndebug->buffer = kmalloc(LPFC_PCI_CFG_SIZE, GFP_KERNEL);\r\nif (!debug->buffer)\r\nreturn 0;\r\npbuffer = debug->buffer;\r\nif (*ppos)\r\nreturn 0;\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_PCICFG_RD) {\r\nwhere = idiag.cmd.data[IDIAG_PCICFG_WHERE_INDX];\r\ncount = idiag.cmd.data[IDIAG_PCICFG_COUNT_INDX];\r\n} else\r\nreturn 0;\r\nswitch (count) {\r\ncase SIZE_U8:\r\npci_read_config_byte(pdev, where, &u8val);\r\nlen += snprintf(pbuffer+len, LPFC_PCI_CFG_SIZE-len,\r\n"%03x: %02x\n", where, u8val);\r\nbreak;\r\ncase SIZE_U16:\r\npci_read_config_word(pdev, where, &u16val);\r\nlen += snprintf(pbuffer+len, LPFC_PCI_CFG_SIZE-len,\r\n"%03x: %04x\n", where, u16val);\r\nbreak;\r\ncase SIZE_U32:\r\npci_read_config_dword(pdev, where, &u32val);\r\nlen += snprintf(pbuffer+len, LPFC_PCI_CFG_SIZE-len,\r\n"%03x: %08x\n", where, u32val);\r\nbreak;\r\ncase LPFC_PCI_CFG_BROWSE:\r\ngoto pcicfg_browse;\r\nbreak;\r\ndefault:\r\nlen = 0;\r\nbreak;\r\n}\r\nreturn simple_read_from_buffer(buf, nbytes, ppos, pbuffer, len);\r\npcicfg_browse:\r\noffset_label = idiag.offset.last_rd;\r\noffset = offset_label;\r\nlen += snprintf(pbuffer+len, LPFC_PCI_CFG_SIZE-len,\r\n"%03x: ", offset_label);\r\nwhile (index > 0) {\r\npci_read_config_dword(pdev, offset, &u32val);\r\nlen += snprintf(pbuffer+len, LPFC_PCI_CFG_SIZE-len,\r\n"%08x ", u32val);\r\noffset += sizeof(uint32_t);\r\nif (offset >= LPFC_PCI_CFG_SIZE) {\r\nlen += snprintf(pbuffer+len,\r\nLPFC_PCI_CFG_SIZE-len, "\n");\r\nbreak;\r\n}\r\nindex -= sizeof(uint32_t);\r\nif (!index)\r\nlen += snprintf(pbuffer+len, LPFC_PCI_CFG_SIZE-len,\r\n"\n");\r\nelse if (!(index % (8 * sizeof(uint32_t)))) {\r\noffset_label += (8 * sizeof(uint32_t));\r\nlen += snprintf(pbuffer+len, LPFC_PCI_CFG_SIZE-len,\r\n"\n%03x: ", offset_label);\r\n}\r\n}\r\nif (index == 0) {\r\nidiag.offset.last_rd += LPFC_PCI_CFG_RD_SIZE;\r\nif (idiag.offset.last_rd >= LPFC_PCI_CFG_SIZE)\r\nidiag.offset.last_rd = 0;\r\n} else\r\nidiag.offset.last_rd = 0;\r\nreturn simple_read_from_buffer(buf, nbytes, ppos, pbuffer, len);\r\n}\r\nstatic ssize_t\r\nlpfc_idiag_pcicfg_write(struct file *file, const char __user *buf,\r\nsize_t nbytes, loff_t *ppos)\r\n{\r\nstruct lpfc_debug *debug = file->private_data;\r\nstruct lpfc_hba *phba = (struct lpfc_hba *)debug->i_private;\r\nuint32_t where, value, count;\r\nuint32_t u32val;\r\nuint16_t u16val;\r\nuint8_t u8val;\r\nstruct pci_dev *pdev;\r\nint rc;\r\npdev = phba->pcidev;\r\nif (!pdev)\r\nreturn -EFAULT;\r\ndebug->op = LPFC_IDIAG_OP_WR;\r\nrc = lpfc_idiag_cmd_get(buf, nbytes, &idiag.cmd);\r\nif (rc < 0)\r\nreturn rc;\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_PCICFG_RD) {\r\nif (rc != LPFC_PCI_CFG_RD_CMD_ARG)\r\ngoto error_out;\r\nwhere = idiag.cmd.data[IDIAG_PCICFG_WHERE_INDX];\r\ncount = idiag.cmd.data[IDIAG_PCICFG_COUNT_INDX];\r\nif (count == LPFC_PCI_CFG_BROWSE) {\r\nif (where % sizeof(uint32_t))\r\ngoto error_out;\r\nidiag.offset.last_rd = where;\r\n} else if ((count != sizeof(uint8_t)) &&\r\n(count != sizeof(uint16_t)) &&\r\n(count != sizeof(uint32_t)))\r\ngoto error_out;\r\nif (count == sizeof(uint8_t)) {\r\nif (where > LPFC_PCI_CFG_SIZE - sizeof(uint8_t))\r\ngoto error_out;\r\nif (where % sizeof(uint8_t))\r\ngoto error_out;\r\n}\r\nif (count == sizeof(uint16_t)) {\r\nif (where > LPFC_PCI_CFG_SIZE - sizeof(uint16_t))\r\ngoto error_out;\r\nif (where % sizeof(uint16_t))\r\ngoto error_out;\r\n}\r\nif (count == sizeof(uint32_t)) {\r\nif (where > LPFC_PCI_CFG_SIZE - sizeof(uint32_t))\r\ngoto error_out;\r\nif (where % sizeof(uint32_t))\r\ngoto error_out;\r\n}\r\n} else if (idiag.cmd.opcode == LPFC_IDIAG_CMD_PCICFG_WR ||\r\nidiag.cmd.opcode == LPFC_IDIAG_CMD_PCICFG_ST ||\r\nidiag.cmd.opcode == LPFC_IDIAG_CMD_PCICFG_CL) {\r\nif (rc != LPFC_PCI_CFG_WR_CMD_ARG)\r\ngoto error_out;\r\nwhere = idiag.cmd.data[IDIAG_PCICFG_WHERE_INDX];\r\ncount = idiag.cmd.data[IDIAG_PCICFG_COUNT_INDX];\r\nvalue = idiag.cmd.data[IDIAG_PCICFG_VALUE_INDX];\r\nif ((count != sizeof(uint8_t)) &&\r\n(count != sizeof(uint16_t)) &&\r\n(count != sizeof(uint32_t)))\r\ngoto error_out;\r\nif (count == sizeof(uint8_t)) {\r\nif (where > LPFC_PCI_CFG_SIZE - sizeof(uint8_t))\r\ngoto error_out;\r\nif (where % sizeof(uint8_t))\r\ngoto error_out;\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_PCICFG_WR)\r\npci_write_config_byte(pdev, where,\r\n(uint8_t)value);\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_PCICFG_ST) {\r\nrc = pci_read_config_byte(pdev, where, &u8val);\r\nif (!rc) {\r\nu8val |= (uint8_t)value;\r\npci_write_config_byte(pdev, where,\r\nu8val);\r\n}\r\n}\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_PCICFG_CL) {\r\nrc = pci_read_config_byte(pdev, where, &u8val);\r\nif (!rc) {\r\nu8val &= (uint8_t)(~value);\r\npci_write_config_byte(pdev, where,\r\nu8val);\r\n}\r\n}\r\n}\r\nif (count == sizeof(uint16_t)) {\r\nif (where > LPFC_PCI_CFG_SIZE - sizeof(uint16_t))\r\ngoto error_out;\r\nif (where % sizeof(uint16_t))\r\ngoto error_out;\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_PCICFG_WR)\r\npci_write_config_word(pdev, where,\r\n(uint16_t)value);\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_PCICFG_ST) {\r\nrc = pci_read_config_word(pdev, where, &u16val);\r\nif (!rc) {\r\nu16val |= (uint16_t)value;\r\npci_write_config_word(pdev, where,\r\nu16val);\r\n}\r\n}\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_PCICFG_CL) {\r\nrc = pci_read_config_word(pdev, where, &u16val);\r\nif (!rc) {\r\nu16val &= (uint16_t)(~value);\r\npci_write_config_word(pdev, where,\r\nu16val);\r\n}\r\n}\r\n}\r\nif (count == sizeof(uint32_t)) {\r\nif (where > LPFC_PCI_CFG_SIZE - sizeof(uint32_t))\r\ngoto error_out;\r\nif (where % sizeof(uint32_t))\r\ngoto error_out;\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_PCICFG_WR)\r\npci_write_config_dword(pdev, where, value);\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_PCICFG_ST) {\r\nrc = pci_read_config_dword(pdev, where,\r\n&u32val);\r\nif (!rc) {\r\nu32val |= value;\r\npci_write_config_dword(pdev, where,\r\nu32val);\r\n}\r\n}\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_PCICFG_CL) {\r\nrc = pci_read_config_dword(pdev, where,\r\n&u32val);\r\nif (!rc) {\r\nu32val &= ~value;\r\npci_write_config_dword(pdev, where,\r\nu32val);\r\n}\r\n}\r\n}\r\n} else\r\ngoto error_out;\r\nreturn nbytes;\r\nerror_out:\r\nmemset(&idiag, 0, sizeof(idiag));\r\nreturn -EINVAL;\r\n}\r\nstatic ssize_t\r\nlpfc_idiag_baracc_read(struct file *file, char __user *buf, size_t nbytes,\r\nloff_t *ppos)\r\n{\r\nstruct lpfc_debug *debug = file->private_data;\r\nstruct lpfc_hba *phba = (struct lpfc_hba *)debug->i_private;\r\nint offset_label, offset, offset_run, len = 0, index;\r\nint bar_num, acc_range, bar_size;\r\nchar *pbuffer;\r\nvoid __iomem *mem_mapped_bar;\r\nuint32_t if_type;\r\nstruct pci_dev *pdev;\r\nuint32_t u32val;\r\npdev = phba->pcidev;\r\nif (!pdev)\r\nreturn 0;\r\ndebug->op = LPFC_IDIAG_OP_RD;\r\nif (!debug->buffer)\r\ndebug->buffer = kmalloc(LPFC_PCI_BAR_RD_BUF_SIZE, GFP_KERNEL);\r\nif (!debug->buffer)\r\nreturn 0;\r\npbuffer = debug->buffer;\r\nif (*ppos)\r\nreturn 0;\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_BARACC_RD) {\r\nbar_num = idiag.cmd.data[IDIAG_BARACC_BAR_NUM_INDX];\r\noffset = idiag.cmd.data[IDIAG_BARACC_OFF_SET_INDX];\r\nacc_range = idiag.cmd.data[IDIAG_BARACC_ACC_MOD_INDX];\r\nbar_size = idiag.cmd.data[IDIAG_BARACC_BAR_SZE_INDX];\r\n} else\r\nreturn 0;\r\nif (acc_range == 0)\r\nreturn 0;\r\nif_type = bf_get(lpfc_sli_intf_if_type, &phba->sli4_hba.sli_intf);\r\nif (if_type == LPFC_SLI_INTF_IF_TYPE_0) {\r\nif (bar_num == IDIAG_BARACC_BAR_0)\r\nmem_mapped_bar = phba->sli4_hba.conf_regs_memmap_p;\r\nelse if (bar_num == IDIAG_BARACC_BAR_1)\r\nmem_mapped_bar = phba->sli4_hba.ctrl_regs_memmap_p;\r\nelse if (bar_num == IDIAG_BARACC_BAR_2)\r\nmem_mapped_bar = phba->sli4_hba.drbl_regs_memmap_p;\r\nelse\r\nreturn 0;\r\n} else if (if_type == LPFC_SLI_INTF_IF_TYPE_2) {\r\nif (bar_num == IDIAG_BARACC_BAR_0)\r\nmem_mapped_bar = phba->sli4_hba.conf_regs_memmap_p;\r\nelse\r\nreturn 0;\r\n} else\r\nreturn 0;\r\nif (acc_range == SINGLE_WORD) {\r\noffset_run = offset;\r\nu32val = readl(mem_mapped_bar + offset_run);\r\nlen += snprintf(pbuffer+len, LPFC_PCI_BAR_RD_BUF_SIZE-len,\r\n"%05x: %08x\n", offset_run, u32val);\r\n} else\r\ngoto baracc_browse;\r\nreturn simple_read_from_buffer(buf, nbytes, ppos, pbuffer, len);\r\nbaracc_browse:\r\noffset_label = idiag.offset.last_rd;\r\noffset_run = offset_label;\r\nlen += snprintf(pbuffer+len, LPFC_PCI_BAR_RD_BUF_SIZE-len,\r\n"%05x: ", offset_label);\r\nindex = LPFC_PCI_BAR_RD_SIZE;\r\nwhile (index > 0) {\r\nu32val = readl(mem_mapped_bar + offset_run);\r\nlen += snprintf(pbuffer+len, LPFC_PCI_BAR_RD_BUF_SIZE-len,\r\n"%08x ", u32val);\r\noffset_run += sizeof(uint32_t);\r\nif (acc_range == LPFC_PCI_BAR_BROWSE) {\r\nif (offset_run >= bar_size) {\r\nlen += snprintf(pbuffer+len,\r\nLPFC_PCI_BAR_RD_BUF_SIZE-len, "\n");\r\nbreak;\r\n}\r\n} else {\r\nif (offset_run >= offset +\r\n(acc_range * sizeof(uint32_t))) {\r\nlen += snprintf(pbuffer+len,\r\nLPFC_PCI_BAR_RD_BUF_SIZE-len, "\n");\r\nbreak;\r\n}\r\n}\r\nindex -= sizeof(uint32_t);\r\nif (!index)\r\nlen += snprintf(pbuffer+len,\r\nLPFC_PCI_BAR_RD_BUF_SIZE-len, "\n");\r\nelse if (!(index % (8 * sizeof(uint32_t)))) {\r\noffset_label += (8 * sizeof(uint32_t));\r\nlen += snprintf(pbuffer+len,\r\nLPFC_PCI_BAR_RD_BUF_SIZE-len,\r\n"\n%05x: ", offset_label);\r\n}\r\n}\r\nif (index == 0) {\r\nidiag.offset.last_rd += LPFC_PCI_BAR_RD_SIZE;\r\nif (acc_range == LPFC_PCI_BAR_BROWSE) {\r\nif (idiag.offset.last_rd >= bar_size)\r\nidiag.offset.last_rd = 0;\r\n} else {\r\nif (offset_run >= offset +\r\n(acc_range * sizeof(uint32_t)))\r\nidiag.offset.last_rd = offset;\r\n}\r\n} else {\r\nif (acc_range == LPFC_PCI_BAR_BROWSE)\r\nidiag.offset.last_rd = 0;\r\nelse\r\nidiag.offset.last_rd = offset;\r\n}\r\nreturn simple_read_from_buffer(buf, nbytes, ppos, pbuffer, len);\r\n}\r\nstatic ssize_t\r\nlpfc_idiag_baracc_write(struct file *file, const char __user *buf,\r\nsize_t nbytes, loff_t *ppos)\r\n{\r\nstruct lpfc_debug *debug = file->private_data;\r\nstruct lpfc_hba *phba = (struct lpfc_hba *)debug->i_private;\r\nuint32_t bar_num, bar_size, offset, value, acc_range;\r\nstruct pci_dev *pdev;\r\nvoid __iomem *mem_mapped_bar;\r\nuint32_t if_type;\r\nuint32_t u32val;\r\nint rc;\r\npdev = phba->pcidev;\r\nif (!pdev)\r\nreturn -EFAULT;\r\ndebug->op = LPFC_IDIAG_OP_WR;\r\nrc = lpfc_idiag_cmd_get(buf, nbytes, &idiag.cmd);\r\nif (rc < 0)\r\nreturn rc;\r\nif_type = bf_get(lpfc_sli_intf_if_type, &phba->sli4_hba.sli_intf);\r\nbar_num = idiag.cmd.data[IDIAG_BARACC_BAR_NUM_INDX];\r\nif (if_type == LPFC_SLI_INTF_IF_TYPE_0) {\r\nif ((bar_num != IDIAG_BARACC_BAR_0) &&\r\n(bar_num != IDIAG_BARACC_BAR_1) &&\r\n(bar_num != IDIAG_BARACC_BAR_2))\r\ngoto error_out;\r\n} else if (if_type == LPFC_SLI_INTF_IF_TYPE_2) {\r\nif (bar_num != IDIAG_BARACC_BAR_0)\r\ngoto error_out;\r\n} else\r\ngoto error_out;\r\nif (if_type == LPFC_SLI_INTF_IF_TYPE_0) {\r\nif (bar_num == IDIAG_BARACC_BAR_0) {\r\nidiag.cmd.data[IDIAG_BARACC_BAR_SZE_INDX] =\r\nLPFC_PCI_IF0_BAR0_SIZE;\r\nmem_mapped_bar = phba->sli4_hba.conf_regs_memmap_p;\r\n} else if (bar_num == IDIAG_BARACC_BAR_1) {\r\nidiag.cmd.data[IDIAG_BARACC_BAR_SZE_INDX] =\r\nLPFC_PCI_IF0_BAR1_SIZE;\r\nmem_mapped_bar = phba->sli4_hba.ctrl_regs_memmap_p;\r\n} else if (bar_num == IDIAG_BARACC_BAR_2) {\r\nidiag.cmd.data[IDIAG_BARACC_BAR_SZE_INDX] =\r\nLPFC_PCI_IF0_BAR2_SIZE;\r\nmem_mapped_bar = phba->sli4_hba.drbl_regs_memmap_p;\r\n} else\r\ngoto error_out;\r\n} else if (if_type == LPFC_SLI_INTF_IF_TYPE_2) {\r\nif (bar_num == IDIAG_BARACC_BAR_0) {\r\nidiag.cmd.data[IDIAG_BARACC_BAR_SZE_INDX] =\r\nLPFC_PCI_IF2_BAR0_SIZE;\r\nmem_mapped_bar = phba->sli4_hba.conf_regs_memmap_p;\r\n} else\r\ngoto error_out;\r\n} else\r\ngoto error_out;\r\noffset = idiag.cmd.data[IDIAG_BARACC_OFF_SET_INDX];\r\nif (offset % sizeof(uint32_t))\r\ngoto error_out;\r\nbar_size = idiag.cmd.data[IDIAG_BARACC_BAR_SZE_INDX];\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_BARACC_RD) {\r\nif (rc != LPFC_PCI_BAR_RD_CMD_ARG)\r\ngoto error_out;\r\nacc_range = idiag.cmd.data[IDIAG_BARACC_ACC_MOD_INDX];\r\nif (acc_range == LPFC_PCI_BAR_BROWSE) {\r\nif (offset > bar_size - sizeof(uint32_t))\r\ngoto error_out;\r\nidiag.offset.last_rd = offset;\r\n} else if (acc_range > SINGLE_WORD) {\r\nif (offset + acc_range * sizeof(uint32_t) > bar_size)\r\ngoto error_out;\r\nidiag.offset.last_rd = offset;\r\n} else if (acc_range != SINGLE_WORD)\r\ngoto error_out;\r\n} else if (idiag.cmd.opcode == LPFC_IDIAG_CMD_BARACC_WR ||\r\nidiag.cmd.opcode == LPFC_IDIAG_CMD_BARACC_ST ||\r\nidiag.cmd.opcode == LPFC_IDIAG_CMD_BARACC_CL) {\r\nif (rc != LPFC_PCI_BAR_WR_CMD_ARG)\r\ngoto error_out;\r\nacc_range = SINGLE_WORD;\r\nvalue = idiag.cmd.data[IDIAG_BARACC_REG_VAL_INDX];\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_BARACC_WR) {\r\nwritel(value, mem_mapped_bar + offset);\r\nreadl(mem_mapped_bar + offset);\r\n}\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_BARACC_ST) {\r\nu32val = readl(mem_mapped_bar + offset);\r\nu32val |= value;\r\nwritel(u32val, mem_mapped_bar + offset);\r\nreadl(mem_mapped_bar + offset);\r\n}\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_BARACC_CL) {\r\nu32val = readl(mem_mapped_bar + offset);\r\nu32val &= ~value;\r\nwritel(u32val, mem_mapped_bar + offset);\r\nreadl(mem_mapped_bar + offset);\r\n}\r\n} else\r\ngoto error_out;\r\nreturn nbytes;\r\nerror_out:\r\nmemset(&idiag, 0, sizeof(idiag));\r\nreturn -EINVAL;\r\n}\r\nstatic ssize_t\r\nlpfc_idiag_queinfo_read(struct file *file, char __user *buf, size_t nbytes,\r\nloff_t *ppos)\r\n{\r\nstruct lpfc_debug *debug = file->private_data;\r\nstruct lpfc_hba *phba = (struct lpfc_hba *)debug->i_private;\r\nint len = 0, fcp_qidx;\r\nchar *pbuffer;\r\nif (!debug->buffer)\r\ndebug->buffer = kmalloc(LPFC_QUE_INFO_GET_BUF_SIZE, GFP_KERNEL);\r\nif (!debug->buffer)\r\nreturn 0;\r\npbuffer = debug->buffer;\r\nif (*ppos)\r\nreturn 0;\r\nlen += snprintf(pbuffer+len, LPFC_QUE_INFO_GET_BUF_SIZE-len,\r\n"Slow-path EQ information:\n");\r\nif (phba->sli4_hba.sp_eq) {\r\nlen += snprintf(pbuffer+len, LPFC_QUE_INFO_GET_BUF_SIZE-len,\r\n"\tEQID[%02d], "\r\n"QE-COUNT[%04d], QE-SIZE[%04d], "\r\n"HOST-INDEX[%04d], PORT-INDEX[%04d]\n\n",\r\nphba->sli4_hba.sp_eq->queue_id,\r\nphba->sli4_hba.sp_eq->entry_count,\r\nphba->sli4_hba.sp_eq->entry_size,\r\nphba->sli4_hba.sp_eq->host_index,\r\nphba->sli4_hba.sp_eq->hba_index);\r\n}\r\nlen += snprintf(pbuffer+len, LPFC_QUE_INFO_GET_BUF_SIZE-len,\r\n"Fast-path EQ information:\n");\r\nif (phba->sli4_hba.fp_eq) {\r\nfor (fcp_qidx = 0; fcp_qidx < phba->cfg_fcp_eq_count;\r\nfcp_qidx++) {\r\nif (phba->sli4_hba.fp_eq[fcp_qidx]) {\r\nlen += snprintf(pbuffer+len,\r\nLPFC_QUE_INFO_GET_BUF_SIZE-len,\r\n"\tEQID[%02d], "\r\n"QE-COUNT[%04d], QE-SIZE[%04d], "\r\n"HOST-INDEX[%04d], PORT-INDEX[%04d]\n",\r\nphba->sli4_hba.fp_eq[fcp_qidx]->queue_id,\r\nphba->sli4_hba.fp_eq[fcp_qidx]->entry_count,\r\nphba->sli4_hba.fp_eq[fcp_qidx]->entry_size,\r\nphba->sli4_hba.fp_eq[fcp_qidx]->host_index,\r\nphba->sli4_hba.fp_eq[fcp_qidx]->hba_index);\r\n}\r\n}\r\n}\r\nlen += snprintf(pbuffer+len, LPFC_QUE_INFO_GET_BUF_SIZE-len, "\n");\r\nlen += snprintf(pbuffer+len, LPFC_QUE_INFO_GET_BUF_SIZE-len,\r\n"Slow-path MBX CQ information:\n");\r\nif (phba->sli4_hba.mbx_cq) {\r\nlen += snprintf(pbuffer+len, LPFC_QUE_INFO_GET_BUF_SIZE-len,\r\n"Associated EQID[%02d]:\n",\r\nphba->sli4_hba.mbx_cq->assoc_qid);\r\nlen += snprintf(pbuffer+len, LPFC_QUE_INFO_GET_BUF_SIZE-len,\r\n"\tCQID[%02d], "\r\n"QE-COUNT[%04d], QE-SIZE[%04d], "\r\n"HOST-INDEX[%04d], PORT-INDEX[%04d]\n\n",\r\nphba->sli4_hba.mbx_cq->queue_id,\r\nphba->sli4_hba.mbx_cq->entry_count,\r\nphba->sli4_hba.mbx_cq->entry_size,\r\nphba->sli4_hba.mbx_cq->host_index,\r\nphba->sli4_hba.mbx_cq->hba_index);\r\n}\r\nlen += snprintf(pbuffer+len, LPFC_QUE_INFO_GET_BUF_SIZE-len,\r\n"Slow-path ELS CQ information:\n");\r\nif (phba->sli4_hba.els_cq) {\r\nlen += snprintf(pbuffer+len, LPFC_QUE_INFO_GET_BUF_SIZE-len,\r\n"Associated EQID[%02d]:\n",\r\nphba->sli4_hba.els_cq->assoc_qid);\r\nlen += snprintf(pbuffer+len, LPFC_QUE_INFO_GET_BUF_SIZE-len,\r\n"\tCQID [%02d], "\r\n"QE-COUNT[%04d], QE-SIZE[%04d], "\r\n"HOST-INDEX[%04d], PORT-INDEX[%04d]\n\n",\r\nphba->sli4_hba.els_cq->queue_id,\r\nphba->sli4_hba.els_cq->entry_count,\r\nphba->sli4_hba.els_cq->entry_size,\r\nphba->sli4_hba.els_cq->host_index,\r\nphba->sli4_hba.els_cq->hba_index);\r\n}\r\nlen += snprintf(pbuffer+len, LPFC_QUE_INFO_GET_BUF_SIZE-len,\r\n"Fast-path FCP CQ information:\n");\r\nfcp_qidx = 0;\r\nif (phba->sli4_hba.fcp_cq) {\r\ndo {\r\nif (phba->sli4_hba.fcp_cq[fcp_qidx]) {\r\nlen += snprintf(pbuffer+len,\r\nLPFC_QUE_INFO_GET_BUF_SIZE-len,\r\n"Associated EQID[%02d]:\n",\r\nphba->sli4_hba.fcp_cq[fcp_qidx]->assoc_qid);\r\nlen += snprintf(pbuffer+len,\r\nLPFC_QUE_INFO_GET_BUF_SIZE-len,\r\n"\tCQID[%02d], "\r\n"QE-COUNT[%04d], QE-SIZE[%04d], "\r\n"HOST-INDEX[%04d], PORT-INDEX[%04d]\n",\r\nphba->sli4_hba.fcp_cq[fcp_qidx]->queue_id,\r\nphba->sli4_hba.fcp_cq[fcp_qidx]->entry_count,\r\nphba->sli4_hba.fcp_cq[fcp_qidx]->entry_size,\r\nphba->sli4_hba.fcp_cq[fcp_qidx]->host_index,\r\nphba->sli4_hba.fcp_cq[fcp_qidx]->hba_index);\r\n}\r\n} while (++fcp_qidx < phba->cfg_fcp_eq_count);\r\nlen += snprintf(pbuffer+len,\r\nLPFC_QUE_INFO_GET_BUF_SIZE-len, "\n");\r\n}\r\nlen += snprintf(pbuffer+len, LPFC_QUE_INFO_GET_BUF_SIZE-len,\r\n"Slow-path MBX MQ information:\n");\r\nif (phba->sli4_hba.mbx_wq) {\r\nlen += snprintf(pbuffer+len, LPFC_QUE_INFO_GET_BUF_SIZE-len,\r\n"Associated CQID[%02d]:\n",\r\nphba->sli4_hba.mbx_wq->assoc_qid);\r\nlen += snprintf(pbuffer+len, LPFC_QUE_INFO_GET_BUF_SIZE-len,\r\n"\tWQID[%02d], "\r\n"QE-COUNT[%04d], QE-SIZE[%04d], "\r\n"HOST-INDEX[%04d], PORT-INDEX[%04d]\n\n",\r\nphba->sli4_hba.mbx_wq->queue_id,\r\nphba->sli4_hba.mbx_wq->entry_count,\r\nphba->sli4_hba.mbx_wq->entry_size,\r\nphba->sli4_hba.mbx_wq->host_index,\r\nphba->sli4_hba.mbx_wq->hba_index);\r\n}\r\nlen += snprintf(pbuffer+len, LPFC_QUE_INFO_GET_BUF_SIZE-len,\r\n"Slow-path ELS WQ information:\n");\r\nif (phba->sli4_hba.els_wq) {\r\nlen += snprintf(pbuffer+len, LPFC_QUE_INFO_GET_BUF_SIZE-len,\r\n"Associated CQID[%02d]:\n",\r\nphba->sli4_hba.els_wq->assoc_qid);\r\nlen += snprintf(pbuffer+len, LPFC_QUE_INFO_GET_BUF_SIZE-len,\r\n"\tWQID[%02d], "\r\n"QE-COUNT[%04d], QE-SIZE[%04d], "\r\n"HOST-INDEX[%04d], PORT-INDEX[%04d]\n\n",\r\nphba->sli4_hba.els_wq->queue_id,\r\nphba->sli4_hba.els_wq->entry_count,\r\nphba->sli4_hba.els_wq->entry_size,\r\nphba->sli4_hba.els_wq->host_index,\r\nphba->sli4_hba.els_wq->hba_index);\r\n}\r\nlen += snprintf(pbuffer+len, LPFC_QUE_INFO_GET_BUF_SIZE-len,\r\n"Fast-path FCP WQ information:\n");\r\nif (phba->sli4_hba.fcp_wq) {\r\nfor (fcp_qidx = 0; fcp_qidx < phba->cfg_fcp_wq_count;\r\nfcp_qidx++) {\r\nif (!phba->sli4_hba.fcp_wq[fcp_qidx])\r\ncontinue;\r\nlen += snprintf(pbuffer+len,\r\nLPFC_QUE_INFO_GET_BUF_SIZE-len,\r\n"Associated CQID[%02d]:\n",\r\nphba->sli4_hba.fcp_wq[fcp_qidx]->assoc_qid);\r\nlen += snprintf(pbuffer+len,\r\nLPFC_QUE_INFO_GET_BUF_SIZE-len,\r\n"\tWQID[%02d], "\r\n"QE-COUNT[%04d], WQE-SIZE[%04d], "\r\n"HOST-INDEX[%04d], PORT-INDEX[%04d]\n",\r\nphba->sli4_hba.fcp_wq[fcp_qidx]->queue_id,\r\nphba->sli4_hba.fcp_wq[fcp_qidx]->entry_count,\r\nphba->sli4_hba.fcp_wq[fcp_qidx]->entry_size,\r\nphba->sli4_hba.fcp_wq[fcp_qidx]->host_index,\r\nphba->sli4_hba.fcp_wq[fcp_qidx]->hba_index);\r\n}\r\nlen += snprintf(pbuffer+len,\r\nLPFC_QUE_INFO_GET_BUF_SIZE-len, "\n");\r\n}\r\nlen += snprintf(pbuffer+len, LPFC_QUE_INFO_GET_BUF_SIZE-len,\r\n"Slow-path RQ information:\n");\r\nif (phba->sli4_hba.hdr_rq && phba->sli4_hba.dat_rq) {\r\nlen += snprintf(pbuffer+len, LPFC_QUE_INFO_GET_BUF_SIZE-len,\r\n"Associated CQID[%02d]:\n",\r\nphba->sli4_hba.hdr_rq->assoc_qid);\r\nlen += snprintf(pbuffer+len, LPFC_QUE_INFO_GET_BUF_SIZE-len,\r\n"\tHQID[%02d], "\r\n"QE-COUNT[%04d], QE-SIZE[%04d], "\r\n"HOST-INDEX[%04d], PORT-INDEX[%04d]\n",\r\nphba->sli4_hba.hdr_rq->queue_id,\r\nphba->sli4_hba.hdr_rq->entry_count,\r\nphba->sli4_hba.hdr_rq->entry_size,\r\nphba->sli4_hba.hdr_rq->host_index,\r\nphba->sli4_hba.hdr_rq->hba_index);\r\nlen += snprintf(pbuffer+len, LPFC_QUE_INFO_GET_BUF_SIZE-len,\r\n"\tDQID[%02d], "\r\n"QE-COUNT[%04d], QE-SIZE[%04d], "\r\n"HOST-INDEX[%04d], PORT-INDEX[%04d]\n",\r\nphba->sli4_hba.dat_rq->queue_id,\r\nphba->sli4_hba.dat_rq->entry_count,\r\nphba->sli4_hba.dat_rq->entry_size,\r\nphba->sli4_hba.dat_rq->host_index,\r\nphba->sli4_hba.dat_rq->hba_index);\r\n}\r\nreturn simple_read_from_buffer(buf, nbytes, ppos, pbuffer, len);\r\n}\r\nstatic int\r\nlpfc_idiag_que_param_check(struct lpfc_queue *q, int index, int count)\r\n{\r\nif ((count != 1) && (count != LPFC_QUE_ACC_BROWSE))\r\nreturn -EINVAL;\r\nif (index > q->entry_count - 1)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int\r\nlpfc_idiag_queacc_read_qe(char *pbuffer, int len, struct lpfc_queue *pque,\r\nuint32_t index)\r\n{\r\nint offset, esize;\r\nuint32_t *pentry;\r\nif (!pbuffer || !pque)\r\nreturn 0;\r\nesize = pque->entry_size;\r\nlen += snprintf(pbuffer+len, LPFC_QUE_ACC_BUF_SIZE-len,\r\n"QE-INDEX[%04d]:\n", index);\r\noffset = 0;\r\npentry = pque->qe[index].address;\r\nwhile (esize > 0) {\r\nlen += snprintf(pbuffer+len, LPFC_QUE_ACC_BUF_SIZE-len,\r\n"%08x ", *pentry);\r\npentry++;\r\noffset += sizeof(uint32_t);\r\nesize -= sizeof(uint32_t);\r\nif (esize > 0 && !(offset % (4 * sizeof(uint32_t))))\r\nlen += snprintf(pbuffer+len,\r\nLPFC_QUE_ACC_BUF_SIZE-len, "\n");\r\n}\r\nlen += snprintf(pbuffer+len, LPFC_QUE_ACC_BUF_SIZE-len, "\n");\r\nreturn len;\r\n}\r\nstatic ssize_t\r\nlpfc_idiag_queacc_read(struct file *file, char __user *buf, size_t nbytes,\r\nloff_t *ppos)\r\n{\r\nstruct lpfc_debug *debug = file->private_data;\r\nuint32_t last_index, index, count;\r\nstruct lpfc_queue *pque = NULL;\r\nchar *pbuffer;\r\nint len = 0;\r\ndebug->op = LPFC_IDIAG_OP_RD;\r\nif (!debug->buffer)\r\ndebug->buffer = kmalloc(LPFC_QUE_ACC_BUF_SIZE, GFP_KERNEL);\r\nif (!debug->buffer)\r\nreturn 0;\r\npbuffer = debug->buffer;\r\nif (*ppos)\r\nreturn 0;\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_QUEACC_RD) {\r\nindex = idiag.cmd.data[IDIAG_QUEACC_INDEX_INDX];\r\ncount = idiag.cmd.data[IDIAG_QUEACC_COUNT_INDX];\r\npque = (struct lpfc_queue *)idiag.ptr_private;\r\n} else\r\nreturn 0;\r\nif (count == LPFC_QUE_ACC_BROWSE)\r\ngoto que_browse;\r\nlen = lpfc_idiag_queacc_read_qe(pbuffer, len, pque, index);\r\nreturn simple_read_from_buffer(buf, nbytes, ppos, pbuffer, len);\r\nque_browse:\r\nlast_index = idiag.offset.last_rd;\r\nindex = last_index;\r\nwhile (len < LPFC_QUE_ACC_SIZE - pque->entry_size) {\r\nlen = lpfc_idiag_queacc_read_qe(pbuffer, len, pque, index);\r\nindex++;\r\nif (index > pque->entry_count - 1)\r\nbreak;\r\n}\r\nif (index > pque->entry_count - 1)\r\nindex = 0;\r\nidiag.offset.last_rd = index;\r\nreturn simple_read_from_buffer(buf, nbytes, ppos, pbuffer, len);\r\n}\r\nstatic ssize_t\r\nlpfc_idiag_queacc_write(struct file *file, const char __user *buf,\r\nsize_t nbytes, loff_t *ppos)\r\n{\r\nstruct lpfc_debug *debug = file->private_data;\r\nstruct lpfc_hba *phba = (struct lpfc_hba *)debug->i_private;\r\nuint32_t qidx, quetp, queid, index, count, offset, value;\r\nuint32_t *pentry;\r\nstruct lpfc_queue *pque;\r\nint rc;\r\ndebug->op = LPFC_IDIAG_OP_WR;\r\nrc = lpfc_idiag_cmd_get(buf, nbytes, &idiag.cmd);\r\nif (rc < 0)\r\nreturn rc;\r\nquetp = idiag.cmd.data[IDIAG_QUEACC_QUETP_INDX];\r\nqueid = idiag.cmd.data[IDIAG_QUEACC_QUEID_INDX];\r\nindex = idiag.cmd.data[IDIAG_QUEACC_INDEX_INDX];\r\ncount = idiag.cmd.data[IDIAG_QUEACC_COUNT_INDX];\r\noffset = idiag.cmd.data[IDIAG_QUEACC_OFFST_INDX];\r\nvalue = idiag.cmd.data[IDIAG_QUEACC_VALUE_INDX];\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_QUEACC_WR ||\r\nidiag.cmd.opcode == LPFC_IDIAG_CMD_QUEACC_ST ||\r\nidiag.cmd.opcode == LPFC_IDIAG_CMD_QUEACC_CL) {\r\nif (rc != LPFC_QUE_ACC_WR_CMD_ARG)\r\ngoto error_out;\r\nif (count != 1)\r\ngoto error_out;\r\n} else if (idiag.cmd.opcode == LPFC_IDIAG_CMD_QUEACC_RD) {\r\nif (rc != LPFC_QUE_ACC_RD_CMD_ARG)\r\ngoto error_out;\r\n} else\r\ngoto error_out;\r\nswitch (quetp) {\r\ncase LPFC_IDIAG_EQ:\r\nif (phba->sli4_hba.sp_eq &&\r\nphba->sli4_hba.sp_eq->queue_id == queid) {\r\nrc = lpfc_idiag_que_param_check(\r\nphba->sli4_hba.sp_eq, index, count);\r\nif (rc)\r\ngoto error_out;\r\nidiag.ptr_private = phba->sli4_hba.sp_eq;\r\ngoto pass_check;\r\n}\r\nif (phba->sli4_hba.fp_eq) {\r\nfor (qidx = 0; qidx < phba->cfg_fcp_eq_count; qidx++) {\r\nif (phba->sli4_hba.fp_eq[qidx] &&\r\nphba->sli4_hba.fp_eq[qidx]->queue_id ==\r\nqueid) {\r\nrc = lpfc_idiag_que_param_check(\r\nphba->sli4_hba.fp_eq[qidx],\r\nindex, count);\r\nif (rc)\r\ngoto error_out;\r\nidiag.ptr_private =\r\nphba->sli4_hba.fp_eq[qidx];\r\ngoto pass_check;\r\n}\r\n}\r\n}\r\ngoto error_out;\r\nbreak;\r\ncase LPFC_IDIAG_CQ:\r\nif (phba->sli4_hba.mbx_cq &&\r\nphba->sli4_hba.mbx_cq->queue_id == queid) {\r\nrc = lpfc_idiag_que_param_check(\r\nphba->sli4_hba.mbx_cq, index, count);\r\nif (rc)\r\ngoto error_out;\r\nidiag.ptr_private = phba->sli4_hba.mbx_cq;\r\ngoto pass_check;\r\n}\r\nif (phba->sli4_hba.els_cq &&\r\nphba->sli4_hba.els_cq->queue_id == queid) {\r\nrc = lpfc_idiag_que_param_check(\r\nphba->sli4_hba.els_cq, index, count);\r\nif (rc)\r\ngoto error_out;\r\nidiag.ptr_private = phba->sli4_hba.els_cq;\r\ngoto pass_check;\r\n}\r\nif (phba->sli4_hba.fcp_cq) {\r\nqidx = 0;\r\ndo {\r\nif (phba->sli4_hba.fcp_cq[qidx] &&\r\nphba->sli4_hba.fcp_cq[qidx]->queue_id ==\r\nqueid) {\r\nrc = lpfc_idiag_que_param_check(\r\nphba->sli4_hba.fcp_cq[qidx],\r\nindex, count);\r\nif (rc)\r\ngoto error_out;\r\nidiag.ptr_private =\r\nphba->sli4_hba.fcp_cq[qidx];\r\ngoto pass_check;\r\n}\r\n} while (++qidx < phba->cfg_fcp_eq_count);\r\n}\r\ngoto error_out;\r\nbreak;\r\ncase LPFC_IDIAG_MQ:\r\nif (phba->sli4_hba.mbx_wq &&\r\nphba->sli4_hba.mbx_wq->queue_id == queid) {\r\nrc = lpfc_idiag_que_param_check(\r\nphba->sli4_hba.mbx_wq, index, count);\r\nif (rc)\r\ngoto error_out;\r\nidiag.ptr_private = phba->sli4_hba.mbx_wq;\r\ngoto pass_check;\r\n}\r\ngoto error_out;\r\nbreak;\r\ncase LPFC_IDIAG_WQ:\r\nif (phba->sli4_hba.els_wq &&\r\nphba->sli4_hba.els_wq->queue_id == queid) {\r\nrc = lpfc_idiag_que_param_check(\r\nphba->sli4_hba.els_wq, index, count);\r\nif (rc)\r\ngoto error_out;\r\nidiag.ptr_private = phba->sli4_hba.els_wq;\r\ngoto pass_check;\r\n}\r\nif (phba->sli4_hba.fcp_wq) {\r\nfor (qidx = 0; qidx < phba->cfg_fcp_wq_count; qidx++) {\r\nif (!phba->sli4_hba.fcp_wq[qidx])\r\ncontinue;\r\nif (phba->sli4_hba.fcp_wq[qidx]->queue_id ==\r\nqueid) {\r\nrc = lpfc_idiag_que_param_check(\r\nphba->sli4_hba.fcp_wq[qidx],\r\nindex, count);\r\nif (rc)\r\ngoto error_out;\r\nidiag.ptr_private =\r\nphba->sli4_hba.fcp_wq[qidx];\r\ngoto pass_check;\r\n}\r\n}\r\n}\r\ngoto error_out;\r\nbreak;\r\ncase LPFC_IDIAG_RQ:\r\nif (phba->sli4_hba.hdr_rq &&\r\nphba->sli4_hba.hdr_rq->queue_id == queid) {\r\nrc = lpfc_idiag_que_param_check(\r\nphba->sli4_hba.hdr_rq, index, count);\r\nif (rc)\r\ngoto error_out;\r\nidiag.ptr_private = phba->sli4_hba.hdr_rq;\r\ngoto pass_check;\r\n}\r\nif (phba->sli4_hba.dat_rq &&\r\nphba->sli4_hba.dat_rq->queue_id == queid) {\r\nrc = lpfc_idiag_que_param_check(\r\nphba->sli4_hba.dat_rq, index, count);\r\nif (rc)\r\ngoto error_out;\r\nidiag.ptr_private = phba->sli4_hba.dat_rq;\r\ngoto pass_check;\r\n}\r\ngoto error_out;\r\nbreak;\r\ndefault:\r\ngoto error_out;\r\nbreak;\r\n}\r\npass_check:\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_QUEACC_RD) {\r\nif (count == LPFC_QUE_ACC_BROWSE)\r\nidiag.offset.last_rd = index;\r\n}\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_QUEACC_WR ||\r\nidiag.cmd.opcode == LPFC_IDIAG_CMD_QUEACC_ST ||\r\nidiag.cmd.opcode == LPFC_IDIAG_CMD_QUEACC_CL) {\r\npque = (struct lpfc_queue *)idiag.ptr_private;\r\nif (offset > pque->entry_size/sizeof(uint32_t) - 1)\r\ngoto error_out;\r\npentry = pque->qe[index].address;\r\npentry += offset;\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_QUEACC_WR)\r\n*pentry = value;\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_QUEACC_ST)\r\n*pentry |= value;\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_QUEACC_CL)\r\n*pentry &= ~value;\r\n}\r\nreturn nbytes;\r\nerror_out:\r\nmemset(&idiag, 0, sizeof(idiag));\r\nreturn -EINVAL;\r\n}\r\nstatic int\r\nlpfc_idiag_drbacc_read_reg(struct lpfc_hba *phba, char *pbuffer,\r\nint len, uint32_t drbregid)\r\n{\r\nif (!pbuffer)\r\nreturn 0;\r\nswitch (drbregid) {\r\ncase LPFC_DRB_EQCQ:\r\nlen += snprintf(pbuffer+len, LPFC_DRB_ACC_BUF_SIZE-len,\r\n"EQCQ-DRB-REG: 0x%08x\n",\r\nreadl(phba->sli4_hba.EQCQDBregaddr));\r\nbreak;\r\ncase LPFC_DRB_MQ:\r\nlen += snprintf(pbuffer+len, LPFC_DRB_ACC_BUF_SIZE-len,\r\n"MQ-DRB-REG: 0x%08x\n",\r\nreadl(phba->sli4_hba.MQDBregaddr));\r\nbreak;\r\ncase LPFC_DRB_WQ:\r\nlen += snprintf(pbuffer+len, LPFC_DRB_ACC_BUF_SIZE-len,\r\n"WQ-DRB-REG: 0x%08x\n",\r\nreadl(phba->sli4_hba.WQDBregaddr));\r\nbreak;\r\ncase LPFC_DRB_RQ:\r\nlen += snprintf(pbuffer+len, LPFC_DRB_ACC_BUF_SIZE-len,\r\n"RQ-DRB-REG: 0x%08x\n",\r\nreadl(phba->sli4_hba.RQDBregaddr));\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn len;\r\n}\r\nstatic ssize_t\r\nlpfc_idiag_drbacc_read(struct file *file, char __user *buf, size_t nbytes,\r\nloff_t *ppos)\r\n{\r\nstruct lpfc_debug *debug = file->private_data;\r\nstruct lpfc_hba *phba = (struct lpfc_hba *)debug->i_private;\r\nuint32_t drb_reg_id, i;\r\nchar *pbuffer;\r\nint len = 0;\r\ndebug->op = LPFC_IDIAG_OP_RD;\r\nif (!debug->buffer)\r\ndebug->buffer = kmalloc(LPFC_DRB_ACC_BUF_SIZE, GFP_KERNEL);\r\nif (!debug->buffer)\r\nreturn 0;\r\npbuffer = debug->buffer;\r\nif (*ppos)\r\nreturn 0;\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_DRBACC_RD)\r\ndrb_reg_id = idiag.cmd.data[IDIAG_DRBACC_REGID_INDX];\r\nelse\r\nreturn 0;\r\nif (drb_reg_id == LPFC_DRB_ACC_ALL)\r\nfor (i = 1; i <= LPFC_DRB_MAX; i++)\r\nlen = lpfc_idiag_drbacc_read_reg(phba,\r\npbuffer, len, i);\r\nelse\r\nlen = lpfc_idiag_drbacc_read_reg(phba,\r\npbuffer, len, drb_reg_id);\r\nreturn simple_read_from_buffer(buf, nbytes, ppos, pbuffer, len);\r\n}\r\nstatic ssize_t\r\nlpfc_idiag_drbacc_write(struct file *file, const char __user *buf,\r\nsize_t nbytes, loff_t *ppos)\r\n{\r\nstruct lpfc_debug *debug = file->private_data;\r\nstruct lpfc_hba *phba = (struct lpfc_hba *)debug->i_private;\r\nuint32_t drb_reg_id, value, reg_val = 0;\r\nvoid __iomem *drb_reg;\r\nint rc;\r\ndebug->op = LPFC_IDIAG_OP_WR;\r\nrc = lpfc_idiag_cmd_get(buf, nbytes, &idiag.cmd);\r\nif (rc < 0)\r\nreturn rc;\r\ndrb_reg_id = idiag.cmd.data[IDIAG_DRBACC_REGID_INDX];\r\nvalue = idiag.cmd.data[IDIAG_DRBACC_VALUE_INDX];\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_DRBACC_WR ||\r\nidiag.cmd.opcode == LPFC_IDIAG_CMD_DRBACC_ST ||\r\nidiag.cmd.opcode == LPFC_IDIAG_CMD_DRBACC_CL) {\r\nif (rc != LPFC_DRB_ACC_WR_CMD_ARG)\r\ngoto error_out;\r\nif (drb_reg_id > LPFC_DRB_MAX)\r\ngoto error_out;\r\n} else if (idiag.cmd.opcode == LPFC_IDIAG_CMD_DRBACC_RD) {\r\nif (rc != LPFC_DRB_ACC_RD_CMD_ARG)\r\ngoto error_out;\r\nif ((drb_reg_id > LPFC_DRB_MAX) &&\r\n(drb_reg_id != LPFC_DRB_ACC_ALL))\r\ngoto error_out;\r\n} else\r\ngoto error_out;\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_DRBACC_WR ||\r\nidiag.cmd.opcode == LPFC_IDIAG_CMD_DRBACC_ST ||\r\nidiag.cmd.opcode == LPFC_IDIAG_CMD_DRBACC_CL) {\r\nswitch (drb_reg_id) {\r\ncase LPFC_DRB_EQCQ:\r\ndrb_reg = phba->sli4_hba.EQCQDBregaddr;\r\nbreak;\r\ncase LPFC_DRB_MQ:\r\ndrb_reg = phba->sli4_hba.MQDBregaddr;\r\nbreak;\r\ncase LPFC_DRB_WQ:\r\ndrb_reg = phba->sli4_hba.WQDBregaddr;\r\nbreak;\r\ncase LPFC_DRB_RQ:\r\ndrb_reg = phba->sli4_hba.RQDBregaddr;\r\nbreak;\r\ndefault:\r\ngoto error_out;\r\n}\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_DRBACC_WR)\r\nreg_val = value;\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_DRBACC_ST) {\r\nreg_val = readl(drb_reg);\r\nreg_val |= value;\r\n}\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_DRBACC_CL) {\r\nreg_val = readl(drb_reg);\r\nreg_val &= ~value;\r\n}\r\nwritel(reg_val, drb_reg);\r\nreadl(drb_reg);\r\n}\r\nreturn nbytes;\r\nerror_out:\r\nmemset(&idiag, 0, sizeof(idiag));\r\nreturn -EINVAL;\r\n}\r\nstatic int\r\nlpfc_idiag_ctlacc_read_reg(struct lpfc_hba *phba, char *pbuffer,\r\nint len, uint32_t ctlregid)\r\n{\r\nif (!pbuffer)\r\nreturn 0;\r\nswitch (ctlregid) {\r\ncase LPFC_CTL_PORT_SEM:\r\nlen += snprintf(pbuffer+len, LPFC_CTL_ACC_BUF_SIZE-len,\r\n"Port SemReg: 0x%08x\n",\r\nreadl(phba->sli4_hba.conf_regs_memmap_p +\r\nLPFC_CTL_PORT_SEM_OFFSET));\r\nbreak;\r\ncase LPFC_CTL_PORT_STA:\r\nlen += snprintf(pbuffer+len, LPFC_CTL_ACC_BUF_SIZE-len,\r\n"Port StaReg: 0x%08x\n",\r\nreadl(phba->sli4_hba.conf_regs_memmap_p +\r\nLPFC_CTL_PORT_STA_OFFSET));\r\nbreak;\r\ncase LPFC_CTL_PORT_CTL:\r\nlen += snprintf(pbuffer+len, LPFC_CTL_ACC_BUF_SIZE-len,\r\n"Port CtlReg: 0x%08x\n",\r\nreadl(phba->sli4_hba.conf_regs_memmap_p +\r\nLPFC_CTL_PORT_CTL_OFFSET));\r\nbreak;\r\ncase LPFC_CTL_PORT_ER1:\r\nlen += snprintf(pbuffer+len, LPFC_CTL_ACC_BUF_SIZE-len,\r\n"Port Er1Reg: 0x%08x\n",\r\nreadl(phba->sli4_hba.conf_regs_memmap_p +\r\nLPFC_CTL_PORT_ER1_OFFSET));\r\nbreak;\r\ncase LPFC_CTL_PORT_ER2:\r\nlen += snprintf(pbuffer+len, LPFC_CTL_ACC_BUF_SIZE-len,\r\n"Port Er2Reg: 0x%08x\n",\r\nreadl(phba->sli4_hba.conf_regs_memmap_p +\r\nLPFC_CTL_PORT_ER2_OFFSET));\r\nbreak;\r\ncase LPFC_CTL_PDEV_CTL:\r\nlen += snprintf(pbuffer+len, LPFC_CTL_ACC_BUF_SIZE-len,\r\n"PDev CtlReg: 0x%08x\n",\r\nreadl(phba->sli4_hba.conf_regs_memmap_p +\r\nLPFC_CTL_PDEV_CTL_OFFSET));\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn len;\r\n}\r\nstatic ssize_t\r\nlpfc_idiag_ctlacc_read(struct file *file, char __user *buf, size_t nbytes,\r\nloff_t *ppos)\r\n{\r\nstruct lpfc_debug *debug = file->private_data;\r\nstruct lpfc_hba *phba = (struct lpfc_hba *)debug->i_private;\r\nuint32_t ctl_reg_id, i;\r\nchar *pbuffer;\r\nint len = 0;\r\ndebug->op = LPFC_IDIAG_OP_RD;\r\nif (!debug->buffer)\r\ndebug->buffer = kmalloc(LPFC_CTL_ACC_BUF_SIZE, GFP_KERNEL);\r\nif (!debug->buffer)\r\nreturn 0;\r\npbuffer = debug->buffer;\r\nif (*ppos)\r\nreturn 0;\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_CTLACC_RD)\r\nctl_reg_id = idiag.cmd.data[IDIAG_CTLACC_REGID_INDX];\r\nelse\r\nreturn 0;\r\nif (ctl_reg_id == LPFC_CTL_ACC_ALL)\r\nfor (i = 1; i <= LPFC_CTL_MAX; i++)\r\nlen = lpfc_idiag_ctlacc_read_reg(phba,\r\npbuffer, len, i);\r\nelse\r\nlen = lpfc_idiag_ctlacc_read_reg(phba,\r\npbuffer, len, ctl_reg_id);\r\nreturn simple_read_from_buffer(buf, nbytes, ppos, pbuffer, len);\r\n}\r\nstatic ssize_t\r\nlpfc_idiag_ctlacc_write(struct file *file, const char __user *buf,\r\nsize_t nbytes, loff_t *ppos)\r\n{\r\nstruct lpfc_debug *debug = file->private_data;\r\nstruct lpfc_hba *phba = (struct lpfc_hba *)debug->i_private;\r\nuint32_t ctl_reg_id, value, reg_val = 0;\r\nvoid __iomem *ctl_reg;\r\nint rc;\r\ndebug->op = LPFC_IDIAG_OP_WR;\r\nrc = lpfc_idiag_cmd_get(buf, nbytes, &idiag.cmd);\r\nif (rc < 0)\r\nreturn rc;\r\nctl_reg_id = idiag.cmd.data[IDIAG_CTLACC_REGID_INDX];\r\nvalue = idiag.cmd.data[IDIAG_CTLACC_VALUE_INDX];\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_CTLACC_WR ||\r\nidiag.cmd.opcode == LPFC_IDIAG_CMD_CTLACC_ST ||\r\nidiag.cmd.opcode == LPFC_IDIAG_CMD_CTLACC_CL) {\r\nif (rc != LPFC_CTL_ACC_WR_CMD_ARG)\r\ngoto error_out;\r\nif (ctl_reg_id > LPFC_CTL_MAX)\r\ngoto error_out;\r\n} else if (idiag.cmd.opcode == LPFC_IDIAG_CMD_CTLACC_RD) {\r\nif (rc != LPFC_CTL_ACC_RD_CMD_ARG)\r\ngoto error_out;\r\nif ((ctl_reg_id > LPFC_CTL_MAX) &&\r\n(ctl_reg_id != LPFC_CTL_ACC_ALL))\r\ngoto error_out;\r\n} else\r\ngoto error_out;\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_CTLACC_WR ||\r\nidiag.cmd.opcode == LPFC_IDIAG_CMD_CTLACC_ST ||\r\nidiag.cmd.opcode == LPFC_IDIAG_CMD_CTLACC_CL) {\r\nswitch (ctl_reg_id) {\r\ncase LPFC_CTL_PORT_SEM:\r\nctl_reg = phba->sli4_hba.conf_regs_memmap_p +\r\nLPFC_CTL_PORT_SEM_OFFSET;\r\nbreak;\r\ncase LPFC_CTL_PORT_STA:\r\nctl_reg = phba->sli4_hba.conf_regs_memmap_p +\r\nLPFC_CTL_PORT_STA_OFFSET;\r\nbreak;\r\ncase LPFC_CTL_PORT_CTL:\r\nctl_reg = phba->sli4_hba.conf_regs_memmap_p +\r\nLPFC_CTL_PORT_CTL_OFFSET;\r\nbreak;\r\ncase LPFC_CTL_PORT_ER1:\r\nctl_reg = phba->sli4_hba.conf_regs_memmap_p +\r\nLPFC_CTL_PORT_ER1_OFFSET;\r\nbreak;\r\ncase LPFC_CTL_PORT_ER2:\r\nctl_reg = phba->sli4_hba.conf_regs_memmap_p +\r\nLPFC_CTL_PORT_ER2_OFFSET;\r\nbreak;\r\ncase LPFC_CTL_PDEV_CTL:\r\nctl_reg = phba->sli4_hba.conf_regs_memmap_p +\r\nLPFC_CTL_PDEV_CTL_OFFSET;\r\nbreak;\r\ndefault:\r\ngoto error_out;\r\n}\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_CTLACC_WR)\r\nreg_val = value;\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_CTLACC_ST) {\r\nreg_val = readl(ctl_reg);\r\nreg_val |= value;\r\n}\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_CTLACC_CL) {\r\nreg_val = readl(ctl_reg);\r\nreg_val &= ~value;\r\n}\r\nwritel(reg_val, ctl_reg);\r\nreadl(ctl_reg);\r\n}\r\nreturn nbytes;\r\nerror_out:\r\nmemset(&idiag, 0, sizeof(idiag));\r\nreturn -EINVAL;\r\n}\r\nstatic int\r\nlpfc_idiag_mbxacc_get_setup(struct lpfc_hba *phba, char *pbuffer)\r\n{\r\nuint32_t mbx_dump_map, mbx_dump_cnt, mbx_word_cnt, mbx_mbox_cmd;\r\nint len = 0;\r\nmbx_mbox_cmd = idiag.cmd.data[IDIAG_MBXACC_MBCMD_INDX];\r\nmbx_dump_map = idiag.cmd.data[IDIAG_MBXACC_DPMAP_INDX];\r\nmbx_dump_cnt = idiag.cmd.data[IDIAG_MBXACC_DPCNT_INDX];\r\nmbx_word_cnt = idiag.cmd.data[IDIAG_MBXACC_WDCNT_INDX];\r\nlen += snprintf(pbuffer+len, LPFC_MBX_ACC_BUF_SIZE-len,\r\n"mbx_dump_map: 0x%08x\n", mbx_dump_map);\r\nlen += snprintf(pbuffer+len, LPFC_MBX_ACC_BUF_SIZE-len,\r\n"mbx_dump_cnt: %04d\n", mbx_dump_cnt);\r\nlen += snprintf(pbuffer+len, LPFC_MBX_ACC_BUF_SIZE-len,\r\n"mbx_word_cnt: %04d\n", mbx_word_cnt);\r\nlen += snprintf(pbuffer+len, LPFC_MBX_ACC_BUF_SIZE-len,\r\n"mbx_mbox_cmd: 0x%02x\n", mbx_mbox_cmd);\r\nreturn len;\r\n}\r\nstatic ssize_t\r\nlpfc_idiag_mbxacc_read(struct file *file, char __user *buf, size_t nbytes,\r\nloff_t *ppos)\r\n{\r\nstruct lpfc_debug *debug = file->private_data;\r\nstruct lpfc_hba *phba = (struct lpfc_hba *)debug->i_private;\r\nchar *pbuffer;\r\nint len = 0;\r\ndebug->op = LPFC_IDIAG_OP_RD;\r\nif (!debug->buffer)\r\ndebug->buffer = kmalloc(LPFC_MBX_ACC_BUF_SIZE, GFP_KERNEL);\r\nif (!debug->buffer)\r\nreturn 0;\r\npbuffer = debug->buffer;\r\nif (*ppos)\r\nreturn 0;\r\nif ((idiag.cmd.opcode != LPFC_IDIAG_CMD_MBXACC_DP) &&\r\n(idiag.cmd.opcode != LPFC_IDIAG_BSG_MBXACC_DP))\r\nreturn 0;\r\nlen = lpfc_idiag_mbxacc_get_setup(phba, pbuffer);\r\nreturn simple_read_from_buffer(buf, nbytes, ppos, pbuffer, len);\r\n}\r\nstatic ssize_t\r\nlpfc_idiag_mbxacc_write(struct file *file, const char __user *buf,\r\nsize_t nbytes, loff_t *ppos)\r\n{\r\nstruct lpfc_debug *debug = file->private_data;\r\nuint32_t mbx_dump_map, mbx_dump_cnt, mbx_word_cnt, mbx_mbox_cmd;\r\nint rc;\r\ndebug->op = LPFC_IDIAG_OP_WR;\r\nrc = lpfc_idiag_cmd_get(buf, nbytes, &idiag.cmd);\r\nif (rc < 0)\r\nreturn rc;\r\nmbx_mbox_cmd = idiag.cmd.data[IDIAG_MBXACC_MBCMD_INDX];\r\nmbx_dump_map = idiag.cmd.data[IDIAG_MBXACC_DPMAP_INDX];\r\nmbx_dump_cnt = idiag.cmd.data[IDIAG_MBXACC_DPCNT_INDX];\r\nmbx_word_cnt = idiag.cmd.data[IDIAG_MBXACC_WDCNT_INDX];\r\nif (idiag.cmd.opcode == LPFC_IDIAG_CMD_MBXACC_DP) {\r\nif (!(mbx_dump_map & LPFC_MBX_DMP_MBX_ALL))\r\ngoto error_out;\r\nif ((mbx_dump_map & ~LPFC_MBX_DMP_MBX_ALL) &&\r\n(mbx_dump_map != LPFC_MBX_DMP_ALL))\r\ngoto error_out;\r\nif (mbx_word_cnt > sizeof(MAILBOX_t))\r\ngoto error_out;\r\n} else if (idiag.cmd.opcode == LPFC_IDIAG_BSG_MBXACC_DP) {\r\nif (!(mbx_dump_map & LPFC_BSG_DMP_MBX_ALL))\r\ngoto error_out;\r\nif ((mbx_dump_map & ~LPFC_BSG_DMP_MBX_ALL) &&\r\n(mbx_dump_map != LPFC_MBX_DMP_ALL))\r\ngoto error_out;\r\nif (mbx_word_cnt > (BSG_MBOX_SIZE)/4)\r\ngoto error_out;\r\nif (mbx_mbox_cmd != 0x9b)\r\ngoto error_out;\r\n} else\r\ngoto error_out;\r\nif (mbx_word_cnt == 0)\r\ngoto error_out;\r\nif (rc != LPFC_MBX_DMP_ARG)\r\ngoto error_out;\r\nif (mbx_mbox_cmd & ~0xff)\r\ngoto error_out;\r\nif (mbx_dump_cnt == 0)\r\ngoto reset_out;\r\nreturn nbytes;\r\nreset_out:\r\nmemset(&idiag, 0, sizeof(idiag));\r\nreturn nbytes;\r\nerror_out:\r\nmemset(&idiag, 0, sizeof(idiag));\r\nreturn -EINVAL;\r\n}\r\nstatic int\r\nlpfc_idiag_extacc_avail_get(struct lpfc_hba *phba, char *pbuffer, int len)\r\n{\r\nuint16_t ext_cnt, ext_size;\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"\nAvailable Extents Information:\n");\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"\tPort Available VPI extents: ");\r\nlpfc_sli4_get_avail_extnt_rsrc(phba, LPFC_RSC_TYPE_FCOE_VPI,\r\n&ext_cnt, &ext_size);\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"Count %3d, Size %3d\n", ext_cnt, ext_size);\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"\tPort Available VFI extents: ");\r\nlpfc_sli4_get_avail_extnt_rsrc(phba, LPFC_RSC_TYPE_FCOE_VFI,\r\n&ext_cnt, &ext_size);\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"Count %3d, Size %3d\n", ext_cnt, ext_size);\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"\tPort Available RPI extents: ");\r\nlpfc_sli4_get_avail_extnt_rsrc(phba, LPFC_RSC_TYPE_FCOE_RPI,\r\n&ext_cnt, &ext_size);\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"Count %3d, Size %3d\n", ext_cnt, ext_size);\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"\tPort Available XRI extents: ");\r\nlpfc_sli4_get_avail_extnt_rsrc(phba, LPFC_RSC_TYPE_FCOE_XRI,\r\n&ext_cnt, &ext_size);\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"Count %3d, Size %3d\n", ext_cnt, ext_size);\r\nreturn len;\r\n}\r\nstatic int\r\nlpfc_idiag_extacc_alloc_get(struct lpfc_hba *phba, char *pbuffer, int len)\r\n{\r\nuint16_t ext_cnt, ext_size;\r\nint rc;\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"\nAllocated Extents Information:\n");\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"\tHost Allocated VPI extents: ");\r\nrc = lpfc_sli4_get_allocated_extnts(phba, LPFC_RSC_TYPE_FCOE_VPI,\r\n&ext_cnt, &ext_size);\r\nif (!rc)\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"Port %d Extent %3d, Size %3d\n",\r\nphba->brd_no, ext_cnt, ext_size);\r\nelse\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"N/A\n");\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"\tHost Allocated VFI extents: ");\r\nrc = lpfc_sli4_get_allocated_extnts(phba, LPFC_RSC_TYPE_FCOE_VFI,\r\n&ext_cnt, &ext_size);\r\nif (!rc)\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"Port %d Extent %3d, Size %3d\n",\r\nphba->brd_no, ext_cnt, ext_size);\r\nelse\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"N/A\n");\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"\tHost Allocated RPI extents: ");\r\nrc = lpfc_sli4_get_allocated_extnts(phba, LPFC_RSC_TYPE_FCOE_RPI,\r\n&ext_cnt, &ext_size);\r\nif (!rc)\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"Port %d Extent %3d, Size %3d\n",\r\nphba->brd_no, ext_cnt, ext_size);\r\nelse\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"N/A\n");\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"\tHost Allocated XRI extents: ");\r\nrc = lpfc_sli4_get_allocated_extnts(phba, LPFC_RSC_TYPE_FCOE_XRI,\r\n&ext_cnt, &ext_size);\r\nif (!rc)\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"Port %d Extent %3d, Size %3d\n",\r\nphba->brd_no, ext_cnt, ext_size);\r\nelse\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"N/A\n");\r\nreturn len;\r\n}\r\nstatic int\r\nlpfc_idiag_extacc_drivr_get(struct lpfc_hba *phba, char *pbuffer, int len)\r\n{\r\nstruct lpfc_rsrc_blks *rsrc_blks;\r\nint index;\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"\nDriver Extents Information:\n");\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"\tVPI extents:\n");\r\nindex = 0;\r\nlist_for_each_entry(rsrc_blks, &phba->lpfc_vpi_blk_list, list) {\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"\t\tBlock %3d: Start %4d, Count %4d\n",\r\nindex, rsrc_blks->rsrc_start,\r\nrsrc_blks->rsrc_size);\r\nindex++;\r\n}\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"\tVFI extents:\n");\r\nindex = 0;\r\nlist_for_each_entry(rsrc_blks, &phba->sli4_hba.lpfc_vfi_blk_list,\r\nlist) {\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"\t\tBlock %3d: Start %4d, Count %4d\n",\r\nindex, rsrc_blks->rsrc_start,\r\nrsrc_blks->rsrc_size);\r\nindex++;\r\n}\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"\tRPI extents:\n");\r\nindex = 0;\r\nlist_for_each_entry(rsrc_blks, &phba->sli4_hba.lpfc_rpi_blk_list,\r\nlist) {\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"\t\tBlock %3d: Start %4d, Count %4d\n",\r\nindex, rsrc_blks->rsrc_start,\r\nrsrc_blks->rsrc_size);\r\nindex++;\r\n}\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"\tXRI extents:\n");\r\nindex = 0;\r\nlist_for_each_entry(rsrc_blks, &phba->sli4_hba.lpfc_xri_blk_list,\r\nlist) {\r\nlen += snprintf(pbuffer+len, LPFC_EXT_ACC_BUF_SIZE-len,\r\n"\t\tBlock %3d: Start %4d, Count %4d\n",\r\nindex, rsrc_blks->rsrc_start,\r\nrsrc_blks->rsrc_size);\r\nindex++;\r\n}\r\nreturn len;\r\n}\r\nstatic ssize_t\r\nlpfc_idiag_extacc_write(struct file *file, const char __user *buf,\r\nsize_t nbytes, loff_t *ppos)\r\n{\r\nstruct lpfc_debug *debug = file->private_data;\r\nuint32_t ext_map;\r\nint rc;\r\ndebug->op = LPFC_IDIAG_OP_WR;\r\nrc = lpfc_idiag_cmd_get(buf, nbytes, &idiag.cmd);\r\nif (rc < 0)\r\nreturn rc;\r\next_map = idiag.cmd.data[IDIAG_EXTACC_EXMAP_INDX];\r\nif (idiag.cmd.opcode != LPFC_IDIAG_CMD_EXTACC_RD)\r\ngoto error_out;\r\nif (rc != LPFC_EXT_ACC_CMD_ARG)\r\ngoto error_out;\r\nif (!(ext_map & LPFC_EXT_ACC_ALL))\r\ngoto error_out;\r\nreturn nbytes;\r\nerror_out:\r\nmemset(&idiag, 0, sizeof(idiag));\r\nreturn -EINVAL;\r\n}\r\nstatic ssize_t\r\nlpfc_idiag_extacc_read(struct file *file, char __user *buf, size_t nbytes,\r\nloff_t *ppos)\r\n{\r\nstruct lpfc_debug *debug = file->private_data;\r\nstruct lpfc_hba *phba = (struct lpfc_hba *)debug->i_private;\r\nchar *pbuffer;\r\nuint32_t ext_map;\r\nint len = 0;\r\ndebug->op = LPFC_IDIAG_OP_RD;\r\nif (!debug->buffer)\r\ndebug->buffer = kmalloc(LPFC_EXT_ACC_BUF_SIZE, GFP_KERNEL);\r\nif (!debug->buffer)\r\nreturn 0;\r\npbuffer = debug->buffer;\r\nif (*ppos)\r\nreturn 0;\r\nif (idiag.cmd.opcode != LPFC_IDIAG_CMD_EXTACC_RD)\r\nreturn 0;\r\next_map = idiag.cmd.data[IDIAG_EXTACC_EXMAP_INDX];\r\nif (ext_map & LPFC_EXT_ACC_AVAIL)\r\nlen = lpfc_idiag_extacc_avail_get(phba, pbuffer, len);\r\nif (ext_map & LPFC_EXT_ACC_ALLOC)\r\nlen = lpfc_idiag_extacc_alloc_get(phba, pbuffer, len);\r\nif (ext_map & LPFC_EXT_ACC_DRIVR)\r\nlen = lpfc_idiag_extacc_drivr_get(phba, pbuffer, len);\r\nreturn simple_read_from_buffer(buf, nbytes, ppos, pbuffer, len);\r\n}\r\nvoid\r\nlpfc_idiag_mbxacc_dump_bsg_mbox(struct lpfc_hba *phba, enum nemb_type nemb_tp,\r\nenum mbox_type mbox_tp, enum dma_type dma_tp,\r\nenum sta_type sta_tp,\r\nstruct lpfc_dmabuf *dmabuf, uint32_t ext_buf)\r\n{\r\n#ifdef CONFIG_SCSI_LPFC_DEBUG_FS\r\nuint32_t *mbx_mbox_cmd, *mbx_dump_map, *mbx_dump_cnt, *mbx_word_cnt;\r\nchar line_buf[LPFC_MBX_ACC_LBUF_SZ];\r\nint len = 0;\r\nuint32_t do_dump = 0;\r\nuint32_t *pword;\r\nuint32_t i;\r\nif (idiag.cmd.opcode != LPFC_IDIAG_BSG_MBXACC_DP)\r\nreturn;\r\nmbx_mbox_cmd = &idiag.cmd.data[IDIAG_MBXACC_MBCMD_INDX];\r\nmbx_dump_map = &idiag.cmd.data[IDIAG_MBXACC_DPMAP_INDX];\r\nmbx_dump_cnt = &idiag.cmd.data[IDIAG_MBXACC_DPCNT_INDX];\r\nmbx_word_cnt = &idiag.cmd.data[IDIAG_MBXACC_WDCNT_INDX];\r\nif (!(*mbx_dump_map & LPFC_MBX_DMP_ALL) ||\r\n(*mbx_dump_cnt == 0) ||\r\n(*mbx_word_cnt == 0))\r\nreturn;\r\nif (*mbx_mbox_cmd != 0x9B)\r\nreturn;\r\nif ((mbox_tp == mbox_rd) && (dma_tp == dma_mbox)) {\r\nif (*mbx_dump_map & LPFC_BSG_DMP_MBX_RD_MBX) {\r\ndo_dump |= LPFC_BSG_DMP_MBX_RD_MBX;\r\nprintk(KERN_ERR "\nRead mbox command (x%x), "\r\n"nemb:0x%x, extbuf_cnt:%d:\n",\r\nsta_tp, nemb_tp, ext_buf);\r\n}\r\n}\r\nif ((mbox_tp == mbox_rd) && (dma_tp == dma_ebuf)) {\r\nif (*mbx_dump_map & LPFC_BSG_DMP_MBX_RD_BUF) {\r\ndo_dump |= LPFC_BSG_DMP_MBX_RD_BUF;\r\nprintk(KERN_ERR "\nRead mbox buffer (x%x), "\r\n"nemb:0x%x, extbuf_seq:%d:\n",\r\nsta_tp, nemb_tp, ext_buf);\r\n}\r\n}\r\nif ((mbox_tp == mbox_wr) && (dma_tp == dma_mbox)) {\r\nif (*mbx_dump_map & LPFC_BSG_DMP_MBX_WR_MBX) {\r\ndo_dump |= LPFC_BSG_DMP_MBX_WR_MBX;\r\nprintk(KERN_ERR "\nWrite mbox command (x%x), "\r\n"nemb:0x%x, extbuf_cnt:%d:\n",\r\nsta_tp, nemb_tp, ext_buf);\r\n}\r\n}\r\nif ((mbox_tp == mbox_wr) && (dma_tp == dma_ebuf)) {\r\nif (*mbx_dump_map & LPFC_BSG_DMP_MBX_WR_BUF) {\r\ndo_dump |= LPFC_BSG_DMP_MBX_WR_BUF;\r\nprintk(KERN_ERR "\nWrite mbox buffer (x%x), "\r\n"nemb:0x%x, extbuf_seq:%d:\n",\r\nsta_tp, nemb_tp, ext_buf);\r\n}\r\n}\r\nif (do_dump) {\r\npword = (uint32_t *)dmabuf->virt;\r\nfor (i = 0; i < *mbx_word_cnt; i++) {\r\nif (!(i % 8)) {\r\nif (i != 0)\r\nprintk(KERN_ERR "%s\n", line_buf);\r\nlen = 0;\r\nlen += snprintf(line_buf+len,\r\nLPFC_MBX_ACC_LBUF_SZ-len,\r\n"%03d: ", i);\r\n}\r\nlen += snprintf(line_buf+len, LPFC_MBX_ACC_LBUF_SZ-len,\r\n"%08x ", (uint32_t)*pword);\r\npword++;\r\n}\r\nif ((i - 1) % 8)\r\nprintk(KERN_ERR "%s\n", line_buf);\r\n(*mbx_dump_cnt)--;\r\n}\r\nif (*mbx_dump_cnt == 0)\r\nmemset(&idiag, 0, sizeof(idiag));\r\nreturn;\r\n#endif\r\n}\r\nvoid\r\nlpfc_idiag_mbxacc_dump_issue_mbox(struct lpfc_hba *phba, MAILBOX_t *pmbox)\r\n{\r\n#ifdef CONFIG_SCSI_LPFC_DEBUG_FS\r\nuint32_t *mbx_dump_map, *mbx_dump_cnt, *mbx_word_cnt, *mbx_mbox_cmd;\r\nchar line_buf[LPFC_MBX_ACC_LBUF_SZ];\r\nint len = 0;\r\nuint32_t *pword;\r\nuint8_t *pbyte;\r\nuint32_t i, j;\r\nif (idiag.cmd.opcode != LPFC_IDIAG_CMD_MBXACC_DP)\r\nreturn;\r\nmbx_mbox_cmd = &idiag.cmd.data[IDIAG_MBXACC_MBCMD_INDX];\r\nmbx_dump_map = &idiag.cmd.data[IDIAG_MBXACC_DPMAP_INDX];\r\nmbx_dump_cnt = &idiag.cmd.data[IDIAG_MBXACC_DPCNT_INDX];\r\nmbx_word_cnt = &idiag.cmd.data[IDIAG_MBXACC_WDCNT_INDX];\r\nif (!(*mbx_dump_map & LPFC_MBX_DMP_MBX_ALL) ||\r\n(*mbx_dump_cnt == 0) ||\r\n(*mbx_word_cnt == 0))\r\nreturn;\r\nif ((*mbx_mbox_cmd != LPFC_MBX_ALL_CMD) &&\r\n(*mbx_mbox_cmd != pmbox->mbxCommand))\r\nreturn;\r\nif (*mbx_dump_map & LPFC_MBX_DMP_MBX_WORD) {\r\nprintk(KERN_ERR "Mailbox command:0x%x dump by word:\n",\r\npmbox->mbxCommand);\r\npword = (uint32_t *)pmbox;\r\nfor (i = 0; i < *mbx_word_cnt; i++) {\r\nif (!(i % 8)) {\r\nif (i != 0)\r\nprintk(KERN_ERR "%s\n", line_buf);\r\nlen = 0;\r\nmemset(line_buf, 0, LPFC_MBX_ACC_LBUF_SZ);\r\nlen += snprintf(line_buf+len,\r\nLPFC_MBX_ACC_LBUF_SZ-len,\r\n"%03d: ", i);\r\n}\r\nlen += snprintf(line_buf+len, LPFC_MBX_ACC_LBUF_SZ-len,\r\n"%08x ",\r\n((uint32_t)*pword) & 0xffffffff);\r\npword++;\r\n}\r\nif ((i - 1) % 8)\r\nprintk(KERN_ERR "%s\n", line_buf);\r\nprintk(KERN_ERR "\n");\r\n}\r\nif (*mbx_dump_map & LPFC_MBX_DMP_MBX_BYTE) {\r\nprintk(KERN_ERR "Mailbox command:0x%x dump by byte:\n",\r\npmbox->mbxCommand);\r\npbyte = (uint8_t *)pmbox;\r\nfor (i = 0; i < *mbx_word_cnt; i++) {\r\nif (!(i % 8)) {\r\nif (i != 0)\r\nprintk(KERN_ERR "%s\n", line_buf);\r\nlen = 0;\r\nmemset(line_buf, 0, LPFC_MBX_ACC_LBUF_SZ);\r\nlen += snprintf(line_buf+len,\r\nLPFC_MBX_ACC_LBUF_SZ-len,\r\n"%03d: ", i);\r\n}\r\nfor (j = 0; j < 4; j++) {\r\nlen += snprintf(line_buf+len,\r\nLPFC_MBX_ACC_LBUF_SZ-len,\r\n"%02x",\r\n((uint8_t)*pbyte) & 0xff);\r\npbyte++;\r\n}\r\nlen += snprintf(line_buf+len,\r\nLPFC_MBX_ACC_LBUF_SZ-len, " ");\r\n}\r\nif ((i - 1) % 8)\r\nprintk(KERN_ERR "%s\n", line_buf);\r\nprintk(KERN_ERR "\n");\r\n}\r\n(*mbx_dump_cnt)--;\r\nif (*mbx_dump_cnt == 0)\r\nmemset(&idiag, 0, sizeof(idiag));\r\nreturn;\r\n#endif\r\n}\r\ninline void\r\nlpfc_debugfs_initialize(struct lpfc_vport *vport)\r\n{\r\n#ifdef CONFIG_SCSI_LPFC_DEBUG_FS\r\nstruct lpfc_hba *phba = vport->phba;\r\nchar name[64];\r\nuint32_t num, i;\r\nif (!lpfc_debugfs_enable)\r\nreturn;\r\nif (!lpfc_debugfs_root) {\r\nlpfc_debugfs_root = debugfs_create_dir("lpfc", NULL);\r\natomic_set(&lpfc_debugfs_hba_count, 0);\r\nif (!lpfc_debugfs_root) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"0408 Cannot create debugfs root\n");\r\ngoto debug_failed;\r\n}\r\n}\r\nif (!lpfc_debugfs_start_time)\r\nlpfc_debugfs_start_time = jiffies;\r\nsnprintf(name, sizeof(name), "fn%d", phba->brd_no);\r\nif (!phba->hba_debugfs_root) {\r\nphba->hba_debugfs_root =\r\ndebugfs_create_dir(name, lpfc_debugfs_root);\r\nif (!phba->hba_debugfs_root) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"0412 Cannot create debugfs hba\n");\r\ngoto debug_failed;\r\n}\r\natomic_inc(&lpfc_debugfs_hba_count);\r\natomic_set(&phba->debugfs_vport_count, 0);\r\nsnprintf(name, sizeof(name), "hbqinfo");\r\nphba->debug_hbqinfo =\r\ndebugfs_create_file(name, S_IFREG|S_IRUGO|S_IWUSR,\r\nphba->hba_debugfs_root,\r\nphba, &lpfc_debugfs_op_hbqinfo);\r\nif (!phba->debug_hbqinfo) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"0411 Cannot create debugfs hbqinfo\n");\r\ngoto debug_failed;\r\n}\r\nif (phba->sli_rev < LPFC_SLI_REV4) {\r\nsnprintf(name, sizeof(name), "dumpHBASlim");\r\nphba->debug_dumpHBASlim =\r\ndebugfs_create_file(name,\r\nS_IFREG|S_IRUGO|S_IWUSR,\r\nphba->hba_debugfs_root,\r\nphba, &lpfc_debugfs_op_dumpHBASlim);\r\nif (!phba->debug_dumpHBASlim) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"0413 Cannot create debugfs "\r\n"dumpHBASlim\n");\r\ngoto debug_failed;\r\n}\r\n} else\r\nphba->debug_dumpHBASlim = NULL;\r\nif (phba->sli_rev < LPFC_SLI_REV4) {\r\nsnprintf(name, sizeof(name), "dumpHostSlim");\r\nphba->debug_dumpHostSlim =\r\ndebugfs_create_file(name,\r\nS_IFREG|S_IRUGO|S_IWUSR,\r\nphba->hba_debugfs_root,\r\nphba, &lpfc_debugfs_op_dumpHostSlim);\r\nif (!phba->debug_dumpHostSlim) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"0414 Cannot create debugfs "\r\n"dumpHostSlim\n");\r\ngoto debug_failed;\r\n}\r\n} else\r\nphba->debug_dumpHBASlim = NULL;\r\nsnprintf(name, sizeof(name), "dumpData");\r\nphba->debug_dumpData =\r\ndebugfs_create_file(name, S_IFREG|S_IRUGO|S_IWUSR,\r\nphba->hba_debugfs_root,\r\nphba, &lpfc_debugfs_op_dumpData);\r\nif (!phba->debug_dumpData) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"0800 Cannot create debugfs dumpData\n");\r\ngoto debug_failed;\r\n}\r\nsnprintf(name, sizeof(name), "dumpDif");\r\nphba->debug_dumpDif =\r\ndebugfs_create_file(name, S_IFREG|S_IRUGO|S_IWUSR,\r\nphba->hba_debugfs_root,\r\nphba, &lpfc_debugfs_op_dumpDif);\r\nif (!phba->debug_dumpDif) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"0801 Cannot create debugfs dumpDif\n");\r\ngoto debug_failed;\r\n}\r\nsnprintf(name, sizeof(name), "InjErrLBA");\r\nphba->debug_InjErrLBA =\r\ndebugfs_create_file(name, S_IFREG|S_IRUGO|S_IWUSR,\r\nphba->hba_debugfs_root,\r\nphba, &lpfc_debugfs_op_dif_err);\r\nif (!phba->debug_InjErrLBA) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"0807 Cannot create debugfs InjErrLBA\n");\r\ngoto debug_failed;\r\n}\r\nphba->lpfc_injerr_lba = LPFC_INJERR_LBA_OFF;\r\nsnprintf(name, sizeof(name), "InjErrNPortID");\r\nphba->debug_InjErrNPortID =\r\ndebugfs_create_file(name, S_IFREG|S_IRUGO|S_IWUSR,\r\nphba->hba_debugfs_root,\r\nphba, &lpfc_debugfs_op_dif_err);\r\nif (!phba->debug_InjErrNPortID) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"0809 Cannot create debugfs InjErrNPortID\n");\r\ngoto debug_failed;\r\n}\r\nsnprintf(name, sizeof(name), "InjErrWWPN");\r\nphba->debug_InjErrWWPN =\r\ndebugfs_create_file(name, S_IFREG|S_IRUGO|S_IWUSR,\r\nphba->hba_debugfs_root,\r\nphba, &lpfc_debugfs_op_dif_err);\r\nif (!phba->debug_InjErrWWPN) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"0810 Cannot create debugfs InjErrWWPN\n");\r\ngoto debug_failed;\r\n}\r\nsnprintf(name, sizeof(name), "writeGuardInjErr");\r\nphba->debug_writeGuard =\r\ndebugfs_create_file(name, S_IFREG|S_IRUGO|S_IWUSR,\r\nphba->hba_debugfs_root,\r\nphba, &lpfc_debugfs_op_dif_err);\r\nif (!phba->debug_writeGuard) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"0802 Cannot create debugfs writeGuard\n");\r\ngoto debug_failed;\r\n}\r\nsnprintf(name, sizeof(name), "writeAppInjErr");\r\nphba->debug_writeApp =\r\ndebugfs_create_file(name, S_IFREG|S_IRUGO|S_IWUSR,\r\nphba->hba_debugfs_root,\r\nphba, &lpfc_debugfs_op_dif_err);\r\nif (!phba->debug_writeApp) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"0803 Cannot create debugfs writeApp\n");\r\ngoto debug_failed;\r\n}\r\nsnprintf(name, sizeof(name), "writeRefInjErr");\r\nphba->debug_writeRef =\r\ndebugfs_create_file(name, S_IFREG|S_IRUGO|S_IWUSR,\r\nphba->hba_debugfs_root,\r\nphba, &lpfc_debugfs_op_dif_err);\r\nif (!phba->debug_writeRef) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"0804 Cannot create debugfs writeRef\n");\r\ngoto debug_failed;\r\n}\r\nsnprintf(name, sizeof(name), "readGuardInjErr");\r\nphba->debug_readGuard =\r\ndebugfs_create_file(name, S_IFREG|S_IRUGO|S_IWUSR,\r\nphba->hba_debugfs_root,\r\nphba, &lpfc_debugfs_op_dif_err);\r\nif (!phba->debug_readGuard) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"0808 Cannot create debugfs readGuard\n");\r\ngoto debug_failed;\r\n}\r\nsnprintf(name, sizeof(name), "readAppInjErr");\r\nphba->debug_readApp =\r\ndebugfs_create_file(name, S_IFREG|S_IRUGO|S_IWUSR,\r\nphba->hba_debugfs_root,\r\nphba, &lpfc_debugfs_op_dif_err);\r\nif (!phba->debug_readApp) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"0805 Cannot create debugfs readApp\n");\r\ngoto debug_failed;\r\n}\r\nsnprintf(name, sizeof(name), "readRefInjErr");\r\nphba->debug_readRef =\r\ndebugfs_create_file(name, S_IFREG|S_IRUGO|S_IWUSR,\r\nphba->hba_debugfs_root,\r\nphba, &lpfc_debugfs_op_dif_err);\r\nif (!phba->debug_readRef) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"0806 Cannot create debugfs readApp\n");\r\ngoto debug_failed;\r\n}\r\nif (lpfc_debugfs_max_slow_ring_trc) {\r\nnum = lpfc_debugfs_max_slow_ring_trc - 1;\r\nif (num & lpfc_debugfs_max_slow_ring_trc) {\r\nnum = lpfc_debugfs_max_slow_ring_trc;\r\ni = 0;\r\nwhile (num > 1) {\r\nnum = num >> 1;\r\ni++;\r\n}\r\nlpfc_debugfs_max_slow_ring_trc = (1 << i);\r\nprintk(KERN_ERR\r\n"lpfc_debugfs_max_disc_trc changed to "\r\n"%d\n", lpfc_debugfs_max_disc_trc);\r\n}\r\n}\r\nsnprintf(name, sizeof(name), "slow_ring_trace");\r\nphba->debug_slow_ring_trc =\r\ndebugfs_create_file(name, S_IFREG|S_IRUGO|S_IWUSR,\r\nphba->hba_debugfs_root,\r\nphba, &lpfc_debugfs_op_slow_ring_trc);\r\nif (!phba->debug_slow_ring_trc) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"0415 Cannot create debugfs "\r\n"slow_ring_trace\n");\r\ngoto debug_failed;\r\n}\r\nif (!phba->slow_ring_trc) {\r\nphba->slow_ring_trc = kmalloc(\r\n(sizeof(struct lpfc_debugfs_trc) *\r\nlpfc_debugfs_max_slow_ring_trc),\r\nGFP_KERNEL);\r\nif (!phba->slow_ring_trc) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"0416 Cannot create debugfs "\r\n"slow_ring buffer\n");\r\ngoto debug_failed;\r\n}\r\natomic_set(&phba->slow_ring_trc_cnt, 0);\r\nmemset(phba->slow_ring_trc, 0,\r\n(sizeof(struct lpfc_debugfs_trc) *\r\nlpfc_debugfs_max_slow_ring_trc));\r\n}\r\n}\r\nsnprintf(name, sizeof(name), "vport%d", vport->vpi);\r\nif (!vport->vport_debugfs_root) {\r\nvport->vport_debugfs_root =\r\ndebugfs_create_dir(name, phba->hba_debugfs_root);\r\nif (!vport->vport_debugfs_root) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"0417 Can't create debugfs\n");\r\ngoto debug_failed;\r\n}\r\natomic_inc(&phba->debugfs_vport_count);\r\n}\r\nif (lpfc_debugfs_max_disc_trc) {\r\nnum = lpfc_debugfs_max_disc_trc - 1;\r\nif (num & lpfc_debugfs_max_disc_trc) {\r\nnum = lpfc_debugfs_max_disc_trc;\r\ni = 0;\r\nwhile (num > 1) {\r\nnum = num >> 1;\r\ni++;\r\n}\r\nlpfc_debugfs_max_disc_trc = (1 << i);\r\nprintk(KERN_ERR\r\n"lpfc_debugfs_max_disc_trc changed to %d\n",\r\nlpfc_debugfs_max_disc_trc);\r\n}\r\n}\r\nvport->disc_trc = kzalloc(\r\n(sizeof(struct lpfc_debugfs_trc) * lpfc_debugfs_max_disc_trc),\r\nGFP_KERNEL);\r\nif (!vport->disc_trc) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"0418 Cannot create debugfs disc trace "\r\n"buffer\n");\r\ngoto debug_failed;\r\n}\r\natomic_set(&vport->disc_trc_cnt, 0);\r\nsnprintf(name, sizeof(name), "discovery_trace");\r\nvport->debug_disc_trc =\r\ndebugfs_create_file(name, S_IFREG|S_IRUGO|S_IWUSR,\r\nvport->vport_debugfs_root,\r\nvport, &lpfc_debugfs_op_disc_trc);\r\nif (!vport->debug_disc_trc) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"0419 Cannot create debugfs "\r\n"discovery_trace\n");\r\ngoto debug_failed;\r\n}\r\nsnprintf(name, sizeof(name), "nodelist");\r\nvport->debug_nodelist =\r\ndebugfs_create_file(name, S_IFREG|S_IRUGO|S_IWUSR,\r\nvport->vport_debugfs_root,\r\nvport, &lpfc_debugfs_op_nodelist);\r\nif (!vport->debug_nodelist) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"2985 Can't create debugfs nodelist\n");\r\ngoto debug_failed;\r\n}\r\nif (phba->sli_rev < LPFC_SLI_REV4)\r\ngoto debug_failed;\r\nsnprintf(name, sizeof(name), "iDiag");\r\nif (!phba->idiag_root) {\r\nphba->idiag_root =\r\ndebugfs_create_dir(name, phba->hba_debugfs_root);\r\nif (!phba->idiag_root) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"2922 Can't create idiag debugfs\n");\r\ngoto debug_failed;\r\n}\r\nmemset(&idiag, 0, sizeof(idiag));\r\n}\r\nsnprintf(name, sizeof(name), "pciCfg");\r\nif (!phba->idiag_pci_cfg) {\r\nphba->idiag_pci_cfg =\r\ndebugfs_create_file(name, S_IFREG|S_IRUGO|S_IWUSR,\r\nphba->idiag_root, phba, &lpfc_idiag_op_pciCfg);\r\nif (!phba->idiag_pci_cfg) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"2923 Can't create idiag debugfs\n");\r\ngoto debug_failed;\r\n}\r\nidiag.offset.last_rd = 0;\r\n}\r\nsnprintf(name, sizeof(name), "barAcc");\r\nif (!phba->idiag_bar_acc) {\r\nphba->idiag_bar_acc =\r\ndebugfs_create_file(name, S_IFREG|S_IRUGO|S_IWUSR,\r\nphba->idiag_root, phba, &lpfc_idiag_op_barAcc);\r\nif (!phba->idiag_bar_acc) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"3056 Can't create idiag debugfs\n");\r\ngoto debug_failed;\r\n}\r\nidiag.offset.last_rd = 0;\r\n}\r\nsnprintf(name, sizeof(name), "queInfo");\r\nif (!phba->idiag_que_info) {\r\nphba->idiag_que_info =\r\ndebugfs_create_file(name, S_IFREG|S_IRUGO,\r\nphba->idiag_root, phba, &lpfc_idiag_op_queInfo);\r\nif (!phba->idiag_que_info) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"2924 Can't create idiag debugfs\n");\r\ngoto debug_failed;\r\n}\r\n}\r\nsnprintf(name, sizeof(name), "queAcc");\r\nif (!phba->idiag_que_acc) {\r\nphba->idiag_que_acc =\r\ndebugfs_create_file(name, S_IFREG|S_IRUGO|S_IWUSR,\r\nphba->idiag_root, phba, &lpfc_idiag_op_queAcc);\r\nif (!phba->idiag_que_acc) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"2926 Can't create idiag debugfs\n");\r\ngoto debug_failed;\r\n}\r\n}\r\nsnprintf(name, sizeof(name), "drbAcc");\r\nif (!phba->idiag_drb_acc) {\r\nphba->idiag_drb_acc =\r\ndebugfs_create_file(name, S_IFREG|S_IRUGO|S_IWUSR,\r\nphba->idiag_root, phba, &lpfc_idiag_op_drbAcc);\r\nif (!phba->idiag_drb_acc) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"2927 Can't create idiag debugfs\n");\r\ngoto debug_failed;\r\n}\r\n}\r\nsnprintf(name, sizeof(name), "ctlAcc");\r\nif (!phba->idiag_ctl_acc) {\r\nphba->idiag_ctl_acc =\r\ndebugfs_create_file(name, S_IFREG|S_IRUGO|S_IWUSR,\r\nphba->idiag_root, phba, &lpfc_idiag_op_ctlAcc);\r\nif (!phba->idiag_ctl_acc) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"2981 Can't create idiag debugfs\n");\r\ngoto debug_failed;\r\n}\r\n}\r\nsnprintf(name, sizeof(name), "mbxAcc");\r\nif (!phba->idiag_mbx_acc) {\r\nphba->idiag_mbx_acc =\r\ndebugfs_create_file(name, S_IFREG|S_IRUGO|S_IWUSR,\r\nphba->idiag_root, phba, &lpfc_idiag_op_mbxAcc);\r\nif (!phba->idiag_mbx_acc) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"2980 Can't create idiag debugfs\n");\r\ngoto debug_failed;\r\n}\r\n}\r\nif (phba->sli4_hba.extents_in_use) {\r\nsnprintf(name, sizeof(name), "extAcc");\r\nif (!phba->idiag_ext_acc) {\r\nphba->idiag_ext_acc =\r\ndebugfs_create_file(name,\r\nS_IFREG|S_IRUGO|S_IWUSR,\r\nphba->idiag_root, phba,\r\n&lpfc_idiag_op_extAcc);\r\nif (!phba->idiag_ext_acc) {\r\nlpfc_printf_vlog(vport, KERN_ERR, LOG_INIT,\r\n"2986 Cant create "\r\n"idiag debugfs\n");\r\ngoto debug_failed;\r\n}\r\n}\r\n}\r\ndebug_failed:\r\nreturn;\r\n#endif\r\n}\r\ninline void\r\nlpfc_debugfs_terminate(struct lpfc_vport *vport)\r\n{\r\n#ifdef CONFIG_SCSI_LPFC_DEBUG_FS\r\nstruct lpfc_hba *phba = vport->phba;\r\nif (vport->disc_trc) {\r\nkfree(vport->disc_trc);\r\nvport->disc_trc = NULL;\r\n}\r\nif (vport->debug_disc_trc) {\r\ndebugfs_remove(vport->debug_disc_trc);\r\nvport->debug_disc_trc = NULL;\r\n}\r\nif (vport->debug_nodelist) {\r\ndebugfs_remove(vport->debug_nodelist);\r\nvport->debug_nodelist = NULL;\r\n}\r\nif (vport->vport_debugfs_root) {\r\ndebugfs_remove(vport->vport_debugfs_root);\r\nvport->vport_debugfs_root = NULL;\r\natomic_dec(&phba->debugfs_vport_count);\r\n}\r\nif (atomic_read(&phba->debugfs_vport_count) == 0) {\r\nif (phba->debug_hbqinfo) {\r\ndebugfs_remove(phba->debug_hbqinfo);\r\nphba->debug_hbqinfo = NULL;\r\n}\r\nif (phba->debug_dumpHBASlim) {\r\ndebugfs_remove(phba->debug_dumpHBASlim);\r\nphba->debug_dumpHBASlim = NULL;\r\n}\r\nif (phba->debug_dumpHostSlim) {\r\ndebugfs_remove(phba->debug_dumpHostSlim);\r\nphba->debug_dumpHostSlim = NULL;\r\n}\r\nif (phba->debug_dumpData) {\r\ndebugfs_remove(phba->debug_dumpData);\r\nphba->debug_dumpData = NULL;\r\n}\r\nif (phba->debug_dumpDif) {\r\ndebugfs_remove(phba->debug_dumpDif);\r\nphba->debug_dumpDif = NULL;\r\n}\r\nif (phba->debug_InjErrLBA) {\r\ndebugfs_remove(phba->debug_InjErrLBA);\r\nphba->debug_InjErrLBA = NULL;\r\n}\r\nif (phba->debug_InjErrNPortID) {\r\ndebugfs_remove(phba->debug_InjErrNPortID);\r\nphba->debug_InjErrNPortID = NULL;\r\n}\r\nif (phba->debug_InjErrWWPN) {\r\ndebugfs_remove(phba->debug_InjErrWWPN);\r\nphba->debug_InjErrWWPN = NULL;\r\n}\r\nif (phba->debug_writeGuard) {\r\ndebugfs_remove(phba->debug_writeGuard);\r\nphba->debug_writeGuard = NULL;\r\n}\r\nif (phba->debug_writeApp) {\r\ndebugfs_remove(phba->debug_writeApp);\r\nphba->debug_writeApp = NULL;\r\n}\r\nif (phba->debug_writeRef) {\r\ndebugfs_remove(phba->debug_writeRef);\r\nphba->debug_writeRef = NULL;\r\n}\r\nif (phba->debug_readGuard) {\r\ndebugfs_remove(phba->debug_readGuard);\r\nphba->debug_readGuard = NULL;\r\n}\r\nif (phba->debug_readApp) {\r\ndebugfs_remove(phba->debug_readApp);\r\nphba->debug_readApp = NULL;\r\n}\r\nif (phba->debug_readRef) {\r\ndebugfs_remove(phba->debug_readRef);\r\nphba->debug_readRef = NULL;\r\n}\r\nif (phba->slow_ring_trc) {\r\nkfree(phba->slow_ring_trc);\r\nphba->slow_ring_trc = NULL;\r\n}\r\nif (phba->debug_slow_ring_trc) {\r\ndebugfs_remove(phba->debug_slow_ring_trc);\r\nphba->debug_slow_ring_trc = NULL;\r\n}\r\nif (phba->sli_rev == LPFC_SLI_REV4) {\r\nif (phba->idiag_ext_acc) {\r\ndebugfs_remove(phba->idiag_ext_acc);\r\nphba->idiag_ext_acc = NULL;\r\n}\r\nif (phba->idiag_mbx_acc) {\r\ndebugfs_remove(phba->idiag_mbx_acc);\r\nphba->idiag_mbx_acc = NULL;\r\n}\r\nif (phba->idiag_ctl_acc) {\r\ndebugfs_remove(phba->idiag_ctl_acc);\r\nphba->idiag_ctl_acc = NULL;\r\n}\r\nif (phba->idiag_drb_acc) {\r\ndebugfs_remove(phba->idiag_drb_acc);\r\nphba->idiag_drb_acc = NULL;\r\n}\r\nif (phba->idiag_que_acc) {\r\ndebugfs_remove(phba->idiag_que_acc);\r\nphba->idiag_que_acc = NULL;\r\n}\r\nif (phba->idiag_que_info) {\r\ndebugfs_remove(phba->idiag_que_info);\r\nphba->idiag_que_info = NULL;\r\n}\r\nif (phba->idiag_bar_acc) {\r\ndebugfs_remove(phba->idiag_bar_acc);\r\nphba->idiag_bar_acc = NULL;\r\n}\r\nif (phba->idiag_pci_cfg) {\r\ndebugfs_remove(phba->idiag_pci_cfg);\r\nphba->idiag_pci_cfg = NULL;\r\n}\r\nif (phba->idiag_root) {\r\ndebugfs_remove(phba->idiag_root);\r\nphba->idiag_root = NULL;\r\n}\r\n}\r\nif (phba->hba_debugfs_root) {\r\ndebugfs_remove(phba->hba_debugfs_root);\r\nphba->hba_debugfs_root = NULL;\r\natomic_dec(&lpfc_debugfs_hba_count);\r\n}\r\nif (atomic_read(&lpfc_debugfs_hba_count) == 0) {\r\ndebugfs_remove(lpfc_debugfs_root);\r\nlpfc_debugfs_root = NULL;\r\n}\r\n}\r\n#endif\r\nreturn;\r\n}\r\nvoid\r\nlpfc_debug_dump_all_queues(struct lpfc_hba *phba)\r\n{\r\nint fcp_wqidx;\r\nlpfc_debug_dump_mbx_wq(phba);\r\nlpfc_debug_dump_els_wq(phba);\r\nfor (fcp_wqidx = 0; fcp_wqidx < phba->cfg_fcp_wq_count; fcp_wqidx++)\r\nlpfc_debug_dump_fcp_wq(phba, fcp_wqidx);\r\nlpfc_debug_dump_hdr_rq(phba);\r\nlpfc_debug_dump_dat_rq(phba);\r\nlpfc_debug_dump_mbx_cq(phba);\r\nlpfc_debug_dump_els_cq(phba);\r\nfor (fcp_wqidx = 0; fcp_wqidx < phba->cfg_fcp_wq_count; fcp_wqidx++)\r\nlpfc_debug_dump_fcp_cq(phba, fcp_wqidx);\r\nlpfc_debug_dump_sp_eq(phba);\r\nfor (fcp_wqidx = 0; fcp_wqidx < phba->cfg_fcp_wq_count; fcp_wqidx++)\r\nlpfc_debug_dump_fcp_eq(phba, fcp_wqidx);\r\n}

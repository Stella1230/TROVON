static int __init testfunc(void)\r\n{\r\nchar buf[100];\r\nunsigned int i;\r\nunsigned int ret;\r\nstruct { unsigned char buf[6]; } hello = { "hello" };\r\nprintk(KERN_INFO "record fifo test start\n");\r\nkfifo_in(&test, &hello, sizeof(hello));\r\nprintk(KERN_INFO "fifo peek len: %u\n", kfifo_peek_len(&test));\r\nfor (i = 0; i < 10; i++) {\r\nmemset(buf, 'a' + i, i + 1);\r\nkfifo_in(&test, buf, i + 1);\r\n}\r\nprintk(KERN_INFO "skip 1st element\n");\r\nkfifo_skip(&test);\r\nprintk(KERN_INFO "fifo len: %u\n", kfifo_len(&test));\r\nret = kfifo_out_peek(&test, buf, sizeof(buf));\r\nif (ret)\r\nprintk(KERN_INFO "%.*s\n", ret, buf);\r\ni = 0;\r\nwhile (!kfifo_is_empty(&test)) {\r\nret = kfifo_out(&test, buf, sizeof(buf));\r\nbuf[ret] = '\0';\r\nprintk(KERN_INFO "item = %.*s\n", ret, buf);\r\nif (strcmp(buf, expected_result[i++])) {\r\nprintk(KERN_WARNING "value mismatch: test failed\n");\r\nreturn -EIO;\r\n}\r\n}\r\nif (i != ARRAY_SIZE(expected_result)) {\r\nprintk(KERN_WARNING "size mismatch: test failed\n");\r\nreturn -EIO;\r\n}\r\nprintk(KERN_INFO "test passed\n");\r\nreturn 0;\r\n}\r\nstatic ssize_t fifo_write(struct file *file, const char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nint ret;\r\nunsigned int copied;\r\nif (mutex_lock_interruptible(&write_lock))\r\nreturn -ERESTARTSYS;\r\nret = kfifo_from_user(&test, buf, count, &copied);\r\nmutex_unlock(&write_lock);\r\nreturn ret ? ret : copied;\r\n}\r\nstatic ssize_t fifo_read(struct file *file, char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nint ret;\r\nunsigned int copied;\r\nif (mutex_lock_interruptible(&read_lock))\r\nreturn -ERESTARTSYS;\r\nret = kfifo_to_user(&test, buf, count, &copied);\r\nmutex_unlock(&read_lock);\r\nreturn ret ? ret : copied;\r\n}\r\nstatic int __init example_init(void)\r\n{\r\n#ifdef DYNAMIC\r\nint ret;\r\nret = kfifo_alloc(&test, FIFO_SIZE, GFP_KERNEL);\r\nif (ret) {\r\nprintk(KERN_ERR "error kfifo_alloc\n");\r\nreturn ret;\r\n}\r\n#else\r\nINIT_KFIFO(test);\r\n#endif\r\nif (testfunc() < 0) {\r\n#ifdef DYNAMIC\r\nkfifo_free(&test);\r\n#endif\r\nreturn -EIO;\r\n}\r\nif (proc_create(PROC_FIFO, 0, NULL, &fifo_fops) == NULL) {\r\n#ifdef DYNAMIC\r\nkfifo_free(&test);\r\n#endif\r\nreturn -ENOMEM;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit example_exit(void)\r\n{\r\nremove_proc_entry(PROC_FIFO, NULL);\r\n#ifdef DYNAMIC\r\nkfifo_free(&test);\r\n#endif\r\n}

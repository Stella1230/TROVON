short hpi_dsp_code_open(u32 adapter, void *os_data, struct dsp_code *dsp_code,\r\nu32 *os_error_code)\r\n{\r\nconst struct firmware *firmware;\r\nstruct pci_dev *dev = os_data;\r\nstruct code_header header;\r\nchar fw_name[20];\r\nshort err_ret = HPI_ERROR_DSP_FILE_NOT_FOUND;\r\nint err;\r\nsprintf(fw_name, "asihpi/dsp%04x.bin", adapter);\r\nerr = request_firmware(&firmware, fw_name, &dev->dev);\r\nif (err || !firmware) {\r\ndev_printk(KERN_ERR, &dev->dev,\r\n"%d, request_firmware failed for %s\n", err,\r\nfw_name);\r\ngoto error1;\r\n}\r\nif (firmware->size < sizeof(header)) {\r\ndev_printk(KERN_ERR, &dev->dev, "Header size too small %s\n",\r\nfw_name);\r\ngoto error2;\r\n}\r\nmemcpy(&header, firmware->data, sizeof(header));\r\nif ((header.type != 0x45444F43) ||\r\n(header.adapter != adapter)\r\n|| (header.size != firmware->size)) {\r\ndev_printk(KERN_ERR, &dev->dev,\r\n"Invalid firmware header size %d != file %zd\n",\r\nheader.size, firmware->size);\r\ngoto error2;\r\n}\r\nif ((header.version >> 9) != (HPI_VER >> 9)) {\r\ndev_printk(KERN_ERR, &dev->dev,\r\n"Incompatible firmware version "\r\n"DSP image %X != Driver %X\n", header.version,\r\nHPI_VER);\r\ngoto error2;\r\n}\r\nif (header.version != HPI_VER) {\r\ndev_printk(KERN_INFO, &dev->dev,\r\n"Firmware: release version mismatch DSP image %X != Driver %X\n",\r\nheader.version, HPI_VER);\r\n}\r\nHPI_DEBUG_LOG(DEBUG, "dsp code %s opened\n", fw_name);\r\ndsp_code->pvt = kmalloc(sizeof(*dsp_code->pvt), GFP_KERNEL);\r\nif (!dsp_code->pvt) {\r\nerr_ret = HPI_ERROR_MEMORY_ALLOC;\r\ngoto error2;\r\n}\r\ndsp_code->pvt->dev = dev;\r\ndsp_code->pvt->firmware = firmware;\r\ndsp_code->header = header;\r\ndsp_code->block_length = header.size / sizeof(u32);\r\ndsp_code->word_count = sizeof(header) / sizeof(u32);\r\nreturn 0;\r\nerror2:\r\nrelease_firmware(firmware);\r\nerror1:\r\ndsp_code->block_length = 0;\r\nreturn err_ret;\r\n}\r\nvoid hpi_dsp_code_close(struct dsp_code *dsp_code)\r\n{\r\nHPI_DEBUG_LOG(DEBUG, "dsp code closed\n");\r\nrelease_firmware(dsp_code->pvt->firmware);\r\nkfree(dsp_code->pvt);\r\n}\r\nvoid hpi_dsp_code_rewind(struct dsp_code *dsp_code)\r\n{\r\ndsp_code->word_count = sizeof(struct code_header) / sizeof(u32);\r\n}\r\nshort hpi_dsp_code_read_word(struct dsp_code *dsp_code, u32 *pword)\r\n{\r\nif (dsp_code->word_count + 1 > dsp_code->block_length)\r\nreturn HPI_ERROR_DSP_FILE_FORMAT;\r\n*pword = ((u32 *)(dsp_code->pvt->firmware->data))[dsp_code->\r\nword_count];\r\ndsp_code->word_count++;\r\nreturn 0;\r\n}\r\nshort hpi_dsp_code_read_block(size_t words_requested,\r\nstruct dsp_code *dsp_code, u32 **ppblock)\r\n{\r\nif (dsp_code->word_count + words_requested > dsp_code->block_length)\r\nreturn HPI_ERROR_DSP_FILE_FORMAT;\r\n*ppblock =\r\n((u32 *)(dsp_code->pvt->firmware->data)) +\r\ndsp_code->word_count;\r\ndsp_code->word_count += words_requested;\r\nreturn 0;\r\n}

static int ds1390_get_reg(struct device *dev, unsigned char address,\r\nunsigned char *data)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nstruct ds1390 *chip = dev_get_drvdata(dev);\r\nint status;\r\nif (!data)\r\nreturn -EINVAL;\r\nchip->txrx_buf[0] = address & 0x7f;\r\nstatus = spi_write_then_read(spi, chip->txrx_buf, 1, chip->txrx_buf, 1);\r\nif (status != 0)\r\nreturn status;\r\n*data = chip->txrx_buf[1];\r\nreturn 0;\r\n}\r\nstatic int ds1390_read_time(struct device *dev, struct rtc_time *dt)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nstruct ds1390 *chip = dev_get_drvdata(dev);\r\nint status;\r\nchip->txrx_buf[0] = DS1390_REG_SECONDS;\r\nstatus = spi_write_then_read(spi, chip->txrx_buf, 1, chip->txrx_buf, 8);\r\nif (status != 0)\r\nreturn status;\r\ndt->tm_sec = bcd2bin(chip->txrx_buf[0]);\r\ndt->tm_min = bcd2bin(chip->txrx_buf[1]);\r\ndt->tm_hour = bcd2bin(chip->txrx_buf[2]);\r\ndt->tm_wday = bcd2bin(chip->txrx_buf[3]);\r\ndt->tm_mday = bcd2bin(chip->txrx_buf[4]);\r\ndt->tm_mon = bcd2bin(chip->txrx_buf[5] & 0x7f) - 1;\r\ndt->tm_year = bcd2bin(chip->txrx_buf[6]) + ((chip->txrx_buf[5] & 0x80) ? 100 : 0);\r\nreturn rtc_valid_tm(dt);\r\n}\r\nstatic int ds1390_set_time(struct device *dev, struct rtc_time *dt)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nstruct ds1390 *chip = dev_get_drvdata(dev);\r\nchip->txrx_buf[0] = DS1390_REG_SECONDS | 0x80;\r\nchip->txrx_buf[1] = bin2bcd(dt->tm_sec);\r\nchip->txrx_buf[2] = bin2bcd(dt->tm_min);\r\nchip->txrx_buf[3] = bin2bcd(dt->tm_hour);\r\nchip->txrx_buf[4] = bin2bcd(dt->tm_wday);\r\nchip->txrx_buf[5] = bin2bcd(dt->tm_mday);\r\nchip->txrx_buf[6] = bin2bcd(dt->tm_mon + 1) |\r\n((dt->tm_year > 99) ? 0x80 : 0x00);\r\nchip->txrx_buf[7] = bin2bcd(dt->tm_year % 100);\r\nreturn spi_write_then_read(spi, chip->txrx_buf, 8, NULL, 0);\r\n}\r\nstatic int __devinit ds1390_probe(struct spi_device *spi)\r\n{\r\nunsigned char tmp;\r\nstruct ds1390 *chip;\r\nint res;\r\nspi->mode = SPI_MODE_3;\r\nspi->bits_per_word = 8;\r\nspi_setup(spi);\r\nchip = kzalloc(sizeof *chip, GFP_KERNEL);\r\nif (!chip) {\r\ndev_err(&spi->dev, "unable to allocate device memory\n");\r\nreturn -ENOMEM;\r\n}\r\ndev_set_drvdata(&spi->dev, chip);\r\nres = ds1390_get_reg(&spi->dev, DS1390_REG_SECONDS, &tmp);\r\nif (res != 0) {\r\ndev_err(&spi->dev, "unable to read device\n");\r\nkfree(chip);\r\nreturn res;\r\n}\r\nchip->rtc = rtc_device_register("ds1390",\r\n&spi->dev, &ds1390_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(chip->rtc)) {\r\ndev_err(&spi->dev, "unable to register device\n");\r\nres = PTR_ERR(chip->rtc);\r\nkfree(chip);\r\n}\r\nreturn res;\r\n}\r\nstatic int __devexit ds1390_remove(struct spi_device *spi)\r\n{\r\nstruct ds1390 *chip = spi_get_drvdata(spi);\r\nrtc_device_unregister(chip->rtc);\r\nkfree(chip);\r\nreturn 0;\r\n}

irqreturn_t interrupt_handler(int dummy, void *card_inst)\r\n{\r\nRspMessage rcvmsg;\r\nint channel;\r\nint card = (int)(unsigned long) card_inst;\r\nif (!IS_VALID_CARD(card)) {\r\npr_debug("Invalid param: %d is not a valid card id\n", card);\r\nreturn IRQ_NONE;\r\n}\r\npr_debug("%s: Entered Interrupt handler\n",\r\nsc_adapter[card]->devicename);\r\nwhile (!receivemessage(card, &rcvmsg)) {\r\nif (sc_adapter[card]->want_async_messages)\r\nmemcpy(&(sc_adapter[card]->async_msg),\r\n&rcvmsg, sizeof(RspMessage));\r\nchannel = (unsigned int) rcvmsg.phy_link_no;\r\nif (IS_CM_MESSAGE(rcvmsg, 0, 0, Invalid)) {\r\npr_debug("%s: Invalid request Message, rsp_status = %d\n",\r\nsc_adapter[card]->devicename,\r\nrcvmsg.rsp_status);\r\nbreak;\r\n}\r\nif (IS_CE_MESSAGE(rcvmsg, Lnk, 1, Read))\r\n{\r\npr_debug("%s: Received packet 0x%x bytes long at 0x%lx\n",\r\nsc_adapter[card]->devicename,\r\nrcvmsg.msg_data.response.msg_len,\r\nrcvmsg.msg_data.response.buff_offset);\r\nrcvpkt(card, &rcvmsg);\r\ncontinue;\r\n}\r\nif (IS_CE_MESSAGE(rcvmsg, Lnk, 1, Write)) {\r\npr_debug("%s: Packet Send ACK on channel %d\n",\r\nsc_adapter[card]->devicename,\r\nrcvmsg.phy_link_no);\r\nsc_adapter[card]->channel[rcvmsg.phy_link_no - 1].free_sendbufs++;\r\ncontinue;\r\n}\r\nif (IS_CE_MESSAGE(rcvmsg, Phy, 1, Connect))\r\n{\r\nunsigned int callid;\r\nsetup_parm setup;\r\npr_debug("%s: Connect message: line %d: status %d: cause 0x%x\n",\r\nsc_adapter[card]->devicename,\r\nrcvmsg.phy_link_no,\r\nrcvmsg.rsp_status,\r\nrcvmsg.msg_data.byte_array[2]);\r\nmemcpy(&callid, rcvmsg.msg_data.byte_array, sizeof(int));\r\nif (callid >= 0x8000 && callid <= 0xFFFF)\r\n{\r\npr_debug("%s: Got Dial-Out Rsp\n",\r\nsc_adapter[card]->devicename);\r\nindicate_status(card, ISDN_STAT_DCONN,\r\n(unsigned long)rcvmsg.phy_link_no - 1, NULL);\r\n}\r\nelse if (callid >= 0x0000 && callid <= 0x7FFF)\r\n{\r\nint len;\r\npr_debug("%s: Got Incoming Call\n",\r\nsc_adapter[card]->devicename);\r\nlen = strlcpy(setup.phone, &(rcvmsg.msg_data.byte_array[4]),\r\nsizeof(setup.phone));\r\nif (len >= sizeof(setup.phone))\r\ncontinue;\r\nlen = strlcpy(setup.eazmsn,\r\nsc_adapter[card]->channel[rcvmsg.phy_link_no - 1].dn,\r\nsizeof(setup.eazmsn));\r\nif (len >= sizeof(setup.eazmsn))\r\ncontinue;\r\nsetup.si1 = 7;\r\nsetup.si2 = 0;\r\nsetup.plan = 0;\r\nsetup.screen = 0;\r\nindicate_status(card, ISDN_STAT_ICALL, (unsigned long)rcvmsg.phy_link_no - 1, (char *)&setup);\r\nindicate_status(card, ISDN_STAT_DCONN, (unsigned long)rcvmsg.phy_link_no - 1, NULL);\r\n}\r\ncontinue;\r\n}\r\nif (IS_CE_MESSAGE(rcvmsg, Phy, 1, Disconnect))\r\n{\r\npr_debug("%s: disconnect message: line %d: status %d: cause 0x%x\n",\r\nsc_adapter[card]->devicename,\r\nrcvmsg.phy_link_no,\r\nrcvmsg.rsp_status,\r\nrcvmsg.msg_data.byte_array[2]);\r\nindicate_status(card, ISDN_STAT_BHUP, (unsigned long)rcvmsg.phy_link_no - 1, NULL);\r\nindicate_status(card, ISDN_STAT_DHUP, (unsigned long)rcvmsg.phy_link_no - 1, NULL);\r\ncontinue;\r\n}\r\nif (IS_CM_MESSAGE(rcvmsg, 5, 0, MiscEngineUp)) {\r\npr_debug("%s: Received EngineUp message\n",\r\nsc_adapter[card]->devicename);\r\nsc_adapter[card]->EngineUp = 1;\r\nsendmessage(card, CEPID, ceReqTypeCall, ceReqClass0, ceReqCallGetMyNumber, 1, 0, NULL);\r\nsendmessage(card, CEPID, ceReqTypeCall, ceReqClass0, ceReqCallGetMyNumber, 2, 0, NULL);\r\ninit_timer(&sc_adapter[card]->stat_timer);\r\nsc_adapter[card]->stat_timer.function = check_phystat;\r\nsc_adapter[card]->stat_timer.data = card;\r\nsc_adapter[card]->stat_timer.expires = jiffies + CHECKSTAT_TIME;\r\nadd_timer(&sc_adapter[card]->stat_timer);\r\ncontinue;\r\n}\r\nif (IS_CM_MESSAGE(rcvmsg, 2, 0, StartProc)) {\r\npr_debug("%s: StartProc Response Status %d\n",\r\nsc_adapter[card]->devicename,\r\nrcvmsg.rsp_status);\r\ncontinue;\r\n}\r\nif (IS_CE_MESSAGE(rcvmsg, Call, 0, GetMyNumber)) {\r\nstrlcpy(sc_adapter[card]->channel[rcvmsg.phy_link_no - 1].dn,\r\nrcvmsg.msg_data.byte_array,\r\nsizeof(rcvmsg.msg_data.byte_array));\r\ncontinue;\r\n}\r\nif (IS_CE_MESSAGE(rcvmsg, Phy, 2, Status)) {\r\nunsigned int b1stat, b2stat;\r\nb1stat = (unsigned int) rcvmsg.msg_data.byte_array[0];\r\nb2stat = (unsigned int) rcvmsg.msg_data.byte_array[1];\r\nsc_adapter[card]->nphystat = (b2stat >> 8) | b1stat;\r\npr_debug("%s: PhyStat is 0x%2x\n",\r\nsc_adapter[card]->devicename,\r\nsc_adapter[card]->nphystat);\r\ncontinue;\r\n}\r\nif (IS_CE_MESSAGE(rcvmsg, Call, 0, GetFrameFormat)) {\r\nif (rcvmsg.msg_data.byte_array[0] != HDLC_PROTO) {\r\nunsigned int proto = HDLC_PROTO;\r\npr_debug("%s: current frame format: 0x%x, will change to HDLC\n",\r\nsc_adapter[card]->devicename,\r\nrcvmsg.msg_data.byte_array[0]);\r\nsendmessage(card, CEPID, ceReqTypeCall,\r\nceReqClass0,\r\nceReqCallSetFrameFormat,\r\n(unsigned char)channel + 1,\r\n1, &proto);\r\n}\r\ncontinue;\r\n}\r\npr_debug("%s: Received unhandled message (%d,%d,%d) link %d\n",\r\nsc_adapter[card]->devicename,\r\nrcvmsg.type, rcvmsg.class, rcvmsg.code,\r\nrcvmsg.phy_link_no);\r\n}\r\npr_debug("%s: Exiting Interrupt Handler\n",\r\nsc_adapter[card]->devicename);\r\nreturn IRQ_HANDLED;\r\n}

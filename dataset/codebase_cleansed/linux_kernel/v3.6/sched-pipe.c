int bench_sched_pipe(int argc, const char **argv,\r\nconst char *prefix __used)\r\n{\r\nint pipe_1[2], pipe_2[2];\r\nint m = 0, i;\r\nstruct timeval start, stop, diff;\r\nunsigned long long result_usec = 0;\r\nint __used ret, wait_stat;\r\npid_t pid, retpid;\r\nargc = parse_options(argc, argv, options,\r\nbench_sched_pipe_usage, 0);\r\nassert(!pipe(pipe_1));\r\nassert(!pipe(pipe_2));\r\npid = fork();\r\nassert(pid >= 0);\r\ngettimeofday(&start, NULL);\r\nif (!pid) {\r\nfor (i = 0; i < loops; i++) {\r\nret = read(pipe_1[0], &m, sizeof(int));\r\nret = write(pipe_2[1], &m, sizeof(int));\r\n}\r\n} else {\r\nfor (i = 0; i < loops; i++) {\r\nret = write(pipe_1[1], &m, sizeof(int));\r\nret = read(pipe_2[0], &m, sizeof(int));\r\n}\r\n}\r\ngettimeofday(&stop, NULL);\r\ntimersub(&stop, &start, &diff);\r\nif (pid) {\r\nretpid = waitpid(pid, &wait_stat, 0);\r\nassert((retpid == pid) && WIFEXITED(wait_stat));\r\n} else {\r\nexit(0);\r\n}\r\nswitch (bench_format) {\r\ncase BENCH_FORMAT_DEFAULT:\r\nprintf("# Executed %d pipe operations between two tasks\n\n",\r\nloops);\r\nresult_usec = diff.tv_sec * 1000000;\r\nresult_usec += diff.tv_usec;\r\nprintf(" %14s: %lu.%03lu [sec]\n\n", "Total time",\r\ndiff.tv_sec,\r\n(unsigned long) (diff.tv_usec/1000));\r\nprintf(" %14lf usecs/op\n",\r\n(double)result_usec / (double)loops);\r\nprintf(" %14d ops/sec\n",\r\n(int)((double)loops /\r\n((double)result_usec / (double)1000000)));\r\nbreak;\r\ncase BENCH_FORMAT_SIMPLE:\r\nprintf("%lu.%03lu\n",\r\ndiff.tv_sec,\r\n(unsigned long) (diff.tv_usec / 1000));\r\nbreak;\r\ndefault:\r\nfprintf(stderr, "Unknown format:%d\n", bench_format);\r\nexit(1);\r\nbreak;\r\n}\r\nreturn 0;\r\n}

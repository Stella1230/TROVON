asmlinkage int sys_tas(int __user *addr)\r\n{\r\nint oldval;\r\nif (!access_ok(VERIFY_WRITE, addr, sizeof (int)))\r\nreturn -EFAULT;\r\n__asm__ __volatile__ (\r\nDCACHE_CLEAR("%0", "r4", "%1")\r\n" .fillinsn\n"\r\n"1:\n"\r\n" lock %0, @%1 -> unlock %2, @%1\n"\r\n"2:\n"\r\n".section .fixup,\"ax\"\n"\r\n" .balign 4\n"\r\n"3: ldi %0, #%3\n"\r\n" seth r14, #high(2b)\n"\r\n" or3 r14, r14, #low(2b)\n"\r\n" jmp r14\n"\r\n".previous\n"\r\n".section __ex_table,\"a\"\n"\r\n" .balign 4\n"\r\n" .long 1b,3b\n"\r\n".previous\n"\r\n: "=&r" (oldval)\r\n: "r" (addr), "r" (1), "i"(-EFAULT)\r\n: "r14", "memory"\r\n#ifdef CONFIG_CHIP_M32700_TS1\r\n, "r4"\r\n#endif\r\n);\r\nreturn oldval;\r\n}\r\nasmlinkage int sys_cacheflush(void *addr, int bytes, int cache)\r\n{\r\n_flush_cache_all();\r\nreturn 0;\r\n}\r\nasmlinkage int sys_cachectl(char *addr, int nbytes, int op)\r\n{\r\nreturn -ENOSYS;\r\n}\r\nint kernel_execve(const char *filename,\r\nconst char *const argv[],\r\nconst char *const envp[])\r\n{\r\nregister long __scno __asm__ ("r7") = __NR_execve;\r\nregister long __arg3 __asm__ ("r2") = (long)(envp);\r\nregister long __arg2 __asm__ ("r1") = (long)(argv);\r\nregister long __res __asm__ ("r0") = (long)(filename);\r\n__asm__ __volatile__ (\r\n"trap #" SYSCALL_VECTOR "|| nop"\r\n: "=r" (__res)\r\n: "r" (__scno), "0" (__res), "r" (__arg2),\r\n"r" (__arg3)\r\n: "memory");\r\nreturn __res;\r\n}

static cputime64_t get_idle_time(int cpu)\r\n{\r\ncputime64_t idle;\r\nidle = kcpustat_cpu(cpu).cpustat[CPUTIME_IDLE];\r\nif (cpu_online(cpu) && !nr_iowait_cpu(cpu))\r\nidle += arch_idle_time(cpu);\r\nreturn idle;\r\n}\r\nstatic cputime64_t get_iowait_time(int cpu)\r\n{\r\ncputime64_t iowait;\r\niowait = kcpustat_cpu(cpu).cpustat[CPUTIME_IOWAIT];\r\nif (cpu_online(cpu) && nr_iowait_cpu(cpu))\r\niowait += arch_idle_time(cpu);\r\nreturn iowait;\r\n}\r\nstatic u64 get_idle_time(int cpu)\r\n{\r\nu64 idle, idle_time = get_cpu_idle_time_us(cpu, NULL);\r\nif (idle_time == -1ULL)\r\nidle = kcpustat_cpu(cpu).cpustat[CPUTIME_IDLE];\r\nelse\r\nidle = usecs_to_cputime64(idle_time);\r\nreturn idle;\r\n}\r\nstatic u64 get_iowait_time(int cpu)\r\n{\r\nu64 iowait, iowait_time = get_cpu_iowait_time_us(cpu, NULL);\r\nif (iowait_time == -1ULL)\r\niowait = kcpustat_cpu(cpu).cpustat[CPUTIME_IOWAIT];\r\nelse\r\niowait = usecs_to_cputime64(iowait_time);\r\nreturn iowait;\r\n}\r\nstatic int show_stat(struct seq_file *p, void *v)\r\n{\r\nint i, j;\r\nunsigned long jif;\r\nu64 user, nice, system, idle, iowait, irq, softirq, steal;\r\nu64 guest, guest_nice;\r\nu64 sum = 0;\r\nu64 sum_softirq = 0;\r\nunsigned int per_softirq_sums[NR_SOFTIRQS] = {0};\r\nstruct timespec boottime;\r\nuser = nice = system = idle = iowait =\r\nirq = softirq = steal = 0;\r\nguest = guest_nice = 0;\r\ngetboottime(&boottime);\r\njif = boottime.tv_sec;\r\nfor_each_possible_cpu(i) {\r\nuser += kcpustat_cpu(i).cpustat[CPUTIME_USER];\r\nnice += kcpustat_cpu(i).cpustat[CPUTIME_NICE];\r\nsystem += kcpustat_cpu(i).cpustat[CPUTIME_SYSTEM];\r\nidle += get_idle_time(i);\r\niowait += get_iowait_time(i);\r\nirq += kcpustat_cpu(i).cpustat[CPUTIME_IRQ];\r\nsoftirq += kcpustat_cpu(i).cpustat[CPUTIME_SOFTIRQ];\r\nsteal += kcpustat_cpu(i).cpustat[CPUTIME_STEAL];\r\nguest += kcpustat_cpu(i).cpustat[CPUTIME_GUEST];\r\nguest_nice += kcpustat_cpu(i).cpustat[CPUTIME_GUEST_NICE];\r\nsum += kstat_cpu_irqs_sum(i);\r\nsum += arch_irq_stat_cpu(i);\r\nfor (j = 0; j < NR_SOFTIRQS; j++) {\r\nunsigned int softirq_stat = kstat_softirqs_cpu(j, i);\r\nper_softirq_sums[j] += softirq_stat;\r\nsum_softirq += softirq_stat;\r\n}\r\n}\r\nsum += arch_irq_stat();\r\nseq_puts(p, "cpu ");\r\nseq_put_decimal_ull(p, ' ', cputime64_to_clock_t(user));\r\nseq_put_decimal_ull(p, ' ', cputime64_to_clock_t(nice));\r\nseq_put_decimal_ull(p, ' ', cputime64_to_clock_t(system));\r\nseq_put_decimal_ull(p, ' ', cputime64_to_clock_t(idle));\r\nseq_put_decimal_ull(p, ' ', cputime64_to_clock_t(iowait));\r\nseq_put_decimal_ull(p, ' ', cputime64_to_clock_t(irq));\r\nseq_put_decimal_ull(p, ' ', cputime64_to_clock_t(softirq));\r\nseq_put_decimal_ull(p, ' ', cputime64_to_clock_t(steal));\r\nseq_put_decimal_ull(p, ' ', cputime64_to_clock_t(guest));\r\nseq_put_decimal_ull(p, ' ', cputime64_to_clock_t(guest_nice));\r\nseq_putc(p, '\n');\r\nfor_each_online_cpu(i) {\r\nuser = kcpustat_cpu(i).cpustat[CPUTIME_USER];\r\nnice = kcpustat_cpu(i).cpustat[CPUTIME_NICE];\r\nsystem = kcpustat_cpu(i).cpustat[CPUTIME_SYSTEM];\r\nidle = get_idle_time(i);\r\niowait = get_iowait_time(i);\r\nirq = kcpustat_cpu(i).cpustat[CPUTIME_IRQ];\r\nsoftirq = kcpustat_cpu(i).cpustat[CPUTIME_SOFTIRQ];\r\nsteal = kcpustat_cpu(i).cpustat[CPUTIME_STEAL];\r\nguest = kcpustat_cpu(i).cpustat[CPUTIME_GUEST];\r\nguest_nice = kcpustat_cpu(i).cpustat[CPUTIME_GUEST_NICE];\r\nseq_printf(p, "cpu%d", i);\r\nseq_put_decimal_ull(p, ' ', cputime64_to_clock_t(user));\r\nseq_put_decimal_ull(p, ' ', cputime64_to_clock_t(nice));\r\nseq_put_decimal_ull(p, ' ', cputime64_to_clock_t(system));\r\nseq_put_decimal_ull(p, ' ', cputime64_to_clock_t(idle));\r\nseq_put_decimal_ull(p, ' ', cputime64_to_clock_t(iowait));\r\nseq_put_decimal_ull(p, ' ', cputime64_to_clock_t(irq));\r\nseq_put_decimal_ull(p, ' ', cputime64_to_clock_t(softirq));\r\nseq_put_decimal_ull(p, ' ', cputime64_to_clock_t(steal));\r\nseq_put_decimal_ull(p, ' ', cputime64_to_clock_t(guest));\r\nseq_put_decimal_ull(p, ' ', cputime64_to_clock_t(guest_nice));\r\nseq_putc(p, '\n');\r\n}\r\nseq_printf(p, "intr %llu", (unsigned long long)sum);\r\nfor_each_irq_nr(j)\r\nseq_put_decimal_ull(p, ' ', kstat_irqs(j));\r\nseq_printf(p,\r\n"\nctxt %llu\n"\r\n"btime %lu\n"\r\n"processes %lu\n"\r\n"procs_running %lu\n"\r\n"procs_blocked %lu\n",\r\nnr_context_switches(),\r\n(unsigned long)jif,\r\ntotal_forks,\r\nnr_running(),\r\nnr_iowait());\r\nseq_printf(p, "softirq %llu", (unsigned long long)sum_softirq);\r\nfor (i = 0; i < NR_SOFTIRQS; i++)\r\nseq_put_decimal_ull(p, ' ', per_softirq_sums[i]);\r\nseq_putc(p, '\n');\r\nreturn 0;\r\n}\r\nstatic int stat_open(struct inode *inode, struct file *file)\r\n{\r\nunsigned size = 1024 + 128 * num_possible_cpus();\r\nchar *buf;\r\nstruct seq_file *m;\r\nint res;\r\nsize += 2 * nr_irqs;\r\nif (size > KMALLOC_MAX_SIZE)\r\nsize = KMALLOC_MAX_SIZE;\r\nbuf = kmalloc(size, GFP_KERNEL);\r\nif (!buf)\r\nreturn -ENOMEM;\r\nres = single_open(file, show_stat, NULL);\r\nif (!res) {\r\nm = file->private_data;\r\nm->buf = buf;\r\nm->size = ksize(buf);\r\n} else\r\nkfree(buf);\r\nreturn res;\r\n}\r\nstatic int __init proc_stat_init(void)\r\n{\r\nproc_create("stat", 0, NULL, &proc_stat_operations);\r\nreturn 0;\r\n}

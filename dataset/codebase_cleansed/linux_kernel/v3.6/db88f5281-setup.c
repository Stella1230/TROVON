static void db88f5281_7seg_event(unsigned long data)\r\n{\r\nstatic int count = 0;\r\nwritel(0, db88f5281_7seg + (count << 4));\r\ncount = (count + 1) & 7;\r\nmod_timer(&db88f5281_timer, jiffies + 2 * HZ);\r\n}\r\nstatic int __init db88f5281_7seg_init(void)\r\n{\r\nif (machine_is_db88f5281()) {\r\ndb88f5281_7seg = ioremap(DB88F5281_7SEG_BASE,\r\nDB88F5281_7SEG_SIZE);\r\nif (!db88f5281_7seg) {\r\nprintk(KERN_ERR "Failed to ioremap db88f5281_7seg\n");\r\nreturn -EIO;\r\n}\r\nsetup_timer(&db88f5281_timer, db88f5281_7seg_event, 0);\r\nmod_timer(&db88f5281_timer, jiffies + 2 * HZ);\r\n}\r\nreturn 0;\r\n}\r\nvoid __init db88f5281_pci_preinit(void)\r\n{\r\nint pin;\r\npin = DB88F5281_PCI_SLOT0_IRQ_PIN;\r\nif (gpio_request(pin, "PCI Int1") == 0) {\r\nif (gpio_direction_input(pin) == 0) {\r\nirq_set_irq_type(gpio_to_irq(pin), IRQ_TYPE_LEVEL_LOW);\r\n} else {\r\nprintk(KERN_ERR "db88f5281_pci_preinit failed to "\r\n"set_irq_type pin %d\n", pin);\r\ngpio_free(pin);\r\n}\r\n} else {\r\nprintk(KERN_ERR "db88f5281_pci_preinit failed to gpio_request %d\n", pin);\r\n}\r\npin = DB88F5281_PCI_SLOT1_SLOT2_IRQ_PIN;\r\nif (gpio_request(pin, "PCI Int2") == 0) {\r\nif (gpio_direction_input(pin) == 0) {\r\nirq_set_irq_type(gpio_to_irq(pin), IRQ_TYPE_LEVEL_LOW);\r\n} else {\r\nprintk(KERN_ERR "db88f5281_pci_preinit failed "\r\n"to set_irq_type pin %d\n", pin);\r\ngpio_free(pin);\r\n}\r\n} else {\r\nprintk(KERN_ERR "db88f5281_pci_preinit failed to gpio_request %d\n", pin);\r\n}\r\n}\r\nstatic int __init db88f5281_pci_map_irq(const struct pci_dev *dev, u8 slot,\r\nu8 pin)\r\n{\r\nint irq;\r\nirq = orion5x_pci_map_irq(dev, slot, pin);\r\nif (irq != -1)\r\nreturn irq;\r\nswitch (slot - DB88F5281_PCI_SLOT0_OFFS) {\r\ncase 0:\r\nreturn gpio_to_irq(DB88F5281_PCI_SLOT0_IRQ_PIN);\r\ncase 1:\r\ncase 2:\r\nreturn gpio_to_irq(DB88F5281_PCI_SLOT1_SLOT2_IRQ_PIN);\r\ndefault:\r\nreturn -1;\r\n}\r\n}\r\nstatic int __init db88f5281_pci_init(void)\r\n{\r\nif (machine_is_db88f5281())\r\npci_common_init(&db88f5281_pci);\r\nreturn 0;\r\n}\r\nstatic void __init db88f5281_init(void)\r\n{\r\norion5x_init();\r\norion5x_mpp_conf(db88f5281_mpp_modes);\r\nwritel(0, MPP_DEV_CTRL);\r\norion5x_ehci0_init();\r\norion5x_eth_init(&db88f5281_eth_data);\r\norion5x_i2c_init();\r\norion5x_uart0_init();\r\norion5x_uart1_init();\r\norion5x_setup_dev_boot_win(DB88F5281_NOR_BOOT_BASE,\r\nDB88F5281_NOR_BOOT_SIZE);\r\nplatform_device_register(&db88f5281_boot_flash);\r\norion5x_setup_dev0_win(DB88F5281_7SEG_BASE, DB88F5281_7SEG_SIZE);\r\norion5x_setup_dev1_win(DB88F5281_NOR_BASE, DB88F5281_NOR_SIZE);\r\nplatform_device_register(&db88f5281_nor_flash);\r\norion5x_setup_dev2_win(DB88F5281_NAND_BASE, DB88F5281_NAND_SIZE);\r\nplatform_device_register(&db88f5281_nand_flash);\r\ni2c_register_board_info(0, &db88f5281_i2c_rtc, 1);\r\n}

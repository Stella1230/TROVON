void usb_stor_pad12_command(struct scsi_cmnd *srb, struct us_data *us)\r\n{\r\nfor (; srb->cmd_len<12; srb->cmd_len++)\r\nsrb->cmnd[srb->cmd_len] = 0;\r\nsrb->cmd_len = 12;\r\nusb_stor_invoke_transport(srb, us);\r\n}\r\nvoid usb_stor_ufi_command(struct scsi_cmnd *srb, struct us_data *us)\r\n{\r\nfor (; srb->cmd_len<12; srb->cmd_len++)\r\nsrb->cmnd[srb->cmd_len] = 0;\r\nsrb->cmd_len = 12;\r\nswitch (srb->cmnd[0]) {\r\ncase INQUIRY:\r\nsrb->cmnd[4] = 36;\r\nbreak;\r\ncase MODE_SENSE_10:\r\nsrb->cmnd[7] = 0;\r\nsrb->cmnd[8] = 8;\r\nbreak;\r\ncase REQUEST_SENSE:\r\nsrb->cmnd[4] = 18;\r\nbreak;\r\n}\r\nusb_stor_invoke_transport(srb, us);\r\n}\r\nvoid usb_stor_transparent_scsi_command(struct scsi_cmnd *srb,\r\nstruct us_data *us)\r\n{\r\nusb_stor_invoke_transport(srb, us);\r\n}\r\nunsigned int usb_stor_access_xfer_buf(unsigned char *buffer,\r\nunsigned int buflen, struct scsi_cmnd *srb, struct scatterlist **sgptr,\r\nunsigned int *offset, enum xfer_buf_dir dir)\r\n{\r\nunsigned int cnt;\r\nstruct scatterlist *sg = *sgptr;\r\nif (!sg)\r\nsg = scsi_sglist(srb);\r\ncnt = 0;\r\nwhile (cnt < buflen && sg) {\r\nstruct page *page = sg_page(sg) +\r\n((sg->offset + *offset) >> PAGE_SHIFT);\r\nunsigned int poff = (sg->offset + *offset) & (PAGE_SIZE-1);\r\nunsigned int sglen = sg->length - *offset;\r\nif (sglen > buflen - cnt) {\r\nsglen = buflen - cnt;\r\n*offset += sglen;\r\n} else {\r\n*offset = 0;\r\nsg = sg_next(sg);\r\n}\r\nwhile (sglen > 0) {\r\nunsigned int plen = min(sglen, (unsigned int)\r\nPAGE_SIZE - poff);\r\nunsigned char *ptr = kmap(page);\r\nif (dir == TO_XFER_BUF)\r\nmemcpy(ptr + poff, buffer + cnt, plen);\r\nelse\r\nmemcpy(buffer + cnt, ptr + poff, plen);\r\nkunmap(page);\r\npoff = 0;\r\n++page;\r\ncnt += plen;\r\nsglen -= plen;\r\n}\r\n}\r\n*sgptr = sg;\r\nreturn cnt;\r\n}\r\nvoid usb_stor_set_xfer_buf(unsigned char *buffer,\r\nunsigned int buflen, struct scsi_cmnd *srb)\r\n{\r\nunsigned int offset = 0;\r\nstruct scatterlist *sg = NULL;\r\nbuflen = min(buflen, scsi_bufflen(srb));\r\nbuflen = usb_stor_access_xfer_buf(buffer, buflen, srb, &sg, &offset,\r\nTO_XFER_BUF);\r\nif (buflen < scsi_bufflen(srb))\r\nscsi_set_resid(srb, scsi_bufflen(srb) - buflen);\r\n}

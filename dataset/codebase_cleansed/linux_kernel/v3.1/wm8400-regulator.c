static int wm8400_ldo_is_enabled(struct regulator_dev *dev)\r\n{\r\nstruct wm8400 *wm8400 = rdev_get_drvdata(dev);\r\nu16 val;\r\nval = wm8400_reg_read(wm8400, WM8400_LDO1_CONTROL + rdev_get_id(dev));\r\nreturn (val & WM8400_LDO1_ENA) != 0;\r\n}\r\nstatic int wm8400_ldo_enable(struct regulator_dev *dev)\r\n{\r\nstruct wm8400 *wm8400 = rdev_get_drvdata(dev);\r\nreturn wm8400_set_bits(wm8400, WM8400_LDO1_CONTROL + rdev_get_id(dev),\r\nWM8400_LDO1_ENA, WM8400_LDO1_ENA);\r\n}\r\nstatic int wm8400_ldo_disable(struct regulator_dev *dev)\r\n{\r\nstruct wm8400 *wm8400 = rdev_get_drvdata(dev);\r\nreturn wm8400_set_bits(wm8400, WM8400_LDO1_CONTROL + rdev_get_id(dev),\r\nWM8400_LDO1_ENA, 0);\r\n}\r\nstatic int wm8400_ldo_list_voltage(struct regulator_dev *dev,\r\nunsigned selector)\r\n{\r\nif (selector > WM8400_LDO1_VSEL_MASK)\r\nreturn -EINVAL;\r\nif (selector < 15)\r\nreturn 900000 + (selector * 50000);\r\nelse\r\nreturn 1600000 + ((selector - 14) * 100000);\r\n}\r\nstatic int wm8400_ldo_get_voltage_sel(struct regulator_dev *dev)\r\n{\r\nstruct wm8400 *wm8400 = rdev_get_drvdata(dev);\r\nu16 val;\r\nval = wm8400_reg_read(wm8400, WM8400_LDO1_CONTROL + rdev_get_id(dev));\r\nval &= WM8400_LDO1_VSEL_MASK;\r\nreturn val;\r\n}\r\nstatic int wm8400_ldo_set_voltage(struct regulator_dev *dev,\r\nint min_uV, int max_uV, unsigned *selector)\r\n{\r\nstruct wm8400 *wm8400 = rdev_get_drvdata(dev);\r\nu16 val;\r\nif (min_uV < 900000 || min_uV > 3300000)\r\nreturn -EINVAL;\r\nif (min_uV < 1700000) {\r\nval = (min_uV - 850001) / 50000;\r\nif ((val * 50000) + 900000 > max_uV)\r\nreturn -EINVAL;\r\nBUG_ON((val * 50000) + 900000 < min_uV);\r\n} else {\r\nval = ((min_uV - 1600001) / 100000);\r\nif ((val * 100000) + 1700000 > max_uV)\r\nreturn -EINVAL;\r\nBUG_ON((val * 100000) + 1700000 < min_uV);\r\nval += 0xf;\r\n}\r\n*selector = val;\r\nreturn wm8400_set_bits(wm8400, WM8400_LDO1_CONTROL + rdev_get_id(dev),\r\nWM8400_LDO1_VSEL_MASK, val);\r\n}\r\nstatic int wm8400_dcdc_is_enabled(struct regulator_dev *dev)\r\n{\r\nstruct wm8400 *wm8400 = rdev_get_drvdata(dev);\r\nint offset = (rdev_get_id(dev) - WM8400_DCDC1) * 2;\r\nu16 val;\r\nval = wm8400_reg_read(wm8400, WM8400_DCDC1_CONTROL_1 + offset);\r\nreturn (val & WM8400_DC1_ENA) != 0;\r\n}\r\nstatic int wm8400_dcdc_enable(struct regulator_dev *dev)\r\n{\r\nstruct wm8400 *wm8400 = rdev_get_drvdata(dev);\r\nint offset = (rdev_get_id(dev) - WM8400_DCDC1) * 2;\r\nreturn wm8400_set_bits(wm8400, WM8400_DCDC1_CONTROL_1 + offset,\r\nWM8400_DC1_ENA, WM8400_DC1_ENA);\r\n}\r\nstatic int wm8400_dcdc_disable(struct regulator_dev *dev)\r\n{\r\nstruct wm8400 *wm8400 = rdev_get_drvdata(dev);\r\nint offset = (rdev_get_id(dev) - WM8400_DCDC1) * 2;\r\nreturn wm8400_set_bits(wm8400, WM8400_DCDC1_CONTROL_1 + offset,\r\nWM8400_DC1_ENA, 0);\r\n}\r\nstatic int wm8400_dcdc_list_voltage(struct regulator_dev *dev,\r\nunsigned selector)\r\n{\r\nif (selector > WM8400_DC1_VSEL_MASK)\r\nreturn -EINVAL;\r\nreturn 850000 + (selector * 25000);\r\n}\r\nstatic int wm8400_dcdc_get_voltage_sel(struct regulator_dev *dev)\r\n{\r\nstruct wm8400 *wm8400 = rdev_get_drvdata(dev);\r\nu16 val;\r\nint offset = (rdev_get_id(dev) - WM8400_DCDC1) * 2;\r\nval = wm8400_reg_read(wm8400, WM8400_DCDC1_CONTROL_1 + offset);\r\nval &= WM8400_DC1_VSEL_MASK;\r\nreturn val;\r\n}\r\nstatic int wm8400_dcdc_set_voltage(struct regulator_dev *dev,\r\nint min_uV, int max_uV, unsigned *selector)\r\n{\r\nstruct wm8400 *wm8400 = rdev_get_drvdata(dev);\r\nu16 val;\r\nint offset = (rdev_get_id(dev) - WM8400_DCDC1) * 2;\r\nif (min_uV < 850000)\r\nreturn -EINVAL;\r\nval = (min_uV - 825001) / 25000;\r\nif (850000 + (25000 * val) > max_uV)\r\nreturn -EINVAL;\r\nBUG_ON(850000 + (25000 * val) < min_uV);\r\n*selector = val;\r\nreturn wm8400_set_bits(wm8400, WM8400_DCDC1_CONTROL_1 + offset,\r\nWM8400_DC1_VSEL_MASK, val);\r\n}\r\nstatic unsigned int wm8400_dcdc_get_mode(struct regulator_dev *dev)\r\n{\r\nstruct wm8400 *wm8400 = rdev_get_drvdata(dev);\r\nint offset = (rdev_get_id(dev) - WM8400_DCDC1) * 2;\r\nu16 data[2];\r\nint ret;\r\nret = wm8400_block_read(wm8400, WM8400_DCDC1_CONTROL_1 + offset, 2,\r\ndata);\r\nif (ret != 0)\r\nreturn 0;\r\nif (data[0] & WM8400_DC1_SLEEP)\r\nreturn REGULATOR_MODE_STANDBY;\r\nif (!(data[0] & WM8400_DC1_ACTIVE))\r\nreturn REGULATOR_MODE_IDLE;\r\nif (data[1] & WM8400_DC1_FRC_PWM)\r\nreturn REGULATOR_MODE_FAST;\r\nelse\r\nreturn REGULATOR_MODE_NORMAL;\r\n}\r\nstatic int wm8400_dcdc_set_mode(struct regulator_dev *dev, unsigned int mode)\r\n{\r\nstruct wm8400 *wm8400 = rdev_get_drvdata(dev);\r\nint offset = (rdev_get_id(dev) - WM8400_DCDC1) * 2;\r\nint ret;\r\nswitch (mode) {\r\ncase REGULATOR_MODE_FAST:\r\nret = wm8400_set_bits(wm8400, WM8400_DCDC1_CONTROL_2 + offset,\r\nWM8400_DC1_FRC_PWM, WM8400_DC1_FRC_PWM);\r\nif (ret != 0)\r\nreturn ret;\r\nreturn wm8400_set_bits(wm8400, WM8400_DCDC1_CONTROL_1 + offset,\r\nWM8400_DC1_ACTIVE | WM8400_DC1_SLEEP,\r\nWM8400_DC1_ACTIVE);\r\ncase REGULATOR_MODE_NORMAL:\r\nret = wm8400_set_bits(wm8400, WM8400_DCDC1_CONTROL_2 + offset,\r\nWM8400_DC1_FRC_PWM, 0);\r\nif (ret != 0)\r\nreturn ret;\r\nreturn wm8400_set_bits(wm8400, WM8400_DCDC1_CONTROL_1 + offset,\r\nWM8400_DC1_ACTIVE | WM8400_DC1_SLEEP,\r\nWM8400_DC1_ACTIVE);\r\ncase REGULATOR_MODE_IDLE:\r\nret = wm8400_set_bits(wm8400, WM8400_DCDC1_CONTROL_1 + offset,\r\nWM8400_DC1_ACTIVE, 0);\r\nif (ret != 0)\r\nreturn ret;\r\nreturn wm8400_set_bits(wm8400, WM8400_DCDC1_CONTROL_1 + offset,\r\nWM8400_DC1_SLEEP, 0);\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic unsigned int wm8400_dcdc_get_optimum_mode(struct regulator_dev *dev,\r\nint input_uV, int output_uV,\r\nint load_uA)\r\n{\r\nreturn REGULATOR_MODE_NORMAL;\r\n}\r\nstatic int __devinit wm8400_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct wm8400 *wm8400 = container_of(pdev, struct wm8400, regulators[pdev->id]);\r\nstruct regulator_dev *rdev;\r\nrdev = regulator_register(&regulators[pdev->id], &pdev->dev,\r\npdev->dev.platform_data, wm8400);\r\nif (IS_ERR(rdev))\r\nreturn PTR_ERR(rdev);\r\nplatform_set_drvdata(pdev, rdev);\r\nreturn 0;\r\n}\r\nstatic int __devexit wm8400_regulator_remove(struct platform_device *pdev)\r\n{\r\nstruct regulator_dev *rdev = platform_get_drvdata(pdev);\r\nplatform_set_drvdata(pdev, NULL);\r\nregulator_unregister(rdev);\r\nreturn 0;\r\n}\r\nint wm8400_register_regulator(struct device *dev, int reg,\r\nstruct regulator_init_data *initdata)\r\n{\r\nstruct wm8400 *wm8400 = dev_get_drvdata(dev);\r\nif (wm8400->regulators[reg].name)\r\nreturn -EBUSY;\r\ninitdata->driver_data = wm8400;\r\nwm8400->regulators[reg].name = "wm8400-regulator";\r\nwm8400->regulators[reg].id = reg;\r\nwm8400->regulators[reg].dev.parent = dev;\r\nwm8400->regulators[reg].dev.platform_data = initdata;\r\nreturn platform_device_register(&wm8400->regulators[reg]);\r\n}\r\nstatic int __init wm8400_regulator_init(void)\r\n{\r\nreturn platform_driver_register(&wm8400_regulator_driver);\r\n}\r\nstatic void __exit wm8400_regulator_exit(void)\r\n{\r\nplatform_driver_unregister(&wm8400_regulator_driver);\r\n}

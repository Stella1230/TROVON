static inline int dev_isalive(const struct net_device *dev)\r\n{\r\nreturn dev->reg_state == NETREG_REGISTERED;\r\n}\r\nstatic ssize_t show_tallies(struct device *d, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct net_device *dev = to_net_dev(d);\r\nstruct wl_private *lp = wl_priv(dev);\r\nunsigned long flags;\r\nCFG_HERMES_TALLIES_STRCT tallies;\r\nssize_t ret = -EINVAL;\r\nrcu_read_lock();\r\nif (dev_isalive(dev)) {\r\nwl_lock(lp, &flags);\r\nret = wl_get_tallies(lp, &tallies);\r\nif (ret == 0) {\r\nwl_unlock(lp, &flags);\r\nret = snprintf(buf, PAGE_SIZE,\r\n"TxUnicastFrames: %u\n"\r\n"TxMulticastFrames: %u\n"\r\n"TxFragments: %u\n"\r\n"TxUnicastOctets: %u\n"\r\n"TxMulticastOctets: %u\n"\r\n"TxDeferredTransmissions: %u\n"\r\n"TxSingleRetryFrames: %u\n"\r\n"TxMultipleRetryFrames: %u\n"\r\n"TxRetryLimitExceeded: %u\n"\r\n"TxDiscards: %u\n"\r\n"RxUnicastFrames: %u\n"\r\n"RxMulticastFrames: %u\n"\r\n"RxFragments: %u\n"\r\n"RxUnicastOctets: %u\n"\r\n"RxMulticastOctets: %u\n"\r\n"RxFCSErrors: %u\n"\r\n"RxDiscardsNoBuffer: %u\n"\r\n"TxDiscardsWrongSA: %u\n"\r\n"RxWEPUndecryptable: %u\n"\r\n"RxMsgInMsgFragments: %u\n"\r\n"RxMsgInBadMsgFragments: %u\n"\r\n"RxDiscardsWEPICVError: %u\n"\r\n"RxDiscardsWEPExcluded: %u\n"\r\n,\r\n(unsigned int)tallies.TxUnicastFrames,\r\n(unsigned int)tallies.TxMulticastFrames,\r\n(unsigned int)tallies.TxFragments,\r\n(unsigned int)tallies.TxUnicastOctets,\r\n(unsigned int)tallies.TxMulticastOctets,\r\n(unsigned int)tallies.TxDeferredTransmissions,\r\n(unsigned int)tallies.TxSingleRetryFrames,\r\n(unsigned int)tallies.TxMultipleRetryFrames,\r\n(unsigned int)tallies.TxRetryLimitExceeded,\r\n(unsigned int)tallies.TxDiscards,\r\n(unsigned int)tallies.RxUnicastFrames,\r\n(unsigned int)tallies.RxMulticastFrames,\r\n(unsigned int)tallies.RxFragments,\r\n(unsigned int)tallies.RxUnicastOctets,\r\n(unsigned int)tallies.RxMulticastOctets,\r\n(unsigned int)tallies.RxFCSErrors,\r\n(unsigned int)tallies.RxDiscardsNoBuffer,\r\n(unsigned int)tallies.TxDiscardsWrongSA,\r\n(unsigned int)tallies.RxWEPUndecryptable,\r\n(unsigned int)tallies.RxMsgInMsgFragments,\r\n(unsigned int)tallies.RxMsgInBadMsgFragments,\r\n(unsigned int)tallies.RxDiscardsWEPICVError,\r\n(unsigned int)tallies.RxDiscardsWEPExcluded);\r\n} else {\r\nwl_unlock( lp, &flags );\r\n}\r\n}\r\nrcu_read_unlock();\r\nreturn ret;\r\n}\r\nvoid register_wlags_sysfs(struct net_device *net)\r\n{\r\nstruct device *dev = &(net->dev);\r\nstruct wl_private *lp = wl_priv(net);\r\nlp->sysfsCreated = sysfs_create_group(&dev->kobj, &wlags_group);\r\n}\r\nvoid unregister_wlags_sysfs(struct net_device *net)\r\n{\r\nstruct device *dev = &(net->dev);\r\nstruct wl_private *lp = wl_priv(net);\r\nif (lp->sysfsCreated)\r\nsysfs_remove_group(&dev->kobj, &wlags_group);\r\n}

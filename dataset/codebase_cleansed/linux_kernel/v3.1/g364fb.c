int g364fb_cursor(struct fb_info *info, struct fb_cursor *cursor)\r\n{\r\nswitch (cursor->enable) {\r\ncase CM_ERASE:\r\n*(unsigned int *) CTLA_REG |= CURS_TOGGLE;\r\nbreak;\r\ncase CM_MOVE:\r\ncase CM_DRAW:\r\n*(unsigned int *) CTLA_REG &= ~CURS_TOGGLE;\r\n*(unsigned int *) CURS_POS_REG =\r\n((x * fontwidth(p)) << 12) | ((y * fontheight(p)) -\r\ninfo->var.yoffset);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int g364fb_pan_display(struct fb_var_screeninfo *var,\r\nstruct fb_info *info)\r\n{\r\nif (var->xoffset || var->yoffset + var->yres > var->yres_virtual)\r\nreturn -EINVAL;\r\n*(unsigned int *) TOP_REG = var->yoffset * var->xres;\r\nreturn 0;\r\n}\r\nstatic int g364fb_blank(int blank, struct fb_info *info)\r\n{\r\nif (blank)\r\n*(unsigned int *) CTLA_REG |= FORCE_BLANK;\r\nelse\r\n*(unsigned int *) CTLA_REG &= ~FORCE_BLANK;\r\nreturn 0;\r\n}\r\nstatic int g364fb_setcolreg(u_int regno, u_int red, u_int green,\r\nu_int blue, u_int transp, struct fb_info *info)\r\n{\r\nvolatile unsigned int *ptr = (volatile unsigned int *) CLR_PAL_REG;\r\nif (regno > 255)\r\nreturn 1;\r\nred >>= 8;\r\ngreen >>= 8;\r\nblue >>= 8;\r\nptr[regno << 1] = (red << 16) | (green << 8) | blue;\r\nreturn 0;\r\n}\r\nint __init g364fb_init(void)\r\n{\r\nvolatile unsigned int *pal_ptr =\r\n(volatile unsigned int *) CLR_PAL_REG;\r\nvolatile unsigned int *curs_pal_ptr =\r\n(volatile unsigned int *) CURS_PAL_REG;\r\nint mem, i, j;\r\nif (fb_get_options("g364fb", NULL))\r\nreturn -ENODEV;\r\n*(volatile unsigned int *) CTLA_REG &= ~ENABLE_VTG;\r\nfb_var.xres =\r\n(*((volatile unsigned int *) DISPLAY_REG) & 0x00ffffff) * 4;\r\nfb_var.yres =\r\n(*((volatile unsigned int *) VDISPLAY_REG) & 0x00ffffff) / 2;\r\n*(volatile unsigned int *) CTLA_REG |= ENABLE_VTG;\r\ncurs_pal_ptr[0] |= 0x00ffffff;\r\ncurs_pal_ptr[2] |= 0x00ffffff;\r\ncurs_pal_ptr[4] |= 0x00ffffff;\r\nfor (i = 0; i < 512; i++)\r\n*(unsigned short *) (CURS_PAT_REG + i * 8) = 0;\r\n*(unsigned short *) (CURS_PAT_REG + 14 * 64) = 0xffff;\r\n*(unsigned short *) (CURS_PAT_REG + 15 * 64) = 0xffff;\r\nfb_var.xres_virtual = fbvar.xres;\r\nfb_fix.line_length = (xres / 8) * fb_var.bits_per_pixel;\r\nfb_fix.smem_start = 0x40000000;\r\nmem = (r4030_read_reg32(JAZZ_R4030_CONFIG) >> 8) & 3;\r\nfb_fix.smem_len = (1 << (mem * 2)) * 512 * 1024;\r\nfb_var.yres_virtual = fb_fix.smem_len / fb_var.xres;\r\nfb_info.fbops = &g364fb_ops;\r\nfb_info.screen_base = (char *) G364_MEM_BASE;\r\nfb_info.var = fb_var;\r\nfb_info.fix = fb_fix;\r\nfb_info.flags = FBINFO_DEFAULT | FBINFO_HWACCEL_YPAN;\r\nfb_alloc_cmap(&fb_info.cmap, 255, 0);\r\nif (register_framebuffer(&fb_info) < 0)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}

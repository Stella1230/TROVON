static ssize_t jz4740_hwmon_show_name(struct device *dev,\r\nstruct device_attribute *dev_attr, char *buf)\r\n{\r\nreturn sprintf(buf, "jz4740\n");\r\n}\r\nstatic irqreturn_t jz4740_hwmon_irq(int irq, void *data)\r\n{\r\nstruct jz4740_hwmon *hwmon = data;\r\ncomplete(&hwmon->read_completion);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic ssize_t jz4740_hwmon_read_adcin(struct device *dev,\r\nstruct device_attribute *dev_attr, char *buf)\r\n{\r\nstruct jz4740_hwmon *hwmon = dev_get_drvdata(dev);\r\nstruct completion *completion = &hwmon->read_completion;\r\nunsigned long t;\r\nunsigned long val;\r\nint ret;\r\nmutex_lock(&hwmon->lock);\r\nINIT_COMPLETION(*completion);\r\nenable_irq(hwmon->irq);\r\nhwmon->cell->enable(to_platform_device(dev));\r\nt = wait_for_completion_interruptible_timeout(completion, HZ);\r\nif (t > 0) {\r\nval = readw(hwmon->base) & 0xfff;\r\nval = (val * 3300) >> 12;\r\nret = sprintf(buf, "%lu\n", val);\r\n} else {\r\nret = t ? t : -ETIMEDOUT;\r\n}\r\nhwmon->cell->disable(to_platform_device(dev));\r\ndisable_irq(hwmon->irq);\r\nmutex_unlock(&hwmon->lock);\r\nreturn ret;\r\n}\r\nstatic int __devinit jz4740_hwmon_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct jz4740_hwmon *hwmon;\r\nhwmon = kmalloc(sizeof(*hwmon), GFP_KERNEL);\r\nif (!hwmon) {\r\ndev_err(&pdev->dev, "Failed to allocate driver structure\n");\r\nreturn -ENOMEM;\r\n}\r\nhwmon->cell = mfd_get_cell(pdev);\r\nhwmon->irq = platform_get_irq(pdev, 0);\r\nif (hwmon->irq < 0) {\r\nret = hwmon->irq;\r\ndev_err(&pdev->dev, "Failed to get platform irq: %d\n", ret);\r\ngoto err_free;\r\n}\r\nhwmon->mem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!hwmon->mem) {\r\nret = -ENOENT;\r\ndev_err(&pdev->dev, "Failed to get platform mmio resource\n");\r\ngoto err_free;\r\n}\r\nhwmon->mem = request_mem_region(hwmon->mem->start,\r\nresource_size(hwmon->mem), pdev->name);\r\nif (!hwmon->mem) {\r\nret = -EBUSY;\r\ndev_err(&pdev->dev, "Failed to request mmio memory region\n");\r\ngoto err_free;\r\n}\r\nhwmon->base = ioremap_nocache(hwmon->mem->start,\r\nresource_size(hwmon->mem));\r\nif (!hwmon->base) {\r\nret = -EBUSY;\r\ndev_err(&pdev->dev, "Failed to ioremap mmio memory\n");\r\ngoto err_release_mem_region;\r\n}\r\ninit_completion(&hwmon->read_completion);\r\nmutex_init(&hwmon->lock);\r\nplatform_set_drvdata(pdev, hwmon);\r\nret = request_irq(hwmon->irq, jz4740_hwmon_irq, 0, pdev->name, hwmon);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to request irq: %d\n", ret);\r\ngoto err_iounmap;\r\n}\r\ndisable_irq(hwmon->irq);\r\nret = sysfs_create_group(&pdev->dev.kobj, &jz4740_hwmon_attr_group);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to create sysfs group: %d\n", ret);\r\ngoto err_free_irq;\r\n}\r\nhwmon->hwmon = hwmon_device_register(&pdev->dev);\r\nif (IS_ERR(hwmon->hwmon)) {\r\nret = PTR_ERR(hwmon->hwmon);\r\ngoto err_remove_file;\r\n}\r\nreturn 0;\r\nerr_remove_file:\r\nsysfs_remove_group(&pdev->dev.kobj, &jz4740_hwmon_attr_group);\r\nerr_free_irq:\r\nfree_irq(hwmon->irq, hwmon);\r\nerr_iounmap:\r\nplatform_set_drvdata(pdev, NULL);\r\niounmap(hwmon->base);\r\nerr_release_mem_region:\r\nrelease_mem_region(hwmon->mem->start, resource_size(hwmon->mem));\r\nerr_free:\r\nkfree(hwmon);\r\nreturn ret;\r\n}\r\nstatic int __devexit jz4740_hwmon_remove(struct platform_device *pdev)\r\n{\r\nstruct jz4740_hwmon *hwmon = platform_get_drvdata(pdev);\r\nhwmon_device_unregister(hwmon->hwmon);\r\nsysfs_remove_group(&pdev->dev.kobj, &jz4740_hwmon_attr_group);\r\nfree_irq(hwmon->irq, hwmon);\r\niounmap(hwmon->base);\r\nrelease_mem_region(hwmon->mem->start, resource_size(hwmon->mem));\r\nplatform_set_drvdata(pdev, NULL);\r\nkfree(hwmon);\r\nreturn 0;\r\n}\r\nstatic int __init jz4740_hwmon_init(void)\r\n{\r\nreturn platform_driver_register(&jz4740_hwmon_driver);\r\n}\r\nstatic void __exit jz4740_hwmon_exit(void)\r\n{\r\nplatform_driver_unregister(&jz4740_hwmon_driver);\r\n}

static int ab8500_regulator_enable(struct regulator_dev *rdev)\r\n{\r\nint ret;\r\nstruct ab8500_regulator_info *info = rdev_get_drvdata(rdev);\r\nif (info == NULL) {\r\ndev_err(rdev_get_dev(rdev), "regulator info null pointer\n");\r\nreturn -EINVAL;\r\n}\r\nret = abx500_mask_and_set_register_interruptible(info->dev,\r\ninfo->update_bank, info->update_reg,\r\ninfo->update_mask, info->update_val_enable);\r\nif (ret < 0)\r\ndev_err(rdev_get_dev(rdev),\r\n"couldn't set enable bits for regulator\n");\r\ndev_vdbg(rdev_get_dev(rdev),\r\n"%s-enable (bank, reg, mask, value): 0x%x, 0x%x, 0x%x, 0x%x\n",\r\ninfo->desc.name, info->update_bank, info->update_reg,\r\ninfo->update_mask, info->update_val_enable);\r\nreturn ret;\r\n}\r\nstatic int ab8500_regulator_disable(struct regulator_dev *rdev)\r\n{\r\nint ret;\r\nstruct ab8500_regulator_info *info = rdev_get_drvdata(rdev);\r\nif (info == NULL) {\r\ndev_err(rdev_get_dev(rdev), "regulator info null pointer\n");\r\nreturn -EINVAL;\r\n}\r\nret = abx500_mask_and_set_register_interruptible(info->dev,\r\ninfo->update_bank, info->update_reg,\r\ninfo->update_mask, 0x0);\r\nif (ret < 0)\r\ndev_err(rdev_get_dev(rdev),\r\n"couldn't set disable bits for regulator\n");\r\ndev_vdbg(rdev_get_dev(rdev),\r\n"%s-disable (bank, reg, mask, value): 0x%x, 0x%x, 0x%x, 0x%x\n",\r\ninfo->desc.name, info->update_bank, info->update_reg,\r\ninfo->update_mask, 0x0);\r\nreturn ret;\r\n}\r\nstatic int ab8500_regulator_is_enabled(struct regulator_dev *rdev)\r\n{\r\nint ret;\r\nstruct ab8500_regulator_info *info = rdev_get_drvdata(rdev);\r\nu8 regval;\r\nif (info == NULL) {\r\ndev_err(rdev_get_dev(rdev), "regulator info null pointer\n");\r\nreturn -EINVAL;\r\n}\r\nret = abx500_get_register_interruptible(info->dev,\r\ninfo->update_bank, info->update_reg, &regval);\r\nif (ret < 0) {\r\ndev_err(rdev_get_dev(rdev),\r\n"couldn't read 0x%x register\n", info->update_reg);\r\nreturn ret;\r\n}\r\ndev_vdbg(rdev_get_dev(rdev),\r\n"%s-is_enabled (bank, reg, mask, value): 0x%x, 0x%x, 0x%x,"\r\n" 0x%x\n",\r\ninfo->desc.name, info->update_bank, info->update_reg,\r\ninfo->update_mask, regval);\r\nif (regval & info->update_mask)\r\nreturn true;\r\nelse\r\nreturn false;\r\n}\r\nstatic int ab8500_list_voltage(struct regulator_dev *rdev, unsigned selector)\r\n{\r\nstruct ab8500_regulator_info *info = rdev_get_drvdata(rdev);\r\nif (info == NULL) {\r\ndev_err(rdev_get_dev(rdev), "regulator info null pointer\n");\r\nreturn -EINVAL;\r\n}\r\nif (info->fixed_uV)\r\nreturn info->fixed_uV;\r\nif (selector >= info->voltages_len)\r\nreturn -EINVAL;\r\nreturn info->voltages[selector];\r\n}\r\nstatic int ab8500_regulator_get_voltage(struct regulator_dev *rdev)\r\n{\r\nint ret, val;\r\nstruct ab8500_regulator_info *info = rdev_get_drvdata(rdev);\r\nu8 regval;\r\nif (info == NULL) {\r\ndev_err(rdev_get_dev(rdev), "regulator info null pointer\n");\r\nreturn -EINVAL;\r\n}\r\nret = abx500_get_register_interruptible(info->dev,\r\ninfo->voltage_bank, info->voltage_reg, &regval);\r\nif (ret < 0) {\r\ndev_err(rdev_get_dev(rdev),\r\n"couldn't read voltage reg for regulator\n");\r\nreturn ret;\r\n}\r\ndev_vdbg(rdev_get_dev(rdev),\r\n"%s-get_voltage (bank, reg, mask, value): 0x%x, 0x%x, 0x%x,"\r\n" 0x%x\n",\r\ninfo->desc.name, info->voltage_bank, info->voltage_reg,\r\ninfo->voltage_mask, regval);\r\nval = regval & info->voltage_mask;\r\nif (info->desc.id == AB8500_LDO_INTCORE)\r\nret = info->voltages[val >> 0x3];\r\nelse\r\nret = info->voltages[val];\r\nreturn ret;\r\n}\r\nstatic int ab8500_get_best_voltage_index(struct regulator_dev *rdev,\r\nint min_uV, int max_uV)\r\n{\r\nstruct ab8500_regulator_info *info = rdev_get_drvdata(rdev);\r\nint i;\r\nfor (i = 0; i < info->voltages_len; i++) {\r\nif ((info->voltages[i] >= min_uV) &&\r\n(info->voltages[i] <= max_uV))\r\nreturn i;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int ab8500_regulator_set_voltage(struct regulator_dev *rdev,\r\nint min_uV, int max_uV,\r\nunsigned *selector)\r\n{\r\nint ret;\r\nstruct ab8500_regulator_info *info = rdev_get_drvdata(rdev);\r\nu8 regval;\r\nif (info == NULL) {\r\ndev_err(rdev_get_dev(rdev), "regulator info null pointer\n");\r\nreturn -EINVAL;\r\n}\r\nret = ab8500_get_best_voltage_index(rdev, min_uV, max_uV);\r\nif (ret < 0) {\r\ndev_err(rdev_get_dev(rdev),\r\n"couldn't get best voltage for regulator\n");\r\nreturn ret;\r\n}\r\n*selector = ret;\r\nregval = (u8)ret;\r\nret = abx500_mask_and_set_register_interruptible(info->dev,\r\ninfo->voltage_bank, info->voltage_reg,\r\ninfo->voltage_mask, regval);\r\nif (ret < 0)\r\ndev_err(rdev_get_dev(rdev),\r\n"couldn't set voltage reg for regulator\n");\r\ndev_vdbg(rdev_get_dev(rdev),\r\n"%s-set_voltage (bank, reg, mask, value): 0x%x, 0x%x, 0x%x,"\r\n" 0x%x\n",\r\ninfo->desc.name, info->voltage_bank, info->voltage_reg,\r\ninfo->voltage_mask, regval);\r\nreturn ret;\r\n}\r\nstatic int ab8500_regulator_enable_time(struct regulator_dev *rdev)\r\n{\r\nstruct ab8500_regulator_info *info = rdev_get_drvdata(rdev);\r\nreturn info->delay;\r\n}\r\nstatic int ab8500_regulator_set_voltage_time_sel(struct regulator_dev *rdev,\r\nunsigned int old_sel,\r\nunsigned int new_sel)\r\n{\r\nstruct ab8500_regulator_info *info = rdev_get_drvdata(rdev);\r\nint ret;\r\nret = ab8500_regulator_is_enabled(rdev);\r\nif (ret < 0)\r\nreturn ret;\r\nif (!ret)\r\nreturn 0;\r\nreturn info->delay;\r\n}\r\nstatic int ab8500_fixed_get_voltage(struct regulator_dev *rdev)\r\n{\r\nstruct ab8500_regulator_info *info = rdev_get_drvdata(rdev);\r\nif (info == NULL) {\r\ndev_err(rdev_get_dev(rdev), "regulator info null pointer\n");\r\nreturn -EINVAL;\r\n}\r\nreturn info->fixed_uV;\r\n}\r\nstatic __devinit int ab8500_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct ab8500 *ab8500 = dev_get_drvdata(pdev->dev.parent);\r\nstruct ab8500_platform_data *pdata;\r\nint i, err;\r\nif (!ab8500) {\r\ndev_err(&pdev->dev, "null mfd parent\n");\r\nreturn -EINVAL;\r\n}\r\npdata = dev_get_platdata(ab8500->dev);\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "null pdata\n");\r\nreturn -EINVAL;\r\n}\r\nif (pdata->num_regulator != ARRAY_SIZE(ab8500_regulator_info)) {\r\ndev_err(&pdev->dev, "Configuration error: size mismatch.\n");\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; i < pdata->num_regulator_reg_init; i++) {\r\nint id;\r\nu8 value;\r\nid = pdata->regulator_reg_init[i].id;\r\nvalue = pdata->regulator_reg_init[i].value;\r\nif (id >= AB8500_NUM_REGULATOR_REGISTERS) {\r\ndev_err(&pdev->dev,\r\n"Configuration error: id outside range.\n");\r\nreturn -EINVAL;\r\n}\r\nif (value & ~ab8500_reg_init[id].mask) {\r\ndev_err(&pdev->dev,\r\n"Configuration error: value outside mask.\n");\r\nreturn -EINVAL;\r\n}\r\nerr = abx500_mask_and_set_register_interruptible(&pdev->dev,\r\nab8500_reg_init[id].bank,\r\nab8500_reg_init[id].addr,\r\nab8500_reg_init[id].mask,\r\nvalue);\r\nif (err < 0) {\r\ndev_err(&pdev->dev,\r\n"Failed to initialize 0x%02x, 0x%02x.\n",\r\nab8500_reg_init[id].bank,\r\nab8500_reg_init[id].addr);\r\nreturn err;\r\n}\r\ndev_vdbg(&pdev->dev,\r\n" init: 0x%02x, 0x%02x, 0x%02x, 0x%02x\n",\r\nab8500_reg_init[id].bank,\r\nab8500_reg_init[id].addr,\r\nab8500_reg_init[id].mask,\r\nvalue);\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(ab8500_regulator_info); i++) {\r\nstruct ab8500_regulator_info *info = NULL;\r\ninfo = &ab8500_regulator_info[i];\r\ninfo->dev = &pdev->dev;\r\nif (abx500_get_chip_id(info->dev) < 0x20) {\r\nif (info->desc.id == AB8500_LDO_AUX3) {\r\ninfo->desc.n_voltages =\r\nARRAY_SIZE(ldo_vauxn_voltages);\r\ninfo->voltages = ldo_vauxn_voltages;\r\ninfo->voltages_len =\r\nARRAY_SIZE(ldo_vauxn_voltages);\r\ninfo->voltage_mask = 0xf;\r\n}\r\n}\r\ninfo->regulator = regulator_register(&info->desc, &pdev->dev,\r\n&pdata->regulator[i], info);\r\nif (IS_ERR(info->regulator)) {\r\nerr = PTR_ERR(info->regulator);\r\ndev_err(&pdev->dev, "failed to register regulator %s\n",\r\ninfo->desc.name);\r\nwhile (--i >= 0) {\r\ninfo = &ab8500_regulator_info[i];\r\nregulator_unregister(info->regulator);\r\n}\r\nreturn err;\r\n}\r\ndev_vdbg(rdev_get_dev(info->regulator),\r\n"%s-probed\n", info->desc.name);\r\n}\r\nreturn 0;\r\n}\r\nstatic __devexit int ab8500_regulator_remove(struct platform_device *pdev)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(ab8500_regulator_info); i++) {\r\nstruct ab8500_regulator_info *info = NULL;\r\ninfo = &ab8500_regulator_info[i];\r\ndev_vdbg(rdev_get_dev(info->regulator),\r\n"%s-remove\n", info->desc.name);\r\nregulator_unregister(info->regulator);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init ab8500_regulator_init(void)\r\n{\r\nint ret;\r\nret = platform_driver_register(&ab8500_regulator_driver);\r\nif (ret != 0)\r\npr_err("Failed to register ab8500 regulator: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic void __exit ab8500_regulator_exit(void)\r\n{\r\nplatform_driver_unregister(&ab8500_regulator_driver);\r\n}

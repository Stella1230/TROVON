static void triflex_set_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nu32 triflex_timings = 0;\r\nu16 timing = 0;\r\nu8 channel_offset = hwif->channel ? 0x74 : 0x70, unit = drive->dn & 1;\r\npci_read_config_dword(dev, channel_offset, &triflex_timings);\r\nswitch (drive->dma_mode) {\r\ncase XFER_MW_DMA_2:\r\ntiming = 0x0103;\r\nbreak;\r\ncase XFER_MW_DMA_1:\r\ntiming = 0x0203;\r\nbreak;\r\ncase XFER_MW_DMA_0:\r\ntiming = 0x0808;\r\nbreak;\r\ncase XFER_SW_DMA_2:\r\ncase XFER_SW_DMA_1:\r\ncase XFER_SW_DMA_0:\r\ntiming = 0x0f0f;\r\nbreak;\r\ncase XFER_PIO_4:\r\ntiming = 0x0202;\r\nbreak;\r\ncase XFER_PIO_3:\r\ntiming = 0x0204;\r\nbreak;\r\ncase XFER_PIO_2:\r\ntiming = 0x0404;\r\nbreak;\r\ncase XFER_PIO_1:\r\ntiming = 0x0508;\r\nbreak;\r\ncase XFER_PIO_0:\r\ntiming = 0x0808;\r\nbreak;\r\n}\r\ntriflex_timings &= ~(0xFFFF << (16 * unit));\r\ntriflex_timings |= (timing << (16 * unit));\r\npci_write_config_dword(dev, channel_offset, triflex_timings);\r\n}\r\nstatic void triflex_set_pio_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\ndrive->dma_mode = drive->pio_mode;\r\ntriflex_set_mode(hwif, drive);\r\n}\r\nstatic int __devinit triflex_init_one(struct pci_dev *dev,\r\nconst struct pci_device_id *id)\r\n{\r\nreturn ide_pci_init_one(dev, &triflex_device, NULL);\r\n}\r\nstatic int __init triflex_ide_init(void)\r\n{\r\nreturn ide_pci_register_driver(&triflex_pci_driver);\r\n}\r\nstatic void __exit triflex_ide_exit(void)\r\n{\r\npci_unregister_driver(&triflex_pci_driver);\r\n}

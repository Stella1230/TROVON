static inline struct trace_bprintk_fmt *lookup_format(const char *fmt)\r\n{\r\nstruct trace_bprintk_fmt *pos;\r\nlist_for_each_entry(pos, &trace_bprintk_fmt_list, list) {\r\nif (!strcmp(pos->fmt, fmt))\r\nreturn pos;\r\n}\r\nreturn NULL;\r\n}\r\nstatic\r\nvoid hold_module_trace_bprintk_format(const char **start, const char **end)\r\n{\r\nconst char **iter;\r\nchar *fmt;\r\nmutex_lock(&btrace_mutex);\r\nfor (iter = start; iter < end; iter++) {\r\nstruct trace_bprintk_fmt *tb_fmt = lookup_format(*iter);\r\nif (tb_fmt) {\r\n*iter = tb_fmt->fmt;\r\ncontinue;\r\n}\r\ntb_fmt = kmalloc(sizeof(*tb_fmt), GFP_KERNEL);\r\nif (tb_fmt)\r\nfmt = kmalloc(strlen(*iter) + 1, GFP_KERNEL);\r\nif (tb_fmt && fmt) {\r\nlist_add_tail(&tb_fmt->list, &trace_bprintk_fmt_list);\r\nstrcpy(fmt, *iter);\r\ntb_fmt->fmt = fmt;\r\n*iter = tb_fmt->fmt;\r\n} else {\r\nkfree(tb_fmt);\r\n*iter = NULL;\r\n}\r\n}\r\nmutex_unlock(&btrace_mutex);\r\n}\r\nstatic int module_trace_bprintk_format_notify(struct notifier_block *self,\r\nunsigned long val, void *data)\r\n{\r\nstruct module *mod = data;\r\nif (mod->num_trace_bprintk_fmt) {\r\nconst char **start = mod->trace_bprintk_fmt_start;\r\nconst char **end = start + mod->num_trace_bprintk_fmt;\r\nif (val == MODULE_STATE_COMING)\r\nhold_module_trace_bprintk_format(start, end);\r\n}\r\nreturn 0;\r\n}\r\nstatic const char **\r\nfind_next_mod_format(int start_index, void *v, const char **fmt, loff_t *pos)\r\n{\r\nstruct trace_bprintk_fmt *mod_fmt;\r\nif (list_empty(&trace_bprintk_fmt_list))\r\nreturn NULL;\r\nif (!v || start_index == *pos) {\r\nstruct trace_bprintk_fmt *p;\r\nlist_for_each_entry(p, &trace_bprintk_fmt_list, list) {\r\nif (start_index == *pos)\r\nreturn &p->fmt;\r\nstart_index++;\r\n}\r\nreturn NULL;\r\n}\r\nmod_fmt = container_of(v, typeof(*mod_fmt), fmt);\r\nif (mod_fmt->list.next == &trace_bprintk_fmt_list)\r\nreturn NULL;\r\nmod_fmt = container_of(mod_fmt->list.next, typeof(*mod_fmt), list);\r\nreturn &mod_fmt->fmt;\r\n}\r\nstatic void format_mod_start(void)\r\n{\r\nmutex_lock(&btrace_mutex);\r\n}\r\nstatic void format_mod_stop(void)\r\n{\r\nmutex_unlock(&btrace_mutex);\r\n}\r\n__init static int\r\nmodule_trace_bprintk_format_notify(struct notifier_block *self,\r\nunsigned long val, void *data)\r\n{\r\nreturn 0;\r\n}\r\nstatic inline const char **\r\nfind_next_mod_format(int start_index, void *v, const char **fmt, loff_t *pos)\r\n{\r\nreturn NULL;\r\n}\r\nstatic inline void format_mod_start(void) { }\r\nstatic inline void format_mod_stop(void) { }\r\nint __trace_bprintk(unsigned long ip, const char *fmt, ...)\r\n{\r\nint ret;\r\nva_list ap;\r\nif (unlikely(!fmt))\r\nreturn 0;\r\nif (!(trace_flags & TRACE_ITER_PRINTK))\r\nreturn 0;\r\nva_start(ap, fmt);\r\nret = trace_vbprintk(ip, fmt, ap);\r\nva_end(ap);\r\nreturn ret;\r\n}\r\nint __ftrace_vbprintk(unsigned long ip, const char *fmt, va_list ap)\r\n{\r\nif (unlikely(!fmt))\r\nreturn 0;\r\nif (!(trace_flags & TRACE_ITER_PRINTK))\r\nreturn 0;\r\nreturn trace_vbprintk(ip, fmt, ap);\r\n}\r\nint __trace_printk(unsigned long ip, const char *fmt, ...)\r\n{\r\nint ret;\r\nva_list ap;\r\nif (!(trace_flags & TRACE_ITER_PRINTK))\r\nreturn 0;\r\nva_start(ap, fmt);\r\nret = trace_vprintk(ip, fmt, ap);\r\nva_end(ap);\r\nreturn ret;\r\n}\r\nint __ftrace_vprintk(unsigned long ip, const char *fmt, va_list ap)\r\n{\r\nif (!(trace_flags & TRACE_ITER_PRINTK))\r\nreturn 0;\r\nreturn trace_vprintk(ip, fmt, ap);\r\n}\r\nstatic const char **find_next(void *v, loff_t *pos)\r\n{\r\nconst char **fmt = v;\r\nint start_index;\r\nstart_index = __stop___trace_bprintk_fmt - __start___trace_bprintk_fmt;\r\nif (*pos < start_index)\r\nreturn __start___trace_bprintk_fmt + *pos;\r\nreturn find_next_mod_format(start_index, v, fmt, pos);\r\n}\r\nstatic void *\r\nt_start(struct seq_file *m, loff_t *pos)\r\n{\r\nformat_mod_start();\r\nreturn find_next(NULL, pos);\r\n}\r\nstatic void *t_next(struct seq_file *m, void * v, loff_t *pos)\r\n{\r\n(*pos)++;\r\nreturn find_next(v, pos);\r\n}\r\nstatic int t_show(struct seq_file *m, void *v)\r\n{\r\nconst char **fmt = v;\r\nconst char *str = *fmt;\r\nint i;\r\nseq_printf(m, "0x%lx : \"", *(unsigned long *)fmt);\r\nfor (i = 0; str[i]; i++) {\r\nswitch (str[i]) {\r\ncase '\n':\r\nseq_puts(m, "\\n");\r\nbreak;\r\ncase '\t':\r\nseq_puts(m, "\\t");\r\nbreak;\r\ncase '\\':\r\nseq_puts(m, "\\");\r\nbreak;\r\ncase '"':\r\nseq_puts(m, "\\\"");\r\nbreak;\r\ndefault:\r\nseq_putc(m, str[i]);\r\n}\r\n}\r\nseq_puts(m, "\"\n");\r\nreturn 0;\r\n}\r\nstatic void t_stop(struct seq_file *m, void *p)\r\n{\r\nformat_mod_stop();\r\n}\r\nstatic int\r\nftrace_formats_open(struct inode *inode, struct file *file)\r\n{\r\nreturn seq_open(file, &show_format_seq_ops);\r\n}\r\nstatic __init int init_trace_printk_function_export(void)\r\n{\r\nstruct dentry *d_tracer;\r\nd_tracer = tracing_init_dentry();\r\nif (!d_tracer)\r\nreturn 0;\r\ntrace_create_file("printk_formats", 0444, d_tracer,\r\nNULL, &ftrace_formats_fops);\r\nreturn 0;\r\n}\r\nstatic __init int init_trace_printk(void)\r\n{\r\nreturn register_module_notifier(&module_trace_bprintk_format_nb);\r\n}

static int max8952_read_reg(struct max8952_data *max8952, u8 reg)\r\n{\r\nint ret = i2c_smbus_read_byte_data(max8952->client, reg);\r\nif (ret > 0)\r\nret &= 0xff;\r\nreturn ret;\r\n}\r\nstatic int max8952_write_reg(struct max8952_data *max8952,\r\nu8 reg, u8 value)\r\n{\r\nreturn i2c_smbus_write_byte_data(max8952->client, reg, value);\r\n}\r\nstatic int max8952_voltage(struct max8952_data *max8952, u8 mode)\r\n{\r\nreturn (max8952->pdata->dvs_mode[mode] * 10 + 770) * 1000;\r\n}\r\nstatic int max8952_list_voltage(struct regulator_dev *rdev,\r\nunsigned int selector)\r\n{\r\nstruct max8952_data *max8952 = rdev_get_drvdata(rdev);\r\nif (rdev_get_id(rdev) != 0)\r\nreturn -EINVAL;\r\nreturn max8952_voltage(max8952, selector);\r\n}\r\nstatic int max8952_is_enabled(struct regulator_dev *rdev)\r\n{\r\nstruct max8952_data *max8952 = rdev_get_drvdata(rdev);\r\nreturn max8952->en;\r\n}\r\nstatic int max8952_enable(struct regulator_dev *rdev)\r\n{\r\nstruct max8952_data *max8952 = rdev_get_drvdata(rdev);\r\nif (gpio_is_valid(max8952->pdata->gpio_en))\r\ngpio_set_value(max8952->pdata->gpio_en, 1);\r\nmax8952->en = true;\r\nreturn 0;\r\n}\r\nstatic int max8952_disable(struct regulator_dev *rdev)\r\n{\r\nstruct max8952_data *max8952 = rdev_get_drvdata(rdev);\r\nif (gpio_is_valid(max8952->pdata->gpio_en))\r\ngpio_set_value(max8952->pdata->gpio_en, 0);\r\nelse\r\nreturn -EPERM;\r\nmax8952->en = false;\r\nreturn 0;\r\n}\r\nstatic int max8952_get_voltage(struct regulator_dev *rdev)\r\n{\r\nstruct max8952_data *max8952 = rdev_get_drvdata(rdev);\r\nu8 vid = 0;\r\nif (max8952->vid0)\r\nvid += 1;\r\nif (max8952->vid1)\r\nvid += 2;\r\nreturn max8952_voltage(max8952, vid);\r\n}\r\nstatic int max8952_set_voltage(struct regulator_dev *rdev,\r\nint min_uV, int max_uV, unsigned *selector)\r\n{\r\nstruct max8952_data *max8952 = rdev_get_drvdata(rdev);\r\ns8 vid = -1, i;\r\nif (!gpio_is_valid(max8952->pdata->gpio_vid0) ||\r\n!gpio_is_valid(max8952->pdata->gpio_vid1)) {\r\nreturn -EPERM;\r\n}\r\nfor (i = 0; i < MAX8952_NUM_DVS_MODE; i++) {\r\nint volt = max8952_voltage(max8952, i);\r\nif (volt <= max_uV && volt >= min_uV)\r\nif (vid == -1 || max8952_voltage(max8952, vid) > volt)\r\nvid = i;\r\n}\r\nif (vid >= 0 && vid < MAX8952_NUM_DVS_MODE) {\r\nmax8952->vid0 = (vid % 2 == 1);\r\nmax8952->vid1 = (((vid >> 1) % 2) == 1);\r\n*selector = vid;\r\ngpio_set_value(max8952->pdata->gpio_vid0, max8952->vid0);\r\ngpio_set_value(max8952->pdata->gpio_vid1, max8952->vid1);\r\n} else\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int __devinit max8952_pmic_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *i2c_id)\r\n{\r\nstruct i2c_adapter *adapter = to_i2c_adapter(client->dev.parent);\r\nstruct max8952_platform_data *pdata = client->dev.platform_data;\r\nstruct max8952_data *max8952;\r\nint ret = 0, err = 0;\r\nif (!pdata) {\r\ndev_err(&client->dev, "Require the platform data\n");\r\nreturn -EINVAL;\r\n}\r\nif (!i2c_check_functionality(adapter, I2C_FUNC_SMBUS_BYTE))\r\nreturn -EIO;\r\nmax8952 = kzalloc(sizeof(struct max8952_data), GFP_KERNEL);\r\nif (!max8952)\r\nreturn -ENOMEM;\r\nmax8952->client = client;\r\nmax8952->dev = &client->dev;\r\nmax8952->pdata = pdata;\r\nmutex_init(&max8952->mutex);\r\nmax8952->rdev = regulator_register(&regulator, max8952->dev,\r\n&pdata->reg_data, max8952);\r\nif (IS_ERR(max8952->rdev)) {\r\nret = PTR_ERR(max8952->rdev);\r\ndev_err(max8952->dev, "regulator init failed (%d)\n", ret);\r\ngoto err_reg;\r\n}\r\nmax8952->en = !!(pdata->reg_data.constraints.boot_on);\r\nmax8952->vid0 = (pdata->default_mode % 2) == 1;\r\nmax8952->vid1 = ((pdata->default_mode >> 1) % 2) == 1;\r\nif (gpio_is_valid(pdata->gpio_en)) {\r\nif (!gpio_request(pdata->gpio_en, "MAX8952 EN"))\r\ngpio_direction_output(pdata->gpio_en, max8952->en);\r\nelse\r\nerr = 1;\r\n} else\r\nerr = 2;\r\nif (err) {\r\ndev_info(max8952->dev, "EN gpio invalid: assume that EN"\r\n"is always High\n");\r\nmax8952->en = 1;\r\npdata->gpio_en = -1;\r\n}\r\nerr = 0;\r\nif (gpio_is_valid(pdata->gpio_vid0) &&\r\ngpio_is_valid(pdata->gpio_vid1)) {\r\nif (!gpio_request(pdata->gpio_vid0, "MAX8952 VID0"))\r\ngpio_direction_output(pdata->gpio_vid0,\r\n(pdata->default_mode) % 2);\r\nelse\r\nerr = 1;\r\nif (!gpio_request(pdata->gpio_vid1, "MAX8952 VID1"))\r\ngpio_direction_output(pdata->gpio_vid1,\r\n(pdata->default_mode >> 1) % 2);\r\nelse {\r\nif (!err)\r\ngpio_free(pdata->gpio_vid0);\r\nerr = 2;\r\n}\r\n} else\r\nerr = 3;\r\nif (err) {\r\ndev_warn(max8952->dev, "VID0/1 gpio invalid: "\r\n"DVS not available.\n");\r\nmax8952->vid0 = 0;\r\nmax8952->vid1 = 0;\r\npdata->gpio_vid0 = -1;\r\npdata->gpio_vid1 = -1;\r\nmax8952_write_reg(max8952, MAX8952_REG_CONTROL, 0x60);\r\ndev_err(max8952->dev, "DVS modes disabled because VID0 and VID1"\r\n" do not have proper controls.\n");\r\n} else {\r\nmax8952_write_reg(max8952, MAX8952_REG_CONTROL, 0x0);\r\n}\r\nmax8952_write_reg(max8952, MAX8952_REG_MODE0,\r\n(max8952_read_reg(max8952,\r\nMAX8952_REG_MODE0) & 0xC0) |\r\n(pdata->dvs_mode[0] & 0x3F));\r\nmax8952_write_reg(max8952, MAX8952_REG_MODE1,\r\n(max8952_read_reg(max8952,\r\nMAX8952_REG_MODE1) & 0xC0) |\r\n(pdata->dvs_mode[1] & 0x3F));\r\nmax8952_write_reg(max8952, MAX8952_REG_MODE2,\r\n(max8952_read_reg(max8952,\r\nMAX8952_REG_MODE2) & 0xC0) |\r\n(pdata->dvs_mode[2] & 0x3F));\r\nmax8952_write_reg(max8952, MAX8952_REG_MODE3,\r\n(max8952_read_reg(max8952,\r\nMAX8952_REG_MODE3) & 0xC0) |\r\n(pdata->dvs_mode[3] & 0x3F));\r\nmax8952_write_reg(max8952, MAX8952_REG_SYNC,\r\n(max8952_read_reg(max8952, MAX8952_REG_SYNC) & 0x3F) |\r\n((pdata->sync_freq & 0x3) << 6));\r\nmax8952_write_reg(max8952, MAX8952_REG_RAMP,\r\n(max8952_read_reg(max8952, MAX8952_REG_RAMP) & 0x1F) |\r\n((pdata->ramp_speed & 0x7) << 5));\r\ni2c_set_clientdata(client, max8952);\r\nreturn 0;\r\nerr_reg:\r\nkfree(max8952);\r\nreturn ret;\r\n}\r\nstatic int __devexit max8952_pmic_remove(struct i2c_client *client)\r\n{\r\nstruct max8952_data *max8952 = i2c_get_clientdata(client);\r\nstruct max8952_platform_data *pdata = max8952->pdata;\r\nstruct regulator_dev *rdev = max8952->rdev;\r\nregulator_unregister(rdev);\r\ngpio_free(pdata->gpio_vid0);\r\ngpio_free(pdata->gpio_vid1);\r\ngpio_free(pdata->gpio_en);\r\nkfree(max8952);\r\nreturn 0;\r\n}\r\nstatic int __init max8952_pmic_init(void)\r\n{\r\nreturn i2c_add_driver(&max8952_pmic_driver);\r\n}\r\nstatic void __exit max8952_pmic_exit(void)\r\n{\r\ni2c_del_driver(&max8952_pmic_driver);\r\n}

static int Enable_SRAM(void)\r\n{\r\nu32 ALong;\r\nif (mv643xx_reg_base == NULL)\r\nmv643xx_reg_base = ioremap(PEGASOS2_MARVELL_REGBASE,\r\nPEGASOS2_MARVELL_REGSIZE);\r\nif (mv643xx_reg_base == NULL)\r\nreturn -ENOMEM;\r\n#ifdef BE_VERBOSE\r\nprintk("Pegasos II/Marvell MV64361: register remapped from %p to %p\n",\r\n(void *)PEGASOS2_MARVELL_REGBASE, (void *)mv643xx_reg_base);\r\n#endif\r\nMV_WRITE(MV64340_SRAM_CONFIG, 0);\r\nMV_WRITE(MV64340_INTEGRATED_SRAM_BASE_ADDR, PEGASOS2_SRAM_BASE >> 16);\r\nMV_READ(MV64340_BASE_ADDR_ENABLE, ALong);\r\nALong &= ~(1 << 19);\r\nMV_WRITE(MV64340_BASE_ADDR_ENABLE, ALong);\r\nALong = 0x02;\r\nALong |= PEGASOS2_SRAM_BASE & 0xffff0000;\r\nMV_WRITE(MV643XX_ETH_BAR_4, ALong);\r\nMV_WRITE(MV643XX_ETH_SIZE_REG_4, (PEGASOS2_SRAM_SIZE-1) & 0xffff0000);\r\nMV_READ(MV643XX_ETH_BASE_ADDR_ENABLE_REG, ALong);\r\nALong &= ~(1 << 4);\r\nMV_WRITE(MV643XX_ETH_BASE_ADDR_ENABLE_REG, ALong);\r\n#ifdef BE_VERBOSE\r\nprintk("Pegasos II/Marvell MV64361: register unmapped\n");\r\nprintk("Pegasos II/Marvell MV64361: SRAM at %p, size=%x\n", (void*) PEGASOS2_SRAM_BASE, PEGASOS2_SRAM_SIZE);\r\n#endif\r\niounmap(mv643xx_reg_base);\r\nmv643xx_reg_base = NULL;\r\nreturn 1;\r\n}\r\nstatic int __init mv643xx_eth_add_pds(void)\r\n{\r\nint ret = 0;\r\nstatic struct pci_device_id pci_marvell_mv64360[] = {\r\n{ PCI_DEVICE(PCI_VENDOR_ID_MARVELL, PCI_DEVICE_ID_MARVELL_MV64360) },\r\n{ }\r\n};\r\n#ifdef BE_VERBOSE\r\nprintk("Pegasos II/Marvell MV64361: init\n");\r\n#endif\r\nif (pci_dev_present(pci_marvell_mv64360)) {\r\nret = platform_add_devices(mv643xx_eth_pd_devs,\r\nARRAY_SIZE(mv643xx_eth_pd_devs));\r\nif ( Enable_SRAM() < 0)\r\n{\r\neth_port1_pd.tx_sram_addr = 0;\r\neth_port1_pd.tx_sram_size = 0;\r\neth_port1_pd.rx_sram_addr = 0;\r\neth_port1_pd.rx_sram_size = 0;\r\n#ifdef BE_VERBOSE\r\nprintk("Pegasos II/Marvell MV64361: Can't enable the "\r\n"SRAM\n");\r\n#endif\r\n}\r\n}\r\n#ifdef BE_VERBOSE\r\nprintk("Pegasos II/Marvell MV64361: init is over\n");\r\n#endif\r\nreturn ret;\r\n}

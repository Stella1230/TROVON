static int __devinit cnt_driver_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *ent)\r\n{\r\nreturn comedi_pci_auto_config(dev, cnt_driver.driver_name);\r\n}\r\nstatic void __devexit cnt_driver_pci_remove(struct pci_dev *dev)\r\n{\r\ncomedi_pci_auto_unconfig(dev);\r\n}\r\nstatic int __init cnt_driver_init_module(void)\r\n{\r\nint retval;\r\nretval = comedi_driver_register(&cnt_driver);\r\nif (retval < 0)\r\nreturn retval;\r\ncnt_driver_pci_driver.name = (char *)cnt_driver.driver_name;\r\nreturn pci_register_driver(&cnt_driver_pci_driver);\r\n}\r\nstatic void __exit cnt_driver_cleanup_module(void)\r\n{\r\npci_unregister_driver(&cnt_driver_pci_driver);\r\ncomedi_driver_unregister(&cnt_driver);\r\n}\r\nstatic int cnt_winsn(struct comedi_device *dev,\r\nstruct comedi_subdevice *s, struct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nint chan = CR_CHAN(insn->chanspec);\r\noutb((unsigned char)((data[0] >> 24) & 0xff),\r\ndev->iobase + chan * 0x20 + 0x10);\r\noutb((unsigned char)((data[0] >> 16) & 0xff),\r\ndev->iobase + chan * 0x20 + 0x0c);\r\noutb((unsigned char)((data[0] >> 8) & 0xff),\r\ndev->iobase + chan * 0x20 + 0x08);\r\noutb((unsigned char)((data[0] >> 0) & 0xff),\r\ndev->iobase + chan * 0x20 + 0x04);\r\nreturn 1;\r\n}\r\nstatic int cnt_rinsn(struct comedi_device *dev,\r\nstruct comedi_subdevice *s, struct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nunsigned char a0, a1, a2, a3, a4;\r\nint chan = CR_CHAN(insn->chanspec);\r\nint result;\r\na0 = inb(dev->iobase + chan * 0x20);\r\na1 = inb(dev->iobase + chan * 0x20 + 0x04);\r\na2 = inb(dev->iobase + chan * 0x20 + 0x08);\r\na3 = inb(dev->iobase + chan * 0x20 + 0x0c);\r\na4 = inb(dev->iobase + chan * 0x20 + 0x10);\r\nresult = (a1 + (a2 * 256) + (a3 * 65536));\r\nif (a4 > 0)\r\nresult = result - s->maxdata;\r\n*data = (unsigned int)result;\r\nreturn 1;\r\n}\r\nstatic int cnt_attach(struct comedi_device *dev, struct comedi_devconfig *it)\r\n{\r\nstruct comedi_subdevice *subdevice;\r\nstruct pci_dev *pci_device = NULL;\r\nstruct cnt_board_struct *board;\r\nunsigned long io_base;\r\nint error, i;\r\nerror = alloc_private(dev, sizeof(struct cnt_device_private));\r\nif (error < 0)\r\nreturn error;\r\nfor_each_pci_dev(pci_device) {\r\nif (pci_device->vendor == PCI_VENDOR_ID_KOLTER) {\r\nfor (i = 0; i < cnt_board_nbr; i++) {\r\nif (cnt_boards[i].device_id ==\r\npci_device->device) {\r\nif ((it->options[0] != 0)\r\n|| (it->options[1] != 0)) {\r\nif (pci_device->bus->number !=\r\nit->options[0]\r\n||\r\nPCI_SLOT(pci_device->devfn)\r\n!= it->options[1]) {\r\ncontinue;\r\n}\r\n}\r\ndev->board_ptr = cnt_boards + i;\r\nboard =\r\n(struct cnt_board_struct *)\r\ndev->board_ptr;\r\ngoto found;\r\n}\r\n}\r\n}\r\n}\r\nprintk(KERN_WARNING\r\n"comedi%d: no supported board found! (req. bus/slot: %d/%d)\n",\r\ndev->minor, it->options[0], it->options[1]);\r\nreturn -EIO;\r\nfound:\r\nprintk(KERN_INFO\r\n"comedi%d: found %s at PCI bus %d, slot %d\n", dev->minor,\r\nboard->name, pci_device->bus->number,\r\nPCI_SLOT(pci_device->devfn));\r\ndevpriv->pcidev = pci_device;\r\ndev->board_name = board->name;\r\nerror = comedi_pci_enable(pci_device, CNT_DRIVER_NAME);\r\nif (error < 0) {\r\nprintk(KERN_WARNING "comedi%d: "\r\n"failed to enable PCI device and request regions!\n",\r\ndev->minor);\r\nreturn error;\r\n}\r\nio_base = pci_resource_start(pci_device, 0);\r\ndev->iobase = io_base;\r\nerror = alloc_subdevices(dev, 1);\r\nif (error < 0)\r\nreturn error;\r\nsubdevice = dev->subdevices + 0;\r\ndev->read_subdev = subdevice;\r\nsubdevice->type = COMEDI_SUBD_COUNTER;\r\nsubdevice->subdev_flags = SDF_READABLE ;\r\nsubdevice->n_chan = board->cnt_channel_nbr;\r\nsubdevice->maxdata = (1 << board->cnt_bits) - 1;\r\nsubdevice->insn_read = cnt_rinsn;\r\nsubdevice->insn_write = cnt_winsn;\r\noutb(3, dev->iobase + 248);\r\noutb(0, dev->iobase);\r\noutb(0, dev->iobase + 0x20);\r\noutb(0, dev->iobase + 0x40);\r\nprintk(KERN_INFO "comedi%d: " CNT_DRIVER_NAME " attached.\n",\r\ndev->minor);\r\nreturn 0;\r\n}\r\nstatic int cnt_detach(struct comedi_device *dev)\r\n{\r\nif (devpriv && devpriv->pcidev) {\r\nif (dev->iobase)\r\ncomedi_pci_disable(devpriv->pcidev);\r\npci_dev_put(devpriv->pcidev);\r\n}\r\nprintk(KERN_INFO "comedi%d: " CNT_DRIVER_NAME " remove\n",\r\ndev->minor);\r\nreturn 0;\r\n}

static int __init driver_dnp_init_module(void)\r\n{\r\nreturn comedi_driver_register(&driver_dnp);\r\n}\r\nstatic void __exit driver_dnp_cleanup_module(void)\r\n{\r\ncomedi_driver_unregister(&driver_dnp);\r\n}\r\nstatic int dnp_attach(struct comedi_device *dev, struct comedi_devconfig *it)\r\n{\r\nstruct comedi_subdevice *s;\r\nprintk(KERN_INFO "comedi%d: dnp: ", dev->minor);\r\ndev->board_name = thisboard->name;\r\nif (alloc_private(dev, sizeof(struct dnp_private_data)) < 0)\r\nreturn -ENOMEM;\r\nif (alloc_subdevices(dev, 1) < 0)\r\nreturn -ENOMEM;\r\ns = dev->subdevices + 0;\r\ns->type = COMEDI_SUBD_DIO;\r\ns->subdev_flags = SDF_READABLE | SDF_WRITABLE;\r\ns->n_chan = 20;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits = dnp_dio_insn_bits;\r\ns->insn_config = dnp_dio_insn_config;\r\nprintk("attached\n");\r\noutb(PAMR, CSCIR);\r\noutb(0x00, CSCDR);\r\noutb(PBMR, CSCIR);\r\noutb(0x00, CSCDR);\r\noutb(PCMR, CSCIR);\r\noutb((inb(CSCDR) & 0xAA), CSCDR);\r\nreturn 1;\r\n}\r\nstatic int dnp_detach(struct comedi_device *dev)\r\n{\r\noutb(PAMR, CSCIR);\r\noutb(0x00, CSCDR);\r\noutb(PBMR, CSCIR);\r\noutb(0x00, CSCDR);\r\noutb(PCMR, CSCIR);\r\noutb((inb(CSCDR) & 0xAA), CSCDR);\r\nprintk(KERN_INFO "comedi%d: dnp: remove\n", dev->minor);\r\nreturn 0;\r\n}\r\nstatic int dnp_dio_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nif (insn->n != 2)\r\nreturn -EINVAL;\r\nif (data[0]) {\r\noutb(PADR, CSCIR);\r\noutb((inb(CSCDR)\r\n& ~(u8) (data[0] & 0x0000FF))\r\n| (u8) (data[1] & 0x0000FF), CSCDR);\r\noutb(PBDR, CSCIR);\r\noutb((inb(CSCDR)\r\n& ~(u8) ((data[0] & 0x00FF00) >> 8))\r\n| (u8) ((data[1] & 0x00FF00) >> 8), CSCDR);\r\noutb(PCDR, CSCIR);\r\noutb((inb(CSCDR)\r\n& ~(u8) ((data[0] & 0x0F0000) >> 12))\r\n| (u8) ((data[1] & 0x0F0000) >> 12), CSCDR);\r\n}\r\noutb(PADR, CSCIR);\r\ndata[0] = inb(CSCDR);\r\noutb(PBDR, CSCIR);\r\ndata[0] += inb(CSCDR) << 8;\r\noutb(PCDR, CSCIR);\r\ndata[0] += ((inb(CSCDR) & 0xF0) << 12);\r\nreturn 2;\r\n}\r\nstatic int dnp_dio_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nu8 register_buffer;\r\nint chan = CR_CHAN(insn->chanspec);\r\nswitch (data[0]) {\r\ncase INSN_CONFIG_DIO_OUTPUT:\r\ncase INSN_CONFIG_DIO_INPUT:\r\nbreak;\r\ncase INSN_CONFIG_DIO_QUERY:\r\ndata[1] =\r\n(inb(CSCDR) & (1 << chan)) ? COMEDI_OUTPUT : COMEDI_INPUT;\r\nreturn insn->n;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\nif ((chan >= 0) && (chan <= 7)) {\r\noutb(PAMR, CSCIR);\r\n} else if ((chan >= 8) && (chan <= 15)) {\r\nchan -= 8;\r\noutb(PBMR, CSCIR);\r\n} else if ((chan >= 16) && (chan <= 19)) {\r\nchan -= 16;\r\nchan *= 2;\r\noutb(PCMR, CSCIR);\r\n} else {\r\nreturn -EINVAL;\r\n}\r\nregister_buffer = inb(CSCDR);\r\nif (data[0] == COMEDI_OUTPUT)\r\nregister_buffer |= (1 << chan);\r\nelse\r\nregister_buffer &= ~(1 << chan);\r\noutb(register_buffer, CSCDR);\r\nreturn 1;\r\n}

int jffs2_init_security(struct inode *inode, struct inode *dir,\r\nconst struct qstr *qstr)\r\n{\r\nint rc;\r\nsize_t len;\r\nvoid *value;\r\nchar *name;\r\nrc = security_inode_init_security(inode, dir, qstr, &name, &value, &len);\r\nif (rc) {\r\nif (rc == -EOPNOTSUPP)\r\nreturn 0;\r\nreturn rc;\r\n}\r\nrc = do_jffs2_setxattr(inode, JFFS2_XPREFIX_SECURITY, name, value, len, 0);\r\nkfree(name);\r\nkfree(value);\r\nreturn rc;\r\n}\r\nstatic int jffs2_security_getxattr(struct dentry *dentry, const char *name,\r\nvoid *buffer, size_t size, int type)\r\n{\r\nif (!strcmp(name, ""))\r\nreturn -EINVAL;\r\nreturn do_jffs2_getxattr(dentry->d_inode, JFFS2_XPREFIX_SECURITY,\r\nname, buffer, size);\r\n}\r\nstatic int jffs2_security_setxattr(struct dentry *dentry, const char *name,\r\nconst void *buffer, size_t size, int flags, int type)\r\n{\r\nif (!strcmp(name, ""))\r\nreturn -EINVAL;\r\nreturn do_jffs2_setxattr(dentry->d_inode, JFFS2_XPREFIX_SECURITY,\r\nname, buffer, size, flags);\r\n}\r\nstatic size_t jffs2_security_listxattr(struct dentry *dentry, char *list,\r\nsize_t list_size, const char *name, size_t name_len, int type)\r\n{\r\nsize_t retlen = XATTR_SECURITY_PREFIX_LEN + name_len + 1;\r\nif (list && retlen <= list_size) {\r\nstrcpy(list, XATTR_SECURITY_PREFIX);\r\nstrcpy(list + XATTR_SECURITY_PREFIX_LEN, name);\r\n}\r\nreturn retlen;\r\n}

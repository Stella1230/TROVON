static inline void pikawdt_reset(void)\r\n{\r\nunsigned reset = in_be32(pikawdt_private.fpga + 0x14);\r\nreset |= (1 << 7) + (WDT_HW_TIMEOUT << 8);\r\nout_be32(pikawdt_private.fpga + 0x14, reset);\r\n}\r\nstatic void pikawdt_ping(unsigned long data)\r\n{\r\nif (time_before(jiffies, pikawdt_private.next_heartbeat) ||\r\n(!nowayout && !pikawdt_private.open)) {\r\npikawdt_reset();\r\nmod_timer(&pikawdt_private.timer, jiffies + WDT_TIMEOUT);\r\n} else\r\nprintk(KERN_CRIT PFX "I will reset your machine !\n");\r\n}\r\nstatic void pikawdt_keepalive(void)\r\n{\r\npikawdt_private.next_heartbeat = jiffies + heartbeat * HZ;\r\n}\r\nstatic void pikawdt_start(void)\r\n{\r\npikawdt_keepalive();\r\nmod_timer(&pikawdt_private.timer, jiffies + WDT_TIMEOUT);\r\n}\r\nstatic int pikawdt_open(struct inode *inode, struct file *file)\r\n{\r\nif (test_and_set_bit(0, &pikawdt_private.open))\r\nreturn -EBUSY;\r\npikawdt_start();\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic int pikawdt_release(struct inode *inode, struct file *file)\r\n{\r\nif (!pikawdt_private.expect_close)\r\ndel_timer(&pikawdt_private.timer);\r\nclear_bit(0, &pikawdt_private.open);\r\npikawdt_private.expect_close = 0;\r\nreturn 0;\r\n}\r\nstatic ssize_t pikawdt_write(struct file *file, const char __user *data,\r\nsize_t len, loff_t *ppos)\r\n{\r\nif (!len)\r\nreturn 0;\r\nif (!nowayout) {\r\nsize_t i;\r\npikawdt_private.expect_close = 0;\r\nfor (i = 0; i < len; i++) {\r\nchar c;\r\nif (get_user(c, data + i))\r\nreturn -EFAULT;\r\nif (c == 'V') {\r\npikawdt_private.expect_close = 42;\r\nbreak;\r\n}\r\n}\r\n}\r\npikawdt_keepalive();\r\nreturn len;\r\n}\r\nstatic long pikawdt_ioctl(struct file *file,\r\nunsigned int cmd, unsigned long arg)\r\n{\r\nvoid __user *argp = (void __user *)arg;\r\nint __user *p = argp;\r\nint new_value;\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nreturn copy_to_user(argp, &ident, sizeof(ident)) ? -EFAULT : 0;\r\ncase WDIOC_GETSTATUS:\r\nreturn put_user(0, p);\r\ncase WDIOC_GETBOOTSTATUS:\r\nreturn put_user(pikawdt_private.bootstatus, p);\r\ncase WDIOC_KEEPALIVE:\r\npikawdt_keepalive();\r\nreturn 0;\r\ncase WDIOC_SETTIMEOUT:\r\nif (get_user(new_value, p))\r\nreturn -EFAULT;\r\nheartbeat = new_value;\r\npikawdt_keepalive();\r\nreturn put_user(new_value, p);\r\ncase WDIOC_GETTIMEOUT:\r\nreturn put_user(heartbeat, p);\r\n}\r\nreturn -ENOTTY;\r\n}\r\nstatic int __init pikawdt_init(void)\r\n{\r\nstruct device_node *np;\r\nvoid __iomem *fpga;\r\nstatic u32 post1;\r\nint ret;\r\nnp = of_find_compatible_node(NULL, NULL, "pika,fpga");\r\nif (np == NULL) {\r\nprintk(KERN_ERR PFX "Unable to find fpga.\n");\r\nreturn -ENOENT;\r\n}\r\npikawdt_private.fpga = of_iomap(np, 0);\r\nof_node_put(np);\r\nif (pikawdt_private.fpga == NULL) {\r\nprintk(KERN_ERR PFX "Unable to map fpga.\n");\r\nreturn -ENOMEM;\r\n}\r\nident.firmware_version = in_be32(pikawdt_private.fpga + 0x1c) & 0xffff;\r\nnp = of_find_compatible_node(NULL, NULL, "pika,fpga-sd");\r\nif (np == NULL) {\r\nprintk(KERN_ERR PFX "Unable to find fpga-sd.\n");\r\nret = -ENOENT;\r\ngoto out;\r\n}\r\nfpga = of_iomap(np, 0);\r\nof_node_put(np);\r\nif (fpga == NULL) {\r\nprintk(KERN_ERR PFX "Unable to map fpga-sd.\n");\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\npost1 = in_be32(fpga + 0x40);\r\nif (post1 & 0x80000000)\r\npikawdt_private.bootstatus = WDIOF_CARDRESET;\r\niounmap(fpga);\r\nsetup_timer(&pikawdt_private.timer, pikawdt_ping, 0);\r\nret = misc_register(&pikawdt_miscdev);\r\nif (ret) {\r\nprintk(KERN_ERR PFX "Unable to register miscdev.\n");\r\ngoto out;\r\n}\r\nprintk(KERN_INFO PFX "initialized. heartbeat=%d sec (nowayout=%d)\n",\r\nheartbeat, nowayout);\r\nreturn 0;\r\nout:\r\niounmap(pikawdt_private.fpga);\r\nreturn ret;\r\n}\r\nstatic void __exit pikawdt_exit(void)\r\n{\r\nmisc_deregister(&pikawdt_miscdev);\r\niounmap(pikawdt_private.fpga);\r\n}

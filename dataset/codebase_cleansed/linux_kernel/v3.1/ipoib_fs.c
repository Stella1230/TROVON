static void format_gid(union ib_gid *gid, char *buf)\r\n{\r\nint i, n;\r\nfor (n = 0, i = 0; i < 8; ++i) {\r\nn += sprintf(buf + n, "%x",\r\nbe16_to_cpu(((__be16 *) gid->raw)[i]));\r\nif (i < 7)\r\nbuf[n++] = ':';\r\n}\r\n}\r\nstatic void *ipoib_mcg_seq_start(struct seq_file *file, loff_t *pos)\r\n{\r\nstruct ipoib_mcast_iter *iter;\r\nloff_t n = *pos;\r\niter = ipoib_mcast_iter_init(file->private);\r\nif (!iter)\r\nreturn NULL;\r\nwhile (n--) {\r\nif (ipoib_mcast_iter_next(iter)) {\r\nkfree(iter);\r\nreturn NULL;\r\n}\r\n}\r\nreturn iter;\r\n}\r\nstatic void *ipoib_mcg_seq_next(struct seq_file *file, void *iter_ptr,\r\nloff_t *pos)\r\n{\r\nstruct ipoib_mcast_iter *iter = iter_ptr;\r\n(*pos)++;\r\nif (ipoib_mcast_iter_next(iter)) {\r\nkfree(iter);\r\nreturn NULL;\r\n}\r\nreturn iter;\r\n}\r\nstatic void ipoib_mcg_seq_stop(struct seq_file *file, void *iter_ptr)\r\n{\r\n}\r\nstatic int ipoib_mcg_seq_show(struct seq_file *file, void *iter_ptr)\r\n{\r\nstruct ipoib_mcast_iter *iter = iter_ptr;\r\nchar gid_buf[sizeof "ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff"];\r\nunion ib_gid mgid;\r\nunsigned long created;\r\nunsigned int queuelen, complete, send_only;\r\nif (!iter)\r\nreturn 0;\r\nipoib_mcast_iter_read(iter, &mgid, &created, &queuelen,\r\n&complete, &send_only);\r\nformat_gid(&mgid, gid_buf);\r\nseq_printf(file,\r\n"GID: %s\n"\r\n" created: %10ld\n"\r\n" queuelen: %9d\n"\r\n" complete: %9s\n"\r\n" send_only: %8s\n"\r\n"\n",\r\ngid_buf, created, queuelen,\r\ncomplete ? "yes" : "no",\r\nsend_only ? "yes" : "no");\r\nreturn 0;\r\n}\r\nstatic int ipoib_mcg_open(struct inode *inode, struct file *file)\r\n{\r\nstruct seq_file *seq;\r\nint ret;\r\nret = seq_open(file, &ipoib_mcg_seq_ops);\r\nif (ret)\r\nreturn ret;\r\nseq = file->private_data;\r\nseq->private = inode->i_private;\r\nreturn 0;\r\n}\r\nstatic void *ipoib_path_seq_start(struct seq_file *file, loff_t *pos)\r\n{\r\nstruct ipoib_path_iter *iter;\r\nloff_t n = *pos;\r\niter = ipoib_path_iter_init(file->private);\r\nif (!iter)\r\nreturn NULL;\r\nwhile (n--) {\r\nif (ipoib_path_iter_next(iter)) {\r\nkfree(iter);\r\nreturn NULL;\r\n}\r\n}\r\nreturn iter;\r\n}\r\nstatic void *ipoib_path_seq_next(struct seq_file *file, void *iter_ptr,\r\nloff_t *pos)\r\n{\r\nstruct ipoib_path_iter *iter = iter_ptr;\r\n(*pos)++;\r\nif (ipoib_path_iter_next(iter)) {\r\nkfree(iter);\r\nreturn NULL;\r\n}\r\nreturn iter;\r\n}\r\nstatic void ipoib_path_seq_stop(struct seq_file *file, void *iter_ptr)\r\n{\r\n}\r\nstatic int ipoib_path_seq_show(struct seq_file *file, void *iter_ptr)\r\n{\r\nstruct ipoib_path_iter *iter = iter_ptr;\r\nchar gid_buf[sizeof "ffff:ffff:ffff:ffff:ffff:ffff:ffff:ffff"];\r\nstruct ipoib_path path;\r\nint rate;\r\nif (!iter)\r\nreturn 0;\r\nipoib_path_iter_read(iter, &path);\r\nformat_gid(&path.pathrec.dgid, gid_buf);\r\nseq_printf(file,\r\n"GID: %s\n"\r\n" complete: %6s\n",\r\ngid_buf, path.pathrec.dlid ? "yes" : "no");\r\nif (path.pathrec.dlid) {\r\nrate = ib_rate_to_mult(path.pathrec.rate) * 25;\r\nseq_printf(file,\r\n" DLID: 0x%04x\n"\r\n" SL: %12d\n"\r\n" rate: %*d%s Gb/sec\n",\r\nbe16_to_cpu(path.pathrec.dlid),\r\npath.pathrec.sl,\r\n10 - ((rate % 10) ? 2 : 0),\r\nrate / 10, rate % 10 ? ".5" : "");\r\n}\r\nseq_putc(file, '\n');\r\nreturn 0;\r\n}\r\nstatic int ipoib_path_open(struct inode *inode, struct file *file)\r\n{\r\nstruct seq_file *seq;\r\nint ret;\r\nret = seq_open(file, &ipoib_path_seq_ops);\r\nif (ret)\r\nreturn ret;\r\nseq = file->private_data;\r\nseq->private = inode->i_private;\r\nreturn 0;\r\n}\r\nvoid ipoib_create_debug_files(struct net_device *dev)\r\n{\r\nstruct ipoib_dev_priv *priv = netdev_priv(dev);\r\nchar name[IFNAMSIZ + sizeof "_path"];\r\nsnprintf(name, sizeof name, "%s_mcg", dev->name);\r\npriv->mcg_dentry = debugfs_create_file(name, S_IFREG | S_IRUGO,\r\nipoib_root, dev, &ipoib_mcg_fops);\r\nif (!priv->mcg_dentry)\r\nipoib_warn(priv, "failed to create mcg debug file\n");\r\nsnprintf(name, sizeof name, "%s_path", dev->name);\r\npriv->path_dentry = debugfs_create_file(name, S_IFREG | S_IRUGO,\r\nipoib_root, dev, &ipoib_path_fops);\r\nif (!priv->path_dentry)\r\nipoib_warn(priv, "failed to create path debug file\n");\r\n}\r\nvoid ipoib_delete_debug_files(struct net_device *dev)\r\n{\r\nstruct ipoib_dev_priv *priv = netdev_priv(dev);\r\nif (priv->mcg_dentry)\r\ndebugfs_remove(priv->mcg_dentry);\r\nif (priv->path_dentry)\r\ndebugfs_remove(priv->path_dentry);\r\n}\r\nint ipoib_register_debugfs(void)\r\n{\r\nipoib_root = debugfs_create_dir("ipoib", NULL);\r\nreturn ipoib_root ? 0 : -ENOMEM;\r\n}\r\nvoid ipoib_unregister_debugfs(void)\r\n{\r\ndebugfs_remove(ipoib_root);\r\n}

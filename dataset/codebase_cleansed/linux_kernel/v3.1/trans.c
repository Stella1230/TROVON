int hfs_mac2asc(struct super_block *sb, char *out, const struct hfs_name *in)\r\n{\r\nstruct nls_table *nls_disk = HFS_SB(sb)->nls_disk;\r\nstruct nls_table *nls_io = HFS_SB(sb)->nls_io;\r\nconst char *src;\r\nchar *dst;\r\nint srclen, dstlen, size;\r\nsrc = in->name;\r\nsrclen = in->len;\r\ndst = out;\r\ndstlen = HFS_MAX_NAMELEN;\r\nif (nls_io) {\r\nwchar_t ch;\r\nwhile (srclen > 0) {\r\nif (nls_disk) {\r\nsize = nls_disk->char2uni(src, srclen, &ch);\r\nif (size <= 0) {\r\nch = '?';\r\nsize = 1;\r\n}\r\nsrc += size;\r\nsrclen -= size;\r\n} else {\r\nch = *src++;\r\nsrclen--;\r\n}\r\nif (ch == '/')\r\nch = ':';\r\nsize = nls_io->uni2char(ch, dst, dstlen);\r\nif (size < 0) {\r\nif (size == -ENAMETOOLONG)\r\ngoto out;\r\n*dst = '?';\r\nsize = 1;\r\n}\r\ndst += size;\r\ndstlen -= size;\r\n}\r\n} else {\r\nchar ch;\r\nwhile (--srclen >= 0)\r\n*dst++ = (ch = *src++) == '/' ? ':' : ch;\r\n}\r\nout:\r\nreturn dst - out;\r\n}\r\nvoid hfs_asc2mac(struct super_block *sb, struct hfs_name *out, struct qstr *in)\r\n{\r\nstruct nls_table *nls_disk = HFS_SB(sb)->nls_disk;\r\nstruct nls_table *nls_io = HFS_SB(sb)->nls_io;\r\nconst char *src;\r\nchar *dst;\r\nint srclen, dstlen, size;\r\nsrc = in->name;\r\nsrclen = in->len;\r\ndst = out->name;\r\ndstlen = HFS_NAMELEN;\r\nif (nls_io) {\r\nwchar_t ch;\r\nwhile (srclen > 0) {\r\nsize = nls_io->char2uni(src, srclen, &ch);\r\nif (size < 0) {\r\nch = '?';\r\nsize = 1;\r\n}\r\nsrc += size;\r\nsrclen -= size;\r\nif (ch == ':')\r\nch = '/';\r\nif (nls_disk) {\r\nsize = nls_disk->uni2char(ch, dst, dstlen);\r\nif (size < 0) {\r\nif (size == -ENAMETOOLONG)\r\ngoto out;\r\n*dst = '?';\r\nsize = 1;\r\n}\r\ndst += size;\r\ndstlen -= size;\r\n} else {\r\n*dst++ = ch > 0xff ? '?' : ch;\r\ndstlen--;\r\n}\r\n}\r\n} else {\r\nchar ch;\r\nif (dstlen > srclen)\r\ndstlen = srclen;\r\nwhile (--dstlen >= 0)\r\n*dst++ = (ch = *src++) == ':' ? '/' : ch;\r\n}\r\nout:\r\nout->len = dst - (char *)out->name;\r\ndstlen = HFS_NAMELEN - out->len;\r\nwhile (--dstlen >= 0)\r\n*dst++ = 0;\r\n}

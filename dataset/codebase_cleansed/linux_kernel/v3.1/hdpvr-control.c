int hdpvr_config_call(struct hdpvr_device *dev, uint value, u8 valbuf)\r\n{\r\nint ret;\r\nchar request_type = 0x38, snd_request = 0x01;\r\nmutex_lock(&dev->usbc_mutex);\r\ndev->usbc_buf[0] = valbuf;\r\nret = usb_control_msg(dev->udev,\r\nusb_sndctrlpipe(dev->udev, 0),\r\nsnd_request, 0x00 | request_type,\r\nvalue, CTRL_DEFAULT_INDEX,\r\ndev->usbc_buf, 1, 10000);\r\nmutex_unlock(&dev->usbc_mutex);\r\nv4l2_dbg(MSG_INFO, hdpvr_debug, &dev->v4l2_dev,\r\n"config call request for value 0x%x returned %d\n", value,\r\nret);\r\nreturn ret < 0 ? ret : 0;\r\n}\r\nstruct hdpvr_video_info *get_video_info(struct hdpvr_device *dev)\r\n{\r\nstruct hdpvr_video_info *vidinf = NULL;\r\n#ifdef HDPVR_DEBUG\r\nchar print_buf[15];\r\n#endif\r\nint ret;\r\nvidinf = kzalloc(sizeof(struct hdpvr_video_info), GFP_KERNEL);\r\nif (!vidinf) {\r\nv4l2_err(&dev->v4l2_dev, "out of memory\n");\r\ngoto err;\r\n}\r\nmutex_lock(&dev->usbc_mutex);\r\nret = usb_control_msg(dev->udev,\r\nusb_rcvctrlpipe(dev->udev, 0),\r\n0x81, 0x80 | 0x38,\r\n0x1400, 0x0003,\r\ndev->usbc_buf, 5,\r\n1000);\r\nif (ret == 5) {\r\nvidinf->width = dev->usbc_buf[1] << 8 | dev->usbc_buf[0];\r\nvidinf->height = dev->usbc_buf[3] << 8 | dev->usbc_buf[2];\r\nvidinf->fps = dev->usbc_buf[4];\r\n}\r\n#ifdef HDPVR_DEBUG\r\nif (hdpvr_debug & MSG_INFO) {\r\nhex_dump_to_buffer(dev->usbc_buf, 5, 16, 1, print_buf,\r\nsizeof(print_buf), 0);\r\nv4l2_dbg(MSG_INFO, hdpvr_debug, &dev->v4l2_dev,\r\n"get video info returned: %d, %s\n", ret, print_buf);\r\n}\r\n#endif\r\nmutex_unlock(&dev->usbc_mutex);\r\nif (!vidinf->width || !vidinf->height || !vidinf->fps) {\r\nkfree(vidinf);\r\nvidinf = NULL;\r\n}\r\nerr:\r\nreturn vidinf;\r\n}\r\nint get_input_lines_info(struct hdpvr_device *dev)\r\n{\r\n#ifdef HDPVR_DEBUG\r\nchar print_buf[9];\r\n#endif\r\nint ret, lines;\r\nmutex_lock(&dev->usbc_mutex);\r\nret = usb_control_msg(dev->udev,\r\nusb_rcvctrlpipe(dev->udev, 0),\r\n0x81, 0x80 | 0x38,\r\n0x1800, 0x0003,\r\ndev->usbc_buf, 3,\r\n1000);\r\n#ifdef HDPVR_DEBUG\r\nif (hdpvr_debug & MSG_INFO) {\r\nhex_dump_to_buffer(dev->usbc_buf, 3, 16, 1, print_buf,\r\nsizeof(print_buf), 0);\r\nv4l2_dbg(MSG_INFO, hdpvr_debug, &dev->v4l2_dev,\r\n"get input lines info returned: %d, %s\n", ret,\r\nprint_buf);\r\n}\r\n#endif\r\nlines = dev->usbc_buf[1] << 8 | dev->usbc_buf[0];\r\nmutex_unlock(&dev->usbc_mutex);\r\nreturn lines;\r\n}\r\nint hdpvr_set_bitrate(struct hdpvr_device *dev)\r\n{\r\nint ret;\r\nmutex_lock(&dev->usbc_mutex);\r\nmemset(dev->usbc_buf, 0, 4);\r\ndev->usbc_buf[0] = dev->options.bitrate;\r\ndev->usbc_buf[2] = dev->options.peak_bitrate;\r\nret = usb_control_msg(dev->udev,\r\nusb_sndctrlpipe(dev->udev, 0),\r\n0x01, 0x38, CTRL_BITRATE_VALUE,\r\nCTRL_DEFAULT_INDEX, dev->usbc_buf, 4, 1000);\r\nmutex_unlock(&dev->usbc_mutex);\r\nreturn ret;\r\n}\r\nint hdpvr_set_audio(struct hdpvr_device *dev, u8 input,\r\nenum v4l2_mpeg_audio_encoding codec)\r\n{\r\nint ret = 0;\r\nif (dev->flags & HDPVR_FLAG_AC3_CAP) {\r\nmutex_lock(&dev->usbc_mutex);\r\nmemset(dev->usbc_buf, 0, 2);\r\ndev->usbc_buf[0] = input;\r\nif (codec == V4L2_MPEG_AUDIO_ENCODING_AAC)\r\ndev->usbc_buf[1] = 0;\r\nelse if (codec == V4L2_MPEG_AUDIO_ENCODING_AC3)\r\ndev->usbc_buf[1] = 1;\r\nelse {\r\nmutex_unlock(&dev->usbc_mutex);\r\nv4l2_err(&dev->v4l2_dev, "invalid audio codec %d\n",\r\ncodec);\r\nret = -EINVAL;\r\ngoto error;\r\n}\r\nret = usb_control_msg(dev->udev,\r\nusb_sndctrlpipe(dev->udev, 0),\r\n0x01, 0x38, CTRL_AUDIO_INPUT_VALUE,\r\nCTRL_DEFAULT_INDEX, dev->usbc_buf, 2,\r\n1000);\r\nmutex_unlock(&dev->usbc_mutex);\r\nif (ret == 2)\r\nret = 0;\r\n} else\r\nret = hdpvr_config_call(dev, CTRL_AUDIO_INPUT_VALUE, input);\r\nerror:\r\nreturn ret;\r\n}\r\nint hdpvr_set_options(struct hdpvr_device *dev)\r\n{\r\nhdpvr_config_call(dev, CTRL_VIDEO_STD_TYPE, dev->options.video_std);\r\nhdpvr_config_call(dev, CTRL_VIDEO_INPUT_VALUE,\r\ndev->options.video_input+1);\r\nhdpvr_set_audio(dev, dev->options.audio_input+1,\r\ndev->options.audio_codec);\r\nhdpvr_set_bitrate(dev);\r\nhdpvr_config_call(dev, CTRL_BITRATE_MODE_VALUE,\r\ndev->options.bitrate_mode);\r\nhdpvr_config_call(dev, CTRL_GOP_MODE_VALUE, dev->options.gop_mode);\r\nhdpvr_config_call(dev, CTRL_BRIGHTNESS, dev->options.brightness);\r\nhdpvr_config_call(dev, CTRL_CONTRAST, dev->options.contrast);\r\nhdpvr_config_call(dev, CTRL_HUE, dev->options.hue);\r\nhdpvr_config_call(dev, CTRL_SATURATION, dev->options.saturation);\r\nhdpvr_config_call(dev, CTRL_SHARPNESS, dev->options.sharpness);\r\nreturn 0;\r\n}

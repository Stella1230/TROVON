static int stp_pdu_rcv(struct sk_buff *skb, struct net_device *dev,\r\nstruct packet_type *pt, struct net_device *orig_dev)\r\n{\r\nconst struct ethhdr *eh = eth_hdr(skb);\r\nconst struct llc_pdu_un *pdu = llc_pdu_un_hdr(skb);\r\nconst struct stp_proto *proto;\r\nif (pdu->ssap != LLC_SAP_BSPAN ||\r\npdu->dsap != LLC_SAP_BSPAN ||\r\npdu->ctrl_1 != LLC_PDU_TYPE_U)\r\ngoto err;\r\nif (eh->h_dest[5] >= GARP_ADDR_MIN && eh->h_dest[5] <= GARP_ADDR_MAX) {\r\nproto = rcu_dereference(garp_protos[eh->h_dest[5] -\r\nGARP_ADDR_MIN]);\r\nif (proto &&\r\ncompare_ether_addr(eh->h_dest, proto->group_address))\r\ngoto err;\r\n} else\r\nproto = rcu_dereference(stp_proto);\r\nif (!proto)\r\ngoto err;\r\nproto->rcv(proto, skb, dev);\r\nreturn 0;\r\nerr:\r\nkfree_skb(skb);\r\nreturn 0;\r\n}\r\nint stp_proto_register(const struct stp_proto *proto)\r\n{\r\nint err = 0;\r\nmutex_lock(&stp_proto_mutex);\r\nif (sap_registered++ == 0) {\r\nsap = llc_sap_open(LLC_SAP_BSPAN, stp_pdu_rcv);\r\nif (!sap) {\r\nerr = -ENOMEM;\r\ngoto out;\r\n}\r\n}\r\nif (is_zero_ether_addr(proto->group_address))\r\nrcu_assign_pointer(stp_proto, proto);\r\nelse\r\nrcu_assign_pointer(garp_protos[proto->group_address[5] -\r\nGARP_ADDR_MIN], proto);\r\nout:\r\nmutex_unlock(&stp_proto_mutex);\r\nreturn err;\r\n}\r\nvoid stp_proto_unregister(const struct stp_proto *proto)\r\n{\r\nmutex_lock(&stp_proto_mutex);\r\nif (is_zero_ether_addr(proto->group_address))\r\nrcu_assign_pointer(stp_proto, NULL);\r\nelse\r\nrcu_assign_pointer(garp_protos[proto->group_address[5] -\r\nGARP_ADDR_MIN], NULL);\r\nsynchronize_rcu();\r\nif (--sap_registered == 0)\r\nllc_sap_put(sap);\r\nmutex_unlock(&stp_proto_mutex);\r\n}

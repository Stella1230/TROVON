static int marvell_ack_interrupt(struct phy_device *phydev)\r\n{\r\nint err;\r\nerr = phy_read(phydev, MII_M1011_IEVENT);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int marvell_config_intr(struct phy_device *phydev)\r\n{\r\nint err;\r\nif (phydev->interrupts == PHY_INTERRUPT_ENABLED)\r\nerr = phy_write(phydev, MII_M1011_IMASK, MII_M1011_IMASK_INIT);\r\nelse\r\nerr = phy_write(phydev, MII_M1011_IMASK, MII_M1011_IMASK_CLEAR);\r\nreturn err;\r\n}\r\nstatic int marvell_config_aneg(struct phy_device *phydev)\r\n{\r\nint err;\r\nerr = phy_write(phydev, MII_BMCR, BMCR_RESET);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, 0x1d, 0x1f);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, 0x1e, 0x200c);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, 0x1d, 0x5);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, 0x1e, 0);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, 0x1e, 0x100);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_M1011_PHY_SCR,\r\nMII_M1011_PHY_SCR_AUTO_CROSS);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_M1111_PHY_LED_CONTROL,\r\nMII_M1111_PHY_LED_DIRECT);\r\nif (err < 0)\r\nreturn err;\r\nerr = genphy_config_aneg(phydev);\r\nif (err < 0)\r\nreturn err;\r\nif (phydev->autoneg != AUTONEG_ENABLE) {\r\nint bmcr;\r\nbmcr = phy_read(phydev, MII_BMCR);\r\nif (bmcr < 0)\r\nreturn bmcr;\r\nerr = phy_write(phydev, MII_BMCR, bmcr | BMCR_RESET);\r\nif (err < 0)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int marvell_of_reg_init(struct phy_device *phydev)\r\n{\r\nconst __be32 *paddr;\r\nint len, i, saved_page, current_page, page_changed, ret;\r\nif (!phydev->dev.of_node)\r\nreturn 0;\r\npaddr = of_get_property(phydev->dev.of_node, "marvell,reg-init", &len);\r\nif (!paddr || len < (4 * sizeof(*paddr)))\r\nreturn 0;\r\nsaved_page = phy_read(phydev, MII_MARVELL_PHY_PAGE);\r\nif (saved_page < 0)\r\nreturn saved_page;\r\npage_changed = 0;\r\ncurrent_page = saved_page;\r\nret = 0;\r\nlen /= sizeof(*paddr);\r\nfor (i = 0; i < len - 3; i += 4) {\r\nu16 reg_page = be32_to_cpup(paddr + i);\r\nu16 reg = be32_to_cpup(paddr + i + 1);\r\nu16 mask = be32_to_cpup(paddr + i + 2);\r\nu16 val_bits = be32_to_cpup(paddr + i + 3);\r\nint val;\r\nif (reg_page != current_page) {\r\ncurrent_page = reg_page;\r\npage_changed = 1;\r\nret = phy_write(phydev, MII_MARVELL_PHY_PAGE, reg_page);\r\nif (ret < 0)\r\ngoto err;\r\n}\r\nval = 0;\r\nif (mask) {\r\nval = phy_read(phydev, reg);\r\nif (val < 0) {\r\nret = val;\r\ngoto err;\r\n}\r\nval &= mask;\r\n}\r\nval |= val_bits;\r\nret = phy_write(phydev, reg, val);\r\nif (ret < 0)\r\ngoto err;\r\n}\r\nerr:\r\nif (page_changed) {\r\ni = phy_write(phydev, MII_MARVELL_PHY_PAGE, saved_page);\r\nif (ret == 0)\r\nret = i;\r\n}\r\nreturn ret;\r\n}\r\nstatic int marvell_of_reg_init(struct phy_device *phydev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int m88e1121_config_aneg(struct phy_device *phydev)\r\n{\r\nint err, oldpage, mscr;\r\noldpage = phy_read(phydev, MII_MARVELL_PHY_PAGE);\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE,\r\nMII_88E1121_PHY_MSCR_PAGE);\r\nif (err < 0)\r\nreturn err;\r\nif ((phydev->interface == PHY_INTERFACE_MODE_RGMII) ||\r\n(phydev->interface == PHY_INTERFACE_MODE_RGMII_ID) ||\r\n(phydev->interface == PHY_INTERFACE_MODE_RGMII_RXID) ||\r\n(phydev->interface == PHY_INTERFACE_MODE_RGMII_TXID)) {\r\nmscr = phy_read(phydev, MII_88E1121_PHY_MSCR_REG) &\r\nMII_88E1121_PHY_MSCR_DELAY_MASK;\r\nif (phydev->interface == PHY_INTERFACE_MODE_RGMII_ID)\r\nmscr |= (MII_88E1121_PHY_MSCR_RX_DELAY |\r\nMII_88E1121_PHY_MSCR_TX_DELAY);\r\nelse if (phydev->interface == PHY_INTERFACE_MODE_RGMII_RXID)\r\nmscr |= MII_88E1121_PHY_MSCR_RX_DELAY;\r\nelse if (phydev->interface == PHY_INTERFACE_MODE_RGMII_TXID)\r\nmscr |= MII_88E1121_PHY_MSCR_TX_DELAY;\r\nerr = phy_write(phydev, MII_88E1121_PHY_MSCR_REG, mscr);\r\nif (err < 0)\r\nreturn err;\r\n}\r\nphy_write(phydev, MII_MARVELL_PHY_PAGE, oldpage);\r\nerr = phy_write(phydev, MII_BMCR, BMCR_RESET);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_M1011_PHY_SCR,\r\nMII_M1011_PHY_SCR_AUTO_CROSS);\r\nif (err < 0)\r\nreturn err;\r\noldpage = phy_read(phydev, MII_MARVELL_PHY_PAGE);\r\nphy_write(phydev, MII_MARVELL_PHY_PAGE, MII_88E1121_PHY_LED_PAGE);\r\nphy_write(phydev, MII_88E1121_PHY_LED_CTRL, MII_88E1121_PHY_LED_DEF);\r\nphy_write(phydev, MII_MARVELL_PHY_PAGE, oldpage);\r\nerr = genphy_config_aneg(phydev);\r\nreturn err;\r\n}\r\nstatic int m88e1318_config_aneg(struct phy_device *phydev)\r\n{\r\nint err, oldpage, mscr;\r\noldpage = phy_read(phydev, MII_MARVELL_PHY_PAGE);\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE,\r\nMII_88E1121_PHY_MSCR_PAGE);\r\nif (err < 0)\r\nreturn err;\r\nmscr = phy_read(phydev, MII_88E1318S_PHY_MSCR1_REG);\r\nmscr |= MII_88E1318S_PHY_MSCR1_PAD_ODD;\r\nerr = phy_write(phydev, MII_88E1318S_PHY_MSCR1_REG, mscr);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE, oldpage);\r\nif (err < 0)\r\nreturn err;\r\nreturn m88e1121_config_aneg(phydev);\r\n}\r\nstatic int m88e1111_config_init(struct phy_device *phydev)\r\n{\r\nint err;\r\nint temp;\r\ntemp = phy_read(phydev, MII_M1111_PHY_EXT_SR);\r\ntemp &= ~MII_M1111_HWCFG_FIBER_COPPER_AUTO;\r\nphy_write(phydev, MII_M1111_PHY_EXT_SR, temp);\r\ntemp = phy_read(phydev, MII_BMCR);\r\ntemp |= BMCR_RESET;\r\nphy_write(phydev, MII_BMCR, temp);\r\nif ((phydev->interface == PHY_INTERFACE_MODE_RGMII) ||\r\n(phydev->interface == PHY_INTERFACE_MODE_RGMII_ID) ||\r\n(phydev->interface == PHY_INTERFACE_MODE_RGMII_RXID) ||\r\n(phydev->interface == PHY_INTERFACE_MODE_RGMII_TXID)) {\r\ntemp = phy_read(phydev, MII_M1111_PHY_EXT_CR);\r\nif (temp < 0)\r\nreturn temp;\r\nif (phydev->interface == PHY_INTERFACE_MODE_RGMII_ID) {\r\ntemp |= (MII_M1111_RX_DELAY | MII_M1111_TX_DELAY);\r\n} else if (phydev->interface == PHY_INTERFACE_MODE_RGMII_RXID) {\r\ntemp &= ~MII_M1111_TX_DELAY;\r\ntemp |= MII_M1111_RX_DELAY;\r\n} else if (phydev->interface == PHY_INTERFACE_MODE_RGMII_TXID) {\r\ntemp &= ~MII_M1111_RX_DELAY;\r\ntemp |= MII_M1111_TX_DELAY;\r\n}\r\nerr = phy_write(phydev, MII_M1111_PHY_EXT_CR, temp);\r\nif (err < 0)\r\nreturn err;\r\ntemp = phy_read(phydev, MII_M1111_PHY_EXT_SR);\r\nif (temp < 0)\r\nreturn temp;\r\ntemp &= ~(MII_M1111_HWCFG_MODE_MASK);\r\nif (temp & MII_M1111_HWCFG_FIBER_COPPER_RES)\r\ntemp |= MII_M1111_HWCFG_MODE_FIBER_RGMII;\r\nelse\r\ntemp |= MII_M1111_HWCFG_MODE_COPPER_RGMII;\r\nerr = phy_write(phydev, MII_M1111_PHY_EXT_SR, temp);\r\nif (err < 0)\r\nreturn err;\r\n}\r\nif (phydev->interface == PHY_INTERFACE_MODE_SGMII) {\r\ntemp = phy_read(phydev, MII_M1111_PHY_EXT_SR);\r\nif (temp < 0)\r\nreturn temp;\r\ntemp &= ~(MII_M1111_HWCFG_MODE_MASK);\r\ntemp |= MII_M1111_HWCFG_MODE_SGMII_NO_CLK;\r\ntemp |= MII_M1111_HWCFG_FIBER_COPPER_AUTO;\r\nerr = phy_write(phydev, MII_M1111_PHY_EXT_SR, temp);\r\nif (err < 0)\r\nreturn err;\r\n}\r\nif (phydev->interface == PHY_INTERFACE_MODE_RTBI) {\r\ntemp = phy_read(phydev, MII_M1111_PHY_EXT_CR);\r\nif (temp < 0)\r\nreturn temp;\r\ntemp |= (MII_M1111_RX_DELAY | MII_M1111_TX_DELAY);\r\nerr = phy_write(phydev, MII_M1111_PHY_EXT_CR, temp);\r\nif (err < 0)\r\nreturn err;\r\ntemp = phy_read(phydev, MII_M1111_PHY_EXT_SR);\r\nif (temp < 0)\r\nreturn temp;\r\ntemp &= ~(MII_M1111_HWCFG_MODE_MASK | MII_M1111_HWCFG_FIBER_COPPER_RES);\r\ntemp |= 0x7 | MII_M1111_HWCFG_FIBER_COPPER_AUTO;\r\nerr = phy_write(phydev, MII_M1111_PHY_EXT_SR, temp);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_BMCR, BMCR_RESET);\r\nif (err < 0)\r\nreturn err;\r\ndo\r\ntemp = phy_read(phydev, MII_BMCR);\r\nwhile (temp & BMCR_RESET);\r\ntemp = phy_read(phydev, MII_M1111_PHY_EXT_SR);\r\nif (temp < 0)\r\nreturn temp;\r\ntemp &= ~(MII_M1111_HWCFG_MODE_MASK | MII_M1111_HWCFG_FIBER_COPPER_RES);\r\ntemp |= MII_M1111_HWCFG_MODE_COPPER_RTBI | MII_M1111_HWCFG_FIBER_COPPER_AUTO;\r\nerr = phy_write(phydev, MII_M1111_PHY_EXT_SR, temp);\r\nif (err < 0)\r\nreturn err;\r\n}\r\nerr = marvell_of_reg_init(phydev);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_BMCR, BMCR_RESET);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int m88e1118_config_aneg(struct phy_device *phydev)\r\n{\r\nint err;\r\nerr = phy_write(phydev, MII_BMCR, BMCR_RESET);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_M1011_PHY_SCR,\r\nMII_M1011_PHY_SCR_AUTO_CROSS);\r\nif (err < 0)\r\nreturn err;\r\nerr = genphy_config_aneg(phydev);\r\nreturn 0;\r\n}\r\nstatic int m88e1118_config_init(struct phy_device *phydev)\r\n{\r\nint err;\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE, 0x0002);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, 0x15, 0x1070);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE, 0x0003);\r\nif (err < 0)\r\nreturn err;\r\nif (phydev->dev_flags & MARVELL_PHY_M1118_DNS323_LEDS)\r\nerr = phy_write(phydev, 0x10, 0x1100);\r\nelse\r\nerr = phy_write(phydev, 0x10, 0x021e);\r\nif (err < 0)\r\nreturn err;\r\nerr = marvell_of_reg_init(phydev);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE, 0x0);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_BMCR, BMCR_RESET);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int m88e1149_config_init(struct phy_device *phydev)\r\n{\r\nint err;\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE, 0x0002);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, 0x15, 0x1048);\r\nif (err < 0)\r\nreturn err;\r\nerr = marvell_of_reg_init(phydev);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_MARVELL_PHY_PAGE, 0x0);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, MII_BMCR, BMCR_RESET);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int m88e1145_config_init(struct phy_device *phydev)\r\n{\r\nint err;\r\nerr = phy_write(phydev, 0x1d, 0x001b);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, 0x1e, 0x418f);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, 0x1d, 0x0016);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, 0x1e, 0xa2da);\r\nif (err < 0)\r\nreturn err;\r\nif (phydev->interface == PHY_INTERFACE_MODE_RGMII_ID) {\r\nint temp = phy_read(phydev, MII_M1145_PHY_EXT_CR);\r\nif (temp < 0)\r\nreturn temp;\r\ntemp |= (MII_M1145_RGMII_RX_DELAY | MII_M1145_RGMII_TX_DELAY);\r\nerr = phy_write(phydev, MII_M1145_PHY_EXT_CR, temp);\r\nif (err < 0)\r\nreturn err;\r\nif (phydev->dev_flags & MARVELL_PHY_M1145_FLAGS_RESISTANCE) {\r\nerr = phy_write(phydev, 0x1d, 0x0012);\r\nif (err < 0)\r\nreturn err;\r\ntemp = phy_read(phydev, 0x1e);\r\nif (temp < 0)\r\nreturn temp;\r\ntemp &= 0xf03f;\r\ntemp |= 2 << 9;\r\ntemp |= 2 << 6;\r\nerr = phy_write(phydev, 0x1e, temp);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, 0x1d, 0x3);\r\nif (err < 0)\r\nreturn err;\r\nerr = phy_write(phydev, 0x1e, 0x8000);\r\nif (err < 0)\r\nreturn err;\r\n}\r\n}\r\nerr = marvell_of_reg_init(phydev);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int marvell_read_status(struct phy_device *phydev)\r\n{\r\nint adv;\r\nint err;\r\nint lpa;\r\nint status = 0;\r\nerr = genphy_update_link(phydev);\r\nif (err)\r\nreturn err;\r\nif (AUTONEG_ENABLE == phydev->autoneg) {\r\nstatus = phy_read(phydev, MII_M1011_PHY_STATUS);\r\nif (status < 0)\r\nreturn status;\r\nlpa = phy_read(phydev, MII_LPA);\r\nif (lpa < 0)\r\nreturn lpa;\r\nadv = phy_read(phydev, MII_ADVERTISE);\r\nif (adv < 0)\r\nreturn adv;\r\nlpa &= adv;\r\nif (status & MII_M1011_PHY_STATUS_FULLDUPLEX)\r\nphydev->duplex = DUPLEX_FULL;\r\nelse\r\nphydev->duplex = DUPLEX_HALF;\r\nstatus = status & MII_M1011_PHY_STATUS_SPD_MASK;\r\nphydev->pause = phydev->asym_pause = 0;\r\nswitch (status) {\r\ncase MII_M1011_PHY_STATUS_1000:\r\nphydev->speed = SPEED_1000;\r\nbreak;\r\ncase MII_M1011_PHY_STATUS_100:\r\nphydev->speed = SPEED_100;\r\nbreak;\r\ndefault:\r\nphydev->speed = SPEED_10;\r\nbreak;\r\n}\r\nif (phydev->duplex == DUPLEX_FULL) {\r\nphydev->pause = lpa & LPA_PAUSE_CAP ? 1 : 0;\r\nphydev->asym_pause = lpa & LPA_PAUSE_ASYM ? 1 : 0;\r\n}\r\n} else {\r\nint bmcr = phy_read(phydev, MII_BMCR);\r\nif (bmcr < 0)\r\nreturn bmcr;\r\nif (bmcr & BMCR_FULLDPLX)\r\nphydev->duplex = DUPLEX_FULL;\r\nelse\r\nphydev->duplex = DUPLEX_HALF;\r\nif (bmcr & BMCR_SPEED1000)\r\nphydev->speed = SPEED_1000;\r\nelse if (bmcr & BMCR_SPEED100)\r\nphydev->speed = SPEED_100;\r\nelse\r\nphydev->speed = SPEED_10;\r\nphydev->pause = phydev->asym_pause = 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int m88e1121_did_interrupt(struct phy_device *phydev)\r\n{\r\nint imask;\r\nimask = phy_read(phydev, MII_M1011_IEVENT);\r\nif (imask & MII_M1011_IMASK_INIT)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int __init marvell_init(void)\r\n{\r\nint ret;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(marvell_drivers); i++) {\r\nret = phy_driver_register(&marvell_drivers[i]);\r\nif (ret) {\r\nwhile (i-- > 0)\r\nphy_driver_unregister(&marvell_drivers[i]);\r\nreturn ret;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit marvell_exit(void)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(marvell_drivers); i++)\r\nphy_driver_unregister(&marvell_drivers[i]);\r\n}

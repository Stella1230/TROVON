static int nvec_keys_notifier(struct notifier_block *nb,\r\nunsigned long event_type, void *data)\r\n{\r\nint code, state;\r\nunsigned char *msg = (unsigned char *)data;\r\nif (event_type == NVEC_KB_EVT) {\r\nnvec_size _size = (msg[0] & (3 << 5)) >> 5;\r\nif(_size == NVEC_VAR_SIZE)\r\nreturn NOTIFY_STOP;\r\nif(_size == NVEC_3BYTES)\r\nmsg++;\r\ncode = msg[1] & 0x7f;\r\nstate = msg[1] & 0x80;\r\ninput_report_key(keys_dev.input, code_tabs[_size][code], !state);\r\ninput_sync(keys_dev.input);\r\nreturn NOTIFY_STOP;\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int nvec_kbd_event(struct input_dev *dev, unsigned int type,\r\nunsigned int code, int value)\r\n{\r\nunsigned char buf[] = ACK_KBD_EVENT;\r\nstruct nvec_chip *nvec = keys_dev.nvec;\r\nif(type==EV_REP)\r\nreturn 0;\r\nif(type!=EV_LED)\r\nreturn -1;\r\nif(code!=LED_CAPSL)\r\nreturn -1;\r\nbuf[2] = !!value;\r\nnvec_write_async(nvec, buf, sizeof(buf));\r\nreturn 0;\r\n}\r\nint __init nvec_kbd_init(struct nvec_chip *nvec)\r\n{\r\nint i, j, err;\r\nstruct input_dev *idev;\r\nj = 0;\r\nfor(i = 0; i < ARRAY_SIZE(code_tab_102us); ++i)\r\nkeycodes[j++] = code_tab_102us[i];\r\nfor(i = 0; i < ARRAY_SIZE(extcode_tab_us102); ++i)\r\nkeycodes[j++]=extcode_tab_us102[i];\r\nidev = input_allocate_device();\r\nidev->name = "Tegra nvec keyboard";\r\nidev->phys = "i2c3_slave/nvec";\r\nidev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_REP) | BIT_MASK(EV_LED);\r\nidev->ledbit[0] = BIT_MASK(LED_CAPSL);\r\nidev->event = nvec_kbd_event;\r\nidev->keycode = keycodes;\r\nidev->keycodesize = sizeof(unsigned char);\r\nidev->keycodemax = ARRAY_SIZE(keycodes);\r\nfor( i = 0; i < ARRAY_SIZE(keycodes); ++i)\r\nset_bit(keycodes[i], idev->keybit);\r\nclear_bit(0, idev->keybit);\r\nerr = input_register_device(idev);\r\nif(err)\r\ngoto fail;\r\nkeys_dev.input = idev;\r\nkeys_dev.notifier.notifier_call = nvec_keys_notifier;\r\nkeys_dev.nvec = nvec;\r\nnvec_register_notifier(nvec, &keys_dev.notifier, 0);\r\nnvec_write_async(nvec, "\x05\xf4", 2);\r\nnvec_write_async(nvec, "\x05\x03\x01\x01", 4);\r\nnvec_write_async(nvec, "\x05\x04\x01", 3);\r\nnvec_write_async(nvec, "\x06\x01\xff\x03", 4);\r\nmdelay(1000);\r\nreturn 0;\r\nfail:\r\ninput_free_device(idev);\r\nreturn err;\r\n}

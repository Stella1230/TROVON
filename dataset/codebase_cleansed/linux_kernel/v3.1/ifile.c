static inline struct nilfs_ifile_info *NILFS_IFILE_I(struct inode *ifile)\r\n{\r\nreturn (struct nilfs_ifile_info *)NILFS_MDT(ifile);\r\n}\r\nint nilfs_ifile_create_inode(struct inode *ifile, ino_t *out_ino,\r\nstruct buffer_head **out_bh)\r\n{\r\nstruct nilfs_palloc_req req;\r\nint ret;\r\nreq.pr_entry_nr = 0;\r\nreq.pr_entry_bh = NULL;\r\nret = nilfs_palloc_prepare_alloc_entry(ifile, &req);\r\nif (!ret) {\r\nret = nilfs_palloc_get_entry_block(ifile, req.pr_entry_nr, 1,\r\n&req.pr_entry_bh);\r\nif (ret < 0)\r\nnilfs_palloc_abort_alloc_entry(ifile, &req);\r\n}\r\nif (ret < 0) {\r\nbrelse(req.pr_entry_bh);\r\nreturn ret;\r\n}\r\nnilfs_palloc_commit_alloc_entry(ifile, &req);\r\nmark_buffer_dirty(req.pr_entry_bh);\r\nnilfs_mdt_mark_dirty(ifile);\r\n*out_ino = (ino_t)req.pr_entry_nr;\r\n*out_bh = req.pr_entry_bh;\r\nreturn 0;\r\n}\r\nint nilfs_ifile_delete_inode(struct inode *ifile, ino_t ino)\r\n{\r\nstruct nilfs_palloc_req req = {\r\n.pr_entry_nr = ino, .pr_entry_bh = NULL\r\n};\r\nstruct nilfs_inode *raw_inode;\r\nvoid *kaddr;\r\nint ret;\r\nret = nilfs_palloc_prepare_free_entry(ifile, &req);\r\nif (!ret) {\r\nret = nilfs_palloc_get_entry_block(ifile, req.pr_entry_nr, 0,\r\n&req.pr_entry_bh);\r\nif (ret < 0)\r\nnilfs_palloc_abort_free_entry(ifile, &req);\r\n}\r\nif (ret < 0) {\r\nbrelse(req.pr_entry_bh);\r\nreturn ret;\r\n}\r\nkaddr = kmap_atomic(req.pr_entry_bh->b_page, KM_USER0);\r\nraw_inode = nilfs_palloc_block_get_entry(ifile, req.pr_entry_nr,\r\nreq.pr_entry_bh, kaddr);\r\nraw_inode->i_flags = 0;\r\nkunmap_atomic(kaddr, KM_USER0);\r\nmark_buffer_dirty(req.pr_entry_bh);\r\nbrelse(req.pr_entry_bh);\r\nnilfs_palloc_commit_free_entry(ifile, &req);\r\nreturn 0;\r\n}\r\nint nilfs_ifile_get_inode_block(struct inode *ifile, ino_t ino,\r\nstruct buffer_head **out_bh)\r\n{\r\nstruct super_block *sb = ifile->i_sb;\r\nint err;\r\nif (unlikely(!NILFS_VALID_INODE(sb, ino))) {\r\nnilfs_error(sb, __func__, "bad inode number: %lu",\r\n(unsigned long) ino);\r\nreturn -EINVAL;\r\n}\r\nerr = nilfs_palloc_get_entry_block(ifile, ino, 0, out_bh);\r\nif (unlikely(err))\r\nnilfs_warning(sb, __func__, "unable to read inode: %lu",\r\n(unsigned long) ino);\r\nreturn err;\r\n}\r\nint nilfs_ifile_read(struct super_block *sb, struct nilfs_root *root,\r\nsize_t inode_size, struct nilfs_inode *raw_inode,\r\nstruct inode **inodep)\r\n{\r\nstruct inode *ifile;\r\nint err;\r\nifile = nilfs_iget_locked(sb, root, NILFS_IFILE_INO);\r\nif (unlikely(!ifile))\r\nreturn -ENOMEM;\r\nif (!(ifile->i_state & I_NEW))\r\ngoto out;\r\nerr = nilfs_mdt_init(ifile, NILFS_MDT_GFP,\r\nsizeof(struct nilfs_ifile_info));\r\nif (err)\r\ngoto failed;\r\nerr = nilfs_palloc_init_blockgroup(ifile, inode_size);\r\nif (err)\r\ngoto failed;\r\nnilfs_palloc_setup_cache(ifile, &NILFS_IFILE_I(ifile)->palloc_cache);\r\nerr = nilfs_read_inode_common(ifile, raw_inode);\r\nif (err)\r\ngoto failed;\r\nunlock_new_inode(ifile);\r\nout:\r\n*inodep = ifile;\r\nreturn 0;\r\nfailed:\r\niget_failed(ifile);\r\nreturn err;\r\n}

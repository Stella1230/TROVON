static void at91_start_clock(void)\r\n{\r\nif (cpu_is_at91sam9261() || cpu_is_at91sam9g10())\r\nclk_enable(hclk);\r\nclk_enable(iclk);\r\nclk_enable(fclk);\r\nclocked = 1;\r\n}\r\nstatic void at91_stop_clock(void)\r\n{\r\nclk_disable(fclk);\r\nclk_disable(iclk);\r\nif (cpu_is_at91sam9261() || cpu_is_at91sam9g10())\r\nclk_disable(hclk);\r\nclocked = 0;\r\n}\r\nstatic void at91_start_hc(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nstruct ohci_regs __iomem *regs = hcd->regs;\r\ndev_dbg(&pdev->dev, "start\n");\r\nat91_start_clock();\r\nwritel(0, &regs->control);\r\n}\r\nstatic void at91_stop_hc(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nstruct ohci_regs __iomem *regs = hcd->regs;\r\ndev_dbg(&pdev->dev, "stop\n");\r\nwritel(0, &regs->control);\r\nat91_stop_clock();\r\n}\r\nstatic int usb_hcd_at91_probe(const struct hc_driver *driver,\r\nstruct platform_device *pdev)\r\n{\r\nint retval;\r\nstruct usb_hcd *hcd = NULL;\r\nif (pdev->num_resources != 2) {\r\npr_debug("hcd probe: invalid num_resources");\r\nreturn -ENODEV;\r\n}\r\nif ((pdev->resource[0].flags != IORESOURCE_MEM)\r\n|| (pdev->resource[1].flags != IORESOURCE_IRQ)) {\r\npr_debug("hcd probe: invalid resource type\n");\r\nreturn -ENODEV;\r\n}\r\nhcd = usb_create_hcd(driver, &pdev->dev, "at91");\r\nif (!hcd)\r\nreturn -ENOMEM;\r\nhcd->rsrc_start = pdev->resource[0].start;\r\nhcd->rsrc_len = pdev->resource[0].end - pdev->resource[0].start + 1;\r\nif (!request_mem_region(hcd->rsrc_start, hcd->rsrc_len, hcd_name)) {\r\npr_debug("request_mem_region failed\n");\r\nretval = -EBUSY;\r\ngoto err1;\r\n}\r\nhcd->regs = ioremap(hcd->rsrc_start, hcd->rsrc_len);\r\nif (!hcd->regs) {\r\npr_debug("ioremap failed\n");\r\nretval = -EIO;\r\ngoto err2;\r\n}\r\niclk = clk_get(&pdev->dev, "ohci_clk");\r\nfclk = clk_get(&pdev->dev, "uhpck");\r\nif (cpu_is_at91sam9261() || cpu_is_at91sam9g10())\r\nhclk = clk_get(&pdev->dev, "hck0");\r\nat91_start_hc(pdev);\r\nohci_hcd_init(hcd_to_ohci(hcd));\r\nretval = usb_add_hcd(hcd, pdev->resource[1].start, IRQF_SHARED);\r\nif (retval == 0)\r\nreturn retval;\r\nat91_stop_hc(pdev);\r\nif (cpu_is_at91sam9261() || cpu_is_at91sam9g10())\r\nclk_put(hclk);\r\nclk_put(fclk);\r\nclk_put(iclk);\r\niounmap(hcd->regs);\r\nerr2:\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nerr1:\r\nusb_put_hcd(hcd);\r\nreturn retval;\r\n}\r\nstatic void usb_hcd_at91_remove(struct usb_hcd *hcd,\r\nstruct platform_device *pdev)\r\n{\r\nusb_remove_hcd(hcd);\r\nat91_stop_hc(pdev);\r\niounmap(hcd->regs);\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nusb_put_hcd(hcd);\r\nif (cpu_is_at91sam9261() || cpu_is_at91sam9g10())\r\nclk_put(hclk);\r\nclk_put(fclk);\r\nclk_put(iclk);\r\nfclk = iclk = hclk = NULL;\r\ndev_set_drvdata(&pdev->dev, NULL);\r\n}\r\nstatic int __devinit\r\nohci_at91_start (struct usb_hcd *hcd)\r\n{\r\nstruct at91_usbh_data *board = hcd->self.controller->platform_data;\r\nstruct ohci_hcd *ohci = hcd_to_ohci (hcd);\r\nint ret;\r\nif ((ret = ohci_init(ohci)) < 0)\r\nreturn ret;\r\nohci->num_ports = board->ports;\r\nif ((ret = ohci_run(ohci)) < 0) {\r\nerr("can't start %s", hcd->self.bus_name);\r\nohci_stop(hcd);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ohci_hcd_at91_drv_probe(struct platform_device *pdev)\r\n{\r\nstruct at91_usbh_data *pdata = pdev->dev.platform_data;\r\nint i;\r\nif (pdata) {\r\nfor (i = 0; i < ARRAY_SIZE(pdata->vbus_pin); i++) {\r\nif (pdata->vbus_pin[i] <= 0)\r\ncontinue;\r\ngpio_request(pdata->vbus_pin[i], "ohci_vbus");\r\ngpio_direction_output(pdata->vbus_pin[i], 0);\r\n}\r\n}\r\ndevice_init_wakeup(&pdev->dev, 1);\r\nreturn usb_hcd_at91_probe(&ohci_at91_hc_driver, pdev);\r\n}\r\nstatic int ohci_hcd_at91_drv_remove(struct platform_device *pdev)\r\n{\r\nstruct at91_usbh_data *pdata = pdev->dev.platform_data;\r\nint i;\r\nif (pdata) {\r\nfor (i = 0; i < ARRAY_SIZE(pdata->vbus_pin); i++) {\r\nif (pdata->vbus_pin[i] <= 0)\r\ncontinue;\r\ngpio_direction_output(pdata->vbus_pin[i], 1);\r\ngpio_free(pdata->vbus_pin[i]);\r\n}\r\n}\r\ndevice_init_wakeup(&pdev->dev, 0);\r\nusb_hcd_at91_remove(platform_get_drvdata(pdev), pdev);\r\nreturn 0;\r\n}\r\nstatic int\r\nohci_hcd_at91_drv_suspend(struct platform_device *pdev, pm_message_t mesg)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\r\nif (device_may_wakeup(&pdev->dev))\r\nenable_irq_wake(hcd->irq);\r\nif (at91_suspend_entering_slow_clock()) {\r\nohci_usb_reset (ohci);\r\n(void) ohci_readl (ohci, &ohci->regs->control);\r\nat91_stop_clock();\r\n}\r\nreturn 0;\r\n}\r\nstatic int ohci_hcd_at91_drv_resume(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nif (device_may_wakeup(&pdev->dev))\r\ndisable_irq_wake(hcd->irq);\r\nif (!clocked)\r\nat91_start_clock();\r\nohci_finish_controller_resume(hcd);\r\nreturn 0;\r\n}

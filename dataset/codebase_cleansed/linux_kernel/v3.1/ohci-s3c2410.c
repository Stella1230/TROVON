static struct s3c2410_hcd_info *to_s3c2410_info(struct usb_hcd *hcd)\r\n{\r\nreturn hcd->self.controller->platform_data;\r\n}\r\nstatic void s3c2410_start_hc(struct platform_device *dev, struct usb_hcd *hcd)\r\n{\r\nstruct s3c2410_hcd_info *info = dev->dev.platform_data;\r\ndev_dbg(&dev->dev, "s3c2410_start_hc:\n");\r\nclk_enable(usb_clk);\r\nmdelay(2);\r\nclk_enable(clk);\r\nif (info != NULL) {\r\ninfo->hcd = hcd;\r\ninfo->report_oc = s3c2410_hcd_oc;\r\nif (info->enable_oc != NULL)\r\n(info->enable_oc)(info, 1);\r\n}\r\n}\r\nstatic void s3c2410_stop_hc(struct platform_device *dev)\r\n{\r\nstruct s3c2410_hcd_info *info = dev->dev.platform_data;\r\ndev_dbg(&dev->dev, "s3c2410_stop_hc:\n");\r\nif (info != NULL) {\r\ninfo->report_oc = NULL;\r\ninfo->hcd = NULL;\r\nif (info->enable_oc != NULL)\r\n(info->enable_oc)(info, 0);\r\n}\r\nclk_disable(clk);\r\nclk_disable(usb_clk);\r\n}\r\nstatic int\r\nohci_s3c2410_hub_status_data(struct usb_hcd *hcd, char *buf)\r\n{\r\nstruct s3c2410_hcd_info *info = to_s3c2410_info(hcd);\r\nstruct s3c2410_hcd_port *port;\r\nint orig;\r\nint portno;\r\norig = ohci_hub_status_data(hcd, buf);\r\nif (info == NULL)\r\nreturn orig;\r\nport = &info->port[0];\r\nfor (portno = 0; portno < 2; port++, portno++) {\r\nif (port->oc_changed == 1 &&\r\nport->flags & S3C_HCDFLG_USED) {\r\ndev_dbg(hcd->self.controller,\r\n"oc change on port %d\n", portno);\r\nif (orig < 1)\r\norig = 1;\r\nbuf[0] |= 1<<(portno+1);\r\n}\r\n}\r\nreturn orig;\r\n}\r\nstatic void s3c2410_usb_set_power(struct s3c2410_hcd_info *info,\r\nint port, int to)\r\n{\r\nif (info == NULL)\r\nreturn;\r\nif (info->power_control != NULL) {\r\ninfo->port[port-1].power = to;\r\n(info->power_control)(port-1, to);\r\n}\r\n}\r\nstatic int ohci_s3c2410_hub_control(\r\nstruct usb_hcd *hcd,\r\nu16 typeReq,\r\nu16 wValue,\r\nu16 wIndex,\r\nchar *buf,\r\nu16 wLength)\r\n{\r\nstruct s3c2410_hcd_info *info = to_s3c2410_info(hcd);\r\nstruct usb_hub_descriptor *desc;\r\nint ret = -EINVAL;\r\nu32 *data = (u32 *)buf;\r\ndev_dbg(hcd->self.controller,\r\n"s3c2410_hub_control(%p,0x%04x,0x%04x,0x%04x,%p,%04x)\n",\r\nhcd, typeReq, wValue, wIndex, buf, wLength);\r\nif (info == NULL) {\r\nret = ohci_hub_control(hcd, typeReq, wValue,\r\nwIndex, buf, wLength);\r\ngoto out;\r\n}\r\nswitch (typeReq) {\r\ncase SetPortFeature:\r\nif (wValue == USB_PORT_FEAT_POWER) {\r\ndev_dbg(hcd->self.controller, "SetPortFeat: POWER\n");\r\ns3c2410_usb_set_power(info, wIndex, 1);\r\ngoto out;\r\n}\r\nbreak;\r\ncase ClearPortFeature:\r\nswitch (wValue) {\r\ncase USB_PORT_FEAT_C_OVER_CURRENT:\r\ndev_dbg(hcd->self.controller,\r\n"ClearPortFeature: C_OVER_CURRENT\n");\r\nif (valid_port(wIndex)) {\r\ninfo->port[wIndex-1].oc_changed = 0;\r\ninfo->port[wIndex-1].oc_status = 0;\r\n}\r\ngoto out;\r\ncase USB_PORT_FEAT_OVER_CURRENT:\r\ndev_dbg(hcd->self.controller,\r\n"ClearPortFeature: OVER_CURRENT\n");\r\nif (valid_port(wIndex))\r\ninfo->port[wIndex-1].oc_status = 0;\r\ngoto out;\r\ncase USB_PORT_FEAT_POWER:\r\ndev_dbg(hcd->self.controller,\r\n"ClearPortFeature: POWER\n");\r\nif (valid_port(wIndex)) {\r\ns3c2410_usb_set_power(info, wIndex, 0);\r\nreturn 0;\r\n}\r\n}\r\nbreak;\r\n}\r\nret = ohci_hub_control(hcd, typeReq, wValue, wIndex, buf, wLength);\r\nif (ret)\r\ngoto out;\r\nswitch (typeReq) {\r\ncase GetHubDescriptor:\r\ndesc = (struct usb_hub_descriptor *)buf;\r\nif (info->power_control == NULL)\r\nreturn ret;\r\ndev_dbg(hcd->self.controller, "wHubCharacteristics 0x%04x\n",\r\ndesc->wHubCharacteristics);\r\ndesc->wHubCharacteristics &= ~cpu_to_le16(HUB_CHAR_LPSM);\r\ndesc->wHubCharacteristics |= cpu_to_le16(0x0001);\r\nif (info->enable_oc) {\r\ndesc->wHubCharacteristics &= ~cpu_to_le16(\r\nHUB_CHAR_OCPM);\r\ndesc->wHubCharacteristics |= cpu_to_le16(\r\n0x0008 |\r\n0x0001);\r\n}\r\ndev_dbg(hcd->self.controller, "wHubCharacteristics after 0x%04x\n",\r\ndesc->wHubCharacteristics);\r\nreturn ret;\r\ncase GetPortStatus:\r\ndev_dbg(hcd->self.controller, "GetPortStatus(%d)\n", wIndex);\r\nif (valid_port(wIndex)) {\r\nif (info->port[wIndex-1].oc_changed)\r\n*data |= cpu_to_le32(RH_PS_OCIC);\r\nif (info->port[wIndex-1].oc_status)\r\n*data |= cpu_to_le32(RH_PS_POCI);\r\n}\r\n}\r\nout:\r\nreturn ret;\r\n}\r\nstatic void s3c2410_hcd_oc(struct s3c2410_hcd_info *info, int port_oc)\r\n{\r\nstruct s3c2410_hcd_port *port;\r\nstruct usb_hcd *hcd;\r\nunsigned long flags;\r\nint portno;\r\nif (info == NULL)\r\nreturn;\r\nport = &info->port[0];\r\nhcd = info->hcd;\r\nlocal_irq_save(flags);\r\nfor (portno = 0; portno < 2; port++, portno++) {\r\nif (port_oc & (1<<portno) &&\r\nport->flags & S3C_HCDFLG_USED) {\r\nport->oc_status = 1;\r\nport->oc_changed = 1;\r\ns3c2410_usb_set_power(info, portno+1, 0);\r\n}\r\n}\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void\r\nusb_hcd_s3c2410_remove(struct usb_hcd *hcd, struct platform_device *dev)\r\n{\r\nusb_remove_hcd(hcd);\r\ns3c2410_stop_hc(dev);\r\niounmap(hcd->regs);\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nusb_put_hcd(hcd);\r\n}\r\nstatic int usb_hcd_s3c2410_probe(const struct hc_driver *driver,\r\nstruct platform_device *dev)\r\n{\r\nstruct usb_hcd *hcd = NULL;\r\nint retval;\r\ns3c2410_usb_set_power(dev->dev.platform_data, 1, 1);\r\ns3c2410_usb_set_power(dev->dev.platform_data, 2, 1);\r\nhcd = usb_create_hcd(driver, &dev->dev, "s3c24xx");\r\nif (hcd == NULL)\r\nreturn -ENOMEM;\r\nhcd->rsrc_start = dev->resource[0].start;\r\nhcd->rsrc_len = resource_size(&dev->resource[0]);\r\nif (!request_mem_region(hcd->rsrc_start, hcd->rsrc_len, hcd_name)) {\r\ndev_err(&dev->dev, "request_mem_region failed\n");\r\nretval = -EBUSY;\r\ngoto err_put;\r\n}\r\nclk = clk_get(&dev->dev, "usb-host");\r\nif (IS_ERR(clk)) {\r\ndev_err(&dev->dev, "cannot get usb-host clock\n");\r\nretval = PTR_ERR(clk);\r\ngoto err_mem;\r\n}\r\nusb_clk = clk_get(&dev->dev, "usb-bus-host");\r\nif (IS_ERR(usb_clk)) {\r\ndev_err(&dev->dev, "cannot get usb-bus-host clock\n");\r\nretval = PTR_ERR(usb_clk);\r\ngoto err_clk;\r\n}\r\ns3c2410_start_hc(dev, hcd);\r\nhcd->regs = ioremap(hcd->rsrc_start, hcd->rsrc_len);\r\nif (!hcd->regs) {\r\ndev_err(&dev->dev, "ioremap failed\n");\r\nretval = -ENOMEM;\r\ngoto err_ioremap;\r\n}\r\nohci_hcd_init(hcd_to_ohci(hcd));\r\nretval = usb_add_hcd(hcd, dev->resource[1].start, IRQF_DISABLED);\r\nif (retval != 0)\r\ngoto err_ioremap;\r\nreturn 0;\r\nerr_ioremap:\r\ns3c2410_stop_hc(dev);\r\niounmap(hcd->regs);\r\nclk_put(usb_clk);\r\nerr_clk:\r\nclk_put(clk);\r\nerr_mem:\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nerr_put:\r\nusb_put_hcd(hcd);\r\nreturn retval;\r\n}\r\nstatic int\r\nohci_s3c2410_start(struct usb_hcd *hcd)\r\n{\r\nstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\r\nint ret;\r\nret = ohci_init(ohci);\r\nif (ret < 0)\r\nreturn ret;\r\nret = ohci_run(ohci);\r\nif (ret < 0) {\r\nerr("can't start %s", hcd->self.bus_name);\r\nohci_stop(hcd);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devinit ohci_hcd_s3c2410_drv_probe(struct platform_device *pdev)\r\n{\r\nreturn usb_hcd_s3c2410_probe(&ohci_s3c2410_hc_driver, pdev);\r\n}\r\nstatic int __devexit ohci_hcd_s3c2410_drv_remove(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nusb_hcd_s3c2410_remove(hcd, pdev);\r\nreturn 0;\r\n}

static void\r\nvxfs_dumpfsh(struct vxfs_fsh *fhp)\r\n{\r\nprintk("\n\ndumping fileset header:\n");\r\nprintk("----------------------------\n");\r\nprintk("version: %u\n", fhp->fsh_version);\r\nprintk("fsindex: %u\n", fhp->fsh_fsindex);\r\nprintk("iauino: %u\tninodes:%u\n",\r\nfhp->fsh_iauino, fhp->fsh_ninodes);\r\nprintk("maxinode: %u\tlctino: %u\n",\r\nfhp->fsh_maxinode, fhp->fsh_lctino);\r\nprintk("nau: %u\n", fhp->fsh_nau);\r\nprintk("ilistino[0]: %u\tilistino[1]: %u\n",\r\nfhp->fsh_ilistino[0], fhp->fsh_ilistino[1]);\r\n}\r\nstatic struct vxfs_fsh *\r\nvxfs_getfsh(struct inode *ip, int which)\r\n{\r\nstruct buffer_head *bp;\r\nbp = vxfs_bread(ip, which);\r\nif (bp) {\r\nstruct vxfs_fsh *fhp;\r\nif (!(fhp = kmalloc(sizeof(*fhp), GFP_KERNEL)))\r\ngoto out;\r\nmemcpy(fhp, bp->b_data, sizeof(*fhp));\r\nput_bh(bp);\r\nreturn (fhp);\r\n}\r\nout:\r\nbrelse(bp);\r\nreturn NULL;\r\n}\r\nint\r\nvxfs_read_fshead(struct super_block *sbp)\r\n{\r\nstruct vxfs_sb_info *infp = VXFS_SBI(sbp);\r\nstruct vxfs_fsh *pfp, *sfp;\r\nstruct vxfs_inode_info *vip, *tip;\r\nvip = vxfs_blkiget(sbp, infp->vsi_iext, infp->vsi_fshino);\r\nif (!vip) {\r\nprintk(KERN_ERR "vxfs: unable to read fsh inode\n");\r\nreturn -EINVAL;\r\n}\r\nif (!VXFS_ISFSH(vip)) {\r\nprintk(KERN_ERR "vxfs: fsh list inode is of wrong type (%x)\n",\r\nvip->vii_mode & VXFS_TYPE_MASK);\r\ngoto out_free_fship;\r\n}\r\n#ifdef DIAGNOSTIC\r\nprintk("vxfs: fsh inode dump:\n");\r\nvxfs_dumpi(vip, infp->vsi_fshino);\r\n#endif\r\ninfp->vsi_fship = vxfs_get_fake_inode(sbp, vip);\r\nif (!infp->vsi_fship) {\r\nprintk(KERN_ERR "vxfs: unable to get fsh inode\n");\r\ngoto out_free_fship;\r\n}\r\nsfp = vxfs_getfsh(infp->vsi_fship, 0);\r\nif (!sfp) {\r\nprintk(KERN_ERR "vxfs: unable to get structural fsh\n");\r\ngoto out_iput_fship;\r\n}\r\n#ifdef DIAGNOSTIC\r\nvxfs_dumpfsh(sfp);\r\n#endif\r\npfp = vxfs_getfsh(infp->vsi_fship, 1);\r\nif (!pfp) {\r\nprintk(KERN_ERR "vxfs: unable to get primary fsh\n");\r\ngoto out_free_sfp;\r\n}\r\n#ifdef DIAGNOSTIC\r\nvxfs_dumpfsh(pfp);\r\n#endif\r\ntip = vxfs_blkiget(sbp, infp->vsi_iext, sfp->fsh_ilistino[0]);\r\nif (!tip)\r\ngoto out_free_pfp;\r\ninfp->vsi_stilist = vxfs_get_fake_inode(sbp, tip);\r\nif (!infp->vsi_stilist) {\r\nprintk(KERN_ERR "vxfs: unable to get structural list inode\n");\r\nkfree(tip);\r\ngoto out_free_pfp;\r\n}\r\nif (!VXFS_ISILT(VXFS_INO(infp->vsi_stilist))) {\r\nprintk(KERN_ERR "vxfs: structural list inode is of wrong type (%x)\n",\r\nVXFS_INO(infp->vsi_stilist)->vii_mode & VXFS_TYPE_MASK);\r\ngoto out_iput_stilist;\r\n}\r\ntip = vxfs_stiget(sbp, pfp->fsh_ilistino[0]);\r\nif (!tip)\r\ngoto out_iput_stilist;\r\ninfp->vsi_ilist = vxfs_get_fake_inode(sbp, tip);\r\nif (!infp->vsi_ilist) {\r\nprintk(KERN_ERR "vxfs: unable to get inode list inode\n");\r\nkfree(tip);\r\ngoto out_iput_stilist;\r\n}\r\nif (!VXFS_ISILT(VXFS_INO(infp->vsi_ilist))) {\r\nprintk(KERN_ERR "vxfs: inode list inode is of wrong type (%x)\n",\r\nVXFS_INO(infp->vsi_ilist)->vii_mode & VXFS_TYPE_MASK);\r\ngoto out_iput_ilist;\r\n}\r\nreturn 0;\r\nout_iput_ilist:\r\niput(infp->vsi_ilist);\r\nout_iput_stilist:\r\niput(infp->vsi_stilist);\r\nout_free_pfp:\r\nkfree(pfp);\r\nout_free_sfp:\r\nkfree(sfp);\r\nout_iput_fship:\r\niput(infp->vsi_fship);\r\nreturn -EINVAL;\r\nout_free_fship:\r\nkfree(vip);\r\nreturn -EINVAL;\r\n}

static int vpac270_pcmcia_hw_init(struct soc_pcmcia_socket *skt)\r\n{\r\nint ret;\r\nif (skt->nr == 0) {\r\nret = gpio_request_array(vpac270_pcmcia_gpios,\r\nARRAY_SIZE(vpac270_pcmcia_gpios));\r\nskt->socket.pci_irq = gpio_to_irq(GPIO35_VPAC270_PCMCIA_RDY);\r\nif (!ret)\r\nret = soc_pcmcia_request_irqs(skt, &cd_irqs[0], 1);\r\n} else {\r\nret = gpio_request_array(vpac270_cf_gpios,\r\nARRAY_SIZE(vpac270_cf_gpios));\r\nskt->socket.pci_irq = gpio_to_irq(GPIO12_VPAC270_CF_RDY);\r\nif (!ret)\r\nret = soc_pcmcia_request_irqs(skt, &cd_irqs[1], 1);\r\n}\r\nreturn ret;\r\n}\r\nstatic void vpac270_pcmcia_hw_shutdown(struct soc_pcmcia_socket *skt)\r\n{\r\nif (skt->nr == 0)\r\ngpio_free_array(vpac270_pcmcia_gpios,\r\nARRAY_SIZE(vpac270_pcmcia_gpios));\r\nelse\r\ngpio_free_array(vpac270_cf_gpios,\r\nARRAY_SIZE(vpac270_cf_gpios));\r\n}\r\nstatic void vpac270_pcmcia_socket_state(struct soc_pcmcia_socket *skt,\r\nstruct pcmcia_state *state)\r\n{\r\nif (skt->nr == 0) {\r\nstate->detect = !gpio_get_value(GPIO84_VPAC270_PCMCIA_CD);\r\nstate->ready = !!gpio_get_value(GPIO35_VPAC270_PCMCIA_RDY);\r\n} else {\r\nstate->detect = !gpio_get_value(GPIO17_VPAC270_CF_CD);\r\nstate->ready = !!gpio_get_value(GPIO12_VPAC270_CF_RDY);\r\n}\r\nstate->bvd1 = 1;\r\nstate->bvd2 = 1;\r\nstate->wrprot = 0;\r\nstate->vs_3v = 1;\r\nstate->vs_Xv = 0;\r\n}\r\nstatic int\r\nvpac270_pcmcia_configure_socket(struct soc_pcmcia_socket *skt,\r\nconst socket_state_t *state)\r\n{\r\nif (skt->nr == 0) {\r\ngpio_set_value(GPIO11_VPAC270_PCMCIA_RESET,\r\n(state->flags & SS_RESET));\r\ngpio_set_value(GPIO107_VPAC270_PCMCIA_PPEN,\r\n!(state->Vcc == 33 || state->Vcc == 50));\r\n} else {\r\ngpio_set_value(GPIO16_VPAC270_CF_RESET,\r\n(state->flags & SS_RESET));\r\n}\r\nreturn 0;\r\n}\r\nstatic void vpac270_pcmcia_socket_init(struct soc_pcmcia_socket *skt)\r\n{\r\n}\r\nstatic void vpac270_pcmcia_socket_suspend(struct soc_pcmcia_socket *skt)\r\n{\r\n}\r\nstatic int __init vpac270_pcmcia_init(void)\r\n{\r\nint ret;\r\nif (!machine_is_vpac270())\r\nreturn -ENODEV;\r\nvpac270_pcmcia_device = platform_device_alloc("pxa2xx-pcmcia", -1);\r\nif (!vpac270_pcmcia_device)\r\nreturn -ENOMEM;\r\nret = platform_device_add_data(vpac270_pcmcia_device,\r\n&vpac270_pcmcia_ops, sizeof(vpac270_pcmcia_ops));\r\nif (!ret)\r\nret = platform_device_add(vpac270_pcmcia_device);\r\nif (ret)\r\nplatform_device_put(vpac270_pcmcia_device);\r\nreturn ret;\r\n}\r\nstatic void __exit vpac270_pcmcia_exit(void)\r\n{\r\nplatform_device_unregister(vpac270_pcmcia_device);\r\n}

static int sffsdr_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nint fs;\r\nint ret = 0;\r\nfs = params_rate(params);\r\n#ifndef CONFIG_SFFSDR_FPGA\r\nif (fs != 44100) {\r\npr_debug("warning: only 44.1 kHz is supported without SFFSDR FPGA module\n");\r\nreturn -EINVAL;\r\n}\r\n#endif\r\nret = snd_soc_dai_set_fmt(cpu_dai, AUDIO_FORMAT);\r\nif (ret < 0)\r\nreturn ret;\r\npr_debug("sffsdr_hw_params: rate = %d Hz\n", fs);\r\n#ifndef CONFIG_SFFSDR_FPGA\r\nreturn 0;\r\n#else\r\nreturn sffsdr_fpga_set_codec_fs(fs);\r\n#endif\r\n}\r\nstatic int __init sffsdr_init(void)\r\n{\r\nint ret;\r\nif (!machine_is_sffsdr())\r\nreturn -EINVAL;\r\nplatform_device_register(&pcm3008_codec);\r\nsffsdr_snd_device = platform_device_alloc("soc-audio", 0);\r\nif (!sffsdr_snd_device) {\r\nprintk(KERN_ERR "platform device allocation failed\n");\r\nreturn -ENOMEM;\r\n}\r\nplatform_set_drvdata(sffsdr_snd_device, &snd_soc_sffsdr);\r\nplatform_device_add_data(sffsdr_snd_device, &sffsdr_snd_data,\r\nsizeof(sffsdr_snd_data));\r\nret = platform_device_add_resources(sffsdr_snd_device,\r\nsffsdr_snd_resources,\r\nARRAY_SIZE(sffsdr_snd_resources));\r\nif (ret) {\r\nprintk(KERN_ERR "platform device add resources failed\n");\r\ngoto error;\r\n}\r\nret = platform_device_add(sffsdr_snd_device);\r\nif (ret)\r\ngoto error;\r\nreturn ret;\r\nerror:\r\nplatform_device_put(sffsdr_snd_device);\r\nreturn ret;\r\n}\r\nstatic void __exit sffsdr_exit(void)\r\n{\r\nplatform_device_unregister(sffsdr_snd_device);\r\nplatform_device_unregister(&pcm3008_codec);\r\n}

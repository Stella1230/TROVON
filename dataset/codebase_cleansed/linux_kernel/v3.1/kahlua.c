static u8 __devinit mixer_read(unsigned long io, u8 reg)\r\n{\r\noutb(reg, io + 4);\r\nudelay(20);\r\nreg = inb(io + 5);\r\nudelay(20);\r\nreturn reg;\r\n}\r\nstatic int __devinit probe_one(struct pci_dev *pdev, const struct pci_device_id *ent)\r\n{\r\nstruct address_info *hw_config;\r\nunsigned long base;\r\nvoid __iomem *mem;\r\nunsigned long io;\r\nu16 map;\r\nu8 irq, dma8, dma16;\r\nint oldquiet;\r\nextern int sb_be_quiet;\r\nbase = pci_resource_start(pdev, 0);\r\nif(base == 0UL)\r\nreturn 1;\r\nmem = ioremap(base, 128);\r\nif (!mem)\r\nreturn 1;\r\nmap = readw(mem + 0x18);\r\niounmap(mem);\r\nio = 0x220 + 0x20 * (map & 3);\r\nif(map & (1<<2))\r\nprintk(KERN_INFO "kahlua: XpressAudio at 0x%lx\n", io);\r\nelse\r\nreturn 1;\r\nif(map & (1<<5))\r\nprintk(KERN_INFO "kahlua: MPU at 0x300\n");\r\nelse if(map & (1<<6))\r\nprintk(KERN_INFO "kahlua: MPU at 0x330\n");\r\nirq = mixer_read(io, 0x80) & 0x0F;\r\ndma8 = mixer_read(io, 0x81);\r\nif(dma8 & 0x20)\r\ndma16 = 5;\r\nelse if(dma8 & 0x40)\r\ndma16 = 6;\r\nelse if(dma8 & 0x80)\r\ndma16 = 7;\r\nelse\r\n{\r\nprintk(KERN_ERR "kahlua: No 16bit DMA enabled.\n");\r\nreturn 1;\r\n}\r\nif(dma8 & 0x01)\r\ndma8 = 0;\r\nelse if(dma8 & 0x02)\r\ndma8 = 1;\r\nelse if(dma8 & 0x08)\r\ndma8 = 3;\r\nelse\r\n{\r\nprintk(KERN_ERR "kahlua: No 8bit DMA enabled.\n");\r\nreturn 1;\r\n}\r\nif(irq & 1)\r\nirq = 9;\r\nelse if(irq & 2)\r\nirq = 5;\r\nelse if(irq & 4)\r\nirq = 7;\r\nelse if(irq & 8)\r\nirq = 10;\r\nelse\r\n{\r\nprintk(KERN_ERR "kahlua: SB IRQ not set.\n");\r\nreturn 1;\r\n}\r\nprintk(KERN_INFO "kahlua: XpressAudio on IRQ %d, DMA %d, %d\n",\r\nirq, dma8, dma16);\r\nhw_config = kzalloc(sizeof(struct address_info), GFP_KERNEL);\r\nif(hw_config == NULL)\r\n{\r\nprintk(KERN_ERR "kahlua: out of memory.\n");\r\nreturn 1;\r\n}\r\npci_set_drvdata(pdev, hw_config);\r\nhw_config->io_base = io;\r\nhw_config->irq = irq;\r\nhw_config->dma = dma8;\r\nhw_config->dma2 = dma16;\r\nhw_config->name = "Cyrix XpressAudio";\r\nhw_config->driver_use_1 = SB_NO_MIDI | SB_PCI_IRQ;\r\nif (!request_region(io, 16, "soundblaster"))\r\ngoto err_out_free;\r\nif(sb_dsp_detect(hw_config, 0, 0, NULL)==0)\r\n{\r\nprintk(KERN_ERR "kahlua: audio not responding.\n");\r\nrelease_region(io, 16);\r\ngoto err_out_free;\r\n}\r\noldquiet = sb_be_quiet;\r\nsb_be_quiet = 1;\r\nif(sb_dsp_init(hw_config, THIS_MODULE))\r\n{\r\nsb_be_quiet = oldquiet;\r\ngoto err_out_free;\r\n}\r\nsb_be_quiet = oldquiet;\r\nreturn 0;\r\nerr_out_free:\r\npci_set_drvdata(pdev, NULL);\r\nkfree(hw_config);\r\nreturn 1;\r\n}\r\nstatic void __devexit remove_one(struct pci_dev *pdev)\r\n{\r\nstruct address_info *hw_config = pci_get_drvdata(pdev);\r\nsb_dsp_unload(hw_config, 0);\r\npci_set_drvdata(pdev, NULL);\r\nkfree(hw_config);\r\n}\r\nstatic int __init kahlua_init_module(void)\r\n{\r\nprintk(KERN_INFO "Cyrix Kahlua VSA1 XpressAudio support (c) Copyright 2003 Red Hat Inc\n");\r\nreturn pci_register_driver(&kahlua_driver);\r\n}\r\nstatic void __devexit kahlua_cleanup_module(void)\r\n{\r\npci_unregister_driver(&kahlua_driver);\r\n}

void *\r\nkmem_zalloc_greedy(size_t *size, size_t minsize, size_t maxsize)\r\n{\r\nvoid *ptr;\r\nsize_t kmsize = maxsize;\r\nwhile (!(ptr = kmem_zalloc_large(kmsize))) {\r\nif ((kmsize >>= 1) <= minsize)\r\nkmsize = minsize;\r\n}\r\nif (ptr)\r\n*size = kmsize;\r\nreturn ptr;\r\n}\r\nvoid *\r\nkmem_alloc(size_t size, unsigned int __nocast flags)\r\n{\r\nint retries = 0;\r\ngfp_t lflags = kmem_flags_convert(flags);\r\nvoid *ptr;\r\ndo {\r\nptr = kmalloc(size, lflags);\r\nif (ptr || (flags & (KM_MAYFAIL|KM_NOSLEEP)))\r\nreturn ptr;\r\nif (!(++retries % 100))\r\nxfs_err(NULL,\r\n"possible memory allocation deadlock in %s (mode:0x%x)",\r\n__func__, lflags);\r\ncongestion_wait(BLK_RW_ASYNC, HZ/50);\r\n} while (1);\r\n}\r\nvoid *\r\nkmem_zalloc(size_t size, unsigned int __nocast flags)\r\n{\r\nvoid *ptr;\r\nptr = kmem_alloc(size, flags);\r\nif (ptr)\r\nmemset((char *)ptr, 0, (int)size);\r\nreturn ptr;\r\n}\r\nvoid\r\nkmem_free(const void *ptr)\r\n{\r\nif (!is_vmalloc_addr(ptr)) {\r\nkfree(ptr);\r\n} else {\r\nvfree(ptr);\r\n}\r\n}\r\nvoid *\r\nkmem_realloc(const void *ptr, size_t newsize, size_t oldsize,\r\nunsigned int __nocast flags)\r\n{\r\nvoid *new;\r\nnew = kmem_alloc(newsize, flags);\r\nif (ptr) {\r\nif (new)\r\nmemcpy(new, ptr,\r\n((oldsize < newsize) ? oldsize : newsize));\r\nkmem_free(ptr);\r\n}\r\nreturn new;\r\n}\r\nvoid *\r\nkmem_zone_alloc(kmem_zone_t *zone, unsigned int __nocast flags)\r\n{\r\nint retries = 0;\r\ngfp_t lflags = kmem_flags_convert(flags);\r\nvoid *ptr;\r\ndo {\r\nptr = kmem_cache_alloc(zone, lflags);\r\nif (ptr || (flags & (KM_MAYFAIL|KM_NOSLEEP)))\r\nreturn ptr;\r\nif (!(++retries % 100))\r\nxfs_err(NULL,\r\n"possible memory allocation deadlock in %s (mode:0x%x)",\r\n__func__, lflags);\r\ncongestion_wait(BLK_RW_ASYNC, HZ/50);\r\n} while (1);\r\n}\r\nvoid *\r\nkmem_zone_zalloc(kmem_zone_t *zone, unsigned int __nocast flags)\r\n{\r\nvoid *ptr;\r\nptr = kmem_zone_alloc(zone, flags);\r\nif (ptr)\r\nmemset((char *)ptr, 0, kmem_cache_size(zone));\r\nreturn ptr;\r\n}

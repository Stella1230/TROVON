int __compute_return_epc(struct pt_regs *regs)\r\n{\r\nunsigned int __user *addr;\r\nunsigned int bit, fcr31, dspcontrol;\r\nlong epc;\r\nunion mips_instruction insn;\r\nepc = regs->cp0_epc;\r\nif (epc & 3)\r\ngoto unaligned;\r\naddr = (unsigned int __user *) epc;\r\nif (__get_user(insn.word, addr)) {\r\nforce_sig(SIGSEGV, current);\r\nreturn -EFAULT;\r\n}\r\nswitch (insn.i_format.opcode) {\r\ncase spec_op:\r\nswitch (insn.r_format.func) {\r\ncase jalr_op:\r\nregs->regs[insn.r_format.rd] = epc + 8;\r\ncase jr_op:\r\nregs->cp0_epc = regs->regs[insn.r_format.rs];\r\nbreak;\r\n}\r\nbreak;\r\ncase bcond_op:\r\nswitch (insn.i_format.rt) {\r\ncase bltz_op:\r\ncase bltzl_op:\r\nif ((long)regs->regs[insn.i_format.rs] < 0)\r\nepc = epc + 4 + (insn.i_format.simmediate << 2);\r\nelse\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\ncase bgez_op:\r\ncase bgezl_op:\r\nif ((long)regs->regs[insn.i_format.rs] >= 0)\r\nepc = epc + 4 + (insn.i_format.simmediate << 2);\r\nelse\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\ncase bltzal_op:\r\ncase bltzall_op:\r\nregs->regs[31] = epc + 8;\r\nif ((long)regs->regs[insn.i_format.rs] < 0)\r\nepc = epc + 4 + (insn.i_format.simmediate << 2);\r\nelse\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\ncase bgezal_op:\r\ncase bgezall_op:\r\nregs->regs[31] = epc + 8;\r\nif ((long)regs->regs[insn.i_format.rs] >= 0)\r\nepc = epc + 4 + (insn.i_format.simmediate << 2);\r\nelse\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\ncase bposge32_op:\r\nif (!cpu_has_dsp)\r\ngoto sigill;\r\ndspcontrol = rddsp(0x01);\r\nif (dspcontrol >= 32) {\r\nepc = epc + 4 + (insn.i_format.simmediate << 2);\r\n} else\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\n}\r\nbreak;\r\ncase jal_op:\r\nregs->regs[31] = regs->cp0_epc + 8;\r\ncase j_op:\r\nepc += 4;\r\nepc >>= 28;\r\nepc <<= 28;\r\nepc |= (insn.j_format.target << 2);\r\nregs->cp0_epc = epc;\r\nbreak;\r\ncase beq_op:\r\ncase beql_op:\r\nif (regs->regs[insn.i_format.rs] ==\r\nregs->regs[insn.i_format.rt])\r\nepc = epc + 4 + (insn.i_format.simmediate << 2);\r\nelse\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\ncase bne_op:\r\ncase bnel_op:\r\nif (regs->regs[insn.i_format.rs] !=\r\nregs->regs[insn.i_format.rt])\r\nepc = epc + 4 + (insn.i_format.simmediate << 2);\r\nelse\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\ncase blez_op:\r\ncase blezl_op:\r\nif ((long)regs->regs[insn.i_format.rs] <= 0)\r\nepc = epc + 4 + (insn.i_format.simmediate << 2);\r\nelse\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\ncase bgtz_op:\r\ncase bgtzl_op:\r\nif ((long)regs->regs[insn.i_format.rs] > 0)\r\nepc = epc + 4 + (insn.i_format.simmediate << 2);\r\nelse\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\ncase cop1_op:\r\npreempt_disable();\r\nif (is_fpu_owner())\r\nasm volatile("cfc1\t%0,$31" : "=r" (fcr31));\r\nelse\r\nfcr31 = current->thread.fpu.fcr31;\r\npreempt_enable();\r\nbit = (insn.i_format.rt >> 2);\r\nbit += (bit != 0);\r\nbit += 23;\r\nswitch (insn.i_format.rt & 3) {\r\ncase 0:\r\ncase 2:\r\nif (~fcr31 & (1 << bit))\r\nepc = epc + 4 + (insn.i_format.simmediate << 2);\r\nelse\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\ncase 1:\r\ncase 3:\r\nif (fcr31 & (1 << bit))\r\nepc = epc + 4 + (insn.i_format.simmediate << 2);\r\nelse\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\n}\r\nbreak;\r\n#ifdef CONFIG_CPU_CAVIUM_OCTEON\r\ncase lwc2_op:\r\nif ((regs->regs[insn.i_format.rs] & (1ull<<insn.i_format.rt))\r\n== 0)\r\nepc = epc + 4 + (insn.i_format.simmediate << 2);\r\nelse\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\ncase ldc2_op:\r\nif ((regs->regs[insn.i_format.rs] &\r\n(1ull<<(insn.i_format.rt+32))) == 0)\r\nepc = epc + 4 + (insn.i_format.simmediate << 2);\r\nelse\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\ncase swc2_op:\r\nif (regs->regs[insn.i_format.rs] & (1ull<<insn.i_format.rt))\r\nepc = epc + 4 + (insn.i_format.simmediate << 2);\r\nelse\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\ncase sdc2_op:\r\nif (regs->regs[insn.i_format.rs] &\r\n(1ull<<(insn.i_format.rt+32)))\r\nepc = epc + 4 + (insn.i_format.simmediate << 2);\r\nelse\r\nepc += 8;\r\nregs->cp0_epc = epc;\r\nbreak;\r\n#endif\r\n}\r\nreturn 0;\r\nunaligned:\r\nprintk("%s: unaligned epc - sending SIGBUS.\n", current->comm);\r\nforce_sig(SIGBUS, current);\r\nreturn -EFAULT;\r\nsigill:\r\nprintk("%s: DSP branch but not DSP ASE - sending SIGBUS.\n", current->comm);\r\nforce_sig(SIGBUS, current);\r\nreturn -EFAULT;\r\n}

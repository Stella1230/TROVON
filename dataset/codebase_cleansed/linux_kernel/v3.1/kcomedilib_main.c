struct comedi_device *comedi_open(const char *filename)\r\n{\r\nstruct comedi_device_file_info *dev_file_info;\r\nstruct comedi_device *dev;\r\nunsigned int minor;\r\nif (strncmp(filename, "/dev/comedi", 11) != 0)\r\nreturn NULL;\r\nminor = simple_strtoul(filename + 11, NULL, 0);\r\nif (minor >= COMEDI_NUM_BOARD_MINORS)\r\nreturn NULL;\r\ndev_file_info = comedi_get_device_file_info(minor);\r\nif (dev_file_info == NULL)\r\nreturn NULL;\r\ndev = dev_file_info->device;\r\nif (dev == NULL || !dev->attached)\r\nreturn NULL;\r\nif (!try_module_get(dev->driver->module))\r\nreturn NULL;\r\nreturn dev;\r\n}\r\nint comedi_close(struct comedi_device *d)\r\n{\r\nstruct comedi_device *dev = (struct comedi_device *)d;\r\nmodule_put(dev->driver->module);\r\nreturn 0;\r\n}\r\nstatic int comedi_do_insn(struct comedi_device *dev, struct comedi_insn *insn)\r\n{\r\nstruct comedi_subdevice *s;\r\nint ret = 0;\r\nif (insn->subdev >= dev->n_subdevices) {\r\nret = -EINVAL;\r\ngoto error;\r\n}\r\ns = dev->subdevices + insn->subdev;\r\nif (s->type == COMEDI_SUBD_UNUSED) {\r\nprintk(KERN_ERR "%d not useable subdevice\n", insn->subdev);\r\nret = -EIO;\r\ngoto error;\r\n}\r\nret = comedi_check_chanlist(s, 1, &insn->chanspec);\r\nif (ret < 0) {\r\nprintk(KERN_ERR "bad chanspec\n");\r\nret = -EINVAL;\r\ngoto error;\r\n}\r\nif (s->busy) {\r\nret = -EBUSY;\r\ngoto error;\r\n}\r\ns->busy = dev;\r\nswitch (insn->insn) {\r\ncase INSN_BITS:\r\nret = s->insn_bits(dev, s, insn, insn->data);\r\nbreak;\r\ncase INSN_CONFIG:\r\nret = s->insn_config(dev, s, insn, insn->data);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\ns->busy = NULL;\r\nerror:\r\nreturn ret;\r\n}\r\nint comedi_dio_config(struct comedi_device *dev, unsigned int subdev,\r\nunsigned int chan, unsigned int io)\r\n{\r\nstruct comedi_insn insn;\r\nmemset(&insn, 0, sizeof(insn));\r\ninsn.insn = INSN_CONFIG;\r\ninsn.n = 1;\r\ninsn.data = &io;\r\ninsn.subdev = subdev;\r\ninsn.chanspec = CR_PACK(chan, 0, 0);\r\nreturn comedi_do_insn(dev, &insn);\r\n}\r\nint comedi_dio_bitfield(struct comedi_device *dev, unsigned int subdev,\r\nunsigned int mask, unsigned int *bits)\r\n{\r\nstruct comedi_insn insn;\r\nunsigned int data[2];\r\nint ret;\r\nmemset(&insn, 0, sizeof(insn));\r\ninsn.insn = INSN_BITS;\r\ninsn.n = 2;\r\ninsn.data = data;\r\ninsn.subdev = subdev;\r\ndata[0] = mask;\r\ndata[1] = *bits;\r\nret = comedi_do_insn(dev, &insn);\r\n*bits = data[1];\r\nreturn ret;\r\n}\r\nint comedi_find_subdevice_by_type(struct comedi_device *dev, int type,\r\nunsigned int subd)\r\n{\r\nif (subd > dev->n_subdevices)\r\nreturn -ENODEV;\r\nfor (; subd < dev->n_subdevices; subd++) {\r\nif (dev->subdevices[subd].type == type)\r\nreturn subd;\r\n}\r\nreturn -1;\r\n}\r\nint comedi_get_n_channels(struct comedi_device *dev, unsigned int subdevice)\r\n{\r\nstruct comedi_subdevice *s = dev->subdevices + subdevice;\r\nreturn s->n_chan;\r\n}

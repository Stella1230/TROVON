static int match_one(char *s, const char *p, substring_t args[])\r\n{\r\nchar *meta;\r\nint argc = 0;\r\nif (!p)\r\nreturn 1;\r\nwhile(1) {\r\nint len = -1;\r\nmeta = strchr(p, '%');\r\nif (!meta)\r\nreturn strcmp(p, s) == 0;\r\nif (strncmp(p, s, meta-p))\r\nreturn 0;\r\ns += meta - p;\r\np = meta + 1;\r\nif (isdigit(*p))\r\nlen = simple_strtoul(p, (char **) &p, 10);\r\nelse if (*p == '%') {\r\nif (*s++ != '%')\r\nreturn 0;\r\np++;\r\ncontinue;\r\n}\r\nif (argc >= MAX_OPT_ARGS)\r\nreturn 0;\r\nargs[argc].from = s;\r\nswitch (*p++) {\r\ncase 's': {\r\nsize_t str_len = strlen(s);\r\nif (str_len == 0)\r\nreturn 0;\r\nif (len == -1 || len > str_len)\r\nlen = str_len;\r\nargs[argc].to = s + len;\r\nbreak;\r\n}\r\ncase 'd':\r\nsimple_strtol(s, &args[argc].to, 0);\r\ngoto num;\r\ncase 'u':\r\nsimple_strtoul(s, &args[argc].to, 0);\r\ngoto num;\r\ncase 'o':\r\nsimple_strtoul(s, &args[argc].to, 8);\r\ngoto num;\r\ncase 'x':\r\nsimple_strtoul(s, &args[argc].to, 16);\r\nnum:\r\nif (args[argc].to == args[argc].from)\r\nreturn 0;\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\ns = args[argc].to;\r\nargc++;\r\n}\r\n}\r\nint match_token(char *s, const match_table_t table, substring_t args[])\r\n{\r\nconst struct match_token *p;\r\nfor (p = table; !match_one(s, p->pattern, args) ; p++)\r\n;\r\nreturn p->token;\r\n}\r\nstatic int match_number(substring_t *s, int *result, int base)\r\n{\r\nchar *endp;\r\nchar *buf;\r\nint ret;\r\nsize_t len = s->to - s->from;\r\nbuf = kmalloc(len + 1, GFP_KERNEL);\r\nif (!buf)\r\nreturn -ENOMEM;\r\nmemcpy(buf, s->from, len);\r\nbuf[len] = '\0';\r\n*result = simple_strtol(buf, &endp, base);\r\nret = 0;\r\nif (endp == buf)\r\nret = -EINVAL;\r\nkfree(buf);\r\nreturn ret;\r\n}\r\nint match_int(substring_t *s, int *result)\r\n{\r\nreturn match_number(s, result, 0);\r\n}\r\nint match_octal(substring_t *s, int *result)\r\n{\r\nreturn match_number(s, result, 8);\r\n}\r\nint match_hex(substring_t *s, int *result)\r\n{\r\nreturn match_number(s, result, 16);\r\n}\r\nsize_t match_strlcpy(char *dest, const substring_t *src, size_t size)\r\n{\r\nsize_t ret = src->to - src->from;\r\nif (size) {\r\nsize_t len = ret >= size ? size - 1 : ret;\r\nmemcpy(dest, src->from, len);\r\ndest[len] = '\0';\r\n}\r\nreturn ret;\r\n}\r\nchar *match_strdup(const substring_t *s)\r\n{\r\nsize_t sz = s->to - s->from + 1;\r\nchar *p = kmalloc(sz, GFP_KERNEL);\r\nif (p)\r\nmatch_strlcpy(p, s, sz);\r\nreturn p;\r\n}

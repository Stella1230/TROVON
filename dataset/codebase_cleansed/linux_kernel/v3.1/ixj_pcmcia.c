static int ixj_probe(struct pcmcia_device *p_dev)\r\n{\r\ndev_dbg(&p_dev->dev, "ixj_attach()\n");\r\np_dev->priv = kzalloc(sizeof(struct ixj_info_t), GFP_KERNEL);\r\nif (!p_dev->priv) {\r\nreturn -ENOMEM;\r\n}\r\nreturn ixj_config(p_dev);\r\n}\r\nstatic void ixj_detach(struct pcmcia_device *link)\r\n{\r\ndev_dbg(&link->dev, "ixj_detach\n");\r\nixj_cs_release(link);\r\nkfree(link->priv);\r\n}\r\nstatic void ixj_get_serial(struct pcmcia_device * link, IXJ * j)\r\n{\r\nchar *str;\r\nint i, place;\r\ndev_dbg(&link->dev, "ixj_get_serial\n");\r\nstr = link->prod_id[0];\r\nif (!str)\r\ngoto failed;\r\nprintk("%s", str);\r\nstr = link->prod_id[1];\r\nif (!str)\r\ngoto failed;\r\nprintk(" %s", str);\r\nstr = link->prod_id[2];\r\nif (!str)\r\ngoto failed;\r\nplace = 1;\r\nfor (i = strlen(str) - 1; i >= 0; i--) {\r\nswitch (str[i]) {\r\ncase '0':\r\ncase '1':\r\ncase '2':\r\ncase '3':\r\ncase '4':\r\ncase '5':\r\ncase '6':\r\ncase '7':\r\ncase '8':\r\ncase '9':\r\nj->serial += (str[i] - 48) * place;\r\nbreak;\r\ncase 'A':\r\ncase 'B':\r\ncase 'C':\r\ncase 'D':\r\ncase 'E':\r\ncase 'F':\r\nj->serial += (str[i] - 55) * place;\r\nbreak;\r\ncase 'a':\r\ncase 'b':\r\ncase 'c':\r\ncase 'd':\r\ncase 'e':\r\ncase 'f':\r\nj->serial += (str[i] - 87) * place;\r\nbreak;\r\n}\r\nplace = place * 0x10;\r\n}\r\nstr = link->prod_id[3];\r\nif (!str)\r\ngoto failed;\r\nprintk(" version %s\n", str);\r\nfailed:\r\nreturn;\r\n}\r\nstatic int ixj_config_check(struct pcmcia_device *p_dev, void *priv_data)\r\n{\r\np_dev->resource[0]->flags &= ~IO_DATA_PATH_WIDTH;\r\np_dev->resource[0]->flags |= IO_DATA_PATH_WIDTH_8;\r\np_dev->resource[1]->flags &= ~IO_DATA_PATH_WIDTH;\r\np_dev->resource[1]->flags |= IO_DATA_PATH_WIDTH_8;\r\np_dev->io_lines = 3;\r\nreturn pcmcia_request_io(p_dev);\r\n}\r\nstatic int ixj_config(struct pcmcia_device * link)\r\n{\r\nIXJ *j;\r\nixj_info_t *info;\r\ninfo = link->priv;\r\ndev_dbg(&link->dev, "ixj_config\n");\r\nlink->config_flags = CONF_AUTO_SET_IO;\r\nif (pcmcia_loop_config(link, ixj_config_check, NULL))\r\ngoto failed;\r\nif (pcmcia_enable_device(link))\r\ngoto failed;\r\nj = ixj_pcmcia_probe(link->resource[0]->start,\r\nlink->resource[0]->start + 0x10);\r\ninfo->ndev = 1;\r\nixj_get_serial(link, j);\r\nreturn 0;\r\nfailed:\r\nixj_cs_release(link);\r\nreturn -ENODEV;\r\n}\r\nstatic void ixj_cs_release(struct pcmcia_device *link)\r\n{\r\nixj_info_t *info = link->priv;\r\ndev_dbg(&link->dev, "ixj_cs_release\n");\r\ninfo->ndev = 0;\r\npcmcia_disable_device(link);\r\n}\r\nstatic int __init ixj_pcmcia_init(void)\r\n{\r\nreturn pcmcia_register_driver(&ixj_driver);\r\n}\r\nstatic void ixj_pcmcia_exit(void)\r\n{\r\npcmcia_unregister_driver(&ixj_driver);\r\n}

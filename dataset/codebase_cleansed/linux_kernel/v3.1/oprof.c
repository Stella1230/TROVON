int oprofile_setup(void)\r\n{\r\nint err;\r\nmutex_lock(&start_mutex);\r\nif ((err = alloc_cpu_buffers()))\r\ngoto out;\r\nif ((err = alloc_event_buffer()))\r\ngoto out1;\r\nif (oprofile_ops.setup && (err = oprofile_ops.setup()))\r\ngoto out2;\r\nif (oprofile_ops.sync_start) {\r\nint sync_ret = oprofile_ops.sync_start();\r\nswitch (sync_ret) {\r\ncase 0:\r\ngoto post_sync;\r\ncase 1:\r\ngoto do_generic;\r\ncase -1:\r\ngoto out3;\r\ndefault:\r\ngoto out3;\r\n}\r\n}\r\ndo_generic:\r\nif ((err = sync_start()))\r\ngoto out3;\r\npost_sync:\r\nis_setup = 1;\r\nmutex_unlock(&start_mutex);\r\nreturn 0;\r\nout3:\r\nif (oprofile_ops.shutdown)\r\noprofile_ops.shutdown();\r\nout2:\r\nfree_event_buffer();\r\nout1:\r\nfree_cpu_buffers();\r\nout:\r\nmutex_unlock(&start_mutex);\r\nreturn err;\r\n}\r\nstatic void start_switch_worker(void)\r\n{\r\nif (oprofile_ops.switch_events)\r\nschedule_delayed_work(&switch_work, oprofile_time_slice);\r\n}\r\nstatic void stop_switch_worker(void)\r\n{\r\ncancel_delayed_work_sync(&switch_work);\r\n}\r\nstatic void switch_worker(struct work_struct *work)\r\n{\r\nif (oprofile_ops.switch_events())\r\nreturn;\r\natomic_inc(&oprofile_stats.multiplex_counter);\r\nstart_switch_worker();\r\n}\r\nint oprofile_set_timeout(unsigned long val_msec)\r\n{\r\nint err = 0;\r\nunsigned long time_slice;\r\nmutex_lock(&start_mutex);\r\nif (oprofile_started) {\r\nerr = -EBUSY;\r\ngoto out;\r\n}\r\nif (!oprofile_ops.switch_events) {\r\nerr = -EINVAL;\r\ngoto out;\r\n}\r\ntime_slice = msecs_to_jiffies(val_msec);\r\nif (time_slice == MAX_JIFFY_OFFSET) {\r\nerr = -EINVAL;\r\ngoto out;\r\n}\r\noprofile_time_slice = time_slice;\r\nout:\r\nmutex_unlock(&start_mutex);\r\nreturn err;\r\n}\r\nstatic inline void start_switch_worker(void) { }\r\nstatic inline void stop_switch_worker(void) { }\r\nint oprofile_start(void)\r\n{\r\nint err = -EINVAL;\r\nmutex_lock(&start_mutex);\r\nif (!is_setup)\r\ngoto out;\r\nerr = 0;\r\nif (oprofile_started)\r\ngoto out;\r\noprofile_reset_stats();\r\nif ((err = oprofile_ops.start()))\r\ngoto out;\r\nstart_switch_worker();\r\noprofile_started = 1;\r\nout:\r\nmutex_unlock(&start_mutex);\r\nreturn err;\r\n}\r\nvoid oprofile_stop(void)\r\n{\r\nmutex_lock(&start_mutex);\r\nif (!oprofile_started)\r\ngoto out;\r\noprofile_ops.stop();\r\noprofile_started = 0;\r\nstop_switch_worker();\r\nwake_up_buffer_waiter();\r\nout:\r\nmutex_unlock(&start_mutex);\r\n}\r\nvoid oprofile_shutdown(void)\r\n{\r\nmutex_lock(&start_mutex);\r\nif (oprofile_ops.sync_stop) {\r\nint sync_ret = oprofile_ops.sync_stop();\r\nswitch (sync_ret) {\r\ncase 0:\r\ngoto post_sync;\r\ncase 1:\r\ngoto do_generic;\r\ndefault:\r\ngoto post_sync;\r\n}\r\n}\r\ndo_generic:\r\nsync_stop();\r\npost_sync:\r\nif (oprofile_ops.shutdown)\r\noprofile_ops.shutdown();\r\nis_setup = 0;\r\nfree_event_buffer();\r\nfree_cpu_buffers();\r\nmutex_unlock(&start_mutex);\r\n}\r\nint oprofile_set_ulong(unsigned long *addr, unsigned long val)\r\n{\r\nint err = -EBUSY;\r\nmutex_lock(&start_mutex);\r\nif (!oprofile_started) {\r\n*addr = val;\r\nerr = 0;\r\n}\r\nmutex_unlock(&start_mutex);\r\nreturn err;\r\n}\r\nstatic int __init oprofile_init(void)\r\n{\r\nint err;\r\nerr = oprofile_arch_init(&oprofile_ops);\r\nif (err < 0 || timer) {\r\nprintk(KERN_INFO "oprofile: using timer interrupt.\n");\r\nerr = oprofile_timer_init(&oprofile_ops);\r\nif (err)\r\nreturn err;\r\n}\r\nreturn oprofilefs_register();\r\n}\r\nstatic void __exit oprofile_exit(void)\r\n{\r\noprofile_timer_exit();\r\noprofilefs_unregister();\r\noprofile_arch_exit();\r\n}

int mthca_uar_alloc(struct mthca_dev *dev, struct mthca_uar *uar)\r\n{\r\nuar->index = mthca_alloc(&dev->uar_table.alloc);\r\nif (uar->index == -1)\r\nreturn -ENOMEM;\r\nuar->pfn = (pci_resource_start(dev->pdev, 2) >> PAGE_SHIFT) + uar->index;\r\nreturn 0;\r\n}\r\nvoid mthca_uar_free(struct mthca_dev *dev, struct mthca_uar *uar)\r\n{\r\nmthca_free(&dev->uar_table.alloc, uar->index);\r\n}\r\nint mthca_init_uar_table(struct mthca_dev *dev)\r\n{\r\nint ret;\r\nret = mthca_alloc_init(&dev->uar_table.alloc,\r\ndev->limits.num_uars,\r\ndev->limits.num_uars - 1,\r\ndev->limits.reserved_uars + 1);\r\nif (ret)\r\nreturn ret;\r\nret = mthca_init_db_tab(dev);\r\nif (ret)\r\nmthca_alloc_cleanup(&dev->uar_table.alloc);\r\nreturn ret;\r\n}\r\nvoid mthca_cleanup_uar_table(struct mthca_dev *dev)\r\n{\r\nmthca_cleanup_db_tab(dev);\r\nmthca_alloc_cleanup(&dev->uar_table.alloc);\r\n}

static int aircable_prepare_write_buffer(struct usb_serial_port *port,\r\nvoid *dest, size_t size)\r\n{\r\nint count;\r\nunsigned char *buf = dest;\r\ncount = kfifo_out_locked(&port->write_fifo, buf + HCI_HEADER_LENGTH,\r\nsize - HCI_HEADER_LENGTH, &port->lock);\r\nbuf[0] = TX_HEADER_0;\r\nbuf[1] = TX_HEADER_1;\r\nput_unaligned_le16(count, &buf[2]);\r\nreturn count + HCI_HEADER_LENGTH;\r\n}\r\nstatic int aircable_probe(struct usb_serial *serial,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct usb_host_interface *iface_desc = serial->interface->\r\ncur_altsetting;\r\nstruct usb_endpoint_descriptor *endpoint;\r\nint num_bulk_out = 0;\r\nint i;\r\nfor (i = 0; i < iface_desc->desc.bNumEndpoints; i++) {\r\nendpoint = &iface_desc->endpoint[i].desc;\r\nif (usb_endpoint_is_bulk_out(endpoint)) {\r\ndbg("found bulk out on endpoint %d", i);\r\n++num_bulk_out;\r\n}\r\n}\r\nif (num_bulk_out == 0) {\r\ndbg("Invalid interface, discarding");\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic int aircable_process_packet(struct tty_struct *tty,\r\nstruct usb_serial_port *port, int has_headers,\r\nchar *packet, int len)\r\n{\r\nif (has_headers) {\r\nlen -= HCI_HEADER_LENGTH;\r\npacket += HCI_HEADER_LENGTH;\r\n}\r\nif (len <= 0) {\r\ndbg("%s - malformed packet", __func__);\r\nreturn 0;\r\n}\r\ntty_insert_flip_string(tty, packet, len);\r\nreturn len;\r\n}\r\nstatic void aircable_process_read_urb(struct urb *urb)\r\n{\r\nstruct usb_serial_port *port = urb->context;\r\nchar *data = (char *)urb->transfer_buffer;\r\nstruct tty_struct *tty;\r\nint has_headers;\r\nint count;\r\nint len;\r\nint i;\r\ntty = tty_port_tty_get(&port->port);\r\nif (!tty)\r\nreturn;\r\nhas_headers = (urb->actual_length > 2 && data[0] == RX_HEADER_0);\r\ncount = 0;\r\nfor (i = 0; i < urb->actual_length; i += HCI_COMPLETE_FRAME) {\r\nlen = min_t(int, urb->actual_length - i, HCI_COMPLETE_FRAME);\r\ncount += aircable_process_packet(tty, port, has_headers,\r\n&data[i], len);\r\n}\r\nif (count)\r\ntty_flip_buffer_push(tty);\r\ntty_kref_put(tty);\r\n}\r\nstatic int __init aircable_init(void)\r\n{\r\nint retval;\r\nretval = usb_serial_register(&aircable_device);\r\nif (retval)\r\ngoto failed_serial_register;\r\nretval = usb_register(&aircable_driver);\r\nif (retval)\r\ngoto failed_usb_register;\r\nreturn 0;\r\nfailed_usb_register:\r\nusb_serial_deregister(&aircable_device);\r\nfailed_serial_register:\r\nreturn retval;\r\n}\r\nstatic void __exit aircable_exit(void)\r\n{\r\nusb_deregister(&aircable_driver);\r\nusb_serial_deregister(&aircable_device);\r\n}

void write_ht_irq_msg(unsigned int irq, struct ht_irq_msg *msg)\r\n{\r\nstruct ht_irq_cfg *cfg = irq_get_handler_data(irq);\r\nunsigned long flags;\r\nspin_lock_irqsave(&ht_irq_lock, flags);\r\nif (cfg->msg.address_lo != msg->address_lo) {\r\npci_write_config_byte(cfg->dev, cfg->pos + 2, cfg->idx);\r\npci_write_config_dword(cfg->dev, cfg->pos + 4, msg->address_lo);\r\n}\r\nif (cfg->msg.address_hi != msg->address_hi) {\r\npci_write_config_byte(cfg->dev, cfg->pos + 2, cfg->idx + 1);\r\npci_write_config_dword(cfg->dev, cfg->pos + 4, msg->address_hi);\r\n}\r\nif (cfg->update)\r\ncfg->update(cfg->dev, irq, msg);\r\nspin_unlock_irqrestore(&ht_irq_lock, flags);\r\ncfg->msg = *msg;\r\n}\r\nvoid fetch_ht_irq_msg(unsigned int irq, struct ht_irq_msg *msg)\r\n{\r\nstruct ht_irq_cfg *cfg = irq_get_handler_data(irq);\r\n*msg = cfg->msg;\r\n}\r\nvoid mask_ht_irq(struct irq_data *data)\r\n{\r\nstruct ht_irq_cfg *cfg = irq_data_get_irq_handler_data(data);\r\nstruct ht_irq_msg msg = cfg->msg;\r\nmsg.address_lo |= 1;\r\nwrite_ht_irq_msg(data->irq, &msg);\r\n}\r\nvoid unmask_ht_irq(struct irq_data *data)\r\n{\r\nstruct ht_irq_cfg *cfg = irq_data_get_irq_handler_data(data);\r\nstruct ht_irq_msg msg = cfg->msg;\r\nmsg.address_lo &= ~1;\r\nwrite_ht_irq_msg(data->irq, &msg);\r\n}\r\nint __ht_create_irq(struct pci_dev *dev, int idx, ht_irq_update_t *update)\r\n{\r\nstruct ht_irq_cfg *cfg;\r\nunsigned long flags;\r\nu32 data;\r\nint max_irq;\r\nint pos;\r\nint irq;\r\nint node;\r\npos = pci_find_ht_capability(dev, HT_CAPTYPE_IRQ);\r\nif (!pos)\r\nreturn -EINVAL;\r\nspin_lock_irqsave(&ht_irq_lock, flags);\r\npci_write_config_byte(dev, pos + 2, 1);\r\npci_read_config_dword(dev, pos + 4, &data);\r\nspin_unlock_irqrestore(&ht_irq_lock, flags);\r\nmax_irq = (data >> 16) & 0xff;\r\nif ( idx > max_irq)\r\nreturn -EINVAL;\r\ncfg = kmalloc(sizeof(*cfg), GFP_KERNEL);\r\nif (!cfg)\r\nreturn -ENOMEM;\r\ncfg->dev = dev;\r\ncfg->update = update;\r\ncfg->pos = pos;\r\ncfg->idx = 0x10 + (idx * 2);\r\ncfg->msg.address_lo = 0xffffffff;\r\ncfg->msg.address_hi = 0xffffffff;\r\nnode = dev_to_node(&dev->dev);\r\nirq = create_irq_nr(0, node);\r\nif (irq <= 0) {\r\nkfree(cfg);\r\nreturn -EBUSY;\r\n}\r\nirq_set_handler_data(irq, cfg);\r\nif (arch_setup_ht_irq(irq, dev) < 0) {\r\nht_destroy_irq(irq);\r\nreturn -EBUSY;\r\n}\r\nreturn irq;\r\n}\r\nint ht_create_irq(struct pci_dev *dev, int idx)\r\n{\r\nreturn __ht_create_irq(dev, idx, NULL);\r\n}\r\nvoid ht_destroy_irq(unsigned int irq)\r\n{\r\nstruct ht_irq_cfg *cfg;\r\ncfg = irq_get_handler_data(irq);\r\nirq_set_chip(irq, NULL);\r\nirq_set_handler_data(irq, NULL);\r\ndestroy_irq(irq);\r\nkfree(cfg);\r\n}

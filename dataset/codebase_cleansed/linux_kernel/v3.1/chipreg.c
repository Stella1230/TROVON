void register_mtd_chip_driver(struct mtd_chip_driver *drv)\r\n{\r\nspin_lock(&chip_drvs_lock);\r\nlist_add(&drv->list, &chip_drvs_list);\r\nspin_unlock(&chip_drvs_lock);\r\n}\r\nvoid unregister_mtd_chip_driver(struct mtd_chip_driver *drv)\r\n{\r\nspin_lock(&chip_drvs_lock);\r\nlist_del(&drv->list);\r\nspin_unlock(&chip_drvs_lock);\r\n}\r\nstatic struct mtd_chip_driver *get_mtd_chip_driver (const char *name)\r\n{\r\nstruct list_head *pos;\r\nstruct mtd_chip_driver *ret = NULL, *this;\r\nspin_lock(&chip_drvs_lock);\r\nlist_for_each(pos, &chip_drvs_list) {\r\nthis = list_entry(pos, typeof(*this), list);\r\nif (!strcmp(this->name, name)) {\r\nret = this;\r\nbreak;\r\n}\r\n}\r\nif (ret && !try_module_get(ret->module))\r\nret = NULL;\r\nspin_unlock(&chip_drvs_lock);\r\nreturn ret;\r\n}\r\nstruct mtd_info *do_map_probe(const char *name, struct map_info *map)\r\n{\r\nstruct mtd_chip_driver *drv;\r\nstruct mtd_info *ret;\r\ndrv = get_mtd_chip_driver(name);\r\nif (!drv && !request_module("%s", name))\r\ndrv = get_mtd_chip_driver(name);\r\nif (!drv)\r\nreturn NULL;\r\nret = drv->probe(map);\r\nmodule_put(drv->module);\r\nif (ret)\r\nreturn ret;\r\nreturn NULL;\r\n}\r\nvoid map_destroy(struct mtd_info *mtd)\r\n{\r\nstruct map_info *map = mtd->priv;\r\nif (map->fldrv->destroy)\r\nmap->fldrv->destroy(mtd);\r\nmodule_put(map->fldrv->module);\r\nkfree(mtd);\r\n}

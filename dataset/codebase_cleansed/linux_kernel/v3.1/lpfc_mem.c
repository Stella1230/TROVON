int\r\nlpfc_mem_alloc(struct lpfc_hba *phba, int align)\r\n{\r\nstruct lpfc_dma_pool *pool = &phba->lpfc_mbuf_safety_pool;\r\nint i;\r\nif (phba->sli_rev == LPFC_SLI_REV4)\r\nphba->lpfc_scsi_dma_buf_pool =\r\npci_pool_create("lpfc_scsi_dma_buf_pool",\r\nphba->pcidev,\r\nphba->cfg_sg_dma_buf_size,\r\nphba->cfg_sg_dma_buf_size,\r\n0);\r\nelse\r\nphba->lpfc_scsi_dma_buf_pool =\r\npci_pool_create("lpfc_scsi_dma_buf_pool",\r\nphba->pcidev, phba->cfg_sg_dma_buf_size,\r\nalign, 0);\r\nif (!phba->lpfc_scsi_dma_buf_pool)\r\ngoto fail;\r\nphba->lpfc_mbuf_pool = pci_pool_create("lpfc_mbuf_pool", phba->pcidev,\r\nLPFC_BPL_SIZE,\r\nalign, 0);\r\nif (!phba->lpfc_mbuf_pool)\r\ngoto fail_free_dma_buf_pool;\r\npool->elements = kmalloc(sizeof(struct lpfc_dmabuf) *\r\nLPFC_MBUF_POOL_SIZE, GFP_KERNEL);\r\nif (!pool->elements)\r\ngoto fail_free_lpfc_mbuf_pool;\r\npool->max_count = 0;\r\npool->current_count = 0;\r\nfor ( i = 0; i < LPFC_MBUF_POOL_SIZE; i++) {\r\npool->elements[i].virt = pci_pool_alloc(phba->lpfc_mbuf_pool,\r\nGFP_KERNEL, &pool->elements[i].phys);\r\nif (!pool->elements[i].virt)\r\ngoto fail_free_mbuf_pool;\r\npool->max_count++;\r\npool->current_count++;\r\n}\r\nphba->mbox_mem_pool = mempool_create_kmalloc_pool(LPFC_MEM_POOL_SIZE,\r\nsizeof(LPFC_MBOXQ_t));\r\nif (!phba->mbox_mem_pool)\r\ngoto fail_free_mbuf_pool;\r\nphba->nlp_mem_pool = mempool_create_kmalloc_pool(LPFC_MEM_POOL_SIZE,\r\nsizeof(struct lpfc_nodelist));\r\nif (!phba->nlp_mem_pool)\r\ngoto fail_free_mbox_pool;\r\nif (phba->sli_rev == LPFC_SLI_REV4) {\r\nphba->rrq_pool =\r\nmempool_create_kmalloc_pool(LPFC_MEM_POOL_SIZE,\r\nsizeof(struct lpfc_node_rrq));\r\nif (!phba->rrq_pool)\r\ngoto fail_free_nlp_mem_pool;\r\nphba->lpfc_hrb_pool = pci_pool_create("lpfc_hrb_pool",\r\nphba->pcidev,\r\nLPFC_HDR_BUF_SIZE, align, 0);\r\nif (!phba->lpfc_hrb_pool)\r\ngoto fail_free_rrq_mem_pool;\r\nphba->lpfc_drb_pool = pci_pool_create("lpfc_drb_pool",\r\nphba->pcidev,\r\nLPFC_DATA_BUF_SIZE, align, 0);\r\nif (!phba->lpfc_drb_pool)\r\ngoto fail_free_hrb_pool;\r\nphba->lpfc_hbq_pool = NULL;\r\n} else {\r\nphba->lpfc_hbq_pool = pci_pool_create("lpfc_hbq_pool",\r\nphba->pcidev, LPFC_BPL_SIZE, align, 0);\r\nif (!phba->lpfc_hbq_pool)\r\ngoto fail_free_nlp_mem_pool;\r\nphba->lpfc_hrb_pool = NULL;\r\nphba->lpfc_drb_pool = NULL;\r\n}\r\nreturn 0;\r\nfail_free_hrb_pool:\r\npci_pool_destroy(phba->lpfc_hrb_pool);\r\nphba->lpfc_hrb_pool = NULL;\r\nfail_free_rrq_mem_pool:\r\nmempool_destroy(phba->rrq_pool);\r\nphba->rrq_pool = NULL;\r\nfail_free_nlp_mem_pool:\r\nmempool_destroy(phba->nlp_mem_pool);\r\nphba->nlp_mem_pool = NULL;\r\nfail_free_mbox_pool:\r\nmempool_destroy(phba->mbox_mem_pool);\r\nphba->mbox_mem_pool = NULL;\r\nfail_free_mbuf_pool:\r\nwhile (i--)\r\npci_pool_free(phba->lpfc_mbuf_pool, pool->elements[i].virt,\r\npool->elements[i].phys);\r\nkfree(pool->elements);\r\nfail_free_lpfc_mbuf_pool:\r\npci_pool_destroy(phba->lpfc_mbuf_pool);\r\nphba->lpfc_mbuf_pool = NULL;\r\nfail_free_dma_buf_pool:\r\npci_pool_destroy(phba->lpfc_scsi_dma_buf_pool);\r\nphba->lpfc_scsi_dma_buf_pool = NULL;\r\nfail:\r\nreturn -ENOMEM;\r\n}\r\nvoid\r\nlpfc_mem_free(struct lpfc_hba *phba)\r\n{\r\nint i;\r\nstruct lpfc_dma_pool *pool = &phba->lpfc_mbuf_safety_pool;\r\nlpfc_sli_hbqbuf_free_all(phba);\r\nif (phba->lpfc_drb_pool)\r\npci_pool_destroy(phba->lpfc_drb_pool);\r\nphba->lpfc_drb_pool = NULL;\r\nif (phba->lpfc_hrb_pool)\r\npci_pool_destroy(phba->lpfc_hrb_pool);\r\nphba->lpfc_hrb_pool = NULL;\r\nif (phba->lpfc_hbq_pool)\r\npci_pool_destroy(phba->lpfc_hbq_pool);\r\nphba->lpfc_hbq_pool = NULL;\r\nmempool_destroy(phba->nlp_mem_pool);\r\nphba->nlp_mem_pool = NULL;\r\nmempool_destroy(phba->mbox_mem_pool);\r\nphba->mbox_mem_pool = NULL;\r\nfor (i = 0; i < pool->current_count; i++)\r\npci_pool_free(phba->lpfc_mbuf_pool, pool->elements[i].virt,\r\npool->elements[i].phys);\r\nkfree(pool->elements);\r\npci_pool_destroy(phba->lpfc_mbuf_pool);\r\nphba->lpfc_mbuf_pool = NULL;\r\npci_pool_destroy(phba->lpfc_scsi_dma_buf_pool);\r\nphba->lpfc_scsi_dma_buf_pool = NULL;\r\nreturn;\r\n}\r\nvoid\r\nlpfc_mem_free_all(struct lpfc_hba *phba)\r\n{\r\nstruct lpfc_sli *psli = &phba->sli;\r\nLPFC_MBOXQ_t *mbox, *next_mbox;\r\nstruct lpfc_dmabuf *mp;\r\nlist_for_each_entry_safe(mbox, next_mbox, &psli->mboxq, list) {\r\nmp = (struct lpfc_dmabuf *) (mbox->context1);\r\nif (mp) {\r\nlpfc_mbuf_free(phba, mp->virt, mp->phys);\r\nkfree(mp);\r\n}\r\nlist_del(&mbox->list);\r\nmempool_free(mbox, phba->mbox_mem_pool);\r\n}\r\nlist_for_each_entry_safe(mbox, next_mbox, &psli->mboxq_cmpl, list) {\r\nmp = (struct lpfc_dmabuf *) (mbox->context1);\r\nif (mp) {\r\nlpfc_mbuf_free(phba, mp->virt, mp->phys);\r\nkfree(mp);\r\n}\r\nlist_del(&mbox->list);\r\nmempool_free(mbox, phba->mbox_mem_pool);\r\n}\r\nspin_lock_irq(&phba->hbalock);\r\npsli->sli_flag &= ~LPFC_SLI_MBOX_ACTIVE;\r\nspin_unlock_irq(&phba->hbalock);\r\nif (psli->mbox_active) {\r\nmbox = psli->mbox_active;\r\nmp = (struct lpfc_dmabuf *) (mbox->context1);\r\nif (mp) {\r\nlpfc_mbuf_free(phba, mp->virt, mp->phys);\r\nkfree(mp);\r\n}\r\nmempool_free(mbox, phba->mbox_mem_pool);\r\npsli->mbox_active = NULL;\r\n}\r\nlpfc_mem_free(phba);\r\nkfree(psli->iocbq_lookup);\r\npsli->iocbq_lookup = NULL;\r\nreturn;\r\n}\r\nvoid *\r\nlpfc_mbuf_alloc(struct lpfc_hba *phba, int mem_flags, dma_addr_t *handle)\r\n{\r\nstruct lpfc_dma_pool *pool = &phba->lpfc_mbuf_safety_pool;\r\nunsigned long iflags;\r\nvoid *ret;\r\nret = pci_pool_alloc(phba->lpfc_mbuf_pool, GFP_KERNEL, handle);\r\nspin_lock_irqsave(&phba->hbalock, iflags);\r\nif (!ret && (mem_flags & MEM_PRI) && pool->current_count) {\r\npool->current_count--;\r\nret = pool->elements[pool->current_count].virt;\r\n*handle = pool->elements[pool->current_count].phys;\r\n}\r\nspin_unlock_irqrestore(&phba->hbalock, iflags);\r\nreturn ret;\r\n}\r\nvoid\r\n__lpfc_mbuf_free(struct lpfc_hba * phba, void *virt, dma_addr_t dma)\r\n{\r\nstruct lpfc_dma_pool *pool = &phba->lpfc_mbuf_safety_pool;\r\nif (pool->current_count < pool->max_count) {\r\npool->elements[pool->current_count].virt = virt;\r\npool->elements[pool->current_count].phys = dma;\r\npool->current_count++;\r\n} else {\r\npci_pool_free(phba->lpfc_mbuf_pool, virt, dma);\r\n}\r\nreturn;\r\n}\r\nvoid\r\nlpfc_mbuf_free(struct lpfc_hba * phba, void *virt, dma_addr_t dma)\r\n{\r\nunsigned long iflags;\r\nspin_lock_irqsave(&phba->hbalock, iflags);\r\n__lpfc_mbuf_free(phba, virt, dma);\r\nspin_unlock_irqrestore(&phba->hbalock, iflags);\r\nreturn;\r\n}\r\nstruct hbq_dmabuf *\r\nlpfc_els_hbq_alloc(struct lpfc_hba *phba)\r\n{\r\nstruct hbq_dmabuf *hbqbp;\r\nhbqbp = kmalloc(sizeof(struct hbq_dmabuf), GFP_KERNEL);\r\nif (!hbqbp)\r\nreturn NULL;\r\nhbqbp->dbuf.virt = pci_pool_alloc(phba->lpfc_hbq_pool, GFP_KERNEL,\r\n&hbqbp->dbuf.phys);\r\nif (!hbqbp->dbuf.virt) {\r\nkfree(hbqbp);\r\nreturn NULL;\r\n}\r\nhbqbp->size = LPFC_BPL_SIZE;\r\nreturn hbqbp;\r\n}\r\nvoid\r\nlpfc_els_hbq_free(struct lpfc_hba *phba, struct hbq_dmabuf *hbqbp)\r\n{\r\npci_pool_free(phba->lpfc_hbq_pool, hbqbp->dbuf.virt, hbqbp->dbuf.phys);\r\nkfree(hbqbp);\r\nreturn;\r\n}\r\nstruct hbq_dmabuf *\r\nlpfc_sli4_rb_alloc(struct lpfc_hba *phba)\r\n{\r\nstruct hbq_dmabuf *dma_buf;\r\ndma_buf = kmalloc(sizeof(struct hbq_dmabuf), GFP_KERNEL);\r\nif (!dma_buf)\r\nreturn NULL;\r\ndma_buf->hbuf.virt = pci_pool_alloc(phba->lpfc_hrb_pool, GFP_KERNEL,\r\n&dma_buf->hbuf.phys);\r\nif (!dma_buf->hbuf.virt) {\r\nkfree(dma_buf);\r\nreturn NULL;\r\n}\r\ndma_buf->dbuf.virt = pci_pool_alloc(phba->lpfc_drb_pool, GFP_KERNEL,\r\n&dma_buf->dbuf.phys);\r\nif (!dma_buf->dbuf.virt) {\r\npci_pool_free(phba->lpfc_hrb_pool, dma_buf->hbuf.virt,\r\ndma_buf->hbuf.phys);\r\nkfree(dma_buf);\r\nreturn NULL;\r\n}\r\ndma_buf->size = LPFC_BPL_SIZE;\r\nreturn dma_buf;\r\n}\r\nvoid\r\nlpfc_sli4_rb_free(struct lpfc_hba *phba, struct hbq_dmabuf *dmab)\r\n{\r\npci_pool_free(phba->lpfc_hrb_pool, dmab->hbuf.virt, dmab->hbuf.phys);\r\npci_pool_free(phba->lpfc_drb_pool, dmab->dbuf.virt, dmab->dbuf.phys);\r\nkfree(dmab);\r\nreturn;\r\n}\r\nvoid\r\nlpfc_in_buf_free(struct lpfc_hba *phba, struct lpfc_dmabuf *mp)\r\n{\r\nstruct hbq_dmabuf *hbq_entry;\r\nunsigned long flags;\r\nif (!mp)\r\nreturn;\r\nif (phba->sli3_options & LPFC_SLI3_HBQ_ENABLED) {\r\nspin_lock_irqsave(&phba->hbalock, flags);\r\nif (!phba->hbq_in_use) {\r\nspin_unlock_irqrestore(&phba->hbalock, flags);\r\nreturn;\r\n}\r\nhbq_entry = container_of(mp, struct hbq_dmabuf, dbuf);\r\nlist_del(&hbq_entry->dbuf.list);\r\nif (hbq_entry->tag == -1) {\r\n(phba->hbqs[LPFC_ELS_HBQ].hbq_free_buffer)\r\n(phba, hbq_entry);\r\n} else {\r\nlpfc_sli_free_hbq(phba, hbq_entry);\r\n}\r\nspin_unlock_irqrestore(&phba->hbalock, flags);\r\n} else {\r\nlpfc_mbuf_free(phba, mp->virt, mp->phys);\r\nkfree(mp);\r\n}\r\nreturn;\r\n}

static map_word\r\nltq_read16(struct map_info *map, unsigned long adr)\r\n{\r\nunsigned long flags;\r\nmap_word temp;\r\nif (map->map_priv_1 == LTQ_NOR_PROBING)\r\nadr ^= 2;\r\nspin_lock_irqsave(&ebu_lock, flags);\r\ntemp.x[0] = *(u16 *)(map->virt + adr);\r\nspin_unlock_irqrestore(&ebu_lock, flags);\r\nreturn temp;\r\n}\r\nstatic void\r\nltq_write16(struct map_info *map, map_word d, unsigned long adr)\r\n{\r\nunsigned long flags;\r\nif (map->map_priv_1 == LTQ_NOR_PROBING)\r\nadr ^= 2;\r\nspin_lock_irqsave(&ebu_lock, flags);\r\n*(u16 *)(map->virt + adr) = d.x[0];\r\nspin_unlock_irqrestore(&ebu_lock, flags);\r\n}\r\nstatic void\r\nltq_copy_from(struct map_info *map, void *to,\r\nunsigned long from, ssize_t len)\r\n{\r\nunsigned char *f = (unsigned char *)map->virt + from;\r\nunsigned char *t = (unsigned char *)to;\r\nunsigned long flags;\r\nspin_lock_irqsave(&ebu_lock, flags);\r\nwhile (len--)\r\n*t++ = *f++;\r\nspin_unlock_irqrestore(&ebu_lock, flags);\r\n}\r\nstatic void\r\nltq_copy_to(struct map_info *map, unsigned long to,\r\nconst void *from, ssize_t len)\r\n{\r\nunsigned char *f = (unsigned char *)from;\r\nunsigned char *t = (unsigned char *)map->virt + to;\r\nunsigned long flags;\r\nspin_lock_irqsave(&ebu_lock, flags);\r\nwhile (len--)\r\n*t++ = *f++;\r\nspin_unlock_irqrestore(&ebu_lock, flags);\r\n}\r\nstatic int __init\r\nltq_mtd_probe(struct platform_device *pdev)\r\n{\r\nstruct physmap_flash_data *ltq_mtd_data = dev_get_platdata(&pdev->dev);\r\nstruct ltq_mtd *ltq_mtd;\r\nstruct mtd_partition *parts;\r\nstruct resource *res;\r\nint nr_parts = 0;\r\nstruct cfi_private *cfi;\r\nint err;\r\nltq_mtd = kzalloc(sizeof(struct ltq_mtd), GFP_KERNEL);\r\nplatform_set_drvdata(pdev, ltq_mtd);\r\nltq_mtd->res = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!ltq_mtd->res) {\r\ndev_err(&pdev->dev, "failed to get memory resource");\r\nerr = -ENOENT;\r\ngoto err_out;\r\n}\r\nres = devm_request_mem_region(&pdev->dev, ltq_mtd->res->start,\r\nresource_size(ltq_mtd->res), dev_name(&pdev->dev));\r\nif (!ltq_mtd->res) {\r\ndev_err(&pdev->dev, "failed to request mem resource");\r\nerr = -EBUSY;\r\ngoto err_out;\r\n}\r\nltq_mtd->map = kzalloc(sizeof(struct map_info), GFP_KERNEL);\r\nltq_mtd->map->phys = res->start;\r\nltq_mtd->map->size = resource_size(res);\r\nltq_mtd->map->virt = devm_ioremap_nocache(&pdev->dev,\r\nltq_mtd->map->phys, ltq_mtd->map->size);\r\nif (!ltq_mtd->map->virt) {\r\ndev_err(&pdev->dev, "failed to ioremap!\n");\r\nerr = -ENOMEM;\r\ngoto err_free;\r\n}\r\nltq_mtd->map->name = ltq_map_name;\r\nltq_mtd->map->bankwidth = 2;\r\nltq_mtd->map->read = ltq_read16;\r\nltq_mtd->map->write = ltq_write16;\r\nltq_mtd->map->copy_from = ltq_copy_from;\r\nltq_mtd->map->copy_to = ltq_copy_to;\r\nltq_mtd->map->map_priv_1 = LTQ_NOR_PROBING;\r\nltq_mtd->mtd = do_map_probe("cfi_probe", ltq_mtd->map);\r\nltq_mtd->map->map_priv_1 = LTQ_NOR_NORMAL;\r\nif (!ltq_mtd->mtd) {\r\ndev_err(&pdev->dev, "probing failed\n");\r\nerr = -ENXIO;\r\ngoto err_unmap;\r\n}\r\nltq_mtd->mtd->owner = THIS_MODULE;\r\ncfi = ltq_mtd->map->fldrv_priv;\r\ncfi->addr_unlock1 ^= 1;\r\ncfi->addr_unlock2 ^= 1;\r\nnr_parts = parse_mtd_partitions(ltq_mtd->mtd,\r\npart_probe_types, &parts, 0);\r\nif (nr_parts > 0) {\r\ndev_info(&pdev->dev,\r\n"using %d partitions from cmdline", nr_parts);\r\n} else {\r\nnr_parts = ltq_mtd_data->nr_parts;\r\nparts = ltq_mtd_data->parts;\r\n}\r\nerr = add_mtd_partitions(ltq_mtd->mtd, parts, nr_parts);\r\nif (err) {\r\ndev_err(&pdev->dev, "failed to add partitions\n");\r\ngoto err_destroy;\r\n}\r\nreturn 0;\r\nerr_destroy:\r\nmap_destroy(ltq_mtd->mtd);\r\nerr_unmap:\r\niounmap(ltq_mtd->map->virt);\r\nerr_free:\r\nkfree(ltq_mtd->map);\r\nerr_out:\r\nkfree(ltq_mtd);\r\nreturn err;\r\n}\r\nstatic int __devexit\r\nltq_mtd_remove(struct platform_device *pdev)\r\n{\r\nstruct ltq_mtd *ltq_mtd = platform_get_drvdata(pdev);\r\nif (ltq_mtd) {\r\nif (ltq_mtd->mtd) {\r\ndel_mtd_partitions(ltq_mtd->mtd);\r\nmap_destroy(ltq_mtd->mtd);\r\n}\r\nif (ltq_mtd->map->virt)\r\niounmap(ltq_mtd->map->virt);\r\nkfree(ltq_mtd->map);\r\nkfree(ltq_mtd);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init\r\ninit_ltq_mtd(void)\r\n{\r\nint ret = platform_driver_probe(&ltq_mtd_driver, ltq_mtd_probe);\r\nif (ret)\r\npr_err("ltq_nor: error registering platform driver");\r\nreturn ret;\r\n}\r\nstatic void __exit\r\nexit_ltq_mtd(void)\r\n{\r\nplatform_driver_unregister(&ltq_mtd_driver);\r\n}

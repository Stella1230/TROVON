static void ams_idev_poll(struct input_polled_dev *dev)\r\n{\r\nstruct input_dev *idev = dev->input;\r\ns8 x, y, z;\r\nmutex_lock(&ams_info.lock);\r\nams_sensors(&x, &y, &z);\r\nx -= ams_info.xcalib;\r\ny -= ams_info.ycalib;\r\nz -= ams_info.zcalib;\r\ninput_report_abs(idev, ABS_X, invert ? -x : x);\r\ninput_report_abs(idev, ABS_Y, invert ? -y : y);\r\ninput_report_abs(idev, ABS_Z, z);\r\ninput_sync(idev);\r\nmutex_unlock(&ams_info.lock);\r\n}\r\nstatic int ams_input_enable(void)\r\n{\r\nstruct input_dev *input;\r\ns8 x, y, z;\r\nint error;\r\nams_sensors(&x, &y, &z);\r\nams_info.xcalib = x;\r\nams_info.ycalib = y;\r\nams_info.zcalib = z;\r\nams_info.idev = input_allocate_polled_device();\r\nif (!ams_info.idev)\r\nreturn -ENOMEM;\r\nams_info.idev->poll = ams_idev_poll;\r\nams_info.idev->poll_interval = 25;\r\ninput = ams_info.idev->input;\r\ninput->name = "Apple Motion Sensor";\r\ninput->id.bustype = ams_info.bustype;\r\ninput->id.vendor = 0;\r\ninput->dev.parent = &ams_info.of_dev->dev;\r\ninput_set_abs_params(input, ABS_X, -50, 50, 3, 0);\r\ninput_set_abs_params(input, ABS_Y, -50, 50, 3, 0);\r\ninput_set_abs_params(input, ABS_Z, -50, 50, 3, 0);\r\nset_bit(EV_ABS, input->evbit);\r\nset_bit(EV_KEY, input->evbit);\r\nset_bit(BTN_TOUCH, input->keybit);\r\nerror = input_register_polled_device(ams_info.idev);\r\nif (error) {\r\ninput_free_polled_device(ams_info.idev);\r\nams_info.idev = NULL;\r\nreturn error;\r\n}\r\njoystick = 1;\r\nreturn 0;\r\n}\r\nstatic void ams_input_disable(void)\r\n{\r\nif (ams_info.idev) {\r\ninput_unregister_polled_device(ams_info.idev);\r\ninput_free_polled_device(ams_info.idev);\r\nams_info.idev = NULL;\r\n}\r\njoystick = 0;\r\n}\r\nstatic ssize_t ams_input_show_joystick(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "%d\n", joystick);\r\n}\r\nstatic ssize_t ams_input_store_joystick(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nunsigned long enable;\r\nint error = 0;\r\nif (strict_strtoul(buf, 0, &enable) || enable > 1)\r\nreturn -EINVAL;\r\nmutex_lock(&ams_input_mutex);\r\nif (enable != joystick) {\r\nif (enable)\r\nerror = ams_input_enable();\r\nelse\r\nams_input_disable();\r\n}\r\nmutex_unlock(&ams_input_mutex);\r\nreturn error ? error : count;\r\n}\r\nint ams_input_init(void)\r\n{\r\nif (joystick)\r\nams_input_enable();\r\nreturn device_create_file(&ams_info.of_dev->dev, &dev_attr_joystick);\r\n}\r\nvoid ams_input_exit(void)\r\n{\r\ndevice_remove_file(&ams_info.of_dev->dev, &dev_attr_joystick);\r\nmutex_lock(&ams_input_mutex);\r\nams_input_disable();\r\nmutex_unlock(&ams_input_mutex);\r\n}

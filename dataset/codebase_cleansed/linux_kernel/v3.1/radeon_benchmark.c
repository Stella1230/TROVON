void radeon_benchmark_move(struct radeon_device *rdev, unsigned bsize,\r\nunsigned sdomain, unsigned ddomain)\r\n{\r\nstruct radeon_bo *dobj = NULL;\r\nstruct radeon_bo *sobj = NULL;\r\nstruct radeon_fence *fence = NULL;\r\nuint64_t saddr, daddr;\r\nunsigned long start_jiffies;\r\nunsigned long end_jiffies;\r\nunsigned long time;\r\nunsigned i, n, size;\r\nint r;\r\nsize = bsize;\r\nn = 1024;\r\nr = radeon_bo_create(rdev, size, PAGE_SIZE, true, sdomain, &sobj);\r\nif (r) {\r\ngoto out_cleanup;\r\n}\r\nr = radeon_bo_reserve(sobj, false);\r\nif (unlikely(r != 0))\r\ngoto out_cleanup;\r\nr = radeon_bo_pin(sobj, sdomain, &saddr);\r\nradeon_bo_unreserve(sobj);\r\nif (r) {\r\ngoto out_cleanup;\r\n}\r\nr = radeon_bo_create(rdev, size, PAGE_SIZE, true, ddomain, &dobj);\r\nif (r) {\r\ngoto out_cleanup;\r\n}\r\nr = radeon_bo_reserve(dobj, false);\r\nif (unlikely(r != 0))\r\ngoto out_cleanup;\r\nr = radeon_bo_pin(dobj, ddomain, &daddr);\r\nradeon_bo_unreserve(dobj);\r\nif (r) {\r\ngoto out_cleanup;\r\n}\r\nif (rdev->asic->copy_dma) {\r\nstart_jiffies = jiffies;\r\nfor (i = 0; i < n; i++) {\r\nr = radeon_fence_create(rdev, &fence);\r\nif (r) {\r\ngoto out_cleanup;\r\n}\r\nr = radeon_copy_dma(rdev, saddr, daddr,\r\nsize / RADEON_GPU_PAGE_SIZE, fence);\r\nif (r) {\r\ngoto out_cleanup;\r\n}\r\nr = radeon_fence_wait(fence, false);\r\nif (r) {\r\ngoto out_cleanup;\r\n}\r\nradeon_fence_unref(&fence);\r\n}\r\nend_jiffies = jiffies;\r\ntime = end_jiffies - start_jiffies;\r\ntime = jiffies_to_msecs(time);\r\nif (time > 0) {\r\ni = ((n * size) >> 10) / time;\r\nprintk(KERN_INFO "radeon: dma %u bo moves of %ukb from"\r\n" %d to %d in %lums (%ukb/ms %ukb/s %uM/s)\n",\r\nn, size >> 10,\r\nsdomain, ddomain, time,\r\ni, i * 1000, (i * 1000) / 1024);\r\n}\r\n}\r\nstart_jiffies = jiffies;\r\nfor (i = 0; i < n; i++) {\r\nr = radeon_fence_create(rdev, &fence);\r\nif (r) {\r\ngoto out_cleanup;\r\n}\r\nr = radeon_copy_blit(rdev, saddr, daddr, size / RADEON_GPU_PAGE_SIZE, fence);\r\nif (r) {\r\ngoto out_cleanup;\r\n}\r\nr = radeon_fence_wait(fence, false);\r\nif (r) {\r\ngoto out_cleanup;\r\n}\r\nradeon_fence_unref(&fence);\r\n}\r\nend_jiffies = jiffies;\r\ntime = end_jiffies - start_jiffies;\r\ntime = jiffies_to_msecs(time);\r\nif (time > 0) {\r\ni = ((n * size) >> 10) / time;\r\nprintk(KERN_INFO "radeon: blit %u bo moves of %ukb from %d to %d"\r\n" in %lums (%ukb/ms %ukb/s %uM/s)\n", n, size >> 10,\r\nsdomain, ddomain, time, i, i * 1000, (i * 1000) / 1024);\r\n}\r\nout_cleanup:\r\nif (sobj) {\r\nr = radeon_bo_reserve(sobj, false);\r\nif (likely(r == 0)) {\r\nradeon_bo_unpin(sobj);\r\nradeon_bo_unreserve(sobj);\r\n}\r\nradeon_bo_unref(&sobj);\r\n}\r\nif (dobj) {\r\nr = radeon_bo_reserve(dobj, false);\r\nif (likely(r == 0)) {\r\nradeon_bo_unpin(dobj);\r\nradeon_bo_unreserve(dobj);\r\n}\r\nradeon_bo_unref(&dobj);\r\n}\r\nif (fence) {\r\nradeon_fence_unref(&fence);\r\n}\r\nif (r) {\r\nprintk(KERN_WARNING "Error while benchmarking BO move.\n");\r\n}\r\n}\r\nvoid radeon_benchmark(struct radeon_device *rdev)\r\n{\r\nradeon_benchmark_move(rdev, 1024*1024, RADEON_GEM_DOMAIN_GTT,\r\nRADEON_GEM_DOMAIN_VRAM);\r\nradeon_benchmark_move(rdev, 1024*1024, RADEON_GEM_DOMAIN_VRAM,\r\nRADEON_GEM_DOMAIN_GTT);\r\n}

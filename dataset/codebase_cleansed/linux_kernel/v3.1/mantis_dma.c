int mantis_dma_exit(struct mantis_pci *mantis)\r\n{\r\nif (mantis->buf_cpu) {\r\ndprintk(MANTIS_ERROR, 1,\r\n"DMA=0x%lx cpu=0x%p size=%d",\r\n(unsigned long) mantis->buf_dma,\r\nmantis->buf_cpu,\r\nMANTIS_BUF_SIZE);\r\npci_free_consistent(mantis->pdev, MANTIS_BUF_SIZE,\r\nmantis->buf_cpu, mantis->buf_dma);\r\nmantis->buf_cpu = NULL;\r\n}\r\nif (mantis->risc_cpu) {\r\ndprintk(MANTIS_ERROR, 1,\r\n"RISC=0x%lx cpu=0x%p size=%lx",\r\n(unsigned long) mantis->risc_dma,\r\nmantis->risc_cpu,\r\nMANTIS_RISC_SIZE);\r\npci_free_consistent(mantis->pdev, MANTIS_RISC_SIZE,\r\nmantis->risc_cpu, mantis->risc_dma);\r\nmantis->risc_cpu = NULL;\r\n}\r\nreturn 0;\r\n}\r\nstatic inline int mantis_alloc_buffers(struct mantis_pci *mantis)\r\n{\r\nif (!mantis->buf_cpu) {\r\nmantis->buf_cpu = pci_alloc_consistent(mantis->pdev,\r\nMANTIS_BUF_SIZE,\r\n&mantis->buf_dma);\r\nif (!mantis->buf_cpu) {\r\ndprintk(MANTIS_ERROR, 1,\r\n"DMA buffer allocation failed");\r\ngoto err;\r\n}\r\ndprintk(MANTIS_ERROR, 1,\r\n"DMA=0x%lx cpu=0x%p size=%d",\r\n(unsigned long) mantis->buf_dma,\r\nmantis->buf_cpu, MANTIS_BUF_SIZE);\r\n}\r\nif (!mantis->risc_cpu) {\r\nmantis->risc_cpu = pci_alloc_consistent(mantis->pdev,\r\nMANTIS_RISC_SIZE,\r\n&mantis->risc_dma);\r\nif (!mantis->risc_cpu) {\r\ndprintk(MANTIS_ERROR, 1,\r\n"RISC program allocation failed");\r\nmantis_dma_exit(mantis);\r\ngoto err;\r\n}\r\ndprintk(MANTIS_ERROR, 1,\r\n"RISC=0x%lx cpu=0x%p size=%lx",\r\n(unsigned long) mantis->risc_dma,\r\nmantis->risc_cpu, MANTIS_RISC_SIZE);\r\n}\r\nreturn 0;\r\nerr:\r\ndprintk(MANTIS_ERROR, 1, "Out of memory (?) .....");\r\nreturn -ENOMEM;\r\n}\r\nstatic inline int mantis_calc_lines(struct mantis_pci *mantis)\r\n{\r\nmantis->line_bytes = MANTIS_BLOCK_BYTES;\r\nmantis->line_count = MANTIS_BLOCK_COUNT;\r\nwhile (mantis->line_bytes > 4095) {\r\nmantis->line_bytes >>= 1;\r\nmantis->line_count <<= 1;\r\n}\r\ndprintk(MANTIS_DEBUG, 1, "Mantis RISC block bytes=[%d], line bytes=[%d], line count=[%d]",\r\nMANTIS_BLOCK_BYTES, mantis->line_bytes, mantis->line_count);\r\nif (mantis->line_count > 255) {\r\ndprintk(MANTIS_ERROR, 1, "Buffer size error");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nint mantis_dma_init(struct mantis_pci *mantis)\r\n{\r\nint err = 0;\r\ndprintk(MANTIS_DEBUG, 1, "Mantis DMA init");\r\nif (mantis_alloc_buffers(mantis) < 0) {\r\ndprintk(MANTIS_ERROR, 1, "Error allocating DMA buffer");\r\nmmwrite(0, MANTIS_DMA_CTL);\r\ngoto err;\r\n}\r\nerr = mantis_calc_lines(mantis);\r\nif (err < 0) {\r\ndprintk(MANTIS_ERROR, 1, "Mantis calc lines failed");\r\ngoto err;\r\n}\r\nreturn 0;\r\nerr:\r\nreturn err;\r\n}\r\nstatic inline void mantis_risc_program(struct mantis_pci *mantis)\r\n{\r\nu32 buf_pos = 0;\r\nu32 line;\r\ndprintk(MANTIS_DEBUG, 1, "Mantis create RISC program");\r\nRISC_FLUSH();\r\ndprintk(MANTIS_DEBUG, 1, "risc len lines %u, bytes per line %u",\r\nmantis->line_count, mantis->line_bytes);\r\nfor (line = 0; line < mantis->line_count; line++) {\r\ndprintk(MANTIS_DEBUG, 1, "RISC PROG line=[%d]", line);\r\nif (!(buf_pos % MANTIS_BLOCK_BYTES)) {\r\nRISC_INSTR(RISC_WRITE |\r\nRISC_IRQ |\r\nRISC_STATUS(((buf_pos / MANTIS_BLOCK_BYTES) +\r\n(MANTIS_BLOCK_COUNT - 1)) %\r\nMANTIS_BLOCK_COUNT) |\r\nmantis->line_bytes);\r\n} else {\r\nRISC_INSTR(RISC_WRITE | mantis->line_bytes);\r\n}\r\nRISC_INSTR(mantis->buf_dma + buf_pos);\r\nbuf_pos += mantis->line_bytes;\r\n}\r\nRISC_INSTR(RISC_JUMP);\r\nRISC_INSTR(mantis->risc_dma);\r\n}\r\nvoid mantis_dma_start(struct mantis_pci *mantis)\r\n{\r\ndprintk(MANTIS_DEBUG, 1, "Mantis Start DMA engine");\r\nmantis_risc_program(mantis);\r\nmmwrite(mantis->risc_dma, MANTIS_RISC_START);\r\nmmwrite(mmread(MANTIS_GPIF_ADDR) | MANTIS_GPIF_HIFRDWRN, MANTIS_GPIF_ADDR);\r\nmmwrite(0, MANTIS_DMA_CTL);\r\nmantis->last_block = mantis->finished_block = 0;\r\nmmwrite(mmread(MANTIS_INT_MASK) | MANTIS_INT_RISCI, MANTIS_INT_MASK);\r\nmmwrite(MANTIS_FIFO_EN | MANTIS_DCAP_EN\r\n| MANTIS_RISC_EN, MANTIS_DMA_CTL);\r\n}\r\nvoid mantis_dma_stop(struct mantis_pci *mantis)\r\n{\r\nu32 stat = 0, mask = 0;\r\nstat = mmread(MANTIS_INT_STAT);\r\nmask = mmread(MANTIS_INT_MASK);\r\ndprintk(MANTIS_DEBUG, 1, "Mantis Stop DMA engine");\r\nmmwrite((mmread(MANTIS_GPIF_ADDR) & (~(MANTIS_GPIF_HIFRDWRN))), MANTIS_GPIF_ADDR);\r\nmmwrite((mmread(MANTIS_DMA_CTL) & ~(MANTIS_FIFO_EN |\r\nMANTIS_DCAP_EN |\r\nMANTIS_RISC_EN)), MANTIS_DMA_CTL);\r\nmmwrite(mmread(MANTIS_INT_STAT), MANTIS_INT_STAT);\r\nmmwrite(mmread(MANTIS_INT_MASK) & ~(MANTIS_INT_RISCI |\r\nMANTIS_INT_RISCEN), MANTIS_INT_MASK);\r\n}\r\nvoid mantis_dma_xfer(unsigned long data)\r\n{\r\nstruct mantis_pci *mantis = (struct mantis_pci *) data;\r\nstruct mantis_hwconfig *config = mantis->hwconfig;\r\nwhile (mantis->last_block != mantis->finished_block) {\r\ndprintk(MANTIS_DEBUG, 1, "last block=[%d] finished block=[%d]",\r\nmantis->last_block, mantis->finished_block);\r\n(config->ts_size ? dvb_dmx_swfilter_204 : dvb_dmx_swfilter)\r\n(&mantis->demux, &mantis->buf_cpu[mantis->last_block * MANTIS_BLOCK_BYTES], MANTIS_BLOCK_BYTES);\r\nmantis->last_block = (mantis->last_block + 1) % MANTIS_BLOCK_COUNT;\r\n}\r\n}

static int cs5535_cable_detect(struct ata_port *ap)\r\n{\r\nu8 cable;\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\npci_read_config_byte(pdev, CS5535_CABLE_DETECT, &cable);\r\nif (cable & 1)\r\nreturn ATA_CBL_PATA80;\r\nelse\r\nreturn ATA_CBL_PATA40;\r\n}\r\nstatic void cs5535_set_piomode(struct ata_port *ap, struct ata_device *adev)\r\n{\r\nstatic const u16 pio_timings[5] = {\r\n0xF7F4, 0xF173, 0x8141, 0x5131, 0x1131\r\n};\r\nstatic const u16 pio_cmd_timings[5] = {\r\n0xF7F4, 0x53F3, 0x13F1, 0x5131, 0x1131\r\n};\r\nu32 reg, dummy;\r\nstruct ata_device *pair = ata_dev_pair(adev);\r\nint mode = adev->pio_mode - XFER_PIO_0;\r\nint cmdmode = mode;\r\nif (pair) {\r\nint pairmode = pair->pio_mode - XFER_PIO_0;\r\ncmdmode = min(mode, pairmode);\r\nif (cmdmode < pairmode)\r\nwrmsr(ATAC_CH0D0_PIO + 2 * pair->devno,\r\npio_cmd_timings[cmdmode] << 16 | pio_timings[pairmode], 0);\r\n}\r\nwrmsr(ATAC_CH0D0_PIO + 2 * adev->devno,\r\npio_cmd_timings[cmdmode] << 16 | pio_timings[mode], 0);\r\nrdmsr(ATAC_CH0D0_DMA + 2 * adev->devno, reg, dummy);\r\nwrmsr(ATAC_CH0D0_DMA + 2 * adev->devno, reg | 0x80000000UL, 0);\r\n}\r\nstatic void cs5535_set_dmamode(struct ata_port *ap, struct ata_device *adev)\r\n{\r\nstatic const u32 udma_timings[5] = {\r\n0x7F7436A1, 0x7F733481, 0x7F723261, 0x7F713161, 0x7F703061\r\n};\r\nstatic const u32 mwdma_timings[3] = {\r\n0x7F0FFFF3, 0x7F035352, 0x7F024241\r\n};\r\nu32 reg, dummy;\r\nint mode = adev->dma_mode;\r\nrdmsr(ATAC_CH0D0_DMA + 2 * adev->devno, reg, dummy);\r\nreg &= 0x80000000UL;\r\nif (mode >= XFER_UDMA_0)\r\nreg |= udma_timings[mode - XFER_UDMA_0];\r\nelse\r\nreg |= mwdma_timings[mode - XFER_MW_DMA_0];\r\nwrmsr(ATAC_CH0D0_DMA + 2 * adev->devno, reg, 0);\r\n}\r\nstatic int cs5535_init_one(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nstatic const struct ata_port_info info = {\r\n.flags = ATA_FLAG_SLAVE_POSS,\r\n.pio_mask = ATA_PIO4,\r\n.mwdma_mask = ATA_MWDMA2,\r\n.udma_mask = ATA_UDMA4,\r\n.port_ops = &cs5535_port_ops\r\n};\r\nconst struct ata_port_info *ppi[] = { &info, &ata_dummy_port_info };\r\nu32 timings, dummy;\r\nrdmsr(ATAC_CH0D0_PIO, timings, dummy);\r\nif (CS5535_BAD_PIO(timings))\r\nwrmsr(ATAC_CH0D0_PIO, 0xF7F4F7F4UL, 0);\r\nrdmsr(ATAC_CH0D1_PIO, timings, dummy);\r\nif (CS5535_BAD_PIO(timings))\r\nwrmsr(ATAC_CH0D1_PIO, 0xF7F4F7F4UL, 0);\r\nreturn ata_pci_bmdma_init_one(dev, ppi, &cs5535_sht, NULL, 0);\r\n}\r\nstatic int __init cs5535_init(void)\r\n{\r\nreturn pci_register_driver(&cs5535_pci_driver);\r\n}\r\nstatic void __exit cs5535_exit(void)\r\n{\r\npci_unregister_driver(&cs5535_pci_driver);\r\n}

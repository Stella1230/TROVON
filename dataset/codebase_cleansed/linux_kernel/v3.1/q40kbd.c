static irqreturn_t q40kbd_interrupt(int irq, void *dev_id)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&q40kbd_lock, flags);\r\nif (Q40_IRQ_KEYB_MASK & master_inb(INTERRUPT_REG))\r\nserio_interrupt(q40kbd_port, master_inb(KEYCODE_REG), 0);\r\nmaster_outb(-1, KEYBOARD_UNLOCK_REG);\r\nspin_unlock_irqrestore(&q40kbd_lock, flags);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void q40kbd_flush(void)\r\n{\r\nint maxread = 100;\r\nunsigned long flags;\r\nspin_lock_irqsave(&q40kbd_lock, flags);\r\nwhile (maxread-- && (Q40_IRQ_KEYB_MASK & master_inb(INTERRUPT_REG)))\r\nmaster_inb(KEYCODE_REG);\r\nspin_unlock_irqrestore(&q40kbd_lock, flags);\r\n}\r\nstatic int q40kbd_open(struct serio *port)\r\n{\r\nq40kbd_flush();\r\nif (request_irq(Q40_IRQ_KEYBOARD, q40kbd_interrupt, 0, "q40kbd", NULL)) {\r\nprintk(KERN_ERR "q40kbd.c: Can't get irq %d.\n", Q40_IRQ_KEYBOARD);\r\nreturn -EBUSY;\r\n}\r\nmaster_outb(-1, KEYBOARD_UNLOCK_REG);\r\nmaster_outb(1, KEY_IRQ_ENABLE_REG);\r\nreturn 0;\r\n}\r\nstatic void q40kbd_close(struct serio *port)\r\n{\r\nmaster_outb(0, KEY_IRQ_ENABLE_REG);\r\nmaster_outb(-1, KEYBOARD_UNLOCK_REG);\r\nfree_irq(Q40_IRQ_KEYBOARD, NULL);\r\nq40kbd_flush();\r\n}\r\nstatic int __devinit q40kbd_probe(struct platform_device *dev)\r\n{\r\nq40kbd_port = kzalloc(sizeof(struct serio), GFP_KERNEL);\r\nif (!q40kbd_port)\r\nreturn -ENOMEM;\r\nq40kbd_port->id.type = SERIO_8042;\r\nq40kbd_port->open = q40kbd_open;\r\nq40kbd_port->close = q40kbd_close;\r\nq40kbd_port->dev.parent = &dev->dev;\r\nstrlcpy(q40kbd_port->name, "Q40 Kbd Port", sizeof(q40kbd_port->name));\r\nstrlcpy(q40kbd_port->phys, "Q40", sizeof(q40kbd_port->phys));\r\nserio_register_port(q40kbd_port);\r\nprintk(KERN_INFO "serio: Q40 kbd registered\n");\r\nreturn 0;\r\n}\r\nstatic int __devexit q40kbd_remove(struct platform_device *dev)\r\n{\r\nserio_unregister_port(q40kbd_port);\r\nreturn 0;\r\n}\r\nstatic int __init q40kbd_init(void)\r\n{\r\nint error;\r\nif (!MACH_IS_Q40)\r\nreturn -ENODEV;\r\nerror = platform_driver_register(&q40kbd_driver);\r\nif (error)\r\nreturn error;\r\nq40kbd_device = platform_device_alloc("q40kbd", -1);\r\nif (!q40kbd_device)\r\ngoto err_unregister_driver;\r\nerror = platform_device_add(q40kbd_device);\r\nif (error)\r\ngoto err_free_device;\r\nreturn 0;\r\nerr_free_device:\r\nplatform_device_put(q40kbd_device);\r\nerr_unregister_driver:\r\nplatform_driver_unregister(&q40kbd_driver);\r\nreturn error;\r\n}\r\nstatic void __exit q40kbd_exit(void)\r\n{\r\nplatform_device_unregister(q40kbd_device);\r\nplatform_driver_unregister(&q40kbd_driver);\r\n}

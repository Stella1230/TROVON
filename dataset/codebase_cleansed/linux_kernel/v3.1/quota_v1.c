static inline qsize_t v1_stoqb(qsize_t space)\r\n{\r\nreturn (space + QUOTABLOCK_SIZE - 1) >> QUOTABLOCK_BITS;\r\n}\r\nstatic inline qsize_t v1_qbtos(qsize_t blocks)\r\n{\r\nreturn blocks << QUOTABLOCK_BITS;\r\n}\r\nstatic void v1_disk2mem_dqblk(struct mem_dqblk *m, struct v1_disk_dqblk *d)\r\n{\r\nm->dqb_ihardlimit = d->dqb_ihardlimit;\r\nm->dqb_isoftlimit = d->dqb_isoftlimit;\r\nm->dqb_curinodes = d->dqb_curinodes;\r\nm->dqb_bhardlimit = v1_qbtos(d->dqb_bhardlimit);\r\nm->dqb_bsoftlimit = v1_qbtos(d->dqb_bsoftlimit);\r\nm->dqb_curspace = v1_qbtos(d->dqb_curblocks);\r\nm->dqb_itime = d->dqb_itime;\r\nm->dqb_btime = d->dqb_btime;\r\n}\r\nstatic void v1_mem2disk_dqblk(struct v1_disk_dqblk *d, struct mem_dqblk *m)\r\n{\r\nd->dqb_ihardlimit = m->dqb_ihardlimit;\r\nd->dqb_isoftlimit = m->dqb_isoftlimit;\r\nd->dqb_curinodes = m->dqb_curinodes;\r\nd->dqb_bhardlimit = v1_stoqb(m->dqb_bhardlimit);\r\nd->dqb_bsoftlimit = v1_stoqb(m->dqb_bsoftlimit);\r\nd->dqb_curblocks = v1_stoqb(m->dqb_curspace);\r\nd->dqb_itime = m->dqb_itime;\r\nd->dqb_btime = m->dqb_btime;\r\n}\r\nstatic int v1_read_dqblk(struct dquot *dquot)\r\n{\r\nint type = dquot->dq_type;\r\nstruct v1_disk_dqblk dqblk;\r\nif (!sb_dqopt(dquot->dq_sb)->files[type])\r\nreturn -EINVAL;\r\nmemset(&dqblk, 0, sizeof(struct v1_disk_dqblk));\r\ndquot->dq_sb->s_op->quota_read(dquot->dq_sb, type, (char *)&dqblk,\r\nsizeof(struct v1_disk_dqblk), v1_dqoff(dquot->dq_id));\r\nv1_disk2mem_dqblk(&dquot->dq_dqb, &dqblk);\r\nif (dquot->dq_dqb.dqb_bhardlimit == 0 &&\r\ndquot->dq_dqb.dqb_bsoftlimit == 0 &&\r\ndquot->dq_dqb.dqb_ihardlimit == 0 &&\r\ndquot->dq_dqb.dqb_isoftlimit == 0)\r\nset_bit(DQ_FAKE_B, &dquot->dq_flags);\r\ndqstats_inc(DQST_READS);\r\nreturn 0;\r\n}\r\nstatic int v1_commit_dqblk(struct dquot *dquot)\r\n{\r\nshort type = dquot->dq_type;\r\nssize_t ret;\r\nstruct v1_disk_dqblk dqblk;\r\nv1_mem2disk_dqblk(&dqblk, &dquot->dq_dqb);\r\nif (dquot->dq_id == 0) {\r\ndqblk.dqb_btime =\r\nsb_dqopt(dquot->dq_sb)->info[type].dqi_bgrace;\r\ndqblk.dqb_itime =\r\nsb_dqopt(dquot->dq_sb)->info[type].dqi_igrace;\r\n}\r\nret = 0;\r\nif (sb_dqopt(dquot->dq_sb)->files[type])\r\nret = dquot->dq_sb->s_op->quota_write(dquot->dq_sb, type,\r\n(char *)&dqblk, sizeof(struct v1_disk_dqblk),\r\nv1_dqoff(dquot->dq_id));\r\nif (ret != sizeof(struct v1_disk_dqblk)) {\r\nquota_error(dquot->dq_sb, "dquota write failed");\r\nif (ret >= 0)\r\nret = -EIO;\r\ngoto out;\r\n}\r\nret = 0;\r\nout:\r\ndqstats_inc(DQST_WRITES);\r\nreturn ret;\r\n}\r\nstatic int v1_check_quota_file(struct super_block *sb, int type)\r\n{\r\nstruct inode *inode = sb_dqopt(sb)->files[type];\r\nulong blocks;\r\nsize_t off;\r\nstruct v2_disk_dqheader dqhead;\r\nssize_t size;\r\nloff_t isize;\r\nstatic const uint quota_magics[] = V2_INITQMAGICS;\r\nisize = i_size_read(inode);\r\nif (!isize)\r\nreturn 0;\r\nblocks = isize >> BLOCK_SIZE_BITS;\r\noff = isize & (BLOCK_SIZE - 1);\r\nif ((blocks % sizeof(struct v1_disk_dqblk) * BLOCK_SIZE + off) %\r\nsizeof(struct v1_disk_dqblk))\r\nreturn 0;\r\nsize = sb->s_op->quota_read(sb, type, (char *)&dqhead,\r\nsizeof(struct v2_disk_dqheader), 0);\r\nif (size != sizeof(struct v2_disk_dqheader))\r\nreturn 1;\r\nif (le32_to_cpu(dqhead.dqh_magic) != quota_magics[type])\r\nreturn 1;\r\nprintk(KERN_INFO\r\n"VFS: %s: Refusing to turn on old quota format on given file."\r\n" It probably contains newer quota format.\n", sb->s_id);\r\nreturn 0;\r\n}\r\nstatic int v1_read_file_info(struct super_block *sb, int type)\r\n{\r\nstruct quota_info *dqopt = sb_dqopt(sb);\r\nstruct v1_disk_dqblk dqblk;\r\nint ret;\r\nret = sb->s_op->quota_read(sb, type, (char *)&dqblk,\r\nsizeof(struct v1_disk_dqblk), v1_dqoff(0));\r\nif (ret != sizeof(struct v1_disk_dqblk)) {\r\nif (ret >= 0)\r\nret = -EIO;\r\ngoto out;\r\n}\r\nret = 0;\r\ndqopt->info[type].dqi_maxblimit = 0xffffffff;\r\ndqopt->info[type].dqi_maxilimit = 0xffffffff;\r\ndqopt->info[type].dqi_igrace =\r\ndqblk.dqb_itime ? dqblk.dqb_itime : MAX_IQ_TIME;\r\ndqopt->info[type].dqi_bgrace =\r\ndqblk.dqb_btime ? dqblk.dqb_btime : MAX_DQ_TIME;\r\nout:\r\nreturn ret;\r\n}\r\nstatic int v1_write_file_info(struct super_block *sb, int type)\r\n{\r\nstruct quota_info *dqopt = sb_dqopt(sb);\r\nstruct v1_disk_dqblk dqblk;\r\nint ret;\r\ndqopt->info[type].dqi_flags &= ~DQF_INFO_DIRTY;\r\nret = sb->s_op->quota_read(sb, type, (char *)&dqblk,\r\nsizeof(struct v1_disk_dqblk), v1_dqoff(0));\r\nif (ret != sizeof(struct v1_disk_dqblk)) {\r\nif (ret >= 0)\r\nret = -EIO;\r\ngoto out;\r\n}\r\ndqblk.dqb_itime = dqopt->info[type].dqi_igrace;\r\ndqblk.dqb_btime = dqopt->info[type].dqi_bgrace;\r\nret = sb->s_op->quota_write(sb, type, (char *)&dqblk,\r\nsizeof(struct v1_disk_dqblk), v1_dqoff(0));\r\nif (ret == sizeof(struct v1_disk_dqblk))\r\nret = 0;\r\nelse if (ret > 0)\r\nret = -EIO;\r\nout:\r\nreturn ret;\r\n}\r\nstatic int __init init_v1_quota_format(void)\r\n{\r\nreturn register_quota_format(&v1_quota_format);\r\n}\r\nstatic void __exit exit_v1_quota_format(void)\r\n{\r\nunregister_quota_format(&v1_quota_format);\r\n}

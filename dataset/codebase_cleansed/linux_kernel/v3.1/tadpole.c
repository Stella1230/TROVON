static inline unsigned int ldphys(unsigned int addr)\r\n{\r\nunsigned long data;\r\n__asm__ __volatile__("\n\tlda [%1] %2, %0\n\t" :\r\n"=r" (data) :\r\n"r" (addr), "i" (ASI_M_BYPASS));\r\nreturn data;\r\n}\r\nstatic void clk_init(void)\r\n{\r\n__asm__ __volatile__("mov 0x6c, %%g1\n\t"\r\n"mov 0x4c, %%g2\n\t"\r\n"mov 0xdf, %%g3\n\t"\r\n"stb %%g1, [%0+3]\n\t"\r\n"stb %%g2, [%0+3]\n\t"\r\n"stb %%g3, [%0+3]\n\t" : :\r\n"r" (clk_ctrl) :\r\n"g1", "g2", "g3");\r\n}\r\nstatic void clk_slow(void)\r\n{\r\n__asm__ __volatile__("mov 0xcc, %%g2\n\t"\r\n"mov 0x4c, %%g3\n\t"\r\n"mov 0xcf, %%g4\n\t"\r\n"mov 0xdf, %%g5\n\t"\r\n"stb %%g2, [%0+3]\n\t"\r\n"stb %%g3, [%0+3]\n\t"\r\n"stb %%g4, [%0+3]\n\t"\r\n"stb %%g5, [%0+3]\n\t" : :\r\n"r" (clk_ctrl) :\r\n"g2", "g3", "g4", "g5");\r\n}\r\nstatic void tsu_clockstop(void)\r\n{\r\nunsigned int mcsr;\r\nunsigned long flags;\r\nif (!clk_ctrl)\r\nreturn;\r\nif (!(clk_state & CLOCK_INIT_DONE)) {\r\nlocal_irq_save(flags);\r\nclk_init();\r\nclk_state |= CLOCK_INIT_DONE;\r\nlocal_irq_restore(flags);\r\nreturn;\r\n}\r\nif (!(clk_ctrl[2] & 1))\r\nreturn;\r\nlocal_irq_save(flags);\r\nmcsr = ldphys(MACIO_SCSI_CSR_ADDR);\r\nif ((mcsr&MACIO_EN_DMA) != 0) {\r\nlocal_irq_restore(flags);\r\nreturn;\r\n}\r\nclk_slow();\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void swift_clockstop(void)\r\n{\r\nif (!clk_ctrl)\r\nreturn;\r\nclk_ctrl[0] = 0;\r\n}\r\nvoid __init clock_stop_probe(void)\r\n{\r\nphandle node, clk_nd;\r\nchar name[20];\r\nprom_getstring(prom_root_node, "name", name, sizeof(name));\r\nif (strncmp(name, "Tadpole", 7))\r\nreturn;\r\nnode = prom_getchild(prom_root_node);\r\nnode = prom_searchsiblings(node, "obio");\r\nnode = prom_getchild(node);\r\nclk_nd = prom_searchsiblings(node, "clk-ctrl");\r\nif (!clk_nd)\r\nreturn;\r\nprintk("Clock Stopping h/w detected... ");\r\nclk_ctrl = (char *) prom_getint(clk_nd, "address");\r\nclk_state = 0;\r\nif (name[10] == '\0') {\r\ncpu_pwr_save = tsu_clockstop;\r\nprintk("enabled (S3)\n");\r\n} else if ((name[10] == 'X') || (name[10] == 'G')) {\r\ncpu_pwr_save = swift_clockstop;\r\nprintk("enabled (%s)\n",name+7);\r\n} else\r\nprintk("disabled %s\n",name+7);\r\n}

static void pwmled_brightness(struct led_classdev *cdev, enum led_brightness b)\r\n{\r\nstruct pwmled *led;\r\nled = container_of(cdev, struct pwmled, cdev);\r\npwm_channel_writel(&led->pwmc, PWM_CUPD, led->mult * (unsigned) b);\r\n}\r\nstatic int __init pwmled_probe(struct platform_device *pdev)\r\n{\r\nconst struct gpio_led_platform_data *pdata;\r\nstruct pwmled *leds;\r\nint i;\r\nint status;\r\npdata = pdev->dev.platform_data;\r\nif (!pdata || pdata->num_leds < 1)\r\nreturn -ENODEV;\r\nleds = kcalloc(pdata->num_leds, sizeof(*leds), GFP_KERNEL);\r\nif (!leds)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < pdata->num_leds; i++) {\r\nstruct pwmled *led = leds + i;\r\nconst struct gpio_led *dat = pdata->leds + i;\r\nu32 tmp;\r\nled->cdev.name = dat->name;\r\nled->cdev.brightness = LED_OFF;\r\nled->cdev.brightness_set = pwmled_brightness;\r\nled->cdev.default_trigger = dat->default_trigger;\r\nled->active_low = dat->active_low;\r\nstatus = pwm_channel_alloc(dat->gpio, &led->pwmc);\r\nif (status < 0)\r\ngoto err;\r\ntmp = 5;\r\nif (!led->active_low)\r\ntmp |= PWM_CPR_CPOL;\r\npwm_channel_writel(&led->pwmc, PWM_CMR, tmp);\r\ntmp = (led->pwmc.mck / (1 << 5)) / 100;\r\ntmp /= 255;\r\nled->mult = tmp;\r\npwm_channel_writel(&led->pwmc, PWM_CDTY,\r\nled->cdev.brightness * 255);\r\npwm_channel_writel(&led->pwmc, PWM_CPRD,\r\nLED_FULL * tmp);\r\npwm_channel_enable(&led->pwmc);\r\nstatus = led_classdev_register(&pdev->dev, &led->cdev);\r\nif (status < 0) {\r\npwm_channel_free(&led->pwmc);\r\ngoto err;\r\n}\r\n}\r\nplatform_set_drvdata(pdev, leds);\r\nreturn 0;\r\nerr:\r\nif (i > 0) {\r\nfor (i = i - 1; i >= 0; i--) {\r\nled_classdev_unregister(&leds[i].cdev);\r\npwm_channel_free(&leds[i].pwmc);\r\n}\r\n}\r\nkfree(leds);\r\nreturn status;\r\n}\r\nstatic int __exit pwmled_remove(struct platform_device *pdev)\r\n{\r\nconst struct gpio_led_platform_data *pdata;\r\nstruct pwmled *leds;\r\nunsigned i;\r\npdata = pdev->dev.platform_data;\r\nleds = platform_get_drvdata(pdev);\r\nfor (i = 0; i < pdata->num_leds; i++) {\r\nstruct pwmled *led = leds + i;\r\nled_classdev_unregister(&led->cdev);\r\npwm_channel_free(&led->pwmc);\r\n}\r\nkfree(leds);\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn 0;\r\n}\r\nstatic int __init modinit(void)\r\n{\r\nreturn platform_driver_probe(&pwmled_driver, pwmled_probe);\r\n}\r\nstatic void __exit modexit(void)\r\n{\r\nplatform_driver_unregister(&pwmled_driver);\r\n}

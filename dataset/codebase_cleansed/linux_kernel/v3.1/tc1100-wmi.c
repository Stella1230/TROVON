static int get_state(u32 *out, u8 instance)\r\n{\r\nu32 tmp;\r\nacpi_status status;\r\nstruct acpi_buffer result = { ACPI_ALLOCATE_BUFFER, NULL };\r\nunion acpi_object *obj;\r\nif (!out)\r\nreturn -EINVAL;\r\nif (instance > 2)\r\nreturn -ENODEV;\r\nstatus = wmi_query_block(GUID, instance, &result);\r\nif (ACPI_FAILURE(status))\r\nreturn -ENODEV;\r\nobj = (union acpi_object *) result.pointer;\r\nif (obj && obj->type == ACPI_TYPE_INTEGER) {\r\ntmp = obj->integer.value;\r\n} else {\r\ntmp = 0;\r\n}\r\nif (result.length > 0 && result.pointer)\r\nkfree(result.pointer);\r\nswitch (instance) {\r\ncase TC1100_INSTANCE_WIRELESS:\r\n*out = (tmp == 3) ? 1 : 0;\r\nreturn 0;\r\ncase TC1100_INSTANCE_JOGDIAL:\r\n*out = (tmp == 1) ? 0 : 1;\r\nreturn 0;\r\ndefault:\r\nreturn -ENODEV;\r\n}\r\n}\r\nstatic int set_state(u32 *in, u8 instance)\r\n{\r\nu32 value;\r\nacpi_status status;\r\nstruct acpi_buffer input;\r\nif (!in)\r\nreturn -EINVAL;\r\nif (instance > 2)\r\nreturn -ENODEV;\r\nswitch (instance) {\r\ncase TC1100_INSTANCE_WIRELESS:\r\nvalue = (*in) ? 1 : 2;\r\nbreak;\r\ncase TC1100_INSTANCE_JOGDIAL:\r\nvalue = (*in) ? 0 : 1;\r\nbreak;\r\ndefault:\r\nreturn -ENODEV;\r\n}\r\ninput.length = sizeof(u32);\r\ninput.pointer = &value;\r\nstatus = wmi_set_block(GUID, instance, &input);\r\nif (ACPI_FAILURE(status))\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nstatic int __init tc1100_probe(struct platform_device *device)\r\n{\r\nreturn sysfs_create_group(&device->dev.kobj, &tc1100_attribute_group);\r\n}\r\nstatic int __devexit tc1100_remove(struct platform_device *device)\r\n{\r\nsysfs_remove_group(&device->dev.kobj, &tc1100_attribute_group);\r\nreturn 0;\r\n}\r\nstatic int tc1100_suspend(struct device *dev)\r\n{\r\nint ret;\r\nret = get_state(&suspend_data.wireless, TC1100_INSTANCE_WIRELESS);\r\nif (ret)\r\nreturn ret;\r\nret = get_state(&suspend_data.jogdial, TC1100_INSTANCE_JOGDIAL);\r\nif (ret)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int tc1100_resume(struct device *dev)\r\n{\r\nint ret;\r\nret = set_state(&suspend_data.wireless, TC1100_INSTANCE_WIRELESS);\r\nif (ret)\r\nreturn ret;\r\nret = set_state(&suspend_data.jogdial, TC1100_INSTANCE_JOGDIAL);\r\nif (ret)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int __init tc1100_init(void)\r\n{\r\nint error;\r\nif (!wmi_has_guid(GUID))\r\nreturn -ENODEV;\r\ntc1100_device = platform_device_alloc("tc1100-wmi", -1);\r\nif (!tc1100_device)\r\nreturn -ENOMEM;\r\nerror = platform_device_add(tc1100_device);\r\nif (error)\r\ngoto err_device_put;\r\nerror = platform_driver_probe(&tc1100_driver, tc1100_probe);\r\nif (error)\r\ngoto err_device_del;\r\npr_info("HP Compaq TC1100 Tablet WMI Extras loaded\n");\r\nreturn 0;\r\nerr_device_del:\r\nplatform_device_del(tc1100_device);\r\nerr_device_put:\r\nplatform_device_put(tc1100_device);\r\nreturn error;\r\n}\r\nstatic void __exit tc1100_exit(void)\r\n{\r\nplatform_device_unregister(tc1100_device);\r\nplatform_driver_unregister(&tc1100_driver);\r\n}

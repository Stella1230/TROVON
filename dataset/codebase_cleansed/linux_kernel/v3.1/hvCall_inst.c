static void *hc_start(struct seq_file *m, loff_t *pos)\r\n{\r\nif ((int)*pos < (HCALL_STAT_ARRAY_SIZE-1))\r\nreturn (void *)(unsigned long)(*pos + 1);\r\nreturn NULL;\r\n}\r\nstatic void *hc_next(struct seq_file *m, void *p, loff_t * pos)\r\n{\r\n++*pos;\r\nreturn hc_start(m, pos);\r\n}\r\nstatic void hc_stop(struct seq_file *m, void *p)\r\n{\r\n}\r\nstatic int hc_show(struct seq_file *m, void *p)\r\n{\r\nunsigned long h_num = (unsigned long)p;\r\nstruct hcall_stats *hs = m->private;\r\nif (hs[h_num].num_calls) {\r\nif (cpu_has_feature(CPU_FTR_PURR))\r\nseq_printf(m, "%lu %lu %lu %lu\n", h_num<<2,\r\nhs[h_num].num_calls,\r\nhs[h_num].tb_total,\r\nhs[h_num].purr_total);\r\nelse\r\nseq_printf(m, "%lu %lu %lu\n", h_num<<2,\r\nhs[h_num].num_calls,\r\nhs[h_num].tb_total);\r\n}\r\nreturn 0;\r\n}\r\nstatic int hcall_inst_seq_open(struct inode *inode, struct file *file)\r\n{\r\nint rc;\r\nstruct seq_file *seq;\r\nrc = seq_open(file, &hcall_inst_seq_ops);\r\nseq = file->private_data;\r\nseq->private = file->f_path.dentry->d_inode->i_private;\r\nreturn rc;\r\n}\r\nstatic void probe_hcall_entry(void *ignored, unsigned long opcode, unsigned long *args)\r\n{\r\nstruct hcall_stats *h;\r\nif (opcode > MAX_HCALL_OPCODE)\r\nreturn;\r\nh = &get_cpu_var(hcall_stats)[opcode / 4];\r\nh->tb_start = mftb();\r\nh->purr_start = mfspr(SPRN_PURR);\r\n}\r\nstatic void probe_hcall_exit(void *ignored, unsigned long opcode, unsigned long retval,\r\nunsigned long *retbuf)\r\n{\r\nstruct hcall_stats *h;\r\nif (opcode > MAX_HCALL_OPCODE)\r\nreturn;\r\nh = &__get_cpu_var(hcall_stats)[opcode / 4];\r\nh->num_calls++;\r\nh->tb_total += mftb() - h->tb_start;\r\nh->purr_total += mfspr(SPRN_PURR) - h->purr_start;\r\nput_cpu_var(hcall_stats);\r\n}\r\nstatic int __init hcall_inst_init(void)\r\n{\r\nstruct dentry *hcall_root;\r\nstruct dentry *hcall_file;\r\nchar cpu_name_buf[CPU_NAME_BUF_SIZE];\r\nint cpu;\r\nif (!firmware_has_feature(FW_FEATURE_LPAR))\r\nreturn 0;\r\nif (register_trace_hcall_entry(probe_hcall_entry, NULL))\r\nreturn -EINVAL;\r\nif (register_trace_hcall_exit(probe_hcall_exit, NULL)) {\r\nunregister_trace_hcall_entry(probe_hcall_entry, NULL);\r\nreturn -EINVAL;\r\n}\r\nhcall_root = debugfs_create_dir(HCALL_ROOT_DIR, NULL);\r\nif (!hcall_root)\r\nreturn -ENOMEM;\r\nfor_each_possible_cpu(cpu) {\r\nsnprintf(cpu_name_buf, CPU_NAME_BUF_SIZE, "cpu%d", cpu);\r\nhcall_file = debugfs_create_file(cpu_name_buf, S_IRUGO,\r\nhcall_root,\r\nper_cpu(hcall_stats, cpu),\r\n&hcall_inst_seq_fops);\r\nif (!hcall_file)\r\nreturn -ENOMEM;\r\n}\r\nreturn 0;\r\n}

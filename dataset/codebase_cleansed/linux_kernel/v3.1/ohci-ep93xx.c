static void ep93xx_start_hc(struct device *dev)\r\n{\r\nclk_enable(usb_host_clock);\r\n}\r\nstatic void ep93xx_stop_hc(struct device *dev)\r\n{\r\nclk_disable(usb_host_clock);\r\n}\r\nstatic int usb_hcd_ep93xx_probe(const struct hc_driver *driver,\r\nstruct platform_device *pdev)\r\n{\r\nint retval;\r\nstruct usb_hcd *hcd;\r\nif (pdev->resource[1].flags != IORESOURCE_IRQ) {\r\ndbg("resource[1] is not IORESOURCE_IRQ");\r\nreturn -ENOMEM;\r\n}\r\nhcd = usb_create_hcd(driver, &pdev->dev, "ep93xx");\r\nif (hcd == NULL)\r\nreturn -ENOMEM;\r\nhcd->rsrc_start = pdev->resource[0].start;\r\nhcd->rsrc_len = pdev->resource[0].end - pdev->resource[0].start + 1;\r\nif (!request_mem_region(hcd->rsrc_start, hcd->rsrc_len, hcd_name)) {\r\nusb_put_hcd(hcd);\r\nretval = -EBUSY;\r\ngoto err1;\r\n}\r\nhcd->regs = ioremap(hcd->rsrc_start, hcd->rsrc_len);\r\nif (hcd->regs == NULL) {\r\ndbg("ioremap failed");\r\nretval = -ENOMEM;\r\ngoto err2;\r\n}\r\nusb_host_clock = clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(usb_host_clock)) {\r\ndbg("clk_get failed");\r\nretval = PTR_ERR(usb_host_clock);\r\ngoto err3;\r\n}\r\nep93xx_start_hc(&pdev->dev);\r\nohci_hcd_init(hcd_to_ohci(hcd));\r\nretval = usb_add_hcd(hcd, pdev->resource[1].start, IRQF_DISABLED);\r\nif (retval == 0)\r\nreturn retval;\r\nep93xx_stop_hc(&pdev->dev);\r\nerr3:\r\niounmap(hcd->regs);\r\nerr2:\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nerr1:\r\nusb_put_hcd(hcd);\r\nreturn retval;\r\n}\r\nstatic void usb_hcd_ep93xx_remove(struct usb_hcd *hcd,\r\nstruct platform_device *pdev)\r\n{\r\nusb_remove_hcd(hcd);\r\nep93xx_stop_hc(&pdev->dev);\r\nclk_put(usb_host_clock);\r\niounmap(hcd->regs);\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nusb_put_hcd(hcd);\r\n}\r\nstatic int __devinit ohci_ep93xx_start(struct usb_hcd *hcd)\r\n{\r\nstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\r\nint ret;\r\nif ((ret = ohci_init(ohci)) < 0)\r\nreturn ret;\r\nif ((ret = ohci_run(ohci)) < 0) {\r\nerr("can't start %s", hcd->self.bus_name);\r\nohci_stop(hcd);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ohci_hcd_ep93xx_drv_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nret = -ENODEV;\r\nif (!usb_disabled())\r\nret = usb_hcd_ep93xx_probe(&ohci_ep93xx_hc_driver, pdev);\r\nreturn ret;\r\n}\r\nstatic int ohci_hcd_ep93xx_drv_remove(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nusb_hcd_ep93xx_remove(hcd, pdev);\r\nreturn 0;\r\n}\r\nstatic int ohci_hcd_ep93xx_drv_suspend(struct platform_device *pdev, pm_message_t state)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\r\nif (time_before(jiffies, ohci->next_statechange))\r\nmsleep(5);\r\nohci->next_statechange = jiffies;\r\nep93xx_stop_hc(&pdev->dev);\r\nhcd->state = HC_STATE_SUSPENDED;\r\nreturn 0;\r\n}\r\nstatic int ohci_hcd_ep93xx_drv_resume(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\r\nif (time_before(jiffies, ohci->next_statechange))\r\nmsleep(5);\r\nohci->next_statechange = jiffies;\r\nep93xx_start_hc(&pdev->dev);\r\nohci_finish_controller_resume(hcd);\r\nreturn 0;\r\n}

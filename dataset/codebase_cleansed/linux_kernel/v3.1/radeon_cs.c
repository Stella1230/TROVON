int radeon_cs_parser_relocs(struct radeon_cs_parser *p)\r\n{\r\nstruct drm_device *ddev = p->rdev->ddev;\r\nstruct radeon_cs_chunk *chunk;\r\nunsigned i, j;\r\nbool duplicate;\r\nif (p->chunk_relocs_idx == -1) {\r\nreturn 0;\r\n}\r\nchunk = &p->chunks[p->chunk_relocs_idx];\r\np->nrelocs = chunk->length_dw / 4;\r\np->relocs_ptr = kcalloc(p->nrelocs, sizeof(void *), GFP_KERNEL);\r\nif (p->relocs_ptr == NULL) {\r\nreturn -ENOMEM;\r\n}\r\np->relocs = kcalloc(p->nrelocs, sizeof(struct radeon_cs_reloc), GFP_KERNEL);\r\nif (p->relocs == NULL) {\r\nreturn -ENOMEM;\r\n}\r\nfor (i = 0; i < p->nrelocs; i++) {\r\nstruct drm_radeon_cs_reloc *r;\r\nduplicate = false;\r\nr = (struct drm_radeon_cs_reloc *)&chunk->kdata[i*4];\r\nfor (j = 0; j < p->nrelocs; j++) {\r\nif (r->handle == p->relocs[j].handle) {\r\np->relocs_ptr[i] = &p->relocs[j];\r\nduplicate = true;\r\nbreak;\r\n}\r\n}\r\nif (!duplicate) {\r\np->relocs[i].gobj = drm_gem_object_lookup(ddev,\r\np->filp,\r\nr->handle);\r\nif (p->relocs[i].gobj == NULL) {\r\nDRM_ERROR("gem object lookup failed 0x%x\n",\r\nr->handle);\r\nreturn -ENOENT;\r\n}\r\np->relocs_ptr[i] = &p->relocs[i];\r\np->relocs[i].robj = gem_to_radeon_bo(p->relocs[i].gobj);\r\np->relocs[i].lobj.bo = p->relocs[i].robj;\r\np->relocs[i].lobj.wdomain = r->write_domain;\r\np->relocs[i].lobj.rdomain = r->read_domains;\r\np->relocs[i].lobj.tv.bo = &p->relocs[i].robj->tbo;\r\np->relocs[i].handle = r->handle;\r\np->relocs[i].flags = r->flags;\r\nradeon_bo_list_add_object(&p->relocs[i].lobj,\r\n&p->validated);\r\n}\r\n}\r\nreturn radeon_bo_list_validate(&p->validated);\r\n}\r\nint radeon_cs_parser_init(struct radeon_cs_parser *p, void *data)\r\n{\r\nstruct drm_radeon_cs *cs = data;\r\nuint64_t *chunk_array_ptr;\r\nunsigned size, i;\r\nif (!cs->num_chunks) {\r\nreturn 0;\r\n}\r\nINIT_LIST_HEAD(&p->validated);\r\np->idx = 0;\r\np->chunk_ib_idx = -1;\r\np->chunk_relocs_idx = -1;\r\np->chunks_array = kcalloc(cs->num_chunks, sizeof(uint64_t), GFP_KERNEL);\r\nif (p->chunks_array == NULL) {\r\nreturn -ENOMEM;\r\n}\r\nchunk_array_ptr = (uint64_t *)(unsigned long)(cs->chunks);\r\nif (DRM_COPY_FROM_USER(p->chunks_array, chunk_array_ptr,\r\nsizeof(uint64_t)*cs->num_chunks)) {\r\nreturn -EFAULT;\r\n}\r\np->nchunks = cs->num_chunks;\r\np->chunks = kcalloc(p->nchunks, sizeof(struct radeon_cs_chunk), GFP_KERNEL);\r\nif (p->chunks == NULL) {\r\nreturn -ENOMEM;\r\n}\r\nfor (i = 0; i < p->nchunks; i++) {\r\nstruct drm_radeon_cs_chunk __user **chunk_ptr = NULL;\r\nstruct drm_radeon_cs_chunk user_chunk;\r\nuint32_t __user *cdata;\r\nchunk_ptr = (void __user*)(unsigned long)p->chunks_array[i];\r\nif (DRM_COPY_FROM_USER(&user_chunk, chunk_ptr,\r\nsizeof(struct drm_radeon_cs_chunk))) {\r\nreturn -EFAULT;\r\n}\r\np->chunks[i].length_dw = user_chunk.length_dw;\r\np->chunks[i].kdata = NULL;\r\np->chunks[i].chunk_id = user_chunk.chunk_id;\r\nif (p->chunks[i].chunk_id == RADEON_CHUNK_ID_RELOCS) {\r\np->chunk_relocs_idx = i;\r\n}\r\nif (p->chunks[i].chunk_id == RADEON_CHUNK_ID_IB) {\r\np->chunk_ib_idx = i;\r\nif (p->chunks[i].length_dw == 0)\r\nreturn -EINVAL;\r\n}\r\np->chunks[i].length_dw = user_chunk.length_dw;\r\np->chunks[i].user_ptr = (void __user *)(unsigned long)user_chunk.chunk_data;\r\ncdata = (uint32_t *)(unsigned long)user_chunk.chunk_data;\r\nif (p->chunks[i].chunk_id != RADEON_CHUNK_ID_IB) {\r\nsize = p->chunks[i].length_dw * sizeof(uint32_t);\r\np->chunks[i].kdata = kmalloc(size, GFP_KERNEL);\r\nif (p->chunks[i].kdata == NULL) {\r\nreturn -ENOMEM;\r\n}\r\nif (DRM_COPY_FROM_USER(p->chunks[i].kdata,\r\np->chunks[i].user_ptr, size)) {\r\nreturn -EFAULT;\r\n}\r\n} else {\r\np->chunks[i].kpage[0] = kmalloc(PAGE_SIZE, GFP_KERNEL);\r\np->chunks[i].kpage[1] = kmalloc(PAGE_SIZE, GFP_KERNEL);\r\nif (p->chunks[i].kpage[0] == NULL || p->chunks[i].kpage[1] == NULL) {\r\nkfree(p->chunks[i].kpage[0]);\r\nkfree(p->chunks[i].kpage[1]);\r\nreturn -ENOMEM;\r\n}\r\np->chunks[i].kpage_idx[0] = -1;\r\np->chunks[i].kpage_idx[1] = -1;\r\np->chunks[i].last_copied_page = -1;\r\np->chunks[i].last_page_index = ((p->chunks[i].length_dw * 4) - 1) / PAGE_SIZE;\r\n}\r\n}\r\nif (p->chunks[p->chunk_ib_idx].length_dw > (16 * 1024)) {\r\nDRM_ERROR("cs IB too big: %d\n",\r\np->chunks[p->chunk_ib_idx].length_dw);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic void radeon_cs_parser_fini(struct radeon_cs_parser *parser, int error)\r\n{\r\nunsigned i;\r\nif (!error && parser->ib)\r\nttm_eu_fence_buffer_objects(&parser->validated,\r\nparser->ib->fence);\r\nelse\r\nttm_eu_backoff_reservation(&parser->validated);\r\nif (parser->relocs != NULL) {\r\nfor (i = 0; i < parser->nrelocs; i++) {\r\nif (parser->relocs[i].gobj)\r\ndrm_gem_object_unreference_unlocked(parser->relocs[i].gobj);\r\n}\r\n}\r\nkfree(parser->track);\r\nkfree(parser->relocs);\r\nkfree(parser->relocs_ptr);\r\nfor (i = 0; i < parser->nchunks; i++) {\r\nkfree(parser->chunks[i].kdata);\r\nkfree(parser->chunks[i].kpage[0]);\r\nkfree(parser->chunks[i].kpage[1]);\r\n}\r\nkfree(parser->chunks);\r\nkfree(parser->chunks_array);\r\nradeon_ib_free(parser->rdev, &parser->ib);\r\n}\r\nint radeon_cs_ioctl(struct drm_device *dev, void *data, struct drm_file *filp)\r\n{\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct radeon_cs_parser parser;\r\nstruct radeon_cs_chunk *ib_chunk;\r\nint r;\r\nmutex_lock(&rdev->cs_mutex);\r\nmemset(&parser, 0, sizeof(struct radeon_cs_parser));\r\nparser.filp = filp;\r\nparser.rdev = rdev;\r\nparser.dev = rdev->dev;\r\nparser.family = rdev->family;\r\nr = radeon_cs_parser_init(&parser, data);\r\nif (r) {\r\nDRM_ERROR("Failed to initialize parser !\n");\r\nradeon_cs_parser_fini(&parser, r);\r\nmutex_unlock(&rdev->cs_mutex);\r\nreturn r;\r\n}\r\nr = radeon_ib_get(rdev, &parser.ib);\r\nif (r) {\r\nDRM_ERROR("Failed to get ib !\n");\r\nradeon_cs_parser_fini(&parser, r);\r\nmutex_unlock(&rdev->cs_mutex);\r\nreturn r;\r\n}\r\nr = radeon_cs_parser_relocs(&parser);\r\nif (r) {\r\nif (r != -ERESTARTSYS)\r\nDRM_ERROR("Failed to parse relocation %d!\n", r);\r\nradeon_cs_parser_fini(&parser, r);\r\nmutex_unlock(&rdev->cs_mutex);\r\nreturn r;\r\n}\r\nib_chunk = &parser.chunks[parser.chunk_ib_idx];\r\nparser.ib->length_dw = ib_chunk->length_dw;\r\nr = radeon_cs_parse(&parser);\r\nif (r || parser.parser_error) {\r\nDRM_ERROR("Invalid command stream !\n");\r\nradeon_cs_parser_fini(&parser, r);\r\nmutex_unlock(&rdev->cs_mutex);\r\nreturn r;\r\n}\r\nr = radeon_cs_finish_pages(&parser);\r\nif (r) {\r\nDRM_ERROR("Invalid command stream !\n");\r\nradeon_cs_parser_fini(&parser, r);\r\nmutex_unlock(&rdev->cs_mutex);\r\nreturn r;\r\n}\r\nr = radeon_ib_schedule(rdev, parser.ib);\r\nif (r) {\r\nDRM_ERROR("Failed to schedule IB !\n");\r\n}\r\nradeon_cs_parser_fini(&parser, r);\r\nmutex_unlock(&rdev->cs_mutex);\r\nreturn r;\r\n}\r\nint radeon_cs_finish_pages(struct radeon_cs_parser *p)\r\n{\r\nstruct radeon_cs_chunk *ibc = &p->chunks[p->chunk_ib_idx];\r\nint i;\r\nint size = PAGE_SIZE;\r\nfor (i = ibc->last_copied_page + 1; i <= ibc->last_page_index; i++) {\r\nif (i == ibc->last_page_index) {\r\nsize = (ibc->length_dw * 4) % PAGE_SIZE;\r\nif (size == 0)\r\nsize = PAGE_SIZE;\r\n}\r\nif (DRM_COPY_FROM_USER(p->ib->ptr + (i * (PAGE_SIZE/4)),\r\nibc->user_ptr + (i * PAGE_SIZE),\r\nsize))\r\nreturn -EFAULT;\r\n}\r\nreturn 0;\r\n}\r\nint radeon_cs_update_pages(struct radeon_cs_parser *p, int pg_idx)\r\n{\r\nint new_page;\r\nstruct radeon_cs_chunk *ibc = &p->chunks[p->chunk_ib_idx];\r\nint i;\r\nint size = PAGE_SIZE;\r\nfor (i = ibc->last_copied_page + 1; i < pg_idx; i++) {\r\nif (DRM_COPY_FROM_USER(p->ib->ptr + (i * (PAGE_SIZE/4)),\r\nibc->user_ptr + (i * PAGE_SIZE),\r\nPAGE_SIZE)) {\r\np->parser_error = -EFAULT;\r\nreturn 0;\r\n}\r\n}\r\nnew_page = ibc->kpage_idx[0] < ibc->kpage_idx[1] ? 0 : 1;\r\nif (pg_idx == ibc->last_page_index) {\r\nsize = (ibc->length_dw * 4) % PAGE_SIZE;\r\nif (size == 0)\r\nsize = PAGE_SIZE;\r\n}\r\nif (DRM_COPY_FROM_USER(ibc->kpage[new_page],\r\nibc->user_ptr + (pg_idx * PAGE_SIZE),\r\nsize)) {\r\np->parser_error = -EFAULT;\r\nreturn 0;\r\n}\r\nmemcpy((void *)(p->ib->ptr+(pg_idx*(PAGE_SIZE/4))), ibc->kpage[new_page], size);\r\nibc->last_copied_page = pg_idx;\r\nibc->kpage_idx[new_page] = pg_idx;\r\nreturn new_page;\r\n}

static int __devinit pata_of_platform_probe(struct platform_device *ofdev)\r\n{\r\nint ret;\r\nstruct device_node *dn = ofdev->dev.of_node;\r\nstruct resource io_res;\r\nstruct resource ctl_res;\r\nstruct resource irq_res;\r\nunsigned int reg_shift = 0;\r\nint pio_mode = 0;\r\nint pio_mask;\r\nconst u32 *prop;\r\nret = of_address_to_resource(dn, 0, &io_res);\r\nif (ret) {\r\ndev_err(&ofdev->dev, "can't get IO address from "\r\n"device tree\n");\r\nreturn -EINVAL;\r\n}\r\nif (of_device_is_compatible(dn, "electra-ide")) {\r\nctl_res = io_res;\r\nctl_res.start = ctl_res.start+0x3f6;\r\nio_res.end = ctl_res.start-1;\r\n} else {\r\nret = of_address_to_resource(dn, 1, &ctl_res);\r\nif (ret) {\r\ndev_err(&ofdev->dev, "can't get CTL address from "\r\n"device tree\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\nret = of_irq_to_resource(dn, 0, &irq_res);\r\nif (ret == NO_IRQ)\r\nirq_res.start = irq_res.end = 0;\r\nelse\r\nirq_res.flags = 0;\r\nprop = of_get_property(dn, "reg-shift", NULL);\r\nif (prop)\r\nreg_shift = *prop;\r\nprop = of_get_property(dn, "pio-mode", NULL);\r\nif (prop) {\r\npio_mode = *prop;\r\nif (pio_mode > 6) {\r\ndev_err(&ofdev->dev, "invalid pio-mode\n");\r\nreturn -EINVAL;\r\n}\r\n} else {\r\ndev_info(&ofdev->dev, "pio-mode unspecified, assuming PIO0\n");\r\n}\r\npio_mask = 1 << pio_mode;\r\npio_mask |= (1 << pio_mode) - 1;\r\nreturn __pata_platform_probe(&ofdev->dev, &io_res, &ctl_res, &irq_res,\r\nreg_shift, pio_mask);\r\n}\r\nstatic int __devexit pata_of_platform_remove(struct platform_device *ofdev)\r\n{\r\nreturn __pata_platform_remove(&ofdev->dev);\r\n}\r\nstatic int __init pata_of_platform_init(void)\r\n{\r\nreturn platform_driver_register(&pata_of_platform_driver);\r\n}\r\nstatic void __exit pata_of_platform_exit(void)\r\n{\r\nplatform_driver_unregister(&pata_of_platform_driver);\r\n}

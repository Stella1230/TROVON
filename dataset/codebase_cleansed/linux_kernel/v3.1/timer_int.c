static enum hrtimer_restart oprofile_hrtimer_notify(struct hrtimer *hrtimer)\r\n{\r\noprofile_add_sample(get_irq_regs(), 0);\r\nhrtimer_forward_now(hrtimer, ns_to_ktime(TICK_NSEC));\r\nreturn HRTIMER_RESTART;\r\n}\r\nstatic void __oprofile_hrtimer_start(void *unused)\r\n{\r\nstruct hrtimer *hrtimer = &__get_cpu_var(oprofile_hrtimer);\r\nif (!ctr_running)\r\nreturn;\r\nhrtimer_init(hrtimer, CLOCK_MONOTONIC, HRTIMER_MODE_REL);\r\nhrtimer->function = oprofile_hrtimer_notify;\r\nhrtimer_start(hrtimer, ns_to_ktime(TICK_NSEC),\r\nHRTIMER_MODE_REL_PINNED);\r\n}\r\nstatic int oprofile_hrtimer_start(void)\r\n{\r\nget_online_cpus();\r\nctr_running = 1;\r\non_each_cpu(__oprofile_hrtimer_start, NULL, 1);\r\nput_online_cpus();\r\nreturn 0;\r\n}\r\nstatic void __oprofile_hrtimer_stop(int cpu)\r\n{\r\nstruct hrtimer *hrtimer = &per_cpu(oprofile_hrtimer, cpu);\r\nif (!ctr_running)\r\nreturn;\r\nhrtimer_cancel(hrtimer);\r\n}\r\nstatic void oprofile_hrtimer_stop(void)\r\n{\r\nint cpu;\r\nget_online_cpus();\r\nfor_each_online_cpu(cpu)\r\n__oprofile_hrtimer_stop(cpu);\r\nctr_running = 0;\r\nput_online_cpus();\r\n}\r\nstatic int __cpuinit oprofile_cpu_notify(struct notifier_block *self,\r\nunsigned long action, void *hcpu)\r\n{\r\nlong cpu = (long) hcpu;\r\nswitch (action) {\r\ncase CPU_ONLINE:\r\ncase CPU_ONLINE_FROZEN:\r\nsmp_call_function_single(cpu, __oprofile_hrtimer_start,\r\nNULL, 1);\r\nbreak;\r\ncase CPU_DEAD:\r\ncase CPU_DEAD_FROZEN:\r\n__oprofile_hrtimer_stop(cpu);\r\nbreak;\r\n}\r\nreturn NOTIFY_OK;\r\n}\r\nint oprofile_timer_init(struct oprofile_operations *ops)\r\n{\r\nint rc;\r\nrc = register_hotcpu_notifier(&oprofile_cpu_notifier);\r\nif (rc)\r\nreturn rc;\r\nops->create_files = NULL;\r\nops->setup = NULL;\r\nops->shutdown = NULL;\r\nops->start = oprofile_hrtimer_start;\r\nops->stop = oprofile_hrtimer_stop;\r\nops->cpu_type = "timer";\r\nreturn 0;\r\n}\r\nvoid oprofile_timer_exit(void)\r\n{\r\nunregister_hotcpu_notifier(&oprofile_cpu_notifier);\r\n}

static inline struct device *to_da903x_dev(struct regulator_dev *rdev)\r\n{\r\nreturn rdev_get_dev(rdev)->parent->parent;\r\n}\r\nstatic inline int check_range(struct da903x_regulator_info *info,\r\nint min_uV, int max_uV)\r\n{\r\nif (min_uV < info->min_uV || min_uV > info->max_uV)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int da903x_set_ldo_voltage(struct regulator_dev *rdev,\r\nint min_uV, int max_uV, unsigned *selector)\r\n{\r\nstruct da903x_regulator_info *info = rdev_get_drvdata(rdev);\r\nstruct device *da9034_dev = to_da903x_dev(rdev);\r\nuint8_t val, mask;\r\nif (check_range(info, min_uV, max_uV)) {\r\npr_err("invalid voltage range (%d, %d) uV\n", min_uV, max_uV);\r\nreturn -EINVAL;\r\n}\r\nval = (min_uV - info->min_uV + info->step_uV - 1) / info->step_uV;\r\n*selector = val;\r\nval <<= info->vol_shift;\r\nmask = ((1 << info->vol_nbits) - 1) << info->vol_shift;\r\nreturn da903x_update(da9034_dev, info->vol_reg, val, mask);\r\n}\r\nstatic int da903x_get_voltage(struct regulator_dev *rdev)\r\n{\r\nstruct da903x_regulator_info *info = rdev_get_drvdata(rdev);\r\nstruct device *da9034_dev = to_da903x_dev(rdev);\r\nuint8_t val, mask;\r\nint ret;\r\nret = da903x_read(da9034_dev, info->vol_reg, &val);\r\nif (ret)\r\nreturn ret;\r\nmask = ((1 << info->vol_nbits) - 1) << info->vol_shift;\r\nval = (val & mask) >> info->vol_shift;\r\nreturn info->min_uV + info->step_uV * val;\r\n}\r\nstatic int da903x_enable(struct regulator_dev *rdev)\r\n{\r\nstruct da903x_regulator_info *info = rdev_get_drvdata(rdev);\r\nstruct device *da9034_dev = to_da903x_dev(rdev);\r\nreturn da903x_set_bits(da9034_dev, info->enable_reg,\r\n1 << info->enable_bit);\r\n}\r\nstatic int da903x_disable(struct regulator_dev *rdev)\r\n{\r\nstruct da903x_regulator_info *info = rdev_get_drvdata(rdev);\r\nstruct device *da9034_dev = to_da903x_dev(rdev);\r\nreturn da903x_clr_bits(da9034_dev, info->enable_reg,\r\n1 << info->enable_bit);\r\n}\r\nstatic int da903x_is_enabled(struct regulator_dev *rdev)\r\n{\r\nstruct da903x_regulator_info *info = rdev_get_drvdata(rdev);\r\nstruct device *da9034_dev = to_da903x_dev(rdev);\r\nuint8_t reg_val;\r\nint ret;\r\nret = da903x_read(da9034_dev, info->enable_reg, &reg_val);\r\nif (ret)\r\nreturn ret;\r\nreturn !!(reg_val & (1 << info->enable_bit));\r\n}\r\nstatic int da903x_list_voltage(struct regulator_dev *rdev, unsigned selector)\r\n{\r\nstruct da903x_regulator_info *info = rdev_get_drvdata(rdev);\r\nint ret;\r\nret = info->min_uV + info->step_uV * selector;\r\nif (ret > info->max_uV)\r\nreturn -EINVAL;\r\nreturn ret;\r\n}\r\nstatic int da9030_set_ldo1_15_voltage(struct regulator_dev *rdev,\r\nint min_uV, int max_uV,\r\nunsigned *selector)\r\n{\r\nstruct da903x_regulator_info *info = rdev_get_drvdata(rdev);\r\nstruct device *da903x_dev = to_da903x_dev(rdev);\r\nuint8_t val, mask;\r\nint ret;\r\nif (check_range(info, min_uV, max_uV)) {\r\npr_err("invalid voltage range (%d, %d) uV\n", min_uV, max_uV);\r\nreturn -EINVAL;\r\n}\r\nval = (min_uV - info->min_uV + info->step_uV - 1) / info->step_uV;\r\n*selector = val;\r\nval <<= info->vol_shift;\r\nmask = ((1 << info->vol_nbits) - 1) << info->vol_shift;\r\nval |= DA9030_LDO_UNLOCK;\r\nmask |= DA9030_LDO_UNLOCK_MASK;\r\nret = da903x_update(da903x_dev, info->vol_reg, val, mask);\r\nif (ret)\r\nreturn ret;\r\nreturn da903x_update(da903x_dev, info->vol_reg, val, mask);\r\n}\r\nstatic int da9030_set_ldo14_voltage(struct regulator_dev *rdev,\r\nint min_uV, int max_uV,\r\nunsigned *selector)\r\n{\r\nstruct da903x_regulator_info *info = rdev_get_drvdata(rdev);\r\nstruct device *da903x_dev = to_da903x_dev(rdev);\r\nuint8_t val, mask;\r\nint thresh;\r\nif (check_range(info, min_uV, max_uV)) {\r\npr_err("invalid voltage range (%d, %d) uV\n", min_uV, max_uV);\r\nreturn -EINVAL;\r\n}\r\nthresh = (info->max_uV + info->min_uV) / 2;\r\nif (min_uV < thresh) {\r\nval = (thresh - min_uV + info->step_uV - 1) / info->step_uV;\r\nval |= 0x4;\r\n} else {\r\nval = (min_uV - thresh + info->step_uV - 1) / info->step_uV;\r\n}\r\n*selector = val;\r\nval <<= info->vol_shift;\r\nmask = ((1 << info->vol_nbits) - 1) << info->vol_shift;\r\nreturn da903x_update(da903x_dev, info->vol_reg, val, mask);\r\n}\r\nstatic int da9030_get_ldo14_voltage(struct regulator_dev *rdev)\r\n{\r\nstruct da903x_regulator_info *info = rdev_get_drvdata(rdev);\r\nstruct device *da903x_dev = to_da903x_dev(rdev);\r\nuint8_t val, mask;\r\nint ret;\r\nret = da903x_read(da903x_dev, info->vol_reg, &val);\r\nif (ret)\r\nreturn ret;\r\nmask = ((1 << info->vol_nbits) - 1) << info->vol_shift;\r\nval = (val & mask) >> info->vol_shift;\r\nif (val & 0x4)\r\nreturn info->min_uV + info->step_uV * (3 - (val & ~0x4));\r\nelse\r\nreturn (info->max_uV + info->min_uV) / 2 +\r\ninfo->step_uV * (val & ~0x4);\r\n}\r\nstatic int da9034_set_dvc_voltage(struct regulator_dev *rdev,\r\nint min_uV, int max_uV, unsigned *selector)\r\n{\r\nstruct da903x_regulator_info *info = rdev_get_drvdata(rdev);\r\nstruct device *da9034_dev = to_da903x_dev(rdev);\r\nuint8_t val, mask;\r\nint ret;\r\nif (check_range(info, min_uV, max_uV)) {\r\npr_err("invalid voltage range (%d, %d) uV\n", min_uV, max_uV);\r\nreturn -EINVAL;\r\n}\r\nval = (min_uV - info->min_uV + info->step_uV - 1) / info->step_uV;\r\n*selector = val;\r\nval <<= info->vol_shift;\r\nmask = ((1 << info->vol_nbits) - 1) << info->vol_shift;\r\nret = da903x_update(da9034_dev, info->vol_reg, val, mask);\r\nif (ret)\r\nreturn ret;\r\nret = da903x_set_bits(da9034_dev, info->update_reg,\r\n1 << info->update_bit);\r\nreturn ret;\r\n}\r\nstatic int da9034_set_ldo12_voltage(struct regulator_dev *rdev,\r\nint min_uV, int max_uV, unsigned *selector)\r\n{\r\nstruct da903x_regulator_info *info = rdev_get_drvdata(rdev);\r\nstruct device *da9034_dev = to_da903x_dev(rdev);\r\nuint8_t val, mask;\r\nif (check_range(info, min_uV, max_uV)) {\r\npr_err("invalid voltage range (%d, %d) uV\n", min_uV, max_uV);\r\nreturn -EINVAL;\r\n}\r\nval = (min_uV - info->min_uV + info->step_uV - 1) / info->step_uV;\r\nval = (val >= 20) ? val - 12 : ((val > 7) ? 8 : val);\r\n*selector = val;\r\nval <<= info->vol_shift;\r\nmask = ((1 << info->vol_nbits) - 1) << info->vol_shift;\r\nreturn da903x_update(da9034_dev, info->vol_reg, val, mask);\r\n}\r\nstatic int da9034_get_ldo12_voltage(struct regulator_dev *rdev)\r\n{\r\nstruct da903x_regulator_info *info = rdev_get_drvdata(rdev);\r\nstruct device *da9034_dev = to_da903x_dev(rdev);\r\nuint8_t val, mask;\r\nint ret;\r\nret = da903x_read(da9034_dev, info->vol_reg, &val);\r\nif (ret)\r\nreturn ret;\r\nmask = ((1 << info->vol_nbits) - 1) << info->vol_shift;\r\nval = (val & mask) >> info->vol_shift;\r\nif (val >= 8)\r\nreturn 2700000 + info->step_uV * (val - 8);\r\nreturn info->min_uV + info->step_uV * val;\r\n}\r\nstatic int da9034_list_ldo12_voltage(struct regulator_dev *rdev,\r\nunsigned selector)\r\n{\r\nif (selector >= ARRAY_SIZE(da9034_ldo12_data))\r\nreturn -EINVAL;\r\nreturn da9034_ldo12_data[selector] * 1000;\r\n}\r\nstatic inline struct da903x_regulator_info *find_regulator_info(int id)\r\n{\r\nstruct da903x_regulator_info *ri;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(da903x_regulator_info); i++) {\r\nri = &da903x_regulator_info[i];\r\nif (ri->desc.id == id)\r\nreturn ri;\r\n}\r\nreturn NULL;\r\n}\r\nstatic int __devinit da903x_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct da903x_regulator_info *ri = NULL;\r\nstruct regulator_dev *rdev;\r\nri = find_regulator_info(pdev->id);\r\nif (ri == NULL) {\r\ndev_err(&pdev->dev, "invalid regulator ID specified\n");\r\nreturn -EINVAL;\r\n}\r\nif (ri->desc.id == DA9034_ID_LDO12) {\r\nri->desc.ops = &da9034_regulator_ldo12_ops;\r\nri->desc.n_voltages = ARRAY_SIZE(da9034_ldo12_data);\r\n}\r\nif (ri->desc.id == DA9030_ID_LDO14)\r\nri->desc.ops = &da9030_regulator_ldo14_ops;\r\nif (ri->desc.id == DA9030_ID_LDO1 || ri->desc.id == DA9030_ID_LDO15)\r\nri->desc.ops = &da9030_regulator_ldo1_15_ops;\r\nrdev = regulator_register(&ri->desc, &pdev->dev,\r\npdev->dev.platform_data, ri);\r\nif (IS_ERR(rdev)) {\r\ndev_err(&pdev->dev, "failed to register regulator %s\n",\r\nri->desc.name);\r\nreturn PTR_ERR(rdev);\r\n}\r\nplatform_set_drvdata(pdev, rdev);\r\nreturn 0;\r\n}\r\nstatic int __devexit da903x_regulator_remove(struct platform_device *pdev)\r\n{\r\nstruct regulator_dev *rdev = platform_get_drvdata(pdev);\r\nregulator_unregister(rdev);\r\nreturn 0;\r\n}\r\nstatic int __init da903x_regulator_init(void)\r\n{\r\nreturn platform_driver_register(&da903x_regulator_driver);\r\n}\r\nstatic void __exit da903x_regulator_exit(void)\r\n{\r\nplatform_driver_unregister(&da903x_regulator_driver);\r\n}

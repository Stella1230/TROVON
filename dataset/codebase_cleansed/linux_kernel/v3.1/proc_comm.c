static inline void msm_a2m_int(uint32_t irq)\r\n{\r\n#if defined(CONFIG_ARCH_MSM7X30)\r\nwritel(1 << irq, MSM_GCC_BASE + 0x8);\r\n#else\r\nwritel(1, MSM_CSR_BASE + 0x400 + (irq * 4));\r\n#endif\r\n}\r\nstatic inline void notify_other_proc_comm(void)\r\n{\r\nmsm_a2m_int(6);\r\n}\r\nstatic int proc_comm_wait_for(void __iomem *addr, unsigned value)\r\n{\r\nfor (;;) {\r\nif (readl(addr) == value)\r\nreturn 0;\r\nif (msm_check_for_modem_crash)\r\nif (msm_check_for_modem_crash())\r\nreturn -EAGAIN;\r\n}\r\n}\r\nint msm_proc_comm(unsigned cmd, unsigned *data1, unsigned *data2)\r\n{\r\nvoid __iomem *base = MSM_SHARED_RAM_BASE;\r\nunsigned long flags;\r\nint ret;\r\nspin_lock_irqsave(&proc_comm_lock, flags);\r\nfor (;;) {\r\nif (proc_comm_wait_for(base + MDM_STATUS, PCOM_READY))\r\ncontinue;\r\nwritel(cmd, base + APP_COMMAND);\r\nwritel(data1 ? *data1 : 0, base + APP_DATA1);\r\nwritel(data2 ? *data2 : 0, base + APP_DATA2);\r\nnotify_other_proc_comm();\r\nif (proc_comm_wait_for(base + APP_COMMAND, PCOM_CMD_DONE))\r\ncontinue;\r\nif (readl(base + APP_STATUS) != PCOM_CMD_FAIL) {\r\nif (data1)\r\n*data1 = readl(base + APP_DATA1);\r\nif (data2)\r\n*data2 = readl(base + APP_DATA2);\r\nret = 0;\r\n} else {\r\nret = -EIO;\r\n}\r\nbreak;\r\n}\r\nwritel(PCOM_CMD_IDLE, base + APP_COMMAND);\r\nspin_unlock_irqrestore(&proc_comm_lock, flags);\r\nreturn ret;\r\n}\r\nvoid __init proc_comm_boot_wait(void)\r\n{\r\nvoid __iomem *base = MSM_SHARED_RAM_BASE;\r\nproc_comm_wait_for(base + MDM_STATUS, PCOM_READY);\r\n}

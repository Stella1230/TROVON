static irqreturn_t deferred_fiq(int irq, void *dev_id)\r\n{\r\nstruct irq_desc *irq_desc;\r\nstruct irq_chip *irq_chip = NULL;\r\nint gpio, irq_num, fiq_count;\r\nirq_desc = irq_to_desc(IH_GPIO_BASE);\r\nif (irq_desc)\r\nirq_chip = irq_desc->irq_data.chip;\r\nfor (gpio = AMS_DELTA_GPIO_PIN_KEYBRD_CLK;\r\ngpio <= AMS_DELTA_GPIO_PIN_HOOK_SWITCH; gpio++) {\r\nirq_num = gpio_to_irq(gpio);\r\nfiq_count = fiq_buffer[FIQ_CNT_INT_00 + gpio];\r\nwhile (irq_counter[gpio] < fiq_count) {\r\nif (gpio != AMS_DELTA_GPIO_PIN_KEYBRD_CLK) {\r\nstruct irq_data *d = irq_get_irq_data(irq_num);\r\nif (irq_chip && irq_chip->irq_unmask)\r\nirq_chip->irq_unmask(d);\r\n}\r\ngeneric_handle_irq(irq_num);\r\nirq_counter[gpio]++;\r\n}\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nvoid __init ams_delta_init_fiq(void)\r\n{\r\nvoid *fiqhandler_start;\r\nunsigned int fiqhandler_length;\r\nstruct pt_regs FIQ_regs;\r\nunsigned long val, offset;\r\nint i, retval;\r\nfiqhandler_start = &qwerty_fiqin_start;\r\nfiqhandler_length = &qwerty_fiqin_end - &qwerty_fiqin_start;\r\npr_info("Installing fiq handler from %p, length 0x%x\n",\r\nfiqhandler_start, fiqhandler_length);\r\nretval = claim_fiq(&fh);\r\nif (retval) {\r\npr_err("ams_delta_init_fiq(): couldn't claim FIQ, ret=%d\n",\r\nretval);\r\nreturn;\r\n}\r\nretval = request_irq(INT_DEFERRED_FIQ, deferred_fiq,\r\nIRQ_TYPE_EDGE_RISING, "deferred_fiq", 0);\r\nif (retval < 0) {\r\npr_err("Failed to get deferred_fiq IRQ, ret=%d\n", retval);\r\nrelease_fiq(&fh);\r\nreturn;\r\n}\r\noffset = IRQ_ILR0_REG_OFFSET + INT_DEFERRED_FIQ * 0x4;\r\nval = omap_readl(DEFERRED_FIQ_IH_BASE + offset) & ~(1 << 1);\r\nomap_writel(val, DEFERRED_FIQ_IH_BASE + offset);\r\nset_fiq_handler(fiqhandler_start, fiqhandler_length);\r\nfiq_buffer[FIQ_GPIO_INT_MASK] = 0;\r\nfiq_buffer[FIQ_MASK] = 0;\r\nfiq_buffer[FIQ_STATE] = 0;\r\nfiq_buffer[FIQ_KEY] = 0;\r\nfiq_buffer[FIQ_KEYS_CNT] = 0;\r\nfiq_buffer[FIQ_KEYS_HICNT] = 0;\r\nfiq_buffer[FIQ_TAIL_OFFSET] = 0;\r\nfiq_buffer[FIQ_HEAD_OFFSET] = 0;\r\nfiq_buffer[FIQ_BUF_LEN] = 256;\r\nfiq_buffer[FIQ_MISSED_KEYS] = 0;\r\nfiq_buffer[FIQ_BUFFER_START] =\r\n(unsigned int) &fiq_buffer[FIQ_CIRC_BUFF];\r\nfor (i = FIQ_CNT_INT_00; i <= FIQ_CNT_INT_15; i++)\r\nfiq_buffer[i] = 0;\r\nFIQ_regs.ARM_r9 = (unsigned int)fiq_buffer;\r\nset_fiq_regs(&FIQ_regs);\r\npr_info("request_fiq(): fiq_buffer = %p\n", fiq_buffer);\r\noffset = IRQ_ILR0_REG_OFFSET + INT_GPIO_BANK1 * 0x4;\r\nval = omap_readl(OMAP_IH1_BASE + offset) | 1;\r\nomap_writel(val, OMAP_IH1_BASE + offset);\r\n}

static int gl861_i2c_msg(struct dvb_usb_device *d, u8 addr,\r\nu8 *wbuf, u16 wlen, u8 *rbuf, u16 rlen)\r\n{\r\nu16 index;\r\nu16 value = addr << (8 + 1);\r\nint wo = (rbuf == NULL || rlen == 0);\r\nu8 req, type;\r\nif (wo) {\r\nreq = GL861_REQ_I2C_WRITE;\r\ntype = GL861_WRITE;\r\n} else {\r\nreq = GL861_REQ_I2C_READ;\r\ntype = GL861_READ;\r\n}\r\nswitch (wlen) {\r\ncase 1:\r\nindex = wbuf[0];\r\nbreak;\r\ncase 2:\r\nindex = wbuf[0];\r\nvalue = value + wbuf[1];\r\nbreak;\r\ndefault:\r\nwarn("wlen = %x, aborting.", wlen);\r\nreturn -EINVAL;\r\n}\r\nmsleep(1);\r\nreturn usb_control_msg(d->udev, usb_rcvctrlpipe(d->udev, 0), req, type,\r\nvalue, index, rbuf, rlen, 2000);\r\n}\r\nstatic int gl861_i2c_xfer(struct i2c_adapter *adap, struct i2c_msg msg[],\r\nint num)\r\n{\r\nstruct dvb_usb_device *d = i2c_get_adapdata(adap);\r\nint i;\r\nif (num > 2)\r\nreturn -EINVAL;\r\nif (mutex_lock_interruptible(&d->i2c_mutex) < 0)\r\nreturn -EAGAIN;\r\nfor (i = 0; i < num; i++) {\r\nif (i+1 < num && (msg[i+1].flags & I2C_M_RD)) {\r\nif (gl861_i2c_msg(d, msg[i].addr, msg[i].buf,\r\nmsg[i].len, msg[i+1].buf, msg[i+1].len) < 0)\r\nbreak;\r\ni++;\r\n} else\r\nif (gl861_i2c_msg(d, msg[i].addr, msg[i].buf,\r\nmsg[i].len, NULL, 0) < 0)\r\nbreak;\r\n}\r\nmutex_unlock(&d->i2c_mutex);\r\nreturn i;\r\n}\r\nstatic u32 gl861_i2c_func(struct i2c_adapter *adapter)\r\n{\r\nreturn I2C_FUNC_I2C;\r\n}\r\nstatic int gl861_frontend_attach(struct dvb_usb_adapter *adap)\r\n{\r\nadap->fe = dvb_attach(zl10353_attach, &gl861_zl10353_config,\r\n&adap->dev->i2c_adap);\r\nif (adap->fe == NULL)\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic int gl861_tuner_attach(struct dvb_usb_adapter *adap)\r\n{\r\nreturn dvb_attach(qt1010_attach,\r\nadap->fe, &adap->dev->i2c_adap,\r\n&gl861_qt1010_config) == NULL ? -ENODEV : 0;\r\n}\r\nstatic int gl861_probe(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct dvb_usb_device *d;\r\nstruct usb_host_interface *alt;\r\nint ret;\r\nif (intf->num_altsetting < 2)\r\nreturn -ENODEV;\r\nret = dvb_usb_device_init(intf, &gl861_properties, THIS_MODULE, &d,\r\nadapter_nr);\r\nif (ret == 0) {\r\nalt = usb_altnum_to_altsetting(intf, 0);\r\nif (alt == NULL) {\r\ndeb_rc("not alt found!\n");\r\nreturn -ENODEV;\r\n}\r\nret = usb_set_interface(d->udev, alt->desc.bInterfaceNumber,\r\nalt->desc.bAlternateSetting);\r\n}\r\nreturn ret;\r\n}\r\nstatic int __init gl861_module_init(void)\r\n{\r\nint ret;\r\nret = usb_register(&gl861_driver);\r\nif (ret)\r\nerr("usb_register failed. Error number %d", ret);\r\nreturn ret;\r\n}\r\nstatic void __exit gl861_module_exit(void)\r\n{\r\nusb_deregister(&gl861_driver);\r\n}

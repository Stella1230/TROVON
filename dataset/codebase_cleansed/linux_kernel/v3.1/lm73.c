static ssize_t set_temp(struct device *dev, struct device_attribute *da,\r\nconst char *buf, size_t count)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(da);\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nlong temp;\r\nshort value;\r\nint status = strict_strtol(buf, 10, &temp);\r\nif (status < 0)\r\nreturn status;\r\nvalue = (short) SENSORS_LIMIT(temp/250, (LM73_TEMP_MIN*4),\r\n(LM73_TEMP_MAX*4)) << 5;\r\ni2c_smbus_write_word_data(client, attr->index, swab16(value));\r\nreturn count;\r\n}\r\nstatic ssize_t show_temp(struct device *dev, struct device_attribute *da,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(da);\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nint temp = ((s16) (swab16(i2c_smbus_read_word_data(client,\r\nattr->index)))*250) / 32;\r\nreturn sprintf(buf, "%d\n", temp);\r\n}\r\nstatic int\r\nlm73_probe(struct i2c_client *client, const struct i2c_device_id *id)\r\n{\r\nstruct device *hwmon_dev;\r\nint status;\r\nstatus = sysfs_create_group(&client->dev.kobj, &lm73_group);\r\nif (status)\r\nreturn status;\r\nhwmon_dev = hwmon_device_register(&client->dev);\r\nif (IS_ERR(hwmon_dev)) {\r\nstatus = PTR_ERR(hwmon_dev);\r\ngoto exit_remove;\r\n}\r\ni2c_set_clientdata(client, hwmon_dev);\r\ndev_info(&client->dev, "%s: sensor '%s'\n",\r\ndev_name(hwmon_dev), client->name);\r\nreturn 0;\r\nexit_remove:\r\nsysfs_remove_group(&client->dev.kobj, &lm73_group);\r\nreturn status;\r\n}\r\nstatic int lm73_remove(struct i2c_client *client)\r\n{\r\nstruct device *hwmon_dev = i2c_get_clientdata(client);\r\nhwmon_device_unregister(hwmon_dev);\r\nsysfs_remove_group(&client->dev.kobj, &lm73_group);\r\nreturn 0;\r\n}\r\nstatic int lm73_detect(struct i2c_client *new_client,\r\nstruct i2c_board_info *info)\r\n{\r\nstruct i2c_adapter *adapter = new_client->adapter;\r\nu16 id;\r\nu8 ctrl;\r\nif (!i2c_check_functionality(adapter, I2C_FUNC_SMBUS_BYTE_DATA |\r\nI2C_FUNC_SMBUS_WORD_DATA))\r\nreturn -ENODEV;\r\nid = i2c_smbus_read_word_data(new_client, LM73_REG_ID);\r\nctrl = i2c_smbus_read_byte_data(new_client, LM73_REG_CTRL);\r\nif ((id != LM73_ID) || (ctrl & 0x10))\r\nreturn -ENODEV;\r\nstrlcpy(info->type, "lm73", I2C_NAME_SIZE);\r\nreturn 0;\r\n}\r\nstatic int __init sensors_lm73_init(void)\r\n{\r\nreturn i2c_add_driver(&lm73_driver);\r\n}\r\nstatic void __exit sensors_lm73_exit(void)\r\n{\r\ni2c_del_driver(&lm73_driver);\r\n}

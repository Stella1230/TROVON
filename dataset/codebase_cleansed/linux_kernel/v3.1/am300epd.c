static int am300_wait_event(struct broadsheetfb_par *par)\r\n{\r\nwait_event(par->waitq, gpio_get_value(RDY_GPIO_PIN));\r\nreturn 0;\r\n}\r\nstatic int am300_init_gpio_regs(struct broadsheetfb_par *par)\r\n{\r\nint i;\r\nint err;\r\nchar dbname[8];\r\nfor (i = 0; i < ARRAY_SIZE(gpios); i++) {\r\nerr = gpio_request(gpios[i], gpio_names[i]);\r\nif (err) {\r\ndev_err(&am300_device->dev, "failed requesting "\r\n"gpio %s, err=%d\n", gpio_names[i], err);\r\ngoto err_req_gpio;\r\n}\r\n}\r\nfor (i = DB0_GPIO_PIN; i <= DB15_GPIO_PIN; i++) {\r\nsprintf(dbname, "DB%d", i);\r\nerr = gpio_request(i, dbname);\r\nif (err) {\r\ndev_err(&am300_device->dev, "failed requesting "\r\n"gpio %d, err=%d\n", i, err);\r\ngoto err_req_gpio2;\r\n}\r\n}\r\ngpio_direction_output(PWR_GPIO_PIN, 0);\r\ngpio_direction_output(CFG_GPIO_PIN, 1);\r\ngpio_direction_output(DC_GPIO_PIN, 0);\r\ngpio_direction_output(RD_GPIO_PIN, 1);\r\ngpio_direction_output(WR_GPIO_PIN, 1);\r\ngpio_direction_output(CS_GPIO_PIN, 1);\r\ngpio_direction_output(RST_GPIO_PIN, 0);\r\ngpio_direction_input(RDY_GPIO_PIN);\r\ngpio_direction_input(IRQ_GPIO_PIN);\r\nfor (i = DB0_GPIO_PIN; i <= DB15_GPIO_PIN; i++)\r\ngpio_direction_output(i, 0);\r\ngpio_set_value(CFG_GPIO_PIN, 1);\r\ngpio_set_value(RST_GPIO_PIN, 0);\r\nmsleep(10);\r\ngpio_set_value(RST_GPIO_PIN, 1);\r\nmsleep(10);\r\nam300_wait_event(par);\r\nreturn 0;\r\nerr_req_gpio2:\r\nwhile (--i >= DB0_GPIO_PIN)\r\ngpio_free(i);\r\ni = ARRAY_SIZE(gpios);\r\nerr_req_gpio:\r\nwhile (--i >= 0)\r\ngpio_free(gpios[i]);\r\nreturn err;\r\n}\r\nstatic int am300_init_board(struct broadsheetfb_par *par)\r\n{\r\nreturn am300_init_gpio_regs(par);\r\n}\r\nstatic void am300_cleanup(struct broadsheetfb_par *par)\r\n{\r\nint i;\r\nfree_irq(IRQ_GPIO(RDY_GPIO_PIN), par);\r\nfor (i = 0; i < ARRAY_SIZE(gpios); i++)\r\ngpio_free(gpios[i]);\r\nfor (i = DB0_GPIO_PIN; i <= DB15_GPIO_PIN; i++)\r\ngpio_free(i);\r\n}\r\nstatic u16 am300_get_hdb(struct broadsheetfb_par *par)\r\n{\r\nu16 res = 0;\r\nint i;\r\nfor (i = 0; i <= (DB15_GPIO_PIN - DB0_GPIO_PIN) ; i++)\r\nres |= (gpio_get_value(DB0_GPIO_PIN + i)) ? (1 << i) : 0;\r\nreturn res;\r\n}\r\nstatic void am300_set_hdb(struct broadsheetfb_par *par, u16 data)\r\n{\r\nint i;\r\nfor (i = 0; i <= (DB15_GPIO_PIN - DB0_GPIO_PIN) ; i++)\r\ngpio_set_value(DB0_GPIO_PIN + i, (data >> i) & 0x01);\r\n}\r\nstatic void am300_set_ctl(struct broadsheetfb_par *par, unsigned char bit,\r\nu8 state)\r\n{\r\nswitch (bit) {\r\ncase BS_CS:\r\ngpio_set_value(CS_GPIO_PIN, state);\r\nbreak;\r\ncase BS_DC:\r\ngpio_set_value(DC_GPIO_PIN, state);\r\nbreak;\r\ncase BS_WR:\r\ngpio_set_value(WR_GPIO_PIN, state);\r\nbreak;\r\n}\r\n}\r\nstatic int am300_get_panel_type(void)\r\n{\r\nreturn panel_type;\r\n}\r\nstatic irqreturn_t am300_handle_irq(int irq, void *dev_id)\r\n{\r\nstruct broadsheetfb_par *par = dev_id;\r\nwake_up(&par->waitq);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int am300_setup_irq(struct fb_info *info)\r\n{\r\nint ret;\r\nstruct broadsheetfb_par *par = info->par;\r\nret = request_irq(IRQ_GPIO(RDY_GPIO_PIN), am300_handle_irq,\r\nIRQF_DISABLED|IRQF_TRIGGER_RISING,\r\n"AM300", par);\r\nif (ret)\r\ndev_err(&am300_device->dev, "request_irq failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nint __init am300_init(void)\r\n{\r\nint ret;\r\npxa2xx_mfp_config(ARRAY_AND_SIZE(am300_pin_config));\r\nrequest_module("broadsheetfb");\r\nam300_device = platform_device_alloc("broadsheetfb", -1);\r\nif (!am300_device)\r\nreturn -ENOMEM;\r\nplatform_device_add_data(am300_device, &am300_board,\r\nsizeof(am300_board));\r\nret = platform_device_add(am300_device);\r\nif (ret) {\r\nplatform_device_put(am300_device);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}

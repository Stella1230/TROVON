static ssize_t show_type(struct device *cdev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct atm_dev *adev = to_atm_dev(cdev);\r\nreturn sprintf(buf, "%s\n", adev->type);\r\n}\r\nstatic ssize_t show_address(struct device *cdev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nchar *pos = buf;\r\nstruct atm_dev *adev = to_atm_dev(cdev);\r\nint i;\r\nfor (i = 0; i < (ESI_LEN - 1); i++)\r\npos += sprintf(pos, "%02x:", adev->esi[i]);\r\npos += sprintf(pos, "%02x\n", adev->esi[i]);\r\nreturn pos - buf;\r\n}\r\nstatic ssize_t show_atmaddress(struct device *cdev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned long flags;\r\nchar *pos = buf;\r\nstruct atm_dev *adev = to_atm_dev(cdev);\r\nstruct atm_dev_addr *aaddr;\r\nint bin[] = { 1, 2, 10, 6, 1 }, *fmt = bin;\r\nint i, j;\r\nspin_lock_irqsave(&adev->lock, flags);\r\nlist_for_each_entry(aaddr, &adev->local, entry) {\r\nfor (i = 0, j = 0; i < ATM_ESA_LEN; ++i, ++j) {\r\nif (j == *fmt) {\r\npos += sprintf(pos, ".");\r\n++fmt;\r\nj = 0;\r\n}\r\npos += sprintf(pos, "%02x",\r\naaddr->addr.sas_addr.prv[i]);\r\n}\r\npos += sprintf(pos, "\n");\r\n}\r\nspin_unlock_irqrestore(&adev->lock, flags);\r\nreturn pos - buf;\r\n}\r\nstatic ssize_t show_atmindex(struct device *cdev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct atm_dev *adev = to_atm_dev(cdev);\r\nreturn sprintf(buf, "%d\n", adev->number);\r\n}\r\nstatic ssize_t show_carrier(struct device *cdev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nchar *pos = buf;\r\nstruct atm_dev *adev = to_atm_dev(cdev);\r\npos += sprintf(pos, "%d\n",\r\nadev->signal == ATM_PHY_SIG_LOST ? 0 : 1);\r\nreturn pos - buf;\r\n}\r\nstatic ssize_t show_link_rate(struct device *cdev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nchar *pos = buf;\r\nstruct atm_dev *adev = to_atm_dev(cdev);\r\nint link_rate;\r\nswitch (adev->link_rate) {\r\ncase ATM_OC3_PCR:\r\nlink_rate = 155520000;\r\nbreak;\r\ncase ATM_OC12_PCR:\r\nlink_rate = 622080000;\r\nbreak;\r\ncase ATM_25_PCR:\r\nlink_rate = 25600000;\r\nbreak;\r\ndefault:\r\nlink_rate = adev->link_rate * 8 * 53;\r\n}\r\npos += sprintf(pos, "%d\n", link_rate);\r\nreturn pos - buf;\r\n}\r\nstatic int atm_uevent(struct device *cdev, struct kobj_uevent_env *env)\r\n{\r\nstruct atm_dev *adev;\r\nif (!cdev)\r\nreturn -ENODEV;\r\nadev = to_atm_dev(cdev);\r\nif (!adev)\r\nreturn -ENODEV;\r\nif (add_uevent_var(env, "NAME=%s%d", adev->type, adev->number))\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nstatic void atm_release(struct device *cdev)\r\n{\r\nstruct atm_dev *adev = to_atm_dev(cdev);\r\nkfree(adev);\r\n}\r\nint atm_register_sysfs(struct atm_dev *adev, struct device *parent)\r\n{\r\nstruct device *cdev = &adev->class_dev;\r\nint i, j, err;\r\ncdev->class = &atm_class;\r\ncdev->parent = parent;\r\ndev_set_drvdata(cdev, adev);\r\ndev_set_name(cdev, "%s%d", adev->type, adev->number);\r\nerr = device_register(cdev);\r\nif (err < 0)\r\nreturn err;\r\nfor (i = 0; atm_attrs[i]; i++) {\r\nerr = device_create_file(cdev, atm_attrs[i]);\r\nif (err)\r\ngoto err_out;\r\n}\r\nreturn 0;\r\nerr_out:\r\nfor (j = 0; j < i; j++)\r\ndevice_remove_file(cdev, atm_attrs[j]);\r\ndevice_del(cdev);\r\nreturn err;\r\n}\r\nvoid atm_unregister_sysfs(struct atm_dev *adev)\r\n{\r\nstruct device *cdev = &adev->class_dev;\r\ndevice_del(cdev);\r\n}\r\nint __init atm_sysfs_init(void)\r\n{\r\nreturn class_register(&atm_class);\r\n}\r\nvoid __exit atm_sysfs_exit(void)\r\n{\r\nclass_unregister(&atm_class);\r\n}

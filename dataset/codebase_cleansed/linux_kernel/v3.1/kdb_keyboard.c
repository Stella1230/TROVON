int kdb_get_kbd_char(void)\r\n{\r\nint scancode, scanstatus;\r\nstatic int shift_lock;\r\nstatic int shift_key;\r\nstatic int ctrl_key;\r\nu_short keychar;\r\nif (KDB_FLAG(NO_I8042) || KDB_FLAG(NO_VT_CONSOLE) ||\r\n(inb(KBD_STATUS_REG) == 0xff && inb(KBD_DATA_REG) == 0xff)) {\r\nkbd_exists = 0;\r\nreturn -1;\r\n}\r\nkbd_exists = 1;\r\nif ((inb(KBD_STATUS_REG) & KBD_STAT_OBF) == 0)\r\nreturn -1;\r\nscancode = inb(KBD_DATA_REG);\r\nscanstatus = inb(KBD_STATUS_REG);\r\nif (scanstatus & KBD_STAT_MOUSE_OBF)\r\nreturn -1;\r\nif (((scancode&0x7f) == 0x2a) || ((scancode&0x7f) == 0x36)) {\r\nif ((scancode & 0x80) == 0)\r\nshift_key = 1;\r\nelse\r\nshift_key = 0;\r\nreturn -1;\r\n}\r\nif ((scancode&0x7f) == 0x1d) {\r\nif ((scancode & 0x80) == 0)\r\nctrl_key = 1;\r\nelse\r\nctrl_key = 0;\r\nreturn -1;\r\n}\r\nif ((scancode & 0x80) != 0)\r\nreturn -1;\r\nscancode &= 0x7f;\r\nif (scancode == 0x3a) {\r\nshift_lock ^= 1;\r\n#ifdef KDB_BLINK_LED\r\nkdb_toggleled(0x4);\r\n#endif\r\nreturn -1;\r\n}\r\nif (scancode == 0x0e) {\r\nreturn 8;\r\n}\r\nswitch (scancode) {\r\ncase 0xF:\r\nreturn 9;\r\ncase 0x53:\r\nreturn 4;\r\ncase 0x47:\r\nreturn 1;\r\ncase 0x4F:\r\nreturn 5;\r\ncase 0x4B:\r\nreturn 2;\r\ncase 0x48:\r\nreturn 16;\r\ncase 0x50:\r\nreturn 14;\r\ncase 0x4D:\r\nreturn 6;\r\n}\r\nif (scancode == 0xe0)\r\nreturn -1;\r\nif (scancode == 0x73)\r\nscancode = 0x59;\r\nelse if (scancode == 0x7d)\r\nscancode = 0x7c;\r\nif (!shift_lock && !shift_key && !ctrl_key) {\r\nkeychar = plain_map[scancode];\r\n} else if ((shift_lock || shift_key) && key_maps[1]) {\r\nkeychar = key_maps[1][scancode];\r\n} else if (ctrl_key && key_maps[4]) {\r\nkeychar = key_maps[4][scancode];\r\n} else {\r\nkeychar = 0x0020;\r\nkdb_printf("Unknown state/scancode (%d)\n", scancode);\r\n}\r\nkeychar &= 0x0fff;\r\nif (keychar == '\t')\r\nkeychar = ' ';\r\nswitch (KTYP(keychar)) {\r\ncase KT_LETTER:\r\ncase KT_LATIN:\r\nif (isprint(keychar))\r\nbreak;\r\ncase KT_SPEC:\r\nif (keychar == K_ENTER)\r\nbreak;\r\ndefault:\r\nreturn -1;\r\n}\r\nif ((scancode & 0x7f) == 0x1c) {\r\nwhile ((inb(KBD_STATUS_REG) & KBD_STAT_OBF) == 0)\r\n;\r\nscancode = inb(KBD_DATA_REG);\r\nscanstatus = inb(KBD_STATUS_REG);\r\nwhile (scanstatus & KBD_STAT_MOUSE_OBF) {\r\nscancode = inb(KBD_DATA_REG);\r\nscanstatus = inb(KBD_STATUS_REG);\r\n}\r\nif (scancode != 0x9c) {\r\nkdb_printf("kdb: expected enter got 0x%x status 0x%x\n",\r\nscancode, scanstatus);\r\n}\r\nreturn 13;\r\n}\r\nreturn keychar & 0xff;\r\n}

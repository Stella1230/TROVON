long h8300_get_reg(struct task_struct *task, int regno)\r\n{\r\nswitch (regno) {\r\ncase PT_USP:\r\nreturn task->thread.usp + sizeof(long)*2 + 2;\r\ncase PT_CCR:\r\ncase PT_EXR:\r\nreturn *(unsigned short *)(task->thread.esp0 + h8300_register_offset[regno]);\r\ndefault:\r\nreturn *(unsigned long *)(task->thread.esp0 + h8300_register_offset[regno]);\r\n}\r\n}\r\nint h8300_put_reg(struct task_struct *task, int regno, unsigned long data)\r\n{\r\nunsigned short oldccr;\r\nswitch (regno) {\r\ncase PT_USP:\r\ntask->thread.usp = data - sizeof(long)*2 - 2;\r\ncase PT_CCR:\r\noldccr = *(unsigned short *)(task->thread.esp0 + h8300_register_offset[regno]);\r\noldccr &= ~CCR_MASK;\r\ndata &= CCR_MASK;\r\ndata |= oldccr;\r\n*(unsigned short *)(task->thread.esp0 + h8300_register_offset[regno]) = data;\r\nbreak;\r\ncase PT_EXR:\r\nreturn -EIO;\r\ndefault:\r\n*(unsigned long *)(task->thread.esp0 + h8300_register_offset[regno]) = data;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nvoid user_disable_single_step(struct task_struct *child)\r\n{\r\n*(unsigned short *)(child->thread.esp0 + h8300_register_offset[PT_EXR]) &= ~EXR_TRACE;\r\n}\r\nvoid user_enable_single_step(struct task_struct *child)\r\n{\r\n*(unsigned short *)(child->thread.esp0 + h8300_register_offset[PT_EXR]) |= EXR_TRACE;\r\n}\r\nasmlinkage void trace_trap(unsigned long bp)\r\n{\r\n(void)bp;\r\nforce_sig(SIGTRAP,current);\r\n}

void vMgrObjectInit(void *hDeviceContext)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPSMgmtObject pMgmt = &(pDevice->sMgmtObj);\r\nint ii;\r\npMgmt->pbyPSPacketPool = &pMgmt->byPSPacketPool[0];\r\npMgmt->pbyMgmtPacketPool = &pMgmt->byMgmtPacketPool[0];\r\npMgmt->uCurrChannel = pDevice->uChannel;\r\nfor (ii = 0; ii < WLAN_BSSID_LEN; ii++)\r\npMgmt->abyDesireBSSID[ii] = 0xFF;\r\npMgmt->sAssocInfo.AssocInfo.Length = sizeof(NDIS_802_11_ASSOCIATION_INFORMATION);\r\npMgmt->byCSSPK = KEY_CTL_NONE;\r\npMgmt->byCSSGK = KEY_CTL_NONE;\r\npMgmt->wIBSSBeaconPeriod = DEFAULT_IBSS_BI;\r\nBSSvClearBSSList((void *) pDevice, FALSE);\r\ninit_timer(&pMgmt->sTimerSecondCallback);\r\npMgmt->sTimerSecondCallback.data = (unsigned long)pDevice;\r\npMgmt->sTimerSecondCallback.function = (TimerFunction)BSSvSecondCallBack;\r\npMgmt->sTimerSecondCallback.expires = RUN_AT(HZ);\r\ninit_timer(&pDevice->sTimerCommand);\r\npDevice->sTimerCommand.data = (unsigned long)pDevice;\r\npDevice->sTimerCommand.function = (TimerFunction)vRunCommand;\r\npDevice->sTimerCommand.expires = RUN_AT(HZ);\r\ninit_timer(&pDevice->sTimerTxData);\r\npDevice->sTimerTxData.data = (unsigned long)pDevice;\r\npDevice->sTimerTxData.function = (TimerFunction)BSSvSecondTxData;\r\npDevice->sTimerTxData.expires = RUN_AT(10*HZ);\r\npDevice->fTxDataInSleep = FALSE;\r\npDevice->IsTxDataTrigger = FALSE;\r\npDevice->nTxDataTimeCout = 0;\r\npDevice->cbFreeCmdQueue = CMD_Q_SIZE;\r\npDevice->uCmdDequeueIdx = 0;\r\npDevice->uCmdEnqueueIdx = 0;\r\npDevice->eCommandState = WLAN_CMD_IDLE;\r\npDevice->bCmdRunning = FALSE;\r\npDevice->bCmdClear = FALSE;\r\nreturn;\r\n}\r\nvoid vMgrAssocBeginSta(void *hDeviceContext,\r\nPSMgmtObject pMgmt,\r\nPCMD_STATUS pStatus)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPSTxMgmtPacket pTxPacket;\r\npMgmt->wCurrCapInfo = 0;\r\npMgmt->wCurrCapInfo |= WLAN_SET_CAP_INFO_ESS(1);\r\nif (pDevice->bEncryptionEnable) {\r\npMgmt->wCurrCapInfo |= WLAN_SET_CAP_INFO_PRIVACY(1);\r\n}\r\npMgmt->wCurrCapInfo |= WLAN_SET_CAP_INFO_SHORTPREAMBLE(1);\r\nif (pMgmt->wListenInterval == 0)\r\npMgmt->wListenInterval = 1;\r\nif (pMgmt->eCurrentPHYMode == PHY_TYPE_11G) {\r\npMgmt->wCurrCapInfo |= WLAN_SET_CAP_INFO_SHORTPREAMBLE(1);\r\nif (pDevice->bShortSlotTime == TRUE)\r\npMgmt->wCurrCapInfo |= WLAN_SET_CAP_INFO_SHORTSLOTTIME(1);\r\n} else if (pMgmt->eCurrentPHYMode == PHY_TYPE_11B) {\r\nif (pDevice->byPreambleType == 1) {\r\npMgmt->wCurrCapInfo |= WLAN_SET_CAP_INFO_SHORTPREAMBLE(1);\r\n}\r\n}\r\nif (pMgmt->b11hEnable == TRUE)\r\npMgmt->wCurrCapInfo |= WLAN_SET_CAP_INFO_SPECTRUMMNG(1);\r\npTxPacket = s_MgrMakeAssocRequest\r\n(\r\npDevice,\r\npMgmt,\r\npMgmt->abyCurrBSSID,\r\npMgmt->wCurrCapInfo,\r\npMgmt->wListenInterval,\r\n(PWLAN_IE_SSID)pMgmt->abyCurrSSID,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrSuppRates,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrExtSuppRates\r\n);\r\nif (pTxPacket != NULL ){\r\n*pStatus = csMgmt_xmit(pDevice, pTxPacket);\r\nif (*pStatus == CMD_STATUS_PENDING) {\r\npMgmt->eCurrState = WMAC_STATE_ASSOCPENDING;\r\n*pStatus = CMD_STATUS_SUCCESS;\r\n}\r\n}\r\nelse\r\n*pStatus = CMD_STATUS_RESOURCES;\r\nreturn ;\r\n}\r\nvoid vMgrReAssocBeginSta(void *hDeviceContext,\r\nPSMgmtObject pMgmt,\r\nPCMD_STATUS pStatus)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPSTxMgmtPacket pTxPacket;\r\npMgmt->wCurrCapInfo = 0;\r\npMgmt->wCurrCapInfo |= WLAN_SET_CAP_INFO_ESS(1);\r\nif (pDevice->bEncryptionEnable) {\r\npMgmt->wCurrCapInfo |= WLAN_SET_CAP_INFO_PRIVACY(1);\r\n}\r\npMgmt->wCurrCapInfo |= WLAN_SET_CAP_INFO_SHORTPREAMBLE(1);\r\nif (pMgmt->wListenInterval == 0)\r\npMgmt->wListenInterval = 1;\r\nif (pMgmt->eCurrentPHYMode == PHY_TYPE_11G) {\r\npMgmt->wCurrCapInfo |= WLAN_SET_CAP_INFO_SHORTPREAMBLE(1);\r\nif (pDevice->bShortSlotTime == TRUE)\r\npMgmt->wCurrCapInfo |= WLAN_SET_CAP_INFO_SHORTSLOTTIME(1);\r\n} else if (pMgmt->eCurrentPHYMode == PHY_TYPE_11B) {\r\nif (pDevice->byPreambleType == 1) {\r\npMgmt->wCurrCapInfo |= WLAN_SET_CAP_INFO_SHORTPREAMBLE(1);\r\n}\r\n}\r\nif (pMgmt->b11hEnable == TRUE)\r\npMgmt->wCurrCapInfo |= WLAN_SET_CAP_INFO_SPECTRUMMNG(1);\r\npTxPacket = s_MgrMakeReAssocRequest\r\n(\r\npDevice,\r\npMgmt,\r\npMgmt->abyCurrBSSID,\r\npMgmt->wCurrCapInfo,\r\npMgmt->wListenInterval,\r\n(PWLAN_IE_SSID)pMgmt->abyCurrSSID,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrSuppRates,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrExtSuppRates\r\n);\r\nif (pTxPacket != NULL ){\r\n*pStatus = csMgmt_xmit(pDevice, pTxPacket);\r\nif (*pStatus != CMD_STATUS_PENDING) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Mgt:Reassociation tx failed.\n");\r\n}\r\nelse {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Mgt:Reassociation tx sending.\n");\r\n}\r\n}\r\nreturn ;\r\n}\r\nvoid vMgrDisassocBeginSta(void *hDeviceContext,\r\nPSMgmtObject pMgmt,\r\nPBYTE abyDestAddress,\r\nWORD wReason,\r\nPCMD_STATUS pStatus)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPSTxMgmtPacket pTxPacket = NULL;\r\nWLAN_FR_DISASSOC sFrame;\r\npTxPacket = (PSTxMgmtPacket)pMgmt->pbyMgmtPacketPool;\r\nmemset(pTxPacket, 0, sizeof(STxMgmtPacket) + WLAN_DISASSOC_FR_MAXLEN);\r\npTxPacket->p80211Header = (PUWLAN_80211HDR)((PBYTE)pTxPacket + sizeof(STxMgmtPacket));\r\nsFrame.pBuf = (PBYTE)pTxPacket->p80211Header;\r\nsFrame.len = WLAN_DISASSOC_FR_MAXLEN;\r\nvMgrEncodeDisassociation(&sFrame);\r\nsFrame.pHdr->sA3.wFrameCtl = cpu_to_le16(\r\n(\r\nWLAN_SET_FC_FTYPE(WLAN_TYPE_MGR) |\r\nWLAN_SET_FC_FSTYPE(WLAN_FSTYPE_DISASSOC)\r\n));\r\nmemcpy( sFrame.pHdr->sA3.abyAddr1, abyDestAddress, WLAN_ADDR_LEN);\r\nmemcpy( sFrame.pHdr->sA3.abyAddr2, pMgmt->abyMACAddr, WLAN_ADDR_LEN);\r\nmemcpy( sFrame.pHdr->sA3.abyAddr3, pMgmt->abyCurrBSSID, WLAN_BSSID_LEN);\r\n*(sFrame.pwReason) = cpu_to_le16(wReason);\r\npTxPacket->cbMPDULen = sFrame.len;\r\npTxPacket->cbPayloadLen = sFrame.len - WLAN_HDR_ADDR3_LEN;\r\n*pStatus = csMgmt_xmit(pDevice, pTxPacket);\r\nif (*pStatus == CMD_STATUS_PENDING) {\r\npMgmt->eCurrState = WMAC_STATE_IDLE;\r\n*pStatus = CMD_STATUS_SUCCESS;\r\n}\r\nreturn;\r\n}\r\nstatic\r\nvoid\r\ns_vMgrRxAssocRequest(\r\nPSDevice pDevice,\r\nPSMgmtObject pMgmt,\r\nPSRxMgmtPacket pRxPacket,\r\nunsigned int uNodeIndex\r\n)\r\n{\r\nWLAN_FR_ASSOCREQ sFrame;\r\nCMD_STATUS Status;\r\nPSTxMgmtPacket pTxPacket;\r\nWORD wAssocStatus = 0;\r\nWORD wAssocAID = 0;\r\nunsigned int uRateLen = WLAN_RATES_MAXLEN;\r\nBYTE abyCurrSuppRates[WLAN_IEHDR_LEN + WLAN_RATES_MAXLEN + 1];\r\nBYTE abyCurrExtSuppRates[WLAN_IEHDR_LEN + WLAN_RATES_MAXLEN + 1];\r\nif (pMgmt->eCurrMode != WMAC_MODE_ESS_AP)\r\nreturn;\r\nif (!uNodeIndex)\r\nreturn;\r\nmemset(&sFrame, 0, sizeof(WLAN_FR_ASSOCREQ));\r\nmemset(abyCurrSuppRates, 0, WLAN_IEHDR_LEN + WLAN_RATES_MAXLEN + 1);\r\nmemset(abyCurrExtSuppRates, 0, WLAN_IEHDR_LEN + WLAN_RATES_MAXLEN + 1);\r\nsFrame.len = pRxPacket->cbMPDULen;\r\nsFrame.pBuf = (PBYTE)pRxPacket->p80211Header;\r\nvMgrDecodeAssocRequest(&sFrame);\r\nif (pMgmt->sNodeDBTable[uNodeIndex].eNodeState >= NODE_AUTH) {\r\npMgmt->sNodeDBTable[uNodeIndex].eNodeState = NODE_ASSOC;\r\npMgmt->sNodeDBTable[uNodeIndex].wCapInfo = cpu_to_le16(*sFrame.pwCapInfo);\r\npMgmt->sNodeDBTable[uNodeIndex].wListenInterval = cpu_to_le16(*sFrame.pwListenInterval);\r\npMgmt->sNodeDBTable[uNodeIndex].bPSEnable =\r\nWLAN_GET_FC_PWRMGT(sFrame.pHdr->sA3.wFrameCtl) ? TRUE : FALSE;\r\nif (pDevice->byBBType == BB_TYPE_11B) {\r\nuRateLen = WLAN_RATES_MAXLEN_11B;\r\n}\r\nabyCurrSuppRates[0] = WLAN_EID_SUPP_RATES;\r\nabyCurrSuppRates[1] = RATEuSetIE((PWLAN_IE_SUPP_RATES)sFrame.pSuppRates,\r\n(PWLAN_IE_SUPP_RATES)abyCurrSuppRates,\r\nuRateLen);\r\nabyCurrExtSuppRates[0] = WLAN_EID_EXTSUPP_RATES;\r\nif (pDevice->byBBType == BB_TYPE_11G) {\r\nabyCurrExtSuppRates[1] = RATEuSetIE((PWLAN_IE_SUPP_RATES)sFrame.pExtSuppRates,\r\n(PWLAN_IE_SUPP_RATES)abyCurrExtSuppRates,\r\nuRateLen);\r\n} else {\r\nabyCurrExtSuppRates[1] = 0;\r\n}\r\nRATEvParseMaxRate((void *)pDevice,\r\n(PWLAN_IE_SUPP_RATES)abyCurrSuppRates,\r\n(PWLAN_IE_SUPP_RATES)abyCurrExtSuppRates,\r\nFALSE,\r\n&(pMgmt->sNodeDBTable[uNodeIndex].wMaxBasicRate),\r\n&(pMgmt->sNodeDBTable[uNodeIndex].wMaxSuppRate),\r\n&(pMgmt->sNodeDBTable[uNodeIndex].wSuppRate),\r\n&(pMgmt->sNodeDBTable[uNodeIndex].byTopCCKBasicRate),\r\n&(pMgmt->sNodeDBTable[uNodeIndex].byTopOFDMBasicRate)\r\n);\r\npMgmt->sNodeDBTable[uNodeIndex].wTxDataRate =\r\npMgmt->sNodeDBTable[uNodeIndex].wMaxSuppRate;\r\npMgmt->sNodeDBTable[uNodeIndex].bShortPreamble =\r\nWLAN_GET_CAP_INFO_SHORTPREAMBLE(*sFrame.pwCapInfo);\r\npMgmt->sNodeDBTable[uNodeIndex].bShortSlotTime =\r\nWLAN_GET_CAP_INFO_SHORTSLOTTIME(*sFrame.pwCapInfo);\r\npMgmt->sNodeDBTable[uNodeIndex].wAID = (WORD)uNodeIndex;\r\nwAssocStatus = WLAN_MGMT_STATUS_SUCCESS;\r\nwAssocAID = (WORD)uNodeIndex;\r\nif(pMgmt->sNodeDBTable[uNodeIndex].wMaxSuppRate > RATE_11M)\r\npMgmt->sNodeDBTable[uNodeIndex].bERPExist = TRUE;\r\nif (pMgmt->sNodeDBTable[uNodeIndex].wMaxSuppRate <= RATE_11M) {\r\npDevice->bProtectMode = TRUE;\r\npDevice->bNonERPPresent = TRUE;\r\n}\r\nif (pMgmt->sNodeDBTable[uNodeIndex].bShortPreamble == FALSE) {\r\npDevice->bBarkerPreambleMd = TRUE;\r\n}\r\nDBG_PRT(MSG_LEVEL_INFO, KERN_INFO "Associate AID= %d \n", wAssocAID);\r\nDBG_PRT(MSG_LEVEL_INFO, KERN_INFO "MAC=%2.2X:%2.2X:%2.2X:%2.2X:%2.2X:%2.2X \n",\r\nsFrame.pHdr->sA3.abyAddr2[0],\r\nsFrame.pHdr->sA3.abyAddr2[1],\r\nsFrame.pHdr->sA3.abyAddr2[2],\r\nsFrame.pHdr->sA3.abyAddr2[3],\r\nsFrame.pHdr->sA3.abyAddr2[4],\r\nsFrame.pHdr->sA3.abyAddr2[5]\r\n) ;\r\nDBG_PRT(MSG_LEVEL_INFO, KERN_INFO "Max Support rate = %d \n",\r\npMgmt->sNodeDBTable[uNodeIndex].wMaxSuppRate);\r\n}\r\npTxPacket = s_MgrMakeAssocResponse\r\n(\r\npDevice,\r\npMgmt,\r\npMgmt->wCurrCapInfo,\r\nwAssocStatus,\r\nwAssocAID,\r\nsFrame.pHdr->sA3.abyAddr2,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrSuppRates,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrExtSuppRates\r\n);\r\nif (pTxPacket != NULL ){\r\nif (pDevice->bEnableHostapd) {\r\nreturn;\r\n}\r\nStatus = csMgmt_xmit(pDevice, pTxPacket);\r\nif (Status != CMD_STATUS_PENDING) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Mgt:Assoc response tx failed\n");\r\n}\r\nelse {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Mgt:Assoc response tx sending..\n");\r\n}\r\n}\r\nreturn;\r\n}\r\nstatic\r\nvoid\r\ns_vMgrRxReAssocRequest(\r\nPSDevice pDevice,\r\nPSMgmtObject pMgmt,\r\nPSRxMgmtPacket pRxPacket,\r\nunsigned int uNodeIndex\r\n)\r\n{\r\nWLAN_FR_REASSOCREQ sFrame;\r\nCMD_STATUS Status;\r\nPSTxMgmtPacket pTxPacket;\r\nWORD wAssocStatus = 0;\r\nWORD wAssocAID = 0;\r\nunsigned int uRateLen = WLAN_RATES_MAXLEN;\r\nBYTE abyCurrSuppRates[WLAN_IEHDR_LEN + WLAN_RATES_MAXLEN + 1];\r\nBYTE abyCurrExtSuppRates[WLAN_IEHDR_LEN + WLAN_RATES_MAXLEN + 1];\r\nif (pMgmt->eCurrMode != WMAC_MODE_ESS_AP)\r\nreturn;\r\nif (!uNodeIndex)\r\nreturn;\r\nmemset(&sFrame, 0, sizeof(WLAN_FR_REASSOCREQ));\r\nsFrame.len = pRxPacket->cbMPDULen;\r\nsFrame.pBuf = (PBYTE)pRxPacket->p80211Header;\r\nvMgrDecodeReassocRequest(&sFrame);\r\nif (pMgmt->sNodeDBTable[uNodeIndex].eNodeState >= NODE_AUTH) {\r\npMgmt->sNodeDBTable[uNodeIndex].eNodeState = NODE_ASSOC;\r\npMgmt->sNodeDBTable[uNodeIndex].wCapInfo = cpu_to_le16(*sFrame.pwCapInfo);\r\npMgmt->sNodeDBTable[uNodeIndex].wListenInterval = cpu_to_le16(*sFrame.pwListenInterval);\r\npMgmt->sNodeDBTable[uNodeIndex].bPSEnable =\r\nWLAN_GET_FC_PWRMGT(sFrame.pHdr->sA3.wFrameCtl) ? TRUE : FALSE;\r\nif (pDevice->byBBType == BB_TYPE_11B) {\r\nuRateLen = WLAN_RATES_MAXLEN_11B;\r\n}\r\nabyCurrSuppRates[0] = WLAN_EID_SUPP_RATES;\r\nabyCurrSuppRates[1] = RATEuSetIE((PWLAN_IE_SUPP_RATES)sFrame.pSuppRates,\r\n(PWLAN_IE_SUPP_RATES)abyCurrSuppRates,\r\nuRateLen);\r\nabyCurrExtSuppRates[0] = WLAN_EID_EXTSUPP_RATES;\r\nif (pDevice->byBBType == BB_TYPE_11G) {\r\nabyCurrExtSuppRates[1] = RATEuSetIE((PWLAN_IE_SUPP_RATES)sFrame.pExtSuppRates,\r\n(PWLAN_IE_SUPP_RATES)abyCurrExtSuppRates,\r\nuRateLen);\r\n} else {\r\nabyCurrExtSuppRates[1] = 0;\r\n}\r\nRATEvParseMaxRate((void *)pDevice,\r\n(PWLAN_IE_SUPP_RATES)abyCurrSuppRates,\r\n(PWLAN_IE_SUPP_RATES)abyCurrExtSuppRates,\r\nFALSE,\r\n&(pMgmt->sNodeDBTable[uNodeIndex].wMaxBasicRate),\r\n&(pMgmt->sNodeDBTable[uNodeIndex].wMaxSuppRate),\r\n&(pMgmt->sNodeDBTable[uNodeIndex].wSuppRate),\r\n&(pMgmt->sNodeDBTable[uNodeIndex].byTopCCKBasicRate),\r\n&(pMgmt->sNodeDBTable[uNodeIndex].byTopOFDMBasicRate)\r\n);\r\npMgmt->sNodeDBTable[uNodeIndex].wTxDataRate =\r\npMgmt->sNodeDBTable[uNodeIndex].wMaxSuppRate;\r\npMgmt->sNodeDBTable[uNodeIndex].bShortPreamble =\r\nWLAN_GET_CAP_INFO_SHORTPREAMBLE(*sFrame.pwCapInfo);\r\npMgmt->sNodeDBTable[uNodeIndex].bShortSlotTime =\r\nWLAN_GET_CAP_INFO_SHORTSLOTTIME(*sFrame.pwCapInfo);\r\npMgmt->sNodeDBTable[uNodeIndex].wAID = (WORD)uNodeIndex;\r\nwAssocStatus = WLAN_MGMT_STATUS_SUCCESS;\r\nwAssocAID = (WORD)uNodeIndex;\r\nif(pMgmt->sNodeDBTable[uNodeIndex].wMaxSuppRate > RATE_11M)\r\npMgmt->sNodeDBTable[uNodeIndex].bERPExist = TRUE;\r\nif (pMgmt->sNodeDBTable[uNodeIndex].wMaxSuppRate <= RATE_11M) {\r\npDevice->bProtectMode = TRUE;\r\npDevice->bNonERPPresent = TRUE;\r\n}\r\nif (pMgmt->sNodeDBTable[uNodeIndex].bShortPreamble == FALSE) {\r\npDevice->bBarkerPreambleMd = TRUE;\r\n}\r\nDBG_PRT(MSG_LEVEL_INFO, KERN_INFO "Rx ReAssociate AID= %d \n", wAssocAID);\r\nDBG_PRT(MSG_LEVEL_INFO, KERN_INFO "MAC=%2.2X:%2.2X:%2.2X:%2.2X:%2.2X:%2.2X \n",\r\nsFrame.pHdr->sA3.abyAddr2[0],\r\nsFrame.pHdr->sA3.abyAddr2[1],\r\nsFrame.pHdr->sA3.abyAddr2[2],\r\nsFrame.pHdr->sA3.abyAddr2[3],\r\nsFrame.pHdr->sA3.abyAddr2[4],\r\nsFrame.pHdr->sA3.abyAddr2[5]\r\n) ;\r\nDBG_PRT(MSG_LEVEL_INFO, KERN_INFO "Max Support rate = %d \n",\r\npMgmt->sNodeDBTable[uNodeIndex].wMaxSuppRate);\r\n}\r\npTxPacket = s_MgrMakeReAssocResponse\r\n(\r\npDevice,\r\npMgmt,\r\npMgmt->wCurrCapInfo,\r\nwAssocStatus,\r\nwAssocAID,\r\nsFrame.pHdr->sA3.abyAddr2,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrSuppRates,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrExtSuppRates\r\n);\r\nif (pTxPacket != NULL ){\r\nif (pDevice->bEnableHostapd) {\r\nreturn;\r\n}\r\nStatus = csMgmt_xmit(pDevice, pTxPacket);\r\nif (Status != CMD_STATUS_PENDING) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Mgt:ReAssoc response tx failed\n");\r\n}\r\nelse {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Mgt:ReAssoc response tx sending..\n");\r\n}\r\n}\r\nreturn;\r\n}\r\nstatic\r\nvoid\r\ns_vMgrRxAssocResponse(\r\nPSDevice pDevice,\r\nPSMgmtObject pMgmt,\r\nPSRxMgmtPacket pRxPacket,\r\nBOOL bReAssocType\r\n)\r\n{\r\nWLAN_FR_ASSOCRESP sFrame;\r\nPWLAN_IE_SSID pItemSSID;\r\nPBYTE pbyIEs;\r\nviawget_wpa_header *wpahdr;\r\nif (pMgmt->eCurrState == WMAC_STATE_ASSOCPENDING ||\r\npMgmt->eCurrState == WMAC_STATE_ASSOC) {\r\nsFrame.len = pRxPacket->cbMPDULen;\r\nsFrame.pBuf = (PBYTE)pRxPacket->p80211Header;\r\nvMgrDecodeAssocResponse(&sFrame);\r\nif ((sFrame.pwCapInfo == NULL)\r\n|| (sFrame.pwStatus == NULL)\r\n|| (sFrame.pwAid == NULL)\r\n|| (sFrame.pSuppRates == NULL)) {\r\nDBG_PORT80(0xCC);\r\nreturn;\r\n}\r\npMgmt->sAssocInfo.AssocInfo.ResponseFixedIEs.Capabilities = *(sFrame.pwCapInfo);\r\npMgmt->sAssocInfo.AssocInfo.ResponseFixedIEs.StatusCode = *(sFrame.pwStatus);\r\npMgmt->sAssocInfo.AssocInfo.ResponseFixedIEs.AssociationId = *(sFrame.pwAid);\r\npMgmt->sAssocInfo.AssocInfo.AvailableResponseFixedIEs |= 0x07;\r\npMgmt->sAssocInfo.AssocInfo.ResponseIELength = sFrame.len - 24 - 6;\r\npMgmt->sAssocInfo.AssocInfo.OffsetResponseIEs = pMgmt->sAssocInfo.AssocInfo.OffsetRequestIEs + pMgmt->sAssocInfo.AssocInfo.RequestIELength;\r\npbyIEs = pMgmt->sAssocInfo.abyIEs;\r\npbyIEs += pMgmt->sAssocInfo.AssocInfo.RequestIELength;\r\nmemcpy(pbyIEs, (sFrame.pBuf + 24 +6), pMgmt->sAssocInfo.AssocInfo.ResponseIELength);\r\nif (cpu_to_le16((*(sFrame.pwStatus))) == WLAN_MGMT_STATUS_SUCCESS ){\r\npMgmt->wCurrAID = cpu_to_le16((*(sFrame.pwAid)));\r\nif ( (pMgmt->wCurrAID >> 14) != (BIT0 | BIT1) )\r\n{\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "AID from AP, has two msb clear.\n");\r\n}\r\nDBG_PRT(MSG_LEVEL_INFO, KERN_INFO "Association Successful, AID=%d.\n", pMgmt->wCurrAID & ~(BIT14|BIT15));\r\npMgmt->eCurrState = WMAC_STATE_ASSOC;\r\nBSSvUpdateAPNode((void *) pDevice,\r\nsFrame.pwCapInfo,\r\nsFrame.pSuppRates,\r\nsFrame.pExtSuppRates);\r\npItemSSID = (PWLAN_IE_SSID)pMgmt->abyCurrSSID;\r\nDBG_PRT(MSG_LEVEL_INFO, KERN_INFO "Link with AP(SSID): %s\n", pItemSSID->abySSID);\r\npDevice->bLinkPass = TRUE;\r\nControlvMaskByte(pDevice,MESSAGE_REQUEST_MACREG,MAC_REG_PAPEDELAY,LEDSTS_STS,LEDSTS_INTER);\r\nif ((pDevice->bWPADEVUp) && (pDevice->skb != NULL)) {\r\nif(skb_tailroom(pDevice->skb) <(sizeof(viawget_wpa_header)+pMgmt->sAssocInfo.AssocInfo.ResponseIELength+\r\npMgmt->sAssocInfo.AssocInfo.RequestIELength)) {\r\ndev_kfree_skb(pDevice->skb);\r\npDevice->skb = dev_alloc_skb((int)pDevice->rx_buf_sz);\r\n}\r\nwpahdr = (viawget_wpa_header *)pDevice->skb->data;\r\nwpahdr->type = VIAWGET_ASSOC_MSG;\r\nwpahdr->resp_ie_len = pMgmt->sAssocInfo.AssocInfo.ResponseIELength;\r\nwpahdr->req_ie_len = pMgmt->sAssocInfo.AssocInfo.RequestIELength;\r\nmemcpy(pDevice->skb->data + sizeof(viawget_wpa_header), pMgmt->sAssocInfo.abyIEs, wpahdr->req_ie_len);\r\nmemcpy(pDevice->skb->data + sizeof(viawget_wpa_header) + wpahdr->req_ie_len,\r\npbyIEs,\r\nwpahdr->resp_ie_len\r\n);\r\nskb_put(pDevice->skb, sizeof(viawget_wpa_header) + wpahdr->resp_ie_len + wpahdr->req_ie_len);\r\npDevice->skb->dev = pDevice->wpadev;\r\nskb_reset_mac_header(pDevice->skb);\r\npDevice->skb->pkt_type = PACKET_HOST;\r\npDevice->skb->protocol = htons(ETH_P_802_2);\r\nmemset(pDevice->skb->cb, 0, sizeof(pDevice->skb->cb));\r\nnetif_rx(pDevice->skb);\r\npDevice->skb = dev_alloc_skb((int)pDevice->rx_buf_sz);\r\n}\r\n#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT\r\n{\r\nBYTE buf[512];\r\nsize_t len;\r\nunion iwreq_data wrqu;\r\nint we_event;\r\nmemset(buf, 0, 512);\r\nlen = pMgmt->sAssocInfo.AssocInfo.RequestIELength;\r\nif(len) {\r\nmemcpy(buf, pMgmt->sAssocInfo.abyIEs, len);\r\nmemset(&wrqu, 0, sizeof (wrqu));\r\nwrqu.data.length = len;\r\nwe_event = IWEVASSOCREQIE;\r\nPRINT_K("wireless_send_event--->IWEVASSOCREQIE\n");\r\nwireless_send_event(pDevice->dev, we_event, &wrqu, buf);\r\n}\r\nmemset(buf, 0, 512);\r\nlen = pMgmt->sAssocInfo.AssocInfo.ResponseIELength;\r\nif(len) {\r\nmemcpy(buf, pbyIEs, len);\r\nmemset(&wrqu, 0, sizeof (wrqu));\r\nwrqu.data.length = len;\r\nwe_event = IWEVASSOCRESPIE;\r\nPRINT_K("wireless_send_event--->IWEVASSOCRESPIE\n");\r\nwireless_send_event(pDevice->dev, we_event, &wrqu, buf);\r\n}\r\nmemset(&wrqu, 0, sizeof (wrqu));\r\nmemcpy(wrqu.ap_addr.sa_data, &pMgmt->abyCurrBSSID[0], ETH_ALEN);\r\nwrqu.ap_addr.sa_family = ARPHRD_ETHER;\r\nPRINT_K("wireless_send_event--->SIOCGIWAP(associated)\n");\r\nwireless_send_event(pDevice->dev, SIOCGIWAP, &wrqu, NULL);\r\n}\r\n#endif\r\n}\r\nelse {\r\nif (bReAssocType) {\r\npMgmt->eCurrState = WMAC_STATE_IDLE;\r\n}\r\nelse {\r\npMgmt->eCurrState = WMAC_STATE_AUTH;\r\n}\r\ns_vMgrLogStatus(pMgmt,cpu_to_le16((*(sFrame.pwStatus))));\r\n}\r\n}\r\n#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT\r\npDevice->bwextstep0 = FALSE;\r\npDevice->bwextstep1 = FALSE;\r\npDevice->bwextstep2 = FALSE;\r\npDevice->bwextstep3 = FALSE;\r\npDevice->bWPASuppWextEnabled = FALSE;\r\n#endif\r\nif(pMgmt->eCurrState == WMAC_STATE_ASSOC)\r\ntimer_expire(pDevice->sTimerCommand, 0);\r\nreturn;\r\n}\r\nvoid vMgrAuthenBeginSta(void *hDeviceContext,\r\nPSMgmtObject pMgmt,\r\nPCMD_STATUS pStatus)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nWLAN_FR_AUTHEN sFrame;\r\nPSTxMgmtPacket pTxPacket = NULL;\r\npTxPacket = (PSTxMgmtPacket)pMgmt->pbyMgmtPacketPool;\r\nmemset(pTxPacket, 0, sizeof(STxMgmtPacket) + WLAN_AUTHEN_FR_MAXLEN);\r\npTxPacket->p80211Header = (PUWLAN_80211HDR)((PBYTE)pTxPacket + sizeof(STxMgmtPacket));\r\nsFrame.pBuf = (PBYTE)pTxPacket->p80211Header;\r\nsFrame.len = WLAN_AUTHEN_FR_MAXLEN;\r\nvMgrEncodeAuthen(&sFrame);\r\nsFrame.pHdr->sA3.wFrameCtl = cpu_to_le16(\r\n(\r\nWLAN_SET_FC_FTYPE(WLAN_TYPE_MGR) |\r\nWLAN_SET_FC_FSTYPE(WLAN_FSTYPE_AUTHEN)\r\n));\r\nmemcpy( sFrame.pHdr->sA3.abyAddr1, pMgmt->abyCurrBSSID, WLAN_ADDR_LEN);\r\nmemcpy( sFrame.pHdr->sA3.abyAddr2, pMgmt->abyMACAddr, WLAN_ADDR_LEN);\r\nmemcpy( sFrame.pHdr->sA3.abyAddr3, pMgmt->abyCurrBSSID, WLAN_BSSID_LEN);\r\nif (pMgmt->bShareKeyAlgorithm)\r\n*(sFrame.pwAuthAlgorithm) = cpu_to_le16(WLAN_AUTH_ALG_SHAREDKEY);\r\nelse\r\n*(sFrame.pwAuthAlgorithm) = cpu_to_le16(WLAN_AUTH_ALG_OPENSYSTEM);\r\n*(sFrame.pwAuthSequence) = cpu_to_le16(1);\r\npTxPacket->cbMPDULen = sFrame.len;\r\npTxPacket->cbPayloadLen = sFrame.len - WLAN_HDR_ADDR3_LEN;\r\n*pStatus = csMgmt_xmit(pDevice, pTxPacket);\r\nif (*pStatus == CMD_STATUS_PENDING){\r\npMgmt->eCurrState = WMAC_STATE_AUTHPENDING;\r\n*pStatus = CMD_STATUS_SUCCESS;\r\n}\r\nreturn ;\r\n}\r\nvoid vMgrDeAuthenBeginSta(void *hDeviceContext,\r\nPSMgmtObject pMgmt,\r\nPBYTE abyDestAddress,\r\nWORD wReason,\r\nPCMD_STATUS pStatus)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nWLAN_FR_DEAUTHEN sFrame;\r\nPSTxMgmtPacket pTxPacket = NULL;\r\npTxPacket = (PSTxMgmtPacket)pMgmt->pbyMgmtPacketPool;\r\nmemset(pTxPacket, 0, sizeof(STxMgmtPacket) + WLAN_DEAUTHEN_FR_MAXLEN);\r\npTxPacket->p80211Header = (PUWLAN_80211HDR)((PBYTE)pTxPacket + sizeof(STxMgmtPacket));\r\nsFrame.pBuf = (PBYTE)pTxPacket->p80211Header;\r\nsFrame.len = WLAN_DEAUTHEN_FR_MAXLEN;\r\nvMgrEncodeDeauthen(&sFrame);\r\nsFrame.pHdr->sA3.wFrameCtl = cpu_to_le16(\r\n(\r\nWLAN_SET_FC_FTYPE(WLAN_TYPE_MGR) |\r\nWLAN_SET_FC_FSTYPE(WLAN_FSTYPE_DEAUTHEN)\r\n));\r\nmemcpy( sFrame.pHdr->sA3.abyAddr1, abyDestAddress, WLAN_ADDR_LEN);\r\nmemcpy( sFrame.pHdr->sA3.abyAddr2, pMgmt->abyMACAddr, WLAN_ADDR_LEN);\r\nmemcpy( sFrame.pHdr->sA3.abyAddr3, pMgmt->abyCurrBSSID, WLAN_BSSID_LEN);\r\n*(sFrame.pwReason) = cpu_to_le16(wReason);\r\npTxPacket->cbMPDULen = sFrame.len;\r\npTxPacket->cbPayloadLen = sFrame.len - WLAN_HDR_ADDR3_LEN;\r\n*pStatus = csMgmt_xmit(pDevice, pTxPacket);\r\nif (*pStatus == CMD_STATUS_PENDING){\r\n*pStatus = CMD_STATUS_SUCCESS;\r\n}\r\nreturn ;\r\n}\r\nstatic\r\nvoid\r\ns_vMgrRxAuthentication(\r\nPSDevice pDevice,\r\nPSMgmtObject pMgmt,\r\nPSRxMgmtPacket pRxPacket\r\n)\r\n{\r\nWLAN_FR_AUTHEN sFrame;\r\nif (!(pMgmt->eCurrMode == WMAC_MODE_ESS_AP ||\r\npMgmt->eCurrState == WMAC_STATE_AUTHPENDING)) {\r\nreturn;\r\n}\r\nsFrame.len = pRxPacket->cbMPDULen;\r\nsFrame.pBuf = (PBYTE)pRxPacket->p80211Header;\r\nvMgrDecodeAuthen(&sFrame);\r\nswitch (cpu_to_le16((*(sFrame.pwAuthSequence )))){\r\ncase 1:\r\ns_vMgrRxAuthenSequence_1(pDevice,pMgmt, &sFrame);\r\nbreak;\r\ncase 2:\r\ns_vMgrRxAuthenSequence_2(pDevice, pMgmt, &sFrame);\r\nbreak;\r\ncase 3:\r\ns_vMgrRxAuthenSequence_3(pDevice, pMgmt, &sFrame);\r\nbreak;\r\ncase 4:\r\ns_vMgrRxAuthenSequence_4(pDevice, pMgmt, &sFrame);\r\nbreak;\r\ndefault:\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Auth Sequence error, seq = %d\n",\r\ncpu_to_le16((*(sFrame.pwAuthSequence))));\r\nbreak;\r\n}\r\nreturn;\r\n}\r\nstatic\r\nvoid\r\ns_vMgrRxAuthenSequence_1(\r\nPSDevice pDevice,\r\nPSMgmtObject pMgmt,\r\nPWLAN_FR_AUTHEN pFrame\r\n)\r\n{\r\nPSTxMgmtPacket pTxPacket = NULL;\r\nunsigned int uNodeIndex;\r\nWLAN_FR_AUTHEN sFrame;\r\nPSKeyItem pTransmitKey;\r\nif (!BSSbIsSTAInNodeDB(pDevice, pFrame->pHdr->sA3.abyAddr2, &uNodeIndex)) {\r\nBSSvCreateOneNode((PSDevice)pDevice, &uNodeIndex);\r\nmemcpy(pMgmt->sNodeDBTable[uNodeIndex].abyMACAddr, pFrame->pHdr->sA3.abyAddr2,\r\nWLAN_ADDR_LEN);\r\n}\r\nif (pMgmt->bShareKeyAlgorithm) {\r\npMgmt->sNodeDBTable[uNodeIndex].eNodeState = NODE_KNOWN;\r\npMgmt->sNodeDBTable[uNodeIndex].byAuthSequence = 1;\r\n}\r\nelse {\r\npMgmt->sNodeDBTable[uNodeIndex].eNodeState = NODE_AUTH;\r\n}\r\npTxPacket = (PSTxMgmtPacket)pMgmt->pbyMgmtPacketPool;\r\nmemset(pTxPacket, 0, sizeof(STxMgmtPacket) + WLAN_AUTHEN_FR_MAXLEN);\r\npTxPacket->p80211Header = (PUWLAN_80211HDR)((PBYTE)pTxPacket + sizeof(STxMgmtPacket));\r\nsFrame.pBuf = (PBYTE)pTxPacket->p80211Header;\r\nsFrame.len = WLAN_AUTHEN_FR_MAXLEN;\r\nvMgrEncodeAuthen(&sFrame);\r\nsFrame.pHdr->sA3.wFrameCtl = cpu_to_le16(\r\n(\r\nWLAN_SET_FC_FTYPE(WLAN_TYPE_MGR) |\r\nWLAN_SET_FC_FSTYPE(WLAN_FSTYPE_AUTHEN)|\r\nWLAN_SET_FC_ISWEP(0)\r\n));\r\nmemcpy( sFrame.pHdr->sA3.abyAddr1, pFrame->pHdr->sA3.abyAddr2, WLAN_ADDR_LEN);\r\nmemcpy( sFrame.pHdr->sA3.abyAddr2, pMgmt->abyMACAddr, WLAN_ADDR_LEN);\r\nmemcpy( sFrame.pHdr->sA3.abyAddr3, pMgmt->abyCurrBSSID, WLAN_BSSID_LEN);\r\n*(sFrame.pwAuthAlgorithm) = *(pFrame->pwAuthAlgorithm);\r\n*(sFrame.pwAuthSequence) = cpu_to_le16(2);\r\nif (cpu_to_le16(*(pFrame->pwAuthAlgorithm)) == WLAN_AUTH_ALG_SHAREDKEY) {\r\nif (pMgmt->bShareKeyAlgorithm)\r\n*(sFrame.pwStatus) = cpu_to_le16(WLAN_MGMT_STATUS_SUCCESS);\r\nelse\r\n*(sFrame.pwStatus) = cpu_to_le16(WLAN_MGMT_STATUS_UNSUPPORTED_AUTHALG);\r\n}\r\nelse {\r\nif (pMgmt->bShareKeyAlgorithm)\r\n*(sFrame.pwStatus) = cpu_to_le16(WLAN_MGMT_STATUS_UNSUPPORTED_AUTHALG);\r\nelse\r\n*(sFrame.pwStatus) = cpu_to_le16(WLAN_MGMT_STATUS_SUCCESS);\r\n}\r\nif (pMgmt->bShareKeyAlgorithm &&\r\n(cpu_to_le16(*(sFrame.pwStatus)) == WLAN_MGMT_STATUS_SUCCESS)) {\r\nsFrame.pChallenge = (PWLAN_IE_CHALLENGE)(sFrame.pBuf + sFrame.len);\r\nsFrame.len += WLAN_CHALLENGE_IE_LEN;\r\nsFrame.pChallenge->byElementID = WLAN_EID_CHALLENGE;\r\nsFrame.pChallenge->len = WLAN_CHALLENGE_LEN;\r\nmemset(pMgmt->abyChallenge, 0, WLAN_CHALLENGE_LEN);\r\nif(KeybGetTransmitKey(&(pDevice->sKey), pDevice->abyBroadcastAddr, GROUP_KEY, &pTransmitKey) == TRUE) {\r\nrc4_init(&pDevice->SBox, pDevice->abyPRNG, pTransmitKey->uKeyLength+3);\r\nrc4_encrypt(&pDevice->SBox, pMgmt->abyChallenge, pMgmt->abyChallenge, WLAN_CHALLENGE_LEN);\r\n}\r\nmemcpy(sFrame.pChallenge->abyChallenge, pMgmt->abyChallenge , WLAN_CHALLENGE_LEN);\r\n}\r\npTxPacket->cbMPDULen = sFrame.len;\r\npTxPacket->cbPayloadLen = sFrame.len - WLAN_HDR_ADDR3_LEN;\r\nif (pDevice->bEnableHostapd) {\r\nreturn;\r\n}\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Mgt:Authreq_reply sequence_1 tx.. \n");\r\nif (csMgmt_xmit(pDevice, pTxPacket) != CMD_STATUS_PENDING) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Mgt:Authreq_reply sequence_1 tx failed.\n");\r\n}\r\nreturn;\r\n}\r\nstatic\r\nvoid\r\ns_vMgrRxAuthenSequence_2(\r\nPSDevice pDevice,\r\nPSMgmtObject pMgmt,\r\nPWLAN_FR_AUTHEN pFrame\r\n)\r\n{\r\nWLAN_FR_AUTHEN sFrame;\r\nPSTxMgmtPacket pTxPacket = NULL;\r\nswitch (cpu_to_le16((*(pFrame->pwAuthAlgorithm))))\r\n{\r\ncase WLAN_AUTH_ALG_OPENSYSTEM:\r\nif ( cpu_to_le16((*(pFrame->pwStatus))) == WLAN_MGMT_STATUS_SUCCESS ){\r\nDBG_PRT(MSG_LEVEL_INFO, KERN_INFO "802.11 Authen (OPEN) Successful.\n");\r\npMgmt->eCurrState = WMAC_STATE_AUTH;\r\ntimer_expire(pDevice->sTimerCommand, 0);\r\n}\r\nelse {\r\nDBG_PRT(MSG_LEVEL_INFO, KERN_INFO "802.11 Authen (OPEN) Failed.\n");\r\ns_vMgrLogStatus(pMgmt, cpu_to_le16((*(pFrame->pwStatus))));\r\npMgmt->eCurrState = WMAC_STATE_IDLE;\r\n}\r\nif (pDevice->eCommandState == WLAN_AUTHENTICATE_WAIT) {\r\n}\r\nbreak;\r\ncase WLAN_AUTH_ALG_SHAREDKEY:\r\nif (cpu_to_le16((*(pFrame->pwStatus))) == WLAN_MGMT_STATUS_SUCCESS) {\r\npTxPacket = (PSTxMgmtPacket)pMgmt->pbyMgmtPacketPool;\r\nmemset(pTxPacket, 0, sizeof(STxMgmtPacket) + WLAN_AUTHEN_FR_MAXLEN);\r\npTxPacket->p80211Header = (PUWLAN_80211HDR)((PBYTE)pTxPacket + sizeof(STxMgmtPacket));\r\nsFrame.pBuf = (PBYTE)pTxPacket->p80211Header;\r\nsFrame.len = WLAN_AUTHEN_FR_MAXLEN;\r\nvMgrEncodeAuthen(&sFrame);\r\nsFrame.pHdr->sA3.wFrameCtl = cpu_to_le16(\r\n(\r\nWLAN_SET_FC_FTYPE(WLAN_TYPE_MGR) |\r\nWLAN_SET_FC_FSTYPE(WLAN_FSTYPE_AUTHEN)|\r\nWLAN_SET_FC_ISWEP(1)\r\n));\r\nmemcpy( sFrame.pHdr->sA3.abyAddr1, pMgmt->abyCurrBSSID, WLAN_BSSID_LEN);\r\nmemcpy( sFrame.pHdr->sA3.abyAddr2, pMgmt->abyMACAddr, WLAN_ADDR_LEN);\r\nmemcpy( sFrame.pHdr->sA3.abyAddr3, pMgmt->abyCurrBSSID, WLAN_BSSID_LEN);\r\n*(sFrame.pwAuthAlgorithm) = *(pFrame->pwAuthAlgorithm);\r\n*(sFrame.pwAuthSequence) = cpu_to_le16(3);\r\n*(sFrame.pwStatus) = cpu_to_le16(WLAN_MGMT_STATUS_SUCCESS);\r\nsFrame.pChallenge = (PWLAN_IE_CHALLENGE)(sFrame.pBuf + sFrame.len);\r\nsFrame.len += WLAN_CHALLENGE_IE_LEN;\r\nsFrame.pChallenge->byElementID = WLAN_EID_CHALLENGE;\r\nsFrame.pChallenge->len = WLAN_CHALLENGE_LEN;\r\nmemcpy( sFrame.pChallenge->abyChallenge, pFrame->pChallenge->abyChallenge, WLAN_CHALLENGE_LEN);\r\npTxPacket->cbMPDULen = sFrame.len;\r\npTxPacket->cbPayloadLen = sFrame.len - WLAN_HDR_ADDR3_LEN;\r\nif (csMgmt_xmit(pDevice, pTxPacket) != CMD_STATUS_PENDING) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Mgt:Auth_reply sequence_2 tx failed.\n");\r\n}\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Mgt:Auth_reply sequence_2 tx ...\n");\r\n}\r\nelse {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Mgt:rx Auth_reply sequence_2 status error ...\n");\r\nif ( pDevice->eCommandState == WLAN_AUTHENTICATE_WAIT ) {\r\n}\r\ns_vMgrLogStatus(pMgmt, cpu_to_le16((*(pFrame->pwStatus))));\r\n}\r\nbreak;\r\ndefault:\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Mgt: rx auth.seq = 2 unknown AuthAlgorithm=%d\n", cpu_to_le16((*(pFrame->pwAuthAlgorithm))));\r\nbreak;\r\n}\r\nreturn;\r\n}\r\nstatic\r\nvoid\r\ns_vMgrRxAuthenSequence_3(\r\nPSDevice pDevice,\r\nPSMgmtObject pMgmt,\r\nPWLAN_FR_AUTHEN pFrame\r\n)\r\n{\r\nPSTxMgmtPacket pTxPacket = NULL;\r\nunsigned int uStatusCode = 0 ;\r\nunsigned int uNodeIndex = 0;\r\nWLAN_FR_AUTHEN sFrame;\r\nif (!WLAN_GET_FC_ISWEP(pFrame->pHdr->sA3.wFrameCtl)) {\r\nuStatusCode = WLAN_MGMT_STATUS_CHALLENGE_FAIL;\r\ngoto reply;\r\n}\r\nif (BSSbIsSTAInNodeDB(pDevice, pFrame->pHdr->sA3.abyAddr2, &uNodeIndex)) {\r\nif (pMgmt->sNodeDBTable[uNodeIndex].byAuthSequence != 1) {\r\nuStatusCode = WLAN_MGMT_STATUS_RX_AUTH_NOSEQ;\r\ngoto reply;\r\n}\r\nif (memcmp(pMgmt->abyChallenge, pFrame->pChallenge->abyChallenge, WLAN_CHALLENGE_LEN) != 0) {\r\nuStatusCode = WLAN_MGMT_STATUS_CHALLENGE_FAIL;\r\ngoto reply;\r\n}\r\n}\r\nelse {\r\nuStatusCode = WLAN_MGMT_STATUS_UNSPEC_FAILURE;\r\ngoto reply;\r\n}\r\nif (uNodeIndex) {\r\npMgmt->sNodeDBTable[uNodeIndex].eNodeState = NODE_AUTH;\r\npMgmt->sNodeDBTable[uNodeIndex].byAuthSequence = 0;\r\n}\r\nuStatusCode = WLAN_MGMT_STATUS_SUCCESS;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Challenge text check ok..\n");\r\nreply:\r\npTxPacket = (PSTxMgmtPacket)pMgmt->pbyMgmtPacketPool;\r\nmemset(pTxPacket, 0, sizeof(STxMgmtPacket) + WLAN_AUTHEN_FR_MAXLEN);\r\npTxPacket->p80211Header = (PUWLAN_80211HDR)((PBYTE)pTxPacket + sizeof(STxMgmtPacket));\r\nsFrame.pBuf = (PBYTE)pTxPacket->p80211Header;\r\nsFrame.len = WLAN_AUTHEN_FR_MAXLEN;\r\nvMgrEncodeAuthen(&sFrame);\r\nsFrame.pHdr->sA3.wFrameCtl = cpu_to_le16(\r\n(\r\nWLAN_SET_FC_FTYPE(WLAN_TYPE_MGR) |\r\nWLAN_SET_FC_FSTYPE(WLAN_FSTYPE_AUTHEN)|\r\nWLAN_SET_FC_ISWEP(0)\r\n));\r\nmemcpy( sFrame.pHdr->sA3.abyAddr1, pFrame->pHdr->sA3.abyAddr2, WLAN_ADDR_LEN);\r\nmemcpy( sFrame.pHdr->sA3.abyAddr2, pMgmt->abyMACAddr, WLAN_ADDR_LEN);\r\nmemcpy( sFrame.pHdr->sA3.abyAddr3, pMgmt->abyCurrBSSID, WLAN_BSSID_LEN);\r\n*(sFrame.pwAuthAlgorithm) = *(pFrame->pwAuthAlgorithm);\r\n*(sFrame.pwAuthSequence) = cpu_to_le16(4);\r\n*(sFrame.pwStatus) = cpu_to_le16(uStatusCode);\r\npTxPacket->cbMPDULen = sFrame.len;\r\npTxPacket->cbPayloadLen = sFrame.len - WLAN_HDR_ADDR3_LEN;\r\nif (pDevice->bEnableHostapd) {\r\nreturn;\r\n}\r\nif (csMgmt_xmit(pDevice, pTxPacket) != CMD_STATUS_PENDING) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Mgt:Authreq_reply sequence_4 tx failed.\n");\r\n}\r\nreturn;\r\n}\r\nstatic\r\nvoid\r\ns_vMgrRxAuthenSequence_4(\r\nPSDevice pDevice,\r\nPSMgmtObject pMgmt,\r\nPWLAN_FR_AUTHEN pFrame\r\n)\r\n{\r\nif ( cpu_to_le16((*(pFrame->pwStatus))) == WLAN_MGMT_STATUS_SUCCESS ){\r\nDBG_PRT(MSG_LEVEL_INFO, KERN_INFO "802.11 Authen (SHAREDKEY) Successful.\n");\r\npMgmt->eCurrState = WMAC_STATE_AUTH;\r\ntimer_expire(pDevice->sTimerCommand, 0);\r\n}\r\nelse{\r\nDBG_PRT(MSG_LEVEL_INFO, KERN_INFO "802.11 Authen (SHAREDKEY) Failed.\n");\r\ns_vMgrLogStatus(pMgmt, cpu_to_le16((*(pFrame->pwStatus))) );\r\npMgmt->eCurrState = WMAC_STATE_IDLE;\r\n}\r\nif ( pDevice->eCommandState == WLAN_AUTHENTICATE_WAIT ) {\r\n}\r\n}\r\nstatic\r\nvoid\r\ns_vMgrRxDisassociation(\r\nPSDevice pDevice,\r\nPSMgmtObject pMgmt,\r\nPSRxMgmtPacket pRxPacket\r\n)\r\n{\r\nWLAN_FR_DISASSOC sFrame;\r\nunsigned int uNodeIndex = 0;\r\nCMD_STATUS CmdStatus;\r\nviawget_wpa_header *wpahdr;\r\nif ( pMgmt->eCurrMode == WMAC_MODE_ESS_AP ){\r\nsFrame.len = pRxPacket->cbMPDULen;\r\nsFrame.pBuf = (PBYTE)pRxPacket->p80211Header;\r\nif (BSSbIsSTAInNodeDB(pDevice, pRxPacket->p80211Header->sA3.abyAddr2, &uNodeIndex)) {\r\nBSSvRemoveOneNode(pDevice, uNodeIndex);\r\n}\r\nelse {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Rx disassoc, sta not found\n");\r\n}\r\n}\r\nelse if (pMgmt->eCurrMode == WMAC_MODE_ESS_STA ){\r\nsFrame.len = pRxPacket->cbMPDULen;\r\nsFrame.pBuf = (PBYTE)pRxPacket->p80211Header;\r\nvMgrDecodeDisassociation(&sFrame);\r\nDBG_PRT(MSG_LEVEL_NOTICE, KERN_INFO "AP disassociated me, reason=%d.\n", cpu_to_le16(*(sFrame.pwReason)));\r\npDevice->fWPA_Authened = FALSE;\r\nif ((pDevice->bWPADEVUp) && (pDevice->skb != NULL)) {\r\nwpahdr = (viawget_wpa_header *)pDevice->skb->data;\r\nwpahdr->type = VIAWGET_DISASSOC_MSG;\r\nwpahdr->resp_ie_len = 0;\r\nwpahdr->req_ie_len = 0;\r\nskb_put(pDevice->skb, sizeof(viawget_wpa_header));\r\npDevice->skb->dev = pDevice->wpadev;\r\nskb_reset_mac_header(pDevice->skb);\r\npDevice->skb->pkt_type = PACKET_HOST;\r\npDevice->skb->protocol = htons(ETH_P_802_2);\r\nmemset(pDevice->skb->cb, 0, sizeof(pDevice->skb->cb));\r\nnetif_rx(pDevice->skb);\r\npDevice->skb = dev_alloc_skb((int)pDevice->rx_buf_sz);\r\n}\r\nif (pMgmt->eCurrState == WMAC_STATE_ASSOC) {\r\npDevice->bLinkPass = FALSE;\r\npMgmt->sNodeDBTable[0].bActive = FALSE;\r\npDevice->byReAssocCount = 0;\r\npMgmt->eCurrState = WMAC_STATE_AUTH;\r\npDevice->eCommandState = WLAN_ASSOCIATE_WAIT;\r\nvMgrReAssocBeginSta((PSDevice)pDevice, pMgmt, &CmdStatus);\r\nif(CmdStatus == CMD_STATUS_PENDING) {\r\npDevice->byReAssocCount ++;\r\nreturn;\r\n}\r\n}\r\n#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT\r\n{\r\nunion iwreq_data wrqu;\r\nmemset(&wrqu, 0, sizeof (wrqu));\r\nwrqu.ap_addr.sa_family = ARPHRD_ETHER;\r\nPRINT_K("wireless_send_event--->SIOCGIWAP(disassociated)\n");\r\nwireless_send_event(pDevice->dev, SIOCGIWAP, &wrqu, NULL);\r\n}\r\n#endif\r\n}\r\nreturn;\r\n}\r\nstatic\r\nvoid\r\ns_vMgrRxDeauthentication(\r\nPSDevice pDevice,\r\nPSMgmtObject pMgmt,\r\nPSRxMgmtPacket pRxPacket\r\n)\r\n{\r\nWLAN_FR_DEAUTHEN sFrame;\r\nunsigned int uNodeIndex = 0;\r\nviawget_wpa_header *wpahdr;\r\nif (pMgmt->eCurrMode == WMAC_MODE_ESS_AP ){\r\nsFrame.len = pRxPacket->cbMPDULen;\r\nsFrame.pBuf = (PBYTE)pRxPacket->p80211Header;\r\nif (BSSbIsSTAInNodeDB(pDevice, pRxPacket->p80211Header->sA3.abyAddr2, &uNodeIndex)) {\r\nBSSvRemoveOneNode(pDevice, uNodeIndex);\r\n}\r\nelse {\r\nDBG_PRT(MSG_LEVEL_NOTICE, KERN_INFO "Rx deauth, sta not found\n");\r\n}\r\n}\r\nelse {\r\nif (pMgmt->eCurrMode == WMAC_MODE_ESS_STA ) {\r\nsFrame.len = pRxPacket->cbMPDULen;\r\nsFrame.pBuf = (PBYTE)pRxPacket->p80211Header;\r\nvMgrDecodeDeauthen(&sFrame);\r\npDevice->fWPA_Authened = FALSE;\r\nDBG_PRT(MSG_LEVEL_NOTICE, KERN_INFO "AP deauthed me, reason=%d.\n", cpu_to_le16((*(sFrame.pwReason))));\r\nif (!compare_ether_addr(sFrame.pHdr->sA3.abyAddr3,\r\npMgmt->abyCurrBSSID)) {\r\nif (pMgmt->eCurrState >= WMAC_STATE_AUTHPENDING) {\r\npMgmt->sNodeDBTable[0].bActive = FALSE;\r\npMgmt->eCurrMode = WMAC_MODE_STANDBY;\r\npMgmt->eCurrState = WMAC_STATE_IDLE;\r\nnetif_stop_queue(pDevice->dev);\r\npDevice->bLinkPass = FALSE;\r\nControlvMaskByte(pDevice,MESSAGE_REQUEST_MACREG,MAC_REG_PAPEDELAY,LEDSTS_STS,LEDSTS_SLOW);\r\n}\r\n}\r\nif ((pDevice->bWPADEVUp) && (pDevice->skb != NULL)) {\r\nwpahdr = (viawget_wpa_header *)pDevice->skb->data;\r\nwpahdr->type = VIAWGET_DISASSOC_MSG;\r\nwpahdr->resp_ie_len = 0;\r\nwpahdr->req_ie_len = 0;\r\nskb_put(pDevice->skb, sizeof(viawget_wpa_header));\r\npDevice->skb->dev = pDevice->wpadev;\r\nskb_reset_mac_header(pDevice->skb);\r\npDevice->skb->pkt_type = PACKET_HOST;\r\npDevice->skb->protocol = htons(ETH_P_802_2);\r\nmemset(pDevice->skb->cb, 0, sizeof(pDevice->skb->cb));\r\nnetif_rx(pDevice->skb);\r\npDevice->skb = dev_alloc_skb((int)pDevice->rx_buf_sz);\r\n}\r\n#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT\r\n{\r\nunion iwreq_data wrqu;\r\nmemset(&wrqu, 0, sizeof (wrqu));\r\nwrqu.ap_addr.sa_family = ARPHRD_ETHER;\r\nPRINT_K("wireless_send_event--->SIOCGIWAP(disauthen)\n");\r\nwireless_send_event(pDevice->dev, SIOCGIWAP, &wrqu, NULL);\r\n}\r\n#endif\r\n}\r\n};\r\nreturn;\r\n}\r\nstatic BOOL\r\nChannelExceedZoneType(\r\nPSDevice pDevice,\r\nBYTE byCurrChannel\r\n)\r\n{\r\nBOOL exceed=FALSE;\r\nswitch(pDevice->byZoneType) {\r\ncase 0x00:\r\nif((byCurrChannel<1) ||(byCurrChannel>11))\r\nexceed = TRUE;\r\nbreak;\r\ncase 0x01:\r\ncase 0x02:\r\nif((byCurrChannel<1) ||(byCurrChannel>13))\r\nexceed = TRUE;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn exceed;\r\n}\r\nstatic\r\nvoid\r\ns_vMgrRxBeacon(\r\nPSDevice pDevice,\r\nPSMgmtObject pMgmt,\r\nPSRxMgmtPacket pRxPacket,\r\nBOOL bInScan\r\n)\r\n{\r\nPKnownBSS pBSSList;\r\nWLAN_FR_BEACON sFrame;\r\nQWORD qwTSFOffset;\r\nBOOL bIsBSSIDEqual = FALSE;\r\nBOOL bIsSSIDEqual = FALSE;\r\nBOOL bTSFLargeDiff = FALSE;\r\nBOOL bTSFOffsetPostive = FALSE;\r\nBOOL bUpdateTSF = FALSE;\r\nBOOL bIsAPBeacon = FALSE;\r\nBOOL bIsChannelEqual = FALSE;\r\nunsigned int uLocateByteIndex;\r\nBYTE byTIMBitOn = 0;\r\nWORD wAIDNumber = 0;\r\nunsigned int uNodeIndex;\r\nQWORD qwTimestamp, qwLocalTSF;\r\nQWORD qwCurrTSF;\r\nWORD wStartIndex = 0;\r\nWORD wAIDIndex = 0;\r\nBYTE byCurrChannel = pRxPacket->byRxChannel;\r\nERPObject sERP;\r\nunsigned int uRateLen = WLAN_RATES_MAXLEN;\r\nBOOL bChannelHit = FALSE;\r\nBYTE byOldPreambleType;\r\nif (pMgmt->eCurrMode == WMAC_MODE_ESS_AP)\r\nreturn;\r\nmemset(&sFrame, 0, sizeof(WLAN_FR_BEACON));\r\nsFrame.len = pRxPacket->cbMPDULen;\r\nsFrame.pBuf = (PBYTE)pRxPacket->p80211Header;\r\nvMgrDecodeBeacon(&sFrame);\r\nif ((sFrame.pwBeaconInterval == NULL)\r\n|| (sFrame.pwCapInfo == NULL)\r\n|| (sFrame.pSSID == NULL)\r\n|| (sFrame.pSuppRates == NULL)) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Rx beacon frame error\n");\r\nreturn;\r\n}\r\nif( byCurrChannel > CB_MAX_CHANNEL_24G )\r\n{\r\nif (sFrame.pDSParms != NULL) {\r\nif (byCurrChannel == RFaby11aChannelIndex[sFrame.pDSParms->byCurrChannel-1])\r\nbChannelHit = TRUE;\r\nbyCurrChannel = RFaby11aChannelIndex[sFrame.pDSParms->byCurrChannel-1];\r\n} else {\r\nbChannelHit = TRUE;\r\n}\r\n} else {\r\nif (sFrame.pDSParms != NULL) {\r\nif (byCurrChannel == sFrame.pDSParms->byCurrChannel)\r\nbChannelHit = TRUE;\r\nbyCurrChannel = sFrame.pDSParms->byCurrChannel;\r\n} else {\r\nbChannelHit = TRUE;\r\n}\r\n}\r\nif(ChannelExceedZoneType(pDevice,byCurrChannel)==TRUE)\r\nreturn;\r\nif (sFrame.pERP != NULL) {\r\nsERP.byERP = sFrame.pERP->byContext;\r\nsERP.bERPExist = TRUE;\r\n} else {\r\nsERP.bERPExist = FALSE;\r\nsERP.byERP = 0;\r\n}\r\npBSSList = BSSpAddrIsInBSSList((void *) pDevice,\r\nsFrame.pHdr->sA3.abyAddr3,\r\nsFrame.pSSID);\r\nif (pBSSList == NULL) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"Beacon/insert: RxChannel = : %d\n", byCurrChannel);\r\nBSSbInsertToBSSList((void *) pDevice,\r\nsFrame.pHdr->sA3.abyAddr3,\r\n*sFrame.pqwTimestamp,\r\n*sFrame.pwBeaconInterval,\r\n*sFrame.pwCapInfo,\r\nbyCurrChannel,\r\nsFrame.pSSID,\r\nsFrame.pSuppRates,\r\nsFrame.pExtSuppRates,\r\n&sERP,\r\nsFrame.pRSN,\r\nsFrame.pRSNWPA,\r\nsFrame.pIE_Country,\r\nsFrame.pIE_Quiet,\r\nsFrame.len - WLAN_HDR_ADDR3_LEN,\r\nsFrame.pHdr->sA4.abyAddr4,\r\n(void *) pRxPacket);\r\n}\r\nelse {\r\nBSSbUpdateToBSSList((void *) pDevice,\r\n*sFrame.pqwTimestamp,\r\n*sFrame.pwBeaconInterval,\r\n*sFrame.pwCapInfo,\r\nbyCurrChannel,\r\nbChannelHit,\r\nsFrame.pSSID,\r\nsFrame.pSuppRates,\r\nsFrame.pExtSuppRates,\r\n&sERP,\r\nsFrame.pRSN,\r\nsFrame.pRSNWPA,\r\nsFrame.pIE_Country,\r\nsFrame.pIE_Quiet,\r\npBSSList,\r\nsFrame.len - WLAN_HDR_ADDR3_LEN,\r\nsFrame.pHdr->sA4.abyAddr4,\r\n(void *) pRxPacket);\r\n}\r\nif (bInScan) {\r\nreturn;\r\n}\r\nif(byCurrChannel == (BYTE)pMgmt->uCurrChannel)\r\nbIsChannelEqual = TRUE;\r\nif (bIsChannelEqual && (pMgmt->eCurrMode == WMAC_MODE_ESS_AP)) {\r\nif (sERP.bERPExist) {\r\nif (WLAN_GET_ERP_USE_PROTECTION(sERP.byERP)){\r\npDevice->byERPFlag |= WLAN_SET_ERP_USE_PROTECTION(1);\r\npDevice->wUseProtectCntDown = USE_PROTECT_PERIOD;\r\n}\r\n}\r\nelse {\r\npDevice->byERPFlag |= WLAN_SET_ERP_USE_PROTECTION(1);\r\npDevice->wUseProtectCntDown = USE_PROTECT_PERIOD;\r\n}\r\nif (pMgmt->eCurrMode == WMAC_MODE_IBSS_STA) {\r\nif(!WLAN_GET_CAP_INFO_SHORTPREAMBLE(*sFrame.pwCapInfo))\r\npDevice->byERPFlag |= WLAN_SET_ERP_BARKER_MODE(1);\r\nif(!sERP.bERPExist)\r\npDevice->byERPFlag |= WLAN_SET_ERP_NONERP_PRESENT(1);\r\n}\r\n}\r\nif (memcmp(sFrame.pHdr->sA3.abyAddr3,\r\npMgmt->abyCurrBSSID,\r\nWLAN_BSSID_LEN) == 0) {\r\nbIsBSSIDEqual = TRUE;\r\npDevice->uCurrRSSI = pRxPacket->uRSSI;\r\npDevice->byCurrSQ = pRxPacket->bySQ;\r\nif (pMgmt->sNodeDBTable[0].uInActiveCount != 0) {\r\npMgmt->sNodeDBTable[0].uInActiveCount = 0;\r\n}\r\n}\r\nif (sFrame.pSSID->len == ((PWLAN_IE_SSID)pMgmt->abyCurrSSID)->len) {\r\nif (memcmp(sFrame.pSSID->abySSID,\r\n((PWLAN_IE_SSID)pMgmt->abyCurrSSID)->abySSID,\r\nsFrame.pSSID->len\r\n) == 0) {\r\nbIsSSIDEqual = TRUE;\r\n}\r\n}\r\nif ((WLAN_GET_CAP_INFO_ESS(*sFrame.pwCapInfo)== TRUE) &&\r\n(bIsBSSIDEqual == TRUE) &&\r\n(bIsSSIDEqual == TRUE) &&\r\n(pMgmt->eCurrMode == WMAC_MODE_ESS_STA) &&\r\n(pMgmt->eCurrState == WMAC_STATE_ASSOC)) {\r\nbIsAPBeacon = TRUE;\r\nif (pBSSList != NULL) {\r\nif ((pBSSList->sERP.bERPExist == TRUE) && (pDevice->byBBType == BB_TYPE_11G)) {\r\nif ((pBSSList->sERP.byERP & WLAN_EID_ERP_USE_PROTECTION) != pDevice->bProtectMode) {\r\npDevice->bProtectMode = (pBSSList->sERP.byERP & WLAN_EID_ERP_USE_PROTECTION);\r\nif (pDevice->bProtectMode) {\r\nMACvEnableProtectMD(pDevice);\r\n} else {\r\nMACvDisableProtectMD(pDevice);\r\n}\r\nvUpdateIFS(pDevice);\r\n}\r\nif ((pBSSList->sERP.byERP & WLAN_EID_ERP_NONERP_PRESENT) != pDevice->bNonERPPresent) {\r\npDevice->bNonERPPresent = (pBSSList->sERP.byERP & WLAN_EID_ERP_USE_PROTECTION);\r\n}\r\nif ((pBSSList->sERP.byERP & WLAN_EID_ERP_BARKER_MODE) != pDevice->bBarkerPreambleMd) {\r\npDevice->bBarkerPreambleMd = (pBSSList->sERP.byERP & WLAN_EID_ERP_BARKER_MODE);\r\nif (pDevice->bBarkerPreambleMd) {\r\nMACvEnableBarkerPreambleMd(pDevice);\r\n} else {\r\nMACvDisableBarkerPreambleMd(pDevice);\r\n}\r\n}\r\n}\r\nif (WLAN_GET_CAP_INFO_SHORTSLOTTIME(pBSSList->wCapInfo) != pDevice->bShortSlotTime) {\r\nBOOL bShortSlotTime;\r\nbShortSlotTime = WLAN_GET_CAP_INFO_SHORTSLOTTIME(pBSSList->wCapInfo);\r\nif (pDevice->byBBType == BB_TYPE_11A) {\r\nbShortSlotTime = TRUE;\r\n}\r\nelse if (pDevice->byBBType == BB_TYPE_11B) {\r\nbShortSlotTime = FALSE;\r\n}\r\nif (bShortSlotTime != pDevice->bShortSlotTime) {\r\npDevice->bShortSlotTime = bShortSlotTime;\r\nBBvSetShortSlotTime(pDevice);\r\nvUpdateIFS(pDevice);\r\n}\r\n}\r\nbyOldPreambleType = pDevice->byPreambleType;\r\nif (WLAN_GET_CAP_INFO_SHORTPREAMBLE(pBSSList->wCapInfo)) {\r\npDevice->byPreambleType = pDevice->byShortPreamble;\r\n}\r\nelse {\r\npDevice->byPreambleType = 0;\r\n}\r\nif (pDevice->byPreambleType != byOldPreambleType)\r\nCARDvSetRSPINF(pDevice, (BYTE)pDevice->byBBType);\r\nif (pBSSList->eNetworkTypeInUse == PHY_TYPE_11B) {\r\nuRateLen = WLAN_RATES_MAXLEN_11B;\r\n}\r\npMgmt->abyCurrSuppRates[1] = RATEuSetIE((PWLAN_IE_SUPP_RATES)pBSSList->abySuppRates,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrSuppRates,\r\nuRateLen);\r\npMgmt->abyCurrExtSuppRates[1] = RATEuSetIE((PWLAN_IE_SUPP_RATES)pBSSList->abyExtSuppRates,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrExtSuppRates,\r\nuRateLen);\r\nRATEvParseMaxRate((void *)pDevice,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrSuppRates,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrExtSuppRates,\r\nTRUE,\r\n&(pMgmt->sNodeDBTable[0].wMaxBasicRate),\r\n&(pMgmt->sNodeDBTable[0].wMaxSuppRate),\r\n&(pMgmt->sNodeDBTable[0].wSuppRate),\r\n&(pMgmt->sNodeDBTable[0].byTopCCKBasicRate),\r\n&(pMgmt->sNodeDBTable[0].byTopOFDMBasicRate)\r\n);\r\n}\r\n}\r\nif (WLAN_GET_CAP_INFO_ESS(*sFrame.pwCapInfo)) {\r\nif (sFrame.pCFParms->wCFPDurRemaining > 0) {\r\n}\r\n}\r\nHIDWORD(qwTimestamp) = cpu_to_le32(HIDWORD(*sFrame.pqwTimestamp));\r\nLODWORD(qwTimestamp) = cpu_to_le32(LODWORD(*sFrame.pqwTimestamp));\r\nHIDWORD(qwLocalTSF) = HIDWORD(pRxPacket->qwLocalTSF);\r\nLODWORD(qwLocalTSF) = LODWORD(pRxPacket->qwLocalTSF);\r\nif (HIDWORD(qwTimestamp) == HIDWORD(qwLocalTSF)) {\r\nif (LODWORD(qwTimestamp) >= LODWORD(qwLocalTSF)) {\r\nbTSFOffsetPostive = TRUE;\r\n}\r\nelse {\r\nbTSFOffsetPostive = FALSE;\r\n}\r\n}\r\nelse if (HIDWORD(qwTimestamp) > HIDWORD(qwLocalTSF)) {\r\nbTSFOffsetPostive = TRUE;\r\n}\r\nelse if (HIDWORD(qwTimestamp) < HIDWORD(qwLocalTSF)) {\r\nbTSFOffsetPostive = FALSE;\r\n}\r\nif (bTSFOffsetPostive) {\r\nqwTSFOffset = CARDqGetTSFOffset(pRxPacket->byRxRate, (qwTimestamp), (qwLocalTSF));\r\n}\r\nelse {\r\nqwTSFOffset = CARDqGetTSFOffset(pRxPacket->byRxRate, (qwLocalTSF), (qwTimestamp));\r\n}\r\nif (HIDWORD(qwTSFOffset) != 0 ||\r\n(LODWORD(qwTSFOffset) > TRIVIAL_SYNC_DIFFERENCE )) {\r\nbTSFLargeDiff = TRUE;\r\n}\r\nif (bIsAPBeacon == TRUE) {\r\nif (bTSFLargeDiff)\r\nbUpdateTSF = TRUE;\r\nif ((pDevice->bEnablePSMode == TRUE) && (sFrame.pTIM)) {\r\npMgmt->bMulticastTIM = WLAN_MGMT_IS_MULTICAST_TIM(sFrame.pTIM->byBitMapCtl) ? TRUE : FALSE ;\r\npMgmt->byDTIMCount = sFrame.pTIM->byDTIMCount;\r\npMgmt->byDTIMPeriod = sFrame.pTIM->byDTIMPeriod;\r\nwAIDNumber = pMgmt->wCurrAID & ~(BIT14|BIT15);\r\nwStartIndex = WLAN_MGMT_GET_TIM_OFFSET(sFrame.pTIM->byBitMapCtl) << 1;\r\nwAIDIndex = (wAIDNumber >> 3);\r\nif ((wAIDNumber > 0) && (wAIDIndex >= wStartIndex)) {\r\nuLocateByteIndex = wAIDIndex - wStartIndex;\r\nif (sFrame.pTIM->len >= (uLocateByteIndex + 4)) {\r\nbyTIMBitOn = (0x01) << ((wAIDNumber) % 8);\r\npMgmt->bInTIM = sFrame.pTIM->byVirtBitMap[uLocateByteIndex] & byTIMBitOn ? TRUE : FALSE;\r\n}\r\nelse {\r\npMgmt->bInTIM = FALSE;\r\n};\r\n}\r\nelse {\r\npMgmt->bInTIM = FALSE;\r\n};\r\nif (pMgmt->bInTIM ||\r\n(pMgmt->bMulticastTIM && (pMgmt->byDTIMCount == 0))) {\r\npMgmt->bInTIMWake = TRUE;\r\nif (pMgmt->bInTIM) {\r\nPSvSendPSPOLL((PSDevice)pDevice);\r\n}\r\n}\r\nelse {\r\npMgmt->bInTIMWake = FALSE;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "BCN: Not In TIM..\n");\r\nif (pDevice->bPWBitOn == FALSE) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "BCN: Send Null Packet\n");\r\nif (PSbSendNullPacket(pDevice))\r\npDevice->bPWBitOn = TRUE;\r\n}\r\nif(PSbConsiderPowerDown(pDevice, FALSE, FALSE)) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "BCN: Power down now...\n");\r\n}\r\n}\r\n}\r\n}\r\nif ((pMgmt->eCurrMode == WMAC_MODE_IBSS_STA) && !bIsAPBeacon && bIsChannelEqual) {\r\nif (bIsBSSIDEqual) {\r\nif (pMgmt->sNodeDBTable[0].uInActiveCount != 0)\r\npMgmt->sNodeDBTable[0].uInActiveCount = 0;\r\nif (bTSFLargeDiff && bTSFOffsetPostive &&\r\n(pMgmt->eCurrState == WMAC_STATE_JOINTED))\r\nbUpdateTSF = TRUE;\r\nif (BSSbIsSTAInNodeDB(pDevice, sFrame.pHdr->sA3.abyAddr2, &uNodeIndex)) {\r\npMgmt->abyCurrSuppRates[1] = RATEuSetIE((PWLAN_IE_SUPP_RATES)sFrame.pSuppRates,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrSuppRates,\r\nWLAN_RATES_MAXLEN_11B);\r\nRATEvParseMaxRate((void *)pDevice,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrSuppRates,\r\nNULL,\r\nTRUE,\r\n&(pMgmt->sNodeDBTable[uNodeIndex].wMaxBasicRate),\r\n&(pMgmt->sNodeDBTable[uNodeIndex].wMaxSuppRate),\r\n&(pMgmt->sNodeDBTable[uNodeIndex].wSuppRate),\r\n&(pMgmt->sNodeDBTable[uNodeIndex].byTopCCKBasicRate),\r\n&(pMgmt->sNodeDBTable[uNodeIndex].byTopOFDMBasicRate)\r\n);\r\npMgmt->sNodeDBTable[uNodeIndex].bShortPreamble = WLAN_GET_CAP_INFO_SHORTPREAMBLE(*sFrame.pwCapInfo);\r\npMgmt->sNodeDBTable[uNodeIndex].bShortSlotTime = WLAN_GET_CAP_INFO_SHORTSLOTTIME(*sFrame.pwCapInfo);\r\npMgmt->sNodeDBTable[uNodeIndex].uInActiveCount = 0;\r\n}\r\nelse {\r\nBSSvCreateOneNode((PSDevice)pDevice, &uNodeIndex);\r\npMgmt->abyCurrSuppRates[1] = RATEuSetIE((PWLAN_IE_SUPP_RATES)sFrame.pSuppRates,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrSuppRates,\r\nWLAN_RATES_MAXLEN_11B);\r\nRATEvParseMaxRate((void *)pDevice,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrSuppRates,\r\nNULL,\r\nTRUE,\r\n&(pMgmt->sNodeDBTable[uNodeIndex].wMaxBasicRate),\r\n&(pMgmt->sNodeDBTable[uNodeIndex].wMaxSuppRate),\r\n&(pMgmt->sNodeDBTable[uNodeIndex].wSuppRate),\r\n&(pMgmt->sNodeDBTable[uNodeIndex].byTopCCKBasicRate),\r\n&(pMgmt->sNodeDBTable[uNodeIndex].byTopOFDMBasicRate)\r\n);\r\nmemcpy(pMgmt->sNodeDBTable[uNodeIndex].abyMACAddr, sFrame.pHdr->sA3.abyAddr2, WLAN_ADDR_LEN);\r\npMgmt->sNodeDBTable[uNodeIndex].bShortPreamble = WLAN_GET_CAP_INFO_SHORTPREAMBLE(*sFrame.pwCapInfo);\r\npMgmt->sNodeDBTable[uNodeIndex].wTxDataRate = pMgmt->sNodeDBTable[uNodeIndex].wMaxSuppRate;\r\n}\r\nif (pMgmt->eCurrState == WMAC_STATE_STARTED) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Current IBSS State: [Started]........to: [Jointed] \n");\r\npMgmt->eCurrState = WMAC_STATE_JOINTED;\r\npDevice->bLinkPass = TRUE;\r\nControlvMaskByte(pDevice,MESSAGE_REQUEST_MACREG,MAC_REG_PAPEDELAY,LEDSTS_STS,LEDSTS_INTER);\r\nif (netif_queue_stopped(pDevice->dev)){\r\nnetif_wake_queue(pDevice->dev);\r\n}\r\npMgmt->sNodeDBTable[0].bActive = TRUE;\r\npMgmt->sNodeDBTable[0].uInActiveCount = 0;\r\n}\r\n}\r\nelse if (bIsSSIDEqual) {\r\nif (bTSFLargeDiff && bTSFOffsetPostive) {\r\nmemcpy(pMgmt->abyCurrBSSID, sFrame.pHdr->sA3.abyAddr3, WLAN_BSSID_LEN);\r\nmemcpy(pDevice->abyBSSID, pMgmt->abyCurrBSSID, WLAN_BSSID_LEN);\r\npMgmt->wCurrATIMWindow = cpu_to_le16(sFrame.pIBSSParms->wATIMWindow);\r\npMgmt->wCurrBeaconPeriod = cpu_to_le16(*sFrame.pwBeaconInterval);\r\npMgmt->abyCurrSuppRates[1] = RATEuSetIE((PWLAN_IE_SUPP_RATES)sFrame.pSuppRates,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrSuppRates,\r\nWLAN_RATES_MAXLEN_11B);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Rejoining to Other Adhoc group with same SSID........\n");\r\nMACvWriteBeaconInterval(pDevice, pMgmt->wCurrBeaconPeriod);\r\nCARDvAdjustTSF(pDevice, pRxPacket->byRxRate, qwTimestamp, pRxPacket->qwLocalTSF);\r\nCARDvUpdateNextTBTT(pDevice, qwTimestamp, pMgmt->wCurrBeaconPeriod);\r\nMACvWriteBSSIDAddress(pDevice, pMgmt->abyCurrBSSID);\r\nbyOldPreambleType = pDevice->byPreambleType;\r\nif (WLAN_GET_CAP_INFO_SHORTPREAMBLE(*sFrame.pwCapInfo)) {\r\npDevice->byPreambleType = pDevice->byShortPreamble;\r\n}\r\nelse {\r\npDevice->byPreambleType = 0;\r\n}\r\nif (pDevice->byPreambleType != byOldPreambleType)\r\nCARDvSetRSPINF(pDevice, (BYTE)pDevice->byBBType);\r\nbMgrPrepareBeaconToSend((void *) pDevice, pMgmt);\r\n}\r\n}\r\n}\r\nif (bUpdateTSF) {\r\nCARDbGetCurrentTSF(pDevice, &qwCurrTSF);\r\nCARDvAdjustTSF(pDevice, pRxPacket->byRxRate, qwTimestamp , pRxPacket->qwLocalTSF);\r\nCARDbGetCurrentTSF(pDevice, &qwCurrTSF);\r\nCARDvUpdateNextTBTT(pDevice, qwTimestamp, pMgmt->wCurrBeaconPeriod);\r\n}\r\nreturn;\r\n}\r\nvoid vMgrCreateOwnIBSS(void *hDeviceContext,\r\nPCMD_STATUS pStatus)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPSMgmtObject pMgmt = &(pDevice->sMgmtObj);\r\nWORD wMaxBasicRate;\r\nWORD wMaxSuppRate;\r\nBYTE byTopCCKBasicRate;\r\nBYTE byTopOFDMBasicRate;\r\nQWORD qwCurrTSF;\r\nunsigned int ii;\r\nBYTE abyRATE[] = {0x82, 0x84, 0x8B, 0x96, 0x24, 0x30, 0x48, 0x6C, 0x0C, 0x12, 0x18, 0x60};\r\nBYTE abyCCK_RATE[] = {0x82, 0x84, 0x8B, 0x96};\r\nBYTE abyOFDM_RATE[] = {0x0C, 0x12, 0x18, 0x24, 0x30, 0x48, 0x60, 0x6C};\r\nWORD wSuppRate;\r\nHIDWORD(qwCurrTSF) = 0;\r\nLODWORD(qwCurrTSF) = 0;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Create Basic Service Set .......\n");\r\nif (pMgmt->eConfigMode == WMAC_CONFIG_IBSS_STA) {\r\nif ((pMgmt->eAuthenMode == WMAC_AUTH_WPANONE) &&\r\n(pDevice->eEncryptionStatus != Ndis802_11Encryption2Enabled) &&\r\n(pDevice->eEncryptionStatus != Ndis802_11Encryption3Enabled)) {\r\n*pStatus = CMD_STATUS_FAILURE;\r\nreturn;\r\n}\r\n}\r\npMgmt->abyCurrSuppRates[0] = WLAN_EID_SUPP_RATES;\r\npMgmt->abyCurrExtSuppRates[0] = WLAN_EID_EXTSUPP_RATES;\r\nif (pMgmt->eConfigMode == WMAC_CONFIG_AP) {\r\npMgmt->eCurrentPHYMode = pMgmt->byAPBBType;\r\n} else {\r\nif (pDevice->byBBType == BB_TYPE_11G)\r\npMgmt->eCurrentPHYMode = PHY_TYPE_11G;\r\nif (pDevice->byBBType == BB_TYPE_11B)\r\npMgmt->eCurrentPHYMode = PHY_TYPE_11B;\r\nif (pDevice->byBBType == BB_TYPE_11A)\r\npMgmt->eCurrentPHYMode = PHY_TYPE_11A;\r\n}\r\nif (pMgmt->eCurrentPHYMode != PHY_TYPE_11A) {\r\npMgmt->abyCurrSuppRates[1] = WLAN_RATES_MAXLEN_11B;\r\npMgmt->abyCurrExtSuppRates[1] = 0;\r\nfor (ii = 0; ii < 4; ii++)\r\npMgmt->abyCurrSuppRates[2+ii] = abyRATE[ii];\r\n} else {\r\npMgmt->abyCurrSuppRates[1] = 8;\r\npMgmt->abyCurrExtSuppRates[1] = 0;\r\nfor (ii = 0; ii < 8; ii++)\r\npMgmt->abyCurrSuppRates[2+ii] = abyRATE[ii];\r\n}\r\nif (pMgmt->eCurrentPHYMode == PHY_TYPE_11G) {\r\npMgmt->abyCurrSuppRates[1] = 8;\r\npMgmt->abyCurrExtSuppRates[1] = 4;\r\nfor (ii = 0; ii < 4; ii++)\r\npMgmt->abyCurrSuppRates[2+ii] = abyCCK_RATE[ii];\r\nfor (ii = 4; ii < 8; ii++)\r\npMgmt->abyCurrSuppRates[2+ii] = abyOFDM_RATE[ii-4];\r\nfor (ii = 0; ii < 4; ii++)\r\npMgmt->abyCurrExtSuppRates[2+ii] = abyOFDM_RATE[ii+4];\r\n}\r\npDevice->bProtectMode = 0;\r\nMACvDisableProtectMD(pDevice);\r\npDevice->bBarkerPreambleMd = 0;\r\nMACvDisableBarkerPreambleMd(pDevice);\r\nif (pMgmt->wIBSSBeaconPeriod == 0)\r\npMgmt->wIBSSBeaconPeriod = DEFAULT_IBSS_BI;\r\nMACvWriteBeaconInterval(pDevice, pMgmt->wIBSSBeaconPeriod);\r\nCARDbGetCurrentTSF(pDevice, &qwCurrTSF);\r\nCARDbClearCurrentTSF(pDevice);\r\nMACvRegBitsOn(pDevice,MAC_REG_TFTCTL,TFTCTL_TSFCNTREN);\r\nCARDvSetFirstNextTBTT(pDevice, pMgmt->wIBSSBeaconPeriod);\r\npMgmt->uIBSSChannel = pDevice->uChannel;\r\nif (pMgmt->uIBSSChannel == 0)\r\npMgmt->uIBSSChannel = DEFAULT_IBSS_CHANNEL;\r\nCARDbSetMediaChannel(pDevice, pMgmt->uIBSSChannel);\r\npMgmt->uCurrChannel = pMgmt->uIBSSChannel;\r\npDevice->byPreambleType = pDevice->byShortPreamble;\r\nRATEvParseMaxRate((void *)pDevice,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrSuppRates,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrExtSuppRates, TRUE,\r\n&wMaxBasicRate, &wMaxSuppRate, &wSuppRate,\r\n&byTopCCKBasicRate, &byTopOFDMBasicRate);\r\nif (pDevice->byBBType == BB_TYPE_11A) {\r\npDevice->bShortSlotTime = TRUE;\r\n} else {\r\npDevice->bShortSlotTime = FALSE;\r\n}\r\nBBvSetShortSlotTime(pDevice);\r\nCARDvSetBSSMode(pDevice);\r\nif (pMgmt->eConfigMode == WMAC_CONFIG_AP) {\r\nMACvRegBitsOn(pDevice, MAC_REG_HOSTCR, HOSTCR_AP);\r\npMgmt->eCurrMode = WMAC_MODE_ESS_AP;\r\n}\r\nif (pMgmt->eConfigMode == WMAC_CONFIG_IBSS_STA) {\r\nMACvRegBitsOn(pDevice, MAC_REG_HOSTCR, HOSTCR_ADHOC);\r\npMgmt->eCurrMode = WMAC_MODE_IBSS_STA;\r\n}\r\npMgmt->eCurrState = WMAC_STATE_STARTED;\r\npMgmt->wCurrBeaconPeriod = pMgmt->wIBSSBeaconPeriod;\r\npMgmt->uCurrChannel = pMgmt->uIBSSChannel;\r\npMgmt->wCurrATIMWindow = pMgmt->wIBSSATIMWindow;\r\npDevice->uCurrRSSI = 0;\r\npDevice->byCurrSQ = 0;\r\nmemcpy(pMgmt->abyDesireSSID,pMgmt->abyAdHocSSID,\r\n((PWLAN_IE_SSID)pMgmt->abyAdHocSSID)->len + WLAN_IEHDR_LEN);\r\nmemset(pMgmt->abyCurrSSID, 0, WLAN_IEHDR_LEN + WLAN_SSID_MAXLEN + 1);\r\nmemcpy(pMgmt->abyCurrSSID,\r\npMgmt->abyDesireSSID,\r\n((PWLAN_IE_SSID)pMgmt->abyDesireSSID)->len + WLAN_IEHDR_LEN\r\n);\r\nif (pMgmt->eCurrMode == WMAC_MODE_ESS_AP) {\r\nmemcpy(pMgmt->abyCurrBSSID, pMgmt->abyMACAddr, WLAN_ADDR_LEN);\r\nDBG_PRT(MSG_LEVEL_INFO, KERN_INFO"AP beacon created BSSID:%02x-%02x-%02x-%02x-%02x-%02x \n",\r\npMgmt->abyCurrBSSID[0],\r\npMgmt->abyCurrBSSID[1],\r\npMgmt->abyCurrBSSID[2],\r\npMgmt->abyCurrBSSID[3],\r\npMgmt->abyCurrBSSID[4],\r\npMgmt->abyCurrBSSID[5]\r\n);\r\n}\r\nif (pMgmt->eCurrMode == WMAC_MODE_IBSS_STA) {\r\npMgmt->abyCurrBSSID[5] = (BYTE) (LODWORD(qwCurrTSF)& 0x000000ff);\r\npMgmt->abyCurrBSSID[4] = (BYTE)((LODWORD(qwCurrTSF)& 0x0000ff00) >> 8);\r\npMgmt->abyCurrBSSID[3] = (BYTE)((LODWORD(qwCurrTSF)& 0x00ff0000) >> 16);\r\npMgmt->abyCurrBSSID[2] = (BYTE)((LODWORD(qwCurrTSF)& 0x00000ff0) >> 4);\r\npMgmt->abyCurrBSSID[1] = (BYTE)((LODWORD(qwCurrTSF)& 0x000ff000) >> 12);\r\npMgmt->abyCurrBSSID[0] = (BYTE)((LODWORD(qwCurrTSF)& 0x0ff00000) >> 20);\r\npMgmt->abyCurrBSSID[5] ^= pMgmt->abyMACAddr[0];\r\npMgmt->abyCurrBSSID[4] ^= pMgmt->abyMACAddr[1];\r\npMgmt->abyCurrBSSID[3] ^= pMgmt->abyMACAddr[2];\r\npMgmt->abyCurrBSSID[2] ^= pMgmt->abyMACAddr[3];\r\npMgmt->abyCurrBSSID[1] ^= pMgmt->abyMACAddr[4];\r\npMgmt->abyCurrBSSID[0] ^= pMgmt->abyMACAddr[5];\r\npMgmt->abyCurrBSSID[0] &= ~IEEE_ADDR_GROUP;\r\npMgmt->abyCurrBSSID[0] |= IEEE_ADDR_UNIVERSAL;\r\nDBG_PRT(MSG_LEVEL_INFO, KERN_INFO"Adhoc beacon created bssid:%02x-%02x-%02x-%02x-%02x-%02x \n",\r\npMgmt->abyCurrBSSID[0],\r\npMgmt->abyCurrBSSID[1],\r\npMgmt->abyCurrBSSID[2],\r\npMgmt->abyCurrBSSID[3],\r\npMgmt->abyCurrBSSID[4],\r\npMgmt->abyCurrBSSID[5]\r\n);\r\n}\r\nMACvWriteBSSIDAddress(pDevice, pMgmt->abyCurrBSSID);\r\nmemcpy(pDevice->abyBSSID, pMgmt->abyCurrBSSID, WLAN_ADDR_LEN);\r\nMACvRegBitsOn(pDevice, MAC_REG_RCR, RCR_BSSID);\r\npDevice->byRxMode |= RCR_BSSID;\r\npMgmt->bCurrBSSIDFilterOn = TRUE;\r\npMgmt->wCurrCapInfo = 0;\r\nif (pMgmt->eCurrMode == WMAC_MODE_ESS_AP) {\r\npMgmt->wCurrCapInfo |= WLAN_SET_CAP_INFO_ESS(1);\r\npMgmt->byDTIMPeriod = DEFAULT_DTIM_PERIOD;\r\npMgmt->byDTIMCount = pMgmt->byDTIMPeriod - 1;\r\npDevice->eOPMode = OP_MODE_AP;\r\n}\r\nif (pMgmt->eCurrMode == WMAC_MODE_IBSS_STA) {\r\npMgmt->wCurrCapInfo |= WLAN_SET_CAP_INFO_IBSS(1);\r\npDevice->eOPMode = OP_MODE_ADHOC;\r\n}\r\nif (pDevice->bEncryptionEnable) {\r\npMgmt->wCurrCapInfo |= WLAN_SET_CAP_INFO_PRIVACY(1);\r\nif (pMgmt->eAuthenMode == WMAC_AUTH_WPANONE) {\r\nif (pDevice->eEncryptionStatus == Ndis802_11Encryption3Enabled) {\r\npMgmt->byCSSPK = KEY_CTL_CCMP;\r\npMgmt->byCSSGK = KEY_CTL_CCMP;\r\n} else if (pDevice->eEncryptionStatus == Ndis802_11Encryption2Enabled) {\r\npMgmt->byCSSPK = KEY_CTL_TKIP;\r\npMgmt->byCSSGK = KEY_CTL_TKIP;\r\n} else {\r\npMgmt->byCSSPK = KEY_CTL_NONE;\r\npMgmt->byCSSGK = KEY_CTL_WEP;\r\n}\r\n} else {\r\npMgmt->byCSSPK = KEY_CTL_WEP;\r\npMgmt->byCSSGK = KEY_CTL_WEP;\r\n}\r\n}\r\npMgmt->byERPContext = 0;\r\nif (pDevice->byPreambleType == 1) {\r\npMgmt->wCurrCapInfo |= WLAN_SET_CAP_INFO_SHORTPREAMBLE(1);\r\n} else {\r\npMgmt->wCurrCapInfo &= (~WLAN_SET_CAP_INFO_SHORTPREAMBLE(1));\r\n}\r\npMgmt->eCurrState = WMAC_STATE_STARTED;\r\nif (bMgrPrepareBeaconToSend((void *) pDevice, pMgmt))\r\n*pStatus = CMD_STATUS_SUCCESS;\r\nreturn;\r\n}\r\nvoid vMgrJoinBSSBegin(void *hDeviceContext, PCMD_STATUS pStatus)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPSMgmtObject pMgmt = &(pDevice->sMgmtObj);\r\nPKnownBSS pCurr = NULL;\r\nunsigned int ii, uu;\r\nPWLAN_IE_SUPP_RATES pItemRates = NULL;\r\nPWLAN_IE_SUPP_RATES pItemExtRates = NULL;\r\nPWLAN_IE_SSID pItemSSID;\r\nunsigned int uRateLen = WLAN_RATES_MAXLEN;\r\nWORD wMaxBasicRate = RATE_1M;\r\nWORD wMaxSuppRate = RATE_1M;\r\nWORD wSuppRate;\r\nBYTE byTopCCKBasicRate = RATE_1M;\r\nBYTE byTopOFDMBasicRate = RATE_1M;\r\nBOOL bShortSlotTime = FALSE;\r\nfor (ii = 0; ii < MAX_BSS_NUM; ii++) {\r\nif (pMgmt->sBSSList[ii].bActive == TRUE)\r\nbreak;\r\n}\r\nif (ii == MAX_BSS_NUM) {\r\n*pStatus = CMD_STATUS_RESOURCES;\r\nDBG_PRT(MSG_LEVEL_NOTICE, KERN_INFO "BSS finding:BSS list is empty.\n");\r\nreturn;\r\n}\r\npCurr = BSSpSearchBSSList(pDevice,\r\npMgmt->abyDesireBSSID,\r\npMgmt->abyDesireSSID,\r\npDevice->eConfigPHYMode\r\n);\r\nif (pCurr == NULL){\r\n*pStatus = CMD_STATUS_RESOURCES;\r\npItemSSID = (PWLAN_IE_SSID)pMgmt->abyDesireSSID;\r\nDBG_PRT(MSG_LEVEL_NOTICE, KERN_INFO "Scanning [%s] not found, disconnected !\n", pItemSSID->abySSID);\r\nreturn;\r\n}\r\nDBG_PRT(MSG_LEVEL_NOTICE, KERN_INFO "AP(BSS) finding:Found a AP(BSS)..\n");\r\nif (WLAN_GET_CAP_INFO_ESS(cpu_to_le16(pCurr->wCapInfo))){\r\nif ((pMgmt->eAuthenMode == WMAC_AUTH_WPA) ||\r\n(pMgmt->eAuthenMode == WMAC_AUTH_WPAPSK)) {\r\n}\r\n#ifdef WPA_SUPPLICANT_DRIVER_WEXT_SUPPORT\r\nEncyption_Rebuild(pDevice, pCurr);\r\n#endif\r\ns_vMgrSynchBSS(pDevice,\r\nWMAC_MODE_ESS_STA,\r\npCurr,\r\npStatus\r\n);\r\nif (*pStatus == CMD_STATUS_SUCCESS){\r\npMgmt->uCurrChannel = pCurr->uChannel;\r\nmemset(pMgmt->abyCurrSuppRates, 0 , WLAN_IEHDR_LEN + WLAN_RATES_MAXLEN + 1);\r\nmemset(pMgmt->abyCurrExtSuppRates, 0 , WLAN_IEHDR_LEN + WLAN_RATES_MAXLEN + 1);\r\nif (pCurr->eNetworkTypeInUse == PHY_TYPE_11B) {\r\nuRateLen = WLAN_RATES_MAXLEN_11B;\r\n}\r\npItemRates = (PWLAN_IE_SUPP_RATES)pMgmt->abyCurrSuppRates;\r\npItemExtRates = (PWLAN_IE_SUPP_RATES)pMgmt->abyCurrExtSuppRates;\r\npItemRates->byElementID = WLAN_EID_SUPP_RATES;\r\npItemRates->len = RATEuSetIE((PWLAN_IE_SUPP_RATES)pCurr->abySuppRates,\r\npItemRates,\r\nuRateLen);\r\npItemExtRates->byElementID = WLAN_EID_EXTSUPP_RATES;\r\npItemExtRates->len = RATEuSetIE((PWLAN_IE_SUPP_RATES)pCurr->abyExtSuppRates,\r\npItemExtRates,\r\nuRateLen);\r\nif ((pItemExtRates->len > 0) && (pItemRates->len < 8)) {\r\nfor (ii = 0; ii < (unsigned int) (8 - pItemRates->len); ) {\r\npItemRates->abyRates[pItemRates->len + ii] =\r\npItemExtRates->abyRates[ii];\r\nii++;\r\nif (pItemExtRates->len <= ii)\r\nbreak;\r\n}\r\npItemRates->len += (BYTE)ii;\r\nif (pItemExtRates->len - ii > 0) {\r\npItemExtRates->len -= (BYTE)ii;\r\nfor (uu = 0; uu < pItemExtRates->len; uu ++) {\r\npItemExtRates->abyRates[uu] = pItemExtRates->abyRates[uu + ii];\r\n}\r\n} else {\r\npItemExtRates->len = 0;\r\n}\r\n}\r\nRATEvParseMaxRate((void *)pDevice, pItemRates, pItemExtRates, TRUE,\r\n&wMaxBasicRate, &wMaxSuppRate, &wSuppRate,\r\n&byTopCCKBasicRate, &byTopOFDMBasicRate);\r\nvUpdateIFS(pDevice);\r\npMgmt->wCurrBeaconPeriod = pCurr->wBeaconInterval;\r\nmemset(pMgmt->abyCurrSSID, 0, WLAN_IEHDR_LEN + WLAN_SSID_MAXLEN + 1);\r\nmemcpy(pMgmt->abyCurrBSSID, pCurr->abyBSSID, WLAN_BSSID_LEN);\r\nmemcpy(pMgmt->abyCurrSSID, pCurr->abySSID, WLAN_IEHDR_LEN + WLAN_SSID_MAXLEN + 1);\r\npMgmt->eCurrMode = WMAC_MODE_ESS_STA;\r\npMgmt->eCurrState = WMAC_STATE_JOINTED;\r\npDevice->eOPMode = OP_MODE_INFRASTRUCTURE;\r\nmemcpy(pDevice->abyBSSID, pCurr->abyBSSID, WLAN_BSSID_LEN);\r\nif (pMgmt->eAuthenMode == WMAC_AUTH_WPA2) {\r\nBOOL bResult = bAdd_PMKID_Candidate((void *) pDevice,\r\npMgmt->abyCurrBSSID,\r\n&pCurr->sRSNCapObj);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"bAdd_PMKID_Candidate: 1(%d)\n", bResult);\r\nif (bResult == FALSE) {\r\nvFlush_PMKID_Candidate((void *) pDevice);\r\nDBG_PRT(MSG_LEVEL_DEBUG,\r\nKERN_INFO "vFlush_PMKID_Candidate: 4\n");\r\nbAdd_PMKID_Candidate((void *) pDevice,\r\npMgmt->abyCurrBSSID,\r\n&pCurr->sRSNCapObj);\r\n}\r\n}\r\nif (WLAN_GET_CAP_INFO_SHORTPREAMBLE(pCurr->wCapInfo)) {\r\npDevice->byPreambleType = pDevice->byShortPreamble;\r\n}\r\nelse {\r\npDevice->byPreambleType = 0;\r\n}\r\nCARDvSetRSPINF(pDevice, (BYTE)pDevice->byBBType);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"Join ESS\n");\r\nif (pCurr->eNetworkTypeInUse == PHY_TYPE_11G) {\r\nif ((pCurr->sERP.byERP & WLAN_EID_ERP_USE_PROTECTION) != pDevice->bProtectMode) {\r\npDevice->bProtectMode = (pCurr->sERP.byERP & WLAN_EID_ERP_USE_PROTECTION);\r\nif (pDevice->bProtectMode) {\r\nMACvEnableProtectMD(pDevice);\r\n} else {\r\nMACvDisableProtectMD(pDevice);\r\n}\r\nvUpdateIFS(pDevice);\r\n}\r\nif ((pCurr->sERP.byERP & WLAN_EID_ERP_NONERP_PRESENT) != pDevice->bNonERPPresent) {\r\npDevice->bNonERPPresent = (pCurr->sERP.byERP & WLAN_EID_ERP_USE_PROTECTION);\r\n}\r\nif ((pCurr->sERP.byERP & WLAN_EID_ERP_BARKER_MODE) != pDevice->bBarkerPreambleMd) {\r\npDevice->bBarkerPreambleMd = (pCurr->sERP.byERP & WLAN_EID_ERP_BARKER_MODE);\r\nif (pDevice->bBarkerPreambleMd) {\r\nMACvEnableBarkerPreambleMd(pDevice);\r\n} else {\r\nMACvDisableBarkerPreambleMd(pDevice);\r\n}\r\n}\r\n}\r\nif (WLAN_GET_CAP_INFO_SHORTSLOTTIME(pCurr->wCapInfo) != pDevice->bShortSlotTime) {\r\nif (pDevice->byBBType == BB_TYPE_11A) {\r\nbShortSlotTime = TRUE;\r\n}\r\nelse if (pDevice->byBBType == BB_TYPE_11B) {\r\nbShortSlotTime = FALSE;\r\n}\r\nelse {\r\nbShortSlotTime = WLAN_GET_CAP_INFO_SHORTSLOTTIME(pCurr->wCapInfo);\r\n}\r\nif (bShortSlotTime != pDevice->bShortSlotTime) {\r\npDevice->bShortSlotTime = bShortSlotTime;\r\nBBvSetShortSlotTime(pDevice);\r\nvUpdateIFS(pDevice);\r\n}\r\n}\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"End of Join AP -- A/B/G Action\n");\r\n}\r\nelse {\r\npMgmt->eCurrState = WMAC_STATE_IDLE;\r\n};\r\n}\r\nelse {\r\nif (pMgmt->eAuthenMode == WMAC_AUTH_WPANONE) {\r\nif (pDevice->eEncryptionStatus == Ndis802_11Encryption2Enabled) {\r\n} else if (pDevice->eEncryptionStatus == Ndis802_11Encryption3Enabled) {\r\n} else {\r\npMgmt->eCurrState = WMAC_STATE_IDLE;\r\nreturn;\r\n}\r\n}\r\ns_vMgrSynchBSS(pDevice,\r\nWMAC_MODE_IBSS_STA,\r\npCurr,\r\npStatus\r\n);\r\nif (*pStatus == CMD_STATUS_SUCCESS){\r\npMgmt->uCurrChannel = pCurr->uChannel;\r\npMgmt->abyCurrSuppRates[0] = WLAN_EID_SUPP_RATES;\r\npMgmt->abyCurrSuppRates[1] = RATEuSetIE((PWLAN_IE_SUPP_RATES)pCurr->abySuppRates,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrSuppRates,\r\nWLAN_RATES_MAXLEN_11B);\r\nRATEvParseMaxRate((void *)pDevice,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrSuppRates,\r\nNULL, TRUE, &wMaxBasicRate, &wMaxSuppRate, &wSuppRate,\r\n&byTopCCKBasicRate, &byTopOFDMBasicRate);\r\nvUpdateIFS(pDevice);\r\npMgmt->wCurrCapInfo = pCurr->wCapInfo;\r\npMgmt->wCurrBeaconPeriod = pCurr->wBeaconInterval;\r\nmemset(pMgmt->abyCurrSSID, 0, WLAN_IEHDR_LEN + WLAN_SSID_MAXLEN);\r\nmemcpy(pMgmt->abyCurrBSSID, pCurr->abyBSSID, WLAN_BSSID_LEN);\r\nmemcpy(pMgmt->abyCurrSSID, pCurr->abySSID, WLAN_IEHDR_LEN + WLAN_SSID_MAXLEN);\r\npMgmt->eCurrMode = WMAC_MODE_IBSS_STA;\r\npMgmt->eCurrState = WMAC_STATE_STARTED;\r\npDevice->eOPMode = OP_MODE_ADHOC;\r\npDevice->bLinkPass = TRUE;\r\nControlvMaskByte(pDevice,MESSAGE_REQUEST_MACREG,MAC_REG_PAPEDELAY,LEDSTS_STS,LEDSTS_INTER);\r\nmemcpy(pDevice->abyBSSID, pCurr->abyBSSID, WLAN_BSSID_LEN);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"Join IBSS ok:%02x-%02x-%02x-%02x-%02x-%02x \n",\r\npMgmt->abyCurrBSSID[0],\r\npMgmt->abyCurrBSSID[1],\r\npMgmt->abyCurrBSSID[2],\r\npMgmt->abyCurrBSSID[3],\r\npMgmt->abyCurrBSSID[4],\r\npMgmt->abyCurrBSSID[5]\r\n);\r\nif (WLAN_GET_CAP_INFO_SHORTPREAMBLE(pCurr->wCapInfo)) {\r\npDevice->byPreambleType = pDevice->byShortPreamble;\r\n}\r\nelse {\r\npDevice->byPreambleType = 0;\r\n}\r\nCARDvSetRSPINF(pDevice, (BYTE)pDevice->byBBType);\r\nbMgrPrepareBeaconToSend((void *) pDevice, pMgmt);\r\n}\r\nelse {\r\npMgmt->eCurrState = WMAC_STATE_IDLE;\r\n};\r\n};\r\nreturn;\r\n}\r\nstatic\r\nvoid\r\ns_vMgrSynchBSS (\r\nPSDevice pDevice,\r\nunsigned int uBSSMode,\r\nPKnownBSS pCurr,\r\nPCMD_STATUS pStatus\r\n)\r\n{\r\nPSMgmtObject pMgmt = &(pDevice->sMgmtObj);\r\nBYTE abyCurrSuppRatesG[] = {WLAN_EID_SUPP_RATES, 8, 0x02, 0x04, 0x0B, 0x16, 0x24, 0x30, 0x48, 0x6C};\r\nBYTE abyCurrExtSuppRatesG[] = {WLAN_EID_EXTSUPP_RATES, 4, 0x0C, 0x12, 0x18, 0x60};\r\nBYTE abyCurrSuppRatesA[] = {WLAN_EID_SUPP_RATES, 8, 0x0C, 0x12, 0x18, 0x24, 0x30, 0x48, 0x60, 0x6C};\r\nBYTE abyCurrSuppRatesB[] = {WLAN_EID_SUPP_RATES, 4, 0x02, 0x04, 0x0B, 0x16};\r\n*pStatus = CMD_STATUS_FAILURE;\r\nif (s_bCipherMatch(pCurr,\r\npDevice->eEncryptionStatus,\r\n&(pMgmt->byCSSPK),\r\n&(pMgmt->byCSSGK)) == FALSE) {\r\nDBG_PRT(MSG_LEVEL_NOTICE, KERN_INFO "s_bCipherMatch Fail .......\n");\r\nreturn;\r\n}\r\npMgmt->pCurrBSS = pCurr;\r\nif(pMgmt->eCurrMode == WMAC_MODE_IBSS_STA) {\r\nMACvRegBitsOff(pDevice, MAC_REG_TCR, TCR_AUTOBCNTX);\r\n}\r\npDevice->bCCK = TRUE;\r\npDevice->bProtectMode = FALSE;\r\nMACvDisableProtectMD(pDevice);\r\npDevice->bBarkerPreambleMd = FALSE;\r\nMACvDisableBarkerPreambleMd(pDevice);\r\npDevice->bNonERPPresent = FALSE;\r\npDevice->byPreambleType = 0;\r\npDevice->wBasicRate = 0;\r\nCARDbAddBasicRate((void *)pDevice, RATE_1M);\r\nCARDvAdjustTSF(pDevice, pCurr->byRxRate, pCurr->qwBSSTimestamp, pCurr->qwLocalTSF);\r\nMACvWriteBeaconInterval(pDevice, pCurr->wBeaconInterval);\r\nCARDvSetFirstNextTBTT(pDevice, pCurr->wBeaconInterval);\r\nMACvWriteBSSIDAddress(pDevice, pCurr->abyBSSID);\r\nmemcpy(pMgmt->abyCurrBSSID, pCurr->abyBSSID, 6);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Sync:set CurrBSSID address = %02x-%02x-%02x=%02x-%02x-%02x\n",\r\npMgmt->abyCurrBSSID[0],\r\npMgmt->abyCurrBSSID[1],\r\npMgmt->abyCurrBSSID[2],\r\npMgmt->abyCurrBSSID[3],\r\npMgmt->abyCurrBSSID[4],\r\npMgmt->abyCurrBSSID[5]);\r\nif (pCurr->eNetworkTypeInUse == PHY_TYPE_11A) {\r\nif ((pDevice->eConfigPHYMode == PHY_TYPE_11A) ||\r\n(pDevice->eConfigPHYMode == PHY_TYPE_AUTO)) {\r\npDevice->byBBType = BB_TYPE_11A;\r\npMgmt->eCurrentPHYMode = PHY_TYPE_11A;\r\npDevice->bShortSlotTime = TRUE;\r\nBBvSetShortSlotTime(pDevice);\r\nCARDvSetBSSMode(pDevice);\r\n} else {\r\nreturn;\r\n}\r\n} else if (pCurr->eNetworkTypeInUse == PHY_TYPE_11B) {\r\nif ((pDevice->eConfigPHYMode == PHY_TYPE_11B) ||\r\n(pDevice->eConfigPHYMode == PHY_TYPE_11G) ||\r\n(pDevice->eConfigPHYMode == PHY_TYPE_AUTO)) {\r\npDevice->byBBType = BB_TYPE_11B;\r\npMgmt->eCurrentPHYMode = PHY_TYPE_11B;\r\npDevice->bShortSlotTime = FALSE;\r\nBBvSetShortSlotTime(pDevice);\r\nCARDvSetBSSMode(pDevice);\r\n} else {\r\nreturn;\r\n}\r\n} else {\r\nif ((pDevice->eConfigPHYMode == PHY_TYPE_11G) ||\r\n(pDevice->eConfigPHYMode == PHY_TYPE_AUTO)) {\r\npDevice->byBBType = BB_TYPE_11G;\r\npMgmt->eCurrentPHYMode = PHY_TYPE_11G;\r\npDevice->bShortSlotTime = TRUE;\r\nBBvSetShortSlotTime(pDevice);\r\nCARDvSetBSSMode(pDevice);\r\n} else if (pDevice->eConfigPHYMode == PHY_TYPE_11B) {\r\npDevice->byBBType = BB_TYPE_11B;\r\npDevice->bShortSlotTime = FALSE;\r\nBBvSetShortSlotTime(pDevice);\r\nCARDvSetBSSMode(pDevice);\r\n} else {\r\nreturn;\r\n}\r\n}\r\nif (uBSSMode == WMAC_MODE_ESS_STA) {\r\nMACvRegBitsOff(pDevice, MAC_REG_HOSTCR, HOSTCR_ADHOC);\r\nMACvRegBitsOn(pDevice, MAC_REG_RCR, RCR_BSSID);\r\npDevice->byRxMode |= RCR_BSSID;\r\npMgmt->bCurrBSSIDFilterOn = TRUE;\r\n}\r\nCARDbSetMediaChannel(pDevice, pCurr->uChannel);\r\npMgmt->uCurrChannel = pCurr->uChannel;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "<----s_bSynchBSS Set Channel [%d]\n", pCurr->uChannel);\r\nif ((pDevice->bUpdateBBVGA) &&\r\n(pDevice->byBBVGACurrent != pDevice->abyBBVGA[0])) {\r\npDevice->byBBVGACurrent = pDevice->abyBBVGA[0];\r\nBBvSetVGAGainOffset(pDevice, pDevice->byBBVGACurrent);\r\nBBvSetShortSlotTime(pDevice);\r\n}\r\nif (uBSSMode == WMAC_MODE_IBSS_STA) {\r\nMACvRegBitsOn(pDevice, MAC_REG_HOSTCR, HOSTCR_ADHOC);\r\nMACvRegBitsOn(pDevice, MAC_REG_RCR, RCR_BSSID);\r\npDevice->byRxMode |= RCR_BSSID;\r\npMgmt->bCurrBSSIDFilterOn = TRUE;\r\n}\r\nif (pDevice->byBBType == BB_TYPE_11A) {\r\nmemcpy(pMgmt->abyCurrSuppRates, &abyCurrSuppRatesA[0], sizeof(abyCurrSuppRatesA));\r\npMgmt->abyCurrExtSuppRates[1] = 0;\r\n} else if (pDevice->byBBType == BB_TYPE_11B) {\r\nmemcpy(pMgmt->abyCurrSuppRates, &abyCurrSuppRatesB[0], sizeof(abyCurrSuppRatesB));\r\npMgmt->abyCurrExtSuppRates[1] = 0;\r\n} else {\r\nmemcpy(pMgmt->abyCurrSuppRates, &abyCurrSuppRatesG[0], sizeof(abyCurrSuppRatesG));\r\nmemcpy(pMgmt->abyCurrExtSuppRates, &abyCurrExtSuppRatesG[0], sizeof(abyCurrExtSuppRatesG));\r\n}\r\npMgmt->byERPContext = pCurr->sERP.byERP;\r\n*pStatus = CMD_STATUS_SUCCESS;\r\nreturn;\r\n}\r\nstatic void Encyption_Rebuild(\r\nPSDevice pDevice,\r\nPKnownBSS pCurr\r\n)\r\n{\r\nPSMgmtObject pMgmt = &(pDevice->sMgmtObj);\r\nif ((pMgmt->eAuthenMode == WMAC_AUTH_WPAPSK) ||\r\n(pMgmt->eAuthenMode == WMAC_AUTH_WPA2PSK)) {\r\nif(pCurr->bWPAValid == TRUE) {\r\npMgmt->eAuthenMode = WMAC_AUTH_WPAPSK;\r\nif(pCurr->abyPKType[0] == WPA_TKIP) {\r\npDevice->eEncryptionStatus = Ndis802_11Encryption2Enabled;\r\nPRINT_K("Encyption_Rebuild--->ssid reset config to [WPAPSK-TKIP]\n");\r\n}\r\nelse if(pCurr->abyPKType[0] == WPA_AESCCMP) {\r\npDevice->eEncryptionStatus = Ndis802_11Encryption3Enabled;\r\nPRINT_K("Encyption_Rebuild--->ssid reset config to [WPAPSK-AES]\n");\r\n}\r\n}\r\nelse if(pCurr->bWPA2Valid == TRUE) {\r\npMgmt->eAuthenMode = WMAC_AUTH_WPA2PSK;\r\nif(pCurr->abyCSSPK[0] == WLAN_11i_CSS_TKIP) {\r\npDevice->eEncryptionStatus = Ndis802_11Encryption2Enabled;\r\nPRINT_K("Encyption_Rebuild--->ssid reset config to [WPA2PSK-TKIP]\n");\r\n}\r\nelse if(pCurr->abyCSSPK[0] == WLAN_11i_CSS_CCMP) {\r\npDevice->eEncryptionStatus = Ndis802_11Encryption3Enabled;\r\nPRINT_K("Encyption_Rebuild--->ssid reset config to [WPA2PSK-AES]\n");\r\n}\r\n}\r\n}\r\nreturn;\r\n}\r\nstatic\r\nvoid\r\ns_vMgrFormatTIM(\r\nPSMgmtObject pMgmt,\r\nPWLAN_IE_TIM pTIM\r\n)\r\n{\r\nBYTE byMask[8] = {1, 2, 4, 8, 0x10, 0x20, 0x40, 0x80};\r\nBYTE byMap;\r\nunsigned int ii, jj;\r\nBOOL bStartFound = FALSE;\r\nBOOL bMulticast = FALSE;\r\nWORD wStartIndex = 0;\r\nWORD wEndIndex = 0;\r\nfor (ii = 0; ii < (MAX_NODE_NUM + 1); ii++) {\r\nbyMap = pMgmt->abyPSTxMap[ii];\r\nif (!ii) {\r\nbMulticast = (byMap & byMask[0]) != 0;\r\nif(bMulticast) {\r\npMgmt->sNodeDBTable[0].bRxPSPoll = TRUE;\r\n}\r\nbyMap = 0;\r\n}\r\nif (byMap) {\r\nif (!bStartFound) {\r\nbStartFound = TRUE;\r\nwStartIndex = (WORD)ii;\r\n}\r\nwEndIndex = (WORD)ii;\r\n}\r\n}\r\nwStartIndex &= ~BIT0;\r\nwEndIndex = ((wEndIndex + 1) & ~BIT0);\r\npTIM->len = 3 + (wEndIndex - wStartIndex) + 1;\r\npTIM->byDTIMCount = pMgmt->byDTIMCount;\r\npTIM->byDTIMPeriod = pMgmt->byDTIMPeriod;\r\npTIM->byBitMapCtl = (bMulticast ? TIM_MULTICAST_MASK : 0) |\r\n(((wStartIndex >> 1) << 1) & TIM_BITMAPOFFSET_MASK);\r\nfor (ii = wStartIndex, jj =0 ; ii <= wEndIndex; ii++, jj++) {\r\npTIM->byVirtBitMap[jj] = pMgmt->abyPSTxMap[ii];\r\n}\r\npTIM->byVirtBitMap[0] &= ~BIT0;\r\n}\r\nstatic\r\nPSTxMgmtPacket\r\ns_MgrMakeBeacon(\r\nPSDevice pDevice,\r\nPSMgmtObject pMgmt,\r\nWORD wCurrCapInfo,\r\nWORD wCurrBeaconPeriod,\r\nunsigned int uCurrChannel,\r\nWORD wCurrATIMWinodw,\r\nPWLAN_IE_SSID pCurrSSID,\r\nPBYTE pCurrBSSID,\r\nPWLAN_IE_SUPP_RATES pCurrSuppRates,\r\nPWLAN_IE_SUPP_RATES pCurrExtSuppRates\r\n)\r\n{\r\nPSTxMgmtPacket pTxPacket = NULL;\r\nWLAN_FR_BEACON sFrame;\r\nBYTE abyBroadcastAddr[] = {0xff, 0xff, 0xff, 0xff, 0xff, 0xff};\r\npTxPacket = (PSTxMgmtPacket)pMgmt->pbyMgmtPacketPool;\r\nmemset(pTxPacket, 0, sizeof(STxMgmtPacket) + WLAN_BEACON_FR_MAXLEN);\r\npTxPacket->p80211Header = (PUWLAN_80211HDR)((PBYTE)pTxPacket + sizeof(STxMgmtPacket));\r\nsFrame.pBuf = (PBYTE)pTxPacket->p80211Header;\r\nsFrame.len = WLAN_BEACON_FR_MAXLEN;\r\nvMgrEncodeBeacon(&sFrame);\r\nsFrame.pHdr->sA3.wFrameCtl = cpu_to_le16(\r\n(\r\nWLAN_SET_FC_FTYPE(WLAN_TYPE_MGR) |\r\nWLAN_SET_FC_FSTYPE(WLAN_FSTYPE_BEACON)\r\n));\r\nif (pDevice->bEnablePSMode) {\r\nsFrame.pHdr->sA3.wFrameCtl |= cpu_to_le16((WORD)WLAN_SET_FC_PWRMGT(1));\r\n}\r\nmemcpy( sFrame.pHdr->sA3.abyAddr1, abyBroadcastAddr, WLAN_ADDR_LEN);\r\nmemcpy( sFrame.pHdr->sA3.abyAddr2, pMgmt->abyMACAddr, WLAN_ADDR_LEN);\r\nmemcpy( sFrame.pHdr->sA3.abyAddr3, pCurrBSSID, WLAN_BSSID_LEN);\r\n*sFrame.pwBeaconInterval = cpu_to_le16(wCurrBeaconPeriod);\r\n*sFrame.pwCapInfo = cpu_to_le16(wCurrCapInfo);\r\nsFrame.pSSID = (PWLAN_IE_SSID)(sFrame.pBuf + sFrame.len);\r\nsFrame.len += ((PWLAN_IE_SSID)pMgmt->abyCurrSSID)->len + WLAN_IEHDR_LEN;\r\nmemcpy(sFrame.pSSID,\r\npCurrSSID,\r\n((PWLAN_IE_SSID)pCurrSSID)->len + WLAN_IEHDR_LEN\r\n);\r\nsFrame.pSuppRates = (PWLAN_IE_SUPP_RATES)(sFrame.pBuf + sFrame.len);\r\nsFrame.len += ((PWLAN_IE_SUPP_RATES)pCurrSuppRates)->len + WLAN_IEHDR_LEN;\r\nmemcpy(sFrame.pSuppRates,\r\npCurrSuppRates,\r\n((PWLAN_IE_SUPP_RATES)pCurrSuppRates)->len + WLAN_IEHDR_LEN\r\n);\r\nif (pDevice->byBBType != BB_TYPE_11A) {\r\nsFrame.pDSParms = (PWLAN_IE_DS_PARMS)(sFrame.pBuf + sFrame.len);\r\nsFrame.len += (1) + WLAN_IEHDR_LEN;\r\nsFrame.pDSParms->byElementID = WLAN_EID_DS_PARMS;\r\nsFrame.pDSParms->len = 1;\r\nsFrame.pDSParms->byCurrChannel = (BYTE)uCurrChannel;\r\n}\r\nif (pMgmt->eCurrMode == WMAC_MODE_ESS_AP) {\r\nsFrame.pTIM = (PWLAN_IE_TIM)(sFrame.pBuf + sFrame.len);\r\nsFrame.pTIM->byElementID = WLAN_EID_TIM;\r\ns_vMgrFormatTIM(pMgmt, sFrame.pTIM);\r\nsFrame.len += (WLAN_IEHDR_LEN + sFrame.pTIM->len);\r\n}\r\nif (pMgmt->eCurrMode == WMAC_MODE_IBSS_STA) {\r\nsFrame.pIBSSParms = (PWLAN_IE_IBSS_PARMS)(sFrame.pBuf + sFrame.len);\r\nsFrame.len += (2) + WLAN_IEHDR_LEN;\r\nsFrame.pIBSSParms->byElementID = WLAN_EID_IBSS_PARMS;\r\nsFrame.pIBSSParms->len = 2;\r\nsFrame.pIBSSParms->wATIMWindow = wCurrATIMWinodw;\r\nif (pMgmt->eAuthenMode == WMAC_AUTH_WPANONE) {\r\nsFrame.pRSNWPA = (PWLAN_IE_RSN_EXT)(sFrame.pBuf + sFrame.len);\r\nsFrame.pRSNWPA->byElementID = WLAN_EID_RSN_WPA;\r\nsFrame.pRSNWPA->len = 12;\r\nsFrame.pRSNWPA->abyOUI[0] = 0x00;\r\nsFrame.pRSNWPA->abyOUI[1] = 0x50;\r\nsFrame.pRSNWPA->abyOUI[2] = 0xf2;\r\nsFrame.pRSNWPA->abyOUI[3] = 0x01;\r\nsFrame.pRSNWPA->wVersion = 1;\r\nsFrame.pRSNWPA->abyMulticast[0] = 0x00;\r\nsFrame.pRSNWPA->abyMulticast[1] = 0x50;\r\nsFrame.pRSNWPA->abyMulticast[2] = 0xf2;\r\nif (pDevice->eEncryptionStatus == Ndis802_11Encryption3Enabled)\r\nsFrame.pRSNWPA->abyMulticast[3] = 0x04;\r\nelse if (pDevice->eEncryptionStatus == Ndis802_11Encryption2Enabled)\r\nsFrame.pRSNWPA->abyMulticast[3] = 0x02;\r\nelse if (pDevice->eEncryptionStatus == Ndis802_11Encryption1Enabled)\r\nsFrame.pRSNWPA->abyMulticast[3] = 0x01;\r\nelse\r\nsFrame.pRSNWPA->abyMulticast[3] = 0x00;\r\nsFrame.pRSNWPA->wPKCount = 0;\r\n*((PWORD)(sFrame.pBuf + sFrame.len + sFrame.pRSNWPA->len))=0;\r\nsFrame.pRSNWPA->len +=2;\r\n*((PWORD)(sFrame.pBuf + sFrame.len + sFrame.pRSNWPA->len))=0;\r\nsFrame.pRSNWPA->len +=2;\r\nsFrame.len += sFrame.pRSNWPA->len + WLAN_IEHDR_LEN;\r\n}\r\n}\r\nif (pMgmt->eCurrentPHYMode == PHY_TYPE_11G) {\r\nsFrame.pERP = (PWLAN_IE_ERP)(sFrame.pBuf + sFrame.len);\r\nsFrame.len += 1 + WLAN_IEHDR_LEN;\r\nsFrame.pERP->byElementID = WLAN_EID_ERP;\r\nsFrame.pERP->len = 1;\r\nsFrame.pERP->byContext = 0;\r\nif (pDevice->bProtectMode == TRUE)\r\nsFrame.pERP->byContext |= WLAN_EID_ERP_USE_PROTECTION;\r\nif (pDevice->bNonERPPresent == TRUE)\r\nsFrame.pERP->byContext |= WLAN_EID_ERP_NONERP_PRESENT;\r\nif (pDevice->bBarkerPreambleMd == TRUE)\r\nsFrame.pERP->byContext |= WLAN_EID_ERP_BARKER_MODE;\r\n}\r\nif (((PWLAN_IE_SUPP_RATES)pCurrExtSuppRates)->len != 0) {\r\nsFrame.pExtSuppRates = (PWLAN_IE_SUPP_RATES)(sFrame.pBuf + sFrame.len);\r\nsFrame.len += ((PWLAN_IE_SUPP_RATES)pCurrExtSuppRates)->len + WLAN_IEHDR_LEN;\r\nmemcpy(sFrame.pExtSuppRates,\r\npCurrExtSuppRates,\r\n((PWLAN_IE_SUPP_RATES)pCurrExtSuppRates)->len + WLAN_IEHDR_LEN\r\n);\r\n}\r\nif ((pMgmt->eCurrMode == WMAC_MODE_ESS_AP) && (pDevice->bEnableHostapd == TRUE)) {\r\nif (pMgmt->eAuthenMode == WMAC_AUTH_WPANONE) {\r\nif (pMgmt->wWPAIELen != 0) {\r\nsFrame.pRSN = (PWLAN_IE_RSN)(sFrame.pBuf + sFrame.len);\r\nmemcpy(sFrame.pRSN, pMgmt->abyWPAIE, pMgmt->wWPAIELen);\r\nsFrame.len += pMgmt->wWPAIELen;\r\n}\r\n}\r\n}\r\npTxPacket->cbMPDULen = sFrame.len;\r\npTxPacket->cbPayloadLen = sFrame.len - WLAN_HDR_ADDR3_LEN;\r\nreturn pTxPacket;\r\n}\r\nPSTxMgmtPacket\r\ns_MgrMakeProbeResponse(\r\nPSDevice pDevice,\r\nPSMgmtObject pMgmt,\r\nWORD wCurrCapInfo,\r\nWORD wCurrBeaconPeriod,\r\nunsigned int uCurrChannel,\r\nWORD wCurrATIMWinodw,\r\nPBYTE pDstAddr,\r\nPWLAN_IE_SSID pCurrSSID,\r\nPBYTE pCurrBSSID,\r\nPWLAN_IE_SUPP_RATES pCurrSuppRates,\r\nPWLAN_IE_SUPP_RATES pCurrExtSuppRates,\r\nBYTE byPHYType\r\n)\r\n{\r\nPSTxMgmtPacket pTxPacket = NULL;\r\nWLAN_FR_PROBERESP sFrame;\r\npTxPacket = (PSTxMgmtPacket)pMgmt->pbyMgmtPacketPool;\r\nmemset(pTxPacket, 0, sizeof(STxMgmtPacket) + WLAN_PROBERESP_FR_MAXLEN);\r\npTxPacket->p80211Header = (PUWLAN_80211HDR)((PBYTE)pTxPacket + sizeof(STxMgmtPacket));\r\nsFrame.pBuf = (PBYTE)pTxPacket->p80211Header;\r\nsFrame.len = WLAN_PROBERESP_FR_MAXLEN;\r\nvMgrEncodeProbeResponse(&sFrame);\r\nsFrame.pHdr->sA3.wFrameCtl = cpu_to_le16(\r\n(\r\nWLAN_SET_FC_FTYPE(WLAN_TYPE_MGR) |\r\nWLAN_SET_FC_FSTYPE(WLAN_FSTYPE_PROBERESP)\r\n));\r\nmemcpy( sFrame.pHdr->sA3.abyAddr1, pDstAddr, WLAN_ADDR_LEN);\r\nmemcpy( sFrame.pHdr->sA3.abyAddr2, pMgmt->abyMACAddr, WLAN_ADDR_LEN);\r\nmemcpy( sFrame.pHdr->sA3.abyAddr3, pCurrBSSID, WLAN_BSSID_LEN);\r\n*sFrame.pwBeaconInterval = cpu_to_le16(wCurrBeaconPeriod);\r\n*sFrame.pwCapInfo = cpu_to_le16(wCurrCapInfo);\r\nif (byPHYType == BB_TYPE_11B) {\r\n*sFrame.pwCapInfo &= cpu_to_le16((WORD)~(WLAN_SET_CAP_INFO_SHORTSLOTTIME(1)));\r\n}\r\nsFrame.pSSID = (PWLAN_IE_SSID)(sFrame.pBuf + sFrame.len);\r\nsFrame.len += ((PWLAN_IE_SSID)pMgmt->abyCurrSSID)->len + WLAN_IEHDR_LEN;\r\nmemcpy(sFrame.pSSID,\r\npCurrSSID,\r\n((PWLAN_IE_SSID)pCurrSSID)->len + WLAN_IEHDR_LEN\r\n);\r\nsFrame.pSuppRates = (PWLAN_IE_SUPP_RATES)(sFrame.pBuf + sFrame.len);\r\nsFrame.len += ((PWLAN_IE_SUPP_RATES)pCurrSuppRates)->len + WLAN_IEHDR_LEN;\r\nmemcpy(sFrame.pSuppRates,\r\npCurrSuppRates,\r\n((PWLAN_IE_SUPP_RATES)pCurrSuppRates)->len + WLAN_IEHDR_LEN\r\n);\r\nif (pDevice->byBBType != BB_TYPE_11A) {\r\nsFrame.pDSParms = (PWLAN_IE_DS_PARMS)(sFrame.pBuf + sFrame.len);\r\nsFrame.len += (1) + WLAN_IEHDR_LEN;\r\nsFrame.pDSParms->byElementID = WLAN_EID_DS_PARMS;\r\nsFrame.pDSParms->len = 1;\r\nsFrame.pDSParms->byCurrChannel = (BYTE)uCurrChannel;\r\n}\r\nif (pMgmt->eCurrMode != WMAC_MODE_ESS_AP) {\r\nsFrame.pIBSSParms = (PWLAN_IE_IBSS_PARMS)(sFrame.pBuf + sFrame.len);\r\nsFrame.len += (2) + WLAN_IEHDR_LEN;\r\nsFrame.pIBSSParms->byElementID = WLAN_EID_IBSS_PARMS;\r\nsFrame.pIBSSParms->len = 2;\r\nsFrame.pIBSSParms->wATIMWindow = 0;\r\n}\r\nif (pDevice->byBBType == BB_TYPE_11G) {\r\nsFrame.pERP = (PWLAN_IE_ERP)(sFrame.pBuf + sFrame.len);\r\nsFrame.len += 1 + WLAN_IEHDR_LEN;\r\nsFrame.pERP->byElementID = WLAN_EID_ERP;\r\nsFrame.pERP->len = 1;\r\nsFrame.pERP->byContext = 0;\r\nif (pDevice->bProtectMode == TRUE)\r\nsFrame.pERP->byContext |= WLAN_EID_ERP_USE_PROTECTION;\r\nif (pDevice->bNonERPPresent == TRUE)\r\nsFrame.pERP->byContext |= WLAN_EID_ERP_NONERP_PRESENT;\r\nif (pDevice->bBarkerPreambleMd == TRUE)\r\nsFrame.pERP->byContext |= WLAN_EID_ERP_BARKER_MODE;\r\n}\r\nif (((PWLAN_IE_SUPP_RATES)pCurrExtSuppRates)->len != 0) {\r\nsFrame.pExtSuppRates = (PWLAN_IE_SUPP_RATES)(sFrame.pBuf + sFrame.len);\r\nsFrame.len += ((PWLAN_IE_SUPP_RATES)pCurrExtSuppRates)->len + WLAN_IEHDR_LEN;\r\nmemcpy(sFrame.pExtSuppRates,\r\npCurrExtSuppRates,\r\n((PWLAN_IE_SUPP_RATES)pCurrExtSuppRates)->len + WLAN_IEHDR_LEN\r\n);\r\n}\r\nif ((pMgmt->eCurrMode == WMAC_MODE_ESS_AP) && (pDevice->bEnableHostapd == TRUE)) {\r\nif (pMgmt->eAuthenMode == WMAC_AUTH_WPANONE) {\r\nif (pMgmt->wWPAIELen != 0) {\r\nsFrame.pRSN = (PWLAN_IE_RSN)(sFrame.pBuf + sFrame.len);\r\nmemcpy(sFrame.pRSN, pMgmt->abyWPAIE, pMgmt->wWPAIELen);\r\nsFrame.len += pMgmt->wWPAIELen;\r\n}\r\n}\r\n}\r\npTxPacket->cbMPDULen = sFrame.len;\r\npTxPacket->cbPayloadLen = sFrame.len - WLAN_HDR_ADDR3_LEN;\r\nreturn pTxPacket;\r\n}\r\nPSTxMgmtPacket\r\ns_MgrMakeAssocRequest(\r\nPSDevice pDevice,\r\nPSMgmtObject pMgmt,\r\nPBYTE pDAddr,\r\nWORD wCurrCapInfo,\r\nWORD wListenInterval,\r\nPWLAN_IE_SSID pCurrSSID,\r\nPWLAN_IE_SUPP_RATES pCurrRates,\r\nPWLAN_IE_SUPP_RATES pCurrExtSuppRates\r\n)\r\n{\r\nPSTxMgmtPacket pTxPacket = NULL;\r\nWLAN_FR_ASSOCREQ sFrame;\r\nPBYTE pbyIEs;\r\nPBYTE pbyRSN;\r\npTxPacket = (PSTxMgmtPacket)pMgmt->pbyMgmtPacketPool;\r\nmemset(pTxPacket, 0, sizeof(STxMgmtPacket) + WLAN_ASSOCREQ_FR_MAXLEN);\r\npTxPacket->p80211Header = (PUWLAN_80211HDR)((PBYTE)pTxPacket + sizeof(STxMgmtPacket));\r\nsFrame.pBuf = (PBYTE)pTxPacket->p80211Header;\r\nsFrame.len = WLAN_ASSOCREQ_FR_MAXLEN;\r\nvMgrEncodeAssocRequest(&sFrame);\r\nsFrame.pHdr->sA3.wFrameCtl = cpu_to_le16(\r\n(\r\nWLAN_SET_FC_FTYPE(WLAN_TYPE_MGR) |\r\nWLAN_SET_FC_FSTYPE(WLAN_FSTYPE_ASSOCREQ)\r\n));\r\nmemcpy( sFrame.pHdr->sA3.abyAddr1, pDAddr, WLAN_ADDR_LEN);\r\nmemcpy( sFrame.pHdr->sA3.abyAddr2, pMgmt->abyMACAddr, WLAN_ADDR_LEN);\r\nmemcpy( sFrame.pHdr->sA3.abyAddr3, pMgmt->abyCurrBSSID, WLAN_BSSID_LEN);\r\n*(sFrame.pwCapInfo) = cpu_to_le16(wCurrCapInfo);\r\n*(sFrame.pwListenInterval) = cpu_to_le16(wListenInterval);\r\nsFrame.pSSID = (PWLAN_IE_SSID)(sFrame.pBuf + sFrame.len);\r\nsFrame.len += pCurrSSID->len + WLAN_IEHDR_LEN;\r\nmemcpy(sFrame.pSSID, pCurrSSID, pCurrSSID->len + WLAN_IEHDR_LEN);\r\npMgmt->sAssocInfo.AssocInfo.RequestIELength = pCurrSSID->len + WLAN_IEHDR_LEN;\r\npMgmt->sAssocInfo.AssocInfo.OffsetRequestIEs = sizeof(NDIS_802_11_ASSOCIATION_INFORMATION);\r\npbyIEs = pMgmt->sAssocInfo.abyIEs;\r\nmemcpy(pbyIEs, pCurrSSID, pCurrSSID->len + WLAN_IEHDR_LEN);\r\npbyIEs += pCurrSSID->len + WLAN_IEHDR_LEN;\r\nsFrame.pSuppRates = (PWLAN_IE_SUPP_RATES)(sFrame.pBuf + sFrame.len);\r\nif ((pDevice->byBBType == BB_TYPE_11B) && (pCurrRates->len > 4))\r\nsFrame.len += 4 + WLAN_IEHDR_LEN;\r\nelse\r\nsFrame.len += pCurrRates->len + WLAN_IEHDR_LEN;\r\nmemcpy(sFrame.pSuppRates, pCurrRates, pCurrRates->len + WLAN_IEHDR_LEN);\r\nif ((pDevice->byBBType == BB_TYPE_11G) && (pCurrExtSuppRates->len > 0)) {\r\nsFrame.pExtSuppRates = (PWLAN_IE_SUPP_RATES)(sFrame.pBuf + sFrame.len);\r\nsFrame.len += pCurrExtSuppRates->len + WLAN_IEHDR_LEN;\r\nmemcpy(sFrame.pExtSuppRates, pCurrExtSuppRates, pCurrExtSuppRates->len + WLAN_IEHDR_LEN);\r\n}\r\npMgmt->sAssocInfo.AssocInfo.RequestIELength += pCurrRates->len + WLAN_IEHDR_LEN;\r\nmemcpy(pbyIEs, pCurrRates, pCurrRates->len + WLAN_IEHDR_LEN);\r\npbyIEs += pCurrRates->len + WLAN_IEHDR_LEN;\r\nif (((pMgmt->eAuthenMode == WMAC_AUTH_WPA) ||\r\n(pMgmt->eAuthenMode == WMAC_AUTH_WPAPSK) ||\r\n(pMgmt->eAuthenMode == WMAC_AUTH_WPANONE)) &&\r\n(pMgmt->pCurrBSS != NULL)) {\r\nsFrame.pRSNWPA = (PWLAN_IE_RSN_EXT)(sFrame.pBuf + sFrame.len);\r\nsFrame.pRSNWPA->byElementID = WLAN_EID_RSN_WPA;\r\nsFrame.pRSNWPA->len = 16;\r\nsFrame.pRSNWPA->abyOUI[0] = 0x00;\r\nsFrame.pRSNWPA->abyOUI[1] = 0x50;\r\nsFrame.pRSNWPA->abyOUI[2] = 0xf2;\r\nsFrame.pRSNWPA->abyOUI[3] = 0x01;\r\nsFrame.pRSNWPA->wVersion = 1;\r\nsFrame.pRSNWPA->abyMulticast[0] = 0x00;\r\nsFrame.pRSNWPA->abyMulticast[1] = 0x50;\r\nsFrame.pRSNWPA->abyMulticast[2] = 0xf2;\r\nif (pMgmt->byCSSGK == KEY_CTL_WEP) {\r\nsFrame.pRSNWPA->abyMulticast[3] = pMgmt->pCurrBSS->byGKType;\r\n} else if (pMgmt->byCSSGK == KEY_CTL_TKIP) {\r\nsFrame.pRSNWPA->abyMulticast[3] = WPA_TKIP;\r\n} else if (pMgmt->byCSSGK == KEY_CTL_CCMP) {\r\nsFrame.pRSNWPA->abyMulticast[3] = WPA_AESCCMP;\r\n} else {\r\nsFrame.pRSNWPA->abyMulticast[3] = WPA_NONE;\r\n}\r\nsFrame.pRSNWPA->wPKCount = 1;\r\nsFrame.pRSNWPA->PKSList[0].abyOUI[0] = 0x00;\r\nsFrame.pRSNWPA->PKSList[0].abyOUI[1] = 0x50;\r\nsFrame.pRSNWPA->PKSList[0].abyOUI[2] = 0xf2;\r\nif (pMgmt->byCSSPK == KEY_CTL_TKIP) {\r\nsFrame.pRSNWPA->PKSList[0].abyOUI[3] = WPA_TKIP;\r\n} else if (pMgmt->byCSSPK == KEY_CTL_CCMP) {\r\nsFrame.pRSNWPA->PKSList[0].abyOUI[3] = WPA_AESCCMP;\r\n} else {\r\nsFrame.pRSNWPA->PKSList[0].abyOUI[3] = WPA_NONE;\r\n}\r\npbyRSN = (PBYTE)(sFrame.pBuf + sFrame.len + 2 + sFrame.pRSNWPA->len);\r\n*pbyRSN++=0x01;\r\n*pbyRSN++=0x00;\r\n*pbyRSN++=0x00;\r\n*pbyRSN++=0x50;\r\n*pbyRSN++=0xf2;\r\nif (pMgmt->eAuthenMode == WMAC_AUTH_WPAPSK) {\r\n*pbyRSN++=WPA_AUTH_PSK;\r\n}\r\nelse if (pMgmt->eAuthenMode == WMAC_AUTH_WPA) {\r\n*pbyRSN++=WPA_AUTH_IEEE802_1X;\r\n}\r\nelse {\r\n*pbyRSN++=WPA_NONE;\r\n}\r\nsFrame.pRSNWPA->len +=6;\r\n*pbyRSN++=0x00;\r\n*pbyRSN++=0x00;\r\nsFrame.pRSNWPA->len +=2;\r\nsFrame.len += sFrame.pRSNWPA->len + WLAN_IEHDR_LEN;\r\npMgmt->sAssocInfo.AssocInfo.RequestIELength += sFrame.pRSNWPA->len + WLAN_IEHDR_LEN;\r\nmemcpy(pbyIEs, sFrame.pRSNWPA, sFrame.pRSNWPA->len + WLAN_IEHDR_LEN);\r\npbyIEs += sFrame.pRSNWPA->len + WLAN_IEHDR_LEN;\r\n} else if (((pMgmt->eAuthenMode == WMAC_AUTH_WPA2) ||\r\n(pMgmt->eAuthenMode == WMAC_AUTH_WPA2PSK)) &&\r\n(pMgmt->pCurrBSS != NULL)) {\r\nunsigned int ii;\r\nPWORD pwPMKID;\r\nsFrame.pRSN = (PWLAN_IE_RSN)(sFrame.pBuf + sFrame.len);\r\nsFrame.pRSN->byElementID = WLAN_EID_RSN;\r\nsFrame.pRSN->len = 6;\r\nsFrame.pRSN->wVersion = 1;\r\nsFrame.pRSN->abyRSN[0] = 0x00;\r\nsFrame.pRSN->abyRSN[1] = 0x0F;\r\nsFrame.pRSN->abyRSN[2] = 0xAC;\r\nif (pMgmt->byCSSGK == KEY_CTL_WEP) {\r\nsFrame.pRSN->abyRSN[3] = pMgmt->pCurrBSS->byCSSGK;\r\n} else if (pMgmt->byCSSGK == KEY_CTL_TKIP) {\r\nsFrame.pRSN->abyRSN[3] = WLAN_11i_CSS_TKIP;\r\n} else if (pMgmt->byCSSGK == KEY_CTL_CCMP) {\r\nsFrame.pRSN->abyRSN[3] = WLAN_11i_CSS_CCMP;\r\n} else {\r\nsFrame.pRSN->abyRSN[3] = WLAN_11i_CSS_UNKNOWN;\r\n}\r\nsFrame.pRSN->abyRSN[4] = 1;\r\nsFrame.pRSN->abyRSN[5] = 0;\r\nsFrame.pRSN->abyRSN[6] = 0x00;\r\nsFrame.pRSN->abyRSN[7] = 0x0F;\r\nsFrame.pRSN->abyRSN[8] = 0xAC;\r\nif (pMgmt->byCSSPK == KEY_CTL_TKIP) {\r\nsFrame.pRSN->abyRSN[9] = WLAN_11i_CSS_TKIP;\r\n} else if (pMgmt->byCSSPK == KEY_CTL_CCMP) {\r\nsFrame.pRSN->abyRSN[9] = WLAN_11i_CSS_CCMP;\r\n} else if (pMgmt->byCSSPK == KEY_CTL_NONE) {\r\nsFrame.pRSN->abyRSN[9] = WLAN_11i_CSS_USE_GROUP;\r\n} else {\r\nsFrame.pRSN->abyRSN[9] = WLAN_11i_CSS_UNKNOWN;\r\n}\r\nsFrame.pRSN->len += 6;\r\nsFrame.pRSN->abyRSN[10] = 1;\r\nsFrame.pRSN->abyRSN[11] = 0;\r\nsFrame.pRSN->abyRSN[12] = 0x00;\r\nsFrame.pRSN->abyRSN[13] = 0x0F;\r\nsFrame.pRSN->abyRSN[14] = 0xAC;\r\nif (pMgmt->eAuthenMode == WMAC_AUTH_WPA2PSK) {\r\nsFrame.pRSN->abyRSN[15] = WLAN_11i_AKMSS_PSK;\r\n} else if (pMgmt->eAuthenMode == WMAC_AUTH_WPA2) {\r\nsFrame.pRSN->abyRSN[15] = WLAN_11i_AKMSS_802_1X;\r\n} else {\r\nsFrame.pRSN->abyRSN[15] = WLAN_11i_AKMSS_UNKNOWN;\r\n}\r\nsFrame.pRSN->len +=6;\r\nif (pMgmt->pCurrBSS->sRSNCapObj.bRSNCapExist == TRUE) {\r\nmemcpy(&sFrame.pRSN->abyRSN[16], &pMgmt->pCurrBSS->sRSNCapObj.wRSNCap, 2);\r\n} else {\r\nsFrame.pRSN->abyRSN[16] = 0;\r\nsFrame.pRSN->abyRSN[17] = 0;\r\n}\r\nsFrame.pRSN->len +=2;\r\nif ((pDevice->gsPMKID.BSSIDInfoCount > 0) && (pDevice->bRoaming == TRUE) && (pMgmt->eAuthenMode == WMAC_AUTH_WPA2)) {\r\npbyRSN = &sFrame.pRSN->abyRSN[18];\r\npwPMKID = (PWORD)pbyRSN;\r\n*pwPMKID = 0;\r\npbyRSN += 2;\r\nfor (ii = 0; ii < pDevice->gsPMKID.BSSIDInfoCount; ii++) {\r\nif (!memcmp(&pDevice->gsPMKID.BSSIDInfo[ii].BSSID[0],\r\npMgmt->abyCurrBSSID,\r\nETH_ALEN)) {\r\n(*pwPMKID)++;\r\nmemcpy(pbyRSN,\r\npDevice->gsPMKID.BSSIDInfo[ii].PMKID,\r\n16);\r\npbyRSN += 16;\r\n}\r\n}\r\nif (*pwPMKID != 0) {\r\nsFrame.pRSN->len += (2 + (*pwPMKID)*16);\r\n}\r\n}\r\nsFrame.len += sFrame.pRSN->len + WLAN_IEHDR_LEN;\r\npMgmt->sAssocInfo.AssocInfo.RequestIELength += sFrame.pRSN->len + WLAN_IEHDR_LEN;\r\nmemcpy(pbyIEs, sFrame.pRSN, sFrame.pRSN->len + WLAN_IEHDR_LEN);\r\npbyIEs += sFrame.pRSN->len + WLAN_IEHDR_LEN;\r\n}\r\npTxPacket->cbMPDULen = sFrame.len;\r\npTxPacket->cbPayloadLen = sFrame.len - WLAN_HDR_ADDR3_LEN;\r\nreturn pTxPacket;\r\n}\r\nPSTxMgmtPacket\r\ns_MgrMakeReAssocRequest(\r\nPSDevice pDevice,\r\nPSMgmtObject pMgmt,\r\nPBYTE pDAddr,\r\nWORD wCurrCapInfo,\r\nWORD wListenInterval,\r\nPWLAN_IE_SSID pCurrSSID,\r\nPWLAN_IE_SUPP_RATES pCurrRates,\r\nPWLAN_IE_SUPP_RATES pCurrExtSuppRates\r\n)\r\n{\r\nPSTxMgmtPacket pTxPacket = NULL;\r\nWLAN_FR_REASSOCREQ sFrame;\r\nPBYTE pbyIEs;\r\nPBYTE pbyRSN;\r\npTxPacket = (PSTxMgmtPacket)pMgmt->pbyMgmtPacketPool;\r\nmemset( pTxPacket, 0, sizeof(STxMgmtPacket) + WLAN_REASSOCREQ_FR_MAXLEN);\r\npTxPacket->p80211Header = (PUWLAN_80211HDR)((PBYTE)pTxPacket + sizeof(STxMgmtPacket));\r\nsFrame.pBuf = (PBYTE)pTxPacket->p80211Header;\r\nsFrame.len = WLAN_REASSOCREQ_FR_MAXLEN;\r\nvMgrEncodeReassocRequest(&sFrame);\r\nsFrame.pHdr->sA3.wFrameCtl = cpu_to_le16(\r\n(\r\nWLAN_SET_FC_FTYPE(WLAN_TYPE_MGR) |\r\nWLAN_SET_FC_FSTYPE(WLAN_FSTYPE_REASSOCREQ)\r\n));\r\nmemcpy( sFrame.pHdr->sA3.abyAddr1, pDAddr, WLAN_ADDR_LEN);\r\nmemcpy( sFrame.pHdr->sA3.abyAddr2, pMgmt->abyMACAddr, WLAN_ADDR_LEN);\r\nmemcpy( sFrame.pHdr->sA3.abyAddr3, pMgmt->abyCurrBSSID, WLAN_BSSID_LEN);\r\n*(sFrame.pwCapInfo) = cpu_to_le16(wCurrCapInfo);\r\n*(sFrame.pwListenInterval) = cpu_to_le16(wListenInterval);\r\nmemcpy(sFrame.pAddrCurrAP, pMgmt->abyCurrBSSID, WLAN_BSSID_LEN);\r\nsFrame.pSSID = (PWLAN_IE_SSID)(sFrame.pBuf + sFrame.len);\r\nsFrame.len += pCurrSSID->len + WLAN_IEHDR_LEN;\r\nmemcpy(sFrame.pSSID, pCurrSSID, pCurrSSID->len + WLAN_IEHDR_LEN);\r\npMgmt->sAssocInfo.AssocInfo.RequestIELength = pCurrSSID->len + WLAN_IEHDR_LEN;\r\npMgmt->sAssocInfo.AssocInfo.OffsetRequestIEs = sizeof(NDIS_802_11_ASSOCIATION_INFORMATION);\r\npbyIEs = pMgmt->sAssocInfo.abyIEs;\r\nmemcpy(pbyIEs, pCurrSSID, pCurrSSID->len + WLAN_IEHDR_LEN);\r\npbyIEs += pCurrSSID->len + WLAN_IEHDR_LEN;\r\nsFrame.pSuppRates = (PWLAN_IE_SUPP_RATES)(sFrame.pBuf + sFrame.len);\r\nsFrame.len += pCurrRates->len + WLAN_IEHDR_LEN;\r\nmemcpy(sFrame.pSuppRates, pCurrRates, pCurrRates->len + WLAN_IEHDR_LEN);\r\nif ((pMgmt->eCurrentPHYMode == PHY_TYPE_11G) && (pCurrExtSuppRates->len > 0)) {\r\nsFrame.pExtSuppRates = (PWLAN_IE_SUPP_RATES)(sFrame.pBuf + sFrame.len);\r\nsFrame.len += pCurrExtSuppRates->len + WLAN_IEHDR_LEN;\r\nmemcpy(sFrame.pExtSuppRates, pCurrExtSuppRates, pCurrExtSuppRates->len + WLAN_IEHDR_LEN);\r\n}\r\npMgmt->sAssocInfo.AssocInfo.RequestIELength += pCurrRates->len + WLAN_IEHDR_LEN;\r\nmemcpy(pbyIEs, pCurrRates, pCurrRates->len + WLAN_IEHDR_LEN);\r\npbyIEs += pCurrRates->len + WLAN_IEHDR_LEN;\r\nif (((pMgmt->eAuthenMode == WMAC_AUTH_WPA) ||\r\n(pMgmt->eAuthenMode == WMAC_AUTH_WPAPSK) ||\r\n(pMgmt->eAuthenMode == WMAC_AUTH_WPANONE)) &&\r\n(pMgmt->pCurrBSS != NULL)) {\r\nsFrame.pRSNWPA = (PWLAN_IE_RSN_EXT)(sFrame.pBuf + sFrame.len);\r\nsFrame.pRSNWPA->byElementID = WLAN_EID_RSN_WPA;\r\nsFrame.pRSNWPA->len = 16;\r\nsFrame.pRSNWPA->abyOUI[0] = 0x00;\r\nsFrame.pRSNWPA->abyOUI[1] = 0x50;\r\nsFrame.pRSNWPA->abyOUI[2] = 0xf2;\r\nsFrame.pRSNWPA->abyOUI[3] = 0x01;\r\nsFrame.pRSNWPA->wVersion = 1;\r\nsFrame.pRSNWPA->abyMulticast[0] = 0x00;\r\nsFrame.pRSNWPA->abyMulticast[1] = 0x50;\r\nsFrame.pRSNWPA->abyMulticast[2] = 0xf2;\r\nif (pMgmt->byCSSGK == KEY_CTL_WEP) {\r\nsFrame.pRSNWPA->abyMulticast[3] = pMgmt->pCurrBSS->byGKType;\r\n} else if (pMgmt->byCSSGK == KEY_CTL_TKIP) {\r\nsFrame.pRSNWPA->abyMulticast[3] = WPA_TKIP;\r\n} else if (pMgmt->byCSSGK == KEY_CTL_CCMP) {\r\nsFrame.pRSNWPA->abyMulticast[3] = WPA_AESCCMP;\r\n} else {\r\nsFrame.pRSNWPA->abyMulticast[3] = WPA_NONE;\r\n}\r\nsFrame.pRSNWPA->wPKCount = 1;\r\nsFrame.pRSNWPA->PKSList[0].abyOUI[0] = 0x00;\r\nsFrame.pRSNWPA->PKSList[0].abyOUI[1] = 0x50;\r\nsFrame.pRSNWPA->PKSList[0].abyOUI[2] = 0xf2;\r\nif (pMgmt->byCSSPK == KEY_CTL_TKIP) {\r\nsFrame.pRSNWPA->PKSList[0].abyOUI[3] = WPA_TKIP;\r\n} else if (pMgmt->byCSSPK == KEY_CTL_CCMP) {\r\nsFrame.pRSNWPA->PKSList[0].abyOUI[3] = WPA_AESCCMP;\r\n} else {\r\nsFrame.pRSNWPA->PKSList[0].abyOUI[3] = WPA_NONE;\r\n}\r\npbyRSN = (PBYTE)(sFrame.pBuf + sFrame.len + 2 + sFrame.pRSNWPA->len);\r\n*pbyRSN++=0x01;\r\n*pbyRSN++=0x00;\r\n*pbyRSN++=0x00;\r\n*pbyRSN++=0x50;\r\n*pbyRSN++=0xf2;\r\nif (pMgmt->eAuthenMode == WMAC_AUTH_WPAPSK) {\r\n*pbyRSN++=WPA_AUTH_PSK;\r\n} else if (pMgmt->eAuthenMode == WMAC_AUTH_WPA) {\r\n*pbyRSN++=WPA_AUTH_IEEE802_1X;\r\n} else {\r\n*pbyRSN++=WPA_NONE;\r\n}\r\nsFrame.pRSNWPA->len +=6;\r\n*pbyRSN++=0x00;\r\n*pbyRSN++=0x00;\r\nsFrame.pRSNWPA->len +=2;\r\nsFrame.len += sFrame.pRSNWPA->len + WLAN_IEHDR_LEN;\r\npMgmt->sAssocInfo.AssocInfo.RequestIELength += sFrame.pRSNWPA->len + WLAN_IEHDR_LEN;\r\nmemcpy(pbyIEs, sFrame.pRSNWPA, sFrame.pRSNWPA->len + WLAN_IEHDR_LEN);\r\npbyIEs += sFrame.pRSNWPA->len + WLAN_IEHDR_LEN;\r\n} else if (((pMgmt->eAuthenMode == WMAC_AUTH_WPA2) ||\r\n(pMgmt->eAuthenMode == WMAC_AUTH_WPA2PSK)) &&\r\n(pMgmt->pCurrBSS != NULL)) {\r\nunsigned int ii;\r\nPWORD pwPMKID;\r\nsFrame.pRSN = (PWLAN_IE_RSN)(sFrame.pBuf + sFrame.len);\r\nsFrame.pRSN->byElementID = WLAN_EID_RSN;\r\nsFrame.pRSN->len = 6;\r\nsFrame.pRSN->wVersion = 1;\r\nsFrame.pRSN->abyRSN[0] = 0x00;\r\nsFrame.pRSN->abyRSN[1] = 0x0F;\r\nsFrame.pRSN->abyRSN[2] = 0xAC;\r\nif (pMgmt->byCSSGK == KEY_CTL_WEP) {\r\nsFrame.pRSN->abyRSN[3] = pMgmt->pCurrBSS->byCSSGK;\r\n} else if (pMgmt->byCSSGK == KEY_CTL_TKIP) {\r\nsFrame.pRSN->abyRSN[3] = WLAN_11i_CSS_TKIP;\r\n} else if (pMgmt->byCSSGK == KEY_CTL_CCMP) {\r\nsFrame.pRSN->abyRSN[3] = WLAN_11i_CSS_CCMP;\r\n} else {\r\nsFrame.pRSN->abyRSN[3] = WLAN_11i_CSS_UNKNOWN;\r\n}\r\nsFrame.pRSN->abyRSN[4] = 1;\r\nsFrame.pRSN->abyRSN[5] = 0;\r\nsFrame.pRSN->abyRSN[6] = 0x00;\r\nsFrame.pRSN->abyRSN[7] = 0x0F;\r\nsFrame.pRSN->abyRSN[8] = 0xAC;\r\nif (pMgmt->byCSSPK == KEY_CTL_TKIP) {\r\nsFrame.pRSN->abyRSN[9] = WLAN_11i_CSS_TKIP;\r\n} else if (pMgmt->byCSSPK == KEY_CTL_CCMP) {\r\nsFrame.pRSN->abyRSN[9] = WLAN_11i_CSS_CCMP;\r\n} else if (pMgmt->byCSSPK == KEY_CTL_NONE) {\r\nsFrame.pRSN->abyRSN[9] = WLAN_11i_CSS_USE_GROUP;\r\n} else {\r\nsFrame.pRSN->abyRSN[9] = WLAN_11i_CSS_UNKNOWN;\r\n}\r\nsFrame.pRSN->len += 6;\r\nsFrame.pRSN->abyRSN[10] = 1;\r\nsFrame.pRSN->abyRSN[11] = 0;\r\nsFrame.pRSN->abyRSN[12] = 0x00;\r\nsFrame.pRSN->abyRSN[13] = 0x0F;\r\nsFrame.pRSN->abyRSN[14] = 0xAC;\r\nif (pMgmt->eAuthenMode == WMAC_AUTH_WPA2PSK) {\r\nsFrame.pRSN->abyRSN[15] = WLAN_11i_AKMSS_PSK;\r\n} else if (pMgmt->eAuthenMode == WMAC_AUTH_WPA2) {\r\nsFrame.pRSN->abyRSN[15] = WLAN_11i_AKMSS_802_1X;\r\n} else {\r\nsFrame.pRSN->abyRSN[15] = WLAN_11i_AKMSS_UNKNOWN;\r\n}\r\nsFrame.pRSN->len +=6;\r\nif (pMgmt->pCurrBSS->sRSNCapObj.bRSNCapExist == TRUE) {\r\nmemcpy(&sFrame.pRSN->abyRSN[16], &pMgmt->pCurrBSS->sRSNCapObj.wRSNCap, 2);\r\n} else {\r\nsFrame.pRSN->abyRSN[16] = 0;\r\nsFrame.pRSN->abyRSN[17] = 0;\r\n}\r\nsFrame.pRSN->len +=2;\r\nif ((pDevice->gsPMKID.BSSIDInfoCount > 0) && (pDevice->bRoaming == TRUE) && (pMgmt->eAuthenMode == WMAC_AUTH_WPA2)) {\r\npbyRSN = &sFrame.pRSN->abyRSN[18];\r\npwPMKID = (PWORD)pbyRSN;\r\n*pwPMKID = 0;\r\npbyRSN += 2;\r\nfor (ii = 0; ii < pDevice->gsPMKID.BSSIDInfoCount; ii++) {\r\nif (!memcmp(&pDevice->gsPMKID.BSSIDInfo[ii].BSSID[0],\r\npMgmt->abyCurrBSSID,\r\nETH_ALEN)) {\r\n(*pwPMKID)++;\r\nmemcpy(pbyRSN,\r\npDevice->gsPMKID.BSSIDInfo[ii].PMKID,\r\n16);\r\npbyRSN += 16;\r\n}\r\n}\r\nif (*pwPMKID != 0) {\r\nsFrame.pRSN->len += (2 + (*pwPMKID)*16);\r\n}\r\n}\r\nsFrame.len += sFrame.pRSN->len + WLAN_IEHDR_LEN;\r\npMgmt->sAssocInfo.AssocInfo.RequestIELength += sFrame.pRSN->len + WLAN_IEHDR_LEN;\r\nmemcpy(pbyIEs, sFrame.pRSN, sFrame.pRSN->len + WLAN_IEHDR_LEN);\r\npbyIEs += sFrame.pRSN->len + WLAN_IEHDR_LEN;\r\n}\r\npTxPacket->cbMPDULen = sFrame.len;\r\npTxPacket->cbPayloadLen = sFrame.len - WLAN_HDR_ADDR3_LEN;\r\nreturn pTxPacket;\r\n}\r\nPSTxMgmtPacket\r\ns_MgrMakeAssocResponse(\r\nPSDevice pDevice,\r\nPSMgmtObject pMgmt,\r\nWORD wCurrCapInfo,\r\nWORD wAssocStatus,\r\nWORD wAssocAID,\r\nPBYTE pDstAddr,\r\nPWLAN_IE_SUPP_RATES pCurrSuppRates,\r\nPWLAN_IE_SUPP_RATES pCurrExtSuppRates\r\n)\r\n{\r\nPSTxMgmtPacket pTxPacket = NULL;\r\nWLAN_FR_ASSOCRESP sFrame;\r\npTxPacket = (PSTxMgmtPacket)pMgmt->pbyMgmtPacketPool;\r\nmemset(pTxPacket, 0, sizeof(STxMgmtPacket) + WLAN_ASSOCREQ_FR_MAXLEN);\r\npTxPacket->p80211Header = (PUWLAN_80211HDR)((PBYTE)pTxPacket + sizeof(STxMgmtPacket));\r\nsFrame.pBuf = (PBYTE)pTxPacket->p80211Header;\r\nsFrame.len = WLAN_REASSOCRESP_FR_MAXLEN;\r\nvMgrEncodeAssocResponse(&sFrame);\r\nsFrame.pHdr->sA3.wFrameCtl = cpu_to_le16(\r\n(\r\nWLAN_SET_FC_FTYPE(WLAN_TYPE_MGR) |\r\nWLAN_SET_FC_FSTYPE(WLAN_FSTYPE_ASSOCRESP)\r\n));\r\nmemcpy( sFrame.pHdr->sA3.abyAddr1, pDstAddr, WLAN_ADDR_LEN);\r\nmemcpy( sFrame.pHdr->sA3.abyAddr2, pMgmt->abyMACAddr, WLAN_ADDR_LEN);\r\nmemcpy( sFrame.pHdr->sA3.abyAddr3, pMgmt->abyCurrBSSID, WLAN_BSSID_LEN);\r\n*sFrame.pwCapInfo = cpu_to_le16(wCurrCapInfo);\r\n*sFrame.pwStatus = cpu_to_le16(wAssocStatus);\r\n*sFrame.pwAid = cpu_to_le16((WORD)(wAssocAID | BIT14 | BIT15));\r\nsFrame.pSuppRates = (PWLAN_IE_SUPP_RATES)(sFrame.pBuf + sFrame.len);\r\nsFrame.len += ((PWLAN_IE_SUPP_RATES)pCurrSuppRates)->len + WLAN_IEHDR_LEN;\r\nmemcpy(sFrame.pSuppRates,\r\npCurrSuppRates,\r\n((PWLAN_IE_SUPP_RATES)pCurrSuppRates)->len + WLAN_IEHDR_LEN\r\n);\r\nif (((PWLAN_IE_SUPP_RATES)pCurrExtSuppRates)->len != 0) {\r\nsFrame.pExtSuppRates = (PWLAN_IE_SUPP_RATES)(sFrame.pBuf + sFrame.len);\r\nsFrame.len += ((PWLAN_IE_SUPP_RATES)pCurrExtSuppRates)->len + WLAN_IEHDR_LEN;\r\nmemcpy(sFrame.pExtSuppRates,\r\npCurrExtSuppRates,\r\n((PWLAN_IE_SUPP_RATES)pCurrExtSuppRates)->len + WLAN_IEHDR_LEN\r\n);\r\n}\r\npTxPacket->cbMPDULen = sFrame.len;\r\npTxPacket->cbPayloadLen = sFrame.len - WLAN_HDR_ADDR3_LEN;\r\nreturn pTxPacket;\r\n}\r\nPSTxMgmtPacket\r\ns_MgrMakeReAssocResponse(\r\nPSDevice pDevice,\r\nPSMgmtObject pMgmt,\r\nWORD wCurrCapInfo,\r\nWORD wAssocStatus,\r\nWORD wAssocAID,\r\nPBYTE pDstAddr,\r\nPWLAN_IE_SUPP_RATES pCurrSuppRates,\r\nPWLAN_IE_SUPP_RATES pCurrExtSuppRates\r\n)\r\n{\r\nPSTxMgmtPacket pTxPacket = NULL;\r\nWLAN_FR_REASSOCRESP sFrame;\r\npTxPacket = (PSTxMgmtPacket)pMgmt->pbyMgmtPacketPool;\r\nmemset(pTxPacket, 0, sizeof(STxMgmtPacket) + WLAN_ASSOCREQ_FR_MAXLEN);\r\npTxPacket->p80211Header = (PUWLAN_80211HDR)((PBYTE)pTxPacket + sizeof(STxMgmtPacket));\r\nsFrame.pBuf = (PBYTE)pTxPacket->p80211Header;\r\nsFrame.len = WLAN_REASSOCRESP_FR_MAXLEN;\r\nvMgrEncodeReassocResponse(&sFrame);\r\nsFrame.pHdr->sA3.wFrameCtl = cpu_to_le16(\r\n(\r\nWLAN_SET_FC_FTYPE(WLAN_TYPE_MGR) |\r\nWLAN_SET_FC_FSTYPE(WLAN_FSTYPE_REASSOCRESP)\r\n));\r\nmemcpy( sFrame.pHdr->sA3.abyAddr1, pDstAddr, WLAN_ADDR_LEN);\r\nmemcpy( sFrame.pHdr->sA3.abyAddr2, pMgmt->abyMACAddr, WLAN_ADDR_LEN);\r\nmemcpy( sFrame.pHdr->sA3.abyAddr3, pMgmt->abyCurrBSSID, WLAN_BSSID_LEN);\r\n*sFrame.pwCapInfo = cpu_to_le16(wCurrCapInfo);\r\n*sFrame.pwStatus = cpu_to_le16(wAssocStatus);\r\n*sFrame.pwAid = cpu_to_le16((WORD)(wAssocAID | BIT14 | BIT15));\r\nsFrame.pSuppRates = (PWLAN_IE_SUPP_RATES)(sFrame.pBuf + sFrame.len);\r\nsFrame.len += ((PWLAN_IE_SUPP_RATES)pCurrSuppRates)->len + WLAN_IEHDR_LEN;\r\nmemcpy(sFrame.pSuppRates,\r\npCurrSuppRates,\r\n((PWLAN_IE_SUPP_RATES)pCurrSuppRates)->len + WLAN_IEHDR_LEN\r\n);\r\nif (((PWLAN_IE_SUPP_RATES)pCurrExtSuppRates)->len != 0) {\r\nsFrame.pExtSuppRates = (PWLAN_IE_SUPP_RATES)(sFrame.pBuf + sFrame.len);\r\nsFrame.len += ((PWLAN_IE_SUPP_RATES)pCurrExtSuppRates)->len + WLAN_IEHDR_LEN;\r\nmemcpy(sFrame.pExtSuppRates,\r\npCurrExtSuppRates,\r\n((PWLAN_IE_SUPP_RATES)pCurrExtSuppRates)->len + WLAN_IEHDR_LEN\r\n);\r\n}\r\npTxPacket->cbMPDULen = sFrame.len;\r\npTxPacket->cbPayloadLen = sFrame.len - WLAN_HDR_ADDR3_LEN;\r\nreturn pTxPacket;\r\n}\r\nstatic\r\nvoid\r\ns_vMgrRxProbeResponse(\r\nPSDevice pDevice,\r\nPSMgmtObject pMgmt,\r\nPSRxMgmtPacket pRxPacket\r\n)\r\n{\r\nPKnownBSS pBSSList = NULL;\r\nWLAN_FR_PROBERESP sFrame;\r\nBYTE byCurrChannel = pRxPacket->byRxChannel;\r\nERPObject sERP;\r\nBOOL bChannelHit = TRUE;\r\nmemset(&sFrame, 0, sizeof(WLAN_FR_PROBERESP));\r\nsFrame.len = pRxPacket->cbMPDULen;\r\nsFrame.pBuf = (PBYTE)pRxPacket->p80211Header;\r\nvMgrDecodeProbeResponse(&sFrame);\r\nif ((sFrame.pqwTimestamp == NULL)\r\n|| (sFrame.pwBeaconInterval == NULL)\r\n|| (sFrame.pwCapInfo == NULL)\r\n|| (sFrame.pSSID == NULL)\r\n|| (sFrame.pSuppRates == NULL)) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Probe resp:Fail addr:[%p]\n",\r\npRxPacket->p80211Header);\r\nDBG_PORT80(0xCC);\r\nreturn;\r\n}\r\nif(sFrame.pSSID->len == 0)\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Rx Probe resp: SSID len = 0 \n");\r\nif( byCurrChannel > CB_MAX_CHANNEL_24G )\r\n{\r\nif (sFrame.pDSParms) {\r\nif (byCurrChannel ==\r\nRFaby11aChannelIndex[sFrame.pDSParms->byCurrChannel-1])\r\nbChannelHit = TRUE;\r\nbyCurrChannel =\r\nRFaby11aChannelIndex[sFrame.pDSParms->byCurrChannel-1];\r\n} else {\r\nbChannelHit = TRUE;\r\n}\r\n} else {\r\nif (sFrame.pDSParms) {\r\nif (byCurrChannel == sFrame.pDSParms->byCurrChannel)\r\nbChannelHit = TRUE;\r\nbyCurrChannel = sFrame.pDSParms->byCurrChannel;\r\n} else {\r\nbChannelHit = TRUE;\r\n}\r\n}\r\nif(ChannelExceedZoneType(pDevice,byCurrChannel)==TRUE)\r\nreturn;\r\nif (sFrame.pERP) {\r\nsERP.byERP = sFrame.pERP->byContext;\r\nsERP.bERPExist = TRUE;\r\n} else {\r\nsERP.bERPExist = FALSE;\r\nsERP.byERP = 0;\r\n}\r\npBSSList = BSSpAddrIsInBSSList((void *) pDevice,\r\nsFrame.pHdr->sA3.abyAddr3,\r\nsFrame.pSSID);\r\nif (pBSSList) {\r\nBSSbUpdateToBSSList((void *) pDevice,\r\n*sFrame.pqwTimestamp,\r\n*sFrame.pwBeaconInterval,\r\n*sFrame.pwCapInfo,\r\nbyCurrChannel,\r\nbChannelHit,\r\nsFrame.pSSID,\r\nsFrame.pSuppRates,\r\nsFrame.pExtSuppRates,\r\n&sERP,\r\nsFrame.pRSN,\r\nsFrame.pRSNWPA,\r\nsFrame.pIE_Country,\r\nsFrame.pIE_Quiet,\r\npBSSList,\r\nsFrame.len - WLAN_HDR_ADDR3_LEN,\r\nsFrame.pHdr->sA4.abyAddr4,\r\n(void *) pRxPacket);\r\n} else {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"Probe resp/insert: RxChannel = : %d\n", byCurrChannel);\r\nBSSbInsertToBSSList((void *) pDevice,\r\nsFrame.pHdr->sA3.abyAddr3,\r\n*sFrame.pqwTimestamp,\r\n*sFrame.pwBeaconInterval,\r\n*sFrame.pwCapInfo,\r\nbyCurrChannel,\r\nsFrame.pSSID,\r\nsFrame.pSuppRates,\r\nsFrame.pExtSuppRates,\r\n&sERP,\r\nsFrame.pRSN,\r\nsFrame.pRSNWPA,\r\nsFrame.pIE_Country,\r\nsFrame.pIE_Quiet,\r\nsFrame.len - WLAN_HDR_ADDR3_LEN,\r\nsFrame.pHdr->sA4.abyAddr4,\r\n(void *) pRxPacket);\r\n}\r\nreturn;\r\n}\r\nstatic\r\nvoid\r\ns_vMgrRxProbeRequest(\r\nPSDevice pDevice,\r\nPSMgmtObject pMgmt,\r\nPSRxMgmtPacket pRxPacket\r\n)\r\n{\r\nWLAN_FR_PROBEREQ sFrame;\r\nCMD_STATUS Status;\r\nPSTxMgmtPacket pTxPacket;\r\nBYTE byPHYType = BB_TYPE_11B;\r\nif ((pMgmt->eCurrMode == WMAC_MODE_ESS_AP) ||\r\n((pMgmt->eCurrMode == WMAC_MODE_IBSS_STA) && pDevice->bBeaconSent)) {\r\nmemset(&sFrame, 0, sizeof(WLAN_FR_PROBEREQ));\r\nsFrame.len = pRxPacket->cbMPDULen;\r\nsFrame.pBuf = (PBYTE)pRxPacket->p80211Header;\r\nvMgrDecodeProbeRequest(&sFrame);\r\nif (sFrame.pSSID->len != 0) {\r\nif (sFrame.pSSID->len != ((PWLAN_IE_SSID)pMgmt->abyCurrSSID)->len)\r\nreturn;\r\nif (memcmp(sFrame.pSSID->abySSID,\r\n((PWLAN_IE_SSID)pMgmt->abyCurrSSID)->abySSID,\r\n((PWLAN_IE_SSID)pMgmt->abyCurrSSID)->len) != 0) {\r\nreturn;\r\n}\r\n}\r\nif ((sFrame.pSuppRates->len > 4) || (sFrame.pExtSuppRates != NULL)) {\r\nbyPHYType = BB_TYPE_11G;\r\n}\r\npTxPacket = s_MgrMakeProbeResponse\r\n(\r\npDevice,\r\npMgmt,\r\npMgmt->wCurrCapInfo,\r\npMgmt->wCurrBeaconPeriod,\r\npMgmt->uCurrChannel,\r\n0,\r\nsFrame.pHdr->sA3.abyAddr2,\r\n(PWLAN_IE_SSID)pMgmt->abyCurrSSID,\r\n(PBYTE)pMgmt->abyCurrBSSID,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrSuppRates,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrExtSuppRates,\r\nbyPHYType\r\n);\r\nif (pTxPacket != NULL ){\r\nStatus = csMgmt_xmit(pDevice, pTxPacket);\r\nif (Status != CMD_STATUS_PENDING) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Mgt:Probe response tx failed\n");\r\n}\r\nelse {\r\n}\r\n}\r\n}\r\nreturn;\r\n}\r\nvoid vMgrRxManagePacket(void *hDeviceContext,\r\nPSMgmtObject pMgmt,\r\nPSRxMgmtPacket pRxPacket)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nBOOL bInScan = FALSE;\r\nunsigned int uNodeIndex = 0;\r\nNODE_STATE eNodeState = 0;\r\nCMD_STATUS Status;\r\nif (pMgmt->eCurrMode == WMAC_MODE_ESS_AP) {\r\nif (BSSbIsSTAInNodeDB(pDevice, pRxPacket->p80211Header->sA3.abyAddr2, &uNodeIndex))\r\neNodeState = pMgmt->sNodeDBTable[uNodeIndex].eNodeState;\r\n}\r\nswitch( WLAN_GET_FC_FSTYPE((pRxPacket->p80211Header->sA3.wFrameCtl)) ){\r\ncase WLAN_FSTYPE_ASSOCREQ:\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "rx assocreq\n");\r\nif ((pMgmt->eCurrMode == WMAC_MODE_ESS_AP) &&\r\n(eNodeState < NODE_AUTH)) {\r\nvMgrDeAuthenBeginSta(pDevice,\r\npMgmt,\r\npRxPacket->p80211Header->sA3.abyAddr2,\r\n(6),\r\n&Status\r\n);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "wmgr: send vMgrDeAuthenBeginSta 1\n");\r\n}\r\nelse {\r\ns_vMgrRxAssocRequest(pDevice, pMgmt, pRxPacket, uNodeIndex);\r\n}\r\nbreak;\r\ncase WLAN_FSTYPE_ASSOCRESP:\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "rx assocresp1\n");\r\ns_vMgrRxAssocResponse(pDevice, pMgmt, pRxPacket, FALSE);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "rx assocresp2\n");\r\nbreak;\r\ncase WLAN_FSTYPE_REASSOCREQ:\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "rx reassocreq\n");\r\nif ((pMgmt->eCurrMode == WMAC_MODE_ESS_AP) &&\r\n(eNodeState < NODE_AUTH)) {\r\nvMgrDeAuthenBeginSta(pDevice,\r\npMgmt,\r\npRxPacket->p80211Header->sA3.abyAddr2,\r\n(6),\r\n&Status\r\n);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "wmgr: send vMgrDeAuthenBeginSta 2\n");\r\n}\r\ns_vMgrRxReAssocRequest(pDevice, pMgmt, pRxPacket, uNodeIndex);\r\nbreak;\r\ncase WLAN_FSTYPE_REASSOCRESP:\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "rx reassocresp\n");\r\ns_vMgrRxAssocResponse(pDevice, pMgmt, pRxPacket, TRUE);\r\nbreak;\r\ncase WLAN_FSTYPE_PROBEREQ:\r\ns_vMgrRxProbeRequest(pDevice, pMgmt, pRxPacket);\r\nbreak;\r\ncase WLAN_FSTYPE_PROBERESP:\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "rx proberesp\n");\r\ns_vMgrRxProbeResponse(pDevice, pMgmt, pRxPacket);\r\nbreak;\r\ncase WLAN_FSTYPE_BEACON:\r\nif (pMgmt->eScanState != WMAC_NO_SCANNING) {\r\nbInScan = TRUE;\r\n}\r\ns_vMgrRxBeacon(pDevice, pMgmt, pRxPacket, bInScan);\r\nbreak;\r\ncase WLAN_FSTYPE_ATIM:\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "rx atim\n");\r\nbreak;\r\ncase WLAN_FSTYPE_DISASSOC:\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "rx disassoc\n");\r\nif ((pMgmt->eCurrMode == WMAC_MODE_ESS_AP) &&\r\n(eNodeState < NODE_AUTH)) {\r\nvMgrDeAuthenBeginSta(pDevice,\r\npMgmt,\r\npRxPacket->p80211Header->sA3.abyAddr2,\r\n(6),\r\n&Status\r\n);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "wmgr: send vMgrDeAuthenBeginSta 3\n");\r\n}\r\ns_vMgrRxDisassociation(pDevice, pMgmt, pRxPacket);\r\nbreak;\r\ncase WLAN_FSTYPE_AUTHEN:\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "rx authen\n");\r\ns_vMgrRxAuthentication(pDevice, pMgmt, pRxPacket);\r\nbreak;\r\ncase WLAN_FSTYPE_DEAUTHEN:\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "rx deauthen\n");\r\ns_vMgrRxDeauthentication(pDevice, pMgmt, pRxPacket);\r\nbreak;\r\ndefault:\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "rx unknown mgmt\n");\r\n}\r\nreturn;\r\n}\r\nBOOL bMgrPrepareBeaconToSend(void *hDeviceContext, PSMgmtObject pMgmt)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPSTxMgmtPacket pTxPacket;\r\nif (pDevice->bEncryptionEnable || pDevice->bEnable8021x){\r\npMgmt->wCurrCapInfo |= WLAN_SET_CAP_INFO_PRIVACY(1);\r\n}\r\nelse {\r\npMgmt->wCurrCapInfo &= ~WLAN_SET_CAP_INFO_PRIVACY(1);\r\n}\r\npTxPacket = s_MgrMakeBeacon\r\n(\r\npDevice,\r\npMgmt,\r\npMgmt->wCurrCapInfo,\r\npMgmt->wCurrBeaconPeriod,\r\npMgmt->uCurrChannel,\r\npMgmt->wCurrATIMWindow,\r\n(PWLAN_IE_SSID)pMgmt->abyCurrSSID,\r\n(PBYTE)pMgmt->abyCurrBSSID,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrSuppRates,\r\n(PWLAN_IE_SUPP_RATES)pMgmt->abyCurrExtSuppRates\r\n);\r\nif ((pMgmt->eCurrMode == WMAC_MODE_IBSS_STA) &&\r\n(pMgmt->abyCurrBSSID[0] == 0))\r\nreturn FALSE;\r\ncsBeacon_xmit(pDevice, pTxPacket);\r\nMACvRegBitsOn(pDevice, MAC_REG_TCR, TCR_AUTOBCNTX);\r\nreturn TRUE;\r\n}\r\nstatic\r\nvoid\r\ns_vMgrLogStatus(\r\nPSMgmtObject pMgmt,\r\nWORD wStatus\r\n)\r\n{\r\nswitch( wStatus ){\r\ncase WLAN_MGMT_STATUS_UNSPEC_FAILURE:\r\nDBG_PRT(MSG_LEVEL_NOTICE, KERN_INFO "Status code == Unspecified error.\n");\r\nbreak;\r\ncase WLAN_MGMT_STATUS_CAPS_UNSUPPORTED:\r\nDBG_PRT(MSG_LEVEL_NOTICE, KERN_INFO "Status code == Can't support all requested capabilities.\n");\r\nbreak;\r\ncase WLAN_MGMT_STATUS_REASSOC_NO_ASSOC:\r\nDBG_PRT(MSG_LEVEL_NOTICE, KERN_INFO "Status code == Reassoc denied, can't confirm original Association.\n");\r\nbreak;\r\ncase WLAN_MGMT_STATUS_ASSOC_DENIED_UNSPEC:\r\nDBG_PRT(MSG_LEVEL_NOTICE, KERN_INFO "Status code == Assoc denied, undefine in spec\n");\r\nbreak;\r\ncase WLAN_MGMT_STATUS_UNSUPPORTED_AUTHALG:\r\nDBG_PRT(MSG_LEVEL_NOTICE, KERN_INFO "Status code == Peer doesn't support authen algorithm.\n");\r\nbreak;\r\ncase WLAN_MGMT_STATUS_RX_AUTH_NOSEQ:\r\nDBG_PRT(MSG_LEVEL_NOTICE, KERN_INFO "Status code == Authen frame received out of sequence.\n");\r\nbreak;\r\ncase WLAN_MGMT_STATUS_CHALLENGE_FAIL:\r\nDBG_PRT(MSG_LEVEL_NOTICE, KERN_INFO "Status code == Authen rejected, challenge failure.\n");\r\nbreak;\r\ncase WLAN_MGMT_STATUS_AUTH_TIMEOUT:\r\nDBG_PRT(MSG_LEVEL_NOTICE, KERN_INFO "Status code == Authen rejected, timeout waiting for next frame.\n");\r\nbreak;\r\ncase WLAN_MGMT_STATUS_ASSOC_DENIED_BUSY:\r\nDBG_PRT(MSG_LEVEL_NOTICE, KERN_INFO "Status code == Assoc denied, AP too busy.\n");\r\nbreak;\r\ncase WLAN_MGMT_STATUS_ASSOC_DENIED_RATES:\r\nDBG_PRT(MSG_LEVEL_NOTICE, KERN_INFO "Status code == Assoc denied, we haven't enough basic rates.\n");\r\nbreak;\r\ncase WLAN_MGMT_STATUS_ASSOC_DENIED_SHORTPREAMBLE:\r\nDBG_PRT(MSG_LEVEL_NOTICE, KERN_INFO "Status code == Assoc denied, we do not support short preamble.\n");\r\nbreak;\r\ncase WLAN_MGMT_STATUS_ASSOC_DENIED_PBCC:\r\nDBG_PRT(MSG_LEVEL_NOTICE, KERN_INFO "Status code == Assoc denied, we do not support PBCC.\n");\r\nbreak;\r\ncase WLAN_MGMT_STATUS_ASSOC_DENIED_AGILITY:\r\nDBG_PRT(MSG_LEVEL_NOTICE, KERN_INFO "Status code == Assoc denied, we do not support channel agility.\n");\r\nbreak;\r\ndefault:\r\nDBG_PRT(MSG_LEVEL_NOTICE, KERN_INFO "Unknown status code %d.\n", wStatus);\r\nbreak;\r\n}\r\n}\r\nBOOL bAdd_PMKID_Candidate(void *hDeviceContext,\r\nPBYTE pbyBSSID,\r\nPSRSNCapObject psRSNCapObj)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPPMKID_CANDIDATE pCandidateList;\r\nunsigned int ii = 0;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"bAdd_PMKID_Candidate START: (%d)\n", (int)pDevice->gsPMKIDCandidate.NumCandidates);\r\nif ((pDevice == NULL) || (pbyBSSID == NULL) || (psRSNCapObj == NULL))\r\nreturn FALSE;\r\nif (pDevice->gsPMKIDCandidate.NumCandidates >= MAX_PMKIDLIST)\r\nreturn FALSE;\r\nfor (ii = 0; ii < pDevice->gsPMKIDCandidate.NumCandidates; ii++) {\r\npCandidateList = &pDevice->gsPMKIDCandidate.CandidateList[ii];\r\nif (!memcmp(pCandidateList->BSSID, pbyBSSID, ETH_ALEN)) {\r\nif ((psRSNCapObj->bRSNCapExist == TRUE)\r\n&& (psRSNCapObj->wRSNCap & BIT0)) {\r\npCandidateList->Flags |=\r\nNDIS_802_11_PMKID_CANDIDATE_PREAUTH_ENABLED;\r\n} else {\r\npCandidateList->Flags &=\r\n~(NDIS_802_11_PMKID_CANDIDATE_PREAUTH_ENABLED);\r\n}\r\nreturn TRUE;\r\n}\r\n}\r\npCandidateList = &pDevice->gsPMKIDCandidate.CandidateList[pDevice->gsPMKIDCandidate.NumCandidates];\r\nif ((psRSNCapObj->bRSNCapExist == TRUE) && (psRSNCapObj->wRSNCap & BIT0)) {\r\npCandidateList->Flags |= NDIS_802_11_PMKID_CANDIDATE_PREAUTH_ENABLED;\r\n} else {\r\npCandidateList->Flags &= ~(NDIS_802_11_PMKID_CANDIDATE_PREAUTH_ENABLED);\r\n}\r\nmemcpy(pCandidateList->BSSID, pbyBSSID, ETH_ALEN);\r\npDevice->gsPMKIDCandidate.NumCandidates++;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"NumCandidates:%d\n", (int)pDevice->gsPMKIDCandidate.NumCandidates);\r\nreturn TRUE;\r\n}\r\nvoid vFlush_PMKID_Candidate(void *hDeviceContext)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nif (pDevice == NULL)\r\nreturn;\r\nmemset(&pDevice->gsPMKIDCandidate, 0, sizeof(SPMKIDCandidateEvent));\r\n}\r\nstatic BOOL\r\ns_bCipherMatch (\r\nPKnownBSS pBSSNode,\r\nNDIS_802_11_ENCRYPTION_STATUS EncStatus,\r\nPBYTE pbyCCSPK,\r\nPBYTE pbyCCSGK\r\n)\r\n{\r\nBYTE byMulticastCipher = KEY_CTL_INVALID;\r\nBYTE byCipherMask = 0x00;\r\nint i;\r\nif (pBSSNode == NULL)\r\nreturn FALSE;\r\nif ((WLAN_GET_CAP_INFO_PRIVACY(pBSSNode->wCapInfo) != 0) &&\r\n(EncStatus == Ndis802_11Encryption1Enabled)) {\r\nbyMulticastCipher = KEY_CTL_WEP;\r\n}\r\nif ((WLAN_GET_CAP_INFO_PRIVACY(pBSSNode->wCapInfo) != 0) &&\r\n(pBSSNode->bWPA2Valid == TRUE) &&\r\n((EncStatus == Ndis802_11Encryption3Enabled) ||\r\n(EncStatus == Ndis802_11Encryption2Enabled))) {\r\nif ((pBSSNode->byCSSGK == WLAN_11i_CSS_WEP40) ||\r\n(pBSSNode->byCSSGK == WLAN_11i_CSS_WEP104)) {\r\nbyMulticastCipher = KEY_CTL_WEP;\r\n} else if (pBSSNode->byCSSGK == WLAN_11i_CSS_TKIP) {\r\nbyMulticastCipher = KEY_CTL_TKIP;\r\n} else if (pBSSNode->byCSSGK == WLAN_11i_CSS_CCMP) {\r\nbyMulticastCipher = KEY_CTL_CCMP;\r\n} else {\r\nbyMulticastCipher = KEY_CTL_INVALID;\r\n}\r\nfor (i = 0; i < pBSSNode->wCSSPKCount; i++) {\r\nif ((pBSSNode->abyCSSPK[i] == WLAN_11i_CSS_WEP40) ||\r\n(pBSSNode->abyCSSPK[i] == WLAN_11i_CSS_WEP104)) {\r\nbyCipherMask |= 0x01;\r\n} else if (pBSSNode->abyCSSPK[i] == WLAN_11i_CSS_TKIP) {\r\nbyCipherMask |= 0x02;\r\n} else if (pBSSNode->abyCSSPK[i] == WLAN_11i_CSS_CCMP) {\r\nbyCipherMask |= 0x04;\r\n} else if (pBSSNode->abyCSSPK[i] == WLAN_11i_CSS_USE_GROUP) {\r\nbyCipherMask = 0;\r\ni = pBSSNode->wCSSPKCount;\r\n}\r\n}\r\n} else if ((WLAN_GET_CAP_INFO_PRIVACY(pBSSNode->wCapInfo) != 0) &&\r\n(pBSSNode->bWPAValid == TRUE) &&\r\n((EncStatus == Ndis802_11Encryption2Enabled) || (EncStatus == Ndis802_11Encryption3Enabled))) {\r\nif ((pBSSNode->byGKType == WPA_WEP40) ||\r\n(pBSSNode->byGKType == WPA_WEP104)) {\r\nbyMulticastCipher = KEY_CTL_WEP;\r\n} else if (pBSSNode->byGKType == WPA_TKIP) {\r\nbyMulticastCipher = KEY_CTL_TKIP;\r\n} else if (pBSSNode->byGKType == WPA_AESCCMP) {\r\nbyMulticastCipher = KEY_CTL_CCMP;\r\n} else {\r\nbyMulticastCipher = KEY_CTL_INVALID;\r\n}\r\nfor (i = 0; i < pBSSNode->wPKCount; i++) {\r\nif (pBSSNode->abyPKType[i] == WPA_TKIP) {\r\nbyCipherMask |= 0x02;\r\n} else if (pBSSNode->abyPKType[i] == WPA_AESCCMP) {\r\nbyCipherMask |= 0x04;\r\n} else if (pBSSNode->abyPKType[i] == WPA_NONE) {\r\nbyCipherMask = 0;\r\ni = pBSSNode->wPKCount;\r\n}\r\n}\r\n}\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"%d, %d, %d, %d, EncStatus:%d\n",\r\nbyMulticastCipher, byCipherMask, pBSSNode->bWPAValid, pBSSNode->bWPA2Valid, EncStatus);\r\nif (EncStatus == Ndis802_11Encryption1Enabled) {\r\nif ((byMulticastCipher == KEY_CTL_WEP) &&\r\n(byCipherMask == 0)) {\r\n*pbyCCSGK = KEY_CTL_WEP;\r\n*pbyCCSPK = KEY_CTL_NONE;\r\nreturn TRUE;\r\n} else {\r\nreturn FALSE;\r\n}\r\n} else if (EncStatus == Ndis802_11Encryption2Enabled) {\r\nif ((byMulticastCipher == KEY_CTL_TKIP) &&\r\n(byCipherMask == 0)) {\r\n*pbyCCSGK = KEY_CTL_TKIP;\r\n*pbyCCSPK = KEY_CTL_NONE;\r\nreturn TRUE;\r\n} else if ((byMulticastCipher == KEY_CTL_WEP) &&\r\n((byCipherMask & 0x02) != 0)) {\r\n*pbyCCSGK = KEY_CTL_WEP;\r\n*pbyCCSPK = KEY_CTL_TKIP;\r\nreturn TRUE;\r\n} else if ((byMulticastCipher == KEY_CTL_TKIP) &&\r\n((byCipherMask & 0x02) != 0)) {\r\n*pbyCCSGK = KEY_CTL_TKIP;\r\n*pbyCCSPK = KEY_CTL_TKIP;\r\nreturn TRUE;\r\n} else {\r\nreturn FALSE;\r\n}\r\n} else if (EncStatus == Ndis802_11Encryption3Enabled) {\r\nif ((byMulticastCipher == KEY_CTL_CCMP) &&\r\n(byCipherMask == 0)) {\r\nreturn FALSE;\r\n} else if ((byMulticastCipher == KEY_CTL_WEP) &&\r\n((byCipherMask & 0x04) != 0)) {\r\n*pbyCCSGK = KEY_CTL_WEP;\r\n*pbyCCSPK = KEY_CTL_CCMP;\r\nreturn TRUE;\r\n} else if ((byMulticastCipher == KEY_CTL_TKIP) &&\r\n((byCipherMask & 0x04) != 0)) {\r\n*pbyCCSGK = KEY_CTL_TKIP;\r\n*pbyCCSPK = KEY_CTL_CCMP;\r\nreturn TRUE;\r\n} else if ((byMulticastCipher == KEY_CTL_CCMP) &&\r\n((byCipherMask & 0x04) != 0)) {\r\n*pbyCCSGK = KEY_CTL_CCMP;\r\n*pbyCCSPK = KEY_CTL_CCMP;\r\nreturn TRUE;\r\n} else {\r\nreturn FALSE;\r\n}\r\n}\r\nreturn TRUE;\r\n}

static void pps_ktimer_event(unsigned long ptr)\r\n{\r\nstruct pps_event_time ts;\r\npps_get_ts(&ts);\r\npps_event(pps, &ts, PPS_CAPTUREASSERT, NULL);\r\nmod_timer(&ktimer, jiffies + HZ);\r\n}\r\nstatic void pps_ktimer_echo(struct pps_device *pps, int event, void *data)\r\n{\r\ndev_info(pps->dev, "echo %s %s\n",\r\nevent & PPS_CAPTUREASSERT ? "assert" : "",\r\nevent & PPS_CAPTURECLEAR ? "clear" : "");\r\n}\r\nstatic void __exit pps_ktimer_exit(void)\r\n{\r\ndev_info(pps->dev, "ktimer PPS source unregistered\n");\r\ndel_timer_sync(&ktimer);\r\npps_unregister_source(pps);\r\n}\r\nstatic int __init pps_ktimer_init(void)\r\n{\r\npps = pps_register_source(&pps_ktimer_info,\r\nPPS_CAPTUREASSERT | PPS_OFFSETASSERT);\r\nif (pps == NULL) {\r\npr_err("cannot register PPS source\n");\r\nreturn -ENOMEM;\r\n}\r\nsetup_timer(&ktimer, pps_ktimer_event, 0);\r\nmod_timer(&ktimer, jiffies + HZ);\r\ndev_info(pps->dev, "ktimer PPS source registered\n");\r\nreturn 0;\r\n}

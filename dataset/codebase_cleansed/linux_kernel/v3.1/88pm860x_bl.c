static inline int wled_a(int port)\r\n{\r\nint ret;\r\nret = ((port - PM8606_BACKLIGHT1) << 1) + 2;\r\nreturn ret;\r\n}\r\nstatic inline int wled_b(int port)\r\n{\r\nint ret;\r\nret = ((port - PM8606_BACKLIGHT1) << 1) + 3;\r\nreturn ret;\r\n}\r\nstatic inline int wled_idc(int port)\r\n{\r\nint ret;\r\nswitch (port) {\r\ncase PM8606_BACKLIGHT1:\r\ncase PM8606_BACKLIGHT2:\r\nret = ((port - PM8606_BACKLIGHT1) << 1) + 3;\r\nbreak;\r\ncase PM8606_BACKLIGHT3:\r\ndefault:\r\nret = ((port - PM8606_BACKLIGHT2) << 1) + 3;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int pm860x_backlight_set(struct backlight_device *bl, int brightness)\r\n{\r\nstruct pm860x_backlight_data *data = bl_get_data(bl);\r\nstruct pm860x_chip *chip = data->chip;\r\nunsigned char value;\r\nint ret;\r\nif (brightness > MAX_BRIGHTNESS)\r\nvalue = MAX_BRIGHTNESS;\r\nelse\r\nvalue = brightness;\r\nret = pm860x_reg_write(data->i2c, wled_a(data->port), value);\r\nif (ret < 0)\r\ngoto out;\r\nif ((data->current_brightness == 0) && brightness) {\r\nif (data->iset) {\r\nret = pm860x_set_bits(data->i2c, wled_idc(data->port),\r\nCURRENT_BITMASK, data->iset);\r\nif (ret < 0)\r\ngoto out;\r\n}\r\nif (data->pwm) {\r\nret = pm860x_set_bits(data->i2c, PM8606_PWM,\r\nPM8606_PWM_FREQ_MASK, data->pwm);\r\nif (ret < 0)\r\ngoto out;\r\n}\r\nif (brightness == MAX_BRIGHTNESS) {\r\nret = pm860x_set_bits(data->i2c, wled_b(data->port),\r\nPM8606_WLED_ON, PM8606_WLED_ON);\r\n}\r\n} else {\r\nif (brightness == MAX_BRIGHTNESS) {\r\nret = pm860x_set_bits(data->i2c, wled_b(data->port),\r\nPM8606_WLED_ON, PM8606_WLED_ON);\r\n} else {\r\nret = pm860x_set_bits(data->i2c, wled_b(data->port),\r\nPM8606_WLED_ON, 0);\r\n}\r\n}\r\nif (ret < 0)\r\ngoto out;\r\ndev_dbg(chip->dev, "set brightness %d\n", value);\r\ndata->current_brightness = value;\r\nreturn 0;\r\nout:\r\ndev_dbg(chip->dev, "set brightness %d failure with return "\r\n"value:%d\n", value, ret);\r\nreturn ret;\r\n}\r\nstatic int pm860x_backlight_update_status(struct backlight_device *bl)\r\n{\r\nint brightness = bl->props.brightness;\r\nif (bl->props.power != FB_BLANK_UNBLANK)\r\nbrightness = 0;\r\nif (bl->props.fb_blank != FB_BLANK_UNBLANK)\r\nbrightness = 0;\r\nif (bl->props.state & BL_CORE_SUSPENDED)\r\nbrightness = 0;\r\nreturn pm860x_backlight_set(bl, brightness);\r\n}\r\nstatic int pm860x_backlight_get_brightness(struct backlight_device *bl)\r\n{\r\nstruct pm860x_backlight_data *data = bl_get_data(bl);\r\nstruct pm860x_chip *chip = data->chip;\r\nint ret;\r\nret = pm860x_reg_read(data->i2c, wled_a(data->port));\r\nif (ret < 0)\r\ngoto out;\r\ndata->current_brightness = ret;\r\ndev_dbg(chip->dev, "get brightness %d\n", data->current_brightness);\r\nreturn data->current_brightness;\r\nout:\r\nreturn -EINVAL;\r\n}\r\nstatic int pm860x_backlight_probe(struct platform_device *pdev)\r\n{\r\nstruct pm860x_chip *chip = dev_get_drvdata(pdev->dev.parent);\r\nstruct pm860x_backlight_pdata *pdata = NULL;\r\nstruct pm860x_backlight_data *data;\r\nstruct backlight_device *bl;\r\nstruct resource *res;\r\nstruct backlight_properties props;\r\nunsigned char value;\r\nchar name[MFD_NAME_SIZE];\r\nint ret;\r\nres = platform_get_resource(pdev, IORESOURCE_IO, 0);\r\nif (res == NULL) {\r\ndev_err(&pdev->dev, "No I/O resource!\n");\r\nreturn -EINVAL;\r\n}\r\npdata = pdev->dev.platform_data;\r\nif (pdata == NULL) {\r\ndev_err(&pdev->dev, "platform data isn't assigned to "\r\n"backlight\n");\r\nreturn -EINVAL;\r\n}\r\ndata = kzalloc(sizeof(struct pm860x_backlight_data), GFP_KERNEL);\r\nif (data == NULL)\r\nreturn -ENOMEM;\r\nstrncpy(name, res->name, MFD_NAME_SIZE);\r\ndata->chip = chip;\r\ndata->i2c = (chip->id == CHIP_PM8606) ? chip->client \\r\n: chip->companion;\r\ndata->current_brightness = MAX_BRIGHTNESS;\r\ndata->pwm = pdata->pwm;\r\ndata->iset = pdata->iset;\r\ndata->port = pdata->flags;\r\nif (data->port < 0) {\r\ndev_err(&pdev->dev, "wrong platform data is assigned");\r\nkfree(data);\r\nreturn -EINVAL;\r\n}\r\nmemset(&props, 0, sizeof(struct backlight_properties));\r\nprops.type = BACKLIGHT_RAW;\r\nprops.max_brightness = MAX_BRIGHTNESS;\r\nbl = backlight_device_register(name, &pdev->dev, data,\r\n&pm860x_backlight_ops, &props);\r\nif (IS_ERR(bl)) {\r\ndev_err(&pdev->dev, "failed to register backlight\n");\r\nkfree(data);\r\nreturn PTR_ERR(bl);\r\n}\r\nbl->props.brightness = MAX_BRIGHTNESS;\r\nplatform_set_drvdata(pdev, bl);\r\nret = pm860x_reg_read(data->i2c, PM8606_VSYS);\r\nif (ret < 0)\r\ngoto out;\r\nif ((ret & PM8606_VSYS_EN) == 0) {\r\nvalue = ret | PM8606_VSYS_EN;\r\nret = pm860x_reg_write(data->i2c, PM8606_VSYS, value);\r\nif (ret < 0)\r\ngoto out;\r\n}\r\nret = pm860x_reg_read(data->i2c, PM8606_MISC);\r\nif (ret < 0)\r\ngoto out;\r\nif ((ret & PM8606_MISC_OSC_EN) == 0) {\r\nvalue = ret | PM8606_MISC_OSC_EN;\r\nret = pm860x_reg_write(data->i2c, PM8606_MISC, value);\r\nif (ret < 0)\r\ngoto out;\r\n}\r\nret = pm860x_backlight_get_brightness(bl);\r\nif (ret < 0)\r\ngoto out;\r\nbacklight_update_status(bl);\r\nreturn 0;\r\nout:\r\nbacklight_device_unregister(bl);\r\nkfree(data);\r\nreturn ret;\r\n}\r\nstatic int pm860x_backlight_remove(struct platform_device *pdev)\r\n{\r\nstruct backlight_device *bl = platform_get_drvdata(pdev);\r\nstruct pm860x_backlight_data *data = bl_get_data(bl);\r\nbacklight_device_unregister(bl);\r\nkfree(data);\r\nreturn 0;\r\n}\r\nstatic int __init pm860x_backlight_init(void)\r\n{\r\nreturn platform_driver_register(&pm860x_backlight_driver);\r\n}\r\nstatic void __exit pm860x_backlight_exit(void)\r\n{\r\nplatform_driver_unregister(&pm860x_backlight_driver);\r\n}

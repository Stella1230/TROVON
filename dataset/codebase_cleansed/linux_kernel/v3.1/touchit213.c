static irqreturn_t touchit213_interrupt(struct serio *serio,\r\nunsigned char data, unsigned int flags)\r\n{\r\nstruct touchit213 *touchit213 = serio_get_drvdata(serio);\r\nstruct input_dev *dev = touchit213->dev;\r\ntouchit213->data[touchit213->idx] = data;\r\nswitch (touchit213->idx++) {\r\ncase 0:\r\nif ((touchit213->data[0] & T213_FORMAT_STATUS_MASK) !=\r\nT213_FORMAT_STATUS_BYTE) {\r\npr_debug("unsynchronized data: 0x%02x\n", data);\r\ntouchit213->idx = 0;\r\n}\r\nbreak;\r\ncase 4:\r\ntouchit213->idx = 0;\r\ninput_report_abs(dev, ABS_X,\r\n(touchit213->data[1] << 7) | touchit213->data[2]);\r\ninput_report_abs(dev, ABS_Y,\r\n(touchit213->data[3] << 7) | touchit213->data[4]);\r\ninput_report_key(dev, BTN_TOUCH,\r\ntouchit213->data[0] & T213_FORMAT_TOUCH_BIT);\r\ninput_sync(dev);\r\nbreak;\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void touchit213_disconnect(struct serio *serio)\r\n{\r\nstruct touchit213 *touchit213 = serio_get_drvdata(serio);\r\ninput_get_device(touchit213->dev);\r\ninput_unregister_device(touchit213->dev);\r\nserio_close(serio);\r\nserio_set_drvdata(serio, NULL);\r\ninput_put_device(touchit213->dev);\r\nkfree(touchit213);\r\n}\r\nstatic int touchit213_connect(struct serio *serio, struct serio_driver *drv)\r\n{\r\nstruct touchit213 *touchit213;\r\nstruct input_dev *input_dev;\r\nint err;\r\ntouchit213 = kzalloc(sizeof(struct touchit213), GFP_KERNEL);\r\ninput_dev = input_allocate_device();\r\nif (!touchit213 || !input_dev) {\r\nerr = -ENOMEM;\r\ngoto fail1;\r\n}\r\ntouchit213->serio = serio;\r\ntouchit213->dev = input_dev;\r\nsnprintf(touchit213->phys, sizeof(touchit213->phys),\r\n"%s/input0", serio->phys);\r\ninput_dev->name = "Sahara Touch-iT213 Serial TouchScreen";\r\ninput_dev->phys = touchit213->phys;\r\ninput_dev->id.bustype = BUS_RS232;\r\ninput_dev->id.vendor = SERIO_TOUCHIT213;\r\ninput_dev->id.product = 0;\r\ninput_dev->id.version = 0x0100;\r\ninput_dev->dev.parent = &serio->dev;\r\ninput_dev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_ABS);\r\ninput_dev->keybit[BIT_WORD(BTN_TOUCH)] = BIT_MASK(BTN_TOUCH);\r\ninput_set_abs_params(touchit213->dev, ABS_X,\r\nT213_MIN_XC, T213_MAX_XC, 0, 0);\r\ninput_set_abs_params(touchit213->dev, ABS_Y,\r\nT213_MIN_YC, T213_MAX_YC, 0, 0);\r\nserio_set_drvdata(serio, touchit213);\r\nerr = serio_open(serio, drv);\r\nif (err)\r\ngoto fail2;\r\nerr = input_register_device(touchit213->dev);\r\nif (err)\r\ngoto fail3;\r\nreturn 0;\r\nfail3: serio_close(serio);\r\nfail2: serio_set_drvdata(serio, NULL);\r\nfail1: input_free_device(input_dev);\r\nkfree(touchit213);\r\nreturn err;\r\n}\r\nstatic int __init touchit213_init(void)\r\n{\r\nreturn serio_register_driver(&touchit213_drv);\r\n}\r\nstatic void __exit touchit213_exit(void)\r\n{\r\nserio_unregister_driver(&touchit213_drv);\r\n}

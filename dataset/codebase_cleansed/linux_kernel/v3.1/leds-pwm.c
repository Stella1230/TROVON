static void led_pwm_set(struct led_classdev *led_cdev,\r\nenum led_brightness brightness)\r\n{\r\nstruct led_pwm_data *led_dat =\r\ncontainer_of(led_cdev, struct led_pwm_data, cdev);\r\nunsigned int max = led_dat->cdev.max_brightness;\r\nunsigned int period = led_dat->period;\r\nif (brightness == 0) {\r\npwm_config(led_dat->pwm, 0, period);\r\npwm_disable(led_dat->pwm);\r\n} else {\r\npwm_config(led_dat->pwm, brightness * period / max, period);\r\npwm_enable(led_dat->pwm);\r\n}\r\n}\r\nstatic int led_pwm_probe(struct platform_device *pdev)\r\n{\r\nstruct led_pwm_platform_data *pdata = pdev->dev.platform_data;\r\nstruct led_pwm *cur_led;\r\nstruct led_pwm_data *leds_data, *led_dat;\r\nint i, ret = 0;\r\nif (!pdata)\r\nreturn -EBUSY;\r\nleds_data = kzalloc(sizeof(struct led_pwm_data) * pdata->num_leds,\r\nGFP_KERNEL);\r\nif (!leds_data)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < pdata->num_leds; i++) {\r\ncur_led = &pdata->leds[i];\r\nled_dat = &leds_data[i];\r\nled_dat->pwm = pwm_request(cur_led->pwm_id,\r\ncur_led->name);\r\nif (IS_ERR(led_dat->pwm)) {\r\nret = PTR_ERR(led_dat->pwm);\r\ndev_err(&pdev->dev, "unable to request PWM %d\n",\r\ncur_led->pwm_id);\r\ngoto err;\r\n}\r\nled_dat->cdev.name = cur_led->name;\r\nled_dat->cdev.default_trigger = cur_led->default_trigger;\r\nled_dat->active_low = cur_led->active_low;\r\nled_dat->period = cur_led->pwm_period_ns;\r\nled_dat->cdev.brightness_set = led_pwm_set;\r\nled_dat->cdev.brightness = LED_OFF;\r\nled_dat->cdev.max_brightness = cur_led->max_brightness;\r\nled_dat->cdev.flags |= LED_CORE_SUSPENDRESUME;\r\nret = led_classdev_register(&pdev->dev, &led_dat->cdev);\r\nif (ret < 0) {\r\npwm_free(led_dat->pwm);\r\ngoto err;\r\n}\r\n}\r\nplatform_set_drvdata(pdev, leds_data);\r\nreturn 0;\r\nerr:\r\nif (i > 0) {\r\nfor (i = i - 1; i >= 0; i--) {\r\nled_classdev_unregister(&leds_data[i].cdev);\r\npwm_free(leds_data[i].pwm);\r\n}\r\n}\r\nkfree(leds_data);\r\nreturn ret;\r\n}\r\nstatic int __devexit led_pwm_remove(struct platform_device *pdev)\r\n{\r\nint i;\r\nstruct led_pwm_platform_data *pdata = pdev->dev.platform_data;\r\nstruct led_pwm_data *leds_data;\r\nleds_data = platform_get_drvdata(pdev);\r\nfor (i = 0; i < pdata->num_leds; i++) {\r\nled_classdev_unregister(&leds_data[i].cdev);\r\npwm_free(leds_data[i].pwm);\r\n}\r\nkfree(leds_data);\r\nreturn 0;\r\n}\r\nstatic int __init led_pwm_init(void)\r\n{\r\nreturn platform_driver_register(&led_pwm_driver);\r\n}\r\nstatic void __exit led_pwm_exit(void)\r\n{\r\nplatform_driver_unregister(&led_pwm_driver);\r\n}

static void set_smc_timings(const u8 chipselect, const u16 cycle,\r\nconst u16 setup, const u16 pulse,\r\nconst u16 data_float, int use_iordy)\r\n{\r\nunsigned long mode = AT91_SMC_READMODE | AT91_SMC_WRITEMODE |\r\nAT91_SMC_BAT_SELECT;\r\nif (use_iordy)\r\nmode |= AT91_SMC_EXNWMODE_READY;\r\nif (data_float)\r\nmode |= AT91_SMC_TDF_(data_float);\r\nat91_sys_write(AT91_SMC_MODE(chipselect), mode);\r\nat91_sys_write(AT91_SMC_SETUP(chipselect), AT91_SMC_NWESETUP_(setup) |\r\nAT91_SMC_NCS_WRSETUP_(0) |\r\nAT91_SMC_NRDSETUP_(setup) |\r\nAT91_SMC_NCS_RDSETUP_(0));\r\nat91_sys_write(AT91_SMC_PULSE(chipselect), AT91_SMC_NWEPULSE_(pulse) |\r\nAT91_SMC_NCS_WRPULSE_(cycle) |\r\nAT91_SMC_NRDPULSE_(pulse) |\r\nAT91_SMC_NCS_RDPULSE_(cycle));\r\nat91_sys_write(AT91_SMC_CYCLE(chipselect), AT91_SMC_NWECYCLE_(cycle) |\r\nAT91_SMC_NRDCYCLE_(cycle));\r\n}\r\nstatic unsigned int calc_mck_cycles(unsigned int ns, unsigned int mck_hz)\r\n{\r\nu64 tmp = ns;\r\ntmp *= mck_hz;\r\ntmp += 1000*1000*1000 - 1;\r\ndo_div(tmp, 1000*1000*1000);\r\nreturn (unsigned int) tmp;\r\n}\r\nstatic void apply_timings(const u8 chipselect, const u8 pio,\r\nconst struct ide_timing *timing, int use_iordy)\r\n{\r\nunsigned int t0, t1, t2, t6z;\r\nunsigned int cycle, setup, pulse, data_float;\r\nunsigned int mck_hz;\r\nstruct clk *mck;\r\nt0 = timing->cyc8b;\r\nt1 = timing->setup;\r\nt2 = timing->act8b;\r\nt6z = (pio < 5) ? 30 : 20;\r\npdbg("t0=%u t1=%u t2=%u t6z=%u\n", t0, t1, t2, t6z);\r\nmck = clk_get(NULL, "mck");\r\nBUG_ON(IS_ERR(mck));\r\nmck_hz = clk_get_rate(mck);\r\npdbg("mck_hz=%u\n", mck_hz);\r\ncycle = calc_mck_cycles(t0, mck_hz);\r\nsetup = calc_mck_cycles(t1, mck_hz);\r\npulse = calc_mck_cycles(t2, mck_hz);\r\ndata_float = calc_mck_cycles(t6z, mck_hz);\r\npdbg("cycle=%u setup=%u pulse=%u data_float=%u\n",\r\ncycle, setup, pulse, data_float);\r\nset_smc_timings(chipselect, cycle, setup, pulse, data_float, use_iordy);\r\n}\r\nstatic void at91_ide_input_data(ide_drive_t *drive, struct ide_cmd *cmd,\r\nvoid *buf, unsigned int len)\r\n{\r\nide_hwif_t *hwif = drive->hwif;\r\nstruct ide_io_ports *io_ports = &hwif->io_ports;\r\nu8 chipselect = hwif->select_data;\r\nunsigned long mode;\r\npdbg("cs %u buf %p len %d\n", chipselect, buf, len);\r\nlen++;\r\nenter_16bit(chipselect, mode);\r\nreadsw((void __iomem *)io_ports->data_addr, buf, len / 2);\r\nleave_16bit(chipselect, mode);\r\n}\r\nstatic void at91_ide_output_data(ide_drive_t *drive, struct ide_cmd *cmd,\r\nvoid *buf, unsigned int len)\r\n{\r\nide_hwif_t *hwif = drive->hwif;\r\nstruct ide_io_ports *io_ports = &hwif->io_ports;\r\nu8 chipselect = hwif->select_data;\r\nunsigned long mode;\r\npdbg("cs %u buf %p len %d\n", chipselect, buf, len);\r\nenter_16bit(chipselect, mode);\r\nwritesw((void __iomem *)io_ports->data_addr, buf, len / 2);\r\nleave_16bit(chipselect, mode);\r\n}\r\nstatic void at91_ide_set_pio_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nstruct ide_timing *timing;\r\nu8 chipselect = hwif->select_data;\r\nint use_iordy = 0;\r\nconst u8 pio = drive->pio_mode - XFER_PIO_0;\r\npdbg("chipselect %u pio %u\n", chipselect, pio);\r\ntiming = ide_timing_find_mode(XFER_PIO_0 + pio);\r\nBUG_ON(!timing);\r\nif (ide_pio_need_iordy(drive, pio))\r\nuse_iordy = 1;\r\napply_timings(chipselect, pio, timing, use_iordy);\r\n}\r\nirqreturn_t at91_irq_handler(int irq, void *dev_id)\r\n{\r\nint ntries = 8;\r\nint pin_val1, pin_val2;\r\ndo {\r\npin_val1 = at91_get_gpio_value(irq);\r\npin_val2 = at91_get_gpio_value(irq);\r\n} while (pin_val1 != pin_val2 && --ntries > 0);\r\nif (pin_val1 == 0 || ntries <= 0)\r\nreturn IRQ_HANDLED;\r\nreturn ide_intr(irq, dev_id);\r\n}\r\nstatic int __init at91_ide_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct ide_hw hw, *hws[] = { &hw };\r\nstruct ide_host *host;\r\nstruct resource *res;\r\nunsigned long tf_base = 0, ctl_base = 0;\r\nstruct at91_cf_data *board = pdev->dev.platform_data;\r\nif (!board)\r\nreturn -ENODEV;\r\nif (board->det_pin && at91_get_gpio_value(board->det_pin) != 0) {\r\nperr("no device detected\n");\r\nreturn -ENODEV;\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\nperr("can't get memory resource\n");\r\nreturn -ENODEV;\r\n}\r\nif (!devm_request_mem_region(&pdev->dev, res->start + TASK_FILE,\r\nREGS_SIZE, "ide") ||\r\n!devm_request_mem_region(&pdev->dev, res->start + ALT_MODE,\r\nREGS_SIZE, "alt")) {\r\nperr("memory resources in use\n");\r\nreturn -EBUSY;\r\n}\r\npdbg("chipselect %u irq %u res %08lx\n", board->chipselect,\r\nboard->irq_pin, (unsigned long) res->start);\r\ntf_base = (unsigned long) devm_ioremap(&pdev->dev, res->start + TASK_FILE,\r\nREGS_SIZE);\r\nctl_base = (unsigned long) devm_ioremap(&pdev->dev, res->start + ALT_MODE,\r\nREGS_SIZE);\r\nif (!tf_base || !ctl_base) {\r\nperr("can't map memory regions\n");\r\nreturn -EBUSY;\r\n}\r\nmemset(&hw, 0, sizeof(hw));\r\nif (board->flags & AT91_IDE_SWAP_A0_A2) {\r\nhw.io_ports.data_addr = tf_base + 0;\r\nhw.io_ports.error_addr = tf_base + 4;\r\nhw.io_ports.nsect_addr = tf_base + 2;\r\nhw.io_ports.lbal_addr = tf_base + 6;\r\nhw.io_ports.lbam_addr = tf_base + 1;\r\nhw.io_ports.lbah_addr = tf_base + 5;\r\nhw.io_ports.device_addr = tf_base + 3;\r\nhw.io_ports.command_addr = tf_base + 7;\r\nhw.io_ports.ctl_addr = ctl_base + 3;\r\n} else\r\nide_std_init_ports(&hw, tf_base, ctl_base + 6);\r\nhw.irq = board->irq_pin;\r\nhw.dev = &pdev->dev;\r\nhost = ide_host_alloc(&at91_ide_port_info, hws, 1);\r\nif (!host) {\r\nperr("failed to allocate ide host\n");\r\nreturn -ENOMEM;\r\n}\r\napply_timings(board->chipselect, 0, ide_timing_find_mode(XFER_PIO_0), 0);\r\nif (board->irq_pin >= PIN_BASE)\r\nhost->irq_handler = at91_irq_handler;\r\nhost->ports[0]->select_data = board->chipselect;\r\nret = ide_host_register(host, &at91_ide_port_info, hws);\r\nif (ret) {\r\nperr("failed to register ide host\n");\r\ngoto err_free_host;\r\n}\r\nplatform_set_drvdata(pdev, host);\r\nreturn 0;\r\nerr_free_host:\r\nide_host_free(host);\r\nreturn ret;\r\n}\r\nstatic int __exit at91_ide_remove(struct platform_device *pdev)\r\n{\r\nstruct ide_host *host = platform_get_drvdata(pdev);\r\nide_host_remove(host);\r\nreturn 0;\r\n}\r\nstatic int __init at91_ide_init(void)\r\n{\r\nreturn platform_driver_probe(&at91_ide_driver, at91_ide_probe);\r\n}\r\nstatic void __exit at91_ide_exit(void)\r\n{\r\nplatform_driver_unregister(&at91_ide_driver);\r\n}

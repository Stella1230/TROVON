static inline struct pcf50633_adc *__to_adc(struct pcf50633 *pcf)\r\n{\r\nreturn platform_get_drvdata(pcf->adc_pdev);\r\n}\r\nstatic void adc_setup(struct pcf50633 *pcf, int channel, int avg)\r\n{\r\nchannel &= PCF50633_ADCC1_ADCMUX_MASK;\r\npcf50633_reg_write(pcf, PCF50633_REG_ADCC2, 0x00);\r\npcf50633_reg_write(pcf, PCF50633_REG_ADCC3, 0x01);\r\npcf50633_reg_write(pcf, PCF50633_REG_ADCC1, channel | avg |\r\nPCF50633_ADCC1_ADCSTART | PCF50633_ADCC1_RES_10BIT);\r\n}\r\nstatic void trigger_next_adc_job_if_any(struct pcf50633 *pcf)\r\n{\r\nstruct pcf50633_adc *adc = __to_adc(pcf);\r\nint head;\r\nhead = adc->queue_head;\r\nif (!adc->queue[head])\r\nreturn;\r\nadc_setup(pcf, adc->queue[head]->mux, adc->queue[head]->avg);\r\n}\r\nstatic int\r\nadc_enqueue_request(struct pcf50633 *pcf, struct pcf50633_adc_request *req)\r\n{\r\nstruct pcf50633_adc *adc = __to_adc(pcf);\r\nint head, tail;\r\nmutex_lock(&adc->queue_mutex);\r\nhead = adc->queue_head;\r\ntail = adc->queue_tail;\r\nif (adc->queue[tail]) {\r\nmutex_unlock(&adc->queue_mutex);\r\ndev_err(pcf->dev, "ADC queue is full, dropping request\n");\r\nreturn -EBUSY;\r\n}\r\nadc->queue[tail] = req;\r\nif (head == tail)\r\ntrigger_next_adc_job_if_any(pcf);\r\nadc->queue_tail = (tail + 1) & (PCF50633_MAX_ADC_FIFO_DEPTH - 1);\r\nmutex_unlock(&adc->queue_mutex);\r\nreturn 0;\r\n}\r\nstatic void pcf50633_adc_sync_read_callback(struct pcf50633 *pcf, void *param,\r\nint result)\r\n{\r\nstruct pcf50633_adc_sync_request *req = param;\r\nreq->result = result;\r\ncomplete(&req->completion);\r\n}\r\nint pcf50633_adc_sync_read(struct pcf50633 *pcf, int mux, int avg)\r\n{\r\nstruct pcf50633_adc_sync_request req;\r\nint ret;\r\ninit_completion(&req.completion);\r\nret = pcf50633_adc_async_read(pcf, mux, avg,\r\npcf50633_adc_sync_read_callback, &req);\r\nif (ret)\r\nreturn ret;\r\nwait_for_completion(&req.completion);\r\nreturn req.result;\r\n}\r\nint pcf50633_adc_async_read(struct pcf50633 *pcf, int mux, int avg,\r\nvoid (*callback)(struct pcf50633 *, void *, int),\r\nvoid *callback_param)\r\n{\r\nstruct pcf50633_adc_request *req;\r\nreq = kmalloc(sizeof(*req), GFP_KERNEL);\r\nif (!req)\r\nreturn -ENOMEM;\r\nreq->mux = mux;\r\nreq->avg = avg;\r\nreq->callback = callback;\r\nreq->callback_param = callback_param;\r\nreturn adc_enqueue_request(pcf, req);\r\n}\r\nstatic int adc_result(struct pcf50633 *pcf)\r\n{\r\nu8 adcs1, adcs3;\r\nu16 result;\r\nadcs1 = pcf50633_reg_read(pcf, PCF50633_REG_ADCS1);\r\nadcs3 = pcf50633_reg_read(pcf, PCF50633_REG_ADCS3);\r\nresult = (adcs1 << 2) | (adcs3 & PCF50633_ADCS3_ADCDAT1L_MASK);\r\ndev_dbg(pcf->dev, "adc result = %d\n", result);\r\nreturn result;\r\n}\r\nstatic void pcf50633_adc_irq(int irq, void *data)\r\n{\r\nstruct pcf50633_adc *adc = data;\r\nstruct pcf50633 *pcf = adc->pcf;\r\nstruct pcf50633_adc_request *req;\r\nint head, res;\r\nmutex_lock(&adc->queue_mutex);\r\nhead = adc->queue_head;\r\nreq = adc->queue[head];\r\nif (WARN_ON(!req)) {\r\ndev_err(pcf->dev, "pcf50633-adc irq: ADC queue empty!\n");\r\nmutex_unlock(&adc->queue_mutex);\r\nreturn;\r\n}\r\nadc->queue[head] = NULL;\r\nadc->queue_head = (head + 1) &\r\n(PCF50633_MAX_ADC_FIFO_DEPTH - 1);\r\nres = adc_result(pcf);\r\ntrigger_next_adc_job_if_any(pcf);\r\nmutex_unlock(&adc->queue_mutex);\r\nreq->callback(pcf, req->callback_param, res);\r\nkfree(req);\r\n}\r\nstatic int __devinit pcf50633_adc_probe(struct platform_device *pdev)\r\n{\r\nstruct pcf50633_adc *adc;\r\nadc = kzalloc(sizeof(*adc), GFP_KERNEL);\r\nif (!adc)\r\nreturn -ENOMEM;\r\nadc->pcf = dev_to_pcf50633(pdev->dev.parent);\r\nplatform_set_drvdata(pdev, adc);\r\npcf50633_register_irq(adc->pcf, PCF50633_IRQ_ADCRDY,\r\npcf50633_adc_irq, adc);\r\nmutex_init(&adc->queue_mutex);\r\nreturn 0;\r\n}\r\nstatic int __devexit pcf50633_adc_remove(struct platform_device *pdev)\r\n{\r\nstruct pcf50633_adc *adc = platform_get_drvdata(pdev);\r\nint i, head;\r\npcf50633_free_irq(adc->pcf, PCF50633_IRQ_ADCRDY);\r\nmutex_lock(&adc->queue_mutex);\r\nhead = adc->queue_head;\r\nif (WARN_ON(adc->queue[head]))\r\ndev_err(adc->pcf->dev,\r\n"adc driver removed with request pending\n");\r\nfor (i = 0; i < PCF50633_MAX_ADC_FIFO_DEPTH; i++)\r\nkfree(adc->queue[i]);\r\nmutex_unlock(&adc->queue_mutex);\r\nkfree(adc);\r\nreturn 0;\r\n}\r\nstatic int __init pcf50633_adc_init(void)\r\n{\r\nreturn platform_driver_register(&pcf50633_adc_driver);\r\n}\r\nstatic void __exit pcf50633_adc_exit(void)\r\n{\r\nplatform_driver_unregister(&pcf50633_adc_driver);\r\n}

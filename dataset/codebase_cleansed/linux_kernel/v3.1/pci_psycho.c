static irqreturn_t psycho_ue_intr(int irq, void *dev_id)\r\n{\r\nstruct pci_pbm_info *pbm = dev_id;\r\nunsigned long afsr_reg = pbm->controller_regs + PSYCHO_UE_AFSR;\r\nunsigned long afar_reg = pbm->controller_regs + PSYCHO_UE_AFAR;\r\nunsigned long afsr, afar, error_bits;\r\nint reported;\r\nafar = upa_readq(afar_reg);\r\nafsr = upa_readq(afsr_reg);\r\nerror_bits = afsr &\r\n(PSYCHO_UEAFSR_PPIO | PSYCHO_UEAFSR_PDRD | PSYCHO_UEAFSR_PDWR |\r\nPSYCHO_UEAFSR_SPIO | PSYCHO_UEAFSR_SDRD | PSYCHO_UEAFSR_SDWR);\r\nif (!error_bits)\r\nreturn IRQ_NONE;\r\nupa_writeq(error_bits, afsr_reg);\r\nprintk("%s: Uncorrectable Error, primary error type[%s]\n",\r\npbm->name,\r\n(((error_bits & PSYCHO_UEAFSR_PPIO) ?\r\n"PIO" :\r\n((error_bits & PSYCHO_UEAFSR_PDRD) ?\r\n"DMA Read" :\r\n((error_bits & PSYCHO_UEAFSR_PDWR) ?\r\n"DMA Write" : "???")))));\r\nprintk("%s: bytemask[%04lx] dword_offset[%lx] UPA_MID[%02lx] was_block(%d)\n",\r\npbm->name,\r\n(afsr & PSYCHO_UEAFSR_BMSK) >> 32UL,\r\n(afsr & PSYCHO_UEAFSR_DOFF) >> 29UL,\r\n(afsr & PSYCHO_UEAFSR_MID) >> 24UL,\r\n((afsr & PSYCHO_UEAFSR_BLK) ? 1 : 0));\r\nprintk("%s: UE AFAR [%016lx]\n", pbm->name, afar);\r\nprintk("%s: UE Secondary errors [", pbm->name);\r\nreported = 0;\r\nif (afsr & PSYCHO_UEAFSR_SPIO) {\r\nreported++;\r\nprintk("(PIO)");\r\n}\r\nif (afsr & PSYCHO_UEAFSR_SDRD) {\r\nreported++;\r\nprintk("(DMA Read)");\r\n}\r\nif (afsr & PSYCHO_UEAFSR_SDWR) {\r\nreported++;\r\nprintk("(DMA Write)");\r\n}\r\nif (!reported)\r\nprintk("(none)");\r\nprintk("]\n");\r\npsycho_check_iommu_error(pbm, afsr, afar, UE_ERR);\r\nif (pbm->sibling)\r\npsycho_check_iommu_error(pbm->sibling, afsr, afar, UE_ERR);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t psycho_ce_intr(int irq, void *dev_id)\r\n{\r\nstruct pci_pbm_info *pbm = dev_id;\r\nunsigned long afsr_reg = pbm->controller_regs + PSYCHO_CE_AFSR;\r\nunsigned long afar_reg = pbm->controller_regs + PSYCHO_CE_AFAR;\r\nunsigned long afsr, afar, error_bits;\r\nint reported;\r\nafar = upa_readq(afar_reg);\r\nafsr = upa_readq(afsr_reg);\r\nerror_bits = afsr &\r\n(PSYCHO_CEAFSR_PPIO | PSYCHO_CEAFSR_PDRD | PSYCHO_CEAFSR_PDWR |\r\nPSYCHO_CEAFSR_SPIO | PSYCHO_CEAFSR_SDRD | PSYCHO_CEAFSR_SDWR);\r\nif (!error_bits)\r\nreturn IRQ_NONE;\r\nupa_writeq(error_bits, afsr_reg);\r\nprintk("%s: Correctable Error, primary error type[%s]\n",\r\npbm->name,\r\n(((error_bits & PSYCHO_CEAFSR_PPIO) ?\r\n"PIO" :\r\n((error_bits & PSYCHO_CEAFSR_PDRD) ?\r\n"DMA Read" :\r\n((error_bits & PSYCHO_CEAFSR_PDWR) ?\r\n"DMA Write" : "???")))));\r\nprintk("%s: syndrome[%02lx] bytemask[%04lx] dword_offset[%lx] "\r\n"UPA_MID[%02lx] was_block(%d)\n",\r\npbm->name,\r\n(afsr & PSYCHO_CEAFSR_ESYND) >> 48UL,\r\n(afsr & PSYCHO_CEAFSR_BMSK) >> 32UL,\r\n(afsr & PSYCHO_CEAFSR_DOFF) >> 29UL,\r\n(afsr & PSYCHO_CEAFSR_MID) >> 24UL,\r\n((afsr & PSYCHO_CEAFSR_BLK) ? 1 : 0));\r\nprintk("%s: CE AFAR [%016lx]\n", pbm->name, afar);\r\nprintk("%s: CE Secondary errors [", pbm->name);\r\nreported = 0;\r\nif (afsr & PSYCHO_CEAFSR_SPIO) {\r\nreported++;\r\nprintk("(PIO)");\r\n}\r\nif (afsr & PSYCHO_CEAFSR_SDRD) {\r\nreported++;\r\nprintk("(DMA Read)");\r\n}\r\nif (afsr & PSYCHO_CEAFSR_SDWR) {\r\nreported++;\r\nprintk("(DMA Write)");\r\n}\r\nif (!reported)\r\nprintk("(none)");\r\nprintk("]\n");\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void psycho_register_error_handlers(struct pci_pbm_info *pbm)\r\n{\r\nstruct platform_device *op = of_find_device_by_node(pbm->op->dev.of_node);\r\nunsigned long base = pbm->controller_regs;\r\nu64 tmp;\r\nint err;\r\nif (!op)\r\nreturn;\r\nif (op->archdata.num_irqs < 6)\r\nreturn;\r\nerr = request_irq(op->archdata.irqs[1], psycho_ue_intr, IRQF_SHARED,\r\n"PSYCHO_UE", pbm);\r\nerr = request_irq(op->archdata.irqs[2], psycho_ce_intr, IRQF_SHARED,\r\n"PSYCHO_CE", pbm);\r\nerr = request_irq(op->archdata.irqs[0], psycho_pcierr_intr, IRQF_SHARED,\r\n"PSYCHO_PCIERR", pbm);\r\nif (err)\r\nprintk(KERN_WARNING "%s: Could not register PCIERR, "\r\n"err=%d\n", pbm->name, err);\r\nupa_writeq((PSYCHO_ECCCTRL_EE |\r\nPSYCHO_ECCCTRL_UE |\r\nPSYCHO_ECCCTRL_CE), base + PSYCHO_ECC_CTRL);\r\ntmp = upa_readq(base + PSYCHO_PCIA_CTRL);\r\ntmp |= (PSYCHO_PCICTRL_SERR |\r\nPSYCHO_PCICTRL_SBH_ERR |\r\nPSYCHO_PCICTRL_EEN);\r\ntmp &= ~(PSYCHO_PCICTRL_SBH_INT);\r\nupa_writeq(tmp, base + PSYCHO_PCIA_CTRL);\r\ntmp = upa_readq(base + PSYCHO_PCIB_CTRL);\r\ntmp |= (PSYCHO_PCICTRL_SERR |\r\nPSYCHO_PCICTRL_SBH_ERR |\r\nPSYCHO_PCICTRL_EEN);\r\ntmp &= ~(PSYCHO_PCICTRL_SBH_INT);\r\nupa_writeq(tmp, base + PSYCHO_PCIB_CTRL);\r\n}\r\nstatic void pbm_config_busmastering(struct pci_pbm_info *pbm)\r\n{\r\nu8 *addr;\r\naddr = psycho_pci_config_mkaddr(pbm, pbm->pci_first_busno,\r\n0, PCI_CACHE_LINE_SIZE);\r\npci_config_write8(addr, 64 / sizeof(u32));\r\naddr = psycho_pci_config_mkaddr(pbm, pbm->pci_first_busno,\r\n0, PCI_LATENCY_TIMER);\r\npci_config_write8(addr, 64);\r\n}\r\nstatic void __devinit psycho_scan_bus(struct pci_pbm_info *pbm,\r\nstruct device *parent)\r\n{\r\npbm_config_busmastering(pbm);\r\npbm->is_66mhz_capable = 0;\r\npbm->pci_bus = pci_scan_one_pbm(pbm, parent);\r\npsycho_register_error_handlers(pbm);\r\n}\r\nstatic void psycho_controller_hwinit(struct pci_pbm_info *pbm)\r\n{\r\nu64 tmp;\r\nupa_writeq(5, pbm->controller_regs + PSYCHO_IRQ_RETRY);\r\ntmp = upa_readq(pbm->controller_regs + PSYCHO_PCIA_CTRL);\r\ntmp |= PSYCHO_PCICTRL_AEN;\r\nupa_writeq(tmp, pbm->controller_regs + PSYCHO_PCIA_CTRL);\r\ntmp = upa_readq(pbm->controller_regs + PSYCHO_PCIB_CTRL);\r\ntmp |= PSYCHO_PCICTRL_AEN;\r\nupa_writeq(tmp, pbm->controller_regs + PSYCHO_PCIB_CTRL);\r\ntmp = upa_readq(pbm->controller_regs + PSYCHO_PCIA_DIAG);\r\ntmp |= PSYCHO_PCIDIAG_DDWSYNC;\r\nupa_writeq(tmp, pbm->controller_regs + PSYCHO_PCIA_DIAG);\r\ntmp = upa_readq(pbm->controller_regs + PSYCHO_PCIB_DIAG);\r\ntmp |= PSYCHO_PCIDIAG_DDWSYNC;\r\nupa_writeq(tmp, pbm->controller_regs + PSYCHO_PCIB_DIAG);\r\n}\r\nstatic void psycho_pbm_strbuf_init(struct pci_pbm_info *pbm,\r\nint is_pbm_a)\r\n{\r\nunsigned long base = pbm->controller_regs;\r\nu64 control;\r\nif (is_pbm_a) {\r\npbm->stc.strbuf_control = base + PSYCHO_STRBUF_CONTROL_A;\r\npbm->stc.strbuf_pflush = base + PSYCHO_STRBUF_FLUSH_A;\r\npbm->stc.strbuf_fsync = base + PSYCHO_STRBUF_FSYNC_A;\r\npbm->stc.strbuf_err_stat = base + PSYCHO_STC_ERR_A;\r\npbm->stc.strbuf_tag_diag = base + PSYCHO_STC_TAG_A;\r\npbm->stc.strbuf_line_diag= base + PSYCHO_STC_LINE_A;\r\n} else {\r\npbm->stc.strbuf_control = base + PSYCHO_STRBUF_CONTROL_B;\r\npbm->stc.strbuf_pflush = base + PSYCHO_STRBUF_FLUSH_B;\r\npbm->stc.strbuf_fsync = base + PSYCHO_STRBUF_FSYNC_B;\r\npbm->stc.strbuf_err_stat = base + PSYCHO_STC_ERR_B;\r\npbm->stc.strbuf_tag_diag = base + PSYCHO_STC_TAG_B;\r\npbm->stc.strbuf_line_diag= base + PSYCHO_STC_LINE_B;\r\n}\r\npbm->stc.strbuf_ctxflush = 0;\r\npbm->stc.strbuf_ctxmatch_base = 0;\r\npbm->stc.strbuf_flushflag = (volatile unsigned long *)\r\n((((unsigned long)&pbm->stc.__flushflag_buf[0])\r\n+ 63UL)\r\n& ~63UL);\r\npbm->stc.strbuf_flushflag_pa = (unsigned long)\r\n__pa(pbm->stc.strbuf_flushflag);\r\n#undef PSYCHO_STRBUF_RERUN_ENABLE\r\n#undef PSYCHO_STRBUF_RERUN_DISABLE\r\ncontrol = upa_readq(pbm->stc.strbuf_control);\r\ncontrol |= PSYCHO_STRBUF_CTRL_ENAB;\r\ncontrol &= ~(PSYCHO_STRBUF_CTRL_LENAB | PSYCHO_STRBUF_CTRL_LPTR);\r\n#ifdef PSYCHO_STRBUF_RERUN_ENABLE\r\ncontrol &= ~(PSYCHO_STRBUF_CTRL_RRDIS);\r\n#else\r\n#ifdef PSYCHO_STRBUF_RERUN_DISABLE\r\ncontrol |= PSYCHO_STRBUF_CTRL_RRDIS;\r\n#endif\r\n#endif\r\nupa_writeq(control, pbm->stc.strbuf_control);\r\npbm->stc.strbuf_enabled = 1;\r\n}\r\nstatic void __devinit psycho_pbm_init(struct pci_pbm_info *pbm,\r\nstruct platform_device *op, int is_pbm_a)\r\n{\r\npsycho_pbm_init_common(pbm, op, "PSYCHO", PBM_CHIP_TYPE_PSYCHO);\r\npsycho_pbm_strbuf_init(pbm, is_pbm_a);\r\npsycho_scan_bus(pbm, &op->dev);\r\n}\r\nstatic struct pci_pbm_info * __devinit psycho_find_sibling(u32 upa_portid)\r\n{\r\nstruct pci_pbm_info *pbm;\r\nfor (pbm = pci_pbm_root; pbm; pbm = pbm->next) {\r\nif (pbm->portid == upa_portid)\r\nreturn pbm;\r\n}\r\nreturn NULL;\r\n}\r\nstatic int __devinit psycho_probe(struct platform_device *op)\r\n{\r\nconst struct linux_prom64_registers *pr_regs;\r\nstruct device_node *dp = op->dev.of_node;\r\nstruct pci_pbm_info *pbm;\r\nstruct iommu *iommu;\r\nint is_pbm_a, err;\r\nu32 upa_portid;\r\nupa_portid = of_getintprop_default(dp, "upa-portid", 0xff);\r\nerr = -ENOMEM;\r\npbm = kzalloc(sizeof(*pbm), GFP_KERNEL);\r\nif (!pbm) {\r\nprintk(KERN_ERR PFX "Cannot allocate pci_pbm_info.\n");\r\ngoto out_err;\r\n}\r\npbm->sibling = psycho_find_sibling(upa_portid);\r\nif (pbm->sibling) {\r\niommu = pbm->sibling->iommu;\r\n} else {\r\niommu = kzalloc(sizeof(struct iommu), GFP_KERNEL);\r\nif (!iommu) {\r\nprintk(KERN_ERR PFX "Cannot allocate PBM iommu.\n");\r\ngoto out_free_controller;\r\n}\r\n}\r\npbm->iommu = iommu;\r\npbm->portid = upa_portid;\r\npr_regs = of_get_property(dp, "reg", NULL);\r\nerr = -ENODEV;\r\nif (!pr_regs) {\r\nprintk(KERN_ERR PFX "No reg property.\n");\r\ngoto out_free_iommu;\r\n}\r\nis_pbm_a = ((pr_regs[0].phys_addr & 0x6000) == 0x2000);\r\npbm->controller_regs = pr_regs[2].phys_addr;\r\npbm->config_space = (pr_regs[2].phys_addr + PSYCHO_CONFIGSPACE);\r\nif (is_pbm_a) {\r\npbm->pci_afsr = pbm->controller_regs + PSYCHO_PCI_AFSR_A;\r\npbm->pci_afar = pbm->controller_regs + PSYCHO_PCI_AFAR_A;\r\npbm->pci_csr = pbm->controller_regs + PSYCHO_PCIA_CTRL;\r\n} else {\r\npbm->pci_afsr = pbm->controller_regs + PSYCHO_PCI_AFSR_B;\r\npbm->pci_afar = pbm->controller_regs + PSYCHO_PCI_AFAR_B;\r\npbm->pci_csr = pbm->controller_regs + PSYCHO_PCIB_CTRL;\r\n}\r\npsycho_controller_hwinit(pbm);\r\nif (!pbm->sibling) {\r\nerr = psycho_iommu_init(pbm, 128, 0xc0000000,\r\n0xffffffff, PSYCHO_CONTROL);\r\nif (err)\r\ngoto out_free_iommu;\r\nif (this_is_starfire)\r\nstarfire_hookup(pbm->portid);\r\n}\r\npsycho_pbm_init(pbm, op, is_pbm_a);\r\npbm->next = pci_pbm_root;\r\npci_pbm_root = pbm;\r\nif (pbm->sibling)\r\npbm->sibling->sibling = pbm;\r\ndev_set_drvdata(&op->dev, pbm);\r\nreturn 0;\r\nout_free_iommu:\r\nif (!pbm->sibling)\r\nkfree(pbm->iommu);\r\nout_free_controller:\r\nkfree(pbm);\r\nout_err:\r\nreturn err;\r\n}\r\nstatic int __init psycho_init(void)\r\n{\r\nreturn platform_driver_register(&psycho_driver);\r\n}

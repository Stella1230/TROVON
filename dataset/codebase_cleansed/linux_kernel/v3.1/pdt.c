static char * __init of_pdt_build_full_name(struct device_node *dp)\r\n{\r\nint len, ourlen, plen;\r\nchar *n;\r\ndp->path_component_name = build_path_component(dp);\r\nplen = strlen(dp->parent->full_name);\r\nourlen = strlen(dp->path_component_name);\r\nlen = ourlen + plen + 2;\r\nn = prom_early_alloc(len);\r\nstrcpy(n, dp->parent->full_name);\r\nif (!of_node_is_root(dp->parent)) {\r\nstrcpy(n + plen, "/");\r\nplen++;\r\n}\r\nstrcpy(n + plen, dp->path_component_name);\r\nreturn n;\r\n}\r\nstatic inline void of_pdt_incr_unique_id(void *p) { }\r\nstatic inline void irq_trans_init(struct device_node *dp) { }\r\nstatic char * __init of_pdt_build_full_name(struct device_node *dp)\r\n{\r\nstatic int failsafe_id = 0;\r\nchar *buf;\r\nint len;\r\nif (of_pdt_prom_ops->pkg2path(dp->phandle, NULL, 0, &len))\r\ngoto failsafe;\r\nbuf = prom_early_alloc(len + 1);\r\nif (of_pdt_prom_ops->pkg2path(dp->phandle, buf, len, &len))\r\ngoto failsafe;\r\nreturn buf;\r\nfailsafe:\r\nbuf = prom_early_alloc(strlen(dp->parent->full_name) +\r\nstrlen(dp->name) + 16);\r\nsprintf(buf, "%s/%s@unknown%i",\r\nof_node_is_root(dp->parent) ? "" : dp->parent->full_name,\r\ndp->name, failsafe_id++);\r\npr_err("%s: pkg2path failed; assigning %s\n", __func__, buf);\r\nreturn buf;\r\n}\r\nstatic struct property * __init of_pdt_build_one_prop(phandle node, char *prev,\r\nchar *special_name,\r\nvoid *special_val,\r\nint special_len)\r\n{\r\nstatic struct property *tmp = NULL;\r\nstruct property *p;\r\nint err;\r\nif (tmp) {\r\np = tmp;\r\nmemset(p, 0, sizeof(*p) + 32);\r\ntmp = NULL;\r\n} else {\r\np = prom_early_alloc(sizeof(struct property) + 32);\r\nof_pdt_incr_unique_id(p);\r\n}\r\np->name = (char *) (p + 1);\r\nif (special_name) {\r\nstrcpy(p->name, special_name);\r\np->length = special_len;\r\np->value = prom_early_alloc(special_len);\r\nmemcpy(p->value, special_val, special_len);\r\n} else {\r\nerr = of_pdt_prom_ops->nextprop(node, prev, p->name);\r\nif (err) {\r\ntmp = p;\r\nreturn NULL;\r\n}\r\np->length = of_pdt_prom_ops->getproplen(node, p->name);\r\nif (p->length <= 0) {\r\np->length = 0;\r\n} else {\r\nint len;\r\np->value = prom_early_alloc(p->length + 1);\r\nlen = of_pdt_prom_ops->getproperty(node, p->name,\r\np->value, p->length);\r\nif (len <= 0)\r\np->length = 0;\r\n((unsigned char *)p->value)[p->length] = '\0';\r\n}\r\n}\r\nreturn p;\r\n}\r\nstatic struct property * __init of_pdt_build_prop_list(phandle node)\r\n{\r\nstruct property *head, *tail;\r\nhead = tail = of_pdt_build_one_prop(node, NULL,\r\n".node", &node, sizeof(node));\r\ntail->next = of_pdt_build_one_prop(node, NULL, NULL, NULL, 0);\r\ntail = tail->next;\r\nwhile(tail) {\r\ntail->next = of_pdt_build_one_prop(node, tail->name,\r\nNULL, NULL, 0);\r\ntail = tail->next;\r\n}\r\nreturn head;\r\n}\r\nstatic char * __init of_pdt_get_one_property(phandle node, const char *name)\r\n{\r\nchar *buf = "<NULL>";\r\nint len;\r\nlen = of_pdt_prom_ops->getproplen(node, name);\r\nif (len > 0) {\r\nbuf = prom_early_alloc(len);\r\nlen = of_pdt_prom_ops->getproperty(node, name, buf, len);\r\n}\r\nreturn buf;\r\n}\r\nstatic struct device_node * __init of_pdt_create_node(phandle node,\r\nstruct device_node *parent)\r\n{\r\nstruct device_node *dp;\r\nif (!node)\r\nreturn NULL;\r\ndp = prom_early_alloc(sizeof(*dp));\r\nof_pdt_incr_unique_id(dp);\r\ndp->parent = parent;\r\nkref_init(&dp->kref);\r\ndp->name = of_pdt_get_one_property(node, "name");\r\ndp->type = of_pdt_get_one_property(node, "device_type");\r\ndp->phandle = node;\r\ndp->properties = of_pdt_build_prop_list(node);\r\nirq_trans_init(dp);\r\nreturn dp;\r\n}\r\nstatic struct device_node * __init of_pdt_build_tree(struct device_node *parent,\r\nphandle node,\r\nstruct device_node ***nextp)\r\n{\r\nstruct device_node *ret = NULL, *prev_sibling = NULL;\r\nstruct device_node *dp;\r\nwhile (1) {\r\ndp = of_pdt_create_node(node, parent);\r\nif (!dp)\r\nbreak;\r\nif (prev_sibling)\r\nprev_sibling->sibling = dp;\r\nif (!ret)\r\nret = dp;\r\nprev_sibling = dp;\r\n*(*nextp) = dp;\r\n*nextp = &dp->allnext;\r\ndp->full_name = of_pdt_build_full_name(dp);\r\ndp->child = of_pdt_build_tree(dp,\r\nof_pdt_prom_ops->getchild(node), nextp);\r\nif (of_pdt_build_more)\r\nof_pdt_build_more(dp, nextp);\r\nnode = of_pdt_prom_ops->getsibling(node);\r\n}\r\nreturn ret;\r\n}\r\nvoid __init of_pdt_build_devicetree(phandle root_node, struct of_pdt_ops *ops)\r\n{\r\nstruct device_node **nextp;\r\nBUG_ON(!ops);\r\nof_pdt_prom_ops = ops;\r\nallnodes = of_pdt_create_node(root_node, NULL);\r\n#if defined(CONFIG_SPARC)\r\nallnodes->path_component_name = "";\r\n#endif\r\nallnodes->full_name = "/";\r\nnextp = &allnodes->allnext;\r\nallnodes->child = of_pdt_build_tree(allnodes,\r\nof_pdt_prom_ops->getchild(allnodes->phandle), &nextp);\r\n}

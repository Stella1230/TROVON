static int show_ctrl (struct controller *ctrl, char *buf)\r\n{\r\nchar *out = buf;\r\nint index;\r\nstruct pci_resource *res;\r\nout += sprintf(buf, "Free resources: memory\n");\r\nindex = 11;\r\nres = ctrl->mem_head;\r\nwhile (res && index--) {\r\nout += sprintf(out, "start = %8.8x, length = %8.8x\n", res->base, res->length);\r\nres = res->next;\r\n}\r\nout += sprintf(out, "Free resources: prefetchable memory\n");\r\nindex = 11;\r\nres = ctrl->p_mem_head;\r\nwhile (res && index--) {\r\nout += sprintf(out, "start = %8.8x, length = %8.8x\n", res->base, res->length);\r\nres = res->next;\r\n}\r\nout += sprintf(out, "Free resources: IO\n");\r\nindex = 11;\r\nres = ctrl->io_head;\r\nwhile (res && index--) {\r\nout += sprintf(out, "start = %8.8x, length = %8.8x\n", res->base, res->length);\r\nres = res->next;\r\n}\r\nout += sprintf(out, "Free resources: bus numbers\n");\r\nindex = 11;\r\nres = ctrl->bus_head;\r\nwhile (res && index--) {\r\nout += sprintf(out, "start = %8.8x, length = %8.8x\n", res->base, res->length);\r\nres = res->next;\r\n}\r\nreturn out - buf;\r\n}\r\nstatic int show_dev (struct controller *ctrl, char *buf)\r\n{\r\nchar * out = buf;\r\nint index;\r\nstruct pci_resource *res;\r\nstruct pci_func *new_slot;\r\nstruct slot *slot;\r\nslot = ctrl->slot;\r\nwhile (slot) {\r\nnew_slot = cpqhp_slot_find(slot->bus, slot->device, 0);\r\nif (!new_slot)\r\nbreak;\r\nout += sprintf(out, "assigned resources: memory\n");\r\nindex = 11;\r\nres = new_slot->mem_head;\r\nwhile (res && index--) {\r\nout += sprintf(out, "start = %8.8x, length = %8.8x\n", res->base, res->length);\r\nres = res->next;\r\n}\r\nout += sprintf(out, "assigned resources: prefetchable memory\n");\r\nindex = 11;\r\nres = new_slot->p_mem_head;\r\nwhile (res && index--) {\r\nout += sprintf(out, "start = %8.8x, length = %8.8x\n", res->base, res->length);\r\nres = res->next;\r\n}\r\nout += sprintf(out, "assigned resources: IO\n");\r\nindex = 11;\r\nres = new_slot->io_head;\r\nwhile (res && index--) {\r\nout += sprintf(out, "start = %8.8x, length = %8.8x\n", res->base, res->length);\r\nres = res->next;\r\n}\r\nout += sprintf(out, "assigned resources: bus numbers\n");\r\nindex = 11;\r\nres = new_slot->bus_head;\r\nwhile (res && index--) {\r\nout += sprintf(out, "start = %8.8x, length = %8.8x\n", res->base, res->length);\r\nres = res->next;\r\n}\r\nslot=slot->next;\r\n}\r\nreturn out - buf;\r\n}\r\nstatic int spew_debug_info(struct controller *ctrl, char *data, int size)\r\n{\r\nint used;\r\nused = size - show_ctrl(ctrl, data);\r\nused = (size - used) - show_dev(ctrl, &data[used]);\r\nreturn used;\r\n}\r\nstatic int open(struct inode *inode, struct file *file)\r\n{\r\nstruct controller *ctrl = inode->i_private;\r\nstruct ctrl_dbg *dbg;\r\nint retval = -ENOMEM;\r\nmutex_lock(&cpqphp_mutex);\r\ndbg = kmalloc(sizeof(*dbg), GFP_KERNEL);\r\nif (!dbg)\r\ngoto exit;\r\ndbg->data = kmalloc(MAX_OUTPUT, GFP_KERNEL);\r\nif (!dbg->data) {\r\nkfree(dbg);\r\ngoto exit;\r\n}\r\ndbg->size = spew_debug_info(ctrl, dbg->data, MAX_OUTPUT);\r\nfile->private_data = dbg;\r\nretval = 0;\r\nexit:\r\nmutex_unlock(&cpqphp_mutex);\r\nreturn retval;\r\n}\r\nstatic loff_t lseek(struct file *file, loff_t off, int whence)\r\n{\r\nstruct ctrl_dbg *dbg;\r\nloff_t new = -1;\r\nmutex_lock(&cpqphp_mutex);\r\ndbg = file->private_data;\r\nswitch (whence) {\r\ncase 0:\r\nnew = off;\r\nbreak;\r\ncase 1:\r\nnew = file->f_pos + off;\r\nbreak;\r\n}\r\nif (new < 0 || new > dbg->size) {\r\nmutex_unlock(&cpqphp_mutex);\r\nreturn -EINVAL;\r\n}\r\nmutex_unlock(&cpqphp_mutex);\r\nreturn (file->f_pos = new);\r\n}\r\nstatic ssize_t read(struct file *file, char __user *buf,\r\nsize_t nbytes, loff_t *ppos)\r\n{\r\nstruct ctrl_dbg *dbg = file->private_data;\r\nreturn simple_read_from_buffer(buf, nbytes, ppos, dbg->data, dbg->size);\r\n}\r\nstatic int release(struct inode *inode, struct file *file)\r\n{\r\nstruct ctrl_dbg *dbg = file->private_data;\r\nkfree(dbg->data);\r\nkfree(dbg);\r\nreturn 0;\r\n}\r\nvoid cpqhp_initialize_debugfs(void)\r\n{\r\nif (!root)\r\nroot = debugfs_create_dir("cpqhp", NULL);\r\n}\r\nvoid cpqhp_shutdown_debugfs(void)\r\n{\r\ndebugfs_remove(root);\r\n}\r\nvoid cpqhp_create_debugfs_files(struct controller *ctrl)\r\n{\r\nctrl->dentry = debugfs_create_file(dev_name(&ctrl->pci_dev->dev),\r\nS_IRUGO, root, ctrl, &debug_ops);\r\n}\r\nvoid cpqhp_remove_debugfs_files(struct controller *ctrl)\r\n{\r\nif (ctrl->dentry)\r\ndebugfs_remove(ctrl->dentry);\r\nctrl->dentry = NULL;\r\n}

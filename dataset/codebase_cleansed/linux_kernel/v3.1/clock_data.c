int __init omap1_clk_init(void)\r\n{\r\nstruct omap_clk *c;\r\nconst struct omap_clock_config *info;\r\nint crystal_type = 0;\r\nu32 reg, cpu_mask;\r\n#ifdef CONFIG_DEBUG_LL\r\nomap_writel(0x3 << 29, MOD_CONF_CTRL_0);\r\n#endif\r\nreg = omap_readw(SOFT_REQ_REG) & (1 << 4);\r\nomap_writew(reg, SOFT_REQ_REG);\r\nif (!cpu_is_omap15xx())\r\nomap_writew(0, SOFT_REQ_REG2);\r\nclk_init(&omap1_clk_functions);\r\narm_idlect1_mask = ~0;\r\nfor (c = omap_clks; c < omap_clks + ARRAY_SIZE(omap_clks); c++)\r\nclk_preinit(c->lk.clk);\r\ncpu_mask = 0;\r\nif (cpu_is_omap16xx())\r\ncpu_mask |= CK_16XX;\r\nif (cpu_is_omap1510())\r\ncpu_mask |= CK_1510;\r\nif (cpu_is_omap7xx())\r\ncpu_mask |= CK_7XX;\r\nif (cpu_is_omap310())\r\ncpu_mask |= CK_310;\r\nfor (c = omap_clks; c < omap_clks + ARRAY_SIZE(omap_clks); c++)\r\nif (c->cpu & cpu_mask) {\r\nclkdev_add(&c->lk);\r\nclk_register(c->lk.clk);\r\n}\r\napi_ck_p = clk_get(NULL, "api_ck");\r\nck_dpll1_p = clk_get(NULL, "ck_dpll1");\r\nck_ref_p = clk_get(NULL, "ck_ref");\r\ninfo = omap_get_config(OMAP_TAG_CLOCK, struct omap_clock_config);\r\nif (info != NULL) {\r\nif (!cpu_is_omap15xx())\r\ncrystal_type = info->system_clock_type;\r\n}\r\nif (cpu_is_omap7xx())\r\nck_ref.rate = 13000000;\r\nif (cpu_is_omap16xx() && crystal_type == 2)\r\nck_ref.rate = 19200000;\r\npr_info("Clocks: ARM_SYSST: 0x%04x DPLL_CTL: 0x%04x ARM_CKCTL: "\r\n"0x%04x\n", omap_readw(ARM_SYSST), omap_readw(DPLL_CTL),\r\nomap_readw(ARM_CKCTL));\r\nomap_writew(0x1000, ARM_SYSST);\r\n#ifdef CONFIG_OMAP_CLOCKS_SET_BY_BOOTLOADER\r\n{\r\nunsigned pll_ctl_val = omap_readw(DPLL_CTL);\r\nck_dpll1.rate = ck_ref.rate;\r\nif (pll_ctl_val & 0x10) {\r\nif (pll_ctl_val & 0xf80)\r\nck_dpll1.rate *= (pll_ctl_val & 0xf80) >> 7;\r\nck_dpll1.rate /= ((pll_ctl_val & 0x60) >> 5) + 1;\r\n} else {\r\nswitch (pll_ctl_val & 0xc) {\r\ncase 0:\r\nbreak;\r\ncase 0x4:\r\nck_dpll1.rate /= 2;\r\nbreak;\r\ndefault:\r\nck_dpll1.rate /= 4;\r\nbreak;\r\n}\r\n}\r\n}\r\n#else\r\nif (omap1_select_table_rate(&virtual_ck_mpu, ~0)) {\r\nprintk(KERN_ERR "System frequencies not set. Check your config.\n");\r\nomap_writew(0x2290, DPLL_CTL);\r\nomap_writew(cpu_is_omap7xx() ? 0x3005 : 0x1005, ARM_CKCTL);\r\nck_dpll1.rate = 60000000;\r\n}\r\n#endif\r\npropagate_rate(&ck_dpll1);\r\npropagate_rate(&ck_ref);\r\nprintk(KERN_INFO "Clocking rate (xtal/DPLL1/MPU): "\r\n"%ld.%01ld/%ld.%01ld/%ld.%01ld MHz\n",\r\nck_ref.rate / 1000000, (ck_ref.rate / 100000) % 10,\r\nck_dpll1.rate / 1000000, (ck_dpll1.rate / 100000) % 10,\r\narm_ck.rate / 1000000, (arm_ck.rate / 100000) % 10);\r\nif (machine_is_omap_perseus2() || machine_is_omap_fsample()) {\r\nomap_writew(omap_readw(OMAP7XX_PCC_UPLD_CTRL) & ~0x1,\r\nOMAP7XX_PCC_UPLD_CTRL);\r\n}\r\nif (machine_is_ams_delta())\r\nomap_writel(omap_readl(ULPD_CLOCK_CTRL) |\r\n(1 << SDW_MCLK_INV_BIT),\r\nULPD_CLOCK_CTRL);\r\nif (cpu_is_omap7xx())\r\nomap_writew(omap_readw(ARM_CKCTL) & 0x2fff, ARM_CKCTL);\r\nelse\r\nomap_writew(omap_readw(ARM_CKCTL) & 0x0fff, ARM_CKCTL);\r\nomap_writew(0, ARM_RSTCT1);\r\nomap_writew(1, ARM_RSTCT2);\r\nomap_writew(0x400, ARM_IDLECT1);\r\nomap_writew(0x0000, ARM_IDLECT2);\r\nclk_enable(&armper_ck.clk);\r\nclk_enable(&armxor_ck.clk);\r\nclk_enable(&armtim_ck.clk);\r\nif (cpu_is_omap15xx())\r\nclk_enable(&arm_gpio_ck);\r\nreturn 0;\r\n}

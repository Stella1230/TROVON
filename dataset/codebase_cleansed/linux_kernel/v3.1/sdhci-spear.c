static irqreturn_t sdhci_gpio_irq(int irq, void *dev_id)\r\n{\r\nstruct platform_device *pdev = dev_id;\r\nstruct sdhci_host *host = platform_get_drvdata(pdev);\r\nstruct spear_sdhci *sdhci = dev_get_platdata(&pdev->dev);\r\nunsigned long gpio_irq_type;\r\nint val;\r\nval = gpio_get_value(sdhci->data->card_int_gpio);\r\ngpio_irq_type = val ? IRQF_TRIGGER_LOW : IRQF_TRIGGER_HIGH;\r\nirq_set_irq_type(irq, gpio_irq_type);\r\nif (sdhci->data->card_power_gpio >= 0) {\r\nif (!sdhci->data->power_always_enb) {\r\nval = sdhci->data->power_active_high ? !val : val ;\r\ngpio_set_value(sdhci->data->card_power_gpio, val);\r\n}\r\n}\r\ntasklet_schedule(&host->card_tasklet);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __devinit sdhci_probe(struct platform_device *pdev)\r\n{\r\nstruct sdhci_host *host;\r\nstruct resource *iomem;\r\nstruct spear_sdhci *sdhci;\r\nint ret;\r\nBUG_ON(pdev == NULL);\r\niomem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!iomem) {\r\nret = -ENOMEM;\r\ndev_dbg(&pdev->dev, "memory resource not defined\n");\r\ngoto err;\r\n}\r\nif (!request_mem_region(iomem->start, resource_size(iomem),\r\n"spear-sdhci")) {\r\nret = -EBUSY;\r\ndev_dbg(&pdev->dev, "cannot request region\n");\r\ngoto err;\r\n}\r\nsdhci = kzalloc(sizeof(*sdhci), GFP_KERNEL);\r\nif (!sdhci) {\r\nret = -ENOMEM;\r\ndev_dbg(&pdev->dev, "cannot allocate memory for sdhci\n");\r\ngoto err_kzalloc;\r\n}\r\nsdhci->clk = clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(sdhci->clk)) {\r\nret = PTR_ERR(sdhci->clk);\r\ndev_dbg(&pdev->dev, "Error getting clock\n");\r\ngoto err_clk_get;\r\n}\r\nret = clk_enable(sdhci->clk);\r\nif (ret) {\r\ndev_dbg(&pdev->dev, "Error enabling clock\n");\r\ngoto err_clk_enb;\r\n}\r\nsdhci->data = dev_get_platdata(&pdev->dev);\r\npdev->dev.platform_data = sdhci;\r\nif (pdev->dev.parent)\r\nhost = sdhci_alloc_host(pdev->dev.parent, 0);\r\nelse\r\nhost = sdhci_alloc_host(&pdev->dev, 0);\r\nif (IS_ERR(host)) {\r\nret = PTR_ERR(host);\r\ndev_dbg(&pdev->dev, "error allocating host\n");\r\ngoto err_alloc_host;\r\n}\r\nhost->hw_name = "sdhci";\r\nhost->ops = &sdhci_pltfm_ops;\r\nhost->irq = platform_get_irq(pdev, 0);\r\nhost->quirks = SDHCI_QUIRK_BROKEN_ADMA;\r\nhost->ioaddr = ioremap(iomem->start, resource_size(iomem));\r\nif (!host->ioaddr) {\r\nret = -ENOMEM;\r\ndev_dbg(&pdev->dev, "failed to remap registers\n");\r\ngoto err_ioremap;\r\n}\r\nret = sdhci_add_host(host);\r\nif (ret) {\r\ndev_dbg(&pdev->dev, "error adding host\n");\r\ngoto err_add_host;\r\n}\r\nplatform_set_drvdata(pdev, host);\r\nif (!sdhci->data)\r\nreturn 0;\r\nif (sdhci->data->card_power_gpio >= 0) {\r\nint val = 0;\r\nret = gpio_request(sdhci->data->card_power_gpio, "sdhci");\r\nif (ret < 0) {\r\ndev_dbg(&pdev->dev, "gpio request fail: %d\n",\r\nsdhci->data->card_power_gpio);\r\ngoto err_pgpio_request;\r\n}\r\nif (sdhci->data->power_always_enb)\r\nval = sdhci->data->power_active_high;\r\nelse\r\nval = !sdhci->data->power_active_high;\r\nret = gpio_direction_output(sdhci->data->card_power_gpio, val);\r\nif (ret) {\r\ndev_dbg(&pdev->dev, "gpio set direction fail: %d\n",\r\nsdhci->data->card_power_gpio);\r\ngoto err_pgpio_direction;\r\n}\r\ngpio_set_value(sdhci->data->card_power_gpio, 1);\r\n}\r\nif (sdhci->data->card_int_gpio >= 0) {\r\nret = gpio_request(sdhci->data->card_int_gpio, "sdhci");\r\nif (ret < 0) {\r\ndev_dbg(&pdev->dev, "gpio request fail: %d\n",\r\nsdhci->data->card_int_gpio);\r\ngoto err_igpio_request;\r\n}\r\nret = gpio_direction_input(sdhci->data->card_int_gpio);\r\nif (ret) {\r\ndev_dbg(&pdev->dev, "gpio set direction fail: %d\n",\r\nsdhci->data->card_int_gpio);\r\ngoto err_igpio_direction;\r\n}\r\nret = request_irq(gpio_to_irq(sdhci->data->card_int_gpio),\r\nsdhci_gpio_irq, IRQF_TRIGGER_LOW,\r\nmmc_hostname(host->mmc), pdev);\r\nif (ret) {\r\ndev_dbg(&pdev->dev, "gpio request irq fail: %d\n",\r\nsdhci->data->card_int_gpio);\r\ngoto err_igpio_request_irq;\r\n}\r\n}\r\nreturn 0;\r\nerr_igpio_request_irq:\r\nerr_igpio_direction:\r\nif (sdhci->data->card_int_gpio >= 0)\r\ngpio_free(sdhci->data->card_int_gpio);\r\nerr_igpio_request:\r\nerr_pgpio_direction:\r\nif (sdhci->data->card_power_gpio >= 0)\r\ngpio_free(sdhci->data->card_power_gpio);\r\nerr_pgpio_request:\r\nplatform_set_drvdata(pdev, NULL);\r\nsdhci_remove_host(host, 1);\r\nerr_add_host:\r\niounmap(host->ioaddr);\r\nerr_ioremap:\r\nsdhci_free_host(host);\r\nerr_alloc_host:\r\nclk_disable(sdhci->clk);\r\nerr_clk_enb:\r\nclk_put(sdhci->clk);\r\nerr_clk_get:\r\nkfree(sdhci);\r\nerr_kzalloc:\r\nrelease_mem_region(iomem->start, resource_size(iomem));\r\nerr:\r\ndev_err(&pdev->dev, "spear-sdhci probe failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int __devexit sdhci_remove(struct platform_device *pdev)\r\n{\r\nstruct sdhci_host *host = platform_get_drvdata(pdev);\r\nstruct resource *iomem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nstruct spear_sdhci *sdhci = dev_get_platdata(&pdev->dev);\r\nint dead;\r\nu32 scratch;\r\nif (sdhci->data) {\r\nif (sdhci->data->card_int_gpio >= 0) {\r\nfree_irq(gpio_to_irq(sdhci->data->card_int_gpio), pdev);\r\ngpio_free(sdhci->data->card_int_gpio);\r\n}\r\nif (sdhci->data->card_power_gpio >= 0)\r\ngpio_free(sdhci->data->card_power_gpio);\r\n}\r\nplatform_set_drvdata(pdev, NULL);\r\ndead = 0;\r\nscratch = readl(host->ioaddr + SDHCI_INT_STATUS);\r\nif (scratch == (u32)-1)\r\ndead = 1;\r\nsdhci_remove_host(host, dead);\r\niounmap(host->ioaddr);\r\nsdhci_free_host(host);\r\nclk_disable(sdhci->clk);\r\nclk_put(sdhci->clk);\r\nkfree(sdhci);\r\nif (iomem)\r\nrelease_mem_region(iomem->start, resource_size(iomem));\r\nreturn 0;\r\n}\r\nstatic int __init sdhci_init(void)\r\n{\r\nreturn platform_driver_register(&sdhci_driver);\r\n}\r\nstatic void __exit sdhci_exit(void)\r\n{\r\nplatform_driver_unregister(&sdhci_driver);\r\n}

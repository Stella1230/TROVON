static void s3c24xx_snd_txctrl(int on)\r\n{\r\nu32 iisfcon;\r\nu32 iiscon;\r\nu32 iismod;\r\npr_debug("Entered %s\n", __func__);\r\niisfcon = readl(s3c24xx_i2s.regs + S3C2410_IISFCON);\r\niiscon = readl(s3c24xx_i2s.regs + S3C2410_IISCON);\r\niismod = readl(s3c24xx_i2s.regs + S3C2410_IISMOD);\r\npr_debug("r: IISCON: %x IISMOD: %x IISFCON: %x\n", iiscon, iismod, iisfcon);\r\nif (on) {\r\niisfcon |= S3C2410_IISFCON_TXDMA | S3C2410_IISFCON_TXENABLE;\r\niiscon |= S3C2410_IISCON_TXDMAEN | S3C2410_IISCON_IISEN;\r\niiscon &= ~S3C2410_IISCON_TXIDLE;\r\niismod |= S3C2410_IISMOD_TXMODE;\r\nwritel(iismod, s3c24xx_i2s.regs + S3C2410_IISMOD);\r\nwritel(iisfcon, s3c24xx_i2s.regs + S3C2410_IISFCON);\r\nwritel(iiscon, s3c24xx_i2s.regs + S3C2410_IISCON);\r\n} else {\r\niisfcon &= ~S3C2410_IISFCON_TXENABLE;\r\niisfcon &= ~S3C2410_IISFCON_TXDMA;\r\niiscon |= S3C2410_IISCON_TXIDLE;\r\niiscon &= ~S3C2410_IISCON_TXDMAEN;\r\niismod &= ~S3C2410_IISMOD_TXMODE;\r\nwritel(iiscon, s3c24xx_i2s.regs + S3C2410_IISCON);\r\nwritel(iisfcon, s3c24xx_i2s.regs + S3C2410_IISFCON);\r\nwritel(iismod, s3c24xx_i2s.regs + S3C2410_IISMOD);\r\n}\r\npr_debug("w: IISCON: %x IISMOD: %x IISFCON: %x\n", iiscon, iismod, iisfcon);\r\n}\r\nstatic void s3c24xx_snd_rxctrl(int on)\r\n{\r\nu32 iisfcon;\r\nu32 iiscon;\r\nu32 iismod;\r\npr_debug("Entered %s\n", __func__);\r\niisfcon = readl(s3c24xx_i2s.regs + S3C2410_IISFCON);\r\niiscon = readl(s3c24xx_i2s.regs + S3C2410_IISCON);\r\niismod = readl(s3c24xx_i2s.regs + S3C2410_IISMOD);\r\npr_debug("r: IISCON: %x IISMOD: %x IISFCON: %x\n", iiscon, iismod, iisfcon);\r\nif (on) {\r\niisfcon |= S3C2410_IISFCON_RXDMA | S3C2410_IISFCON_RXENABLE;\r\niiscon |= S3C2410_IISCON_RXDMAEN | S3C2410_IISCON_IISEN;\r\niiscon &= ~S3C2410_IISCON_RXIDLE;\r\niismod |= S3C2410_IISMOD_RXMODE;\r\nwritel(iismod, s3c24xx_i2s.regs + S3C2410_IISMOD);\r\nwritel(iisfcon, s3c24xx_i2s.regs + S3C2410_IISFCON);\r\nwritel(iiscon, s3c24xx_i2s.regs + S3C2410_IISCON);\r\n} else {\r\niisfcon &= ~S3C2410_IISFCON_RXENABLE;\r\niisfcon &= ~S3C2410_IISFCON_RXDMA;\r\niiscon |= S3C2410_IISCON_RXIDLE;\r\niiscon &= ~S3C2410_IISCON_RXDMAEN;\r\niismod &= ~S3C2410_IISMOD_RXMODE;\r\nwritel(iisfcon, s3c24xx_i2s.regs + S3C2410_IISFCON);\r\nwritel(iiscon, s3c24xx_i2s.regs + S3C2410_IISCON);\r\nwritel(iismod, s3c24xx_i2s.regs + S3C2410_IISMOD);\r\n}\r\npr_debug("w: IISCON: %x IISMOD: %x IISFCON: %x\n", iiscon, iismod, iisfcon);\r\n}\r\nstatic int s3c24xx_snd_lrsync(void)\r\n{\r\nu32 iiscon;\r\nint timeout = 50;\r\npr_debug("Entered %s\n", __func__);\r\nwhile (1) {\r\niiscon = readl(s3c24xx_i2s.regs + S3C2410_IISCON);\r\nif (iiscon & S3C2410_IISCON_LRINDEX)\r\nbreak;\r\nif (!timeout--)\r\nreturn -ETIMEDOUT;\r\nudelay(100);\r\n}\r\nreturn 0;\r\n}\r\nstatic inline int s3c24xx_snd_is_clkmaster(void)\r\n{\r\npr_debug("Entered %s\n", __func__);\r\nreturn (readl(s3c24xx_i2s.regs + S3C2410_IISMOD) & S3C2410_IISMOD_SLAVE) ? 0:1;\r\n}\r\nstatic int s3c24xx_i2s_set_fmt(struct snd_soc_dai *cpu_dai,\r\nunsigned int fmt)\r\n{\r\nu32 iismod;\r\npr_debug("Entered %s\n", __func__);\r\niismod = readl(s3c24xx_i2s.regs + S3C2410_IISMOD);\r\npr_debug("hw_params r: IISMOD: %x \n", iismod);\r\nswitch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {\r\ncase SND_SOC_DAIFMT_CBM_CFM:\r\niismod |= S3C2410_IISMOD_SLAVE;\r\nbreak;\r\ncase SND_SOC_DAIFMT_CBS_CFS:\r\niismod &= ~S3C2410_IISMOD_SLAVE;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\r\ncase SND_SOC_DAIFMT_LEFT_J:\r\niismod |= S3C2410_IISMOD_MSB;\r\nbreak;\r\ncase SND_SOC_DAIFMT_I2S:\r\niismod &= ~S3C2410_IISMOD_MSB;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nwritel(iismod, s3c24xx_i2s.regs + S3C2410_IISMOD);\r\npr_debug("hw_params w: IISMOD: %x \n", iismod);\r\nreturn 0;\r\n}\r\nstatic int s3c24xx_i2s_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct s3c_dma_params *dma_data;\r\nu32 iismod;\r\npr_debug("Entered %s\n", __func__);\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\ndma_data = &s3c24xx_i2s_pcm_stereo_out;\r\nelse\r\ndma_data = &s3c24xx_i2s_pcm_stereo_in;\r\nsnd_soc_dai_set_dma_data(rtd->cpu_dai, substream, dma_data);\r\niismod = readl(s3c24xx_i2s.regs + S3C2410_IISMOD);\r\npr_debug("hw_params r: IISMOD: %x\n", iismod);\r\nswitch (params_format(params)) {\r\ncase SNDRV_PCM_FORMAT_S8:\r\niismod &= ~S3C2410_IISMOD_16BIT;\r\ndma_data->dma_size = 1;\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S16_LE:\r\niismod |= S3C2410_IISMOD_16BIT;\r\ndma_data->dma_size = 2;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nwritel(iismod, s3c24xx_i2s.regs + S3C2410_IISMOD);\r\npr_debug("hw_params w: IISMOD: %x\n", iismod);\r\nreturn 0;\r\n}\r\nstatic int s3c24xx_i2s_trigger(struct snd_pcm_substream *substream, int cmd,\r\nstruct snd_soc_dai *dai)\r\n{\r\nint ret = 0;\r\nstruct s3c_dma_params *dma_data =\r\nsnd_soc_dai_get_dma_data(dai, substream);\r\npr_debug("Entered %s\n", __func__);\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\r\nif (!s3c24xx_snd_is_clkmaster()) {\r\nret = s3c24xx_snd_lrsync();\r\nif (ret)\r\ngoto exit_err;\r\n}\r\nif (substream->stream == SNDRV_PCM_STREAM_CAPTURE)\r\ns3c24xx_snd_rxctrl(1);\r\nelse\r\ns3c24xx_snd_txctrl(1);\r\ns3c2410_dma_ctrl(dma_data->channel, S3C2410_DMAOP_STARTED);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\r\nif (substream->stream == SNDRV_PCM_STREAM_CAPTURE)\r\ns3c24xx_snd_rxctrl(0);\r\nelse\r\ns3c24xx_snd_txctrl(0);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nexit_err:\r\nreturn ret;\r\n}\r\nstatic int s3c24xx_i2s_set_sysclk(struct snd_soc_dai *cpu_dai,\r\nint clk_id, unsigned int freq, int dir)\r\n{\r\nu32 iismod = readl(s3c24xx_i2s.regs + S3C2410_IISMOD);\r\npr_debug("Entered %s\n", __func__);\r\niismod &= ~S3C2440_IISMOD_MPLL;\r\nswitch (clk_id) {\r\ncase S3C24XX_CLKSRC_PCLK:\r\nbreak;\r\ncase S3C24XX_CLKSRC_MPLL:\r\niismod |= S3C2440_IISMOD_MPLL;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nwritel(iismod, s3c24xx_i2s.regs + S3C2410_IISMOD);\r\nreturn 0;\r\n}\r\nstatic int s3c24xx_i2s_set_clkdiv(struct snd_soc_dai *cpu_dai,\r\nint div_id, int div)\r\n{\r\nu32 reg;\r\npr_debug("Entered %s\n", __func__);\r\nswitch (div_id) {\r\ncase S3C24XX_DIV_BCLK:\r\nreg = readl(s3c24xx_i2s.regs + S3C2410_IISMOD) & ~S3C2410_IISMOD_FS_MASK;\r\nwritel(reg | div, s3c24xx_i2s.regs + S3C2410_IISMOD);\r\nbreak;\r\ncase S3C24XX_DIV_MCLK:\r\nreg = readl(s3c24xx_i2s.regs + S3C2410_IISMOD) & ~(S3C2410_IISMOD_384FS);\r\nwritel(reg | div, s3c24xx_i2s.regs + S3C2410_IISMOD);\r\nbreak;\r\ncase S3C24XX_DIV_PRESCALER:\r\nwritel(div, s3c24xx_i2s.regs + S3C2410_IISPSR);\r\nreg = readl(s3c24xx_i2s.regs + S3C2410_IISCON);\r\nwritel(reg | S3C2410_IISCON_PSCEN, s3c24xx_i2s.regs + S3C2410_IISCON);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nu32 s3c24xx_i2s_get_clockrate(void)\r\n{\r\nreturn clk_get_rate(s3c24xx_i2s.iis_clk);\r\n}\r\nstatic int s3c24xx_i2s_probe(struct snd_soc_dai *dai)\r\n{\r\npr_debug("Entered %s\n", __func__);\r\ns3c24xx_i2s.regs = ioremap(S3C2410_PA_IIS, 0x100);\r\nif (s3c24xx_i2s.regs == NULL)\r\nreturn -ENXIO;\r\ns3c24xx_i2s.iis_clk = clk_get(dai->dev, "iis");\r\nif (s3c24xx_i2s.iis_clk == NULL) {\r\npr_err("failed to get iis_clock\n");\r\niounmap(s3c24xx_i2s.regs);\r\nreturn -ENODEV;\r\n}\r\nclk_enable(s3c24xx_i2s.iis_clk);\r\ns3c2410_gpio_cfgpin(S3C2410_GPE0, S3C2410_GPE0_I2SLRCK);\r\ns3c2410_gpio_cfgpin(S3C2410_GPE1, S3C2410_GPE1_I2SSCLK);\r\ns3c2410_gpio_cfgpin(S3C2410_GPE2, S3C2410_GPE2_CDCLK);\r\ns3c2410_gpio_cfgpin(S3C2410_GPE3, S3C2410_GPE3_I2SSDI);\r\ns3c2410_gpio_cfgpin(S3C2410_GPE4, S3C2410_GPE4_I2SSDO);\r\nwritel(S3C2410_IISCON_IISEN, s3c24xx_i2s.regs + S3C2410_IISCON);\r\ns3c24xx_snd_txctrl(0);\r\ns3c24xx_snd_rxctrl(0);\r\nreturn 0;\r\n}\r\nstatic int s3c24xx_i2s_suspend(struct snd_soc_dai *cpu_dai)\r\n{\r\npr_debug("Entered %s\n", __func__);\r\ns3c24xx_i2s.iiscon = readl(s3c24xx_i2s.regs + S3C2410_IISCON);\r\ns3c24xx_i2s.iismod = readl(s3c24xx_i2s.regs + S3C2410_IISMOD);\r\ns3c24xx_i2s.iisfcon = readl(s3c24xx_i2s.regs + S3C2410_IISFCON);\r\ns3c24xx_i2s.iispsr = readl(s3c24xx_i2s.regs + S3C2410_IISPSR);\r\nclk_disable(s3c24xx_i2s.iis_clk);\r\nreturn 0;\r\n}\r\nstatic int s3c24xx_i2s_resume(struct snd_soc_dai *cpu_dai)\r\n{\r\npr_debug("Entered %s\n", __func__);\r\nclk_enable(s3c24xx_i2s.iis_clk);\r\nwritel(s3c24xx_i2s.iiscon, s3c24xx_i2s.regs + S3C2410_IISCON);\r\nwritel(s3c24xx_i2s.iismod, s3c24xx_i2s.regs + S3C2410_IISMOD);\r\nwritel(s3c24xx_i2s.iisfcon, s3c24xx_i2s.regs + S3C2410_IISFCON);\r\nwritel(s3c24xx_i2s.iispsr, s3c24xx_i2s.regs + S3C2410_IISPSR);\r\nreturn 0;\r\n}\r\nstatic __devinit int s3c24xx_iis_dev_probe(struct platform_device *pdev)\r\n{\r\nreturn snd_soc_register_dai(&pdev->dev, &s3c24xx_i2s_dai);\r\n}\r\nstatic __devexit int s3c24xx_iis_dev_remove(struct platform_device *pdev)\r\n{\r\nsnd_soc_unregister_dai(&pdev->dev);\r\nreturn 0;\r\n}\r\nstatic int __init s3c24xx_i2s_init(void)\r\n{\r\nreturn platform_driver_register(&s3c24xx_iis_driver);\r\n}\r\nstatic void __exit s3c24xx_i2s_exit(void)\r\n{\r\nplatform_driver_unregister(&s3c24xx_iis_driver);\r\n}

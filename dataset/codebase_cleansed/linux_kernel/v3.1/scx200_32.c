static void __devinit scx200_init_shadow(void)\r\n{\r\nint bank;\r\nfor (bank = 0; bank < 2; ++bank)\r\nscx200_gpio_shadow[bank] = inl(scx200_gpio_base + 0x10 * bank);\r\n}\r\nstatic int __devinit scx200_probe(struct pci_dev *pdev, const struct pci_device_id *ent)\r\n{\r\nunsigned base;\r\nif (pdev->device == PCI_DEVICE_ID_NS_SCx200_BRIDGE ||\r\npdev->device == PCI_DEVICE_ID_NS_SC1100_BRIDGE) {\r\nbase = pci_resource_start(pdev, 0);\r\nprintk(KERN_INFO NAME ": GPIO base 0x%x\n", base);\r\nif (!request_region(base, SCx200_GPIO_SIZE, "NatSemi SCx200 GPIO")) {\r\nprintk(KERN_ERR NAME ": can't allocate I/O for GPIOs\n");\r\nreturn -EBUSY;\r\n}\r\nscx200_gpio_base = base;\r\nscx200_init_shadow();\r\n} else {\r\nif (scx200_cb_probe(SCx200_CB_BASE_FIXED)) {\r\nscx200_cb_base = SCx200_CB_BASE_FIXED;\r\n} else {\r\npci_read_config_dword(pdev, SCx200_CBA_SCRATCH, &base);\r\nif (scx200_cb_probe(base)) {\r\nscx200_cb_base = base;\r\n} else {\r\nprintk(KERN_WARNING NAME ": Configuration Block not found\n");\r\nreturn -ENODEV;\r\n}\r\n}\r\nprintk(KERN_INFO NAME ": Configuration Block base 0x%x\n", scx200_cb_base);\r\n}\r\nreturn 0;\r\n}\r\nu32 scx200_gpio_configure(unsigned index, u32 mask, u32 bits)\r\n{\r\nu32 config, new_config;\r\nmutex_lock(&scx200_gpio_config_lock);\r\noutl(index, scx200_gpio_base + 0x20);\r\nconfig = inl(scx200_gpio_base + 0x24);\r\nnew_config = (config & mask) | bits;\r\noutl(new_config, scx200_gpio_base + 0x24);\r\nmutex_unlock(&scx200_gpio_config_lock);\r\nreturn config;\r\n}\r\nstatic int __init scx200_init(void)\r\n{\r\nprintk(KERN_INFO NAME ": NatSemi SCx200 Driver\n");\r\nreturn pci_register_driver(&scx200_pci_driver);\r\n}\r\nstatic void __exit scx200_cleanup(void)\r\n{\r\npci_unregister_driver(&scx200_pci_driver);\r\nrelease_region(scx200_gpio_base, SCx200_GPIO_SIZE);\r\n}

static int sm_block_markbad(struct mtd_info *mtd, loff_t ofs)\r\n{\r\nstruct mtd_oob_ops ops;\r\nstruct sm_oob oob;\r\nint ret, error = 0;\r\nmemset(&oob, -1, SM_OOB_SIZE);\r\noob.block_status = 0x0F;\r\nops.mode = MTD_OOB_PLACE;\r\nops.ooboffs = 0;\r\nops.ooblen = mtd->oobsize;\r\nops.oobbuf = (void *)&oob;\r\nops.datbuf = NULL;\r\nret = mtd->write_oob(mtd, ofs, &ops);\r\nif (ret < 0 || ops.oobretlen != SM_OOB_SIZE) {\r\nprintk(KERN_NOTICE\r\n"sm_common: can't mark sector at %i as bad\n",\r\n(int)ofs);\r\nerror = -EIO;\r\n} else\r\nmtd->ecc_stats.badblocks++;\r\nreturn error;\r\n}\r\nint sm_register_device(struct mtd_info *mtd, int smartmedia)\r\n{\r\nstruct nand_chip *chip = mtd->priv;\r\nint ret;\r\nchip->options |= NAND_SKIP_BBTSCAN;\r\nret = nand_scan_ident(mtd, 1, smartmedia ?\r\nnand_smartmedia_flash_ids : nand_xd_flash_ids);\r\nif (ret)\r\nreturn ret;\r\nchip->badblockpos = 0x05;\r\nchip->badblockbits = 7;\r\nchip->block_markbad = sm_block_markbad;\r\nif (mtd->writesize == SM_SECTOR_SIZE)\r\nchip->ecc.layout = &nand_oob_sm;\r\nelse if (mtd->writesize == SM_SMALL_PAGE)\r\nchip->ecc.layout = &nand_oob_sm_small;\r\nelse\r\nreturn -ENODEV;\r\nret = nand_scan_tail(mtd);\r\nif (ret)\r\nreturn ret;\r\nreturn mtd_device_register(mtd, NULL, 0);\r\n}

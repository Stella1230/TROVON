int fdt_setprop_inplace(void *fdt, int nodeoffset, const char *name,\r\nconst void *val, int len)\r\n{\r\nvoid *propval;\r\nint proplen;\r\npropval = fdt_getprop_w(fdt, nodeoffset, name, &proplen);\r\nif (! propval)\r\nreturn proplen;\r\nif (proplen != len)\r\nreturn -FDT_ERR_NOSPACE;\r\nmemcpy(propval, val, len);\r\nreturn 0;\r\n}\r\nstatic void _fdt_nop_region(void *start, int len)\r\n{\r\nuint32_t *p;\r\nfor (p = start; (char *)p < ((char *)start + len); p++)\r\n*p = cpu_to_fdt32(FDT_NOP);\r\n}\r\nint fdt_nop_property(void *fdt, int nodeoffset, const char *name)\r\n{\r\nstruct fdt_property *prop;\r\nint len;\r\nprop = fdt_get_property_w(fdt, nodeoffset, name, &len);\r\nif (! prop)\r\nreturn len;\r\n_fdt_nop_region(prop, len + sizeof(*prop));\r\nreturn 0;\r\n}\r\nint _fdt_node_end_offset(void *fdt, int nodeoffset)\r\n{\r\nint level = 0;\r\nuint32_t tag;\r\nint offset, nextoffset;\r\ntag = fdt_next_tag(fdt, nodeoffset, &nextoffset);\r\nif (tag != FDT_BEGIN_NODE)\r\nreturn -FDT_ERR_BADOFFSET;\r\ndo {\r\noffset = nextoffset;\r\ntag = fdt_next_tag(fdt, offset, &nextoffset);\r\nswitch (tag) {\r\ncase FDT_END:\r\nreturn offset;\r\ncase FDT_BEGIN_NODE:\r\nlevel++;\r\nbreak;\r\ncase FDT_END_NODE:\r\nlevel--;\r\nbreak;\r\ncase FDT_PROP:\r\ncase FDT_NOP:\r\nbreak;\r\ndefault:\r\nreturn -FDT_ERR_BADSTRUCTURE;\r\n}\r\n} while (level >= 0);\r\nreturn nextoffset;\r\n}\r\nint fdt_nop_node(void *fdt, int nodeoffset)\r\n{\r\nint endoffset;\r\nendoffset = _fdt_node_end_offset(fdt, nodeoffset);\r\nif (endoffset < 0)\r\nreturn endoffset;\r\n_fdt_nop_region(fdt_offset_ptr_w(fdt, nodeoffset, 0),\r\nendoffset - nodeoffset);\r\nreturn 0;\r\n}

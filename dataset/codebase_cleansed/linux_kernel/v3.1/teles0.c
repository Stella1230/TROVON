static inline u_char\r\nreadisac(void __iomem *adr, u_char off)\r\n{\r\nreturn readb(adr + ((off & 1) ? 0x2ff : 0x100) + off);\r\n}\r\nstatic inline void\r\nwriteisac(void __iomem *adr, u_char off, u_char data)\r\n{\r\nwriteb(data, adr + ((off & 1) ? 0x2ff : 0x100) + off); mb();\r\n}\r\nstatic inline u_char\r\nreadhscx(void __iomem *adr, int hscx, u_char off)\r\n{\r\nreturn readb(adr + (hscx ? 0x1c0 : 0x180) +\r\n((off & 1) ? 0x1ff : 0) + off);\r\n}\r\nstatic inline void\r\nwritehscx(void __iomem *adr, int hscx, u_char off, u_char data)\r\n{\r\nwriteb(data, adr + (hscx ? 0x1c0 : 0x180) +\r\n((off & 1) ? 0x1ff : 0) + off); mb();\r\n}\r\nstatic inline void\r\nread_fifo_isac(void __iomem *adr, u_char * data, int size)\r\n{\r\nregister int i;\r\nregister u_char __iomem *ad = adr + 0x100;\r\nfor (i = 0; i < size; i++)\r\ndata[i] = readb(ad);\r\n}\r\nstatic inline void\r\nwrite_fifo_isac(void __iomem *adr, u_char * data, int size)\r\n{\r\nregister int i;\r\nregister u_char __iomem *ad = adr + 0x100;\r\nfor (i = 0; i < size; i++) {\r\nwriteb(data[i], ad); mb();\r\n}\r\n}\r\nstatic inline void\r\nread_fifo_hscx(void __iomem *adr, int hscx, u_char * data, int size)\r\n{\r\nregister int i;\r\nregister u_char __iomem *ad = adr + (hscx ? 0x1c0 : 0x180);\r\nfor (i = 0; i < size; i++)\r\ndata[i] = readb(ad);\r\n}\r\nstatic inline void\r\nwrite_fifo_hscx(void __iomem *adr, int hscx, u_char * data, int size)\r\n{\r\nint i;\r\nregister u_char __iomem *ad = adr + (hscx ? 0x1c0 : 0x180);\r\nfor (i = 0; i < size; i++) {\r\nwriteb(data[i], ad); mb();\r\n}\r\n}\r\nstatic u_char\r\nReadISAC(struct IsdnCardState *cs, u_char offset)\r\n{\r\nreturn (readisac(cs->hw.teles0.membase, offset));\r\n}\r\nstatic void\r\nWriteISAC(struct IsdnCardState *cs, u_char offset, u_char value)\r\n{\r\nwriteisac(cs->hw.teles0.membase, offset, value);\r\n}\r\nstatic void\r\nReadISACfifo(struct IsdnCardState *cs, u_char * data, int size)\r\n{\r\nread_fifo_isac(cs->hw.teles0.membase, data, size);\r\n}\r\nstatic void\r\nWriteISACfifo(struct IsdnCardState *cs, u_char * data, int size)\r\n{\r\nwrite_fifo_isac(cs->hw.teles0.membase, data, size);\r\n}\r\nstatic u_char\r\nReadHSCX(struct IsdnCardState *cs, int hscx, u_char offset)\r\n{\r\nreturn (readhscx(cs->hw.teles0.membase, hscx, offset));\r\n}\r\nstatic void\r\nWriteHSCX(struct IsdnCardState *cs, int hscx, u_char offset, u_char value)\r\n{\r\nwritehscx(cs->hw.teles0.membase, hscx, offset, value);\r\n}\r\nstatic irqreturn_t\r\nteles0_interrupt(int intno, void *dev_id)\r\n{\r\nstruct IsdnCardState *cs = dev_id;\r\nu_char val;\r\nu_long flags;\r\nint count = 0;\r\nspin_lock_irqsave(&cs->lock, flags);\r\nval = readhscx(cs->hw.teles0.membase, 1, HSCX_ISTA);\r\nStart_HSCX:\r\nif (val)\r\nhscx_int_main(cs, val);\r\nval = readisac(cs->hw.teles0.membase, ISAC_ISTA);\r\nStart_ISAC:\r\nif (val)\r\nisac_interrupt(cs, val);\r\ncount++;\r\nval = readhscx(cs->hw.teles0.membase, 1, HSCX_ISTA);\r\nif (val && count < 5) {\r\nif (cs->debug & L1_DEB_HSCX)\r\ndebugl1(cs, "HSCX IntStat after IntRoutine");\r\ngoto Start_HSCX;\r\n}\r\nval = readisac(cs->hw.teles0.membase, ISAC_ISTA);\r\nif (val && count < 5) {\r\nif (cs->debug & L1_DEB_ISAC)\r\ndebugl1(cs, "ISAC IntStat after IntRoutine");\r\ngoto Start_ISAC;\r\n}\r\nwritehscx(cs->hw.teles0.membase, 0, HSCX_MASK, 0xFF);\r\nwritehscx(cs->hw.teles0.membase, 1, HSCX_MASK, 0xFF);\r\nwriteisac(cs->hw.teles0.membase, ISAC_MASK, 0xFF);\r\nwriteisac(cs->hw.teles0.membase, ISAC_MASK, 0x0);\r\nwritehscx(cs->hw.teles0.membase, 0, HSCX_MASK, 0x0);\r\nwritehscx(cs->hw.teles0.membase, 1, HSCX_MASK, 0x0);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void\r\nrelease_io_teles0(struct IsdnCardState *cs)\r\n{\r\nif (cs->hw.teles0.cfg_reg)\r\nrelease_region(cs->hw.teles0.cfg_reg, 8);\r\niounmap(cs->hw.teles0.membase);\r\nrelease_mem_region(cs->hw.teles0.phymem, TELES_IOMEM_SIZE);\r\n}\r\nstatic int\r\nreset_teles0(struct IsdnCardState *cs)\r\n{\r\nu_char cfval;\r\nif (cs->hw.teles0.cfg_reg) {\r\nswitch (cs->irq) {\r\ncase 2:\r\ncase 9:\r\ncfval = 0x00;\r\nbreak;\r\ncase 3:\r\ncfval = 0x02;\r\nbreak;\r\ncase 4:\r\ncfval = 0x04;\r\nbreak;\r\ncase 5:\r\ncfval = 0x06;\r\nbreak;\r\ncase 10:\r\ncfval = 0x08;\r\nbreak;\r\ncase 11:\r\ncfval = 0x0A;\r\nbreak;\r\ncase 12:\r\ncfval = 0x0C;\r\nbreak;\r\ncase 15:\r\ncfval = 0x0E;\r\nbreak;\r\ndefault:\r\nreturn(1);\r\n}\r\ncfval |= ((cs->hw.teles0.phymem >> 9) & 0xF0);\r\nbyteout(cs->hw.teles0.cfg_reg + 4, cfval);\r\nHZDELAY(HZ / 10 + 1);\r\nbyteout(cs->hw.teles0.cfg_reg + 4, cfval | 1);\r\nHZDELAY(HZ / 10 + 1);\r\n}\r\nwriteb(0, cs->hw.teles0.membase + 0x80); mb();\r\nHZDELAY(HZ / 5 + 1);\r\nwriteb(1, cs->hw.teles0.membase + 0x80); mb();\r\nHZDELAY(HZ / 5 + 1);\r\nreturn(0);\r\n}\r\nstatic int\r\nTeles_card_msg(struct IsdnCardState *cs, int mt, void *arg)\r\n{\r\nu_long flags;\r\nswitch (mt) {\r\ncase CARD_RESET:\r\nspin_lock_irqsave(&cs->lock, flags);\r\nreset_teles0(cs);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn(0);\r\ncase CARD_RELEASE:\r\nrelease_io_teles0(cs);\r\nreturn(0);\r\ncase CARD_INIT:\r\nspin_lock_irqsave(&cs->lock, flags);\r\ninithscxisac(cs, 3);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn(0);\r\ncase CARD_TEST:\r\nreturn(0);\r\n}\r\nreturn(0);\r\n}\r\nint __devinit\r\nsetup_teles0(struct IsdnCard *card)\r\n{\r\nu_char val;\r\nstruct IsdnCardState *cs = card->cs;\r\nchar tmp[64];\r\nstrcpy(tmp, teles0_revision);\r\nprintk(KERN_INFO "HiSax: Teles 8.0/16.0 driver Rev. %s\n", HiSax_getrev(tmp));\r\nif ((cs->typ != ISDN_CTYPE_16_0) && (cs->typ != ISDN_CTYPE_8_0))\r\nreturn (0);\r\nif (cs->typ == ISDN_CTYPE_16_0)\r\ncs->hw.teles0.cfg_reg = card->para[2];\r\nelse\r\ncs->hw.teles0.cfg_reg = 0;\r\nif (card->para[1] < 0x10000) {\r\ncard->para[1] <<= 4;\r\nprintk(KERN_INFO\r\n"Teles0: membase configured DOSish, assuming 0x%lx\n",\r\n(unsigned long) card->para[1]);\r\n}\r\ncs->irq = card->para[0];\r\nif (cs->hw.teles0.cfg_reg) {\r\nif (!request_region(cs->hw.teles0.cfg_reg, 8, "teles cfg")) {\r\nprintk(KERN_WARNING\r\n"HiSax: %s config port %x-%x already in use\n",\r\nCardType[card->typ],\r\ncs->hw.teles0.cfg_reg,\r\ncs->hw.teles0.cfg_reg + 8);\r\nreturn (0);\r\n}\r\n}\r\nif (cs->hw.teles0.cfg_reg) {\r\nif ((val = bytein(cs->hw.teles0.cfg_reg + 0)) != 0x51) {\r\nprintk(KERN_WARNING "Teles0: 16.0 Byte at %x is %x\n",\r\ncs->hw.teles0.cfg_reg + 0, val);\r\nrelease_region(cs->hw.teles0.cfg_reg, 8);\r\nreturn (0);\r\n}\r\nif ((val = bytein(cs->hw.teles0.cfg_reg + 1)) != 0x93) {\r\nprintk(KERN_WARNING "Teles0: 16.0 Byte at %x is %x\n",\r\ncs->hw.teles0.cfg_reg + 1, val);\r\nrelease_region(cs->hw.teles0.cfg_reg, 8);\r\nreturn (0);\r\n}\r\nval = bytein(cs->hw.teles0.cfg_reg + 2);\r\nif (val != 0x1e && val != 0x1f) {\r\nprintk(KERN_WARNING "Teles0: 16.0 Byte at %x is %x\n",\r\ncs->hw.teles0.cfg_reg + 2, val);\r\nrelease_region(cs->hw.teles0.cfg_reg, 8);\r\nreturn (0);\r\n}\r\n}\r\ntest_and_set_bit(HW_IOM1, &cs->HW_Flags);\r\ncs->hw.teles0.phymem = card->para[1];\r\nif (!request_mem_region(cs->hw.teles0.phymem, TELES_IOMEM_SIZE, "teles iomem")) {\r\nprintk(KERN_WARNING\r\n"HiSax: %s memory region %lx-%lx already in use\n",\r\nCardType[card->typ],\r\ncs->hw.teles0.phymem,\r\ncs->hw.teles0.phymem + TELES_IOMEM_SIZE);\r\nif (cs->hw.teles0.cfg_reg)\r\nrelease_region(cs->hw.teles0.cfg_reg, 8);\r\nreturn (0);\r\n}\r\ncs->hw.teles0.membase = ioremap(cs->hw.teles0.phymem, TELES_IOMEM_SIZE);\r\nprintk(KERN_INFO\r\n"HiSax: %s config irq:%d mem:%p cfg:0x%X\n",\r\nCardType[cs->typ], cs->irq,\r\ncs->hw.teles0.membase, cs->hw.teles0.cfg_reg);\r\nif (reset_teles0(cs)) {\r\nprintk(KERN_WARNING "Teles0: wrong IRQ\n");\r\nrelease_io_teles0(cs);\r\nreturn (0);\r\n}\r\nsetup_isac(cs);\r\ncs->readisac = &ReadISAC;\r\ncs->writeisac = &WriteISAC;\r\ncs->readisacfifo = &ReadISACfifo;\r\ncs->writeisacfifo = &WriteISACfifo;\r\ncs->BC_Read_Reg = &ReadHSCX;\r\ncs->BC_Write_Reg = &WriteHSCX;\r\ncs->BC_Send_Data = &hscx_fill_fifo;\r\ncs->cardmsg = &Teles_card_msg;\r\ncs->irq_func = &teles0_interrupt;\r\nISACVersion(cs, "Teles0:");\r\nif (HscxVersion(cs, "Teles0:")) {\r\nprintk(KERN_WARNING\r\n"Teles0: wrong HSCX versions check IO/MEM addresses\n");\r\nrelease_io_teles0(cs);\r\nreturn (0);\r\n}\r\nreturn (1);\r\n}

static inline struct spufs_calls *spufs_calls_get(void)\r\n{\r\nstruct spufs_calls *calls = NULL;\r\nrcu_read_lock();\r\ncalls = rcu_dereference(spufs_calls);\r\nif (calls && !try_module_get(calls->owner))\r\ncalls = NULL;\r\nrcu_read_unlock();\r\nreturn calls;\r\n}\r\nstatic inline void spufs_calls_put(struct spufs_calls *calls)\r\n{\r\nBUG_ON(calls != spufs_calls);\r\nmodule_put(spufs_calls->owner);\r\n}\r\nstatic inline struct spufs_calls *spufs_calls_get(void)\r\n{\r\nreturn spufs_calls;\r\n}\r\nstatic inline void spufs_calls_put(struct spufs_calls *calls) { }\r\nasmlinkage long sys_spu_create(const char __user *name,\r\nunsigned int flags, mode_t mode, int neighbor_fd)\r\n{\r\nlong ret;\r\nstruct file *neighbor;\r\nint fput_needed;\r\nstruct spufs_calls *calls;\r\ncalls = spufs_calls_get();\r\nif (!calls)\r\nreturn -ENOSYS;\r\nif (flags & SPU_CREATE_AFFINITY_SPU) {\r\nret = -EBADF;\r\nneighbor = fget_light(neighbor_fd, &fput_needed);\r\nif (neighbor) {\r\nret = calls->create_thread(name, flags, mode, neighbor);\r\nfput_light(neighbor, fput_needed);\r\n}\r\n} else\r\nret = calls->create_thread(name, flags, mode, NULL);\r\nspufs_calls_put(calls);\r\nreturn ret;\r\n}\r\nasmlinkage long sys_spu_run(int fd, __u32 __user *unpc, __u32 __user *ustatus)\r\n{\r\nlong ret;\r\nstruct file *filp;\r\nint fput_needed;\r\nstruct spufs_calls *calls;\r\ncalls = spufs_calls_get();\r\nif (!calls)\r\nreturn -ENOSYS;\r\nret = -EBADF;\r\nfilp = fget_light(fd, &fput_needed);\r\nif (filp) {\r\nret = calls->spu_run(filp, unpc, ustatus);\r\nfput_light(filp, fput_needed);\r\n}\r\nspufs_calls_put(calls);\r\nreturn ret;\r\n}\r\nint elf_coredump_extra_notes_size(void)\r\n{\r\nstruct spufs_calls *calls;\r\nint ret;\r\ncalls = spufs_calls_get();\r\nif (!calls)\r\nreturn 0;\r\nret = calls->coredump_extra_notes_size();\r\nspufs_calls_put(calls);\r\nreturn ret;\r\n}\r\nint elf_coredump_extra_notes_write(struct file *file, loff_t *foffset)\r\n{\r\nstruct spufs_calls *calls;\r\nint ret;\r\ncalls = spufs_calls_get();\r\nif (!calls)\r\nreturn 0;\r\nret = calls->coredump_extra_notes_write(file, foffset);\r\nspufs_calls_put(calls);\r\nreturn ret;\r\n}\r\nvoid notify_spus_active(void)\r\n{\r\nstruct spufs_calls *calls;\r\ncalls = spufs_calls_get();\r\nif (!calls)\r\nreturn;\r\ncalls->notify_spus_active();\r\nspufs_calls_put(calls);\r\nreturn;\r\n}\r\nint register_spu_syscalls(struct spufs_calls *calls)\r\n{\r\nif (spufs_calls)\r\nreturn -EBUSY;\r\nrcu_assign_pointer(spufs_calls, calls);\r\nreturn 0;\r\n}\r\nvoid unregister_spu_syscalls(struct spufs_calls *calls)\r\n{\r\nBUG_ON(spufs_calls->owner != calls->owner);\r\nrcu_assign_pointer(spufs_calls, NULL);\r\nsynchronize_rcu();\r\n}

static int st6422_probe(struct sd *sd)\r\n{\r\nstruct st6422_settings *sensor_settings;\r\nif (sd->bridge != BRIDGE_ST6422)\r\nreturn -ENODEV;\r\ninfo("st6422 sensor detected");\r\nsensor_settings = kmalloc(sizeof *sensor_settings, GFP_KERNEL);\r\nif (!sensor_settings)\r\nreturn -ENOMEM;\r\nsd->gspca_dev.cam.cam_mode = st6422_mode;\r\nsd->gspca_dev.cam.nmodes = ARRAY_SIZE(st6422_mode);\r\nsd->gspca_dev.cam.ctrls = sensor_settings->ctrls;\r\nsd->desc.ctrls = st6422_ctrl;\r\nsd->desc.nctrls = ARRAY_SIZE(st6422_ctrl);\r\nsd->sensor_priv = sensor_settings;\r\nreturn 0;\r\n}\r\nstatic int st6422_init(struct sd *sd)\r\n{\r\nint err = 0, i;\r\nconst u16 st6422_bridge_init[][2] = {\r\n{ STV_ISO_ENABLE, 0x00 },\r\n{ 0x1436, 0x00 },\r\n{ 0x1432, 0x03 },\r\n{ 0x143a, 0xf9 },\r\n{ 0x0509, 0x38 },\r\n{ 0x050a, 0x38 },\r\n{ 0x050b, 0x38 },\r\n{ 0x050c, 0x2a },\r\n{ 0x050d, 0x01 },\r\n{ 0x1431, 0x00 },\r\n{ 0x1433, 0x34 },\r\n{ 0x1438, 0x18 },\r\n{ 0x1439, 0x00 },\r\n{ 0x143b, 0x05 },\r\n{ 0x143c, 0x00 },\r\n{ 0x143e, 0x01 },\r\n{ 0x143d, 0x00 },\r\n{ 0x1442, 0xe2 },\r\n{ 0x1500, 0xd0 },\r\n{ 0x1500, 0xd0 },\r\n{ 0x1500, 0x50 },\r\n{ 0x1501, 0xaf },\r\n{ 0x1502, 0xc2 },\r\n{ 0x1503, 0x45 },\r\n{ 0x1505, 0x02 },\r\n{ 0x150e, 0x8e },\r\n{ 0x150f, 0x37 },\r\n{ 0x15c0, 0x00 },\r\n{ 0x15c3, 0x08 },\r\n{ 0x143f, 0x01 },\r\n};\r\nfor (i = 0; i < ARRAY_SIZE(st6422_bridge_init) && !err; i++) {\r\nerr = stv06xx_write_bridge(sd, st6422_bridge_init[i][0],\r\nst6422_bridge_init[i][1]);\r\n}\r\nreturn err;\r\n}\r\nstatic void st6422_disconnect(struct sd *sd)\r\n{\r\nsd->sensor = NULL;\r\nkfree(sd->sensor_priv);\r\n}\r\nstatic int setbrightness(struct sd *sd)\r\n{\r\nstruct st6422_settings *sensor_settings = sd->sensor_priv;\r\nreturn stv06xx_write_bridge(sd, 0x1432,\r\nsensor_settings->ctrls[BRIGHTNESS].val);\r\n}\r\nstatic int setcontrast(struct sd *sd)\r\n{\r\nstruct st6422_settings *sensor_settings = sd->sensor_priv;\r\nreturn stv06xx_write_bridge(sd, 0x143a,\r\nsensor_settings->ctrls[CONTRAST].val | 0xf0);\r\n}\r\nstatic int setgain(struct sd *sd)\r\n{\r\nstruct st6422_settings *sensor_settings = sd->sensor_priv;\r\nu8 gain;\r\nint err;\r\ngain = sensor_settings->ctrls[GAIN].val;\r\nerr = stv06xx_write_bridge(sd, 0x0509, gain);\r\nif (err < 0)\r\nreturn err;\r\nerr = stv06xx_write_bridge(sd, 0x050a, gain);\r\nif (err < 0)\r\nreturn err;\r\nerr = stv06xx_write_bridge(sd, 0x050b, gain);\r\nif (err < 0)\r\nreturn err;\r\nerr = stv06xx_write_bridge(sd, 0x050c, 0x2a);\r\nif (err < 0)\r\nreturn err;\r\nreturn stv06xx_write_bridge(sd, 0x050d, 0x01);\r\n}\r\nstatic int setexposure(struct sd *sd)\r\n{\r\nstruct st6422_settings *sensor_settings = sd->sensor_priv;\r\nu16 expo;\r\nint err;\r\nexpo = sensor_settings->ctrls[EXPOSURE].val;\r\nerr = stv06xx_write_bridge(sd, 0x143d, expo & 0xff);\r\nif (err < 0)\r\nreturn err;\r\nreturn stv06xx_write_bridge(sd, 0x143e, expo >> 8);\r\n}\r\nstatic int st6422_start(struct sd *sd)\r\n{\r\nint err;\r\nstruct cam *cam = &sd->gspca_dev.cam;\r\nif (cam->cam_mode[sd->gspca_dev.curr_mode].priv)\r\nerr = stv06xx_write_bridge(sd, 0x1505, 0x0f);\r\nelse\r\nerr = stv06xx_write_bridge(sd, 0x1505, 0x02);\r\nif (err < 0)\r\nreturn err;\r\nerr = setbrightness(sd);\r\nif (err < 0)\r\nreturn err;\r\nerr = setcontrast(sd);\r\nif (err < 0)\r\nreturn err;\r\nerr = setexposure(sd);\r\nif (err < 0)\r\nreturn err;\r\nerr = setgain(sd);\r\nif (err < 0)\r\nreturn err;\r\nerr = stv06xx_write_bridge(sd, 0x143f, 0x01);\r\nreturn (err < 0) ? err : 0;\r\n}\r\nstatic int st6422_stop(struct sd *sd)\r\n{\r\nPDEBUG(D_STREAM, "Halting stream");\r\nreturn 0;\r\n}\r\nstatic void st6422_set_brightness(struct gspca_dev *gspca_dev)\r\n{\r\nint err;\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nerr = setbrightness(sd);\r\nif (err >= 0)\r\nerr = stv06xx_write_bridge(sd, 0x143f, 0x01);\r\ngspca_dev->usb_err = err;\r\n}\r\nstatic void st6422_set_contrast(struct gspca_dev *gspca_dev)\r\n{\r\nint err;\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nerr = setcontrast(sd);\r\nif (err >= 0)\r\nerr = stv06xx_write_bridge(sd, 0x143f, 0x01);\r\ngspca_dev->usb_err = err;\r\n}\r\nstatic void st6422_set_gain(struct gspca_dev *gspca_dev)\r\n{\r\nint err;\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nerr = setgain(sd);\r\nif (err >= 0)\r\nerr = stv06xx_write_bridge(sd, 0x143f, 0x01);\r\ngspca_dev->usb_err = err;\r\n}\r\nstatic void st6422_set_exposure(struct gspca_dev *gspca_dev)\r\n{\r\nint err;\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nerr = setexposure(sd);\r\nif (err >= 0)\r\nerr = stv06xx_write_bridge(sd, 0x143f, 0x01);\r\ngspca_dev->usb_err = err;\r\n}

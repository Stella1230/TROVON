static void xfrm6_beet_make_header(struct sk_buff *skb)\r\n{\r\nstruct ipv6hdr *iph = ipv6_hdr(skb);\r\niph->version = 6;\r\nmemcpy(iph->flow_lbl, XFRM_MODE_SKB_CB(skb)->flow_lbl,\r\nsizeof(iph->flow_lbl));\r\niph->nexthdr = XFRM_MODE_SKB_CB(skb)->protocol;\r\nipv6_change_dsfield(iph, 0, XFRM_MODE_SKB_CB(skb)->tos);\r\niph->hop_limit = XFRM_MODE_SKB_CB(skb)->ttl;\r\n}\r\nstatic int xfrm6_beet_output(struct xfrm_state *x, struct sk_buff *skb)\r\n{\r\nstruct ipv6hdr *top_iph;\r\nstruct ip_beet_phdr *ph;\r\nint optlen, hdr_len;\r\nhdr_len = 0;\r\noptlen = XFRM_MODE_SKB_CB(skb)->optlen;\r\nif (unlikely(optlen))\r\nhdr_len += IPV4_BEET_PHMAXLEN - (optlen & 4);\r\nskb_set_network_header(skb, -x->props.header_len - hdr_len);\r\nif (x->sel.family != AF_INET6)\r\nskb->network_header += IPV4_BEET_PHMAXLEN;\r\nskb->mac_header = skb->network_header +\r\noffsetof(struct ipv6hdr, nexthdr);\r\nskb->transport_header = skb->network_header + sizeof(*top_iph);\r\nph = (struct ip_beet_phdr *)__skb_pull(skb, XFRM_MODE_SKB_CB(skb)->ihl-hdr_len);\r\nxfrm6_beet_make_header(skb);\r\ntop_iph = ipv6_hdr(skb);\r\nif (unlikely(optlen)) {\r\nBUG_ON(optlen < 0);\r\nph->padlen = 4 - (optlen & 4);\r\nph->hdrlen = optlen / 8;\r\nph->nexthdr = top_iph->nexthdr;\r\nif (ph->padlen)\r\nmemset(ph + 1, IPOPT_NOP, ph->padlen);\r\ntop_iph->nexthdr = IPPROTO_BEETPH;\r\n}\r\nipv6_addr_copy(&top_iph->saddr, (struct in6_addr *)&x->props.saddr);\r\nipv6_addr_copy(&top_iph->daddr, (struct in6_addr *)&x->id.daddr);\r\nreturn 0;\r\n}\r\nstatic int xfrm6_beet_input(struct xfrm_state *x, struct sk_buff *skb)\r\n{\r\nstruct ipv6hdr *ip6h;\r\nconst unsigned char *old_mac;\r\nint size = sizeof(struct ipv6hdr);\r\nint err;\r\nerr = skb_cow_head(skb, size + skb->mac_len);\r\nif (err)\r\ngoto out;\r\n__skb_push(skb, size);\r\nskb_reset_network_header(skb);\r\nold_mac = skb_mac_header(skb);\r\nskb_set_mac_header(skb, -skb->mac_len);\r\nmemmove(skb_mac_header(skb), old_mac, skb->mac_len);\r\nxfrm6_beet_make_header(skb);\r\nip6h = ipv6_hdr(skb);\r\nip6h->payload_len = htons(skb->len - size);\r\nipv6_addr_copy(&ip6h->daddr, (struct in6_addr *) &x->sel.daddr.a6);\r\nipv6_addr_copy(&ip6h->saddr, (struct in6_addr *) &x->sel.saddr.a6);\r\nerr = 0;\r\nout:\r\nreturn err;\r\n}\r\nstatic int __init xfrm6_beet_init(void)\r\n{\r\nreturn xfrm_register_mode(&xfrm6_beet_mode, AF_INET6);\r\n}\r\nstatic void __exit xfrm6_beet_exit(void)\r\n{\r\nint err;\r\nerr = xfrm_unregister_mode(&xfrm6_beet_mode, AF_INET6);\r\nBUG_ON(err);\r\n}

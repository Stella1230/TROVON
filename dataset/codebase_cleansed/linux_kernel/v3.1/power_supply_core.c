static int __power_supply_changed_work(struct device *dev, void *data)\r\n{\r\nstruct power_supply *psy = (struct power_supply *)data;\r\nstruct power_supply *pst = dev_get_drvdata(dev);\r\nint i;\r\nfor (i = 0; i < psy->num_supplicants; i++)\r\nif (!strcmp(psy->supplied_to[i], pst->name)) {\r\nif (pst->external_power_changed)\r\npst->external_power_changed(pst);\r\n}\r\nreturn 0;\r\n}\r\nstatic void power_supply_changed_work(struct work_struct *work)\r\n{\r\nstruct power_supply *psy = container_of(work, struct power_supply,\r\nchanged_work);\r\ndev_dbg(psy->dev, "%s\n", __func__);\r\nclass_for_each_device(power_supply_class, NULL, psy,\r\n__power_supply_changed_work);\r\npower_supply_update_leds(psy);\r\nkobject_uevent(&psy->dev->kobj, KOBJ_CHANGE);\r\n}\r\nvoid power_supply_changed(struct power_supply *psy)\r\n{\r\ndev_dbg(psy->dev, "%s\n", __func__);\r\nschedule_work(&psy->changed_work);\r\n}\r\nstatic int __power_supply_am_i_supplied(struct device *dev, void *data)\r\n{\r\nunion power_supply_propval ret = {0,};\r\nstruct power_supply *psy = (struct power_supply *)data;\r\nstruct power_supply *epsy = dev_get_drvdata(dev);\r\nint i;\r\nfor (i = 0; i < epsy->num_supplicants; i++) {\r\nif (!strcmp(epsy->supplied_to[i], psy->name)) {\r\nif (epsy->get_property(epsy,\r\nPOWER_SUPPLY_PROP_ONLINE, &ret))\r\ncontinue;\r\nif (ret.intval)\r\nreturn ret.intval;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint power_supply_am_i_supplied(struct power_supply *psy)\r\n{\r\nint error;\r\nerror = class_for_each_device(power_supply_class, NULL, psy,\r\n__power_supply_am_i_supplied);\r\ndev_dbg(psy->dev, "%s %d\n", __func__, error);\r\nreturn error;\r\n}\r\nstatic int __power_supply_is_system_supplied(struct device *dev, void *data)\r\n{\r\nunion power_supply_propval ret = {0,};\r\nstruct power_supply *psy = dev_get_drvdata(dev);\r\nif (psy->type != POWER_SUPPLY_TYPE_BATTERY) {\r\nif (psy->get_property(psy, POWER_SUPPLY_PROP_ONLINE, &ret))\r\nreturn 0;\r\nif (ret.intval)\r\nreturn ret.intval;\r\n}\r\nreturn 0;\r\n}\r\nint power_supply_is_system_supplied(void)\r\n{\r\nint error;\r\nerror = class_for_each_device(power_supply_class, NULL, NULL,\r\n__power_supply_is_system_supplied);\r\nreturn error;\r\n}\r\nint power_supply_set_battery_charged(struct power_supply *psy)\r\n{\r\nif (psy->type == POWER_SUPPLY_TYPE_BATTERY && psy->set_charged) {\r\npsy->set_charged(psy);\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int power_supply_match_device_by_name(struct device *dev, void *data)\r\n{\r\nconst char *name = data;\r\nstruct power_supply *psy = dev_get_drvdata(dev);\r\nreturn strcmp(psy->name, name) == 0;\r\n}\r\nstruct power_supply *power_supply_get_by_name(char *name)\r\n{\r\nstruct device *dev = class_find_device(power_supply_class, NULL, name,\r\npower_supply_match_device_by_name);\r\nreturn dev ? dev_get_drvdata(dev) : NULL;\r\n}\r\nstatic void power_supply_dev_release(struct device *dev)\r\n{\r\npr_debug("device: '%s': %s\n", dev_name(dev), __func__);\r\nkfree(dev);\r\n}\r\nint power_supply_register(struct device *parent, struct power_supply *psy)\r\n{\r\nstruct device *dev;\r\nint rc;\r\ndev = kzalloc(sizeof(*dev), GFP_KERNEL);\r\nif (!dev)\r\nreturn -ENOMEM;\r\ndevice_initialize(dev);\r\ndev->class = power_supply_class;\r\ndev->type = &power_supply_dev_type;\r\ndev->parent = parent;\r\ndev->release = power_supply_dev_release;\r\ndev_set_drvdata(dev, psy);\r\npsy->dev = dev;\r\nINIT_WORK(&psy->changed_work, power_supply_changed_work);\r\nrc = kobject_set_name(&dev->kobj, "%s", psy->name);\r\nif (rc)\r\ngoto kobject_set_name_failed;\r\nrc = device_add(dev);\r\nif (rc)\r\ngoto device_add_failed;\r\nrc = power_supply_create_triggers(psy);\r\nif (rc)\r\ngoto create_triggers_failed;\r\npower_supply_changed(psy);\r\ngoto success;\r\ncreate_triggers_failed:\r\ndevice_del(dev);\r\nkobject_set_name_failed:\r\ndevice_add_failed:\r\nput_device(dev);\r\nsuccess:\r\nreturn rc;\r\n}\r\nvoid power_supply_unregister(struct power_supply *psy)\r\n{\r\ncancel_work_sync(&psy->changed_work);\r\npower_supply_remove_triggers(psy);\r\ndevice_unregister(psy->dev);\r\n}\r\nstatic int __init power_supply_class_init(void)\r\n{\r\npower_supply_class = class_create(THIS_MODULE, "power_supply");\r\nif (IS_ERR(power_supply_class))\r\nreturn PTR_ERR(power_supply_class);\r\npower_supply_class->dev_uevent = power_supply_uevent;\r\npower_supply_init_attrs(&power_supply_dev_type);\r\nreturn 0;\r\n}\r\nstatic void __exit power_supply_class_exit(void)\r\n{\r\nclass_destroy(power_supply_class);\r\n}

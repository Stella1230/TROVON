static pmd_t *resume_one_md_table_init(pgd_t *pgd)\r\n{\r\npud_t *pud;\r\npmd_t *pmd_table;\r\n#ifdef CONFIG_X86_PAE\r\npmd_table = (pmd_t *)get_safe_page(GFP_ATOMIC);\r\nif (!pmd_table)\r\nreturn NULL;\r\nset_pgd(pgd, __pgd(__pa(pmd_table) | _PAGE_PRESENT));\r\npud = pud_offset(pgd, 0);\r\nBUG_ON(pmd_table != pmd_offset(pud, 0));\r\n#else\r\npud = pud_offset(pgd, 0);\r\npmd_table = pmd_offset(pud, 0);\r\n#endif\r\nreturn pmd_table;\r\n}\r\nstatic pte_t *resume_one_page_table_init(pmd_t *pmd)\r\n{\r\nif (pmd_none(*pmd)) {\r\npte_t *page_table = (pte_t *)get_safe_page(GFP_ATOMIC);\r\nif (!page_table)\r\nreturn NULL;\r\nset_pmd(pmd, __pmd(__pa(page_table) | _PAGE_TABLE));\r\nBUG_ON(page_table != pte_offset_kernel(pmd, 0));\r\nreturn page_table;\r\n}\r\nreturn pte_offset_kernel(pmd, 0);\r\n}\r\nstatic int resume_physical_mapping_init(pgd_t *pgd_base)\r\n{\r\nunsigned long pfn;\r\npgd_t *pgd;\r\npmd_t *pmd;\r\npte_t *pte;\r\nint pgd_idx, pmd_idx;\r\npgd_idx = pgd_index(PAGE_OFFSET);\r\npgd = pgd_base + pgd_idx;\r\npfn = 0;\r\nfor (; pgd_idx < PTRS_PER_PGD; pgd++, pgd_idx++) {\r\npmd = resume_one_md_table_init(pgd);\r\nif (!pmd)\r\nreturn -ENOMEM;\r\nif (pfn >= max_low_pfn)\r\ncontinue;\r\nfor (pmd_idx = 0; pmd_idx < PTRS_PER_PMD; pmd++, pmd_idx++) {\r\nif (pfn >= max_low_pfn)\r\nbreak;\r\nif (cpu_has_pse) {\r\nset_pmd(pmd, pfn_pmd(pfn, PAGE_KERNEL_LARGE_EXEC));\r\npfn += PTRS_PER_PTE;\r\n} else {\r\npte_t *max_pte;\r\npte = resume_one_page_table_init(pmd);\r\nif (!pte)\r\nreturn -ENOMEM;\r\nmax_pte = pte + PTRS_PER_PTE;\r\nfor (; pte < max_pte; pte++, pfn++) {\r\nif (pfn >= max_low_pfn)\r\nbreak;\r\nset_pte(pte, pfn_pte(pfn, PAGE_KERNEL_EXEC));\r\n}\r\n}\r\n}\r\n}\r\nresume_map_numa_kva(pgd_base);\r\nreturn 0;\r\n}\r\nstatic inline void resume_init_first_level_page_table(pgd_t *pg_dir)\r\n{\r\n#ifdef CONFIG_X86_PAE\r\nint i;\r\nfor (i = 0; i < PTRS_PER_PGD; i++)\r\nset_pgd(pg_dir + i,\r\n__pgd(__pa(empty_zero_page) | _PAGE_PRESENT));\r\n#endif\r\n}\r\nint swsusp_arch_resume(void)\r\n{\r\nint error;\r\nresume_pg_dir = (pgd_t *)get_safe_page(GFP_ATOMIC);\r\nif (!resume_pg_dir)\r\nreturn -ENOMEM;\r\nresume_init_first_level_page_table(resume_pg_dir);\r\nerror = resume_physical_mapping_init(resume_pg_dir);\r\nif (error)\r\nreturn error;\r\nrestore_image();\r\nreturn 0;\r\n}\r\nint pfn_is_nosave(unsigned long pfn)\r\n{\r\nunsigned long nosave_begin_pfn = __pa_symbol(&__nosave_begin) >> PAGE_SHIFT;\r\nunsigned long nosave_end_pfn = PAGE_ALIGN(__pa_symbol(&__nosave_end)) >> PAGE_SHIFT;\r\nreturn (pfn >= nosave_begin_pfn) && (pfn < nosave_end_pfn);\r\n}

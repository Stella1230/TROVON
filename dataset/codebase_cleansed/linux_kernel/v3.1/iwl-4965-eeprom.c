int iwl4965_eeprom_acquire_semaphore(struct iwl_priv *priv)\r\n{\r\nu16 count;\r\nint ret;\r\nfor (count = 0; count < EEPROM_SEM_RETRY_LIMIT; count++) {\r\niwl_legacy_set_bit(priv, CSR_HW_IF_CONFIG_REG,\r\nCSR_HW_IF_CONFIG_REG_BIT_EEPROM_OWN_SEM);\r\nret = iwl_poll_bit(priv, CSR_HW_IF_CONFIG_REG,\r\nCSR_HW_IF_CONFIG_REG_BIT_EEPROM_OWN_SEM,\r\nCSR_HW_IF_CONFIG_REG_BIT_EEPROM_OWN_SEM,\r\nEEPROM_SEM_TIMEOUT);\r\nif (ret >= 0) {\r\nIWL_DEBUG_IO(priv,\r\n"Acquired semaphore after %d tries.\n",\r\ncount+1);\r\nreturn ret;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nvoid iwl4965_eeprom_release_semaphore(struct iwl_priv *priv)\r\n{\r\niwl_legacy_clear_bit(priv, CSR_HW_IF_CONFIG_REG,\r\nCSR_HW_IF_CONFIG_REG_BIT_EEPROM_OWN_SEM);\r\n}\r\nint iwl4965_eeprom_check_version(struct iwl_priv *priv)\r\n{\r\nu16 eeprom_ver;\r\nu16 calib_ver;\r\neeprom_ver = iwl_legacy_eeprom_query16(priv, EEPROM_VERSION);\r\ncalib_ver = iwl_legacy_eeprom_query16(priv,\r\nEEPROM_4965_CALIB_VERSION_OFFSET);\r\nif (eeprom_ver < priv->cfg->eeprom_ver ||\r\ncalib_ver < priv->cfg->eeprom_calib_ver)\r\ngoto err;\r\nIWL_INFO(priv, "device EEPROM VER=0x%x, CALIB=0x%x\n",\r\neeprom_ver, calib_ver);\r\nreturn 0;\r\nerr:\r\nIWL_ERR(priv, "Unsupported (too old) EEPROM VER=0x%x < 0x%x "\r\n"CALIB=0x%x < 0x%x\n",\r\neeprom_ver, priv->cfg->eeprom_ver,\r\ncalib_ver, priv->cfg->eeprom_calib_ver);\r\nreturn -EINVAL;\r\n}\r\nvoid iwl4965_eeprom_get_mac(const struct iwl_priv *priv, u8 *mac)\r\n{\r\nconst u8 *addr = iwl_legacy_eeprom_query_addr(priv,\r\nEEPROM_MAC_ADDRESS);\r\nmemcpy(mac, addr, ETH_ALEN);\r\n}

int mpc7448_hpc2_exclude_device(struct pci_controller *hose,\r\nu_char bus, u_char devfn)\r\n{\r\nif (bus == 0 && PCI_SLOT(devfn) == 0)\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nelse\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic void __init mpc7448_hpc2_setup_arch(void)\r\n{\r\nstruct device_node *np;\r\nif (ppc_md.progress)\r\nppc_md.progress("mpc7448_hpc2_setup_arch():set_bridge", 0);\r\ntsi108_csr_vir_base = get_vir_csrbase();\r\n#ifdef CONFIG_PCI\r\nfor_each_compatible_node(np, "pci", "tsi108-pci")\r\ntsi108_setup_pci(np, MPC7448HPC2_PCI_CFG_PHYS, 0);\r\nppc_md.pci_exclude_device = mpc7448_hpc2_exclude_device;\r\nif (ppc_md.progress)\r\nppc_md.progress("tsi108: resources set", 0x100);\r\n#endif\r\nprintk(KERN_INFO "MPC7448HPC2 (TAIGA) Platform\n");\r\nprintk(KERN_INFO\r\n"Jointly ported by Freescale and Tundra Semiconductor\n");\r\nprintk(KERN_INFO\r\n"Enabling L2 cache then enabling the HID0 prefetch engine.\n");\r\n}\r\nstatic void __init mpc7448_hpc2_init_IRQ(void)\r\n{\r\nstruct mpic *mpic;\r\nphys_addr_t mpic_paddr = 0;\r\nstruct device_node *tsi_pic;\r\n#ifdef CONFIG_PCI\r\nunsigned int cascade_pci_irq;\r\nstruct device_node *tsi_pci;\r\nstruct device_node *cascade_node = NULL;\r\n#endif\r\ntsi_pic = of_find_node_by_type(NULL, "open-pic");\r\nif (tsi_pic) {\r\nunsigned int size;\r\nconst void *prop = of_get_property(tsi_pic, "reg", &size);\r\nmpic_paddr = of_translate_address(tsi_pic, prop);\r\n}\r\nif (mpic_paddr == 0) {\r\nprintk("%s: No tsi108 PIC found !\n", __func__);\r\nreturn;\r\n}\r\nDBG("%s: tsi108 pic phys_addr = 0x%x\n", __func__,\r\n(u32) mpic_paddr);\r\nmpic = mpic_alloc(tsi_pic, mpic_paddr,\r\nMPIC_PRIMARY | MPIC_BIG_ENDIAN | MPIC_WANTS_RESET |\r\nMPIC_SPV_EOI | MPIC_NO_PTHROU_DIS | MPIC_REGSET_TSI108,\r\n24,\r\nNR_IRQS-4,\r\n"Tsi108_PIC");\r\nBUG_ON(mpic == NULL);\r\nmpic_assign_isu(mpic, 0, mpic_paddr + 0x100);\r\nmpic_init(mpic);\r\n#ifdef CONFIG_PCI\r\ntsi_pci = of_find_node_by_type(NULL, "pci");\r\nif (tsi_pci == NULL) {\r\nprintk("%s: No tsi108 pci node found !\n", __func__);\r\nreturn;\r\n}\r\ncascade_node = of_find_node_by_type(NULL, "pic-router");\r\nif (cascade_node == NULL) {\r\nprintk("%s: No tsi108 pci cascade node found !\n", __func__);\r\nreturn;\r\n}\r\ncascade_pci_irq = irq_of_parse_and_map(tsi_pci, 0);\r\nDBG("%s: tsi108 cascade_pci_irq = 0x%x\n", __func__,\r\n(u32) cascade_pci_irq);\r\ntsi108_pci_int_init(cascade_node);\r\nirq_set_handler_data(cascade_pci_irq, mpic);\r\nirq_set_chained_handler(cascade_pci_irq, tsi108_irq_cascade);\r\n#endif\r\ntsi108_write_reg(TSI108_MPIC_OFFSET + 0x30c, 0);\r\nof_node_put(tsi_pic);\r\n}\r\nvoid mpc7448_hpc2_show_cpuinfo(struct seq_file *m)\r\n{\r\nseq_printf(m, "vendor\t\t: Freescale Semiconductor\n");\r\n}\r\nvoid mpc7448_hpc2_restart(char *cmd)\r\n{\r\nlocal_irq_disable();\r\n_nmask_and_or_msr(0, MSR_IP);\r\nfor (;;) ;\r\n}\r\nvoid mpc7448_hpc2_power_off(void)\r\n{\r\nlocal_irq_disable();\r\nfor (;;) ;\r\n}\r\nvoid mpc7448_hpc2_halt(void)\r\n{\r\nmpc7448_hpc2_power_off();\r\n}\r\nstatic int __init mpc7448_hpc2_probe(void)\r\n{\r\nunsigned long root = of_get_flat_dt_root();\r\nif (!of_flat_dt_is_compatible(root, "mpc74xx"))\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic int mpc7448_machine_check_exception(struct pt_regs *regs)\r\n{\r\nconst struct exception_table_entry *entry;\r\nif ((entry = search_exception_tables(regs->nip)) != NULL) {\r\ntsi108_clear_pci_cfg_error();\r\nregs->msr |= MSR_RI;\r\nregs->nip = entry->fixup;\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}

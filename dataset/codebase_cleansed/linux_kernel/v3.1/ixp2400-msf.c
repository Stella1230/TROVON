static void ixp2400_pll_init(struct ixp2400_msf_parameters *mp)\r\n{\r\nint rx_dual_clock;\r\nint tx_dual_clock;\r\nu32 value;\r\nrx_dual_clock = !!(mp->rx_mode & IXP2400_RX_MODE_WIDTH_MASK);\r\ntx_dual_clock = !!(mp->tx_mode & IXP2400_TX_MODE_WIDTH_MASK);\r\nvalue = ixp2000_reg_read(IXP2000_MSF_CLK_CNTRL);\r\nvalue |= 0x0000f0f0;\r\nixp2000_reg_write(IXP2000_MSF_CLK_CNTRL, value);\r\nvalue &= ~0x03000000;\r\nvalue |= (rx_dual_clock << 24) | (tx_dual_clock << 25);\r\nvalue &= ~0x00ff0000;\r\nvalue |= mp->rxclk01_multiplier << 16;\r\nvalue |= mp->rxclk23_multiplier << 18;\r\nvalue |= mp->txclk01_multiplier << 20;\r\nvalue |= mp->txclk23_multiplier << 22;\r\nixp2000_reg_write(IXP2000_MSF_CLK_CNTRL, value);\r\nvalue &= ~(0x00005000 | rx_dual_clock << 13 | tx_dual_clock << 15);\r\nixp2000_reg_write(IXP2000_MSF_CLK_CNTRL, value);\r\nvalue &= ~(0x00000050 | rx_dual_clock << 5 | tx_dual_clock << 7);\r\nixp2000_reg_write(IXP2000_MSF_CLK_CNTRL, value);\r\nudelay(100);\r\n}\r\nstatic void ixp2400_msf_free_rbuf_entries(struct ixp2400_msf_parameters *mp)\r\n{\r\nint size_bits;\r\nint i;\r\nsize_bits = mp->rx_mode & IXP2400_RX_MODE_RBUF_SIZE_MASK;\r\nif (size_bits == IXP2400_RX_MODE_RBUF_SIZE_64) {\r\nfor (i = 1; i < 128; i++) {\r\nif (i == 9 || i == 18 || i == 27)\r\ncontinue;\r\nixp2000_reg_write(IXP2000_MSF_RBUF_ELEMENT_DONE, i);\r\n}\r\n} else if (size_bits == IXP2400_RX_MODE_RBUF_SIZE_128) {\r\nfor (i = 1; i < 64; i++) {\r\nif (i == 4 || i == 9 || i == 13)\r\ncontinue;\r\nixp2000_reg_write(IXP2000_MSF_RBUF_ELEMENT_DONE, i);\r\n}\r\n} else if (size_bits == IXP2400_RX_MODE_RBUF_SIZE_256) {\r\nfor (i = 1; i < 32; i++) {\r\nif (i == 2 || i == 4 || i == 6)\r\ncontinue;\r\nixp2000_reg_write(IXP2000_MSF_RBUF_ELEMENT_DONE, i);\r\n}\r\n}\r\n}\r\nstatic u32 ixp2400_msf_valid_channels(u32 reg)\r\n{\r\nu32 channels;\r\nchannels = 0;\r\nswitch (reg & IXP2400_RX_MODE_WIDTH_MASK) {\r\ncase IXP2400_RX_MODE_1x32:\r\nchannels = 0x1;\r\nif (reg & IXP2400_RX_MODE_MPHY &&\r\n!(reg & IXP2400_RX_MODE_MPHY_32))\r\nchannels = 0xf;\r\nbreak;\r\ncase IXP2400_RX_MODE_2x16:\r\nchannels = 0x5;\r\nbreak;\r\ncase IXP2400_RX_MODE_4x8:\r\nchannels = 0xf;\r\nbreak;\r\ncase IXP2400_RX_MODE_1x16_2x8:\r\nchannels = 0xd;\r\nbreak;\r\n}\r\nreturn channels;\r\n}\r\nstatic void ixp2400_msf_enable_rx(struct ixp2400_msf_parameters *mp)\r\n{\r\nu32 value;\r\nvalue = ixp2000_reg_read(IXP2000_MSF_RX_CONTROL) & 0x0fffffff;\r\nvalue |= ixp2400_msf_valid_channels(mp->rx_mode) << 28;\r\nixp2000_reg_write(IXP2000_MSF_RX_CONTROL, value);\r\n}\r\nstatic void ixp2400_msf_enable_tx(struct ixp2400_msf_parameters *mp)\r\n{\r\nu32 value;\r\nvalue = ixp2000_reg_read(IXP2000_MSF_TX_CONTROL) & 0x0fffffff;\r\nvalue |= ixp2400_msf_valid_channels(mp->tx_mode) << 28;\r\nixp2000_reg_write(IXP2000_MSF_TX_CONTROL, value);\r\n}\r\nvoid ixp2400_msf_init(struct ixp2400_msf_parameters *mp)\r\n{\r\nu32 value;\r\nint i;\r\nixp2400_pll_init(mp);\r\nvalue = ixp2000_reg_read(IXP2000_RESET0);\r\nixp2000_reg_write(IXP2000_RESET0, value | 0x80);\r\nixp2000_reg_write(IXP2000_RESET0, value & ~0x80);\r\nixp2000_reg_write(IXP2000_MSF_RX_MPHY_POLL_LIMIT, mp->rx_poll_ports - 1);\r\nixp2000_reg_write(IXP2000_MSF_RX_CONTROL, mp->rx_mode);\r\nfor (i = 0; i < 4; i++) {\r\nixp2000_reg_write(IXP2000_MSF_RX_UP_CONTROL_0 + i,\r\nmp->rx_channel_mode[i]);\r\n}\r\nixp2400_msf_free_rbuf_entries(mp);\r\nixp2400_msf_enable_rx(mp);\r\nixp2000_reg_write(IXP2000_MSF_TX_MPHY_POLL_LIMIT, mp->tx_poll_ports - 1);\r\nixp2000_reg_write(IXP2000_MSF_TX_CONTROL, mp->tx_mode);\r\nfor (i = 0; i < 4; i++) {\r\nixp2000_reg_write(IXP2000_MSF_TX_UP_CONTROL_0 + i,\r\nmp->tx_channel_mode[i]);\r\n}\r\nixp2400_msf_enable_tx(mp);\r\n}

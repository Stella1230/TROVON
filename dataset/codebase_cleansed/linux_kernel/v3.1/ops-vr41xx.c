static inline int set_pci_configuration_address(unsigned char number,\r\nunsigned int devfn, int where)\r\n{\r\nif (number == 0) {\r\nif (PCI_SLOT(devfn) < 11 || where > 0xff)\r\nreturn -EINVAL;\r\nwritel((1U << PCI_SLOT(devfn)) | (PCI_FUNC(devfn) << 8) |\r\n(where & 0xfc), PCICONFAREG);\r\n} else {\r\nif (where > 0xff)\r\nreturn -EINVAL;\r\nwritel(((uint32_t)number << 16) | ((devfn & 0xff) << 8) |\r\n(where & 0xfc) | 1U, PCICONFAREG);\r\n}\r\nreturn 0;\r\n}\r\nstatic int pci_config_read(struct pci_bus *bus, unsigned int devfn, int where,\r\nint size, uint32_t *val)\r\n{\r\nuint32_t data;\r\n*val = 0xffffffffU;\r\nif (set_pci_configuration_address(bus->number, devfn, where) < 0)\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\ndata = readl(PCICONFDREG);\r\nswitch (size) {\r\ncase 1:\r\n*val = (data >> ((where & 3) << 3)) & 0xffU;\r\nbreak;\r\ncase 2:\r\n*val = (data >> ((where & 2) << 3)) & 0xffffU;\r\nbreak;\r\ncase 4:\r\n*val = data;\r\nbreak;\r\ndefault:\r\nreturn PCIBIOS_FUNC_NOT_SUPPORTED;\r\n}\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int pci_config_write(struct pci_bus *bus, unsigned int devfn, int where,\r\nint size, uint32_t val)\r\n{\r\nuint32_t data;\r\nint shift;\r\nif (set_pci_configuration_address(bus->number, devfn, where) < 0)\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\ndata = readl(PCICONFDREG);\r\nswitch (size) {\r\ncase 1:\r\nshift = (where & 3) << 3;\r\ndata &= ~(0xffU << shift);\r\ndata |= ((val & 0xffU) << shift);\r\nbreak;\r\ncase 2:\r\nshift = (where & 2) << 3;\r\ndata &= ~(0xffffU << shift);\r\ndata |= ((val & 0xffffU) << shift);\r\nbreak;\r\ncase 4:\r\ndata = val;\r\nbreak;\r\ndefault:\r\nreturn PCIBIOS_FUNC_NOT_SUPPORTED;\r\n}\r\nwritel(data, PCICONFDREG);\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}

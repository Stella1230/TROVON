static inline int set_rtc_mmss(unsigned long nowtime)\r\n{\r\nif (mach_set_clock_mmss)\r\nreturn mach_set_clock_mmss (nowtime);\r\nreturn -1;\r\n}\r\nirqreturn_t arch_timer_interrupt(int irq, void *dummy)\r\n{\r\nif (current->pid)\r\nprofile_tick(CPU_PROFILING);\r\nxtime_update(1);\r\nupdate_process_times(user_mode(get_irq_regs()));\r\nreturn(IRQ_HANDLED);\r\n}\r\nstatic unsigned long read_rtc_mmss(void)\r\n{\r\nunsigned int year, mon, day, hour, min, sec;\r\nif (mach_gettod) {\r\nmach_gettod(&year, &mon, &day, &hour, &min, &sec);\r\nif ((year += 1900) < 1970)\r\nyear += 100;\r\n} else {\r\nyear = 1970;\r\nmon = day = 1;\r\nhour = min = sec = 0;\r\n}\r\nreturn mktime(year, mon, day, hour, min, sec);\r\n}\r\nvoid read_persistent_clock(struct timespec *ts)\r\n{\r\nts->tv_sec = read_rtc_mmss();\r\nts->tv_nsec = 0;\r\n}\r\nint update_persistent_clock(struct timespec now)\r\n{\r\nreturn set_rtc_mmss(now.tv_sec);\r\n}\r\nvoid time_init(void)\r\n{\r\nhw_timer_init();\r\n}

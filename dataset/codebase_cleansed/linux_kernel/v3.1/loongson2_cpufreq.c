static int loongson2_cpu_freq_notifier(struct notifier_block *nb,\r\nunsigned long val, void *data)\r\n{\r\nif (val == CPUFREQ_POSTCHANGE)\r\ncurrent_cpu_data.udelay_val = loops_per_jiffy;\r\nreturn 0;\r\n}\r\nstatic unsigned int loongson2_cpufreq_get(unsigned int cpu)\r\n{\r\nreturn clk_get_rate(cpuclk);\r\n}\r\nstatic int loongson2_cpufreq_target(struct cpufreq_policy *policy,\r\nunsigned int target_freq,\r\nunsigned int relation)\r\n{\r\nunsigned int cpu = policy->cpu;\r\nunsigned int newstate = 0;\r\ncpumask_t cpus_allowed;\r\nstruct cpufreq_freqs freqs;\r\nunsigned int freq;\r\nif (!cpu_online(cpu))\r\nreturn -ENODEV;\r\ncpus_allowed = current->cpus_allowed;\r\nset_cpus_allowed_ptr(current, cpumask_of(cpu));\r\nif (cpufreq_frequency_table_target\r\n(policy, &loongson2_clockmod_table[0], target_freq, relation,\r\n&newstate))\r\nreturn -EINVAL;\r\nfreq =\r\n((cpu_clock_freq / 1000) *\r\nloongson2_clockmod_table[newstate].index) / 8;\r\nif (freq < policy->min || freq > policy->max)\r\nreturn -EINVAL;\r\npr_debug("cpufreq: requested frequency %u Hz\n", target_freq * 1000);\r\nfreqs.cpu = cpu;\r\nfreqs.old = loongson2_cpufreq_get(cpu);\r\nfreqs.new = freq;\r\nfreqs.flags = 0;\r\nif (freqs.new == freqs.old)\r\nreturn 0;\r\ncpufreq_notify_transition(&freqs, CPUFREQ_PRECHANGE);\r\nset_cpus_allowed_ptr(current, &cpus_allowed);\r\nclk_set_rate(cpuclk, freq);\r\ncpufreq_notify_transition(&freqs, CPUFREQ_POSTCHANGE);\r\npr_debug("cpufreq: set frequency %u kHz\n", freq);\r\nreturn 0;\r\n}\r\nstatic int loongson2_cpufreq_cpu_init(struct cpufreq_policy *policy)\r\n{\r\nint i;\r\nif (!cpu_online(policy->cpu))\r\nreturn -ENODEV;\r\ncpuclk = clk_get(NULL, "cpu_clk");\r\nif (IS_ERR(cpuclk)) {\r\nprintk(KERN_ERR "cpufreq: couldn't get CPU clk\n");\r\nreturn PTR_ERR(cpuclk);\r\n}\r\ncpuclk->rate = cpu_clock_freq / 1000;\r\nif (!cpuclk->rate)\r\nreturn -EINVAL;\r\nfor (i = 2;\r\n(loongson2_clockmod_table[i].frequency != CPUFREQ_TABLE_END);\r\ni++)\r\nloongson2_clockmod_table[i].frequency = (cpuclk->rate * i) / 8;\r\npolicy->cur = loongson2_cpufreq_get(policy->cpu);\r\ncpufreq_frequency_table_get_attr(&loongson2_clockmod_table[0],\r\npolicy->cpu);\r\nreturn cpufreq_frequency_table_cpuinfo(policy,\r\n&loongson2_clockmod_table[0]);\r\n}\r\nstatic int loongson2_cpufreq_verify(struct cpufreq_policy *policy)\r\n{\r\nreturn cpufreq_frequency_table_verify(policy,\r\n&loongson2_clockmod_table[0]);\r\n}\r\nstatic int loongson2_cpufreq_exit(struct cpufreq_policy *policy)\r\n{\r\nclk_put(cpuclk);\r\nreturn 0;\r\n}\r\nstatic int __init cpufreq_init(void)\r\n{\r\nint ret;\r\nret = platform_driver_register(&platform_driver);\r\nif (ret)\r\nreturn ret;\r\npr_info("cpufreq: Loongson-2F CPU frequency driver.\n");\r\ncpufreq_register_notifier(&loongson2_cpufreq_notifier_block,\r\nCPUFREQ_TRANSITION_NOTIFIER);\r\nret = cpufreq_register_driver(&loongson2_cpufreq_driver);\r\nif (!ret && !nowait) {\r\nsaved_cpu_wait = cpu_wait;\r\ncpu_wait = loongson2_cpu_wait;\r\n}\r\nreturn ret;\r\n}\r\nstatic void __exit cpufreq_exit(void)\r\n{\r\nif (!nowait && saved_cpu_wait)\r\ncpu_wait = saved_cpu_wait;\r\ncpufreq_unregister_driver(&loongson2_cpufreq_driver);\r\ncpufreq_unregister_notifier(&loongson2_cpufreq_notifier_block,\r\nCPUFREQ_TRANSITION_NOTIFIER);\r\nplatform_driver_unregister(&platform_driver);\r\n}

static void alix_led_set(struct led_classdev *led_cdev,\r\nenum led_brightness brightness)\r\n{\r\nstruct alix_led *led_dev =\r\ncontainer_of(led_cdev, struct alix_led, cdev);\r\nif (brightness)\r\noutl(led_dev->on_value, gpio_base + led_dev->port);\r\nelse\r\noutl(led_dev->off_value, gpio_base + led_dev->port);\r\n}\r\nstatic int __init alix_led_probe(struct platform_device *pdev)\r\n{\r\nint i;\r\nint ret;\r\nfor (i = 0; i < ARRAY_SIZE(alix_leds); i++) {\r\nalix_leds[i].cdev.flags |= LED_CORE_SUSPENDRESUME;\r\nret = led_classdev_register(&pdev->dev, &alix_leds[i].cdev);\r\nif (ret < 0)\r\ngoto fail;\r\n}\r\nreturn 0;\r\nfail:\r\nwhile (--i >= 0)\r\nled_classdev_unregister(&alix_leds[i].cdev);\r\nreturn ret;\r\n}\r\nstatic int alix_led_remove(struct platform_device *pdev)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(alix_leds); i++)\r\nled_classdev_unregister(&alix_leds[i].cdev);\r\nreturn 0;\r\n}\r\nstatic int __init alix_present(unsigned long bios_phys,\r\nconst char *alix_sig,\r\nsize_t alix_sig_len)\r\n{\r\nconst size_t bios_len = 0x00010000;\r\nconst char *bios_virt;\r\nconst char *scan_end;\r\nconst char *p;\r\nchar name[64];\r\nif (force) {\r\nprintk(KERN_NOTICE "%s: forced to skip BIOS test, "\r\n"assume system has ALIX.2 style LEDs\n",\r\nKBUILD_MODNAME);\r\nreturn 1;\r\n}\r\nbios_virt = phys_to_virt(bios_phys);\r\nscan_end = bios_virt + bios_len - (alix_sig_len + 2);\r\nfor (p = bios_virt; p < scan_end; p++) {\r\nconst char *tail;\r\nchar *a;\r\nif (memcmp(p, alix_sig, alix_sig_len) != 0)\r\ncontinue;\r\nmemcpy(name, p, sizeof(name));\r\na = strchr(name, '\0');\r\nif (a)\r\n*a = ' ';\r\na = strchr(name, '\r');\r\nif (a)\r\n*a = '\0';\r\ntail = p + alix_sig_len;\r\nif ((tail[0] == '2' || tail[0] == '3')) {\r\nprintk(KERN_INFO\r\n"%s: system is recognized as \"%s\"\n",\r\nKBUILD_MODNAME, name);\r\nreturn 1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init alix_pci_led_init(void)\r\n{\r\nu32 low, hi;\r\nif (pci_dev_present(divil_pci) == 0) {\r\nprintk(KERN_WARNING KBUILD_MODNAME": DIVIL not found\n");\r\nreturn -ENODEV;\r\n}\r\nrdmsr(MSR_LBAR_GPIO, low, hi);\r\nif (hi != 0x0000f001) {\r\nprintk(KERN_WARNING KBUILD_MODNAME": GPIO not enabled\n");\r\nreturn -ENODEV;\r\n}\r\ngpio_base = low & 0x0000ff00;\r\nif (!request_region(gpio_base, CS5535_GPIO_SIZE, KBUILD_MODNAME)) {\r\nprintk(KERN_ERR KBUILD_MODNAME": can't allocate I/O for GPIO\n");\r\nreturn -ENODEV;\r\n}\r\noutl(1 << 6, gpio_base + 0x04);\r\noutl(1 << 9, gpio_base + 0x84);\r\noutl(1 << 11, gpio_base + 0x84);\r\nreturn 0;\r\n}\r\nstatic int __init alix_led_init(void)\r\n{\r\nint ret = -ENODEV;\r\nconst char tinybios_sig[] = "PC Engines ALIX.";\r\nconst char coreboot_sig[] = "PC Engines\0ALIX.";\r\nif (alix_present(0xf0000, tinybios_sig, sizeof(tinybios_sig) - 1) ||\r\nalix_present(0x500, coreboot_sig, sizeof(coreboot_sig) - 1))\r\nret = alix_pci_led_init();\r\nif (ret < 0)\r\nreturn ret;\r\npdev = platform_device_register_simple(KBUILD_MODNAME, -1, NULL, 0);\r\nif (!IS_ERR(pdev)) {\r\nret = platform_driver_probe(&alix_led_driver, alix_led_probe);\r\nif (ret)\r\nplatform_device_unregister(pdev);\r\n} else\r\nret = PTR_ERR(pdev);\r\nreturn ret;\r\n}\r\nstatic void __exit alix_led_exit(void)\r\n{\r\nplatform_device_unregister(pdev);\r\nplatform_driver_unregister(&alix_led_driver);\r\nrelease_region(gpio_base, CS5535_GPIO_SIZE);\r\n}

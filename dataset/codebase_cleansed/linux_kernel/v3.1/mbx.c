static s32 e1000_poll_for_msg(struct e1000_hw *hw)\r\n{\r\nstruct e1000_mbx_info *mbx = &hw->mbx;\r\nint countdown = mbx->timeout;\r\nif (!mbx->ops.check_for_msg)\r\ngoto out;\r\nwhile (countdown && mbx->ops.check_for_msg(hw)) {\r\ncountdown--;\r\nudelay(mbx->usec_delay);\r\n}\r\nif (!countdown)\r\nmbx->timeout = 0;\r\nout:\r\nreturn countdown ? E1000_SUCCESS : -E1000_ERR_MBX;\r\n}\r\nstatic s32 e1000_poll_for_ack(struct e1000_hw *hw)\r\n{\r\nstruct e1000_mbx_info *mbx = &hw->mbx;\r\nint countdown = mbx->timeout;\r\nif (!mbx->ops.check_for_ack)\r\ngoto out;\r\nwhile (countdown && mbx->ops.check_for_ack(hw)) {\r\ncountdown--;\r\nudelay(mbx->usec_delay);\r\n}\r\nif (!countdown)\r\nmbx->timeout = 0;\r\nout:\r\nreturn countdown ? E1000_SUCCESS : -E1000_ERR_MBX;\r\n}\r\nstatic s32 e1000_read_posted_mbx(struct e1000_hw *hw, u32 *msg, u16 size)\r\n{\r\nstruct e1000_mbx_info *mbx = &hw->mbx;\r\ns32 ret_val = -E1000_ERR_MBX;\r\nif (!mbx->ops.read)\r\ngoto out;\r\nret_val = e1000_poll_for_msg(hw);\r\nif (!ret_val)\r\nret_val = mbx->ops.read(hw, msg, size);\r\nout:\r\nreturn ret_val;\r\n}\r\nstatic s32 e1000_write_posted_mbx(struct e1000_hw *hw, u32 *msg, u16 size)\r\n{\r\nstruct e1000_mbx_info *mbx = &hw->mbx;\r\ns32 ret_val = -E1000_ERR_MBX;\r\nif (!mbx->ops.write || !mbx->timeout)\r\ngoto out;\r\nret_val = mbx->ops.write(hw, msg, size);\r\nif (!ret_val)\r\nret_val = e1000_poll_for_ack(hw);\r\nout:\r\nreturn ret_val;\r\n}\r\nstatic u32 e1000_read_v2p_mailbox(struct e1000_hw *hw)\r\n{\r\nu32 v2p_mailbox = er32(V2PMAILBOX(0));\r\nv2p_mailbox |= hw->dev_spec.vf.v2p_mailbox;\r\nhw->dev_spec.vf.v2p_mailbox |= v2p_mailbox & E1000_V2PMAILBOX_R2C_BITS;\r\nreturn v2p_mailbox;\r\n}\r\nstatic s32 e1000_check_for_bit_vf(struct e1000_hw *hw, u32 mask)\r\n{\r\nu32 v2p_mailbox = e1000_read_v2p_mailbox(hw);\r\ns32 ret_val = -E1000_ERR_MBX;\r\nif (v2p_mailbox & mask)\r\nret_val = E1000_SUCCESS;\r\nhw->dev_spec.vf.v2p_mailbox &= ~mask;\r\nreturn ret_val;\r\n}\r\nstatic s32 e1000_check_for_msg_vf(struct e1000_hw *hw)\r\n{\r\ns32 ret_val = -E1000_ERR_MBX;\r\nif (!e1000_check_for_bit_vf(hw, E1000_V2PMAILBOX_PFSTS)) {\r\nret_val = E1000_SUCCESS;\r\nhw->mbx.stats.reqs++;\r\n}\r\nreturn ret_val;\r\n}\r\nstatic s32 e1000_check_for_ack_vf(struct e1000_hw *hw)\r\n{\r\ns32 ret_val = -E1000_ERR_MBX;\r\nif (!e1000_check_for_bit_vf(hw, E1000_V2PMAILBOX_PFACK)) {\r\nret_val = E1000_SUCCESS;\r\nhw->mbx.stats.acks++;\r\n}\r\nreturn ret_val;\r\n}\r\nstatic s32 e1000_check_for_rst_vf(struct e1000_hw *hw)\r\n{\r\ns32 ret_val = -E1000_ERR_MBX;\r\nif (!e1000_check_for_bit_vf(hw, (E1000_V2PMAILBOX_RSTD |\r\nE1000_V2PMAILBOX_RSTI))) {\r\nret_val = E1000_SUCCESS;\r\nhw->mbx.stats.rsts++;\r\n}\r\nreturn ret_val;\r\n}\r\nstatic s32 e1000_obtain_mbx_lock_vf(struct e1000_hw *hw)\r\n{\r\ns32 ret_val = -E1000_ERR_MBX;\r\new32(V2PMAILBOX(0), E1000_V2PMAILBOX_VFU);\r\nif (e1000_read_v2p_mailbox(hw) & E1000_V2PMAILBOX_VFU)\r\nret_val = E1000_SUCCESS;\r\nreturn ret_val;\r\n}\r\nstatic s32 e1000_write_mbx_vf(struct e1000_hw *hw, u32 *msg, u16 size)\r\n{\r\ns32 err;\r\nu16 i;\r\nerr = e1000_obtain_mbx_lock_vf(hw);\r\nif (err)\r\ngoto out_no_write;\r\ne1000_check_for_ack_vf(hw);\r\ne1000_check_for_msg_vf(hw);\r\nfor (i = 0; i < size; i++)\r\narray_ew32(VMBMEM(0), i, msg[i]);\r\nhw->mbx.stats.msgs_tx++;\r\new32(V2PMAILBOX(0), E1000_V2PMAILBOX_REQ);\r\nout_no_write:\r\nreturn err;\r\n}\r\nstatic s32 e1000_read_mbx_vf(struct e1000_hw *hw, u32 *msg, u16 size)\r\n{\r\ns32 err;\r\nu16 i;\r\nerr = e1000_obtain_mbx_lock_vf(hw);\r\nif (err)\r\ngoto out_no_read;\r\nfor (i = 0; i < size; i++)\r\nmsg[i] = array_er32(VMBMEM(0), i);\r\new32(V2PMAILBOX(0), E1000_V2PMAILBOX_ACK);\r\nhw->mbx.stats.msgs_rx++;\r\nout_no_read:\r\nreturn err;\r\n}\r\ns32 e1000_init_mbx_params_vf(struct e1000_hw *hw)\r\n{\r\nstruct e1000_mbx_info *mbx = &hw->mbx;\r\nmbx->timeout = 0;\r\nmbx->usec_delay = E1000_VF_MBX_INIT_DELAY;\r\nmbx->size = E1000_VFMAILBOX_SIZE;\r\nmbx->ops.read = e1000_read_mbx_vf;\r\nmbx->ops.write = e1000_write_mbx_vf;\r\nmbx->ops.read_posted = e1000_read_posted_mbx;\r\nmbx->ops.write_posted = e1000_write_posted_mbx;\r\nmbx->ops.check_for_msg = e1000_check_for_msg_vf;\r\nmbx->ops.check_for_ack = e1000_check_for_ack_vf;\r\nmbx->ops.check_for_rst = e1000_check_for_rst_vf;\r\nmbx->stats.msgs_tx = 0;\r\nmbx->stats.msgs_rx = 0;\r\nmbx->stats.reqs = 0;\r\nmbx->stats.acks = 0;\r\nmbx->stats.rsts = 0;\r\nreturn E1000_SUCCESS;\r\n}

void mlx4_cq_completion(struct mlx4_dev *dev, u32 cqn)\r\n{\r\nstruct mlx4_cq *cq;\r\ncq = radix_tree_lookup(&mlx4_priv(dev)->cq_table.tree,\r\ncqn & (dev->caps.num_cqs - 1));\r\nif (!cq) {\r\nmlx4_warn(dev, "Completion event for bogus CQ %08x\n", cqn);\r\nreturn;\r\n}\r\n++cq->arm_sn;\r\ncq->comp(cq);\r\n}\r\nvoid mlx4_cq_event(struct mlx4_dev *dev, u32 cqn, int event_type)\r\n{\r\nstruct mlx4_cq_table *cq_table = &mlx4_priv(dev)->cq_table;\r\nstruct mlx4_cq *cq;\r\nspin_lock(&cq_table->lock);\r\ncq = radix_tree_lookup(&cq_table->tree, cqn & (dev->caps.num_cqs - 1));\r\nif (cq)\r\natomic_inc(&cq->refcount);\r\nspin_unlock(&cq_table->lock);\r\nif (!cq) {\r\nmlx4_warn(dev, "Async event for bogus CQ %08x\n", cqn);\r\nreturn;\r\n}\r\ncq->event(cq, event_type);\r\nif (atomic_dec_and_test(&cq->refcount))\r\ncomplete(&cq->free);\r\n}\r\nstatic int mlx4_SW2HW_CQ(struct mlx4_dev *dev, struct mlx4_cmd_mailbox *mailbox,\r\nint cq_num)\r\n{\r\nreturn mlx4_cmd(dev, mailbox->dma, cq_num, 0, MLX4_CMD_SW2HW_CQ,\r\nMLX4_CMD_TIME_CLASS_A);\r\n}\r\nstatic int mlx4_MODIFY_CQ(struct mlx4_dev *dev, struct mlx4_cmd_mailbox *mailbox,\r\nint cq_num, u32 opmod)\r\n{\r\nreturn mlx4_cmd(dev, mailbox->dma, cq_num, opmod, MLX4_CMD_MODIFY_CQ,\r\nMLX4_CMD_TIME_CLASS_A);\r\n}\r\nstatic int mlx4_HW2SW_CQ(struct mlx4_dev *dev, struct mlx4_cmd_mailbox *mailbox,\r\nint cq_num)\r\n{\r\nreturn mlx4_cmd_box(dev, 0, mailbox ? mailbox->dma : 0, cq_num,\r\nmailbox ? 0 : 1, MLX4_CMD_HW2SW_CQ,\r\nMLX4_CMD_TIME_CLASS_A);\r\n}\r\nint mlx4_cq_modify(struct mlx4_dev *dev, struct mlx4_cq *cq,\r\nu16 count, u16 period)\r\n{\r\nstruct mlx4_cmd_mailbox *mailbox;\r\nstruct mlx4_cq_context *cq_context;\r\nint err;\r\nmailbox = mlx4_alloc_cmd_mailbox(dev);\r\nif (IS_ERR(mailbox))\r\nreturn PTR_ERR(mailbox);\r\ncq_context = mailbox->buf;\r\nmemset(cq_context, 0, sizeof *cq_context);\r\ncq_context->cq_max_count = cpu_to_be16(count);\r\ncq_context->cq_period = cpu_to_be16(period);\r\nerr = mlx4_MODIFY_CQ(dev, mailbox, cq->cqn, 1);\r\nmlx4_free_cmd_mailbox(dev, mailbox);\r\nreturn err;\r\n}\r\nint mlx4_cq_resize(struct mlx4_dev *dev, struct mlx4_cq *cq,\r\nint entries, struct mlx4_mtt *mtt)\r\n{\r\nstruct mlx4_cmd_mailbox *mailbox;\r\nstruct mlx4_cq_context *cq_context;\r\nu64 mtt_addr;\r\nint err;\r\nmailbox = mlx4_alloc_cmd_mailbox(dev);\r\nif (IS_ERR(mailbox))\r\nreturn PTR_ERR(mailbox);\r\ncq_context = mailbox->buf;\r\nmemset(cq_context, 0, sizeof *cq_context);\r\ncq_context->logsize_usrpage = cpu_to_be32(ilog2(entries) << 24);\r\ncq_context->log_page_size = mtt->page_shift - 12;\r\nmtt_addr = mlx4_mtt_addr(dev, mtt);\r\ncq_context->mtt_base_addr_h = mtt_addr >> 32;\r\ncq_context->mtt_base_addr_l = cpu_to_be32(mtt_addr & 0xffffffff);\r\nerr = mlx4_MODIFY_CQ(dev, mailbox, cq->cqn, 0);\r\nmlx4_free_cmd_mailbox(dev, mailbox);\r\nreturn err;\r\n}\r\nint mlx4_cq_alloc(struct mlx4_dev *dev, int nent, struct mlx4_mtt *mtt,\r\nstruct mlx4_uar *uar, u64 db_rec, struct mlx4_cq *cq,\r\nunsigned vector, int collapsed)\r\n{\r\nstruct mlx4_priv *priv = mlx4_priv(dev);\r\nstruct mlx4_cq_table *cq_table = &priv->cq_table;\r\nstruct mlx4_cmd_mailbox *mailbox;\r\nstruct mlx4_cq_context *cq_context;\r\nu64 mtt_addr;\r\nint err;\r\nif (vector > dev->caps.num_comp_vectors + dev->caps.comp_pool)\r\nreturn -EINVAL;\r\ncq->vector = vector;\r\ncq->cqn = mlx4_bitmap_alloc(&cq_table->bitmap);\r\nif (cq->cqn == -1)\r\nreturn -ENOMEM;\r\nerr = mlx4_table_get(dev, &cq_table->table, cq->cqn);\r\nif (err)\r\ngoto err_out;\r\nerr = mlx4_table_get(dev, &cq_table->cmpt_table, cq->cqn);\r\nif (err)\r\ngoto err_put;\r\nspin_lock_irq(&cq_table->lock);\r\nerr = radix_tree_insert(&cq_table->tree, cq->cqn, cq);\r\nspin_unlock_irq(&cq_table->lock);\r\nif (err)\r\ngoto err_cmpt_put;\r\nmailbox = mlx4_alloc_cmd_mailbox(dev);\r\nif (IS_ERR(mailbox)) {\r\nerr = PTR_ERR(mailbox);\r\ngoto err_radix;\r\n}\r\ncq_context = mailbox->buf;\r\nmemset(cq_context, 0, sizeof *cq_context);\r\ncq_context->flags = cpu_to_be32(!!collapsed << 18);\r\ncq_context->logsize_usrpage = cpu_to_be32((ilog2(nent) << 24) | uar->index);\r\ncq_context->comp_eqn = priv->eq_table.eq[vector].eqn;\r\ncq_context->log_page_size = mtt->page_shift - MLX4_ICM_PAGE_SHIFT;\r\nmtt_addr = mlx4_mtt_addr(dev, mtt);\r\ncq_context->mtt_base_addr_h = mtt_addr >> 32;\r\ncq_context->mtt_base_addr_l = cpu_to_be32(mtt_addr & 0xffffffff);\r\ncq_context->db_rec_addr = cpu_to_be64(db_rec);\r\nerr = mlx4_SW2HW_CQ(dev, mailbox, cq->cqn);\r\nmlx4_free_cmd_mailbox(dev, mailbox);\r\nif (err)\r\ngoto err_radix;\r\ncq->cons_index = 0;\r\ncq->arm_sn = 1;\r\ncq->uar = uar;\r\natomic_set(&cq->refcount, 1);\r\ninit_completion(&cq->free);\r\nreturn 0;\r\nerr_radix:\r\nspin_lock_irq(&cq_table->lock);\r\nradix_tree_delete(&cq_table->tree, cq->cqn);\r\nspin_unlock_irq(&cq_table->lock);\r\nerr_cmpt_put:\r\nmlx4_table_put(dev, &cq_table->cmpt_table, cq->cqn);\r\nerr_put:\r\nmlx4_table_put(dev, &cq_table->table, cq->cqn);\r\nerr_out:\r\nmlx4_bitmap_free(&cq_table->bitmap, cq->cqn);\r\nreturn err;\r\n}\r\nvoid mlx4_cq_free(struct mlx4_dev *dev, struct mlx4_cq *cq)\r\n{\r\nstruct mlx4_priv *priv = mlx4_priv(dev);\r\nstruct mlx4_cq_table *cq_table = &priv->cq_table;\r\nint err;\r\nerr = mlx4_HW2SW_CQ(dev, NULL, cq->cqn);\r\nif (err)\r\nmlx4_warn(dev, "HW2SW_CQ failed (%d) for CQN %06x\n", err, cq->cqn);\r\nsynchronize_irq(priv->eq_table.eq[cq->vector].irq);\r\nspin_lock_irq(&cq_table->lock);\r\nradix_tree_delete(&cq_table->tree, cq->cqn);\r\nspin_unlock_irq(&cq_table->lock);\r\nif (atomic_dec_and_test(&cq->refcount))\r\ncomplete(&cq->free);\r\nwait_for_completion(&cq->free);\r\nmlx4_table_put(dev, &cq_table->table, cq->cqn);\r\nmlx4_bitmap_free(&cq_table->bitmap, cq->cqn);\r\n}\r\nint mlx4_init_cq_table(struct mlx4_dev *dev)\r\n{\r\nstruct mlx4_cq_table *cq_table = &mlx4_priv(dev)->cq_table;\r\nint err;\r\nspin_lock_init(&cq_table->lock);\r\nINIT_RADIX_TREE(&cq_table->tree, GFP_ATOMIC);\r\nerr = mlx4_bitmap_init(&cq_table->bitmap, dev->caps.num_cqs,\r\ndev->caps.num_cqs - 1, dev->caps.reserved_cqs, 0);\r\nif (err)\r\nreturn err;\r\nreturn 0;\r\n}\r\nvoid mlx4_cleanup_cq_table(struct mlx4_dev *dev)\r\n{\r\nmlx4_bitmap_cleanup(&mlx4_priv(dev)->cq_table.bitmap);\r\n}

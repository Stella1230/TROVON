static ssize_t dma_show_devices(struct sys_device *dev,\r\nstruct sysdev_attribute *attr, char *buf)\r\n{\r\nssize_t len = 0;\r\nint i;\r\nfor (i = 0; i < MAX_DMA_CHANNELS; i++) {\r\nstruct dma_info *info = get_dma_info(i);\r\nstruct dma_channel *channel = get_dma_channel(i);\r\nif (unlikely(!info) || !channel)\r\ncontinue;\r\nlen += sprintf(buf + len, "%2d: %14s %s\n",\r\nchannel->chan, info->name,\r\nchannel->dev_id);\r\n}\r\nreturn len;\r\n}\r\nstatic int __init dma_sysclass_init(void)\r\n{\r\nint ret;\r\nret = sysdev_class_register(&dma_sysclass);\r\nif (unlikely(ret))\r\nreturn ret;\r\nreturn sysfs_create_file(&dma_sysclass.kset.kobj, &attr_devices.attr);\r\n}\r\nstatic ssize_t dma_show_dev_id(struct sys_device *dev,\r\nstruct sysdev_attribute *attr, char *buf)\r\n{\r\nstruct dma_channel *channel = to_dma_channel(dev);\r\nreturn sprintf(buf, "%s\n", channel->dev_id);\r\n}\r\nstatic ssize_t dma_store_dev_id(struct sys_device *dev,\r\nstruct sysdev_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct dma_channel *channel = to_dma_channel(dev);\r\nstrcpy(channel->dev_id, buf);\r\nreturn count;\r\n}\r\nstatic ssize_t dma_store_config(struct sys_device *dev,\r\nstruct sysdev_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct dma_channel *channel = to_dma_channel(dev);\r\nunsigned long config;\r\nconfig = simple_strtoul(buf, NULL, 0);\r\ndma_configure_channel(channel->vchan, config);\r\nreturn count;\r\n}\r\nstatic ssize_t dma_show_mode(struct sys_device *dev,\r\nstruct sysdev_attribute *attr, char *buf)\r\n{\r\nstruct dma_channel *channel = to_dma_channel(dev);\r\nreturn sprintf(buf, "0x%08x\n", channel->mode);\r\n}\r\nstatic ssize_t dma_store_mode(struct sys_device *dev,\r\nstruct sysdev_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct dma_channel *channel = to_dma_channel(dev);\r\nchannel->mode = simple_strtoul(buf, NULL, 0);\r\nreturn count;\r\n}\r\nint dma_create_sysfs_files(struct dma_channel *chan, struct dma_info *info)\r\n{\r\nstruct sys_device *dev = &chan->dev;\r\nchar name[16];\r\nint ret;\r\ndev->id = chan->vchan;\r\ndev->cls = &dma_sysclass;\r\nret = sysdev_register(dev);\r\nif (ret)\r\nreturn ret;\r\nret |= sysdev_create_file(dev, &attr_dev_id);\r\nret |= sysdev_create_file(dev, &attr_count);\r\nret |= sysdev_create_file(dev, &attr_mode);\r\nret |= sysdev_create_file(dev, &attr_flags);\r\nret |= sysdev_create_file(dev, &attr_config);\r\nif (unlikely(ret)) {\r\ndev_err(&info->pdev->dev, "Failed creating attrs\n");\r\nreturn ret;\r\n}\r\nsnprintf(name, sizeof(name), "dma%d", chan->chan);\r\nreturn sysfs_create_link(&info->pdev->dev.kobj, &dev->kobj, name);\r\n}\r\nvoid dma_remove_sysfs_files(struct dma_channel *chan, struct dma_info *info)\r\n{\r\nstruct sys_device *dev = &chan->dev;\r\nchar name[16];\r\nsysdev_remove_file(dev, &attr_dev_id);\r\nsysdev_remove_file(dev, &attr_count);\r\nsysdev_remove_file(dev, &attr_mode);\r\nsysdev_remove_file(dev, &attr_flags);\r\nsysdev_remove_file(dev, &attr_config);\r\nsnprintf(name, sizeof(name), "dma%d", chan->chan);\r\nsysfs_remove_link(&info->pdev->dev.kobj, name);\r\nsysdev_unregister(dev);\r\n}

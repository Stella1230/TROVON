static inline unsigned int get_irq_flags(struct resource *res)\r\n{\r\nunsigned int flags = IRQF_SAMPLE_RANDOM | IRQF_SHARED;\r\nflags |= res->flags & IRQF_TRIGGER_MASK;\r\nreturn flags;\r\n}\r\nstatic int pda_power_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nif (psy->type == POWER_SUPPLY_TYPE_MAINS)\r\nval->intval = pdata->is_ac_online ?\r\npdata->is_ac_online() : 0;\r\nelse\r\nval->intval = pdata->is_usb_online ?\r\npdata->is_usb_online() : 0;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic void update_status(void)\r\n{\r\nif (pdata->is_ac_online)\r\nnew_ac_status = !!pdata->is_ac_online();\r\nif (pdata->is_usb_online)\r\nnew_usb_status = !!pdata->is_usb_online();\r\n}\r\nstatic void update_charger(void)\r\n{\r\nstatic int regulator_enabled;\r\nint max_uA = pdata->ac_max_uA;\r\nif (pdata->set_charge) {\r\nif (new_ac_status > 0) {\r\ndev_dbg(dev, "charger on (AC)\n");\r\npdata->set_charge(PDA_POWER_CHARGE_AC);\r\n} else if (new_usb_status > 0) {\r\ndev_dbg(dev, "charger on (USB)\n");\r\npdata->set_charge(PDA_POWER_CHARGE_USB);\r\n} else {\r\ndev_dbg(dev, "charger off\n");\r\npdata->set_charge(0);\r\n}\r\n} else if (ac_draw) {\r\nif (new_ac_status > 0) {\r\nregulator_set_current_limit(ac_draw, max_uA, max_uA);\r\nif (!regulator_enabled) {\r\ndev_dbg(dev, "charger on (AC)\n");\r\nregulator_enable(ac_draw);\r\nregulator_enabled = 1;\r\n}\r\n} else {\r\nif (regulator_enabled) {\r\ndev_dbg(dev, "charger off\n");\r\nregulator_disable(ac_draw);\r\nregulator_enabled = 0;\r\n}\r\n}\r\n}\r\n}\r\nstatic void supply_timer_func(unsigned long unused)\r\n{\r\nif (ac_status == PDA_PSY_TO_CHANGE) {\r\nac_status = new_ac_status;\r\npower_supply_changed(&pda_psy_ac);\r\n}\r\nif (usb_status == PDA_PSY_TO_CHANGE) {\r\nusb_status = new_usb_status;\r\npower_supply_changed(&pda_psy_usb);\r\n}\r\n}\r\nstatic void psy_changed(void)\r\n{\r\nupdate_charger();\r\nmod_timer(&supply_timer,\r\njiffies + msecs_to_jiffies(pdata->wait_for_charger));\r\n}\r\nstatic void charger_timer_func(unsigned long unused)\r\n{\r\nupdate_status();\r\npsy_changed();\r\n}\r\nstatic irqreturn_t power_changed_isr(int irq, void *power_supply)\r\n{\r\nif (power_supply == &pda_psy_ac)\r\nac_status = PDA_PSY_TO_CHANGE;\r\nelse if (power_supply == &pda_psy_usb)\r\nusb_status = PDA_PSY_TO_CHANGE;\r\nelse\r\nreturn IRQ_NONE;\r\nmod_timer(&charger_timer,\r\njiffies + msecs_to_jiffies(pdata->wait_for_status));\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void polling_timer_func(unsigned long unused)\r\n{\r\nint changed = 0;\r\ndev_dbg(dev, "polling...\n");\r\nupdate_status();\r\nif (!ac_irq && new_ac_status != ac_status) {\r\nac_status = PDA_PSY_TO_CHANGE;\r\nchanged = 1;\r\n}\r\nif (!usb_irq && new_usb_status != usb_status) {\r\nusb_status = PDA_PSY_TO_CHANGE;\r\nchanged = 1;\r\n}\r\nif (changed)\r\npsy_changed();\r\nmod_timer(&polling_timer,\r\njiffies + msecs_to_jiffies(pdata->polling_interval));\r\n}\r\nstatic int otg_is_usb_online(void)\r\n{\r\nreturn (transceiver->state == OTG_STATE_B_PERIPHERAL);\r\n}\r\nstatic int pda_power_probe(struct platform_device *pdev)\r\n{\r\nint ret = 0;\r\ndev = &pdev->dev;\r\nif (pdev->id != -1) {\r\ndev_err(dev, "it's meaningless to register several "\r\n"pda_powers; use id = -1\n");\r\nret = -EINVAL;\r\ngoto wrongid;\r\n}\r\npdata = pdev->dev.platform_data;\r\nif (pdata->init) {\r\nret = pdata->init(dev);\r\nif (ret < 0)\r\ngoto init_failed;\r\n}\r\nupdate_status();\r\nupdate_charger();\r\nif (!pdata->wait_for_status)\r\npdata->wait_for_status = 500;\r\nif (!pdata->wait_for_charger)\r\npdata->wait_for_charger = 500;\r\nif (!pdata->polling_interval)\r\npdata->polling_interval = 2000;\r\nif (!pdata->ac_max_uA)\r\npdata->ac_max_uA = 500000;\r\nsetup_timer(&charger_timer, charger_timer_func, 0);\r\nsetup_timer(&supply_timer, supply_timer_func, 0);\r\nac_irq = platform_get_resource_byname(pdev, IORESOURCE_IRQ, "ac");\r\nusb_irq = platform_get_resource_byname(pdev, IORESOURCE_IRQ, "usb");\r\nif (pdata->supplied_to) {\r\npda_psy_ac.supplied_to = pdata->supplied_to;\r\npda_psy_ac.num_supplicants = pdata->num_supplicants;\r\npda_psy_usb.supplied_to = pdata->supplied_to;\r\npda_psy_usb.num_supplicants = pdata->num_supplicants;\r\n}\r\nac_draw = regulator_get(dev, "ac_draw");\r\nif (IS_ERR(ac_draw)) {\r\ndev_dbg(dev, "couldn't get ac_draw regulator\n");\r\nac_draw = NULL;\r\nret = PTR_ERR(ac_draw);\r\n}\r\nif (pdata->is_ac_online) {\r\nret = power_supply_register(&pdev->dev, &pda_psy_ac);\r\nif (ret) {\r\ndev_err(dev, "failed to register %s power supply\n",\r\npda_psy_ac.name);\r\ngoto ac_supply_failed;\r\n}\r\nif (ac_irq) {\r\nret = request_irq(ac_irq->start, power_changed_isr,\r\nget_irq_flags(ac_irq), ac_irq->name,\r\n&pda_psy_ac);\r\nif (ret) {\r\ndev_err(dev, "request ac irq failed\n");\r\ngoto ac_irq_failed;\r\n}\r\n} else {\r\npolling = 1;\r\n}\r\n}\r\n#ifdef CONFIG_USB_OTG_UTILS\r\ntransceiver = otg_get_transceiver();\r\nif (transceiver && !pdata->is_usb_online) {\r\npdata->is_usb_online = otg_is_usb_online;\r\n}\r\n#endif\r\nif (pdata->is_usb_online) {\r\nret = power_supply_register(&pdev->dev, &pda_psy_usb);\r\nif (ret) {\r\ndev_err(dev, "failed to register %s power supply\n",\r\npda_psy_usb.name);\r\ngoto usb_supply_failed;\r\n}\r\nif (usb_irq) {\r\nret = request_irq(usb_irq->start, power_changed_isr,\r\nget_irq_flags(usb_irq),\r\nusb_irq->name, &pda_psy_usb);\r\nif (ret) {\r\ndev_err(dev, "request usb irq failed\n");\r\ngoto usb_irq_failed;\r\n}\r\n} else {\r\npolling = 1;\r\n}\r\n}\r\nif (polling) {\r\ndev_dbg(dev, "will poll for status\n");\r\nsetup_timer(&polling_timer, polling_timer_func, 0);\r\nmod_timer(&polling_timer,\r\njiffies + msecs_to_jiffies(pdata->polling_interval));\r\n}\r\nif (ac_irq || usb_irq)\r\ndevice_init_wakeup(&pdev->dev, 1);\r\nreturn 0;\r\nusb_irq_failed:\r\nif (pdata->is_usb_online)\r\npower_supply_unregister(&pda_psy_usb);\r\nusb_supply_failed:\r\nif (pdata->is_ac_online && ac_irq)\r\nfree_irq(ac_irq->start, &pda_psy_ac);\r\n#ifdef CONFIG_USB_OTG_UTILS\r\nif (transceiver)\r\notg_put_transceiver(transceiver);\r\n#endif\r\nac_irq_failed:\r\nif (pdata->is_ac_online)\r\npower_supply_unregister(&pda_psy_ac);\r\nac_supply_failed:\r\nif (ac_draw) {\r\nregulator_put(ac_draw);\r\nac_draw = NULL;\r\n}\r\nif (pdata->exit)\r\npdata->exit(dev);\r\ninit_failed:\r\nwrongid:\r\nreturn ret;\r\n}\r\nstatic int pda_power_remove(struct platform_device *pdev)\r\n{\r\nif (pdata->is_usb_online && usb_irq)\r\nfree_irq(usb_irq->start, &pda_psy_usb);\r\nif (pdata->is_ac_online && ac_irq)\r\nfree_irq(ac_irq->start, &pda_psy_ac);\r\nif (polling)\r\ndel_timer_sync(&polling_timer);\r\ndel_timer_sync(&charger_timer);\r\ndel_timer_sync(&supply_timer);\r\nif (pdata->is_usb_online)\r\npower_supply_unregister(&pda_psy_usb);\r\nif (pdata->is_ac_online)\r\npower_supply_unregister(&pda_psy_ac);\r\n#ifdef CONFIG_USB_OTG_UTILS\r\nif (transceiver)\r\notg_put_transceiver(transceiver);\r\n#endif\r\nif (ac_draw) {\r\nregulator_put(ac_draw);\r\nac_draw = NULL;\r\n}\r\nif (pdata->exit)\r\npdata->exit(dev);\r\nreturn 0;\r\n}\r\nstatic int pda_power_suspend(struct platform_device *pdev, pm_message_t state)\r\n{\r\nif (pdata->suspend) {\r\nint ret = pdata->suspend(state);\r\nif (ret)\r\nreturn ret;\r\n}\r\nif (device_may_wakeup(&pdev->dev)) {\r\nif (ac_irq)\r\nac_wakeup_enabled = !enable_irq_wake(ac_irq->start);\r\nif (usb_irq)\r\nusb_wakeup_enabled = !enable_irq_wake(usb_irq->start);\r\n}\r\nreturn 0;\r\n}\r\nstatic int pda_power_resume(struct platform_device *pdev)\r\n{\r\nif (device_may_wakeup(&pdev->dev)) {\r\nif (usb_irq && usb_wakeup_enabled)\r\ndisable_irq_wake(usb_irq->start);\r\nif (ac_irq && ac_wakeup_enabled)\r\ndisable_irq_wake(ac_irq->start);\r\n}\r\nif (pdata->resume)\r\nreturn pdata->resume();\r\nreturn 0;\r\n}\r\nstatic int __init pda_power_init(void)\r\n{\r\nreturn platform_driver_register(&pda_power_pdrv);\r\n}\r\nstatic void __exit pda_power_exit(void)\r\n{\r\nplatform_driver_unregister(&pda_power_pdrv);\r\n}

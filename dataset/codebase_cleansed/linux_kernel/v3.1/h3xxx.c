void h3xxx_init_gpio(struct gpio_default_state *s, size_t n)\r\n{\r\nwhile (n--) {\r\nconst char *name = s->name;\r\nint err;\r\nif (!name)\r\nname = "[init]";\r\nerr = gpio_request(s->gpio, name);\r\nif (err) {\r\nprintk(KERN_ERR "gpio%u: unable to request: %d\n",\r\ns->gpio, err);\r\ncontinue;\r\n}\r\nif (s->mode >= 0) {\r\nerr = gpio_direction_output(s->gpio, s->mode);\r\n} else {\r\nerr = gpio_direction_input(s->gpio);\r\n}\r\nif (err) {\r\nprintk(KERN_ERR "gpio%u: unable to set direction: %d\n",\r\ns->gpio, err);\r\ncontinue;\r\n}\r\nif (!s->name)\r\ngpio_free(s->gpio);\r\ns++;\r\n}\r\n}\r\nstatic void h3xxx_set_vpp(int vpp)\r\n{\r\ngpio_set_value(H3XXX_EGPIO_VPP_ON, vpp);\r\n}\r\nstatic int h3xxx_flash_init(void)\r\n{\r\nint err = gpio_request(H3XXX_EGPIO_VPP_ON, "Flash Vpp");\r\nif (err) {\r\npr_err("%s: can't request H3XXX_EGPIO_VPP_ON\n", __func__);\r\nreturn err;\r\n}\r\nerr = gpio_direction_output(H3XXX_EGPIO_VPP_ON, 0);\r\nif (err)\r\ngpio_free(H3XXX_EGPIO_VPP_ON);\r\nreturn err;\r\n}\r\nstatic void h3xxx_flash_exit(void)\r\n{\r\ngpio_free(H3XXX_EGPIO_VPP_ON);\r\n}\r\nstatic void h3xxx_uart_set_mctrl(struct uart_port *port, u_int mctrl)\r\n{\r\nif (port->mapbase == _Ser3UTCR0) {\r\ngpio_set_value(H3XXX_GPIO_COM_RTS, !(mctrl & TIOCM_RTS));\r\n}\r\n}\r\nstatic u_int h3xxx_uart_get_mctrl(struct uart_port *port)\r\n{\r\nu_int ret = TIOCM_CD | TIOCM_CTS | TIOCM_DSR;\r\nif (port->mapbase == _Ser3UTCR0) {\r\nif (gpio_get_value(H3XXX_GPIO_COM_DCD))\r\nret &= ~TIOCM_CD;\r\nif (gpio_get_value(H3XXX_GPIO_COM_CTS))\r\nret &= ~TIOCM_CTS;\r\n}\r\nreturn ret;\r\n}\r\nstatic void h3xxx_uart_pm(struct uart_port *port, u_int state, u_int oldstate)\r\n{\r\nif (port->mapbase == _Ser3UTCR0) {\r\nif (!gpio_request(H3XXX_EGPIO_RS232_ON, "RS232 transceiver")) {\r\ngpio_direction_output(H3XXX_EGPIO_RS232_ON, !state);\r\ngpio_free(H3XXX_EGPIO_RS232_ON);\r\n} else {\r\npr_err("%s: can't request H3XXX_EGPIO_RS232_ON\n",\r\n__func__);\r\n}\r\n}\r\n}\r\nstatic int h3xxx_uart_set_wake(struct uart_port *port, u_int enable)\r\n{\r\nint err = -EINVAL;\r\nif (port->mapbase == _Ser3UTCR0) {\r\nif (enable)\r\nPWER |= PWER_GPIO23 | PWER_GPIO25;\r\nelse\r\nPWER &= ~(PWER_GPIO23 | PWER_GPIO25);\r\nerr = 0;\r\n}\r\nreturn err;\r\n}\r\nvoid __init h3xxx_mach_init(void)\r\n{\r\nsa1100_register_uart_fns(&h3xxx_port_fns);\r\nsa11x0_register_mtd(&h3xxx_flash_data, &h3xxx_flash_resource, 1);\r\nplatform_add_devices(h3xxx_devices, ARRAY_SIZE(h3xxx_devices));\r\n}\r\nvoid __init h3xxx_map_io(void)\r\n{\r\nsa1100_map_io();\r\niotable_init(h3600_io_desc, ARRAY_SIZE(h3600_io_desc));\r\nsa1100_register_uart(0, 3);\r\nPPDR |= PPC_TXD4 | PPC_SCLK | PPC_SFRM;\r\nPPSR &= ~(PPC_TXD4 | PPC_SCLK | PPC_SFRM);\r\nPGSR = 0;\r\nPCFR = PCFR_OPDE;\r\nPSDR = 0;\r\nGPCR = 0x0fffffff;\r\nGPDR = 0;\r\n}

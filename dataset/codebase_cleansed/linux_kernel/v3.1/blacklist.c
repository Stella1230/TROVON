static int blacklist_range(range_action action, unsigned int from_ssid,\r\nunsigned int to_ssid, unsigned int from,\r\nunsigned int to, int msgtrigger)\r\n{\r\nif ((from_ssid > to_ssid) || ((from_ssid == to_ssid) && (from > to))) {\r\nif (msgtrigger)\r\npr_warning("0.%x.%04x to 0.%x.%04x is not a valid "\r\n"range for cio_ignore\n", from_ssid, from,\r\nto_ssid, to);\r\nreturn 1;\r\n}\r\nwhile ((from_ssid < to_ssid) || ((from_ssid == to_ssid) &&\r\n(from <= to))) {\r\nif (action == add)\r\nset_bit(from, bl_dev[from_ssid]);\r\nelse\r\nclear_bit(from, bl_dev[from_ssid]);\r\nfrom++;\r\nif (from > __MAX_SUBCHANNEL) {\r\nfrom_ssid++;\r\nfrom = 0;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int pure_hex(char **cp, unsigned int *val, int min_digit,\r\nint max_digit, int max_val)\r\n{\r\nint diff;\r\ndiff = 0;\r\n*val = 0;\r\nwhile (diff <= max_digit) {\r\nint value = hex_to_bin(**cp);\r\nif (value < 0)\r\nbreak;\r\n*val = *val * 16 + value;\r\n(*cp)++;\r\ndiff++;\r\n}\r\nif ((diff < min_digit) || (diff > max_digit) || (*val > max_val))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int parse_busid(char *str, unsigned int *cssid, unsigned int *ssid,\r\nunsigned int *devno, int msgtrigger)\r\n{\r\nchar *str_work;\r\nint val, rc, ret;\r\nrc = 1;\r\nif (*str == '\0')\r\ngoto out;\r\nstr_work = str;\r\nval = simple_strtoul(str, &str_work, 16);\r\nif (*str_work == '\0') {\r\nif (val <= __MAX_SUBCHANNEL) {\r\n*devno = val;\r\n*ssid = 0;\r\n*cssid = 0;\r\nrc = 0;\r\n}\r\ngoto out;\r\n}\r\nstr_work = str;\r\nret = pure_hex(&str_work, cssid, 1, 2, __MAX_CSSID);\r\nif (ret || (str_work[0] != '.'))\r\ngoto out;\r\nstr_work++;\r\nret = pure_hex(&str_work, ssid, 1, 1, __MAX_SSID);\r\nif (ret || (str_work[0] != '.'))\r\ngoto out;\r\nstr_work++;\r\nret = pure_hex(&str_work, devno, 4, 4, __MAX_SUBCHANNEL);\r\nif (ret || (str_work[0] != '\0'))\r\ngoto out;\r\nrc = 0;\r\nout:\r\nif (rc && msgtrigger)\r\npr_warning("%s is not a valid device for the cio_ignore "\r\n"kernel parameter\n", str);\r\nreturn rc;\r\n}\r\nstatic int blacklist_parse_parameters(char *str, range_action action,\r\nint msgtrigger)\r\n{\r\nunsigned int from_cssid, to_cssid, from_ssid, to_ssid, from, to;\r\nint rc, totalrc;\r\nchar *parm;\r\nrange_action ra;\r\ntotalrc = 0;\r\nwhile ((parm = strsep(&str, ","))) {\r\nrc = 0;\r\nra = action;\r\nif (*parm == '!') {\r\nif (ra == add)\r\nra = free;\r\nelse\r\nra = add;\r\nparm++;\r\n}\r\nif (strcmp(parm, "all") == 0) {\r\nfrom_cssid = 0;\r\nfrom_ssid = 0;\r\nfrom = 0;\r\nto_cssid = __MAX_CSSID;\r\nto_ssid = __MAX_SSID;\r\nto = __MAX_SUBCHANNEL;\r\n} else {\r\nrc = parse_busid(strsep(&parm, "-"), &from_cssid,\r\n&from_ssid, &from, msgtrigger);\r\nif (!rc) {\r\nif (parm != NULL)\r\nrc = parse_busid(parm, &to_cssid,\r\n&to_ssid, &to,\r\nmsgtrigger);\r\nelse {\r\nto_cssid = from_cssid;\r\nto_ssid = from_ssid;\r\nto = from;\r\n}\r\n}\r\n}\r\nif (!rc) {\r\nrc = blacklist_range(ra, from_ssid, to_ssid, from, to,\r\nmsgtrigger);\r\nif (rc)\r\ntotalrc = -EINVAL;\r\n} else\r\ntotalrc = -EINVAL;\r\n}\r\nreturn totalrc;\r\n}\r\nstatic int __init\r\nblacklist_setup (char *str)\r\n{\r\nCIO_MSG_EVENT(6, "Reading blacklist parameters\n");\r\nif (blacklist_parse_parameters(str, add, 1))\r\nreturn 0;\r\nreturn 1;\r\n}\r\nint\r\nis_blacklisted (int ssid, int devno)\r\n{\r\nreturn test_bit (devno, bl_dev[ssid]);\r\n}\r\nstatic int blacklist_parse_proc_parameters(char *buf)\r\n{\r\nint rc;\r\nchar *parm;\r\nparm = strsep(&buf, " ");\r\nif (strcmp("free", parm) == 0)\r\nrc = blacklist_parse_parameters(buf, free, 0);\r\nelse if (strcmp("add", parm) == 0)\r\nrc = blacklist_parse_parameters(buf, add, 0);\r\nelse if (strcmp("purge", parm) == 0)\r\nreturn ccw_purge_blacklisted();\r\nelse\r\nreturn -EINVAL;\r\ncss_schedule_reprobe();\r\nreturn rc;\r\n}\r\nstatic void *\r\ncio_ignore_proc_seq_start(struct seq_file *s, loff_t *offset)\r\n{\r\nstruct ccwdev_iter *iter = s->private;\r\nif (*offset >= (__MAX_SUBCHANNEL + 1) * (__MAX_SSID + 1))\r\nreturn NULL;\r\nmemset(iter, 0, sizeof(*iter));\r\niter->ssid = *offset / (__MAX_SUBCHANNEL + 1);\r\niter->devno = *offset % (__MAX_SUBCHANNEL + 1);\r\nreturn iter;\r\n}\r\nstatic void\r\ncio_ignore_proc_seq_stop(struct seq_file *s, void *it)\r\n{\r\n}\r\nstatic void *\r\ncio_ignore_proc_seq_next(struct seq_file *s, void *it, loff_t *offset)\r\n{\r\nstruct ccwdev_iter *iter;\r\nif (*offset >= (__MAX_SUBCHANNEL + 1) * (__MAX_SSID + 1))\r\nreturn NULL;\r\niter = it;\r\nif (iter->devno == __MAX_SUBCHANNEL) {\r\niter->devno = 0;\r\niter->ssid++;\r\nif (iter->ssid > __MAX_SSID)\r\nreturn NULL;\r\n} else\r\niter->devno++;\r\n(*offset)++;\r\nreturn iter;\r\n}\r\nstatic int\r\ncio_ignore_proc_seq_show(struct seq_file *s, void *it)\r\n{\r\nstruct ccwdev_iter *iter;\r\niter = it;\r\nif (!is_blacklisted(iter->ssid, iter->devno))\r\nreturn 0;\r\nif (!iter->in_range) {\r\nif ((iter->devno == __MAX_SUBCHANNEL) ||\r\n!is_blacklisted(iter->ssid, iter->devno + 1))\r\nreturn seq_printf(s, "0.%x.%04x\n",\r\niter->ssid, iter->devno);\r\niter->in_range = 1;\r\nreturn seq_printf(s, "0.%x.%04x-", iter->ssid, iter->devno);\r\n}\r\nif ((iter->devno == __MAX_SUBCHANNEL) ||\r\n!is_blacklisted(iter->ssid, iter->devno + 1)) {\r\niter->in_range = 0;\r\nreturn seq_printf(s, "0.%x.%04x\n", iter->ssid, iter->devno);\r\n}\r\nreturn 0;\r\n}\r\nstatic ssize_t\r\ncio_ignore_write(struct file *file, const char __user *user_buf,\r\nsize_t user_len, loff_t *offset)\r\n{\r\nchar *buf;\r\nssize_t rc, ret, i;\r\nif (*offset)\r\nreturn -EINVAL;\r\nif (user_len > 65536)\r\nuser_len = 65536;\r\nbuf = vmalloc (user_len + 1);\r\nif (buf == NULL)\r\nreturn -ENOMEM;\r\nmemset(buf, 0, user_len + 1);\r\nif (strncpy_from_user (buf, user_buf, user_len) < 0) {\r\nrc = -EFAULT;\r\ngoto out_free;\r\n}\r\ni = user_len - 1;\r\nwhile ((i >= 0) && (isspace(buf[i]) || (buf[i] == 0))) {\r\nbuf[i] = '\0';\r\ni--;\r\n}\r\nret = blacklist_parse_proc_parameters(buf);\r\nif (ret)\r\nrc = ret;\r\nelse\r\nrc = user_len;\r\nout_free:\r\nvfree (buf);\r\nreturn rc;\r\n}\r\nstatic int\r\ncio_ignore_proc_open(struct inode *inode, struct file *file)\r\n{\r\nreturn seq_open_private(file, &cio_ignore_proc_seq_ops,\r\nsizeof(struct ccwdev_iter));\r\n}\r\nstatic int\r\ncio_ignore_proc_init (void)\r\n{\r\nstruct proc_dir_entry *entry;\r\nentry = proc_create("cio_ignore", S_IFREG | S_IRUGO | S_IWUSR, NULL,\r\n&cio_ignore_proc_fops);\r\nif (!entry)\r\nreturn -ENOENT;\r\nreturn 0;\r\n}

static void atamouse_interrupt(char *buf)\r\n{\r\nint buttons, dx, dy;\r\nbuttons = (buf[0] & 1) | ((buf[0] & 2) << 1);\r\n#ifdef FIXED_ATARI_JOYSTICK\r\nbuttons |= atari_mouse_buttons & 2;\r\natari_mouse_buttons = buttons;\r\n#endif\r\ndx = buf[1];\r\ndy = buf[2];\r\ninput_report_rel(atamouse_dev, REL_X, dx);\r\ninput_report_rel(atamouse_dev, REL_Y, dy);\r\ninput_report_key(atamouse_dev, BTN_LEFT, buttons & 0x4);\r\ninput_report_key(atamouse_dev, BTN_MIDDLE, buttons & 0x2);\r\ninput_report_key(atamouse_dev, BTN_RIGHT, buttons & 0x1);\r\ninput_sync(atamouse_dev);\r\nreturn;\r\n}\r\nstatic int atamouse_open(struct input_dev *dev)\r\n{\r\n#ifdef FIXED_ATARI_JOYSTICK\r\natari_mouse_buttons = 0;\r\n#endif\r\nikbd_mouse_y0_top();\r\nikbd_mouse_thresh(mouse_threshold[0], mouse_threshold[1]);\r\nikbd_mouse_rel_pos();\r\natari_input_mouse_interrupt_hook = atamouse_interrupt;\r\nreturn 0;\r\n}\r\nstatic void atamouse_close(struct input_dev *dev)\r\n{\r\nikbd_mouse_disable();\r\natari_input_mouse_interrupt_hook = NULL;\r\n}\r\nstatic int __init atamouse_init(void)\r\n{\r\nint error;\r\nif (!MACH_IS_ATARI || !ATARIHW_PRESENT(ST_MFP))\r\nreturn -ENODEV;\r\nerror = atari_keyb_init();\r\nif (error)\r\nreturn error;\r\natamouse_dev = input_allocate_device();\r\nif (!atamouse_dev)\r\nreturn -ENOMEM;\r\natamouse_dev->name = "Atari mouse";\r\natamouse_dev->phys = "atamouse/input0";\r\natamouse_dev->id.bustype = BUS_HOST;\r\natamouse_dev->id.vendor = 0x0001;\r\natamouse_dev->id.product = 0x0002;\r\natamouse_dev->id.version = 0x0100;\r\natamouse_dev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_REL);\r\natamouse_dev->relbit[0] = BIT_MASK(REL_X) | BIT_MASK(REL_Y);\r\natamouse_dev->keybit[BIT_WORD(BTN_LEFT)] = BIT_MASK(BTN_LEFT) |\r\nBIT_MASK(BTN_MIDDLE) | BIT_MASK(BTN_RIGHT);\r\natamouse_dev->open = atamouse_open;\r\natamouse_dev->close = atamouse_close;\r\nerror = input_register_device(atamouse_dev);\r\nif (error) {\r\ninput_free_device(atamouse_dev);\r\nreturn error;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit atamouse_exit(void)\r\n{\r\ninput_unregister_device(atamouse_dev);\r\n}

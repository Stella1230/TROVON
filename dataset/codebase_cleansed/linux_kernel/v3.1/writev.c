static inline int mtd_fake_writev(struct mtd_info *mtd, const struct kvec *vecs,\r\nunsigned long count, loff_t to, size_t *retlen)\r\n{\r\nunsigned long i;\r\nsize_t totlen = 0, thislen;\r\nint ret = 0;\r\nfor (i=0; i<count; i++) {\r\nif (!vecs[i].iov_len)\r\ncontinue;\r\nret = mtd->write(mtd, to, vecs[i].iov_len, &thislen, vecs[i].iov_base);\r\ntotlen += thislen;\r\nif (ret || thislen != vecs[i].iov_len)\r\nbreak;\r\nto += vecs[i].iov_len;\r\n}\r\nif (retlen)\r\n*retlen = totlen;\r\nreturn ret;\r\n}\r\nint jffs2_flash_direct_writev(struct jffs2_sb_info *c, const struct kvec *vecs,\r\nunsigned long count, loff_t to, size_t *retlen)\r\n{\r\nif (!jffs2_is_writebuffered(c)) {\r\nif (jffs2_sum_active()) {\r\nint res;\r\nres = jffs2_sum_add_kvec(c, vecs, count, (uint32_t) to);\r\nif (res) {\r\nreturn res;\r\n}\r\n}\r\n}\r\nif (c->mtd->writev)\r\nreturn c->mtd->writev(c->mtd, vecs, count, to, retlen);\r\nelse {\r\nreturn mtd_fake_writev(c->mtd, vecs, count, to, retlen);\r\n}\r\n}\r\nint jffs2_flash_direct_write(struct jffs2_sb_info *c, loff_t ofs, size_t len,\r\nsize_t *retlen, const u_char *buf)\r\n{\r\nint ret;\r\nret = c->mtd->write(c->mtd, ofs, len, retlen, buf);\r\nif (jffs2_sum_active()) {\r\nstruct kvec vecs[1];\r\nint res;\r\nvecs[0].iov_base = (unsigned char *) buf;\r\nvecs[0].iov_len = len;\r\nres = jffs2_sum_add_kvec(c, vecs, 1, (uint32_t) ofs);\r\nif (res) {\r\nreturn res;\r\n}\r\n}\r\nreturn ret;\r\n}

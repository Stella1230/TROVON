static inline void hfa384x_outb_debug(struct net_device *dev, int a, u8 v)\r\n{\r\nstruct hostap_interface *iface;\r\nstruct hostap_pci_priv *hw_priv;\r\nlocal_info_t *local;\r\nunsigned long flags;\r\niface = netdev_priv(dev);\r\nlocal = iface->local;\r\nhw_priv = local->hw_priv;\r\nspin_lock_irqsave(&local->lock, flags);\r\nprism2_io_debug_add(dev, PRISM2_IO_DEBUG_CMD_OUTB, a, v);\r\nwriteb(v, hw_priv->mem_start + a);\r\nspin_unlock_irqrestore(&local->lock, flags);\r\n}\r\nstatic inline u8 hfa384x_inb_debug(struct net_device *dev, int a)\r\n{\r\nstruct hostap_interface *iface;\r\nstruct hostap_pci_priv *hw_priv;\r\nlocal_info_t *local;\r\nunsigned long flags;\r\nu8 v;\r\niface = netdev_priv(dev);\r\nlocal = iface->local;\r\nhw_priv = local->hw_priv;\r\nspin_lock_irqsave(&local->lock, flags);\r\nv = readb(hw_priv->mem_start + a);\r\nprism2_io_debug_add(dev, PRISM2_IO_DEBUG_CMD_INB, a, v);\r\nspin_unlock_irqrestore(&local->lock, flags);\r\nreturn v;\r\n}\r\nstatic inline void hfa384x_outw_debug(struct net_device *dev, int a, u16 v)\r\n{\r\nstruct hostap_interface *iface;\r\nstruct hostap_pci_priv *hw_priv;\r\nlocal_info_t *local;\r\nunsigned long flags;\r\niface = netdev_priv(dev);\r\nlocal = iface->local;\r\nhw_priv = local->hw_priv;\r\nspin_lock_irqsave(&local->lock, flags);\r\nprism2_io_debug_add(dev, PRISM2_IO_DEBUG_CMD_OUTW, a, v);\r\nwritew(v, hw_priv->mem_start + a);\r\nspin_unlock_irqrestore(&local->lock, flags);\r\n}\r\nstatic inline u16 hfa384x_inw_debug(struct net_device *dev, int a)\r\n{\r\nstruct hostap_interface *iface;\r\nstruct hostap_pci_priv *hw_priv;\r\nlocal_info_t *local;\r\nunsigned long flags;\r\nu16 v;\r\niface = netdev_priv(dev);\r\nlocal = iface->local;\r\nhw_priv = local->hw_priv;\r\nspin_lock_irqsave(&local->lock, flags);\r\nv = readw(hw_priv->mem_start + a);\r\nprism2_io_debug_add(dev, PRISM2_IO_DEBUG_CMD_INW, a, v);\r\nspin_unlock_irqrestore(&local->lock, flags);\r\nreturn v;\r\n}\r\nstatic inline void hfa384x_outb(struct net_device *dev, int a, u8 v)\r\n{\r\nstruct hostap_interface *iface;\r\nstruct hostap_pci_priv *hw_priv;\r\niface = netdev_priv(dev);\r\nhw_priv = iface->local->hw_priv;\r\nwriteb(v, hw_priv->mem_start + a);\r\n}\r\nstatic inline u8 hfa384x_inb(struct net_device *dev, int a)\r\n{\r\nstruct hostap_interface *iface;\r\nstruct hostap_pci_priv *hw_priv;\r\niface = netdev_priv(dev);\r\nhw_priv = iface->local->hw_priv;\r\nreturn readb(hw_priv->mem_start + a);\r\n}\r\nstatic inline void hfa384x_outw(struct net_device *dev, int a, u16 v)\r\n{\r\nstruct hostap_interface *iface;\r\nstruct hostap_pci_priv *hw_priv;\r\niface = netdev_priv(dev);\r\nhw_priv = iface->local->hw_priv;\r\nwritew(v, hw_priv->mem_start + a);\r\n}\r\nstatic inline u16 hfa384x_inw(struct net_device *dev, int a)\r\n{\r\nstruct hostap_interface *iface;\r\nstruct hostap_pci_priv *hw_priv;\r\niface = netdev_priv(dev);\r\nhw_priv = iface->local->hw_priv;\r\nreturn readw(hw_priv->mem_start + a);\r\n}\r\nstatic int hfa384x_from_bap(struct net_device *dev, u16 bap, void *buf,\r\nint len)\r\n{\r\nu16 d_off;\r\n__le16 *pos;\r\nd_off = (bap == 1) ? HFA384X_DATA1_OFF : HFA384X_DATA0_OFF;\r\npos = (__le16 *) buf;\r\nfor ( ; len > 1; len -= 2)\r\n*pos++ = HFA384X_INW_DATA(d_off);\r\nif (len & 1)\r\n*((char *) pos) = HFA384X_INB(d_off);\r\nreturn 0;\r\n}\r\nstatic int hfa384x_to_bap(struct net_device *dev, u16 bap, void *buf, int len)\r\n{\r\nu16 d_off;\r\n__le16 *pos;\r\nd_off = (bap == 1) ? HFA384X_DATA1_OFF : HFA384X_DATA0_OFF;\r\npos = (__le16 *) buf;\r\nfor ( ; len > 1; len -= 2)\r\nHFA384X_OUTW_DATA(*pos++, d_off);\r\nif (len & 1)\r\nHFA384X_OUTB(*((char *) pos), d_off);\r\nreturn 0;\r\n}\r\nstatic void prism2_pci_cor_sreset(local_info_t *local)\r\n{\r\nstruct net_device *dev = local->dev;\r\nu16 reg;\r\nreg = HFA384X_INB(HFA384X_PCICOR_OFF);\r\nprintk(KERN_DEBUG "%s: Original COR value: 0x%0x\n", dev->name, reg);\r\n#ifdef PRISM2_PCI_USE_LONG_DELAYS\r\nint i;\r\nHFA384X_OUTW(reg | 0x0080, HFA384X_PCICOR_OFF);\r\nmdelay(250);\r\nHFA384X_OUTW(reg & ~0x0080, HFA384X_PCICOR_OFF);\r\nmdelay(500);\r\ni = 2000000 / 10;\r\nwhile ((HFA384X_INW(HFA384X_CMD_OFF) & HFA384X_CMD_BUSY) && --i)\r\nudelay(10);\r\n#else\r\nHFA384X_OUTW(reg | 0x0080, HFA384X_PCICOR_OFF);\r\nmdelay(2);\r\nHFA384X_OUTW(reg & ~0x0080, HFA384X_PCICOR_OFF);\r\nmdelay(2);\r\n#endif\r\nif (HFA384X_INW(HFA384X_CMD_OFF) & HFA384X_CMD_BUSY) {\r\nprintk(KERN_DEBUG "%s: COR sreset timeout\n", dev->name);\r\n}\r\n}\r\nstatic void prism2_pci_genesis_reset(local_info_t *local, int hcr)\r\n{\r\nstruct net_device *dev = local->dev;\r\nHFA384X_OUTW(0x00C5, HFA384X_PCICOR_OFF);\r\nmdelay(10);\r\nHFA384X_OUTW(hcr, HFA384X_PCIHCR_OFF);\r\nmdelay(10);\r\nHFA384X_OUTW(0x0045, HFA384X_PCICOR_OFF);\r\nmdelay(10);\r\n}\r\nstatic int prism2_pci_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *id)\r\n{\r\nunsigned long phymem;\r\nvoid __iomem *mem = NULL;\r\nlocal_info_t *local = NULL;\r\nstruct net_device *dev = NULL;\r\nstatic int cards_found ;\r\nint irq_registered = 0;\r\nstruct hostap_interface *iface;\r\nstruct hostap_pci_priv *hw_priv;\r\nhw_priv = kzalloc(sizeof(*hw_priv), GFP_KERNEL);\r\nif (hw_priv == NULL)\r\nreturn -ENOMEM;\r\nif (pci_enable_device(pdev))\r\ngoto err_out_free;\r\nphymem = pci_resource_start(pdev, 0);\r\nif (!request_mem_region(phymem, pci_resource_len(pdev, 0), "Prism2")) {\r\nprintk(KERN_ERR "prism2: Cannot reserve PCI memory region\n");\r\ngoto err_out_disable;\r\n}\r\nmem = pci_ioremap_bar(pdev, 0);\r\nif (mem == NULL) {\r\nprintk(KERN_ERR "prism2: Cannot remap PCI memory region\n") ;\r\ngoto fail;\r\n}\r\ndev = prism2_init_local_data(&prism2_pci_funcs, cards_found,\r\n&pdev->dev);\r\nif (dev == NULL)\r\ngoto fail;\r\niface = netdev_priv(dev);\r\nlocal = iface->local;\r\nlocal->hw_priv = hw_priv;\r\ncards_found++;\r\ndev->irq = pdev->irq;\r\nhw_priv->mem_start = mem;\r\ndev->base_addr = (unsigned long) mem;\r\nprism2_pci_cor_sreset(local);\r\npci_set_drvdata(pdev, dev);\r\nif (request_irq(dev->irq, prism2_interrupt, IRQF_SHARED, dev->name,\r\ndev)) {\r\nprintk(KERN_WARNING "%s: request_irq failed\n", dev->name);\r\ngoto fail;\r\n} else\r\nirq_registered = 1;\r\nif (!local->pri_only && prism2_hw_config(dev, 1)) {\r\nprintk(KERN_DEBUG "%s: hardware initialization failed\n",\r\ndev_info);\r\ngoto fail;\r\n}\r\nprintk(KERN_INFO "%s: Intersil Prism2.5 PCI: "\r\n"mem=0x%lx, irq=%d\n", dev->name, phymem, dev->irq);\r\nreturn hostap_hw_ready(dev);\r\nfail:\r\nif (irq_registered && dev)\r\nfree_irq(dev->irq, dev);\r\nif (mem)\r\niounmap(mem);\r\nrelease_mem_region(phymem, pci_resource_len(pdev, 0));\r\nerr_out_disable:\r\npci_disable_device(pdev);\r\nprism2_free_local_data(dev);\r\nerr_out_free:\r\nkfree(hw_priv);\r\nreturn -ENODEV;\r\n}\r\nstatic void prism2_pci_remove(struct pci_dev *pdev)\r\n{\r\nstruct net_device *dev;\r\nstruct hostap_interface *iface;\r\nvoid __iomem *mem_start;\r\nstruct hostap_pci_priv *hw_priv;\r\ndev = pci_get_drvdata(pdev);\r\niface = netdev_priv(dev);\r\nhw_priv = iface->local->hw_priv;\r\nprism2_pci_cor_sreset(iface->local);\r\nhfa384x_disable_interrupts(dev);\r\nif (dev->irq)\r\nfree_irq(dev->irq, dev);\r\nmem_start = hw_priv->mem_start;\r\nprism2_free_local_data(dev);\r\nkfree(hw_priv);\r\niounmap(mem_start);\r\nrelease_mem_region(pci_resource_start(pdev, 0),\r\npci_resource_len(pdev, 0));\r\npci_disable_device(pdev);\r\n}\r\nstatic int prism2_pci_suspend(struct pci_dev *pdev, pm_message_t state)\r\n{\r\nstruct net_device *dev = pci_get_drvdata(pdev);\r\nif (netif_running(dev)) {\r\nnetif_stop_queue(dev);\r\nnetif_device_detach(dev);\r\n}\r\nprism2_suspend(dev);\r\npci_save_state(pdev);\r\npci_disable_device(pdev);\r\npci_set_power_state(pdev, PCI_D3hot);\r\nreturn 0;\r\n}\r\nstatic int prism2_pci_resume(struct pci_dev *pdev)\r\n{\r\nstruct net_device *dev = pci_get_drvdata(pdev);\r\nint err;\r\nerr = pci_enable_device(pdev);\r\nif (err) {\r\nprintk(KERN_ERR "%s: pci_enable_device failed on resume\n",\r\ndev->name);\r\nreturn err;\r\n}\r\npci_restore_state(pdev);\r\nprism2_hw_config(dev, 0);\r\nif (netif_running(dev)) {\r\nnetif_device_attach(dev);\r\nnetif_start_queue(dev);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init init_prism2_pci(void)\r\n{\r\nreturn pci_register_driver(&prism2_pci_driver);\r\n}\r\nstatic void __exit exit_prism2_pci(void)\r\n{\r\npci_unregister_driver(&prism2_pci_driver);\r\n}

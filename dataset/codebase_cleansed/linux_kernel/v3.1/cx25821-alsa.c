static int _cx25821_start_audio_dma(struct cx25821_audio_dev *chip)\r\n{\r\nstruct cx25821_audio_buffer *buf = chip->buf;\r\nstruct cx25821_dev *dev = chip->dev;\r\nstruct sram_channel *audio_ch =\r\n&cx25821_sram_channels[AUDIO_SRAM_CHANNEL];\r\nu32 tmp = 0;\r\ncx25821_set_gpiopin_direction(chip->dev, 0, 0);\r\ncx_clear(AUD_INT_DMA_CTL,\r\nFLD_AUD_DST_A_RISC_EN | FLD_AUD_DST_A_FIFO_EN);\r\ncx25821_sram_channel_setup_audio(chip->dev, audio_ch, buf->bpl,\r\nbuf->risc.dma);\r\ncx_write(AUD_A_LNGTH, buf->bpl);\r\ncx_write(AUD_A_GPCNT_CTL, GP_COUNT_CONTROL_RESET);\r\natomic_set(&chip->count, 0);\r\ntmp = cx_read(AUD_A_CFG);\r\ncx_write(AUD_A_CFG,\r\ntmp | FLD_AUD_DST_PK_MODE | FLD_AUD_DST_ENABLE |\r\nFLD_AUD_CLK_ENABLE);\r\ncx_write(AUD_A_INT_MSK,\r\nFLD_AUD_DST_RISCI1 | FLD_AUD_DST_OF | FLD_AUD_DST_SYNC |\r\nFLD_AUD_DST_OPC_ERR);\r\ncx_write(AUD_A_INT_STAT, ~0);\r\ncx_set(PCI_INT_MSK, chip->dev->pci_irqmask | PCI_MSK_AUD_INT);\r\ntmp = cx_read(AUD_INT_DMA_CTL);\r\ncx_set(AUD_INT_DMA_CTL,\r\ntmp | (FLD_AUD_DST_A_RISC_EN | FLD_AUD_DST_A_FIFO_EN));\r\nmdelay(100);\r\nreturn 0;\r\n}\r\nstatic int _cx25821_stop_audio_dma(struct cx25821_audio_dev *chip)\r\n{\r\nstruct cx25821_dev *dev = chip->dev;\r\ncx_clear(AUD_INT_DMA_CTL,\r\nFLD_AUD_DST_A_RISC_EN | FLD_AUD_DST_A_FIFO_EN);\r\ncx_clear(PCI_INT_MSK, PCI_MSK_AUD_INT);\r\ncx_clear(AUD_A_INT_MSK,\r\nAUD_INT_OPC_ERR | AUD_INT_DN_SYNC | AUD_INT_DN_RISCI2 |\r\nAUD_INT_DN_RISCI1);\r\nreturn 0;\r\n}\r\nstatic void cx25821_aud_irq(struct cx25821_audio_dev *chip, u32 status,\r\nu32 mask)\r\n{\r\nstruct cx25821_dev *dev = chip->dev;\r\nif (0 == (status & mask))\r\nreturn;\r\ncx_write(AUD_A_INT_STAT, status);\r\nif (debug > 1 || (status & mask & ~0xff))\r\ncx25821_print_irqbits(dev->name, "irq aud",\r\ncx25821_aud_irqs,\r\nARRAY_SIZE(cx25821_aud_irqs), status,\r\nmask);\r\nif (status & AUD_INT_OPC_ERR) {\r\npr_warn("WARNING %s/1: Audio risc op code error\n", dev->name);\r\ncx_clear(AUD_INT_DMA_CTL,\r\nFLD_AUD_DST_A_RISC_EN | FLD_AUD_DST_A_FIFO_EN);\r\ncx25821_sram_channel_dump_audio(dev,\r\n&cx25821_sram_channels\r\n[AUDIO_SRAM_CHANNEL]);\r\n}\r\nif (status & AUD_INT_DN_SYNC) {\r\npr_warn("WARNING %s: Downstream sync error!\n", dev->name);\r\ncx_write(AUD_A_GPCNT_CTL, GP_COUNT_CONTROL_RESET);\r\nreturn;\r\n}\r\nif (status & AUD_INT_DN_RISCI1) {\r\natomic_set(&chip->count, cx_read(AUD_A_GPCNT));\r\nsnd_pcm_period_elapsed(chip->substream);\r\n}\r\n}\r\nstatic irqreturn_t cx25821_irq(int irq, void *dev_id)\r\n{\r\nstruct cx25821_audio_dev *chip = dev_id;\r\nstruct cx25821_dev *dev = chip->dev;\r\nu32 status, pci_status;\r\nu32 audint_status, audint_mask;\r\nint loop, handled = 0;\r\nint audint_count = 0;\r\naudint_status = cx_read(AUD_A_INT_STAT);\r\naudint_mask = cx_read(AUD_A_INT_MSK);\r\naudint_count = cx_read(AUD_A_GPCNT);\r\nstatus = cx_read(PCI_INT_STAT);\r\nfor (loop = 0; loop < 1; loop++) {\r\nstatus = cx_read(PCI_INT_STAT);\r\nif (0 == status) {\r\nstatus = cx_read(PCI_INT_STAT);\r\naudint_status = cx_read(AUD_A_INT_STAT);\r\naudint_mask = cx_read(AUD_A_INT_MSK);\r\nif (status) {\r\nhandled = 1;\r\ncx_write(PCI_INT_STAT, status);\r\ncx25821_aud_irq(chip, audint_status,\r\naudint_mask);\r\nbreak;\r\n} else\r\ngoto out;\r\n}\r\nhandled = 1;\r\ncx_write(PCI_INT_STAT, status);\r\ncx25821_aud_irq(chip, audint_status, audint_mask);\r\n}\r\npci_status = cx_read(PCI_INT_STAT);\r\nif (handled)\r\ncx_write(PCI_INT_STAT, pci_status);\r\nout:\r\nreturn IRQ_RETVAL(handled);\r\n}\r\nstatic int dsp_buffer_free(struct cx25821_audio_dev *chip)\r\n{\r\nBUG_ON(!chip->dma_size);\r\ndprintk(2, "Freeing buffer\n");\r\nvideobuf_dma_unmap(&chip->pci->dev, chip->dma_risc);\r\nvideobuf_dma_free(chip->dma_risc);\r\nbtcx_riscmem_free(chip->pci, &chip->buf->risc);\r\nkfree(chip->buf);\r\nchip->dma_risc = NULL;\r\nchip->dma_size = 0;\r\nreturn 0;\r\n}\r\nstatic int snd_cx25821_pcm_open(struct snd_pcm_substream *substream)\r\n{\r\nstruct cx25821_audio_dev *chip = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nint err;\r\nunsigned int bpl = 0;\r\nif (!chip) {\r\npr_err("DEBUG: cx25821 can't find device struct. Can't proceed with open\n");\r\nreturn -ENODEV;\r\n}\r\nerr =\r\nsnd_pcm_hw_constraint_pow2(runtime, 0, SNDRV_PCM_HW_PARAM_PERIODS);\r\nif (err < 0)\r\ngoto _error;\r\nchip->substream = substream;\r\nruntime->hw = snd_cx25821_digital_hw;\r\nif (cx25821_sram_channels[AUDIO_SRAM_CHANNEL].fifo_size !=\r\nDEFAULT_FIFO_SIZE) {\r\nbpl = cx25821_sram_channels[AUDIO_SRAM_CHANNEL].fifo_size / 3;\r\nbpl &= ~7;\r\nif (bpl > AUDIO_LINE_SIZE)\r\nbpl = AUDIO_LINE_SIZE;\r\nruntime->hw.period_bytes_min = bpl;\r\nruntime->hw.period_bytes_max = bpl;\r\n}\r\nreturn 0;\r\n_error:\r\ndprintk(1, "Error opening PCM!\n");\r\nreturn err;\r\n}\r\nstatic int snd_cx25821_close(struct snd_pcm_substream *substream)\r\n{\r\nreturn 0;\r\n}\r\nstatic int snd_cx25821_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *hw_params)\r\n{\r\nstruct cx25821_audio_dev *chip = snd_pcm_substream_chip(substream);\r\nstruct videobuf_dmabuf *dma;\r\nstruct cx25821_audio_buffer *buf;\r\nint ret;\r\nif (substream->runtime->dma_area) {\r\ndsp_buffer_free(chip);\r\nsubstream->runtime->dma_area = NULL;\r\n}\r\nchip->period_size = params_period_bytes(hw_params);\r\nchip->num_periods = params_periods(hw_params);\r\nchip->dma_size = chip->period_size * params_periods(hw_params);\r\nBUG_ON(!chip->dma_size);\r\nBUG_ON(chip->num_periods & (chip->num_periods - 1));\r\nbuf = kzalloc(sizeof(*buf), GFP_KERNEL);\r\nif (NULL == buf)\r\nreturn -ENOMEM;\r\nif (chip->period_size > AUDIO_LINE_SIZE)\r\nchip->period_size = AUDIO_LINE_SIZE;\r\nbuf->bpl = chip->period_size;\r\ndma = &buf->dma;\r\nvideobuf_dma_init(dma);\r\nret = videobuf_dma_init_kernel(dma, PCI_DMA_FROMDEVICE,\r\n(PAGE_ALIGN(chip->dma_size) >>\r\nPAGE_SHIFT));\r\nif (ret < 0)\r\ngoto error;\r\nret = videobuf_dma_map(&chip->pci->dev, dma);\r\nif (ret < 0)\r\ngoto error;\r\nret =\r\ncx25821_risc_databuffer_audio(chip->pci, &buf->risc, dma->sglist,\r\nchip->period_size, chip->num_periods,\r\n1);\r\nif (ret < 0) {\r\npr_info("DEBUG: ERROR after cx25821_risc_databuffer_audio()\n");\r\ngoto error;\r\n}\r\nbuf->risc.jmp[0] = cpu_to_le32(RISC_JUMP | RISC_IRQ1 | RISC_CNT_INC);\r\nbuf->risc.jmp[1] = cpu_to_le32(buf->risc.dma);\r\nbuf->risc.jmp[2] = cpu_to_le32(0);\r\nchip->buf = buf;\r\nchip->dma_risc = dma;\r\nsubstream->runtime->dma_area = chip->dma_risc->vaddr;\r\nsubstream->runtime->dma_bytes = chip->dma_size;\r\nsubstream->runtime->dma_addr = 0;\r\nreturn 0;\r\nerror:\r\nkfree(buf);\r\nreturn ret;\r\n}\r\nstatic int snd_cx25821_hw_free(struct snd_pcm_substream *substream)\r\n{\r\nstruct cx25821_audio_dev *chip = snd_pcm_substream_chip(substream);\r\nif (substream->runtime->dma_area) {\r\ndsp_buffer_free(chip);\r\nsubstream->runtime->dma_area = NULL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int snd_cx25821_prepare(struct snd_pcm_substream *substream)\r\n{\r\nreturn 0;\r\n}\r\nstatic int snd_cx25821_card_trigger(struct snd_pcm_substream *substream,\r\nint cmd)\r\n{\r\nstruct cx25821_audio_dev *chip = snd_pcm_substream_chip(substream);\r\nint err = 0;\r\nspin_lock(&chip->reg_lock);\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\nerr = _cx25821_start_audio_dma(chip);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\nerr = _cx25821_stop_audio_dma(chip);\r\nbreak;\r\ndefault:\r\nerr = -EINVAL;\r\nbreak;\r\n}\r\nspin_unlock(&chip->reg_lock);\r\nreturn err;\r\n}\r\nstatic snd_pcm_uframes_t snd_cx25821_pointer(struct snd_pcm_substream\r\n*substream)\r\n{\r\nstruct cx25821_audio_dev *chip = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nu16 count;\r\ncount = atomic_read(&chip->count);\r\nreturn runtime->period_size * (count & (runtime->periods - 1));\r\n}\r\nstatic struct page *snd_cx25821_page(struct snd_pcm_substream *substream,\r\nunsigned long offset)\r\n{\r\nvoid *pageptr = substream->runtime->dma_area + offset;\r\nreturn vmalloc_to_page(pageptr);\r\n}\r\nstatic int snd_cx25821_pcm(struct cx25821_audio_dev *chip, int device,\r\nchar *name)\r\n{\r\nstruct snd_pcm *pcm;\r\nint err;\r\nerr = snd_pcm_new(chip->card, name, device, 0, 1, &pcm);\r\nif (err < 0) {\r\npr_info("ERROR: FAILED snd_pcm_new() in %s\n", __func__);\r\nreturn err;\r\n}\r\npcm->private_data = chip;\r\npcm->info_flags = 0;\r\nstrcpy(pcm->name, name);\r\nsnd_pcm_set_ops(pcm, SNDRV_PCM_STREAM_CAPTURE, &snd_cx25821_pcm_ops);\r\nreturn 0;\r\n}\r\nstatic void snd_cx25821_dev_free(struct snd_card *card)\r\n{\r\nstruct cx25821_audio_dev *chip = card->private_data;\r\nsnd_card_free(chip->card);\r\n}\r\nstatic int cx25821_audio_initdev(struct cx25821_dev *dev)\r\n{\r\nstruct snd_card *card;\r\nstruct cx25821_audio_dev *chip;\r\nint err;\r\nif (devno >= SNDRV_CARDS) {\r\npr_info("DEBUG ERROR: devno >= SNDRV_CARDS %s\n", __func__);\r\nreturn -ENODEV;\r\n}\r\nif (!enable[devno]) {\r\n++devno;\r\npr_info("DEBUG ERROR: !enable[devno] %s\n", __func__);\r\nreturn -ENOENT;\r\n}\r\nerr = snd_card_create(index[devno], id[devno], THIS_MODULE,\r\nsizeof(struct cx25821_audio_dev), &card);\r\nif (err < 0) {\r\npr_info("DEBUG ERROR: cannot create snd_card_new in %s\n",\r\n__func__);\r\nreturn err;\r\n}\r\nstrcpy(card->driver, "cx25821");\r\ncard->private_free = snd_cx25821_dev_free;\r\nchip = card->private_data;\r\nspin_lock_init(&chip->reg_lock);\r\nchip->dev = dev;\r\nchip->card = card;\r\nchip->pci = dev->pci;\r\nchip->iobase = pci_resource_start(dev->pci, 0);\r\nchip->irq = dev->pci->irq;\r\nerr = request_irq(dev->pci->irq, cx25821_irq,\r\nIRQF_SHARED | IRQF_DISABLED, chip->dev->name, chip);\r\nif (err < 0) {\r\npr_err("ERROR %s: can't get IRQ %d for ALSA\n",\r\nchip->dev->name, dev->pci->irq);\r\ngoto error;\r\n}\r\nerr = snd_cx25821_pcm(chip, 0, "cx25821 Digital");\r\nif (err < 0) {\r\npr_info("DEBUG ERROR: cannot create snd_cx25821_pcm %s\n",\r\n__func__);\r\ngoto error;\r\n}\r\nsnd_card_set_dev(card, &chip->pci->dev);\r\nstrcpy(card->shortname, "cx25821");\r\nsprintf(card->longname, "%s at 0x%lx irq %d", chip->dev->name,\r\nchip->iobase, chip->irq);\r\nstrcpy(card->mixername, "CX25821");\r\npr_info("%s/%i: ALSA support for cx25821 boards\n",\r\ncard->driver, devno);\r\nerr = snd_card_register(card);\r\nif (err < 0) {\r\npr_info("DEBUG ERROR: cannot register sound card %s\n",\r\n__func__);\r\ngoto error;\r\n}\r\nsnd_cx25821_cards[devno] = card;\r\ndevno++;\r\nreturn 0;\r\nerror:\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\nstatic void cx25821_audio_fini(void)\r\n{\r\nsnd_card_free(snd_cx25821_cards[0]);\r\n}\r\nstatic int cx25821_alsa_init(void)\r\n{\r\nstruct cx25821_dev *dev = NULL;\r\nstruct list_head *list;\r\nmutex_lock(&cx25821_devlist_mutex);\r\nlist_for_each(list, &cx25821_devlist) {\r\ndev = list_entry(list, struct cx25821_dev, devlist);\r\ncx25821_audio_initdev(dev);\r\n}\r\nmutex_unlock(&cx25821_devlist_mutex);\r\nif (dev == NULL)\r\npr_info("ERROR ALSA: no cx25821 cards found\n");\r\nreturn 0;\r\n}

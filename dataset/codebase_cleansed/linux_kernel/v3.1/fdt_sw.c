static int _fdt_sw_check_header(void *fdt)\r\n{\r\nif (fdt_magic(fdt) != FDT_SW_MAGIC)\r\nreturn -FDT_ERR_BADMAGIC;\r\nreturn 0;\r\n}\r\nstatic void *_fdt_grab_space(void *fdt, int len)\r\n{\r\nint offset = fdt_size_dt_struct(fdt);\r\nint spaceleft;\r\nspaceleft = fdt_totalsize(fdt) - fdt_off_dt_struct(fdt)\r\n- fdt_size_dt_strings(fdt);\r\nif ((offset + len < offset) || (offset + len > spaceleft))\r\nreturn NULL;\r\nfdt_set_size_dt_struct(fdt, offset + len);\r\nreturn fdt_offset_ptr_w(fdt, offset, len);\r\n}\r\nint fdt_create(void *buf, int bufsize)\r\n{\r\nvoid *fdt = buf;\r\nif (bufsize < sizeof(struct fdt_header))\r\nreturn -FDT_ERR_NOSPACE;\r\nmemset(buf, 0, bufsize);\r\nfdt_set_magic(fdt, FDT_SW_MAGIC);\r\nfdt_set_version(fdt, FDT_LAST_SUPPORTED_VERSION);\r\nfdt_set_last_comp_version(fdt, FDT_FIRST_SUPPORTED_VERSION);\r\nfdt_set_totalsize(fdt, bufsize);\r\nfdt_set_off_mem_rsvmap(fdt, FDT_ALIGN(sizeof(struct fdt_header),\r\nsizeof(struct fdt_reserve_entry)));\r\nfdt_set_off_dt_struct(fdt, fdt_off_mem_rsvmap(fdt));\r\nfdt_set_off_dt_strings(fdt, bufsize);\r\nreturn 0;\r\n}\r\nint fdt_add_reservemap_entry(void *fdt, uint64_t addr, uint64_t size)\r\n{\r\nstruct fdt_reserve_entry *re;\r\nint offset;\r\nFDT_SW_CHECK_HEADER(fdt);\r\nif (fdt_size_dt_struct(fdt))\r\nreturn -FDT_ERR_BADSTATE;\r\noffset = fdt_off_dt_struct(fdt);\r\nif ((offset + sizeof(*re)) > fdt_totalsize(fdt))\r\nreturn -FDT_ERR_NOSPACE;\r\nre = (struct fdt_reserve_entry *)((char *)fdt + offset);\r\nre->address = cpu_to_fdt64(addr);\r\nre->size = cpu_to_fdt64(size);\r\nfdt_set_off_dt_struct(fdt, offset + sizeof(*re));\r\nreturn 0;\r\n}\r\nint fdt_finish_reservemap(void *fdt)\r\n{\r\nreturn fdt_add_reservemap_entry(fdt, 0, 0);\r\n}\r\nint fdt_begin_node(void *fdt, const char *name)\r\n{\r\nstruct fdt_node_header *nh;\r\nint namelen = strlen(name) + 1;\r\nFDT_SW_CHECK_HEADER(fdt);\r\nnh = _fdt_grab_space(fdt, sizeof(*nh) + FDT_TAGALIGN(namelen));\r\nif (! nh)\r\nreturn -FDT_ERR_NOSPACE;\r\nnh->tag = cpu_to_fdt32(FDT_BEGIN_NODE);\r\nmemcpy(nh->name, name, namelen);\r\nreturn 0;\r\n}\r\nint fdt_end_node(void *fdt)\r\n{\r\nuint32_t *en;\r\nFDT_SW_CHECK_HEADER(fdt);\r\nen = _fdt_grab_space(fdt, FDT_TAGSIZE);\r\nif (! en)\r\nreturn -FDT_ERR_NOSPACE;\r\n*en = cpu_to_fdt32(FDT_END_NODE);\r\nreturn 0;\r\n}\r\nstatic int _fdt_find_add_string(void *fdt, const char *s)\r\n{\r\nchar *strtab = (char *)fdt + fdt_totalsize(fdt);\r\nconst char *p;\r\nint strtabsize = fdt_size_dt_strings(fdt);\r\nint len = strlen(s) + 1;\r\nint struct_top, offset;\r\np = _fdt_find_string(strtab - strtabsize, strtabsize, s);\r\nif (p)\r\nreturn p - strtab;\r\noffset = -strtabsize - len;\r\nstruct_top = fdt_off_dt_struct(fdt) + fdt_size_dt_struct(fdt);\r\nif (fdt_totalsize(fdt) + offset < struct_top)\r\nreturn 0;\r\nmemcpy(strtab + offset, s, len);\r\nfdt_set_size_dt_strings(fdt, strtabsize + len);\r\nreturn offset;\r\n}\r\nint fdt_property(void *fdt, const char *name, const void *val, int len)\r\n{\r\nstruct fdt_property *prop;\r\nint nameoff;\r\nFDT_SW_CHECK_HEADER(fdt);\r\nnameoff = _fdt_find_add_string(fdt, name);\r\nif (nameoff == 0)\r\nreturn -FDT_ERR_NOSPACE;\r\nprop = _fdt_grab_space(fdt, sizeof(*prop) + FDT_TAGALIGN(len));\r\nif (! prop)\r\nreturn -FDT_ERR_NOSPACE;\r\nprop->tag = cpu_to_fdt32(FDT_PROP);\r\nprop->nameoff = cpu_to_fdt32(nameoff);\r\nprop->len = cpu_to_fdt32(len);\r\nmemcpy(prop->data, val, len);\r\nreturn 0;\r\n}\r\nint fdt_finish(void *fdt)\r\n{\r\nchar *p = (char *)fdt;\r\nuint32_t *end;\r\nint oldstroffset, newstroffset;\r\nuint32_t tag;\r\nint offset, nextoffset;\r\nFDT_SW_CHECK_HEADER(fdt);\r\nend = _fdt_grab_space(fdt, sizeof(*end));\r\nif (! end)\r\nreturn -FDT_ERR_NOSPACE;\r\n*end = cpu_to_fdt32(FDT_END);\r\noldstroffset = fdt_totalsize(fdt) - fdt_size_dt_strings(fdt);\r\nnewstroffset = fdt_off_dt_struct(fdt) + fdt_size_dt_struct(fdt);\r\nmemmove(p + newstroffset, p + oldstroffset, fdt_size_dt_strings(fdt));\r\nfdt_set_off_dt_strings(fdt, newstroffset);\r\noffset = 0;\r\nwhile ((tag = fdt_next_tag(fdt, offset, &nextoffset)) != FDT_END) {\r\nif (tag == FDT_PROP) {\r\nstruct fdt_property *prop =\r\nfdt_offset_ptr_w(fdt, offset, sizeof(*prop));\r\nint nameoff;\r\nif (! prop)\r\nreturn -FDT_ERR_BADSTRUCTURE;\r\nnameoff = fdt32_to_cpu(prop->nameoff);\r\nnameoff += fdt_size_dt_strings(fdt);\r\nprop->nameoff = cpu_to_fdt32(nameoff);\r\n}\r\noffset = nextoffset;\r\n}\r\nfdt_set_totalsize(fdt, newstroffset + fdt_size_dt_strings(fdt));\r\nfdt_set_magic(fdt, FDT_MAGIC);\r\nreturn 0;\r\n}

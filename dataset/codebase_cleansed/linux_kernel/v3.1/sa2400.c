static void write_sa2400(struct ieee80211_hw *dev, u8 addr, u32 data)\r\n{\r\nstruct rtl8180_priv *priv = dev->priv;\r\nu32 phy_config;\r\nphy_config = 0xb0000000;\r\nphy_config |= ((u32)(addr & 0xf)) << 24;\r\nphy_config |= data & 0xffffff;\r\nrtl818x_iowrite32(priv,\r\n(__le32 __iomem *) &priv->map->RFPinsOutput, phy_config);\r\nmsleep(3);\r\n}\r\nstatic void sa2400_write_phy_antenna(struct ieee80211_hw *dev, short chan)\r\n{\r\nstruct rtl8180_priv *priv = dev->priv;\r\nu8 ant = SA2400_ANTENNA;\r\nif (priv->rfparam & RF_PARAM_ANTBDEFAULT)\r\nant |= BB_ANTENNA_B;\r\nif (chan == 14)\r\nant |= BB_ANTATTEN_CHAN14;\r\nrtl8180_write_phy(dev, 0x10, ant);\r\n}\r\nstatic u8 sa2400_rf_calc_rssi(u8 agc, u8 sq)\r\n{\r\nif (sq == 0x80)\r\nreturn 1;\r\nif (sq > 78)\r\nreturn 32;\r\nreturn 65 * sa2400_rf_rssi_map[sq] / 100;\r\n}\r\nstatic void sa2400_rf_set_channel(struct ieee80211_hw *dev,\r\nstruct ieee80211_conf *conf)\r\n{\r\nstruct rtl8180_priv *priv = dev->priv;\r\nint channel = ieee80211_frequency_to_channel(conf->channel->center_freq);\r\nu32 txpw = priv->channels[channel - 1].hw_value & 0xFF;\r\nu32 chan = sa2400_chan[channel - 1];\r\nwrite_sa2400(dev, 7, txpw);\r\nsa2400_write_phy_antenna(dev, channel);\r\nwrite_sa2400(dev, 0, chan);\r\nwrite_sa2400(dev, 1, 0xbb50);\r\nwrite_sa2400(dev, 2, 0x80);\r\nwrite_sa2400(dev, 3, 0);\r\n}\r\nstatic void sa2400_rf_stop(struct ieee80211_hw *dev)\r\n{\r\nwrite_sa2400(dev, 4, 0);\r\n}\r\nstatic void sa2400_rf_init(struct ieee80211_hw *dev)\r\n{\r\nstruct rtl8180_priv *priv = dev->priv;\r\nu32 anaparam, txconf;\r\nu8 firdac;\r\nint analogphy = priv->rfparam & RF_PARAM_ANALOGPHY;\r\nanaparam = priv->anaparam;\r\nanaparam &= ~(1 << ANAPARAM_TXDACOFF_SHIFT);\r\nanaparam &= ~ANAPARAM_PWR1_MASK;\r\nanaparam &= ~ANAPARAM_PWR0_MASK;\r\nif (analogphy) {\r\nanaparam |= SA2400_ANA_ANAPARAM_PWR1_ON << ANAPARAM_PWR1_SHIFT;\r\nfirdac = 0;\r\n} else {\r\nanaparam |= (SA2400_DIG_ANAPARAM_PWR1_ON << ANAPARAM_PWR1_SHIFT);\r\nanaparam |= (SA2400_ANAPARAM_PWR0_ON << ANAPARAM_PWR0_SHIFT);\r\nfirdac = 1 << SA2400_REG4_FIRDAC_SHIFT;\r\n}\r\nrtl8180_set_anaparam(priv, anaparam);\r\nwrite_sa2400(dev, 0, sa2400_chan[0]);\r\nwrite_sa2400(dev, 1, 0xbb50);\r\nwrite_sa2400(dev, 2, 0x80);\r\nwrite_sa2400(dev, 3, 0);\r\nwrite_sa2400(dev, 4, 0x19340 | firdac);\r\nwrite_sa2400(dev, 5, 0x1dfb | (SA2400_MAX_SENS - 54) << 15);\r\nwrite_sa2400(dev, 4, 0x19348 | firdac);\r\nif (!analogphy)\r\nwrite_sa2400(dev, 4, 0x1938c);\r\nwrite_sa2400(dev, 4, 0x19340 | firdac);\r\nwrite_sa2400(dev, 0, sa2400_chan[0]);\r\nwrite_sa2400(dev, 1, 0xbb50);\r\nwrite_sa2400(dev, 2, 0x80);\r\nwrite_sa2400(dev, 3, 0);\r\nwrite_sa2400(dev, 4, 0x19344 | firdac);\r\nwrite_sa2400(dev, 6, 0x13ff | (1 << 23));\r\nwrite_sa2400(dev, 8, 0);\r\nif (analogphy) {\r\nrtl8180_set_anaparam(priv, anaparam |\r\n(1 << ANAPARAM_TXDACOFF_SHIFT));\r\ntxconf = rtl818x_ioread32(priv, &priv->map->TX_CONF);\r\nrtl818x_iowrite32(priv, &priv->map->TX_CONF,\r\ntxconf | RTL818X_TX_CONF_LOOPBACK_CONT);\r\nwrite_sa2400(dev, 4, 0x19341);\r\nwrite_sa2400(dev, 4, 0x19345);\r\nrtl818x_iowrite32(priv, &priv->map->TX_CONF, txconf);\r\nrtl8180_set_anaparam(priv, anaparam);\r\n}\r\nwrite_sa2400(dev, 4, 0x19341 | firdac);\r\nrtl8180_write_phy(dev, 0, 0x98);\r\nrtl8180_write_phy(dev, 3, 0x38);\r\nrtl8180_write_phy(dev, 4, 0xe0);\r\nrtl8180_write_phy(dev, 5, 0x90);\r\nrtl8180_write_phy(dev, 6, 0x1a);\r\nrtl8180_write_phy(dev, 7, 0x64);\r\nsa2400_write_phy_antenna(dev, 1);\r\nrtl8180_write_phy(dev, 0x11, 0x80);\r\nif (rtl818x_ioread8(priv, &priv->map->CONFIG2) &\r\nRTL818X_CONFIG2_ANTENNA_DIV)\r\nrtl8180_write_phy(dev, 0x12, 0xc7);\r\nelse\r\nrtl8180_write_phy(dev, 0x12, 0x47);\r\nrtl8180_write_phy(dev, 0x13, 0x90 | priv->csthreshold);\r\nrtl8180_write_phy(dev, 0x19, 0x0);\r\nrtl8180_write_phy(dev, 0x1a, 0xa0);\r\n}

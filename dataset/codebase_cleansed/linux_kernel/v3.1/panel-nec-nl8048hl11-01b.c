static int nec_8048_bl_update_status(struct backlight_device *bl)\r\n{\r\nstruct omap_dss_device *dssdev = dev_get_drvdata(&bl->dev);\r\nint level;\r\nif (!dssdev->set_backlight)\r\nreturn -EINVAL;\r\nif (bl->props.fb_blank == FB_BLANK_UNBLANK &&\r\nbl->props.power == FB_BLANK_UNBLANK)\r\nlevel = bl->props.brightness;\r\nelse\r\nlevel = 0;\r\nreturn dssdev->set_backlight(dssdev, level);\r\n}\r\nstatic int nec_8048_bl_get_brightness(struct backlight_device *bl)\r\n{\r\nif (bl->props.fb_blank == FB_BLANK_UNBLANK &&\r\nbl->props.power == FB_BLANK_UNBLANK)\r\nreturn bl->props.brightness;\r\nreturn 0;\r\n}\r\nstatic int nec_8048_panel_probe(struct omap_dss_device *dssdev)\r\n{\r\nstruct backlight_device *bl;\r\nstruct nec_8048_data *necd;\r\nstruct backlight_properties props;\r\nint r;\r\ndssdev->panel.config = OMAP_DSS_LCD_TFT | OMAP_DSS_LCD_IVS |\r\nOMAP_DSS_LCD_IHS | OMAP_DSS_LCD_RF |\r\nOMAP_DSS_LCD_ONOFF;\r\ndssdev->panel.timings = nec_8048_panel_timings;\r\nnecd = kzalloc(sizeof(*necd), GFP_KERNEL);\r\nif (!necd)\r\nreturn -ENOMEM;\r\ndev_set_drvdata(&dssdev->dev, necd);\r\nmemset(&props, 0, sizeof(struct backlight_properties));\r\nprops.max_brightness = 255;\r\nbl = backlight_device_register("nec-8048", &dssdev->dev, dssdev,\r\n&nec_8048_bl_ops, &props);\r\nif (IS_ERR(bl)) {\r\nr = PTR_ERR(bl);\r\nkfree(necd);\r\nreturn r;\r\n}\r\nnecd->bl = bl;\r\nbl->props.fb_blank = FB_BLANK_UNBLANK;\r\nbl->props.power = FB_BLANK_UNBLANK;\r\nbl->props.max_brightness = dssdev->max_backlight_level;\r\nbl->props.brightness = dssdev->max_backlight_level;\r\nr = nec_8048_bl_update_status(bl);\r\nif (r < 0)\r\ndev_err(&dssdev->dev, "failed to set lcd brightness\n");\r\nreturn 0;\r\n}\r\nstatic void nec_8048_panel_remove(struct omap_dss_device *dssdev)\r\n{\r\nstruct nec_8048_data *necd = dev_get_drvdata(&dssdev->dev);\r\nstruct backlight_device *bl = necd->bl;\r\nbl->props.power = FB_BLANK_POWERDOWN;\r\nnec_8048_bl_update_status(bl);\r\nbacklight_device_unregister(bl);\r\nkfree(necd);\r\n}\r\nstatic int nec_8048_panel_enable(struct omap_dss_device *dssdev)\r\n{\r\nint r = 0;\r\nstruct nec_8048_data *necd = dev_get_drvdata(&dssdev->dev);\r\nstruct backlight_device *bl = necd->bl;\r\nif (dssdev->platform_enable) {\r\nr = dssdev->platform_enable(dssdev);\r\nif (r)\r\nreturn r;\r\n}\r\nr = nec_8048_bl_update_status(bl);\r\nif (r < 0)\r\ndev_err(&dssdev->dev, "failed to set lcd brightness\n");\r\nr = omapdss_dpi_display_enable(dssdev);\r\nreturn r;\r\n}\r\nstatic void nec_8048_panel_disable(struct omap_dss_device *dssdev)\r\n{\r\nstruct nec_8048_data *necd = dev_get_drvdata(&dssdev->dev);\r\nstruct backlight_device *bl = necd->bl;\r\nomapdss_dpi_display_disable(dssdev);\r\nbl->props.brightness = 0;\r\nnec_8048_bl_update_status(bl);\r\nif (dssdev->platform_disable)\r\ndssdev->platform_disable(dssdev);\r\n}\r\nstatic int nec_8048_panel_suspend(struct omap_dss_device *dssdev)\r\n{\r\nnec_8048_panel_disable(dssdev);\r\nreturn 0;\r\n}\r\nstatic int nec_8048_panel_resume(struct omap_dss_device *dssdev)\r\n{\r\nreturn nec_8048_panel_enable(dssdev);\r\n}\r\nstatic int nec_8048_recommended_bpp(struct omap_dss_device *dssdev)\r\n{\r\nreturn 16;\r\n}\r\nstatic int nec_8048_spi_send(struct spi_device *spi, unsigned char reg_addr,\r\nunsigned char reg_data)\r\n{\r\nint ret = 0;\r\nunsigned int cmd = 0, data = 0;\r\ncmd = 0x0000 | reg_addr;\r\ndata = 0x0100 | reg_data ;\r\ndata = (cmd << 16) | data;\r\nret = spi_write(spi, (unsigned char *)&data, 4);\r\nif (ret)\r\npr_err("error in spi_write %x\n", data);\r\nreturn ret;\r\n}\r\nstatic int init_nec_8048_wvga_lcd(struct spi_device *spi)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < (ARRAY_SIZE(nec_8048_init_seq) - 1); i++)\r\nnec_8048_spi_send(spi, nec_8048_init_seq[i].addr,\r\nnec_8048_init_seq[i].dat);\r\nudelay(20);\r\nnec_8048_spi_send(spi, nec_8048_init_seq[i].addr,\r\nnec_8048_init_seq[i].dat);\r\nreturn 0;\r\n}\r\nstatic int nec_8048_spi_probe(struct spi_device *spi)\r\n{\r\nspi->mode = SPI_MODE_0;\r\nspi->bits_per_word = 32;\r\nspi_setup(spi);\r\ninit_nec_8048_wvga_lcd(spi);\r\nreturn omap_dss_register_driver(&nec_8048_driver);\r\n}\r\nstatic int nec_8048_spi_remove(struct spi_device *spi)\r\n{\r\nomap_dss_unregister_driver(&nec_8048_driver);\r\nreturn 0;\r\n}\r\nstatic int nec_8048_spi_suspend(struct spi_device *spi, pm_message_t mesg)\r\n{\r\nnec_8048_spi_send(spi, 2, 0x01);\r\nmdelay(40);\r\nreturn 0;\r\n}\r\nstatic int nec_8048_spi_resume(struct spi_device *spi)\r\n{\r\nspi_setup(spi);\r\nnec_8048_spi_send(spi, 2, 0x00);\r\ninit_nec_8048_wvga_lcd(spi);\r\nreturn 0;\r\n}\r\nstatic int __init nec_8048_lcd_init(void)\r\n{\r\nreturn spi_register_driver(&nec_8048_spi_driver);\r\n}\r\nstatic void __exit nec_8048_lcd_exit(void)\r\n{\r\nreturn spi_unregister_driver(&nec_8048_spi_driver);\r\n}

void pci_dma_dev_setup_swiotlb(struct pci_dev *pdev)\r\n{\r\nstruct pci_controller *hose;\r\nstruct dev_archdata *sd;\r\nhose = pci_bus_to_host(pdev->bus);\r\nsd = &pdev->dev.archdata;\r\nsd->max_direct_dma_addr =\r\nhose->dma_window_base_cur + hose->dma_window_size;\r\n}\r\nstatic int ppc_swiotlb_bus_notify(struct notifier_block *nb,\r\nunsigned long action, void *data)\r\n{\r\nstruct device *dev = data;\r\nstruct dev_archdata *sd;\r\nif (action != BUS_NOTIFY_ADD_DEVICE)\r\nreturn 0;\r\nsd = &dev->archdata;\r\nsd->max_direct_dma_addr = 0;\r\nif ((dma_get_mask(dev) + 1) < memblock_end_of_DRAM())\r\nset_dma_ops(dev, &swiotlb_dma_ops);\r\nreturn NOTIFY_DONE;\r\n}\r\nint __init swiotlb_setup_bus_notifier(void)\r\n{\r\nbus_register_notifier(&platform_bus_type,\r\n&ppc_swiotlb_plat_bus_notifier);\r\nreturn 0;\r\n}

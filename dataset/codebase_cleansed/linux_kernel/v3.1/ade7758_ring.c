static int ade7758_spi_read_burst(struct device *dev)\r\n{\r\nstruct iio_dev *indio_dev = dev_get_drvdata(dev);\r\nstruct ade7758_state *st = iio_priv(indio_dev);\r\nint ret;\r\nret = spi_sync(st->us, &st->ring_msg);\r\nif (ret)\r\ndev_err(&st->us->dev, "problem when reading WFORM value\n");\r\nreturn ret;\r\n}\r\nstatic int ade7758_write_waveform_type(struct device *dev, unsigned type)\r\n{\r\nint ret;\r\nu8 reg;\r\nret = ade7758_spi_read_reg_8(dev,\r\nADE7758_WAVMODE,\r\n&reg);\r\nif (ret)\r\ngoto out;\r\nreg &= ~0x1F;\r\nreg |= type & 0x1F;\r\nret = ade7758_spi_write_reg_8(dev,\r\nADE7758_WAVMODE,\r\nreg);\r\nout:\r\nreturn ret;\r\n}\r\nstatic irqreturn_t ade7758_trigger_handler(int irq, void *p)\r\n{\r\nstruct iio_poll_func *pf = p;\r\nstruct iio_dev *indio_dev = pf->private_data;\r\nstruct iio_ring_buffer *ring = indio_dev->ring;\r\nstruct ade7758_state *st = iio_priv(indio_dev);\r\ns64 dat64[2];\r\nu32 *dat32 = (u32 *)dat64;\r\nif (ring->scan_count)\r\nif (ade7758_spi_read_burst(&indio_dev->dev) >= 0)\r\n*dat32 = get_unaligned_be32(&st->rx_buf[5]) & 0xFFFFFF;\r\nif (ring->scan_timestamp)\r\ndat64[1] = pf->timestamp;\r\nring->access->store_to(ring, (u8 *)dat64, pf->timestamp);\r\niio_trigger_notify_done(indio_dev->trig);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int ade7758_ring_preenable(struct iio_dev *indio_dev)\r\n{\r\nstruct ade7758_state *st = iio_priv(indio_dev);\r\nstruct iio_ring_buffer *ring = indio_dev->ring;\r\nsize_t d_size;\r\nunsigned channel;\r\nif (!ring->scan_count)\r\nreturn -EINVAL;\r\nchannel = __ffs(ring->scan_mask);\r\nd_size = st->ade7758_ring_channels[channel].scan_type.storagebits / 8;\r\nif (ring->scan_timestamp) {\r\nd_size += sizeof(s64);\r\nif (d_size % sizeof(s64))\r\nd_size += sizeof(s64) - (d_size % sizeof(s64));\r\n}\r\nif (indio_dev->ring->access->set_bytes_per_datum)\r\nindio_dev->ring->access->set_bytes_per_datum(indio_dev->ring,\r\nd_size);\r\nade7758_write_waveform_type(&indio_dev->dev,\r\nst->ade7758_ring_channels[channel].address);\r\nreturn 0;\r\n}\r\nvoid ade7758_unconfigure_ring(struct iio_dev *indio_dev)\r\n{\r\nif (indio_dev->trig) {\r\niio_put_trigger(indio_dev->trig);\r\niio_trigger_dettach_poll_func(indio_dev->trig,\r\nindio_dev->pollfunc);\r\n}\r\niio_dealloc_pollfunc(indio_dev->pollfunc);\r\niio_sw_rb_free(indio_dev->ring);\r\n}\r\nint ade7758_configure_ring(struct iio_dev *indio_dev)\r\n{\r\nstruct ade7758_state *st = iio_priv(indio_dev);\r\nint ret = 0;\r\nindio_dev->ring = iio_sw_rb_allocate(indio_dev);\r\nif (!indio_dev->ring) {\r\nret = -ENOMEM;\r\nreturn ret;\r\n}\r\nindio_dev->ring->access = &ring_sw_access_funcs;\r\nindio_dev->ring->setup_ops = &ade7758_ring_setup_ops;\r\nindio_dev->ring->owner = THIS_MODULE;\r\nindio_dev->pollfunc = iio_alloc_pollfunc(&iio_pollfunc_store_time,\r\n&ade7758_trigger_handler,\r\n0,\r\nindio_dev,\r\n"ade7759_consumer%d",\r\nindio_dev->id);\r\nif (indio_dev->pollfunc == NULL) {\r\nret = -ENOMEM;\r\ngoto error_iio_sw_rb_free;\r\n}\r\nindio_dev->modes |= INDIO_RING_TRIGGERED;\r\nst->tx_buf[0] = ADE7758_READ_REG(ADE7758_RSTATUS);\r\nst->tx_buf[1] = 0;\r\nst->tx_buf[2] = 0;\r\nst->tx_buf[3] = 0;\r\nst->tx_buf[4] = ADE7758_READ_REG(ADE7758_WFORM);\r\nst->tx_buf[5] = 0;\r\nst->tx_buf[6] = 0;\r\nst->tx_buf[7] = 0;\r\nst->ring_xfer[0].tx_buf = &st->tx_buf[0];\r\nst->ring_xfer[0].len = 1;\r\nst->ring_xfer[0].bits_per_word = 8;\r\nst->ring_xfer[0].delay_usecs = 4;\r\nst->ring_xfer[1].rx_buf = &st->rx_buf[1];\r\nst->ring_xfer[1].len = 3;\r\nst->ring_xfer[1].bits_per_word = 8;\r\nst->ring_xfer[1].cs_change = 1;\r\nst->ring_xfer[2].tx_buf = &st->tx_buf[4];\r\nst->ring_xfer[2].len = 1;\r\nst->ring_xfer[2].bits_per_word = 8;\r\nst->ring_xfer[2].delay_usecs = 1;\r\nst->ring_xfer[3].rx_buf = &st->rx_buf[5];\r\nst->ring_xfer[3].len = 3;\r\nst->ring_xfer[3].bits_per_word = 8;\r\nspi_message_init(&st->ring_msg);\r\nspi_message_add_tail(&st->ring_xfer[0], &st->ring_msg);\r\nspi_message_add_tail(&st->ring_xfer[1], &st->ring_msg);\r\nspi_message_add_tail(&st->ring_xfer[2], &st->ring_msg);\r\nspi_message_add_tail(&st->ring_xfer[3], &st->ring_msg);\r\nreturn 0;\r\nerror_iio_sw_rb_free:\r\niio_sw_rb_free(indio_dev->ring);\r\nreturn ret;\r\n}\r\nvoid ade7758_uninitialize_ring(struct iio_ring_buffer *ring)\r\n{\r\niio_ring_buffer_unregister(ring);\r\n}

struct prom_pmemblock * __init prom_getmdesc(void)\r\n{\r\nunsigned int memsize;\r\nmemsize = 0x02000000;\r\npr_info("Setting default memory size 0x%08x\n", memsize);\r\nmemset(mdesc, 0, sizeof(mdesc));\r\nmdesc[0].type = simmem_reserved;\r\nmdesc[0].base = 0x00000000;\r\nmdesc[0].size = 0x00001000;\r\nmdesc[1].type = simmem_free;\r\nmdesc[1].base = 0x00001000;\r\nmdesc[1].size = 0x000ff000;\r\nmdesc[2].type = simmem_reserved;\r\nmdesc[2].base = 0x00100000;\r\nmdesc[2].size = CPHYSADDR(PFN_ALIGN(&_end)) - mdesc[2].base;\r\nmdesc[3].type = simmem_free;\r\nmdesc[3].base = CPHYSADDR(PFN_ALIGN(&_end));\r\nmdesc[3].size = memsize - mdesc[3].base;\r\nreturn &mdesc[0];\r\n}\r\nstatic int __init prom_memtype_classify(unsigned int type)\r\n{\r\nswitch (type) {\r\ncase simmem_free:\r\nreturn BOOT_MEM_RAM;\r\ncase simmem_reserved:\r\ndefault:\r\nreturn BOOT_MEM_RESERVED;\r\n}\r\n}\r\nvoid __init prom_meminit(void)\r\n{\r\nstruct prom_pmemblock *p;\r\np = prom_getmdesc();\r\nwhile (p->size) {\r\nlong type;\r\nunsigned long base, size;\r\ntype = prom_memtype_classify(p->type);\r\nbase = p->base;\r\nsize = p->size;\r\nadd_memory_region(base, size, type);\r\np++;\r\n}\r\n}\r\nvoid __init prom_free_prom_memory(void)\r\n{\r\nint i;\r\nunsigned long addr;\r\nfor (i = 0; i < boot_mem_map.nr_map; i++) {\r\nif (boot_mem_map.map[i].type != BOOT_MEM_ROM_DATA)\r\ncontinue;\r\naddr = boot_mem_map.map[i].addr;\r\nfree_init_pages("prom memory",\r\naddr, addr + boot_mem_map.map[i].size);\r\n}\r\n}

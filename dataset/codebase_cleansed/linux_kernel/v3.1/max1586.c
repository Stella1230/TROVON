static int max1586_v3_calc_voltage(struct max1586_data *max1586,\r\nunsigned selector)\r\n{\r\nunsigned range_uV = max1586->max_uV - max1586->min_uV;\r\nreturn max1586->min_uV + (selector * range_uV / MAX1586_V3_MAX_VSEL);\r\n}\r\nstatic int max1586_v3_set(struct regulator_dev *rdev, int min_uV, int max_uV,\r\nunsigned *selector)\r\n{\r\nstruct max1586_data *max1586 = rdev_get_drvdata(rdev);\r\nstruct i2c_client *client = max1586->client;\r\nunsigned range_uV = max1586->max_uV - max1586->min_uV;\r\nu8 v3_prog;\r\nif (min_uV > max1586->max_uV || max_uV < max1586->min_uV)\r\nreturn -EINVAL;\r\nif (min_uV < max1586->min_uV)\r\nmin_uV = max1586->min_uV;\r\n*selector = ((min_uV - max1586->min_uV) * MAX1586_V3_MAX_VSEL +\r\nrange_uV - 1) / range_uV;\r\nif (max1586_v3_calc_voltage(max1586, *selector) > max_uV)\r\nreturn -EINVAL;\r\ndev_dbg(&client->dev, "changing voltage v3 to %dmv\n",\r\nmax1586_v3_calc_voltage(max1586, *selector) / 1000);\r\nv3_prog = I2C_V3_SELECT | (u8) *selector;\r\nreturn i2c_smbus_write_byte(client, v3_prog);\r\n}\r\nstatic int max1586_v3_list(struct regulator_dev *rdev, unsigned selector)\r\n{\r\nstruct max1586_data *max1586 = rdev_get_drvdata(rdev);\r\nif (selector > MAX1586_V3_MAX_VSEL)\r\nreturn -EINVAL;\r\nreturn max1586_v3_calc_voltage(max1586, selector);\r\n}\r\nstatic int max1586_v6_calc_voltage(unsigned selector)\r\n{\r\nstatic int voltages_uv[] = { 1, 1800000, 2500000, 3000000 };\r\nreturn voltages_uv[selector];\r\n}\r\nstatic int max1586_v6_set(struct regulator_dev *rdev, int min_uV, int max_uV,\r\nunsigned int *selector)\r\n{\r\nstruct i2c_client *client = rdev_get_drvdata(rdev);\r\nu8 v6_prog;\r\nif (min_uV < MAX1586_V6_MIN_UV || min_uV > MAX1586_V6_MAX_UV)\r\nreturn -EINVAL;\r\nif (max_uV < MAX1586_V6_MIN_UV || max_uV > MAX1586_V6_MAX_UV)\r\nreturn -EINVAL;\r\nif (min_uV < 1800000)\r\n*selector = 0;\r\nelse if (min_uV < 2500000)\r\n*selector = 1;\r\nelse if (min_uV < 3000000)\r\n*selector = 2;\r\nelse if (min_uV >= 3000000)\r\n*selector = 3;\r\nif (max1586_v6_calc_voltage(*selector) > max_uV)\r\nreturn -EINVAL;\r\ndev_dbg(&client->dev, "changing voltage v6 to %dmv\n",\r\nmax1586_v6_calc_voltage(*selector) / 1000);\r\nv6_prog = I2C_V6_SELECT | (u8) *selector;\r\nreturn i2c_smbus_write_byte(client, v6_prog);\r\n}\r\nstatic int max1586_v6_list(struct regulator_dev *rdev, unsigned selector)\r\n{\r\nif (selector > MAX1586_V6_MAX_VSEL)\r\nreturn -EINVAL;\r\nreturn max1586_v6_calc_voltage(selector);\r\n}\r\nstatic int __devinit max1586_pmic_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *i2c_id)\r\n{\r\nstruct regulator_dev **rdev;\r\nstruct max1586_platform_data *pdata = client->dev.platform_data;\r\nstruct max1586_data *max1586;\r\nint i, id, ret = -ENOMEM;\r\nmax1586 = kzalloc(sizeof(struct max1586_data) +\r\nsizeof(struct regulator_dev *) * (MAX1586_V6 + 1),\r\nGFP_KERNEL);\r\nif (!max1586)\r\ngoto out;\r\nmax1586->client = client;\r\nif (!pdata->v3_gain) {\r\nret = -EINVAL;\r\ngoto out_unmap;\r\n}\r\nmax1586->min_uV = MAX1586_V3_MIN_UV / 1000 * pdata->v3_gain / 1000;\r\nmax1586->max_uV = MAX1586_V3_MAX_UV / 1000 * pdata->v3_gain / 1000;\r\nrdev = max1586->rdev;\r\nfor (i = 0; i < pdata->num_subdevs && i <= MAX1586_V6; i++) {\r\nid = pdata->subdevs[i].id;\r\nif (!pdata->subdevs[i].platform_data)\r\ncontinue;\r\nif (id < MAX1586_V3 || id > MAX1586_V6) {\r\ndev_err(&client->dev, "invalid regulator id %d\n", id);\r\ngoto err;\r\n}\r\nrdev[i] = regulator_register(&max1586_reg[id], &client->dev,\r\npdata->subdevs[i].platform_data,\r\nmax1586);\r\nif (IS_ERR(rdev[i])) {\r\nret = PTR_ERR(rdev[i]);\r\ndev_err(&client->dev, "failed to register %s\n",\r\nmax1586_reg[id].name);\r\ngoto err;\r\n}\r\n}\r\ni2c_set_clientdata(client, max1586);\r\ndev_info(&client->dev, "Maxim 1586 regulator driver loaded\n");\r\nreturn 0;\r\nerr:\r\nwhile (--i >= 0)\r\nregulator_unregister(rdev[i]);\r\nout_unmap:\r\nkfree(max1586);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int __devexit max1586_pmic_remove(struct i2c_client *client)\r\n{\r\nstruct max1586_data *max1586 = i2c_get_clientdata(client);\r\nint i;\r\nfor (i = 0; i <= MAX1586_V6; i++)\r\nif (max1586->rdev[i])\r\nregulator_unregister(max1586->rdev[i]);\r\nkfree(max1586);\r\nreturn 0;\r\n}\r\nstatic int __init max1586_pmic_init(void)\r\n{\r\nreturn i2c_add_driver(&max1586_pmic_driver);\r\n}\r\nstatic void __exit max1586_pmic_exit(void)\r\n{\r\ni2c_del_driver(&max1586_pmic_driver);\r\n}

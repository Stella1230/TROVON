static int\r\ni2c_algo_dp_aux_transaction(struct i2c_adapter *adapter, int mode,\r\nuint8_t write_byte, uint8_t *read_byte)\r\n{\r\nstruct i2c_algo_dp_aux_data *algo_data = adapter->algo_data;\r\nint ret;\r\nret = (*algo_data->aux_ch)(adapter, mode,\r\nwrite_byte, read_byte);\r\nreturn ret;\r\n}\r\nstatic int\r\ni2c_algo_dp_aux_address(struct i2c_adapter *adapter, u16 address, bool reading)\r\n{\r\nstruct i2c_algo_dp_aux_data *algo_data = adapter->algo_data;\r\nint mode = MODE_I2C_START;\r\nint ret;\r\nif (reading)\r\nmode |= MODE_I2C_READ;\r\nelse\r\nmode |= MODE_I2C_WRITE;\r\nalgo_data->address = address;\r\nalgo_data->running = true;\r\nret = i2c_algo_dp_aux_transaction(adapter, mode, 0, NULL);\r\nreturn ret;\r\n}\r\nstatic void\r\ni2c_algo_dp_aux_stop(struct i2c_adapter *adapter, bool reading)\r\n{\r\nstruct i2c_algo_dp_aux_data *algo_data = adapter->algo_data;\r\nint mode = MODE_I2C_STOP;\r\nif (reading)\r\nmode |= MODE_I2C_READ;\r\nelse\r\nmode |= MODE_I2C_WRITE;\r\nif (algo_data->running) {\r\n(void) i2c_algo_dp_aux_transaction(adapter, mode, 0, NULL);\r\nalgo_data->running = false;\r\n}\r\n}\r\nstatic int\r\ni2c_algo_dp_aux_put_byte(struct i2c_adapter *adapter, u8 byte)\r\n{\r\nstruct i2c_algo_dp_aux_data *algo_data = adapter->algo_data;\r\nint ret;\r\nif (!algo_data->running)\r\nreturn -EIO;\r\nret = i2c_algo_dp_aux_transaction(adapter, MODE_I2C_WRITE, byte, NULL);\r\nreturn ret;\r\n}\r\nstatic int\r\ni2c_algo_dp_aux_get_byte(struct i2c_adapter *adapter, u8 *byte_ret)\r\n{\r\nstruct i2c_algo_dp_aux_data *algo_data = adapter->algo_data;\r\nint ret;\r\nif (!algo_data->running)\r\nreturn -EIO;\r\nret = i2c_algo_dp_aux_transaction(adapter, MODE_I2C_READ, 0, byte_ret);\r\nreturn ret;\r\n}\r\nstatic int\r\ni2c_algo_dp_aux_xfer(struct i2c_adapter *adapter,\r\nstruct i2c_msg *msgs,\r\nint num)\r\n{\r\nint ret = 0;\r\nbool reading = false;\r\nint m;\r\nint b;\r\nfor (m = 0; m < num; m++) {\r\nu16 len = msgs[m].len;\r\nu8 *buf = msgs[m].buf;\r\nreading = (msgs[m].flags & I2C_M_RD) != 0;\r\nret = i2c_algo_dp_aux_address(adapter, msgs[m].addr, reading);\r\nif (ret < 0)\r\nbreak;\r\nif (reading) {\r\nfor (b = 0; b < len; b++) {\r\nret = i2c_algo_dp_aux_get_byte(adapter, &buf[b]);\r\nif (ret < 0)\r\nbreak;\r\n}\r\n} else {\r\nfor (b = 0; b < len; b++) {\r\nret = i2c_algo_dp_aux_put_byte(adapter, buf[b]);\r\nif (ret < 0)\r\nbreak;\r\n}\r\n}\r\nif (ret < 0)\r\nbreak;\r\n}\r\nif (ret >= 0)\r\nret = num;\r\ni2c_algo_dp_aux_stop(adapter, reading);\r\nDRM_DEBUG_KMS("dp_aux_xfer return %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic u32\r\ni2c_algo_dp_aux_functionality(struct i2c_adapter *adapter)\r\n{\r\nreturn I2C_FUNC_I2C | I2C_FUNC_SMBUS_EMUL |\r\nI2C_FUNC_SMBUS_READ_BLOCK_DATA |\r\nI2C_FUNC_SMBUS_BLOCK_PROC_CALL |\r\nI2C_FUNC_10BIT_ADDR;\r\n}\r\nstatic void\r\ni2c_dp_aux_reset_bus(struct i2c_adapter *adapter)\r\n{\r\n(void) i2c_algo_dp_aux_address(adapter, 0, false);\r\n(void) i2c_algo_dp_aux_stop(adapter, false);\r\n}\r\nstatic int\r\ni2c_dp_aux_prepare_bus(struct i2c_adapter *adapter)\r\n{\r\nadapter->algo = &i2c_dp_aux_algo;\r\nadapter->retries = 3;\r\ni2c_dp_aux_reset_bus(adapter);\r\nreturn 0;\r\n}\r\nint\r\ni2c_dp_aux_add_bus(struct i2c_adapter *adapter)\r\n{\r\nint error;\r\nerror = i2c_dp_aux_prepare_bus(adapter);\r\nif (error)\r\nreturn error;\r\nerror = i2c_add_adapter(adapter);\r\nreturn error;\r\n}

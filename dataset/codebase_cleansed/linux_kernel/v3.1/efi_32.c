void efi_call_phys_prelog(void)\r\n{\r\nunsigned long cr4;\r\nunsigned long temp;\r\nstruct desc_ptr gdt_descr;\r\nlocal_irq_save(efi_rt_eflags);\r\ncr4 = read_cr4_safe();\r\nif (cr4 & X86_CR4_PAE) {\r\nefi_bak_pg_dir_pointer[0].pgd =\r\nswapper_pg_dir[pgd_index(0)].pgd;\r\nswapper_pg_dir[0].pgd =\r\nswapper_pg_dir[pgd_index(PAGE_OFFSET)].pgd;\r\n} else {\r\nefi_bak_pg_dir_pointer[0].pgd =\r\nswapper_pg_dir[pgd_index(0)].pgd;\r\nefi_bak_pg_dir_pointer[1].pgd =\r\nswapper_pg_dir[pgd_index(0x400000)].pgd;\r\nswapper_pg_dir[pgd_index(0)].pgd =\r\nswapper_pg_dir[pgd_index(PAGE_OFFSET)].pgd;\r\ntemp = PAGE_OFFSET + 0x400000;\r\nswapper_pg_dir[pgd_index(0x400000)].pgd =\r\nswapper_pg_dir[pgd_index(temp)].pgd;\r\n}\r\n__flush_tlb_all();\r\ngdt_descr.address = __pa(get_cpu_gdt_table(0));\r\ngdt_descr.size = GDT_SIZE - 1;\r\nload_gdt(&gdt_descr);\r\n}\r\nvoid efi_call_phys_epilog(void)\r\n{\r\nunsigned long cr4;\r\nstruct desc_ptr gdt_descr;\r\ngdt_descr.address = (unsigned long)get_cpu_gdt_table(0);\r\ngdt_descr.size = GDT_SIZE - 1;\r\nload_gdt(&gdt_descr);\r\ncr4 = read_cr4_safe();\r\nif (cr4 & X86_CR4_PAE) {\r\nswapper_pg_dir[pgd_index(0)].pgd =\r\nefi_bak_pg_dir_pointer[0].pgd;\r\n} else {\r\nswapper_pg_dir[pgd_index(0)].pgd =\r\nefi_bak_pg_dir_pointer[0].pgd;\r\nswapper_pg_dir[pgd_index(0x400000)].pgd =\r\nefi_bak_pg_dir_pointer[1].pgd;\r\n}\r\n__flush_tlb_all();\r\nlocal_irq_restore(efi_rt_eflags);\r\n}

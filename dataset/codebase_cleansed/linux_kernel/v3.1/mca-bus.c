static int mca_bus_match (struct device *dev, struct device_driver *drv)\r\n{\r\nstruct mca_device *mca_dev = to_mca_device (dev);\r\nstruct mca_driver *mca_drv = to_mca_driver (drv);\r\nconst unsigned short *mca_ids = mca_drv->id_table;\r\nint i = 0;\r\nif (mca_ids) {\r\nfor(i = 0; mca_ids[i]; i++) {\r\nif (mca_ids[i] == mca_dev->pos_id) {\r\nmca_dev->index = i;\r\nreturn 1;\r\n}\r\n}\r\n}\r\nif (mca_drv->integrated_id && mca_dev->pos_id ==\r\nmca_drv->integrated_id) {\r\nmca_dev->index = i;\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic ssize_t mca_show_pos_id(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nstruct mca_device *mca_dev = to_mca_device(dev);\r\nint len;\r\nif(mca_dev->pos_id < MCA_DUMMY_POS_START)\r\nlen = sprintf(buf, "%04x\n", mca_dev->pos_id);\r\nelse\r\nlen = sprintf(buf, "none\n");\r\nreturn len;\r\n}\r\nstatic ssize_t mca_show_pos(struct device *dev, struct device_attribute *attr, char *buf)\r\n{\r\nint j, len=0;\r\nstruct mca_device *mca_dev = to_mca_device(dev);\r\nfor(j=0; j<8; j++)\r\nlen += sprintf(buf+len, "%02x ", mca_dev->pos[j]);\r\nbuf[len-1] = '\n';\r\nreturn len;\r\n}\r\nint __init mca_register_device(int bus, struct mca_device *mca_dev)\r\n{\r\nstruct mca_bus *mca_bus = mca_root_busses[bus];\r\nint rc;\r\nmca_dev->dev.parent = &mca_bus->dev;\r\nmca_dev->dev.bus = &mca_bus_type;\r\ndev_set_name(&mca_dev->dev, "%02d:%02X", bus, mca_dev->slot);\r\nmca_dev->dma_mask = mca_bus->default_dma_mask;\r\nmca_dev->dev.dma_mask = &mca_dev->dma_mask;\r\nmca_dev->dev.coherent_dma_mask = mca_dev->dma_mask;\r\nrc = device_register(&mca_dev->dev);\r\nif (rc)\r\ngoto err_out;\r\nrc = device_create_file(&mca_dev->dev, &dev_attr_id);\r\nif (rc) goto err_out_devreg;\r\nrc = device_create_file(&mca_dev->dev, &dev_attr_pos);\r\nif (rc) goto err_out_id;\r\nreturn 1;\r\nerr_out_id:\r\ndevice_remove_file(&mca_dev->dev, &dev_attr_id);\r\nerr_out_devreg:\r\ndevice_unregister(&mca_dev->dev);\r\nerr_out:\r\nreturn 0;\r\n}\r\nstruct mca_bus * __devinit mca_attach_bus(int bus)\r\n{\r\nstruct mca_bus *mca_bus;\r\nif (unlikely(mca_root_busses[bus] != NULL)) {\r\nprintk(KERN_EMERG "MCA tried to add already existing bus %d\n",\r\nbus);\r\ndump_stack();\r\nreturn NULL;\r\n}\r\nmca_bus = kzalloc(sizeof(struct mca_bus), GFP_KERNEL);\r\nif (!mca_bus)\r\nreturn NULL;\r\ndev_set_name(&mca_bus->dev, "mca%d", bus);\r\nsprintf(mca_bus->name,"Host %s MCA Bridge", bus ? "Secondary" : "Primary");\r\nif (device_register(&mca_bus->dev)) {\r\nkfree(mca_bus);\r\nreturn NULL;\r\n}\r\nmca_root_busses[bus] = mca_bus;\r\nreturn mca_bus;\r\n}\r\nint __init mca_system_init (void)\r\n{\r\nreturn bus_register(&mca_bus_type);\r\n}

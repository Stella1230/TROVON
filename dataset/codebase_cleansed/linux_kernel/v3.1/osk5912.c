static int osk_startup(struct snd_pcm_substream *substream)\r\n{\r\nreturn clk_enable(tlv320aic23_mclk);\r\n}\r\nstatic void osk_shutdown(struct snd_pcm_substream *substream)\r\n{\r\nclk_disable(tlv320aic23_mclk);\r\n}\r\nstatic int osk_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nint err;\r\nerr = snd_soc_dai_set_fmt(codec_dai,\r\nSND_SOC_DAIFMT_DSP_B |\r\nSND_SOC_DAIFMT_NB_NF |\r\nSND_SOC_DAIFMT_CBM_CFM);\r\nif (err < 0) {\r\nprintk(KERN_ERR "can't set codec DAI configuration\n");\r\nreturn err;\r\n}\r\nerr = snd_soc_dai_set_fmt(cpu_dai,\r\nSND_SOC_DAIFMT_DSP_B |\r\nSND_SOC_DAIFMT_NB_NF |\r\nSND_SOC_DAIFMT_CBM_CFM);\r\nif (err < 0) {\r\nprintk(KERN_ERR "can't set cpu DAI configuration\n");\r\nreturn err;\r\n}\r\nerr =\r\nsnd_soc_dai_set_sysclk(codec_dai, 0, CODEC_CLOCK, SND_SOC_CLOCK_IN);\r\nif (err < 0) {\r\nprintk(KERN_ERR "can't set codec system clock\n");\r\nreturn err;\r\n}\r\nreturn err;\r\n}\r\nstatic int osk_tlv320aic23_init(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct snd_soc_codec *codec = rtd->codec;\r\nstruct snd_soc_dapm_context *dapm = &codec->dapm;\r\nsnd_soc_dapm_new_controls(dapm, tlv320aic23_dapm_widgets,\r\nARRAY_SIZE(tlv320aic23_dapm_widgets));\r\nsnd_soc_dapm_add_routes(dapm, audio_map, ARRAY_SIZE(audio_map));\r\nsnd_soc_dapm_enable_pin(dapm, "Headphone Jack");\r\nsnd_soc_dapm_enable_pin(dapm, "Line In");\r\nsnd_soc_dapm_enable_pin(dapm, "Mic Jack");\r\nsnd_soc_dapm_sync(dapm);\r\nreturn 0;\r\n}\r\nstatic int __init osk_soc_init(void)\r\n{\r\nint err;\r\nu32 curRate;\r\nstruct device *dev;\r\nif (!(machine_is_omap_osk()))\r\nreturn -ENODEV;\r\nosk_snd_device = platform_device_alloc("soc-audio", -1);\r\nif (!osk_snd_device)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(osk_snd_device, &snd_soc_card_osk);\r\nerr = platform_device_add(osk_snd_device);\r\nif (err)\r\ngoto err1;\r\ndev = &osk_snd_device->dev;\r\ntlv320aic23_mclk = clk_get(dev, "mclk");\r\nif (IS_ERR(tlv320aic23_mclk)) {\r\nprintk(KERN_ERR "Could not get mclk clock\n");\r\nerr = PTR_ERR(tlv320aic23_mclk);\r\ngoto err2;\r\n}\r\ncurRate = (uint) clk_get_rate(tlv320aic23_mclk);\r\nif (curRate != CODEC_CLOCK) {\r\nif (clk_set_rate(tlv320aic23_mclk, CODEC_CLOCK)) {\r\nprintk(KERN_ERR "Cannot set MCLK for AIC23 CODEC\n");\r\nerr = -ECANCELED;\r\ngoto err3;\r\n}\r\n}\r\nprintk(KERN_INFO "MCLK = %d [%d]\n",\r\n(uint) clk_get_rate(tlv320aic23_mclk), CODEC_CLOCK);\r\nreturn 0;\r\nerr3:\r\nclk_put(tlv320aic23_mclk);\r\nerr2:\r\nplatform_device_del(osk_snd_device);\r\nerr1:\r\nplatform_device_put(osk_snd_device);\r\nreturn err;\r\n}\r\nstatic void __exit osk_soc_exit(void)\r\n{\r\nclk_put(tlv320aic23_mclk);\r\nplatform_device_unregister(osk_snd_device);\r\n}

static void cs5530_set_dclk_frequency(struct fb_info *info)\r\n{\r\nstruct geodefb_par *par = info->par;\r\nint i;\r\nu32 value;\r\nlong min, diff;\r\nvalue = cs5530_pll_table[0].pll_value;\r\nmin = cs5530_pll_table[0].pixclock - info->var.pixclock;\r\nif (min < 0) min = -min;\r\nfor (i = 1; i < ARRAY_SIZE(cs5530_pll_table); i++) {\r\ndiff = cs5530_pll_table[i].pixclock - info->var.pixclock;\r\nif (diff < 0L) diff = -diff;\r\nif (diff < min) {\r\nmin = diff;\r\nvalue = cs5530_pll_table[i].pll_value;\r\n}\r\n}\r\nwritel(value, par->vid_regs + CS5530_DOT_CLK_CONFIG);\r\nwritel(value | 0x80000100, par->vid_regs + CS5530_DOT_CLK_CONFIG);\r\nudelay(500);\r\nwritel(value & 0x7FFFFFFF, par->vid_regs + CS5530_DOT_CLK_CONFIG);\r\nwritel(value & 0x7FFFFEFF, par->vid_regs + CS5530_DOT_CLK_CONFIG);\r\n}\r\nstatic void cs5530_configure_display(struct fb_info *info)\r\n{\r\nstruct geodefb_par *par = info->par;\r\nu32 dcfg;\r\ndcfg = readl(par->vid_regs + CS5530_DISPLAY_CONFIG);\r\ndcfg &= ~(CS5530_DCFG_CRT_SYNC_SKW_MASK | CS5530_DCFG_PWR_SEQ_DLY_MASK\r\n| CS5530_DCFG_CRT_HSYNC_POL | CS5530_DCFG_CRT_VSYNC_POL\r\n| CS5530_DCFG_FP_PWR_EN | CS5530_DCFG_FP_DATA_EN\r\n| CS5530_DCFG_DAC_PWR_EN | CS5530_DCFG_VSYNC_EN\r\n| CS5530_DCFG_HSYNC_EN);\r\ndcfg |= (CS5530_DCFG_CRT_SYNC_SKW_INIT | CS5530_DCFG_PWR_SEQ_DLY_INIT\r\n| CS5530_DCFG_GV_PAL_BYP);\r\nif (par->enable_crt) {\r\ndcfg |= CS5530_DCFG_DAC_PWR_EN;\r\ndcfg |= CS5530_DCFG_HSYNC_EN | CS5530_DCFG_VSYNC_EN;\r\n}\r\nif (par->panel_x > 0) {\r\ndcfg |= CS5530_DCFG_FP_PWR_EN;\r\ndcfg |= CS5530_DCFG_FP_DATA_EN;\r\n}\r\nif (info->var.sync & FB_SYNC_HOR_HIGH_ACT)\r\ndcfg |= CS5530_DCFG_CRT_HSYNC_POL;\r\nif (info->var.sync & FB_SYNC_VERT_HIGH_ACT)\r\ndcfg |= CS5530_DCFG_CRT_VSYNC_POL;\r\nwritel(dcfg, par->vid_regs + CS5530_DISPLAY_CONFIG);\r\n}\r\nstatic int cs5530_blank_display(struct fb_info *info, int blank_mode)\r\n{\r\nstruct geodefb_par *par = info->par;\r\nu32 dcfg;\r\nint blank, hsync, vsync;\r\nswitch (blank_mode) {\r\ncase FB_BLANK_UNBLANK:\r\nblank = 0; hsync = 1; vsync = 1;\r\nbreak;\r\ncase FB_BLANK_NORMAL:\r\nblank = 1; hsync = 1; vsync = 1;\r\nbreak;\r\ncase FB_BLANK_VSYNC_SUSPEND:\r\nblank = 1; hsync = 1; vsync = 0;\r\nbreak;\r\ncase FB_BLANK_HSYNC_SUSPEND:\r\nblank = 1; hsync = 0; vsync = 1;\r\nbreak;\r\ncase FB_BLANK_POWERDOWN:\r\nblank = 1; hsync = 0; vsync = 0;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ndcfg = readl(par->vid_regs + CS5530_DISPLAY_CONFIG);\r\ndcfg &= ~(CS5530_DCFG_DAC_BL_EN | CS5530_DCFG_DAC_PWR_EN\r\n| CS5530_DCFG_HSYNC_EN | CS5530_DCFG_VSYNC_EN\r\n| CS5530_DCFG_FP_DATA_EN | CS5530_DCFG_FP_PWR_EN);\r\nif (par->enable_crt) {\r\nif (!blank)\r\ndcfg |= CS5530_DCFG_DAC_BL_EN | CS5530_DCFG_DAC_PWR_EN;\r\nif (hsync)\r\ndcfg |= CS5530_DCFG_HSYNC_EN;\r\nif (vsync)\r\ndcfg |= CS5530_DCFG_VSYNC_EN;\r\n}\r\nif (par->panel_x > 0) {\r\nif (!blank)\r\ndcfg |= CS5530_DCFG_FP_DATA_EN;\r\nif (hsync && vsync)\r\ndcfg |= CS5530_DCFG_FP_PWR_EN;\r\n}\r\nwritel(dcfg, par->vid_regs + CS5530_DISPLAY_CONFIG);\r\nreturn 0;\r\n}

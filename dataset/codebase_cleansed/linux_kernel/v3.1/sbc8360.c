static void sbc8360_activate(void)\r\n{\r\noutb(0x0A, SBC8360_ENABLE);\r\nmsleep_interruptible(100);\r\noutb(0x0B, SBC8360_ENABLE);\r\nmsleep_interruptible(100);\r\noutb(wd_multiplier, SBC8360_ENABLE);\r\nmsleep_interruptible(100);\r\n}\r\nstatic void sbc8360_ping(void)\r\n{\r\noutb(wd_margin, SBC8360_BASETIME);\r\n}\r\nstatic void sbc8360_stop(void)\r\n{\r\noutb(0, SBC8360_ENABLE);\r\n}\r\nstatic ssize_t sbc8360_write(struct file *file, const char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nif (count) {\r\nif (!nowayout) {\r\nsize_t i;\r\nexpect_close = 0;\r\nfor (i = 0; i != count; i++) {\r\nchar c;\r\nif (get_user(c, buf + i))\r\nreturn -EFAULT;\r\nif (c == 'V')\r\nexpect_close = 42;\r\n}\r\n}\r\nsbc8360_ping();\r\n}\r\nreturn count;\r\n}\r\nstatic int sbc8360_open(struct inode *inode, struct file *file)\r\n{\r\nif (test_and_set_bit(0, &sbc8360_is_open))\r\nreturn -EBUSY;\r\nif (nowayout)\r\n__module_get(THIS_MODULE);\r\nsbc8360_activate();\r\nsbc8360_ping();\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic int sbc8360_close(struct inode *inode, struct file *file)\r\n{\r\nif (expect_close == 42)\r\nsbc8360_stop();\r\nelse\r\nprintk(KERN_CRIT PFX "SBC8360 device closed unexpectedly. "\r\n"SBC8360 will not stop!\n");\r\nclear_bit(0, &sbc8360_is_open);\r\nexpect_close = 0;\r\nreturn 0;\r\n}\r\nstatic int sbc8360_notify_sys(struct notifier_block *this, unsigned long code,\r\nvoid *unused)\r\n{\r\nif (code == SYS_DOWN || code == SYS_HALT)\r\nsbc8360_stop();\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int __init sbc8360_init(void)\r\n{\r\nint res;\r\nunsigned long int mseconds = 60000;\r\nif (timeout < 0 || timeout > 63) {\r\nprintk(KERN_ERR PFX "Invalid timeout index (must be 0-63).\n");\r\nres = -EINVAL;\r\ngoto out;\r\n}\r\nif (!request_region(SBC8360_ENABLE, 1, "SBC8360")) {\r\nprintk(KERN_ERR PFX "ENABLE method I/O %X is not available.\n",\r\nSBC8360_ENABLE);\r\nres = -EIO;\r\ngoto out;\r\n}\r\nif (!request_region(SBC8360_BASETIME, 1, "SBC8360")) {\r\nprintk(KERN_ERR PFX\r\n"BASETIME method I/O %X is not available.\n",\r\nSBC8360_BASETIME);\r\nres = -EIO;\r\ngoto out_nobasetimereg;\r\n}\r\nres = register_reboot_notifier(&sbc8360_notifier);\r\nif (res) {\r\nprintk(KERN_ERR PFX "Failed to register reboot notifier.\n");\r\ngoto out_noreboot;\r\n}\r\nres = misc_register(&sbc8360_miscdev);\r\nif (res) {\r\nprintk(KERN_ERR PFX "failed to register misc device\n");\r\ngoto out_nomisc;\r\n}\r\nwd_margin = wd_times[timeout][0];\r\nwd_multiplier = wd_times[timeout][1];\r\nif (wd_multiplier == 1)\r\nmseconds = (wd_margin + 1) * 500;\r\nelse if (wd_multiplier == 2)\r\nmseconds = (wd_margin + 1) * 5000;\r\nelse if (wd_multiplier == 3)\r\nmseconds = (wd_margin + 1) * 50000;\r\nelse if (wd_multiplier == 4)\r\nmseconds = (wd_margin + 1) * 100000;\r\nprintk(KERN_INFO PFX "Timeout set at %ld ms.\n", mseconds);\r\nreturn 0;\r\nout_nomisc:\r\nunregister_reboot_notifier(&sbc8360_notifier);\r\nout_noreboot:\r\nrelease_region(SBC8360_BASETIME, 1);\r\nout_nobasetimereg:\r\nrelease_region(SBC8360_ENABLE, 1);\r\nout:\r\nreturn res;\r\n}\r\nstatic void __exit sbc8360_exit(void)\r\n{\r\nmisc_deregister(&sbc8360_miscdev);\r\nunregister_reboot_notifier(&sbc8360_notifier);\r\nrelease_region(SBC8360_ENABLE, 1);\r\nrelease_region(SBC8360_BASETIME, 1);\r\n}

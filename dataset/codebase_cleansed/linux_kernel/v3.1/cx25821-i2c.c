static inline int i2c_slave_did_ack(struct i2c_adapter *i2c_adap)\r\n{\r\nstruct cx25821_i2c *bus = i2c_adap->algo_data;\r\nstruct cx25821_dev *dev = bus->dev;\r\nreturn cx_read(bus->reg_stat) & 0x01;\r\n}\r\nstatic inline int i2c_is_busy(struct i2c_adapter *i2c_adap)\r\n{\r\nstruct cx25821_i2c *bus = i2c_adap->algo_data;\r\nstruct cx25821_dev *dev = bus->dev;\r\nreturn cx_read(bus->reg_stat) & 0x02 ? 1 : 0;\r\n}\r\nstatic int i2c_wait_done(struct i2c_adapter *i2c_adap)\r\n{\r\nint count;\r\nfor (count = 0; count < I2C_WAIT_RETRY; count++) {\r\nif (!i2c_is_busy(i2c_adap))\r\nbreak;\r\nudelay(I2C_WAIT_DELAY);\r\n}\r\nif (I2C_WAIT_RETRY == count)\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic int i2c_sendbytes(struct i2c_adapter *i2c_adap,\r\nconst struct i2c_msg *msg, int joined_rlen)\r\n{\r\nstruct cx25821_i2c *bus = i2c_adap->algo_data;\r\nstruct cx25821_dev *dev = bus->dev;\r\nu32 wdata, addr, ctrl;\r\nint retval, cnt;\r\nif (joined_rlen)\r\ndprintk(1, "%s(msg->wlen=%d, nextmsg->rlen=%d)\n", __func__,\r\nmsg->len, joined_rlen);\r\nelse\r\ndprintk(1, "%s(msg->len=%d)\n", __func__, msg->len);\r\nif (msg->len == 0) {\r\ncx_write(bus->reg_addr, msg->addr << 25);\r\ncx_write(bus->reg_ctrl, bus->i2c_period | (1 << 2));\r\nif (!i2c_wait_done(i2c_adap))\r\nreturn -EIO;\r\nif (!i2c_slave_did_ack(i2c_adap))\r\nreturn -EIO;\r\ndprintk(1, "%s(): returns 0\n", __func__);\r\nreturn 0;\r\n}\r\naddr = (msg->addr << 25) | msg->buf[0];\r\nwdata = msg->buf[0];\r\nctrl = bus->i2c_period | (1 << 12) | (1 << 2);\r\nif (msg->len > 1)\r\nctrl |= I2C_NOSTOP | I2C_EXTEND;\r\nelse if (joined_rlen)\r\nctrl |= I2C_NOSTOP;\r\ncx_write(bus->reg_addr, addr);\r\ncx_write(bus->reg_wdata, wdata);\r\ncx_write(bus->reg_ctrl, ctrl);\r\nretval = i2c_wait_done(i2c_adap);\r\nif (retval < 0)\r\ngoto err;\r\nif (retval == 0)\r\ngoto eio;\r\nif (i2c_debug) {\r\nif (!(ctrl & I2C_NOSTOP))\r\nprintk(" >\n");\r\n}\r\nfor (cnt = 1; cnt < msg->len; cnt++) {\r\nwdata = msg->buf[cnt];\r\nctrl = bus->i2c_period | (1 << 12) | (1 << 2);\r\nif (cnt < msg->len - 1)\r\nctrl |= I2C_NOSTOP | I2C_EXTEND;\r\nelse if (joined_rlen)\r\nctrl |= I2C_NOSTOP;\r\ncx_write(bus->reg_addr, addr);\r\ncx_write(bus->reg_wdata, wdata);\r\ncx_write(bus->reg_ctrl, ctrl);\r\nretval = i2c_wait_done(i2c_adap);\r\nif (retval < 0)\r\ngoto err;\r\nif (retval == 0)\r\ngoto eio;\r\nif (i2c_debug) {\r\ndprintk(1, " %02x", msg->buf[cnt]);\r\nif (!(ctrl & I2C_NOSTOP))\r\ndprintk(1, " >\n");\r\n}\r\n}\r\nreturn msg->len;\r\neio:\r\nretval = -EIO;\r\nerr:\r\nif (i2c_debug)\r\npr_err(" ERR: %d\n", retval);\r\nreturn retval;\r\n}\r\nstatic int i2c_readbytes(struct i2c_adapter *i2c_adap,\r\nconst struct i2c_msg *msg, int joined)\r\n{\r\nstruct cx25821_i2c *bus = i2c_adap->algo_data;\r\nstruct cx25821_dev *dev = bus->dev;\r\nu32 ctrl, cnt;\r\nint retval;\r\nif (i2c_debug && !joined)\r\ndprintk(1, "6-%s(msg->len=%d)\n", __func__, msg->len);\r\nif (msg->len == 0) {\r\ncx_write(bus->reg_addr, msg->addr << 25);\r\ncx_write(bus->reg_ctrl, bus->i2c_period | (1 << 2) | 1);\r\nif (!i2c_wait_done(i2c_adap))\r\nreturn -EIO;\r\nif (!i2c_slave_did_ack(i2c_adap))\r\nreturn -EIO;\r\ndprintk(1, "%s(): returns 0\n", __func__);\r\nreturn 0;\r\n}\r\nif (i2c_debug) {\r\nif (joined)\r\ndprintk(1, " R");\r\nelse\r\ndprintk(1, " <R %02x", (msg->addr << 1) + 1);\r\n}\r\nfor (cnt = 0; cnt < msg->len; cnt++) {\r\nctrl = bus->i2c_period | (1 << 12) | (1 << 2) | 1;\r\nif (cnt < msg->len - 1)\r\nctrl |= I2C_NOSTOP | I2C_EXTEND;\r\ncx_write(bus->reg_addr, msg->addr << 25);\r\ncx_write(bus->reg_ctrl, ctrl);\r\nretval = i2c_wait_done(i2c_adap);\r\nif (retval < 0)\r\ngoto err;\r\nif (retval == 0)\r\ngoto eio;\r\nmsg->buf[cnt] = cx_read(bus->reg_rdata) & 0xff;\r\nif (i2c_debug) {\r\ndprintk(1, " %02x", msg->buf[cnt]);\r\nif (!(ctrl & I2C_NOSTOP))\r\ndprintk(1, " >\n");\r\n}\r\n}\r\nreturn msg->len;\r\neio:\r\nretval = -EIO;\r\nerr:\r\nif (i2c_debug)\r\npr_err(" ERR: %d\n", retval);\r\nreturn retval;\r\n}\r\nstatic int i2c_xfer(struct i2c_adapter *i2c_adap, struct i2c_msg *msgs, int num)\r\n{\r\nstruct cx25821_i2c *bus = i2c_adap->algo_data;\r\nstruct cx25821_dev *dev = bus->dev;\r\nint i, retval = 0;\r\ndprintk(1, "%s(num = %d)\n", __func__, num);\r\nfor (i = 0; i < num; i++) {\r\ndprintk(1, "%s(num = %d) addr = 0x%02x len = 0x%x\n",\r\n__func__, num, msgs[i].addr, msgs[i].len);\r\nif (msgs[i].flags & I2C_M_RD) {\r\nretval = i2c_readbytes(i2c_adap, &msgs[i], 0);\r\n} else if (i + 1 < num && (msgs[i + 1].flags & I2C_M_RD) &&\r\nmsgs[i].addr == msgs[i + 1].addr) {\r\nretval =\r\ni2c_sendbytes(i2c_adap, &msgs[i], msgs[i + 1].len);\r\nif (retval < 0)\r\ngoto err;\r\ni++;\r\nretval = i2c_readbytes(i2c_adap, &msgs[i], 1);\r\n} else {\r\nretval = i2c_sendbytes(i2c_adap, &msgs[i], 0);\r\n}\r\nif (retval < 0)\r\ngoto err;\r\n}\r\nreturn num;\r\nerr:\r\nreturn retval;\r\n}\r\nstatic u32 cx25821_functionality(struct i2c_adapter *adap)\r\n{\r\nreturn I2C_FUNC_SMBUS_EMUL |\r\nI2C_FUNC_I2C |\r\nI2C_FUNC_SMBUS_WORD_DATA |\r\nI2C_FUNC_SMBUS_READ_WORD_DATA | I2C_FUNC_SMBUS_WRITE_WORD_DATA;\r\n}\r\nint cx25821_i2c_register(struct cx25821_i2c *bus)\r\n{\r\nstruct cx25821_dev *dev = bus->dev;\r\ndprintk(1, "%s(bus = %d)\n", __func__, bus->nr);\r\nmemcpy(&bus->i2c_adap, &cx25821_i2c_adap_template,\r\nsizeof(bus->i2c_adap));\r\nmemcpy(&bus->i2c_algo, &cx25821_i2c_algo_template,\r\nsizeof(bus->i2c_algo));\r\nmemcpy(&bus->i2c_client, &cx25821_i2c_client_template,\r\nsizeof(bus->i2c_client));\r\nbus->i2c_adap.dev.parent = &dev->pci->dev;\r\nstrlcpy(bus->i2c_adap.name, bus->dev->name, sizeof(bus->i2c_adap.name));\r\nbus->i2c_algo.data = bus;\r\nbus->i2c_adap.algo_data = bus;\r\ni2c_set_adapdata(&bus->i2c_adap, &dev->v4l2_dev);\r\ni2c_add_adapter(&bus->i2c_adap);\r\nbus->i2c_client.adapter = &bus->i2c_adap;\r\nbus->i2c_client.addr = (0x88 >> 1);\r\nreturn bus->i2c_rc;\r\n}\r\nint cx25821_i2c_unregister(struct cx25821_i2c *bus)\r\n{\r\ni2c_del_adapter(&bus->i2c_adap);\r\nreturn 0;\r\n}\r\nvoid cx25821_av_clk(struct cx25821_dev *dev, int enable)\r\n{\r\nchar buffer[3];\r\nstruct i2c_msg msg;\r\ndprintk(1, "%s(enabled = %d)\n", __func__, enable);\r\nbuffer[0] = 0x01;\r\nbuffer[1] = 0x44;\r\nif (enable == 1)\r\nbuffer[2] = 0x05;\r\nelse\r\nbuffer[2] = 0x00;\r\nmsg.addr = 0x44;\r\nmsg.flags = I2C_M_TEN;\r\nmsg.len = 3;\r\nmsg.buf = buffer;\r\ni2c_xfer(&dev->i2c_bus[0].i2c_adap, &msg, 1);\r\n}\r\nint cx25821_i2c_read(struct cx25821_i2c *bus, u16 reg_addr, int *value)\r\n{\r\nstruct i2c_client *client = &bus->i2c_client;\r\nint retval = 0;\r\nint v = 0;\r\nu8 addr[2] = { 0, 0 };\r\nu8 buf[4] = { 0, 0, 0, 0 };\r\nstruct i2c_msg msgs[2] = {\r\n{\r\n.addr = client->addr,\r\n.flags = 0,\r\n.len = 2,\r\n.buf = addr,\r\n}, {\r\n.addr = client->addr,\r\n.flags = I2C_M_RD,\r\n.len = 4,\r\n.buf = buf,\r\n}\r\n};\r\naddr[0] = (reg_addr >> 8);\r\naddr[1] = (reg_addr & 0xff);\r\nmsgs[0].addr = 0x44;\r\nmsgs[1].addr = 0x44;\r\nretval = i2c_xfer(client->adapter, msgs, 2);\r\nv = (buf[3] << 24) | (buf[2] << 16) | (buf[1] << 8) | buf[0];\r\n*value = v;\r\nreturn v;\r\n}\r\nint cx25821_i2c_write(struct cx25821_i2c *bus, u16 reg_addr, int value)\r\n{\r\nstruct i2c_client *client = &bus->i2c_client;\r\nint retval = 0;\r\nu8 buf[6] = { 0, 0, 0, 0, 0, 0 };\r\nstruct i2c_msg msgs[1] = {\r\n{\r\n.addr = client->addr,\r\n.flags = 0,\r\n.len = 6,\r\n.buf = buf,\r\n}\r\n};\r\nbuf[0] = reg_addr >> 8;\r\nbuf[1] = reg_addr & 0xff;\r\nbuf[5] = (value >> 24) & 0xff;\r\nbuf[4] = (value >> 16) & 0xff;\r\nbuf[3] = (value >> 8) & 0xff;\r\nbuf[2] = value & 0xff;\r\nclient->flags = 0;\r\nmsgs[0].addr = 0x44;\r\nretval = i2c_xfer(client->adapter, msgs, 1);\r\nreturn retval;\r\n}

static int __init driver_mpc8260cpm_init_module(void)\r\n{\r\nreturn comedi_driver_register(&driver_mpc8260cpm);\r\n}\r\nstatic void __exit driver_mpc8260cpm_cleanup_module(void)\r\n{\r\ncomedi_driver_unregister(&driver_mpc8260cpm);\r\n}\r\nstatic int mpc8260cpm_attach(struct comedi_device *dev,\r\nstruct comedi_devconfig *it)\r\n{\r\nstruct comedi_subdevice *s;\r\nint i;\r\nprintk("comedi%d: mpc8260cpm: ", dev->minor);\r\ndev->board_ptr = mpc8260cpm_boards + dev->board;\r\ndev->board_name = thisboard->name;\r\nif (alloc_private(dev, sizeof(struct mpc8260cpm_private)) < 0)\r\nreturn -ENOMEM;\r\nif (alloc_subdevices(dev, 4) < 0)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < 4; i++) {\r\ns = dev->subdevices + i;\r\ns->type = COMEDI_SUBD_DIO;\r\ns->subdev_flags = SDF_READABLE | SDF_WRITABLE;\r\ns->n_chan = 32;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_config = mpc8260cpm_dio_config;\r\ns->insn_bits = mpc8260cpm_dio_bits;\r\n}\r\nreturn 1;\r\n}\r\nstatic int mpc8260cpm_detach(struct comedi_device *dev)\r\n{\r\nprintk("comedi%d: mpc8260cpm: remove\n", dev->minor);\r\nreturn 0;\r\n}\r\nstatic unsigned long *cpm_pdat(int port)\r\n{\r\nswitch (port) {\r\ncase 0:\r\nreturn &io->iop_pdata;\r\ncase 1:\r\nreturn &io->iop_pdatb;\r\ncase 2:\r\nreturn &io->iop_pdatc;\r\ncase 3:\r\nreturn &io->iop_pdatd;\r\n}\r\n}\r\nstatic int mpc8260cpm_dio_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint n;\r\nunsigned int d;\r\nunsigned int mask;\r\nint port;\r\nport = (int)s->private;\r\nmask = 1 << CR_CHAN(insn->chanspec);\r\nif (mask & cpm_reserved_bits[port]) {\r\nreturn -EINVAL;\r\n}\r\nswitch (data[0]) {\r\ncase INSN_CONFIG_DIO_OUTPUT:\r\ns->io_bits |= mask;\r\nbreak;\r\ncase INSN_CONFIG_DIO_INPUT:\r\ns->io_bits &= ~mask;\r\nbreak;\r\ncase INSN_CONFIG_DIO_QUERY:\r\ndata[1] = (s->io_bits & mask) ? COMEDI_OUTPUT : COMEDI_INPUT;\r\nreturn insn->n;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (port) {\r\ncase 0:\r\nreturn &io->iop_pdira;\r\ncase 1:\r\nreturn &io->iop_pdirb;\r\ncase 2:\r\nreturn &io->iop_pdirc;\r\ncase 3:\r\nreturn &io->iop_pdird;\r\n}\r\nreturn 1;\r\n}\r\nstatic int mpc8260cpm_dio_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint port;\r\nunsigned long *p;\r\np = cpm_pdat((int)s->private);\r\nreturn 2;\r\n}

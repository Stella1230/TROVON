int po1030_probe(struct sd *sd)\r\n{\r\nu8 dev_id_h = 0, i;\r\ns32 *sensor_settings;\r\nif (force_sensor) {\r\nif (force_sensor == PO1030_SENSOR) {\r\ninfo("Forcing a %s sensor", po1030.name);\r\ngoto sensor_found;\r\n}\r\nreturn -ENODEV;\r\n}\r\nPDEBUG(D_PROBE, "Probing for a po1030 sensor");\r\nfor (i = 0; i < ARRAY_SIZE(preinit_po1030); i++) {\r\nu8 data = preinit_po1030[i][2];\r\nif (preinit_po1030[i][0] == SENSOR)\r\nm5602_write_sensor(sd,\r\npreinit_po1030[i][1], &data, 1);\r\nelse\r\nm5602_write_bridge(sd, preinit_po1030[i][1], data);\r\n}\r\nif (m5602_read_sensor(sd, PO1030_DEVID_H, &dev_id_h, 1))\r\nreturn -ENODEV;\r\nif (dev_id_h == 0x30) {\r\ninfo("Detected a po1030 sensor");\r\ngoto sensor_found;\r\n}\r\nreturn -ENODEV;\r\nsensor_found:\r\nsensor_settings = kmalloc(\r\nARRAY_SIZE(po1030_ctrls) * sizeof(s32), GFP_KERNEL);\r\nif (!sensor_settings)\r\nreturn -ENOMEM;\r\nsd->gspca_dev.cam.cam_mode = po1030_modes;\r\nsd->gspca_dev.cam.nmodes = ARRAY_SIZE(po1030_modes);\r\nsd->desc->ctrls = po1030_ctrls;\r\nsd->desc->nctrls = ARRAY_SIZE(po1030_ctrls);\r\nfor (i = 0; i < ARRAY_SIZE(po1030_ctrls); i++)\r\nsensor_settings[i] = po1030_ctrls[i].qctrl.default_value;\r\nsd->sensor_priv = sensor_settings;\r\nreturn 0;\r\n}\r\nint po1030_init(struct sd *sd)\r\n{\r\ns32 *sensor_settings = sd->sensor_priv;\r\nint i, err = 0;\r\nfor (i = 0; i < ARRAY_SIZE(init_po1030) && !err; i++) {\r\nu8 data[2] = {0x00, 0x00};\r\nswitch (init_po1030[i][0]) {\r\ncase BRIDGE:\r\nerr = m5602_write_bridge(sd,\r\ninit_po1030[i][1],\r\ninit_po1030[i][2]);\r\nbreak;\r\ncase SENSOR:\r\ndata[0] = init_po1030[i][2];\r\nerr = m5602_write_sensor(sd,\r\ninit_po1030[i][1], data, 1);\r\nbreak;\r\ndefault:\r\ninfo("Invalid stream command, exiting init");\r\nreturn -EINVAL;\r\n}\r\n}\r\nif (err < 0)\r\nreturn err;\r\nif (dump_sensor)\r\npo1030_dump_registers(sd);\r\nerr = po1030_set_exposure(&sd->gspca_dev,\r\nsensor_settings[EXPOSURE_IDX]);\r\nif (err < 0)\r\nreturn err;\r\nerr = po1030_set_gain(&sd->gspca_dev, sensor_settings[GAIN_IDX]);\r\nif (err < 0)\r\nreturn err;\r\nerr = po1030_set_hflip(&sd->gspca_dev, sensor_settings[HFLIP_IDX]);\r\nif (err < 0)\r\nreturn err;\r\nerr = po1030_set_vflip(&sd->gspca_dev, sensor_settings[VFLIP_IDX]);\r\nif (err < 0)\r\nreturn err;\r\nerr = po1030_set_red_balance(&sd->gspca_dev,\r\nsensor_settings[RED_BALANCE_IDX]);\r\nif (err < 0)\r\nreturn err;\r\nerr = po1030_set_blue_balance(&sd->gspca_dev,\r\nsensor_settings[BLUE_BALANCE_IDX]);\r\nif (err < 0)\r\nreturn err;\r\nerr = po1030_set_green_balance(&sd->gspca_dev,\r\nsensor_settings[GREEN_BALANCE_IDX]);\r\nif (err < 0)\r\nreturn err;\r\nerr = po1030_set_auto_white_balance(&sd->gspca_dev,\r\nsensor_settings[AUTO_WHITE_BALANCE_IDX]);\r\nif (err < 0)\r\nreturn err;\r\nerr = po1030_set_auto_exposure(&sd->gspca_dev,\r\nsensor_settings[AUTO_EXPOSURE_IDX]);\r\nreturn err;\r\n}\r\nint po1030_start(struct sd *sd)\r\n{\r\nstruct cam *cam = &sd->gspca_dev.cam;\r\nint i, err = 0;\r\nint width = cam->cam_mode[sd->gspca_dev.curr_mode].width;\r\nint height = cam->cam_mode[sd->gspca_dev.curr_mode].height;\r\nint ver_offs = cam->cam_mode[sd->gspca_dev.curr_mode].priv;\r\nu8 data;\r\nswitch (width) {\r\ncase 320:\r\ndata = PO1030_SUBSAMPLING;\r\nerr = m5602_write_sensor(sd, PO1030_CONTROL3, &data, 1);\r\nif (err < 0)\r\nreturn err;\r\ndata = ((width + 3) >> 8) & 0xff;\r\nerr = m5602_write_sensor(sd, PO1030_WINDOWWIDTH_H, &data, 1);\r\nif (err < 0)\r\nreturn err;\r\ndata = (width + 3) & 0xff;\r\nerr = m5602_write_sensor(sd, PO1030_WINDOWWIDTH_L, &data, 1);\r\nif (err < 0)\r\nreturn err;\r\ndata = ((height + 1) >> 8) & 0xff;\r\nerr = m5602_write_sensor(sd, PO1030_WINDOWHEIGHT_H, &data, 1);\r\nif (err < 0)\r\nreturn err;\r\ndata = (height + 1) & 0xff;\r\nerr = m5602_write_sensor(sd, PO1030_WINDOWHEIGHT_L, &data, 1);\r\nheight += 6;\r\nwidth -= 1;\r\nbreak;\r\ncase 640:\r\ndata = 0;\r\nerr = m5602_write_sensor(sd, PO1030_CONTROL3, &data, 1);\r\nif (err < 0)\r\nreturn err;\r\ndata = ((width + 7) >> 8) & 0xff;\r\nerr = m5602_write_sensor(sd, PO1030_WINDOWWIDTH_H, &data, 1);\r\nif (err < 0)\r\nreturn err;\r\ndata = (width + 7) & 0xff;\r\nerr = m5602_write_sensor(sd, PO1030_WINDOWWIDTH_L, &data, 1);\r\nif (err < 0)\r\nreturn err;\r\ndata = ((height + 3) >> 8) & 0xff;\r\nerr = m5602_write_sensor(sd, PO1030_WINDOWHEIGHT_H, &data, 1);\r\nif (err < 0)\r\nreturn err;\r\ndata = (height + 3) & 0xff;\r\nerr = m5602_write_sensor(sd, PO1030_WINDOWHEIGHT_L, &data, 1);\r\nheight += 12;\r\nwidth -= 2;\r\nbreak;\r\n}\r\nerr = m5602_write_bridge(sd, M5602_XB_SENSOR_TYPE, 0x0c);\r\nif (err < 0)\r\nreturn err;\r\nerr = m5602_write_bridge(sd, M5602_XB_LINE_OF_FRAME_H, 0x81);\r\nif (err < 0)\r\nreturn err;\r\nerr = m5602_write_bridge(sd, M5602_XB_PIX_OF_LINE_H, 0x82);\r\nif (err < 0)\r\nreturn err;\r\nerr = m5602_write_bridge(sd, M5602_XB_SIG_INI, 0x01);\r\nif (err < 0)\r\nreturn err;\r\nerr = m5602_write_bridge(sd, M5602_XB_VSYNC_PARA,\r\n((ver_offs >> 8) & 0xff));\r\nif (err < 0)\r\nreturn err;\r\nerr = m5602_write_bridge(sd, M5602_XB_VSYNC_PARA, (ver_offs & 0xff));\r\nif (err < 0)\r\nreturn err;\r\nfor (i = 0; i < 2 && !err; i++)\r\nerr = m5602_write_bridge(sd, M5602_XB_VSYNC_PARA, 0);\r\nif (err < 0)\r\nreturn err;\r\nerr = m5602_write_bridge(sd, M5602_XB_VSYNC_PARA, (height >> 8) & 0xff);\r\nif (err < 0)\r\nreturn err;\r\nerr = m5602_write_bridge(sd, M5602_XB_VSYNC_PARA, (height & 0xff));\r\nif (err < 0)\r\nreturn err;\r\nfor (i = 0; i < 2 && !err; i++)\r\nerr = m5602_write_bridge(sd, M5602_XB_VSYNC_PARA, 0);\r\nfor (i = 0; i < 2 && !err; i++)\r\nerr = m5602_write_bridge(sd, M5602_XB_SIG_INI, 0);\r\nfor (i = 0; i < 2 && !err; i++)\r\nerr = m5602_write_bridge(sd, M5602_XB_HSYNC_PARA, 0);\r\nif (err < 0)\r\nreturn err;\r\nerr = m5602_write_bridge(sd, M5602_XB_HSYNC_PARA, (width >> 8) & 0xff);\r\nif (err < 0)\r\nreturn err;\r\nerr = m5602_write_bridge(sd, M5602_XB_HSYNC_PARA, (width & 0xff));\r\nif (err < 0)\r\nreturn err;\r\nerr = m5602_write_bridge(sd, M5602_XB_SIG_INI, 0);\r\nreturn err;\r\n}\r\nstatic int po1030_get_exposure(struct gspca_dev *gspca_dev, __s32 *val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\ns32 *sensor_settings = sd->sensor_priv;\r\n*val = sensor_settings[EXPOSURE_IDX];\r\nPDEBUG(D_V4L2, "Exposure read as %d", *val);\r\nreturn 0;\r\n}\r\nstatic int po1030_set_exposure(struct gspca_dev *gspca_dev, __s32 val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\ns32 *sensor_settings = sd->sensor_priv;\r\nu8 i2c_data;\r\nint err;\r\nsensor_settings[EXPOSURE_IDX] = val;\r\nPDEBUG(D_V4L2, "Set exposure to %d", val & 0xffff);\r\ni2c_data = ((val & 0xff00) >> 8);\r\nPDEBUG(D_V4L2, "Set exposure to high byte to 0x%x",\r\ni2c_data);\r\nerr = m5602_write_sensor(sd, PO1030_INTEGLINES_H,\r\n&i2c_data, 1);\r\nif (err < 0)\r\nreturn err;\r\ni2c_data = (val & 0xff);\r\nPDEBUG(D_V4L2, "Set exposure to low byte to 0x%x",\r\ni2c_data);\r\nerr = m5602_write_sensor(sd, PO1030_INTEGLINES_M,\r\n&i2c_data, 1);\r\nreturn err;\r\n}\r\nstatic int po1030_get_gain(struct gspca_dev *gspca_dev, __s32 *val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\ns32 *sensor_settings = sd->sensor_priv;\r\n*val = sensor_settings[GAIN_IDX];\r\nPDEBUG(D_V4L2, "Read global gain %d", *val);\r\nreturn 0;\r\n}\r\nstatic int po1030_set_gain(struct gspca_dev *gspca_dev, __s32 val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\ns32 *sensor_settings = sd->sensor_priv;\r\nu8 i2c_data;\r\nint err;\r\nsensor_settings[GAIN_IDX] = val;\r\ni2c_data = val & 0xff;\r\nPDEBUG(D_V4L2, "Set global gain to %d", i2c_data);\r\nerr = m5602_write_sensor(sd, PO1030_GLOBALGAIN,\r\n&i2c_data, 1);\r\nreturn err;\r\n}\r\nstatic int po1030_get_hflip(struct gspca_dev *gspca_dev, __s32 *val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\ns32 *sensor_settings = sd->sensor_priv;\r\n*val = sensor_settings[HFLIP_IDX];\r\nPDEBUG(D_V4L2, "Read hflip %d", *val);\r\nreturn 0;\r\n}\r\nstatic int po1030_set_hflip(struct gspca_dev *gspca_dev, __s32 val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\ns32 *sensor_settings = sd->sensor_priv;\r\nu8 i2c_data;\r\nint err;\r\nsensor_settings[HFLIP_IDX] = val;\r\nPDEBUG(D_V4L2, "Set hflip %d", val);\r\nerr = m5602_read_sensor(sd, PO1030_CONTROL2, &i2c_data, 1);\r\nif (err < 0)\r\nreturn err;\r\ni2c_data = (0x7f & i2c_data) | ((val & 0x01) << 7);\r\nerr = m5602_write_sensor(sd, PO1030_CONTROL2,\r\n&i2c_data, 1);\r\nreturn err;\r\n}\r\nstatic int po1030_get_vflip(struct gspca_dev *gspca_dev, __s32 *val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\ns32 *sensor_settings = sd->sensor_priv;\r\n*val = sensor_settings[VFLIP_IDX];\r\nPDEBUG(D_V4L2, "Read vflip %d", *val);\r\nreturn 0;\r\n}\r\nstatic int po1030_set_vflip(struct gspca_dev *gspca_dev, __s32 val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\ns32 *sensor_settings = sd->sensor_priv;\r\nu8 i2c_data;\r\nint err;\r\nsensor_settings[VFLIP_IDX] = val;\r\nPDEBUG(D_V4L2, "Set vflip %d", val);\r\nerr = m5602_read_sensor(sd, PO1030_CONTROL2, &i2c_data, 1);\r\nif (err < 0)\r\nreturn err;\r\ni2c_data = (i2c_data & 0xbf) | ((val & 0x01) << 6);\r\nerr = m5602_write_sensor(sd, PO1030_CONTROL2,\r\n&i2c_data, 1);\r\nreturn err;\r\n}\r\nstatic int po1030_get_red_balance(struct gspca_dev *gspca_dev, __s32 *val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\ns32 *sensor_settings = sd->sensor_priv;\r\n*val = sensor_settings[RED_BALANCE_IDX];\r\nPDEBUG(D_V4L2, "Read red gain %d", *val);\r\nreturn 0;\r\n}\r\nstatic int po1030_set_red_balance(struct gspca_dev *gspca_dev, __s32 val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\ns32 *sensor_settings = sd->sensor_priv;\r\nu8 i2c_data;\r\nint err;\r\nsensor_settings[RED_BALANCE_IDX] = val;\r\ni2c_data = val & 0xff;\r\nPDEBUG(D_V4L2, "Set red gain to %d", i2c_data);\r\nerr = m5602_write_sensor(sd, PO1030_RED_GAIN,\r\n&i2c_data, 1);\r\nreturn err;\r\n}\r\nstatic int po1030_get_blue_balance(struct gspca_dev *gspca_dev, __s32 *val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\ns32 *sensor_settings = sd->sensor_priv;\r\n*val = sensor_settings[BLUE_BALANCE_IDX];\r\nPDEBUG(D_V4L2, "Read blue gain %d", *val);\r\nreturn 0;\r\n}\r\nstatic int po1030_set_blue_balance(struct gspca_dev *gspca_dev, __s32 val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\ns32 *sensor_settings = sd->sensor_priv;\r\nu8 i2c_data;\r\nint err;\r\nsensor_settings[BLUE_BALANCE_IDX] = val;\r\ni2c_data = val & 0xff;\r\nPDEBUG(D_V4L2, "Set blue gain to %d", i2c_data);\r\nerr = m5602_write_sensor(sd, PO1030_BLUE_GAIN,\r\n&i2c_data, 1);\r\nreturn err;\r\n}\r\nstatic int po1030_get_green_balance(struct gspca_dev *gspca_dev, __s32 *val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\ns32 *sensor_settings = sd->sensor_priv;\r\n*val = sensor_settings[GREEN_BALANCE_IDX];\r\nPDEBUG(D_V4L2, "Read green gain %d", *val);\r\nreturn 0;\r\n}\r\nstatic int po1030_set_green_balance(struct gspca_dev *gspca_dev, __s32 val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\ns32 *sensor_settings = sd->sensor_priv;\r\nu8 i2c_data;\r\nint err;\r\nsensor_settings[GREEN_BALANCE_IDX] = val;\r\ni2c_data = val & 0xff;\r\nPDEBUG(D_V4L2, "Set green gain to %d", i2c_data);\r\nerr = m5602_write_sensor(sd, PO1030_GREEN_1_GAIN,\r\n&i2c_data, 1);\r\nif (err < 0)\r\nreturn err;\r\nreturn m5602_write_sensor(sd, PO1030_GREEN_2_GAIN,\r\n&i2c_data, 1);\r\n}\r\nstatic int po1030_get_auto_white_balance(struct gspca_dev *gspca_dev,\r\n__s32 *val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\ns32 *sensor_settings = sd->sensor_priv;\r\n*val = sensor_settings[AUTO_WHITE_BALANCE_IDX];\r\nPDEBUG(D_V4L2, "Auto white balancing is %d", *val);\r\nreturn 0;\r\n}\r\nstatic int po1030_set_auto_white_balance(struct gspca_dev *gspca_dev,\r\n__s32 val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\ns32 *sensor_settings = sd->sensor_priv;\r\nu8 i2c_data;\r\nint err;\r\nsensor_settings[AUTO_WHITE_BALANCE_IDX] = val;\r\nerr = m5602_read_sensor(sd, PO1030_AUTOCTRL1, &i2c_data, 1);\r\nif (err < 0)\r\nreturn err;\r\nPDEBUG(D_V4L2, "Set auto white balance to %d", val);\r\ni2c_data = (i2c_data & 0xfe) | (val & 0x01);\r\nerr = m5602_write_sensor(sd, PO1030_AUTOCTRL1, &i2c_data, 1);\r\nreturn err;\r\n}\r\nstatic int po1030_get_auto_exposure(struct gspca_dev *gspca_dev,\r\n__s32 *val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\ns32 *sensor_settings = sd->sensor_priv;\r\n*val = sensor_settings[AUTO_EXPOSURE_IDX];\r\nPDEBUG(D_V4L2, "Auto exposure is %d", *val);\r\nreturn 0;\r\n}\r\nstatic int po1030_set_auto_exposure(struct gspca_dev *gspca_dev,\r\n__s32 val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\ns32 *sensor_settings = sd->sensor_priv;\r\nu8 i2c_data;\r\nint err;\r\nsensor_settings[AUTO_EXPOSURE_IDX] = val;\r\nerr = m5602_read_sensor(sd, PO1030_AUTOCTRL1, &i2c_data, 1);\r\nif (err < 0)\r\nreturn err;\r\nPDEBUG(D_V4L2, "Set auto exposure to %d", val);\r\ni2c_data = (i2c_data & 0xfd) | ((val & 0x01) << 1);\r\nreturn m5602_write_sensor(sd, PO1030_AUTOCTRL1, &i2c_data, 1);\r\n}\r\nvoid po1030_disconnect(struct sd *sd)\r\n{\r\nsd->sensor = NULL;\r\nkfree(sd->sensor_priv);\r\n}\r\nstatic void po1030_dump_registers(struct sd *sd)\r\n{\r\nint address;\r\nu8 value = 0;\r\ninfo("Dumping the po1030 sensor core registers");\r\nfor (address = 0; address < 0x7f; address++) {\r\nm5602_read_sensor(sd, address, &value, 1);\r\ninfo("register 0x%x contains 0x%x",\r\naddress, value);\r\n}\r\ninfo("po1030 register state dump complete");\r\ninfo("Probing for which registers that are read/write");\r\nfor (address = 0; address < 0xff; address++) {\r\nu8 old_value, ctrl_value;\r\nu8 test_value[2] = {0xff, 0xff};\r\nm5602_read_sensor(sd, address, &old_value, 1);\r\nm5602_write_sensor(sd, address, test_value, 1);\r\nm5602_read_sensor(sd, address, &ctrl_value, 1);\r\nif (ctrl_value == test_value[0])\r\ninfo("register 0x%x is writeable", address);\r\nelse\r\ninfo("register 0x%x is read only", address);\r\nm5602_write_sensor(sd, address, &old_value, 1);\r\n}\r\n}

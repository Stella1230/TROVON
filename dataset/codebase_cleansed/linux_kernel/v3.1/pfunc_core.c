static u32 pmf_next32(struct pmf_cmd *cmd)\r\n{\r\nu32 value;\r\nif ((cmd->cmdend - cmd->cmdptr) < 4) {\r\ncmd->error = 1;\r\nreturn 0;\r\n}\r\nvalue = *((u32 *)cmd->cmdptr);\r\ncmd->cmdptr += 4;\r\nreturn value;\r\n}\r\nstatic const void* pmf_next_blob(struct pmf_cmd *cmd, int count)\r\n{\r\nconst void *value;\r\nif ((cmd->cmdend - cmd->cmdptr) < count) {\r\ncmd->error = 1;\r\nreturn NULL;\r\n}\r\nvalue = cmd->cmdptr;\r\ncmd->cmdptr += count;\r\nreturn value;\r\n}\r\nstatic int pmf_parser_read_gpio(struct pmf_cmd *cmd, struct pmf_handlers *h)\r\n{\r\nu8 mask = (u8)pmf_next32(cmd);\r\nint rshift = (int)pmf_next32(cmd);\r\nu8 xor = (u8)pmf_next32(cmd);\r\nLOG_PARSE("pmf: read_gpio(mask: %02x, rshift: %d, xor: %02x)\n",\r\nmask, rshift, xor);\r\nPMF_PARSE_CALL(read_gpio, cmd, h, mask, rshift, xor);\r\n}\r\nstatic int pmf_parser_write_reg32(struct pmf_cmd *cmd, struct pmf_handlers *h)\r\n{\r\nu32 offset = pmf_next32(cmd);\r\nu32 value = pmf_next32(cmd);\r\nu32 mask = pmf_next32(cmd);\r\nLOG_PARSE("pmf: write_reg32(offset: %08x, value: %08x, mask: %08x)\n",\r\noffset, value, mask);\r\nPMF_PARSE_CALL(write_reg32, cmd, h, offset, value, mask);\r\n}\r\nstatic int pmf_parser_read_reg32(struct pmf_cmd *cmd, struct pmf_handlers *h)\r\n{\r\nu32 offset = pmf_next32(cmd);\r\nLOG_PARSE("pmf: read_reg32(offset: %08x)\n", offset);\r\nPMF_PARSE_CALL(read_reg32, cmd, h, offset);\r\n}\r\nstatic int pmf_parser_write_reg16(struct pmf_cmd *cmd, struct pmf_handlers *h)\r\n{\r\nu32 offset = pmf_next32(cmd);\r\nu16 value = (u16)pmf_next32(cmd);\r\nu16 mask = (u16)pmf_next32(cmd);\r\nLOG_PARSE("pmf: write_reg16(offset: %08x, value: %04x, mask: %04x)\n",\r\noffset, value, mask);\r\nPMF_PARSE_CALL(write_reg16, cmd, h, offset, value, mask);\r\n}\r\nstatic int pmf_parser_read_reg16(struct pmf_cmd *cmd, struct pmf_handlers *h)\r\n{\r\nu32 offset = pmf_next32(cmd);\r\nLOG_PARSE("pmf: read_reg16(offset: %08x)\n", offset);\r\nPMF_PARSE_CALL(read_reg16, cmd, h, offset);\r\n}\r\nstatic int pmf_parser_write_reg8(struct pmf_cmd *cmd, struct pmf_handlers *h)\r\n{\r\nu32 offset = pmf_next32(cmd);\r\nu8 value = (u16)pmf_next32(cmd);\r\nu8 mask = (u16)pmf_next32(cmd);\r\nLOG_PARSE("pmf: write_reg8(offset: %08x, value: %02x, mask: %02x)\n",\r\noffset, value, mask);\r\nPMF_PARSE_CALL(write_reg8, cmd, h, offset, value, mask);\r\n}\r\nstatic int pmf_parser_read_reg8(struct pmf_cmd *cmd, struct pmf_handlers *h)\r\n{\r\nu32 offset = pmf_next32(cmd);\r\nLOG_PARSE("pmf: read_reg8(offset: %08x)\n", offset);\r\nPMF_PARSE_CALL(read_reg8, cmd, h, offset);\r\n}\r\nstatic int pmf_parser_delay(struct pmf_cmd *cmd, struct pmf_handlers *h)\r\n{\r\nu32 duration = pmf_next32(cmd);\r\nLOG_PARSE("pmf: delay(duration: %d us)\n", duration);\r\nPMF_PARSE_CALL(delay, cmd, h, duration);\r\n}\r\nstatic int pmf_parser_wait_reg32(struct pmf_cmd *cmd, struct pmf_handlers *h)\r\n{\r\nu32 offset = pmf_next32(cmd);\r\nu32 value = pmf_next32(cmd);\r\nu32 mask = pmf_next32(cmd);\r\nLOG_PARSE("pmf: wait_reg32(offset: %08x, comp_value: %08x,mask: %08x)\n",\r\noffset, value, mask);\r\nPMF_PARSE_CALL(wait_reg32, cmd, h, offset, value, mask);\r\n}\r\nstatic int pmf_parser_wait_reg16(struct pmf_cmd *cmd, struct pmf_handlers *h)\r\n{\r\nu32 offset = pmf_next32(cmd);\r\nu16 value = (u16)pmf_next32(cmd);\r\nu16 mask = (u16)pmf_next32(cmd);\r\nLOG_PARSE("pmf: wait_reg16(offset: %08x, comp_value: %04x,mask: %04x)\n",\r\noffset, value, mask);\r\nPMF_PARSE_CALL(wait_reg16, cmd, h, offset, value, mask);\r\n}\r\nstatic int pmf_parser_wait_reg8(struct pmf_cmd *cmd, struct pmf_handlers *h)\r\n{\r\nu32 offset = pmf_next32(cmd);\r\nu8 value = (u8)pmf_next32(cmd);\r\nu8 mask = (u8)pmf_next32(cmd);\r\nLOG_PARSE("pmf: wait_reg8(offset: %08x, comp_value: %02x,mask: %02x)\n",\r\noffset, value, mask);\r\nPMF_PARSE_CALL(wait_reg8, cmd, h, offset, value, mask);\r\n}\r\nstatic int pmf_parser_read_i2c(struct pmf_cmd *cmd, struct pmf_handlers *h)\r\n{\r\nu32 bytes = pmf_next32(cmd);\r\nLOG_PARSE("pmf: read_i2c(bytes: %ud)\n", bytes);\r\nPMF_PARSE_CALL(read_i2c, cmd, h, bytes);\r\n}\r\nstatic int pmf_parser_write_i2c(struct pmf_cmd *cmd, struct pmf_handlers *h)\r\n{\r\nu32 bytes = pmf_next32(cmd);\r\nconst void *blob = pmf_next_blob(cmd, bytes);\r\nLOG_PARSE("pmf: write_i2c(bytes: %ud) ...\n", bytes);\r\nLOG_BLOB("pmf: data: \n", blob, bytes);\r\nPMF_PARSE_CALL(write_i2c, cmd, h, bytes, blob);\r\n}\r\nstatic int pmf_parser_rmw_i2c(struct pmf_cmd *cmd, struct pmf_handlers *h)\r\n{\r\nu32 maskbytes = pmf_next32(cmd);\r\nu32 valuesbytes = pmf_next32(cmd);\r\nu32 totalbytes = pmf_next32(cmd);\r\nconst void *maskblob = pmf_next_blob(cmd, maskbytes);\r\nconst void *valuesblob = pmf_next_blob(cmd, valuesbytes);\r\nLOG_PARSE("pmf: rmw_i2c(maskbytes: %ud, valuebytes: %ud, "\r\n"totalbytes: %d) ...\n",\r\nmaskbytes, valuesbytes, totalbytes);\r\nLOG_BLOB("pmf: mask data: \n", maskblob, maskbytes);\r\nLOG_BLOB("pmf: values data: \n", valuesblob, valuesbytes);\r\nPMF_PARSE_CALL(rmw_i2c, cmd, h, maskbytes, valuesbytes, totalbytes,\r\nmaskblob, valuesblob);\r\n}\r\nstatic int pmf_parser_read_cfg(struct pmf_cmd *cmd, struct pmf_handlers *h)\r\n{\r\nu32 offset = pmf_next32(cmd);\r\nu32 bytes = pmf_next32(cmd);\r\nLOG_PARSE("pmf: read_cfg(offset: %x, bytes: %ud)\n", offset, bytes);\r\nPMF_PARSE_CALL(read_cfg, cmd, h, offset, bytes);\r\n}\r\nstatic int pmf_parser_write_cfg(struct pmf_cmd *cmd, struct pmf_handlers *h)\r\n{\r\nu32 offset = pmf_next32(cmd);\r\nu32 bytes = pmf_next32(cmd);\r\nconst void *blob = pmf_next_blob(cmd, bytes);\r\nLOG_PARSE("pmf: write_cfg(offset: %x, bytes: %ud)\n", offset, bytes);\r\nLOG_BLOB("pmf: data: \n", blob, bytes);\r\nPMF_PARSE_CALL(write_cfg, cmd, h, offset, bytes, blob);\r\n}\r\nstatic int pmf_parser_rmw_cfg(struct pmf_cmd *cmd, struct pmf_handlers *h)\r\n{\r\nu32 offset = pmf_next32(cmd);\r\nu32 maskbytes = pmf_next32(cmd);\r\nu32 valuesbytes = pmf_next32(cmd);\r\nu32 totalbytes = pmf_next32(cmd);\r\nconst void *maskblob = pmf_next_blob(cmd, maskbytes);\r\nconst void *valuesblob = pmf_next_blob(cmd, valuesbytes);\r\nLOG_PARSE("pmf: rmw_cfg(maskbytes: %ud, valuebytes: %ud,"\r\n" totalbytes: %d) ...\n",\r\nmaskbytes, valuesbytes, totalbytes);\r\nLOG_BLOB("pmf: mask data: \n", maskblob, maskbytes);\r\nLOG_BLOB("pmf: values data: \n", valuesblob, valuesbytes);\r\nPMF_PARSE_CALL(rmw_cfg, cmd, h, offset, maskbytes, valuesbytes,\r\ntotalbytes, maskblob, valuesblob);\r\n}\r\nstatic int pmf_parser_read_i2c_sub(struct pmf_cmd *cmd, struct pmf_handlers *h)\r\n{\r\nu8 subaddr = (u8)pmf_next32(cmd);\r\nu32 bytes = pmf_next32(cmd);\r\nLOG_PARSE("pmf: read_i2c_sub(subaddr: %x, bytes: %ud)\n",\r\nsubaddr, bytes);\r\nPMF_PARSE_CALL(read_i2c_sub, cmd, h, subaddr, bytes);\r\n}\r\nstatic int pmf_parser_write_i2c_sub(struct pmf_cmd *cmd, struct pmf_handlers *h)\r\n{\r\nu8 subaddr = (u8)pmf_next32(cmd);\r\nu32 bytes = pmf_next32(cmd);\r\nconst void *blob = pmf_next_blob(cmd, bytes);\r\nLOG_PARSE("pmf: write_i2c_sub(subaddr: %x, bytes: %ud) ...\n",\r\nsubaddr, bytes);\r\nLOG_BLOB("pmf: data: \n", blob, bytes);\r\nPMF_PARSE_CALL(write_i2c_sub, cmd, h, subaddr, bytes, blob);\r\n}\r\nstatic int pmf_parser_set_i2c_mode(struct pmf_cmd *cmd, struct pmf_handlers *h)\r\n{\r\nu32 mode = pmf_next32(cmd);\r\nLOG_PARSE("pmf: set_i2c_mode(mode: %d)\n", mode);\r\nPMF_PARSE_CALL(set_i2c_mode, cmd, h, mode);\r\n}\r\nstatic int pmf_parser_rmw_i2c_sub(struct pmf_cmd *cmd, struct pmf_handlers *h)\r\n{\r\nu8 subaddr = (u8)pmf_next32(cmd);\r\nu32 maskbytes = pmf_next32(cmd);\r\nu32 valuesbytes = pmf_next32(cmd);\r\nu32 totalbytes = pmf_next32(cmd);\r\nconst void *maskblob = pmf_next_blob(cmd, maskbytes);\r\nconst void *valuesblob = pmf_next_blob(cmd, valuesbytes);\r\nLOG_PARSE("pmf: rmw_i2c_sub(subaddr: %x, maskbytes: %ud, valuebytes: %ud"\r\n", totalbytes: %d) ...\n",\r\nsubaddr, maskbytes, valuesbytes, totalbytes);\r\nLOG_BLOB("pmf: mask data: \n", maskblob, maskbytes);\r\nLOG_BLOB("pmf: values data: \n", valuesblob, valuesbytes);\r\nPMF_PARSE_CALL(rmw_i2c_sub, cmd, h, subaddr, maskbytes, valuesbytes,\r\ntotalbytes, maskblob, valuesblob);\r\n}\r\nstatic int pmf_parser_read_reg32_msrx(struct pmf_cmd *cmd,\r\nstruct pmf_handlers *h)\r\n{\r\nu32 offset = pmf_next32(cmd);\r\nu32 mask = pmf_next32(cmd);\r\nu32 shift = pmf_next32(cmd);\r\nu32 xor = pmf_next32(cmd);\r\nLOG_PARSE("pmf: read_reg32_msrx(offset: %x, mask: %x, shift: %x,"\r\n" xor: %x\n", offset, mask, shift, xor);\r\nPMF_PARSE_CALL(read_reg32_msrx, cmd, h, offset, mask, shift, xor);\r\n}\r\nstatic int pmf_parser_read_reg16_msrx(struct pmf_cmd *cmd,\r\nstruct pmf_handlers *h)\r\n{\r\nu32 offset = pmf_next32(cmd);\r\nu32 mask = pmf_next32(cmd);\r\nu32 shift = pmf_next32(cmd);\r\nu32 xor = pmf_next32(cmd);\r\nLOG_PARSE("pmf: read_reg16_msrx(offset: %x, mask: %x, shift: %x,"\r\n" xor: %x\n", offset, mask, shift, xor);\r\nPMF_PARSE_CALL(read_reg16_msrx, cmd, h, offset, mask, shift, xor);\r\n}\r\nstatic int pmf_parser_read_reg8_msrx(struct pmf_cmd *cmd,\r\nstruct pmf_handlers *h)\r\n{\r\nu32 offset = pmf_next32(cmd);\r\nu32 mask = pmf_next32(cmd);\r\nu32 shift = pmf_next32(cmd);\r\nu32 xor = pmf_next32(cmd);\r\nLOG_PARSE("pmf: read_reg8_msrx(offset: %x, mask: %x, shift: %x,"\r\n" xor: %x\n", offset, mask, shift, xor);\r\nPMF_PARSE_CALL(read_reg8_msrx, cmd, h, offset, mask, shift, xor);\r\n}\r\nstatic int pmf_parser_write_reg32_slm(struct pmf_cmd *cmd,\r\nstruct pmf_handlers *h)\r\n{\r\nu32 offset = pmf_next32(cmd);\r\nu32 shift = pmf_next32(cmd);\r\nu32 mask = pmf_next32(cmd);\r\nLOG_PARSE("pmf: write_reg32_slm(offset: %x, shift: %x, mask: %x\n",\r\noffset, shift, mask);\r\nPMF_PARSE_CALL(write_reg32_slm, cmd, h, offset, shift, mask);\r\n}\r\nstatic int pmf_parser_write_reg16_slm(struct pmf_cmd *cmd,\r\nstruct pmf_handlers *h)\r\n{\r\nu32 offset = pmf_next32(cmd);\r\nu32 shift = pmf_next32(cmd);\r\nu32 mask = pmf_next32(cmd);\r\nLOG_PARSE("pmf: write_reg16_slm(offset: %x, shift: %x, mask: %x\n",\r\noffset, shift, mask);\r\nPMF_PARSE_CALL(write_reg16_slm, cmd, h, offset, shift, mask);\r\n}\r\nstatic int pmf_parser_write_reg8_slm(struct pmf_cmd *cmd,\r\nstruct pmf_handlers *h)\r\n{\r\nu32 offset = pmf_next32(cmd);\r\nu32 shift = pmf_next32(cmd);\r\nu32 mask = pmf_next32(cmd);\r\nLOG_PARSE("pmf: write_reg8_slm(offset: %x, shift: %x, mask: %x\n",\r\noffset, shift, mask);\r\nPMF_PARSE_CALL(write_reg8_slm, cmd, h, offset, shift, mask);\r\n}\r\nstatic int pmf_parser_mask_and_compare(struct pmf_cmd *cmd,\r\nstruct pmf_handlers *h)\r\n{\r\nu32 bytes = pmf_next32(cmd);\r\nconst void *maskblob = pmf_next_blob(cmd, bytes);\r\nconst void *valuesblob = pmf_next_blob(cmd, bytes);\r\nLOG_PARSE("pmf: mask_and_compare(length: %ud ...\n", bytes);\r\nLOG_BLOB("pmf: mask data: \n", maskblob, bytes);\r\nLOG_BLOB("pmf: values data: \n", valuesblob, bytes);\r\nPMF_PARSE_CALL(mask_and_compare, cmd, h,\r\nbytes, maskblob, valuesblob);\r\n}\r\nstatic void pmf_release_device(struct kref *kref)\r\n{\r\nstruct pmf_device *dev = container_of(kref, struct pmf_device, ref);\r\nkfree(dev);\r\n}\r\nstatic inline void pmf_put_device(struct pmf_device *dev)\r\n{\r\nkref_put(&dev->ref, pmf_release_device);\r\n}\r\nstatic inline struct pmf_device *pmf_get_device(struct pmf_device *dev)\r\n{\r\nkref_get(&dev->ref);\r\nreturn dev;\r\n}\r\nstatic inline struct pmf_device *pmf_find_device(struct device_node *np)\r\n{\r\nstruct pmf_device *dev;\r\nlist_for_each_entry(dev, &pmf_devices, link) {\r\nif (dev->node == np)\r\nreturn pmf_get_device(dev);\r\n}\r\nreturn NULL;\r\n}\r\nstatic int pmf_parse_one(struct pmf_function *func,\r\nstruct pmf_handlers *handlers,\r\nvoid *instdata, struct pmf_args *args)\r\n{\r\nstruct pmf_cmd cmd;\r\nu32 ccode;\r\nint count, rc;\r\ncmd.cmdptr = func->data;\r\ncmd.cmdend = func->data + func->length;\r\ncmd.func = func;\r\ncmd.instdata = instdata;\r\ncmd.args = args;\r\ncmd.error = 0;\r\nLOG_PARSE("pmf: func %s, %d bytes, %s...\n",\r\nfunc->name, func->length,\r\nhandlers ? "executing" : "parsing");\r\ncount = 1;\r\nwhile(count-- && cmd.cmdptr < cmd.cmdend) {\r\nccode = pmf_next32(&cmd);\r\nif (ccode == 0) {\r\ncount = pmf_next32(&cmd) - 1;\r\nccode = pmf_next32(&cmd);\r\n}\r\nif (cmd.error) {\r\nLOG_ERROR("pmf: parse error, not enough data\n");\r\nreturn -ENXIO;\r\n}\r\nif (ccode >= PMF_CMD_COUNT) {\r\nLOG_ERROR("pmf: command code %d unknown !\n", ccode);\r\nreturn -ENXIO;\r\n}\r\nif (pmf_parsers[ccode] == NULL) {\r\nLOG_ERROR("pmf: no parser for command %d !\n", ccode);\r\nreturn -ENXIO;\r\n}\r\nrc = pmf_parsers[ccode](&cmd, handlers);\r\nif (rc != 0) {\r\nLOG_ERROR("pmf: parser for command %d returned"\r\n" error %d\n", ccode, rc);\r\nreturn rc;\r\n}\r\n}\r\nif (handlers == NULL)\r\nfunc->length = cmd.cmdptr - func->data;\r\nreturn 0;\r\n}\r\nstatic int pmf_add_function_prop(struct pmf_device *dev, void *driverdata,\r\nconst char *name, u32 *data,\r\nunsigned int length)\r\n{\r\nint count = 0;\r\nstruct pmf_function *func = NULL;\r\nDBG("pmf: Adding functions for platform-do-%s\n", name);\r\nwhile (length >= 12) {\r\nfunc = kzalloc(sizeof(struct pmf_function), GFP_KERNEL);\r\nif (func == NULL)\r\ngoto bail;\r\nkref_init(&func->ref);\r\nINIT_LIST_HEAD(&func->irq_clients);\r\nfunc->node = dev->node;\r\nfunc->driver_data = driverdata;\r\nfunc->name = name;\r\nfunc->phandle = data[0];\r\nfunc->flags = data[1];\r\ndata += 2;\r\nlength -= 8;\r\nfunc->data = data;\r\nfunc->length = length;\r\nfunc->dev = dev;\r\nDBG("pmf: idx %d: flags=%08x, phandle=%08x "\r\n" %d bytes remaining, parsing...\n",\r\ncount+1, func->flags, func->phandle, length);\r\nif (pmf_parse_one(func, NULL, NULL, NULL)) {\r\nkfree(func);\r\ngoto bail;\r\n}\r\nlength -= func->length;\r\ndata = (u32 *)(((u8 *)data) + func->length);\r\nlist_add(&func->link, &dev->functions);\r\npmf_get_device(dev);\r\ncount++;\r\n}\r\nbail:\r\nDBG("pmf: Added %d functions\n", count);\r\nreturn count;\r\n}\r\nstatic int pmf_add_functions(struct pmf_device *dev, void *driverdata)\r\n{\r\nstruct property *pp;\r\n#define PP_PREFIX "platform-do-"\r\nconst int plen = strlen(PP_PREFIX);\r\nint count = 0;\r\nfor (pp = dev->node->properties; pp != 0; pp = pp->next) {\r\nchar *name;\r\nif (strncmp(pp->name, PP_PREFIX, plen) != 0)\r\ncontinue;\r\nname = pp->name + plen;\r\nif (strlen(name) && pp->length >= 12)\r\ncount += pmf_add_function_prop(dev, driverdata, name,\r\npp->value, pp->length);\r\n}\r\nreturn count;\r\n}\r\nint pmf_register_driver(struct device_node *np,\r\nstruct pmf_handlers *handlers,\r\nvoid *driverdata)\r\n{\r\nstruct pmf_device *dev;\r\nunsigned long flags;\r\nint rc = 0;\r\nif (handlers == NULL)\r\nreturn -EINVAL;\r\nDBG("pmf: registering driver for node %s\n", np->full_name);\r\nspin_lock_irqsave(&pmf_lock, flags);\r\ndev = pmf_find_device(np);\r\nspin_unlock_irqrestore(&pmf_lock, flags);\r\nif (dev != NULL) {\r\nDBG("pmf: already there !\n");\r\npmf_put_device(dev);\r\nreturn -EBUSY;\r\n}\r\ndev = kzalloc(sizeof(struct pmf_device), GFP_KERNEL);\r\nif (dev == NULL) {\r\nDBG("pmf: no memory !\n");\r\nreturn -ENOMEM;\r\n}\r\nkref_init(&dev->ref);\r\ndev->node = of_node_get(np);\r\ndev->handlers = handlers;\r\nINIT_LIST_HEAD(&dev->functions);\r\nrc = pmf_add_functions(dev, driverdata);\r\nif (rc == 0) {\r\nDBG("pmf: no functions, disposing.. \n");\r\nof_node_put(np);\r\nkfree(dev);\r\nreturn -ENODEV;\r\n}\r\nspin_lock_irqsave(&pmf_lock, flags);\r\nlist_add(&dev->link, &pmf_devices);\r\nspin_unlock_irqrestore(&pmf_lock, flags);\r\nreturn 0;\r\n}\r\nstruct pmf_function *pmf_get_function(struct pmf_function *func)\r\n{\r\nif (!try_module_get(func->dev->handlers->owner))\r\nreturn NULL;\r\nkref_get(&func->ref);\r\nreturn func;\r\n}\r\nstatic void pmf_release_function(struct kref *kref)\r\n{\r\nstruct pmf_function *func =\r\ncontainer_of(kref, struct pmf_function, ref);\r\npmf_put_device(func->dev);\r\nkfree(func);\r\n}\r\nstatic inline void __pmf_put_function(struct pmf_function *func)\r\n{\r\nkref_put(&func->ref, pmf_release_function);\r\n}\r\nvoid pmf_put_function(struct pmf_function *func)\r\n{\r\nif (func == NULL)\r\nreturn;\r\nmodule_put(func->dev->handlers->owner);\r\n__pmf_put_function(func);\r\n}\r\nvoid pmf_unregister_driver(struct device_node *np)\r\n{\r\nstruct pmf_device *dev;\r\nunsigned long flags;\r\nDBG("pmf: unregistering driver for node %s\n", np->full_name);\r\nspin_lock_irqsave(&pmf_lock, flags);\r\ndev = pmf_find_device(np);\r\nif (dev == NULL) {\r\nDBG("pmf: not such driver !\n");\r\nspin_unlock_irqrestore(&pmf_lock, flags);\r\nreturn;\r\n}\r\nlist_del(&dev->link);\r\nwhile(!list_empty(&dev->functions)) {\r\nstruct pmf_function *func =\r\nlist_entry(dev->functions.next, typeof(*func), link);\r\nlist_del(&func->link);\r\n__pmf_put_function(func);\r\n}\r\npmf_put_device(dev);\r\nspin_unlock_irqrestore(&pmf_lock, flags);\r\n}\r\nstruct pmf_function *__pmf_find_function(struct device_node *target,\r\nconst char *name, u32 flags)\r\n{\r\nstruct device_node *actor = of_node_get(target);\r\nstruct pmf_device *dev;\r\nstruct pmf_function *func, *result = NULL;\r\nchar fname[64];\r\nconst u32 *prop;\r\nu32 ph;\r\nsnprintf(fname, 63, "platform-%s", name);\r\nprop = of_get_property(target, fname, NULL);\r\nif (prop == NULL)\r\ngoto find_it;\r\nph = *prop;\r\nif (ph == 0)\r\ngoto find_it;\r\nof_node_put(actor);\r\nactor = of_find_node_by_phandle(ph);\r\nif (actor == NULL)\r\nreturn NULL;\r\nfind_it:\r\ndev = pmf_find_device(actor);\r\nif (dev == NULL) {\r\nresult = NULL;\r\ngoto out;\r\n}\r\nlist_for_each_entry(func, &dev->functions, link) {\r\nif (name && strcmp(name, func->name))\r\ncontinue;\r\nif (func->phandle && target->phandle != func->phandle)\r\ncontinue;\r\nif ((func->flags & flags) == 0)\r\ncontinue;\r\nresult = func;\r\nbreak;\r\n}\r\npmf_put_device(dev);\r\nout:\r\nof_node_put(actor);\r\nreturn result;\r\n}\r\nint pmf_register_irq_client(struct device_node *target,\r\nconst char *name,\r\nstruct pmf_irq_client *client)\r\n{\r\nstruct pmf_function *func;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pmf_lock, flags);\r\nfunc = __pmf_find_function(target, name, PMF_FLAGS_INT_GEN);\r\nif (func)\r\nfunc = pmf_get_function(func);\r\nspin_unlock_irqrestore(&pmf_lock, flags);\r\nif (func == NULL)\r\nreturn -ENODEV;\r\nmutex_lock(&pmf_irq_mutex);\r\nif (list_empty(&func->irq_clients))\r\nfunc->dev->handlers->irq_enable(func);\r\nspin_lock_irqsave(&pmf_lock, flags);\r\nlist_add(&client->link, &func->irq_clients);\r\nspin_unlock_irqrestore(&pmf_lock, flags);\r\nclient->func = func;\r\nmutex_unlock(&pmf_irq_mutex);\r\nreturn 0;\r\n}\r\nvoid pmf_unregister_irq_client(struct pmf_irq_client *client)\r\n{\r\nstruct pmf_function *func = client->func;\r\nunsigned long flags;\r\nBUG_ON(func == NULL);\r\nmutex_lock(&pmf_irq_mutex);\r\nclient->func = NULL;\r\nspin_lock_irqsave(&pmf_lock, flags);\r\nlist_del(&client->link);\r\nspin_unlock_irqrestore(&pmf_lock, flags);\r\nif (list_empty(&func->irq_clients))\r\nfunc->dev->handlers->irq_disable(func);\r\nmutex_unlock(&pmf_irq_mutex);\r\npmf_put_function(func);\r\n}\r\nvoid pmf_do_irq(struct pmf_function *func)\r\n{\r\nunsigned long flags;\r\nstruct pmf_irq_client *client;\r\nspin_lock_irqsave(&pmf_lock, flags);\r\nlist_for_each_entry(client, &func->irq_clients, link) {\r\nif (!try_module_get(client->owner))\r\ncontinue;\r\nclient->handler(client->data);\r\nmodule_put(client->owner);\r\n}\r\nspin_unlock_irqrestore(&pmf_lock, flags);\r\n}\r\nint pmf_call_one(struct pmf_function *func, struct pmf_args *args)\r\n{\r\nstruct pmf_device *dev = func->dev;\r\nvoid *instdata = NULL;\r\nint rc = 0;\r\nDBG(" ** pmf_call_one(%s/%s) **\n", dev->node->full_name, func->name);\r\nif (dev->handlers->begin)\r\ninstdata = dev->handlers->begin(func, args);\r\nrc = pmf_parse_one(func, dev->handlers, instdata, args);\r\nif (dev->handlers->end)\r\ndev->handlers->end(func, instdata);\r\nreturn rc;\r\n}\r\nint pmf_do_functions(struct device_node *np, const char *name,\r\nu32 phandle, u32 fflags, struct pmf_args *args)\r\n{\r\nstruct pmf_device *dev;\r\nstruct pmf_function *func, *tmp;\r\nunsigned long flags;\r\nint rc = -ENODEV;\r\nspin_lock_irqsave(&pmf_lock, flags);\r\ndev = pmf_find_device(np);\r\nif (dev == NULL) {\r\nspin_unlock_irqrestore(&pmf_lock, flags);\r\nreturn -ENODEV;\r\n}\r\nlist_for_each_entry_safe(func, tmp, &dev->functions, link) {\r\nif (name && strcmp(name, func->name))\r\ncontinue;\r\nif (phandle && func->phandle && phandle != func->phandle)\r\ncontinue;\r\nif ((func->flags & fflags) == 0)\r\ncontinue;\r\nif (pmf_get_function(func) == NULL)\r\ncontinue;\r\nspin_unlock_irqrestore(&pmf_lock, flags);\r\nrc = pmf_call_one(func, args);\r\npmf_put_function(func);\r\nspin_lock_irqsave(&pmf_lock, flags);\r\n}\r\npmf_put_device(dev);\r\nspin_unlock_irqrestore(&pmf_lock, flags);\r\nreturn rc;\r\n}\r\nstruct pmf_function *pmf_find_function(struct device_node *target,\r\nconst char *name)\r\n{\r\nstruct pmf_function *func;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pmf_lock, flags);\r\nfunc = __pmf_find_function(target, name, PMF_FLAGS_ON_DEMAND);\r\nif (func)\r\nfunc = pmf_get_function(func);\r\nspin_unlock_irqrestore(&pmf_lock, flags);\r\nreturn func;\r\n}\r\nint pmf_call_function(struct device_node *target, const char *name,\r\nstruct pmf_args *args)\r\n{\r\nstruct pmf_function *func = pmf_find_function(target, name);\r\nint rc;\r\nif (func == NULL)\r\nreturn -ENODEV;\r\nrc = pmf_call_one(func, args);\r\npmf_put_function(func);\r\nreturn rc;\r\n}

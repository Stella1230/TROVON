static void write_rtl8225(struct net_device *dev, u8 adr, u16 data)\r\n{\r\nint i;\r\nu16 out, select;\r\nu8 bit;\r\nu32 bangdata = (data << 4) | (adr & 0xf);\r\nout = read_nic_word(dev, RFPinsOutput) & 0xfff3;\r\nwrite_nic_word(dev, RFPinsEnable,\r\n(read_nic_word(dev, RFPinsEnable) | 0x7));\r\nselect = read_nic_word(dev, RFPinsSelect);\r\nwrite_nic_word(dev, RFPinsSelect, select | 0x7 |\r\nSW_CONTROL_GPIO);\r\nforce_pci_posting(dev);\r\nudelay(10);\r\nwrite_nic_word(dev, RFPinsOutput, out | BB_HOST_BANG_EN);\r\nforce_pci_posting(dev);\r\nudelay(2);\r\nwrite_nic_word(dev, RFPinsOutput, out);\r\nforce_pci_posting(dev);\r\nudelay(10);\r\nfor (i = 15; i >= 0; i--) {\r\nbit = (bangdata & (1 << i)) >> i;\r\nwrite_nic_word(dev, RFPinsOutput, bit | out);\r\nwrite_nic_word(dev, RFPinsOutput, bit | out | BB_HOST_BANG_CLK);\r\nwrite_nic_word(dev, RFPinsOutput, bit | out | BB_HOST_BANG_CLK);\r\ni--;\r\nbit = (bangdata & (1 << i)) >> i;\r\nwrite_nic_word(dev, RFPinsOutput, bit | out | BB_HOST_BANG_CLK);\r\nwrite_nic_word(dev, RFPinsOutput, bit | out | BB_HOST_BANG_CLK);\r\nwrite_nic_word(dev, RFPinsOutput, bit | out);\r\n}\r\nwrite_nic_word(dev, RFPinsOutput, out | BB_HOST_BANG_EN);\r\nforce_pci_posting(dev);\r\nudelay(10);\r\nwrite_nic_word(dev, RFPinsOutput, out | BB_HOST_BANG_EN);\r\nwrite_nic_word(dev, RFPinsSelect, select | SW_CONTROL_GPIO);\r\nrtl8185_rf_pins_enable(dev);\r\n}\r\nstatic void rtl8225_SetTXPowerLevel(struct net_device *dev, short ch)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nint GainIdx;\r\nint GainSetting;\r\nint i;\r\nu8 power;\r\nconst u8 *cck_power_table;\r\nu8 max_cck_power_level;\r\nu8 max_ofdm_power_level;\r\nu8 min_ofdm_power_level;\r\nu8 cck_power_level = 0xff & priv->chtxpwr[ch];\r\nu8 ofdm_power_level = 0xff & priv->chtxpwr_ofdm[ch];\r\nmax_cck_power_level = 35;\r\nmax_ofdm_power_level = 35;\r\nmin_ofdm_power_level = 0;\r\nif (cck_power_level > max_cck_power_level)\r\ncck_power_level = max_cck_power_level;\r\nGainIdx = cck_power_level % 6;\r\nGainSetting = cck_power_level / 6;\r\nif (ch == 14)\r\ncck_power_table = rtl8225_tx_power_cck_ch14;\r\nelse\r\ncck_power_table = rtl8225_tx_power_cck;\r\nwrite_nic_byte(dev, TX_GAIN_CCK,\r\nrtl8225_tx_gain_cck_ofdm[GainSetting] >> 1);\r\nfor (i = 0; i < 8; i++) {\r\npower = cck_power_table[GainIdx * 8 + i];\r\nwrite_phy_cck(dev, 0x44 + i, power);\r\n}\r\nforce_pci_posting(dev);\r\nmdelay(1);\r\nif (ofdm_power_level > (max_ofdm_power_level - min_ofdm_power_level))\r\nofdm_power_level = max_ofdm_power_level;\r\nelse\r\nofdm_power_level += min_ofdm_power_level;\r\nif (ofdm_power_level > 35)\r\nofdm_power_level = 35;\r\nGainIdx = ofdm_power_level % 6;\r\nGainSetting = ofdm_power_level / 6;\r\nrtl8185_set_anaparam2(dev, RTL8225_ANAPARAM2_ON);\r\nwrite_phy_ofdm(dev, 2, 0x42);\r\nwrite_phy_ofdm(dev, 6, 0x00);\r\nwrite_phy_ofdm(dev, 8, 0x00);\r\nwrite_nic_byte(dev, TX_GAIN_OFDM,\r\nrtl8225_tx_gain_cck_ofdm[GainSetting] >> 1);\r\npower = rtl8225_tx_power_ofdm[GainIdx];\r\nwrite_phy_ofdm(dev, 5, power);\r\nwrite_phy_ofdm(dev, 7, power);\r\nforce_pci_posting(dev);\r\nmdelay(1);\r\n}\r\nvoid rtl8225z2_set_gain(struct net_device *dev, short gain)\r\n{\r\nconst u8 *rtl8225_gain;\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nu8 mode = priv->ieee80211->mode;\r\nif (mode == IEEE_B || mode == IEEE_G)\r\nrtl8225_gain = rtl8225z2_gain_bg;\r\nelse\r\nrtl8225_gain = rtl8225z2_gain_a;\r\nwrite_phy_ofdm(dev, 0x0b, rtl8225_gain[gain * 3]);\r\nwrite_phy_ofdm(dev, 0x1b, rtl8225_gain[gain * 3 + 1]);\r\nwrite_phy_ofdm(dev, 0x1d, rtl8225_gain[gain * 3 + 2]);\r\nwrite_phy_ofdm(dev, 0x21, 0x37);\r\n}\r\nstatic u32 read_rtl8225(struct net_device *dev, u8 adr)\r\n{\r\nu32 data2Write = ((u32)(adr & 0x1f)) << 27;\r\nu32 dataRead;\r\nu32 mask;\r\nu16 oval, oval2, oval3, tmp;\r\nint i;\r\nshort bit, rw;\r\nu8 wLength = 6;\r\nu8 rLength = 12;\r\nu8 low2high = 0;\r\noval = read_nic_word(dev, RFPinsOutput);\r\noval2 = read_nic_word(dev, RFPinsEnable);\r\noval3 = read_nic_word(dev, RFPinsSelect);\r\nwrite_nic_word(dev, RFPinsEnable, (oval2|0xf));\r\nwrite_nic_word(dev, RFPinsSelect, (oval3|0xf));\r\ndataRead = 0;\r\noval &= ~0xf;\r\nwrite_nic_word(dev, RFPinsOutput, oval | BB_HOST_BANG_EN);\r\nudelay(4);\r\nwrite_nic_word(dev, RFPinsOutput, oval);\r\nudelay(5);\r\nrw = 0;\r\nmask = (low2high) ? 0x01 : (((u32)0x01)<<(32-1));\r\nfor (i = 0; i < wLength/2; i++) {\r\nbit = ((data2Write&mask) != 0) ? 1 : 0;\r\nwrite_nic_word(dev, RFPinsOutput, bit | oval | rw);\r\nudelay(1);\r\nwrite_nic_word(dev, RFPinsOutput,\r\nbit | oval | BB_HOST_BANG_CLK | rw);\r\nudelay(2);\r\nwrite_nic_word(dev, RFPinsOutput,\r\nbit | oval | BB_HOST_BANG_CLK | rw);\r\nudelay(2);\r\nmask = (low2high) ? (mask<<1) : (mask>>1);\r\nif (i == 2) {\r\nrw = BB_HOST_BANG_RW;\r\nwrite_nic_word(dev, RFPinsOutput,\r\nbit | oval | BB_HOST_BANG_CLK | rw);\r\nudelay(2);\r\nwrite_nic_word(dev, RFPinsOutput, bit | oval | rw);\r\nudelay(2);\r\nbreak;\r\n}\r\nbit = ((data2Write&mask) != 0) ? 1 : 0;\r\nwrite_nic_word(dev, RFPinsOutput,\r\noval | bit | rw | BB_HOST_BANG_CLK);\r\nudelay(2);\r\nwrite_nic_word(dev, RFPinsOutput,\r\noval | bit | rw | BB_HOST_BANG_CLK);\r\nudelay(2);\r\nwrite_nic_word(dev, RFPinsOutput, oval | bit | rw);\r\nudelay(1);\r\nmask = (low2high) ? (mask<<1) : (mask>>1);\r\n}\r\nwrite_nic_word(dev, RFPinsOutput, rw|oval);\r\nudelay(2);\r\nmask = (low2high) ? 0x01 : (((u32)0x01) << (12-1));\r\nwrite_nic_word(dev, RFPinsEnable, (oval2 & (~0x01)));\r\nfor (i = 0; i < rLength; i++) {\r\nwrite_nic_word(dev, RFPinsOutput, rw|oval); udelay(1);\r\nwrite_nic_word(dev, RFPinsOutput, rw|oval|BB_HOST_BANG_CLK);\r\nudelay(2);\r\nwrite_nic_word(dev, RFPinsOutput, rw|oval|BB_HOST_BANG_CLK);\r\nudelay(2);\r\nwrite_nic_word(dev, RFPinsOutput, rw|oval|BB_HOST_BANG_CLK);\r\nudelay(2);\r\ntmp = read_nic_word(dev, RFPinsInput);\r\ndataRead |= (tmp & BB_HOST_BANG_CLK ? mask : 0);\r\nwrite_nic_word(dev, RFPinsOutput, (rw|oval)); udelay(2);\r\nmask = (low2high) ? (mask<<1) : (mask>>1);\r\n}\r\nwrite_nic_word(dev, RFPinsOutput,\r\nBB_HOST_BANG_EN | BB_HOST_BANG_RW | oval);\r\nudelay(2);\r\nwrite_nic_word(dev, RFPinsEnable, oval2);\r\nwrite_nic_word(dev, RFPinsSelect, oval3);\r\nwrite_nic_word(dev, RFPinsOutput, 0x3a0);\r\nreturn dataRead;\r\n}\r\nshort rtl8225_is_V_z2(struct net_device *dev)\r\n{\r\nshort vz2 = 1;\r\nif (read_rtl8225(dev, 8) != 0x588)\r\nvz2 = 0;\r\nelse\r\nif (read_rtl8225(dev, 9) != 0x700)\r\nvz2 = 0;\r\nwrite_rtl8225(dev, 0, 0xb7);\r\nreturn vz2;\r\n}\r\nvoid rtl8225z2_rf_close(struct net_device *dev)\r\n{\r\nRF_WriteReg(dev, 0x4, 0x1f);\r\nforce_pci_posting(dev);\r\nmdelay(1);\r\nrtl8180_set_anaparam(dev, RTL8225z2_ANAPARAM_OFF);\r\nrtl8185_set_anaparam2(dev, RTL8225z2_ANAPARAM2_OFF);\r\n}\r\ns8 DbmToTxPwrIdx(struct r8180_priv *priv, WIRELESS_MODE WirelessMode,\r\ns32 PowerInDbm)\r\n{\r\nbool bUseDefault = true;\r\ns8 TxPwrIdx = 0;\r\ns32 tmp = 0;\r\nif (WirelessMode == WIRELESS_MODE_G) {\r\nbUseDefault = false;\r\ntmp = (2 * PowerInDbm);\r\nif (tmp < 0)\r\nTxPwrIdx = 0;\r\nelse if (tmp > 40)\r\nTxPwrIdx = 40;\r\nelse\r\nTxPwrIdx = (s8)tmp;\r\n} else if (WirelessMode == WIRELESS_MODE_B) {\r\nbUseDefault = false;\r\ntmp = (4 * PowerInDbm) - 52;\r\nif (tmp < 0)\r\nTxPwrIdx = 0;\r\nelse if (tmp > 28)\r\nTxPwrIdx = 28;\r\nelse\r\nTxPwrIdx = (s8)tmp;\r\n}\r\nif (bUseDefault) {\r\nif (PowerInDbm < 0)\r\nTxPwrIdx = 0;\r\nelse if (PowerInDbm > 35)\r\nTxPwrIdx = 35;\r\nelse\r\nTxPwrIdx = (u8)PowerInDbm;\r\n}\r\nreturn TxPwrIdx;\r\n}\r\nvoid rtl8225z2_SetTXPowerLevel(struct net_device *dev, short ch)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nu8 max_cck_power_level;\r\nu8 max_ofdm_power_level;\r\nu8 min_ofdm_power_level;\r\nchar cck_power_level = (char)(0xff & priv->chtxpwr[ch]);\r\nchar ofdm_power_level = (char)(0xff & priv->chtxpwr_ofdm[ch]);\r\nif (IS_DOT11D_ENABLE(priv->ieee80211) &&\r\nIS_DOT11D_STATE_DONE(priv->ieee80211)) {\r\nu8 MaxTxPwrInDbm = DOT11D_GetMaxTxPwrInDbm(priv->ieee80211, ch);\r\nu8 CckMaxPwrIdx = DbmToTxPwrIdx(priv, WIRELESS_MODE_B,\r\nMaxTxPwrInDbm);\r\nu8 OfdmMaxPwrIdx = DbmToTxPwrIdx(priv, WIRELESS_MODE_G,\r\nMaxTxPwrInDbm);\r\nif (cck_power_level > CckMaxPwrIdx)\r\ncck_power_level = CckMaxPwrIdx;\r\nif (ofdm_power_level > OfdmMaxPwrIdx)\r\nofdm_power_level = OfdmMaxPwrIdx;\r\n}\r\nmax_cck_power_level = 15;\r\nmax_ofdm_power_level = 25;\r\nmin_ofdm_power_level = 10;\r\nif (cck_power_level > 35)\r\ncck_power_level = 35;\r\nwrite_nic_byte(dev, CCK_TXAGC,\r\n(ZEBRA2_CCK_OFDM_GAIN_SETTING[(u8)cck_power_level]));\r\nforce_pci_posting(dev);\r\nmdelay(1);\r\nif (ofdm_power_level > 35)\r\nofdm_power_level = 35;\r\nif (priv->up == 0) {\r\nwrite_phy_ofdm(dev, 2, 0x42);\r\nwrite_phy_ofdm(dev, 5, 0x00);\r\nwrite_phy_ofdm(dev, 6, 0x40);\r\nwrite_phy_ofdm(dev, 7, 0x00);\r\nwrite_phy_ofdm(dev, 8, 0x40);\r\n}\r\nwrite_nic_byte(dev, OFDM_TXAGC,\r\nZEBRA2_CCK_OFDM_GAIN_SETTING[(u8)ofdm_power_level]);\r\nif (ofdm_power_level <= 11) {\r\nwrite_phy_ofdm(dev, 0x07, 0x5c);\r\nwrite_phy_ofdm(dev, 0x09, 0x5c);\r\n}\r\nif (ofdm_power_level <= 17) {\r\nwrite_phy_ofdm(dev, 0x07, 0x54);\r\nwrite_phy_ofdm(dev, 0x09, 0x54);\r\n} else {\r\nwrite_phy_ofdm(dev, 0x07, 0x50);\r\nwrite_phy_ofdm(dev, 0x09, 0x50);\r\n}\r\nforce_pci_posting(dev);\r\nmdelay(1);\r\n}\r\nvoid rtl8225z2_rf_set_chan(struct net_device *dev, short ch)\r\n{\r\nrtl8225z2_SetTXPowerLevel(dev, ch);\r\nRF_WriteReg(dev, 0x7, rtl8225_chan[ch]);\r\nif ((RF_ReadReg(dev, 0x7) & 0x0F80) != rtl8225_chan[ch])\r\nRF_WriteReg(dev, 0x7, rtl8225_chan[ch]);\r\nmdelay(1);\r\nforce_pci_posting(dev);\r\nmdelay(10);\r\n}\r\nstatic void rtl8225_host_pci_init(struct net_device *dev)\r\n{\r\nwrite_nic_word(dev, RFPinsOutput, 0x480);\r\nrtl8185_rf_pins_enable(dev);\r\nwrite_nic_word(dev, RFPinsSelect, 0x88 | SW_CONTROL_GPIO);\r\nwrite_nic_byte(dev, GP_ENABLE, 0);\r\nforce_pci_posting(dev);\r\nmdelay(200);\r\nwrite_nic_word(dev, GP_ENABLE, 0xff & (~(1 << 6)));\r\n}\r\nstatic void rtl8225_rf_set_chan(struct net_device *dev, short ch)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nshort gset = (priv->ieee80211->state == IEEE80211_LINKED &&\r\nieee80211_is_54g(priv->ieee80211->current_network)) ||\r\npriv->ieee80211->iw_mode == IW_MODE_MONITOR;\r\nrtl8225_SetTXPowerLevel(dev, ch);\r\nwrite_rtl8225(dev, 0x7, rtl8225_chan[ch]);\r\nforce_pci_posting(dev);\r\nmdelay(10);\r\nif (gset) {\r\nwrite_nic_byte(dev, SIFS, 0x22);\r\nwrite_nic_byte(dev, DIFS, 0x14);\r\n} else {\r\nwrite_nic_byte(dev, SIFS, 0x44);\r\nwrite_nic_byte(dev, DIFS, 0x24);\r\n}\r\nif (priv->ieee80211->state == IEEE80211_LINKED &&\r\nieee80211_is_shortslot(priv->ieee80211->current_network))\r\nwrite_nic_byte(dev, SLOT, 0x9);\r\nelse\r\nwrite_nic_byte(dev, SLOT, 0x14);\r\nif (gset) {\r\nwrite_nic_byte(dev, EIFS, 81);\r\nwrite_nic_byte(dev, CW_VAL, 0x73);\r\n} else {\r\nwrite_nic_byte(dev, EIFS, 81);\r\nwrite_nic_byte(dev, CW_VAL, 0xa5);\r\n}\r\n}\r\nvoid rtl8225z2_rf_init(struct net_device *dev)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nint i;\r\nshort channel = 1;\r\nu16 brsr;\r\nu32 data, addr;\r\npriv->chan = channel;\r\nrtl8225_host_pci_init(dev);\r\nwrite_nic_dword(dev, RF_TIMING, 0x000a8008);\r\nbrsr = read_nic_word(dev, BRSR);\r\nwrite_nic_word(dev, BRSR, 0xffff);\r\nwrite_nic_dword(dev, RF_PARA, 0x100044);\r\nrtl8180_set_mode(dev, EPROM_CMD_CONFIG);\r\nwrite_nic_byte(dev, CONFIG3, 0x44);\r\nrtl8180_set_mode(dev, EPROM_CMD_NORMAL);\r\nrtl8185_rf_pins_enable(dev);\r\nwrite_rtl8225(dev, 0x0, 0x2bf); mdelay(1);\r\nwrite_rtl8225(dev, 0x1, 0xee0); mdelay(1);\r\nwrite_rtl8225(dev, 0x2, 0x44d); mdelay(1);\r\nwrite_rtl8225(dev, 0x3, 0x441); mdelay(1);\r\nwrite_rtl8225(dev, 0x4, 0x8c3); mdelay(1);\r\nwrite_rtl8225(dev, 0x5, 0xc72); mdelay(1);\r\nwrite_rtl8225(dev, 0x6, 0xe6); mdelay(1);\r\nwrite_rtl8225(dev, 0x7, rtl8225_chan[channel]); mdelay(1);\r\nwrite_rtl8225(dev, 0x8, 0x3f); mdelay(1);\r\nwrite_rtl8225(dev, 0x9, 0x335); mdelay(1);\r\nwrite_rtl8225(dev, 0xa, 0x9d4); mdelay(1);\r\nwrite_rtl8225(dev, 0xb, 0x7bb); mdelay(1);\r\nwrite_rtl8225(dev, 0xc, 0x850); mdelay(1);\r\nwrite_rtl8225(dev, 0xd, 0xcdf); mdelay(1);\r\nwrite_rtl8225(dev, 0xe, 0x2b); mdelay(1);\r\nwrite_rtl8225(dev, 0xf, 0x114);\r\nmdelay(100);\r\nwrite_rtl8225(dev, 0x0, 0x1b7);\r\nfor (i = 0; i < 95; i++) {\r\nwrite_rtl8225(dev, 0x1, (u8)(i + 1));\r\nwrite_rtl8225(dev, 0x2, rtl8225z2_rxgain[i]);\r\n}\r\nwrite_rtl8225(dev, 0x3, 0x80);\r\nwrite_rtl8225(dev, 0x5, 0x4);\r\nwrite_rtl8225(dev, 0x0, 0xb7);\r\nwrite_rtl8225(dev, 0x2, 0xc4d);\r\ndata = read_rtl8225(dev, 6);\r\nif (!(data & 0x00000080)) {\r\nwrite_rtl8225(dev, 0x02, 0x0c4d);\r\nforce_pci_posting(dev); mdelay(200);\r\nwrite_rtl8225(dev, 0x02, 0x044d);\r\nforce_pci_posting(dev); mdelay(100);\r\ndata = read_rtl8225(dev, 6);\r\nif (!(data & 0x00000080))\r\nDMESGW("RF Calibration Failed!!!!\n");\r\n}\r\nmdelay(200);\r\nwrite_rtl8225(dev, 0x0, 0x2bf);\r\nfor (i = 0; i < 128; i++) {\r\ndata = rtl8225_agc[i];\r\naddr = i + 0x80;\r\nwrite_phy_ofdm(dev, 0xb, data);\r\nmdelay(1);\r\nwrite_phy_ofdm(dev, 0xa, addr);\r\nmdelay(1);\r\n}\r\nforce_pci_posting(dev);\r\nmdelay(1);\r\nwrite_phy_ofdm(dev, 0x00, 0x01); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x01, 0x02); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x02, 0x62); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x03, 0x00); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x04, 0x00); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x05, 0x00); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x06, 0x40); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x07, 0x00); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x08, 0x40); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x09, 0xfe); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x0a, 0x08); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x0b, 0x80); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x0c, 0x01); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x0d, 0x43);\r\nwrite_phy_ofdm(dev, 0x0e, 0xd3); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x0f, 0x38); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x10, 0x84); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x11, 0x07); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x12, 0x20); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x13, 0x20); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x14, 0x00); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x15, 0x40); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x16, 0x00); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x17, 0x40); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x18, 0xef); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x19, 0x19); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x1a, 0x20); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x1b, 0x15); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x1c, 0x04); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x1d, 0xc5); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x1e, 0x95); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x1f, 0x75); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x20, 0x1f); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x21, 0x17); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x22, 0x16); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x23, 0x80); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x24, 0x46); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x25, 0x00); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x26, 0x90); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x27, 0x88); mdelay(1);\r\nrtl8225z2_set_gain(dev, 4);\r\nwrite_phy_cck(dev, 0x0, 0x98); mdelay(1);\r\nwrite_phy_cck(dev, 0x3, 0x20); mdelay(1);\r\nwrite_phy_cck(dev, 0x4, 0x7e); mdelay(1);\r\nwrite_phy_cck(dev, 0x5, 0x12); mdelay(1);\r\nwrite_phy_cck(dev, 0x6, 0xfc); mdelay(1);\r\nwrite_phy_cck(dev, 0x7, 0x78); mdelay(1);\r\nwrite_phy_cck(dev, 0x8, 0x2e); mdelay(1);\r\nwrite_phy_cck(dev, 0x10, 0x93); mdelay(1);\r\nwrite_phy_cck(dev, 0x11, 0x88); mdelay(1);\r\nwrite_phy_cck(dev, 0x12, 0x47); mdelay(1);\r\nwrite_phy_cck(dev, 0x13, 0xd0);\r\nwrite_phy_cck(dev, 0x19, 0x00);\r\nwrite_phy_cck(dev, 0x1a, 0xa0);\r\nwrite_phy_cck(dev, 0x1b, 0x08);\r\nwrite_phy_cck(dev, 0x40, 0x86);\r\nwrite_phy_cck(dev, 0x41, 0x8d); mdelay(1);\r\nwrite_phy_cck(dev, 0x42, 0x15); mdelay(1);\r\nwrite_phy_cck(dev, 0x43, 0x18); mdelay(1);\r\nwrite_phy_cck(dev, 0x44, 0x36); mdelay(1);\r\nwrite_phy_cck(dev, 0x45, 0x35); mdelay(1);\r\nwrite_phy_cck(dev, 0x46, 0x2e); mdelay(1);\r\nwrite_phy_cck(dev, 0x47, 0x25); mdelay(1);\r\nwrite_phy_cck(dev, 0x48, 0x1c); mdelay(1);\r\nwrite_phy_cck(dev, 0x49, 0x12); mdelay(1);\r\nwrite_phy_cck(dev, 0x4a, 0x09); mdelay(1);\r\nwrite_phy_cck(dev, 0x4b, 0x04); mdelay(1);\r\nwrite_phy_cck(dev, 0x4c, 0x05); mdelay(1);\r\nwrite_nic_byte(dev, 0x5b, 0x0d); mdelay(1);\r\nrtl8225z2_SetTXPowerLevel(dev, channel);\r\nwrite_phy_cck(dev, 0x11, 0x9b); mdelay(1);\r\nwrite_phy_ofdm(dev, 0x26, 0x90); mdelay(1);\r\nrtl8185_tx_antenna(dev, 0x03);\r\nwrite_nic_dword(dev, 0x94, 0x15c00002);\r\nrtl8185_rf_pins_enable(dev);\r\nrtl8225_rf_set_chan(dev, priv->chan);\r\n}\r\nvoid rtl8225z2_rf_set_mode(struct net_device *dev)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nif (priv->ieee80211->mode == IEEE_A) {\r\nwrite_rtl8225(dev, 0x5, 0x1865);\r\nwrite_nic_dword(dev, RF_PARA, 0x10084);\r\nwrite_nic_dword(dev, RF_TIMING, 0xa8008);\r\nwrite_phy_ofdm(dev, 0x0, 0x0);\r\nwrite_phy_ofdm(dev, 0xa, 0x6);\r\nwrite_phy_ofdm(dev, 0xb, 0x99);\r\nwrite_phy_ofdm(dev, 0xf, 0x20);\r\nwrite_phy_ofdm(dev, 0x11, 0x7);\r\nrtl8225z2_set_gain(dev, 4);\r\nwrite_phy_ofdm(dev, 0x15, 0x40);\r\nwrite_phy_ofdm(dev, 0x17, 0x40);\r\nwrite_nic_dword(dev, 0x94, 0x10000000);\r\n} else {\r\nwrite_rtl8225(dev, 0x5, 0x1864);\r\nwrite_nic_dword(dev, RF_PARA, 0x10044);\r\nwrite_nic_dword(dev, RF_TIMING, 0xa8008);\r\nwrite_phy_ofdm(dev, 0x0, 0x1);\r\nwrite_phy_ofdm(dev, 0xa, 0x6);\r\nwrite_phy_ofdm(dev, 0xb, 0x99);\r\nwrite_phy_ofdm(dev, 0xf, 0x20);\r\nwrite_phy_ofdm(dev, 0x11, 0x7);\r\nrtl8225z2_set_gain(dev, 4);\r\nwrite_phy_ofdm(dev, 0x15, 0x40);\r\nwrite_phy_ofdm(dev, 0x17, 0x40);\r\nwrite_nic_dword(dev, 0x94, 0x04000002);\r\n}\r\n}\r\nbool SetZebraRFPowerState8185(struct net_device *dev,\r\nRT_RF_POWER_STATE eRFPowerState)\r\n{\r\nstruct r8180_priv *priv = ieee80211_priv(dev);\r\nu8 btCR9346, btConfig3;\r\nbool bActionAllowed = true, bTurnOffBB = true;\r\nu8 u1bTmp;\r\nint i;\r\nbool bResult = true;\r\nu8 QueueID;\r\nif (priv->SetRFPowerStateInProgress == true)\r\nreturn false;\r\npriv->SetRFPowerStateInProgress = true;\r\nbtCR9346 = read_nic_byte(dev, CR9346);\r\nwrite_nic_byte(dev, CR9346, (btCR9346 | 0xC0));\r\nbtConfig3 = read_nic_byte(dev, CONFIG3);\r\nwrite_nic_byte(dev, CONFIG3, (btConfig3 | CONFIG3_PARM_En));\r\nswitch (eRFPowerState) {\r\ncase eRfOn:\r\nwrite_nic_word(dev, 0x37C, 0x00EC);\r\nwrite_nic_byte(dev, 0x54, 0x00);\r\nwrite_nic_byte(dev, 0x62, 0x00);\r\nRF_WriteReg(dev, 0x0, 0x009f); udelay(500);\r\nRF_WriteReg(dev, 0x4, 0x0972); udelay(500);\r\nRF_WriteReg(dev, 0x0, 0x009f); udelay(500);\r\nRF_WriteReg(dev, 0x4, 0x0972); udelay(500);\r\nwrite_phy_ofdm(dev, 0x10, 0x40);\r\nwrite_phy_ofdm(dev, 0x12, 0x40);\r\nwrite_nic_byte(dev, CONFIG4, priv->RFProgType);\r\nu1bTmp = read_nic_byte(dev, 0x24E);\r\nwrite_nic_byte(dev, 0x24E, (u1bTmp & (~(BIT5 | BIT6))));\r\nbreak;\r\ncase eRfSleep:\r\nfor (QueueID = 0, i = 0; QueueID < 6;) {\r\nif (get_curr_tx_free_desc(dev, QueueID) ==\r\npriv->txringcount) {\r\nQueueID++;\r\ncontinue;\r\n} else {\r\npriv->TxPollingTimes++;\r\nif (priv->TxPollingTimes >=\r\nLPS_MAX_SLEEP_WAITING_TIMES_87SE) {\r\nbActionAllowed = false;\r\nbreak;\r\n} else\r\nudelay(10);\r\n}\r\n}\r\nif (bActionAllowed) {\r\nwrite_phy_ofdm(dev, 0x10, 0x00);\r\nwrite_phy_ofdm(dev, 0x12, 0x00);\r\nRF_WriteReg(dev, 0x4, 0x0000);\r\nRF_WriteReg(dev, 0x0, 0x0000);\r\nwrite_nic_byte(dev, 0x62, 0xff);\r\nwrite_nic_byte(dev, 0x54, 0xec);\r\nmdelay(1);\r\n{\r\nint i = 0;\r\nwhile (true) {\r\nu8 tmp24F = read_nic_byte(dev, 0x24f);\r\nif ((tmp24F == 0x01) ||\r\n(tmp24F == 0x09)) {\r\nbTurnOffBB = true;\r\nbreak;\r\n} else {\r\nudelay(10);\r\ni++;\r\npriv->TxPollingTimes++;\r\nif (priv->TxPollingTimes >= LPS_MAX_SLEEP_WAITING_TIMES_87SE) {\r\nbTurnOffBB = false;\r\nbreak;\r\n} else\r\nudelay(10);\r\n}\r\n}\r\n}\r\nif (bTurnOffBB) {\r\nu1bTmp = read_nic_byte(dev, 0x24E);\r\nwrite_nic_byte(dev, 0x24E,\r\n(u1bTmp | BIT5 | BIT6));\r\nwrite_nic_byte(dev, 0x54, 0xFC);\r\nwrite_nic_word(dev, 0x37C, 0x00FC);\r\n}\r\n}\r\nbreak;\r\ncase eRfOff:\r\nfor (QueueID = 0, i = 0; QueueID < 6;) {\r\nif (get_curr_tx_free_desc(dev, QueueID) ==\r\npriv->txringcount) {\r\nQueueID++;\r\ncontinue;\r\n} else {\r\nudelay(10);\r\ni++;\r\n}\r\nif (i >= MAX_DOZE_WAITING_TIMES_85B)\r\nbreak;\r\n}\r\nwrite_phy_ofdm(dev, 0x10, 0x00);\r\nwrite_phy_ofdm(dev, 0x12, 0x00);\r\nRF_WriteReg(dev, 0x4, 0x0000);\r\nRF_WriteReg(dev, 0x0, 0x0000);\r\nwrite_nic_byte(dev, 0x62, 0xff);\r\nwrite_nic_byte(dev, 0x54, 0xec);\r\nmdelay(1);\r\n{\r\nint i = 0;\r\nwhile (true) {\r\nu8 tmp24F = read_nic_byte(dev, 0x24f);\r\nif ((tmp24F == 0x01) || (tmp24F == 0x09)) {\r\nbTurnOffBB = true;\r\nbreak;\r\n} else {\r\nbTurnOffBB = false;\r\nudelay(10);\r\ni++;\r\n}\r\nif (i > MAX_POLLING_24F_TIMES_87SE)\r\nbreak;\r\n}\r\n}\r\nif (bTurnOffBB) {\r\nu1bTmp = read_nic_byte(dev, 0x24E);\r\nwrite_nic_byte(dev, 0x24E, (u1bTmp | BIT5 | BIT6));\r\nwrite_nic_byte(dev, 0x54, 0xFC);\r\nwrite_nic_word(dev, 0x37C, 0x00FC);\r\n}\r\nbreak;\r\n}\r\nbtConfig3 &= ~(CONFIG3_PARM_En);\r\nwrite_nic_byte(dev, CONFIG3, btConfig3);\r\nbtCR9346 &= ~(0xC0);\r\nwrite_nic_byte(dev, CR9346, btCR9346);\r\nif (bResult && bActionAllowed)\r\npriv->eRFPowerState = eRFPowerState;\r\npriv->SetRFPowerStateInProgress = false;\r\nreturn bResult && bActionAllowed;\r\n}\r\nvoid rtl8225z4_rf_sleep(struct net_device *dev)\r\n{\r\nMgntActSet_RF_State(dev, eRfSleep, RF_CHANGE_BY_PS);\r\n}\r\nvoid rtl8225z4_rf_wakeup(struct net_device *dev)\r\n{\r\nMgntActSet_RF_State(dev, eRfOn, RF_CHANGE_BY_PS);\r\n}

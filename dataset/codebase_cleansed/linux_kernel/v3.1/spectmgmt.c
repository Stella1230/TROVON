static void ieee80211_send_refuse_measurement_request(struct ieee80211_sub_if_data *sdata,\r\nstruct ieee80211_msrment_ie *request_ie,\r\nconst u8 *da, const u8 *bssid,\r\nu8 dialog_token)\r\n{\r\nstruct ieee80211_local *local = sdata->local;\r\nstruct sk_buff *skb;\r\nstruct ieee80211_mgmt *msr_report;\r\nskb = dev_alloc_skb(sizeof(*msr_report) + local->hw.extra_tx_headroom +\r\nsizeof(struct ieee80211_msrment_ie));\r\nif (!skb) {\r\nprintk(KERN_ERR "%s: failed to allocate buffer for "\r\n"measurement report frame\n", sdata->name);\r\nreturn;\r\n}\r\nskb_reserve(skb, local->hw.extra_tx_headroom);\r\nmsr_report = (struct ieee80211_mgmt *)skb_put(skb, 24);\r\nmemset(msr_report, 0, 24);\r\nmemcpy(msr_report->da, da, ETH_ALEN);\r\nmemcpy(msr_report->sa, sdata->vif.addr, ETH_ALEN);\r\nmemcpy(msr_report->bssid, bssid, ETH_ALEN);\r\nmsr_report->frame_control = cpu_to_le16(IEEE80211_FTYPE_MGMT |\r\nIEEE80211_STYPE_ACTION);\r\nskb_put(skb, 1 + sizeof(msr_report->u.action.u.measurement));\r\nmsr_report->u.action.category = WLAN_CATEGORY_SPECTRUM_MGMT;\r\nmsr_report->u.action.u.measurement.action_code =\r\nWLAN_ACTION_SPCT_MSR_RPRT;\r\nmsr_report->u.action.u.measurement.dialog_token = dialog_token;\r\nmsr_report->u.action.u.measurement.element_id = WLAN_EID_MEASURE_REPORT;\r\nmsr_report->u.action.u.measurement.length =\r\nsizeof(struct ieee80211_msrment_ie);\r\nmemset(&msr_report->u.action.u.measurement.msr_elem, 0,\r\nsizeof(struct ieee80211_msrment_ie));\r\nmsr_report->u.action.u.measurement.msr_elem.token = request_ie->token;\r\nmsr_report->u.action.u.measurement.msr_elem.mode |=\r\nIEEE80211_SPCT_MSR_RPRT_MODE_REFUSED;\r\nmsr_report->u.action.u.measurement.msr_elem.type = request_ie->type;\r\nieee80211_tx_skb(sdata, skb);\r\n}\r\nvoid ieee80211_process_measurement_req(struct ieee80211_sub_if_data *sdata,\r\nstruct ieee80211_mgmt *mgmt,\r\nsize_t len)\r\n{\r\nieee80211_send_refuse_measurement_request(sdata,\r\n&mgmt->u.action.u.measurement.msr_elem,\r\nmgmt->sa, mgmt->bssid,\r\nmgmt->u.action.u.measurement.dialog_token);\r\n}

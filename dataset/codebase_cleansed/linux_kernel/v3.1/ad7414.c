static inline int ad7414_temp_from_reg(s16 reg)\r\n{\r\nreturn ((int)reg / 64) * 250;\r\n}\r\nstatic inline int ad7414_read(struct i2c_client *client, u8 reg)\r\n{\r\nif (reg == AD7414_REG_TEMP) {\r\nint value = i2c_smbus_read_word_data(client, reg);\r\nreturn (value < 0) ? value : swab16(value);\r\n} else\r\nreturn i2c_smbus_read_byte_data(client, reg);\r\n}\r\nstatic inline int ad7414_write(struct i2c_client *client, u8 reg, u8 value)\r\n{\r\nreturn i2c_smbus_write_byte_data(client, reg, value);\r\n}\r\nstatic struct ad7414_data *ad7414_update_device(struct device *dev)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct ad7414_data *data = i2c_get_clientdata(client);\r\nmutex_lock(&data->lock);\r\nif (time_after(jiffies, data->next_update) || !data->valid) {\r\nint value, i;\r\ndev_dbg(&client->dev, "starting ad7414 update\n");\r\nvalue = ad7414_read(client, AD7414_REG_TEMP);\r\nif (value < 0)\r\ndev_dbg(&client->dev, "AD7414_REG_TEMP err %d\n",\r\nvalue);\r\nelse\r\ndata->temp_input = value;\r\nfor (i = 0; i < ARRAY_SIZE(AD7414_REG_LIMIT); ++i) {\r\nvalue = ad7414_read(client, AD7414_REG_LIMIT[i]);\r\nif (value < 0)\r\ndev_dbg(&client->dev, "AD7414 reg %d err %d\n",\r\nAD7414_REG_LIMIT[i], value);\r\nelse\r\ndata->temps[i] = value;\r\n}\r\ndata->next_update = jiffies + HZ + HZ / 2;\r\ndata->valid = 1;\r\n}\r\nmutex_unlock(&data->lock);\r\nreturn data;\r\n}\r\nstatic ssize_t show_temp_input(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct ad7414_data *data = ad7414_update_device(dev);\r\nreturn sprintf(buf, "%d\n", ad7414_temp_from_reg(data->temp_input));\r\n}\r\nstatic ssize_t show_max_min(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nint index = to_sensor_dev_attr(attr)->index;\r\nstruct ad7414_data *data = ad7414_update_device(dev);\r\nreturn sprintf(buf, "%d\n", data->temps[index] * 1000);\r\n}\r\nstatic ssize_t set_max_min(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct ad7414_data *data = i2c_get_clientdata(client);\r\nint index = to_sensor_dev_attr(attr)->index;\r\nu8 reg = AD7414_REG_LIMIT[index];\r\nlong temp = simple_strtol(buf, NULL, 10);\r\ntemp = SENSORS_LIMIT(temp, -40000, 85000);\r\ntemp = (temp + (temp < 0 ? -500 : 500)) / 1000;\r\nmutex_lock(&data->lock);\r\ndata->temps[index] = temp;\r\nad7414_write(client, reg, temp);\r\nmutex_unlock(&data->lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_alarm(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nint bitnr = to_sensor_dev_attr(attr)->index;\r\nstruct ad7414_data *data = ad7414_update_device(dev);\r\nint value = (data->temp_input >> bitnr) & 1;\r\nreturn sprintf(buf, "%d\n", value);\r\n}\r\nstatic int ad7414_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *dev_id)\r\n{\r\nstruct ad7414_data *data;\r\nint conf;\r\nint err;\r\nif (!i2c_check_functionality(client->adapter, I2C_FUNC_SMBUS_BYTE_DATA |\r\nI2C_FUNC_SMBUS_READ_WORD_DATA)) {\r\nerr = -EOPNOTSUPP;\r\ngoto exit;\r\n}\r\ndata = kzalloc(sizeof(struct ad7414_data), GFP_KERNEL);\r\nif (!data) {\r\nerr = -ENOMEM;\r\ngoto exit;\r\n}\r\ni2c_set_clientdata(client, data);\r\nmutex_init(&data->lock);\r\ndev_info(&client->dev, "chip found\n");\r\nconf = i2c_smbus_read_byte_data(client, AD7414_REG_CONF);\r\nif (conf < 0)\r\ndev_warn(&client->dev,\r\n"ad7414_probe unable to read config register.\n");\r\nelse {\r\nconf &= ~(1 << 7);\r\ni2c_smbus_write_byte_data(client, AD7414_REG_CONF, conf);\r\n}\r\nerr = sysfs_create_group(&client->dev.kobj, &ad7414_group);\r\nif (err)\r\ngoto exit_free;\r\ndata->hwmon_dev = hwmon_device_register(&client->dev);\r\nif (IS_ERR(data->hwmon_dev)) {\r\nerr = PTR_ERR(data->hwmon_dev);\r\ngoto exit_remove;\r\n}\r\nreturn 0;\r\nexit_remove:\r\nsysfs_remove_group(&client->dev.kobj, &ad7414_group);\r\nexit_free:\r\nkfree(data);\r\nexit:\r\nreturn err;\r\n}\r\nstatic int __devexit ad7414_remove(struct i2c_client *client)\r\n{\r\nstruct ad7414_data *data = i2c_get_clientdata(client);\r\nhwmon_device_unregister(data->hwmon_dev);\r\nsysfs_remove_group(&client->dev.kobj, &ad7414_group);\r\nkfree(data);\r\nreturn 0;\r\n}\r\nstatic int __init ad7414_init(void)\r\n{\r\nreturn i2c_add_driver(&ad7414_driver);\r\n}\r\nstatic void __exit ad7414_exit(void)\r\n{\r\ni2c_del_driver(&ad7414_driver);\r\n}

static u8 acpi_rs_count_set_bits(u16 bit_field)\r\n{\r\nu8 bits_set;\r\nACPI_FUNCTION_ENTRY();\r\nfor (bits_set = 0; bit_field; bits_set++) {\r\nbit_field &= (u16) (bit_field - 1);\r\n}\r\nreturn bits_set;\r\n}\r\nstatic acpi_rs_length\r\nacpi_rs_struct_option_length(struct acpi_resource_source *resource_source)\r\n{\r\nACPI_FUNCTION_ENTRY();\r\nif (resource_source->string_ptr) {\r\nreturn ((acpi_rs_length) (resource_source->string_length + 1));\r\n}\r\nreturn (0);\r\n}\r\nstatic u32\r\nacpi_rs_stream_option_length(u32 resource_length,\r\nu32 minimum_aml_resource_length)\r\n{\r\nu32 string_length = 0;\r\nACPI_FUNCTION_ENTRY();\r\nif (resource_length > minimum_aml_resource_length) {\r\nstring_length =\r\nresource_length - minimum_aml_resource_length - 1;\r\n}\r\nreturn ((u32) ACPI_ROUND_UP_TO_NATIVE_WORD(string_length));\r\n}\r\nacpi_status\r\nacpi_rs_get_aml_length(struct acpi_resource * resource, acpi_size * size_needed)\r\n{\r\nacpi_size aml_size_needed = 0;\r\nacpi_rs_length total_size;\r\nACPI_FUNCTION_TRACE(rs_get_aml_length);\r\nwhile (resource) {\r\nif (resource->type > ACPI_RESOURCE_TYPE_MAX) {\r\nreturn_ACPI_STATUS(AE_AML_INVALID_RESOURCE_TYPE);\r\n}\r\ntotal_size = acpi_gbl_aml_resource_sizes[resource->type];\r\nswitch (resource->type) {\r\ncase ACPI_RESOURCE_TYPE_IRQ:\r\nif (resource->data.irq.descriptor_length == 2) {\r\ntotal_size--;\r\n}\r\nbreak;\r\ncase ACPI_RESOURCE_TYPE_START_DEPENDENT:\r\nif (resource->data.irq.descriptor_length == 0) {\r\ntotal_size--;\r\n}\r\nbreak;\r\ncase ACPI_RESOURCE_TYPE_VENDOR:\r\nif (resource->data.vendor.byte_length > 7) {\r\ntotal_size =\r\nsizeof(struct aml_resource_large_header);\r\n}\r\ntotal_size = (acpi_rs_length)\r\n(total_size + resource->data.vendor.byte_length);\r\nbreak;\r\ncase ACPI_RESOURCE_TYPE_END_TAG:\r\n*size_needed = aml_size_needed + total_size;\r\nreturn_ACPI_STATUS(AE_OK);\r\ncase ACPI_RESOURCE_TYPE_ADDRESS16:\r\ntotal_size = (acpi_rs_length)\r\n(total_size +\r\nacpi_rs_struct_option_length(&resource->data.\r\naddress16.\r\nresource_source));\r\nbreak;\r\ncase ACPI_RESOURCE_TYPE_ADDRESS32:\r\ntotal_size = (acpi_rs_length)\r\n(total_size +\r\nacpi_rs_struct_option_length(&resource->data.\r\naddress32.\r\nresource_source));\r\nbreak;\r\ncase ACPI_RESOURCE_TYPE_ADDRESS64:\r\ntotal_size = (acpi_rs_length)\r\n(total_size +\r\nacpi_rs_struct_option_length(&resource->data.\r\naddress64.\r\nresource_source));\r\nbreak;\r\ncase ACPI_RESOURCE_TYPE_EXTENDED_IRQ:\r\ntotal_size = (acpi_rs_length)\r\n(total_size +\r\n((resource->data.extended_irq.interrupt_count -\r\n1) * 4) +\r\nacpi_rs_struct_option_length(&resource->data.\r\nextended_irq.\r\nresource_source));\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\naml_size_needed += total_size;\r\nresource =\r\nACPI_ADD_PTR(struct acpi_resource, resource,\r\nresource->length);\r\n}\r\nreturn_ACPI_STATUS(AE_AML_NO_RESOURCE_END_TAG);\r\n}\r\nacpi_status\r\nacpi_rs_get_list_length(u8 * aml_buffer,\r\nu32 aml_buffer_length, acpi_size * size_needed)\r\n{\r\nacpi_status status;\r\nu8 *end_aml;\r\nu8 *buffer;\r\nu32 buffer_size;\r\nu16 temp16;\r\nu16 resource_length;\r\nu32 extra_struct_bytes;\r\nu8 resource_index;\r\nu8 minimum_aml_resource_length;\r\nACPI_FUNCTION_TRACE(rs_get_list_length);\r\n*size_needed = 0;\r\nend_aml = aml_buffer + aml_buffer_length;\r\nwhile (aml_buffer < end_aml) {\r\nstatus = acpi_ut_validate_resource(aml_buffer, &resource_index);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nresource_length = acpi_ut_get_resource_length(aml_buffer);\r\nminimum_aml_resource_length =\r\nacpi_gbl_resource_aml_sizes[resource_index];\r\nextra_struct_bytes = 0;\r\nbuffer =\r\naml_buffer + acpi_ut_get_resource_header_length(aml_buffer);\r\nswitch (acpi_ut_get_resource_type(aml_buffer)) {\r\ncase ACPI_RESOURCE_NAME_IRQ:\r\nACPI_MOVE_16_TO_16(&temp16, buffer);\r\nextra_struct_bytes = acpi_rs_count_set_bits(temp16);\r\nbreak;\r\ncase ACPI_RESOURCE_NAME_DMA:\r\nextra_struct_bytes = acpi_rs_count_set_bits(*buffer);\r\nbreak;\r\ncase ACPI_RESOURCE_NAME_VENDOR_SMALL:\r\ncase ACPI_RESOURCE_NAME_VENDOR_LARGE:\r\nextra_struct_bytes = resource_length;\r\nbreak;\r\ncase ACPI_RESOURCE_NAME_END_TAG:\r\n*size_needed += ACPI_RS_SIZE_MIN;\r\nreturn_ACPI_STATUS(AE_OK);\r\ncase ACPI_RESOURCE_NAME_ADDRESS32:\r\ncase ACPI_RESOURCE_NAME_ADDRESS16:\r\ncase ACPI_RESOURCE_NAME_ADDRESS64:\r\nextra_struct_bytes =\r\nacpi_rs_stream_option_length(resource_length,\r\nminimum_aml_resource_length);\r\nbreak;\r\ncase ACPI_RESOURCE_NAME_EXTENDED_IRQ:\r\nextra_struct_bytes = (buffer[1] - 1) * sizeof(u32);\r\nextra_struct_bytes +=\r\nacpi_rs_stream_option_length(resource_length -\r\nextra_struct_bytes,\r\nminimum_aml_resource_length);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbuffer_size = acpi_gbl_resource_struct_sizes[resource_index] +\r\nextra_struct_bytes;\r\nbuffer_size = (u32) ACPI_ROUND_UP_TO_NATIVE_WORD(buffer_size);\r\n*size_needed += buffer_size;\r\nACPI_DEBUG_PRINT((ACPI_DB_RESOURCES,\r\n"Type %.2X, AmlLength %.2X InternalLength %.2X\n",\r\nacpi_ut_get_resource_type(aml_buffer),\r\nacpi_ut_get_descriptor_length(aml_buffer),\r\nbuffer_size));\r\naml_buffer += acpi_ut_get_descriptor_length(aml_buffer);\r\n}\r\nreturn_ACPI_STATUS(AE_AML_NO_RESOURCE_END_TAG);\r\n}\r\nacpi_status\r\nacpi_rs_get_pci_routing_table_length(union acpi_operand_object *package_object,\r\nacpi_size * buffer_size_needed)\r\n{\r\nu32 number_of_elements;\r\nacpi_size temp_size_needed = 0;\r\nunion acpi_operand_object **top_object_list;\r\nu32 index;\r\nunion acpi_operand_object *package_element;\r\nunion acpi_operand_object **sub_object_list;\r\nu8 name_found;\r\nu32 table_index;\r\nACPI_FUNCTION_TRACE(rs_get_pci_routing_table_length);\r\nnumber_of_elements = package_object->package.count;\r\ntop_object_list = package_object->package.elements;\r\nfor (index = 0; index < number_of_elements; index++) {\r\npackage_element = *top_object_list;\r\nif (!package_element ||\r\n(package_element->common.type != ACPI_TYPE_PACKAGE)) {\r\nreturn_ACPI_STATUS(AE_AML_OPERAND_TYPE);\r\n}\r\nsub_object_list = package_element->package.elements;\r\nname_found = FALSE;\r\nfor (table_index = 0; table_index < 4 && !name_found;\r\ntable_index++) {\r\nif (*sub_object_list &&\r\n((ACPI_TYPE_STRING ==\r\n(*sub_object_list)->common.type) ||\r\n((ACPI_TYPE_LOCAL_REFERENCE ==\r\n(*sub_object_list)->common.type) &&\r\n((*sub_object_list)->reference.class ==\r\nACPI_REFCLASS_NAME)))) {\r\nname_found = TRUE;\r\n} else {\r\nsub_object_list++;\r\n}\r\n}\r\ntemp_size_needed += (sizeof(struct acpi_pci_routing_table) - 4);\r\nif (name_found) {\r\nif ((*sub_object_list)->common.type == ACPI_TYPE_STRING) {\r\ntemp_size_needed += ((acpi_size)\r\n(*sub_object_list)->string.\r\nlength + 1);\r\n} else {\r\ntemp_size_needed +=\r\nacpi_ns_get_pathname_length((*sub_object_list)->reference.node);\r\n}\r\n} else {\r\ntemp_size_needed += sizeof(u32);\r\n}\r\ntemp_size_needed = ACPI_ROUND_UP_TO_64BIT(temp_size_needed);\r\ntop_object_list++;\r\n}\r\n*buffer_size_needed =\r\ntemp_size_needed + sizeof(struct acpi_pci_routing_table);\r\nreturn_ACPI_STATUS(AE_OK);\r\n}

static int\r\nclps7111fb_setcolreg(u_int regno, u_int red, u_int green, u_int blue,\r\nu_int transp, struct fb_info *info)\r\n{\r\nunsigned int level, mask, shift, pal;\r\nif (regno >= (1 << info->var.bits_per_pixel))\r\nreturn 1;\r\nlevel = (red * 77 + green * 151 + blue * 28) >> 20;\r\nif (machine_is_edb7211()) {\r\nlevel = 15 - level;\r\n}\r\nshift = 4 * (regno & 7);\r\nlevel <<= shift;\r\nmask = 15 << shift;\r\nlevel &= mask;\r\nregno = regno < 8 ? PALLSW : PALMSW;\r\npal = clps_readl(regno);\r\npal = (pal & ~mask) | level;\r\nclps_writel(pal, regno);\r\nreturn 0;\r\n}\r\nstatic int\r\nclps7111fb_check_var(struct fb_var_screeninfo *var, struct fb_info *info)\r\n{\r\nvar->transp.msb_right = 0;\r\nvar->transp.offset = 0;\r\nvar->transp.length = 0;\r\nvar->red.msb_right = 0;\r\nvar->red.offset = 0;\r\nvar->red.length = var->bits_per_pixel;\r\nvar->green = var->red;\r\nvar->blue = var->red;\r\nif (var->bits_per_pixel > 4)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int\r\nclps7111fb_set_par(struct fb_info *info)\r\n{\r\nunsigned int lcdcon, syscon, pixclock;\r\nswitch (info->var.bits_per_pixel) {\r\ncase 1:\r\ninfo->fix.visual = FB_VISUAL_MONO01;\r\nbreak;\r\ncase 2:\r\ninfo->fix.visual = FB_VISUAL_PSEUDOCOLOR;\r\nbreak;\r\ncase 4:\r\ninfo->fix.visual = FB_VISUAL_PSEUDOCOLOR;\r\nbreak;\r\n}\r\ninfo->fix.line_length = info->var.xres_virtual * info->var.bits_per_pixel / 8;\r\nlcdcon = (info->var.xres_virtual * info->var.yres_virtual * info->var.bits_per_pixel) / 128 - 1;\r\nlcdcon |= ((info->var.xres_virtual / 16) - 1) << 13;\r\nlcdcon |= lcd_ac_prescale << 25;\r\npixclock = 9 * info->var.pixclock / 244140 - 1;\r\nlcdcon |= pixclock << 19;\r\nif (info->var.bits_per_pixel == 4)\r\nlcdcon |= LCDCON_GSMD;\r\nif (info->var.bits_per_pixel >= 2)\r\nlcdcon |= LCDCON_GSEN;\r\nsyscon = clps_readl(SYSCON1);\r\nclps_writel(syscon & ~SYSCON1_LCDEN, SYSCON1);\r\nclps_writel(lcdcon, LCDCON);\r\nclps_writel(syscon | SYSCON1_LCDEN, SYSCON1);\r\nreturn 0;\r\n}\r\nstatic int clps7111fb_blank(int blank, struct fb_info *info)\r\n{\r\nif (blank) {\r\nif (machine_is_edb7211()) {\r\nclps_writeb(clps_readb(PDDR) & ~EDB_PD3_LCDBL, PDDR);\r\nclps_writeb(clps_readb(PDDR) & ~EDB_PD1_LCD_DC_DC_EN, PDDR);\r\nudelay(100);\r\nclps_writeb(clps_readb(PDDR) & ~EDB_PD2_LCDEN, PDDR);\r\nclps_writel(clps_readl(SYSCON1) & ~SYSCON1_LCDEN,\r\nSYSCON1);\r\n}\r\n} else {\r\nif (machine_is_edb7211()) {\r\nclps_writel(clps_readl(SYSCON1) | SYSCON1_LCDEN,\r\nSYSCON1);\r\nclps_writeb(clps_readb(PDDR) | EDB_PD2_LCDEN, PDDR);\r\nudelay(100);\r\nclps_writeb(clps_readb(PDDR) | EDB_PD1_LCD_DC_DC_EN,\r\nPDDR);\r\nclps_writeb(clps_readb(PDDR) | EDB_PD3_LCDBL, PDDR);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int backlight_proc_show(struct seq_file *m, void *v)\r\n{\r\nif (machine_is_edb7211()) {\r\nseq_printf(m, "%d\n",\r\n(clps_readb(PDDR) & EDB_PD3_LCDBL) ? 1 : 0);\r\n}\r\nreturn 0;\r\n}\r\nstatic int backlight_proc_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, backlight_proc_show, NULL);\r\n}\r\nstatic ssize_t backlight_proc_write(struct file *file, const char *buffer,\r\nsize_t count, loff_t *pos)\r\n{\r\nunsigned char char_value;\r\nint value;\r\nif (count < 1) {\r\nreturn -EINVAL;\r\n}\r\nif (copy_from_user(&char_value, buffer, 1))\r\nreturn -EFAULT;\r\nvalue = char_value - '0';\r\nif (machine_is_edb7211()) {\r\nunsigned char port_d;\r\nport_d = clps_readb(PDDR);\r\nif (value) {\r\nport_d |= EDB_PD3_LCDBL;\r\n} else {\r\nport_d &= ~EDB_PD3_LCDBL;\r\n}\r\nclps_writeb(port_d, PDDR);\r\n}\r\nreturn count;\r\n}\r\nstatic void __init clps711x_guess_lcd_params(struct fb_info *info)\r\n{\r\nunsigned int lcdcon, syscon, size;\r\nunsigned long phys_base = PAGE_OFFSET;\r\nvoid *virt_base = (void *)PAGE_OFFSET;\r\ninfo->var.xres_virtual = 640;\r\ninfo->var.yres_virtual = 240;\r\ninfo->var.bits_per_pixel = 4;\r\ninfo->var.activate = FB_ACTIVATE_NOW;\r\ninfo->var.height = -1;\r\ninfo->var.width = -1;\r\ninfo->var.pixclock = 93006;\r\nsyscon = clps_readl(SYSCON1);\r\nif (syscon & SYSCON1_LCDEN) {\r\nlcdcon = clps_readl(LCDCON);\r\nswitch (lcdcon & (LCDCON_GSMD | LCDCON_GSEN)) {\r\ncase LCDCON_GSMD | LCDCON_GSEN:\r\ninfo->var.bits_per_pixel = 4;\r\nbreak;\r\ncase LCDCON_GSEN:\r\ninfo->var.bits_per_pixel = 2;\r\nbreak;\r\ndefault:\r\ninfo->var.bits_per_pixel = 1;\r\nbreak;\r\n}\r\ninfo->var.xres_virtual = (((lcdcon >> 13) & 0x3f) + 1) * 16;\r\ninfo->var.yres_virtual = (((lcdcon & 0x1fff) + 1) * 128) /\r\n(info->var.xres_virtual *\r\ninfo->var.bits_per_pixel);\r\ninfo->var.pixclock = (((lcdcon >> 19) & 0x3f) + 1) * 244140 / 9;\r\nlcd_ac_prescale = (lcdcon >> 25) & 0x1f;\r\n}\r\ninfo->var.xres = info->var.xres_virtual;\r\ninfo->var.yres = info->var.yres_virtual;\r\ninfo->var.grayscale = info->var.bits_per_pixel > 1;\r\nsize = info->var.xres * info->var.yres * info->var.bits_per_pixel / 8;\r\nif (size <= 38400) {\r\nprintk(KERN_INFO "CLPS711xFB: could use on-board SRAM?\n");\r\n}\r\nif ((syscon & SYSCON1_LCDEN) == 0) {\r\nmemset(virt_base, 0, size);\r\n}\r\ninfo->screen_base = virt_base;\r\ninfo->fix.smem_start = phys_base;\r\ninfo->fix.smem_len = PAGE_ALIGN(size);\r\ninfo->fix.type = FB_TYPE_PACKED_PIXELS;\r\n}\r\nint __init clps711xfb_init(void)\r\n{\r\nint err = -ENOMEM;\r\nif (fb_get_options("clps711xfb", NULL))\r\nreturn -ENODEV;\r\ncfb = kzalloc(sizeof(*cfb), GFP_KERNEL);\r\nif (!cfb)\r\ngoto out;\r\nstrcpy(cfb->fix.id, "clps711x");\r\ncfb->fbops = &clps7111fb_ops;\r\ncfb->flags = FBINFO_DEFAULT;\r\nclps711x_guess_lcd_params(cfb);\r\nfb_alloc_cmap(&cfb->cmap, CMAP_MAX_SIZE, 0);\r\nif (!proc_create("backlight", 0444, NULL, &backlight_proc_fops)) {\r\nprintk("Couldn't create the /proc entry for the backlight.\n");\r\nreturn -EINVAL;\r\n}\r\nif (machine_is_p720t()) {\r\nPLD_LCDEN = PLD_LCDEN_EN;\r\nPLD_PWR |= (PLD_S4_ON|PLD_S3_ON|PLD_S2_ON|PLD_S1_ON);\r\n}\r\nif (machine_is_edb7211()) {\r\nclps_writeb(clps_readb(PDDR) | EDB_PD2_LCDEN, PDDR);\r\nudelay(100);\r\nclps_writeb(clps_readb(PDDR) | EDB_PD1_LCD_DC_DC_EN, PDDR);\r\nclps_writeb(clps_readb(PDDR) | EDB_PD3_LCDBL, PDDR);\r\n}\r\nerr = register_framebuffer(cfb);\r\nout: return err;\r\n}\r\nstatic void __exit clps711xfb_exit(void)\r\n{\r\nunregister_framebuffer(cfb);\r\nkfree(cfb);\r\nif (machine_is_p720t()) {\r\nPLD_LCDEN = 0;\r\nPLD_PWR &= ~(PLD_S4_ON|PLD_S3_ON|PLD_S2_ON|PLD_S1_ON);\r\n}\r\n}

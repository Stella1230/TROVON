static void __init ts72xx_map_io(void)\r\n{\r\nep93xx_map_io();\r\niotable_init(ts72xx_io_desc, ARRAY_SIZE(ts72xx_io_desc));\r\n}\r\nstatic void ts72xx_nand_hwcontrol(struct mtd_info *mtd,\r\nint cmd, unsigned int ctrl)\r\n{\r\nstruct nand_chip *chip = mtd->priv;\r\nif (ctrl & NAND_CTRL_CHANGE) {\r\nvoid __iomem *addr = chip->IO_ADDR_R;\r\nunsigned char bits;\r\naddr += (1 << TS72XX_NAND_CONTROL_ADDR_LINE);\r\nbits = __raw_readb(addr) & ~0x07;\r\nbits |= (ctrl & NAND_NCE) << 2;\r\nbits |= (ctrl & NAND_CLE);\r\nbits |= (ctrl & NAND_ALE) >> 2;\r\n__raw_writeb(bits, addr);\r\n}\r\nif (cmd != NAND_CMD_NONE)\r\n__raw_writeb(cmd, chip->IO_ADDR_W);\r\n}\r\nstatic int ts72xx_nand_device_ready(struct mtd_info *mtd)\r\n{\r\nstruct nand_chip *chip = mtd->priv;\r\nvoid __iomem *addr = chip->IO_ADDR_R;\r\naddr += (1 << TS72XX_NAND_BUSY_ADDR_LINE);\r\nreturn !!(__raw_readb(addr) & 0x20);\r\n}\r\nstatic void ts72xx_nand_set_parts(uint64_t size,\r\nstruct platform_nand_chip *chip)\r\n{\r\nif (size == SZ_32M || size == SZ_128M) {\r\nts72xx_nand_parts[1].size = size - TS72XX_REDBOOT_PART_SIZE;\r\nchip->partitions = ts72xx_nand_parts;\r\nchip->nr_partitions = ARRAY_SIZE(ts72xx_nand_parts);\r\n} else {\r\npr_warning("Unknown nand disk size:%lluMiB\n", size >> 20);\r\n}\r\n}\r\nstatic void __init ts72xx_register_flash(void)\r\n{\r\nif (board_is_ts7200()) {\r\nep93xx_register_flash(2, EP93XX_CS6_PHYS_BASE, SZ_16M);\r\n} else {\r\nresource_size_t start;\r\nif (is_ts9420_installed())\r\nstart = EP93XX_CS7_PHYS_BASE;\r\nelse\r\nstart = EP93XX_CS6_PHYS_BASE;\r\nts72xx_nand_resource[0].start = start;\r\nts72xx_nand_resource[0].end = start + SZ_16M - 1;\r\nplatform_device_register(&ts72xx_nand_flash);\r\n}\r\n}\r\nstatic unsigned char ts72xx_rtc_readbyte(unsigned long addr)\r\n{\r\n__raw_writeb(addr, TS72XX_RTC_INDEX_VIRT_BASE);\r\nreturn __raw_readb(TS72XX_RTC_DATA_VIRT_BASE);\r\n}\r\nstatic void ts72xx_rtc_writebyte(unsigned char value, unsigned long addr)\r\n{\r\n__raw_writeb(addr, TS72XX_RTC_INDEX_VIRT_BASE);\r\n__raw_writeb(value, TS72XX_RTC_DATA_VIRT_BASE);\r\n}\r\nstatic void __init ts72xx_init_machine(void)\r\n{\r\nep93xx_init_devices();\r\nts72xx_register_flash();\r\nplatform_device_register(&ts72xx_rtc_device);\r\nplatform_device_register(&ts72xx_wdt_device);\r\nep93xx_register_eth(&ts72xx_eth_data, 1);\r\n}

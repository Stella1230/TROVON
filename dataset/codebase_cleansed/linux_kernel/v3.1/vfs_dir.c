static inline int dt_type(struct p9_wstat *mistat)\r\n{\r\nunsigned long perm = mistat->mode;\r\nint rettype = DT_REG;\r\nif (perm & P9_DMDIR)\r\nrettype = DT_DIR;\r\nif (perm & P9_DMSYMLINK)\r\nrettype = DT_LNK;\r\nreturn rettype;\r\n}\r\nstatic void p9stat_init(struct p9_wstat *stbuf)\r\n{\r\nstbuf->name = NULL;\r\nstbuf->uid = NULL;\r\nstbuf->gid = NULL;\r\nstbuf->muid = NULL;\r\nstbuf->extension = NULL;\r\n}\r\nstatic int v9fs_alloc_rdir_buf(struct file *filp, int buflen)\r\n{\r\nstruct p9_rdir *rdir;\r\nstruct p9_fid *fid;\r\nint err = 0;\r\nfid = filp->private_data;\r\nif (!fid->rdir) {\r\nrdir = kmalloc(sizeof(struct p9_rdir) + buflen, GFP_KERNEL);\r\nif (rdir == NULL) {\r\nerr = -ENOMEM;\r\ngoto exit;\r\n}\r\nspin_lock(&filp->f_dentry->d_lock);\r\nif (!fid->rdir) {\r\nrdir->buf = (uint8_t *)rdir + sizeof(struct p9_rdir);\r\nmutex_init(&rdir->mutex);\r\nrdir->head = rdir->tail = 0;\r\nfid->rdir = (void *) rdir;\r\nrdir = NULL;\r\n}\r\nspin_unlock(&filp->f_dentry->d_lock);\r\nkfree(rdir);\r\n}\r\nexit:\r\nreturn err;\r\n}\r\nstatic int v9fs_dir_readdir(struct file *filp, void *dirent, filldir_t filldir)\r\n{\r\nint over;\r\nstruct p9_wstat st;\r\nint err = 0;\r\nstruct p9_fid *fid;\r\nint buflen;\r\nint reclen = 0;\r\nstruct p9_rdir *rdir;\r\nP9_DPRINTK(P9_DEBUG_VFS, "name %s\n", filp->f_path.dentry->d_name.name);\r\nfid = filp->private_data;\r\nbuflen = fid->clnt->msize - P9_IOHDRSZ;\r\nerr = v9fs_alloc_rdir_buf(filp, buflen);\r\nif (err)\r\ngoto exit;\r\nrdir = (struct p9_rdir *) fid->rdir;\r\nerr = mutex_lock_interruptible(&rdir->mutex);\r\nif (err)\r\nreturn err;\r\nwhile (err == 0) {\r\nif (rdir->tail == rdir->head) {\r\nerr = v9fs_file_readn(filp, rdir->buf, NULL,\r\nbuflen, filp->f_pos);\r\nif (err <= 0)\r\ngoto unlock_and_exit;\r\nrdir->head = 0;\r\nrdir->tail = err;\r\n}\r\nwhile (rdir->head < rdir->tail) {\r\np9stat_init(&st);\r\nerr = p9stat_read(rdir->buf + rdir->head,\r\nrdir->tail - rdir->head, &st,\r\nfid->clnt->proto_version);\r\nif (err) {\r\nP9_DPRINTK(P9_DEBUG_VFS, "returned %d\n", err);\r\nerr = -EIO;\r\np9stat_free(&st);\r\ngoto unlock_and_exit;\r\n}\r\nreclen = st.size+2;\r\nover = filldir(dirent, st.name, strlen(st.name),\r\nfilp->f_pos, v9fs_qid2ino(&st.qid), dt_type(&st));\r\np9stat_free(&st);\r\nif (over) {\r\nerr = 0;\r\ngoto unlock_and_exit;\r\n}\r\nrdir->head += reclen;\r\nfilp->f_pos += reclen;\r\n}\r\n}\r\nunlock_and_exit:\r\nmutex_unlock(&rdir->mutex);\r\nexit:\r\nreturn err;\r\n}\r\nstatic int v9fs_dir_readdir_dotl(struct file *filp, void *dirent,\r\nfilldir_t filldir)\r\n{\r\nint over;\r\nint err = 0;\r\nstruct p9_fid *fid;\r\nint buflen;\r\nstruct p9_rdir *rdir;\r\nstruct p9_dirent curdirent;\r\nu64 oldoffset = 0;\r\nP9_DPRINTK(P9_DEBUG_VFS, "name %s\n", filp->f_path.dentry->d_name.name);\r\nfid = filp->private_data;\r\nbuflen = fid->clnt->msize - P9_READDIRHDRSZ;\r\nerr = v9fs_alloc_rdir_buf(filp, buflen);\r\nif (err)\r\ngoto exit;\r\nrdir = (struct p9_rdir *) fid->rdir;\r\nerr = mutex_lock_interruptible(&rdir->mutex);\r\nif (err)\r\nreturn err;\r\nwhile (err == 0) {\r\nif (rdir->tail == rdir->head) {\r\nerr = p9_client_readdir(fid, rdir->buf, buflen,\r\nfilp->f_pos);\r\nif (err <= 0)\r\ngoto unlock_and_exit;\r\nrdir->head = 0;\r\nrdir->tail = err;\r\n}\r\nwhile (rdir->head < rdir->tail) {\r\nerr = p9dirent_read(rdir->buf + rdir->head,\r\nrdir->tail - rdir->head,\r\n&curdirent,\r\nfid->clnt->proto_version);\r\nif (err < 0) {\r\nP9_DPRINTK(P9_DEBUG_VFS, "returned %d\n", err);\r\nerr = -EIO;\r\ngoto unlock_and_exit;\r\n}\r\nover = filldir(dirent, curdirent.d_name,\r\nstrlen(curdirent.d_name),\r\noldoffset, v9fs_qid2ino(&curdirent.qid),\r\ncurdirent.d_type);\r\noldoffset = curdirent.d_off;\r\nif (over) {\r\nerr = 0;\r\ngoto unlock_and_exit;\r\n}\r\nfilp->f_pos = curdirent.d_off;\r\nrdir->head += err;\r\n}\r\n}\r\nunlock_and_exit:\r\nmutex_unlock(&rdir->mutex);\r\nexit:\r\nreturn err;\r\n}\r\nint v9fs_dir_release(struct inode *inode, struct file *filp)\r\n{\r\nstruct p9_fid *fid;\r\nfid = filp->private_data;\r\nP9_DPRINTK(P9_DEBUG_VFS,\r\n"v9fs_dir_release: inode: %p filp: %p fid: %d\n",\r\ninode, filp, fid ? fid->fid : -1);\r\nif (fid)\r\np9_client_clunk(fid);\r\nreturn 0;\r\n}

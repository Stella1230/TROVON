static int adl_pci8164_attach(struct comedi_device *dev,\r\nstruct comedi_devconfig *it)\r\n{\r\nstruct pci_dev *pcidev = NULL;\r\nstruct comedi_subdevice *s;\r\nint bus, slot;\r\nprintk(KERN_INFO "comedi: attempt to attach...\n");\r\nprintk(KERN_INFO "comedi%d: adl_pci8164\n", dev->minor);\r\ndev->board_name = "pci8164";\r\nbus = it->options[0];\r\nslot = it->options[1];\r\nif (alloc_private(dev, sizeof(struct adl_pci8164_private)) < 0)\r\nreturn -ENOMEM;\r\nif (alloc_subdevices(dev, 4) < 0)\r\nreturn -ENOMEM;\r\nfor_each_pci_dev(pcidev) {\r\nif (pcidev->vendor == PCI_VENDOR_ID_ADLINK &&\r\npcidev->device == PCI_DEVICE_ID_PCI8164) {\r\nif (bus || slot) {\r\nif (pcidev->bus->number != bus\r\n|| PCI_SLOT(pcidev->devfn) != slot)\r\ncontinue;\r\n}\r\ndevpriv->pci_dev = pcidev;\r\nif (comedi_pci_enable(pcidev, "adl_pci8164") < 0) {\r\nprintk(KERN_ERR "comedi%d: Failed to enable "\r\n"PCI device and request regions\n", dev->minor);\r\nreturn -EIO;\r\n}\r\ndev->iobase = pci_resource_start(pcidev, 2);\r\nprintk(KERN_DEBUG "comedi: base addr %4lx\n",\r\ndev->iobase);\r\ns = dev->subdevices + 0;\r\ns->type = COMEDI_SUBD_PROC;\r\ns->subdev_flags = SDF_READABLE | SDF_WRITABLE;\r\ns->n_chan = 4;\r\ns->maxdata = 0xffff;\r\ns->len_chanlist = 4;\r\ns->insn_read = adl_pci8164_insn_read_msts;\r\ns->insn_write = adl_pci8164_insn_write_cmd;\r\ns = dev->subdevices + 1;\r\ns->type = COMEDI_SUBD_PROC;\r\ns->subdev_flags = SDF_READABLE | SDF_WRITABLE;\r\ns->n_chan = 4;\r\ns->maxdata = 0xffff;\r\ns->len_chanlist = 4;\r\ns->insn_read = adl_pci8164_insn_read_ssts;\r\ns->insn_write = adl_pci8164_insn_write_otp;\r\ns = dev->subdevices + 2;\r\ns->type = COMEDI_SUBD_PROC;\r\ns->subdev_flags = SDF_READABLE | SDF_WRITABLE;\r\ns->n_chan = 4;\r\ns->maxdata = 0xffff;\r\ns->len_chanlist = 4;\r\ns->insn_read = adl_pci8164_insn_read_buf0;\r\ns->insn_write = adl_pci8164_insn_write_buf0;\r\ns = dev->subdevices + 3;\r\ns->type = COMEDI_SUBD_PROC;\r\ns->subdev_flags = SDF_READABLE | SDF_WRITABLE;\r\ns->n_chan = 4;\r\ns->maxdata = 0xffff;\r\ns->len_chanlist = 4;\r\ns->insn_read = adl_pci8164_insn_read_buf1;\r\ns->insn_write = adl_pci8164_insn_write_buf1;\r\nprintk(KERN_INFO "comedi: attached\n");\r\nreturn 1;\r\n}\r\n}\r\nprintk(KERN_ERR "comedi%d: no supported board found!"\r\n"(req. bus/slot : %d/%d)\n", dev->minor, bus, slot);\r\nreturn -EIO;\r\n}\r\nstatic int adl_pci8164_detach(struct comedi_device *dev)\r\n{\r\nprintk(KERN_INFO "comedi%d: pci8164: remove\n", dev->minor);\r\nif (devpriv && devpriv->pci_dev) {\r\nif (dev->iobase)\r\ncomedi_pci_disable(devpriv->pci_dev);\r\npci_dev_put(devpriv->pci_dev);\r\n}\r\nreturn 0;\r\n}\r\nstatic void adl_pci8164_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data,\r\nchar *action, unsigned short offset)\r\n{\r\nint axis, axis_reg;\r\nchar *axisname;\r\naxis = CR_CHAN(insn->chanspec);\r\nswitch (axis) {\r\ncase 0:\r\naxis_reg = PCI8164_AXIS_X;\r\naxisname = "X";\r\nbreak;\r\ncase 1:\r\naxis_reg = PCI8164_AXIS_Y;\r\naxisname = "Y";\r\nbreak;\r\ncase 2:\r\naxis_reg = PCI8164_AXIS_Z;\r\naxisname = "Z";\r\nbreak;\r\ncase 3:\r\naxis_reg = PCI8164_AXIS_U;\r\naxisname = "U";\r\nbreak;\r\ndefault:\r\naxis_reg = PCI8164_AXIS_X;\r\naxisname = "X";\r\n}\r\ndata[0] = inw(dev->iobase + axis_reg + offset);\r\nprintk(KERN_DEBUG "comedi: pci8164 %s read -> "\r\n"%04X:%04X on axis %s\n",\r\naction, data[0], data[1], axisname);\r\n}\r\nstatic int adl_pci8164_insn_read_msts(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nadl_pci8164_insn_read(dev, s, insn, data, "MSTS", PCI8164_MSTS);\r\nreturn 2;\r\n}\r\nstatic int adl_pci8164_insn_read_ssts(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nadl_pci8164_insn_read(dev, s, insn, data, "SSTS", PCI8164_SSTS);\r\nreturn 2;\r\n}\r\nstatic int adl_pci8164_insn_read_buf0(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nadl_pci8164_insn_read(dev, s, insn, data, "BUF0", PCI8164_BUF0);\r\nreturn 2;\r\n}\r\nstatic int adl_pci8164_insn_read_buf1(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nadl_pci8164_insn_read(dev, s, insn, data, "BUF1", PCI8164_BUF1);\r\nreturn 2;\r\n}\r\nstatic void adl_pci8164_insn_out(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data,\r\nchar *action, unsigned short offset)\r\n{\r\nunsigned int axis, axis_reg;\r\nchar *axisname;\r\naxis = CR_CHAN(insn->chanspec);\r\nswitch (axis) {\r\ncase 0:\r\naxis_reg = PCI8164_AXIS_X;\r\naxisname = "X";\r\nbreak;\r\ncase 1:\r\naxis_reg = PCI8164_AXIS_Y;\r\naxisname = "Y";\r\nbreak;\r\ncase 2:\r\naxis_reg = PCI8164_AXIS_Z;\r\naxisname = "Z";\r\nbreak;\r\ncase 3:\r\naxis_reg = PCI8164_AXIS_U;\r\naxisname = "U";\r\nbreak;\r\ndefault:\r\naxis_reg = PCI8164_AXIS_X;\r\naxisname = "X";\r\n}\r\noutw(data[0], dev->iobase + axis_reg + offset);\r\nprintk(KERN_DEBUG "comedi: pci8164 %s write -> "\r\n"%04X:%04X on axis %s\n",\r\naction, data[0], data[1], axisname);\r\n}\r\nstatic int adl_pci8164_insn_write_cmd(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nadl_pci8164_insn_out(dev, s, insn, data, "CMD", PCI8164_CMD);\r\nreturn 2;\r\n}\r\nstatic int adl_pci8164_insn_write_otp(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nadl_pci8164_insn_out(dev, s, insn, data, "OTP", PCI8164_OTP);\r\nreturn 2;\r\n}\r\nstatic int adl_pci8164_insn_write_buf0(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nadl_pci8164_insn_out(dev, s, insn, data, "BUF0", PCI8164_BUF0);\r\nreturn 2;\r\n}\r\nstatic int adl_pci8164_insn_write_buf1(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nadl_pci8164_insn_out(dev, s, insn, data, "BUF1", PCI8164_BUF1);\r\nreturn 2;\r\n}\r\nstatic int __devinit driver_adl_pci8164_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id\r\n*ent)\r\n{\r\nreturn comedi_pci_auto_config(dev, driver_adl_pci8164.driver_name);\r\n}\r\nstatic void __devexit driver_adl_pci8164_pci_remove(struct pci_dev *dev)\r\n{\r\ncomedi_pci_auto_unconfig(dev);\r\n}\r\nstatic int __init driver_adl_pci8164_init_module(void)\r\n{\r\nint retval;\r\nretval = comedi_driver_register(&driver_adl_pci8164);\r\nif (retval < 0)\r\nreturn retval;\r\ndriver_adl_pci8164_pci_driver.name =\r\n(char *)driver_adl_pci8164.driver_name;\r\nreturn pci_register_driver(&driver_adl_pci8164_pci_driver);\r\n}\r\nstatic void __exit driver_adl_pci8164_cleanup_module(void)\r\n{\r\npci_unregister_driver(&driver_adl_pci8164_pci_driver);\r\ncomedi_driver_unregister(&driver_adl_pci8164);\r\n}

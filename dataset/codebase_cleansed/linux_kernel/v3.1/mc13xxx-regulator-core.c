static int mc13xxx_regulator_enable(struct regulator_dev *rdev)\r\n{\r\nstruct mc13xxx_regulator_priv *priv = rdev_get_drvdata(rdev);\r\nstruct mc13xxx_regulator *mc13xxx_regulators = priv->mc13xxx_regulators;\r\nint id = rdev_get_id(rdev);\r\nint ret;\r\ndev_dbg(rdev_get_dev(rdev), "%s id: %d\n", __func__, id);\r\nmc13xxx_lock(priv->mc13xxx);\r\nret = mc13xxx_reg_rmw(priv->mc13xxx, mc13xxx_regulators[id].reg,\r\nmc13xxx_regulators[id].enable_bit,\r\nmc13xxx_regulators[id].enable_bit);\r\nmc13xxx_unlock(priv->mc13xxx);\r\nreturn ret;\r\n}\r\nstatic int mc13xxx_regulator_disable(struct regulator_dev *rdev)\r\n{\r\nstruct mc13xxx_regulator_priv *priv = rdev_get_drvdata(rdev);\r\nstruct mc13xxx_regulator *mc13xxx_regulators = priv->mc13xxx_regulators;\r\nint id = rdev_get_id(rdev);\r\nint ret;\r\ndev_dbg(rdev_get_dev(rdev), "%s id: %d\n", __func__, id);\r\nmc13xxx_lock(priv->mc13xxx);\r\nret = mc13xxx_reg_rmw(priv->mc13xxx, mc13xxx_regulators[id].reg,\r\nmc13xxx_regulators[id].enable_bit, 0);\r\nmc13xxx_unlock(priv->mc13xxx);\r\nreturn ret;\r\n}\r\nstatic int mc13xxx_regulator_is_enabled(struct regulator_dev *rdev)\r\n{\r\nstruct mc13xxx_regulator_priv *priv = rdev_get_drvdata(rdev);\r\nstruct mc13xxx_regulator *mc13xxx_regulators = priv->mc13xxx_regulators;\r\nint ret, id = rdev_get_id(rdev);\r\nunsigned int val;\r\nmc13xxx_lock(priv->mc13xxx);\r\nret = mc13xxx_reg_read(priv->mc13xxx, mc13xxx_regulators[id].reg, &val);\r\nmc13xxx_unlock(priv->mc13xxx);\r\nif (ret)\r\nreturn ret;\r\nreturn (val & mc13xxx_regulators[id].enable_bit) != 0;\r\n}\r\nint mc13xxx_regulator_list_voltage(struct regulator_dev *rdev,\r\nunsigned selector)\r\n{\r\nint id = rdev_get_id(rdev);\r\nstruct mc13xxx_regulator_priv *priv = rdev_get_drvdata(rdev);\r\nstruct mc13xxx_regulator *mc13xxx_regulators = priv->mc13xxx_regulators;\r\nif (selector >= mc13xxx_regulators[id].desc.n_voltages)\r\nreturn -EINVAL;\r\nreturn mc13xxx_regulators[id].voltages[selector];\r\n}\r\nint mc13xxx_get_best_voltage_index(struct regulator_dev *rdev,\r\nint min_uV, int max_uV)\r\n{\r\nstruct mc13xxx_regulator_priv *priv = rdev_get_drvdata(rdev);\r\nstruct mc13xxx_regulator *mc13xxx_regulators = priv->mc13xxx_regulators;\r\nint reg_id = rdev_get_id(rdev);\r\nint i;\r\nint bestmatch;\r\nint bestindex;\r\nbestmatch = INT_MAX;\r\nbestindex = -1;\r\nfor (i = 0; i < mc13xxx_regulators[reg_id].desc.n_voltages; i++) {\r\nif (mc13xxx_regulators[reg_id].voltages[i] >= min_uV &&\r\nmc13xxx_regulators[reg_id].voltages[i] < bestmatch) {\r\nbestmatch = mc13xxx_regulators[reg_id].voltages[i];\r\nbestindex = i;\r\n}\r\n}\r\nif (bestindex < 0 || bestmatch > max_uV) {\r\ndev_warn(&rdev->dev, "no possible value for %d<=x<=%d uV\n",\r\nmin_uV, max_uV);\r\nreturn -EINVAL;\r\n}\r\nreturn bestindex;\r\n}\r\nstatic int mc13xxx_regulator_set_voltage(struct regulator_dev *rdev, int min_uV,\r\nint max_uV, unsigned *selector)\r\n{\r\nstruct mc13xxx_regulator_priv *priv = rdev_get_drvdata(rdev);\r\nstruct mc13xxx_regulator *mc13xxx_regulators = priv->mc13xxx_regulators;\r\nint value, id = rdev_get_id(rdev);\r\nint ret;\r\ndev_dbg(rdev_get_dev(rdev), "%s id: %d min_uV: %d max_uV: %d\n",\r\n__func__, id, min_uV, max_uV);\r\nvalue = mc13xxx_get_best_voltage_index(rdev, min_uV, max_uV);\r\ndev_dbg(rdev_get_dev(rdev), "%s best value: %d\n", __func__, value);\r\nif (value < 0)\r\nreturn value;\r\nmc13xxx_lock(priv->mc13xxx);\r\nret = mc13xxx_reg_rmw(priv->mc13xxx, mc13xxx_regulators[id].vsel_reg,\r\nmc13xxx_regulators[id].vsel_mask,\r\nvalue << mc13xxx_regulators[id].vsel_shift);\r\nmc13xxx_unlock(priv->mc13xxx);\r\nreturn ret;\r\n}\r\nstatic int mc13xxx_regulator_get_voltage(struct regulator_dev *rdev)\r\n{\r\nstruct mc13xxx_regulator_priv *priv = rdev_get_drvdata(rdev);\r\nstruct mc13xxx_regulator *mc13xxx_regulators = priv->mc13xxx_regulators;\r\nint ret, id = rdev_get_id(rdev);\r\nunsigned int val;\r\ndev_dbg(rdev_get_dev(rdev), "%s id: %d\n", __func__, id);\r\nmc13xxx_lock(priv->mc13xxx);\r\nret = mc13xxx_reg_read(priv->mc13xxx,\r\nmc13xxx_regulators[id].vsel_reg, &val);\r\nmc13xxx_unlock(priv->mc13xxx);\r\nif (ret)\r\nreturn ret;\r\nval = (val & mc13xxx_regulators[id].vsel_mask)\r\n>> mc13xxx_regulators[id].vsel_shift;\r\ndev_dbg(rdev_get_dev(rdev), "%s id: %d val: %d\n", __func__, id, val);\r\nBUG_ON(val >= mc13xxx_regulators[id].desc.n_voltages);\r\nreturn mc13xxx_regulators[id].voltages[val];\r\n}\r\nint mc13xxx_fixed_regulator_set_voltage(struct regulator_dev *rdev, int min_uV,\r\nint max_uV, unsigned *selector)\r\n{\r\nstruct mc13xxx_regulator_priv *priv = rdev_get_drvdata(rdev);\r\nstruct mc13xxx_regulator *mc13xxx_regulators = priv->mc13xxx_regulators;\r\nint id = rdev_get_id(rdev);\r\ndev_dbg(rdev_get_dev(rdev), "%s id: %d min_uV: %d max_uV: %d\n",\r\n__func__, id, min_uV, max_uV);\r\nif (min_uV >= mc13xxx_regulators[id].voltages[0] &&\r\nmax_uV <= mc13xxx_regulators[id].voltages[0])\r\nreturn 0;\r\nelse\r\nreturn -EINVAL;\r\n}\r\nint mc13xxx_fixed_regulator_get_voltage(struct regulator_dev *rdev)\r\n{\r\nstruct mc13xxx_regulator_priv *priv = rdev_get_drvdata(rdev);\r\nstruct mc13xxx_regulator *mc13xxx_regulators = priv->mc13xxx_regulators;\r\nint id = rdev_get_id(rdev);\r\ndev_dbg(rdev_get_dev(rdev), "%s id: %d\n", __func__, id);\r\nreturn mc13xxx_regulators[id].voltages[0];\r\n}\r\nint mc13xxx_sw_regulator_is_enabled(struct regulator_dev *rdev)\r\n{\r\nreturn 1;\r\n}

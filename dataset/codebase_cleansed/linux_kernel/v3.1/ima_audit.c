static int __init ima_audit_setup(char *str)\r\n{\r\nunsigned long audit;\r\nif (!strict_strtoul(str, 0, &audit))\r\nima_audit = audit ? 1 : 0;\r\nreturn 1;\r\n}\r\nvoid integrity_audit_msg(int audit_msgno, struct inode *inode,\r\nconst unsigned char *fname, const char *op,\r\nconst char *cause, int result, int audit_info)\r\n{\r\nstruct audit_buffer *ab;\r\nif (!ima_audit && audit_info == 1)\r\nreturn;\r\nab = audit_log_start(current->audit_context, GFP_KERNEL, audit_msgno);\r\naudit_log_format(ab, "pid=%d uid=%u auid=%u ses=%u",\r\ncurrent->pid, current_cred()->uid,\r\naudit_get_loginuid(current),\r\naudit_get_sessionid(current));\r\naudit_log_task_context(ab);\r\naudit_log_format(ab, " op=");\r\naudit_log_string(ab, op);\r\naudit_log_format(ab, " cause=");\r\naudit_log_string(ab, cause);\r\naudit_log_format(ab, " comm=");\r\naudit_log_untrustedstring(ab, current->comm);\r\nif (fname) {\r\naudit_log_format(ab, " name=");\r\naudit_log_untrustedstring(ab, fname);\r\n}\r\nif (inode)\r\naudit_log_format(ab, " dev=%s ino=%lu",\r\ninode->i_sb->s_id, inode->i_ino);\r\naudit_log_format(ab, " res=%d", !result ? 0 : 1);\r\naudit_log_end(ab);\r\n}

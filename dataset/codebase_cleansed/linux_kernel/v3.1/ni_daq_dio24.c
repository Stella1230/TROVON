static int dio24_attach(struct comedi_device *dev, struct comedi_devconfig *it)\r\n{\r\nstruct comedi_subdevice *s;\r\nunsigned long iobase = 0;\r\n#ifdef incomplete\r\nunsigned int irq = 0;\r\n#endif\r\nstruct pcmcia_device *link;\r\nif (alloc_private(dev, sizeof(struct dio24_private)) < 0)\r\nreturn -ENOMEM;\r\nswitch (thisboard->bustype) {\r\ncase pcmcia_bustype:\r\nlink = pcmcia_cur_dev;\r\nif (!link)\r\nreturn -EIO;\r\niobase = link->resource[0]->start;\r\n#ifdef incomplete\r\nirq = link->irq;\r\n#endif\r\nbreak;\r\ndefault:\r\nprintk("bug! couldn't determine board type\n");\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\nprintk("comedi%d: ni_daq_dio24: %s, io 0x%lx", dev->minor,\r\nthisboard->name, iobase);\r\n#ifdef incomplete\r\nif (irq) {\r\nprintk(", irq %u", irq);\r\n}\r\n#endif\r\nprintk("\n");\r\nif (iobase == 0) {\r\nprintk("io base address is zero!\n");\r\nreturn -EINVAL;\r\n}\r\ndev->iobase = iobase;\r\n#ifdef incomplete\r\ndev->irq = irq;\r\n#endif\r\ndev->board_name = thisboard->name;\r\nif (alloc_subdevices(dev, 1) < 0)\r\nreturn -ENOMEM;\r\ns = dev->subdevices + 0;\r\nsubdev_8255_init(dev, s, NULL, dev->iobase);\r\nreturn 0;\r\n}\r\nstatic int dio24_detach(struct comedi_device *dev)\r\n{\r\nprintk("comedi%d: ni_daq_dio24: remove\n", dev->minor);\r\nif (dev->subdevices)\r\nsubdev_8255_cleanup(dev, dev->subdevices + 0);\r\nif (thisboard->bustype != pcmcia_bustype && dev->iobase)\r\nrelease_region(dev->iobase, DIO24_SIZE);\r\nif (dev->irq)\r\nfree_irq(dev->irq, dev);\r\nreturn 0;\r\n}\r\nstatic int dio24_cs_attach(struct pcmcia_device *link)\r\n{\r\nstruct local_info_t *local;\r\nprintk(KERN_INFO "ni_daq_dio24: HOLA SOY YO - CS-attach!\n");\r\ndev_dbg(&link->dev, "dio24_cs_attach()\n");\r\nlocal = kzalloc(sizeof(struct local_info_t), GFP_KERNEL);\r\nif (!local)\r\nreturn -ENOMEM;\r\nlocal->link = link;\r\nlink->priv = local;\r\npcmcia_cur_dev = link;\r\ndio24_config(link);\r\nreturn 0;\r\n}\r\nstatic void dio24_cs_detach(struct pcmcia_device *link)\r\n{\r\nprintk(KERN_INFO "ni_daq_dio24: HOLA SOY YO - cs-detach!\n");\r\ndev_dbg(&link->dev, "dio24_cs_detach\n");\r\n((struct local_info_t *)link->priv)->stop = 1;\r\ndio24_release(link);\r\nkfree(link->priv);\r\n}\r\nstatic int dio24_pcmcia_config_loop(struct pcmcia_device *p_dev,\r\nvoid *priv_data)\r\n{\r\nif (p_dev->config_index == 0)\r\nreturn -EINVAL;\r\nreturn pcmcia_request_io(p_dev);\r\n}\r\nstatic void dio24_config(struct pcmcia_device *link)\r\n{\r\nint ret;\r\nprintk(KERN_INFO "ni_daq_dio24: HOLA SOY YO! - config\n");\r\ndev_dbg(&link->dev, "dio24_config\n");\r\nlink->config_flags |= CONF_ENABLE_IRQ | CONF_AUTO_AUDIO |\r\nCONF_AUTO_SET_IO;\r\nret = pcmcia_loop_config(link, dio24_pcmcia_config_loop, NULL);\r\nif (ret) {\r\ndev_warn(&link->dev, "no configuration found\n");\r\ngoto failed;\r\n}\r\nif (!link->irq)\r\ngoto failed;\r\nret = pcmcia_enable_device(link);\r\nif (ret)\r\ngoto failed;\r\nreturn;\r\nfailed:\r\nprintk(KERN_INFO "Fallo");\r\ndio24_release(link);\r\n}\r\nstatic void dio24_release(struct pcmcia_device *link)\r\n{\r\ndev_dbg(&link->dev, "dio24_release\n");\r\npcmcia_disable_device(link);\r\n}\r\nstatic int dio24_cs_suspend(struct pcmcia_device *link)\r\n{\r\nstruct local_info_t *local = link->priv;\r\nlocal->stop = 1;\r\nreturn 0;\r\n}\r\nstatic int dio24_cs_resume(struct pcmcia_device *link)\r\n{\r\nstruct local_info_t *local = link->priv;\r\nlocal->stop = 0;\r\nreturn 0;\r\n}\r\nstatic int __init init_dio24_cs(void)\r\n{\r\nprintk("ni_daq_dio24: HOLA SOY YO!\n");\r\npcmcia_register_driver(&dio24_cs_driver);\r\nreturn 0;\r\n}\r\nstatic void __exit exit_dio24_cs(void)\r\n{\r\npcmcia_unregister_driver(&dio24_cs_driver);\r\n}\r\nint __init init_module(void)\r\n{\r\nint ret;\r\nret = init_dio24_cs();\r\nif (ret < 0)\r\nreturn ret;\r\nreturn comedi_driver_register(&driver_dio24);\r\n}\r\nvoid __exit cleanup_module(void)\r\n{\r\nexit_dio24_cs();\r\ncomedi_driver_unregister(&driver_dio24);\r\n}

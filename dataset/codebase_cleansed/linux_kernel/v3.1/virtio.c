static ssize_t device_show(struct device *_d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct virtio_device *dev = container_of(_d,struct virtio_device,dev);\r\nreturn sprintf(buf, "0x%04x\n", dev->id.device);\r\n}\r\nstatic ssize_t vendor_show(struct device *_d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct virtio_device *dev = container_of(_d,struct virtio_device,dev);\r\nreturn sprintf(buf, "0x%04x\n", dev->id.vendor);\r\n}\r\nstatic ssize_t status_show(struct device *_d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct virtio_device *dev = container_of(_d,struct virtio_device,dev);\r\nreturn sprintf(buf, "0x%08x\n", dev->config->get_status(dev));\r\n}\r\nstatic ssize_t modalias_show(struct device *_d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct virtio_device *dev = container_of(_d,struct virtio_device,dev);\r\nreturn sprintf(buf, "virtio:d%08Xv%08X\n",\r\ndev->id.device, dev->id.vendor);\r\n}\r\nstatic ssize_t features_show(struct device *_d,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct virtio_device *dev = container_of(_d, struct virtio_device, dev);\r\nunsigned int i;\r\nssize_t len = 0;\r\nfor (i = 0; i < ARRAY_SIZE(dev->features)*BITS_PER_LONG; i++)\r\nlen += sprintf(buf+len, "%c",\r\ntest_bit(i, dev->features) ? '1' : '0');\r\nlen += sprintf(buf+len, "\n");\r\nreturn len;\r\n}\r\nstatic inline int virtio_id_match(const struct virtio_device *dev,\r\nconst struct virtio_device_id *id)\r\n{\r\nif (id->device != dev->id.device && id->device != VIRTIO_DEV_ANY_ID)\r\nreturn 0;\r\nreturn id->vendor == VIRTIO_DEV_ANY_ID || id->vendor == dev->id.vendor;\r\n}\r\nstatic int virtio_dev_match(struct device *_dv, struct device_driver *_dr)\r\n{\r\nunsigned int i;\r\nstruct virtio_device *dev = container_of(_dv,struct virtio_device,dev);\r\nconst struct virtio_device_id *ids;\r\nids = container_of(_dr, struct virtio_driver, driver)->id_table;\r\nfor (i = 0; ids[i].device; i++)\r\nif (virtio_id_match(dev, &ids[i]))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int virtio_uevent(struct device *_dv, struct kobj_uevent_env *env)\r\n{\r\nstruct virtio_device *dev = container_of(_dv,struct virtio_device,dev);\r\nreturn add_uevent_var(env, "MODALIAS=virtio:d%08Xv%08X",\r\ndev->id.device, dev->id.vendor);\r\n}\r\nstatic void add_status(struct virtio_device *dev, unsigned status)\r\n{\r\ndev->config->set_status(dev, dev->config->get_status(dev) | status);\r\n}\r\nvoid virtio_check_driver_offered_feature(const struct virtio_device *vdev,\r\nunsigned int fbit)\r\n{\r\nunsigned int i;\r\nstruct virtio_driver *drv = container_of(vdev->dev.driver,\r\nstruct virtio_driver, driver);\r\nfor (i = 0; i < drv->feature_table_size; i++)\r\nif (drv->feature_table[i] == fbit)\r\nreturn;\r\nBUG();\r\n}\r\nstatic int virtio_dev_probe(struct device *_d)\r\n{\r\nint err, i;\r\nstruct virtio_device *dev = container_of(_d,struct virtio_device,dev);\r\nstruct virtio_driver *drv = container_of(dev->dev.driver,\r\nstruct virtio_driver, driver);\r\nu32 device_features;\r\nadd_status(dev, VIRTIO_CONFIG_S_DRIVER);\r\ndevice_features = dev->config->get_features(dev);\r\nmemset(dev->features, 0, sizeof(dev->features));\r\nfor (i = 0; i < drv->feature_table_size; i++) {\r\nunsigned int f = drv->feature_table[i];\r\nBUG_ON(f >= 32);\r\nif (device_features & (1 << f))\r\nset_bit(f, dev->features);\r\n}\r\nfor (i = VIRTIO_TRANSPORT_F_START; i < VIRTIO_TRANSPORT_F_END; i++)\r\nif (device_features & (1 << i))\r\nset_bit(i, dev->features);\r\ndev->config->finalize_features(dev);\r\nerr = drv->probe(dev);\r\nif (err)\r\nadd_status(dev, VIRTIO_CONFIG_S_FAILED);\r\nelse\r\nadd_status(dev, VIRTIO_CONFIG_S_DRIVER_OK);\r\nreturn err;\r\n}\r\nstatic int virtio_dev_remove(struct device *_d)\r\n{\r\nstruct virtio_device *dev = container_of(_d,struct virtio_device,dev);\r\nstruct virtio_driver *drv = container_of(dev->dev.driver,\r\nstruct virtio_driver, driver);\r\ndrv->remove(dev);\r\nBUG_ON(dev->config->get_status(dev));\r\nadd_status(dev, VIRTIO_CONFIG_S_ACKNOWLEDGE);\r\nreturn 0;\r\n}\r\nint register_virtio_driver(struct virtio_driver *driver)\r\n{\r\nBUG_ON(driver->feature_table_size && !driver->feature_table);\r\ndriver->driver.bus = &virtio_bus;\r\nreturn driver_register(&driver->driver);\r\n}\r\nvoid unregister_virtio_driver(struct virtio_driver *driver)\r\n{\r\ndriver_unregister(&driver->driver);\r\n}\r\nint register_virtio_device(struct virtio_device *dev)\r\n{\r\nint err;\r\ndev->dev.bus = &virtio_bus;\r\ndev->index = dev_index++;\r\ndev_set_name(&dev->dev, "virtio%u", dev->index);\r\ndev->config->reset(dev);\r\nadd_status(dev, VIRTIO_CONFIG_S_ACKNOWLEDGE);\r\nINIT_LIST_HEAD(&dev->vqs);\r\nerr = device_register(&dev->dev);\r\nif (err)\r\nadd_status(dev, VIRTIO_CONFIG_S_FAILED);\r\nreturn err;\r\n}\r\nvoid unregister_virtio_device(struct virtio_device *dev)\r\n{\r\ndevice_unregister(&dev->dev);\r\n}\r\nstatic int virtio_init(void)\r\n{\r\nif (bus_register(&virtio_bus) != 0)\r\npanic("virtio bus registration failed");\r\nreturn 0;\r\n}\r\nstatic void __exit virtio_exit(void)\r\n{\r\nbus_unregister(&virtio_bus);\r\n}

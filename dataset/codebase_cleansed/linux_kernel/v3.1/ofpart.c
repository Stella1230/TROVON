int __devinit of_mtd_parse_partitions(struct device *dev,\r\nstruct device_node *node,\r\nstruct mtd_partition **pparts)\r\n{\r\nconst char *partname;\r\nstruct device_node *pp;\r\nint nr_parts, i;\r\npp = NULL;\r\nnr_parts = 0;\r\nwhile ((pp = of_get_next_child(node, pp)))\r\nnr_parts++;\r\nif (nr_parts == 0)\r\nreturn 0;\r\n*pparts = kzalloc(nr_parts * sizeof(**pparts), GFP_KERNEL);\r\nif (!*pparts)\r\nreturn -ENOMEM;\r\npp = NULL;\r\ni = 0;\r\nwhile ((pp = of_get_next_child(node, pp))) {\r\nconst __be32 *reg;\r\nint len;\r\nreg = of_get_property(pp, "reg", &len);\r\nif (!reg) {\r\nnr_parts--;\r\ncontinue;\r\n}\r\n(*pparts)[i].offset = be32_to_cpu(reg[0]);\r\n(*pparts)[i].size = be32_to_cpu(reg[1]);\r\npartname = of_get_property(pp, "label", &len);\r\nif (!partname)\r\npartname = of_get_property(pp, "name", &len);\r\n(*pparts)[i].name = (char *)partname;\r\nif (of_get_property(pp, "read-only", &len))\r\n(*pparts)[i].mask_flags = MTD_WRITEABLE;\r\ni++;\r\n}\r\nif (!i) {\r\nof_node_put(pp);\r\ndev_err(dev, "No valid partition found on %s\n", node->full_name);\r\nkfree(*pparts);\r\n*pparts = NULL;\r\nreturn -EINVAL;\r\n}\r\nreturn nr_parts;\r\n}

int qib_enable_wc(struct qib_devdata *dd)\r\n{\r\nint ret = 0;\r\nu64 pioaddr, piolen;\r\nunsigned bits;\r\nconst unsigned long addr = pci_resource_start(dd->pcidev, 0);\r\nconst size_t len = pci_resource_len(dd->pcidev, 0);\r\nif (dd->piobcnt2k && dd->piobcnt4k) {\r\nunsigned long pio2kbase, pio4kbase;\r\npio2kbase = dd->piobufbase & 0xffffffffUL;\r\npio4kbase = (dd->piobufbase >> 32) & 0xffffffffUL;\r\nif (pio2kbase < pio4kbase) {\r\npioaddr = addr + pio2kbase;\r\npiolen = pio4kbase - pio2kbase +\r\ndd->piobcnt4k * dd->align4k;\r\n} else {\r\npioaddr = addr + pio4kbase;\r\npiolen = pio2kbase - pio4kbase +\r\ndd->piobcnt2k * dd->palign;\r\n}\r\n} else {\r\npioaddr = addr + dd->piobufbase;\r\npiolen = dd->piobcnt2k * dd->palign +\r\ndd->piobcnt4k * dd->align4k;\r\n}\r\nfor (bits = 0; !(piolen & (1ULL << bits)); bits++)\r\n;\r\nif (piolen != (1ULL << bits)) {\r\npiolen >>= bits;\r\nwhile (piolen >>= 1)\r\nbits++;\r\npiolen = 1ULL << (bits + 1);\r\n}\r\nif (pioaddr & (piolen - 1)) {\r\nu64 atmp;\r\natmp = pioaddr & ~(piolen - 1);\r\nif (atmp < addr || (atmp + piolen) > (addr + len)) {\r\nqib_dev_err(dd, "No way to align address/size "\r\n"(%llx/%llx), no WC mtrr\n",\r\n(unsigned long long) atmp,\r\n(unsigned long long) piolen << 1);\r\nret = -ENODEV;\r\n} else {\r\npioaddr = atmp;\r\npiolen <<= 1;\r\n}\r\n}\r\nif (!ret) {\r\nint cookie;\r\ncookie = mtrr_add(pioaddr, piolen, MTRR_TYPE_WRCOMB, 0);\r\nif (cookie < 0) {\r\n{\r\nqib_devinfo(dd->pcidev,\r\n"mtrr_add() WC for PIO bufs "\r\n"failed (%d)\n",\r\ncookie);\r\nret = -EINVAL;\r\n}\r\n} else {\r\ndd->wc_cookie = cookie;\r\ndd->wc_base = (unsigned long) pioaddr;\r\ndd->wc_len = (unsigned long) piolen;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nvoid qib_disable_wc(struct qib_devdata *dd)\r\n{\r\nif (dd->wc_cookie) {\r\nint r;\r\nr = mtrr_del(dd->wc_cookie, dd->wc_base,\r\ndd->wc_len);\r\nif (r < 0)\r\nqib_devinfo(dd->pcidev,\r\n"mtrr_del(%lx, %lx, %lx) failed: %d\n",\r\ndd->wc_cookie, dd->wc_base,\r\ndd->wc_len, r);\r\ndd->wc_cookie = 0;\r\n}\r\n}\r\nint qib_unordered_wc(void)\r\n{\r\nreturn boot_cpu_data.x86_vendor != X86_VENDOR_AMD;\r\n}

static inline unsigned long\r\nnilfs_palloc_groups_per_desc_block(const struct inode *inode)\r\n{\r\nreturn (1UL << inode->i_blkbits) /\r\nsizeof(struct nilfs_palloc_group_desc);\r\n}\r\nstatic inline unsigned long\r\nnilfs_palloc_groups_count(const struct inode *inode)\r\n{\r\nreturn 1UL << (BITS_PER_LONG - (inode->i_blkbits + 3 ));\r\n}\r\nint nilfs_palloc_init_blockgroup(struct inode *inode, unsigned entry_size)\r\n{\r\nstruct nilfs_mdt_info *mi = NILFS_MDT(inode);\r\nmi->mi_bgl = kmalloc(sizeof(*mi->mi_bgl), GFP_NOFS);\r\nif (!mi->mi_bgl)\r\nreturn -ENOMEM;\r\nbgl_lock_init(mi->mi_bgl);\r\nnilfs_mdt_set_entry_size(inode, entry_size, 0);\r\nmi->mi_blocks_per_group =\r\nDIV_ROUND_UP(nilfs_palloc_entries_per_group(inode),\r\nmi->mi_entries_per_block) + 1;\r\nmi->mi_blocks_per_desc_block =\r\nnilfs_palloc_groups_per_desc_block(inode) *\r\nmi->mi_blocks_per_group + 1;\r\nreturn 0;\r\n}\r\nstatic unsigned long nilfs_palloc_group(const struct inode *inode, __u64 nr,\r\nunsigned long *offset)\r\n{\r\n__u64 group = nr;\r\n*offset = do_div(group, nilfs_palloc_entries_per_group(inode));\r\nreturn group;\r\n}\r\nstatic unsigned long\r\nnilfs_palloc_desc_blkoff(const struct inode *inode, unsigned long group)\r\n{\r\nunsigned long desc_block =\r\ngroup / nilfs_palloc_groups_per_desc_block(inode);\r\nreturn desc_block * NILFS_MDT(inode)->mi_blocks_per_desc_block;\r\n}\r\nstatic unsigned long\r\nnilfs_palloc_bitmap_blkoff(const struct inode *inode, unsigned long group)\r\n{\r\nunsigned long desc_offset =\r\ngroup % nilfs_palloc_groups_per_desc_block(inode);\r\nreturn nilfs_palloc_desc_blkoff(inode, group) + 1 +\r\ndesc_offset * NILFS_MDT(inode)->mi_blocks_per_group;\r\n}\r\nstatic unsigned long\r\nnilfs_palloc_group_desc_nfrees(struct inode *inode, unsigned long group,\r\nconst struct nilfs_palloc_group_desc *desc)\r\n{\r\nunsigned long nfree;\r\nspin_lock(nilfs_mdt_bgl_lock(inode, group));\r\nnfree = le32_to_cpu(desc->pg_nfrees);\r\nspin_unlock(nilfs_mdt_bgl_lock(inode, group));\r\nreturn nfree;\r\n}\r\nstatic void\r\nnilfs_palloc_group_desc_add_entries(struct inode *inode,\r\nunsigned long group,\r\nstruct nilfs_palloc_group_desc *desc,\r\nu32 n)\r\n{\r\nspin_lock(nilfs_mdt_bgl_lock(inode, group));\r\nle32_add_cpu(&desc->pg_nfrees, n);\r\nspin_unlock(nilfs_mdt_bgl_lock(inode, group));\r\n}\r\nstatic unsigned long\r\nnilfs_palloc_entry_blkoff(const struct inode *inode, __u64 nr)\r\n{\r\nunsigned long group, group_offset;\r\ngroup = nilfs_palloc_group(inode, nr, &group_offset);\r\nreturn nilfs_palloc_bitmap_blkoff(inode, group) + 1 +\r\ngroup_offset / NILFS_MDT(inode)->mi_entries_per_block;\r\n}\r\nstatic void nilfs_palloc_desc_block_init(struct inode *inode,\r\nstruct buffer_head *bh, void *kaddr)\r\n{\r\nstruct nilfs_palloc_group_desc *desc = kaddr + bh_offset(bh);\r\nunsigned long n = nilfs_palloc_groups_per_desc_block(inode);\r\n__le32 nfrees;\r\nnfrees = cpu_to_le32(nilfs_palloc_entries_per_group(inode));\r\nwhile (n-- > 0) {\r\ndesc->pg_nfrees = nfrees;\r\ndesc++;\r\n}\r\n}\r\nstatic int nilfs_palloc_get_block(struct inode *inode, unsigned long blkoff,\r\nint create,\r\nvoid (*init_block)(struct inode *,\r\nstruct buffer_head *,\r\nvoid *),\r\nstruct buffer_head **bhp,\r\nstruct nilfs_bh_assoc *prev,\r\nspinlock_t *lock)\r\n{\r\nint ret;\r\nspin_lock(lock);\r\nif (prev->bh && blkoff == prev->blkoff) {\r\nget_bh(prev->bh);\r\n*bhp = prev->bh;\r\nspin_unlock(lock);\r\nreturn 0;\r\n}\r\nspin_unlock(lock);\r\nret = nilfs_mdt_get_block(inode, blkoff, create, init_block, bhp);\r\nif (!ret) {\r\nspin_lock(lock);\r\nbrelse(prev->bh);\r\nget_bh(*bhp);\r\nprev->bh = *bhp;\r\nprev->blkoff = blkoff;\r\nspin_unlock(lock);\r\n}\r\nreturn ret;\r\n}\r\nstatic int nilfs_palloc_get_desc_block(struct inode *inode,\r\nunsigned long group,\r\nint create, struct buffer_head **bhp)\r\n{\r\nstruct nilfs_palloc_cache *cache = NILFS_MDT(inode)->mi_palloc_cache;\r\nreturn nilfs_palloc_get_block(inode,\r\nnilfs_palloc_desc_blkoff(inode, group),\r\ncreate, nilfs_palloc_desc_block_init,\r\nbhp, &cache->prev_desc, &cache->lock);\r\n}\r\nstatic int nilfs_palloc_get_bitmap_block(struct inode *inode,\r\nunsigned long group,\r\nint create, struct buffer_head **bhp)\r\n{\r\nstruct nilfs_palloc_cache *cache = NILFS_MDT(inode)->mi_palloc_cache;\r\nreturn nilfs_palloc_get_block(inode,\r\nnilfs_palloc_bitmap_blkoff(inode, group),\r\ncreate, NULL, bhp,\r\n&cache->prev_bitmap, &cache->lock);\r\n}\r\nint nilfs_palloc_get_entry_block(struct inode *inode, __u64 nr,\r\nint create, struct buffer_head **bhp)\r\n{\r\nstruct nilfs_palloc_cache *cache = NILFS_MDT(inode)->mi_palloc_cache;\r\nreturn nilfs_palloc_get_block(inode,\r\nnilfs_palloc_entry_blkoff(inode, nr),\r\ncreate, NULL, bhp,\r\n&cache->prev_entry, &cache->lock);\r\n}\r\nstatic struct nilfs_palloc_group_desc *\r\nnilfs_palloc_block_get_group_desc(const struct inode *inode,\r\nunsigned long group,\r\nconst struct buffer_head *bh, void *kaddr)\r\n{\r\nreturn (struct nilfs_palloc_group_desc *)(kaddr + bh_offset(bh)) +\r\ngroup % nilfs_palloc_groups_per_desc_block(inode);\r\n}\r\nvoid *nilfs_palloc_block_get_entry(const struct inode *inode, __u64 nr,\r\nconst struct buffer_head *bh, void *kaddr)\r\n{\r\nunsigned long entry_offset, group_offset;\r\nnilfs_palloc_group(inode, nr, &group_offset);\r\nentry_offset = group_offset % NILFS_MDT(inode)->mi_entries_per_block;\r\nreturn kaddr + bh_offset(bh) +\r\nentry_offset * NILFS_MDT(inode)->mi_entry_size;\r\n}\r\nstatic int nilfs_palloc_find_available_slot(struct inode *inode,\r\nunsigned long group,\r\nunsigned long target,\r\nunsigned char *bitmap,\r\nint bsize)\r\n{\r\nint curr, pos, end, i;\r\nif (target > 0) {\r\nend = (target + BITS_PER_LONG - 1) & ~(BITS_PER_LONG - 1);\r\nif (end > bsize)\r\nend = bsize;\r\npos = nilfs_find_next_zero_bit(bitmap, end, target);\r\nif (pos < end &&\r\n!nilfs_set_bit_atomic(\r\nnilfs_mdt_bgl_lock(inode, group), pos, bitmap))\r\nreturn pos;\r\n} else\r\nend = 0;\r\nfor (i = 0, curr = end;\r\ni < bsize;\r\ni += BITS_PER_LONG, curr += BITS_PER_LONG) {\r\nif (curr >= bsize)\r\ncurr = 0;\r\nwhile (*((unsigned long *)bitmap + curr / BITS_PER_LONG)\r\n!= ~0UL) {\r\nend = curr + BITS_PER_LONG;\r\nif (end > bsize)\r\nend = bsize;\r\npos = nilfs_find_next_zero_bit(bitmap, end, curr);\r\nif ((pos < end) &&\r\n!nilfs_set_bit_atomic(\r\nnilfs_mdt_bgl_lock(inode, group), pos,\r\nbitmap))\r\nreturn pos;\r\n}\r\n}\r\nreturn -ENOSPC;\r\n}\r\nstatic unsigned long\r\nnilfs_palloc_rest_groups_in_desc_block(const struct inode *inode,\r\nunsigned long curr, unsigned long max)\r\n{\r\nreturn min_t(unsigned long,\r\nnilfs_palloc_groups_per_desc_block(inode) -\r\ncurr % nilfs_palloc_groups_per_desc_block(inode),\r\nmax - curr + 1);\r\n}\r\nint nilfs_palloc_prepare_alloc_entry(struct inode *inode,\r\nstruct nilfs_palloc_req *req)\r\n{\r\nstruct buffer_head *desc_bh, *bitmap_bh;\r\nstruct nilfs_palloc_group_desc *desc;\r\nunsigned char *bitmap;\r\nvoid *desc_kaddr, *bitmap_kaddr;\r\nunsigned long group, maxgroup, ngroups;\r\nunsigned long group_offset, maxgroup_offset;\r\nunsigned long n, entries_per_group, groups_per_desc_block;\r\nunsigned long i, j;\r\nint pos, ret;\r\nngroups = nilfs_palloc_groups_count(inode);\r\nmaxgroup = ngroups - 1;\r\ngroup = nilfs_palloc_group(inode, req->pr_entry_nr, &group_offset);\r\nentries_per_group = nilfs_palloc_entries_per_group(inode);\r\ngroups_per_desc_block = nilfs_palloc_groups_per_desc_block(inode);\r\nfor (i = 0; i < ngroups; i += n) {\r\nif (group >= ngroups) {\r\ngroup = 0;\r\nmaxgroup = nilfs_palloc_group(inode, req->pr_entry_nr,\r\n&maxgroup_offset) - 1;\r\n}\r\nret = nilfs_palloc_get_desc_block(inode, group, 1, &desc_bh);\r\nif (ret < 0)\r\nreturn ret;\r\ndesc_kaddr = kmap(desc_bh->b_page);\r\ndesc = nilfs_palloc_block_get_group_desc(\r\ninode, group, desc_bh, desc_kaddr);\r\nn = nilfs_palloc_rest_groups_in_desc_block(inode, group,\r\nmaxgroup);\r\nfor (j = 0; j < n; j++, desc++, group++) {\r\nif (nilfs_palloc_group_desc_nfrees(inode, group, desc)\r\n> 0) {\r\nret = nilfs_palloc_get_bitmap_block(\r\ninode, group, 1, &bitmap_bh);\r\nif (ret < 0)\r\ngoto out_desc;\r\nbitmap_kaddr = kmap(bitmap_bh->b_page);\r\nbitmap = bitmap_kaddr + bh_offset(bitmap_bh);\r\npos = nilfs_palloc_find_available_slot(\r\ninode, group, group_offset, bitmap,\r\nentries_per_group);\r\nif (pos >= 0) {\r\nnilfs_palloc_group_desc_add_entries(\r\ninode, group, desc, -1);\r\nreq->pr_entry_nr =\r\nentries_per_group * group + pos;\r\nkunmap(desc_bh->b_page);\r\nkunmap(bitmap_bh->b_page);\r\nreq->pr_desc_bh = desc_bh;\r\nreq->pr_bitmap_bh = bitmap_bh;\r\nreturn 0;\r\n}\r\nkunmap(bitmap_bh->b_page);\r\nbrelse(bitmap_bh);\r\n}\r\ngroup_offset = 0;\r\n}\r\nkunmap(desc_bh->b_page);\r\nbrelse(desc_bh);\r\n}\r\nreturn -ENOSPC;\r\nout_desc:\r\nkunmap(desc_bh->b_page);\r\nbrelse(desc_bh);\r\nreturn ret;\r\n}\r\nvoid nilfs_palloc_commit_alloc_entry(struct inode *inode,\r\nstruct nilfs_palloc_req *req)\r\n{\r\nmark_buffer_dirty(req->pr_bitmap_bh);\r\nmark_buffer_dirty(req->pr_desc_bh);\r\nnilfs_mdt_mark_dirty(inode);\r\nbrelse(req->pr_bitmap_bh);\r\nbrelse(req->pr_desc_bh);\r\n}\r\nvoid nilfs_palloc_commit_free_entry(struct inode *inode,\r\nstruct nilfs_palloc_req *req)\r\n{\r\nstruct nilfs_palloc_group_desc *desc;\r\nunsigned long group, group_offset;\r\nunsigned char *bitmap;\r\nvoid *desc_kaddr, *bitmap_kaddr;\r\ngroup = nilfs_palloc_group(inode, req->pr_entry_nr, &group_offset);\r\ndesc_kaddr = kmap(req->pr_desc_bh->b_page);\r\ndesc = nilfs_palloc_block_get_group_desc(inode, group,\r\nreq->pr_desc_bh, desc_kaddr);\r\nbitmap_kaddr = kmap(req->pr_bitmap_bh->b_page);\r\nbitmap = bitmap_kaddr + bh_offset(req->pr_bitmap_bh);\r\nif (!nilfs_clear_bit_atomic(nilfs_mdt_bgl_lock(inode, group),\r\ngroup_offset, bitmap))\r\nprintk(KERN_WARNING "%s: entry number %llu already freed\n",\r\n__func__, (unsigned long long)req->pr_entry_nr);\r\nelse\r\nnilfs_palloc_group_desc_add_entries(inode, group, desc, 1);\r\nkunmap(req->pr_bitmap_bh->b_page);\r\nkunmap(req->pr_desc_bh->b_page);\r\nmark_buffer_dirty(req->pr_desc_bh);\r\nmark_buffer_dirty(req->pr_bitmap_bh);\r\nnilfs_mdt_mark_dirty(inode);\r\nbrelse(req->pr_bitmap_bh);\r\nbrelse(req->pr_desc_bh);\r\n}\r\nvoid nilfs_palloc_abort_alloc_entry(struct inode *inode,\r\nstruct nilfs_palloc_req *req)\r\n{\r\nstruct nilfs_palloc_group_desc *desc;\r\nvoid *desc_kaddr, *bitmap_kaddr;\r\nunsigned char *bitmap;\r\nunsigned long group, group_offset;\r\ngroup = nilfs_palloc_group(inode, req->pr_entry_nr, &group_offset);\r\ndesc_kaddr = kmap(req->pr_desc_bh->b_page);\r\ndesc = nilfs_palloc_block_get_group_desc(inode, group,\r\nreq->pr_desc_bh, desc_kaddr);\r\nbitmap_kaddr = kmap(req->pr_bitmap_bh->b_page);\r\nbitmap = bitmap_kaddr + bh_offset(req->pr_bitmap_bh);\r\nif (!nilfs_clear_bit_atomic(nilfs_mdt_bgl_lock(inode, group),\r\ngroup_offset, bitmap))\r\nprintk(KERN_WARNING "%s: entry number %llu already freed\n",\r\n__func__, (unsigned long long)req->pr_entry_nr);\r\nelse\r\nnilfs_palloc_group_desc_add_entries(inode, group, desc, 1);\r\nkunmap(req->pr_bitmap_bh->b_page);\r\nkunmap(req->pr_desc_bh->b_page);\r\nbrelse(req->pr_bitmap_bh);\r\nbrelse(req->pr_desc_bh);\r\nreq->pr_entry_nr = 0;\r\nreq->pr_bitmap_bh = NULL;\r\nreq->pr_desc_bh = NULL;\r\n}\r\nint nilfs_palloc_prepare_free_entry(struct inode *inode,\r\nstruct nilfs_palloc_req *req)\r\n{\r\nstruct buffer_head *desc_bh, *bitmap_bh;\r\nunsigned long group, group_offset;\r\nint ret;\r\ngroup = nilfs_palloc_group(inode, req->pr_entry_nr, &group_offset);\r\nret = nilfs_palloc_get_desc_block(inode, group, 1, &desc_bh);\r\nif (ret < 0)\r\nreturn ret;\r\nret = nilfs_palloc_get_bitmap_block(inode, group, 1, &bitmap_bh);\r\nif (ret < 0) {\r\nbrelse(desc_bh);\r\nreturn ret;\r\n}\r\nreq->pr_desc_bh = desc_bh;\r\nreq->pr_bitmap_bh = bitmap_bh;\r\nreturn 0;\r\n}\r\nvoid nilfs_palloc_abort_free_entry(struct inode *inode,\r\nstruct nilfs_palloc_req *req)\r\n{\r\nbrelse(req->pr_bitmap_bh);\r\nbrelse(req->pr_desc_bh);\r\nreq->pr_entry_nr = 0;\r\nreq->pr_bitmap_bh = NULL;\r\nreq->pr_desc_bh = NULL;\r\n}\r\nstatic int\r\nnilfs_palloc_group_is_in(struct inode *inode, unsigned long group, __u64 nr)\r\n{\r\n__u64 first, last;\r\nfirst = group * nilfs_palloc_entries_per_group(inode);\r\nlast = first + nilfs_palloc_entries_per_group(inode) - 1;\r\nreturn (nr >= first) && (nr <= last);\r\n}\r\nint nilfs_palloc_freev(struct inode *inode, __u64 *entry_nrs, size_t nitems)\r\n{\r\nstruct buffer_head *desc_bh, *bitmap_bh;\r\nstruct nilfs_palloc_group_desc *desc;\r\nunsigned char *bitmap;\r\nvoid *desc_kaddr, *bitmap_kaddr;\r\nunsigned long group, group_offset;\r\nint i, j, n, ret;\r\nfor (i = 0; i < nitems; i = j) {\r\ngroup = nilfs_palloc_group(inode, entry_nrs[i], &group_offset);\r\nret = nilfs_palloc_get_desc_block(inode, group, 0, &desc_bh);\r\nif (ret < 0)\r\nreturn ret;\r\nret = nilfs_palloc_get_bitmap_block(inode, group, 0,\r\n&bitmap_bh);\r\nif (ret < 0) {\r\nbrelse(desc_bh);\r\nreturn ret;\r\n}\r\ndesc_kaddr = kmap(desc_bh->b_page);\r\ndesc = nilfs_palloc_block_get_group_desc(\r\ninode, group, desc_bh, desc_kaddr);\r\nbitmap_kaddr = kmap(bitmap_bh->b_page);\r\nbitmap = bitmap_kaddr + bh_offset(bitmap_bh);\r\nfor (j = i, n = 0;\r\n(j < nitems) && nilfs_palloc_group_is_in(inode, group,\r\nentry_nrs[j]);\r\nj++) {\r\nnilfs_palloc_group(inode, entry_nrs[j], &group_offset);\r\nif (!nilfs_clear_bit_atomic(\r\nnilfs_mdt_bgl_lock(inode, group),\r\ngroup_offset, bitmap)) {\r\nprintk(KERN_WARNING\r\n"%s: entry number %llu already freed\n",\r\n__func__,\r\n(unsigned long long)entry_nrs[j]);\r\n} else {\r\nn++;\r\n}\r\n}\r\nnilfs_palloc_group_desc_add_entries(inode, group, desc, n);\r\nkunmap(bitmap_bh->b_page);\r\nkunmap(desc_bh->b_page);\r\nmark_buffer_dirty(desc_bh);\r\nmark_buffer_dirty(bitmap_bh);\r\nnilfs_mdt_mark_dirty(inode);\r\nbrelse(bitmap_bh);\r\nbrelse(desc_bh);\r\n}\r\nreturn 0;\r\n}\r\nvoid nilfs_palloc_setup_cache(struct inode *inode,\r\nstruct nilfs_palloc_cache *cache)\r\n{\r\nNILFS_MDT(inode)->mi_palloc_cache = cache;\r\nspin_lock_init(&cache->lock);\r\n}\r\nvoid nilfs_palloc_clear_cache(struct inode *inode)\r\n{\r\nstruct nilfs_palloc_cache *cache = NILFS_MDT(inode)->mi_palloc_cache;\r\nspin_lock(&cache->lock);\r\nbrelse(cache->prev_desc.bh);\r\nbrelse(cache->prev_bitmap.bh);\r\nbrelse(cache->prev_entry.bh);\r\ncache->prev_desc.bh = NULL;\r\ncache->prev_bitmap.bh = NULL;\r\ncache->prev_entry.bh = NULL;\r\nspin_unlock(&cache->lock);\r\n}\r\nvoid nilfs_palloc_destroy_cache(struct inode *inode)\r\n{\r\nnilfs_palloc_clear_cache(inode);\r\nNILFS_MDT(inode)->mi_palloc_cache = NULL;\r\n}

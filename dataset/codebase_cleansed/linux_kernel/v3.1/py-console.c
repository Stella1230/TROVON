static unsigned char readb_outer_space(unsigned long long phys)\r\n{\r\nunsigned long long vaddr = IO_BASE_64 | phys;\r\nunsigned char res;\r\nunsigned int sr;\r\nsr = read_c0_status();\r\nwrite_c0_status((sr | ST0_KX) & ~ ST0_IE);\r\nssnop_4();\r\n__asm__ __volatile__ (\r\n" .set mips3 \n"\r\n" .set push \n"\r\n" .set noreorder \n"\r\n" .set nomacro \n"\r\n" ld %0, %1 \n"\r\n" .set pop \n"\r\n" lbu %0, (%0) \n"\r\n" .set mips0 \n"\r\n: "=r" (res)\r\n: "R" (vaddr));\r\nwrite_c0_status(sr);\r\nssnop_4();\r\nreturn res;\r\n}\r\nstatic void writeb_outer_space(unsigned long long phys, unsigned char c)\r\n{\r\nunsigned long long vaddr = IO_BASE_64 | phys;\r\nunsigned long tmp;\r\nunsigned int sr;\r\nsr = read_c0_status();\r\nwrite_c0_status((sr | ST0_KX) & ~ ST0_IE);\r\nssnop_4();\r\n__asm__ __volatile__ (\r\n" .set mips3 \n"\r\n" .set push \n"\r\n" .set noreorder \n"\r\n" .set nomacro \n"\r\n" ld %0, %1 \n"\r\n" .set pop \n"\r\n" sb %2, (%0) \n"\r\n" .set mips0 \n"\r\n: "=&r" (tmp)\r\n: "R" (vaddr), "r" (c));\r\nwrite_c0_status(sr);\r\nssnop_4();\r\n}\r\nvoid prom_putchar(char c)\r\n{\r\nunsigned long lsr = 0xfd000008ULL + offsetof(struct yo_uartregs, iu_lsr);\r\nunsigned long thr = 0xfd000008ULL + offsetof(struct yo_uartregs, iu_thr);\r\nwhile ((readb_outer_space(lsr) & 0x20) == 0);\r\nwriteb_outer_space(thr, c);\r\n}

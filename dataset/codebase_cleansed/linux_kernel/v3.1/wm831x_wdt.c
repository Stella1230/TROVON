static int wm831x_wdt_set_timeout(struct wm831x *wm831x, u16 value)\r\n{\r\nint ret;\r\nmutex_lock(&wdt_mutex);\r\nret = wm831x_reg_unlock(wm831x);\r\nif (ret == 0) {\r\nret = wm831x_set_bits(wm831x, WM831X_WATCHDOG,\r\nWM831X_WDOG_TO_MASK, value);\r\nwm831x_reg_lock(wm831x);\r\n} else {\r\ndev_err(wm831x->dev, "Failed to unlock security key: %d\n",\r\nret);\r\n}\r\nmutex_unlock(&wdt_mutex);\r\nreturn ret;\r\n}\r\nstatic int wm831x_wdt_start(struct wm831x *wm831x)\r\n{\r\nint ret;\r\nmutex_lock(&wdt_mutex);\r\nret = wm831x_reg_unlock(wm831x);\r\nif (ret == 0) {\r\nret = wm831x_set_bits(wm831x, WM831X_WATCHDOG,\r\nWM831X_WDOG_ENA, WM831X_WDOG_ENA);\r\nwm831x_reg_lock(wm831x);\r\n} else {\r\ndev_err(wm831x->dev, "Failed to unlock security key: %d\n",\r\nret);\r\n}\r\nmutex_unlock(&wdt_mutex);\r\nreturn ret;\r\n}\r\nstatic int wm831x_wdt_stop(struct wm831x *wm831x)\r\n{\r\nint ret;\r\nmutex_lock(&wdt_mutex);\r\nret = wm831x_reg_unlock(wm831x);\r\nif (ret == 0) {\r\nret = wm831x_set_bits(wm831x, WM831X_WATCHDOG,\r\nWM831X_WDOG_ENA, 0);\r\nwm831x_reg_lock(wm831x);\r\n} else {\r\ndev_err(wm831x->dev, "Failed to unlock security key: %d\n",\r\nret);\r\n}\r\nmutex_unlock(&wdt_mutex);\r\nreturn ret;\r\n}\r\nstatic int wm831x_wdt_kick(struct wm831x *wm831x)\r\n{\r\nint ret;\r\nu16 reg;\r\nmutex_lock(&wdt_mutex);\r\nif (update_gpio) {\r\ngpio_set_value_cansleep(update_gpio, update_state);\r\nupdate_state = !update_state;\r\nret = 0;\r\ngoto out;\r\n}\r\nreg = wm831x_reg_read(wm831x, WM831X_WATCHDOG);\r\nif (!(reg & WM831X_WDOG_RST_SRC)) {\r\ndev_err(wm831x->dev, "Hardware watchdog update unsupported\n");\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nreg |= WM831X_WDOG_RESET;\r\nret = wm831x_reg_unlock(wm831x);\r\nif (ret == 0) {\r\nret = wm831x_reg_write(wm831x, WM831X_WATCHDOG, reg);\r\nwm831x_reg_lock(wm831x);\r\n} else {\r\ndev_err(wm831x->dev, "Failed to unlock security key: %d\n",\r\nret);\r\n}\r\nout:\r\nmutex_unlock(&wdt_mutex);\r\nreturn ret;\r\n}\r\nstatic int wm831x_wdt_open(struct inode *inode, struct file *file)\r\n{\r\nint ret;\r\nif (!wm831x)\r\nreturn -ENODEV;\r\nif (test_and_set_bit(0, &wm831x_wdt_users))\r\nreturn -EBUSY;\r\nret = wm831x_wdt_start(wm831x);\r\nif (ret != 0)\r\nreturn ret;\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic int wm831x_wdt_release(struct inode *inode, struct file *file)\r\n{\r\nif (wm831x_wdt_expect_close)\r\nwm831x_wdt_stop(wm831x);\r\nelse {\r\ndev_warn(wm831x->dev, "Watchdog device closed uncleanly\n");\r\nwm831x_wdt_kick(wm831x);\r\n}\r\nclear_bit(0, &wm831x_wdt_users);\r\nreturn 0;\r\n}\r\nstatic ssize_t wm831x_wdt_write(struct file *file,\r\nconst char __user *data, size_t count,\r\nloff_t *ppos)\r\n{\r\nsize_t i;\r\nif (count) {\r\nwm831x_wdt_kick(wm831x);\r\nif (!nowayout) {\r\nwm831x_wdt_expect_close = 0;\r\nfor (i = 0; i != count; i++) {\r\nchar c;\r\nif (get_user(c, data + i))\r\nreturn -EFAULT;\r\nif (c == 'V')\r\nwm831x_wdt_expect_close = 42;\r\n}\r\n}\r\n}\r\nreturn count;\r\n}\r\nstatic long wm831x_wdt_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nint ret = -ENOTTY, time, i;\r\nvoid __user *argp = (void __user *)arg;\r\nint __user *p = argp;\r\nu16 reg;\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nret = copy_to_user(argp, &ident, sizeof(ident)) ? -EFAULT : 0;\r\nbreak;\r\ncase WDIOC_GETSTATUS:\r\ncase WDIOC_GETBOOTSTATUS:\r\nret = put_user(0, p);\r\nbreak;\r\ncase WDIOC_SETOPTIONS:\r\n{\r\nint options;\r\nif (get_user(options, p))\r\nreturn -EFAULT;\r\nret = -EINVAL;\r\nif (options == WDIOS_DISABLECARD)\r\nret = wm831x_wdt_start(wm831x);\r\nif (options == WDIOS_ENABLECARD)\r\nret = wm831x_wdt_stop(wm831x);\r\nbreak;\r\n}\r\ncase WDIOC_KEEPALIVE:\r\nret = wm831x_wdt_kick(wm831x);\r\nbreak;\r\ncase WDIOC_SETTIMEOUT:\r\nret = get_user(time, p);\r\nif (ret)\r\nbreak;\r\nif (time == 0) {\r\nif (nowayout)\r\nret = -EINVAL;\r\nelse\r\nwm831x_wdt_stop(wm831x);\r\nbreak;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(wm831x_wdt_cfgs); i++)\r\nif (wm831x_wdt_cfgs[i].time == time)\r\nbreak;\r\nif (i == ARRAY_SIZE(wm831x_wdt_cfgs))\r\nret = -EINVAL;\r\nelse\r\nret = wm831x_wdt_set_timeout(wm831x,\r\nwm831x_wdt_cfgs[i].val);\r\nbreak;\r\ncase WDIOC_GETTIMEOUT:\r\nreg = wm831x_reg_read(wm831x, WM831X_WATCHDOG);\r\nreg &= WM831X_WDOG_TO_MASK;\r\nfor (i = 0; i < ARRAY_SIZE(wm831x_wdt_cfgs); i++)\r\nif (wm831x_wdt_cfgs[i].val == reg)\r\nbreak;\r\nif (i == ARRAY_SIZE(wm831x_wdt_cfgs)) {\r\ndev_warn(wm831x->dev,\r\n"Unknown watchdog configuration: %x\n", reg);\r\nret = -EINVAL;\r\n} else\r\nret = put_user(wm831x_wdt_cfgs[i].time, p);\r\n}\r\nreturn ret;\r\n}\r\nstatic int __devinit wm831x_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct wm831x_pdata *chip_pdata;\r\nstruct wm831x_watchdog_pdata *pdata;\r\nint reg, ret;\r\nif (wm831x) {\r\ndev_err(&pdev->dev, "wm831x watchdog already registered\n");\r\nreturn -EBUSY;\r\n}\r\nwm831x = dev_get_drvdata(pdev->dev.parent);\r\nret = wm831x_reg_read(wm831x, WM831X_WATCHDOG);\r\nif (ret < 0) {\r\ndev_err(wm831x->dev, "Failed to read watchdog status: %d\n",\r\nret);\r\ngoto err;\r\n}\r\nreg = ret;\r\nif (reg & WM831X_WDOG_DEBUG)\r\ndev_warn(wm831x->dev, "Watchdog is paused\n");\r\nif (pdev->dev.parent->platform_data) {\r\nchip_pdata = pdev->dev.parent->platform_data;\r\npdata = chip_pdata->watchdog;\r\n} else {\r\npdata = NULL;\r\n}\r\nif (pdata) {\r\nreg &= ~(WM831X_WDOG_SECACT_MASK | WM831X_WDOG_PRIMACT_MASK |\r\nWM831X_WDOG_RST_SRC);\r\nreg |= pdata->primary << WM831X_WDOG_PRIMACT_SHIFT;\r\nreg |= pdata->secondary << WM831X_WDOG_SECACT_SHIFT;\r\nreg |= pdata->software << WM831X_WDOG_RST_SRC_SHIFT;\r\nif (pdata->update_gpio) {\r\nret = gpio_request(pdata->update_gpio,\r\n"Watchdog update");\r\nif (ret < 0) {\r\ndev_err(wm831x->dev,\r\n"Failed to request update GPIO: %d\n",\r\nret);\r\ngoto err;\r\n}\r\nret = gpio_direction_output(pdata->update_gpio, 0);\r\nif (ret != 0) {\r\ndev_err(wm831x->dev,\r\n"gpio_direction_output returned: %d\n",\r\nret);\r\ngoto err_gpio;\r\n}\r\nupdate_gpio = pdata->update_gpio;\r\nreg |= WM831X_WDOG_RST_SRC;\r\n}\r\nret = wm831x_reg_unlock(wm831x);\r\nif (ret == 0) {\r\nret = wm831x_reg_write(wm831x, WM831X_WATCHDOG, reg);\r\nwm831x_reg_lock(wm831x);\r\n} else {\r\ndev_err(wm831x->dev,\r\n"Failed to unlock security key: %d\n", ret);\r\ngoto err_gpio;\r\n}\r\n}\r\nwm831x_wdt_miscdev.parent = &pdev->dev;\r\nret = misc_register(&wm831x_wdt_miscdev);\r\nif (ret != 0) {\r\ndev_err(wm831x->dev, "Failed to register miscdev: %d\n", ret);\r\ngoto err_gpio;\r\n}\r\nreturn 0;\r\nerr_gpio:\r\nif (update_gpio) {\r\ngpio_free(update_gpio);\r\nupdate_gpio = 0;\r\n}\r\nerr:\r\nreturn ret;\r\n}\r\nstatic int __devexit wm831x_wdt_remove(struct platform_device *pdev)\r\n{\r\nif (update_gpio) {\r\ngpio_free(update_gpio);\r\nupdate_gpio = 0;\r\n}\r\nmisc_deregister(&wm831x_wdt_miscdev);\r\nreturn 0;\r\n}\r\nstatic int __init wm831x_wdt_init(void)\r\n{\r\nreturn platform_driver_register(&wm831x_wdt_driver);\r\n}\r\nstatic void __exit wm831x_wdt_exit(void)\r\n{\r\nplatform_driver_unregister(&wm831x_wdt_driver);\r\n}

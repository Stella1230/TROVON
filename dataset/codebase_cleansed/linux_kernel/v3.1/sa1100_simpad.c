static int simpad_pcmcia_hw_init(struct soc_pcmcia_socket *skt)\r\n{\r\nclear_cs3_bit(VCC_3V_EN|VCC_5V_EN|EN0|EN1);\r\nskt->socket.pci_irq = IRQ_GPIO_CF_IRQ;\r\nreturn soc_pcmcia_request_irqs(skt, irqs, ARRAY_SIZE(irqs));\r\n}\r\nstatic void simpad_pcmcia_hw_shutdown(struct soc_pcmcia_socket *skt)\r\n{\r\nsoc_pcmcia_free_irqs(skt, irqs, ARRAY_SIZE(irqs));\r\nclear_cs3_bit(PCMCIA_RESET);\r\n}\r\nstatic void\r\nsimpad_pcmcia_socket_state(struct soc_pcmcia_socket *skt,\r\nstruct pcmcia_state *state)\r\n{\r\nunsigned long levels = GPLR;\r\nlong cs3reg = get_cs3_shadow();\r\nstate->detect=((levels & GPIO_CF_CD)==0)?1:0;\r\nstate->ready=(levels & GPIO_CF_IRQ)?1:0;\r\nstate->bvd1=1;\r\nstate->bvd2=1;\r\nstate->wrprot=0;\r\nif((cs3reg & 0x0c) == 0x0c) {\r\nstate->vs_3v=0;\r\nstate->vs_Xv=0;\r\n} else {\r\nstate->vs_3v=1;\r\nstate->vs_Xv=0;\r\n}\r\n}\r\nstatic int\r\nsimpad_pcmcia_configure_socket(struct soc_pcmcia_socket *skt,\r\nconst socket_state_t *state)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nswitch (state->Vcc) {\r\ncase 0:\r\nclear_cs3_bit(VCC_3V_EN|VCC_5V_EN|EN0|EN1);\r\nbreak;\r\ncase 33:\r\nclear_cs3_bit(VCC_3V_EN|EN1);\r\nset_cs3_bit(VCC_5V_EN|EN0);\r\nbreak;\r\ncase 50:\r\nclear_cs3_bit(VCC_5V_EN|EN1);\r\nset_cs3_bit(VCC_3V_EN|EN0);\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "%s(): unrecognized Vcc %u\n",\r\n__func__, state->Vcc);\r\nclear_cs3_bit(VCC_3V_EN|VCC_5V_EN|EN0|EN1);\r\nlocal_irq_restore(flags);\r\nreturn -1;\r\n}\r\nlocal_irq_restore(flags);\r\nreturn 0;\r\n}\r\nstatic void simpad_pcmcia_socket_init(struct soc_pcmcia_socket *skt)\r\n{\r\nsoc_pcmcia_enable_irqs(skt, irqs, ARRAY_SIZE(irqs));\r\n}\r\nstatic void simpad_pcmcia_socket_suspend(struct soc_pcmcia_socket *skt)\r\n{\r\nsoc_pcmcia_disable_irqs(skt, irqs, ARRAY_SIZE(irqs));\r\nset_cs3_bit(PCMCIA_RESET);\r\n}\r\nint __devinit pcmcia_simpad_init(struct device *dev)\r\n{\r\nint ret = -ENODEV;\r\nif (machine_is_simpad())\r\nret = sa11xx_drv_pcmcia_probe(dev, &simpad_pcmcia_ops, 1, 1);\r\nreturn ret;\r\n}

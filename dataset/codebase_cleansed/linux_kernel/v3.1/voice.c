static int voice_alloc(struct snd_emu10k1 *emu, int type, int number,\r\nstruct snd_emu10k1_voice **rvoice)\r\n{\r\nstruct snd_emu10k1_voice *voice;\r\nint i, j, k, first_voice, last_voice, skip;\r\n*rvoice = NULL;\r\nfirst_voice = last_voice = 0;\r\nfor (i = emu->next_free_voice, j = 0; j < NUM_G ; i += number, j += number) {\r\ni %= NUM_G;\r\nif ((number == 2) && (i % 2)) {\r\ni++;\r\ncontinue;\r\n}\r\nskip = 0;\r\nfor (k = 0; k < number; k++) {\r\nvoice = &emu->voices[(i+k) % NUM_G];\r\nif (voice->use) {\r\nskip = 1;\r\nbreak;\r\n}\r\n}\r\nif (!skip) {\r\nfirst_voice = i;\r\nlast_voice = (i + number) % NUM_G;\r\nemu->next_free_voice = last_voice;\r\nbreak;\r\n}\r\n}\r\nif (first_voice == last_voice)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < number; i++) {\r\nvoice = &emu->voices[(first_voice + i) % NUM_G];\r\nvoice->use = 1;\r\nswitch (type) {\r\ncase EMU10K1_PCM:\r\nvoice->pcm = 1;\r\nbreak;\r\ncase EMU10K1_SYNTH:\r\nvoice->synth = 1;\r\nbreak;\r\ncase EMU10K1_MIDI:\r\nvoice->midi = 1;\r\nbreak;\r\ncase EMU10K1_EFX:\r\nvoice->efx = 1;\r\nbreak;\r\n}\r\n}\r\n*rvoice = &emu->voices[first_voice];\r\nreturn 0;\r\n}\r\nint snd_emu10k1_voice_alloc(struct snd_emu10k1 *emu, int type, int number,\r\nstruct snd_emu10k1_voice **rvoice)\r\n{\r\nunsigned long flags;\r\nint result;\r\nif (snd_BUG_ON(!rvoice))\r\nreturn -EINVAL;\r\nif (snd_BUG_ON(!number))\r\nreturn -EINVAL;\r\nspin_lock_irqsave(&emu->voice_lock, flags);\r\nfor (;;) {\r\nresult = voice_alloc(emu, type, number, rvoice);\r\nif (result == 0 || type == EMU10K1_SYNTH || type == EMU10K1_MIDI)\r\nbreak;\r\nif (emu->get_synth_voice) {\r\nresult = emu->get_synth_voice(emu);\r\nif (result >= 0) {\r\nstruct snd_emu10k1_voice *pvoice = &emu->voices[result];\r\npvoice->interrupt = NULL;\r\npvoice->use = pvoice->pcm = pvoice->synth = pvoice->midi = pvoice->efx = 0;\r\npvoice->epcm = NULL;\r\n}\r\n}\r\nif (result < 0)\r\nbreak;\r\n}\r\nspin_unlock_irqrestore(&emu->voice_lock, flags);\r\nreturn result;\r\n}\r\nint snd_emu10k1_voice_free(struct snd_emu10k1 *emu,\r\nstruct snd_emu10k1_voice *pvoice)\r\n{\r\nunsigned long flags;\r\nif (snd_BUG_ON(!pvoice))\r\nreturn -EINVAL;\r\nspin_lock_irqsave(&emu->voice_lock, flags);\r\npvoice->interrupt = NULL;\r\npvoice->use = pvoice->pcm = pvoice->synth = pvoice->midi = pvoice->efx = 0;\r\npvoice->epcm = NULL;\r\nsnd_emu10k1_voice_init(emu, pvoice->number);\r\nspin_unlock_irqrestore(&emu->voice_lock, flags);\r\nreturn 0;\r\n}

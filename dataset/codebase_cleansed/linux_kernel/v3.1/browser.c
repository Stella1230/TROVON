static int ui_browser__percent_color(double percent, bool current)\r\n{\r\nif (current)\r\nreturn HE_COLORSET_SELECTED;\r\nif (percent >= MIN_RED)\r\nreturn HE_COLORSET_TOP;\r\nif (percent >= MIN_GREEN)\r\nreturn HE_COLORSET_MEDIUM;\r\nreturn HE_COLORSET_NORMAL;\r\n}\r\nvoid ui_browser__set_color(struct ui_browser *self __used, int color)\r\n{\r\nSLsmg_set_color(color);\r\n}\r\nvoid ui_browser__set_percent_color(struct ui_browser *self,\r\ndouble percent, bool current)\r\n{\r\nint color = ui_browser__percent_color(percent, current);\r\nui_browser__set_color(self, color);\r\n}\r\nvoid ui_browser__gotorc(struct ui_browser *self, int y, int x)\r\n{\r\nSLsmg_gotorc(self->y + y, self->x + x);\r\n}\r\nvoid ui_browser__list_head_seek(struct ui_browser *self, off_t offset, int whence)\r\n{\r\nstruct list_head *head = self->entries;\r\nstruct list_head *pos;\r\nswitch (whence) {\r\ncase SEEK_SET:\r\npos = head->next;\r\nbreak;\r\ncase SEEK_CUR:\r\npos = self->top;\r\nbreak;\r\ncase SEEK_END:\r\npos = head->prev;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nif (offset > 0) {\r\nwhile (offset-- != 0)\r\npos = pos->next;\r\n} else {\r\nwhile (offset++ != 0)\r\npos = pos->prev;\r\n}\r\nself->top = pos;\r\n}\r\nvoid ui_browser__rb_tree_seek(struct ui_browser *self, off_t offset, int whence)\r\n{\r\nstruct rb_root *root = self->entries;\r\nstruct rb_node *nd;\r\nswitch (whence) {\r\ncase SEEK_SET:\r\nnd = rb_first(root);\r\nbreak;\r\ncase SEEK_CUR:\r\nnd = self->top;\r\nbreak;\r\ncase SEEK_END:\r\nnd = rb_last(root);\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nif (offset > 0) {\r\nwhile (offset-- != 0)\r\nnd = rb_next(nd);\r\n} else {\r\nwhile (offset++ != 0)\r\nnd = rb_prev(nd);\r\n}\r\nself->top = nd;\r\n}\r\nunsigned int ui_browser__rb_tree_refresh(struct ui_browser *self)\r\n{\r\nstruct rb_node *nd;\r\nint row = 0;\r\nif (self->top == NULL)\r\nself->top = rb_first(self->entries);\r\nnd = self->top;\r\nwhile (nd != NULL) {\r\nui_browser__gotorc(self, row, 0);\r\nself->write(self, nd, row);\r\nif (++row == self->height)\r\nbreak;\r\nnd = rb_next(nd);\r\n}\r\nreturn row;\r\n}\r\nbool ui_browser__is_current_entry(struct ui_browser *self, unsigned row)\r\n{\r\nreturn self->top_idx + row == self->index;\r\n}\r\nvoid ui_browser__refresh_dimensions(struct ui_browser *self)\r\n{\r\nint cols, rows;\r\nnewtGetScreenSize(&cols, &rows);\r\nself->width = cols - 1;\r\nself->height = rows - 2;\r\nself->y = 1;\r\nself->x = 0;\r\n}\r\nvoid ui_browser__reset_index(struct ui_browser *self)\r\n{\r\nself->index = self->top_idx = 0;\r\nself->seek(self, 0, SEEK_SET);\r\n}\r\nvoid ui_browser__add_exit_key(struct ui_browser *self, int key)\r\n{\r\nnewtFormAddHotKey(self->form, key);\r\n}\r\nvoid ui_browser__add_exit_keys(struct ui_browser *self, int keys[])\r\n{\r\nint i = 0;\r\nwhile (keys[i] && i < 64) {\r\nui_browser__add_exit_key(self, keys[i]);\r\n++i;\r\n}\r\n}\r\nvoid __ui_browser__show_title(struct ui_browser *browser, const char *title)\r\n{\r\nSLsmg_gotorc(0, 0);\r\nui_browser__set_color(browser, NEWT_COLORSET_ROOT);\r\nslsmg_write_nstring(title, browser->width);\r\n}\r\nvoid ui_browser__show_title(struct ui_browser *browser, const char *title)\r\n{\r\npthread_mutex_lock(&ui__lock);\r\n__ui_browser__show_title(browser, title);\r\npthread_mutex_unlock(&ui__lock);\r\n}\r\nint ui_browser__show(struct ui_browser *self, const char *title,\r\nconst char *helpline, ...)\r\n{\r\nva_list ap;\r\nint keys[] = { NEWT_KEY_UP, NEWT_KEY_DOWN, NEWT_KEY_PGUP,\r\nNEWT_KEY_PGDN, NEWT_KEY_HOME, NEWT_KEY_END, ' ',\r\nNEWT_KEY_LEFT, NEWT_KEY_ESCAPE, 'q', CTRL('c'), 0 };\r\nif (self->form != NULL)\r\nnewtFormDestroy(self->form);\r\nui_browser__refresh_dimensions(self);\r\nself->form = newtForm(NULL, NULL, 0);\r\nif (self->form == NULL)\r\nreturn -1;\r\nself->sb = newtVerticalScrollbar(self->width, 1, self->height,\r\nHE_COLORSET_NORMAL,\r\nHE_COLORSET_SELECTED);\r\nif (self->sb == NULL)\r\nreturn -1;\r\npthread_mutex_lock(&ui__lock);\r\n__ui_browser__show_title(self, title);\r\nui_browser__add_exit_keys(self, keys);\r\nnewtFormAddComponent(self->form, self->sb);\r\nva_start(ap, helpline);\r\nui_helpline__vpush(helpline, ap);\r\nva_end(ap);\r\npthread_mutex_unlock(&ui__lock);\r\nreturn 0;\r\n}\r\nvoid ui_browser__hide(struct ui_browser *self)\r\n{\r\npthread_mutex_lock(&ui__lock);\r\nnewtFormDestroy(self->form);\r\nself->form = NULL;\r\nui_helpline__pop();\r\npthread_mutex_unlock(&ui__lock);\r\n}\r\nint ui_browser__refresh(struct ui_browser *self)\r\n{\r\nint row;\r\npthread_mutex_lock(&ui__lock);\r\nnewtScrollbarSet(self->sb, self->index, self->nr_entries - 1);\r\nrow = self->refresh(self);\r\nui_browser__set_color(self, HE_COLORSET_NORMAL);\r\nSLsmg_fill_region(self->y + row, self->x,\r\nself->height - row, self->width, ' ');\r\npthread_mutex_unlock(&ui__lock);\r\nreturn 0;\r\n}\r\nint ui_browser__run(struct ui_browser *self)\r\n{\r\nstruct newtExitStruct es;\r\nif (ui_browser__refresh(self) < 0)\r\nreturn -1;\r\nwhile (1) {\r\noff_t offset;\r\nnewtFormRun(self->form, &es);\r\nif (es.reason != NEWT_EXIT_HOTKEY)\r\nbreak;\r\nswitch (es.u.key) {\r\ncase NEWT_KEY_DOWN:\r\nif (self->index == self->nr_entries - 1)\r\nbreak;\r\n++self->index;\r\nif (self->index == self->top_idx + self->height) {\r\n++self->top_idx;\r\nself->seek(self, +1, SEEK_CUR);\r\n}\r\nbreak;\r\ncase NEWT_KEY_UP:\r\nif (self->index == 0)\r\nbreak;\r\n--self->index;\r\nif (self->index < self->top_idx) {\r\n--self->top_idx;\r\nself->seek(self, -1, SEEK_CUR);\r\n}\r\nbreak;\r\ncase NEWT_KEY_PGDN:\r\ncase ' ':\r\nif (self->top_idx + self->height > self->nr_entries - 1)\r\nbreak;\r\noffset = self->height;\r\nif (self->index + offset > self->nr_entries - 1)\r\noffset = self->nr_entries - 1 - self->index;\r\nself->index += offset;\r\nself->top_idx += offset;\r\nself->seek(self, +offset, SEEK_CUR);\r\nbreak;\r\ncase NEWT_KEY_PGUP:\r\nif (self->top_idx == 0)\r\nbreak;\r\nif (self->top_idx < self->height)\r\noffset = self->top_idx;\r\nelse\r\noffset = self->height;\r\nself->index -= offset;\r\nself->top_idx -= offset;\r\nself->seek(self, -offset, SEEK_CUR);\r\nbreak;\r\ncase NEWT_KEY_HOME:\r\nui_browser__reset_index(self);\r\nbreak;\r\ncase NEWT_KEY_END:\r\noffset = self->height - 1;\r\nif (offset >= self->nr_entries)\r\noffset = self->nr_entries - 1;\r\nself->index = self->nr_entries - 1;\r\nself->top_idx = self->index - offset;\r\nself->seek(self, -offset, SEEK_END);\r\nbreak;\r\ndefault:\r\nreturn es.u.key;\r\n}\r\nif (ui_browser__refresh(self) < 0)\r\nreturn -1;\r\n}\r\nreturn -1;\r\n}\r\nunsigned int ui_browser__list_head_refresh(struct ui_browser *self)\r\n{\r\nstruct list_head *pos;\r\nstruct list_head *head = self->entries;\r\nint row = 0;\r\nif (self->top == NULL || self->top == self->entries)\r\nself->top = head->next;\r\npos = self->top;\r\nlist_for_each_from(pos, head) {\r\nui_browser__gotorc(self, row, 0);\r\nself->write(self, pos, row);\r\nif (++row == self->height)\r\nbreak;\r\n}\r\nreturn row;\r\n}\r\nvoid ui_browser__init(void)\r\n{\r\nstruct newtPercentTreeColors *c = &defaultPercentTreeColors;\r\nsltt_set_color(HE_COLORSET_TOP, NULL, c->topColorFg, c->topColorBg);\r\nsltt_set_color(HE_COLORSET_MEDIUM, NULL, c->mediumColorFg, c->mediumColorBg);\r\nsltt_set_color(HE_COLORSET_NORMAL, NULL, c->normalColorFg, c->normalColorBg);\r\nsltt_set_color(HE_COLORSET_SELECTED, NULL, c->selColorFg, c->selColorBg);\r\nsltt_set_color(HE_COLORSET_CODE, NULL, c->codeColorFg, c->codeColorBg);\r\n}

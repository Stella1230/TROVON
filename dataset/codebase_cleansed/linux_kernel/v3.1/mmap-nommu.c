static unsigned long romfs_get_unmapped_area(struct file *file,\r\nunsigned long addr,\r\nunsigned long len,\r\nunsigned long pgoff,\r\nunsigned long flags)\r\n{\r\nstruct inode *inode = file->f_mapping->host;\r\nstruct mtd_info *mtd = inode->i_sb->s_mtd;\r\nunsigned long isize, offset, maxpages, lpages;\r\nif (!mtd)\r\ngoto cant_map_directly;\r\nlpages = (len + PAGE_SIZE - 1) >> PAGE_SHIFT;\r\nisize = i_size_read(inode);\r\noffset = pgoff << PAGE_SHIFT;\r\nmaxpages = (isize + PAGE_SIZE - 1) >> PAGE_SHIFT;\r\nif ((pgoff >= maxpages) || (maxpages - pgoff < lpages))\r\nreturn (unsigned long) -EINVAL;\r\nif (mtd->get_unmapped_area) {\r\nif (addr != 0)\r\nreturn (unsigned long) -EINVAL;\r\nif (len > mtd->size || pgoff >= (mtd->size >> PAGE_SHIFT))\r\nreturn (unsigned long) -EINVAL;\r\noffset += ROMFS_I(inode)->i_dataoffset;\r\nif (offset > mtd->size - len)\r\nreturn (unsigned long) -EINVAL;\r\nreturn mtd->get_unmapped_area(mtd, len, offset, flags);\r\n}\r\ncant_map_directly:\r\nreturn (unsigned long) -ENOSYS;\r\n}\r\nstatic int romfs_mmap(struct file *file, struct vm_area_struct *vma)\r\n{\r\nreturn vma->vm_flags & (VM_SHARED | VM_MAYSHARE) ? 0 : -ENOSYS;\r\n}

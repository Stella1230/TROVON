static void\r\nneponset_irq_handler(unsigned int irq, struct irq_desc *desc)\r\n{\r\nunsigned int irr;\r\nwhile (1) {\r\ndesc->irq_data.chip->irq_ack(&desc->irq_data);\r\nirr = IRR ^ (IRR_ETHERNET | IRR_USAR);\r\nif ((irr & (IRR_ETHERNET | IRR_USAR | IRR_SA1111)) == 0)\r\nbreak;\r\nif (irr & (IRR_ETHERNET | IRR_USAR)) {\r\ndesc->irq_data.chip->irq_mask(&desc->irq_data);\r\ndesc->irq_data.chip->irq_ack(&desc->irq_data);\r\nif (irr & IRR_ETHERNET) {\r\ngeneric_handle_irq(IRQ_NEPONSET_SMC9196);\r\n}\r\nif (irr & IRR_USAR) {\r\ngeneric_handle_irq(IRQ_NEPONSET_USAR);\r\n}\r\ndesc->irq_data.chip->irq_unmask(&desc->irq_data);\r\n}\r\nif (irr & IRR_SA1111) {\r\ngeneric_handle_irq(IRQ_NEPONSET_SA1111);\r\n}\r\n}\r\n}\r\nstatic void neponset_set_mctrl(struct uart_port *port, u_int mctrl)\r\n{\r\nu_int mdm_ctl0 = MDM_CTL_0;\r\nif (port->mapbase == _Ser1UTCR0) {\r\nif (mctrl & TIOCM_RTS)\r\nmdm_ctl0 &= ~MDM_CTL0_RTS2;\r\nelse\r\nmdm_ctl0 |= MDM_CTL0_RTS2;\r\nif (mctrl & TIOCM_DTR)\r\nmdm_ctl0 &= ~MDM_CTL0_DTR2;\r\nelse\r\nmdm_ctl0 |= MDM_CTL0_DTR2;\r\n} else if (port->mapbase == _Ser3UTCR0) {\r\nif (mctrl & TIOCM_RTS)\r\nmdm_ctl0 &= ~MDM_CTL0_RTS1;\r\nelse\r\nmdm_ctl0 |= MDM_CTL0_RTS1;\r\nif (mctrl & TIOCM_DTR)\r\nmdm_ctl0 &= ~MDM_CTL0_DTR1;\r\nelse\r\nmdm_ctl0 |= MDM_CTL0_DTR1;\r\n}\r\nMDM_CTL_0 = mdm_ctl0;\r\n}\r\nstatic u_int neponset_get_mctrl(struct uart_port *port)\r\n{\r\nu_int ret = TIOCM_CD | TIOCM_CTS | TIOCM_DSR;\r\nu_int mdm_ctl1 = MDM_CTL_1;\r\nif (port->mapbase == _Ser1UTCR0) {\r\nif (mdm_ctl1 & MDM_CTL1_DCD2)\r\nret &= ~TIOCM_CD;\r\nif (mdm_ctl1 & MDM_CTL1_CTS2)\r\nret &= ~TIOCM_CTS;\r\nif (mdm_ctl1 & MDM_CTL1_DSR2)\r\nret &= ~TIOCM_DSR;\r\n} else if (port->mapbase == _Ser3UTCR0) {\r\nif (mdm_ctl1 & MDM_CTL1_DCD1)\r\nret &= ~TIOCM_CD;\r\nif (mdm_ctl1 & MDM_CTL1_CTS1)\r\nret &= ~TIOCM_CTS;\r\nif (mdm_ctl1 & MDM_CTL1_DSR1)\r\nret &= ~TIOCM_DSR;\r\n}\r\nreturn ret;\r\n}\r\nstatic int __devinit neponset_probe(struct platform_device *dev)\r\n{\r\nsa1100_register_uart_fns(&neponset_port_fns);\r\nirq_set_irq_type(IRQ_GPIO25, IRQ_TYPE_EDGE_RISING);\r\nirq_set_chained_handler(IRQ_GPIO25, neponset_irq_handler);\r\n#if 0\r\nenable_irq_wake(IRQ_GPIO25);\r\n#endif\r\nirq_set_handler(IRQ_NEPONSET_SMC9196, handle_simple_irq);\r\nset_irq_flags(IRQ_NEPONSET_SMC9196, IRQF_VALID | IRQF_PROBE);\r\nirq_set_handler(IRQ_NEPONSET_USAR, handle_simple_irq);\r\nset_irq_flags(IRQ_NEPONSET_USAR, IRQF_VALID | IRQF_PROBE);\r\nNCR_0 = NCR_GP01_OFF;\r\nreturn 0;\r\n}\r\nstatic int neponset_suspend(struct platform_device *dev, pm_message_t state)\r\n{\r\nneponset_saved_state = NCR_0;\r\nreturn 0;\r\n}\r\nstatic int neponset_resume(struct platform_device *dev)\r\n{\r\nNCR_0 = neponset_saved_state;\r\nreturn 0;\r\n}\r\nstatic int __init neponset_init(void)\r\n{\r\nplatform_driver_register(&neponset_device_driver);\r\nif (!machine_is_assabet())\r\nreturn -ENODEV;\r\nsa1110_mb_disable();\r\nif (!machine_has_neponset()) {\r\nprintk(KERN_DEBUG "Neponset expansion board not present\n");\r\nreturn -ENODEV;\r\n}\r\nif (WHOAMI != 0x11) {\r\nprintk(KERN_WARNING "Neponset board detected, but "\r\n"wrong ID: %02x\n", WHOAMI);\r\nreturn -ENODEV;\r\n}\r\nreturn platform_add_devices(devices, ARRAY_SIZE(devices));\r\n}\r\nvoid __init neponset_map_io(void)\r\n{\r\niotable_init(neponset_io_desc, ARRAY_SIZE(neponset_io_desc));\r\n}

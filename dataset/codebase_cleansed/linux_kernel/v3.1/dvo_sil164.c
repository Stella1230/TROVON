static bool sil164_readb(struct intel_dvo_device *dvo, int addr, uint8_t *ch)\r\n{\r\nstruct sil164_priv *sil = dvo->dev_priv;\r\nstruct i2c_adapter *adapter = dvo->i2c_bus;\r\nu8 out_buf[2];\r\nu8 in_buf[2];\r\nstruct i2c_msg msgs[] = {\r\n{\r\n.addr = dvo->slave_addr,\r\n.flags = 0,\r\n.len = 1,\r\n.buf = out_buf,\r\n},\r\n{\r\n.addr = dvo->slave_addr,\r\n.flags = I2C_M_RD,\r\n.len = 1,\r\n.buf = in_buf,\r\n}\r\n};\r\nout_buf[0] = addr;\r\nout_buf[1] = 0;\r\nif (i2c_transfer(adapter, msgs, 2) == 2) {\r\n*ch = in_buf[0];\r\nreturn true;\r\n};\r\nif (!sil->quiet) {\r\nDRM_DEBUG_KMS("Unable to read register 0x%02x from %s:%02x.\n",\r\naddr, adapter->name, dvo->slave_addr);\r\n}\r\nreturn false;\r\n}\r\nstatic bool sil164_writeb(struct intel_dvo_device *dvo, int addr, uint8_t ch)\r\n{\r\nstruct sil164_priv *sil= dvo->dev_priv;\r\nstruct i2c_adapter *adapter = dvo->i2c_bus;\r\nuint8_t out_buf[2];\r\nstruct i2c_msg msg = {\r\n.addr = dvo->slave_addr,\r\n.flags = 0,\r\n.len = 2,\r\n.buf = out_buf,\r\n};\r\nout_buf[0] = addr;\r\nout_buf[1] = ch;\r\nif (i2c_transfer(adapter, &msg, 1) == 1)\r\nreturn true;\r\nif (!sil->quiet) {\r\nDRM_DEBUG_KMS("Unable to write register 0x%02x to %s:%d.\n",\r\naddr, adapter->name, dvo->slave_addr);\r\n}\r\nreturn false;\r\n}\r\nstatic bool sil164_init(struct intel_dvo_device *dvo,\r\nstruct i2c_adapter *adapter)\r\n{\r\nstruct sil164_priv *sil;\r\nunsigned char ch;\r\nsil = kzalloc(sizeof(struct sil164_priv), GFP_KERNEL);\r\nif (sil == NULL)\r\nreturn false;\r\ndvo->i2c_bus = adapter;\r\ndvo->dev_priv = sil;\r\nsil->quiet = true;\r\nif (!sil164_readb(dvo, SIL164_VID_LO, &ch))\r\ngoto out;\r\nif (ch != (SIL164_VID & 0xff)) {\r\nDRM_DEBUG_KMS("sil164 not detected got %d: from %s Slave %d.\n",\r\nch, adapter->name, dvo->slave_addr);\r\ngoto out;\r\n}\r\nif (!sil164_readb(dvo, SIL164_DID_LO, &ch))\r\ngoto out;\r\nif (ch != (SIL164_DID & 0xff)) {\r\nDRM_DEBUG_KMS("sil164 not detected got %d: from %s Slave %d.\n",\r\nch, adapter->name, dvo->slave_addr);\r\ngoto out;\r\n}\r\nsil->quiet = false;\r\nDRM_DEBUG_KMS("init sil164 dvo controller successfully!\n");\r\nreturn true;\r\nout:\r\nkfree(sil);\r\nreturn false;\r\n}\r\nstatic enum drm_connector_status sil164_detect(struct intel_dvo_device *dvo)\r\n{\r\nuint8_t reg9;\r\nsil164_readb(dvo, SIL164_REG9, &reg9);\r\nif (reg9 & SIL164_9_HTPLG)\r\nreturn connector_status_connected;\r\nelse\r\nreturn connector_status_disconnected;\r\n}\r\nstatic enum drm_mode_status sil164_mode_valid(struct intel_dvo_device *dvo,\r\nstruct drm_display_mode *mode)\r\n{\r\nreturn MODE_OK;\r\n}\r\nstatic void sil164_mode_set(struct intel_dvo_device *dvo,\r\nstruct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nreturn;\r\n}\r\nstatic void sil164_dpms(struct intel_dvo_device *dvo, int mode)\r\n{\r\nint ret;\r\nunsigned char ch;\r\nret = sil164_readb(dvo, SIL164_REG8, &ch);\r\nif (ret == false)\r\nreturn;\r\nif (mode == DRM_MODE_DPMS_ON)\r\nch |= SIL164_8_PD;\r\nelse\r\nch &= ~SIL164_8_PD;\r\nsil164_writeb(dvo, SIL164_REG8, ch);\r\nreturn;\r\n}\r\nstatic void sil164_dump_regs(struct intel_dvo_device *dvo)\r\n{\r\nuint8_t val;\r\nsil164_readb(dvo, SIL164_FREQ_LO, &val);\r\nDRM_LOG_KMS("SIL164_FREQ_LO: 0x%02x\n", val);\r\nsil164_readb(dvo, SIL164_FREQ_HI, &val);\r\nDRM_LOG_KMS("SIL164_FREQ_HI: 0x%02x\n", val);\r\nsil164_readb(dvo, SIL164_REG8, &val);\r\nDRM_LOG_KMS("SIL164_REG8: 0x%02x\n", val);\r\nsil164_readb(dvo, SIL164_REG9, &val);\r\nDRM_LOG_KMS("SIL164_REG9: 0x%02x\n", val);\r\nsil164_readb(dvo, SIL164_REGC, &val);\r\nDRM_LOG_KMS("SIL164_REGC: 0x%02x\n", val);\r\n}\r\nstatic void sil164_destroy(struct intel_dvo_device *dvo)\r\n{\r\nstruct sil164_priv *sil = dvo->dev_priv;\r\nif (sil) {\r\nkfree(sil);\r\ndvo->dev_priv = NULL;\r\n}\r\n}

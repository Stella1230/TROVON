void __init oss_init(void)\r\n{\r\nint i;\r\nif (!oss_present) return;\r\noss = (struct mac_oss *) OSS_BASE;\r\nfor (i = 0; i <= OSS_NUM_SOURCES; i++) {\r\noss->irq_level[i] = OSS_IRQLEV_DISABLED;\r\n}\r\noss->irq_level[OSS_VIA1] = OSS_IRQLEV_VIA1;\r\n}\r\nvoid __init oss_register_interrupts(void)\r\n{\r\nif (request_irq(OSS_IRQLEV_SCSI, oss_irq, IRQ_FLG_LOCK,\r\n"scsi", (void *) oss))\r\npr_err("Couldn't register %s interrupt\n", "scsi");\r\nif (request_irq(OSS_IRQLEV_NUBUS, oss_nubus_irq, IRQ_FLG_LOCK,\r\n"nubus", (void *) oss))\r\npr_err("Couldn't register %s interrupt\n", "nubus");\r\nif (request_irq(OSS_IRQLEV_SOUND, oss_irq, IRQ_FLG_LOCK,\r\n"sound", (void *) oss))\r\npr_err("Couldn't register %s interrupt\n", "sound");\r\nif (request_irq(OSS_IRQLEV_VIA1, via1_irq, IRQ_FLG_LOCK,\r\n"via1", (void *) via1))\r\npr_err("Couldn't register %s interrupt\n", "via1");\r\n}\r\nvoid __init oss_nubus_init(void)\r\n{\r\n}\r\nstatic irqreturn_t oss_irq(int irq, void *dev_id)\r\n{\r\nint events;\r\nevents = oss->irq_pending & (OSS_IP_SOUND|OSS_IP_SCSI);\r\nif (!events)\r\nreturn IRQ_NONE;\r\n#ifdef DEBUG_IRQS\r\nif ((console_loglevel == 10) && !(events & OSS_IP_SCSI)) {\r\nprintk("oss_irq: irq %d events = 0x%04X\n", irq,\r\n(int) oss->irq_pending);\r\n}\r\n#endif\r\nif (events & OSS_IP_SOUND) {\r\noss->irq_pending &= ~OSS_IP_SOUND;\r\n} else if (events & OSS_IP_SCSI) {\r\noss->irq_pending &= ~OSS_IP_SCSI;\r\nm68k_handle_int(IRQ_MAC_SCSI);\r\n} else {\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t oss_nubus_irq(int irq, void *dev_id)\r\n{\r\nint events, irq_bit, i;\r\nevents = oss->irq_pending & OSS_IP_NUBUS;\r\nif (!events)\r\nreturn IRQ_NONE;\r\n#ifdef DEBUG_NUBUS_INT\r\nif (console_loglevel > 7) {\r\nprintk("oss_nubus_irq: events = 0x%04X\n", events);\r\n}\r\n#endif\r\ni = 6;\r\nirq_bit = 0x40;\r\ndo {\r\n--i;\r\nirq_bit >>= 1;\r\nif (events & irq_bit) {\r\noss->irq_pending &= ~irq_bit;\r\nm68k_handle_int(NUBUS_SOURCE_BASE + i);\r\n}\r\n} while(events & (irq_bit - 1));\r\nreturn IRQ_HANDLED;\r\n}\r\nvoid oss_irq_enable(int irq) {\r\n#ifdef DEBUG_IRQUSE\r\nprintk("oss_irq_enable(%d)\n", irq);\r\n#endif\r\nswitch(irq) {\r\ncase IRQ_MAC_SCC:\r\noss->irq_level[OSS_IOPSCC] = OSS_IRQLEV_IOPSCC;\r\nbreak;\r\ncase IRQ_MAC_ADB:\r\noss->irq_level[OSS_IOPISM] = OSS_IRQLEV_IOPISM;\r\nbreak;\r\ncase IRQ_MAC_SCSI:\r\noss->irq_level[OSS_SCSI] = OSS_IRQLEV_SCSI;\r\nbreak;\r\ncase IRQ_NUBUS_9:\r\ncase IRQ_NUBUS_A:\r\ncase IRQ_NUBUS_B:\r\ncase IRQ_NUBUS_C:\r\ncase IRQ_NUBUS_D:\r\ncase IRQ_NUBUS_E:\r\nirq -= NUBUS_SOURCE_BASE;\r\noss->irq_level[irq] = OSS_IRQLEV_NUBUS;\r\nbreak;\r\n#ifdef DEBUG_IRQUSE\r\ndefault:\r\nprintk("%s unknown irq %d\n", __func__, irq);\r\nbreak;\r\n#endif\r\n}\r\n}\r\nvoid oss_irq_disable(int irq) {\r\n#ifdef DEBUG_IRQUSE\r\nprintk("oss_irq_disable(%d)\n", irq);\r\n#endif\r\nswitch(irq) {\r\ncase IRQ_MAC_SCC:\r\noss->irq_level[OSS_IOPSCC] = OSS_IRQLEV_DISABLED;\r\nbreak;\r\ncase IRQ_MAC_ADB:\r\noss->irq_level[OSS_IOPISM] = OSS_IRQLEV_DISABLED;\r\nbreak;\r\ncase IRQ_MAC_SCSI:\r\noss->irq_level[OSS_SCSI] = OSS_IRQLEV_DISABLED;\r\nbreak;\r\ncase IRQ_NUBUS_9:\r\ncase IRQ_NUBUS_A:\r\ncase IRQ_NUBUS_B:\r\ncase IRQ_NUBUS_C:\r\ncase IRQ_NUBUS_D:\r\ncase IRQ_NUBUS_E:\r\nirq -= NUBUS_SOURCE_BASE;\r\noss->irq_level[irq] = OSS_IRQLEV_DISABLED;\r\nbreak;\r\n#ifdef DEBUG_IRQUSE\r\ndefault:\r\nprintk("%s unknown irq %d\n", __func__, irq);\r\nbreak;\r\n#endif\r\n}\r\n}\r\nvoid oss_irq_clear(int irq) {\r\nswitch(irq) {\r\ncase IRQ_MAC_SCC:\r\noss->irq_pending &= ~OSS_IP_IOPSCC;\r\nbreak;\r\ncase IRQ_MAC_ADB:\r\noss->irq_pending &= ~OSS_IP_IOPISM;\r\nbreak;\r\ncase IRQ_MAC_SCSI:\r\noss->irq_pending &= ~OSS_IP_SCSI;\r\nbreak;\r\ncase IRQ_NUBUS_9:\r\ncase IRQ_NUBUS_A:\r\ncase IRQ_NUBUS_B:\r\ncase IRQ_NUBUS_C:\r\ncase IRQ_NUBUS_D:\r\ncase IRQ_NUBUS_E:\r\nirq -= NUBUS_SOURCE_BASE;\r\noss->irq_pending &= ~(1 << irq);\r\nbreak;\r\n}\r\n}\r\nint oss_irq_pending(int irq)\r\n{\r\nswitch(irq) {\r\ncase IRQ_MAC_SCC:\r\nreturn oss->irq_pending & OSS_IP_IOPSCC;\r\nbreak;\r\ncase IRQ_MAC_ADB:\r\nreturn oss->irq_pending & OSS_IP_IOPISM;\r\nbreak;\r\ncase IRQ_MAC_SCSI:\r\nreturn oss->irq_pending & OSS_IP_SCSI;\r\nbreak;\r\ncase IRQ_NUBUS_9:\r\ncase IRQ_NUBUS_A:\r\ncase IRQ_NUBUS_B:\r\ncase IRQ_NUBUS_C:\r\ncase IRQ_NUBUS_D:\r\ncase IRQ_NUBUS_E:\r\nirq -= NUBUS_SOURCE_BASE;\r\nreturn oss->irq_pending & (1 << irq);\r\nbreak;\r\n}\r\nreturn 0;\r\n}

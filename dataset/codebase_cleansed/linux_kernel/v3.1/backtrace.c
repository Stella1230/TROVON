static unsigned int user_getsp32(unsigned int sp, int is_first)\r\n{\r\nunsigned int stack_frame[2];\r\nvoid __user *p = compat_ptr(sp);\r\nif (!access_ok(VERIFY_READ, p, sizeof(stack_frame)))\r\nreturn 0;\r\nif (__copy_from_user_inatomic(stack_frame, p, sizeof(stack_frame)))\r\nreturn 0;\r\nif (!is_first)\r\noprofile_add_trace(STACK_LR32(stack_frame));\r\nreturn STACK_SP(stack_frame);\r\n}\r\nstatic unsigned long user_getsp64(unsigned long sp, int is_first)\r\n{\r\nunsigned long stack_frame[3];\r\nif (!access_ok(VERIFY_READ, (void __user *)sp, sizeof(stack_frame)))\r\nreturn 0;\r\nif (__copy_from_user_inatomic(stack_frame, (void __user *)sp,\r\nsizeof(stack_frame)))\r\nreturn 0;\r\nif (!is_first)\r\noprofile_add_trace(STACK_LR64(stack_frame));\r\nreturn STACK_SP(stack_frame);\r\n}\r\nstatic unsigned long kernel_getsp(unsigned long sp, int is_first)\r\n{\r\nunsigned long *stack_frame = (unsigned long *)sp;\r\nif (!validate_sp(sp, current, STACK_FRAME_OVERHEAD))\r\nreturn 0;\r\nif (!is_first)\r\noprofile_add_trace(STACK_LR(stack_frame));\r\nreturn STACK_SP(stack_frame);\r\n}\r\nvoid op_powerpc_backtrace(struct pt_regs * const regs, unsigned int depth)\r\n{\r\nunsigned long sp = regs->gpr[1];\r\nint first_frame = 1;\r\ndepth += 1;\r\nif (!user_mode(regs)) {\r\nwhile (depth--) {\r\nsp = kernel_getsp(sp, first_frame);\r\nif (!sp)\r\nbreak;\r\nfirst_frame = 0;\r\n}\r\n} else {\r\n#ifdef CONFIG_PPC64\r\nif (!is_32bit_task()) {\r\nwhile (depth--) {\r\nsp = user_getsp64(sp, first_frame);\r\nif (!sp)\r\nbreak;\r\nfirst_frame = 0;\r\n}\r\nreturn;\r\n}\r\n#endif\r\nwhile (depth--) {\r\nsp = user_getsp32(sp, first_frame);\r\nif (!sp)\r\nbreak;\r\nfirst_frame = 0;\r\n}\r\n}\r\n}

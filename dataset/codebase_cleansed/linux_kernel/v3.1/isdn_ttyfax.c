static char *\r\nisdn_getrev(const char *revision)\r\n{\r\nchar *rev;\r\nchar *p;\r\nif ((p = strchr(revision, ':'))) {\r\nrev = p + 2;\r\np = strchr(rev, '$');\r\n*--p = 0;\r\n} else\r\nrev = "???";\r\nreturn rev;\r\n}\r\nstatic void\r\nisdn_tty_fax_modem_result(int code, modem_info * info)\r\n{\r\natemu *m = &info->emu;\r\nT30_s *f = info->fax;\r\nchar rs[50];\r\nchar rss[50];\r\nchar *rp;\r\nint i;\r\nstatic char *msg[] =\r\n{"OK", "ERROR", "+FCON", "+FCSI:", "+FDIS:",\r\n"+FHNG:", "+FDCS:", "CONNECT", "+FTSI:",\r\n"+FCFR", "+FPTS:", "+FET:"};\r\nisdn_tty_at_cout("\r\n", info);\r\nisdn_tty_at_cout(msg[code], info);\r\n#ifdef ISDN_TTY_FAX_CMD_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty: Fax send %s on ttyI%d\n",\r\nmsg[code], info->line);\r\n#endif\r\nswitch (code) {\r\ncase 0:\r\nbreak;\r\ncase 1:\r\nbreak;\r\ncase 2:\r\nif ((m->mdmreg[REG_CPNFCON] & BIT_CPNFCON) &&\r\n(!(dev->usage[info->isdn_channel] & ISDN_USAGE_OUTGOING))) {\r\nsprintf(rs, "/%s", m->cpn);\r\nisdn_tty_at_cout(rs, info);\r\n}\r\ninfo->online = 1;\r\nf->fet = 0;\r\nif (f->phase == ISDN_FAX_PHASE_A)\r\nf->phase = ISDN_FAX_PHASE_B;\r\nbreak;\r\ncase 3:\r\ncase 8:\r\nsprintf(rs, "\"%s\"", f->r_id);\r\nisdn_tty_at_cout(rs, info);\r\nbreak;\r\ncase 4:\r\nrs[0] = 0;\r\nrp = &f->r_resolution;\r\nfor (i = 0; i < 8; i++) {\r\nsprintf(rss, "%c%s", rp[i] + 48,\r\n(i < 7) ? "," : "");\r\nstrcat(rs, rss);\r\n}\r\nisdn_tty_at_cout(rs, info);\r\n#ifdef ISDN_TTY_FAX_CMD_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty: Fax DIS=%s on ttyI%d\n",\r\nrs, info->line);\r\n#endif\r\nbreak;\r\ncase 5:\r\nsprintf(rs, "%d", f->code);\r\nisdn_tty_at_cout(rs, info);\r\ninfo->faxonline = 0;\r\nbreak;\r\ncase 6:\r\nrs[0] = 0;\r\nrp = &f->r_resolution;\r\nfor (i = 0; i < 8; i++) {\r\nsprintf(rss, "%c%s", rp[i] + 48,\r\n(i < 7) ? "," : "");\r\nstrcat(rs, rss);\r\n}\r\nisdn_tty_at_cout(rs, info);\r\n#ifdef ISDN_TTY_FAX_CMD_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty: Fax DCS=%s on ttyI%d\n",\r\nrs, info->line);\r\n#endif\r\nbreak;\r\ncase 7:\r\ninfo->faxonline |= 2;\r\nbreak;\r\ncase 9:\r\nbreak;\r\ncase 10:\r\nisdn_tty_at_cout("1", info);\r\nbreak;\r\ncase 11:\r\nsprintf(rs, "%d", f->fet);\r\nisdn_tty_at_cout(rs, info);\r\nbreak;\r\n}\r\nisdn_tty_at_cout("\r\n", info);\r\nswitch (code) {\r\ncase 7:\r\ninfo->online = 2;\r\nif (info->faxonline & 1) {\r\nsprintf(rs, "%c", XON);\r\nisdn_tty_at_cout(rs, info);\r\n}\r\nbreak;\r\n}\r\n}\r\nstatic int\r\nisdn_tty_fax_command1(modem_info * info, isdn_ctrl * c)\r\n{\r\nstatic char *msg[] =\r\n{"OK", "CONNECT", "NO CARRIER", "ERROR", "FCERROR"};\r\n#ifdef ISDN_TTY_FAX_CMD_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty: FCLASS1 cmd(%d)\n", c->parm.aux.cmd);\r\n#endif\r\nif (c->parm.aux.cmd < ISDN_FAX_CLASS1_QUERY) {\r\nif (info->online)\r\ninfo->online = 1;\r\nisdn_tty_at_cout("\r\n", info);\r\nisdn_tty_at_cout(msg[c->parm.aux.cmd], info);\r\nisdn_tty_at_cout("\r\n", info);\r\n}\r\nswitch (c->parm.aux.cmd) {\r\ncase ISDN_FAX_CLASS1_CONNECT:\r\ninfo->online = 2;\r\nbreak;\r\ncase ISDN_FAX_CLASS1_OK:\r\ncase ISDN_FAX_CLASS1_FCERROR:\r\ncase ISDN_FAX_CLASS1_ERROR:\r\ncase ISDN_FAX_CLASS1_NOCARR:\r\nbreak;\r\ncase ISDN_FAX_CLASS1_QUERY:\r\nisdn_tty_at_cout("\r\n", info);\r\nif (!c->parm.aux.para[0]) {\r\nisdn_tty_at_cout(msg[ISDN_FAX_CLASS1_ERROR], info);\r\nisdn_tty_at_cout("\r\n", info);\r\n} else {\r\nisdn_tty_at_cout(c->parm.aux.para, info);\r\nisdn_tty_at_cout("\r\nOK\r\n", info);\r\n}\r\nbreak;\r\n}\r\nreturn (0);\r\n}\r\nint\r\nisdn_tty_fax_command(modem_info * info, isdn_ctrl * c)\r\n{\r\nT30_s *f = info->fax;\r\nchar rs[10];\r\nif (TTY_IS_FCLASS1(info))\r\nreturn (isdn_tty_fax_command1(info, c));\r\n#ifdef ISDN_TTY_FAX_CMD_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty: Fax cmd %d on ttyI%d\n",\r\nf->r_code, info->line);\r\n#endif\r\nswitch (f->r_code) {\r\ncase ISDN_TTY_FAX_FCON:\r\ninfo->faxonline = 1;\r\nisdn_tty_fax_modem_result(2, info);\r\nreturn (0);\r\ncase ISDN_TTY_FAX_FCON_I:\r\ninfo->faxonline = 16;\r\nisdn_tty_fax_modem_result(2, info);\r\nreturn (0);\r\ncase ISDN_TTY_FAX_RID:\r\nif (info->faxonline & 1)\r\nisdn_tty_fax_modem_result(3, info);\r\nif (info->faxonline & 16)\r\nisdn_tty_fax_modem_result(8, info);\r\nreturn (0);\r\ncase ISDN_TTY_FAX_DIS:\r\nisdn_tty_fax_modem_result(4, info);\r\nreturn (0);\r\ncase ISDN_TTY_FAX_HNG:\r\nif (f->phase == ISDN_FAX_PHASE_C) {\r\nif (f->direction == ISDN_TTY_FAX_CONN_IN) {\r\nsprintf(rs, "%c%c", DLE, ETX);\r\nisdn_tty_at_cout(rs, info);\r\n} else {\r\nsprintf(rs, "%c", 0x18);\r\nisdn_tty_at_cout(rs, info);\r\n}\r\ninfo->faxonline &= ~2;\r\ninfo->online = 1;\r\n}\r\nf->phase = ISDN_FAX_PHASE_E;\r\nisdn_tty_fax_modem_result(5, info);\r\nisdn_tty_fax_modem_result(0, info);\r\nreturn (0);\r\ncase ISDN_TTY_FAX_DCS:\r\nisdn_tty_fax_modem_result(6, info);\r\nisdn_tty_fax_modem_result(7, info);\r\nf->phase = ISDN_FAX_PHASE_C;\r\nreturn (0);\r\ncase ISDN_TTY_FAX_TRAIN_OK:\r\nisdn_tty_fax_modem_result(6, info);\r\nisdn_tty_fax_modem_result(0, info);\r\nreturn (0);\r\ncase ISDN_TTY_FAX_SENT:\r\nisdn_tty_fax_modem_result(0, info);\r\nreturn (0);\r\ncase ISDN_TTY_FAX_CFR:\r\nisdn_tty_fax_modem_result(9, info);\r\nreturn (0);\r\ncase ISDN_TTY_FAX_ET:\r\nsprintf(rs, "%c%c", DLE, ETX);\r\nisdn_tty_at_cout(rs, info);\r\nisdn_tty_fax_modem_result(10, info);\r\nisdn_tty_fax_modem_result(11, info);\r\nisdn_tty_fax_modem_result(0, info);\r\ninfo->faxonline &= ~2;\r\ninfo->online = 1;\r\nf->phase = ISDN_FAX_PHASE_D;\r\nreturn (0);\r\ncase ISDN_TTY_FAX_PTS:\r\nisdn_tty_fax_modem_result(10, info);\r\nif (f->direction == ISDN_TTY_FAX_CONN_OUT) {\r\nif (f->fet == 1)\r\nf->phase = ISDN_FAX_PHASE_B;\r\nif (f->fet == 0)\r\nisdn_tty_fax_modem_result(0, info);\r\n}\r\nreturn (0);\r\ncase ISDN_TTY_FAX_EOP:\r\ninfo->faxonline &= ~2;\r\ninfo->online = 1;\r\nf->phase = ISDN_FAX_PHASE_D;\r\nreturn (0);\r\n}\r\nreturn (-1);\r\n}\r\nvoid\r\nisdn_tty_fax_bitorder(modem_info * info, struct sk_buff *skb)\r\n{\r\n__u8 LeftMask;\r\n__u8 RightMask;\r\n__u8 fBit;\r\n__u8 Data;\r\nint i;\r\nif (!info->fax->bor) {\r\nfor (i = 0; i < skb->len; i++) {\r\nData = skb->data[i];\r\nfor (\r\nLeftMask = 0x80, RightMask = 0x01;\r\nLeftMask > RightMask;\r\nLeftMask >>= 1, RightMask <<= 1\r\n) {\r\nfBit = (Data & LeftMask);\r\nif (Data & RightMask)\r\nData |= LeftMask;\r\nelse\r\nData &= ~LeftMask;\r\nif (fBit)\r\nData |= RightMask;\r\nelse\r\nData &= ~RightMask;\r\n}\r\nskb->data[i] = Data;\r\n}\r\n}\r\n}\r\nstatic int\r\nisdn_tty_cmd_FCLASS1(char **p, modem_info * info)\r\n{\r\nstatic char *cmd[] =\r\n{"AE", "TS", "RS", "TM", "RM", "TH", "RH"};\r\nisdn_ctrl c;\r\nint par, i;\r\nu_long flags;\r\nfor (c.parm.aux.cmd = 0; c.parm.aux.cmd < 7; c.parm.aux.cmd++)\r\nif (!strncmp(p[0], cmd[c.parm.aux.cmd], 2))\r\nbreak;\r\n#ifdef ISDN_TTY_FAX_CMD_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty_cmd_FCLASS1 (%s,%d)\n", p[0], c.parm.aux.cmd);\r\n#endif\r\nif (c.parm.aux.cmd == 7)\r\nPARSE_ERROR1;\r\np[0] += 2;\r\nswitch (*p[0]) {\r\ncase '?':\r\np[0]++;\r\nc.parm.aux.subcmd = AT_QUERY;\r\nbreak;\r\ncase '=':\r\np[0]++;\r\nif (*p[0] == '?') {\r\np[0]++;\r\nc.parm.aux.subcmd = AT_EQ_QUERY;\r\n} else {\r\npar = isdn_getnum(p);\r\nif ((par < 0) || (par > 255))\r\nPARSE_ERROR1;\r\nc.parm.aux.subcmd = AT_EQ_VALUE;\r\nc.parm.aux.para[0] = par;\r\n}\r\nbreak;\r\ncase 0:\r\nc.parm.aux.subcmd = AT_COMMAND;\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nc.command = ISDN_CMD_FAXCMD;\r\n#ifdef ISDN_TTY_FAX_CMD_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty_cmd_FCLASS1 %d/%d/%d)\n",\r\nc.parm.aux.cmd, c.parm.aux.subcmd, c.parm.aux.para[0]);\r\n#endif\r\nif (info->isdn_driver < 0) {\r\nif ((c.parm.aux.subcmd == AT_EQ_VALUE) ||\r\n(c.parm.aux.subcmd == AT_COMMAND)) {\r\nPARSE_ERROR1;\r\n}\r\nspin_lock_irqsave(&dev->lock, flags);\r\ni = isdn_get_free_channel(ISDN_USAGE_FAX, ISDN_PROTO_L2_FAX,\r\nISDN_PROTO_L3_FCLASS1, -1, -1, "00");\r\nif (i < 0) {\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nPARSE_ERROR1;\r\n}\r\ninfo->isdn_driver = dev->drvmap[i];\r\ninfo->isdn_channel = dev->chanmap[i];\r\ninfo->drv_index = i;\r\ndev->m_idx[i] = info->line;\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nc.driver = info->isdn_driver;\r\nc.arg = info->isdn_channel;\r\nisdn_command(&c);\r\nspin_lock_irqsave(&dev->lock, flags);\r\nisdn_free_channel(info->isdn_driver, info->isdn_channel,\r\nISDN_USAGE_FAX);\r\ninfo->isdn_driver = -1;\r\ninfo->isdn_channel = -1;\r\nif (info->drv_index >= 0) {\r\ndev->m_idx[info->drv_index] = -1;\r\ninfo->drv_index = -1;\r\n}\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\n} else {\r\nc.driver = info->isdn_driver;\r\nc.arg = info->isdn_channel;\r\nisdn_command(&c);\r\n}\r\nreturn 1;\r\n}\r\nstatic int\r\nisdn_tty_cmd_FCLASS2(char **p, modem_info * info)\r\n{\r\natemu *m = &info->emu;\r\nT30_s *f = info->fax;\r\nisdn_ctrl cmd;\r\nint par;\r\nchar rs[50];\r\nchar rss[50];\r\nint maxdccval[] =\r\n{1, 5, 2, 2, 3, 2, 0, 7};\r\nif (!strncmp(p[0], "AA", 2)) {\r\np[0] += 2;\r\nswitch (*p[0]) {\r\ncase '?':\r\np[0]++;\r\nsprintf(rs, "\r\n%d", 0);\r\nisdn_tty_at_cout(rs, info);\r\nbreak;\r\ncase '=':\r\np[0]++;\r\npar = isdn_getnum(p);\r\nif ((par < 0) || (par > 255))\r\nPARSE_ERROR1;\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nreturn 0;\r\n}\r\nif (!strncmp(p[0], "BADLIN", 6)) {\r\np[0] += 6;\r\nswitch (*p[0]) {\r\ncase '?':\r\np[0]++;\r\nsprintf(rs, "\r\n%d", f->badlin);\r\nisdn_tty_at_cout(rs, info);\r\nbreak;\r\ncase '=':\r\np[0]++;\r\nif (*p[0] == '?') {\r\np[0]++;\r\nsprintf(rs, "\r\n0-255");\r\nisdn_tty_at_cout(rs, info);\r\n} else {\r\npar = isdn_getnum(p);\r\nif ((par < 0) || (par > 255))\r\nPARSE_ERROR1;\r\nf->badlin = par;\r\n#ifdef ISDN_TTY_FAX_STAT_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty: Fax FBADLIN=%d\n", par);\r\n#endif\r\n}\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nreturn 0;\r\n}\r\nif (!strncmp(p[0], "BADMUL", 6)) {\r\np[0] += 6;\r\nswitch (*p[0]) {\r\ncase '?':\r\np[0]++;\r\nsprintf(rs, "\r\n%d", f->badmul);\r\nisdn_tty_at_cout(rs, info);\r\nbreak;\r\ncase '=':\r\np[0]++;\r\nif (*p[0] == '?') {\r\np[0]++;\r\nsprintf(rs, "\r\n0-255");\r\nisdn_tty_at_cout(rs, info);\r\n} else {\r\npar = isdn_getnum(p);\r\nif ((par < 0) || (par > 255))\r\nPARSE_ERROR1;\r\nf->badmul = par;\r\n#ifdef ISDN_TTY_FAX_STAT_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty: Fax FBADMUL=%d\n", par);\r\n#endif\r\n}\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nreturn 0;\r\n}\r\nif (!strncmp(p[0], "BOR", 3)) {\r\np[0] += 3;\r\nswitch (*p[0]) {\r\ncase '?':\r\np[0]++;\r\nsprintf(rs, "\r\n%d", f->bor);\r\nisdn_tty_at_cout(rs, info);\r\nbreak;\r\ncase '=':\r\np[0]++;\r\nif (*p[0] == '?') {\r\np[0]++;\r\nsprintf(rs, "\r\n0,1");\r\nisdn_tty_at_cout(rs, info);\r\n} else {\r\npar = isdn_getnum(p);\r\nif ((par < 0) || (par > 1))\r\nPARSE_ERROR1;\r\nf->bor = par;\r\n#ifdef ISDN_TTY_FAX_STAT_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty: Fax FBOR=%d\n", par);\r\n#endif\r\n}\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nreturn 0;\r\n}\r\nif (!strncmp(p[0], "NBC", 3)) {\r\np[0] += 3;\r\nswitch (*p[0]) {\r\ncase '?':\r\np[0]++;\r\nsprintf(rs, "\r\n%d", f->nbc);\r\nisdn_tty_at_cout(rs, info);\r\nbreak;\r\ncase '=':\r\np[0]++;\r\nif (*p[0] == '?') {\r\np[0]++;\r\nsprintf(rs, "\r\n0,1");\r\nisdn_tty_at_cout(rs, info);\r\n} else {\r\npar = isdn_getnum(p);\r\nif ((par < 0) || (par > 1))\r\nPARSE_ERROR1;\r\nf->nbc = par;\r\n#ifdef ISDN_TTY_FAX_STAT_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty: Fax FNBC=%d\n", par);\r\n#endif\r\n}\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nreturn 0;\r\n}\r\nif (!strncmp(p[0], "BUF?", 4)) {\r\np[0] += 4;\r\n#ifdef ISDN_TTY_FAX_STAT_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty: Fax FBUF? (%d) \n", (16 * m->mdmreg[REG_PSIZE]));\r\n#endif\r\np[0]++;\r\nsprintf(rs, "\r\n %d ", (16 * m->mdmreg[REG_PSIZE]));\r\nisdn_tty_at_cout(rs, info);\r\nreturn 0;\r\n}\r\nif (!strncmp(p[0], "CIG", 3)) {\r\nint i, r;\r\np[0] += 3;\r\nswitch (*p[0]) {\r\ncase '?':\r\np[0]++;\r\nsprintf(rs, "\r\n\"%s\"", f->pollid);\r\nisdn_tty_at_cout(rs, info);\r\nbreak;\r\ncase '=':\r\np[0]++;\r\nif (*p[0] == '?') {\r\np[0]++;\r\nsprintf(rs, "\r\n\"STRING\"");\r\nisdn_tty_at_cout(rs, info);\r\n} else {\r\nif (*p[0] == '"')\r\np[0]++;\r\nfor (i = 0; (*p[0]) && i < (FAXIDLEN - 1) && (*p[0] != '"'); i++) {\r\nf->pollid[i] = *p[0]++;\r\n}\r\nif (*p[0] == '"')\r\np[0]++;\r\nfor (r = i; r < FAXIDLEN; r++) {\r\nf->pollid[r] = 32;\r\n}\r\nf->pollid[FAXIDLEN - 1] = 0;\r\n#ifdef ISDN_TTY_FAX_STAT_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty: Fax local poll ID rx \"%s\"\n", f->pollid);\r\n#endif\r\n}\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nreturn 0;\r\n}\r\nif (!strncmp(p[0], "CQ", 2)) {\r\np[0] += 2;\r\nswitch (*p[0]) {\r\ncase '?':\r\np[0]++;\r\nsprintf(rs, "\r\n%d", f->cq);\r\nisdn_tty_at_cout(rs, info);\r\nbreak;\r\ncase '=':\r\np[0]++;\r\nif (*p[0] == '?') {\r\np[0]++;\r\nsprintf(rs, "\r\n0,1,2");\r\nisdn_tty_at_cout(rs, info);\r\n} else {\r\npar = isdn_getnum(p);\r\nif ((par < 0) || (par > 2))\r\nPARSE_ERROR1;\r\nf->cq = par;\r\n#ifdef ISDN_TTY_FAX_STAT_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty: Fax FCQ=%d\n", par);\r\n#endif\r\n}\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nreturn 0;\r\n}\r\nif (!strncmp(p[0], "CR", 2)) {\r\np[0] += 2;\r\nswitch (*p[0]) {\r\ncase '?':\r\np[0]++;\r\nsprintf(rs, "\r\n%d", f->cr);\r\nisdn_tty_at_cout(rs, info);\r\nbreak;\r\ncase '=':\r\np[0]++;\r\nif (*p[0] == '?') {\r\np[0]++;\r\nsprintf(rs, "\r\n0,1");\r\nisdn_tty_at_cout(rs, info);\r\n} else {\r\npar = isdn_getnum(p);\r\nif ((par < 0) || (par > 1))\r\nPARSE_ERROR1;\r\nf->cr = par;\r\n#ifdef ISDN_TTY_FAX_STAT_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty: Fax FCR=%d\n", par);\r\n#endif\r\n}\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nreturn 0;\r\n}\r\nif (!strncmp(p[0], "CTCRTY", 6)) {\r\np[0] += 6;\r\nswitch (*p[0]) {\r\ncase '?':\r\np[0]++;\r\nsprintf(rs, "\r\n%d", f->ctcrty);\r\nisdn_tty_at_cout(rs, info);\r\nbreak;\r\ncase '=':\r\np[0]++;\r\nif (*p[0] == '?') {\r\np[0]++;\r\nsprintf(rs, "\r\n0-255");\r\nisdn_tty_at_cout(rs, info);\r\n} else {\r\npar = isdn_getnum(p);\r\nif ((par < 0) || (par > 255))\r\nPARSE_ERROR1;\r\nf->ctcrty = par;\r\n#ifdef ISDN_TTY_FAX_STAT_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty: Fax FCTCRTY=%d\n", par);\r\n#endif\r\n}\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nreturn 0;\r\n}\r\nif (!strncmp(p[0], "DCC", 3)) {\r\nchar *rp = &f->resolution;\r\nint i;\r\np[0] += 3;\r\nswitch (*p[0]) {\r\ncase '?':\r\np[0]++;\r\nstrcpy(rs, "\r\n");\r\nfor (i = 0; i < 8; i++) {\r\nsprintf(rss, "%c%s", rp[i] + 48,\r\n(i < 7) ? "," : "");\r\nstrcat(rs, rss);\r\n}\r\nisdn_tty_at_cout(rs, info);\r\nbreak;\r\ncase '=':\r\np[0]++;\r\nif (*p[0] == '?') {\r\nisdn_tty_at_cout("\r\n(0,1),(0-5),(0-2),(0-2),(0-3),(0-2),(0),(0-7)", info);\r\np[0]++;\r\n} else {\r\nfor (i = 0; (((*p[0] >= '0') && (*p[0] <= '9')) || (*p[0] == ',')) && (i < 8); i++) {\r\nif (*p[0] != ',') {\r\nif ((*p[0] - 48) > maxdccval[i]) {\r\nPARSE_ERROR1;\r\n}\r\nrp[i] = *p[0] - 48;\r\np[0]++;\r\nif (*p[0] == ',')\r\np[0]++;\r\n} else\r\np[0]++;\r\n}\r\n#ifdef ISDN_TTY_FAX_STAT_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty: Fax FDCC capabilities DCE=%d,%d,%d,%d,%d,%d,%d,%d\n",\r\nrp[0], rp[1], rp[2], rp[3], rp[4], rp[5], rp[6], rp[7]);\r\n#endif\r\n}\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nreturn 0;\r\n}\r\nif (!strncmp(p[0], "DIS", 3)) {\r\nchar *rp = &f->resolution;\r\nint i;\r\np[0] += 3;\r\nswitch (*p[0]) {\r\ncase '?':\r\np[0]++;\r\nstrcpy(rs, "\r\n");\r\nfor (i = 0; i < 8; i++) {\r\nsprintf(rss, "%c%s", rp[i] + 48,\r\n(i < 7) ? "," : "");\r\nstrcat(rs, rss);\r\n}\r\nisdn_tty_at_cout(rs, info);\r\nbreak;\r\ncase '=':\r\np[0]++;\r\nif (*p[0] == '?') {\r\nisdn_tty_at_cout("\r\n(0,1),(0-5),(0-2),(0-2),(0-3),(0-2),(0),(0-7)", info);\r\np[0]++;\r\n} else {\r\nfor (i = 0; (((*p[0] >= '0') && (*p[0] <= '9')) || (*p[0] == ',')) && (i < 8); i++) {\r\nif (*p[0] != ',') {\r\nif ((*p[0] - 48) > maxdccval[i]) {\r\nPARSE_ERROR1;\r\n}\r\nrp[i] = *p[0] - 48;\r\np[0]++;\r\nif (*p[0] == ',')\r\np[0]++;\r\n} else\r\np[0]++;\r\n}\r\n#ifdef ISDN_TTY_FAX_STAT_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty: Fax FDIS session parms=%d,%d,%d,%d,%d,%d,%d,%d\n",\r\nrp[0], rp[1], rp[2], rp[3], rp[4], rp[5], rp[6], rp[7]);\r\n#endif\r\n}\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nreturn 0;\r\n}\r\nif (!strncmp(p[0], "DR", 2)) {\r\np[0] += 2;\r\nif ((info->faxonline & 16) &&\r\n((f->phase == ISDN_FAX_PHASE_B) || (f->phase == ISDN_FAX_PHASE_D))) {\r\n#ifdef ISDN_TTY_FAX_STAT_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty: Fax FDR\n");\r\n#endif\r\nf->code = ISDN_TTY_FAX_DR;\r\ncmd.driver = info->isdn_driver;\r\ncmd.arg = info->isdn_channel;\r\ncmd.command = ISDN_CMD_FAXCMD;\r\nisdn_command(&cmd);\r\nif (f->phase == ISDN_FAX_PHASE_B) {\r\nf->phase = ISDN_FAX_PHASE_C;\r\n} else if (f->phase == ISDN_FAX_PHASE_D) {\r\nswitch (f->fet) {\r\ncase 0:\r\nf->phase = ISDN_FAX_PHASE_C;\r\nisdn_tty_fax_modem_result(7, info);\r\nbreak;\r\ncase 1:\r\nf->phase = ISDN_FAX_PHASE_B;\r\nbreak;\r\ncase 2:\r\nf->phase = ISDN_FAX_PHASE_E;\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\n}\r\n} else {\r\nPARSE_ERROR1;\r\n}\r\nreturn 1;\r\n}\r\nif (!strncmp(p[0], "DT", 2)) {\r\nint i, val[] =\r\n{4, 0, 2, 3};\r\nchar *rp = &f->resolution;\r\np[0] += 2;\r\nif (!(info->faxonline & 1))\r\nPARSE_ERROR1;\r\nfor (i = 0; (((*p[0] >= '0') && (*p[0] <= '9')) || (*p[0] == ',')) && (i < 4); i++) {\r\nif (*p[0] != ',') {\r\nif ((*p[0] - 48) > maxdccval[val[i]]) {\r\nPARSE_ERROR1;\r\n}\r\nrp[val[i]] = *p[0] - 48;\r\np[0]++;\r\nif (*p[0] == ',')\r\np[0]++;\r\n} else\r\np[0]++;\r\n}\r\n#ifdef ISDN_TTY_FAX_STAT_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty: Fax FDT tx data command parms=%d,%d,%d,%d\n",\r\nrp[4], rp[0], rp[2], rp[3]);\r\n#endif\r\nif ((f->phase == ISDN_FAX_PHASE_B) || (f->phase == ISDN_FAX_PHASE_D)) {\r\nf->code = ISDN_TTY_FAX_DT;\r\ncmd.driver = info->isdn_driver;\r\ncmd.arg = info->isdn_channel;\r\ncmd.command = ISDN_CMD_FAXCMD;\r\nisdn_command(&cmd);\r\nif (f->phase == ISDN_FAX_PHASE_D) {\r\nf->phase = ISDN_FAX_PHASE_C;\r\nisdn_tty_fax_modem_result(7, info);\r\n}\r\n} else {\r\nPARSE_ERROR1;\r\n}\r\nreturn 1;\r\n}\r\nif (!strncmp(p[0], "ECM", 3)) {\r\np[0] += 3;\r\nswitch (*p[0]) {\r\ncase '?':\r\np[0]++;\r\nsprintf(rs, "\r\n%d", f->ecm);\r\nisdn_tty_at_cout(rs, info);\r\nbreak;\r\ncase '=':\r\np[0]++;\r\nif (*p[0] == '?') {\r\np[0]++;\r\nsprintf(rs, "\r\n0,2");\r\nisdn_tty_at_cout(rs, info);\r\n} else {\r\npar = isdn_getnum(p);\r\nif ((par != 0) && (par != 2))\r\nPARSE_ERROR1;\r\nf->ecm = par;\r\n#ifdef ISDN_TTY_FAX_STAT_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty: Fax FECM=%d\n", par);\r\n#endif\r\n}\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nreturn 0;\r\n}\r\nif (!strncmp(p[0], "ET=", 3)) {\r\np[0] += 3;\r\nif (*p[0] == '?') {\r\np[0]++;\r\nsprintf(rs, "\r\n0-2");\r\nisdn_tty_at_cout(rs, info);\r\n} else {\r\nif ((f->phase != ISDN_FAX_PHASE_D) ||\r\n(!(info->faxonline & 1)))\r\nPARSE_ERROR1;\r\npar = isdn_getnum(p);\r\nif ((par < 0) || (par > 2))\r\nPARSE_ERROR1;\r\nf->fet = par;\r\nf->code = ISDN_TTY_FAX_ET;\r\ncmd.driver = info->isdn_driver;\r\ncmd.arg = info->isdn_channel;\r\ncmd.command = ISDN_CMD_FAXCMD;\r\nisdn_command(&cmd);\r\n#ifdef ISDN_TTY_FAX_STAT_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty: Fax FET=%d\n", par);\r\n#endif\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nif (!strncmp(p[0], "K", 1)) {\r\np[0] += 1;\r\nif ((f->phase == ISDN_FAX_PHASE_IDLE) || (f->phase == ISDN_FAX_PHASE_E))\r\nPARSE_ERROR1;\r\nisdn_tty_modem_hup(info, 1);\r\nreturn 1;\r\n}\r\nif (!strncmp(p[0], "LID", 3)) {\r\nint i, r;\r\np[0] += 3;\r\nswitch (*p[0]) {\r\ncase '?':\r\np[0]++;\r\nsprintf(rs, "\r\n\"%s\"", f->id);\r\nisdn_tty_at_cout(rs, info);\r\nbreak;\r\ncase '=':\r\np[0]++;\r\nif (*p[0] == '?') {\r\np[0]++;\r\nsprintf(rs, "\r\n\"STRING\"");\r\nisdn_tty_at_cout(rs, info);\r\n} else {\r\nif (*p[0] == '"')\r\np[0]++;\r\nfor (i = 0; (*p[0]) && i < (FAXIDLEN - 1) && (*p[0] != '"'); i++) {\r\nf->id[i] = *p[0]++;\r\n}\r\nif (*p[0] == '"')\r\np[0]++;\r\nfor (r = i; r < FAXIDLEN; r++) {\r\nf->id[r] = 32;\r\n}\r\nf->id[FAXIDLEN - 1] = 0;\r\n#ifdef ISDN_TTY_FAX_STAT_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty: Fax local ID \"%s\"\n", f->id);\r\n#endif\r\n}\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nreturn 0;\r\n}\r\nif (!strncmp(p[0], "MDL?", 4)) {\r\np[0] += 4;\r\n#ifdef ISDN_TTY_FAX_STAT_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty: FMDL?\n");\r\n#endif\r\nisdn_tty_at_cout("\r\nisdn4linux", info);\r\nreturn 0;\r\n}\r\nif (!strncmp(p[0], "MFR?", 4)) {\r\np[0] += 4;\r\n#ifdef ISDN_TTY_FAX_STAT_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty: FMFR?\n");\r\n#endif\r\nisdn_tty_at_cout("\r\nisdn4linux", info);\r\nreturn 0;\r\n}\r\nif (!strncmp(p[0], "MINSP", 5)) {\r\np[0] += 5;\r\nswitch (*p[0]) {\r\ncase '?':\r\np[0]++;\r\nsprintf(rs, "\r\n%d", f->minsp);\r\nisdn_tty_at_cout(rs, info);\r\nbreak;\r\ncase '=':\r\np[0]++;\r\nif (*p[0] == '?') {\r\np[0]++;\r\nsprintf(rs, "\r\n0-5");\r\nisdn_tty_at_cout(rs, info);\r\n} else {\r\npar = isdn_getnum(p);\r\nif ((par < 0) || (par > 5))\r\nPARSE_ERROR1;\r\nf->minsp = par;\r\n#ifdef ISDN_TTY_FAX_STAT_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty: Fax FMINSP=%d\n", par);\r\n#endif\r\n}\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nreturn 0;\r\n}\r\nif (!strncmp(p[0], "PHCTO", 5)) {\r\np[0] += 5;\r\nswitch (*p[0]) {\r\ncase '?':\r\np[0]++;\r\nsprintf(rs, "\r\n%d", f->phcto);\r\nisdn_tty_at_cout(rs, info);\r\nbreak;\r\ncase '=':\r\np[0]++;\r\nif (*p[0] == '?') {\r\np[0]++;\r\nsprintf(rs, "\r\n0-255");\r\nisdn_tty_at_cout(rs, info);\r\n} else {\r\npar = isdn_getnum(p);\r\nif ((par < 0) || (par > 255))\r\nPARSE_ERROR1;\r\nf->phcto = par;\r\n#ifdef ISDN_TTY_FAX_STAT_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty: Fax FPHCTO=%d\n", par);\r\n#endif\r\n}\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nreturn 0;\r\n}\r\nif (!strncmp(p[0], "REL", 3)) {\r\np[0] += 3;\r\nswitch (*p[0]) {\r\ncase '?':\r\np[0]++;\r\nsprintf(rs, "\r\n%d", f->rel);\r\nisdn_tty_at_cout(rs, info);\r\nbreak;\r\ncase '=':\r\np[0]++;\r\nif (*p[0] == '?') {\r\np[0]++;\r\nsprintf(rs, "\r\n0,1");\r\nisdn_tty_at_cout(rs, info);\r\n} else {\r\npar = isdn_getnum(p);\r\nif ((par < 0) || (par > 1))\r\nPARSE_ERROR1;\r\nf->rel = par;\r\n#ifdef ISDN_TTY_FAX_STAT_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty: Fax FREL=%d\n", par);\r\n#endif\r\n}\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nreturn 0;\r\n}\r\nif (!strncmp(p[0], "REV?", 4)) {\r\np[0] += 4;\r\n#ifdef ISDN_TTY_FAX_STAT_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty: FREV?\n");\r\n#endif\r\nstrcpy(rss, isdn_tty_fax_revision);\r\nsprintf(rs, "\r\nRev: %s", isdn_getrev(rss));\r\nisdn_tty_at_cout(rs, info);\r\nreturn 0;\r\n}\r\nif (!strncmp(p[0], "TBC=", 4)) {\r\np[0] += 4;\r\n#ifdef ISDN_TTY_FAX_STAT_DEBUG\r\nprintk(KERN_DEBUG "isdn_tty: Fax FTBC=%c\n", *p[0]);\r\n#endif\r\nswitch (*p[0]) {\r\ncase '0':\r\np[0]++;\r\nbreak;\r\ndefault:\r\nPARSE_ERROR1;\r\n}\r\nreturn 0;\r\n}\r\nprintk(KERN_DEBUG "isdn_tty: unknown token=>AT+F%s<\n", p[0]);\r\nPARSE_ERROR1;\r\n}\r\nint\r\nisdn_tty_cmd_PLUSF_FAX(char **p, modem_info * info)\r\n{\r\nif (TTY_IS_FCLASS2(info))\r\nreturn (isdn_tty_cmd_FCLASS2(p, info));\r\nelse if (TTY_IS_FCLASS1(info))\r\nreturn (isdn_tty_cmd_FCLASS1(p, info));\r\nPARSE_ERROR1;\r\n}

static void DoSendCompletion(struct htc_endpoint *pEndpoint,\r\nstruct htc_packet_queue *pQueueToIndicate)\r\n{\r\ndo {\r\nif (HTC_QUEUE_EMPTY(pQueueToIndicate)) {\r\nbreak;\r\n}\r\nif (pEndpoint->EpCallBacks.EpTxCompleteMultiple != NULL) {\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND, (" HTC calling ep %d, send complete multiple callback (%d pkts) \n",\r\npEndpoint->Id, HTC_PACKET_QUEUE_DEPTH(pQueueToIndicate)));\r\npEndpoint->EpCallBacks.EpTxCompleteMultiple(pEndpoint->EpCallBacks.pContext,\r\npQueueToIndicate);\r\nINIT_HTC_PACKET_QUEUE(pQueueToIndicate);\r\n} else {\r\nstruct htc_packet *pPacket;\r\ndo {\r\npPacket = HTC_PACKET_DEQUEUE(pQueueToIndicate);\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND, (" HTC calling ep %d send complete callback on packet 0x%lX \n", \\r\npEndpoint->Id, (unsigned long)(pPacket)));\r\npEndpoint->EpCallBacks.EpTxComplete(pEndpoint->EpCallBacks.pContext, pPacket);\r\n} while (!HTC_QUEUE_EMPTY(pQueueToIndicate));\r\n}\r\n} while (false);\r\n}\r\nstatic INLINE void CompleteSentPacket(struct htc_target *target, struct htc_endpoint *pEndpoint, struct htc_packet *pPacket)\r\n{\r\npPacket->Completion = NULL;\r\nif (pPacket->Status) {\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ERR,\r\n("CompleteSentPacket: request failed (status:%d, ep:%d, length:%d creds:%d) \n",\r\npPacket->Status, pPacket->Endpoint, pPacket->ActualLength, pPacket->PktInfo.AsTx.CreditsUsed));\r\nLOCK_HTC_TX(target);\r\npEndpoint->CreditDist.TxCreditsToDist += pPacket->PktInfo.AsTx.CreditsUsed;\r\npEndpoint->CreditDist.TxQueueDepth = HTC_PACKET_QUEUE_DEPTH(&pEndpoint->TxQueue);\r\nDO_DISTRIBUTION(target,\r\nHTC_CREDIT_DIST_SEND_COMPLETE,\r\n"Send Complete",\r\ntarget->EpCreditDistributionListHead->pNext);\r\nUNLOCK_HTC_TX(target);\r\n}\r\npPacket->pBuffer += HTC_HDR_LENGTH;\r\n}\r\nstatic void HTCSendPktCompletionHandler(void *Context, struct htc_packet *pPacket)\r\n{\r\nstruct htc_target *target = (struct htc_target *)Context;\r\nstruct htc_endpoint *pEndpoint = &target->EndPoint[pPacket->Endpoint];\r\nstruct htc_packet_queue container;\r\nCompleteSentPacket(target,pEndpoint,pPacket);\r\nINIT_HTC_PACKET_QUEUE_AND_ADD(&container,pPacket);\r\nDO_EP_TX_COMPLETION(pEndpoint,&container);\r\n}\r\nint HTCIssueSend(struct htc_target *target, struct htc_packet *pPacket)\r\n{\r\nint status;\r\nbool sync = false;\r\nif (pPacket->Completion == NULL) {\r\nsync = true;\r\n}\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND,\r\n("+-HTCIssueSend: transmit length : %d (%s) \n",\r\npPacket->ActualLength + (u32)HTC_HDR_LENGTH,\r\nsync ? "SYNC" : "ASYNC" ));\r\nstatus = DevSendPacket(&target->Device,\r\npPacket,\r\npPacket->ActualLength + HTC_HDR_LENGTH);\r\nif (sync) {\r\npPacket->pBuffer += HTC_HDR_LENGTH;\r\n}\r\nreturn status;\r\n}\r\nstatic INLINE void GetHTCSendPackets(struct htc_target *target,\r\nstruct htc_endpoint *pEndpoint,\r\nstruct htc_packet_queue *pQueue)\r\n{\r\nint creditsRequired;\r\nint remainder;\r\nu8 sendFlags;\r\nstruct htc_packet *pPacket;\r\nunsigned int transferLength;\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND,("+GetHTCSendPackets \n"));\r\nwhile (true) {\r\nsendFlags = 0;\r\npPacket = HTC_GET_PKT_AT_HEAD(&pEndpoint->TxQueue);\r\nif (pPacket == NULL) {\r\nbreak;\r\n}\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND,(" Got head packet:0x%lX , Queue Depth: %d\n",\r\n(unsigned long)pPacket, HTC_PACKET_QUEUE_DEPTH(&pEndpoint->TxQueue)));\r\ntransferLength = DEV_CALC_SEND_PADDED_LEN(&target->Device, pPacket->ActualLength + HTC_HDR_LENGTH);\r\nif (transferLength <= target->TargetCreditSize) {\r\ncreditsRequired = 1;\r\n} else {\r\ncreditsRequired = transferLength / target->TargetCreditSize;\r\nremainder = transferLength % target->TargetCreditSize;\r\nif (remainder) {\r\ncreditsRequired++;\r\n}\r\n}\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND,(" Creds Required:%d Got:%d\n",\r\ncreditsRequired, pEndpoint->CreditDist.TxCredits));\r\nif (pEndpoint->CreditDist.TxCredits < creditsRequired) {\r\nif (pPacket->Endpoint == ENDPOINT_0) {\r\nbreak;\r\n}\r\npEndpoint->CreditDist.TxCreditsSeek =\r\ncreditsRequired - pEndpoint->CreditDist.TxCredits;\r\nDO_DISTRIBUTION(target,\r\nHTC_CREDIT_DIST_SEEK_CREDITS,\r\n"Seek Credits",\r\n&pEndpoint->CreditDist);\r\npEndpoint->CreditDist.TxCreditsSeek = 0;\r\nif (pEndpoint->CreditDist.TxCredits < creditsRequired) {\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND,\r\n(" Not enough credits for ep %d leaving packet in queue..\n",\r\npPacket->Endpoint));\r\nbreak;\r\n}\r\n}\r\npEndpoint->CreditDist.TxCredits -= creditsRequired;\r\nINC_HTC_EP_STAT(pEndpoint, TxCreditsConsummed, creditsRequired);\r\nif (pEndpoint->CreditDist.TxCredits < pEndpoint->CreditDist.TxCreditsPerMaxMsg) {\r\npEndpoint->CreditDist.TxCreditsSeek =\r\npEndpoint->CreditDist.TxCreditsPerMaxMsg - pEndpoint->CreditDist.TxCredits;\r\nDO_DISTRIBUTION(target,\r\nHTC_CREDIT_DIST_SEEK_CREDITS,\r\n"Seek Credits",\r\n&pEndpoint->CreditDist);\r\npEndpoint->CreditDist.TxCreditsSeek = 0;\r\nif (pEndpoint->CreditDist.TxCredits < pEndpoint->CreditDist.TxCreditsPerMaxMsg) {\r\nsendFlags |= HTC_FLAGS_NEED_CREDIT_UPDATE;\r\nINC_HTC_EP_STAT(pEndpoint, TxCreditLowIndications, 1);\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND,(" Host Needs Credits \n"));\r\n}\r\n}\r\npPacket = HTC_PACKET_DEQUEUE(&pEndpoint->TxQueue);\r\npPacket->PktInfo.AsTx.CreditsUsed = creditsRequired;\r\npPacket->Completion = HTCSendPktCompletionHandler;\r\npPacket->pContext = target;\r\nINC_HTC_EP_STAT(pEndpoint, TxIssued, 1);\r\npPacket->PktInfo.AsTx.SendFlags = sendFlags;\r\npPacket->PktInfo.AsTx.SeqNo = pEndpoint->SeqNo;\r\npEndpoint->SeqNo++;\r\nHTC_PACKET_ENQUEUE(pQueue,pPacket);\r\n}\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND,("-GetHTCSendPackets \n"));\r\n}\r\nstatic void HTCAsyncSendScatterCompletion(struct hif_scatter_req *pScatterReq)\r\n{\r\nint i;\r\nstruct htc_packet *pPacket;\r\nstruct htc_endpoint *pEndpoint = (struct htc_endpoint *)pScatterReq->Context;\r\nstruct htc_target *target = (struct htc_target *)pEndpoint->target;\r\nint status = 0;\r\nstruct htc_packet_queue sendCompletes;\r\nINIT_HTC_PACKET_QUEUE(&sendCompletes);\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND,("+HTCAsyncSendScatterCompletion TotLen: %d Entries: %d\n",\r\npScatterReq->TotalLength, pScatterReq->ValidScatterEntries));\r\nDEV_FINISH_SCATTER_OPERATION(pScatterReq);\r\nif (pScatterReq->CompletionStatus) {\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ERR,("** Send Scatter Request Failed: %d \n",pScatterReq->CompletionStatus));\r\nstatus = A_ERROR;\r\n}\r\nfor (i = 0; i < pScatterReq->ValidScatterEntries; i++) {\r\npPacket = (struct htc_packet *)(pScatterReq->ScatterList[i].pCallerContexts[0]);\r\nA_ASSERT(pPacket != NULL);\r\npPacket->Status = status;\r\nCompleteSentPacket(target,pEndpoint,pPacket);\r\nHTC_PACKET_ENQUEUE(&sendCompletes, pPacket);\r\n}\r\nDEV_FREE_SCATTER_REQ(&target->Device,pScatterReq);\r\nDO_EP_TX_COMPLETION(pEndpoint,&sendCompletes);\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND,("-HTCAsyncSendScatterCompletion \n"));\r\n}\r\nstatic void HTCIssueSendBundle(struct htc_endpoint *pEndpoint,\r\nstruct htc_packet_queue *pQueue,\r\nint *pBundlesSent,\r\nint *pTotalBundlesPkts)\r\n{\r\nint pktsToScatter;\r\nunsigned int scatterSpaceRemaining;\r\nstruct hif_scatter_req *pScatterReq = NULL;\r\nint i, packetsInScatterReq;\r\nunsigned int transferLength;\r\nstruct htc_packet *pPacket;\r\nbool done = false;\r\nint bundlesSent = 0;\r\nint totalPktsInBundle = 0;\r\nstruct htc_target *target = pEndpoint->target;\r\nint creditRemainder = 0;\r\nint creditPad;\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND,("+HTCIssueSendBundle \n"));\r\nwhile (!done) {\r\npktsToScatter = HTC_PACKET_QUEUE_DEPTH(pQueue);\r\npktsToScatter = min(pktsToScatter, target->MaxMsgPerBundle);\r\nif (pktsToScatter < HTC_MIN_HTC_MSGS_TO_BUNDLE) {\r\nbreak;\r\n}\r\npScatterReq = DEV_ALLOC_SCATTER_REQ(&target->Device);\r\nif (pScatterReq == NULL) {\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND,(" No more scatter resources \n"));\r\nbreak;\r\n}\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND,(" pkts to scatter: %d \n", pktsToScatter));\r\npScatterReq->TotalLength = 0;\r\npScatterReq->ValidScatterEntries = 0;\r\npacketsInScatterReq = 0;\r\nscatterSpaceRemaining = DEV_GET_MAX_BUNDLE_SEND_LENGTH(&target->Device);\r\nfor (i = 0; i < pktsToScatter; i++) {\r\npScatterReq->ScatterList[i].pCallerContexts[0] = NULL;\r\npPacket = HTC_GET_PKT_AT_HEAD(pQueue);\r\nif (pPacket == NULL) {\r\nA_ASSERT(false);\r\nbreak;\r\n}\r\ncreditPad = 0;\r\ntransferLength = DEV_CALC_SEND_PADDED_LEN(&target->Device,\r\npPacket->ActualLength + HTC_HDR_LENGTH);\r\ncreditRemainder = transferLength % target->TargetCreditSize;\r\nif (creditRemainder != 0) {\r\nif (pEndpoint->LocalConnectionFlags & HTC_LOCAL_CONN_FLAGS_ENABLE_SEND_BUNDLE_PADDING) {\r\nif (transferLength < target->TargetCreditSize) {\r\ncreditPad = target->TargetCreditSize - transferLength;\r\n} else {\r\ncreditPad = creditRemainder;\r\n}\r\nif ((creditPad > 0) && (creditPad <= 255)) {\r\ntransferLength += creditPad;\r\n} else {\r\npPacket = NULL;\r\n}\r\n} else {\r\npPacket = NULL;\r\n}\r\n}\r\nif (NULL == pPacket) {\r\ndone = true;\r\nbreak;\r\n}\r\nif (scatterSpaceRemaining < transferLength) {\r\nbreak;\r\n}\r\nscatterSpaceRemaining -= transferLength;\r\npPacket = HTC_PACKET_DEQUEUE(pQueue);\r\npScatterReq->ScatterList[i].pCallerContexts[0] = pPacket;\r\nHTC_PREPARE_SEND_PKT(pPacket,\r\npPacket->PktInfo.AsTx.SendFlags | HTC_FLAGS_SEND_BUNDLE,\r\ncreditPad,\r\npPacket->PktInfo.AsTx.SeqNo);\r\npScatterReq->ScatterList[i].pBuffer = pPacket->pBuffer;\r\npScatterReq->ScatterList[i].Length = transferLength;\r\nA_ASSERT(transferLength);\r\npScatterReq->TotalLength += transferLength;\r\npScatterReq->ValidScatterEntries++;\r\npacketsInScatterReq++;\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND,(" %d, Adding packet : 0x%lX, len:%d (remaining space:%d) \n",\r\ni, (unsigned long)pPacket,transferLength,scatterSpaceRemaining));\r\n}\r\nif (packetsInScatterReq >= HTC_MIN_HTC_MSGS_TO_BUNDLE) {\r\npScatterReq->CompletionRoutine = HTCAsyncSendScatterCompletion;\r\npScatterReq->Context = pEndpoint;\r\nbundlesSent++;\r\ntotalPktsInBundle += packetsInScatterReq;\r\npacketsInScatterReq = 0;\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND,(" Send Scatter total bytes: %d , entries: %d\n",\r\npScatterReq->TotalLength,pScatterReq->ValidScatterEntries));\r\nDevSubmitScatterRequest(&target->Device, pScatterReq, DEV_SCATTER_WRITE, DEV_SCATTER_ASYNC);\r\npScatterReq = NULL;\r\ncontinue;\r\n}\r\nif (pScatterReq != NULL) {\r\nif (packetsInScatterReq > 0) {\r\nfor (i = (packetsInScatterReq - 1); i >= 0; i--) {\r\npPacket = (struct htc_packet *)(pScatterReq->ScatterList[i].pCallerContexts[0]);\r\nif (pPacket != NULL) {\r\nHTC_UNPREPARE_SEND_PKT(pPacket);\r\nHTC_PACKET_ENQUEUE_TO_HEAD(pQueue,pPacket);\r\n}\r\n}\r\n}\r\nDEV_FREE_SCATTER_REQ(&target->Device,pScatterReq);\r\n}\r\nbreak;\r\n}\r\n*pBundlesSent = bundlesSent;\r\n*pTotalBundlesPkts = totalPktsInBundle;\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND,("-HTCIssueSendBundle (sent:%d) \n",bundlesSent));\r\nreturn;\r\n}\r\nstatic HTC_SEND_QUEUE_RESULT HTCTrySend(struct htc_target *target,\r\nstruct htc_endpoint *pEndpoint,\r\nstruct htc_packet_queue *pCallersSendQueue)\r\n{\r\nstruct htc_packet_queue sendQueue;\r\nstruct htc_packet *pPacket;\r\nint bundlesSent;\r\nint pktsInBundles;\r\nint overflow;\r\nHTC_SEND_QUEUE_RESULT result = HTC_SEND_QUEUE_OK;\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND,("+HTCTrySend (Queue:0x%lX Depth:%d)\n",\r\n(unsigned long)pCallersSendQueue,\r\n(pCallersSendQueue == NULL) ? 0 : HTC_PACKET_QUEUE_DEPTH(pCallersSendQueue)));\r\nINIT_HTC_PACKET_QUEUE(&sendQueue);\r\ndo {\r\nif (NULL == pCallersSendQueue) {\r\nbreak;\r\n}\r\nif (HTC_QUEUE_EMPTY(pCallersSendQueue)) {\r\nresult = HTC_SEND_QUEUE_DROP;\r\nbreak;\r\n}\r\nif (HTC_PACKET_QUEUE_DEPTH(&pEndpoint->TxQueue) >= pEndpoint->MaxTxQueueDepth) {\r\noverflow = HTC_PACKET_QUEUE_DEPTH(pCallersSendQueue);\r\n} else {\r\noverflow = HTC_PACKET_QUEUE_DEPTH(&pEndpoint->TxQueue);\r\noverflow += HTC_PACKET_QUEUE_DEPTH(pCallersSendQueue);\r\noverflow -= pEndpoint->MaxTxQueueDepth;\r\n}\r\nif (overflow > 0) {\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND,\r\n(" Endpoint %d, TX queue will overflow :%d , Tx Depth:%d, Max:%d \n",\r\npEndpoint->Id, overflow, HTC_PACKET_QUEUE_DEPTH(&pEndpoint->TxQueue), pEndpoint->MaxTxQueueDepth));\r\n}\r\nif ((overflow <= 0) || (pEndpoint->EpCallBacks.EpSendFull == NULL)) {\r\nHTC_PACKET_QUEUE_TRANSFER_TO_TAIL(&sendQueue, pCallersSendQueue);\r\n} else {\r\nint i;\r\nint goodPkts = HTC_PACKET_QUEUE_DEPTH(pCallersSendQueue) - overflow;\r\nA_ASSERT(goodPkts >= 0);\r\nfor (i = 0; i < goodPkts; i++) {\r\npPacket = HTC_PACKET_DEQUEUE(pCallersSendQueue);\r\nA_ASSERT(pPacket != NULL);\r\nHTC_PACKET_ENQUEUE(&sendQueue,pPacket);\r\n}\r\nITERATE_OVER_LIST_ALLOW_REMOVE(&pCallersSendQueue->QueueHead, pPacket, struct htc_packet, ListLink) {\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND, (" Indicating overflowed TX packet: 0x%lX \n",\r\n(unsigned long)pPacket));\r\nif (pEndpoint->EpCallBacks.EpSendFull(pEndpoint->EpCallBacks.pContext,\r\npPacket) == HTC_SEND_FULL_DROP) {\r\nINC_HTC_EP_STAT(pEndpoint, TxDropped, 1);\r\n} else {\r\nHTC_PACKET_REMOVE(pCallersSendQueue, pPacket);\r\nHTC_PACKET_ENQUEUE(&sendQueue,pPacket);\r\n}\r\n} ITERATE_END;\r\nif (HTC_QUEUE_EMPTY(&sendQueue)) {\r\nresult = HTC_SEND_QUEUE_DROP;\r\nbreak;\r\n}\r\n}\r\n} while (false);\r\nif (result != HTC_SEND_QUEUE_OK) {\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND,("-HTCTrySend: \n"));\r\nreturn result;\r\n}\r\nLOCK_HTC_TX(target);\r\nif (!HTC_QUEUE_EMPTY(&sendQueue)) {\r\nHTC_PACKET_QUEUE_TRANSFER_TO_TAIL(&pEndpoint->TxQueue,&sendQueue);\r\nA_ASSERT(HTC_QUEUE_EMPTY(&sendQueue));\r\nINIT_HTC_PACKET_QUEUE(&sendQueue);\r\n}\r\npEndpoint->TxProcessCount++;\r\nif (pEndpoint->TxProcessCount > 1) {\r\npEndpoint->TxProcessCount--;\r\nUNLOCK_HTC_TX(target);\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND,("-HTCTrySend (busy) \n"));\r\nreturn HTC_SEND_QUEUE_OK;\r\n}\r\nwhile (true) {\r\nif (HTC_PACKET_QUEUE_DEPTH(&pEndpoint->TxQueue) == 0) {\r\nbreak;\r\n}\r\nGetHTCSendPackets(target, pEndpoint, &sendQueue);\r\nif (HTC_PACKET_QUEUE_DEPTH(&sendQueue) == 0) {\r\nbreak;\r\n}\r\nUNLOCK_HTC_TX(target);\r\nbundlesSent = 0;\r\npktsInBundles = 0;\r\nwhile (true) {\r\nif ((target->SendBundlingEnabled) &&\r\n(HTC_PACKET_QUEUE_DEPTH(&sendQueue) >= HTC_MIN_HTC_MSGS_TO_BUNDLE)) {\r\nint temp1,temp2;\r\nHTCIssueSendBundle(pEndpoint, &sendQueue, &temp1, &temp2);\r\nbundlesSent += temp1;\r\npktsInBundles += temp2;\r\n}\r\npPacket = HTC_PACKET_DEQUEUE(&sendQueue);\r\nif (NULL == pPacket) {\r\nbreak;\r\n}\r\nHTC_PREPARE_SEND_PKT(pPacket,\r\npPacket->PktInfo.AsTx.SendFlags,\r\n0,\r\npPacket->PktInfo.AsTx.SeqNo);\r\nHTCIssueSend(target, pPacket);\r\n}\r\nLOCK_HTC_TX(target);\r\nINC_HTC_EP_STAT(pEndpoint, TxBundles, bundlesSent);\r\nINC_HTC_EP_STAT(pEndpoint, TxPacketsBundled, pktsInBundles);\r\n}\r\npEndpoint->TxProcessCount = 0;\r\nUNLOCK_HTC_TX(target);\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND,("-HTCTrySend: \n"));\r\nreturn HTC_SEND_QUEUE_OK;\r\n}\r\nint HTCSendPktsMultiple(HTC_HANDLE HTCHandle, struct htc_packet_queue *pPktQueue)\r\n{\r\nstruct htc_target *target = GET_HTC_TARGET_FROM_HANDLE(HTCHandle);\r\nstruct htc_endpoint *pEndpoint;\r\nstruct htc_packet *pPacket;\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND, ("+HTCSendPktsMultiple: Queue: 0x%lX, Pkts %d \n",\r\n(unsigned long)pPktQueue, HTC_PACKET_QUEUE_DEPTH(pPktQueue)));\r\npPacket = HTC_GET_PKT_AT_HEAD(pPktQueue);\r\nif (NULL == pPacket) {\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND, ("-HTCSendPktsMultiple \n"));\r\nreturn A_EINVAL;\r\n}\r\nAR_DEBUG_ASSERT(pPacket->Endpoint < ENDPOINT_MAX);\r\npEndpoint = &target->EndPoint[pPacket->Endpoint];\r\nHTCTrySend(target, pEndpoint, pPktQueue);\r\nif (!HTC_QUEUE_EMPTY(pPktQueue)) {\r\nHTC_PACKET_QUEUE_ITERATE_ALLOW_REMOVE(pPktQueue,pPacket) {\r\nif (HTC_STOPPING(target)) {\r\npPacket->Status = A_ECANCELED;\r\n} else {\r\npPacket->Status = A_NO_RESOURCE;\r\n}\r\n} HTC_PACKET_QUEUE_ITERATE_END;\r\nDO_EP_TX_COMPLETION(pEndpoint,pPktQueue);\r\n}\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND, ("-HTCSendPktsMultiple \n"));\r\nreturn 0;\r\n}\r\nint HTCSendPkt(HTC_HANDLE HTCHandle, struct htc_packet *pPacket)\r\n{\r\nstruct htc_packet_queue queue;\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND,\r\n("+-HTCSendPkt: Enter endPointId: %d, buffer: 0x%lX, length: %d \n",\r\npPacket->Endpoint, (unsigned long)pPacket->pBuffer, pPacket->ActualLength));\r\nINIT_HTC_PACKET_QUEUE_AND_ADD(&queue,pPacket);\r\nreturn HTCSendPktsMultiple(HTCHandle, &queue);\r\n}\r\nstatic INLINE void HTCCheckEndpointTxQueues(struct htc_target *target)\r\n{\r\nstruct htc_endpoint *pEndpoint;\r\nstruct htc_endpoint_credit_dist *pDistItem;\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND, ("+HTCCheckEndpointTxQueues \n"));\r\npDistItem = target->EpCreditDistributionListHead;\r\nwhile (pDistItem != NULL) {\r\npEndpoint = (struct htc_endpoint *)pDistItem->pHTCReserved;\r\nif (HTC_PACKET_QUEUE_DEPTH(&pEndpoint->TxQueue) > 0) {\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND, (" Ep %d has %d credits and %d Packets in TX Queue \n",\r\npDistItem->Endpoint, pEndpoint->CreditDist.TxCredits, HTC_PACKET_QUEUE_DEPTH(&pEndpoint->TxQueue)));\r\nHTCTrySend(target, pEndpoint, NULL);\r\n}\r\npDistItem = pDistItem->pNext;\r\n}\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND, ("-HTCCheckEndpointTxQueues \n"));\r\n}\r\nvoid HTCProcessCreditRpt(struct htc_target *target, HTC_CREDIT_REPORT *pRpt, int NumEntries, HTC_ENDPOINT_ID FromEndpoint)\r\n{\r\nint i;\r\nstruct htc_endpoint *pEndpoint;\r\nint totalCredits = 0;\r\nbool doDist = false;\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND, ("+HTCProcessCreditRpt, Credit Report Entries:%d \n", NumEntries));\r\nLOCK_HTC_TX(target);\r\nfor (i = 0; i < NumEntries; i++, pRpt++) {\r\nif (pRpt->EndpointID >= ENDPOINT_MAX) {\r\nAR_DEBUG_ASSERT(false);\r\nbreak;\r\n}\r\npEndpoint = &target->EndPoint[pRpt->EndpointID];\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND, (" Endpoint %d got %d credits \n",\r\npRpt->EndpointID, pRpt->Credits));\r\nINC_HTC_EP_STAT(pEndpoint, TxCreditRpts, 1);\r\nINC_HTC_EP_STAT(pEndpoint, TxCreditsReturned, pRpt->Credits);\r\nif (FromEndpoint == pRpt->EndpointID) {\r\nINC_HTC_EP_STAT(pEndpoint, TxCreditsFromRx, pRpt->Credits);\r\nINC_HTC_EP_STAT(pEndpoint, TxCreditRptsFromRx, 1);\r\n} else if (FromEndpoint == ENDPOINT_0) {\r\nINC_HTC_EP_STAT(pEndpoint, TxCreditsFromEp0, pRpt->Credits);\r\nINC_HTC_EP_STAT(pEndpoint, TxCreditRptsFromEp0, 1);\r\n} else {\r\nINC_HTC_EP_STAT(pEndpoint, TxCreditsFromOther, pRpt->Credits);\r\nINC_HTC_EP_STAT(pEndpoint, TxCreditRptsFromOther, 1);\r\n}\r\nif (ENDPOINT_0 == pRpt->EndpointID) {\r\npEndpoint->CreditDist.TxCredits += pRpt->Credits;\r\n} else {\r\npEndpoint->CreditDist.TxCreditsToDist += pRpt->Credits;\r\ndoDist = true;\r\n}\r\npEndpoint->CreditDist.TxQueueDepth = HTC_PACKET_QUEUE_DEPTH(&pEndpoint->TxQueue);\r\ntotalCredits += pRpt->Credits;\r\n}\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND, (" Report indicated %d credits to distribute \n", totalCredits));\r\nif (doDist) {\r\nDO_DISTRIBUTION(target,\r\nHTC_CREDIT_DIST_SEND_COMPLETE,\r\n"Send Complete",\r\ntarget->EpCreditDistributionListHead->pNext);\r\n}\r\nUNLOCK_HTC_TX(target);\r\nif (totalCredits) {\r\nHTCCheckEndpointTxQueues(target);\r\n}\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SEND, ("-HTCProcessCreditRpt \n"));\r\n}\r\nstatic void HTCFlushEndpointTX(struct htc_target *target, struct htc_endpoint *pEndpoint, HTC_TX_TAG Tag)\r\n{\r\nstruct htc_packet *pPacket;\r\nstruct htc_packet_queue discardQueue;\r\nstruct htc_packet_queue container;\r\nINIT_HTC_PACKET_QUEUE(&discardQueue);\r\nLOCK_HTC_TX(target);\r\nITERATE_OVER_LIST_ALLOW_REMOVE(&pEndpoint->TxQueue.QueueHead, pPacket, struct htc_packet, ListLink) {\r\nif ((HTC_TX_PACKET_TAG_ALL == Tag) || (Tag == pPacket->PktInfo.AsTx.Tag)) {\r\nHTC_PACKET_REMOVE(&pEndpoint->TxQueue, pPacket);\r\nHTC_PACKET_ENQUEUE(&discardQueue, pPacket);\r\n}\r\n} ITERATE_END;\r\nUNLOCK_HTC_TX(target);\r\nwhile (1) {\r\npPacket = HTC_PACKET_DEQUEUE(&discardQueue);\r\nif (NULL == pPacket) {\r\nbreak;\r\n}\r\npPacket->Status = A_ECANCELED;\r\nAR_DEBUG_PRINTF(ATH_DEBUG_TRC, (" Flushing TX packet:0x%lX, length:%d, ep:%d tag:0x%X \n",\r\n(unsigned long)pPacket, pPacket->ActualLength, pPacket->Endpoint, pPacket->PktInfo.AsTx.Tag));\r\nINIT_HTC_PACKET_QUEUE_AND_ADD(&container,pPacket);\r\nDO_EP_TX_COMPLETION(pEndpoint,&container);\r\n}\r\n}\r\nvoid DumpCreditDist(struct htc_endpoint_credit_dist *pEPDist)\r\n{\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ANY, ("--- EP : %d ServiceID: 0x%X --------------\n",\r\npEPDist->Endpoint, pEPDist->ServiceID));\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ANY, (" this:0x%lX next:0x%lX prev:0x%lX\n",\r\n(unsigned long)pEPDist, (unsigned long)pEPDist->pNext, (unsigned long)pEPDist->pPrev));\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ANY, (" DistFlags : 0x%X \n", pEPDist->DistFlags));\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ANY, (" TxCreditsNorm : %d \n", pEPDist->TxCreditsNorm));\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ANY, (" TxCreditsMin : %d \n", pEPDist->TxCreditsMin));\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ANY, (" TxCredits : %d \n", pEPDist->TxCredits));\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ANY, (" TxCreditsAssigned : %d \n", pEPDist->TxCreditsAssigned));\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ANY, (" TxCreditsSeek : %d \n", pEPDist->TxCreditsSeek));\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ANY, (" TxCreditSize : %d \n", pEPDist->TxCreditSize));\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ANY, (" TxCreditsPerMaxMsg : %d \n", pEPDist->TxCreditsPerMaxMsg));\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ANY, (" TxCreditsToDist : %d \n", pEPDist->TxCreditsToDist));\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ANY, (" TxQueueDepth : %d \n",\r\nHTC_PACKET_QUEUE_DEPTH(&((struct htc_endpoint *)pEPDist->pHTCReserved)->TxQueue)));\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ANY, ("----------------------------------------------------\n"));\r\n}\r\nvoid DumpCreditDistStates(struct htc_target *target)\r\n{\r\nstruct htc_endpoint_credit_dist *pEPList = target->EpCreditDistributionListHead;\r\nwhile (pEPList != NULL) {\r\nDumpCreditDist(pEPList);\r\npEPList = pEPList->pNext;\r\n}\r\nif (target->DistributeCredits != NULL) {\r\nDO_DISTRIBUTION(target,\r\nHTC_DUMP_CREDIT_STATE,\r\n"Dump State",\r\nNULL);\r\n}\r\n}\r\nvoid HTCFlushSendPkts(struct htc_target *target)\r\n{\r\nstruct htc_endpoint *pEndpoint;\r\nint i;\r\nif (AR_DEBUG_LVL_CHECK(ATH_DEBUG_TRC)) {\r\nDumpCreditDistStates(target);\r\n}\r\nfor (i = ENDPOINT_0; i < ENDPOINT_MAX; i++) {\r\npEndpoint = &target->EndPoint[i];\r\nif (pEndpoint->ServiceID == 0) {\r\ncontinue;\r\n}\r\nHTCFlushEndpointTX(target,pEndpoint,HTC_TX_PACKET_TAG_ALL);\r\n}\r\n}\r\nvoid HTCFlushEndpoint(HTC_HANDLE HTCHandle, HTC_ENDPOINT_ID Endpoint, HTC_TX_TAG Tag)\r\n{\r\nstruct htc_target *target = GET_HTC_TARGET_FROM_HANDLE(HTCHandle);\r\nstruct htc_endpoint *pEndpoint = &target->EndPoint[Endpoint];\r\nif (pEndpoint->ServiceID == 0) {\r\nAR_DEBUG_ASSERT(false);\r\nreturn;\r\n}\r\nHTCFlushEndpointTX(target, pEndpoint, Tag);\r\n}\r\nvoid HTCIndicateActivityChange(HTC_HANDLE HTCHandle,\r\nHTC_ENDPOINT_ID Endpoint,\r\nbool Active)\r\n{\r\nstruct htc_target *target = GET_HTC_TARGET_FROM_HANDLE(HTCHandle);\r\nstruct htc_endpoint *pEndpoint = &target->EndPoint[Endpoint];\r\nbool doDist = false;\r\nif (pEndpoint->ServiceID == 0) {\r\nAR_DEBUG_ASSERT(false);\r\nreturn;\r\n}\r\nLOCK_HTC_TX(target);\r\nif (Active) {\r\nif (!(pEndpoint->CreditDist.DistFlags & HTC_EP_ACTIVE)) {\r\npEndpoint->CreditDist.DistFlags |= HTC_EP_ACTIVE;\r\ndoDist = true;\r\n}\r\n} else {\r\nif (pEndpoint->CreditDist.DistFlags & HTC_EP_ACTIVE) {\r\npEndpoint->CreditDist.DistFlags &= ~HTC_EP_ACTIVE;\r\ndoDist = true;\r\n}\r\n}\r\nif (doDist) {\r\npEndpoint->CreditDist.TxQueueDepth = HTC_PACKET_QUEUE_DEPTH(&pEndpoint->TxQueue);\r\nDO_DISTRIBUTION(target,\r\nHTC_CREDIT_DIST_ACTIVITY_CHANGE,\r\n"Activity Change",\r\ntarget->EpCreditDistributionListHead->pNext);\r\n}\r\nUNLOCK_HTC_TX(target);\r\nif (doDist && !Active) {\r\nHTCCheckEndpointTxQueues(target);\r\n}\r\n}\r\nbool HTCIsEndpointActive(HTC_HANDLE HTCHandle,\r\nHTC_ENDPOINT_ID Endpoint)\r\n{\r\nstruct htc_target *target = GET_HTC_TARGET_FROM_HANDLE(HTCHandle);\r\nstruct htc_endpoint *pEndpoint = &target->EndPoint[Endpoint];\r\nif (pEndpoint->ServiceID == 0) {\r\nreturn false;\r\n}\r\nif (pEndpoint->CreditDist.DistFlags & HTC_EP_ACTIVE) {\r\nreturn true;\r\n}\r\nreturn false;\r\n}

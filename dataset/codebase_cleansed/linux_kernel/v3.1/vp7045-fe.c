static int vp7045_fe_read_status(struct dvb_frontend* fe, fe_status_t *status)\r\n{\r\nstruct vp7045_fe_state *state = fe->demodulator_priv;\r\nu8 s0 = vp7045_read_reg(state->d,0x00),\r\ns1 = vp7045_read_reg(state->d,0x01),\r\ns3 = vp7045_read_reg(state->d,0x03);\r\n*status = 0;\r\nif (s0 & (1 << 4))\r\n*status |= FE_HAS_CARRIER;\r\nif (s0 & (1 << 1))\r\n*status |= FE_HAS_VITERBI;\r\nif (s0 & (1 << 5))\r\n*status |= FE_HAS_LOCK;\r\nif (s1 & (1 << 1))\r\n*status |= FE_HAS_SYNC;\r\nif (s3 & (1 << 6))\r\n*status |= FE_HAS_SIGNAL;\r\nif ((*status & (FE_HAS_CARRIER | FE_HAS_VITERBI | FE_HAS_SYNC)) !=\r\n(FE_HAS_CARRIER | FE_HAS_VITERBI | FE_HAS_SYNC))\r\n*status &= ~FE_HAS_LOCK;\r\nreturn 0;\r\n}\r\nstatic int vp7045_fe_read_ber(struct dvb_frontend* fe, u32 *ber)\r\n{\r\nstruct vp7045_fe_state *state = fe->demodulator_priv;\r\n*ber = (vp7045_read_reg(state->d, 0x0D) << 16) |\r\n(vp7045_read_reg(state->d, 0x0E) << 8) |\r\nvp7045_read_reg(state->d, 0x0F);\r\nreturn 0;\r\n}\r\nstatic int vp7045_fe_read_unc_blocks(struct dvb_frontend* fe, u32 *unc)\r\n{\r\nstruct vp7045_fe_state *state = fe->demodulator_priv;\r\n*unc = (vp7045_read_reg(state->d, 0x10) << 8) |\r\nvp7045_read_reg(state->d, 0x11);\r\nreturn 0;\r\n}\r\nstatic int vp7045_fe_read_signal_strength(struct dvb_frontend* fe, u16 *strength)\r\n{\r\nstruct vp7045_fe_state *state = fe->demodulator_priv;\r\nu16 signal = (vp7045_read_reg(state->d, 0x14) << 8) |\r\nvp7045_read_reg(state->d, 0x15);\r\n*strength = ~signal;\r\nreturn 0;\r\n}\r\nstatic int vp7045_fe_read_snr(struct dvb_frontend* fe, u16 *snr)\r\n{\r\nstruct vp7045_fe_state *state = fe->demodulator_priv;\r\nu8 _snr = vp7045_read_reg(state->d, 0x09);\r\n*snr = (_snr << 8) | _snr;\r\nreturn 0;\r\n}\r\nstatic int vp7045_fe_init(struct dvb_frontend* fe)\r\n{\r\nreturn 0;\r\n}\r\nstatic int vp7045_fe_sleep(struct dvb_frontend* fe)\r\n{\r\nreturn 0;\r\n}\r\nstatic int vp7045_fe_get_tune_settings(struct dvb_frontend* fe, struct dvb_frontend_tune_settings *tune)\r\n{\r\ntune->min_delay_ms = 800;\r\nreturn 0;\r\n}\r\nstatic int vp7045_fe_set_frontend(struct dvb_frontend* fe,\r\nstruct dvb_frontend_parameters *fep)\r\n{\r\nstruct vp7045_fe_state *state = fe->demodulator_priv;\r\nu8 buf[5];\r\nu32 freq = fep->frequency / 1000;\r\nbuf[0] = (freq >> 16) & 0xff;\r\nbuf[1] = (freq >> 8) & 0xff;\r\nbuf[2] = freq & 0xff;\r\nbuf[3] = 0;\r\nswitch (fep->u.ofdm.bandwidth) {\r\ncase BANDWIDTH_8_MHZ: buf[4] = 8; break;\r\ncase BANDWIDTH_7_MHZ: buf[4] = 7; break;\r\ncase BANDWIDTH_6_MHZ: buf[4] = 6; break;\r\ncase BANDWIDTH_AUTO: return -EOPNOTSUPP;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nvp7045_usb_op(state->d,LOCK_TUNER_COMMAND,buf,5,NULL,0,200);\r\nreturn 0;\r\n}\r\nstatic int vp7045_fe_get_frontend(struct dvb_frontend* fe,\r\nstruct dvb_frontend_parameters *fep)\r\n{\r\nreturn 0;\r\n}\r\nstatic void vp7045_fe_release(struct dvb_frontend* fe)\r\n{\r\nstruct vp7045_fe_state *state = fe->demodulator_priv;\r\nkfree(state);\r\n}\r\nstruct dvb_frontend * vp7045_fe_attach(struct dvb_usb_device *d)\r\n{\r\nstruct vp7045_fe_state *s = kzalloc(sizeof(struct vp7045_fe_state), GFP_KERNEL);\r\nif (s == NULL)\r\ngoto error;\r\ns->d = d;\r\nmemcpy(&s->fe.ops, &vp7045_fe_ops, sizeof(struct dvb_frontend_ops));\r\ns->fe.demodulator_priv = s;\r\nreturn &s->fe;\r\nerror:\r\nreturn NULL;\r\n}

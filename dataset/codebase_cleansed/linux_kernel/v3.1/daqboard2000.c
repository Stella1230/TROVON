static void writeAcqScanListEntry(struct comedi_device *dev, u16 entry)\r\n{\r\nstruct daqboard2000_hw *fpga = devpriv->daq;\r\nfpga->acqScanListFIFO = entry & 0x00ff;\r\nfpga->acqScanListFIFO = (entry >> 8) & 0x00ff;\r\n}\r\nstatic void setup_sampling(struct comedi_device *dev, int chan, int gain)\r\n{\r\nu16 word0, word1, word2, word3;\r\nword0 = 0;\r\nword1 = 0x0004;\r\nword2 = (chan << 6) & 0x00c0;\r\nswitch (chan / 4) {\r\ncase 0:\r\nword3 = 0x0001;\r\nbreak;\r\ncase 1:\r\nword3 = 0x0002;\r\nbreak;\r\ncase 2:\r\nword3 = 0x0005;\r\nbreak;\r\ncase 3:\r\nword3 = 0x0006;\r\nbreak;\r\ncase 4:\r\nword3 = 0x0041;\r\nbreak;\r\ncase 5:\r\nword3 = 0x0042;\r\nbreak;\r\ndefault:\r\nword3 = 0;\r\nbreak;\r\n}\r\nword2 |= 0x0800;\r\nword3 |= 0xc000;\r\nwriteAcqScanListEntry(dev, word0);\r\nwriteAcqScanListEntry(dev, word1);\r\nwriteAcqScanListEntry(dev, word2);\r\nwriteAcqScanListEntry(dev, word3);\r\n}\r\nstatic int daqboard2000_ai_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nint i;\r\nstruct daqboard2000_hw *fpga = devpriv->daq;\r\nint gain, chan, timeout;\r\nfpga->acqControl =\r\nDAQBOARD2000_AcqResetScanListFifo |\r\nDAQBOARD2000_AcqResetResultsFifo | DAQBOARD2000_AcqResetConfigPipe;\r\nfpga->acqPacerClockDivLow = 1000000;\r\nfpga->acqPacerClockDivHigh = 0;\r\ngain = CR_RANGE(insn->chanspec);\r\nchan = CR_CHAN(insn->chanspec);\r\nfor (i = 0; i < insn->n; i++) {\r\nsetup_sampling(dev, chan, gain);\r\nfpga->acqControl = DAQBOARD2000_SeqStartScanList;\r\nfor (timeout = 0; timeout < 20; timeout++) {\r\nif (fpga->acqControl & DAQBOARD2000_AcqConfigPipeFull) {\r\nbreak;\r\n}\r\n}\r\nfpga->acqControl = DAQBOARD2000_AdcPacerEnable;\r\nfor (timeout = 0; timeout < 20; timeout++) {\r\nif (fpga->acqControl & DAQBOARD2000_AcqLogicScanning) {\r\nbreak;\r\n}\r\n}\r\nfor (timeout = 0; timeout < 20; timeout++) {\r\nif (fpga->acqControl &\r\nDAQBOARD2000_AcqResultsFIFOHasValidData) {\r\nbreak;\r\n}\r\n}\r\ndata[i] = fpga->acqResultsFIFO;\r\nfpga->acqControl = DAQBOARD2000_AdcPacerDisable;\r\nfpga->acqControl = DAQBOARD2000_SeqStopScanList;\r\n}\r\nreturn i;\r\n}\r\nstatic int daqboard2000_ao_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nint i;\r\nint chan = CR_CHAN(insn->chanspec);\r\nfor (i = 0; i < insn->n; i++) {\r\ndata[i] = devpriv->ao_readback[chan];\r\n}\r\nreturn i;\r\n}\r\nstatic int daqboard2000_ao_insn_write(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nint i;\r\nint chan = CR_CHAN(insn->chanspec);\r\nstruct daqboard2000_hw *fpga = devpriv->daq;\r\nint timeout;\r\nfor (i = 0; i < insn->n; i++) {\r\nfpga->dacSetting[chan] = data[i];\r\nfor (timeout = 0; timeout < 20; timeout++) {\r\nif ((fpga->dacControl & ((chan + 1) * 0x0010)) == 0) {\r\nbreak;\r\n}\r\n}\r\ndevpriv->ao_readback[chan] = data[i];\r\n}\r\nreturn i;\r\n}\r\nstatic void daqboard2000_resetLocalBus(struct comedi_device *dev)\r\n{\r\nprintk("daqboard2000_resetLocalBus\n");\r\nwritel(DAQBOARD2000_SECRLocalBusHi, devpriv->plx + 0x6c);\r\nudelay(10000);\r\nwritel(DAQBOARD2000_SECRLocalBusLo, devpriv->plx + 0x6c);\r\nudelay(10000);\r\n}\r\nstatic void daqboard2000_reloadPLX(struct comedi_device *dev)\r\n{\r\nprintk("daqboard2000_reloadPLX\n");\r\nwritel(DAQBOARD2000_SECRReloadLo, devpriv->plx + 0x6c);\r\nudelay(10000);\r\nwritel(DAQBOARD2000_SECRReloadHi, devpriv->plx + 0x6c);\r\nudelay(10000);\r\nwritel(DAQBOARD2000_SECRReloadLo, devpriv->plx + 0x6c);\r\nudelay(10000);\r\n}\r\nstatic void daqboard2000_pulseProgPin(struct comedi_device *dev)\r\n{\r\nprintk("daqboard2000_pulseProgPin 1\n");\r\nwritel(DAQBOARD2000_SECRProgPinHi, devpriv->plx + 0x6c);\r\nudelay(10000);\r\nwritel(DAQBOARD2000_SECRProgPinLo, devpriv->plx + 0x6c);\r\nudelay(10000);\r\n}\r\nstatic int daqboard2000_pollCPLD(struct comedi_device *dev, int mask)\r\n{\r\nint result = 0;\r\nint i;\r\nint cpld;\r\nfor (i = 0; i < 50; i++) {\r\ncpld = readw(devpriv->daq + 0x1000);\r\nif ((cpld & mask) == mask) {\r\nresult = 1;\r\nbreak;\r\n}\r\nudelay(100);\r\n}\r\nudelay(5);\r\nreturn result;\r\n}\r\nstatic int daqboard2000_writeCPLD(struct comedi_device *dev, int data)\r\n{\r\nint result = 0;\r\nudelay(10);\r\nwritew(data, devpriv->daq + 0x1000);\r\nif ((readw(devpriv->daq + 0x1000) & DAQBOARD2000_CPLD_INIT) ==\r\nDAQBOARD2000_CPLD_INIT) {\r\nresult = 1;\r\n}\r\nreturn result;\r\n}\r\nstatic int initialize_daqboard2000(struct comedi_device *dev,\r\nunsigned char *cpld_array, int len)\r\n{\r\nint result = -EIO;\r\nint secr;\r\nint retry;\r\nint i;\r\nsecr = readl(devpriv->plx + 0x6c);\r\nif (!(secr & DAQBOARD2000_EEPROM_PRESENT)) {\r\n#ifdef DEBUG_EEPROM\r\nprintk("no serial eeprom\n");\r\n#endif\r\nreturn -EIO;\r\n}\r\nfor (retry = 0; retry < 3; retry++) {\r\n#ifdef DEBUG_EEPROM\r\nprintk("Programming EEPROM try %x\n", retry);\r\n#endif\r\ndaqboard2000_resetLocalBus(dev);\r\ndaqboard2000_reloadPLX(dev);\r\ndaqboard2000_pulseProgPin(dev);\r\nif (daqboard2000_pollCPLD(dev, DAQBOARD2000_CPLD_INIT)) {\r\nfor (i = 0; i < len; i++) {\r\nif (cpld_array[i] == 0xff\r\n&& cpld_array[i + 1] == 0x20) {\r\n#ifdef DEBUG_EEPROM\r\nprintk("Preamble found at %d\n", i);\r\n#endif\r\nbreak;\r\n}\r\n}\r\nfor (; i < len; i += 2) {\r\nint data =\r\n(cpld_array[i] << 8) + cpld_array[i + 1];\r\nif (!daqboard2000_writeCPLD(dev, data)) {\r\nbreak;\r\n}\r\n}\r\nif (i >= len) {\r\n#ifdef DEBUG_EEPROM\r\nprintk("Programmed\n");\r\n#endif\r\ndaqboard2000_resetLocalBus(dev);\r\ndaqboard2000_reloadPLX(dev);\r\nresult = 0;\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn result;\r\n}\r\nstatic void daqboard2000_adcStopDmaTransfer(struct comedi_device *dev)\r\n{\r\n}\r\nstatic void daqboard2000_adcDisarm(struct comedi_device *dev)\r\n{\r\nstruct daqboard2000_hw *fpga = devpriv->daq;\r\nudelay(2);\r\nfpga->trigControl = DAQBOARD2000_TrigAnalog | DAQBOARD2000_TrigDisable;\r\nudelay(2);\r\nfpga->trigControl = DAQBOARD2000_TrigTTL | DAQBOARD2000_TrigDisable;\r\nudelay(2);\r\nfpga->acqControl = DAQBOARD2000_SeqStopScanList;\r\nudelay(2);\r\nfpga->acqControl = DAQBOARD2000_AdcPacerDisable;\r\ndaqboard2000_adcStopDmaTransfer(dev);\r\n}\r\nstatic void daqboard2000_activateReferenceDacs(struct comedi_device *dev)\r\n{\r\nstruct daqboard2000_hw *fpga = devpriv->daq;\r\nint timeout;\r\nfpga->refDacs = 0x80 | DAQBOARD2000_PosRefDacSelect;\r\nfor (timeout = 0; timeout < 20; timeout++) {\r\nif ((fpga->dacControl & DAQBOARD2000_RefBusy) == 0) {\r\nbreak;\r\n}\r\nudelay(2);\r\n}\r\nfpga->refDacs = 0x80 | DAQBOARD2000_NegRefDacSelect;\r\nfor (timeout = 0; timeout < 20; timeout++) {\r\nif ((fpga->dacControl & DAQBOARD2000_RefBusy) == 0) {\r\nbreak;\r\n}\r\nudelay(2);\r\n}\r\n}\r\nstatic void daqboard2000_initializeCtrs(struct comedi_device *dev)\r\n{\r\n}\r\nstatic void daqboard2000_initializeTmrs(struct comedi_device *dev)\r\n{\r\n}\r\nstatic void daqboard2000_dacDisarm(struct comedi_device *dev)\r\n{\r\n}\r\nstatic void daqboard2000_initializeAdc(struct comedi_device *dev)\r\n{\r\ndaqboard2000_adcDisarm(dev);\r\ndaqboard2000_activateReferenceDacs(dev);\r\ndaqboard2000_initializeCtrs(dev);\r\ndaqboard2000_initializeTmrs(dev);\r\n}\r\nstatic void daqboard2000_initializeDac(struct comedi_device *dev)\r\n{\r\ndaqboard2000_dacDisarm(dev);\r\n}\r\nstatic int daqboard2000_8255_cb(int dir, int port, int data,\r\nunsigned long ioaddr)\r\n{\r\nint result = 0;\r\nif (dir) {\r\nwritew(data, ((void *)ioaddr) + port * 2);\r\nresult = 0;\r\n} else {\r\nresult = readw(((void *)ioaddr) + port * 2);\r\n}\r\nreturn result;\r\n}\r\nstatic int daqboard2000_attach(struct comedi_device *dev,\r\nstruct comedi_devconfig *it)\r\n{\r\nint result = 0;\r\nstruct comedi_subdevice *s;\r\nstruct pci_dev *card = NULL;\r\nvoid *aux_data;\r\nunsigned int aux_len;\r\nint bus, slot;\r\nprintk("comedi%d: daqboard2000:", dev->minor);\r\nbus = it->options[0];\r\nslot = it->options[1];\r\nresult = alloc_private(dev, sizeof(struct daqboard2000_private));\r\nif (result < 0) {\r\nreturn -ENOMEM;\r\n}\r\nfor (card = pci_get_device(0x1616, 0x0409, NULL);\r\ncard != NULL; card = pci_get_device(0x1616, 0x0409, card)) {\r\nif (bus || slot) {\r\nif (card->bus->number != bus ||\r\nPCI_SLOT(card->devfn) != slot) {\r\ncontinue;\r\n}\r\n}\r\nbreak;\r\n}\r\nif (!card) {\r\nif (bus || slot)\r\nprintk(" no daqboard2000 found at bus/slot: %d/%d\n",\r\nbus, slot);\r\nelse\r\nprintk(" no daqboard2000 found\n");\r\nreturn -EIO;\r\n} else {\r\nu32 id;\r\nint i;\r\ndevpriv->pci_dev = card;\r\nid = ((u32) card->\r\nsubsystem_device << 16) | card->subsystem_vendor;\r\nfor (i = 0; i < n_boardtypes; i++) {\r\nif (boardtypes[i].id == id) {\r\nprintk(" %s", boardtypes[i].name);\r\ndev->board_ptr = boardtypes + i;\r\n}\r\n}\r\nif (!dev->board_ptr) {\r\nprintk\r\n(" unknown subsystem id %08x (pretend it is an ids2)",\r\nid);\r\ndev->board_ptr = boardtypes;\r\n}\r\n}\r\nresult = comedi_pci_enable(card, "daqboard2000");\r\nif (result < 0) {\r\nprintk(" failed to enable PCI device and request regions\n");\r\nreturn -EIO;\r\n}\r\ndevpriv->got_regions = 1;\r\ndevpriv->plx =\r\nioremap(pci_resource_start(card, 0), DAQBOARD2000_PLX_SIZE);\r\ndevpriv->daq =\r\nioremap(pci_resource_start(card, 2), DAQBOARD2000_DAQ_SIZE);\r\nif (!devpriv->plx || !devpriv->daq) {\r\nreturn -ENOMEM;\r\n}\r\nresult = alloc_subdevices(dev, 3);\r\nif (result < 0)\r\ngoto out;\r\nreadl(devpriv->plx + 0x6c);\r\naux_data = comedi_aux_data(it->options, 0);\r\naux_len = it->options[COMEDI_DEVCONF_AUX_DATA_LENGTH];\r\nif (aux_data && aux_len) {\r\nresult = initialize_daqboard2000(dev, aux_data, aux_len);\r\n} else {\r\nprintk("no FPGA initialization code, aborting\n");\r\nresult = -EIO;\r\n}\r\nif (result < 0)\r\ngoto out;\r\ndaqboard2000_initializeAdc(dev);\r\ndaqboard2000_initializeDac(dev);\r\ndev->iobase = (unsigned long)devpriv->daq;\r\ndev->board_name = this_board->name;\r\ns = dev->subdevices + 0;\r\ns->type = COMEDI_SUBD_AI;\r\ns->subdev_flags = SDF_READABLE | SDF_GROUND;\r\ns->n_chan = 24;\r\ns->maxdata = 0xffff;\r\ns->insn_read = daqboard2000_ai_insn_read;\r\ns->range_table = &range_daqboard2000_ai;\r\ns = dev->subdevices + 1;\r\ns->type = COMEDI_SUBD_AO;\r\ns->subdev_flags = SDF_WRITABLE;\r\ns->n_chan = 2;\r\ns->maxdata = 0xffff;\r\ns->insn_read = daqboard2000_ao_insn_read;\r\ns->insn_write = daqboard2000_ao_insn_write;\r\ns->range_table = &range_daqboard2000_ao;\r\ns = dev->subdevices + 2;\r\nresult = subdev_8255_init(dev, s, daqboard2000_8255_cb,\r\n(unsigned long)(dev->iobase + 0x40));\r\nprintk("\n");\r\nout:\r\nreturn result;\r\n}\r\nstatic int daqboard2000_detach(struct comedi_device *dev)\r\n{\r\nprintk("comedi%d: daqboard2000: remove\n", dev->minor);\r\nif (dev->subdevices)\r\nsubdev_8255_cleanup(dev, dev->subdevices + 2);\r\nif (dev->irq) {\r\nfree_irq(dev->irq, dev);\r\n}\r\nif (devpriv) {\r\nif (devpriv->daq)\r\niounmap(devpriv->daq);\r\nif (devpriv->plx)\r\niounmap(devpriv->plx);\r\nif (devpriv->pci_dev) {\r\nif (devpriv->got_regions) {\r\ncomedi_pci_disable(devpriv->pci_dev);\r\n}\r\npci_dev_put(devpriv->pci_dev);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devinit driver_daqboard2000_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id\r\n*ent)\r\n{\r\nreturn comedi_pci_auto_config(dev, driver_daqboard2000.driver_name);\r\n}\r\nstatic void __devexit driver_daqboard2000_pci_remove(struct pci_dev *dev)\r\n{\r\ncomedi_pci_auto_unconfig(dev);\r\n}\r\nstatic int __init driver_daqboard2000_init_module(void)\r\n{\r\nint retval;\r\nretval = comedi_driver_register(&driver_daqboard2000);\r\nif (retval < 0)\r\nreturn retval;\r\ndriver_daqboard2000_pci_driver.name =\r\n(char *)driver_daqboard2000.driver_name;\r\nreturn pci_register_driver(&driver_daqboard2000_pci_driver);\r\n}\r\nstatic void __exit driver_daqboard2000_cleanup_module(void)\r\n{\r\npci_unregister_driver(&driver_daqboard2000_pci_driver);\r\ncomedi_driver_unregister(&driver_daqboard2000);\r\n}

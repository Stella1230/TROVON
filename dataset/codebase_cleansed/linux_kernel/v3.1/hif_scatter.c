static void FreeScatterReq(struct hif_device *device, struct hif_scatter_req *pReq)\r\n{\r\nunsigned long flag;\r\nspin_lock_irqsave(&device->lock, flag);\r\nDL_ListInsertTail(&device->ScatterReqHead, &pReq->ListLink);\r\nspin_unlock_irqrestore(&device->lock, flag);\r\n}\r\nstatic struct hif_scatter_req *AllocScatterReq(struct hif_device *device)\r\n{\r\nstruct dl_list *pItem;\r\nunsigned long flag;\r\nspin_lock_irqsave(&device->lock, flag);\r\npItem = DL_ListRemoveItemFromHead(&device->ScatterReqHead);\r\nspin_unlock_irqrestore(&device->lock, flag);\r\nif (pItem != NULL) {\r\nreturn A_CONTAINING_STRUCT(pItem, struct hif_scatter_req, ListLink);\r\n}\r\nreturn NULL;\r\n}\r\nint DoHifReadWriteScatter(struct hif_device *device, BUS_REQUEST *busrequest)\r\n{\r\nint i;\r\nu8 rw;\r\nu8 opcode;\r\nstruct mmc_request mmcreq;\r\nstruct mmc_command cmd;\r\nstruct mmc_data data;\r\nstruct hif_scatter_req_priv *pReqPriv;\r\nstruct hif_scatter_req *pReq;\r\nint status = 0;\r\nstruct scatterlist *pSg;\r\npReqPriv = busrequest->pScatterReq;\r\nA_ASSERT(pReqPriv != NULL);\r\npReq = pReqPriv->pHifScatterReq;\r\nmemset(&mmcreq, 0, sizeof(struct mmc_request));\r\nmemset(&cmd, 0, sizeof(struct mmc_command));\r\nmemset(&data, 0, sizeof(struct mmc_data));\r\ndata.blksz = HIF_MBOX_BLOCK_SIZE;\r\ndata.blocks = pReq->TotalLength / HIF_MBOX_BLOCK_SIZE;\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SCATTER, ("HIF-SCATTER: (%s) Address: 0x%X, (BlockLen: %d, BlockCount: %d) , (tot:%d,sg:%d)\n",\r\n(pReq->Request & HIF_WRITE) ? "WRITE":"READ", pReq->Address, data.blksz, data.blocks,\r\npReq->TotalLength,pReq->ValidScatterEntries));\r\nif (pReq->Request & HIF_WRITE) {\r\nrw = _CMD53_ARG_WRITE;\r\ndata.flags = MMC_DATA_WRITE;\r\n} else {\r\nrw = _CMD53_ARG_READ;\r\ndata.flags = MMC_DATA_READ;\r\n}\r\nif (pReq->Request & HIF_FIXED_ADDRESS) {\r\nopcode = _CMD53_ARG_FIXED_ADDRESS;\r\n} else {\r\nopcode = _CMD53_ARG_INCR_ADDRESS;\r\n}\r\npSg = pReqPriv->sgentries;\r\nsg_init_table(pSg, pReq->ValidScatterEntries);\r\nfor (i = 0 ; i < pReq->ValidScatterEntries ; i++, pSg++) {\r\nif ((unsigned long)pReq->ScatterList[i].pBuffer & 0x3) {\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SCATTER,\r\n("HIF: (%s) Scatter Buffer is unaligned 0x%lx\n",\r\npReq->Request & HIF_WRITE ? "WRITE":"READ",\r\n(unsigned long)pReq->ScatterList[i].pBuffer));\r\n}\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SCATTER, (" %d: Addr:0x%lX, Len:%d \n",\r\ni,(unsigned long)pReq->ScatterList[i].pBuffer,pReq->ScatterList[i].Length));\r\nsg_set_buf(pSg, pReq->ScatterList[i].pBuffer, pReq->ScatterList[i].Length);\r\n}\r\ndata.sg = pReqPriv->sgentries;\r\ndata.sg_len = pReq->ValidScatterEntries;\r\nSDIO_SET_CMD53_ARG(cmd.arg,\r\nrw,\r\ndevice->func->num,\r\n_CMD53_ARG_BLOCK_BASIS,\r\nopcode,\r\npReq->Address,\r\ndata.blocks);\r\ncmd.opcode = SD_IO_RW_EXTENDED;\r\ncmd.flags = MMC_RSP_SPI_R5 | MMC_RSP_R5 | MMC_CMD_ADTC;\r\nmmcreq.cmd = &cmd;\r\nmmcreq.data = &data;\r\nmmc_set_data_timeout(&data, device->func->card);\r\nmmc_wait_for_req(device->func->card->host, &mmcreq);\r\nif (cmd.error) {\r\nstatus = A_ERROR;\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ERROR, ("HIF-SCATTER: cmd error: %d \n",cmd.error));\r\n}\r\nif (data.error) {\r\nstatus = A_ERROR;\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ERROR, ("HIF-SCATTER: data error: %d \n",data.error));\r\n}\r\nif (status) {\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ERROR, ("HIF-SCATTER: FAILED!!! (%s) Address: 0x%X, Block mode (BlockLen: %d, BlockCount: %d)\n",\r\n(pReq->Request & HIF_WRITE) ? "WRITE":"READ",pReq->Address, data.blksz, data.blocks));\r\n}\r\npReq->CompletionStatus = status;\r\nif (pReq->Request & HIF_ASYNCHRONOUS) {\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SCATTER, ("HIF-SCATTER: async_task completion routine req: 0x%lX (%d)\n",(unsigned long)busrequest, status));\r\nA_ASSERT(pReq->CompletionRoutine != NULL);\r\npReq->CompletionRoutine(pReq);\r\n} else {\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SCATTER, ("HIF-SCATTER async_task upping busrequest : 0x%lX (%d)\n", (unsigned long)busrequest,status));\r\nup(&busrequest->sem_req);\r\n}\r\nreturn status;\r\n}\r\nstatic int HifReadWriteScatter(struct hif_device *device, struct hif_scatter_req *pReq)\r\n{\r\nint status = A_EINVAL;\r\nu32 request = pReq->Request;\r\nstruct hif_scatter_req_priv *pReqPriv = (struct hif_scatter_req_priv *)pReq->HIFPrivate[0];\r\ndo {\r\nA_ASSERT(pReqPriv != NULL);\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SCATTER, ("HIF-SCATTER: total len: %d Scatter Entries: %d\n",\r\npReq->TotalLength, pReq->ValidScatterEntries));\r\nif (!(request & HIF_EXTENDED_IO)) {\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ERROR,\r\n("HIF-SCATTER: Invalid command type: 0x%08x\n", request));\r\nbreak;\r\n}\r\nif (!(request & (HIF_SYNCHRONOUS | HIF_ASYNCHRONOUS))) {\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ERROR,\r\n("HIF-SCATTER: Invalid execution mode: 0x%08x\n", request));\r\nbreak;\r\n}\r\nif (!(request & HIF_BLOCK_BASIS)) {\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ERROR,\r\n("HIF-SCATTER: Invalid data mode: 0x%08x\n", request));\r\nbreak;\r\n}\r\nif (pReq->TotalLength > MAX_SCATTER_REQ_TRANSFER_SIZE) {\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ERROR,\r\n("HIF-SCATTER: Invalid length: %d \n", pReq->TotalLength));\r\nbreak;\r\n}\r\nif (pReq->TotalLength == 0) {\r\nA_ASSERT(false);\r\nbreak;\r\n}\r\nAddToAsyncList(device, pReqPriv->busrequest);\r\nif (request & HIF_SYNCHRONOUS) {\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SCATTER, ("HIF-SCATTER: queued sync req: 0x%lX\n", (unsigned long)pReqPriv->busrequest));\r\nup(&device->sem_async);\r\nif (down_interruptible(&pReqPriv->busrequest->sem_req) != 0) {\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ERROR,("HIF-SCATTER: interrupted! \n"));\r\nstatus = A_ERROR;\r\nbreak;\r\n} else {\r\nstatus = pReq->CompletionStatus;\r\n}\r\n} else {\r\nAR_DEBUG_PRINTF(ATH_DEBUG_SCATTER, ("HIF-SCATTER: queued async req: 0x%lX\n", (unsigned long)pReqPriv->busrequest));\r\nup(&device->sem_async);\r\nstatus = 0;\r\n}\r\n} while (false);\r\nif (status && (request & HIF_ASYNCHRONOUS)) {\r\npReq->CompletionStatus = status;\r\npReq->CompletionRoutine(pReq);\r\nstatus = 0;\r\n}\r\nreturn status;\r\n}\r\nint SetupHIFScatterSupport(struct hif_device *device, struct hif_device_scatter_support_info *pInfo)\r\n{\r\nint status = A_ERROR;\r\nint i;\r\nstruct hif_scatter_req_priv *pReqPriv;\r\nBUS_REQUEST *busrequest;\r\ndo {\r\nif (device->func->card->host->max_segs < MAX_SCATTER_ENTRIES_PER_REQ) {\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ERR,("HIF-SCATTER : host only supports scatter of : %d entries, need: %d \n",\r\ndevice->func->card->host->max_segs, MAX_SCATTER_ENTRIES_PER_REQ));\r\nstatus = A_ENOTSUP;\r\nbreak;\r\n}\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ANY,("HIF-SCATTER Enabled: max scatter req : %d entries: %d \n",\r\nMAX_SCATTER_REQUESTS, MAX_SCATTER_ENTRIES_PER_REQ));\r\nfor (i = 0; i < MAX_SCATTER_REQUESTS; i++) {\r\npReqPriv = (struct hif_scatter_req_priv *)A_MALLOC(sizeof(struct hif_scatter_req_priv));\r\nif (NULL == pReqPriv) {\r\nbreak;\r\n}\r\nA_MEMZERO(pReqPriv, sizeof(struct hif_scatter_req_priv));\r\npReqPriv->device = device;\r\npReqPriv->pHifScatterReq = (struct hif_scatter_req *)A_MALLOC(sizeof(struct hif_scatter_req) +\r\n(MAX_SCATTER_ENTRIES_PER_REQ - 1) * (sizeof(struct hif_scatter_item)));\r\nif (NULL == pReqPriv->pHifScatterReq) {\r\nkfree(pReqPriv);\r\nbreak;\r\n}\r\nA_MEMZERO(pReqPriv->pHifScatterReq, sizeof(struct hif_scatter_req));\r\npReqPriv->pHifScatterReq->HIFPrivate[0] = pReqPriv;\r\nbusrequest = hifAllocateBusRequest(device);\r\nif (NULL == busrequest) {\r\nkfree(pReqPriv->pHifScatterReq);\r\nkfree(pReqPriv);\r\nbreak;\r\n}\r\nbusrequest->pScatterReq = pReqPriv;\r\npReqPriv->busrequest = busrequest;\r\nFreeScatterReq(device,pReqPriv->pHifScatterReq);\r\n}\r\nif (i != MAX_SCATTER_REQUESTS) {\r\nstatus = A_NO_MEMORY;\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ERR,("HIF-SCATTER : failed to alloc scatter resources !\n"));\r\nbreak;\r\n}\r\npInfo->pAllocateReqFunc = AllocScatterReq;\r\npInfo->pFreeReqFunc = FreeScatterReq;\r\npInfo->pReadWriteScatterFunc = HifReadWriteScatter;\r\npInfo->MaxScatterEntries = MAX_SCATTER_ENTRIES_PER_REQ;\r\npInfo->MaxTransferSizePerScatterReq = MAX_SCATTER_REQ_TRANSFER_SIZE;\r\nstatus = 0;\r\n} while (false);\r\nif (status) {\r\nCleanupHIFScatterResources(device);\r\n}\r\nreturn status;\r\n}\r\nvoid CleanupHIFScatterResources(struct hif_device *device)\r\n{\r\nstruct hif_scatter_req_priv *pReqPriv;\r\nstruct hif_scatter_req *pReq;\r\nwhile (1) {\r\npReq = AllocScatterReq(device);\r\nif (NULL == pReq) {\r\nbreak;\r\n}\r\npReqPriv = (struct hif_scatter_req_priv *)pReq->HIFPrivate[0];\r\nA_ASSERT(pReqPriv != NULL);\r\nif (pReqPriv->busrequest != NULL) {\r\npReqPriv->busrequest->pScatterReq = NULL;\r\nhifFreeBusRequest(device, pReqPriv->busrequest);\r\npReqPriv->busrequest = NULL;\r\n}\r\nif (pReqPriv->pHifScatterReq != NULL) {\r\nkfree(pReqPriv->pHifScatterReq);\r\npReqPriv->pHifScatterReq = NULL;\r\n}\r\nkfree(pReqPriv);\r\n}\r\n}

static int cfag12864bfb_mmap(struct fb_info *info, struct vm_area_struct *vma)\r\n{\r\nreturn vm_insert_page(vma, vma->vm_start,\r\nvirt_to_page(cfag12864b_buffer));\r\n}\r\nstatic int __devinit cfag12864bfb_probe(struct platform_device *device)\r\n{\r\nint ret = -EINVAL;\r\nstruct fb_info *info = framebuffer_alloc(0, &device->dev);\r\nif (!info)\r\ngoto none;\r\ninfo->screen_base = (char __iomem *) cfag12864b_buffer;\r\ninfo->screen_size = CFAG12864B_SIZE;\r\ninfo->fbops = &cfag12864bfb_ops;\r\ninfo->fix = cfag12864bfb_fix;\r\ninfo->var = cfag12864bfb_var;\r\ninfo->pseudo_palette = NULL;\r\ninfo->par = NULL;\r\ninfo->flags = FBINFO_FLAG_DEFAULT;\r\nif (register_framebuffer(info) < 0)\r\ngoto fballoced;\r\nplatform_set_drvdata(device, info);\r\nprintk(KERN_INFO "fb%d: %s frame buffer device\n", info->node,\r\ninfo->fix.id);\r\nreturn 0;\r\nfballoced:\r\nframebuffer_release(info);\r\nnone:\r\nreturn ret;\r\n}\r\nstatic int __devexit cfag12864bfb_remove(struct platform_device *device)\r\n{\r\nstruct fb_info *info = platform_get_drvdata(device);\r\nif (info) {\r\nunregister_framebuffer(info);\r\nframebuffer_release(info);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init cfag12864bfb_init(void)\r\n{\r\nint ret = -EINVAL;\r\nif (!cfag12864b_isinited()) {\r\nprintk(KERN_ERR CFAG12864BFB_NAME ": ERROR: "\r\n"cfag12864b is not initialized\n");\r\ngoto none;\r\n}\r\nif (cfag12864b_enable()) {\r\nprintk(KERN_ERR CFAG12864BFB_NAME ": ERROR: "\r\n"can't enable cfag12864b refreshing (being used)\n");\r\nreturn -ENODEV;\r\n}\r\nret = platform_driver_register(&cfag12864bfb_driver);\r\nif (!ret) {\r\ncfag12864bfb_device =\r\nplatform_device_alloc(CFAG12864BFB_NAME, 0);\r\nif (cfag12864bfb_device)\r\nret = platform_device_add(cfag12864bfb_device);\r\nelse\r\nret = -ENOMEM;\r\nif (ret) {\r\nplatform_device_put(cfag12864bfb_device);\r\nplatform_driver_unregister(&cfag12864bfb_driver);\r\n}\r\n}\r\nnone:\r\nreturn ret;\r\n}\r\nstatic void __exit cfag12864bfb_exit(void)\r\n{\r\nplatform_device_unregister(cfag12864bfb_device);\r\nplatform_driver_unregister(&cfag12864bfb_driver);\r\ncfag12864b_disable();\r\n}

struct device_node *scom_find_parent(struct device_node *node)\r\n{\r\nstruct device_node *par, *tmp;\r\nconst u32 *p;\r\nfor (par = of_node_get(node); par;) {\r\nif (of_get_property(par, "scom-controller", NULL))\r\nbreak;\r\np = of_get_property(par, "scom-parent", NULL);\r\ntmp = par;\r\nif (p == NULL)\r\npar = of_get_parent(par);\r\nelse\r\npar = of_find_node_by_phandle(*p);\r\nof_node_put(tmp);\r\n}\r\nreturn par;\r\n}\r\nscom_map_t scom_map_device(struct device_node *dev, int index)\r\n{\r\nstruct device_node *parent;\r\nunsigned int cells, size;\r\nconst u32 *prop;\r\nu64 reg, cnt;\r\nscom_map_t ret;\r\nparent = scom_find_parent(dev);\r\nif (parent == NULL)\r\nreturn 0;\r\nprop = of_get_property(parent, "#scom-cells", NULL);\r\ncells = prop ? *prop : 1;\r\nprop = of_get_property(dev, "scom-reg", &size);\r\nif (!prop)\r\nreturn 0;\r\nsize >>= 2;\r\nif (index >= (size / (2*cells)))\r\nreturn 0;\r\nreg = of_read_number(&prop[index * cells * 2], cells);\r\ncnt = of_read_number(&prop[index * cells * 2 + cells], cells);\r\nret = scom_map(parent, reg, cnt);\r\nof_node_put(parent);\r\nreturn ret;\r\n}\r\nstatic int scom_addr_set(void *data, u64 val)\r\n{\r\nstruct scom_debug_entry *ent = data;\r\nent->addr = 0;\r\nscom_unmap(ent->map);\r\nent->map = scom_map(ent->dn, val, 1);\r\nif (scom_map_ok(ent->map))\r\nent->addr = val;\r\nelse\r\nreturn -EFAULT;\r\nreturn 0;\r\n}\r\nstatic int scom_addr_get(void *data, u64 *val)\r\n{\r\nstruct scom_debug_entry *ent = data;\r\n*val = ent->addr;\r\nreturn 0;\r\n}\r\nstatic int scom_val_set(void *data, u64 val)\r\n{\r\nstruct scom_debug_entry *ent = data;\r\nif (!scom_map_ok(ent->map))\r\nreturn -EFAULT;\r\nscom_write(ent->map, 0, val);\r\nreturn 0;\r\n}\r\nstatic int scom_val_get(void *data, u64 *val)\r\n{\r\nstruct scom_debug_entry *ent = data;\r\nif (!scom_map_ok(ent->map))\r\nreturn -EFAULT;\r\n*val = scom_read(ent->map, 0);\r\nreturn 0;\r\n}\r\nstatic int scom_debug_init_one(struct dentry *root, struct device_node *dn,\r\nint i)\r\n{\r\nstruct scom_debug_entry *ent;\r\nstruct dentry *dir;\r\nent = kzalloc(sizeof(*ent), GFP_KERNEL);\r\nif (!ent)\r\nreturn -ENOMEM;\r\nent->dn = of_node_get(dn);\r\nent->map = SCOM_MAP_INVALID;\r\nspin_lock_init(&ent->lock);\r\nsnprintf(ent->name, 8, "scom%d", i);\r\nent->blob.data = dn->full_name;\r\nent->blob.size = strlen(dn->full_name);\r\ndir = debugfs_create_dir(ent->name, root);\r\nif (!dir) {\r\nof_node_put(dn);\r\nkfree(ent);\r\nreturn -1;\r\n}\r\ndebugfs_create_file("addr", 0600, dir, ent, &scom_addr_fops);\r\ndebugfs_create_file("value", 0600, dir, ent, &scom_val_fops);\r\ndebugfs_create_blob("path", 0400, dir, &ent->blob);\r\nreturn 0;\r\n}\r\nstatic int scom_debug_init(void)\r\n{\r\nstruct device_node *dn;\r\nstruct dentry *root;\r\nint i, rc;\r\nroot = debugfs_create_dir("scom", powerpc_debugfs_root);\r\nif (!root)\r\nreturn -1;\r\ni = rc = 0;\r\nfor_each_node_with_property(dn, "scom-controller")\r\nrc |= scom_debug_init_one(root, dn, i++);\r\nreturn rc;\r\n}

static void hp6x0_apm_get_power_status(struct apm_power_info *info)\r\n{\r\nint battery, backup, charging, percentage;\r\nu8 pgdr;\r\nbattery = adc_single(ADC_CHANNEL_BATTERY);\r\nbackup = adc_single(ADC_CHANNEL_BACKUP);\r\ncharging = adc_single(ADC_CHANNEL_CHARGE);\r\npercentage = 100 * (battery - HP680_BATTERY_MIN) /\r\n(HP680_BATTERY_MAX - HP680_BATTERY_MIN);\r\ninfo->battery_life = percentage;\r\ninfo->units = 0;\r\ninfo->time = (2 * battery);\r\ninfo->ac_line_status = (battery > HP680_BATTERY_AC_ON) ?\r\nAPM_AC_ONLINE : APM_AC_OFFLINE;\r\npgdr = __raw_readb(PGDR);\r\nif (pgdr & PGDR_MAIN_BATTERY_OUT) {\r\ninfo->battery_status = APM_BATTERY_STATUS_NOT_PRESENT;\r\ninfo->battery_flag = 0x80;\r\n} else if (charging < 8) {\r\ninfo->battery_status = APM_BATTERY_STATUS_CHARGING;\r\ninfo->battery_flag = 0x08;\r\ninfo->ac_line_status = 0x01;\r\n} else if (percentage <= APM_CRITICAL) {\r\ninfo->battery_status = APM_BATTERY_STATUS_CRITICAL;\r\ninfo->battery_flag = 0x04;\r\n} else if (percentage <= APM_LOW) {\r\ninfo->battery_status = APM_BATTERY_STATUS_LOW;\r\ninfo->battery_flag = 0x02;\r\n} else {\r\ninfo->battery_status = APM_BATTERY_STATUS_HIGH;\r\ninfo->battery_flag = 0x01;\r\n}\r\n}\r\nstatic irqreturn_t hp6x0_apm_interrupt(int irq, void *dev)\r\n{\r\nif (!APM_DISABLED)\r\napm_queue_event(APM_USER_SUSPEND);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __init hp6x0_apm_init(void)\r\n{\r\nint ret;\r\nret = request_irq(HP680_BTN_IRQ, hp6x0_apm_interrupt,\r\nIRQF_DISABLED, MODNAME, NULL);\r\nif (unlikely(ret < 0)) {\r\nprintk(KERN_ERR MODNAME ": IRQ %d request failed\n",\r\nHP680_BTN_IRQ);\r\nreturn ret;\r\n}\r\napm_get_power_status = hp6x0_apm_get_power_status;\r\nreturn ret;\r\n}\r\nstatic void __exit hp6x0_apm_exit(void)\r\n{\r\nfree_irq(HP680_BTN_IRQ, 0);\r\n}

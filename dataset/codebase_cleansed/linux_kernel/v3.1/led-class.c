static void led_update_brightness(struct led_classdev *led_cdev)\r\n{\r\nif (led_cdev->brightness_get)\r\nled_cdev->brightness = led_cdev->brightness_get(led_cdev);\r\n}\r\nstatic ssize_t led_brightness_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nled_update_brightness(led_cdev);\r\nreturn sprintf(buf, "%u\n", led_cdev->brightness);\r\n}\r\nstatic ssize_t led_brightness_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t size)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nssize_t ret = -EINVAL;\r\nchar *after;\r\nunsigned long state = simple_strtoul(buf, &after, 10);\r\nsize_t count = after - buf;\r\nif (isspace(*after))\r\ncount++;\r\nif (count == size) {\r\nret = count;\r\nif (state == LED_OFF)\r\nled_trigger_remove(led_cdev);\r\nled_set_brightness(led_cdev, state);\r\n}\r\nreturn ret;\r\n}\r\nstatic ssize_t led_max_brightness_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%u\n", led_cdev->max_brightness);\r\n}\r\nstatic void led_timer_function(unsigned long data)\r\n{\r\nstruct led_classdev *led_cdev = (void *)data;\r\nunsigned long brightness;\r\nunsigned long delay;\r\nif (!led_cdev->blink_delay_on || !led_cdev->blink_delay_off) {\r\nled_set_brightness(led_cdev, LED_OFF);\r\nreturn;\r\n}\r\nbrightness = led_get_brightness(led_cdev);\r\nif (!brightness) {\r\nbrightness = led_cdev->blink_brightness;\r\ndelay = led_cdev->blink_delay_on;\r\n} else {\r\nled_cdev->blink_brightness = brightness;\r\nbrightness = LED_OFF;\r\ndelay = led_cdev->blink_delay_off;\r\n}\r\nled_set_brightness(led_cdev, brightness);\r\nmod_timer(&led_cdev->blink_timer, jiffies + msecs_to_jiffies(delay));\r\n}\r\nstatic void led_stop_software_blink(struct led_classdev *led_cdev)\r\n{\r\ndel_timer_sync(&led_cdev->blink_timer);\r\nled_cdev->blink_delay_on = 0;\r\nled_cdev->blink_delay_off = 0;\r\n}\r\nstatic void led_set_software_blink(struct led_classdev *led_cdev,\r\nunsigned long delay_on,\r\nunsigned long delay_off)\r\n{\r\nint current_brightness;\r\ncurrent_brightness = led_get_brightness(led_cdev);\r\nif (current_brightness)\r\nled_cdev->blink_brightness = current_brightness;\r\nif (!led_cdev->blink_brightness)\r\nled_cdev->blink_brightness = led_cdev->max_brightness;\r\nif (led_get_trigger_data(led_cdev) &&\r\ndelay_on == led_cdev->blink_delay_on &&\r\ndelay_off == led_cdev->blink_delay_off)\r\nreturn;\r\nled_stop_software_blink(led_cdev);\r\nled_cdev->blink_delay_on = delay_on;\r\nled_cdev->blink_delay_off = delay_off;\r\nif (!delay_on)\r\nreturn;\r\nif (!delay_off) {\r\nled_set_brightness(led_cdev, led_cdev->blink_brightness);\r\nreturn;\r\n}\r\nmod_timer(&led_cdev->blink_timer, jiffies + 1);\r\n}\r\nvoid led_classdev_suspend(struct led_classdev *led_cdev)\r\n{\r\nled_cdev->flags |= LED_SUSPENDED;\r\nled_cdev->brightness_set(led_cdev, 0);\r\n}\r\nvoid led_classdev_resume(struct led_classdev *led_cdev)\r\n{\r\nled_cdev->brightness_set(led_cdev, led_cdev->brightness);\r\nled_cdev->flags &= ~LED_SUSPENDED;\r\n}\r\nstatic int led_suspend(struct device *dev, pm_message_t state)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nif (led_cdev->flags & LED_CORE_SUSPENDRESUME)\r\nled_classdev_suspend(led_cdev);\r\nreturn 0;\r\n}\r\nstatic int led_resume(struct device *dev)\r\n{\r\nstruct led_classdev *led_cdev = dev_get_drvdata(dev);\r\nif (led_cdev->flags & LED_CORE_SUSPENDRESUME)\r\nled_classdev_resume(led_cdev);\r\nreturn 0;\r\n}\r\nint led_classdev_register(struct device *parent, struct led_classdev *led_cdev)\r\n{\r\nled_cdev->dev = device_create(leds_class, parent, 0, led_cdev,\r\n"%s", led_cdev->name);\r\nif (IS_ERR(led_cdev->dev))\r\nreturn PTR_ERR(led_cdev->dev);\r\n#ifdef CONFIG_LEDS_TRIGGERS\r\ninit_rwsem(&led_cdev->trigger_lock);\r\n#endif\r\ndown_write(&leds_list_lock);\r\nlist_add_tail(&led_cdev->node, &leds_list);\r\nup_write(&leds_list_lock);\r\nif (!led_cdev->max_brightness)\r\nled_cdev->max_brightness = LED_FULL;\r\nled_update_brightness(led_cdev);\r\ninit_timer(&led_cdev->blink_timer);\r\nled_cdev->blink_timer.function = led_timer_function;\r\nled_cdev->blink_timer.data = (unsigned long)led_cdev;\r\n#ifdef CONFIG_LEDS_TRIGGERS\r\nled_trigger_set_default(led_cdev);\r\n#endif\r\nprintk(KERN_DEBUG "Registered led device: %s\n",\r\nled_cdev->name);\r\nreturn 0;\r\n}\r\nvoid led_classdev_unregister(struct led_classdev *led_cdev)\r\n{\r\n#ifdef CONFIG_LEDS_TRIGGERS\r\ndown_write(&led_cdev->trigger_lock);\r\nif (led_cdev->trigger)\r\nled_trigger_set(led_cdev, NULL);\r\nup_write(&led_cdev->trigger_lock);\r\n#endif\r\nled_brightness_set(led_cdev, LED_OFF);\r\ndevice_unregister(led_cdev->dev);\r\ndown_write(&leds_list_lock);\r\nlist_del(&led_cdev->node);\r\nup_write(&leds_list_lock);\r\n}\r\nvoid led_blink_set(struct led_classdev *led_cdev,\r\nunsigned long *delay_on,\r\nunsigned long *delay_off)\r\n{\r\nif (led_cdev->blink_set &&\r\n!led_cdev->blink_set(led_cdev, delay_on, delay_off))\r\nreturn;\r\nif (!*delay_on && !*delay_off)\r\n*delay_on = *delay_off = 500;\r\nled_set_software_blink(led_cdev, *delay_on, *delay_off);\r\n}\r\nvoid led_brightness_set(struct led_classdev *led_cdev,\r\nenum led_brightness brightness)\r\n{\r\nled_stop_software_blink(led_cdev);\r\nled_cdev->brightness_set(led_cdev, brightness);\r\n}\r\nstatic int __init leds_init(void)\r\n{\r\nleds_class = class_create(THIS_MODULE, "leds");\r\nif (IS_ERR(leds_class))\r\nreturn PTR_ERR(leds_class);\r\nleds_class->suspend = led_suspend;\r\nleds_class->resume = led_resume;\r\nleds_class->dev_attrs = led_class_attrs;\r\nreturn 0;\r\n}\r\nstatic void __exit leds_exit(void)\r\n{\r\nclass_destroy(leds_class);\r\n}

void\r\nDot11d_Init(struct ieee80211_device *ieee)\r\n{\r\nPRT_DOT11D_INFO pDot11dInfo = GET_DOT11D_INFO(ieee);\r\npDot11dInfo->bEnabled = 0;\r\npDot11dInfo->State = DOT11D_STATE_NONE;\r\npDot11dInfo->CountryIeLen = 0;\r\nmemset(pDot11dInfo->channel_map, 0, MAX_CHANNEL_NUMBER+1);\r\nmemset(pDot11dInfo->MaxTxPwrDbmList, 0xFF, MAX_CHANNEL_NUMBER+1);\r\nRESET_CIE_WATCHDOG(ieee);\r\nprintk("Dot11d_Init()\n");\r\n}\r\nvoid\r\nDot11d_Reset(struct ieee80211_device *ieee)\r\n{\r\nu32 i;\r\nPRT_DOT11D_INFO pDot11dInfo = GET_DOT11D_INFO(ieee);\r\nmemset(pDot11dInfo->channel_map, 0, MAX_CHANNEL_NUMBER+1);\r\nmemset(pDot11dInfo->MaxTxPwrDbmList, 0xFF, MAX_CHANNEL_NUMBER+1);\r\nfor (i=1; i<=11; i++) {\r\n(pDot11dInfo->channel_map)[i] = 1;\r\n}\r\nfor (i=12; i<=14; i++) {\r\n(pDot11dInfo->channel_map)[i] = 2;\r\n}\r\npDot11dInfo->State = DOT11D_STATE_NONE;\r\npDot11dInfo->CountryIeLen = 0;\r\nRESET_CIE_WATCHDOG(ieee);\r\n}\r\nvoid\r\nDot11d_UpdateCountryIe(\r\nstruct ieee80211_device *dev,\r\nu8 * pTaddr,\r\nu16 CoutryIeLen,\r\nu8 * pCoutryIe\r\n)\r\n{\r\nPRT_DOT11D_INFO pDot11dInfo = GET_DOT11D_INFO(dev);\r\nu8 i, j, NumTriples, MaxChnlNum;\r\nPCHNL_TXPOWER_TRIPLE pTriple;\r\nmemset(pDot11dInfo->channel_map, 0, MAX_CHANNEL_NUMBER+1);\r\nmemset(pDot11dInfo->MaxTxPwrDbmList, 0xFF, MAX_CHANNEL_NUMBER+1);\r\nMaxChnlNum = 0;\r\nNumTriples = (CoutryIeLen - 3) / 3;\r\npTriple = (PCHNL_TXPOWER_TRIPLE)(pCoutryIe + 3);\r\nfor(i = 0; i < NumTriples; i++)\r\n{\r\nif(MaxChnlNum >= pTriple->FirstChnl)\r\n{\r\nprintk("Dot11d_UpdateCountryIe(): Invalid country IE, skip it........1\n");\r\nreturn;\r\n}\r\nif(MAX_CHANNEL_NUMBER < (pTriple->FirstChnl + pTriple->NumChnls))\r\n{\r\nprintk("Dot11d_UpdateCountryIe(): Invalid country IE, skip it........2\n");\r\nreturn;\r\n}\r\nfor(j = 0 ; j < pTriple->NumChnls; j++)\r\n{\r\npDot11dInfo->channel_map[pTriple->FirstChnl + j] = 1;\r\npDot11dInfo->MaxTxPwrDbmList[pTriple->FirstChnl + j] = pTriple->MaxTxPowerInDbm;\r\nMaxChnlNum = pTriple->FirstChnl + j;\r\n}\r\npTriple = (PCHNL_TXPOWER_TRIPLE)((u8*)pTriple + 3);\r\n}\r\nprintk("Channel List:");\r\nfor(i=1; i<= MAX_CHANNEL_NUMBER; i++)\r\nif(pDot11dInfo->channel_map[i] > 0)\r\nprintk(" %d", i);\r\nprintk("\n");\r\nUPDATE_CIE_SRC(dev, pTaddr);\r\npDot11dInfo->CountryIeLen = CoutryIeLen;\r\nmemcpy(pDot11dInfo->CountryIeBuf, pCoutryIe,CoutryIeLen);\r\npDot11dInfo->State = DOT11D_STATE_LEARNED;\r\n}\r\nu8\r\nDOT11D_GetMaxTxPwrInDbm(\r\nstruct ieee80211_device *dev,\r\nu8 Channel\r\n)\r\n{\r\nPRT_DOT11D_INFO pDot11dInfo = GET_DOT11D_INFO(dev);\r\nu8 MaxTxPwrInDbm = 255;\r\nif(MAX_CHANNEL_NUMBER < Channel)\r\n{\r\nprintk("DOT11D_GetMaxTxPwrInDbm(): Invalid Channel\n");\r\nreturn MaxTxPwrInDbm;\r\n}\r\nif(pDot11dInfo->channel_map[Channel])\r\n{\r\nMaxTxPwrInDbm = pDot11dInfo->MaxTxPwrDbmList[Channel];\r\n}\r\nreturn MaxTxPwrInDbm;\r\n}\r\nvoid\r\nDOT11D_ScanComplete(\r\nstruct ieee80211_device * dev\r\n)\r\n{\r\nPRT_DOT11D_INFO pDot11dInfo = GET_DOT11D_INFO(dev);\r\nswitch(pDot11dInfo->State)\r\n{\r\ncase DOT11D_STATE_LEARNED:\r\npDot11dInfo->State = DOT11D_STATE_DONE;\r\nbreak;\r\ncase DOT11D_STATE_DONE:\r\nif( GET_CIE_WATCHDOG(dev) == 0 )\r\n{\r\nDot11d_Reset(dev);\r\n}\r\nbreak;\r\ncase DOT11D_STATE_NONE:\r\nbreak;\r\n}\r\n}\r\nint IsLegalChannel(\r\nstruct ieee80211_device * dev,\r\nu8 channel\r\n)\r\n{\r\nPRT_DOT11D_INFO pDot11dInfo = GET_DOT11D_INFO(dev);\r\nif(MAX_CHANNEL_NUMBER < channel)\r\n{\r\nprintk("IsLegalChannel(): Invalid Channel\n");\r\nreturn 0;\r\n}\r\nif(pDot11dInfo->channel_map[channel] > 0)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nint ToLegalChannel(\r\nstruct ieee80211_device * dev,\r\nu8 channel\r\n)\r\n{\r\nPRT_DOT11D_INFO pDot11dInfo = GET_DOT11D_INFO(dev);\r\nu8 default_chn = 0;\r\nu32 i = 0;\r\nfor (i=1; i<= MAX_CHANNEL_NUMBER; i++)\r\n{\r\nif(pDot11dInfo->channel_map[i] > 0)\r\n{\r\ndefault_chn = i;\r\nbreak;\r\n}\r\n}\r\nif(MAX_CHANNEL_NUMBER < channel)\r\n{\r\nprintk("IsLegalChannel(): Invalid Channel\n");\r\nreturn default_chn;\r\n}\r\nif(pDot11dInfo->channel_map[channel] > 0)\r\nreturn channel;\r\nreturn default_chn;\r\n}

static int sc1200_clock(void)\r\n{\r\nu8 chip_id = inb(0x903C);\r\nu8 silicon_rev = inb(0x903D);\r\nu16 pci_clock;\r\nif (chip_id == 0x04 && silicon_rev < SC1200_REV_B1)\r\nreturn 0;\r\npci_clock = inw(0x901E);\r\npci_clock >>= 8;\r\npci_clock &= 0x03;\r\nif (pci_clock == 3)\r\npci_clock = 0;\r\nreturn pci_clock;\r\n}\r\nstatic void sc1200_set_piomode(struct ata_port *ap, struct ata_device *adev)\r\n{\r\nstatic const u32 pio_timings[4][5] = {\r\n{0x00009172, 0x00012171, 0x00020080, 0x00032010, 0x00040010},\r\n{0xd1329172, 0x71212171, 0x30200080, 0x20102010, 0x00100010},\r\n{0xfaa3f4f3, 0xc23232b2, 0x513101c1, 0x31213121, 0x10211021},\r\n{0xfff4fff4, 0xf35353d3, 0x814102f1, 0x42314231, 0x11311131}\r\n};\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nu32 format;\r\nunsigned int reg = 0x40 + 0x10 * ap->port_no;\r\nint mode = adev->pio_mode - XFER_PIO_0;\r\npci_read_config_dword(pdev, reg + 4, &format);\r\nformat >>= 31;\r\nformat += sc1200_clock();\r\npci_write_config_dword(pdev, reg + 8 * adev->devno,\r\npio_timings[format][mode]);\r\n}\r\nstatic void sc1200_set_dmamode(struct ata_port *ap, struct ata_device *adev)\r\n{\r\nstatic const u32 udma_timing[3][3] = {\r\n{ 0x00921250, 0x00911140, 0x00911030 },\r\n{ 0x00932470, 0x00922260, 0x00922140 },\r\n{ 0x009436A1, 0x00933481, 0x00923261 }\r\n};\r\nstatic const u32 mwdma_timing[3][3] = {\r\n{ 0x00077771, 0x00012121, 0x00002020 },\r\n{ 0x000BBBB2, 0x00024241, 0x00013131 },\r\n{ 0x000FFFF3, 0x00035352, 0x00015151 }\r\n};\r\nint clock = sc1200_clock();\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nunsigned int reg = 0x40 + 0x10 * ap->port_no;\r\nint mode = adev->dma_mode;\r\nu32 format;\r\nif (mode >= XFER_UDMA_0)\r\nformat = udma_timing[clock][mode - XFER_UDMA_0];\r\nelse\r\nformat = mwdma_timing[clock][mode - XFER_MW_DMA_0];\r\nif (adev->devno == 0) {\r\nu32 timings;\r\npci_read_config_dword(pdev, reg + 4, &timings);\r\ntimings &= 0x80000000UL;\r\ntimings |= format;\r\npci_write_config_dword(pdev, reg + 4, timings);\r\n} else\r\npci_write_config_dword(pdev, reg + 12, format);\r\n}\r\nstatic unsigned int sc1200_qc_issue(struct ata_queued_cmd *qc)\r\n{\r\nstruct ata_port *ap = qc->ap;\r\nstruct ata_device *adev = qc->dev;\r\nstruct ata_device *prev = ap->private_data;\r\nif (ata_dma_enabled(adev) && adev != prev && prev != NULL) {\r\nif ((ata_using_udma(adev) && !ata_using_udma(prev)) ||\r\n(ata_using_udma(prev) && !ata_using_udma(adev)))\r\nsc1200_set_dmamode(ap, adev);\r\n}\r\nreturn ata_bmdma_qc_issue(qc);\r\n}\r\nstatic int sc1200_qc_defer(struct ata_queued_cmd *qc)\r\n{\r\nstruct ata_host *host = qc->ap->host;\r\nstruct ata_port *alt = host->ports[1 ^ qc->ap->port_no];\r\nint rc;\r\nrc = ata_std_qc_defer(qc);\r\nif (rc != 0)\r\nreturn rc;\r\nif (alt && alt->qc_active)\r\nreturn ATA_DEFER_PORT;\r\nreturn 0;\r\n}\r\nstatic int sc1200_init_one(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nstatic const struct ata_port_info info = {\r\n.flags = ATA_FLAG_SLAVE_POSS,\r\n.pio_mask = ATA_PIO4,\r\n.mwdma_mask = ATA_MWDMA2,\r\n.udma_mask = ATA_UDMA2,\r\n.port_ops = &sc1200_port_ops\r\n};\r\nconst struct ata_port_info *ppi[] = { &info, NULL };\r\nreturn ata_pci_bmdma_init_one(dev, ppi, &sc1200_sht, NULL, 0);\r\n}\r\nstatic int __init sc1200_init(void)\r\n{\r\nreturn pci_register_driver(&sc1200_pci_driver);\r\n}\r\nstatic void __exit sc1200_exit(void)\r\n{\r\npci_unregister_driver(&sc1200_pci_driver);\r\n}

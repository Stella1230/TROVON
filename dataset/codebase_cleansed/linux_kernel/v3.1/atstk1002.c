static struct mtd_partition *nand_part_info(int size, int *num_partitions)\r\n{\r\n*num_partitions = ARRAY_SIZE(nand_partitions);\r\nreturn nand_partitions;\r\n}\r\nstatic int __init parse_tag_ethernet(struct tag *tag)\r\n{\r\nint i;\r\ni = tag->u.ethernet.mac_index;\r\nif (i < ARRAY_SIZE(hw_addr))\r\nmemcpy(hw_addr[i].addr, tag->u.ethernet.hw_address,\r\nsizeof(hw_addr[i].addr));\r\nreturn 0;\r\n}\r\nstatic void __init set_hw_addr(struct platform_device *pdev)\r\n{\r\nstruct resource *res = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nconst u8 *addr;\r\nvoid __iomem *regs;\r\nstruct clk *pclk;\r\nif (!res)\r\nreturn;\r\nif (pdev->id >= ARRAY_SIZE(hw_addr))\r\nreturn;\r\naddr = hw_addr[pdev->id].addr;\r\nif (!is_valid_ether_addr(addr))\r\nreturn;\r\nregs = (void __iomem __force *)res->start;\r\npclk = clk_get(&pdev->dev, "pclk");\r\nif (IS_ERR(pclk))\r\nreturn;\r\nclk_enable(pclk);\r\n__raw_writel((addr[3] << 24) | (addr[2] << 16)\r\n| (addr[1] << 8) | addr[0], regs + 0x98);\r\n__raw_writel((addr[5] << 8) | addr[4], regs + 0x9c);\r\nclk_disable(pclk);\r\nclk_put(pclk);\r\n}\r\nstatic void __init atstk1002_setup_extdac(void)\r\n{\r\nstruct clk *gclk;\r\nstruct clk *pll;\r\ngclk = clk_get(NULL, "gclk0");\r\nif (IS_ERR(gclk))\r\ngoto err_gclk;\r\npll = clk_get(NULL, "pll0");\r\nif (IS_ERR(pll))\r\ngoto err_pll;\r\nif (clk_set_parent(gclk, pll)) {\r\npr_debug("STK1000: failed to set pll0 as parent for DAC clock\n");\r\ngoto err_set_clk;\r\n}\r\nat32_select_periph(GPIO_PIOA_BASE, (1 << 30), GPIO_PERIPH_A, 0);\r\nat73c213_data.dac_clk = gclk;\r\nerr_set_clk:\r\nclk_put(pll);\r\nerr_pll:\r\nclk_put(gclk);\r\nerr_gclk:\r\nreturn;\r\n}\r\nstatic void __init atstk1002_setup_extdac(void)\r\n{\r\n}\r\nvoid __init setup_board(void)\r\n{\r\n#ifdef CONFIG_BOARD_ATSTK100X_SW2_CUSTOM\r\nat32_map_usart(0, 1, 0);\r\n#else\r\nat32_map_usart(1, 0, 0);\r\n#endif\r\nat32_map_usart(3, 2, 0);\r\nat32_setup_serial_console(0);\r\n}\r\nstatic int __init atstk1002_init(void)\r\n{\r\nat32_reserve_pin(GPIO_PIOE_BASE, ATMEL_EBI_PE_DATA_ALL);\r\n#ifdef CONFIG_BOARD_ATSTK1006\r\nsmc_set_timing(&nand_config, &nand_timing);\r\nsmc_set_configuration(3, &nand_config);\r\nat32_add_device_nand(0, &atstk1006_nand_data);\r\n#endif\r\n#ifdef CONFIG_BOARD_ATSTK100X_SW2_CUSTOM\r\nat32_add_device_usart(1);\r\n#else\r\nat32_add_device_usart(0);\r\n#endif\r\nat32_add_device_usart(2);\r\n#ifndef CONFIG_BOARD_ATSTK1002_SW6_CUSTOM\r\nset_hw_addr(at32_add_device_eth(0, &eth_data[0]));\r\n#endif\r\n#ifndef CONFIG_BOARD_ATSTK100X_SW1_CUSTOM\r\nat32_add_device_spi(0, spi0_board_info, ARRAY_SIZE(spi0_board_info));\r\n#endif\r\n#ifdef CONFIG_BOARD_ATSTK100X_SPI1\r\nat32_add_device_spi(1, spi1_board_info, ARRAY_SIZE(spi1_board_info));\r\n#endif\r\n#ifndef CONFIG_BOARD_ATSTK100X_SW2_CUSTOM\r\nat32_add_device_mci(0, &mci0_data);\r\n#endif\r\n#ifdef CONFIG_BOARD_ATSTK1002_SW5_CUSTOM\r\nset_hw_addr(at32_add_device_eth(1, &eth_data[1]));\r\n#else\r\nat32_add_device_lcdc(0, &atstk1000_lcdc_data,\r\nfbmem_start, fbmem_size,\r\nATMEL_LCDC_PRI_24BIT | ATMEL_LCDC_PRI_CONTROL);\r\n#endif\r\nat32_add_device_usba(0, NULL);\r\n#ifndef CONFIG_BOARD_ATSTK100X_SW3_CUSTOM\r\nat32_add_device_ssc(0, ATMEL_SSC_TX);\r\n#endif\r\natstk1000_setup_j2_leds();\r\natstk1002_setup_extdac();\r\nreturn 0;\r\n}

static u8 ReadByteFromHwPort(unsigned long addr)\r\n{\r\nu8 result = inb(addr);\r\nreturn result;\r\n}\r\nstatic void WriteByteToHwPort(unsigned long addr, u8 val)\r\n{\r\noutb_p(val, addr);\r\n}\r\nstatic void C6X_pwmInit(unsigned long baseAddr)\r\n{\r\nint timeout = 0;\r\nWriteByteToHwPort(baseAddr, 0x70);\r\nwhile (((ReadByteFromHwPort(baseAddr + 1) & 0x80) == 0)\r\n&& (timeout < C6XDIGIO_TIME_OUT)) {\r\ntimeout++;\r\n}\r\nWriteByteToHwPort(baseAddr, 0x74);\r\ntimeout = 0;\r\nwhile (((ReadByteFromHwPort(baseAddr + 1) & 0x80) == 0x80)\r\n&& (timeout < C6XDIGIO_TIME_OUT)) {\r\ntimeout++;\r\n}\r\nWriteByteToHwPort(baseAddr, 0x70);\r\ntimeout = 0;\r\nwhile (((ReadByteFromHwPort(baseAddr + 1) & 0x80) == 0x0)\r\n&& (timeout < C6XDIGIO_TIME_OUT)) {\r\ntimeout++;\r\n}\r\nWriteByteToHwPort(baseAddr, 0x0);\r\ntimeout = 0;\r\nwhile (((ReadByteFromHwPort(baseAddr + 1) & 0x80) == 0x80)\r\n&& (timeout < C6XDIGIO_TIME_OUT)) {\r\ntimeout++;\r\n}\r\n}\r\nstatic void C6X_pwmOutput(unsigned long baseAddr, unsigned channel, int value)\r\n{\r\nunsigned ppcmd;\r\nunion pwmcmdtype pwm;\r\nint timeout = 0;\r\nunsigned tmp;\r\npwm.cmd = value;\r\nif (pwm.cmd > 498)\r\npwm.cmd = 498;\r\nif (pwm.cmd < 2)\r\npwm.cmd = 2;\r\nif (channel == 0) {\r\nppcmd = 0x28;\r\n} else {\r\nppcmd = 0x30;\r\n}\r\nWriteByteToHwPort(baseAddr, ppcmd + pwm.bits.sb0);\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\nwhile (((tmp & 0x80) == 0) && (timeout < C6XDIGIO_TIME_OUT)) {\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\ntimeout++;\r\n}\r\nWriteByteToHwPort(baseAddr, ppcmd + pwm.bits.sb1 + 0x4);\r\ntimeout = 0;\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\nwhile (((tmp & 0x80) == 0x80) && (timeout < C6XDIGIO_TIME_OUT)) {\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\ntimeout++;\r\n}\r\nWriteByteToHwPort(baseAddr, ppcmd + pwm.bits.sb2);\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\nwhile (((tmp & 0x80) == 0) && (timeout < C6XDIGIO_TIME_OUT)) {\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\ntimeout++;\r\n}\r\nWriteByteToHwPort(baseAddr, ppcmd + pwm.bits.sb3 + 0x4);\r\ntimeout = 0;\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\nwhile (((tmp & 0x80) == 0x80) && (timeout < C6XDIGIO_TIME_OUT)) {\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\ntimeout++;\r\n}\r\nWriteByteToHwPort(baseAddr, ppcmd + pwm.bits.sb4);\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\nwhile (((tmp & 0x80) == 0) && (timeout < C6XDIGIO_TIME_OUT)) {\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\ntimeout++;\r\n}\r\nWriteByteToHwPort(baseAddr, 0x0);\r\ntimeout = 0;\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\nwhile (((tmp & 0x80) == 0x80) && (timeout < C6XDIGIO_TIME_OUT)) {\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\ntimeout++;\r\n}\r\n}\r\nstatic int C6X_encInput(unsigned long baseAddr, unsigned channel)\r\n{\r\nunsigned ppcmd;\r\nunion encvaluetype enc;\r\nint timeout = 0;\r\nint tmp;\r\nenc.value = 0;\r\nif (channel == 0)\r\nppcmd = 0x48;\r\nelse\r\nppcmd = 0x50;\r\nWriteByteToHwPort(baseAddr, ppcmd);\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\nwhile (((tmp & 0x80) == 0) && (timeout < C6XDIGIO_TIME_OUT)) {\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\ntimeout++;\r\n}\r\nenc.bits.sb0 = ((ReadByteFromHwPort(baseAddr + 1) >> 3) & 0x7);\r\nWriteByteToHwPort(baseAddr, ppcmd + 0x4);\r\ntimeout = 0;\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\nwhile (((tmp & 0x80) == 0x80) && (timeout < C6XDIGIO_TIME_OUT)) {\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\ntimeout++;\r\n}\r\nenc.bits.sb1 = ((ReadByteFromHwPort(baseAddr + 1) >> 3) & 0x7);\r\nWriteByteToHwPort(baseAddr, ppcmd);\r\ntimeout = 0;\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\nwhile (((tmp & 0x80) == 0) && (timeout < C6XDIGIO_TIME_OUT)) {\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\ntimeout++;\r\n}\r\nenc.bits.sb2 = ((ReadByteFromHwPort(baseAddr + 1) >> 3) & 0x7);\r\nWriteByteToHwPort(baseAddr, ppcmd + 0x4);\r\ntimeout = 0;\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\nwhile (((tmp & 0x80) == 0x80) && (timeout < C6XDIGIO_TIME_OUT)) {\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\ntimeout++;\r\n}\r\nenc.bits.sb3 = ((ReadByteFromHwPort(baseAddr + 1) >> 3) & 0x7);\r\nWriteByteToHwPort(baseAddr, ppcmd);\r\ntimeout = 0;\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\nwhile (((tmp & 0x80) == 0) && (timeout < C6XDIGIO_TIME_OUT)) {\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\ntimeout++;\r\n}\r\nenc.bits.sb4 = ((ReadByteFromHwPort(baseAddr + 1) >> 3) & 0x7);\r\nWriteByteToHwPort(baseAddr, ppcmd + 0x4);\r\ntimeout = 0;\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\nwhile (((tmp & 0x80) == 0x80) && (timeout < C6XDIGIO_TIME_OUT)) {\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\ntimeout++;\r\n}\r\nenc.bits.sb5 = ((ReadByteFromHwPort(baseAddr + 1) >> 3) & 0x7);\r\nWriteByteToHwPort(baseAddr, ppcmd);\r\ntimeout = 0;\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\nwhile (((tmp & 0x80) == 0x0) && (timeout < C6XDIGIO_TIME_OUT)) {\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\ntimeout++;\r\n}\r\nenc.bits.sb6 = ((ReadByteFromHwPort(baseAddr + 1) >> 3) & 0x7);\r\nWriteByteToHwPort(baseAddr, ppcmd + 0x4);\r\ntimeout = 0;\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\nwhile (((tmp & 0x80) == 0x80) && (timeout < C6XDIGIO_TIME_OUT)) {\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\ntimeout++;\r\n}\r\nenc.bits.sb7 = ((ReadByteFromHwPort(baseAddr + 1) >> 3) & 0x7);\r\nWriteByteToHwPort(baseAddr, ppcmd);\r\ntimeout = 0;\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\nwhile (((tmp & 0x80) == 0x0) && (timeout < C6XDIGIO_TIME_OUT)) {\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\ntimeout++;\r\n}\r\nWriteByteToHwPort(baseAddr, 0x0);\r\ntimeout = 0;\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\nwhile (((tmp & 0x80) == 0x80) && (timeout < C6XDIGIO_TIME_OUT)) {\r\ntmp = ReadByteFromHwPort(baseAddr + 1);\r\ntimeout++;\r\n}\r\nreturn enc.value ^ 0x800000;\r\n}\r\nstatic void C6X_encResetAll(unsigned long baseAddr)\r\n{\r\nunsigned timeout = 0;\r\nWriteByteToHwPort(baseAddr, 0x68);\r\nwhile (((ReadByteFromHwPort(baseAddr + 1) & 0x80) == 0)\r\n&& (timeout < C6XDIGIO_TIME_OUT)) {\r\ntimeout++;\r\n}\r\nWriteByteToHwPort(baseAddr, 0x6C);\r\ntimeout = 0;\r\nwhile (((ReadByteFromHwPort(baseAddr + 1) & 0x80) == 0x80)\r\n&& (timeout < C6XDIGIO_TIME_OUT)) {\r\ntimeout++;\r\n}\r\nWriteByteToHwPort(baseAddr, 0x68);\r\ntimeout = 0;\r\nwhile (((ReadByteFromHwPort(baseAddr + 1) & 0x80) == 0x0)\r\n&& (timeout < C6XDIGIO_TIME_OUT)) {\r\ntimeout++;\r\n}\r\nWriteByteToHwPort(baseAddr, 0x0);\r\ntimeout = 0;\r\nwhile (((ReadByteFromHwPort(baseAddr + 1) & 0x80) == 0x80)\r\n&& (timeout < C6XDIGIO_TIME_OUT)) {\r\ntimeout++;\r\n}\r\n}\r\nstatic int c6xdigio_pwmo_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nprintk("c6xdigio_pwmo_insn_read %x\n", insn->n);\r\nreturn insn->n;\r\n}\r\nstatic int c6xdigio_pwmo_insn_write(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nint i;\r\nint chan = CR_CHAN(insn->chanspec);\r\nfor (i = 0; i < insn->n; i++) {\r\nC6X_pwmOutput(dev->iobase, chan, data[i]);\r\n}\r\nreturn i;\r\n}\r\nstatic int c6xdigio_ei_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint n;\r\nint chan = CR_CHAN(insn->chanspec);\r\nfor (n = 0; n < insn->n; n++)\r\ndata[n] = (C6X_encInput(dev->iobase, chan) & 0xffffff);\r\nreturn n;\r\n}\r\nstatic void board_init(struct comedi_device *dev)\r\n{\r\nC6X_pwmInit(dev->iobase);\r\nC6X_encResetAll(dev->iobase);\r\n}\r\nstatic int c6xdigio_attach(struct comedi_device *dev,\r\nstruct comedi_devconfig *it)\r\n{\r\nint result = 0;\r\nunsigned long iobase;\r\nunsigned int irq;\r\nstruct comedi_subdevice *s;\r\niobase = it->options[0];\r\nprintk("comedi%d: c6xdigio: 0x%04lx\n", dev->minor, iobase);\r\nif (!request_region(iobase, C6XDIGIO_SIZE, "c6xdigio")) {\r\nprintk("comedi%d: I/O port conflict\n", dev->minor);\r\nreturn -EIO;\r\n}\r\ndev->iobase = iobase;\r\ndev->board_name = "c6xdigio";\r\nresult = alloc_subdevices(dev, 2);\r\nif (result < 0)\r\nreturn result;\r\npnp_register_driver(&c6xdigio_pnp_driver);\r\nirq = it->options[1];\r\nif (irq > 0)\r\nprintk("comedi%d: irq = %u ignored\n", dev->minor, irq);\r\nelse if (irq == 0)\r\nprintk("comedi%d: no irq\n", dev->minor);\r\ns = dev->subdevices + 0;\r\ns->type = COMEDI_SUBD_AO;\r\ns->subdev_flags = SDF_WRITEABLE;\r\ns->n_chan = 2;\r\ns->insn_read = c6xdigio_pwmo_insn_read;\r\ns->insn_write = c6xdigio_pwmo_insn_write;\r\ns->maxdata = 500;\r\ns->range_table = &range_bipolar10;\r\ns = dev->subdevices + 1;\r\ns->type = COMEDI_SUBD_COUNTER;\r\ns->subdev_flags = SDF_READABLE | SDF_LSAMPL;\r\ns->n_chan = 2;\r\ns->insn_read = c6xdigio_ei_insn_read;\r\ns->maxdata = 0xffffff;\r\ns->range_table = &range_unknown;\r\nboard_init(dev);\r\nreturn 0;\r\n}\r\nstatic int c6xdigio_detach(struct comedi_device *dev)\r\n{\r\nprintk("comedi%d: c6xdigio: remove\n", dev->minor);\r\nif (dev->iobase)\r\nrelease_region(dev->iobase, C6XDIGIO_SIZE);\r\nif (dev->irq)\r\nfree_irq(dev->irq, dev);\r\npnp_unregister_driver(&c6xdigio_pnp_driver);\r\nreturn 0;\r\n}\r\nstatic int __init driver_c6xdigio_init_module(void)\r\n{\r\nreturn comedi_driver_register(&driver_c6xdigio);\r\n}\r\nstatic void __exit driver_c6xdigio_cleanup_module(void)\r\n{\r\ncomedi_driver_unregister(&driver_c6xdigio);\r\n}

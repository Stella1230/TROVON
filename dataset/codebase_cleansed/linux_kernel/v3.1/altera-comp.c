static u32 altera_bits_req(u32 n)\r\n{\r\nu32 result = SHORT_BITS;\r\nif (n == 0)\r\nresult = 1;\r\nelse {\r\nwhile ((n & (1 << (SHORT_BITS - 1))) == 0) {\r\nn <<= 1;\r\n--result;\r\n}\r\n}\r\nreturn result;\r\n}\r\nstatic u32 altera_read_packed(u8 *buffer, u32 bits, u32 *bits_avail,\r\nu32 *in_index)\r\n{\r\nu32 result = 0;\r\nu32 shift = 0;\r\nu32 databyte = 0;\r\nwhile (bits > 0) {\r\ndatabyte = buffer[*in_index];\r\nresult |= (((databyte >> (CHAR_BITS - *bits_avail))\r\n& (0xff >> (CHAR_BITS - *bits_avail))) << shift);\r\nif (bits <= *bits_avail) {\r\nresult &= (0xffff >> (SHORT_BITS - (bits + shift)));\r\n*bits_avail -= bits;\r\nbits = 0;\r\n} else {\r\n++(*in_index);\r\nshift += *bits_avail;\r\nbits -= *bits_avail;\r\n*bits_avail = CHAR_BITS;\r\n}\r\n}\r\nreturn result;\r\n}\r\nu32 altera_shrink(u8 *in, u32 in_length, u8 *out, u32 out_length, s32 version)\r\n{\r\nu32 i, j, data_length = 0L;\r\nu32 offset, length;\r\nu32 match_data_length = MATCH_DATA_LENGTH;\r\nu32 bits_avail = CHAR_BITS;\r\nu32 in_index = 0L;\r\nif (version > 0)\r\n--match_data_length;\r\nfor (i = 0; i < out_length; ++i)\r\nout[i] = 0;\r\nfor (i = 0; i < sizeof(in_length); ++i) {\r\ndata_length = data_length | (\r\naltera_read_packed(in,\r\nCHAR_BITS,\r\n&bits_avail,\r\n&in_index) << (i * CHAR_BITS));\r\n}\r\nif (data_length > out_length) {\r\ndata_length = 0L;\r\nreturn data_length;\r\n}\r\ni = 0;\r\nwhile (i < data_length) {\r\nif (altera_read_packed(in, 1, &bits_avail,\r\n&in_index) == 0) {\r\nfor (j = 0; j < DATA_BLOB_LENGTH; ++j) {\r\nif (i < data_length) {\r\nout[i] = (u8)altera_read_packed(in,\r\nCHAR_BITS,\r\n&bits_avail,\r\n&in_index);\r\ni++;\r\n}\r\n}\r\n} else {\r\noffset = altera_read_packed(in, altera_bits_req((s16)\r\n(i > match_data_length ?\r\nmatch_data_length : i)),\r\n&bits_avail,\r\n&in_index);\r\nlength = altera_read_packed(in, CHAR_BITS,\r\n&bits_avail,\r\n&in_index);\r\nfor (j = 0; j < length; ++j) {\r\nif (i < data_length) {\r\nout[i] = out[i - offset];\r\ni++;\r\n}\r\n}\r\n}\r\n}\r\nreturn data_length;\r\n}

static struct mtd_info *map_ram_probe(struct map_info *map)\r\n{\r\nstruct mtd_info *mtd;\r\n#if 0\r\nmap_write8(map, 0x55, 0);\r\nif (map_read8(map, 0) != 0x55)\r\nreturn NULL;\r\nmap_write8(map, 0xAA, 0);\r\nif (map_read8(map, 0) != 0xAA)\r\nreturn NULL;\r\nmap_write8(map, 0x55, map->size-1);\r\nif (map_read8(map, map->size-1) != 0x55)\r\nreturn NULL;\r\nmap_write8(map, 0xAA, map->size-1);\r\nif (map_read8(map, map->size-1) != 0xAA)\r\nreturn NULL;\r\n#endif\r\nmtd = kzalloc(sizeof(*mtd), GFP_KERNEL);\r\nif (!mtd)\r\nreturn NULL;\r\nmap->fldrv = &mapram_chipdrv;\r\nmtd->priv = map;\r\nmtd->name = map->name;\r\nmtd->type = MTD_RAM;\r\nmtd->size = map->size;\r\nmtd->erase = mapram_erase;\r\nmtd->get_unmapped_area = mapram_unmapped_area;\r\nmtd->read = mapram_read;\r\nmtd->write = mapram_write;\r\nmtd->sync = mapram_nop;\r\nmtd->flags = MTD_CAP_RAM;\r\nmtd->writesize = 1;\r\nmtd->erasesize = PAGE_SIZE;\r\nwhile(mtd->size & (mtd->erasesize - 1))\r\nmtd->erasesize >>= 1;\r\n__module_get(THIS_MODULE);\r\nreturn mtd;\r\n}\r\nstatic unsigned long mapram_unmapped_area(struct mtd_info *mtd,\r\nunsigned long len,\r\nunsigned long offset,\r\nunsigned long flags)\r\n{\r\nstruct map_info *map = mtd->priv;\r\nreturn (unsigned long) map->virt + offset;\r\n}\r\nstatic int mapram_read (struct mtd_info *mtd, loff_t from, size_t len, size_t *retlen, u_char *buf)\r\n{\r\nstruct map_info *map = mtd->priv;\r\nmap_copy_from(map, buf, from, len);\r\n*retlen = len;\r\nreturn 0;\r\n}\r\nstatic int mapram_write (struct mtd_info *mtd, loff_t to, size_t len, size_t *retlen, const u_char *buf)\r\n{\r\nstruct map_info *map = mtd->priv;\r\nmap_copy_to(map, to, buf, len);\r\n*retlen = len;\r\nreturn 0;\r\n}\r\nstatic int mapram_erase (struct mtd_info *mtd, struct erase_info *instr)\r\n{\r\nstruct map_info *map = mtd->priv;\r\nmap_word allff;\r\nunsigned long i;\r\nallff = map_word_ff(map);\r\nfor (i=0; i<instr->len; i += map_bankwidth(map))\r\nmap_write(map, allff, instr->addr + i);\r\ninstr->state = MTD_ERASE_DONE;\r\nmtd_erase_callback(instr);\r\nreturn 0;\r\n}\r\nstatic void mapram_nop(struct mtd_info *mtd)\r\n{\r\n}\r\nstatic int __init map_ram_init(void)\r\n{\r\nregister_mtd_chip_driver(&mapram_chipdrv);\r\nreturn 0;\r\n}\r\nstatic void __exit map_ram_exit(void)\r\n{\r\nunregister_mtd_chip_driver(&mapram_chipdrv);\r\n}

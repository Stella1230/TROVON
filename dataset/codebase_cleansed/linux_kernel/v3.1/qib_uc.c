int qib_make_uc_req(struct qib_qp *qp)\r\n{\r\nstruct qib_other_headers *ohdr;\r\nstruct qib_swqe *wqe;\r\nunsigned long flags;\r\nu32 hwords;\r\nu32 bth0;\r\nu32 len;\r\nu32 pmtu = ib_mtu_enum_to_int(qp->path_mtu);\r\nint ret = 0;\r\nspin_lock_irqsave(&qp->s_lock, flags);\r\nif (!(ib_qib_state_ops[qp->state] & QIB_PROCESS_SEND_OK)) {\r\nif (!(ib_qib_state_ops[qp->state] & QIB_FLUSH_SEND))\r\ngoto bail;\r\nif (qp->s_last == qp->s_head)\r\ngoto bail;\r\nif (atomic_read(&qp->s_dma_busy)) {\r\nqp->s_flags |= QIB_S_WAIT_DMA;\r\ngoto bail;\r\n}\r\nwqe = get_swqe_ptr(qp, qp->s_last);\r\nqib_send_complete(qp, wqe, IB_WC_WR_FLUSH_ERR);\r\ngoto done;\r\n}\r\nohdr = &qp->s_hdr.u.oth;\r\nif (qp->remote_ah_attr.ah_flags & IB_AH_GRH)\r\nohdr = &qp->s_hdr.u.l.oth;\r\nhwords = 5;\r\nbth0 = 0;\r\nwqe = get_swqe_ptr(qp, qp->s_cur);\r\nqp->s_wqe = NULL;\r\nswitch (qp->s_state) {\r\ndefault:\r\nif (!(ib_qib_state_ops[qp->state] &\r\nQIB_PROCESS_NEXT_SEND_OK))\r\ngoto bail;\r\nif (qp->s_cur == qp->s_head)\r\ngoto bail;\r\nwqe->psn = qp->s_next_psn;\r\nqp->s_psn = qp->s_next_psn;\r\nqp->s_sge.sge = wqe->sg_list[0];\r\nqp->s_sge.sg_list = wqe->sg_list + 1;\r\nqp->s_sge.num_sge = wqe->wr.num_sge;\r\nqp->s_sge.total_len = wqe->length;\r\nlen = wqe->length;\r\nqp->s_len = len;\r\nswitch (wqe->wr.opcode) {\r\ncase IB_WR_SEND:\r\ncase IB_WR_SEND_WITH_IMM:\r\nif (len > pmtu) {\r\nqp->s_state = OP(SEND_FIRST);\r\nlen = pmtu;\r\nbreak;\r\n}\r\nif (wqe->wr.opcode == IB_WR_SEND)\r\nqp->s_state = OP(SEND_ONLY);\r\nelse {\r\nqp->s_state =\r\nOP(SEND_ONLY_WITH_IMMEDIATE);\r\nohdr->u.imm_data = wqe->wr.ex.imm_data;\r\nhwords += 1;\r\n}\r\nif (wqe->wr.send_flags & IB_SEND_SOLICITED)\r\nbth0 |= IB_BTH_SOLICITED;\r\nqp->s_wqe = wqe;\r\nif (++qp->s_cur >= qp->s_size)\r\nqp->s_cur = 0;\r\nbreak;\r\ncase IB_WR_RDMA_WRITE:\r\ncase IB_WR_RDMA_WRITE_WITH_IMM:\r\nohdr->u.rc.reth.vaddr =\r\ncpu_to_be64(wqe->wr.wr.rdma.remote_addr);\r\nohdr->u.rc.reth.rkey =\r\ncpu_to_be32(wqe->wr.wr.rdma.rkey);\r\nohdr->u.rc.reth.length = cpu_to_be32(len);\r\nhwords += sizeof(struct ib_reth) / 4;\r\nif (len > pmtu) {\r\nqp->s_state = OP(RDMA_WRITE_FIRST);\r\nlen = pmtu;\r\nbreak;\r\n}\r\nif (wqe->wr.opcode == IB_WR_RDMA_WRITE)\r\nqp->s_state = OP(RDMA_WRITE_ONLY);\r\nelse {\r\nqp->s_state =\r\nOP(RDMA_WRITE_ONLY_WITH_IMMEDIATE);\r\nohdr->u.rc.imm_data = wqe->wr.ex.imm_data;\r\nhwords += 1;\r\nif (wqe->wr.send_flags & IB_SEND_SOLICITED)\r\nbth0 |= IB_BTH_SOLICITED;\r\n}\r\nqp->s_wqe = wqe;\r\nif (++qp->s_cur >= qp->s_size)\r\nqp->s_cur = 0;\r\nbreak;\r\ndefault:\r\ngoto bail;\r\n}\r\nbreak;\r\ncase OP(SEND_FIRST):\r\nqp->s_state = OP(SEND_MIDDLE);\r\ncase OP(SEND_MIDDLE):\r\nlen = qp->s_len;\r\nif (len > pmtu) {\r\nlen = pmtu;\r\nbreak;\r\n}\r\nif (wqe->wr.opcode == IB_WR_SEND)\r\nqp->s_state = OP(SEND_LAST);\r\nelse {\r\nqp->s_state = OP(SEND_LAST_WITH_IMMEDIATE);\r\nohdr->u.imm_data = wqe->wr.ex.imm_data;\r\nhwords += 1;\r\n}\r\nif (wqe->wr.send_flags & IB_SEND_SOLICITED)\r\nbth0 |= IB_BTH_SOLICITED;\r\nqp->s_wqe = wqe;\r\nif (++qp->s_cur >= qp->s_size)\r\nqp->s_cur = 0;\r\nbreak;\r\ncase OP(RDMA_WRITE_FIRST):\r\nqp->s_state = OP(RDMA_WRITE_MIDDLE);\r\ncase OP(RDMA_WRITE_MIDDLE):\r\nlen = qp->s_len;\r\nif (len > pmtu) {\r\nlen = pmtu;\r\nbreak;\r\n}\r\nif (wqe->wr.opcode == IB_WR_RDMA_WRITE)\r\nqp->s_state = OP(RDMA_WRITE_LAST);\r\nelse {\r\nqp->s_state =\r\nOP(RDMA_WRITE_LAST_WITH_IMMEDIATE);\r\nohdr->u.imm_data = wqe->wr.ex.imm_data;\r\nhwords += 1;\r\nif (wqe->wr.send_flags & IB_SEND_SOLICITED)\r\nbth0 |= IB_BTH_SOLICITED;\r\n}\r\nqp->s_wqe = wqe;\r\nif (++qp->s_cur >= qp->s_size)\r\nqp->s_cur = 0;\r\nbreak;\r\n}\r\nqp->s_len -= len;\r\nqp->s_hdrwords = hwords;\r\nqp->s_cur_sge = &qp->s_sge;\r\nqp->s_cur_size = len;\r\nqib_make_ruc_header(qp, ohdr, bth0 | (qp->s_state << 24),\r\nqp->s_next_psn++ & QIB_PSN_MASK);\r\ndone:\r\nret = 1;\r\ngoto unlock;\r\nbail:\r\nqp->s_flags &= ~QIB_S_BUSY;\r\nunlock:\r\nspin_unlock_irqrestore(&qp->s_lock, flags);\r\nreturn ret;\r\n}\r\nvoid qib_uc_rcv(struct qib_ibport *ibp, struct qib_ib_header *hdr,\r\nint has_grh, void *data, u32 tlen, struct qib_qp *qp)\r\n{\r\nstruct qib_other_headers *ohdr;\r\nunsigned long flags;\r\nu32 opcode;\r\nu32 hdrsize;\r\nu32 psn;\r\nu32 pad;\r\nstruct ib_wc wc;\r\nu32 pmtu = ib_mtu_enum_to_int(qp->path_mtu);\r\nstruct ib_reth *reth;\r\nint ret;\r\nif (!has_grh) {\r\nohdr = &hdr->u.oth;\r\nhdrsize = 8 + 12;\r\n} else {\r\nohdr = &hdr->u.l.oth;\r\nhdrsize = 8 + 40 + 12;\r\n}\r\nopcode = be32_to_cpu(ohdr->bth[0]);\r\nspin_lock_irqsave(&qp->s_lock, flags);\r\nif (qib_ruc_check_hdr(ibp, hdr, has_grh, qp, opcode))\r\ngoto sunlock;\r\nspin_unlock_irqrestore(&qp->s_lock, flags);\r\npsn = be32_to_cpu(ohdr->bth[2]);\r\nopcode >>= 24;\r\nmemset(&wc, 0, sizeof wc);\r\nif (unlikely(qib_cmp24(psn, qp->r_psn) != 0)) {\r\nqp->r_psn = psn;\r\ninv:\r\nif (qp->r_state == OP(SEND_FIRST) ||\r\nqp->r_state == OP(SEND_MIDDLE)) {\r\nset_bit(QIB_R_REWIND_SGE, &qp->r_aflags);\r\nqp->r_sge.num_sge = 0;\r\n} else\r\nwhile (qp->r_sge.num_sge) {\r\natomic_dec(&qp->r_sge.sge.mr->refcount);\r\nif (--qp->r_sge.num_sge)\r\nqp->r_sge.sge = *qp->r_sge.sg_list++;\r\n}\r\nqp->r_state = OP(SEND_LAST);\r\nswitch (opcode) {\r\ncase OP(SEND_FIRST):\r\ncase OP(SEND_ONLY):\r\ncase OP(SEND_ONLY_WITH_IMMEDIATE):\r\ngoto send_first;\r\ncase OP(RDMA_WRITE_FIRST):\r\ncase OP(RDMA_WRITE_ONLY):\r\ncase OP(RDMA_WRITE_ONLY_WITH_IMMEDIATE):\r\ngoto rdma_first;\r\ndefault:\r\ngoto drop;\r\n}\r\n}\r\nswitch (qp->r_state) {\r\ncase OP(SEND_FIRST):\r\ncase OP(SEND_MIDDLE):\r\nif (opcode == OP(SEND_MIDDLE) ||\r\nopcode == OP(SEND_LAST) ||\r\nopcode == OP(SEND_LAST_WITH_IMMEDIATE))\r\nbreak;\r\ngoto inv;\r\ncase OP(RDMA_WRITE_FIRST):\r\ncase OP(RDMA_WRITE_MIDDLE):\r\nif (opcode == OP(RDMA_WRITE_MIDDLE) ||\r\nopcode == OP(RDMA_WRITE_LAST) ||\r\nopcode == OP(RDMA_WRITE_LAST_WITH_IMMEDIATE))\r\nbreak;\r\ngoto inv;\r\ndefault:\r\nif (opcode == OP(SEND_FIRST) ||\r\nopcode == OP(SEND_ONLY) ||\r\nopcode == OP(SEND_ONLY_WITH_IMMEDIATE) ||\r\nopcode == OP(RDMA_WRITE_FIRST) ||\r\nopcode == OP(RDMA_WRITE_ONLY) ||\r\nopcode == OP(RDMA_WRITE_ONLY_WITH_IMMEDIATE))\r\nbreak;\r\ngoto inv;\r\n}\r\nif (qp->state == IB_QPS_RTR && !(qp->r_flags & QIB_R_COMM_EST)) {\r\nqp->r_flags |= QIB_R_COMM_EST;\r\nif (qp->ibqp.event_handler) {\r\nstruct ib_event ev;\r\nev.device = qp->ibqp.device;\r\nev.element.qp = &qp->ibqp;\r\nev.event = IB_EVENT_COMM_EST;\r\nqp->ibqp.event_handler(&ev, qp->ibqp.qp_context);\r\n}\r\n}\r\nswitch (opcode) {\r\ncase OP(SEND_FIRST):\r\ncase OP(SEND_ONLY):\r\ncase OP(SEND_ONLY_WITH_IMMEDIATE):\r\nsend_first:\r\nif (test_and_clear_bit(QIB_R_REWIND_SGE, &qp->r_aflags))\r\nqp->r_sge = qp->s_rdma_read_sge;\r\nelse {\r\nret = qib_get_rwqe(qp, 0);\r\nif (ret < 0)\r\ngoto op_err;\r\nif (!ret)\r\ngoto drop;\r\nqp->s_rdma_read_sge = qp->r_sge;\r\n}\r\nqp->r_rcv_len = 0;\r\nif (opcode == OP(SEND_ONLY))\r\ngoto send_last;\r\nelse if (opcode == OP(SEND_ONLY_WITH_IMMEDIATE))\r\ngoto send_last_imm;\r\ncase OP(SEND_MIDDLE):\r\nif (unlikely(tlen != (hdrsize + pmtu + 4)))\r\ngoto rewind;\r\nqp->r_rcv_len += pmtu;\r\nif (unlikely(qp->r_rcv_len > qp->r_len))\r\ngoto rewind;\r\nqib_copy_sge(&qp->r_sge, data, pmtu, 0);\r\nbreak;\r\ncase OP(SEND_LAST_WITH_IMMEDIATE):\r\nsend_last_imm:\r\nwc.ex.imm_data = ohdr->u.imm_data;\r\nhdrsize += 4;\r\nwc.wc_flags = IB_WC_WITH_IMM;\r\ncase OP(SEND_LAST):\r\nsend_last:\r\npad = (be32_to_cpu(ohdr->bth[0]) >> 20) & 3;\r\nif (unlikely(tlen < (hdrsize + pad + 4)))\r\ngoto rewind;\r\ntlen -= (hdrsize + pad + 4);\r\nwc.byte_len = tlen + qp->r_rcv_len;\r\nif (unlikely(wc.byte_len > qp->r_len))\r\ngoto rewind;\r\nwc.opcode = IB_WC_RECV;\r\nlast_imm:\r\nqib_copy_sge(&qp->r_sge, data, tlen, 0);\r\nwhile (qp->s_rdma_read_sge.num_sge) {\r\natomic_dec(&qp->s_rdma_read_sge.sge.mr->refcount);\r\nif (--qp->s_rdma_read_sge.num_sge)\r\nqp->s_rdma_read_sge.sge =\r\n*qp->s_rdma_read_sge.sg_list++;\r\n}\r\nwc.wr_id = qp->r_wr_id;\r\nwc.status = IB_WC_SUCCESS;\r\nwc.qp = &qp->ibqp;\r\nwc.src_qp = qp->remote_qpn;\r\nwc.slid = qp->remote_ah_attr.dlid;\r\nwc.sl = qp->remote_ah_attr.sl;\r\nqib_cq_enter(to_icq(qp->ibqp.recv_cq), &wc,\r\n(ohdr->bth[0] &\r\ncpu_to_be32(IB_BTH_SOLICITED)) != 0);\r\nbreak;\r\ncase OP(RDMA_WRITE_FIRST):\r\ncase OP(RDMA_WRITE_ONLY):\r\ncase OP(RDMA_WRITE_ONLY_WITH_IMMEDIATE):\r\nrdma_first:\r\nif (unlikely(!(qp->qp_access_flags &\r\nIB_ACCESS_REMOTE_WRITE))) {\r\ngoto drop;\r\n}\r\nreth = &ohdr->u.rc.reth;\r\nhdrsize += sizeof(*reth);\r\nqp->r_len = be32_to_cpu(reth->length);\r\nqp->r_rcv_len = 0;\r\nqp->r_sge.sg_list = NULL;\r\nif (qp->r_len != 0) {\r\nu32 rkey = be32_to_cpu(reth->rkey);\r\nu64 vaddr = be64_to_cpu(reth->vaddr);\r\nint ok;\r\nok = qib_rkey_ok(qp, &qp->r_sge.sge, qp->r_len,\r\nvaddr, rkey, IB_ACCESS_REMOTE_WRITE);\r\nif (unlikely(!ok))\r\ngoto drop;\r\nqp->r_sge.num_sge = 1;\r\n} else {\r\nqp->r_sge.num_sge = 0;\r\nqp->r_sge.sge.mr = NULL;\r\nqp->r_sge.sge.vaddr = NULL;\r\nqp->r_sge.sge.length = 0;\r\nqp->r_sge.sge.sge_length = 0;\r\n}\r\nif (opcode == OP(RDMA_WRITE_ONLY))\r\ngoto rdma_last;\r\nelse if (opcode == OP(RDMA_WRITE_ONLY_WITH_IMMEDIATE)) {\r\nwc.ex.imm_data = ohdr->u.rc.imm_data;\r\ngoto rdma_last_imm;\r\n}\r\ncase OP(RDMA_WRITE_MIDDLE):\r\nif (unlikely(tlen != (hdrsize + pmtu + 4)))\r\ngoto drop;\r\nqp->r_rcv_len += pmtu;\r\nif (unlikely(qp->r_rcv_len > qp->r_len))\r\ngoto drop;\r\nqib_copy_sge(&qp->r_sge, data, pmtu, 1);\r\nbreak;\r\ncase OP(RDMA_WRITE_LAST_WITH_IMMEDIATE):\r\nwc.ex.imm_data = ohdr->u.imm_data;\r\nrdma_last_imm:\r\nhdrsize += 4;\r\nwc.wc_flags = IB_WC_WITH_IMM;\r\npad = (be32_to_cpu(ohdr->bth[0]) >> 20) & 3;\r\nif (unlikely(tlen < (hdrsize + pad + 4)))\r\ngoto drop;\r\ntlen -= (hdrsize + pad + 4);\r\nif (unlikely(tlen + qp->r_rcv_len != qp->r_len))\r\ngoto drop;\r\nif (test_and_clear_bit(QIB_R_REWIND_SGE, &qp->r_aflags))\r\nwhile (qp->s_rdma_read_sge.num_sge) {\r\natomic_dec(&qp->s_rdma_read_sge.sge.mr->\r\nrefcount);\r\nif (--qp->s_rdma_read_sge.num_sge)\r\nqp->s_rdma_read_sge.sge =\r\n*qp->s_rdma_read_sge.sg_list++;\r\n}\r\nelse {\r\nret = qib_get_rwqe(qp, 1);\r\nif (ret < 0)\r\ngoto op_err;\r\nif (!ret)\r\ngoto drop;\r\n}\r\nwc.byte_len = qp->r_len;\r\nwc.opcode = IB_WC_RECV_RDMA_WITH_IMM;\r\ngoto last_imm;\r\ncase OP(RDMA_WRITE_LAST):\r\nrdma_last:\r\npad = (be32_to_cpu(ohdr->bth[0]) >> 20) & 3;\r\nif (unlikely(tlen < (hdrsize + pad + 4)))\r\ngoto drop;\r\ntlen -= (hdrsize + pad + 4);\r\nif (unlikely(tlen + qp->r_rcv_len != qp->r_len))\r\ngoto drop;\r\nqib_copy_sge(&qp->r_sge, data, tlen, 1);\r\nwhile (qp->r_sge.num_sge) {\r\natomic_dec(&qp->r_sge.sge.mr->refcount);\r\nif (--qp->r_sge.num_sge)\r\nqp->r_sge.sge = *qp->r_sge.sg_list++;\r\n}\r\nbreak;\r\ndefault:\r\ngoto drop;\r\n}\r\nqp->r_psn++;\r\nqp->r_state = opcode;\r\nreturn;\r\nrewind:\r\nset_bit(QIB_R_REWIND_SGE, &qp->r_aflags);\r\nqp->r_sge.num_sge = 0;\r\ndrop:\r\nibp->n_pkt_drops++;\r\nreturn;\r\nop_err:\r\nqib_rc_error(qp, IB_WC_LOC_QP_OP_ERR);\r\nreturn;\r\nsunlock:\r\nspin_unlock_irqrestore(&qp->s_lock, flags);\r\n}

static int isp1301_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nreturn 0;\r\n}\r\nstatic int isp1301_remove(struct i2c_client *client)\r\n{\r\nreturn 0;\r\n}\r\nstatic void i2c_write(u8 buf, u8 subaddr)\r\n{\r\nchar tmpbuf[2];\r\ntmpbuf[0] = subaddr;\r\ntmpbuf[1] = buf;\r\ni2c_master_send(isp1301_i2c_client, &tmpbuf[0], 2);\r\n}\r\nstatic void isp1301_configure(void)\r\n{\r\ni2c_write(MC1_DAT_SE0 | MC1_SPEED_REG, ISP1301_I2C_MODE_CONTROL_1);\r\ni2c_write(~(MC1_DAT_SE0 | MC1_SPEED_REG),\r\nISP1301_I2C_MODE_CONTROL_1 | ISP1301_I2C_REG_CLEAR_ADDR);\r\ni2c_write(MC2_BI_DI | MC2_PSW_EN | MC2_SPD_SUSP_CTRL,\r\nISP1301_I2C_MODE_CONTROL_2);\r\ni2c_write(~(MC2_BI_DI | MC2_PSW_EN | MC2_SPD_SUSP_CTRL),\r\nISP1301_I2C_MODE_CONTROL_2 | ISP1301_I2C_REG_CLEAR_ADDR);\r\ni2c_write(OTG1_DM_PULLDOWN | OTG1_DP_PULLDOWN,\r\nISP1301_I2C_OTG_CONTROL_1);\r\ni2c_write(~(OTG1_DM_PULLDOWN | OTG1_DP_PULLDOWN),\r\nISP1301_I2C_OTG_CONTROL_1 | ISP1301_I2C_REG_CLEAR_ADDR);\r\ni2c_write(0xFF,\r\nISP1301_I2C_INTERRUPT_LATCH | ISP1301_I2C_REG_CLEAR_ADDR);\r\ni2c_write(0xFF,\r\nISP1301_I2C_INTERRUPT_FALLING | ISP1301_I2C_REG_CLEAR_ADDR);\r\ni2c_write(0xFF,\r\nISP1301_I2C_INTERRUPT_RISING | ISP1301_I2C_REG_CLEAR_ADDR);\r\n}\r\nstatic inline void isp1301_vbus_on(void)\r\n{\r\ni2c_write(OTG1_VBUS_DRV, ISP1301_I2C_OTG_CONTROL_1);\r\n}\r\nstatic inline void isp1301_vbus_off(void)\r\n{\r\ni2c_write(OTG1_VBUS_DRV,\r\nISP1301_I2C_OTG_CONTROL_1 | ISP1301_I2C_REG_CLEAR_ADDR);\r\n}\r\nstatic void pnx4008_start_hc(void)\r\n{\r\nunsigned long tmp = __raw_readl(USB_OTG_STAT_CONTROL) | HOST_EN;\r\n__raw_writel(tmp, USB_OTG_STAT_CONTROL);\r\nisp1301_vbus_on();\r\n}\r\nstatic void pnx4008_stop_hc(void)\r\n{\r\nunsigned long tmp;\r\nisp1301_vbus_off();\r\ntmp = __raw_readl(USB_OTG_STAT_CONTROL) & ~HOST_EN;\r\n__raw_writel(tmp, USB_OTG_STAT_CONTROL);\r\n}\r\nstatic int __devinit ohci_pnx4008_start(struct usb_hcd *hcd)\r\n{\r\nstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\r\nint ret;\r\nif ((ret = ohci_init(ohci)) < 0)\r\nreturn ret;\r\nif ((ret = ohci_run(ohci)) < 0) {\r\ndev_err(hcd->self.controller, "can't start\n");\r\nohci_stop(hcd);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic void pnx4008_set_usb_bits(void)\r\n{\r\nstart_int_set_falling_edge(SE_USB_OTG_ATX_INT_N);\r\nstart_int_ack(SE_USB_OTG_ATX_INT_N);\r\nstart_int_umask(SE_USB_OTG_ATX_INT_N);\r\nstart_int_set_rising_edge(SE_USB_OTG_TIMER_INT);\r\nstart_int_ack(SE_USB_OTG_TIMER_INT);\r\nstart_int_umask(SE_USB_OTG_TIMER_INT);\r\nstart_int_set_rising_edge(SE_USB_I2C_INT);\r\nstart_int_ack(SE_USB_I2C_INT);\r\nstart_int_umask(SE_USB_I2C_INT);\r\nstart_int_set_rising_edge(SE_USB_INT);\r\nstart_int_ack(SE_USB_INT);\r\nstart_int_umask(SE_USB_INT);\r\nstart_int_set_rising_edge(SE_USB_NEED_CLK_INT);\r\nstart_int_ack(SE_USB_NEED_CLK_INT);\r\nstart_int_umask(SE_USB_NEED_CLK_INT);\r\nstart_int_set_rising_edge(SE_USB_AHB_NEED_CLK_INT);\r\nstart_int_ack(SE_USB_AHB_NEED_CLK_INT);\r\nstart_int_umask(SE_USB_AHB_NEED_CLK_INT);\r\n}\r\nstatic void pnx4008_unset_usb_bits(void)\r\n{\r\nstart_int_mask(SE_USB_OTG_ATX_INT_N);\r\nstart_int_mask(SE_USB_OTG_TIMER_INT);\r\nstart_int_mask(SE_USB_I2C_INT);\r\nstart_int_mask(SE_USB_INT);\r\nstart_int_mask(SE_USB_NEED_CLK_INT);\r\nstart_int_mask(SE_USB_AHB_NEED_CLK_INT);\r\n}\r\nstatic int __devinit usb_hcd_pnx4008_probe(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = 0;\r\nstruct ohci_hcd *ohci;\r\nconst struct hc_driver *driver = &ohci_pnx4008_hc_driver;\r\nstruct i2c_adapter *i2c_adap;\r\nstruct i2c_board_info i2c_info;\r\nint ret = 0, irq;\r\ndev_dbg(&pdev->dev, "%s: " DRIVER_DESC " (pnx4008)\n", hcd_name);\r\nif (usb_disabled()) {\r\nerr("USB is disabled");\r\nret = -ENODEV;\r\ngoto out;\r\n}\r\nif (pdev->num_resources != 2\r\n|| pdev->resource[0].flags != IORESOURCE_MEM\r\n|| pdev->resource[1].flags != IORESOURCE_IRQ) {\r\nerr("Invalid resource configuration");\r\nret = -ENODEV;\r\ngoto out;\r\n}\r\n__raw_writel(USB_SLAVE_HCLK_EN | (1 << 19), USB_CTRL);\r\nret = i2c_add_driver(&isp1301_driver);\r\nif (ret < 0) {\r\nerr("failed to add ISP1301 driver");\r\ngoto out;\r\n}\r\ni2c_adap = i2c_get_adapter(2);\r\nmemset(&i2c_info, 0, sizeof(struct i2c_board_info));\r\nstrlcpy(i2c_info.type, "isp1301_pnx", I2C_NAME_SIZE);\r\nisp1301_i2c_client = i2c_new_probed_device(i2c_adap, &i2c_info,\r\nnormal_i2c, NULL);\r\ni2c_put_adapter(i2c_adap);\r\nif (!isp1301_i2c_client) {\r\nerr("failed to connect I2C to ISP1301 USB Transceiver");\r\nret = -ENODEV;\r\ngoto out_i2c_driver;\r\n}\r\nisp1301_configure();\r\nusb_clk = clk_get(&pdev->dev, "ck_pll5");\r\nif (IS_ERR(usb_clk)) {\r\nerr("failed to acquire USB PLL");\r\nret = PTR_ERR(usb_clk);\r\ngoto out1;\r\n}\r\nret = clk_enable(usb_clk);\r\nif (ret < 0) {\r\nerr("failed to start USB PLL");\r\ngoto out2;\r\n}\r\nret = clk_set_rate(usb_clk, 48000);\r\nif (ret < 0) {\r\nerr("failed to set USB clock rate");\r\ngoto out3;\r\n}\r\n__raw_writel(__raw_readl(USB_CTRL) | USB_HOST_NEED_CLK_EN, USB_CTRL);\r\n__raw_writel(USB_CLOCK_MASK, USB_OTG_CLK_CTRL);\r\nwhile ((__raw_readl(USB_OTG_CLK_STAT) & USB_CLOCK_MASK) !=\r\nUSB_CLOCK_MASK) ;\r\nhcd = usb_create_hcd (driver, &pdev->dev, dev_name(&pdev->dev));\r\nif (!hcd) {\r\nerr("Failed to allocate HC buffer");\r\nret = -ENOMEM;\r\ngoto out3;\r\n}\r\npnx4008_set_usb_bits();\r\nhcd->rsrc_start = pdev->resource[0].start;\r\nhcd->rsrc_len = pdev->resource[0].end - pdev->resource[0].start + 1;\r\nif (!request_mem_region(hcd->rsrc_start, hcd->rsrc_len, hcd_name)) {\r\ndev_dbg(&pdev->dev, "request_mem_region failed\n");\r\nret = -ENOMEM;\r\ngoto out4;\r\n}\r\nhcd->regs = (void __iomem *)pdev->resource[0].start;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\nret = -ENXIO;\r\ngoto out4;\r\n}\r\npnx4008_start_hc();\r\nplatform_set_drvdata(pdev, hcd);\r\nohci = hcd_to_ohci(hcd);\r\nohci_hcd_init(ohci);\r\ndev_info(&pdev->dev, "at 0x%p, irq %d\n", hcd->regs, hcd->irq);\r\nret = usb_add_hcd(hcd, irq, IRQF_DISABLED);\r\nif (ret == 0)\r\nreturn ret;\r\npnx4008_stop_hc();\r\nout4:\r\npnx4008_unset_usb_bits();\r\nusb_put_hcd(hcd);\r\nout3:\r\nclk_disable(usb_clk);\r\nout2:\r\nclk_put(usb_clk);\r\nout1:\r\ni2c_unregister_device(isp1301_i2c_client);\r\nisp1301_i2c_client = NULL;\r\nout_i2c_driver:\r\ni2c_del_driver(&isp1301_driver);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int usb_hcd_pnx4008_remove(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nusb_remove_hcd(hcd);\r\npnx4008_stop_hc();\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nusb_put_hcd(hcd);\r\npnx4008_unset_usb_bits();\r\nclk_disable(usb_clk);\r\nclk_put(usb_clk);\r\ni2c_unregister_device(isp1301_i2c_client);\r\nisp1301_i2c_client = NULL;\r\ni2c_del_driver(&isp1301_driver);\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn 0;\r\n}

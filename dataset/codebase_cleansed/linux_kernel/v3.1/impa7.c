static int __init init_impa7(void)\r\n{\r\nstatic const char *rom_probe_types[] = PROBETYPES;\r\nconst char **type;\r\nconst char *part_type = 0;\r\nint i;\r\nstatic struct { u_long addr; u_long size; } pt[NUM_FLASHBANKS] = {\r\n{ WINDOW_ADDR0, WINDOW_SIZE0 },\r\n{ WINDOW_ADDR1, WINDOW_SIZE1 },\r\n};\r\nint devicesfound = 0;\r\nfor(i=0; i<NUM_FLASHBANKS; i++)\r\n{\r\nprintk(KERN_NOTICE MSG_PREFIX "probing 0x%08lx at 0x%08lx\n",\r\npt[i].size, pt[i].addr);\r\nimpa7_map[i].phys = pt[i].addr;\r\nimpa7_map[i].virt = ioremap(pt[i].addr, pt[i].size);\r\nif (!impa7_map[i].virt) {\r\nprintk(MSG_PREFIX "failed to ioremap\n");\r\nreturn -EIO;\r\n}\r\nsimple_map_init(&impa7_map[i]);\r\nimpa7_mtd[i] = 0;\r\ntype = rom_probe_types;\r\nfor(; !impa7_mtd[i] && *type; type++) {\r\nimpa7_mtd[i] = do_map_probe(*type, &impa7_map[i]);\r\n}\r\nif (impa7_mtd[i]) {\r\nimpa7_mtd[i]->owner = THIS_MODULE;\r\ndevicesfound++;\r\nmtd_parts_nb[i] = parse_mtd_partitions(impa7_mtd[i],\r\nprobes,\r\n&mtd_parts[i],\r\n0);\r\nif (mtd_parts_nb[i] > 0) {\r\npart_type = "command line";\r\n} else {\r\nmtd_parts[i] = static_partitions;\r\nmtd_parts_nb[i] = ARRAY_SIZE(static_partitions);\r\npart_type = "static";\r\n}\r\nprintk(KERN_NOTICE MSG_PREFIX\r\n"using %s partition definition\n",\r\npart_type);\r\nmtd_device_register(impa7_mtd[i],\r\nmtd_parts[i], mtd_parts_nb[i]);\r\n}\r\nelse\r\niounmap((void *)impa7_map[i].virt);\r\n}\r\nreturn devicesfound == 0 ? -ENXIO : 0;\r\n}\r\nstatic void __exit cleanup_impa7(void)\r\n{\r\nint i;\r\nfor (i=0; i<NUM_FLASHBANKS; i++) {\r\nif (impa7_mtd[i]) {\r\nmtd_device_unregister(impa7_mtd[i]);\r\nmap_destroy(impa7_mtd[i]);\r\niounmap((void *)impa7_map[i].virt);\r\nimpa7_map[i].virt = 0;\r\n}\r\n}\r\n}

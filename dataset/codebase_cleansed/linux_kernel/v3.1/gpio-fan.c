static void fan_alarm_notify(struct work_struct *ws)\r\n{\r\nstruct gpio_fan_data *fan_data =\r\ncontainer_of(ws, struct gpio_fan_data, alarm_work);\r\nsysfs_notify(&fan_data->pdev->dev.kobj, NULL, "fan1_alarm");\r\nkobject_uevent(&fan_data->pdev->dev.kobj, KOBJ_CHANGE);\r\n}\r\nstatic irqreturn_t fan_alarm_irq_handler(int irq, void *dev_id)\r\n{\r\nstruct gpio_fan_data *fan_data = dev_id;\r\nschedule_work(&fan_data->alarm_work);\r\nreturn IRQ_NONE;\r\n}\r\nstatic ssize_t show_fan_alarm(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct gpio_fan_data *fan_data = dev_get_drvdata(dev);\r\nstruct gpio_fan_alarm *alarm = fan_data->alarm;\r\nint value = gpio_get_value(alarm->gpio);\r\nif (alarm->active_low)\r\nvalue = !value;\r\nreturn sprintf(buf, "%d\n", value);\r\n}\r\nstatic int fan_alarm_init(struct gpio_fan_data *fan_data,\r\nstruct gpio_fan_alarm *alarm)\r\n{\r\nint err;\r\nint alarm_irq;\r\nstruct platform_device *pdev = fan_data->pdev;\r\nfan_data->alarm = alarm;\r\nerr = gpio_request(alarm->gpio, "GPIO fan alarm");\r\nif (err)\r\nreturn err;\r\nerr = gpio_direction_input(alarm->gpio);\r\nif (err)\r\ngoto err_free_gpio;\r\nerr = device_create_file(&pdev->dev, &dev_attr_fan1_alarm);\r\nif (err)\r\ngoto err_free_gpio;\r\nalarm_irq = gpio_to_irq(alarm->gpio);\r\nif (alarm_irq < 0)\r\nreturn 0;\r\nINIT_WORK(&fan_data->alarm_work, fan_alarm_notify);\r\nirq_set_irq_type(alarm_irq, IRQ_TYPE_EDGE_BOTH);\r\nerr = request_irq(alarm_irq, fan_alarm_irq_handler, IRQF_SHARED,\r\n"GPIO fan alarm", fan_data);\r\nif (err)\r\ngoto err_free_sysfs;\r\nreturn 0;\r\nerr_free_sysfs:\r\ndevice_remove_file(&pdev->dev, &dev_attr_fan1_alarm);\r\nerr_free_gpio:\r\ngpio_free(alarm->gpio);\r\nreturn err;\r\n}\r\nstatic void fan_alarm_free(struct gpio_fan_data *fan_data)\r\n{\r\nstruct platform_device *pdev = fan_data->pdev;\r\nint alarm_irq = gpio_to_irq(fan_data->alarm->gpio);\r\nif (alarm_irq >= 0)\r\nfree_irq(alarm_irq, fan_data);\r\ndevice_remove_file(&pdev->dev, &dev_attr_fan1_alarm);\r\ngpio_free(fan_data->alarm->gpio);\r\n}\r\nstatic void __set_fan_ctrl(struct gpio_fan_data *fan_data, int ctrl_val)\r\n{\r\nint i;\r\nfor (i = 0; i < fan_data->num_ctrl; i++)\r\ngpio_set_value(fan_data->ctrl[i], (ctrl_val >> i) & 1);\r\n}\r\nstatic int __get_fan_ctrl(struct gpio_fan_data *fan_data)\r\n{\r\nint i;\r\nint ctrl_val = 0;\r\nfor (i = 0; i < fan_data->num_ctrl; i++) {\r\nint value;\r\nvalue = gpio_get_value(fan_data->ctrl[i]);\r\nctrl_val |= (value << i);\r\n}\r\nreturn ctrl_val;\r\n}\r\nstatic void set_fan_speed(struct gpio_fan_data *fan_data, int speed_index)\r\n{\r\nif (fan_data->speed_index == speed_index)\r\nreturn;\r\n__set_fan_ctrl(fan_data, fan_data->speed[speed_index].ctrl_val);\r\nfan_data->speed_index = speed_index;\r\n}\r\nstatic int get_fan_speed_index(struct gpio_fan_data *fan_data)\r\n{\r\nint ctrl_val = __get_fan_ctrl(fan_data);\r\nint i;\r\nfor (i = 0; i < fan_data->num_speed; i++)\r\nif (fan_data->speed[i].ctrl_val == ctrl_val)\r\nreturn i;\r\ndev_warn(&fan_data->pdev->dev,\r\n"missing speed array entry for GPIO value 0x%x\n", ctrl_val);\r\nreturn -EINVAL;\r\n}\r\nstatic int rpm_to_speed_index(struct gpio_fan_data *fan_data, int rpm)\r\n{\r\nstruct gpio_fan_speed *speed = fan_data->speed;\r\nint i;\r\nfor (i = 0; i < fan_data->num_speed; i++)\r\nif (speed[i].rpm >= rpm)\r\nreturn i;\r\nreturn fan_data->num_speed - 1;\r\n}\r\nstatic ssize_t show_pwm(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct gpio_fan_data *fan_data = dev_get_drvdata(dev);\r\nu8 pwm = fan_data->speed_index * 255 / (fan_data->num_speed - 1);\r\nreturn sprintf(buf, "%d\n", pwm);\r\n}\r\nstatic ssize_t set_pwm(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct gpio_fan_data *fan_data = dev_get_drvdata(dev);\r\nunsigned long pwm;\r\nint speed_index;\r\nint ret = count;\r\nif (strict_strtoul(buf, 10, &pwm) || pwm > 255)\r\nreturn -EINVAL;\r\nmutex_lock(&fan_data->lock);\r\nif (!fan_data->pwm_enable) {\r\nret = -EPERM;\r\ngoto exit_unlock;\r\n}\r\nspeed_index = DIV_ROUND_UP(pwm * (fan_data->num_speed - 1), 255);\r\nset_fan_speed(fan_data, speed_index);\r\nexit_unlock:\r\nmutex_unlock(&fan_data->lock);\r\nreturn ret;\r\n}\r\nstatic ssize_t show_pwm_enable(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct gpio_fan_data *fan_data = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%d\n", fan_data->pwm_enable);\r\n}\r\nstatic ssize_t set_pwm_enable(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct gpio_fan_data *fan_data = dev_get_drvdata(dev);\r\nunsigned long val;\r\nif (strict_strtoul(buf, 10, &val) || val > 1)\r\nreturn -EINVAL;\r\nif (fan_data->pwm_enable == val)\r\nreturn count;\r\nmutex_lock(&fan_data->lock);\r\nfan_data->pwm_enable = val;\r\nif (val == 0)\r\nset_fan_speed(fan_data, fan_data->num_speed - 1);\r\nmutex_unlock(&fan_data->lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_pwm_mode(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "0\n");\r\n}\r\nstatic ssize_t show_rpm_min(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct gpio_fan_data *fan_data = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%d\n", fan_data->speed[0].rpm);\r\n}\r\nstatic ssize_t show_rpm_max(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct gpio_fan_data *fan_data = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%d\n",\r\nfan_data->speed[fan_data->num_speed - 1].rpm);\r\n}\r\nstatic ssize_t show_rpm(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct gpio_fan_data *fan_data = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%d\n", fan_data->speed[fan_data->speed_index].rpm);\r\n}\r\nstatic ssize_t set_rpm(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct gpio_fan_data *fan_data = dev_get_drvdata(dev);\r\nunsigned long rpm;\r\nint ret = count;\r\nif (strict_strtoul(buf, 10, &rpm))\r\nreturn -EINVAL;\r\nmutex_lock(&fan_data->lock);\r\nif (!fan_data->pwm_enable) {\r\nret = -EPERM;\r\ngoto exit_unlock;\r\n}\r\nset_fan_speed(fan_data, rpm_to_speed_index(fan_data, rpm));\r\nexit_unlock:\r\nmutex_unlock(&fan_data->lock);\r\nreturn ret;\r\n}\r\nstatic int fan_ctrl_init(struct gpio_fan_data *fan_data,\r\nstruct gpio_fan_platform_data *pdata)\r\n{\r\nstruct platform_device *pdev = fan_data->pdev;\r\nint num_ctrl = pdata->num_ctrl;\r\nunsigned *ctrl = pdata->ctrl;\r\nint i, err;\r\nfor (i = 0; i < num_ctrl; i++) {\r\nerr = gpio_request(ctrl[i], "GPIO fan control");\r\nif (err)\r\ngoto err_free_gpio;\r\nerr = gpio_direction_output(ctrl[i], gpio_get_value(ctrl[i]));\r\nif (err) {\r\ngpio_free(ctrl[i]);\r\ngoto err_free_gpio;\r\n}\r\n}\r\nfan_data->num_ctrl = num_ctrl;\r\nfan_data->ctrl = ctrl;\r\nfan_data->num_speed = pdata->num_speed;\r\nfan_data->speed = pdata->speed;\r\nfan_data->pwm_enable = true;\r\nfan_data->speed_index = get_fan_speed_index(fan_data);\r\nif (fan_data->speed_index < 0) {\r\nerr = -ENODEV;\r\ngoto err_free_gpio;\r\n}\r\nerr = sysfs_create_group(&pdev->dev.kobj, &gpio_fan_ctrl_group);\r\nif (err)\r\ngoto err_free_gpio;\r\nreturn 0;\r\nerr_free_gpio:\r\nfor (i = i - 1; i >= 0; i--)\r\ngpio_free(ctrl[i]);\r\nreturn err;\r\n}\r\nstatic void fan_ctrl_free(struct gpio_fan_data *fan_data)\r\n{\r\nstruct platform_device *pdev = fan_data->pdev;\r\nint i;\r\nsysfs_remove_group(&pdev->dev.kobj, &gpio_fan_ctrl_group);\r\nfor (i = 0; i < fan_data->num_ctrl; i++)\r\ngpio_free(fan_data->ctrl[i]);\r\n}\r\nstatic ssize_t show_name(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "gpio-fan\n");\r\n}\r\nstatic int __devinit gpio_fan_probe(struct platform_device *pdev)\r\n{\r\nint err;\r\nstruct gpio_fan_data *fan_data;\r\nstruct gpio_fan_platform_data *pdata = pdev->dev.platform_data;\r\nif (!pdata)\r\nreturn -EINVAL;\r\nfan_data = kzalloc(sizeof(struct gpio_fan_data), GFP_KERNEL);\r\nif (!fan_data)\r\nreturn -ENOMEM;\r\nfan_data->pdev = pdev;\r\nplatform_set_drvdata(pdev, fan_data);\r\nmutex_init(&fan_data->lock);\r\nif (pdata->alarm) {\r\nerr = fan_alarm_init(fan_data, pdata->alarm);\r\nif (err)\r\ngoto err_free_data;\r\n}\r\nif (pdata->ctrl && pdata->num_ctrl > 0) {\r\nif (!pdata->speed || pdata->num_speed <= 1) {\r\nerr = -EINVAL;\r\ngoto err_free_alarm;\r\n}\r\nerr = fan_ctrl_init(fan_data, pdata);\r\nif (err)\r\ngoto err_free_alarm;\r\n}\r\nerr = device_create_file(&pdev->dev, &dev_attr_name);\r\nif (err)\r\ngoto err_free_ctrl;\r\nfan_data->hwmon_dev = hwmon_device_register(&pdev->dev);\r\nif (IS_ERR(fan_data->hwmon_dev)) {\r\nerr = PTR_ERR(fan_data->hwmon_dev);\r\ngoto err_remove_name;\r\n}\r\ndev_info(&pdev->dev, "GPIO fan initialized\n");\r\nreturn 0;\r\nerr_remove_name:\r\ndevice_remove_file(&pdev->dev, &dev_attr_name);\r\nerr_free_ctrl:\r\nif (fan_data->ctrl)\r\nfan_ctrl_free(fan_data);\r\nerr_free_alarm:\r\nif (fan_data->alarm)\r\nfan_alarm_free(fan_data);\r\nerr_free_data:\r\nplatform_set_drvdata(pdev, NULL);\r\nkfree(fan_data);\r\nreturn err;\r\n}\r\nstatic int __devexit gpio_fan_remove(struct platform_device *pdev)\r\n{\r\nstruct gpio_fan_data *fan_data = platform_get_drvdata(pdev);\r\nhwmon_device_unregister(fan_data->hwmon_dev);\r\ndevice_remove_file(&pdev->dev, &dev_attr_name);\r\nif (fan_data->alarm)\r\nfan_alarm_free(fan_data);\r\nif (fan_data->ctrl)\r\nfan_ctrl_free(fan_data);\r\nkfree(fan_data);\r\nreturn 0;\r\n}\r\nstatic int gpio_fan_suspend(struct platform_device *pdev, pm_message_t state)\r\n{\r\nstruct gpio_fan_data *fan_data = platform_get_drvdata(pdev);\r\nif (fan_data->ctrl) {\r\nfan_data->resume_speed = fan_data->speed_index;\r\nset_fan_speed(fan_data, 0);\r\n}\r\nreturn 0;\r\n}\r\nstatic int gpio_fan_resume(struct platform_device *pdev)\r\n{\r\nstruct gpio_fan_data *fan_data = platform_get_drvdata(pdev);\r\nif (fan_data->ctrl)\r\nset_fan_speed(fan_data, fan_data->resume_speed);\r\nreturn 0;\r\n}\r\nstatic int __init gpio_fan_init(void)\r\n{\r\nreturn platform_driver_register(&gpio_fan_driver);\r\n}\r\nstatic void __exit gpio_fan_exit(void)\r\n{\r\nplatform_driver_unregister(&gpio_fan_driver);\r\n}

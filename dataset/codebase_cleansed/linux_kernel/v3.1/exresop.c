static acpi_status\r\nacpi_ex_check_object_type(acpi_object_type type_needed,\r\nacpi_object_type this_type, void *object)\r\n{\r\nACPI_FUNCTION_ENTRY();\r\nif (type_needed == ACPI_TYPE_ANY) {\r\nreturn (AE_OK);\r\n}\r\nif (type_needed == ACPI_TYPE_LOCAL_REFERENCE) {\r\nif ((this_type == ACPI_TYPE_INTEGER) &&\r\n(((union acpi_operand_object *)object)->common.\r\nflags & AOPOBJ_AML_CONSTANT)) {\r\nreturn (AE_OK);\r\n}\r\n}\r\nif (type_needed != this_type) {\r\nACPI_ERROR((AE_INFO,\r\n"Needed type [%s], found [%s] %p",\r\nacpi_ut_get_type_name(type_needed),\r\nacpi_ut_get_type_name(this_type), object));\r\nreturn (AE_AML_OPERAND_TYPE);\r\n}\r\nreturn (AE_OK);\r\n}\r\nacpi_status\r\nacpi_ex_resolve_operands(u16 opcode,\r\nunion acpi_operand_object ** stack_ptr,\r\nstruct acpi_walk_state * walk_state)\r\n{\r\nunion acpi_operand_object *obj_desc;\r\nacpi_status status = AE_OK;\r\nu8 object_type;\r\nu32 arg_types;\r\nconst struct acpi_opcode_info *op_info;\r\nu32 this_arg_type;\r\nacpi_object_type type_needed;\r\nu16 target_op = 0;\r\nACPI_FUNCTION_TRACE_U32(ex_resolve_operands, opcode);\r\nop_info = acpi_ps_get_opcode_info(opcode);\r\nif (op_info->class == AML_CLASS_UNKNOWN) {\r\nreturn_ACPI_STATUS(AE_AML_BAD_OPCODE);\r\n}\r\narg_types = op_info->runtime_args;\r\nif (arg_types == ARGI_INVALID_OPCODE) {\r\nACPI_ERROR((AE_INFO, "Unknown AML opcode 0x%X", opcode));\r\nreturn_ACPI_STATUS(AE_AML_INTERNAL);\r\n}\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC,\r\n"Opcode %X [%s] RequiredOperandTypes=%8.8X\n",\r\nopcode, op_info->name, arg_types));\r\nwhile (GET_CURRENT_ARG_TYPE(arg_types)) {\r\nif (!stack_ptr || !*stack_ptr) {\r\nACPI_ERROR((AE_INFO, "Null stack entry at %p",\r\nstack_ptr));\r\nreturn_ACPI_STATUS(AE_AML_INTERNAL);\r\n}\r\nobj_desc = *stack_ptr;\r\nswitch (ACPI_GET_DESCRIPTOR_TYPE(obj_desc)) {\r\ncase ACPI_DESC_TYPE_NAMED:\r\nobject_type =\r\n((struct acpi_namespace_node *)obj_desc)->type;\r\nif (object_type == ACPI_TYPE_LOCAL_ALIAS) {\r\nobj_desc =\r\nacpi_ns_get_attached_object((struct\r\nacpi_namespace_node\r\n*)obj_desc);\r\n*stack_ptr = obj_desc;\r\nobject_type =\r\n((struct acpi_namespace_node *)obj_desc)->\r\ntype;\r\n}\r\nbreak;\r\ncase ACPI_DESC_TYPE_OPERAND:\r\nobject_type = obj_desc->common.type;\r\nif (!acpi_ut_valid_object_type(object_type)) {\r\nACPI_ERROR((AE_INFO,\r\n"Bad operand object type [0x%X]",\r\nobject_type));\r\nreturn_ACPI_STATUS(AE_AML_OPERAND_TYPE);\r\n}\r\nif (object_type == (u8) ACPI_TYPE_LOCAL_REFERENCE) {\r\nswitch (obj_desc->reference.class) {\r\ncase ACPI_REFCLASS_DEBUG:\r\ntarget_op = AML_DEBUG_OP;\r\ncase ACPI_REFCLASS_ARG:\r\ncase ACPI_REFCLASS_LOCAL:\r\ncase ACPI_REFCLASS_INDEX:\r\ncase ACPI_REFCLASS_REFOF:\r\ncase ACPI_REFCLASS_TABLE:\r\ncase ACPI_REFCLASS_NAME:\r\nACPI_DEBUG_PRINT((ACPI_DB_EXEC,\r\n"Operand is a Reference, Class [%s] %2.2X\n",\r\nacpi_ut_get_reference_name\r\n(obj_desc),\r\nobj_desc->reference.\r\nclass));\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"Unknown Reference Class 0x%2.2X in %p",\r\nobj_desc->reference.class,\r\nobj_desc));\r\nreturn_ACPI_STATUS(AE_AML_OPERAND_TYPE);\r\n}\r\n}\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO, "Invalid descriptor %p [%s]",\r\nobj_desc,\r\nacpi_ut_get_descriptor_name(obj_desc)));\r\nreturn_ACPI_STATUS(AE_AML_OPERAND_TYPE);\r\n}\r\nthis_arg_type = GET_CURRENT_ARG_TYPE(arg_types);\r\nINCREMENT_ARG_LIST(arg_types);\r\nswitch (this_arg_type) {\r\ncase ARGI_REF_OR_STRING:\r\nif ((ACPI_GET_DESCRIPTOR_TYPE(obj_desc) ==\r\nACPI_DESC_TYPE_OPERAND)\r\n&& (obj_desc->common.type == ACPI_TYPE_STRING)) {\r\ngoto next_operand;\r\n}\r\ncase ARGI_REFERENCE:\r\ncase ARGI_INTEGER_REF:\r\ncase ARGI_OBJECT_REF:\r\ncase ARGI_DEVICE_REF:\r\ncase ARGI_TARGETREF:\r\ncase ARGI_FIXED_TARGET:\r\ncase ARGI_SIMPLE_TARGET:\r\nif (ACPI_GET_DESCRIPTOR_TYPE(obj_desc) ==\r\nACPI_DESC_TYPE_NAMED) {\r\ngoto next_operand;\r\n}\r\nstatus =\r\nacpi_ex_check_object_type(ACPI_TYPE_LOCAL_REFERENCE,\r\nobject_type, obj_desc);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\ngoto next_operand;\r\ncase ARGI_DATAREFOBJ:\r\nif ((opcode == AML_STORE_OP) &&\r\n((*stack_ptr)->common.type ==\r\nACPI_TYPE_LOCAL_REFERENCE)\r\n&& ((*stack_ptr)->reference.class == ACPI_REFCLASS_INDEX)) {\r\ngoto next_operand;\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nstatus = acpi_ex_resolve_to_value(stack_ptr, walk_state);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nobj_desc = *stack_ptr;\r\nswitch (this_arg_type) {\r\ncase ARGI_MUTEX:\r\ntype_needed = ACPI_TYPE_MUTEX;\r\nbreak;\r\ncase ARGI_EVENT:\r\ntype_needed = ACPI_TYPE_EVENT;\r\nbreak;\r\ncase ARGI_PACKAGE:\r\ntype_needed = ACPI_TYPE_PACKAGE;\r\nbreak;\r\ncase ARGI_ANYTYPE:\r\ntype_needed = ACPI_TYPE_ANY;\r\nbreak;\r\ncase ARGI_DDBHANDLE:\r\ntype_needed = ACPI_TYPE_LOCAL_REFERENCE;\r\nbreak;\r\ncase ARGI_INTEGER:\r\nstatus =\r\nacpi_ex_convert_to_integer(obj_desc, stack_ptr, 16);\r\nif (ACPI_FAILURE(status)) {\r\nif (status == AE_TYPE) {\r\nACPI_ERROR((AE_INFO,\r\n"Needed [Integer/String/Buffer], found [%s] %p",\r\nacpi_ut_get_object_type_name\r\n(obj_desc), obj_desc));\r\nreturn_ACPI_STATUS(AE_AML_OPERAND_TYPE);\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}\r\nif (obj_desc != *stack_ptr) {\r\nacpi_ut_remove_reference(obj_desc);\r\n}\r\ngoto next_operand;\r\ncase ARGI_BUFFER:\r\nstatus = acpi_ex_convert_to_buffer(obj_desc, stack_ptr);\r\nif (ACPI_FAILURE(status)) {\r\nif (status == AE_TYPE) {\r\nACPI_ERROR((AE_INFO,\r\n"Needed [Integer/String/Buffer], found [%s] %p",\r\nacpi_ut_get_object_type_name\r\n(obj_desc), obj_desc));\r\nreturn_ACPI_STATUS(AE_AML_OPERAND_TYPE);\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}\r\nif (obj_desc != *stack_ptr) {\r\nacpi_ut_remove_reference(obj_desc);\r\n}\r\ngoto next_operand;\r\ncase ARGI_STRING:\r\nstatus = acpi_ex_convert_to_string(obj_desc, stack_ptr,\r\nACPI_IMPLICIT_CONVERT_HEX);\r\nif (ACPI_FAILURE(status)) {\r\nif (status == AE_TYPE) {\r\nACPI_ERROR((AE_INFO,\r\n"Needed [Integer/String/Buffer], found [%s] %p",\r\nacpi_ut_get_object_type_name\r\n(obj_desc), obj_desc));\r\nreturn_ACPI_STATUS(AE_AML_OPERAND_TYPE);\r\n}\r\nreturn_ACPI_STATUS(status);\r\n}\r\nif (obj_desc != *stack_ptr) {\r\nacpi_ut_remove_reference(obj_desc);\r\n}\r\ngoto next_operand;\r\ncase ARGI_COMPUTEDATA:\r\nswitch (obj_desc->common.type) {\r\ncase ACPI_TYPE_INTEGER:\r\ncase ACPI_TYPE_STRING:\r\ncase ACPI_TYPE_BUFFER:\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"Needed [Integer/String/Buffer], found [%s] %p",\r\nacpi_ut_get_object_type_name\r\n(obj_desc), obj_desc));\r\nreturn_ACPI_STATUS(AE_AML_OPERAND_TYPE);\r\n}\r\ngoto next_operand;\r\ncase ARGI_BUFFER_OR_STRING:\r\nswitch (obj_desc->common.type) {\r\ncase ACPI_TYPE_STRING:\r\ncase ACPI_TYPE_BUFFER:\r\nbreak;\r\ncase ACPI_TYPE_INTEGER:\r\nstatus =\r\nacpi_ex_convert_to_buffer(obj_desc,\r\nstack_ptr);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nif (obj_desc != *stack_ptr) {\r\nacpi_ut_remove_reference(obj_desc);\r\n}\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"Needed [Integer/String/Buffer], found [%s] %p",\r\nacpi_ut_get_object_type_name\r\n(obj_desc), obj_desc));\r\nreturn_ACPI_STATUS(AE_AML_OPERAND_TYPE);\r\n}\r\ngoto next_operand;\r\ncase ARGI_DATAOBJECT:\r\nswitch (obj_desc->common.type) {\r\ncase ACPI_TYPE_PACKAGE:\r\ncase ACPI_TYPE_STRING:\r\ncase ACPI_TYPE_BUFFER:\r\ncase ACPI_TYPE_LOCAL_REFERENCE:\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"Needed [Buffer/String/Package/Reference], found [%s] %p",\r\nacpi_ut_get_object_type_name\r\n(obj_desc), obj_desc));\r\nreturn_ACPI_STATUS(AE_AML_OPERAND_TYPE);\r\n}\r\ngoto next_operand;\r\ncase ARGI_COMPLEXOBJ:\r\nswitch (obj_desc->common.type) {\r\ncase ACPI_TYPE_PACKAGE:\r\ncase ACPI_TYPE_STRING:\r\ncase ACPI_TYPE_BUFFER:\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"Needed [Buffer/String/Package], found [%s] %p",\r\nacpi_ut_get_object_type_name\r\n(obj_desc), obj_desc));\r\nreturn_ACPI_STATUS(AE_AML_OPERAND_TYPE);\r\n}\r\ngoto next_operand;\r\ncase ARGI_REGION_OR_BUFFER:\r\nswitch (obj_desc->common.type) {\r\ncase ACPI_TYPE_BUFFER:\r\ncase ACPI_TYPE_REGION:\r\nbreak;\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"Needed [Region/Buffer], found [%s] %p",\r\nacpi_ut_get_object_type_name\r\n(obj_desc), obj_desc));\r\nreturn_ACPI_STATUS(AE_AML_OPERAND_TYPE);\r\n}\r\ngoto next_operand;\r\ncase ARGI_DATAREFOBJ:\r\nswitch (obj_desc->common.type) {\r\ncase ACPI_TYPE_INTEGER:\r\ncase ACPI_TYPE_PACKAGE:\r\ncase ACPI_TYPE_STRING:\r\ncase ACPI_TYPE_BUFFER:\r\ncase ACPI_TYPE_BUFFER_FIELD:\r\ncase ACPI_TYPE_LOCAL_REFERENCE:\r\ncase ACPI_TYPE_LOCAL_REGION_FIELD:\r\ncase ACPI_TYPE_LOCAL_BANK_FIELD:\r\ncase ACPI_TYPE_LOCAL_INDEX_FIELD:\r\ncase ACPI_TYPE_DDB_HANDLE:\r\nbreak;\r\ndefault:\r\nif (acpi_gbl_enable_interpreter_slack) {\r\nbreak;\r\n}\r\nif (target_op == AML_DEBUG_OP) {\r\nbreak;\r\n}\r\nACPI_ERROR((AE_INFO,\r\n"Needed Integer/Buffer/String/Package/Ref/Ddb], found [%s] %p",\r\nacpi_ut_get_object_type_name\r\n(obj_desc), obj_desc));\r\nreturn_ACPI_STATUS(AE_AML_OPERAND_TYPE);\r\n}\r\ngoto next_operand;\r\ndefault:\r\nACPI_ERROR((AE_INFO,\r\n"Internal - Unknown ARGI (required operand) type 0x%X",\r\nthis_arg_type));\r\nreturn_ACPI_STATUS(AE_BAD_PARAMETER);\r\n}\r\nstatus = acpi_ex_check_object_type(type_needed,\r\n(*stack_ptr)->common.type,\r\n*stack_ptr);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nnext_operand:\r\nif (GET_CURRENT_ARG_TYPE(arg_types)) {\r\nstack_ptr--;\r\n}\r\n}\r\nACPI_DUMP_OPERANDS(walk_state->operands,\r\nacpi_ps_get_opcode_name(opcode),\r\nwalk_state->num_operands);\r\nreturn_ACPI_STATUS(status);\r\n}

static int wm831x_spi_read_device(struct wm831x *wm831x, unsigned short reg,\r\nint bytes, void *dest)\r\n{\r\nu16 tx_val;\r\nu16 *d = dest;\r\nint r, ret;\r\nfor (r = reg; r < reg + (bytes / 2); r++) {\r\ntx_val = r | 0x8000;\r\nret = spi_write_then_read(wm831x->control_data,\r\n(u8 *)&tx_val, 2, (u8 *)d, 2);\r\nif (ret != 0)\r\nreturn ret;\r\n*d = be16_to_cpu(*d);\r\nd++;\r\n}\r\nreturn 0;\r\n}\r\nstatic int wm831x_spi_write_device(struct wm831x *wm831x, unsigned short reg,\r\nint bytes, void *src)\r\n{\r\nstruct spi_device *spi = wm831x->control_data;\r\nu16 *s = src;\r\nu16 data[2];\r\nint ret, r;\r\nfor (r = reg; r < reg + (bytes / 2); r++) {\r\ndata[0] = r;\r\ndata[1] = *s++;\r\nret = spi_write(spi, (char *)&data, sizeof(data));\r\nif (ret != 0)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devinit wm831x_spi_probe(struct spi_device *spi)\r\n{\r\nstruct wm831x *wm831x;\r\nenum wm831x_parent type;\r\nif (strcmp(spi->modalias, "wm8310") == 0)\r\ntype = WM8310;\r\nelse if (strcmp(spi->modalias, "wm8311") == 0)\r\ntype = WM8311;\r\nelse if (strcmp(spi->modalias, "wm8312") == 0)\r\ntype = WM8312;\r\nelse if (strcmp(spi->modalias, "wm8320") == 0)\r\ntype = WM8320;\r\nelse if (strcmp(spi->modalias, "wm8321") == 0)\r\ntype = WM8321;\r\nelse if (strcmp(spi->modalias, "wm8325") == 0)\r\ntype = WM8325;\r\nelse if (strcmp(spi->modalias, "wm8326") == 0)\r\ntype = WM8326;\r\nelse {\r\ndev_err(&spi->dev, "Unknown device type\n");\r\nreturn -EINVAL;\r\n}\r\nwm831x = kzalloc(sizeof(struct wm831x), GFP_KERNEL);\r\nif (wm831x == NULL)\r\nreturn -ENOMEM;\r\nspi->bits_per_word = 16;\r\nspi->mode = SPI_MODE_0;\r\ndev_set_drvdata(&spi->dev, wm831x);\r\nwm831x->dev = &spi->dev;\r\nwm831x->control_data = spi;\r\nwm831x->read_dev = wm831x_spi_read_device;\r\nwm831x->write_dev = wm831x_spi_write_device;\r\nreturn wm831x_device_init(wm831x, type, spi->irq);\r\n}\r\nstatic int __devexit wm831x_spi_remove(struct spi_device *spi)\r\n{\r\nstruct wm831x *wm831x = dev_get_drvdata(&spi->dev);\r\nwm831x_device_exit(wm831x);\r\nreturn 0;\r\n}\r\nstatic int wm831x_spi_suspend(struct device *dev)\r\n{\r\nstruct wm831x *wm831x = dev_get_drvdata(dev);\r\nreturn wm831x_device_suspend(wm831x);\r\n}\r\nstatic int __init wm831x_spi_init(void)\r\n{\r\nint ret;\r\nret = spi_register_driver(&wm8310_spi_driver);\r\nif (ret != 0)\r\npr_err("Failed to register WM8310 SPI driver: %d\n", ret);\r\nret = spi_register_driver(&wm8311_spi_driver);\r\nif (ret != 0)\r\npr_err("Failed to register WM8311 SPI driver: %d\n", ret);\r\nret = spi_register_driver(&wm8312_spi_driver);\r\nif (ret != 0)\r\npr_err("Failed to register WM8312 SPI driver: %d\n", ret);\r\nret = spi_register_driver(&wm8320_spi_driver);\r\nif (ret != 0)\r\npr_err("Failed to register WM8320 SPI driver: %d\n", ret);\r\nret = spi_register_driver(&wm8321_spi_driver);\r\nif (ret != 0)\r\npr_err("Failed to register WM8321 SPI driver: %d\n", ret);\r\nret = spi_register_driver(&wm8325_spi_driver);\r\nif (ret != 0)\r\npr_err("Failed to register WM8325 SPI driver: %d\n", ret);\r\nret = spi_register_driver(&wm8326_spi_driver);\r\nif (ret != 0)\r\npr_err("Failed to register WM8326 SPI driver: %d\n", ret);\r\nreturn 0;\r\n}\r\nstatic void __exit wm831x_spi_exit(void)\r\n{\r\nspi_unregister_driver(&wm8326_spi_driver);\r\nspi_unregister_driver(&wm8325_spi_driver);\r\nspi_unregister_driver(&wm8321_spi_driver);\r\nspi_unregister_driver(&wm8320_spi_driver);\r\nspi_unregister_driver(&wm8312_spi_driver);\r\nspi_unregister_driver(&wm8311_spi_driver);\r\nspi_unregister_driver(&wm8310_spi_driver);\r\n}

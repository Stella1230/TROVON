static inline void clear_status(void)\r\n{\r\nunsigned long pci_stat;\r\npci_stat = inl(PCI_BASE | PCI_GPPM_STATUS);\r\noutl(pci_stat, PCI_BASE | PCI_GPPM_ICLR);\r\n}\r\nstatic inline unsigned int\r\ncalc_cfg_addr(struct pci_bus *bus, unsigned int devfn, int where)\r\n{\r\nunsigned int addr;\r\naddr = ((bus->number > 0) ? (((bus->number & 0xff) << PCI_CFG_BUS_SHIFT) | 1) : 0);\r\naddr |= ((devfn & 0xff) << PCI_CFG_FUNC_SHIFT) | (where & 0xfc);\r\nreturn addr;\r\n}\r\nstatic int\r\nconfig_access(unsigned int pci_cmd, struct pci_bus *bus, unsigned int devfn, int where, unsigned int pci_mode, unsigned int *val)\r\n{\r\nunsigned int flags;\r\nunsigned long loops = 0;\r\nunsigned long ioaddr = calc_cfg_addr(bus, devfn, where);\r\nlocal_irq_save(flags);\r\nif (inl(PCI_BASE | PCI_GPPM_STATUS)) {\r\nclear_status();\r\nwhile (!(inl(PCI_BASE | PCI_GPPM_STATUS) == 0)) ;\r\n}\r\noutl(ioaddr, PCI_BASE | PCI_GPPM_ADDR);\r\nif ((pci_cmd == PCI_CMD_IOW) || (pci_cmd == PCI_CMD_CONFIG_WRITE))\r\noutl(*val, PCI_BASE | PCI_GPPM_WDAT);\r\noutl(INIT_PCI_CYCLE | pci_cmd | (pci_mode & PCI_BYTE_ENABLE_MASK),\r\nPCI_BASE | PCI_GPPM_CTRL);\r\nloops =\r\n((loops_per_jiffy *\r\nPCI_IO_JIFFIES_TIMEOUT) >> (PCI_IO_JIFFIES_SHIFT));\r\nwhile (1) {\r\nif (inl(PCI_BASE | PCI_GPPM_STATUS) & GPPM_DONE) {\r\nif ((pci_cmd == PCI_CMD_IOR) ||\r\n(pci_cmd == PCI_CMD_CONFIG_READ))\r\n*val = inl(PCI_BASE | PCI_GPPM_RDAT);\r\nclear_status();\r\nlocal_irq_restore(flags);\r\nreturn PCIBIOS_SUCCESSFUL;\r\n} else if (inl(PCI_BASE | PCI_GPPM_STATUS) & GPPM_R_MABORT) {\r\nbreak;\r\n}\r\nloops--;\r\nif (loops == 0) {\r\nprintk("%s : Arbiter Locked.\n", __func__);\r\n}\r\n}\r\nclear_status();\r\nif ((pci_cmd == PCI_CMD_IOR) || (pci_cmd == PCI_CMD_IOW)) {\r\nprintk("%s timeout (GPPM_CTRL=%X) ioaddr %lX pci_cmd %X\n",\r\n__func__, inl(PCI_BASE | PCI_GPPM_CTRL), ioaddr,\r\npci_cmd);\r\n}\r\nif ((pci_cmd == PCI_CMD_IOR) || (pci_cmd == PCI_CMD_CONFIG_READ))\r\n*val = 0xffffffff;\r\nlocal_irq_restore(flags);\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\n}\r\nstatic int\r\nread_config_byte(struct pci_bus *bus, unsigned int devfn, int where, u8 * val)\r\n{\r\nunsigned int data = 0;\r\nint err;\r\nif (bus == NULL)\r\nreturn -1;\r\nerr = config_access(PCI_CMD_CONFIG_READ, bus, devfn, where, ~(1 << (where & 3)), &data);\r\nswitch (where & 0x03) {\r\ncase 0:\r\n*val = (unsigned char)(data & 0x000000ff);\r\nbreak;\r\ncase 1:\r\n*val = (unsigned char)((data & 0x0000ff00) >> 8);\r\nbreak;\r\ncase 2:\r\n*val = (unsigned char)((data & 0x00ff0000) >> 16);\r\nbreak;\r\ncase 3:\r\n*val = (unsigned char)((data & 0xff000000) >> 24);\r\nbreak;\r\n}\r\nreturn err;\r\n}\r\nstatic int\r\nread_config_word(struct pci_bus *bus, unsigned int devfn, int where, u16 * val)\r\n{\r\nunsigned int data = 0;\r\nint err;\r\nif (bus == NULL)\r\nreturn -1;\r\nif (where & 0x01)\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\nerr = config_access(PCI_CMD_CONFIG_READ, bus, devfn, where, ~(3 << (where & 3)), &data);\r\nswitch (where & 0x02) {\r\ncase 0:\r\n*val = (unsigned short)(data & 0x0000ffff);\r\nbreak;\r\ncase 2:\r\n*val = (unsigned short)((data & 0xffff0000) >> 16);\r\nbreak;\r\n}\r\nreturn err;\r\n}\r\nstatic int\r\nread_config_dword(struct pci_bus *bus, unsigned int devfn, int where, u32 * val)\r\n{\r\nint err;\r\nif (bus == NULL)\r\nreturn -1;\r\nif (where & 0x03)\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\nerr = config_access(PCI_CMD_CONFIG_READ, bus, devfn, where, 0, val);\r\nreturn err;\r\n}\r\nstatic int\r\nwrite_config_byte(struct pci_bus *bus, unsigned int devfn, int where, u8 val)\r\n{\r\nunsigned int data = (unsigned int)val;\r\nint err;\r\nif (bus == NULL)\r\nreturn -1;\r\nswitch (where & 0x03) {\r\ncase 1:\r\ndata = (data << 8);\r\nbreak;\r\ncase 2:\r\ndata = (data << 16);\r\nbreak;\r\ncase 3:\r\ndata = (data << 24);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nerr = config_access(PCI_CMD_CONFIG_WRITE, bus, devfn, where, ~(1 << (where & 3)), &data);\r\nreturn err;\r\n}\r\nstatic int\r\nwrite_config_word(struct pci_bus *bus, unsigned int devfn, int where, u16 val)\r\n{\r\nunsigned int data = (unsigned int)val;\r\nint err;\r\nif (bus == NULL)\r\nreturn -1;\r\nif (where & 0x01)\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\nswitch (where & 0x02) {\r\ncase 2:\r\ndata = (data << 16);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nerr = config_access(PCI_CMD_CONFIG_WRITE, bus, devfn, where, ~(3 << (where & 3)), &data);\r\nreturn err;\r\n}\r\nstatic int\r\nwrite_config_dword(struct pci_bus *bus, unsigned int devfn, int where, u32 val)\r\n{\r\nint err;\r\nif (bus == NULL)\r\nreturn -1;\r\nif (where & 0x03)\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\nerr = config_access(PCI_CMD_CONFIG_WRITE, bus, devfn, where, 0, &val);\r\nreturn err;\r\n}\r\nstatic int config_read(struct pci_bus *bus, unsigned int devfn, int where, int size, u32 * val)\r\n{\r\nswitch (size) {\r\ncase 1: {\r\nu8 _val;\r\nint rc = read_config_byte(bus, devfn, where, &_val);\r\n*val = _val;\r\nreturn rc;\r\n}\r\ncase 2: {\r\nu16 _val;\r\nint rc = read_config_word(bus, devfn, where, &_val);\r\n*val = _val;\r\nreturn rc;\r\n}\r\ndefault:\r\nreturn read_config_dword(bus, devfn, where, val);\r\n}\r\n}\r\nstatic int config_write(struct pci_bus *bus, unsigned int devfn, int where, int size, u32 val)\r\n{\r\nswitch (size) {\r\ncase 1:\r\nreturn write_config_byte(bus, devfn, where, (u8) val);\r\ncase 2:\r\nreturn write_config_word(bus, devfn, where, (u16) val);\r\ndefault:\r\nreturn write_config_dword(bus, devfn, where, val);\r\n}\r\n}

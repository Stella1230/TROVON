static void complain_about_jumpering(const char *whom,\r\nconst char *supply,\r\nint given, int wanted)\r\n{\r\nprintk(KERN_ERR\r\n"%s: %s %d.%dV wanted but board is jumpered for %s %d.%dV operation"\r\n"; re-jumper the board and/or use pcmv=xx,xx,xx\n",\r\nwhom, supply,\r\nwanted / 10, wanted % 10,\r\nsupply,\r\ngiven / 10, given % 10);\r\n}\r\nstatic int\r\nbadge4_pcmcia_configure_socket(struct soc_pcmcia_socket *skt, const socket_state_t *state)\r\n{\r\nint ret;\r\nswitch (skt->nr) {\r\ncase 0:\r\nif ((state->Vcc != 0) &&\r\n(state->Vcc != badge4_pcmvcc)) {\r\ncomplain_about_jumpering(__func__, "pcmvcc",\r\nbadge4_pcmvcc, state->Vcc);\r\n}\r\nif ((state->Vpp != 0) &&\r\n(state->Vpp != badge4_pcmvpp)) {\r\ncomplain_about_jumpering(__func__, "pcmvpp",\r\nbadge4_pcmvpp, state->Vpp);\r\nreturn -1;\r\n}\r\nbreak;\r\ncase 1:\r\nif ((state->Vcc != 0) &&\r\n(state->Vcc != badge4_cfvcc)) {\r\ncomplain_about_jumpering(__func__, "cfvcc",\r\nbadge4_cfvcc, state->Vcc);\r\nreturn -1;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -1;\r\n}\r\nret = sa1111_pcmcia_configure_socket(skt, state);\r\nif (ret == 0) {\r\nunsigned long flags;\r\nint need5V;\r\nlocal_irq_save(flags);\r\nneed5V = ((state->Vcc == 50) || (state->Vpp == 50));\r\nbadge4_set_5V(BADGE4_5V_PCMCIA_SOCK(skt->nr), need5V);\r\nlocal_irq_restore(flags);\r\n}\r\nreturn 0;\r\n}\r\nint pcmcia_badge4_init(struct device *dev)\r\n{\r\nint ret = -ENODEV;\r\nif (machine_is_badge4()) {\r\nprintk(KERN_INFO\r\n"%s: badge4_pcmvcc=%d, badge4_pcmvpp=%d, badge4_cfvcc=%d\n",\r\n__func__,\r\nbadge4_pcmvcc, badge4_pcmvpp, badge4_cfvcc);\r\nsa11xx_drv_pcmcia_ops(&badge4_pcmcia_ops);\r\nret = sa1111_pcmcia_add(dev, &badge4_pcmcia_ops,\r\nsa11xx_drv_pcmcia_add_one);\r\n}\r\nreturn ret;\r\n}\r\nstatic int __init pcmv_setup(char *s)\r\n{\r\nint v[4];\r\ns = get_options(s, ARRAY_SIZE(v), v);\r\nif (v[0] >= 1) badge4_pcmvcc = v[1];\r\nif (v[0] >= 2) badge4_pcmvpp = v[2];\r\nif (v[0] >= 3) badge4_cfvcc = v[3];\r\nreturn 1;\r\n}

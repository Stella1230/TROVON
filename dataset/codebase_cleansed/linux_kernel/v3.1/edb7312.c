static void ep7312_hwcontrol(struct mtd_info *mtd, int cmd, unsigned int ctrl)\r\n{\r\nstruct nand_chip *chip = mtd->priv;\r\nif (ctrl & NAND_CTRL_CHANGE) {\r\nunsigned char bits = 0x80;\r\nbits |= (ctrl & (NAND_CLE | NAND_ALE)) << 3;\r\nbits |= (ctrl & NAND_NCE) ? 0x00 : 0x40;\r\nclps_writeb((clps_readb(ep7312_pxdr) & 0xF0) | bits,\r\nep7312_pxdr);\r\n}\r\nif (cmd != NAND_CMD_NONE)\r\nwriteb(cmd, chip->IO_ADDR_W);\r\n}\r\nstatic int ep7312_device_ready(struct mtd_info *mtd)\r\n{\r\nreturn 1;\r\n}\r\nstatic int __init ep7312_init(void)\r\n{\r\nstruct nand_chip *this;\r\nconst char *part_type = 0;\r\nint mtd_parts_nb = 0;\r\nstruct mtd_partition *mtd_parts = 0;\r\nvoid __iomem *ep7312_fio_base;\r\nep7312_mtd = kmalloc(sizeof(struct mtd_info) + sizeof(struct nand_chip), GFP_KERNEL);\r\nif (!ep7312_mtd) {\r\nprintk("Unable to allocate EDB7312 NAND MTD device structure.\n");\r\nreturn -ENOMEM;\r\n}\r\nep7312_fio_base = ioremap(ep7312_fio_pbase, SZ_1K);\r\nif (!ep7312_fio_base) {\r\nprintk("ioremap EDB7312 NAND flash failed\n");\r\nkfree(ep7312_mtd);\r\nreturn -EIO;\r\n}\r\nthis = (struct nand_chip *)(&ep7312_mtd[1]);\r\nmemset(ep7312_mtd, 0, sizeof(struct mtd_info));\r\nmemset(this, 0, sizeof(struct nand_chip));\r\nep7312_mtd->priv = this;\r\nep7312_mtd->owner = THIS_MODULE;\r\nclps_writeb(0xf0, ep7312_pxddr);\r\nthis->IO_ADDR_R = ep7312_fio_base;\r\nthis->IO_ADDR_W = ep7312_fio_base;\r\nthis->cmd_ctrl = ep7312_hwcontrol;\r\nthis->dev_ready = ep7312_device_ready;\r\nthis->chip_delay = 15;\r\nif (nand_scan(ep7312_mtd, 1)) {\r\niounmap((void *)ep7312_fio_base);\r\nkfree(ep7312_mtd);\r\nreturn -ENXIO;\r\n}\r\nep7312_mtd->name = "edb7312-nand";\r\nmtd_parts_nb = parse_mtd_partitions(ep7312_mtd, part_probes, &mtd_parts, 0);\r\nif (mtd_parts_nb > 0)\r\npart_type = "command line";\r\nelse\r\nmtd_parts_nb = 0;\r\nif (mtd_parts_nb == 0) {\r\nmtd_parts = partition_info;\r\nmtd_parts_nb = NUM_PARTITIONS;\r\npart_type = "static";\r\n}\r\nprintk(KERN_NOTICE "Using %s partition definition\n", part_type);\r\nmtd_device_register(ep7312_mtd, mtd_parts, mtd_parts_nb);\r\nreturn 0;\r\n}\r\nstatic void __exit ep7312_cleanup(void)\r\n{\r\nstruct nand_chip *this = (struct nand_chip *)&ep7312_mtd[1];\r\nnand_release(ap7312_mtd);\r\niounmap(this->IO_ADDR_R);\r\nkfree(ep7312_mtd);\r\n}

static void *didd_callback(void *context, DESCRIPTOR * adapter,\r\nint removal)\r\n{\r\nif (adapter->type == IDI_DADAPTER) {\r\nDBG_ERR(("Notification about IDI_DADAPTER change ! Oops."))\r\nreturn (NULL);\r\n} else if (adapter->type == IDI_DIMAINT) {\r\nif (removal) {\r\nDbgDeregister();\r\n} else {\r\nDbgRegister("DIDD", DRIVERRELEASE_DIDD, DBG_DEFAULT);\r\n}\r\n}\r\nreturn (NULL);\r\n}\r\nstatic int DIVA_INIT_FUNCTION connect_didd(void)\r\n{\r\nint x = 0;\r\nint dadapter = 0;\r\nIDI_SYNC_REQ req;\r\nDESCRIPTOR DIDD_Table[MAX_DESCRIPTORS];\r\nDIVA_DIDD_Read(DIDD_Table, sizeof(DIDD_Table));\r\nfor (x = 0; x < MAX_DESCRIPTORS; x++) {\r\nif (DIDD_Table[x].type == IDI_DADAPTER) {\r\ndadapter = 1;\r\nmemcpy(&_DAdapter, &DIDD_Table[x], sizeof(_DAdapter));\r\nreq.didd_notify.e.Req = 0;\r\nreq.didd_notify.e.Rc =\r\nIDI_SYNC_REQ_DIDD_REGISTER_ADAPTER_NOTIFY;\r\nreq.didd_notify.info.callback = (void *)didd_callback;\r\nreq.didd_notify.info.context = NULL;\r\n_DAdapter.request((ENTITY *) & req);\r\nif (req.didd_notify.e.Rc != 0xff)\r\nreturn (0);\r\nnotify_handle = req.didd_notify.info.handle;\r\n} else if (DIDD_Table[x].type == IDI_DIMAINT) {\r\nDbgRegister("DIDD", DRIVERRELEASE_DIDD, DBG_DEFAULT);\r\n}\r\n}\r\nreturn (dadapter);\r\n}\r\nstatic void DIVA_EXIT_FUNCTION disconnect_didd(void)\r\n{\r\nIDI_SYNC_REQ req;\r\nreq.didd_notify.e.Req = 0;\r\nreq.didd_notify.e.Rc = IDI_SYNC_REQ_DIDD_REMOVE_ADAPTER_NOTIFY;\r\nreq.didd_notify.info.handle = notify_handle;\r\n_DAdapter.request((ENTITY *) & req);\r\n}\r\nint DIVA_INIT_FUNCTION diddfunc_init(void)\r\n{\r\ndiva_didd_load_time_init();\r\nif (!connect_didd()) {\r\nDBG_ERR(("init: failed to connect to DIDD."))\r\ndiva_didd_load_time_finit();\r\nreturn (0);\r\n}\r\nreturn (1);\r\n}\r\nvoid DIVA_EXIT_FUNCTION diddfunc_finit(void)\r\n{\r\nDbgDeregister();\r\ndisconnect_didd();\r\ndiva_didd_load_time_finit();\r\n}

static int __init init_mbx(void)\r\n{\r\nprintk(KERN_NOTICE "Motorola MBX flash device: 0x%x at 0x%x\n", WINDOW_SIZE*4, WINDOW_ADDR);\r\nmbx_map.virt = ioremap(WINDOW_ADDR, WINDOW_SIZE * 4);\r\nif (!mbx_map.virt) {\r\nprintk("Failed to ioremap\n");\r\nreturn -EIO;\r\n}\r\nsimple_map_init(&mbx_map);\r\nmymtd = do_map_probe("jedec_probe", &mbx_map);\r\nif (mymtd) {\r\nmymtd->owner = THIS_MODULE;\r\nmtd_device_register(mymtd, NULL, 0);\r\nmtd_device_register(mymtd, partition_info, NUM_PARTITIONS);\r\nreturn 0;\r\n}\r\niounmap((void *)mbx_map.virt);\r\nreturn -ENXIO;\r\n}\r\nstatic void __exit cleanup_mbx(void)\r\n{\r\nif (mymtd) {\r\nmtd_device_unregister(mymtd);\r\nmap_destroy(mymtd);\r\n}\r\nif (mbx_map.virt) {\r\niounmap((void *)mbx_map.virt);\r\nmbx_map.virt = 0;\r\n}\r\n}

static void smsusb_onresponse(struct urb *urb)\r\n{\r\nstruct smsusb_urb_t *surb = (struct smsusb_urb_t *) urb->context;\r\nstruct smsusb_device_t *dev = surb->dev;\r\nif (urb->status == -ESHUTDOWN) {\r\nsms_err("error, urb status %d (-ESHUTDOWN), %d bytes",\r\nurb->status, urb->actual_length);\r\nreturn;\r\n}\r\nif ((urb->actual_length > 0) && (urb->status == 0)) {\r\nstruct SmsMsgHdr_ST *phdr = (struct SmsMsgHdr_ST *)surb->cb->p;\r\nsmsendian_handle_message_header(phdr);\r\nif (urb->actual_length >= phdr->msgLength) {\r\nsurb->cb->size = phdr->msgLength;\r\nif (dev->response_alignment &&\r\n(phdr->msgFlags & MSG_HDR_FLAG_SPLIT_MSG)) {\r\nsurb->cb->offset =\r\ndev->response_alignment +\r\n((phdr->msgFlags >> 8) & 3);\r\nif (((int) phdr->msgLength +\r\nsurb->cb->offset) > urb->actual_length) {\r\nsms_err("invalid response "\r\n"msglen %d offset %d "\r\n"size %d",\r\nphdr->msgLength,\r\nsurb->cb->offset,\r\nurb->actual_length);\r\ngoto exit_and_resubmit;\r\n}\r\nmemcpy((char *) phdr + surb->cb->offset,\r\nphdr, sizeof(struct SmsMsgHdr_ST));\r\n} else\r\nsurb->cb->offset = 0;\r\nsmscore_onresponse(dev->coredev, surb->cb);\r\nsurb->cb = NULL;\r\n} else {\r\nsms_err("invalid response "\r\n"msglen %d actual %d",\r\nphdr->msgLength, urb->actual_length);\r\n}\r\n} else\r\nsms_err("error, urb status %d, %d bytes",\r\nurb->status, urb->actual_length);\r\nexit_and_resubmit:\r\nsmsusb_submit_urb(dev, surb);\r\n}\r\nstatic int smsusb_submit_urb(struct smsusb_device_t *dev,\r\nstruct smsusb_urb_t *surb)\r\n{\r\nif (!surb->cb) {\r\nsurb->cb = smscore_getbuffer(dev->coredev);\r\nif (!surb->cb) {\r\nsms_err("smscore_getbuffer(...) returned NULL");\r\nreturn -ENOMEM;\r\n}\r\n}\r\nusb_fill_bulk_urb(\r\n&surb->urb,\r\ndev->udev,\r\nusb_rcvbulkpipe(dev->udev, 0x81),\r\nsurb->cb->p,\r\ndev->buffer_size,\r\nsmsusb_onresponse,\r\nsurb\r\n);\r\nsurb->urb.transfer_dma = surb->cb->phys;\r\nsurb->urb.transfer_flags |= URB_NO_TRANSFER_DMA_MAP;\r\nreturn usb_submit_urb(&surb->urb, GFP_ATOMIC);\r\n}\r\nstatic void smsusb_stop_streaming(struct smsusb_device_t *dev)\r\n{\r\nint i;\r\nfor (i = 0; i < MAX_URBS; i++) {\r\nusb_kill_urb(&dev->surbs[i].urb);\r\nif (dev->surbs[i].cb) {\r\nsmscore_putbuffer(dev->coredev, dev->surbs[i].cb);\r\ndev->surbs[i].cb = NULL;\r\n}\r\n}\r\n}\r\nstatic int smsusb_start_streaming(struct smsusb_device_t *dev)\r\n{\r\nint i, rc;\r\nfor (i = 0; i < MAX_URBS; i++) {\r\nrc = smsusb_submit_urb(dev, &dev->surbs[i]);\r\nif (rc < 0) {\r\nsms_err("smsusb_submit_urb(...) failed");\r\nsmsusb_stop_streaming(dev);\r\nbreak;\r\n}\r\n}\r\nreturn rc;\r\n}\r\nstatic int smsusb_sendrequest(void *context, void *buffer, size_t size)\r\n{\r\nstruct smsusb_device_t *dev = (struct smsusb_device_t *) context;\r\nint dummy;\r\nsmsendian_handle_message_header((struct SmsMsgHdr_ST *)buffer);\r\nreturn usb_bulk_msg(dev->udev, usb_sndbulkpipe(dev->udev, 2),\r\nbuffer, size, &dummy, 1000);\r\n}\r\nstatic inline char *sms_get_fw_name(int mode, int board_id)\r\n{\r\nchar **fw = sms_get_board(board_id)->fw;\r\nreturn (fw && fw[mode]) ? fw[mode] : smsusb1_fw_lkup[mode];\r\n}\r\nstatic int smsusb1_load_firmware(struct usb_device *udev, int id, int board_id)\r\n{\r\nconst struct firmware *fw;\r\nu8 *fw_buffer;\r\nint rc, dummy;\r\nchar *fw_filename;\r\nif (id < DEVICE_MODE_DVBT || id > DEVICE_MODE_DVBT_BDA) {\r\nsms_err("invalid firmware id specified %d", id);\r\nreturn -EINVAL;\r\n}\r\nfw_filename = sms_get_fw_name(id, board_id);\r\nrc = request_firmware(&fw, fw_filename, &udev->dev);\r\nif (rc < 0) {\r\nsms_warn("failed to open \"%s\" mode %d, "\r\n"trying again with default firmware", fw_filename, id);\r\nfw_filename = smsusb1_fw_lkup[id];\r\nrc = request_firmware(&fw, fw_filename, &udev->dev);\r\nif (rc < 0) {\r\nsms_warn("failed to open \"%s\" mode %d",\r\nfw_filename, id);\r\nreturn rc;\r\n}\r\n}\r\nfw_buffer = kmalloc(fw->size, GFP_KERNEL);\r\nif (fw_buffer) {\r\nmemcpy(fw_buffer, fw->data, fw->size);\r\nrc = usb_bulk_msg(udev, usb_sndbulkpipe(udev, 2),\r\nfw_buffer, fw->size, &dummy, 1000);\r\nsms_info("sent %zd(%d) bytes, rc %d", fw->size, dummy, rc);\r\nkfree(fw_buffer);\r\n} else {\r\nsms_err("failed to allocate firmware buffer");\r\nrc = -ENOMEM;\r\n}\r\nsms_info("read FW %s, size=%zd", fw_filename, fw->size);\r\nrelease_firmware(fw);\r\nreturn rc;\r\n}\r\nstatic void smsusb1_detectmode(void *context, int *mode)\r\n{\r\nchar *product_string =\r\n((struct smsusb_device_t *) context)->udev->product;\r\n*mode = DEVICE_MODE_NONE;\r\nif (!product_string) {\r\nproduct_string = "none";\r\nsms_err("product string not found");\r\n} else if (strstr(product_string, "DVBH"))\r\n*mode = 1;\r\nelse if (strstr(product_string, "BDA"))\r\n*mode = 4;\r\nelse if (strstr(product_string, "DVBT"))\r\n*mode = 0;\r\nelse if (strstr(product_string, "TDMB"))\r\n*mode = 2;\r\nsms_info("%d \"%s\"", *mode, product_string);\r\n}\r\nstatic int smsusb1_setmode(void *context, int mode)\r\n{\r\nstruct SmsMsgHdr_ST Msg = { MSG_SW_RELOAD_REQ, 0, HIF_TASK,\r\nsizeof(struct SmsMsgHdr_ST), 0 };\r\nif (mode < DEVICE_MODE_DVBT || mode > DEVICE_MODE_DVBT_BDA) {\r\nsms_err("invalid firmware id specified %d", mode);\r\nreturn -EINVAL;\r\n}\r\nreturn smsusb_sendrequest(context, &Msg, sizeof(Msg));\r\n}\r\nstatic void smsusb_term_device(struct usb_interface *intf)\r\n{\r\nstruct smsusb_device_t *dev = usb_get_intfdata(intf);\r\nif (dev) {\r\nsmsusb_stop_streaming(dev);\r\nif (dev->coredev)\r\nsmscore_unregister_device(dev->coredev);\r\nsms_info("device %p destroyed", dev);\r\nkfree(dev);\r\n}\r\nusb_set_intfdata(intf, NULL);\r\n}\r\nstatic int smsusb_init_device(struct usb_interface *intf, int board_id)\r\n{\r\nstruct smsdevice_params_t params;\r\nstruct smsusb_device_t *dev;\r\nint i, rc;\r\ndev = kzalloc(sizeof(struct smsusb_device_t), GFP_KERNEL);\r\nif (!dev) {\r\nsms_err("kzalloc(sizeof(struct smsusb_device_t) failed");\r\nreturn -ENOMEM;\r\n}\r\nmemset(&params, 0, sizeof(params));\r\nusb_set_intfdata(intf, dev);\r\ndev->udev = interface_to_usbdev(intf);\r\nparams.device_type = sms_get_board(board_id)->type;\r\nswitch (params.device_type) {\r\ncase SMS_STELLAR:\r\ndev->buffer_size = USB1_BUFFER_SIZE;\r\nparams.setmode_handler = smsusb1_setmode;\r\nparams.detectmode_handler = smsusb1_detectmode;\r\nbreak;\r\ndefault:\r\nsms_err("Unspecified sms device type!");\r\ncase SMS_NOVA_A0:\r\ncase SMS_NOVA_B0:\r\ncase SMS_VEGA:\r\ndev->buffer_size = USB2_BUFFER_SIZE;\r\ndev->response_alignment =\r\nle16_to_cpu(dev->udev->ep_in[1]->desc.wMaxPacketSize) -\r\nsizeof(struct SmsMsgHdr_ST);\r\nparams.flags |= SMS_DEVICE_FAMILY2;\r\nbreak;\r\n}\r\nparams.device = &dev->udev->dev;\r\nparams.buffer_size = dev->buffer_size;\r\nparams.num_buffers = MAX_BUFFERS;\r\nparams.sendrequest_handler = smsusb_sendrequest;\r\nparams.context = dev;\r\nusb_make_path(dev->udev, params.devpath, sizeof(params.devpath));\r\nrc = smscore_register_device(&params, &dev->coredev);\r\nif (rc < 0) {\r\nsms_err("smscore_register_device(...) failed, rc %d", rc);\r\nsmsusb_term_device(intf);\r\nreturn rc;\r\n}\r\nsmscore_set_board_id(dev->coredev, board_id);\r\nfor (i = 0; i < MAX_URBS; i++) {\r\ndev->surbs[i].dev = dev;\r\nusb_init_urb(&dev->surbs[i].urb);\r\n}\r\nsms_info("smsusb_start_streaming(...).");\r\nrc = smsusb_start_streaming(dev);\r\nif (rc < 0) {\r\nsms_err("smsusb_start_streaming(...) failed");\r\nsmsusb_term_device(intf);\r\nreturn rc;\r\n}\r\nrc = smscore_start_device(dev->coredev);\r\nif (rc < 0) {\r\nsms_err("smscore_start_device(...) failed");\r\nsmsusb_term_device(intf);\r\nreturn rc;\r\n}\r\nsms_info("device %p created", dev);\r\nreturn rc;\r\n}\r\nstatic int __devinit smsusb_probe(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct usb_device *udev = interface_to_usbdev(intf);\r\nchar devpath[32];\r\nint i, rc;\r\nrc = usb_clear_halt(udev, usb_rcvbulkpipe(udev, 0x81));\r\nrc = usb_clear_halt(udev, usb_rcvbulkpipe(udev, 0x02));\r\nif (intf->num_altsetting > 0) {\r\nrc = usb_set_interface(\r\nudev, intf->cur_altsetting->desc.bInterfaceNumber, 0);\r\nif (rc < 0) {\r\nsms_err("usb_set_interface failed, rc %d", rc);\r\nreturn rc;\r\n}\r\n}\r\nsms_info("smsusb_probe %d",\r\nintf->cur_altsetting->desc.bInterfaceNumber);\r\nfor (i = 0; i < intf->cur_altsetting->desc.bNumEndpoints; i++)\r\nsms_info("endpoint %d %02x %02x %d", i,\r\nintf->cur_altsetting->endpoint[i].desc.bEndpointAddress,\r\nintf->cur_altsetting->endpoint[i].desc.bmAttributes,\r\nintf->cur_altsetting->endpoint[i].desc.wMaxPacketSize);\r\nif ((udev->actconfig->desc.bNumInterfaces == 2) &&\r\n(intf->cur_altsetting->desc.bInterfaceNumber == 0)) {\r\nsms_err("rom interface 0 is not used");\r\nreturn -ENODEV;\r\n}\r\nif (intf->cur_altsetting->desc.bInterfaceNumber == 1) {\r\nsnprintf(devpath, sizeof(devpath), "usb\\%d-%s",\r\nudev->bus->busnum, udev->devpath);\r\nsms_info("stellar device was found.");\r\nreturn smsusb1_load_firmware(\r\nudev, smscore_registry_getmode(devpath),\r\nid->driver_info);\r\n}\r\nrc = smsusb_init_device(intf, id->driver_info);\r\nsms_info("rc %d", rc);\r\nsms_board_load_modules(id->driver_info);\r\nreturn rc;\r\n}\r\nstatic void smsusb_disconnect(struct usb_interface *intf)\r\n{\r\nsmsusb_term_device(intf);\r\n}\r\nstatic int smsusb_suspend(struct usb_interface *intf, pm_message_t msg)\r\n{\r\nstruct smsusb_device_t *dev = usb_get_intfdata(intf);\r\nprintk(KERN_INFO "%s: Entering status %d.\n", __func__, msg.event);\r\nsmsusb_stop_streaming(dev);\r\nreturn 0;\r\n}\r\nstatic int smsusb_resume(struct usb_interface *intf)\r\n{\r\nint rc, i;\r\nstruct smsusb_device_t *dev = usb_get_intfdata(intf);\r\nstruct usb_device *udev = interface_to_usbdev(intf);\r\nprintk(KERN_INFO "%s: Entering.\n", __func__);\r\nusb_clear_halt(udev, usb_rcvbulkpipe(udev, 0x81));\r\nusb_clear_halt(udev, usb_rcvbulkpipe(udev, 0x02));\r\nfor (i = 0; i < intf->cur_altsetting->desc.bNumEndpoints; i++)\r\nprintk(KERN_INFO "endpoint %d %02x %02x %d\n", i,\r\nintf->cur_altsetting->endpoint[i].desc.bEndpointAddress,\r\nintf->cur_altsetting->endpoint[i].desc.bmAttributes,\r\nintf->cur_altsetting->endpoint[i].desc.wMaxPacketSize);\r\nif (intf->num_altsetting > 0) {\r\nrc = usb_set_interface(udev,\r\nintf->cur_altsetting->desc.\r\nbInterfaceNumber, 0);\r\nif (rc < 0) {\r\nprintk(KERN_INFO "%s usb_set_interface failed, "\r\n"rc %d\n", __func__, rc);\r\nreturn rc;\r\n}\r\n}\r\nsmsusb_start_streaming(dev);\r\nreturn 0;\r\n}\r\nstatic int __init smsusb_module_init(void)\r\n{\r\nint rc = usb_register(&smsusb_driver);\r\nif (rc)\r\nsms_err("usb_register failed. Error number %d", rc);\r\nsms_debug("");\r\nreturn rc;\r\n}\r\nstatic void __exit smsusb_module_exit(void)\r\n{\r\nusb_deregister(&smsusb_driver);\r\nsms_info("end");\r\n}

void leon_pci_init(struct platform_device *ofdev, struct leon_pci_info *info)\r\n{\r\nstruct pci_bus *root_bus;\r\nroot_bus = pci_scan_bus_parented(&ofdev->dev, 0, info->ops, info);\r\nif (root_bus) {\r\nroot_bus->resource[0] = &info->io_space;\r\nroot_bus->resource[1] = &info->mem_space;\r\nroot_bus->resource[2] = NULL;\r\npci_bus_add_devices(root_bus);\r\npci_fixup_irqs(pci_common_swizzle, info->map_irq);\r\npci_assign_unassigned_resources();\r\n}\r\n}\r\nvoid pcibios_resource_to_bus(struct pci_dev *dev, struct pci_bus_region *region,\r\nstruct resource *res)\r\n{\r\nstruct leon_pci_info *info = dev->bus->sysdata;\r\nregion->start = res->start;\r\nregion->end = res->end;\r\nif (res->flags & IORESOURCE_IO) {\r\nregion->start -= (info->io_space.start - 0x1000);\r\nregion->end -= (info->io_space.start - 0x1000);\r\n}\r\n}\r\nvoid pcibios_bus_to_resource(struct pci_dev *dev, struct resource *res,\r\nstruct pci_bus_region *region)\r\n{\r\nstruct leon_pci_info *info = dev->bus->sysdata;\r\nres->start = region->start;\r\nres->end = region->end;\r\nif (res->flags & IORESOURCE_IO) {\r\nres->start += (info->io_space.start - 0x1000);\r\nres->end += (info->io_space.start - 0x1000);\r\n}\r\n}\r\nvoid __devinit pcibios_fixup_bus(struct pci_bus *pbus)\r\n{\r\nstruct leon_pci_info *info = pbus->sysdata;\r\nstruct pci_dev *dev;\r\nint i, has_io, has_mem;\r\nu16 cmd;\r\nif (pbus->self == NULL) {\r\npbus->resource[0] = &info->io_space;\r\npbus->resource[1] = &info->mem_space;\r\npbus->resource[2] = NULL;\r\n}\r\nlist_for_each_entry(dev, &pbus->devices, bus_list) {\r\nhas_io = has_mem = 0;\r\nfor (i = 0; i < PCI_ROM_RESOURCE; i++) {\r\nunsigned long f = dev->resource[i].flags;\r\nif (f & IORESOURCE_IO)\r\nhas_io = 1;\r\nelse if (f & IORESOURCE_MEM)\r\nhas_mem = 1;\r\n}\r\nif (dev->resource[PCI_ROM_RESOURCE].end != 0) {\r\ndev->resource[PCI_ROM_RESOURCE].flags |=\r\nIORESOURCE_ROM_ENABLE;\r\nhas_mem = 1;\r\n}\r\npci_bus_read_config_word(pbus, dev->devfn, PCI_COMMAND, &cmd);\r\nif (has_io && !(cmd & PCI_COMMAND_IO)) {\r\n#ifdef CONFIG_PCI_DEBUG\r\nprintk(KERN_INFO "LEONPCI: Enabling I/O for dev %s\n",\r\npci_name(dev));\r\n#endif\r\ncmd |= PCI_COMMAND_IO;\r\npci_bus_write_config_word(pbus, dev->devfn, PCI_COMMAND,\r\ncmd);\r\n}\r\nif (has_mem && !(cmd & PCI_COMMAND_MEMORY)) {\r\n#ifdef CONFIG_PCI_DEBUG\r\nprintk(KERN_INFO "LEONPCI: Enabling MEMORY for dev"\r\n"%s\n", pci_name(dev));\r\n#endif\r\ncmd |= PCI_COMMAND_MEMORY;\r\npci_bus_write_config_word(pbus, dev->devfn, PCI_COMMAND,\r\ncmd);\r\n}\r\n}\r\n}\r\nchar * __devinit pcibios_setup(char *str)\r\n{\r\nreturn str;\r\n}\r\nresource_size_t pcibios_align_resource(void *data, const struct resource *res,\r\nresource_size_t size, resource_size_t align)\r\n{\r\nreturn res->start;\r\n}\r\nint pcibios_enable_device(struct pci_dev *dev, int mask)\r\n{\r\nreturn pci_enable_resources(dev, mask);\r\n}\r\nstruct device_node *pci_device_to_OF_node(struct pci_dev *pdev)\r\n{\r\nreturn NULL;\r\n}\r\nvoid __devinit pcibios_update_irq(struct pci_dev *dev, int irq)\r\n{\r\n#ifdef CONFIG_PCI_DEBUG\r\nprintk(KERN_DEBUG "LEONPCI: Assigning IRQ %02d to %s\n", irq,\r\npci_name(dev));\r\n#endif\r\npci_write_config_byte(dev, PCI_INTERRUPT_LINE, irq);\r\n}\r\nvoid outsb(unsigned long addr, const void *src, unsigned long count)\r\n{\r\nwhile (count) {\r\ncount -= 1;\r\noutb(*(const char *)src, addr);\r\nsrc += 1;\r\n}\r\n}\r\nvoid outsw(unsigned long addr, const void *src, unsigned long count)\r\n{\r\nwhile (count) {\r\ncount -= 2;\r\noutw(*(const short *)src, addr);\r\nsrc += 2;\r\n}\r\n}\r\nvoid outsl(unsigned long addr, const void *src, unsigned long count)\r\n{\r\nwhile (count) {\r\ncount -= 4;\r\noutl(*(const long *)src, addr);\r\nsrc += 4;\r\n}\r\n}\r\nvoid insb(unsigned long addr, void *dst, unsigned long count)\r\n{\r\nwhile (count) {\r\ncount -= 1;\r\n*(unsigned char *)dst = inb(addr);\r\ndst += 1;\r\n}\r\n}\r\nvoid insw(unsigned long addr, void *dst, unsigned long count)\r\n{\r\nwhile (count) {\r\ncount -= 2;\r\n*(unsigned short *)dst = inw(addr);\r\ndst += 2;\r\n}\r\n}\r\nvoid insl(unsigned long addr, void *dst, unsigned long count)\r\n{\r\nwhile (count) {\r\ncount -= 4;\r\n*(unsigned long *)dst = inl(addr);\r\ndst += 4;\r\n}\r\n}

int read_ext_dsp_data(struct bridge_dev_context *dev_ctxt,\r\nu8 *host_buff, u32 dsp_addr,\r\nu32 ul_num_bytes, u32 mem_type)\r\n{\r\nint status = 0;\r\nstruct bridge_dev_context *dev_context = dev_ctxt;\r\nu32 offset;\r\nu32 ul_tlb_base_virt = 0;\r\nu32 ul_shm_offset_virt = 0;\r\nu32 dw_ext_prog_virt_mem;\r\nu32 dw_base_addr = dev_context->dsp_ext_base_addr;\r\nbool trace_read = false;\r\nif (!ul_shm_base_virt) {\r\nstatus = dev_get_symbol(dev_context->dev_obj,\r\nSHMBASENAME, &ul_shm_base_virt);\r\n}\r\nDBC_ASSERT(ul_shm_base_virt != 0);\r\nif (!status && !ul_trace_sec_beg) {\r\nstatus = dev_get_symbol(dev_context->dev_obj,\r\nDSP_TRACESEC_BEG, &ul_trace_sec_beg);\r\n}\r\nDBC_ASSERT(ul_trace_sec_beg != 0);\r\nif (!status && !ul_trace_sec_end) {\r\nstatus = dev_get_symbol(dev_context->dev_obj,\r\nDSP_TRACESEC_END, &ul_trace_sec_end);\r\n}\r\nDBC_ASSERT(ul_trace_sec_end != 0);\r\nif (!status) {\r\nif ((dsp_addr <= ul_trace_sec_end) &&\r\n(dsp_addr >= ul_trace_sec_beg))\r\ntrace_read = true;\r\n}\r\nif (trace_read && dw_base_addr) {\r\ndw_base_addr = 0;\r\ndev_context->dsp_ext_base_addr = 0;\r\n}\r\nif (!dw_base_addr) {\r\nul_ext_base = 0;\r\nul_ext_end = 0;\r\nif (!status && !ul_dyn_ext_base) {\r\nstatus = dev_get_symbol(dev_context->dev_obj,\r\nDYNEXTBASE, &ul_dyn_ext_base);\r\n}\r\nDBC_ASSERT(ul_dyn_ext_base != 0);\r\nif (!status) {\r\nstatus = dev_get_symbol(dev_context->dev_obj,\r\nEXTBASE, &ul_ext_base);\r\n}\r\nDBC_ASSERT(ul_ext_base != 0);\r\nif (!status) {\r\nstatus = dev_get_symbol(dev_context->dev_obj,\r\nEXTEND, &ul_ext_end);\r\n}\r\nDBC_ASSERT(ul_ext_end != 0);\r\nif (trace_read) {\r\nul_ext_base = ul_shm_base_virt;\r\nul_ext_end = ul_trace_sec_end;\r\n}\r\nDBC_ASSERT(ul_ext_end != 0);\r\nDBC_ASSERT(ul_ext_end > ul_ext_base);\r\nif (ul_ext_end < ul_ext_base)\r\nstatus = -EPERM;\r\nif (!status) {\r\nul_tlb_base_virt =\r\ndev_context->atlb_entry[0].dsp_va * DSPWORDSIZE;\r\nDBC_ASSERT(ul_tlb_base_virt <= ul_shm_base_virt);\r\ndw_ext_prog_virt_mem =\r\ndev_context->atlb_entry[0].gpp_va;\r\nif (!trace_read) {\r\nul_shm_offset_virt =\r\nul_shm_base_virt - ul_tlb_base_virt;\r\nul_shm_offset_virt +=\r\nPG_ALIGN_HIGH(ul_ext_end - ul_dyn_ext_base +\r\n1, HW_PAGE_SIZE64KB);\r\ndw_ext_prog_virt_mem -= ul_shm_offset_virt;\r\ndw_ext_prog_virt_mem +=\r\n(ul_ext_base - ul_dyn_ext_base);\r\ndev_context->dsp_ext_base_addr =\r\ndw_ext_prog_virt_mem;\r\nif (!dev_context->dsp_ext_base_addr)\r\nstatus = -EPERM;\r\n}\r\ndw_base_addr = dw_ext_prog_virt_mem;\r\n}\r\n}\r\nif (!dw_base_addr || !ul_ext_base || !ul_ext_end)\r\nstatus = -EPERM;\r\noffset = dsp_addr - ul_ext_base;\r\nif (!status)\r\nmemcpy(host_buff, (u8 *) dw_base_addr + offset, ul_num_bytes);\r\nreturn status;\r\n}\r\nint write_dsp_data(struct bridge_dev_context *dev_context,\r\nu8 *host_buff, u32 dsp_addr, u32 ul_num_bytes,\r\nu32 mem_type)\r\n{\r\nu32 offset;\r\nu32 dw_base_addr = dev_context->dsp_base_addr;\r\nstruct cfg_hostres *resources = dev_context->resources;\r\nint status = 0;\r\nu32 base1, base2, base3;\r\nbase1 = OMAP_DSP_MEM1_SIZE;\r\nbase2 = OMAP_DSP_MEM2_BASE - OMAP_DSP_MEM1_BASE;\r\nbase3 = OMAP_DSP_MEM3_BASE - OMAP_DSP_MEM1_BASE;\r\nif (!resources)\r\nreturn -EPERM;\r\noffset = dsp_addr - dev_context->dsp_start_add;\r\nif (offset < base1) {\r\ndw_base_addr = MEM_LINEAR_ADDRESS(resources->mem_base[2],\r\nresources->mem_length[2]);\r\n} else if (offset > base1 && offset < base2 + OMAP_DSP_MEM2_SIZE) {\r\ndw_base_addr = MEM_LINEAR_ADDRESS(resources->mem_base[3],\r\nresources->mem_length[3]);\r\noffset = offset - base2;\r\n} else if (offset >= base2 + OMAP_DSP_MEM2_SIZE &&\r\noffset < base3 + OMAP_DSP_MEM3_SIZE) {\r\ndw_base_addr = MEM_LINEAR_ADDRESS(resources->mem_base[4],\r\nresources->mem_length[4]);\r\noffset = offset - base3;\r\n} else {\r\nreturn -EPERM;\r\n}\r\nif (ul_num_bytes)\r\nmemcpy((u8 *) (dw_base_addr + offset), host_buff, ul_num_bytes);\r\nelse\r\n*((u32 *) host_buff) = dw_base_addr + offset;\r\nreturn status;\r\n}\r\nint write_ext_dsp_data(struct bridge_dev_context *dev_context,\r\nu8 *host_buff, u32 dsp_addr,\r\nu32 ul_num_bytes, u32 mem_type,\r\nbool dynamic_load)\r\n{\r\nu32 dw_base_addr = dev_context->dsp_ext_base_addr;\r\nu32 dw_offset = 0;\r\nu8 temp_byte1, temp_byte2;\r\nu8 remain_byte[4];\r\ns32 i;\r\nint ret = 0;\r\nu32 dw_ext_prog_virt_mem;\r\nu32 ul_tlb_base_virt = 0;\r\nu32 ul_shm_offset_virt = 0;\r\nstruct cfg_hostres *host_res = dev_context->resources;\r\nbool trace_load = false;\r\ntemp_byte1 = 0x0;\r\ntemp_byte2 = 0x0;\r\nif (symbols_reloaded) {\r\nret = dev_get_symbol(dev_context->dev_obj,\r\nDSP_TRACESEC_BEG, &ul_trace_sec_beg);\r\nif (!ret)\r\nret = dev_get_symbol(dev_context->dev_obj,\r\nDSP_TRACESEC_END,\r\n&ul_trace_sec_end);\r\n}\r\nif (!ret) {\r\nif ((dsp_addr <= ul_trace_sec_end) &&\r\n(dsp_addr >= ul_trace_sec_beg))\r\ntrace_load = true;\r\n}\r\nif ((dynamic_load || trace_load) && dw_base_addr) {\r\ndw_base_addr = 0;\r\nMEM_UNMAP_LINEAR_ADDRESS((void *)\r\ndev_context->dsp_ext_base_addr);\r\ndev_context->dsp_ext_base_addr = 0x0;\r\n}\r\nif (!dw_base_addr) {\r\nif (symbols_reloaded)\r\nret = dev_get_symbol(dev_context->dev_obj,\r\nSHMBASENAME, &ul_shm_base_virt);\r\nDBC_ASSERT(ul_shm_base_virt != 0);\r\nif (dynamic_load) {\r\nif (!ret) {\r\nif (symbols_reloaded)\r\nret =\r\ndev_get_symbol\r\n(dev_context->dev_obj, DYNEXTBASE,\r\n&ul_ext_base);\r\n}\r\nDBC_ASSERT(ul_ext_base != 0);\r\nif (!ret) {\r\nif (symbols_reloaded)\r\nret =\r\ndev_get_symbol\r\n(dev_context->dev_obj, EXTEND,\r\n&ul_ext_end);\r\n}\r\n} else {\r\nif (symbols_reloaded) {\r\nif (!ret)\r\nret =\r\ndev_get_symbol\r\n(dev_context->dev_obj, EXTBASE,\r\n&ul_ext_base);\r\nDBC_ASSERT(ul_ext_base != 0);\r\nif (!ret)\r\nret =\r\ndev_get_symbol\r\n(dev_context->dev_obj, EXTEND,\r\n&ul_ext_end);\r\n}\r\n}\r\nif (trace_load)\r\nul_ext_base = ul_shm_base_virt;\r\nDBC_ASSERT(ul_ext_end != 0);\r\nDBC_ASSERT(ul_ext_end > ul_ext_base);\r\nif (ul_ext_end < ul_ext_base)\r\nret = -EPERM;\r\nif (!ret) {\r\nul_tlb_base_virt =\r\ndev_context->atlb_entry[0].dsp_va * DSPWORDSIZE;\r\nDBC_ASSERT(ul_tlb_base_virt <= ul_shm_base_virt);\r\nif (symbols_reloaded) {\r\nret = dev_get_symbol\r\n(dev_context->dev_obj,\r\nDSP_TRACESEC_END, &shm0_end);\r\nif (!ret) {\r\nret =\r\ndev_get_symbol\r\n(dev_context->dev_obj, DYNEXTBASE,\r\n&ul_dyn_ext_base);\r\n}\r\n}\r\nul_shm_offset_virt =\r\nul_shm_base_virt - ul_tlb_base_virt;\r\nif (trace_load) {\r\ndw_ext_prog_virt_mem =\r\ndev_context->atlb_entry[0].gpp_va;\r\n} else {\r\ndw_ext_prog_virt_mem = host_res->mem_base[1];\r\ndw_ext_prog_virt_mem +=\r\n(ul_ext_base - ul_dyn_ext_base);\r\n}\r\ndev_context->dsp_ext_base_addr =\r\n(u32) MEM_LINEAR_ADDRESS((void *)\r\ndw_ext_prog_virt_mem,\r\nul_ext_end - ul_ext_base);\r\ndw_base_addr += dev_context->dsp_ext_base_addr;\r\nif (!dev_context->dsp_ext_base_addr)\r\nret = -EPERM;\r\n}\r\n}\r\nif (!dw_base_addr || !ul_ext_base || !ul_ext_end)\r\nret = -EPERM;\r\nif (!ret) {\r\nfor (i = 0; i < 4; i++)\r\nremain_byte[i] = 0x0;\r\ndw_offset = dsp_addr - ul_ext_base;\r\nif (dsp_addr > ul_ext_end || dw_offset > dsp_addr)\r\nret = -EPERM;\r\n}\r\nif (!ret) {\r\nif (ul_num_bytes)\r\nmemcpy((u8 *) dw_base_addr + dw_offset, host_buff,\r\nul_num_bytes);\r\nelse\r\n*((u32 *) host_buff) = dw_base_addr + dw_offset;\r\n}\r\nif ((dynamic_load || trace_load) && dev_context->dsp_ext_base_addr) {\r\nMEM_UNMAP_LINEAR_ADDRESS((void *)\r\ndev_context->dsp_ext_base_addr);\r\ndev_context->dsp_ext_base_addr = 0x0;\r\n}\r\nsymbols_reloaded = false;\r\nreturn ret;\r\n}\r\nint sm_interrupt_dsp(struct bridge_dev_context *dev_context, u16 mb_val)\r\n{\r\n#ifdef CONFIG_TIDSPBRIDGE_DVFS\r\nu32 opplevel = 0;\r\n#endif\r\nstruct omap_dsp_platform_data *pdata =\r\nomap_dspbridge_dev->dev.platform_data;\r\nstruct cfg_hostres *resources = dev_context->resources;\r\nint status = 0;\r\nu32 temp;\r\nif (!dev_context->mbox)\r\nreturn 0;\r\nif (!resources)\r\nreturn -EPERM;\r\nif (dev_context->brd_state == BRD_DSP_HIBERNATION ||\r\ndev_context->brd_state == BRD_HIBERNATION) {\r\n#ifdef CONFIG_TIDSPBRIDGE_DVFS\r\nif (pdata->dsp_get_opp)\r\nopplevel = (*pdata->dsp_get_opp) ();\r\nif (opplevel == VDD1_OPP1) {\r\nif (pdata->dsp_set_min_opp)\r\n(*pdata->dsp_set_min_opp) (VDD1_OPP2);\r\n}\r\n#endif\r\ndsp_clock_enable_all(dev_context->dsp_per_clks);\r\ndsp_wdt_enable(true);\r\n(*pdata->dsp_cm_write)(1 << OMAP3430_AUTO_IVA2_DPLL_SHIFT,\r\nOMAP3430_IVA2_MOD, OMAP3430_CM_AUTOIDLE_PLL);\r\n(*pdata->dsp_cm_rmw_bits)(OMAP3430_IVA2_DPLL_FREQSEL_MASK |\r\nOMAP3430_EN_IVA2_DPLL_MASK,\r\n0x3 << OMAP3430_IVA2_DPLL_FREQSEL_SHIFT |\r\n0x7 << OMAP3430_EN_IVA2_DPLL_SHIFT,\r\nOMAP3430_IVA2_MOD, OMAP3430_CM_CLKEN_PLL);\r\nomap_mbox_restore_ctx(dev_context->mbox);\r\ntemp = readl(resources->dmmu_base + 0x10);\r\ndev_context->brd_state = BRD_RUNNING;\r\n} else if (dev_context->brd_state == BRD_RETENTION) {\r\ndsp_clock_enable_all(dev_context->dsp_per_clks);\r\n}\r\nstatus = omap_mbox_msg_send(dev_context->mbox, mb_val);\r\nif (status) {\r\npr_err("omap_mbox_msg_send Fail and status = %d\n", status);\r\nstatus = -EPERM;\r\n}\r\nreturn 0;\r\n}

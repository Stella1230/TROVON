static int rpckbd_write(struct serio *port, unsigned char val)\r\n{\r\nwhile (!(iomd_readb(IOMD_KCTRL) & (1 << 7)))\r\ncpu_relax();\r\niomd_writeb(val, IOMD_KARTTX);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t rpckbd_rx(int irq, void *dev_id)\r\n{\r\nstruct serio *port = dev_id;\r\nunsigned int byte;\r\nint handled = IRQ_NONE;\r\nwhile (iomd_readb(IOMD_KCTRL) & (1 << 5)) {\r\nbyte = iomd_readb(IOMD_KARTRX);\r\nserio_interrupt(port, byte, 0);\r\nhandled = IRQ_HANDLED;\r\n}\r\nreturn handled;\r\n}\r\nstatic irqreturn_t rpckbd_tx(int irq, void *dev_id)\r\n{\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int rpckbd_open(struct serio *port)\r\n{\r\niomd_writeb(0, IOMD_KCTRL);\r\niomd_writeb(8, IOMD_KCTRL);\r\niomd_readb(IOMD_KARTRX);\r\nif (request_irq(IRQ_KEYBOARDRX, rpckbd_rx, 0, "rpckbd", port) != 0) {\r\nprintk(KERN_ERR "rpckbd.c: Could not allocate keyboard receive IRQ\n");\r\nreturn -EBUSY;\r\n}\r\nif (request_irq(IRQ_KEYBOARDTX, rpckbd_tx, 0, "rpckbd", port) != 0) {\r\nprintk(KERN_ERR "rpckbd.c: Could not allocate keyboard transmit IRQ\n");\r\nfree_irq(IRQ_KEYBOARDRX, port);\r\nreturn -EBUSY;\r\n}\r\nreturn 0;\r\n}\r\nstatic void rpckbd_close(struct serio *port)\r\n{\r\nfree_irq(IRQ_KEYBOARDRX, port);\r\nfree_irq(IRQ_KEYBOARDTX, port);\r\n}\r\nstatic int __devinit rpckbd_probe(struct platform_device *dev)\r\n{\r\nstruct serio *serio;\r\nserio = kzalloc(sizeof(struct serio), GFP_KERNEL);\r\nif (!serio)\r\nreturn -ENOMEM;\r\nserio->id.type = SERIO_8042;\r\nserio->write = rpckbd_write;\r\nserio->open = rpckbd_open;\r\nserio->close = rpckbd_close;\r\nserio->dev.parent = &dev->dev;\r\nstrlcpy(serio->name, "RiscPC PS/2 kbd port", sizeof(serio->name));\r\nstrlcpy(serio->phys, "rpckbd/serio0", sizeof(serio->phys));\r\nplatform_set_drvdata(dev, serio);\r\nserio_register_port(serio);\r\nreturn 0;\r\n}\r\nstatic int __devexit rpckbd_remove(struct platform_device *dev)\r\n{\r\nstruct serio *serio = platform_get_drvdata(dev);\r\nserio_unregister_port(serio);\r\nreturn 0;\r\n}\r\nstatic int __init rpckbd_init(void)\r\n{\r\nreturn platform_driver_register(&rpckbd_driver);\r\n}\r\nstatic void __exit rpckbd_exit(void)\r\n{\r\nplatform_driver_unregister(&rpckbd_driver);\r\n}

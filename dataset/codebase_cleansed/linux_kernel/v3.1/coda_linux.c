char * coda_f2s(struct CodaFid *f)\r\n{\r\nstatic char s[60];\r\nsprintf(s, "(%08x.%08x.%08x.%08x)", f->opaque[0], f->opaque[1], f->opaque[2], f->opaque[3]);\r\nreturn s;\r\n}\r\nint coda_iscontrol(const char *name, size_t length)\r\n{\r\nreturn ((CODA_CONTROLLEN == length) &&\r\n(strncmp(name, CODA_CONTROL, CODA_CONTROLLEN) == 0));\r\n}\r\nint coda_isroot(struct inode *i)\r\n{\r\nreturn ( i->i_sb->s_root->d_inode == i );\r\n}\r\nunsigned short coda_flags_to_cflags(unsigned short flags)\r\n{\r\nunsigned short coda_flags = 0;\r\nif ((flags & O_ACCMODE) == O_RDONLY)\r\ncoda_flags |= C_O_READ;\r\nif ((flags & O_ACCMODE) == O_RDWR)\r\ncoda_flags |= C_O_READ | C_O_WRITE;\r\nif ((flags & O_ACCMODE) == O_WRONLY)\r\ncoda_flags |= C_O_WRITE;\r\nif (flags & O_TRUNC)\r\ncoda_flags |= C_O_TRUNC;\r\nif (flags & O_CREAT)\r\ncoda_flags |= C_O_CREAT;\r\nif (flags & O_EXCL)\r\ncoda_flags |= C_O_EXCL;\r\nreturn coda_flags;\r\n}\r\nvoid coda_vattr_to_iattr(struct inode *inode, struct coda_vattr *attr)\r\n{\r\nint inode_type;\r\nswitch (attr->va_type) {\r\ncase C_VNON:\r\ninode_type = 0;\r\nbreak;\r\ncase C_VREG:\r\ninode_type = S_IFREG;\r\nbreak;\r\ncase C_VDIR:\r\ninode_type = S_IFDIR;\r\nbreak;\r\ncase C_VLNK:\r\ninode_type = S_IFLNK;\r\nbreak;\r\ndefault:\r\ninode_type = 0;\r\n}\r\ninode->i_mode |= inode_type;\r\nif (attr->va_mode != (u_short) -1)\r\ninode->i_mode = attr->va_mode | inode_type;\r\nif (attr->va_uid != -1)\r\ninode->i_uid = (uid_t) attr->va_uid;\r\nif (attr->va_gid != -1)\r\ninode->i_gid = (gid_t) attr->va_gid;\r\nif (attr->va_nlink != -1)\r\ninode->i_nlink = attr->va_nlink;\r\nif (attr->va_size != -1)\r\ninode->i_size = attr->va_size;\r\nif (attr->va_size != -1)\r\ninode->i_blocks = (attr->va_size + 511) >> 9;\r\nif (attr->va_atime.tv_sec != -1)\r\ninode->i_atime = attr->va_atime;\r\nif (attr->va_mtime.tv_sec != -1)\r\ninode->i_mtime = attr->va_mtime;\r\nif (attr->va_ctime.tv_sec != -1)\r\ninode->i_ctime = attr->va_ctime;\r\n}\r\nvoid coda_iattr_to_vattr(struct iattr *iattr, struct coda_vattr *vattr)\r\n{\r\nunsigned int valid;\r\nvattr->va_mode = -1;\r\nvattr->va_uid = (vuid_t) -1;\r\nvattr->va_gid = (vgid_t) -1;\r\nvattr->va_size = (off_t) -1;\r\nvattr->va_atime.tv_sec = (time_t) -1;\r\nvattr->va_atime.tv_nsec = (time_t) -1;\r\nvattr->va_mtime.tv_sec = (time_t) -1;\r\nvattr->va_mtime.tv_nsec = (time_t) -1;\r\nvattr->va_ctime.tv_sec = (time_t) -1;\r\nvattr->va_ctime.tv_nsec = (time_t) -1;\r\nvattr->va_type = C_VNON;\r\nvattr->va_fileid = -1;\r\nvattr->va_gen = -1;\r\nvattr->va_bytes = -1;\r\nvattr->va_nlink = -1;\r\nvattr->va_blocksize = -1;\r\nvattr->va_rdev = -1;\r\nvattr->va_flags = 0;\r\n#if 0\r\nmode = iattr->ia_mode;\r\nif ( S_ISDIR(mode) ) {\r\nvattr->va_type = C_VDIR;\r\n} else if ( S_ISREG(mode) ) {\r\nvattr->va_type = C_VREG;\r\n} else if ( S_ISLNK(mode) ) {\r\nvattr->va_type = C_VLNK;\r\n} else {\r\nvattr->va_type = C_VNON;\r\n}\r\n#endif\r\nvalid = iattr->ia_valid;\r\nif ( valid & ATTR_MODE ) {\r\nvattr->va_mode = iattr->ia_mode;\r\n}\r\nif ( valid & ATTR_UID ) {\r\nvattr->va_uid = (vuid_t) iattr->ia_uid;\r\n}\r\nif ( valid & ATTR_GID ) {\r\nvattr->va_gid = (vgid_t) iattr->ia_gid;\r\n}\r\nif ( valid & ATTR_SIZE ) {\r\nvattr->va_size = iattr->ia_size;\r\n}\r\nif ( valid & ATTR_ATIME ) {\r\nvattr->va_atime = iattr->ia_atime;\r\n}\r\nif ( valid & ATTR_MTIME ) {\r\nvattr->va_mtime = iattr->ia_mtime;\r\n}\r\nif ( valid & ATTR_CTIME ) {\r\nvattr->va_ctime = iattr->ia_ctime;\r\n}\r\n}

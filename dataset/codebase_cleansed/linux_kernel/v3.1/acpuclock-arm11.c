static int pc_pll_request(unsigned id, unsigned on)\r\n{\r\nint res;\r\non = !!on;\r\n#if PERF_SWITCH_DEBUG\r\nif (on)\r\nprintk(KERN_DEBUG "Enabling PLL %d\n", id);\r\nelse\r\nprintk(KERN_DEBUG "Disabling PLL %d\n", id);\r\n#endif\r\nres = msm_proc_comm(PCOM_CLKCTL_RPC_PLL_REQUEST, &id, &on);\r\nif (res < 0)\r\nreturn res;\r\n#if PERF_SWITCH_DEBUG\r\nif (on)\r\nprintk(KERN_DEBUG "PLL %d enabled\n", id);\r\nelse\r\nprintk(KERN_DEBUG "PLL %d disabled\n", id);\r\n#endif\r\nreturn res;\r\n}\r\nunsigned long acpuclk_power_collapse(void) {\r\nint ret = acpuclk_get_rate();\r\nret *= 1000;\r\nif (ret > drv_state.power_collapse_khz)\r\nacpuclk_set_rate(drv_state.power_collapse_khz, 1);\r\nreturn ret;\r\n}\r\nunsigned long acpuclk_get_wfi_rate(void)\r\n{\r\nreturn drv_state.wait_for_irq_khz;\r\n}\r\nunsigned long acpuclk_wait_for_irq(void) {\r\nint ret = acpuclk_get_rate();\r\nret *= 1000;\r\nif (ret > drv_state.wait_for_irq_khz)\r\nacpuclk_set_rate(drv_state.wait_for_irq_khz, 1);\r\nreturn ret;\r\n}\r\nstatic int acpuclk_set_vdd_level(int vdd)\r\n{\r\nuint32_t current_vdd;\r\ncurrent_vdd = readl(A11S_VDD_SVS_PLEVEL_ADDR) & 0x07;\r\n#if PERF_SWITCH_DEBUG\r\nprintk(KERN_DEBUG "acpuclock: Switching VDD from %u -> %d\n",\r\ncurrent_vdd, vdd);\r\n#endif\r\nwritel((1 << 7) | (vdd << 3), A11S_VDD_SVS_PLEVEL_ADDR);\r\nudelay(drv_state.vdd_switch_time_us);\r\nif ((readl(A11S_VDD_SVS_PLEVEL_ADDR) & 0x7) != vdd) {\r\n#if PERF_SWITCH_DEBUG\r\nprintk(KERN_ERR "acpuclock: VDD set failed\n");\r\n#endif\r\nreturn -EIO;\r\n}\r\n#if PERF_SWITCH_DEBUG\r\nprintk(KERN_DEBUG "acpuclock: VDD switched\n");\r\n#endif\r\nreturn 0;\r\n}\r\nstatic void acpuclk_set_div(const struct clkctl_acpu_speed *hunt_s) {\r\nuint32_t reg_clkctl, reg_clksel, clk_div;\r\nclk_div = (readl(A11S_CLK_SEL_ADDR) >> 1) & 0x03;\r\nif (hunt_s->ahbclk_div > clk_div) {\r\nreg_clksel = readl(A11S_CLK_SEL_ADDR);\r\nreg_clksel &= ~(0x3 << 1);\r\nreg_clksel |= (hunt_s->ahbclk_div << 1);\r\nwritel(reg_clksel, A11S_CLK_SEL_ADDR);\r\n}\r\nif ((readl(A11S_CLK_SEL_ADDR) & 0x01) == 0) {\r\nreg_clkctl = readl(A11S_CLK_CNTL_ADDR);\r\nreg_clkctl &= ~(0x07 << 4);\r\nreg_clkctl |= (hunt_s->a11clk_src_sel << 4);\r\nwritel(reg_clkctl, A11S_CLK_CNTL_ADDR);\r\nreg_clkctl = readl(A11S_CLK_CNTL_ADDR);\r\nreg_clkctl &= ~0xf;\r\nreg_clkctl |= hunt_s->a11clk_src_div;\r\nwritel(reg_clkctl, A11S_CLK_CNTL_ADDR);\r\nreg_clksel = readl(A11S_CLK_SEL_ADDR);\r\nreg_clksel |= 1;\r\nwritel(reg_clksel, A11S_CLK_SEL_ADDR);\r\n} else {\r\nreg_clkctl = readl(A11S_CLK_CNTL_ADDR);\r\nreg_clkctl &= ~(0x07 << 12);\r\nreg_clkctl |= (hunt_s->a11clk_src_sel << 12);\r\nwritel(reg_clkctl, A11S_CLK_CNTL_ADDR);\r\nreg_clkctl = readl(A11S_CLK_CNTL_ADDR);\r\nreg_clkctl &= ~(0xf << 8);\r\nreg_clkctl |= (hunt_s->a11clk_src_div << 8);\r\nwritel(reg_clkctl, A11S_CLK_CNTL_ADDR);\r\nreg_clksel = readl(A11S_CLK_SEL_ADDR);\r\nreg_clksel &= ~1;\r\nwritel(reg_clksel, A11S_CLK_SEL_ADDR);\r\n}\r\nif (hunt_s->ahbclk_div < clk_div) {\r\nreg_clksel = readl(A11S_CLK_SEL_ADDR);\r\nreg_clksel &= ~(0x3 << 1);\r\nreg_clksel |= (hunt_s->ahbclk_div << 1);\r\nwritel(reg_clksel, A11S_CLK_SEL_ADDR);\r\n}\r\n}\r\nint acpuclk_set_rate(unsigned long rate, int for_power_collapse)\r\n{\r\nuint32_t reg_clkctl;\r\nstruct clkctl_acpu_speed *cur_s, *tgt_s, *strt_s;\r\nint rc = 0;\r\nunsigned int plls_enabled = 0, pll;\r\nstrt_s = cur_s = drv_state.current_speed;\r\nWARN_ONCE(cur_s == NULL, "acpuclk_set_rate: not initialized\n");\r\nif (cur_s == NULL)\r\nreturn -ENOENT;\r\nif (rate == (cur_s->a11clk_khz * 1000))\r\nreturn 0;\r\nfor (tgt_s = acpu_freq_tbl; tgt_s->a11clk_khz != 0; tgt_s++) {\r\nif (tgt_s->a11clk_khz == (rate / 1000))\r\nbreak;\r\n}\r\nif (tgt_s->a11clk_khz == 0)\r\nreturn -EINVAL;\r\nif (for_power_collapse && tgt_s->a11clk_khz < cur_s->a11clk_khz) {\r\nwhile (tgt_s->pll != ACPU_PLL_TCXO && tgt_s->pll != cur_s->pll)\r\ntgt_s--;\r\n}\r\nif (strt_s->pll != ACPU_PLL_TCXO)\r\nplls_enabled |= 1 << strt_s->pll;\r\nif (!for_power_collapse) {\r\nmutex_lock(&drv_state.lock);\r\nif (strt_s->pll != tgt_s->pll && tgt_s->pll != ACPU_PLL_TCXO) {\r\nrc = pc_pll_request(tgt_s->pll, 1);\r\nif (rc < 0) {\r\npr_err("PLL%d enable failed (%d)\n",\r\ntgt_s->pll, rc);\r\ngoto out;\r\n}\r\nplls_enabled |= 1 << tgt_s->pll;\r\n}\r\nif (tgt_s->vdd > cur_s->vdd) {\r\nif ((rc = acpuclk_set_vdd_level(tgt_s->vdd)) < 0) {\r\nprintk(KERN_ERR "Unable to switch ACPU vdd\n");\r\ngoto out;\r\n}\r\n}\r\n}\r\nreg_clkctl = readl(A11S_CLK_CNTL_ADDR);\r\nreg_clkctl |= (100 << 16);\r\nwritel(reg_clkctl, A11S_CLK_CNTL_ADDR);\r\n#if PERF_SWITCH_DEBUG\r\nprintk(KERN_INFO "acpuclock: Switching from ACPU rate %u -> %u\n",\r\nstrt_s->a11clk_khz * 1000, tgt_s->a11clk_khz * 1000);\r\n#endif\r\nwhile (cur_s != tgt_s) {\r\nint d = abs((int)(cur_s->a11clk_khz - tgt_s->a11clk_khz));\r\nif (d > drv_state.max_speed_delta_khz) {\r\nint clk_index = tgt_s->a11clk_khz > cur_s->a11clk_khz ?\r\ncur_s->up : cur_s->down;\r\nif (clk_index < 0) {\r\nprintk(KERN_ERR "cur:%u target: %u\n",\r\ncur_s->a11clk_khz, tgt_s->a11clk_khz);\r\nrc = -EINVAL;\r\ngoto out;\r\n}\r\ncur_s = &acpu_freq_tbl[clk_index];\r\n} else {\r\ncur_s = tgt_s;\r\n}\r\n#if PERF_SWITCH_STEP_DEBUG\r\nprintk(KERN_DEBUG "%s: STEP khz = %u, pll = %d\n",\r\n__FUNCTION__, cur_s->a11clk_khz, cur_s->pll);\r\n#endif\r\nif (!for_power_collapse&& cur_s->pll != ACPU_PLL_TCXO\r\n&& !(plls_enabled & (1 << cur_s->pll))) {\r\nrc = pc_pll_request(cur_s->pll, 1);\r\nif (rc < 0) {\r\npr_err("PLL%d enable failed (%d)\n",\r\ncur_s->pll, rc);\r\ngoto out;\r\n}\r\nplls_enabled |= 1 << cur_s->pll;\r\n}\r\nacpuclk_set_div(cur_s);\r\ndrv_state.current_speed = cur_s;\r\nloops_per_jiffy = cur_s->lpj;\r\nudelay(drv_state.acpu_switch_time_us);\r\n}\r\nif (for_power_collapse)\r\nreturn 0;\r\nplls_enabled &= ~(1 << tgt_s->pll);\r\nfor (pll = ACPU_PLL_0; pll <= ACPU_PLL_2; pll++)\r\nif (plls_enabled & (1 << pll)) {\r\nrc = pc_pll_request(pll, 0);\r\nif (rc < 0) {\r\npr_err("PLL%d disable failed (%d)\n", pll, rc);\r\ngoto out;\r\n}\r\n}\r\nif (strt_s->axiclk_khz != tgt_s->axiclk_khz) {\r\nrc = clk_set_rate(ebi1_clk, tgt_s->axiclk_khz * 1000);\r\nif (rc < 0)\r\npr_err("Setting AXI min rate failed!\n");\r\n}\r\nif (tgt_s->vdd < strt_s->vdd) {\r\nif (acpuclk_set_vdd_level(tgt_s->vdd) < 0)\r\nprintk(KERN_ERR "acpuclock: Unable to drop ACPU vdd\n");\r\n}\r\n#if PERF_SWITCH_DEBUG\r\nprintk(KERN_DEBUG "%s: ACPU speed change complete\n", __FUNCTION__);\r\n#endif\r\nout:\r\nif (!for_power_collapse)\r\nmutex_unlock(&drv_state.lock);\r\nreturn rc;\r\n}\r\nstatic void __init acpuclk_init(void)\r\n{\r\nstruct clkctl_acpu_speed *speed;\r\nuint32_t div, sel;\r\nint rc;\r\nif (!(readl(A11S_CLK_SEL_ADDR) & 0x01)) {\r\nsel = (readl(A11S_CLK_CNTL_ADDR) >> 12) & 0x7;\r\ndiv = (readl(A11S_CLK_CNTL_ADDR) >> 8) & 0x0f;\r\n} else {\r\nsel = (readl(A11S_CLK_CNTL_ADDR) >> 4) & 0x07;\r\ndiv = readl(A11S_CLK_CNTL_ADDR) & 0x0f;\r\n}\r\nfor (speed = acpu_freq_tbl; speed->a11clk_khz != 0; speed++) {\r\nif (speed->a11clk_src_sel == sel\r\n&& (speed->a11clk_src_div == div))\r\nbreak;\r\n}\r\nif (speed->a11clk_khz == 0) {\r\nprintk(KERN_WARNING "Warning - ACPU clock reports invalid speed\n");\r\nreturn;\r\n}\r\ndrv_state.current_speed = speed;\r\nrc = clk_set_rate(ebi1_clk, speed->axiclk_khz * 1000);\r\nif (rc < 0)\r\npr_err("Setting AXI min rate failed!\n");\r\nprintk(KERN_INFO "ACPU running at %d KHz\n", speed->a11clk_khz);\r\n}\r\nunsigned long acpuclk_get_rate(void)\r\n{\r\nWARN_ONCE(drv_state.current_speed == NULL,\r\n"acpuclk_get_rate: not initialized\n");\r\nif (drv_state.current_speed)\r\nreturn drv_state.current_speed->a11clk_khz;\r\nelse\r\nreturn 0;\r\n}\r\nuint32_t acpuclk_get_switch_time(void)\r\n{\r\nreturn drv_state.acpu_switch_time_us;\r\n}\r\nstatic void __init lpj_init(void)\r\n{\r\nint i;\r\nconst struct clkctl_acpu_speed *base_clk = drv_state.current_speed;\r\nfor (i = 0; acpu_freq_tbl[i].a11clk_khz; i++) {\r\nacpu_freq_tbl[i].lpj = cpufreq_scale(loops_per_jiffy,\r\nbase_clk->a11clk_khz,\r\nacpu_freq_tbl[i].a11clk_khz);\r\n}\r\n}\r\nvoid __init msm_acpu_clock_init(struct msm_acpu_clock_platform_data *clkdata)\r\n{\r\npr_info("acpu_clock_init()\n");\r\nebi1_clk = clk_get(NULL, "ebi1_clk");\r\nmutex_init(&drv_state.lock);\r\ndrv_state.acpu_switch_time_us = clkdata->acpu_switch_time_us;\r\ndrv_state.max_speed_delta_khz = clkdata->max_speed_delta_khz;\r\ndrv_state.vdd_switch_time_us = clkdata->vdd_switch_time_us;\r\ndrv_state.power_collapse_khz = clkdata->power_collapse_khz;\r\ndrv_state.wait_for_irq_khz = clkdata->wait_for_irq_khz;\r\nacpuclk_init();\r\nlpj_init();\r\n#ifdef CONFIG_CPU_FREQ_TABLE\r\ncpufreq_frequency_table_get_attr(freq_table, smp_processor_id());\r\n#endif\r\n}

static int ipw_open(struct tty_struct *tty, struct usb_serial_port *port)\r\n{\r\nstruct usb_device *dev = port->serial->dev;\r\nu8 buf_flow_static[16] = IPW_BYTES_FLOWINIT;\r\nu8 *buf_flow_init;\r\nint result;\r\ndbg("%s", __func__);\r\nbuf_flow_init = kmemdup(buf_flow_static, 16, GFP_KERNEL);\r\nif (!buf_flow_init)\r\nreturn -ENOMEM;\r\ndbg("%s: Sending SIO_INIT (we guess)", __func__);\r\nresult = usb_control_msg(dev, usb_sndctrlpipe(dev, 0),\r\nIPW_SIO_INIT,\r\nUSB_TYPE_VENDOR | USB_RECIP_INTERFACE | USB_DIR_OUT,\r\n0,\r\n0,\r\nNULL,\r\n0,\r\n100000);\r\nif (result < 0)\r\ndev_err(&port->dev,\r\n"Init of modem failed (error = %d)\n", result);\r\nusb_clear_halt(dev,\r\nusb_rcvbulkpipe(dev, port->bulk_in_endpointAddress));\r\nusb_clear_halt(dev,\r\nusb_sndbulkpipe(dev, port->bulk_out_endpointAddress));\r\ndbg("%s: setting up bulk read callback", __func__);\r\nusb_serial_generic_open(tty, port);\r\ndbg("%s:asking modem for RxRead (RXBULK_ON)", __func__);\r\nresult = usb_control_msg(dev, usb_sndctrlpipe(dev, 0),\r\nIPW_SIO_RXCTL,\r\nUSB_TYPE_VENDOR | USB_RECIP_INTERFACE | USB_DIR_OUT,\r\nIPW_RXBULK_ON,\r\n0,\r\nNULL,\r\n0,\r\n100000);\r\nif (result < 0)\r\ndev_err(&port->dev,\r\n"Enabling bulk RxRead failed (error = %d)\n", result);\r\ndbg("%s:setting init flowcontrol (%s)", __func__, buf_flow_init);\r\nresult = usb_control_msg(dev, usb_sndctrlpipe(dev, 0),\r\nIPW_SIO_HANDFLOW,\r\nUSB_TYPE_VENDOR | USB_RECIP_INTERFACE | USB_DIR_OUT,\r\n0,\r\n0,\r\nbuf_flow_init,\r\n0x10,\r\n200000);\r\nif (result < 0)\r\ndev_err(&port->dev,\r\n"initial flowcontrol failed (error = %d)\n", result);\r\nkfree(buf_flow_init);\r\nreturn 0;\r\n}\r\nstatic void ipw_dtr_rts(struct usb_serial_port *port, int on)\r\n{\r\nstruct usb_device *dev = port->serial->dev;\r\nint result;\r\ndbg("%s: on = %d", __func__, on);\r\nresult = usb_control_msg(dev, usb_sndctrlpipe(dev, 0),\r\nIPW_SIO_SET_PIN,\r\nUSB_TYPE_VENDOR | USB_RECIP_INTERFACE | USB_DIR_OUT,\r\non ? IPW_PIN_SETDTR : IPW_PIN_CLRDTR,\r\n0,\r\nNULL,\r\n0,\r\n200000);\r\nif (result < 0)\r\ndev_err(&port->dev, "setting dtr failed (error = %d)\n",\r\nresult);\r\nresult = usb_control_msg(dev, usb_sndctrlpipe(dev, 0),\r\nIPW_SIO_SET_PIN, USB_TYPE_VENDOR |\r\nUSB_RECIP_INTERFACE | USB_DIR_OUT,\r\non ? IPW_PIN_SETRTS : IPW_PIN_CLRRTS,\r\n0,\r\nNULL,\r\n0,\r\n200000);\r\nif (result < 0)\r\ndev_err(&port->dev, "setting rts failed (error = %d)\n",\r\nresult);\r\n}\r\nstatic void ipw_close(struct usb_serial_port *port)\r\n{\r\nstruct usb_device *dev = port->serial->dev;\r\nint result;\r\ndbg("%s:sending purge", __func__);\r\nresult = usb_control_msg(dev, usb_sndctrlpipe(dev, 0),\r\nIPW_SIO_PURGE, USB_TYPE_VENDOR |\r\nUSB_RECIP_INTERFACE | USB_DIR_OUT,\r\n0x03,\r\n0,\r\nNULL,\r\n0,\r\n200000);\r\nif (result < 0)\r\ndev_err(&port->dev, "purge failed (error = %d)\n", result);\r\nresult = usb_control_msg(dev, usb_sndctrlpipe(dev, 0),\r\nIPW_SIO_RXCTL,\r\nUSB_TYPE_VENDOR | USB_RECIP_INTERFACE | USB_DIR_OUT,\r\nIPW_RXBULK_OFF,\r\n0,\r\nNULL,\r\n0,\r\n100000);\r\nif (result < 0)\r\ndev_err(&port->dev,\r\n"Disabling bulk RxRead failed (error = %d)\n", result);\r\nusb_serial_generic_close(port);\r\n}\r\nstatic int __init usb_ipw_init(void)\r\n{\r\nint retval;\r\nretval = usb_serial_register(&ipw_device);\r\nif (retval)\r\nreturn retval;\r\nretval = usb_register(&usb_ipw_driver);\r\nif (retval) {\r\nusb_serial_deregister(&ipw_device);\r\nreturn retval;\r\n}\r\nprintk(KERN_INFO KBUILD_MODNAME ": " DRIVER_VERSION ":"\r\nDRIVER_DESC "\n");\r\nreturn 0;\r\n}\r\nstatic void __exit usb_ipw_exit(void)\r\n{\r\nusb_deregister(&usb_ipw_driver);\r\nusb_serial_deregister(&ipw_device);\r\n}

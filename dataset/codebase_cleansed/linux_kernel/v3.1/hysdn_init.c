static int __devinit hysdn_pci_init_one(struct pci_dev *akt_pcidev,\r\nconst struct pci_device_id *ent)\r\n{\r\nhysdn_card *card;\r\nint rc;\r\nrc = pci_enable_device(akt_pcidev);\r\nif (rc)\r\nreturn rc;\r\nif (!(card = kzalloc(sizeof(hysdn_card), GFP_KERNEL))) {\r\nprintk(KERN_ERR "HYSDN: unable to alloc device mem \n");\r\nrc = -ENOMEM;\r\ngoto err_out;\r\n}\r\ncard->myid = cardmax;\r\ncard->bus = akt_pcidev->bus->number;\r\ncard->devfn = akt_pcidev->devfn;\r\ncard->subsysid = akt_pcidev->subsystem_device;\r\ncard->irq = akt_pcidev->irq;\r\ncard->iobase = pci_resource_start(akt_pcidev, PCI_REG_PLX_IO_BASE);\r\ncard->plxbase = pci_resource_start(akt_pcidev, PCI_REG_PLX_MEM_BASE);\r\ncard->membase = pci_resource_start(akt_pcidev, PCI_REG_MEMORY_BASE);\r\ncard->brdtype = BD_NONE;\r\ncard->debug_flags = DEF_DEB_FLAGS;\r\ncard->faxchans = 0;\r\ncard->bchans = 2;\r\ncard->brdtype = ent->driver_data;\r\nif (ergo_inithardware(card)) {\r\nprintk(KERN_WARNING "HYSDN: card at io 0x%04x already in use\n", card->iobase);\r\nrc = -EBUSY;\r\ngoto err_out_card;\r\n}\r\ncardmax++;\r\ncard->next = NULL;\r\nif (card_last)\r\ncard_last->next = card;\r\nelse\r\ncard_root = card;\r\ncard_last = card;\r\npci_set_drvdata(akt_pcidev, card);\r\nreturn 0;\r\nerr_out_card:\r\nkfree(card);\r\nerr_out:\r\npci_disable_device(akt_pcidev);\r\nreturn rc;\r\n}\r\nstatic void __devexit hysdn_pci_remove_one(struct pci_dev *akt_pcidev)\r\n{\r\nhysdn_card *card = pci_get_drvdata(akt_pcidev);\r\npci_set_drvdata(akt_pcidev, NULL);\r\nif (card->stopcard)\r\ncard->stopcard(card);\r\n#ifdef CONFIG_HYSDN_CAPI\r\nhycapi_capi_release(card);\r\n#endif\r\nif (card->releasehardware)\r\ncard->releasehardware(card);\r\nif (card == card_root) {\r\ncard_root = card_root->next;\r\nif (!card_root)\r\ncard_last = NULL;\r\n} else {\r\nhysdn_card *tmp = card_root;\r\nwhile (tmp) {\r\nif (tmp->next == card)\r\ntmp->next = card->next;\r\ncard_last = tmp;\r\ntmp = tmp->next;\r\n}\r\n}\r\nkfree(card);\r\npci_disable_device(akt_pcidev);\r\n}\r\nstatic int __init\r\nhysdn_init(void)\r\n{\r\nint rc;\r\nprintk(KERN_NOTICE "HYSDN: module loaded\n");\r\nrc = pci_register_driver(&hysdn_pci_driver);\r\nif (rc)\r\nreturn rc;\r\nprintk(KERN_INFO "HYSDN: %d card(s) found.\n", cardmax);\r\nif (!hysdn_procconf_init())\r\nhysdn_have_procfs = 1;\r\n#ifdef CONFIG_HYSDN_CAPI\r\nif(cardmax > 0) {\r\nif(hycapi_init()) {\r\nprintk(KERN_ERR "HYCAPI: init failed\n");\r\nif (hysdn_have_procfs)\r\nhysdn_procconf_release();\r\npci_unregister_driver(&hysdn_pci_driver);\r\nreturn -ESPIPE;\r\n}\r\n}\r\n#endif\r\nreturn 0;\r\n}\r\nstatic void __exit\r\nhysdn_exit(void)\r\n{\r\nif (hysdn_have_procfs)\r\nhysdn_procconf_release();\r\npci_unregister_driver(&hysdn_pci_driver);\r\n#ifdef CONFIG_HYSDN_CAPI\r\nhycapi_cleanup();\r\n#endif\r\nprintk(KERN_NOTICE "HYSDN: module unloaded\n");\r\n}

static void spitz_charger_init(void)\r\n{\r\ngpio_request_array(ARRAY_AND_SIZE(spitz_charger_gpios));\r\n}\r\nstatic void spitz_measure_temp(int on)\r\n{\r\ngpio_set_value(SPITZ_GPIO_ADC_TEMP_ON, on);\r\n}\r\nstatic void spitz_charge(int on)\r\n{\r\nif (on) {\r\nif (sharpsl_pm.flags & SHARPSL_SUSPENDED) {\r\ngpio_set_value(SPITZ_GPIO_JK_B, 1);\r\ngpio_set_value(SPITZ_GPIO_CHRG_ON, 0);\r\n} else {\r\ngpio_set_value(SPITZ_GPIO_JK_B, 0);\r\ngpio_set_value(SPITZ_GPIO_CHRG_ON, 0);\r\n}\r\n} else {\r\ngpio_set_value(SPITZ_GPIO_JK_B, 0);\r\ngpio_set_value(SPITZ_GPIO_CHRG_ON, 1);\r\n}\r\n}\r\nstatic void spitz_discharge(int on)\r\n{\r\ngpio_set_value(SPITZ_GPIO_JK_A, on);\r\n}\r\nstatic void spitz_discharge1(int on)\r\n{\r\ngpio_set_value(SPITZ_GPIO_LED_GREEN, on);\r\n}\r\nstatic void spitz_presuspend(void)\r\n{\r\nspitz_last_ac_status = sharpsl_pm.machinfo->read_devdata(SHARPSL_STATUS_ACIN);\r\nPGSR0 = 0x00144018;\r\nPGSR1 = 0x00EF0000;\r\nif (machine_is_akita()) {\r\nPGSR2 = 0x2121C000;\r\nPGSR3 = 0x00600400;\r\n} else {\r\nPGSR2 = 0x0121C000;\r\nPGSR3 = 0x00600000;\r\n}\r\nPGSR0 &= ~SPITZ_GPIO_G0_STROBE_BIT;\r\nPGSR1 &= ~SPITZ_GPIO_G1_STROBE_BIT;\r\nPGSR2 &= ~SPITZ_GPIO_G2_STROBE_BIT;\r\nPGSR3 &= ~SPITZ_GPIO_G3_STROBE_BIT;\r\nPGSR2 |= GPIO_bit(SPITZ_GPIO_KEY_STROBE0);\r\npxa2xx_mfp_config(&gpio18_config[0], 1);\r\ngpio_request_one(18, GPIOF_OUT_INIT_HIGH, "Unknown");\r\ngpio_free(18);\r\nPRER = GPIO_bit(SPITZ_GPIO_KEY_INT);\r\nPFER = GPIO_bit(SPITZ_GPIO_KEY_INT) | GPIO_bit(SPITZ_GPIO_RESET);\r\nPWER = GPIO_bit(SPITZ_GPIO_KEY_INT) | GPIO_bit(SPITZ_GPIO_RESET) | PWER_RTC;\r\nPKWR = GPIO_bit(SPITZ_GPIO_SYNC) | GPIO_bit(SPITZ_GPIO_KEY_INT) | GPIO_bit(SPITZ_GPIO_RESET);\r\nPKSR = 0xffffffff;\r\nPSLR |= PSLR_SL_ROD;\r\nPCFR = PCFR_GPR_EN | PCFR_OPDE;\r\n}\r\nstatic void spitz_postsuspend(void)\r\n{\r\npxa2xx_mfp_config(&gpio18_config[1], 1);\r\n}\r\nstatic int spitz_should_wakeup(unsigned int resume_on_alarm)\r\n{\r\nint is_resume = 0;\r\nint acin = sharpsl_pm.machinfo->read_devdata(SHARPSL_STATUS_ACIN);\r\nif (spitz_last_ac_status != acin) {\r\nif (acin) {\r\nsharpsl_pm.flags |= SHARPSL_DO_OFFLINE_CHRG;\r\ndev_dbg(sharpsl_pm.dev, "AC Inserted\n");\r\n} else {\r\ndev_dbg(sharpsl_pm.dev, "AC Removed\n");\r\nsharpsl_pm_led(SHARPSL_LED_OFF);\r\nsharpsl_pm.machinfo->charge(0);\r\nsharpsl_pm.charge_mode = CHRG_OFF;\r\n}\r\nspitz_last_ac_status = acin;\r\nreturn 0;\r\n}\r\nif (PEDR & GPIO_bit(SPITZ_GPIO_KEY_INT))\r\nis_resume |= GPIO_bit(SPITZ_GPIO_KEY_INT);\r\nif (PKSR & GPIO_bit(SPITZ_GPIO_SYNC))\r\nis_resume |= GPIO_bit(SPITZ_GPIO_SYNC);\r\nif (resume_on_alarm && (PEDR & PWER_RTC))\r\nis_resume |= PWER_RTC;\r\ndev_dbg(sharpsl_pm.dev, "is_resume: %x\n", is_resume);\r\nreturn is_resume;\r\n}\r\nstatic unsigned long spitz_charger_wakeup(void)\r\n{\r\nreturn (~GPLR0 & GPIO_bit(SPITZ_GPIO_KEY_INT)) | (GPLR0 & GPIO_bit(SPITZ_GPIO_SYNC));\r\n}\r\nunsigned long spitzpm_read_devdata(int type)\r\n{\r\nswitch (type) {\r\ncase SHARPSL_STATUS_ACIN:\r\nreturn (((~GPLR(SPITZ_GPIO_AC_IN)) & GPIO_bit(SPITZ_GPIO_AC_IN)) != 0);\r\ncase SHARPSL_STATUS_LOCK:\r\nreturn gpio_get_value(sharpsl_pm.machinfo->gpio_batlock);\r\ncase SHARPSL_STATUS_CHRGFULL:\r\nreturn gpio_get_value(sharpsl_pm.machinfo->gpio_batfull);\r\ncase SHARPSL_STATUS_FATAL:\r\nreturn gpio_get_value(sharpsl_pm.machinfo->gpio_fatal);\r\ncase SHARPSL_ACIN_VOLT:\r\nreturn sharpsl_pm_pxa_read_max1111(MAX1111_ACIN_VOLT);\r\ncase SHARPSL_BATT_TEMP:\r\nreturn sharpsl_pm_pxa_read_max1111(MAX1111_BATT_TEMP);\r\ncase SHARPSL_BATT_VOLT:\r\ndefault:\r\nreturn sharpsl_pm_pxa_read_max1111(MAX1111_BATT_VOLT);\r\n}\r\n}\r\nstatic int __devinit spitzpm_init(void)\r\n{\r\nint ret;\r\nif (!machine_is_spitz() && !machine_is_akita()\r\n&& !machine_is_borzoi())\r\nreturn -ENODEV;\r\nspitzpm_device = platform_device_alloc("sharpsl-pm", -1);\r\nif (!spitzpm_device)\r\nreturn -ENOMEM;\r\nspitzpm_device->dev.platform_data = &spitz_pm_machinfo;\r\nret = platform_device_add(spitzpm_device);\r\nif (ret)\r\nplatform_device_put(spitzpm_device);\r\nreturn ret;\r\n}\r\nstatic void spitzpm_exit(void)\r\n{\r\nplatform_device_unregister(spitzpm_device);\r\n}

static void orion_wdt_ping(void)\r\n{\r\nspin_lock(&wdt_lock);\r\nwritel(wdt_tclk * heartbeat, WDT_VAL);\r\nspin_unlock(&wdt_lock);\r\n}\r\nstatic void orion_wdt_enable(void)\r\n{\r\nu32 reg;\r\nspin_lock(&wdt_lock);\r\nwritel(wdt_tclk * heartbeat, WDT_VAL);\r\nreg = readl(BRIDGE_CAUSE);\r\nreg &= ~WDT_INT_REQ;\r\nwritel(reg, BRIDGE_CAUSE);\r\nreg = readl(TIMER_CTRL);\r\nreg |= WDT_EN;\r\nwritel(reg, TIMER_CTRL);\r\nreg = readl(RSTOUTn_MASK);\r\nreg |= WDT_RESET_OUT_EN;\r\nwritel(reg, RSTOUTn_MASK);\r\nspin_unlock(&wdt_lock);\r\n}\r\nstatic void orion_wdt_disable(void)\r\n{\r\nu32 reg;\r\nspin_lock(&wdt_lock);\r\nreg = readl(RSTOUTn_MASK);\r\nreg &= ~WDT_RESET_OUT_EN;\r\nwritel(reg, RSTOUTn_MASK);\r\nreg = readl(TIMER_CTRL);\r\nreg &= ~WDT_EN;\r\nwritel(reg, TIMER_CTRL);\r\nspin_unlock(&wdt_lock);\r\n}\r\nstatic int orion_wdt_get_timeleft(int *time_left)\r\n{\r\nspin_lock(&wdt_lock);\r\n*time_left = readl(WDT_VAL) / wdt_tclk;\r\nspin_unlock(&wdt_lock);\r\nreturn 0;\r\n}\r\nstatic int orion_wdt_open(struct inode *inode, struct file *file)\r\n{\r\nif (test_and_set_bit(WDT_IN_USE, &wdt_status))\r\nreturn -EBUSY;\r\nclear_bit(WDT_OK_TO_CLOSE, &wdt_status);\r\norion_wdt_enable();\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic ssize_t orion_wdt_write(struct file *file, const char *data,\r\nsize_t len, loff_t *ppos)\r\n{\r\nif (len) {\r\nif (!nowayout) {\r\nsize_t i;\r\nclear_bit(WDT_OK_TO_CLOSE, &wdt_status);\r\nfor (i = 0; i != len; i++) {\r\nchar c;\r\nif (get_user(c, data + i))\r\nreturn -EFAULT;\r\nif (c == 'V')\r\nset_bit(WDT_OK_TO_CLOSE, &wdt_status);\r\n}\r\n}\r\norion_wdt_ping();\r\n}\r\nreturn len;\r\n}\r\nstatic int orion_wdt_settimeout(int new_time)\r\n{\r\nif ((new_time <= 0) || (new_time > wdt_max_duration))\r\nreturn -EINVAL;\r\nheartbeat = new_time;\r\nreturn 0;\r\n}\r\nstatic long orion_wdt_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nint ret = -ENOTTY;\r\nint time;\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nret = copy_to_user((struct watchdog_info *)arg, &ident,\r\nsizeof(ident)) ? -EFAULT : 0;\r\nbreak;\r\ncase WDIOC_GETSTATUS:\r\ncase WDIOC_GETBOOTSTATUS:\r\nret = put_user(0, (int *)arg);\r\nbreak;\r\ncase WDIOC_KEEPALIVE:\r\norion_wdt_ping();\r\nret = 0;\r\nbreak;\r\ncase WDIOC_SETTIMEOUT:\r\nret = get_user(time, (int *)arg);\r\nif (ret)\r\nbreak;\r\nif (orion_wdt_settimeout(time)) {\r\nret = -EINVAL;\r\nbreak;\r\n}\r\norion_wdt_ping();\r\ncase WDIOC_GETTIMEOUT:\r\nret = put_user(heartbeat, (int *)arg);\r\nbreak;\r\ncase WDIOC_GETTIMELEFT:\r\nif (orion_wdt_get_timeleft(&time)) {\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nret = put_user(time, (int *)arg);\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int orion_wdt_release(struct inode *inode, struct file *file)\r\n{\r\nif (test_bit(WDT_OK_TO_CLOSE, &wdt_status))\r\norion_wdt_disable();\r\nelse\r\nprintk(KERN_CRIT "WATCHDOG: Device closed unexpectedly - "\r\n"timer will not stop\n");\r\nclear_bit(WDT_IN_USE, &wdt_status);\r\nclear_bit(WDT_OK_TO_CLOSE, &wdt_status);\r\nreturn 0;\r\n}\r\nstatic int __devinit orion_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct orion_wdt_platform_data *pdata = pdev->dev.platform_data;\r\nint ret;\r\nif (pdata) {\r\nwdt_tclk = pdata->tclk;\r\n} else {\r\nprintk(KERN_ERR "Orion Watchdog misses platform data\n");\r\nreturn -ENODEV;\r\n}\r\nif (orion_wdt_miscdev.parent)\r\nreturn -EBUSY;\r\norion_wdt_miscdev.parent = &pdev->dev;\r\nwdt_max_duration = WDT_MAX_CYCLE_COUNT / wdt_tclk;\r\nif (orion_wdt_settimeout(heartbeat))\r\nheartbeat = wdt_max_duration;\r\nret = misc_register(&orion_wdt_miscdev);\r\nif (ret)\r\nreturn ret;\r\nprintk(KERN_INFO "Orion Watchdog Timer: Initial timeout %d sec%s\n",\r\nheartbeat, nowayout ? ", nowayout" : "");\r\nreturn 0;\r\n}\r\nstatic int __devexit orion_wdt_remove(struct platform_device *pdev)\r\n{\r\nint ret;\r\nif (test_bit(WDT_IN_USE, &wdt_status)) {\r\norion_wdt_disable();\r\nclear_bit(WDT_IN_USE, &wdt_status);\r\n}\r\nret = misc_deregister(&orion_wdt_miscdev);\r\nif (!ret)\r\norion_wdt_miscdev.parent = NULL;\r\nreturn ret;\r\n}\r\nstatic void orion_wdt_shutdown(struct platform_device *pdev)\r\n{\r\nif (test_bit(WDT_IN_USE, &wdt_status))\r\norion_wdt_disable();\r\n}\r\nstatic int __init orion_wdt_init(void)\r\n{\r\nspin_lock_init(&wdt_lock);\r\nreturn platform_driver_register(&orion_wdt_driver);\r\n}\r\nstatic void __exit orion_wdt_exit(void)\r\n{\r\nplatform_driver_unregister(&orion_wdt_driver);\r\n}

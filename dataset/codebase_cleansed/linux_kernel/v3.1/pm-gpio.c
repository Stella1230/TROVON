static void s3c_gpio_pm_1bit_save(struct s3c_gpio_chip *chip)\r\n{\r\nchip->pm_save[0] = __raw_readl(chip->base + OFFS_CON);\r\nchip->pm_save[1] = __raw_readl(chip->base + OFFS_DAT);\r\n}\r\nstatic void s3c_gpio_pm_1bit_resume(struct s3c_gpio_chip *chip)\r\n{\r\nvoid __iomem *base = chip->base;\r\nu32 old_gpcon = __raw_readl(base + OFFS_CON);\r\nu32 old_gpdat = __raw_readl(base + OFFS_DAT);\r\nu32 gps_gpcon = chip->pm_save[0];\r\nu32 gps_gpdat = chip->pm_save[1];\r\nu32 gpcon;\r\ngpcon = old_gpcon | gps_gpcon;\r\n__raw_writel(gpcon, base + OFFS_CON);\r\n__raw_writel(gps_gpdat, base + OFFS_DAT);\r\n__raw_writel(gps_gpcon, base + OFFS_CON);\r\nS3C_PMDBG("%s: CON %08x => %08x, DAT %08x => %08x\n",\r\nchip->chip.label, old_gpcon, gps_gpcon, old_gpdat, gps_gpdat);\r\n}\r\nstatic void s3c_gpio_pm_2bit_save(struct s3c_gpio_chip *chip)\r\n{\r\nchip->pm_save[0] = __raw_readl(chip->base + OFFS_CON);\r\nchip->pm_save[1] = __raw_readl(chip->base + OFFS_DAT);\r\nchip->pm_save[2] = __raw_readl(chip->base + OFFS_UP);\r\n}\r\nstatic inline int is_sfn(unsigned long con)\r\n{\r\nreturn con >= 2;\r\n}\r\nstatic inline int is_in(unsigned long con)\r\n{\r\nreturn con == 0;\r\n}\r\nstatic inline int is_out(unsigned long con)\r\n{\r\nreturn con == 1;\r\n}\r\nstatic void s3c_gpio_pm_2bit_resume(struct s3c_gpio_chip *chip)\r\n{\r\nvoid __iomem *base = chip->base;\r\nu32 old_gpcon = __raw_readl(base + OFFS_CON);\r\nu32 old_gpdat = __raw_readl(base + OFFS_DAT);\r\nu32 gps_gpcon = chip->pm_save[0];\r\nu32 gps_gpdat = chip->pm_save[1];\r\nu32 gpcon, old, new, mask;\r\nu32 change_mask = 0x0;\r\nint nr;\r\n__raw_writel(chip->pm_save[2], base + OFFS_UP);\r\nfor (nr = 0, mask = 0x03; nr < 32; nr += 2, mask <<= 2) {\r\nold = (old_gpcon & mask) >> nr;\r\nnew = (gps_gpcon & mask) >> nr;\r\nif (old == new)\r\ncontinue;\r\nif (is_sfn(old) && is_sfn(new))\r\ncontinue;\r\nif (is_in(old) && is_out(new))\r\ncontinue;\r\nif (is_sfn(old) && is_out(new))\r\ncontinue;\r\nchange_mask |= mask;\r\n}\r\ngpcon = old_gpcon & ~change_mask;\r\ngpcon |= gps_gpcon & change_mask;\r\n__raw_writel(gpcon, base + OFFS_CON);\r\n__raw_writel(gps_gpdat, base + OFFS_DAT);\r\n__raw_writel(gps_gpcon, base + OFFS_CON);\r\nS3C_PMDBG("%s: CON %08x => %08x, DAT %08x => %08x\n",\r\nchip->chip.label, old_gpcon, gps_gpcon, old_gpdat, gps_gpdat);\r\n}\r\nstatic void s3c_gpio_pm_4bit_save(struct s3c_gpio_chip *chip)\r\n{\r\nchip->pm_save[1] = __raw_readl(chip->base + OFFS_CON);\r\nchip->pm_save[2] = __raw_readl(chip->base + OFFS_DAT);\r\nchip->pm_save[3] = __raw_readl(chip->base + OFFS_UP);\r\nif (chip->chip.ngpio > 8)\r\nchip->pm_save[0] = __raw_readl(chip->base - 4);\r\n}\r\nstatic u32 s3c_gpio_pm_4bit_mask(u32 old_gpcon, u32 gps_gpcon)\r\n{\r\nu32 old, new, mask;\r\nu32 change_mask = 0x0;\r\nint nr;\r\nfor (nr = 0, mask = 0x0f; nr < 16; nr += 4, mask <<= 4) {\r\nold = (old_gpcon & mask) >> nr;\r\nnew = (gps_gpcon & mask) >> nr;\r\nif (old == new)\r\ncontinue;\r\nif (is_sfn(old) && is_sfn(new))\r\ncontinue;\r\nif (is_in(old) && is_out(new))\r\ncontinue;\r\nif (is_sfn(old) && is_out(new))\r\ncontinue;\r\nchange_mask |= mask;\r\n}\r\nreturn change_mask;\r\n}\r\nstatic void s3c_gpio_pm_4bit_con(struct s3c_gpio_chip *chip, int index)\r\n{\r\nvoid __iomem *con = chip->base + (index * 4);\r\nu32 old_gpcon = __raw_readl(con);\r\nu32 gps_gpcon = chip->pm_save[index + 1];\r\nu32 gpcon, mask;\r\nmask = s3c_gpio_pm_4bit_mask(old_gpcon, gps_gpcon);\r\ngpcon = old_gpcon & ~mask;\r\ngpcon |= gps_gpcon & mask;\r\n__raw_writel(gpcon, con);\r\n}\r\nstatic void s3c_gpio_pm_4bit_resume(struct s3c_gpio_chip *chip)\r\n{\r\nvoid __iomem *base = chip->base;\r\nu32 old_gpcon[2];\r\nu32 old_gpdat = __raw_readl(base + OFFS_DAT);\r\nu32 gps_gpdat = chip->pm_save[2];\r\nold_gpcon[0] = 0;\r\nold_gpcon[1] = __raw_readl(base + OFFS_CON);\r\ns3c_gpio_pm_4bit_con(chip, 0);\r\nif (chip->chip.ngpio > 8) {\r\nold_gpcon[0] = __raw_readl(base - 4);\r\ns3c_gpio_pm_4bit_con(chip, -1);\r\n}\r\n__raw_writel(chip->pm_save[2], base + OFFS_DAT);\r\n__raw_writel(chip->pm_save[1], base + OFFS_CON);\r\nif (chip->chip.ngpio > 8)\r\n__raw_writel(chip->pm_save[0], base - 4);\r\n__raw_writel(chip->pm_save[2], base + OFFS_DAT);\r\n__raw_writel(chip->pm_save[3], base + OFFS_UP);\r\nif (chip->chip.ngpio > 8) {\r\nS3C_PMDBG("%s: CON4 %08x,%08x => %08x,%08x, DAT %08x => %08x\n",\r\nchip->chip.label, old_gpcon[0], old_gpcon[1],\r\n__raw_readl(base - 4),\r\n__raw_readl(base + OFFS_CON),\r\nold_gpdat, gps_gpdat);\r\n} else\r\nS3C_PMDBG("%s: CON4 %08x => %08x, DAT %08x => %08x\n",\r\nchip->chip.label, old_gpcon[1],\r\n__raw_readl(base + OFFS_CON),\r\nold_gpdat, gps_gpdat);\r\n}\r\nstatic void s3c_pm_save_gpio(struct s3c_gpio_chip *ourchip)\r\n{\r\nstruct s3c_gpio_pm *pm = ourchip->pm;\r\nif (pm == NULL || pm->save == NULL)\r\nS3C_PMDBG("%s: no pm for %s\n", __func__, ourchip->chip.label);\r\nelse\r\npm->save(ourchip);\r\n}\r\nvoid s3c_pm_save_gpios(void)\r\n{\r\nstruct s3c_gpio_chip *ourchip;\r\nunsigned int gpio_nr;\r\nfor (gpio_nr = 0; gpio_nr < S3C_GPIO_END;) {\r\nourchip = s3c_gpiolib_getchip(gpio_nr);\r\nif (!ourchip) {\r\ngpio_nr++;\r\ncontinue;\r\n}\r\ns3c_pm_save_gpio(ourchip);\r\nS3C_PMDBG("%s: save %08x,%08x,%08x,%08x\n",\r\nourchip->chip.label,\r\nourchip->pm_save[0],\r\nourchip->pm_save[1],\r\nourchip->pm_save[2],\r\nourchip->pm_save[3]);\r\ngpio_nr += ourchip->chip.ngpio;\r\ngpio_nr += CONFIG_S3C_GPIO_SPACE;\r\n}\r\n}\r\nstatic void s3c_pm_resume_gpio(struct s3c_gpio_chip *ourchip)\r\n{\r\nstruct s3c_gpio_pm *pm = ourchip->pm;\r\nif (pm == NULL || pm->resume == NULL)\r\nS3C_PMDBG("%s: no pm for %s\n", __func__, ourchip->chip.label);\r\nelse\r\npm->resume(ourchip);\r\n}\r\nvoid s3c_pm_restore_gpios(void)\r\n{\r\nstruct s3c_gpio_chip *ourchip;\r\nunsigned int gpio_nr;\r\nfor (gpio_nr = 0; gpio_nr < S3C_GPIO_END;) {\r\nourchip = s3c_gpiolib_getchip(gpio_nr);\r\nif (!ourchip) {\r\ngpio_nr++;\r\ncontinue;\r\n}\r\ns3c_pm_resume_gpio(ourchip);\r\ngpio_nr += ourchip->chip.ngpio;\r\ngpio_nr += CONFIG_S3C_GPIO_SPACE;\r\n}\r\n}

static void reg_w1(struct gspca_dev *gspca_dev,\r\n__u16 index, __u8 value)\r\n{\r\ngspca_dev->usb_buf[0] = value;\r\nusb_control_msg(gspca_dev->dev,\r\nusb_sndctrlpipe(gspca_dev->dev, 0),\r\n0x02,\r\nUSB_DIR_OUT | USB_TYPE_VENDOR | USB_RECIP_DEVICE,\r\n0,\r\nindex, gspca_dev->usb_buf, 1, 500);\r\n}\r\nstatic void reg_w2(struct gspca_dev *gspca_dev,\r\nu16 index, u16 value)\r\n{\r\ngspca_dev->usb_buf[0] = value;\r\ngspca_dev->usb_buf[1] = value >> 8;\r\nusb_control_msg(gspca_dev->dev,\r\nusb_sndctrlpipe(gspca_dev->dev, 0),\r\n0x02,\r\nUSB_DIR_OUT | USB_TYPE_VENDOR | USB_RECIP_DEVICE,\r\n0,\r\nindex, gspca_dev->usb_buf, 2, 500);\r\n}\r\nstatic void tv_8532WriteEEprom(struct gspca_dev *gspca_dev)\r\n{\r\nint i;\r\nreg_w1(gspca_dev, R01_TIMING_CONTROL_LOW, CMD_EEprom_Open);\r\nfor (i = 0; i < ARRAY_SIZE(eeprom_data); i++) {\r\nreg_w1(gspca_dev, R03_TABLE_ADDR, i);\r\nreg_w1(gspca_dev, R04_WTRAM_DATA_L, eeprom_data[i][2]);\r\nreg_w1(gspca_dev, R05_WTRAM_DATA_M, eeprom_data[i][1]);\r\nreg_w1(gspca_dev, R06_WTRAM_DATA_H, eeprom_data[i][0]);\r\nreg_w1(gspca_dev, R08_RAM_WRITE_ACTION, 0);\r\n}\r\nreg_w1(gspca_dev, R07_TABLE_LEN, i);\r\nreg_w1(gspca_dev, R01_TIMING_CONTROL_LOW, CMD_EEprom_Close);\r\n}\r\nstatic int sd_config(struct gspca_dev *gspca_dev,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nstruct cam *cam;\r\ncam = &gspca_dev->cam;\r\ncam->cam_mode = sif_mode;\r\ncam->nmodes = ARRAY_SIZE(sif_mode);\r\nsd->exposure = EXPOSURE_DEF;\r\nsd->gain = GAIN_DEF;\r\nreturn 0;\r\n}\r\nstatic void tv_8532_setReg(struct gspca_dev *gspca_dev)\r\n{\r\nreg_w1(gspca_dev, R3B_Test3, 0x0a);\r\nreg_w1(gspca_dev, R0E_AD_HEIGHTL, 0x90);\r\nreg_w1(gspca_dev, R0F_AD_HEIGHTH, 0x01);\r\nreg_w2(gspca_dev, R1C_AD_EXPOSE_TIMEL, 0x018f);\r\nreg_w1(gspca_dev, R10_AD_COL_BEGINL, 0x44);\r\nreg_w1(gspca_dev, R11_AD_COL_BEGINH, 0x00);\r\nreg_w1(gspca_dev, R14_AD_ROW_BEGINL, 0x0a);\r\nreg_w1(gspca_dev, R94_AD_BITCONTROL, 0x02);\r\nreg_w1(gspca_dev, R91_AD_SLOPEREG, 0x00);\r\nreg_w1(gspca_dev, R00_PART_CONTROL, LATENT_CHANGE | EXPO_CHANGE);\r\n}\r\nstatic int sd_init(struct gspca_dev *gspca_dev)\r\n{\r\ntv_8532WriteEEprom(gspca_dev);\r\nreturn 0;\r\n}\r\nstatic void setexposure(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nreg_w2(gspca_dev, R1C_AD_EXPOSE_TIMEL, sd->exposure);\r\nreg_w1(gspca_dev, R00_PART_CONTROL, LATENT_CHANGE | EXPO_CHANGE);\r\n}\r\nstatic void setgain(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nreg_w2(gspca_dev, R20_GAIN_G1L, sd->gain);\r\nreg_w2(gspca_dev, R22_GAIN_RL, sd->gain);\r\nreg_w2(gspca_dev, R24_GAIN_BL, sd->gain);\r\nreg_w2(gspca_dev, R26_GAIN_G2L, sd->gain);\r\n}\r\nstatic int sd_start(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nreg_w1(gspca_dev, R0C_AD_WIDTHL, 0xe8);\r\nreg_w1(gspca_dev, R0D_AD_WIDTHH, 0x03);\r\nreg_w1(gspca_dev, R28_QUANT, 0x90);\r\nif (gspca_dev->cam.cam_mode[(int) gspca_dev->curr_mode].priv) {\r\nreg_w1(gspca_dev, R29_LINE, 0x41);\r\n} else {\r\nreg_w1(gspca_dev, R29_LINE, 0x81);\r\n}\r\nreg_w1(gspca_dev, R2C_POLARITY, 0x10);\r\nreg_w1(gspca_dev, R2D_POINT, 0x14);\r\nreg_w1(gspca_dev, R2E_POINTH, 0x01);\r\nreg_w1(gspca_dev, R2F_POINTB, 0x12);\r\nreg_w1(gspca_dev, R30_POINTBH, 0x01);\r\ntv_8532_setReg(gspca_dev);\r\nsetexposure(gspca_dev);\r\nsetgain(gspca_dev);\r\nreg_w1(gspca_dev, R31_UPD, 0x01);\r\nmsleep(200);\r\nreg_w1(gspca_dev, R31_UPD, 0x00);\r\ngspca_dev->empty_packet = 0;\r\nsd->packet = 0;\r\nreturn 0;\r\n}\r\nstatic void sd_stopN(struct gspca_dev *gspca_dev)\r\n{\r\nreg_w1(gspca_dev, R3B_Test3, 0x0b);\r\n}\r\nstatic void sd_pkt_scan(struct gspca_dev *gspca_dev,\r\nu8 *data,\r\nint len)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nint packet_type0, packet_type1;\r\npacket_type0 = packet_type1 = INTER_PACKET;\r\nif (gspca_dev->empty_packet) {\r\ngspca_dev->empty_packet = 0;\r\nsd->packet = gspca_dev->height / 2;\r\npacket_type0 = FIRST_PACKET;\r\n} else if (sd->packet == 0)\r\nreturn;\r\nsd->packet--;\r\nif (sd->packet == 0)\r\npacket_type1 = LAST_PACKET;\r\ngspca_frame_add(gspca_dev, packet_type0,\r\ndata + 2, gspca_dev->width);\r\ngspca_frame_add(gspca_dev, packet_type1,\r\ndata + gspca_dev->width + 5, gspca_dev->width);\r\n}\r\nstatic int sd_setexposure(struct gspca_dev *gspca_dev, __s32 val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nsd->exposure = val;\r\nif (gspca_dev->streaming)\r\nsetexposure(gspca_dev);\r\nreturn 0;\r\n}\r\nstatic int sd_getexposure(struct gspca_dev *gspca_dev, __s32 *val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\n*val = sd->exposure;\r\nreturn 0;\r\n}\r\nstatic int sd_setgain(struct gspca_dev *gspca_dev, __s32 val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nsd->gain = val;\r\nif (gspca_dev->streaming)\r\nsetgain(gspca_dev);\r\nreturn 0;\r\n}\r\nstatic int sd_getgain(struct gspca_dev *gspca_dev, __s32 *val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\n*val = sd->gain;\r\nreturn 0;\r\n}\r\nstatic int sd_probe(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nreturn gspca_dev_probe(intf, id, &sd_desc, sizeof(struct sd),\r\nTHIS_MODULE);\r\n}\r\nstatic int __init sd_mod_init(void)\r\n{\r\nreturn usb_register(&sd_driver);\r\n}\r\nstatic void __exit sd_mod_exit(void)\r\n{\r\nusb_deregister(&sd_driver);\r\n}

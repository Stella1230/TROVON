static int ab3100_enable_regulator(struct regulator_dev *reg)\r\n{\r\nstruct ab3100_regulator *abreg = reg->reg_data;\r\nint err;\r\nu8 regval;\r\nerr = abx500_get_register_interruptible(abreg->dev, 0, abreg->regreg,\r\n&regval);\r\nif (err) {\r\ndev_warn(&reg->dev, "failed to get regid %d value\n",\r\nabreg->regreg);\r\nreturn err;\r\n}\r\nif (regval & AB3100_REG_ON_MASK)\r\nreturn 0;\r\nregval |= AB3100_REG_ON_MASK;\r\nerr = abx500_set_register_interruptible(abreg->dev, 0, abreg->regreg,\r\nregval);\r\nif (err) {\r\ndev_warn(&reg->dev, "failed to set regid %d value\n",\r\nabreg->regreg);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ab3100_disable_regulator(struct regulator_dev *reg)\r\n{\r\nstruct ab3100_regulator *abreg = reg->reg_data;\r\nint err;\r\nu8 regval;\r\npr_info("Called ab3100_disable_regulator\n");\r\nif (abreg->regreg == AB3100_LDO_D) {\r\ndev_info(&reg->dev, "disabling LDO D - shut down system\n");\r\nreturn abx500_set_register_interruptible(abreg->dev, 0,\r\nAB3100_LDO_D, 0x00U);\r\n}\r\nerr = abx500_get_register_interruptible(abreg->dev, 0, abreg->regreg,\r\n&regval);\r\nif (err) {\r\ndev_err(&reg->dev, "unable to get register 0x%x\n",\r\nabreg->regreg);\r\nreturn err;\r\n}\r\nregval &= ~AB3100_REG_ON_MASK;\r\nreturn abx500_set_register_interruptible(abreg->dev, 0, abreg->regreg,\r\nregval);\r\n}\r\nstatic int ab3100_is_enabled_regulator(struct regulator_dev *reg)\r\n{\r\nstruct ab3100_regulator *abreg = reg->reg_data;\r\nu8 regval;\r\nint err;\r\nerr = abx500_get_register_interruptible(abreg->dev, 0, abreg->regreg,\r\n&regval);\r\nif (err) {\r\ndev_err(&reg->dev, "unable to get register 0x%x\n",\r\nabreg->regreg);\r\nreturn err;\r\n}\r\nreturn regval & AB3100_REG_ON_MASK;\r\n}\r\nstatic int ab3100_list_voltage_regulator(struct regulator_dev *reg,\r\nunsigned selector)\r\n{\r\nstruct ab3100_regulator *abreg = reg->reg_data;\r\nif (selector >= abreg->voltages_len)\r\nreturn -EINVAL;\r\nreturn abreg->typ_voltages[selector];\r\n}\r\nstatic int ab3100_get_voltage_regulator(struct regulator_dev *reg)\r\n{\r\nstruct ab3100_regulator *abreg = reg->reg_data;\r\nu8 regval;\r\nint err;\r\nif (abreg->fixed_voltage)\r\nreturn abreg->fixed_voltage;\r\nerr = abx500_get_register_interruptible(abreg->dev, 0,\r\nabreg->regreg, &regval);\r\nif (err) {\r\ndev_warn(&reg->dev,\r\n"failed to get regulator value in register %02x\n",\r\nabreg->regreg);\r\nreturn err;\r\n}\r\nregval &= 0xE0;\r\nregval >>= 5;\r\nif (regval >= abreg->voltages_len) {\r\ndev_err(&reg->dev,\r\n"regulator register %02x contains an illegal voltage setting\n",\r\nabreg->regreg);\r\nreturn -EINVAL;\r\n}\r\nreturn abreg->typ_voltages[regval];\r\n}\r\nstatic int ab3100_get_best_voltage_index(struct regulator_dev *reg,\r\nint min_uV, int max_uV)\r\n{\r\nstruct ab3100_regulator *abreg = reg->reg_data;\r\nint i;\r\nint bestmatch;\r\nint bestindex;\r\nbestmatch = INT_MAX;\r\nbestindex = -1;\r\nfor (i = 0; i < abreg->voltages_len; i++) {\r\nif (abreg->typ_voltages[i] <= max_uV &&\r\nabreg->typ_voltages[i] >= min_uV &&\r\nabreg->typ_voltages[i] < bestmatch) {\r\nbestmatch = abreg->typ_voltages[i];\r\nbestindex = i;\r\n}\r\n}\r\nif (bestindex < 0) {\r\ndev_warn(&reg->dev, "requested %d<=x<=%d uV, out of range!\n",\r\nmin_uV, max_uV);\r\nreturn -EINVAL;\r\n}\r\nreturn bestindex;\r\n}\r\nstatic int ab3100_set_voltage_regulator(struct regulator_dev *reg,\r\nint min_uV, int max_uV,\r\nunsigned *selector)\r\n{\r\nstruct ab3100_regulator *abreg = reg->reg_data;\r\nu8 regval;\r\nint err;\r\nint bestindex;\r\nbestindex = ab3100_get_best_voltage_index(reg, min_uV, max_uV);\r\nif (bestindex < 0)\r\nreturn bestindex;\r\n*selector = bestindex;\r\nerr = abx500_get_register_interruptible(abreg->dev, 0,\r\nabreg->regreg, &regval);\r\nif (err) {\r\ndev_warn(&reg->dev,\r\n"failed to get regulator register %02x\n",\r\nabreg->regreg);\r\nreturn err;\r\n}\r\nregval &= ~0xE0;\r\nregval |= (bestindex << 5);\r\nerr = abx500_set_register_interruptible(abreg->dev, 0,\r\nabreg->regreg, regval);\r\nif (err)\r\ndev_warn(&reg->dev, "failed to set regulator register %02x\n",\r\nabreg->regreg);\r\nreturn err;\r\n}\r\nstatic int ab3100_set_suspend_voltage_regulator(struct regulator_dev *reg,\r\nint uV)\r\n{\r\nstruct ab3100_regulator *abreg = reg->reg_data;\r\nu8 regval;\r\nint err;\r\nint bestindex;\r\nu8 targetreg;\r\nif (abreg->regreg == AB3100_LDO_E)\r\ntargetreg = AB3100_LDO_E_SLEEP;\r\nelse if (abreg->regreg == AB3100_BUCK)\r\ntargetreg = AB3100_BUCK_SLEEP;\r\nelse\r\nreturn -EINVAL;\r\nbestindex = ab3100_get_best_voltage_index(reg, uV, uV);\r\nerr = abx500_get_register_interruptible(abreg->dev, 0,\r\ntargetreg, &regval);\r\nif (err) {\r\ndev_warn(&reg->dev,\r\n"failed to get regulator register %02x\n",\r\ntargetreg);\r\nreturn err;\r\n}\r\nregval &= ~0xE0;\r\nregval |= (bestindex << 5);\r\nerr = abx500_set_register_interruptible(abreg->dev, 0,\r\ntargetreg, regval);\r\nif (err)\r\ndev_warn(&reg->dev, "failed to set regulator register %02x\n",\r\nabreg->regreg);\r\nreturn err;\r\n}\r\nstatic int ab3100_get_voltage_regulator_external(struct regulator_dev *reg)\r\n{\r\nstruct ab3100_regulator *abreg = reg->reg_data;\r\nreturn abreg->plfdata->external_voltage;\r\n}\r\nstatic int ab3100_enable_time_regulator(struct regulator_dev *reg)\r\n{\r\nstruct ab3100_regulator *abreg = reg->reg_data;\r\nswitch (abreg->regreg) {\r\ncase AB3100_LDO_A:\r\ncase AB3100_LDO_C:\r\ncase AB3100_LDO_D:\r\ncase AB3100_LDO_E:\r\ncase AB3100_LDO_H:\r\ncase AB3100_LDO_K:\r\nreturn 200;\r\ncase AB3100_LDO_F:\r\nreturn 600;\r\ncase AB3100_LDO_G:\r\nreturn 400;\r\ncase AB3100_BUCK:\r\nreturn 1000;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devinit ab3100_regulators_probe(struct platform_device *pdev)\r\n{\r\nstruct ab3100_platform_data *plfdata = pdev->dev.platform_data;\r\nint err = 0;\r\nu8 data;\r\nint i;\r\nerr = abx500_get_register_interruptible(&pdev->dev, 0,\r\nAB3100_LDO_D, &data);\r\nif (err) {\r\ndev_err(&pdev->dev, "could not read initial status of LDO_D\n");\r\nreturn err;\r\n}\r\nif (data & 0x10)\r\ndev_notice(&pdev->dev,\r\n"chip is already in active mode (Warm start)\n");\r\nelse\r\ndev_notice(&pdev->dev,\r\n"chip is in inactive mode (Cold start)\n");\r\nfor (i = 0; i < ARRAY_SIZE(ab3100_reg_init_order); i++) {\r\nerr = abx500_set_register_interruptible(&pdev->dev, 0,\r\nab3100_reg_init_order[i],\r\nplfdata->reg_initvals[i]);\r\nif (err) {\r\ndev_err(&pdev->dev, "regulator initialization failed with error %d\n",\r\nerr);\r\nreturn err;\r\n}\r\n}\r\nfor (i = 0; i < AB3100_NUM_REGULATORS; i++) {\r\nstruct ab3100_regulator *reg = &ab3100_regulators[i];\r\nstruct regulator_dev *rdev;\r\nreg->dev = &pdev->dev;\r\nreg->plfdata = plfdata;\r\nrdev = regulator_register(&ab3100_regulator_desc[i],\r\n&pdev->dev,\r\n&plfdata->reg_constraints[i],\r\nreg);\r\nif (IS_ERR(rdev)) {\r\nerr = PTR_ERR(rdev);\r\ndev_err(&pdev->dev,\r\n"%s: failed to register regulator %s err %d\n",\r\n__func__, ab3100_regulator_desc[i].name,\r\nerr);\r\nwhile (--i >= 0)\r\nregulator_unregister(ab3100_regulators[i].rdev);\r\nreturn err;\r\n}\r\nreg->rdev = rdev;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devexit ab3100_regulators_remove(struct platform_device *pdev)\r\n{\r\nint i;\r\nfor (i = 0; i < AB3100_NUM_REGULATORS; i++) {\r\nstruct ab3100_regulator *reg = &ab3100_regulators[i];\r\nregulator_unregister(reg->rdev);\r\n}\r\nreturn 0;\r\n}\r\nstatic __init int ab3100_regulators_init(void)\r\n{\r\nreturn platform_driver_register(&ab3100_regulators_driver);\r\n}\r\nstatic __exit void ab3100_regulators_exit(void)\r\n{\r\nplatform_driver_unregister(&ab3100_regulators_driver);\r\n}

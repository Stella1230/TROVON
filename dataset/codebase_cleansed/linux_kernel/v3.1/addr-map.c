static void __init __iomem *win_cfg_base(int win)\r\n{\r\nreturn (void __iomem *)((win < 8) ? WIN0_OFF(win) : WIN8_OFF(win));\r\n}\r\nstatic int __init cpu_win_can_remap(int win)\r\n{\r\nif (win < 8)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic void __init setup_cpu_win(int win, u32 base, u32 size,\r\nu8 target, u8 attr, int remap)\r\n{\r\nvoid __iomem *addr = win_cfg_base(win);\r\nu32 ctrl;\r\nbase &= 0xffff0000;\r\nctrl = ((size - 1) & 0xffff0000) | (attr << 8) | (target << 4) | 1;\r\nwritel(base, addr + WIN_BASE_OFF);\r\nwritel(ctrl, addr + WIN_CTRL_OFF);\r\nif (cpu_win_can_remap(win)) {\r\nif (remap < 0)\r\nremap = base;\r\nwritel(remap & 0xffff0000, addr + WIN_REMAP_LO_OFF);\r\nwritel(0, addr + WIN_REMAP_HI_OFF);\r\n}\r\n}\r\nvoid __init mv78xx0_setup_cpu_mbus(void)\r\n{\r\nvoid __iomem *addr;\r\nint i;\r\nint cs;\r\nfor (i = 0; i < 14; i++) {\r\naddr = win_cfg_base(i);\r\nwritel(0, addr + WIN_BASE_OFF);\r\nwritel(0, addr + WIN_CTRL_OFF);\r\nif (cpu_win_can_remap(i)) {\r\nwritel(0, addr + WIN_REMAP_LO_OFF);\r\nwritel(0, addr + WIN_REMAP_HI_OFF);\r\n}\r\n}\r\nmv78xx0_mbus_dram_info.mbus_dram_target_id = TARGET_DDR;\r\nif (mv78xx0_core_index() == 0)\r\naddr = (void __iomem *)DDR_WINDOW_CPU0_BASE;\r\nelse\r\naddr = (void __iomem *)DDR_WINDOW_CPU1_BASE;\r\nfor (i = 0, cs = 0; i < 4; i++) {\r\nu32 base = readl(addr + DDR_BASE_CS_OFF(i));\r\nu32 size = readl(addr + DDR_SIZE_CS_OFF(i));\r\nif (size & 1) {\r\nstruct mbus_dram_window *w;\r\nw = &mv78xx0_mbus_dram_info.cs[cs++];\r\nw->cs_index = i;\r\nw->mbus_attr = 0xf & ~(1 << i);\r\nw->base = base & 0xffff0000;\r\nw->size = (size | 0x0000ffff) + 1;\r\n}\r\n}\r\nmv78xx0_mbus_dram_info.num_cs = cs;\r\n}\r\nvoid __init mv78xx0_setup_pcie_io_win(int window, u32 base, u32 size,\r\nint maj, int min)\r\n{\r\nsetup_cpu_win(window, base, size, TARGET_PCIE(maj),\r\nATTR_PCIE_IO(min), -1);\r\n}\r\nvoid __init mv78xx0_setup_pcie_mem_win(int window, u32 base, u32 size,\r\nint maj, int min)\r\n{\r\nsetup_cpu_win(window, base, size, TARGET_PCIE(maj),\r\nATTR_PCIE_MEM(min), -1);\r\n}

static void print_item(WINDOW * win, int choice, int selected)\r\n{\r\nint i;\r\nchar *list_item = malloc(list_width + 1);\r\nstrncpy(list_item, item_str(), list_width - item_x);\r\nlist_item[list_width - item_x] = '\0';\r\nwattrset(win, dlg.menubox.atr);\r\nwmove(win, choice, 0);\r\nfor (i = 0; i < list_width; i++)\r\nwaddch(win, ' ');\r\nwmove(win, choice, check_x);\r\nwattrset(win, selected ? dlg.check_selected.atr\r\n: dlg.check.atr);\r\nif (!item_is_tag(':'))\r\nwprintw(win, "(%c)", item_is_tag('X') ? 'X' : ' ');\r\nwattrset(win, selected ? dlg.tag_selected.atr : dlg.tag.atr);\r\nmvwaddch(win, choice, item_x, list_item[0]);\r\nwattrset(win, selected ? dlg.item_selected.atr : dlg.item.atr);\r\nwaddstr(win, list_item + 1);\r\nif (selected) {\r\nwmove(win, choice, check_x + 1);\r\nwrefresh(win);\r\n}\r\nfree(list_item);\r\n}\r\nstatic void print_arrows(WINDOW * win, int choice, int item_no, int scroll,\r\nint y, int x, int height)\r\n{\r\nwmove(win, y, x);\r\nif (scroll > 0) {\r\nwattrset(win, dlg.uarrow.atr);\r\nwaddch(win, ACS_UARROW);\r\nwaddstr(win, "(-)");\r\n} else {\r\nwattrset(win, dlg.menubox.atr);\r\nwaddch(win, ACS_HLINE);\r\nwaddch(win, ACS_HLINE);\r\nwaddch(win, ACS_HLINE);\r\nwaddch(win, ACS_HLINE);\r\n}\r\ny = y + height + 1;\r\nwmove(win, y, x);\r\nif ((height < item_no) && (scroll + choice < item_no - 1)) {\r\nwattrset(win, dlg.darrow.atr);\r\nwaddch(win, ACS_DARROW);\r\nwaddstr(win, "(+)");\r\n} else {\r\nwattrset(win, dlg.menubox_border.atr);\r\nwaddch(win, ACS_HLINE);\r\nwaddch(win, ACS_HLINE);\r\nwaddch(win, ACS_HLINE);\r\nwaddch(win, ACS_HLINE);\r\n}\r\n}\r\nstatic void print_buttons(WINDOW * dialog, int height, int width, int selected)\r\n{\r\nint x = width / 2 - 11;\r\nint y = height - 2;\r\nprint_button(dialog, gettext("Select"), y, x, selected == 0);\r\nprint_button(dialog, gettext(" Help "), y, x + 14, selected == 1);\r\nwmove(dialog, y, x + 1 + 14 * selected);\r\nwrefresh(dialog);\r\n}\r\nint dialog_checklist(const char *title, const char *prompt, int height,\r\nint width, int list_height)\r\n{\r\nint i, x, y, box_x, box_y;\r\nint key = 0, button = 0, choice = 0, scroll = 0, max_choice;\r\nWINDOW *dialog, *list;\r\nitem_foreach() {\r\nif (item_is_tag('X'))\r\nchoice = item_n();\r\nif (item_is_selected()) {\r\nchoice = item_n();\r\nbreak;\r\n}\r\n}\r\ndo_resize:\r\nif (getmaxy(stdscr) < (height + 6))\r\nreturn -ERRDISPLAYTOOSMALL;\r\nif (getmaxx(stdscr) < (width + 6))\r\nreturn -ERRDISPLAYTOOSMALL;\r\nmax_choice = MIN(list_height, item_count());\r\nx = (COLS - width) / 2;\r\ny = (LINES - height) / 2;\r\ndraw_shadow(stdscr, y, x, height, width);\r\ndialog = newwin(height, width, y, x);\r\nkeypad(dialog, TRUE);\r\ndraw_box(dialog, 0, 0, height, width,\r\ndlg.dialog.atr, dlg.border.atr);\r\nwattrset(dialog, dlg.border.atr);\r\nmvwaddch(dialog, height - 3, 0, ACS_LTEE);\r\nfor (i = 0; i < width - 2; i++)\r\nwaddch(dialog, ACS_HLINE);\r\nwattrset(dialog, dlg.dialog.atr);\r\nwaddch(dialog, ACS_RTEE);\r\nprint_title(dialog, title, width);\r\nwattrset(dialog, dlg.dialog.atr);\r\nprint_autowrap(dialog, prompt, width - 2, 1, 3);\r\nlist_width = width - 6;\r\nbox_y = height - list_height - 5;\r\nbox_x = (width - list_width) / 2 - 1;\r\nlist = subwin(dialog, list_height, list_width, y + box_y + 1,\r\nx + box_x + 1);\r\nkeypad(list, TRUE);\r\ndraw_box(dialog, box_y, box_x, list_height + 2, list_width + 2,\r\ndlg.menubox_border.atr, dlg.menubox.atr);\r\ncheck_x = 0;\r\nitem_foreach()\r\ncheck_x = MAX(check_x, strlen(item_str()) + 4);\r\ncheck_x = MIN(check_x, list_width);\r\ncheck_x = (list_width - check_x) / 2;\r\nitem_x = check_x + 4;\r\nif (choice >= list_height) {\r\nscroll = choice - list_height + 1;\r\nchoice -= scroll;\r\n}\r\nfor (i = 0; i < max_choice; i++) {\r\nitem_set(scroll + i);\r\nprint_item(list, i, i == choice);\r\n}\r\nprint_arrows(dialog, choice, item_count(), scroll,\r\nbox_y, box_x + check_x + 5, list_height);\r\nprint_buttons(dialog, height, width, 0);\r\nwnoutrefresh(dialog);\r\nwnoutrefresh(list);\r\ndoupdate();\r\nwhile (key != KEY_ESC) {\r\nkey = wgetch(dialog);\r\nfor (i = 0; i < max_choice; i++) {\r\nitem_set(i + scroll);\r\nif (toupper(key) == toupper(item_str()[0]))\r\nbreak;\r\n}\r\nif (i < max_choice || key == KEY_UP || key == KEY_DOWN ||\r\nkey == '+' || key == '-') {\r\nif (key == KEY_UP || key == '-') {\r\nif (!choice) {\r\nif (!scroll)\r\ncontinue;\r\nif (list_height > 1) {\r\nitem_set(scroll);\r\nprint_item(list, 0, FALSE);\r\nscrollok(list, TRUE);\r\nwscrl(list, -1);\r\nscrollok(list, FALSE);\r\n}\r\nscroll--;\r\nitem_set(scroll);\r\nprint_item(list, 0, TRUE);\r\nprint_arrows(dialog, choice, item_count(),\r\nscroll, box_y, box_x + check_x + 5, list_height);\r\nwnoutrefresh(dialog);\r\nwrefresh(list);\r\ncontinue;\r\n} else\r\ni = choice - 1;\r\n} else if (key == KEY_DOWN || key == '+') {\r\nif (choice == max_choice - 1) {\r\nif (scroll + choice >= item_count() - 1)\r\ncontinue;\r\nif (list_height > 1) {\r\nitem_set(scroll + max_choice - 1);\r\nprint_item(list,\r\nmax_choice - 1,\r\nFALSE);\r\nscrollok(list, TRUE);\r\nwscrl(list, 1);\r\nscrollok(list, FALSE);\r\n}\r\nscroll++;\r\nitem_set(scroll + max_choice - 1);\r\nprint_item(list, max_choice - 1, TRUE);\r\nprint_arrows(dialog, choice, item_count(),\r\nscroll, box_y, box_x + check_x + 5, list_height);\r\nwnoutrefresh(dialog);\r\nwrefresh(list);\r\ncontinue;\r\n} else\r\ni = choice + 1;\r\n}\r\nif (i != choice) {\r\nitem_set(scroll + choice);\r\nprint_item(list, choice, FALSE);\r\nchoice = i;\r\nitem_set(scroll + choice);\r\nprint_item(list, choice, TRUE);\r\nwnoutrefresh(dialog);\r\nwrefresh(list);\r\n}\r\ncontinue;\r\n}\r\nswitch (key) {\r\ncase 'H':\r\ncase 'h':\r\ncase '?':\r\nbutton = 1;\r\ncase 'S':\r\ncase 's':\r\ncase ' ':\r\ncase '\n':\r\nitem_foreach()\r\nitem_set_selected(0);\r\nitem_set(scroll + choice);\r\nitem_set_selected(1);\r\ndelwin(list);\r\ndelwin(dialog);\r\nreturn button;\r\ncase TAB:\r\ncase KEY_LEFT:\r\ncase KEY_RIGHT:\r\nbutton = ((key == KEY_LEFT ? --button : ++button) < 0)\r\n? 1 : (button > 1 ? 0 : button);\r\nprint_buttons(dialog, height, width, button);\r\nwrefresh(dialog);\r\nbreak;\r\ncase 'X':\r\ncase 'x':\r\nkey = KEY_ESC;\r\nbreak;\r\ncase KEY_ESC:\r\nkey = on_key_esc(dialog);\r\nbreak;\r\ncase KEY_RESIZE:\r\ndelwin(list);\r\ndelwin(dialog);\r\non_key_resize();\r\ngoto do_resize;\r\n}\r\ndoupdate();\r\n}\r\ndelwin(list);\r\ndelwin(dialog);\r\nreturn key;\r\n}

static int mx_init_card(void)\r\n{\r\nstruct sc_reg_access sc_access[] = {\r\n{0x200, 0x80, 0x00},\r\n{0x201, 0xC0, 0x00},\r\n{0x202, 0x00, 0x00},\r\n{0x203, 0x00, 0x00},\r\n{0x204, 0x02, 0x00},\r\n{0x205, 0x10, 0x00},\r\n{0x206, 0x60, 0x00},\r\n{0x207, 0x00, 0x00},\r\n{0x208, 0x90, 0x00},\r\n{0x209, 0x51, 0x00},\r\n{0x20a, 0x00, 0x00},\r\n{0x20b, 0x10, 0x00},\r\n{0x20c, 0x00, 0x00},\r\n{0x20d, 0x00, 0x00},\r\n{0x20e, 0x21, 0x00},\r\n{0x20f, 0x00, 0x00},\r\n{0x210, 0x84, 0x00},\r\n{0x211, 0xB3, 0x00},\r\n{0x212, 0x00, 0x00},\r\n{0x213, 0x00, 0x00},\r\n{0x214, 0x41, 0x00},\r\n{0x215, 0x00, 0x00},\r\n{0x216, 0x00, 0x00},\r\n{0x217, 0x00, 0x00},\r\n{0x218, 0x03, 0x00},\r\n{0x219, 0x03, 0x00},\r\n{0x21a, 0x00, 0x00},\r\n{0x21b, 0x00, 0x00},\r\n{0x21c, 0x00, 0x00},\r\n{0x21d, 0x00, 0x00},\r\n{0x21e, 0x00, 0x00},\r\n{0x21f, 0x00, 0x00},\r\n{0x220, 0x20, 0x00},\r\n{0x221, 0x20, 0x00},\r\n{0x222, 0x51, 0x00},\r\n{0x223, 0x20, 0x00},\r\n{0x224, 0x04, 0x00},\r\n{0x225, 0x80, 0x00},\r\n{0x226, 0x0F, 0x00},\r\n{0x227, 0x08, 0x00},\r\n{0xf9, 0x40, 0x00},\r\n{0xfa, 0x1f, 0x00},\r\n{0xfb, 0x1f, 0x00},\r\n{0xfc, 0x1f, 0x00},\r\n{0xfd, 0x1f, 0x00},\r\n{0xfe, 0x00, 0x00},\r\n{0xff, 0x0c, 0x00},\r\n};\r\nsnd_pmic_ops_mx.card_status = SND_CARD_INIT_DONE;\r\nsnd_pmic_ops_mx.num_channel = 2;\r\nsnd_pmic_ops_mx.master_mute = UNMUTE;\r\nsnd_pmic_ops_mx.mute_status = UNMUTE;\r\nreturn sst_sc_reg_access(sc_access, PMIC_WRITE, 47);\r\n}\r\nstatic int mx_enable_audiodac(int value)\r\n{\r\nstruct sc_reg_access sc_access[3];\r\nint mute_val = 0;\r\nint mute_val1 = 0;\r\nint retval = 0;\r\nsc_access[0].reg_addr = AS_LEFT_HP_VOL_CTL;\r\nsc_access[1].reg_addr = AS_RIGHT_HP_VOL_CTL;\r\nif (value == UNMUTE) {\r\nmute_val = 0x1F;\r\nmute_val1 = 0x00;\r\n} else {\r\nmute_val = 0x00;\r\nmute_val1 = 0x40;\r\n}\r\nsc_access[0].mask = sc_access[1].mask = MASK0|MASK1|MASK2|MASK3|MASK4;\r\nsc_access[0].value = sc_access[1].value = (u8)mute_val;\r\nretval = sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 2);\r\nif (retval)\r\nreturn retval;\r\npr_debug("mute status = %d\n", snd_pmic_ops_mx.mute_status);\r\nif (snd_pmic_ops_mx.mute_status == MUTE ||\r\nsnd_pmic_ops_mx.master_mute == MUTE)\r\nreturn retval;\r\nsc_access[0].reg_addr = VOL_CTRL_LT;\r\nsc_access[1].reg_addr = VOL_CTRL_RT;\r\nsc_access[0].mask = sc_access[1].mask = MASK6;\r\nsc_access[0].value = sc_access[1].value = mute_val1;\r\nif (snd_pmic_ops_mx.num_channel == 1)\r\nsc_access[1].value = 0x40;\r\nreturn sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 2);\r\n}\r\nstatic int mx_power_up_pb(unsigned int port)\r\n{\r\nint retval = 0;\r\nstruct sc_reg_access sc_access[3];\r\nif (snd_pmic_ops_mx.card_status == SND_CARD_UN_INIT) {\r\nretval = mx_init_card();\r\nif (retval)\r\nreturn retval;\r\n}\r\nretval = mx_enable_audiodac(MUTE);\r\nif (retval)\r\nreturn retval;\r\nmsleep(10);\r\nsc_access[0].reg_addr = AS_CONFIG;\r\nsc_access[0].mask = MASK7;\r\nsc_access[0].value = 0x80;\r\nretval = sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 1);\r\nif (retval)\r\nreturn retval;\r\nsc_access[0].reg_addr = ENABLE_OPDEV_CTRL;\r\nsc_access[0].mask = 0xff;\r\nsc_access[0].value = 0x3C;\r\nretval = sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 1);\r\nif (retval)\r\nreturn retval;\r\nsc_access[0].reg_addr = ENABLE_DEV_AND_USE_XTAL;\r\nsc_access[0].mask = 0x80;\r\nsc_access[0].value = 0x80;\r\nretval = sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 1);\r\nif (retval)\r\nreturn retval;\r\nreturn mx_enable_audiodac(UNMUTE);\r\n}\r\nstatic int mx_power_down_pb(unsigned int device)\r\n{\r\nstruct sc_reg_access sc_access[3];\r\nint retval = 0;\r\nif (snd_pmic_ops_mx.card_status == SND_CARD_UN_INIT) {\r\nretval = mx_init_card();\r\nif (retval)\r\nreturn retval;\r\n}\r\nretval = mx_enable_audiodac(MUTE);\r\nif (retval)\r\nreturn retval;\r\nsc_access[0].reg_addr = ENABLE_OPDEV_CTRL;\r\nsc_access[0].mask = MASK3|MASK2;\r\nsc_access[0].value = 0x00;\r\nretval = sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 1);\r\nif (retval)\r\nreturn retval;\r\nreturn mx_enable_audiodac(UNMUTE);\r\n}\r\nstatic int mx_power_up_cp(unsigned int port)\r\n{\r\nint retval = 0;\r\nstruct sc_reg_access sc_access[] = {\r\n{ENABLE_DEV_AND_USE_XTAL, 0x80, MASK7},\r\n{ENABLE_OPDEV_CTRL, 0x3, 0x3},\r\n};\r\nif (snd_pmic_ops_mx.card_status == SND_CARD_UN_INIT) {\r\nretval = mx_init_card();\r\nif (retval)\r\nreturn retval;\r\n}\r\nreturn sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 2);\r\n}\r\nstatic int mx_power_down_cp(unsigned int device)\r\n{\r\nstruct sc_reg_access sc_access[] = {\r\n{ENABLE_OPDEV_CTRL, 0x00, MASK1|MASK0},\r\n};\r\nint retval = 0;\r\nif (snd_pmic_ops_mx.card_status == SND_CARD_UN_INIT) {\r\nretval = mx_init_card();\r\nif (retval)\r\nreturn retval;\r\n}\r\nreturn sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 1);\r\n}\r\nstatic int mx_power_down(void)\r\n{\r\nint retval = 0;\r\nstruct sc_reg_access sc_access[3];\r\nif (snd_pmic_ops_mx.card_status == SND_CARD_UN_INIT) {\r\nretval = mx_init_card();\r\nif (retval)\r\nreturn retval;\r\n}\r\nretval = mx_enable_audiodac(MUTE);\r\nif (retval)\r\nreturn retval;\r\nsc_access[0].reg_addr = AS_CONFIG;\r\nsc_access[0].mask = MASK7;\r\nsc_access[0].value = 0x00;\r\nretval = sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 1);\r\nif (retval)\r\nreturn retval;\r\nsc_access[0].reg_addr = ENABLE_DEV_AND_USE_XTAL;\r\nsc_access[0].mask = MASK7;\r\nsc_access[0].value = 0x00;\r\nretval = sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 1);\r\nif (retval)\r\nreturn retval;\r\nsc_access[0].reg_addr = ENABLE_OPDEV_CTRL;\r\nsc_access[0].mask = MASK3|MASK2;\r\nsc_access[0].value = 0x00;\r\nretval = sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 1);\r\nif (retval)\r\nreturn retval;\r\nreturn mx_enable_audiodac(UNMUTE);\r\n}\r\nstatic int mx_set_pcm_voice_params(void)\r\n{\r\nint retval = 0;\r\nstruct sc_reg_access sc_access[] = {\r\n{0x200, 0x80, 0x00},\r\n{0x201, 0xC0, 0x00},\r\n{0x202, 0x00, 0x00},\r\n{0x203, 0x00, 0x00},\r\n{0x204, 0x0e, 0x00},\r\n{0x205, 0x20, 0x00},\r\n{0x206, 0x8f, 0x00},\r\n{0x207, 0x21, 0x00},\r\n{0x208, 0x18, 0x00},\r\n{0x209, 0x32, 0x00},\r\n{0x20a, 0x00, 0x00},\r\n{0x20b, 0x5A, 0x00},\r\n{0x20c, 0xBE, 0x00},\r\n{0x20d, 0x00, 0x00},\r\n{0x20e, 0x40, 0x00},\r\n{0x20f, 0x00, 0x00},\r\n{0x210, 0x84, 0x00},\r\n{0x211, 0x33, 0x00},\r\n{0x212, 0x00, 0x00},\r\n{0x213, 0x00, 0x00},\r\n{0x214, 0x41, 0x00},\r\n{0x215, 0x00, 0x00},\r\n{0x216, 0x00, 0x00},\r\n{0x217, 0x20, 0x00},\r\n{0x218, 0x00, 0x00},\r\n{0x219, 0x00, 0x00},\r\n{0x21a, 0x40, 0x00},\r\n{0x21b, 0x40, 0x00},\r\n{0x21c, 0x09, 0x00},\r\n{0x21d, 0x09, 0x00},\r\n{0x21e, 0x00, 0x00},\r\n{0x21f, 0x00, 0x00},\r\n{0x220, 0x00, 0x00},\r\n{0x221, 0x00, 0x00},\r\n{0x222, 0x50, 0x00},\r\n{0x223, 0x21, 0x00},\r\n{0x224, 0x00, 0x00},\r\n{0x225, 0x80, 0x00},\r\n{0xf9, 0x40, 0x00},\r\n{0xfa, 0x19, 0x00},\r\n{0xfb, 0x19, 0x00},\r\n{0xfc, 0x12, 0x00},\r\n{0xfd, 0x12, 0x00},\r\n{0xfe, 0x00, 0x00},\r\n};\r\nif (snd_pmic_ops_mx.card_status == SND_CARD_UN_INIT) {\r\nretval = mx_init_card();\r\nif (retval)\r\nreturn retval;\r\n}\r\npr_debug("SST DBG:mx_set_pcm_voice_params called\n");\r\nreturn sst_sc_reg_access(sc_access, PMIC_WRITE, 44);\r\n}\r\nstatic int mx_set_pcm_audio_params(int sfreq, int word_size, int num_channel)\r\n{\r\nint retval = 0;\r\nint config1 = 0, config2 = 0, filter = 0xB3;\r\nstruct sc_reg_access sc_access[5];\r\nif (snd_pmic_ops_mx.card_status == SND_CARD_UN_INIT) {\r\nretval = mx_init_card();\r\nif (retval)\r\nreturn retval;\r\n}\r\nswitch (sfreq) {\r\ncase 8000:\r\nconfig1 = 0x10;\r\nconfig2 = 0x00;\r\nfilter = 0x33;\r\nbreak;\r\ncase 11025:\r\nconfig1 = 0x16;\r\nconfig2 = 0x0d;\r\nbreak;\r\ncase 12000:\r\nconfig1 = 0x18;\r\nconfig2 = 0x00;\r\nbreak;\r\ncase 16000:\r\nconfig1 = 0x20;\r\nconfig2 = 0x00;\r\nbreak;\r\ncase 22050:\r\nconfig1 = 0x2c;\r\nconfig2 = 0x1a;\r\nbreak;\r\ncase 24000:\r\nconfig1 = 0x30;\r\nconfig2 = 0x00;\r\nbreak;\r\ncase 32000:\r\nconfig1 = 0x40;\r\nconfig2 = 0x00;\r\nbreak;\r\ncase 44100:\r\nconfig1 = 0x58;\r\nconfig2 = 0x33;\r\nbreak;\r\ncase 48000:\r\nconfig1 = 0x60;\r\nconfig2 = 0x00;\r\nbreak;\r\n}\r\nsnd_pmic_ops_mx.num_channel = num_channel;\r\nif (snd_pmic_ops_mx.num_channel == 1) {\r\nsc_access[0].reg_addr = VOL_CTRL_RT;\r\nsc_access[0].value = 0x40;\r\nsc_access[0].mask = MASK6;\r\nsc_access[1].reg_addr = 0x224;\r\nsc_access[1].value = 0x05;\r\nsc_access[1].mask = MASK0|MASK1|MASK2;\r\nretval = sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 2);\r\nif (retval)\r\nreturn retval;\r\n} else {\r\nsc_access[0].reg_addr = VOL_CTRL_RT;\r\nsc_access[0].value = 0x00;\r\nsc_access[0].mask = MASK6;\r\nsc_access[1].reg_addr = 0x224;\r\nsc_access[1].value = 0x04;\r\nsc_access[1].mask = MASK0|MASK1|MASK2;\r\nretval = sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 2);\r\nif (retval)\r\nreturn retval;\r\n}\r\nsc_access[0].reg_addr = 0x206;\r\nsc_access[0].value = config1;\r\nsc_access[1].reg_addr = 0x207;\r\nsc_access[1].value = config2;\r\nif (word_size == 16) {\r\nsc_access[2].value = 0x51;\r\nsc_access[3].value = 0x31;\r\n} else if (word_size == 24) {\r\nsc_access[2].value = 0x52;\r\nsc_access[3].value = 0x92;\r\n}\r\nsc_access[2].reg_addr = 0x209;\r\nsc_access[3].reg_addr = 0x20e;\r\nsc_access[4].reg_addr = 0x211;\r\nsc_access[4].value = filter;\r\nreturn sst_sc_reg_access(sc_access, PMIC_WRITE, 5);\r\n}\r\nstatic int mx_set_selected_output_dev(u8 dev_id)\r\n{\r\nstruct sc_reg_access sc_access[2];\r\nint num_reg = 0;\r\nint retval = 0;\r\nif (snd_pmic_ops_mx.card_status == SND_CARD_UN_INIT) {\r\nretval = mx_init_card();\r\nif (retval)\r\nreturn retval;\r\n}\r\npr_debug("mx_set_selected_output_dev dev_id:0x%x\n", dev_id);\r\nsnd_pmic_ops_mx.output_dev_id = dev_id;\r\nswitch (dev_id) {\r\ncase STEREO_HEADPHONE:\r\nsc_access[0].reg_addr = 0xFF;\r\nsc_access[0].value = 0x8C;\r\nsc_access[0].mask =\r\nMASK2|MASK3|MASK5|MASK6|MASK4;\r\nnum_reg = 1;\r\nbreak;\r\ncase MONO_EARPIECE:\r\ncase INTERNAL_SPKR:\r\nsc_access[0].reg_addr = 0xFF;\r\nsc_access[0].value = 0xb0;\r\nsc_access[0].mask = MASK2|MASK3|MASK5|MASK6|MASK4;\r\nnum_reg = 1;\r\nbreak;\r\ncase RECEIVER:\r\npr_debug("RECEIVER Koski selected\n");\r\nsc_access[0].reg_addr = 0xFF;\r\nsc_access[0].value = 0x81;\r\nsc_access[0].mask = 0xff;\r\nnum_reg = 1;\r\nbreak;\r\ndefault:\r\npr_err("Not a valid output dev\n");\r\nreturn 0;\r\n}\r\nreturn sst_sc_reg_access(sc_access, PMIC_WRITE, num_reg);\r\n}\r\nstatic int mx_set_voice_port(int status)\r\n{\r\nint retval = 0;\r\nif (snd_pmic_ops_mx.card_status == SND_CARD_UN_INIT) {\r\nretval = mx_init_card();\r\nif (retval)\r\nreturn retval;\r\n}\r\nif (status == ACTIVATE)\r\nretval = mx_set_pcm_voice_params();\r\nreturn retval;\r\n}\r\nstatic int mx_set_audio_port(int status)\r\n{\r\nreturn 0;\r\n}\r\nstatic int mx_set_selected_input_dev(u8 dev_id)\r\n{\r\nstruct sc_reg_access sc_access[2];\r\nint num_reg = 0;\r\nint retval = 0;\r\nif (snd_pmic_ops_mx.card_status == SND_CARD_UN_INIT) {\r\nretval = mx_init_card();\r\nif (retval)\r\nreturn retval;\r\n}\r\nsnd_pmic_ops_mx.input_dev_id = dev_id;\r\npr_debug("mx_set_selected_input_dev dev_id:0x%x\n", dev_id);\r\nswitch (dev_id) {\r\ncase AMIC:\r\nsc_access[0].reg_addr = 0x223;\r\nsc_access[0].value = 0x00;\r\nsc_access[0].mask = MASK7|MASK6|MASK5|MASK4|MASK0;\r\nsc_access[1].reg_addr = 0x222;\r\nsc_access[1].value = 0x50;\r\nsc_access[1].mask = MASK7|MASK6|MASK5|MASK4;\r\nnum_reg = 2;\r\nbreak;\r\ncase HS_MIC:\r\nsc_access[0].reg_addr = 0x223;\r\nsc_access[0].value = 0x20;\r\nsc_access[0].mask = MASK7|MASK6|MASK5|MASK4|MASK0;\r\nsc_access[1].reg_addr = 0x222;\r\nsc_access[1].value = 0x51;\r\nsc_access[1].mask = MASK7|MASK6|MASK5|MASK4;\r\nnum_reg = 2;\r\nbreak;\r\ncase DMIC:\r\nsc_access[1].reg_addr = 0x222;\r\nsc_access[1].value = 0x00;\r\nsc_access[1].mask = MASK7|MASK6|MASK5|MASK4|MASK0;\r\nsc_access[0].reg_addr = 0x223;\r\nsc_access[0].value = 0x20;\r\nsc_access[0].mask = MASK7|MASK6|MASK5|MASK4|MASK0;\r\nnum_reg = 2;\r\nbreak;\r\n}\r\nreturn sst_sc_reg_access(sc_access, PMIC_WRITE, num_reg);\r\n}\r\nstatic int mx_set_mute(int dev_id, u8 value)\r\n{\r\nstruct sc_reg_access sc_access[5];\r\nint num_reg = 0;\r\nint retval = 0;\r\nif (snd_pmic_ops_mx.card_status == SND_CARD_UN_INIT) {\r\nretval = mx_init_card();\r\nif (retval)\r\nreturn retval;\r\n}\r\npr_debug("set_mute dev_id:0x%x , value:%d\n", dev_id, value);\r\nswitch (dev_id) {\r\ncase PMIC_SND_DMIC_MUTE:\r\ncase PMIC_SND_AMIC_MUTE:\r\ncase PMIC_SND_HP_MIC_MUTE:\r\nsc_access[0].reg_addr = 0x220;\r\nsc_access[1].reg_addr = 0x221;\r\nsc_access[2].reg_addr = 0x223;\r\nif (value == MUTE) {\r\nsc_access[0].value = 0x00;\r\nsc_access[1].value = 0x00;\r\nif (snd_pmic_ops_mx.input_dev_id == DMIC)\r\nsc_access[2].value = 0x00;\r\nelse\r\nsc_access[2].value = 0x20;\r\n} else {\r\nsc_access[0].value = 0x20;\r\nsc_access[1].value = 0x20;\r\nif (snd_pmic_ops_mx.input_dev_id == DMIC)\r\nsc_access[2].value = 0x20;\r\nelse\r\nsc_access[2].value = 0x00;\r\n}\r\nsc_access[0].mask = MASK5|MASK6;\r\nsc_access[1].mask = MASK5|MASK6;\r\nsc_access[2].mask = MASK5|MASK6;\r\nnum_reg = 3;\r\nbreak;\r\ncase PMIC_SND_LEFT_SPEAKER_MUTE:\r\ncase PMIC_SND_LEFT_HP_MUTE:\r\nsc_access[0].reg_addr = VOL_CTRL_LT;\r\nif (value == MUTE)\r\nsc_access[0].value = 0x40;\r\nelse\r\nsc_access[0].value = 0x00;\r\nsc_access[0].mask = MASK6;\r\nnum_reg = 1;\r\nsnd_pmic_ops_mx.mute_status = value;\r\nbreak;\r\ncase PMIC_SND_RIGHT_SPEAKER_MUTE:\r\ncase PMIC_SND_RIGHT_HP_MUTE:\r\nsc_access[0].reg_addr = VOL_CTRL_RT;\r\nif (snd_pmic_ops_mx.num_channel == 1)\r\nvalue = MUTE;\r\nif (value == MUTE)\r\nsc_access[0].value = 0x40;\r\nelse\r\nsc_access[0].value = 0x00;\r\nsc_access[0].mask = MASK6;\r\nnum_reg = 1;\r\nsnd_pmic_ops_mx.mute_status = value;\r\nbreak;\r\ncase PMIC_SND_MUTE_ALL:\r\nsc_access[0].reg_addr = VOL_CTRL_RT;\r\nsc_access[1].reg_addr = VOL_CTRL_LT;\r\nsc_access[2].reg_addr = 0x220;\r\nsc_access[3].reg_addr = 0x221;\r\nsc_access[4].reg_addr = 0x223;\r\nsnd_pmic_ops_mx.master_mute = value;\r\nif (value == MUTE) {\r\nsc_access[0].value = sc_access[1].value = 0x40;\r\nsc_access[2].value = 0x00;\r\nsc_access[3].value = 0x00;\r\nif (snd_pmic_ops_mx.input_dev_id == DMIC)\r\nsc_access[4].value = 0x00;\r\nelse\r\nsc_access[4].value = 0x20;\r\n} else {\r\nsc_access[0].value = sc_access[1].value = 0x00;\r\nsc_access[2].value = sc_access[3].value = 0x20;\r\nsc_access[4].value = 0x20;\r\nif (snd_pmic_ops_mx.input_dev_id == DMIC)\r\nsc_access[4].value = 0x20;\r\nelse\r\nsc_access[4].value = 0x00;\r\n}\r\nif (snd_pmic_ops_mx.num_channel == 1)\r\nsc_access[0].value = 0x40;\r\nsc_access[0].mask = sc_access[1].mask = MASK6;\r\nsc_access[2].mask = MASK5|MASK6;\r\nsc_access[3].mask = MASK5|MASK6|MASK2|MASK4;\r\nsc_access[4].mask = MASK5|MASK6|MASK4;\r\nnum_reg = 5;\r\nbreak;\r\ncase PMIC_SND_RECEIVER_MUTE:\r\nsc_access[0].reg_addr = VOL_CTRL_RT;\r\nif (value == MUTE)\r\nsc_access[0].value = 0x40;\r\nelse\r\nsc_access[0].value = 0x00;\r\nsc_access[0].mask = MASK6;\r\nnum_reg = 1;\r\nbreak;\r\n}\r\nreturn sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, num_reg);\r\n}\r\nstatic int mx_set_vol(int dev_id, int value)\r\n{\r\nstruct sc_reg_access sc_access[2] = {{0},};\r\nint num_reg = 0;\r\nint retval = 0;\r\nif (snd_pmic_ops_mx.card_status == SND_CARD_UN_INIT) {\r\nretval = mx_init_card();\r\nif (retval)\r\nreturn retval;\r\n}\r\npr_debug("set_vol dev_id:0x%x ,value:%d\n", dev_id, value);\r\nswitch (dev_id) {\r\ncase PMIC_SND_RECEIVER_VOL:\r\nreturn 0;\r\nbreak;\r\ncase PMIC_SND_CAPTURE_VOL:\r\nsc_access[0].reg_addr = 0x220;\r\nsc_access[1].reg_addr = 0x221;\r\nsc_access[0].value = sc_access[1].value = -value;\r\nsc_access[0].mask = sc_access[1].mask =\r\n(MASK0|MASK1|MASK2|MASK3|MASK4);\r\nnum_reg = 2;\r\nbreak;\r\ncase PMIC_SND_LEFT_PB_VOL:\r\nsc_access[0].value = -value;\r\nsc_access[0].reg_addr = VOL_CTRL_LT;\r\nsc_access[0].mask = (MASK0|MASK1|MASK2|MASK3|MASK4|MASK5);\r\nnum_reg = 1;\r\nbreak;\r\ncase PMIC_SND_RIGHT_PB_VOL:\r\nsc_access[0].value = -value;\r\nsc_access[0].reg_addr = VOL_CTRL_RT;\r\nsc_access[0].mask = (MASK0|MASK1|MASK2|MASK3|MASK4|MASK5);\r\nif (snd_pmic_ops_mx.num_channel == 1) {\r\nsc_access[0].value = 0x40;\r\nsc_access[0].mask = MASK6;\r\nsc_access[0].reg_addr = VOL_CTRL_RT;\r\n}\r\nnum_reg = 1;\r\nbreak;\r\n}\r\nreturn sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, num_reg);\r\n}\r\nstatic int mx_get_mute(int dev_id, u8 *value)\r\n{\r\nstruct sc_reg_access sc_access[4] = {{0},};\r\nint retval = 0, num_reg = 0, mask = 0;\r\nif (snd_pmic_ops_mx.card_status == SND_CARD_UN_INIT) {\r\nretval = mx_init_card();\r\nif (retval)\r\nreturn retval;\r\n}\r\nswitch (dev_id) {\r\ncase PMIC_SND_DMIC_MUTE:\r\ncase PMIC_SND_AMIC_MUTE:\r\ncase PMIC_SND_HP_MIC_MUTE:\r\nsc_access[0].reg_addr = 0x220;\r\nmask = MASK5|MASK6;\r\nnum_reg = 1;\r\nretval = sst_sc_reg_access(sc_access, PMIC_READ, num_reg);\r\nif (retval)\r\nreturn retval;\r\n*value = sc_access[0].value & mask;\r\nif (*value)\r\n*value = UNMUTE;\r\nelse\r\n*value = MUTE;\r\nreturn retval;\r\ncase PMIC_SND_LEFT_HP_MUTE:\r\ncase PMIC_SND_LEFT_SPEAKER_MUTE:\r\nsc_access[0].reg_addr = VOL_CTRL_LT;\r\nnum_reg = 1;\r\nmask = MASK6;\r\nbreak;\r\ncase PMIC_SND_RIGHT_HP_MUTE:\r\ncase PMIC_SND_RIGHT_SPEAKER_MUTE:\r\nsc_access[0].reg_addr = VOL_CTRL_RT;\r\nnum_reg = 1;\r\nmask = MASK6;\r\nbreak;\r\n}\r\nretval = sst_sc_reg_access(sc_access, PMIC_READ, num_reg);\r\nif (retval)\r\nreturn retval;\r\n*value = sc_access[0].value & mask;\r\nif (*value)\r\n*value = MUTE;\r\nelse\r\n*value = UNMUTE;\r\nreturn retval;\r\n}\r\nstatic int mx_get_vol(int dev_id, int *value)\r\n{\r\nstruct sc_reg_access sc_access = {0,};\r\nint retval = 0, mask = 0, num_reg = 0;\r\nif (snd_pmic_ops_mx.card_status == SND_CARD_UN_INIT) {\r\nretval = mx_init_card();\r\nif (retval)\r\nreturn retval;\r\n}\r\nswitch (dev_id) {\r\ncase PMIC_SND_CAPTURE_VOL:\r\nsc_access.reg_addr = 0x220;\r\nmask = MASK0|MASK1|MASK2|MASK3|MASK4;\r\nnum_reg = 1;\r\nbreak;\r\ncase PMIC_SND_LEFT_PB_VOL:\r\nsc_access.reg_addr = VOL_CTRL_LT;\r\nmask = MASK0|MASK1|MASK2|MASK3|MASK4|MASK5;\r\nnum_reg = 1;\r\nbreak;\r\ncase PMIC_SND_RIGHT_PB_VOL:\r\nsc_access.reg_addr = VOL_CTRL_RT;\r\nmask = MASK0|MASK1|MASK2|MASK3|MASK4|MASK5;\r\nnum_reg = 1;\r\nbreak;\r\n}\r\nretval = sst_sc_reg_access(&sc_access, PMIC_READ, num_reg);\r\nif (retval)\r\nreturn retval;\r\n*value = -(sc_access.value & mask);\r\npr_debug("get volume value extracted %d\n", *value);\r\nreturn retval;\r\n}\r\nstatic u8 mx_get_jack_status(void)\r\n{\r\nstruct sc_reg_access sc_access_read = {0,};\r\nsc_access_read.reg_addr = 0x201;\r\nsst_sc_reg_access(&sc_access_read, PMIC_READ, 1);\r\npr_debug("value returned = 0x%x\n", sc_access_read.value);\r\nreturn sc_access_read.value;\r\n}\r\nstatic void mx_pmic_irq_enable(void *data)\r\n{\r\nstruct snd_intelmad *intelmaddata = data;\r\nintelmaddata->jack_prev_state = 0xc0;\r\nreturn;\r\n}\r\nstatic void mx_pmic_irq_cb(void *cb_data, u8 intsts)\r\n{\r\nu8 jack_cur_status, jack_prev_state = 0;\r\nstruct mad_jack *mjack = NULL;\r\nunsigned int present = 0, jack_event_flag = 0, buttonpressflag = 0;\r\ntime_t timediff;\r\nstruct snd_intelmad *intelmaddata = cb_data;\r\nmjack = &intelmaddata->jack[0];\r\nif (intsts & 0x2) {\r\njack_cur_status = mx_get_jack_status();\r\njack_prev_state = intelmaddata->jack_prev_state;\r\nif ((jack_prev_state == 0xc0) && (jack_cur_status == 0x40)) {\r\npr_debug("MAD headset inserted\n");\r\npresent = 1;\r\njack_event_flag = 1;\r\nmjack->jack_status = 1;\r\nmjack->jack.type = SND_JACK_HEADSET;\r\n}\r\nif ((jack_prev_state == 0xc0) && (jack_cur_status == 0x00)) {\r\npr_debug("MAD headphone inserted\n");\r\npresent = 1;\r\njack_event_flag = 1;\r\nmjack->jack.type = SND_JACK_HEADPHONE;\r\n}\r\nif ((jack_prev_state == 0x40) && (jack_cur_status == 0xc0)) {\r\npr_debug("MAD headset removed\n");\r\npresent = 0;\r\njack_event_flag = 1;\r\nmjack->jack_status = 0;\r\nmjack->jack.type = SND_JACK_HEADSET;\r\n}\r\nif ((jack_prev_state == 0x00) && (jack_cur_status == 0xc0)) {\r\npr_debug("MAD headphone removed\n");\r\npresent = 0;\r\njack_event_flag = 1;\r\nmjack->jack.type = SND_JACK_HEADPHONE;\r\n}\r\nif ((jack_prev_state == 0x40) && (jack_cur_status == 0x00)) {\r\ndo_gettimeofday(&mjack->buttonpressed);\r\npr_debug("MAD button press detected\n");\r\n}\r\nif ((jack_prev_state == 0x00) && (jack_cur_status == 0x40)) {\r\nif (mjack->jack_status) {\r\ndo_gettimeofday(\r\n&mjack->buttonreleased);\r\npr_debug("MAD Button Released detected\n");\r\ntimediff = mjack->buttonreleased.tv_sec -\r\nmjack->buttonpressed.tv_sec;\r\nbuttonpressflag = 1;\r\nif (timediff > 1) {\r\npr_debug("MAD long press dtd\n");\r\npresent = 1;\r\njack_event_flag = 1;\r\nmjack->jack.type =\r\nMID_JACK_HS_LONG_PRESS;\r\n} else {\r\npr_debug("MAD short press dtd\n");\r\npresent = 1;\r\njack_event_flag = 1;\r\nmjack->jack.type =\r\nMID_JACK_HS_SHORT_PRESS;\r\n}\r\n} else {\r\npr_debug("MAD headset inserted\n");\r\npresent = 1;\r\njack_event_flag = 1;\r\nmjack->jack_status = 1;\r\nmjack->jack.type = SND_JACK_HEADSET;\r\n}\r\n}\r\nintelmaddata->jack_prev_state = jack_cur_status;\r\npr_debug("mx_pmic_irq_cb prv_state= 0x%x\n",\r\nintelmaddata->jack_prev_state);\r\n}\r\nif (jack_event_flag)\r\nsst_mad_send_jack_report(&mjack->jack,\r\nbuttonpressflag, present);\r\n}\r\nstatic int mx_jack_enable(void)\r\n{\r\nreturn 0;\r\n}

static void update_vfd(void)\r\n{\r\nint i;\r\noutb(0x02, BRIQ_PANEL_VFD_IOPORT);\r\nfor (i=0; i<20; i++)\r\noutb(vfd[i], BRIQ_PANEL_VFD_IOPORT + 1);\r\noutb(0xc0, BRIQ_PANEL_VFD_IOPORT);\r\nfor (i=20; i<40; i++)\r\noutb(vfd[i], BRIQ_PANEL_VFD_IOPORT + 1);\r\n}\r\nstatic void set_led(char state)\r\n{\r\nif (state == 'R')\r\nled = 0x01;\r\nelse if (state == 'G')\r\nled = 0x02;\r\nelse if (state == 'Y')\r\nled = 0x03;\r\nelse if (state == 'X')\r\nled = 0x00;\r\noutb(led, BRIQ_PANEL_LED_IOPORT);\r\n}\r\nstatic int briq_panel_open(struct inode *ino, struct file *filep)\r\n{\r\ntty_lock();\r\nif (vfd_is_open) {\r\ntty_unlock();\r\nreturn -EBUSY;\r\n}\r\nvfd_is_open = 1;\r\ntty_unlock();\r\nreturn 0;\r\n}\r\nstatic int briq_panel_release(struct inode *ino, struct file *filep)\r\n{\r\nif (!vfd_is_open)\r\nreturn -ENODEV;\r\nvfd_is_open = 0;\r\nreturn 0;\r\n}\r\nstatic ssize_t briq_panel_read(struct file *file, char __user *buf, size_t count,\r\nloff_t *ppos)\r\n{\r\nunsigned short c;\r\nunsigned char cp;\r\nif (!vfd_is_open)\r\nreturn -ENODEV;\r\nc = (inb(BRIQ_PANEL_LED_IOPORT) & 0x000c) | (ledpb & 0x0003);\r\nset_led(' ');\r\nif ((!(ledpb & 0x0004)) && (c & 0x0004)) {\r\ncp = ' ';\r\nledpb = c;\r\nif (copy_to_user(buf, &cp, 1))\r\nreturn -EFAULT;\r\nreturn 1;\r\n}\r\nelse if ((!(ledpb & 0x0008)) && (c & 0x0008)) {\r\ncp = '\r';\r\nledpb = c;\r\nif (copy_to_user(buf, &cp, 1))\r\nreturn -EFAULT;\r\nreturn 1;\r\n} else {\r\nledpb = c;\r\nreturn 0;\r\n}\r\n}\r\nstatic void scroll_vfd( void )\r\n{\r\nint i;\r\nfor (i=0; i<20; i++) {\r\nvfd[i] = vfd[i+20];\r\nvfd[i+20] = ' ';\r\n}\r\nvfd_cursor = 20;\r\n}\r\nstatic ssize_t briq_panel_write(struct file *file, const char __user *buf, size_t len,\r\nloff_t *ppos)\r\n{\r\nsize_t indx = len;\r\nint i, esc = 0;\r\nif (!vfd_is_open)\r\nreturn -EBUSY;\r\nfor (;;) {\r\nchar c;\r\nif (!indx)\r\nbreak;\r\nif (get_user(c, buf))\r\nreturn -EFAULT;\r\nif (esc) {\r\nset_led(c);\r\nesc = 0;\r\n} else if (c == 27) {\r\nesc = 1;\r\n} else if (c == 12) {\r\nfor (i=0; i<40; i++)\r\nvfd[i] = ' ';\r\nvfd_cursor = 0;\r\n} else if (c == 10) {\r\nif (vfd_cursor < 20)\r\nvfd_cursor = 20;\r\nelse if (vfd_cursor < 40)\r\nvfd_cursor = 40;\r\nelse if (vfd_cursor < 60)\r\nvfd_cursor = 60;\r\nif (vfd_cursor > 59)\r\nscroll_vfd();\r\n} else {\r\nif (vfd_cursor > 39)\r\nscroll_vfd();\r\nvfd[vfd_cursor++] = c;\r\n}\r\nindx--;\r\nbuf++;\r\n}\r\nupdate_vfd();\r\nreturn len;\r\n}\r\nstatic int __init briq_panel_init(void)\r\n{\r\nstruct device_node *root = of_find_node_by_path("/");\r\nconst char *machine;\r\nint i;\r\nmachine = of_get_property(root, "model", NULL);\r\nif (!machine || strncmp(machine, "TotalImpact,BRIQ-1", 18) != 0) {\r\nof_node_put(root);\r\nreturn -ENODEV;\r\n}\r\nof_node_put(root);\r\nprintk(KERN_INFO\r\n"briq_panel: v%s Dr. Karsten Jeppesen (kj@totalimpact.com)\n",\r\nBRIQ_PANEL_VER);\r\nif (!request_region(BRIQ_PANEL_VFD_IOPORT, 4, "BRIQ Front Panel"))\r\nreturn -EBUSY;\r\nif (!request_region(BRIQ_PANEL_LED_IOPORT, 2, "BRIQ Front Panel")) {\r\nrelease_region(BRIQ_PANEL_VFD_IOPORT, 4);\r\nreturn -EBUSY;\r\n}\r\nledpb = inb(BRIQ_PANEL_LED_IOPORT) & 0x000c;\r\nif (misc_register(&briq_panel_miscdev) < 0) {\r\nrelease_region(BRIQ_PANEL_VFD_IOPORT, 4);\r\nrelease_region(BRIQ_PANEL_LED_IOPORT, 2);\r\nreturn -EBUSY;\r\n}\r\noutb(0x38, BRIQ_PANEL_VFD_IOPORT);\r\noutb(0x01, BRIQ_PANEL_VFD_IOPORT);\r\noutb(0x0c, BRIQ_PANEL_VFD_IOPORT);\r\noutb(0x06, BRIQ_PANEL_VFD_IOPORT);\r\nfor (i=0; i<40; i++)\r\nvfd[i]=' ';\r\n#ifndef MODULE\r\nvfd[0] = 'L';\r\nvfd[1] = 'o';\r\nvfd[2] = 'a';\r\nvfd[3] = 'd';\r\nvfd[4] = 'i';\r\nvfd[5] = 'n';\r\nvfd[6] = 'g';\r\nvfd[7] = ' ';\r\nvfd[8] = '.';\r\nvfd[9] = '.';\r\nvfd[10] = '.';\r\n#endif\r\nupdate_vfd();\r\nreturn 0;\r\n}\r\nstatic void __exit briq_panel_exit(void)\r\n{\r\nmisc_deregister(&briq_panel_miscdev);\r\nrelease_region(BRIQ_PANEL_VFD_IOPORT, 4);\r\nrelease_region(BRIQ_PANEL_LED_IOPORT, 2);\r\n}

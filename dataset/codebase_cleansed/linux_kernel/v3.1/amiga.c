static __inline__ u32\r\nchecksum_block(__be32 *m, int size)\r\n{\r\nu32 sum = 0;\r\nwhile (size--)\r\nsum += be32_to_cpu(*m++);\r\nreturn sum;\r\n}\r\nint amiga_partition(struct parsed_partitions *state)\r\n{\r\nSector sect;\r\nunsigned char *data;\r\nstruct RigidDiskBlock *rdb;\r\nstruct PartitionBlock *pb;\r\nint start_sect, nr_sects, blk, part, res = 0;\r\nint blksize = 1;\r\nint slot = 1;\r\nchar b[BDEVNAME_SIZE];\r\nfor (blk = 0; ; blk++, put_dev_sector(sect)) {\r\nif (blk == RDB_ALLOCATION_LIMIT)\r\ngoto rdb_done;\r\ndata = read_part_sector(state, blk, &sect);\r\nif (!data) {\r\nif (warn_no_part)\r\nprintk("Dev %s: unable to read RDB block %d\n",\r\nbdevname(state->bdev, b), blk);\r\nres = -1;\r\ngoto rdb_done;\r\n}\r\nif (*(__be32 *)data != cpu_to_be32(IDNAME_RIGIDDISK))\r\ncontinue;\r\nrdb = (struct RigidDiskBlock *)data;\r\nif (checksum_block((__be32 *)data, be32_to_cpu(rdb->rdb_SummedLongs) & 0x7F) == 0)\r\nbreak;\r\n*(__be32 *)(data+0xdc) = 0;\r\nif (checksum_block((__be32 *)data,\r\nbe32_to_cpu(rdb->rdb_SummedLongs) & 0x7F)==0) {\r\nprintk("Warning: Trashed word at 0xd0 in block %d "\r\n"ignored in checksum calculation\n",blk);\r\nbreak;\r\n}\r\nprintk("Dev %s: RDB in block %d has bad checksum\n",\r\nbdevname(state->bdev, b), blk);\r\n}\r\nblksize = be32_to_cpu( rdb->rdb_BlockBytes ) / 512;\r\n{\r\nchar tmp[7 + 10 + 1 + 1];\r\nsnprintf(tmp, sizeof(tmp), " RDSK (%d)", blksize * 512);\r\nstrlcat(state->pp_buf, tmp, PAGE_SIZE);\r\n}\r\nblk = be32_to_cpu(rdb->rdb_PartitionList);\r\nput_dev_sector(sect);\r\nfor (part = 1; blk>0 && part<=16; part++, put_dev_sector(sect)) {\r\nblk *= blksize;\r\ndata = read_part_sector(state, blk, &sect);\r\nif (!data) {\r\nif (warn_no_part)\r\nprintk("Dev %s: unable to read partition block %d\n",\r\nbdevname(state->bdev, b), blk);\r\nres = -1;\r\ngoto rdb_done;\r\n}\r\npb = (struct PartitionBlock *)data;\r\nblk = be32_to_cpu(pb->pb_Next);\r\nif (pb->pb_ID != cpu_to_be32(IDNAME_PARTITION))\r\ncontinue;\r\nif (checksum_block((__be32 *)pb, be32_to_cpu(pb->pb_SummedLongs) & 0x7F) != 0 )\r\ncontinue;\r\nnr_sects = (be32_to_cpu(pb->pb_Environment[10]) + 1 -\r\nbe32_to_cpu(pb->pb_Environment[9])) *\r\nbe32_to_cpu(pb->pb_Environment[3]) *\r\nbe32_to_cpu(pb->pb_Environment[5]) *\r\nblksize;\r\nif (!nr_sects)\r\ncontinue;\r\nstart_sect = be32_to_cpu(pb->pb_Environment[9]) *\r\nbe32_to_cpu(pb->pb_Environment[3]) *\r\nbe32_to_cpu(pb->pb_Environment[5]) *\r\nblksize;\r\nput_partition(state,slot++,start_sect,nr_sects);\r\n{\r\nchar dostype[4];\r\nchar tmp[42];\r\n__be32 *dt = (__be32 *)dostype;\r\n*dt = pb->pb_Environment[16];\r\nif (dostype[3] < ' ')\r\nsnprintf(tmp, sizeof(tmp), " (%c%c%c^%c)",\r\ndostype[0], dostype[1],\r\ndostype[2], dostype[3] + '@' );\r\nelse\r\nsnprintf(tmp, sizeof(tmp), " (%c%c%c%c)",\r\ndostype[0], dostype[1],\r\ndostype[2], dostype[3]);\r\nstrlcat(state->pp_buf, tmp, PAGE_SIZE);\r\nsnprintf(tmp, sizeof(tmp), "(res %d spb %d)",\r\nbe32_to_cpu(pb->pb_Environment[6]),\r\nbe32_to_cpu(pb->pb_Environment[4]));\r\nstrlcat(state->pp_buf, tmp, PAGE_SIZE);\r\n}\r\nres = 1;\r\n}\r\nstrlcat(state->pp_buf, "\n", PAGE_SIZE);\r\nrdb_done:\r\nreturn res;\r\n}

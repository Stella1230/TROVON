static int vbi_workaround(struct saa7146_dev *dev)\r\n{\r\nstruct saa7146_vv *vv = dev->vv_data;\r\nu32 *cpu;\r\ndma_addr_t dma_addr;\r\nint count = 0;\r\nint i;\r\nDECLARE_WAITQUEUE(wait, current);\r\nDEB_VBI(("dev:%p\n",dev));\r\ncpu = pci_alloc_consistent(dev->pci, 4096, &dma_addr);\r\nif (NULL == cpu)\r\nreturn -ENOMEM;\r\nsaa7146_write(dev, BASE_EVEN3, dma_addr);\r\nsaa7146_write(dev, BASE_ODD3, dma_addr+vbi_pixel_to_capture);\r\nsaa7146_write(dev, PROT_ADDR3, dma_addr+4096);\r\nsaa7146_write(dev, PITCH3, vbi_pixel_to_capture);\r\nsaa7146_write(dev, BASE_PAGE3, 0x0);\r\nsaa7146_write(dev, NUM_LINE_BYTE3, (2<<16)|((vbi_pixel_to_capture)<<0));\r\nsaa7146_write(dev, MC2, MASK_04|MASK_20);\r\nWRITE_RPS1(CMD_WR_REG | (1 << 8) | (BRS_CTRL/4));\r\nWRITE_RPS1(0xc000008c);\r\nif ( 0 != (SAA7146_USE_PORT_B_FOR_VBI & dev->ext_vv_data->flags)) {\r\nDEB_D(("...using port b\n"));\r\nWRITE_RPS1(CMD_PAUSE | CMD_OAN | CMD_SIG1 | CMD_E_FID_B);\r\nWRITE_RPS1(CMD_PAUSE | CMD_OAN | CMD_SIG1 | CMD_O_FID_B);\r\n} else {\r\nDEB_D(("...using port a\n"));\r\nWRITE_RPS1(CMD_PAUSE | MASK_10);\r\n}\r\nWRITE_RPS1(CMD_UPLOAD | MASK_08);\r\nWRITE_RPS1(CMD_WR_REG | (1 << 8) | (BRS_CTRL/4));\r\nWRITE_RPS1(((1728-(vbi_pixel_to_capture)) << 7) | MASK_19);\r\nWRITE_RPS1(CMD_PAUSE | MASK_08);\r\nWRITE_RPS1(CMD_UPLOAD | MASK_08);\r\nWRITE_RPS1(CMD_WR_REG | (1 << 8) | (NUM_LINE_BYTE3/4));\r\nWRITE_RPS1((2 << 16) | (vbi_pixel_to_capture));\r\nWRITE_RPS1(CMD_WR_REG | (1 << 8) | (BRS_CTRL/4));\r\nWRITE_RPS1((540 << 7) | (5 << 19));\r\nWRITE_RPS1(CMD_PAUSE | MASK_08);\r\nWRITE_RPS1(CMD_UPLOAD | MASK_08 | MASK_04);\r\nWRITE_RPS1(CMD_WR_REG | (1 << 8) | (MC1/4));\r\nWRITE_RPS1(MASK_20 | MASK_04);\r\nWRITE_RPS1(CMD_INTERRUPT);\r\nWRITE_RPS1(CMD_STOP);\r\nfor(i = 0; i < 2; i++) {\r\nsaa7146_write(dev, MC2, MASK_31|MASK_15);\r\nsaa7146_write(dev, NUM_LINE_BYTE3, (1<<16)|(2<<0));\r\nsaa7146_write(dev, MC2, MASK_04|MASK_20);\r\nSAA7146_IER_ENABLE(dev,MASK_28);\r\nadd_wait_queue(&vv->vbi_wq, &wait);\r\ncurrent->state = TASK_INTERRUPTIBLE;\r\nsaa7146_write(dev, RPS_ADDR1, dev->d_rps1.dma_handle);\r\nsaa7146_write(dev, MC1, (MASK_13 | MASK_29));\r\nschedule();\r\nDEB_VBI(("brs bug workaround %d/1.\n",i));\r\nremove_wait_queue(&vv->vbi_wq, &wait);\r\ncurrent->state = TASK_RUNNING;\r\nSAA7146_IER_DISABLE(dev,MASK_28);\r\nsaa7146_write(dev, MC1, MASK_20);\r\nif(signal_pending(current)) {\r\nDEB_VBI(("aborted (rps:0x%08x).\n",saa7146_read(dev,RPS_ADDR1)));\r\nsaa7146_write(dev, MC1, MASK_29);\r\npci_free_consistent(dev->pci, 4096, cpu, dma_addr);\r\nreturn -EINTR;\r\n}\r\n}\r\npci_free_consistent(dev->pci, 4096, cpu, dma_addr);\r\nreturn 0;\r\n}\r\nstatic void saa7146_set_vbi_capture(struct saa7146_dev *dev, struct saa7146_buf *buf, struct saa7146_buf *next)\r\n{\r\nstruct saa7146_vv *vv = dev->vv_data;\r\nstruct saa7146_video_dma vdma3;\r\nint count = 0;\r\nunsigned long e_wait = vv->current_hps_sync == SAA7146_HPS_SYNC_PORT_A ? CMD_E_FID_A : CMD_E_FID_B;\r\nunsigned long o_wait = vv->current_hps_sync == SAA7146_HPS_SYNC_PORT_A ? CMD_O_FID_A : CMD_O_FID_B;\r\nvdma3.base_even = buf->pt[2].offset;\r\nvdma3.base_odd = buf->pt[2].offset + 16 * vbi_pixel_to_capture;\r\nvdma3.prot_addr = buf->pt[2].offset + 16 * 2 * vbi_pixel_to_capture;\r\nvdma3.pitch = vbi_pixel_to_capture;\r\nvdma3.base_page = buf->pt[2].dma | ME1;\r\nvdma3.num_line_byte = (16 << 16) | vbi_pixel_to_capture;\r\nsaa7146_write_out_dma(dev, 3, &vdma3);\r\ncount = 0;\r\nWRITE_RPS1(CMD_WR_REG | (1 << 8) | (MC2/4));\r\nWRITE_RPS1(MASK_28 | MASK_12);\r\nWRITE_RPS1(CMD_WR_REG_MASK | (MC1/4));\r\nWRITE_RPS1(MASK_04 | MASK_20);\r\nWRITE_RPS1(MASK_04 | MASK_20);\r\nWRITE_RPS1(CMD_PAUSE | o_wait);\r\nWRITE_RPS1(CMD_PAUSE | e_wait);\r\nWRITE_RPS1(CMD_INTERRUPT);\r\nWRITE_RPS1(CMD_STOP);\r\nSAA7146_IER_ENABLE(dev, MASK_28);\r\nsaa7146_write(dev, RPS_ADDR1, dev->d_rps1.dma_handle);\r\nsaa7146_write(dev, MC1, (MASK_13 | MASK_29));\r\n}\r\nstatic int buffer_activate(struct saa7146_dev *dev,\r\nstruct saa7146_buf *buf,\r\nstruct saa7146_buf *next)\r\n{\r\nstruct saa7146_vv *vv = dev->vv_data;\r\nbuf->vb.state = VIDEOBUF_ACTIVE;\r\nDEB_VBI(("dev:%p, buf:%p, next:%p\n",dev,buf,next));\r\nsaa7146_set_vbi_capture(dev,buf,next);\r\nmod_timer(&vv->vbi_q.timeout, jiffies+BUFFER_TIMEOUT);\r\nreturn 0;\r\n}\r\nstatic int buffer_prepare(struct videobuf_queue *q, struct videobuf_buffer *vb,enum v4l2_field field)\r\n{\r\nstruct file *file = q->priv_data;\r\nstruct saa7146_fh *fh = file->private_data;\r\nstruct saa7146_dev *dev = fh->dev;\r\nstruct saa7146_buf *buf = (struct saa7146_buf *)vb;\r\nint err = 0;\r\nint lines, llength, size;\r\nlines = 16 * 2 ;\r\nllength = vbi_pixel_to_capture;\r\nsize = lines * llength;\r\nDEB_VBI(("vb:%p\n",vb));\r\nif (0 != buf->vb.baddr && buf->vb.bsize < size) {\r\nDEB_VBI(("size mismatch.\n"));\r\nreturn -EINVAL;\r\n}\r\nif (buf->vb.size != size)\r\nsaa7146_dma_free(dev,q,buf);\r\nif (VIDEOBUF_NEEDS_INIT == buf->vb.state) {\r\nstruct videobuf_dmabuf *dma=videobuf_to_dma(&buf->vb);\r\nbuf->vb.width = llength;\r\nbuf->vb.height = lines;\r\nbuf->vb.size = size;\r\nbuf->vb.field = field;\r\nsaa7146_pgtable_free(dev->pci, &buf->pt[2]);\r\nsaa7146_pgtable_alloc(dev->pci, &buf->pt[2]);\r\nerr = videobuf_iolock(q,&buf->vb, NULL);\r\nif (err)\r\ngoto oops;\r\nerr = saa7146_pgtable_build_single(dev->pci, &buf->pt[2],\r\ndma->sglist, dma->sglen);\r\nif (0 != err)\r\nreturn err;\r\n}\r\nbuf->vb.state = VIDEOBUF_PREPARED;\r\nbuf->activate = buffer_activate;\r\nreturn 0;\r\noops:\r\nDEB_VBI(("error out.\n"));\r\nsaa7146_dma_free(dev,q,buf);\r\nreturn err;\r\n}\r\nstatic int buffer_setup(struct videobuf_queue *q, unsigned int *count, unsigned int *size)\r\n{\r\nint llength,lines;\r\nlines = 16 * 2 ;\r\nllength = vbi_pixel_to_capture;\r\n*size = lines * llength;\r\n*count = 2;\r\nDEB_VBI(("count:%d, size:%d\n",*count,*size));\r\nreturn 0;\r\n}\r\nstatic void buffer_queue(struct videobuf_queue *q, struct videobuf_buffer *vb)\r\n{\r\nstruct file *file = q->priv_data;\r\nstruct saa7146_fh *fh = file->private_data;\r\nstruct saa7146_dev *dev = fh->dev;\r\nstruct saa7146_vv *vv = dev->vv_data;\r\nstruct saa7146_buf *buf = (struct saa7146_buf *)vb;\r\nDEB_VBI(("vb:%p\n",vb));\r\nsaa7146_buffer_queue(dev,&vv->vbi_q,buf);\r\n}\r\nstatic void buffer_release(struct videobuf_queue *q, struct videobuf_buffer *vb)\r\n{\r\nstruct file *file = q->priv_data;\r\nstruct saa7146_fh *fh = file->private_data;\r\nstruct saa7146_dev *dev = fh->dev;\r\nstruct saa7146_buf *buf = (struct saa7146_buf *)vb;\r\nDEB_VBI(("vb:%p\n",vb));\r\nsaa7146_dma_free(dev,q,buf);\r\n}\r\nstatic void vbi_stop(struct saa7146_fh *fh, struct file *file)\r\n{\r\nstruct saa7146_dev *dev = fh->dev;\r\nstruct saa7146_vv *vv = dev->vv_data;\r\nunsigned long flags;\r\nDEB_VBI(("dev:%p, fh:%p\n",dev, fh));\r\nspin_lock_irqsave(&dev->slock,flags);\r\nsaa7146_write(dev, MC1, MASK_29);\r\nSAA7146_IER_DISABLE(dev, MASK_28);\r\nsaa7146_write(dev, MC1, MASK_20);\r\nif (vv->vbi_q.curr) {\r\nsaa7146_buffer_finish(dev,&vv->vbi_q,VIDEOBUF_DONE);\r\n}\r\nvideobuf_queue_cancel(&fh->vbi_q);\r\nvv->vbi_streaming = NULL;\r\ndel_timer(&vv->vbi_q.timeout);\r\ndel_timer(&fh->vbi_read_timeout);\r\nspin_unlock_irqrestore(&dev->slock, flags);\r\n}\r\nstatic void vbi_read_timeout(unsigned long data)\r\n{\r\nstruct file *file = (struct file*)data;\r\nstruct saa7146_fh *fh = file->private_data;\r\nstruct saa7146_dev *dev = fh->dev;\r\nDEB_VBI(("dev:%p, fh:%p\n",dev, fh));\r\nvbi_stop(fh, file);\r\n}\r\nstatic void vbi_init(struct saa7146_dev *dev, struct saa7146_vv *vv)\r\n{\r\nDEB_VBI(("dev:%p\n",dev));\r\nINIT_LIST_HEAD(&vv->vbi_q.queue);\r\ninit_timer(&vv->vbi_q.timeout);\r\nvv->vbi_q.timeout.function = saa7146_buffer_timeout;\r\nvv->vbi_q.timeout.data = (unsigned long)(&vv->vbi_q);\r\nvv->vbi_q.dev = dev;\r\ninit_waitqueue_head(&vv->vbi_wq);\r\n}\r\nstatic int vbi_open(struct saa7146_dev *dev, struct file *file)\r\n{\r\nstruct saa7146_fh *fh = file->private_data;\r\nu32 arbtr_ctrl = saa7146_read(dev, PCI_BT_V1);\r\nint ret = 0;\r\nDEB_VBI(("dev:%p, fh:%p\n",dev,fh));\r\nret = saa7146_res_get(fh, RESOURCE_DMA3_BRS);\r\nif (0 == ret) {\r\nDEB_S(("cannot get vbi RESOURCE_DMA3_BRS resource\n"));\r\nreturn -EBUSY;\r\n}\r\narbtr_ctrl &= ~0x1f0000;\r\narbtr_ctrl |= 0x1d0000;\r\nsaa7146_write(dev, PCI_BT_V1, arbtr_ctrl);\r\nsaa7146_write(dev, MC2, (MASK_04|MASK_20));\r\nmemset(&fh->vbi_fmt,0,sizeof(fh->vbi_fmt));\r\nfh->vbi_fmt.sampling_rate = 27000000;\r\nfh->vbi_fmt.offset = 248;\r\nfh->vbi_fmt.samples_per_line = vbi_pixel_to_capture;\r\nfh->vbi_fmt.sample_format = V4L2_PIX_FMT_GREY;\r\nfh->vbi_fmt.start[0] = 5;\r\nfh->vbi_fmt.count[0] = 16;\r\nfh->vbi_fmt.start[1] = 312;\r\nfh->vbi_fmt.count[1] = 16;\r\nvideobuf_queue_sg_init(&fh->vbi_q, &vbi_qops,\r\n&dev->pci->dev, &dev->slock,\r\nV4L2_BUF_TYPE_VBI_CAPTURE,\r\nV4L2_FIELD_SEQ_TB,\r\nsizeof(struct saa7146_buf),\r\nfile, &dev->v4l2_lock);\r\ninit_timer(&fh->vbi_read_timeout);\r\nfh->vbi_read_timeout.function = vbi_read_timeout;\r\nfh->vbi_read_timeout.data = (unsigned long)file;\r\nif ( 0 != (SAA7146_USE_PORT_B_FOR_VBI & dev->ext_vv_data->flags)) {\r\nsaa7146_write(dev, BRS_CTRL, MASK_30|MASK_29 | (7 << 19));\r\n} else {\r\nsaa7146_write(dev, BRS_CTRL, 0x00000001);\r\nif (0 != (ret = vbi_workaround(dev))) {\r\nDEB_VBI(("vbi workaround failed!\n"));\r\n}\r\n}\r\nsaa7146_write(dev, MC2, (MASK_08|MASK_24));\r\nreturn 0;\r\n}\r\nstatic void vbi_close(struct saa7146_dev *dev, struct file *file)\r\n{\r\nstruct saa7146_fh *fh = file->private_data;\r\nstruct saa7146_vv *vv = dev->vv_data;\r\nDEB_VBI(("dev:%p, fh:%p\n",dev,fh));\r\nif( fh == vv->vbi_streaming ) {\r\nvbi_stop(fh, file);\r\n}\r\nsaa7146_res_free(fh, RESOURCE_DMA3_BRS);\r\n}\r\nstatic void vbi_irq_done(struct saa7146_dev *dev, unsigned long status)\r\n{\r\nstruct saa7146_vv *vv = dev->vv_data;\r\nspin_lock(&dev->slock);\r\nif (vv->vbi_q.curr) {\r\nDEB_VBI(("dev:%p, curr:%p\n",dev,vv->vbi_q.curr));\r\nvv->vbi_fieldcount+=2;\r\nvv->vbi_q.curr->vb.field_count = vv->vbi_fieldcount;\r\nsaa7146_buffer_finish(dev,&vv->vbi_q,VIDEOBUF_DONE);\r\n} else {\r\nDEB_VBI(("dev:%p\n",dev));\r\n}\r\nsaa7146_buffer_next(dev,&vv->vbi_q,1);\r\nspin_unlock(&dev->slock);\r\n}\r\nstatic ssize_t vbi_read(struct file *file, char __user *data, size_t count, loff_t *ppos)\r\n{\r\nstruct saa7146_fh *fh = file->private_data;\r\nstruct saa7146_dev *dev = fh->dev;\r\nstruct saa7146_vv *vv = dev->vv_data;\r\nssize_t ret = 0;\r\nDEB_VBI(("dev:%p, fh:%p\n",dev,fh));\r\nif( NULL == vv->vbi_streaming ) {\r\nvv->vbi_streaming = fh;\r\n}\r\nif( fh != vv->vbi_streaming ) {\r\nDEB_VBI(("open %p is already using vbi capture.",vv->vbi_streaming));\r\nreturn -EBUSY;\r\n}\r\nmod_timer(&fh->vbi_read_timeout, jiffies+BUFFER_TIMEOUT);\r\nret = videobuf_read_stream(&fh->vbi_q, data, count, ppos, 1,\r\nfile->f_flags & O_NONBLOCK);\r\nreturn ret;\r\n}

static int __init storcenter_device_probe(void)\r\n{\r\nof_platform_bus_probe(NULL, storcenter_of_bus, NULL);\r\nreturn 0;\r\n}\r\nstatic int __init storcenter_add_bridge(struct device_node *dev)\r\n{\r\n#ifdef CONFIG_PCI\r\nint len;\r\nstruct pci_controller *hose;\r\nconst int *bus_range;\r\nprintk("Adding PCI host bridge %s\n", dev->full_name);\r\nhose = pcibios_alloc_controller(dev);\r\nif (hose == NULL)\r\nreturn -ENOMEM;\r\nbus_range = of_get_property(dev, "bus-range", &len);\r\nhose->first_busno = bus_range ? bus_range[0] : 0;\r\nhose->last_busno = bus_range ? bus_range[1] : 0xff;\r\nsetup_indirect_pci(hose, MPC10X_MAPB_CNFG_ADDR, MPC10X_MAPB_CNFG_DATA, 0);\r\npci_process_bridge_OF_ranges(hose, dev, 1);\r\n#endif\r\nreturn 0;\r\n}\r\nstatic void __init storcenter_setup_arch(void)\r\n{\r\nstruct device_node *np;\r\nfor_each_compatible_node(np, "pci", "mpc10x-pci")\r\nstorcenter_add_bridge(np);\r\nprintk(KERN_INFO "IOMEGA StorCenter\n");\r\n}\r\nstatic void __init storcenter_init_IRQ(void)\r\n{\r\nstruct mpic *mpic;\r\nstruct device_node *dnp;\r\nconst void *prop;\r\nint size;\r\nphys_addr_t paddr;\r\ndnp = of_find_node_by_type(NULL, "open-pic");\r\nif (dnp == NULL)\r\nreturn;\r\nprop = of_get_property(dnp, "reg", &size);\r\nif (prop == NULL) {\r\nof_node_put(dnp);\r\nreturn;\r\n}\r\npaddr = (phys_addr_t)of_translate_address(dnp, prop);\r\nmpic = mpic_alloc(dnp, paddr, MPIC_PRIMARY | MPIC_WANTS_RESET,\r\n16, 32, " OpenPIC ");\r\nof_node_put(dnp);\r\nBUG_ON(mpic == NULL);\r\nmpic_assign_isu(mpic, 0, paddr + 0x10200);\r\nmpic_assign_isu(mpic, 1, paddr + 0x11000);\r\nmpic_init(mpic);\r\n}\r\nstatic void storcenter_restart(char *cmd)\r\n{\r\nlocal_irq_disable();\r\n_nmask_and_or_msr(0, MSR_IP);\r\nfor (;;) ;\r\n}\r\nstatic int __init storcenter_probe(void)\r\n{\r\nunsigned long root = of_get_flat_dt_root();\r\nreturn of_flat_dt_is_compatible(root, "iomega,storcenter");\r\n}

void mi1320_init_settings(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nsd->vcur.backlight = 0;\r\nsd->vcur.brightness = 0;\r\nsd->vcur.sharpness = 6;\r\nsd->vcur.contrast = 10;\r\nsd->vcur.gamma = 20;\r\nsd->vcur.hue = 0;\r\nsd->vcur.saturation = 6;\r\nsd->vcur.whitebal = 0;\r\nsd->vcur.mirror = 0;\r\nsd->vcur.flip = 0;\r\nsd->vcur.AC50Hz = 1;\r\nsd->vmax.backlight = 2;\r\nsd->vmax.brightness = 8;\r\nsd->vmax.sharpness = 7;\r\nsd->vmax.contrast = 0;\r\nsd->vmax.gamma = 40;\r\nsd->vmax.hue = 5 + 1;\r\nsd->vmax.saturation = 8;\r\nsd->vmax.whitebal = 2;\r\nsd->vmax.mirror = 1;\r\nsd->vmax.flip = 1;\r\nsd->vmax.AC50Hz = 1;\r\nsd->dev_camera_settings = mi1320_camera_settings;\r\nsd->dev_init_at_startup = mi1320_init_at_startup;\r\nsd->dev_configure_alt = mi1320_configure_alt;\r\nsd->dev_init_pre_alt = mi1320_init_pre_alt;\r\nsd->dev_post_unset_alt = mi1320_post_unset_alt;\r\n}\r\nstatic void common(struct gspca_dev *gspca_dev)\r\n{\r\ns32 n;\r\nctrl_out(gspca_dev, 0x40, 3, 0x0000, 0x0200, 22, dat_common00);\r\nctrl_out(gspca_dev, 0x40, 1, 0x0041, 0x0000, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 3, 0xba00, 0x0200, 32, dat_common01);\r\nn = fetch_validx(gspca_dev, tbl_common, ARRAY_SIZE(tbl_common));\r\nctrl_out(gspca_dev, 0x40, 3, 0xba00, 0x0200, 48, dat_common02);\r\nctrl_out(gspca_dev, 0x40, 3, 0xba00, 0x0200, 48, dat_common03);\r\nctrl_out(gspca_dev, 0x40, 3, 0xba00, 0x0200, 16, dat_common04);\r\nctrl_out(gspca_dev, 0x40, 3, 0xba00, 0x0200, 48, dat_common05);\r\nctrl_out(gspca_dev, 0x40, 3, 0xba00, 0x0200, 44, dat_common06);\r\nkeep_on_fetching_validx(gspca_dev, tbl_common,\r\nARRAY_SIZE(tbl_common), n);\r\nctrl_out(gspca_dev, 0x40, 3, 0xba00, 0x0200, 52, dat_common07);\r\nctrl_out(gspca_dev, 0x40, 3, 0xba00, 0x0200, 48, dat_common08);\r\nctrl_out(gspca_dev, 0x40, 3, 0xba00, 0x0200, 48, dat_common09);\r\nctrl_out(gspca_dev, 0x40, 3, 0xba00, 0x0200, 56, dat_common10);\r\nkeep_on_fetching_validx(gspca_dev, tbl_common,\r\nARRAY_SIZE(tbl_common), n);\r\nctrl_out(gspca_dev, 0x40, 3, 0xba00, 0x0200, 40, dat_common11);\r\nkeep_on_fetching_validx(gspca_dev, tbl_common,\r\nARRAY_SIZE(tbl_common), n);\r\n}\r\nstatic int mi1320_init_at_startup(struct gspca_dev *gspca_dev)\r\n{\r\nfetch_validx(gspca_dev, tbl_init_at_startup,\r\nARRAY_SIZE(tbl_init_at_startup));\r\ncommon(gspca_dev);\r\nreturn 0;\r\n}\r\nstatic int mi1320_init_pre_alt(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nsd->mirrorMask = 0;\r\nsd->vold.backlight = -1;\r\nsd->vold.brightness = -1;\r\nsd->vold.sharpness = -1;\r\nsd->vold.contrast = -1;\r\nsd->vold.saturation = -1;\r\nsd->vold.gamma = -1;\r\nsd->vold.hue = -1;\r\nsd->vold.whitebal = -1;\r\nsd->vold.mirror = -1;\r\nsd->vold.flip = -1;\r\nsd->vold.AC50Hz = -1;\r\ncommon(gspca_dev);\r\nmi1320_sensor_settings(gspca_dev);\r\nmi1320_init_post_alt(gspca_dev);\r\nreturn 0;\r\n}\r\nstatic int mi1320_init_post_alt(struct gspca_dev *gspca_dev)\r\n{\r\nmi1320_camera_settings(gspca_dev);\r\nreturn 0;\r\n}\r\nstatic int mi1320_sensor_settings(struct gspca_dev *gspca_dev)\r\n{\r\ns32 reso = gspca_dev->cam.cam_mode[(s32) gspca_dev->curr_mode].priv;\r\nctrl_out(gspca_dev, 0x40, 5, 0x0001, 0x0000, 0, NULL);\r\nfetch_validx(gspca_dev, tbl_sensor_settings_common,\r\nARRAY_SIZE(tbl_sensor_settings_common));\r\nswitch (reso) {\r\ncase IMAGE_1280:\r\nfetch_validx(gspca_dev, tbl_sensor_settings_1280,\r\nARRAY_SIZE(tbl_sensor_settings_1280));\r\nctrl_out(gspca_dev, 0x40, 3, 0xba00, 0x0200, 64, tbl_1280[0]);\r\nctrl_out(gspca_dev, 0x40, 3, 0xba00, 0x0200, 40, tbl_1280[1]);\r\nctrl_out(gspca_dev, 0x40, 3, 0x0000, 0x0200, 12, tbl_1280[2]);\r\nbreak;\r\ncase IMAGE_800:\r\nfetch_validx(gspca_dev, tbl_sensor_settings_800,\r\nARRAY_SIZE(tbl_sensor_settings_800));\r\nctrl_out(gspca_dev, 0x40, 3, 0xba00, 0x0200, 64, tbl_800[0]);\r\nctrl_out(gspca_dev, 0x40, 3, 0xba00, 0x0200, 40, tbl_800[1]);\r\nctrl_out(gspca_dev, 0x40, 3, 0x0000, 0x0200, 12, tbl_800[2]);\r\nbreak;\r\ndefault:\r\nfetch_validx(gspca_dev, tbl_sensor_settings_640,\r\nARRAY_SIZE(tbl_sensor_settings_640));\r\nctrl_out(gspca_dev, 0x40, 3, 0xba00, 0x0200, 60, tbl_640[0]);\r\nctrl_out(gspca_dev, 0x40, 3, 0xba00, 0x0200, 40, tbl_640[1]);\r\nctrl_out(gspca_dev, 0x40, 3, 0x0000, 0x0200, 12, tbl_640[2]);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mi1320_configure_alt(struct gspca_dev *gspca_dev)\r\n{\r\ns32 reso = gspca_dev->cam.cam_mode[(s32) gspca_dev->curr_mode].priv;\r\nswitch (reso) {\r\ncase IMAGE_640:\r\ngspca_dev->alt = 3 + 1;\r\nbreak;\r\ncase IMAGE_800:\r\ncase IMAGE_1280:\r\ngspca_dev->alt = 1 + 1;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mi1320_camera_settings(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\ns32 backlight = sd->vcur.backlight;\r\ns32 bright = sd->vcur.brightness;\r\ns32 sharp = sd->vcur.sharpness;\r\ns32 cntr = sd->vcur.contrast;\r\ns32 gam = sd->vcur.gamma;\r\ns32 hue = sd->vcur.hue;\r\ns32 sat = sd->vcur.saturation;\r\ns32 wbal = sd->vcur.whitebal;\r\ns32 mirror = (((sd->vcur.mirror > 0) ^ sd->mirrorMask) > 0);\r\ns32 flip = (((sd->vcur.flip > 0) ^ sd->mirrorMask) > 0);\r\ns32 freq = (sd->vcur.AC50Hz > 0);\r\ns32 i;\r\nif (freq != sd->vold.AC50Hz) {\r\nsd->vold.AC50Hz = freq;\r\nfreq = 2 * (freq == 0);\r\nctrl_out(gspca_dev, 0x40, 1, 0xba00, 0x00f0, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0xba02, 0x00f1, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0xba00 , 0x005b, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0xba01 + freq, 0x00f1, 0, NULL);\r\n}\r\nif (wbal != sd->vold.whitebal) {\r\nsd->vold.whitebal = wbal;\r\nif (wbal < 0 || wbal > sd->vmax.whitebal)\r\nwbal = 0;\r\nfor (i = 0; i < 2; i++) {\r\nif (wbal == 0) {\r\nctrl_out(gspca_dev, 0x40, 1,\r\n0x0010, 0x0010, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1,\r\n0x0003, 0x00c1, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1,\r\n0x0042, 0x00c2, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 3,\r\n0xba00, 0x0200, 48, dat_wbalNL);\r\n}\r\nif (wbal == 1) {\r\nctrl_out(gspca_dev, 0x40, 1,\r\n0x0010, 0x0010, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1,\r\n0x0004, 0x00c1, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1,\r\n0x0043, 0x00c2, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 3,\r\n0xba00, 0x0200, 48, dat_wbalLL);\r\n}\r\nif (wbal == 2) {\r\nctrl_out(gspca_dev, 0x40, 1,\r\n0x0010, 0x0010, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1,\r\n0x0003, 0x00c1, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1,\r\n0x0042, 0x00c2, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 3,\r\n0xba00, 0x0200, 44, dat_wbalBL);\r\n}\r\n}\r\n}\r\nif (bright != sd->vold.brightness) {\r\nsd->vold.brightness = bright;\r\nif (bright < 0 || bright > sd->vmax.brightness)\r\nbright = 0;\r\nbright = tbl_bright[bright];\r\nctrl_out(gspca_dev, 0x40, 1, 0xba00, 0x00f0, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0xba01, 0x00f1, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0xba00 + bright, 0x0034, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0xba00 + bright, 0x00f1, 0, NULL);\r\n}\r\nif (sat != sd->vold.saturation) {\r\nsd->vold.saturation = sat;\r\nif (sat < 0 || sat > sd->vmax.saturation)\r\nsat = 0;\r\nsat = tbl_sat[sat];\r\nctrl_out(gspca_dev, 0x40, 1, 0xba00, 0x00f0, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0xba01, 0x00f1, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0xba00 , 0x0025, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0xba00 + sat, 0x00f1, 0, NULL);\r\n}\r\nif (sharp != sd->vold.sharpness) {\r\nsd->vold.sharpness = sharp;\r\nif (sharp < 0 || sharp > sd->vmax.sharpness)\r\nsharp = 0;\r\nctrl_out(gspca_dev, 0x40, 1, 0xba00, 0x00f0, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0xba01, 0x00f1, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0xba00 , 0x0005, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0xba00 + sharp, 0x00f1, 0, NULL);\r\n}\r\nif (hue != sd->vold.hue) {\r\nif (hue < 0 || hue > sd->vmax.hue)\r\nhue = 0;\r\nif (hue == sd->vmax.hue)\r\nsd->swapRB = 1;\r\nelse\r\nsd->swapRB = 0;\r\nctrl_out(gspca_dev, 0x40, 1, 0xba00, 0x00f0, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0xba01, 0x00f1, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0xba70, 0x00e2, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0xba00 + hue * (hue < 6), 0x00f1,\r\n0, NULL);\r\n}\r\nif (backlight != sd->vold.backlight) {\r\nsd->vold.backlight = backlight;\r\nif (backlight < 0 || backlight > sd->vmax.backlight)\r\nbacklight = 0;\r\nbacklight = tbl_backlight[backlight];\r\nfor (i = 0; i < 2; i++) {\r\nctrl_out(gspca_dev, 0x40, 1, 0xba00, 0x00f0, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0xba01, 0x00f1, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0xba74, 0x0006, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0xba80 + backlight, 0x00f1,\r\n0, NULL);\r\n}\r\n}\r\nif (hue != sd->vold.hue) {\r\nsd->vold.hue = hue;\r\nctrl_out(gspca_dev, 0x40, 1, 0xba00, 0x00f0, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0xba01, 0x00f1, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0xba70, 0x00e2, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0xba00 + hue * (hue < 6), 0x00f1,\r\n0, NULL);\r\n}\r\nif (mirror != sd->vold.mirror || flip != sd->vold.flip) {\r\nu8 dat_hvflip2[4] = {0x20, 0x01, 0xf1, 0x00};\r\nsd->vold.mirror = mirror;\r\nsd->vold.flip = flip;\r\ndat_hvflip2[3] = flip + 2 * mirror;\r\nctrl_out(gspca_dev, 0x40, 3, 0xba00, 0x0200, 4, dat_hvflip1);\r\nctrl_out(gspca_dev, 0x40, 3, 0xba00, 0x0200, 4, dat_hvflip2);\r\n}\r\nif (gam != sd->vold.gamma) {\r\nsd->vold.gamma = gam;\r\nif (gam < 0 || gam > sd->vmax.gamma)\r\ngam = 0;\r\ngam = 2 * gam;\r\nctrl_out(gspca_dev, 0x40, 1, 0xba00, 0x00f0, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0xba01, 0x00f1, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0xba04 , 0x003b, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0xba02 + gam, 0x00f1, 0, NULL);\r\n}\r\nif (cntr != sd->vold.contrast) {\r\nsd->vold.contrast = cntr;\r\nif (cntr < 0 || cntr > sd->vmax.contrast)\r\ncntr = 0;\r\nctrl_out(gspca_dev, 0x40, 1, 0xba00, 0x00f0, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0xba01, 0x00f1, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0xba00 + tbl_cntr1[cntr], 0x0035,\r\n0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0xba00 + tbl_cntr2[cntr], 0x00f1,\r\n0, NULL);\r\n}\r\nreturn 0;\r\n}\r\nstatic void mi1320_post_unset_alt(struct gspca_dev *gspca_dev)\r\n{\r\nctrl_out(gspca_dev, 0x40, 5, 0x0000, 0x0000, 0, NULL);\r\nfetch_validx(gspca_dev, tbl_post_unset_alt,\r\nARRAY_SIZE(tbl_post_unset_alt));\r\n}

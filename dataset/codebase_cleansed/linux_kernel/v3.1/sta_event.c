void\r\nmwifiex_reset_connect_state(struct mwifiex_private *priv)\r\n{\r\nstruct mwifiex_adapter *adapter = priv->adapter;\r\nif (!priv->media_connected)\r\nreturn;\r\ndev_dbg(adapter->dev, "info: handles disconnect event\n");\r\npriv->media_connected = false;\r\npriv->scan_block = false;\r\nmwifiex_clean_txrx(priv);\r\npriv->data_rssi_last = 0;\r\npriv->data_nf_last = 0;\r\npriv->data_rssi_avg = 0;\r\npriv->data_nf_avg = 0;\r\npriv->bcn_rssi_last = 0;\r\npriv->bcn_nf_last = 0;\r\npriv->bcn_rssi_avg = 0;\r\npriv->bcn_nf_avg = 0;\r\npriv->rxpd_rate = 0;\r\npriv->rxpd_htinfo = 0;\r\npriv->sec_info.wpa_enabled = false;\r\npriv->sec_info.wpa2_enabled = false;\r\npriv->wpa_ie_len = 0;\r\npriv->sec_info.wapi_enabled = false;\r\npriv->wapi_ie_len = 0;\r\npriv->sec_info.wapi_key_on = false;\r\npriv->sec_info.encryption_mode = 0;\r\npriv->is_data_rate_auto = true;\r\npriv->data_rate = 0;\r\nif (priv->bss_mode == NL80211_IFTYPE_ADHOC) {\r\npriv->adhoc_state = ADHOC_IDLE;\r\npriv->adhoc_is_link_sensed = false;\r\n}\r\ndev_dbg(adapter->dev, "info: previous SSID=%s, SSID len=%u\n",\r\npriv->prev_ssid.ssid, priv->prev_ssid.ssid_len);\r\ndev_dbg(adapter->dev, "info: current SSID=%s, SSID len=%u\n",\r\npriv->curr_bss_params.bss_descriptor.ssid.ssid,\r\npriv->curr_bss_params.bss_descriptor.ssid.ssid_len);\r\nmemcpy(&priv->prev_ssid,\r\n&priv->curr_bss_params.bss_descriptor.ssid,\r\nsizeof(struct mwifiex_802_11_ssid));\r\nmemcpy(priv->prev_bssid,\r\npriv->curr_bss_params.bss_descriptor.mac_address, ETH_ALEN);\r\nmemset(&priv->curr_bss_params, 0x00, sizeof(priv->curr_bss_params));\r\nadapter->tx_lock_flag = false;\r\nadapter->pps_uapsd_mode = false;\r\nif (adapter->num_cmd_timeout && adapter->curr_cmd)\r\nreturn;\r\npriv->media_connected = false;\r\nif (!priv->disconnect) {\r\npriv->disconnect = 1;\r\ndev_dbg(adapter->dev, "info: successfully disconnected from"\r\n" %pM: reason code %d\n", priv->cfg_bssid,\r\nWLAN_REASON_DEAUTH_LEAVING);\r\ncfg80211_disconnected(priv->netdev,\r\nWLAN_REASON_DEAUTH_LEAVING, NULL, 0,\r\nGFP_KERNEL);\r\nqueue_work(priv->workqueue, &priv->cfg_workqueue);\r\n}\r\nif (!netif_queue_stopped(priv->netdev))\r\nnetif_stop_queue(priv->netdev);\r\nif (netif_carrier_ok(priv->netdev))\r\nnetif_carrier_off(priv->netdev);\r\npriv->w_stats.qual.level = 0;\r\npriv->w_stats.qual.noise = 0;\r\n}\r\nint mwifiex_process_sta_event(struct mwifiex_private *priv)\r\n{\r\nstruct mwifiex_adapter *adapter = priv->adapter;\r\nint ret = 0;\r\nu32 eventcause = adapter->event_cause;\r\nswitch (eventcause) {\r\ncase EVENT_DUMMY_HOST_WAKEUP_SIGNAL:\r\ndev_err(adapter->dev, "invalid EVENT: DUMMY_HOST_WAKEUP_SIGNAL,"\r\n" ignoring it\n");\r\nbreak;\r\ncase EVENT_LINK_SENSED:\r\ndev_dbg(adapter->dev, "event: LINK_SENSED\n");\r\nif (!netif_carrier_ok(priv->netdev))\r\nnetif_carrier_on(priv->netdev);\r\nif (netif_queue_stopped(priv->netdev))\r\nnetif_wake_queue(priv->netdev);\r\nbreak;\r\ncase EVENT_DEAUTHENTICATED:\r\ndev_dbg(adapter->dev, "event: Deauthenticated\n");\r\nadapter->dbg.num_event_deauth++;\r\nif (priv->media_connected)\r\nmwifiex_reset_connect_state(priv);\r\nbreak;\r\ncase EVENT_DISASSOCIATED:\r\ndev_dbg(adapter->dev, "event: Disassociated\n");\r\nadapter->dbg.num_event_disassoc++;\r\nif (priv->media_connected)\r\nmwifiex_reset_connect_state(priv);\r\nbreak;\r\ncase EVENT_LINK_LOST:\r\ndev_dbg(adapter->dev, "event: Link lost\n");\r\nadapter->dbg.num_event_link_lost++;\r\nif (priv->media_connected)\r\nmwifiex_reset_connect_state(priv);\r\nbreak;\r\ncase EVENT_PS_SLEEP:\r\ndev_dbg(adapter->dev, "info: EVENT: SLEEP\n");\r\nadapter->ps_state = PS_STATE_PRE_SLEEP;\r\nmwifiex_check_ps_cond(adapter);\r\nbreak;\r\ncase EVENT_PS_AWAKE:\r\ndev_dbg(adapter->dev, "info: EVENT: AWAKE\n");\r\nif (!adapter->pps_uapsd_mode &&\r\npriv->media_connected &&\r\nadapter->sleep_period.period) {\r\nadapter->pps_uapsd_mode = true;\r\ndev_dbg(adapter->dev,\r\n"event: PPS/UAPSD mode activated\n");\r\n}\r\nadapter->tx_lock_flag = false;\r\nif (adapter->pps_uapsd_mode && adapter->gen_null_pkt) {\r\nif (mwifiex_check_last_packet_indication(priv)) {\r\nif (!adapter->data_sent) {\r\nif (!mwifiex_send_null_packet(priv,\r\nMWIFIEX_TxPD_POWER_MGMT_NULL_PACKET\r\n|\r\nMWIFIEX_TxPD_POWER_MGMT_LAST_PACKET))\r\nadapter->ps_state =\r\nPS_STATE_SLEEP;\r\nreturn 0;\r\n}\r\n}\r\n}\r\nadapter->ps_state = PS_STATE_AWAKE;\r\nadapter->pm_wakeup_card_req = false;\r\nadapter->pm_wakeup_fw_try = false;\r\nbreak;\r\ncase EVENT_DEEP_SLEEP_AWAKE:\r\nadapter->if_ops.wakeup_complete(adapter);\r\ndev_dbg(adapter->dev, "event: DS_AWAKE\n");\r\nif (adapter->is_deep_sleep)\r\nadapter->is_deep_sleep = false;\r\nbreak;\r\ncase EVENT_HS_ACT_REQ:\r\ndev_dbg(adapter->dev, "event: HS_ACT_REQ\n");\r\nret = mwifiex_send_cmd_async(priv,\r\nHostCmd_CMD_802_11_HS_CFG_ENH,\r\n0, 0, NULL);\r\nbreak;\r\ncase EVENT_MIC_ERR_UNICAST:\r\ndev_dbg(adapter->dev, "event: UNICAST MIC ERROR\n");\r\nbreak;\r\ncase EVENT_MIC_ERR_MULTICAST:\r\ndev_dbg(adapter->dev, "event: MULTICAST MIC ERROR\n");\r\nbreak;\r\ncase EVENT_MIB_CHANGED:\r\ncase EVENT_INIT_DONE:\r\nbreak;\r\ncase EVENT_ADHOC_BCN_LOST:\r\ndev_dbg(adapter->dev, "event: ADHOC_BCN_LOST\n");\r\npriv->adhoc_is_link_sensed = false;\r\nmwifiex_clean_txrx(priv);\r\nif (!netif_queue_stopped(priv->netdev))\r\nnetif_stop_queue(priv->netdev);\r\nif (netif_carrier_ok(priv->netdev))\r\nnetif_carrier_off(priv->netdev);\r\nbreak;\r\ncase EVENT_BG_SCAN_REPORT:\r\ndev_dbg(adapter->dev, "event: BGS_REPORT\n");\r\nmemset(adapter->scan_table, 0x00,\r\nsizeof(struct mwifiex_bssdescriptor) * IW_MAX_AP);\r\nadapter->num_in_scan_table = 0;\r\nadapter->bcn_buf_end = adapter->bcn_buf;\r\nret = mwifiex_send_cmd_async(priv,\r\nHostCmd_CMD_802_11_BG_SCAN_QUERY,\r\nHostCmd_ACT_GEN_GET, 0, NULL);\r\nbreak;\r\ncase EVENT_PORT_RELEASE:\r\ndev_dbg(adapter->dev, "event: PORT RELEASE\n");\r\nbreak;\r\ncase EVENT_WMM_STATUS_CHANGE:\r\ndev_dbg(adapter->dev, "event: WMM status changed\n");\r\nret = mwifiex_send_cmd_async(priv, HostCmd_CMD_WMM_GET_STATUS,\r\n0, 0, NULL);\r\nbreak;\r\ncase EVENT_RSSI_LOW:\r\ndev_dbg(adapter->dev, "event: Beacon RSSI_LOW\n");\r\nbreak;\r\ncase EVENT_SNR_LOW:\r\ndev_dbg(adapter->dev, "event: Beacon SNR_LOW\n");\r\nbreak;\r\ncase EVENT_MAX_FAIL:\r\ndev_dbg(adapter->dev, "event: MAX_FAIL\n");\r\nbreak;\r\ncase EVENT_RSSI_HIGH:\r\ndev_dbg(adapter->dev, "event: Beacon RSSI_HIGH\n");\r\nbreak;\r\ncase EVENT_SNR_HIGH:\r\ndev_dbg(adapter->dev, "event: Beacon SNR_HIGH\n");\r\nbreak;\r\ncase EVENT_DATA_RSSI_LOW:\r\ndev_dbg(adapter->dev, "event: Data RSSI_LOW\n");\r\nbreak;\r\ncase EVENT_DATA_SNR_LOW:\r\ndev_dbg(adapter->dev, "event: Data SNR_LOW\n");\r\nbreak;\r\ncase EVENT_DATA_RSSI_HIGH:\r\ndev_dbg(adapter->dev, "event: Data RSSI_HIGH\n");\r\nbreak;\r\ncase EVENT_DATA_SNR_HIGH:\r\ndev_dbg(adapter->dev, "event: Data SNR_HIGH\n");\r\nbreak;\r\ncase EVENT_LINK_QUALITY:\r\ndev_dbg(adapter->dev, "event: Link Quality\n");\r\nbreak;\r\ncase EVENT_PRE_BEACON_LOST:\r\ndev_dbg(adapter->dev, "event: Pre-Beacon Lost\n");\r\nbreak;\r\ncase EVENT_IBSS_COALESCED:\r\ndev_dbg(adapter->dev, "event: IBSS_COALESCED\n");\r\nret = mwifiex_send_cmd_async(priv,\r\nHostCmd_CMD_802_11_IBSS_COALESCING_STATUS,\r\nHostCmd_ACT_GEN_GET, 0, NULL);\r\nbreak;\r\ncase EVENT_ADDBA:\r\ndev_dbg(adapter->dev, "event: ADDBA Request\n");\r\nmwifiex_send_cmd_async(priv, HostCmd_CMD_11N_ADDBA_RSP,\r\nHostCmd_ACT_GEN_SET, 0,\r\nadapter->event_body);\r\nbreak;\r\ncase EVENT_DELBA:\r\ndev_dbg(adapter->dev, "event: DELBA Request\n");\r\nmwifiex_11n_delete_ba_stream(priv, adapter->event_body);\r\nbreak;\r\ncase EVENT_BA_STREAM_TIEMOUT:\r\ndev_dbg(adapter->dev, "event: BA Stream timeout\n");\r\nmwifiex_11n_ba_stream_timeout(priv,\r\n(struct host_cmd_ds_11n_batimeout\r\n*)\r\nadapter->event_body);\r\nbreak;\r\ncase EVENT_AMSDU_AGGR_CTRL:\r\ndev_dbg(adapter->dev, "event: AMSDU_AGGR_CTRL %d\n",\r\n*(u16 *) adapter->event_body);\r\nadapter->tx_buf_size =\r\nmin(adapter->curr_tx_buf_size,\r\nle16_to_cpu(*(__le16 *) adapter->event_body));\r\ndev_dbg(adapter->dev, "event: tx_buf_size %d\n",\r\nadapter->tx_buf_size);\r\nbreak;\r\ncase EVENT_WEP_ICV_ERR:\r\ndev_dbg(adapter->dev, "event: WEP ICV error\n");\r\nbreak;\r\ncase EVENT_BW_CHANGE:\r\ndev_dbg(adapter->dev, "event: BW Change\n");\r\nbreak;\r\ncase EVENT_HOSTWAKE_STAIE:\r\ndev_dbg(adapter->dev, "event: HOSTWAKE_STAIE %d\n", eventcause);\r\nbreak;\r\ndefault:\r\ndev_dbg(adapter->dev, "event: unknown event id: %#x\n",\r\neventcause);\r\nbreak;\r\n}\r\nreturn ret;\r\n}

static void _init_mp_priv_(struct mp_priv *pmp_priv)\r\n{\r\npmp_priv->mode = _LOOPBOOK_MODE_;\r\npmp_priv->curr_ch = 1;\r\npmp_priv->curr_modem = MIXED_PHY;\r\npmp_priv->curr_rateidx = 0;\r\npmp_priv->curr_txpoweridx = 0x14;\r\npmp_priv->antenna_tx = ANTENNA_A;\r\npmp_priv->antenna_rx = ANTENNA_AB;\r\npmp_priv->check_mp_pkt = 0;\r\npmp_priv->tx_pktcount = 0;\r\npmp_priv->rx_pktcount = 0;\r\npmp_priv->rx_crcerrpktcount = 0;\r\n}\r\nstatic int init_mp_priv(struct mp_priv *pmp_priv)\r\n{\r\nint i, res;\r\nstruct mp_xmit_frame *pmp_xmitframe;\r\n_init_mp_priv_(pmp_priv);\r\n_init_queue(&pmp_priv->free_mp_xmitqueue);\r\npmp_priv->pallocated_mp_xmitframe_buf = NULL;\r\npmp_priv->pallocated_mp_xmitframe_buf = _malloc(NR_MP_XMITFRAME *\r\nsizeof(struct mp_xmit_frame) + 4);\r\nif (pmp_priv->pallocated_mp_xmitframe_buf == NULL) {\r\nres = _FAIL;\r\ngoto _exit_init_mp_priv;\r\n}\r\npmp_priv->pmp_xmtframe_buf = pmp_priv->pallocated_mp_xmitframe_buf +\r\n4 -\r\n((addr_t)(pmp_priv->pallocated_mp_xmitframe_buf) & 3);\r\npmp_xmitframe = (struct mp_xmit_frame *)pmp_priv->pmp_xmtframe_buf;\r\nfor (i = 0; i < NR_MP_XMITFRAME; i++) {\r\n_init_listhead(&(pmp_xmitframe->list));\r\nlist_insert_tail(&(pmp_xmitframe->list),\r\n&(pmp_priv->free_mp_xmitqueue.queue));\r\npmp_xmitframe->pkt = NULL;\r\npmp_xmitframe->frame_tag = MP_FRAMETAG;\r\npmp_xmitframe->padapter = pmp_priv->papdater;\r\npmp_xmitframe++;\r\n}\r\npmp_priv->free_mp_xmitframe_cnt = NR_MP_XMITFRAME;\r\nres = _SUCCESS;\r\n_exit_init_mp_priv:\r\nreturn res;\r\n}\r\nstatic int free_mp_priv(struct mp_priv *pmp_priv)\r\n{\r\nint res = 0;\r\nkfree(pmp_priv->pallocated_mp_xmitframe_buf);\r\nreturn res;\r\n}\r\nvoid mp871xinit(struct _adapter *padapter)\r\n{\r\nstruct mp_priv *pmppriv = &padapter->mppriv;\r\npmppriv->papdater = padapter;\r\ninit_mp_priv(pmppriv);\r\n}\r\nvoid mp871xdeinit(struct _adapter *padapter)\r\n{\r\nstruct mp_priv *pmppriv = &padapter->mppriv;\r\nfree_mp_priv(pmppriv);\r\n}\r\nstatic u32 fw_iocmd_read(struct _adapter *pAdapter, struct IOCMD_STRUCT iocmd)\r\n{\r\nu32 cmd32 = 0, val32 = 0;\r\nu8 iocmd_class = iocmd.cmdclass;\r\nu16 iocmd_value = iocmd.value;\r\nu8 iocmd_idx = iocmd.index;\r\ncmd32 = (iocmd_class << 24) | (iocmd_value << 8) | iocmd_idx ;\r\nif (r8712_fw_cmd(pAdapter, cmd32))\r\nr8712_fw_cmd_data(pAdapter, &val32, 1);\r\nelse\r\nval32 = 0;\r\nreturn val32;\r\n}\r\nstatic u8 fw_iocmd_write(struct _adapter *pAdapter,\r\nstruct IOCMD_STRUCT iocmd, u32 value)\r\n{\r\nu32 cmd32 = 0;\r\nu8 iocmd_class = iocmd.cmdclass;\r\nu32 iocmd_value = iocmd.value;\r\nu8 iocmd_idx = iocmd.index;\r\nr8712_fw_cmd_data(pAdapter, &value, 0);\r\nmsleep(100);\r\ncmd32 = (iocmd_class << 24) | (iocmd_value << 8) | iocmd_idx ;\r\nreturn r8712_fw_cmd(pAdapter, cmd32);\r\n}\r\nu32 r8712_bb_reg_read(struct _adapter *pAdapter, u16 offset)\r\n{\r\nu8 shift = offset & 0x0003;\r\nu16 bb_addr = offset & 0x0FFC;\r\nu32 bb_val = 0;\r\nstruct IOCMD_STRUCT iocmd;\r\niocmd.cmdclass = IOCMD_CLASS_BB_RF;\r\niocmd.value = bb_addr;\r\niocmd.index = IOCMD_BB_READ_IDX;\r\nbb_val = fw_iocmd_read(pAdapter, iocmd);\r\nif (shift != 0) {\r\nu32 bb_val2 = 0;\r\nbb_val >>= (shift * 8);\r\niocmd.value += 4;\r\nbb_val2 = fw_iocmd_read(pAdapter, iocmd);\r\nbb_val2 <<= ((4 - shift) * 8);\r\nbb_val |= bb_val2;\r\n}\r\nreturn bb_val;\r\n}\r\nu8 r8712_bb_reg_write(struct _adapter *pAdapter, u16 offset, u32 value)\r\n{\r\nu8 shift = offset & 0x0003;\r\nu16 bb_addr = offset & 0x0FFC;\r\nstruct IOCMD_STRUCT iocmd;\r\niocmd.cmdclass = IOCMD_CLASS_BB_RF;\r\niocmd.value = bb_addr;\r\niocmd.index = IOCMD_BB_WRITE_IDX;\r\nif (shift != 0) {\r\nu32 oldValue = 0;\r\nu32 newValue = value;\r\noldValue = r8712_bb_reg_read(pAdapter, iocmd.value);\r\noldValue &= (0xFFFFFFFF >> ((4 - shift) * 8));\r\nvalue = oldValue | (newValue << (shift * 8));\r\nif (fw_iocmd_write(pAdapter, iocmd, value) == false)\r\nreturn false;\r\niocmd.value += 4;\r\noldValue = r8712_bb_reg_read(pAdapter, iocmd.value);\r\noldValue &= (0xFFFFFFFF << (shift * 8));\r\nvalue = oldValue | (newValue >> ((4 - shift) * 8));\r\n}\r\nreturn fw_iocmd_write(pAdapter, iocmd, value);\r\n}\r\nu32 r8712_rf_reg_read(struct _adapter *pAdapter, u8 path, u8 offset)\r\n{\r\nu16 rf_addr = (path << 8) | offset;\r\nu32 rf_data;\r\nstruct IOCMD_STRUCT iocmd;\r\niocmd.cmdclass = IOCMD_CLASS_BB_RF ;\r\niocmd.value = rf_addr ;\r\niocmd.index = IOCMD_RF_READ_IDX;\r\nrf_data = fw_iocmd_read(pAdapter, iocmd);\r\nreturn rf_data;\r\n}\r\nu8 r8712_rf_reg_write(struct _adapter *pAdapter, u8 path, u8 offset, u32 value)\r\n{\r\nu16 rf_addr = (path << 8) | offset;\r\nstruct IOCMD_STRUCT iocmd;\r\niocmd.cmdclass = IOCMD_CLASS_BB_RF;\r\niocmd.value = rf_addr;\r\niocmd.index = IOCMD_RF_WRIT_IDX;\r\nreturn fw_iocmd_write(pAdapter, iocmd, value);\r\n}\r\nstatic u32 bitshift(u32 bitmask)\r\n{\r\nu32 i;\r\nfor (i = 0; i <= 31; i++)\r\nif (((bitmask>>i) & 0x1) == 1)\r\nbreak;\r\nreturn i;\r\n}\r\nstatic u32 get_bb_reg(struct _adapter *pAdapter, u16 offset, u32 bitmask)\r\n{\r\nu32 org_value, bit_shift, new_value;\r\norg_value = r8712_bb_reg_read(pAdapter, offset);\r\nbit_shift = bitshift(bitmask);\r\nnew_value = (org_value & bitmask) >> bit_shift;\r\nreturn new_value;\r\n}\r\nstatic u8 set_bb_reg(struct _adapter *pAdapter,\r\nu16 offset,\r\nu32 bitmask,\r\nu32 value)\r\n{\r\nu32 org_value, bit_shift, new_value;\r\nif (bitmask != bMaskDWord) {\r\norg_value = r8712_bb_reg_read(pAdapter, offset);\r\nbit_shift = bitshift(bitmask);\r\nnew_value = ((org_value & (~bitmask)) | (value << bit_shift));\r\n} else\r\nnew_value = value;\r\nreturn r8712_bb_reg_write(pAdapter, offset, new_value);\r\n}\r\nstatic u32 get_rf_reg(struct _adapter *pAdapter, u8 path, u8 offset,\r\nu32 bitmask)\r\n{\r\nu32 org_value, bit_shift, new_value;\r\norg_value = r8712_rf_reg_read(pAdapter, path, offset);\r\nbit_shift = bitshift(bitmask);\r\nnew_value = (org_value & bitmask) >> bit_shift;\r\nreturn new_value;\r\n}\r\nstatic u8 set_rf_reg(struct _adapter *pAdapter, u8 path, u8 offset, u32 bitmask,\r\nu32 value)\r\n{\r\nu32 org_value, bit_shift, new_value;\r\nif (bitmask != bMaskDWord) {\r\norg_value = r8712_rf_reg_read(pAdapter, path, offset);\r\nbit_shift = bitshift(bitmask);\r\nnew_value = ((org_value & (~bitmask)) | (value << bit_shift));\r\n} else\r\nnew_value = value;\r\nreturn r8712_rf_reg_write(pAdapter, path, offset, new_value);\r\n}\r\nvoid r8712_SetChannel(struct _adapter *pAdapter)\r\n{\r\nstruct cmd_priv *pcmdpriv = &pAdapter->cmdpriv;\r\nstruct cmd_obj *pcmd = NULL;\r\nstruct SetChannel_parm *pparm = NULL;\r\nu16 code = GEN_CMD_CODE(_SetChannel);\r\npcmd = (struct cmd_obj *)_malloc(sizeof(struct cmd_obj));\r\nif (pcmd == NULL)\r\nreturn;\r\npparm = (struct SetChannel_parm *)_malloc(sizeof(struct\r\nSetChannel_parm));\r\nif (pparm == NULL) {\r\nkfree(pcmd);\r\nreturn;\r\n}\r\npparm->curr_ch = pAdapter->mppriv.curr_ch;\r\ninit_h2fwcmd_w_parm_no_rsp(pcmd, pparm, code);\r\nr8712_enqueue_cmd(pcmdpriv, pcmd);\r\n}\r\nstatic void SetCCKTxPower(struct _adapter *pAdapter, u8 TxPower)\r\n{\r\nu16 TxAGC = 0;\r\nTxAGC = TxPower;\r\nset_bb_reg(pAdapter, rTxAGC_CCK_Mcs32, bTxAGCRateCCK, TxAGC);\r\n}\r\nstatic void SetOFDMTxPower(struct _adapter *pAdapter, u8 TxPower)\r\n{\r\nu32 TxAGC = 0;\r\nTxAGC |= ((TxPower<<24)|(TxPower<<16)|(TxPower<<8)|TxPower);\r\nset_bb_reg(pAdapter, rTxAGC_Rate18_06, bTxAGCRate18_06, TxAGC);\r\nset_bb_reg(pAdapter, rTxAGC_Rate54_24, bTxAGCRate54_24, TxAGC);\r\nset_bb_reg(pAdapter, rTxAGC_Mcs03_Mcs00, bTxAGCRateMCS3_MCS0, TxAGC);\r\nset_bb_reg(pAdapter, rTxAGC_Mcs07_Mcs04, bTxAGCRateMCS7_MCS4, TxAGC);\r\nset_bb_reg(pAdapter, rTxAGC_Mcs11_Mcs08, bTxAGCRateMCS11_MCS8, TxAGC);\r\nset_bb_reg(pAdapter, rTxAGC_Mcs15_Mcs12, bTxAGCRateMCS15_MCS12, TxAGC);\r\n}\r\nvoid r8712_SetTxPower(struct _adapter *pAdapter)\r\n{\r\nu8 TxPower = pAdapter->mppriv.curr_txpoweridx;\r\nSetCCKTxPower(pAdapter, TxPower);\r\nSetOFDMTxPower(pAdapter, TxPower);\r\n}\r\nvoid r8712_SetTxAGCOffset(struct _adapter *pAdapter, u32 ulTxAGCOffset)\r\n{\r\nu32 TxAGCOffset_B, TxAGCOffset_C, TxAGCOffset_D, tmpAGC;\r\nTxAGCOffset_B = (ulTxAGCOffset&0x000000ff);\r\nTxAGCOffset_C = ((ulTxAGCOffset&0x0000ff00)>>8);\r\nTxAGCOffset_D = ((ulTxAGCOffset&0x00ff0000)>>16);\r\ntmpAGC = (TxAGCOffset_D<<8 | TxAGCOffset_C<<4 | TxAGCOffset_B);\r\nset_bb_reg(pAdapter, rFPGA0_TxGainStage,\r\n(bXBTxAGC|bXCTxAGC|bXDTxAGC), tmpAGC);\r\n}\r\nvoid r8712_SetDataRate(struct _adapter *pAdapter)\r\n{\r\nu8 path = RF_PATH_A;\r\nu8 offset = RF_SYN_G2;\r\nu32 value;\r\nvalue = (pAdapter->mppriv.curr_rateidx < 4) ? 0x4440 : 0xF200;\r\nr8712_rf_reg_write(pAdapter, path, offset, value);\r\n}\r\nvoid r8712_SwitchBandwidth(struct _adapter *pAdapter)\r\n{\r\nu8 regBwOpMode = 0;\r\nu8 Bandwidth = pAdapter->mppriv.curr_bandwidth;\r\nregBwOpMode = r8712_read8(pAdapter, 0x10250203);\r\nif (Bandwidth == HT_CHANNEL_WIDTH_20)\r\nregBwOpMode |= BIT(2);\r\nelse\r\nregBwOpMode &= ~(BIT(2));\r\nr8712_write8(pAdapter, 0x10250203, regBwOpMode);\r\nswitch (Bandwidth) {\r\ncase HT_CHANNEL_WIDTH_20:\r\nset_bb_reg(pAdapter, rFPGA0_RFMOD, bRFMOD, 0x0);\r\nset_bb_reg(pAdapter, rFPGA1_RFMOD, bRFMOD, 0x0);\r\nset_bb_reg(pAdapter, rFPGA0_AnalogParameter2, bMaskDWord, 0x58);\r\nbreak;\r\ncase HT_CHANNEL_WIDTH_40:\r\nset_bb_reg(pAdapter, rFPGA0_RFMOD, bRFMOD, 0x1);\r\nset_bb_reg(pAdapter, rFPGA1_RFMOD, bRFMOD, 0x1);\r\nset_bb_reg(pAdapter, rCCK0_System, bCCKSideBand,\r\n(HAL_PRIME_CHNL_OFFSET_DONT_CARE>>1));\r\nset_bb_reg(pAdapter, rOFDM1_LSTF, 0xC00,\r\nHAL_PRIME_CHNL_OFFSET_DONT_CARE);\r\nset_bb_reg(pAdapter, rFPGA0_AnalogParameter2, bMaskDWord, 0x18);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nswitch (Bandwidth) {\r\ncase HT_CHANNEL_WIDTH_20:\r\nset_rf_reg(pAdapter, RF_PATH_A, RF_CHNLBW,\r\nBIT(10) | BIT(11), 0x01);\r\nbreak;\r\ncase HT_CHANNEL_WIDTH_40:\r\nset_rf_reg(pAdapter, RF_PATH_A, RF_CHNLBW,\r\nBIT(10) | BIT(11), 0x00);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nvoid r8712_SwitchAntenna(struct _adapter *pAdapter)\r\n{\r\nu32 ofdm_tx_en_val = 0, ofdm_tx_ant_sel_val = 0;\r\nu8 ofdm_rx_ant_sel_val = 0;\r\nu8 cck_ant_select_val = 0;\r\nu32 cck_ant_sel_val = 0;\r\nstruct R_ANTENNA_SELECT_CCK *p_cck_txrx;\r\np_cck_txrx = (struct R_ANTENNA_SELECT_CCK *)&cck_ant_select_val;\r\nswitch (pAdapter->mppriv.antenna_tx) {\r\ncase ANTENNA_A:\r\nset_bb_reg(pAdapter, rFPGA0_XA_HSSIParameter2, 0xe, 2);\r\nset_bb_reg(pAdapter, rFPGA0_XB_HSSIParameter2, 0xe, 1);\r\nofdm_tx_en_val = 0x3;\r\nofdm_tx_ant_sel_val = 0x11111111;\r\np_cck_txrx->r_ccktx_enable = 0x8;\r\nbreak;\r\ncase ANTENNA_B:\r\nset_bb_reg(pAdapter, rFPGA0_XA_HSSIParameter2, 0xe, 1);\r\nset_bb_reg(pAdapter, rFPGA0_XB_HSSIParameter2, 0xe, 2);\r\nofdm_tx_en_val = 0x3;\r\nofdm_tx_ant_sel_val = 0x22222222;\r\np_cck_txrx->r_ccktx_enable = 0x4;\r\nbreak;\r\ncase ANTENNA_AB:\r\nset_bb_reg(pAdapter, rFPGA0_XA_HSSIParameter2, 0xe, 2);\r\nset_bb_reg(pAdapter, rFPGA0_XB_HSSIParameter2, 0xe, 2);\r\nofdm_tx_en_val = 0x3;\r\nofdm_tx_ant_sel_val = 0x3321333;\r\np_cck_txrx->r_ccktx_enable = 0xC;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nset_bb_reg(pAdapter, rFPGA1_TxInfo, 0xffffffff, ofdm_tx_ant_sel_val);\r\nset_bb_reg(pAdapter, rFPGA0_TxInfo, 0x0000000f, ofdm_tx_en_val);\r\nswitch (pAdapter->mppriv.antenna_rx) {\r\ncase ANTENNA_A:\r\nofdm_rx_ant_sel_val = 0x1;\r\np_cck_txrx->r_cckrx_enable = 0x0;\r\np_cck_txrx->r_cckrx_enable_2 = 0x0;\r\nbreak;\r\ncase ANTENNA_B:\r\nofdm_rx_ant_sel_val = 0x2;\r\np_cck_txrx->r_cckrx_enable = 0x1;\r\np_cck_txrx->r_cckrx_enable_2 = 0x1;\r\nbreak;\r\ncase ANTENNA_AB:\r\nofdm_rx_ant_sel_val = 0x3;\r\np_cck_txrx->r_cckrx_enable = 0x0;\r\np_cck_txrx->r_cckrx_enable_2 = 0x1;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nset_bb_reg(pAdapter, rOFDM0_TRxPathEnable, 0x0000000f,\r\nofdm_rx_ant_sel_val);\r\nset_bb_reg(pAdapter, rOFDM1_TRxPathEnable, 0x0000000f,\r\nofdm_rx_ant_sel_val);\r\ncck_ant_sel_val = cck_ant_select_val;\r\nset_bb_reg(pAdapter, rCCK0_AFESetting, bMaskByte3, cck_ant_sel_val);\r\n}\r\nvoid r8712_SetCrystalCap(struct _adapter *pAdapter)\r\n{\r\nset_bb_reg(pAdapter, rFPGA0_AnalogParameter1, bXtalCap,\r\npAdapter->mppriv.curr_crystalcap);\r\n}\r\nstatic void TriggerRFThermalMeter(struct _adapter *pAdapter)\r\n{\r\nset_rf_reg(pAdapter, RF_PATH_A, RF_T_METER, bRFRegOffsetMask, 0x60);\r\n}\r\nstatic u32 ReadRFThermalMeter(struct _adapter *pAdapter)\r\n{\r\nu32 ThermalValue = 0;\r\nThermalValue = get_rf_reg(pAdapter, RF_PATH_A, RF_T_METER, 0x1F);\r\nreturn ThermalValue;\r\n}\r\nvoid r8712_GetThermalMeter(struct _adapter *pAdapter, u32 *value)\r\n{\r\nTriggerRFThermalMeter(pAdapter);\r\nmsleep(1000);\r\n*value = ReadRFThermalMeter(pAdapter);\r\n}\r\nvoid r8712_SetSingleCarrierTx(struct _adapter *pAdapter, u8 bStart)\r\n{\r\nif (bStart) {\r\nif (!get_bb_reg(pAdapter, rFPGA0_RFMOD, bOFDMEn))\r\nset_bb_reg(pAdapter, rFPGA0_RFMOD, bOFDMEn, bEnable);\r\nset_bb_reg(pAdapter, rCCK0_System, bCCKBBMode, bDisable);\r\nset_bb_reg(pAdapter, rCCK0_System, bCCKScramble, bEnable);\r\nset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMContinueTx, bDisable);\r\nset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMSingleCarrier, bEnable);\r\nset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMSingleTone, bDisable);\r\n} else {\r\nset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMContinueTx, bDisable);\r\nset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMSingleCarrier,\r\nbDisable);\r\nset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMSingleTone, bDisable);\r\nmsleep(20);\r\nset_bb_reg(pAdapter, rPMAC_Reset, bBBResetB, 0x0);\r\nset_bb_reg(pAdapter, rPMAC_Reset, bBBResetB, 0x1);\r\n}\r\n}\r\nvoid r8712_SetSingleToneTx(struct _adapter *pAdapter, u8 bStart)\r\n{\r\nu8 rfPath = pAdapter->mppriv.curr_rfpath;\r\nswitch (pAdapter->mppriv.antenna_tx) {\r\ncase ANTENNA_B:\r\nrfPath = RF_PATH_B;\r\nbreak;\r\ncase ANTENNA_A:\r\ndefault:\r\nrfPath = RF_PATH_A;\r\nbreak;\r\n}\r\nif (bStart) {\r\nset_bb_reg(pAdapter, rFPGA0_RFMOD, bCCKEn, bDisable);\r\nset_bb_reg(pAdapter, rFPGA0_RFMOD, bOFDMEn, bDisable);\r\nset_rf_reg(pAdapter, rfPath, RF_TX_G2, bRFRegOffsetMask,\r\n0xd4000);\r\nmsleep(100);\r\nset_rf_reg(pAdapter, rfPath, RF_AC, bRFRegOffsetMask, 0x2001f);\r\nmsleep(100);\r\n} else {\r\nset_bb_reg(pAdapter, rFPGA0_RFMOD, bCCKEn, bEnable);\r\nset_bb_reg(pAdapter, rFPGA0_RFMOD, bOFDMEn, bEnable);\r\nset_rf_reg(pAdapter, rfPath, RF_TX_G2, bRFRegOffsetMask,\r\n0x54000);\r\nmsleep(100);\r\nset_rf_reg(pAdapter, rfPath, RF_AC, bRFRegOffsetMask, 0x30000);\r\nmsleep(100);\r\n}\r\n}\r\nvoid r8712_SetCarrierSuppressionTx(struct _adapter *pAdapter, u8 bStart)\r\n{\r\nif (bStart) {\r\nif (pAdapter->mppriv.curr_rateidx <= MPT_RATE_11M) {\r\nif (!get_bb_reg(pAdapter, rFPGA0_RFMOD, bCCKEn)) {\r\nset_bb_reg(pAdapter, rFPGA0_RFMOD, bCCKEn,\r\nbEnable);\r\n}\r\nset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMContinueTx,\r\nbDisable);\r\nset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMSingleCarrier,\r\nbDisable);\r\nset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMSingleTone,\r\nbDisable);\r\nset_bb_reg(pAdapter, rCCK0_System, bCCKBBMode, 0x2);\r\nset_bb_reg(pAdapter, rCCK0_System, bCCKScramble,\r\nbDisable);\r\nset_bb_reg(pAdapter, rCCK0_System, bCCKTxRate, 0x0);\r\n}\r\n} else {\r\nif (pAdapter->mppriv.curr_rateidx <= MPT_RATE_11M) {\r\nset_bb_reg(pAdapter, rCCK0_System, bCCKBBMode, 0x0);\r\nset_bb_reg(pAdapter, rCCK0_System, bCCKScramble,\r\nbEnable);\r\nset_bb_reg(pAdapter, rPMAC_Reset, bBBResetB, 0x0);\r\nset_bb_reg(pAdapter, rPMAC_Reset, bBBResetB, 0x1);\r\n}\r\n}\r\n}\r\nstatic void SetCCKContinuousTx(struct _adapter *pAdapter, u8 bStart)\r\n{\r\nu32 cckrate;\r\nif (bStart) {\r\nif (!get_bb_reg(pAdapter, rFPGA0_RFMOD, bCCKEn)) {\r\nset_bb_reg(pAdapter, rFPGA0_RFMOD, bCCKEn, bEnable);\r\n}\r\nset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMContinueTx, bDisable);\r\nset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMSingleCarrier, bDisable);\r\nset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMSingleTone, bDisable);\r\ncckrate = pAdapter->mppriv.curr_rateidx;\r\nset_bb_reg(pAdapter, rCCK0_System, bCCKTxRate, cckrate);\r\nset_bb_reg(pAdapter, rCCK0_System, bCCKBBMode, 0x2);\r\nset_bb_reg(pAdapter, rCCK0_System, bCCKScramble, bEnable);\r\n} else {\r\nset_bb_reg(pAdapter, rCCK0_System, bCCKBBMode, 0x0);\r\nset_bb_reg(pAdapter, rCCK0_System, bCCKScramble, bEnable);\r\nset_bb_reg(pAdapter, rPMAC_Reset, bBBResetB, 0x0);\r\nset_bb_reg(pAdapter, rPMAC_Reset, bBBResetB, 0x1);\r\n}\r\n}\r\nstatic void SetOFDMContinuousTx(struct _adapter *pAdapter, u8 bStart)\r\n{\r\nif (bStart) {\r\nif (!get_bb_reg(pAdapter, rFPGA0_RFMOD, bOFDMEn)) {\r\nset_bb_reg(pAdapter, rFPGA0_RFMOD, bOFDMEn, bEnable);\r\n}\r\nset_bb_reg(pAdapter, rCCK0_System, bCCKBBMode, bDisable);\r\nset_bb_reg(pAdapter, rCCK0_System, bCCKScramble, bEnable);\r\nset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMContinueTx, bEnable);\r\nset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMSingleCarrier, bDisable);\r\nset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMSingleTone, bDisable);\r\n} else {\r\nset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMContinueTx, bDisable);\r\nset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMSingleCarrier,\r\nbDisable);\r\nset_bb_reg(pAdapter, rOFDM1_LSTF, bOFDMSingleTone, bDisable);\r\nmsleep(20);\r\nset_bb_reg(pAdapter, rPMAC_Reset, bBBResetB, 0x0);\r\nset_bb_reg(pAdapter, rPMAC_Reset, bBBResetB, 0x1);\r\n}\r\n}\r\nvoid r8712_SetContinuousTx(struct _adapter *pAdapter, u8 bStart)\r\n{\r\nif (bStart) {\r\nr8712_bb_reg_write(pAdapter, rRx_Wait_CCCA,\r\nr8712_bb_reg_read(pAdapter,\r\nrRx_Wait_CCCA) & 0xFE1FFFFF);\r\nmsleep(100);\r\n}\r\nif (pAdapter->mppriv.curr_rateidx <= MPT_RATE_11M)\r\nSetCCKContinuousTx(pAdapter, bStart);\r\nelse if ((pAdapter->mppriv.curr_rateidx >= MPT_RATE_6M) &&\r\n(pAdapter->mppriv.curr_rateidx <= MPT_RATE_MCS15))\r\nSetOFDMContinuousTx(pAdapter, bStart);\r\nif (!bStart)\r\nr8712_bb_reg_write(pAdapter, rRx_Wait_CCCA,\r\nr8712_bb_reg_read(pAdapter,\r\nrRx_Wait_CCCA) | 0x01E00000);\r\n}\r\nvoid r8712_ResetPhyRxPktCount(struct _adapter *pAdapter)\r\n{\r\nu32 i, phyrx_set = 0;\r\nfor (i = OFDM_PPDU_BIT; i <= HT_MPDU_FAIL_BIT; i++) {\r\nphyrx_set = 0;\r\nphyrx_set |= (i << 28);\r\nphyrx_set |= 0x08000000;\r\nr8712_write32(pAdapter, RXERR_RPT, phyrx_set);\r\n}\r\n}\r\nstatic u32 GetPhyRxPktCounts(struct _adapter *pAdapter, u32 selbit)\r\n{\r\nu32 phyrx_set = 0, count = 0;\r\nu32 SelectBit;\r\nSelectBit = selbit << 28;\r\nphyrx_set |= (SelectBit & 0xF0000000);\r\nr8712_write32(pAdapter, RXERR_RPT, phyrx_set);\r\ncount = r8712_read32(pAdapter, RXERR_RPT) & RPTMaxCount;\r\nreturn count;\r\n}\r\nu32 r8712_GetPhyRxPktReceived(struct _adapter *pAdapter)\r\n{\r\nu32 OFDM_cnt = 0, CCK_cnt = 0, HT_cnt = 0;\r\nOFDM_cnt = GetPhyRxPktCounts(pAdapter, OFDM_MPDU_OK_BIT);\r\nCCK_cnt = GetPhyRxPktCounts(pAdapter, CCK_MPDU_OK_BIT);\r\nHT_cnt = GetPhyRxPktCounts(pAdapter, HT_MPDU_OK_BIT);\r\nreturn OFDM_cnt + CCK_cnt + HT_cnt;\r\n}\r\nu32 r8712_GetPhyRxPktCRC32Error(struct _adapter *pAdapter)\r\n{\r\nu32 OFDM_cnt = 0, CCK_cnt = 0, HT_cnt = 0;\r\nOFDM_cnt = GetPhyRxPktCounts(pAdapter, OFDM_MPDU_FAIL_BIT);\r\nCCK_cnt = GetPhyRxPktCounts(pAdapter, CCK_MPDU_FAIL_BIT);\r\nHT_cnt = GetPhyRxPktCounts(pAdapter, HT_MPDU_FAIL_BIT);\r\nreturn OFDM_cnt + CCK_cnt + HT_cnt;\r\n}

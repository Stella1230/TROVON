void HTCControlTxComplete(void *Context, struct htc_packet *pPacket)\r\n{\r\nAR_DEBUG_ASSERT(false);\r\n}\r\nvoid HTCControlRecv(void *Context, struct htc_packet *pPacket)\r\n{\r\nAR_DEBUG_ASSERT(pPacket->Endpoint == ENDPOINT_0);\r\nif (pPacket->Status == A_ECANCELED) {\r\nHTC_FREE_CONTROL_RX((struct htc_target*)Context,pPacket);\r\nreturn;\r\n}\r\nif (pPacket->ActualLength > 0) {\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ERR,\r\n("HTCControlRecv, got message with length:%d \n",\r\npPacket->ActualLength + (u32)HTC_HDR_LENGTH));\r\n#ifdef ATH_DEBUG_MODULE\r\nDebugDumpBytes(pPacket->pBuffer - HTC_HDR_LENGTH,\r\npPacket->ActualLength + HTC_HDR_LENGTH,\r\n"Unexpected ENDPOINT 0 Message");\r\n#endif\r\n}\r\nHTC_RECYCLE_RX_PKT((struct htc_target*)Context,pPacket,&((struct htc_target*)Context)->EndPoint[0]);\r\n}\r\nint HTCSendSetupComplete(struct htc_target *target)\r\n{\r\nstruct htc_packet *pSendPacket = NULL;\r\nint status;\r\ndo {\r\npSendPacket = HTC_ALLOC_CONTROL_TX(target);\r\nif (NULL == pSendPacket) {\r\nstatus = A_NO_MEMORY;\r\nbreak;\r\n}\r\nif (target->HTCTargetVersion >= HTC_VERSION_2P1) {\r\nHTC_SETUP_COMPLETE_EX_MSG *pSetupCompleteEx;\r\nu32 setupFlags = 0;\r\npSetupCompleteEx = (HTC_SETUP_COMPLETE_EX_MSG *)pSendPacket->pBuffer;\r\nA_MEMZERO(pSetupCompleteEx, sizeof(HTC_SETUP_COMPLETE_EX_MSG));\r\npSetupCompleteEx->MessageID = HTC_MSG_SETUP_COMPLETE_EX_ID;\r\nif (target->MaxMsgPerBundle > 0) {\r\nsetupFlags |= HTC_SETUP_COMPLETE_FLAGS_ENABLE_BUNDLE_RECV;\r\npSetupCompleteEx->MaxMsgsPerBundledRecv = target->MaxMsgPerBundle;\r\n}\r\nmemcpy(&pSetupCompleteEx->SetupFlags, &setupFlags, sizeof(pSetupCompleteEx->SetupFlags));\r\nSET_HTC_PACKET_INFO_TX(pSendPacket,\r\nNULL,\r\n(u8 *)pSetupCompleteEx,\r\nsizeof(HTC_SETUP_COMPLETE_EX_MSG),\r\nENDPOINT_0,\r\nHTC_SERVICE_TX_PACKET_TAG);\r\n} else {\r\nHTC_SETUP_COMPLETE_MSG *pSetupComplete;\r\npSetupComplete = (HTC_SETUP_COMPLETE_MSG *)pSendPacket->pBuffer;\r\nA_MEMZERO(pSetupComplete, sizeof(HTC_SETUP_COMPLETE_MSG));\r\npSetupComplete->MessageID = HTC_MSG_SETUP_COMPLETE_ID;\r\nSET_HTC_PACKET_INFO_TX(pSendPacket,\r\nNULL,\r\n(u8 *)pSetupComplete,\r\nsizeof(HTC_SETUP_COMPLETE_MSG),\r\nENDPOINT_0,\r\nHTC_SERVICE_TX_PACKET_TAG);\r\n}\r\npSendPacket->Completion = NULL;\r\nHTC_PREPARE_SEND_PKT(pSendPacket,0,0,0);\r\nstatus = HTCIssueSend(target,pSendPacket);\r\n} while (false);\r\nif (pSendPacket != NULL) {\r\nHTC_FREE_CONTROL_TX(target,pSendPacket);\r\n}\r\nreturn status;\r\n}\r\nint HTCConnectService(HTC_HANDLE HTCHandle,\r\nstruct htc_service_connect_req *pConnectReq,\r\nstruct htc_service_connect_resp *pConnectResp)\r\n{\r\nstruct htc_target *target = GET_HTC_TARGET_FROM_HANDLE(HTCHandle);\r\nint status = 0;\r\nstruct htc_packet *pRecvPacket = NULL;\r\nstruct htc_packet *pSendPacket = NULL;\r\nHTC_CONNECT_SERVICE_RESPONSE_MSG *pResponseMsg;\r\nHTC_CONNECT_SERVICE_MSG *pConnectMsg;\r\nHTC_ENDPOINT_ID assignedEndpoint = ENDPOINT_MAX;\r\nstruct htc_endpoint *pEndpoint;\r\nunsigned int maxMsgSize = 0;\r\nAR_DEBUG_PRINTF(ATH_DEBUG_TRC, ("+HTCConnectService, target:0x%lX SvcID:0x%X \n",\r\n(unsigned long)target, pConnectReq->ServiceID));\r\ndo {\r\nAR_DEBUG_ASSERT(pConnectReq->ServiceID != 0);\r\nif (HTC_CTRL_RSVD_SVC == pConnectReq->ServiceID) {\r\nassignedEndpoint = ENDPOINT_0;\r\nmaxMsgSize = HTC_MAX_CONTROL_MESSAGE_LENGTH;\r\n} else {\r\npSendPacket = HTC_ALLOC_CONTROL_TX(target);\r\nif (NULL == pSendPacket) {\r\nAR_DEBUG_ASSERT(false);\r\nstatus = A_NO_MEMORY;\r\nbreak;\r\n}\r\npConnectMsg = (HTC_CONNECT_SERVICE_MSG *)pSendPacket->pBuffer;\r\nAR_DEBUG_ASSERT(pConnectMsg != NULL);\r\nA_MEMZERO(pConnectMsg,sizeof(HTC_CONNECT_SERVICE_MSG));\r\npConnectMsg->MessageID = HTC_MSG_CONNECT_SERVICE_ID;\r\npConnectMsg->ServiceID = pConnectReq->ServiceID;\r\npConnectMsg->ConnectionFlags = pConnectReq->ConnectionFlags;\r\nif ((pConnectReq->pMetaData != NULL) &&\r\n(pConnectReq->MetaDataLength <= HTC_SERVICE_META_DATA_MAX_LENGTH)) {\r\nmemcpy((u8 *)pConnectMsg + sizeof(HTC_CONNECT_SERVICE_MSG),\r\npConnectReq->pMetaData,\r\npConnectReq->MetaDataLength);\r\npConnectMsg->ServiceMetaLength = pConnectReq->MetaDataLength;\r\n}\r\nSET_HTC_PACKET_INFO_TX(pSendPacket,\r\nNULL,\r\n(u8 *)pConnectMsg,\r\nsizeof(HTC_CONNECT_SERVICE_MSG) + pConnectMsg->ServiceMetaLength,\r\nENDPOINT_0,\r\nHTC_SERVICE_TX_PACKET_TAG);\r\npSendPacket->Completion = NULL;\r\nHTC_PREPARE_SEND_PKT(pSendPacket,0,0,0);\r\nstatus = HTCIssueSend(target,pSendPacket);\r\nif (status) {\r\nbreak;\r\n}\r\nstatus = HTCWaitforControlMessage(target, &pRecvPacket);\r\nif (status) {\r\nbreak;\r\n}\r\npResponseMsg = (HTC_CONNECT_SERVICE_RESPONSE_MSG *)pRecvPacket->pBuffer;\r\nif ((pResponseMsg->MessageID != HTC_MSG_CONNECT_SERVICE_RESPONSE_ID) ||\r\n(pRecvPacket->ActualLength < sizeof(HTC_CONNECT_SERVICE_RESPONSE_MSG))) {\r\nAR_DEBUG_ASSERT(false);\r\nstatus = A_EPROTO;\r\nbreak;\r\n}\r\npConnectResp->ConnectRespCode = pResponseMsg->Status;\r\nif (pResponseMsg->Status != HTC_SERVICE_SUCCESS) {\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ERR,\r\n(" Target failed service 0x%X connect request (status:%d)\n",\r\npResponseMsg->ServiceID, pResponseMsg->Status));\r\nstatus = A_EPROTO;\r\nbreak;\r\n}\r\nassignedEndpoint = (HTC_ENDPOINT_ID) pResponseMsg->EndpointID;\r\nmaxMsgSize = pResponseMsg->MaxMsgSize;\r\nif ((pConnectResp->pMetaData != NULL) &&\r\n(pResponseMsg->ServiceMetaLength > 0) &&\r\n(pResponseMsg->ServiceMetaLength <= HTC_SERVICE_META_DATA_MAX_LENGTH)) {\r\nint copyLength = min((int)pConnectResp->BufferLength, (int)pResponseMsg->ServiceMetaLength);\r\nmemcpy(pConnectResp->pMetaData,\r\n((u8 *)pResponseMsg) + sizeof(HTC_CONNECT_SERVICE_RESPONSE_MSG),\r\ncopyLength);\r\npConnectResp->ActualLength = copyLength;\r\n}\r\n}\r\nstatus = A_EPROTO;\r\nif (assignedEndpoint >= ENDPOINT_MAX) {\r\nAR_DEBUG_ASSERT(false);\r\nbreak;\r\n}\r\nif (0 == maxMsgSize) {\r\nAR_DEBUG_ASSERT(false);\r\nbreak;\r\n}\r\npEndpoint = &target->EndPoint[assignedEndpoint];\r\npEndpoint->Id = assignedEndpoint;\r\nif (pEndpoint->ServiceID != 0) {\r\nAR_DEBUG_ASSERT(false);\r\nbreak;\r\n}\r\npConnectResp->Endpoint = assignedEndpoint;\r\npConnectResp->MaxMsgLength = maxMsgSize;\r\npEndpoint->ServiceID = pConnectReq->ServiceID;\r\npEndpoint->MaxTxQueueDepth = pConnectReq->MaxSendQueueDepth;\r\npEndpoint->MaxMsgLength = maxMsgSize;\r\npEndpoint->EpCallBacks = pConnectReq->EpCallbacks;\r\npEndpoint->CreditDist.ServiceID = pConnectReq->ServiceID;\r\npEndpoint->CreditDist.pHTCReserved = pEndpoint;\r\npEndpoint->CreditDist.Endpoint = assignedEndpoint;\r\npEndpoint->CreditDist.TxCreditSize = target->TargetCreditSize;\r\nif (pConnectReq->MaxSendMsgSize != 0) {\r\nif (pConnectReq->MaxSendMsgSize > maxMsgSize) {\r\nAR_DEBUG_ASSERT(false);\r\nbreak;\r\n}\r\npEndpoint->CreditDist.TxCreditsPerMaxMsg = pConnectReq->MaxSendMsgSize / target->TargetCreditSize;\r\n} else {\r\npEndpoint->CreditDist.TxCreditsPerMaxMsg = maxMsgSize / target->TargetCreditSize;\r\n}\r\nif (0 == pEndpoint->CreditDist.TxCreditsPerMaxMsg) {\r\npEndpoint->CreditDist.TxCreditsPerMaxMsg = 1;\r\n}\r\npEndpoint->LocalConnectionFlags = pConnectReq->LocalConnectionFlags;\r\nstatus = 0;\r\n} while (false);\r\nif (pSendPacket != NULL) {\r\nHTC_FREE_CONTROL_TX(target,pSendPacket);\r\n}\r\nif (pRecvPacket != NULL) {\r\nHTC_FREE_CONTROL_RX(target,pRecvPacket);\r\n}\r\nAR_DEBUG_PRINTF(ATH_DEBUG_TRC, ("-HTCConnectService \n"));\r\nreturn status;\r\n}\r\nstatic void AddToEndpointDistList(struct htc_target *target, struct htc_endpoint_credit_dist *pEpDist)\r\n{\r\nstruct htc_endpoint_credit_dist *pCurEntry,*pLastEntry;\r\nif (NULL == target->EpCreditDistributionListHead) {\r\ntarget->EpCreditDistributionListHead = pEpDist;\r\npEpDist->pNext = NULL;\r\npEpDist->pPrev = NULL;\r\nreturn;\r\n}\r\npCurEntry = target->EpCreditDistributionListHead;\r\nwhile (pCurEntry) {\r\npLastEntry = pCurEntry;\r\npCurEntry = pCurEntry->pNext;\r\n}\r\npLastEntry->pNext = pEpDist;\r\npEpDist->pPrev = pLastEntry;\r\npEpDist->pNext = NULL;\r\n}\r\nstatic void HTCDefaultCreditInit(void *Context,\r\nstruct htc_endpoint_credit_dist *pEPList,\r\nint TotalCredits)\r\n{\r\nstruct htc_endpoint_credit_dist *pCurEpDist;\r\nint totalEps = 0;\r\nint creditsPerEndpoint;\r\npCurEpDist = pEPList;\r\nwhile (pCurEpDist != NULL) {\r\npCurEpDist = pCurEpDist->pNext;\r\ntotalEps++;\r\n}\r\ncreditsPerEndpoint = TotalCredits/totalEps;\r\npCurEpDist = pEPList;\r\nwhile (pCurEpDist != NULL) {\r\nif (creditsPerEndpoint < pCurEpDist->TxCreditsPerMaxMsg) {\r\nAR_DEBUG_ASSERT(false);\r\nbreak;\r\n}\r\npCurEpDist->TxCreditsMin = pCurEpDist->TxCreditsPerMaxMsg;\r\npCurEpDist->TxCreditsNorm = 0xFFFF;\r\npCurEpDist->TxCredits = creditsPerEndpoint;\r\npCurEpDist->TxCreditsAssigned = creditsPerEndpoint;\r\npCurEpDist = pCurEpDist->pNext;\r\n}\r\n}\r\nvoid HTCDefaultCreditDist(void *Context,\r\nstruct htc_endpoint_credit_dist *pEPDistList,\r\nHTC_CREDIT_DIST_REASON Reason)\r\n{\r\nstruct htc_endpoint_credit_dist *pCurEpDist;\r\nif (Reason == HTC_CREDIT_DIST_SEND_COMPLETE) {\r\npCurEpDist = pEPDistList;\r\nwhile (pCurEpDist != NULL) {\r\nif (pCurEpDist->TxCreditsToDist > 0) {\r\npCurEpDist->TxCredits += pCurEpDist->TxCreditsToDist;\r\npCurEpDist->TxCreditsToDist = 0;\r\n}\r\npCurEpDist = pCurEpDist->pNext;\r\n}\r\n}\r\n}\r\nvoid HTCSetCreditDistribution(HTC_HANDLE HTCHandle,\r\nvoid *pCreditDistContext,\r\nHTC_CREDIT_DIST_CALLBACK CreditDistFunc,\r\nHTC_CREDIT_INIT_CALLBACK CreditInitFunc,\r\nHTC_SERVICE_ID ServicePriorityOrder[],\r\nint ListLength)\r\n{\r\nstruct htc_target *target = GET_HTC_TARGET_FROM_HANDLE(HTCHandle);\r\nint i;\r\nint ep;\r\nif (CreditInitFunc != NULL) {\r\ntarget->InitCredits = CreditInitFunc;\r\nAR_DEBUG_ASSERT(CreditDistFunc != NULL);\r\ntarget->DistributeCredits = CreditDistFunc;\r\ntarget->pCredDistContext = pCreditDistContext;\r\n} else {\r\nAR_DEBUG_ASSERT(CreditDistFunc == NULL);\r\ntarget->InitCredits = HTCDefaultCreditInit;\r\ntarget->DistributeCredits = HTCDefaultCreditDist;\r\ntarget->pCredDistContext = target;\r\n}\r\nAddToEndpointDistList(target, &target->EndPoint[ENDPOINT_0].CreditDist);\r\nfor (i = 0; i < ListLength; i++) {\r\nfor (ep = ENDPOINT_1; ep < ENDPOINT_MAX; ep++) {\r\nif (target->EndPoint[ep].ServiceID == ServicePriorityOrder[i]) {\r\nAddToEndpointDistList(target, &target->EndPoint[ep].CreditDist);\r\nbreak;\r\n}\r\n}\r\nAR_DEBUG_ASSERT(ep < ENDPOINT_MAX);\r\n}\r\n}

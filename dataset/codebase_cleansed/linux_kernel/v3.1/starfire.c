void check_if_starfire(void)\r\n{\r\nphandle ssnode = prom_finddevice("/ssp-serial");\r\nif (ssnode != 0 && (s32)ssnode != -1)\r\nthis_is_starfire = 1;\r\n}\r\nint starfire_hard_smp_processor_id(void)\r\n{\r\nreturn upa_readl(0x1fff40000d0UL);\r\n}\r\nvoid starfire_hookup(int upaid)\r\n{\r\nstruct starfire_irqinfo *p;\r\nunsigned long treg_base, hwmid, i;\r\np = kmalloc(sizeof(*p), GFP_KERNEL);\r\nif (!p) {\r\nprom_printf("starfire_hookup: No memory, this is insane.\n");\r\nprom_halt();\r\n}\r\ntreg_base = 0x100fc000000UL;\r\nhwmid = ((upaid & 0x3c) << 1) |\r\n((upaid & 0x40) >> 4) |\r\n(upaid & 0x3);\r\np->hwmid = hwmid;\r\ntreg_base += (hwmid << 33UL);\r\ntreg_base += 0x200UL;\r\nfor (i = 0; i < 32; i++) {\r\np->imap_slots[i] = 0UL;\r\np->tregs[i] = treg_base + (i * 0x10UL);\r\nif (upa_readl(p->tregs[i]) != 0)\r\np->imap_slots[i] = 0xdeadbeaf;\r\n}\r\np->upaid = upaid;\r\np->next = sflist;\r\nsflist = p;\r\n}\r\nunsigned int starfire_translate(unsigned long imap,\r\nunsigned int upaid)\r\n{\r\nstruct starfire_irqinfo *p;\r\nunsigned int bus_hwmid;\r\nunsigned int i;\r\nbus_hwmid = (((unsigned long)imap) >> 33) & 0x7f;\r\nfor (p = sflist; p != NULL; p = p->next)\r\nif (p->hwmid == bus_hwmid)\r\nbreak;\r\nif (p == NULL) {\r\nprom_printf("XFIRE: Cannot find irqinfo for imap %016lx\n",\r\n((unsigned long)imap));\r\nprom_halt();\r\n}\r\nfor (i = 0; i < 32; i++) {\r\nif (p->imap_slots[i] == imap ||\r\np->imap_slots[i] == 0UL)\r\nbreak;\r\n}\r\nif (i == 32) {\r\nprintk("starfire_translate: Are you kidding me?\n");\r\npanic("Lucy in the sky....");\r\n}\r\np->imap_slots[i] = imap;\r\nupaid = (((upaid & 0x3c) << 1) |\r\n((upaid & 0x40) >> 4) |\r\n(upaid & 0x3));\r\nupa_writel(upaid, p->tregs[i]);\r\nreturn i;\r\n}

static int __init acpi_find_ibft(struct acpi_table_header *header)\r\n{\r\nibft_addr = (struct acpi_table_ibft *)header;\r\nreturn 0;\r\n}\r\nstatic int __init find_ibft_in_mem(void)\r\n{\r\nunsigned long pos;\r\nunsigned int len = 0;\r\nvoid *virt;\r\nint i;\r\nfor (pos = IBFT_START; pos < IBFT_END; pos += 16) {\r\nif (pos == VGA_MEM)\r\npos += VGA_SIZE;\r\nvirt = isa_bus_to_virt(pos);\r\nfor (i = 0; i < ARRAY_SIZE(ibft_signs); i++) {\r\nif (memcmp(virt, ibft_signs[i].sign, IBFT_SIGN_LEN) ==\r\n0) {\r\nunsigned long *addr =\r\n(unsigned long *)isa_bus_to_virt(pos + 4);\r\nlen = *addr;\r\nif (pos + len <= (IBFT_END-1)) {\r\nibft_addr = (struct acpi_table_ibft *)virt;\r\ngoto done;\r\n}\r\n}\r\n}\r\n}\r\ndone:\r\nreturn len;\r\n}\r\nunsigned long __init find_ibft_region(unsigned long *sizep)\r\n{\r\n#ifdef CONFIG_ACPI\r\nint i;\r\n#endif\r\nibft_addr = NULL;\r\n#ifdef CONFIG_ACPI\r\nfor (i = 0; i < ARRAY_SIZE(ibft_signs) && !ibft_addr; i++)\r\nacpi_table_parse(ibft_signs[i].sign, acpi_find_ibft);\r\n#endif\r\nif (!ibft_addr && !efi_enabled)\r\nfind_ibft_in_mem();\r\nif (ibft_addr) {\r\n*sizep = PAGE_ALIGN(ibft_addr->header.length);\r\nreturn (u64)isa_virt_to_bus(ibft_addr);\r\n}\r\n*sizep = 0;\r\nreturn 0;\r\n}

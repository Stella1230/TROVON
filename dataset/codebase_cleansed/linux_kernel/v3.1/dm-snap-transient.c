static void transient_dtr(struct dm_exception_store *store)\r\n{\r\nkfree(store->context);\r\n}\r\nstatic int transient_read_metadata(struct dm_exception_store *store,\r\nint (*callback)(void *callback_context,\r\nchunk_t old, chunk_t new),\r\nvoid *callback_context)\r\n{\r\nreturn 0;\r\n}\r\nstatic int transient_prepare_exception(struct dm_exception_store *store,\r\nstruct dm_exception *e)\r\n{\r\nstruct transient_c *tc = store->context;\r\nsector_t size = get_dev_size(dm_snap_cow(store->snap)->bdev);\r\nif (size < (tc->next_free + store->chunk_size))\r\nreturn -1;\r\ne->new_chunk = sector_to_chunk(store, tc->next_free);\r\ntc->next_free += store->chunk_size;\r\nreturn 0;\r\n}\r\nstatic void transient_commit_exception(struct dm_exception_store *store,\r\nstruct dm_exception *e,\r\nvoid (*callback) (void *, int success),\r\nvoid *callback_context)\r\n{\r\ncallback(callback_context, 1);\r\n}\r\nstatic void transient_usage(struct dm_exception_store *store,\r\nsector_t *total_sectors,\r\nsector_t *sectors_allocated,\r\nsector_t *metadata_sectors)\r\n{\r\n*sectors_allocated = ((struct transient_c *) store->context)->next_free;\r\n*total_sectors = get_dev_size(dm_snap_cow(store->snap)->bdev);\r\n*metadata_sectors = 0;\r\n}\r\nstatic int transient_ctr(struct dm_exception_store *store,\r\nunsigned argc, char **argv)\r\n{\r\nstruct transient_c *tc;\r\ntc = kmalloc(sizeof(struct transient_c), GFP_KERNEL);\r\nif (!tc)\r\nreturn -ENOMEM;\r\ntc->next_free = 0;\r\nstore->context = tc;\r\nreturn 0;\r\n}\r\nstatic unsigned transient_status(struct dm_exception_store *store,\r\nstatus_type_t status, char *result,\r\nunsigned maxlen)\r\n{\r\nunsigned sz = 0;\r\nswitch (status) {\r\ncase STATUSTYPE_INFO:\r\nbreak;\r\ncase STATUSTYPE_TABLE:\r\nDMEMIT(" N %llu", (unsigned long long)store->chunk_size);\r\n}\r\nreturn sz;\r\n}\r\nint dm_transient_snapshot_init(void)\r\n{\r\nint r;\r\nr = dm_exception_store_type_register(&_transient_type);\r\nif (r) {\r\nDMWARN("Unable to register transient exception store type");\r\nreturn r;\r\n}\r\nr = dm_exception_store_type_register(&_transient_compat_type);\r\nif (r) {\r\nDMWARN("Unable to register old-style transient "\r\n"exception store type");\r\ndm_exception_store_type_unregister(&_transient_type);\r\nreturn r;\r\n}\r\nreturn r;\r\n}\r\nvoid dm_transient_snapshot_exit(void)\r\n{\r\ndm_exception_store_type_unregister(&_transient_type);\r\ndm_exception_store_type_unregister(&_transient_compat_type);\r\n}

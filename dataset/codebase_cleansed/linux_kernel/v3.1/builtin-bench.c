static void dump_suites(int subsys_index)\r\n{\r\nint i;\r\nprintf("# List of available suites for %s...\n\n",\r\nsubsystems[subsys_index].name);\r\nfor (i = 0; subsystems[subsys_index].suites[i].name; i++)\r\nprintf("%14s: %s\n",\r\nsubsystems[subsys_index].suites[i].name,\r\nsubsystems[subsys_index].suites[i].summary);\r\nprintf("\n");\r\nreturn;\r\n}\r\nstatic void print_usage(void)\r\n{\r\nint i;\r\nprintf("Usage: \n");\r\nfor (i = 0; bench_usage[i]; i++)\r\nprintf("\t%s\n", bench_usage[i]);\r\nprintf("\n");\r\nprintf("# List of available subsystems...\n\n");\r\nfor (i = 0; subsystems[i].name; i++)\r\nprintf("%14s: %s\n",\r\nsubsystems[i].name, subsystems[i].summary);\r\nprintf("\n");\r\n}\r\nstatic int bench_str2int(const char *str)\r\n{\r\nif (!str)\r\nreturn BENCH_FORMAT_DEFAULT;\r\nif (!strcmp(str, BENCH_FORMAT_DEFAULT_STR))\r\nreturn BENCH_FORMAT_DEFAULT;\r\nelse if (!strcmp(str, BENCH_FORMAT_SIMPLE_STR))\r\nreturn BENCH_FORMAT_SIMPLE;\r\nreturn BENCH_FORMAT_UNKNOWN;\r\n}\r\nstatic void all_suite(struct bench_subsys *subsys)\r\n{\r\nint i;\r\nconst char *argv[2];\r\nstruct bench_suite *suites = subsys->suites;\r\nargv[1] = NULL;\r\nfor (i = 0; suites[i].fn; i++) {\r\nprintf("# Running %s/%s benchmark...\n",\r\nsubsys->name,\r\nsuites[i].name);\r\nargv[1] = suites[i].name;\r\nsuites[i].fn(1, argv, NULL);\r\nprintf("\n");\r\n}\r\n}\r\nstatic void all_subsystem(void)\r\n{\r\nint i;\r\nfor (i = 0; subsystems[i].suites; i++)\r\nall_suite(&subsystems[i]);\r\n}\r\nint cmd_bench(int argc, const char **argv, const char *prefix __used)\r\n{\r\nint i, j, status = 0;\r\nif (argc < 2) {\r\nprint_usage();\r\ngoto end;\r\n}\r\nargc = parse_options(argc, argv, bench_options, bench_usage,\r\nPARSE_OPT_STOP_AT_NON_OPTION);\r\nbench_format = bench_str2int(bench_format_str);\r\nif (bench_format == BENCH_FORMAT_UNKNOWN) {\r\nprintf("Unknown format descriptor:%s\n", bench_format_str);\r\ngoto end;\r\n}\r\nif (argc < 1) {\r\nprint_usage();\r\ngoto end;\r\n}\r\nif (!strcmp(argv[0], "all")) {\r\nall_subsystem();\r\ngoto end;\r\n}\r\nfor (i = 0; subsystems[i].name; i++) {\r\nif (strcmp(subsystems[i].name, argv[0]))\r\ncontinue;\r\nif (argc < 2) {\r\ndump_suites(i);\r\ngoto end;\r\n}\r\nif (!strcmp(argv[1], "all")) {\r\nall_suite(&subsystems[i]);\r\ngoto end;\r\n}\r\nfor (j = 0; subsystems[i].suites[j].name; j++) {\r\nif (strcmp(subsystems[i].suites[j].name, argv[1]))\r\ncontinue;\r\nif (bench_format == BENCH_FORMAT_DEFAULT)\r\nprintf("# Running %s/%s benchmark...\n",\r\nsubsystems[i].name,\r\nsubsystems[i].suites[j].name);\r\nstatus = subsystems[i].suites[j].fn(argc - 1,\r\nargv + 1, prefix);\r\ngoto end;\r\n}\r\nif (!strcmp(argv[1], "-h") || !strcmp(argv[1], "--help")) {\r\ndump_suites(i);\r\ngoto end;\r\n}\r\nprintf("Unknown suite:%s for %s\n", argv[1], argv[0]);\r\nstatus = 1;\r\ngoto end;\r\n}\r\nprintf("Unknown subsystem:%s\n", argv[0]);\r\nstatus = 1;\r\nend:\r\nreturn status;\r\n}

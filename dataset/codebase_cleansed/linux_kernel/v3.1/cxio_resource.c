static int __cxio_init_resource_fifo(struct kfifo *fifo,\r\nspinlock_t *fifo_lock,\r\nu32 nr, u32 skip_low,\r\nu32 skip_high,\r\nint random)\r\n{\r\nu32 i, j, entry = 0, idx;\r\nu32 random_bytes;\r\nu32 rarray[16];\r\nspin_lock_init(fifo_lock);\r\nif (kfifo_alloc(fifo, nr * sizeof(u32), GFP_KERNEL))\r\nreturn -ENOMEM;\r\nfor (i = 0; i < skip_low + skip_high; i++)\r\nkfifo_in(fifo, (unsigned char *) &entry, sizeof(u32));\r\nif (random) {\r\nj = 0;\r\nrandom_bytes = random32();\r\nfor (i = 0; i < RANDOM_SIZE; i++)\r\nrarray[i] = i + skip_low;\r\nfor (i = skip_low + RANDOM_SIZE; i < nr - skip_high; i++) {\r\nif (j >= RANDOM_SIZE) {\r\nj = 0;\r\nrandom_bytes = random32();\r\n}\r\nidx = (random_bytes >> (j * 2)) & 0xF;\r\nkfifo_in(fifo,\r\n(unsigned char *) &rarray[idx],\r\nsizeof(u32));\r\nrarray[idx] = i;\r\nj++;\r\n}\r\nfor (i = 0; i < RANDOM_SIZE; i++)\r\nkfifo_in(fifo,\r\n(unsigned char *) &rarray[i],\r\nsizeof(u32));\r\n} else\r\nfor (i = skip_low; i < nr - skip_high; i++)\r\nkfifo_in(fifo, (unsigned char *) &i, sizeof(u32));\r\nfor (i = 0; i < skip_low + skip_high; i++)\r\nif (kfifo_out_locked(fifo, (unsigned char *) &entry,\r\nsizeof(u32), fifo_lock) != sizeof(u32))\r\nbreak;\r\nreturn 0;\r\n}\r\nstatic int cxio_init_resource_fifo(struct kfifo *fifo, spinlock_t * fifo_lock,\r\nu32 nr, u32 skip_low, u32 skip_high)\r\n{\r\nreturn (__cxio_init_resource_fifo(fifo, fifo_lock, nr, skip_low,\r\nskip_high, 0));\r\n}\r\nstatic int cxio_init_resource_fifo_random(struct kfifo *fifo,\r\nspinlock_t * fifo_lock,\r\nu32 nr, u32 skip_low, u32 skip_high)\r\n{\r\nreturn (__cxio_init_resource_fifo(fifo, fifo_lock, nr, skip_low,\r\nskip_high, 1));\r\n}\r\nstatic int cxio_init_qpid_fifo(struct cxio_rdev *rdev_p)\r\n{\r\nu32 i;\r\nspin_lock_init(&rdev_p->rscp->qpid_fifo_lock);\r\nif (kfifo_alloc(&rdev_p->rscp->qpid_fifo, T3_MAX_NUM_QP * sizeof(u32),\r\nGFP_KERNEL))\r\nreturn -ENOMEM;\r\nfor (i = 16; i < T3_MAX_NUM_QP; i++)\r\nif (!(i & rdev_p->qpmask))\r\nkfifo_in(&rdev_p->rscp->qpid_fifo,\r\n(unsigned char *) &i, sizeof(u32));\r\nreturn 0;\r\n}\r\nint cxio_hal_init_rhdl_resource(u32 nr_rhdl)\r\n{\r\nreturn cxio_init_resource_fifo(&rhdl_fifo, &rhdl_fifo_lock, nr_rhdl, 1,\r\n0);\r\n}\r\nvoid cxio_hal_destroy_rhdl_resource(void)\r\n{\r\nkfifo_free(&rhdl_fifo);\r\n}\r\nint cxio_hal_init_resource(struct cxio_rdev *rdev_p,\r\nu32 nr_tpt, u32 nr_pbl,\r\nu32 nr_rqt, u32 nr_qpid, u32 nr_cqid, u32 nr_pdid)\r\n{\r\nint err = 0;\r\nstruct cxio_hal_resource *rscp;\r\nrscp = kmalloc(sizeof(*rscp), GFP_KERNEL);\r\nif (!rscp)\r\nreturn -ENOMEM;\r\nrdev_p->rscp = rscp;\r\nerr = cxio_init_resource_fifo_random(&rscp->tpt_fifo,\r\n&rscp->tpt_fifo_lock,\r\nnr_tpt, 1, 0);\r\nif (err)\r\ngoto tpt_err;\r\nerr = cxio_init_qpid_fifo(rdev_p);\r\nif (err)\r\ngoto qpid_err;\r\nerr = cxio_init_resource_fifo(&rscp->cqid_fifo, &rscp->cqid_fifo_lock,\r\nnr_cqid, 1, 0);\r\nif (err)\r\ngoto cqid_err;\r\nerr = cxio_init_resource_fifo(&rscp->pdid_fifo, &rscp->pdid_fifo_lock,\r\nnr_pdid, 1, 0);\r\nif (err)\r\ngoto pdid_err;\r\nreturn 0;\r\npdid_err:\r\nkfifo_free(&rscp->cqid_fifo);\r\ncqid_err:\r\nkfifo_free(&rscp->qpid_fifo);\r\nqpid_err:\r\nkfifo_free(&rscp->tpt_fifo);\r\ntpt_err:\r\nreturn -ENOMEM;\r\n}\r\nstatic u32 cxio_hal_get_resource(struct kfifo *fifo, spinlock_t * lock)\r\n{\r\nu32 entry;\r\nif (kfifo_out_locked(fifo, (unsigned char *) &entry, sizeof(u32), lock))\r\nreturn entry;\r\nelse\r\nreturn 0;\r\n}\r\nstatic void cxio_hal_put_resource(struct kfifo *fifo, spinlock_t * lock,\r\nu32 entry)\r\n{\r\nBUG_ON(\r\nkfifo_in_locked(fifo, (unsigned char *) &entry, sizeof(u32), lock)\r\n== 0);\r\n}\r\nu32 cxio_hal_get_stag(struct cxio_hal_resource *rscp)\r\n{\r\nreturn cxio_hal_get_resource(&rscp->tpt_fifo, &rscp->tpt_fifo_lock);\r\n}\r\nvoid cxio_hal_put_stag(struct cxio_hal_resource *rscp, u32 stag)\r\n{\r\ncxio_hal_put_resource(&rscp->tpt_fifo, &rscp->tpt_fifo_lock, stag);\r\n}\r\nu32 cxio_hal_get_qpid(struct cxio_hal_resource *rscp)\r\n{\r\nu32 qpid = cxio_hal_get_resource(&rscp->qpid_fifo,\r\n&rscp->qpid_fifo_lock);\r\nPDBG("%s qpid 0x%x\n", __func__, qpid);\r\nreturn qpid;\r\n}\r\nvoid cxio_hal_put_qpid(struct cxio_hal_resource *rscp, u32 qpid)\r\n{\r\nPDBG("%s qpid 0x%x\n", __func__, qpid);\r\ncxio_hal_put_resource(&rscp->qpid_fifo, &rscp->qpid_fifo_lock, qpid);\r\n}\r\nu32 cxio_hal_get_cqid(struct cxio_hal_resource *rscp)\r\n{\r\nreturn cxio_hal_get_resource(&rscp->cqid_fifo, &rscp->cqid_fifo_lock);\r\n}\r\nvoid cxio_hal_put_cqid(struct cxio_hal_resource *rscp, u32 cqid)\r\n{\r\ncxio_hal_put_resource(&rscp->cqid_fifo, &rscp->cqid_fifo_lock, cqid);\r\n}\r\nu32 cxio_hal_get_pdid(struct cxio_hal_resource *rscp)\r\n{\r\nreturn cxio_hal_get_resource(&rscp->pdid_fifo, &rscp->pdid_fifo_lock);\r\n}\r\nvoid cxio_hal_put_pdid(struct cxio_hal_resource *rscp, u32 pdid)\r\n{\r\ncxio_hal_put_resource(&rscp->pdid_fifo, &rscp->pdid_fifo_lock, pdid);\r\n}\r\nvoid cxio_hal_destroy_resource(struct cxio_hal_resource *rscp)\r\n{\r\nkfifo_free(&rscp->tpt_fifo);\r\nkfifo_free(&rscp->cqid_fifo);\r\nkfifo_free(&rscp->qpid_fifo);\r\nkfifo_free(&rscp->pdid_fifo);\r\nkfree(rscp);\r\n}\r\nu32 cxio_hal_pblpool_alloc(struct cxio_rdev *rdev_p, int size)\r\n{\r\nunsigned long addr = gen_pool_alloc(rdev_p->pbl_pool, size);\r\nPDBG("%s addr 0x%x size %d\n", __func__, (u32)addr, size);\r\nreturn (u32)addr;\r\n}\r\nvoid cxio_hal_pblpool_free(struct cxio_rdev *rdev_p, u32 addr, int size)\r\n{\r\nPDBG("%s addr 0x%x size %d\n", __func__, addr, size);\r\ngen_pool_free(rdev_p->pbl_pool, (unsigned long)addr, size);\r\n}\r\nint cxio_hal_pblpool_create(struct cxio_rdev *rdev_p)\r\n{\r\nunsigned pbl_start, pbl_chunk;\r\nrdev_p->pbl_pool = gen_pool_create(MIN_PBL_SHIFT, -1);\r\nif (!rdev_p->pbl_pool)\r\nreturn -ENOMEM;\r\npbl_start = rdev_p->rnic_info.pbl_base;\r\npbl_chunk = rdev_p->rnic_info.pbl_top - pbl_start + 1;\r\nwhile (pbl_start < rdev_p->rnic_info.pbl_top) {\r\npbl_chunk = min(rdev_p->rnic_info.pbl_top - pbl_start + 1,\r\npbl_chunk);\r\nif (gen_pool_add(rdev_p->pbl_pool, pbl_start, pbl_chunk, -1)) {\r\nPDBG("%s failed to add PBL chunk (%x/%x)\n",\r\n__func__, pbl_start, pbl_chunk);\r\nif (pbl_chunk <= 1024 << MIN_PBL_SHIFT) {\r\nprintk(KERN_WARNING MOD "%s: Failed to add all PBL chunks (%x/%x)\n",\r\n__func__, pbl_start, rdev_p->rnic_info.pbl_top - pbl_start);\r\nreturn 0;\r\n}\r\npbl_chunk >>= 1;\r\n} else {\r\nPDBG("%s added PBL chunk (%x/%x)\n",\r\n__func__, pbl_start, pbl_chunk);\r\npbl_start += pbl_chunk;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nvoid cxio_hal_pblpool_destroy(struct cxio_rdev *rdev_p)\r\n{\r\ngen_pool_destroy(rdev_p->pbl_pool);\r\n}\r\nu32 cxio_hal_rqtpool_alloc(struct cxio_rdev *rdev_p, int size)\r\n{\r\nunsigned long addr = gen_pool_alloc(rdev_p->rqt_pool, size << 6);\r\nPDBG("%s addr 0x%x size %d\n", __func__, (u32)addr, size << 6);\r\nreturn (u32)addr;\r\n}\r\nvoid cxio_hal_rqtpool_free(struct cxio_rdev *rdev_p, u32 addr, int size)\r\n{\r\nPDBG("%s addr 0x%x size %d\n", __func__, addr, size << 6);\r\ngen_pool_free(rdev_p->rqt_pool, (unsigned long)addr, size << 6);\r\n}\r\nint cxio_hal_rqtpool_create(struct cxio_rdev *rdev_p)\r\n{\r\nunsigned long i;\r\nrdev_p->rqt_pool = gen_pool_create(MIN_RQT_SHIFT, -1);\r\nif (rdev_p->rqt_pool)\r\nfor (i = rdev_p->rnic_info.rqt_base;\r\ni <= rdev_p->rnic_info.rqt_top - RQT_CHUNK + 1;\r\ni += RQT_CHUNK)\r\ngen_pool_add(rdev_p->rqt_pool, i, RQT_CHUNK, -1);\r\nreturn rdev_p->rqt_pool ? 0 : -ENOMEM;\r\n}\r\nvoid cxio_hal_rqtpool_destroy(struct cxio_rdev *rdev_p)\r\n{\r\ngen_pool_destroy(rdev_p->rqt_pool);\r\n}

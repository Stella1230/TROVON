int zlib_inflate_blob(void *gunzip_buf, unsigned int sz,\r\nconst void *buf, unsigned int len)\r\n{\r\nconst u8 *zbuf = buf;\r\nstruct z_stream_s *strm;\r\nint rc;\r\nrc = -ENOMEM;\r\nstrm = kmalloc(sizeof(*strm), GFP_KERNEL);\r\nif (strm == NULL)\r\ngoto gunzip_nomem1;\r\nstrm->workspace = kmalloc(zlib_inflate_workspacesize(), GFP_KERNEL);\r\nif (strm->workspace == NULL)\r\ngoto gunzip_nomem2;\r\nstrm->next_in = zbuf;\r\nstrm->avail_in = len;\r\nstrm->next_out = gunzip_buf;\r\nstrm->avail_out = sz;\r\nrc = zlib_inflateInit2(strm, -MAX_WBITS);\r\nif (rc == Z_OK) {\r\nrc = zlib_inflate(strm, Z_FINISH);\r\nif (rc == Z_STREAM_END)\r\nrc = sz - strm->avail_out;\r\nelse\r\nrc = -EINVAL;\r\nzlib_inflateEnd(strm);\r\n} else\r\nrc = -EINVAL;\r\nkfree(strm->workspace);\r\ngunzip_nomem2:\r\nkfree(strm);\r\ngunzip_nomem1:\r\nreturn rc;\r\n}

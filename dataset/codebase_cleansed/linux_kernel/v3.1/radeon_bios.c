static bool igp_read_bios_from_vram(struct radeon_device *rdev)\r\n{\r\nuint8_t __iomem *bios;\r\nresource_size_t vram_base;\r\nresource_size_t size = 256 * 1024;\r\nif (!(rdev->flags & RADEON_IS_IGP))\r\nif (!radeon_card_posted(rdev))\r\nreturn false;\r\nrdev->bios = NULL;\r\nvram_base = pci_resource_start(rdev->pdev, 0);\r\nbios = ioremap(vram_base, size);\r\nif (!bios) {\r\nreturn false;\r\n}\r\nif (size == 0 || bios[0] != 0x55 || bios[1] != 0xaa) {\r\niounmap(bios);\r\nreturn false;\r\n}\r\nrdev->bios = kmalloc(size, GFP_KERNEL);\r\nif (rdev->bios == NULL) {\r\niounmap(bios);\r\nreturn false;\r\n}\r\nmemcpy_fromio(rdev->bios, bios, size);\r\niounmap(bios);\r\nreturn true;\r\n}\r\nstatic bool radeon_read_bios(struct radeon_device *rdev)\r\n{\r\nuint8_t __iomem *bios;\r\nsize_t size;\r\nrdev->bios = NULL;\r\nbios = pci_map_rom(rdev->pdev, &size);\r\nif (!bios) {\r\nreturn false;\r\n}\r\nif (size == 0 || bios[0] != 0x55 || bios[1] != 0xaa) {\r\npci_unmap_rom(rdev->pdev, bios);\r\nreturn false;\r\n}\r\nrdev->bios = kmemdup(bios, size, GFP_KERNEL);\r\nif (rdev->bios == NULL) {\r\npci_unmap_rom(rdev->pdev, bios);\r\nreturn false;\r\n}\r\npci_unmap_rom(rdev->pdev, bios);\r\nreturn true;\r\n}\r\nstatic bool radeon_atrm_get_bios(struct radeon_device *rdev)\r\n{\r\nint ret;\r\nint size = 256 * 1024;\r\nint i;\r\nif (!radeon_atrm_supported(rdev->pdev))\r\nreturn false;\r\nrdev->bios = kmalloc(size, GFP_KERNEL);\r\nif (!rdev->bios) {\r\nDRM_ERROR("Unable to allocate bios\n");\r\nreturn false;\r\n}\r\nfor (i = 0; i < size / ATRM_BIOS_PAGE; i++) {\r\nret = radeon_atrm_get_bios_chunk(rdev->bios,\r\n(i * ATRM_BIOS_PAGE),\r\nATRM_BIOS_PAGE);\r\nif (ret <= 0)\r\nbreak;\r\n}\r\nif (i == 0 || rdev->bios[0] != 0x55 || rdev->bios[1] != 0xaa) {\r\nkfree(rdev->bios);\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nstatic bool ni_read_disabled_bios(struct radeon_device *rdev)\r\n{\r\nu32 bus_cntl;\r\nu32 d1vga_control;\r\nu32 d2vga_control;\r\nu32 vga_render_control;\r\nu32 rom_cntl;\r\nbool r;\r\nbus_cntl = RREG32(R600_BUS_CNTL);\r\nd1vga_control = RREG32(AVIVO_D1VGA_CONTROL);\r\nd2vga_control = RREG32(AVIVO_D2VGA_CONTROL);\r\nvga_render_control = RREG32(AVIVO_VGA_RENDER_CONTROL);\r\nrom_cntl = RREG32(R600_ROM_CNTL);\r\nWREG32(R600_BUS_CNTL, (bus_cntl & ~R600_BIOS_ROM_DIS));\r\nWREG32(AVIVO_D1VGA_CONTROL,\r\n(d1vga_control & ~(AVIVO_DVGA_CONTROL_MODE_ENABLE |\r\nAVIVO_DVGA_CONTROL_TIMING_SELECT)));\r\nWREG32(AVIVO_D2VGA_CONTROL,\r\n(d2vga_control & ~(AVIVO_DVGA_CONTROL_MODE_ENABLE |\r\nAVIVO_DVGA_CONTROL_TIMING_SELECT)));\r\nWREG32(AVIVO_VGA_RENDER_CONTROL,\r\n(vga_render_control & ~AVIVO_VGA_VSTATUS_CNTL_MASK));\r\nWREG32(R600_ROM_CNTL, rom_cntl | R600_SCK_OVERWRITE);\r\nr = radeon_read_bios(rdev);\r\nWREG32(R600_BUS_CNTL, bus_cntl);\r\nWREG32(AVIVO_D1VGA_CONTROL, d1vga_control);\r\nWREG32(AVIVO_D2VGA_CONTROL, d2vga_control);\r\nWREG32(AVIVO_VGA_RENDER_CONTROL, vga_render_control);\r\nWREG32(R600_ROM_CNTL, rom_cntl);\r\nreturn r;\r\n}\r\nstatic bool r700_read_disabled_bios(struct radeon_device *rdev)\r\n{\r\nuint32_t viph_control;\r\nuint32_t bus_cntl;\r\nuint32_t d1vga_control;\r\nuint32_t d2vga_control;\r\nuint32_t vga_render_control;\r\nuint32_t rom_cntl;\r\nuint32_t cg_spll_func_cntl = 0;\r\nuint32_t cg_spll_status;\r\nbool r;\r\nviph_control = RREG32(RADEON_VIPH_CONTROL);\r\nbus_cntl = RREG32(R600_BUS_CNTL);\r\nd1vga_control = RREG32(AVIVO_D1VGA_CONTROL);\r\nd2vga_control = RREG32(AVIVO_D2VGA_CONTROL);\r\nvga_render_control = RREG32(AVIVO_VGA_RENDER_CONTROL);\r\nrom_cntl = RREG32(R600_ROM_CNTL);\r\nWREG32(RADEON_VIPH_CONTROL, (viph_control & ~RADEON_VIPH_EN));\r\nWREG32(R600_BUS_CNTL, (bus_cntl & ~R600_BIOS_ROM_DIS));\r\nWREG32(AVIVO_D1VGA_CONTROL,\r\n(d1vga_control & ~(AVIVO_DVGA_CONTROL_MODE_ENABLE |\r\nAVIVO_DVGA_CONTROL_TIMING_SELECT)));\r\nWREG32(AVIVO_D2VGA_CONTROL,\r\n(d2vga_control & ~(AVIVO_DVGA_CONTROL_MODE_ENABLE |\r\nAVIVO_DVGA_CONTROL_TIMING_SELECT)));\r\nWREG32(AVIVO_VGA_RENDER_CONTROL,\r\n(vga_render_control & ~AVIVO_VGA_VSTATUS_CNTL_MASK));\r\nif (rdev->family == CHIP_RV730) {\r\ncg_spll_func_cntl = RREG32(R600_CG_SPLL_FUNC_CNTL);\r\nWREG32(R600_CG_SPLL_FUNC_CNTL, (cg_spll_func_cntl |\r\nR600_SPLL_BYPASS_EN));\r\ncg_spll_status = 0;\r\nwhile (!(cg_spll_status & R600_SPLL_CHG_STATUS))\r\ncg_spll_status = RREG32(R600_CG_SPLL_STATUS);\r\nWREG32(R600_ROM_CNTL, (rom_cntl & ~R600_SCK_OVERWRITE));\r\n} else\r\nWREG32(R600_ROM_CNTL, (rom_cntl | R600_SCK_OVERWRITE));\r\nr = radeon_read_bios(rdev);\r\nif (rdev->family == CHIP_RV730) {\r\nWREG32(R600_CG_SPLL_FUNC_CNTL, cg_spll_func_cntl);\r\ncg_spll_status = 0;\r\nwhile (!(cg_spll_status & R600_SPLL_CHG_STATUS))\r\ncg_spll_status = RREG32(R600_CG_SPLL_STATUS);\r\n}\r\nWREG32(RADEON_VIPH_CONTROL, viph_control);\r\nWREG32(R600_BUS_CNTL, bus_cntl);\r\nWREG32(AVIVO_D1VGA_CONTROL, d1vga_control);\r\nWREG32(AVIVO_D2VGA_CONTROL, d2vga_control);\r\nWREG32(AVIVO_VGA_RENDER_CONTROL, vga_render_control);\r\nWREG32(R600_ROM_CNTL, rom_cntl);\r\nreturn r;\r\n}\r\nstatic bool r600_read_disabled_bios(struct radeon_device *rdev)\r\n{\r\nuint32_t viph_control;\r\nuint32_t bus_cntl;\r\nuint32_t d1vga_control;\r\nuint32_t d2vga_control;\r\nuint32_t vga_render_control;\r\nuint32_t rom_cntl;\r\nuint32_t general_pwrmgt;\r\nuint32_t low_vid_lower_gpio_cntl;\r\nuint32_t medium_vid_lower_gpio_cntl;\r\nuint32_t high_vid_lower_gpio_cntl;\r\nuint32_t ctxsw_vid_lower_gpio_cntl;\r\nuint32_t lower_gpio_enable;\r\nbool r;\r\nviph_control = RREG32(RADEON_VIPH_CONTROL);\r\nbus_cntl = RREG32(R600_BUS_CNTL);\r\nd1vga_control = RREG32(AVIVO_D1VGA_CONTROL);\r\nd2vga_control = RREG32(AVIVO_D2VGA_CONTROL);\r\nvga_render_control = RREG32(AVIVO_VGA_RENDER_CONTROL);\r\nrom_cntl = RREG32(R600_ROM_CNTL);\r\ngeneral_pwrmgt = RREG32(R600_GENERAL_PWRMGT);\r\nlow_vid_lower_gpio_cntl = RREG32(R600_LOW_VID_LOWER_GPIO_CNTL);\r\nmedium_vid_lower_gpio_cntl = RREG32(R600_MEDIUM_VID_LOWER_GPIO_CNTL);\r\nhigh_vid_lower_gpio_cntl = RREG32(R600_HIGH_VID_LOWER_GPIO_CNTL);\r\nctxsw_vid_lower_gpio_cntl = RREG32(R600_CTXSW_VID_LOWER_GPIO_CNTL);\r\nlower_gpio_enable = RREG32(R600_LOWER_GPIO_ENABLE);\r\nWREG32(RADEON_VIPH_CONTROL, (viph_control & ~RADEON_VIPH_EN));\r\nWREG32(R600_BUS_CNTL, (bus_cntl & ~R600_BIOS_ROM_DIS));\r\nWREG32(AVIVO_D1VGA_CONTROL,\r\n(d1vga_control & ~(AVIVO_DVGA_CONTROL_MODE_ENABLE |\r\nAVIVO_DVGA_CONTROL_TIMING_SELECT)));\r\nWREG32(AVIVO_D2VGA_CONTROL,\r\n(d2vga_control & ~(AVIVO_DVGA_CONTROL_MODE_ENABLE |\r\nAVIVO_DVGA_CONTROL_TIMING_SELECT)));\r\nWREG32(AVIVO_VGA_RENDER_CONTROL,\r\n(vga_render_control & ~AVIVO_VGA_VSTATUS_CNTL_MASK));\r\nWREG32(R600_ROM_CNTL,\r\n((rom_cntl & ~R600_SCK_PRESCALE_CRYSTAL_CLK_MASK) |\r\n(1 << R600_SCK_PRESCALE_CRYSTAL_CLK_SHIFT) |\r\nR600_SCK_OVERWRITE));\r\nWREG32(R600_GENERAL_PWRMGT, (general_pwrmgt & ~R600_OPEN_DRAIN_PADS));\r\nWREG32(R600_LOW_VID_LOWER_GPIO_CNTL,\r\n(low_vid_lower_gpio_cntl & ~0x400));\r\nWREG32(R600_MEDIUM_VID_LOWER_GPIO_CNTL,\r\n(medium_vid_lower_gpio_cntl & ~0x400));\r\nWREG32(R600_HIGH_VID_LOWER_GPIO_CNTL,\r\n(high_vid_lower_gpio_cntl & ~0x400));\r\nWREG32(R600_CTXSW_VID_LOWER_GPIO_CNTL,\r\n(ctxsw_vid_lower_gpio_cntl & ~0x400));\r\nWREG32(R600_LOWER_GPIO_ENABLE, (lower_gpio_enable | 0x400));\r\nr = radeon_read_bios(rdev);\r\nWREG32(RADEON_VIPH_CONTROL, viph_control);\r\nWREG32(R600_BUS_CNTL, bus_cntl);\r\nWREG32(AVIVO_D1VGA_CONTROL, d1vga_control);\r\nWREG32(AVIVO_D2VGA_CONTROL, d2vga_control);\r\nWREG32(AVIVO_VGA_RENDER_CONTROL, vga_render_control);\r\nWREG32(R600_ROM_CNTL, rom_cntl);\r\nWREG32(R600_GENERAL_PWRMGT, general_pwrmgt);\r\nWREG32(R600_LOW_VID_LOWER_GPIO_CNTL, low_vid_lower_gpio_cntl);\r\nWREG32(R600_MEDIUM_VID_LOWER_GPIO_CNTL, medium_vid_lower_gpio_cntl);\r\nWREG32(R600_HIGH_VID_LOWER_GPIO_CNTL, high_vid_lower_gpio_cntl);\r\nWREG32(R600_CTXSW_VID_LOWER_GPIO_CNTL, ctxsw_vid_lower_gpio_cntl);\r\nWREG32(R600_LOWER_GPIO_ENABLE, lower_gpio_enable);\r\nreturn r;\r\n}\r\nstatic bool avivo_read_disabled_bios(struct radeon_device *rdev)\r\n{\r\nuint32_t seprom_cntl1;\r\nuint32_t viph_control;\r\nuint32_t bus_cntl;\r\nuint32_t d1vga_control;\r\nuint32_t d2vga_control;\r\nuint32_t vga_render_control;\r\nuint32_t gpiopad_a;\r\nuint32_t gpiopad_en;\r\nuint32_t gpiopad_mask;\r\nbool r;\r\nseprom_cntl1 = RREG32(RADEON_SEPROM_CNTL1);\r\nviph_control = RREG32(RADEON_VIPH_CONTROL);\r\nbus_cntl = RREG32(RV370_BUS_CNTL);\r\nd1vga_control = RREG32(AVIVO_D1VGA_CONTROL);\r\nd2vga_control = RREG32(AVIVO_D2VGA_CONTROL);\r\nvga_render_control = RREG32(AVIVO_VGA_RENDER_CONTROL);\r\ngpiopad_a = RREG32(RADEON_GPIOPAD_A);\r\ngpiopad_en = RREG32(RADEON_GPIOPAD_EN);\r\ngpiopad_mask = RREG32(RADEON_GPIOPAD_MASK);\r\nWREG32(RADEON_SEPROM_CNTL1,\r\n((seprom_cntl1 & ~RADEON_SCK_PRESCALE_MASK) |\r\n(0xc << RADEON_SCK_PRESCALE_SHIFT)));\r\nWREG32(RADEON_GPIOPAD_A, 0);\r\nWREG32(RADEON_GPIOPAD_EN, 0);\r\nWREG32(RADEON_GPIOPAD_MASK, 0);\r\nWREG32(RADEON_VIPH_CONTROL, (viph_control & ~RADEON_VIPH_EN));\r\nWREG32(RV370_BUS_CNTL, (bus_cntl & ~RV370_BUS_BIOS_DIS_ROM));\r\nWREG32(AVIVO_D1VGA_CONTROL,\r\n(d1vga_control & ~(AVIVO_DVGA_CONTROL_MODE_ENABLE |\r\nAVIVO_DVGA_CONTROL_TIMING_SELECT)));\r\nWREG32(AVIVO_D2VGA_CONTROL,\r\n(d2vga_control & ~(AVIVO_DVGA_CONTROL_MODE_ENABLE |\r\nAVIVO_DVGA_CONTROL_TIMING_SELECT)));\r\nWREG32(AVIVO_VGA_RENDER_CONTROL,\r\n(vga_render_control & ~AVIVO_VGA_VSTATUS_CNTL_MASK));\r\nr = radeon_read_bios(rdev);\r\nWREG32(RADEON_SEPROM_CNTL1, seprom_cntl1);\r\nWREG32(RADEON_VIPH_CONTROL, viph_control);\r\nWREG32(RV370_BUS_CNTL, bus_cntl);\r\nWREG32(AVIVO_D1VGA_CONTROL, d1vga_control);\r\nWREG32(AVIVO_D2VGA_CONTROL, d2vga_control);\r\nWREG32(AVIVO_VGA_RENDER_CONTROL, vga_render_control);\r\nWREG32(RADEON_GPIOPAD_A, gpiopad_a);\r\nWREG32(RADEON_GPIOPAD_EN, gpiopad_en);\r\nWREG32(RADEON_GPIOPAD_MASK, gpiopad_mask);\r\nreturn r;\r\n}\r\nstatic bool legacy_read_disabled_bios(struct radeon_device *rdev)\r\n{\r\nuint32_t seprom_cntl1;\r\nuint32_t viph_control;\r\nuint32_t bus_cntl;\r\nuint32_t crtc_gen_cntl;\r\nuint32_t crtc2_gen_cntl;\r\nuint32_t crtc_ext_cntl;\r\nuint32_t fp2_gen_cntl;\r\nbool r;\r\nseprom_cntl1 = RREG32(RADEON_SEPROM_CNTL1);\r\nviph_control = RREG32(RADEON_VIPH_CONTROL);\r\nif (rdev->flags & RADEON_IS_PCIE)\r\nbus_cntl = RREG32(RV370_BUS_CNTL);\r\nelse\r\nbus_cntl = RREG32(RADEON_BUS_CNTL);\r\ncrtc_gen_cntl = RREG32(RADEON_CRTC_GEN_CNTL);\r\ncrtc2_gen_cntl = 0;\r\ncrtc_ext_cntl = RREG32(RADEON_CRTC_EXT_CNTL);\r\nfp2_gen_cntl = 0;\r\nif (rdev->ddev->pci_device == PCI_DEVICE_ID_ATI_RADEON_QY) {\r\nfp2_gen_cntl = RREG32(RADEON_FP2_GEN_CNTL);\r\n}\r\nif (!(rdev->flags & RADEON_SINGLE_CRTC)) {\r\ncrtc2_gen_cntl = RREG32(RADEON_CRTC2_GEN_CNTL);\r\n}\r\nWREG32(RADEON_SEPROM_CNTL1,\r\n((seprom_cntl1 & ~RADEON_SCK_PRESCALE_MASK) |\r\n(0xc << RADEON_SCK_PRESCALE_SHIFT)));\r\nWREG32(RADEON_VIPH_CONTROL, (viph_control & ~RADEON_VIPH_EN));\r\nif (rdev->flags & RADEON_IS_PCIE)\r\nWREG32(RV370_BUS_CNTL, (bus_cntl & ~RV370_BUS_BIOS_DIS_ROM));\r\nelse\r\nWREG32(RADEON_BUS_CNTL, (bus_cntl & ~RADEON_BUS_BIOS_DIS_ROM));\r\nWREG32(RADEON_CRTC_GEN_CNTL,\r\n((crtc_gen_cntl & ~RADEON_CRTC_EN) |\r\n(RADEON_CRTC_DISP_REQ_EN_B |\r\nRADEON_CRTC_EXT_DISP_EN)));\r\nif (!(rdev->flags & RADEON_SINGLE_CRTC)) {\r\nWREG32(RADEON_CRTC2_GEN_CNTL,\r\n((crtc2_gen_cntl & ~RADEON_CRTC2_EN) |\r\nRADEON_CRTC2_DISP_REQ_EN_B));\r\n}\r\nWREG32(RADEON_CRTC_EXT_CNTL,\r\n((crtc_ext_cntl & ~RADEON_CRTC_CRT_ON) |\r\n(RADEON_CRTC_SYNC_TRISTAT |\r\nRADEON_CRTC_DISPLAY_DIS)));\r\nif (rdev->ddev->pci_device == PCI_DEVICE_ID_ATI_RADEON_QY) {\r\nWREG32(RADEON_FP2_GEN_CNTL, (fp2_gen_cntl & ~RADEON_FP2_ON));\r\n}\r\nr = radeon_read_bios(rdev);\r\nWREG32(RADEON_SEPROM_CNTL1, seprom_cntl1);\r\nWREG32(RADEON_VIPH_CONTROL, viph_control);\r\nif (rdev->flags & RADEON_IS_PCIE)\r\nWREG32(RV370_BUS_CNTL, bus_cntl);\r\nelse\r\nWREG32(RADEON_BUS_CNTL, bus_cntl);\r\nWREG32(RADEON_CRTC_GEN_CNTL, crtc_gen_cntl);\r\nif (!(rdev->flags & RADEON_SINGLE_CRTC)) {\r\nWREG32(RADEON_CRTC2_GEN_CNTL, crtc2_gen_cntl);\r\n}\r\nWREG32(RADEON_CRTC_EXT_CNTL, crtc_ext_cntl);\r\nif (rdev->ddev->pci_device == PCI_DEVICE_ID_ATI_RADEON_QY) {\r\nWREG32(RADEON_FP2_GEN_CNTL, fp2_gen_cntl);\r\n}\r\nreturn r;\r\n}\r\nstatic bool radeon_read_disabled_bios(struct radeon_device *rdev)\r\n{\r\nif (rdev->flags & RADEON_IS_IGP)\r\nreturn igp_read_bios_from_vram(rdev);\r\nelse if (rdev->family >= CHIP_BARTS)\r\nreturn ni_read_disabled_bios(rdev);\r\nelse if (rdev->family >= CHIP_RV770)\r\nreturn r700_read_disabled_bios(rdev);\r\nelse if (rdev->family >= CHIP_R600)\r\nreturn r600_read_disabled_bios(rdev);\r\nelse if (rdev->family >= CHIP_RS600)\r\nreturn avivo_read_disabled_bios(rdev);\r\nelse\r\nreturn legacy_read_disabled_bios(rdev);\r\n}\r\nbool radeon_get_bios(struct radeon_device *rdev)\r\n{\r\nbool r;\r\nuint16_t tmp;\r\nr = radeon_atrm_get_bios(rdev);\r\nif (r == false)\r\nr = igp_read_bios_from_vram(rdev);\r\nif (r == false)\r\nr = radeon_read_bios(rdev);\r\nif (r == false) {\r\nr = radeon_read_disabled_bios(rdev);\r\n}\r\nif (r == false || rdev->bios == NULL) {\r\nDRM_ERROR("Unable to locate a BIOS ROM\n");\r\nrdev->bios = NULL;\r\nreturn false;\r\n}\r\nif (rdev->bios[0] != 0x55 || rdev->bios[1] != 0xaa) {\r\nprintk("BIOS signature incorrect %x %x\n", rdev->bios[0], rdev->bios[1]);\r\ngoto free_bios;\r\n}\r\ntmp = RBIOS16(0x18);\r\nif (RBIOS8(tmp + 0x14) != 0x0) {\r\nDRM_INFO("Not an x86 BIOS ROM, not using.\n");\r\ngoto free_bios;\r\n}\r\nrdev->bios_header_start = RBIOS16(0x48);\r\nif (!rdev->bios_header_start) {\r\ngoto free_bios;\r\n}\r\ntmp = rdev->bios_header_start + 4;\r\nif (!memcmp(rdev->bios + tmp, "ATOM", 4) ||\r\n!memcmp(rdev->bios + tmp, "MOTA", 4)) {\r\nrdev->is_atom_bios = true;\r\n} else {\r\nrdev->is_atom_bios = false;\r\n}\r\nDRM_DEBUG("%sBIOS detected\n", rdev->is_atom_bios ? "ATOM" : "COM");\r\nreturn true;\r\nfree_bios:\r\nkfree(rdev->bios);\r\nrdev->bios = NULL;\r\nreturn false;\r\n}

static int tuntap_user_init(void *data, void *dev)\r\n{\r\nstruct tuntap_data *pri = data;\r\npri->dev = dev;\r\nreturn 0;\r\n}\r\nstatic void tuntap_add_addr(unsigned char *addr, unsigned char *netmask,\r\nvoid *data)\r\n{\r\nstruct tuntap_data *pri = data;\r\ntap_check_ips(pri->gate_addr, addr);\r\nif ((pri->fd == -1) || pri->fixed_config)\r\nreturn;\r\nopen_addr(addr, netmask, pri->dev_name);\r\n}\r\nstatic void tuntap_del_addr(unsigned char *addr, unsigned char *netmask,\r\nvoid *data)\r\n{\r\nstruct tuntap_data *pri = data;\r\nif ((pri->fd == -1) || pri->fixed_config)\r\nreturn;\r\nclose_addr(addr, netmask, pri->dev_name);\r\n}\r\nstatic void tuntap_pre_exec(void *arg)\r\n{\r\nstruct tuntap_pre_exec_data *data = arg;\r\ndup2(data->stdout, 1);\r\nclose(data->close_me);\r\n}\r\nstatic int tuntap_open_tramp(char *gate, int *fd_out, int me, int remote,\r\nchar *buffer, int buffer_len, int *used_out)\r\n{\r\nstruct tuntap_pre_exec_data data;\r\nchar version_buf[sizeof("nnnnn\0")];\r\nchar *argv[] = { "uml_net", version_buf, "tuntap", "up", gate,\r\nNULL };\r\nchar buf[CMSG_SPACE(sizeof(*fd_out))];\r\nstruct msghdr msg;\r\nstruct cmsghdr *cmsg;\r\nstruct iovec iov;\r\nint pid, n, err;\r\nsprintf(version_buf, "%d", UML_NET_VERSION);\r\ndata.stdout = remote;\r\ndata.close_me = me;\r\npid = run_helper(tuntap_pre_exec, &data, argv);\r\nif (pid < 0)\r\nreturn -pid;\r\nclose(remote);\r\nmsg.msg_name = NULL;\r\nmsg.msg_namelen = 0;\r\nif (buffer != NULL) {\r\niov = ((struct iovec) { buffer, buffer_len });\r\nmsg.msg_iov = &iov;\r\nmsg.msg_iovlen = 1;\r\n}\r\nelse {\r\nmsg.msg_iov = NULL;\r\nmsg.msg_iovlen = 0;\r\n}\r\nmsg.msg_control = buf;\r\nmsg.msg_controllen = sizeof(buf);\r\nmsg.msg_flags = 0;\r\nn = recvmsg(me, &msg, 0);\r\n*used_out = n;\r\nif (n < 0) {\r\nerr = -errno;\r\nprintk(UM_KERN_ERR "tuntap_open_tramp : recvmsg failed - "\r\n"errno = %d\n", errno);\r\nreturn err;\r\n}\r\nhelper_wait(pid);\r\ncmsg = CMSG_FIRSTHDR(&msg);\r\nif (cmsg == NULL) {\r\nprintk(UM_KERN_ERR "tuntap_open_tramp : didn't receive a "\r\n"message\n");\r\nreturn -EINVAL;\r\n}\r\nif ((cmsg->cmsg_level != SOL_SOCKET) ||\r\n(cmsg->cmsg_type != SCM_RIGHTS)) {\r\nprintk(UM_KERN_ERR "tuntap_open_tramp : didn't receive a "\r\n"descriptor\n");\r\nreturn -EINVAL;\r\n}\r\n*fd_out = ((int *) CMSG_DATA(cmsg))[0];\r\nos_set_exec_close(*fd_out);\r\nreturn 0;\r\n}\r\nstatic int tuntap_open(void *data)\r\n{\r\nstruct ifreq ifr;\r\nstruct tuntap_data *pri = data;\r\nchar *output, *buffer;\r\nint err, fds[2], len, used;\r\nerr = tap_open_common(pri->dev, pri->gate_addr);\r\nif (err < 0)\r\nreturn err;\r\nif (pri->fixed_config) {\r\npri->fd = os_open_file("/dev/net/tun",\r\nof_cloexec(of_rdwr(OPENFLAGS())), 0);\r\nif (pri->fd < 0) {\r\nprintk(UM_KERN_ERR "Failed to open /dev/net/tun, "\r\n"err = %d\n", -pri->fd);\r\nreturn pri->fd;\r\n}\r\nmemset(&ifr, 0, sizeof(ifr));\r\nifr.ifr_flags = IFF_TAP | IFF_NO_PI;\r\nstrlcpy(ifr.ifr_name, pri->dev_name, sizeof(ifr.ifr_name));\r\nif (ioctl(pri->fd, TUNSETIFF, &ifr) < 0) {\r\nerr = -errno;\r\nprintk(UM_KERN_ERR "TUNSETIFF failed, errno = %d\n",\r\nerrno);\r\nclose(pri->fd);\r\nreturn err;\r\n}\r\n}\r\nelse {\r\nerr = socketpair(AF_UNIX, SOCK_DGRAM, 0, fds);\r\nif (err) {\r\nerr = -errno;\r\nprintk(UM_KERN_ERR "tuntap_open : socketpair failed - "\r\n"errno = %d\n", errno);\r\nreturn err;\r\n}\r\nbuffer = get_output_buffer(&len);\r\nif (buffer != NULL)\r\nlen--;\r\nused = 0;\r\nerr = tuntap_open_tramp(pri->gate_addr, &pri->fd, fds[0],\r\nfds[1], buffer, len, &used);\r\noutput = buffer;\r\nif (err < 0) {\r\nprintk("%s", output);\r\nfree_output_buffer(buffer);\r\nprintk(UM_KERN_ERR "tuntap_open_tramp failed - "\r\n"err = %d\n", -err);\r\nreturn err;\r\n}\r\npri->dev_name = uml_strdup(buffer);\r\noutput += IFNAMSIZ;\r\nprintk("%s", output);\r\nfree_output_buffer(buffer);\r\nclose(fds[0]);\r\niter_addresses(pri->dev, open_addr, pri->dev_name);\r\n}\r\nreturn pri->fd;\r\n}\r\nstatic void tuntap_close(int fd, void *data)\r\n{\r\nstruct tuntap_data *pri = data;\r\nif (!pri->fixed_config)\r\niter_addresses(pri->dev, close_addr, pri->dev_name);\r\nclose(fd);\r\npri->fd = -1;\r\n}

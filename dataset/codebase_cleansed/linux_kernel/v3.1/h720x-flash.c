static int __init h720x_mtd_init(void)\r\n{\r\nchar *part_type = NULL;\r\nh720x_map.virt = ioremap(h720x_map.phys, h720x_map.size);\r\nif (!h720x_map.virt) {\r\nprintk(KERN_ERR "H720x-MTD: ioremap failed\n");\r\nreturn -EIO;\r\n}\r\nsimple_map_init(&h720x_map);\r\nprintk (KERN_INFO "H720x-MTD probing 32bit FLASH\n");\r\nmymtd = do_map_probe("cfi_probe", &h720x_map);\r\nif (!mymtd) {\r\nprintk (KERN_INFO "H720x-MTD probing 16bit FLASH\n");\r\nh720x_map.bankwidth = 2;\r\nmymtd = do_map_probe("cfi_probe", &h720x_map);\r\n}\r\nif (mymtd) {\r\nmymtd->owner = THIS_MODULE;\r\nnr_mtd_parts = parse_mtd_partitions(mymtd, probes, &mtd_parts, 0);\r\nif (nr_mtd_parts > 0)\r\npart_type = "command line";\r\nif (nr_mtd_parts <= 0) {\r\nmtd_parts = h720x_partitions;\r\nnr_mtd_parts = NUM_PARTITIONS;\r\npart_type = "builtin";\r\n}\r\nprintk(KERN_INFO "Using %s partition table\n", part_type);\r\nmtd_device_register(mymtd, mtd_parts, nr_mtd_parts);\r\nreturn 0;\r\n}\r\niounmap((void *)h720x_map.virt);\r\nreturn -ENXIO;\r\n}\r\nstatic void __exit h720x_mtd_cleanup(void)\r\n{\r\nif (mymtd) {\r\nmtd_device_unregister(mymtd);\r\nmap_destroy(mymtd);\r\n}\r\nif (mtd_parts && (mtd_parts != h720x_partitions))\r\nkfree (mtd_parts);\r\nif (h720x_map.virt) {\r\niounmap((void *)h720x_map.virt);\r\nh720x_map.virt = 0;\r\n}\r\n}

int\r\nxfs_swapext(\r\nxfs_swapext_t *sxp)\r\n{\r\nxfs_inode_t *ip, *tip;\r\nstruct file *file, *tmp_file;\r\nint error = 0;\r\nfile = fget((int)sxp->sx_fdtarget);\r\nif (!file) {\r\nerror = XFS_ERROR(EINVAL);\r\ngoto out;\r\n}\r\nif (!(file->f_mode & FMODE_WRITE) ||\r\n!(file->f_mode & FMODE_READ) ||\r\n(file->f_flags & O_APPEND)) {\r\nerror = XFS_ERROR(EBADF);\r\ngoto out_put_file;\r\n}\r\ntmp_file = fget((int)sxp->sx_fdtmp);\r\nif (!tmp_file) {\r\nerror = XFS_ERROR(EINVAL);\r\ngoto out_put_file;\r\n}\r\nif (!(tmp_file->f_mode & FMODE_WRITE) ||\r\n!(tmp_file->f_mode & FMODE_READ) ||\r\n(tmp_file->f_flags & O_APPEND)) {\r\nerror = XFS_ERROR(EBADF);\r\ngoto out_put_tmp_file;\r\n}\r\nif (IS_SWAPFILE(file->f_path.dentry->d_inode) ||\r\nIS_SWAPFILE(tmp_file->f_path.dentry->d_inode)) {\r\nerror = XFS_ERROR(EINVAL);\r\ngoto out_put_tmp_file;\r\n}\r\nip = XFS_I(file->f_path.dentry->d_inode);\r\ntip = XFS_I(tmp_file->f_path.dentry->d_inode);\r\nif (ip->i_mount != tip->i_mount) {\r\nerror = XFS_ERROR(EINVAL);\r\ngoto out_put_tmp_file;\r\n}\r\nif (ip->i_ino == tip->i_ino) {\r\nerror = XFS_ERROR(EINVAL);\r\ngoto out_put_tmp_file;\r\n}\r\nif (XFS_FORCED_SHUTDOWN(ip->i_mount)) {\r\nerror = XFS_ERROR(EIO);\r\ngoto out_put_tmp_file;\r\n}\r\nerror = xfs_swap_extents(ip, tip, sxp);\r\nout_put_tmp_file:\r\nfput(tmp_file);\r\nout_put_file:\r\nfput(file);\r\nout:\r\nreturn error;\r\n}\r\nstatic int\r\nxfs_swap_extents_check_format(\r\nxfs_inode_t *ip,\r\nxfs_inode_t *tip)\r\n{\r\nif (ip->i_d.di_format == XFS_DINODE_FMT_LOCAL ||\r\ntip->i_d.di_format == XFS_DINODE_FMT_LOCAL)\r\nreturn EINVAL;\r\nif (ip->i_d.di_nextents < tip->i_d.di_nextents)\r\nreturn EINVAL;\r\nif (ip->i_d.di_format == XFS_DINODE_FMT_EXTENTS &&\r\ntip->i_d.di_format == XFS_DINODE_FMT_BTREE)\r\nreturn EINVAL;\r\nif (tip->i_d.di_format == XFS_DINODE_FMT_EXTENTS &&\r\nXFS_IFORK_NEXTENTS(tip, XFS_DATA_FORK) > ip->i_df.if_ext_max)\r\nreturn EINVAL;\r\nif (ip->i_d.di_format == XFS_DINODE_FMT_EXTENTS &&\r\nXFS_IFORK_NEXTENTS(ip, XFS_DATA_FORK) > tip->i_df.if_ext_max)\r\nreturn EINVAL;\r\nif (tip->i_d.di_format == XFS_DINODE_FMT_BTREE &&\r\n((XFS_IFORK_BOFF(ip) &&\r\ntip->i_df.if_broot_bytes > XFS_IFORK_BOFF(ip)) ||\r\nXFS_IFORK_NEXTENTS(tip, XFS_DATA_FORK) <= ip->i_df.if_ext_max))\r\nreturn EINVAL;\r\nif (ip->i_d.di_format == XFS_DINODE_FMT_BTREE &&\r\n((XFS_IFORK_BOFF(tip) &&\r\nip->i_df.if_broot_bytes > XFS_IFORK_BOFF(tip)) ||\r\nXFS_IFORK_NEXTENTS(ip, XFS_DATA_FORK) <= tip->i_df.if_ext_max))\r\nreturn EINVAL;\r\nreturn 0;\r\n}\r\nstatic int\r\nxfs_swap_extents(\r\nxfs_inode_t *ip,\r\nxfs_inode_t *tip,\r\nxfs_swapext_t *sxp)\r\n{\r\nxfs_mount_t *mp = ip->i_mount;\r\nxfs_trans_t *tp;\r\nxfs_bstat_t *sbp = &sxp->sx_stat;\r\nxfs_ifork_t *tempifp, *ifp, *tifp;\r\nint ilf_fields, tilf_fields;\r\nint error = 0;\r\nint aforkblks = 0;\r\nint taforkblks = 0;\r\n__uint64_t tmp;\r\ntempifp = kmem_alloc(sizeof(xfs_ifork_t), KM_MAYFAIL);\r\nif (!tempifp) {\r\nerror = XFS_ERROR(ENOMEM);\r\ngoto out;\r\n}\r\nxfs_lock_two_inodes(ip, tip, XFS_IOLOCK_EXCL);\r\nxfs_lock_two_inodes(ip, tip, XFS_ILOCK_EXCL);\r\nif ((ip->i_d.di_mode & S_IFMT) != (tip->i_d.di_mode & S_IFMT)) {\r\nerror = XFS_ERROR(EINVAL);\r\ngoto out_unlock;\r\n}\r\nif (XFS_IS_REALTIME_INODE(ip) != XFS_IS_REALTIME_INODE(tip)) {\r\nerror = XFS_ERROR(EINVAL);\r\ngoto out_unlock;\r\n}\r\nif (VN_CACHED(VFS_I(tip)) != 0) {\r\nerror = xfs_flushinval_pages(tip, 0, -1,\r\nFI_REMAPF_LOCKED);\r\nif (error)\r\ngoto out_unlock;\r\n}\r\nif (VN_CACHED(VFS_I(tip)) != 0) {\r\nerror = XFS_ERROR(EINVAL);\r\ngoto out_unlock;\r\n}\r\nif (sxp->sx_offset != 0 ||\r\nsxp->sx_length != ip->i_d.di_size ||\r\nsxp->sx_length != tip->i_d.di_size) {\r\nerror = XFS_ERROR(EFAULT);\r\ngoto out_unlock;\r\n}\r\ntrace_xfs_swap_extent_before(ip, 0);\r\ntrace_xfs_swap_extent_before(tip, 1);\r\nerror = xfs_swap_extents_check_format(ip, tip);\r\nif (error) {\r\nxfs_notice(mp,\r\n"%s: inode 0x%llx format is incompatible for exchanging.",\r\n__func__, ip->i_ino);\r\ngoto out_unlock;\r\n}\r\nif ((sbp->bs_ctime.tv_sec != VFS_I(ip)->i_ctime.tv_sec) ||\r\n(sbp->bs_ctime.tv_nsec != VFS_I(ip)->i_ctime.tv_nsec) ||\r\n(sbp->bs_mtime.tv_sec != VFS_I(ip)->i_mtime.tv_sec) ||\r\n(sbp->bs_mtime.tv_nsec != VFS_I(ip)->i_mtime.tv_nsec)) {\r\nerror = XFS_ERROR(EBUSY);\r\ngoto out_unlock;\r\n}\r\nif (VN_MAPPED(VFS_I(ip))) {\r\nerror = XFS_ERROR(EBUSY);\r\ngoto out_unlock;\r\n}\r\nxfs_iunlock(ip, XFS_ILOCK_EXCL);\r\nxfs_iunlock(tip, XFS_ILOCK_EXCL);\r\nxfs_tosspages(ip, 0, -1, FI_REMAPF);\r\ntp = xfs_trans_alloc(mp, XFS_TRANS_SWAPEXT);\r\nif ((error = xfs_trans_reserve(tp, 0,\r\nXFS_ICHANGE_LOG_RES(mp), 0,\r\n0, 0))) {\r\nxfs_iunlock(ip, XFS_IOLOCK_EXCL);\r\nxfs_iunlock(tip, XFS_IOLOCK_EXCL);\r\nxfs_trans_cancel(tp, 0);\r\ngoto out;\r\n}\r\nxfs_lock_two_inodes(ip, tip, XFS_ILOCK_EXCL);\r\nif ( ((XFS_IFORK_Q(ip) != 0) && (ip->i_d.di_anextents > 0)) &&\r\n(ip->i_d.di_aformat != XFS_DINODE_FMT_LOCAL)) {\r\nerror = xfs_bmap_count_blocks(tp, ip, XFS_ATTR_FORK, &aforkblks);\r\nif (error)\r\ngoto out_trans_cancel;\r\n}\r\nif ( ((XFS_IFORK_Q(tip) != 0) && (tip->i_d.di_anextents > 0)) &&\r\n(tip->i_d.di_aformat != XFS_DINODE_FMT_LOCAL)) {\r\nerror = xfs_bmap_count_blocks(tp, tip, XFS_ATTR_FORK,\r\n&taforkblks);\r\nif (error)\r\ngoto out_trans_cancel;\r\n}\r\nifp = &ip->i_df;\r\ntifp = &tip->i_df;\r\n*tempifp = *ifp;\r\n*ifp = *tifp;\r\n*tifp = *tempifp;\r\nifp->if_ext_max = XFS_IFORK_SIZE(ip, XFS_DATA_FORK) /\r\n(uint)sizeof(xfs_bmbt_rec_t);\r\ntifp->if_ext_max = XFS_IFORK_SIZE(tip, XFS_DATA_FORK) /\r\n(uint)sizeof(xfs_bmbt_rec_t);\r\ntmp = (__uint64_t)ip->i_d.di_nblocks;\r\nip->i_d.di_nblocks = tip->i_d.di_nblocks - taforkblks + aforkblks;\r\ntip->i_d.di_nblocks = tmp + taforkblks - aforkblks;\r\ntmp = (__uint64_t) ip->i_d.di_nextents;\r\nip->i_d.di_nextents = tip->i_d.di_nextents;\r\ntip->i_d.di_nextents = tmp;\r\ntmp = (__uint64_t) ip->i_d.di_format;\r\nip->i_d.di_format = tip->i_d.di_format;\r\ntip->i_d.di_format = tmp;\r\nASSERT(tip->i_delayed_blks == 0);\r\ntip->i_delayed_blks = ip->i_delayed_blks;\r\nip->i_delayed_blks = 0;\r\nilf_fields = XFS_ILOG_CORE;\r\nswitch(ip->i_d.di_format) {\r\ncase XFS_DINODE_FMT_EXTENTS:\r\nif (ip->i_d.di_nextents <= XFS_INLINE_EXTS) {\r\nifp->if_u1.if_extents =\r\nifp->if_u2.if_inline_ext;\r\n}\r\nilf_fields |= XFS_ILOG_DEXT;\r\nbreak;\r\ncase XFS_DINODE_FMT_BTREE:\r\nilf_fields |= XFS_ILOG_DBROOT;\r\nbreak;\r\n}\r\ntilf_fields = XFS_ILOG_CORE;\r\nswitch(tip->i_d.di_format) {\r\ncase XFS_DINODE_FMT_EXTENTS:\r\nif (tip->i_d.di_nextents <= XFS_INLINE_EXTS) {\r\ntifp->if_u1.if_extents =\r\ntifp->if_u2.if_inline_ext;\r\n}\r\ntilf_fields |= XFS_ILOG_DEXT;\r\nbreak;\r\ncase XFS_DINODE_FMT_BTREE:\r\ntilf_fields |= XFS_ILOG_DBROOT;\r\nbreak;\r\n}\r\nxfs_trans_ijoin_ref(tp, ip, XFS_ILOCK_EXCL | XFS_IOLOCK_EXCL);\r\nxfs_trans_ijoin_ref(tp, tip, XFS_ILOCK_EXCL | XFS_IOLOCK_EXCL);\r\nxfs_trans_log_inode(tp, ip, ilf_fields);\r\nxfs_trans_log_inode(tp, tip, tilf_fields);\r\nif (mp->m_flags & XFS_MOUNT_WSYNC)\r\nxfs_trans_set_sync(tp);\r\nerror = xfs_trans_commit(tp, XFS_TRANS_SWAPEXT);\r\ntrace_xfs_swap_extent_after(ip, 0);\r\ntrace_xfs_swap_extent_after(tip, 1);\r\nout:\r\nkmem_free(tempifp);\r\nreturn error;\r\nout_unlock:\r\nxfs_iunlock(ip, XFS_ILOCK_EXCL | XFS_IOLOCK_EXCL);\r\nxfs_iunlock(tip, XFS_ILOCK_EXCL | XFS_IOLOCK_EXCL);\r\ngoto out;\r\nout_trans_cancel:\r\nxfs_trans_cancel(tp, 0);\r\ngoto out_unlock;\r\n}

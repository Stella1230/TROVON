static inline struct platform_lcd *to_our_lcd(struct lcd_device *lcd)\r\n{\r\nreturn lcd_get_data(lcd);\r\n}\r\nstatic int platform_lcd_get_power(struct lcd_device *lcd)\r\n{\r\nstruct platform_lcd *plcd = to_our_lcd(lcd);\r\nreturn plcd->power;\r\n}\r\nstatic int platform_lcd_set_power(struct lcd_device *lcd, int power)\r\n{\r\nstruct platform_lcd *plcd = to_our_lcd(lcd);\r\nint lcd_power = 1;\r\nif (power == FB_BLANK_POWERDOWN || plcd->suspended)\r\nlcd_power = 0;\r\nplcd->pdata->set_power(plcd->pdata, lcd_power);\r\nplcd->power = power;\r\nreturn 0;\r\n}\r\nstatic int platform_lcd_match(struct lcd_device *lcd, struct fb_info *info)\r\n{\r\nstruct platform_lcd *plcd = to_our_lcd(lcd);\r\nstruct plat_lcd_data *pdata = plcd->pdata;\r\nif (pdata->match_fb)\r\nreturn pdata->match_fb(pdata, info);\r\nreturn plcd->us->parent == info->device;\r\n}\r\nstatic int __devinit platform_lcd_probe(struct platform_device *pdev)\r\n{\r\nstruct plat_lcd_data *pdata;\r\nstruct platform_lcd *plcd;\r\nstruct device *dev = &pdev->dev;\r\nint err;\r\npdata = pdev->dev.platform_data;\r\nif (!pdata) {\r\ndev_err(dev, "no platform data supplied\n");\r\nreturn -EINVAL;\r\n}\r\nplcd = kzalloc(sizeof(struct platform_lcd), GFP_KERNEL);\r\nif (!plcd) {\r\ndev_err(dev, "no memory for state\n");\r\nreturn -ENOMEM;\r\n}\r\nplcd->us = dev;\r\nplcd->pdata = pdata;\r\nplcd->lcd = lcd_device_register(dev_name(dev), dev,\r\nplcd, &platform_lcd_ops);\r\nif (IS_ERR(plcd->lcd)) {\r\ndev_err(dev, "cannot register lcd device\n");\r\nerr = PTR_ERR(plcd->lcd);\r\ngoto err_mem;\r\n}\r\nplatform_set_drvdata(pdev, plcd);\r\nplatform_lcd_set_power(plcd->lcd, FB_BLANK_NORMAL);\r\nreturn 0;\r\nerr_mem:\r\nkfree(plcd);\r\nreturn err;\r\n}\r\nstatic int __devexit platform_lcd_remove(struct platform_device *pdev)\r\n{\r\nstruct platform_lcd *plcd = platform_get_drvdata(pdev);\r\nlcd_device_unregister(plcd->lcd);\r\nkfree(plcd);\r\nreturn 0;\r\n}\r\nstatic int platform_lcd_suspend(struct platform_device *pdev, pm_message_t st)\r\n{\r\nstruct platform_lcd *plcd = platform_get_drvdata(pdev);\r\nplcd->suspended = 1;\r\nplatform_lcd_set_power(plcd->lcd, plcd->power);\r\nreturn 0;\r\n}\r\nstatic int platform_lcd_resume(struct platform_device *pdev)\r\n{\r\nstruct platform_lcd *plcd = platform_get_drvdata(pdev);\r\nplcd->suspended = 0;\r\nplatform_lcd_set_power(plcd->lcd, plcd->power);\r\nreturn 0;\r\n}\r\nstatic int __init platform_lcd_init(void)\r\n{\r\nreturn platform_driver_register(&platform_lcd_driver);\r\n}\r\nstatic void __exit platform_lcd_cleanup(void)\r\n{\r\nplatform_driver_unregister(&platform_lcd_driver);\r\n}

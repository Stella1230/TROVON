static u64 zram_stat64_read(struct zram *zram, u64 *v)\r\n{\r\nu64 val;\r\nspin_lock(&zram->stat64_lock);\r\nval = *v;\r\nspin_unlock(&zram->stat64_lock);\r\nreturn val;\r\n}\r\nstatic struct zram *dev_to_zram(struct device *dev)\r\n{\r\nint i;\r\nstruct zram *zram = NULL;\r\nfor (i = 0; i < num_devices; i++) {\r\nzram = &devices[i];\r\nif (disk_to_dev(zram->disk) == dev)\r\nbreak;\r\n}\r\nreturn zram;\r\n}\r\nstatic ssize_t disksize_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct zram *zram = dev_to_zram(dev);\r\nreturn sprintf(buf, "%llu\n", zram->disksize);\r\n}\r\nstatic ssize_t disksize_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t len)\r\n{\r\nint ret;\r\nstruct zram *zram = dev_to_zram(dev);\r\nif (zram->init_done) {\r\npr_info("Cannot change disksize for initialized device\n");\r\nreturn -EBUSY;\r\n}\r\nret = strict_strtoull(buf, 10, &zram->disksize);\r\nif (ret)\r\nreturn ret;\r\nzram->disksize = PAGE_ALIGN(zram->disksize);\r\nset_capacity(zram->disk, zram->disksize >> SECTOR_SHIFT);\r\nreturn len;\r\n}\r\nstatic ssize_t initstate_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct zram *zram = dev_to_zram(dev);\r\nreturn sprintf(buf, "%u\n", zram->init_done);\r\n}\r\nstatic ssize_t reset_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t len)\r\n{\r\nint ret;\r\nunsigned long do_reset;\r\nstruct zram *zram;\r\nstruct block_device *bdev;\r\nzram = dev_to_zram(dev);\r\nbdev = bdget_disk(zram->disk, 0);\r\nif (bdev->bd_holders)\r\nreturn -EBUSY;\r\nret = strict_strtoul(buf, 10, &do_reset);\r\nif (ret)\r\nreturn ret;\r\nif (!do_reset)\r\nreturn -EINVAL;\r\nif (bdev)\r\nfsync_bdev(bdev);\r\nif (zram->init_done)\r\nzram_reset_device(zram);\r\nreturn len;\r\n}\r\nstatic ssize_t num_reads_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct zram *zram = dev_to_zram(dev);\r\nreturn sprintf(buf, "%llu\n",\r\nzram_stat64_read(zram, &zram->stats.num_reads));\r\n}\r\nstatic ssize_t num_writes_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct zram *zram = dev_to_zram(dev);\r\nreturn sprintf(buf, "%llu\n",\r\nzram_stat64_read(zram, &zram->stats.num_writes));\r\n}\r\nstatic ssize_t invalid_io_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct zram *zram = dev_to_zram(dev);\r\nreturn sprintf(buf, "%llu\n",\r\nzram_stat64_read(zram, &zram->stats.invalid_io));\r\n}\r\nstatic ssize_t notify_free_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct zram *zram = dev_to_zram(dev);\r\nreturn sprintf(buf, "%llu\n",\r\nzram_stat64_read(zram, &zram->stats.notify_free));\r\n}\r\nstatic ssize_t zero_pages_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct zram *zram = dev_to_zram(dev);\r\nreturn sprintf(buf, "%u\n", zram->stats.pages_zero);\r\n}\r\nstatic ssize_t orig_data_size_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct zram *zram = dev_to_zram(dev);\r\nreturn sprintf(buf, "%llu\n",\r\n(u64)(zram->stats.pages_stored) << PAGE_SHIFT);\r\n}\r\nstatic ssize_t compr_data_size_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct zram *zram = dev_to_zram(dev);\r\nreturn sprintf(buf, "%llu\n",\r\nzram_stat64_read(zram, &zram->stats.compr_size));\r\n}\r\nstatic ssize_t mem_used_total_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nu64 val = 0;\r\nstruct zram *zram = dev_to_zram(dev);\r\nif (zram->init_done) {\r\nval = xv_get_total_size_bytes(zram->mem_pool) +\r\n((u64)(zram->stats.pages_expand) << PAGE_SHIFT);\r\n}\r\nreturn sprintf(buf, "%llu\n", val);\r\n}

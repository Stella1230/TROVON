static int __devinit snd_cs423x_pnp_init_wss(int dev, struct pnp_dev *pdev)\r\n{\r\nif (pnp_activate_dev(pdev) < 0) {\r\nprintk(KERN_ERR IDENT " WSS PnP configure failed for WSS (out of resources?)\n");\r\nreturn -EBUSY;\r\n}\r\nport[dev] = pnp_port_start(pdev, 0);\r\nif (fm_port[dev] > 0)\r\nfm_port[dev] = pnp_port_start(pdev, 1);\r\nsb_port[dev] = pnp_port_start(pdev, 2);\r\nirq[dev] = pnp_irq(pdev, 0);\r\ndma1[dev] = pnp_dma(pdev, 0);\r\ndma2[dev] = pnp_dma(pdev, 1) == 4 ? -1 : (int)pnp_dma(pdev, 1);\r\nsnd_printdd("isapnp WSS: wss port=0x%lx, fm port=0x%lx, sb port=0x%lx\n",\r\nport[dev], fm_port[dev], sb_port[dev]);\r\nsnd_printdd("isapnp WSS: irq=%i, dma1=%i, dma2=%i\n",\r\nirq[dev], dma1[dev], dma2[dev]);\r\nreturn 0;\r\n}\r\nstatic int __devinit snd_cs423x_pnp_init_ctrl(int dev, struct pnp_dev *pdev)\r\n{\r\nif (pnp_activate_dev(pdev) < 0) {\r\nprintk(KERN_ERR IDENT " CTRL PnP configure failed for WSS (out of resources?)\n");\r\nreturn -EBUSY;\r\n}\r\ncport[dev] = pnp_port_start(pdev, 0);\r\nsnd_printdd("isapnp CTRL: control port=0x%lx\n", cport[dev]);\r\nreturn 0;\r\n}\r\nstatic int __devinit snd_cs423x_pnp_init_mpu(int dev, struct pnp_dev *pdev)\r\n{\r\nif (pnp_activate_dev(pdev) < 0) {\r\nprintk(KERN_ERR IDENT " MPU401 PnP configure failed for WSS (out of resources?)\n");\r\nmpu_port[dev] = SNDRV_AUTO_PORT;\r\nmpu_irq[dev] = SNDRV_AUTO_IRQ;\r\n} else {\r\nmpu_port[dev] = pnp_port_start(pdev, 0);\r\nif (mpu_irq[dev] >= 0 &&\r\npnp_irq_valid(pdev, 0) && pnp_irq(pdev, 0) >= 0) {\r\nmpu_irq[dev] = pnp_irq(pdev, 0);\r\n} else {\r\nmpu_irq[dev] = -1;\r\n}\r\n}\r\nsnd_printdd("isapnp MPU: port=0x%lx, irq=%i\n", mpu_port[dev], mpu_irq[dev]);\r\nreturn 0;\r\n}\r\nstatic int __devinit snd_card_cs423x_pnp(int dev, struct snd_card_cs4236 *acard,\r\nstruct pnp_dev *pdev,\r\nstruct pnp_dev *cdev)\r\n{\r\nacard->wss = pdev;\r\nif (snd_cs423x_pnp_init_wss(dev, acard->wss) < 0)\r\nreturn -EBUSY;\r\nif (cdev)\r\ncport[dev] = pnp_port_start(cdev, 0);\r\nelse\r\ncport[dev] = -1;\r\nreturn 0;\r\n}\r\nstatic int __devinit snd_card_cs423x_pnpc(int dev, struct snd_card_cs4236 *acard,\r\nstruct pnp_card_link *card,\r\nconst struct pnp_card_device_id *id)\r\n{\r\nacard->wss = pnp_request_card_device(card, id->devs[0].id, NULL);\r\nif (acard->wss == NULL)\r\nreturn -EBUSY;\r\nacard->ctrl = pnp_request_card_device(card, id->devs[1].id, NULL);\r\nif (acard->ctrl == NULL)\r\nreturn -EBUSY;\r\nif (id->devs[2].id[0]) {\r\nacard->mpu = pnp_request_card_device(card, id->devs[2].id, NULL);\r\nif (acard->mpu == NULL)\r\nreturn -EBUSY;\r\n}\r\nif (snd_cs423x_pnp_init_wss(dev, acard->wss) < 0)\r\nreturn -EBUSY;\r\nif (acard->ctrl && cport[dev] > 0) {\r\nif (snd_cs423x_pnp_init_ctrl(dev, acard->ctrl) < 0)\r\nreturn -EBUSY;\r\n}\r\nif (acard->mpu && mpu_port[dev] > 0) {\r\nif (snd_cs423x_pnp_init_mpu(dev, acard->mpu) < 0)\r\nreturn -EBUSY;\r\n}\r\nreturn 0;\r\n}\r\nstatic void snd_card_cs4236_free(struct snd_card *card)\r\n{\r\nstruct snd_card_cs4236 *acard = card->private_data;\r\nrelease_and_free_resource(acard->res_sb_port);\r\n}\r\nstatic int snd_cs423x_card_new(int dev, struct snd_card **cardp)\r\n{\r\nstruct snd_card *card;\r\nint err;\r\nerr = snd_card_create(index[dev], id[dev], THIS_MODULE,\r\nsizeof(struct snd_card_cs4236), &card);\r\nif (err < 0)\r\nreturn err;\r\ncard->private_free = snd_card_cs4236_free;\r\n*cardp = card;\r\nreturn 0;\r\n}\r\nstatic int __devinit snd_cs423x_probe(struct snd_card *card, int dev)\r\n{\r\nstruct snd_card_cs4236 *acard;\r\nstruct snd_pcm *pcm;\r\nstruct snd_wss *chip;\r\nstruct snd_opl3 *opl3;\r\nint err;\r\nacard = card->private_data;\r\nif (sb_port[dev] > 0 && sb_port[dev] != SNDRV_AUTO_PORT)\r\nif ((acard->res_sb_port = request_region(sb_port[dev], 16, IDENT " SB")) == NULL) {\r\nprintk(KERN_ERR IDENT ": unable to register SB port at 0x%lx\n", sb_port[dev]);\r\nreturn -EBUSY;\r\n}\r\nerr = snd_cs4236_create(card, port[dev], cport[dev],\r\nirq[dev],\r\ndma1[dev], dma2[dev],\r\nWSS_HW_DETECT3, 0, &chip);\r\nif (err < 0)\r\nreturn err;\r\nacard->chip = chip;\r\nif (chip->hardware & WSS_HW_CS4236B_MASK) {\r\nerr = snd_cs4236_pcm(chip, 0, &pcm);\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_cs4236_mixer(chip);\r\nif (err < 0)\r\nreturn err;\r\n} else {\r\nerr = snd_wss_pcm(chip, 0, &pcm);\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_wss_mixer(chip);\r\nif (err < 0)\r\nreturn err;\r\n}\r\nstrcpy(card->driver, pcm->name);\r\nstrcpy(card->shortname, pcm->name);\r\nsprintf(card->longname, "%s at 0x%lx, irq %i, dma %i",\r\npcm->name,\r\nchip->port,\r\nirq[dev],\r\ndma1[dev]);\r\nif (dma2[dev] >= 0)\r\nsprintf(card->longname + strlen(card->longname), "&%d", dma2[dev]);\r\nerr = snd_wss_timer(chip, 0, NULL);\r\nif (err < 0)\r\nreturn err;\r\nif (fm_port[dev] > 0 && fm_port[dev] != SNDRV_AUTO_PORT) {\r\nif (snd_opl3_create(card,\r\nfm_port[dev], fm_port[dev] + 2,\r\nOPL3_HW_OPL3_CS, 0, &opl3) < 0) {\r\nprintk(KERN_WARNING IDENT ": OPL3 not detected\n");\r\n} else {\r\nif ((err = snd_opl3_hwdep_new(opl3, 0, 1, NULL)) < 0)\r\nreturn err;\r\n}\r\n}\r\nif (mpu_port[dev] > 0 && mpu_port[dev] != SNDRV_AUTO_PORT) {\r\nif (mpu_irq[dev] == SNDRV_AUTO_IRQ)\r\nmpu_irq[dev] = -1;\r\nif (snd_mpu401_uart_new(card, 0, MPU401_HW_CS4232,\r\nmpu_port[dev], 0,\r\nmpu_irq[dev],\r\nmpu_irq[dev] >= 0 ? IRQF_DISABLED : 0, NULL) < 0)\r\nprintk(KERN_WARNING IDENT ": MPU401 not detected\n");\r\n}\r\nreturn snd_card_register(card);\r\n}\r\nstatic int __devinit snd_cs423x_isa_match(struct device *pdev,\r\nunsigned int dev)\r\n{\r\nif (!enable[dev] || is_isapnp_selected(dev))\r\nreturn 0;\r\nif (port[dev] == SNDRV_AUTO_PORT) {\r\ndev_err(pdev, "please specify port\n");\r\nreturn 0;\r\n}\r\nif (cport[dev] == SNDRV_AUTO_PORT) {\r\ndev_err(pdev, "please specify cport\n");\r\nreturn 0;\r\n}\r\nif (irq[dev] == SNDRV_AUTO_IRQ) {\r\ndev_err(pdev, "please specify irq\n");\r\nreturn 0;\r\n}\r\nif (dma1[dev] == SNDRV_AUTO_DMA) {\r\ndev_err(pdev, "please specify dma1\n");\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int __devinit snd_cs423x_isa_probe(struct device *pdev,\r\nunsigned int dev)\r\n{\r\nstruct snd_card *card;\r\nint err;\r\nerr = snd_cs423x_card_new(dev, &card);\r\nif (err < 0)\r\nreturn err;\r\nsnd_card_set_dev(card, pdev);\r\nif ((err = snd_cs423x_probe(card, dev)) < 0) {\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\ndev_set_drvdata(pdev, card);\r\nreturn 0;\r\n}\r\nstatic int __devexit snd_cs423x_isa_remove(struct device *pdev,\r\nunsigned int dev)\r\n{\r\nsnd_card_free(dev_get_drvdata(pdev));\r\ndev_set_drvdata(pdev, NULL);\r\nreturn 0;\r\n}\r\nstatic int snd_cs423x_suspend(struct snd_card *card)\r\n{\r\nstruct snd_card_cs4236 *acard = card->private_data;\r\nsnd_power_change_state(card, SNDRV_CTL_POWER_D3hot);\r\nacard->chip->suspend(acard->chip);\r\nreturn 0;\r\n}\r\nstatic int snd_cs423x_resume(struct snd_card *card)\r\n{\r\nstruct snd_card_cs4236 *acard = card->private_data;\r\nacard->chip->resume(acard->chip);\r\nsnd_power_change_state(card, SNDRV_CTL_POWER_D0);\r\nreturn 0;\r\n}\r\nstatic int snd_cs423x_isa_suspend(struct device *dev, unsigned int n,\r\npm_message_t state)\r\n{\r\nreturn snd_cs423x_suspend(dev_get_drvdata(dev));\r\n}\r\nstatic int snd_cs423x_isa_resume(struct device *dev, unsigned int n)\r\n{\r\nreturn snd_cs423x_resume(dev_get_drvdata(dev));\r\n}\r\nstatic int __devinit snd_cs423x_pnpbios_detect(struct pnp_dev *pdev,\r\nconst struct pnp_device_id *id)\r\n{\r\nstatic int dev;\r\nint err;\r\nstruct snd_card *card;\r\nstruct pnp_dev *cdev;\r\nchar cid[PNP_ID_LEN];\r\nif (pnp_device_is_isapnp(pdev))\r\nreturn -ENOENT;\r\nfor (; dev < SNDRV_CARDS; dev++) {\r\nif (enable[dev] && isapnp[dev])\r\nbreak;\r\n}\r\nif (dev >= SNDRV_CARDS)\r\nreturn -ENODEV;\r\nstrcpy(cid, pdev->id[0].id);\r\ncid[5] = '1';\r\ncdev = NULL;\r\nlist_for_each_entry(cdev, &(pdev->protocol->devices), protocol_list) {\r\nif (!strcmp(cdev->id[0].id, cid))\r\nbreak;\r\n}\r\nerr = snd_cs423x_card_new(dev, &card);\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_card_cs423x_pnp(dev, card->private_data, pdev, cdev);\r\nif (err < 0) {\r\nprintk(KERN_ERR "PnP BIOS detection failed for " IDENT "\n");\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\nsnd_card_set_dev(card, &pdev->dev);\r\nif ((err = snd_cs423x_probe(card, dev)) < 0) {\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\npnp_set_drvdata(pdev, card);\r\ndev++;\r\nreturn 0;\r\n}\r\nstatic void __devexit snd_cs423x_pnp_remove(struct pnp_dev *pdev)\r\n{\r\nsnd_card_free(pnp_get_drvdata(pdev));\r\npnp_set_drvdata(pdev, NULL);\r\n}\r\nstatic int snd_cs423x_pnp_suspend(struct pnp_dev *pdev, pm_message_t state)\r\n{\r\nreturn snd_cs423x_suspend(pnp_get_drvdata(pdev));\r\n}\r\nstatic int snd_cs423x_pnp_resume(struct pnp_dev *pdev)\r\n{\r\nreturn snd_cs423x_resume(pnp_get_drvdata(pdev));\r\n}\r\nstatic int __devinit snd_cs423x_pnpc_detect(struct pnp_card_link *pcard,\r\nconst struct pnp_card_device_id *pid)\r\n{\r\nstatic int dev;\r\nstruct snd_card *card;\r\nint res;\r\nfor ( ; dev < SNDRV_CARDS; dev++) {\r\nif (enable[dev] && isapnp[dev])\r\nbreak;\r\n}\r\nif (dev >= SNDRV_CARDS)\r\nreturn -ENODEV;\r\nres = snd_cs423x_card_new(dev, &card);\r\nif (res < 0)\r\nreturn res;\r\nif ((res = snd_card_cs423x_pnpc(dev, card->private_data, pcard, pid)) < 0) {\r\nprintk(KERN_ERR "isapnp detection failed and probing for " IDENT\r\n" is not supported\n");\r\nsnd_card_free(card);\r\nreturn res;\r\n}\r\nsnd_card_set_dev(card, &pcard->card->dev);\r\nif ((res = snd_cs423x_probe(card, dev)) < 0) {\r\nsnd_card_free(card);\r\nreturn res;\r\n}\r\npnp_set_card_drvdata(pcard, card);\r\ndev++;\r\nreturn 0;\r\n}\r\nstatic void __devexit snd_cs423x_pnpc_remove(struct pnp_card_link * pcard)\r\n{\r\nsnd_card_free(pnp_get_card_drvdata(pcard));\r\npnp_set_card_drvdata(pcard, NULL);\r\n}\r\nstatic int snd_cs423x_pnpc_suspend(struct pnp_card_link *pcard, pm_message_t state)\r\n{\r\nreturn snd_cs423x_suspend(pnp_get_card_drvdata(pcard));\r\n}\r\nstatic int snd_cs423x_pnpc_resume(struct pnp_card_link *pcard)\r\n{\r\nreturn snd_cs423x_resume(pnp_get_card_drvdata(pcard));\r\n}\r\nstatic int __init alsa_card_cs423x_init(void)\r\n{\r\nint err;\r\nerr = isa_register_driver(&cs423x_isa_driver, SNDRV_CARDS);\r\n#ifdef CONFIG_PNP\r\nif (!err)\r\nisa_registered = 1;\r\nerr = pnp_register_driver(&cs423x_pnp_driver);\r\nif (!err)\r\npnp_registered = 1;\r\nerr = pnp_register_card_driver(&cs423x_pnpc_driver);\r\nif (!err)\r\npnpc_registered = 1;\r\nif (pnp_registered)\r\nerr = 0;\r\nif (isa_registered)\r\nerr = 0;\r\n#endif\r\nreturn err;\r\n}\r\nstatic void __exit alsa_card_cs423x_exit(void)\r\n{\r\n#ifdef CONFIG_PNP\r\nif (pnpc_registered)\r\npnp_unregister_card_driver(&cs423x_pnpc_driver);\r\nif (pnp_registered)\r\npnp_unregister_driver(&cs423x_pnp_driver);\r\nif (isa_registered)\r\n#endif\r\nisa_unregister_driver(&cs423x_isa_driver);\r\n}

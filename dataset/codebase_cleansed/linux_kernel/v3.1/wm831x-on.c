static void wm831x_poll_on(struct work_struct *work)\r\n{\r\nstruct wm831x_on *wm831x_on = container_of(work, struct wm831x_on,\r\nwork.work);\r\nstruct wm831x *wm831x = wm831x_on->wm831x;\r\nint poll, ret;\r\nret = wm831x_reg_read(wm831x, WM831X_ON_PIN_CONTROL);\r\nif (ret >= 0) {\r\npoll = !(ret & WM831X_ON_PIN_STS);\r\ninput_report_key(wm831x_on->dev, KEY_POWER, poll);\r\ninput_sync(wm831x_on->dev);\r\n} else {\r\ndev_err(wm831x->dev, "Failed to read ON status: %d\n", ret);\r\npoll = 1;\r\n}\r\nif (poll)\r\nschedule_delayed_work(&wm831x_on->work, 100);\r\n}\r\nstatic irqreturn_t wm831x_on_irq(int irq, void *data)\r\n{\r\nstruct wm831x_on *wm831x_on = data;\r\nschedule_delayed_work(&wm831x_on->work, 0);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __devinit wm831x_on_probe(struct platform_device *pdev)\r\n{\r\nstruct wm831x *wm831x = dev_get_drvdata(pdev->dev.parent);\r\nstruct wm831x_on *wm831x_on;\r\nint irq = platform_get_irq(pdev, 0);\r\nint ret;\r\nwm831x_on = kzalloc(sizeof(struct wm831x_on), GFP_KERNEL);\r\nif (!wm831x_on) {\r\ndev_err(&pdev->dev, "Can't allocate data\n");\r\nreturn -ENOMEM;\r\n}\r\nwm831x_on->wm831x = wm831x;\r\nINIT_DELAYED_WORK(&wm831x_on->work, wm831x_poll_on);\r\nwm831x_on->dev = input_allocate_device();\r\nif (!wm831x_on->dev) {\r\ndev_err(&pdev->dev, "Can't allocate input dev\n");\r\nret = -ENOMEM;\r\ngoto err;\r\n}\r\nwm831x_on->dev->evbit[0] = BIT_MASK(EV_KEY);\r\nwm831x_on->dev->keybit[BIT_WORD(KEY_POWER)] = BIT_MASK(KEY_POWER);\r\nwm831x_on->dev->name = "wm831x_on";\r\nwm831x_on->dev->phys = "wm831x_on/input0";\r\nwm831x_on->dev->dev.parent = &pdev->dev;\r\nret = request_threaded_irq(irq, NULL, wm831x_on_irq,\r\nIRQF_TRIGGER_RISING, "wm831x_on",\r\nwm831x_on);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Unable to request IRQ: %d\n", ret);\r\ngoto err_input_dev;\r\n}\r\nret = input_register_device(wm831x_on->dev);\r\nif (ret) {\r\ndev_dbg(&pdev->dev, "Can't register input device: %d\n", ret);\r\ngoto err_irq;\r\n}\r\nplatform_set_drvdata(pdev, wm831x_on);\r\nreturn 0;\r\nerr_irq:\r\nfree_irq(irq, wm831x_on);\r\nerr_input_dev:\r\ninput_free_device(wm831x_on->dev);\r\nerr:\r\nkfree(wm831x_on);\r\nreturn ret;\r\n}\r\nstatic int __devexit wm831x_on_remove(struct platform_device *pdev)\r\n{\r\nstruct wm831x_on *wm831x_on = platform_get_drvdata(pdev);\r\nint irq = platform_get_irq(pdev, 0);\r\nfree_irq(irq, wm831x_on);\r\ncancel_delayed_work_sync(&wm831x_on->work);\r\ninput_unregister_device(wm831x_on->dev);\r\nkfree(wm831x_on);\r\nreturn 0;\r\n}\r\nstatic int __init wm831x_on_init(void)\r\n{\r\nreturn platform_driver_register(&wm831x_on_driver);\r\n}\r\nstatic void __exit wm831x_on_exit(void)\r\n{\r\nplatform_driver_unregister(&wm831x_on_driver);\r\n}

int prop_descriptor_init(struct prop_descriptor *pd, int shift)\r\n{\r\nint err;\r\nif (shift > PROP_MAX_SHIFT)\r\nshift = PROP_MAX_SHIFT;\r\npd->index = 0;\r\npd->pg[0].shift = shift;\r\nmutex_init(&pd->mutex);\r\nerr = percpu_counter_init(&pd->pg[0].events, 0);\r\nif (err)\r\ngoto out;\r\nerr = percpu_counter_init(&pd->pg[1].events, 0);\r\nif (err)\r\npercpu_counter_destroy(&pd->pg[0].events);\r\nout:\r\nreturn err;\r\n}\r\nvoid prop_change_shift(struct prop_descriptor *pd, int shift)\r\n{\r\nint index;\r\nint offset;\r\nu64 events;\r\nunsigned long flags;\r\nif (shift > PROP_MAX_SHIFT)\r\nshift = PROP_MAX_SHIFT;\r\nmutex_lock(&pd->mutex);\r\nindex = pd->index ^ 1;\r\noffset = pd->pg[pd->index].shift - shift;\r\nif (!offset)\r\ngoto out;\r\npd->pg[index].shift = shift;\r\nlocal_irq_save(flags);\r\nevents = percpu_counter_sum(&pd->pg[pd->index].events);\r\nif (offset < 0)\r\nevents <<= -offset;\r\nelse\r\nevents >>= offset;\r\npercpu_counter_set(&pd->pg[index].events, events);\r\nsmp_wmb();\r\npd->index = index;\r\nlocal_irq_restore(flags);\r\nsynchronize_rcu();\r\nout:\r\nmutex_unlock(&pd->mutex);\r\n}\r\nstatic struct prop_global *prop_get_global(struct prop_descriptor *pd)\r\n__acquires(RCU)\r\n{\r\nint index;\r\nrcu_read_lock();\r\nindex = pd->index;\r\nsmp_rmb();\r\nreturn &pd->pg[index];\r\n}\r\nstatic void prop_put_global(struct prop_descriptor *pd, struct prop_global *pg)\r\n__releases(RCU)\r\n{\r\nrcu_read_unlock();\r\n}\r\nstatic void\r\nprop_adjust_shift(int *pl_shift, unsigned long *pl_period, int new_shift)\r\n{\r\nint offset = *pl_shift - new_shift;\r\nif (!offset)\r\nreturn;\r\nif (offset < 0)\r\n*pl_period <<= -offset;\r\nelse\r\n*pl_period >>= offset;\r\n*pl_shift = new_shift;\r\n}\r\nint prop_local_init_percpu(struct prop_local_percpu *pl)\r\n{\r\nspin_lock_init(&pl->lock);\r\npl->shift = 0;\r\npl->period = 0;\r\nreturn percpu_counter_init(&pl->events, 0);\r\n}\r\nvoid prop_local_destroy_percpu(struct prop_local_percpu *pl)\r\n{\r\npercpu_counter_destroy(&pl->events);\r\n}\r\nstatic\r\nvoid prop_norm_percpu(struct prop_global *pg, struct prop_local_percpu *pl)\r\n{\r\nunsigned long period = 1UL << (pg->shift - 1);\r\nunsigned long period_mask = ~(period - 1);\r\nunsigned long global_period;\r\nunsigned long flags;\r\nglobal_period = percpu_counter_read(&pg->events);\r\nglobal_period &= period_mask;\r\nif (pl->period == global_period)\r\nreturn;\r\nspin_lock_irqsave(&pl->lock, flags);\r\nprop_adjust_shift(&pl->shift, &pl->period, pg->shift);\r\nperiod = (global_period - pl->period) >> (pg->shift - 1);\r\nif (period < BITS_PER_LONG) {\r\ns64 val = percpu_counter_read(&pl->events);\r\nif (val < (nr_cpu_ids * PROP_BATCH))\r\nval = percpu_counter_sum(&pl->events);\r\n__percpu_counter_add(&pl->events, -val + (val >> period),\r\nPROP_BATCH);\r\n} else\r\npercpu_counter_set(&pl->events, 0);\r\npl->period = global_period;\r\nspin_unlock_irqrestore(&pl->lock, flags);\r\n}\r\nvoid __prop_inc_percpu(struct prop_descriptor *pd, struct prop_local_percpu *pl)\r\n{\r\nstruct prop_global *pg = prop_get_global(pd);\r\nprop_norm_percpu(pg, pl);\r\n__percpu_counter_add(&pl->events, 1, PROP_BATCH);\r\npercpu_counter_add(&pg->events, 1);\r\nprop_put_global(pd, pg);\r\n}\r\nvoid __prop_inc_percpu_max(struct prop_descriptor *pd,\r\nstruct prop_local_percpu *pl, long frac)\r\n{\r\nstruct prop_global *pg = prop_get_global(pd);\r\nprop_norm_percpu(pg, pl);\r\nif (unlikely(frac != PROP_FRAC_BASE)) {\r\nunsigned long period_2 = 1UL << (pg->shift - 1);\r\nunsigned long counter_mask = period_2 - 1;\r\nunsigned long global_count;\r\nlong numerator, denominator;\r\nnumerator = percpu_counter_read_positive(&pl->events);\r\nglobal_count = percpu_counter_read(&pg->events);\r\ndenominator = period_2 + (global_count & counter_mask);\r\nif (numerator > ((denominator * frac) >> PROP_FRAC_SHIFT))\r\ngoto out_put;\r\n}\r\npercpu_counter_add(&pl->events, 1);\r\npercpu_counter_add(&pg->events, 1);\r\nout_put:\r\nprop_put_global(pd, pg);\r\n}\r\nvoid prop_fraction_percpu(struct prop_descriptor *pd,\r\nstruct prop_local_percpu *pl,\r\nlong *numerator, long *denominator)\r\n{\r\nstruct prop_global *pg = prop_get_global(pd);\r\nunsigned long period_2 = 1UL << (pg->shift - 1);\r\nunsigned long counter_mask = period_2 - 1;\r\nunsigned long global_count;\r\nprop_norm_percpu(pg, pl);\r\n*numerator = percpu_counter_read_positive(&pl->events);\r\nglobal_count = percpu_counter_read(&pg->events);\r\n*denominator = period_2 + (global_count & counter_mask);\r\nprop_put_global(pd, pg);\r\n}\r\nint prop_local_init_single(struct prop_local_single *pl)\r\n{\r\nspin_lock_init(&pl->lock);\r\npl->shift = 0;\r\npl->period = 0;\r\npl->events = 0;\r\nreturn 0;\r\n}\r\nvoid prop_local_destroy_single(struct prop_local_single *pl)\r\n{\r\n}\r\nstatic\r\nvoid prop_norm_single(struct prop_global *pg, struct prop_local_single *pl)\r\n{\r\nunsigned long period = 1UL << (pg->shift - 1);\r\nunsigned long period_mask = ~(period - 1);\r\nunsigned long global_period;\r\nunsigned long flags;\r\nglobal_period = percpu_counter_read(&pg->events);\r\nglobal_period &= period_mask;\r\nif (pl->period == global_period)\r\nreturn;\r\nspin_lock_irqsave(&pl->lock, flags);\r\nprop_adjust_shift(&pl->shift, &pl->period, pg->shift);\r\nperiod = (global_period - pl->period) >> (pg->shift - 1);\r\nif (likely(period < BITS_PER_LONG))\r\npl->events >>= period;\r\nelse\r\npl->events = 0;\r\npl->period = global_period;\r\nspin_unlock_irqrestore(&pl->lock, flags);\r\n}\r\nvoid __prop_inc_single(struct prop_descriptor *pd, struct prop_local_single *pl)\r\n{\r\nstruct prop_global *pg = prop_get_global(pd);\r\nprop_norm_single(pg, pl);\r\npl->events++;\r\npercpu_counter_add(&pg->events, 1);\r\nprop_put_global(pd, pg);\r\n}\r\nvoid prop_fraction_single(struct prop_descriptor *pd,\r\nstruct prop_local_single *pl,\r\nlong *numerator, long *denominator)\r\n{\r\nstruct prop_global *pg = prop_get_global(pd);\r\nunsigned long period_2 = 1UL << (pg->shift - 1);\r\nunsigned long counter_mask = period_2 - 1;\r\nunsigned long global_count;\r\nprop_norm_single(pg, pl);\r\n*numerator = pl->events;\r\nglobal_count = percpu_counter_read(&pg->events);\r\n*denominator = period_2 + (global_count & counter_mask);\r\nprop_put_global(pd, pg);\r\n}

static int __init driver_fl512_init_module(void)\r\n{\r\nreturn comedi_driver_register(&driver_fl512);\r\n}\r\nstatic void __exit driver_fl512_cleanup_module(void)\r\n{\r\ncomedi_driver_unregister(&driver_fl512);\r\n}\r\nstatic int fl512_ai_insn(struct comedi_device *dev,\r\nstruct comedi_subdevice *s, struct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nint n;\r\nunsigned int lo_byte, hi_byte;\r\nchar chan = CR_CHAN(insn->chanspec);\r\nunsigned long iobase = dev->iobase;\r\nfor (n = 0; n < insn->n; n++) {\r\noutb(chan, iobase + 2);\r\noutb(0, iobase + 3);\r\nudelay(30);\r\nlo_byte = inb(iobase + 2);\r\nhi_byte = inb(iobase + 3) & 0xf;\r\ndata[n] = lo_byte + (hi_byte << 8);\r\n}\r\nreturn n;\r\n}\r\nstatic int fl512_ao_insn(struct comedi_device *dev,\r\nstruct comedi_subdevice *s, struct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nint n;\r\nint chan = CR_CHAN(insn->chanspec);\r\nunsigned long iobase = dev->iobase;\r\nfor (n = 0; n < insn->n; n++) {\r\noutb(data[n] & 0x0ff, iobase + 4 + 2 * chan);\r\noutb((data[n] & 0xf00) >> 8, iobase + 4 + 2 * chan);\r\ninb(iobase + 4 + 2 * chan);\r\ndevpriv->ao_readback[chan] = data[n];\r\n}\r\nreturn n;\r\n}\r\nstatic int fl512_ao_insn_readback(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint n;\r\nint chan = CR_CHAN(insn->chanspec);\r\nfor (n = 0; n < insn->n; n++)\r\ndata[n] = devpriv->ao_readback[chan];\r\nreturn n;\r\n}\r\nstatic int fl512_attach(struct comedi_device *dev, struct comedi_devconfig *it)\r\n{\r\nunsigned long iobase;\r\nstruct comedi_subdevice *s;\r\niobase = it->options[0];\r\nprintk(KERN_INFO "comedi:%d fl512: 0x%04lx", dev->minor, iobase);\r\nif (!request_region(iobase, FL512_SIZE, "fl512")) {\r\nprintk(KERN_WARNING " I/O port conflict\n");\r\nreturn -EIO;\r\n}\r\ndev->iobase = iobase;\r\ndev->board_name = "fl512";\r\nif (alloc_private(dev, sizeof(struct fl512_private)) < 0)\r\nreturn -ENOMEM;\r\n#if DEBUG\r\nprintk(KERN_DEBUG "malloc ok\n");\r\n#endif\r\nif (alloc_subdevices(dev, 2) < 0)\r\nreturn -ENOMEM;\r\ns = dev->subdevices + 0;\r\ns->type = COMEDI_SUBD_AI;\r\ns->subdev_flags = SDF_READABLE | SDF_GROUND;\r\ns->n_chan = 16;\r\ns->maxdata = 0x0fff;\r\ns->range_table = &range_fl512;\r\ns->insn_read = fl512_ai_insn;\r\nprintk(KERN_INFO "comedi: fl512: subdevice 0 initialized\n");\r\ns = dev->subdevices + 1;\r\ns->type = COMEDI_SUBD_AO;\r\ns->subdev_flags = SDF_WRITABLE;\r\ns->n_chan = 2;\r\ns->maxdata = 0x0fff;\r\ns->range_table = &range_fl512;\r\ns->insn_write = fl512_ao_insn;\r\ns->insn_read = fl512_ao_insn_readback;\r\nprintk(KERN_INFO "comedi: fl512: subdevice 1 initialized\n");\r\nreturn 1;\r\n}\r\nstatic int fl512_detach(struct comedi_device *dev)\r\n{\r\nif (dev->iobase)\r\nrelease_region(dev->iobase, FL512_SIZE);\r\nprintk(KERN_INFO "comedi%d: fl512: dummy i detach\n", dev->minor);\r\nreturn 0;\r\n}

static inline u32 pci_cfg_read_32bit(struct pci_bus *bus, unsigned int devfn,\r\nint where)\r\n{\r\nu32 data;\r\nu32 *cfgaddr;\r\ncfgaddr = (u32 *)(pci_config_base +\r\npci_cfg_addr(bus->number, devfn, where & ~3));\r\ndata = *cfgaddr;\r\nreturn cpu_to_le32(data);\r\n}\r\nstatic inline void pci_cfg_write_32bit(struct pci_bus *bus, unsigned int devfn,\r\nint where, u32 data)\r\n{\r\nu32 *cfgaddr;\r\ncfgaddr = (u32 *)(pci_config_base +\r\npci_cfg_addr(bus->number, devfn, where & ~3));\r\n*cfgaddr = cpu_to_le32(data);\r\n}\r\nstatic int nlm_pcibios_read(struct pci_bus *bus, unsigned int devfn,\r\nint where, int size, u32 *val)\r\n{\r\nu32 data;\r\nif ((size == 2) && (where & 1))\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\nelse if ((size == 4) && (where & 3))\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\ndata = pci_cfg_read_32bit(bus, devfn, where);\r\nif (size == 1)\r\n*val = (data >> ((where & 3) << 3)) & 0xff;\r\nelse if (size == 2)\r\n*val = (data >> ((where & 3) << 3)) & 0xffff;\r\nelse\r\n*val = data;\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int nlm_pcibios_write(struct pci_bus *bus, unsigned int devfn,\r\nint where, int size, u32 val)\r\n{\r\nu32 data;\r\nif ((size == 2) && (where & 1))\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\nelse if ((size == 4) && (where & 3))\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\ndata = pci_cfg_read_32bit(bus, devfn, where);\r\nif (size == 1)\r\ndata = (data & ~(0xff << ((where & 3) << 3))) |\r\n(val << ((where & 3) << 3));\r\nelse if (size == 2)\r\ndata = (data & ~(0xffff << ((where & 3) << 3))) |\r\n(val << ((where & 3) << 3));\r\nelse\r\ndata = val;\r\npci_cfg_write_32bit(bus, devfn, where, data);\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nint __init pcibios_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nif (!nlm_chip_is_xls())\r\nreturn PIC_PCIX_IRQ;\r\nif (dev->bus->self == NULL)\r\nreturn 0;\r\nswitch (dev->bus->self->devfn) {\r\ncase 0x0:\r\nreturn PIC_PCIE_LINK0_IRQ;\r\ncase 0x8:\r\nreturn PIC_PCIE_LINK1_IRQ;\r\ncase 0x10:\r\nif (nlm_chip_is_xls_b())\r\nreturn PIC_PCIE_XLSB0_LINK2_IRQ;\r\nelse\r\nreturn PIC_PCIE_LINK2_IRQ;\r\ncase 0x18:\r\nif (nlm_chip_is_xls_b())\r\nreturn PIC_PCIE_XLSB0_LINK3_IRQ;\r\nelse\r\nreturn PIC_PCIE_LINK3_IRQ;\r\n}\r\nWARN(1, "Unexpected devfn %d\n", dev->bus->self->devfn);\r\nreturn 0;\r\n}\r\nint pcibios_plat_dev_init(struct pci_dev *dev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int __init pcibios_init(void)\r\n{\r\npci_probe_only = 1;\r\npci_config_base = ioremap(DEFAULT_PCI_CONFIG_BASE, 16 << 20);\r\nioport_resource.start = 0;\r\nioport_resource.end = ~0;\r\nset_io_port_base(CKSEG1);\r\nnlm_pci_controller.io_map_base = CKSEG1;\r\npr_info("Registering XLR/XLS PCIX/PCIE Controller.\n");\r\nregister_pci_controller(&nlm_pci_controller);\r\nreturn 0;\r\n}

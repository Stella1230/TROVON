static void au1xxx_start_ohc(void)\r\n{\r\n#ifndef CONFIG_SOC_AU1200\r\nau_writel(USBH_ENABLE_CE, USB_HOST_CONFIG);\r\nau_sync();\r\nudelay(1000);\r\nau_writel(au_readl(USB_HOST_CONFIG) | USBH_ENABLE_INIT, USB_HOST_CONFIG);\r\nau_sync();\r\nudelay(1000);\r\nwhile (au_readl(USB_HOST_CONFIG),\r\n!(au_readl(USB_HOST_CONFIG) & USBH_ENABLE_RD))\r\nudelay(1000);\r\n#else\r\nau_writel(au_readl(USB_HOST_CONFIG) | USBH_ENABLE_CE, USB_HOST_CONFIG);\r\nau_sync();\r\nudelay(1000);\r\nau_writel(au_readl(USB_HOST_CONFIG) | USBH_ENABLE_INIT, USB_HOST_CONFIG);\r\nau_sync();\r\nudelay(2000);\r\n#endif\r\n}\r\nstatic void au1xxx_stop_ohc(void)\r\n{\r\n#ifdef CONFIG_SOC_AU1200\r\nau_writel(au_readl(USB_HOST_CONFIG) & ~USBH_DISABLE, USB_HOST_CONFIG);\r\nau_sync();\r\nudelay(1000);\r\n#endif\r\nau_writel(au_readl(USB_HOST_CONFIG) & ~USBH_ENABLE_CE, USB_HOST_CONFIG);\r\nau_sync();\r\n}\r\nstatic int __devinit ohci_au1xxx_start(struct usb_hcd *hcd)\r\n{\r\nstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\r\nint ret;\r\nohci_dbg(ohci, "ohci_au1xxx_start, ohci:%p", ohci);\r\nif ((ret = ohci_init(ohci)) < 0)\r\nreturn ret;\r\nif ((ret = ohci_run(ohci)) < 0) {\r\nerr ("can't start %s", hcd->self.bus_name);\r\nohci_stop(hcd);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ohci_hcd_au1xxx_drv_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct usb_hcd *hcd;\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\n#if defined(CONFIG_SOC_AU1200) && defined(CONFIG_DMA_COHERENT)\r\nif (!(read_c0_prid() & 0xff)) {\r\nprintk(KERN_INFO "%s: this is chip revision AB !!\n",\r\npdev->name);\r\nprintk(KERN_INFO "%s: update your board or re-configure "\r\n"the kernel\n", pdev->name);\r\nreturn -ENODEV;\r\n}\r\n#endif\r\nif (pdev->resource[1].flags != IORESOURCE_IRQ) {\r\npr_debug("resource[1] is not IORESOURCE_IRQ\n");\r\nreturn -ENOMEM;\r\n}\r\nhcd = usb_create_hcd(&ohci_au1xxx_hc_driver, &pdev->dev, "au1xxx");\r\nif (!hcd)\r\nreturn -ENOMEM;\r\nhcd->rsrc_start = pdev->resource[0].start;\r\nhcd->rsrc_len = pdev->resource[0].end - pdev->resource[0].start + 1;\r\nif (!request_mem_region(hcd->rsrc_start, hcd->rsrc_len, hcd_name)) {\r\npr_debug("request_mem_region failed\n");\r\nret = -EBUSY;\r\ngoto err1;\r\n}\r\nhcd->regs = ioremap(hcd->rsrc_start, hcd->rsrc_len);\r\nif (!hcd->regs) {\r\npr_debug("ioremap failed\n");\r\nret = -ENOMEM;\r\ngoto err2;\r\n}\r\nau1xxx_start_ohc();\r\nohci_hcd_init(hcd_to_ohci(hcd));\r\nret = usb_add_hcd(hcd, pdev->resource[1].start,\r\nIRQF_DISABLED | IRQF_SHARED);\r\nif (ret == 0) {\r\nplatform_set_drvdata(pdev, hcd);\r\nreturn ret;\r\n}\r\nau1xxx_stop_ohc();\r\niounmap(hcd->regs);\r\nerr2:\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nerr1:\r\nusb_put_hcd(hcd);\r\nreturn ret;\r\n}\r\nstatic int ohci_hcd_au1xxx_drv_remove(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nusb_remove_hcd(hcd);\r\nau1xxx_stop_ohc();\r\niounmap(hcd->regs);\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nusb_put_hcd(hcd);\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn 0;\r\n}\r\nstatic int ohci_hcd_au1xxx_drv_suspend(struct device *dev)\r\n{\r\nstruct usb_hcd *hcd = dev_get_drvdata(dev);\r\nstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\r\nunsigned long flags;\r\nint rc;\r\nrc = 0;\r\nspin_lock_irqsave(&ohci->lock, flags);\r\nif (hcd->state != HC_STATE_SUSPENDED) {\r\nrc = -EINVAL;\r\ngoto bail;\r\n}\r\nohci_writel(ohci, OHCI_INTR_MIE, &ohci->regs->intrdisable);\r\n(void)ohci_readl(ohci, &ohci->regs->intrdisable);\r\nclear_bit(HCD_FLAG_HW_ACCESSIBLE, &hcd->flags);\r\nau1xxx_stop_ohc();\r\nbail:\r\nspin_unlock_irqrestore(&ohci->lock, flags);\r\nreturn rc;\r\n}\r\nstatic int ohci_hcd_au1xxx_drv_resume(struct device *dev)\r\n{\r\nstruct usb_hcd *hcd = dev_get_drvdata(dev);\r\nau1xxx_start_ohc();\r\nset_bit(HCD_FLAG_HW_ACCESSIBLE, &hcd->flags);\r\nohci_finish_controller_resume(hcd);\r\nreturn 0;\r\n}

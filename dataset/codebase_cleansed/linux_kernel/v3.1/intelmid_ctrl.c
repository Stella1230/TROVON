static inline int snd_intelmad_volume_info(struct snd_ctl_elem_info *uinfo,\r\nint control_type, int max, int min)\r\n{\r\nWARN_ON(!uinfo);\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\r\nuinfo->count = control_type;\r\nuinfo->value.integer.min = min;\r\nuinfo->value.integer.max = max;\r\nreturn 0;\r\n}\r\nstatic int snd_intelmad_mute_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nWARN_ON(!uinfo);\r\nWARN_ON(!kcontrol);\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_BOOLEAN;\r\nuinfo->count = MONO_CNTL;\r\nuinfo->value.integer.min = MIN_MUTE;\r\nuinfo->value.integer.max = MAX_MUTE;\r\nreturn 0;\r\n}\r\nstatic int snd_intelmad_capture_volume_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nsnd_intelmad_volume_info(uinfo, MONO_CNTL,\r\nintelmad_ctrl_val[sst_card_vendor_id].capture_vol_max,\r\nintelmad_ctrl_val[sst_card_vendor_id].capture_vol_min);\r\nreturn 0;\r\n}\r\nstatic int snd_intelmad_playback_volume_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nsnd_intelmad_volume_info(uinfo, STEREO_CNTL,\r\nintelmad_ctrl_val[sst_card_vendor_id].playback_vol_max,\r\nintelmad_ctrl_val[sst_card_vendor_id].playback_vol_min);\r\nreturn 0;\r\n}\r\nstatic int snd_intelmad_master_volume_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nsnd_intelmad_volume_info(uinfo, STEREO_CNTL,\r\nintelmad_ctrl_val[sst_card_vendor_id].master_vol_max,\r\nintelmad_ctrl_val[sst_card_vendor_id].master_vol_min);\r\nreturn 0;\r\n}\r\nstatic int snd_intelmad_device_info_mrst(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nWARN_ON(!kcontrol);\r\nWARN_ON(!uinfo);\r\nif (kcontrol->id.numid == OUTPUT_SEL)\r\nuinfo->value.enumerated.items = ARRAY_SIZE(out_names_mrst);\r\nelse\r\nuinfo->value.enumerated.items = ARRAY_SIZE(in_names_mrst);\r\nuinfo->count = MONO_CNTL;\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_ENUMERATED;\r\nif (uinfo->value.enumerated.item >= uinfo->value.enumerated.items)\r\nuinfo->value.enumerated.item = 1;\r\nif (kcontrol->id.numid == OUTPUT_SEL)\r\nstrncpy(uinfo->value.enumerated.name,\r\nout_names_mrst[uinfo->value.enumerated.item],\r\nsizeof(uinfo->value.enumerated.name)-1);\r\nelse\r\nstrncpy(uinfo->value.enumerated.name,\r\nin_names_mrst[uinfo->value.enumerated.item],\r\nsizeof(uinfo->value.enumerated.name)-1);\r\nreturn 0;\r\n}\r\nstatic int snd_intelmad_device_info_mfld(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nstruct snd_pmic_ops *scard_ops;\r\nstruct snd_intelmad *intelmaddata;\r\nWARN_ON(!kcontrol);\r\nWARN_ON(!uinfo);\r\nintelmaddata = kcontrol->private_data;\r\nWARN_ON(!intelmaddata->sstdrv_ops);\r\nscard_ops = intelmaddata->sstdrv_ops->scard_ops;\r\nif (kcontrol->id.numid == OUTPUT_SEL)\r\nuinfo->value.enumerated.items = ARRAY_SIZE(out_names_mfld);\r\nelse if (kcontrol->id.numid == INPUT_SEL)\r\nuinfo->value.enumerated.items = ARRAY_SIZE(in_names_mfld);\r\nelse if (kcontrol->id.numid == LINEOUT_SEL_MFLD) {\r\nuinfo->value.enumerated.items = ARRAY_SIZE(line_out_names_mfld);\r\nscard_ops->line_out_names_cnt = uinfo->value.enumerated.items;\r\n} else\r\nreturn -EINVAL;\r\nuinfo->count = MONO_CNTL;\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_ENUMERATED;\r\nif (uinfo->value.enumerated.item >= uinfo->value.enumerated.items)\r\nuinfo->value.enumerated.item = 1;\r\nif (kcontrol->id.numid == OUTPUT_SEL)\r\nstrncpy(uinfo->value.enumerated.name,\r\nout_names_mfld[uinfo->value.enumerated.item],\r\nsizeof(uinfo->value.enumerated.name)-1);\r\nelse if (kcontrol->id.numid == INPUT_SEL)\r\nstrncpy(uinfo->value.enumerated.name,\r\nin_names_mfld[uinfo->value.enumerated.item],\r\nsizeof(uinfo->value.enumerated.name)-1);\r\nelse if (kcontrol->id.numid == LINEOUT_SEL_MFLD)\r\nstrncpy(uinfo->value.enumerated.name,\r\nline_out_names_mfld[uinfo->value.enumerated.item],\r\nsizeof(uinfo->value.enumerated.name)-1);\r\nelse\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int snd_intelmad_volume_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *uval)\r\n{\r\nint ret_val = 0, cntl_list[2] = {0,};\r\nint value = 0;\r\nstruct snd_intelmad *intelmaddata;\r\nstruct snd_pmic_ops *scard_ops;\r\npr_debug("snd_intelmad_volume_get called\n");\r\nWARN_ON(!uval);\r\nWARN_ON(!kcontrol);\r\nintelmaddata = kcontrol->private_data;\r\nWARN_ON(!intelmaddata->sstdrv_ops);\r\nscard_ops = intelmaddata->sstdrv_ops->scard_ops;\r\nWARN_ON(!scard_ops);\r\nswitch (kcontrol->id.numid) {\r\ncase PLAYBACK_VOL:\r\ncntl_list[0] = PMIC_SND_RIGHT_PB_VOL;\r\ncntl_list[1] = PMIC_SND_LEFT_PB_VOL;\r\nbreak;\r\ncase CAPTURE_VOL:\r\ncntl_list[0] = PMIC_SND_CAPTURE_VOL;\r\nbreak;\r\ncase MASTER_VOL:\r\ncntl_list[0] = PMIC_SND_RIGHT_MASTER_VOL;\r\ncntl_list[1] = PMIC_SND_LEFT_MASTER_VOL;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nret_val = scard_ops->get_vol(cntl_list[0], &value);\r\nuval->value.integer.value[0] = value;\r\nif (ret_val)\r\nreturn ret_val;\r\nif (kcontrol->id.numid == PLAYBACK_VOL ||\r\nkcontrol->id.numid == MASTER_VOL) {\r\nret_val = scard_ops->get_vol(cntl_list[1], &value);\r\nuval->value.integer.value[1] = value;\r\n}\r\nreturn ret_val;\r\n}\r\nstatic int snd_intelmad_mute_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *uval)\r\n{\r\nint cntl_list = 0, ret_val = 0;\r\nu8 value = 0;\r\nstruct snd_intelmad *intelmaddata;\r\nstruct snd_pmic_ops *scard_ops;\r\npr_debug("Mute_get called\n");\r\nWARN_ON(!uval);\r\nWARN_ON(!kcontrol);\r\nintelmaddata = kcontrol->private_data;\r\nWARN_ON(!intelmaddata->sstdrv_ops);\r\nscard_ops = intelmaddata->sstdrv_ops->scard_ops;\r\nWARN_ON(!scard_ops);\r\nswitch (kcontrol->id.numid) {\r\ncase PLAYBACK_MUTE:\r\nif (intelmaddata->output_sel == STEREO_HEADPHONE)\r\ncntl_list = PMIC_SND_LEFT_HP_MUTE;\r\nelse if ((intelmaddata->output_sel == INTERNAL_SPKR) ||\r\n(intelmaddata->output_sel == MONO_EARPIECE))\r\ncntl_list = PMIC_SND_LEFT_SPEAKER_MUTE;\r\nbreak;\r\ncase CAPTURE_MUTE:\r\nif (intelmaddata->input_sel == DMIC)\r\ncntl_list = PMIC_SND_DMIC_MUTE;\r\nelse if (intelmaddata->input_sel == AMIC)\r\ncntl_list = PMIC_SND_AMIC_MUTE;\r\nelse if (intelmaddata->input_sel == HS_MIC)\r\ncntl_list = PMIC_SND_HP_MIC_MUTE;\r\nbreak;\r\ncase MASTER_MUTE:\r\nuval->value.integer.value[0] = intelmaddata->master_mute;\r\nreturn 0;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nret_val = scard_ops->get_mute(cntl_list, &value);\r\nuval->value.integer.value[0] = value;\r\nreturn ret_val;\r\n}\r\nstatic int snd_intelmad_volume_set(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *uval)\r\n{\r\nint ret_val, cntl_list[2] = {0,};\r\nstruct snd_intelmad *intelmaddata;\r\nstruct snd_pmic_ops *scard_ops;\r\npr_debug("volume set called:%ld %ld\n",\r\nuval->value.integer.value[0],\r\nuval->value.integer.value[1]);\r\nWARN_ON(!uval);\r\nWARN_ON(!kcontrol);\r\nintelmaddata = kcontrol->private_data;\r\nWARN_ON(!intelmaddata->sstdrv_ops);\r\nscard_ops = intelmaddata->sstdrv_ops->scard_ops;\r\nWARN_ON(!scard_ops);\r\nswitch (kcontrol->id.numid) {\r\ncase PLAYBACK_VOL:\r\ncntl_list[0] = PMIC_SND_LEFT_PB_VOL;\r\ncntl_list[1] = PMIC_SND_RIGHT_PB_VOL;\r\nbreak;\r\ncase CAPTURE_VOL:\r\ncntl_list[0] = PMIC_SND_CAPTURE_VOL;\r\nbreak;\r\ncase MASTER_VOL:\r\ncntl_list[0] = PMIC_SND_LEFT_MASTER_VOL;\r\ncntl_list[1] = PMIC_SND_RIGHT_MASTER_VOL;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nret_val = scard_ops->set_vol(cntl_list[0],\r\nuval->value.integer.value[0]);\r\nif (ret_val)\r\nreturn ret_val;\r\nif (kcontrol->id.numid == PLAYBACK_VOL ||\r\nkcontrol->id.numid == MASTER_VOL)\r\nret_val = scard_ops->set_vol(cntl_list[1],\r\nuval->value.integer.value[1]);\r\nreturn ret_val;\r\n}\r\nstatic int snd_intelmad_mute_set(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *uval)\r\n{\r\nint cntl_list[2] = {0,}, ret_val;\r\nstruct snd_intelmad *intelmaddata;\r\nstruct snd_pmic_ops *scard_ops;\r\npr_debug("snd_intelmad_mute_set called\n");\r\nWARN_ON(!uval);\r\nWARN_ON(!kcontrol);\r\nintelmaddata = kcontrol->private_data;\r\nWARN_ON(!intelmaddata->sstdrv_ops);\r\nscard_ops = intelmaddata->sstdrv_ops->scard_ops;\r\nWARN_ON(!scard_ops);\r\nkcontrol->private_value = uval->value.integer.value[0];\r\nswitch (kcontrol->id.numid) {\r\ncase PLAYBACK_MUTE:\r\nif (intelmaddata->output_sel == STEREO_HEADPHONE) {\r\ncntl_list[0] = PMIC_SND_LEFT_HP_MUTE;\r\ncntl_list[1] = PMIC_SND_RIGHT_HP_MUTE;\r\n} else if ((intelmaddata->output_sel == INTERNAL_SPKR) ||\r\n(intelmaddata->output_sel == MONO_EARPIECE)) {\r\ncntl_list[0] = PMIC_SND_LEFT_SPEAKER_MUTE;\r\ncntl_list[1] = PMIC_SND_RIGHT_SPEAKER_MUTE;\r\n}\r\nbreak;\r\ncase CAPTURE_MUTE:\r\nif (intelmaddata->input_sel == DMIC)\r\ncntl_list[0] = PMIC_SND_DMIC_MUTE;\r\nelse if (intelmaddata->input_sel == AMIC)\r\ncntl_list[0] = PMIC_SND_AMIC_MUTE;\r\nelse if (intelmaddata->input_sel == HS_MIC)\r\ncntl_list[0] = PMIC_SND_HP_MIC_MUTE;\r\nbreak;\r\ncase MASTER_MUTE:\r\ncntl_list[0] = PMIC_SND_MUTE_ALL;\r\nintelmaddata->master_mute = uval->value.integer.value[0];\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nret_val = scard_ops->set_mute(cntl_list[0],\r\nuval->value.integer.value[0]);\r\nif (ret_val)\r\nreturn ret_val;\r\nif (kcontrol->id.numid == PLAYBACK_MUTE)\r\nret_val = scard_ops->set_mute(cntl_list[1],\r\nuval->value.integer.value[0]);\r\nreturn ret_val;\r\n}\r\nstatic int snd_intelmad_device_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *uval)\r\n{\r\nstruct snd_intelmad *intelmaddata;\r\nstruct snd_pmic_ops *scard_ops;\r\npr_debug("device_get called\n");\r\nWARN_ON(!uval);\r\nWARN_ON(!kcontrol);\r\nintelmaddata = kcontrol->private_data;\r\nscard_ops = intelmaddata->sstdrv_ops->scard_ops;\r\nif (intelmaddata->cpu_id == CPU_CHIP_PENWELL) {\r\nif (kcontrol->id.numid == OUTPUT_SEL)\r\nuval->value.enumerated.item[0] =\r\nscard_ops->output_dev_id;\r\nelse if (kcontrol->id.numid == INPUT_SEL)\r\nuval->value.enumerated.item[0] =\r\nscard_ops->input_dev_id;\r\nelse if (kcontrol->id.numid == LINEOUT_SEL_MFLD)\r\nuval->value.enumerated.item[0] =\r\nscard_ops->lineout_dev_id;\r\nelse\r\nreturn -EINVAL;\r\n} else if (intelmaddata->cpu_id == CPU_CHIP_LINCROFT) {\r\nif (kcontrol->id.numid == OUTPUT_SEL)\r\nif (scard_ops->output_dev_id == MONO_EARPIECE ||\r\nscard_ops->output_dev_id == INTERNAL_SPKR)\r\nuval->value.enumerated.item[0] = MONO_EARPIECE;\r\nelse if (scard_ops->output_dev_id == STEREO_HEADPHONE)\r\nuval->value.enumerated.item[0] =\r\nSTEREO_HEADPHONE;\r\nelse\r\nreturn -EINVAL;\r\nelse if (kcontrol->id.numid == INPUT_SEL)\r\nuval->value.enumerated.item[0] =\r\nscard_ops->input_dev_id;\r\nelse\r\nreturn -EINVAL;\r\n} else\r\nuval->value.enumerated.item[0] = kcontrol->private_value;\r\nreturn 0;\r\n}\r\nstatic int snd_intelmad_device_set(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *uval)\r\n{\r\nstruct snd_intelmad *intelmaddata;\r\nstruct snd_pmic_ops *scard_ops;\r\nint ret_val = 0, vendor, status;\r\nstruct intel_sst_pcm_control *pcm_control;\r\npr_debug("snd_intelmad_device_set called\n");\r\nWARN_ON(!uval);\r\nWARN_ON(!kcontrol);\r\nstatus = -1;\r\nintelmaddata = kcontrol->private_data;\r\nWARN_ON(!intelmaddata->sstdrv_ops);\r\nscard_ops = intelmaddata->sstdrv_ops->scard_ops;\r\nWARN_ON(!scard_ops);\r\nkcontrol->private_value = uval->value.enumerated.item[0];\r\nswitch (kcontrol->id.numid) {\r\ncase OUTPUT_SEL:\r\nret_val = scard_ops->set_output_dev(\r\nuval->value.enumerated.item[0]);\r\nintelmaddata->output_sel = uval->value.enumerated.item[0];\r\nbreak;\r\ncase INPUT_SEL:\r\nvendor = intelmaddata->sstdrv_ops->vendor_id;\r\nif ((vendor == SND_MX) || (vendor == SND_FS)) {\r\npcm_control = intelmaddata->sstdrv_ops->pcm_control;\r\nif (uval->value.enumerated.item[0] == HS_MIC)\r\nstatus = 1;\r\nelse\r\nstatus = 0;\r\npcm_control->device_control(\r\nSST_ENABLE_RX_TIME_SLOT, &status);\r\n}\r\nret_val = scard_ops->set_input_dev(\r\nuval->value.enumerated.item[0]);\r\nintelmaddata->input_sel = uval->value.enumerated.item[0];\r\nbreak;\r\ncase LINEOUT_SEL_MFLD:\r\nret_val = scard_ops->set_lineout_dev(\r\nuval->value.enumerated.item[0]);\r\nintelmaddata->lineout_sel = uval->value.enumerated.item[0];\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nkcontrol->private_value = uval->value.enumerated.item[0];\r\nreturn ret_val;\r\n}\r\nstatic int snd_intelmad_device_dmic_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *uval)\r\n{\r\nstruct snd_intelmad *intelmaddata;\r\nstruct snd_pmic_ops *scard_ops;\r\nWARN_ON(!uval);\r\nWARN_ON(!kcontrol);\r\nintelmaddata = kcontrol->private_data;\r\nscard_ops = intelmaddata->sstdrv_ops->scard_ops;\r\nif (scard_ops->input_dev_id != DMIC) {\r\npr_debug("input dev = 0x%x\n", scard_ops->input_dev_id);\r\nreturn 0;\r\n}\r\nif (intelmaddata->cpu_id == CPU_CHIP_PENWELL)\r\nuval->value.enumerated.item[0] = kcontrol->private_value;\r\nelse\r\npr_debug(" CPU id = 0x%xis invalid.\n",\r\nintelmaddata->cpu_id);\r\nreturn 0;\r\n}\r\nvoid msic_set_bit(u8 index, unsigned int *available_dmics)\r\n{\r\n*available_dmics |= (1 << index);\r\n}\r\nvoid msic_clear_bit(u8 index, unsigned int *available_dmics)\r\n{\r\n*available_dmics &= ~(1 << index);\r\n}\r\nint msic_is_set_bit(u8 index, unsigned int *available_dmics)\r\n{\r\nint ret_val;\r\nret_val = (*available_dmics & (1 << index));\r\nreturn ret_val;\r\n}\r\nstatic int snd_intelmad_device_dmic_set(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *uval)\r\n{\r\nstruct snd_intelmad *intelmaddata;\r\nstruct snd_pmic_ops *scard_ops;\r\nint i, dmic_index;\r\nunsigned int available_dmics;\r\nint jump_count;\r\nint max_dmics = ARRAY_SIZE(router_dmics);\r\nWARN_ON(!uval);\r\nWARN_ON(!kcontrol);\r\nintelmaddata = kcontrol->private_data;\r\nWARN_ON(!intelmaddata->sstdrv_ops);\r\nscard_ops = intelmaddata->sstdrv_ops->scard_ops;\r\nWARN_ON(!scard_ops);\r\nif (scard_ops->input_dev_id != DMIC) {\r\npr_debug("input dev = 0x%x\n", scard_ops->input_dev_id);\r\nreturn 0;\r\n}\r\navailable_dmics = scard_ops->available_dmics;\r\nif (kcontrol->private_value > uval->value.enumerated.item[0]) {\r\npr_debug("jump count -1.\n");\r\njump_count = -1;\r\n} else {\r\npr_debug("jump count 1.\n");\r\njump_count = 1;\r\n}\r\ndmic_index = uval->value.enumerated.item[0];\r\npr_debug("set function. dmic_index = %d, avl_dmic = 0x%x\n",\r\ndmic_index, available_dmics);\r\nfor (i = 0; i < max_dmics; i++) {\r\npr_debug("set function. loop index = 0x%x. dmic_index = 0x%x\n",\r\ni, dmic_index);\r\nif (!msic_is_set_bit(dmic_index, &available_dmics)) {\r\nmsic_clear_bit(kcontrol->private_value,\r\n&available_dmics);\r\nmsic_set_bit(dmic_index, &available_dmics);\r\nkcontrol->private_value = dmic_index;\r\nscard_ops->available_dmics = available_dmics;\r\nscard_ops->hw_dmic_map[kcontrol->id.numid-HW_CH_BASE] =\r\nkcontrol->private_value;\r\nscard_ops->set_hw_dmic_route\r\n(kcontrol->id.numid-HW_CH_BASE);\r\nreturn 0;\r\n}\r\ndmic_index += jump_count;\r\nif (dmic_index > (max_dmics - 1) && jump_count == 1) {\r\npr_debug("Resettingthe dmic index to 0.\n");\r\ndmic_index = 0;\r\n} else if (dmic_index == -1 && jump_count == -1) {\r\npr_debug("Resetting the dmic index to 5.\n");\r\ndmic_index = max_dmics - 1;\r\n}\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int snd_intelmad_device_dmic_info_mfld(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nstruct snd_intelmad *intelmaddata;\r\nstruct snd_pmic_ops *scard_ops;\r\nuinfo->count = MONO_CNTL;\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_ENUMERATED;\r\nuinfo->value.enumerated.items = ARRAY_SIZE(router_dmics);\r\nintelmaddata = kcontrol->private_data;\r\nWARN_ON(!intelmaddata->sstdrv_ops);\r\nscard_ops = intelmaddata->sstdrv_ops->scard_ops;\r\nWARN_ON(!scard_ops);\r\nif (uinfo->value.enumerated.item >= uinfo->value.enumerated.items)\r\nuinfo->value.enumerated.item =\r\nuinfo->value.enumerated.items - 1;\r\nstrncpy(uinfo->value.enumerated.name,\r\nrouter_dmics[uinfo->value.enumerated.item],\r\nsizeof(uinfo->value.enumerated.name)-1);\r\nmsic_set_bit(kcontrol->private_value, &scard_ops->available_dmics);\r\npr_debug("info function. avl_dmic = 0x%x",\r\nscard_ops->available_dmics);\r\nscard_ops->hw_dmic_map[kcontrol->id.numid-HW_CH_BASE] =\r\nkcontrol->private_value;\r\nreturn 0;\r\n}

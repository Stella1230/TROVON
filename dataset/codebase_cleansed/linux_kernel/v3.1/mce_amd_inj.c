static ssize_t edac_inject_bank_store(struct kobject *kobj,\r\nstruct edac_mce_attr *attr,\r\nconst char *data, size_t count)\r\n{\r\nint ret = 0;\r\nunsigned long value;\r\nret = strict_strtoul(data, 10, &value);\r\nif (ret < 0) {\r\nprintk(KERN_ERR "Invalid bank value!\n");\r\nreturn -EINVAL;\r\n}\r\nif (value > 5)\r\nif (boot_cpu_data.x86 != 0x15 || value > 6) {\r\nprintk(KERN_ERR "Non-existent MCE bank: %lu\n", value);\r\nreturn -EINVAL;\r\n}\r\ni_mce.bank = value;\r\namd_decode_mce(NULL, 0, &i_mce);\r\nreturn count;\r\n}\r\nstatic ssize_t edac_inject_bank_show(struct kobject *kobj,\r\nstruct edac_mce_attr *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "%d\n", i_mce.bank);\r\n}\r\nstatic int __init edac_init_mce_inject(void)\r\n{\r\nstruct sysdev_class *edac_class = NULL;\r\nint i, err = 0;\r\nedac_class = edac_get_sysfs_class();\r\nif (!edac_class)\r\nreturn -EINVAL;\r\nmce_kobj = kobject_create_and_add("mce", &edac_class->kset.kobj);\r\nif (!mce_kobj) {\r\nprintk(KERN_ERR "Error creating a mce kset.\n");\r\nerr = -ENOMEM;\r\ngoto err_mce_kobj;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(sysfs_attrs); i++) {\r\nerr = sysfs_create_file(mce_kobj, &sysfs_attrs[i]->attr);\r\nif (err) {\r\nprintk(KERN_ERR "Error creating %s in sysfs.\n",\r\nsysfs_attrs[i]->attr.name);\r\ngoto err_sysfs_create;\r\n}\r\n}\r\nreturn 0;\r\nerr_sysfs_create:\r\nwhile (--i >= 0)\r\nsysfs_remove_file(mce_kobj, &sysfs_attrs[i]->attr);\r\nkobject_del(mce_kobj);\r\nerr_mce_kobj:\r\nedac_put_sysfs_class();\r\nreturn err;\r\n}\r\nstatic void __exit edac_exit_mce_inject(void)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(sysfs_attrs); i++)\r\nsysfs_remove_file(mce_kobj, &sysfs_attrs[i]->attr);\r\nkobject_del(mce_kobj);\r\nedac_put_sysfs_class();\r\n}

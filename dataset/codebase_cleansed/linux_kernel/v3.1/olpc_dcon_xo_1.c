static int dcon_init_xo_1(struct dcon_priv *dcon)\r\n{\r\nunsigned char lob;\r\nif (gpio_request(OLPC_GPIO_DCON_STAT0, "OLPC-DCON")) {\r\nprintk(KERN_ERR "olpc-dcon: failed to request STAT0 GPIO\n");\r\nreturn -EIO;\r\n}\r\nif (gpio_request(OLPC_GPIO_DCON_STAT1, "OLPC-DCON")) {\r\nprintk(KERN_ERR "olpc-dcon: failed to request STAT1 GPIO\n");\r\ngoto err_gp_stat1;\r\n}\r\nif (gpio_request(OLPC_GPIO_DCON_IRQ, "OLPC-DCON")) {\r\nprintk(KERN_ERR "olpc-dcon: failed to request IRQ GPIO\n");\r\ngoto err_gp_irq;\r\n}\r\nif (gpio_request(OLPC_GPIO_DCON_LOAD, "OLPC-DCON")) {\r\nprintk(KERN_ERR "olpc-dcon: failed to request LOAD GPIO\n");\r\ngoto err_gp_load;\r\n}\r\nif (gpio_request(OLPC_GPIO_DCON_BLANK, "OLPC-DCON")) {\r\nprintk(KERN_ERR "olpc-dcon: failed to request BLANK GPIO\n");\r\ngoto err_gp_blank;\r\n}\r\ncs5535_gpio_clear(OLPC_GPIO_DCON_IRQ, GPIO_EVENTS_ENABLE);\r\ndcon->curr_src = cs5535_gpio_isset(OLPC_GPIO_DCON_LOAD, GPIO_OUTPUT_VAL)\r\n? DCON_SOURCE_CPU\r\n: DCON_SOURCE_DCON;\r\ndcon->pending_src = dcon->curr_src;\r\ngpio_direction_input(OLPC_GPIO_DCON_STAT0);\r\ngpio_direction_input(OLPC_GPIO_DCON_STAT1);\r\ngpio_direction_input(OLPC_GPIO_DCON_IRQ);\r\ngpio_direction_input(OLPC_GPIO_DCON_BLANK);\r\ngpio_direction_output(OLPC_GPIO_DCON_LOAD,\r\ndcon->curr_src == DCON_SOURCE_CPU);\r\ncs5535_gpio_setup_event(OLPC_GPIO_DCON_IRQ, 2, 0);\r\ncs5535_gpio_set_irq(2, DCON_IRQ);\r\nlob = inb(0x4d0);\r\nlob &= ~(1 << DCON_IRQ);\r\noutb(lob, 0x4d0);\r\nif (request_irq(DCON_IRQ, &dcon_interrupt, 0, "DCON", dcon)) {\r\nprintk(KERN_ERR "olpc-dcon: failed to request DCON's irq\n");\r\ngoto err_req_irq;\r\n}\r\ncs5535_gpio_clear(OLPC_GPIO_DCON_IRQ, GPIO_INPUT_INVERT);\r\ncs5535_gpio_set(OLPC_GPIO_DCON_BLANK, GPIO_INPUT_FILTER);\r\ncs5535_gpio_clear(OLPC_GPIO_DCON_IRQ, GPIO_INPUT_FILTER);\r\ncs5535_gpio_clear(OLPC_GPIO_DCON_IRQ, GPIO_INPUT_EVENT_COUNT);\r\ncs5535_gpio_clear(OLPC_GPIO_DCON_BLANK, GPIO_INPUT_EVENT_COUNT);\r\ncs5535_gpio_set(OLPC_GPIO_DCON_BLANK, GPIO_FE7_SEL);\r\ncs5535_gpio_clear(OLPC_GPIO_DCON_BLANK, GPIO_NEGATIVE_EDGE_EN);\r\ncs5535_gpio_set(OLPC_GPIO_DCON_IRQ, GPIO_NEGATIVE_EDGE_EN);\r\ncs5535_gpio_set(0, GPIO_FLTR7_AMOUNT);\r\ncs5535_gpio_set(OLPC_GPIO_DCON_IRQ, GPIO_NEGATIVE_EDGE_STS);\r\ncs5535_gpio_set(OLPC_GPIO_DCON_BLANK, GPIO_NEGATIVE_EDGE_STS);\r\ncs5535_gpio_set(OLPC_GPIO_DCON_IRQ, GPIO_POSITIVE_EDGE_STS);\r\ncs5535_gpio_set(OLPC_GPIO_DCON_BLANK, GPIO_POSITIVE_EDGE_STS);\r\ncs5535_gpio_set(OLPC_GPIO_DCON_IRQ, GPIO_EVENTS_ENABLE);\r\ncs5535_gpio_set(OLPC_GPIO_DCON_BLANK, GPIO_EVENTS_ENABLE);\r\nreturn 0;\r\nerr_req_irq:\r\ngpio_free(OLPC_GPIO_DCON_BLANK);\r\nerr_gp_blank:\r\ngpio_free(OLPC_GPIO_DCON_LOAD);\r\nerr_gp_load:\r\ngpio_free(OLPC_GPIO_DCON_IRQ);\r\nerr_gp_irq:\r\ngpio_free(OLPC_GPIO_DCON_STAT1);\r\nerr_gp_stat1:\r\ngpio_free(OLPC_GPIO_DCON_STAT0);\r\nreturn -EIO;\r\n}\r\nstatic void dcon_wiggle_xo_1(void)\r\n{\r\nint x;\r\ncs5535_gpio_set(OLPC_GPIO_SMB_CLK, GPIO_OUTPUT_VAL);\r\ncs5535_gpio_set(OLPC_GPIO_SMB_DATA, GPIO_OUTPUT_VAL);\r\ncs5535_gpio_set(OLPC_GPIO_SMB_CLK, GPIO_OUTPUT_ENABLE);\r\ncs5535_gpio_set(OLPC_GPIO_SMB_DATA, GPIO_OUTPUT_ENABLE);\r\ncs5535_gpio_clear(OLPC_GPIO_SMB_CLK, GPIO_OUTPUT_AUX1);\r\ncs5535_gpio_clear(OLPC_GPIO_SMB_DATA, GPIO_OUTPUT_AUX1);\r\ncs5535_gpio_clear(OLPC_GPIO_SMB_CLK, GPIO_OUTPUT_AUX2);\r\ncs5535_gpio_clear(OLPC_GPIO_SMB_DATA, GPIO_OUTPUT_AUX2);\r\ncs5535_gpio_clear(OLPC_GPIO_SMB_CLK, GPIO_INPUT_AUX1);\r\ncs5535_gpio_clear(OLPC_GPIO_SMB_DATA, GPIO_INPUT_AUX1);\r\nfor (x = 0; x < 16; x++) {\r\nudelay(5);\r\ncs5535_gpio_clear(OLPC_GPIO_SMB_CLK, GPIO_OUTPUT_VAL);\r\nudelay(5);\r\ncs5535_gpio_set(OLPC_GPIO_SMB_CLK, GPIO_OUTPUT_VAL);\r\n}\r\nudelay(5);\r\ncs5535_gpio_set(OLPC_GPIO_SMB_CLK, GPIO_OUTPUT_AUX1);\r\ncs5535_gpio_set(OLPC_GPIO_SMB_DATA, GPIO_OUTPUT_AUX1);\r\ncs5535_gpio_set(OLPC_GPIO_SMB_CLK, GPIO_INPUT_AUX1);\r\ncs5535_gpio_set(OLPC_GPIO_SMB_DATA, GPIO_INPUT_AUX1);\r\n}\r\nstatic void dcon_set_dconload_1(int val)\r\n{\r\ngpio_set_value(OLPC_GPIO_DCON_LOAD, val);\r\n}\r\nstatic u8 dcon_read_status_xo_1(void)\r\n{\r\nu8 status;\r\nstatus = gpio_get_value(OLPC_GPIO_DCON_STAT0);\r\nstatus |= gpio_get_value(OLPC_GPIO_DCON_STAT1) << 1;\r\ncs5535_gpio_set(OLPC_GPIO_DCON_IRQ, GPIO_NEGATIVE_EDGE_STS);\r\nreturn status;\r\n}

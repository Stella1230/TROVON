static int __devinit driver_pci6208_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *ent)\r\n{\r\nreturn comedi_pci_auto_config(dev, driver_pci6208.driver_name);\r\n}\r\nstatic void __devexit driver_pci6208_pci_remove(struct pci_dev *dev)\r\n{\r\ncomedi_pci_auto_unconfig(dev);\r\n}\r\nstatic int __init driver_pci6208_init_module(void)\r\n{\r\nint retval;\r\nretval = comedi_driver_register(&driver_pci6208);\r\nif (retval < 0)\r\nreturn retval;\r\ndriver_pci6208_pci_driver.name = (char *)driver_pci6208.driver_name;\r\nreturn pci_register_driver(&driver_pci6208_pci_driver);\r\n}\r\nstatic void __exit driver_pci6208_cleanup_module(void)\r\n{\r\npci_unregister_driver(&driver_pci6208_pci_driver);\r\ncomedi_driver_unregister(&driver_pci6208);\r\n}\r\nstatic int pci6208_attach(struct comedi_device *dev,\r\nstruct comedi_devconfig *it)\r\n{\r\nstruct comedi_subdevice *s;\r\nint retval;\r\nunsigned long io_base;\r\nprintk(KERN_INFO "comedi%d: pci6208: ", dev->minor);\r\nretval = alloc_private(dev, sizeof(struct pci6208_private));\r\nif (retval < 0)\r\nreturn retval;\r\nretval = pci6208_find_device(dev, it->options[0], it->options[1]);\r\nif (retval < 0)\r\nreturn retval;\r\nretval = pci6208_pci_setup(devpriv->pci_dev, &io_base, dev->minor);\r\nif (retval < 0)\r\nreturn retval;\r\ndev->iobase = io_base;\r\ndev->board_name = thisboard->name;\r\nif (alloc_subdevices(dev, 2) < 0)\r\nreturn -ENOMEM;\r\ns = dev->subdevices + 0;\r\ns->type = COMEDI_SUBD_AO;\r\ns->subdev_flags = SDF_WRITABLE;\r\ns->n_chan = thisboard->ao_chans;\r\ns->maxdata = 0xffff;\r\ns->range_table = &range_bipolar10;\r\ns->insn_write = pci6208_ao_winsn;\r\ns->insn_read = pci6208_ao_rinsn;\r\nprintk(KERN_INFO "attached\n");\r\nreturn 1;\r\n}\r\nstatic int pci6208_detach(struct comedi_device *dev)\r\n{\r\nprintk(KERN_INFO "comedi%d: pci6208: remove\n", dev->minor);\r\nif (devpriv && devpriv->pci_dev) {\r\nif (dev->iobase)\r\ncomedi_pci_disable(devpriv->pci_dev);\r\npci_dev_put(devpriv->pci_dev);\r\n}\r\nreturn 0;\r\n}\r\nstatic int pci6208_ao_winsn(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint i = 0, Data_Read;\r\nunsigned short chan = CR_CHAN(insn->chanspec);\r\nunsigned long invert = 1 << (16 - 1);\r\nunsigned long out_value;\r\nfor (i = 0; i < insn->n; i++) {\r\nout_value = data[i] ^ invert;\r\ndo {\r\nData_Read = (inw(dev->iobase) & 1);\r\n} while (Data_Read);\r\noutw(out_value, dev->iobase + (0x02 * chan));\r\ndevpriv->ao_readback[chan] = out_value;\r\n}\r\nreturn i;\r\n}\r\nstatic int pci6208_ao_rinsn(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint i;\r\nint chan = CR_CHAN(insn->chanspec);\r\nfor (i = 0; i < insn->n; i++)\r\ndata[i] = devpriv->ao_readback[chan];\r\nreturn i;\r\n}\r\nstatic int pci6208_find_device(struct comedi_device *dev, int bus, int slot)\r\n{\r\nstruct pci_dev *pci_dev = NULL;\r\nint i;\r\nfor_each_pci_dev(pci_dev) {\r\nif (pci_dev->vendor == PCI_VENDOR_ID_ADLINK) {\r\nfor (i = 0; i < ARRAY_SIZE(pci6208_boards); i++) {\r\nif (pci6208_boards[i].dev_id ==\r\npci_dev->device) {\r\nif ((bus != 0) || (slot != 0)) {\r\nif (pci_dev->bus->number\r\n!= bus ||\r\nPCI_SLOT(pci_dev->devfn)\r\n!= slot) {\r\ncontinue;\r\n}\r\n}\r\ndev->board_ptr = pci6208_boards + i;\r\ngoto found;\r\n}\r\n}\r\n}\r\n}\r\nprintk(KERN_ERR "comedi%d: no supported board found! "\r\n"(req. bus/slot : %d/%d)\n",\r\ndev->minor, bus, slot);\r\nreturn -EIO;\r\nfound:\r\nprintk("comedi%d: found %s (b:s:f=%d:%d:%d) , irq=%d\n",\r\ndev->minor,\r\npci6208_boards[i].name,\r\npci_dev->bus->number,\r\nPCI_SLOT(pci_dev->devfn),\r\nPCI_FUNC(pci_dev->devfn), pci_dev->irq);\r\ndevpriv->pci_dev = pci_dev;\r\nreturn 0;\r\n}\r\nstatic int\r\npci6208_pci_setup(struct pci_dev *pci_dev, unsigned long *io_base_ptr,\r\nint dev_minor)\r\n{\r\nunsigned long io_base, io_range, lcr_io_base, lcr_io_range;\r\nif (comedi_pci_enable(pci_dev, PCI6208_DRIVER_NAME) < 0) {\r\nprintk(KERN_ERR "comedi%d: Failed to enable PCI device "\r\n"and request regions\n",\r\ndev_minor);\r\nreturn -EIO;\r\n}\r\nlcr_io_base = pci_resource_start(pci_dev, 1);\r\nlcr_io_range = pci_resource_len(pci_dev, 1);\r\nprintk(KERN_INFO "comedi%d: local config registers at address"\r\n" 0x%4lx [0x%4lx]\n",\r\ndev_minor, lcr_io_base, lcr_io_range);\r\nio_base = pci_resource_start(pci_dev, 2);\r\nio_range = pci_resource_end(pci_dev, 2) - io_base + 1;\r\nprintk("comedi%d: 6208 registers at address 0x%4lx [0x%4lx]\n",\r\ndev_minor, io_base, io_range);\r\n*io_base_ptr = io_base;\r\nreturn 0;\r\n}

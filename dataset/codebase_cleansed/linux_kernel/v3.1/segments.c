static bool ignored_gdt(unsigned int num)\r\n{\r\nreturn (num == GDT_ENTRY_TSS\r\n|| num == GDT_ENTRY_LGUEST_CS\r\n|| num == GDT_ENTRY_LGUEST_DS\r\n|| num == GDT_ENTRY_DOUBLEFAULT_TSS);\r\n}\r\nstatic void fixup_gdt_table(struct lg_cpu *cpu, unsigned start, unsigned end)\r\n{\r\nunsigned int i;\r\nfor (i = start; i < end; i++) {\r\nif (ignored_gdt(i))\r\ncontinue;\r\nif ((cpu->arch.gdt[i].b & 0x00006000) == 0)\r\ncpu->arch.gdt[i].b |= (GUEST_PL << 13);\r\ncpu->arch.gdt[i].b |= 0x00000100;\r\n}\r\n}\r\nvoid setup_default_gdt_entries(struct lguest_ro_state *state)\r\n{\r\nstruct desc_struct *gdt = state->guest_gdt;\r\nunsigned long tss = (unsigned long)&state->guest_tss;\r\ngdt[GDT_ENTRY_LGUEST_CS] = FULL_EXEC_SEGMENT;\r\ngdt[GDT_ENTRY_LGUEST_DS] = FULL_SEGMENT;\r\ngdt[GDT_ENTRY_TSS].a = 0x00000067 | (tss << 16);\r\ngdt[GDT_ENTRY_TSS].b = 0x00008900 | (tss & 0xFF000000)\r\n| ((tss >> 16) & 0x000000FF);\r\n}\r\nvoid setup_guest_gdt(struct lg_cpu *cpu)\r\n{\r\ncpu->arch.gdt[GDT_ENTRY_KERNEL_CS] = FULL_EXEC_SEGMENT;\r\ncpu->arch.gdt[GDT_ENTRY_KERNEL_DS] = FULL_SEGMENT;\r\ncpu->arch.gdt[GDT_ENTRY_KERNEL_CS].b |= (GUEST_PL << 13);\r\ncpu->arch.gdt[GDT_ENTRY_KERNEL_DS].b |= (GUEST_PL << 13);\r\n}\r\nvoid copy_gdt_tls(const struct lg_cpu *cpu, struct desc_struct *gdt)\r\n{\r\nunsigned int i;\r\nfor (i = GDT_ENTRY_TLS_MIN; i <= GDT_ENTRY_TLS_MAX; i++)\r\ngdt[i] = cpu->arch.gdt[i];\r\n}\r\nvoid copy_gdt(const struct lg_cpu *cpu, struct desc_struct *gdt)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < GDT_ENTRIES; i++)\r\nif (!ignored_gdt(i))\r\ngdt[i] = cpu->arch.gdt[i];\r\n}\r\nvoid load_guest_gdt_entry(struct lg_cpu *cpu, u32 num, u32 lo, u32 hi)\r\n{\r\nif (num >= ARRAY_SIZE(cpu->arch.gdt)) {\r\nkill_guest(cpu, "too many gdt entries %i", num);\r\nreturn;\r\n}\r\ncpu->arch.gdt[num].a = lo;\r\ncpu->arch.gdt[num].b = hi;\r\nfixup_gdt_table(cpu, num, num+1);\r\ncpu->changed |= CHANGED_GDT;\r\n}\r\nvoid guest_load_tls(struct lg_cpu *cpu, unsigned long gtls)\r\n{\r\nstruct desc_struct *tls = &cpu->arch.gdt[GDT_ENTRY_TLS_MIN];\r\n__lgread(cpu, tls, gtls, sizeof(*tls)*GDT_ENTRY_TLS_ENTRIES);\r\nfixup_gdt_table(cpu, GDT_ENTRY_TLS_MIN, GDT_ENTRY_TLS_MAX+1);\r\ncpu->changed |= CHANGED_GDT_TLS;\r\n}

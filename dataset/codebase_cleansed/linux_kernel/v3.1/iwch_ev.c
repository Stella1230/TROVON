static void post_qp_event(struct iwch_dev *rnicp, struct iwch_cq *chp,\r\nstruct respQ_msg_t *rsp_msg,\r\nenum ib_event_type ib_event,\r\nint send_term)\r\n{\r\nstruct ib_event event;\r\nstruct iwch_qp_attributes attrs;\r\nstruct iwch_qp *qhp;\r\nspin_lock(&rnicp->lock);\r\nqhp = get_qhp(rnicp, CQE_QPID(rsp_msg->cqe));\r\nif (!qhp) {\r\nprintk(KERN_ERR "%s unaffiliated error 0x%x qpid 0x%x\n",\r\n__func__, CQE_STATUS(rsp_msg->cqe),\r\nCQE_QPID(rsp_msg->cqe));\r\nspin_unlock(&rnicp->lock);\r\nreturn;\r\n}\r\nif ((qhp->attr.state == IWCH_QP_STATE_ERROR) ||\r\n(qhp->attr.state == IWCH_QP_STATE_TERMINATE)) {\r\nPDBG("%s AE received after RTS - "\r\n"qp state %d qpid 0x%x status 0x%x\n", __func__,\r\nqhp->attr.state, qhp->wq.qpid, CQE_STATUS(rsp_msg->cqe));\r\nspin_unlock(&rnicp->lock);\r\nreturn;\r\n}\r\nprintk(KERN_ERR "%s - AE qpid 0x%x opcode %d status 0x%x "\r\n"type %d wrid.hi 0x%x wrid.lo 0x%x \n", __func__,\r\nCQE_QPID(rsp_msg->cqe), CQE_OPCODE(rsp_msg->cqe),\r\nCQE_STATUS(rsp_msg->cqe), CQE_TYPE(rsp_msg->cqe),\r\nCQE_WRID_HI(rsp_msg->cqe), CQE_WRID_LOW(rsp_msg->cqe));\r\natomic_inc(&qhp->refcnt);\r\nspin_unlock(&rnicp->lock);\r\nif (qhp->attr.state == IWCH_QP_STATE_RTS) {\r\nattrs.next_state = IWCH_QP_STATE_TERMINATE;\r\niwch_modify_qp(qhp->rhp, qhp, IWCH_QP_ATTR_NEXT_STATE,\r\n&attrs, 1);\r\nif (send_term)\r\niwch_post_terminate(qhp, rsp_msg);\r\n}\r\nevent.event = ib_event;\r\nevent.device = chp->ibcq.device;\r\nif (ib_event == IB_EVENT_CQ_ERR)\r\nevent.element.cq = &chp->ibcq;\r\nelse\r\nevent.element.qp = &qhp->ibqp;\r\nif (qhp->ibqp.event_handler)\r\n(*qhp->ibqp.event_handler)(&event, qhp->ibqp.qp_context);\r\n(*chp->ibcq.comp_handler)(&chp->ibcq, chp->ibcq.cq_context);\r\nif (atomic_dec_and_test(&qhp->refcnt))\r\nwake_up(&qhp->wait);\r\n}\r\nvoid iwch_ev_dispatch(struct cxio_rdev *rdev_p, struct sk_buff *skb)\r\n{\r\nstruct iwch_dev *rnicp;\r\nstruct respQ_msg_t *rsp_msg = (struct respQ_msg_t *) skb->data;\r\nstruct iwch_cq *chp;\r\nstruct iwch_qp *qhp;\r\nu32 cqid = RSPQ_CQID(rsp_msg);\r\nrnicp = (struct iwch_dev *) rdev_p->ulp;\r\nspin_lock(&rnicp->lock);\r\nchp = get_chp(rnicp, cqid);\r\nqhp = get_qhp(rnicp, CQE_QPID(rsp_msg->cqe));\r\nif (!chp || !qhp) {\r\nprintk(KERN_ERR MOD "BAD AE cqid 0x%x qpid 0x%x opcode %d "\r\n"status 0x%x type %d wrid.hi 0x%x wrid.lo 0x%x \n",\r\ncqid, CQE_QPID(rsp_msg->cqe),\r\nCQE_OPCODE(rsp_msg->cqe), CQE_STATUS(rsp_msg->cqe),\r\nCQE_TYPE(rsp_msg->cqe), CQE_WRID_HI(rsp_msg->cqe),\r\nCQE_WRID_LOW(rsp_msg->cqe));\r\nspin_unlock(&rnicp->lock);\r\ngoto out;\r\n}\r\niwch_qp_add_ref(&qhp->ibqp);\r\natomic_inc(&chp->refcnt);\r\nspin_unlock(&rnicp->lock);\r\nif ((CQE_OPCODE(rsp_msg->cqe) == T3_TERMINATE) &&\r\n(CQE_STATUS(rsp_msg->cqe) == 0)) {\r\nif (SQ_TYPE(rsp_msg->cqe)) {\r\nPDBG("%s QPID 0x%x ep %p disconnecting\n",\r\n__func__, qhp->wq.qpid, qhp->ep);\r\niwch_ep_disconnect(qhp->ep, 0, GFP_ATOMIC);\r\n} else {\r\nPDBG("%s post REQ_ERR AE QPID 0x%x\n", __func__,\r\nqhp->wq.qpid);\r\npost_qp_event(rnicp, chp, rsp_msg,\r\nIB_EVENT_QP_REQ_ERR, 0);\r\niwch_ep_disconnect(qhp->ep, 0, GFP_ATOMIC);\r\n}\r\ngoto done;\r\n}\r\nif (SQ_TYPE(rsp_msg->cqe) &&\r\n(CQE_OPCODE(rsp_msg->cqe) == T3_READ_RESP)) {\r\npost_qp_event(rnicp, chp, rsp_msg, IB_EVENT_QP_REQ_ERR, 1);\r\ngoto done;\r\n}\r\nif (RQ_TYPE(rsp_msg->cqe) &&\r\n(CQE_OPCODE(rsp_msg->cqe) == T3_RDMA_WRITE)) {\r\npost_qp_event(rnicp, chp, rsp_msg, IB_EVENT_QP_REQ_ERR, 1);\r\ngoto done;\r\n}\r\nswitch (CQE_STATUS(rsp_msg->cqe)) {\r\ncase TPT_ERR_SUCCESS:\r\nif (qhp->ep && SQ_TYPE(rsp_msg->cqe))\r\ndst_confirm(qhp->ep->dst);\r\n(*chp->ibcq.comp_handler)(&chp->ibcq, chp->ibcq.cq_context);\r\nbreak;\r\ncase TPT_ERR_STAG:\r\ncase TPT_ERR_PDID:\r\ncase TPT_ERR_QPID:\r\ncase TPT_ERR_ACCESS:\r\ncase TPT_ERR_WRAP:\r\ncase TPT_ERR_BOUND:\r\ncase TPT_ERR_INVALIDATE_SHARED_MR:\r\ncase TPT_ERR_INVALIDATE_MR_WITH_MW_BOUND:\r\npost_qp_event(rnicp, chp, rsp_msg, IB_EVENT_QP_ACCESS_ERR, 1);\r\nbreak;\r\ncase TPT_ERR_ECC:\r\ncase TPT_ERR_ECC_PSTAG:\r\ncase TPT_ERR_INTERNAL_ERR:\r\npost_qp_event(rnicp, chp, rsp_msg, IB_EVENT_DEVICE_FATAL, 1);\r\nbreak;\r\ncase TPT_ERR_OUT_OF_RQE:\r\ncase TPT_ERR_PBL_ADDR_BOUND:\r\ncase TPT_ERR_CRC:\r\ncase TPT_ERR_MARKER:\r\ncase TPT_ERR_PDU_LEN_ERR:\r\ncase TPT_ERR_DDP_VERSION:\r\ncase TPT_ERR_RDMA_VERSION:\r\ncase TPT_ERR_OPCODE:\r\ncase TPT_ERR_DDP_QUEUE_NUM:\r\ncase TPT_ERR_MSN:\r\ncase TPT_ERR_TBIT:\r\ncase TPT_ERR_MO:\r\ncase TPT_ERR_MSN_GAP:\r\ncase TPT_ERR_MSN_RANGE:\r\ncase TPT_ERR_RQE_ADDR_BOUND:\r\ncase TPT_ERR_IRD_OVERFLOW:\r\npost_qp_event(rnicp, chp, rsp_msg, IB_EVENT_QP_FATAL, 1);\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR MOD "Unknown T3 status 0x%x QPID 0x%x\n",\r\nCQE_STATUS(rsp_msg->cqe), qhp->wq.qpid);\r\npost_qp_event(rnicp, chp, rsp_msg, IB_EVENT_QP_FATAL, 1);\r\nbreak;\r\n}\r\ndone:\r\nif (atomic_dec_and_test(&chp->refcnt))\r\nwake_up(&chp->wait);\r\niwch_qp_rem_ref(&qhp->ibqp);\r\nout:\r\ndev_kfree_skb_irq(skb);\r\n}

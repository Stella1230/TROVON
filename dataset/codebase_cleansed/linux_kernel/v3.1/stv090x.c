static struct stv090x_dev *find_dev(struct i2c_adapter *i2c_adap,\r\nu8 i2c_addr)\r\n{\r\nstruct stv090x_dev *temp_dev = stv090x_first_dev;\r\nwhile ((temp_dev != NULL) &&\r\n((temp_dev->internal->i2c_adap != i2c_adap) ||\r\n(temp_dev->internal->i2c_addr != i2c_addr))) {\r\ntemp_dev = temp_dev->next_dev;\r\n}\r\nreturn temp_dev;\r\n}\r\nstatic void remove_dev(struct stv090x_internal *internal)\r\n{\r\nstruct stv090x_dev *prev_dev = stv090x_first_dev;\r\nstruct stv090x_dev *del_dev = find_dev(internal->i2c_adap,\r\ninternal->i2c_addr);\r\nif (del_dev != NULL) {\r\nif (del_dev == stv090x_first_dev) {\r\nstv090x_first_dev = del_dev->next_dev;\r\n} else {\r\nwhile (prev_dev->next_dev != del_dev)\r\nprev_dev = prev_dev->next_dev;\r\nprev_dev->next_dev = del_dev->next_dev;\r\n}\r\nkfree(del_dev);\r\n}\r\n}\r\nstatic struct stv090x_dev *append_internal(struct stv090x_internal *internal)\r\n{\r\nstruct stv090x_dev *new_dev;\r\nstruct stv090x_dev *temp_dev;\r\nnew_dev = kmalloc(sizeof(struct stv090x_dev), GFP_KERNEL);\r\nif (new_dev != NULL) {\r\nnew_dev->internal = internal;\r\nnew_dev->next_dev = NULL;\r\nif (stv090x_first_dev == NULL) {\r\nstv090x_first_dev = new_dev;\r\n} else {\r\ntemp_dev = stv090x_first_dev;\r\nwhile (temp_dev->next_dev != NULL)\r\ntemp_dev = temp_dev->next_dev;\r\ntemp_dev->next_dev = new_dev;\r\n}\r\n}\r\nreturn new_dev;\r\n}\r\nstatic inline s32 comp2(s32 __x, s32 __width)\r\n{\r\nif (__width == 32)\r\nreturn __x;\r\nelse\r\nreturn (__x >= (1 << (__width - 1))) ? (__x - (1 << __width)) : __x;\r\n}\r\nstatic int stv090x_read_reg(struct stv090x_state *state, unsigned int reg)\r\n{\r\nconst struct stv090x_config *config = state->config;\r\nint ret;\r\nu8 b0[] = { reg >> 8, reg & 0xff };\r\nu8 buf;\r\nstruct i2c_msg msg[] = {\r\n{ .addr = config->address, .flags = 0, .buf = b0, .len = 2 },\r\n{ .addr = config->address, .flags = I2C_M_RD, .buf = &buf, .len = 1 }\r\n};\r\nret = i2c_transfer(state->i2c, msg, 2);\r\nif (ret != 2) {\r\nif (ret != -ERESTARTSYS)\r\ndprintk(FE_ERROR, 1,\r\n"Read error, Reg=[0x%02x], Status=%d",\r\nreg, ret);\r\nreturn ret < 0 ? ret : -EREMOTEIO;\r\n}\r\nif (unlikely(*state->verbose >= FE_DEBUGREG))\r\ndprintk(FE_ERROR, 1, "Reg=[0x%02x], data=%02x",\r\nreg, buf);\r\nreturn (unsigned int) buf;\r\n}\r\nstatic int stv090x_write_regs(struct stv090x_state *state, unsigned int reg, u8 *data, u32 count)\r\n{\r\nconst struct stv090x_config *config = state->config;\r\nint ret;\r\nu8 buf[2 + count];\r\nstruct i2c_msg i2c_msg = { .addr = config->address, .flags = 0, .buf = buf, .len = 2 + count };\r\nbuf[0] = reg >> 8;\r\nbuf[1] = reg & 0xff;\r\nmemcpy(&buf[2], data, count);\r\nif (unlikely(*state->verbose >= FE_DEBUGREG)) {\r\nint i;\r\nprintk(KERN_DEBUG "%s [0x%04x]:", __func__, reg);\r\nfor (i = 0; i < count; i++)\r\nprintk(" %02x", data[i]);\r\nprintk("\n");\r\n}\r\nret = i2c_transfer(state->i2c, &i2c_msg, 1);\r\nif (ret != 1) {\r\nif (ret != -ERESTARTSYS)\r\ndprintk(FE_ERROR, 1, "Reg=[0x%04x], Data=[0x%02x ...], Count=%u, Status=%d",\r\nreg, data[0], count, ret);\r\nreturn ret < 0 ? ret : -EREMOTEIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int stv090x_write_reg(struct stv090x_state *state, unsigned int reg, u8 data)\r\n{\r\nreturn stv090x_write_regs(state, reg, &data, 1);\r\n}\r\nstatic int stv090x_i2c_gate_ctrl(struct stv090x_state *state, int enable)\r\n{\r\nu32 reg;\r\nif (enable) {\r\nif (state->config->tuner_i2c_lock)\r\nstate->config->tuner_i2c_lock(&state->frontend, 1);\r\nelse\r\nmutex_lock(&state->internal->tuner_lock);\r\n}\r\nreg = STV090x_READ_DEMOD(state, I2CRPT);\r\nif (enable) {\r\ndprintk(FE_DEBUG, 1, "Enable Gate");\r\nSTV090x_SETFIELD_Px(reg, I2CT_ON_FIELD, 1);\r\nif (STV090x_WRITE_DEMOD(state, I2CRPT, reg) < 0)\r\ngoto err;\r\n} else {\r\ndprintk(FE_DEBUG, 1, "Disable Gate");\r\nSTV090x_SETFIELD_Px(reg, I2CT_ON_FIELD, 0);\r\nif ((STV090x_WRITE_DEMOD(state, I2CRPT, reg)) < 0)\r\ngoto err;\r\n}\r\nif (!enable) {\r\nif (state->config->tuner_i2c_lock)\r\nstate->config->tuner_i2c_lock(&state->frontend, 0);\r\nelse\r\nmutex_unlock(&state->internal->tuner_lock);\r\n}\r\nreturn 0;\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nif (state->config->tuner_i2c_lock)\r\nstate->config->tuner_i2c_lock(&state->frontend, 0);\r\nelse\r\nmutex_unlock(&state->internal->tuner_lock);\r\nreturn -1;\r\n}\r\nstatic void stv090x_get_lock_tmg(struct stv090x_state *state)\r\n{\r\nswitch (state->algo) {\r\ncase STV090x_BLIND_SEARCH:\r\ndprintk(FE_DEBUG, 1, "Blind Search");\r\nif (state->srate <= 1500000) {\r\nstate->DemodTimeout = 1500;\r\nstate->FecTimeout = 400;\r\n} else if (state->srate <= 5000000) {\r\nstate->DemodTimeout = 1000;\r\nstate->FecTimeout = 300;\r\n} else {\r\nstate->DemodTimeout = 700;\r\nstate->FecTimeout = 100;\r\n}\r\nbreak;\r\ncase STV090x_COLD_SEARCH:\r\ncase STV090x_WARM_SEARCH:\r\ndefault:\r\ndprintk(FE_DEBUG, 1, "Normal Search");\r\nif (state->srate <= 1000000) {\r\nstate->DemodTimeout = 4500;\r\nstate->FecTimeout = 1700;\r\n} else if (state->srate <= 2000000) {\r\nstate->DemodTimeout = 2500;\r\nstate->FecTimeout = 1100;\r\n} else if (state->srate <= 5000000) {\r\nstate->DemodTimeout = 1000;\r\nstate->FecTimeout = 550;\r\n} else if (state->srate <= 10000000) {\r\nstate->DemodTimeout = 700;\r\nstate->FecTimeout = 250;\r\n} else if (state->srate <= 20000000) {\r\nstate->DemodTimeout = 400;\r\nstate->FecTimeout = 130;\r\n} else {\r\nstate->DemodTimeout = 300;\r\nstate->FecTimeout = 100;\r\n}\r\nbreak;\r\n}\r\nif (state->algo == STV090x_WARM_SEARCH)\r\nstate->DemodTimeout /= 2;\r\n}\r\nstatic int stv090x_set_srate(struct stv090x_state *state, u32 srate)\r\n{\r\nu32 sym;\r\nif (srate > 60000000) {\r\nsym = (srate << 4);\r\nsym /= (state->internal->mclk >> 12);\r\n} else if (srate > 6000000) {\r\nsym = (srate << 6);\r\nsym /= (state->internal->mclk >> 10);\r\n} else {\r\nsym = (srate << 9);\r\nsym /= (state->internal->mclk >> 7);\r\n}\r\nif (STV090x_WRITE_DEMOD(state, SFRINIT1, (sym >> 8) & 0x7f) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, SFRINIT0, (sym & 0xff)) < 0)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic int stv090x_set_max_srate(struct stv090x_state *state, u32 clk, u32 srate)\r\n{\r\nu32 sym;\r\nsrate = 105 * (srate / 100);\r\nif (srate > 60000000) {\r\nsym = (srate << 4);\r\nsym /= (state->internal->mclk >> 12);\r\n} else if (srate > 6000000) {\r\nsym = (srate << 6);\r\nsym /= (state->internal->mclk >> 10);\r\n} else {\r\nsym = (srate << 9);\r\nsym /= (state->internal->mclk >> 7);\r\n}\r\nif (sym < 0x7fff) {\r\nif (STV090x_WRITE_DEMOD(state, SFRUP1, (sym >> 8) & 0x7f) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, SFRUP0, sym & 0xff) < 0)\r\ngoto err;\r\n} else {\r\nif (STV090x_WRITE_DEMOD(state, SFRUP1, 0x7f) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, SFRUP0, 0xff) < 0)\r\ngoto err;\r\n}\r\nreturn 0;\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic int stv090x_set_min_srate(struct stv090x_state *state, u32 clk, u32 srate)\r\n{\r\nu32 sym;\r\nsrate = 95 * (srate / 100);\r\nif (srate > 60000000) {\r\nsym = (srate << 4);\r\nsym /= (state->internal->mclk >> 12);\r\n} else if (srate > 6000000) {\r\nsym = (srate << 6);\r\nsym /= (state->internal->mclk >> 10);\r\n} else {\r\nsym = (srate << 9);\r\nsym /= (state->internal->mclk >> 7);\r\n}\r\nif (STV090x_WRITE_DEMOD(state, SFRLOW1, ((sym >> 8) & 0x7f)) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, SFRLOW0, (sym & 0xff)) < 0)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic u32 stv090x_car_width(u32 srate, enum stv090x_rolloff rolloff)\r\n{\r\nu32 ro;\r\nswitch (rolloff) {\r\ncase STV090x_RO_20:\r\nro = 20;\r\nbreak;\r\ncase STV090x_RO_25:\r\nro = 25;\r\nbreak;\r\ncase STV090x_RO_35:\r\ndefault:\r\nro = 35;\r\nbreak;\r\n}\r\nreturn srate + (srate * ro) / 100;\r\n}\r\nstatic int stv090x_set_vit_thacq(struct stv090x_state *state)\r\n{\r\nif (STV090x_WRITE_DEMOD(state, VTH12, 0x96) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, VTH23, 0x64) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, VTH34, 0x36) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, VTH56, 0x23) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, VTH67, 0x1e) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, VTH78, 0x19) < 0)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic int stv090x_set_vit_thtracq(struct stv090x_state *state)\r\n{\r\nif (STV090x_WRITE_DEMOD(state, VTH12, 0xd0) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, VTH23, 0x7d) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, VTH34, 0x53) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, VTH56, 0x2f) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, VTH67, 0x24) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, VTH78, 0x1f) < 0)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic int stv090x_set_viterbi(struct stv090x_state *state)\r\n{\r\nswitch (state->search_mode) {\r\ncase STV090x_SEARCH_AUTO:\r\nif (STV090x_WRITE_DEMOD(state, FECM, 0x10) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, PRVIT, 0x3f) < 0)\r\ngoto err;\r\nbreak;\r\ncase STV090x_SEARCH_DVBS1:\r\nif (STV090x_WRITE_DEMOD(state, FECM, 0x00) < 0)\r\ngoto err;\r\nswitch (state->fec) {\r\ncase STV090x_PR12:\r\nif (STV090x_WRITE_DEMOD(state, PRVIT, 0x01) < 0)\r\ngoto err;\r\nbreak;\r\ncase STV090x_PR23:\r\nif (STV090x_WRITE_DEMOD(state, PRVIT, 0x02) < 0)\r\ngoto err;\r\nbreak;\r\ncase STV090x_PR34:\r\nif (STV090x_WRITE_DEMOD(state, PRVIT, 0x04) < 0)\r\ngoto err;\r\nbreak;\r\ncase STV090x_PR56:\r\nif (STV090x_WRITE_DEMOD(state, PRVIT, 0x08) < 0)\r\ngoto err;\r\nbreak;\r\ncase STV090x_PR78:\r\nif (STV090x_WRITE_DEMOD(state, PRVIT, 0x20) < 0)\r\ngoto err;\r\nbreak;\r\ndefault:\r\nif (STV090x_WRITE_DEMOD(state, PRVIT, 0x2f) < 0)\r\ngoto err;\r\nbreak;\r\n}\r\nbreak;\r\ncase STV090x_SEARCH_DSS:\r\nif (STV090x_WRITE_DEMOD(state, FECM, 0x80) < 0)\r\ngoto err;\r\nswitch (state->fec) {\r\ncase STV090x_PR12:\r\nif (STV090x_WRITE_DEMOD(state, PRVIT, 0x01) < 0)\r\ngoto err;\r\nbreak;\r\ncase STV090x_PR23:\r\nif (STV090x_WRITE_DEMOD(state, PRVIT, 0x02) < 0)\r\ngoto err;\r\nbreak;\r\ncase STV090x_PR67:\r\nif (STV090x_WRITE_DEMOD(state, PRVIT, 0x10) < 0)\r\ngoto err;\r\nbreak;\r\ndefault:\r\nif (STV090x_WRITE_DEMOD(state, PRVIT, 0x13) < 0)\r\ngoto err;\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic int stv090x_stop_modcod(struct stv090x_state *state)\r\n{\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST0, 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST1, 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST2, 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST3, 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST4, 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST5, 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST6, 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST7, 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST8, 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST9, 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLSTA, 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLSTB, 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLSTC, 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLSTD, 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLSTE, 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLSTF, 0xff) < 0)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic int stv090x_activate_modcod(struct stv090x_state *state)\r\n{\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST0, 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST1, 0xfc) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST2, 0xcc) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST3, 0xcc) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST4, 0xcc) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST5, 0xcc) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST6, 0xcc) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST7, 0xcc) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST8, 0xcc) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST9, 0xcc) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLSTA, 0xcc) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLSTB, 0xcc) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLSTC, 0xcc) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLSTD, 0xcc) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLSTE, 0xcc) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLSTF, 0xcf) < 0)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic int stv090x_activate_modcod_single(struct stv090x_state *state)\r\n{\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST0, 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST1, 0xf0) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST2, 0x00) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST3, 0x00) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST4, 0x00) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST5, 0x00) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST6, 0x00) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST7, 0x00) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST8, 0x00) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST9, 0x00) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLSTA, 0x00) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLSTB, 0x00) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLSTC, 0x00) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLSTD, 0x00) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLSTE, 0x00) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLSTF, 0x0f) < 0)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic int stv090x_vitclk_ctl(struct stv090x_state *state, int enable)\r\n{\r\nu32 reg;\r\nswitch (state->demod) {\r\ncase STV090x_DEMODULATOR_0:\r\nmutex_lock(&state->internal->demod_lock);\r\nreg = stv090x_read_reg(state, STV090x_STOPCLK2);\r\nSTV090x_SETFIELD(reg, STOP_CLKVIT1_FIELD, enable);\r\nif (stv090x_write_reg(state, STV090x_STOPCLK2, reg) < 0)\r\ngoto err;\r\nmutex_unlock(&state->internal->demod_lock);\r\nbreak;\r\ncase STV090x_DEMODULATOR_1:\r\nmutex_lock(&state->internal->demod_lock);\r\nreg = stv090x_read_reg(state, STV090x_STOPCLK2);\r\nSTV090x_SETFIELD(reg, STOP_CLKVIT2_FIELD, enable);\r\nif (stv090x_write_reg(state, STV090x_STOPCLK2, reg) < 0)\r\ngoto err;\r\nmutex_unlock(&state->internal->demod_lock);\r\nbreak;\r\ndefault:\r\ndprintk(FE_ERROR, 1, "Wrong demodulator!");\r\nbreak;\r\n}\r\nreturn 0;\r\nerr:\r\nmutex_unlock(&state->internal->demod_lock);\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic int stv090x_dvbs_track_crl(struct stv090x_state *state)\r\n{\r\nif (state->internal->dev_ver >= 0x30) {\r\nif (state->srate >= 15000000) {\r\nif (STV090x_WRITE_DEMOD(state, ACLC, 0x2b) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, BCLC, 0x1a) < 0)\r\ngoto err;\r\n} else if ((state->srate >= 7000000) && (15000000 > state->srate)) {\r\nif (STV090x_WRITE_DEMOD(state, ACLC, 0x0c) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, BCLC, 0x1b) < 0)\r\ngoto err;\r\n} else if (state->srate < 7000000) {\r\nif (STV090x_WRITE_DEMOD(state, ACLC, 0x2c) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, BCLC, 0x1c) < 0)\r\ngoto err;\r\n}\r\n} else {\r\nif (STV090x_WRITE_DEMOD(state, ACLC, 0x1a) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, BCLC, 0x09) < 0)\r\ngoto err;\r\n}\r\nreturn 0;\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic int stv090x_delivery_search(struct stv090x_state *state)\r\n{\r\nu32 reg;\r\nswitch (state->search_mode) {\r\ncase STV090x_SEARCH_DVBS1:\r\ncase STV090x_SEARCH_DSS:\r\nreg = STV090x_READ_DEMOD(state, DMDCFGMD);\r\nSTV090x_SETFIELD_Px(reg, DVBS1_ENABLE_FIELD, 1);\r\nSTV090x_SETFIELD_Px(reg, DVBS2_ENABLE_FIELD, 0);\r\nif (STV090x_WRITE_DEMOD(state, DMDCFGMD, reg) < 0)\r\ngoto err;\r\nif (stv090x_vitclk_ctl(state, 0) < 0)\r\ngoto err;\r\nif (stv090x_dvbs_track_crl(state) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CAR2CFG, 0x22) < 0)\r\ngoto err;\r\nif (stv090x_set_vit_thacq(state) < 0)\r\ngoto err;\r\nif (stv090x_set_viterbi(state) < 0)\r\ngoto err;\r\nbreak;\r\ncase STV090x_SEARCH_DVBS2:\r\nreg = STV090x_READ_DEMOD(state, DMDCFGMD);\r\nSTV090x_SETFIELD_Px(reg, DVBS1_ENABLE_FIELD, 0);\r\nSTV090x_SETFIELD_Px(reg, DVBS2_ENABLE_FIELD, 0);\r\nif (STV090x_WRITE_DEMOD(state, DMDCFGMD, reg) < 0)\r\ngoto err;\r\nSTV090x_SETFIELD_Px(reg, DVBS1_ENABLE_FIELD, 1);\r\nSTV090x_SETFIELD_Px(reg, DVBS2_ENABLE_FIELD, 1);\r\nif (STV090x_WRITE_DEMOD(state, DMDCFGMD, reg) < 0)\r\ngoto err;\r\nif (stv090x_vitclk_ctl(state, 1) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, ACLC, 0x1a) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, BCLC, 0x09) < 0)\r\ngoto err;\r\nif (state->internal->dev_ver <= 0x20) {\r\nif (STV090x_WRITE_DEMOD(state, CAR2CFG, 0x26) < 0)\r\ngoto err;\r\n} else {\r\nif (STV090x_WRITE_DEMOD(state, CAR2CFG, 0x66) < 0)\r\ngoto err;\r\n}\r\nif (state->demod_mode != STV090x_SINGLE) {\r\nif (stv090x_activate_modcod(state) < 0)\r\ngoto err;\r\n} else {\r\nif (stv090x_activate_modcod_single(state) < 0)\r\ngoto err;\r\n}\r\nif (stv090x_set_vit_thtracq(state) < 0)\r\ngoto err;\r\nbreak;\r\ncase STV090x_SEARCH_AUTO:\r\ndefault:\r\nreg = STV090x_READ_DEMOD(state, DMDCFGMD);\r\nSTV090x_SETFIELD_Px(reg, DVBS1_ENABLE_FIELD, 0);\r\nSTV090x_SETFIELD_Px(reg, DVBS2_ENABLE_FIELD, 0);\r\nif (STV090x_WRITE_DEMOD(state, DMDCFGMD, reg) < 0)\r\ngoto err;\r\nSTV090x_SETFIELD_Px(reg, DVBS1_ENABLE_FIELD, 1);\r\nSTV090x_SETFIELD_Px(reg, DVBS2_ENABLE_FIELD, 1);\r\nif (STV090x_WRITE_DEMOD(state, DMDCFGMD, reg) < 0)\r\ngoto err;\r\nif (stv090x_vitclk_ctl(state, 0) < 0)\r\ngoto err;\r\nif (stv090x_dvbs_track_crl(state) < 0)\r\ngoto err;\r\nif (state->internal->dev_ver <= 0x20) {\r\nif (STV090x_WRITE_DEMOD(state, CAR2CFG, 0x26) < 0)\r\ngoto err;\r\n} else {\r\nif (STV090x_WRITE_DEMOD(state, CAR2CFG, 0x66) < 0)\r\ngoto err;\r\n}\r\nif (state->demod_mode != STV090x_SINGLE) {\r\nif (stv090x_activate_modcod(state) < 0)\r\ngoto err;\r\n} else {\r\nif (stv090x_activate_modcod_single(state) < 0)\r\ngoto err;\r\n}\r\nif (stv090x_set_vit_thacq(state) < 0)\r\ngoto err;\r\nif (stv090x_set_viterbi(state) < 0)\r\ngoto err;\r\nbreak;\r\n}\r\nreturn 0;\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic int stv090x_start_search(struct stv090x_state *state)\r\n{\r\nu32 reg, freq_abs;\r\ns16 freq;\r\nreg = STV090x_READ_DEMOD(state, DMDISTATE);\r\nSTV090x_SETFIELD_Px(reg, I2C_DEMOD_MODE_FIELD, 0x1f);\r\nif (STV090x_WRITE_DEMOD(state, DMDISTATE, reg) < 0)\r\ngoto err;\r\nif (state->internal->dev_ver <= 0x20) {\r\nif (state->srate <= 5000000) {\r\nif (STV090x_WRITE_DEMOD(state, CARCFG, 0x44) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CFRUP1, 0x0f) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CFRUP0, 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CFRLOW1, 0xf0) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CFRLOW0, 0x00) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, RTCS2, 0x68) < 0)\r\ngoto err;\r\n} else {\r\nif (STV090x_WRITE_DEMOD(state, CARCFG, 0xc4) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, RTCS2, 0x44) < 0)\r\ngoto err;\r\n}\r\n} else {\r\nif (state->srate <= 5000000) {\r\nSTV090x_WRITE_DEMOD(state, RTCS2, 0x68);\r\n} else {\r\nSTV090x_WRITE_DEMOD(state, RTCS2, 0x44);\r\n}\r\nSTV090x_WRITE_DEMOD(state, CARCFG, 0x46);\r\nif (state->algo == STV090x_WARM_SEARCH) {\r\nfreq_abs = 1000 << 16;\r\nfreq_abs /= (state->internal->mclk / 1000);\r\nfreq = (s16) freq_abs;\r\n} else {\r\nfreq_abs = (state->search_range / 2000) + 600;\r\nfreq_abs = freq_abs << 16;\r\nfreq_abs /= (state->internal->mclk / 1000);\r\nfreq = (s16) freq_abs;\r\n}\r\nif (STV090x_WRITE_DEMOD(state, CFRUP1, MSB(freq)) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CFRUP0, LSB(freq)) < 0)\r\ngoto err;\r\nfreq *= -1;\r\nif (STV090x_WRITE_DEMOD(state, CFRLOW1, MSB(freq)) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CFRLOW0, LSB(freq)) < 0)\r\ngoto err;\r\n}\r\nif (STV090x_WRITE_DEMOD(state, CFRINIT1, 0) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CFRINIT0, 0) < 0)\r\ngoto err;\r\nif (state->internal->dev_ver >= 0x20) {\r\nif (STV090x_WRITE_DEMOD(state, EQUALCFG, 0x41) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, FFECFG, 0x41) < 0)\r\ngoto err;\r\nif ((state->search_mode == STV090x_SEARCH_DVBS1) ||\r\n(state->search_mode == STV090x_SEARCH_DSS) ||\r\n(state->search_mode == STV090x_SEARCH_AUTO)) {\r\nif (STV090x_WRITE_DEMOD(state, VITSCALE, 0x82) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, VAVSRVIT, 0x00) < 0)\r\ngoto err;\r\n}\r\n}\r\nif (STV090x_WRITE_DEMOD(state, SFRSTEP, 0x00) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, TMGTHRISE, 0xe0) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, TMGTHFALL, 0xc0) < 0)\r\ngoto err;\r\nreg = STV090x_READ_DEMOD(state, DMDCFGMD);\r\nSTV090x_SETFIELD_Px(reg, SCAN_ENABLE_FIELD, 0);\r\nSTV090x_SETFIELD_Px(reg, CFR_AUTOSCAN_FIELD, 0);\r\nif (STV090x_WRITE_DEMOD(state, DMDCFGMD, reg) < 0)\r\ngoto err;\r\nreg = STV090x_READ_DEMOD(state, DMDCFG2);\r\nSTV090x_SETFIELD_Px(reg, S1S2_SEQUENTIAL_FIELD, 0x0);\r\nif (STV090x_WRITE_DEMOD(state, DMDCFG2, reg) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, RTC, 0x88) < 0)\r\ngoto err;\r\nif (state->internal->dev_ver >= 0x20) {\r\nif (state->srate < 2000000) {\r\nif (state->internal->dev_ver <= 0x20) {\r\nif (STV090x_WRITE_DEMOD(state, CARFREQ, 0x39) < 0)\r\ngoto err;\r\n} else {\r\nif (STV090x_WRITE_DEMOD(state, CARFREQ, 0x89) < 0)\r\ngoto err;\r\n}\r\nif (STV090x_WRITE_DEMOD(state, CARHDR, 0x40) < 0)\r\ngoto err;\r\n} else if (state->srate < 10000000) {\r\nif (STV090x_WRITE_DEMOD(state, CARFREQ, 0x4c) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CARHDR, 0x20) < 0)\r\ngoto err;\r\n} else {\r\nif (STV090x_WRITE_DEMOD(state, CARFREQ, 0x4b) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CARHDR, 0x20) < 0)\r\ngoto err;\r\n}\r\n} else {\r\nif (state->srate < 10000000) {\r\nif (STV090x_WRITE_DEMOD(state, CARFREQ, 0xef) < 0)\r\ngoto err;\r\n} else {\r\nif (STV090x_WRITE_DEMOD(state, CARFREQ, 0xed) < 0)\r\ngoto err;\r\n}\r\n}\r\nswitch (state->algo) {\r\ncase STV090x_WARM_SEARCH:\r\nif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x1f) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x18) < 0)\r\ngoto err;\r\nbreak;\r\ncase STV090x_COLD_SEARCH:\r\nif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x1f) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x15) < 0)\r\ngoto err;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic int stv090x_get_agc2_min_level(struct stv090x_state *state)\r\n{\r\nu32 agc2_min = 0xffff, agc2 = 0, freq_init, freq_step, reg;\r\ns32 i, j, steps, dir;\r\nif (STV090x_WRITE_DEMOD(state, AGC2REF, 0x38) < 0)\r\ngoto err;\r\nreg = STV090x_READ_DEMOD(state, DMDCFGMD);\r\nSTV090x_SETFIELD_Px(reg, SCAN_ENABLE_FIELD, 0);\r\nSTV090x_SETFIELD_Px(reg, CFR_AUTOSCAN_FIELD, 0);\r\nif (STV090x_WRITE_DEMOD(state, DMDCFGMD, reg) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, SFRUP1, 0x83) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, SFRUP0, 0xc0) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, SFRLOW1, 0x82) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, SFRLOW0, 0xa0) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, DMDTOM, 0x00) < 0)\r\ngoto err;\r\nif (stv090x_set_srate(state, 1000000) < 0)\r\ngoto err;\r\nsteps = state->search_range / 1000000;\r\nif (steps <= 0)\r\nsteps = 1;\r\ndir = 1;\r\nfreq_step = (1000000 * 256) / (state->internal->mclk / 256);\r\nfreq_init = 0;\r\nfor (i = 0; i < steps; i++) {\r\nif (dir > 0)\r\nfreq_init = freq_init + (freq_step * i);\r\nelse\r\nfreq_init = freq_init - (freq_step * i);\r\ndir *= -1;\r\nif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x5c) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CFRINIT1, (freq_init >> 8) & 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CFRINIT0, freq_init & 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x58) < 0)\r\ngoto err;\r\nmsleep(10);\r\nagc2 = 0;\r\nfor (j = 0; j < 10; j++) {\r\nagc2 += (STV090x_READ_DEMOD(state, AGC2I1) << 8) |\r\nSTV090x_READ_DEMOD(state, AGC2I0);\r\n}\r\nagc2 /= 10;\r\nif (agc2 < agc2_min)\r\nagc2_min = agc2;\r\n}\r\nreturn agc2_min;\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic u32 stv090x_get_srate(struct stv090x_state *state, u32 clk)\r\n{\r\nu8 r3, r2, r1, r0;\r\ns32 srate, int_1, int_2, tmp_1, tmp_2;\r\nr3 = STV090x_READ_DEMOD(state, SFR3);\r\nr2 = STV090x_READ_DEMOD(state, SFR2);\r\nr1 = STV090x_READ_DEMOD(state, SFR1);\r\nr0 = STV090x_READ_DEMOD(state, SFR0);\r\nsrate = ((r3 << 24) | (r2 << 16) | (r1 << 8) | r0);\r\nint_1 = clk >> 16;\r\nint_2 = srate >> 16;\r\ntmp_1 = clk % 0x10000;\r\ntmp_2 = srate % 0x10000;\r\nsrate = (int_1 * int_2) +\r\n((int_1 * tmp_2) >> 16) +\r\n((int_2 * tmp_1) >> 16);\r\nreturn srate;\r\n}\r\nstatic u32 stv090x_srate_srch_coarse(struct stv090x_state *state)\r\n{\r\nstruct dvb_frontend *fe = &state->frontend;\r\nint tmg_lock = 0, i;\r\ns32 tmg_cpt = 0, dir = 1, steps, cur_step = 0, freq;\r\nu32 srate_coarse = 0, agc2 = 0, car_step = 1200, reg;\r\nu32 agc2th;\r\nif (state->internal->dev_ver >= 0x30)\r\nagc2th = 0x2e00;\r\nelse\r\nagc2th = 0x1f00;\r\nreg = STV090x_READ_DEMOD(state, DMDISTATE);\r\nSTV090x_SETFIELD_Px(reg, I2C_DEMOD_MODE_FIELD, 0x1f);\r\nif (STV090x_WRITE_DEMOD(state, DMDISTATE, reg) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, TMGCFG, 0x12) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, TMGCFG2, 0xc0) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, TMGTHRISE, 0xf0) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, TMGTHFALL, 0xe0) < 0)\r\ngoto err;\r\nreg = STV090x_READ_DEMOD(state, DMDCFGMD);\r\nSTV090x_SETFIELD_Px(reg, SCAN_ENABLE_FIELD, 1);\r\nSTV090x_SETFIELD_Px(reg, CFR_AUTOSCAN_FIELD, 0);\r\nif (STV090x_WRITE_DEMOD(state, DMDCFGMD, reg) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, SFRUP1, 0x83) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, SFRUP0, 0xc0) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, SFRLOW1, 0x82) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, SFRLOW0, 0xa0) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, DMDTOM, 0x00) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, AGC2REF, 0x50) < 0)\r\ngoto err;\r\nif (state->internal->dev_ver >= 0x30) {\r\nif (STV090x_WRITE_DEMOD(state, CARFREQ, 0x99) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, SFRSTEP, 0x98) < 0)\r\ngoto err;\r\n} else if (state->internal->dev_ver >= 0x20) {\r\nif (STV090x_WRITE_DEMOD(state, CARFREQ, 0x6a) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, SFRSTEP, 0x95) < 0)\r\ngoto err;\r\n}\r\nif (state->srate <= 2000000)\r\ncar_step = 1000;\r\nelse if (state->srate <= 5000000)\r\ncar_step = 2000;\r\nelse if (state->srate <= 12000000)\r\ncar_step = 3000;\r\nelse\r\ncar_step = 5000;\r\nsteps = -1 + ((state->search_range / 1000) / car_step);\r\nsteps /= 2;\r\nsteps = (2 * steps) + 1;\r\nif (steps < 0)\r\nsteps = 1;\r\nelse if (steps > 10) {\r\nsteps = 11;\r\ncar_step = (state->search_range / 1000) / 10;\r\n}\r\ncur_step = 0;\r\ndir = 1;\r\nfreq = state->frequency;\r\nwhile ((!tmg_lock) && (cur_step < steps)) {\r\nif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x5f) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CFRINIT1, 0x00) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CFRINIT0, 0x00) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, SFRINIT1, 0x00) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, SFRINIT0, 0x00) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x40) < 0)\r\ngoto err;\r\nmsleep(50);\r\nfor (i = 0; i < 10; i++) {\r\nreg = STV090x_READ_DEMOD(state, DSTATUS);\r\nif (STV090x_GETFIELD_Px(reg, TMGLOCK_QUALITY_FIELD) >= 2)\r\ntmg_cpt++;\r\nagc2 += (STV090x_READ_DEMOD(state, AGC2I1) << 8) |\r\nSTV090x_READ_DEMOD(state, AGC2I0);\r\n}\r\nagc2 /= 10;\r\nsrate_coarse = stv090x_get_srate(state, state->internal->mclk);\r\ncur_step++;\r\ndir *= -1;\r\nif ((tmg_cpt >= 5) && (agc2 < agc2th) &&\r\n(srate_coarse < 50000000) && (srate_coarse > 850000))\r\ntmg_lock = 1;\r\nelse if (cur_step < steps) {\r\nif (dir > 0)\r\nfreq += cur_step * car_step;\r\nelse\r\nfreq -= cur_step * car_step;\r\nif (stv090x_i2c_gate_ctrl(state, 1) < 0)\r\ngoto err;\r\nif (state->config->tuner_set_frequency) {\r\nif (state->config->tuner_set_frequency(fe, freq) < 0)\r\ngoto err_gateoff;\r\n}\r\nif (state->config->tuner_set_bandwidth) {\r\nif (state->config->tuner_set_bandwidth(fe, state->tuner_bw) < 0)\r\ngoto err_gateoff;\r\n}\r\nif (stv090x_i2c_gate_ctrl(state, 0) < 0)\r\ngoto err;\r\nmsleep(50);\r\nif (stv090x_i2c_gate_ctrl(state, 1) < 0)\r\ngoto err;\r\nif (state->config->tuner_get_status) {\r\nif (state->config->tuner_get_status(fe, &reg) < 0)\r\ngoto err_gateoff;\r\n}\r\nif (reg)\r\ndprintk(FE_DEBUG, 1, "Tuner phase locked");\r\nelse\r\ndprintk(FE_DEBUG, 1, "Tuner unlocked");\r\nif (stv090x_i2c_gate_ctrl(state, 0) < 0)\r\ngoto err;\r\n}\r\n}\r\nif (!tmg_lock)\r\nsrate_coarse = 0;\r\nelse\r\nsrate_coarse = stv090x_get_srate(state, state->internal->mclk);\r\nreturn srate_coarse;\r\nerr_gateoff:\r\nstv090x_i2c_gate_ctrl(state, 0);\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic u32 stv090x_srate_srch_fine(struct stv090x_state *state)\r\n{\r\nu32 srate_coarse, freq_coarse, sym, reg;\r\nsrate_coarse = stv090x_get_srate(state, state->internal->mclk);\r\nfreq_coarse = STV090x_READ_DEMOD(state, CFR2) << 8;\r\nfreq_coarse |= STV090x_READ_DEMOD(state, CFR1);\r\nsym = 13 * (srate_coarse / 10);\r\nif (sym < state->srate)\r\nsrate_coarse = 0;\r\nelse {\r\nif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x1f) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, TMGCFG2, 0xc1) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, TMGTHRISE, 0x20) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, TMGTHFALL, 0x00) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, TMGCFG, 0xd2) < 0)\r\ngoto err;\r\nreg = STV090x_READ_DEMOD(state, DMDCFGMD);\r\nSTV090x_SETFIELD_Px(reg, CFR_AUTOSCAN_FIELD, 0x00);\r\nif (STV090x_WRITE_DEMOD(state, DMDCFGMD, reg) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, AGC2REF, 0x38) < 0)\r\ngoto err;\r\nif (state->internal->dev_ver >= 0x30) {\r\nif (STV090x_WRITE_DEMOD(state, CARFREQ, 0x79) < 0)\r\ngoto err;\r\n} else if (state->internal->dev_ver >= 0x20) {\r\nif (STV090x_WRITE_DEMOD(state, CARFREQ, 0x49) < 0)\r\ngoto err;\r\n}\r\nif (srate_coarse > 3000000) {\r\nsym = 13 * (srate_coarse / 10);\r\nsym = (sym / 1000) * 65536;\r\nsym /= (state->internal->mclk / 1000);\r\nif (STV090x_WRITE_DEMOD(state, SFRUP1, (sym >> 8) & 0x7f) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, SFRUP0, sym & 0xff) < 0)\r\ngoto err;\r\nsym = 10 * (srate_coarse / 13);\r\nsym = (sym / 1000) * 65536;\r\nsym /= (state->internal->mclk / 1000);\r\nif (STV090x_WRITE_DEMOD(state, SFRLOW1, (sym >> 8) & 0x7f) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, SFRLOW0, sym & 0xff) < 0)\r\ngoto err;\r\nsym = (srate_coarse / 1000) * 65536;\r\nsym /= (state->internal->mclk / 1000);\r\nif (STV090x_WRITE_DEMOD(state, SFRINIT1, (sym >> 8) & 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, SFRINIT0, sym & 0xff) < 0)\r\ngoto err;\r\n} else {\r\nsym = 13 * (srate_coarse / 10);\r\nsym = (sym / 100) * 65536;\r\nsym /= (state->internal->mclk / 100);\r\nif (STV090x_WRITE_DEMOD(state, SFRUP1, (sym >> 8) & 0x7f) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, SFRUP0, sym & 0xff) < 0)\r\ngoto err;\r\nsym = 10 * (srate_coarse / 14);\r\nsym = (sym / 100) * 65536;\r\nsym /= (state->internal->mclk / 100);\r\nif (STV090x_WRITE_DEMOD(state, SFRLOW1, (sym >> 8) & 0x7f) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, SFRLOW0, sym & 0xff) < 0)\r\ngoto err;\r\nsym = (srate_coarse / 100) * 65536;\r\nsym /= (state->internal->mclk / 100);\r\nif (STV090x_WRITE_DEMOD(state, SFRINIT1, (sym >> 8) & 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, SFRINIT0, sym & 0xff) < 0)\r\ngoto err;\r\n}\r\nif (STV090x_WRITE_DEMOD(state, DMDTOM, 0x20) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CFRINIT1, (freq_coarse >> 8) & 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CFRINIT0, freq_coarse & 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x15) < 0)\r\ngoto err;\r\n}\r\nreturn srate_coarse;\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic int stv090x_get_dmdlock(struct stv090x_state *state, s32 timeout)\r\n{\r\ns32 timer = 0, lock = 0;\r\nu32 reg;\r\nu8 stat;\r\nwhile ((timer < timeout) && (!lock)) {\r\nreg = STV090x_READ_DEMOD(state, DMDSTATE);\r\nstat = STV090x_GETFIELD_Px(reg, HEADER_MODE_FIELD);\r\nswitch (stat) {\r\ncase 0:\r\ncase 1:\r\ndefault:\r\ndprintk(FE_DEBUG, 1, "Demodulator searching ..");\r\nlock = 0;\r\nbreak;\r\ncase 2:\r\ncase 3:\r\nreg = STV090x_READ_DEMOD(state, DSTATUS);\r\nlock = STV090x_GETFIELD_Px(reg, LOCK_DEFINITIF_FIELD);\r\nbreak;\r\n}\r\nif (!lock)\r\nmsleep(10);\r\nelse\r\ndprintk(FE_DEBUG, 1, "Demodulator acquired LOCK");\r\ntimer += 10;\r\n}\r\nreturn lock;\r\n}\r\nstatic int stv090x_blind_search(struct stv090x_state *state)\r\n{\r\nu32 agc2, reg, srate_coarse;\r\ns32 cpt_fail, agc2_ovflw, i;\r\nu8 k_ref, k_max, k_min;\r\nint coarse_fail = 0;\r\nint lock;\r\nk_max = 110;\r\nk_min = 10;\r\nagc2 = stv090x_get_agc2_min_level(state);\r\nif (agc2 > STV090x_SEARCH_AGC2_TH(state->internal->dev_ver)) {\r\nlock = 0;\r\n} else {\r\nif (state->internal->dev_ver <= 0x20) {\r\nif (STV090x_WRITE_DEMOD(state, CARCFG, 0xc4) < 0)\r\ngoto err;\r\n} else {\r\nif (STV090x_WRITE_DEMOD(state, CARCFG, 0x06) < 0)\r\ngoto err;\r\n}\r\nif (STV090x_WRITE_DEMOD(state, RTCS2, 0x44) < 0)\r\ngoto err;\r\nif (state->internal->dev_ver >= 0x20) {\r\nif (STV090x_WRITE_DEMOD(state, EQUALCFG, 0x41) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, FFECFG, 0x41) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, VITSCALE, 0x82) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, VAVSRVIT, 0x00) < 0)\r\ngoto err;\r\n}\r\nk_ref = k_max;\r\ndo {\r\nif (STV090x_WRITE_DEMOD(state, KREFTMG, k_ref) < 0)\r\ngoto err;\r\nif (stv090x_srate_srch_coarse(state) != 0) {\r\nsrate_coarse = stv090x_srate_srch_fine(state);\r\nif (srate_coarse != 0) {\r\nstv090x_get_lock_tmg(state);\r\nlock = stv090x_get_dmdlock(state,\r\nstate->DemodTimeout);\r\n} else {\r\nlock = 0;\r\n}\r\n} else {\r\ncpt_fail = 0;\r\nagc2_ovflw = 0;\r\nfor (i = 0; i < 10; i++) {\r\nagc2 += (STV090x_READ_DEMOD(state, AGC2I1) << 8) |\r\nSTV090x_READ_DEMOD(state, AGC2I0);\r\nif (agc2 >= 0xff00)\r\nagc2_ovflw++;\r\nreg = STV090x_READ_DEMOD(state, DSTATUS2);\r\nif ((STV090x_GETFIELD_Px(reg, CFR_OVERFLOW_FIELD) == 0x01) &&\r\n(STV090x_GETFIELD_Px(reg, DEMOD_DELOCK_FIELD) == 0x01))\r\ncpt_fail++;\r\n}\r\nif ((cpt_fail > 7) || (agc2_ovflw > 7))\r\ncoarse_fail = 1;\r\nlock = 0;\r\n}\r\nk_ref -= 20;\r\n} while ((k_ref >= k_min) && (!lock) && (!coarse_fail));\r\n}\r\nreturn lock;\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic int stv090x_chk_tmg(struct stv090x_state *state)\r\n{\r\nu32 reg;\r\ns32 tmg_cpt = 0, i;\r\nu8 freq, tmg_thh, tmg_thl;\r\nint tmg_lock = 0;\r\nfreq = STV090x_READ_DEMOD(state, CARFREQ);\r\ntmg_thh = STV090x_READ_DEMOD(state, TMGTHRISE);\r\ntmg_thl = STV090x_READ_DEMOD(state, TMGTHFALL);\r\nif (STV090x_WRITE_DEMOD(state, TMGTHRISE, 0x20) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, TMGTHFALL, 0x00) < 0)\r\ngoto err;\r\nreg = STV090x_READ_DEMOD(state, DMDCFGMD);\r\nSTV090x_SETFIELD_Px(reg, CFR_AUTOSCAN_FIELD, 0x00);\r\nif (STV090x_WRITE_DEMOD(state, DMDCFGMD, reg) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, RTC, 0x80) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, RTCS2, 0x40) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CARFREQ, 0x00) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CFRINIT1, 0x00) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CFRINIT0, 0x00) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, AGC2REF, 0x65) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x18) < 0)\r\ngoto err;\r\nmsleep(10);\r\nfor (i = 0; i < 10; i++) {\r\nreg = STV090x_READ_DEMOD(state, DSTATUS);\r\nif (STV090x_GETFIELD_Px(reg, TMGLOCK_QUALITY_FIELD) >= 2)\r\ntmg_cpt++;\r\nmsleep(1);\r\n}\r\nif (tmg_cpt >= 3)\r\ntmg_lock = 1;\r\nif (STV090x_WRITE_DEMOD(state, AGC2REF, 0x38) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, RTC, 0x88) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, RTCS2, 0x68) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CARFREQ, freq) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, TMGTHRISE, tmg_thh) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, TMGTHFALL, tmg_thl) < 0)\r\ngoto err;\r\nreturn tmg_lock;\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic int stv090x_get_coldlock(struct stv090x_state *state, s32 timeout_dmd)\r\n{\r\nstruct dvb_frontend *fe = &state->frontend;\r\nu32 reg;\r\ns32 car_step, steps, cur_step, dir, freq, timeout_lock;\r\nint lock = 0;\r\nif (state->srate >= 10000000)\r\ntimeout_lock = timeout_dmd / 3;\r\nelse\r\ntimeout_lock = timeout_dmd / 2;\r\nlock = stv090x_get_dmdlock(state, timeout_lock);\r\nif (!lock) {\r\nif (state->srate >= 10000000) {\r\nif (stv090x_chk_tmg(state)) {\r\nif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x1f) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x15) < 0)\r\ngoto err;\r\nlock = stv090x_get_dmdlock(state, timeout_dmd);\r\n} else {\r\nlock = 0;\r\n}\r\n} else {\r\nif (state->srate <= 4000000)\r\ncar_step = 1000;\r\nelse if (state->srate <= 7000000)\r\ncar_step = 2000;\r\nelse if (state->srate <= 10000000)\r\ncar_step = 3000;\r\nelse\r\ncar_step = 5000;\r\nsteps = (state->search_range / 1000) / car_step;\r\nsteps /= 2;\r\nsteps = 2 * (steps + 1);\r\nif (steps < 0)\r\nsteps = 2;\r\nelse if (steps > 12)\r\nsteps = 12;\r\ncur_step = 1;\r\ndir = 1;\r\nif (!lock) {\r\nfreq = state->frequency;\r\nstate->tuner_bw = stv090x_car_width(state->srate, state->rolloff) + state->srate;\r\nwhile ((cur_step <= steps) && (!lock)) {\r\nif (dir > 0)\r\nfreq += cur_step * car_step;\r\nelse\r\nfreq -= cur_step * car_step;\r\nif (stv090x_i2c_gate_ctrl(state, 1) < 0)\r\ngoto err;\r\nif (state->config->tuner_set_frequency) {\r\nif (state->config->tuner_set_frequency(fe, freq) < 0)\r\ngoto err_gateoff;\r\n}\r\nif (state->config->tuner_set_bandwidth) {\r\nif (state->config->tuner_set_bandwidth(fe, state->tuner_bw) < 0)\r\ngoto err_gateoff;\r\n}\r\nif (stv090x_i2c_gate_ctrl(state, 0) < 0)\r\ngoto err;\r\nmsleep(50);\r\nif (stv090x_i2c_gate_ctrl(state, 1) < 0)\r\ngoto err;\r\nif (state->config->tuner_get_status) {\r\nif (state->config->tuner_get_status(fe, &reg) < 0)\r\ngoto err_gateoff;\r\n}\r\nif (reg)\r\ndprintk(FE_DEBUG, 1, "Tuner phase locked");\r\nelse\r\ndprintk(FE_DEBUG, 1, "Tuner unlocked");\r\nif (stv090x_i2c_gate_ctrl(state, 0) < 0)\r\ngoto err;\r\nSTV090x_WRITE_DEMOD(state, DMDISTATE, 0x1c);\r\nif (STV090x_WRITE_DEMOD(state, CFRINIT1, 0x00) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CFRINIT0, 0x00) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x1f) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x15) < 0)\r\ngoto err;\r\nlock = stv090x_get_dmdlock(state, (timeout_dmd / 3));\r\ndir *= -1;\r\ncur_step++;\r\n}\r\n}\r\n}\r\n}\r\nreturn lock;\r\nerr_gateoff:\r\nstv090x_i2c_gate_ctrl(state, 0);\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic int stv090x_get_loop_params(struct stv090x_state *state, s32 *freq_inc, s32 *timeout_sw, s32 *steps)\r\n{\r\ns32 timeout, inc, steps_max, srate, car_max;\r\nsrate = state->srate;\r\ncar_max = state->search_range / 1000;\r\ncar_max += car_max / 10;\r\ncar_max = 65536 * (car_max / 2);\r\ncar_max /= (state->internal->mclk / 1000);\r\nif (car_max > 0x4000)\r\ncar_max = 0x4000 ;\r\ninc = srate;\r\ninc /= state->internal->mclk / 1000;\r\ninc *= 256;\r\ninc *= 256;\r\ninc /= 1000;\r\nswitch (state->search_mode) {\r\ncase STV090x_SEARCH_DVBS1:\r\ncase STV090x_SEARCH_DSS:\r\ninc *= 3;\r\ntimeout = 20;\r\nbreak;\r\ncase STV090x_SEARCH_DVBS2:\r\ninc *= 4;\r\ntimeout = 25;\r\nbreak;\r\ncase STV090x_SEARCH_AUTO:\r\ndefault:\r\ninc *= 3;\r\ntimeout = 25;\r\nbreak;\r\n}\r\ninc /= 100;\r\nif ((inc > car_max) || (inc < 0))\r\ninc = car_max / 2;\r\ntimeout *= 27500;\r\nif (srate > 0)\r\ntimeout /= (srate / 1000);\r\nif ((timeout > 100) || (timeout < 0))\r\ntimeout = 100;\r\nsteps_max = (car_max / inc) + 1;\r\nif ((steps_max > 100) || (steps_max < 0)) {\r\nsteps_max = 100;\r\ninc = car_max / steps_max;\r\n}\r\n*freq_inc = inc;\r\n*timeout_sw = timeout;\r\n*steps = steps_max;\r\nreturn 0;\r\n}\r\nstatic int stv090x_chk_signal(struct stv090x_state *state)\r\n{\r\ns32 offst_car, agc2, car_max;\r\nint no_signal;\r\noffst_car = STV090x_READ_DEMOD(state, CFR2) << 8;\r\noffst_car |= STV090x_READ_DEMOD(state, CFR1);\r\noffst_car = comp2(offst_car, 16);\r\nagc2 = STV090x_READ_DEMOD(state, AGC2I1) << 8;\r\nagc2 |= STV090x_READ_DEMOD(state, AGC2I0);\r\ncar_max = state->search_range / 1000;\r\ncar_max += (car_max / 10);\r\ncar_max = (65536 * car_max / 2);\r\ncar_max /= state->internal->mclk / 1000;\r\nif (car_max > 0x4000)\r\ncar_max = 0x4000;\r\nif ((agc2 > 0x2000) || (offst_car > 2 * car_max) || (offst_car < -2 * car_max)) {\r\nno_signal = 1;\r\ndprintk(FE_DEBUG, 1, "No Signal");\r\n} else {\r\nno_signal = 0;\r\ndprintk(FE_DEBUG, 1, "Found Signal");\r\n}\r\nreturn no_signal;\r\n}\r\nstatic int stv090x_search_car_loop(struct stv090x_state *state, s32 inc, s32 timeout, int zigzag, s32 steps_max)\r\n{\r\nint no_signal, lock = 0;\r\ns32 cpt_step = 0, offst_freq, car_max;\r\nu32 reg;\r\ncar_max = state->search_range / 1000;\r\ncar_max += (car_max / 10);\r\ncar_max = (65536 * car_max / 2);\r\ncar_max /= (state->internal->mclk / 1000);\r\nif (car_max > 0x4000)\r\ncar_max = 0x4000;\r\nif (zigzag)\r\noffst_freq = 0;\r\nelse\r\noffst_freq = -car_max + inc;\r\ndo {\r\nif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x1c) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CFRINIT1, ((offst_freq / 256) & 0xff)) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CFRINIT0, offst_freq & 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x18) < 0)\r\ngoto err;\r\nreg = STV090x_READ_DEMOD(state, PDELCTRL1);\r\nSTV090x_SETFIELD_Px(reg, ALGOSWRST_FIELD, 0x1);\r\nif (STV090x_WRITE_DEMOD(state, PDELCTRL1, reg) < 0)\r\ngoto err;\r\nif (zigzag) {\r\nif (offst_freq >= 0)\r\noffst_freq = -offst_freq - 2 * inc;\r\nelse\r\noffst_freq = -offst_freq;\r\n} else {\r\noffst_freq += 2 * inc;\r\n}\r\ncpt_step++;\r\nlock = stv090x_get_dmdlock(state, timeout);\r\nno_signal = stv090x_chk_signal(state);\r\n} while ((!lock) &&\r\n(!no_signal) &&\r\n((offst_freq - inc) < car_max) &&\r\n((offst_freq + inc) > -car_max) &&\r\n(cpt_step < steps_max));\r\nreg = STV090x_READ_DEMOD(state, PDELCTRL1);\r\nSTV090x_SETFIELD_Px(reg, ALGOSWRST_FIELD, 0);\r\nif (STV090x_WRITE_DEMOD(state, PDELCTRL1, reg) < 0)\r\ngoto err;\r\nreturn lock;\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic int stv090x_sw_algo(struct stv090x_state *state)\r\n{\r\nint no_signal, zigzag, lock = 0;\r\nu32 reg;\r\ns32 dvbs2_fly_wheel;\r\ns32 inc, timeout_step, trials, steps_max;\r\nstv090x_get_loop_params(state, &inc, &timeout_step, &steps_max);\r\nswitch (state->search_mode) {\r\ncase STV090x_SEARCH_DVBS1:\r\ncase STV090x_SEARCH_DSS:\r\nif (state->internal->dev_ver >= 0x20) {\r\nif (STV090x_WRITE_DEMOD(state, CARFREQ, 0x3B) < 0)\r\ngoto err;\r\n}\r\nif (STV090x_WRITE_DEMOD(state, DMDCFGMD, 0x49) < 0)\r\ngoto err;\r\nzigzag = 0;\r\nbreak;\r\ncase STV090x_SEARCH_DVBS2:\r\nif (state->internal->dev_ver >= 0x20) {\r\nif (STV090x_WRITE_DEMOD(state, CORRELABS, 0x79) < 0)\r\ngoto err;\r\n}\r\nif (STV090x_WRITE_DEMOD(state, DMDCFGMD, 0x89) < 0)\r\ngoto err;\r\nzigzag = 1;\r\nbreak;\r\ncase STV090x_SEARCH_AUTO:\r\ndefault:\r\nif (state->internal->dev_ver >= 0x20) {\r\nif (STV090x_WRITE_DEMOD(state, CARFREQ, 0x3b) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CORRELABS, 0x79) < 0)\r\ngoto err;\r\n}\r\nif (STV090x_WRITE_DEMOD(state, DMDCFGMD, 0xc9) < 0)\r\ngoto err;\r\nzigzag = 0;\r\nbreak;\r\n}\r\ntrials = 0;\r\ndo {\r\nlock = stv090x_search_car_loop(state, inc, timeout_step, zigzag, steps_max);\r\nno_signal = stv090x_chk_signal(state);\r\ntrials++;\r\nif (lock || no_signal || (trials == 2)) {\r\nif (state->internal->dev_ver >= 0x20) {\r\nif (STV090x_WRITE_DEMOD(state, CARFREQ, 0x49) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CORRELABS, 0x9e) < 0)\r\ngoto err;\r\n}\r\nreg = STV090x_READ_DEMOD(state, DMDSTATE);\r\nif ((lock) && (STV090x_GETFIELD_Px(reg, HEADER_MODE_FIELD) == STV090x_DVBS2)) {\r\nmsleep(timeout_step);\r\nreg = STV090x_READ_DEMOD(state, DMDFLYW);\r\ndvbs2_fly_wheel = STV090x_GETFIELD_Px(reg, FLYWHEEL_CPT_FIELD);\r\nif (dvbs2_fly_wheel < 0xd) {\r\nmsleep(timeout_step);\r\nreg = STV090x_READ_DEMOD(state, DMDFLYW);\r\ndvbs2_fly_wheel = STV090x_GETFIELD_Px(reg, FLYWHEEL_CPT_FIELD);\r\n}\r\nif (dvbs2_fly_wheel < 0xd) {\r\nlock = 0;\r\nif (trials < 2) {\r\nif (state->internal->dev_ver >= 0x20) {\r\nif (STV090x_WRITE_DEMOD(state, CORRELABS, 0x79) < 0)\r\ngoto err;\r\n}\r\nif (STV090x_WRITE_DEMOD(state, DMDCFGMD, 0x89) < 0)\r\ngoto err;\r\n}\r\n}\r\n}\r\n}\r\n} while ((!lock) && (trials < 2) && (!no_signal));\r\nreturn lock;\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic enum stv090x_delsys stv090x_get_std(struct stv090x_state *state)\r\n{\r\nu32 reg;\r\nenum stv090x_delsys delsys;\r\nreg = STV090x_READ_DEMOD(state, DMDSTATE);\r\nif (STV090x_GETFIELD_Px(reg, HEADER_MODE_FIELD) == 2)\r\ndelsys = STV090x_DVBS2;\r\nelse if (STV090x_GETFIELD_Px(reg, HEADER_MODE_FIELD) == 3) {\r\nreg = STV090x_READ_DEMOD(state, FECM);\r\nif (STV090x_GETFIELD_Px(reg, DSS_DVB_FIELD) == 1)\r\ndelsys = STV090x_DSS;\r\nelse\r\ndelsys = STV090x_DVBS1;\r\n} else {\r\ndelsys = STV090x_ERROR;\r\n}\r\nreturn delsys;\r\n}\r\nstatic s32 stv090x_get_car_freq(struct stv090x_state *state, u32 mclk)\r\n{\r\ns32 derot, int_1, int_2, tmp_1, tmp_2;\r\nderot = STV090x_READ_DEMOD(state, CFR2) << 16;\r\nderot |= STV090x_READ_DEMOD(state, CFR1) << 8;\r\nderot |= STV090x_READ_DEMOD(state, CFR0);\r\nderot = comp2(derot, 24);\r\nint_1 = mclk >> 12;\r\nint_2 = derot >> 12;\r\ntmp_1 = mclk % 0x1000;\r\ntmp_2 = derot % 0x1000;\r\nderot = (int_1 * int_2) +\r\n((int_1 * tmp_2) >> 12) +\r\n((int_2 * tmp_1) >> 12);\r\nreturn derot;\r\n}\r\nstatic int stv090x_get_viterbi(struct stv090x_state *state)\r\n{\r\nu32 reg, rate;\r\nreg = STV090x_READ_DEMOD(state, VITCURPUN);\r\nrate = STV090x_GETFIELD_Px(reg, VIT_CURPUN_FIELD);\r\nswitch (rate) {\r\ncase 13:\r\nstate->fec = STV090x_PR12;\r\nbreak;\r\ncase 18:\r\nstate->fec = STV090x_PR23;\r\nbreak;\r\ncase 21:\r\nstate->fec = STV090x_PR34;\r\nbreak;\r\ncase 24:\r\nstate->fec = STV090x_PR56;\r\nbreak;\r\ncase 25:\r\nstate->fec = STV090x_PR67;\r\nbreak;\r\ncase 26:\r\nstate->fec = STV090x_PR78;\r\nbreak;\r\ndefault:\r\nstate->fec = STV090x_PRERR;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic enum stv090x_signal_state stv090x_get_sig_params(struct stv090x_state *state)\r\n{\r\nstruct dvb_frontend *fe = &state->frontend;\r\nu8 tmg;\r\nu32 reg;\r\ns32 i = 0, offst_freq;\r\nmsleep(5);\r\nif (state->algo == STV090x_BLIND_SEARCH) {\r\ntmg = STV090x_READ_DEMOD(state, TMGREG2);\r\nSTV090x_WRITE_DEMOD(state, SFRSTEP, 0x5c);\r\nwhile ((i <= 50) && (tmg != 0) && (tmg != 0xff)) {\r\ntmg = STV090x_READ_DEMOD(state, TMGREG2);\r\nmsleep(5);\r\ni += 5;\r\n}\r\n}\r\nstate->delsys = stv090x_get_std(state);\r\nif (stv090x_i2c_gate_ctrl(state, 1) < 0)\r\ngoto err;\r\nif (state->config->tuner_get_frequency) {\r\nif (state->config->tuner_get_frequency(fe, &state->frequency) < 0)\r\ngoto err_gateoff;\r\n}\r\nif (stv090x_i2c_gate_ctrl(state, 0) < 0)\r\ngoto err;\r\noffst_freq = stv090x_get_car_freq(state, state->internal->mclk) / 1000;\r\nstate->frequency += offst_freq;\r\nif (stv090x_get_viterbi(state) < 0)\r\ngoto err;\r\nreg = STV090x_READ_DEMOD(state, DMDMODCOD);\r\nstate->modcod = STV090x_GETFIELD_Px(reg, DEMOD_MODCOD_FIELD);\r\nstate->pilots = STV090x_GETFIELD_Px(reg, DEMOD_TYPE_FIELD) & 0x01;\r\nstate->frame_len = STV090x_GETFIELD_Px(reg, DEMOD_TYPE_FIELD) >> 1;\r\nreg = STV090x_READ_DEMOD(state, TMGOBS);\r\nstate->rolloff = STV090x_GETFIELD_Px(reg, ROLLOFF_STATUS_FIELD);\r\nreg = STV090x_READ_DEMOD(state, FECM);\r\nstate->inversion = STV090x_GETFIELD_Px(reg, IQINV_FIELD);\r\nif ((state->algo == STV090x_BLIND_SEARCH) || (state->srate < 10000000)) {\r\nif (stv090x_i2c_gate_ctrl(state, 1) < 0)\r\ngoto err;\r\nif (state->config->tuner_get_frequency) {\r\nif (state->config->tuner_get_frequency(fe, &state->frequency) < 0)\r\ngoto err_gateoff;\r\n}\r\nif (stv090x_i2c_gate_ctrl(state, 0) < 0)\r\ngoto err;\r\nif (abs(offst_freq) <= ((state->search_range / 2000) + 500))\r\nreturn STV090x_RANGEOK;\r\nelse if (abs(offst_freq) <= (stv090x_car_width(state->srate, state->rolloff) / 2000))\r\nreturn STV090x_RANGEOK;\r\nelse\r\nreturn STV090x_OUTOFRANGE;\r\n} else {\r\nif (abs(offst_freq) <= ((state->search_range / 2000) + 500))\r\nreturn STV090x_RANGEOK;\r\nelse\r\nreturn STV090x_OUTOFRANGE;\r\n}\r\nreturn STV090x_OUTOFRANGE;\r\nerr_gateoff:\r\nstv090x_i2c_gate_ctrl(state, 0);\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic u32 stv090x_get_tmgoffst(struct stv090x_state *state, u32 srate)\r\n{\r\ns32 offst_tmg;\r\noffst_tmg = STV090x_READ_DEMOD(state, TMGREG2) << 16;\r\noffst_tmg |= STV090x_READ_DEMOD(state, TMGREG1) << 8;\r\noffst_tmg |= STV090x_READ_DEMOD(state, TMGREG0);\r\noffst_tmg = comp2(offst_tmg, 24);\r\nif (!offst_tmg)\r\noffst_tmg = 1;\r\noffst_tmg = ((s32) srate * 10) / ((s32) 0x1000000 / offst_tmg);\r\noffst_tmg /= 320;\r\nreturn offst_tmg;\r\n}\r\nstatic u8 stv090x_optimize_carloop(struct stv090x_state *state, enum stv090x_modcod modcod, s32 pilots)\r\n{\r\nu8 aclc = 0x29;\r\ns32 i;\r\nstruct stv090x_long_frame_crloop *car_loop, *car_loop_qpsk_low, *car_loop_apsk_low;\r\nif (state->internal->dev_ver == 0x20) {\r\ncar_loop = stv090x_s2_crl_cut20;\r\ncar_loop_qpsk_low = stv090x_s2_lowqpsk_crl_cut20;\r\ncar_loop_apsk_low = stv090x_s2_apsk_crl_cut20;\r\n} else {\r\ncar_loop = stv090x_s2_crl_cut30;\r\ncar_loop_qpsk_low = stv090x_s2_lowqpsk_crl_cut30;\r\ncar_loop_apsk_low = stv090x_s2_apsk_crl_cut30;\r\n}\r\nif (modcod < STV090x_QPSK_12) {\r\ni = 0;\r\nwhile ((i < 3) && (modcod != car_loop_qpsk_low[i].modcod))\r\ni++;\r\nif (i >= 3)\r\ni = 2;\r\n} else {\r\ni = 0;\r\nwhile ((i < 14) && (modcod != car_loop[i].modcod))\r\ni++;\r\nif (i >= 14) {\r\ni = 0;\r\nwhile ((i < 11) && (modcod != car_loop_apsk_low[i].modcod))\r\ni++;\r\nif (i >= 11)\r\ni = 10;\r\n}\r\n}\r\nif (modcod <= STV090x_QPSK_25) {\r\nif (pilots) {\r\nif (state->srate <= 3000000)\r\naclc = car_loop_qpsk_low[i].crl_pilots_on_2;\r\nelse if (state->srate <= 7000000)\r\naclc = car_loop_qpsk_low[i].crl_pilots_on_5;\r\nelse if (state->srate <= 15000000)\r\naclc = car_loop_qpsk_low[i].crl_pilots_on_10;\r\nelse if (state->srate <= 25000000)\r\naclc = car_loop_qpsk_low[i].crl_pilots_on_20;\r\nelse\r\naclc = car_loop_qpsk_low[i].crl_pilots_on_30;\r\n} else {\r\nif (state->srate <= 3000000)\r\naclc = car_loop_qpsk_low[i].crl_pilots_off_2;\r\nelse if (state->srate <= 7000000)\r\naclc = car_loop_qpsk_low[i].crl_pilots_off_5;\r\nelse if (state->srate <= 15000000)\r\naclc = car_loop_qpsk_low[i].crl_pilots_off_10;\r\nelse if (state->srate <= 25000000)\r\naclc = car_loop_qpsk_low[i].crl_pilots_off_20;\r\nelse\r\naclc = car_loop_qpsk_low[i].crl_pilots_off_30;\r\n}\r\n} else if (modcod <= STV090x_8PSK_910) {\r\nif (pilots) {\r\nif (state->srate <= 3000000)\r\naclc = car_loop[i].crl_pilots_on_2;\r\nelse if (state->srate <= 7000000)\r\naclc = car_loop[i].crl_pilots_on_5;\r\nelse if (state->srate <= 15000000)\r\naclc = car_loop[i].crl_pilots_on_10;\r\nelse if (state->srate <= 25000000)\r\naclc = car_loop[i].crl_pilots_on_20;\r\nelse\r\naclc = car_loop[i].crl_pilots_on_30;\r\n} else {\r\nif (state->srate <= 3000000)\r\naclc = car_loop[i].crl_pilots_off_2;\r\nelse if (state->srate <= 7000000)\r\naclc = car_loop[i].crl_pilots_off_5;\r\nelse if (state->srate <= 15000000)\r\naclc = car_loop[i].crl_pilots_off_10;\r\nelse if (state->srate <= 25000000)\r\naclc = car_loop[i].crl_pilots_off_20;\r\nelse\r\naclc = car_loop[i].crl_pilots_off_30;\r\n}\r\n} else {\r\nif (state->srate <= 3000000)\r\naclc = car_loop_apsk_low[i].crl_pilots_on_2;\r\nelse if (state->srate <= 7000000)\r\naclc = car_loop_apsk_low[i].crl_pilots_on_5;\r\nelse if (state->srate <= 15000000)\r\naclc = car_loop_apsk_low[i].crl_pilots_on_10;\r\nelse if (state->srate <= 25000000)\r\naclc = car_loop_apsk_low[i].crl_pilots_on_20;\r\nelse\r\naclc = car_loop_apsk_low[i].crl_pilots_on_30;\r\n}\r\nreturn aclc;\r\n}\r\nstatic u8 stv090x_optimize_carloop_short(struct stv090x_state *state)\r\n{\r\nstruct stv090x_short_frame_crloop *short_crl = NULL;\r\ns32 index = 0;\r\nu8 aclc = 0x0b;\r\nswitch (state->modulation) {\r\ncase STV090x_QPSK:\r\ndefault:\r\nindex = 0;\r\nbreak;\r\ncase STV090x_8PSK:\r\nindex = 1;\r\nbreak;\r\ncase STV090x_16APSK:\r\nindex = 2;\r\nbreak;\r\ncase STV090x_32APSK:\r\nindex = 3;\r\nbreak;\r\n}\r\nif (state->internal->dev_ver >= 0x30) {\r\nshort_crl = stv090x_s2_short_crl_cut30;\r\n} else {\r\nshort_crl = stv090x_s2_short_crl_cut20;\r\n}\r\nif (state->srate <= 3000000)\r\naclc = short_crl[index].crl_2;\r\nelse if (state->srate <= 7000000)\r\naclc = short_crl[index].crl_5;\r\nelse if (state->srate <= 15000000)\r\naclc = short_crl[index].crl_10;\r\nelse if (state->srate <= 25000000)\r\naclc = short_crl[index].crl_20;\r\nelse\r\naclc = short_crl[index].crl_30;\r\nreturn aclc;\r\n}\r\nstatic int stv090x_optimize_track(struct stv090x_state *state)\r\n{\r\nstruct dvb_frontend *fe = &state->frontend;\r\nenum stv090x_rolloff rolloff;\r\nenum stv090x_modcod modcod;\r\ns32 srate, pilots, aclc, f_1, f_0, i = 0, blind_tune = 0;\r\nu32 reg;\r\nsrate = stv090x_get_srate(state, state->internal->mclk);\r\nsrate += stv090x_get_tmgoffst(state, srate);\r\nswitch (state->delsys) {\r\ncase STV090x_DVBS1:\r\ncase STV090x_DSS:\r\nif (state->search_mode == STV090x_SEARCH_AUTO) {\r\nreg = STV090x_READ_DEMOD(state, DMDCFGMD);\r\nSTV090x_SETFIELD_Px(reg, DVBS1_ENABLE_FIELD, 1);\r\nSTV090x_SETFIELD_Px(reg, DVBS2_ENABLE_FIELD, 0);\r\nif (STV090x_WRITE_DEMOD(state, DMDCFGMD, reg) < 0)\r\ngoto err;\r\n}\r\nreg = STV090x_READ_DEMOD(state, DEMOD);\r\nSTV090x_SETFIELD_Px(reg, ROLLOFF_CONTROL_FIELD, state->rolloff);\r\nSTV090x_SETFIELD_Px(reg, MANUAL_SXROLLOFF_FIELD, 0x01);\r\nif (STV090x_WRITE_DEMOD(state, DEMOD, reg) < 0)\r\ngoto err;\r\nif (state->internal->dev_ver >= 0x30) {\r\nif (stv090x_get_viterbi(state) < 0)\r\ngoto err;\r\nif (state->fec == STV090x_PR12) {\r\nif (STV090x_WRITE_DEMOD(state, GAUSSR0, 0x98) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CCIR0, 0x18) < 0)\r\ngoto err;\r\n} else {\r\nif (STV090x_WRITE_DEMOD(state, GAUSSR0, 0x18) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CCIR0, 0x18) < 0)\r\ngoto err;\r\n}\r\n}\r\nif (STV090x_WRITE_DEMOD(state, ERRCTRL1, 0x75) < 0)\r\ngoto err;\r\nbreak;\r\ncase STV090x_DVBS2:\r\nreg = STV090x_READ_DEMOD(state, DMDCFGMD);\r\nSTV090x_SETFIELD_Px(reg, DVBS1_ENABLE_FIELD, 0);\r\nSTV090x_SETFIELD_Px(reg, DVBS2_ENABLE_FIELD, 1);\r\nif (STV090x_WRITE_DEMOD(state, DMDCFGMD, reg) < 0)\r\ngoto err;\r\nif (state->internal->dev_ver >= 0x30) {\r\nif (STV090x_WRITE_DEMOD(state, ACLC, 0) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, BCLC, 0) < 0)\r\ngoto err;\r\n}\r\nif (state->frame_len == STV090x_LONG_FRAME) {\r\nreg = STV090x_READ_DEMOD(state, DMDMODCOD);\r\nmodcod = STV090x_GETFIELD_Px(reg, DEMOD_MODCOD_FIELD);\r\npilots = STV090x_GETFIELD_Px(reg, DEMOD_TYPE_FIELD) & 0x01;\r\naclc = stv090x_optimize_carloop(state, modcod, pilots);\r\nif (modcod <= STV090x_QPSK_910) {\r\nSTV090x_WRITE_DEMOD(state, ACLC2S2Q, aclc);\r\n} else if (modcod <= STV090x_8PSK_910) {\r\nif (STV090x_WRITE_DEMOD(state, ACLC2S2Q, 0x2a) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, ACLC2S28, aclc) < 0)\r\ngoto err;\r\n}\r\nif ((state->demod_mode == STV090x_SINGLE) && (modcod > STV090x_8PSK_910)) {\r\nif (modcod <= STV090x_16APSK_910) {\r\nif (STV090x_WRITE_DEMOD(state, ACLC2S2Q, 0x2a) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, ACLC2S216A, aclc) < 0)\r\ngoto err;\r\n} else {\r\nif (STV090x_WRITE_DEMOD(state, ACLC2S2Q, 0x2a) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, ACLC2S232A, aclc) < 0)\r\ngoto err;\r\n}\r\n}\r\n} else {\r\naclc = stv090x_optimize_carloop_short(state);\r\nif (state->modulation == STV090x_QPSK) {\r\nif (STV090x_WRITE_DEMOD(state, ACLC2S2Q, aclc) < 0)\r\ngoto err;\r\n} else if (state->modulation == STV090x_8PSK) {\r\nif (STV090x_WRITE_DEMOD(state, ACLC2S2Q, 0x2a) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, ACLC2S28, aclc) < 0)\r\ngoto err;\r\n} else if (state->modulation == STV090x_16APSK) {\r\nif (STV090x_WRITE_DEMOD(state, ACLC2S2Q, 0x2a) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, ACLC2S216A, aclc) < 0)\r\ngoto err;\r\n} else if (state->modulation == STV090x_32APSK) {\r\nif (STV090x_WRITE_DEMOD(state, ACLC2S2Q, 0x2a) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, ACLC2S232A, aclc) < 0)\r\ngoto err;\r\n}\r\n}\r\nSTV090x_WRITE_DEMOD(state, ERRCTRL1, 0x67);\r\nbreak;\r\ncase STV090x_ERROR:\r\ndefault:\r\nreg = STV090x_READ_DEMOD(state, DMDCFGMD);\r\nSTV090x_SETFIELD_Px(reg, DVBS1_ENABLE_FIELD, 1);\r\nSTV090x_SETFIELD_Px(reg, DVBS2_ENABLE_FIELD, 1);\r\nif (STV090x_WRITE_DEMOD(state, DMDCFGMD, reg) < 0)\r\ngoto err;\r\nbreak;\r\n}\r\nf_1 = STV090x_READ_DEMOD(state, CFR2);\r\nf_0 = STV090x_READ_DEMOD(state, CFR1);\r\nreg = STV090x_READ_DEMOD(state, TMGOBS);\r\nrolloff = STV090x_GETFIELD_Px(reg, ROLLOFF_STATUS_FIELD);\r\nif (state->algo == STV090x_BLIND_SEARCH) {\r\nSTV090x_WRITE_DEMOD(state, SFRSTEP, 0x00);\r\nreg = STV090x_READ_DEMOD(state, DMDCFGMD);\r\nSTV090x_SETFIELD_Px(reg, SCAN_ENABLE_FIELD, 0x00);\r\nSTV090x_SETFIELD_Px(reg, CFR_AUTOSCAN_FIELD, 0x00);\r\nif (STV090x_WRITE_DEMOD(state, DMDCFGMD, reg) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, TMGCFG2, 0xc1) < 0)\r\ngoto err;\r\nif (stv090x_set_srate(state, srate) < 0)\r\ngoto err;\r\nblind_tune = 1;\r\nif (stv090x_dvbs_track_crl(state) < 0)\r\ngoto err;\r\n}\r\nif (state->internal->dev_ver >= 0x20) {\r\nif ((state->search_mode == STV090x_SEARCH_DVBS1) ||\r\n(state->search_mode == STV090x_SEARCH_DSS) ||\r\n(state->search_mode == STV090x_SEARCH_AUTO)) {\r\nif (STV090x_WRITE_DEMOD(state, VAVSRVIT, 0x0a) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, VITSCALE, 0x00) < 0)\r\ngoto err;\r\n}\r\n}\r\nif (STV090x_WRITE_DEMOD(state, AGC2REF, 0x38) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, SFRUP1, 0x80) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, SFRLOW1, 0x80) < 0)\r\ngoto err;\r\nif ((state->internal->dev_ver >= 0x20) || (blind_tune == 1) ||\r\n(state->srate < 10000000)) {\r\nif (STV090x_WRITE_DEMOD(state, CFRINIT1, f_1) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CFRINIT0, f_0) < 0)\r\ngoto err;\r\nstate->tuner_bw = stv090x_car_width(srate, state->rolloff) + 10000000;\r\nif ((state->internal->dev_ver >= 0x20) || (blind_tune == 1)) {\r\nif (state->algo != STV090x_WARM_SEARCH) {\r\nif (stv090x_i2c_gate_ctrl(state, 1) < 0)\r\ngoto err;\r\nif (state->config->tuner_set_bandwidth) {\r\nif (state->config->tuner_set_bandwidth(fe, state->tuner_bw) < 0)\r\ngoto err_gateoff;\r\n}\r\nif (stv090x_i2c_gate_ctrl(state, 0) < 0)\r\ngoto err;\r\n}\r\n}\r\nif ((state->algo == STV090x_BLIND_SEARCH) || (state->srate < 10000000))\r\nmsleep(50);\r\nelse\r\nmsleep(5);\r\nstv090x_get_lock_tmg(state);\r\nif (!(stv090x_get_dmdlock(state, (state->DemodTimeout / 2)))) {\r\nif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x1f) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CFRINIT1, f_1) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CFRINIT0, f_0) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x18) < 0)\r\ngoto err;\r\ni = 0;\r\nwhile ((!(stv090x_get_dmdlock(state, (state->DemodTimeout / 2)))) && (i <= 2)) {\r\nif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x1f) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CFRINIT1, f_1) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CFRINIT0, f_0) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x18) < 0)\r\ngoto err;\r\ni++;\r\n}\r\n}\r\n}\r\nif (state->internal->dev_ver >= 0x20) {\r\nif (STV090x_WRITE_DEMOD(state, CARFREQ, 0x49) < 0)\r\ngoto err;\r\n}\r\nif ((state->delsys == STV090x_DVBS1) || (state->delsys == STV090x_DSS))\r\nstv090x_set_vit_thtracq(state);\r\nreturn 0;\r\nerr_gateoff:\r\nstv090x_i2c_gate_ctrl(state, 0);\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic int stv090x_get_feclock(struct stv090x_state *state, s32 timeout)\r\n{\r\ns32 timer = 0, lock = 0, stat;\r\nu32 reg;\r\nwhile ((timer < timeout) && (!lock)) {\r\nreg = STV090x_READ_DEMOD(state, DMDSTATE);\r\nstat = STV090x_GETFIELD_Px(reg, HEADER_MODE_FIELD);\r\nswitch (stat) {\r\ncase 0:\r\ncase 1:\r\ndefault:\r\nlock = 0;\r\nbreak;\r\ncase 2:\r\nreg = STV090x_READ_DEMOD(state, PDELSTATUS1);\r\nlock = STV090x_GETFIELD_Px(reg, PKTDELIN_LOCK_FIELD);\r\nbreak;\r\ncase 3:\r\nreg = STV090x_READ_DEMOD(state, VSTATUSVIT);\r\nlock = STV090x_GETFIELD_Px(reg, LOCKEDVIT_FIELD);\r\nbreak;\r\n}\r\nif (!lock) {\r\nmsleep(10);\r\ntimer += 10;\r\n}\r\n}\r\nreturn lock;\r\n}\r\nstatic int stv090x_get_lock(struct stv090x_state *state, s32 timeout_dmd, s32 timeout_fec)\r\n{\r\nu32 reg;\r\ns32 timer = 0;\r\nint lock;\r\nlock = stv090x_get_dmdlock(state, timeout_dmd);\r\nif (lock)\r\nlock = stv090x_get_feclock(state, timeout_fec);\r\nif (lock) {\r\nlock = 0;\r\nwhile ((timer < timeout_fec) && (!lock)) {\r\nreg = STV090x_READ_DEMOD(state, TSSTATUS);\r\nlock = STV090x_GETFIELD_Px(reg, TSFIFO_LINEOK_FIELD);\r\nmsleep(1);\r\ntimer++;\r\n}\r\n}\r\nreturn lock;\r\n}\r\nstatic int stv090x_set_s2rolloff(struct stv090x_state *state)\r\n{\r\nu32 reg;\r\nif (state->internal->dev_ver <= 0x20) {\r\nreg = STV090x_READ_DEMOD(state, DEMOD);\r\nSTV090x_SETFIELD_Px(reg, MANUAL_SXROLLOFF_FIELD, 0x00);\r\nif (STV090x_WRITE_DEMOD(state, DEMOD, reg) < 0)\r\ngoto err;\r\n} else {\r\nreg = STV090x_READ_DEMOD(state, DEMOD);\r\nSTV090x_SETFIELD_Px(reg, MANUAL_S2ROLLOFF_FIELD, 0x00);\r\nif (STV090x_WRITE_DEMOD(state, DEMOD, reg) < 0)\r\ngoto err;\r\n}\r\nreturn 0;\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic enum stv090x_signal_state stv090x_algo(struct stv090x_state *state)\r\n{\r\nstruct dvb_frontend *fe = &state->frontend;\r\nenum stv090x_signal_state signal_state = STV090x_NOCARRIER;\r\nu32 reg;\r\ns32 agc1_power, power_iq = 0, i;\r\nint lock = 0, low_sr = 0, no_signal = 0;\r\nreg = STV090x_READ_DEMOD(state, TSCFGH);\r\nSTV090x_SETFIELD_Px(reg, RST_HWARE_FIELD, 1);\r\nif (STV090x_WRITE_DEMOD(state, TSCFGH, reg) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, DMDISTATE, 0x5c) < 0)\r\ngoto err;\r\nif (state->internal->dev_ver >= 0x20) {\r\nif (state->srate > 5000000) {\r\nif (STV090x_WRITE_DEMOD(state, CORRELABS, 0x9e) < 0)\r\ngoto err;\r\n} else {\r\nif (STV090x_WRITE_DEMOD(state, CORRELABS, 0x82) < 0)\r\ngoto err;\r\n}\r\n}\r\nstv090x_get_lock_tmg(state);\r\nif (state->algo == STV090x_BLIND_SEARCH) {\r\nstate->tuner_bw = 2 * 36000000;\r\nif (STV090x_WRITE_DEMOD(state, TMGCFG2, 0xc0) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, CORRELMANT, 0x70) < 0)\r\ngoto err;\r\nif (stv090x_set_srate(state, 1000000) < 0)\r\ngoto err;\r\n} else {\r\nif (STV090x_WRITE_DEMOD(state, DMDTOM, 0x20) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, TMGCFG, 0xd2) < 0)\r\ngoto err;\r\nif (state->srate < 2000000) {\r\nif (STV090x_WRITE_DEMOD(state, CORRELMANT, 0x63) < 0)\r\ngoto err;\r\n} else {\r\nif (STV090x_WRITE_DEMOD(state, CORRELMANT, 0x70) < 0)\r\ngoto err;\r\n}\r\nif (STV090x_WRITE_DEMOD(state, AGC2REF, 0x38) < 0)\r\ngoto err;\r\nif (state->internal->dev_ver >= 0x20) {\r\nif (STV090x_WRITE_DEMOD(state, KREFTMG, 0x5a) < 0)\r\ngoto err;\r\nif (state->algo == STV090x_COLD_SEARCH)\r\nstate->tuner_bw = (15 * (stv090x_car_width(state->srate, state->rolloff) + 10000000)) / 10;\r\nelse if (state->algo == STV090x_WARM_SEARCH)\r\nstate->tuner_bw = stv090x_car_width(state->srate, state->rolloff) + 10000000;\r\n}\r\nif (STV090x_WRITE_DEMOD(state, TMGCFG2, 0xc1) < 0)\r\ngoto err;\r\nif (stv090x_set_srate(state, state->srate) < 0)\r\ngoto err;\r\nif (stv090x_set_max_srate(state, state->internal->mclk,\r\nstate->srate) < 0)\r\ngoto err;\r\nif (stv090x_set_min_srate(state, state->internal->mclk,\r\nstate->srate) < 0)\r\ngoto err;\r\nif (state->srate >= 10000000)\r\nlow_sr = 0;\r\nelse\r\nlow_sr = 1;\r\n}\r\nif (stv090x_i2c_gate_ctrl(state, 1) < 0)\r\ngoto err;\r\nif (state->config->tuner_set_bbgain) {\r\nreg = state->config->tuner_bbgain;\r\nif (reg == 0)\r\nreg = 10;\r\nif (state->config->tuner_set_bbgain(fe, reg) < 0)\r\ngoto err_gateoff;\r\n}\r\nif (state->config->tuner_set_frequency) {\r\nif (state->config->tuner_set_frequency(fe, state->frequency) < 0)\r\ngoto err_gateoff;\r\n}\r\nif (state->config->tuner_set_bandwidth) {\r\nif (state->config->tuner_set_bandwidth(fe, state->tuner_bw) < 0)\r\ngoto err_gateoff;\r\n}\r\nif (stv090x_i2c_gate_ctrl(state, 0) < 0)\r\ngoto err;\r\nmsleep(50);\r\nif (state->config->tuner_get_status) {\r\nif (stv090x_i2c_gate_ctrl(state, 1) < 0)\r\ngoto err;\r\nif (state->config->tuner_get_status(fe, &reg) < 0)\r\ngoto err_gateoff;\r\nif (stv090x_i2c_gate_ctrl(state, 0) < 0)\r\ngoto err;\r\nif (reg)\r\ndprintk(FE_DEBUG, 1, "Tuner phase locked");\r\nelse {\r\ndprintk(FE_DEBUG, 1, "Tuner unlocked");\r\nreturn STV090x_NOCARRIER;\r\n}\r\n}\r\nmsleep(10);\r\nagc1_power = MAKEWORD16(STV090x_READ_DEMOD(state, AGCIQIN1),\r\nSTV090x_READ_DEMOD(state, AGCIQIN0));\r\nif (agc1_power == 0) {\r\nfor (i = 0; i < 5; i++) {\r\npower_iq += (STV090x_READ_DEMOD(state, POWERI) +\r\nSTV090x_READ_DEMOD(state, POWERQ)) >> 1;\r\n}\r\npower_iq /= 5;\r\n}\r\nif ((agc1_power == 0) && (power_iq < STV090x_IQPOWER_THRESHOLD)) {\r\ndprintk(FE_ERROR, 1, "No Signal: POWER_IQ=0x%02x", power_iq);\r\nlock = 0;\r\nsignal_state = STV090x_NOAGC1;\r\n} else {\r\nreg = STV090x_READ_DEMOD(state, DEMOD);\r\nSTV090x_SETFIELD_Px(reg, SPECINV_CONTROL_FIELD, state->inversion);\r\nif (state->internal->dev_ver <= 0x20) {\r\nSTV090x_SETFIELD_Px(reg, MANUAL_SXROLLOFF_FIELD, 1);\r\n} else {\r\nSTV090x_SETFIELD_Px(reg, MANUAL_S2ROLLOFF_FIELD, 1);\r\n}\r\nif (STV090x_WRITE_DEMOD(state, DEMOD, reg) < 0)\r\ngoto err;\r\nif (stv090x_delivery_search(state) < 0)\r\ngoto err;\r\nif (state->algo != STV090x_BLIND_SEARCH) {\r\nif (stv090x_start_search(state) < 0)\r\ngoto err;\r\n}\r\n}\r\nif (signal_state == STV090x_NOAGC1)\r\nreturn signal_state;\r\nif (state->algo == STV090x_BLIND_SEARCH)\r\nlock = stv090x_blind_search(state);\r\nelse if (state->algo == STV090x_COLD_SEARCH)\r\nlock = stv090x_get_coldlock(state, state->DemodTimeout);\r\nelse if (state->algo == STV090x_WARM_SEARCH)\r\nlock = stv090x_get_dmdlock(state, state->DemodTimeout);\r\nif ((!lock) && (state->algo == STV090x_COLD_SEARCH)) {\r\nif (!low_sr) {\r\nif (stv090x_chk_tmg(state))\r\nlock = stv090x_sw_algo(state);\r\n}\r\n}\r\nif (lock)\r\nsignal_state = stv090x_get_sig_params(state);\r\nif ((lock) && (signal_state == STV090x_RANGEOK)) {\r\nstv090x_optimize_track(state);\r\nif (state->internal->dev_ver >= 0x20) {\r\nreg = STV090x_READ_DEMOD(state, TSCFGH);\r\nSTV090x_SETFIELD_Px(reg, RST_HWARE_FIELD, 0);\r\nif (STV090x_WRITE_DEMOD(state, TSCFGH, reg) < 0)\r\ngoto err;\r\nmsleep(3);\r\nSTV090x_SETFIELD_Px(reg, RST_HWARE_FIELD, 1);\r\nif (STV090x_WRITE_DEMOD(state, TSCFGH, reg) < 0)\r\ngoto err;\r\nSTV090x_SETFIELD_Px(reg, RST_HWARE_FIELD, 0);\r\nif (STV090x_WRITE_DEMOD(state, TSCFGH, reg) < 0)\r\ngoto err;\r\n}\r\nlock = stv090x_get_lock(state, state->FecTimeout,\r\nstate->FecTimeout);\r\nif (lock) {\r\nif (state->delsys == STV090x_DVBS2) {\r\nstv090x_set_s2rolloff(state);\r\nreg = STV090x_READ_DEMOD(state, PDELCTRL2);\r\nSTV090x_SETFIELD_Px(reg, RESET_UPKO_COUNT, 1);\r\nif (STV090x_WRITE_DEMOD(state, PDELCTRL2, reg) < 0)\r\ngoto err;\r\nreg = STV090x_READ_DEMOD(state, PDELCTRL2);\r\nSTV090x_SETFIELD_Px(reg, RESET_UPKO_COUNT, 0);\r\nif (STV090x_WRITE_DEMOD(state, PDELCTRL2, reg) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, ERRCTRL1, 0x67) < 0)\r\ngoto err;\r\n} else {\r\nif (STV090x_WRITE_DEMOD(state, ERRCTRL1, 0x75) < 0)\r\ngoto err;\r\n}\r\nif (STV090x_WRITE_DEMOD(state, FBERCPT4, 0x00) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, ERRCTRL2, 0xc1) < 0)\r\ngoto err;\r\n} else {\r\nsignal_state = STV090x_NODATA;\r\nno_signal = stv090x_chk_signal(state);\r\n}\r\n}\r\nreturn signal_state;\r\nerr_gateoff:\r\nstv090x_i2c_gate_ctrl(state, 0);\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic enum dvbfe_search stv090x_search(struct dvb_frontend *fe, struct dvb_frontend_parameters *p)\r\n{\r\nstruct stv090x_state *state = fe->demodulator_priv;\r\nstruct dtv_frontend_properties *props = &fe->dtv_property_cache;\r\nif (p->frequency == 0)\r\nreturn DVBFE_ALGO_SEARCH_INVALID;\r\nstate->delsys = props->delivery_system;\r\nstate->frequency = p->frequency;\r\nstate->srate = p->u.qpsk.symbol_rate;\r\nstate->search_mode = STV090x_SEARCH_AUTO;\r\nstate->algo = STV090x_COLD_SEARCH;\r\nstate->fec = STV090x_PRERR;\r\nif (state->srate > 10000000) {\r\ndprintk(FE_DEBUG, 1, "Search range: 10 MHz");\r\nstate->search_range = 10000000;\r\n} else {\r\ndprintk(FE_DEBUG, 1, "Search range: 5 MHz");\r\nstate->search_range = 5000000;\r\n}\r\nif (stv090x_algo(state) == STV090x_RANGEOK) {\r\ndprintk(FE_DEBUG, 1, "Search success!");\r\nreturn DVBFE_ALGO_SEARCH_SUCCESS;\r\n} else {\r\ndprintk(FE_DEBUG, 1, "Search failed!");\r\nreturn DVBFE_ALGO_SEARCH_FAILED;\r\n}\r\nreturn DVBFE_ALGO_SEARCH_ERROR;\r\n}\r\nstatic int stv090x_read_status(struct dvb_frontend *fe, enum fe_status *status)\r\n{\r\nstruct stv090x_state *state = fe->demodulator_priv;\r\nu32 reg;\r\nu8 search_state;\r\nreg = STV090x_READ_DEMOD(state, DMDSTATE);\r\nsearch_state = STV090x_GETFIELD_Px(reg, HEADER_MODE_FIELD);\r\nswitch (search_state) {\r\ncase 0:\r\ncase 1:\r\ndefault:\r\ndprintk(FE_DEBUG, 1, "Status: Unlocked (Searching ..)");\r\n*status = 0;\r\nbreak;\r\ncase 2:\r\ndprintk(FE_DEBUG, 1, "Delivery system: DVB-S2");\r\nreg = STV090x_READ_DEMOD(state, DSTATUS);\r\nif (STV090x_GETFIELD_Px(reg, LOCK_DEFINITIF_FIELD)) {\r\nreg = STV090x_READ_DEMOD(state, PDELSTATUS1);\r\nif (STV090x_GETFIELD_Px(reg, PKTDELIN_LOCK_FIELD)) {\r\nreg = STV090x_READ_DEMOD(state, TSSTATUS);\r\nif (STV090x_GETFIELD_Px(reg, TSFIFO_LINEOK_FIELD)) {\r\n*status = FE_HAS_SIGNAL |\r\nFE_HAS_CARRIER |\r\nFE_HAS_VITERBI |\r\nFE_HAS_SYNC |\r\nFE_HAS_LOCK;\r\n}\r\n}\r\n}\r\nbreak;\r\ncase 3:\r\ndprintk(FE_DEBUG, 1, "Delivery system: DVB-S");\r\nreg = STV090x_READ_DEMOD(state, DSTATUS);\r\nif (STV090x_GETFIELD_Px(reg, LOCK_DEFINITIF_FIELD)) {\r\nreg = STV090x_READ_DEMOD(state, VSTATUSVIT);\r\nif (STV090x_GETFIELD_Px(reg, LOCKEDVIT_FIELD)) {\r\nreg = STV090x_READ_DEMOD(state, TSSTATUS);\r\nif (STV090x_GETFIELD_Px(reg, TSFIFO_LINEOK_FIELD)) {\r\n*status = FE_HAS_SIGNAL |\r\nFE_HAS_CARRIER |\r\nFE_HAS_VITERBI |\r\nFE_HAS_SYNC |\r\nFE_HAS_LOCK;\r\n}\r\n}\r\n}\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int stv090x_read_per(struct dvb_frontend *fe, u32 *per)\r\n{\r\nstruct stv090x_state *state = fe->demodulator_priv;\r\ns32 count_4, count_3, count_2, count_1, count_0, count;\r\nu32 reg, h, m, l;\r\nenum fe_status status;\r\nstv090x_read_status(fe, &status);\r\nif (!(status & FE_HAS_LOCK)) {\r\n*per = 1 << 23;\r\n} else {\r\nreg = STV090x_READ_DEMOD(state, ERRCNT22);\r\nh = STV090x_GETFIELD_Px(reg, ERR_CNT2_FIELD);\r\nreg = STV090x_READ_DEMOD(state, ERRCNT21);\r\nm = STV090x_GETFIELD_Px(reg, ERR_CNT21_FIELD);\r\nreg = STV090x_READ_DEMOD(state, ERRCNT20);\r\nl = STV090x_GETFIELD_Px(reg, ERR_CNT20_FIELD);\r\n*per = ((h << 16) | (m << 8) | l);\r\ncount_4 = STV090x_READ_DEMOD(state, FBERCPT4);\r\ncount_3 = STV090x_READ_DEMOD(state, FBERCPT3);\r\ncount_2 = STV090x_READ_DEMOD(state, FBERCPT2);\r\ncount_1 = STV090x_READ_DEMOD(state, FBERCPT1);\r\ncount_0 = STV090x_READ_DEMOD(state, FBERCPT0);\r\nif ((!count_4) && (!count_3)) {\r\ncount = (count_2 & 0xff) << 16;\r\ncount |= (count_1 & 0xff) << 8;\r\ncount |= count_0 & 0xff;\r\n} else {\r\ncount = 1 << 24;\r\n}\r\nif (count == 0)\r\n*per = 1;\r\n}\r\nif (STV090x_WRITE_DEMOD(state, FBERCPT4, 0) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, ERRCTRL2, 0xc1) < 0)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic int stv090x_table_lookup(const struct stv090x_tab *tab, int max, int val)\r\n{\r\nint res = 0;\r\nint min = 0, med;\r\nif ((val >= tab[min].read && val < tab[max].read) ||\r\n(val >= tab[max].read && val < tab[min].read)) {\r\nwhile ((max - min) > 1) {\r\nmed = (max + min) / 2;\r\nif ((val >= tab[min].read && val < tab[med].read) ||\r\n(val >= tab[med].read && val < tab[min].read))\r\nmax = med;\r\nelse\r\nmin = med;\r\n}\r\nres = ((val - tab[min].read) *\r\n(tab[max].real - tab[min].real) /\r\n(tab[max].read - tab[min].read)) +\r\ntab[min].real;\r\n} else {\r\nif (tab[min].read < tab[max].read) {\r\nif (val < tab[min].read)\r\nres = tab[min].real;\r\nelse if (val >= tab[max].read)\r\nres = tab[max].real;\r\n} else {\r\nif (val >= tab[min].read)\r\nres = tab[min].real;\r\nelse if (val < tab[max].read)\r\nres = tab[max].real;\r\n}\r\n}\r\nreturn res;\r\n}\r\nstatic int stv090x_read_signal_strength(struct dvb_frontend *fe, u16 *strength)\r\n{\r\nstruct stv090x_state *state = fe->demodulator_priv;\r\nu32 reg;\r\ns32 agc_0, agc_1, agc;\r\ns32 str;\r\nreg = STV090x_READ_DEMOD(state, AGCIQIN1);\r\nagc_1 = STV090x_GETFIELD_Px(reg, AGCIQ_VALUE_FIELD);\r\nreg = STV090x_READ_DEMOD(state, AGCIQIN0);\r\nagc_0 = STV090x_GETFIELD_Px(reg, AGCIQ_VALUE_FIELD);\r\nagc = MAKEWORD16(agc_1, agc_0);\r\nstr = stv090x_table_lookup(stv090x_rf_tab,\r\nARRAY_SIZE(stv090x_rf_tab) - 1, agc);\r\nif (agc > stv090x_rf_tab[0].read)\r\nstr = 0;\r\nelse if (agc < stv090x_rf_tab[ARRAY_SIZE(stv090x_rf_tab) - 1].read)\r\nstr = -100;\r\n*strength = (str + 100) * 0xFFFF / 100;\r\nreturn 0;\r\n}\r\nstatic int stv090x_read_cnr(struct dvb_frontend *fe, u16 *cnr)\r\n{\r\nstruct stv090x_state *state = fe->demodulator_priv;\r\nu32 reg_0, reg_1, reg, i;\r\ns32 val_0, val_1, val = 0;\r\nu8 lock_f;\r\ns32 div;\r\nu32 last;\r\nswitch (state->delsys) {\r\ncase STV090x_DVBS2:\r\nreg = STV090x_READ_DEMOD(state, DSTATUS);\r\nlock_f = STV090x_GETFIELD_Px(reg, LOCK_DEFINITIF_FIELD);\r\nif (lock_f) {\r\nmsleep(5);\r\nfor (i = 0; i < 16; i++) {\r\nreg_1 = STV090x_READ_DEMOD(state, NNOSPLHT1);\r\nval_1 = STV090x_GETFIELD_Px(reg_1, NOSPLHT_NORMED_FIELD);\r\nreg_0 = STV090x_READ_DEMOD(state, NNOSPLHT0);\r\nval_0 = STV090x_GETFIELD_Px(reg_0, NOSPLHT_NORMED_FIELD);\r\nval += MAKEWORD16(val_1, val_0);\r\nmsleep(1);\r\n}\r\nval /= 16;\r\nlast = ARRAY_SIZE(stv090x_s2cn_tab) - 1;\r\ndiv = stv090x_s2cn_tab[0].read -\r\nstv090x_s2cn_tab[last].read;\r\n*cnr = 0xFFFF - ((val * 0xFFFF) / div);\r\n}\r\nbreak;\r\ncase STV090x_DVBS1:\r\ncase STV090x_DSS:\r\nreg = STV090x_READ_DEMOD(state, DSTATUS);\r\nlock_f = STV090x_GETFIELD_Px(reg, LOCK_DEFINITIF_FIELD);\r\nif (lock_f) {\r\nmsleep(5);\r\nfor (i = 0; i < 16; i++) {\r\nreg_1 = STV090x_READ_DEMOD(state, NOSDATAT1);\r\nval_1 = STV090x_GETFIELD_Px(reg_1, NOSDATAT_UNNORMED_FIELD);\r\nreg_0 = STV090x_READ_DEMOD(state, NOSDATAT0);\r\nval_0 = STV090x_GETFIELD_Px(reg_0, NOSDATAT_UNNORMED_FIELD);\r\nval += MAKEWORD16(val_1, val_0);\r\nmsleep(1);\r\n}\r\nval /= 16;\r\nlast = ARRAY_SIZE(stv090x_s1cn_tab) - 1;\r\ndiv = stv090x_s1cn_tab[0].read -\r\nstv090x_s1cn_tab[last].read;\r\n*cnr = 0xFFFF - ((val * 0xFFFF) / div);\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int stv090x_set_tone(struct dvb_frontend *fe, fe_sec_tone_mode_t tone)\r\n{\r\nstruct stv090x_state *state = fe->demodulator_priv;\r\nu32 reg;\r\nreg = STV090x_READ_DEMOD(state, DISTXCTL);\r\nswitch (tone) {\r\ncase SEC_TONE_ON:\r\nSTV090x_SETFIELD_Px(reg, DISTX_MODE_FIELD, 0);\r\nSTV090x_SETFIELD_Px(reg, DISEQC_RESET_FIELD, 1);\r\nif (STV090x_WRITE_DEMOD(state, DISTXCTL, reg) < 0)\r\ngoto err;\r\nSTV090x_SETFIELD_Px(reg, DISEQC_RESET_FIELD, 0);\r\nif (STV090x_WRITE_DEMOD(state, DISTXCTL, reg) < 0)\r\ngoto err;\r\nbreak;\r\ncase SEC_TONE_OFF:\r\nSTV090x_SETFIELD_Px(reg, DISTX_MODE_FIELD, 0);\r\nSTV090x_SETFIELD_Px(reg, DISEQC_RESET_FIELD, 1);\r\nif (STV090x_WRITE_DEMOD(state, DISTXCTL, reg) < 0)\r\ngoto err;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic enum dvbfe_algo stv090x_frontend_algo(struct dvb_frontend *fe)\r\n{\r\nreturn DVBFE_ALGO_CUSTOM;\r\n}\r\nstatic int stv090x_send_diseqc_msg(struct dvb_frontend *fe, struct dvb_diseqc_master_cmd *cmd)\r\n{\r\nstruct stv090x_state *state = fe->demodulator_priv;\r\nu32 reg, idle = 0, fifo_full = 1;\r\nint i;\r\nreg = STV090x_READ_DEMOD(state, DISTXCTL);\r\nSTV090x_SETFIELD_Px(reg, DISTX_MODE_FIELD,\r\n(state->config->diseqc_envelope_mode) ? 4 : 2);\r\nSTV090x_SETFIELD_Px(reg, DISEQC_RESET_FIELD, 1);\r\nif (STV090x_WRITE_DEMOD(state, DISTXCTL, reg) < 0)\r\ngoto err;\r\nSTV090x_SETFIELD_Px(reg, DISEQC_RESET_FIELD, 0);\r\nif (STV090x_WRITE_DEMOD(state, DISTXCTL, reg) < 0)\r\ngoto err;\r\nSTV090x_SETFIELD_Px(reg, DIS_PRECHARGE_FIELD, 1);\r\nif (STV090x_WRITE_DEMOD(state, DISTXCTL, reg) < 0)\r\ngoto err;\r\nfor (i = 0; i < cmd->msg_len; i++) {\r\nwhile (fifo_full) {\r\nreg = STV090x_READ_DEMOD(state, DISTXSTATUS);\r\nfifo_full = STV090x_GETFIELD_Px(reg, FIFO_FULL_FIELD);\r\n}\r\nif (STV090x_WRITE_DEMOD(state, DISTXDATA, cmd->msg[i]) < 0)\r\ngoto err;\r\n}\r\nreg = STV090x_READ_DEMOD(state, DISTXCTL);\r\nSTV090x_SETFIELD_Px(reg, DIS_PRECHARGE_FIELD, 0);\r\nif (STV090x_WRITE_DEMOD(state, DISTXCTL, reg) < 0)\r\ngoto err;\r\ni = 0;\r\nwhile ((!idle) && (i < 10)) {\r\nreg = STV090x_READ_DEMOD(state, DISTXSTATUS);\r\nidle = STV090x_GETFIELD_Px(reg, TX_IDLE_FIELD);\r\nmsleep(10);\r\ni++;\r\n}\r\nreturn 0;\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic int stv090x_send_diseqc_burst(struct dvb_frontend *fe, fe_sec_mini_cmd_t burst)\r\n{\r\nstruct stv090x_state *state = fe->demodulator_priv;\r\nu32 reg, idle = 0, fifo_full = 1;\r\nu8 mode, value;\r\nint i;\r\nreg = STV090x_READ_DEMOD(state, DISTXCTL);\r\nif (burst == SEC_MINI_A) {\r\nmode = (state->config->diseqc_envelope_mode) ? 5 : 3;\r\nvalue = 0x00;\r\n} else {\r\nmode = (state->config->diseqc_envelope_mode) ? 4 : 2;\r\nvalue = 0xFF;\r\n}\r\nSTV090x_SETFIELD_Px(reg, DISTX_MODE_FIELD, mode);\r\nSTV090x_SETFIELD_Px(reg, DISEQC_RESET_FIELD, 1);\r\nif (STV090x_WRITE_DEMOD(state, DISTXCTL, reg) < 0)\r\ngoto err;\r\nSTV090x_SETFIELD_Px(reg, DISEQC_RESET_FIELD, 0);\r\nif (STV090x_WRITE_DEMOD(state, DISTXCTL, reg) < 0)\r\ngoto err;\r\nSTV090x_SETFIELD_Px(reg, DIS_PRECHARGE_FIELD, 1);\r\nif (STV090x_WRITE_DEMOD(state, DISTXCTL, reg) < 0)\r\ngoto err;\r\nwhile (fifo_full) {\r\nreg = STV090x_READ_DEMOD(state, DISTXSTATUS);\r\nfifo_full = STV090x_GETFIELD_Px(reg, FIFO_FULL_FIELD);\r\n}\r\nif (STV090x_WRITE_DEMOD(state, DISTXDATA, value) < 0)\r\ngoto err;\r\nreg = STV090x_READ_DEMOD(state, DISTXCTL);\r\nSTV090x_SETFIELD_Px(reg, DIS_PRECHARGE_FIELD, 0);\r\nif (STV090x_WRITE_DEMOD(state, DISTXCTL, reg) < 0)\r\ngoto err;\r\ni = 0;\r\nwhile ((!idle) && (i < 10)) {\r\nreg = STV090x_READ_DEMOD(state, DISTXSTATUS);\r\nidle = STV090x_GETFIELD_Px(reg, TX_IDLE_FIELD);\r\nmsleep(10);\r\ni++;\r\n}\r\nreturn 0;\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic int stv090x_recv_slave_reply(struct dvb_frontend *fe, struct dvb_diseqc_slave_reply *reply)\r\n{\r\nstruct stv090x_state *state = fe->demodulator_priv;\r\nu32 reg = 0, i = 0, rx_end = 0;\r\nwhile ((rx_end != 1) && (i < 10)) {\r\nmsleep(10);\r\ni++;\r\nreg = STV090x_READ_DEMOD(state, DISRX_ST0);\r\nrx_end = STV090x_GETFIELD_Px(reg, RX_END_FIELD);\r\n}\r\nif (rx_end) {\r\nreply->msg_len = STV090x_GETFIELD_Px(reg, FIFO_BYTENBR_FIELD);\r\nfor (i = 0; i < reply->msg_len; i++)\r\nreply->msg[i] = STV090x_READ_DEMOD(state, DISRXDATA);\r\n}\r\nreturn 0;\r\n}\r\nstatic int stv090x_sleep(struct dvb_frontend *fe)\r\n{\r\nstruct stv090x_state *state = fe->demodulator_priv;\r\nu32 reg;\r\nu8 full_standby = 0;\r\nif (stv090x_i2c_gate_ctrl(state, 1) < 0)\r\ngoto err;\r\nif (state->config->tuner_sleep) {\r\nif (state->config->tuner_sleep(fe) < 0)\r\ngoto err_gateoff;\r\n}\r\nif (stv090x_i2c_gate_ctrl(state, 0) < 0)\r\ngoto err;\r\ndprintk(FE_DEBUG, 1, "Set %s(%d) to sleep",\r\nstate->device == STV0900 ? "STV0900" : "STV0903",\r\nstate->demod);\r\nmutex_lock(&state->internal->demod_lock);\r\nswitch (state->demod) {\r\ncase STV090x_DEMODULATOR_0:\r\nreg = stv090x_read_reg(state, STV090x_TSTTNR1);\r\nSTV090x_SETFIELD(reg, ADC1_PON_FIELD, 0);\r\nif (stv090x_write_reg(state, STV090x_TSTTNR1, reg) < 0)\r\ngoto err;\r\nreg = stv090x_read_reg(state, STV090x_TSTTNR2);\r\nSTV090x_SETFIELD(reg, DISEQC1_PON_FIELD, 0);\r\nif (stv090x_write_reg(state, STV090x_TSTTNR2, reg) < 0)\r\ngoto err;\r\nreg = stv090x_read_reg(state, STV090x_TSTTNR3);\r\nif (STV090x_GETFIELD(reg, ADC2_PON_FIELD) == 0)\r\nfull_standby = 1;\r\nreg = stv090x_read_reg(state, STV090x_STOPCLK1);\r\nSTV090x_SETFIELD(reg, STOP_CLKPKDT1_FIELD, 1);\r\nSTV090x_SETFIELD(reg, STOP_CLKADCI1_FIELD, 1);\r\nif (full_standby)\r\nSTV090x_SETFIELD(reg, STOP_CLKFEC_FIELD, 1);\r\nif (stv090x_write_reg(state, STV090x_STOPCLK1, reg) < 0)\r\ngoto err;\r\nreg = stv090x_read_reg(state, STV090x_STOPCLK2);\r\nSTV090x_SETFIELD(reg, STOP_CLKSAMP1_FIELD, 1);\r\nSTV090x_SETFIELD(reg, STOP_CLKVIT1_FIELD, 1);\r\nif (full_standby)\r\nSTV090x_SETFIELD(reg, STOP_CLKTS_FIELD, 1);\r\nif (stv090x_write_reg(state, STV090x_STOPCLK2, reg) < 0)\r\ngoto err;\r\nbreak;\r\ncase STV090x_DEMODULATOR_1:\r\nreg = stv090x_read_reg(state, STV090x_TSTTNR3);\r\nSTV090x_SETFIELD(reg, ADC2_PON_FIELD, 0);\r\nif (stv090x_write_reg(state, STV090x_TSTTNR3, reg) < 0)\r\ngoto err;\r\nreg = stv090x_read_reg(state, STV090x_TSTTNR4);\r\nSTV090x_SETFIELD(reg, DISEQC2_PON_FIELD, 0);\r\nif (stv090x_write_reg(state, STV090x_TSTTNR4, reg) < 0)\r\ngoto err;\r\nreg = stv090x_read_reg(state, STV090x_TSTTNR1);\r\nif (STV090x_GETFIELD(reg, ADC1_PON_FIELD) == 0)\r\nfull_standby = 1;\r\nreg = stv090x_read_reg(state, STV090x_STOPCLK1);\r\nSTV090x_SETFIELD(reg, STOP_CLKPKDT2_FIELD, 1);\r\nSTV090x_SETFIELD(reg, STOP_CLKADCI2_FIELD, 1);\r\nif (full_standby)\r\nSTV090x_SETFIELD(reg, STOP_CLKFEC_FIELD, 1);\r\nif (stv090x_write_reg(state, STV090x_STOPCLK1, reg) < 0)\r\ngoto err;\r\nreg = stv090x_read_reg(state, STV090x_STOPCLK2);\r\nSTV090x_SETFIELD(reg, STOP_CLKSAMP2_FIELD, 1);\r\nSTV090x_SETFIELD(reg, STOP_CLKVIT2_FIELD, 1);\r\nif (full_standby)\r\nSTV090x_SETFIELD(reg, STOP_CLKTS_FIELD, 1);\r\nif (stv090x_write_reg(state, STV090x_STOPCLK2, reg) < 0)\r\ngoto err;\r\nbreak;\r\ndefault:\r\ndprintk(FE_ERROR, 1, "Wrong demodulator!");\r\nbreak;\r\n}\r\nif (full_standby) {\r\nreg = stv090x_read_reg(state, STV090x_SYNTCTRL);\r\nSTV090x_SETFIELD(reg, STANDBY_FIELD, 0x01);\r\nif (stv090x_write_reg(state, STV090x_SYNTCTRL, reg) < 0)\r\ngoto err;\r\n}\r\nmutex_unlock(&state->internal->demod_lock);\r\nreturn 0;\r\nerr_gateoff:\r\nstv090x_i2c_gate_ctrl(state, 0);\r\nerr:\r\nmutex_unlock(&state->internal->demod_lock);\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic int stv090x_wakeup(struct dvb_frontend *fe)\r\n{\r\nstruct stv090x_state *state = fe->demodulator_priv;\r\nu32 reg;\r\ndprintk(FE_DEBUG, 1, "Wake %s(%d) from standby",\r\nstate->device == STV0900 ? "STV0900" : "STV0903",\r\nstate->demod);\r\nmutex_lock(&state->internal->demod_lock);\r\nreg = stv090x_read_reg(state, STV090x_SYNTCTRL);\r\nSTV090x_SETFIELD(reg, STANDBY_FIELD, 0x00);\r\nif (stv090x_write_reg(state, STV090x_SYNTCTRL, reg) < 0)\r\ngoto err;\r\nswitch (state->demod) {\r\ncase STV090x_DEMODULATOR_0:\r\nreg = stv090x_read_reg(state, STV090x_TSTTNR1);\r\nSTV090x_SETFIELD(reg, ADC1_PON_FIELD, 1);\r\nif (stv090x_write_reg(state, STV090x_TSTTNR1, reg) < 0)\r\ngoto err;\r\nreg = stv090x_read_reg(state, STV090x_TSTTNR2);\r\nSTV090x_SETFIELD(reg, DISEQC1_PON_FIELD, 1);\r\nif (stv090x_write_reg(state, STV090x_TSTTNR2, reg) < 0)\r\ngoto err;\r\nreg = stv090x_read_reg(state, STV090x_STOPCLK1);\r\nSTV090x_SETFIELD(reg, STOP_CLKPKDT1_FIELD, 0);\r\nSTV090x_SETFIELD(reg, STOP_CLKADCI1_FIELD, 0);\r\nSTV090x_SETFIELD(reg, STOP_CLKFEC_FIELD, 0);\r\nif (stv090x_write_reg(state, STV090x_STOPCLK1, reg) < 0)\r\ngoto err;\r\nreg = stv090x_read_reg(state, STV090x_STOPCLK2);\r\nSTV090x_SETFIELD(reg, STOP_CLKSAMP1_FIELD, 0);\r\nSTV090x_SETFIELD(reg, STOP_CLKVIT1_FIELD, 0);\r\nSTV090x_SETFIELD(reg, STOP_CLKTS_FIELD, 0);\r\nif (stv090x_write_reg(state, STV090x_STOPCLK2, reg) < 0)\r\ngoto err;\r\nbreak;\r\ncase STV090x_DEMODULATOR_1:\r\nreg = stv090x_read_reg(state, STV090x_TSTTNR3);\r\nSTV090x_SETFIELD(reg, ADC2_PON_FIELD, 1);\r\nif (stv090x_write_reg(state, STV090x_TSTTNR3, reg) < 0)\r\ngoto err;\r\nreg = stv090x_read_reg(state, STV090x_TSTTNR4);\r\nSTV090x_SETFIELD(reg, DISEQC2_PON_FIELD, 1);\r\nif (stv090x_write_reg(state, STV090x_TSTTNR4, reg) < 0)\r\ngoto err;\r\nreg = stv090x_read_reg(state, STV090x_STOPCLK1);\r\nSTV090x_SETFIELD(reg, STOP_CLKPKDT2_FIELD, 0);\r\nSTV090x_SETFIELD(reg, STOP_CLKADCI2_FIELD, 0);\r\nSTV090x_SETFIELD(reg, STOP_CLKFEC_FIELD, 0);\r\nif (stv090x_write_reg(state, STV090x_STOPCLK1, reg) < 0)\r\ngoto err;\r\nreg = stv090x_read_reg(state, STV090x_STOPCLK2);\r\nSTV090x_SETFIELD(reg, STOP_CLKSAMP2_FIELD, 0);\r\nSTV090x_SETFIELD(reg, STOP_CLKVIT2_FIELD, 0);\r\nSTV090x_SETFIELD(reg, STOP_CLKTS_FIELD, 0);\r\nif (stv090x_write_reg(state, STV090x_STOPCLK2, reg) < 0)\r\ngoto err;\r\nbreak;\r\ndefault:\r\ndprintk(FE_ERROR, 1, "Wrong demodulator!");\r\nbreak;\r\n}\r\nmutex_unlock(&state->internal->demod_lock);\r\nreturn 0;\r\nerr:\r\nmutex_unlock(&state->internal->demod_lock);\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic void stv090x_release(struct dvb_frontend *fe)\r\n{\r\nstruct stv090x_state *state = fe->demodulator_priv;\r\nstate->internal->num_used--;\r\nif (state->internal->num_used <= 0) {\r\ndprintk(FE_ERROR, 1, "Actually removing");\r\nremove_dev(state->internal);\r\nkfree(state->internal);\r\n}\r\nkfree(state);\r\n}\r\nstatic int stv090x_ldpc_mode(struct stv090x_state *state, enum stv090x_mode ldpc_mode)\r\n{\r\nu32 reg = 0;\r\nreg = stv090x_read_reg(state, STV090x_GENCFG);\r\nswitch (ldpc_mode) {\r\ncase STV090x_DUAL:\r\ndefault:\r\nif ((state->demod_mode != STV090x_DUAL) || (STV090x_GETFIELD(reg, DDEMOD_FIELD) != 1)) {\r\nif (stv090x_write_reg(state, STV090x_GENCFG, 0x1d) < 0)\r\ngoto err;\r\nstate->demod_mode = STV090x_DUAL;\r\nreg = stv090x_read_reg(state, STV090x_TSTRES0);\r\nSTV090x_SETFIELD(reg, FRESFEC_FIELD, 0x1);\r\nif (stv090x_write_reg(state, STV090x_TSTRES0, reg) < 0)\r\ngoto err;\r\nSTV090x_SETFIELD(reg, FRESFEC_FIELD, 0x0);\r\nif (stv090x_write_reg(state, STV090x_TSTRES0, reg) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST0, 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST1, 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST2, 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST3, 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST4, 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST5, 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST6, 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST7, 0xcc) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST8, 0xcc) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLST9, 0xcc) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLSTA, 0xcc) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLSTB, 0xcc) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLSTC, 0xcc) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLSTD, 0xcc) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLSTE, 0xff) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, MODCODLSTF, 0xcf) < 0)\r\ngoto err;\r\n}\r\nbreak;\r\ncase STV090x_SINGLE:\r\nif (stv090x_stop_modcod(state) < 0)\r\ngoto err;\r\nif (stv090x_activate_modcod_single(state) < 0)\r\ngoto err;\r\nif (state->demod == STV090x_DEMODULATOR_1) {\r\nif (stv090x_write_reg(state, STV090x_GENCFG, 0x06) < 0)\r\ngoto err;\r\n} else {\r\nif (stv090x_write_reg(state, STV090x_GENCFG, 0x04) < 0)\r\ngoto err;\r\n}\r\nreg = stv090x_read_reg(state, STV090x_TSTRES0);\r\nSTV090x_SETFIELD(reg, FRESFEC_FIELD, 0x1);\r\nif (stv090x_write_reg(state, STV090x_TSTRES0, reg) < 0)\r\ngoto err;\r\nSTV090x_SETFIELD(reg, FRESFEC_FIELD, 0x0);\r\nif (stv090x_write_reg(state, STV090x_TSTRES0, reg) < 0)\r\ngoto err;\r\nreg = STV090x_READ_DEMOD(state, PDELCTRL1);\r\nSTV090x_SETFIELD_Px(reg, ALGOSWRST_FIELD, 0x01);\r\nif (STV090x_WRITE_DEMOD(state, PDELCTRL1, reg) < 0)\r\ngoto err;\r\nSTV090x_SETFIELD_Px(reg, ALGOSWRST_FIELD, 0x00);\r\nif (STV090x_WRITE_DEMOD(state, PDELCTRL1, reg) < 0)\r\ngoto err;\r\nbreak;\r\n}\r\nreturn 0;\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic u32 stv090x_get_mclk(struct stv090x_state *state)\r\n{\r\nconst struct stv090x_config *config = state->config;\r\nu32 div, reg;\r\nu8 ratio;\r\ndiv = stv090x_read_reg(state, STV090x_NCOARSE);\r\nreg = stv090x_read_reg(state, STV090x_SYNTCTRL);\r\nratio = STV090x_GETFIELD(reg, SELX1RATIO_FIELD) ? 4 : 6;\r\nreturn (div + 1) * config->xtal / ratio;\r\n}\r\nstatic int stv090x_set_mclk(struct stv090x_state *state, u32 mclk, u32 clk)\r\n{\r\nconst struct stv090x_config *config = state->config;\r\nu32 reg, div, clk_sel;\r\nreg = stv090x_read_reg(state, STV090x_SYNTCTRL);\r\nclk_sel = ((STV090x_GETFIELD(reg, SELX1RATIO_FIELD) == 1) ? 4 : 6);\r\ndiv = ((clk_sel * mclk) / config->xtal) - 1;\r\nreg = stv090x_read_reg(state, STV090x_NCOARSE);\r\nSTV090x_SETFIELD(reg, M_DIV_FIELD, div);\r\nif (stv090x_write_reg(state, STV090x_NCOARSE, reg) < 0)\r\ngoto err;\r\nstate->internal->mclk = stv090x_get_mclk(state);\r\ndiv = state->internal->mclk / 704000;\r\nif (STV090x_WRITE_DEMOD(state, F22TX, div) < 0)\r\ngoto err;\r\nif (STV090x_WRITE_DEMOD(state, F22RX, div) < 0)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic int stv090x_set_tspath(struct stv090x_state *state)\r\n{\r\nu32 reg;\r\nif (state->internal->dev_ver >= 0x20) {\r\nswitch (state->config->ts1_mode) {\r\ncase STV090x_TSMODE_PARALLEL_PUNCTURED:\r\ncase STV090x_TSMODE_DVBCI:\r\nswitch (state->config->ts2_mode) {\r\ncase STV090x_TSMODE_SERIAL_PUNCTURED:\r\ncase STV090x_TSMODE_SERIAL_CONTINUOUS:\r\ndefault:\r\nstv090x_write_reg(state, STV090x_TSGENERAL, 0x00);\r\nbreak;\r\ncase STV090x_TSMODE_PARALLEL_PUNCTURED:\r\ncase STV090x_TSMODE_DVBCI:\r\nif (stv090x_write_reg(state, STV090x_TSGENERAL, 0x06) < 0)\r\ngoto err;\r\nreg = stv090x_read_reg(state, STV090x_P1_TSCFGM);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_MANSPEED_FIELD, 3);\r\nif (stv090x_write_reg(state, STV090x_P1_TSCFGM, reg) < 0)\r\ngoto err;\r\nreg = stv090x_read_reg(state, STV090x_P2_TSCFGM);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_MANSPEED_FIELD, 3);\r\nif (stv090x_write_reg(state, STV090x_P2_TSCFGM, reg) < 0)\r\ngoto err;\r\nif (stv090x_write_reg(state, STV090x_P1_TSSPEED, 0x14) < 0)\r\ngoto err;\r\nif (stv090x_write_reg(state, STV090x_P2_TSSPEED, 0x28) < 0)\r\ngoto err;\r\nbreak;\r\n}\r\nbreak;\r\ncase STV090x_TSMODE_SERIAL_PUNCTURED:\r\ncase STV090x_TSMODE_SERIAL_CONTINUOUS:\r\ndefault:\r\nswitch (state->config->ts2_mode) {\r\ncase STV090x_TSMODE_SERIAL_PUNCTURED:\r\ncase STV090x_TSMODE_SERIAL_CONTINUOUS:\r\ndefault:\r\nif (stv090x_write_reg(state, STV090x_TSGENERAL, 0x0c) < 0)\r\ngoto err;\r\nbreak;\r\ncase STV090x_TSMODE_PARALLEL_PUNCTURED:\r\ncase STV090x_TSMODE_DVBCI:\r\nif (stv090x_write_reg(state, STV090x_TSGENERAL, 0x0a) < 0)\r\ngoto err;\r\nbreak;\r\n}\r\nbreak;\r\n}\r\n} else {\r\nswitch (state->config->ts1_mode) {\r\ncase STV090x_TSMODE_PARALLEL_PUNCTURED:\r\ncase STV090x_TSMODE_DVBCI:\r\nswitch (state->config->ts2_mode) {\r\ncase STV090x_TSMODE_SERIAL_PUNCTURED:\r\ncase STV090x_TSMODE_SERIAL_CONTINUOUS:\r\ndefault:\r\nstv090x_write_reg(state, STV090x_TSGENERAL1X, 0x10);\r\nbreak;\r\ncase STV090x_TSMODE_PARALLEL_PUNCTURED:\r\ncase STV090x_TSMODE_DVBCI:\r\nstv090x_write_reg(state, STV090x_TSGENERAL1X, 0x16);\r\nreg = stv090x_read_reg(state, STV090x_P1_TSCFGM);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_MANSPEED_FIELD, 3);\r\nif (stv090x_write_reg(state, STV090x_P1_TSCFGM, reg) < 0)\r\ngoto err;\r\nreg = stv090x_read_reg(state, STV090x_P1_TSCFGM);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_MANSPEED_FIELD, 0);\r\nif (stv090x_write_reg(state, STV090x_P1_TSCFGM, reg) < 0)\r\ngoto err;\r\nif (stv090x_write_reg(state, STV090x_P1_TSSPEED, 0x14) < 0)\r\ngoto err;\r\nif (stv090x_write_reg(state, STV090x_P2_TSSPEED, 0x28) < 0)\r\ngoto err;\r\nbreak;\r\n}\r\nbreak;\r\ncase STV090x_TSMODE_SERIAL_PUNCTURED:\r\ncase STV090x_TSMODE_SERIAL_CONTINUOUS:\r\ndefault:\r\nswitch (state->config->ts2_mode) {\r\ncase STV090x_TSMODE_SERIAL_PUNCTURED:\r\ncase STV090x_TSMODE_SERIAL_CONTINUOUS:\r\ndefault:\r\nstv090x_write_reg(state, STV090x_TSGENERAL1X, 0x14);\r\nbreak;\r\ncase STV090x_TSMODE_PARALLEL_PUNCTURED:\r\ncase STV090x_TSMODE_DVBCI:\r\nstv090x_write_reg(state, STV090x_TSGENERAL1X, 0x12);\r\nbreak;\r\n}\r\nbreak;\r\n}\r\n}\r\nswitch (state->config->ts1_mode) {\r\ncase STV090x_TSMODE_PARALLEL_PUNCTURED:\r\nreg = stv090x_read_reg(state, STV090x_P1_TSCFGH);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_TEIUPDATE_FIELD, state->config->ts1_tei);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_SERIAL_FIELD, 0x00);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_DVBCI_FIELD, 0x00);\r\nif (stv090x_write_reg(state, STV090x_P1_TSCFGH, reg) < 0)\r\ngoto err;\r\nbreak;\r\ncase STV090x_TSMODE_DVBCI:\r\nreg = stv090x_read_reg(state, STV090x_P1_TSCFGH);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_TEIUPDATE_FIELD, state->config->ts1_tei);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_SERIAL_FIELD, 0x00);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_DVBCI_FIELD, 0x01);\r\nif (stv090x_write_reg(state, STV090x_P1_TSCFGH, reg) < 0)\r\ngoto err;\r\nbreak;\r\ncase STV090x_TSMODE_SERIAL_PUNCTURED:\r\nreg = stv090x_read_reg(state, STV090x_P1_TSCFGH);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_TEIUPDATE_FIELD, state->config->ts1_tei);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_SERIAL_FIELD, 0x01);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_DVBCI_FIELD, 0x00);\r\nif (stv090x_write_reg(state, STV090x_P1_TSCFGH, reg) < 0)\r\ngoto err;\r\nbreak;\r\ncase STV090x_TSMODE_SERIAL_CONTINUOUS:\r\nreg = stv090x_read_reg(state, STV090x_P1_TSCFGH);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_TEIUPDATE_FIELD, state->config->ts1_tei);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_SERIAL_FIELD, 0x01);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_DVBCI_FIELD, 0x01);\r\nif (stv090x_write_reg(state, STV090x_P1_TSCFGH, reg) < 0)\r\ngoto err;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nswitch (state->config->ts2_mode) {\r\ncase STV090x_TSMODE_PARALLEL_PUNCTURED:\r\nreg = stv090x_read_reg(state, STV090x_P2_TSCFGH);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_TEIUPDATE_FIELD, state->config->ts2_tei);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_SERIAL_FIELD, 0x00);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_DVBCI_FIELD, 0x00);\r\nif (stv090x_write_reg(state, STV090x_P2_TSCFGH, reg) < 0)\r\ngoto err;\r\nbreak;\r\ncase STV090x_TSMODE_DVBCI:\r\nreg = stv090x_read_reg(state, STV090x_P2_TSCFGH);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_TEIUPDATE_FIELD, state->config->ts2_tei);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_SERIAL_FIELD, 0x00);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_DVBCI_FIELD, 0x01);\r\nif (stv090x_write_reg(state, STV090x_P2_TSCFGH, reg) < 0)\r\ngoto err;\r\nbreak;\r\ncase STV090x_TSMODE_SERIAL_PUNCTURED:\r\nreg = stv090x_read_reg(state, STV090x_P2_TSCFGH);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_TEIUPDATE_FIELD, state->config->ts2_tei);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_SERIAL_FIELD, 0x01);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_DVBCI_FIELD, 0x00);\r\nif (stv090x_write_reg(state, STV090x_P2_TSCFGH, reg) < 0)\r\ngoto err;\r\nbreak;\r\ncase STV090x_TSMODE_SERIAL_CONTINUOUS:\r\nreg = stv090x_read_reg(state, STV090x_P2_TSCFGH);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_TEIUPDATE_FIELD, state->config->ts2_tei);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_SERIAL_FIELD, 0x01);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_DVBCI_FIELD, 0x01);\r\nif (stv090x_write_reg(state, STV090x_P2_TSCFGH, reg) < 0)\r\ngoto err;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (state->config->ts1_clk > 0) {\r\nu32 speed;\r\nswitch (state->config->ts1_mode) {\r\ncase STV090x_TSMODE_PARALLEL_PUNCTURED:\r\ncase STV090x_TSMODE_DVBCI:\r\ndefault:\r\nspeed = state->internal->mclk /\r\n(state->config->ts1_clk / 4);\r\nif (speed < 0x08)\r\nspeed = 0x08;\r\nif (speed > 0xFF)\r\nspeed = 0xFF;\r\nbreak;\r\ncase STV090x_TSMODE_SERIAL_PUNCTURED:\r\ncase STV090x_TSMODE_SERIAL_CONTINUOUS:\r\nspeed = state->internal->mclk /\r\n(state->config->ts1_clk / 32);\r\nif (speed < 0x20)\r\nspeed = 0x20;\r\nif (speed > 0xFF)\r\nspeed = 0xFF;\r\nbreak;\r\n}\r\nreg = stv090x_read_reg(state, STV090x_P1_TSCFGM);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_MANSPEED_FIELD, 3);\r\nif (stv090x_write_reg(state, STV090x_P1_TSCFGM, reg) < 0)\r\ngoto err;\r\nif (stv090x_write_reg(state, STV090x_P1_TSSPEED, speed) < 0)\r\ngoto err;\r\n}\r\nif (state->config->ts2_clk > 0) {\r\nu32 speed;\r\nswitch (state->config->ts2_mode) {\r\ncase STV090x_TSMODE_PARALLEL_PUNCTURED:\r\ncase STV090x_TSMODE_DVBCI:\r\ndefault:\r\nspeed = state->internal->mclk /\r\n(state->config->ts2_clk / 4);\r\nif (speed < 0x08)\r\nspeed = 0x08;\r\nif (speed > 0xFF)\r\nspeed = 0xFF;\r\nbreak;\r\ncase STV090x_TSMODE_SERIAL_PUNCTURED:\r\ncase STV090x_TSMODE_SERIAL_CONTINUOUS:\r\nspeed = state->internal->mclk /\r\n(state->config->ts2_clk / 32);\r\nif (speed < 0x20)\r\nspeed = 0x20;\r\nif (speed > 0xFF)\r\nspeed = 0xFF;\r\nbreak;\r\n}\r\nreg = stv090x_read_reg(state, STV090x_P2_TSCFGM);\r\nSTV090x_SETFIELD_Px(reg, TSFIFO_MANSPEED_FIELD, 3);\r\nif (stv090x_write_reg(state, STV090x_P2_TSCFGM, reg) < 0)\r\ngoto err;\r\nif (stv090x_write_reg(state, STV090x_P2_TSSPEED, speed) < 0)\r\ngoto err;\r\n}\r\nreg = stv090x_read_reg(state, STV090x_P2_TSCFGH);\r\nSTV090x_SETFIELD_Px(reg, RST_HWARE_FIELD, 0x01);\r\nif (stv090x_write_reg(state, STV090x_P2_TSCFGH, reg) < 0)\r\ngoto err;\r\nSTV090x_SETFIELD_Px(reg, RST_HWARE_FIELD, 0x00);\r\nif (stv090x_write_reg(state, STV090x_P2_TSCFGH, reg) < 0)\r\ngoto err;\r\nreg = stv090x_read_reg(state, STV090x_P1_TSCFGH);\r\nSTV090x_SETFIELD_Px(reg, RST_HWARE_FIELD, 0x01);\r\nif (stv090x_write_reg(state, STV090x_P1_TSCFGH, reg) < 0)\r\ngoto err;\r\nSTV090x_SETFIELD_Px(reg, RST_HWARE_FIELD, 0x00);\r\nif (stv090x_write_reg(state, STV090x_P1_TSCFGH, reg) < 0)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic int stv090x_init(struct dvb_frontend *fe)\r\n{\r\nstruct stv090x_state *state = fe->demodulator_priv;\r\nconst struct stv090x_config *config = state->config;\r\nu32 reg;\r\nif (state->internal->mclk == 0) {\r\nif (stv090x_i2c_gate_ctrl(state, 1) < 0)\r\ngoto err;\r\nif (config->tuner_init) {\r\nif (config->tuner_init(fe) < 0)\r\ngoto err_gateoff;\r\n}\r\nif (stv090x_i2c_gate_ctrl(state, 0) < 0)\r\ngoto err;\r\nstv090x_set_mclk(state, 135000000, config->xtal);\r\nmsleep(5);\r\nif (stv090x_write_reg(state, STV090x_SYNTCTRL,\r\n0x20 | config->clk_mode) < 0)\r\ngoto err;\r\nstv090x_get_mclk(state);\r\n}\r\nif (stv090x_wakeup(fe) < 0) {\r\ndprintk(FE_ERROR, 1, "Error waking device");\r\ngoto err;\r\n}\r\nif (stv090x_ldpc_mode(state, state->demod_mode) < 0)\r\ngoto err;\r\nreg = STV090x_READ_DEMOD(state, TNRCFG2);\r\nSTV090x_SETFIELD_Px(reg, TUN_IQSWAP_FIELD, state->inversion);\r\nif (STV090x_WRITE_DEMOD(state, TNRCFG2, reg) < 0)\r\ngoto err;\r\nreg = STV090x_READ_DEMOD(state, DEMOD);\r\nSTV090x_SETFIELD_Px(reg, ROLLOFF_CONTROL_FIELD, state->rolloff);\r\nif (STV090x_WRITE_DEMOD(state, DEMOD, reg) < 0)\r\ngoto err;\r\nif (stv090x_i2c_gate_ctrl(state, 1) < 0)\r\ngoto err;\r\nif (config->tuner_set_mode) {\r\nif (config->tuner_set_mode(fe, TUNER_WAKE) < 0)\r\ngoto err_gateoff;\r\n}\r\nif (config->tuner_init) {\r\nif (config->tuner_init(fe) < 0)\r\ngoto err_gateoff;\r\n}\r\nif (stv090x_i2c_gate_ctrl(state, 0) < 0)\r\ngoto err;\r\nif (stv090x_set_tspath(state) < 0)\r\ngoto err;\r\nreturn 0;\r\nerr_gateoff:\r\nstv090x_i2c_gate_ctrl(state, 0);\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nstatic int stv090x_setup(struct dvb_frontend *fe)\r\n{\r\nstruct stv090x_state *state = fe->demodulator_priv;\r\nconst struct stv090x_config *config = state->config;\r\nconst struct stv090x_reg *stv090x_initval = NULL;\r\nconst struct stv090x_reg *stv090x_cut20_val = NULL;\r\nunsigned long t1_size = 0, t2_size = 0;\r\nu32 reg = 0;\r\nint i;\r\nif (state->device == STV0900) {\r\ndprintk(FE_DEBUG, 1, "Initializing STV0900");\r\nstv090x_initval = stv0900_initval;\r\nt1_size = ARRAY_SIZE(stv0900_initval);\r\nstv090x_cut20_val = stv0900_cut20_val;\r\nt2_size = ARRAY_SIZE(stv0900_cut20_val);\r\n} else if (state->device == STV0903) {\r\ndprintk(FE_DEBUG, 1, "Initializing STV0903");\r\nstv090x_initval = stv0903_initval;\r\nt1_size = ARRAY_SIZE(stv0903_initval);\r\nstv090x_cut20_val = stv0903_cut20_val;\r\nt2_size = ARRAY_SIZE(stv0903_cut20_val);\r\n}\r\nif (stv090x_write_reg(state, STV090x_P1_DMDISTATE, 0x5c) < 0)\r\ngoto err;\r\nif (stv090x_write_reg(state, STV090x_P2_DMDISTATE, 0x5c) < 0)\r\ngoto err;\r\nmsleep(5);\r\nif (stv090x_write_reg(state, STV090x_P1_TNRCFG, 0x6c) < 0)\r\ngoto err;\r\nif (stv090x_write_reg(state, STV090x_P2_TNRCFG, 0x6c) < 0)\r\ngoto err;\r\nSTV090x_SETFIELD_Px(reg, ENARPT_LEVEL_FIELD, config->repeater_level);\r\nif (stv090x_write_reg(state, STV090x_P1_I2CRPT, reg) < 0)\r\ngoto err;\r\nif (stv090x_write_reg(state, STV090x_P2_I2CRPT, reg) < 0)\r\ngoto err;\r\nif (stv090x_write_reg(state, STV090x_NCOARSE, 0x13) < 0)\r\ngoto err;\r\nmsleep(5);\r\nif (stv090x_write_reg(state, STV090x_I2CCFG, 0x08) < 0)\r\ngoto err;\r\nif (stv090x_write_reg(state, STV090x_SYNTCTRL, 0x20 | config->clk_mode) < 0)\r\ngoto err;\r\nmsleep(5);\r\ndprintk(FE_DEBUG, 1, "Setting up initial values");\r\nfor (i = 0; i < t1_size; i++) {\r\nif (stv090x_write_reg(state, stv090x_initval[i].addr, stv090x_initval[i].data) < 0)\r\ngoto err;\r\n}\r\nstate->internal->dev_ver = stv090x_read_reg(state, STV090x_MID);\r\nif (state->internal->dev_ver >= 0x20) {\r\nif (stv090x_write_reg(state, STV090x_TSGENERAL, 0x0c) < 0)\r\ngoto err;\r\ndprintk(FE_DEBUG, 1, "Setting up Cut 2.0 initial values");\r\nfor (i = 0; i < t2_size; i++) {\r\nif (stv090x_write_reg(state, stv090x_cut20_val[i].addr, stv090x_cut20_val[i].data) < 0)\r\ngoto err;\r\n}\r\n} else if (state->internal->dev_ver < 0x20) {\r\ndprintk(FE_ERROR, 1, "ERROR: Unsupported Cut: 0x%02x!",\r\nstate->internal->dev_ver);\r\ngoto err;\r\n} else if (state->internal->dev_ver > 0x30) {\r\ndprintk(FE_ERROR, 1, "INFO: Cut: 0x%02x probably incomplete support!",\r\nstate->internal->dev_ver);\r\n}\r\nreg = stv090x_read_reg(state, STV090x_TSTTNR1);\r\nSTV090x_SETFIELD(reg, ADC1_INMODE_FIELD,\r\n(config->adc1_range == STV090x_ADC_1Vpp) ? 0 : 1);\r\nif (stv090x_write_reg(state, STV090x_TSTTNR1, reg) < 0)\r\ngoto err;\r\nreg = stv090x_read_reg(state, STV090x_TSTTNR3);\r\nSTV090x_SETFIELD(reg, ADC2_INMODE_FIELD,\r\n(config->adc2_range == STV090x_ADC_1Vpp) ? 0 : 1);\r\nif (stv090x_write_reg(state, STV090x_TSTTNR3, reg) < 0)\r\ngoto err;\r\nif (stv090x_write_reg(state, STV090x_TSTRES0, 0x80) < 0)\r\ngoto err;\r\nif (stv090x_write_reg(state, STV090x_TSTRES0, 0x00) < 0)\r\ngoto err;\r\nreturn 0;\r\nerr:\r\ndprintk(FE_ERROR, 1, "I/O error");\r\nreturn -1;\r\n}\r\nint stv090x_set_gpio(struct dvb_frontend *fe, u8 gpio, u8 dir, u8 value,\r\nu8 xor_value)\r\n{\r\nstruct stv090x_state *state = fe->demodulator_priv;\r\nu8 reg = 0;\r\nSTV090x_SETFIELD(reg, GPIOx_OPD_FIELD, dir);\r\nSTV090x_SETFIELD(reg, GPIOx_CONFIG_FIELD, value);\r\nSTV090x_SETFIELD(reg, GPIOx_XOR_FIELD, xor_value);\r\nreturn stv090x_write_reg(state, STV090x_GPIOxCFG(gpio), reg);\r\n}\r\nstruct dvb_frontend *stv090x_attach(const struct stv090x_config *config,\r\nstruct i2c_adapter *i2c,\r\nenum stv090x_demodulator demod)\r\n{\r\nstruct stv090x_state *state = NULL;\r\nstruct stv090x_dev *temp_int;\r\nstate = kzalloc(sizeof (struct stv090x_state), GFP_KERNEL);\r\nif (state == NULL)\r\ngoto error;\r\nstate->verbose = &verbose;\r\nstate->config = config;\r\nstate->i2c = i2c;\r\nstate->frontend.ops = stv090x_ops;\r\nstate->frontend.demodulator_priv = state;\r\nstate->demod = demod;\r\nstate->demod_mode = config->demod_mode;\r\nstate->device = config->device;\r\nstate->rolloff = STV090x_RO_35;\r\ntemp_int = find_dev(state->i2c,\r\nstate->config->address);\r\nif ((temp_int != NULL) && (state->demod_mode == STV090x_DUAL)) {\r\nstate->internal = temp_int->internal;\r\nstate->internal->num_used++;\r\ndprintk(FE_INFO, 1, "Found Internal Structure!");\r\n} else {\r\nstate->internal = kmalloc(sizeof(struct stv090x_internal),\r\nGFP_KERNEL);\r\nif (!state->internal)\r\ngoto error;\r\ntemp_int = append_internal(state->internal);\r\nif (!temp_int) {\r\nkfree(state->internal);\r\ngoto error;\r\n}\r\nstate->internal->num_used = 1;\r\nstate->internal->mclk = 0;\r\nstate->internal->dev_ver = 0;\r\nstate->internal->i2c_adap = state->i2c;\r\nstate->internal->i2c_addr = state->config->address;\r\ndprintk(FE_INFO, 1, "Create New Internal Structure!");\r\nmutex_init(&state->internal->demod_lock);\r\nmutex_init(&state->internal->tuner_lock);\r\nif (stv090x_setup(&state->frontend) < 0) {\r\ndprintk(FE_ERROR, 1, "Error setting up device");\r\ngoto err_remove;\r\n}\r\n}\r\nif (config->diseqc_envelope_mode)\r\nstv090x_send_diseqc_burst(&state->frontend, SEC_MINI_A);\r\ndprintk(FE_ERROR, 1, "Attaching %s demodulator(%d) Cut=0x%02x",\r\nstate->device == STV0900 ? "STV0900" : "STV0903",\r\ndemod,\r\nstate->internal->dev_ver);\r\nreturn &state->frontend;\r\nerr_remove:\r\nremove_dev(state->internal);\r\nkfree(state->internal);\r\nerror:\r\nkfree(state);\r\nreturn NULL;\r\n}

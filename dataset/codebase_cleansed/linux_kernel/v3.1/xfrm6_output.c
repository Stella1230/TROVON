int xfrm6_find_1stfragopt(struct xfrm_state *x, struct sk_buff *skb,\r\nu8 **prevhdr)\r\n{\r\nreturn ip6_find_1stfragopt(skb, prevhdr);\r\n}\r\nstatic int xfrm6_tunnel_check_size(struct sk_buff *skb)\r\n{\r\nint mtu, ret = 0;\r\nstruct dst_entry *dst = skb_dst(skb);\r\nmtu = dst_mtu(dst);\r\nif (mtu < IPV6_MIN_MTU)\r\nmtu = IPV6_MIN_MTU;\r\nif (!skb->local_df && skb->len > mtu) {\r\nskb->dev = dst->dev;\r\nicmpv6_send(skb, ICMPV6_PKT_TOOBIG, 0, mtu);\r\nret = -EMSGSIZE;\r\n}\r\nreturn ret;\r\n}\r\nint xfrm6_extract_output(struct xfrm_state *x, struct sk_buff *skb)\r\n{\r\nint err;\r\nerr = xfrm6_tunnel_check_size(skb);\r\nif (err)\r\nreturn err;\r\nXFRM_MODE_SKB_CB(skb)->protocol = ipv6_hdr(skb)->nexthdr;\r\nreturn xfrm6_extract_header(skb);\r\n}\r\nint xfrm6_prepare_output(struct xfrm_state *x, struct sk_buff *skb)\r\n{\r\nint err;\r\nerr = xfrm_inner_extract_output(x, skb);\r\nif (err)\r\nreturn err;\r\nmemset(IP6CB(skb), 0, sizeof(*IP6CB(skb)));\r\n#ifdef CONFIG_NETFILTER\r\nIP6CB(skb)->flags |= IP6SKB_XFRM_TRANSFORMED;\r\n#endif\r\nskb->protocol = htons(ETH_P_IPV6);\r\nskb->local_df = 1;\r\nreturn x->outer_mode->output2(x, skb);\r\n}\r\nint xfrm6_output_finish(struct sk_buff *skb)\r\n{\r\n#ifdef CONFIG_NETFILTER\r\nIP6CB(skb)->flags |= IP6SKB_XFRM_TRANSFORMED;\r\n#endif\r\nskb->protocol = htons(ETH_P_IPV6);\r\nreturn xfrm_output(skb);\r\n}\r\nstatic int __xfrm6_output(struct sk_buff *skb)\r\n{\r\nstruct dst_entry *dst = skb_dst(skb);\r\nstruct xfrm_state *x = dst->xfrm;\r\nif ((x && x->props.mode == XFRM_MODE_TUNNEL) &&\r\n((skb->len > ip6_skb_dst_mtu(skb) && !skb_is_gso(skb)) ||\r\ndst_allfrag(skb_dst(skb)))) {\r\nreturn ip6_fragment(skb, x->outer_mode->afinfo->output_finish);\r\n}\r\nreturn x->outer_mode->afinfo->output_finish(skb);\r\n}\r\nint xfrm6_output(struct sk_buff *skb)\r\n{\r\nreturn NF_HOOK(NFPROTO_IPV6, NF_INET_POST_ROUTING, skb, NULL,\r\nskb_dst(skb)->dev, __xfrm6_output);\r\n}

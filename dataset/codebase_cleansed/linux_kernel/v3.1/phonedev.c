static int phone_open(struct inode *inode, struct file *file)\r\n{\r\nunsigned int minor = iminor(inode);\r\nint err = 0;\r\nstruct phone_device *p;\r\nconst struct file_operations *old_fops, *new_fops = NULL;\r\nif (minor >= PHONE_NUM_DEVICES)\r\nreturn -ENODEV;\r\nmutex_lock(&phone_lock);\r\np = phone_device[minor];\r\nif (p)\r\nnew_fops = fops_get(p->f_op);\r\nif (!new_fops) {\r\nmutex_unlock(&phone_lock);\r\nrequest_module("char-major-%d-%d", PHONE_MAJOR, minor);\r\nmutex_lock(&phone_lock);\r\np = phone_device[minor];\r\nif (p == NULL || (new_fops = fops_get(p->f_op)) == NULL)\r\n{\r\nerr=-ENODEV;\r\ngoto end;\r\n}\r\n}\r\nold_fops = file->f_op;\r\nfile->f_op = new_fops;\r\nif (p->open)\r\nerr = p->open(p, file);\r\nif (err) {\r\nfops_put(file->f_op);\r\nfile->f_op = fops_get(old_fops);\r\n}\r\nfops_put(old_fops);\r\nend:\r\nmutex_unlock(&phone_lock);\r\nreturn err;\r\n}\r\nint phone_register_device(struct phone_device *p, int unit)\r\n{\r\nint base;\r\nint end;\r\nint i;\r\nbase = 0;\r\nend = PHONE_NUM_DEVICES - 1;\r\nif (unit != PHONE_UNIT_ANY) {\r\nbase = unit;\r\nend = unit + 1;\r\n}\r\nmutex_lock(&phone_lock);\r\nfor (i = base; i < end; i++) {\r\nif (phone_device[i] == NULL) {\r\nphone_device[i] = p;\r\np->minor = i;\r\nmutex_unlock(&phone_lock);\r\nreturn 0;\r\n}\r\n}\r\nmutex_unlock(&phone_lock);\r\nreturn -ENFILE;\r\n}\r\nvoid phone_unregister_device(struct phone_device *pfd)\r\n{\r\nmutex_lock(&phone_lock);\r\nif (likely(phone_device[pfd->minor] == pfd))\r\nphone_device[pfd->minor] = NULL;\r\nmutex_unlock(&phone_lock);\r\n}\r\nstatic int __init telephony_init(void)\r\n{\r\nprintk(KERN_INFO "Linux telephony interface: v1.00\n");\r\nif (register_chrdev(PHONE_MAJOR, "telephony", &phone_fops)) {\r\nprintk("phonedev: unable to get major %d\n", PHONE_MAJOR);\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit telephony_exit(void)\r\n{\r\nunregister_chrdev(PHONE_MAJOR, "telephony");\r\n}

static void led_heartbeat_function(unsigned long data)\r\n{\r\nstruct led_classdev *led_cdev = (struct led_classdev *) data;\r\nstruct heartbeat_trig_data *heartbeat_data = led_cdev->trigger_data;\r\nunsigned long brightness = LED_OFF;\r\nunsigned long delay = 0;\r\nswitch (heartbeat_data->phase) {\r\ncase 0:\r\nheartbeat_data->period = 300 +\r\n(6720 << FSHIFT) / (5 * avenrun[0] + (7 << FSHIFT));\r\nheartbeat_data->period =\r\nmsecs_to_jiffies(heartbeat_data->period);\r\ndelay = msecs_to_jiffies(70);\r\nheartbeat_data->phase++;\r\nbrightness = led_cdev->max_brightness;\r\nbreak;\r\ncase 1:\r\ndelay = heartbeat_data->period / 4 - msecs_to_jiffies(70);\r\nheartbeat_data->phase++;\r\nbreak;\r\ncase 2:\r\ndelay = msecs_to_jiffies(70);\r\nheartbeat_data->phase++;\r\nbrightness = led_cdev->max_brightness;\r\nbreak;\r\ndefault:\r\ndelay = heartbeat_data->period - heartbeat_data->period / 4 -\r\nmsecs_to_jiffies(70);\r\nheartbeat_data->phase = 0;\r\nbreak;\r\n}\r\nled_set_brightness(led_cdev, brightness);\r\nmod_timer(&heartbeat_data->timer, jiffies + delay);\r\n}\r\nstatic void heartbeat_trig_activate(struct led_classdev *led_cdev)\r\n{\r\nstruct heartbeat_trig_data *heartbeat_data;\r\nheartbeat_data = kzalloc(sizeof(*heartbeat_data), GFP_KERNEL);\r\nif (!heartbeat_data)\r\nreturn;\r\nled_cdev->trigger_data = heartbeat_data;\r\nsetup_timer(&heartbeat_data->timer,\r\nled_heartbeat_function, (unsigned long) led_cdev);\r\nheartbeat_data->phase = 0;\r\nled_heartbeat_function(heartbeat_data->timer.data);\r\n}\r\nstatic void heartbeat_trig_deactivate(struct led_classdev *led_cdev)\r\n{\r\nstruct heartbeat_trig_data *heartbeat_data = led_cdev->trigger_data;\r\nif (heartbeat_data) {\r\ndel_timer_sync(&heartbeat_data->timer);\r\nkfree(heartbeat_data);\r\n}\r\n}\r\nstatic int __init heartbeat_trig_init(void)\r\n{\r\nreturn led_trigger_register(&heartbeat_led_trigger);\r\n}\r\nstatic void __exit heartbeat_trig_exit(void)\r\n{\r\nled_trigger_unregister(&heartbeat_led_trigger);\r\n}

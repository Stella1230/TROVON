static int buffer_activate(struct saa7134_dev *dev,\r\nstruct saa7134_buf *buf,\r\nstruct saa7134_buf *next)\r\n{\r\ndprintk("buffer_activate [%p]",buf);\r\nbuf->vb.state = VIDEOBUF_ACTIVE;\r\nbuf->top_seen = 0;\r\nif (NULL == next)\r\nnext = buf;\r\nif (V4L2_FIELD_TOP == buf->vb.field) {\r\ndprintk("- [top] buf=%p next=%p\n",buf,next);\r\nsaa_writel(SAA7134_RS_BA1(5),saa7134_buffer_base(buf));\r\nsaa_writel(SAA7134_RS_BA2(5),saa7134_buffer_base(next));\r\n} else {\r\ndprintk("- [bottom] buf=%p next=%p\n",buf,next);\r\nsaa_writel(SAA7134_RS_BA1(5),saa7134_buffer_base(next));\r\nsaa_writel(SAA7134_RS_BA2(5),saa7134_buffer_base(buf));\r\n}\r\nsaa7134_set_dmabits(dev);\r\nmod_timer(&dev->ts_q.timeout, jiffies+TS_BUFFER_TIMEOUT);\r\nif (!dev->ts_started)\r\nsaa7134_ts_start(dev);\r\nreturn 0;\r\n}\r\nstatic int buffer_prepare(struct videobuf_queue *q, struct videobuf_buffer *vb,\r\nenum v4l2_field field)\r\n{\r\nstruct saa7134_dev *dev = q->priv_data;\r\nstruct saa7134_buf *buf = container_of(vb,struct saa7134_buf,vb);\r\nunsigned int lines, llength, size;\r\nint err;\r\ndprintk("buffer_prepare [%p,%s]\n",buf,v4l2_field_names[field]);\r\nllength = TS_PACKET_SIZE;\r\nlines = dev->ts.nr_packets;\r\nsize = lines * llength;\r\nif (0 != buf->vb.baddr && buf->vb.bsize < size)\r\nreturn -EINVAL;\r\nif (buf->vb.size != size) {\r\nsaa7134_dma_free(q,buf);\r\n}\r\nif (VIDEOBUF_NEEDS_INIT == buf->vb.state) {\r\nstruct videobuf_dmabuf *dma=videobuf_to_dma(&buf->vb);\r\ndprintk("buffer_prepare: needs_init\n");\r\nbuf->vb.width = llength;\r\nbuf->vb.height = lines;\r\nbuf->vb.size = size;\r\nbuf->pt = &dev->ts.pt_ts;\r\nerr = videobuf_iolock(q,&buf->vb,NULL);\r\nif (err)\r\ngoto oops;\r\nerr = saa7134_pgtable_build(dev->pci,buf->pt,\r\ndma->sglist,\r\ndma->sglen,\r\nsaa7134_buffer_startpage(buf));\r\nif (err)\r\ngoto oops;\r\n}\r\nbuf->vb.state = VIDEOBUF_PREPARED;\r\nbuf->activate = buffer_activate;\r\nbuf->vb.field = field;\r\nreturn 0;\r\noops:\r\nsaa7134_dma_free(q,buf);\r\nreturn err;\r\n}\r\nstatic int\r\nbuffer_setup(struct videobuf_queue *q, unsigned int *count, unsigned int *size)\r\n{\r\nstruct saa7134_dev *dev = q->priv_data;\r\n*size = TS_PACKET_SIZE * dev->ts.nr_packets;\r\nif (0 == *count)\r\n*count = dev->ts.nr_bufs;\r\n*count = saa7134_buffer_count(*size,*count);\r\nreturn 0;\r\n}\r\nstatic void buffer_queue(struct videobuf_queue *q, struct videobuf_buffer *vb)\r\n{\r\nstruct saa7134_dev *dev = q->priv_data;\r\nstruct saa7134_buf *buf = container_of(vb,struct saa7134_buf,vb);\r\nsaa7134_buffer_queue(dev,&dev->ts_q,buf);\r\n}\r\nstatic void buffer_release(struct videobuf_queue *q, struct videobuf_buffer *vb)\r\n{\r\nstruct saa7134_buf *buf = container_of(vb,struct saa7134_buf,vb);\r\nstruct saa7134_dev *dev = q->priv_data;\r\nif (dev->ts_started)\r\nsaa7134_ts_stop(dev);\r\nsaa7134_dma_free(q,buf);\r\n}\r\nint saa7134_ts_init_hw(struct saa7134_dev *dev)\r\n{\r\nsaa_writeb(SAA7134_TS_SERIAL1, 0x00);\r\nsaa_writeb(SAA7134_TS_PARALLEL, 0x6c);\r\nsaa_writeb(SAA7134_TS_PARALLEL_SERIAL, (TS_PACKET_SIZE-1));\r\nsaa_writeb(SAA7134_TS_DMA0, ((dev->ts.nr_packets-1)&0xff));\r\nsaa_writeb(SAA7134_TS_DMA1, (((dev->ts.nr_packets-1)>>8)&0xff));\r\nsaa_writeb(SAA7134_TS_DMA2,\r\n((((dev->ts.nr_packets-1)>>16)&0x3f) | 0x00));\r\nreturn 0;\r\n}\r\nint saa7134_ts_init1(struct saa7134_dev *dev)\r\n{\r\nif (tsbufs < 2)\r\ntsbufs = 2;\r\nif (tsbufs > VIDEO_MAX_FRAME)\r\ntsbufs = VIDEO_MAX_FRAME;\r\nif (ts_nr_packets < 4)\r\nts_nr_packets = 4;\r\nif (ts_nr_packets > 312)\r\nts_nr_packets = 312;\r\ndev->ts.nr_bufs = tsbufs;\r\ndev->ts.nr_packets = ts_nr_packets;\r\nINIT_LIST_HEAD(&dev->ts_q.queue);\r\ninit_timer(&dev->ts_q.timeout);\r\ndev->ts_q.timeout.function = saa7134_buffer_timeout;\r\ndev->ts_q.timeout.data = (unsigned long)(&dev->ts_q);\r\ndev->ts_q.dev = dev;\r\ndev->ts_q.need_two = 1;\r\ndev->ts_started = 0;\r\nsaa7134_pgtable_alloc(dev->pci,&dev->ts.pt_ts);\r\nsaa7134_ts_init_hw(dev);\r\nreturn 0;\r\n}\r\nint saa7134_ts_stop(struct saa7134_dev *dev)\r\n{\r\ndprintk("TS stop\n");\r\nBUG_ON(!dev->ts_started);\r\nswitch (saa7134_boards[dev->board].ts_type) {\r\ncase SAA7134_MPEG_TS_PARALLEL:\r\nsaa_writeb(SAA7134_TS_PARALLEL, 0x6c);\r\ndev->ts_started = 0;\r\nbreak;\r\ncase SAA7134_MPEG_TS_SERIAL:\r\nsaa_writeb(SAA7134_TS_SERIAL0, 0x40);\r\ndev->ts_started = 0;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nint saa7134_ts_start(struct saa7134_dev *dev)\r\n{\r\ndprintk("TS start\n");\r\nBUG_ON(dev->ts_started);\r\nsaa_writeb(SAA7134_TS_DMA0, (dev->ts.nr_packets - 1) & 0xff);\r\nsaa_writeb(SAA7134_TS_DMA1,\r\n((dev->ts.nr_packets - 1) >> 8) & 0xff);\r\nsaa_writeb(SAA7134_TS_DMA2,\r\n(((dev->ts.nr_packets - 1) >> 16) & 0x3f) | 0x00);\r\nsaa_writel(SAA7134_RS_PITCH(5), TS_PACKET_SIZE);\r\nsaa_writel(SAA7134_RS_CONTROL(5), SAA7134_RS_CONTROL_BURST_16 |\r\nSAA7134_RS_CONTROL_ME |\r\n(dev->ts.pt_ts.dma >> 12));\r\nsaa_writeb(SAA7134_TS_SERIAL1, 0x00);\r\nsaa_writeb(SAA7134_TS_SERIAL1, 0x03);\r\nsaa_writeb(SAA7134_TS_SERIAL1, 0x00);\r\nsaa_writeb(SAA7134_TS_SERIAL1, 0x01);\r\nsaa_writeb(SAA7134_TS_SERIAL1, 0x00);\r\nswitch (saa7134_boards[dev->board].ts_type) {\r\ncase SAA7134_MPEG_TS_PARALLEL:\r\nsaa_writeb(SAA7134_TS_SERIAL0, 0x40);\r\nsaa_writeb(SAA7134_TS_PARALLEL, 0xec |\r\n(saa7134_boards[dev->board].ts_force_val << 4));\r\nbreak;\r\ncase SAA7134_MPEG_TS_SERIAL:\r\nsaa_writeb(SAA7134_TS_SERIAL0, 0xd8);\r\nsaa_writeb(SAA7134_TS_PARALLEL, 0x6c |\r\n(saa7134_boards[dev->board].ts_force_val << 4));\r\nsaa_writeb(SAA7134_TS_PARALLEL_SERIAL, 0xbc);\r\nsaa_writeb(SAA7134_TS_SERIAL1, 0x02);\r\nbreak;\r\n}\r\ndev->ts_started = 1;\r\nreturn 0;\r\n}\r\nint saa7134_ts_fini(struct saa7134_dev *dev)\r\n{\r\nsaa7134_pgtable_free(dev->pci,&dev->ts.pt_ts);\r\nreturn 0;\r\n}\r\nvoid saa7134_irq_ts_done(struct saa7134_dev *dev, unsigned long status)\r\n{\r\nenum v4l2_field field;\r\nspin_lock(&dev->slock);\r\nif (dev->ts_q.curr) {\r\nfield = dev->ts_q.curr->vb.field;\r\nif (field == V4L2_FIELD_TOP) {\r\nif ((status & 0x100000) != 0x000000)\r\ngoto done;\r\n} else {\r\nif ((status & 0x100000) != 0x100000)\r\ngoto done;\r\n}\r\nsaa7134_buffer_finish(dev,&dev->ts_q,VIDEOBUF_DONE);\r\n}\r\nsaa7134_buffer_next(dev,&dev->ts_q);\r\ndone:\r\nspin_unlock(&dev->slock);\r\n}

static u8 blizzard_read_reg(u8 reg)\r\n{\r\nu8 data;\r\nblizzard.extif->set_bits_per_cycle(8);\r\nblizzard.extif->write_command(&reg, 1);\r\nblizzard.extif->read_data(&data, 1);\r\nreturn data;\r\n}\r\nstatic void blizzard_write_reg(u8 reg, u8 val)\r\n{\r\nblizzard.extif->set_bits_per_cycle(8);\r\nblizzard.extif->write_command(&reg, 1);\r\nblizzard.extif->write_data(&val, 1);\r\n}\r\nstatic void blizzard_restart_sdram(void)\r\n{\r\nunsigned long tmo;\r\nblizzard_write_reg(BLIZZARD_MEM_BANK0_ACTIVATE, 0);\r\nudelay(50);\r\nblizzard_write_reg(BLIZZARD_MEM_BANK0_ACTIVATE, 1);\r\ntmo = jiffies + msecs_to_jiffies(200);\r\nwhile (!(blizzard_read_reg(BLIZZARD_MEM_BANK0_STATUS) & 0x01)) {\r\nif (time_after(jiffies, tmo)) {\r\ndev_err(blizzard.fbdev->dev,\r\n"s1d1374x: SDRAM not ready\n");\r\nbreak;\r\n}\r\nmsleep(1);\r\n}\r\n}\r\nstatic void blizzard_stop_sdram(void)\r\n{\r\nblizzard_write_reg(BLIZZARD_MEM_BANK0_ACTIVATE, 0);\r\n}\r\nstatic void blizzard_wait_line_buffer(void)\r\n{\r\nunsigned long tmo = jiffies + msecs_to_jiffies(30);\r\nwhile (blizzard_read_reg(BLIZZARD_NDISP_CTRL_STATUS) & (1 << 7)) {\r\nif (time_after(jiffies, tmo)) {\r\nif (printk_ratelimit())\r\ndev_err(blizzard.fbdev->dev,\r\n"s1d1374x: line buffer not ready\n");\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void blizzard_wait_yyc(void)\r\n{\r\nunsigned long tmo = jiffies + msecs_to_jiffies(30);\r\nwhile (blizzard_read_reg(BLIZZARD_NDISP_CTRL_STATUS) & (1 << 4)) {\r\nif (time_after(jiffies, tmo)) {\r\nif (printk_ratelimit())\r\ndev_err(blizzard.fbdev->dev,\r\n"s1d1374x: YYC not ready\n");\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void disable_overlay(void)\r\n{\r\nblizzard_write_reg(BLIZZARD_DATA_SOURCE_SELECT,\r\nBLIZZARD_SRC_DISABLE_OVERLAY);\r\n}\r\nstatic void set_window_regs(int x_start, int y_start, int x_end, int y_end,\r\nint x_out_start, int y_out_start,\r\nint x_out_end, int y_out_end, int color_mode,\r\nint zoom_off, int flags)\r\n{\r\nu8 tmp[18];\r\nu8 cmd;\r\nx_end--;\r\ny_end--;\r\ntmp[0] = x_start;\r\ntmp[1] = x_start >> 8;\r\ntmp[2] = y_start;\r\ntmp[3] = y_start >> 8;\r\ntmp[4] = x_end;\r\ntmp[5] = x_end >> 8;\r\ntmp[6] = y_end;\r\ntmp[7] = y_end >> 8;\r\nx_out_end--;\r\ny_out_end--;\r\ntmp[8] = x_out_start;\r\ntmp[9] = x_out_start >> 8;\r\ntmp[10] = y_out_start;\r\ntmp[11] = y_out_start >> 8;\r\ntmp[12] = x_out_end;\r\ntmp[13] = x_out_end >> 8;\r\ntmp[14] = y_out_end;\r\ntmp[15] = y_out_end >> 8;\r\ntmp[16] = color_mode;\r\nif (zoom_off && blizzard.version == BLIZZARD_VERSION_S1D13745)\r\ntmp[17] = BLIZZARD_SRC_WRITE_LCD_BACKGROUND;\r\nelse if (flags & OMAPFB_FORMAT_FLAG_ENABLE_OVERLAY)\r\ntmp[17] = BLIZZARD_SRC_WRITE_OVERLAY_ENABLE;\r\nelse\r\ntmp[17] = blizzard.version == BLIZZARD_VERSION_S1D13744 ?\r\nBLIZZARD_SRC_WRITE_LCD :\r\nBLIZZARD_SRC_WRITE_LCD_DESTRUCTIVE;\r\nblizzard.extif->set_bits_per_cycle(8);\r\ncmd = BLIZZARD_INPUT_WIN_X_START_0;\r\nblizzard.extif->write_command(&cmd, 1);\r\nblizzard.extif->write_data(tmp, 18);\r\n}\r\nstatic void enable_tearsync(int y, int width, int height, int screen_height,\r\nint out_height, int force_vsync)\r\n{\r\nu8 b;\r\nb = blizzard_read_reg(BLIZZARD_NDISP_CTRL_STATUS);\r\nb |= 1 << 3;\r\nblizzard_write_reg(BLIZZARD_NDISP_CTRL_STATUS, b);\r\nif (likely(blizzard.vsync_only || force_vsync)) {\r\nblizzard.extif->enable_tearsync(1, 0);\r\nreturn;\r\n}\r\nif (width * blizzard.pix_tx_time < blizzard.line_upd_time) {\r\nblizzard.extif->enable_tearsync(1, 0);\r\nreturn;\r\n}\r\nif ((width * blizzard.pix_tx_time / 1000) * height <\r\n(y + out_height) * (blizzard.line_upd_time / 1000)) {\r\nblizzard.extif->enable_tearsync(1, 0);\r\nreturn;\r\n}\r\nblizzard.extif->enable_tearsync(1, y + 1);\r\n}\r\nstatic void disable_tearsync(void)\r\n{\r\nu8 b;\r\nblizzard.extif->enable_tearsync(0, 0);\r\nb = blizzard_read_reg(BLIZZARD_NDISP_CTRL_STATUS);\r\nb &= ~(1 << 3);\r\nblizzard_write_reg(BLIZZARD_NDISP_CTRL_STATUS, b);\r\nb = blizzard_read_reg(BLIZZARD_NDISP_CTRL_STATUS);\r\n}\r\nstatic inline struct blizzard_request *alloc_req(void)\r\n{\r\nunsigned long flags;\r\nstruct blizzard_request *req;\r\nint req_flags = 0;\r\nif (!in_interrupt())\r\ndown(&blizzard.req_sema);\r\nelse\r\nreq_flags = REQ_FROM_IRQ_POOL;\r\nspin_lock_irqsave(&blizzard.req_lock, flags);\r\nBUG_ON(list_empty(&blizzard.free_req_list));\r\nreq = list_entry(blizzard.free_req_list.next,\r\nstruct blizzard_request, entry);\r\nlist_del(&req->entry);\r\nspin_unlock_irqrestore(&blizzard.req_lock, flags);\r\nINIT_LIST_HEAD(&req->entry);\r\nreq->flags = req_flags;\r\nreturn req;\r\n}\r\nstatic inline void free_req(struct blizzard_request *req)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&blizzard.req_lock, flags);\r\nlist_move(&req->entry, &blizzard.free_req_list);\r\nif (!(req->flags & REQ_FROM_IRQ_POOL))\r\nup(&blizzard.req_sema);\r\nspin_unlock_irqrestore(&blizzard.req_lock, flags);\r\n}\r\nstatic void process_pending_requests(void)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&blizzard.req_lock, flags);\r\nwhile (!list_empty(&blizzard.pending_req_list)) {\r\nstruct blizzard_request *req;\r\nvoid (*complete)(void *);\r\nvoid *complete_data;\r\nreq = list_entry(blizzard.pending_req_list.next,\r\nstruct blizzard_request, entry);\r\nspin_unlock_irqrestore(&blizzard.req_lock, flags);\r\nif (req->handler(req) == REQ_PENDING)\r\nreturn;\r\ncomplete = req->complete;\r\ncomplete_data = req->complete_data;\r\nfree_req(req);\r\nif (complete)\r\ncomplete(complete_data);\r\nspin_lock_irqsave(&blizzard.req_lock, flags);\r\n}\r\nspin_unlock_irqrestore(&blizzard.req_lock, flags);\r\n}\r\nstatic void submit_req_list(struct list_head *head)\r\n{\r\nunsigned long flags;\r\nint process = 1;\r\nspin_lock_irqsave(&blizzard.req_lock, flags);\r\nif (likely(!list_empty(&blizzard.pending_req_list)))\r\nprocess = 0;\r\nlist_splice_init(head, blizzard.pending_req_list.prev);\r\nspin_unlock_irqrestore(&blizzard.req_lock, flags);\r\nif (process)\r\nprocess_pending_requests();\r\n}\r\nstatic void request_complete(void *data)\r\n{\r\nstruct blizzard_request *req = (struct blizzard_request *)data;\r\nvoid (*complete)(void *);\r\nvoid *complete_data;\r\ncomplete = req->complete;\r\ncomplete_data = req->complete_data;\r\nfree_req(req);\r\nif (complete)\r\ncomplete(complete_data);\r\nprocess_pending_requests();\r\n}\r\nstatic int do_full_screen_update(struct blizzard_request *req)\r\n{\r\nint i;\r\nint flags;\r\nfor (i = 0; i < 3; i++) {\r\nstruct plane_info *p = &blizzard.plane[i];\r\nif (!(blizzard.enabled_planes & (1 << i))) {\r\nblizzard.int_ctrl->enable_plane(i, 0);\r\ncontinue;\r\n}\r\ndev_dbg(blizzard.fbdev->dev, "pw %d ph %d\n",\r\np->width, p->height);\r\nblizzard.int_ctrl->setup_plane(i,\r\nOMAPFB_CHANNEL_OUT_LCD, p->offset,\r\np->scr_width, p->pos_x, p->pos_y,\r\np->width, p->height,\r\np->color_mode);\r\nblizzard.int_ctrl->enable_plane(i, 1);\r\n}\r\ndev_dbg(blizzard.fbdev->dev, "sw %d sh %d\n",\r\nblizzard.screen_width, blizzard.screen_height);\r\nblizzard_wait_line_buffer();\r\nflags = req->par.update.flags;\r\nif (flags & OMAPFB_FORMAT_FLAG_TEARSYNC)\r\nenable_tearsync(0, blizzard.screen_width,\r\nblizzard.screen_height,\r\nblizzard.screen_height,\r\nblizzard.screen_height,\r\nflags & OMAPFB_FORMAT_FLAG_FORCE_VSYNC);\r\nelse\r\ndisable_tearsync();\r\nset_window_regs(0, 0, blizzard.screen_width, blizzard.screen_height,\r\n0, 0, blizzard.screen_width, blizzard.screen_height,\r\nBLIZZARD_COLOR_RGB565, blizzard.zoom_on, flags);\r\nblizzard.zoom_on = 0;\r\nblizzard.extif->set_bits_per_cycle(16);\r\nblizzard.extif->transfer_area(blizzard.screen_width,\r\nblizzard.screen_height,\r\nrequest_complete, req);\r\nreturn REQ_PENDING;\r\n}\r\nstatic int check_1d_intersect(int a1, int a2, int b1, int b2)\r\n{\r\nif (a2 <= b1 || b2 <= a1)\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic int do_partial_update(struct blizzard_request *req, int plane,\r\nint x, int y, int w, int h,\r\nint x_out, int y_out, int w_out, int h_out,\r\nint wnd_color_mode, int bpp)\r\n{\r\nint i;\r\nint gx1, gy1, gx2, gy2;\r\nint gx1_out, gy1_out, gx2_out, gy2_out;\r\nint color_mode;\r\nint flags;\r\nint zoom_off;\r\nint have_zoom_for_this_update = 0;\r\ngx1 = x + blizzard.plane[plane].pos_x;\r\ngy1 = y + blizzard.plane[plane].pos_y;\r\ngx2 = gx1 + w;\r\ngy2 = gy1 + h;\r\nflags = req->par.update.flags;\r\nif (flags & OMAPFB_FORMAT_FLAG_DOUBLE) {\r\ngx1_out = gx1;\r\ngy1_out = gy1;\r\ngx2_out = gx1 + w * 2;\r\ngy2_out = gy1 + h * 2;\r\n} else {\r\ngx1_out = x_out + blizzard.plane[plane].pos_x;\r\ngy1_out = y_out + blizzard.plane[plane].pos_y;\r\ngx2_out = gx1_out + w_out;\r\ngy2_out = gy1_out + h_out;\r\n}\r\nfor (i = 0; i < OMAPFB_PLANE_NUM; i++) {\r\nstruct plane_info *p = &blizzard.plane[i];\r\nint px1, py1;\r\nint px2, py2;\r\nint pw, ph;\r\nint pposx, pposy;\r\nunsigned long offset;\r\nif (!(blizzard.enabled_planes & (1 << i)) ||\r\n(wnd_color_mode && i != plane)) {\r\nblizzard.int_ctrl->enable_plane(i, 0);\r\ncontinue;\r\n}\r\nif (i == plane) {\r\npx1 = x;\r\npy1 = y;\r\npx2 = x + w;\r\npy2 = y + h;\r\npposx = 0;\r\npposy = 0;\r\n} else {\r\npx1 = gx1 - p->pos_x;\r\npy1 = gy1 - p->pos_y;\r\npx2 = gx2 - p->pos_x;\r\npy2 = gy2 - p->pos_y;\r\nif (px1 >= p->width || py1 >= p->height ||\r\npx2 <= 0 || py2 <= 0) {\r\nblizzard.int_ctrl->enable_plane(i, 0);\r\ncontinue;\r\n}\r\npposx = -px1;\r\npposy = -py1;\r\nif (px1 < 0)\r\npx1 = 0;\r\nif (py1 < 0)\r\npy1 = 0;\r\nif (px2 > p->width)\r\npx2 = p->width;\r\nif (py2 > p->height)\r\npy2 = p->height;\r\nif (pposx < 0)\r\npposx = 0;\r\nif (pposy < 0)\r\npposy = 0;\r\n}\r\npw = px2 - px1;\r\nph = py2 - py1;\r\noffset = p->offset + (p->scr_width * py1 + px1) * p->bpp / 8;\r\nif (wnd_color_mode)\r\npw = (pw + 1) * bpp / p->bpp;\r\n#ifdef VERBOSE\r\ndev_dbg(blizzard.fbdev->dev,\r\n"plane %d offset %#08lx pposx %d pposy %d "\r\n"px1 %d py1 %d pw %d ph %d\n",\r\ni, offset, pposx, pposy, px1, py1, pw, ph);\r\n#endif\r\nblizzard.int_ctrl->setup_plane(i,\r\nOMAPFB_CHANNEL_OUT_LCD, offset,\r\np->scr_width,\r\npposx, pposy, pw, ph,\r\np->color_mode);\r\nblizzard.int_ctrl->enable_plane(i, 1);\r\n}\r\nswitch (wnd_color_mode) {\r\ncase OMAPFB_COLOR_YUV420:\r\ncolor_mode = BLIZZARD_COLOR_YUV420;\r\nw = (w + 1) * 3 / 4;\r\nbreak;\r\ndefault:\r\ncolor_mode = BLIZZARD_COLOR_RGB565;\r\nbreak;\r\n}\r\nblizzard_wait_line_buffer();\r\nif (blizzard.last_color_mode == BLIZZARD_COLOR_YUV420)\r\nblizzard_wait_yyc();\r\nblizzard.last_color_mode = color_mode;\r\nif (flags & OMAPFB_FORMAT_FLAG_TEARSYNC)\r\nenable_tearsync(gy1, w, h,\r\nblizzard.screen_height,\r\nh_out,\r\nflags & OMAPFB_FORMAT_FLAG_FORCE_VSYNC);\r\nelse\r\ndisable_tearsync();\r\nif ((gx2_out - gx1_out) != (gx2 - gx1) ||\r\n(gy2_out - gy1_out) != (gy2 - gy1))\r\nhave_zoom_for_this_update = 1;\r\nzoom_off = blizzard.zoom_on && !have_zoom_for_this_update &&\r\n(gx1_out == 0) && (gx2_out == blizzard.screen_width) &&\r\n(gy1_out == 0) && (gy2_out == blizzard.screen_height) &&\r\n(gx1 == 0) && (gy1 == 0);\r\nif (blizzard.zoom_on && !have_zoom_for_this_update && !zoom_off &&\r\ncheck_1d_intersect(blizzard.zoom_area_gx1, blizzard.zoom_area_gx2,\r\ngx1_out, gx2_out) &&\r\ncheck_1d_intersect(blizzard.zoom_area_gy1, blizzard.zoom_area_gy2,\r\ngy1_out, gy2_out)) {\r\nset_window_regs(0, 0, blizzard.screen_width,\r\nblizzard.screen_height,\r\n0, 0, blizzard.screen_width,\r\nblizzard.screen_height,\r\nBLIZZARD_COLOR_RGB565, 1, flags);\r\nblizzard.zoom_on = 0;\r\n}\r\nif (have_zoom_for_this_update) {\r\nblizzard.zoom_on = 1;\r\nblizzard.zoom_area_gx1 = gx1_out;\r\nblizzard.zoom_area_gx2 = gx2_out;\r\nblizzard.zoom_area_gy1 = gy1_out;\r\nblizzard.zoom_area_gy2 = gy2_out;\r\n}\r\nset_window_regs(gx1, gy1, gx2, gy2, gx1_out, gy1_out, gx2_out, gy2_out,\r\ncolor_mode, zoom_off, flags);\r\nif (zoom_off)\r\nblizzard.zoom_on = 0;\r\nblizzard.extif->set_bits_per_cycle(16);\r\nblizzard.extif->transfer_area(w, h, request_complete, req);\r\nreturn REQ_PENDING;\r\n}\r\nstatic int send_frame_handler(struct blizzard_request *req)\r\n{\r\nstruct update_param *par = &req->par.update;\r\nint plane = par->plane;\r\n#ifdef VERBOSE\r\ndev_dbg(blizzard.fbdev->dev,\r\n"send_frame: x %d y %d w %d h %d "\r\n"x_out %d y_out %d w_out %d h_out %d "\r\n"color_mode %04x flags %04x planes %01x\n",\r\npar->x, par->y, par->width, par->height,\r\npar->out_x, par->out_y, par->out_width, par->out_height,\r\npar->color_mode, par->flags, blizzard.enabled_planes);\r\n#endif\r\nif (par->flags & OMAPFB_FORMAT_FLAG_DISABLE_OVERLAY)\r\ndisable_overlay();\r\nif ((blizzard.enabled_planes & blizzard.vid_nonstd_color) ||\r\n(blizzard.enabled_planes & blizzard.vid_scaled))\r\nreturn do_full_screen_update(req);\r\nreturn do_partial_update(req, plane, par->x, par->y,\r\npar->width, par->height,\r\npar->out_x, par->out_y,\r\npar->out_width, par->out_height,\r\npar->color_mode, par->bpp);\r\n}\r\nstatic void send_frame_complete(void *data)\r\n{\r\n}\r\nstatic void create_req_list(int plane_idx,\r\nstruct omapfb_update_window *win,\r\nstruct list_head *req_head)\r\n{\r\nstruct blizzard_request *req;\r\nint x = win->x;\r\nint y = win->y;\r\nint width = win->width;\r\nint height = win->height;\r\nint x_out = win->out_x;\r\nint y_out = win->out_y;\r\nint width_out = win->out_width;\r\nint height_out = win->out_height;\r\nint color_mode;\r\nint bpp;\r\nint flags;\r\nunsigned int ystart = y;\r\nunsigned int yspan = height;\r\nunsigned int ystart_out = y_out;\r\nunsigned int yspan_out = height_out;\r\nflags = win->format & ~OMAPFB_FORMAT_MASK;\r\ncolor_mode = win->format & OMAPFB_FORMAT_MASK;\r\nswitch (color_mode) {\r\ncase OMAPFB_COLOR_YUV420:\r\nbpp = 12;\r\nx &= ~1;\r\ny &= ~1;\r\nheight = yspan = height & ~1;\r\nwidth = width & ~3;\r\nbreak;\r\ndefault:\r\nbpp = blizzard.plane[plane_idx].bpp;\r\nbreak;\r\n}\r\nif (width * height * bpp / 8 > blizzard.max_transmit_size) {\r\nyspan = blizzard.max_transmit_size / (width * bpp / 8);\r\nyspan_out = yspan * height_out / height;\r\nADD_PREQ(x, ystart, width, yspan, x_out, ystart_out,\r\nwidth_out, yspan_out);\r\nystart += yspan;\r\nystart_out += yspan_out;\r\nyspan = height - yspan;\r\nyspan_out = height_out - yspan_out;\r\nflags &= ~OMAPFB_FORMAT_FLAG_TEARSYNC;\r\n}\r\nADD_PREQ(x, ystart, width, yspan, x_out, ystart_out,\r\nwidth_out, yspan_out);\r\n}\r\nstatic void auto_update_complete(void *data)\r\n{\r\nif (!blizzard.stop_auto_update)\r\nmod_timer(&blizzard.auto_update_timer,\r\njiffies + BLIZZARD_AUTO_UPDATE_TIME);\r\n}\r\nstatic void blizzard_update_window_auto(unsigned long arg)\r\n{\r\nLIST_HEAD(req_list);\r\nstruct blizzard_request *last;\r\nstruct omapfb_plane_struct *plane;\r\nplane = blizzard.fbdev->fb_info[0]->par;\r\ncreate_req_list(plane->idx,\r\n&blizzard.auto_update_window, &req_list);\r\nlast = list_entry(req_list.prev, struct blizzard_request, entry);\r\nlast->complete = auto_update_complete;\r\nlast->complete_data = NULL;\r\nsubmit_req_list(&req_list);\r\n}\r\nint blizzard_update_window_async(struct fb_info *fbi,\r\nstruct omapfb_update_window *win,\r\nvoid (*complete_callback)(void *arg),\r\nvoid *complete_callback_data)\r\n{\r\nLIST_HEAD(req_list);\r\nstruct blizzard_request *last;\r\nstruct omapfb_plane_struct *plane = fbi->par;\r\nif (unlikely(blizzard.update_mode != OMAPFB_MANUAL_UPDATE))\r\nreturn -EINVAL;\r\nif (unlikely(!blizzard.te_connected &&\r\n(win->format & OMAPFB_FORMAT_FLAG_TEARSYNC)))\r\nreturn -EINVAL;\r\ncreate_req_list(plane->idx, win, &req_list);\r\nlast = list_entry(req_list.prev, struct blizzard_request, entry);\r\nlast->complete = complete_callback;\r\nlast->complete_data = (void *)complete_callback_data;\r\nsubmit_req_list(&req_list);\r\nreturn 0;\r\n}\r\nstatic int update_full_screen(void)\r\n{\r\nreturn blizzard_update_window_async(blizzard.fbdev->fb_info[0],\r\n&blizzard.auto_update_window, NULL, NULL);\r\n}\r\nstatic int blizzard_setup_plane(int plane, int channel_out,\r\nunsigned long offset, int screen_width,\r\nint pos_x, int pos_y, int width, int height,\r\nint color_mode)\r\n{\r\nstruct plane_info *p;\r\n#ifdef VERBOSE\r\ndev_dbg(blizzard.fbdev->dev,\r\n"plane %d ch_out %d offset %#08lx scr_width %d "\r\n"pos_x %d pos_y %d width %d height %d color_mode %d\n",\r\nplane, channel_out, offset, screen_width,\r\npos_x, pos_y, width, height, color_mode);\r\n#endif\r\nif ((unsigned)plane > OMAPFB_PLANE_NUM)\r\nreturn -EINVAL;\r\np = &blizzard.plane[plane];\r\nswitch (color_mode) {\r\ncase OMAPFB_COLOR_YUV422:\r\ncase OMAPFB_COLOR_YUY422:\r\np->bpp = 16;\r\nblizzard.vid_nonstd_color &= ~(1 << plane);\r\nbreak;\r\ncase OMAPFB_COLOR_YUV420:\r\np->bpp = 12;\r\nblizzard.vid_nonstd_color |= 1 << plane;\r\nbreak;\r\ncase OMAPFB_COLOR_RGB565:\r\np->bpp = 16;\r\nblizzard.vid_nonstd_color &= ~(1 << plane);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\np->offset = offset;\r\np->pos_x = pos_x;\r\np->pos_y = pos_y;\r\np->width = width;\r\np->height = height;\r\np->scr_width = screen_width;\r\nif (!p->out_width)\r\np->out_width = width;\r\nif (!p->out_height)\r\np->out_height = height;\r\np->color_mode = color_mode;\r\nreturn 0;\r\n}\r\nstatic int blizzard_set_scale(int plane, int orig_w, int orig_h,\r\nint out_w, int out_h)\r\n{\r\nstruct plane_info *p = &blizzard.plane[plane];\r\nint r;\r\ndev_dbg(blizzard.fbdev->dev,\r\n"plane %d orig_w %d orig_h %d out_w %d out_h %d\n",\r\nplane, orig_w, orig_h, out_w, out_h);\r\nif ((unsigned)plane > OMAPFB_PLANE_NUM)\r\nreturn -ENODEV;\r\nr = blizzard.int_ctrl->set_scale(plane, orig_w, orig_h, out_w, out_h);\r\nif (r < 0)\r\nreturn r;\r\np->width = orig_w;\r\np->height = orig_h;\r\np->out_width = out_w;\r\np->out_height = out_h;\r\nif (orig_w == out_w && orig_h == out_h)\r\nblizzard.vid_scaled &= ~(1 << plane);\r\nelse\r\nblizzard.vid_scaled |= 1 << plane;\r\nreturn 0;\r\n}\r\nstatic int blizzard_set_rotate(int angle)\r\n{\r\nu32 l;\r\nl = blizzard_read_reg(BLIZZARD_PANEL_CONFIGURATION);\r\nl &= ~0x03;\r\nswitch (angle) {\r\ncase 0:\r\nl = l | 0x00;\r\nbreak;\r\ncase 90:\r\nl = l | 0x03;\r\nbreak;\r\ncase 180:\r\nl = l | 0x02;\r\nbreak;\r\ncase 270:\r\nl = l | 0x01;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nblizzard_write_reg(BLIZZARD_PANEL_CONFIGURATION, l);\r\nreturn 0;\r\n}\r\nstatic int blizzard_enable_plane(int plane, int enable)\r\n{\r\nif (enable)\r\nblizzard.enabled_planes |= 1 << plane;\r\nelse\r\nblizzard.enabled_planes &= ~(1 << plane);\r\nreturn 0;\r\n}\r\nstatic int sync_handler(struct blizzard_request *req)\r\n{\r\ncomplete(req->par.sync);\r\nreturn REQ_COMPLETE;\r\n}\r\nstatic void blizzard_sync(void)\r\n{\r\nLIST_HEAD(req_list);\r\nstruct blizzard_request *req;\r\nstruct completion comp;\r\nreq = alloc_req();\r\nreq->handler = sync_handler;\r\nreq->complete = NULL;\r\ninit_completion(&comp);\r\nreq->par.sync = &comp;\r\nlist_add(&req->entry, &req_list);\r\nsubmit_req_list(&req_list);\r\nwait_for_completion(&comp);\r\n}\r\nstatic void blizzard_bind_client(struct omapfb_notifier_block *nb)\r\n{\r\nif (blizzard.update_mode == OMAPFB_MANUAL_UPDATE) {\r\nomapfb_notify_clients(blizzard.fbdev, OMAPFB_EVENT_READY);\r\n}\r\n}\r\nstatic int blizzard_set_update_mode(enum omapfb_update_mode mode)\r\n{\r\nif (unlikely(mode != OMAPFB_MANUAL_UPDATE &&\r\nmode != OMAPFB_AUTO_UPDATE &&\r\nmode != OMAPFB_UPDATE_DISABLED))\r\nreturn -EINVAL;\r\nif (mode == blizzard.update_mode)\r\nreturn 0;\r\ndev_info(blizzard.fbdev->dev, "s1d1374x: setting update mode to %s\n",\r\nmode == OMAPFB_UPDATE_DISABLED ? "disabled" :\r\n(mode == OMAPFB_AUTO_UPDATE ? "auto" : "manual"));\r\nswitch (blizzard.update_mode) {\r\ncase OMAPFB_MANUAL_UPDATE:\r\nomapfb_notify_clients(blizzard.fbdev, OMAPFB_EVENT_DISABLED);\r\nbreak;\r\ncase OMAPFB_AUTO_UPDATE:\r\nblizzard.stop_auto_update = 1;\r\ndel_timer_sync(&blizzard.auto_update_timer);\r\nbreak;\r\ncase OMAPFB_UPDATE_DISABLED:\r\nbreak;\r\n}\r\nblizzard.update_mode = mode;\r\nblizzard_sync();\r\nblizzard.stop_auto_update = 0;\r\nswitch (mode) {\r\ncase OMAPFB_MANUAL_UPDATE:\r\nomapfb_notify_clients(blizzard.fbdev, OMAPFB_EVENT_READY);\r\nbreak;\r\ncase OMAPFB_AUTO_UPDATE:\r\nblizzard_update_window_auto(0);\r\nbreak;\r\ncase OMAPFB_UPDATE_DISABLED:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic enum omapfb_update_mode blizzard_get_update_mode(void)\r\n{\r\nreturn blizzard.update_mode;\r\n}\r\nstatic inline void set_extif_timings(const struct extif_timings *t)\r\n{\r\nblizzard.extif->set_timings(t);\r\n}\r\nstatic inline unsigned long round_to_extif_ticks(unsigned long ps, int div)\r\n{\r\nint bus_tick = blizzard.extif_clk_period * div;\r\nreturn (ps + bus_tick - 1) / bus_tick * bus_tick;\r\n}\r\nstatic int calc_reg_timing(unsigned long sysclk, int div)\r\n{\r\nstruct extif_timings *t;\r\nunsigned long systim;\r\nsystim = 1000000000 / (sysclk / 1000);\r\ndev_dbg(blizzard.fbdev->dev,\r\n"Blizzard systim %lu ps extif_clk_period %u div %d\n",\r\nsystim, blizzard.extif_clk_period, div);\r\nt = &blizzard.reg_timings;\r\nmemset(t, 0, sizeof(*t));\r\nt->clk_div = div;\r\nt->cs_on_time = 0;\r\nt->we_on_time = round_to_extif_ticks(t->cs_on_time + 2000, div);\r\nt->re_on_time = round_to_extif_ticks(t->cs_on_time + 2000, div);\r\nt->access_time = round_to_extif_ticks(t->re_on_time + 12200, div);\r\nt->we_off_time = round_to_extif_ticks(t->we_on_time + 1000, div);\r\nt->re_off_time = round_to_extif_ticks(t->re_on_time + 13000, div);\r\nt->cs_off_time = round_to_extif_ticks(t->re_off_time + 1000, div);\r\nt->we_cycle_time = round_to_extif_ticks(2 * systim + 2000, div);\r\nif (t->we_cycle_time < t->we_off_time)\r\nt->we_cycle_time = t->we_off_time;\r\nt->re_cycle_time = round_to_extif_ticks(2 * systim + 2000, div);\r\nif (t->re_cycle_time < t->re_off_time)\r\nt->re_cycle_time = t->re_off_time;\r\nt->cs_pulse_width = 0;\r\ndev_dbg(blizzard.fbdev->dev, "[reg]cson %d csoff %d reon %d reoff %d\n",\r\nt->cs_on_time, t->cs_off_time, t->re_on_time, t->re_off_time);\r\ndev_dbg(blizzard.fbdev->dev, "[reg]weon %d weoff %d recyc %d wecyc %d\n",\r\nt->we_on_time, t->we_off_time, t->re_cycle_time,\r\nt->we_cycle_time);\r\ndev_dbg(blizzard.fbdev->dev, "[reg]rdaccess %d cspulse %d\n",\r\nt->access_time, t->cs_pulse_width);\r\nreturn blizzard.extif->convert_timings(t);\r\n}\r\nstatic int calc_lut_timing(unsigned long sysclk, int div)\r\n{\r\nstruct extif_timings *t;\r\nunsigned long systim;\r\nsystim = 1000000000 / (sysclk / 1000);\r\ndev_dbg(blizzard.fbdev->dev,\r\n"Blizzard systim %lu ps extif_clk_period %u div %d\n",\r\nsystim, blizzard.extif_clk_period, div);\r\nt = &blizzard.lut_timings;\r\nmemset(t, 0, sizeof(*t));\r\nt->clk_div = div;\r\nt->cs_on_time = 0;\r\nt->we_on_time = round_to_extif_ticks(t->cs_on_time + 2000, div);\r\nt->re_on_time = round_to_extif_ticks(t->cs_on_time + 2000, div);\r\nt->access_time = round_to_extif_ticks(t->re_on_time + 4 * systim +\r\n26000, div);\r\nt->we_off_time = round_to_extif_ticks(t->we_on_time + 1000, div);\r\nt->re_off_time = round_to_extif_ticks(t->re_on_time + 4 * systim +\r\n26000, div);\r\nt->cs_off_time = round_to_extif_ticks(t->re_off_time + 1000, div);\r\nt->we_cycle_time = round_to_extif_ticks(2 * systim + 2000, div);\r\nif (t->we_cycle_time < t->we_off_time)\r\nt->we_cycle_time = t->we_off_time;\r\nt->re_cycle_time = round_to_extif_ticks(2000 + 4 * systim + 26000, div);\r\nif (t->re_cycle_time < t->re_off_time)\r\nt->re_cycle_time = t->re_off_time;\r\nt->cs_pulse_width = 0;\r\ndev_dbg(blizzard.fbdev->dev,\r\n"[lut]cson %d csoff %d reon %d reoff %d\n",\r\nt->cs_on_time, t->cs_off_time, t->re_on_time, t->re_off_time);\r\ndev_dbg(blizzard.fbdev->dev,\r\n"[lut]weon %d weoff %d recyc %d wecyc %d\n",\r\nt->we_on_time, t->we_off_time, t->re_cycle_time,\r\nt->we_cycle_time);\r\ndev_dbg(blizzard.fbdev->dev, "[lut]rdaccess %d cspulse %d\n",\r\nt->access_time, t->cs_pulse_width);\r\nreturn blizzard.extif->convert_timings(t);\r\n}\r\nstatic int calc_extif_timings(unsigned long sysclk, int *extif_mem_div)\r\n{\r\nint max_clk_div;\r\nint div;\r\nblizzard.extif->get_clk_info(&blizzard.extif_clk_period, &max_clk_div);\r\nfor (div = 1; div <= max_clk_div; div++) {\r\nif (calc_reg_timing(sysclk, div) == 0)\r\nbreak;\r\n}\r\nif (div > max_clk_div) {\r\ndev_dbg(blizzard.fbdev->dev, "reg timing failed\n");\r\ngoto err;\r\n}\r\n*extif_mem_div = div;\r\nfor (div = 1; div <= max_clk_div; div++) {\r\nif (calc_lut_timing(sysclk, div) == 0)\r\nbreak;\r\n}\r\nif (div > max_clk_div)\r\ngoto err;\r\nblizzard.extif_clk_div = div;\r\nreturn 0;\r\nerr:\r\ndev_err(blizzard.fbdev->dev, "can't setup timings\n");\r\nreturn -1;\r\n}\r\nstatic void calc_blizzard_clk_rates(unsigned long ext_clk,\r\nunsigned long *sys_clk, unsigned long *pix_clk)\r\n{\r\nint pix_clk_src;\r\nint sys_div = 0, sys_mul = 0;\r\nint pix_div;\r\npix_clk_src = blizzard_read_reg(BLIZZARD_CLK_SRC);\r\npix_div = ((pix_clk_src >> 3) & 0x1f) + 1;\r\nif ((pix_clk_src & (0x3 << 1)) == 0) {\r\nsys_div = (blizzard_read_reg(BLIZZARD_PLL_DIV) & 0x3f) + 1;\r\nsys_mul = blizzard_read_reg(BLIZZARD_PLL_CLOCK_SYNTH_0);\r\nsys_mul |= ((blizzard_read_reg(BLIZZARD_PLL_CLOCK_SYNTH_1)\r\n& 0x0f) << 11);\r\n*sys_clk = ext_clk * sys_mul / sys_div;\r\n} else\r\n*sys_clk = ext_clk;\r\n*pix_clk = *sys_clk / pix_div;\r\ndev_dbg(blizzard.fbdev->dev,\r\n"ext_clk %ld pix_src %d pix_div %d sys_div %d sys_mul %d\n",\r\next_clk, pix_clk_src & (0x3 << 1), pix_div, sys_div, sys_mul);\r\ndev_dbg(blizzard.fbdev->dev, "sys_clk %ld pix_clk %ld\n",\r\n*sys_clk, *pix_clk);\r\n}\r\nstatic int setup_tearsync(unsigned long pix_clk, int extif_div)\r\n{\r\nint hdisp, vdisp;\r\nint hndp, vndp;\r\nint hsw, vsw;\r\nint hs, vs;\r\nint hs_pol_inv, vs_pol_inv;\r\nint use_hsvs, use_ndp;\r\nu8 b;\r\nhsw = blizzard_read_reg(BLIZZARD_HSW);\r\nvsw = blizzard_read_reg(BLIZZARD_VSW);\r\nhs_pol_inv = !(hsw & 0x80);\r\nvs_pol_inv = !(vsw & 0x80);\r\nhsw = hsw & 0x7f;\r\nvsw = vsw & 0x3f;\r\nhdisp = blizzard_read_reg(BLIZZARD_HDISP) * 8;\r\nvdisp = blizzard_read_reg(BLIZZARD_VDISP0) +\r\n((blizzard_read_reg(BLIZZARD_VDISP1) & 0x3) << 8);\r\nhndp = blizzard_read_reg(BLIZZARD_HNDP) & 0x3f;\r\nvndp = blizzard_read_reg(BLIZZARD_VNDP);\r\nblizzard.pix_tx_time = blizzard.reg_timings.we_cycle_time;\r\nif (blizzard.extif->get_max_tx_rate != NULL) {\r\nunsigned long min_tx_time;\r\nunsigned long max_tx_rate = blizzard.extif->get_max_tx_rate();\r\ndev_dbg(blizzard.fbdev->dev, "max_tx_rate %ld HZ\n",\r\nmax_tx_rate);\r\nmin_tx_time = 1000000000 / (max_tx_rate / 1000);\r\nif (blizzard.pix_tx_time < min_tx_time)\r\nblizzard.pix_tx_time = min_tx_time;\r\n}\r\nblizzard.line_upd_time = (hdisp + hndp) * 1000000 / (pix_clk / 1000);\r\nblizzard.line_upd_time *= 1000;\r\nif (hdisp * blizzard.pix_tx_time > blizzard.line_upd_time)\r\nuse_hsvs = 1;\r\nelse\r\nuse_hsvs = 0;\r\nif (use_hsvs && (hs_pol_inv || vs_pol_inv)) {\r\nuse_ndp = 1;\r\nhs_pol_inv = 0;\r\nvs_pol_inv = 0;\r\nhs = hndp;\r\nvs = vndp;\r\n} else {\r\nuse_ndp = 0;\r\nhs = hsw;\r\nvs = vsw;\r\nif (!use_hsvs) {\r\nhs_pol_inv = 0;\r\nvs_pol_inv = 0;\r\n}\r\n}\r\nhs = hs * 1000000 / (pix_clk / 1000);\r\nhs *= 1000;\r\nvs = vs * (hdisp + hndp) * 1000000 / (pix_clk / 1000);\r\nvs *= 1000;\r\nif (vs <= hs)\r\nreturn -EDOM;\r\nvs = hs * 12 / 10;\r\nif (hs > 10000)\r\nhs = 10000;\r\nb = blizzard_read_reg(BLIZZARD_NDISP_CTRL_STATUS);\r\nb &= ~0x3;\r\nb |= use_hsvs ? 1 : 0;\r\nb |= (use_ndp && use_hsvs) ? 0 : 2;\r\nblizzard_write_reg(BLIZZARD_NDISP_CTRL_STATUS, b);\r\nblizzard.vsync_only = !use_hsvs;\r\ndev_dbg(blizzard.fbdev->dev,\r\n"pix_clk %ld HZ pix_tx_time %ld ps line_upd_time %ld ps\n",\r\npix_clk, blizzard.pix_tx_time, blizzard.line_upd_time);\r\ndev_dbg(blizzard.fbdev->dev,\r\n"hs %d ps vs %d ps mode %d vsync_only %d\n",\r\nhs, vs, b & 0x3, !use_hsvs);\r\nreturn blizzard.extif->setup_tearsync(1, hs, vs,\r\nhs_pol_inv, vs_pol_inv,\r\nextif_div);\r\n}\r\nstatic void blizzard_get_caps(int plane, struct omapfb_caps *caps)\r\n{\r\nblizzard.int_ctrl->get_caps(plane, caps);\r\ncaps->ctrl |= OMAPFB_CAPS_MANUAL_UPDATE |\r\nOMAPFB_CAPS_WINDOW_PIXEL_DOUBLE |\r\nOMAPFB_CAPS_WINDOW_SCALE |\r\nOMAPFB_CAPS_WINDOW_OVERLAY |\r\nOMAPFB_CAPS_WINDOW_ROTATE;\r\nif (blizzard.te_connected)\r\ncaps->ctrl |= OMAPFB_CAPS_TEARSYNC;\r\ncaps->wnd_color |= (1 << OMAPFB_COLOR_RGB565) |\r\n(1 << OMAPFB_COLOR_YUV420);\r\n}\r\nstatic void _save_regs(const struct blizzard_reg_list *list, int cnt)\r\n{\r\nint i;\r\nfor (i = 0; i < cnt; i++, list++) {\r\nint reg;\r\nfor (reg = list->start; reg <= list->end; reg += 2)\r\nblizzard_reg_cache[reg / 2] = blizzard_read_reg(reg);\r\n}\r\n}\r\nstatic void _restore_regs(const struct blizzard_reg_list *list, int cnt)\r\n{\r\nint i;\r\nfor (i = 0; i < cnt; i++, list++) {\r\nint reg;\r\nfor (reg = list->start; reg <= list->end; reg += 2)\r\nblizzard_write_reg(reg, blizzard_reg_cache[reg / 2]);\r\n}\r\n}\r\nstatic void blizzard_save_all_regs(void)\r\n{\r\n_save_regs(blizzard_pll_regs, ARRAY_SIZE(blizzard_pll_regs));\r\n_save_regs(blizzard_gen_regs, ARRAY_SIZE(blizzard_gen_regs));\r\n}\r\nstatic void blizzard_restore_pll_regs(void)\r\n{\r\n_restore_regs(blizzard_pll_regs, ARRAY_SIZE(blizzard_pll_regs));\r\n}\r\nstatic void blizzard_restore_gen_regs(void)\r\n{\r\n_restore_regs(blizzard_gen_regs, ARRAY_SIZE(blizzard_gen_regs));\r\n}\r\nstatic void blizzard_suspend(void)\r\n{\r\nu32 l;\r\nunsigned long tmo;\r\nif (blizzard.last_color_mode) {\r\nupdate_full_screen();\r\nblizzard_sync();\r\n}\r\nblizzard.update_mode_before_suspend = blizzard.update_mode;\r\nblizzard_set_update_mode(OMAPFB_UPDATE_DISABLED);\r\nblizzard_save_all_regs();\r\nblizzard_stop_sdram();\r\nl = blizzard_read_reg(BLIZZARD_POWER_SAVE);\r\nl |= 0x03;\r\nblizzard_write_reg(BLIZZARD_POWER_SAVE, l);\r\ntmo = jiffies + msecs_to_jiffies(100);\r\nwhile (!(blizzard_read_reg(BLIZZARD_PLL_MODE) & (1 << 1))) {\r\nif (time_after(jiffies, tmo)) {\r\ndev_err(blizzard.fbdev->dev,\r\n"s1d1374x: sleep timeout, stopping PLL manually\n");\r\nl = blizzard_read_reg(BLIZZARD_PLL_MODE);\r\nl &= ~0x03;\r\nl |= 0x2;\r\nblizzard_write_reg(BLIZZARD_PLL_MODE, l);\r\nbreak;\r\n}\r\nmsleep(1);\r\n}\r\nif (blizzard.power_down != NULL)\r\nblizzard.power_down(blizzard.fbdev->dev);\r\n}\r\nstatic void blizzard_resume(void)\r\n{\r\nu32 l;\r\nif (blizzard.power_up != NULL)\r\nblizzard.power_up(blizzard.fbdev->dev);\r\nl = blizzard_read_reg(BLIZZARD_POWER_SAVE);\r\nl &= ~0x03;\r\nblizzard_write_reg(BLIZZARD_POWER_SAVE, l);\r\nblizzard_restore_pll_regs();\r\nl = blizzard_read_reg(BLIZZARD_PLL_MODE);\r\nl &= ~0x03;\r\nl |= 0x1;\r\nblizzard_write_reg(BLIZZARD_PLL_MODE, l);\r\nwhile (!(blizzard_read_reg(BLIZZARD_PLL_DIV) & (1 << 7)))\r\nmsleep(1);\r\nblizzard_restart_sdram();\r\nblizzard_restore_gen_regs();\r\nblizzard_write_reg(BLIZZARD_DISPLAY_MODE, 0x01);\r\nblizzard_set_update_mode(blizzard.update_mode_before_suspend);\r\nblizzard.zoom_on = 1;\r\nupdate_full_screen();\r\nblizzard_sync();\r\n}\r\nstatic int blizzard_init(struct omapfb_device *fbdev, int ext_mode,\r\nstruct omapfb_mem_desc *req_vram)\r\n{\r\nint r = 0, i;\r\nu8 rev, conf;\r\nunsigned long ext_clk;\r\nint extif_div;\r\nunsigned long sys_clk, pix_clk;\r\nstruct omapfb_platform_data *omapfb_conf;\r\nstruct blizzard_platform_data *ctrl_conf;\r\nblizzard.fbdev = fbdev;\r\nBUG_ON(!fbdev->ext_if || !fbdev->int_ctrl);\r\nblizzard.fbdev = fbdev;\r\nblizzard.extif = fbdev->ext_if;\r\nblizzard.int_ctrl = fbdev->int_ctrl;\r\nomapfb_conf = fbdev->dev->platform_data;\r\nctrl_conf = omapfb_conf->ctrl_platform_data;\r\nif (ctrl_conf == NULL || ctrl_conf->get_clock_rate == NULL) {\r\ndev_err(fbdev->dev, "s1d1374x: missing platform data\n");\r\nr = -ENOENT;\r\ngoto err1;\r\n}\r\nblizzard.power_down = ctrl_conf->power_down;\r\nblizzard.power_up = ctrl_conf->power_up;\r\nspin_lock_init(&blizzard.req_lock);\r\nif ((r = blizzard.int_ctrl->init(fbdev, 1, req_vram)) < 0)\r\ngoto err1;\r\nif ((r = blizzard.extif->init(fbdev)) < 0)\r\ngoto err2;\r\nblizzard_ctrl.set_color_key = blizzard.int_ctrl->set_color_key;\r\nblizzard_ctrl.get_color_key = blizzard.int_ctrl->get_color_key;\r\nblizzard_ctrl.setup_mem = blizzard.int_ctrl->setup_mem;\r\nblizzard_ctrl.mmap = blizzard.int_ctrl->mmap;\r\next_clk = ctrl_conf->get_clock_rate(fbdev->dev);\r\nif ((r = calc_extif_timings(ext_clk, &extif_div)) < 0)\r\ngoto err3;\r\nset_extif_timings(&blizzard.reg_timings);\r\nif (blizzard.power_up != NULL)\r\nblizzard.power_up(fbdev->dev);\r\ncalc_blizzard_clk_rates(ext_clk, &sys_clk, &pix_clk);\r\nif ((r = calc_extif_timings(sys_clk, &extif_div)) < 0)\r\ngoto err3;\r\nset_extif_timings(&blizzard.reg_timings);\r\nif (!(blizzard_read_reg(BLIZZARD_PLL_DIV) & 0x80)) {\r\ndev_err(fbdev->dev,\r\n"controller not initialized by the bootloader\n");\r\nr = -ENODEV;\r\ngoto err3;\r\n}\r\nif (ctrl_conf->te_connected) {\r\nif ((r = setup_tearsync(pix_clk, extif_div)) < 0)\r\ngoto err3;\r\nblizzard.te_connected = 1;\r\n}\r\nrev = blizzard_read_reg(BLIZZARD_REV_CODE);\r\nconf = blizzard_read_reg(BLIZZARD_CONFIG);\r\nswitch (rev & 0xfc) {\r\ncase 0x9c:\r\nblizzard.version = BLIZZARD_VERSION_S1D13744;\r\npr_info("omapfb: s1d13744 LCD controller rev %d "\r\n"initialized (CNF pins %x)\n", rev & 0x03, conf & 0x07);\r\nbreak;\r\ncase 0xa4:\r\nblizzard.version = BLIZZARD_VERSION_S1D13745;\r\npr_info("omapfb: s1d13745 LCD controller rev %d "\r\n"initialized (CNF pins %x)\n", rev & 0x03, conf & 0x07);\r\nbreak;\r\ndefault:\r\ndev_err(fbdev->dev, "invalid s1d1374x revision %02x\n",\r\nrev);\r\nr = -ENODEV;\r\ngoto err3;\r\n}\r\nblizzard.max_transmit_size = blizzard.extif->max_transmit_size;\r\nblizzard.update_mode = OMAPFB_UPDATE_DISABLED;\r\nblizzard.auto_update_window.x = 0;\r\nblizzard.auto_update_window.y = 0;\r\nblizzard.auto_update_window.width = fbdev->panel->x_res;\r\nblizzard.auto_update_window.height = fbdev->panel->y_res;\r\nblizzard.auto_update_window.out_x = 0;\r\nblizzard.auto_update_window.out_y = 0;\r\nblizzard.auto_update_window.out_width = fbdev->panel->x_res;\r\nblizzard.auto_update_window.out_height = fbdev->panel->y_res;\r\nblizzard.auto_update_window.format = 0;\r\nblizzard.screen_width = fbdev->panel->x_res;\r\nblizzard.screen_height = fbdev->panel->y_res;\r\ninit_timer(&blizzard.auto_update_timer);\r\nblizzard.auto_update_timer.function = blizzard_update_window_auto;\r\nblizzard.auto_update_timer.data = 0;\r\nINIT_LIST_HEAD(&blizzard.free_req_list);\r\nINIT_LIST_HEAD(&blizzard.pending_req_list);\r\nfor (i = 0; i < ARRAY_SIZE(blizzard.req_pool); i++)\r\nlist_add(&blizzard.req_pool[i].entry, &blizzard.free_req_list);\r\nBUG_ON(i <= IRQ_REQ_POOL_SIZE);\r\nsema_init(&blizzard.req_sema, i - IRQ_REQ_POOL_SIZE);\r\nreturn 0;\r\nerr3:\r\nif (blizzard.power_down != NULL)\r\nblizzard.power_down(fbdev->dev);\r\nblizzard.extif->cleanup();\r\nerr2:\r\nblizzard.int_ctrl->cleanup();\r\nerr1:\r\nreturn r;\r\n}\r\nstatic void blizzard_cleanup(void)\r\n{\r\nblizzard_set_update_mode(OMAPFB_UPDATE_DISABLED);\r\nblizzard.extif->cleanup();\r\nblizzard.int_ctrl->cleanup();\r\nif (blizzard.power_down != NULL)\r\nblizzard.power_down(blizzard.fbdev->dev);\r\n}

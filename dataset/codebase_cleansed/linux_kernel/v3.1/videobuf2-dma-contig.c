static void *vb2_dma_contig_alloc(void *alloc_ctx, unsigned long size)\r\n{\r\nstruct vb2_dc_conf *conf = alloc_ctx;\r\nstruct vb2_dc_buf *buf;\r\nbuf = kzalloc(sizeof *buf, GFP_KERNEL);\r\nif (!buf)\r\nreturn ERR_PTR(-ENOMEM);\r\nbuf->vaddr = dma_alloc_coherent(conf->dev, size, &buf->paddr,\r\nGFP_KERNEL);\r\nif (!buf->vaddr) {\r\ndev_err(conf->dev, "dma_alloc_coherent of size %ld failed\n",\r\nsize);\r\nkfree(buf);\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nbuf->conf = conf;\r\nbuf->size = size;\r\nbuf->handler.refcount = &buf->refcount;\r\nbuf->handler.put = vb2_dma_contig_put;\r\nbuf->handler.arg = buf;\r\natomic_inc(&buf->refcount);\r\nreturn buf;\r\n}\r\nstatic void vb2_dma_contig_put(void *buf_priv)\r\n{\r\nstruct vb2_dc_buf *buf = buf_priv;\r\nif (atomic_dec_and_test(&buf->refcount)) {\r\ndma_free_coherent(buf->conf->dev, buf->size, buf->vaddr,\r\nbuf->paddr);\r\nkfree(buf);\r\n}\r\n}\r\nstatic void *vb2_dma_contig_cookie(void *buf_priv)\r\n{\r\nstruct vb2_dc_buf *buf = buf_priv;\r\nreturn &buf->paddr;\r\n}\r\nstatic void *vb2_dma_contig_vaddr(void *buf_priv)\r\n{\r\nstruct vb2_dc_buf *buf = buf_priv;\r\nif (!buf)\r\nreturn 0;\r\nreturn buf->vaddr;\r\n}\r\nstatic unsigned int vb2_dma_contig_num_users(void *buf_priv)\r\n{\r\nstruct vb2_dc_buf *buf = buf_priv;\r\nreturn atomic_read(&buf->refcount);\r\n}\r\nstatic int vb2_dma_contig_mmap(void *buf_priv, struct vm_area_struct *vma)\r\n{\r\nstruct vb2_dc_buf *buf = buf_priv;\r\nif (!buf) {\r\nprintk(KERN_ERR "No buffer to map\n");\r\nreturn -EINVAL;\r\n}\r\nreturn vb2_mmap_pfn_range(vma, buf->paddr, buf->size,\r\n&vb2_common_vm_ops, &buf->handler);\r\n}\r\nstatic void *vb2_dma_contig_get_userptr(void *alloc_ctx, unsigned long vaddr,\r\nunsigned long size, int write)\r\n{\r\nstruct vb2_dc_buf *buf;\r\nstruct vm_area_struct *vma;\r\ndma_addr_t paddr = 0;\r\nint ret;\r\nbuf = kzalloc(sizeof *buf, GFP_KERNEL);\r\nif (!buf)\r\nreturn ERR_PTR(-ENOMEM);\r\nret = vb2_get_contig_userptr(vaddr, size, &vma, &paddr);\r\nif (ret) {\r\nprintk(KERN_ERR "Failed acquiring VMA for vaddr 0x%08lx\n",\r\nvaddr);\r\nkfree(buf);\r\nreturn ERR_PTR(ret);\r\n}\r\nbuf->size = size;\r\nbuf->paddr = paddr;\r\nbuf->vma = vma;\r\nreturn buf;\r\n}\r\nstatic void vb2_dma_contig_put_userptr(void *mem_priv)\r\n{\r\nstruct vb2_dc_buf *buf = mem_priv;\r\nif (!buf)\r\nreturn;\r\nvb2_put_vma(buf->vma);\r\nkfree(buf);\r\n}\r\nvoid *vb2_dma_contig_init_ctx(struct device *dev)\r\n{\r\nstruct vb2_dc_conf *conf;\r\nconf = kzalloc(sizeof *conf, GFP_KERNEL);\r\nif (!conf)\r\nreturn ERR_PTR(-ENOMEM);\r\nconf->dev = dev;\r\nreturn conf;\r\n}\r\nvoid vb2_dma_contig_cleanup_ctx(void *alloc_ctx)\r\n{\r\nkfree(alloc_ctx);\r\n}

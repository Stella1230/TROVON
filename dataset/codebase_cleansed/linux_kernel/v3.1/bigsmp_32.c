static unsigned bigsmp_get_apic_id(unsigned long x)\r\n{\r\nreturn (x >> 24) & 0xFF;\r\n}\r\nstatic int bigsmp_apic_id_registered(void)\r\n{\r\nreturn 1;\r\n}\r\nstatic const struct cpumask *bigsmp_target_cpus(void)\r\n{\r\n#ifdef CONFIG_SMP\r\nreturn cpu_online_mask;\r\n#else\r\nreturn cpumask_of(0);\r\n#endif\r\n}\r\nstatic unsigned long bigsmp_check_apicid_used(physid_mask_t *map, int apicid)\r\n{\r\nreturn 0;\r\n}\r\nstatic unsigned long bigsmp_check_apicid_present(int bit)\r\n{\r\nreturn 1;\r\n}\r\nstatic int bigsmp_early_logical_apicid(int cpu)\r\n{\r\nreturn early_per_cpu(x86_cpu_to_apicid, cpu);\r\n}\r\nstatic inline unsigned long calculate_ldr(int cpu)\r\n{\r\nunsigned long val, id;\r\nval = apic_read(APIC_LDR) & ~APIC_LDR_MASK;\r\nid = per_cpu(x86_bios_cpu_apicid, cpu);\r\nval |= SET_APIC_LOGICAL_ID(id);\r\nreturn val;\r\n}\r\nstatic void bigsmp_init_apic_ldr(void)\r\n{\r\nunsigned long val;\r\nint cpu = smp_processor_id();\r\napic_write(APIC_DFR, APIC_DFR_FLAT);\r\nval = calculate_ldr(cpu);\r\napic_write(APIC_LDR, val);\r\n}\r\nstatic void bigsmp_setup_apic_routing(void)\r\n{\r\nprintk(KERN_INFO\r\n"Enabling APIC mode: Physflat. Using %d I/O APICs\n",\r\nnr_ioapics);\r\n}\r\nstatic int bigsmp_cpu_present_to_apicid(int mps_cpu)\r\n{\r\nif (mps_cpu < nr_cpu_ids)\r\nreturn (int) per_cpu(x86_bios_cpu_apicid, mps_cpu);\r\nreturn BAD_APICID;\r\n}\r\nstatic void bigsmp_ioapic_phys_id_map(physid_mask_t *phys_map, physid_mask_t *retmap)\r\n{\r\nphysids_promote(0xFFL, retmap);\r\n}\r\nstatic int bigsmp_check_phys_apicid_present(int phys_apicid)\r\n{\r\nreturn 1;\r\n}\r\nstatic unsigned int bigsmp_cpu_mask_to_apicid(const struct cpumask *cpumask)\r\n{\r\nint cpu = cpumask_first(cpumask);\r\nif (cpu < nr_cpu_ids)\r\nreturn cpu_physical_id(cpu);\r\nreturn BAD_APICID;\r\n}\r\nstatic unsigned int bigsmp_cpu_mask_to_apicid_and(const struct cpumask *cpumask,\r\nconst struct cpumask *andmask)\r\n{\r\nint cpu;\r\nfor_each_cpu_and(cpu, cpumask, andmask) {\r\nif (cpumask_test_cpu(cpu, cpu_online_mask))\r\nreturn cpu_physical_id(cpu);\r\n}\r\nreturn BAD_APICID;\r\n}\r\nstatic int bigsmp_phys_pkg_id(int cpuid_apic, int index_msb)\r\n{\r\nreturn cpuid_apic >> index_msb;\r\n}\r\nstatic inline void bigsmp_send_IPI_mask(const struct cpumask *mask, int vector)\r\n{\r\ndefault_send_IPI_mask_sequence_phys(mask, vector);\r\n}\r\nstatic void bigsmp_send_IPI_allbutself(int vector)\r\n{\r\ndefault_send_IPI_mask_allbutself_phys(cpu_online_mask, vector);\r\n}\r\nstatic void bigsmp_send_IPI_all(int vector)\r\n{\r\nbigsmp_send_IPI_mask(cpu_online_mask, vector);\r\n}\r\nstatic int hp_ht_bigsmp(const struct dmi_system_id *d)\r\n{\r\nprintk(KERN_NOTICE "%s detected: force use of apic=bigsmp\n", d->ident);\r\ndmi_bigsmp = 1;\r\nreturn 0;\r\n}\r\nstatic void bigsmp_vector_allocation_domain(int cpu, struct cpumask *retmask)\r\n{\r\ncpumask_clear(retmask);\r\ncpumask_set_cpu(cpu, retmask);\r\n}\r\nstatic int probe_bigsmp(void)\r\n{\r\nif (def_to_bigsmp)\r\ndmi_bigsmp = 1;\r\nelse\r\ndmi_check_system(bigsmp_dmi_table);\r\nreturn dmi_bigsmp;\r\n}\r\nstruct apic * __init generic_bigsmp_probe(void)\r\n{\r\nif (probe_bigsmp())\r\nreturn &apic_bigsmp;\r\nreturn NULL;\r\n}

void die(const char *str, struct pt_regs *fp, long err)\r\n{\r\nconsole_verbose();\r\nspin_lock_irq(&die_lock);\r\nprintk(KERN_WARNING "Oops: %s, sig: %ld\n", str, err);\r\nshow_regs(fp);\r\nspin_unlock_irq(&die_lock);\r\ndo_exit(err);\r\n}\r\nasmlinkage void sw_exception(struct pt_regs *regs)\r\n{\r\n_exception(SIGTRAP, regs, TRAP_BRKPT, regs->r16);\r\nflush_dcache_range(regs->r16, regs->r16 + 0x4);\r\nflush_icache_range(regs->r16, regs->r16 + 0x4);\r\n}\r\nvoid _exception(int signr, struct pt_regs *regs, int code, unsigned long addr)\r\n{\r\nsiginfo_t info;\r\nif (kernel_mode(regs)) {\r\ndie("Exception in kernel mode", regs, signr);\r\n}\r\ninfo.si_signo = signr;\r\ninfo.si_errno = 0;\r\ninfo.si_code = code;\r\ninfo.si_addr = (void __user *) addr;\r\nforce_sig_info(signr, &info, current);\r\n}\r\nasmlinkage void full_exception(struct pt_regs *regs, unsigned int type,\r\nint fsr, int addr)\r\n{\r\n#ifdef CONFIG_MMU\r\naddr = regs->pc;\r\n#endif\r\n#if 0\r\nprintk(KERN_WARNING "Exception %02x in %s mode, FSR=%08x PC=%08x " \\r\n"ESR=%08x\n",\r\ntype, user_mode(regs) ? "user" : "kernel", fsr,\r\n(unsigned int) regs->pc, (unsigned int) regs->esr);\r\n#endif\r\nswitch (type & 0x1F) {\r\ncase MICROBLAZE_ILL_OPCODE_EXCEPTION:\r\nif (user_mode(regs)) {\r\npr_debug("Illegal opcode exception in user mode\n");\r\n_exception(SIGILL, regs, ILL_ILLOPC, addr);\r\nreturn;\r\n}\r\nprintk(KERN_WARNING "Illegal opcode exception " \\r\n"in kernel mode.\n");\r\ndie("opcode exception", regs, SIGBUS);\r\nbreak;\r\ncase MICROBLAZE_IBUS_EXCEPTION:\r\nif (user_mode(regs)) {\r\npr_debug("Instruction bus error exception in user mode\n");\r\n_exception(SIGBUS, regs, BUS_ADRERR, addr);\r\nreturn;\r\n}\r\nprintk(KERN_WARNING "Instruction bus error exception " \\r\n"in kernel mode.\n");\r\ndie("bus exception", regs, SIGBUS);\r\nbreak;\r\ncase MICROBLAZE_DBUS_EXCEPTION:\r\nif (user_mode(regs)) {\r\npr_debug("Data bus error exception in user mode\n");\r\n_exception(SIGBUS, regs, BUS_ADRERR, addr);\r\nreturn;\r\n}\r\nprintk(KERN_WARNING "Data bus error exception " \\r\n"in kernel mode.\n");\r\ndie("bus exception", regs, SIGBUS);\r\nbreak;\r\ncase MICROBLAZE_DIV_ZERO_EXCEPTION:\r\nif (user_mode(regs)) {\r\npr_debug("Divide by zero exception in user mode\n");\r\n_exception(SIGILL, regs, FPE_INTDIV, addr);\r\nreturn;\r\n}\r\nprintk(KERN_WARNING "Divide by zero exception " \\r\n"in kernel mode.\n");\r\ndie("Divide by zero exception", regs, SIGBUS);\r\nbreak;\r\ncase MICROBLAZE_FPU_EXCEPTION:\r\npr_debug("FPU exception\n");\r\nif (fsr & FSR_IO)\r\nfsr = FPE_FLTINV;\r\nelse if (fsr & FSR_OF)\r\nfsr = FPE_FLTOVF;\r\nelse if (fsr & FSR_UF)\r\nfsr = FPE_FLTUND;\r\nelse if (fsr & FSR_DZ)\r\nfsr = FPE_FLTDIV;\r\nelse if (fsr & FSR_DO)\r\nfsr = FPE_FLTRES;\r\n_exception(SIGFPE, regs, fsr, addr);\r\nbreak;\r\n#ifdef CONFIG_MMU\r\ncase MICROBLAZE_PRIVILEGED_EXCEPTION:\r\npr_debug("Privileged exception\n");\r\n_exception(SIGILL, regs, ILL_PRVOPC, addr);\r\nbreak;\r\n#endif\r\ndefault:\r\nprintk(KERN_WARNING "Unexpected exception %02x "\r\n"PC=%08x in %s mode\n", type, (unsigned int) addr,\r\nkernel_mode(regs) ? "kernel" : "user");\r\n}\r\nreturn;\r\n}

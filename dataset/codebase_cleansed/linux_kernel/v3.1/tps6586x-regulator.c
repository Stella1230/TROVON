static inline struct device *to_tps6586x_dev(struct regulator_dev *rdev)\r\n{\r\nreturn rdev_get_dev(rdev)->parent->parent;\r\n}\r\nstatic int tps6586x_ldo_list_voltage(struct regulator_dev *rdev,\r\nunsigned selector)\r\n{\r\nstruct tps6586x_regulator *info = rdev_get_drvdata(rdev);\r\nreturn info->voltages[selector] * 1000;\r\n}\r\nstatic int __tps6586x_ldo_set_voltage(struct device *parent,\r\nstruct tps6586x_regulator *ri,\r\nint min_uV, int max_uV,\r\nunsigned *selector)\r\n{\r\nint val, uV;\r\nuint8_t mask;\r\nfor (val = 0; val < ri->desc.n_voltages; val++) {\r\nuV = ri->voltages[val] * 1000;\r\nif (ri->desc.id == TPS6586X_ID_LDO_0 && val == 0)\r\nuV -= 50 * 1000;\r\nif (min_uV <= uV && uV <= max_uV) {\r\n*selector = val;\r\nval <<= ri->volt_shift;\r\nmask = ((1 << ri->volt_nbits) - 1) << ri->volt_shift;\r\nreturn tps6586x_update(parent, ri->volt_reg, val, mask);\r\n}\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int tps6586x_ldo_set_voltage(struct regulator_dev *rdev,\r\nint min_uV, int max_uV, unsigned *selector)\r\n{\r\nstruct tps6586x_regulator *ri = rdev_get_drvdata(rdev);\r\nstruct device *parent = to_tps6586x_dev(rdev);\r\nreturn __tps6586x_ldo_set_voltage(parent, ri, min_uV, max_uV,\r\nselector);\r\n}\r\nstatic int tps6586x_ldo_get_voltage(struct regulator_dev *rdev)\r\n{\r\nstruct tps6586x_regulator *ri = rdev_get_drvdata(rdev);\r\nstruct device *parent = to_tps6586x_dev(rdev);\r\nuint8_t val, mask;\r\nint ret;\r\nret = tps6586x_read(parent, ri->volt_reg, &val);\r\nif (ret)\r\nreturn ret;\r\nmask = ((1 << ri->volt_nbits) - 1) << ri->volt_shift;\r\nval = (val & mask) >> ri->volt_shift;\r\nif (val >= ri->desc.n_voltages)\r\nBUG();\r\nreturn ri->voltages[val] * 1000;\r\n}\r\nstatic int tps6586x_dvm_set_voltage(struct regulator_dev *rdev,\r\nint min_uV, int max_uV, unsigned *selector)\r\n{\r\nstruct tps6586x_regulator *ri = rdev_get_drvdata(rdev);\r\nstruct device *parent = to_tps6586x_dev(rdev);\r\nint ret;\r\nret = __tps6586x_ldo_set_voltage(parent, ri, min_uV, max_uV,\r\nselector);\r\nif (ret)\r\nreturn ret;\r\nreturn tps6586x_set_bits(parent, ri->go_reg, 1 << ri->go_bit);\r\n}\r\nstatic int tps6586x_regulator_enable(struct regulator_dev *rdev)\r\n{\r\nstruct tps6586x_regulator *ri = rdev_get_drvdata(rdev);\r\nstruct device *parent = to_tps6586x_dev(rdev);\r\nreturn tps6586x_set_bits(parent, ri->enable_reg[0],\r\n1 << ri->enable_bit[0]);\r\n}\r\nstatic int tps6586x_regulator_disable(struct regulator_dev *rdev)\r\n{\r\nstruct tps6586x_regulator *ri = rdev_get_drvdata(rdev);\r\nstruct device *parent = to_tps6586x_dev(rdev);\r\nreturn tps6586x_clr_bits(parent, ri->enable_reg[0],\r\n1 << ri->enable_bit[0]);\r\n}\r\nstatic int tps6586x_regulator_is_enabled(struct regulator_dev *rdev)\r\n{\r\nstruct tps6586x_regulator *ri = rdev_get_drvdata(rdev);\r\nstruct device *parent = to_tps6586x_dev(rdev);\r\nuint8_t reg_val;\r\nint ret;\r\nret = tps6586x_read(parent, ri->enable_reg[0], &reg_val);\r\nif (ret)\r\nreturn ret;\r\nreturn !!(reg_val & (1 << ri->enable_bit[0]));\r\n}\r\nstatic inline int tps6586x_regulator_preinit(struct device *parent,\r\nstruct tps6586x_regulator *ri)\r\n{\r\nuint8_t val1, val2;\r\nint ret;\r\nif (ri->enable_reg[0] == ri->enable_reg[1] &&\r\nri->enable_bit[0] == ri->enable_bit[1])\r\nreturn 0;\r\nret = tps6586x_read(parent, ri->enable_reg[0], &val1);\r\nif (ret)\r\nreturn ret;\r\nret = tps6586x_read(parent, ri->enable_reg[1], &val2);\r\nif (ret)\r\nreturn ret;\r\nif (!(val2 & (1 << ri->enable_bit[1])))\r\nreturn 0;\r\nif (!(val1 & (1 << ri->enable_bit[0]))) {\r\nret = tps6586x_set_bits(parent, ri->enable_reg[0],\r\n1 << ri->enable_bit[0]);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn tps6586x_clr_bits(parent, ri->enable_reg[1],\r\n1 << ri->enable_bit[1]);\r\n}\r\nstatic inline struct tps6586x_regulator *find_regulator_info(int id)\r\n{\r\nstruct tps6586x_regulator *ri;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(tps6586x_regulator); i++) {\r\nri = &tps6586x_regulator[i];\r\nif (ri->desc.id == id)\r\nreturn ri;\r\n}\r\nreturn NULL;\r\n}\r\nstatic int __devinit tps6586x_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct tps6586x_regulator *ri = NULL;\r\nstruct regulator_dev *rdev;\r\nint id = pdev->id;\r\nint err;\r\ndev_dbg(&pdev->dev, "Probing reulator %d\n", id);\r\nri = find_regulator_info(id);\r\nif (ri == NULL) {\r\ndev_err(&pdev->dev, "invalid regulator ID specified\n");\r\nreturn -EINVAL;\r\n}\r\nerr = tps6586x_regulator_preinit(pdev->dev.parent, ri);\r\nif (err)\r\nreturn err;\r\nrdev = regulator_register(&ri->desc, &pdev->dev,\r\npdev->dev.platform_data, ri);\r\nif (IS_ERR(rdev)) {\r\ndev_err(&pdev->dev, "failed to register regulator %s\n",\r\nri->desc.name);\r\nreturn PTR_ERR(rdev);\r\n}\r\nplatform_set_drvdata(pdev, rdev);\r\nreturn 0;\r\n}\r\nstatic int __devexit tps6586x_regulator_remove(struct platform_device *pdev)\r\n{\r\nstruct regulator_dev *rdev = platform_get_drvdata(pdev);\r\nregulator_unregister(rdev);\r\nreturn 0;\r\n}\r\nstatic int __init tps6586x_regulator_init(void)\r\n{\r\nreturn platform_driver_register(&tps6586x_regulator_driver);\r\n}\r\nstatic void __exit tps6586x_regulator_exit(void)\r\n{\r\nplatform_driver_unregister(&tps6586x_regulator_driver);\r\n}

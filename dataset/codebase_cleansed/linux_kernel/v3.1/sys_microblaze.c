asmlinkage long microblaze_vfork(struct pt_regs *regs)\r\n{\r\nreturn do_fork(CLONE_VFORK | CLONE_VM | SIGCHLD, regs->r1,\r\nregs, 0, NULL, NULL);\r\n}\r\nasmlinkage long microblaze_clone(int flags, unsigned long stack,\r\nstruct pt_regs *regs)\r\n{\r\nif (!stack)\r\nstack = regs->r1;\r\nreturn do_fork(flags, stack, regs, 0, NULL, NULL);\r\n}\r\nasmlinkage long microblaze_execve(const char __user *filenamei,\r\nconst char __user *const __user *argv,\r\nconst char __user *const __user *envp,\r\nstruct pt_regs *regs)\r\n{\r\nint error;\r\nchar *filename;\r\nfilename = getname(filenamei);\r\nerror = PTR_ERR(filename);\r\nif (IS_ERR(filename))\r\ngoto out;\r\nerror = do_execve(filename, argv, envp, regs);\r\nputname(filename);\r\nout:\r\nreturn error;\r\n}\r\nasmlinkage long sys_mmap(unsigned long addr, unsigned long len,\r\nunsigned long prot, unsigned long flags,\r\nunsigned long fd, off_t pgoff)\r\n{\r\nif (pgoff & ~PAGE_MASK)\r\nreturn -EINVAL;\r\nreturn sys_mmap_pgoff(addr, len, prot, flags, fd, pgoff >> PAGE_SHIFT);\r\n}\r\nint kernel_execve(const char *filename,\r\nconst char *const argv[],\r\nconst char *const envp[])\r\n{\r\nregister const char *__a __asm__("r5") = filename;\r\nregister const void *__b __asm__("r6") = argv;\r\nregister const void *__c __asm__("r7") = envp;\r\nregister unsigned long __syscall __asm__("r12") = __NR_execve;\r\nregister unsigned long __ret __asm__("r3");\r\n__asm__ __volatile__ ("brki r14, 0x8"\r\n: "=r" (__ret), "=r" (__syscall)\r\n: "1" (__syscall), "r" (__a), "r" (__b), "r" (__c)\r\n: "r4", "r8", "r9",\r\n"r10", "r11", "r14", "cc", "memory");\r\nreturn __ret;\r\n}

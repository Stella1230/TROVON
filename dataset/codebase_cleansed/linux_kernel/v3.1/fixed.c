static int fixed_voltage_is_enabled(struct regulator_dev *dev)\r\n{\r\nstruct fixed_voltage_data *data = rdev_get_drvdata(dev);\r\nreturn data->is_enabled;\r\n}\r\nstatic int fixed_voltage_enable(struct regulator_dev *dev)\r\n{\r\nstruct fixed_voltage_data *data = rdev_get_drvdata(dev);\r\nif (gpio_is_valid(data->gpio)) {\r\ngpio_set_value_cansleep(data->gpio, data->enable_high);\r\ndata->is_enabled = true;\r\n}\r\nreturn 0;\r\n}\r\nstatic int fixed_voltage_disable(struct regulator_dev *dev)\r\n{\r\nstruct fixed_voltage_data *data = rdev_get_drvdata(dev);\r\nif (gpio_is_valid(data->gpio)) {\r\ngpio_set_value_cansleep(data->gpio, !data->enable_high);\r\ndata->is_enabled = false;\r\n}\r\nreturn 0;\r\n}\r\nstatic int fixed_voltage_enable_time(struct regulator_dev *dev)\r\n{\r\nstruct fixed_voltage_data *data = rdev_get_drvdata(dev);\r\nreturn data->startup_delay;\r\n}\r\nstatic int fixed_voltage_get_voltage(struct regulator_dev *dev)\r\n{\r\nstruct fixed_voltage_data *data = rdev_get_drvdata(dev);\r\nreturn data->microvolts;\r\n}\r\nstatic int fixed_voltage_list_voltage(struct regulator_dev *dev,\r\nunsigned selector)\r\n{\r\nstruct fixed_voltage_data *data = rdev_get_drvdata(dev);\r\nif (selector != 0)\r\nreturn -EINVAL;\r\nreturn data->microvolts;\r\n}\r\nstatic int __devinit reg_fixed_voltage_probe(struct platform_device *pdev)\r\n{\r\nstruct fixed_voltage_config *config = pdev->dev.platform_data;\r\nstruct fixed_voltage_data *drvdata;\r\nint ret;\r\ndrvdata = kzalloc(sizeof(struct fixed_voltage_data), GFP_KERNEL);\r\nif (drvdata == NULL) {\r\ndev_err(&pdev->dev, "Failed to allocate device data\n");\r\nret = -ENOMEM;\r\ngoto err;\r\n}\r\ndrvdata->desc.name = kstrdup(config->supply_name, GFP_KERNEL);\r\nif (drvdata->desc.name == NULL) {\r\ndev_err(&pdev->dev, "Failed to allocate supply name\n");\r\nret = -ENOMEM;\r\ngoto err;\r\n}\r\ndrvdata->desc.type = REGULATOR_VOLTAGE;\r\ndrvdata->desc.owner = THIS_MODULE;\r\ndrvdata->desc.ops = &fixed_voltage_ops;\r\ndrvdata->desc.n_voltages = 1;\r\ndrvdata->microvolts = config->microvolts;\r\ndrvdata->gpio = config->gpio;\r\ndrvdata->startup_delay = config->startup_delay;\r\nif (gpio_is_valid(config->gpio)) {\r\ndrvdata->enable_high = config->enable_high;\r\nif (!config->gpio)\r\ndev_warn(&pdev->dev,\r\n"using GPIO 0 for regulator enable control\n");\r\nret = gpio_request(config->gpio, config->supply_name);\r\nif (ret) {\r\ndev_err(&pdev->dev,\r\n"Could not obtain regulator enable GPIO %d: %d\n",\r\nconfig->gpio, ret);\r\ngoto err_name;\r\n}\r\ndrvdata->is_enabled = config->enabled_at_boot;\r\nret = drvdata->is_enabled ?\r\nconfig->enable_high : !config->enable_high;\r\nret = gpio_direction_output(config->gpio, ret);\r\nif (ret) {\r\ndev_err(&pdev->dev,\r\n"Could not configure regulator enable GPIO %d direction: %d\n",\r\nconfig->gpio, ret);\r\ngoto err_gpio;\r\n}\r\n} else {\r\ndrvdata->is_enabled = true;\r\n}\r\ndrvdata->dev = regulator_register(&drvdata->desc, &pdev->dev,\r\nconfig->init_data, drvdata);\r\nif (IS_ERR(drvdata->dev)) {\r\nret = PTR_ERR(drvdata->dev);\r\ndev_err(&pdev->dev, "Failed to register regulator: %d\n", ret);\r\ngoto err_gpio;\r\n}\r\nplatform_set_drvdata(pdev, drvdata);\r\ndev_dbg(&pdev->dev, "%s supplying %duV\n", drvdata->desc.name,\r\ndrvdata->microvolts);\r\nreturn 0;\r\nerr_gpio:\r\nif (gpio_is_valid(config->gpio))\r\ngpio_free(config->gpio);\r\nerr_name:\r\nkfree(drvdata->desc.name);\r\nerr:\r\nkfree(drvdata);\r\nreturn ret;\r\n}\r\nstatic int __devexit reg_fixed_voltage_remove(struct platform_device *pdev)\r\n{\r\nstruct fixed_voltage_data *drvdata = platform_get_drvdata(pdev);\r\nregulator_unregister(drvdata->dev);\r\nif (gpio_is_valid(drvdata->gpio))\r\ngpio_free(drvdata->gpio);\r\nkfree(drvdata->desc.name);\r\nkfree(drvdata);\r\nreturn 0;\r\n}\r\nstatic int __init regulator_fixed_voltage_init(void)\r\n{\r\nreturn platform_driver_register(&regulator_fixed_voltage_driver);\r\n}\r\nstatic void __exit regulator_fixed_voltage_exit(void)\r\n{\r\nplatform_driver_unregister(&regulator_fixed_voltage_driver);\r\n}

static u32 saa7146_i2c_func(struct i2c_adapter *adapter)\r\n{\r\nreturn I2C_FUNC_I2C\r\n| I2C_FUNC_SMBUS_QUICK\r\n| I2C_FUNC_SMBUS_READ_BYTE | I2C_FUNC_SMBUS_WRITE_BYTE\r\n| I2C_FUNC_SMBUS_READ_BYTE_DATA | I2C_FUNC_SMBUS_WRITE_BYTE_DATA;\r\n}\r\nstatic inline u32 saa7146_i2c_status(struct saa7146_dev *dev)\r\n{\r\nu32 iicsta = saa7146_read(dev, I2C_STATUS);\r\nreturn iicsta;\r\n}\r\nstatic int saa7146_i2c_msg_prepare(const struct i2c_msg *m, int num, __le32 *op)\r\n{\r\nint h1, h2;\r\nint i, j, addr;\r\nint mem = 0, op_count = 0;\r\nfor(i = 0; i < num; i++) {\r\nmem += m[i].len + 1;\r\n}\r\nmem = 1 + ((mem-1) / 3);\r\nif ( (4*mem) > SAA7146_I2C_MEM ) {\r\nreturn -ENOMEM;\r\n}\r\nmemset(op,0,sizeof(__le32)*mem);\r\nfor(i = 0; i < num; i++) {\r\naddr = (m[i].addr*2) + ( (0 != (m[i].flags & I2C_M_RD)) ? 1 : 0);\r\nh1 = op_count/3; h2 = op_count%3;\r\nop[h1] |= cpu_to_le32( (u8)addr << ((3-h2)*8));\r\nop[h1] |= cpu_to_le32(SAA7146_I2C_START << ((3-h2)*2));\r\nop_count++;\r\nfor(j = 0; j < m[i].len; j++) {\r\nh1 = op_count/3; h2 = op_count%3;\r\nop[h1] |= cpu_to_le32( (u32)((u8)m[i].buf[j]) << ((3-h2)*8));\r\nop[h1] |= cpu_to_le32( SAA7146_I2C_CONT << ((3-h2)*2));\r\nop_count++;\r\n}\r\n}\r\nh1 = (op_count-1)/3; h2 = (op_count-1)%3;\r\nif ( SAA7146_I2C_CONT == (0x3 & (le32_to_cpu(op[h1]) >> ((3-h2)*2))) ) {\r\nop[h1] &= ~cpu_to_le32(0x2 << ((3-h2)*2));\r\nop[h1] |= cpu_to_le32(SAA7146_I2C_STOP << ((3-h2)*2));\r\n}\r\nreturn mem;\r\n}\r\nstatic int saa7146_i2c_msg_cleanup(const struct i2c_msg *m, int num, __le32 *op)\r\n{\r\nint i, j;\r\nint op_count = 0;\r\nfor(i = 0; i < num; i++) {\r\nop_count++;\r\nfor(j = 0; j < m[i].len; j++) {\r\nm[i].buf[j] = (le32_to_cpu(op[op_count/3]) >> ((3-(op_count%3))*8));\r\nop_count++;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int saa7146_i2c_reset(struct saa7146_dev *dev)\r\n{\r\nu32 status = saa7146_i2c_status(dev);\r\nsaa7146_write(dev, I2C_STATUS, dev->i2c_bitrate);\r\nsaa7146_write(dev, I2C_TRANSFER, 0);\r\nif ( 0 != ( status & SAA7146_I2C_BUSY) ) {\r\nDEB_I2C(("busy_state detected.\n"));\r\nsaa7146_write(dev, I2C_STATUS, (dev->i2c_bitrate | MASK_07));\r\nsaa7146_write(dev, MC2, (MASK_00 | MASK_16));\r\nmsleep(SAA7146_I2C_DELAY);\r\nsaa7146_write(dev, I2C_STATUS, dev->i2c_bitrate);\r\nsaa7146_write(dev, MC2, (MASK_00 | MASK_16));\r\nmsleep(SAA7146_I2C_DELAY);\r\n}\r\nstatus = saa7146_i2c_status(dev);\r\nif ( dev->i2c_bitrate != status ) {\r\nDEB_I2C(("error_state detected. status:0x%08x\n",status));\r\nsaa7146_write(dev, I2C_STATUS, (dev->i2c_bitrate | MASK_07));\r\nsaa7146_write(dev, MC2, (MASK_00 | MASK_16));\r\nmsleep(SAA7146_I2C_DELAY);\r\nsaa7146_write(dev, I2C_STATUS, dev->i2c_bitrate);\r\nsaa7146_write(dev, MC2, (MASK_00 | MASK_16));\r\nmsleep(SAA7146_I2C_DELAY);\r\nsaa7146_write(dev, I2C_STATUS, dev->i2c_bitrate);\r\nsaa7146_write(dev, MC2, (MASK_00 | MASK_16));\r\nmsleep(SAA7146_I2C_DELAY);\r\n}\r\nstatus = saa7146_i2c_status(dev);\r\nif ( dev->i2c_bitrate != status ) {\r\nDEB_I2C(("fatal error. status:0x%08x\n",status));\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int saa7146_i2c_writeout(struct saa7146_dev *dev, __le32 *dword, int short_delay)\r\n{\r\nu32 status = 0, mc2 = 0;\r\nint trial = 0;\r\nunsigned long timeout;\r\nDEB_I2C(("before: 0x%08x (status: 0x%08x), %d\n",*dword,saa7146_read(dev, I2C_STATUS), dev->i2c_op));\r\nif( 0 != (SAA7146_USE_I2C_IRQ & dev->ext->flags)) {\r\nsaa7146_write(dev, I2C_STATUS, dev->i2c_bitrate);\r\nsaa7146_write(dev, I2C_TRANSFER, le32_to_cpu(*dword));\r\ndev->i2c_op = 1;\r\nSAA7146_ISR_CLEAR(dev, MASK_16|MASK_17);\r\nSAA7146_IER_ENABLE(dev, MASK_16|MASK_17);\r\nsaa7146_write(dev, MC2, (MASK_00 | MASK_16));\r\ntimeout = HZ/100 + 1;\r\ntimeout = wait_event_interruptible_timeout(dev->i2c_wq, dev->i2c_op == 0, timeout);\r\nif (timeout == -ERESTARTSYS || dev->i2c_op) {\r\nSAA7146_IER_DISABLE(dev, MASK_16|MASK_17);\r\nSAA7146_ISR_CLEAR(dev, MASK_16|MASK_17);\r\nif (timeout == -ERESTARTSYS)\r\nreturn -ERESTARTSYS;\r\nprintk(KERN_WARNING "%s %s [irq]: timed out waiting for end of xfer\n",\r\ndev->name, __func__);\r\nreturn -EIO;\r\n}\r\nstatus = saa7146_read(dev, I2C_STATUS);\r\n} else {\r\nsaa7146_write(dev, I2C_STATUS, dev->i2c_bitrate);\r\nsaa7146_write(dev, I2C_TRANSFER, le32_to_cpu(*dword));\r\nsaa7146_write(dev, MC2, (MASK_00 | MASK_16));\r\ntimeout = jiffies + HZ/100 + 1;\r\nwhile(1) {\r\nmc2 = (saa7146_read(dev, MC2) & 0x1);\r\nif( 0 != mc2 ) {\r\nbreak;\r\n}\r\nif (time_after(jiffies,timeout)) {\r\nprintk(KERN_WARNING "%s %s: timed out waiting for MC2\n",\r\ndev->name, __func__);\r\nreturn -EIO;\r\n}\r\n}\r\ntimeout = jiffies + HZ/100 + 1;\r\nsaa7146_i2c_status(dev);\r\nwhile(1) {\r\nstatus = saa7146_i2c_status(dev);\r\nif ((status & 0x3) != 1)\r\nbreak;\r\nif (time_after(jiffies,timeout)) {\r\nprintk(KERN_WARNING "%s %s [poll]: timed out waiting for end of xfer\n",\r\ndev->name, __func__);\r\nreturn -EIO;\r\n}\r\nif (++trial < 50 && short_delay)\r\nudelay(10);\r\nelse\r\nmsleep(1);\r\n}\r\n}\r\nif ( 0 != (status & (SAA7146_I2C_SPERR | SAA7146_I2C_APERR |\r\nSAA7146_I2C_DTERR | SAA7146_I2C_DRERR |\r\nSAA7146_I2C_AL | SAA7146_I2C_ERR |\r\nSAA7146_I2C_BUSY)) ) {\r\nif ( 0 == (status & SAA7146_I2C_ERR) ||\r\n0 == (status & SAA7146_I2C_BUSY) ) {\r\nDEB_I2C(("unexpected i2c status %04x\n", status));\r\n}\r\nif( 0 != (status & SAA7146_I2C_SPERR) ) {\r\nDEB_I2C(("error due to invalid start/stop condition.\n"));\r\n}\r\nif( 0 != (status & SAA7146_I2C_DTERR) ) {\r\nDEB_I2C(("error in data transmission.\n"));\r\n}\r\nif( 0 != (status & SAA7146_I2C_DRERR) ) {\r\nDEB_I2C(("error when receiving data.\n"));\r\n}\r\nif( 0 != (status & SAA7146_I2C_AL) ) {\r\nDEB_I2C(("error because arbitration lost.\n"));\r\n}\r\nif( 0 != (status & SAA7146_I2C_APERR) ) {\r\nDEB_I2C(("error in address phase.\n"));\r\nreturn -EREMOTEIO;\r\n}\r\nreturn -EIO;\r\n}\r\n*dword = cpu_to_le32(saa7146_read(dev, I2C_TRANSFER));\r\nDEB_I2C(("after: 0x%08x\n",*dword));\r\nreturn 0;\r\n}\r\nstatic int saa7146_i2c_transfer(struct saa7146_dev *dev, const struct i2c_msg *msgs, int num, int retries)\r\n{\r\nint i = 0, count = 0;\r\n__le32 *buffer = dev->d_i2c.cpu_addr;\r\nint err = 0;\r\nint short_delay = 0;\r\nif (mutex_lock_interruptible(&dev->i2c_lock))\r\nreturn -ERESTARTSYS;\r\nfor(i=0;i<num;i++) {\r\nDEB_I2C(("msg:%d/%d\n",i+1,num));\r\n}\r\ncount = saa7146_i2c_msg_prepare(msgs, num, buffer);\r\nif ( 0 > count ) {\r\nerr = -1;\r\ngoto out;\r\n}\r\nif ( count > 3 || 0 != (SAA7146_I2C_SHORT_DELAY & dev->ext->flags) )\r\nshort_delay = 1;\r\ndo {\r\nerr = saa7146_i2c_reset(dev);\r\nif ( 0 > err ) {\r\nDEB_I2C(("could not reset i2c-device.\n"));\r\ngoto out;\r\n}\r\nfor(i = 0; i < count; i++) {\r\nerr = saa7146_i2c_writeout(dev, &buffer[i], short_delay);\r\nif ( 0 != err) {\r\nif (-EREMOTEIO == err && 0 != (SAA7146_USE_I2C_IRQ & dev->ext->flags))\r\ngoto out;\r\nDEB_I2C(("error while sending message(s). starting again.\n"));\r\nbreak;\r\n}\r\n}\r\nif( 0 == err ) {\r\nerr = num;\r\nbreak;\r\n}\r\nmsleep(10);\r\n} while (err != num && retries--);\r\nif (err != num)\r\ngoto out;\r\nif ( 0 != saa7146_i2c_msg_cleanup(msgs, num, buffer)) {\r\nDEB_I2C(("could not cleanup i2c-message.\n"));\r\nerr = -1;\r\ngoto out;\r\n}\r\nDEB_I2C(("transmission successful. (msg:%d).\n",err));\r\nout:\r\nif( 0 == dev->revision ) {\r\n__le32 zero = 0;\r\nsaa7146_i2c_reset(dev);\r\nif( 0 != saa7146_i2c_writeout(dev, &zero, short_delay)) {\r\nINFO(("revision 0 error. this should never happen.\n"));\r\n}\r\n}\r\nmutex_unlock(&dev->i2c_lock);\r\nreturn err;\r\n}\r\nstatic int saa7146_i2c_xfer(struct i2c_adapter* adapter, struct i2c_msg *msg, int num)\r\n{\r\nstruct v4l2_device *v4l2_dev = i2c_get_adapdata(adapter);\r\nstruct saa7146_dev *dev = to_saa7146_dev(v4l2_dev);\r\nreturn saa7146_i2c_transfer(dev, msg, num, adapter->retries);\r\n}\r\nint saa7146_i2c_adapter_prepare(struct saa7146_dev *dev, struct i2c_adapter *i2c_adapter, u32 bitrate)\r\n{\r\nDEB_EE(("bitrate: 0x%08x\n",bitrate));\r\nsaa7146_write(dev, MC1, (MASK_08 | MASK_24));\r\ndev->i2c_bitrate = bitrate;\r\nsaa7146_i2c_reset(dev);\r\nif (i2c_adapter) {\r\ni2c_set_adapdata(i2c_adapter, &dev->v4l2_dev);\r\ni2c_adapter->dev.parent = &dev->pci->dev;\r\ni2c_adapter->algo = &saa7146_algo;\r\ni2c_adapter->algo_data = NULL;\r\ni2c_adapter->timeout = SAA7146_I2C_TIMEOUT;\r\ni2c_adapter->retries = SAA7146_I2C_RETRIES;\r\n}\r\nreturn 0;\r\n}

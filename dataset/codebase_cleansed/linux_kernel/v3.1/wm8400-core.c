static int wm8400_read(struct wm8400 *wm8400, u8 reg, int num_regs, u16 *dest)\r\n{\r\nint i, ret = 0;\r\nBUG_ON(reg + num_regs > ARRAY_SIZE(wm8400->reg_cache));\r\nfor (i = reg; i < reg + num_regs; i++)\r\nif (reg_data[i].vol) {\r\nret = wm8400->read_dev(wm8400->io_data, reg,\r\nnum_regs, dest);\r\nif (ret != 0)\r\nreturn ret;\r\nfor (i = 0; i < num_regs; i++)\r\ndest[i] = be16_to_cpu(dest[i]);\r\nreturn 0;\r\n}\r\nmemcpy(dest, &wm8400->reg_cache[reg], num_regs * sizeof(u16));\r\nreturn 0;\r\n}\r\nstatic int wm8400_write(struct wm8400 *wm8400, u8 reg, int num_regs,\r\nu16 *src)\r\n{\r\nint ret, i;\r\nBUG_ON(reg + num_regs > ARRAY_SIZE(wm8400->reg_cache));\r\nfor (i = 0; i < num_regs; i++) {\r\nBUG_ON(!reg_data[reg + i].writable);\r\nwm8400->reg_cache[reg + i] = src[i];\r\nsrc[i] = cpu_to_be16(src[i]);\r\n}\r\nret = wm8400->write_dev(wm8400->io_data, reg, num_regs, src);\r\nif (ret != 0)\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nu16 wm8400_reg_read(struct wm8400 *wm8400, u8 reg)\r\n{\r\nu16 val;\r\nmutex_lock(&wm8400->io_lock);\r\nwm8400_read(wm8400, reg, 1, &val);\r\nmutex_unlock(&wm8400->io_lock);\r\nreturn val;\r\n}\r\nint wm8400_block_read(struct wm8400 *wm8400, u8 reg, int count, u16 *data)\r\n{\r\nint ret;\r\nmutex_lock(&wm8400->io_lock);\r\nret = wm8400_read(wm8400, reg, count, data);\r\nmutex_unlock(&wm8400->io_lock);\r\nreturn ret;\r\n}\r\nint wm8400_set_bits(struct wm8400 *wm8400, u8 reg, u16 mask, u16 val)\r\n{\r\nu16 tmp;\r\nint ret;\r\nmutex_lock(&wm8400->io_lock);\r\nret = wm8400_read(wm8400, reg, 1, &tmp);\r\ntmp = (tmp & ~mask) | val;\r\nif (ret == 0)\r\nret = wm8400_write(wm8400, reg, 1, &tmp);\r\nmutex_unlock(&wm8400->io_lock);\r\nreturn ret;\r\n}\r\nvoid wm8400_reset_codec_reg_cache(struct wm8400 *wm8400)\r\n{\r\nint i;\r\nmutex_lock(&wm8400->io_lock);\r\nfor (i = 0; i < ARRAY_SIZE(wm8400->reg_cache); i++)\r\nif (reg_data[i].is_codec)\r\nwm8400->reg_cache[i] = reg_data[i].default_val;\r\nmutex_unlock(&wm8400->io_lock);\r\n}\r\nstatic int wm8400_register_codec(struct wm8400 *wm8400)\r\n{\r\nstruct mfd_cell cell = {\r\n.name = "wm8400-codec",\r\n.platform_data = wm8400,\r\n.pdata_size = sizeof(*wm8400),\r\n};\r\nreturn mfd_add_devices(wm8400->dev, -1, &cell, 1, NULL, 0);\r\n}\r\nstatic int wm8400_init(struct wm8400 *wm8400,\r\nstruct wm8400_platform_data *pdata)\r\n{\r\nu16 reg;\r\nint ret, i;\r\nmutex_init(&wm8400->io_lock);\r\ndev_set_drvdata(wm8400->dev, wm8400);\r\nret = wm8400->read_dev(wm8400->io_data, WM8400_RESET_ID, 1, &reg);\r\nif (ret != 0) {\r\ndev_err(wm8400->dev, "Chip ID register read failed\n");\r\nreturn -EIO;\r\n}\r\nif (be16_to_cpu(reg) != reg_data[WM8400_RESET_ID].default_val) {\r\ndev_err(wm8400->dev, "Device is not a WM8400, ID is %x\n",\r\nbe16_to_cpu(reg));\r\nreturn -ENODEV;\r\n}\r\nret = wm8400->read_dev(wm8400->io_data, 0,\r\nARRAY_SIZE(wm8400->reg_cache),\r\nwm8400->reg_cache);\r\nif (ret != 0) {\r\ndev_err(wm8400->dev, "Register cache read failed\n");\r\nreturn -EIO;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(wm8400->reg_cache); i++)\r\nwm8400->reg_cache[i] = be16_to_cpu(wm8400->reg_cache[i]);\r\nif (!(wm8400->reg_cache[WM8400_POWER_MANAGEMENT_1] & WM8400_CODEC_ENA))\r\nfor (i = 0; i < ARRAY_SIZE(wm8400->reg_cache); i++)\r\nif (reg_data[i].is_codec)\r\nwm8400->reg_cache[i] = reg_data[i].default_val;\r\nret = wm8400_read(wm8400, WM8400_ID, 1, &reg);\r\nif (ret != 0) {\r\ndev_err(wm8400->dev, "ID register read failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nreg = (reg & WM8400_CHIP_REV_MASK) >> WM8400_CHIP_REV_SHIFT;\r\ndev_info(wm8400->dev, "WM8400 revision %x\n", reg);\r\nret = wm8400_register_codec(wm8400);\r\nif (ret != 0) {\r\ndev_err(wm8400->dev, "Failed to register codec\n");\r\ngoto err_children;\r\n}\r\nif (pdata && pdata->platform_init) {\r\nret = pdata->platform_init(wm8400->dev);\r\nif (ret != 0) {\r\ndev_err(wm8400->dev, "Platform init failed: %d\n",\r\nret);\r\ngoto err_children;\r\n}\r\n} else\r\ndev_warn(wm8400->dev, "No platform initialisation supplied\n");\r\nreturn 0;\r\nerr_children:\r\nmfd_remove_devices(wm8400->dev);\r\nreturn ret;\r\n}\r\nstatic void wm8400_release(struct wm8400 *wm8400)\r\n{\r\nmfd_remove_devices(wm8400->dev);\r\n}\r\nstatic int wm8400_i2c_read(void *io_data, char reg, int count, u16 *dest)\r\n{\r\nstruct i2c_client *i2c = io_data;\r\nstruct i2c_msg xfer[2];\r\nint ret;\r\nxfer[0].addr = i2c->addr;\r\nxfer[0].flags = 0;\r\nxfer[0].len = 1;\r\nxfer[0].buf = &reg;\r\nxfer[1].addr = i2c->addr;\r\nxfer[1].flags = I2C_M_RD;\r\nxfer[1].len = count * sizeof(u16);\r\nxfer[1].buf = (u8 *)dest;\r\nret = i2c_transfer(i2c->adapter, xfer, 2);\r\nif (ret == 2)\r\nret = 0;\r\nelse if (ret >= 0)\r\nret = -EIO;\r\nreturn ret;\r\n}\r\nstatic int wm8400_i2c_write(void *io_data, char reg, int count, const u16 *src)\r\n{\r\nstruct i2c_client *i2c = io_data;\r\nu8 *msg;\r\nint ret;\r\nmsg = kmalloc((count * sizeof(u16)) + 1, GFP_KERNEL);\r\nif (msg == NULL)\r\nreturn -ENOMEM;\r\nmsg[0] = reg;\r\nmemcpy(&msg[1], src, count * sizeof(u16));\r\nret = i2c_master_send(i2c, msg, (count * sizeof(u16)) + 1);\r\nif (ret == (count * 2) + 1)\r\nret = 0;\r\nelse if (ret >= 0)\r\nret = -EIO;\r\nkfree(msg);\r\nreturn ret;\r\n}\r\nstatic int wm8400_i2c_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct wm8400 *wm8400;\r\nint ret;\r\nwm8400 = kzalloc(sizeof(struct wm8400), GFP_KERNEL);\r\nif (wm8400 == NULL) {\r\nret = -ENOMEM;\r\ngoto err;\r\n}\r\nwm8400->io_data = i2c;\r\nwm8400->read_dev = wm8400_i2c_read;\r\nwm8400->write_dev = wm8400_i2c_write;\r\nwm8400->dev = &i2c->dev;\r\ni2c_set_clientdata(i2c, wm8400);\r\nret = wm8400_init(wm8400, i2c->dev.platform_data);\r\nif (ret != 0)\r\ngoto struct_err;\r\nreturn 0;\r\nstruct_err:\r\nkfree(wm8400);\r\nerr:\r\nreturn ret;\r\n}\r\nstatic int wm8400_i2c_remove(struct i2c_client *i2c)\r\n{\r\nstruct wm8400 *wm8400 = i2c_get_clientdata(i2c);\r\nwm8400_release(wm8400);\r\nkfree(wm8400);\r\nreturn 0;\r\n}\r\nstatic int __init wm8400_module_init(void)\r\n{\r\nint ret = -ENODEV;\r\n#if defined(CONFIG_I2C) || defined(CONFIG_I2C_MODULE)\r\nret = i2c_add_driver(&wm8400_i2c_driver);\r\nif (ret != 0)\r\npr_err("Failed to register I2C driver: %d\n", ret);\r\n#endif\r\nreturn ret;\r\n}\r\nstatic void __exit wm8400_module_exit(void)\r\n{\r\n#if defined(CONFIG_I2C) || defined(CONFIG_I2C_MODULE)\r\ni2c_del_driver(&wm8400_i2c_driver);\r\n#endif\r\n}

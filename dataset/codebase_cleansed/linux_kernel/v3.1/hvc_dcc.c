static inline u32 __dcc_getstatus(void)\r\n{\r\nu32 __ret;\r\nasm volatile("mrc p14, 0, %0, c0, c1, 0 @ read comms ctrl reg"\r\n: "=r" (__ret) : : "cc");\r\nreturn __ret;\r\n}\r\nstatic inline char __dcc_getchar(void)\r\n{\r\nchar __c;\r\nasm volatile("mrc p14, 0, %0, c0, c5, 0 @ read comms data reg"\r\n: "=r" (__c));\r\nreturn __c;\r\n}\r\nstatic inline void __dcc_putchar(char c)\r\n{\r\nasm volatile("mcr p14, 0, %0, c0, c5, 0 @ write a char"\r\n:\r\n: "r" (c));\r\n}\r\nstatic int hvc_dcc_put_chars(uint32_t vt, const char *buf, int count)\r\n{\r\nint i;\r\nfor (i = 0; i < count; i++) {\r\nwhile (__dcc_getstatus() & DCC_STATUS_TX)\r\ncpu_relax();\r\n__dcc_putchar(buf[i]);\r\n}\r\nreturn count;\r\n}\r\nstatic int hvc_dcc_get_chars(uint32_t vt, char *buf, int count)\r\n{\r\nint i;\r\nfor (i = 0; i < count; ++i)\r\nif (__dcc_getstatus() & DCC_STATUS_RX)\r\nbuf[i] = __dcc_getchar();\r\nelse\r\nbreak;\r\nreturn i;\r\n}\r\nstatic int __init hvc_dcc_console_init(void)\r\n{\r\nhvc_instantiate(0, 0, &hvc_dcc_get_put_ops);\r\nreturn 0;\r\n}\r\nstatic int __init hvc_dcc_init(void)\r\n{\r\nhvc_alloc(0, 0, &hvc_dcc_get_put_ops, 128);\r\nreturn 0;\r\n}

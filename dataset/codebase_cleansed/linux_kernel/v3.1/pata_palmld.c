static __devinit int palmld_pata_probe(struct platform_device *pdev)\r\n{\r\nstruct ata_host *host;\r\nstruct ata_port *ap;\r\nvoid __iomem *mem;\r\nint ret;\r\nhost = ata_host_alloc(&pdev->dev, 1);\r\nif (!host) {\r\nret = -ENOMEM;\r\ngoto err1;\r\n}\r\nmem = devm_ioremap(&pdev->dev, PALMLD_IDE_PHYS, 0x1000);\r\nif (!mem) {\r\nret = -ENOMEM;\r\ngoto err1;\r\n}\r\nret = gpio_request_array(palmld_hdd_gpios,\r\nARRAY_SIZE(palmld_hdd_gpios));\r\nif (ret)\r\ngoto err1;\r\ngpio_set_value(GPIO_NR_PALMLD_IDE_RESET, 0);\r\nmsleep(30);\r\ngpio_set_value(GPIO_NR_PALMLD_IDE_RESET, 1);\r\nmsleep(30);\r\nap = host->ports[0];\r\nap->ops = &palmld_port_ops;\r\nap->pio_mask = ATA_PIO4;\r\nap->flags |= ATA_FLAG_PIO_POLLING;\r\nap->ioaddr.cmd_addr = mem + 0x10;\r\nap->ioaddr.altstatus_addr = mem + 0xe;\r\nap->ioaddr.ctl_addr = mem + 0xe;\r\nata_sff_std_ports(&ap->ioaddr);\r\nret = ata_host_activate(host, 0, NULL, IRQF_TRIGGER_RISING,\r\n&palmld_sht);\r\nif (ret)\r\ngoto err2;\r\nreturn ret;\r\nerr2:\r\ngpio_free_array(palmld_hdd_gpios, ARRAY_SIZE(palmld_hdd_gpios));\r\nerr1:\r\nreturn ret;\r\n}\r\nstatic __devexit int palmld_pata_remove(struct platform_device *dev)\r\n{\r\nstruct ata_host *host = platform_get_drvdata(dev);\r\nata_host_detach(host);\r\ngpio_set_value(GPIO_NR_PALMLD_IDE_PWEN, 0);\r\ngpio_free_array(palmld_hdd_gpios, ARRAY_SIZE(palmld_hdd_gpios));\r\nreturn 0;\r\n}\r\nstatic int __init palmld_pata_init(void)\r\n{\r\nreturn platform_driver_register(&palmld_pata_platform_driver);\r\n}\r\nstatic void __exit palmld_pata_exit(void)\r\n{\r\nplatform_driver_unregister(&palmld_pata_platform_driver);\r\n}

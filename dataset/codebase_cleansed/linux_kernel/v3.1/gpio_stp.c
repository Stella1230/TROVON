static void ltq_stp_set(struct gpio_chip *chip, unsigned offset, int value)\r\n{\r\nif (value)\r\nltq_stp_shadow |= (1 << offset);\r\nelse\r\nltq_stp_shadow &= ~(1 << offset);\r\nltq_stp_w32(ltq_stp_shadow, LTQ_STP_CPU0);\r\n}\r\nstatic int ltq_stp_direction_output(struct gpio_chip *chip, unsigned offset,\r\nint value)\r\n{\r\nltq_stp_set(chip, offset, value);\r\nreturn 0;\r\n}\r\nstatic int ltq_stp_hw_init(void)\r\n{\r\nltq_gpio_request(4, 1, 0, 1, "stp-st");\r\nltq_gpio_request(5, 1, 0, 1, "stp-d");\r\nltq_gpio_request(6, 1, 0, 1, "stp-sh");\r\nltq_stp_w32(0, LTQ_STP_AR);\r\nltq_stp_w32(0, LTQ_STP_CPU0);\r\nltq_stp_w32(0, LTQ_STP_CPU1);\r\nltq_stp_w32(LTQ_STP_CON_SWU, LTQ_STP_CON0);\r\nltq_stp_w32(0, LTQ_STP_CON1);\r\nltq_stp_w32_mask(LTQ_STP_EDGE_MASK, LTQ_STP_FALLING, LTQ_STP_CON0);\r\nltq_stp_w32_mask(0, LTQ_STP_GROUP0, LTQ_STP_CON1);\r\nltq_stp_w32_mask(LTQ_STP_UPD_MASK, LTQ_STP_UPD_FPI, LTQ_STP_CON1);\r\nltq_stp_w32_mask(LTQ_STP_SPEED_MASK, LTQ_STP_8HZ, LTQ_STP_CON1);\r\nltq_stp_w32_mask(0, LTQ_STP_ADSL_SRC, LTQ_STP_CON0);\r\nltq_pmu_enable(PMU_LED);\r\nreturn 0;\r\n}\r\nstatic int __devinit ltq_stp_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nint ret = 0;\r\nif (!res)\r\nreturn -ENOENT;\r\nres = devm_request_mem_region(&pdev->dev, res->start,\r\nresource_size(res), dev_name(&pdev->dev));\r\nif (!res) {\r\ndev_err(&pdev->dev, "failed to request STP memory\n");\r\nreturn -EBUSY;\r\n}\r\nltq_stp_membase = devm_ioremap_nocache(&pdev->dev, res->start,\r\nresource_size(res));\r\nif (!ltq_stp_membase) {\r\ndev_err(&pdev->dev, "failed to remap STP memory\n");\r\nreturn -ENOMEM;\r\n}\r\nret = gpiochip_add(&ltq_stp_chip);\r\nif (!ret)\r\nret = ltq_stp_hw_init();\r\nreturn ret;\r\n}\r\nint __init ltq_stp_init(void)\r\n{\r\nint ret = platform_driver_register(&ltq_stp_driver);\r\nif (ret)\r\npr_info("ltq_stp: error registering platfom driver");\r\nreturn ret;\r\n}

static int c2_alloc_mqsp_chunk(struct c2_dev *c2dev, gfp_t gfp_mask,\r\nstruct sp_chunk **head)\r\n{\r\nint i;\r\nstruct sp_chunk *new_head;\r\ndma_addr_t dma_addr;\r\nnew_head = dma_alloc_coherent(&c2dev->pcidev->dev, PAGE_SIZE,\r\n&dma_addr, gfp_mask);\r\nif (new_head == NULL)\r\nreturn -ENOMEM;\r\nnew_head->dma_addr = dma_addr;\r\ndma_unmap_addr_set(new_head, mapping, new_head->dma_addr);\r\nnew_head->next = NULL;\r\nnew_head->head = 0;\r\nfor (i = 0;\r\ni < (PAGE_SIZE - sizeof(struct sp_chunk) -\r\nsizeof(u16)) / sizeof(u16) - 1;\r\ni++) {\r\nnew_head->shared_ptr[i] = i + 1;\r\n}\r\nnew_head->shared_ptr[i] = 0xFFFF;\r\n*head = new_head;\r\nreturn 0;\r\n}\r\nint c2_init_mqsp_pool(struct c2_dev *c2dev, gfp_t gfp_mask,\r\nstruct sp_chunk **root)\r\n{\r\nreturn c2_alloc_mqsp_chunk(c2dev, gfp_mask, root);\r\n}\r\nvoid c2_free_mqsp_pool(struct c2_dev *c2dev, struct sp_chunk *root)\r\n{\r\nstruct sp_chunk *next;\r\nwhile (root) {\r\nnext = root->next;\r\ndma_free_coherent(&c2dev->pcidev->dev, PAGE_SIZE, root,\r\ndma_unmap_addr(root, mapping));\r\nroot = next;\r\n}\r\n}\r\n__be16 *c2_alloc_mqsp(struct c2_dev *c2dev, struct sp_chunk *head,\r\ndma_addr_t *dma_addr, gfp_t gfp_mask)\r\n{\r\nu16 mqsp;\r\nwhile (head) {\r\nmqsp = head->head;\r\nif (mqsp != 0xFFFF) {\r\nhead->head = head->shared_ptr[mqsp];\r\nbreak;\r\n} else if (head->next == NULL) {\r\nif (c2_alloc_mqsp_chunk(c2dev, gfp_mask, &head->next) ==\r\n0) {\r\nhead = head->next;\r\nmqsp = head->head;\r\nhead->head = head->shared_ptr[mqsp];\r\nbreak;\r\n} else\r\nreturn NULL;\r\n} else\r\nhead = head->next;\r\n}\r\nif (head) {\r\n*dma_addr = head->dma_addr +\r\n((unsigned long) &(head->shared_ptr[mqsp]) -\r\n(unsigned long) head);\r\npr_debug("%s addr %p dma_addr %llx\n", __func__,\r\n&(head->shared_ptr[mqsp]), (unsigned long long) *dma_addr);\r\nreturn (__force __be16 *) &(head->shared_ptr[mqsp]);\r\n}\r\nreturn NULL;\r\n}\r\nvoid c2_free_mqsp(__be16 *mqsp)\r\n{\r\nstruct sp_chunk *head;\r\nu16 idx;\r\nhead = (struct sp_chunk *) ((unsigned long) mqsp & PAGE_MASK);\r\n*mqsp = (__force __be16) head->head;\r\nidx = ((unsigned long) mqsp & ~PAGE_MASK) >> 1;\r\nidx -= (unsigned long) &(((struct sp_chunk *) 0)->shared_ptr[0]) >> 1;\r\nhead->shared_ptr[idx] = head->head;\r\nhead->head = idx;\r\n}

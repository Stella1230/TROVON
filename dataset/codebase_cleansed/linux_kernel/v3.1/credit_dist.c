static INLINE void ReduceCredits(struct common_credit_state_info *pCredInfo,\r\nstruct htc_endpoint_credit_dist *pEpDist,\r\nint Limit)\r\n{\r\nint credits;\r\npEpDist->TxCreditsAssigned = Limit;\r\nif (pEpDist->TxCredits <= Limit) {\r\nreturn;\r\n}\r\ncredits = pEpDist->TxCredits - Limit;\r\npEpDist->TxCredits -= credits;\r\npCredInfo->CurrentFreeCredits += credits;\r\n}\r\nstatic void ar6000_credit_init(void *Context,\r\nstruct htc_endpoint_credit_dist *pEPList,\r\nint TotalCredits)\r\n{\r\nstruct htc_endpoint_credit_dist *pCurEpDist;\r\nint count;\r\nstruct common_credit_state_info *pCredInfo = (struct common_credit_state_info *)Context;\r\npCredInfo->CurrentFreeCredits = TotalCredits;\r\npCredInfo->TotalAvailableCredits = TotalCredits;\r\npCurEpDist = pEPList;\r\nwhile (pCurEpDist != NULL) {\r\npCurEpDist->TxCreditsMin = pCurEpDist->TxCreditsPerMaxMsg;\r\n#ifdef CONFIG_GIVE_LOW_PRIORITY_STREAMS_MIN_CREDITS\r\nif (TotalCredits > 4)\r\n{\r\nif ((pCurEpDist->ServiceID == WMI_DATA_BK_SVC) || (pCurEpDist->ServiceID == WMI_DATA_BE_SVC)){\r\nGiveCredits(pCredInfo,pCurEpDist,pCurEpDist->TxCreditsMin);\r\nSET_EP_ACTIVE(pCurEpDist);\r\n}\r\n}\r\n#endif\r\nif (pCurEpDist->ServiceID == WMI_CONTROL_SVC) {\r\nGiveCredits(pCredInfo,pCurEpDist,pCurEpDist->TxCreditsMin);\r\nSET_EP_ACTIVE(pCurEpDist);\r\n} else if (pCurEpDist->ServiceID == WMI_DATA_BK_SVC) {\r\npCredInfo->pLowestPriEpDist = pCurEpDist;\r\n}\r\npCurEpDist = pCurEpDist->pNext;\r\n}\r\nif (pCredInfo->CurrentFreeCredits <= 0) {\r\nAR_DEBUG_PRINTF(ATH_LOG_INF, ("Not enough credits (%d) to do credit distributions \n", TotalCredits));\r\nA_ASSERT(false);\r\nreturn;\r\n}\r\npCurEpDist = pEPList;\r\nwhile (pCurEpDist != NULL) {\r\nif (pCurEpDist->ServiceID == WMI_CONTROL_SVC) {\r\npCurEpDist->TxCreditsNorm = pCurEpDist->TxCreditsPerMaxMsg;\r\n} else {\r\ncount = (pCredInfo->CurrentFreeCredits/pCurEpDist->TxCreditsPerMaxMsg) * pCurEpDist->TxCreditsPerMaxMsg;\r\ncount = (count * 3) >> 2;\r\ncount = max(count,pCurEpDist->TxCreditsPerMaxMsg);\r\npCurEpDist->TxCreditsNorm = count;\r\n}\r\npCurEpDist = pCurEpDist->pNext;\r\n}\r\n}\r\nstatic void ar6000_credit_distribute(void *Context,\r\nstruct htc_endpoint_credit_dist *pEPDistList,\r\nHTC_CREDIT_DIST_REASON Reason)\r\n{\r\nstruct htc_endpoint_credit_dist *pCurEpDist;\r\nstruct common_credit_state_info *pCredInfo = (struct common_credit_state_info *)Context;\r\nswitch (Reason) {\r\ncase HTC_CREDIT_DIST_SEND_COMPLETE :\r\npCurEpDist = pEPDistList;\r\nwhile (pCurEpDist != NULL) {\r\nif (pCurEpDist->TxCreditsToDist > 0) {\r\npCurEpDist->TxCredits += pCurEpDist->TxCreditsToDist;\r\npCurEpDist->TxCreditsToDist = 0;\r\nif (pCurEpDist->TxCredits > pCurEpDist->TxCreditsAssigned) {\r\nReduceCredits(pCredInfo, pCurEpDist, pCurEpDist->TxCreditsAssigned);\r\n}\r\nif (pCurEpDist->TxCredits > pCurEpDist->TxCreditsNorm) {\r\nReduceCredits(pCredInfo, pCurEpDist, pCurEpDist->TxCreditsNorm);\r\n}\r\nif (!IS_EP_ACTIVE(pCurEpDist)) {\r\nif (pCurEpDist->TxQueueDepth == 0) {\r\nReduceCredits(pCredInfo, pCurEpDist, 0);\r\n}\r\n}\r\n}\r\npCurEpDist = pCurEpDist->pNext;\r\n}\r\nbreak;\r\ncase HTC_CREDIT_DIST_ACTIVITY_CHANGE :\r\nRedistributeCredits(pCredInfo,pEPDistList);\r\nbreak;\r\ncase HTC_CREDIT_DIST_SEEK_CREDITS :\r\nSeekCredits(pCredInfo,pEPDistList);\r\nbreak;\r\ncase HTC_DUMP_CREDIT_STATE :\r\nAR_DEBUG_PRINTF(ATH_DEBUG_ERR, ("Credit Distribution, total : %d, free : %d\n",\r\npCredInfo->TotalAvailableCredits, pCredInfo->CurrentFreeCredits));\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nA_ASSERT(pCredInfo->CurrentFreeCredits <= pCredInfo->TotalAvailableCredits);\r\nA_ASSERT(pCredInfo->CurrentFreeCredits >= 0);\r\n}\r\nstatic void RedistributeCredits(struct common_credit_state_info *pCredInfo,\r\nstruct htc_endpoint_credit_dist *pEPDistList)\r\n{\r\nstruct htc_endpoint_credit_dist *pCurEpDist = pEPDistList;\r\nwhile (pCurEpDist != NULL) {\r\n#ifdef CONFIG_GIVE_LOW_PRIORITY_STREAMS_MIN_CREDITS\r\nif ((pCurEpDist->ServiceID == WMI_DATA_BK_SVC) || (pCurEpDist->ServiceID == WMI_DATA_BE_SVC)) {\r\nSET_EP_ACTIVE(pCurEpDist);\r\n}\r\n#endif\r\nif (pCurEpDist->ServiceID != WMI_CONTROL_SVC) {\r\nif (!IS_EP_ACTIVE(pCurEpDist)) {\r\nif (pCurEpDist->TxQueueDepth == 0) {\r\nReduceCredits(pCredInfo, pCurEpDist, 0);\r\n} else {\r\nReduceCredits(pCredInfo, pCurEpDist, pCurEpDist->TxCreditsMin);\r\n}\r\n}\r\n}\r\npCurEpDist = pCurEpDist->pNext;\r\n}\r\n}\r\nstatic void SeekCredits(struct common_credit_state_info *pCredInfo,\r\nstruct htc_endpoint_credit_dist *pEPDist)\r\n{\r\nstruct htc_endpoint_credit_dist *pCurEpDist;\r\nint credits = 0;\r\nint need;\r\ndo {\r\nif (pEPDist->ServiceID == WMI_CONTROL_SVC) {\r\nbreak;\r\n}\r\n#ifdef CONFIG_GIVE_LOW_PRIORITY_STREAMS_MIN_CREDITS\r\nif (pEPDist->ServiceID == WMI_DATA_VI_SVC) {\r\nif ((pEPDist->TxCreditsAssigned >= pEPDist->TxCreditsNorm)) {\r\nbreak;\r\n}\r\n}\r\nif (pEPDist->ServiceID == WMI_DATA_VO_SVC) {\r\nif ((pEPDist->TxCreditsAssigned >= pEPDist->TxCreditsNorm)) {\r\nbreak;\r\n}\r\n}\r\n#else\r\nif (pEPDist->ServiceID == WMI_DATA_VI_SVC) {\r\nif ((pEPDist->TxCreditsAssigned >= pEPDist->TxCreditsNorm) ||\r\n(pCredInfo->CurrentFreeCredits <= pEPDist->TxCreditsPerMaxMsg)) {\r\nbreak;\r\n}\r\n}\r\nif (pEPDist->ServiceID == WMI_DATA_VO_SVC) {\r\nif ((pEPDist->TxCreditsAssigned >= pEPDist->TxCreditsNorm) ||\r\n(pCredInfo->CurrentFreeCredits <= pEPDist->TxCreditsPerMaxMsg)) {\r\nbreak;\r\n}\r\n}\r\n#endif\r\ncredits = min(pCredInfo->CurrentFreeCredits,pEPDist->TxCreditsSeek);\r\nif (credits >= pEPDist->TxCreditsSeek) {\r\nbreak;\r\n}\r\npCurEpDist = pCredInfo->pLowestPriEpDist;\r\nwhile (pCurEpDist != pEPDist) {\r\nneed = pEPDist->TxCreditsSeek - pCredInfo->CurrentFreeCredits;\r\nif ((pCurEpDist->TxCreditsAssigned - need) >= pCurEpDist->TxCreditsMin) {\r\nReduceCredits(pCredInfo,\r\npCurEpDist,\r\npCurEpDist->TxCreditsAssigned - need);\r\nif (pCredInfo->CurrentFreeCredits >= pEPDist->TxCreditsSeek) {\r\nbreak;\r\n}\r\n}\r\npCurEpDist = pCurEpDist->pPrev;\r\n}\r\ncredits = min(pCredInfo->CurrentFreeCredits,pEPDist->TxCreditsSeek);\r\n} while (false);\r\nif (credits) {\r\nGiveCredits(pCredInfo, pEPDist, credits);\r\n}\r\n}\r\nint ar6000_setup_credit_dist(HTC_HANDLE HTCHandle, struct common_credit_state_info *pCredInfo)\r\n{\r\nHTC_SERVICE_ID servicepriority[5];\r\nA_MEMZERO(pCredInfo,sizeof(struct common_credit_state_info));\r\nservicepriority[0] = WMI_CONTROL_SVC;\r\nservicepriority[1] = WMI_DATA_VO_SVC;\r\nservicepriority[2] = WMI_DATA_VI_SVC;\r\nservicepriority[3] = WMI_DATA_BE_SVC;\r\nservicepriority[4] = WMI_DATA_BK_SVC;\r\nHTCSetCreditDistribution(HTCHandle,\r\npCredInfo,\r\nar6000_credit_distribute,\r\nar6000_credit_init,\r\nservicepriority,\r\n5);\r\nreturn 0;\r\n}

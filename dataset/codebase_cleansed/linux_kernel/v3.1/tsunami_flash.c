static inline map_word tsunami_flash_read8(struct map_info *map, unsigned long offset)\r\n{\r\nmap_word val;\r\nval.x[0] = tsunami_tig_readb(offset);\r\nreturn val;\r\n}\r\nstatic void tsunami_flash_write8(struct map_info *map, map_word value, unsigned long offset)\r\n{\r\ntsunami_tig_writeb(value.x[0], offset);\r\n}\r\nstatic void tsunami_flash_copy_from(\r\nstruct map_info *map, void *addr, unsigned long offset, ssize_t len)\r\n{\r\nunsigned char *dest;\r\ndest = addr;\r\nwhile(len && (offset < MAX_TIG_FLASH_SIZE)) {\r\n*dest = tsunami_tig_readb(offset);\r\noffset++;\r\ndest++;\r\nlen--;\r\n}\r\n}\r\nstatic void tsunami_flash_copy_to(\r\nstruct map_info *map, unsigned long offset,\r\nconst void *addr, ssize_t len)\r\n{\r\nconst unsigned char *src;\r\nsrc = addr;\r\nwhile(len && (offset < MAX_TIG_FLASH_SIZE)) {\r\ntsunami_tig_writeb(*src, offset);\r\noffset++;\r\nsrc++;\r\nlen--;\r\n}\r\n}\r\nstatic void __exit cleanup_tsunami_flash(void)\r\n{\r\nstruct mtd_info *mtd;\r\nmtd = tsunami_flash_mtd;\r\nif (mtd) {\r\nmtd_device_unregister(mtd);\r\nmap_destroy(mtd);\r\n}\r\ntsunami_flash_mtd = 0;\r\n}\r\nstatic int __init init_tsunami_flash(void)\r\n{\r\nstatic const char *rom_probe_types[] = { "cfi_probe", "jedec_probe", "map_rom", NULL };\r\nchar **type;\r\ntsunami_tig_writeb(FLASH_ENABLE_BYTE, FLASH_ENABLE_PORT);\r\ntsunami_flash_mtd = 0;\r\ntype = rom_probe_types;\r\nfor(; !tsunami_flash_mtd && *type; type++) {\r\ntsunami_flash_mtd = do_map_probe(*type, &tsunami_flash_map);\r\n}\r\nif (tsunami_flash_mtd) {\r\ntsunami_flash_mtd->owner = THIS_MODULE;\r\nmtd_device_register(tsunami_flash_mtd, NULL, 0);\r\nreturn 0;\r\n}\r\nreturn -ENXIO;\r\n}

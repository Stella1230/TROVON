static bool use_new_ani(struct ath_hw *ah)\r\n{\r\nreturn AR_SREV_9300_20_OR_LATER(ah) || modparam_force_new_ani;\r\n}\r\nstatic void ath9k_hw_update_mibstats(struct ath_hw *ah,\r\nstruct ath9k_mib_stats *stats)\r\n{\r\nstats->ackrcv_bad += REG_READ(ah, AR_ACK_FAIL);\r\nstats->rts_bad += REG_READ(ah, AR_RTS_FAIL);\r\nstats->fcs_bad += REG_READ(ah, AR_FCS_FAIL);\r\nstats->rts_good += REG_READ(ah, AR_RTS_OK);\r\nstats->beacons += REG_READ(ah, AR_BEACON_CNT);\r\n}\r\nstatic void ath9k_ani_restart(struct ath_hw *ah)\r\n{\r\nstruct ar5416AniState *aniState;\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nu32 ofdm_base = 0, cck_base = 0;\r\nif (!DO_ANI(ah))\r\nreturn;\r\naniState = &ah->curchan->ani;\r\naniState->listenTime = 0;\r\nif (!use_new_ani(ah)) {\r\nofdm_base = AR_PHY_COUNTMAX - ah->config.ofdm_trig_high;\r\ncck_base = AR_PHY_COUNTMAX - ah->config.cck_trig_high;\r\n}\r\nath_dbg(common, ATH_DBG_ANI,\r\n"Writing ofdmbase=%u cckbase=%u\n", ofdm_base, cck_base);\r\nENABLE_REGWRITE_BUFFER(ah);\r\nREG_WRITE(ah, AR_PHY_ERR_1, ofdm_base);\r\nREG_WRITE(ah, AR_PHY_ERR_2, cck_base);\r\nREG_WRITE(ah, AR_PHY_ERR_MASK_1, AR_PHY_ERR_OFDM_TIMING);\r\nREG_WRITE(ah, AR_PHY_ERR_MASK_2, AR_PHY_ERR_CCK_TIMING);\r\nREGWRITE_BUFFER_FLUSH(ah);\r\nath9k_hw_update_mibstats(ah, &ah->ah_mibStats);\r\naniState->ofdmPhyErrCount = 0;\r\naniState->cckPhyErrCount = 0;\r\n}\r\nstatic void ath9k_hw_ani_ofdm_err_trigger_old(struct ath_hw *ah)\r\n{\r\nstruct ieee80211_conf *conf = &ath9k_hw_common(ah)->hw->conf;\r\nstruct ar5416AniState *aniState;\r\nint32_t rssi;\r\naniState = &ah->curchan->ani;\r\nif (aniState->noiseImmunityLevel < HAL_NOISE_IMMUNE_MAX) {\r\nif (ath9k_hw_ani_control(ah, ATH9K_ANI_NOISE_IMMUNITY_LEVEL,\r\naniState->noiseImmunityLevel + 1)) {\r\nreturn;\r\n}\r\n}\r\nif (aniState->spurImmunityLevel < HAL_SPUR_IMMUNE_MAX) {\r\nif (ath9k_hw_ani_control(ah, ATH9K_ANI_SPUR_IMMUNITY_LEVEL,\r\naniState->spurImmunityLevel + 1)) {\r\nreturn;\r\n}\r\n}\r\nif (ah->opmode == NL80211_IFTYPE_AP) {\r\nif (aniState->firstepLevel < HAL_FIRST_STEP_MAX) {\r\nath9k_hw_ani_control(ah, ATH9K_ANI_FIRSTEP_LEVEL,\r\naniState->firstepLevel + 1);\r\n}\r\nreturn;\r\n}\r\nrssi = BEACON_RSSI(ah);\r\nif (rssi > aniState->rssiThrHigh) {\r\nif (!aniState->ofdmWeakSigDetectOff) {\r\nif (ath9k_hw_ani_control(ah,\r\nATH9K_ANI_OFDM_WEAK_SIGNAL_DETECTION,\r\nfalse)) {\r\nath9k_hw_ani_control(ah,\r\nATH9K_ANI_SPUR_IMMUNITY_LEVEL, 0);\r\nreturn;\r\n}\r\n}\r\nif (aniState->firstepLevel < HAL_FIRST_STEP_MAX) {\r\nath9k_hw_ani_control(ah, ATH9K_ANI_FIRSTEP_LEVEL,\r\naniState->firstepLevel + 1);\r\nreturn;\r\n}\r\n} else if (rssi > aniState->rssiThrLow) {\r\nif (aniState->ofdmWeakSigDetectOff)\r\nath9k_hw_ani_control(ah,\r\nATH9K_ANI_OFDM_WEAK_SIGNAL_DETECTION,\r\ntrue);\r\nif (aniState->firstepLevel < HAL_FIRST_STEP_MAX)\r\nath9k_hw_ani_control(ah, ATH9K_ANI_FIRSTEP_LEVEL,\r\naniState->firstepLevel + 1);\r\nreturn;\r\n} else {\r\nif ((conf->channel->band == IEEE80211_BAND_2GHZ) &&\r\n!conf_is_ht(conf)) {\r\nif (!aniState->ofdmWeakSigDetectOff)\r\nath9k_hw_ani_control(ah,\r\nATH9K_ANI_OFDM_WEAK_SIGNAL_DETECTION,\r\nfalse);\r\nif (aniState->firstepLevel > 0)\r\nath9k_hw_ani_control(ah,\r\nATH9K_ANI_FIRSTEP_LEVEL, 0);\r\nreturn;\r\n}\r\n}\r\n}\r\nstatic void ath9k_hw_ani_cck_err_trigger_old(struct ath_hw *ah)\r\n{\r\nstruct ieee80211_conf *conf = &ath9k_hw_common(ah)->hw->conf;\r\nstruct ar5416AniState *aniState;\r\nint32_t rssi;\r\naniState = &ah->curchan->ani;\r\nif (aniState->noiseImmunityLevel < HAL_NOISE_IMMUNE_MAX) {\r\nif (ath9k_hw_ani_control(ah, ATH9K_ANI_NOISE_IMMUNITY_LEVEL,\r\naniState->noiseImmunityLevel + 1)) {\r\nreturn;\r\n}\r\n}\r\nif (ah->opmode == NL80211_IFTYPE_AP) {\r\nif (aniState->firstepLevel < HAL_FIRST_STEP_MAX) {\r\nath9k_hw_ani_control(ah, ATH9K_ANI_FIRSTEP_LEVEL,\r\naniState->firstepLevel + 1);\r\n}\r\nreturn;\r\n}\r\nrssi = BEACON_RSSI(ah);\r\nif (rssi > aniState->rssiThrLow) {\r\nif (aniState->firstepLevel < HAL_FIRST_STEP_MAX)\r\nath9k_hw_ani_control(ah, ATH9K_ANI_FIRSTEP_LEVEL,\r\naniState->firstepLevel + 1);\r\n} else {\r\nif ((conf->channel->band == IEEE80211_BAND_2GHZ) &&\r\n!conf_is_ht(conf)) {\r\nif (aniState->firstepLevel > 0)\r\nath9k_hw_ani_control(ah,\r\nATH9K_ANI_FIRSTEP_LEVEL, 0);\r\n}\r\n}\r\n}\r\nstatic void ath9k_hw_set_ofdm_nil(struct ath_hw *ah, u8 immunityLevel)\r\n{\r\nstruct ar5416AniState *aniState = &ah->curchan->ani;\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nconst struct ani_ofdm_level_entry *entry_ofdm;\r\nconst struct ani_cck_level_entry *entry_cck;\r\naniState->noiseFloor = BEACON_RSSI(ah);\r\nath_dbg(common, ATH_DBG_ANI,\r\n"**** ofdmlevel %d=>%d, rssi=%d[lo=%d hi=%d]\n",\r\naniState->ofdmNoiseImmunityLevel,\r\nimmunityLevel, aniState->noiseFloor,\r\naniState->rssiThrLow, aniState->rssiThrHigh);\r\naniState->ofdmNoiseImmunityLevel = immunityLevel;\r\nentry_ofdm = &ofdm_level_table[aniState->ofdmNoiseImmunityLevel];\r\nentry_cck = &cck_level_table[aniState->cckNoiseImmunityLevel];\r\nif (aniState->spurImmunityLevel != entry_ofdm->spur_immunity_level)\r\nath9k_hw_ani_control(ah,\r\nATH9K_ANI_SPUR_IMMUNITY_LEVEL,\r\nentry_ofdm->spur_immunity_level);\r\nif (aniState->firstepLevel != entry_ofdm->fir_step_level &&\r\nentry_ofdm->fir_step_level >= entry_cck->fir_step_level)\r\nath9k_hw_ani_control(ah,\r\nATH9K_ANI_FIRSTEP_LEVEL,\r\nentry_ofdm->fir_step_level);\r\nif ((ah->opmode != NL80211_IFTYPE_STATION &&\r\nah->opmode != NL80211_IFTYPE_ADHOC) ||\r\naniState->noiseFloor <= aniState->rssiThrHigh) {\r\nif (aniState->ofdmWeakSigDetectOff)\r\nath9k_hw_ani_control(ah,\r\nATH9K_ANI_OFDM_WEAK_SIGNAL_DETECTION,\r\ntrue);\r\nelse if (aniState->ofdmWeakSigDetectOff ==\r\nentry_ofdm->ofdm_weak_signal_on)\r\nath9k_hw_ani_control(ah,\r\nATH9K_ANI_OFDM_WEAK_SIGNAL_DETECTION,\r\nentry_ofdm->ofdm_weak_signal_on);\r\n}\r\n}\r\nstatic void ath9k_hw_ani_ofdm_err_trigger(struct ath_hw *ah)\r\n{\r\nstruct ar5416AniState *aniState;\r\nif (!DO_ANI(ah))\r\nreturn;\r\nif (!use_new_ani(ah)) {\r\nath9k_hw_ani_ofdm_err_trigger_old(ah);\r\nreturn;\r\n}\r\naniState = &ah->curchan->ani;\r\nif (aniState->ofdmNoiseImmunityLevel < ATH9K_ANI_OFDM_MAX_LEVEL)\r\nath9k_hw_set_ofdm_nil(ah, aniState->ofdmNoiseImmunityLevel + 1);\r\n}\r\nstatic void ath9k_hw_set_cck_nil(struct ath_hw *ah, u_int8_t immunityLevel)\r\n{\r\nstruct ar5416AniState *aniState = &ah->curchan->ani;\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nconst struct ani_ofdm_level_entry *entry_ofdm;\r\nconst struct ani_cck_level_entry *entry_cck;\r\naniState->noiseFloor = BEACON_RSSI(ah);\r\nath_dbg(common, ATH_DBG_ANI,\r\n"**** ccklevel %d=>%d, rssi=%d[lo=%d hi=%d]\n",\r\naniState->cckNoiseImmunityLevel, immunityLevel,\r\naniState->noiseFloor, aniState->rssiThrLow,\r\naniState->rssiThrHigh);\r\nif ((ah->opmode == NL80211_IFTYPE_STATION ||\r\nah->opmode == NL80211_IFTYPE_ADHOC) &&\r\naniState->noiseFloor <= aniState->rssiThrLow &&\r\nimmunityLevel > ATH9K_ANI_CCK_MAX_LEVEL_LOW_RSSI)\r\nimmunityLevel = ATH9K_ANI_CCK_MAX_LEVEL_LOW_RSSI;\r\naniState->cckNoiseImmunityLevel = immunityLevel;\r\nentry_ofdm = &ofdm_level_table[aniState->ofdmNoiseImmunityLevel];\r\nentry_cck = &cck_level_table[aniState->cckNoiseImmunityLevel];\r\nif (aniState->firstepLevel != entry_cck->fir_step_level &&\r\nentry_cck->fir_step_level >= entry_ofdm->fir_step_level)\r\nath9k_hw_ani_control(ah,\r\nATH9K_ANI_FIRSTEP_LEVEL,\r\nentry_cck->fir_step_level);\r\nif (!AR_SREV_9300_20_OR_LATER(ah) || AR_SREV_9485(ah))\r\nreturn;\r\nif (aniState->mrcCCKOff == entry_cck->mrc_cck_on)\r\nath9k_hw_ani_control(ah,\r\nATH9K_ANI_MRC_CCK,\r\nentry_cck->mrc_cck_on);\r\n}\r\nstatic void ath9k_hw_ani_cck_err_trigger(struct ath_hw *ah)\r\n{\r\nstruct ar5416AniState *aniState;\r\nif (!DO_ANI(ah))\r\nreturn;\r\nif (!use_new_ani(ah)) {\r\nath9k_hw_ani_cck_err_trigger_old(ah);\r\nreturn;\r\n}\r\naniState = &ah->curchan->ani;\r\nif (aniState->cckNoiseImmunityLevel < ATH9K_ANI_CCK_MAX_LEVEL)\r\nath9k_hw_set_cck_nil(ah, aniState->cckNoiseImmunityLevel + 1);\r\n}\r\nstatic void ath9k_hw_ani_lower_immunity_old(struct ath_hw *ah)\r\n{\r\nstruct ar5416AniState *aniState;\r\nint32_t rssi;\r\naniState = &ah->curchan->ani;\r\nif (ah->opmode == NL80211_IFTYPE_AP) {\r\nif (aniState->firstepLevel > 0) {\r\nif (ath9k_hw_ani_control(ah, ATH9K_ANI_FIRSTEP_LEVEL,\r\naniState->firstepLevel - 1))\r\nreturn;\r\n}\r\n} else {\r\nrssi = BEACON_RSSI(ah);\r\nif (rssi > aniState->rssiThrHigh) {\r\n} else if (rssi > aniState->rssiThrLow) {\r\nif (aniState->ofdmWeakSigDetectOff) {\r\nif (ath9k_hw_ani_control(ah,\r\nATH9K_ANI_OFDM_WEAK_SIGNAL_DETECTION,\r\ntrue) == true)\r\nreturn;\r\n}\r\nif (aniState->firstepLevel > 0) {\r\nif (ath9k_hw_ani_control(ah,\r\nATH9K_ANI_FIRSTEP_LEVEL,\r\naniState->firstepLevel - 1) == true)\r\nreturn;\r\n}\r\n} else {\r\nif (aniState->firstepLevel > 0) {\r\nif (ath9k_hw_ani_control(ah,\r\nATH9K_ANI_FIRSTEP_LEVEL,\r\naniState->firstepLevel - 1) == true)\r\nreturn;\r\n}\r\n}\r\n}\r\nif (aniState->spurImmunityLevel > 0) {\r\nif (ath9k_hw_ani_control(ah, ATH9K_ANI_SPUR_IMMUNITY_LEVEL,\r\naniState->spurImmunityLevel - 1))\r\nreturn;\r\n}\r\nif (aniState->noiseImmunityLevel > 0) {\r\nath9k_hw_ani_control(ah, ATH9K_ANI_NOISE_IMMUNITY_LEVEL,\r\naniState->noiseImmunityLevel - 1);\r\nreturn;\r\n}\r\n}\r\nstatic void ath9k_hw_ani_lower_immunity(struct ath_hw *ah)\r\n{\r\nstruct ar5416AniState *aniState;\r\naniState = &ah->curchan->ani;\r\nif (!use_new_ani(ah)) {\r\nath9k_hw_ani_lower_immunity_old(ah);\r\nreturn;\r\n}\r\nif (aniState->ofdmNoiseImmunityLevel > 0 &&\r\n(aniState->ofdmsTurn || aniState->cckNoiseImmunityLevel == 0)) {\r\nath9k_hw_set_ofdm_nil(ah, aniState->ofdmNoiseImmunityLevel - 1);\r\nreturn;\r\n}\r\nif (aniState->cckNoiseImmunityLevel > 0)\r\nath9k_hw_set_cck_nil(ah, aniState->cckNoiseImmunityLevel - 1);\r\n}\r\nstatic void ath9k_ani_reset_old(struct ath_hw *ah, bool is_scanning)\r\n{\r\nstruct ar5416AniState *aniState;\r\nstruct ath9k_channel *chan = ah->curchan;\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nif (!DO_ANI(ah))\r\nreturn;\r\naniState = &ah->curchan->ani;\r\nif (ah->opmode != NL80211_IFTYPE_STATION\r\n&& ah->opmode != NL80211_IFTYPE_ADHOC) {\r\nath_dbg(common, ATH_DBG_ANI,\r\n"Reset ANI state opmode %u\n", ah->opmode);\r\nah->stats.ast_ani_reset++;\r\nif (ah->opmode == NL80211_IFTYPE_AP) {\r\nif (IS_CHAN_2GHZ(chan))\r\nah->ani_function = (ATH9K_ANI_SPUR_IMMUNITY_LEVEL |\r\nATH9K_ANI_FIRSTEP_LEVEL);\r\nelse\r\nah->ani_function = 0;\r\n}\r\nath9k_hw_ani_control(ah, ATH9K_ANI_NOISE_IMMUNITY_LEVEL, 0);\r\nath9k_hw_ani_control(ah, ATH9K_ANI_SPUR_IMMUNITY_LEVEL, 0);\r\nath9k_hw_ani_control(ah, ATH9K_ANI_FIRSTEP_LEVEL, 0);\r\nath9k_hw_ani_control(ah, ATH9K_ANI_OFDM_WEAK_SIGNAL_DETECTION,\r\n!ATH9K_ANI_USE_OFDM_WEAK_SIG);\r\nath9k_hw_ani_control(ah, ATH9K_ANI_CCK_WEAK_SIGNAL_THR,\r\nATH9K_ANI_CCK_WEAK_SIG_THR);\r\nath9k_hw_setrxfilter(ah, ath9k_hw_getrxfilter(ah) |\r\nATH9K_RX_FILTER_PHYERR);\r\nath9k_ani_restart(ah);\r\nreturn;\r\n}\r\nif (aniState->noiseImmunityLevel != 0)\r\nath9k_hw_ani_control(ah, ATH9K_ANI_NOISE_IMMUNITY_LEVEL,\r\naniState->noiseImmunityLevel);\r\nif (aniState->spurImmunityLevel != 0)\r\nath9k_hw_ani_control(ah, ATH9K_ANI_SPUR_IMMUNITY_LEVEL,\r\naniState->spurImmunityLevel);\r\nif (aniState->ofdmWeakSigDetectOff)\r\nath9k_hw_ani_control(ah, ATH9K_ANI_OFDM_WEAK_SIGNAL_DETECTION,\r\n!aniState->ofdmWeakSigDetectOff);\r\nif (aniState->cckWeakSigThreshold)\r\nath9k_hw_ani_control(ah, ATH9K_ANI_CCK_WEAK_SIGNAL_THR,\r\naniState->cckWeakSigThreshold);\r\nif (aniState->firstepLevel != 0)\r\nath9k_hw_ani_control(ah, ATH9K_ANI_FIRSTEP_LEVEL,\r\naniState->firstepLevel);\r\nath9k_hw_setrxfilter(ah, ath9k_hw_getrxfilter(ah) &\r\n~ATH9K_RX_FILTER_PHYERR);\r\nath9k_ani_restart(ah);\r\nENABLE_REGWRITE_BUFFER(ah);\r\nREG_WRITE(ah, AR_PHY_ERR_MASK_1, AR_PHY_ERR_OFDM_TIMING);\r\nREG_WRITE(ah, AR_PHY_ERR_MASK_2, AR_PHY_ERR_CCK_TIMING);\r\nREGWRITE_BUFFER_FLUSH(ah);\r\n}\r\nvoid ath9k_ani_reset(struct ath_hw *ah, bool is_scanning)\r\n{\r\nstruct ar5416AniState *aniState = &ah->curchan->ani;\r\nstruct ath9k_channel *chan = ah->curchan;\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nif (!DO_ANI(ah))\r\nreturn;\r\nif (!use_new_ani(ah))\r\nreturn ath9k_ani_reset_old(ah, is_scanning);\r\nBUG_ON(aniState == NULL);\r\nah->stats.ast_ani_reset++;\r\nif (ah->opmode == NL80211_IFTYPE_AP) {\r\nif (IS_CHAN_2GHZ(chan)) {\r\nah->ani_function = (ATH9K_ANI_SPUR_IMMUNITY_LEVEL |\r\nATH9K_ANI_FIRSTEP_LEVEL);\r\nif (AR_SREV_9300_20_OR_LATER(ah))\r\nah->ani_function |= ATH9K_ANI_MRC_CCK;\r\n} else\r\nah->ani_function = 0;\r\n}\r\nah->ani_function |= ATH9K_ANI_MODE;\r\nif (is_scanning ||\r\n(ah->opmode != NL80211_IFTYPE_STATION &&\r\nah->opmode != NL80211_IFTYPE_ADHOC)) {\r\nif (aniState->ofdmNoiseImmunityLevel !=\r\nATH9K_ANI_OFDM_DEF_LEVEL ||\r\naniState->cckNoiseImmunityLevel !=\r\nATH9K_ANI_CCK_DEF_LEVEL) {\r\nath_dbg(common, ATH_DBG_ANI,\r\n"Restore defaults: opmode %u chan %d Mhz/0x%x is_scanning=%d ofdm:%d cck:%d\n",\r\nah->opmode,\r\nchan->channel,\r\nchan->channelFlags,\r\nis_scanning,\r\naniState->ofdmNoiseImmunityLevel,\r\naniState->cckNoiseImmunityLevel);\r\nath9k_hw_set_ofdm_nil(ah, ATH9K_ANI_OFDM_DEF_LEVEL);\r\nath9k_hw_set_cck_nil(ah, ATH9K_ANI_CCK_DEF_LEVEL);\r\n}\r\n} else {\r\nath_dbg(common, ATH_DBG_ANI,\r\n"Restore history: opmode %u chan %d Mhz/0x%x is_scanning=%d ofdm:%d cck:%d\n",\r\nah->opmode,\r\nchan->channel,\r\nchan->channelFlags,\r\nis_scanning,\r\naniState->ofdmNoiseImmunityLevel,\r\naniState->cckNoiseImmunityLevel);\r\nath9k_hw_set_ofdm_nil(ah,\r\naniState->ofdmNoiseImmunityLevel);\r\nath9k_hw_set_cck_nil(ah,\r\naniState->cckNoiseImmunityLevel);\r\n}\r\nath9k_ani_restart(ah);\r\nENABLE_REGWRITE_BUFFER(ah);\r\nREG_WRITE(ah, AR_PHY_ERR_MASK_1, AR_PHY_ERR_OFDM_TIMING);\r\nREG_WRITE(ah, AR_PHY_ERR_MASK_2, AR_PHY_ERR_CCK_TIMING);\r\nREGWRITE_BUFFER_FLUSH(ah);\r\n}\r\nstatic bool ath9k_hw_ani_read_counters(struct ath_hw *ah)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nstruct ar5416AniState *aniState = &ah->curchan->ani;\r\nu32 ofdm_base = 0;\r\nu32 cck_base = 0;\r\nu32 ofdmPhyErrCnt, cckPhyErrCnt;\r\nu32 phyCnt1, phyCnt2;\r\nint32_t listenTime;\r\nath_hw_cycle_counters_update(common);\r\nlistenTime = ath_hw_get_listen_time(common);\r\nif (listenTime <= 0) {\r\nah->stats.ast_ani_lneg++;\r\nath9k_ani_restart(ah);\r\nreturn false;\r\n}\r\nif (!use_new_ani(ah)) {\r\nofdm_base = AR_PHY_COUNTMAX - ah->config.ofdm_trig_high;\r\ncck_base = AR_PHY_COUNTMAX - ah->config.cck_trig_high;\r\n}\r\naniState->listenTime += listenTime;\r\nath9k_hw_update_mibstats(ah, &ah->ah_mibStats);\r\nphyCnt1 = REG_READ(ah, AR_PHY_ERR_1);\r\nphyCnt2 = REG_READ(ah, AR_PHY_ERR_2);\r\nif (!use_new_ani(ah) && (phyCnt1 < ofdm_base || phyCnt2 < cck_base)) {\r\nif (phyCnt1 < ofdm_base) {\r\nath_dbg(common, ATH_DBG_ANI,\r\n"phyCnt1 0x%x, resetting counter value to 0x%x\n",\r\nphyCnt1, ofdm_base);\r\nREG_WRITE(ah, AR_PHY_ERR_1, ofdm_base);\r\nREG_WRITE(ah, AR_PHY_ERR_MASK_1,\r\nAR_PHY_ERR_OFDM_TIMING);\r\n}\r\nif (phyCnt2 < cck_base) {\r\nath_dbg(common, ATH_DBG_ANI,\r\n"phyCnt2 0x%x, resetting counter value to 0x%x\n",\r\nphyCnt2, cck_base);\r\nREG_WRITE(ah, AR_PHY_ERR_2, cck_base);\r\nREG_WRITE(ah, AR_PHY_ERR_MASK_2,\r\nAR_PHY_ERR_CCK_TIMING);\r\n}\r\nreturn false;\r\n}\r\nofdmPhyErrCnt = phyCnt1 - ofdm_base;\r\nah->stats.ast_ani_ofdmerrs +=\r\nofdmPhyErrCnt - aniState->ofdmPhyErrCount;\r\naniState->ofdmPhyErrCount = ofdmPhyErrCnt;\r\ncckPhyErrCnt = phyCnt2 - cck_base;\r\nah->stats.ast_ani_cckerrs +=\r\ncckPhyErrCnt - aniState->cckPhyErrCount;\r\naniState->cckPhyErrCount = cckPhyErrCnt;\r\nreturn true;\r\n}\r\nvoid ath9k_hw_ani_monitor(struct ath_hw *ah, struct ath9k_channel *chan)\r\n{\r\nstruct ar5416AniState *aniState;\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nu32 ofdmPhyErrRate, cckPhyErrRate;\r\nif (!DO_ANI(ah))\r\nreturn;\r\naniState = &ah->curchan->ani;\r\nif (WARN_ON(!aniState))\r\nreturn;\r\nif (!ath9k_hw_ani_read_counters(ah))\r\nreturn;\r\nofdmPhyErrRate = aniState->ofdmPhyErrCount * 1000 /\r\naniState->listenTime;\r\ncckPhyErrRate = aniState->cckPhyErrCount * 1000 /\r\naniState->listenTime;\r\nath_dbg(common, ATH_DBG_ANI,\r\n"listenTime=%d OFDM:%d errs=%d/s CCK:%d errs=%d/s ofdm_turn=%d\n",\r\naniState->listenTime,\r\naniState->ofdmNoiseImmunityLevel,\r\nofdmPhyErrRate, aniState->cckNoiseImmunityLevel,\r\ncckPhyErrRate, aniState->ofdmsTurn);\r\nif (aniState->listenTime > 5 * ah->aniperiod) {\r\nif (ofdmPhyErrRate <= ah->config.ofdm_trig_low &&\r\ncckPhyErrRate <= ah->config.cck_trig_low) {\r\nath9k_hw_ani_lower_immunity(ah);\r\naniState->ofdmsTurn = !aniState->ofdmsTurn;\r\n}\r\nath9k_ani_restart(ah);\r\n} else if (aniState->listenTime > ah->aniperiod) {\r\nif (ofdmPhyErrRate > ah->config.ofdm_trig_high &&\r\n(cckPhyErrRate <= ah->config.cck_trig_high ||\r\naniState->ofdmsTurn)) {\r\nath9k_hw_ani_ofdm_err_trigger(ah);\r\nath9k_ani_restart(ah);\r\naniState->ofdmsTurn = false;\r\n} else if (cckPhyErrRate > ah->config.cck_trig_high) {\r\nath9k_hw_ani_cck_err_trigger(ah);\r\nath9k_ani_restart(ah);\r\naniState->ofdmsTurn = true;\r\n}\r\n}\r\n}\r\nvoid ath9k_enable_mib_counters(struct ath_hw *ah)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nath_dbg(common, ATH_DBG_ANI, "Enable MIB counters\n");\r\nath9k_hw_update_mibstats(ah, &ah->ah_mibStats);\r\nENABLE_REGWRITE_BUFFER(ah);\r\nREG_WRITE(ah, AR_FILT_OFDM, 0);\r\nREG_WRITE(ah, AR_FILT_CCK, 0);\r\nREG_WRITE(ah, AR_MIBC,\r\n~(AR_MIBC_COW | AR_MIBC_FMC | AR_MIBC_CMC | AR_MIBC_MCS)\r\n& 0x0f);\r\nREG_WRITE(ah, AR_PHY_ERR_MASK_1, AR_PHY_ERR_OFDM_TIMING);\r\nREG_WRITE(ah, AR_PHY_ERR_MASK_2, AR_PHY_ERR_CCK_TIMING);\r\nREGWRITE_BUFFER_FLUSH(ah);\r\n}\r\nvoid ath9k_hw_disable_mib_counters(struct ath_hw *ah)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nath_dbg(common, ATH_DBG_ANI, "Disable MIB counters\n");\r\nREG_WRITE(ah, AR_MIBC, AR_MIBC_FMC);\r\nath9k_hw_update_mibstats(ah, &ah->ah_mibStats);\r\nREG_WRITE(ah, AR_MIBC, AR_MIBC_CMC);\r\nREG_WRITE(ah, AR_FILT_OFDM, 0);\r\nREG_WRITE(ah, AR_FILT_CCK, 0);\r\n}\r\nvoid ath9k_hw_proc_mib_event(struct ath_hw *ah)\r\n{\r\nu32 phyCnt1, phyCnt2;\r\nREG_WRITE(ah, AR_FILT_OFDM, 0);\r\nREG_WRITE(ah, AR_FILT_CCK, 0);\r\nif (!(REG_READ(ah, AR_SLP_MIB_CTRL) & AR_SLP_MIB_PENDING))\r\nREG_WRITE(ah, AR_SLP_MIB_CTRL, AR_SLP_MIB_CLEAR);\r\nath9k_hw_update_mibstats(ah, &ah->ah_mibStats);\r\nif (!DO_ANI(ah)) {\r\nREG_WRITE(ah, AR_PHY_ERR_1, 0);\r\nREG_WRITE(ah, AR_PHY_ERR_2, 0);\r\nreturn;\r\n}\r\nphyCnt1 = REG_READ(ah, AR_PHY_ERR_1);\r\nphyCnt2 = REG_READ(ah, AR_PHY_ERR_2);\r\nif (((phyCnt1 & AR_MIBCNT_INTRMASK) == AR_MIBCNT_INTRMASK) ||\r\n((phyCnt2 & AR_MIBCNT_INTRMASK) == AR_MIBCNT_INTRMASK)) {\r\nif (!use_new_ani(ah))\r\nath9k_hw_ani_read_counters(ah);\r\nath9k_ani_restart(ah);\r\n}\r\n}\r\nvoid ath9k_hw_ani_setup(struct ath_hw *ah)\r\n{\r\nint i;\r\nstatic const int totalSizeDesired[] = { -55, -55, -55, -55, -62 };\r\nstatic const int coarseHigh[] = { -14, -14, -14, -14, -12 };\r\nstatic const int coarseLow[] = { -64, -64, -64, -64, -70 };\r\nstatic const int firpwr[] = { -78, -78, -78, -78, -80 };\r\nfor (i = 0; i < 5; i++) {\r\nah->totalSizeDesired[i] = totalSizeDesired[i];\r\nah->coarse_high[i] = coarseHigh[i];\r\nah->coarse_low[i] = coarseLow[i];\r\nah->firpwr[i] = firpwr[i];\r\n}\r\n}\r\nvoid ath9k_hw_ani_init(struct ath_hw *ah)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nint i;\r\nath_dbg(common, ATH_DBG_ANI, "Initialize ANI\n");\r\nif (use_new_ani(ah)) {\r\nah->config.ofdm_trig_high = ATH9K_ANI_OFDM_TRIG_HIGH_NEW;\r\nah->config.ofdm_trig_low = ATH9K_ANI_OFDM_TRIG_LOW_NEW;\r\nah->config.cck_trig_high = ATH9K_ANI_CCK_TRIG_HIGH_NEW;\r\nah->config.cck_trig_low = ATH9K_ANI_CCK_TRIG_LOW_NEW;\r\n} else {\r\nah->config.ofdm_trig_high = ATH9K_ANI_OFDM_TRIG_HIGH_OLD;\r\nah->config.ofdm_trig_low = ATH9K_ANI_OFDM_TRIG_LOW_OLD;\r\nah->config.cck_trig_high = ATH9K_ANI_CCK_TRIG_HIGH_OLD;\r\nah->config.cck_trig_low = ATH9K_ANI_CCK_TRIG_LOW_OLD;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(ah->channels); i++) {\r\nstruct ath9k_channel *chan = &ah->channels[i];\r\nstruct ar5416AniState *ani = &chan->ani;\r\nif (use_new_ani(ah)) {\r\nani->spurImmunityLevel =\r\nATH9K_ANI_SPUR_IMMUNE_LVL_NEW;\r\nani->firstepLevel = ATH9K_ANI_FIRSTEP_LVL_NEW;\r\nif (AR_SREV_9300_20_OR_LATER(ah))\r\nani->mrcCCKOff =\r\n!ATH9K_ANI_ENABLE_MRC_CCK;\r\nelse\r\nani->mrcCCKOff = true;\r\nani->ofdmsTurn = true;\r\n} else {\r\nani->spurImmunityLevel =\r\nATH9K_ANI_SPUR_IMMUNE_LVL_OLD;\r\nani->firstepLevel = ATH9K_ANI_FIRSTEP_LVL_OLD;\r\nani->cckWeakSigThreshold =\r\nATH9K_ANI_CCK_WEAK_SIG_THR;\r\n}\r\nani->rssiThrHigh = ATH9K_ANI_RSSI_THR_HIGH;\r\nani->rssiThrLow = ATH9K_ANI_RSSI_THR_LOW;\r\nani->ofdmWeakSigDetectOff =\r\n!ATH9K_ANI_USE_OFDM_WEAK_SIG;\r\nani->cckNoiseImmunityLevel = ATH9K_ANI_CCK_DEF_LEVEL;\r\n}\r\nif (use_new_ani(ah)) {\r\nah->aniperiod = ATH9K_ANI_PERIOD_NEW;\r\nah->config.ani_poll_interval = ATH9K_ANI_POLLINTERVAL_NEW;\r\n} else {\r\nah->aniperiod = ATH9K_ANI_PERIOD_OLD;\r\nah->config.ani_poll_interval = ATH9K_ANI_POLLINTERVAL_OLD;\r\n}\r\nif (ah->config.enable_ani)\r\nah->proc_phyerr |= HAL_PROCESS_ANI;\r\nath9k_ani_restart(ah);\r\nath9k_enable_mib_counters(ah);\r\n}

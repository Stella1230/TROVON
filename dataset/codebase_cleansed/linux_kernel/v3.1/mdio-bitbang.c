static void mdiobb_send_bit(struct mdiobb_ctrl *ctrl, int val)\r\n{\r\nconst struct mdiobb_ops *ops = ctrl->ops;\r\nops->set_mdio_data(ctrl, val);\r\nndelay(MDIO_DELAY);\r\nops->set_mdc(ctrl, 1);\r\nndelay(MDIO_DELAY);\r\nops->set_mdc(ctrl, 0);\r\n}\r\nstatic int mdiobb_get_bit(struct mdiobb_ctrl *ctrl)\r\n{\r\nconst struct mdiobb_ops *ops = ctrl->ops;\r\nndelay(MDIO_DELAY);\r\nops->set_mdc(ctrl, 1);\r\nndelay(MDIO_READ_DELAY);\r\nops->set_mdc(ctrl, 0);\r\nreturn ops->get_mdio_data(ctrl);\r\n}\r\nstatic void mdiobb_send_num(struct mdiobb_ctrl *ctrl, u16 val, int bits)\r\n{\r\nint i;\r\nfor (i = bits - 1; i >= 0; i--)\r\nmdiobb_send_bit(ctrl, (val >> i) & 1);\r\n}\r\nstatic u16 mdiobb_get_num(struct mdiobb_ctrl *ctrl, int bits)\r\n{\r\nint i;\r\nu16 ret = 0;\r\nfor (i = bits - 1; i >= 0; i--) {\r\nret <<= 1;\r\nret |= mdiobb_get_bit(ctrl);\r\n}\r\nreturn ret;\r\n}\r\nstatic void mdiobb_cmd(struct mdiobb_ctrl *ctrl, int op, u8 phy, u8 reg)\r\n{\r\nconst struct mdiobb_ops *ops = ctrl->ops;\r\nint i;\r\nops->set_mdio_dir(ctrl, 1);\r\nfor (i = 0; i < 32; i++)\r\nmdiobb_send_bit(ctrl, 1);\r\nmdiobb_send_bit(ctrl, 0);\r\nif (op & MDIO_C45)\r\nmdiobb_send_bit(ctrl, 0);\r\nelse\r\nmdiobb_send_bit(ctrl, 1);\r\nmdiobb_send_bit(ctrl, (op >> 1) & 1);\r\nmdiobb_send_bit(ctrl, (op >> 0) & 1);\r\nmdiobb_send_num(ctrl, phy, 5);\r\nmdiobb_send_num(ctrl, reg, 5);\r\n}\r\nstatic int mdiobb_cmd_addr(struct mdiobb_ctrl *ctrl, int phy, u32 addr)\r\n{\r\nunsigned int dev_addr = (addr >> 16) & 0x1F;\r\nunsigned int reg = addr & 0xFFFF;\r\nmdiobb_cmd(ctrl, MDIO_C45_ADDR, phy, dev_addr);\r\nmdiobb_send_bit(ctrl, 1);\r\nmdiobb_send_bit(ctrl, 0);\r\nmdiobb_send_num(ctrl, reg, 16);\r\nctrl->ops->set_mdio_dir(ctrl, 0);\r\nmdiobb_get_bit(ctrl);\r\nreturn dev_addr;\r\n}\r\nstatic int mdiobb_read(struct mii_bus *bus, int phy, int reg)\r\n{\r\nstruct mdiobb_ctrl *ctrl = bus->priv;\r\nint ret, i;\r\nif (reg & MII_ADDR_C45) {\r\nreg = mdiobb_cmd_addr(ctrl, phy, reg);\r\nmdiobb_cmd(ctrl, MDIO_C45_READ, phy, reg);\r\n} else\r\nmdiobb_cmd(ctrl, MDIO_READ, phy, reg);\r\nctrl->ops->set_mdio_dir(ctrl, 0);\r\nif (mdiobb_get_bit(ctrl) != 0) {\r\nfor (i = 0; i < 32; i++)\r\nmdiobb_get_bit(ctrl);\r\nreturn 0xffff;\r\n}\r\nret = mdiobb_get_num(ctrl, 16);\r\nmdiobb_get_bit(ctrl);\r\nreturn ret;\r\n}\r\nstatic int mdiobb_write(struct mii_bus *bus, int phy, int reg, u16 val)\r\n{\r\nstruct mdiobb_ctrl *ctrl = bus->priv;\r\nif (reg & MII_ADDR_C45) {\r\nreg = mdiobb_cmd_addr(ctrl, phy, reg);\r\nmdiobb_cmd(ctrl, MDIO_C45_WRITE, phy, reg);\r\n} else\r\nmdiobb_cmd(ctrl, MDIO_WRITE, phy, reg);\r\nmdiobb_send_bit(ctrl, 1);\r\nmdiobb_send_bit(ctrl, 0);\r\nmdiobb_send_num(ctrl, val, 16);\r\nctrl->ops->set_mdio_dir(ctrl, 0);\r\nmdiobb_get_bit(ctrl);\r\nreturn 0;\r\n}\r\nstruct mii_bus *alloc_mdio_bitbang(struct mdiobb_ctrl *ctrl)\r\n{\r\nstruct mii_bus *bus;\r\nbus = mdiobus_alloc();\r\nif (!bus)\r\nreturn NULL;\r\n__module_get(ctrl->ops->owner);\r\nbus->read = mdiobb_read;\r\nbus->write = mdiobb_write;\r\nbus->priv = ctrl;\r\nreturn bus;\r\n}\r\nvoid free_mdio_bitbang(struct mii_bus *bus)\r\n{\r\nstruct mdiobb_ctrl *ctrl = bus->priv;\r\nmodule_put(ctrl->ops->owner);\r\nmdiobus_free(bus);\r\n}

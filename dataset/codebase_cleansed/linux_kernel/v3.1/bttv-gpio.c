static int bttv_sub_bus_match(struct device *dev, struct device_driver *drv)\r\n{\r\nstruct bttv_sub_driver *sub = to_bttv_sub_drv(drv);\r\nint len = strlen(sub->wanted);\r\nif (0 == strncmp(dev_name(dev), sub->wanted, len))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int bttv_sub_probe(struct device *dev)\r\n{\r\nstruct bttv_sub_device *sdev = to_bttv_sub_dev(dev);\r\nstruct bttv_sub_driver *sub = to_bttv_sub_drv(dev->driver);\r\nreturn sub->probe ? sub->probe(sdev) : -ENODEV;\r\n}\r\nstatic int bttv_sub_remove(struct device *dev)\r\n{\r\nstruct bttv_sub_device *sdev = to_bttv_sub_dev(dev);\r\nstruct bttv_sub_driver *sub = to_bttv_sub_drv(dev->driver);\r\nif (sub->remove)\r\nsub->remove(sdev);\r\nreturn 0;\r\n}\r\nstatic void release_sub_device(struct device *dev)\r\n{\r\nstruct bttv_sub_device *sub = to_bttv_sub_dev(dev);\r\nkfree(sub);\r\n}\r\nint bttv_sub_add_device(struct bttv_core *core, char *name)\r\n{\r\nstruct bttv_sub_device *sub;\r\nint err;\r\nsub = kzalloc(sizeof(*sub),GFP_KERNEL);\r\nif (NULL == sub)\r\nreturn -ENOMEM;\r\nsub->core = core;\r\nsub->dev.parent = &core->pci->dev;\r\nsub->dev.bus = &bttv_sub_bus_type;\r\nsub->dev.release = release_sub_device;\r\ndev_set_name(&sub->dev, "%s%d", name, core->nr);\r\nerr = device_register(&sub->dev);\r\nif (0 != err) {\r\nkfree(sub);\r\nreturn err;\r\n}\r\nprintk("bttv%d: add subdevice \"%s\"\n", core->nr, dev_name(&sub->dev));\r\nlist_add_tail(&sub->list,&core->subs);\r\nreturn 0;\r\n}\r\nint bttv_sub_del_devices(struct bttv_core *core)\r\n{\r\nstruct bttv_sub_device *sub, *save;\r\nlist_for_each_entry_safe(sub, save, &core->subs, list) {\r\nlist_del(&sub->list);\r\ndevice_unregister(&sub->dev);\r\n}\r\nreturn 0;\r\n}\r\nint bttv_sub_register(struct bttv_sub_driver *sub, char *wanted)\r\n{\r\nsub->drv.bus = &bttv_sub_bus_type;\r\nsnprintf(sub->wanted,sizeof(sub->wanted),"%s",wanted);\r\nreturn driver_register(&sub->drv);\r\n}\r\nint bttv_sub_unregister(struct bttv_sub_driver *sub)\r\n{\r\ndriver_unregister(&sub->drv);\r\nreturn 0;\r\n}\r\nvoid bttv_gpio_inout(struct bttv_core *core, u32 mask, u32 outbits)\r\n{\r\nstruct bttv *btv = container_of(core, struct bttv, c);\r\nunsigned long flags;\r\nu32 data;\r\nspin_lock_irqsave(&btv->gpio_lock,flags);\r\ndata = btread(BT848_GPIO_OUT_EN);\r\ndata = data & ~mask;\r\ndata = data | (mask & outbits);\r\nbtwrite(data,BT848_GPIO_OUT_EN);\r\nspin_unlock_irqrestore(&btv->gpio_lock,flags);\r\n}\r\nu32 bttv_gpio_read(struct bttv_core *core)\r\n{\r\nstruct bttv *btv = container_of(core, struct bttv, c);\r\nu32 value;\r\nvalue = btread(BT848_GPIO_DATA);\r\nreturn value;\r\n}\r\nvoid bttv_gpio_write(struct bttv_core *core, u32 value)\r\n{\r\nstruct bttv *btv = container_of(core, struct bttv, c);\r\nbtwrite(value,BT848_GPIO_DATA);\r\n}\r\nvoid bttv_gpio_bits(struct bttv_core *core, u32 mask, u32 bits)\r\n{\r\nstruct bttv *btv = container_of(core, struct bttv, c);\r\nunsigned long flags;\r\nu32 data;\r\nspin_lock_irqsave(&btv->gpio_lock,flags);\r\ndata = btread(BT848_GPIO_DATA);\r\ndata = data & ~mask;\r\ndata = data | (mask & bits);\r\nbtwrite(data,BT848_GPIO_DATA);\r\nspin_unlock_irqrestore(&btv->gpio_lock,flags);\r\n}

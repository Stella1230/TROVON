static inline u_char\r\nreadreg(unsigned int adr, u_char off)\r\n{\r\nreturn (bytein(adr + off));\r\n}\r\nstatic inline void\r\nwritereg(unsigned int adr, u_char off, u_char data)\r\n{\r\nbyteout(adr + off, data);\r\n}\r\nstatic inline void\r\nread_fifo(unsigned int adr, u_char * data, int size)\r\n{\r\ninsb(adr, data, size);\r\n}\r\nstatic void\r\nwrite_fifo(unsigned int adr, u_char * data, int size)\r\n{\r\noutsb(adr, data, size);\r\n}\r\nstatic u_char\r\nReadISAC(struct IsdnCardState *cs, u_char offset)\r\n{\r\nreturn (readreg(cs->hw.teles3.isac, offset));\r\n}\r\nstatic void\r\nWriteISAC(struct IsdnCardState *cs, u_char offset, u_char value)\r\n{\r\nwritereg(cs->hw.teles3.isac, offset, value);\r\n}\r\nstatic void\r\nReadISACfifo(struct IsdnCardState *cs, u_char * data, int size)\r\n{\r\nread_fifo(cs->hw.teles3.isacfifo, data, size);\r\n}\r\nstatic void\r\nWriteISACfifo(struct IsdnCardState *cs, u_char * data, int size)\r\n{\r\nwrite_fifo(cs->hw.teles3.isacfifo, data, size);\r\n}\r\nstatic u_char\r\nReadHSCX(struct IsdnCardState *cs, int hscx, u_char offset)\r\n{\r\nreturn (readreg(cs->hw.teles3.hscx[hscx], offset));\r\n}\r\nstatic void\r\nWriteHSCX(struct IsdnCardState *cs, int hscx, u_char offset, u_char value)\r\n{\r\nwritereg(cs->hw.teles3.hscx[hscx], offset, value);\r\n}\r\nstatic irqreturn_t\r\nteles3_interrupt(int intno, void *dev_id)\r\n{\r\n#define MAXCOUNT 5\r\nstruct IsdnCardState *cs = dev_id;\r\nu_char val;\r\nu_long flags;\r\nint count = 0;\r\nspin_lock_irqsave(&cs->lock, flags);\r\nval = readreg(cs->hw.teles3.hscx[1], HSCX_ISTA);\r\nStart_HSCX:\r\nif (val)\r\nhscx_int_main(cs, val);\r\nval = readreg(cs->hw.teles3.isac, ISAC_ISTA);\r\nStart_ISAC:\r\nif (val)\r\nisac_interrupt(cs, val);\r\ncount++;\r\nval = readreg(cs->hw.teles3.hscx[1], HSCX_ISTA);\r\nif (val && count < MAXCOUNT) {\r\nif (cs->debug & L1_DEB_HSCX)\r\ndebugl1(cs, "HSCX IntStat after IntRoutine");\r\ngoto Start_HSCX;\r\n}\r\nval = readreg(cs->hw.teles3.isac, ISAC_ISTA);\r\nif (val && count < MAXCOUNT) {\r\nif (cs->debug & L1_DEB_ISAC)\r\ndebugl1(cs, "ISAC IntStat after IntRoutine");\r\ngoto Start_ISAC;\r\n}\r\nif (count >= MAXCOUNT)\r\nprintk(KERN_WARNING "Teles3: more than %d loops in teles3_interrupt\n", count);\r\nwritereg(cs->hw.teles3.hscx[0], HSCX_MASK, 0xFF);\r\nwritereg(cs->hw.teles3.hscx[1], HSCX_MASK, 0xFF);\r\nwritereg(cs->hw.teles3.isac, ISAC_MASK, 0xFF);\r\nwritereg(cs->hw.teles3.isac, ISAC_MASK, 0x0);\r\nwritereg(cs->hw.teles3.hscx[0], HSCX_MASK, 0x0);\r\nwritereg(cs->hw.teles3.hscx[1], HSCX_MASK, 0x0);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic inline void\r\nrelease_ioregs(struct IsdnCardState *cs, int mask)\r\n{\r\nif (mask & 1)\r\nrelease_region(cs->hw.teles3.isac + 32, 32);\r\nif (mask & 2)\r\nrelease_region(cs->hw.teles3.hscx[0] + 32, 32);\r\nif (mask & 4)\r\nrelease_region(cs->hw.teles3.hscx[1] + 32, 32);\r\n}\r\nstatic void\r\nrelease_io_teles3(struct IsdnCardState *cs)\r\n{\r\nif (cs->typ == ISDN_CTYPE_TELESPCMCIA) {\r\nrelease_region(cs->hw.teles3.hscx[1], 96);\r\n} else {\r\nif (cs->hw.teles3.cfg_reg) {\r\nif (cs->typ == ISDN_CTYPE_COMPAQ_ISA) {\r\nrelease_region(cs->hw.teles3.cfg_reg, 1);\r\n} else {\r\nrelease_region(cs->hw.teles3.cfg_reg, 8);\r\n}\r\n}\r\nrelease_ioregs(cs, 0x7);\r\n}\r\n}\r\nstatic int\r\nreset_teles3(struct IsdnCardState *cs)\r\n{\r\nu_char irqcfg;\r\nif (cs->typ != ISDN_CTYPE_TELESPCMCIA) {\r\nif ((cs->hw.teles3.cfg_reg) && (cs->typ != ISDN_CTYPE_COMPAQ_ISA)) {\r\nswitch (cs->irq) {\r\ncase 2:\r\ncase 9:\r\nirqcfg = 0x00;\r\nbreak;\r\ncase 3:\r\nirqcfg = 0x02;\r\nbreak;\r\ncase 4:\r\nirqcfg = 0x04;\r\nbreak;\r\ncase 5:\r\nirqcfg = 0x06;\r\nbreak;\r\ncase 10:\r\nirqcfg = 0x08;\r\nbreak;\r\ncase 11:\r\nirqcfg = 0x0A;\r\nbreak;\r\ncase 12:\r\nirqcfg = 0x0C;\r\nbreak;\r\ncase 15:\r\nirqcfg = 0x0E;\r\nbreak;\r\ndefault:\r\nreturn(1);\r\n}\r\nbyteout(cs->hw.teles3.cfg_reg + 4, irqcfg);\r\nHZDELAY(HZ / 10 + 1);\r\nbyteout(cs->hw.teles3.cfg_reg + 4, irqcfg | 1);\r\nHZDELAY(HZ / 10 + 1);\r\n} else if (cs->typ == ISDN_CTYPE_COMPAQ_ISA) {\r\nbyteout(cs->hw.teles3.cfg_reg, 0xff);\r\nHZDELAY(2);\r\nbyteout(cs->hw.teles3.cfg_reg, 0x00);\r\nHZDELAY(2);\r\n} else {\r\nbyteout(cs->hw.teles3.isac + 0x3c, 0);\r\nHZDELAY(2);\r\nbyteout(cs->hw.teles3.isac + 0x3c, 1);\r\nHZDELAY(2);\r\n}\r\n}\r\nreturn(0);\r\n}\r\nstatic int\r\nTeles_card_msg(struct IsdnCardState *cs, int mt, void *arg)\r\n{\r\nu_long flags;\r\nswitch (mt) {\r\ncase CARD_RESET:\r\nspin_lock_irqsave(&cs->lock, flags);\r\nreset_teles3(cs);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn(0);\r\ncase CARD_RELEASE:\r\nrelease_io_teles3(cs);\r\nreturn(0);\r\ncase CARD_INIT:\r\nspin_lock_irqsave(&cs->lock, flags);\r\ninithscxisac(cs, 3);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn(0);\r\ncase CARD_TEST:\r\nreturn(0);\r\n}\r\nreturn(0);\r\n}\r\nint __devinit\r\nsetup_teles3(struct IsdnCard *card)\r\n{\r\nu_char val;\r\nstruct IsdnCardState *cs = card->cs;\r\nchar tmp[64];\r\nstrcpy(tmp, teles3_revision);\r\nprintk(KERN_INFO "HiSax: Teles IO driver Rev. %s\n", HiSax_getrev(tmp));\r\nif ((cs->typ != ISDN_CTYPE_16_3) && (cs->typ != ISDN_CTYPE_PNP)\r\n&& (cs->typ != ISDN_CTYPE_TELESPCMCIA) && (cs->typ != ISDN_CTYPE_COMPAQ_ISA))\r\nreturn (0);\r\n#ifdef __ISAPNP__\r\nif (!card->para[1] && isapnp_present()) {\r\nstruct pnp_dev *pnp_d;\r\nwhile(ipid->card_vendor) {\r\nif ((pnp_c = pnp_find_card(ipid->card_vendor,\r\nipid->card_device, pnp_c))) {\r\npnp_d = NULL;\r\nif ((pnp_d = pnp_find_dev(pnp_c,\r\nipid->vendor, ipid->function, pnp_d))) {\r\nint err;\r\nprintk(KERN_INFO "HiSax: %s detected\n",\r\n(char *)ipid->driver_data);\r\npnp_disable_dev(pnp_d);\r\nerr = pnp_activate_dev(pnp_d);\r\nif (err<0) {\r\nprintk(KERN_WARNING "%s: pnp_activate_dev ret(%d)\n",\r\n__func__, err);\r\nreturn(0);\r\n}\r\ncard->para[3] = pnp_port_start(pnp_d, 2);\r\ncard->para[2] = pnp_port_start(pnp_d, 1);\r\ncard->para[1] = pnp_port_start(pnp_d, 0);\r\ncard->para[0] = pnp_irq(pnp_d, 0);\r\nif (!card->para[0] || !card->para[1] || !card->para[2]) {\r\nprintk(KERN_ERR "Teles PnP:some resources are missing %ld/%lx/%lx\n",\r\ncard->para[0], card->para[1], card->para[2]);\r\npnp_disable_dev(pnp_d);\r\nreturn(0);\r\n}\r\nbreak;\r\n} else {\r\nprintk(KERN_ERR "Teles PnP: PnP error card found, no device\n");\r\n}\r\n}\r\nipid++;\r\npnp_c = NULL;\r\n}\r\nif (!ipid->card_vendor) {\r\nprintk(KERN_INFO "Teles PnP: no ISAPnP card found\n");\r\nreturn(0);\r\n}\r\n}\r\n#endif\r\nif (cs->typ == ISDN_CTYPE_16_3) {\r\ncs->hw.teles3.cfg_reg = card->para[1];\r\nswitch (cs->hw.teles3.cfg_reg) {\r\ncase 0x180:\r\ncase 0x280:\r\ncase 0x380:\r\ncs->hw.teles3.cfg_reg |= 0xc00;\r\nbreak;\r\n}\r\ncs->hw.teles3.isac = cs->hw.teles3.cfg_reg - 0x420;\r\ncs->hw.teles3.hscx[0] = cs->hw.teles3.cfg_reg - 0xc20;\r\ncs->hw.teles3.hscx[1] = cs->hw.teles3.cfg_reg - 0x820;\r\n} else if (cs->typ == ISDN_CTYPE_TELESPCMCIA) {\r\ncs->hw.teles3.cfg_reg = 0;\r\ncs->hw.teles3.hscx[0] = card->para[1] - 0x20;\r\ncs->hw.teles3.hscx[1] = card->para[1];\r\ncs->hw.teles3.isac = card->para[1] + 0x20;\r\n} else if (cs->typ == ISDN_CTYPE_COMPAQ_ISA) {\r\ncs->hw.teles3.cfg_reg = card->para[3];\r\ncs->hw.teles3.isac = card->para[2] - 32;\r\ncs->hw.teles3.hscx[0] = card->para[1] - 32;\r\ncs->hw.teles3.hscx[1] = card->para[1];\r\n} else {\r\ncs->hw.teles3.cfg_reg = 0;\r\ncs->hw.teles3.isac = card->para[1] - 32;\r\ncs->hw.teles3.hscx[0] = card->para[2] - 32;\r\ncs->hw.teles3.hscx[1] = card->para[2];\r\n}\r\ncs->irq = card->para[0];\r\ncs->hw.teles3.isacfifo = cs->hw.teles3.isac + 0x3e;\r\ncs->hw.teles3.hscxfifo[0] = cs->hw.teles3.hscx[0] + 0x3e;\r\ncs->hw.teles3.hscxfifo[1] = cs->hw.teles3.hscx[1] + 0x3e;\r\nif (cs->typ == ISDN_CTYPE_TELESPCMCIA) {\r\nif (!request_region(cs->hw.teles3.hscx[1], 96, "HiSax Teles PCMCIA")) {\r\nprintk(KERN_WARNING\r\n"HiSax: %s ports %x-%x already in use\n",\r\nCardType[cs->typ],\r\ncs->hw.teles3.hscx[1],\r\ncs->hw.teles3.hscx[1] + 96);\r\nreturn (0);\r\n}\r\ncs->irq_flags |= IRQF_SHARED;\r\n} else {\r\nif (cs->hw.teles3.cfg_reg) {\r\nif (cs->typ == ISDN_CTYPE_COMPAQ_ISA) {\r\nif (!request_region(cs->hw.teles3.cfg_reg, 1, "teles3 cfg")) {\r\nprintk(KERN_WARNING\r\n"HiSax: %s config port %x already in use\n",\r\nCardType[card->typ],\r\ncs->hw.teles3.cfg_reg);\r\nreturn (0);\r\n}\r\n} else {\r\nif (!request_region(cs->hw.teles3.cfg_reg, 8, "teles3 cfg")) {\r\nprintk(KERN_WARNING\r\n"HiSax: %s config port %x-%x already in use\n",\r\nCardType[card->typ],\r\ncs->hw.teles3.cfg_reg,\r\ncs->hw.teles3.cfg_reg + 8);\r\nreturn (0);\r\n}\r\n}\r\n}\r\nif (!request_region(cs->hw.teles3.isac + 32, 32, "HiSax isac")) {\r\nprintk(KERN_WARNING\r\n"HiSax: %s isac ports %x-%x already in use\n",\r\nCardType[cs->typ],\r\ncs->hw.teles3.isac + 32,\r\ncs->hw.teles3.isac + 64);\r\nif (cs->hw.teles3.cfg_reg) {\r\nif (cs->typ == ISDN_CTYPE_COMPAQ_ISA) {\r\nrelease_region(cs->hw.teles3.cfg_reg, 1);\r\n} else {\r\nrelease_region(cs->hw.teles3.cfg_reg, 8);\r\n}\r\n}\r\nreturn (0);\r\n}\r\nif (!request_region(cs->hw.teles3.hscx[0] + 32, 32, "HiSax hscx A")) {\r\nprintk(KERN_WARNING\r\n"HiSax: %s hscx A ports %x-%x already in use\n",\r\nCardType[cs->typ],\r\ncs->hw.teles3.hscx[0] + 32,\r\ncs->hw.teles3.hscx[0] + 64);\r\nif (cs->hw.teles3.cfg_reg) {\r\nif (cs->typ == ISDN_CTYPE_COMPAQ_ISA) {\r\nrelease_region(cs->hw.teles3.cfg_reg, 1);\r\n} else {\r\nrelease_region(cs->hw.teles3.cfg_reg, 8);\r\n}\r\n}\r\nrelease_ioregs(cs, 1);\r\nreturn (0);\r\n}\r\nif (!request_region(cs->hw.teles3.hscx[1] + 32, 32, "HiSax hscx B")) {\r\nprintk(KERN_WARNING\r\n"HiSax: %s hscx B ports %x-%x already in use\n",\r\nCardType[cs->typ],\r\ncs->hw.teles3.hscx[1] + 32,\r\ncs->hw.teles3.hscx[1] + 64);\r\nif (cs->hw.teles3.cfg_reg) {\r\nif (cs->typ == ISDN_CTYPE_COMPAQ_ISA) {\r\nrelease_region(cs->hw.teles3.cfg_reg, 1);\r\n} else {\r\nrelease_region(cs->hw.teles3.cfg_reg, 8);\r\n}\r\n}\r\nrelease_ioregs(cs, 3);\r\nreturn (0);\r\n}\r\n}\r\nif ((cs->hw.teles3.cfg_reg) && (cs->typ != ISDN_CTYPE_COMPAQ_ISA)) {\r\nif ((val = bytein(cs->hw.teles3.cfg_reg + 0)) != 0x51) {\r\nprintk(KERN_WARNING "Teles: 16.3 Byte at %x is %x\n",\r\ncs->hw.teles3.cfg_reg + 0, val);\r\nrelease_io_teles3(cs);\r\nreturn (0);\r\n}\r\nif ((val = bytein(cs->hw.teles3.cfg_reg + 1)) != 0x93) {\r\nprintk(KERN_WARNING "Teles: 16.3 Byte at %x is %x\n",\r\ncs->hw.teles3.cfg_reg + 1, val);\r\nrelease_io_teles3(cs);\r\nreturn (0);\r\n}\r\nval = bytein(cs->hw.teles3.cfg_reg + 2);\r\nif (val != 0x46 && val != 0x39 && val != 0x38 && val != 0x1c && val != 0x1e && val != 0x1f) {\r\nprintk(KERN_WARNING "Teles: 16.3 Byte at %x is %x\n",\r\ncs->hw.teles3.cfg_reg + 2, val);\r\nrelease_io_teles3(cs);\r\nreturn (0);\r\n}\r\n}\r\nprintk(KERN_INFO\r\n"HiSax: %s config irq:%d isac:0x%X cfg:0x%X\n",\r\nCardType[cs->typ], cs->irq,\r\ncs->hw.teles3.isac + 32, cs->hw.teles3.cfg_reg);\r\nprintk(KERN_INFO\r\n"HiSax: hscx A:0x%X hscx B:0x%X\n",\r\ncs->hw.teles3.hscx[0] + 32, cs->hw.teles3.hscx[1] + 32);\r\nsetup_isac(cs);\r\nif (reset_teles3(cs)) {\r\nprintk(KERN_WARNING "Teles3: wrong IRQ\n");\r\nrelease_io_teles3(cs);\r\nreturn (0);\r\n}\r\ncs->readisac = &ReadISAC;\r\ncs->writeisac = &WriteISAC;\r\ncs->readisacfifo = &ReadISACfifo;\r\ncs->writeisacfifo = &WriteISACfifo;\r\ncs->BC_Read_Reg = &ReadHSCX;\r\ncs->BC_Write_Reg = &WriteHSCX;\r\ncs->BC_Send_Data = &hscx_fill_fifo;\r\ncs->cardmsg = &Teles_card_msg;\r\ncs->irq_func = &teles3_interrupt;\r\nISACVersion(cs, "Teles3:");\r\nif (HscxVersion(cs, "Teles3:")) {\r\nprintk(KERN_WARNING\r\n"Teles3: wrong HSCX versions check IO address\n");\r\nrelease_io_teles3(cs);\r\nreturn (0);\r\n}\r\nreturn (1);\r\n}

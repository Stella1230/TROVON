static bool udp_pkt_to_tuple(const struct sk_buff *skb,\r\nunsigned int dataoff,\r\nstruct nf_conntrack_tuple *tuple)\r\n{\r\nconst struct udphdr *hp;\r\nstruct udphdr _hdr;\r\nhp = skb_header_pointer(skb, dataoff, sizeof(_hdr), &_hdr);\r\nif (hp == NULL)\r\nreturn false;\r\ntuple->src.u.udp.port = hp->source;\r\ntuple->dst.u.udp.port = hp->dest;\r\nreturn true;\r\n}\r\nstatic bool udp_invert_tuple(struct nf_conntrack_tuple *tuple,\r\nconst struct nf_conntrack_tuple *orig)\r\n{\r\ntuple->src.u.udp.port = orig->dst.u.udp.port;\r\ntuple->dst.u.udp.port = orig->src.u.udp.port;\r\nreturn true;\r\n}\r\nstatic int udp_print_tuple(struct seq_file *s,\r\nconst struct nf_conntrack_tuple *tuple)\r\n{\r\nreturn seq_printf(s, "sport=%hu dport=%hu ",\r\nntohs(tuple->src.u.udp.port),\r\nntohs(tuple->dst.u.udp.port));\r\n}\r\nstatic int udp_packet(struct nf_conn *ct,\r\nconst struct sk_buff *skb,\r\nunsigned int dataoff,\r\nenum ip_conntrack_info ctinfo,\r\nu_int8_t pf,\r\nunsigned int hooknum)\r\n{\r\nif (test_bit(IPS_SEEN_REPLY_BIT, &ct->status)) {\r\nnf_ct_refresh_acct(ct, ctinfo, skb, nf_ct_udp_timeout_stream);\r\nif (!test_and_set_bit(IPS_ASSURED_BIT, &ct->status))\r\nnf_conntrack_event_cache(IPCT_ASSURED, ct);\r\n} else\r\nnf_ct_refresh_acct(ct, ctinfo, skb, nf_ct_udp_timeout);\r\nreturn NF_ACCEPT;\r\n}\r\nstatic bool udp_new(struct nf_conn *ct, const struct sk_buff *skb,\r\nunsigned int dataoff)\r\n{\r\nreturn true;\r\n}\r\nstatic int udp_error(struct net *net, struct nf_conn *tmpl, struct sk_buff *skb,\r\nunsigned int dataoff, enum ip_conntrack_info *ctinfo,\r\nu_int8_t pf,\r\nunsigned int hooknum)\r\n{\r\nunsigned int udplen = skb->len - dataoff;\r\nconst struct udphdr *hdr;\r\nstruct udphdr _hdr;\r\nhdr = skb_header_pointer(skb, dataoff, sizeof(_hdr), &_hdr);\r\nif (hdr == NULL) {\r\nif (LOG_INVALID(net, IPPROTO_UDP))\r\nnf_log_packet(pf, 0, skb, NULL, NULL, NULL,\r\n"nf_ct_udp: short packet ");\r\nreturn -NF_ACCEPT;\r\n}\r\nif (ntohs(hdr->len) > udplen || ntohs(hdr->len) < sizeof(*hdr)) {\r\nif (LOG_INVALID(net, IPPROTO_UDP))\r\nnf_log_packet(pf, 0, skb, NULL, NULL, NULL,\r\n"nf_ct_udp: truncated/malformed packet ");\r\nreturn -NF_ACCEPT;\r\n}\r\nif (!hdr->check)\r\nreturn NF_ACCEPT;\r\nif (net->ct.sysctl_checksum && hooknum == NF_INET_PRE_ROUTING &&\r\nnf_checksum(skb, hooknum, dataoff, IPPROTO_UDP, pf)) {\r\nif (LOG_INVALID(net, IPPROTO_UDP))\r\nnf_log_packet(pf, 0, skb, NULL, NULL, NULL,\r\n"nf_ct_udp: bad UDP checksum ");\r\nreturn -NF_ACCEPT;\r\n}\r\nreturn NF_ACCEPT;\r\n}

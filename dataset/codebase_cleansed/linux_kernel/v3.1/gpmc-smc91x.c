static int smc91c96_gpmc_retime(void)\r\n{\r\nstruct gpmc_timings t;\r\nconst int t3 = 10;\r\nconst int t4_r = 20;\r\nconst int t4_w = 5;\r\nconst int t5 = 25;\r\nconst int t6 = 15;\r\nconst int t7 = 5;\r\nconst int t8 = 5;\r\nconst int t20 = 185;\r\nu32 l;\r\nmemset(&t, 0, sizeof(t));\r\nt.cs_on = 0;\r\nt.adv_on = t.cs_on;\r\nt.oe_on = t.adv_on + t3;\r\nt.access = t.oe_on + t5;\r\nt.oe_off = t.access;\r\nt.adv_rd_off = t.oe_off + max(t4_r, t6);\r\nt.cs_rd_off = t.oe_off;\r\nt.rd_cycle = t20 - t.oe_on;\r\nt.we_on = t.adv_on + t3;\r\nif (cpu_is_omap34xx() && (gpmc_cfg->flags & GPMC_MUX_ADD_DATA)) {\r\nt.wr_data_mux_bus = t.we_on;\r\nt.we_off = t.wr_data_mux_bus + t7;\r\n} else\r\nt.we_off = t.we_on + t7;\r\nif (cpu_is_omap34xx())\r\nt.wr_access = t.we_off;\r\nt.adv_wr_off = t.we_off + max(t4_w, t8);\r\nt.cs_wr_off = t.we_off + t4_w;\r\nt.wr_cycle = t20 - t.we_on;\r\nl = GPMC_CONFIG1_DEVICESIZE_16;\r\nif (gpmc_cfg->flags & GPMC_MUX_ADD_DATA)\r\nl |= GPMC_CONFIG1_MUXADDDATA;\r\nif (gpmc_cfg->flags & GPMC_READ_MON)\r\nl |= GPMC_CONFIG1_WAIT_READ_MON;\r\nif (gpmc_cfg->flags & GPMC_WRITE_MON)\r\nl |= GPMC_CONFIG1_WAIT_WRITE_MON;\r\nif (gpmc_cfg->wait_pin)\r\nl |= GPMC_CONFIG1_WAIT_PIN_SEL(gpmc_cfg->wait_pin);\r\ngpmc_cs_write_reg(gpmc_cfg->cs, GPMC_CS_CONFIG1, l);\r\nif (gpmc_cfg->flags & GPMC_MUX_ADD_DATA)\r\nreturn 0;\r\nreturn gpmc_cs_set_timings(gpmc_cfg->cs, &t);\r\n}\r\nvoid __init gpmc_smc91x_init(struct omap_smc91x_platform_data *board_data)\r\n{\r\nunsigned long cs_mem_base;\r\nint ret;\r\ngpmc_cfg = board_data;\r\nif (gpmc_cfg->flags & GPMC_TIMINGS_SMC91C96)\r\ngpmc_cfg->retime = smc91c96_gpmc_retime;\r\nif (gpmc_cs_request(gpmc_cfg->cs, SZ_16M, &cs_mem_base) < 0) {\r\nprintk(KERN_ERR "Failed to request GPMC mem for smc91x\n");\r\nreturn;\r\n}\r\ngpmc_smc91x_resources[0].start = cs_mem_base + 0x300;\r\ngpmc_smc91x_resources[0].end = cs_mem_base + 0x30f;\r\ngpmc_smc91x_resources[1].flags |= (gpmc_cfg->flags & IRQF_TRIGGER_MASK);\r\nif (gpmc_cfg->retime) {\r\nret = gpmc_cfg->retime();\r\nif (ret != 0)\r\ngoto free1;\r\n}\r\nif (gpio_request_one(gpmc_cfg->gpio_irq, GPIOF_IN, "SMC91X irq") < 0)\r\ngoto free1;\r\ngpmc_smc91x_resources[1].start = gpio_to_irq(gpmc_cfg->gpio_irq);\r\nif (gpmc_cfg->gpio_pwrdwn) {\r\nret = gpio_request_one(gpmc_cfg->gpio_pwrdwn,\r\nGPIOF_OUT_INIT_LOW, "SMC91X powerdown");\r\nif (ret)\r\ngoto free2;\r\n}\r\nif (gpmc_cfg->gpio_reset) {\r\nret = gpio_request_one(gpmc_cfg->gpio_reset,\r\nGPIOF_OUT_INIT_LOW, "SMC91X reset");\r\nif (ret)\r\ngoto free3;\r\ngpio_set_value(gpmc_cfg->gpio_reset, 1);\r\nmsleep(100);\r\ngpio_set_value(gpmc_cfg->gpio_reset, 0);\r\n}\r\nif (platform_device_register(&gpmc_smc91x_device) < 0) {\r\nprintk(KERN_ERR "Unable to register smc91x device\n");\r\ngpio_free(gpmc_cfg->gpio_reset);\r\ngoto free3;\r\n}\r\nreturn;\r\nfree3:\r\nif (gpmc_cfg->gpio_pwrdwn)\r\ngpio_free(gpmc_cfg->gpio_pwrdwn);\r\nfree2:\r\ngpio_free(gpmc_cfg->gpio_irq);\r\nfree1:\r\ngpmc_cs_free(gpmc_cfg->cs);\r\nprintk(KERN_ERR "Could not initialize smc91x\n");\r\n}

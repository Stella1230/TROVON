static int ds1553_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct rtc_plat_data *pdata = platform_get_drvdata(pdev);\r\nvoid __iomem *ioaddr = pdata->ioaddr;\r\nu8 century;\r\ncentury = bin2bcd((tm->tm_year + 1900) / 100);\r\nwriteb(RTC_WRITE, pdata->ioaddr + RTC_CONTROL);\r\nwriteb(bin2bcd(tm->tm_year % 100), ioaddr + RTC_YEAR);\r\nwriteb(bin2bcd(tm->tm_mon + 1), ioaddr + RTC_MONTH);\r\nwriteb(bin2bcd(tm->tm_wday) & RTC_DAY_MASK, ioaddr + RTC_DAY);\r\nwriteb(bin2bcd(tm->tm_mday), ioaddr + RTC_DATE);\r\nwriteb(bin2bcd(tm->tm_hour), ioaddr + RTC_HOURS);\r\nwriteb(bin2bcd(tm->tm_min), ioaddr + RTC_MINUTES);\r\nwriteb(bin2bcd(tm->tm_sec) & RTC_SECONDS_MASK, ioaddr + RTC_SECONDS);\r\nwriteb(RTC_WRITE | (century & RTC_CENTURY_MASK), ioaddr + RTC_CENTURY);\r\nwriteb(century & RTC_CENTURY_MASK, ioaddr + RTC_CONTROL);\r\nreturn 0;\r\n}\r\nstatic int ds1553_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct rtc_plat_data *pdata = platform_get_drvdata(pdev);\r\nvoid __iomem *ioaddr = pdata->ioaddr;\r\nunsigned int year, month, day, hour, minute, second, week;\r\nunsigned int century;\r\nif (pdata->last_jiffies == jiffies)\r\nmsleep(1);\r\npdata->last_jiffies = jiffies;\r\nwriteb(RTC_READ, ioaddr + RTC_CONTROL);\r\nsecond = readb(ioaddr + RTC_SECONDS) & RTC_SECONDS_MASK;\r\nminute = readb(ioaddr + RTC_MINUTES);\r\nhour = readb(ioaddr + RTC_HOURS);\r\nday = readb(ioaddr + RTC_DATE);\r\nweek = readb(ioaddr + RTC_DAY) & RTC_DAY_MASK;\r\nmonth = readb(ioaddr + RTC_MONTH);\r\nyear = readb(ioaddr + RTC_YEAR);\r\ncentury = readb(ioaddr + RTC_CENTURY) & RTC_CENTURY_MASK;\r\nwriteb(0, ioaddr + RTC_CONTROL);\r\ntm->tm_sec = bcd2bin(second);\r\ntm->tm_min = bcd2bin(minute);\r\ntm->tm_hour = bcd2bin(hour);\r\ntm->tm_mday = bcd2bin(day);\r\ntm->tm_wday = bcd2bin(week);\r\ntm->tm_mon = bcd2bin(month) - 1;\r\ntm->tm_year = bcd2bin(year) + bcd2bin(century) * 100 - 1900;\r\nif (rtc_valid_tm(tm) < 0) {\r\ndev_err(dev, "retrieved date/time is not valid.\n");\r\nrtc_time_to_tm(0, tm);\r\n}\r\nreturn 0;\r\n}\r\nstatic void ds1553_rtc_update_alarm(struct rtc_plat_data *pdata)\r\n{\r\nvoid __iomem *ioaddr = pdata->ioaddr;\r\nunsigned long flags;\r\nspin_lock_irqsave(&pdata->lock, flags);\r\nwriteb(pdata->alrm_mday < 0 || (pdata->irqen & RTC_UF) ?\r\n0x80 : bin2bcd(pdata->alrm_mday),\r\nioaddr + RTC_DATE_ALARM);\r\nwriteb(pdata->alrm_hour < 0 || (pdata->irqen & RTC_UF) ?\r\n0x80 : bin2bcd(pdata->alrm_hour),\r\nioaddr + RTC_HOURS_ALARM);\r\nwriteb(pdata->alrm_min < 0 || (pdata->irqen & RTC_UF) ?\r\n0x80 : bin2bcd(pdata->alrm_min),\r\nioaddr + RTC_MINUTES_ALARM);\r\nwriteb(pdata->alrm_sec < 0 || (pdata->irqen & RTC_UF) ?\r\n0x80 : bin2bcd(pdata->alrm_sec),\r\nioaddr + RTC_SECONDS_ALARM);\r\nwriteb(pdata->irqen ? RTC_INTS_AE : 0, ioaddr + RTC_INTERRUPTS);\r\nreadb(ioaddr + RTC_FLAGS);\r\nspin_unlock_irqrestore(&pdata->lock, flags);\r\n}\r\nstatic int ds1553_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct rtc_plat_data *pdata = platform_get_drvdata(pdev);\r\nif (pdata->irq <= 0)\r\nreturn -EINVAL;\r\npdata->alrm_mday = alrm->time.tm_mday;\r\npdata->alrm_hour = alrm->time.tm_hour;\r\npdata->alrm_min = alrm->time.tm_min;\r\npdata->alrm_sec = alrm->time.tm_sec;\r\nif (alrm->enabled)\r\npdata->irqen |= RTC_AF;\r\nds1553_rtc_update_alarm(pdata);\r\nreturn 0;\r\n}\r\nstatic int ds1553_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct rtc_plat_data *pdata = platform_get_drvdata(pdev);\r\nif (pdata->irq <= 0)\r\nreturn -EINVAL;\r\nalrm->time.tm_mday = pdata->alrm_mday < 0 ? 0 : pdata->alrm_mday;\r\nalrm->time.tm_hour = pdata->alrm_hour < 0 ? 0 : pdata->alrm_hour;\r\nalrm->time.tm_min = pdata->alrm_min < 0 ? 0 : pdata->alrm_min;\r\nalrm->time.tm_sec = pdata->alrm_sec < 0 ? 0 : pdata->alrm_sec;\r\nalrm->enabled = (pdata->irqen & RTC_AF) ? 1 : 0;\r\nreturn 0;\r\n}\r\nstatic irqreturn_t ds1553_rtc_interrupt(int irq, void *dev_id)\r\n{\r\nstruct platform_device *pdev = dev_id;\r\nstruct rtc_plat_data *pdata = platform_get_drvdata(pdev);\r\nvoid __iomem *ioaddr = pdata->ioaddr;\r\nunsigned long events = 0;\r\nspin_lock(&pdata->lock);\r\nif (readb(ioaddr + RTC_FLAGS) & RTC_FLAGS_AF) {\r\nevents = RTC_IRQF;\r\nif (readb(ioaddr + RTC_SECONDS_ALARM) & 0x80)\r\nevents |= RTC_UF;\r\nelse\r\nevents |= RTC_AF;\r\nif (likely(pdata->rtc))\r\nrtc_update_irq(pdata->rtc, 1, events);\r\n}\r\nspin_unlock(&pdata->lock);\r\nreturn events ? IRQ_HANDLED : IRQ_NONE;\r\n}\r\nstatic int ds1553_rtc_alarm_irq_enable(struct device *dev, unsigned int enabled)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct rtc_plat_data *pdata = platform_get_drvdata(pdev);\r\nif (pdata->irq <= 0)\r\nreturn -EINVAL;\r\nif (enabled)\r\npdata->irqen |= RTC_AF;\r\nelse\r\npdata->irqen &= ~RTC_AF;\r\nds1553_rtc_update_alarm(pdata);\r\nreturn 0;\r\n}\r\nstatic ssize_t ds1553_nvram_read(struct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *bin_attr,\r\nchar *buf, loff_t pos, size_t size)\r\n{\r\nstruct device *dev = container_of(kobj, struct device, kobj);\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct rtc_plat_data *pdata = platform_get_drvdata(pdev);\r\nvoid __iomem *ioaddr = pdata->ioaddr;\r\nssize_t count;\r\nfor (count = 0; size > 0 && pos < RTC_OFFSET; count++, size--)\r\n*buf++ = readb(ioaddr + pos++);\r\nreturn count;\r\n}\r\nstatic ssize_t ds1553_nvram_write(struct file *filp, struct kobject *kobj,\r\nstruct bin_attribute *bin_attr,\r\nchar *buf, loff_t pos, size_t size)\r\n{\r\nstruct device *dev = container_of(kobj, struct device, kobj);\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct rtc_plat_data *pdata = platform_get_drvdata(pdev);\r\nvoid __iomem *ioaddr = pdata->ioaddr;\r\nssize_t count;\r\nfor (count = 0; size > 0 && pos < RTC_OFFSET; count++, size--)\r\nwriteb(*buf++, ioaddr + pos++);\r\nreturn count;\r\n}\r\nstatic int __devinit ds1553_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct rtc_device *rtc;\r\nstruct resource *res;\r\nunsigned int cen, sec;\r\nstruct rtc_plat_data *pdata;\r\nvoid __iomem *ioaddr;\r\nint ret = 0;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENODEV;\r\npdata = devm_kzalloc(&pdev->dev, sizeof(*pdata), GFP_KERNEL);\r\nif (!pdata)\r\nreturn -ENOMEM;\r\nif (!devm_request_mem_region(&pdev->dev, res->start, RTC_REG_SIZE,\r\npdev->name))\r\nreturn -EBUSY;\r\nioaddr = devm_ioremap(&pdev->dev, res->start, RTC_REG_SIZE);\r\nif (!ioaddr)\r\nreturn -ENOMEM;\r\npdata->ioaddr = ioaddr;\r\npdata->irq = platform_get_irq(pdev, 0);\r\nsec = readb(ioaddr + RTC_SECONDS);\r\nif (sec & RTC_STOP) {\r\nsec &= RTC_SECONDS_MASK;\r\ncen = readb(ioaddr + RTC_CENTURY) & RTC_CENTURY_MASK;\r\nwriteb(RTC_WRITE, ioaddr + RTC_CONTROL);\r\nwriteb(sec, ioaddr + RTC_SECONDS);\r\nwriteb(cen & RTC_CENTURY_MASK, ioaddr + RTC_CONTROL);\r\n}\r\nif (readb(ioaddr + RTC_FLAGS) & RTC_FLAGS_BLF)\r\ndev_warn(&pdev->dev, "voltage-low detected.\n");\r\nspin_lock_init(&pdata->lock);\r\npdata->last_jiffies = jiffies;\r\nplatform_set_drvdata(pdev, pdata);\r\nif (pdata->irq > 0) {\r\nwriteb(0, ioaddr + RTC_INTERRUPTS);\r\nif (devm_request_irq(&pdev->dev, pdata->irq,\r\nds1553_rtc_interrupt,\r\nIRQF_DISABLED, pdev->name, pdev) < 0) {\r\ndev_warn(&pdev->dev, "interrupt not available.\n");\r\npdata->irq = 0;\r\n}\r\n}\r\nrtc = rtc_device_register(pdev->name, &pdev->dev,\r\n&ds1553_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc))\r\nreturn PTR_ERR(rtc);\r\npdata->rtc = rtc;\r\nret = sysfs_create_bin_file(&pdev->dev.kobj, &ds1553_nvram_attr);\r\nif (ret)\r\nrtc_device_unregister(rtc);\r\nreturn ret;\r\n}\r\nstatic int __devexit ds1553_rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct rtc_plat_data *pdata = platform_get_drvdata(pdev);\r\nsysfs_remove_bin_file(&pdev->dev.kobj, &ds1553_nvram_attr);\r\nrtc_device_unregister(pdata->rtc);\r\nif (pdata->irq > 0)\r\nwriteb(0, pdata->ioaddr + RTC_INTERRUPTS);\r\nreturn 0;\r\n}\r\nstatic __init int ds1553_init(void)\r\n{\r\nreturn platform_driver_register(&ds1553_rtc_driver);\r\n}\r\nstatic __exit void ds1553_exit(void)\r\n{\r\nplatform_driver_unregister(&ds1553_rtc_driver);\r\n}

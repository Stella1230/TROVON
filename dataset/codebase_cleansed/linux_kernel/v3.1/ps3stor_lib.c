static int ps3stor_open_hv_device(struct ps3_system_bus_device *sbd)\r\n{\r\nint error = ps3_open_hv_device(sbd);\r\nif (error)\r\nreturn error;\r\nif (sbd->match_id == PS3_MATCH_ID_STOR_FLASH)\r\nps3_flash_workaround.flash_open = 1;\r\nif (sbd->match_id == PS3_MATCH_ID_STOR_DISK)\r\nps3_flash_workaround.disk_open = 1;\r\nreturn 0;\r\n}\r\nstatic int ps3stor_close_hv_device(struct ps3_system_bus_device *sbd)\r\n{\r\nint error;\r\nif (sbd->match_id == PS3_MATCH_ID_STOR_DISK\r\n&& ps3_flash_workaround.disk_open\r\n&& ps3_flash_workaround.flash_open) {\r\nps3_flash_workaround.disk_sbd = sbd;\r\nreturn 0;\r\n}\r\nerror = ps3_close_hv_device(sbd);\r\nif (error)\r\nreturn error;\r\nif (sbd->match_id == PS3_MATCH_ID_STOR_DISK)\r\nps3_flash_workaround.disk_open = 0;\r\nif (sbd->match_id == PS3_MATCH_ID_STOR_FLASH) {\r\nps3_flash_workaround.flash_open = 0;\r\nif (ps3_flash_workaround.disk_sbd) {\r\nps3_close_hv_device(ps3_flash_workaround.disk_sbd);\r\nps3_flash_workaround.disk_open = 0;\r\nps3_flash_workaround.disk_sbd = NULL;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int ps3stor_probe_access(struct ps3_storage_device *dev)\r\n{\r\nint res, error;\r\nunsigned int i;\r\nunsigned long n;\r\nif (dev->sbd.match_id == PS3_MATCH_ID_STOR_ROM) {\r\ndev->accessible_regions = 1;\r\nreturn 0;\r\n}\r\nerror = -EPERM;\r\nfor (i = 0; i < dev->num_regions; i++) {\r\ndev_dbg(&dev->sbd.core,\r\n"%s:%u: checking accessibility of region %u\n",\r\n__func__, __LINE__, i);\r\ndev->region_idx = i;\r\nres = ps3stor_read_write_sectors(dev, dev->bounce_lpar, 0, 1,\r\n0);\r\nif (res) {\r\ndev_dbg(&dev->sbd.core, "%s:%u: read failed, "\r\n"region %u is not accessible\n", __func__,\r\n__LINE__, i);\r\ncontinue;\r\n}\r\ndev_dbg(&dev->sbd.core, "%s:%u: region %u is accessible\n",\r\n__func__, __LINE__, i);\r\nset_bit(i, &dev->accessible_regions);\r\nerror = 0;\r\n}\r\nif (error)\r\nreturn error;\r\nn = hweight_long(dev->accessible_regions);\r\nif (n > 1)\r\ndev_info(&dev->sbd.core,\r\n"%s:%u: %lu accessible regions found. Only the first "\r\n"one will be used\n",\r\n__func__, __LINE__, n);\r\ndev->region_idx = __ffs(dev->accessible_regions);\r\ndev_info(&dev->sbd.core,\r\n"First accessible region has index %u start %llu size %llu\n",\r\ndev->region_idx, dev->regions[dev->region_idx].start,\r\ndev->regions[dev->region_idx].size);\r\nreturn 0;\r\n}\r\nint ps3stor_setup(struct ps3_storage_device *dev, irq_handler_t handler)\r\n{\r\nint error, res, alignment;\r\nenum ps3_dma_page_size page_size;\r\nerror = ps3stor_open_hv_device(&dev->sbd);\r\nif (error) {\r\ndev_err(&dev->sbd.core,\r\n"%s:%u: ps3_open_hv_device failed %d\n", __func__,\r\n__LINE__, error);\r\ngoto fail;\r\n}\r\nerror = ps3_sb_event_receive_port_setup(&dev->sbd, PS3_BINDING_CPU_ANY,\r\n&dev->irq);\r\nif (error) {\r\ndev_err(&dev->sbd.core,\r\n"%s:%u: ps3_sb_event_receive_port_setup failed %d\n",\r\n__func__, __LINE__, error);\r\ngoto fail_close_device;\r\n}\r\nerror = request_irq(dev->irq, handler, IRQF_DISABLED,\r\ndev->sbd.core.driver->name, dev);\r\nif (error) {\r\ndev_err(&dev->sbd.core, "%s:%u: request_irq failed %d\n",\r\n__func__, __LINE__, error);\r\ngoto fail_sb_event_receive_port_destroy;\r\n}\r\nalignment = min(__ffs(dev->bounce_size),\r\n__ffs((unsigned long)dev->bounce_buf));\r\nif (alignment < 12) {\r\ndev_err(&dev->sbd.core,\r\n"%s:%u: bounce buffer not aligned (%lx at 0x%p)\n",\r\n__func__, __LINE__, dev->bounce_size, dev->bounce_buf);\r\nerror = -EINVAL;\r\ngoto fail_free_irq;\r\n} else if (alignment < 16)\r\npage_size = PS3_DMA_4K;\r\nelse\r\npage_size = PS3_DMA_64K;\r\ndev->sbd.d_region = &dev->dma_region;\r\nps3_dma_region_init(&dev->sbd, &dev->dma_region, page_size,\r\nPS3_DMA_OTHER, dev->bounce_buf, dev->bounce_size);\r\nres = ps3_dma_region_create(&dev->dma_region);\r\nif (res) {\r\ndev_err(&dev->sbd.core, "%s:%u: cannot create DMA region\n",\r\n__func__, __LINE__);\r\nerror = -ENOMEM;\r\ngoto fail_free_irq;\r\n}\r\ndev->bounce_lpar = ps3_mm_phys_to_lpar(__pa(dev->bounce_buf));\r\ndev->bounce_dma = dma_map_single(&dev->sbd.core, dev->bounce_buf,\r\ndev->bounce_size, DMA_BIDIRECTIONAL);\r\nif (!dev->bounce_dma) {\r\ndev_err(&dev->sbd.core, "%s:%u: map DMA region failed\n",\r\n__func__, __LINE__);\r\nerror = -ENODEV;\r\ngoto fail_free_dma;\r\n}\r\nerror = ps3stor_probe_access(dev);\r\nif (error) {\r\ndev_err(&dev->sbd.core, "%s:%u: No accessible regions found\n",\r\n__func__, __LINE__);\r\ngoto fail_unmap_dma;\r\n}\r\nreturn 0;\r\nfail_unmap_dma:\r\ndma_unmap_single(&dev->sbd.core, dev->bounce_dma, dev->bounce_size,\r\nDMA_BIDIRECTIONAL);\r\nfail_free_dma:\r\nps3_dma_region_free(&dev->dma_region);\r\nfail_free_irq:\r\nfree_irq(dev->irq, dev);\r\nfail_sb_event_receive_port_destroy:\r\nps3_sb_event_receive_port_destroy(&dev->sbd, dev->irq);\r\nfail_close_device:\r\nps3stor_close_hv_device(&dev->sbd);\r\nfail:\r\nreturn error;\r\n}\r\nvoid ps3stor_teardown(struct ps3_storage_device *dev)\r\n{\r\nint error;\r\ndma_unmap_single(&dev->sbd.core, dev->bounce_dma, dev->bounce_size,\r\nDMA_BIDIRECTIONAL);\r\nps3_dma_region_free(&dev->dma_region);\r\nfree_irq(dev->irq, dev);\r\nerror = ps3_sb_event_receive_port_destroy(&dev->sbd, dev->irq);\r\nif (error)\r\ndev_err(&dev->sbd.core,\r\n"%s:%u: destroy event receive port failed %d\n",\r\n__func__, __LINE__, error);\r\nerror = ps3stor_close_hv_device(&dev->sbd);\r\nif (error)\r\ndev_err(&dev->sbd.core,\r\n"%s:%u: ps3_close_hv_device failed %d\n", __func__,\r\n__LINE__, error);\r\n}\r\nu64 ps3stor_read_write_sectors(struct ps3_storage_device *dev, u64 lpar,\r\nu64 start_sector, u64 sectors, int write)\r\n{\r\nunsigned int region_id = dev->regions[dev->region_idx].id;\r\nconst char *op = write ? "write" : "read";\r\nint res;\r\ndev_dbg(&dev->sbd.core, "%s:%u: %s %llu sectors starting at %llu\n",\r\n__func__, __LINE__, op, sectors, start_sector);\r\ninit_completion(&dev->done);\r\nres = write ? lv1_storage_write(dev->sbd.dev_id, region_id,\r\nstart_sector, sectors, 0, lpar,\r\n&dev->tag)\r\n: lv1_storage_read(dev->sbd.dev_id, region_id,\r\nstart_sector, sectors, 0, lpar,\r\n&dev->tag);\r\nif (res) {\r\ndev_dbg(&dev->sbd.core, "%s:%u: %s failed %d\n", __func__,\r\n__LINE__, op, res);\r\nreturn -1;\r\n}\r\nwait_for_completion(&dev->done);\r\nif (dev->lv1_status) {\r\ndev_dbg(&dev->sbd.core, "%s:%u: %s failed 0x%llx\n", __func__,\r\n__LINE__, op, dev->lv1_status);\r\nreturn dev->lv1_status;\r\n}\r\ndev_dbg(&dev->sbd.core, "%s:%u: %s completed\n", __func__, __LINE__,\r\nop);\r\nreturn 0;\r\n}\r\nu64 ps3stor_send_command(struct ps3_storage_device *dev, u64 cmd, u64 arg1,\r\nu64 arg2, u64 arg3, u64 arg4)\r\n{\r\nint res;\r\ndev_dbg(&dev->sbd.core, "%s:%u: send device command 0x%llx\n", __func__,\r\n__LINE__, cmd);\r\ninit_completion(&dev->done);\r\nres = lv1_storage_send_device_command(dev->sbd.dev_id, cmd, arg1,\r\narg2, arg3, arg4, &dev->tag);\r\nif (res) {\r\ndev_err(&dev->sbd.core,\r\n"%s:%u: send_device_command 0x%llx failed %d\n",\r\n__func__, __LINE__, cmd, res);\r\nreturn -1;\r\n}\r\nwait_for_completion(&dev->done);\r\nif (dev->lv1_status) {\r\ndev_dbg(&dev->sbd.core, "%s:%u: command 0x%llx failed 0x%llx\n",\r\n__func__, __LINE__, cmd, dev->lv1_status);\r\nreturn dev->lv1_status;\r\n}\r\ndev_dbg(&dev->sbd.core, "%s:%u: command 0x%llx completed\n", __func__,\r\n__LINE__, cmd);\r\nreturn 0;\r\n}

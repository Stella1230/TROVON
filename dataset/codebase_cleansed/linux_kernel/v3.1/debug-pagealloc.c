static inline void set_page_poison(struct page *page)\r\n{\r\n__set_bit(PAGE_DEBUG_FLAG_POISON, &page->debug_flags);\r\n}\r\nstatic inline void clear_page_poison(struct page *page)\r\n{\r\n__clear_bit(PAGE_DEBUG_FLAG_POISON, &page->debug_flags);\r\n}\r\nstatic inline bool page_poison(struct page *page)\r\n{\r\nreturn test_bit(PAGE_DEBUG_FLAG_POISON, &page->debug_flags);\r\n}\r\nstatic void poison_highpage(struct page *page)\r\n{\r\n}\r\nstatic void poison_page(struct page *page)\r\n{\r\nvoid *addr;\r\nif (PageHighMem(page)) {\r\npoison_highpage(page);\r\nreturn;\r\n}\r\nset_page_poison(page);\r\naddr = page_address(page);\r\nmemset(addr, PAGE_POISON, PAGE_SIZE);\r\n}\r\nstatic void poison_pages(struct page *page, int n)\r\n{\r\nint i;\r\nfor (i = 0; i < n; i++)\r\npoison_page(page + i);\r\n}\r\nstatic bool single_bit_flip(unsigned char a, unsigned char b)\r\n{\r\nunsigned char error = a ^ b;\r\nreturn error && !(error & (error - 1));\r\n}\r\nstatic void check_poison_mem(unsigned char *mem, size_t bytes)\r\n{\r\nunsigned char *start;\r\nunsigned char *end;\r\nfor (start = mem; start < mem + bytes; start++) {\r\nif (*start != PAGE_POISON)\r\nbreak;\r\n}\r\nif (start == mem + bytes)\r\nreturn;\r\nfor (end = mem + bytes - 1; end > start; end--) {\r\nif (*end != PAGE_POISON)\r\nbreak;\r\n}\r\nif (!printk_ratelimit())\r\nreturn;\r\nelse if (start == end && single_bit_flip(*start, PAGE_POISON))\r\nprintk(KERN_ERR "pagealloc: single bit error\n");\r\nelse\r\nprintk(KERN_ERR "pagealloc: memory corruption\n");\r\nprint_hex_dump(KERN_ERR, "", DUMP_PREFIX_ADDRESS, 16, 1, start,\r\nend - start + 1, 1);\r\ndump_stack();\r\n}\r\nstatic void unpoison_highpage(struct page *page)\r\n{\r\nBUG_ON(page_poison(page));\r\n}\r\nstatic void unpoison_page(struct page *page)\r\n{\r\nif (PageHighMem(page)) {\r\nunpoison_highpage(page);\r\nreturn;\r\n}\r\nif (page_poison(page)) {\r\nvoid *addr = page_address(page);\r\ncheck_poison_mem(addr, PAGE_SIZE);\r\nclear_page_poison(page);\r\n}\r\n}\r\nstatic void unpoison_pages(struct page *page, int n)\r\n{\r\nint i;\r\nfor (i = 0; i < n; i++)\r\nunpoison_page(page + i);\r\n}\r\nvoid kernel_map_pages(struct page *page, int numpages, int enable)\r\n{\r\nif (!debug_pagealloc_enabled)\r\nreturn;\r\nif (enable)\r\nunpoison_pages(page, numpages);\r\nelse\r\npoison_pages(page, numpages);\r\n}

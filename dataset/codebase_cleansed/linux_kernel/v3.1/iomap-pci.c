static void __iomem *ioport_map_pci(struct pci_dev *dev,\r\nunsigned long port, unsigned int nr)\r\n{\r\nstruct pci_controller *ctrl = dev->bus->sysdata;\r\nunsigned long base = ctrl->io_map_base;\r\nif (unlikely(!ctrl->io_map_base)) {\r\nstruct pci_bus *bus = dev->bus;\r\nchar name[8];\r\nwhile (bus->parent)\r\nbus = bus->parent;\r\nctrl->io_map_base = base = mips_io_port_base;\r\nsprintf(name, "%04x:%02x", pci_domain_nr(bus), bus->number);\r\nprintk(KERN_WARNING "io_map_base of root PCI bus %s unset. "\r\n"Trying to continue but you better\nfix this issue or "\r\n"report it to linux-mips@linux-mips.org or your "\r\n"vendor.\n", name);\r\n#ifdef CONFIG_PCI_DOMAINS\r\npanic("To avoid data corruption io_map_base MUST be set with "\r\n"multiple PCI domains.");\r\n#endif\r\n}\r\nreturn (void __iomem *) (ctrl->io_map_base + port);\r\n}\r\nvoid __iomem *pci_iomap(struct pci_dev *dev, int bar, unsigned long maxlen)\r\n{\r\nresource_size_t start = pci_resource_start(dev, bar);\r\nresource_size_t len = pci_resource_len(dev, bar);\r\nunsigned long flags = pci_resource_flags(dev, bar);\r\nif (!len || !start)\r\nreturn NULL;\r\nif (maxlen && len > maxlen)\r\nlen = maxlen;\r\nif (flags & IORESOURCE_IO)\r\nreturn ioport_map_pci(dev, start, len);\r\nif (flags & IORESOURCE_MEM) {\r\nif (flags & IORESOURCE_CACHEABLE)\r\nreturn ioremap(start, len);\r\nreturn ioremap_nocache(start, len);\r\n}\r\nreturn NULL;\r\n}\r\nvoid pci_iounmap(struct pci_dev *dev, void __iomem * addr)\r\n{\r\niounmap(addr);\r\n}

void *dma_alloc_coherent(struct device *dev, size_t size,\r\ndma_addr_t *handle, gfp_t flag)\r\n{\r\nstruct page *page, **map;\r\npgprot_t pgprot;\r\nvoid *addr;\r\nint i, order;\r\npr_debug("dma_alloc_coherent: %d,%x\n", size, flag);\r\nsize = PAGE_ALIGN(size);\r\norder = get_order(size);\r\npage = alloc_pages(flag, order);\r\nif (!page)\r\nreturn NULL;\r\n*handle = page_to_phys(page);\r\nmap = kmalloc(sizeof(struct page *) << order, flag & ~__GFP_DMA);\r\nif (!map) {\r\n__free_pages(page, order);\r\nreturn NULL;\r\n}\r\nsplit_page(page, order);\r\norder = 1 << order;\r\nsize >>= PAGE_SHIFT;\r\nmap[0] = page;\r\nfor (i = 1; i < size; i++)\r\nmap[i] = page + i;\r\nfor (; i < order; i++)\r\n__free_page(page + i);\r\npgprot = __pgprot(_PAGE_PRESENT | _PAGE_ACCESSED | _PAGE_DIRTY);\r\nif (CPU_IS_040_OR_060)\r\npgprot_val(pgprot) |= _PAGE_GLOBAL040 | _PAGE_NOCACHE_S;\r\nelse\r\npgprot_val(pgprot) |= _PAGE_NOCACHE030;\r\naddr = vmap(map, size, VM_MAP, pgprot);\r\nkfree(map);\r\nreturn addr;\r\n}\r\nvoid dma_free_coherent(struct device *dev, size_t size,\r\nvoid *addr, dma_addr_t handle)\r\n{\r\npr_debug("dma_free_coherent: %p, %x\n", addr, handle);\r\nvfree(addr);\r\n}\r\nvoid dma_sync_single_for_device(struct device *dev, dma_addr_t handle,\r\nsize_t size, enum dma_data_direction dir)\r\n{\r\nswitch (dir) {\r\ncase DMA_TO_DEVICE:\r\ncache_push(handle, size);\r\nbreak;\r\ncase DMA_FROM_DEVICE:\r\ncache_clear(handle, size);\r\nbreak;\r\ndefault:\r\nif (printk_ratelimit())\r\nprintk("dma_sync_single_for_device: unsupported dir %u\n", dir);\r\nbreak;\r\n}\r\n}\r\nvoid dma_sync_sg_for_device(struct device *dev, struct scatterlist *sg, int nents,\r\nenum dma_data_direction dir)\r\n{\r\nint i;\r\nfor (i = 0; i < nents; sg++, i++)\r\ndma_sync_single_for_device(dev, sg->dma_address, sg->length, dir);\r\n}\r\ndma_addr_t dma_map_single(struct device *dev, void *addr, size_t size,\r\nenum dma_data_direction dir)\r\n{\r\ndma_addr_t handle = virt_to_bus(addr);\r\ndma_sync_single_for_device(dev, handle, size, dir);\r\nreturn handle;\r\n}\r\ndma_addr_t dma_map_page(struct device *dev, struct page *page,\r\nunsigned long offset, size_t size,\r\nenum dma_data_direction dir)\r\n{\r\ndma_addr_t handle = page_to_phys(page) + offset;\r\ndma_sync_single_for_device(dev, handle, size, dir);\r\nreturn handle;\r\n}\r\nint dma_map_sg(struct device *dev, struct scatterlist *sg, int nents,\r\nenum dma_data_direction dir)\r\n{\r\nint i;\r\nfor (i = 0; i < nents; sg++, i++) {\r\nsg->dma_address = sg_phys(sg);\r\ndma_sync_single_for_device(dev, sg->dma_address, sg->length, dir);\r\n}\r\nreturn nents;\r\n}

static int filter(const struct dirent *dir)\r\n{\r\nif (dir->d_name[0] == '.')\r\nreturn 0;\r\nelse\r\nreturn 1;\r\n}\r\nstruct thread_map *thread_map__new_by_pid(pid_t pid)\r\n{\r\nstruct thread_map *threads;\r\nchar name[256];\r\nint items;\r\nstruct dirent **namelist = NULL;\r\nint i;\r\nsprintf(name, "/proc/%d/task", pid);\r\nitems = scandir(name, &namelist, filter, NULL);\r\nif (items <= 0)\r\nreturn NULL;\r\nthreads = malloc(sizeof(*threads) + sizeof(pid_t) * items);\r\nif (threads != NULL) {\r\nfor (i = 0; i < items; i++)\r\nthreads->map[i] = atoi(namelist[i]->d_name);\r\nthreads->nr = items;\r\n}\r\nfor (i=0; i<items; i++)\r\nfree(namelist[i]);\r\nfree(namelist);\r\nreturn threads;\r\n}\r\nstruct thread_map *thread_map__new_by_tid(pid_t tid)\r\n{\r\nstruct thread_map *threads = malloc(sizeof(*threads) + sizeof(pid_t));\r\nif (threads != NULL) {\r\nthreads->map[0] = tid;\r\nthreads->nr = 1;\r\n}\r\nreturn threads;\r\n}\r\nstruct thread_map *thread_map__new(pid_t pid, pid_t tid)\r\n{\r\nif (pid != -1)\r\nreturn thread_map__new_by_pid(pid);\r\nreturn thread_map__new_by_tid(tid);\r\n}\r\nvoid thread_map__delete(struct thread_map *threads)\r\n{\r\nfree(threads);\r\n}

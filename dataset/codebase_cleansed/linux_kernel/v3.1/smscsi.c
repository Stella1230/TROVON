int SM_SCSIIrp(struct us_data *us, struct scsi_cmnd *srb)\r\n{\r\nint result;\r\nus->SrbStatus = SS_SUCCESS;\r\nswitch (srb->cmnd[0])\r\n{\r\ncase TEST_UNIT_READY : result = SM_SCSI_Test_Unit_Ready (us, srb); break;\r\ncase INQUIRY : result = SM_SCSI_Inquiry (us, srb); break;\r\ncase MODE_SENSE : result = SM_SCSI_Mode_Sense (us, srb); break;\r\ncase READ_CAPACITY : result = SM_SCSI_Read_Capacity (us, srb); break;\r\ncase READ_10 : result = SM_SCSI_Read (us, srb); break;\r\ncase WRITE_10 : result = SM_SCSI_Write (us, srb); break;\r\ndefault:\r\nus->SrbStatus = SS_ILLEGAL_REQUEST;\r\nresult = USB_STOR_TRANSPORT_FAILED;\r\nbreak;\r\n}\r\nreturn result;\r\n}\r\nint SM_SCSI_Test_Unit_Ready(struct us_data *us, struct scsi_cmnd *srb)\r\n{\r\nif (us->SM_Status.Insert && us->SM_Status.Ready)\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\nelse\r\n{\r\nENE_SMInit(us);\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}\r\nint SM_SCSI_Inquiry(struct us_data *us, struct scsi_cmnd *srb)\r\n{\r\nBYTE data_ptr[36] = {0x00, 0x80, 0x02, 0x00, 0x1F, 0x00, 0x00, 0x00, 0x55, 0x53, 0x42, 0x32, 0x2E, 0x30, 0x20, 0x20, 0x43, 0x61, 0x72, 0x64, 0x52, 0x65, 0x61, 0x64, 0x65, 0x72, 0x20, 0x20, 0x20, 0x20, 0x20, 0x20, 0x30, 0x31, 0x30, 0x30};\r\nusb_stor_set_xfer_buf(us, data_ptr, 36, srb, TO_XFER_BUF);\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}\r\nint SM_SCSI_Mode_Sense(struct us_data *us, struct scsi_cmnd *srb)\r\n{\r\nBYTE mediaNoWP[12] = {0x0b,0x00,0x00,0x08,0x00,0x00,0x71,0xc0,0x00,0x00,0x02,0x00};\r\nBYTE mediaWP[12] = {0x0b,0x00,0x80,0x08,0x00,0x00,0x71,0xc0,0x00,0x00,0x02,0x00};\r\nif (us->SM_Status.WtP)\r\nusb_stor_set_xfer_buf(us, mediaWP, 12, srb, TO_XFER_BUF);\r\nelse\r\nusb_stor_set_xfer_buf(us, mediaNoWP, 12, srb, TO_XFER_BUF);\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}\r\nint SM_SCSI_Read_Capacity(struct us_data *us, struct scsi_cmnd *srb)\r\n{\r\nunsigned int offset = 0;\r\nstruct scatterlist *sg = NULL;\r\nDWORD bl_num;\r\nWORD bl_len;\r\nBYTE buf[8];\r\nprintk("SM_SCSI_Read_Capacity\n");\r\nbl_len = 0x200;\r\nbl_num = Ssfdc.MaxLogBlocks * Ssfdc.MaxSectors * Ssfdc.MaxZones - 1;\r\nus->bl_num = bl_num;\r\nprintk("bl_len = %x\n", bl_len);\r\nprintk("bl_num = %x\n", bl_num);\r\nbuf[0] = (bl_num>>24) & 0xff;\r\nbuf[1] = (bl_num>>16) & 0xff;\r\nbuf[2] = (bl_num>> 8) & 0xff;\r\nbuf[3] = (bl_num>> 0) & 0xff;\r\nbuf[4] = (bl_len>>24) & 0xff;\r\nbuf[5] = (bl_len>>16) & 0xff;\r\nbuf[6] = (bl_len>> 8) & 0xff;\r\nbuf[7] = (bl_len>> 0) & 0xff;\r\nusb_stor_access_xfer_buf(us, buf, 8, srb, &sg, &offset, TO_XFER_BUF);\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}\r\nint SM_SCSI_Read(struct us_data *us, struct scsi_cmnd *srb)\r\n{\r\nint result=0;\r\nPBYTE Cdb = srb->cmnd;\r\nDWORD bn = ((Cdb[2]<<24) & 0xff000000) | ((Cdb[3]<<16) & 0x00ff0000) |\r\n((Cdb[4]<< 8) & 0x0000ff00) | ((Cdb[5]<< 0) & 0x000000ff);\r\nWORD blen = ((Cdb[7]<< 8) & 0xff00) | ((Cdb[8]<< 0) & 0x00ff);\r\nDWORD blenByte = blen * 0x200;\r\nvoid *buf;\r\nif (bn > us->bl_num)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nbuf = kmalloc(blenByte, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nresult = Media_D_ReadSector(us, bn, blen, buf);\r\nusb_stor_set_xfer_buf(us, buf, blenByte, srb, TO_XFER_BUF);\r\nkfree(buf);\r\nif (!result)\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\nelse\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}\r\nint SM_SCSI_Write(struct us_data *us, struct scsi_cmnd *srb)\r\n{\r\nint result=0;\r\nPBYTE Cdb = srb->cmnd;\r\nDWORD bn = ((Cdb[2]<<24) & 0xff000000) | ((Cdb[3]<<16) & 0x00ff0000) |\r\n((Cdb[4]<< 8) & 0x0000ff00) | ((Cdb[5]<< 0) & 0x000000ff);\r\nWORD blen = ((Cdb[7]<< 8) & 0xff00) | ((Cdb[8]<< 0) & 0x00ff);\r\nDWORD blenByte = blen * 0x200;\r\nvoid *buf;\r\nif (bn > us->bl_num)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nbuf = kmalloc(blenByte, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nusb_stor_set_xfer_buf(us, buf, blenByte, srb, FROM_XFER_BUF);\r\nresult = Media_D_CopySector(us, bn, blen, buf);\r\nkfree(buf);\r\nif (!result)\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\nelse\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}

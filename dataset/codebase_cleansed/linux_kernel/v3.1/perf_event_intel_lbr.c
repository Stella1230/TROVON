static void __intel_pmu_lbr_enable(void)\r\n{\r\nu64 debugctl;\r\nrdmsrl(MSR_IA32_DEBUGCTLMSR, debugctl);\r\ndebugctl |= (DEBUGCTLMSR_LBR | DEBUGCTLMSR_FREEZE_LBRS_ON_PMI);\r\nwrmsrl(MSR_IA32_DEBUGCTLMSR, debugctl);\r\n}\r\nstatic void __intel_pmu_lbr_disable(void)\r\n{\r\nu64 debugctl;\r\nrdmsrl(MSR_IA32_DEBUGCTLMSR, debugctl);\r\ndebugctl &= ~(DEBUGCTLMSR_LBR | DEBUGCTLMSR_FREEZE_LBRS_ON_PMI);\r\nwrmsrl(MSR_IA32_DEBUGCTLMSR, debugctl);\r\n}\r\nstatic void intel_pmu_lbr_reset_32(void)\r\n{\r\nint i;\r\nfor (i = 0; i < x86_pmu.lbr_nr; i++)\r\nwrmsrl(x86_pmu.lbr_from + i, 0);\r\n}\r\nstatic void intel_pmu_lbr_reset_64(void)\r\n{\r\nint i;\r\nfor (i = 0; i < x86_pmu.lbr_nr; i++) {\r\nwrmsrl(x86_pmu.lbr_from + i, 0);\r\nwrmsrl(x86_pmu.lbr_to + i, 0);\r\n}\r\n}\r\nstatic void intel_pmu_lbr_reset(void)\r\n{\r\nif (!x86_pmu.lbr_nr)\r\nreturn;\r\nif (x86_pmu.intel_cap.lbr_format == LBR_FORMAT_32)\r\nintel_pmu_lbr_reset_32();\r\nelse\r\nintel_pmu_lbr_reset_64();\r\n}\r\nstatic void intel_pmu_lbr_enable(struct perf_event *event)\r\n{\r\nstruct cpu_hw_events *cpuc = &__get_cpu_var(cpu_hw_events);\r\nif (!x86_pmu.lbr_nr)\r\nreturn;\r\nWARN_ON_ONCE(cpuc->enabled);\r\nif (event->ctx->task && cpuc->lbr_context != event->ctx) {\r\nintel_pmu_lbr_reset();\r\ncpuc->lbr_context = event->ctx;\r\n}\r\ncpuc->lbr_users++;\r\n}\r\nstatic void intel_pmu_lbr_disable(struct perf_event *event)\r\n{\r\nstruct cpu_hw_events *cpuc = &__get_cpu_var(cpu_hw_events);\r\nif (!x86_pmu.lbr_nr)\r\nreturn;\r\ncpuc->lbr_users--;\r\nWARN_ON_ONCE(cpuc->lbr_users < 0);\r\nif (cpuc->enabled && !cpuc->lbr_users)\r\n__intel_pmu_lbr_disable();\r\n}\r\nstatic void intel_pmu_lbr_enable_all(void)\r\n{\r\nstruct cpu_hw_events *cpuc = &__get_cpu_var(cpu_hw_events);\r\nif (cpuc->lbr_users)\r\n__intel_pmu_lbr_enable();\r\n}\r\nstatic void intel_pmu_lbr_disable_all(void)\r\n{\r\nstruct cpu_hw_events *cpuc = &__get_cpu_var(cpu_hw_events);\r\nif (cpuc->lbr_users)\r\n__intel_pmu_lbr_disable();\r\n}\r\nstatic inline u64 intel_pmu_lbr_tos(void)\r\n{\r\nu64 tos;\r\nrdmsrl(x86_pmu.lbr_tos, tos);\r\nreturn tos;\r\n}\r\nstatic void intel_pmu_lbr_read_32(struct cpu_hw_events *cpuc)\r\n{\r\nunsigned long mask = x86_pmu.lbr_nr - 1;\r\nu64 tos = intel_pmu_lbr_tos();\r\nint i;\r\nfor (i = 0; i < x86_pmu.lbr_nr; i++) {\r\nunsigned long lbr_idx = (tos - i) & mask;\r\nunion {\r\nstruct {\r\nu32 from;\r\nu32 to;\r\n};\r\nu64 lbr;\r\n} msr_lastbranch;\r\nrdmsrl(x86_pmu.lbr_from + lbr_idx, msr_lastbranch.lbr);\r\ncpuc->lbr_entries[i].from = msr_lastbranch.from;\r\ncpuc->lbr_entries[i].to = msr_lastbranch.to;\r\ncpuc->lbr_entries[i].flags = 0;\r\n}\r\ncpuc->lbr_stack.nr = i;\r\n}\r\nstatic void intel_pmu_lbr_read_64(struct cpu_hw_events *cpuc)\r\n{\r\nunsigned long mask = x86_pmu.lbr_nr - 1;\r\nint lbr_format = x86_pmu.intel_cap.lbr_format;\r\nu64 tos = intel_pmu_lbr_tos();\r\nint i;\r\nfor (i = 0; i < x86_pmu.lbr_nr; i++) {\r\nunsigned long lbr_idx = (tos - i) & mask;\r\nu64 from, to, flags = 0;\r\nrdmsrl(x86_pmu.lbr_from + lbr_idx, from);\r\nrdmsrl(x86_pmu.lbr_to + lbr_idx, to);\r\nif (lbr_format == LBR_FORMAT_EIP_FLAGS) {\r\nflags = !!(from & LBR_FROM_FLAG_MISPRED);\r\nfrom = (u64)((((s64)from) << 1) >> 1);\r\n}\r\ncpuc->lbr_entries[i].from = from;\r\ncpuc->lbr_entries[i].to = to;\r\ncpuc->lbr_entries[i].flags = flags;\r\n}\r\ncpuc->lbr_stack.nr = i;\r\n}\r\nstatic void intel_pmu_lbr_read(void)\r\n{\r\nstruct cpu_hw_events *cpuc = &__get_cpu_var(cpu_hw_events);\r\nif (!cpuc->lbr_users)\r\nreturn;\r\nif (x86_pmu.intel_cap.lbr_format == LBR_FORMAT_32)\r\nintel_pmu_lbr_read_32(cpuc);\r\nelse\r\nintel_pmu_lbr_read_64(cpuc);\r\n}\r\nstatic void intel_pmu_lbr_init_core(void)\r\n{\r\nx86_pmu.lbr_nr = 4;\r\nx86_pmu.lbr_tos = 0x01c9;\r\nx86_pmu.lbr_from = 0x40;\r\nx86_pmu.lbr_to = 0x60;\r\n}\r\nstatic void intel_pmu_lbr_init_nhm(void)\r\n{\r\nx86_pmu.lbr_nr = 16;\r\nx86_pmu.lbr_tos = 0x01c9;\r\nx86_pmu.lbr_from = 0x680;\r\nx86_pmu.lbr_to = 0x6c0;\r\n}\r\nstatic void intel_pmu_lbr_init_atom(void)\r\n{\r\nx86_pmu.lbr_nr = 8;\r\nx86_pmu.lbr_tos = 0x01c9;\r\nx86_pmu.lbr_from = 0x40;\r\nx86_pmu.lbr_to = 0x60;\r\n}

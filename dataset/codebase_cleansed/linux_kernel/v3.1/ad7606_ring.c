int ad7606_scan_from_ring(struct iio_dev *indio_dev, unsigned ch)\r\n{\r\nstruct iio_ring_buffer *ring = indio_dev->ring;\r\nint ret;\r\nu16 *ring_data;\r\nring_data = kmalloc(ring->access->get_bytes_per_datum(ring),\r\nGFP_KERNEL);\r\nif (ring_data == NULL) {\r\nret = -ENOMEM;\r\ngoto error_ret;\r\n}\r\nret = ring->access->read_last(ring, (u8 *) ring_data);\r\nif (ret)\r\ngoto error_free_ring_data;\r\nret = ring_data[ch];\r\nerror_free_ring_data:\r\nkfree(ring_data);\r\nerror_ret:\r\nreturn ret;\r\n}\r\nstatic int ad7606_ring_preenable(struct iio_dev *indio_dev)\r\n{\r\nstruct ad7606_state *st = iio_priv(indio_dev);\r\nstruct iio_ring_buffer *ring = indio_dev->ring;\r\nsize_t d_size;\r\nd_size = st->chip_info->num_channels *\r\nst->chip_info->channels[0].scan_type.storagebits / 8;\r\nif (ring->scan_timestamp) {\r\nd_size += sizeof(s64);\r\nif (d_size % sizeof(s64))\r\nd_size += sizeof(s64) - (d_size % sizeof(s64));\r\n}\r\nif (ring->access->set_bytes_per_datum)\r\nring->access->set_bytes_per_datum(ring, d_size);\r\nst->d_size = d_size;\r\nreturn 0;\r\n}\r\nstatic irqreturn_t ad7606_trigger_handler_th_bh(int irq, void *p)\r\n{\r\nstruct iio_poll_func *pf = p;\r\nstruct iio_dev *indio_dev = pf->private_data;\r\nstruct ad7606_state *st = iio_priv(indio_dev);\r\ngpio_set_value(st->pdata->gpio_convst, 1);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void ad7606_poll_bh_to_ring(struct work_struct *work_s)\r\n{\r\nstruct ad7606_state *st = container_of(work_s, struct ad7606_state,\r\npoll_work);\r\nstruct iio_dev *indio_dev = iio_priv_to_dev(st);\r\nstruct iio_ring_buffer *ring = indio_dev->ring;\r\ns64 time_ns;\r\n__u8 *buf;\r\nint ret;\r\nbuf = kzalloc(st->d_size, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn;\r\nif (st->have_frstdata) {\r\nret = st->bops->read_block(st->dev, 1, buf);\r\nif (ret)\r\ngoto done;\r\nif (!gpio_get_value(st->pdata->gpio_frstdata)) {\r\nad7606_reset(st);\r\ngoto done;\r\n}\r\nret = st->bops->read_block(st->dev,\r\nst->chip_info->num_channels - 1, buf + 2);\r\nif (ret)\r\ngoto done;\r\n} else {\r\nret = st->bops->read_block(st->dev,\r\nst->chip_info->num_channels, buf);\r\nif (ret)\r\ngoto done;\r\n}\r\ntime_ns = iio_get_time_ns();\r\nif (ring->scan_timestamp)\r\nmemcpy(buf + st->d_size - sizeof(s64),\r\n&time_ns, sizeof(time_ns));\r\nring->access->store_to(indio_dev->ring, buf, time_ns);\r\ndone:\r\ngpio_set_value(st->pdata->gpio_convst, 0);\r\niio_trigger_notify_done(indio_dev->trig);\r\nkfree(buf);\r\n}\r\nint ad7606_register_ring_funcs_and_init(struct iio_dev *indio_dev)\r\n{\r\nstruct ad7606_state *st = iio_priv(indio_dev);\r\nint ret;\r\nindio_dev->ring = iio_sw_rb_allocate(indio_dev);\r\nif (!indio_dev->ring) {\r\nret = -ENOMEM;\r\ngoto error_ret;\r\n}\r\nindio_dev->ring->access = &ring_sw_access_funcs;\r\nindio_dev->pollfunc = iio_alloc_pollfunc(&ad7606_trigger_handler_th_bh,\r\n&ad7606_trigger_handler_th_bh,\r\n0,\r\nindio_dev,\r\n"%s_consumer%d",\r\nindio_dev->name,\r\nindio_dev->id);\r\nif (indio_dev->pollfunc == NULL) {\r\nret = -ENOMEM;\r\ngoto error_deallocate_sw_rb;\r\n}\r\nindio_dev->ring->setup_ops = &ad7606_ring_setup_ops;\r\nindio_dev->ring->scan_timestamp = true ;\r\nINIT_WORK(&st->poll_work, &ad7606_poll_bh_to_ring);\r\nindio_dev->modes |= INDIO_RING_TRIGGERED;\r\nreturn 0;\r\nerror_deallocate_sw_rb:\r\niio_sw_rb_free(indio_dev->ring);\r\nerror_ret:\r\nreturn ret;\r\n}\r\nvoid ad7606_ring_cleanup(struct iio_dev *indio_dev)\r\n{\r\nif (indio_dev->trig) {\r\niio_put_trigger(indio_dev->trig);\r\niio_trigger_dettach_poll_func(indio_dev->trig,\r\nindio_dev->pollfunc);\r\n}\r\niio_dealloc_pollfunc(indio_dev->pollfunc);\r\niio_sw_rb_free(indio_dev->ring);\r\n}

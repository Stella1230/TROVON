static caddr_t remap_window(struct map_info *map, unsigned long to)\r\n{\r\nstruct pcmciamtd_dev *dev = (struct pcmciamtd_dev *)map->map_priv_1;\r\nstruct resource *win = (struct resource *) map->map_priv_2;\r\nunsigned int offset;\r\nint ret;\r\nif (!pcmcia_dev_present(dev->p_dev)) {\r\nDEBUG(1, "device removed");\r\nreturn 0;\r\n}\r\noffset = to & ~(dev->win_size-1);\r\nif (offset != dev->offset) {\r\nDEBUG(2, "Remapping window from 0x%8.8x to 0x%8.8x",\r\ndev->offset, offset);\r\nret = pcmcia_map_mem_page(dev->p_dev, win, offset);\r\nif (ret != 0)\r\nreturn NULL;\r\ndev->offset = offset;\r\n}\r\nreturn dev->win_base + (to & (dev->win_size-1));\r\n}\r\nstatic map_word pcmcia_read8_remap(struct map_info *map, unsigned long ofs)\r\n{\r\ncaddr_t addr;\r\nmap_word d = {{0}};\r\naddr = remap_window(map, ofs);\r\nif(!addr)\r\nreturn d;\r\nd.x[0] = readb(addr);\r\nDEBUG(3, "ofs = 0x%08lx (%p) data = 0x%02lx", ofs, addr, d.x[0]);\r\nreturn d;\r\n}\r\nstatic map_word pcmcia_read16_remap(struct map_info *map, unsigned long ofs)\r\n{\r\ncaddr_t addr;\r\nmap_word d = {{0}};\r\naddr = remap_window(map, ofs);\r\nif(!addr)\r\nreturn d;\r\nd.x[0] = readw(addr);\r\nDEBUG(3, "ofs = 0x%08lx (%p) data = 0x%04lx", ofs, addr, d.x[0]);\r\nreturn d;\r\n}\r\nstatic void pcmcia_copy_from_remap(struct map_info *map, void *to, unsigned long from, ssize_t len)\r\n{\r\nstruct pcmciamtd_dev *dev = (struct pcmciamtd_dev *)map->map_priv_1;\r\nunsigned long win_size = dev->win_size;\r\nDEBUG(3, "to = %p from = %lu len = %zd", to, from, len);\r\nwhile(len) {\r\nint toread = win_size - (from & (win_size-1));\r\ncaddr_t addr;\r\nif(toread > len)\r\ntoread = len;\r\naddr = remap_window(map, from);\r\nif(!addr)\r\nreturn;\r\nDEBUG(4, "memcpy from %p to %p len = %d", addr, to, toread);\r\nmemcpy_fromio(to, addr, toread);\r\nlen -= toread;\r\nto += toread;\r\nfrom += toread;\r\n}\r\n}\r\nstatic void pcmcia_write8_remap(struct map_info *map, map_word d, unsigned long adr)\r\n{\r\ncaddr_t addr = remap_window(map, adr);\r\nif(!addr)\r\nreturn;\r\nDEBUG(3, "adr = 0x%08lx (%p) data = 0x%02lx", adr, addr, d.x[0]);\r\nwriteb(d.x[0], addr);\r\n}\r\nstatic void pcmcia_write16_remap(struct map_info *map, map_word d, unsigned long adr)\r\n{\r\ncaddr_t addr = remap_window(map, adr);\r\nif(!addr)\r\nreturn;\r\nDEBUG(3, "adr = 0x%08lx (%p) data = 0x%04lx", adr, addr, d.x[0]);\r\nwritew(d.x[0], addr);\r\n}\r\nstatic void pcmcia_copy_to_remap(struct map_info *map, unsigned long to, const void *from, ssize_t len)\r\n{\r\nstruct pcmciamtd_dev *dev = (struct pcmciamtd_dev *)map->map_priv_1;\r\nunsigned long win_size = dev->win_size;\r\nDEBUG(3, "to = %lu from = %p len = %zd", to, from, len);\r\nwhile(len) {\r\nint towrite = win_size - (to & (win_size-1));\r\ncaddr_t addr;\r\nif(towrite > len)\r\ntowrite = len;\r\naddr = remap_window(map, to);\r\nif(!addr)\r\nreturn;\r\nDEBUG(4, "memcpy from %p to %p len = %d", from, addr, towrite);\r\nmemcpy_toio(addr, from, towrite);\r\nlen -= towrite;\r\nto += towrite;\r\nfrom += towrite;\r\n}\r\n}\r\nstatic map_word pcmcia_read8(struct map_info *map, unsigned long ofs)\r\n{\r\ncaddr_t win_base = (caddr_t)map->map_priv_2;\r\nmap_word d = {{0}};\r\nif(DEV_REMOVED(map))\r\nreturn d;\r\nd.x[0] = readb(win_base + ofs);\r\nDEBUG(3, "ofs = 0x%08lx (%p) data = 0x%02lx",\r\nofs, win_base + ofs, d.x[0]);\r\nreturn d;\r\n}\r\nstatic map_word pcmcia_read16(struct map_info *map, unsigned long ofs)\r\n{\r\ncaddr_t win_base = (caddr_t)map->map_priv_2;\r\nmap_word d = {{0}};\r\nif(DEV_REMOVED(map))\r\nreturn d;\r\nd.x[0] = readw(win_base + ofs);\r\nDEBUG(3, "ofs = 0x%08lx (%p) data = 0x%04lx",\r\nofs, win_base + ofs, d.x[0]);\r\nreturn d;\r\n}\r\nstatic void pcmcia_copy_from(struct map_info *map, void *to, unsigned long from, ssize_t len)\r\n{\r\ncaddr_t win_base = (caddr_t)map->map_priv_2;\r\nif(DEV_REMOVED(map))\r\nreturn;\r\nDEBUG(3, "to = %p from = %lu len = %zd", to, from, len);\r\nmemcpy_fromio(to, win_base + from, len);\r\n}\r\nstatic void pcmcia_write8(struct map_info *map, map_word d, unsigned long adr)\r\n{\r\ncaddr_t win_base = (caddr_t)map->map_priv_2;\r\nif(DEV_REMOVED(map))\r\nreturn;\r\nDEBUG(3, "adr = 0x%08lx (%p) data = 0x%02lx",\r\nadr, win_base + adr, d.x[0]);\r\nwriteb(d.x[0], win_base + adr);\r\n}\r\nstatic void pcmcia_write16(struct map_info *map, map_word d, unsigned long adr)\r\n{\r\ncaddr_t win_base = (caddr_t)map->map_priv_2;\r\nif(DEV_REMOVED(map))\r\nreturn;\r\nDEBUG(3, "adr = 0x%08lx (%p) data = 0x%04lx",\r\nadr, win_base + adr, d.x[0]);\r\nwritew(d.x[0], win_base + adr);\r\n}\r\nstatic void pcmcia_copy_to(struct map_info *map, unsigned long to, const void *from, ssize_t len)\r\n{\r\ncaddr_t win_base = (caddr_t)map->map_priv_2;\r\nif(DEV_REMOVED(map))\r\nreturn;\r\nDEBUG(3, "to = %lu from = %p len = %zd", to, from, len);\r\nmemcpy_toio(win_base + to, from, len);\r\n}\r\nstatic void pcmciamtd_set_vpp(struct map_info *map, int on)\r\n{\r\nstruct pcmciamtd_dev *dev = (struct pcmciamtd_dev *)map->map_priv_1;\r\nstruct pcmcia_device *link = dev->p_dev;\r\nDEBUG(2, "dev = %p on = %d vpp = %d\n", dev, on, dev->vpp);\r\npcmcia_fixup_vpp(link, on ? dev->vpp : 0);\r\n}\r\nstatic void pcmciamtd_release(struct pcmcia_device *link)\r\n{\r\nstruct pcmciamtd_dev *dev = link->priv;\r\nDEBUG(3, "link = 0x%p", link);\r\nif (link->resource[2]->end) {\r\nif(dev->win_base) {\r\niounmap(dev->win_base);\r\ndev->win_base = NULL;\r\n}\r\n}\r\npcmcia_disable_device(link);\r\n}\r\nstatic int pcmciamtd_cistpl_format(struct pcmcia_device *p_dev,\r\ntuple_t *tuple,\r\nvoid *priv_data)\r\n{\r\ncisparse_t parse;\r\nif (!pcmcia_parse_tuple(tuple, &parse)) {\r\ncistpl_format_t *t = &parse.format;\r\n(void)t;\r\nDEBUG(2, "Format type: %u, Error Detection: %u, offset = %u, length =%u",\r\nt->type, t->edc, t->offset, t->length);\r\n}\r\nreturn -ENOSPC;\r\n}\r\nstatic int pcmciamtd_cistpl_jedec(struct pcmcia_device *p_dev,\r\ntuple_t *tuple,\r\nvoid *priv_data)\r\n{\r\ncisparse_t parse;\r\nint i;\r\nif (!pcmcia_parse_tuple(tuple, &parse)) {\r\ncistpl_jedec_t *t = &parse.jedec;\r\nfor (i = 0; i < t->nid; i++)\r\nDEBUG(2, "JEDEC: 0x%02x 0x%02x",\r\nt->id[i].mfr, t->id[i].info);\r\n}\r\nreturn -ENOSPC;\r\n}\r\nstatic int pcmciamtd_cistpl_device(struct pcmcia_device *p_dev,\r\ntuple_t *tuple,\r\nvoid *priv_data)\r\n{\r\nstruct pcmciamtd_dev *dev = priv_data;\r\ncisparse_t parse;\r\ncistpl_device_t *t = &parse.device;\r\nint i;\r\nif (pcmcia_parse_tuple(tuple, &parse))\r\nreturn -EINVAL;\r\nDEBUG(2, "Common memory:");\r\ndev->pcmcia_map.size = t->dev[0].size;\r\nfor (i = 0; i < t->ndev; i++) {\r\nDEBUG(2, "Region %d, type = %u", i, t->dev[i].type);\r\nDEBUG(2, "Region %d, wp = %u", i, t->dev[i].wp);\r\nDEBUG(2, "Region %d, speed = %u ns", i, t->dev[i].speed);\r\nDEBUG(2, "Region %d, size = %u bytes", i, t->dev[i].size);\r\n}\r\nreturn 0;\r\n}\r\nstatic int pcmciamtd_cistpl_geo(struct pcmcia_device *p_dev,\r\ntuple_t *tuple,\r\nvoid *priv_data)\r\n{\r\nstruct pcmciamtd_dev *dev = priv_data;\r\ncisparse_t parse;\r\ncistpl_device_geo_t *t = &parse.device_geo;\r\nint i;\r\nif (pcmcia_parse_tuple(tuple, &parse))\r\nreturn -EINVAL;\r\ndev->pcmcia_map.bankwidth = t->geo[0].buswidth;\r\nfor (i = 0; i < t->ngeo; i++) {\r\nDEBUG(2, "region: %d bankwidth = %u", i, t->geo[i].buswidth);\r\nDEBUG(2, "region: %d erase_block = %u", i, t->geo[i].erase_block);\r\nDEBUG(2, "region: %d read_block = %u", i, t->geo[i].read_block);\r\nDEBUG(2, "region: %d write_block = %u", i, t->geo[i].write_block);\r\nDEBUG(2, "region: %d partition = %u", i, t->geo[i].partition);\r\nDEBUG(2, "region: %d interleave = %u", i, t->geo[i].interleave);\r\n}\r\nreturn 0;\r\n}\r\nstatic void card_settings(struct pcmciamtd_dev *dev, struct pcmcia_device *p_dev, int *new_name)\r\n{\r\nint i;\r\nif (p_dev->prod_id[0]) {\r\ndev->mtd_name[0] = '\0';\r\nfor (i = 0; i < 4; i++) {\r\nif (i)\r\nstrcat(dev->mtd_name, " ");\r\nif (p_dev->prod_id[i])\r\nstrcat(dev->mtd_name, p_dev->prod_id[i]);\r\n}\r\nDEBUG(2, "Found name: %s", dev->mtd_name);\r\n}\r\n#ifdef CONFIG_MTD_DEBUG\r\npcmcia_loop_tuple(p_dev, CISTPL_FORMAT, pcmciamtd_cistpl_format, NULL);\r\npcmcia_loop_tuple(p_dev, CISTPL_JEDEC_C, pcmciamtd_cistpl_jedec, NULL);\r\n#endif\r\npcmcia_loop_tuple(p_dev, CISTPL_DEVICE, pcmciamtd_cistpl_device, dev);\r\npcmcia_loop_tuple(p_dev, CISTPL_DEVICE_GEO, pcmciamtd_cistpl_geo, dev);\r\nif(!dev->pcmcia_map.size)\r\ndev->pcmcia_map.size = MAX_PCMCIA_ADDR;\r\nif(!dev->pcmcia_map.bankwidth)\r\ndev->pcmcia_map.bankwidth = 2;\r\nif(force_size) {\r\ndev->pcmcia_map.size = force_size << 20;\r\nDEBUG(2, "size forced to %dM", force_size);\r\n}\r\nif(bankwidth) {\r\ndev->pcmcia_map.bankwidth = bankwidth;\r\nDEBUG(2, "bankwidth forced to %d", bankwidth);\r\n}\r\ndev->pcmcia_map.name = dev->mtd_name;\r\nif(!dev->mtd_name[0]) {\r\nstrcpy(dev->mtd_name, "PCMCIA Memory card");\r\n*new_name = 1;\r\n}\r\nDEBUG(1, "Device: Size: %lu Width:%d Name: %s",\r\ndev->pcmcia_map.size,\r\ndev->pcmcia_map.bankwidth << 3, dev->mtd_name);\r\n}\r\nstatic int pcmciamtd_config(struct pcmcia_device *link)\r\n{\r\nstruct pcmciamtd_dev *dev = link->priv;\r\nstruct mtd_info *mtd = NULL;\r\nint ret;\r\nint i, j = 0;\r\nstatic char *probes[] = { "jedec_probe", "cfi_probe" };\r\nint new_name = 0;\r\nDEBUG(3, "link=0x%p", link);\r\ncard_settings(dev, link, &new_name);\r\ndev->pcmcia_map.phys = NO_XIP;\r\ndev->pcmcia_map.copy_from = pcmcia_copy_from_remap;\r\ndev->pcmcia_map.copy_to = pcmcia_copy_to_remap;\r\nif (dev->pcmcia_map.bankwidth == 1) {\r\ndev->pcmcia_map.read = pcmcia_read8_remap;\r\ndev->pcmcia_map.write = pcmcia_write8_remap;\r\n} else {\r\ndev->pcmcia_map.read = pcmcia_read16_remap;\r\ndev->pcmcia_map.write = pcmcia_write16_remap;\r\n}\r\nif(setvpp == 1)\r\ndev->pcmcia_map.set_vpp = pcmciamtd_set_vpp;\r\nlink->resource[2]->flags |= WIN_MEMORY_TYPE_CM | WIN_ENABLE;\r\nlink->resource[2]->flags |= (dev->pcmcia_map.bankwidth == 1) ?\r\nWIN_DATA_WIDTH_8 : WIN_DATA_WIDTH_16;\r\nlink->resource[2]->start = 0;\r\nlink->resource[2]->end = (force_size) ? force_size << 20 :\r\nMAX_PCMCIA_ADDR;\r\ndev->win_size = 0;\r\ndo {\r\nint ret;\r\nDEBUG(2, "requesting window with size = %luKiB memspeed = %d",\r\n(unsigned long) resource_size(link->resource[2]) >> 10,\r\nmem_speed);\r\nret = pcmcia_request_window(link, link->resource[2], mem_speed);\r\nDEBUG(2, "ret = %d dev->win_size = %d", ret, dev->win_size);\r\nif(ret) {\r\nj++;\r\nlink->resource[2]->start = 0;\r\nlink->resource[2]->end = (force_size) ?\r\nforce_size << 20 : MAX_PCMCIA_ADDR;\r\nlink->resource[2]->end >>= j;\r\n} else {\r\nDEBUG(2, "Got window of size %luKiB", (unsigned long)\r\nresource_size(link->resource[2]) >> 10);\r\ndev->win_size = resource_size(link->resource[2]);\r\nbreak;\r\n}\r\n} while (link->resource[2]->end >= 0x1000);\r\nDEBUG(2, "dev->win_size = %d", dev->win_size);\r\nif(!dev->win_size) {\r\ndev_err(&dev->p_dev->dev, "Cannot allocate memory window\n");\r\npcmciamtd_release(link);\r\nreturn -ENODEV;\r\n}\r\nDEBUG(1, "Allocated a window of %dKiB", dev->win_size >> 10);\r\ndev->win_base = ioremap(link->resource[2]->start,\r\nresource_size(link->resource[2]));\r\nif(!dev->win_base) {\r\ndev_err(&dev->p_dev->dev, "ioremap(%pR) failed\n",\r\nlink->resource[2]);\r\npcmciamtd_release(link);\r\nreturn -ENODEV;\r\n}\r\nDEBUG(1, "mapped window dev = %p @ %pR, base = %p",\r\ndev, link->resource[2], dev->win_base);\r\ndev->offset = 0;\r\ndev->pcmcia_map.map_priv_1 = (unsigned long)dev;\r\ndev->pcmcia_map.map_priv_2 = (unsigned long)link->resource[2];\r\ndev->vpp = (vpp) ? vpp : link->socket->socket.Vpp;\r\nif(setvpp == 2) {\r\nlink->vpp = dev->vpp;\r\n} else {\r\nlink->vpp = 0;\r\n}\r\nlink->config_index = 0;\r\nDEBUG(2, "Setting Configuration");\r\nret = pcmcia_enable_device(link);\r\nif (ret != 0) {\r\nif (dev->win_base) {\r\niounmap(dev->win_base);\r\ndev->win_base = NULL;\r\n}\r\nreturn -ENODEV;\r\n}\r\nif(mem_type == 1) {\r\nmtd = do_map_probe("map_ram", &dev->pcmcia_map);\r\n} else if(mem_type == 2) {\r\nmtd = do_map_probe("map_rom", &dev->pcmcia_map);\r\n} else {\r\nfor(i = 0; i < ARRAY_SIZE(probes); i++) {\r\nDEBUG(1, "Trying %s", probes[i]);\r\nmtd = do_map_probe(probes[i], &dev->pcmcia_map);\r\nif(mtd)\r\nbreak;\r\nDEBUG(1, "FAILED: %s", probes[i]);\r\n}\r\n}\r\nif(!mtd) {\r\nDEBUG(1, "Can not find an MTD");\r\npcmciamtd_release(link);\r\nreturn -ENODEV;\r\n}\r\ndev->mtd_info = mtd;\r\nmtd->owner = THIS_MODULE;\r\nif(new_name) {\r\nint size = 0;\r\nchar unit = ' ';\r\nif(mtd->size < 1048576) {\r\nsize = mtd->size >> 10;\r\nunit = 'K';\r\n} else {\r\nsize = mtd->size >> 20;\r\nunit = 'M';\r\n}\r\nsnprintf(dev->mtd_name, sizeof(dev->mtd_name), "%d%ciB %s", size, unit, "PCMCIA Memory card");\r\n}\r\nif(mtd->size <= dev->win_size) {\r\nDEBUG(1, "Using non remapping memory functions");\r\ndev->pcmcia_map.map_priv_2 = (unsigned long)dev->win_base;\r\nif (dev->pcmcia_map.bankwidth == 1) {\r\ndev->pcmcia_map.read = pcmcia_read8;\r\ndev->pcmcia_map.write = pcmcia_write8;\r\n} else {\r\ndev->pcmcia_map.read = pcmcia_read16;\r\ndev->pcmcia_map.write = pcmcia_write16;\r\n}\r\ndev->pcmcia_map.copy_from = pcmcia_copy_from;\r\ndev->pcmcia_map.copy_to = pcmcia_copy_to;\r\n}\r\nif (mtd_device_register(mtd, NULL, 0)) {\r\nmap_destroy(mtd);\r\ndev->mtd_info = NULL;\r\ndev_err(&dev->p_dev->dev,\r\n"Could not register the MTD device\n");\r\npcmciamtd_release(link);\r\nreturn -ENODEV;\r\n}\r\ndev_info(&dev->p_dev->dev, "mtd%d: %s\n", mtd->index, mtd->name);\r\nreturn 0;\r\n}\r\nstatic int pcmciamtd_suspend(struct pcmcia_device *dev)\r\n{\r\nDEBUG(2, "EVENT_PM_RESUME");\r\nreturn 0;\r\n}\r\nstatic int pcmciamtd_resume(struct pcmcia_device *dev)\r\n{\r\nDEBUG(2, "EVENT_PM_SUSPEND");\r\nreturn 0;\r\n}\r\nstatic void pcmciamtd_detach(struct pcmcia_device *link)\r\n{\r\nstruct pcmciamtd_dev *dev = link->priv;\r\nDEBUG(3, "link=0x%p", link);\r\nif(dev->mtd_info) {\r\nmtd_device_unregister(dev->mtd_info);\r\ndev_info(&dev->p_dev->dev, "mtd%d: Removing\n",\r\ndev->mtd_info->index);\r\nmap_destroy(dev->mtd_info);\r\n}\r\npcmciamtd_release(link);\r\n}\r\nstatic int pcmciamtd_probe(struct pcmcia_device *link)\r\n{\r\nstruct pcmciamtd_dev *dev;\r\ndev = kzalloc(sizeof(*dev), GFP_KERNEL);\r\nif (!dev) return -ENOMEM;\r\nDEBUG(1, "dev=0x%p", dev);\r\ndev->p_dev = link;\r\nlink->priv = dev;\r\nreturn pcmciamtd_config(link);\r\n}\r\nstatic int __init init_pcmciamtd(void)\r\n{\r\nif(bankwidth && bankwidth != 1 && bankwidth != 2) {\r\ninfo("bad bankwidth (%d), using default", bankwidth);\r\nbankwidth = 2;\r\n}\r\nif(force_size && (force_size < 1 || force_size > 64)) {\r\ninfo("bad force_size (%d), using default", force_size);\r\nforce_size = 0;\r\n}\r\nif(mem_type && mem_type != 1 && mem_type != 2) {\r\ninfo("bad mem_type (%d), using default", mem_type);\r\nmem_type = 0;\r\n}\r\nreturn pcmcia_register_driver(&pcmciamtd_driver);\r\n}\r\nstatic void __exit exit_pcmciamtd(void)\r\n{\r\nDEBUG(1, DRIVER_DESC " unloading");\r\npcmcia_unregister_driver(&pcmciamtd_driver);\r\n}

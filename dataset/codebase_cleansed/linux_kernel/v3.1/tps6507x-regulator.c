static inline int tps6507x_pmic_read(struct tps6507x_pmic *tps, u8 reg)\r\n{\r\nu8 val;\r\nint err;\r\nerr = tps->mfd->read_dev(tps->mfd, reg, 1, &val);\r\nif (err)\r\nreturn err;\r\nreturn val;\r\n}\r\nstatic inline int tps6507x_pmic_write(struct tps6507x_pmic *tps, u8 reg, u8 val)\r\n{\r\nreturn tps->mfd->write_dev(tps->mfd, reg, 1, &val);\r\n}\r\nstatic int tps6507x_pmic_set_bits(struct tps6507x_pmic *tps, u8 reg, u8 mask)\r\n{\r\nint err, data;\r\nmutex_lock(&tps->io_lock);\r\ndata = tps6507x_pmic_read(tps, reg);\r\nif (data < 0) {\r\ndev_err(tps->mfd->dev, "Read from reg 0x%x failed\n", reg);\r\nerr = data;\r\ngoto out;\r\n}\r\ndata |= mask;\r\nerr = tps6507x_pmic_write(tps, reg, data);\r\nif (err)\r\ndev_err(tps->mfd->dev, "Write for reg 0x%x failed\n", reg);\r\nout:\r\nmutex_unlock(&tps->io_lock);\r\nreturn err;\r\n}\r\nstatic int tps6507x_pmic_clear_bits(struct tps6507x_pmic *tps, u8 reg, u8 mask)\r\n{\r\nint err, data;\r\nmutex_lock(&tps->io_lock);\r\ndata = tps6507x_pmic_read(tps, reg);\r\nif (data < 0) {\r\ndev_err(tps->mfd->dev, "Read from reg 0x%x failed\n", reg);\r\nerr = data;\r\ngoto out;\r\n}\r\ndata &= ~mask;\r\nerr = tps6507x_pmic_write(tps, reg, data);\r\nif (err)\r\ndev_err(tps->mfd->dev, "Write for reg 0x%x failed\n", reg);\r\nout:\r\nmutex_unlock(&tps->io_lock);\r\nreturn err;\r\n}\r\nstatic int tps6507x_pmic_reg_read(struct tps6507x_pmic *tps, u8 reg)\r\n{\r\nint data;\r\nmutex_lock(&tps->io_lock);\r\ndata = tps6507x_pmic_read(tps, reg);\r\nif (data < 0)\r\ndev_err(tps->mfd->dev, "Read from reg 0x%x failed\n", reg);\r\nmutex_unlock(&tps->io_lock);\r\nreturn data;\r\n}\r\nstatic int tps6507x_pmic_reg_write(struct tps6507x_pmic *tps, u8 reg, u8 val)\r\n{\r\nint err;\r\nmutex_lock(&tps->io_lock);\r\nerr = tps6507x_pmic_write(tps, reg, val);\r\nif (err < 0)\r\ndev_err(tps->mfd->dev, "Write for reg 0x%x failed\n", reg);\r\nmutex_unlock(&tps->io_lock);\r\nreturn err;\r\n}\r\nstatic int tps6507x_pmic_dcdc_is_enabled(struct regulator_dev *dev)\r\n{\r\nstruct tps6507x_pmic *tps = rdev_get_drvdata(dev);\r\nint data, dcdc = rdev_get_id(dev);\r\nu8 shift;\r\nif (dcdc < TPS6507X_DCDC_1 || dcdc > TPS6507X_DCDC_3)\r\nreturn -EINVAL;\r\nshift = TPS6507X_MAX_REG_ID - dcdc;\r\ndata = tps6507x_pmic_reg_read(tps, TPS6507X_REG_CON_CTRL1);\r\nif (data < 0)\r\nreturn data;\r\nelse\r\nreturn (data & 1<<shift) ? 1 : 0;\r\n}\r\nstatic int tps6507x_pmic_ldo_is_enabled(struct regulator_dev *dev)\r\n{\r\nstruct tps6507x_pmic *tps = rdev_get_drvdata(dev);\r\nint data, ldo = rdev_get_id(dev);\r\nu8 shift;\r\nif (ldo < TPS6507X_LDO_1 || ldo > TPS6507X_LDO_2)\r\nreturn -EINVAL;\r\nshift = TPS6507X_MAX_REG_ID - ldo;\r\ndata = tps6507x_pmic_reg_read(tps, TPS6507X_REG_CON_CTRL1);\r\nif (data < 0)\r\nreturn data;\r\nelse\r\nreturn (data & 1<<shift) ? 1 : 0;\r\n}\r\nstatic int tps6507x_pmic_dcdc_enable(struct regulator_dev *dev)\r\n{\r\nstruct tps6507x_pmic *tps = rdev_get_drvdata(dev);\r\nint dcdc = rdev_get_id(dev);\r\nu8 shift;\r\nif (dcdc < TPS6507X_DCDC_1 || dcdc > TPS6507X_DCDC_3)\r\nreturn -EINVAL;\r\nshift = TPS6507X_MAX_REG_ID - dcdc;\r\nreturn tps6507x_pmic_set_bits(tps, TPS6507X_REG_CON_CTRL1, 1 << shift);\r\n}\r\nstatic int tps6507x_pmic_dcdc_disable(struct regulator_dev *dev)\r\n{\r\nstruct tps6507x_pmic *tps = rdev_get_drvdata(dev);\r\nint dcdc = rdev_get_id(dev);\r\nu8 shift;\r\nif (dcdc < TPS6507X_DCDC_1 || dcdc > TPS6507X_DCDC_3)\r\nreturn -EINVAL;\r\nshift = TPS6507X_MAX_REG_ID - dcdc;\r\nreturn tps6507x_pmic_clear_bits(tps, TPS6507X_REG_CON_CTRL1,\r\n1 << shift);\r\n}\r\nstatic int tps6507x_pmic_ldo_enable(struct regulator_dev *dev)\r\n{\r\nstruct tps6507x_pmic *tps = rdev_get_drvdata(dev);\r\nint ldo = rdev_get_id(dev);\r\nu8 shift;\r\nif (ldo < TPS6507X_LDO_1 || ldo > TPS6507X_LDO_2)\r\nreturn -EINVAL;\r\nshift = TPS6507X_MAX_REG_ID - ldo;\r\nreturn tps6507x_pmic_set_bits(tps, TPS6507X_REG_CON_CTRL1, 1 << shift);\r\n}\r\nstatic int tps6507x_pmic_ldo_disable(struct regulator_dev *dev)\r\n{\r\nstruct tps6507x_pmic *tps = rdev_get_drvdata(dev);\r\nint ldo = rdev_get_id(dev);\r\nu8 shift;\r\nif (ldo < TPS6507X_LDO_1 || ldo > TPS6507X_LDO_2)\r\nreturn -EINVAL;\r\nshift = TPS6507X_MAX_REG_ID - ldo;\r\nreturn tps6507x_pmic_clear_bits(tps, TPS6507X_REG_CON_CTRL1,\r\n1 << shift);\r\n}\r\nstatic int tps6507x_pmic_dcdc_get_voltage(struct regulator_dev *dev)\r\n{\r\nstruct tps6507x_pmic *tps = rdev_get_drvdata(dev);\r\nint data, dcdc = rdev_get_id(dev);\r\nu8 reg;\r\nswitch (dcdc) {\r\ncase TPS6507X_DCDC_1:\r\nreg = TPS6507X_REG_DEFDCDC1;\r\nbreak;\r\ncase TPS6507X_DCDC_2:\r\nif (tps->info[dcdc]->defdcdc_default)\r\nreg = TPS6507X_REG_DEFDCDC2_HIGH;\r\nelse\r\nreg = TPS6507X_REG_DEFDCDC2_LOW;\r\nbreak;\r\ncase TPS6507X_DCDC_3:\r\nif (tps->info[dcdc]->defdcdc_default)\r\nreg = TPS6507X_REG_DEFDCDC3_HIGH;\r\nelse\r\nreg = TPS6507X_REG_DEFDCDC3_LOW;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ndata = tps6507x_pmic_reg_read(tps, reg);\r\nif (data < 0)\r\nreturn data;\r\ndata &= TPS6507X_DEFDCDCX_DCDC_MASK;\r\nreturn tps->info[dcdc]->table[data] * 1000;\r\n}\r\nstatic int tps6507x_pmic_dcdc_set_voltage(struct regulator_dev *dev,\r\nint min_uV, int max_uV,\r\nunsigned *selector)\r\n{\r\nstruct tps6507x_pmic *tps = rdev_get_drvdata(dev);\r\nint data, vsel, dcdc = rdev_get_id(dev);\r\nu8 reg;\r\nswitch (dcdc) {\r\ncase TPS6507X_DCDC_1:\r\nreg = TPS6507X_REG_DEFDCDC1;\r\nbreak;\r\ncase TPS6507X_DCDC_2:\r\nif (tps->info[dcdc]->defdcdc_default)\r\nreg = TPS6507X_REG_DEFDCDC2_HIGH;\r\nelse\r\nreg = TPS6507X_REG_DEFDCDC2_LOW;\r\nbreak;\r\ncase TPS6507X_DCDC_3:\r\nif (tps->info[dcdc]->defdcdc_default)\r\nreg = TPS6507X_REG_DEFDCDC3_HIGH;\r\nelse\r\nreg = TPS6507X_REG_DEFDCDC3_LOW;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (min_uV < tps->info[dcdc]->min_uV\r\n|| min_uV > tps->info[dcdc]->max_uV)\r\nreturn -EINVAL;\r\nif (max_uV < tps->info[dcdc]->min_uV\r\n|| max_uV > tps->info[dcdc]->max_uV)\r\nreturn -EINVAL;\r\nfor (vsel = 0; vsel < tps->info[dcdc]->table_len; vsel++) {\r\nint mV = tps->info[dcdc]->table[vsel];\r\nint uV = mV * 1000;\r\nif (min_uV <= uV && uV <= max_uV)\r\nbreak;\r\n}\r\nif (vsel == tps->info[dcdc]->table_len)\r\nreturn -EINVAL;\r\n*selector = vsel;\r\ndata = tps6507x_pmic_reg_read(tps, reg);\r\nif (data < 0)\r\nreturn data;\r\ndata &= ~TPS6507X_DEFDCDCX_DCDC_MASK;\r\ndata |= vsel;\r\nreturn tps6507x_pmic_reg_write(tps, reg, data);\r\n}\r\nstatic int tps6507x_pmic_ldo_get_voltage(struct regulator_dev *dev)\r\n{\r\nstruct tps6507x_pmic *tps = rdev_get_drvdata(dev);\r\nint data, ldo = rdev_get_id(dev);\r\nu8 reg, mask;\r\nif (ldo < TPS6507X_LDO_1 || ldo > TPS6507X_LDO_2)\r\nreturn -EINVAL;\r\nelse {\r\nreg = (ldo == TPS6507X_LDO_1 ?\r\nTPS6507X_REG_LDO_CTRL1 : TPS6507X_REG_DEFLDO2);\r\nmask = (ldo == TPS6507X_LDO_1 ?\r\nTPS6507X_REG_LDO_CTRL1_LDO1_MASK :\r\nTPS6507X_REG_DEFLDO2_LDO2_MASK);\r\n}\r\ndata = tps6507x_pmic_reg_read(tps, reg);\r\nif (data < 0)\r\nreturn data;\r\ndata &= mask;\r\nreturn tps->info[ldo]->table[data] * 1000;\r\n}\r\nstatic int tps6507x_pmic_ldo_set_voltage(struct regulator_dev *dev,\r\nint min_uV, int max_uV,\r\nunsigned *selector)\r\n{\r\nstruct tps6507x_pmic *tps = rdev_get_drvdata(dev);\r\nint data, vsel, ldo = rdev_get_id(dev);\r\nu8 reg, mask;\r\nif (ldo < TPS6507X_LDO_1 || ldo > TPS6507X_LDO_2)\r\nreturn -EINVAL;\r\nelse {\r\nreg = (ldo == TPS6507X_LDO_1 ?\r\nTPS6507X_REG_LDO_CTRL1 : TPS6507X_REG_DEFLDO2);\r\nmask = (ldo == TPS6507X_LDO_1 ?\r\nTPS6507X_REG_LDO_CTRL1_LDO1_MASK :\r\nTPS6507X_REG_DEFLDO2_LDO2_MASK);\r\n}\r\nif (min_uV < tps->info[ldo]->min_uV || min_uV > tps->info[ldo]->max_uV)\r\nreturn -EINVAL;\r\nif (max_uV < tps->info[ldo]->min_uV || max_uV > tps->info[ldo]->max_uV)\r\nreturn -EINVAL;\r\nfor (vsel = 0; vsel < tps->info[ldo]->table_len; vsel++) {\r\nint mV = tps->info[ldo]->table[vsel];\r\nint uV = mV * 1000;\r\nif (min_uV <= uV && uV <= max_uV)\r\nbreak;\r\n}\r\nif (vsel == tps->info[ldo]->table_len)\r\nreturn -EINVAL;\r\n*selector = vsel;\r\ndata = tps6507x_pmic_reg_read(tps, reg);\r\nif (data < 0)\r\nreturn data;\r\ndata &= ~mask;\r\ndata |= vsel;\r\nreturn tps6507x_pmic_reg_write(tps, reg, data);\r\n}\r\nstatic int tps6507x_pmic_dcdc_list_voltage(struct regulator_dev *dev,\r\nunsigned selector)\r\n{\r\nstruct tps6507x_pmic *tps = rdev_get_drvdata(dev);\r\nint dcdc = rdev_get_id(dev);\r\nif (dcdc < TPS6507X_DCDC_1 || dcdc > TPS6507X_DCDC_3)\r\nreturn -EINVAL;\r\nif (selector >= tps->info[dcdc]->table_len)\r\nreturn -EINVAL;\r\nelse\r\nreturn tps->info[dcdc]->table[selector] * 1000;\r\n}\r\nstatic int tps6507x_pmic_ldo_list_voltage(struct regulator_dev *dev,\r\nunsigned selector)\r\n{\r\nstruct tps6507x_pmic *tps = rdev_get_drvdata(dev);\r\nint ldo = rdev_get_id(dev);\r\nif (ldo < TPS6507X_LDO_1 || ldo > TPS6507X_LDO_2)\r\nreturn -EINVAL;\r\nif (selector >= tps->info[ldo]->table_len)\r\nreturn -EINVAL;\r\nelse\r\nreturn tps->info[ldo]->table[selector] * 1000;\r\n}\r\nstatic __devinit\r\nint tps6507x_pmic_probe(struct platform_device *pdev)\r\n{\r\nstruct tps6507x_dev *tps6507x_dev = dev_get_drvdata(pdev->dev.parent);\r\nstruct tps_info *info = &tps6507x_pmic_regs[0];\r\nstruct regulator_init_data *init_data;\r\nstruct regulator_dev *rdev;\r\nstruct tps6507x_pmic *tps;\r\nstruct tps6507x_board *tps_board;\r\nint i;\r\nint error;\r\ntps_board = dev_get_platdata(tps6507x_dev->dev);\r\nif (!tps_board)\r\nreturn -EINVAL;\r\ninit_data = tps_board->tps6507x_pmic_init_data;\r\nif (!init_data)\r\nreturn -EINVAL;\r\ntps = kzalloc(sizeof(*tps), GFP_KERNEL);\r\nif (!tps)\r\nreturn -ENOMEM;\r\nmutex_init(&tps->io_lock);\r\ntps->mfd = tps6507x_dev;\r\nfor (i = 0; i < TPS6507X_NUM_REGULATOR; i++, info++, init_data++) {\r\ntps->info[i] = info;\r\nif (init_data->driver_data) {\r\nstruct tps6507x_reg_platform_data *data =\r\ninit_data->driver_data;\r\ntps->info[i]->defdcdc_default = data->defdcdc_default;\r\n}\r\ntps->desc[i].name = info->name;\r\ntps->desc[i].id = i;\r\ntps->desc[i].n_voltages = num_voltages[i];\r\ntps->desc[i].ops = (i > TPS6507X_DCDC_3 ?\r\n&tps6507x_pmic_ldo_ops : &tps6507x_pmic_dcdc_ops);\r\ntps->desc[i].type = REGULATOR_VOLTAGE;\r\ntps->desc[i].owner = THIS_MODULE;\r\nrdev = regulator_register(&tps->desc[i],\r\ntps6507x_dev->dev, init_data, tps);\r\nif (IS_ERR(rdev)) {\r\ndev_err(tps6507x_dev->dev,\r\n"failed to register %s regulator\n",\r\npdev->name);\r\nerror = PTR_ERR(rdev);\r\ngoto fail;\r\n}\r\ntps->rdev[i] = rdev;\r\n}\r\ntps6507x_dev->pmic = tps;\r\nplatform_set_drvdata(pdev, tps6507x_dev);\r\nreturn 0;\r\nfail:\r\nwhile (--i >= 0)\r\nregulator_unregister(tps->rdev[i]);\r\nkfree(tps);\r\nreturn error;\r\n}\r\nstatic int __devexit tps6507x_pmic_remove(struct platform_device *pdev)\r\n{\r\nstruct tps6507x_dev *tps6507x_dev = platform_get_drvdata(pdev);\r\nstruct tps6507x_pmic *tps = tps6507x_dev->pmic;\r\nint i;\r\nfor (i = 0; i < TPS6507X_NUM_REGULATOR; i++)\r\nregulator_unregister(tps->rdev[i]);\r\nkfree(tps);\r\nreturn 0;\r\n}\r\nstatic int __init tps6507x_pmic_init(void)\r\n{\r\nreturn platform_driver_register(&tps6507x_pmic_driver);\r\n}\r\nstatic void __exit tps6507x_pmic_cleanup(void)\r\n{\r\nplatform_driver_unregister(&tps6507x_pmic_driver);\r\n}

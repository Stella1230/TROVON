static void out_umc(char port, char wert)\r\n{\r\noutb_p(port, 0x108);\r\noutb_p(wert, 0x109);\r\n}\r\nstatic inline u8 in_umc(char port)\r\n{\r\noutb_p(port, 0x108);\r\nreturn inb_p(0x109);\r\n}\r\nstatic void umc_set_speeds(u8 speeds[])\r\n{\r\nint i, tmp;\r\noutb_p(0x5A, 0x108);\r\nout_umc(0xd7, (speedtab[0][speeds[2]] | (speedtab[0][speeds[3]]<<4)));\r\nout_umc(0xd6, (speedtab[0][speeds[0]] | (speedtab[0][speeds[1]]<<4)));\r\ntmp = 0;\r\nfor (i = 3; i >= 0; i--)\r\ntmp = (tmp << 2) | speedtab[1][speeds[i]];\r\nout_umc(0xdc, tmp);\r\nfor (i = 0; i < 4; i++) {\r\nout_umc(0xd0 + i, speedtab[2][speeds[i]]);\r\nout_umc(0xd8 + i, speedtab[2][speeds[i]]);\r\n}\r\noutb_p(0xa5, 0x108);\r\nprintk("umc8672: drive speeds [0 to 11]: %d %d %d %d\n",\r\nspeeds[0], speeds[1], speeds[2], speeds[3]);\r\n}\r\nstatic void umc_set_pio_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nide_hwif_t *mate = hwif->mate;\r\nunsigned long uninitialized_var(flags);\r\nconst u8 pio = drive->pio_mode - XFER_PIO_0;\r\nprintk("%s: setting umc8672 to PIO mode%d (speed %d)\n",\r\ndrive->name, pio, pio_to_umc[pio]);\r\nif (mate)\r\nspin_lock_irqsave(&mate->lock, flags);\r\nif (mate && mate->handler) {\r\nprintk(KERN_ERR "umc8672: other interface is busy: exiting tune_umc()\n");\r\n} else {\r\ncurrent_speeds[drive->name[2] - 'a'] = pio_to_umc[pio];\r\numc_set_speeds(current_speeds);\r\n}\r\nif (mate)\r\nspin_unlock_irqrestore(&mate->lock, flags);\r\n}\r\nstatic int __init umc8672_probe(void)\r\n{\r\nunsigned long flags;\r\nif (!request_region(0x108, 2, "umc8672")) {\r\nprintk(KERN_ERR "umc8672: ports 0x108-0x109 already in use.\n");\r\nreturn 1;\r\n}\r\nlocal_irq_save(flags);\r\noutb_p(0x5A, 0x108);\r\nif (in_umc (0xd5) != 0xa0) {\r\nlocal_irq_restore(flags);\r\nprintk(KERN_ERR "umc8672: not found\n");\r\nrelease_region(0x108, 2);\r\nreturn 1;\r\n}\r\noutb_p(0xa5, 0x108);\r\numc_set_speeds(current_speeds);\r\nlocal_irq_restore(flags);\r\nreturn ide_legacy_device_add(&umc8672_port_info, 0);\r\n}\r\nstatic int __init umc8672_init(void)\r\n{\r\nif (probe_umc8672 == 0)\r\ngoto out;\r\nif (umc8672_probe() == 0)\r\nreturn 0;\r\nout:\r\nreturn -ENODEV;\r\n}

static int pvc_shutdown(struct socket *sock, int how)\r\n{\r\nreturn 0;\r\n}\r\nstatic int pvc_bind(struct socket *sock, struct sockaddr *sockaddr,\r\nint sockaddr_len)\r\n{\r\nstruct sock *sk = sock->sk;\r\nstruct sockaddr_atmpvc *addr;\r\nstruct atm_vcc *vcc;\r\nint error;\r\nif (sockaddr_len != sizeof(struct sockaddr_atmpvc))\r\nreturn -EINVAL;\r\naddr = (struct sockaddr_atmpvc *)sockaddr;\r\nif (addr->sap_family != AF_ATMPVC)\r\nreturn -EAFNOSUPPORT;\r\nlock_sock(sk);\r\nvcc = ATM_SD(sock);\r\nif (!test_bit(ATM_VF_HASQOS, &vcc->flags)) {\r\nerror = -EBADFD;\r\ngoto out;\r\n}\r\nif (test_bit(ATM_VF_PARTIAL, &vcc->flags)) {\r\nif (vcc->vpi != ATM_VPI_UNSPEC)\r\naddr->sap_addr.vpi = vcc->vpi;\r\nif (vcc->vci != ATM_VCI_UNSPEC)\r\naddr->sap_addr.vci = vcc->vci;\r\n}\r\nerror = vcc_connect(sock, addr->sap_addr.itf, addr->sap_addr.vpi,\r\naddr->sap_addr.vci);\r\nout:\r\nrelease_sock(sk);\r\nreturn error;\r\n}\r\nstatic int pvc_connect(struct socket *sock, struct sockaddr *sockaddr,\r\nint sockaddr_len, int flags)\r\n{\r\nreturn pvc_bind(sock, sockaddr, sockaddr_len);\r\n}\r\nstatic int pvc_setsockopt(struct socket *sock, int level, int optname,\r\nchar __user *optval, unsigned int optlen)\r\n{\r\nstruct sock *sk = sock->sk;\r\nint error;\r\nlock_sock(sk);\r\nerror = vcc_setsockopt(sock, level, optname, optval, optlen);\r\nrelease_sock(sk);\r\nreturn error;\r\n}\r\nstatic int pvc_getsockopt(struct socket *sock, int level, int optname,\r\nchar __user *optval, int __user *optlen)\r\n{\r\nstruct sock *sk = sock->sk;\r\nint error;\r\nlock_sock(sk);\r\nerror = vcc_getsockopt(sock, level, optname, optval, optlen);\r\nrelease_sock(sk);\r\nreturn error;\r\n}\r\nstatic int pvc_getname(struct socket *sock, struct sockaddr *sockaddr,\r\nint *sockaddr_len, int peer)\r\n{\r\nstruct sockaddr_atmpvc *addr;\r\nstruct atm_vcc *vcc = ATM_SD(sock);\r\nif (!vcc->dev || !test_bit(ATM_VF_ADDR, &vcc->flags))\r\nreturn -ENOTCONN;\r\n*sockaddr_len = sizeof(struct sockaddr_atmpvc);\r\naddr = (struct sockaddr_atmpvc *)sockaddr;\r\naddr->sap_family = AF_ATMPVC;\r\naddr->sap_addr.itf = vcc->dev->number;\r\naddr->sap_addr.vpi = vcc->vpi;\r\naddr->sap_addr.vci = vcc->vci;\r\nreturn 0;\r\n}\r\nstatic int pvc_create(struct net *net, struct socket *sock, int protocol,\r\nint kern)\r\n{\r\nif (net != &init_net)\r\nreturn -EAFNOSUPPORT;\r\nsock->ops = &pvc_proto_ops;\r\nreturn vcc_create(net, sock, protocol, PF_ATMPVC);\r\n}\r\nint __init atmpvc_init(void)\r\n{\r\nreturn sock_register(&pvc_family_ops);\r\n}\r\nvoid atmpvc_exit(void)\r\n{\r\nsock_unregister(PF_ATMPVC);\r\n}

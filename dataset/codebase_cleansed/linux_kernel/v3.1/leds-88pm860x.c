static inline int __led_off(int port)\r\n{\r\nint ret = -EINVAL;\r\nswitch (port) {\r\ncase PM8606_LED1_RED:\r\ncase PM8606_LED1_GREEN:\r\ncase PM8606_LED1_BLUE:\r\nret = port - PM8606_LED1_RED + PM8606_RGB1B;\r\nbreak;\r\ncase PM8606_LED2_RED:\r\ncase PM8606_LED2_GREEN:\r\ncase PM8606_LED2_BLUE:\r\nret = port - PM8606_LED2_RED + PM8606_RGB2B;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic inline int __blink_off(int port)\r\n{\r\nint ret = -EINVAL;\r\nswitch (port) {\r\ncase PM8606_LED1_RED:\r\ncase PM8606_LED1_GREEN:\r\ncase PM8606_LED1_BLUE:\r\nret = PM8606_RGB1A;\r\nbreak;\r\ncase PM8606_LED2_RED:\r\ncase PM8606_LED2_GREEN:\r\ncase PM8606_LED2_BLUE:\r\nret = PM8606_RGB2A;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic inline int __blink_ctl_mask(int port)\r\n{\r\nint ret = -EINVAL;\r\nswitch (port) {\r\ncase PM8606_LED1_RED:\r\ncase PM8606_LED1_GREEN:\r\ncase PM8606_LED1_BLUE:\r\nret = LED1_BLINK_EN;\r\nbreak;\r\ncase PM8606_LED2_RED:\r\ncase PM8606_LED2_GREEN:\r\ncase PM8606_LED2_BLUE:\r\nret = LED2_BLINK_EN;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic void pm860x_led_work(struct work_struct *work)\r\n{\r\nstruct pm860x_led *led;\r\nstruct pm860x_chip *chip;\r\nunsigned char buf[3];\r\nint mask, ret;\r\nled = container_of(work, struct pm860x_led, work);\r\nchip = led->chip;\r\nmutex_lock(&led->lock);\r\nif ((led->current_brightness == 0) && led->brightness) {\r\nif (led->iset) {\r\npm860x_set_bits(led->i2c, __led_off(led->port),\r\nLED_CURRENT_MASK, led->iset);\r\n}\r\npm860x_set_bits(led->i2c, __blink_off(led->port),\r\nLED_BLINK_MASK, LED_ON_CONTINUOUS);\r\nmask = __blink_ctl_mask(led->port);\r\npm860x_set_bits(led->i2c, PM8606_WLED3B, mask, mask);\r\n}\r\npm860x_set_bits(led->i2c, __led_off(led->port), LED_PWM_MASK,\r\nled->brightness);\r\nif (led->brightness == 0) {\r\npm860x_bulk_read(led->i2c, __led_off(led->port), 3, buf);\r\nret = buf[0] & LED_PWM_MASK;\r\nret |= buf[1] & LED_PWM_MASK;\r\nret |= buf[2] & LED_PWM_MASK;\r\nif (ret == 0) {\r\npm860x_set_bits(led->i2c, __led_off(led->port),\r\nLED_CURRENT_MASK, 0);\r\nmask = __blink_ctl_mask(led->port);\r\npm860x_set_bits(led->i2c, PM8606_WLED3B, mask, 0);\r\n}\r\n}\r\nled->current_brightness = led->brightness;\r\ndev_dbg(chip->dev, "Update LED. (reg:%d, brightness:%d)\n",\r\n__led_off(led->port), led->brightness);\r\nmutex_unlock(&led->lock);\r\n}\r\nstatic void pm860x_led_set(struct led_classdev *cdev,\r\nenum led_brightness value)\r\n{\r\nstruct pm860x_led *data = container_of(cdev, struct pm860x_led, cdev);\r\ndata->brightness = value >> 3;\r\nschedule_work(&data->work);\r\n}\r\nstatic int pm860x_led_probe(struct platform_device *pdev)\r\n{\r\nstruct pm860x_chip *chip = dev_get_drvdata(pdev->dev.parent);\r\nstruct pm860x_led_pdata *pdata;\r\nstruct pm860x_led *data;\r\nstruct resource *res;\r\nint ret;\r\nres = platform_get_resource(pdev, IORESOURCE_IO, 0);\r\nif (res == NULL) {\r\ndev_err(&pdev->dev, "No I/O resource!\n");\r\nreturn -EINVAL;\r\n}\r\npdata = pdev->dev.platform_data;\r\nif (pdata == NULL) {\r\ndev_err(&pdev->dev, "No platform data!\n");\r\nreturn -EINVAL;\r\n}\r\ndata = kzalloc(sizeof(struct pm860x_led), GFP_KERNEL);\r\nif (data == NULL)\r\nreturn -ENOMEM;\r\nstrncpy(data->name, res->name, MFD_NAME_SIZE - 1);\r\ndev_set_drvdata(&pdev->dev, data);\r\ndata->chip = chip;\r\ndata->i2c = (chip->id == CHIP_PM8606) ? chip->client : chip->companion;\r\ndata->iset = pdata->iset;\r\ndata->port = pdata->flags;\r\nif (data->port < 0) {\r\ndev_err(&pdev->dev, "check device failed\n");\r\nkfree(data);\r\nreturn -EINVAL;\r\n}\r\ndata->current_brightness = 0;\r\ndata->cdev.name = data->name;\r\ndata->cdev.brightness_set = pm860x_led_set;\r\nmutex_init(&data->lock);\r\nINIT_WORK(&data->work, pm860x_led_work);\r\nret = led_classdev_register(chip->dev, &data->cdev);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Failed to register LED: %d\n", ret);\r\ngoto out;\r\n}\r\npm860x_led_set(&data->cdev, 0);\r\nreturn 0;\r\nout:\r\nkfree(data);\r\nreturn ret;\r\n}\r\nstatic int pm860x_led_remove(struct platform_device *pdev)\r\n{\r\nstruct pm860x_led *data = platform_get_drvdata(pdev);\r\nled_classdev_unregister(&data->cdev);\r\nkfree(data);\r\nreturn 0;\r\n}\r\nstatic int __devinit pm860x_led_init(void)\r\n{\r\nreturn platform_driver_register(&pm860x_led_driver);\r\n}\r\nstatic void __devexit pm860x_led_exit(void)\r\n{\r\nplatform_driver_unregister(&pm860x_led_driver);\r\n}

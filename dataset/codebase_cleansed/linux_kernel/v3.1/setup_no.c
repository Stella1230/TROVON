void parse_uboot_commandline(char *commandp, int size)\r\n{\r\nextern unsigned long _init_sp;\r\nunsigned long *sp;\r\nunsigned long uboot_kbd;\r\nunsigned long uboot_initrd_start, uboot_initrd_end;\r\nunsigned long uboot_cmd_start, uboot_cmd_end;\r\nsp = (unsigned long *)_init_sp;\r\nuboot_kbd = sp[1];\r\nuboot_initrd_start = sp[2];\r\nuboot_initrd_end = sp[3];\r\nuboot_cmd_start = sp[4];\r\nuboot_cmd_end = sp[5];\r\nif (uboot_cmd_start && uboot_cmd_end)\r\nstrncpy(commandp, (const char *)uboot_cmd_start, size);\r\n#if defined(CONFIG_BLK_DEV_INITRD)\r\nif (uboot_initrd_start && uboot_initrd_end &&\r\n(uboot_initrd_end > uboot_initrd_start)) {\r\ninitrd_start = uboot_initrd_start;\r\ninitrd_end = uboot_initrd_end;\r\nROOT_DEV = Root_RAM0;\r\nprintk(KERN_INFO "initrd at 0x%lx:0x%lx\n",\r\ninitrd_start, initrd_end);\r\n}\r\n#endif\r\n}\r\nvoid __init setup_arch(char **cmdline_p)\r\n{\r\nint bootmap_size;\r\nmemory_start = PAGE_ALIGN(_ramstart);\r\nmemory_end = _ramend;\r\ninit_mm.start_code = (unsigned long) &_stext;\r\ninit_mm.end_code = (unsigned long) &_etext;\r\ninit_mm.end_data = (unsigned long) &_edata;\r\ninit_mm.brk = (unsigned long) 0;\r\nconfig_BSP(&command_line[0], sizeof(command_line));\r\n#if defined(CONFIG_BOOTPARAM)\r\nstrncpy(&command_line[0], CONFIG_BOOTPARAM_STRING, sizeof(command_line));\r\ncommand_line[sizeof(command_line) - 1] = 0;\r\n#endif\r\n#if defined(CONFIG_UBOOT)\r\n#if defined(CONFIG_BOOTPARAM)\r\ncommand_line[strlen(CONFIG_BOOTPARAM_STRING)] = ' ';\r\nparse_uboot_commandline(\r\n&command_line[(strlen(CONFIG_BOOTPARAM_STRING)+1)],\r\n(sizeof(command_line) -\r\n(strlen(CONFIG_BOOTPARAM_STRING)+1)));\r\n#else\r\nparse_uboot_commandline(&command_line[0], sizeof(command_line));\r\n#endif\r\ncommand_line[sizeof(command_line) - 1] = 0;\r\n#endif\r\nprintk(KERN_INFO "\x0F\r\n\nuClinux/" CPU_NAME "\n");\r\n#ifdef CONFIG_UCDIMM\r\nprintk(KERN_INFO "uCdimm by Lineo, Inc. <www.lineo.com>\n");\r\n#endif\r\n#ifdef CONFIG_M68VZ328\r\nprintk(KERN_INFO "M68VZ328 support by Evan Stawnyczy <e@lineo.ca>\n");\r\n#endif\r\n#ifdef CONFIG_COLDFIRE\r\nprintk(KERN_INFO "COLDFIRE port done by Greg Ungerer, gerg@snapgear.com\n");\r\n#ifdef CONFIG_M5307\r\nprintk(KERN_INFO "Modified for M5307 by Dave Miller, dmiller@intellistor.com\n");\r\n#endif\r\n#ifdef CONFIG_ELITE\r\nprintk(KERN_INFO "Modified for M5206eLITE by Rob Scott, rscott@mtrob.fdns.net\n");\r\n#endif\r\n#endif\r\nprintk(KERN_INFO "Flat model support (C) 1998,1999 Kenneth Albanowski, D. Jeff Dionne\n");\r\n#if defined( CONFIG_PILOT ) && defined( CONFIG_M68328 )\r\nprintk(KERN_INFO "TRG SuperPilot FLASH card support <info@trgnet.com>\n");\r\n#endif\r\n#if defined( CONFIG_PILOT ) && defined( CONFIG_M68EZ328 )\r\nprintk(KERN_INFO "PalmV support by Lineo Inc. <jeff@uclinux.com>\n");\r\n#endif\r\n#if defined (CONFIG_M68360)\r\nprintk(KERN_INFO "QUICC port done by SED Systems <hamilton@sedsystems.ca>,\n");\r\nprintk(KERN_INFO "based on 2.0.38 port by Lineo Inc. <mleslie@lineo.com>.\n");\r\n#endif\r\n#ifdef CONFIG_DRAGEN2\r\nprintk(KERN_INFO "DragonEngine II board support by Georges Menie\n");\r\n#endif\r\n#ifdef CONFIG_M5235EVB\r\nprintk(KERN_INFO "Motorola M5235EVB support (C)2005 Syn-tech Systems, Inc. (Jate Sujjavanich)\n");\r\n#endif\r\npr_debug("KERNEL -> TEXT=0x%06x-0x%06x DATA=0x%06x-0x%06x "\r\n"BSS=0x%06x-0x%06x\n", (int) &_stext, (int) &_etext,\r\n(int) &_sdata, (int) &_edata,\r\n(int) &_sbss, (int) &_ebss);\r\npr_debug("MEMORY -> ROMFS=0x%06x-0x%06x MEM=0x%06x-0x%06x\n ",\r\n(int) &_ebss, (int) memory_start,\r\n(int) memory_start, (int) memory_end);\r\n*cmdline_p = &command_line[0];\r\nmemcpy(boot_command_line, command_line, COMMAND_LINE_SIZE);\r\nboot_command_line[COMMAND_LINE_SIZE-1] = 0;\r\n#if defined(CONFIG_FRAMEBUFFER_CONSOLE) && defined(CONFIG_DUMMY_CONSOLE)\r\nconswitchp = &dummy_con;\r\n#endif\r\nbootmap_size = init_bootmem_node(\r\nNODE_DATA(0),\r\nmemory_start >> PAGE_SHIFT,\r\nPAGE_OFFSET >> PAGE_SHIFT,\r\nmemory_end >> PAGE_SHIFT);\r\nfree_bootmem(memory_start, memory_end - memory_start);\r\nreserve_bootmem(memory_start, bootmap_size, BOOTMEM_DEFAULT);\r\n#if defined(CONFIG_UBOOT) && defined(CONFIG_BLK_DEV_INITRD)\r\nif ((initrd_start > 0) && (initrd_start < initrd_end) &&\r\n(initrd_end < memory_end))\r\nreserve_bootmem(initrd_start, initrd_end - initrd_start,\r\nBOOTMEM_DEFAULT);\r\n#endif\r\npaging_init();\r\n}\r\nstatic int show_cpuinfo(struct seq_file *m, void *v)\r\n{\r\nchar *cpu, *mmu, *fpu;\r\nu_long clockfreq;\r\ncpu = CPU_NAME;\r\nmmu = "none";\r\nfpu = "none";\r\nclockfreq = (loops_per_jiffy * HZ) * CPU_INSTR_PER_JIFFY;\r\nseq_printf(m, "CPU:\t\t%s\n"\r\n"MMU:\t\t%s\n"\r\n"FPU:\t\t%s\n"\r\n"Clocking:\t%lu.%1luMHz\n"\r\n"BogoMips:\t%lu.%02lu\n"\r\n"Calibration:\t%lu loops\n",\r\ncpu, mmu, fpu,\r\nclockfreq / 1000000,\r\n(clockfreq / 100000) % 10,\r\n(loops_per_jiffy * HZ) / 500000,\r\n((loops_per_jiffy * HZ) / 5000) % 100,\r\n(loops_per_jiffy * HZ));\r\nreturn 0;\r\n}\r\nstatic void *c_start(struct seq_file *m, loff_t *pos)\r\n{\r\nreturn *pos < NR_CPUS ? ((void *) 0x12345678) : NULL;\r\n}\r\nstatic void *c_next(struct seq_file *m, void *v, loff_t *pos)\r\n{\r\n++*pos;\r\nreturn c_start(m, pos);\r\n}\r\nstatic void c_stop(struct seq_file *m, void *v)\r\n{\r\n}

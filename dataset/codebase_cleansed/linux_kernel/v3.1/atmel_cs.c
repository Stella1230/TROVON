static int atmel_probe(struct pcmcia_device *p_dev)\r\n{\r\nlocal_info_t *local;\r\ndev_dbg(&p_dev->dev, "atmel_attach()\n");\r\nlocal = kzalloc(sizeof(local_info_t), GFP_KERNEL);\r\nif (!local) {\r\nprintk(KERN_ERR "atmel_cs: no memory for new device\n");\r\nreturn -ENOMEM;\r\n}\r\np_dev->priv = local;\r\nreturn atmel_config(p_dev);\r\n}\r\nstatic void atmel_detach(struct pcmcia_device *link)\r\n{\r\ndev_dbg(&link->dev, "atmel_detach\n");\r\natmel_release(link);\r\nkfree(link->priv);\r\n}\r\nstatic int card_present(void *arg)\r\n{\r\nstruct pcmcia_device *link = (struct pcmcia_device *)arg;\r\nif (pcmcia_dev_present(link))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int atmel_config_check(struct pcmcia_device *p_dev, void *priv_data)\r\n{\r\nif (p_dev->config_index == 0)\r\nreturn -EINVAL;\r\nreturn pcmcia_request_io(p_dev);\r\n}\r\nstatic int atmel_config(struct pcmcia_device *link)\r\n{\r\nlocal_info_t *dev;\r\nint ret;\r\nconst struct pcmcia_device_id *did;\r\ndev = link->priv;\r\ndid = dev_get_drvdata(&link->dev);\r\ndev_dbg(&link->dev, "atmel_config\n");\r\nlink->config_flags |= CONF_ENABLE_IRQ | CONF_AUTO_SET_VPP |\r\nCONF_AUTO_AUDIO | CONF_AUTO_SET_IO;\r\nif (pcmcia_loop_config(link, atmel_config_check, NULL))\r\ngoto failed;\r\nif (!link->irq) {\r\ndev_err(&link->dev, "atmel: cannot assign IRQ: check that CONFIG_ISA is set in kernel config.");\r\ngoto failed;\r\n}\r\nret = pcmcia_enable_device(link);\r\nif (ret)\r\ngoto failed;\r\n((local_info_t*)link->priv)->eth_dev =\r\ninit_atmel_card(link->irq,\r\nlink->resource[0]->start,\r\ndid ? did->driver_info : ATMEL_FW_TYPE_NONE,\r\n&link->dev,\r\ncard_present,\r\nlink);\r\nif (!((local_info_t*)link->priv)->eth_dev)\r\ngoto failed;\r\nreturn 0;\r\nfailed:\r\natmel_release(link);\r\nreturn -ENODEV;\r\n}\r\nstatic void atmel_release(struct pcmcia_device *link)\r\n{\r\nstruct net_device *dev = ((local_info_t*)link->priv)->eth_dev;\r\ndev_dbg(&link->dev, "atmel_release\n");\r\nif (dev)\r\nstop_atmel_card(dev);\r\n((local_info_t*)link->priv)->eth_dev = NULL;\r\npcmcia_disable_device(link);\r\n}\r\nstatic int atmel_suspend(struct pcmcia_device *link)\r\n{\r\nlocal_info_t *local = link->priv;\r\nnetif_device_detach(local->eth_dev);\r\nreturn 0;\r\n}\r\nstatic int atmel_resume(struct pcmcia_device *link)\r\n{\r\nlocal_info_t *local = link->priv;\r\natmel_open(local->eth_dev);\r\nnetif_device_attach(local->eth_dev);\r\nreturn 0;\r\n}\r\nstatic int __init atmel_cs_init(void)\r\n{\r\nreturn pcmcia_register_driver(&atmel_driver);\r\n}\r\nstatic void __exit atmel_cs_cleanup(void)\r\n{\r\npcmcia_unregister_driver(&atmel_driver);\r\n}

static int collie_power_init(struct device *dev)\r\n{\r\nint ret = gpio_request(COLLIE_GPIO_AC_IN, "ac in");\r\nif (ret)\r\ngoto err_gpio_req;\r\nret = gpio_direction_input(COLLIE_GPIO_AC_IN);\r\nif (ret)\r\ngoto err_gpio_in;\r\nreturn 0;\r\nerr_gpio_in:\r\ngpio_free(COLLIE_GPIO_AC_IN);\r\nerr_gpio_req:\r\nreturn ret;\r\n}\r\nstatic void collie_power_exit(struct device *dev)\r\n{\r\ngpio_free(COLLIE_GPIO_AC_IN);\r\n}\r\nstatic int collie_power_ac_online(void)\r\n{\r\nreturn gpio_get_value(COLLIE_GPIO_AC_IN) == 2;\r\n}\r\nstatic void collie_uart_set_mctrl(struct uart_port *port, u_int mctrl)\r\n{\r\nif (mctrl & TIOCM_RTS)\r\nlocomo_gpio_write(&collie_locomo_device.dev, LOCOMO_GPIO_RTS, 0);\r\nelse\r\nlocomo_gpio_write(&collie_locomo_device.dev, LOCOMO_GPIO_RTS, 1);\r\nif (mctrl & TIOCM_DTR)\r\nlocomo_gpio_write(&collie_locomo_device.dev, LOCOMO_GPIO_DTR, 0);\r\nelse\r\nlocomo_gpio_write(&collie_locomo_device.dev, LOCOMO_GPIO_DTR, 1);\r\n}\r\nstatic u_int collie_uart_get_mctrl(struct uart_port *port)\r\n{\r\nint ret = TIOCM_CD;\r\nunsigned int r;\r\nr = locomo_gpio_read_output(&collie_locomo_device.dev, LOCOMO_GPIO_CTS & LOCOMO_GPIO_DSR);\r\nif (r == -ENODEV)\r\nreturn ret;\r\nif (r & LOCOMO_GPIO_CTS)\r\nret |= TIOCM_CTS;\r\nif (r & LOCOMO_GPIO_DSR)\r\nret |= TIOCM_DSR;\r\nreturn ret;\r\n}\r\nstatic int collie_uart_probe(struct locomo_dev *dev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int collie_uart_remove(struct locomo_dev *dev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int __init collie_uart_init(void)\r\n{\r\nreturn locomo_driver_register(&collie_uart_driver);\r\n}\r\nstatic int collie_flash_init(void)\r\n{\r\nint rc = gpio_request(COLLIE_GPIO_VPEN, "flash Vpp enable");\r\nif (rc)\r\nreturn rc;\r\nrc = gpio_direction_output(COLLIE_GPIO_VPEN, 1);\r\nif (rc)\r\ngpio_free(COLLIE_GPIO_VPEN);\r\nreturn rc;\r\n}\r\nstatic void collie_set_vpp(int vpp)\r\n{\r\ngpio_set_value(COLLIE_GPIO_VPEN, vpp);\r\n}\r\nstatic void collie_flash_exit(void)\r\n{\r\ngpio_free(COLLIE_GPIO_VPEN);\r\n}\r\nstatic void __init collie_init(void)\r\n{\r\nint ret = 0;\r\nGAFR = GPIO_SSP_TXD | GPIO_SSP_SCLK | GPIO_SSP_SFRM | GPIO_SSP_CLK |\r\nGPIO_MCP_CLK | GPIO_32_768kHz;\r\nGPDR = GPIO_LDD8 | GPIO_LDD9 | GPIO_LDD10 | GPIO_LDD11 | GPIO_LDD12 |\r\nGPIO_LDD13 | GPIO_LDD14 | GPIO_LDD15 | GPIO_SSP_TXD |\r\nGPIO_SSP_SCLK | GPIO_SSP_SFRM | GPIO_SDLC_SCLK |\r\n_COLLIE_GPIO_UCB1x00_RESET | _COLLIE_GPIO_nMIC_ON |\r\n_COLLIE_GPIO_nREMOCON_ON | GPIO_32_768kHz;\r\nPPDR = PPC_LDD0 | PPC_LDD1 | PPC_LDD2 | PPC_LDD3 | PPC_LDD4 | PPC_LDD5 |\r\nPPC_LDD6 | PPC_LDD7 | PPC_L_PCLK | PPC_L_LCLK | PPC_L_FCLK | PPC_L_BIAS |\r\nPPC_TXD1 | PPC_TXD2 | PPC_TXD3 | PPC_TXD4 | PPC_SCLK | PPC_SFRM;\r\nPWER = _COLLIE_GPIO_AC_IN | _COLLIE_GPIO_CO | _COLLIE_GPIO_ON_KEY |\r\n_COLLIE_GPIO_WAKEUP | _COLLIE_GPIO_nREMOCON_INT | PWER_RTC;\r\nPGSR = _COLLIE_GPIO_nREMOCON_ON;\r\nPSDR = PPC_RXD1 | PPC_RXD2 | PPC_RXD3 | PPC_RXD4;\r\nPCFR = PCFR_OPDE;\r\nGPSR |= _COLLIE_GPIO_UCB1x00_RESET;\r\nplatform_scoop_config = &collie_pcmcia_config;\r\nret = platform_add_devices(devices, ARRAY_SIZE(devices));\r\nif (ret) {\r\nprintk(KERN_WARNING "collie: Unable to register LoCoMo device\n");\r\n}\r\nsa11x0_register_mtd(&collie_flash_data, collie_flash_resources,\r\nARRAY_SIZE(collie_flash_resources));\r\nsa11x0_register_mcp(&collie_mcp_data);\r\nsharpsl_save_param();\r\n}\r\nstatic void __init collie_map_io(void)\r\n{\r\nsa1100_map_io();\r\niotable_init(collie_io_desc, ARRAY_SIZE(collie_io_desc));\r\n#ifdef CONFIG_SHARP_LOCOMO\r\nsa1100_register_uart_fns(&collie_port_fns);\r\n#endif\r\nsa1100_register_uart(0, 3);\r\nsa1100_register_uart(1, 1);\r\n}

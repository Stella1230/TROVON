static int audmux_open_file(struct inode *inode, struct file *file)\r\n{\r\nfile->private_data = inode->i_private;\r\nreturn 0;\r\n}\r\nstatic const char *audmux_port_string(int port)\r\n{\r\nswitch (port) {\r\ncase MX31_AUDMUX_PORT1_SSI0:\r\nreturn "imx-ssi.0";\r\ncase MX31_AUDMUX_PORT2_SSI1:\r\nreturn "imx-ssi.1";\r\ncase MX31_AUDMUX_PORT3_SSI_PINS_3:\r\nreturn "SSI3";\r\ncase MX31_AUDMUX_PORT4_SSI_PINS_4:\r\nreturn "SSI4";\r\ncase MX31_AUDMUX_PORT5_SSI_PINS_5:\r\nreturn "SSI5";\r\ncase MX31_AUDMUX_PORT6_SSI_PINS_6:\r\nreturn "SSI6";\r\ndefault:\r\nreturn "UNKNOWN";\r\n}\r\n}\r\nstatic ssize_t audmux_read_file(struct file *file, char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nssize_t ret;\r\nchar *buf = kmalloc(PAGE_SIZE, GFP_KERNEL);\r\nint port = (int)file->private_data;\r\nu32 pdcr, ptcr;\r\nif (!buf)\r\nreturn -ENOMEM;\r\nif (audmux_clk)\r\nclk_enable(audmux_clk);\r\nptcr = readl(audmux_base + MXC_AUDMUX_V2_PTCR(port));\r\npdcr = readl(audmux_base + MXC_AUDMUX_V2_PDCR(port));\r\nif (audmux_clk)\r\nclk_disable(audmux_clk);\r\nret = snprintf(buf, PAGE_SIZE, "PDCR: %08x\nPTCR: %08x\n",\r\npdcr, ptcr);\r\nif (ptcr & MXC_AUDMUX_V2_PTCR_TFSDIR)\r\nret += snprintf(buf + ret, PAGE_SIZE - ret,\r\n"TxFS output from %s, ",\r\naudmux_port_string((ptcr >> 27) & 0x7));\r\nelse\r\nret += snprintf(buf + ret, PAGE_SIZE - ret,\r\n"TxFS input, ");\r\nif (ptcr & MXC_AUDMUX_V2_PTCR_TCLKDIR)\r\nret += snprintf(buf + ret, PAGE_SIZE - ret,\r\n"TxClk output from %s",\r\naudmux_port_string((ptcr >> 22) & 0x7));\r\nelse\r\nret += snprintf(buf + ret, PAGE_SIZE - ret,\r\n"TxClk input");\r\nret += snprintf(buf + ret, PAGE_SIZE - ret, "\n");\r\nif (ptcr & MXC_AUDMUX_V2_PTCR_SYN) {\r\nret += snprintf(buf + ret, PAGE_SIZE - ret,\r\n"Port is symmetric");\r\n} else {\r\nif (ptcr & MXC_AUDMUX_V2_PTCR_RFSDIR)\r\nret += snprintf(buf + ret, PAGE_SIZE - ret,\r\n"RxFS output from %s, ",\r\naudmux_port_string((ptcr >> 17) & 0x7));\r\nelse\r\nret += snprintf(buf + ret, PAGE_SIZE - ret,\r\n"RxFS input, ");\r\nif (ptcr & MXC_AUDMUX_V2_PTCR_RCLKDIR)\r\nret += snprintf(buf + ret, PAGE_SIZE - ret,\r\n"RxClk output from %s",\r\naudmux_port_string((ptcr >> 12) & 0x7));\r\nelse\r\nret += snprintf(buf + ret, PAGE_SIZE - ret,\r\n"RxClk input");\r\n}\r\nret += snprintf(buf + ret, PAGE_SIZE - ret,\r\n"\nData received from %s\n",\r\naudmux_port_string((pdcr >> 13) & 0x7));\r\nret = simple_read_from_buffer(user_buf, count, ppos, buf, ret);\r\nkfree(buf);\r\nreturn ret;\r\n}\r\nstatic void audmux_debugfs_init(void)\r\n{\r\nint i;\r\nchar buf[20];\r\naudmux_debugfs_root = debugfs_create_dir("audmux", NULL);\r\nif (!audmux_debugfs_root) {\r\npr_warning("Failed to create AUDMUX debugfs root\n");\r\nreturn;\r\n}\r\nfor (i = 1; i < 8; i++) {\r\nsnprintf(buf, sizeof(buf), "ssi%d", i);\r\nif (!debugfs_create_file(buf, 0444, audmux_debugfs_root,\r\n(void *)i, &audmux_debugfs_fops))\r\npr_warning("Failed to create AUDMUX port %d debugfs file\n",\r\ni);\r\n}\r\n}\r\nstatic inline void audmux_debugfs_init(void)\r\n{\r\n}\r\nint mxc_audmux_v2_configure_port(unsigned int port, unsigned int ptcr,\r\nunsigned int pdcr)\r\n{\r\nif (!audmux_base)\r\nreturn -ENOSYS;\r\nif (audmux_clk)\r\nclk_enable(audmux_clk);\r\nwritel(ptcr, audmux_base + MXC_AUDMUX_V2_PTCR(port));\r\nwritel(pdcr, audmux_base + MXC_AUDMUX_V2_PDCR(port));\r\nif (audmux_clk)\r\nclk_disable(audmux_clk);\r\nreturn 0;\r\n}\r\nstatic int mxc_audmux_v2_init(void)\r\n{\r\nint ret;\r\n#if defined(CONFIG_ARCH_MX5)\r\nif (cpu_is_mx51()) {\r\naudmux_base = MX51_IO_ADDRESS(MX51_AUDMUX_BASE_ADDR);\r\nret = 0;\r\nreturn ret;\r\n}\r\n#endif\r\n#if defined(CONFIG_ARCH_MX3)\r\nif (cpu_is_mx31())\r\naudmux_base = MX31_IO_ADDRESS(MX31_AUDMUX_BASE_ADDR);\r\nelse if (cpu_is_mx35()) {\r\naudmux_clk = clk_get(NULL, "audmux");\r\nif (IS_ERR(audmux_clk)) {\r\nret = PTR_ERR(audmux_clk);\r\nprintk(KERN_ERR "%s: cannot get clock: %d\n", __func__,\r\nret);\r\nreturn ret;\r\n}\r\naudmux_base = MX35_IO_ADDRESS(MX35_AUDMUX_BASE_ADDR);\r\n}\r\n#endif\r\n#if defined(CONFIG_SOC_IMX25)\r\nif (cpu_is_mx25()) {\r\naudmux_clk = clk_get(NULL, "audmux");\r\nif (IS_ERR(audmux_clk)) {\r\nret = PTR_ERR(audmux_clk);\r\nprintk(KERN_ERR "%s: cannot get clock: %d\n", __func__,\r\nret);\r\nreturn ret;\r\n}\r\naudmux_base = MX25_IO_ADDRESS(MX25_AUDMUX_BASE_ADDR);\r\n}\r\n#endif\r\naudmux_debugfs_init();\r\nreturn 0;\r\n}

irqreturn_t radeon_driver_irq_handler_kms(DRM_IRQ_ARGS)\r\n{\r\nstruct drm_device *dev = (struct drm_device *) arg;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nreturn radeon_irq_process(rdev);\r\n}\r\nstatic void radeon_hotplug_work_func(struct work_struct *work)\r\n{\r\nstruct radeon_device *rdev = container_of(work, struct radeon_device,\r\nhotplug_work);\r\nstruct drm_device *dev = rdev->ddev;\r\nstruct drm_mode_config *mode_config = &dev->mode_config;\r\nstruct drm_connector *connector;\r\nif (mode_config->num_connector) {\r\nlist_for_each_entry(connector, &mode_config->connector_list, head)\r\nradeon_connector_hotplug(connector);\r\n}\r\ndrm_helper_hpd_irq_event(dev);\r\n}\r\nvoid radeon_driver_irq_preinstall_kms(struct drm_device *dev)\r\n{\r\nstruct radeon_device *rdev = dev->dev_private;\r\nunsigned i;\r\nrdev->irq.sw_int = false;\r\nrdev->irq.gui_idle = false;\r\nfor (i = 0; i < rdev->num_crtc; i++)\r\nrdev->irq.crtc_vblank_int[i] = false;\r\nfor (i = 0; i < 6; i++) {\r\nrdev->irq.hpd[i] = false;\r\nrdev->irq.pflip[i] = false;\r\n}\r\nradeon_irq_set(rdev);\r\nradeon_irq_process(rdev);\r\n}\r\nint radeon_driver_irq_postinstall_kms(struct drm_device *dev)\r\n{\r\nstruct radeon_device *rdev = dev->dev_private;\r\ndev->max_vblank_count = 0x001fffff;\r\nrdev->irq.sw_int = true;\r\nradeon_irq_set(rdev);\r\nreturn 0;\r\n}\r\nvoid radeon_driver_irq_uninstall_kms(struct drm_device *dev)\r\n{\r\nstruct radeon_device *rdev = dev->dev_private;\r\nunsigned i;\r\nif (rdev == NULL) {\r\nreturn;\r\n}\r\nrdev->irq.sw_int = false;\r\nrdev->irq.gui_idle = false;\r\nfor (i = 0; i < rdev->num_crtc; i++)\r\nrdev->irq.crtc_vblank_int[i] = false;\r\nfor (i = 0; i < 6; i++) {\r\nrdev->irq.hpd[i] = false;\r\nrdev->irq.pflip[i] = false;\r\n}\r\nradeon_irq_set(rdev);\r\n}\r\nint radeon_irq_kms_init(struct radeon_device *rdev)\r\n{\r\nint i;\r\nint r = 0;\r\nINIT_WORK(&rdev->hotplug_work, radeon_hotplug_work_func);\r\nspin_lock_init(&rdev->irq.sw_lock);\r\nfor (i = 0; i < rdev->num_crtc; i++)\r\nspin_lock_init(&rdev->irq.pflip_lock[i]);\r\nr = drm_vblank_init(rdev->ddev, rdev->num_crtc);\r\nif (r) {\r\nreturn r;\r\n}\r\nrdev->msi_enabled = 0;\r\nif ((rdev->family >= CHIP_RV380) &&\r\n((!(rdev->flags & RADEON_IS_IGP)) || (rdev->family >= CHIP_PALM)) &&\r\n(!(rdev->flags & RADEON_IS_AGP))) {\r\nint ret = pci_enable_msi(rdev->pdev);\r\nif (!ret) {\r\nrdev->msi_enabled = 1;\r\ndev_info(rdev->dev, "radeon: using MSI.\n");\r\n}\r\n}\r\nrdev->irq.installed = true;\r\nr = drm_irq_install(rdev->ddev);\r\nif (r) {\r\nrdev->irq.installed = false;\r\nreturn r;\r\n}\r\nDRM_INFO("radeon: irq initialized.\n");\r\nreturn 0;\r\n}\r\nvoid radeon_irq_kms_fini(struct radeon_device *rdev)\r\n{\r\ndrm_vblank_cleanup(rdev->ddev);\r\nif (rdev->irq.installed) {\r\ndrm_irq_uninstall(rdev->ddev);\r\nrdev->irq.installed = false;\r\nif (rdev->msi_enabled)\r\npci_disable_msi(rdev->pdev);\r\n}\r\nflush_work_sync(&rdev->hotplug_work);\r\n}\r\nvoid radeon_irq_kms_sw_irq_get(struct radeon_device *rdev)\r\n{\r\nunsigned long irqflags;\r\nspin_lock_irqsave(&rdev->irq.sw_lock, irqflags);\r\nif (rdev->ddev->irq_enabled && (++rdev->irq.sw_refcount == 1)) {\r\nrdev->irq.sw_int = true;\r\nradeon_irq_set(rdev);\r\n}\r\nspin_unlock_irqrestore(&rdev->irq.sw_lock, irqflags);\r\n}\r\nvoid radeon_irq_kms_sw_irq_put(struct radeon_device *rdev)\r\n{\r\nunsigned long irqflags;\r\nspin_lock_irqsave(&rdev->irq.sw_lock, irqflags);\r\nBUG_ON(rdev->ddev->irq_enabled && rdev->irq.sw_refcount <= 0);\r\nif (rdev->ddev->irq_enabled && (--rdev->irq.sw_refcount == 0)) {\r\nrdev->irq.sw_int = false;\r\nradeon_irq_set(rdev);\r\n}\r\nspin_unlock_irqrestore(&rdev->irq.sw_lock, irqflags);\r\n}\r\nvoid radeon_irq_kms_pflip_irq_get(struct radeon_device *rdev, int crtc)\r\n{\r\nunsigned long irqflags;\r\nif (crtc < 0 || crtc >= rdev->num_crtc)\r\nreturn;\r\nspin_lock_irqsave(&rdev->irq.pflip_lock[crtc], irqflags);\r\nif (rdev->ddev->irq_enabled && (++rdev->irq.pflip_refcount[crtc] == 1)) {\r\nrdev->irq.pflip[crtc] = true;\r\nradeon_irq_set(rdev);\r\n}\r\nspin_unlock_irqrestore(&rdev->irq.pflip_lock[crtc], irqflags);\r\n}\r\nvoid radeon_irq_kms_pflip_irq_put(struct radeon_device *rdev, int crtc)\r\n{\r\nunsigned long irqflags;\r\nif (crtc < 0 || crtc >= rdev->num_crtc)\r\nreturn;\r\nspin_lock_irqsave(&rdev->irq.pflip_lock[crtc], irqflags);\r\nBUG_ON(rdev->ddev->irq_enabled && rdev->irq.pflip_refcount[crtc] <= 0);\r\nif (rdev->ddev->irq_enabled && (--rdev->irq.pflip_refcount[crtc] == 0)) {\r\nrdev->irq.pflip[crtc] = false;\r\nradeon_irq_set(rdev);\r\n}\r\nspin_unlock_irqrestore(&rdev->irq.pflip_lock[crtc], irqflags);\r\n}

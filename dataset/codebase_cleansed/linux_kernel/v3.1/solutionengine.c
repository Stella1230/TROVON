static int __init init_soleng_maps(void)\r\n{\r\nint nr_parts = 0;\r\nsoleng_flash_map.phys = 0;\r\nsoleng_flash_map.virt = (void __iomem *)P2SEGADDR(0);\r\nsoleng_eprom_map.phys = 0x01000000;\r\nsoleng_eprom_map.virt = (void __iomem *)P1SEGADDR(0x01000000);\r\nsimple_map_init(&soleng_eprom_map);\r\nsimple_map_init(&soleng_flash_map);\r\nprintk(KERN_NOTICE "Probing for flash chips at 0x00000000:\n");\r\nflash_mtd = do_map_probe("cfi_probe", &soleng_flash_map);\r\nif (!flash_mtd) {\r\nprintk(KERN_NOTICE "Probing for flash chips at 0x01000000:\n");\r\nsoleng_flash_map.phys = 0x01000000;\r\nsoleng_flash_map.virt = P2SEGADDR(0x01000000);\r\nsoleng_eprom_map.phys = 0;\r\nsoleng_eprom_map.virt = P1SEGADDR(0);\r\nflash_mtd = do_map_probe("cfi_probe", &soleng_flash_map);\r\nif (!flash_mtd) {\r\nprintk(KERN_NOTICE "Flash chips not detected at either possible location.\n");\r\nreturn -ENXIO;\r\n}\r\n}\r\nprintk(KERN_NOTICE "Solution Engine: Flash at 0x%08lx, EPROM at 0x%08lx\n",\r\nsoleng_flash_map.phys & 0x1fffffff,\r\nsoleng_eprom_map.phys & 0x1fffffff);\r\nflash_mtd->owner = THIS_MODULE;\r\neprom_mtd = do_map_probe("map_rom", &soleng_eprom_map);\r\nif (eprom_mtd) {\r\neprom_mtd->owner = THIS_MODULE;\r\nmtd_device_register(eprom_mtd, NULL, 0);\r\n}\r\nnr_parts = parse_mtd_partitions(flash_mtd, probes, &parsed_parts, 0);\r\n#ifdef CONFIG_MTD_SUPERH_RESERVE\r\nif (nr_parts <= 0) {\r\nprintk(KERN_NOTICE "Using configured partition at 0x%08x.\n",\r\nCONFIG_MTD_SUPERH_RESERVE);\r\nparsed_parts = superh_se_partitions;\r\nnr_parts = sizeof(superh_se_partitions)/sizeof(*parsed_parts);\r\n}\r\n#endif\r\nif (nr_parts > 0)\r\nmtd_device_register(flash_mtd, parsed_parts, nr_parts);\r\nelse\r\nmtd_device_register(flash_mtd, NULL, 0);\r\nreturn 0;\r\n}\r\nstatic void __exit cleanup_soleng_maps(void)\r\n{\r\nif (eprom_mtd) {\r\nmtd_device_unregister(eprom_mtd);\r\nmap_destroy(eprom_mtd);\r\n}\r\nif (parsed_parts)\r\nmtd_device_unregister(flash_mtd);\r\nelse\r\nmtd_device_unregister(flash_mtd);\r\nmap_destroy(flash_mtd);\r\n}

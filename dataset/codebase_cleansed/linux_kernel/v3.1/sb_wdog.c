void sbwdog_set(char __iomem *wdog, unsigned long t)\r\n{\r\nspin_lock(&sbwd_lock);\r\n__raw_writeb(0, wdog);\r\n__raw_writeq(t & 0x7fffffUL, wdog - 0x10);\r\nspin_unlock(&sbwd_lock);\r\n}\r\nvoid sbwdog_pet(char __iomem *wdog)\r\n{\r\nspin_lock(&sbwd_lock);\r\n__raw_writeb(__raw_readb(wdog) | 1, wdog);\r\nspin_unlock(&sbwd_lock);\r\n}\r\nstatic int sbwdog_open(struct inode *inode, struct file *file)\r\n{\r\nnonseekable_open(inode, file);\r\nif (test_and_set_bit(0, &sbwdog_gate))\r\nreturn -EBUSY;\r\n__module_get(THIS_MODULE);\r\nsbwdog_set(user_dog, timeout);\r\n__raw_writeb(1, user_dog);\r\nreturn 0;\r\n}\r\nstatic int sbwdog_release(struct inode *inode, struct file *file)\r\n{\r\nif (expect_close == 42) {\r\n__raw_writeb(0, user_dog);\r\nmodule_put(THIS_MODULE);\r\n} else {\r\nprintk(KERN_CRIT\r\n"%s: Unexpected close, not stopping watchdog!\n",\r\nident.identity);\r\nsbwdog_pet(user_dog);\r\n}\r\nclear_bit(0, &sbwdog_gate);\r\nexpect_close = 0;\r\nreturn 0;\r\n}\r\nstatic ssize_t sbwdog_write(struct file *file, const char __user *data,\r\nsize_t len, loff_t *ppos)\r\n{\r\nint i;\r\nif (len) {\r\nexpect_close = 0;\r\nfor (i = 0; i != len; i++) {\r\nchar c;\r\nif (get_user(c, data + i))\r\nreturn -EFAULT;\r\nif (c == 'V')\r\nexpect_close = 42;\r\n}\r\nsbwdog_pet(user_dog);\r\n}\r\nreturn len;\r\n}\r\nstatic long sbwdog_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nint ret = -ENOTTY;\r\nunsigned long time;\r\nvoid __user *argp = (void __user *)arg;\r\nint __user *p = argp;\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nret = copy_to_user(argp, &ident, sizeof(ident)) ? -EFAULT : 0;\r\nbreak;\r\ncase WDIOC_GETSTATUS:\r\ncase WDIOC_GETBOOTSTATUS:\r\nret = put_user(0, p);\r\nbreak;\r\ncase WDIOC_KEEPALIVE:\r\nsbwdog_pet(user_dog);\r\nret = 0;\r\nbreak;\r\ncase WDIOC_SETTIMEOUT:\r\nret = get_user(time, p);\r\nif (ret)\r\nbreak;\r\ntime *= 1000000;\r\nif (time > 0x7fffffUL) {\r\nret = -EINVAL;\r\nbreak;\r\n}\r\ntimeout = time;\r\nsbwdog_set(user_dog, timeout);\r\nsbwdog_pet(user_dog);\r\ncase WDIOC_GETTIMEOUT:\r\nret = put_user(__raw_readq(user_dog - 8) / 1000000, p);\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int sbwdog_notify_sys(struct notifier_block *this, unsigned long code,\r\nvoid *erf)\r\n{\r\nif (code == SYS_DOWN || code == SYS_HALT) {\r\n__raw_writeb(0, user_dog);\r\n__raw_writeb(0, kern_dog);\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nirqreturn_t sbwdog_interrupt(int irq, void *addr)\r\n{\r\nunsigned long wd_init;\r\nchar *wd_cfg_reg = (char *)addr;\r\nu8 cfg;\r\ncfg = __raw_readb(wd_cfg_reg);\r\nwd_init = __raw_readq(wd_cfg_reg - 8) & 0x7fffff;\r\nif (wd_cfg_reg == user_dog)\r\nprintk(KERN_CRIT "%s in danger of initiating system reset "\r\n"in %ld.%01ld seconds\n",\r\nident.identity,\r\nwd_init / 1000000, (wd_init / 100000) % 10);\r\nelse\r\ncfg |= 1;\r\n__raw_writeb(cfg, wd_cfg_reg);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __init sbwdog_init(void)\r\n{\r\nint ret;\r\nret = register_reboot_notifier(&sbwdog_notifier);\r\nif (ret) {\r\nprintk(KERN_ERR\r\n"%s: cannot register reboot notifier (err=%d)\n",\r\nident.identity, ret);\r\nreturn ret;\r\n}\r\nret = request_irq(1, sbwdog_interrupt, IRQF_DISABLED | IRQF_SHARED,\r\nident.identity, (void *)user_dog);\r\nif (ret) {\r\nprintk(KERN_ERR "%s: failed to request irq 1 - %d\n",\r\nident.identity, ret);\r\ngoto out;\r\n}\r\nret = misc_register(&sbwdog_miscdev);\r\nif (ret == 0) {\r\nprintk(KERN_INFO "%s: timeout is %ld.%ld secs\n",\r\nident.identity,\r\ntimeout / 1000000, (timeout / 100000) % 10);\r\nreturn 0;\r\n}\r\nfree_irq(1, (void *)user_dog);\r\nout:\r\nunregister_reboot_notifier(&sbwdog_notifier);\r\nreturn ret;\r\n}\r\nstatic void __exit sbwdog_exit(void)\r\n{\r\nmisc_deregister(&sbwdog_miscdev);\r\nfree_irq(1, (void *)user_dog);\r\nunregister_reboot_notifier(&sbwdog_notifier);\r\n}

static int vt8500lcd_set_par(struct fb_info *info)\r\n{\r\nstruct vt8500lcd_info *fbi = to_vt8500lcd_info(info);\r\nint reg_bpp = 5;\r\nint i;\r\nunsigned long control0;\r\nif (!fbi)\r\nreturn -EINVAL;\r\nif (info->var.bits_per_pixel <= 8) {\r\ninfo->var.red.offset = 0;\r\ninfo->var.red.length = info->var.bits_per_pixel;\r\ninfo->var.red.msb_right = 0;\r\ninfo->var.green.offset = 0;\r\ninfo->var.green.length = info->var.bits_per_pixel;\r\ninfo->var.green.msb_right = 0;\r\ninfo->var.blue.offset = 0;\r\ninfo->var.blue.length = info->var.bits_per_pixel;\r\ninfo->var.blue.msb_right = 0;\r\ninfo->var.transp.offset = 0;\r\ninfo->var.transp.length = 0;\r\ninfo->var.transp.msb_right = 0;\r\ninfo->fix.visual = FB_VISUAL_PSEUDOCOLOR;\r\ninfo->fix.line_length = info->var.xres_virtual /\r\n(8/info->var.bits_per_pixel);\r\n} else {\r\ninfo->var.transp.offset = 0;\r\ninfo->var.transp.length = 0;\r\ninfo->var.transp.msb_right = 0;\r\nif (info->var.bits_per_pixel == 16) {\r\ninfo->var.red.offset = 11;\r\ninfo->var.red.length = 5;\r\ninfo->var.red.msb_right = 0;\r\ninfo->var.green.offset = 5;\r\ninfo->var.green.length = 6;\r\ninfo->var.green.msb_right = 0;\r\ninfo->var.blue.offset = 0;\r\ninfo->var.blue.length = 5;\r\ninfo->var.blue.msb_right = 0;\r\n} else {\r\ninfo->var.red.offset = info->var.bits_per_pixel\r\n* 2 / 3;\r\ninfo->var.red.length = info->var.bits_per_pixel / 3;\r\ninfo->var.red.msb_right = 0;\r\ninfo->var.green.offset = info->var.bits_per_pixel / 3;\r\ninfo->var.green.length = info->var.bits_per_pixel / 3;\r\ninfo->var.green.msb_right = 0;\r\ninfo->var.blue.offset = 0;\r\ninfo->var.blue.length = info->var.bits_per_pixel / 3;\r\ninfo->var.blue.msb_right = 0;\r\n}\r\ninfo->fix.visual = FB_VISUAL_TRUECOLOR;\r\ninfo->fix.line_length = info->var.bits_per_pixel > 16 ?\r\ninfo->var.xres_virtual << 2 :\r\ninfo->var.xres_virtual << 1;\r\n}\r\nfor (i = 0; i < 8; i++) {\r\nif (bpp_values[i] == info->var.bits_per_pixel) {\r\nreg_bpp = i;\r\ncontinue;\r\n}\r\n}\r\ncontrol0 = readl(fbi->regbase) & ~0xf;\r\nwritel(0, fbi->regbase);\r\nwhile (readl(fbi->regbase + 0x38) & 0x10)\r\n;\r\nwritel((((info->var.hsync_len - 1) & 0x3f) << 26)\r\n| ((info->var.left_margin & 0xff) << 18)\r\n| (((info->var.xres - 1) & 0x3ff) << 8)\r\n| (info->var.right_margin & 0xff), fbi->regbase + 0x4);\r\nwritel((((info->var.vsync_len - 1) & 0x3f) << 26)\r\n| ((info->var.upper_margin & 0xff) << 18)\r\n| (((info->var.yres - 1) & 0x3ff) << 8)\r\n| (info->var.lower_margin & 0xff), fbi->regbase + 0x8);\r\nwritel((((info->var.yres - 1) & 0x400) << 2)\r\n| ((info->var.xres - 1) & 0x400), fbi->regbase + 0x10);\r\nwritel(0x80000000, fbi->regbase + 0x20);\r\nwritel(control0 | (reg_bpp << 1) | 0x100, fbi->regbase);\r\nreturn 0;\r\n}\r\nstatic inline u_int chan_to_field(u_int chan, struct fb_bitfield *bf)\r\n{\r\nchan &= 0xffff;\r\nchan >>= 16 - bf->length;\r\nreturn chan << bf->offset;\r\n}\r\nstatic int vt8500lcd_setcolreg(unsigned regno, unsigned red, unsigned green,\r\nunsigned blue, unsigned transp,\r\nstruct fb_info *info) {\r\nstruct vt8500lcd_info *fbi = to_vt8500lcd_info(info);\r\nint ret = 1;\r\nunsigned int val;\r\nif (regno >= 256)\r\nreturn -EINVAL;\r\nif (info->var.grayscale)\r\nred = green = blue =\r\n(19595 * red + 38470 * green + 7471 * blue) >> 16;\r\nswitch (fbi->fb.fix.visual) {\r\ncase FB_VISUAL_TRUECOLOR:\r\nif (regno < 16) {\r\nu32 *pal = fbi->fb.pseudo_palette;\r\nval = chan_to_field(red, &fbi->fb.var.red);\r\nval |= chan_to_field(green, &fbi->fb.var.green);\r\nval |= chan_to_field(blue, &fbi->fb.var.blue);\r\npal[regno] = val;\r\nret = 0;\r\n}\r\nbreak;\r\ncase FB_VISUAL_STATIC_PSEUDOCOLOR:\r\ncase FB_VISUAL_PSEUDOCOLOR:\r\nwritew((red & 0xf800)\r\n| ((green >> 5) & 0x7e0)\r\n| ((blue >> 11) & 0x1f),\r\nfbi->palette_cpu + sizeof(u16) * regno);\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int vt8500lcd_ioctl(struct fb_info *info, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nint ret = 0;\r\nstruct vt8500lcd_info *fbi = to_vt8500lcd_info(info);\r\nif (cmd == FBIO_WAITFORVSYNC) {\r\nwritel(0xffffffff ^ (1 << 3), fbi->regbase + 0x3c);\r\nret = wait_event_interruptible_timeout(fbi->wait,\r\nreadl(fbi->regbase + 0x38) & (1 << 3), HZ / 10);\r\nwritel(0xffffffff, fbi->regbase + 0x3c);\r\nif (ret < 0)\r\nreturn ret;\r\nif (ret == 0)\r\nreturn -ETIMEDOUT;\r\n}\r\nreturn ret;\r\n}\r\nstatic int vt8500lcd_pan_display(struct fb_var_screeninfo *var,\r\nstruct fb_info *info)\r\n{\r\nunsigned pixlen = info->fix.line_length / info->var.xres_virtual;\r\nunsigned off = pixlen * var->xoffset\r\n+ info->fix.line_length * var->yoffset;\r\nstruct vt8500lcd_info *fbi = to_vt8500lcd_info(info);\r\nwritel((1 << 31)\r\n| (((var->xres_virtual - var->xres) * pixlen / 4) << 20)\r\n| (off >> 2), fbi->regbase + 0x20);\r\nreturn 0;\r\n}\r\nstatic int vt8500lcd_blank(int blank, struct fb_info *info)\r\n{\r\nint i;\r\nswitch (blank) {\r\ncase FB_BLANK_POWERDOWN:\r\ncase FB_BLANK_VSYNC_SUSPEND:\r\ncase FB_BLANK_HSYNC_SUSPEND:\r\ncase FB_BLANK_NORMAL:\r\nif (info->fix.visual == FB_VISUAL_PSEUDOCOLOR ||\r\ninfo->fix.visual == FB_VISUAL_STATIC_PSEUDOCOLOR)\r\nfor (i = 0; i < 256; i++)\r\nvt8500lcd_setcolreg(i, 0, 0, 0, 0, info);\r\ncase FB_BLANK_UNBLANK:\r\nif (info->fix.visual == FB_VISUAL_PSEUDOCOLOR ||\r\ninfo->fix.visual == FB_VISUAL_STATIC_PSEUDOCOLOR)\r\nfb_set_cmap(&info->cmap, info);\r\n}\r\nreturn 0;\r\n}\r\nstatic irqreturn_t vt8500lcd_handle_irq(int irq, void *dev_id)\r\n{\r\nstruct vt8500lcd_info *fbi = dev_id;\r\nif (readl(fbi->regbase + 0x38) & (1 << 3))\r\nwake_up_interruptible(&fbi->wait);\r\nwritel(0xffffffff, fbi->regbase + 0x38);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __devinit vt8500lcd_probe(struct platform_device *pdev)\r\n{\r\nstruct vt8500lcd_info *fbi;\r\nstruct resource *res;\r\nstruct vt8500fb_platform_data *pdata = pdev->dev.platform_data;\r\nvoid *addr;\r\nint irq, ret;\r\nret = -ENOMEM;\r\nfbi = NULL;\r\nfbi = kzalloc(sizeof(struct vt8500lcd_info) + sizeof(u32) * 16,\r\nGFP_KERNEL);\r\nif (!fbi) {\r\ndev_err(&pdev->dev, "Failed to initialize framebuffer device\n");\r\nret = -ENOMEM;\r\ngoto failed;\r\n}\r\nstrcpy(fbi->fb.fix.id, "VT8500 LCD");\r\nfbi->fb.fix.type = FB_TYPE_PACKED_PIXELS;\r\nfbi->fb.fix.xpanstep = 0;\r\nfbi->fb.fix.ypanstep = 1;\r\nfbi->fb.fix.ywrapstep = 0;\r\nfbi->fb.fix.accel = FB_ACCEL_NONE;\r\nfbi->fb.var.nonstd = 0;\r\nfbi->fb.var.activate = FB_ACTIVATE_NOW;\r\nfbi->fb.var.height = -1;\r\nfbi->fb.var.width = -1;\r\nfbi->fb.var.vmode = FB_VMODE_NONINTERLACED;\r\nfbi->fb.fbops = &vt8500lcd_ops;\r\nfbi->fb.flags = FBINFO_DEFAULT\r\n| FBINFO_HWACCEL_COPYAREA\r\n| FBINFO_HWACCEL_FILLRECT\r\n| FBINFO_HWACCEL_YPAN\r\n| FBINFO_VIRTFB\r\n| FBINFO_PARTIAL_PAN_OK;\r\nfbi->fb.node = -1;\r\naddr = fbi;\r\naddr = addr + sizeof(struct vt8500lcd_info);\r\nfbi->fb.pseudo_palette = addr;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (res == NULL) {\r\ndev_err(&pdev->dev, "no I/O memory resource defined\n");\r\nret = -ENODEV;\r\ngoto failed_fbi;\r\n}\r\nres = request_mem_region(res->start, resource_size(res), "vt8500lcd");\r\nif (res == NULL) {\r\ndev_err(&pdev->dev, "failed to request I/O memory\n");\r\nret = -EBUSY;\r\ngoto failed_fbi;\r\n}\r\nfbi->regbase = ioremap(res->start, resource_size(res));\r\nif (fbi->regbase == NULL) {\r\ndev_err(&pdev->dev, "failed to map I/O memory\n");\r\nret = -EBUSY;\r\ngoto failed_free_res;\r\n}\r\nfbi->fb.fix.smem_start = pdata->video_mem_phys;\r\nfbi->fb.fix.smem_len = pdata->video_mem_len;\r\nfbi->fb.screen_base = pdata->video_mem_virt;\r\nfbi->palette_size = PAGE_ALIGN(512);\r\nfbi->palette_cpu = dma_alloc_coherent(&pdev->dev,\r\nfbi->palette_size,\r\n&fbi->palette_phys,\r\nGFP_KERNEL);\r\nif (fbi->palette_cpu == NULL) {\r\ndev_err(&pdev->dev, "Failed to allocate palette buffer\n");\r\nret = -ENOMEM;\r\ngoto failed_free_io;\r\n}\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\ndev_err(&pdev->dev, "no IRQ defined\n");\r\nret = -ENODEV;\r\ngoto failed_free_palette;\r\n}\r\nret = request_irq(irq, vt8500lcd_handle_irq, IRQF_DISABLED, "LCD", fbi);\r\nif (ret) {\r\ndev_err(&pdev->dev, "request_irq failed: %d\n", ret);\r\nret = -EBUSY;\r\ngoto failed_free_palette;\r\n}\r\ninit_waitqueue_head(&fbi->wait);\r\nif (fb_alloc_cmap(&fbi->fb.cmap, 256, 0) < 0) {\r\ndev_err(&pdev->dev, "Failed to allocate color map\n");\r\nret = -ENOMEM;\r\ngoto failed_free_irq;\r\n}\r\nfb_videomode_to_var(&fbi->fb.var, &pdata->mode);\r\nfbi->fb.var.bits_per_pixel = pdata->bpp;\r\nfbi->fb.var.xres_virtual = pdata->xres_virtual;\r\nfbi->fb.var.yres_virtual = pdata->yres_virtual;\r\nret = vt8500lcd_set_par(&fbi->fb);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to set parameters\n");\r\ngoto failed_free_cmap;\r\n}\r\nwritel(fbi->fb.fix.smem_start >> 22, fbi->regbase + 0x1c);\r\nwritel((fbi->palette_phys & 0xfffffe00) | 1, fbi->regbase + 0x18);\r\nplatform_set_drvdata(pdev, fbi);\r\nret = register_framebuffer(&fbi->fb);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev,\r\n"Failed to register framebuffer device: %d\n", ret);\r\ngoto failed_free_cmap;\r\n}\r\nwritel(readl(fbi->regbase) | 1, fbi->regbase);\r\nreturn 0;\r\nfailed_free_cmap:\r\nif (fbi->fb.cmap.len)\r\nfb_dealloc_cmap(&fbi->fb.cmap);\r\nfailed_free_irq:\r\nfree_irq(irq, fbi);\r\nfailed_free_palette:\r\ndma_free_coherent(&pdev->dev, fbi->palette_size,\r\nfbi->palette_cpu, fbi->palette_phys);\r\nfailed_free_io:\r\niounmap(fbi->regbase);\r\nfailed_free_res:\r\nrelease_mem_region(res->start, resource_size(res));\r\nfailed_fbi:\r\nplatform_set_drvdata(pdev, NULL);\r\nkfree(fbi);\r\nfailed:\r\nreturn ret;\r\n}\r\nstatic int __devexit vt8500lcd_remove(struct platform_device *pdev)\r\n{\r\nstruct vt8500lcd_info *fbi = platform_get_drvdata(pdev);\r\nstruct resource *res;\r\nint irq;\r\nunregister_framebuffer(&fbi->fb);\r\nwritel(0, fbi->regbase);\r\nif (fbi->fb.cmap.len)\r\nfb_dealloc_cmap(&fbi->fb.cmap);\r\nirq = platform_get_irq(pdev, 0);\r\nfree_irq(irq, fbi);\r\ndma_free_coherent(&pdev->dev, fbi->palette_size,\r\nfbi->palette_cpu, fbi->palette_phys);\r\niounmap(fbi->regbase);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nrelease_mem_region(res->start, resource_size(res));\r\nkfree(fbi);\r\nreturn 0;\r\n}\r\nstatic int __init vt8500lcd_init(void)\r\n{\r\nreturn platform_driver_register(&vt8500lcd_driver);\r\n}\r\nstatic void __exit vt8500lcd_exit(void)\r\n{\r\nplatform_driver_unregister(&vt8500lcd_driver);\r\n}

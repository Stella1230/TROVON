static inline unsigned long kvirt_to_pa(unsigned long adr)\r\n{\r\nunsigned long kva, ret;\r\nkva = (unsigned long) page_address(vmalloc_to_page((void *)adr));\r\nkva |= adr & (PAGE_SIZE-1);\r\nret = __pa(kva);\r\nreturn ret;\r\n}\r\nstatic void *rvmalloc(unsigned long size)\r\n{\r\nvoid *mem;\r\nunsigned long adr;\r\nsize = PAGE_ALIGN(size);\r\nmem = vmalloc_32(size);\r\nif (!mem)\r\nreturn NULL;\r\nmemset(mem, 0, size);\r\nadr = (unsigned long) mem;\r\nwhile ((long)size > 0) {\r\nSetPageReserved(vmalloc_to_page((void *)adr));\r\nadr += PAGE_SIZE;\r\nsize -= PAGE_SIZE;\r\n}\r\nreturn mem;\r\n}\r\nstatic void rvfree(void *mem, unsigned long size)\r\n{\r\nunsigned long adr;\r\nif (!mem)\r\nreturn;\r\nsize = PAGE_ALIGN(size);\r\nadr = (unsigned long) mem;\r\nwhile ((long)size > 0) {\r\nClearPageReserved(vmalloc_to_page((void *)adr));\r\nadr += PAGE_SIZE;\r\nsize -= PAGE_SIZE;\r\n}\r\nvfree(mem);\r\n}\r\nint cpia2_do_command(struct camera_data *cam,\r\nu32 command, u8 direction, u8 param)\r\n{\r\nint retval = 0;\r\nstruct cpia2_command cmd;\r\nunsigned int device = cam->params.pnp_id.device_type;\r\ncmd.command = command;\r\ncmd.reg_count = 2;\r\ncmd.direction = direction;\r\nswitch (command) {\r\ncase CPIA2_CMD_GET_VERSION:\r\ncmd.req_mode =\r\nCAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_SYSTEM;\r\ncmd.start = CPIA2_SYSTEM_DEVICE_HI;\r\nbreak;\r\ncase CPIA2_CMD_GET_PNP_ID:\r\ncmd.req_mode =\r\nCAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_SYSTEM;\r\ncmd.reg_count = 8;\r\ncmd.start = CPIA2_SYSTEM_DESCRIP_VID_HI;\r\nbreak;\r\ncase CPIA2_CMD_GET_ASIC_TYPE:\r\ncmd.req_mode = CAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_VC;\r\ncmd.start = CPIA2_VC_ASIC_ID;\r\nbreak;\r\ncase CPIA2_CMD_GET_SENSOR:\r\ncmd.req_mode = CAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_VP;\r\ncmd.start = CPIA2_VP_SENSOR_FLAGS;\r\nbreak;\r\ncase CPIA2_CMD_GET_VP_DEVICE:\r\ncmd.req_mode = CAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_VP;\r\ncmd.start = CPIA2_VP_DEVICEH;\r\nbreak;\r\ncase CPIA2_CMD_SET_VP_BRIGHTNESS:\r\ncmd.buffer.block_data[0] = param;\r\ncase CPIA2_CMD_GET_VP_BRIGHTNESS:\r\ncmd.req_mode = CAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_VP;\r\ncmd.reg_count = 1;\r\nif (device == DEVICE_STV_672)\r\ncmd.start = CPIA2_VP4_EXPOSURE_TARGET;\r\nelse\r\ncmd.start = CPIA2_VP5_EXPOSURE_TARGET;\r\nbreak;\r\ncase CPIA2_CMD_SET_CONTRAST:\r\ncmd.buffer.block_data[0] = param;\r\ncase CPIA2_CMD_GET_CONTRAST:\r\ncmd.req_mode = CAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_VP;\r\ncmd.reg_count = 1;\r\ncmd.start = CPIA2_VP_YRANGE;\r\nbreak;\r\ncase CPIA2_CMD_SET_VP_SATURATION:\r\ncmd.buffer.block_data[0] = param;\r\ncase CPIA2_CMD_GET_VP_SATURATION:\r\ncmd.req_mode = CAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_VP;\r\ncmd.reg_count = 1;\r\nif (device == DEVICE_STV_672)\r\ncmd.start = CPIA2_VP_SATURATION;\r\nelse\r\ncmd.start = CPIA2_VP5_MCUVSATURATION;\r\nbreak;\r\ncase CPIA2_CMD_SET_VP_GPIO_DATA:\r\ncmd.buffer.block_data[0] = param;\r\ncase CPIA2_CMD_GET_VP_GPIO_DATA:\r\ncmd.req_mode = CAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_VP;\r\ncmd.reg_count = 1;\r\ncmd.start = CPIA2_VP_GPIO_DATA;\r\nbreak;\r\ncase CPIA2_CMD_SET_VP_GPIO_DIRECTION:\r\ncmd.buffer.block_data[0] = param;\r\ncase CPIA2_CMD_GET_VP_GPIO_DIRECTION:\r\ncmd.req_mode = CAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_VP;\r\ncmd.reg_count = 1;\r\ncmd.start = CPIA2_VP_GPIO_DIRECTION;\r\nbreak;\r\ncase CPIA2_CMD_SET_VC_MP_GPIO_DATA:\r\ncmd.buffer.block_data[0] = param;\r\ncase CPIA2_CMD_GET_VC_MP_GPIO_DATA:\r\ncmd.req_mode = CAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_VC;\r\ncmd.reg_count = 1;\r\ncmd.start = CPIA2_VC_MP_DATA;\r\nbreak;\r\ncase CPIA2_CMD_SET_VC_MP_GPIO_DIRECTION:\r\ncmd.buffer.block_data[0] = param;\r\ncase CPIA2_CMD_GET_VC_MP_GPIO_DIRECTION:\r\ncmd.req_mode = CAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_VC;\r\ncmd.reg_count = 1;\r\ncmd.start = CPIA2_VC_MP_DIR;\r\nbreak;\r\ncase CPIA2_CMD_ENABLE_PACKET_CTRL:\r\ncmd.req_mode =\r\nCAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_SYSTEM;\r\ncmd.start = CPIA2_SYSTEM_INT_PACKET_CTRL;\r\ncmd.reg_count = 1;\r\ncmd.buffer.block_data[0] = param;\r\nbreak;\r\ncase CPIA2_CMD_SET_FLICKER_MODES:\r\ncmd.buffer.block_data[0] = param;\r\ncase CPIA2_CMD_GET_FLICKER_MODES:\r\ncmd.req_mode = CAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_VP;\r\ncmd.reg_count = 1;\r\ncmd.start = CPIA2_VP_FLICKER_MODES;\r\nbreak;\r\ncase CPIA2_CMD_RESET_FIFO:\r\ncmd.req_mode = CAMERAACCESS_TYPE_RANDOM | CAMERAACCESS_VC;\r\ncmd.reg_count = 2;\r\ncmd.start = 0;\r\ncmd.buffer.registers[0].index = CPIA2_VC_ST_CTRL;\r\ncmd.buffer.registers[0].value = CPIA2_VC_ST_CTRL_SRC_VC |\r\nCPIA2_VC_ST_CTRL_DST_USB | CPIA2_VC_ST_CTRL_EOF_DETECT;\r\ncmd.buffer.registers[1].index = CPIA2_VC_ST_CTRL;\r\ncmd.buffer.registers[1].value = CPIA2_VC_ST_CTRL_SRC_VC |\r\nCPIA2_VC_ST_CTRL_DST_USB |\r\nCPIA2_VC_ST_CTRL_EOF_DETECT |\r\nCPIA2_VC_ST_CTRL_FIFO_ENABLE;\r\nbreak;\r\ncase CPIA2_CMD_SET_HI_POWER:\r\ncmd.req_mode =\r\nCAMERAACCESS_TYPE_RANDOM | CAMERAACCESS_SYSTEM;\r\ncmd.reg_count = 2;\r\ncmd.buffer.registers[0].index =\r\nCPIA2_SYSTEM_SYSTEM_CONTROL;\r\ncmd.buffer.registers[1].index =\r\nCPIA2_SYSTEM_SYSTEM_CONTROL;\r\ncmd.buffer.registers[0].value = CPIA2_SYSTEM_CONTROL_CLEAR_ERR;\r\ncmd.buffer.registers[1].value =\r\nCPIA2_SYSTEM_CONTROL_HIGH_POWER;\r\nbreak;\r\ncase CPIA2_CMD_SET_LOW_POWER:\r\ncmd.req_mode =\r\nCAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_SYSTEM;\r\ncmd.reg_count = 1;\r\ncmd.start = CPIA2_SYSTEM_SYSTEM_CONTROL;\r\ncmd.buffer.block_data[0] = 0;\r\nbreak;\r\ncase CPIA2_CMD_CLEAR_V2W_ERR:\r\ncmd.req_mode =\r\nCAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_SYSTEM;\r\ncmd.reg_count = 1;\r\ncmd.start = CPIA2_SYSTEM_SYSTEM_CONTROL;\r\ncmd.buffer.block_data[0] = CPIA2_SYSTEM_CONTROL_CLEAR_ERR;\r\nbreak;\r\ncase CPIA2_CMD_SET_USER_MODE:\r\ncmd.buffer.block_data[0] = param;\r\ncase CPIA2_CMD_GET_USER_MODE:\r\ncmd.req_mode = CAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_VP;\r\ncmd.reg_count = 1;\r\nif (device == DEVICE_STV_672)\r\ncmd.start = CPIA2_VP4_USER_MODE;\r\nelse\r\ncmd.start = CPIA2_VP5_USER_MODE;\r\nbreak;\r\ncase CPIA2_CMD_FRAMERATE_REQ:\r\ncmd.req_mode = CAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_VP;\r\ncmd.reg_count = 1;\r\nif (device == DEVICE_STV_672)\r\ncmd.start = CPIA2_VP4_FRAMERATE_REQUEST;\r\nelse\r\ncmd.start = CPIA2_VP5_FRAMERATE_REQUEST;\r\ncmd.buffer.block_data[0] = param;\r\nbreak;\r\ncase CPIA2_CMD_SET_WAKEUP:\r\ncmd.buffer.block_data[0] = param;\r\ncase CPIA2_CMD_GET_WAKEUP:\r\ncmd.req_mode = CAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_VC;\r\ncmd.reg_count = 1;\r\ncmd.start = CPIA2_VC_WAKEUP;\r\nbreak;\r\ncase CPIA2_CMD_SET_PW_CONTROL:\r\ncmd.buffer.block_data[0] = param;\r\ncase CPIA2_CMD_GET_PW_CONTROL:\r\ncmd.req_mode = CAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_VC;\r\ncmd.reg_count = 1;\r\ncmd.start = CPIA2_VC_PW_CTRL;\r\nbreak;\r\ncase CPIA2_CMD_GET_VP_SYSTEM_STATE:\r\ncmd.req_mode = CAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_VP;\r\ncmd.reg_count = 1;\r\ncmd.start = CPIA2_VP_SYSTEMSTATE;\r\nbreak;\r\ncase CPIA2_CMD_SET_SYSTEM_CTRL:\r\ncmd.buffer.block_data[0] = param;\r\ncase CPIA2_CMD_GET_SYSTEM_CTRL:\r\ncmd.req_mode =\r\nCAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_SYSTEM;\r\ncmd.reg_count = 1;\r\ncmd.start = CPIA2_SYSTEM_SYSTEM_CONTROL;\r\nbreak;\r\ncase CPIA2_CMD_SET_VP_SYSTEM_CTRL:\r\ncmd.buffer.block_data[0] = param;\r\ncase CPIA2_CMD_GET_VP_SYSTEM_CTRL:\r\ncmd.req_mode = CAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_VP;\r\ncmd.reg_count = 1;\r\ncmd.start = CPIA2_VP_SYSTEMCTRL;\r\nbreak;\r\ncase CPIA2_CMD_SET_VP_EXP_MODES:\r\ncmd.buffer.block_data[0] = param;\r\ncase CPIA2_CMD_GET_VP_EXP_MODES:\r\ncmd.req_mode = CAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_VP;\r\ncmd.reg_count = 1;\r\ncmd.start = CPIA2_VP_EXPOSURE_MODES;\r\nbreak;\r\ncase CPIA2_CMD_SET_DEVICE_CONFIG:\r\ncmd.buffer.block_data[0] = param;\r\ncase CPIA2_CMD_GET_DEVICE_CONFIG:\r\ncmd.req_mode = CAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_VP;\r\ncmd.reg_count = 1;\r\ncmd.start = CPIA2_VP_DEVICE_CONFIG;\r\nbreak;\r\ncase CPIA2_CMD_SET_SERIAL_ADDR:\r\ncmd.buffer.block_data[0] = param;\r\ncmd.req_mode =\r\nCAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_SYSTEM;\r\ncmd.reg_count = 1;\r\ncmd.start = CPIA2_SYSTEM_VP_SERIAL_ADDR;\r\nbreak;\r\ncase CPIA2_CMD_SET_SENSOR_CR1:\r\ncmd.buffer.block_data[0] = param;\r\ncmd.req_mode = CAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_VP;\r\ncmd.reg_count = 1;\r\ncmd.start = CPIA2_SENSOR_CR1;\r\nbreak;\r\ncase CPIA2_CMD_SET_VC_CONTROL:\r\ncmd.buffer.block_data[0] = param;\r\ncase CPIA2_CMD_GET_VC_CONTROL:\r\ncmd.req_mode = CAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_VC;\r\ncmd.reg_count = 1;\r\ncmd.start = CPIA2_VC_VC_CTRL;\r\nbreak;\r\ncase CPIA2_CMD_SET_TARGET_KB:\r\ncmd.req_mode = CAMERAACCESS_TYPE_RANDOM | CAMERAACCESS_VC;\r\ncmd.reg_count = 1;\r\ncmd.buffer.registers[0].index = CPIA2_VC_VC_TARGET_KB;\r\ncmd.buffer.registers[0].value = param;\r\nbreak;\r\ncase CPIA2_CMD_SET_DEF_JPEG_OPT:\r\ncmd.req_mode = CAMERAACCESS_TYPE_RANDOM | CAMERAACCESS_VC;\r\ncmd.reg_count = 4;\r\ncmd.buffer.registers[0].index = CPIA2_VC_VC_JPEG_OPT;\r\ncmd.buffer.registers[0].value =\r\nCPIA2_VC_VC_JPEG_OPT_DOUBLE_SQUEEZE;\r\ncmd.buffer.registers[1].index = CPIA2_VC_VC_USER_SQUEEZE;\r\ncmd.buffer.registers[1].value = 20;\r\ncmd.buffer.registers[2].index = CPIA2_VC_VC_CREEP_PERIOD;\r\ncmd.buffer.registers[2].value = 2;\r\ncmd.buffer.registers[3].index = CPIA2_VC_VC_JPEG_OPT;\r\ncmd.buffer.registers[3].value = CPIA2_VC_VC_JPEG_OPT_DEFAULT;\r\nbreak;\r\ncase CPIA2_CMD_REHASH_VP4:\r\ncmd.req_mode = CAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_VP;\r\ncmd.reg_count = 1;\r\ncmd.start = CPIA2_VP_REHASH_VALUES;\r\ncmd.buffer.block_data[0] = param;\r\nbreak;\r\ncase CPIA2_CMD_SET_USER_EFFECTS:\r\ncmd.buffer.block_data[0] = param;\r\ncase CPIA2_CMD_GET_USER_EFFECTS:\r\ncmd.req_mode = CAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_VP;\r\ncmd.reg_count = 1;\r\nif (device == DEVICE_STV_672)\r\ncmd.start = CPIA2_VP4_USER_EFFECTS;\r\nelse\r\ncmd.start = CPIA2_VP5_USER_EFFECTS;\r\nbreak;\r\ndefault:\r\nLOG("DoCommand received invalid command\n");\r\nreturn -EINVAL;\r\n}\r\nretval = cpia2_send_command(cam, &cmd);\r\nif (retval) {\r\nreturn retval;\r\n}\r\nswitch (command) {\r\ncase CPIA2_CMD_GET_VERSION:\r\ncam->params.version.firmware_revision_hi =\r\ncmd.buffer.block_data[0];\r\ncam->params.version.firmware_revision_lo =\r\ncmd.buffer.block_data[1];\r\nbreak;\r\ncase CPIA2_CMD_GET_PNP_ID:\r\ncam->params.pnp_id.vendor = (cmd.buffer.block_data[0] << 8) |\r\ncmd.buffer.block_data[1];\r\ncam->params.pnp_id.product = (cmd.buffer.block_data[2] << 8) |\r\ncmd.buffer.block_data[3];\r\ncam->params.pnp_id.device_revision =\r\n(cmd.buffer.block_data[4] << 8) |\r\ncmd.buffer.block_data[5];\r\nif (cam->params.pnp_id.vendor == 0x553) {\r\nif (cam->params.pnp_id.product == 0x100) {\r\ncam->params.pnp_id.device_type = DEVICE_STV_672;\r\n} else if (cam->params.pnp_id.product == 0x140 ||\r\ncam->params.pnp_id.product == 0x151) {\r\ncam->params.pnp_id.device_type = DEVICE_STV_676;\r\n}\r\n}\r\nbreak;\r\ncase CPIA2_CMD_GET_ASIC_TYPE:\r\ncam->params.version.asic_id = cmd.buffer.block_data[0];\r\ncam->params.version.asic_rev = cmd.buffer.block_data[1];\r\nbreak;\r\ncase CPIA2_CMD_GET_SENSOR:\r\ncam->params.version.sensor_flags = cmd.buffer.block_data[0];\r\ncam->params.version.sensor_rev = cmd.buffer.block_data[1];\r\nbreak;\r\ncase CPIA2_CMD_GET_VP_DEVICE:\r\ncam->params.version.vp_device_hi = cmd.buffer.block_data[0];\r\ncam->params.version.vp_device_lo = cmd.buffer.block_data[1];\r\nbreak;\r\ncase CPIA2_CMD_GET_VP_BRIGHTNESS:\r\ncam->params.color_params.brightness = cmd.buffer.block_data[0];\r\nbreak;\r\ncase CPIA2_CMD_GET_CONTRAST:\r\ncam->params.color_params.contrast = cmd.buffer.block_data[0];\r\nbreak;\r\ncase CPIA2_CMD_GET_VP_SATURATION:\r\ncam->params.color_params.saturation = cmd.buffer.block_data[0];\r\nbreak;\r\ncase CPIA2_CMD_GET_VP_GPIO_DATA:\r\ncam->params.vp_params.gpio_data = cmd.buffer.block_data[0];\r\nbreak;\r\ncase CPIA2_CMD_GET_VP_GPIO_DIRECTION:\r\ncam->params.vp_params.gpio_direction = cmd.buffer.block_data[0];\r\nbreak;\r\ncase CPIA2_CMD_GET_VC_MP_GPIO_DIRECTION:\r\ncam->params.vc_params.vc_mp_direction =cmd.buffer.block_data[0];\r\nbreak;\r\ncase CPIA2_CMD_GET_VC_MP_GPIO_DATA:\r\ncam->params.vc_params.vc_mp_data = cmd.buffer.block_data[0];\r\nbreak;\r\ncase CPIA2_CMD_GET_FLICKER_MODES:\r\ncam->params.flicker_control.cam_register =\r\ncmd.buffer.block_data[0];\r\nbreak;\r\ncase CPIA2_CMD_GET_WAKEUP:\r\ncam->params.vc_params.wakeup = cmd.buffer.block_data[0];\r\nbreak;\r\ncase CPIA2_CMD_GET_PW_CONTROL:\r\ncam->params.vc_params.pw_control = cmd.buffer.block_data[0];\r\nbreak;\r\ncase CPIA2_CMD_GET_SYSTEM_CTRL:\r\ncam->params.camera_state.system_ctrl = cmd.buffer.block_data[0];\r\nbreak;\r\ncase CPIA2_CMD_GET_VP_SYSTEM_STATE:\r\ncam->params.vp_params.system_state = cmd.buffer.block_data[0];\r\nbreak;\r\ncase CPIA2_CMD_GET_VP_SYSTEM_CTRL:\r\ncam->params.vp_params.system_ctrl = cmd.buffer.block_data[0];\r\nbreak;\r\ncase CPIA2_CMD_GET_VP_EXP_MODES:\r\ncam->params.vp_params.exposure_modes = cmd.buffer.block_data[0];\r\nbreak;\r\ncase CPIA2_CMD_GET_DEVICE_CONFIG:\r\ncam->params.vp_params.device_config = cmd.buffer.block_data[0];\r\nbreak;\r\ncase CPIA2_CMD_GET_VC_CONTROL:\r\ncam->params.vc_params.vc_control = cmd.buffer.block_data[0];\r\nbreak;\r\ncase CPIA2_CMD_GET_USER_MODE:\r\ncam->params.vp_params.video_mode = cmd.buffer.block_data[0];\r\nbreak;\r\ncase CPIA2_CMD_GET_USER_EFFECTS:\r\ncam->params.vp_params.user_effects = cmd.buffer.block_data[0];\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn retval;\r\n}\r\nint cpia2_send_command(struct camera_data *cam, struct cpia2_command *cmd)\r\n{\r\nu8 count;\r\nu8 start;\r\nu8 *buffer;\r\nint retval;\r\nswitch (cmd->req_mode & 0x0c) {\r\ncase CAMERAACCESS_TYPE_RANDOM:\r\ncount = cmd->reg_count * sizeof(struct cpia2_register);\r\nstart = 0;\r\nbuffer = (u8 *) & cmd->buffer;\r\nif (debugs_on & DEBUG_REG)\r\nDBG("%s Random: Register block %s\n", DIR(cmd),\r\nblock_name[BINDEX(cmd)]);\r\nbreak;\r\ncase CAMERAACCESS_TYPE_BLOCK:\r\ncount = cmd->reg_count;\r\nstart = cmd->start;\r\nbuffer = cmd->buffer.block_data;\r\nif (debugs_on & DEBUG_REG)\r\nDBG("%s Block: Register block %s\n", DIR(cmd),\r\nblock_name[BINDEX(cmd)]);\r\nbreak;\r\ncase CAMERAACCESS_TYPE_MASK:\r\ncount = cmd->reg_count * sizeof(struct cpia2_reg_mask);\r\nstart = 0;\r\nbuffer = (u8 *) & cmd->buffer;\r\nif (debugs_on & DEBUG_REG)\r\nDBG("%s Mask: Register block %s\n", DIR(cmd),\r\nblock_name[BINDEX(cmd)]);\r\nbreak;\r\ncase CAMERAACCESS_TYPE_REPEAT:\r\ncount = cmd->reg_count;\r\nstart = cmd->start;\r\nbuffer = cmd->buffer.block_data;\r\nif (debugs_on & DEBUG_REG)\r\nDBG("%s Repeat: Register block %s\n", DIR(cmd),\r\nblock_name[BINDEX(cmd)]);\r\nbreak;\r\ndefault:\r\nLOG("%s: invalid request mode\n",__func__);\r\nreturn -EINVAL;\r\n}\r\nretval = cpia2_usb_transfer_cmd(cam,\r\nbuffer,\r\ncmd->req_mode,\r\nstart, count, cmd->direction);\r\n#ifdef _CPIA2_DEBUG_\r\nif (debugs_on & DEBUG_REG) {\r\nint i;\r\nfor (i = 0; i < cmd->reg_count; i++) {\r\nif((cmd->req_mode & 0x0c) == CAMERAACCESS_TYPE_BLOCK)\r\nKINFO("%s Block: [0x%02X] = 0x%02X\n",\r\nDIR(cmd), start + i, buffer[i]);\r\nif((cmd->req_mode & 0x0c) == CAMERAACCESS_TYPE_RANDOM)\r\nKINFO("%s Random: [0x%02X] = 0x%02X\n",\r\nDIR(cmd), cmd->buffer.registers[i].index,\r\ncmd->buffer.registers[i].value);\r\n}\r\n}\r\n#endif\r\nreturn retval;\r\n}\r\nstatic void cpia2_get_version_info(struct camera_data *cam)\r\n{\r\ncpia2_do_command(cam, CPIA2_CMD_GET_VERSION, TRANSFER_READ, 0);\r\ncpia2_do_command(cam, CPIA2_CMD_GET_PNP_ID, TRANSFER_READ, 0);\r\ncpia2_do_command(cam, CPIA2_CMD_GET_ASIC_TYPE, TRANSFER_READ, 0);\r\ncpia2_do_command(cam, CPIA2_CMD_GET_SENSOR, TRANSFER_READ, 0);\r\ncpia2_do_command(cam, CPIA2_CMD_GET_VP_DEVICE, TRANSFER_READ, 0);\r\n}\r\nint cpia2_reset_camera(struct camera_data *cam)\r\n{\r\nu8 tmp_reg;\r\nint retval = 0;\r\nint i;\r\nstruct cpia2_command cmd;\r\nretval = configure_sensor(cam,\r\ncam->params.roi.width,\r\ncam->params.roi.height);\r\nif (retval < 0) {\r\nERR("Couldn't configure sensor, error=%d\n", retval);\r\nreturn retval;\r\n}\r\ncmd.req_mode = CAMERAACCESS_TYPE_RANDOM | CAMERAACCESS_VC;\r\ncmd.direction = TRANSFER_WRITE;\r\ncmd.reg_count = 2;\r\ncmd.buffer.registers[0].index = CPIA2_VC_ST_CTRL;\r\ncmd.buffer.registers[0].value = CPIA2_VC_ST_CTRL_SRC_VC |\r\nCPIA2_VC_ST_CTRL_DST_USB | CPIA2_VC_ST_CTRL_EOF_DETECT;\r\ncmd.buffer.registers[1].index = CPIA2_VC_ST_CTRL;\r\ncmd.buffer.registers[1].value = CPIA2_VC_ST_CTRL_SRC_VC |\r\nCPIA2_VC_ST_CTRL_DST_USB |\r\nCPIA2_VC_ST_CTRL_EOF_DETECT | CPIA2_VC_ST_CTRL_FIFO_ENABLE;\r\ncpia2_send_command(cam, &cmd);\r\ncpia2_set_high_power(cam);\r\nif (cam->params.pnp_id.device_type == DEVICE_STV_672) {\r\ncmd.req_mode = CAMERAACCESS_TYPE_RANDOM | CAMERAACCESS_SYSTEM;\r\ncmd.buffer.registers[0].index = CPIA2_SYSTEM_INT_PACKET_CTRL;\r\ncmd.buffer.registers[0].value =\r\nCPIA2_SYSTEM_INT_PACKET_CTRL_ENABLE_SW_XX;\r\ncmd.reg_count = 1;\r\ncpia2_send_command(cam, &cmd);\r\n}\r\nschedule_timeout_interruptible(msecs_to_jiffies(100));\r\nif (cam->params.pnp_id.device_type == DEVICE_STV_672)\r\nretval = apply_vp_patch(cam);\r\nschedule_timeout_interruptible(msecs_to_jiffies(100));\r\nif (cam->params.pnp_id.device_type == DEVICE_STV_676) {\r\ncmd.req_mode = CAMERAACCESS_TYPE_RANDOM | CAMERAACCESS_VP;\r\ncmd.buffer.registers[0].index = CPIA2_VP5_MYBLACK_LEVEL;\r\ncmd.buffer.registers[0].value = 0;\r\ncmd.buffer.registers[1].index = CPIA2_VP5_MCYRANGE;\r\ncmd.buffer.registers[1].value = 0x92;\r\ncmd.buffer.registers[2].index = CPIA2_VP5_MYCEILING;\r\ncmd.buffer.registers[2].value = 0xFF;\r\ncmd.buffer.registers[3].index = CPIA2_VP5_MCUVSATURATION;\r\ncmd.buffer.registers[3].value = 0xFF;\r\ncmd.buffer.registers[4].index = CPIA2_VP5_ANTIFLKRSETUP;\r\ncmd.buffer.registers[4].value = 0x80;\r\ncmd.buffer.registers[5].index = CPIA2_VP_RAM_ADDR_H;\r\ncmd.buffer.registers[5].value = 0x01;\r\ncmd.buffer.registers[6].index = CPIA2_VP_RAM_ADDR_L;\r\ncmd.buffer.registers[6].value = 0xE3;\r\ncmd.buffer.registers[7].index = CPIA2_VP_RAM_DATA;\r\ncmd.buffer.registers[7].value = 0x02;\r\ncmd.buffer.registers[8].index = CPIA2_VP_RAM_DATA;\r\ncmd.buffer.registers[8].value = 0xFC;\r\ncmd.direction = TRANSFER_WRITE;\r\ncmd.reg_count = 9;\r\ncpia2_send_command(cam, &cmd);\r\n}\r\nset_default_user_mode(cam);\r\nschedule_timeout_interruptible(msecs_to_jiffies(100));\r\nset_all_properties(cam);\r\ncpia2_do_command(cam, CPIA2_CMD_GET_USER_MODE, TRANSFER_READ, 0);\r\nDBG("After SetAllProperties(cam), user mode is 0x%0X\n",\r\ncam->params.vp_params.video_mode);\r\ncpia2_do_command(cam, CPIA2_CMD_GET_VP_SYSTEM_CTRL, TRANSFER_READ, 0);\r\ntmp_reg = cam->params.vp_params.system_ctrl;\r\ncmd.buffer.registers[0].value = tmp_reg &\r\n(tmp_reg & (CPIA2_VP_SYSTEMCTRL_HK_CONTROL ^ 0xFF));\r\ncpia2_do_command(cam, CPIA2_CMD_GET_DEVICE_CONFIG, TRANSFER_READ, 0);\r\ncmd.buffer.registers[1].value = cam->params.vp_params.device_config |\r\nCPIA2_VP_DEVICE_CONFIG_SERIAL_BRIDGE;\r\ncmd.buffer.registers[0].index = CPIA2_VP_SYSTEMCTRL;\r\ncmd.buffer.registers[1].index = CPIA2_VP_DEVICE_CONFIG;\r\ncmd.req_mode = CAMERAACCESS_TYPE_RANDOM | CAMERAACCESS_VP;\r\ncmd.reg_count = 2;\r\ncmd.direction = TRANSFER_WRITE;\r\ncmd.start = 0;\r\ncpia2_send_command(cam, &cmd);\r\ncpia2_do_command(cam,\r\nCPIA2_CMD_SET_SERIAL_ADDR,\r\nTRANSFER_WRITE,\r\nCPIA2_SYSTEM_VP_SERIAL_ADDR_SENSOR);\r\ncpia2_do_command(cam,\r\nCPIA2_CMD_SET_SENSOR_CR1,\r\nTRANSFER_WRITE, CPIA2_SENSOR_CR1_DOWN_AUDIO_REGULATOR);\r\nif (cam->params.pnp_id.device_type == DEVICE_STV_672)\r\ncpia2_do_command(cam,\r\nCPIA2_CMD_SET_SERIAL_ADDR,\r\nTRANSFER_WRITE,\r\nCPIA2_SYSTEM_VP_SERIAL_ADDR_VP);\r\nelse\r\ncpia2_do_command(cam,\r\nCPIA2_CMD_SET_SERIAL_ADDR,\r\nTRANSFER_WRITE,\r\nCPIA2_SYSTEM_VP_SERIAL_ADDR_676_VP);\r\nif (cam->params.pnp_id.device_type == DEVICE_STV_676)\r\ncpia2_do_command(cam,\r\nCPIA2_CMD_SET_VP_EXP_MODES,\r\nTRANSFER_WRITE,\r\nCPIA2_VP_EXPOSURE_MODES_COMPILE_EXP);\r\ncpia2_do_command(cam, CPIA2_CMD_GET_DEVICE_CONFIG, TRANSFER_READ, 0);\r\ncmd.buffer.registers[0].value = cam->params.vp_params.device_config &\r\n(CPIA2_VP_DEVICE_CONFIG_SERIAL_BRIDGE ^ 0xFF);\r\ncpia2_do_command(cam, CPIA2_CMD_GET_VP_SYSTEM_CTRL, TRANSFER_READ, 0);\r\ncmd.buffer.registers[1].value =\r\ncam->params.vp_params.system_ctrl | CPIA2_VP_SYSTEMCTRL_HK_CONTROL;\r\ncmd.buffer.registers[0].index = CPIA2_VP_DEVICE_CONFIG;\r\ncmd.buffer.registers[1].index = CPIA2_VP_SYSTEMCTRL;\r\ncmd.req_mode = CAMERAACCESS_TYPE_RANDOM | CAMERAACCESS_VP;\r\ncmd.reg_count = 2;\r\ncmd.direction = TRANSFER_WRITE;\r\ncpia2_send_command(cam, &cmd);\r\ncpia2_do_command(cam, CPIA2_CMD_GET_VC_CONTROL, TRANSFER_READ, 0);\r\nif (cam->params.compression.inhibit_htables) {\r\ntmp_reg = cam->params.vc_params.vc_control |\r\nCPIA2_VC_VC_CTRL_INHIBIT_H_TABLES;\r\n} else {\r\ntmp_reg = cam->params.vc_params.vc_control &\r\n~CPIA2_VC_VC_CTRL_INHIBIT_H_TABLES;\r\n}\r\ncpia2_do_command(cam, CPIA2_CMD_SET_VC_CONTROL, TRANSFER_WRITE,tmp_reg);\r\ncpia2_do_command(cam, CPIA2_CMD_SET_TARGET_KB,\r\nTRANSFER_WRITE, cam->params.vc_params.target_kb);\r\nfor (i = 0; i < 50; i++) {\r\ncpia2_do_command(cam, CPIA2_CMD_GET_PW_CONTROL,\r\nTRANSFER_READ, 0);\r\n}\r\ntmp_reg = cam->params.vc_params.pw_control;\r\ntmp_reg &= ~CPIA2_VC_PW_CTRL_VC_RESET_N;\r\ncpia2_do_command(cam, CPIA2_CMD_SET_PW_CONTROL, TRANSFER_WRITE,tmp_reg);\r\ntmp_reg |= CPIA2_VC_PW_CTRL_VC_RESET_N;\r\ncpia2_do_command(cam, CPIA2_CMD_SET_PW_CONTROL, TRANSFER_WRITE,tmp_reg);\r\ncpia2_do_command(cam, CPIA2_CMD_SET_DEF_JPEG_OPT, TRANSFER_WRITE, 0);\r\ncpia2_do_command(cam, CPIA2_CMD_GET_USER_MODE, TRANSFER_READ, 0);\r\nDBG("After VC RESET, user mode is 0x%0X\n",\r\ncam->params.vp_params.video_mode);\r\nreturn retval;\r\n}\r\nstatic int cpia2_set_high_power(struct camera_data *cam)\r\n{\r\nint i;\r\nfor (i = 0; i <= 50; i++) {\r\ncpia2_do_command(cam,CPIA2_CMD_GET_SYSTEM_CTRL,TRANSFER_READ,0);\r\nif(cam->params.camera_state.system_ctrl &\r\nCPIA2_SYSTEM_CONTROL_V2W_ERR)\r\ncpia2_do_command(cam, CPIA2_CMD_CLEAR_V2W_ERR,\r\nTRANSFER_WRITE, 0);\r\ncpia2_do_command(cam, CPIA2_CMD_SET_SYSTEM_CTRL,\r\nTRANSFER_WRITE, 1);\r\ncpia2_do_command(cam, CPIA2_CMD_GET_VP_SYSTEM_STATE,\r\nTRANSFER_READ, 0);\r\nif (cam->params.vp_params.system_state &\r\nCPIA2_VP_SYSTEMSTATE_HK_ALIVE) {\r\nbreak;\r\n} else if (i == 50) {\r\ncam->params.camera_state.power_mode = LO_POWER_MODE;\r\nERR("Camera did not wake up\n");\r\nreturn -EIO;\r\n}\r\n}\r\nDBG("System now in high power state\n");\r\ncam->params.camera_state.power_mode = HI_POWER_MODE;\r\nreturn 0;\r\n}\r\nint cpia2_set_low_power(struct camera_data *cam)\r\n{\r\ncam->params.camera_state.power_mode = LO_POWER_MODE;\r\ncpia2_do_command(cam, CPIA2_CMD_SET_SYSTEM_CTRL, TRANSFER_WRITE, 0);\r\nreturn 0;\r\n}\r\nstatic int cpia2_send_onebyte_command(struct camera_data *cam,\r\nstruct cpia2_command *cmd,\r\nu8 start, u8 datum)\r\n{\r\ncmd->buffer.block_data[0] = datum;\r\ncmd->start = start;\r\ncmd->reg_count = 1;\r\nreturn cpia2_send_command(cam, cmd);\r\n}\r\nstatic int apply_vp_patch(struct camera_data *cam)\r\n{\r\nconst struct firmware *fw;\r\nconst char fw_name[] = "cpia2/stv0672_vp4.bin";\r\nint i, ret;\r\nstruct cpia2_command cmd;\r\nret = request_firmware(&fw, fw_name, &cam->dev->dev);\r\nif (ret) {\r\nprintk(KERN_ERR "cpia2: failed to load VP patch \"%s\"\n",\r\nfw_name);\r\nreturn ret;\r\n}\r\ncmd.req_mode = CAMERAACCESS_TYPE_REPEAT | CAMERAACCESS_VP;\r\ncmd.direction = TRANSFER_WRITE;\r\ncpia2_send_onebyte_command(cam, &cmd, 0x0A, fw->data[0]);\r\ncpia2_send_onebyte_command(cam, &cmd, 0x0B, fw->data[1]);\r\nfor (i = 2; i < fw->size; i += 64) {\r\ncmd.start = 0x0C;\r\ncmd.reg_count = min_t(int, 64, fw->size - i);\r\nmemcpy(cmd.buffer.block_data, &fw->data[i], cmd.reg_count);\r\ncpia2_send_command(cam, &cmd);\r\n}\r\ncpia2_send_onebyte_command(cam, &cmd, 0x0A, fw->data[0]);\r\ncpia2_send_onebyte_command(cam, &cmd, 0x0B, fw->data[1]);\r\ncpia2_send_onebyte_command(cam, &cmd, 0x0D, 1);\r\nrelease_firmware(fw);\r\nreturn 0;\r\n}\r\nstatic int set_default_user_mode(struct camera_data *cam)\r\n{\r\nunsigned char user_mode;\r\nunsigned char frame_rate;\r\nint width = cam->params.roi.width;\r\nint height = cam->params.roi.height;\r\nswitch (cam->params.version.sensor_flags) {\r\ncase CPIA2_VP_SENSOR_FLAGS_404:\r\ncase CPIA2_VP_SENSOR_FLAGS_407:\r\ncase CPIA2_VP_SENSOR_FLAGS_409:\r\ncase CPIA2_VP_SENSOR_FLAGS_410:\r\nif ((width > STV_IMAGE_QCIF_COLS)\r\n|| (height > STV_IMAGE_QCIF_ROWS)) {\r\nuser_mode = CPIA2_VP_USER_MODE_CIF;\r\n} else {\r\nuser_mode = CPIA2_VP_USER_MODE_QCIFDS;\r\n}\r\nframe_rate = CPIA2_VP_FRAMERATE_30;\r\nbreak;\r\ncase CPIA2_VP_SENSOR_FLAGS_500:\r\nif ((width > STV_IMAGE_CIF_COLS)\r\n|| (height > STV_IMAGE_CIF_ROWS)) {\r\nuser_mode = CPIA2_VP_USER_MODE_VGA;\r\n} else {\r\nuser_mode = CPIA2_VP_USER_MODE_QVGADS;\r\n}\r\nif (cam->params.pnp_id.device_type == DEVICE_STV_672)\r\nframe_rate = CPIA2_VP_FRAMERATE_15;\r\nelse\r\nframe_rate = CPIA2_VP_FRAMERATE_30;\r\nbreak;\r\ndefault:\r\nLOG("%s: Invalid sensor flag value 0x%0X\n",__func__,\r\ncam->params.version.sensor_flags);\r\nreturn -EINVAL;\r\n}\r\nDBG("Sensor flag = 0x%0x, user mode = 0x%0x, frame rate = 0x%X\n",\r\ncam->params.version.sensor_flags, user_mode, frame_rate);\r\ncpia2_do_command(cam, CPIA2_CMD_SET_USER_MODE, TRANSFER_WRITE,\r\nuser_mode);\r\nif(cam->params.vp_params.frame_rate > 0 &&\r\nframe_rate > cam->params.vp_params.frame_rate)\r\nframe_rate = cam->params.vp_params.frame_rate;\r\ncpia2_set_fps(cam, frame_rate);\r\nreturn 0;\r\n}\r\nint cpia2_match_video_size(int width, int height)\r\n{\r\nif (width >= STV_IMAGE_VGA_COLS && height >= STV_IMAGE_VGA_ROWS)\r\nreturn VIDEOSIZE_VGA;\r\nif (width >= STV_IMAGE_CIF_COLS && height >= STV_IMAGE_CIF_ROWS)\r\nreturn VIDEOSIZE_CIF;\r\nif (width >= STV_IMAGE_QVGA_COLS && height >= STV_IMAGE_QVGA_ROWS)\r\nreturn VIDEOSIZE_QVGA;\r\nif (width >= 288 && height >= 216)\r\nreturn VIDEOSIZE_288_216;\r\nif (width >= 256 && height >= 192)\r\nreturn VIDEOSIZE_256_192;\r\nif (width >= 224 && height >= 168)\r\nreturn VIDEOSIZE_224_168;\r\nif (width >= 192 && height >= 144)\r\nreturn VIDEOSIZE_192_144;\r\nif (width >= STV_IMAGE_QCIF_COLS && height >= STV_IMAGE_QCIF_ROWS)\r\nreturn VIDEOSIZE_QCIF;\r\nreturn -1;\r\n}\r\nstatic int set_vw_size(struct camera_data *cam, int size)\r\n{\r\nint retval = 0;\r\ncam->params.vp_params.video_size = size;\r\nswitch (size) {\r\ncase VIDEOSIZE_VGA:\r\nDBG("Setting size to VGA\n");\r\ncam->params.roi.width = STV_IMAGE_VGA_COLS;\r\ncam->params.roi.height = STV_IMAGE_VGA_ROWS;\r\ncam->width = STV_IMAGE_VGA_COLS;\r\ncam->height = STV_IMAGE_VGA_ROWS;\r\nbreak;\r\ncase VIDEOSIZE_CIF:\r\nDBG("Setting size to CIF\n");\r\ncam->params.roi.width = STV_IMAGE_CIF_COLS;\r\ncam->params.roi.height = STV_IMAGE_CIF_ROWS;\r\ncam->width = STV_IMAGE_CIF_COLS;\r\ncam->height = STV_IMAGE_CIF_ROWS;\r\nbreak;\r\ncase VIDEOSIZE_QVGA:\r\nDBG("Setting size to QVGA\n");\r\ncam->params.roi.width = STV_IMAGE_QVGA_COLS;\r\ncam->params.roi.height = STV_IMAGE_QVGA_ROWS;\r\ncam->width = STV_IMAGE_QVGA_COLS;\r\ncam->height = STV_IMAGE_QVGA_ROWS;\r\nbreak;\r\ncase VIDEOSIZE_288_216:\r\ncam->params.roi.width = 288;\r\ncam->params.roi.height = 216;\r\ncam->width = 288;\r\ncam->height = 216;\r\nbreak;\r\ncase VIDEOSIZE_256_192:\r\ncam->width = 256;\r\ncam->height = 192;\r\ncam->params.roi.width = 256;\r\ncam->params.roi.height = 192;\r\nbreak;\r\ncase VIDEOSIZE_224_168:\r\ncam->width = 224;\r\ncam->height = 168;\r\ncam->params.roi.width = 224;\r\ncam->params.roi.height = 168;\r\nbreak;\r\ncase VIDEOSIZE_192_144:\r\ncam->width = 192;\r\ncam->height = 144;\r\ncam->params.roi.width = 192;\r\ncam->params.roi.height = 144;\r\nbreak;\r\ncase VIDEOSIZE_QCIF:\r\nDBG("Setting size to QCIF\n");\r\ncam->params.roi.width = STV_IMAGE_QCIF_COLS;\r\ncam->params.roi.height = STV_IMAGE_QCIF_ROWS;\r\ncam->width = STV_IMAGE_QCIF_COLS;\r\ncam->height = STV_IMAGE_QCIF_ROWS;\r\nbreak;\r\ndefault:\r\nretval = -EINVAL;\r\n}\r\nreturn retval;\r\n}\r\nstatic int configure_sensor(struct camera_data *cam,\r\nint req_width, int req_height)\r\n{\r\nint retval;\r\nswitch (cam->params.version.sensor_flags) {\r\ncase CPIA2_VP_SENSOR_FLAGS_404:\r\ncase CPIA2_VP_SENSOR_FLAGS_407:\r\ncase CPIA2_VP_SENSOR_FLAGS_409:\r\ncase CPIA2_VP_SENSOR_FLAGS_410:\r\nretval = config_sensor_410(cam, req_width, req_height);\r\nbreak;\r\ncase CPIA2_VP_SENSOR_FLAGS_500:\r\nretval = config_sensor_500(cam, req_width, req_height);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn retval;\r\n}\r\nstatic int config_sensor_410(struct camera_data *cam,\r\nint req_width, int req_height)\r\n{\r\nstruct cpia2_command cmd;\r\nint i = 0;\r\nint image_size;\r\nint image_type;\r\nint width = req_width;\r\nint height = req_height;\r\nif (width > STV_IMAGE_CIF_COLS)\r\nwidth = STV_IMAGE_CIF_COLS;\r\nif (height > STV_IMAGE_CIF_ROWS)\r\nheight = STV_IMAGE_CIF_ROWS;\r\nimage_size = cpia2_match_video_size(width, height);\r\nDBG("Config 410: width = %d, height = %d\n", width, height);\r\nDBG("Image size returned is %d\n", image_size);\r\nif (image_size >= 0) {\r\nset_vw_size(cam, image_size);\r\nwidth = cam->params.roi.width;\r\nheight = cam->params.roi.height;\r\nDBG("After set_vw_size(), width = %d, height = %d\n",\r\nwidth, height);\r\nif (width <= 176 && height <= 144) {\r\nDBG("image type = VIDEOSIZE_QCIF\n");\r\nimage_type = VIDEOSIZE_QCIF;\r\n}\r\nelse if (width <= 320 && height <= 240) {\r\nDBG("image type = VIDEOSIZE_QVGA\n");\r\nimage_type = VIDEOSIZE_QVGA;\r\n}\r\nelse {\r\nDBG("image type = VIDEOSIZE_CIF\n");\r\nimage_type = VIDEOSIZE_CIF;\r\n}\r\n} else {\r\nERR("ConfigSensor410 failed\n");\r\nreturn -EINVAL;\r\n}\r\ncmd.req_mode = CAMERAACCESS_TYPE_RANDOM | CAMERAACCESS_VC;\r\ncmd.direction = TRANSFER_WRITE;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_FORMAT;\r\nif (image_type == VIDEOSIZE_CIF) {\r\ncmd.buffer.registers[i++].value =\r\n(u8) (CPIA2_VC_VC_FORMAT_UFIRST |\r\nCPIA2_VC_VC_FORMAT_SHORTLINE);\r\n} else {\r\ncmd.buffer.registers[i++].value =\r\n(u8) CPIA2_VC_VC_FORMAT_UFIRST;\r\n}\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_CLOCKS;\r\nif (image_type == VIDEOSIZE_QCIF) {\r\nif (cam->params.pnp_id.device_type == DEVICE_STV_672) {\r\ncmd.buffer.registers[i++].value=\r\n(u8)(CPIA2_VC_VC_672_CLOCKS_CIF_DIV_BY_3 |\r\nCPIA2_VC_VC_672_CLOCKS_SCALING |\r\nCPIA2_VC_VC_CLOCKS_LOGDIV2);\r\nDBG("VC_Clocks (0xc4) should be B\n");\r\n}\r\nelse {\r\ncmd.buffer.registers[i++].value=\r\n(u8)(CPIA2_VC_VC_676_CLOCKS_CIF_DIV_BY_3 |\r\nCPIA2_VC_VC_CLOCKS_LOGDIV2);\r\n}\r\n} else {\r\nif (cam->params.pnp_id.device_type == DEVICE_STV_672) {\r\ncmd.buffer.registers[i++].value =\r\n(u8) (CPIA2_VC_VC_672_CLOCKS_CIF_DIV_BY_3 |\r\nCPIA2_VC_VC_CLOCKS_LOGDIV0);\r\n}\r\nelse {\r\ncmd.buffer.registers[i++].value =\r\n(u8) (CPIA2_VC_VC_676_CLOCKS_CIF_DIV_BY_3 |\r\nCPIA2_VC_VC_676_CLOCKS_SCALING |\r\nCPIA2_VC_VC_CLOCKS_LOGDIV0);\r\n}\r\n}\r\nDBG("VC_Clocks (0xc4) = 0x%0X\n", cmd.buffer.registers[i-1].value);\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_IHSIZE_LO;\r\nif (image_type == VIDEOSIZE_QCIF)\r\ncmd.buffer.registers[i++].value =\r\n(u8) (STV_IMAGE_QCIF_COLS / 4);\r\nelse\r\ncmd.buffer.registers[i++].value =\r\n(u8) (STV_IMAGE_CIF_COLS / 4);\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_XLIM_HI;\r\nif (image_type == VIDEOSIZE_QCIF)\r\ncmd.buffer.registers[i++].value = (u8) 0;\r\nelse\r\ncmd.buffer.registers[i++].value = (u8) 1;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_XLIM_LO;\r\nif (image_type == VIDEOSIZE_QCIF)\r\ncmd.buffer.registers[i++].value = (u8) 208;\r\nelse\r\ncmd.buffer.registers[i++].value = (u8) 160;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_YLIM_HI;\r\nif (image_type == VIDEOSIZE_QCIF)\r\ncmd.buffer.registers[i++].value = (u8) 0;\r\nelse\r\ncmd.buffer.registers[i++].value = (u8) 1;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_YLIM_LO;\r\nif (image_type == VIDEOSIZE_QCIF)\r\ncmd.buffer.registers[i++].value = (u8) 160;\r\nelse\r\ncmd.buffer.registers[i++].value = (u8) 64;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_OHSIZE;\r\ncmd.buffer.registers[i++].value = cam->params.roi.width / 4;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_OVSIZE;\r\ncmd.buffer.registers[i++].value = cam->params.roi.height / 4;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_HCROP;\r\nif (image_type == VIDEOSIZE_QCIF)\r\ncmd.buffer.registers[i++].value =\r\n(u8) (((STV_IMAGE_QCIF_COLS / 4) - (width / 4)) / 2);\r\nelse\r\ncmd.buffer.registers[i++].value =\r\n(u8) (((STV_IMAGE_CIF_COLS / 4) - (width / 4)) / 2);\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_VCROP;\r\nif (image_type == VIDEOSIZE_QCIF)\r\ncmd.buffer.registers[i++].value =\r\n(u8) (((STV_IMAGE_QCIF_ROWS / 4) - (height / 4)) / 2);\r\nelse\r\ncmd.buffer.registers[i++].value =\r\n(u8) (((STV_IMAGE_CIF_ROWS / 4) - (height / 4)) / 2);\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_HPHASE;\r\ncmd.buffer.registers[i++].value = (u8) 0;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_VPHASE;\r\ncmd.buffer.registers[i++].value = (u8) 0;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_HISPAN;\r\ncmd.buffer.registers[i++].value = (u8) 31;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_VISPAN;\r\ncmd.buffer.registers[i++].value = (u8) 31;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_HICROP;\r\ncmd.buffer.registers[i++].value = (u8) 0;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_VICROP;\r\ncmd.buffer.registers[i++].value = (u8) 0;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_HFRACT;\r\ncmd.buffer.registers[i++].value = (u8) 0x81;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_VFRACT;\r\ncmd.buffer.registers[i++].value = (u8) 0x81;\r\ncmd.reg_count = i;\r\ncpia2_send_command(cam, &cmd);\r\nreturn i;\r\n}\r\nstatic int config_sensor_500(struct camera_data *cam,\r\nint req_width, int req_height)\r\n{\r\nstruct cpia2_command cmd;\r\nint i = 0;\r\nint image_size = VIDEOSIZE_CIF;\r\nint image_type = VIDEOSIZE_VGA;\r\nint width = req_width;\r\nint height = req_height;\r\nunsigned int device = cam->params.pnp_id.device_type;\r\nimage_size = cpia2_match_video_size(width, height);\r\nif (width > STV_IMAGE_CIF_COLS || height > STV_IMAGE_CIF_ROWS)\r\nimage_type = VIDEOSIZE_VGA;\r\nelse if (width > STV_IMAGE_QVGA_COLS || height > STV_IMAGE_QVGA_ROWS)\r\nimage_type = VIDEOSIZE_CIF;\r\nelse if (width > STV_IMAGE_QCIF_COLS || height > STV_IMAGE_QCIF_ROWS)\r\nimage_type = VIDEOSIZE_QVGA;\r\nelse\r\nimage_type = VIDEOSIZE_QCIF;\r\nif (image_size >= 0) {\r\nset_vw_size(cam, image_size);\r\nwidth = cam->params.roi.width;\r\nheight = cam->params.roi.height;\r\n} else {\r\nERR("ConfigSensor500 failed\n");\r\nreturn -EINVAL;\r\n}\r\nDBG("image_size = %d, width = %d, height = %d, type = %d\n",\r\nimage_size, width, height, image_type);\r\ncmd.req_mode = CAMERAACCESS_TYPE_RANDOM | CAMERAACCESS_VC;\r\ncmd.direction = TRANSFER_WRITE;\r\ni = 0;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_FORMAT;\r\ncmd.buffer.registers[i].value = (u8) CPIA2_VC_VC_FORMAT_UFIRST;\r\nif (image_type == VIDEOSIZE_QCIF)\r\ncmd.buffer.registers[i].value |= (u8) CPIA2_VC_VC_FORMAT_DECIMATING;\r\ni++;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_CLOCKS;\r\nif (device == DEVICE_STV_672) {\r\nif (image_type == VIDEOSIZE_VGA)\r\ncmd.buffer.registers[i].value =\r\n(u8)CPIA2_VC_VC_CLOCKS_LOGDIV1;\r\nelse\r\ncmd.buffer.registers[i].value =\r\n(u8)(CPIA2_VC_VC_672_CLOCKS_SCALING |\r\nCPIA2_VC_VC_CLOCKS_LOGDIV3);\r\n} else {\r\nif (image_type == VIDEOSIZE_VGA)\r\ncmd.buffer.registers[i].value =\r\n(u8)CPIA2_VC_VC_CLOCKS_LOGDIV0;\r\nelse\r\ncmd.buffer.registers[i].value =\r\n(u8)(CPIA2_VC_VC_676_CLOCKS_SCALING |\r\nCPIA2_VC_VC_CLOCKS_LOGDIV2);\r\n}\r\ni++;\r\nDBG("VC_CLOCKS = 0x%X\n", cmd.buffer.registers[i-1].value);\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_IHSIZE_LO;\r\nif (image_type == VIDEOSIZE_VGA)\r\ncmd.buffer.registers[i].value =\r\n(u8) (STV_IMAGE_VGA_COLS / 4);\r\nelse\r\ncmd.buffer.registers[i].value =\r\n(u8) (STV_IMAGE_QVGA_COLS / 4);\r\ni++;\r\nDBG("Input width = %d\n", cmd.buffer.registers[i-1].value);\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_XLIM_HI;\r\nif (image_type == VIDEOSIZE_VGA)\r\ncmd.buffer.registers[i++].value = (u8) 2;\r\nelse\r\ncmd.buffer.registers[i++].value = (u8) 1;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_XLIM_LO;\r\nif (image_type == VIDEOSIZE_VGA)\r\ncmd.buffer.registers[i++].value = (u8) 250;\r\nelse if (image_type == VIDEOSIZE_QVGA)\r\ncmd.buffer.registers[i++].value = (u8) 125;\r\nelse\r\ncmd.buffer.registers[i++].value = (u8) 160;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_YLIM_HI;\r\nif (image_type == VIDEOSIZE_VGA)\r\ncmd.buffer.registers[i++].value = (u8) 2;\r\nelse\r\ncmd.buffer.registers[i++].value = (u8) 1;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_YLIM_LO;\r\nif (image_type == VIDEOSIZE_VGA)\r\ncmd.buffer.registers[i++].value = (u8) 12;\r\nelse if (image_type == VIDEOSIZE_QVGA)\r\ncmd.buffer.registers[i++].value = (u8) 64;\r\nelse\r\ncmd.buffer.registers[i++].value = (u8) 6;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_OHSIZE;\r\nif (image_type == VIDEOSIZE_QCIF)\r\ncmd.buffer.registers[i++].value = STV_IMAGE_CIF_COLS / 4;\r\nelse\r\ncmd.buffer.registers[i++].value = width / 4;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_OVSIZE;\r\nif (image_type == VIDEOSIZE_QCIF)\r\ncmd.buffer.registers[i++].value = STV_IMAGE_CIF_ROWS / 4;\r\nelse\r\ncmd.buffer.registers[i++].value = height / 4;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_HCROP;\r\nif (image_type == VIDEOSIZE_VGA)\r\ncmd.buffer.registers[i++].value =\r\n(u8) (((STV_IMAGE_VGA_COLS / 4) - (width / 4)) / 2);\r\nelse if (image_type == VIDEOSIZE_QVGA)\r\ncmd.buffer.registers[i++].value =\r\n(u8) (((STV_IMAGE_QVGA_COLS / 4) - (width / 4)) / 2);\r\nelse if (image_type == VIDEOSIZE_CIF)\r\ncmd.buffer.registers[i++].value =\r\n(u8) (((STV_IMAGE_CIF_COLS / 4) - (width / 4)) / 2);\r\nelse\r\ncmd.buffer.registers[i++].value =\r\n(u8) (((STV_IMAGE_QCIF_COLS / 4) - (width / 4)) / 2);\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_VCROP;\r\nif (image_type == VIDEOSIZE_VGA)\r\ncmd.buffer.registers[i++].value =\r\n(u8) (((STV_IMAGE_VGA_ROWS / 4) - (height / 4)) / 2);\r\nelse if (image_type == VIDEOSIZE_QVGA)\r\ncmd.buffer.registers[i++].value =\r\n(u8) (((STV_IMAGE_QVGA_ROWS / 4) - (height / 4)) / 2);\r\nelse if (image_type == VIDEOSIZE_CIF)\r\ncmd.buffer.registers[i++].value =\r\n(u8) (((STV_IMAGE_CIF_ROWS / 4) - (height / 4)) / 2);\r\nelse\r\ncmd.buffer.registers[i++].value =\r\n(u8) (((STV_IMAGE_QCIF_ROWS / 4) - (height / 4)) / 2);\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_HPHASE;\r\nif (image_type == VIDEOSIZE_CIF || image_type == VIDEOSIZE_QCIF)\r\ncmd.buffer.registers[i++].value = (u8) 36;\r\nelse\r\ncmd.buffer.registers[i++].value = (u8) 0;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_VPHASE;\r\nif (image_type == VIDEOSIZE_CIF || image_type == VIDEOSIZE_QCIF)\r\ncmd.buffer.registers[i++].value = (u8) 32;\r\nelse\r\ncmd.buffer.registers[i++].value = (u8) 0;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_HISPAN;\r\nif (image_type == VIDEOSIZE_CIF || image_type == VIDEOSIZE_QCIF)\r\ncmd.buffer.registers[i++].value = (u8) 26;\r\nelse\r\ncmd.buffer.registers[i++].value = (u8) 31;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_VISPAN;\r\nif (image_type == VIDEOSIZE_CIF || image_type == VIDEOSIZE_QCIF)\r\ncmd.buffer.registers[i++].value = (u8) 21;\r\nelse\r\ncmd.buffer.registers[i++].value = (u8) 31;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_HICROP;\r\ncmd.buffer.registers[i++].value = (u8) 0;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_VICROP;\r\ncmd.buffer.registers[i++].value = (u8) 0;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_HFRACT;\r\nif (image_type == VIDEOSIZE_CIF || image_type == VIDEOSIZE_QCIF)\r\ncmd.buffer.registers[i++].value = (u8) 0x2B;\r\nelse\r\ncmd.buffer.registers[i++].value = (u8) 0x81;\r\ncmd.buffer.registers[i].index = CPIA2_VC_VC_VFRACT;\r\nif (image_type == VIDEOSIZE_CIF || image_type == VIDEOSIZE_QCIF)\r\ncmd.buffer.registers[i++].value = (u8) 0x13;\r\nelse\r\ncmd.buffer.registers[i++].value = (u8) 0x81;\r\ncmd.reg_count = i;\r\ncpia2_send_command(cam, &cmd);\r\nreturn i;\r\n}\r\nstatic int set_all_properties(struct camera_data *cam)\r\n{\r\ncpia2_set_color_params(cam);\r\ncpia2_usb_change_streaming_alternate(cam,\r\ncam->params.camera_state.stream_mode);\r\ncpia2_do_command(cam, CPIA2_CMD_SET_USER_EFFECTS, TRANSFER_WRITE,\r\ncam->params.vp_params.user_effects);\r\ncpia2_set_flicker_mode(cam,\r\ncam->params.flicker_control.flicker_mode_req);\r\ncpia2_do_command(cam,\r\nCPIA2_CMD_SET_VC_MP_GPIO_DIRECTION,\r\nTRANSFER_WRITE, cam->params.vp_params.gpio_direction);\r\ncpia2_do_command(cam, CPIA2_CMD_SET_VC_MP_GPIO_DATA, TRANSFER_WRITE,\r\ncam->params.vp_params.gpio_data);\r\nwake_system(cam);\r\nset_lowlight_boost(cam);\r\nreturn 0;\r\n}\r\nvoid cpia2_save_camera_state(struct camera_data *cam)\r\n{\r\nget_color_params(cam);\r\ncpia2_do_command(cam, CPIA2_CMD_GET_USER_EFFECTS, TRANSFER_READ, 0);\r\ncpia2_do_command(cam, CPIA2_CMD_GET_VC_MP_GPIO_DIRECTION, TRANSFER_READ,\r\n0);\r\ncpia2_do_command(cam, CPIA2_CMD_GET_VC_MP_GPIO_DATA, TRANSFER_READ, 0);\r\n}\r\nstatic void get_color_params(struct camera_data *cam)\r\n{\r\ncpia2_do_command(cam, CPIA2_CMD_GET_VP_BRIGHTNESS, TRANSFER_READ, 0);\r\ncpia2_do_command(cam, CPIA2_CMD_GET_VP_SATURATION, TRANSFER_READ, 0);\r\ncpia2_do_command(cam, CPIA2_CMD_GET_CONTRAST, TRANSFER_READ, 0);\r\n}\r\nvoid cpia2_set_color_params(struct camera_data *cam)\r\n{\r\nDBG("Setting color params\n");\r\ncpia2_set_brightness(cam, cam->params.color_params.brightness);\r\ncpia2_set_contrast(cam, cam->params.color_params.contrast);\r\ncpia2_set_saturation(cam, cam->params.color_params.saturation);\r\n}\r\nint cpia2_set_flicker_mode(struct camera_data *cam, int mode)\r\n{\r\nunsigned char cam_reg;\r\nint err = 0;\r\nif(cam->params.pnp_id.device_type != DEVICE_STV_672)\r\nreturn -EINVAL;\r\nif((err = cpia2_do_command(cam, CPIA2_CMD_GET_FLICKER_MODES,\r\nTRANSFER_READ, 0)))\r\nreturn err;\r\ncam_reg = cam->params.flicker_control.cam_register;\r\nswitch(mode) {\r\ncase NEVER_FLICKER:\r\ncam_reg |= CPIA2_VP_FLICKER_MODES_NEVER_FLICKER;\r\ncam_reg &= ~CPIA2_VP_FLICKER_MODES_50HZ;\r\nbreak;\r\ncase FLICKER_60:\r\ncam_reg &= ~CPIA2_VP_FLICKER_MODES_NEVER_FLICKER;\r\ncam_reg &= ~CPIA2_VP_FLICKER_MODES_50HZ;\r\nbreak;\r\ncase FLICKER_50:\r\ncam_reg &= ~CPIA2_VP_FLICKER_MODES_NEVER_FLICKER;\r\ncam_reg |= CPIA2_VP_FLICKER_MODES_50HZ;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif((err = cpia2_do_command(cam, CPIA2_CMD_SET_FLICKER_MODES,\r\nTRANSFER_WRITE, cam_reg)))\r\nreturn err;\r\nif((err = cpia2_do_command(cam, CPIA2_CMD_GET_VP_EXP_MODES,\r\nTRANSFER_READ, 0)))\r\nreturn err;\r\ncam_reg = cam->params.vp_params.exposure_modes;\r\nif (mode == NEVER_FLICKER) {\r\ncam_reg |= CPIA2_VP_EXPOSURE_MODES_INHIBIT_FLICKER;\r\n} else {\r\ncam_reg &= ~CPIA2_VP_EXPOSURE_MODES_INHIBIT_FLICKER;\r\n}\r\nif((err = cpia2_do_command(cam, CPIA2_CMD_SET_VP_EXP_MODES,\r\nTRANSFER_WRITE, cam_reg)))\r\nreturn err;\r\nif((err = cpia2_do_command(cam, CPIA2_CMD_REHASH_VP4,\r\nTRANSFER_WRITE, 1)))\r\nreturn err;\r\nswitch(mode) {\r\ncase NEVER_FLICKER:\r\ncam->params.flicker_control.flicker_mode_req = mode;\r\nbreak;\r\ncase FLICKER_60:\r\ncam->params.flicker_control.flicker_mode_req = mode;\r\ncam->params.flicker_control.mains_frequency = 60;\r\nbreak;\r\ncase FLICKER_50:\r\ncam->params.flicker_control.flicker_mode_req = mode;\r\ncam->params.flicker_control.mains_frequency = 50;\r\nbreak;\r\ndefault:\r\nerr = -EINVAL;\r\n}\r\nreturn err;\r\n}\r\nvoid cpia2_set_property_flip(struct camera_data *cam, int prop_val)\r\n{\r\nunsigned char cam_reg;\r\ncpia2_do_command(cam, CPIA2_CMD_GET_USER_EFFECTS, TRANSFER_READ, 0);\r\ncam_reg = cam->params.vp_params.user_effects;\r\nif (prop_val)\r\n{\r\ncam_reg |= CPIA2_VP_USER_EFFECTS_FLIP;\r\n}\r\nelse\r\n{\r\ncam_reg &= ~CPIA2_VP_USER_EFFECTS_FLIP;\r\n}\r\ncpia2_do_command(cam, CPIA2_CMD_SET_USER_EFFECTS, TRANSFER_WRITE,\r\ncam_reg);\r\n}\r\nvoid cpia2_set_property_mirror(struct camera_data *cam, int prop_val)\r\n{\r\nunsigned char cam_reg;\r\ncpia2_do_command(cam, CPIA2_CMD_GET_USER_EFFECTS, TRANSFER_READ, 0);\r\ncam_reg = cam->params.vp_params.user_effects;\r\nif (prop_val)\r\n{\r\ncam_reg |= CPIA2_VP_USER_EFFECTS_MIRROR;\r\n}\r\nelse\r\n{\r\ncam_reg &= ~CPIA2_VP_USER_EFFECTS_MIRROR;\r\n}\r\ncpia2_do_command(cam, CPIA2_CMD_SET_USER_EFFECTS, TRANSFER_WRITE,\r\ncam_reg);\r\n}\r\nint cpia2_set_target_kb(struct camera_data *cam, unsigned char value)\r\n{\r\nDBG("Requested target_kb = %d\n", value);\r\nif (value != cam->params.vc_params.target_kb) {\r\ncpia2_usb_stream_pause(cam);\r\ncam->params.vc_params.target_kb = value;\r\ncpia2_reset_camera(cam);\r\ncpia2_usb_stream_resume(cam);\r\n}\r\nreturn 0;\r\n}\r\nint cpia2_set_gpio(struct camera_data *cam, unsigned char setting)\r\n{\r\nint ret;\r\nret = cpia2_do_command(cam,\r\nCPIA2_CMD_SET_VC_MP_GPIO_DIRECTION,\r\nCPIA2_VC_MP_DIR_OUTPUT,\r\n255);\r\nif (ret < 0)\r\nreturn ret;\r\ncam->params.vp_params.gpio_direction = 255;\r\nret = cpia2_do_command(cam,\r\nCPIA2_CMD_SET_VC_MP_GPIO_DATA,\r\nCPIA2_VC_MP_DIR_OUTPUT,\r\nsetting);\r\nif (ret < 0)\r\nreturn ret;\r\ncam->params.vp_params.gpio_data = setting;\r\nreturn 0;\r\n}\r\nint cpia2_set_fps(struct camera_data *cam, int framerate)\r\n{\r\nint retval;\r\nswitch(framerate) {\r\ncase CPIA2_VP_FRAMERATE_30:\r\ncase CPIA2_VP_FRAMERATE_25:\r\nif(cam->params.pnp_id.device_type == DEVICE_STV_672 &&\r\ncam->params.version.sensor_flags ==\r\nCPIA2_VP_SENSOR_FLAGS_500) {\r\nreturn -EINVAL;\r\n}\r\ncase CPIA2_VP_FRAMERATE_15:\r\ncase CPIA2_VP_FRAMERATE_12_5:\r\ncase CPIA2_VP_FRAMERATE_7_5:\r\ncase CPIA2_VP_FRAMERATE_6_25:\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (cam->params.pnp_id.device_type == DEVICE_STV_672 &&\r\nframerate == CPIA2_VP_FRAMERATE_15)\r\nframerate = 0;\r\nretval = cpia2_do_command(cam,\r\nCPIA2_CMD_FRAMERATE_REQ,\r\nTRANSFER_WRITE,\r\nframerate);\r\nif(retval == 0)\r\ncam->params.vp_params.frame_rate = framerate;\r\nreturn retval;\r\n}\r\nvoid cpia2_set_brightness(struct camera_data *cam, unsigned char value)\r\n{\r\nif (cam->params.pnp_id.device_type == DEVICE_STV_672 && value == 0)\r\nvalue++;\r\nDBG("Setting brightness to %d (0x%0x)\n", value, value);\r\ncpia2_do_command(cam,CPIA2_CMD_SET_VP_BRIGHTNESS, TRANSFER_WRITE,value);\r\n}\r\nvoid cpia2_set_contrast(struct camera_data *cam, unsigned char value)\r\n{\r\nDBG("Setting contrast to %d (0x%0x)\n", value, value);\r\ncam->params.color_params.contrast = value;\r\ncpia2_do_command(cam, CPIA2_CMD_SET_CONTRAST, TRANSFER_WRITE, value);\r\n}\r\nvoid cpia2_set_saturation(struct camera_data *cam, unsigned char value)\r\n{\r\nDBG("Setting saturation to %d (0x%0x)\n", value, value);\r\ncam->params.color_params.saturation = value;\r\ncpia2_do_command(cam,CPIA2_CMD_SET_VP_SATURATION, TRANSFER_WRITE,value);\r\n}\r\nstatic void wake_system(struct camera_data *cam)\r\n{\r\ncpia2_do_command(cam, CPIA2_CMD_SET_WAKEUP, TRANSFER_WRITE, 0);\r\n}\r\nstatic void set_lowlight_boost(struct camera_data *cam)\r\n{\r\nstruct cpia2_command cmd;\r\nif (cam->params.pnp_id.device_type != DEVICE_STV_672 ||\r\ncam->params.version.sensor_flags != CPIA2_VP_SENSOR_FLAGS_500)\r\nreturn;\r\ncmd.direction = TRANSFER_WRITE;\r\ncmd.req_mode = CAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_VP;\r\ncmd.reg_count = 3;\r\ncmd.start = CPIA2_VP_RAM_ADDR_H;\r\ncmd.buffer.block_data[0] = 0;\r\ncmd.buffer.block_data[1] = 0x59;\r\ncmd.buffer.block_data[2] = 0;\r\ncpia2_send_command(cam, &cmd);\r\nif (cam->params.vp_params.lowlight_boost) {\r\ncmd.buffer.block_data[0] = 0x02;\r\n} else {\r\ncmd.buffer.block_data[0] = 0x06;\r\n}\r\ncmd.start = CPIA2_VP_RAM_DATA;\r\ncmd.reg_count = 1;\r\ncpia2_send_command(cam, &cmd);\r\ncpia2_do_command(cam, CPIA2_CMD_REHASH_VP4, TRANSFER_WRITE, 1);\r\n}\r\nvoid cpia2_set_format(struct camera_data *cam)\r\n{\r\ncam->flush = true;\r\ncpia2_usb_stream_pause(cam);\r\ncpia2_set_low_power(cam);\r\ncpia2_reset_camera(cam);\r\ncam->flush = false;\r\ncpia2_dbg_dump_registers(cam);\r\ncpia2_usb_stream_resume(cam);\r\n}\r\nvoid cpia2_dbg_dump_registers(struct camera_data *cam)\r\n{\r\n#ifdef _CPIA2_DEBUG_\r\nstruct cpia2_command cmd;\r\nif (!(debugs_on & DEBUG_DUMP_REGS))\r\nreturn;\r\ncmd.direction = TRANSFER_READ;\r\ncmd.req_mode = CAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_SYSTEM;\r\ncmd.reg_count = 3;\r\ncmd.start = 0;\r\ncpia2_send_command(cam, &cmd);\r\nprintk(KERN_DEBUG "System Device Hi = 0x%X\n",\r\ncmd.buffer.block_data[0]);\r\nprintk(KERN_DEBUG "System Device Lo = 0x%X\n",\r\ncmd.buffer.block_data[1]);\r\nprintk(KERN_DEBUG "System_system control = 0x%X\n",\r\ncmd.buffer.block_data[2]);\r\ncmd.req_mode = CAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_VC;\r\ncmd.reg_count = 4;\r\ncmd.start = 0x80;\r\ncpia2_send_command(cam, &cmd);\r\nprintk(KERN_DEBUG "ASIC_ID = 0x%X\n",\r\ncmd.buffer.block_data[0]);\r\nprintk(KERN_DEBUG "ASIC_REV = 0x%X\n",\r\ncmd.buffer.block_data[1]);\r\nprintk(KERN_DEBUG "PW_CONTRL = 0x%X\n",\r\ncmd.buffer.block_data[2]);\r\nprintk(KERN_DEBUG "WAKEUP = 0x%X\n",\r\ncmd.buffer.block_data[3]);\r\ncmd.start = 0xA0;\r\ncmd.reg_count = 1;\r\ncpia2_send_command(cam, &cmd);\r\nprintk(KERN_DEBUG "Stream ctrl = 0x%X\n",\r\ncmd.buffer.block_data[0]);\r\ncmd.start = 0xA4;\r\ncpia2_send_command(cam, &cmd);\r\nprintk(KERN_DEBUG "Stream status = 0x%X\n",\r\ncmd.buffer.block_data[0]);\r\ncmd.start = 0xA8;\r\ncmd.reg_count = 3;\r\ncpia2_send_command(cam, &cmd);\r\nprintk(KERN_DEBUG "USB_CTRL = 0x%X\n",\r\ncmd.buffer.block_data[0]);\r\nprintk(KERN_DEBUG "USB_STRM = 0x%X\n",\r\ncmd.buffer.block_data[1]);\r\nprintk(KERN_DEBUG "USB_STATUS = 0x%X\n",\r\ncmd.buffer.block_data[2]);\r\ncmd.start = 0xAF;\r\ncmd.reg_count = 1;\r\ncpia2_send_command(cam, &cmd);\r\nprintk(KERN_DEBUG "USB settings = 0x%X\n",\r\ncmd.buffer.block_data[0]);\r\ncmd.start = 0xC0;\r\ncmd.reg_count = 26;\r\ncpia2_send_command(cam, &cmd);\r\nprintk(KERN_DEBUG "VC Control = 0x%0X\n",\r\ncmd.buffer.block_data[0]);\r\nprintk(KERN_DEBUG "VC Format = 0x%0X\n",\r\ncmd.buffer.block_data[3]);\r\nprintk(KERN_DEBUG "VC Clocks = 0x%0X\n",\r\ncmd.buffer.block_data[4]);\r\nprintk(KERN_DEBUG "VC IHSize = 0x%0X\n",\r\ncmd.buffer.block_data[5]);\r\nprintk(KERN_DEBUG "VC Xlim Hi = 0x%0X\n",\r\ncmd.buffer.block_data[6]);\r\nprintk(KERN_DEBUG "VC XLim Lo = 0x%0X\n",\r\ncmd.buffer.block_data[7]);\r\nprintk(KERN_DEBUG "VC YLim Hi = 0x%0X\n",\r\ncmd.buffer.block_data[8]);\r\nprintk(KERN_DEBUG "VC YLim Lo = 0x%0X\n",\r\ncmd.buffer.block_data[9]);\r\nprintk(KERN_DEBUG "VC OHSize = 0x%0X\n",\r\ncmd.buffer.block_data[10]);\r\nprintk(KERN_DEBUG "VC OVSize = 0x%0X\n",\r\ncmd.buffer.block_data[11]);\r\nprintk(KERN_DEBUG "VC HCrop = 0x%0X\n",\r\ncmd.buffer.block_data[12]);\r\nprintk(KERN_DEBUG "VC VCrop = 0x%0X\n",\r\ncmd.buffer.block_data[13]);\r\nprintk(KERN_DEBUG "VC HPhase = 0x%0X\n",\r\ncmd.buffer.block_data[14]);\r\nprintk(KERN_DEBUG "VC VPhase = 0x%0X\n",\r\ncmd.buffer.block_data[15]);\r\nprintk(KERN_DEBUG "VC HIspan = 0x%0X\n",\r\ncmd.buffer.block_data[16]);\r\nprintk(KERN_DEBUG "VC VIspan = 0x%0X\n",\r\ncmd.buffer.block_data[17]);\r\nprintk(KERN_DEBUG "VC HiCrop = 0x%0X\n",\r\ncmd.buffer.block_data[18]);\r\nprintk(KERN_DEBUG "VC ViCrop = 0x%0X\n",\r\ncmd.buffer.block_data[19]);\r\nprintk(KERN_DEBUG "VC HiFract = 0x%0X\n",\r\ncmd.buffer.block_data[20]);\r\nprintk(KERN_DEBUG "VC ViFract = 0x%0X\n",\r\ncmd.buffer.block_data[21]);\r\nprintk(KERN_DEBUG "VC JPeg Opt = 0x%0X\n",\r\ncmd.buffer.block_data[22]);\r\nprintk(KERN_DEBUG "VC Creep Per = 0x%0X\n",\r\ncmd.buffer.block_data[23]);\r\nprintk(KERN_DEBUG "VC User Sq. = 0x%0X\n",\r\ncmd.buffer.block_data[24]);\r\nprintk(KERN_DEBUG "VC Target KB = 0x%0X\n",\r\ncmd.buffer.block_data[25]);\r\ncmd.req_mode = CAMERAACCESS_TYPE_BLOCK | CAMERAACCESS_VP;\r\ncmd.reg_count = 14;\r\ncmd.start = 0;\r\ncpia2_send_command(cam, &cmd);\r\nprintk(KERN_DEBUG "VP Dev Hi = 0x%0X\n",\r\ncmd.buffer.block_data[0]);\r\nprintk(KERN_DEBUG "VP Dev Lo = 0x%0X\n",\r\ncmd.buffer.block_data[1]);\r\nprintk(KERN_DEBUG "VP Sys State = 0x%0X\n",\r\ncmd.buffer.block_data[2]);\r\nprintk(KERN_DEBUG "VP Sys Ctrl = 0x%0X\n",\r\ncmd.buffer.block_data[3]);\r\nprintk(KERN_DEBUG "VP Sensor flg = 0x%0X\n",\r\ncmd.buffer.block_data[5]);\r\nprintk(KERN_DEBUG "VP Sensor Rev = 0x%0X\n",\r\ncmd.buffer.block_data[6]);\r\nprintk(KERN_DEBUG "VP Dev Config = 0x%0X\n",\r\ncmd.buffer.block_data[7]);\r\nprintk(KERN_DEBUG "VP GPIO_DIR = 0x%0X\n",\r\ncmd.buffer.block_data[8]);\r\nprintk(KERN_DEBUG "VP GPIO_DATA = 0x%0X\n",\r\ncmd.buffer.block_data[9]);\r\nprintk(KERN_DEBUG "VP Ram ADDR H = 0x%0X\n",\r\ncmd.buffer.block_data[10]);\r\nprintk(KERN_DEBUG "VP Ram ADDR L = 0x%0X\n",\r\ncmd.buffer.block_data[11]);\r\nprintk(KERN_DEBUG "VP RAM Data = 0x%0X\n",\r\ncmd.buffer.block_data[12]);\r\nprintk(KERN_DEBUG "Do Call = 0x%0X\n",\r\ncmd.buffer.block_data[13]);\r\nif (cam->params.pnp_id.device_type == DEVICE_STV_672) {\r\ncmd.reg_count = 9;\r\ncmd.start = 0x0E;\r\ncpia2_send_command(cam, &cmd);\r\nprintk(KERN_DEBUG "VP Clock Ctrl = 0x%0X\n",\r\ncmd.buffer.block_data[0]);\r\nprintk(KERN_DEBUG "VP Patch Rev = 0x%0X\n",\r\ncmd.buffer.block_data[1]);\r\nprintk(KERN_DEBUG "VP Vid Mode = 0x%0X\n",\r\ncmd.buffer.block_data[2]);\r\nprintk(KERN_DEBUG "VP Framerate = 0x%0X\n",\r\ncmd.buffer.block_data[3]);\r\nprintk(KERN_DEBUG "VP UserEffect = 0x%0X\n",\r\ncmd.buffer.block_data[4]);\r\nprintk(KERN_DEBUG "VP White Bal = 0x%0X\n",\r\ncmd.buffer.block_data[5]);\r\nprintk(KERN_DEBUG "VP WB thresh = 0x%0X\n",\r\ncmd.buffer.block_data[6]);\r\nprintk(KERN_DEBUG "VP Exp Modes = 0x%0X\n",\r\ncmd.buffer.block_data[7]);\r\nprintk(KERN_DEBUG "VP Exp Target = 0x%0X\n",\r\ncmd.buffer.block_data[8]);\r\ncmd.reg_count = 1;\r\ncmd.start = 0x1B;\r\ncpia2_send_command(cam, &cmd);\r\nprintk(KERN_DEBUG "VP FlickerMds = 0x%0X\n",\r\ncmd.buffer.block_data[0]);\r\n} else {\r\ncmd.reg_count = 8 ;\r\ncmd.start = 0x0E;\r\ncpia2_send_command(cam, &cmd);\r\nprintk(KERN_DEBUG "VP Clock Ctrl = 0x%0X\n",\r\ncmd.buffer.block_data[0]);\r\nprintk(KERN_DEBUG "VP Patch Rev = 0x%0X\n",\r\ncmd.buffer.block_data[1]);\r\nprintk(KERN_DEBUG "VP Vid Mode = 0x%0X\n",\r\ncmd.buffer.block_data[5]);\r\nprintk(KERN_DEBUG "VP Framerate = 0x%0X\n",\r\ncmd.buffer.block_data[6]);\r\nprintk(KERN_DEBUG "VP UserEffect = 0x%0X\n",\r\ncmd.buffer.block_data[7]);\r\ncmd.reg_count = 1;\r\ncmd.start = CPIA2_VP5_EXPOSURE_TARGET;\r\ncpia2_send_command(cam, &cmd);\r\nprintk(KERN_DEBUG "VP5 Exp Target= 0x%0X\n",\r\ncmd.buffer.block_data[0]);\r\ncmd.reg_count = 4;\r\ncmd.start = 0x3A;\r\ncpia2_send_command(cam, &cmd);\r\nprintk(KERN_DEBUG "VP5 MY Black = 0x%0X\n",\r\ncmd.buffer.block_data[0]);\r\nprintk(KERN_DEBUG "VP5 MCY Range = 0x%0X\n",\r\ncmd.buffer.block_data[1]);\r\nprintk(KERN_DEBUG "VP5 MYCEILING = 0x%0X\n",\r\ncmd.buffer.block_data[2]);\r\nprintk(KERN_DEBUG "VP5 MCUV Sat = 0x%0X\n",\r\ncmd.buffer.block_data[3]);\r\n}\r\n#endif\r\n}\r\nstatic void reset_camera_struct(struct camera_data *cam)\r\n{\r\ncam->params.color_params.brightness = DEFAULT_BRIGHTNESS;\r\ncam->params.color_params.contrast = DEFAULT_CONTRAST;\r\ncam->params.color_params.saturation = DEFAULT_SATURATION;\r\ncam->params.vp_params.lowlight_boost = 0;\r\ncam->params.flicker_control.flicker_mode_req = NEVER_FLICKER;\r\ncam->params.flicker_control.mains_frequency = 60;\r\ncam->params.compression.jpeg_options = CPIA2_VC_VC_JPEG_OPT_DEFAULT;\r\ncam->params.compression.creep_period = 2;\r\ncam->params.compression.user_squeeze = 20;\r\ncam->params.compression.inhibit_htables = false;\r\ncam->params.vp_params.gpio_direction = 0;\r\ncam->params.vp_params.gpio_data = 0;\r\ncam->params.vc_params.target_kb = DEFAULT_TARGET_KB;\r\nif(cam->params.pnp_id.device_type == DEVICE_STV_672) {\r\nif(cam->params.version.sensor_flags == CPIA2_VP_SENSOR_FLAGS_500)\r\ncam->params.vp_params.frame_rate = CPIA2_VP_FRAMERATE_15;\r\nelse\r\ncam->params.vp_params.frame_rate = CPIA2_VP_FRAMERATE_30;\r\n} else {\r\ncam->params.vp_params.frame_rate = CPIA2_VP_FRAMERATE_30;\r\n}\r\nif (cam->params.version.sensor_flags == CPIA2_VP_SENSOR_FLAGS_500) {\r\ncam->sensor_type = CPIA2_SENSOR_500;\r\ncam->video_size = VIDEOSIZE_VGA;\r\ncam->params.roi.width = STV_IMAGE_VGA_COLS;\r\ncam->params.roi.height = STV_IMAGE_VGA_ROWS;\r\n} else {\r\ncam->sensor_type = CPIA2_SENSOR_410;\r\ncam->video_size = VIDEOSIZE_CIF;\r\ncam->params.roi.width = STV_IMAGE_CIF_COLS;\r\ncam->params.roi.height = STV_IMAGE_CIF_ROWS;\r\n}\r\ncam->width = cam->params.roi.width;\r\ncam->height = cam->params.roi.height;\r\n}\r\nstruct camera_data *cpia2_init_camera_struct(void)\r\n{\r\nstruct camera_data *cam;\r\ncam = kzalloc(sizeof(*cam), GFP_KERNEL);\r\nif (!cam) {\r\nERR("couldn't kmalloc cpia2 struct\n");\r\nreturn NULL;\r\n}\r\ncam->present = 1;\r\nmutex_init(&cam->v4l2_lock);\r\ninit_waitqueue_head(&cam->wq_stream);\r\nreturn cam;\r\n}\r\nint cpia2_init_camera(struct camera_data *cam)\r\n{\r\nDBG("Start\n");\r\ncam->mmapped = false;\r\ncpia2_set_high_power(cam);\r\ncpia2_get_version_info(cam);\r\nif (cam->params.version.asic_id != CPIA2_ASIC_672) {\r\nERR("Device IO error (asicID has incorrect value of 0x%X\n",\r\ncam->params.version.asic_id);\r\nreturn -ENODEV;\r\n}\r\ncpia2_do_command(cam, CPIA2_CMD_SET_VC_MP_GPIO_DIRECTION,\r\nTRANSFER_WRITE, 0);\r\ncpia2_do_command(cam, CPIA2_CMD_SET_VC_MP_GPIO_DATA,\r\nTRANSFER_WRITE, 0);\r\nreset_camera_struct(cam);\r\ncpia2_set_low_power(cam);\r\nDBG("End\n");\r\nreturn 0;\r\n}\r\nint cpia2_allocate_buffers(struct camera_data *cam)\r\n{\r\nint i;\r\nif(!cam->buffers) {\r\nu32 size = cam->num_frames*sizeof(struct framebuf);\r\ncam->buffers = kmalloc(size, GFP_KERNEL);\r\nif(!cam->buffers) {\r\nERR("couldn't kmalloc frame buffer structures\n");\r\nreturn -ENOMEM;\r\n}\r\n}\r\nif(!cam->frame_buffer) {\r\ncam->frame_buffer = rvmalloc(cam->frame_size*cam->num_frames);\r\nif (!cam->frame_buffer) {\r\nERR("couldn't vmalloc frame buffer data area\n");\r\nkfree(cam->buffers);\r\ncam->buffers = NULL;\r\nreturn -ENOMEM;\r\n}\r\n}\r\nfor(i=0; i<cam->num_frames-1; ++i) {\r\ncam->buffers[i].next = &cam->buffers[i+1];\r\ncam->buffers[i].data = cam->frame_buffer +i*cam->frame_size;\r\ncam->buffers[i].status = FRAME_EMPTY;\r\ncam->buffers[i].length = 0;\r\ncam->buffers[i].max_length = 0;\r\ncam->buffers[i].num = i;\r\n}\r\ncam->buffers[i].next = cam->buffers;\r\ncam->buffers[i].data = cam->frame_buffer +i*cam->frame_size;\r\ncam->buffers[i].status = FRAME_EMPTY;\r\ncam->buffers[i].length = 0;\r\ncam->buffers[i].max_length = 0;\r\ncam->buffers[i].num = i;\r\ncam->curbuff = cam->buffers;\r\ncam->workbuff = cam->curbuff->next;\r\nDBG("buffers=%p, curbuff=%p, workbuff=%p\n", cam->buffers, cam->curbuff,\r\ncam->workbuff);\r\nreturn 0;\r\n}\r\nvoid cpia2_free_buffers(struct camera_data *cam)\r\n{\r\nif(cam->buffers) {\r\nkfree(cam->buffers);\r\ncam->buffers = NULL;\r\n}\r\nif(cam->frame_buffer) {\r\nrvfree(cam->frame_buffer, cam->frame_size*cam->num_frames);\r\ncam->frame_buffer = NULL;\r\n}\r\n}\r\nlong cpia2_read(struct camera_data *cam,\r\nchar __user *buf, unsigned long count, int noblock)\r\n{\r\nstruct framebuf *frame;\r\nif (!count)\r\nreturn 0;\r\nif (!buf) {\r\nERR("%s: buffer NULL\n",__func__);\r\nreturn -EINVAL;\r\n}\r\nif (!cam) {\r\nERR("%s: Internal error, camera_data NULL!\n",__func__);\r\nreturn -EINVAL;\r\n}\r\nif (!cam->present) {\r\nLOG("%s: camera removed\n",__func__);\r\nreturn 0;\r\n}\r\nif (!cam->streaming) {\r\ncpia2_usb_stream_start(cam,\r\ncam->params.camera_state.stream_mode);\r\n}\r\nframe = cam->curbuff;\r\nif (noblock && frame->status != FRAME_READY) {\r\nreturn -EAGAIN;\r\n}\r\nif (frame->status != FRAME_READY) {\r\nmutex_unlock(&cam->v4l2_lock);\r\nwait_event_interruptible(cam->wq_stream,\r\n!cam->present ||\r\n(frame = cam->curbuff)->status == FRAME_READY);\r\nmutex_lock(&cam->v4l2_lock);\r\nif (signal_pending(current))\r\nreturn -ERESTARTSYS;\r\nif (!cam->present)\r\nreturn 0;\r\n}\r\nif (frame->length > count)\r\nreturn -EFAULT;\r\nif (copy_to_user(buf, frame->data, frame->length))\r\nreturn -EFAULT;\r\ncount = frame->length;\r\nframe->status = FRAME_EMPTY;\r\nreturn count;\r\n}\r\nunsigned int cpia2_poll(struct camera_data *cam, struct file *filp,\r\npoll_table *wait)\r\n{\r\nunsigned int status=0;\r\nif (!cam) {\r\nERR("%s: Internal error, camera_data not found!\n",__func__);\r\nreturn POLLERR;\r\n}\r\nif (!cam->present)\r\nreturn POLLHUP;\r\nif(!cam->streaming) {\r\ncpia2_usb_stream_start(cam,\r\ncam->params.camera_state.stream_mode);\r\n}\r\npoll_wait(filp, &cam->wq_stream, wait);\r\nif(!cam->present)\r\nstatus = POLLHUP;\r\nelse if(cam->curbuff->status == FRAME_READY)\r\nstatus = POLLIN | POLLRDNORM;\r\nreturn status;\r\n}\r\nint cpia2_remap_buffer(struct camera_data *cam, struct vm_area_struct *vma)\r\n{\r\nconst char *adr = (const char *)vma->vm_start;\r\nunsigned long size = vma->vm_end-vma->vm_start;\r\nunsigned long start_offset = vma->vm_pgoff << PAGE_SHIFT;\r\nunsigned long start = (unsigned long) adr;\r\nunsigned long page, pos;\r\nif (!cam)\r\nreturn -ENODEV;\r\nDBG("mmap offset:%ld size:%ld\n", start_offset, size);\r\nif (!cam->present)\r\nreturn -ENODEV;\r\nif (size > cam->frame_size*cam->num_frames ||\r\n(start_offset % cam->frame_size) != 0 ||\r\n(start_offset+size > cam->frame_size*cam->num_frames))\r\nreturn -EINVAL;\r\npos = ((unsigned long) (cam->frame_buffer)) + start_offset;\r\nwhile (size > 0) {\r\npage = kvirt_to_pa(pos);\r\nif (remap_pfn_range(vma, start, page >> PAGE_SHIFT, PAGE_SIZE, PAGE_SHARED))\r\nreturn -EAGAIN;\r\nstart += PAGE_SIZE;\r\npos += PAGE_SIZE;\r\nif (size > PAGE_SIZE)\r\nsize -= PAGE_SIZE;\r\nelse\r\nsize = 0;\r\n}\r\ncam->mmapped = true;\r\nreturn 0;\r\n}

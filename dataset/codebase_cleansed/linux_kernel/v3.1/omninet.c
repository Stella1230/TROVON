static int omninet_attach(struct usb_serial *serial)\r\n{\r\nstruct omninet_data *od;\r\nstruct usb_serial_port *port = serial->port[0];\r\nod = kmalloc(sizeof(struct omninet_data), GFP_KERNEL);\r\nif (!od) {\r\ndev_err(&port->dev, "%s- kmalloc(%Zd) failed.\n",\r\n__func__, sizeof(struct omninet_data));\r\nreturn -ENOMEM;\r\n}\r\nusb_set_serial_port_data(port, od);\r\nreturn 0;\r\n}\r\nstatic int omninet_open(struct tty_struct *tty, struct usb_serial_port *port)\r\n{\r\nstruct usb_serial *serial = port->serial;\r\nstruct usb_serial_port *wport;\r\nint result = 0;\r\ndbg("%s - port %d", __func__, port->number);\r\nwport = serial->port[1];\r\ntty_port_tty_set(&wport->port, tty);\r\nusb_fill_bulk_urb(port->read_urb, serial->dev,\r\nusb_rcvbulkpipe(serial->dev,\r\nport->bulk_in_endpointAddress),\r\nport->read_urb->transfer_buffer,\r\nport->read_urb->transfer_buffer_length,\r\nomninet_read_bulk_callback, port);\r\nresult = usb_submit_urb(port->read_urb, GFP_KERNEL);\r\nif (result)\r\ndev_err(&port->dev,\r\n"%s - failed submitting read urb, error %d\n",\r\n__func__, result);\r\nreturn result;\r\n}\r\nstatic void omninet_close(struct usb_serial_port *port)\r\n{\r\ndbg("%s - port %d", __func__, port->number);\r\nusb_kill_urb(port->read_urb);\r\n}\r\nstatic void omninet_read_bulk_callback(struct urb *urb)\r\n{\r\nstruct usb_serial_port *port = urb->context;\r\nunsigned char *data = urb->transfer_buffer;\r\nstruct omninet_header *header = (struct omninet_header *) &data[0];\r\nint status = urb->status;\r\nint result;\r\nint i;\r\ndbg("%s - port %d", __func__, port->number);\r\nif (status) {\r\ndbg("%s - nonzero read bulk status received: %d",\r\n__func__, status);\r\nreturn;\r\n}\r\nif (debug && header->oh_xxx != 0x30) {\r\nif (urb->actual_length) {\r\nprintk(KERN_DEBUG "%s: omninet_read %d: ",\r\n__FILE__, header->oh_len);\r\nfor (i = 0; i < (header->oh_len +\r\nOMNINET_HEADERLEN); i++)\r\nprintk("%.2x ", data[i]);\r\nprintk("\n");\r\n}\r\n}\r\nif (urb->actual_length && header->oh_len) {\r\nstruct tty_struct *tty = tty_port_tty_get(&port->port);\r\ntty_insert_flip_string(tty, data + OMNINET_DATAOFFSET,\r\nheader->oh_len);\r\ntty_flip_buffer_push(tty);\r\ntty_kref_put(tty);\r\n}\r\nusb_fill_bulk_urb(urb, port->serial->dev,\r\nusb_rcvbulkpipe(port->serial->dev,\r\nport->bulk_in_endpointAddress),\r\nurb->transfer_buffer, urb->transfer_buffer_length,\r\nomninet_read_bulk_callback, port);\r\nresult = usb_submit_urb(urb, GFP_ATOMIC);\r\nif (result)\r\ndev_err(&port->dev,\r\n"%s - failed resubmitting read urb, error %d\n",\r\n__func__, result);\r\n}\r\nstatic int omninet_write(struct tty_struct *tty, struct usb_serial_port *port,\r\nconst unsigned char *buf, int count)\r\n{\r\nstruct usb_serial *serial = port->serial;\r\nstruct usb_serial_port *wport = serial->port[1];\r\nstruct omninet_data *od = usb_get_serial_port_data(port);\r\nstruct omninet_header *header = (struct omninet_header *)\r\nwport->write_urb->transfer_buffer;\r\nint result;\r\ndbg("%s - port %d", __func__, port->number);\r\nif (count == 0) {\r\ndbg("%s - write request of 0 bytes", __func__);\r\nreturn 0;\r\n}\r\nspin_lock_bh(&wport->lock);\r\nif (wport->write_urb_busy) {\r\nspin_unlock_bh(&wport->lock);\r\ndbg("%s - already writing", __func__);\r\nreturn 0;\r\n}\r\nwport->write_urb_busy = 1;\r\nspin_unlock_bh(&wport->lock);\r\ncount = (count > OMNINET_BULKOUTSIZE) ? OMNINET_BULKOUTSIZE : count;\r\nmemcpy(wport->write_urb->transfer_buffer + OMNINET_DATAOFFSET,\r\nbuf, count);\r\nusb_serial_debug_data(debug, &port->dev, __func__, count,\r\nwport->write_urb->transfer_buffer);\r\nheader->oh_seq = od->od_outseq++;\r\nheader->oh_len = count;\r\nheader->oh_xxx = 0x03;\r\nheader->oh_pad = 0x00;\r\nwport->write_urb->transfer_buffer_length = 64;\r\nwport->write_urb->dev = serial->dev;\r\nresult = usb_submit_urb(wport->write_urb, GFP_ATOMIC);\r\nif (result) {\r\nwport->write_urb_busy = 0;\r\ndev_err(&port->dev,\r\n"%s - failed submitting write urb, error %d\n",\r\n__func__, result);\r\n} else\r\nresult = count;\r\nreturn result;\r\n}\r\nstatic int omninet_write_room(struct tty_struct *tty)\r\n{\r\nstruct usb_serial_port *port = tty->driver_data;\r\nstruct usb_serial *serial = port->serial;\r\nstruct usb_serial_port *wport = serial->port[1];\r\nint room = 0;\r\nif (wport->write_urb_busy)\r\nroom = wport->bulk_out_size - OMNINET_HEADERLEN;\r\ndbg("%s - returns %d", __func__, room);\r\nreturn room;\r\n}\r\nstatic void omninet_write_bulk_callback(struct urb *urb)\r\n{\r\nstruct usb_serial_port *port = urb->context;\r\nint status = urb->status;\r\ndbg("%s - port %0x", __func__, port->number);\r\nport->write_urb_busy = 0;\r\nif (status) {\r\ndbg("%s - nonzero write bulk status received: %d",\r\n__func__, status);\r\nreturn;\r\n}\r\nusb_serial_port_softint(port);\r\n}\r\nstatic void omninet_disconnect(struct usb_serial *serial)\r\n{\r\nstruct usb_serial_port *wport = serial->port[1];\r\ndbg("%s", __func__);\r\nusb_kill_urb(wport->write_urb);\r\n}\r\nstatic void omninet_release(struct usb_serial *serial)\r\n{\r\nstruct usb_serial_port *port = serial->port[0];\r\ndbg("%s", __func__);\r\nkfree(usb_get_serial_port_data(port));\r\n}\r\nstatic int __init omninet_init(void)\r\n{\r\nint retval;\r\nretval = usb_serial_register(&zyxel_omninet_device);\r\nif (retval)\r\ngoto failed_usb_serial_register;\r\nretval = usb_register(&omninet_driver);\r\nif (retval)\r\ngoto failed_usb_register;\r\nprintk(KERN_INFO KBUILD_MODNAME ": " DRIVER_VERSION ":"\r\nDRIVER_DESC "\n");\r\nreturn 0;\r\nfailed_usb_register:\r\nusb_serial_deregister(&zyxel_omninet_device);\r\nfailed_usb_serial_register:\r\nreturn retval;\r\n}\r\nstatic void __exit omninet_exit(void)\r\n{\r\nusb_deregister(&omninet_driver);\r\nusb_serial_deregister(&zyxel_omninet_device);\r\n}

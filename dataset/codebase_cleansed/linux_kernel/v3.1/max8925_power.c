static int __set_charger(struct max8925_power_info *info, int enable)\r\n{\r\nstruct max8925_chip *chip = info->chip;\r\nif (enable) {\r\nif (info->set_charger)\r\ninfo->set_charger(1);\r\nmax8925_set_bits(info->gpm, MAX8925_CHG_CNTL1, 1 << 7, 0);\r\n} else {\r\nmax8925_set_bits(info->gpm, MAX8925_CHG_CNTL1, 1 << 7, 1 << 7);\r\nif (info->set_charger)\r\ninfo->set_charger(0);\r\n}\r\ndev_dbg(chip->dev, "%s\n", (enable) ? "Enable charger"\r\n: "Disable charger");\r\nreturn 0;\r\n}\r\nstatic irqreturn_t max8925_charger_handler(int irq, void *data)\r\n{\r\nstruct max8925_power_info *info = (struct max8925_power_info *)data;\r\nstruct max8925_chip *chip = info->chip;\r\nswitch (irq - chip->irq_base) {\r\ncase MAX8925_IRQ_VCHG_DC_R:\r\ninfo->ac_online = 1;\r\n__set_charger(info, 1);\r\ndev_dbg(chip->dev, "Adapter inserted\n");\r\nbreak;\r\ncase MAX8925_IRQ_VCHG_DC_F:\r\ninfo->ac_online = 0;\r\n__set_charger(info, 0);\r\ndev_dbg(chip->dev, "Adapter is removal\n");\r\nbreak;\r\ncase MAX8925_IRQ_VCHG_USB_R:\r\ninfo->usb_online = 1;\r\n__set_charger(info, 1);\r\ndev_dbg(chip->dev, "USB inserted\n");\r\nbreak;\r\ncase MAX8925_IRQ_VCHG_USB_F:\r\ninfo->usb_online = 0;\r\n__set_charger(info, 0);\r\ndev_dbg(chip->dev, "USB is removal\n");\r\nbreak;\r\ncase MAX8925_IRQ_VCHG_THM_OK_F:\r\ndev_dbg(chip->dev, "Battery temperature is out of range\n");\r\ncase MAX8925_IRQ_VCHG_DC_OVP:\r\ndev_dbg(chip->dev, "Error detection\n");\r\n__set_charger(info, 0);\r\nbreak;\r\ncase MAX8925_IRQ_VCHG_THM_OK_R:\r\ndev_dbg(chip->dev, "Battery temperature is in range\n");\r\nbreak;\r\ncase MAX8925_IRQ_VCHG_SYSLOW_R:\r\ndev_info(chip->dev, "Sys power is too low\n");\r\nbreak;\r\ncase MAX8925_IRQ_VCHG_SYSLOW_F:\r\ndev_dbg(chip->dev, "Sys power is above low threshold\n");\r\nbreak;\r\ncase MAX8925_IRQ_VCHG_DONE:\r\n__set_charger(info, 0);\r\ndev_dbg(chip->dev, "Charging is done\n");\r\nbreak;\r\ncase MAX8925_IRQ_VCHG_TOPOFF:\r\ndev_dbg(chip->dev, "Charging in top-off mode\n");\r\nbreak;\r\ncase MAX8925_IRQ_VCHG_TMR_FAULT:\r\n__set_charger(info, 0);\r\ndev_dbg(chip->dev, "Safe timer is expired\n");\r\nbreak;\r\ncase MAX8925_IRQ_VCHG_RST:\r\n__set_charger(info, 0);\r\ndev_dbg(chip->dev, "Charger is reset\n");\r\nbreak;\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int start_measure(struct max8925_power_info *info, int type)\r\n{\r\nunsigned char buf[2] = {0, 0};\r\nint meas_reg = 0, ret;\r\nswitch (type) {\r\ncase MEASURE_VCHG:\r\nmeas_reg = MAX8925_ADC_VCHG;\r\nbreak;\r\ncase MEASURE_VBBATT:\r\nmeas_reg = MAX8925_ADC_VBBATT;\r\nbreak;\r\ncase MEASURE_VMBATT:\r\nmeas_reg = MAX8925_ADC_VMBATT;\r\nbreak;\r\ncase MEASURE_ISNS:\r\nmeas_reg = MAX8925_ADC_ISNS;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nmax8925_bulk_read(info->adc, meas_reg, 2, buf);\r\nret = (buf[0] << 4) | (buf[1] >> 4);\r\nreturn ret;\r\n}\r\nstatic int max8925_ac_get_prop(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct max8925_power_info *info = dev_get_drvdata(psy->dev->parent);\r\nint ret = 0;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nval->intval = info->ac_online;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nif (info->ac_online) {\r\nret = start_measure(info, MEASURE_VCHG);\r\nif (ret >= 0) {\r\nval->intval = ret << 1;\r\ngoto out;\r\n}\r\n}\r\nret = -ENODATA;\r\nbreak;\r\ndefault:\r\nret = -ENODEV;\r\nbreak;\r\n}\r\nout:\r\nreturn ret;\r\n}\r\nstatic int max8925_usb_get_prop(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct max8925_power_info *info = dev_get_drvdata(psy->dev->parent);\r\nint ret = 0;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nval->intval = info->usb_online;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nif (info->usb_online) {\r\nret = start_measure(info, MEASURE_VCHG);\r\nif (ret >= 0) {\r\nval->intval = ret << 1;\r\ngoto out;\r\n}\r\n}\r\nret = -ENODATA;\r\nbreak;\r\ndefault:\r\nret = -ENODEV;\r\nbreak;\r\n}\r\nout:\r\nreturn ret;\r\n}\r\nstatic int max8925_bat_get_prop(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct max8925_power_info *info = dev_get_drvdata(psy->dev->parent);\r\nlong long int tmp = 0;\r\nint ret = 0;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nval->intval = info->bat_online;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nif (info->bat_online) {\r\nret = start_measure(info, MEASURE_VMBATT);\r\nif (ret >= 0) {\r\nval->intval = ret << 1;\r\nret = 0;\r\nbreak;\r\n}\r\n}\r\nret = -ENODATA;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CURRENT_NOW:\r\nif (info->bat_online) {\r\nret = start_measure(info, MEASURE_ISNS);\r\nif (ret >= 0) {\r\ntmp = (long long int)ret * 6250 / 4096 - 3125;\r\nret = (int)tmp;\r\nval->intval = 0;\r\nif (ret > 0)\r\nval->intval = ret;\r\nret = 0;\r\nbreak;\r\n}\r\n}\r\nret = -ENODATA;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_TYPE:\r\nif (!info->bat_online) {\r\nret = -ENODATA;\r\nbreak;\r\n}\r\nret = max8925_reg_read(info->gpm, MAX8925_CHG_STATUS);\r\nret = (ret & MAX8925_CHG_STAT_MODE_MASK) >> 2;\r\nswitch (ret) {\r\ncase 1:\r\nval->intval = POWER_SUPPLY_CHARGE_TYPE_FAST;\r\nbreak;\r\ncase 0:\r\ncase 2:\r\nval->intval = POWER_SUPPLY_CHARGE_TYPE_TRICKLE;\r\nbreak;\r\ncase 3:\r\nval->intval = POWER_SUPPLY_CHARGE_TYPE_NONE;\r\nbreak;\r\n}\r\nret = 0;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nif (!info->bat_online) {\r\nret = -ENODATA;\r\nbreak;\r\n}\r\nret = max8925_reg_read(info->gpm, MAX8925_CHG_STATUS);\r\nif (info->usb_online || info->ac_online) {\r\nval->intval = POWER_SUPPLY_STATUS_NOT_CHARGING;\r\nif (ret & MAX8925_CHG_STAT_EN_MASK)\r\nval->intval = POWER_SUPPLY_STATUS_CHARGING;\r\n} else\r\nval->intval = POWER_SUPPLY_STATUS_DISCHARGING;\r\nret = 0;\r\nbreak;\r\ndefault:\r\nret = -ENODEV;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic __devinit int max8925_init_charger(struct max8925_chip *chip,\r\nstruct max8925_power_info *info)\r\n{\r\nint ret;\r\nREQUEST_IRQ(MAX8925_IRQ_VCHG_DC_OVP, "ac-ovp");\r\nREQUEST_IRQ(MAX8925_IRQ_VCHG_DC_F, "ac-remove");\r\nREQUEST_IRQ(MAX8925_IRQ_VCHG_DC_R, "ac-insert");\r\nREQUEST_IRQ(MAX8925_IRQ_VCHG_USB_OVP, "usb-ovp");\r\nREQUEST_IRQ(MAX8925_IRQ_VCHG_USB_F, "usb-remove");\r\nREQUEST_IRQ(MAX8925_IRQ_VCHG_USB_R, "usb-insert");\r\nREQUEST_IRQ(MAX8925_IRQ_VCHG_THM_OK_R, "batt-temp-in-range");\r\nREQUEST_IRQ(MAX8925_IRQ_VCHG_THM_OK_F, "batt-temp-out-range");\r\nREQUEST_IRQ(MAX8925_IRQ_VCHG_SYSLOW_F, "vsys-high");\r\nREQUEST_IRQ(MAX8925_IRQ_VCHG_SYSLOW_R, "vsys-low");\r\nREQUEST_IRQ(MAX8925_IRQ_VCHG_RST, "charger-reset");\r\nREQUEST_IRQ(MAX8925_IRQ_VCHG_DONE, "charger-done");\r\nREQUEST_IRQ(MAX8925_IRQ_VCHG_TOPOFF, "charger-topoff");\r\nREQUEST_IRQ(MAX8925_IRQ_VCHG_TMR_FAULT, "charger-timer-expire");\r\ninfo->ac_online = 0;\r\ninfo->usb_online = 0;\r\ninfo->bat_online = 0;\r\nret = max8925_reg_read(info->gpm, MAX8925_CHG_STATUS);\r\nif (ret >= 0) {\r\nif (info->batt_detect)\r\ninfo->bat_online = (ret & MAX8925_CHG_MBDET) ? 0 : 1;\r\nelse\r\ninfo->bat_online = 1;\r\nif (ret & MAX8925_CHG_AC_RANGE_MASK)\r\ninfo->ac_online = 1;\r\nelse\r\ninfo->ac_online = 0;\r\n}\r\nmax8925_set_bits(info->gpm, MAX8925_CHG_CNTL1, 1 << 7, 1 << 7);\r\nmax8925_set_bits(info->gpm, MAX8925_CHG_CNTL1, 3 << 5,\r\ninfo->topoff_threshold << 5);\r\nmax8925_set_bits(info->gpm, MAX8925_CHG_CNTL1, 7, info->fast_charge);\r\nreturn 0;\r\n}\r\nstatic __devexit int max8925_deinit_charger(struct max8925_power_info *info)\r\n{\r\nstruct max8925_chip *chip = info->chip;\r\nint irq;\r\nirq = chip->irq_base + MAX8925_IRQ_VCHG_DC_OVP;\r\nfor (; irq <= chip->irq_base + MAX8925_IRQ_VCHG_TMR_FAULT; irq++)\r\nfree_irq(irq, info);\r\nreturn 0;\r\n}\r\nstatic __devinit int max8925_power_probe(struct platform_device *pdev)\r\n{\r\nstruct max8925_chip *chip = dev_get_drvdata(pdev->dev.parent);\r\nstruct max8925_power_pdata *pdata = NULL;\r\nstruct max8925_power_info *info;\r\nint ret;\r\npdata = pdev->dev.platform_data;\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "platform data isn't assigned to "\r\n"power supply\n");\r\nreturn -EINVAL;\r\n}\r\ninfo = kzalloc(sizeof(struct max8925_power_info), GFP_KERNEL);\r\nif (!info)\r\nreturn -ENOMEM;\r\ninfo->chip = chip;\r\ninfo->gpm = chip->i2c;\r\ninfo->adc = chip->adc;\r\nplatform_set_drvdata(pdev, info);\r\ninfo->ac.name = "max8925-ac";\r\ninfo->ac.type = POWER_SUPPLY_TYPE_MAINS;\r\ninfo->ac.properties = max8925_ac_props;\r\ninfo->ac.num_properties = ARRAY_SIZE(max8925_ac_props);\r\ninfo->ac.get_property = max8925_ac_get_prop;\r\nret = power_supply_register(&pdev->dev, &info->ac);\r\nif (ret)\r\ngoto out;\r\ninfo->ac.dev->parent = &pdev->dev;\r\ninfo->usb.name = "max8925-usb";\r\ninfo->usb.type = POWER_SUPPLY_TYPE_USB;\r\ninfo->usb.properties = max8925_usb_props;\r\ninfo->usb.num_properties = ARRAY_SIZE(max8925_usb_props);\r\ninfo->usb.get_property = max8925_usb_get_prop;\r\nret = power_supply_register(&pdev->dev, &info->usb);\r\nif (ret)\r\ngoto out_usb;\r\ninfo->usb.dev->parent = &pdev->dev;\r\ninfo->battery.name = "max8925-battery";\r\ninfo->battery.type = POWER_SUPPLY_TYPE_BATTERY;\r\ninfo->battery.properties = max8925_battery_props;\r\ninfo->battery.num_properties = ARRAY_SIZE(max8925_battery_props);\r\ninfo->battery.get_property = max8925_bat_get_prop;\r\nret = power_supply_register(&pdev->dev, &info->battery);\r\nif (ret)\r\ngoto out_battery;\r\ninfo->battery.dev->parent = &pdev->dev;\r\ninfo->batt_detect = pdata->batt_detect;\r\ninfo->topoff_threshold = pdata->topoff_threshold;\r\ninfo->fast_charge = pdata->fast_charge;\r\ninfo->set_charger = pdata->set_charger;\r\nmax8925_init_charger(chip, info);\r\nreturn 0;\r\nout_battery:\r\npower_supply_unregister(&info->battery);\r\nout_usb:\r\npower_supply_unregister(&info->ac);\r\nout:\r\nkfree(info);\r\nreturn ret;\r\n}\r\nstatic __devexit int max8925_power_remove(struct platform_device *pdev)\r\n{\r\nstruct max8925_power_info *info = platform_get_drvdata(pdev);\r\nif (info) {\r\npower_supply_unregister(&info->ac);\r\npower_supply_unregister(&info->usb);\r\npower_supply_unregister(&info->battery);\r\nmax8925_deinit_charger(info);\r\nkfree(info);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init max8925_power_init(void)\r\n{\r\nreturn platform_driver_register(&max8925_power_driver);\r\n}\r\nstatic void __exit max8925_power_exit(void)\r\n{\r\nplatform_driver_unregister(&max8925_power_driver);\r\n}

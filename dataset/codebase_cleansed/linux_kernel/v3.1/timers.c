static irqreturn_t mcftmr_tick(int irq, void *dummy)\r\n{\r\n__raw_writeb(MCFTIMER_TER_CAP | MCFTIMER_TER_REF, TA(MCFTIMER_TER));\r\nmcftmr_cnt += mcftmr_cycles_per_jiffy;\r\nreturn arch_timer_interrupt(irq, dummy);\r\n}\r\nstatic cycle_t mcftmr_read_clk(struct clocksource *cs)\r\n{\r\nunsigned long flags;\r\nu32 cycles;\r\nu16 tcn;\r\nlocal_irq_save(flags);\r\ntcn = __raw_readw(TA(MCFTIMER_TCN));\r\ncycles = mcftmr_cnt;\r\nlocal_irq_restore(flags);\r\nreturn cycles + tcn;\r\n}\r\nvoid hw_timer_init(void)\r\n{\r\n__raw_writew(MCFTIMER_TMR_DISABLE, TA(MCFTIMER_TMR));\r\nmcftmr_cycles_per_jiffy = FREQ / HZ;\r\n__raw_writetrr(mcftmr_cycles_per_jiffy - 1, TA(MCFTIMER_TRR));\r\n__raw_writew(MCFTIMER_TMR_ENORI | MCFTIMER_TMR_CLK16 |\r\nMCFTIMER_TMR_RESTART | MCFTIMER_TMR_ENABLE, TA(MCFTIMER_TMR));\r\nmcftmr_clk.mult = clocksource_hz2mult(FREQ, mcftmr_clk.shift);\r\nclocksource_register(&mcftmr_clk);\r\nsetup_irq(MCF_IRQ_TIMER, &mcftmr_timer_irq);\r\n#ifdef CONFIG_HIGHPROFILE\r\ncoldfire_profile_init();\r\n#endif\r\n}\r\nirqreturn_t coldfire_profile_tick(int irq, void *dummy)\r\n{\r\n__raw_writeb(MCFTIMER_TER_CAP | MCFTIMER_TER_REF, PA(MCFTIMER_TER));\r\nif (current->pid)\r\nprofile_tick(CPU_PROFILING);\r\nreturn IRQ_HANDLED;\r\n}\r\nvoid coldfire_profile_init(void)\r\n{\r\nprintk(KERN_INFO "PROFILE: lodging TIMER2 @ %dHz as profile timer\n",\r\nPROFILEHZ);\r\n__raw_writew(MCFTIMER_TMR_DISABLE, PA(MCFTIMER_TMR));\r\n__raw_writetrr(((MCF_BUSCLK / 16) / PROFILEHZ), PA(MCFTIMER_TRR));\r\n__raw_writew(MCFTIMER_TMR_ENORI | MCFTIMER_TMR_CLK16 |\r\nMCFTIMER_TMR_RESTART | MCFTIMER_TMR_ENABLE, PA(MCFTIMER_TMR));\r\nsetup_irq(MCF_IRQ_PROFILER, &coldfire_profile_irq);\r\n}

static int goni_wm8994_init(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct snd_soc_codec *codec = rtd->codec;\r\nstruct snd_soc_dapm_context *dapm = &codec->dapm;\r\nint ret;\r\nsnd_soc_dapm_new_controls(dapm, goni_dapm_widgets,\r\nARRAY_SIZE(goni_dapm_widgets));\r\nsnd_soc_dapm_add_routes(dapm, goni_dapm_routes,\r\nARRAY_SIZE(goni_dapm_routes));\r\nsnd_soc_dapm_nc_pin(dapm, "IN2LP:VXRN");\r\nsnd_soc_dapm_nc_pin(dapm, "IN2RP:VXRP");\r\nsnd_soc_dapm_nc_pin(dapm, "LINEOUT1N");\r\nsnd_soc_dapm_nc_pin(dapm, "LINEOUT1P");\r\nsnd_soc_dapm_nc_pin(dapm, "LINEOUT2N");\r\nsnd_soc_dapm_nc_pin(dapm, "LINEOUT2P");\r\nif (machine_is_aquila()) {\r\nsnd_soc_dapm_nc_pin(dapm, "SPKOUTRN");\r\nsnd_soc_dapm_nc_pin(dapm, "SPKOUTRP");\r\n}\r\nsnd_soc_dapm_sync(dapm);\r\nret = snd_soc_jack_new(codec, "Headset Jack",\r\nSND_JACK_HEADSET | SND_JACK_MECHANICAL | SND_JACK_AVOUT,\r\n&jack);\r\nif (ret)\r\nreturn ret;\r\nret = snd_soc_jack_add_pins(&jack, ARRAY_SIZE(jack_pins), jack_pins);\r\nif (ret)\r\nreturn ret;\r\nret = snd_soc_jack_add_gpios(&jack, ARRAY_SIZE(jack_gpios), jack_gpios);\r\nif (ret)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int goni_hifi_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nunsigned int pll_out = 24000000;\r\nint ret = 0;\r\nret = snd_soc_dai_set_fmt(cpu_dai, SND_SOC_DAIFMT_I2S |\r\nSND_SOC_DAIFMT_NB_NF | SND_SOC_DAIFMT_CBM_CFM);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_fmt(codec_dai, SND_SOC_DAIFMT_I2S |\r\nSND_SOC_DAIFMT_NB_NF | SND_SOC_DAIFMT_CBM_CFM);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_pll(codec_dai, WM8994_FLL1, 0, pll_out,\r\nparams_rate(params) * 256);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_sysclk(codec_dai, WM8994_SYSCLK_FLL1,\r\nparams_rate(params) * 256, SND_SOC_CLOCK_IN);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int goni_voice_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nunsigned int pll_out = 24000000;\r\nint ret = 0;\r\nif (params_rate(params) != 8000)\r\nreturn -EINVAL;\r\nret = snd_soc_dai_set_fmt(codec_dai, SND_SOC_DAIFMT_LEFT_J |\r\nSND_SOC_DAIFMT_IB_IF | SND_SOC_DAIFMT_CBM_CFM);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_pll(codec_dai, WM8994_FLL2, 0, pll_out,\r\nparams_rate(params) * 256);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_sysclk(codec_dai, WM8994_SYSCLK_FLL2,\r\nparams_rate(params) * 256, SND_SOC_CLOCK_IN);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int __init goni_init(void)\r\n{\r\nint ret;\r\nif (machine_is_aquila()) {\r\nvoice_dai.name = aquila_str[CPU_VOICE_DAI];\r\ngoni_dai[1].cpu_dai_name = aquila_str[CPU_VOICE_DAI];\r\ngoni.name = aquila_str[MACHINE_NAME];\r\n} else if (!machine_is_goni())\r\nreturn -ENODEV;\r\ngoni_snd_device = platform_device_alloc("soc-audio", -1);\r\nif (!goni_snd_device)\r\nreturn -ENOMEM;\r\nret = snd_soc_register_dai(&goni_snd_device->dev, &voice_dai);\r\nif (ret) {\r\nplatform_device_put(goni_snd_device);\r\nreturn ret;\r\n}\r\nplatform_set_drvdata(goni_snd_device, &goni);\r\nret = platform_device_add(goni_snd_device);\r\nif (ret) {\r\nsnd_soc_unregister_dai(&goni_snd_device->dev);\r\nplatform_device_put(goni_snd_device);\r\n}\r\nreturn ret;\r\n}\r\nstatic void __exit goni_exit(void)\r\n{\r\nsnd_soc_unregister_dai(&goni_snd_device->dev);\r\nplatform_device_unregister(goni_snd_device);\r\n}

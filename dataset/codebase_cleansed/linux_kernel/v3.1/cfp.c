u32 mwifiex_index_to_data_rate(u8 index, u8 ht_info)\r\n{\r\nu16 mcs_rate[4][8] = {\r\n{0x1b, 0x36, 0x51, 0x6c, 0xa2, 0xd8, 0xf3, 0x10e}\r\n,\r\n{0x1e, 0x3c, 0x5a, 0x78, 0xb4, 0xf0, 0x10e, 0x12c}\r\n,\r\n{0x0d, 0x1a, 0x27, 0x34, 0x4e, 0x68, 0x75, 0x82}\r\n,\r\n{0x0e, 0x1c, 0x2b, 0x39, 0x56, 0x73, 0x82, 0x90}\r\n};\r\nu32 rate;\r\nif (ht_info & BIT(0)) {\r\nif (index == MWIFIEX_RATE_BITMAP_MCS0) {\r\nif (ht_info & BIT(2))\r\nrate = 0x0D;\r\nelse\r\nrate = 0x0C;\r\n} else if (index < 8) {\r\nif (ht_info & BIT(1)) {\r\nif (ht_info & BIT(2))\r\nrate = mcs_rate[1][index];\r\nelse\r\nrate = mcs_rate[0][index];\r\n} else {\r\nif (ht_info & BIT(2))\r\nrate = mcs_rate[3][index];\r\nelse\r\nrate = mcs_rate[2][index];\r\n}\r\n} else\r\nrate = mwifiex_data_rates[0];\r\n} else {\r\nif (index >= MWIFIEX_SUPPORTED_RATES_EXT)\r\nindex = 0;\r\nrate = mwifiex_data_rates[index];\r\n}\r\nreturn rate;\r\n}\r\nu8 mwifiex_data_rate_to_index(u32 rate)\r\n{\r\nu16 *ptr;\r\nif (rate) {\r\nptr = memchr(mwifiex_data_rates, rate,\r\nsizeof(mwifiex_data_rates));\r\nif (ptr)\r\nreturn (u8) (ptr - mwifiex_data_rates);\r\n}\r\nreturn 0;\r\n}\r\nu32 mwifiex_get_active_data_rates(struct mwifiex_private *priv, u8 *rates)\r\n{\r\nif (!priv->media_connected)\r\nreturn mwifiex_get_supported_rates(priv, rates);\r\nelse\r\nreturn mwifiex_copy_rates(rates, 0,\r\npriv->curr_bss_params.data_rates,\r\npriv->curr_bss_params.num_of_rates);\r\n}\r\nstruct mwifiex_chan_freq_power *\r\nmwifiex_get_cfp_by_band_and_channel_from_cfg80211(struct mwifiex_private\r\n*priv, u8 band, u16 channel)\r\n{\r\nstruct mwifiex_chan_freq_power *cfp = NULL;\r\nstruct ieee80211_supported_band *sband;\r\nstruct ieee80211_channel *ch;\r\nint i;\r\nif (mwifiex_band_to_radio_type(band) == HostCmd_SCAN_RADIO_TYPE_BG)\r\nsband = priv->wdev->wiphy->bands[IEEE80211_BAND_2GHZ];\r\nelse\r\nsband = priv->wdev->wiphy->bands[IEEE80211_BAND_5GHZ];\r\nif (!sband) {\r\ndev_err(priv->adapter->dev, "%s: cannot find cfp by band %d"\r\n" & channel %d\n", __func__, band, channel);\r\nreturn cfp;\r\n}\r\nfor (i = 0; i < sband->n_channels; i++) {\r\nch = &sband->channels[i];\r\nif (((ch->hw_value == channel) ||\r\n(channel == FIRST_VALID_CHANNEL))\r\n&& !(ch->flags & IEEE80211_CHAN_DISABLED)) {\r\npriv->cfp.channel = channel;\r\npriv->cfp.freq = ch->center_freq;\r\npriv->cfp.max_tx_power = ch->max_power;\r\ncfp = &priv->cfp;\r\nbreak;\r\n}\r\n}\r\nif (i == sband->n_channels)\r\ndev_err(priv->adapter->dev, "%s: cannot find cfp by band %d"\r\n" & channel %d\n", __func__, band, channel);\r\nreturn cfp;\r\n}\r\nstruct mwifiex_chan_freq_power *\r\nmwifiex_get_cfp_by_band_and_freq_from_cfg80211(struct mwifiex_private *priv,\r\nu8 band, u32 freq)\r\n{\r\nstruct mwifiex_chan_freq_power *cfp = NULL;\r\nstruct ieee80211_supported_band *sband;\r\nstruct ieee80211_channel *ch;\r\nint i;\r\nif (mwifiex_band_to_radio_type(band) == HostCmd_SCAN_RADIO_TYPE_BG)\r\nsband = priv->wdev->wiphy->bands[IEEE80211_BAND_2GHZ];\r\nelse\r\nsband = priv->wdev->wiphy->bands[IEEE80211_BAND_5GHZ];\r\nif (!sband) {\r\ndev_err(priv->adapter->dev, "%s: cannot find cfp by band %d"\r\n" & freq %d\n", __func__, band, freq);\r\nreturn cfp;\r\n}\r\nfor (i = 0; i < sband->n_channels; i++) {\r\nch = &sband->channels[i];\r\nif ((ch->center_freq == freq) &&\r\n!(ch->flags & IEEE80211_CHAN_DISABLED)) {\r\npriv->cfp.channel = ch->hw_value;\r\npriv->cfp.freq = freq;\r\npriv->cfp.max_tx_power = ch->max_power;\r\ncfp = &priv->cfp;\r\nbreak;\r\n}\r\n}\r\nif (i == sband->n_channels)\r\ndev_err(priv->adapter->dev, "%s: cannot find cfp by band %d"\r\n" & freq %d\n", __func__, band, freq);\r\nreturn cfp;\r\n}\r\nu8\r\nmwifiex_is_rate_auto(struct mwifiex_private *priv)\r\n{\r\nu32 i;\r\nint rate_num = 0;\r\nfor (i = 0; i < ARRAY_SIZE(priv->bitmap_rates); i++)\r\nif (priv->bitmap_rates[i])\r\nrate_num++;\r\nif (rate_num > 1)\r\nreturn true;\r\nelse\r\nreturn false;\r\n}\r\nint mwifiex_get_rate_index(u16 *rate_bitmap, int size)\r\n{\r\nint i;\r\nfor (i = 0; i < size * 8; i++)\r\nif (rate_bitmap[i / 16] & (1 << (i % 16)))\r\nreturn i;\r\nreturn 0;\r\n}\r\nu32 mwifiex_get_supported_rates(struct mwifiex_private *priv, u8 *rates)\r\n{\r\nu32 k = 0;\r\nstruct mwifiex_adapter *adapter = priv->adapter;\r\nif (priv->bss_mode == NL80211_IFTYPE_STATION) {\r\nswitch (adapter->config_bands) {\r\ncase BAND_B:\r\ndev_dbg(adapter->dev, "info: infra band=%d "\r\n"supported_rates_b\n", adapter->config_bands);\r\nk = mwifiex_copy_rates(rates, k, supported_rates_b,\r\nsizeof(supported_rates_b));\r\nbreak;\r\ncase BAND_G:\r\ncase BAND_G | BAND_GN:\r\ndev_dbg(adapter->dev, "info: infra band=%d "\r\n"supported_rates_g\n", adapter->config_bands);\r\nk = mwifiex_copy_rates(rates, k, supported_rates_g,\r\nsizeof(supported_rates_g));\r\nbreak;\r\ncase BAND_B | BAND_G:\r\ncase BAND_A | BAND_B | BAND_G:\r\ncase BAND_A | BAND_B:\r\ncase BAND_A | BAND_B | BAND_G | BAND_GN | BAND_AN:\r\ncase BAND_B | BAND_G | BAND_GN:\r\ndev_dbg(adapter->dev, "info: infra band=%d "\r\n"supported_rates_bg\n", adapter->config_bands);\r\nk = mwifiex_copy_rates(rates, k, supported_rates_bg,\r\nsizeof(supported_rates_bg));\r\nbreak;\r\ncase BAND_A:\r\ncase BAND_A | BAND_G:\r\ndev_dbg(adapter->dev, "info: infra band=%d "\r\n"supported_rates_a\n", adapter->config_bands);\r\nk = mwifiex_copy_rates(rates, k, supported_rates_a,\r\nsizeof(supported_rates_a));\r\nbreak;\r\ncase BAND_A | BAND_AN:\r\ncase BAND_A | BAND_G | BAND_AN | BAND_GN:\r\ndev_dbg(adapter->dev, "info: infra band=%d "\r\n"supported_rates_a\n", adapter->config_bands);\r\nk = mwifiex_copy_rates(rates, k, supported_rates_a,\r\nsizeof(supported_rates_a));\r\nbreak;\r\ncase BAND_GN:\r\ndev_dbg(adapter->dev, "info: infra band=%d "\r\n"supported_rates_n\n", adapter->config_bands);\r\nk = mwifiex_copy_rates(rates, k, supported_rates_n,\r\nsizeof(supported_rates_n));\r\nbreak;\r\n}\r\n} else {\r\nswitch (adapter->adhoc_start_band) {\r\ncase BAND_B:\r\ndev_dbg(adapter->dev, "info: adhoc B\n");\r\nk = mwifiex_copy_rates(rates, k, adhoc_rates_b,\r\nsizeof(adhoc_rates_b));\r\nbreak;\r\ncase BAND_G:\r\ncase BAND_G | BAND_GN:\r\ndev_dbg(adapter->dev, "info: adhoc G only\n");\r\nk = mwifiex_copy_rates(rates, k, adhoc_rates_g,\r\nsizeof(adhoc_rates_g));\r\nbreak;\r\ncase BAND_B | BAND_G:\r\ncase BAND_B | BAND_G | BAND_GN:\r\ndev_dbg(adapter->dev, "info: adhoc BG\n");\r\nk = mwifiex_copy_rates(rates, k, adhoc_rates_bg,\r\nsizeof(adhoc_rates_bg));\r\nbreak;\r\ncase BAND_A:\r\ncase BAND_A | BAND_AN:\r\ndev_dbg(adapter->dev, "info: adhoc A\n");\r\nk = mwifiex_copy_rates(rates, k, adhoc_rates_a,\r\nsizeof(adhoc_rates_a));\r\nbreak;\r\n}\r\n}\r\nreturn k;\r\n}

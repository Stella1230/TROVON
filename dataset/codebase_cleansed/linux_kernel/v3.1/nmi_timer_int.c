static int profile_timer_exceptions_notify(struct notifier_block *self,\r\nunsigned long val, void *data)\r\n{\r\nstruct die_args *args = (struct die_args *)data;\r\nint ret = NOTIFY_DONE;\r\nswitch (val) {\r\ncase DIE_NMI:\r\noprofile_add_sample(args->regs, 0);\r\nret = NOTIFY_STOP;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int timer_start(void)\r\n{\r\nif (register_die_notifier(&profile_timer_exceptions_nb))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic void timer_stop(void)\r\n{\r\nunregister_die_notifier(&profile_timer_exceptions_nb);\r\nsynchronize_sched();\r\n}\r\nint __init op_nmi_timer_init(struct oprofile_operations *ops)\r\n{\r\nops->start = timer_start;\r\nops->stop = timer_stop;\r\nops->cpu_type = "timer";\r\nprintk(KERN_INFO "oprofile: using NMI timer interrupt.\n");\r\nreturn 0;\r\n}

static int s3c2412_i2s_probe(struct snd_soc_dai *dai)\r\n{\r\nint ret;\r\npr_debug("Entered %s\n", __func__);\r\nret = s3c_i2sv2_probe(dai, &s3c2412_i2s, S3C2410_PA_IIS);\r\nif (ret)\r\nreturn ret;\r\ns3c2412_i2s.dma_capture = &s3c2412_i2s_pcm_stereo_in;\r\ns3c2412_i2s.dma_playback = &s3c2412_i2s_pcm_stereo_out;\r\ns3c2412_i2s.iis_cclk = clk_get(dai->dev, "i2sclk");\r\nif (s3c2412_i2s.iis_cclk == NULL) {\r\npr_err("failed to get i2sclk clock\n");\r\niounmap(s3c2412_i2s.regs);\r\nreturn -ENODEV;\r\n}\r\nclk_set_parent(s3c2412_i2s.iis_cclk, clk_get(NULL, "mpll"));\r\nclk_enable(s3c2412_i2s.iis_cclk);\r\ns3c2412_i2s.iis_cclk = s3c2412_i2s.iis_pclk;\r\ns3c2410_gpio_cfgpin(S3C2410_GPE0, S3C2410_GPE0_I2SLRCK);\r\ns3c2410_gpio_cfgpin(S3C2410_GPE1, S3C2410_GPE1_I2SSCLK);\r\ns3c2410_gpio_cfgpin(S3C2410_GPE2, S3C2410_GPE2_CDCLK);\r\ns3c2410_gpio_cfgpin(S3C2410_GPE3, S3C2410_GPE3_I2SSDI);\r\ns3c2410_gpio_cfgpin(S3C2410_GPE4, S3C2410_GPE4_I2SSDO);\r\nreturn 0;\r\n}\r\nstatic int s3c2412_i2s_remove(struct snd_soc_dai *dai)\r\n{\r\nclk_disable(s3c2412_i2s.iis_cclk);\r\nclk_put(s3c2412_i2s.iis_cclk);\r\niounmap(s3c2412_i2s.regs);\r\nreturn 0;\r\n}\r\nstatic int s3c2412_i2s_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *cpu_dai)\r\n{\r\nstruct s3c_i2sv2_info *i2s = snd_soc_dai_get_drvdata(cpu_dai);\r\nstruct s3c_dma_params *dma_data;\r\nu32 iismod;\r\npr_debug("Entered %s\n", __func__);\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\ndma_data = i2s->dma_playback;\r\nelse\r\ndma_data = i2s->dma_capture;\r\nsnd_soc_dai_set_dma_data(cpu_dai, substream, dma_data);\r\niismod = readl(i2s->regs + S3C2412_IISMOD);\r\npr_debug("%s: r: IISMOD: %x\n", __func__, iismod);\r\nswitch (params_format(params)) {\r\ncase SNDRV_PCM_FORMAT_S8:\r\niismod |= S3C2412_IISMOD_8BIT;\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S16_LE:\r\niismod &= ~S3C2412_IISMOD_8BIT;\r\nbreak;\r\n}\r\nwritel(iismod, i2s->regs + S3C2412_IISMOD);\r\npr_debug("%s: w: IISMOD: %x\n", __func__, iismod);\r\nreturn 0;\r\n}\r\nstatic __devinit int s3c2412_iis_dev_probe(struct platform_device *pdev)\r\n{\r\nreturn snd_soc_register_dai(&pdev->dev, &s3c2412_i2s_dai);\r\n}\r\nstatic __devexit int s3c2412_iis_dev_remove(struct platform_device *pdev)\r\n{\r\nsnd_soc_unregister_dai(&pdev->dev);\r\nreturn 0;\r\n}\r\nstatic int __init s3c2412_i2s_init(void)\r\n{\r\nreturn platform_driver_register(&s3c2412_iis_driver);\r\n}\r\nstatic void __exit s3c2412_i2s_exit(void)\r\n{\r\nplatform_driver_unregister(&s3c2412_iis_driver);\r\n}

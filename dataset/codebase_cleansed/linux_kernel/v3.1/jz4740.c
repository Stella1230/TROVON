static unsigned int jz4740_codec_read(struct snd_soc_codec *codec,\r\nunsigned int reg)\r\n{\r\nstruct jz4740_codec *jz4740_codec = snd_soc_codec_get_drvdata(codec);\r\nreturn readl(jz4740_codec->base + (reg << 2));\r\n}\r\nstatic int jz4740_codec_write(struct snd_soc_codec *codec, unsigned int reg,\r\nunsigned int val)\r\n{\r\nstruct jz4740_codec *jz4740_codec = snd_soc_codec_get_drvdata(codec);\r\nu32 *cache = codec->reg_cache;\r\ncache[reg] = val;\r\nwritel(val, jz4740_codec->base + (reg << 2));\r\nreturn 0;\r\n}\r\nstatic int jz4740_codec_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params, struct snd_soc_dai *dai)\r\n{\r\nuint32_t val;\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_codec *codec =rtd->codec;\r\nswitch (params_rate(params)) {\r\ncase 8000:\r\nval = 0;\r\nbreak;\r\ncase 11025:\r\nval = 1;\r\nbreak;\r\ncase 12000:\r\nval = 2;\r\nbreak;\r\ncase 16000:\r\nval = 3;\r\nbreak;\r\ncase 22050:\r\nval = 4;\r\nbreak;\r\ncase 24000:\r\nval = 5;\r\nbreak;\r\ncase 32000:\r\nval = 6;\r\nbreak;\r\ncase 44100:\r\nval = 7;\r\nbreak;\r\ncase 48000:\r\nval = 8;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nval <<= JZ4740_CODEC_2_SAMPLE_RATE_OFFSET;\r\nsnd_soc_update_bits(codec, JZ4740_REG_CODEC_2,\r\nJZ4740_CODEC_2_SAMPLE_RATE_MASK, val);\r\nreturn 0;\r\n}\r\nstatic void jz4740_codec_wakeup(struct snd_soc_codec *codec)\r\n{\r\nint i;\r\nuint32_t *cache = codec->reg_cache;\r\nsnd_soc_update_bits(codec, JZ4740_REG_CODEC_1,\r\nJZ4740_CODEC_1_RESET, JZ4740_CODEC_1_RESET);\r\nudelay(2);\r\nsnd_soc_update_bits(codec, JZ4740_REG_CODEC_1,\r\nJZ4740_CODEC_1_SUSPEND | JZ4740_CODEC_1_RESET, 0);\r\nfor (i = 0; i < ARRAY_SIZE(jz4740_codec_regs); ++i)\r\njz4740_codec_write(codec, i, cache[i]);\r\n}\r\nstatic int jz4740_codec_set_bias_level(struct snd_soc_codec *codec,\r\nenum snd_soc_bias_level level)\r\n{\r\nunsigned int mask;\r\nunsigned int value;\r\nswitch (level) {\r\ncase SND_SOC_BIAS_ON:\r\nbreak;\r\ncase SND_SOC_BIAS_PREPARE:\r\nmask = JZ4740_CODEC_1_VREF_DISABLE |\r\nJZ4740_CODEC_1_VREF_AMP_DISABLE |\r\nJZ4740_CODEC_1_HEADPHONE_POWERDOWN_M;\r\nvalue = 0;\r\nsnd_soc_update_bits(codec, JZ4740_REG_CODEC_1, mask, value);\r\nbreak;\r\ncase SND_SOC_BIAS_STANDBY:\r\nif (codec->dapm.bias_level == SND_SOC_BIAS_OFF)\r\njz4740_codec_wakeup(codec);\r\nmask = JZ4740_CODEC_1_VREF_DISABLE |\r\nJZ4740_CODEC_1_VREF_AMP_DISABLE |\r\nJZ4740_CODEC_1_HEADPHONE_POWERDOWN_M;\r\nvalue = JZ4740_CODEC_1_VREF_DISABLE |\r\nJZ4740_CODEC_1_VREF_AMP_DISABLE |\r\nJZ4740_CODEC_1_HEADPHONE_POWERDOWN_M;\r\nsnd_soc_update_bits(codec, JZ4740_REG_CODEC_1, mask, value);\r\nbreak;\r\ncase SND_SOC_BIAS_OFF:\r\nmask = JZ4740_CODEC_1_SUSPEND;\r\nvalue = JZ4740_CODEC_1_SUSPEND;\r\nsnd_soc_update_bits(codec, JZ4740_REG_CODEC_1, mask, value);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\ncodec->dapm.bias_level = level;\r\nreturn 0;\r\n}\r\nstatic int jz4740_codec_dev_probe(struct snd_soc_codec *codec)\r\n{\r\nsnd_soc_update_bits(codec, JZ4740_REG_CODEC_1,\r\nJZ4740_CODEC_1_SW2_ENABLE, JZ4740_CODEC_1_SW2_ENABLE);\r\njz4740_codec_set_bias_level(codec, SND_SOC_BIAS_STANDBY);\r\nreturn 0;\r\n}\r\nstatic int jz4740_codec_dev_remove(struct snd_soc_codec *codec)\r\n{\r\njz4740_codec_set_bias_level(codec, SND_SOC_BIAS_OFF);\r\nreturn 0;\r\n}\r\nstatic int jz4740_codec_suspend(struct snd_soc_codec *codec, pm_message_t state)\r\n{\r\nreturn jz4740_codec_set_bias_level(codec, SND_SOC_BIAS_OFF);\r\n}\r\nstatic int jz4740_codec_resume(struct snd_soc_codec *codec)\r\n{\r\nreturn jz4740_codec_set_bias_level(codec, SND_SOC_BIAS_STANDBY);\r\n}\r\nstatic int __devinit jz4740_codec_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct jz4740_codec *jz4740_codec;\r\nstruct resource *mem;\r\njz4740_codec = kzalloc(sizeof(*jz4740_codec), GFP_KERNEL);\r\nif (!jz4740_codec)\r\nreturn -ENOMEM;\r\nmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!mem) {\r\ndev_err(&pdev->dev, "Failed to get mmio memory resource\n");\r\nret = -ENOENT;\r\ngoto err_free_codec;\r\n}\r\nmem = request_mem_region(mem->start, resource_size(mem), pdev->name);\r\nif (!mem) {\r\ndev_err(&pdev->dev, "Failed to request mmio memory region\n");\r\nret = -EBUSY;\r\ngoto err_free_codec;\r\n}\r\njz4740_codec->base = ioremap(mem->start, resource_size(mem));\r\nif (!jz4740_codec->base) {\r\ndev_err(&pdev->dev, "Failed to ioremap mmio memory\n");\r\nret = -EBUSY;\r\ngoto err_release_mem_region;\r\n}\r\njz4740_codec->mem = mem;\r\nplatform_set_drvdata(pdev, jz4740_codec);\r\nret = snd_soc_register_codec(&pdev->dev,\r\n&soc_codec_dev_jz4740_codec, &jz4740_codec_dai, 1);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to register codec\n");\r\ngoto err_iounmap;\r\n}\r\nreturn 0;\r\nerr_iounmap:\r\niounmap(jz4740_codec->base);\r\nerr_release_mem_region:\r\nrelease_mem_region(mem->start, resource_size(mem));\r\nerr_free_codec:\r\nkfree(jz4740_codec);\r\nreturn ret;\r\n}\r\nstatic int __devexit jz4740_codec_remove(struct platform_device *pdev)\r\n{\r\nstruct jz4740_codec *jz4740_codec = platform_get_drvdata(pdev);\r\nstruct resource *mem = jz4740_codec->mem;\r\nsnd_soc_unregister_codec(&pdev->dev);\r\niounmap(jz4740_codec->base);\r\nrelease_mem_region(mem->start, resource_size(mem));\r\nplatform_set_drvdata(pdev, NULL);\r\nkfree(jz4740_codec);\r\nreturn 0;\r\n}\r\nstatic int __init jz4740_codec_init(void)\r\n{\r\nreturn platform_driver_register(&jz4740_codec_driver);\r\n}\r\nstatic void __exit jz4740_codec_exit(void)\r\n{\r\nplatform_driver_unregister(&jz4740_codec_driver);\r\n}

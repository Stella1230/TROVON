static inline struct xencons_interface *xencons_interface(void)\r\n{\r\nif (console_pfn == ~0ul)\r\nreturn mfn_to_virt(xen_start_info->console.domU.mfn);\r\nelse\r\nreturn __va(console_pfn << PAGE_SHIFT);\r\n}\r\nstatic inline void notify_daemon(void)\r\n{\r\nnotify_remote_via_evtchn(xen_start_info->console.domU.evtchn);\r\n}\r\nstatic int __write_console(const char *data, int len)\r\n{\r\nstruct xencons_interface *intf = xencons_interface();\r\nXENCONS_RING_IDX cons, prod;\r\nint sent = 0;\r\ncons = intf->out_cons;\r\nprod = intf->out_prod;\r\nmb();\r\nBUG_ON((prod - cons) > sizeof(intf->out));\r\nwhile ((sent < len) && ((prod - cons) < sizeof(intf->out)))\r\nintf->out[MASK_XENCONS_IDX(prod++, intf->out)] = data[sent++];\r\nwmb();\r\nintf->out_prod = prod;\r\nif (sent)\r\nnotify_daemon();\r\nreturn sent;\r\n}\r\nstatic int domU_write_console(uint32_t vtermno, const char *data, int len)\r\n{\r\nint ret = len;\r\nwhile (len) {\r\nint sent = __write_console(data, len);\r\ndata += sent;\r\nlen -= sent;\r\nif (unlikely(len))\r\nHYPERVISOR_sched_op(SCHEDOP_yield, NULL);\r\n}\r\nreturn ret;\r\n}\r\nstatic int domU_read_console(uint32_t vtermno, char *buf, int len)\r\n{\r\nstruct xencons_interface *intf = xencons_interface();\r\nXENCONS_RING_IDX cons, prod;\r\nint recv = 0;\r\ncons = intf->in_cons;\r\nprod = intf->in_prod;\r\nmb();\r\nBUG_ON((prod - cons) > sizeof(intf->in));\r\nwhile (cons != prod && recv < len)\r\nbuf[recv++] = intf->in[MASK_XENCONS_IDX(cons++, intf->in)];\r\nmb();\r\nintf->in_cons = cons;\r\nnotify_daemon();\r\nreturn recv;\r\n}\r\nstatic int dom0_read_console(uint32_t vtermno, char *buf, int len)\r\n{\r\nreturn HYPERVISOR_console_io(CONSOLEIO_read, len, buf);\r\n}\r\nstatic int dom0_write_console(uint32_t vtermno, const char *str, int len)\r\n{\r\nint rc = HYPERVISOR_console_io(CONSOLEIO_write, len, (char *)str);\r\nif (rc < 0)\r\nreturn 0;\r\nreturn len;\r\n}\r\nstatic int __init xen_hvc_init(void)\r\n{\r\nstruct hvc_struct *hp;\r\nstruct hv_ops *ops;\r\nif (!xen_pv_domain())\r\nreturn -ENODEV;\r\nif (xen_initial_domain()) {\r\nops = &dom0_hvc_ops;\r\nxencons_irq = bind_virq_to_irq(VIRQ_CONSOLE, 0);\r\n} else {\r\nif (!xen_start_info->console.domU.evtchn)\r\nreturn -ENODEV;\r\nops = &domU_hvc_ops;\r\nxencons_irq = bind_evtchn_to_irq(xen_start_info->console.domU.evtchn);\r\n}\r\nif (xencons_irq < 0)\r\nxencons_irq = 0;\r\nelse\r\nirq_set_noprobe(xencons_irq);\r\nhp = hvc_alloc(HVC_COOKIE, xencons_irq, ops, 256);\r\nif (IS_ERR(hp))\r\nreturn PTR_ERR(hp);\r\nhvc = hp;\r\nconsole_pfn = mfn_to_pfn(xen_start_info->console.domU.mfn);\r\nreturn 0;\r\n}\r\nvoid xen_console_resume(void)\r\n{\r\nif (xencons_irq)\r\nrebind_evtchn_irq(xen_start_info->console.domU.evtchn, xencons_irq);\r\n}\r\nstatic void __exit xen_hvc_fini(void)\r\n{\r\nif (hvc)\r\nhvc_remove(hvc);\r\n}\r\nstatic int xen_cons_init(void)\r\n{\r\nstruct hv_ops *ops;\r\nif (!xen_pv_domain())\r\nreturn 0;\r\nif (xen_initial_domain())\r\nops = &dom0_hvc_ops;\r\nelse\r\nops = &domU_hvc_ops;\r\nhvc_instantiate(HVC_COOKIE, 0, ops);\r\nreturn 0;\r\n}\r\nstatic void xenboot_write_console(struct console *console, const char *string,\r\nunsigned len)\r\n{\r\nunsigned int linelen, off = 0;\r\nconst char *pos;\r\ndom0_write_console(0, string, len);\r\nif (xen_initial_domain())\r\nreturn;\r\ndomU_write_console(0, "(early) ", 8);\r\nwhile (off < len && NULL != (pos = strchr(string+off, '\n'))) {\r\nlinelen = pos-string+off;\r\nif (off + linelen > len)\r\nbreak;\r\ndomU_write_console(0, string+off, linelen);\r\ndomU_write_console(0, "\r\n", 2);\r\noff += linelen + 1;\r\n}\r\nif (off < len)\r\ndomU_write_console(0, string+off, len-off);\r\n}\r\nvoid xen_raw_console_write(const char *str)\r\n{\r\ndom0_write_console(0, str, strlen(str));\r\n}\r\nvoid xen_raw_printk(const char *fmt, ...)\r\n{\r\nstatic char buf[512];\r\nva_list ap;\r\nva_start(ap, fmt);\r\nvsnprintf(buf, sizeof(buf), fmt, ap);\r\nva_end(ap);\r\nxen_raw_console_write(buf);\r\n}

void __init baboon_init(void)\r\n{\r\nif (macintosh_config->ident != MAC_MODEL_PB190) {\r\nbaboon = NULL;\r\nbaboon_present = 0;\r\nreturn;\r\n}\r\nbaboon = (struct baboon *) BABOON_BASE;\r\nbaboon_present = 1;\r\nprintk("Baboon detected at %p\n", baboon);\r\n}\r\nstatic irqreturn_t baboon_irq(int irq, void *dev_id)\r\n{\r\nint irq_bit, irq_num;\r\nunsigned char events;\r\n#ifdef DEBUG_IRQS\r\nprintk("baboon_irq: mb_control %02X mb_ifr %02X mb_status %02X\n",\r\n(uint) baboon->mb_control, (uint) baboon->mb_ifr,\r\n(uint) baboon->mb_status);\r\n#endif\r\nif (!(events = baboon->mb_ifr & 0x07))\r\nreturn IRQ_NONE;\r\nirq_num = IRQ_BABOON_0;\r\nirq_bit = 1;\r\ndo {\r\nif (events & irq_bit) {\r\nbaboon->mb_ifr &= ~irq_bit;\r\nm68k_handle_int(irq_num);\r\n}\r\nirq_bit <<= 1;\r\nirq_num++;\r\n} while(events >= irq_bit);\r\n#if 0\r\nif (baboon->mb_ifr & 0x02) macide_ack_intr(NULL);\r\nbaboon->mb_ifr &= ~events;\r\n#endif\r\nreturn IRQ_HANDLED;\r\n}\r\nvoid __init baboon_register_interrupts(void)\r\n{\r\nbaboon_disabled = 0;\r\nif (request_irq(IRQ_NUBUS_C, baboon_irq, 0, "baboon", (void *)baboon))\r\npr_err("Couldn't register baboon interrupt\n");\r\n}\r\nvoid baboon_irq_enable(int irq)\r\n{\r\nint irq_idx = IRQ_IDX(irq);\r\n#ifdef DEBUG_IRQUSE\r\nprintk("baboon_irq_enable(%d)\n", irq);\r\n#endif\r\nbaboon_disabled &= ~(1 << irq_idx);\r\nif (!baboon_disabled)\r\nmac_enable_irq(IRQ_NUBUS_C);\r\n}\r\nvoid baboon_irq_disable(int irq)\r\n{\r\nint irq_idx = IRQ_IDX(irq);\r\n#ifdef DEBUG_IRQUSE\r\nprintk("baboon_irq_disable(%d)\n", irq);\r\n#endif\r\nbaboon_disabled |= 1 << irq_idx;\r\nif (baboon_disabled)\r\nmac_disable_irq(IRQ_NUBUS_C);\r\n}\r\nvoid baboon_irq_clear(int irq)\r\n{\r\nint irq_idx = IRQ_IDX(irq);\r\nbaboon->mb_ifr &= ~(1 << irq_idx);\r\n}\r\nint baboon_irq_pending(int irq)\r\n{\r\nint irq_idx = IRQ_IDX(irq);\r\nreturn baboon->mb_ifr & (1 << irq_idx);\r\n}

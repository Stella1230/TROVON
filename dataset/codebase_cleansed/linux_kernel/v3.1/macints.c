void __init mac_init_IRQ(void)\r\n{\r\n#ifdef DEBUG_MACINTS\r\nprintk("mac_init_IRQ(): Setting things up...\n");\r\n#endif\r\nm68k_setup_irq_controller(&mac_irq_controller, IRQ_USER,\r\nNUM_MAC_SOURCES - IRQ_USER);\r\n#ifdef SHUTUP_SONIC\r\nprintk("Killing onboard sonic... ");\r\nif (hwreg_present((void*)(0x50f0a000))) {\r\n*(long *)(0x50f0a014) = 0x7fffL;\r\n*(long *)(0x50f0a010) = 0L;\r\n}\r\nprintk("Done.\n");\r\n#endif\r\nif (oss_present)\r\noss_register_interrupts();\r\nelse\r\nvia_register_interrupts();\r\nif (psc_present)\r\npsc_register_interrupts();\r\nif (baboon_present)\r\nbaboon_register_interrupts();\r\niop_register_interrupts();\r\nif (request_irq(IRQ_AUTO_7, mac_nmi_handler, 0, "NMI",\r\nmac_nmi_handler))\r\npr_err("Couldn't register NMI\n");\r\n#ifdef DEBUG_MACINTS\r\nprintk("mac_init_IRQ(): Done!\n");\r\n#endif\r\n}\r\nvoid mac_enable_irq(unsigned int irq)\r\n{\r\nint irq_src = IRQ_SRC(irq);\r\nswitch(irq_src) {\r\ncase 1:\r\nvia_irq_enable(irq);\r\nbreak;\r\ncase 2:\r\ncase 7:\r\nif (oss_present)\r\noss_irq_enable(irq);\r\nelse\r\nvia_irq_enable(irq);\r\nbreak;\r\ncase 3:\r\ncase 5:\r\ncase 6:\r\nif (psc_present)\r\npsc_irq_enable(irq);\r\nelse if (oss_present)\r\noss_irq_enable(irq);\r\nbreak;\r\ncase 4:\r\nif (psc_present)\r\npsc_irq_enable(irq);\r\nbreak;\r\ncase 8:\r\nif (baboon_present)\r\nbaboon_irq_enable(irq);\r\nbreak;\r\n}\r\n}\r\nvoid mac_disable_irq(unsigned int irq)\r\n{\r\nint irq_src = IRQ_SRC(irq);\r\nswitch(irq_src) {\r\ncase 1:\r\nvia_irq_disable(irq);\r\nbreak;\r\ncase 2:\r\ncase 7:\r\nif (oss_present)\r\noss_irq_disable(irq);\r\nelse\r\nvia_irq_disable(irq);\r\nbreak;\r\ncase 3:\r\ncase 5:\r\ncase 6:\r\nif (psc_present)\r\npsc_irq_disable(irq);\r\nelse if (oss_present)\r\noss_irq_disable(irq);\r\nbreak;\r\ncase 4:\r\nif (psc_present)\r\npsc_irq_disable(irq);\r\nbreak;\r\ncase 8:\r\nif (baboon_present)\r\nbaboon_irq_disable(irq);\r\nbreak;\r\n}\r\n}\r\nvoid mac_clear_irq(unsigned int irq)\r\n{\r\nswitch(IRQ_SRC(irq)) {\r\ncase 1:\r\nvia_irq_clear(irq);\r\nbreak;\r\ncase 2:\r\ncase 7:\r\nif (oss_present)\r\noss_irq_clear(irq);\r\nelse\r\nvia_irq_clear(irq);\r\nbreak;\r\ncase 3:\r\ncase 5:\r\ncase 6:\r\nif (psc_present)\r\npsc_irq_clear(irq);\r\nelse if (oss_present)\r\noss_irq_clear(irq);\r\nbreak;\r\ncase 4:\r\nif (psc_present)\r\npsc_irq_clear(irq);\r\nbreak;\r\ncase 8:\r\nif (baboon_present)\r\nbaboon_irq_clear(irq);\r\nbreak;\r\n}\r\n}\r\nint mac_irq_pending(unsigned int irq)\r\n{\r\nswitch(IRQ_SRC(irq)) {\r\ncase 1:\r\nreturn via_irq_pending(irq);\r\ncase 2:\r\ncase 7:\r\nif (oss_present)\r\nreturn oss_irq_pending(irq);\r\nelse\r\nreturn via_irq_pending(irq);\r\ncase 3:\r\ncase 5:\r\ncase 6:\r\nif (psc_present)\r\nreturn psc_irq_pending(irq);\r\nelse if (oss_present)\r\nreturn oss_irq_pending(irq);\r\nbreak;\r\ncase 4:\r\nif (psc_present)\r\npsc_irq_pending(irq);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nirqreturn_t mac_debug_handler(int irq, void *dev_id)\r\n{\r\nif (num_debug[irq] < 10) {\r\nprintk("DEBUG: Unexpected IRQ %d\n", irq);\r\nnum_debug[irq]++;\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nirqreturn_t mac_nmi_handler(int irq, void *dev_id)\r\n{\r\nint i;\r\nin_nmi++;\r\nfor (i=0; i<100; i++)\r\nudelay(1000);\r\nif (in_nmi == 1) {\r\nnmi_hold = 1;\r\nprintk("... pausing, press NMI to resume ...");\r\n} else {\r\nprintk(" ok!\n");\r\nnmi_hold = 0;\r\n}\r\nbarrier();\r\nwhile (nmi_hold == 1)\r\nudelay(1000);\r\nif (console_loglevel >= 8) {\r\n#if 0\r\nstruct pt_regs *fp = get_irq_regs();\r\nshow_state();\r\nprintk("PC: %08lx\nSR: %04x SP: %p\n", fp->pc, fp->sr, fp);\r\nprintk("d0: %08lx d1: %08lx d2: %08lx d3: %08lx\n",\r\nfp->d0, fp->d1, fp->d2, fp->d3);\r\nprintk("d4: %08lx d5: %08lx a0: %08lx a1: %08lx\n",\r\nfp->d4, fp->d5, fp->a0, fp->a1);\r\nif (STACK_MAGIC != *(unsigned long *)current->kernel_stack_page)\r\nprintk("Corrupted stack page\n");\r\nprintk("Process %s (pid: %d, stackpage=%08lx)\n",\r\ncurrent->comm, current->pid, current->kernel_stack_page);\r\nif (intr_count == 1)\r\ndump_stack((struct frame *)fp);\r\n#else\r\n#endif\r\n}\r\nin_nmi--;\r\nreturn IRQ_HANDLED;\r\n}

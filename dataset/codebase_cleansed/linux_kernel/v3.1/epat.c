static void epat_write_regr( PIA *pi, int cont, int regr, int val)\r\n{ int r;\r\nr = regr + cont_map[cont];\r\nswitch (pi->mode) {\r\ncase 0:\r\ncase 1:\r\ncase 2: w0(0x60+r); w2(1); w0(val); w2(4);\r\nbreak;\r\ncase 3:\r\ncase 4:\r\ncase 5: w3(0x40+r); w4(val);\r\nbreak;\r\n}\r\n}\r\nstatic int epat_read_regr( PIA *pi, int cont, int regr )\r\n{ int a, b, r;\r\nr = regr + cont_map[cont];\r\nswitch (pi->mode) {\r\ncase 0: w0(r); w2(1); w2(3);\r\na = r1(); w2(4); b = r1();\r\nreturn j44(a,b);\r\ncase 1: w0(0x40+r); w2(1); w2(4);\r\na = r1(); b = r2(); w0(0xff);\r\nreturn j53(a,b);\r\ncase 2: w0(0x20+r); w2(1); w2(0x25);\r\na = r0(); w2(4);\r\nreturn a;\r\ncase 3:\r\ncase 4:\r\ncase 5: w3(r); w2(0x24); a = r4(); w2(4);\r\nreturn a;\r\n}\r\nreturn -1;\r\n}\r\nstatic void epat_read_block( PIA *pi, char * buf, int count )\r\n{ int k, ph, a, b;\r\nswitch (pi->mode) {\r\ncase 0: w0(7); w2(1); w2(3); w0(0xff);\r\nph = 0;\r\nfor(k=0;k<count;k++) {\r\nif (k == count-1) w0(0xfd);\r\nw2(6+ph); a = r1();\r\nif (a & 8) b = a;\r\nelse { w2(4+ph); b = r1(); }\r\nbuf[k] = j44(a,b);\r\nph = 1 - ph;\r\n}\r\nw0(0); w2(4);\r\nbreak;\r\ncase 1: w0(0x47); w2(1); w2(5); w0(0xff);\r\nph = 0;\r\nfor(k=0;k<count;k++) {\r\nif (k == count-1) w0(0xfd);\r\nw2(4+ph);\r\na = r1(); b = r2();\r\nbuf[k] = j53(a,b);\r\nph = 1 - ph;\r\n}\r\nw0(0); w2(4);\r\nbreak;\r\ncase 2: w0(0x27); w2(1); w2(0x25); w0(0);\r\nph = 0;\r\nfor(k=0;k<count-1;k++) {\r\nw2(0x24+ph);\r\nbuf[k] = r0();\r\nph = 1 - ph;\r\n}\r\nw2(0x26); w2(0x27); buf[count-1] = r0();\r\nw2(0x25); w2(4);\r\nbreak;\r\ncase 3: w3(0x80); w2(0x24);\r\nfor(k=0;k<count-1;k++) buf[k] = r4();\r\nw2(4); w3(0xa0); w2(0x24); buf[count-1] = r4();\r\nw2(4);\r\nbreak;\r\ncase 4: w3(0x80); w2(0x24);\r\nfor(k=0;k<(count/2)-1;k++) ((u16 *)buf)[k] = r4w();\r\nbuf[count-2] = r4();\r\nw2(4); w3(0xa0); w2(0x24); buf[count-1] = r4();\r\nw2(4);\r\nbreak;\r\ncase 5: w3(0x80); w2(0x24);\r\nfor(k=0;k<(count/4)-1;k++) ((u32 *)buf)[k] = r4l();\r\nfor(k=count-4;k<count-1;k++) buf[k] = r4();\r\nw2(4); w3(0xa0); w2(0x24); buf[count-1] = r4();\r\nw2(4);\r\nbreak;\r\n}\r\n}\r\nstatic void epat_write_block( PIA *pi, char * buf, int count )\r\n{ int ph, k;\r\nswitch (pi->mode) {\r\ncase 0:\r\ncase 1:\r\ncase 2: w0(0x67); w2(1); w2(5);\r\nph = 0;\r\nfor(k=0;k<count;k++) {\r\nw0(buf[k]);\r\nw2(4+ph);\r\nph = 1 - ph;\r\n}\r\nw2(7); w2(4);\r\nbreak;\r\ncase 3: w3(0xc0);\r\nfor(k=0;k<count;k++) w4(buf[k]);\r\nw2(4);\r\nbreak;\r\ncase 4: w3(0xc0);\r\nfor(k=0;k<(count/2);k++) w4w(((u16 *)buf)[k]);\r\nw2(4);\r\nbreak;\r\ncase 5: w3(0xc0);\r\nfor(k=0;k<(count/4);k++) w4l(((u32 *)buf)[k]);\r\nw2(4);\r\nbreak;\r\n}\r\n}\r\nstatic void epat_connect ( PIA *pi )\r\n{ pi->saved_r0 = r0();\r\npi->saved_r2 = r2();\r\nCPP(0);\r\nif (epatc8) {\r\nCPP(0x40);CPP(0xe0);\r\nw0(0);w2(1);w2(4);\r\nWR(0x8,0x12);WR(0xc,0x14);WR(0x12,0x10);\r\nWR(0xe,0xf);WR(0xf,4);\r\nWR(0xe,0xd);WR(0xf,0);\r\n}\r\nCPP(0xe0);\r\nw0(0);w2(1);w2(4);\r\nif (pi->mode >= 3) {\r\nw0(0);w2(1);w2(4);w2(0xc);\r\nw0(0x40);w2(6);w2(7);w2(4);w2(0xc);w2(4);\r\n}\r\nif (!epatc8) {\r\nWR(8,0x10); WR(0xc,0x14); WR(0xa,0x38); WR(0x12,0x10);\r\n}\r\n}\r\nstatic void epat_disconnect (PIA *pi)\r\n{ CPP(0x30);\r\nw0(pi->saved_r0);\r\nw2(pi->saved_r2);\r\n}\r\nstatic int epat_test_proto( PIA *pi, char * scratch, int verbose )\r\n{ int k, j, f, cc;\r\nint e[2] = {0,0};\r\nepat_connect(pi);\r\ncc = RR(0xd);\r\nepat_disconnect(pi);\r\nepat_connect(pi);\r\nfor (j=0;j<2;j++) {\r\nWRi(6,0xa0+j*0x10);\r\nfor (k=0;k<256;k++) {\r\nWRi(2,k^0xaa);\r\nWRi(3,k^0x55);\r\nif (RRi(2) != (k^0xaa)) e[j]++;\r\n}\r\n}\r\nepat_disconnect(pi);\r\nf = 0;\r\nepat_connect(pi);\r\nWR(0x13,1); WR(0x13,0); WR(0xa,0x11);\r\nepat_read_block(pi,scratch,512);\r\nfor (k=0;k<256;k++) {\r\nif ((scratch[2*k] & 0xff) != k) f++;\r\nif ((scratch[2*k+1] & 0xff) != (0xff-k)) f++;\r\n}\r\nepat_disconnect(pi);\r\nif (verbose) {\r\nprintk("%s: epat: port 0x%x, mode %d, ccr %x, test=(%d,%d,%d)\n",\r\npi->device,pi->port,pi->mode,cc,e[0],e[1],f);\r\n}\r\nreturn (e[0] && e[1]) || f;\r\n}\r\nstatic void epat_log_adapter( PIA *pi, char * scratch, int verbose )\r\n{ int ver;\r\nchar *mode_string[6] =\r\n{"4-bit","5/3","8-bit","EPP-8","EPP-16","EPP-32"};\r\nepat_connect(pi);\r\nWR(0xa,0x38);\r\nver = RR(0xb);\r\nepat_disconnect(pi);\r\nprintk("%s: epat %s, Shuttle EPAT chip %x at 0x%x, ",\r\npi->device,EPAT_VERSION,ver,pi->port);\r\nprintk("mode %d (%s), delay %d\n",pi->mode,\r\nmode_string[pi->mode],pi->delay);\r\n}\r\nstatic int __init epat_init(void)\r\n{\r\n#ifdef CONFIG_PARIDE_EPATC8\r\nepatc8 = 1;\r\n#endif\r\nreturn paride_register(&epat);\r\n}\r\nstatic void __exit epat_exit(void)\r\n{\r\nparide_unregister(&epat);\r\n}

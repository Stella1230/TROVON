static ssize_t show_power(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nu32 val, tdp_limit, running_avg_range;\r\ns32 running_avg_capture;\r\nu64 curr_pwr_watts;\r\nstruct pci_dev *f4 = to_pci_dev(dev);\r\nstruct fam15h_power_data *data = dev_get_drvdata(dev);\r\npci_bus_read_config_dword(f4->bus, PCI_DEVFN(PCI_SLOT(f4->devfn), 5),\r\nREG_TDP_RUNNING_AVERAGE, &val);\r\nrunning_avg_capture = (val >> 4) & 0x3fffff;\r\nrunning_avg_capture = sign_extend32(running_avg_capture, 22);\r\nrunning_avg_range = val & 0xf;\r\npci_bus_read_config_dword(f4->bus, PCI_DEVFN(PCI_SLOT(f4->devfn), 5),\r\nREG_TDP_LIMIT3, &val);\r\ntdp_limit = val >> 16;\r\ncurr_pwr_watts = tdp_limit + data->base_tdp -\r\n(s32)(running_avg_capture >> (running_avg_range + 1));\r\ncurr_pwr_watts *= data->tdp_to_watts;\r\ncurr_pwr_watts = (curr_pwr_watts * 15625) >> 10;\r\nreturn sprintf(buf, "%u\n", (unsigned int) curr_pwr_watts);\r\n}\r\nstatic ssize_t show_power_crit(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct fam15h_power_data *data = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%u\n", data->processor_pwr_watts);\r\n}\r\nstatic ssize_t show_name(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "fam15h_power\n");\r\n}\r\nstatic bool __devinit fam15h_power_is_internal_node0(struct pci_dev *f4)\r\n{\r\nu32 val;\r\npci_bus_read_config_dword(f4->bus, PCI_DEVFN(PCI_SLOT(f4->devfn), 3),\r\nREG_NORTHBRIDGE_CAP, &val);\r\nif ((val & BIT(29)) && ((val >> 30) & 3))\r\nreturn false;\r\nreturn true;\r\n}\r\nstatic void __devinit fam15h_power_init_data(struct pci_dev *f4,\r\nstruct fam15h_power_data *data)\r\n{\r\nu32 val;\r\nu64 tmp;\r\npci_read_config_dword(f4, REG_PROCESSOR_TDP, &val);\r\ndata->base_tdp = val >> 16;\r\ntmp = val & 0xffff;\r\npci_bus_read_config_dword(f4->bus, PCI_DEVFN(PCI_SLOT(f4->devfn), 5),\r\nREG_TDP_LIMIT3, &val);\r\ndata->tdp_to_watts = ((val & 0x3ff) << 6) | ((val >> 10) & 0x3f);\r\ntmp *= data->tdp_to_watts;\r\nif ((tmp >> 16) >= 256)\r\ndev_warn(&f4->dev, "Bogus value for ProcessorPwrWatts "\r\n"(processor_pwr_watts>=%u)\n",\r\n(unsigned int) (tmp >> 16));\r\ndata->processor_pwr_watts = (tmp * 15625) >> 10;\r\n}\r\nstatic int __devinit fam15h_power_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *id)\r\n{\r\nstruct fam15h_power_data *data;\r\nstruct device *dev;\r\nint err;\r\nif (!fam15h_power_is_internal_node0(pdev)) {\r\nerr = -ENODEV;\r\ngoto exit;\r\n}\r\ndata = kzalloc(sizeof(struct fam15h_power_data), GFP_KERNEL);\r\nif (!data) {\r\nerr = -ENOMEM;\r\ngoto exit;\r\n}\r\nfam15h_power_init_data(pdev, data);\r\ndev = &pdev->dev;\r\ndev_set_drvdata(dev, data);\r\nerr = sysfs_create_group(&dev->kobj, &fam15h_power_attr_group);\r\nif (err)\r\ngoto exit_free_data;\r\ndata->hwmon_dev = hwmon_device_register(dev);\r\nif (IS_ERR(data->hwmon_dev)) {\r\nerr = PTR_ERR(data->hwmon_dev);\r\ngoto exit_remove_group;\r\n}\r\nreturn 0;\r\nexit_remove_group:\r\nsysfs_remove_group(&dev->kobj, &fam15h_power_attr_group);\r\nexit_free_data:\r\nkfree(data);\r\nexit:\r\nreturn err;\r\n}\r\nstatic void __devexit fam15h_power_remove(struct pci_dev *pdev)\r\n{\r\nstruct device *dev;\r\nstruct fam15h_power_data *data;\r\ndev = &pdev->dev;\r\ndata = dev_get_drvdata(dev);\r\nhwmon_device_unregister(data->hwmon_dev);\r\nsysfs_remove_group(&dev->kobj, &fam15h_power_attr_group);\r\ndev_set_drvdata(dev, NULL);\r\nkfree(data);\r\n}\r\nstatic int __init fam15h_power_init(void)\r\n{\r\nreturn pci_register_driver(&fam15h_power_driver);\r\n}\r\nstatic void __exit fam15h_power_exit(void)\r\n{\r\npci_unregister_driver(&fam15h_power_driver);\r\n}

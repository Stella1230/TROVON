static int kobil_startup(struct usb_serial *serial)\r\n{\r\nint i;\r\nstruct kobil_private *priv;\r\nstruct usb_device *pdev;\r\nstruct usb_host_config *actconfig;\r\nstruct usb_interface *interface;\r\nstruct usb_host_interface *altsetting;\r\nstruct usb_host_endpoint *endpoint;\r\npriv = kmalloc(sizeof(struct kobil_private), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->filled = 0;\r\npriv->cur_pos = 0;\r\npriv->device_type = le16_to_cpu(serial->dev->descriptor.idProduct);\r\nswitch (priv->device_type) {\r\ncase KOBIL_ADAPTER_B_PRODUCT_ID:\r\nprintk(KERN_DEBUG "KOBIL B1 PRO / KAAN PRO detected\n");\r\nbreak;\r\ncase KOBIL_ADAPTER_K_PRODUCT_ID:\r\nprintk(KERN_DEBUG\r\n"KOBIL KAAN Standard Plus / SecOVID Reader Plus detected\n");\r\nbreak;\r\ncase KOBIL_USBTWIN_PRODUCT_ID:\r\nprintk(KERN_DEBUG "KOBIL USBTWIN detected\n");\r\nbreak;\r\ncase KOBIL_KAAN_SIM_PRODUCT_ID:\r\nprintk(KERN_DEBUG "KOBIL KAAN SIM detected\n");\r\nbreak;\r\n}\r\nusb_set_serial_port_data(serial->port[0], priv);\r\npdev = serial->dev;\r\nactconfig = pdev->actconfig;\r\ninterface = actconfig->interface[0];\r\naltsetting = interface->cur_altsetting;\r\nendpoint = altsetting->endpoint;\r\nfor (i = 0; i < altsetting->desc.bNumEndpoints; i++) {\r\nendpoint = &altsetting->endpoint[i];\r\nif (usb_endpoint_is_int_out(&endpoint->desc)) {\r\ndbg("%s Found interrupt out endpoint. Address: %d",\r\n__func__, endpoint->desc.bEndpointAddress);\r\npriv->write_int_endpoint_address =\r\nendpoint->desc.bEndpointAddress;\r\n}\r\nif (usb_endpoint_is_int_in(&endpoint->desc)) {\r\ndbg("%s Found interrupt in endpoint. Address: %d",\r\n__func__, endpoint->desc.bEndpointAddress);\r\npriv->read_int_endpoint_address =\r\nendpoint->desc.bEndpointAddress;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void kobil_release(struct usb_serial *serial)\r\n{\r\nint i;\r\ndbg("%s - port %d", __func__, serial->port[0]->number);\r\nfor (i = 0; i < serial->num_ports; ++i)\r\nkfree(usb_get_serial_port_data(serial->port[i]));\r\n}\r\nstatic void kobil_init_termios(struct tty_struct *tty)\r\n{\r\ntty->termios->c_lflag = 0;\r\ntty->termios->c_lflag &= ~(ISIG | ICANON | ECHO | IEXTEN | XCASE);\r\ntty->termios->c_iflag = IGNBRK | IGNPAR | IXOFF;\r\ntty->termios->c_oflag &= ~ONLCR;\r\n}\r\nstatic int kobil_open(struct tty_struct *tty, struct usb_serial_port *port)\r\n{\r\nint result = 0;\r\nstruct kobil_private *priv;\r\nunsigned char *transfer_buffer;\r\nint transfer_buffer_length = 8;\r\nint write_urb_transfer_buffer_length = 8;\r\ndbg("%s - port %d", __func__, port->number);\r\npriv = usb_get_serial_port_data(port);\r\nport->interrupt_in_urb->dev = port->serial->dev;\r\ntransfer_buffer = kzalloc(transfer_buffer_length, GFP_KERNEL);\r\nif (!transfer_buffer)\r\nreturn -ENOMEM;\r\nif (!port->write_urb) {\r\ndbg("%s - port %d Allocating port->write_urb",\r\n__func__, port->number);\r\nport->write_urb = usb_alloc_urb(0, GFP_KERNEL);\r\nif (!port->write_urb) {\r\ndbg("%s - port %d usb_alloc_urb failed",\r\n__func__, port->number);\r\nkfree(transfer_buffer);\r\nreturn -ENOMEM;\r\n}\r\n}\r\nport->write_urb->transfer_buffer =\r\nkmalloc(write_urb_transfer_buffer_length, GFP_KERNEL);\r\nif (!port->write_urb->transfer_buffer) {\r\nkfree(transfer_buffer);\r\nusb_free_urb(port->write_urb);\r\nport->write_urb = NULL;\r\nreturn -ENOMEM;\r\n}\r\nresult = usb_control_msg(port->serial->dev,\r\nusb_rcvctrlpipe(port->serial->dev, 0),\r\nSUSBCRequest_GetMisc,\r\nUSB_TYPE_VENDOR | USB_RECIP_ENDPOINT | USB_DIR_IN,\r\nSUSBCR_MSC_GetHWVersion,\r\n0,\r\ntransfer_buffer,\r\ntransfer_buffer_length,\r\nKOBIL_TIMEOUT\r\n);\r\ndbg("%s - port %d Send get_HW_version URB returns: %i",\r\n__func__, port->number, result);\r\ndbg("Harware version: %i.%i.%i",\r\ntransfer_buffer[0], transfer_buffer[1], transfer_buffer[2]);\r\nresult = usb_control_msg(port->serial->dev,\r\nusb_rcvctrlpipe(port->serial->dev, 0),\r\nSUSBCRequest_GetMisc,\r\nUSB_TYPE_VENDOR | USB_RECIP_ENDPOINT | USB_DIR_IN,\r\nSUSBCR_MSC_GetFWVersion,\r\n0,\r\ntransfer_buffer,\r\ntransfer_buffer_length,\r\nKOBIL_TIMEOUT\r\n);\r\ndbg("%s - port %d Send get_FW_version URB returns: %i",\r\n__func__, port->number, result);\r\ndbg("Firmware version: %i.%i.%i",\r\ntransfer_buffer[0], transfer_buffer[1], transfer_buffer[2]);\r\nif (priv->device_type == KOBIL_ADAPTER_B_PRODUCT_ID ||\r\npriv->device_type == KOBIL_ADAPTER_K_PRODUCT_ID) {\r\nresult = usb_control_msg(port->serial->dev,\r\nusb_rcvctrlpipe(port->serial->dev, 0),\r\nSUSBCRequest_SetBaudRateParityAndStopBits,\r\nUSB_TYPE_VENDOR | USB_RECIP_ENDPOINT | USB_DIR_OUT,\r\nSUSBCR_SBR_9600 | SUSBCR_SPASB_EvenParity |\r\nSUSBCR_SPASB_1StopBit,\r\n0,\r\ntransfer_buffer,\r\n0,\r\nKOBIL_TIMEOUT\r\n);\r\ndbg("%s - port %d Send set_baudrate URB returns: %i",\r\n__func__, port->number, result);\r\nresult = usb_control_msg(port->serial->dev,\r\nusb_rcvctrlpipe(port->serial->dev, 0),\r\nSUSBCRequest_Misc,\r\nUSB_TYPE_VENDOR | USB_RECIP_ENDPOINT | USB_DIR_OUT,\r\nSUSBCR_MSC_ResetAllQueues,\r\n0,\r\ntransfer_buffer,\r\n0,\r\nKOBIL_TIMEOUT\r\n);\r\ndbg("%s - port %d Send reset_all_queues URB returns: %i",\r\n__func__, port->number, result);\r\n}\r\nif (priv->device_type == KOBIL_USBTWIN_PRODUCT_ID ||\r\npriv->device_type == KOBIL_ADAPTER_B_PRODUCT_ID ||\r\npriv->device_type == KOBIL_KAAN_SIM_PRODUCT_ID) {\r\nresult = usb_submit_urb(port->interrupt_in_urb, GFP_ATOMIC);\r\ndbg("%s - port %d Send read URB returns: %i",\r\n__func__, port->number, result);\r\n}\r\nkfree(transfer_buffer);\r\nreturn 0;\r\n}\r\nstatic void kobil_close(struct usb_serial_port *port)\r\n{\r\ndbg("%s - port %d", __func__, port->number);\r\nif (port->write_urb) {\r\nusb_poison_urb(port->write_urb);\r\nkfree(port->write_urb->transfer_buffer);\r\nusb_free_urb(port->write_urb);\r\nport->write_urb = NULL;\r\n}\r\nusb_kill_urb(port->interrupt_in_urb);\r\n}\r\nstatic void kobil_read_int_callback(struct urb *urb)\r\n{\r\nint result;\r\nstruct usb_serial_port *port = urb->context;\r\nstruct tty_struct *tty;\r\nunsigned char *data = urb->transfer_buffer;\r\nint status = urb->status;\r\ndbg("%s - port %d", __func__, port->number);\r\nif (status) {\r\ndbg("%s - port %d Read int status not zero: %d",\r\n__func__, port->number, status);\r\nreturn;\r\n}\r\ntty = tty_port_tty_get(&port->port);\r\nif (tty && urb->actual_length) {\r\ntty_insert_flip_string(tty, data, urb->actual_length);\r\ntty_flip_buffer_push(tty);\r\n}\r\ntty_kref_put(tty);\r\nport->interrupt_in_urb->dev = port->serial->dev;\r\nresult = usb_submit_urb(port->interrupt_in_urb, GFP_ATOMIC);\r\ndbg("%s - port %d Send read URB returns: %i",\r\n__func__, port->number, result);\r\n}\r\nstatic void kobil_write_callback(struct urb *purb)\r\n{\r\n}\r\nstatic int kobil_write(struct tty_struct *tty, struct usb_serial_port *port,\r\nconst unsigned char *buf, int count)\r\n{\r\nint length = 0;\r\nint result = 0;\r\nint todo = 0;\r\nstruct kobil_private *priv;\r\nif (count == 0) {\r\ndbg("%s - port %d write request of 0 bytes",\r\n__func__, port->number);\r\nreturn 0;\r\n}\r\npriv = usb_get_serial_port_data(port);\r\nif (count > (KOBIL_BUF_LENGTH - priv->filled)) {\r\ndbg("%s - port %d Error: write request bigger than buffer size", __func__, port->number);\r\nreturn -ENOMEM;\r\n}\r\nmemcpy(priv->buf + priv->filled, buf, count);\r\nusb_serial_debug_data(debug, &port->dev, __func__, count,\r\npriv->buf + priv->filled);\r\npriv->filled = priv->filled + count;\r\nif (((priv->device_type != KOBIL_ADAPTER_B_PRODUCT_ID) && (priv->filled > 2) && (priv->filled >= (priv->buf[1] + 3))) ||\r\n((priv->device_type == KOBIL_ADAPTER_B_PRODUCT_ID) && (priv->filled > 3) && (priv->filled >= (priv->buf[2] + 4)))) {\r\nif ((priv->device_type == KOBIL_ADAPTER_B_PRODUCT_ID)\r\n|| (priv->device_type == KOBIL_ADAPTER_K_PRODUCT_ID))\r\nusb_kill_urb(port->interrupt_in_urb);\r\ntodo = priv->filled - priv->cur_pos;\r\nwhile (todo > 0) {\r\nlength = (todo < 8) ? todo : 8;\r\nmemcpy(port->write_urb->transfer_buffer,\r\npriv->buf + priv->cur_pos, length);\r\nusb_fill_int_urb(port->write_urb,\r\nport->serial->dev,\r\nusb_sndintpipe(port->serial->dev,\r\npriv->write_int_endpoint_address),\r\nport->write_urb->transfer_buffer,\r\nlength,\r\nkobil_write_callback,\r\nport,\r\n8\r\n);\r\npriv->cur_pos = priv->cur_pos + length;\r\nresult = usb_submit_urb(port->write_urb, GFP_NOIO);\r\ndbg("%s - port %d Send write URB returns: %i",\r\n__func__, port->number, result);\r\ntodo = priv->filled - priv->cur_pos;\r\nif (todo > 0)\r\nmsleep(24);\r\n}\r\npriv->filled = 0;\r\npriv->cur_pos = 0;\r\nport->interrupt_in_urb->dev = port->serial->dev;\r\nif (priv->device_type == KOBIL_ADAPTER_B_PRODUCT_ID ||\r\npriv->device_type == KOBIL_ADAPTER_K_PRODUCT_ID) {\r\nport->interrupt_in_urb->dev = port->serial->dev;\r\nresult = usb_submit_urb(port->interrupt_in_urb,\r\nGFP_NOIO);\r\ndbg("%s - port %d Send read URB returns: %i",\r\n__func__, port->number, result);\r\n}\r\n}\r\nreturn count;\r\n}\r\nstatic int kobil_write_room(struct tty_struct *tty)\r\n{\r\nreturn 8;\r\n}\r\nstatic int kobil_tiocmget(struct tty_struct *tty)\r\n{\r\nstruct usb_serial_port *port = tty->driver_data;\r\nstruct kobil_private *priv;\r\nint result;\r\nunsigned char *transfer_buffer;\r\nint transfer_buffer_length = 8;\r\npriv = usb_get_serial_port_data(port);\r\nif (priv->device_type == KOBIL_USBTWIN_PRODUCT_ID\r\n|| priv->device_type == KOBIL_KAAN_SIM_PRODUCT_ID) {\r\nreturn -EINVAL;\r\n}\r\ntransfer_buffer = kzalloc(transfer_buffer_length, GFP_KERNEL);\r\nif (!transfer_buffer)\r\nreturn -ENOMEM;\r\nresult = usb_control_msg(port->serial->dev,\r\nusb_rcvctrlpipe(port->serial->dev, 0),\r\nSUSBCRequest_GetStatusLineState,\r\nUSB_TYPE_VENDOR | USB_RECIP_ENDPOINT | USB_DIR_IN,\r\n0,\r\n0,\r\ntransfer_buffer,\r\ntransfer_buffer_length,\r\nKOBIL_TIMEOUT);\r\ndbg("%s - port %d Send get_status_line_state URB returns: %i. Statusline: %02x",\r\n__func__, port->number, result, transfer_buffer[0]);\r\nresult = 0;\r\nif ((transfer_buffer[0] & SUSBCR_GSL_DSR) != 0)\r\nresult = TIOCM_DSR;\r\nkfree(transfer_buffer);\r\nreturn result;\r\n}\r\nstatic int kobil_tiocmset(struct tty_struct *tty,\r\nunsigned int set, unsigned int clear)\r\n{\r\nstruct usb_serial_port *port = tty->driver_data;\r\nstruct kobil_private *priv;\r\nint result;\r\nint dtr = 0;\r\nint rts = 0;\r\nunsigned char *transfer_buffer;\r\nint transfer_buffer_length = 8;\r\npriv = usb_get_serial_port_data(port);\r\nif (priv->device_type == KOBIL_USBTWIN_PRODUCT_ID\r\n|| priv->device_type == KOBIL_KAAN_SIM_PRODUCT_ID) {\r\nreturn -EINVAL;\r\n}\r\ntransfer_buffer = kzalloc(transfer_buffer_length, GFP_KERNEL);\r\nif (!transfer_buffer)\r\nreturn -ENOMEM;\r\nif (set & TIOCM_RTS)\r\nrts = 1;\r\nif (set & TIOCM_DTR)\r\ndtr = 1;\r\nif (clear & TIOCM_RTS)\r\nrts = 0;\r\nif (clear & TIOCM_DTR)\r\ndtr = 0;\r\nif (priv->device_type == KOBIL_ADAPTER_B_PRODUCT_ID) {\r\nif (dtr != 0)\r\ndbg("%s - port %d Setting DTR",\r\n__func__, port->number);\r\nelse\r\ndbg("%s - port %d Clearing DTR",\r\n__func__, port->number);\r\nresult = usb_control_msg(port->serial->dev,\r\nusb_rcvctrlpipe(port->serial->dev, 0),\r\nSUSBCRequest_SetStatusLinesOrQueues,\r\nUSB_TYPE_VENDOR | USB_RECIP_ENDPOINT | USB_DIR_OUT,\r\n((dtr != 0) ? SUSBCR_SSL_SETDTR : SUSBCR_SSL_CLRDTR),\r\n0,\r\ntransfer_buffer,\r\n0,\r\nKOBIL_TIMEOUT);\r\n} else {\r\nif (rts != 0)\r\ndbg("%s - port %d Setting RTS",\r\n__func__, port->number);\r\nelse\r\ndbg("%s - port %d Clearing RTS",\r\n__func__, port->number);\r\nresult = usb_control_msg(port->serial->dev,\r\nusb_rcvctrlpipe(port->serial->dev, 0),\r\nSUSBCRequest_SetStatusLinesOrQueues,\r\nUSB_TYPE_VENDOR | USB_RECIP_ENDPOINT | USB_DIR_OUT,\r\n((rts != 0) ? SUSBCR_SSL_SETRTS : SUSBCR_SSL_CLRRTS),\r\n0,\r\ntransfer_buffer,\r\n0,\r\nKOBIL_TIMEOUT);\r\n}\r\ndbg("%s - port %d Send set_status_line URB returns: %i",\r\n__func__, port->number, result);\r\nkfree(transfer_buffer);\r\nreturn (result < 0) ? result : 0;\r\n}\r\nstatic void kobil_set_termios(struct tty_struct *tty,\r\nstruct usb_serial_port *port, struct ktermios *old)\r\n{\r\nstruct kobil_private *priv;\r\nint result;\r\nunsigned short urb_val = 0;\r\nint c_cflag = tty->termios->c_cflag;\r\nspeed_t speed;\r\npriv = usb_get_serial_port_data(port);\r\nif (priv->device_type == KOBIL_USBTWIN_PRODUCT_ID ||\r\npriv->device_type == KOBIL_KAAN_SIM_PRODUCT_ID) {\r\n*tty->termios = *old;\r\nreturn;\r\n}\r\nspeed = tty_get_baud_rate(tty);\r\nswitch (speed) {\r\ncase 1200:\r\nurb_val = SUSBCR_SBR_1200;\r\nbreak;\r\ndefault:\r\nspeed = 9600;\r\ncase 9600:\r\nurb_val = SUSBCR_SBR_9600;\r\nbreak;\r\n}\r\nurb_val |= (c_cflag & CSTOPB) ? SUSBCR_SPASB_2StopBits :\r\nSUSBCR_SPASB_1StopBit;\r\nif (c_cflag & PARENB) {\r\nif (c_cflag & PARODD)\r\nurb_val |= SUSBCR_SPASB_OddParity;\r\nelse\r\nurb_val |= SUSBCR_SPASB_EvenParity;\r\n} else\r\nurb_val |= SUSBCR_SPASB_NoParity;\r\ntty->termios->c_cflag &= ~CMSPAR;\r\ntty_encode_baud_rate(tty, speed, speed);\r\nresult = usb_control_msg(port->serial->dev,\r\nusb_rcvctrlpipe(port->serial->dev, 0),\r\nSUSBCRequest_SetBaudRateParityAndStopBits,\r\nUSB_TYPE_VENDOR | USB_RECIP_ENDPOINT | USB_DIR_OUT,\r\nurb_val,\r\n0,\r\nNULL,\r\n0,\r\nKOBIL_TIMEOUT\r\n);\r\n}\r\nstatic int kobil_ioctl(struct tty_struct *tty,\r\nunsigned int cmd, unsigned long arg)\r\n{\r\nstruct usb_serial_port *port = tty->driver_data;\r\nstruct kobil_private *priv = usb_get_serial_port_data(port);\r\nunsigned char *transfer_buffer;\r\nint transfer_buffer_length = 8;\r\nint result;\r\nif (priv->device_type == KOBIL_USBTWIN_PRODUCT_ID ||\r\npriv->device_type == KOBIL_KAAN_SIM_PRODUCT_ID)\r\nreturn -ENOIOCTLCMD;\r\nswitch (cmd) {\r\ncase TCFLSH:\r\ntransfer_buffer = kmalloc(transfer_buffer_length, GFP_KERNEL);\r\nif (!transfer_buffer)\r\nreturn -ENOBUFS;\r\nresult = usb_control_msg(port->serial->dev,\r\nusb_rcvctrlpipe(port->serial->dev, 0),\r\nSUSBCRequest_Misc,\r\nUSB_TYPE_VENDOR | USB_RECIP_ENDPOINT | USB_DIR_OUT,\r\nSUSBCR_MSC_ResetAllQueues,\r\n0,\r\nNULL,\r\n0,\r\nKOBIL_TIMEOUT\r\n);\r\ndbg("%s - port %d Send reset_all_queues (FLUSH) URB returns: %i", __func__, port->number, result);\r\nkfree(transfer_buffer);\r\nreturn (result < 0) ? -EIO: 0;\r\ndefault:\r\nreturn -ENOIOCTLCMD;\r\n}\r\n}\r\nstatic int __init kobil_init(void)\r\n{\r\nint retval;\r\nretval = usb_serial_register(&kobil_device);\r\nif (retval)\r\ngoto failed_usb_serial_register;\r\nretval = usb_register(&kobil_driver);\r\nif (retval)\r\ngoto failed_usb_register;\r\nprintk(KERN_INFO KBUILD_MODNAME ": " DRIVER_VERSION ":"\r\nDRIVER_DESC "\n");\r\nreturn 0;\r\nfailed_usb_register:\r\nusb_serial_deregister(&kobil_device);\r\nfailed_usb_serial_register:\r\nreturn retval;\r\n}\r\nstatic void __exit kobil_exit(void)\r\n{\r\nusb_deregister(&kobil_driver);\r\nusb_serial_deregister(&kobil_device);\r\n}

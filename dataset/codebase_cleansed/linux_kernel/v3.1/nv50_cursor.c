static void\r\nnv50_cursor_show(struct nouveau_crtc *nv_crtc, bool update)\r\n{\r\nstruct drm_device *dev = nv_crtc->base.dev;\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_channel *evo = nv50_display(dev)->master;\r\nint ret;\r\nNV_DEBUG_KMS(dev, "\n");\r\nif (update && nv_crtc->cursor.visible)\r\nreturn;\r\nret = RING_SPACE(evo, (dev_priv->chipset != 0x50 ? 5 : 3) + update * 2);\r\nif (ret) {\r\nNV_ERROR(dev, "no space while unhiding cursor\n");\r\nreturn;\r\n}\r\nif (dev_priv->chipset != 0x50) {\r\nBEGIN_RING(evo, 0, NV84_EVO_CRTC(nv_crtc->index, CURSOR_DMA), 1);\r\nOUT_RING(evo, NvEvoVRAM);\r\n}\r\nBEGIN_RING(evo, 0, NV50_EVO_CRTC(nv_crtc->index, CURSOR_CTRL), 2);\r\nOUT_RING(evo, NV50_EVO_CRTC_CURSOR_CTRL_SHOW);\r\nOUT_RING(evo, nv_crtc->cursor.offset >> 8);\r\nif (update) {\r\nBEGIN_RING(evo, 0, NV50_EVO_UPDATE, 1);\r\nOUT_RING(evo, 0);\r\nFIRE_RING(evo);\r\nnv_crtc->cursor.visible = true;\r\n}\r\n}\r\nstatic void\r\nnv50_cursor_hide(struct nouveau_crtc *nv_crtc, bool update)\r\n{\r\nstruct drm_device *dev = nv_crtc->base.dev;\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_channel *evo = nv50_display(dev)->master;\r\nint ret;\r\nNV_DEBUG_KMS(dev, "\n");\r\nif (update && !nv_crtc->cursor.visible)\r\nreturn;\r\nret = RING_SPACE(evo, (dev_priv->chipset != 0x50 ? 5 : 3) + update * 2);\r\nif (ret) {\r\nNV_ERROR(dev, "no space while hiding cursor\n");\r\nreturn;\r\n}\r\nBEGIN_RING(evo, 0, NV50_EVO_CRTC(nv_crtc->index, CURSOR_CTRL), 2);\r\nOUT_RING(evo, NV50_EVO_CRTC_CURSOR_CTRL_HIDE);\r\nOUT_RING(evo, 0);\r\nif (dev_priv->chipset != 0x50) {\r\nBEGIN_RING(evo, 0, NV84_EVO_CRTC(nv_crtc->index, CURSOR_DMA), 1);\r\nOUT_RING(evo, NV84_EVO_CRTC_CURSOR_DMA_HANDLE_NONE);\r\n}\r\nif (update) {\r\nBEGIN_RING(evo, 0, NV50_EVO_UPDATE, 1);\r\nOUT_RING(evo, 0);\r\nFIRE_RING(evo);\r\nnv_crtc->cursor.visible = false;\r\n}\r\n}\r\nstatic void\r\nnv50_cursor_set_pos(struct nouveau_crtc *nv_crtc, int x, int y)\r\n{\r\nstruct drm_device *dev = nv_crtc->base.dev;\r\nnv_crtc->cursor_saved_x = x; nv_crtc->cursor_saved_y = y;\r\nnv_wr32(dev, NV50_PDISPLAY_CURSOR_USER_POS(nv_crtc->index),\r\n((y & 0xFFFF) << 16) | (x & 0xFFFF));\r\nnv_wr32(dev, NV50_PDISPLAY_CURSOR_USER_POS_CTRL(nv_crtc->index), 0);\r\n}\r\nstatic void\r\nnv50_cursor_set_offset(struct nouveau_crtc *nv_crtc, uint32_t offset)\r\n{\r\nNV_DEBUG_KMS(nv_crtc->base.dev, "\n");\r\nif (offset == nv_crtc->cursor.offset)\r\nreturn;\r\nnv_crtc->cursor.offset = offset;\r\nif (nv_crtc->cursor.visible) {\r\nnv_crtc->cursor.visible = false;\r\nnv_crtc->cursor.show(nv_crtc, true);\r\n}\r\n}\r\nint\r\nnv50_cursor_init(struct nouveau_crtc *nv_crtc)\r\n{\r\nnv_crtc->cursor.set_offset = nv50_cursor_set_offset;\r\nnv_crtc->cursor.set_pos = nv50_cursor_set_pos;\r\nnv_crtc->cursor.hide = nv50_cursor_hide;\r\nnv_crtc->cursor.show = nv50_cursor_show;\r\nreturn 0;\r\n}\r\nvoid\r\nnv50_cursor_fini(struct nouveau_crtc *nv_crtc)\r\n{\r\nstruct drm_device *dev = nv_crtc->base.dev;\r\nint idx = nv_crtc->index;\r\nNV_DEBUG_KMS(dev, "\n");\r\nnv_wr32(dev, NV50_PDISPLAY_CURSOR_CURSOR_CTRL2(idx), 0);\r\nif (!nv_wait(dev, NV50_PDISPLAY_CURSOR_CURSOR_CTRL2(idx),\r\nNV50_PDISPLAY_CURSOR_CURSOR_CTRL2_STATUS, 0)) {\r\nNV_ERROR(dev, "timeout: CURSOR_CTRL2_STATUS == 0\n");\r\nNV_ERROR(dev, "CURSOR_CTRL2 = 0x%08x\n",\r\nnv_rd32(dev, NV50_PDISPLAY_CURSOR_CURSOR_CTRL2(idx)));\r\n}\r\n}

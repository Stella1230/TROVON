static int bq24022_set_current_limit(struct regulator_dev *rdev,\r\nint min_uA, int max_uA)\r\n{\r\nstruct bq24022_mach_info *pdata = rdev_get_drvdata(rdev);\r\ndev_dbg(rdev_get_dev(rdev), "setting current limit to %s mA\n",\r\nmax_uA >= 500000 ? "500" : "100");\r\ngpio_set_value(pdata->gpio_iset2, max_uA >= 500000);\r\nreturn 0;\r\n}\r\nstatic int bq24022_get_current_limit(struct regulator_dev *rdev)\r\n{\r\nstruct bq24022_mach_info *pdata = rdev_get_drvdata(rdev);\r\nreturn gpio_get_value(pdata->gpio_iset2) ? 500000 : 100000;\r\n}\r\nstatic int bq24022_enable(struct regulator_dev *rdev)\r\n{\r\nstruct bq24022_mach_info *pdata = rdev_get_drvdata(rdev);\r\ndev_dbg(rdev_get_dev(rdev), "enabling charger\n");\r\ngpio_set_value(pdata->gpio_nce, 0);\r\nreturn 0;\r\n}\r\nstatic int bq24022_disable(struct regulator_dev *rdev)\r\n{\r\nstruct bq24022_mach_info *pdata = rdev_get_drvdata(rdev);\r\ndev_dbg(rdev_get_dev(rdev), "disabling charger\n");\r\ngpio_set_value(pdata->gpio_nce, 1);\r\nreturn 0;\r\n}\r\nstatic int bq24022_is_enabled(struct regulator_dev *rdev)\r\n{\r\nstruct bq24022_mach_info *pdata = rdev_get_drvdata(rdev);\r\nreturn !gpio_get_value(pdata->gpio_nce);\r\n}\r\nstatic int __init bq24022_probe(struct platform_device *pdev)\r\n{\r\nstruct bq24022_mach_info *pdata = pdev->dev.platform_data;\r\nstruct regulator_dev *bq24022;\r\nint ret;\r\nif (!pdata || !pdata->gpio_nce || !pdata->gpio_iset2)\r\nreturn -EINVAL;\r\nret = gpio_request(pdata->gpio_nce, "ncharge_en");\r\nif (ret) {\r\ndev_dbg(&pdev->dev, "couldn't request nCE GPIO: %d\n",\r\npdata->gpio_nce);\r\ngoto err_ce;\r\n}\r\nret = gpio_request(pdata->gpio_iset2, "charge_mode");\r\nif (ret) {\r\ndev_dbg(&pdev->dev, "couldn't request ISET2 GPIO: %d\n",\r\npdata->gpio_iset2);\r\ngoto err_iset2;\r\n}\r\nret = gpio_direction_output(pdata->gpio_iset2, 0);\r\nret = gpio_direction_output(pdata->gpio_nce, 1);\r\nbq24022 = regulator_register(&bq24022_desc, &pdev->dev,\r\npdata->init_data, pdata);\r\nif (IS_ERR(bq24022)) {\r\ndev_dbg(&pdev->dev, "couldn't register regulator\n");\r\nret = PTR_ERR(bq24022);\r\ngoto err_reg;\r\n}\r\nplatform_set_drvdata(pdev, bq24022);\r\ndev_dbg(&pdev->dev, "registered regulator\n");\r\nreturn 0;\r\nerr_reg:\r\ngpio_free(pdata->gpio_iset2);\r\nerr_iset2:\r\ngpio_free(pdata->gpio_nce);\r\nerr_ce:\r\nreturn ret;\r\n}\r\nstatic int __devexit bq24022_remove(struct platform_device *pdev)\r\n{\r\nstruct bq24022_mach_info *pdata = pdev->dev.platform_data;\r\nstruct regulator_dev *bq24022 = platform_get_drvdata(pdev);\r\nregulator_unregister(bq24022);\r\ngpio_free(pdata->gpio_iset2);\r\ngpio_free(pdata->gpio_nce);\r\nreturn 0;\r\n}\r\nstatic int __init bq24022_init(void)\r\n{\r\nreturn platform_driver_probe(&bq24022_driver, bq24022_probe);\r\n}\r\nstatic void __exit bq24022_exit(void)\r\n{\r\nplatform_driver_unregister(&bq24022_driver);\r\n}

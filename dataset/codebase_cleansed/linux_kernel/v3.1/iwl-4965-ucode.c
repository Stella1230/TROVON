static int\r\niwl4965_verify_inst_sparse(struct iwl_priv *priv, __le32 *image, u32 len)\r\n{\r\nu32 val;\r\nint ret = 0;\r\nu32 errcnt = 0;\r\nu32 i;\r\nIWL_DEBUG_INFO(priv, "ucode inst image size is %u\n", len);\r\nfor (i = 0; i < len; i += 100, image += 100/sizeof(u32)) {\r\niwl_legacy_write_direct32(priv, HBUS_TARG_MEM_RADDR,\r\ni + IWL4965_RTC_INST_LOWER_BOUND);\r\nval = _iwl_legacy_read_direct32(priv, HBUS_TARG_MEM_RDAT);\r\nif (val != le32_to_cpu(*image)) {\r\nret = -EIO;\r\nerrcnt++;\r\nif (errcnt >= 3)\r\nbreak;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic int iwl4965_verify_inst_full(struct iwl_priv *priv, __le32 *image,\r\nu32 len)\r\n{\r\nu32 val;\r\nu32 save_len = len;\r\nint ret = 0;\r\nu32 errcnt;\r\nIWL_DEBUG_INFO(priv, "ucode inst image size is %u\n", len);\r\niwl_legacy_write_direct32(priv, HBUS_TARG_MEM_RADDR,\r\nIWL4965_RTC_INST_LOWER_BOUND);\r\nerrcnt = 0;\r\nfor (; len > 0; len -= sizeof(u32), image++) {\r\nval = _iwl_legacy_read_direct32(priv, HBUS_TARG_MEM_RDAT);\r\nif (val != le32_to_cpu(*image)) {\r\nIWL_ERR(priv, "uCode INST section is invalid at "\r\n"offset 0x%x, is 0x%x, s/b 0x%x\n",\r\nsave_len - len, val, le32_to_cpu(*image));\r\nret = -EIO;\r\nerrcnt++;\r\nif (errcnt >= 20)\r\nbreak;\r\n}\r\n}\r\nif (!errcnt)\r\nIWL_DEBUG_INFO(priv,\r\n"ucode image in INSTRUCTION memory is good\n");\r\nreturn ret;\r\n}\r\nint iwl4965_verify_ucode(struct iwl_priv *priv)\r\n{\r\n__le32 *image;\r\nu32 len;\r\nint ret;\r\nimage = (__le32 *)priv->ucode_boot.v_addr;\r\nlen = priv->ucode_boot.len;\r\nret = iwl4965_verify_inst_sparse(priv, image, len);\r\nif (!ret) {\r\nIWL_DEBUG_INFO(priv, "Bootstrap uCode is good in inst SRAM\n");\r\nreturn 0;\r\n}\r\nimage = (__le32 *)priv->ucode_init.v_addr;\r\nlen = priv->ucode_init.len;\r\nret = iwl4965_verify_inst_sparse(priv, image, len);\r\nif (!ret) {\r\nIWL_DEBUG_INFO(priv, "Initialize uCode is good in inst SRAM\n");\r\nreturn 0;\r\n}\r\nimage = (__le32 *)priv->ucode_code.v_addr;\r\nlen = priv->ucode_code.len;\r\nret = iwl4965_verify_inst_sparse(priv, image, len);\r\nif (!ret) {\r\nIWL_DEBUG_INFO(priv, "Runtime uCode is good in inst SRAM\n");\r\nreturn 0;\r\n}\r\nIWL_ERR(priv, "NO VALID UCODE IMAGE IN INSTRUCTION SRAM!!\n");\r\nimage = (__le32 *)priv->ucode_boot.v_addr;\r\nlen = priv->ucode_boot.len;\r\nret = iwl4965_verify_inst_full(priv, image, len);\r\nreturn ret;\r\n}

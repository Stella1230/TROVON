static bool ch7017_read(struct intel_dvo_device *dvo, u8 addr, u8 *val)\r\n{\r\nstruct i2c_msg msgs[] = {\r\n{\r\n.addr = dvo->slave_addr,\r\n.flags = 0,\r\n.len = 1,\r\n.buf = &addr,\r\n},\r\n{\r\n.addr = dvo->slave_addr,\r\n.flags = I2C_M_RD,\r\n.len = 1,\r\n.buf = val,\r\n}\r\n};\r\nreturn i2c_transfer(dvo->i2c_bus, msgs, 2) == 2;\r\n}\r\nstatic bool ch7017_write(struct intel_dvo_device *dvo, u8 addr, u8 val)\r\n{\r\nuint8_t buf[2] = { addr, val };\r\nstruct i2c_msg msg = {\r\n.addr = dvo->slave_addr,\r\n.flags = 0,\r\n.len = 2,\r\n.buf = buf,\r\n};\r\nreturn i2c_transfer(dvo->i2c_bus, &msg, 1) == 1;\r\n}\r\nstatic bool ch7017_init(struct intel_dvo_device *dvo,\r\nstruct i2c_adapter *adapter)\r\n{\r\nstruct ch7017_priv *priv;\r\nconst char *str;\r\nu8 val;\r\npriv = kzalloc(sizeof(struct ch7017_priv), GFP_KERNEL);\r\nif (priv == NULL)\r\nreturn false;\r\ndvo->i2c_bus = adapter;\r\ndvo->dev_priv = priv;\r\nif (!ch7017_read(dvo, CH7017_DEVICE_ID, &val))\r\ngoto fail;\r\nswitch (val) {\r\ncase CH7017_DEVICE_ID_VALUE:\r\nstr = "ch7017";\r\nbreak;\r\ncase CH7018_DEVICE_ID_VALUE:\r\nstr = "ch7018";\r\nbreak;\r\ncase CH7019_DEVICE_ID_VALUE:\r\nstr = "ch7019";\r\nbreak;\r\ndefault:\r\nDRM_DEBUG_KMS("ch701x not detected, got %d: from %s "\r\n"slave %d.\n",\r\nval, adapter->name,dvo->slave_addr);\r\ngoto fail;\r\n}\r\nDRM_DEBUG_KMS("%s detected on %s, addr %d\n",\r\nstr, adapter->name, dvo->slave_addr);\r\nreturn true;\r\nfail:\r\nkfree(priv);\r\nreturn false;\r\n}\r\nstatic enum drm_connector_status ch7017_detect(struct intel_dvo_device *dvo)\r\n{\r\nreturn connector_status_connected;\r\n}\r\nstatic enum drm_mode_status ch7017_mode_valid(struct intel_dvo_device *dvo,\r\nstruct drm_display_mode *mode)\r\n{\r\nif (mode->clock > 160000)\r\nreturn MODE_CLOCK_HIGH;\r\nreturn MODE_OK;\r\n}\r\nstatic void ch7017_mode_set(struct intel_dvo_device *dvo,\r\nstruct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nuint8_t lvds_pll_feedback_div, lvds_pll_vco_control;\r\nuint8_t outputs_enable, lvds_control_2, lvds_power_down;\r\nuint8_t horizontal_active_pixel_input;\r\nuint8_t horizontal_active_pixel_output, vertical_active_line_output;\r\nuint8_t active_input_line_output;\r\nDRM_DEBUG_KMS("Registers before mode setting\n");\r\nch7017_dump_regs(dvo);\r\nif (mode->clock < 100000) {\r\noutputs_enable = CH7017_LVDS_CHANNEL_A | CH7017_CHARGE_PUMP_LOW;\r\nlvds_pll_feedback_div = CH7017_LVDS_PLL_FEEDBACK_DEFAULT_RESERVED |\r\n(2 << CH7017_LVDS_PLL_FEED_BACK_DIVIDER_SHIFT) |\r\n(13 << CH7017_LVDS_PLL_FEED_FORWARD_DIVIDER_SHIFT);\r\nlvds_pll_vco_control = CH7017_LVDS_PLL_VCO_DEFAULT_RESERVED |\r\n(2 << CH7017_LVDS_PLL_VCO_SHIFT) |\r\n(3 << CH7017_LVDS_PLL_POST_SCALE_DIV_SHIFT);\r\nlvds_control_2 = (1 << CH7017_LOOP_FILTER_SHIFT) |\r\n(0 << CH7017_PHASE_DETECTOR_SHIFT);\r\n} else {\r\noutputs_enable = CH7017_LVDS_CHANNEL_A | CH7017_CHARGE_PUMP_HIGH;\r\nlvds_pll_feedback_div = CH7017_LVDS_PLL_FEEDBACK_DEFAULT_RESERVED |\r\n(2 << CH7017_LVDS_PLL_FEED_BACK_DIVIDER_SHIFT) |\r\n(3 << CH7017_LVDS_PLL_FEED_FORWARD_DIVIDER_SHIFT);\r\nlvds_pll_feedback_div = 35;\r\nlvds_control_2 = (3 << CH7017_LOOP_FILTER_SHIFT) |\r\n(0 << CH7017_PHASE_DETECTOR_SHIFT);\r\nif (1) {\r\noutputs_enable |= CH7017_LVDS_CHANNEL_B;\r\nlvds_pll_vco_control = CH7017_LVDS_PLL_VCO_DEFAULT_RESERVED |\r\n(2 << CH7017_LVDS_PLL_VCO_SHIFT) |\r\n(13 << CH7017_LVDS_PLL_POST_SCALE_DIV_SHIFT);\r\n} else {\r\nlvds_pll_vco_control = CH7017_LVDS_PLL_VCO_DEFAULT_RESERVED |\r\n(1 << CH7017_LVDS_PLL_VCO_SHIFT) |\r\n(13 << CH7017_LVDS_PLL_POST_SCALE_DIV_SHIFT);\r\n}\r\n}\r\nhorizontal_active_pixel_input = mode->hdisplay & 0x00ff;\r\nvertical_active_line_output = mode->vdisplay & 0x00ff;\r\nhorizontal_active_pixel_output = mode->hdisplay & 0x00ff;\r\nactive_input_line_output = ((mode->hdisplay & 0x0700) >> 8) |\r\n(((mode->vdisplay & 0x0700) >> 8) << 3);\r\nlvds_power_down = CH7017_LVDS_POWER_DOWN_DEFAULT_RESERVED |\r\n(mode->hdisplay & 0x0700) >> 8;\r\nch7017_dpms(dvo, DRM_MODE_DPMS_OFF);\r\nch7017_write(dvo, CH7017_HORIZONTAL_ACTIVE_PIXEL_INPUT,\r\nhorizontal_active_pixel_input);\r\nch7017_write(dvo, CH7017_HORIZONTAL_ACTIVE_PIXEL_OUTPUT,\r\nhorizontal_active_pixel_output);\r\nch7017_write(dvo, CH7017_VERTICAL_ACTIVE_LINE_OUTPUT,\r\nvertical_active_line_output);\r\nch7017_write(dvo, CH7017_ACTIVE_INPUT_LINE_OUTPUT,\r\nactive_input_line_output);\r\nch7017_write(dvo, CH7017_LVDS_PLL_VCO_CONTROL, lvds_pll_vco_control);\r\nch7017_write(dvo, CH7017_LVDS_PLL_FEEDBACK_DIV, lvds_pll_feedback_div);\r\nch7017_write(dvo, CH7017_LVDS_CONTROL_2, lvds_control_2);\r\nch7017_write(dvo, CH7017_OUTPUTS_ENABLE, outputs_enable);\r\nch7017_write(dvo, CH7017_LVDS_POWER_DOWN, lvds_power_down);\r\nDRM_DEBUG_KMS("Registers after mode setting\n");\r\nch7017_dump_regs(dvo);\r\n}\r\nstatic void ch7017_dpms(struct intel_dvo_device *dvo, int mode)\r\n{\r\nuint8_t val;\r\nch7017_read(dvo, CH7017_LVDS_POWER_DOWN, &val);\r\nch7017_write(dvo, CH7017_POWER_MANAGEMENT,\r\nCH7017_DAC0_POWER_DOWN |\r\nCH7017_DAC1_POWER_DOWN |\r\nCH7017_DAC2_POWER_DOWN |\r\nCH7017_DAC3_POWER_DOWN |\r\nCH7017_TV_POWER_DOWN_EN);\r\nif (mode == DRM_MODE_DPMS_ON) {\r\nch7017_write(dvo, CH7017_LVDS_POWER_DOWN,\r\nval & ~CH7017_LVDS_POWER_DOWN_EN);\r\n} else {\r\nch7017_write(dvo, CH7017_LVDS_POWER_DOWN,\r\nval | CH7017_LVDS_POWER_DOWN_EN);\r\n}\r\nmsleep(20);\r\n}\r\nstatic void ch7017_dump_regs(struct intel_dvo_device *dvo)\r\n{\r\nuint8_t val;\r\n#define DUMP(reg) \\r\ndo { \\r\nch7017_read(dvo, reg, &val); \\r\nDRM_DEBUG_KMS(#reg ": %02x\n", val); \\r\n} while (0)\r\nDUMP(CH7017_HORIZONTAL_ACTIVE_PIXEL_INPUT);\r\nDUMP(CH7017_HORIZONTAL_ACTIVE_PIXEL_OUTPUT);\r\nDUMP(CH7017_VERTICAL_ACTIVE_LINE_OUTPUT);\r\nDUMP(CH7017_ACTIVE_INPUT_LINE_OUTPUT);\r\nDUMP(CH7017_LVDS_PLL_VCO_CONTROL);\r\nDUMP(CH7017_LVDS_PLL_FEEDBACK_DIV);\r\nDUMP(CH7017_LVDS_CONTROL_2);\r\nDUMP(CH7017_OUTPUTS_ENABLE);\r\nDUMP(CH7017_LVDS_POWER_DOWN);\r\n}\r\nstatic void ch7017_destroy(struct intel_dvo_device *dvo)\r\n{\r\nstruct ch7017_priv *priv = dvo->dev_priv;\r\nif (priv) {\r\nkfree(priv);\r\ndvo->dev_priv = NULL;\r\n}\r\n}

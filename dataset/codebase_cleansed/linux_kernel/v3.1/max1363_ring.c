int max1363_single_channel_from_ring(long mask, struct max1363_state *st)\r\n{\r\nstruct iio_ring_buffer *ring = iio_priv_to_dev(st)->ring;\r\nint count = 0, ret;\r\nu8 *ring_data;\r\nif (!(st->current_mode->modemask & mask)) {\r\nret = -EBUSY;\r\ngoto error_ret;\r\n}\r\nring_data = kmalloc(ring->access->get_bytes_per_datum(ring),\r\nGFP_KERNEL);\r\nif (ring_data == NULL) {\r\nret = -ENOMEM;\r\ngoto error_ret;\r\n}\r\nret = ring->access->read_last(ring, ring_data);\r\nif (ret)\r\ngoto error_free_ring_data;\r\nmask >>= 1;\r\nwhile (mask) {\r\nif (mask & st->current_mode->modemask)\r\ncount++;\r\nmask >>= 1;\r\n}\r\nif (st->chip_info->bits != 8)\r\nret = ((int)(ring_data[count*2 + 0] & 0x0F) << 8)\r\n+ (int)(ring_data[count*2 + 1]);\r\nelse\r\nret = ring_data[count];\r\nerror_free_ring_data:\r\nkfree(ring_data);\r\nerror_ret:\r\nreturn ret;\r\n}\r\nstatic int max1363_ring_preenable(struct iio_dev *indio_dev)\r\n{\r\nstruct max1363_state *st = iio_priv(indio_dev);\r\nstruct iio_ring_buffer *ring = indio_dev->ring;\r\nsize_t d_size = 0;\r\nunsigned long numvals;\r\nst->current_mode = max1363_match_mode(ring->scan_mask,\r\nst->chip_info);\r\nif (!st->current_mode)\r\nreturn -EINVAL;\r\nmax1363_set_scan_mode(st);\r\nnumvals = hweight_long(st->current_mode->modemask);\r\nif (ring->access->set_bytes_per_datum) {\r\nif (ring->scan_timestamp)\r\nd_size += sizeof(s64);\r\nif (st->chip_info->bits != 8)\r\nd_size += numvals*2;\r\nelse\r\nd_size += numvals;\r\nif (ring->scan_timestamp && (d_size % 8))\r\nd_size += 8 - (d_size % 8);\r\nring->access->set_bytes_per_datum(ring, d_size);\r\n}\r\nreturn 0;\r\n}\r\nstatic irqreturn_t max1363_trigger_handler(int irq, void *p)\r\n{\r\nstruct iio_poll_func *pf = p;\r\nstruct iio_dev *indio_dev = pf->private_data;\r\nstruct max1363_state *st = iio_priv(indio_dev);\r\ns64 time_ns;\r\n__u8 *rxbuf;\r\nint b_sent;\r\nsize_t d_size;\r\nunsigned long numvals = hweight_long(st->current_mode->modemask);\r\nif (st->chip_info->bits != 8)\r\nd_size = numvals*2 + sizeof(s64);\r\nelse\r\nd_size = numvals + sizeof(s64);\r\nif (d_size % sizeof(s64))\r\nd_size += sizeof(s64) - (d_size % sizeof(s64));\r\nif (numvals == 0)\r\nreturn IRQ_HANDLED;\r\nrxbuf = kmalloc(d_size, GFP_KERNEL);\r\nif (rxbuf == NULL)\r\nreturn -ENOMEM;\r\nif (st->chip_info->bits != 8)\r\nb_sent = i2c_master_recv(st->client, rxbuf, numvals*2);\r\nelse\r\nb_sent = i2c_master_recv(st->client, rxbuf, numvals);\r\nif (b_sent < 0)\r\ngoto done;\r\ntime_ns = iio_get_time_ns();\r\nmemcpy(rxbuf + d_size - sizeof(s64), &time_ns, sizeof(time_ns));\r\nindio_dev->ring->access->store_to(indio_dev->ring, rxbuf, time_ns);\r\ndone:\r\niio_trigger_notify_done(indio_dev->trig);\r\nkfree(rxbuf);\r\nreturn IRQ_HANDLED;\r\n}\r\nint max1363_register_ring_funcs_and_init(struct iio_dev *indio_dev)\r\n{\r\nstruct max1363_state *st = iio_priv(indio_dev);\r\nint ret = 0;\r\nindio_dev->ring = iio_sw_rb_allocate(indio_dev);\r\nif (!indio_dev->ring) {\r\nret = -ENOMEM;\r\ngoto error_ret;\r\n}\r\nindio_dev->pollfunc = iio_alloc_pollfunc(NULL,\r\n&max1363_trigger_handler,\r\nIRQF_ONESHOT,\r\nindio_dev,\r\n"%s_consumer%d",\r\nst->client->name,\r\nindio_dev->id);\r\nif (indio_dev->pollfunc == NULL) {\r\nret = -ENOMEM;\r\ngoto error_deallocate_sw_rb;\r\n}\r\nindio_dev->ring->access = &ring_sw_access_funcs;\r\nindio_dev->ring->setup_ops = &max1363_ring_setup_ops;\r\nindio_dev->modes |= INDIO_RING_TRIGGERED;\r\nreturn 0;\r\nerror_deallocate_sw_rb:\r\niio_sw_rb_free(indio_dev->ring);\r\nerror_ret:\r\nreturn ret;\r\n}\r\nvoid max1363_ring_cleanup(struct iio_dev *indio_dev)\r\n{\r\nif (indio_dev->trig) {\r\niio_put_trigger(indio_dev->trig);\r\niio_trigger_dettach_poll_func(indio_dev->trig,\r\nindio_dev->pollfunc);\r\n}\r\niio_dealloc_pollfunc(indio_dev->pollfunc);\r\niio_sw_rb_free(indio_dev->ring);\r\n}

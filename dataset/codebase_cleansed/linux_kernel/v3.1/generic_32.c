static inline void io_remap_pte_range(struct mm_struct *mm, pte_t * pte, unsigned long address, unsigned long size,\r\nunsigned long offset, pgprot_t prot, int space)\r\n{\r\nunsigned long end;\r\naddress &= ~PMD_MASK;\r\nend = address + size;\r\nif (end > PMD_SIZE)\r\nend = PMD_SIZE;\r\ndo {\r\nset_pte_at(mm, address, pte, mk_pte_io(offset, prot, space));\r\naddress += PAGE_SIZE;\r\noffset += PAGE_SIZE;\r\npte++;\r\n} while (address < end);\r\n}\r\nstatic inline int io_remap_pmd_range(struct mm_struct *mm, pmd_t * pmd, unsigned long address, unsigned long size,\r\nunsigned long offset, pgprot_t prot, int space)\r\n{\r\nunsigned long end;\r\naddress &= ~PGDIR_MASK;\r\nend = address + size;\r\nif (end > PGDIR_SIZE)\r\nend = PGDIR_SIZE;\r\noffset -= address;\r\ndo {\r\npte_t *pte = pte_alloc_map(mm, NULL, pmd, address);\r\nif (!pte)\r\nreturn -ENOMEM;\r\nio_remap_pte_range(mm, pte, address, end - address, address + offset, prot, space);\r\naddress = (address + PMD_SIZE) & PMD_MASK;\r\npmd++;\r\n} while (address < end);\r\nreturn 0;\r\n}\r\nint io_remap_pfn_range(struct vm_area_struct *vma, unsigned long from,\r\nunsigned long pfn, unsigned long size, pgprot_t prot)\r\n{\r\nint error = 0;\r\npgd_t * dir;\r\nunsigned long beg = from;\r\nunsigned long end = from + size;\r\nstruct mm_struct *mm = vma->vm_mm;\r\nint space = GET_IOSPACE(pfn);\r\nunsigned long offset = GET_PFN(pfn) << PAGE_SHIFT;\r\nvma->vm_flags |= VM_IO | VM_RESERVED | VM_PFNMAP;\r\nvma->vm_pgoff = (offset >> PAGE_SHIFT) |\r\n((unsigned long)space << 28UL);\r\noffset -= from;\r\ndir = pgd_offset(mm, from);\r\nflush_cache_range(vma, beg, end);\r\nwhile (from < end) {\r\npmd_t *pmd = pmd_alloc(mm, dir, from);\r\nerror = -ENOMEM;\r\nif (!pmd)\r\nbreak;\r\nerror = io_remap_pmd_range(mm, pmd, from, end - from, offset + from, prot, space);\r\nif (error)\r\nbreak;\r\nfrom = (from + PGDIR_SIZE) & PGDIR_MASK;\r\ndir++;\r\n}\r\nflush_tlb_range(vma, beg, end);\r\nreturn error;\r\n}

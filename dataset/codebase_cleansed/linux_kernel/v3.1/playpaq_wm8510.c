static struct ssc_clock_data playpaq_wm8510_calc_ssc_clock(\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *cpu_dai)\r\n{\r\nstruct at32_ssc_info *ssc_p = snd_soc_dai_get_drvdata(cpu_dai);\r\nstruct ssc_device *ssc = ssc_p->ssc;\r\nstruct ssc_clock_data cd;\r\nunsigned int rate, width_bits, channels;\r\nunsigned int bitrate, ssc_div;\r\nunsigned actual_rate;\r\nrate = params_rate(params);\r\nchannels = params_channels(params);\r\nwidth_bits = snd_pcm_format_physical_width(params_format(params));\r\nbitrate = rate * width_bits * channels;\r\ncd.ssc_rate = clk_get_rate(ssc->clk);\r\nssc_div = cd.ssc_rate / bitrate;\r\ncd.cmr_div = ssc_div / 2;\r\nif (ssc_div & 1) {\r\ncd.cmr_div++;\r\n}\r\ncd.period = width_bits - 1;\r\nactual_rate = (cd.ssc_rate / (cd.cmr_div * 2)) / (2 * (cd.period + 1));\r\npr_debug("playpaq_wm8510: Request rate = %u, actual rate = %u\n",\r\nrate, actual_rate);\r\nreturn cd;\r\n}\r\nstatic int playpaq_wm8510_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nstruct at32_ssc_info *ssc_p = snd_soc_dai_get_drvdata(cpu_dai);\r\nstruct ssc_device *ssc = ssc_p->ssc;\r\nunsigned int pll_out = 0, bclk = 0, mclk_div = 0;\r\nint ret;\r\n#if !defined CONFIG_SND_AT32_SOC_PLAYPAQ_SLAVE\r\nconst unsigned int fmt = (SND_SOC_DAIFMT_I2S |\r\nSND_SOC_DAIFMT_NB_NF |\r\nSND_SOC_DAIFMT_CBM_CFM);\r\n#else\r\nstruct ssc_clock_data cd;\r\nconst unsigned int fmt = (SND_SOC_DAIFMT_I2S |\r\nSND_SOC_DAIFMT_NB_NF |\r\nSND_SOC_DAIFMT_CBS_CFS);\r\n#endif\r\nif (ssc == NULL) {\r\npr_warning("playpaq_wm8510_hw_params: ssc is NULL!\n");\r\nreturn -EINVAL;\r\n}\r\nswitch (params_rate(params)) {\r\ncase 48000:\r\npll_out = 24576000;\r\nmclk_div = WM8510_MCLKDIV_2;\r\nbclk = WM8510_BCLKDIV_8;\r\nbreak;\r\ncase 44100:\r\npll_out = 22579200;\r\nmclk_div = WM8510_MCLKDIV_2;\r\nbclk = WM8510_BCLKDIV_8;\r\nbreak;\r\ncase 22050:\r\npll_out = 22579200;\r\nmclk_div = WM8510_MCLKDIV_4;\r\nbclk = WM8510_BCLKDIV_8;\r\nbreak;\r\ncase 16000:\r\npll_out = 24576000;\r\nmclk_div = WM8510_MCLKDIV_6;\r\nbclk = WM8510_BCLKDIV_8;\r\nbreak;\r\ncase 11025:\r\npll_out = 22579200;\r\nmclk_div = WM8510_MCLKDIV_8;\r\nbclk = WM8510_BCLKDIV_8;\r\nbreak;\r\ncase 8000:\r\npll_out = 24576000;\r\nmclk_div = WM8510_MCLKDIV_12;\r\nbclk = WM8510_BCLKDIV_8;\r\nbreak;\r\ndefault:\r\npr_warning("playpaq_wm8510: Unsupported sample rate %d\n",\r\nparams_rate(params));\r\nreturn -EINVAL;\r\n}\r\nret = snd_soc_dai_set_fmt(codec_dai, fmt);\r\nif (ret < 0) {\r\npr_warning("playpaq_wm8510: "\r\n"Failed to set CODEC DAI format (%d)\n",\r\nret);\r\nreturn ret;\r\n}\r\nret = snd_soc_dai_set_fmt(cpu_dai, fmt);\r\nif (ret < 0) {\r\npr_warning("playpaq_wm8510: "\r\n"Failed to set CPU DAI format (%d)\n",\r\nret);\r\nreturn ret;\r\n}\r\n#if defined CONFIG_SND_AT32_SOC_PLAYPAQ_SLAVE\r\ncd = playpaq_wm8510_calc_ssc_clock(params, cpu_dai);\r\npr_debug("playpaq_wm8510: cmr_div = %d, period = %d\n",\r\ncd.cmr_div, cd.period);\r\nret = snd_soc_dai_set_clkdiv(cpu_dai, AT32_SSC_CMR_DIV, cd.cmr_div);\r\nif (ret < 0) {\r\npr_warning("playpaq_wm8510: Failed to set CPU CMR_DIV (%d)\n",\r\nret);\r\nreturn ret;\r\n}\r\nret = snd_soc_dai_set_clkdiv(cpu_dai, AT32_SSC_TCMR_PERIOD,\r\ncd.period);\r\nif (ret < 0) {\r\npr_warning("playpaq_wm8510: "\r\n"Failed to set CPU transmit period (%d)\n",\r\nret);\r\nreturn ret;\r\n}\r\n#endif\r\npr_debug("playpaq_wm8510: "\r\n"pll_in = %ld, pll_out = %u, bclk = %x, mclk = %x\n",\r\nclk_get_rate(CODEC_CLK), pll_out, bclk, mclk_div);\r\n#if !defined CONFIG_SND_AT32_SOC_PLAYPAQ_SLAVE\r\nret = snd_soc_dai_set_clkdiv(codec_dai, WM8510_BCLKDIV, bclk);\r\nif (ret < 0) {\r\npr_warning\r\n("playpaq_wm8510: Failed to set CODEC DAI BCLKDIV (%d)\n",\r\nret);\r\nreturn ret;\r\n}\r\n#endif\r\nret = snd_soc_dai_set_pll(codec_dai, 0, 0,\r\nclk_get_rate(CODEC_CLK), pll_out);\r\nif (ret < 0) {\r\npr_warning("playpaq_wm8510: Failed to set CODEC DAI PLL (%d)\n",\r\nret);\r\nreturn ret;\r\n}\r\nret = snd_soc_dai_set_clkdiv(codec_dai, WM8510_MCLKDIV, mclk_div);\r\nif (ret < 0) {\r\npr_warning("playpaq_wm8510: Failed to set CODEC MCLKDIV (%d)\n",\r\nret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int playpaq_wm8510_init(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct snd_soc_codec *codec = rtd->codec;\r\nstruct snd_soc_dapm_context *dapm = &codec->dapm;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(playpaq_dapm_widgets); i++)\r\nsnd_soc_dapm_new_control(dapm, &playpaq_dapm_widgets[i]);\r\nsnd_soc_dapm_add_routes(dapm, intercon, ARRAY_SIZE(intercon));\r\nsnd_soc_dapm_enable_pin(dapm, "Int Mic");\r\nsnd_soc_dapm_enable_pin(dapm, "Ext Spk");\r\nsnd_soc_dapm_sync(dapm);\r\nsnd_soc_dai_set_clkdiv(rtd->codec_dai, WM8510_OPCLKDIV,\r\nWM8510_OPCLKDIV_1 | 4);\r\nreturn 0;\r\n}\r\nstatic int __init playpaq_asoc_init(void)\r\n{\r\nint ret = 0;\r\n_gclk0 = clk_get(NULL, "gclk0");\r\nif (IS_ERR(_gclk0)) {\r\n_gclk0 = NULL;\r\ngoto err_gclk0;\r\n}\r\n_pll0 = clk_get(NULL, "pll0");\r\nif (IS_ERR(_pll0)) {\r\n_pll0 = NULL;\r\ngoto err_pll0;\r\n}\r\nif (clk_set_parent(_gclk0, _pll0)) {\r\npr_warning("snd-soc-playpaq: "\r\n"Failed to set PLL0 as parent for DAC clock\n");\r\ngoto err_set_clk;\r\n}\r\nclk_set_rate(CODEC_CLK, 12000000);\r\nclk_enable(CODEC_CLK);\r\n#if defined CONFIG_AT32_ENHANCED_PORTMUX\r\nat32_select_periph(MCLK_PIN, MCLK_PERIPH, 0);\r\n#endif\r\nplaypaq_snd_device = platform_device_alloc("soc-audio", 0);\r\nif (playpaq_snd_device == NULL) {\r\nret = -ENOMEM;\r\ngoto err_device_alloc;\r\n}\r\nplatform_set_drvdata(playpaq_snd_device, &snd_soc_playpaq);\r\nret = platform_device_add(playpaq_snd_device);\r\nif (ret) {\r\npr_warning("playpaq_wm8510: platform_device_add failed (%d)\n",\r\nret);\r\ngoto err_device_add;\r\n}\r\nreturn 0;\r\nerr_device_add:\r\nif (playpaq_snd_device != NULL) {\r\nplatform_device_put(playpaq_snd_device);\r\nplaypaq_snd_device = NULL;\r\n}\r\nerr_device_alloc:\r\nerr_set_clk:\r\nif (_pll0 != NULL) {\r\nclk_put(_pll0);\r\n_pll0 = NULL;\r\n}\r\nerr_pll0:\r\nif (_gclk0 != NULL) {\r\nclk_put(_gclk0);\r\n_gclk0 = NULL;\r\n}\r\nreturn ret;\r\n}\r\nstatic void __exit playpaq_asoc_exit(void)\r\n{\r\nif (_gclk0 != NULL) {\r\nclk_put(_gclk0);\r\n_gclk0 = NULL;\r\n}\r\nif (_pll0 != NULL) {\r\nclk_put(_pll0);\r\n_pll0 = NULL;\r\n}\r\n#if defined CONFIG_AT32_ENHANCED_PORTMUX\r\nat32_free_pin(MCLK_PIN);\r\n#endif\r\nplatform_device_unregister(playpaq_snd_device);\r\nplaypaq_snd_device = NULL;\r\n}

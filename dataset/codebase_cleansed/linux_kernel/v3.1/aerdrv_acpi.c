static inline int hest_match_pci(struct acpi_hest_aer_common *p,\r\nstruct pci_dev *pci)\r\n{\r\nreturn (0 == pci_domain_nr(pci->bus) &&\r\np->bus == pci->bus->number &&\r\np->device == PCI_SLOT(pci->devfn) &&\r\np->function == PCI_FUNC(pci->devfn));\r\n}\r\nstatic int aer_hest_parse(struct acpi_hest_header *hest_hdr, void *data)\r\n{\r\nstruct aer_hest_parse_info *info = data;\r\nstruct acpi_hest_aer_common *p;\r\nu8 pcie_type = 0;\r\nu8 bridge = 0;\r\nint ff = 0;\r\nswitch (hest_hdr->type) {\r\ncase ACPI_HEST_TYPE_AER_ROOT_PORT:\r\npcie_type = PCI_EXP_TYPE_ROOT_PORT;\r\nbreak;\r\ncase ACPI_HEST_TYPE_AER_ENDPOINT:\r\npcie_type = PCI_EXP_TYPE_ENDPOINT;\r\nbreak;\r\ncase ACPI_HEST_TYPE_AER_BRIDGE:\r\nif ((info->pci_dev->class >> 16) == PCI_BASE_CLASS_BRIDGE)\r\nbridge = 1;\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\np = (struct acpi_hest_aer_common *)(hest_hdr + 1);\r\nif (p->flags & ACPI_HEST_GLOBAL) {\r\nif ((info->pci_dev->is_pcie &&\r\ninfo->pci_dev->pcie_type == pcie_type) || bridge)\r\nff = !!(p->flags & ACPI_HEST_FIRMWARE_FIRST);\r\n} else\r\nif (hest_match_pci(p, info->pci_dev))\r\nff = !!(p->flags & ACPI_HEST_FIRMWARE_FIRST);\r\ninfo->firmware_first = ff;\r\nreturn 0;\r\n}\r\nstatic void aer_set_firmware_first(struct pci_dev *pci_dev)\r\n{\r\nint rc;\r\nstruct aer_hest_parse_info info = {\r\n.pci_dev = pci_dev,\r\n.firmware_first = 0,\r\n};\r\nrc = apei_hest_parse(aer_hest_parse, &info);\r\nif (rc)\r\npci_dev->__aer_firmware_first = 0;\r\nelse\r\npci_dev->__aer_firmware_first = info.firmware_first;\r\npci_dev->__aer_firmware_first_valid = 1;\r\n}\r\nint pcie_aer_get_firmware_first(struct pci_dev *dev)\r\n{\r\nif (!dev->__aer_firmware_first_valid)\r\naer_set_firmware_first(dev);\r\nreturn dev->__aer_firmware_first;\r\n}\r\nstatic int aer_hest_parse_aff(struct acpi_hest_header *hest_hdr, void *data)\r\n{\r\nstruct acpi_hest_aer_common *p;\r\nif (aer_firmware_first)\r\nreturn 0;\r\nswitch (hest_hdr->type) {\r\ncase ACPI_HEST_TYPE_AER_ROOT_PORT:\r\ncase ACPI_HEST_TYPE_AER_ENDPOINT:\r\ncase ACPI_HEST_TYPE_AER_BRIDGE:\r\np = (struct acpi_hest_aer_common *)(hest_hdr + 1);\r\naer_firmware_first = !!(p->flags & ACPI_HEST_FIRMWARE_FIRST);\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nbool aer_acpi_firmware_first(void)\r\n{\r\nstatic bool parsed = false;\r\nif (!parsed) {\r\napei_hest_parse(aer_hest_parse_aff, NULL);\r\nparsed = true;\r\n}\r\nreturn aer_firmware_first;\r\n}

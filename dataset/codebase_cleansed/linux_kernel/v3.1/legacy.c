static void __devinit pcibios_fixup_peer_bridges(void)\r\n{\r\nint n;\r\nif (pcibios_last_bus <= 0 || pcibios_last_bus > 0xff)\r\nreturn;\r\nDBG("PCI: Peer bridge fixup\n");\r\nfor (n=0; n <= pcibios_last_bus; n++)\r\npcibios_scan_specific_bus(n);\r\n}\r\nint __init pci_legacy_init(void)\r\n{\r\nif (!raw_pci_ops) {\r\nprintk("PCI: System does not support PCI\n");\r\nreturn 0;\r\n}\r\nprintk("PCI: Probing PCI hardware\n");\r\npci_root_bus = pcibios_scan_root(0);\r\nif (pci_root_bus)\r\npci_bus_add_devices(pci_root_bus);\r\nreturn 0;\r\n}\r\nvoid __devinit pcibios_scan_specific_bus(int busn)\r\n{\r\nint devfn;\r\nlong node;\r\nu32 l;\r\nif (pci_find_bus(0, busn))\r\nreturn;\r\nnode = get_mp_bus_to_node(busn);\r\nfor (devfn = 0; devfn < 256; devfn += 8) {\r\nif (!raw_pci_read(0, busn, devfn, PCI_VENDOR_ID, 2, &l) &&\r\nl != 0x0000 && l != 0xffff) {\r\nDBG("Found device at %02x:%02x [%04x]\n", busn, devfn, l);\r\nprintk(KERN_INFO "PCI: Discovered peer bus %02x\n", busn);\r\npci_scan_bus_on_node(busn, &pci_root_ops, node);\r\nreturn;\r\n}\r\n}\r\n}\r\nint __init pci_subsys_init(void)\r\n{\r\nif (x86_init.pci.init())\r\npci_legacy_init();\r\npcibios_fixup_peer_bridges();\r\nx86_init.pci.init_irq();\r\npcibios_init();\r\nreturn 0;\r\n}

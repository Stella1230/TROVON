int rpaphp_get_sensor_state(struct slot *slot, int *state)\r\n{\r\nint rc;\r\nint setlevel;\r\nrc = rtas_get_sensor(DR_ENTITY_SENSE, slot->index, state);\r\nif (rc < 0) {\r\nif (rc == -EFAULT || rc == -EEXIST) {\r\ndbg("%s: slot must be power up to get sensor-state\n",\r\n__func__);\r\nrc = rtas_set_power_level(slot->power_domain, POWER_ON,\r\n&setlevel);\r\nif (rc < 0) {\r\ndbg("%s: power on slot[%s] failed rc=%d.\n",\r\n__func__, slot->name, rc);\r\n} else {\r\nrc = rtas_get_sensor(DR_ENTITY_SENSE,\r\nslot->index, state);\r\n}\r\n} else if (rc == -ENODEV)\r\ninfo("%s: slot is unusable\n", __func__);\r\nelse\r\nerr("%s failed to get sensor state\n", __func__);\r\n}\r\nreturn rc;\r\n}\r\nint rpaphp_enable_slot(struct slot *slot)\r\n{\r\nint rc, level, state;\r\nstruct pci_bus *bus;\r\nstruct hotplug_slot_info *info = slot->hotplug_slot->info;\r\ninfo->adapter_status = NOT_VALID;\r\nslot->state = EMPTY;\r\nrc = rtas_get_power_level(slot->power_domain, &level);\r\nif (rc)\r\nreturn rc;\r\ninfo->power_status = level;\r\nrc = rpaphp_get_sensor_state(slot, &state);\r\nif (rc)\r\nreturn rc;\r\nbus = pcibios_find_pci_bus(slot->dn);\r\nif (!bus) {\r\nerr("%s: no pci_bus for dn %s\n", __func__, slot->dn->full_name);\r\nreturn -EINVAL;\r\n}\r\ninfo->adapter_status = EMPTY;\r\nslot->bus = bus;\r\nslot->pci_devs = &bus->devices;\r\nif (state == PRESENT) {\r\ninfo->adapter_status = NOT_CONFIGURED;\r\nslot->state = NOT_CONFIGURED;\r\nif (!slot->dn->child) {\r\nerr("%s: slot[%s]'s device_node doesn't have child for adapter\n",\r\n__func__, slot->name);\r\nreturn -EINVAL;\r\n}\r\nif (list_empty(&bus->devices))\r\npcibios_add_pci_devices(bus);\r\nif (!list_empty(&bus->devices)) {\r\ninfo->adapter_status = CONFIGURED;\r\nslot->state = CONFIGURED;\r\n}\r\nif (rpaphp_debug) {\r\nstruct pci_dev *dev;\r\ndbg("%s: pci_devs of slot[%s]\n", __func__, slot->dn->full_name);\r\nlist_for_each_entry (dev, &bus->devices, bus_list)\r\ndbg("\t%s\n", pci_name(dev));\r\n}\r\n}\r\nreturn 0;\r\n}

static int __init aoe_iflist_setup(char *str)\r\n{\r\nstrncpy(aoe_iflist, str, IFLISTSZ);\r\naoe_iflist[IFLISTSZ - 1] = '\0';\r\nreturn 1;\r\n}\r\nint\r\nis_aoe_netif(struct net_device *ifp)\r\n{\r\nregister char *p, *q;\r\nregister int len;\r\nif (aoe_iflist[0] == '\0')\r\nreturn 1;\r\np = aoe_iflist + strspn(aoe_iflist, WHITESPACE);\r\nfor (; *p; p = q + strspn(q, WHITESPACE)) {\r\nq = p + strcspn(p, WHITESPACE);\r\nif (q != p)\r\nlen = q - p;\r\nelse\r\nlen = strlen(p);\r\nif (strlen(ifp->name) == len && !strncmp(ifp->name, p, len))\r\nreturn 1;\r\nif (q == p)\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nint\r\nset_aoe_iflist(const char __user *user_str, size_t size)\r\n{\r\nif (size >= IFLISTSZ)\r\nreturn -EINVAL;\r\nif (copy_from_user(aoe_iflist, user_str, size)) {\r\nprintk(KERN_INFO "aoe: copy from user failed\n");\r\nreturn -EFAULT;\r\n}\r\naoe_iflist[size] = 0x00;\r\nreturn 0;\r\n}\r\nvoid\r\naoenet_xmit(struct sk_buff_head *queue)\r\n{\r\nstruct sk_buff *skb, *tmp;\r\nskb_queue_walk_safe(queue, skb, tmp) {\r\n__skb_unlink(skb, queue);\r\ndev_queue_xmit(skb);\r\n}\r\n}\r\nstatic int\r\naoenet_rcv(struct sk_buff *skb, struct net_device *ifp, struct packet_type *pt, struct net_device *orig_dev)\r\n{\r\nstruct aoe_hdr *h;\r\nu32 n;\r\nif (dev_net(ifp) != &init_net)\r\ngoto exit;\r\nskb = skb_share_check(skb, GFP_ATOMIC);\r\nif (skb == NULL)\r\nreturn 0;\r\nif (skb_linearize(skb))\r\ngoto exit;\r\nif (!is_aoe_netif(ifp))\r\ngoto exit;\r\nskb_push(skb, ETH_HLEN);\r\nh = (struct aoe_hdr *) skb_mac_header(skb);\r\nn = get_unaligned_be32(&h->tag);\r\nif ((h->verfl & AOEFL_RSP) == 0 || (n & 1<<31))\r\ngoto exit;\r\nif (h->verfl & AOEFL_ERR) {\r\nn = h->err;\r\nif (n > NECODES)\r\nn = 0;\r\nif (net_ratelimit())\r\nprintk(KERN_ERR\r\n"%s%d.%d@%s; ecode=%d '%s'\n",\r\n"aoe: error packet from ",\r\nget_unaligned_be16(&h->major),\r\nh->minor, skb->dev->name,\r\nh->err, aoe_errlist[n]);\r\ngoto exit;\r\n}\r\nswitch (h->cmd) {\r\ncase AOECMD_ATA:\r\naoecmd_ata_rsp(skb);\r\nbreak;\r\ncase AOECMD_CFG:\r\naoecmd_cfg_rsp(skb);\r\nbreak;\r\ndefault:\r\nif (h->cmd >= AOECMD_VEND_MIN)\r\nbreak;\r\nprintk(KERN_INFO "aoe: unknown cmd %d\n", h->cmd);\r\n}\r\nexit:\r\ndev_kfree_skb(skb);\r\nreturn 0;\r\n}\r\nint __init\r\naoenet_init(void)\r\n{\r\ndev_add_pack(&aoe_pt);\r\nreturn 0;\r\n}\r\nvoid\r\naoenet_exit(void)\r\n{\r\ndev_remove_pack(&aoe_pt);\r\n}

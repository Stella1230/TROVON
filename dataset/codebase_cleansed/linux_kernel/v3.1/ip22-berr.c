static void save_and_clear_buserr(void)\r\n{\r\ncpu_err_addr = sgimc->cerr;\r\ncpu_err_stat = sgimc->cstat;\r\ngio_err_addr = sgimc->gerr;\r\ngio_err_stat = sgimc->gstat;\r\nextio_stat = ip22_is_fullhouse() ? sgioc->extio : (sgint->errstat << 4);\r\nhpc3_berr_stat = hpc3c0->bestat;\r\nsgimc->cstat = sgimc->gstat = 0;\r\n}\r\nstatic void print_buserr(void)\r\n{\r\nif (extio_stat & EXTIO_MC_BUSERR)\r\nprintk(KERN_ERR "MC Bus Error\n");\r\nif (extio_stat & EXTIO_HPC3_BUSERR)\r\nprintk(KERN_ERR "HPC3 Bus Error 0x%x:<id=0x%x,%s,lane=0x%x>\n",\r\nhpc3_berr_stat,\r\n(hpc3_berr_stat & HPC3_BESTAT_PIDMASK) >>\r\nHPC3_BESTAT_PIDSHIFT,\r\n(hpc3_berr_stat & HPC3_BESTAT_CTYPE) ? "PIO" : "DMA",\r\nhpc3_berr_stat & HPC3_BESTAT_BLMASK);\r\nif (extio_stat & EXTIO_EISA_BUSERR)\r\nprintk(KERN_ERR "EISA Bus Error\n");\r\nif (cpu_err_stat & CPU_ERRMASK)\r\nprintk(KERN_ERR "CPU error 0x%x<%s%s%s%s%s%s> @ 0x%08x\n",\r\ncpu_err_stat,\r\ncpu_err_stat & SGIMC_CSTAT_RD ? "RD " : "",\r\ncpu_err_stat & SGIMC_CSTAT_PAR ? "PAR " : "",\r\ncpu_err_stat & SGIMC_CSTAT_ADDR ? "ADDR " : "",\r\ncpu_err_stat & SGIMC_CSTAT_SYSAD_PAR ? "SYSAD " : "",\r\ncpu_err_stat & SGIMC_CSTAT_SYSCMD_PAR ? "SYSCMD " : "",\r\ncpu_err_stat & SGIMC_CSTAT_BAD_DATA ? "BAD_DATA " : "",\r\ncpu_err_addr);\r\nif (gio_err_stat & GIO_ERRMASK)\r\nprintk(KERN_ERR "GIO error 0x%x:<%s%s%s%s%s%s%s%s> @ 0x%08x\n",\r\ngio_err_stat,\r\ngio_err_stat & SGIMC_GSTAT_RD ? "RD " : "",\r\ngio_err_stat & SGIMC_GSTAT_WR ? "WR " : "",\r\ngio_err_stat & SGIMC_GSTAT_TIME ? "TIME " : "",\r\ngio_err_stat & SGIMC_GSTAT_PROM ? "PROM " : "",\r\ngio_err_stat & SGIMC_GSTAT_ADDR ? "ADDR " : "",\r\ngio_err_stat & SGIMC_GSTAT_BC ? "BC " : "",\r\ngio_err_stat & SGIMC_GSTAT_PIO_RD ? "PIO_RD " : "",\r\ngio_err_stat & SGIMC_GSTAT_PIO_WR ? "PIO_WR " : "",\r\ngio_err_addr);\r\n}\r\nvoid ip22_be_interrupt(int irq)\r\n{\r\nconst int field = 2 * sizeof(unsigned long);\r\nstruct pt_regs *regs = get_irq_regs();\r\nsave_and_clear_buserr();\r\nprint_buserr();\r\nprintk(KERN_ALERT "%s bus error, epc == %0*lx, ra == %0*lx\n",\r\n(regs->cp0_cause & 4) ? "Data" : "Instruction",\r\nfield, regs->cp0_epc, field, regs->regs[31]);\r\ndie_if_kernel("Oops", regs);\r\nforce_sig(SIGBUS, current);\r\n}\r\nstatic int ip22_be_handler(struct pt_regs *regs, int is_fixup)\r\n{\r\nsave_and_clear_buserr();\r\nif (is_fixup)\r\nreturn MIPS_BE_FIXUP;\r\nprint_buserr();\r\nreturn MIPS_BE_FATAL;\r\n}\r\nvoid __init ip22_be_init(void)\r\n{\r\nboard_be_handler = ip22_be_handler;\r\n}

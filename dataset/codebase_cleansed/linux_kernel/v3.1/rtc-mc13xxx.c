static int mc13xxx_rtc_irq_enable_unlocked(struct device *dev,\r\nunsigned int enabled, int irq)\r\n{\r\nstruct mc13xxx_rtc *priv = dev_get_drvdata(dev);\r\nint (*func)(struct mc13xxx *mc13xxx, int irq);\r\nif (!priv->valid)\r\nreturn -ENODATA;\r\nfunc = enabled ? mc13xxx_irq_unmask : mc13xxx_irq_mask;\r\nreturn func(priv->mc13xxx, irq);\r\n}\r\nstatic int mc13xxx_rtc_irq_enable(struct device *dev,\r\nunsigned int enabled, int irq)\r\n{\r\nstruct mc13xxx_rtc *priv = dev_get_drvdata(dev);\r\nint ret;\r\nmc13xxx_lock(priv->mc13xxx);\r\nret = mc13xxx_rtc_irq_enable_unlocked(dev, enabled, irq);\r\nmc13xxx_unlock(priv->mc13xxx);\r\nreturn ret;\r\n}\r\nstatic int mc13xxx_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct mc13xxx_rtc *priv = dev_get_drvdata(dev);\r\nunsigned int seconds, days1, days2;\r\nunsigned long s1970;\r\nint ret;\r\nmc13xxx_lock(priv->mc13xxx);\r\nif (!priv->valid) {\r\nret = -ENODATA;\r\ngoto out;\r\n}\r\nret = mc13xxx_reg_read(priv->mc13xxx, MC13XXX_RTCDAY, &days1);\r\nif (unlikely(ret))\r\ngoto out;\r\nret = mc13xxx_reg_read(priv->mc13xxx, MC13XXX_RTCTOD, &seconds);\r\nif (unlikely(ret))\r\ngoto out;\r\nret = mc13xxx_reg_read(priv->mc13xxx, MC13XXX_RTCDAY, &days2);\r\nout:\r\nmc13xxx_unlock(priv->mc13xxx);\r\nif (ret)\r\nreturn ret;\r\nif (days2 == days1 + 1) {\r\nif (seconds >= 86400 / 2)\r\ndays2 = days1;\r\nelse\r\ndays1 = days2;\r\n}\r\nif (days1 != days2)\r\nreturn -EIO;\r\ns1970 = days1 * 86400 + seconds;\r\nrtc_time_to_tm(s1970, tm);\r\nreturn rtc_valid_tm(tm);\r\n}\r\nstatic int mc13xxx_rtc_set_mmss(struct device *dev, unsigned long secs)\r\n{\r\nstruct mc13xxx_rtc *priv = dev_get_drvdata(dev);\r\nunsigned int seconds, days;\r\nunsigned int alarmseconds;\r\nint ret;\r\nseconds = secs % 86400;\r\ndays = secs / 86400;\r\nmc13xxx_lock(priv->mc13xxx);\r\nret = mc13xxx_reg_read(priv->mc13xxx, MC13XXX_RTCTODA, &alarmseconds);\r\nif (unlikely(ret))\r\ngoto out;\r\nif (alarmseconds < 86400) {\r\nret = mc13xxx_reg_write(priv->mc13xxx,\r\nMC13XXX_RTCTODA, 0x1ffff);\r\nif (unlikely(ret))\r\ngoto out;\r\n}\r\nret = mc13xxx_reg_write(priv->mc13xxx, MC13XXX_RTCTOD, 0);\r\nif (unlikely(ret))\r\ngoto out;\r\nret = mc13xxx_reg_write(priv->mc13xxx, MC13XXX_RTCDAY, days);\r\nif (unlikely(ret))\r\ngoto out;\r\nret = mc13xxx_reg_write(priv->mc13xxx, MC13XXX_RTCTOD, seconds);\r\nif (unlikely(ret))\r\ngoto out;\r\nif (alarmseconds < 86400) {\r\nret = mc13xxx_reg_write(priv->mc13xxx,\r\nMC13XXX_RTCTODA, alarmseconds);\r\nif (unlikely(ret))\r\ngoto out;\r\n}\r\nret = mc13xxx_irq_ack(priv->mc13xxx, MC13XXX_IRQ_RTCRST);\r\nif (unlikely(ret))\r\ngoto out;\r\nret = mc13xxx_irq_unmask(priv->mc13xxx, MC13XXX_IRQ_RTCRST);\r\nout:\r\npriv->valid = !ret;\r\nmc13xxx_unlock(priv->mc13xxx);\r\nreturn ret;\r\n}\r\nstatic int mc13xxx_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alarm)\r\n{\r\nstruct mc13xxx_rtc *priv = dev_get_drvdata(dev);\r\nunsigned seconds, days;\r\nunsigned long s1970;\r\nint enabled, pending;\r\nint ret;\r\nmc13xxx_lock(priv->mc13xxx);\r\nret = mc13xxx_reg_read(priv->mc13xxx, MC13XXX_RTCTODA, &seconds);\r\nif (unlikely(ret))\r\ngoto out;\r\nif (seconds >= 86400) {\r\nret = -ENODATA;\r\ngoto out;\r\n}\r\nret = mc13xxx_reg_read(priv->mc13xxx, MC13XXX_RTCDAY, &days);\r\nif (unlikely(ret))\r\ngoto out;\r\nret = mc13xxx_irq_status(priv->mc13xxx, MC13XXX_IRQ_TODA,\r\n&enabled, &pending);\r\nout:\r\nmc13xxx_unlock(priv->mc13xxx);\r\nif (ret)\r\nreturn ret;\r\nalarm->enabled = enabled;\r\nalarm->pending = pending;\r\ns1970 = days * 86400 + seconds;\r\nrtc_time_to_tm(s1970, &alarm->time);\r\ndev_dbg(dev, "%s: %lu\n", __func__, s1970);\r\nreturn 0;\r\n}\r\nstatic int mc13xxx_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alarm)\r\n{\r\nstruct mc13xxx_rtc *priv = dev_get_drvdata(dev);\r\nunsigned long s1970;\r\nunsigned seconds, days;\r\nint ret;\r\nmc13xxx_lock(priv->mc13xxx);\r\nret = mc13xxx_reg_write(priv->mc13xxx, MC13XXX_RTCTODA, 0x1ffff);\r\nif (unlikely(ret))\r\ngoto out;\r\nret = mc13xxx_irq_ack(priv->mc13xxx, MC13XXX_IRQ_TODA);\r\nif (unlikely(ret))\r\ngoto out;\r\nret = rtc_tm_to_time(&alarm->time, &s1970);\r\nif (unlikely(ret))\r\ngoto out;\r\ndev_dbg(dev, "%s: o%2.s %lu\n", __func__, alarm->enabled ? "n" : "ff",\r\ns1970);\r\nret = mc13xxx_rtc_irq_enable_unlocked(dev, alarm->enabled,\r\nMC13XXX_IRQ_TODA);\r\nif (unlikely(ret))\r\ngoto out;\r\nseconds = s1970 % 86400;\r\ndays = s1970 / 86400;\r\nret = mc13xxx_reg_write(priv->mc13xxx, MC13XXX_RTCDAYA, days);\r\nif (unlikely(ret))\r\ngoto out;\r\nret = mc13xxx_reg_write(priv->mc13xxx, MC13XXX_RTCTODA, seconds);\r\nout:\r\nmc13xxx_unlock(priv->mc13xxx);\r\nreturn ret;\r\n}\r\nstatic irqreturn_t mc13xxx_rtc_alarm_handler(int irq, void *dev)\r\n{\r\nstruct mc13xxx_rtc *priv = dev;\r\nstruct mc13xxx *mc13xxx = priv->mc13xxx;\r\ndev_dbg(&priv->rtc->dev, "Alarm\n");\r\nrtc_update_irq(priv->rtc, 1, RTC_IRQF | RTC_AF);\r\nmc13xxx_irq_ack(mc13xxx, irq);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t mc13xxx_rtc_update_handler(int irq, void *dev)\r\n{\r\nstruct mc13xxx_rtc *priv = dev;\r\nstruct mc13xxx *mc13xxx = priv->mc13xxx;\r\ndev_dbg(&priv->rtc->dev, "1HZ\n");\r\nrtc_update_irq(priv->rtc, 1, RTC_IRQF | RTC_UF);\r\nmc13xxx_irq_ack(mc13xxx, irq);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int mc13xxx_rtc_alarm_irq_enable(struct device *dev,\r\nunsigned int enabled)\r\n{\r\nreturn mc13xxx_rtc_irq_enable(dev, enabled, MC13XXX_IRQ_TODA);\r\n}\r\nstatic irqreturn_t mc13xxx_rtc_reset_handler(int irq, void *dev)\r\n{\r\nstruct mc13xxx_rtc *priv = dev;\r\nstruct mc13xxx *mc13xxx = priv->mc13xxx;\r\ndev_dbg(&priv->rtc->dev, "RTCRST\n");\r\npriv->valid = 0;\r\nmc13xxx_irq_mask(mc13xxx, irq);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __devinit mc13xxx_rtc_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct mc13xxx_rtc *priv;\r\nstruct mc13xxx *mc13xxx;\r\nint rtcrst_pending;\r\npriv = kzalloc(sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nmc13xxx = dev_get_drvdata(pdev->dev.parent);\r\npriv->mc13xxx = mc13xxx;\r\nplatform_set_drvdata(pdev, priv);\r\nmc13xxx_lock(mc13xxx);\r\nret = mc13xxx_irq_request(mc13xxx, MC13XXX_IRQ_RTCRST,\r\nmc13xxx_rtc_reset_handler, DRIVER_NAME, priv);\r\nif (ret)\r\ngoto err_reset_irq_request;\r\nret = mc13xxx_irq_status(mc13xxx, MC13XXX_IRQ_RTCRST,\r\nNULL, &rtcrst_pending);\r\nif (ret)\r\ngoto err_reset_irq_status;\r\npriv->valid = !rtcrst_pending;\r\nret = mc13xxx_irq_request_nounmask(mc13xxx, MC13XXX_IRQ_1HZ,\r\nmc13xxx_rtc_update_handler, DRIVER_NAME, priv);\r\nif (ret)\r\ngoto err_update_irq_request;\r\nret = mc13xxx_irq_request_nounmask(mc13xxx, MC13XXX_IRQ_TODA,\r\nmc13xxx_rtc_alarm_handler, DRIVER_NAME, priv);\r\nif (ret)\r\ngoto err_alarm_irq_request;\r\nmc13xxx_unlock(mc13xxx);\r\npriv->rtc = rtc_device_register(pdev->name,\r\n&pdev->dev, &mc13xxx_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(priv->rtc)) {\r\nret = PTR_ERR(priv->rtc);\r\nmc13xxx_lock(mc13xxx);\r\nmc13xxx_irq_free(mc13xxx, MC13XXX_IRQ_TODA, priv);\r\nerr_alarm_irq_request:\r\nmc13xxx_irq_free(mc13xxx, MC13XXX_IRQ_1HZ, priv);\r\nerr_update_irq_request:\r\nerr_reset_irq_status:\r\nmc13xxx_irq_free(mc13xxx, MC13XXX_IRQ_RTCRST, priv);\r\nerr_reset_irq_request:\r\nmc13xxx_unlock(mc13xxx);\r\nplatform_set_drvdata(pdev, NULL);\r\nkfree(priv);\r\n}\r\nreturn ret;\r\n}\r\nstatic int __devexit mc13xxx_rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct mc13xxx_rtc *priv = platform_get_drvdata(pdev);\r\nmc13xxx_lock(priv->mc13xxx);\r\nrtc_device_unregister(priv->rtc);\r\nmc13xxx_irq_free(priv->mc13xxx, MC13XXX_IRQ_TODA, priv);\r\nmc13xxx_irq_free(priv->mc13xxx, MC13XXX_IRQ_1HZ, priv);\r\nmc13xxx_irq_free(priv->mc13xxx, MC13XXX_IRQ_RTCRST, priv);\r\nmc13xxx_unlock(priv->mc13xxx);\r\nplatform_set_drvdata(pdev, NULL);\r\nkfree(priv);\r\nreturn 0;\r\n}\r\nstatic int __init mc13xxx_rtc_init(void)\r\n{\r\nreturn platform_driver_probe(&mc13xxx_rtc_driver, &mc13xxx_rtc_probe);\r\n}\r\nstatic void __exit mc13xxx_rtc_exit(void)\r\n{\r\nplatform_driver_unregister(&mc13xxx_rtc_driver);\r\n}

static int ohci_omap3_init(struct usb_hcd *hcd)\r\n{\r\ndev_dbg(hcd->self.controller, "starting OHCI controller\n");\r\nreturn ohci_init(hcd_to_ohci(hcd));\r\n}\r\nstatic int ohci_omap3_start(struct usb_hcd *hcd)\r\n{\r\nstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\r\nint ret;\r\nohci->hc_control = OHCI_CTRL_RWC;\r\nwritel(OHCI_CTRL_RWC, &ohci->regs->control);\r\nret = ohci_run(ohci);\r\nif (ret < 0) {\r\ndev_err(hcd->self.controller, "can't start\n");\r\nohci_stop(hcd);\r\n}\r\nreturn ret;\r\n}\r\nstatic int __devinit ohci_hcd_omap3_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct usb_hcd *hcd = NULL;\r\nvoid __iomem *regs = NULL;\r\nstruct resource *res;\r\nint ret = -ENODEV;\r\nint irq;\r\nif (usb_disabled())\r\ngoto err_end;\r\nif (!dev->parent) {\r\ndev_err(dev, "Missing parent device\n");\r\nreturn -ENODEV;\r\n}\r\nirq = platform_get_irq_byname(pdev, "ohci-irq");\r\nif (irq < 0) {\r\ndev_err(dev, "OHCI irq failed\n");\r\nreturn -ENODEV;\r\n}\r\nres = platform_get_resource_byname(pdev,\r\nIORESOURCE_MEM, "ohci");\r\nif (!ret) {\r\ndev_err(dev, "UHH OHCI get resource failed\n");\r\nreturn -ENOMEM;\r\n}\r\nregs = ioremap(res->start, resource_size(res));\r\nif (!regs) {\r\ndev_err(dev, "UHH OHCI ioremap failed\n");\r\nreturn -ENOMEM;\r\n}\r\nhcd = usb_create_hcd(&ohci_omap3_hc_driver, dev,\r\ndev_name(dev));\r\nif (!hcd) {\r\ndev_err(dev, "usb_create_hcd failed\n");\r\ngoto err_io;\r\n}\r\nhcd->rsrc_start = res->start;\r\nhcd->rsrc_len = resource_size(res);\r\nhcd->regs = regs;\r\nret = omap_usbhs_enable(dev);\r\nif (ret) {\r\ndev_dbg(dev, "failed to start ohci\n");\r\ngoto err_end;\r\n}\r\nohci_hcd_init(hcd_to_ohci(hcd));\r\nret = usb_add_hcd(hcd, irq, IRQF_DISABLED);\r\nif (ret) {\r\ndev_dbg(dev, "failed to add hcd with err %d\n", ret);\r\ngoto err_add_hcd;\r\n}\r\nreturn 0;\r\nerr_add_hcd:\r\nomap_usbhs_disable(dev);\r\nerr_end:\r\nusb_put_hcd(hcd);\r\nerr_io:\r\niounmap(regs);\r\nreturn ret;\r\n}\r\nstatic int __devexit ohci_hcd_omap3_remove(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct usb_hcd *hcd = dev_get_drvdata(dev);\r\niounmap(hcd->regs);\r\nusb_remove_hcd(hcd);\r\nomap_usbhs_disable(dev);\r\nusb_put_hcd(hcd);\r\nreturn 0;\r\n}\r\nstatic void ohci_hcd_omap3_shutdown(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = dev_get_drvdata(&pdev->dev);\r\nif (hcd->driver->shutdown)\r\nhcd->driver->shutdown(hcd);\r\n}

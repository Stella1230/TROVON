static void kvmppc_emul_rfi(struct kvm_vcpu *vcpu)\r\n{\r\nvcpu->arch.pc = vcpu->arch.shared->srr0;\r\nkvmppc_set_msr(vcpu, vcpu->arch.shared->srr1);\r\n}\r\nint kvmppc_booke_emulate_op(struct kvm_run *run, struct kvm_vcpu *vcpu,\r\nunsigned int inst, int *advance)\r\n{\r\nint emulated = EMULATE_DONE;\r\nint rs;\r\nint rt;\r\nswitch (get_op(inst)) {\r\ncase 19:\r\nswitch (get_xop(inst)) {\r\ncase OP_19_XOP_RFI:\r\nkvmppc_emul_rfi(vcpu);\r\nkvmppc_set_exit_type(vcpu, EMULATED_RFI_EXITS);\r\n*advance = 0;\r\nbreak;\r\ndefault:\r\nemulated = EMULATE_FAIL;\r\nbreak;\r\n}\r\nbreak;\r\ncase 31:\r\nswitch (get_xop(inst)) {\r\ncase OP_31_XOP_MFMSR:\r\nrt = get_rt(inst);\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.shared->msr);\r\nkvmppc_set_exit_type(vcpu, EMULATED_MFMSR_EXITS);\r\nbreak;\r\ncase OP_31_XOP_MTMSR:\r\nrs = get_rs(inst);\r\nkvmppc_set_exit_type(vcpu, EMULATED_MTMSR_EXITS);\r\nkvmppc_set_msr(vcpu, kvmppc_get_gpr(vcpu, rs));\r\nbreak;\r\ncase OP_31_XOP_WRTEE:\r\nrs = get_rs(inst);\r\nvcpu->arch.shared->msr = (vcpu->arch.shared->msr & ~MSR_EE)\r\n| (kvmppc_get_gpr(vcpu, rs) & MSR_EE);\r\nkvmppc_set_exit_type(vcpu, EMULATED_WRTEE_EXITS);\r\nbreak;\r\ncase OP_31_XOP_WRTEEI:\r\nvcpu->arch.shared->msr = (vcpu->arch.shared->msr & ~MSR_EE)\r\n| (inst & MSR_EE);\r\nkvmppc_set_exit_type(vcpu, EMULATED_WRTEE_EXITS);\r\nbreak;\r\ndefault:\r\nemulated = EMULATE_FAIL;\r\n}\r\nbreak;\r\ndefault:\r\nemulated = EMULATE_FAIL;\r\n}\r\nreturn emulated;\r\n}\r\nint kvmppc_booke_emulate_mtspr(struct kvm_vcpu *vcpu, int sprn, int rs)\r\n{\r\nint emulated = EMULATE_DONE;\r\nulong spr_val = kvmppc_get_gpr(vcpu, rs);\r\nswitch (sprn) {\r\ncase SPRN_DEAR:\r\nvcpu->arch.shared->dar = spr_val; break;\r\ncase SPRN_ESR:\r\nvcpu->arch.esr = spr_val; break;\r\ncase SPRN_DBCR0:\r\nvcpu->arch.dbcr0 = spr_val; break;\r\ncase SPRN_DBCR1:\r\nvcpu->arch.dbcr1 = spr_val; break;\r\ncase SPRN_DBSR:\r\nvcpu->arch.dbsr &= ~spr_val; break;\r\ncase SPRN_TSR:\r\nvcpu->arch.tsr &= ~spr_val; break;\r\ncase SPRN_TCR:\r\nvcpu->arch.tcr = spr_val;\r\nkvmppc_emulate_dec(vcpu);\r\nbreak;\r\ncase SPRN_SPRG4:\r\nvcpu->arch.sprg4 = spr_val; break;\r\ncase SPRN_SPRG5:\r\nvcpu->arch.sprg5 = spr_val; break;\r\ncase SPRN_SPRG6:\r\nvcpu->arch.sprg6 = spr_val; break;\r\ncase SPRN_SPRG7:\r\nvcpu->arch.sprg7 = spr_val; break;\r\ncase SPRN_IVPR:\r\nvcpu->arch.ivpr = spr_val;\r\nbreak;\r\ncase SPRN_IVOR0:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_CRITICAL] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR1:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_MACHINE_CHECK] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR2:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_DATA_STORAGE] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR3:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_INST_STORAGE] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR4:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_EXTERNAL] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR5:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_ALIGNMENT] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR6:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_PROGRAM] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR7:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_FP_UNAVAIL] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR8:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_SYSCALL] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR9:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_AP_UNAVAIL] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR10:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_DECREMENTER] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR11:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_FIT] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR12:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_WATCHDOG] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR13:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_DTLB_MISS] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR14:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_ITLB_MISS] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR15:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_DEBUG] = spr_val;\r\nbreak;\r\ndefault:\r\nemulated = EMULATE_FAIL;\r\n}\r\nreturn emulated;\r\n}\r\nint kvmppc_booke_emulate_mfspr(struct kvm_vcpu *vcpu, int sprn, int rt)\r\n{\r\nint emulated = EMULATE_DONE;\r\nswitch (sprn) {\r\ncase SPRN_IVPR:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.ivpr); break;\r\ncase SPRN_DEAR:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.shared->dar); break;\r\ncase SPRN_ESR:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.esr); break;\r\ncase SPRN_DBCR0:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.dbcr0); break;\r\ncase SPRN_DBCR1:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.dbcr1); break;\r\ncase SPRN_DBSR:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.dbsr); break;\r\ncase SPRN_IVOR0:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.ivor[BOOKE_IRQPRIO_CRITICAL]);\r\nbreak;\r\ncase SPRN_IVOR1:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.ivor[BOOKE_IRQPRIO_MACHINE_CHECK]);\r\nbreak;\r\ncase SPRN_IVOR2:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.ivor[BOOKE_IRQPRIO_DATA_STORAGE]);\r\nbreak;\r\ncase SPRN_IVOR3:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.ivor[BOOKE_IRQPRIO_INST_STORAGE]);\r\nbreak;\r\ncase SPRN_IVOR4:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.ivor[BOOKE_IRQPRIO_EXTERNAL]);\r\nbreak;\r\ncase SPRN_IVOR5:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.ivor[BOOKE_IRQPRIO_ALIGNMENT]);\r\nbreak;\r\ncase SPRN_IVOR6:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.ivor[BOOKE_IRQPRIO_PROGRAM]);\r\nbreak;\r\ncase SPRN_IVOR7:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.ivor[BOOKE_IRQPRIO_FP_UNAVAIL]);\r\nbreak;\r\ncase SPRN_IVOR8:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.ivor[BOOKE_IRQPRIO_SYSCALL]);\r\nbreak;\r\ncase SPRN_IVOR9:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.ivor[BOOKE_IRQPRIO_AP_UNAVAIL]);\r\nbreak;\r\ncase SPRN_IVOR10:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.ivor[BOOKE_IRQPRIO_DECREMENTER]);\r\nbreak;\r\ncase SPRN_IVOR11:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.ivor[BOOKE_IRQPRIO_FIT]);\r\nbreak;\r\ncase SPRN_IVOR12:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.ivor[BOOKE_IRQPRIO_WATCHDOG]);\r\nbreak;\r\ncase SPRN_IVOR13:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.ivor[BOOKE_IRQPRIO_DTLB_MISS]);\r\nbreak;\r\ncase SPRN_IVOR14:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.ivor[BOOKE_IRQPRIO_ITLB_MISS]);\r\nbreak;\r\ncase SPRN_IVOR15:\r\nkvmppc_set_gpr(vcpu, rt, vcpu->arch.ivor[BOOKE_IRQPRIO_DEBUG]);\r\nbreak;\r\ndefault:\r\nemulated = EMULATE_FAIL;\r\n}\r\nreturn emulated;\r\n}

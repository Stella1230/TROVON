static struct bio *get_swap_bio(gfp_t gfp_flags,\r\nstruct page *page, bio_end_io_t end_io)\r\n{\r\nstruct bio *bio;\r\nbio = bio_alloc(gfp_flags, 1);\r\nif (bio) {\r\nbio->bi_sector = map_swap_page(page, &bio->bi_bdev);\r\nbio->bi_sector <<= PAGE_SHIFT - 9;\r\nbio->bi_io_vec[0].bv_page = page;\r\nbio->bi_io_vec[0].bv_len = PAGE_SIZE;\r\nbio->bi_io_vec[0].bv_offset = 0;\r\nbio->bi_vcnt = 1;\r\nbio->bi_idx = 0;\r\nbio->bi_size = PAGE_SIZE;\r\nbio->bi_end_io = end_io;\r\n}\r\nreturn bio;\r\n}\r\nstatic void end_swap_bio_write(struct bio *bio, int err)\r\n{\r\nconst int uptodate = test_bit(BIO_UPTODATE, &bio->bi_flags);\r\nstruct page *page = bio->bi_io_vec[0].bv_page;\r\nif (!uptodate) {\r\nSetPageError(page);\r\nset_page_dirty(page);\r\nprintk(KERN_ALERT "Write-error on swap-device (%u:%u:%Lu)\n",\r\nimajor(bio->bi_bdev->bd_inode),\r\niminor(bio->bi_bdev->bd_inode),\r\n(unsigned long long)bio->bi_sector);\r\nClearPageReclaim(page);\r\n}\r\nend_page_writeback(page);\r\nbio_put(bio);\r\n}\r\nvoid end_swap_bio_read(struct bio *bio, int err)\r\n{\r\nconst int uptodate = test_bit(BIO_UPTODATE, &bio->bi_flags);\r\nstruct page *page = bio->bi_io_vec[0].bv_page;\r\nif (!uptodate) {\r\nSetPageError(page);\r\nClearPageUptodate(page);\r\nprintk(KERN_ALERT "Read-error on swap-device (%u:%u:%Lu)\n",\r\nimajor(bio->bi_bdev->bd_inode),\r\niminor(bio->bi_bdev->bd_inode),\r\n(unsigned long long)bio->bi_sector);\r\n} else {\r\nSetPageUptodate(page);\r\n}\r\nunlock_page(page);\r\nbio_put(bio);\r\n}\r\nint swap_writepage(struct page *page, struct writeback_control *wbc)\r\n{\r\nstruct bio *bio;\r\nint ret = 0, rw = WRITE;\r\nif (try_to_free_swap(page)) {\r\nunlock_page(page);\r\ngoto out;\r\n}\r\nbio = get_swap_bio(GFP_NOIO, page, end_swap_bio_write);\r\nif (bio == NULL) {\r\nset_page_dirty(page);\r\nunlock_page(page);\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nif (wbc->sync_mode == WB_SYNC_ALL)\r\nrw |= REQ_SYNC;\r\ncount_vm_event(PSWPOUT);\r\nset_page_writeback(page);\r\nunlock_page(page);\r\nsubmit_bio(rw, bio);\r\nout:\r\nreturn ret;\r\n}\r\nint swap_readpage(struct page *page)\r\n{\r\nstruct bio *bio;\r\nint ret = 0;\r\nVM_BUG_ON(!PageLocked(page));\r\nVM_BUG_ON(PageUptodate(page));\r\nbio = get_swap_bio(GFP_KERNEL, page, end_swap_bio_read);\r\nif (bio == NULL) {\r\nunlock_page(page);\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\ncount_vm_event(PSWPIN);\r\nsubmit_bio(READ, bio);\r\nout:\r\nreturn ret;\r\n}

static irqreturn_t sh7780_pci_err_irq(int irq, void *dev_id)\r\n{\r\nstruct pci_channel *hose = dev_id;\r\nunsigned long addr;\r\nunsigned int status;\r\nunsigned int cmd;\r\nint i;\r\naddr = __raw_readl(hose->reg_base + SH4_PCIALR);\r\nstatus = __raw_readw(hose->reg_base + PCI_STATUS);\r\nif (status & (PCI_STATUS_PARITY |\r\nPCI_STATUS_DETECTED_PARITY |\r\nPCI_STATUS_SIG_TARGET_ABORT |\r\nPCI_STATUS_REC_TARGET_ABORT |\r\nPCI_STATUS_REC_MASTER_ABORT)) {\r\ncmd = pcibios_handle_status_errors(addr, status, hose);\r\nif (likely(cmd))\r\n__raw_writew(cmd, hose->reg_base + PCI_STATUS);\r\n}\r\nstatus = __raw_readl(hose->reg_base + SH4_PCIAINT);\r\nfor (i = cmd = 0; i < ARRAY_SIZE(pci_arbiter_errors); i++) {\r\nif (status & pci_arbiter_errors[i].mask) {\r\nprintk(KERN_DEBUG "PCI: %s, addr=%08lx\n",\r\npci_arbiter_errors[i].str, addr);\r\ncmd |= pci_arbiter_errors[i].mask;\r\n}\r\n}\r\n__raw_writel(cmd, hose->reg_base + SH4_PCIAINT);\r\nstatus = __raw_readl(hose->reg_base + SH4_PCIINT);\r\nfor (i = cmd = 0; i < ARRAY_SIZE(pci_interrupt_errors); i++) {\r\nif (status & pci_interrupt_errors[i].mask) {\r\nprintk(KERN_DEBUG "PCI: %s, addr=%08lx\n",\r\npci_interrupt_errors[i].str, addr);\r\ncmd |= pci_interrupt_errors[i].mask;\r\n}\r\n}\r\n__raw_writel(cmd, hose->reg_base + SH4_PCIINT);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t sh7780_pci_serr_irq(int irq, void *dev_id)\r\n{\r\nstruct pci_channel *hose = dev_id;\r\nprintk(KERN_DEBUG "PCI: system error received: ");\r\npcibios_report_status(PCI_STATUS_SIG_SYSTEM_ERROR, 1);\r\nprintk("\n");\r\n__raw_writel(SH4_PCIINTM_SDIM, hose->reg_base + SH4_PCIINTM);\r\ndisable_irq_nosync(irq);\r\nhose->serr_timer.expires = jiffies + HZ;\r\nadd_timer(&hose->serr_timer);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __init sh7780_pci_setup_irqs(struct pci_channel *hose)\r\n{\r\nint ret;\r\n__raw_writel(0, hose->reg_base + SH4_PCIAINT);\r\n__raw_writew(PCI_STATUS_DETECTED_PARITY | \\r\nPCI_STATUS_SIG_SYSTEM_ERROR | \\r\nPCI_STATUS_REC_MASTER_ABORT | \\r\nPCI_STATUS_REC_TARGET_ABORT | \\r\nPCI_STATUS_SIG_TARGET_ABORT | \\r\nPCI_STATUS_PARITY, hose->reg_base + PCI_STATUS);\r\nret = request_irq(hose->serr_irq, sh7780_pci_serr_irq, IRQF_DISABLED,\r\n"PCI SERR interrupt", hose);\r\nif (unlikely(ret)) {\r\nprintk(KERN_ERR "PCI: Failed hooking SERR IRQ\n");\r\nreturn ret;\r\n}\r\nret = request_irq(hose->err_irq, sh7780_pci_err_irq, IRQF_SHARED,\r\n"PCI ERR interrupt", hose);\r\nif (unlikely(ret)) {\r\nfree_irq(hose->serr_irq, hose);\r\nreturn ret;\r\n}\r\n__raw_writel(SH4_PCIAINT_MBKN | SH4_PCIAINT_TBTO | SH4_PCIAINT_MBTO | \\r\nSH4_PCIAINT_TABT | SH4_PCIAINT_MABT | SH4_PCIAINT_RDPE | \\r\nSH4_PCIAINT_WDPE, hose->reg_base + SH4_PCIAINTM);\r\n__raw_writel(SH4_PCIINTM_TTADIM | SH4_PCIINTM_TMTOIM | \\r\nSH4_PCIINTM_MDEIM | SH4_PCIINTM_APEDIM | \\r\nSH4_PCIINTM_SDIM | SH4_PCIINTM_DPEITWM | \\r\nSH4_PCIINTM_PEDITRM | SH4_PCIINTM_TADIMM | \\r\nSH4_PCIINTM_MADIMM | SH4_PCIINTM_MWPDIM | \\r\nSH4_PCIINTM_MRDPEIM, hose->reg_base + SH4_PCIINTM);\r\nreturn ret;\r\n}\r\nstatic inline void __init sh7780_pci_teardown_irqs(struct pci_channel *hose)\r\n{\r\nfree_irq(hose->err_irq, hose);\r\nfree_irq(hose->serr_irq, hose);\r\n}\r\nstatic void __init sh7780_pci66_init(struct pci_channel *hose)\r\n{\r\nunsigned int tmp;\r\nif (!pci_is_66mhz_capable(hose, 0, 0))\r\nreturn;\r\ntmp = __raw_readl(hose->reg_base + SH4_PCICR);\r\ntmp |= SH4_PCICR_PREFIX;\r\n__raw_writel(tmp, hose->reg_base + SH4_PCICR);\r\ntmp = __raw_readw(hose->reg_base + PCI_STATUS);\r\ntmp |= PCI_STATUS_66MHZ;\r\n__raw_writew(tmp, hose->reg_base + PCI_STATUS);\r\ntmp = __raw_readl(hose->reg_base + SH4_PCICR);\r\ntmp |= SH4_PCICR_PREFIX | SH4_PCICR_CFIN;\r\n__raw_writel(tmp, hose->reg_base + SH4_PCICR);\r\n}\r\nstatic int __init sh7780_pci_init(void)\r\n{\r\nstruct pci_channel *chan = &sh7780_pci_controller;\r\nphys_addr_t memphys;\r\nsize_t memsize;\r\nunsigned int id;\r\nconst char *type;\r\nint ret, i;\r\nprintk(KERN_NOTICE "PCI: Starting initialization.\n");\r\nchan->reg_base = 0xfe040000;\r\n__raw_writel(PCIECR_ENBL, PCIECR);\r\n__raw_writel(SH4_PCICR_PREFIX | SH4_PCICR_PRST,\r\nchan->reg_base + SH4_PCICR);\r\nmdelay(100);\r\nid = __raw_readw(chan->reg_base + PCI_VENDOR_ID);\r\nif (id != PCI_VENDOR_ID_RENESAS) {\r\nprintk(KERN_ERR "PCI: Unknown vendor ID 0x%04x.\n", id);\r\nreturn -ENODEV;\r\n}\r\nid = __raw_readw(chan->reg_base + PCI_DEVICE_ID);\r\ntype = (id == PCI_DEVICE_ID_RENESAS_SH7763) ? "SH7763" :\r\n(id == PCI_DEVICE_ID_RENESAS_SH7780) ? "SH7780" :\r\n(id == PCI_DEVICE_ID_RENESAS_SH7781) ? "SH7781" :\r\n(id == PCI_DEVICE_ID_RENESAS_SH7785) ? "SH7785" :\r\nNULL;\r\nif (unlikely(!type)) {\r\nprintk(KERN_ERR "PCI: Found an unsupported Renesas host "\r\n"controller, device id 0x%04x.\n", id);\r\nreturn -EINVAL;\r\n}\r\nprintk(KERN_NOTICE "PCI: Found a Renesas %s host "\r\n"controller, revision %d.\n", type,\r\n__raw_readb(chan->reg_base + PCI_REVISION_ID));\r\n__raw_writel(SH4_PCICR_PREFIX, chan->reg_base + SH4_PCICR);\r\nmemphys = __pa(memory_start);\r\nmemsize = roundup_pow_of_two(memory_end - memory_start);\r\nif (memsize > SZ_512M) {\r\n__raw_writel(memphys + SZ_512M, chan->reg_base + SH4_PCILAR1);\r\n__raw_writel((((memsize - SZ_512M) - SZ_1M) & 0x1ff00000) | 1,\r\nchan->reg_base + SH4_PCILSR1);\r\nmemsize = SZ_512M;\r\n} else {\r\n__raw_writel(0, chan->reg_base + SH4_PCILAR1);\r\n__raw_writel(0, chan->reg_base + SH4_PCILSR1);\r\n}\r\n__raw_writel(memphys, chan->reg_base + SH4_PCILAR0);\r\n__raw_writel(((memsize - SZ_1M) & 0x1ff00000) | 1,\r\nchan->reg_base + SH4_PCILSR0);\r\nret = sh7780_pci_setup_irqs(chan);\r\nif (unlikely(ret))\r\nreturn ret;\r\n__raw_writel(0, chan->reg_base + SH7780_PCICSCR0);\r\n__raw_writel(0, chan->reg_base + SH7780_PCICSAR0);\r\n__raw_writel(0, chan->reg_base + SH7780_PCICSCR1);\r\n__raw_writel(0, chan->reg_base + SH7780_PCICSAR1);\r\nfor (i = 1; i < chan->nr_resources; i++) {\r\nstruct resource *res = chan->resources + i;\r\nresource_size_t size;\r\nif (unlikely(res->flags & IORESOURCE_IO))\r\ncontinue;\r\nif ((res->flags & IORESOURCE_MEM_32BIT) && __in_29bit_mode()) {\r\nchan->nr_resources--;\r\ncontinue;\r\n}\r\nsize = resource_size(res);\r\n__raw_writel(((roundup_pow_of_two(size) / SZ_256K) - 1) << 18,\r\nchan->reg_base + SH7780_PCIMBMR(i - 1));\r\n__raw_writel(res->start, chan->reg_base + SH7780_PCIMBR(i - 1));\r\n}\r\n__raw_writel(0, chan->reg_base + PCI_BASE_ADDRESS_0);\r\n__raw_writel(0, chan->reg_base + SH7780_PCIIOBR);\r\n__raw_writel(0, chan->reg_base + SH7780_PCIIOBMR);\r\n__raw_writew(PCI_COMMAND_SERR | PCI_COMMAND_WAIT | \\r\nPCI_COMMAND_PARITY | PCI_COMMAND_MASTER | \\r\nPCI_COMMAND_MEMORY, chan->reg_base + PCI_COMMAND);\r\n__raw_writel(SH4_PCICR_PREFIX | SH4_PCICR_CFIN | SH4_PCICR_FTO,\r\nchan->reg_base + SH4_PCICR);\r\nret = register_pci_controller(chan);\r\nif (unlikely(ret))\r\ngoto err;\r\nsh7780_pci66_init(chan);\r\nprintk(KERN_NOTICE "PCI: Running at %dMHz.\n",\r\n(__raw_readw(chan->reg_base + PCI_STATUS) & PCI_STATUS_66MHZ) ?\r\n66 : 33);\r\nreturn 0;\r\nerr:\r\nsh7780_pci_teardown_irqs(chan);\r\nreturn ret;\r\n}

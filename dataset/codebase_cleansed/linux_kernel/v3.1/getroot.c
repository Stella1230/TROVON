static int nfs_superblock_set_dummy_root(struct super_block *sb, struct inode *inode)\r\n{\r\nif (sb->s_root == NULL) {\r\nsb->s_root = d_alloc_root(inode);\r\nif (sb->s_root == NULL) {\r\niput(inode);\r\nreturn -ENOMEM;\r\n}\r\nihold(inode);\r\nspin_lock(&sb->s_root->d_inode->i_lock);\r\nspin_lock(&sb->s_root->d_lock);\r\nlist_del_init(&sb->s_root->d_alias);\r\nspin_unlock(&sb->s_root->d_lock);\r\nspin_unlock(&sb->s_root->d_inode->i_lock);\r\n}\r\nreturn 0;\r\n}\r\nstruct dentry *nfs_get_root(struct super_block *sb, struct nfs_fh *mntfh,\r\nconst char *devname)\r\n{\r\nstruct nfs_server *server = NFS_SB(sb);\r\nstruct nfs_fsinfo fsinfo;\r\nstruct dentry *ret;\r\nstruct inode *inode;\r\nvoid *name = kstrdup(devname, GFP_KERNEL);\r\nint error;\r\nif (!name)\r\nreturn ERR_PTR(-ENOMEM);\r\nfsinfo.fattr = nfs_alloc_fattr();\r\nif (fsinfo.fattr == NULL) {\r\nkfree(name);\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nerror = server->nfs_client->rpc_ops->getroot(server, mntfh, &fsinfo);\r\nif (error < 0) {\r\ndprintk("nfs_get_root: getattr error = %d\n", -error);\r\nret = ERR_PTR(error);\r\ngoto out;\r\n}\r\ninode = nfs_fhget(sb, mntfh, fsinfo.fattr);\r\nif (IS_ERR(inode)) {\r\ndprintk("nfs_get_root: get root inode failed\n");\r\nret = ERR_CAST(inode);\r\ngoto out;\r\n}\r\nerror = nfs_superblock_set_dummy_root(sb, inode);\r\nif (error != 0) {\r\nret = ERR_PTR(error);\r\ngoto out;\r\n}\r\nret = d_obtain_alias(inode);\r\nif (IS_ERR(ret)) {\r\ndprintk("nfs_get_root: get root dentry failed\n");\r\ngoto out;\r\n}\r\nsecurity_d_instantiate(ret, inode);\r\nspin_lock(&ret->d_lock);\r\nif (IS_ROOT(ret) && !(ret->d_flags & DCACHE_NFSFS_RENAMED)) {\r\nret->d_fsdata = name;\r\nname = NULL;\r\n}\r\nspin_unlock(&ret->d_lock);\r\nout:\r\nif (name)\r\nkfree(name);\r\nnfs_free_fattr(fsinfo.fattr);\r\nreturn ret;\r\n}\r\nint nfs4_get_rootfh(struct nfs_server *server, struct nfs_fh *mntfh)\r\n{\r\nstruct nfs_fsinfo fsinfo;\r\nint ret = -ENOMEM;\r\ndprintk("--> nfs4_get_rootfh()\n");\r\nfsinfo.fattr = nfs_alloc_fattr();\r\nif (fsinfo.fattr == NULL)\r\ngoto out;\r\nret = server->nfs_client->rpc_ops->getroot(server, mntfh, &fsinfo);\r\nif (ret < 0) {\r\ndprintk("nfs4_get_rootfh: getroot error = %d\n", -ret);\r\ngoto out;\r\n}\r\nif (!(fsinfo.fattr->valid & NFS_ATTR_FATTR_TYPE)\r\n|| !S_ISDIR(fsinfo.fattr->mode)) {\r\nprintk(KERN_ERR "nfs4_get_rootfh:"\r\n" getroot encountered non-directory\n");\r\nret = -ENOTDIR;\r\ngoto out;\r\n}\r\nif (fsinfo.fattr->valid & NFS_ATTR_FATTR_V4_REFERRAL) {\r\nprintk(KERN_ERR "nfs4_get_rootfh:"\r\n" getroot obtained referral\n");\r\nret = -EREMOTE;\r\ngoto out;\r\n}\r\nmemcpy(&server->fsid, &fsinfo.fattr->fsid, sizeof(server->fsid));\r\nout:\r\nnfs_free_fattr(fsinfo.fattr);\r\ndprintk("<-- nfs4_get_rootfh() = %d\n", ret);\r\nreturn ret;\r\n}\r\nstruct dentry *nfs4_get_root(struct super_block *sb, struct nfs_fh *mntfh,\r\nconst char *devname)\r\n{\r\nstruct nfs_server *server = NFS_SB(sb);\r\nstruct nfs_fattr *fattr = NULL;\r\nstruct dentry *ret;\r\nstruct inode *inode;\r\nvoid *name = kstrdup(devname, GFP_KERNEL);\r\nint error;\r\ndprintk("--> nfs4_get_root()\n");\r\nif (!name)\r\nreturn ERR_PTR(-ENOMEM);\r\nerror = nfs4_server_capabilities(server, mntfh);\r\nif (error < 0) {\r\ndprintk("nfs_get_root: getcaps error = %d\n",\r\n-error);\r\nkfree(name);\r\nreturn ERR_PTR(error);\r\n}\r\nfattr = nfs_alloc_fattr();\r\nif (fattr == NULL) {\r\nkfree(name);\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nerror = server->nfs_client->rpc_ops->getattr(server, mntfh, fattr);\r\nif (error < 0) {\r\ndprintk("nfs_get_root: getattr error = %d\n", -error);\r\nret = ERR_PTR(error);\r\ngoto out;\r\n}\r\nif (fattr->valid & NFS_ATTR_FATTR_FSID &&\r\n!nfs_fsid_equal(&server->fsid, &fattr->fsid))\r\nmemcpy(&server->fsid, &fattr->fsid, sizeof(server->fsid));\r\ninode = nfs_fhget(sb, mntfh, fattr);\r\nif (IS_ERR(inode)) {\r\ndprintk("nfs_get_root: get root inode failed\n");\r\nret = ERR_CAST(inode);\r\ngoto out;\r\n}\r\nerror = nfs_superblock_set_dummy_root(sb, inode);\r\nif (error != 0) {\r\nret = ERR_PTR(error);\r\ngoto out;\r\n}\r\nret = d_obtain_alias(inode);\r\nif (IS_ERR(ret)) {\r\ndprintk("nfs_get_root: get root dentry failed\n");\r\ngoto out;\r\n}\r\nsecurity_d_instantiate(ret, inode);\r\nspin_lock(&ret->d_lock);\r\nif (IS_ROOT(ret) && !(ret->d_flags & DCACHE_NFSFS_RENAMED)) {\r\nret->d_fsdata = name;\r\nname = NULL;\r\n}\r\nspin_unlock(&ret->d_lock);\r\nout:\r\nif (name)\r\nkfree(name);\r\nnfs_free_fattr(fattr);\r\ndprintk("<-- nfs4_get_root()\n");\r\nreturn ret;\r\n}

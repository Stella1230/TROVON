static int sh_clk_mstp32_enable(struct clk *clk)\r\n{\r\n__raw_writel(__raw_readl(clk->enable_reg) & ~(1 << clk->enable_bit),\r\nclk->enable_reg);\r\nreturn 0;\r\n}\r\nstatic void sh_clk_mstp32_disable(struct clk *clk)\r\n{\r\n__raw_writel(__raw_readl(clk->enable_reg) | (1 << clk->enable_bit),\r\nclk->enable_reg);\r\n}\r\nint __init sh_clk_mstp32_register(struct clk *clks, int nr)\r\n{\r\nstruct clk *clkp;\r\nint ret = 0;\r\nint k;\r\nfor (k = 0; !ret && (k < nr); k++) {\r\nclkp = clks + k;\r\nclkp->ops = &sh_clk_mstp32_clk_ops;\r\nret |= clk_register(clkp);\r\n}\r\nreturn ret;\r\n}\r\nstatic long sh_clk_div_round_rate(struct clk *clk, unsigned long rate)\r\n{\r\nreturn clk_rate_table_round(clk, clk->freq_table, rate);\r\n}\r\nstatic unsigned long sh_clk_div6_recalc(struct clk *clk)\r\n{\r\nstruct clk_div_mult_table *table = &sh_clk_div6_table;\r\nunsigned int idx;\r\nclk_rate_table_build(clk, clk->freq_table, table->nr_divisors,\r\ntable, NULL);\r\nidx = __raw_readl(clk->enable_reg) & 0x003f;\r\nreturn clk->freq_table[idx].frequency;\r\n}\r\nstatic int sh_clk_div6_set_parent(struct clk *clk, struct clk *parent)\r\n{\r\nstruct clk_div_mult_table *table = &sh_clk_div6_table;\r\nu32 value;\r\nint ret, i;\r\nif (!clk->parent_table || !clk->parent_num)\r\nreturn -EINVAL;\r\nfor (i = 0; i < clk->parent_num; i++)\r\nif (clk->parent_table[i] == parent)\r\nbreak;\r\nif (i == clk->parent_num)\r\nreturn -ENODEV;\r\nret = clk_reparent(clk, parent);\r\nif (ret < 0)\r\nreturn ret;\r\nvalue = __raw_readl(clk->enable_reg) &\r\n~(((1 << clk->src_width) - 1) << clk->src_shift);\r\n__raw_writel(value | (i << clk->src_shift), clk->enable_reg);\r\nclk_rate_table_build(clk, clk->freq_table, table->nr_divisors,\r\ntable, NULL);\r\nreturn 0;\r\n}\r\nstatic int sh_clk_div6_set_rate(struct clk *clk, unsigned long rate)\r\n{\r\nunsigned long value;\r\nint idx;\r\nidx = clk_rate_table_find(clk, clk->freq_table, rate);\r\nif (idx < 0)\r\nreturn idx;\r\nvalue = __raw_readl(clk->enable_reg);\r\nvalue &= ~0x3f;\r\nvalue |= idx;\r\n__raw_writel(value, clk->enable_reg);\r\nreturn 0;\r\n}\r\nstatic int sh_clk_div6_enable(struct clk *clk)\r\n{\r\nunsigned long value;\r\nint ret;\r\nret = sh_clk_div6_set_rate(clk, clk->rate);\r\nif (ret == 0) {\r\nvalue = __raw_readl(clk->enable_reg);\r\nvalue &= ~0x100;\r\n__raw_writel(value, clk->enable_reg);\r\n}\r\nreturn ret;\r\n}\r\nstatic void sh_clk_div6_disable(struct clk *clk)\r\n{\r\nunsigned long value;\r\nvalue = __raw_readl(clk->enable_reg);\r\nvalue |= 0x100;\r\nvalue |= 0x3f;\r\n__raw_writel(value, clk->enable_reg);\r\n}\r\nstatic int __init sh_clk_div6_register_ops(struct clk *clks, int nr,\r\nstruct clk_ops *ops)\r\n{\r\nstruct clk *clkp;\r\nvoid *freq_table;\r\nint nr_divs = sh_clk_div6_table.nr_divisors;\r\nint freq_table_size = sizeof(struct cpufreq_frequency_table);\r\nint ret = 0;\r\nint k;\r\nfreq_table_size *= (nr_divs + 1);\r\nfreq_table = kzalloc(freq_table_size * nr, GFP_KERNEL);\r\nif (!freq_table) {\r\npr_err("sh_clk_div6_register: unable to alloc memory\n");\r\nreturn -ENOMEM;\r\n}\r\nfor (k = 0; !ret && (k < nr); k++) {\r\nclkp = clks + k;\r\nclkp->ops = ops;\r\nclkp->freq_table = freq_table + (k * freq_table_size);\r\nclkp->freq_table[nr_divs].frequency = CPUFREQ_TABLE_END;\r\nret = clk_register(clkp);\r\n}\r\nreturn ret;\r\n}\r\nint __init sh_clk_div6_register(struct clk *clks, int nr)\r\n{\r\nreturn sh_clk_div6_register_ops(clks, nr, &sh_clk_div6_clk_ops);\r\n}\r\nint __init sh_clk_div6_reparent_register(struct clk *clks, int nr)\r\n{\r\nreturn sh_clk_div6_register_ops(clks, nr,\r\n&sh_clk_div6_reparent_clk_ops);\r\n}\r\nstatic unsigned long sh_clk_div4_recalc(struct clk *clk)\r\n{\r\nstruct clk_div4_table *d4t = clk->priv;\r\nstruct clk_div_mult_table *table = d4t->div_mult_table;\r\nunsigned int idx;\r\nclk_rate_table_build(clk, clk->freq_table, table->nr_divisors,\r\ntable, &clk->arch_flags);\r\nidx = (__raw_readl(clk->enable_reg) >> clk->enable_bit) & 0x000f;\r\nreturn clk->freq_table[idx].frequency;\r\n}\r\nstatic int sh_clk_div4_set_parent(struct clk *clk, struct clk *parent)\r\n{\r\nstruct clk_div4_table *d4t = clk->priv;\r\nstruct clk_div_mult_table *table = d4t->div_mult_table;\r\nu32 value;\r\nint ret;\r\nif (parent->flags & CLK_ENABLE_ON_INIT)\r\nvalue = __raw_readl(clk->enable_reg) & ~(1 << 7);\r\nelse\r\nvalue = __raw_readl(clk->enable_reg) | (1 << 7);\r\nret = clk_reparent(clk, parent);\r\nif (ret < 0)\r\nreturn ret;\r\n__raw_writel(value, clk->enable_reg);\r\nclk_rate_table_build(clk, clk->freq_table, table->nr_divisors,\r\ntable, &clk->arch_flags);\r\nreturn 0;\r\n}\r\nstatic int sh_clk_div4_set_rate(struct clk *clk, unsigned long rate)\r\n{\r\nstruct clk_div4_table *d4t = clk->priv;\r\nunsigned long value;\r\nint idx = clk_rate_table_find(clk, clk->freq_table, rate);\r\nif (idx < 0)\r\nreturn idx;\r\nvalue = __raw_readl(clk->enable_reg);\r\nvalue &= ~(0xf << clk->enable_bit);\r\nvalue |= (idx << clk->enable_bit);\r\n__raw_writel(value, clk->enable_reg);\r\nif (d4t->kick)\r\nd4t->kick(clk);\r\nreturn 0;\r\n}\r\nstatic int sh_clk_div4_enable(struct clk *clk)\r\n{\r\n__raw_writel(__raw_readl(clk->enable_reg) & ~(1 << 8), clk->enable_reg);\r\nreturn 0;\r\n}\r\nstatic void sh_clk_div4_disable(struct clk *clk)\r\n{\r\n__raw_writel(__raw_readl(clk->enable_reg) | (1 << 8), clk->enable_reg);\r\n}\r\nstatic int __init sh_clk_div4_register_ops(struct clk *clks, int nr,\r\nstruct clk_div4_table *table, struct clk_ops *ops)\r\n{\r\nstruct clk *clkp;\r\nvoid *freq_table;\r\nint nr_divs = table->div_mult_table->nr_divisors;\r\nint freq_table_size = sizeof(struct cpufreq_frequency_table);\r\nint ret = 0;\r\nint k;\r\nfreq_table_size *= (nr_divs + 1);\r\nfreq_table = kzalloc(freq_table_size * nr, GFP_KERNEL);\r\nif (!freq_table) {\r\npr_err("sh_clk_div4_register: unable to alloc memory\n");\r\nreturn -ENOMEM;\r\n}\r\nfor (k = 0; !ret && (k < nr); k++) {\r\nclkp = clks + k;\r\nclkp->ops = ops;\r\nclkp->priv = table;\r\nclkp->freq_table = freq_table + (k * freq_table_size);\r\nclkp->freq_table[nr_divs].frequency = CPUFREQ_TABLE_END;\r\nret = clk_register(clkp);\r\n}\r\nreturn ret;\r\n}\r\nint __init sh_clk_div4_register(struct clk *clks, int nr,\r\nstruct clk_div4_table *table)\r\n{\r\nreturn sh_clk_div4_register_ops(clks, nr, table, &sh_clk_div4_clk_ops);\r\n}\r\nint __init sh_clk_div4_enable_register(struct clk *clks, int nr,\r\nstruct clk_div4_table *table)\r\n{\r\nreturn sh_clk_div4_register_ops(clks, nr, table,\r\n&sh_clk_div4_enable_clk_ops);\r\n}\r\nint __init sh_clk_div4_reparent_register(struct clk *clks, int nr,\r\nstruct clk_div4_table *table)\r\n{\r\nreturn sh_clk_div4_register_ops(clks, nr, table,\r\n&sh_clk_div4_reparent_clk_ops);\r\n}

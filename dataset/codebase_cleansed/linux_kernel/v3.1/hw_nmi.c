u64 hw_nmi_get_sample_period(int watchdog_thresh)\r\n{\r\nreturn (u64)(cpu_khz) * 1000 * watchdog_thresh;\r\n}\r\nvoid arch_trigger_all_cpu_backtrace(void)\r\n{\r\nint i;\r\nif (test_and_set_bit(0, &backtrace_flag))\r\nreturn;\r\ncpumask_copy(to_cpumask(backtrace_mask), cpu_online_mask);\r\nprintk(KERN_INFO "sending NMI to all CPUs:\n");\r\napic->send_IPI_all(NMI_VECTOR);\r\nfor (i = 0; i < 10 * 1000; i++) {\r\nif (cpumask_empty(to_cpumask(backtrace_mask)))\r\nbreak;\r\nmdelay(1);\r\n}\r\nclear_bit(0, &backtrace_flag);\r\nsmp_mb__after_clear_bit();\r\n}\r\nstatic int __kprobes\r\narch_trigger_all_cpu_backtrace_handler(struct notifier_block *self,\r\nunsigned long cmd, void *__args)\r\n{\r\nstruct die_args *args = __args;\r\nstruct pt_regs *regs;\r\nint cpu;\r\nswitch (cmd) {\r\ncase DIE_NMI:\r\nbreak;\r\ndefault:\r\nreturn NOTIFY_DONE;\r\n}\r\nregs = args->regs;\r\ncpu = smp_processor_id();\r\nif (cpumask_test_cpu(cpu, to_cpumask(backtrace_mask))) {\r\nstatic arch_spinlock_t lock = __ARCH_SPIN_LOCK_UNLOCKED;\r\narch_spin_lock(&lock);\r\nprintk(KERN_WARNING "NMI backtrace for cpu %d\n", cpu);\r\nshow_regs(regs);\r\narch_spin_unlock(&lock);\r\ncpumask_clear_cpu(cpu, to_cpumask(backtrace_mask));\r\nreturn NOTIFY_STOP;\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int __init register_trigger_all_cpu_backtrace(void)\r\n{\r\nregister_die_notifier(&backtrace_notifier);\r\nreturn 0;\r\n}

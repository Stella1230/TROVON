bss_t *\r\nwlan_node_alloc(struct ieee80211_node_table *nt, int wh_size)\r\n{\r\nbss_t *ni;\r\nni = A_MALLOC_NOWAIT(sizeof(bss_t));\r\nif (ni != NULL) {\r\nif (wh_size)\r\n{\r\nni->ni_buf = A_MALLOC_NOWAIT(wh_size);\r\nif (ni->ni_buf == NULL) {\r\nkfree(ni);\r\nni = NULL;\r\nreturn ni;\r\n}\r\n}\r\n} else {\r\nreturn ni;\r\n}\r\nni->ni_list_next = NULL;\r\nni->ni_list_prev = NULL;\r\nni->ni_hash_next = NULL;\r\nni->ni_hash_prev = NULL;\r\nni->ni_scangen = 0;\r\n#ifdef OS_ROAM_MANAGEMENT\r\nni->ni_si_gen = 0;\r\n#endif\r\nreturn ni;\r\n}\r\nvoid\r\nwlan_node_free(bss_t *ni)\r\n{\r\nif (ni->ni_buf != NULL) {\r\nkfree(ni->ni_buf);\r\n}\r\nkfree(ni);\r\n}\r\nvoid\r\nwlan_setup_node(struct ieee80211_node_table *nt, bss_t *ni,\r\nconst u8 *macaddr)\r\n{\r\nint hash;\r\nu32 timeoutValue = 0;\r\nmemcpy(ni->ni_macaddr, macaddr, IEEE80211_ADDR_LEN);\r\nhash = IEEE80211_NODE_HASH (macaddr);\r\nieee80211_node_initref (ni);\r\ntimeoutValue = nt->nt_nodeAge;\r\nni->ni_tstamp = A_GET_MS (0);\r\nni->ni_actcnt = WLAN_NODE_INACT_CNT;\r\nIEEE80211_NODE_LOCK_BH(nt);\r\nni->ni_list_next = NULL;\r\nni->ni_list_prev = nt->nt_node_last;\r\nif(nt->nt_node_last != NULL)\r\n{\r\nnt->nt_node_last->ni_list_next = ni;\r\n}\r\nnt->nt_node_last = ni;\r\nif(nt->nt_node_first == NULL)\r\n{\r\nnt->nt_node_first = ni;\r\n}\r\nif((ni->ni_hash_next = nt->nt_hash[hash]) != NULL)\r\n{\r\nnt->nt_hash[hash]->ni_hash_prev = ni;\r\n}\r\nni->ni_hash_prev = NULL;\r\nnt->nt_hash[hash] = ni;\r\n#ifdef THREAD_X\r\nif (!nt->isTimerArmed) {\r\nA_TIMEOUT_MS(&nt->nt_inact_timer, timeoutValue, 0);\r\nnt->isTimerArmed = true;\r\n}\r\n#endif\r\nIEEE80211_NODE_UNLOCK_BH(nt);\r\n}\r\nstatic bss_t *\r\n_ieee80211_find_node(struct ieee80211_node_table *nt,\r\nconst u8 *macaddr)\r\n{\r\nbss_t *ni;\r\nint hash;\r\nIEEE80211_NODE_LOCK_ASSERT(nt);\r\nhash = IEEE80211_NODE_HASH(macaddr);\r\nfor(ni = nt->nt_hash[hash]; ni; ni = ni->ni_hash_next) {\r\nif (IEEE80211_ADDR_EQ(ni->ni_macaddr, macaddr)) {\r\nieee80211_node_incref(ni);\r\nreturn ni;\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nbss_t *\r\nwlan_find_node(struct ieee80211_node_table *nt, const u8 *macaddr)\r\n{\r\nbss_t *ni;\r\nIEEE80211_NODE_LOCK(nt);\r\nni = _ieee80211_find_node(nt, macaddr);\r\nIEEE80211_NODE_UNLOCK(nt);\r\nreturn ni;\r\n}\r\nvoid\r\nwlan_node_reclaim(struct ieee80211_node_table *nt, bss_t *ni)\r\n{\r\nIEEE80211_NODE_LOCK(nt);\r\nif(ni->ni_list_prev == NULL)\r\n{\r\nnt->nt_node_first = ni->ni_list_next;\r\n}\r\nelse\r\n{\r\nni->ni_list_prev->ni_list_next = ni->ni_list_next;\r\n}\r\nif(ni->ni_list_next == NULL)\r\n{\r\nnt->nt_node_last = ni->ni_list_prev;\r\n}\r\nelse\r\n{\r\nni->ni_list_next->ni_list_prev = ni->ni_list_prev;\r\n}\r\nif(ni->ni_hash_prev == NULL)\r\n{\r\nint hash;\r\nhash = IEEE80211_NODE_HASH(ni->ni_macaddr);\r\nnt->nt_hash[hash] = ni->ni_hash_next;\r\n}\r\nelse\r\n{\r\nni->ni_hash_prev->ni_hash_next = ni->ni_hash_next;\r\n}\r\nif(ni->ni_hash_next != NULL)\r\n{\r\nni->ni_hash_next->ni_hash_prev = ni->ni_hash_prev;\r\n}\r\nwlan_node_free(ni);\r\nIEEE80211_NODE_UNLOCK(nt);\r\n}\r\nstatic void\r\nwlan_node_dec_free(bss_t *ni)\r\n{\r\nif (ieee80211_node_dectestref(ni)) {\r\nwlan_node_free(ni);\r\n}\r\n}\r\nvoid\r\nwlan_free_allnodes(struct ieee80211_node_table *nt)\r\n{\r\nbss_t *ni;\r\nwhile ((ni = nt->nt_node_first) != NULL) {\r\nwlan_node_reclaim(nt, ni);\r\n}\r\n}\r\nvoid\r\nwlan_iterate_nodes(struct ieee80211_node_table *nt, wlan_node_iter_func *f,\r\nvoid *arg)\r\n{\r\nbss_t *ni;\r\nu32 gen;\r\ngen = ++nt->nt_scangen;\r\nIEEE80211_NODE_LOCK(nt);\r\nfor (ni = nt->nt_node_first; ni; ni = ni->ni_list_next) {\r\nif (ni->ni_scangen != gen) {\r\nni->ni_scangen = gen;\r\n(void) ieee80211_node_incref(ni);\r\n(*f)(arg, ni);\r\nwlan_node_dec_free(ni);\r\n}\r\n}\r\nIEEE80211_NODE_UNLOCK(nt);\r\n}\r\nvoid\r\nwlan_node_table_init(void *wmip, struct ieee80211_node_table *nt)\r\n{\r\nint i;\r\nAR_DEBUG_PRINTF(ATH_DEBUG_WLAN, ("node table = 0x%lx\n", (unsigned long)nt));\r\nIEEE80211_NODE_LOCK_INIT(nt);\r\nA_REGISTER_MODULE_DEBUG_INFO(wlan);\r\nnt->nt_node_first = nt->nt_node_last = NULL;\r\nfor(i = 0; i < IEEE80211_NODE_HASHSIZE; i++)\r\n{\r\nnt->nt_hash[i] = NULL;\r\n}\r\n#ifdef THREAD_X\r\nA_INIT_TIMER(&nt->nt_inact_timer, wlan_node_timeout, nt);\r\nnt->isTimerArmed = false;\r\n#endif\r\nnt->nt_wmip = wmip;\r\nnt->nt_nodeAge = WLAN_NODE_INACT_TIMEOUT_MSEC;\r\nnt->nt_scangen = 0;\r\n#ifdef OS_ROAM_MANAGEMENT\r\nnt->nt_si_gen = 0;\r\n#endif\r\n}\r\nvoid\r\nwlan_set_nodeage(struct ieee80211_node_table *nt, u32 nodeAge)\r\n{\r\nnt->nt_nodeAge = nodeAge;\r\nreturn;\r\n}\r\nvoid\r\nwlan_refresh_inactive_nodes (struct ieee80211_node_table *nt)\r\n{\r\n#ifdef THREAD_X\r\nbss_t *bss, *nextBss;\r\nu8 myBssid[IEEE80211_ADDR_LEN], reArmTimer = false;\r\nwmi_get_current_bssid(nt->nt_wmip, myBssid);\r\nbss = nt->nt_node_first;\r\nwhile (bss != NULL)\r\n{\r\nnextBss = bss->ni_list_next;\r\nif (memcmp(myBssid, bss->ni_macaddr, sizeof(myBssid)) != 0)\r\n{\r\nwlan_node_reclaim(nt, bss);\r\n}\r\nbss = nextBss;\r\n}\r\n#else\r\nbss_t *bss, *nextBss;\r\nu8 myBssid[IEEE80211_ADDR_LEN];\r\nu32 timeoutValue = 0;\r\nu32 now = A_GET_MS(0);\r\ntimeoutValue = nt->nt_nodeAge;\r\nwmi_get_current_bssid(nt->nt_wmip, myBssid);\r\nbss = nt->nt_node_first;\r\nwhile (bss != NULL)\r\n{\r\nnextBss = bss->ni_list_next;\r\nif (memcmp(myBssid, bss->ni_macaddr, sizeof(myBssid)) != 0)\r\n{\r\nif (((now - bss->ni_tstamp) > timeoutValue) || --bss->ni_actcnt == 0)\r\n{\r\nwlan_node_reclaim(nt, bss);\r\n}\r\n}\r\nbss = nextBss;\r\n}\r\n#endif\r\n}\r\nstatic void\r\nwlan_node_timeout (unsigned long arg)\r\n{\r\nstruct ieee80211_node_table *nt = (struct ieee80211_node_table *)arg;\r\nbss_t *bss, *nextBss;\r\nu8 myBssid[IEEE80211_ADDR_LEN], reArmTimer = false;\r\nu32 timeoutValue = 0;\r\nu32 now = A_GET_MS(0);\r\ntimeoutValue = nt->nt_nodeAge;\r\nwmi_get_current_bssid(nt->nt_wmip, myBssid);\r\nbss = nt->nt_node_first;\r\nwhile (bss != NULL)\r\n{\r\nnextBss = bss->ni_list_next;\r\nif (memcmp(myBssid, bss->ni_macaddr, sizeof(myBssid)) != 0)\r\n{\r\nif ((now - bss->ni_tstamp) > timeoutValue)\r\n{\r\nwlan_node_reclaim(nt, bss);\r\n}\r\nelse\r\n{\r\nreArmTimer = true;\r\n}\r\n}\r\nbss = nextBss;\r\n}\r\nif (reArmTimer)\r\nA_TIMEOUT_MS (&nt->nt_inact_timer, timeoutValue, 0);\r\nnt->isTimerArmed = reArmTimer;\r\n}\r\nvoid\r\nwlan_node_table_cleanup(struct ieee80211_node_table *nt)\r\n{\r\n#ifdef THREAD_X\r\nA_UNTIMEOUT(&nt->nt_inact_timer);\r\nA_DELETE_TIMER(&nt->nt_inact_timer);\r\n#endif\r\nwlan_free_allnodes(nt);\r\nIEEE80211_NODE_LOCK_DESTROY(nt);\r\n}\r\nbss_t *\r\nwlan_find_Ssidnode (struct ieee80211_node_table *nt, u8 *pSsid,\r\nu32 ssidLength, bool bIsWPA2, bool bMatchSSID)\r\n{\r\nbss_t *ni = NULL;\r\nu8 *pIESsid = NULL;\r\nIEEE80211_NODE_LOCK (nt);\r\nfor (ni = nt->nt_node_first; ni; ni = ni->ni_list_next) {\r\npIESsid = ni->ni_cie.ie_ssid;\r\nif (pIESsid[1] <= 32) {\r\nif (0x00 == memcmp (pSsid, &pIESsid[2], ssidLength)) {\r\nif (true == bMatchSSID) {\r\nieee80211_node_incref (ni);\r\nIEEE80211_NODE_UNLOCK (nt);\r\nreturn ni;\r\n}\r\nif (true == bIsWPA2 && NULL != ni->ni_cie.ie_rsn) {\r\nieee80211_node_incref (ni);\r\nIEEE80211_NODE_UNLOCK (nt);\r\nreturn ni;\r\n}\r\nif (false == bIsWPA2 && NULL != ni->ni_cie.ie_wpa) {\r\nieee80211_node_incref(ni);\r\nIEEE80211_NODE_UNLOCK (nt);\r\nreturn ni;\r\n}\r\n}\r\n}\r\n}\r\nIEEE80211_NODE_UNLOCK (nt);\r\nreturn NULL;\r\n}\r\nvoid\r\nwlan_node_return (struct ieee80211_node_table *nt, bss_t *ni)\r\n{\r\nIEEE80211_NODE_LOCK (nt);\r\nwlan_node_dec_free (ni);\r\nIEEE80211_NODE_UNLOCK (nt);\r\n}\r\nvoid\r\nwlan_node_remove_core (struct ieee80211_node_table *nt, bss_t *ni)\r\n{\r\nif(ni->ni_list_prev == NULL)\r\n{\r\nnt->nt_node_first = ni->ni_list_next;\r\n}\r\nelse\r\n{\r\nni->ni_list_prev->ni_list_next = ni->ni_list_next;\r\n}\r\nif(ni->ni_list_next == NULL)\r\n{\r\nnt->nt_node_last = ni->ni_list_prev;\r\n}\r\nelse\r\n{\r\nni->ni_list_next->ni_list_prev = ni->ni_list_prev;\r\n}\r\nif(ni->ni_hash_prev == NULL)\r\n{\r\nint hash;\r\nhash = IEEE80211_NODE_HASH(ni->ni_macaddr);\r\nnt->nt_hash[hash] = ni->ni_hash_next;\r\n}\r\nelse\r\n{\r\nni->ni_hash_prev->ni_hash_next = ni->ni_hash_next;\r\n}\r\nif(ni->ni_hash_next != NULL)\r\n{\r\nni->ni_hash_next->ni_hash_prev = ni->ni_hash_prev;\r\n}\r\n}\r\nbss_t *\r\nwlan_node_remove(struct ieee80211_node_table *nt, u8 *bssid)\r\n{\r\nbss_t *bss, *nextBss;\r\nIEEE80211_NODE_LOCK(nt);\r\nbss = nt->nt_node_first;\r\nwhile (bss != NULL)\r\n{\r\nnextBss = bss->ni_list_next;\r\nif (memcmp(bssid, bss->ni_macaddr, 6) == 0)\r\n{\r\nwlan_node_remove_core (nt, bss);\r\nIEEE80211_NODE_UNLOCK(nt);\r\nreturn bss;\r\n}\r\nbss = nextBss;\r\n}\r\nIEEE80211_NODE_UNLOCK(nt);\r\nreturn NULL;\r\n}\r\nbss_t *\r\nwlan_find_matching_Ssidnode (struct ieee80211_node_table *nt, u8 *pSsid,\r\nu32 ssidLength, u32 dot11AuthMode, u32 authMode,\r\nu32 pairwiseCryptoType, u32 grpwiseCryptoTyp)\r\n{\r\nbss_t *ni = NULL;\r\nbss_t *best_ni = NULL;\r\nu8 *pIESsid = NULL;\r\nIEEE80211_NODE_LOCK (nt);\r\nfor (ni = nt->nt_node_first; ni; ni = ni->ni_list_next) {\r\npIESsid = ni->ni_cie.ie_ssid;\r\nif (pIESsid[1] <= 32) {\r\nif (0x00 == memcmp (pSsid, &pIESsid[2], ssidLength)) {\r\nif (ni->ni_cie.ie_capInfo & 0x10)\r\n{\r\nif ((NULL != ni->ni_cie.ie_rsn) && (WPA2_PSK_AUTH == authMode))\r\n{\r\nif (NULL == best_ni)\r\n{\r\nbest_ni = ni;\r\n}\r\nelse if (ni->ni_rssi > best_ni->ni_rssi)\r\n{\r\nbest_ni = ni;\r\n}\r\n}\r\nelse if ((NULL != ni->ni_cie.ie_wpa) && (WPA_PSK_AUTH == authMode))\r\n{\r\nif (NULL == best_ni)\r\n{\r\nbest_ni = ni;\r\n}\r\nelse if (ni->ni_rssi > best_ni->ni_rssi)\r\n{\r\nbest_ni = ni;\r\n}\r\n}\r\nelse if (WEP_CRYPT == pairwiseCryptoType)\r\n{\r\nif (NULL == best_ni)\r\n{\r\nbest_ni = ni;\r\n}\r\nelse if (ni->ni_rssi > best_ni->ni_rssi)\r\n{\r\nbest_ni = ni;\r\n}\r\n}\r\n}\r\nelse\r\n{\r\nif ((OPEN_AUTH == authMode) && (NONE_CRYPT == pairwiseCryptoType))\r\n{\r\nif (NULL == best_ni)\r\n{\r\nbest_ni = ni;\r\n}\r\nelse if (ni->ni_rssi > best_ni->ni_rssi)\r\n{\r\nbest_ni = ni;\r\n}\r\n}\r\n}\r\n}\r\n}\r\n}\r\nIEEE80211_NODE_UNLOCK (nt);\r\nreturn best_ni;\r\n}

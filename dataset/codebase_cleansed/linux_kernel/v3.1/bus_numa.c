void x86_pci_root_bus_res_quirks(struct pci_bus *b)\r\n{\r\nint i;\r\nint j;\r\nstruct pci_root_info *info;\r\nif (b->resource[0] != &ioport_resource ||\r\nb->resource[1] != &iomem_resource)\r\nreturn;\r\nif (!pci_root_num)\r\nreturn;\r\nfor (i = 0; i < pci_root_num; i++) {\r\nif (pci_root_info[i].bus_min == b->number)\r\nbreak;\r\n}\r\nif (i == pci_root_num)\r\nreturn;\r\nprintk(KERN_DEBUG "PCI: peer root bus %02x res updated from pci conf\n",\r\nb->number);\r\npci_bus_remove_resources(b);\r\ninfo = &pci_root_info[i];\r\nfor (j = 0; j < info->res_num; j++) {\r\nstruct resource *res;\r\nstruct resource *root;\r\nres = &info->res[j];\r\npci_bus_add_resource(b, res, 0);\r\nif (res->flags & IORESOURCE_IO)\r\nroot = &ioport_resource;\r\nelse\r\nroot = &iomem_resource;\r\ninsert_resource(root, res);\r\n}\r\n}\r\nvoid __devinit update_res(struct pci_root_info *info, resource_size_t start,\r\nresource_size_t end, unsigned long flags, int merge)\r\n{\r\nint i;\r\nstruct resource *res;\r\nif (start > end)\r\nreturn;\r\nif (start == MAX_RESOURCE)\r\nreturn;\r\nif (!merge)\r\ngoto addit;\r\nfor (i = 0; i < info->res_num; i++) {\r\nresource_size_t final_start, final_end;\r\nresource_size_t common_start, common_end;\r\nres = &info->res[i];\r\nif (res->flags != flags)\r\ncontinue;\r\ncommon_start = max(res->start, start);\r\ncommon_end = min(res->end, end);\r\nif (common_start > common_end + 1)\r\ncontinue;\r\nfinal_start = min(res->start, start);\r\nfinal_end = max(res->end, end);\r\nres->start = final_start;\r\nres->end = final_end;\r\nreturn;\r\n}\r\naddit:\r\nif (info->res_num >= RES_NUM)\r\nreturn;\r\nres = &info->res[info->res_num];\r\nres->name = info->name;\r\nres->flags = flags;\r\nres->start = start;\r\nres->end = end;\r\nres->child = NULL;\r\ninfo->res_num++;\r\n}

void get_vmalloc_info(struct vmalloc_info *vmi)\r\n{\r\nstruct vm_struct *vma;\r\nunsigned long free_area_size;\r\nunsigned long prev_end;\r\nvmi->used = 0;\r\nif (!vmlist) {\r\nvmi->largest_chunk = VMALLOC_TOTAL;\r\n}\r\nelse {\r\nvmi->largest_chunk = 0;\r\nprev_end = VMALLOC_START;\r\nread_lock(&vmlist_lock);\r\nfor (vma = vmlist; vma; vma = vma->next) {\r\nunsigned long addr = (unsigned long) vma->addr;\r\nif (addr < VMALLOC_START)\r\ncontinue;\r\nif (addr >= VMALLOC_END)\r\nbreak;\r\nvmi->used += vma->size;\r\nfree_area_size = addr - prev_end;\r\nif (vmi->largest_chunk < free_area_size)\r\nvmi->largest_chunk = free_area_size;\r\nprev_end = vma->size + addr;\r\n}\r\nif (VMALLOC_END - prev_end > vmi->largest_chunk)\r\nvmi->largest_chunk = VMALLOC_END - prev_end;\r\nread_unlock(&vmlist_lock);\r\n}\r\n}

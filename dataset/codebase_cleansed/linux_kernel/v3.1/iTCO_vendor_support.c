static void supermicro_old_pre_start(unsigned long acpibase)\r\n{\r\nunsigned long val32;\r\nval32 = inl(SMI_EN);\r\nval32 &= 0xffffdfff;\r\noutl(val32, SMI_EN);\r\n}\r\nstatic void supermicro_old_pre_stop(unsigned long acpibase)\r\n{\r\nunsigned long val32;\r\nval32 = inl(SMI_EN);\r\nval32 |= 0x00002000;\r\noutl(val32, SMI_EN);\r\n}\r\nstatic void supermicro_new_unlock_watchdog(void)\r\n{\r\noutb(SM_WATCHPAGE, SM_REGINDEX);\r\noutb(SM_WATCHPAGE, SM_REGINDEX);\r\noutb(SM_CTLPAGESW, SM_REGINDEX);\r\noutb(SM_CTLPAGE, SM_DATAIO);\r\n}\r\nstatic void supermicro_new_lock_watchdog(void)\r\n{\r\noutb(SM_ENDWATCH, SM_REGINDEX);\r\n}\r\nstatic void supermicro_new_pre_start(unsigned int heartbeat)\r\n{\r\nunsigned int val;\r\nsupermicro_new_unlock_watchdog();\r\noutb(SM_COUNTMODE, SM_REGINDEX);\r\nval = inb(SM_DATAIO);\r\nval &= 0xF7;\r\noutb(val, SM_DATAIO);\r\noutb(SM_WATCHTIMER, SM_REGINDEX);\r\noutb((heartbeat & 255), SM_DATAIO);\r\noutb(SM_RESETCONTROL, SM_REGINDEX);\r\nval = inb(SM_DATAIO);\r\nval &= 0x3f;\r\noutb(val, SM_DATAIO);\r\noutb(SM_WATCHENABLE, SM_REGINDEX);\r\nval = inb(SM_DATAIO);\r\nval |= 0x01;\r\noutb(val, SM_DATAIO);\r\nsupermicro_new_lock_watchdog();\r\n}\r\nstatic void supermicro_new_pre_stop(void)\r\n{\r\nunsigned int val;\r\nsupermicro_new_unlock_watchdog();\r\noutb(SM_WATCHENABLE, SM_REGINDEX);\r\nval = inb(SM_DATAIO);\r\nval &= 0xFE;\r\noutb(val, SM_DATAIO);\r\nsupermicro_new_lock_watchdog();\r\n}\r\nstatic void supermicro_new_pre_set_heartbeat(unsigned int heartbeat)\r\n{\r\nsupermicro_new_unlock_watchdog();\r\noutb(SM_WATCHTIMER, SM_REGINDEX);\r\noutb((heartbeat & 255), SM_DATAIO);\r\nsupermicro_new_lock_watchdog();\r\n}\r\nstatic void broken_bios_start(unsigned long acpibase)\r\n{\r\nunsigned long val32;\r\nval32 = inl(SMI_EN);\r\nval32 &= 0xffffdffe;\r\noutl(val32, SMI_EN);\r\n}\r\nstatic void broken_bios_stop(unsigned long acpibase)\r\n{\r\nunsigned long val32;\r\nval32 = inl(SMI_EN);\r\nval32 |= 0x00002001;\r\noutl(val32, SMI_EN);\r\n}\r\nvoid iTCO_vendor_pre_start(unsigned long acpibase,\r\nunsigned int heartbeat)\r\n{\r\nswitch (vendorsupport) {\r\ncase SUPERMICRO_OLD_BOARD:\r\nsupermicro_old_pre_start(acpibase);\r\nbreak;\r\ncase SUPERMICRO_NEW_BOARD:\r\nsupermicro_new_pre_start(heartbeat);\r\nbreak;\r\ncase BROKEN_BIOS:\r\nbroken_bios_start(acpibase);\r\nbreak;\r\n}\r\n}\r\nvoid iTCO_vendor_pre_stop(unsigned long acpibase)\r\n{\r\nswitch (vendorsupport) {\r\ncase SUPERMICRO_OLD_BOARD:\r\nsupermicro_old_pre_stop(acpibase);\r\nbreak;\r\ncase SUPERMICRO_NEW_BOARD:\r\nsupermicro_new_pre_stop();\r\nbreak;\r\ncase BROKEN_BIOS:\r\nbroken_bios_stop(acpibase);\r\nbreak;\r\n}\r\n}\r\nvoid iTCO_vendor_pre_keepalive(unsigned long acpibase, unsigned int heartbeat)\r\n{\r\nif (vendorsupport == SUPERMICRO_NEW_BOARD)\r\nsupermicro_new_pre_set_heartbeat(heartbeat);\r\n}\r\nvoid iTCO_vendor_pre_set_heartbeat(unsigned int heartbeat)\r\n{\r\nif (vendorsupport == SUPERMICRO_NEW_BOARD)\r\nsupermicro_new_pre_set_heartbeat(heartbeat);\r\n}\r\nint iTCO_vendor_check_noreboot_on(void)\r\n{\r\nswitch (vendorsupport) {\r\ncase SUPERMICRO_OLD_BOARD:\r\nreturn 0;\r\ndefault:\r\nreturn 1;\r\n}\r\n}\r\nstatic int __init iTCO_vendor_init_module(void)\r\n{\r\nprintk(KERN_INFO PFX "vendor-support=%d\n", vendorsupport);\r\nreturn 0;\r\n}\r\nstatic void __exit iTCO_vendor_exit_module(void)\r\n{\r\nprintk(KERN_INFO PFX "Module Unloaded\n");\r\n}

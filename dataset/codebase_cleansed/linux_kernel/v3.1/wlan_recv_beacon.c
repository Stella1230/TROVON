static int __inline\r\niswpaoui(const u8 *frm)\r\n{\r\nreturn frm[1] > 3 && LE_READ_4(frm+2) == ((WPA_OUI_TYPE<<24)|WPA_OUI);\r\n}\r\nstatic int __inline\r\niswmmoui(const u8 *frm)\r\n{\r\nreturn frm[1] > 3 && LE_READ_4(frm+2) == ((WMM_OUI_TYPE<<24)|WMM_OUI);\r\n}\r\nstatic int __inline\r\nisatherosoui(const u8 *frm)\r\n{\r\nreturn frm[1] > 3 && LE_READ_4(frm+2) == ((ATH_OUI_TYPE<<24)|ATH_OUI);\r\n}\r\nstatic int __inline\r\niswscoui(const u8 *frm)\r\n{\r\nreturn frm[1] > 3 && LE_READ_4(frm+2) == ((0x04<<24)|WPA_OUI);\r\n}\r\nint\r\nwlan_parse_beacon(u8 *buf, int framelen, struct ieee80211_common_ie *cie)\r\n{\r\nu8 *frm, *efrm;\r\nu8 elemid_ssid = false;\r\nfrm = buf;\r\nefrm = (u8 *) (frm + framelen);\r\nIEEE80211_VERIFY_LENGTH(efrm - frm, 12);\r\nA_MEMZERO(cie, sizeof(*cie));\r\ncie->ie_tstamp = frm; frm += 8;\r\ncie->ie_beaconInt = A_LE2CPU16(*(u16 *)frm); frm += 2;\r\ncie->ie_capInfo = A_LE2CPU16(*(u16 *)frm); frm += 2;\r\ncie->ie_chan = 0;\r\nwhile (frm < efrm) {\r\nswitch (*frm) {\r\ncase IEEE80211_ELEMID_SSID:\r\nif (!elemid_ssid) {\r\ncie->ie_ssid = frm;\r\nelemid_ssid = true;\r\n}\r\nbreak;\r\ncase IEEE80211_ELEMID_RATES:\r\ncie->ie_rates = frm;\r\nbreak;\r\ncase IEEE80211_ELEMID_COUNTRY:\r\ncie->ie_country = frm;\r\nbreak;\r\ncase IEEE80211_ELEMID_FHPARMS:\r\nbreak;\r\ncase IEEE80211_ELEMID_DSPARMS:\r\ncie->ie_chan = frm[2];\r\nbreak;\r\ncase IEEE80211_ELEMID_TIM:\r\ncie->ie_tim = frm;\r\nbreak;\r\ncase IEEE80211_ELEMID_IBSSPARMS:\r\nbreak;\r\ncase IEEE80211_ELEMID_XRATES:\r\ncie->ie_xrates = frm;\r\nbreak;\r\ncase IEEE80211_ELEMID_ERP:\r\nif (frm[1] != 1) {\r\nreturn A_EINVAL;\r\n}\r\ncie->ie_erp = frm[2];\r\nbreak;\r\ncase IEEE80211_ELEMID_RSN:\r\ncie->ie_rsn = frm;\r\nbreak;\r\ncase IEEE80211_ELEMID_HTCAP_ANA:\r\ncie->ie_htcap = frm;\r\nbreak;\r\ncase IEEE80211_ELEMID_HTINFO_ANA:\r\ncie->ie_htop = frm;\r\nbreak;\r\n#ifdef WAPI_ENABLE\r\ncase IEEE80211_ELEMID_WAPI:\r\ncie->ie_wapi = frm;\r\nbreak;\r\n#endif\r\ncase IEEE80211_ELEMID_VENDOR:\r\nif (iswpaoui(frm)) {\r\ncie->ie_wpa = frm;\r\n} else if (iswmmoui(frm)) {\r\ncie->ie_wmm = frm;\r\n} else if (isatherosoui(frm)) {\r\ncie->ie_ath = frm;\r\n} else if(iswscoui(frm)) {\r\ncie->ie_wsc = frm;\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nfrm += frm[1] + 2;\r\n}\r\nIEEE80211_VERIFY_ELEMENT(cie->ie_rates, IEEE80211_RATE_MAXSIZE);\r\nIEEE80211_VERIFY_ELEMENT(cie->ie_ssid, IEEE80211_NWID_LEN);\r\nreturn 0;\r\n}

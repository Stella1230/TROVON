static int __devinit snd_vortex_midi(vortex_t * vortex)\r\n{\r\nstruct snd_rawmidi *rmidi;\r\nint temp, mode;\r\nstruct snd_mpu401 *mpu;\r\nunsigned long port;\r\n#ifdef VORTEX_MPU401_LEGACY\r\nport = (0x03 << 5);\r\ntemp =\r\n(hwread(vortex->mmio, VORTEX_CTRL) & ~CTRL_MIDI_PORT) |\r\nCTRL_MIDI_EN | port;\r\nhwwrite(vortex->mmio, VORTEX_CTRL, temp);\r\n#else\r\ntemp =\r\n(hwread(vortex->mmio, VORTEX_CTRL) & ~CTRL_MIDI_PORT) &\r\n~CTRL_MIDI_EN;\r\nhwwrite(vortex->mmio, VORTEX_CTRL, temp);\r\n#endif\r\nmode = 1;\r\ntemp = hwread(vortex->mmio, VORTEX_CTRL2) & 0xffff00cf;\r\ntemp |= (MIDI_CLOCK_DIV << 8) | ((mode >> 24) & 0xff) << 4;\r\nhwwrite(vortex->mmio, VORTEX_CTRL2, temp);\r\nhwwrite(vortex->mmio, VORTEX_MIDI_CMD, MPU401_RESET);\r\ntemp = hwread(vortex->mmio, VORTEX_MIDI_DATA);\r\nif (temp != MPU401_ACK ) {\r\nprintk(KERN_ERR "midi port doesn't acknowledge!\n");\r\nreturn -ENODEV;\r\n}\r\nhwwrite(vortex->mmio, VORTEX_IRQ_CTRL,\r\nhwread(vortex->mmio, VORTEX_IRQ_CTRL) | IRQ_MIDI);\r\n#ifdef VORTEX_MPU401_LEGACY\r\nif ((temp =\r\nsnd_mpu401_uart_new(vortex->card, 0, MPU401_HW_MPU401, 0x330,\r\n0, 0, 0, &rmidi)) != 0) {\r\nhwwrite(vortex->mmio, VORTEX_CTRL,\r\n(hwread(vortex->mmio, VORTEX_CTRL) &\r\n~CTRL_MIDI_PORT) & ~CTRL_MIDI_EN);\r\nreturn temp;\r\n}\r\n#else\r\nport = (unsigned long)(vortex->mmio + VORTEX_MIDI_DATA);\r\nif ((temp =\r\nsnd_mpu401_uart_new(vortex->card, 0, MPU401_HW_AUREAL, port,\r\nMPU401_INFO_INTEGRATED | MPU401_INFO_MMIO,\r\n0, 0, &rmidi)) != 0) {\r\nhwwrite(vortex->mmio, VORTEX_CTRL,\r\n(hwread(vortex->mmio, VORTEX_CTRL) &\r\n~CTRL_MIDI_PORT) & ~CTRL_MIDI_EN);\r\nreturn temp;\r\n}\r\nmpu = rmidi->private_data;\r\nmpu->cport = (unsigned long)(vortex->mmio + VORTEX_MIDI_CMD);\r\n#endif\r\nsnprintf(rmidi->name, sizeof(rmidi->name), "%s MIDI %d", CARD_NAME_SHORT , vortex->card->number);\r\nvortex->rmidi = rmidi;\r\nreturn 0;\r\n}

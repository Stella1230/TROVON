void dsp_dtmf_goertzel_init(struct dsp *dsp)\r\n{\r\ndsp->dtmf.size = 0;\r\ndsp->dtmf.lastwhat = '\0';\r\ndsp->dtmf.lastdigit = '\0';\r\ndsp->dtmf.count = 0;\r\n}\r\nvoid dsp_dtmf_hardware(struct dsp *dsp)\r\n{\r\nint hardware = 1;\r\nif (!dsp->dtmf.enable)\r\nreturn;\r\nif (!dsp->features.hfc_dtmf)\r\nhardware = 0;\r\nif (dsp->tx_volume) {\r\nif (dsp_debug & DEBUG_DSP_DTMF)\r\nprintk(KERN_DEBUG "%s dsp %s cannot do hardware DTMF, "\r\n"because tx_volume is changed\n",\r\n__func__, dsp->name);\r\nhardware = 0;\r\n}\r\nif (dsp->rx_volume) {\r\nif (dsp_debug & DEBUG_DSP_DTMF)\r\nprintk(KERN_DEBUG "%s dsp %s cannot do hardware DTMF, "\r\n"because rx_volume is changed\n",\r\n__func__, dsp->name);\r\nhardware = 0;\r\n}\r\nif (dsp->bf_enable) {\r\nif (dsp_debug & DEBUG_DSP_DTMF)\r\nprintk(KERN_DEBUG "%s dsp %s cannot do hardware DTMF, "\r\n"because encryption is enabled\n",\r\n__func__, dsp->name);\r\nhardware = 0;\r\n}\r\nif (dsp->pipeline.inuse) {\r\nif (dsp_debug & DEBUG_DSP_DTMF)\r\nprintk(KERN_DEBUG "%s dsp %s cannot do hardware DTMF, "\r\n"because pipeline exists.\n",\r\n__func__, dsp->name);\r\nhardware = 0;\r\n}\r\ndsp->dtmf.hardware = hardware;\r\ndsp->dtmf.software = !hardware;\r\n}\r\nu8\r\n*dsp_dtmf_goertzel_decode(struct dsp *dsp, u8 *data, int len, int fmt)\r\n{\r\nu8 what;\r\nint size;\r\nsigned short *buf;\r\ns32 sk, sk1, sk2;\r\nint k, n, i;\r\ns32 *hfccoeff;\r\ns32 result[NCOEFF], tresh, treshl;\r\nint lowgroup, highgroup;\r\ns64 cos2pik_;\r\ndsp->dtmf.digits[0] = '\0';\r\nagain:\r\nsize = dsp->dtmf.size;\r\nbuf = dsp->dtmf.buffer;\r\nswitch (fmt) {\r\ncase 0:\r\ncase 1:\r\nwhile (size < DSP_DTMF_NPOINTS && len) {\r\nbuf[size++] = dsp_audio_law_to_s32[*data++];\r\nlen--;\r\n}\r\nbreak;\r\ncase 2:\r\ndefault:\r\nif (len < 64) {\r\nif (len > 0)\r\nprintk(KERN_ERR "%s: coefficients have invalid "\r\n"size. (is=%d < must=%d)\n",\r\n__func__, len, 64);\r\nreturn dsp->dtmf.digits;\r\n}\r\nhfccoeff = (s32 *)data;\r\nfor (k = 0; k < NCOEFF; k++) {\r\nsk2 = (*hfccoeff++)>>4;\r\nsk = (*hfccoeff++)>>4;\r\nif (sk > 32767 || sk < -32767 || sk2 > 32767\r\n|| sk2 < -32767)\r\nprintk(KERN_WARNING\r\n"DTMF-Detection overflow\n");\r\nresult[k] =\r\n(sk * sk) -\r\n(((cos2pik[k] * sk) >> 15) * sk2) +\r\n(sk2 * sk2);\r\n}\r\ndata += 64;\r\nlen -= 64;\r\ngoto coefficients;\r\nbreak;\r\n}\r\ndsp->dtmf.size = size;\r\nif (size < DSP_DTMF_NPOINTS)\r\nreturn dsp->dtmf.digits;\r\ndsp->dtmf.size = 0;\r\nfor (k = 0; k < NCOEFF; k++) {\r\nsk = 0;\r\nsk1 = 0;\r\nsk2 = 0;\r\nbuf = dsp->dtmf.buffer;\r\ncos2pik_ = cos2pik[k];\r\nfor (n = 0; n < DSP_DTMF_NPOINTS; n++) {\r\nsk = ((cos2pik_*sk1)>>15) - sk2 + (*buf++);\r\nsk2 = sk1;\r\nsk1 = sk;\r\n}\r\nsk >>= 8;\r\nsk2 >>= 8;\r\nif (sk > 32767 || sk < -32767 || sk2 > 32767 || sk2 < -32767)\r\nprintk(KERN_WARNING "DTMF-Detection overflow\n");\r\nresult[k] =\r\n(sk * sk) -\r\n(((cos2pik[k] * sk) >> 15) * sk2) +\r\n(sk2 * sk2);\r\n}\r\ncoefficients:\r\ntresh = 0;\r\nfor (i = 0; i < NCOEFF; i++) {\r\nif (result[i] < 0)\r\nresult[i] = 0;\r\nif (result[i] > dsp->dtmf.treshold) {\r\nif (result[i] > tresh)\r\ntresh = result[i];\r\n}\r\n}\r\nif (tresh == 0) {\r\nwhat = 0;\r\ngoto storedigit;\r\n}\r\nif (dsp_debug & DEBUG_DSP_DTMFCOEFF)\r\nprintk(KERN_DEBUG "a %3d %3d %3d %3d %3d %3d %3d %3d"\r\n" tr:%3d r %3d %3d %3d %3d %3d %3d %3d %3d\n",\r\nresult[0]/10000, result[1]/10000, result[2]/10000,\r\nresult[3]/10000, result[4]/10000, result[5]/10000,\r\nresult[6]/10000, result[7]/10000, tresh/10000,\r\nresult[0]/(tresh/100), result[1]/(tresh/100),\r\nresult[2]/(tresh/100), result[3]/(tresh/100),\r\nresult[4]/(tresh/100), result[5]/(tresh/100),\r\nresult[6]/(tresh/100), result[7]/(tresh/100));\r\nlowgroup = -1;\r\nhighgroup = -1;\r\ntreshl = tresh >> 3;\r\ntresh = tresh >> 2;\r\nfor (i = 0; i < NCOEFF; i++) {\r\nif (result[i] < treshl)\r\ncontinue;\r\nif (result[i] < tresh) {\r\nlowgroup = -1;\r\nhighgroup = -1;\r\nbreak;\r\n}\r\nif (i < NCOEFF/2) {\r\nif (lowgroup >= 0) {\r\nlowgroup = -1;\r\nbreak;\r\n} else\r\nlowgroup = i;\r\n} else {\r\nif (highgroup >= 0) {\r\nhighgroup = -1;\r\nbreak;\r\n} else\r\nhighgroup = i-(NCOEFF/2);\r\n}\r\n}\r\nwhat = 0;\r\nif (lowgroup >= 0 && highgroup >= 0)\r\nwhat = dtmf_matrix[lowgroup][highgroup];\r\nstoredigit:\r\nif (what && (dsp_debug & DEBUG_DSP_DTMF))\r\nprintk(KERN_DEBUG "DTMF what: %c\n", what);\r\nif (dsp->dtmf.lastwhat != what)\r\ndsp->dtmf.count = 0;\r\nif (dsp->dtmf.count == 2) {\r\nif (dsp->dtmf.lastdigit != what) {\r\ndsp->dtmf.lastdigit = what;\r\nif (what) {\r\nif (dsp_debug & DEBUG_DSP_DTMF)\r\nprintk(KERN_DEBUG "DTMF digit: %c\n",\r\nwhat);\r\nif ((strlen(dsp->dtmf.digits)+1)\r\n< sizeof(dsp->dtmf.digits)) {\r\ndsp->dtmf.digits[strlen(\r\ndsp->dtmf.digits)+1] = '\0';\r\ndsp->dtmf.digits[strlen(\r\ndsp->dtmf.digits)] = what;\r\n}\r\n}\r\n}\r\n} else\r\ndsp->dtmf.count++;\r\ndsp->dtmf.lastwhat = what;\r\ngoto again;\r\n}

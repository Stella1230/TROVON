static int ati_remote2_set_mask(const char *val,\r\nconst struct kernel_param *kp,\r\nunsigned int max)\r\n{\r\nunsigned long mask;\r\nint ret;\r\nif (!val)\r\nreturn -EINVAL;\r\nret = strict_strtoul(val, 0, &mask);\r\nif (ret)\r\nreturn ret;\r\nif (mask & ~max)\r\nreturn -EINVAL;\r\n*(unsigned int *)kp->arg = mask;\r\nreturn 0;\r\n}\r\nstatic int ati_remote2_set_channel_mask(const char *val,\r\nconst struct kernel_param *kp)\r\n{\r\npr_debug("%s()\n", __func__);\r\nreturn ati_remote2_set_mask(val, kp, ATI_REMOTE2_MAX_CHANNEL_MASK);\r\n}\r\nstatic int ati_remote2_get_channel_mask(char *buffer,\r\nconst struct kernel_param *kp)\r\n{\r\npr_debug("%s()\n", __func__);\r\nreturn sprintf(buffer, "0x%04x", *(unsigned int *)kp->arg);\r\n}\r\nstatic int ati_remote2_set_mode_mask(const char *val,\r\nconst struct kernel_param *kp)\r\n{\r\npr_debug("%s()\n", __func__);\r\nreturn ati_remote2_set_mask(val, kp, ATI_REMOTE2_MAX_MODE_MASK);\r\n}\r\nstatic int ati_remote2_get_mode_mask(char *buffer,\r\nconst struct kernel_param *kp)\r\n{\r\npr_debug("%s()\n", __func__);\r\nreturn sprintf(buffer, "0x%02x", *(unsigned int *)kp->arg);\r\n}\r\nstatic int ati_remote2_submit_urbs(struct ati_remote2 *ar2)\r\n{\r\nint r;\r\nr = usb_submit_urb(ar2->urb[0], GFP_KERNEL);\r\nif (r) {\r\ndev_err(&ar2->intf[0]->dev,\r\n"%s(): usb_submit_urb() = %d\n", __func__, r);\r\nreturn r;\r\n}\r\nr = usb_submit_urb(ar2->urb[1], GFP_KERNEL);\r\nif (r) {\r\nusb_kill_urb(ar2->urb[0]);\r\ndev_err(&ar2->intf[1]->dev,\r\n"%s(): usb_submit_urb() = %d\n", __func__, r);\r\nreturn r;\r\n}\r\nreturn 0;\r\n}\r\nstatic void ati_remote2_kill_urbs(struct ati_remote2 *ar2)\r\n{\r\nusb_kill_urb(ar2->urb[1]);\r\nusb_kill_urb(ar2->urb[0]);\r\n}\r\nstatic int ati_remote2_open(struct input_dev *idev)\r\n{\r\nstruct ati_remote2 *ar2 = input_get_drvdata(idev);\r\nint r;\r\ndev_dbg(&ar2->intf[0]->dev, "%s()\n", __func__);\r\nr = usb_autopm_get_interface(ar2->intf[0]);\r\nif (r) {\r\ndev_err(&ar2->intf[0]->dev,\r\n"%s(): usb_autopm_get_interface() = %d\n", __func__, r);\r\ngoto fail1;\r\n}\r\nmutex_lock(&ati_remote2_mutex);\r\nif (!(ar2->flags & ATI_REMOTE2_SUSPENDED)) {\r\nr = ati_remote2_submit_urbs(ar2);\r\nif (r)\r\ngoto fail2;\r\n}\r\nar2->flags |= ATI_REMOTE2_OPENED;\r\nmutex_unlock(&ati_remote2_mutex);\r\nusb_autopm_put_interface(ar2->intf[0]);\r\nreturn 0;\r\nfail2:\r\nmutex_unlock(&ati_remote2_mutex);\r\nusb_autopm_put_interface(ar2->intf[0]);\r\nfail1:\r\nreturn r;\r\n}\r\nstatic void ati_remote2_close(struct input_dev *idev)\r\n{\r\nstruct ati_remote2 *ar2 = input_get_drvdata(idev);\r\ndev_dbg(&ar2->intf[0]->dev, "%s()\n", __func__);\r\nmutex_lock(&ati_remote2_mutex);\r\nif (!(ar2->flags & ATI_REMOTE2_SUSPENDED))\r\nati_remote2_kill_urbs(ar2);\r\nar2->flags &= ~ATI_REMOTE2_OPENED;\r\nmutex_unlock(&ati_remote2_mutex);\r\n}\r\nstatic void ati_remote2_input_mouse(struct ati_remote2 *ar2)\r\n{\r\nstruct input_dev *idev = ar2->idev;\r\nu8 *data = ar2->buf[0];\r\nint channel, mode;\r\nchannel = data[0] >> 4;\r\nif (!((1 << channel) & ar2->channel_mask))\r\nreturn;\r\nmode = data[0] & 0x0F;\r\nif (mode > ATI_REMOTE2_PC) {\r\ndev_err(&ar2->intf[0]->dev,\r\n"Unknown mode byte (%02x %02x %02x %02x)\n",\r\ndata[3], data[2], data[1], data[0]);\r\nreturn;\r\n}\r\nif (!((1 << mode) & ar2->mode_mask))\r\nreturn;\r\ninput_event(idev, EV_REL, REL_X, (s8) data[1]);\r\ninput_event(idev, EV_REL, REL_Y, (s8) data[2]);\r\ninput_sync(idev);\r\n}\r\nstatic int ati_remote2_lookup(unsigned int hw_code)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(ati_remote2_key_table); i++)\r\nif (ati_remote2_key_table[i].hw_code == hw_code)\r\nreturn i;\r\nreturn -1;\r\n}\r\nstatic void ati_remote2_input_key(struct ati_remote2 *ar2)\r\n{\r\nstruct input_dev *idev = ar2->idev;\r\nu8 *data = ar2->buf[1];\r\nint channel, mode, hw_code, index;\r\nchannel = data[0] >> 4;\r\nif (!((1 << channel) & ar2->channel_mask))\r\nreturn;\r\nmode = data[0] & 0x0F;\r\nif (mode > ATI_REMOTE2_PC) {\r\ndev_err(&ar2->intf[1]->dev,\r\n"Unknown mode byte (%02x %02x %02x %02x)\n",\r\ndata[3], data[2], data[1], data[0]);\r\nreturn;\r\n}\r\nhw_code = data[2];\r\nif (hw_code == 0x3f) {\r\nif (ar2->mode == mode)\r\nreturn;\r\nif (data[1] == 0)\r\nar2->mode = mode;\r\n}\r\nif (!((1 << mode) & ar2->mode_mask))\r\nreturn;\r\nindex = ati_remote2_lookup(hw_code);\r\nif (index < 0) {\r\ndev_err(&ar2->intf[1]->dev,\r\n"Unknown code byte (%02x %02x %02x %02x)\n",\r\ndata[3], data[2], data[1], data[0]);\r\nreturn;\r\n}\r\nswitch (data[1]) {\r\ncase 0:\r\nbreak;\r\ncase 1:\r\nar2->jiffies = jiffies + msecs_to_jiffies(idev->rep[REP_DELAY]);\r\nbreak;\r\ncase 2:\r\nif (ar2->keycode[mode][index] == BTN_LEFT ||\r\nar2->keycode[mode][index] == BTN_RIGHT)\r\nreturn;\r\nif (!time_after_eq(jiffies, ar2->jiffies))\r\nreturn;\r\nar2->jiffies = jiffies + msecs_to_jiffies(idev->rep[REP_PERIOD]);\r\nbreak;\r\ndefault:\r\ndev_err(&ar2->intf[1]->dev,\r\n"Unknown state byte (%02x %02x %02x %02x)\n",\r\ndata[3], data[2], data[1], data[0]);\r\nreturn;\r\n}\r\ninput_event(idev, EV_KEY, ar2->keycode[mode][index], data[1]);\r\ninput_sync(idev);\r\n}\r\nstatic void ati_remote2_complete_mouse(struct urb *urb)\r\n{\r\nstruct ati_remote2 *ar2 = urb->context;\r\nint r;\r\nswitch (urb->status) {\r\ncase 0:\r\nusb_mark_last_busy(ar2->udev);\r\nati_remote2_input_mouse(ar2);\r\nbreak;\r\ncase -ENOENT:\r\ncase -EILSEQ:\r\ncase -ECONNRESET:\r\ncase -ESHUTDOWN:\r\ndev_dbg(&ar2->intf[0]->dev,\r\n"%s(): urb status = %d\n", __func__, urb->status);\r\nreturn;\r\ndefault:\r\nusb_mark_last_busy(ar2->udev);\r\ndev_err(&ar2->intf[0]->dev,\r\n"%s(): urb status = %d\n", __func__, urb->status);\r\n}\r\nr = usb_submit_urb(urb, GFP_ATOMIC);\r\nif (r)\r\ndev_err(&ar2->intf[0]->dev,\r\n"%s(): usb_submit_urb() = %d\n", __func__, r);\r\n}\r\nstatic void ati_remote2_complete_key(struct urb *urb)\r\n{\r\nstruct ati_remote2 *ar2 = urb->context;\r\nint r;\r\nswitch (urb->status) {\r\ncase 0:\r\nusb_mark_last_busy(ar2->udev);\r\nati_remote2_input_key(ar2);\r\nbreak;\r\ncase -ENOENT:\r\ncase -EILSEQ:\r\ncase -ECONNRESET:\r\ncase -ESHUTDOWN:\r\ndev_dbg(&ar2->intf[1]->dev,\r\n"%s(): urb status = %d\n", __func__, urb->status);\r\nreturn;\r\ndefault:\r\nusb_mark_last_busy(ar2->udev);\r\ndev_err(&ar2->intf[1]->dev,\r\n"%s(): urb status = %d\n", __func__, urb->status);\r\n}\r\nr = usb_submit_urb(urb, GFP_ATOMIC);\r\nif (r)\r\ndev_err(&ar2->intf[1]->dev,\r\n"%s(): usb_submit_urb() = %d\n", __func__, r);\r\n}\r\nstatic int ati_remote2_getkeycode(struct input_dev *idev,\r\nstruct input_keymap_entry *ke)\r\n{\r\nstruct ati_remote2 *ar2 = input_get_drvdata(idev);\r\nunsigned int mode;\r\nint offset;\r\nunsigned int index;\r\nunsigned int scancode;\r\nif (ke->flags & INPUT_KEYMAP_BY_INDEX) {\r\nindex = ke->index;\r\nif (index >= ATI_REMOTE2_MODES *\r\nARRAY_SIZE(ati_remote2_key_table))\r\nreturn -EINVAL;\r\nmode = ke->index / ARRAY_SIZE(ati_remote2_key_table);\r\noffset = ke->index % ARRAY_SIZE(ati_remote2_key_table);\r\nscancode = (mode << 8) + ati_remote2_key_table[offset].hw_code;\r\n} else {\r\nif (input_scancode_to_scalar(ke, &scancode))\r\nreturn -EINVAL;\r\nmode = scancode >> 8;\r\nif (mode > ATI_REMOTE2_PC)\r\nreturn -EINVAL;\r\noffset = ati_remote2_lookup(scancode & 0xff);\r\nif (offset < 0)\r\nreturn -EINVAL;\r\nindex = mode * ARRAY_SIZE(ati_remote2_key_table) + offset;\r\n}\r\nke->keycode = ar2->keycode[mode][offset];\r\nke->len = sizeof(scancode);\r\nmemcpy(&ke->scancode, &scancode, sizeof(scancode));\r\nke->index = index;\r\nreturn 0;\r\n}\r\nstatic int ati_remote2_setkeycode(struct input_dev *idev,\r\nconst struct input_keymap_entry *ke,\r\nunsigned int *old_keycode)\r\n{\r\nstruct ati_remote2 *ar2 = input_get_drvdata(idev);\r\nunsigned int mode;\r\nint offset;\r\nunsigned int index;\r\nunsigned int scancode;\r\nif (ke->flags & INPUT_KEYMAP_BY_INDEX) {\r\nif (ke->index >= ATI_REMOTE2_MODES *\r\nARRAY_SIZE(ati_remote2_key_table))\r\nreturn -EINVAL;\r\nmode = ke->index / ARRAY_SIZE(ati_remote2_key_table);\r\noffset = ke->index % ARRAY_SIZE(ati_remote2_key_table);\r\n} else {\r\nif (input_scancode_to_scalar(ke, &scancode))\r\nreturn -EINVAL;\r\nmode = scancode >> 8;\r\nif (mode > ATI_REMOTE2_PC)\r\nreturn -EINVAL;\r\noffset = ati_remote2_lookup(scancode & 0xff);\r\nif (offset < 0)\r\nreturn -EINVAL;\r\n}\r\n*old_keycode = ar2->keycode[mode][offset];\r\nar2->keycode[mode][offset] = ke->keycode;\r\n__set_bit(ke->keycode, idev->keybit);\r\nfor (mode = 0; mode < ATI_REMOTE2_MODES; mode++) {\r\nfor (index = 0; index < ARRAY_SIZE(ati_remote2_key_table); index++) {\r\nif (ar2->keycode[mode][index] == *old_keycode)\r\nreturn 0;\r\n}\r\n}\r\n__clear_bit(*old_keycode, idev->keybit);\r\nreturn 0;\r\n}\r\nstatic int ati_remote2_input_init(struct ati_remote2 *ar2)\r\n{\r\nstruct input_dev *idev;\r\nint index, mode, retval;\r\nidev = input_allocate_device();\r\nif (!idev)\r\nreturn -ENOMEM;\r\nar2->idev = idev;\r\ninput_set_drvdata(idev, ar2);\r\nidev->evbit[0] = BIT_MASK(EV_KEY) | BIT_MASK(EV_REP) | BIT_MASK(EV_REL);\r\nidev->keybit[BIT_WORD(BTN_MOUSE)] = BIT_MASK(BTN_LEFT) |\r\nBIT_MASK(BTN_RIGHT);\r\nidev->relbit[0] = BIT_MASK(REL_X) | BIT_MASK(REL_Y);\r\nfor (mode = 0; mode < ATI_REMOTE2_MODES; mode++) {\r\nfor (index = 0; index < ARRAY_SIZE(ati_remote2_key_table); index++) {\r\nar2->keycode[mode][index] = ati_remote2_key_table[index].keycode;\r\n__set_bit(ar2->keycode[mode][index], idev->keybit);\r\n}\r\n}\r\nindex = ati_remote2_lookup(0x3f);\r\nar2->keycode[ATI_REMOTE2_AUX1][index] = KEY_PROG1;\r\nar2->keycode[ATI_REMOTE2_AUX2][index] = KEY_PROG2;\r\nar2->keycode[ATI_REMOTE2_AUX3][index] = KEY_PROG3;\r\nar2->keycode[ATI_REMOTE2_AUX4][index] = KEY_PROG4;\r\nar2->keycode[ATI_REMOTE2_PC][index] = KEY_PC;\r\n__set_bit(KEY_PROG1, idev->keybit);\r\n__set_bit(KEY_PROG2, idev->keybit);\r\n__set_bit(KEY_PROG3, idev->keybit);\r\n__set_bit(KEY_PROG4, idev->keybit);\r\n__set_bit(KEY_PC, idev->keybit);\r\nidev->rep[REP_DELAY] = 250;\r\nidev->rep[REP_PERIOD] = 33;\r\nidev->open = ati_remote2_open;\r\nidev->close = ati_remote2_close;\r\nidev->getkeycode = ati_remote2_getkeycode;\r\nidev->setkeycode = ati_remote2_setkeycode;\r\nidev->name = ar2->name;\r\nidev->phys = ar2->phys;\r\nusb_to_input_id(ar2->udev, &idev->id);\r\nidev->dev.parent = &ar2->udev->dev;\r\nretval = input_register_device(idev);\r\nif (retval)\r\ninput_free_device(idev);\r\nreturn retval;\r\n}\r\nstatic int ati_remote2_urb_init(struct ati_remote2 *ar2)\r\n{\r\nstruct usb_device *udev = ar2->udev;\r\nint i, pipe, maxp;\r\nfor (i = 0; i < 2; i++) {\r\nar2->buf[i] = usb_alloc_coherent(udev, 4, GFP_KERNEL, &ar2->buf_dma[i]);\r\nif (!ar2->buf[i])\r\nreturn -ENOMEM;\r\nar2->urb[i] = usb_alloc_urb(0, GFP_KERNEL);\r\nif (!ar2->urb[i])\r\nreturn -ENOMEM;\r\npipe = usb_rcvintpipe(udev, ar2->ep[i]->bEndpointAddress);\r\nmaxp = usb_maxpacket(udev, pipe, usb_pipeout(pipe));\r\nmaxp = maxp > 4 ? 4 : maxp;\r\nusb_fill_int_urb(ar2->urb[i], udev, pipe, ar2->buf[i], maxp,\r\ni ? ati_remote2_complete_key : ati_remote2_complete_mouse,\r\nar2, ar2->ep[i]->bInterval);\r\nar2->urb[i]->transfer_dma = ar2->buf_dma[i];\r\nar2->urb[i]->transfer_flags |= URB_NO_TRANSFER_DMA_MAP;\r\n}\r\nreturn 0;\r\n}\r\nstatic void ati_remote2_urb_cleanup(struct ati_remote2 *ar2)\r\n{\r\nint i;\r\nfor (i = 0; i < 2; i++) {\r\nusb_free_urb(ar2->urb[i]);\r\nusb_free_coherent(ar2->udev, 4, ar2->buf[i], ar2->buf_dma[i]);\r\n}\r\n}\r\nstatic int ati_remote2_setup(struct ati_remote2 *ar2, unsigned int ch_mask)\r\n{\r\nint r, i, channel;\r\nchannel = 0;\r\nfor (i = 0; i < 16; i++) {\r\nif ((1 << i) & ch_mask) {\r\nif (!(~(1 << i) & ch_mask))\r\nchannel = i + 1;\r\nbreak;\r\n}\r\n}\r\nr = usb_control_msg(ar2->udev, usb_sndctrlpipe(ar2->udev, 0),\r\n0x20,\r\nUSB_DIR_OUT | USB_TYPE_VENDOR | USB_RECIP_INTERFACE,\r\nchannel, 0x0, NULL, 0, USB_CTRL_SET_TIMEOUT);\r\nif (r) {\r\ndev_err(&ar2->udev->dev, "%s - failed to set channel due to error: %d\n",\r\n__func__, r);\r\nreturn r;\r\n}\r\nreturn 0;\r\n}\r\nstatic ssize_t ati_remote2_show_channel_mask(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct usb_device *udev = to_usb_device(dev);\r\nstruct usb_interface *intf = usb_ifnum_to_if(udev, 0);\r\nstruct ati_remote2 *ar2 = usb_get_intfdata(intf);\r\nreturn sprintf(buf, "0x%04x\n", ar2->channel_mask);\r\n}\r\nstatic ssize_t ati_remote2_store_channel_mask(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct usb_device *udev = to_usb_device(dev);\r\nstruct usb_interface *intf = usb_ifnum_to_if(udev, 0);\r\nstruct ati_remote2 *ar2 = usb_get_intfdata(intf);\r\nunsigned long mask;\r\nint r;\r\nif (strict_strtoul(buf, 0, &mask))\r\nreturn -EINVAL;\r\nif (mask & ~ATI_REMOTE2_MAX_CHANNEL_MASK)\r\nreturn -EINVAL;\r\nr = usb_autopm_get_interface(ar2->intf[0]);\r\nif (r) {\r\ndev_err(&ar2->intf[0]->dev,\r\n"%s(): usb_autopm_get_interface() = %d\n", __func__, r);\r\nreturn r;\r\n}\r\nmutex_lock(&ati_remote2_mutex);\r\nif (mask != ar2->channel_mask) {\r\nr = ati_remote2_setup(ar2, mask);\r\nif (!r)\r\nar2->channel_mask = mask;\r\n}\r\nmutex_unlock(&ati_remote2_mutex);\r\nusb_autopm_put_interface(ar2->intf[0]);\r\nreturn r ? r : count;\r\n}\r\nstatic ssize_t ati_remote2_show_mode_mask(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct usb_device *udev = to_usb_device(dev);\r\nstruct usb_interface *intf = usb_ifnum_to_if(udev, 0);\r\nstruct ati_remote2 *ar2 = usb_get_intfdata(intf);\r\nreturn sprintf(buf, "0x%02x\n", ar2->mode_mask);\r\n}\r\nstatic ssize_t ati_remote2_store_mode_mask(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct usb_device *udev = to_usb_device(dev);\r\nstruct usb_interface *intf = usb_ifnum_to_if(udev, 0);\r\nstruct ati_remote2 *ar2 = usb_get_intfdata(intf);\r\nunsigned long mask;\r\nif (strict_strtoul(buf, 0, &mask))\r\nreturn -EINVAL;\r\nif (mask & ~ATI_REMOTE2_MAX_MODE_MASK)\r\nreturn -EINVAL;\r\nar2->mode_mask = mask;\r\nreturn count;\r\n}\r\nstatic int ati_remote2_probe(struct usb_interface *interface, const struct usb_device_id *id)\r\n{\r\nstruct usb_device *udev = interface_to_usbdev(interface);\r\nstruct usb_host_interface *alt = interface->cur_altsetting;\r\nstruct ati_remote2 *ar2;\r\nint r;\r\nif (alt->desc.bInterfaceNumber)\r\nreturn -ENODEV;\r\nar2 = kzalloc(sizeof (struct ati_remote2), GFP_KERNEL);\r\nif (!ar2)\r\nreturn -ENOMEM;\r\nar2->udev = udev;\r\nar2->intf[0] = interface;\r\nar2->ep[0] = &alt->endpoint[0].desc;\r\nar2->intf[1] = usb_ifnum_to_if(udev, 1);\r\nr = usb_driver_claim_interface(&ati_remote2_driver, ar2->intf[1], ar2);\r\nif (r)\r\ngoto fail1;\r\nalt = ar2->intf[1]->cur_altsetting;\r\nar2->ep[1] = &alt->endpoint[0].desc;\r\nr = ati_remote2_urb_init(ar2);\r\nif (r)\r\ngoto fail2;\r\nar2->channel_mask = channel_mask;\r\nar2->mode_mask = mode_mask;\r\nr = ati_remote2_setup(ar2, ar2->channel_mask);\r\nif (r)\r\ngoto fail2;\r\nusb_make_path(udev, ar2->phys, sizeof(ar2->phys));\r\nstrlcat(ar2->phys, "/input0", sizeof(ar2->phys));\r\nstrlcat(ar2->name, "ATI Remote Wonder II", sizeof(ar2->name));\r\nr = sysfs_create_group(&udev->dev.kobj, &ati_remote2_attr_group);\r\nif (r)\r\ngoto fail2;\r\nr = ati_remote2_input_init(ar2);\r\nif (r)\r\ngoto fail3;\r\nusb_set_intfdata(interface, ar2);\r\ninterface->needs_remote_wakeup = 1;\r\nreturn 0;\r\nfail3:\r\nsysfs_remove_group(&udev->dev.kobj, &ati_remote2_attr_group);\r\nfail2:\r\nati_remote2_urb_cleanup(ar2);\r\nusb_driver_release_interface(&ati_remote2_driver, ar2->intf[1]);\r\nfail1:\r\nkfree(ar2);\r\nreturn r;\r\n}\r\nstatic void ati_remote2_disconnect(struct usb_interface *interface)\r\n{\r\nstruct ati_remote2 *ar2;\r\nstruct usb_host_interface *alt = interface->cur_altsetting;\r\nif (alt->desc.bInterfaceNumber)\r\nreturn;\r\nar2 = usb_get_intfdata(interface);\r\nusb_set_intfdata(interface, NULL);\r\ninput_unregister_device(ar2->idev);\r\nsysfs_remove_group(&ar2->udev->dev.kobj, &ati_remote2_attr_group);\r\nati_remote2_urb_cleanup(ar2);\r\nusb_driver_release_interface(&ati_remote2_driver, ar2->intf[1]);\r\nkfree(ar2);\r\n}\r\nstatic int ati_remote2_suspend(struct usb_interface *interface,\r\npm_message_t message)\r\n{\r\nstruct ati_remote2 *ar2;\r\nstruct usb_host_interface *alt = interface->cur_altsetting;\r\nif (alt->desc.bInterfaceNumber)\r\nreturn 0;\r\nar2 = usb_get_intfdata(interface);\r\ndev_dbg(&ar2->intf[0]->dev, "%s()\n", __func__);\r\nmutex_lock(&ati_remote2_mutex);\r\nif (ar2->flags & ATI_REMOTE2_OPENED)\r\nati_remote2_kill_urbs(ar2);\r\nar2->flags |= ATI_REMOTE2_SUSPENDED;\r\nmutex_unlock(&ati_remote2_mutex);\r\nreturn 0;\r\n}\r\nstatic int ati_remote2_resume(struct usb_interface *interface)\r\n{\r\nstruct ati_remote2 *ar2;\r\nstruct usb_host_interface *alt = interface->cur_altsetting;\r\nint r = 0;\r\nif (alt->desc.bInterfaceNumber)\r\nreturn 0;\r\nar2 = usb_get_intfdata(interface);\r\ndev_dbg(&ar2->intf[0]->dev, "%s()\n", __func__);\r\nmutex_lock(&ati_remote2_mutex);\r\nif (ar2->flags & ATI_REMOTE2_OPENED)\r\nr = ati_remote2_submit_urbs(ar2);\r\nif (!r)\r\nar2->flags &= ~ATI_REMOTE2_SUSPENDED;\r\nmutex_unlock(&ati_remote2_mutex);\r\nreturn r;\r\n}\r\nstatic int ati_remote2_reset_resume(struct usb_interface *interface)\r\n{\r\nstruct ati_remote2 *ar2;\r\nstruct usb_host_interface *alt = interface->cur_altsetting;\r\nint r = 0;\r\nif (alt->desc.bInterfaceNumber)\r\nreturn 0;\r\nar2 = usb_get_intfdata(interface);\r\ndev_dbg(&ar2->intf[0]->dev, "%s()\n", __func__);\r\nmutex_lock(&ati_remote2_mutex);\r\nr = ati_remote2_setup(ar2, ar2->channel_mask);\r\nif (r)\r\ngoto out;\r\nif (ar2->flags & ATI_REMOTE2_OPENED)\r\nr = ati_remote2_submit_urbs(ar2);\r\nif (!r)\r\nar2->flags &= ~ATI_REMOTE2_SUSPENDED;\r\nout:\r\nmutex_unlock(&ati_remote2_mutex);\r\nreturn r;\r\n}\r\nstatic int ati_remote2_pre_reset(struct usb_interface *interface)\r\n{\r\nstruct ati_remote2 *ar2;\r\nstruct usb_host_interface *alt = interface->cur_altsetting;\r\nif (alt->desc.bInterfaceNumber)\r\nreturn 0;\r\nar2 = usb_get_intfdata(interface);\r\ndev_dbg(&ar2->intf[0]->dev, "%s()\n", __func__);\r\nmutex_lock(&ati_remote2_mutex);\r\nif (ar2->flags == ATI_REMOTE2_OPENED)\r\nati_remote2_kill_urbs(ar2);\r\nreturn 0;\r\n}\r\nstatic int ati_remote2_post_reset(struct usb_interface *interface)\r\n{\r\nstruct ati_remote2 *ar2;\r\nstruct usb_host_interface *alt = interface->cur_altsetting;\r\nint r = 0;\r\nif (alt->desc.bInterfaceNumber)\r\nreturn 0;\r\nar2 = usb_get_intfdata(interface);\r\ndev_dbg(&ar2->intf[0]->dev, "%s()\n", __func__);\r\nif (ar2->flags == ATI_REMOTE2_OPENED)\r\nr = ati_remote2_submit_urbs(ar2);\r\nmutex_unlock(&ati_remote2_mutex);\r\nreturn r;\r\n}\r\nstatic int __init ati_remote2_init(void)\r\n{\r\nint r;\r\nr = usb_register(&ati_remote2_driver);\r\nif (r)\r\nprintk(KERN_ERR "ati_remote2: usb_register() = %d\n", r);\r\nelse\r\nprintk(KERN_INFO "ati_remote2: " DRIVER_DESC " " DRIVER_VERSION "\n");\r\nreturn r;\r\n}\r\nstatic void __exit ati_remote2_exit(void)\r\n{\r\nusb_deregister(&ati_remote2_driver);\r\n}

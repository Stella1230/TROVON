static int ttusb2_msg(struct dvb_usb_device *d, u8 cmd,\r\nu8 *wbuf, int wlen, u8 *rbuf, int rlen)\r\n{\r\nstruct ttusb2_state *st = d->priv;\r\nu8 s[wlen+4],r[64] = { 0 };\r\nint ret = 0;\r\nmemset(s,0,wlen+4);\r\ns[0] = 0xaa;\r\ns[1] = ++st->id;\r\ns[2] = cmd;\r\ns[3] = wlen;\r\nmemcpy(&s[4],wbuf,wlen);\r\nret = dvb_usb_generic_rw(d, s, wlen+4, r, 64, 0);\r\nif (ret != 0 ||\r\nr[0] != 0x55 ||\r\nr[1] != s[1] ||\r\nr[2] != cmd ||\r\n(rlen > 0 && r[3] != rlen)) {\r\nwarn("there might have been an error during control message transfer. (rlen = %d, was %d)",rlen,r[3]);\r\nreturn -EIO;\r\n}\r\nif (rlen > 0)\r\nmemcpy(rbuf, &r[4], rlen);\r\nreturn 0;\r\n}\r\nstatic int ttusb2_i2c_xfer(struct i2c_adapter *adap,struct i2c_msg msg[],int num)\r\n{\r\nstruct dvb_usb_device *d = i2c_get_adapdata(adap);\r\nstatic u8 obuf[60], ibuf[60];\r\nint i,read;\r\nif (mutex_lock_interruptible(&d->i2c_mutex) < 0)\r\nreturn -EAGAIN;\r\nif (num > 2)\r\nwarn("more than 2 i2c messages at a time is not handled yet. TODO.");\r\nfor (i = 0; i < num; i++) {\r\nread = i+1 < num && (msg[i+1].flags & I2C_M_RD);\r\nobuf[0] = (msg[i].addr << 1) | read;\r\nobuf[1] = msg[i].len;\r\nif (read)\r\nobuf[2] = msg[i+1].len;\r\nelse\r\nobuf[2] = 0;\r\nmemcpy(&obuf[3],msg[i].buf,msg[i].len);\r\nif (ttusb2_msg(d, CMD_I2C_XFER, obuf, msg[i].len+3, ibuf, obuf[2] + 3) < 0) {\r\nerr("i2c transfer failed.");\r\nbreak;\r\n}\r\nif (read) {\r\nmemcpy(msg[i+1].buf,&ibuf[3],msg[i+1].len);\r\ni++;\r\n}\r\n}\r\nmutex_unlock(&d->i2c_mutex);\r\nreturn i;\r\n}\r\nstatic u32 ttusb2_i2c_func(struct i2c_adapter *adapter)\r\n{\r\nreturn I2C_FUNC_I2C;\r\n}\r\nstatic int tt3650_rc_query(struct dvb_usb_device *d)\r\n{\r\nint ret;\r\nu8 rx[9];\r\nstruct ttusb2_state *st = d->priv;\r\nret = ttusb2_msg(d, CMD_GET_IR_CODE, NULL, 0, rx, sizeof(rx));\r\nif (ret != 0)\r\nreturn ret;\r\nif (rx[8] & 0x01) {\r\nst->last_rc_key = (rx[3] << 8) | rx[2];\r\ndeb_info("%s: cmd=0x%02x sys=0x%02x\n", __func__, rx[2], rx[3]);\r\nrc_keydown(d->rc_dev, st->last_rc_key, 0);\r\n} else if (st->last_rc_key) {\r\nrc_keyup(d->rc_dev);\r\nst->last_rc_key = 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ttusb2_identify_state (struct usb_device *udev, struct\r\ndvb_usb_device_properties *props, struct dvb_usb_device_description **desc,\r\nint *cold)\r\n{\r\n*cold = udev->descriptor.iManufacturer == 0 && udev->descriptor.iProduct == 0;\r\nreturn 0;\r\n}\r\nstatic int ttusb2_power_ctrl(struct dvb_usb_device *d, int onoff)\r\n{\r\nu8 b = onoff;\r\nttusb2_msg(d, CMD_POWER, &b, 0, NULL, 0);\r\nreturn ttusb2_msg(d, CMD_POWER, &b, 1, NULL, 0);\r\n}\r\nstatic int ttusb2_frontend_tda10086_attach(struct dvb_usb_adapter *adap)\r\n{\r\nif (usb_set_interface(adap->dev->udev,0,3) < 0)\r\nerr("set interface to alts=3 failed");\r\nif ((adap->fe = dvb_attach(tda10086_attach, &tda10086_config, &adap->dev->i2c_adap)) == NULL) {\r\ndeb_info("TDA10086 attach failed\n");\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ttusb2_frontend_tda10023_attach(struct dvb_usb_adapter *adap)\r\n{\r\nif (usb_set_interface(adap->dev->udev, 0, 3) < 0)\r\nerr("set interface to alts=3 failed");\r\nif ((adap->fe = dvb_attach(tda10023_attach, &tda10023_config, &adap->dev->i2c_adap, 0x48)) == NULL) {\r\ndeb_info("TDA10023 attach failed\n");\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ttusb2_tuner_tda827x_attach(struct dvb_usb_adapter *adap)\r\n{\r\nif (dvb_attach(tda827x_attach, adap->fe, 0x61, &adap->dev->i2c_adap, NULL) == NULL) {\r\nprintk(KERN_ERR "%s: No tda827x found!\n", __func__);\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ttusb2_tuner_tda826x_attach(struct dvb_usb_adapter *adap)\r\n{\r\nif (dvb_attach(tda826x_attach, adap->fe, 0x60, &adap->dev->i2c_adap, 0) == NULL) {\r\ndeb_info("TDA8263 attach failed\n");\r\nreturn -ENODEV;\r\n}\r\nif (dvb_attach(lnbp21_attach, adap->fe, &adap->dev->i2c_adap, 0, 0) == NULL) {\r\ndeb_info("LNBP21 attach failed\n");\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ttusb2_probe(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nif (0 == dvb_usb_device_init(intf, &ttusb2_properties,\r\nTHIS_MODULE, NULL, adapter_nr) ||\r\n0 == dvb_usb_device_init(intf, &ttusb2_properties_s2400,\r\nTHIS_MODULE, NULL, adapter_nr) ||\r\n0 == dvb_usb_device_init(intf, &ttusb2_properties_ct3650,\r\nTHIS_MODULE, NULL, adapter_nr))\r\nreturn 0;\r\nreturn -ENODEV;\r\n}\r\nstatic int __init ttusb2_module_init(void)\r\n{\r\nint result;\r\nif ((result = usb_register(&ttusb2_driver))) {\r\nerr("usb_register failed. Error number %d",result);\r\nreturn result;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit ttusb2_module_exit(void)\r\n{\r\nusb_deregister(&ttusb2_driver);\r\n}

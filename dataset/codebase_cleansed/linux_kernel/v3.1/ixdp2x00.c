static void ixdp2x00_irq_mask(struct irq_data *d)\r\n{\r\nunsigned long dummy;\r\nstatic struct slowport_cfg old_cfg;\r\n#ifdef CONFIG_ARCH_IXDP2400\r\nif (machine_is_ixdp2400())\r\nixp2000_acquire_slowport(&slowport_cpld_cfg, &old_cfg);\r\n#endif\r\ndummy = *board_irq_mask;\r\ndummy |= IXP2000_BOARD_IRQ_MASK(d->irq);\r\nixp2000_reg_wrb(board_irq_mask, dummy);\r\n#ifdef CONFIG_ARCH_IXDP2400\r\nif (machine_is_ixdp2400())\r\nixp2000_release_slowport(&old_cfg);\r\n#endif\r\n}\r\nstatic void ixdp2x00_irq_unmask(struct irq_data *d)\r\n{\r\nunsigned long dummy;\r\nstatic struct slowport_cfg old_cfg;\r\n#ifdef CONFIG_ARCH_IXDP2400\r\nif (machine_is_ixdp2400())\r\nixp2000_acquire_slowport(&slowport_cpld_cfg, &old_cfg);\r\n#endif\r\ndummy = *board_irq_mask;\r\ndummy &= ~IXP2000_BOARD_IRQ_MASK(d->irq);\r\nixp2000_reg_wrb(board_irq_mask, dummy);\r\nif (machine_is_ixdp2400())\r\nixp2000_release_slowport(&old_cfg);\r\n}\r\nstatic void ixdp2x00_irq_handler(unsigned int irq, struct irq_desc *desc)\r\n{\r\nvolatile u32 ex_interrupt = 0;\r\nstatic struct slowport_cfg old_cfg;\r\nint i;\r\ndesc->irq_data.chip->irq_mask(&desc->irq_data);\r\n#ifdef CONFIG_ARCH_IXDP2400\r\nif (machine_is_ixdp2400())\r\nixp2000_acquire_slowport(&slowport_cpld_cfg, &old_cfg);\r\n#endif\r\nex_interrupt = *board_irq_stat & 0xff;\r\nif (machine_is_ixdp2400())\r\nixp2000_release_slowport(&old_cfg);\r\nif(!ex_interrupt) {\r\nprintk(KERN_ERR "Spurious IXDP2x00 CPLD interrupt!\n");\r\nreturn;\r\n}\r\nfor(i = 0; i < board_irq_count; i++) {\r\nif(ex_interrupt & (1 << i)) {\r\nint cpld_irq = IXP2000_BOARD_IRQ(0) + i;\r\ngeneric_handle_irq(cpld_irq);\r\n}\r\n}\r\ndesc->irq_data.chip->irq_unmask(&desc->irq_data);\r\n}\r\nvoid __init ixdp2x00_init_irq(volatile unsigned long *stat_reg, volatile unsigned long *mask_reg, unsigned long nr_of_irqs)\r\n{\r\nunsigned int irq;\r\nixp2000_init_irq();\r\nif (!ixdp2x00_master_npu())\r\nreturn;\r\nboard_irq_stat = stat_reg;\r\nboard_irq_mask = mask_reg;\r\nboard_irq_count = nr_of_irqs;\r\n*board_irq_mask = 0xffffffff;\r\nfor(irq = IXP2000_BOARD_IRQ(0); irq < IXP2000_BOARD_IRQ(board_irq_count); irq++) {\r\nirq_set_chip_and_handler(irq, &ixdp2x00_cpld_irq_chip,\r\nhandle_level_irq);\r\nset_irq_flags(irq, IRQF_VALID);\r\n}\r\nirq_set_chained_handler(IRQ_IXP2000_PCIB, ixdp2x00_irq_handler);\r\n}\r\nvoid __init ixdp2x00_map_io(void)\r\n{\r\nixp2000_map_io();\r\niotable_init(&ixdp2x00_io_desc, 1);\r\n}\r\nvoid ixdp2x00_slave_pci_postinit(void)\r\n{\r\nstruct pci_dev *dev;\r\nif((dev = pci_get_bus_and_slot(1, IXDP2X00_PMC_DEVFN))) {\r\npci_remove_bus_device(dev);\r\npci_dev_put(dev);\r\n}\r\ndev = pci_get_bus_and_slot(0, IXDP2X00_21555_DEVFN);\r\npci_remove_bus_device(dev);\r\npci_dev_put(dev);\r\n}\r\nvoid __init ixdp2x00_init_machine(void)\r\n{\r\ngpio_line_set(IXDP2X00_GPIO_I2C_ENABLE, 1);\r\ngpio_line_config(IXDP2X00_GPIO_I2C_ENABLE, GPIO_OUT);\r\nplatform_add_devices(ixdp2x00_devices, ARRAY_SIZE(ixdp2x00_devices));\r\nixp2000_uart_init();\r\n}

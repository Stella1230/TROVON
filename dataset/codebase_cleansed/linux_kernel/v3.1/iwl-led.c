static inline u8 iwl_legacy_blink_compensation(struct iwl_priv *priv,\r\nu8 time, u16 compensation)\r\n{\r\nif (!compensation) {\r\nIWL_ERR(priv, "undefined blink compensation: "\r\n"use pre-defined blinking time\n");\r\nreturn time;\r\n}\r\nreturn (u8)((time * compensation) >> 6);\r\n}\r\nstatic int iwl_legacy_led_cmd(struct iwl_priv *priv,\r\nunsigned long on,\r\nunsigned long off)\r\n{\r\nstruct iwl_led_cmd led_cmd = {\r\n.id = IWL_LED_LINK,\r\n.interval = IWL_DEF_LED_INTRVL\r\n};\r\nint ret;\r\nif (!test_bit(STATUS_READY, &priv->status))\r\nreturn -EBUSY;\r\nif (priv->blink_on == on && priv->blink_off == off)\r\nreturn 0;\r\nif (off == 0) {\r\non = IWL_LED_SOLID;\r\n}\r\nIWL_DEBUG_LED(priv, "Led blink time compensation=%u\n",\r\npriv->cfg->base_params->led_compensation);\r\nled_cmd.on = iwl_legacy_blink_compensation(priv, on,\r\npriv->cfg->base_params->led_compensation);\r\nled_cmd.off = iwl_legacy_blink_compensation(priv, off,\r\npriv->cfg->base_params->led_compensation);\r\nret = priv->cfg->ops->led->cmd(priv, &led_cmd);\r\nif (!ret) {\r\npriv->blink_on = on;\r\npriv->blink_off = off;\r\n}\r\nreturn ret;\r\n}\r\nstatic void iwl_legacy_led_brightness_set(struct led_classdev *led_cdev,\r\nenum led_brightness brightness)\r\n{\r\nstruct iwl_priv *priv = container_of(led_cdev, struct iwl_priv, led);\r\nunsigned long on = 0;\r\nif (brightness > 0)\r\non = IWL_LED_SOLID;\r\niwl_legacy_led_cmd(priv, on, 0);\r\n}\r\nstatic int iwl_legacy_led_blink_set(struct led_classdev *led_cdev,\r\nunsigned long *delay_on,\r\nunsigned long *delay_off)\r\n{\r\nstruct iwl_priv *priv = container_of(led_cdev, struct iwl_priv, led);\r\nreturn iwl_legacy_led_cmd(priv, *delay_on, *delay_off);\r\n}\r\nvoid iwl_legacy_leds_init(struct iwl_priv *priv)\r\n{\r\nint mode = led_mode;\r\nint ret;\r\nif (mode == IWL_LED_DEFAULT)\r\nmode = priv->cfg->led_mode;\r\npriv->led.name = kasprintf(GFP_KERNEL, "%s-led",\r\nwiphy_name(priv->hw->wiphy));\r\npriv->led.brightness_set = iwl_legacy_led_brightness_set;\r\npriv->led.blink_set = iwl_legacy_led_blink_set;\r\npriv->led.max_brightness = 1;\r\nswitch (mode) {\r\ncase IWL_LED_DEFAULT:\r\nWARN_ON(1);\r\nbreak;\r\ncase IWL_LED_BLINK:\r\npriv->led.default_trigger =\r\nieee80211_create_tpt_led_trigger(priv->hw,\r\nIEEE80211_TPT_LEDTRIG_FL_CONNECTED,\r\niwl_blink, ARRAY_SIZE(iwl_blink));\r\nbreak;\r\ncase IWL_LED_RF_STATE:\r\npriv->led.default_trigger =\r\nieee80211_get_radio_led_name(priv->hw);\r\nbreak;\r\n}\r\nret = led_classdev_register(&priv->pci_dev->dev, &priv->led);\r\nif (ret) {\r\nkfree(priv->led.name);\r\nreturn;\r\n}\r\npriv->led_registered = true;\r\n}\r\nvoid iwl_legacy_leds_exit(struct iwl_priv *priv)\r\n{\r\nif (!priv->led_registered)\r\nreturn;\r\nled_classdev_unregister(&priv->led);\r\nkfree(priv->led.name);\r\n}

static inline struct panel_generic_dpi_data\r\n*get_panel_data(const struct omap_dss_device *dssdev)\r\n{\r\nreturn (struct panel_generic_dpi_data *) dssdev->data;\r\n}\r\nstatic int generic_dpi_panel_power_on(struct omap_dss_device *dssdev)\r\n{\r\nint r;\r\nstruct panel_generic_dpi_data *panel_data = get_panel_data(dssdev);\r\nstruct panel_drv_data *drv_data = dev_get_drvdata(&dssdev->dev);\r\nstruct panel_config *panel_config = drv_data->panel_config;\r\nif (dssdev->state == OMAP_DSS_DISPLAY_ACTIVE)\r\nreturn 0;\r\nr = omapdss_dpi_display_enable(dssdev);\r\nif (r)\r\ngoto err0;\r\nif (panel_config->power_on_delay)\r\nmsleep(panel_config->power_on_delay);\r\nif (panel_data->platform_enable) {\r\nr = panel_data->platform_enable(dssdev);\r\nif (r)\r\ngoto err1;\r\n}\r\nreturn 0;\r\nerr1:\r\nomapdss_dpi_display_disable(dssdev);\r\nerr0:\r\nreturn r;\r\n}\r\nstatic void generic_dpi_panel_power_off(struct omap_dss_device *dssdev)\r\n{\r\nstruct panel_generic_dpi_data *panel_data = get_panel_data(dssdev);\r\nstruct panel_drv_data *drv_data = dev_get_drvdata(&dssdev->dev);\r\nstruct panel_config *panel_config = drv_data->panel_config;\r\nif (dssdev->state != OMAP_DSS_DISPLAY_ACTIVE)\r\nreturn;\r\nif (panel_data->platform_disable)\r\npanel_data->platform_disable(dssdev);\r\nif (panel_config->power_off_delay)\r\nmsleep(panel_config->power_off_delay);\r\nomapdss_dpi_display_disable(dssdev);\r\n}\r\nstatic int generic_dpi_panel_probe(struct omap_dss_device *dssdev)\r\n{\r\nstruct panel_generic_dpi_data *panel_data = get_panel_data(dssdev);\r\nstruct panel_config *panel_config = NULL;\r\nstruct panel_drv_data *drv_data = NULL;\r\nint i;\r\ndev_dbg(&dssdev->dev, "probe\n");\r\nif (!panel_data || !panel_data->name)\r\nreturn -EINVAL;\r\nfor (i = 0; i < ARRAY_SIZE(generic_dpi_panels); i++) {\r\nif (strcmp(panel_data->name, generic_dpi_panels[i].name) == 0) {\r\npanel_config = &generic_dpi_panels[i];\r\nbreak;\r\n}\r\n}\r\nif (!panel_config)\r\nreturn -EINVAL;\r\ndssdev->panel.config = panel_config->config;\r\ndssdev->panel.timings = panel_config->timings;\r\ndssdev->panel.acb = panel_config->acb;\r\ndssdev->panel.acbi = panel_config->acbi;\r\ndrv_data = kzalloc(sizeof(*drv_data), GFP_KERNEL);\r\nif (!drv_data)\r\nreturn -ENOMEM;\r\ndrv_data->dssdev = dssdev;\r\ndrv_data->panel_config = panel_config;\r\ndev_set_drvdata(&dssdev->dev, drv_data);\r\nreturn 0;\r\n}\r\nstatic void __exit generic_dpi_panel_remove(struct omap_dss_device *dssdev)\r\n{\r\nstruct panel_drv_data *drv_data = dev_get_drvdata(&dssdev->dev);\r\ndev_dbg(&dssdev->dev, "remove\n");\r\nkfree(drv_data);\r\ndev_set_drvdata(&dssdev->dev, NULL);\r\n}\r\nstatic int generic_dpi_panel_enable(struct omap_dss_device *dssdev)\r\n{\r\nint r = 0;\r\nr = generic_dpi_panel_power_on(dssdev);\r\nif (r)\r\nreturn r;\r\ndssdev->state = OMAP_DSS_DISPLAY_ACTIVE;\r\nreturn 0;\r\n}\r\nstatic void generic_dpi_panel_disable(struct omap_dss_device *dssdev)\r\n{\r\ngeneric_dpi_panel_power_off(dssdev);\r\ndssdev->state = OMAP_DSS_DISPLAY_DISABLED;\r\n}\r\nstatic int generic_dpi_panel_suspend(struct omap_dss_device *dssdev)\r\n{\r\ngeneric_dpi_panel_power_off(dssdev);\r\ndssdev->state = OMAP_DSS_DISPLAY_SUSPENDED;\r\nreturn 0;\r\n}\r\nstatic int generic_dpi_panel_resume(struct omap_dss_device *dssdev)\r\n{\r\nint r = 0;\r\nr = generic_dpi_panel_power_on(dssdev);\r\nif (r)\r\nreturn r;\r\ndssdev->state = OMAP_DSS_DISPLAY_ACTIVE;\r\nreturn 0;\r\n}\r\nstatic void generic_dpi_panel_set_timings(struct omap_dss_device *dssdev,\r\nstruct omap_video_timings *timings)\r\n{\r\ndpi_set_timings(dssdev, timings);\r\n}\r\nstatic void generic_dpi_panel_get_timings(struct omap_dss_device *dssdev,\r\nstruct omap_video_timings *timings)\r\n{\r\n*timings = dssdev->panel.timings;\r\n}\r\nstatic int generic_dpi_panel_check_timings(struct omap_dss_device *dssdev,\r\nstruct omap_video_timings *timings)\r\n{\r\nreturn dpi_check_timings(dssdev, timings);\r\n}\r\nstatic int __init generic_dpi_panel_drv_init(void)\r\n{\r\nreturn omap_dss_register_driver(&dpi_driver);\r\n}\r\nstatic void __exit generic_dpi_panel_drv_exit(void)\r\n{\r\nomap_dss_unregister_driver(&dpi_driver);\r\n}

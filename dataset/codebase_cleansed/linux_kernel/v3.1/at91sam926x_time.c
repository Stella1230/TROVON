static cycle_t read_pit_clk(struct clocksource *cs)\r\n{\r\nunsigned long flags;\r\nu32 elapsed;\r\nu32 t;\r\nraw_local_irq_save(flags);\r\nelapsed = pit_cnt;\r\nt = at91_sys_read(AT91_PIT_PIIR);\r\nraw_local_irq_restore(flags);\r\nelapsed += PIT_PICNT(t) * pit_cycle;\r\nelapsed += PIT_CPIV(t);\r\nreturn elapsed;\r\n}\r\nstatic void\r\npit_clkevt_mode(enum clock_event_mode mode, struct clock_event_device *dev)\r\n{\r\nswitch (mode) {\r\ncase CLOCK_EVT_MODE_PERIODIC:\r\npit_cnt += pit_cycle * PIT_PICNT(at91_sys_read(AT91_PIT_PIVR));\r\nat91_sys_write(AT91_PIT_MR, (pit_cycle - 1) | AT91_PIT_PITEN\r\n| AT91_PIT_PITIEN);\r\nbreak;\r\ncase CLOCK_EVT_MODE_ONESHOT:\r\nBUG();\r\ncase CLOCK_EVT_MODE_SHUTDOWN:\r\ncase CLOCK_EVT_MODE_UNUSED:\r\nat91_sys_write(AT91_PIT_MR, (pit_cycle - 1) | AT91_PIT_PITEN);\r\nbreak;\r\ncase CLOCK_EVT_MODE_RESUME:\r\nbreak;\r\n}\r\n}\r\nstatic irqreturn_t at91sam926x_pit_interrupt(int irq, void *dev_id)\r\n{\r\nWARN_ON_ONCE(!irqs_disabled());\r\nif ((pit_clkevt.mode == CLOCK_EVT_MODE_PERIODIC)\r\n&& (at91_sys_read(AT91_PIT_SR) & AT91_PIT_PITS)) {\r\nunsigned nr_ticks;\r\nnr_ticks = PIT_PICNT(at91_sys_read(AT91_PIT_PIVR));\r\ndo {\r\npit_cnt += pit_cycle;\r\npit_clkevt.event_handler(&pit_clkevt);\r\nnr_ticks--;\r\n} while (nr_ticks);\r\nreturn IRQ_HANDLED;\r\n}\r\nreturn IRQ_NONE;\r\n}\r\nstatic void at91sam926x_pit_reset(void)\r\n{\r\nat91_sys_write(AT91_PIT_MR, 0);\r\nwhile (PIT_CPIV(at91_sys_read(AT91_PIT_PIVR)) != 0)\r\ncpu_relax();\r\nat91_sys_write(AT91_PIT_MR, (pit_cycle - 1) | AT91_PIT_PITEN);\r\n}\r\nstatic void __init at91sam926x_pit_init(void)\r\n{\r\nunsigned long pit_rate;\r\nunsigned bits;\r\npit_rate = clk_get_rate(clk_get(NULL, "mck")) / 16;\r\npit_cycle = (pit_rate + HZ/2) / HZ;\r\nWARN_ON(((pit_cycle - 1) & ~AT91_PIT_PIV) != 0);\r\nat91sam926x_pit_reset();\r\nbits = 12 + ilog2(pit_cycle) ;\r\npit_clk.mask = CLOCKSOURCE_MASK(bits);\r\nclocksource_register_hz(&pit_clk, pit_rate);\r\nsetup_irq(AT91_ID_SYS, &at91sam926x_pit_irq);\r\npit_clkevt.mult = div_sc(pit_rate, NSEC_PER_SEC, pit_clkevt.shift);\r\npit_clkevt.cpumask = cpumask_of(0);\r\nclockevents_register_device(&pit_clkevt);\r\n}\r\nstatic void at91sam926x_pit_suspend(void)\r\n{\r\nat91_sys_write(AT91_PIT_MR, 0);\r\n}

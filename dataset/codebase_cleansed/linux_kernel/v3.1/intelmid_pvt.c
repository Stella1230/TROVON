void period_elapsed(void *mad_substream)\r\n{\r\nstruct snd_pcm_substream *substream = mad_substream;\r\nstruct mad_stream_pvt *stream;\r\nif (!substream || !substream->runtime)\r\nreturn;\r\nstream = substream->runtime->private_data;\r\nif (!stream)\r\nreturn;\r\nif (stream->stream_status != RUNNING)\r\nreturn;\r\npr_debug("calling period elapsed\n");\r\nsnd_pcm_period_elapsed(substream);\r\nreturn;\r\n}\r\nint snd_intelmad_alloc_stream(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_intelmad *intelmaddata = snd_pcm_substream_chip(substream);\r\nstruct mad_stream_pvt *stream = substream->runtime->private_data;\r\nstruct snd_sst_stream_params param = {{{0,},},};\r\nstruct snd_sst_params str_params = {0};\r\nint ret_val;\r\nparam.uc.pcm_params.codec = SST_CODEC_TYPE_PCM;\r\nparam.uc.pcm_params.num_chan = (u8) substream->runtime->channels;\r\nparam.uc.pcm_params.pcm_wd_sz = substream->runtime->sample_bits;\r\nparam.uc.pcm_params.reserved = 0;\r\nparam.uc.pcm_params.sfreq = substream->runtime->rate;\r\nparam.uc.pcm_params.ring_buffer_size =\r\nsnd_pcm_lib_buffer_bytes(substream);\r\nparam.uc.pcm_params.period_count = substream->runtime->period_size;\r\nparam.uc.pcm_params.ring_buffer_addr =\r\nvirt_to_phys(substream->runtime->dma_area);\r\npr_debug("period_cnt = %d\n", param.uc.pcm_params.period_count);\r\npr_debug("sfreq= %d, wd_sz = %d\n",\r\nparam.uc.pcm_params.sfreq, param.uc.pcm_params.pcm_wd_sz);\r\nstr_params.sparams = param;\r\nstr_params.codec = SST_CODEC_TYPE_PCM;\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK) {\r\nstr_params.ops = STREAM_OPS_PLAYBACK;\r\npr_debug("Playbck stream,Device %d\n", stream->device);\r\n} else {\r\nstr_params.ops = STREAM_OPS_CAPTURE;\r\nstream->device = SND_SST_DEVICE_CAPTURE;\r\npr_debug("Capture stream,Device %d\n", stream->device);\r\n}\r\nstr_params.device_type = stream->device;\r\nret_val = intelmaddata->sstdrv_ops->pcm_control->open(&str_params);\r\npr_debug("sst: SST_SND_PLAY/CAPTURE ret_val = %x\n", ret_val);\r\nif (ret_val < 0)\r\nreturn ret_val;\r\nstream->stream_info.str_id = ret_val;\r\nstream->stream_status = INIT;\r\nstream->stream_info.buffer_ptr = 0;\r\npr_debug("str id : %d\n", stream->stream_info.str_id);\r\nreturn ret_val;\r\n}\r\nint snd_intelmad_init_stream(struct snd_pcm_substream *substream)\r\n{\r\nstruct mad_stream_pvt *stream = substream->runtime->private_data;\r\nstruct snd_intelmad *intelmaddata = snd_pcm_substream_chip(substream);\r\nint ret_val;\r\npr_debug("setting buffer ptr param\n");\r\nstream->stream_info.period_elapsed = period_elapsed;\r\nstream->stream_info.mad_substream = substream;\r\nstream->stream_info.buffer_ptr = 0;\r\nstream->stream_info.sfreq = substream->runtime->rate;\r\nret_val = intelmaddata->sstdrv_ops->pcm_control->device_control(\r\nSST_SND_STREAM_INIT, &stream->stream_info);\r\nif (ret_val)\r\npr_err("control_set ret error %d\n", ret_val);\r\nreturn ret_val;\r\n}\r\nint sst_sc_reg_access(struct sc_reg_access *sc_access,\r\nint type, int num_val)\r\n{\r\nint i, retval = 0;\r\nif (type == PMIC_WRITE) {\r\nfor (i = 0; i < num_val; i++) {\r\nretval = intel_scu_ipc_iowrite8(sc_access[i].reg_addr,\r\nsc_access[i].value);\r\nif (retval)\r\ngoto err;\r\n}\r\n} else if (type == PMIC_READ) {\r\nfor (i = 0; i < num_val; i++) {\r\nretval = intel_scu_ipc_ioread8(sc_access[i].reg_addr,\r\n&(sc_access[i].value));\r\nif (retval)\r\ngoto err;\r\n}\r\n} else {\r\nfor (i = 0; i < num_val; i++) {\r\nretval = intel_scu_ipc_update_register(\r\nsc_access[i].reg_addr, sc_access[i].value,\r\nsc_access[i].mask);\r\nif (retval)\r\ngoto err;\r\n}\r\n}\r\nreturn 0;\r\nerr:\r\npr_err("IPC failed for cmd %d, %d\n", retval, type);\r\npr_err("reg:0x%2x addr:0x%2x\n",\r\nsc_access[i].reg_addr, sc_access[i].value);\r\nreturn retval;\r\n}

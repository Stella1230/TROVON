struct pstack *pstack__new(unsigned short max_nr_entries)\r\n{\r\nstruct pstack *self = zalloc((sizeof(*self) +\r\nmax_nr_entries * sizeof(void *)));\r\nif (self != NULL)\r\nself->max_nr_entries = max_nr_entries;\r\nreturn self;\r\n}\r\nvoid pstack__delete(struct pstack *self)\r\n{\r\nfree(self);\r\n}\r\nbool pstack__empty(const struct pstack *self)\r\n{\r\nreturn self->top == 0;\r\n}\r\nvoid pstack__remove(struct pstack *self, void *key)\r\n{\r\nunsigned short i = self->top, last_index = self->top - 1;\r\nwhile (i-- != 0) {\r\nif (self->entries[i] == key) {\r\nif (i < last_index)\r\nmemmove(self->entries + i,\r\nself->entries + i + 1,\r\n(last_index - i) * sizeof(void *));\r\n--self->top;\r\nreturn;\r\n}\r\n}\r\npr_err("%s: %p not on the pstack!\n", __func__, key);\r\n}\r\nvoid pstack__push(struct pstack *self, void *key)\r\n{\r\nif (self->top == self->max_nr_entries) {\r\npr_err("%s: top=%d, overflow!\n", __func__, self->top);\r\nreturn;\r\n}\r\nself->entries[self->top++] = key;\r\n}\r\nvoid *pstack__pop(struct pstack *self)\r\n{\r\nvoid *ret;\r\nif (self->top == 0) {\r\npr_err("%s: underflow!\n", __func__);\r\nreturn NULL;\r\n}\r\nret = self->entries[--self->top];\r\nself->entries[self->top] = NULL;\r\nreturn ret;\r\n}

static int gp8psk_tuned_to_DCII(struct dvb_frontend *fe)\r\n{\r\nstruct gp8psk_fe_state *st = fe->demodulator_priv;\r\nu8 status;\r\ngp8psk_usb_in_op(st->d, GET_8PSK_CONFIG, 0, 0, &status, 1);\r\nreturn status & bmDCtuned;\r\n}\r\nstatic int gp8psk_set_tuner_mode(struct dvb_frontend *fe, int mode)\r\n{\r\nstruct gp8psk_fe_state *state = fe->demodulator_priv;\r\nreturn gp8psk_usb_out_op(state->d, SET_8PSK_CONFIG, mode, 0, NULL, 0);\r\n}\r\nstatic int gp8psk_fe_update_status(struct gp8psk_fe_state *st)\r\n{\r\nu8 buf[6];\r\nif (time_after(jiffies,st->next_status_check)) {\r\ngp8psk_usb_in_op(st->d, GET_SIGNAL_LOCK, 0,0,&st->lock,1);\r\ngp8psk_usb_in_op(st->d, GET_SIGNAL_STRENGTH, 0,0,buf,6);\r\nst->snr = (buf[1]) << 8 | buf[0];\r\nst->next_status_check = jiffies + (st->status_check_interval*HZ)/1000;\r\n}\r\nreturn 0;\r\n}\r\nstatic int gp8psk_fe_read_status(struct dvb_frontend* fe, fe_status_t *status)\r\n{\r\nstruct gp8psk_fe_state *st = fe->demodulator_priv;\r\ngp8psk_fe_update_status(st);\r\nif (st->lock)\r\n*status = FE_HAS_LOCK | FE_HAS_SYNC | FE_HAS_VITERBI | FE_HAS_SIGNAL | FE_HAS_CARRIER;\r\nelse\r\n*status = 0;\r\nif (*status & FE_HAS_LOCK)\r\nst->status_check_interval = 1000;\r\nelse\r\nst->status_check_interval = 100;\r\nreturn 0;\r\n}\r\nstatic int gp8psk_fe_read_ber(struct dvb_frontend* fe, u32 *ber)\r\n{\r\n(void) fe;\r\n*ber = 0;\r\nreturn 0;\r\n}\r\nstatic int gp8psk_fe_read_unc_blocks(struct dvb_frontend* fe, u32 *unc)\r\n{\r\n(void) fe;\r\n*unc = 0;\r\nreturn 0;\r\n}\r\nstatic int gp8psk_fe_read_snr(struct dvb_frontend* fe, u16 *snr)\r\n{\r\nstruct gp8psk_fe_state *st = fe->demodulator_priv;\r\ngp8psk_fe_update_status(st);\r\n*snr = st->snr;\r\nreturn 0;\r\n}\r\nstatic int gp8psk_fe_read_signal_strength(struct dvb_frontend* fe, u16 *strength)\r\n{\r\nstruct gp8psk_fe_state *st = fe->demodulator_priv;\r\ngp8psk_fe_update_status(st);\r\nif (st->snr > 0xf00)\r\n*strength = 0xffff;\r\nelse\r\n*strength = (st->snr << 4) + st->snr;\r\nreturn 0;\r\n}\r\nstatic int gp8psk_fe_get_tune_settings(struct dvb_frontend* fe, struct dvb_frontend_tune_settings *tune)\r\n{\r\ntune->min_delay_ms = 800;\r\nreturn 0;\r\n}\r\nstatic int gp8psk_fe_set_property(struct dvb_frontend *fe,\r\nstruct dtv_property *tvp)\r\n{\r\ndeb_fe("%s(..)\n", __func__);\r\nreturn 0;\r\n}\r\nstatic int gp8psk_fe_get_property(struct dvb_frontend *fe,\r\nstruct dtv_property *tvp)\r\n{\r\ndeb_fe("%s(..)\n", __func__);\r\nreturn 0;\r\n}\r\nstatic int gp8psk_fe_set_frontend(struct dvb_frontend* fe,\r\nstruct dvb_frontend_parameters *fep)\r\n{\r\nstruct gp8psk_fe_state *state = fe->demodulator_priv;\r\nstruct dtv_frontend_properties *c = &fe->dtv_property_cache;\r\nu8 cmd[10];\r\nu32 freq = fep->frequency * 1000;\r\nint gp_product_id = le16_to_cpu(state->d->udev->descriptor.idProduct);\r\ndeb_fe("%s()\n", __func__);\r\ncmd[4] = freq & 0xff;\r\ncmd[5] = (freq >> 8) & 0xff;\r\ncmd[6] = (freq >> 16) & 0xff;\r\ncmd[7] = (freq >> 24) & 0xff;\r\nswitch (c->delivery_system) {\r\ncase SYS_DVBS:\r\nif (c->modulation != QPSK && c->modulation != PSK_8) {\r\ndeb_fe("%s: unsupported modulation selected (%d)\n",\r\n__func__, c->modulation);\r\nreturn -EOPNOTSUPP;\r\n}\r\nc->fec_inner = FEC_AUTO;\r\nbreak;\r\ncase SYS_DVBS2:\r\ndeb_fe("%s: DVB-S2 delivery system selected\n", __func__);\r\nbreak;\r\ndefault:\r\ndeb_fe("%s: unsupported delivery system selected (%d)\n",\r\n__func__, c->delivery_system);\r\nreturn -EOPNOTSUPP;\r\n}\r\ncmd[0] = c->symbol_rate & 0xff;\r\ncmd[1] = (c->symbol_rate >> 8) & 0xff;\r\ncmd[2] = (c->symbol_rate >> 16) & 0xff;\r\ncmd[3] = (c->symbol_rate >> 24) & 0xff;\r\nswitch (c->modulation) {\r\ncase QPSK:\r\nif (gp_product_id == USB_PID_GENPIX_8PSK_REV_1_WARM)\r\nif (gp8psk_tuned_to_DCII(fe))\r\ngp8psk_bcm4500_reload(state->d);\r\nswitch (c->fec_inner) {\r\ncase FEC_1_2:\r\ncmd[9] = 0; break;\r\ncase FEC_2_3:\r\ncmd[9] = 1; break;\r\ncase FEC_3_4:\r\ncmd[9] = 2; break;\r\ncase FEC_5_6:\r\ncmd[9] = 3; break;\r\ncase FEC_7_8:\r\ncmd[9] = 4; break;\r\ncase FEC_AUTO:\r\ncmd[9] = 5; break;\r\ndefault:\r\ncmd[9] = 5; break;\r\n}\r\ncmd[8] = ADV_MOD_DVB_QPSK;\r\nbreak;\r\ncase PSK_8:\r\ncmd[8] = ADV_MOD_TURBO_8PSK;\r\nswitch (c->fec_inner) {\r\ncase FEC_2_3:\r\ncmd[9] = 0; break;\r\ncase FEC_3_4:\r\ncmd[9] = 1; break;\r\ncase FEC_3_5:\r\ncmd[9] = 2; break;\r\ncase FEC_5_6:\r\ncmd[9] = 3; break;\r\ncase FEC_8_9:\r\ncmd[9] = 4; break;\r\ndefault:\r\ncmd[9] = 0; break;\r\n}\r\nbreak;\r\ncase QAM_16:\r\ncmd[8] = ADV_MOD_TURBO_16QAM;\r\ncmd[9] = 0;\r\nbreak;\r\ndefault:\r\ndeb_fe("%s: unsupported modulation selected (%d)\n",\r\n__func__, c->modulation);\r\nreturn -EOPNOTSUPP;\r\n}\r\nif (gp_product_id == USB_PID_GENPIX_8PSK_REV_1_WARM)\r\ngp8psk_set_tuner_mode(fe, 0);\r\ngp8psk_usb_out_op(state->d, TUNE_8PSK, 0, 0, cmd, 10);\r\nstate->lock = 0;\r\nstate->next_status_check = jiffies;\r\nstate->status_check_interval = 200;\r\nreturn 0;\r\n}\r\nstatic int gp8psk_fe_send_diseqc_msg (struct dvb_frontend* fe,\r\nstruct dvb_diseqc_master_cmd *m)\r\n{\r\nstruct gp8psk_fe_state *st = fe->demodulator_priv;\r\ndeb_fe("%s\n",__func__);\r\nif (gp8psk_usb_out_op(st->d,SEND_DISEQC_COMMAND, m->msg[0], 0,\r\nm->msg, m->msg_len)) {\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int gp8psk_fe_send_diseqc_burst (struct dvb_frontend* fe,\r\nfe_sec_mini_cmd_t burst)\r\n{\r\nstruct gp8psk_fe_state *st = fe->demodulator_priv;\r\nu8 cmd;\r\ndeb_fe("%s\n",__func__);\r\ncmd = (burst == SEC_MINI_A) ? 0x00 : 0x01;\r\nif (gp8psk_usb_out_op(st->d,SEND_DISEQC_COMMAND, cmd, 0,\r\n&cmd, 0)) {\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int gp8psk_fe_set_tone (struct dvb_frontend* fe, fe_sec_tone_mode_t tone)\r\n{\r\nstruct gp8psk_fe_state* state = fe->demodulator_priv;\r\nif (gp8psk_usb_out_op(state->d,SET_22KHZ_TONE,\r\n(tone == SEC_TONE_ON), 0, NULL, 0)) {\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int gp8psk_fe_set_voltage (struct dvb_frontend* fe, fe_sec_voltage_t voltage)\r\n{\r\nstruct gp8psk_fe_state* state = fe->demodulator_priv;\r\nif (gp8psk_usb_out_op(state->d,SET_LNB_VOLTAGE,\r\nvoltage == SEC_VOLTAGE_18, 0, NULL, 0)) {\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int gp8psk_fe_enable_high_lnb_voltage(struct dvb_frontend* fe, long onoff)\r\n{\r\nstruct gp8psk_fe_state* state = fe->demodulator_priv;\r\nreturn gp8psk_usb_out_op(state->d, USE_EXTRA_VOLT, onoff, 0,NULL,0);\r\n}\r\nstatic int gp8psk_fe_send_legacy_dish_cmd (struct dvb_frontend* fe, unsigned long sw_cmd)\r\n{\r\nstruct gp8psk_fe_state* state = fe->demodulator_priv;\r\nu8 cmd = sw_cmd & 0x7f;\r\nif (gp8psk_usb_out_op(state->d,SET_DN_SWITCH, cmd, 0,\r\nNULL, 0)) {\r\nreturn -EINVAL;\r\n}\r\nif (gp8psk_usb_out_op(state->d,SET_LNB_VOLTAGE, !!(sw_cmd & 0x80),\r\n0, NULL, 0)) {\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic void gp8psk_fe_release(struct dvb_frontend* fe)\r\n{\r\nstruct gp8psk_fe_state *state = fe->demodulator_priv;\r\nkfree(state);\r\n}\r\nstruct dvb_frontend * gp8psk_fe_attach(struct dvb_usb_device *d)\r\n{\r\nstruct gp8psk_fe_state *s = kzalloc(sizeof(struct gp8psk_fe_state), GFP_KERNEL);\r\nif (s == NULL)\r\ngoto error;\r\ns->d = d;\r\nmemcpy(&s->fe.ops, &gp8psk_fe_ops, sizeof(struct dvb_frontend_ops));\r\ns->fe.demodulator_priv = s;\r\ngoto success;\r\nerror:\r\nreturn NULL;\r\nsuccess:\r\nreturn &s->fe;\r\n}

static inline int check_range(struct max8925_regulator_info *info,\r\nint min_uV, int max_uV)\r\n{\r\nif (min_uV < info->min_uV || min_uV > info->max_uV)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int max8925_list_voltage(struct regulator_dev *rdev, unsigned index)\r\n{\r\nstruct max8925_regulator_info *info = rdev_get_drvdata(rdev);\r\nreturn info->min_uV + index * info->step_uV;\r\n}\r\nstatic int max8925_set_voltage(struct regulator_dev *rdev,\r\nint min_uV, int max_uV, unsigned int *selector)\r\n{\r\nstruct max8925_regulator_info *info = rdev_get_drvdata(rdev);\r\nunsigned char data, mask;\r\nif (check_range(info, min_uV, max_uV)) {\r\ndev_err(info->chip->dev, "invalid voltage range (%d, %d) uV\n",\r\nmin_uV, max_uV);\r\nreturn -EINVAL;\r\n}\r\ndata = (min_uV - info->min_uV + info->step_uV - 1) / info->step_uV;\r\n*selector = data;\r\ndata <<= info->vol_shift;\r\nmask = ((1 << info->vol_nbits) - 1) << info->vol_shift;\r\nreturn max8925_set_bits(info->i2c, info->vol_reg, mask, data);\r\n}\r\nstatic int max8925_get_voltage(struct regulator_dev *rdev)\r\n{\r\nstruct max8925_regulator_info *info = rdev_get_drvdata(rdev);\r\nunsigned char data, mask;\r\nint ret;\r\nret = max8925_reg_read(info->i2c, info->vol_reg);\r\nif (ret < 0)\r\nreturn ret;\r\nmask = ((1 << info->vol_nbits) - 1) << info->vol_shift;\r\ndata = (ret & mask) >> info->vol_shift;\r\nreturn max8925_list_voltage(rdev, data);\r\n}\r\nstatic int max8925_enable(struct regulator_dev *rdev)\r\n{\r\nstruct max8925_regulator_info *info = rdev_get_drvdata(rdev);\r\nreturn max8925_set_bits(info->i2c, info->enable_reg,\r\nOUT_ENABLE << info->enable_bit,\r\nOUT_ENABLE << info->enable_bit);\r\n}\r\nstatic int max8925_disable(struct regulator_dev *rdev)\r\n{\r\nstruct max8925_regulator_info *info = rdev_get_drvdata(rdev);\r\nreturn max8925_set_bits(info->i2c, info->enable_reg,\r\nOUT_ENABLE << info->enable_bit,\r\nOUT_DISABLE << info->enable_bit);\r\n}\r\nstatic int max8925_is_enabled(struct regulator_dev *rdev)\r\n{\r\nstruct max8925_regulator_info *info = rdev_get_drvdata(rdev);\r\nint ret;\r\nret = max8925_reg_read(info->i2c, info->enable_reg);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn ret & (1 << info->enable_bit);\r\n}\r\nstatic int max8925_set_dvm_voltage(struct regulator_dev *rdev, int uV)\r\n{\r\nstruct max8925_regulator_info *info = rdev_get_drvdata(rdev);\r\nunsigned char data, mask;\r\nif (uV < SD1_DVM_VMIN || uV > SD1_DVM_VMAX)\r\nreturn -EINVAL;\r\ndata = (uV - SD1_DVM_VMIN + SD1_DVM_STEP - 1) / SD1_DVM_STEP;\r\ndata <<= SD1_DVM_SHIFT;\r\nmask = 3 << SD1_DVM_SHIFT;\r\nreturn max8925_set_bits(info->i2c, info->enable_reg, mask, data);\r\n}\r\nstatic int max8925_set_dvm_enable(struct regulator_dev *rdev)\r\n{\r\nstruct max8925_regulator_info *info = rdev_get_drvdata(rdev);\r\nreturn max8925_set_bits(info->i2c, info->vol_reg, 1 << SD1_DVM_EN,\r\n1 << SD1_DVM_EN);\r\n}\r\nstatic int max8925_set_dvm_disable(struct regulator_dev *rdev)\r\n{\r\nstruct max8925_regulator_info *info = rdev_get_drvdata(rdev);\r\nreturn max8925_set_bits(info->i2c, info->vol_reg, 1 << SD1_DVM_EN, 0);\r\n}\r\nstatic struct max8925_regulator_info * __devinit find_regulator_info(int id)\r\n{\r\nstruct max8925_regulator_info *ri;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(max8925_regulator_info); i++) {\r\nri = &max8925_regulator_info[i];\r\nif (ri->desc.id == id)\r\nreturn ri;\r\n}\r\nreturn NULL;\r\n}\r\nstatic int __devinit max8925_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct max8925_chip *chip = dev_get_drvdata(pdev->dev.parent);\r\nstruct max8925_platform_data *pdata = chip->dev->platform_data;\r\nstruct max8925_regulator_info *ri;\r\nstruct regulator_dev *rdev;\r\nri = find_regulator_info(pdev->id);\r\nif (ri == NULL) {\r\ndev_err(&pdev->dev, "invalid regulator ID specified\n");\r\nreturn -EINVAL;\r\n}\r\nri->i2c = chip->i2c;\r\nri->chip = chip;\r\nrdev = regulator_register(&ri->desc, &pdev->dev,\r\npdata->regulator[pdev->id], ri);\r\nif (IS_ERR(rdev)) {\r\ndev_err(&pdev->dev, "failed to register regulator %s\n",\r\nri->desc.name);\r\nreturn PTR_ERR(rdev);\r\n}\r\nplatform_set_drvdata(pdev, rdev);\r\nreturn 0;\r\n}\r\nstatic int __devexit max8925_regulator_remove(struct platform_device *pdev)\r\n{\r\nstruct regulator_dev *rdev = platform_get_drvdata(pdev);\r\nplatform_set_drvdata(pdev, NULL);\r\nregulator_unregister(rdev);\r\nreturn 0;\r\n}\r\nstatic int __init max8925_regulator_init(void)\r\n{\r\nreturn platform_driver_register(&max8925_regulator_driver);\r\n}\r\nstatic void __exit max8925_regulator_exit(void)\r\n{\r\nplatform_driver_unregister(&max8925_regulator_driver);\r\n}

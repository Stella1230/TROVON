bool sci_remote_node_context_is_ready(\r\nstruct sci_remote_node_context *sci_rnc)\r\n{\r\nu32 current_state = sci_rnc->sm.current_state_id;\r\nif (current_state == SCI_RNC_READY) {\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic union scu_remote_node_context *sci_rnc_by_id(struct isci_host *ihost, u16 id)\r\n{\r\nif (id < ihost->remote_node_entries &&\r\nihost->device_table[id])\r\nreturn &ihost->remote_node_context_table[id];\r\nreturn NULL;\r\n}\r\nstatic void sci_remote_node_context_construct_buffer(struct sci_remote_node_context *sci_rnc)\r\n{\r\nstruct isci_remote_device *idev = rnc_to_dev(sci_rnc);\r\nstruct domain_device *dev = idev->domain_dev;\r\nint rni = sci_rnc->remote_node_index;\r\nunion scu_remote_node_context *rnc;\r\nstruct isci_host *ihost;\r\n__le64 sas_addr;\r\nihost = idev->owning_port->owning_controller;\r\nrnc = sci_rnc_by_id(ihost, rni);\r\nmemset(rnc, 0, sizeof(union scu_remote_node_context)\r\n* sci_remote_device_node_count(idev));\r\nrnc->ssp.remote_node_index = rni;\r\nrnc->ssp.remote_node_port_width = idev->device_port_width;\r\nrnc->ssp.logical_port_index = idev->owning_port->physical_port_index;\r\nsas_addr = cpu_to_le64(SAS_ADDR(dev->sas_addr));\r\nrnc->ssp.remote_sas_address_hi = upper_32_bits(sas_addr);\r\nrnc->ssp.remote_sas_address_lo = lower_32_bits(sas_addr);\r\nrnc->ssp.nexus_loss_timer_enable = true;\r\nrnc->ssp.check_bit = false;\r\nrnc->ssp.is_valid = false;\r\nrnc->ssp.is_remote_node_context = true;\r\nrnc->ssp.function_number = 0;\r\nrnc->ssp.arbitration_wait_time = 0;\r\nif (dev->dev_type == SATA_DEV || (dev->tproto & SAS_PROTOCOL_STP)) {\r\nrnc->ssp.connection_occupancy_timeout =\r\nihost->user_parameters.stp_max_occupancy_timeout;\r\nrnc->ssp.connection_inactivity_timeout =\r\nihost->user_parameters.stp_inactivity_timeout;\r\n} else {\r\nrnc->ssp.connection_occupancy_timeout =\r\nihost->user_parameters.ssp_max_occupancy_timeout;\r\nrnc->ssp.connection_inactivity_timeout =\r\nihost->user_parameters.ssp_inactivity_timeout;\r\n}\r\nrnc->ssp.initial_arbitration_wait_time = 0;\r\nrnc->ssp.oaf_connection_rate = idev->connection_rate;\r\nrnc->ssp.oaf_features = 0;\r\nrnc->ssp.oaf_source_zone_group = 0;\r\nrnc->ssp.oaf_more_compatibility_features = 0;\r\n}\r\nstatic void sci_remote_node_context_setup_to_resume(\r\nstruct sci_remote_node_context *sci_rnc,\r\nscics_sds_remote_node_context_callback callback,\r\nvoid *callback_parameter)\r\n{\r\nif (sci_rnc->destination_state != SCIC_SDS_REMOTE_NODE_DESTINATION_STATE_FINAL) {\r\nsci_rnc->destination_state = SCIC_SDS_REMOTE_NODE_DESTINATION_STATE_READY;\r\nsci_rnc->user_callback = callback;\r\nsci_rnc->user_cookie = callback_parameter;\r\n}\r\n}\r\nstatic void sci_remote_node_context_setup_to_destory(\r\nstruct sci_remote_node_context *sci_rnc,\r\nscics_sds_remote_node_context_callback callback,\r\nvoid *callback_parameter)\r\n{\r\nsci_rnc->destination_state = SCIC_SDS_REMOTE_NODE_DESTINATION_STATE_FINAL;\r\nsci_rnc->user_callback = callback;\r\nsci_rnc->user_cookie = callback_parameter;\r\n}\r\nstatic void sci_remote_node_context_notify_user(\r\nstruct sci_remote_node_context *rnc)\r\n{\r\nif (rnc->user_callback != NULL) {\r\n(*rnc->user_callback)(rnc->user_cookie);\r\nrnc->user_callback = NULL;\r\nrnc->user_cookie = NULL;\r\n}\r\n}\r\nstatic void sci_remote_node_context_continue_state_transitions(struct sci_remote_node_context *rnc)\r\n{\r\nif (rnc->destination_state == SCIC_SDS_REMOTE_NODE_DESTINATION_STATE_READY)\r\nsci_remote_node_context_resume(rnc, rnc->user_callback,\r\nrnc->user_cookie);\r\n}\r\nstatic void sci_remote_node_context_validate_context_buffer(struct sci_remote_node_context *sci_rnc)\r\n{\r\nunion scu_remote_node_context *rnc_buffer;\r\nstruct isci_remote_device *idev = rnc_to_dev(sci_rnc);\r\nstruct domain_device *dev = idev->domain_dev;\r\nstruct isci_host *ihost = idev->owning_port->owning_controller;\r\nrnc_buffer = sci_rnc_by_id(ihost, sci_rnc->remote_node_index);\r\nrnc_buffer->ssp.is_valid = true;\r\nif (!idev->is_direct_attached &&\r\n(dev->dev_type == SATA_DEV || (dev->tproto & SAS_PROTOCOL_STP))) {\r\nsci_remote_device_post_request(idev, SCU_CONTEXT_COMMAND_POST_RNC_96);\r\n} else {\r\nsci_remote_device_post_request(idev, SCU_CONTEXT_COMMAND_POST_RNC_32);\r\nif (idev->is_direct_attached)\r\nsci_port_setup_transports(idev->owning_port,\r\nsci_rnc->remote_node_index);\r\n}\r\n}\r\nstatic void sci_remote_node_context_invalidate_context_buffer(struct sci_remote_node_context *sci_rnc)\r\n{\r\nunion scu_remote_node_context *rnc_buffer;\r\nstruct isci_remote_device *idev = rnc_to_dev(sci_rnc);\r\nstruct isci_host *ihost = idev->owning_port->owning_controller;\r\nrnc_buffer = sci_rnc_by_id(ihost, sci_rnc->remote_node_index);\r\nrnc_buffer->ssp.is_valid = false;\r\nsci_remote_device_post_request(rnc_to_dev(sci_rnc),\r\nSCU_CONTEXT_COMMAND_POST_RNC_INVALIDATE);\r\n}\r\nstatic void sci_remote_node_context_initial_state_enter(struct sci_base_state_machine *sm)\r\n{\r\nstruct sci_remote_node_context *rnc = container_of(sm, typeof(*rnc), sm);\r\nif (sm->previous_state_id == SCI_RNC_INVALIDATING) {\r\nrnc->destination_state = SCIC_SDS_REMOTE_NODE_DESTINATION_STATE_UNSPECIFIED;\r\nsci_remote_node_context_notify_user(rnc);\r\n}\r\n}\r\nstatic void sci_remote_node_context_posting_state_enter(struct sci_base_state_machine *sm)\r\n{\r\nstruct sci_remote_node_context *sci_rnc = container_of(sm, typeof(*sci_rnc), sm);\r\nsci_remote_node_context_validate_context_buffer(sci_rnc);\r\n}\r\nstatic void sci_remote_node_context_invalidating_state_enter(struct sci_base_state_machine *sm)\r\n{\r\nstruct sci_remote_node_context *rnc = container_of(sm, typeof(*rnc), sm);\r\nsci_remote_node_context_invalidate_context_buffer(rnc);\r\n}\r\nstatic void sci_remote_node_context_resuming_state_enter(struct sci_base_state_machine *sm)\r\n{\r\nstruct sci_remote_node_context *rnc = container_of(sm, typeof(*rnc), sm);\r\nstruct isci_remote_device *idev;\r\nstruct domain_device *dev;\r\nidev = rnc_to_dev(rnc);\r\ndev = idev->domain_dev;\r\nif ((dev->dev_type == SATA_DEV || (dev->tproto & SAS_PROTOCOL_STP)) &&\r\nidev->is_direct_attached)\r\nsci_port_setup_transports(idev->owning_port,\r\nrnc->remote_node_index);\r\nsci_remote_device_post_request(idev, SCU_CONTEXT_COMMAND_POST_RNC_RESUME);\r\n}\r\nstatic void sci_remote_node_context_ready_state_enter(struct sci_base_state_machine *sm)\r\n{\r\nstruct sci_remote_node_context *rnc = container_of(sm, typeof(*rnc), sm);\r\nrnc->destination_state = SCIC_SDS_REMOTE_NODE_DESTINATION_STATE_UNSPECIFIED;\r\nif (rnc->user_callback)\r\nsci_remote_node_context_notify_user(rnc);\r\n}\r\nstatic void sci_remote_node_context_tx_suspended_state_enter(struct sci_base_state_machine *sm)\r\n{\r\nstruct sci_remote_node_context *rnc = container_of(sm, typeof(*rnc), sm);\r\nsci_remote_node_context_continue_state_transitions(rnc);\r\n}\r\nstatic void sci_remote_node_context_tx_rx_suspended_state_enter(struct sci_base_state_machine *sm)\r\n{\r\nstruct sci_remote_node_context *rnc = container_of(sm, typeof(*rnc), sm);\r\nsci_remote_node_context_continue_state_transitions(rnc);\r\n}\r\nvoid sci_remote_node_context_construct(struct sci_remote_node_context *rnc,\r\nu16 remote_node_index)\r\n{\r\nmemset(rnc, 0, sizeof(struct sci_remote_node_context));\r\nrnc->remote_node_index = remote_node_index;\r\nrnc->destination_state = SCIC_SDS_REMOTE_NODE_DESTINATION_STATE_UNSPECIFIED;\r\nsci_init_sm(&rnc->sm, sci_remote_node_context_state_table, SCI_RNC_INITIAL);\r\n}\r\nenum sci_status sci_remote_node_context_event_handler(struct sci_remote_node_context *sci_rnc,\r\nu32 event_code)\r\n{\r\nenum scis_sds_remote_node_context_states state;\r\nstate = sci_rnc->sm.current_state_id;\r\nswitch (state) {\r\ncase SCI_RNC_POSTING:\r\nswitch (scu_get_event_code(event_code)) {\r\ncase SCU_EVENT_POST_RNC_COMPLETE:\r\nsci_change_state(&sci_rnc->sm, SCI_RNC_READY);\r\nbreak;\r\ndefault:\r\ngoto out;\r\n}\r\nbreak;\r\ncase SCI_RNC_INVALIDATING:\r\nif (scu_get_event_code(event_code) == SCU_EVENT_POST_RNC_INVALIDATE_COMPLETE) {\r\nif (sci_rnc->destination_state == SCIC_SDS_REMOTE_NODE_DESTINATION_STATE_FINAL)\r\nstate = SCI_RNC_INITIAL;\r\nelse\r\nstate = SCI_RNC_POSTING;\r\nsci_change_state(&sci_rnc->sm, state);\r\n} else {\r\nswitch (scu_get_event_type(event_code)) {\r\ncase SCU_EVENT_TYPE_RNC_SUSPEND_TX:\r\ncase SCU_EVENT_TYPE_RNC_SUSPEND_TX_RX:\r\ndev_dbg(scirdev_to_dev(rnc_to_dev(sci_rnc)),\r\n"%s: SCIC Remote Node Context 0x%p was "\r\n"suspeneded by hardware while being "\r\n"invalidated.\n", __func__, sci_rnc);\r\nbreak;\r\ndefault:\r\ngoto out;\r\n}\r\n}\r\nbreak;\r\ncase SCI_RNC_RESUMING:\r\nif (scu_get_event_code(event_code) == SCU_EVENT_POST_RCN_RELEASE) {\r\nsci_change_state(&sci_rnc->sm, SCI_RNC_READY);\r\n} else {\r\nswitch (scu_get_event_type(event_code)) {\r\ncase SCU_EVENT_TYPE_RNC_SUSPEND_TX:\r\ncase SCU_EVENT_TYPE_RNC_SUSPEND_TX_RX:\r\ndev_dbg(scirdev_to_dev(rnc_to_dev(sci_rnc)),\r\n"%s: SCIC Remote Node Context 0x%p was "\r\n"suspeneded by hardware while being resumed.\n",\r\n__func__, sci_rnc);\r\nbreak;\r\ndefault:\r\ngoto out;\r\n}\r\n}\r\nbreak;\r\ncase SCI_RNC_READY:\r\nswitch (scu_get_event_type(event_code)) {\r\ncase SCU_EVENT_TL_RNC_SUSPEND_TX:\r\nsci_change_state(&sci_rnc->sm, SCI_RNC_TX_SUSPENDED);\r\nsci_rnc->suspension_code = scu_get_event_specifier(event_code);\r\nbreak;\r\ncase SCU_EVENT_TL_RNC_SUSPEND_TX_RX:\r\nsci_change_state(&sci_rnc->sm, SCI_RNC_TX_RX_SUSPENDED);\r\nsci_rnc->suspension_code = scu_get_event_specifier(event_code);\r\nbreak;\r\ndefault:\r\ngoto out;\r\n}\r\nbreak;\r\ncase SCI_RNC_AWAIT_SUSPENSION:\r\nswitch (scu_get_event_type(event_code)) {\r\ncase SCU_EVENT_TL_RNC_SUSPEND_TX:\r\nsci_change_state(&sci_rnc->sm, SCI_RNC_TX_SUSPENDED);\r\nsci_rnc->suspension_code = scu_get_event_specifier(event_code);\r\nbreak;\r\ncase SCU_EVENT_TL_RNC_SUSPEND_TX_RX:\r\nsci_change_state(&sci_rnc->sm, SCI_RNC_TX_RX_SUSPENDED);\r\nsci_rnc->suspension_code = scu_get_event_specifier(event_code);\r\nbreak;\r\ndefault:\r\ngoto out;\r\n}\r\nbreak;\r\ndefault:\r\ndev_warn(scirdev_to_dev(rnc_to_dev(sci_rnc)),\r\n"%s: invalid state %d\n", __func__, state);\r\nreturn SCI_FAILURE_INVALID_STATE;\r\n}\r\nreturn SCI_SUCCESS;\r\nout:\r\ndev_warn(scirdev_to_dev(rnc_to_dev(sci_rnc)),\r\n"%s: code: %#x state: %d\n", __func__, event_code, state);\r\nreturn SCI_FAILURE;\r\n}\r\nenum sci_status sci_remote_node_context_destruct(struct sci_remote_node_context *sci_rnc,\r\nscics_sds_remote_node_context_callback cb_fn,\r\nvoid *cb_p)\r\n{\r\nenum scis_sds_remote_node_context_states state;\r\nstate = sci_rnc->sm.current_state_id;\r\nswitch (state) {\r\ncase SCI_RNC_INVALIDATING:\r\nsci_remote_node_context_setup_to_destory(sci_rnc, cb_fn, cb_p);\r\nreturn SCI_SUCCESS;\r\ncase SCI_RNC_POSTING:\r\ncase SCI_RNC_RESUMING:\r\ncase SCI_RNC_READY:\r\ncase SCI_RNC_TX_SUSPENDED:\r\ncase SCI_RNC_TX_RX_SUSPENDED:\r\ncase SCI_RNC_AWAIT_SUSPENSION:\r\nsci_remote_node_context_setup_to_destory(sci_rnc, cb_fn, cb_p);\r\nsci_change_state(&sci_rnc->sm, SCI_RNC_INVALIDATING);\r\nreturn SCI_SUCCESS;\r\ncase SCI_RNC_INITIAL:\r\ndev_warn(scirdev_to_dev(rnc_to_dev(sci_rnc)),\r\n"%s: invalid state %d\n", __func__, state);\r\nreturn SCI_SUCCESS;\r\ndefault:\r\ndev_warn(scirdev_to_dev(rnc_to_dev(sci_rnc)),\r\n"%s: invalid state %d\n", __func__, state);\r\nreturn SCI_FAILURE_INVALID_STATE;\r\n}\r\n}\r\nenum sci_status sci_remote_node_context_suspend(struct sci_remote_node_context *sci_rnc,\r\nu32 suspend_type,\r\nscics_sds_remote_node_context_callback cb_fn,\r\nvoid *cb_p)\r\n{\r\nenum scis_sds_remote_node_context_states state;\r\nstate = sci_rnc->sm.current_state_id;\r\nif (state != SCI_RNC_READY) {\r\ndev_warn(scirdev_to_dev(rnc_to_dev(sci_rnc)),\r\n"%s: invalid state %d\n", __func__, state);\r\nreturn SCI_FAILURE_INVALID_STATE;\r\n}\r\nsci_rnc->user_callback = cb_fn;\r\nsci_rnc->user_cookie = cb_p;\r\nsci_rnc->suspension_code = suspend_type;\r\nif (suspend_type == SCI_SOFTWARE_SUSPENSION) {\r\nsci_remote_device_post_request(rnc_to_dev(sci_rnc),\r\nSCU_CONTEXT_COMMAND_POST_RNC_SUSPEND_TX);\r\n}\r\nsci_change_state(&sci_rnc->sm, SCI_RNC_AWAIT_SUSPENSION);\r\nreturn SCI_SUCCESS;\r\n}\r\nenum sci_status sci_remote_node_context_resume(struct sci_remote_node_context *sci_rnc,\r\nscics_sds_remote_node_context_callback cb_fn,\r\nvoid *cb_p)\r\n{\r\nenum scis_sds_remote_node_context_states state;\r\nstate = sci_rnc->sm.current_state_id;\r\nswitch (state) {\r\ncase SCI_RNC_INITIAL:\r\nif (sci_rnc->remote_node_index == SCIC_SDS_REMOTE_NODE_CONTEXT_INVALID_INDEX)\r\nreturn SCI_FAILURE_INVALID_STATE;\r\nsci_remote_node_context_setup_to_resume(sci_rnc, cb_fn, cb_p);\r\nsci_remote_node_context_construct_buffer(sci_rnc);\r\nsci_change_state(&sci_rnc->sm, SCI_RNC_POSTING);\r\nreturn SCI_SUCCESS;\r\ncase SCI_RNC_POSTING:\r\ncase SCI_RNC_INVALIDATING:\r\ncase SCI_RNC_RESUMING:\r\nif (sci_rnc->destination_state != SCIC_SDS_REMOTE_NODE_DESTINATION_STATE_READY)\r\nreturn SCI_FAILURE_INVALID_STATE;\r\nsci_rnc->user_callback = cb_fn;\r\nsci_rnc->user_cookie = cb_p;\r\nreturn SCI_SUCCESS;\r\ncase SCI_RNC_TX_SUSPENDED: {\r\nstruct isci_remote_device *idev = rnc_to_dev(sci_rnc);\r\nstruct domain_device *dev = idev->domain_dev;\r\nsci_remote_node_context_setup_to_resume(sci_rnc, cb_fn, cb_p);\r\nif (dev->dev_type == SAS_END_DEV || dev_is_expander(dev))\r\nsci_change_state(&sci_rnc->sm, SCI_RNC_RESUMING);\r\nelse if (dev->dev_type == SATA_DEV || (dev->tproto & SAS_PROTOCOL_STP)) {\r\nif (idev->is_direct_attached) {\r\nsci_change_state(&sci_rnc->sm, SCI_RNC_RESUMING);\r\n} else {\r\nsci_change_state(&sci_rnc->sm, SCI_RNC_INVALIDATING);\r\n}\r\n} else\r\nreturn SCI_FAILURE;\r\nreturn SCI_SUCCESS;\r\n}\r\ncase SCI_RNC_TX_RX_SUSPENDED:\r\nsci_remote_node_context_setup_to_resume(sci_rnc, cb_fn, cb_p);\r\nsci_change_state(&sci_rnc->sm, SCI_RNC_RESUMING);\r\nreturn SCI_FAILURE_INVALID_STATE;\r\ncase SCI_RNC_AWAIT_SUSPENSION:\r\nsci_remote_node_context_setup_to_resume(sci_rnc, cb_fn, cb_p);\r\nreturn SCI_SUCCESS;\r\ndefault:\r\ndev_warn(scirdev_to_dev(rnc_to_dev(sci_rnc)),\r\n"%s: invalid state %d\n", __func__, state);\r\nreturn SCI_FAILURE_INVALID_STATE;\r\n}\r\n}\r\nenum sci_status sci_remote_node_context_start_io(struct sci_remote_node_context *sci_rnc,\r\nstruct isci_request *ireq)\r\n{\r\nenum scis_sds_remote_node_context_states state;\r\nstate = sci_rnc->sm.current_state_id;\r\nswitch (state) {\r\ncase SCI_RNC_READY:\r\nreturn SCI_SUCCESS;\r\ncase SCI_RNC_TX_SUSPENDED:\r\ncase SCI_RNC_TX_RX_SUSPENDED:\r\ncase SCI_RNC_AWAIT_SUSPENSION:\r\ndev_warn(scirdev_to_dev(rnc_to_dev(sci_rnc)),\r\n"%s: invalid state %d\n", __func__, state);\r\nreturn SCI_FAILURE_REMOTE_DEVICE_RESET_REQUIRED;\r\ndefault:\r\nbreak;\r\n}\r\ndev_dbg(scirdev_to_dev(rnc_to_dev(sci_rnc)),\r\n"%s: requested to start IO while still resuming, %d\n",\r\n__func__, state);\r\nreturn SCI_FAILURE_INVALID_STATE;\r\n}\r\nenum sci_status sci_remote_node_context_start_task(struct sci_remote_node_context *sci_rnc,\r\nstruct isci_request *ireq)\r\n{\r\nenum scis_sds_remote_node_context_states state;\r\nstate = sci_rnc->sm.current_state_id;\r\nswitch (state) {\r\ncase SCI_RNC_RESUMING:\r\ncase SCI_RNC_READY:\r\ncase SCI_RNC_AWAIT_SUSPENSION:\r\nreturn SCI_SUCCESS;\r\ncase SCI_RNC_TX_SUSPENDED:\r\ncase SCI_RNC_TX_RX_SUSPENDED:\r\nsci_remote_node_context_resume(sci_rnc, NULL, NULL);\r\nreturn SCI_SUCCESS;\r\ndefault:\r\ndev_warn(scirdev_to_dev(rnc_to_dev(sci_rnc)),\r\n"%s: invalid state %d\n", __func__, state);\r\nreturn SCI_FAILURE_INVALID_STATE;\r\n}\r\n}

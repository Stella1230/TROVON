static void ltq_ebu_apply(void)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&ebu_lock, flags);\r\nltq_ebu_w32(LTQ_EBU_BUSCON, LTQ_EBU_BUSCON1);\r\n*((__u16 *)ltq_ebu_gpio_membase) = ltq_ebu_gpio_shadow;\r\nltq_ebu_w32(LTQ_EBU_BUSCON | LTQ_EBU_WP, LTQ_EBU_BUSCON1);\r\nspin_unlock_irqrestore(&ebu_lock, flags);\r\n}\r\nstatic void ltq_ebu_set(struct gpio_chip *chip, unsigned offset, int value)\r\n{\r\nif (value)\r\nltq_ebu_gpio_shadow |= (1 << offset);\r\nelse\r\nltq_ebu_gpio_shadow &= ~(1 << offset);\r\nltq_ebu_apply();\r\n}\r\nstatic int ltq_ebu_direction_output(struct gpio_chip *chip, unsigned offset,\r\nint value)\r\n{\r\nltq_ebu_set(chip, offset, value);\r\nreturn 0;\r\n}\r\nstatic int ltq_ebu_probe(struct platform_device *pdev)\r\n{\r\nint ret = 0;\r\nstruct resource *res = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\ndev_err(&pdev->dev, "failed to get memory resource\n");\r\nreturn -ENOENT;\r\n}\r\nres = devm_request_mem_region(&pdev->dev, res->start,\r\nresource_size(res), dev_name(&pdev->dev));\r\nif (!res) {\r\ndev_err(&pdev->dev, "failed to request memory resource\n");\r\nreturn -EBUSY;\r\n}\r\nltq_ebu_gpio_membase = devm_ioremap_nocache(&pdev->dev, res->start,\r\nresource_size(res));\r\nif (!ltq_ebu_gpio_membase) {\r\ndev_err(&pdev->dev, "Failed to ioremap mem region\n");\r\nreturn -ENOMEM;\r\n}\r\nltq_ebu_gpio_shadow = (unsigned int) pdev->dev.platform_data;\r\nltq_ebu_w32(pdev->resource->start | 0x1, LTQ_EBU_ADDRSEL1);\r\nltq_ebu_w32(LTQ_EBU_BUSCON | LTQ_EBU_WP, LTQ_EBU_BUSCON1);\r\nret = gpiochip_add(&ltq_ebu_chip);\r\nif (!ret)\r\nltq_ebu_apply();\r\nreturn ret;\r\n}\r\nstatic int __init ltq_ebu_init(void)\r\n{\r\nint ret = platform_driver_register(&ltq_ebu_driver);\r\nif (ret)\r\npr_info("ltq_ebu : Error registering platfom driver!");\r\nreturn ret;\r\n}

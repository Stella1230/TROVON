static void tda827x_set_std(struct dvb_frontend *fe,\r\nstruct analog_parameters *params)\r\n{\r\nstruct tda827x_priv *priv = fe->tuner_priv;\r\nchar *mode;\r\npriv->lpsel = 0;\r\nif (params->std & V4L2_STD_MN) {\r\npriv->sgIF = 92;\r\npriv->lpsel = 1;\r\nmode = "MN";\r\n} else if (params->std & V4L2_STD_B) {\r\npriv->sgIF = 108;\r\nmode = "B";\r\n} else if (params->std & V4L2_STD_GH) {\r\npriv->sgIF = 124;\r\nmode = "GH";\r\n} else if (params->std & V4L2_STD_PAL_I) {\r\npriv->sgIF = 124;\r\nmode = "I";\r\n} else if (params->std & V4L2_STD_DK) {\r\npriv->sgIF = 124;\r\nmode = "DK";\r\n} else if (params->std & V4L2_STD_SECAM_L) {\r\npriv->sgIF = 124;\r\nmode = "L";\r\n} else if (params->std & V4L2_STD_SECAM_LC) {\r\npriv->sgIF = 20;\r\nmode = "LC";\r\n} else {\r\npriv->sgIF = 124;\r\nmode = "xx";\r\n}\r\nif (params->mode == V4L2_TUNER_RADIO) {\r\npriv->sgIF = 88;\r\ndprintk("setting tda827x to radio FM\n");\r\n} else\r\ndprintk("setting tda827x to system %s\n", mode);\r\n}\r\nstatic int tuner_transfer(struct dvb_frontend *fe,\r\nstruct i2c_msg *msg,\r\nconst int size)\r\n{\r\nint rc;\r\nstruct tda827x_priv *priv = fe->tuner_priv;\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 1);\r\nrc = i2c_transfer(priv->i2c_adap, msg, size);\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 0);\r\nif (rc >= 0 && rc != size)\r\nreturn -EIO;\r\nreturn rc;\r\n}\r\nstatic int tda827xo_set_params(struct dvb_frontend *fe,\r\nstruct dvb_frontend_parameters *params)\r\n{\r\nstruct tda827x_priv *priv = fe->tuner_priv;\r\nu8 buf[14];\r\nint rc;\r\nstruct i2c_msg msg = { .addr = priv->i2c_addr, .flags = 0,\r\n.buf = buf, .len = sizeof(buf) };\r\nint i, tuner_freq, if_freq;\r\nu32 N;\r\ndprintk("%s:\n", __func__);\r\nswitch (params->u.ofdm.bandwidth) {\r\ncase BANDWIDTH_6_MHZ:\r\nif_freq = 4000000;\r\nbreak;\r\ncase BANDWIDTH_7_MHZ:\r\nif_freq = 4500000;\r\nbreak;\r\ndefault:\r\nif_freq = 5000000;\r\nbreak;\r\n}\r\ntuner_freq = params->frequency + if_freq;\r\ni = 0;\r\nwhile (tda827x_table[i].lomax < tuner_freq) {\r\nif (tda827x_table[i + 1].lomax == 0)\r\nbreak;\r\ni++;\r\n}\r\nN = ((tuner_freq + 125000) / 250000) << (tda827x_table[i].spd + 2);\r\nbuf[0] = 0;\r\nbuf[1] = (N>>8) | 0x40;\r\nbuf[2] = N & 0xff;\r\nbuf[3] = 0;\r\nbuf[4] = 0x52;\r\nbuf[5] = (tda827x_table[i].spd << 6) + (tda827x_table[i].div1p5 << 5) +\r\n(tda827x_table[i].bs << 3) +\r\ntda827x_table[i].bp;\r\nbuf[6] = (tda827x_table[i].gc3 << 4) + 0x8f;\r\nbuf[7] = 0xbf;\r\nbuf[8] = 0x2a;\r\nbuf[9] = 0x05;\r\nbuf[10] = 0xff;\r\nbuf[11] = 0x00;\r\nbuf[12] = 0x00;\r\nbuf[13] = 0x40;\r\nmsg.len = 14;\r\nrc = tuner_transfer(fe, &msg, 1);\r\nif (rc < 0)\r\ngoto err;\r\nmsleep(500);\r\nbuf[0] = 0x30;\r\nbuf[1] = 0x50 + tda827x_table[i].cp;\r\nmsg.len = 2;\r\nrc = tuner_transfer(fe, &msg, 1);\r\nif (rc < 0)\r\ngoto err;\r\npriv->frequency = params->frequency;\r\npriv->bandwidth = (fe->ops.info.type == FE_OFDM) ? params->u.ofdm.bandwidth : 0;\r\nreturn 0;\r\nerr:\r\nprintk(KERN_ERR "%s: could not write to tuner at addr: 0x%02x\n",\r\n__func__, priv->i2c_addr << 1);\r\nreturn rc;\r\n}\r\nstatic int tda827xo_sleep(struct dvb_frontend *fe)\r\n{\r\nstruct tda827x_priv *priv = fe->tuner_priv;\r\nstatic u8 buf[] = { 0x30, 0xd0 };\r\nstruct i2c_msg msg = { .addr = priv->i2c_addr, .flags = 0,\r\n.buf = buf, .len = sizeof(buf) };\r\ndprintk("%s:\n", __func__);\r\ntuner_transfer(fe, &msg, 1);\r\nif (priv->cfg && priv->cfg->sleep)\r\npriv->cfg->sleep(fe);\r\nreturn 0;\r\n}\r\nstatic int tda827xo_set_analog_params(struct dvb_frontend *fe,\r\nstruct analog_parameters *params)\r\n{\r\nunsigned char tuner_reg[8];\r\nunsigned char reg2[2];\r\nu32 N;\r\nint i;\r\nstruct tda827x_priv *priv = fe->tuner_priv;\r\nstruct i2c_msg msg = { .addr = priv->i2c_addr, .flags = 0 };\r\nunsigned int freq = params->frequency;\r\ntda827x_set_std(fe, params);\r\nif (params->mode == V4L2_TUNER_RADIO)\r\nfreq = freq / 1000;\r\nN = freq + priv->sgIF;\r\ni = 0;\r\nwhile (tda827x_table[i].lomax < N * 62500) {\r\nif (tda827x_table[i + 1].lomax == 0)\r\nbreak;\r\ni++;\r\n}\r\nN = N << tda827x_table[i].spd;\r\ntuner_reg[0] = 0;\r\ntuner_reg[1] = (unsigned char)(N>>8);\r\ntuner_reg[2] = (unsigned char) N;\r\ntuner_reg[3] = 0x40;\r\ntuner_reg[4] = 0x52 + (priv->lpsel << 5);\r\ntuner_reg[5] = (tda827x_table[i].spd << 6) +\r\n(tda827x_table[i].div1p5 << 5) +\r\n(tda827x_table[i].bs << 3) + tda827x_table[i].bp;\r\ntuner_reg[6] = 0x8f + (tda827x_table[i].gc3 << 4);\r\ntuner_reg[7] = 0x8f;\r\nmsg.buf = tuner_reg;\r\nmsg.len = 8;\r\ntuner_transfer(fe, &msg, 1);\r\nmsg.buf = reg2;\r\nmsg.len = 2;\r\nreg2[0] = 0x80;\r\nreg2[1] = 0;\r\ntuner_transfer(fe, &msg, 1);\r\nreg2[0] = 0x60;\r\nreg2[1] = 0xbf;\r\ntuner_transfer(fe, &msg, 1);\r\nreg2[0] = 0x30;\r\nreg2[1] = tuner_reg[4] + 0x80;\r\ntuner_transfer(fe, &msg, 1);\r\nmsleep(1);\r\nreg2[0] = 0x30;\r\nreg2[1] = tuner_reg[4] + 4;\r\ntuner_transfer(fe, &msg, 1);\r\nmsleep(1);\r\nreg2[0] = 0x30;\r\nreg2[1] = tuner_reg[4];\r\ntuner_transfer(fe, &msg, 1);\r\nmsleep(550);\r\nreg2[0] = 0x30;\r\nreg2[1] = (tuner_reg[4] & 0xfc) + tda827x_table[i].cp;\r\ntuner_transfer(fe, &msg, 1);\r\nreg2[0] = 0x60;\r\nreg2[1] = 0x3f;\r\ntuner_transfer(fe, &msg, 1);\r\nreg2[0] = 0x80;\r\nreg2[1] = 0x08;\r\ntuner_transfer(fe, &msg, 1);\r\npriv->frequency = params->frequency;\r\nreturn 0;\r\n}\r\nstatic void tda827xo_agcf(struct dvb_frontend *fe)\r\n{\r\nstruct tda827x_priv *priv = fe->tuner_priv;\r\nunsigned char data[] = { 0x80, 0x0c };\r\nstruct i2c_msg msg = { .addr = priv->i2c_addr, .flags = 0,\r\n.buf = data, .len = 2};\r\ntuner_transfer(fe, &msg, 1);\r\n}\r\nstatic int tda827xa_sleep(struct dvb_frontend *fe)\r\n{\r\nstruct tda827x_priv *priv = fe->tuner_priv;\r\nstatic u8 buf[] = { 0x30, 0x90 };\r\nstruct i2c_msg msg = { .addr = priv->i2c_addr, .flags = 0,\r\n.buf = buf, .len = sizeof(buf) };\r\ndprintk("%s:\n", __func__);\r\ntuner_transfer(fe, &msg, 1);\r\nif (priv->cfg && priv->cfg->sleep)\r\npriv->cfg->sleep(fe);\r\nreturn 0;\r\n}\r\nstatic void tda827xa_lna_gain(struct dvb_frontend *fe, int high,\r\nstruct analog_parameters *params)\r\n{\r\nstruct tda827x_priv *priv = fe->tuner_priv;\r\nunsigned char buf[] = {0x22, 0x01};\r\nint arg;\r\nint gp_func;\r\nstruct i2c_msg msg = { .flags = 0, .buf = buf, .len = sizeof(buf) };\r\nif (NULL == priv->cfg) {\r\ndprintk("tda827x_config not defined, cannot set LNA gain!\n");\r\nreturn;\r\n}\r\nmsg.addr = priv->cfg->switch_addr;\r\nif (priv->cfg->config) {\r\nif (high)\r\ndprintk("setting LNA to high gain\n");\r\nelse\r\ndprintk("setting LNA to low gain\n");\r\n}\r\nswitch (priv->cfg->config) {\r\ncase 0:\r\nbreak;\r\ncase 1:\r\ncase 2:\r\nif (params == NULL) {\r\ngp_func = 0;\r\narg = 0;\r\n} else {\r\ngp_func = 1;\r\nif (params->std & V4L2_STD_MN)\r\narg = 1;\r\nelse\r\narg = 0;\r\n}\r\nif (fe->callback)\r\nfe->callback(priv->i2c_adap->algo_data,\r\nDVB_FRONTEND_COMPONENT_TUNER,\r\ngp_func, arg);\r\nbuf[1] = high ? 0 : 1;\r\nif (priv->cfg->config == 2)\r\nbuf[1] = high ? 1 : 0;\r\ntuner_transfer(fe, &msg, 1);\r\nbreak;\r\ncase 3:\r\nif (fe->callback)\r\nfe->callback(priv->i2c_adap->algo_data,\r\nDVB_FRONTEND_COMPONENT_TUNER, 0, high);\r\nbreak;\r\n}\r\n}\r\nstatic int tda827xa_set_params(struct dvb_frontend *fe,\r\nstruct dvb_frontend_parameters *params)\r\n{\r\nstruct tda827x_priv *priv = fe->tuner_priv;\r\nstruct tda827xa_data *frequency_map = tda827xa_dvbt;\r\nu8 buf[11];\r\nstruct i2c_msg msg = { .addr = priv->i2c_addr, .flags = 0,\r\n.buf = buf, .len = sizeof(buf) };\r\nint i, tuner_freq, if_freq, rc;\r\nu32 N;\r\ndprintk("%s:\n", __func__);\r\ntda827xa_lna_gain(fe, 1, NULL);\r\nmsleep(20);\r\nswitch (params->u.ofdm.bandwidth) {\r\ncase BANDWIDTH_6_MHZ:\r\nif_freq = 4000000;\r\nbreak;\r\ncase BANDWIDTH_7_MHZ:\r\nif_freq = 4500000;\r\nbreak;\r\ndefault:\r\nif_freq = 5000000;\r\nbreak;\r\n}\r\ntuner_freq = params->frequency + if_freq;\r\nif (fe->ops.info.type == FE_QAM) {\r\ndprintk("%s select tda827xa_dvbc\n", __func__);\r\nfrequency_map = tda827xa_dvbc;\r\n}\r\ni = 0;\r\nwhile (frequency_map[i].lomax < tuner_freq) {\r\nif (frequency_map[i + 1].lomax == 0)\r\nbreak;\r\ni++;\r\n}\r\nN = ((tuner_freq + 31250) / 62500) << frequency_map[i].spd;\r\nbuf[0] = 0;\r\nbuf[1] = N >> 8;\r\nbuf[2] = N & 0xff;\r\nbuf[3] = 0;\r\nbuf[4] = 0x16;\r\nbuf[5] = (frequency_map[i].spd << 5) + (frequency_map[i].svco << 3) +\r\nfrequency_map[i].sbs;\r\nbuf[6] = 0x4b + (frequency_map[i].gc3 << 4);\r\nbuf[7] = 0x1c;\r\nbuf[8] = 0x06;\r\nbuf[9] = 0x24;\r\nbuf[10] = 0x00;\r\nmsg.len = 11;\r\nrc = tuner_transfer(fe, &msg, 1);\r\nif (rc < 0)\r\ngoto err;\r\nbuf[0] = 0x90;\r\nbuf[1] = 0xff;\r\nbuf[2] = 0x60;\r\nbuf[3] = 0x00;\r\nbuf[4] = 0x59;\r\nmsg.len = 5;\r\nrc = tuner_transfer(fe, &msg, 1);\r\nif (rc < 0)\r\ngoto err;\r\nbuf[0] = 0xa0;\r\nbuf[1] = 0x40;\r\nmsg.len = 2;\r\nrc = tuner_transfer(fe, &msg, 1);\r\nif (rc < 0)\r\ngoto err;\r\nmsleep(11);\r\nmsg.flags = I2C_M_RD;\r\nrc = tuner_transfer(fe, &msg, 1);\r\nif (rc < 0)\r\ngoto err;\r\nmsg.flags = 0;\r\nbuf[1] >>= 4;\r\ndprintk("tda8275a AGC2 gain is: %d\n", buf[1]);\r\nif ((buf[1]) < 2) {\r\ntda827xa_lna_gain(fe, 0, NULL);\r\nbuf[0] = 0x60;\r\nbuf[1] = 0x0c;\r\nrc = tuner_transfer(fe, &msg, 1);\r\nif (rc < 0)\r\ngoto err;\r\n}\r\nbuf[0] = 0xc0;\r\nbuf[1] = 0x99;\r\nrc = tuner_transfer(fe, &msg, 1);\r\nif (rc < 0)\r\ngoto err;\r\nbuf[0] = 0x60;\r\nbuf[1] = 0x3c;\r\nrc = tuner_transfer(fe, &msg, 1);\r\nif (rc < 0)\r\ngoto err;\r\nbuf[0] = 0x30;\r\nbuf[1] = 0x10 + frequency_map[i].scr;\r\nrc = tuner_transfer(fe, &msg, 1);\r\nif (rc < 0)\r\ngoto err;\r\nmsleep(163);\r\nbuf[0] = 0xc0;\r\nbuf[1] = 0x39;\r\nrc = tuner_transfer(fe, &msg, 1);\r\nif (rc < 0)\r\ngoto err;\r\nmsleep(3);\r\nbuf[0] = 0x50;\r\nbuf[1] = 0x4f + (frequency_map[i].gc3 << 4);\r\nrc = tuner_transfer(fe, &msg, 1);\r\nif (rc < 0)\r\ngoto err;\r\npriv->frequency = params->frequency;\r\npriv->bandwidth = (fe->ops.info.type == FE_OFDM) ? params->u.ofdm.bandwidth : 0;\r\nreturn 0;\r\nerr:\r\nprintk(KERN_ERR "%s: could not write to tuner at addr: 0x%02x\n",\r\n__func__, priv->i2c_addr << 1);\r\nreturn rc;\r\n}\r\nstatic int tda827xa_set_analog_params(struct dvb_frontend *fe,\r\nstruct analog_parameters *params)\r\n{\r\nunsigned char tuner_reg[11];\r\nu32 N;\r\nint i;\r\nstruct tda827x_priv *priv = fe->tuner_priv;\r\nstruct i2c_msg msg = { .addr = priv->i2c_addr, .flags = 0,\r\n.buf = tuner_reg, .len = sizeof(tuner_reg) };\r\nunsigned int freq = params->frequency;\r\ntda827x_set_std(fe, params);\r\ntda827xa_lna_gain(fe, 1, params);\r\nmsleep(10);\r\nif (params->mode == V4L2_TUNER_RADIO)\r\nfreq = freq / 1000;\r\nN = freq + priv->sgIF;\r\ni = 0;\r\nwhile (tda827xa_analog[i].lomax < N * 62500) {\r\nif (tda827xa_analog[i + 1].lomax == 0)\r\nbreak;\r\ni++;\r\n}\r\nN = N << tda827xa_analog[i].spd;\r\ntuner_reg[0] = 0;\r\ntuner_reg[1] = (unsigned char)(N>>8);\r\ntuner_reg[2] = (unsigned char) N;\r\ntuner_reg[3] = 0;\r\ntuner_reg[4] = 0x16;\r\ntuner_reg[5] = (tda827xa_analog[i].spd << 5) +\r\n(tda827xa_analog[i].svco << 3) +\r\ntda827xa_analog[i].sbs;\r\ntuner_reg[6] = 0x8b + (tda827xa_analog[i].gc3 << 4);\r\ntuner_reg[7] = 0x1c;\r\ntuner_reg[8] = 4;\r\ntuner_reg[9] = 0x20;\r\ntuner_reg[10] = 0x00;\r\nmsg.len = 11;\r\ntuner_transfer(fe, &msg, 1);\r\ntuner_reg[0] = 0x90;\r\ntuner_reg[1] = 0xff;\r\ntuner_reg[2] = 0xe0;\r\ntuner_reg[3] = 0;\r\ntuner_reg[4] = 0x99 + (priv->lpsel << 1);\r\nmsg.len = 5;\r\ntuner_transfer(fe, &msg, 1);\r\ntuner_reg[0] = 0xa0;\r\ntuner_reg[1] = 0xc0;\r\nmsg.len = 2;\r\ntuner_transfer(fe, &msg, 1);\r\ntuner_reg[0] = 0x30;\r\ntuner_reg[1] = 0x10 + tda827xa_analog[i].scr;\r\ntuner_transfer(fe, &msg, 1);\r\nmsg.flags = I2C_M_RD;\r\ntuner_transfer(fe, &msg, 1);\r\nmsg.flags = 0;\r\ntuner_reg[1] >>= 4;\r\ndprintk("AGC2 gain is: %d\n", tuner_reg[1]);\r\nif (tuner_reg[1] < 1)\r\ntda827xa_lna_gain(fe, 0, params);\r\nmsleep(100);\r\ntuner_reg[0] = 0x60;\r\ntuner_reg[1] = 0x3c;\r\ntuner_transfer(fe, &msg, 1);\r\nmsleep(163);\r\ntuner_reg[0] = 0x50;\r\ntuner_reg[1] = 0x8f + (tda827xa_analog[i].gc3 << 4);\r\ntuner_transfer(fe, &msg, 1);\r\ntuner_reg[0] = 0x80;\r\ntuner_reg[1] = 0x28;\r\ntuner_transfer(fe, &msg, 1);\r\ntuner_reg[0] = 0xb0;\r\ntuner_reg[1] = 0x01;\r\ntuner_transfer(fe, &msg, 1);\r\ntuner_reg[0] = 0xc0;\r\ntuner_reg[1] = 0x19 + (priv->lpsel << 1);\r\ntuner_transfer(fe, &msg, 1);\r\npriv->frequency = params->frequency;\r\nreturn 0;\r\n}\r\nstatic void tda827xa_agcf(struct dvb_frontend *fe)\r\n{\r\nstruct tda827x_priv *priv = fe->tuner_priv;\r\nunsigned char data[] = {0x80, 0x2c};\r\nstruct i2c_msg msg = {.addr = priv->i2c_addr, .flags = 0,\r\n.buf = data, .len = 2};\r\ntuner_transfer(fe, &msg, 1);\r\n}\r\nstatic int tda827x_release(struct dvb_frontend *fe)\r\n{\r\nkfree(fe->tuner_priv);\r\nfe->tuner_priv = NULL;\r\nreturn 0;\r\n}\r\nstatic int tda827x_get_frequency(struct dvb_frontend *fe, u32 *frequency)\r\n{\r\nstruct tda827x_priv *priv = fe->tuner_priv;\r\n*frequency = priv->frequency;\r\nreturn 0;\r\n}\r\nstatic int tda827x_get_bandwidth(struct dvb_frontend *fe, u32 *bandwidth)\r\n{\r\nstruct tda827x_priv *priv = fe->tuner_priv;\r\n*bandwidth = priv->bandwidth;\r\nreturn 0;\r\n}\r\nstatic int tda827x_init(struct dvb_frontend *fe)\r\n{\r\nstruct tda827x_priv *priv = fe->tuner_priv;\r\ndprintk("%s:\n", __func__);\r\nif (priv->cfg && priv->cfg->init)\r\npriv->cfg->init(fe);\r\nreturn 0;\r\n}\r\nstatic int tda827x_initial_init(struct dvb_frontend *fe)\r\n{\r\nint ret;\r\nret = tda827x_probe_version(fe);\r\nif (ret)\r\nreturn ret;\r\nreturn fe->ops.tuner_ops.init(fe);\r\n}\r\nstatic int tda827x_initial_sleep(struct dvb_frontend *fe)\r\n{\r\nint ret;\r\nret = tda827x_probe_version(fe);\r\nif (ret)\r\nreturn ret;\r\nreturn fe->ops.tuner_ops.sleep(fe);\r\n}\r\nstatic int tda827x_probe_version(struct dvb_frontend *fe)\r\n{\r\nu8 data;\r\nint rc;\r\nstruct tda827x_priv *priv = fe->tuner_priv;\r\nstruct i2c_msg msg = { .addr = priv->i2c_addr, .flags = I2C_M_RD,\r\n.buf = &data, .len = 1 };\r\nrc = tuner_transfer(fe, &msg, 1);\r\nif (rc < 0) {\r\nprintk("%s: could not read from tuner at addr: 0x%02x\n",\r\n__func__, msg.addr << 1);\r\nreturn rc;\r\n}\r\nif ((data & 0x3c) == 0) {\r\ndprintk("tda827x tuner found\n");\r\nfe->ops.tuner_ops.init = tda827x_init;\r\nfe->ops.tuner_ops.sleep = tda827xo_sleep;\r\nif (priv->cfg)\r\npriv->cfg->agcf = tda827xo_agcf;\r\n} else {\r\ndprintk("tda827xa tuner found\n");\r\nmemcpy(&fe->ops.tuner_ops, &tda827xa_tuner_ops, sizeof(struct dvb_tuner_ops));\r\nif (priv->cfg)\r\npriv->cfg->agcf = tda827xa_agcf;\r\n}\r\nreturn 0;\r\n}\r\nstruct dvb_frontend *tda827x_attach(struct dvb_frontend *fe, int addr,\r\nstruct i2c_adapter *i2c,\r\nstruct tda827x_config *cfg)\r\n{\r\nstruct tda827x_priv *priv = NULL;\r\ndprintk("%s:\n", __func__);\r\npriv = kzalloc(sizeof(struct tda827x_priv), GFP_KERNEL);\r\nif (priv == NULL)\r\nreturn NULL;\r\npriv->i2c_addr = addr;\r\npriv->i2c_adap = i2c;\r\npriv->cfg = cfg;\r\nmemcpy(&fe->ops.tuner_ops, &tda827xo_tuner_ops, sizeof(struct dvb_tuner_ops));\r\nfe->tuner_priv = priv;\r\ndprintk("type set to %s\n", fe->ops.tuner_ops.info.name);\r\nreturn fe;\r\n}

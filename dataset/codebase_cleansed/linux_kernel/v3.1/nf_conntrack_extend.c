void __nf_ct_ext_destroy(struct nf_conn *ct)\r\n{\r\nunsigned int i;\r\nstruct nf_ct_ext_type *t;\r\nstruct nf_ct_ext *ext = ct->ext;\r\nfor (i = 0; i < NF_CT_EXT_NUM; i++) {\r\nif (!__nf_ct_ext_exist(ext, i))\r\ncontinue;\r\nrcu_read_lock();\r\nt = rcu_dereference(nf_ct_ext_types[i]);\r\nif (t && t->destroy)\r\nt->destroy(ct);\r\nrcu_read_unlock();\r\n}\r\n}\r\nstatic void *\r\nnf_ct_ext_create(struct nf_ct_ext **ext, enum nf_ct_ext_id id, gfp_t gfp)\r\n{\r\nunsigned int off, len;\r\nstruct nf_ct_ext_type *t;\r\nsize_t alloc_size;\r\nrcu_read_lock();\r\nt = rcu_dereference(nf_ct_ext_types[id]);\r\nBUG_ON(t == NULL);\r\noff = ALIGN(sizeof(struct nf_ct_ext), t->align);\r\nlen = off + t->len;\r\nalloc_size = t->alloc_size;\r\nrcu_read_unlock();\r\n*ext = kzalloc(alloc_size, gfp);\r\nif (!*ext)\r\nreturn NULL;\r\n(*ext)->offset[id] = off;\r\n(*ext)->len = len;\r\nreturn (void *)(*ext) + off;\r\n}\r\nvoid *__nf_ct_ext_add(struct nf_conn *ct, enum nf_ct_ext_id id, gfp_t gfp)\r\n{\r\nstruct nf_ct_ext *old, *new;\r\nint i, newlen, newoff;\r\nstruct nf_ct_ext_type *t;\r\nNF_CT_ASSERT(!nf_ct_is_confirmed(ct));\r\nold = ct->ext;\r\nif (!old)\r\nreturn nf_ct_ext_create(&ct->ext, id, gfp);\r\nif (__nf_ct_ext_exist(old, id))\r\nreturn NULL;\r\nrcu_read_lock();\r\nt = rcu_dereference(nf_ct_ext_types[id]);\r\nBUG_ON(t == NULL);\r\nnewoff = ALIGN(old->len, t->align);\r\nnewlen = newoff + t->len;\r\nrcu_read_unlock();\r\nnew = __krealloc(old, newlen, gfp);\r\nif (!new)\r\nreturn NULL;\r\nif (new != old) {\r\nfor (i = 0; i < NF_CT_EXT_NUM; i++) {\r\nif (!__nf_ct_ext_exist(old, i))\r\ncontinue;\r\nrcu_read_lock();\r\nt = rcu_dereference(nf_ct_ext_types[i]);\r\nif (t && t->move)\r\nt->move((void *)new + new->offset[i],\r\n(void *)old + old->offset[i]);\r\nrcu_read_unlock();\r\n}\r\nkfree_rcu(old, rcu);\r\nct->ext = new;\r\n}\r\nnew->offset[id] = newoff;\r\nnew->len = newlen;\r\nmemset((void *)new + newoff, 0, newlen - newoff);\r\nreturn (void *)new + newoff;\r\n}\r\nstatic void update_alloc_size(struct nf_ct_ext_type *type)\r\n{\r\nint i, j;\r\nstruct nf_ct_ext_type *t1, *t2;\r\nenum nf_ct_ext_id min = 0, max = NF_CT_EXT_NUM - 1;\r\nif ((type->flags & NF_CT_EXT_F_PREALLOC) == 0) {\r\nmin = type->id;\r\nmax = type->id;\r\n}\r\nfor (i = min; i <= max; i++) {\r\nt1 = rcu_dereference_protected(nf_ct_ext_types[i],\r\nlockdep_is_held(&nf_ct_ext_type_mutex));\r\nif (!t1)\r\ncontinue;\r\nt1->alloc_size = ALIGN(sizeof(struct nf_ct_ext), t1->align) +\r\nt1->len;\r\nfor (j = 0; j < NF_CT_EXT_NUM; j++) {\r\nt2 = rcu_dereference_protected(nf_ct_ext_types[j],\r\nlockdep_is_held(&nf_ct_ext_type_mutex));\r\nif (t2 == NULL || t2 == t1 ||\r\n(t2->flags & NF_CT_EXT_F_PREALLOC) == 0)\r\ncontinue;\r\nt1->alloc_size = ALIGN(t1->alloc_size, t2->align)\r\n+ t2->len;\r\n}\r\n}\r\n}\r\nint nf_ct_extend_register(struct nf_ct_ext_type *type)\r\n{\r\nint ret = 0;\r\nmutex_lock(&nf_ct_ext_type_mutex);\r\nif (nf_ct_ext_types[type->id]) {\r\nret = -EBUSY;\r\ngoto out;\r\n}\r\ntype->alloc_size = ALIGN(sizeof(struct nf_ct_ext), type->align)\r\n+ type->len;\r\nrcu_assign_pointer(nf_ct_ext_types[type->id], type);\r\nupdate_alloc_size(type);\r\nout:\r\nmutex_unlock(&nf_ct_ext_type_mutex);\r\nreturn ret;\r\n}\r\nvoid nf_ct_extend_unregister(struct nf_ct_ext_type *type)\r\n{\r\nmutex_lock(&nf_ct_ext_type_mutex);\r\nrcu_assign_pointer(nf_ct_ext_types[type->id], NULL);\r\nupdate_alloc_size(type);\r\nmutex_unlock(&nf_ct_ext_type_mutex);\r\nrcu_barrier();\r\n}

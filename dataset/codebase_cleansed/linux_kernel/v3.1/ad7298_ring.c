int ad7298_scan_from_ring(struct iio_dev *dev_info, long ch)\r\n{\r\nstruct iio_ring_buffer *ring = dev_info->ring;\r\nint ret;\r\nu16 *ring_data;\r\nif (!(ring->scan_mask & (1 << ch))) {\r\nret = -EBUSY;\r\ngoto error_ret;\r\n}\r\nring_data = kmalloc(ring->access->get_bytes_per_datum(ring),\r\nGFP_KERNEL);\r\nif (ring_data == NULL) {\r\nret = -ENOMEM;\r\ngoto error_ret;\r\n}\r\nret = ring->access->read_last(ring, (u8 *) ring_data);\r\nif (ret)\r\ngoto error_free_ring_data;\r\nret = be16_to_cpu(ring_data[ch]);\r\nerror_free_ring_data:\r\nkfree(ring_data);\r\nerror_ret:\r\nreturn ret;\r\n}\r\nstatic int ad7298_ring_preenable(struct iio_dev *indio_dev)\r\n{\r\nstruct ad7298_state *st = iio_priv(indio_dev);\r\nstruct iio_ring_buffer *ring = indio_dev->ring;\r\nsize_t d_size;\r\nint i, m;\r\nunsigned short command;\r\nd_size = ring->scan_count * (AD7298_STORAGE_BITS / 8);\r\nif (ring->scan_timestamp) {\r\nd_size += sizeof(s64);\r\nif (d_size % sizeof(s64))\r\nd_size += sizeof(s64) - (d_size % sizeof(s64));\r\n}\r\nif (ring->access->set_bytes_per_datum)\r\nring->access->set_bytes_per_datum(ring, d_size);\r\nst->d_size = d_size;\r\ncommand = AD7298_WRITE | st->ext_ref;\r\nfor (i = 0, m = AD7298_CH(0); i < AD7298_MAX_CHAN; i++, m >>= 1)\r\nif (ring->scan_mask & (1 << i))\r\ncommand |= m;\r\nst->tx_buf[0] = cpu_to_be16(command);\r\nst->ring_xfer[0].tx_buf = &st->tx_buf[0];\r\nst->ring_xfer[0].len = 2;\r\nst->ring_xfer[0].cs_change = 1;\r\nst->ring_xfer[1].tx_buf = &st->tx_buf[1];\r\nst->ring_xfer[1].len = 2;\r\nst->ring_xfer[1].cs_change = 1;\r\nspi_message_init(&st->ring_msg);\r\nspi_message_add_tail(&st->ring_xfer[0], &st->ring_msg);\r\nspi_message_add_tail(&st->ring_xfer[1], &st->ring_msg);\r\nfor (i = 0; i < ring->scan_count; i++) {\r\nst->ring_xfer[i + 2].rx_buf = &st->rx_buf[i];\r\nst->ring_xfer[i + 2].len = 2;\r\nst->ring_xfer[i + 2].cs_change = 1;\r\nspi_message_add_tail(&st->ring_xfer[i + 2], &st->ring_msg);\r\n}\r\nst->ring_xfer[i + 1].cs_change = 0;\r\nreturn 0;\r\n}\r\nstatic irqreturn_t ad7298_trigger_handler(int irq, void *p)\r\n{\r\nstruct iio_poll_func *pf = p;\r\nstruct iio_dev *indio_dev = pf->private_data;\r\nstruct ad7298_state *st = iio_priv(indio_dev);\r\nstruct iio_ring_buffer *ring = indio_dev->ring;\r\ns64 time_ns;\r\n__u16 buf[16];\r\nint b_sent, i;\r\nb_sent = spi_sync(st->spi, &st->ring_msg);\r\nif (b_sent)\r\nreturn b_sent;\r\nif (ring->scan_timestamp) {\r\ntime_ns = iio_get_time_ns();\r\nmemcpy((u8 *)buf + st->d_size - sizeof(s64),\r\n&time_ns, sizeof(time_ns));\r\n}\r\nfor (i = 0; i < ring->scan_count; i++)\r\nbuf[i] = be16_to_cpu(st->rx_buf[i]);\r\nindio_dev->ring->access->store_to(ring, (u8 *)buf, time_ns);\r\niio_trigger_notify_done(indio_dev->trig);\r\nreturn IRQ_HANDLED;\r\n}\r\nint ad7298_register_ring_funcs_and_init(struct iio_dev *indio_dev)\r\n{\r\nint ret;\r\nindio_dev->ring = iio_sw_rb_allocate(indio_dev);\r\nif (!indio_dev->ring) {\r\nret = -ENOMEM;\r\ngoto error_ret;\r\n}\r\nindio_dev->ring->access = &ring_sw_access_funcs;\r\nindio_dev->pollfunc = iio_alloc_pollfunc(NULL,\r\n&ad7298_trigger_handler,\r\nIRQF_ONESHOT,\r\nindio_dev,\r\n"ad7298_consumer%d",\r\nindio_dev->id);\r\nif (indio_dev->pollfunc == NULL) {\r\nret = -ENOMEM;\r\ngoto error_deallocate_sw_rb;\r\n}\r\nindio_dev->ring->setup_ops = &ad7298_ring_setup_ops;\r\nindio_dev->ring->scan_timestamp = true;\r\nindio_dev->modes |= INDIO_RING_TRIGGERED;\r\nreturn 0;\r\nerror_deallocate_sw_rb:\r\niio_sw_rb_free(indio_dev->ring);\r\nerror_ret:\r\nreturn ret;\r\n}\r\nvoid ad7298_ring_cleanup(struct iio_dev *indio_dev)\r\n{\r\nif (indio_dev->trig) {\r\niio_put_trigger(indio_dev->trig);\r\niio_trigger_dettach_poll_func(indio_dev->trig,\r\nindio_dev->pollfunc);\r\n}\r\niio_dealloc_pollfunc(indio_dev->pollfunc);\r\niio_sw_rb_free(indio_dev->ring);\r\n}

static void tosa_bt_on(struct tosa_bt_data *data)\r\n{\r\ngpio_set_value(data->gpio_reset, 0);\r\ngpio_set_value(data->gpio_pwr, 1);\r\ngpio_set_value(data->gpio_reset, 1);\r\nmdelay(20);\r\ngpio_set_value(data->gpio_reset, 0);\r\n}\r\nstatic void tosa_bt_off(struct tosa_bt_data *data)\r\n{\r\ngpio_set_value(data->gpio_reset, 1);\r\nmdelay(10);\r\ngpio_set_value(data->gpio_pwr, 0);\r\ngpio_set_value(data->gpio_reset, 0);\r\n}\r\nstatic int tosa_bt_set_block(void *data, bool blocked)\r\n{\r\npr_info("BT_RADIO going: %s\n", blocked ? "off" : "on");\r\nif (!blocked) {\r\npr_info("TOSA_BT: going ON\n");\r\ntosa_bt_on(data);\r\n} else {\r\npr_info("TOSA_BT: going OFF\n");\r\ntosa_bt_off(data);\r\n}\r\nreturn 0;\r\n}\r\nstatic int tosa_bt_probe(struct platform_device *dev)\r\n{\r\nint rc;\r\nstruct rfkill *rfk;\r\nstruct tosa_bt_data *data = dev->dev.platform_data;\r\nrc = gpio_request(data->gpio_reset, "Bluetooth reset");\r\nif (rc)\r\ngoto err_reset;\r\nrc = gpio_direction_output(data->gpio_reset, 0);\r\nif (rc)\r\ngoto err_reset_dir;\r\nrc = gpio_request(data->gpio_pwr, "Bluetooth power");\r\nif (rc)\r\ngoto err_pwr;\r\nrc = gpio_direction_output(data->gpio_pwr, 0);\r\nif (rc)\r\ngoto err_pwr_dir;\r\nrfk = rfkill_alloc("tosa-bt", &dev->dev, RFKILL_TYPE_BLUETOOTH,\r\n&tosa_bt_rfkill_ops, data);\r\nif (!rfk) {\r\nrc = -ENOMEM;\r\ngoto err_rfk_alloc;\r\n}\r\nrc = rfkill_register(rfk);\r\nif (rc)\r\ngoto err_rfkill;\r\nplatform_set_drvdata(dev, rfk);\r\nreturn 0;\r\nerr_rfkill:\r\nrfkill_destroy(rfk);\r\nerr_rfk_alloc:\r\ntosa_bt_off(data);\r\nerr_pwr_dir:\r\ngpio_free(data->gpio_pwr);\r\nerr_pwr:\r\nerr_reset_dir:\r\ngpio_free(data->gpio_reset);\r\nerr_reset:\r\nreturn rc;\r\n}\r\nstatic int __devexit tosa_bt_remove(struct platform_device *dev)\r\n{\r\nstruct tosa_bt_data *data = dev->dev.platform_data;\r\nstruct rfkill *rfk = platform_get_drvdata(dev);\r\nplatform_set_drvdata(dev, NULL);\r\nif (rfk) {\r\nrfkill_unregister(rfk);\r\nrfkill_destroy(rfk);\r\n}\r\nrfk = NULL;\r\ntosa_bt_off(data);\r\ngpio_free(data->gpio_pwr);\r\ngpio_free(data->gpio_reset);\r\nreturn 0;\r\n}\r\nstatic int __init tosa_bt_init(void)\r\n{\r\nreturn platform_driver_register(&tosa_bt_driver);\r\n}\r\nstatic void __exit tosa_bt_exit(void)\r\n{\r\nplatform_driver_unregister(&tosa_bt_driver);\r\n}

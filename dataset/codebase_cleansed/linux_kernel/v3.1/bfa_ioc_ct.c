void\r\nbfa_nw_ioc_set_ct_hwif(struct bfa_ioc *ioc)\r\n{\r\nnw_hwif_ct.ioc_pll_init = bfa_ioc_ct_pll_init;\r\nnw_hwif_ct.ioc_firmware_lock = bfa_ioc_ct_firmware_lock;\r\nnw_hwif_ct.ioc_firmware_unlock = bfa_ioc_ct_firmware_unlock;\r\nnw_hwif_ct.ioc_reg_init = bfa_ioc_ct_reg_init;\r\nnw_hwif_ct.ioc_map_port = bfa_ioc_ct_map_port;\r\nnw_hwif_ct.ioc_isr_mode_set = bfa_ioc_ct_isr_mode_set;\r\nnw_hwif_ct.ioc_notify_fail = bfa_ioc_ct_notify_fail;\r\nnw_hwif_ct.ioc_ownership_reset = bfa_ioc_ct_ownership_reset;\r\nnw_hwif_ct.ioc_sync_start = bfa_ioc_ct_sync_start;\r\nnw_hwif_ct.ioc_sync_join = bfa_ioc_ct_sync_join;\r\nnw_hwif_ct.ioc_sync_leave = bfa_ioc_ct_sync_leave;\r\nnw_hwif_ct.ioc_sync_ack = bfa_ioc_ct_sync_ack;\r\nnw_hwif_ct.ioc_sync_complete = bfa_ioc_ct_sync_complete;\r\nioc->ioc_hwif = &nw_hwif_ct;\r\n}\r\nstatic bool\r\nbfa_ioc_ct_firmware_lock(struct bfa_ioc *ioc)\r\n{\r\nenum bfi_ioc_state ioc_fwstate;\r\nu32 usecnt;\r\nstruct bfi_ioc_image_hdr fwhdr;\r\nif (!ioc->cna)\r\nreturn true;\r\nif (bfa_cb_image_get_size(BFA_IOC_FWIMG_TYPE(ioc)) <\r\nBFA_IOC_FWIMG_MINSZ)\r\nreturn true;\r\nbfa_nw_ioc_sem_get(ioc->ioc_regs.ioc_usage_sem_reg);\r\nusecnt = readl(ioc->ioc_regs.ioc_usage_reg);\r\nif (usecnt == 0) {\r\nwritel(1, ioc->ioc_regs.ioc_usage_reg);\r\nbfa_nw_ioc_sem_release(ioc->ioc_regs.ioc_usage_sem_reg);\r\nwritel(0, ioc->ioc_regs.ioc_fail_sync);\r\nreturn true;\r\n}\r\nioc_fwstate = readl(ioc->ioc_regs.ioc_fwstate);\r\nBUG_ON(!(ioc_fwstate != BFI_IOC_UNINIT));\r\nbfa_nw_ioc_fwver_get(ioc, &fwhdr);\r\nif (!bfa_nw_ioc_fwver_cmp(ioc, &fwhdr)) {\r\nbfa_nw_ioc_sem_release(ioc->ioc_regs.ioc_usage_sem_reg);\r\nreturn false;\r\n}\r\nusecnt++;\r\nwritel(usecnt, ioc->ioc_regs.ioc_usage_reg);\r\nbfa_nw_ioc_sem_release(ioc->ioc_regs.ioc_usage_sem_reg);\r\nreturn true;\r\n}\r\nstatic void\r\nbfa_ioc_ct_firmware_unlock(struct bfa_ioc *ioc)\r\n{\r\nu32 usecnt;\r\nif (!ioc->cna)\r\nreturn;\r\nif (bfa_cb_image_get_size(BFA_IOC_FWIMG_TYPE(ioc)) <\r\nBFA_IOC_FWIMG_MINSZ)\r\nreturn;\r\nbfa_nw_ioc_sem_get(ioc->ioc_regs.ioc_usage_sem_reg);\r\nusecnt = readl(ioc->ioc_regs.ioc_usage_reg);\r\nBUG_ON(!(usecnt > 0));\r\nusecnt--;\r\nwritel(usecnt, ioc->ioc_regs.ioc_usage_reg);\r\nbfa_nw_ioc_sem_release(ioc->ioc_regs.ioc_usage_sem_reg);\r\n}\r\nstatic void\r\nbfa_ioc_ct_notify_fail(struct bfa_ioc *ioc)\r\n{\r\nif (ioc->cna) {\r\nwritel(__FW_INIT_HALT_P, ioc->ioc_regs.ll_halt);\r\nwritel(__FW_INIT_HALT_P, ioc->ioc_regs.alt_ll_halt);\r\nreadl(ioc->ioc_regs.ll_halt);\r\nreadl(ioc->ioc_regs.alt_ll_halt);\r\n} else {\r\nwritel(__PSS_ERR_STATUS_SET, ioc->ioc_regs.err_set);\r\nreadl(ioc->ioc_regs.err_set);\r\n}\r\n}\r\nstatic void\r\nbfa_ioc_ct_reg_init(struct bfa_ioc *ioc)\r\n{\r\nvoid __iomem *rb;\r\nint pcifn = bfa_ioc_pcifn(ioc);\r\nrb = bfa_ioc_bar0(ioc);\r\nioc->ioc_regs.hfn_mbox = rb + iocreg_fnreg[pcifn].hfn_mbox;\r\nioc->ioc_regs.lpu_mbox = rb + iocreg_fnreg[pcifn].lpu_mbox;\r\nioc->ioc_regs.host_page_num_fn = rb + iocreg_fnreg[pcifn].hfn_pgn;\r\nif (ioc->port_id == 0) {\r\nioc->ioc_regs.heartbeat = rb + BFA_IOC0_HBEAT_REG;\r\nioc->ioc_regs.ioc_fwstate = rb + BFA_IOC0_STATE_REG;\r\nioc->ioc_regs.alt_ioc_fwstate = rb + BFA_IOC1_STATE_REG;\r\nioc->ioc_regs.hfn_mbox_cmd = rb + iocreg_mbcmd_p0[pcifn].hfn;\r\nioc->ioc_regs.lpu_mbox_cmd = rb + iocreg_mbcmd_p0[pcifn].lpu;\r\nioc->ioc_regs.ll_halt = rb + FW_INIT_HALT_P0;\r\nioc->ioc_regs.alt_ll_halt = rb + FW_INIT_HALT_P1;\r\n} else {\r\nioc->ioc_regs.heartbeat = (rb + BFA_IOC1_HBEAT_REG);\r\nioc->ioc_regs.ioc_fwstate = (rb + BFA_IOC1_STATE_REG);\r\nioc->ioc_regs.alt_ioc_fwstate = rb + BFA_IOC0_STATE_REG;\r\nioc->ioc_regs.hfn_mbox_cmd = rb + iocreg_mbcmd_p1[pcifn].hfn;\r\nioc->ioc_regs.lpu_mbox_cmd = rb + iocreg_mbcmd_p1[pcifn].lpu;\r\nioc->ioc_regs.ll_halt = rb + FW_INIT_HALT_P1;\r\nioc->ioc_regs.alt_ll_halt = rb + FW_INIT_HALT_P0;\r\n}\r\nioc->ioc_regs.pss_ctl_reg = (rb + PSS_CTL_REG);\r\nioc->ioc_regs.pss_err_status_reg = (rb + PSS_ERR_STATUS_REG);\r\nioc->ioc_regs.app_pll_fast_ctl_reg = (rb + APP_PLL_425_CTL_REG);\r\nioc->ioc_regs.app_pll_slow_ctl_reg = (rb + APP_PLL_312_CTL_REG);\r\nioc->ioc_regs.ioc_sem_reg = (rb + HOST_SEM0_REG);\r\nioc->ioc_regs.ioc_usage_sem_reg = (rb + HOST_SEM1_REG);\r\nioc->ioc_regs.ioc_init_sem_reg = (rb + HOST_SEM2_REG);\r\nioc->ioc_regs.ioc_usage_reg = (rb + BFA_FW_USE_COUNT);\r\nioc->ioc_regs.ioc_fail_sync = (rb + BFA_IOC_FAIL_SYNC);\r\nioc->ioc_regs.smem_page_start = (rb + PSS_SMEM_PAGE_START);\r\nioc->ioc_regs.smem_pg0 = BFI_IOC_SMEM_PG0_CT;\r\nioc->ioc_regs.err_set = (rb + ERR_SET_REG);\r\n}\r\nstatic void\r\nbfa_ioc_ct_map_port(struct bfa_ioc *ioc)\r\n{\r\nvoid __iomem *rb = ioc->pcidev.pci_bar_kva;\r\nu32 r32;\r\nr32 = readl(rb + FNC_PERS_REG);\r\nr32 >>= FNC_PERS_FN_SHIFT(bfa_ioc_pcifn(ioc));\r\nioc->port_id = (r32 & __F0_PORT_MAP_MK) >> __F0_PORT_MAP_SH;\r\n}\r\nstatic void\r\nbfa_ioc_ct_isr_mode_set(struct bfa_ioc *ioc, bool msix)\r\n{\r\nvoid __iomem *rb = ioc->pcidev.pci_bar_kva;\r\nu32 r32, mode;\r\nr32 = readl(rb + FNC_PERS_REG);\r\nmode = (r32 >> FNC_PERS_FN_SHIFT(bfa_ioc_pcifn(ioc))) &\r\n__F0_INTX_STATUS;\r\nif (!msix && mode)\r\nreturn;\r\nif (msix)\r\nmode = __F0_INTX_STATUS_MSIX;\r\nelse\r\nmode = __F0_INTX_STATUS_INTA;\r\nr32 &= ~(__F0_INTX_STATUS << FNC_PERS_FN_SHIFT(bfa_ioc_pcifn(ioc)));\r\nr32 |= (mode << FNC_PERS_FN_SHIFT(bfa_ioc_pcifn(ioc)));\r\nwritel(r32, rb + FNC_PERS_REG);\r\n}\r\nstatic void\r\nbfa_ioc_ct_ownership_reset(struct bfa_ioc *ioc)\r\n{\r\nif (ioc->cna) {\r\nbfa_nw_ioc_sem_get(ioc->ioc_regs.ioc_usage_sem_reg);\r\nwritel(0, ioc->ioc_regs.ioc_usage_reg);\r\nbfa_nw_ioc_sem_release(ioc->ioc_regs.ioc_usage_sem_reg);\r\n}\r\nreadl(ioc->ioc_regs.ioc_sem_reg);\r\nbfa_nw_ioc_hw_sem_release(ioc);\r\n}\r\nstatic bool\r\nbfa_ioc_ct_sync_start(struct bfa_ioc *ioc)\r\n{\r\nu32 r32 = readl(ioc->ioc_regs.ioc_fail_sync);\r\nu32 sync_reqd = bfa_ioc_ct_get_sync_reqd(r32);\r\nif (sync_reqd & bfa_ioc_ct_sync_pos(ioc)) {\r\nwritel(0, ioc->ioc_regs.ioc_fail_sync);\r\nwritel(1, ioc->ioc_regs.ioc_usage_reg);\r\nwritel(BFI_IOC_UNINIT, ioc->ioc_regs.ioc_fwstate);\r\nwritel(BFI_IOC_UNINIT, ioc->ioc_regs.alt_ioc_fwstate);\r\nreturn true;\r\n}\r\nreturn bfa_ioc_ct_sync_complete(ioc);\r\n}\r\nstatic void\r\nbfa_ioc_ct_sync_join(struct bfa_ioc *ioc)\r\n{\r\nu32 r32 = readl(ioc->ioc_regs.ioc_fail_sync);\r\nu32 sync_pos = bfa_ioc_ct_sync_reqd_pos(ioc);\r\nwritel((r32 | sync_pos), ioc->ioc_regs.ioc_fail_sync);\r\n}\r\nstatic void\r\nbfa_ioc_ct_sync_leave(struct bfa_ioc *ioc)\r\n{\r\nu32 r32 = readl(ioc->ioc_regs.ioc_fail_sync);\r\nu32 sync_msk = bfa_ioc_ct_sync_reqd_pos(ioc) |\r\nbfa_ioc_ct_sync_pos(ioc);\r\nwritel((r32 & ~sync_msk), ioc->ioc_regs.ioc_fail_sync);\r\n}\r\nstatic void\r\nbfa_ioc_ct_sync_ack(struct bfa_ioc *ioc)\r\n{\r\nu32 r32 = readl(ioc->ioc_regs.ioc_fail_sync);\r\nwritel((r32 | bfa_ioc_ct_sync_pos(ioc)), ioc->ioc_regs.ioc_fail_sync);\r\n}\r\nstatic bool\r\nbfa_ioc_ct_sync_complete(struct bfa_ioc *ioc)\r\n{\r\nu32 r32 = readl(ioc->ioc_regs.ioc_fail_sync);\r\nu32 sync_reqd = bfa_ioc_ct_get_sync_reqd(r32);\r\nu32 sync_ackd = bfa_ioc_ct_get_sync_ackd(r32);\r\nu32 tmp_ackd;\r\nif (sync_ackd == 0)\r\nreturn true;\r\ntmp_ackd = sync_ackd;\r\nif ((sync_reqd & bfa_ioc_ct_sync_pos(ioc)) &&\r\n!(sync_ackd & bfa_ioc_ct_sync_pos(ioc)))\r\nsync_ackd |= bfa_ioc_ct_sync_pos(ioc);\r\nif (sync_reqd == sync_ackd) {\r\nwritel(bfa_ioc_ct_clear_sync_ackd(r32),\r\nioc->ioc_regs.ioc_fail_sync);\r\nwritel(BFI_IOC_FAIL, ioc->ioc_regs.ioc_fwstate);\r\nwritel(BFI_IOC_FAIL, ioc->ioc_regs.alt_ioc_fwstate);\r\nreturn true;\r\n}\r\nif (tmp_ackd != sync_ackd)\r\nwritel((r32 | sync_ackd), ioc->ioc_regs.ioc_fail_sync);\r\nreturn false;\r\n}\r\nstatic enum bfa_status\r\nbfa_ioc_ct_pll_init(void __iomem *rb, bool fcmode)\r\n{\r\nu32 pll_sclk, pll_fclk, r32;\r\npll_sclk = __APP_PLL_312_LRESETN | __APP_PLL_312_ENARST |\r\n__APP_PLL_312_RSEL200500 | __APP_PLL_312_P0_1(3U) |\r\n__APP_PLL_312_JITLMT0_1(3U) |\r\n__APP_PLL_312_CNTLMT0_1(1U);\r\npll_fclk = __APP_PLL_425_LRESETN | __APP_PLL_425_ENARST |\r\n__APP_PLL_425_RSEL200500 | __APP_PLL_425_P0_1(3U) |\r\n__APP_PLL_425_JITLMT0_1(3U) |\r\n__APP_PLL_425_CNTLMT0_1(1U);\r\nif (fcmode) {\r\nwritel(0, (rb + OP_MODE));\r\nwritel(__APP_EMS_CMLCKSEL |\r\n__APP_EMS_REFCKBUFEN2 |\r\n__APP_EMS_CHANNEL_SEL,\r\n(rb + ETH_MAC_SER_REG));\r\n} else {\r\nwritel(__GLOBAL_FCOE_MODE, (rb + OP_MODE));\r\nwritel(__APP_EMS_REFCKBUFEN1,\r\n(rb + ETH_MAC_SER_REG));\r\n}\r\nwritel(BFI_IOC_UNINIT, (rb + BFA_IOC0_STATE_REG));\r\nwritel(BFI_IOC_UNINIT, (rb + BFA_IOC1_STATE_REG));\r\nwritel(0xffffffffU, (rb + HOSTFN0_INT_MSK));\r\nwritel(0xffffffffU, (rb + HOSTFN1_INT_MSK));\r\nwritel(0xffffffffU, (rb + HOSTFN0_INT_STATUS));\r\nwritel(0xffffffffU, (rb + HOSTFN1_INT_STATUS));\r\nwritel(0xffffffffU, (rb + HOSTFN0_INT_MSK));\r\nwritel(0xffffffffU, (rb + HOSTFN1_INT_MSK));\r\nwritel(pll_sclk |\r\n__APP_PLL_312_LOGIC_SOFT_RESET,\r\nrb + APP_PLL_312_CTL_REG);\r\nwritel(pll_fclk |\r\n__APP_PLL_425_LOGIC_SOFT_RESET,\r\nrb + APP_PLL_425_CTL_REG);\r\nwritel(pll_sclk |\r\n__APP_PLL_312_LOGIC_SOFT_RESET | __APP_PLL_312_ENABLE,\r\nrb + APP_PLL_312_CTL_REG);\r\nwritel(pll_fclk |\r\n__APP_PLL_425_LOGIC_SOFT_RESET | __APP_PLL_425_ENABLE,\r\nrb + APP_PLL_425_CTL_REG);\r\nreadl(rb + HOSTFN0_INT_MSK);\r\nudelay(2000);\r\nwritel(0xffffffffU, (rb + HOSTFN0_INT_STATUS));\r\nwritel(0xffffffffU, (rb + HOSTFN1_INT_STATUS));\r\nwritel(pll_sclk |\r\n__APP_PLL_312_ENABLE,\r\nrb + APP_PLL_312_CTL_REG);\r\nwritel(pll_fclk |\r\n__APP_PLL_425_ENABLE,\r\nrb + APP_PLL_425_CTL_REG);\r\nif (!fcmode) {\r\nwritel(__PMM_1T_RESET_P, (rb + PMM_1T_RESET_REG_P0));\r\nwritel(__PMM_1T_RESET_P, (rb + PMM_1T_RESET_REG_P1));\r\n}\r\nr32 = readl((rb + PSS_CTL_REG));\r\nr32 &= ~__PSS_LMEM_RESET;\r\nwritel(r32, (rb + PSS_CTL_REG));\r\nudelay(1000);\r\nif (!fcmode) {\r\nwritel(0, (rb + PMM_1T_RESET_REG_P0));\r\nwritel(0, (rb + PMM_1T_RESET_REG_P1));\r\n}\r\nwritel(__EDRAM_BISTR_START, (rb + MBIST_CTL_REG));\r\nudelay(1000);\r\nr32 = readl((rb + MBIST_STAT_REG));\r\nwritel(0, (rb + MBIST_CTL_REG));\r\nreturn BFA_STATUS_OK;\r\n}

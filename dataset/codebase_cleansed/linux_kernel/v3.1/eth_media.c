static int send_msg(struct sk_buff *buf, struct tipc_bearer *tb_ptr,\r\nstruct tipc_media_addr *dest)\r\n{\r\nstruct sk_buff *clone;\r\nstruct net_device *dev;\r\nint delta;\r\nclone = skb_clone(buf, GFP_ATOMIC);\r\nif (!clone)\r\nreturn 0;\r\ndev = ((struct eth_bearer *)(tb_ptr->usr_handle))->dev;\r\ndelta = dev->hard_header_len - skb_headroom(buf);\r\nif ((delta > 0) &&\r\npskb_expand_head(clone, SKB_DATA_ALIGN(delta), 0, GFP_ATOMIC)) {\r\nkfree_skb(clone);\r\nreturn 0;\r\n}\r\nskb_reset_network_header(clone);\r\nclone->dev = dev;\r\ndev_hard_header(clone, dev, ETH_P_TIPC, &dest->dev_addr.eth_addr,\r\ndev->dev_addr, clone->len);\r\ndev_queue_xmit(clone);\r\nreturn 0;\r\n}\r\nstatic int recv_msg(struct sk_buff *buf, struct net_device *dev,\r\nstruct packet_type *pt, struct net_device *orig_dev)\r\n{\r\nstruct eth_bearer *eb_ptr = (struct eth_bearer *)pt->af_packet_priv;\r\nif (!net_eq(dev_net(dev), &init_net)) {\r\nkfree_skb(buf);\r\nreturn 0;\r\n}\r\nif (likely(eb_ptr->bearer)) {\r\nif (likely(buf->pkt_type <= PACKET_BROADCAST)) {\r\nbuf->next = NULL;\r\ntipc_recv_msg(buf, eb_ptr->bearer);\r\nreturn 0;\r\n}\r\n}\r\nkfree_skb(buf);\r\nreturn 0;\r\n}\r\nstatic int enable_bearer(struct tipc_bearer *tb_ptr)\r\n{\r\nstruct net_device *dev = NULL;\r\nstruct net_device *pdev = NULL;\r\nstruct eth_bearer *eb_ptr = &eth_bearers[0];\r\nstruct eth_bearer *stop = &eth_bearers[MAX_ETH_BEARERS];\r\nchar *driver_name = strchr((const char *)tb_ptr->name, ':') + 1;\r\nint pending_dev = 0;\r\nwhile (eb_ptr->dev) {\r\nif (!eb_ptr->bearer)\r\npending_dev++;\r\nif (++eb_ptr == stop)\r\nreturn pending_dev ? -EAGAIN : -EDQUOT;\r\n}\r\nfor_each_netdev(&init_net, pdev) {\r\nif (!strncmp(pdev->name, driver_name, IFNAMSIZ)) {\r\ndev = pdev;\r\nbreak;\r\n}\r\n}\r\nif (!dev)\r\nreturn -ENODEV;\r\nwhile ((eb_ptr != stop) && eb_ptr->dev && (eb_ptr->dev != dev))\r\neb_ptr++;\r\nif (eb_ptr == stop)\r\nreturn -EDQUOT;\r\nif (!eb_ptr->dev) {\r\neb_ptr->dev = dev;\r\neb_ptr->tipc_packet_type.type = htons(ETH_P_TIPC);\r\neb_ptr->tipc_packet_type.dev = dev;\r\neb_ptr->tipc_packet_type.func = recv_msg;\r\neb_ptr->tipc_packet_type.af_packet_priv = eb_ptr;\r\nINIT_LIST_HEAD(&(eb_ptr->tipc_packet_type.list));\r\ndev_hold(dev);\r\ndev_add_pack(&eb_ptr->tipc_packet_type);\r\n}\r\neb_ptr->bearer = tb_ptr;\r\ntb_ptr->usr_handle = (void *)eb_ptr;\r\ntb_ptr->mtu = dev->mtu;\r\ntb_ptr->blocked = 0;\r\ntb_ptr->addr.type = htonl(TIPC_MEDIA_TYPE_ETH);\r\nmemcpy(&tb_ptr->addr.dev_addr, dev->dev_addr, ETH_ALEN);\r\nreturn 0;\r\n}\r\nstatic void disable_bearer(struct tipc_bearer *tb_ptr)\r\n{\r\n((struct eth_bearer *)tb_ptr->usr_handle)->bearer = NULL;\r\n}\r\nstatic int recv_notification(struct notifier_block *nb, unsigned long evt,\r\nvoid *dv)\r\n{\r\nstruct net_device *dev = (struct net_device *)dv;\r\nstruct eth_bearer *eb_ptr = &eth_bearers[0];\r\nstruct eth_bearer *stop = &eth_bearers[MAX_ETH_BEARERS];\r\nif (!net_eq(dev_net(dev), &init_net))\r\nreturn NOTIFY_DONE;\r\nwhile ((eb_ptr->dev != dev)) {\r\nif (++eb_ptr == stop)\r\nreturn NOTIFY_DONE;\r\n}\r\nif (!eb_ptr->bearer)\r\nreturn NOTIFY_DONE;\r\neb_ptr->bearer->mtu = dev->mtu;\r\nswitch (evt) {\r\ncase NETDEV_CHANGE:\r\nif (netif_carrier_ok(dev))\r\ntipc_continue(eb_ptr->bearer);\r\nelse\r\ntipc_block_bearer(eb_ptr->bearer->name);\r\nbreak;\r\ncase NETDEV_UP:\r\ntipc_continue(eb_ptr->bearer);\r\nbreak;\r\ncase NETDEV_DOWN:\r\ntipc_block_bearer(eb_ptr->bearer->name);\r\nbreak;\r\ncase NETDEV_CHANGEMTU:\r\ncase NETDEV_CHANGEADDR:\r\ntipc_block_bearer(eb_ptr->bearer->name);\r\ntipc_continue(eb_ptr->bearer);\r\nbreak;\r\ncase NETDEV_UNREGISTER:\r\ncase NETDEV_CHANGENAME:\r\ntipc_disable_bearer(eb_ptr->bearer->name);\r\nbreak;\r\n}\r\nreturn NOTIFY_OK;\r\n}\r\nstatic char *eth_addr2str(struct tipc_media_addr *a, char *str_buf, int str_size)\r\n{\r\nunchar *addr = (unchar *)&a->dev_addr;\r\nif (str_size < 18)\r\n*str_buf = '\0';\r\nelse\r\nsprintf(str_buf, "%pM", addr);\r\nreturn str_buf;\r\n}\r\nint tipc_eth_media_start(void)\r\n{\r\nstruct tipc_media_addr bcast_addr;\r\nint res;\r\nif (eth_started)\r\nreturn -EINVAL;\r\nbcast_addr.type = htonl(TIPC_MEDIA_TYPE_ETH);\r\nmemset(&bcast_addr.dev_addr, 0xff, ETH_ALEN);\r\nmemset(eth_bearers, 0, sizeof(eth_bearers));\r\nres = tipc_register_media(TIPC_MEDIA_TYPE_ETH, "eth",\r\nenable_bearer, disable_bearer, send_msg,\r\neth_addr2str, &bcast_addr, ETH_LINK_PRIORITY,\r\nETH_LINK_TOLERANCE, ETH_LINK_WINDOW);\r\nif (res)\r\nreturn res;\r\nnotifier.notifier_call = &recv_notification;\r\nnotifier.priority = 0;\r\nres = register_netdevice_notifier(&notifier);\r\nif (!res)\r\neth_started = 1;\r\nreturn res;\r\n}\r\nvoid tipc_eth_media_stop(void)\r\n{\r\nint i;\r\nif (!eth_started)\r\nreturn;\r\nunregister_netdevice_notifier(&notifier);\r\nfor (i = 0; i < MAX_ETH_BEARERS ; i++) {\r\nif (eth_bearers[i].bearer) {\r\neth_bearers[i].bearer->blocked = 1;\r\neth_bearers[i].bearer = NULL;\r\n}\r\nif (eth_bearers[i].dev) {\r\ndev_remove_pack(&eth_bearers[i].tipc_packet_type);\r\ndev_put(eth_bearers[i].dev);\r\n}\r\n}\r\nmemset(&eth_bearers, 0, sizeof(eth_bearers));\r\neth_started = 0;\r\n}

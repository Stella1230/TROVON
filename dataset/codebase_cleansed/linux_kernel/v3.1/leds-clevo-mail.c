static int __init clevo_mail_led_dmi_callback(const struct dmi_system_id *id)\r\n{\r\nprintk(KERN_INFO KBUILD_MODNAME ": '%s' found\n", id->ident);\r\nreturn 1;\r\n}\r\nstatic void clevo_mail_led_set(struct led_classdev *led_cdev,\r\nenum led_brightness value)\r\n{\r\ni8042_lock_chip();\r\nif (value == LED_OFF)\r\ni8042_command(NULL, CLEVO_MAIL_LED_OFF);\r\nelse if (value <= LED_HALF)\r\ni8042_command(NULL, CLEVO_MAIL_LED_BLINK_0_5HZ);\r\nelse\r\ni8042_command(NULL, CLEVO_MAIL_LED_BLINK_1HZ);\r\ni8042_unlock_chip();\r\n}\r\nstatic int clevo_mail_led_blink(struct led_classdev *led_cdev,\r\nunsigned long *delay_on,\r\nunsigned long *delay_off)\r\n{\r\nint status = -EINVAL;\r\ni8042_lock_chip();\r\nif (*delay_on == 0 && *delay_off == 0 ) {\r\n*delay_on = 1000;\r\n*delay_off = 1000;\r\ni8042_command(NULL, CLEVO_MAIL_LED_BLINK_0_5HZ);\r\nstatus = 0;\r\n} else if (*delay_on == 500 && *delay_off == 500 ) {\r\ni8042_command(NULL, CLEVO_MAIL_LED_BLINK_1HZ);\r\nstatus = 0;\r\n} else if (*delay_on == 1000 && *delay_off == 1000 ) {\r\ni8042_command(NULL, CLEVO_MAIL_LED_BLINK_0_5HZ);\r\nstatus = 0;\r\n} else {\r\nprintk(KERN_DEBUG KBUILD_MODNAME\r\n": clevo_mail_led_blink(..., %lu, %lu),"\r\n" returning -EINVAL (unsupported)\n",\r\n*delay_on, *delay_off);\r\n}\r\ni8042_unlock_chip();\r\nreturn status;\r\n}\r\nstatic int __devinit clevo_mail_led_probe(struct platform_device *pdev)\r\n{\r\nreturn led_classdev_register(&pdev->dev, &clevo_mail_led);\r\n}\r\nstatic int clevo_mail_led_remove(struct platform_device *pdev)\r\n{\r\nled_classdev_unregister(&clevo_mail_led);\r\nreturn 0;\r\n}\r\nstatic int __init clevo_mail_led_init(void)\r\n{\r\nint error = 0;\r\nint count = 0;\r\nif (!nodetect) {\r\ncount = dmi_check_system(mail_led_whitelist);\r\n} else {\r\ncount = 1;\r\nprintk(KERN_ERR KBUILD_MODNAME ": Skipping DMI detection. "\r\n"If the driver works on your hardware please "\r\n"report model and the output of dmidecode in tracker "\r\n"at http://sourceforge.net/projects/clevo-mailled/\n");\r\n}\r\nif (!count)\r\nreturn -ENODEV;\r\npdev = platform_device_register_simple(KBUILD_MODNAME, -1, NULL, 0);\r\nif (!IS_ERR(pdev)) {\r\nerror = platform_driver_probe(&clevo_mail_led_driver,\r\nclevo_mail_led_probe);\r\nif (error) {\r\nprintk(KERN_ERR KBUILD_MODNAME\r\n": Can't probe platform driver\n");\r\nplatform_device_unregister(pdev);\r\n}\r\n} else\r\nerror = PTR_ERR(pdev);\r\nreturn error;\r\n}\r\nstatic void __exit clevo_mail_led_exit(void)\r\n{\r\nplatform_device_unregister(pdev);\r\nplatform_driver_unregister(&clevo_mail_led_driver);\r\nclevo_mail_led_set(NULL, LED_OFF);\r\n}

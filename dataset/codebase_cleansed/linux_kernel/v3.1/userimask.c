static ssize_t\r\nshow_intc_userimask(struct sysdev_class *cls,\r\nstruct sysdev_class_attribute *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "%d\n", (__raw_readl(uimask) >> 4) & 0xf);\r\n}\r\nstatic ssize_t\r\nstore_intc_userimask(struct sysdev_class *cls,\r\nstruct sysdev_class_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nunsigned long level;\r\nlevel = simple_strtoul(buf, NULL, 10);\r\nif (level >= intc_get_dfl_prio_level())\r\nreturn -EINVAL;\r\n__raw_writel(0xa5 << 24 | level << 4, uimask);\r\nreturn count;\r\n}\r\nstatic int __init userimask_sysdev_init(void)\r\n{\r\nif (unlikely(!uimask))\r\nreturn -ENXIO;\r\nreturn sysdev_class_create_file(&intc_sysdev_class, &attr_userimask);\r\n}\r\nint register_intc_userimask(unsigned long addr)\r\n{\r\nif (unlikely(uimask))\r\nreturn -EBUSY;\r\nuimask = ioremap_nocache(addr, SZ_4K);\r\nif (unlikely(!uimask))\r\nreturn -ENOMEM;\r\npr_info("userimask support registered for levels 0 -> %d\n",\r\nintc_get_dfl_prio_level() - 1);\r\nreturn 0;\r\n}

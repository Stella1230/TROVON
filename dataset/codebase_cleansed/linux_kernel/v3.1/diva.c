static int diva_find_free_adapters(int base, int nr)\r\n{\r\nint i;\r\nfor (i = 0; i < nr; i++) {\r\nif (IoAdapters[base + i]) {\r\nreturn (-1);\r\n}\r\n}\r\nreturn (0);\r\n}\r\nstatic diva_os_xdi_adapter_t *diva_q_get_next(struct list_head * what)\r\n{\r\ndiva_os_xdi_adapter_t *a = NULL;\r\nif (what && (what->next != &adapter_queue))\r\na = list_entry(what->next, diva_os_xdi_adapter_t, link);\r\nreturn(a);\r\n}\r\nvoid *diva_driver_add_card(void *pdev, unsigned long CardOrdinal)\r\n{\r\ndiva_os_spin_lock_magic_t old_irql;\r\ndiva_os_xdi_adapter_t *pdiva, *pa;\r\nint i, j, max, nr;\r\nfor (i = 0; divas_supported_cards[i].CardOrdinal != -1; i++) {\r\nif (divas_supported_cards[i].CardOrdinal == CardOrdinal) {\r\nif (!(pdiva = divas_create_pci_card(i, pdev))) {\r\nreturn NULL;\r\n}\r\nswitch (CardOrdinal) {\r\ncase CARDTYPE_DIVASRV_Q_8M_PCI:\r\ncase CARDTYPE_DIVASRV_VOICE_Q_8M_PCI:\r\ncase CARDTYPE_DIVASRV_Q_8M_V2_PCI:\r\ncase CARDTYPE_DIVASRV_VOICE_Q_8M_V2_PCI:\r\nmax = MAX_ADAPTER - 4;\r\nnr = 4;\r\nbreak;\r\ndefault:\r\nmax = MAX_ADAPTER;\r\nnr = 1;\r\n}\r\ndiva_os_enter_spin_lock(&adapter_lock, &old_irql, "add card");\r\nfor (i = 0; i < max; i++) {\r\nif (!diva_find_free_adapters(i, nr)) {\r\npdiva->controller = i + 1;\r\npdiva->xdi_adapter.ANum = pdiva->controller;\r\nIoAdapters[i] = &pdiva->xdi_adapter;\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "add card");\r\ncreate_adapter_proc(pdiva);\r\nDBG_LOG(("add %s:%d",\r\nCardProperties\r\n[CardOrdinal].Name,\r\npdiva->controller))\r\ndiva_os_enter_spin_lock(&adapter_lock, &old_irql, "add card");\r\npa = pdiva;\r\nfor (j = 1; j < nr; j++) {\r\npa = diva_q_get_next(&pa->link);\r\nif (pa && !pa->interface.cleanup_adapter_proc) {\r\npa->controller = i + 1 + j;\r\npa->xdi_adapter.ANum = pa->controller;\r\nIoAdapters[i + j] = &pa->xdi_adapter;\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "add card");\r\nDBG_LOG(("add slave adapter (%d)",\r\npa->controller))\r\ncreate_adapter_proc(pa);\r\ndiva_os_enter_spin_lock(&adapter_lock, &old_irql, "add card");\r\n} else {\r\nDBG_ERR(("slave adapter problem"))\r\nbreak;\r\n}\r\n}\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "add card");\r\nreturn (pdiva);\r\n}\r\n}\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "add card");\r\nDBG_ERR(("can not alloc request array"))\r\ndiva_driver_remove_card(pdiva);\r\nreturn NULL;\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nint divasa_xdi_driver_entry(void)\r\n{\r\ndiva_os_initialize_spin_lock(&adapter_lock, "adapter");\r\nmemset(&IoAdapters[0], 0x00, sizeof(IoAdapters));\r\ndiva_init_request_array();\r\nreturn (0);\r\n}\r\nstatic diva_os_xdi_adapter_t *get_and_remove_from_queue(void)\r\n{\r\ndiva_os_spin_lock_magic_t old_irql;\r\ndiva_os_xdi_adapter_t *a = NULL;\r\ndiva_os_enter_spin_lock(&adapter_lock, &old_irql, "driver_unload");\r\nif (!list_empty(&adapter_queue)) {\r\na = list_entry(adapter_queue.next, diva_os_xdi_adapter_t, link);\r\nlist_del(adapter_queue.next);\r\n}\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "driver_unload");\r\nreturn (a);\r\n}\r\nvoid diva_driver_remove_card(void *pdiva)\r\n{\r\ndiva_os_spin_lock_magic_t old_irql;\r\ndiva_os_xdi_adapter_t *a[4];\r\ndiva_os_xdi_adapter_t *pa;\r\nint i;\r\npa = a[0] = (diva_os_xdi_adapter_t *) pdiva;\r\na[1] = a[2] = a[3] = NULL;\r\ndiva_os_enter_spin_lock(&adapter_lock, &old_irql, "remode adapter");\r\nfor (i = 1; i < 4; i++) {\r\nif ((pa = diva_q_get_next(&pa->link))\r\n&& !pa->interface.cleanup_adapter_proc) {\r\na[i] = pa;\r\n} else {\r\nbreak;\r\n}\r\n}\r\nfor (i = 0; ((i < 4) && a[i]); i++) {\r\nlist_del(&a[i]->link);\r\n}\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "driver_unload");\r\n(*(a[0]->interface.cleanup_adapter_proc)) (a[0]);\r\nfor (i = 0; i < 4; i++) {\r\nif (a[i]) {\r\nif (a[i]->controller) {\r\nDBG_LOG(("remove adapter (%d)",\r\na[i]->controller)) IoAdapters[a[i]->controller - 1] = NULL;\r\nremove_adapter_proc(a[i]);\r\n}\r\ndiva_os_free(0, a[i]);\r\n}\r\n}\r\n}\r\nstatic void *divas_create_pci_card(int handle, void *pci_dev_handle)\r\n{\r\ndiva_supported_cards_info_t *pI = &divas_supported_cards[handle];\r\ndiva_os_spin_lock_magic_t old_irql;\r\ndiva_os_xdi_adapter_t *a;\r\nDBG_LOG(("found %d-%s", pI->CardOrdinal, CardProperties[pI->CardOrdinal].Name))\r\nif (!(a = (diva_os_xdi_adapter_t *) diva_os_malloc(0, sizeof(*a)))) {\r\nDBG_ERR(("A: can't alloc adapter"));\r\nreturn NULL;\r\n}\r\nmemset(a, 0x00, sizeof(*a));\r\na->CardIndex = handle;\r\na->CardOrdinal = pI->CardOrdinal;\r\na->Bus = DIVAS_XDI_ADAPTER_BUS_PCI;\r\na->xdi_adapter.cardType = a->CardOrdinal;\r\na->resources.pci.bus = diva_os_get_pci_bus(pci_dev_handle);\r\na->resources.pci.func = diva_os_get_pci_func(pci_dev_handle);\r\na->resources.pci.hdev = pci_dev_handle;\r\ndiva_os_enter_spin_lock(&adapter_lock, &old_irql, "found_pci_card");\r\nlist_add_tail(&a->link, &adapter_queue);\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "found_pci_card");\r\nif ((*(pI->init_card)) (a)) {\r\ndiva_os_enter_spin_lock(&adapter_lock, &old_irql, "found_pci_card");\r\nlist_del(&a->link);\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "found_pci_card");\r\ndiva_os_free(0, a);\r\nDBG_ERR(("A: can't get adapter resources"));\r\nreturn NULL;\r\n}\r\nreturn (a);\r\n}\r\nvoid divasa_xdi_driver_unload(void)\r\n{\r\ndiva_os_xdi_adapter_t *a;\r\nwhile ((a = get_and_remove_from_queue())) {\r\nif (a->interface.cleanup_adapter_proc) {\r\n(*(a->interface.cleanup_adapter_proc)) (a);\r\n}\r\nif (a->controller) {\r\nIoAdapters[a->controller - 1] = NULL;\r\nremove_adapter_proc(a);\r\n}\r\ndiva_os_free(0, a);\r\n}\r\ndiva_os_destroy_spin_lock(&adapter_lock, "adapter");\r\n}\r\nvoid *diva_xdi_open_adapter(void *os_handle, const void __user *src,\r\nint length,\r\ndivas_xdi_copy_from_user_fn_t cp_fn)\r\n{\r\ndiva_xdi_um_cfg_cmd_t msg;\r\ndiva_os_xdi_adapter_t *a = NULL;\r\ndiva_os_spin_lock_magic_t old_irql;\r\nstruct list_head *tmp;\r\nif (length < sizeof(diva_xdi_um_cfg_cmd_t)) {\r\nDBG_ERR(("A: A(?) open, msg too small (%d < %d)",\r\nlength, sizeof(diva_xdi_um_cfg_cmd_t)))\r\nreturn NULL;\r\n}\r\nif ((*cp_fn) (os_handle, &msg, src, sizeof(msg)) <= 0) {\r\nDBG_ERR(("A: A(?) open, write error"))\r\nreturn NULL;\r\n}\r\ndiva_os_enter_spin_lock(&adapter_lock, &old_irql, "open_adapter");\r\nlist_for_each(tmp, &adapter_queue) {\r\na = list_entry(tmp, diva_os_xdi_adapter_t, link);\r\nif (a->controller == (int)msg.adapter)\r\nbreak;\r\na = NULL;\r\n}\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "open_adapter");\r\nif (!a) {\r\nDBG_ERR(("A: A(%d) open, adapter not found", msg.adapter))\r\n}\r\nreturn (a);\r\n}\r\nvoid diva_xdi_close_adapter(void *adapter, void *os_handle)\r\n{\r\ndiva_os_xdi_adapter_t *a = (diva_os_xdi_adapter_t *) adapter;\r\na->xdi_mbox.status &= ~DIVA_XDI_MBOX_BUSY;\r\nif (a->xdi_mbox.data) {\r\ndiva_os_free(0, a->xdi_mbox.data);\r\na->xdi_mbox.data = NULL;\r\n}\r\n}\r\nint\r\ndiva_xdi_write(void *adapter, void *os_handle, const void __user *src,\r\nint length, divas_xdi_copy_from_user_fn_t cp_fn)\r\n{\r\ndiva_os_xdi_adapter_t *a = (diva_os_xdi_adapter_t *) adapter;\r\nvoid *data;\r\nif (a->xdi_mbox.status & DIVA_XDI_MBOX_BUSY) {\r\nDBG_ERR(("A: A(%d) write, mbox busy", a->controller))\r\nreturn (-1);\r\n}\r\nif (length < sizeof(diva_xdi_um_cfg_cmd_t)) {\r\nDBG_ERR(("A: A(%d) write, message too small (%d < %d)",\r\na->controller, length,\r\nsizeof(diva_xdi_um_cfg_cmd_t)))\r\nreturn (-3);\r\n}\r\nif (!(data = diva_os_malloc(0, length))) {\r\nDBG_ERR(("A: A(%d) write, ENOMEM", a->controller))\r\nreturn (-2);\r\n}\r\nlength = (*cp_fn) (os_handle, data, src, length);\r\nif (length > 0) {\r\nif ((*(a->interface.cmd_proc))\r\n(a, (diva_xdi_um_cfg_cmd_t *) data, length)) {\r\nlength = -3;\r\n}\r\n} else {\r\nDBG_ERR(("A: A(%d) write error (%d)", a->controller,\r\nlength))\r\n}\r\ndiva_os_free(0, data);\r\nreturn (length);\r\n}\r\nint\r\ndiva_xdi_read(void *adapter, void *os_handle, void __user *dst,\r\nint max_length, divas_xdi_copy_to_user_fn_t cp_fn)\r\n{\r\ndiva_os_xdi_adapter_t *a = (diva_os_xdi_adapter_t *) adapter;\r\nint ret;\r\nif (!(a->xdi_mbox.status & DIVA_XDI_MBOX_BUSY)) {\r\nDBG_ERR(("A: A(%d) rx mbox empty", a->controller))\r\nreturn (-1);\r\n}\r\nif (!a->xdi_mbox.data) {\r\na->xdi_mbox.status &= ~DIVA_XDI_MBOX_BUSY;\r\nDBG_ERR(("A: A(%d) rx ENOMEM", a->controller))\r\nreturn (-2);\r\n}\r\nif (max_length < a->xdi_mbox.data_length) {\r\nDBG_ERR(("A: A(%d) rx buffer too short(%d < %d)",\r\na->controller, max_length,\r\na->xdi_mbox.data_length))\r\nreturn (-3);\r\n}\r\nret = (*cp_fn) (os_handle, dst, a->xdi_mbox.data,\r\na->xdi_mbox.data_length);\r\nif (ret > 0) {\r\ndiva_os_free(0, a->xdi_mbox.data);\r\na->xdi_mbox.data = NULL;\r\na->xdi_mbox.status &= ~DIVA_XDI_MBOX_BUSY;\r\n}\r\nreturn (ret);\r\n}\r\nirqreturn_t diva_os_irq_wrapper(int irq, void *context)\r\n{\r\ndiva_os_xdi_adapter_t *a = context;\r\ndiva_xdi_clear_interrupts_proc_t clear_int_proc;\r\nif (!a || !a->xdi_adapter.diva_isr_handler)\r\nreturn IRQ_NONE;\r\nif ((clear_int_proc = a->clear_interrupts_proc)) {\r\n(*clear_int_proc) (a);\r\na->clear_interrupts_proc = NULL;\r\nreturn IRQ_HANDLED;\r\n}\r\n(*(a->xdi_adapter.diva_isr_handler)) (&a->xdi_adapter);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void diva_init_request_array(void)\r\n{\r\nRequests[0] = DivaIdiRequest0;\r\nRequests[1] = DivaIdiRequest1;\r\nRequests[2] = DivaIdiRequest2;\r\nRequests[3] = DivaIdiRequest3;\r\nRequests[4] = DivaIdiRequest4;\r\nRequests[5] = DivaIdiRequest5;\r\nRequests[6] = DivaIdiRequest6;\r\nRequests[7] = DivaIdiRequest7;\r\nRequests[8] = DivaIdiRequest8;\r\nRequests[9] = DivaIdiRequest9;\r\nRequests[10] = DivaIdiRequest10;\r\nRequests[11] = DivaIdiRequest11;\r\nRequests[12] = DivaIdiRequest12;\r\nRequests[13] = DivaIdiRequest13;\r\nRequests[14] = DivaIdiRequest14;\r\nRequests[15] = DivaIdiRequest15;\r\nRequests[16] = DivaIdiRequest16;\r\nRequests[17] = DivaIdiRequest17;\r\nRequests[18] = DivaIdiRequest18;\r\nRequests[19] = DivaIdiRequest19;\r\nRequests[20] = DivaIdiRequest20;\r\nRequests[21] = DivaIdiRequest21;\r\nRequests[22] = DivaIdiRequest22;\r\nRequests[23] = DivaIdiRequest23;\r\nRequests[24] = DivaIdiRequest24;\r\nRequests[25] = DivaIdiRequest25;\r\nRequests[26] = DivaIdiRequest26;\r\nRequests[27] = DivaIdiRequest27;\r\nRequests[28] = DivaIdiRequest28;\r\nRequests[29] = DivaIdiRequest29;\r\nRequests[30] = DivaIdiRequest30;\r\nRequests[31] = DivaIdiRequest31;\r\n}\r\nvoid diva_xdi_display_adapter_features(int card)\r\n{\r\ndword features;\r\nif (!card || ((card - 1) >= MAX_ADAPTER) || !IoAdapters[card - 1]) {\r\nreturn;\r\n}\r\ncard--;\r\nfeatures = IoAdapters[card]->Properties.Features;\r\nDBG_LOG(("FEATURES FOR ADAPTER: %d", card + 1))\r\nDBG_LOG((" DI_FAX3 : %s",\r\n(features & DI_FAX3) ? "Y" : "N"))\r\nDBG_LOG((" DI_MODEM : %s",\r\n(features & DI_MODEM) ? "Y" : "N"))\r\nDBG_LOG((" DI_POST : %s",\r\n(features & DI_POST) ? "Y" : "N"))\r\nDBG_LOG((" DI_V110 : %s",\r\n(features & DI_V110) ? "Y" : "N"))\r\nDBG_LOG((" DI_V120 : %s",\r\n(features & DI_V120) ? "Y" : "N"))\r\nDBG_LOG((" DI_POTS : %s",\r\n(features & DI_POTS) ? "Y" : "N"))\r\nDBG_LOG((" DI_CODEC : %s",\r\n(features & DI_CODEC) ? "Y" : "N"))\r\nDBG_LOG((" DI_MANAGE : %s",\r\n(features & DI_MANAGE) ? "Y" : "N"))\r\nDBG_LOG((" DI_V_42 : %s",\r\n(features & DI_V_42) ? "Y" : "N"))\r\nDBG_LOG((" DI_EXTD_FAX : %s",\r\n(features & DI_EXTD_FAX) ? "Y" : "N"))\r\nDBG_LOG((" DI_AT_PARSER : %s",\r\n(features & DI_AT_PARSER) ? "Y" : "N"))\r\nDBG_LOG((" DI_VOICE_OVER_IP : %s",\r\n(features & DI_VOICE_OVER_IP) ? "Y" : "N"))\r\n}\r\nvoid diva_add_slave_adapter(diva_os_xdi_adapter_t * a)\r\n{\r\ndiva_os_spin_lock_magic_t old_irql;\r\ndiva_os_enter_spin_lock(&adapter_lock, &old_irql, "add_slave");\r\nlist_add_tail(&a->link, &adapter_queue);\r\ndiva_os_leave_spin_lock(&adapter_lock, &old_irql, "add_slave");\r\n}\r\nint diva_card_read_xlog(diva_os_xdi_adapter_t * a)\r\n{\r\ndiva_get_xlog_t *req;\r\nbyte *data;\r\nif (!a->xdi_adapter.Initialized || !a->xdi_adapter.DIRequest) {\r\nreturn (-1);\r\n}\r\nif (!(data = diva_os_malloc(0, sizeof(struct mi_pc_maint)))) {\r\nreturn (-1);\r\n}\r\nmemset(data, 0x00, sizeof(struct mi_pc_maint));\r\nif (!(req = diva_os_malloc(0, sizeof(*req)))) {\r\ndiva_os_free(0, data);\r\nreturn (-1);\r\n}\r\nreq->command = 0x0400;\r\nreq->req = LOG;\r\nreq->rc = 0x00;\r\n(*(a->xdi_adapter.DIRequest)) (&a->xdi_adapter, (ENTITY *) req);\r\nif (!req->rc || req->req) {\r\ndiva_os_free(0, data);\r\ndiva_os_free(0, req);\r\nreturn (-1);\r\n}\r\nmemcpy(data, &req->req, sizeof(struct mi_pc_maint));\r\ndiva_os_free(0, req);\r\na->xdi_mbox.data_length = sizeof(struct mi_pc_maint);\r\na->xdi_mbox.data = data;\r\na->xdi_mbox.status = DIVA_XDI_MBOX_BUSY;\r\nreturn (0);\r\n}\r\nvoid xdiFreeFile(void *handle)\r\n{\r\n}

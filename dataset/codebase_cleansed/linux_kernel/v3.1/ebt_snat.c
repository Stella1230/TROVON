static unsigned int\r\nebt_snat_tg(struct sk_buff *skb, const struct xt_action_param *par)\r\n{\r\nconst struct ebt_nat_info *info = par->targinfo;\r\nif (!skb_make_writable(skb, 0))\r\nreturn EBT_DROP;\r\nmemcpy(eth_hdr(skb)->h_source, info->mac, ETH_ALEN);\r\nif (!(info->target & NAT_ARP_BIT) &&\r\neth_hdr(skb)->h_proto == htons(ETH_P_ARP)) {\r\nconst struct arphdr *ap;\r\nstruct arphdr _ah;\r\nap = skb_header_pointer(skb, 0, sizeof(_ah), &_ah);\r\nif (ap == NULL)\r\nreturn EBT_DROP;\r\nif (ap->ar_hln != ETH_ALEN)\r\ngoto out;\r\nif (skb_store_bits(skb, sizeof(_ah), info->mac,ETH_ALEN))\r\nreturn EBT_DROP;\r\n}\r\nout:\r\nreturn info->target | ~EBT_VERDICT_BITS;\r\n}\r\nstatic int ebt_snat_tg_check(const struct xt_tgchk_param *par)\r\n{\r\nconst struct ebt_nat_info *info = par->targinfo;\r\nint tmp;\r\ntmp = info->target | ~EBT_VERDICT_BITS;\r\nif (BASE_CHAIN && tmp == EBT_RETURN)\r\nreturn -EINVAL;\r\nif (tmp < -NUM_STANDARD_TARGETS || tmp >= 0)\r\nreturn -EINVAL;\r\ntmp = info->target | EBT_VERDICT_BITS;\r\nif ((tmp & ~NAT_ARP_BIT) != ~NAT_ARP_BIT)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int __init ebt_snat_init(void)\r\n{\r\nreturn xt_register_target(&ebt_snat_tg_reg);\r\n}\r\nstatic void __exit ebt_snat_fini(void)\r\n{\r\nxt_unregister_target(&ebt_snat_tg_reg);\r\n}

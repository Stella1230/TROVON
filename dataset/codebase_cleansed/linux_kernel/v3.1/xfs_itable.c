STATIC int\r\nxfs_internal_inum(\r\nxfs_mount_t *mp,\r\nxfs_ino_t ino)\r\n{\r\nreturn (ino == mp->m_sb.sb_rbmino || ino == mp->m_sb.sb_rsumino ||\r\n(xfs_sb_version_hasquota(&mp->m_sb) &&\r\n(ino == mp->m_sb.sb_uquotino || ino == mp->m_sb.sb_gquotino)));\r\n}\r\nint\r\nxfs_bulkstat_one_int(\r\nstruct xfs_mount *mp,\r\nxfs_ino_t ino,\r\nvoid __user *buffer,\r\nint ubsize,\r\nbulkstat_one_fmt_pf formatter,\r\nint *ubused,\r\nint *stat)\r\n{\r\nstruct xfs_icdinode *dic;\r\nstruct xfs_inode *ip;\r\nstruct inode *inode;\r\nstruct xfs_bstat *buf;\r\nint error = 0;\r\n*stat = BULKSTAT_RV_NOTHING;\r\nif (!buffer || xfs_internal_inum(mp, ino))\r\nreturn XFS_ERROR(EINVAL);\r\nbuf = kmem_alloc(sizeof(*buf), KM_SLEEP | KM_MAYFAIL);\r\nif (!buf)\r\nreturn XFS_ERROR(ENOMEM);\r\nerror = xfs_iget(mp, NULL, ino,\r\nXFS_IGET_UNTRUSTED, XFS_ILOCK_SHARED, &ip);\r\nif (error) {\r\n*stat = BULKSTAT_RV_NOTHING;\r\ngoto out_free;\r\n}\r\nASSERT(ip != NULL);\r\nASSERT(ip->i_imap.im_blkno != 0);\r\ndic = &ip->i_d;\r\ninode = VFS_I(ip);\r\nbuf->bs_nlink = dic->di_nlink;\r\nbuf->bs_projid_lo = dic->di_projid_lo;\r\nbuf->bs_projid_hi = dic->di_projid_hi;\r\nbuf->bs_ino = ino;\r\nbuf->bs_mode = dic->di_mode;\r\nbuf->bs_uid = dic->di_uid;\r\nbuf->bs_gid = dic->di_gid;\r\nbuf->bs_size = dic->di_size;\r\nbuf->bs_atime.tv_sec = inode->i_atime.tv_sec;\r\nbuf->bs_atime.tv_nsec = inode->i_atime.tv_nsec;\r\nbuf->bs_mtime.tv_sec = inode->i_mtime.tv_sec;\r\nbuf->bs_mtime.tv_nsec = inode->i_mtime.tv_nsec;\r\nbuf->bs_ctime.tv_sec = inode->i_ctime.tv_sec;\r\nbuf->bs_ctime.tv_nsec = inode->i_ctime.tv_nsec;\r\nbuf->bs_xflags = xfs_ip2xflags(ip);\r\nbuf->bs_extsize = dic->di_extsize << mp->m_sb.sb_blocklog;\r\nbuf->bs_extents = dic->di_nextents;\r\nbuf->bs_gen = dic->di_gen;\r\nmemset(buf->bs_pad, 0, sizeof(buf->bs_pad));\r\nbuf->bs_dmevmask = dic->di_dmevmask;\r\nbuf->bs_dmstate = dic->di_dmstate;\r\nbuf->bs_aextents = dic->di_anextents;\r\nbuf->bs_forkoff = XFS_IFORK_BOFF(ip);\r\nswitch (dic->di_format) {\r\ncase XFS_DINODE_FMT_DEV:\r\nbuf->bs_rdev = ip->i_df.if_u2.if_rdev;\r\nbuf->bs_blksize = BLKDEV_IOSIZE;\r\nbuf->bs_blocks = 0;\r\nbreak;\r\ncase XFS_DINODE_FMT_LOCAL:\r\ncase XFS_DINODE_FMT_UUID:\r\nbuf->bs_rdev = 0;\r\nbuf->bs_blksize = mp->m_sb.sb_blocksize;\r\nbuf->bs_blocks = 0;\r\nbreak;\r\ncase XFS_DINODE_FMT_EXTENTS:\r\ncase XFS_DINODE_FMT_BTREE:\r\nbuf->bs_rdev = 0;\r\nbuf->bs_blksize = mp->m_sb.sb_blocksize;\r\nbuf->bs_blocks = dic->di_nblocks + ip->i_delayed_blks;\r\nbreak;\r\n}\r\nxfs_iunlock(ip, XFS_ILOCK_SHARED);\r\nIRELE(ip);\r\nerror = formatter(buffer, ubsize, ubused, buf);\r\nif (!error)\r\n*stat = BULKSTAT_RV_DIDONE;\r\nout_free:\r\nkmem_free(buf);\r\nreturn error;\r\n}\r\nSTATIC int\r\nxfs_bulkstat_one_fmt(\r\nvoid __user *ubuffer,\r\nint ubsize,\r\nint *ubused,\r\nconst xfs_bstat_t *buffer)\r\n{\r\nif (ubsize < sizeof(*buffer))\r\nreturn XFS_ERROR(ENOMEM);\r\nif (copy_to_user(ubuffer, buffer, sizeof(*buffer)))\r\nreturn XFS_ERROR(EFAULT);\r\nif (ubused)\r\n*ubused = sizeof(*buffer);\r\nreturn 0;\r\n}\r\nint\r\nxfs_bulkstat_one(\r\nxfs_mount_t *mp,\r\nxfs_ino_t ino,\r\nvoid __user *buffer,\r\nint ubsize,\r\nint *ubused,\r\nint *stat)\r\n{\r\nreturn xfs_bulkstat_one_int(mp, ino, buffer, ubsize,\r\nxfs_bulkstat_one_fmt, ubused, stat);\r\n}\r\nint\r\nxfs_bulkstat(\r\nxfs_mount_t *mp,\r\nxfs_ino_t *lastinop,\r\nint *ubcountp,\r\nbulkstat_one_pf formatter,\r\nsize_t statstruct_size,\r\nchar __user *ubuffer,\r\nint *done)\r\n{\r\nxfs_agblock_t agbno=0;\r\nxfs_buf_t *agbp;\r\nxfs_agi_t *agi;\r\nxfs_agino_t agino;\r\nxfs_agnumber_t agno;\r\nint chunkidx;\r\nint clustidx;\r\nxfs_btree_cur_t *cur;\r\nint end_of_ag;\r\nint error;\r\nint fmterror;\r\nint i;\r\nint icount;\r\nsize_t irbsize;\r\nxfs_ino_t ino;\r\nxfs_inobt_rec_incore_t *irbp;\r\nxfs_inobt_rec_incore_t *irbuf;\r\nxfs_inobt_rec_incore_t *irbufend;\r\nxfs_ino_t lastino;\r\nint nbcluster;\r\nint nicluster;\r\nint nimask;\r\nint nirbuf;\r\nint rval;\r\nint tmp;\r\nint ubcount;\r\nint ubleft;\r\nchar __user *ubufp;\r\nint ubelem;\r\nint ubused;\r\nxfs_buf_t *bp;\r\nino = (xfs_ino_t)*lastinop;\r\nlastino = ino;\r\nagno = XFS_INO_TO_AGNO(mp, ino);\r\nagino = XFS_INO_TO_AGINO(mp, ino);\r\nif (agno >= mp->m_sb.sb_agcount ||\r\nino != XFS_AGINO_TO_INO(mp, agno, agino)) {\r\n*done = 1;\r\n*ubcountp = 0;\r\nreturn 0;\r\n}\r\nif (!ubcountp || *ubcountp <= 0) {\r\nreturn EINVAL;\r\n}\r\nubcount = *ubcountp;\r\nubleft = ubcount * statstruct_size;\r\n*ubcountp = ubelem = 0;\r\n*done = 0;\r\nfmterror = 0;\r\nubufp = ubuffer;\r\nnicluster = mp->m_sb.sb_blocksize >= XFS_INODE_CLUSTER_SIZE(mp) ?\r\nmp->m_sb.sb_inopblock :\r\n(XFS_INODE_CLUSTER_SIZE(mp) >> mp->m_sb.sb_inodelog);\r\nnimask = ~(nicluster - 1);\r\nnbcluster = nicluster >> mp->m_sb.sb_inopblog;\r\nirbuf = kmem_zalloc_greedy(&irbsize, PAGE_SIZE, PAGE_SIZE * 4);\r\nif (!irbuf)\r\nreturn ENOMEM;\r\nnirbuf = irbsize / sizeof(*irbuf);\r\nrval = 0;\r\nwhile (XFS_BULKSTAT_UBLEFT(ubleft) && agno < mp->m_sb.sb_agcount) {\r\ncond_resched();\r\nbp = NULL;\r\nerror = xfs_ialloc_read_agi(mp, NULL, agno, &agbp);\r\nif (error) {\r\nagno++;\r\nagino = 0;\r\ncontinue;\r\n}\r\nagi = XFS_BUF_TO_AGI(agbp);\r\ncur = xfs_inobt_init_cursor(mp, NULL, agbp, agno);\r\nirbp = irbuf;\r\nirbufend = irbuf + nirbuf;\r\nend_of_ag = 0;\r\nif (agino > 0) {\r\nxfs_inobt_rec_incore_t r;\r\nerror = xfs_inobt_lookup(cur, agino, XFS_LOOKUP_LE,\r\n&tmp);\r\nif (!error &&\r\ntmp &&\r\n!(error = xfs_inobt_get_rec(cur, &r, &i)) &&\r\ni == 1 &&\r\nagino < r.ir_startino + XFS_INODES_PER_CHUNK &&\r\n(chunkidx = agino - r.ir_startino + 1) <\r\nXFS_INODES_PER_CHUNK &&\r\nxfs_inobt_maskn(chunkidx,\r\nXFS_INODES_PER_CHUNK - chunkidx) &\r\n~r.ir_free) {\r\nfor (i = 0; i < chunkidx; i++) {\r\nif (XFS_INOBT_MASK(i) & ~r.ir_free)\r\nr.ir_freecount++;\r\n}\r\nr.ir_free |= xfs_inobt_maskn(0, chunkidx);\r\nirbp->ir_startino = r.ir_startino;\r\nirbp->ir_freecount = r.ir_freecount;\r\nirbp->ir_free = r.ir_free;\r\nirbp++;\r\nagino = r.ir_startino + XFS_INODES_PER_CHUNK;\r\nicount = XFS_INODES_PER_CHUNK - r.ir_freecount;\r\n} else {\r\nagino++;\r\nicount = 0;\r\n}\r\nif (!error)\r\nerror = xfs_btree_increment(cur, 0, &tmp);\r\n} else {\r\nerror = xfs_inobt_lookup(cur, 0, XFS_LOOKUP_GE, &tmp);\r\nicount = 0;\r\n}\r\nwhile (irbp < irbufend && icount < ubcount) {\r\nxfs_inobt_rec_incore_t r;\r\nwhile (error) {\r\nagino += XFS_INODES_PER_CHUNK;\r\nif (XFS_AGINO_TO_AGBNO(mp, agino) >=\r\nbe32_to_cpu(agi->agi_length))\r\nbreak;\r\nerror = xfs_inobt_lookup(cur, agino,\r\nXFS_LOOKUP_GE, &tmp);\r\ncond_resched();\r\n}\r\nif (error) {\r\nend_of_ag = 1;\r\nbreak;\r\n}\r\nerror = xfs_inobt_get_rec(cur, &r, &i);\r\nif (error || i == 0) {\r\nend_of_ag = 1;\r\nbreak;\r\n}\r\nif (r.ir_freecount < XFS_INODES_PER_CHUNK) {\r\nagbno = XFS_AGINO_TO_AGBNO(mp, r.ir_startino);\r\nfor (chunkidx = 0;\r\nchunkidx < XFS_INODES_PER_CHUNK;\r\nchunkidx += nicluster,\r\nagbno += nbcluster) {\r\nif (xfs_inobt_maskn(chunkidx, nicluster)\r\n& ~r.ir_free)\r\nxfs_btree_reada_bufs(mp, agno,\r\nagbno, nbcluster);\r\n}\r\nirbp->ir_startino = r.ir_startino;\r\nirbp->ir_freecount = r.ir_freecount;\r\nirbp->ir_free = r.ir_free;\r\nirbp++;\r\nicount += XFS_INODES_PER_CHUNK - r.ir_freecount;\r\n}\r\nagino = r.ir_startino + XFS_INODES_PER_CHUNK;\r\nerror = xfs_btree_increment(cur, 0, &tmp);\r\ncond_resched();\r\n}\r\nxfs_btree_del_cursor(cur, XFS_BTREE_NOERROR);\r\nxfs_buf_relse(agbp);\r\nirbufend = irbp;\r\nfor (irbp = irbuf;\r\nirbp < irbufend && XFS_BULKSTAT_UBLEFT(ubleft); irbp++) {\r\nfor (agino = irbp->ir_startino, chunkidx = clustidx = 0;\r\nXFS_BULKSTAT_UBLEFT(ubleft) &&\r\nirbp->ir_freecount < XFS_INODES_PER_CHUNK;\r\nchunkidx++, clustidx++, agino++) {\r\nASSERT(chunkidx < XFS_INODES_PER_CHUNK);\r\nif ((chunkidx & (nicluster - 1)) == 0) {\r\nagbno = XFS_AGINO_TO_AGBNO(mp,\r\nirbp->ir_startino) +\r\n((chunkidx & nimask) >>\r\nmp->m_sb.sb_inopblog);\r\n}\r\nino = XFS_AGINO_TO_INO(mp, agno, agino);\r\nif (XFS_INOBT_MASK(chunkidx) & irbp->ir_free) {\r\nlastino = ino;\r\ncontinue;\r\n}\r\nirbp->ir_freecount++;\r\nubused = statstruct_size;\r\nerror = formatter(mp, ino, ubufp, ubleft,\r\n&ubused, &fmterror);\r\nif (fmterror == BULKSTAT_RV_NOTHING) {\r\nif (error && error != ENOENT &&\r\nerror != EINVAL) {\r\nubleft = 0;\r\nrval = error;\r\nbreak;\r\n}\r\nlastino = ino;\r\ncontinue;\r\n}\r\nif (fmterror == BULKSTAT_RV_GIVEUP) {\r\nubleft = 0;\r\nASSERT(error);\r\nrval = error;\r\nbreak;\r\n}\r\nif (ubufp)\r\nubufp += ubused;\r\nubleft -= ubused;\r\nubelem++;\r\nlastino = ino;\r\n}\r\ncond_resched();\r\n}\r\nif (bp)\r\nxfs_buf_relse(bp);\r\nif (XFS_BULKSTAT_UBLEFT(ubleft)) {\r\nif (end_of_ag) {\r\nagno++;\r\nagino = 0;\r\n} else\r\nagino = XFS_INO_TO_AGINO(mp, lastino);\r\n} else\r\nbreak;\r\n}\r\nkmem_free_large(irbuf);\r\n*ubcountp = ubelem;\r\nif (ubelem)\r\nrval = 0;\r\nif (agno >= mp->m_sb.sb_agcount) {\r\n*lastinop = (xfs_ino_t)XFS_AGINO_TO_INO(mp, agno, 0);\r\n*done = 1;\r\n} else\r\n*lastinop = (xfs_ino_t)lastino;\r\nreturn rval;\r\n}\r\nint\r\nxfs_bulkstat_single(\r\nxfs_mount_t *mp,\r\nxfs_ino_t *lastinop,\r\nchar __user *buffer,\r\nint *done)\r\n{\r\nint count;\r\nint error;\r\nxfs_ino_t ino;\r\nint res;\r\nino = (xfs_ino_t)*lastinop;\r\nerror = xfs_bulkstat_one(mp, ino, buffer, sizeof(xfs_bstat_t), 0, &res);\r\nif (error) {\r\n(*lastinop)--;\r\ncount = 1;\r\nif (xfs_bulkstat(mp, lastinop, &count, xfs_bulkstat_one,\r\nsizeof(xfs_bstat_t), buffer, done))\r\nreturn error;\r\nif (count == 0 || (xfs_ino_t)*lastinop != ino)\r\nreturn error == EFSCORRUPTED ?\r\nXFS_ERROR(EINVAL) : error;\r\nelse\r\nreturn 0;\r\n}\r\n*done = 0;\r\nreturn 0;\r\n}\r\nint\r\nxfs_inumbers_fmt(\r\nvoid __user *ubuffer,\r\nconst xfs_inogrp_t *buffer,\r\nlong count,\r\nlong *written)\r\n{\r\nif (copy_to_user(ubuffer, buffer, count * sizeof(*buffer)))\r\nreturn -EFAULT;\r\n*written = count * sizeof(*buffer);\r\nreturn 0;\r\n}\r\nint\r\nxfs_inumbers(\r\nxfs_mount_t *mp,\r\nxfs_ino_t *lastino,\r\nint *count,\r\nvoid __user *ubuffer,\r\ninumbers_fmt_pf formatter)\r\n{\r\nxfs_buf_t *agbp;\r\nxfs_agino_t agino;\r\nxfs_agnumber_t agno;\r\nint bcount;\r\nxfs_inogrp_t *buffer;\r\nint bufidx;\r\nxfs_btree_cur_t *cur;\r\nint error;\r\nxfs_inobt_rec_incore_t r;\r\nint i;\r\nxfs_ino_t ino;\r\nint left;\r\nint tmp;\r\nino = (xfs_ino_t)*lastino;\r\nagno = XFS_INO_TO_AGNO(mp, ino);\r\nagino = XFS_INO_TO_AGINO(mp, ino);\r\nleft = *count;\r\n*count = 0;\r\nbcount = MIN(left, (int)(PAGE_SIZE / sizeof(*buffer)));\r\nbuffer = kmem_alloc(bcount * sizeof(*buffer), KM_SLEEP);\r\nerror = bufidx = 0;\r\ncur = NULL;\r\nagbp = NULL;\r\nwhile (left > 0 && agno < mp->m_sb.sb_agcount) {\r\nif (agbp == NULL) {\r\nerror = xfs_ialloc_read_agi(mp, NULL, agno, &agbp);\r\nif (error) {\r\nASSERT(cur == NULL);\r\nagbp = NULL;\r\nagno++;\r\nagino = 0;\r\ncontinue;\r\n}\r\ncur = xfs_inobt_init_cursor(mp, NULL, agbp, agno);\r\nerror = xfs_inobt_lookup(cur, agino, XFS_LOOKUP_GE,\r\n&tmp);\r\nif (error) {\r\nxfs_btree_del_cursor(cur, XFS_BTREE_ERROR);\r\ncur = NULL;\r\nxfs_buf_relse(agbp);\r\nagbp = NULL;\r\nagino += XFS_INODES_PER_CHUNK - 1;\r\ncontinue;\r\n}\r\n}\r\nerror = xfs_inobt_get_rec(cur, &r, &i);\r\nif (error || i == 0) {\r\nxfs_buf_relse(agbp);\r\nagbp = NULL;\r\nxfs_btree_del_cursor(cur, XFS_BTREE_NOERROR);\r\ncur = NULL;\r\nagno++;\r\nagino = 0;\r\ncontinue;\r\n}\r\nagino = r.ir_startino + XFS_INODES_PER_CHUNK - 1;\r\nbuffer[bufidx].xi_startino =\r\nXFS_AGINO_TO_INO(mp, agno, r.ir_startino);\r\nbuffer[bufidx].xi_alloccount =\r\nXFS_INODES_PER_CHUNK - r.ir_freecount;\r\nbuffer[bufidx].xi_allocmask = ~r.ir_free;\r\nbufidx++;\r\nleft--;\r\nif (bufidx == bcount) {\r\nlong written;\r\nif (formatter(ubuffer, buffer, bufidx, &written)) {\r\nerror = XFS_ERROR(EFAULT);\r\nbreak;\r\n}\r\nubuffer += written;\r\n*count += bufidx;\r\nbufidx = 0;\r\n}\r\nif (left) {\r\nerror = xfs_btree_increment(cur, 0, &tmp);\r\nif (error) {\r\nxfs_btree_del_cursor(cur, XFS_BTREE_ERROR);\r\ncur = NULL;\r\nxfs_buf_relse(agbp);\r\nagbp = NULL;\r\nagino += XFS_INODES_PER_CHUNK;\r\ncontinue;\r\n}\r\n}\r\n}\r\nif (!error) {\r\nif (bufidx) {\r\nlong written;\r\nif (formatter(ubuffer, buffer, bufidx, &written))\r\nerror = XFS_ERROR(EFAULT);\r\nelse\r\n*count += bufidx;\r\n}\r\n*lastino = XFS_AGINO_TO_INO(mp, agno, agino);\r\n}\r\nkmem_free(buffer);\r\nif (cur)\r\nxfs_btree_del_cursor(cur, (error ? XFS_BTREE_ERROR :\r\nXFS_BTREE_NOERROR));\r\nif (agbp)\r\nxfs_buf_relse(agbp);\r\nreturn error;\r\n}

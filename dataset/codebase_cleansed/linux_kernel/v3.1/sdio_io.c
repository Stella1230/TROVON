void sdio_claim_host(struct sdio_func *func)\r\n{\r\nBUG_ON(!func);\r\nBUG_ON(!func->card);\r\nmmc_claim_host(func->card->host);\r\n}\r\nvoid sdio_release_host(struct sdio_func *func)\r\n{\r\nBUG_ON(!func);\r\nBUG_ON(!func->card);\r\nmmc_release_host(func->card->host);\r\n}\r\nint sdio_enable_func(struct sdio_func *func)\r\n{\r\nint ret;\r\nunsigned char reg;\r\nunsigned long timeout;\r\nBUG_ON(!func);\r\nBUG_ON(!func->card);\r\npr_debug("SDIO: Enabling device %s...\n", sdio_func_id(func));\r\nret = mmc_io_rw_direct(func->card, 0, 0, SDIO_CCCR_IOEx, 0, &reg);\r\nif (ret)\r\ngoto err;\r\nreg |= 1 << func->num;\r\nret = mmc_io_rw_direct(func->card, 1, 0, SDIO_CCCR_IOEx, reg, NULL);\r\nif (ret)\r\ngoto err;\r\ntimeout = jiffies + msecs_to_jiffies(func->enable_timeout);\r\nwhile (1) {\r\nret = mmc_io_rw_direct(func->card, 0, 0, SDIO_CCCR_IORx, 0, &reg);\r\nif (ret)\r\ngoto err;\r\nif (reg & (1 << func->num))\r\nbreak;\r\nret = -ETIME;\r\nif (time_after(jiffies, timeout))\r\ngoto err;\r\n}\r\npr_debug("SDIO: Enabled device %s\n", sdio_func_id(func));\r\nreturn 0;\r\nerr:\r\npr_debug("SDIO: Failed to enable device %s\n", sdio_func_id(func));\r\nreturn ret;\r\n}\r\nint sdio_disable_func(struct sdio_func *func)\r\n{\r\nint ret;\r\nunsigned char reg;\r\nBUG_ON(!func);\r\nBUG_ON(!func->card);\r\npr_debug("SDIO: Disabling device %s...\n", sdio_func_id(func));\r\nret = mmc_io_rw_direct(func->card, 0, 0, SDIO_CCCR_IOEx, 0, &reg);\r\nif (ret)\r\ngoto err;\r\nreg &= ~(1 << func->num);\r\nret = mmc_io_rw_direct(func->card, 1, 0, SDIO_CCCR_IOEx, reg, NULL);\r\nif (ret)\r\ngoto err;\r\npr_debug("SDIO: Disabled device %s\n", sdio_func_id(func));\r\nreturn 0;\r\nerr:\r\npr_debug("SDIO: Failed to disable device %s\n", sdio_func_id(func));\r\nreturn -EIO;\r\n}\r\nint sdio_set_block_size(struct sdio_func *func, unsigned blksz)\r\n{\r\nint ret;\r\nif (blksz > func->card->host->max_blk_size)\r\nreturn -EINVAL;\r\nif (blksz == 0) {\r\nblksz = min(func->max_blksize, func->card->host->max_blk_size);\r\nblksz = min(blksz, 512u);\r\n}\r\nret = mmc_io_rw_direct(func->card, 1, 0,\r\nSDIO_FBR_BASE(func->num) + SDIO_FBR_BLKSIZE,\r\nblksz & 0xff, NULL);\r\nif (ret)\r\nreturn ret;\r\nret = mmc_io_rw_direct(func->card, 1, 0,\r\nSDIO_FBR_BASE(func->num) + SDIO_FBR_BLKSIZE + 1,\r\n(blksz >> 8) & 0xff, NULL);\r\nif (ret)\r\nreturn ret;\r\nfunc->cur_blksize = blksz;\r\nreturn 0;\r\n}\r\nstatic inline unsigned int sdio_max_byte_size(struct sdio_func *func)\r\n{\r\nunsigned mval = min(func->card->host->max_seg_size,\r\nfunc->card->host->max_blk_size);\r\nif (mmc_blksz_for_byte_mode(func->card))\r\nmval = min(mval, func->cur_blksize);\r\nelse\r\nmval = min(mval, func->max_blksize);\r\nreturn min(mval, 512u);\r\n}\r\nunsigned int sdio_align_size(struct sdio_func *func, unsigned int sz)\r\n{\r\nunsigned int orig_sz;\r\nunsigned int blk_sz, byte_sz;\r\nunsigned chunk_sz;\r\norig_sz = sz;\r\nsz = mmc_align_data_size(func->card, sz);\r\nif (sz <= sdio_max_byte_size(func))\r\nreturn sz;\r\nif (func->card->cccr.multi_block) {\r\nif ((sz % func->cur_blksize) == 0)\r\nreturn sz;\r\nblk_sz = ((sz + func->cur_blksize - 1) /\r\nfunc->cur_blksize) * func->cur_blksize;\r\nblk_sz = mmc_align_data_size(func->card, blk_sz);\r\nif ((blk_sz % func->cur_blksize) == 0)\r\nreturn blk_sz;\r\nbyte_sz = mmc_align_data_size(func->card,\r\nsz % func->cur_blksize);\r\nif (byte_sz <= sdio_max_byte_size(func)) {\r\nblk_sz = sz / func->cur_blksize;\r\nreturn blk_sz * func->cur_blksize + byte_sz;\r\n}\r\n} else {\r\nchunk_sz = mmc_align_data_size(func->card,\r\nsdio_max_byte_size(func));\r\nif (chunk_sz == sdio_max_byte_size(func)) {\r\nbyte_sz = orig_sz % chunk_sz;\r\nif (byte_sz) {\r\nbyte_sz = mmc_align_data_size(func->card,\r\nbyte_sz);\r\n}\r\nreturn (orig_sz / chunk_sz) * chunk_sz + byte_sz;\r\n}\r\n}\r\nreturn orig_sz;\r\n}\r\nstatic int sdio_io_rw_ext_helper(struct sdio_func *func, int write,\r\nunsigned addr, int incr_addr, u8 *buf, unsigned size)\r\n{\r\nunsigned remainder = size;\r\nunsigned max_blocks;\r\nint ret;\r\nif (func->card->cccr.multi_block && (size > sdio_max_byte_size(func))) {\r\nmax_blocks = min(func->card->host->max_blk_count,\r\nfunc->card->host->max_seg_size / func->cur_blksize);\r\nmax_blocks = min(max_blocks, 511u);\r\nwhile (remainder > func->cur_blksize) {\r\nunsigned blocks;\r\nblocks = remainder / func->cur_blksize;\r\nif (blocks > max_blocks)\r\nblocks = max_blocks;\r\nsize = blocks * func->cur_blksize;\r\nret = mmc_io_rw_extended(func->card, write,\r\nfunc->num, addr, incr_addr, buf,\r\nblocks, func->cur_blksize);\r\nif (ret)\r\nreturn ret;\r\nremainder -= size;\r\nbuf += size;\r\nif (incr_addr)\r\naddr += size;\r\n}\r\n}\r\nwhile (remainder > 0) {\r\nsize = min(remainder, sdio_max_byte_size(func));\r\nret = mmc_io_rw_extended(func->card, write, func->num, addr,\r\nincr_addr, buf, 1, size);\r\nif (ret)\r\nreturn ret;\r\nremainder -= size;\r\nbuf += size;\r\nif (incr_addr)\r\naddr += size;\r\n}\r\nreturn 0;\r\n}\r\nu8 sdio_readb(struct sdio_func *func, unsigned int addr, int *err_ret)\r\n{\r\nint ret;\r\nu8 val;\r\nBUG_ON(!func);\r\nif (err_ret)\r\n*err_ret = 0;\r\nret = mmc_io_rw_direct(func->card, 0, func->num, addr, 0, &val);\r\nif (ret) {\r\nif (err_ret)\r\n*err_ret = ret;\r\nreturn 0xFF;\r\n}\r\nreturn val;\r\n}\r\nvoid sdio_writeb(struct sdio_func *func, u8 b, unsigned int addr, int *err_ret)\r\n{\r\nint ret;\r\nBUG_ON(!func);\r\nret = mmc_io_rw_direct(func->card, 1, func->num, addr, b, NULL);\r\nif (err_ret)\r\n*err_ret = ret;\r\n}\r\nu8 sdio_writeb_readb(struct sdio_func *func, u8 write_byte,\r\nunsigned int addr, int *err_ret)\r\n{\r\nint ret;\r\nu8 val;\r\nret = mmc_io_rw_direct(func->card, 1, func->num, addr,\r\nwrite_byte, &val);\r\nif (err_ret)\r\n*err_ret = ret;\r\nif (ret)\r\nval = 0xff;\r\nreturn val;\r\n}\r\nint sdio_memcpy_fromio(struct sdio_func *func, void *dst,\r\nunsigned int addr, int count)\r\n{\r\nreturn sdio_io_rw_ext_helper(func, 0, addr, 1, dst, count);\r\n}\r\nint sdio_memcpy_toio(struct sdio_func *func, unsigned int addr,\r\nvoid *src, int count)\r\n{\r\nreturn sdio_io_rw_ext_helper(func, 1, addr, 1, src, count);\r\n}\r\nint sdio_readsb(struct sdio_func *func, void *dst, unsigned int addr,\r\nint count)\r\n{\r\nreturn sdio_io_rw_ext_helper(func, 0, addr, 0, dst, count);\r\n}\r\nint sdio_writesb(struct sdio_func *func, unsigned int addr, void *src,\r\nint count)\r\n{\r\nreturn sdio_io_rw_ext_helper(func, 1, addr, 0, src, count);\r\n}\r\nu16 sdio_readw(struct sdio_func *func, unsigned int addr, int *err_ret)\r\n{\r\nint ret;\r\nif (err_ret)\r\n*err_ret = 0;\r\nret = sdio_memcpy_fromio(func, func->tmpbuf, addr, 2);\r\nif (ret) {\r\nif (err_ret)\r\n*err_ret = ret;\r\nreturn 0xFFFF;\r\n}\r\nreturn le16_to_cpup((__le16 *)func->tmpbuf);\r\n}\r\nvoid sdio_writew(struct sdio_func *func, u16 b, unsigned int addr, int *err_ret)\r\n{\r\nint ret;\r\n*(__le16 *)func->tmpbuf = cpu_to_le16(b);\r\nret = sdio_memcpy_toio(func, addr, func->tmpbuf, 2);\r\nif (err_ret)\r\n*err_ret = ret;\r\n}\r\nu32 sdio_readl(struct sdio_func *func, unsigned int addr, int *err_ret)\r\n{\r\nint ret;\r\nif (err_ret)\r\n*err_ret = 0;\r\nret = sdio_memcpy_fromio(func, func->tmpbuf, addr, 4);\r\nif (ret) {\r\nif (err_ret)\r\n*err_ret = ret;\r\nreturn 0xFFFFFFFF;\r\n}\r\nreturn le32_to_cpup((__le32 *)func->tmpbuf);\r\n}\r\nvoid sdio_writel(struct sdio_func *func, u32 b, unsigned int addr, int *err_ret)\r\n{\r\nint ret;\r\n*(__le32 *)func->tmpbuf = cpu_to_le32(b);\r\nret = sdio_memcpy_toio(func, addr, func->tmpbuf, 4);\r\nif (err_ret)\r\n*err_ret = ret;\r\n}\r\nunsigned char sdio_f0_readb(struct sdio_func *func, unsigned int addr,\r\nint *err_ret)\r\n{\r\nint ret;\r\nunsigned char val;\r\nBUG_ON(!func);\r\nif (err_ret)\r\n*err_ret = 0;\r\nret = mmc_io_rw_direct(func->card, 0, 0, addr, 0, &val);\r\nif (ret) {\r\nif (err_ret)\r\n*err_ret = ret;\r\nreturn 0xFF;\r\n}\r\nreturn val;\r\n}\r\nvoid sdio_f0_writeb(struct sdio_func *func, unsigned char b, unsigned int addr,\r\nint *err_ret)\r\n{\r\nint ret;\r\nBUG_ON(!func);\r\nif ((addr < 0xF0 || addr > 0xFF) && (!mmc_card_lenient_fn0(func->card))) {\r\nif (err_ret)\r\n*err_ret = -EINVAL;\r\nreturn;\r\n}\r\nret = mmc_io_rw_direct(func->card, 1, 0, addr, b, NULL);\r\nif (err_ret)\r\n*err_ret = ret;\r\n}\r\nmmc_pm_flag_t sdio_get_host_pm_caps(struct sdio_func *func)\r\n{\r\nBUG_ON(!func);\r\nBUG_ON(!func->card);\r\nreturn func->card->host->pm_caps;\r\n}\r\nint sdio_set_host_pm_flags(struct sdio_func *func, mmc_pm_flag_t flags)\r\n{\r\nstruct mmc_host *host;\r\nBUG_ON(!func);\r\nBUG_ON(!func->card);\r\nhost = func->card->host;\r\nif (flags & ~host->pm_caps)\r\nreturn -EINVAL;\r\nhost->pm_flags |= flags;\r\nreturn 0;\r\n}

static void ct_atc_pcm_interrupt(struct ct_atc_pcm *atc_pcm)\r\n{\r\nstruct ct_atc_pcm *apcm = atc_pcm;\r\nif (!apcm->substream)\r\nreturn;\r\nsnd_pcm_period_elapsed(apcm->substream);\r\n}\r\nstatic void ct_atc_pcm_free_substream(struct snd_pcm_runtime *runtime)\r\n{\r\nstruct ct_atc_pcm *apcm = runtime->private_data;\r\nstruct ct_atc *atc = snd_pcm_substream_chip(apcm->substream);\r\natc->pcm_release_resources(atc, apcm);\r\nct_timer_instance_free(apcm->timer);\r\nkfree(apcm);\r\nruntime->private_data = NULL;\r\n}\r\nstatic int ct_pcm_playback_open(struct snd_pcm_substream *substream)\r\n{\r\nstruct ct_atc *atc = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct ct_atc_pcm *apcm;\r\nint err;\r\napcm = kzalloc(sizeof(*apcm), GFP_KERNEL);\r\nif (!apcm)\r\nreturn -ENOMEM;\r\napcm->substream = substream;\r\napcm->interrupt = ct_atc_pcm_interrupt;\r\nif (IEC958 == substream->pcm->device) {\r\nruntime->hw = ct_spdif_passthru_playback_hw;\r\natc->spdif_out_passthru(atc, 1);\r\n} else {\r\nruntime->hw = ct_pcm_playback_hw;\r\nif (FRONT == substream->pcm->device)\r\nruntime->hw.channels_max = 8;\r\n}\r\nerr = snd_pcm_hw_constraint_integer(runtime,\r\nSNDRV_PCM_HW_PARAM_PERIODS);\r\nif (err < 0) {\r\nkfree(apcm);\r\nreturn err;\r\n}\r\nerr = snd_pcm_hw_constraint_minmax(runtime,\r\nSNDRV_PCM_HW_PARAM_BUFFER_BYTES,\r\n1024, UINT_MAX);\r\nif (err < 0) {\r\nkfree(apcm);\r\nreturn err;\r\n}\r\napcm->timer = ct_timer_instance_new(atc->timer, apcm);\r\nif (!apcm->timer) {\r\nkfree(apcm);\r\nreturn -ENOMEM;\r\n}\r\nruntime->private_data = apcm;\r\nruntime->private_free = ct_atc_pcm_free_substream;\r\nreturn 0;\r\n}\r\nstatic int ct_pcm_playback_close(struct snd_pcm_substream *substream)\r\n{\r\nstruct ct_atc *atc = snd_pcm_substream_chip(substream);\r\nif (IEC958 == substream->pcm->device)\r\natc->spdif_out_passthru(atc, 0);\r\nreturn 0;\r\n}\r\nstatic int ct_pcm_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *hw_params)\r\n{\r\nstruct ct_atc *atc = snd_pcm_substream_chip(substream);\r\nstruct ct_atc_pcm *apcm = substream->runtime->private_data;\r\nint err;\r\nerr = snd_pcm_lib_malloc_pages(substream,\r\nparams_buffer_bytes(hw_params));\r\nif (err < 0)\r\nreturn err;\r\natc->pcm_release_resources(atc, apcm);\r\nreturn err;\r\n}\r\nstatic int ct_pcm_hw_free(struct snd_pcm_substream *substream)\r\n{\r\nstruct ct_atc *atc = snd_pcm_substream_chip(substream);\r\nstruct ct_atc_pcm *apcm = substream->runtime->private_data;\r\natc->pcm_release_resources(atc, apcm);\r\nreturn snd_pcm_lib_free_pages(substream);\r\n}\r\nstatic int ct_pcm_playback_prepare(struct snd_pcm_substream *substream)\r\n{\r\nint err;\r\nstruct ct_atc *atc = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct ct_atc_pcm *apcm = runtime->private_data;\r\nif (IEC958 == substream->pcm->device)\r\nerr = atc->spdif_passthru_playback_prepare(atc, apcm);\r\nelse\r\nerr = atc->pcm_playback_prepare(atc, apcm);\r\nif (err < 0) {\r\nprintk(KERN_ERR "ctxfi: Preparing pcm playback failed!!!\n");\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nct_pcm_playback_trigger(struct snd_pcm_substream *substream, int cmd)\r\n{\r\nstruct ct_atc *atc = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct ct_atc_pcm *apcm = runtime->private_data;\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\r\natc->pcm_playback_start(atc, apcm);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\r\natc->pcm_playback_stop(atc, apcm);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic snd_pcm_uframes_t\r\nct_pcm_playback_pointer(struct snd_pcm_substream *substream)\r\n{\r\nunsigned long position;\r\nstruct ct_atc *atc = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct ct_atc_pcm *apcm = runtime->private_data;\r\nposition = atc->pcm_playback_position(atc, apcm);\r\nposition = bytes_to_frames(runtime, position);\r\nif (position >= runtime->buffer_size)\r\nposition = 0;\r\nreturn position;\r\n}\r\nstatic int ct_pcm_capture_open(struct snd_pcm_substream *substream)\r\n{\r\nstruct ct_atc *atc = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct ct_atc_pcm *apcm;\r\nint err;\r\napcm = kzalloc(sizeof(*apcm), GFP_KERNEL);\r\nif (!apcm)\r\nreturn -ENOMEM;\r\napcm->started = 0;\r\napcm->substream = substream;\r\napcm->interrupt = ct_atc_pcm_interrupt;\r\nruntime->hw = ct_pcm_capture_hw;\r\nruntime->hw.rate_max = atc->rsr * atc->msr;\r\nerr = snd_pcm_hw_constraint_integer(runtime,\r\nSNDRV_PCM_HW_PARAM_PERIODS);\r\nif (err < 0) {\r\nkfree(apcm);\r\nreturn err;\r\n}\r\nerr = snd_pcm_hw_constraint_minmax(runtime,\r\nSNDRV_PCM_HW_PARAM_BUFFER_BYTES,\r\n1024, UINT_MAX);\r\nif (err < 0) {\r\nkfree(apcm);\r\nreturn err;\r\n}\r\napcm->timer = ct_timer_instance_new(atc->timer, apcm);\r\nif (!apcm->timer) {\r\nkfree(apcm);\r\nreturn -ENOMEM;\r\n}\r\nruntime->private_data = apcm;\r\nruntime->private_free = ct_atc_pcm_free_substream;\r\nreturn 0;\r\n}\r\nstatic int ct_pcm_capture_close(struct snd_pcm_substream *substream)\r\n{\r\nreturn 0;\r\n}\r\nstatic int ct_pcm_capture_prepare(struct snd_pcm_substream *substream)\r\n{\r\nint err;\r\nstruct ct_atc *atc = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct ct_atc_pcm *apcm = runtime->private_data;\r\nerr = atc->pcm_capture_prepare(atc, apcm);\r\nif (err < 0) {\r\nprintk(KERN_ERR "ctxfi: Preparing pcm capture failed!!!\n");\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nct_pcm_capture_trigger(struct snd_pcm_substream *substream, int cmd)\r\n{\r\nstruct ct_atc *atc = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct ct_atc_pcm *apcm = runtime->private_data;\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\natc->pcm_capture_start(atc, apcm);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\natc->pcm_capture_stop(atc, apcm);\r\nbreak;\r\ndefault:\r\natc->pcm_capture_stop(atc, apcm);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic snd_pcm_uframes_t\r\nct_pcm_capture_pointer(struct snd_pcm_substream *substream)\r\n{\r\nunsigned long position;\r\nstruct ct_atc *atc = snd_pcm_substream_chip(substream);\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nstruct ct_atc_pcm *apcm = runtime->private_data;\r\nposition = atc->pcm_capture_position(atc, apcm);\r\nposition = bytes_to_frames(runtime, position);\r\nif (position >= runtime->buffer_size)\r\nposition = 0;\r\nreturn position;\r\n}\r\nint ct_alsa_pcm_create(struct ct_atc *atc,\r\nenum CTALSADEVS device,\r\nconst char *device_name)\r\n{\r\nstruct snd_pcm *pcm;\r\nint err;\r\nint playback_count, capture_count;\r\nplayback_count = (IEC958 == device) ? 1 : 8;\r\ncapture_count = (FRONT == device) ? 1 : 0;\r\nerr = snd_pcm_new(atc->card, "ctxfi", device,\r\nplayback_count, capture_count, &pcm);\r\nif (err < 0) {\r\nprintk(KERN_ERR "ctxfi: snd_pcm_new failed!! Err=%d\n", err);\r\nreturn err;\r\n}\r\npcm->private_data = atc;\r\npcm->info_flags = 0;\r\npcm->dev_subclass = SNDRV_PCM_SUBCLASS_GENERIC_MIX;\r\nstrlcpy(pcm->name, device_name, sizeof(pcm->name));\r\nsnd_pcm_set_ops(pcm, SNDRV_PCM_STREAM_PLAYBACK, &ct_pcm_playback_ops);\r\nif (FRONT == device)\r\nsnd_pcm_set_ops(pcm,\r\nSNDRV_PCM_STREAM_CAPTURE, &ct_pcm_capture_ops);\r\nsnd_pcm_lib_preallocate_pages_for_all(pcm, SNDRV_DMA_TYPE_DEV_SG,\r\nsnd_dma_pci_data(atc->pci), 128*1024, 128*1024);\r\n#ifdef CONFIG_PM\r\natc->pcms[device] = pcm;\r\n#endif\r\nreturn 0;\r\n}

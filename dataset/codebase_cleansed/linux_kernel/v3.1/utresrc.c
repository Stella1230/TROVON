acpi_status\r\nacpi_ut_walk_aml_resources(u8 * aml,\r\nacpi_size aml_length,\r\nacpi_walk_aml_callback user_function, void **context)\r\n{\r\nacpi_status status;\r\nu8 *end_aml;\r\nu8 resource_index;\r\nu32 length;\r\nu32 offset = 0;\r\nACPI_FUNCTION_TRACE(ut_walk_aml_resources);\r\nif (aml_length < sizeof(struct aml_resource_end_tag)) {\r\nreturn_ACPI_STATUS(AE_AML_NO_RESOURCE_END_TAG);\r\n}\r\nend_aml = aml + aml_length;\r\nwhile (aml < end_aml) {\r\nstatus = acpi_ut_validate_resource(aml, &resource_index);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nlength = acpi_ut_get_descriptor_length(aml);\r\nif (user_function) {\r\nstatus =\r\nuser_function(aml, length, offset, resource_index,\r\ncontext);\r\nif (ACPI_FAILURE(status)) {\r\nreturn (status);\r\n}\r\n}\r\nif (acpi_ut_get_resource_type(aml) ==\r\nACPI_RESOURCE_NAME_END_TAG) {\r\nif ((aml + 1) >= end_aml) {\r\nreturn_ACPI_STATUS(AE_AML_NO_RESOURCE_END_TAG);\r\n}\r\nif (!user_function) {\r\n*context = aml;\r\n}\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\naml += length;\r\noffset += length;\r\n}\r\nreturn (AE_AML_NO_RESOURCE_END_TAG);\r\n}\r\nacpi_status acpi_ut_validate_resource(void *aml, u8 * return_index)\r\n{\r\nu8 resource_type;\r\nu8 resource_index;\r\nacpi_rs_length resource_length;\r\nacpi_rs_length minimum_resource_length;\r\nACPI_FUNCTION_ENTRY();\r\nresource_type = ACPI_GET8(aml);\r\nif (resource_type & ACPI_RESOURCE_NAME_LARGE) {\r\nif (resource_type > ACPI_RESOURCE_NAME_LARGE_MAX) {\r\nreturn (AE_AML_INVALID_RESOURCE_TYPE);\r\n}\r\nresource_index = (u8) (resource_type - 0x70);\r\n} else {\r\nresource_index = (u8)\r\n((resource_type & ACPI_RESOURCE_NAME_SMALL_MASK) >> 3);\r\n}\r\nif (!acpi_gbl_resource_types[resource_index]) {\r\nreturn (AE_AML_INVALID_RESOURCE_TYPE);\r\n}\r\nresource_length = acpi_ut_get_resource_length(aml);\r\nminimum_resource_length = acpi_gbl_resource_aml_sizes[resource_index];\r\nswitch (acpi_gbl_resource_types[resource_index]) {\r\ncase ACPI_FIXED_LENGTH:\r\nif (resource_length != minimum_resource_length) {\r\nreturn (AE_AML_BAD_RESOURCE_LENGTH);\r\n}\r\nbreak;\r\ncase ACPI_VARIABLE_LENGTH:\r\nif (resource_length < minimum_resource_length) {\r\nreturn (AE_AML_BAD_RESOURCE_LENGTH);\r\n}\r\nbreak;\r\ncase ACPI_SMALL_VARIABLE_LENGTH:\r\nif ((resource_length > minimum_resource_length) ||\r\n(resource_length < (minimum_resource_length - 1))) {\r\nreturn (AE_AML_BAD_RESOURCE_LENGTH);\r\n}\r\nbreak;\r\ndefault:\r\nreturn (AE_AML_INVALID_RESOURCE_TYPE);\r\n}\r\nif (return_index) {\r\n*return_index = resource_index;\r\n}\r\nreturn (AE_OK);\r\n}\r\nu8 acpi_ut_get_resource_type(void *aml)\r\n{\r\nACPI_FUNCTION_ENTRY();\r\nif (ACPI_GET8(aml) & ACPI_RESOURCE_NAME_LARGE) {\r\nreturn (ACPI_GET8(aml));\r\n} else {\r\nreturn ((u8) (ACPI_GET8(aml) & ACPI_RESOURCE_NAME_SMALL_MASK));\r\n}\r\n}\r\nu16 acpi_ut_get_resource_length(void *aml)\r\n{\r\nacpi_rs_length resource_length;\r\nACPI_FUNCTION_ENTRY();\r\nif (ACPI_GET8(aml) & ACPI_RESOURCE_NAME_LARGE) {\r\nACPI_MOVE_16_TO_16(&resource_length, ACPI_ADD_PTR(u8, aml, 1));\r\n} else {\r\nresource_length = (u16) (ACPI_GET8(aml) &\r\nACPI_RESOURCE_NAME_SMALL_LENGTH_MASK);\r\n}\r\nreturn (resource_length);\r\n}\r\nu8 acpi_ut_get_resource_header_length(void *aml)\r\n{\r\nACPI_FUNCTION_ENTRY();\r\nif (ACPI_GET8(aml) & ACPI_RESOURCE_NAME_LARGE) {\r\nreturn (sizeof(struct aml_resource_large_header));\r\n} else {\r\nreturn (sizeof(struct aml_resource_small_header));\r\n}\r\n}\r\nu32 acpi_ut_get_descriptor_length(void *aml)\r\n{\r\nACPI_FUNCTION_ENTRY();\r\nreturn (acpi_ut_get_resource_length(aml) +\r\nacpi_ut_get_resource_header_length(aml));\r\n}\r\nacpi_status\r\nacpi_ut_get_resource_end_tag(union acpi_operand_object * obj_desc,\r\nu8 ** end_tag)\r\n{\r\nacpi_status status;\r\nACPI_FUNCTION_TRACE(ut_get_resource_end_tag);\r\nif (!obj_desc->buffer.length) {\r\n*end_tag = obj_desc->buffer.pointer;\r\nreturn_ACPI_STATUS(AE_OK);\r\n}\r\nstatus = acpi_ut_walk_aml_resources(obj_desc->buffer.pointer,\r\nobj_desc->buffer.length, NULL,\r\n(void **)end_tag);\r\nreturn_ACPI_STATUS(status);\r\n}

struct ev7_lf_subpackets *\r\nev7_collect_logout_frame_subpackets(struct el_subpacket *el_ptr,\r\nstruct ev7_lf_subpackets *lf_subpackets)\r\n{\r\nstruct el_subpacket *subpacket;\r\nint i;\r\nif (el_ptr->class != EL_CLASS__HEADER ||\r\nel_ptr->type != EL_TYPE__HEADER__LOGOUT_FRAME)\r\nreturn NULL;\r\nel_ptr = (struct el_subpacket *)\r\n((unsigned long)el_ptr + el_ptr->length);\r\nif (el_ptr->class != EL_CLASS__PAL ||\r\nel_ptr->type != EL_TYPE__PAL__LOGOUT_FRAME)\r\nreturn NULL;\r\nlf_subpackets->logout = (struct ev7_pal_logout_subpacket *)\r\nel_ptr->by_type.raw.data_start;\r\nsubpacket = (struct el_subpacket *)\r\n((unsigned long)el_ptr + el_ptr->length);\r\nfor (i = 0;\r\nsubpacket && i < lf_subpackets->logout->subpacket_count;\r\nsubpacket = (struct el_subpacket *)\r\n((unsigned long)subpacket + subpacket->length), i++) {\r\nif (subpacket->class != EL_CLASS__PAL) {\r\nprintk("%s**UNEXPECTED SUBPACKET CLASS %d "\r\n"IN LOGOUT FRAME (packet %d\n",\r\nerr_print_prefix, subpacket->class, i);\r\nreturn NULL;\r\n}\r\nswitch(subpacket->type) {\r\ncase EL_TYPE__PAL__EV7_PROCESSOR:\r\nlf_subpackets->ev7 =\r\n(struct ev7_pal_processor_subpacket *)\r\nsubpacket->by_type.raw.data_start;\r\nbreak;\r\ncase EL_TYPE__PAL__EV7_RBOX:\r\nlf_subpackets->rbox = (struct ev7_pal_rbox_subpacket *)\r\nsubpacket->by_type.raw.data_start;\r\nbreak;\r\ncase EL_TYPE__PAL__EV7_ZBOX:\r\nlf_subpackets->zbox = (struct ev7_pal_zbox_subpacket *)\r\nsubpacket->by_type.raw.data_start;\r\nbreak;\r\ncase EL_TYPE__PAL__EV7_IO:\r\nlf_subpackets->io = (struct ev7_pal_io_subpacket *)\r\nsubpacket->by_type.raw.data_start;\r\nbreak;\r\ncase EL_TYPE__PAL__ENV__AMBIENT_TEMPERATURE:\r\ncase EL_TYPE__PAL__ENV__AIRMOVER_FAN:\r\ncase EL_TYPE__PAL__ENV__VOLTAGE:\r\ncase EL_TYPE__PAL__ENV__INTRUSION:\r\ncase EL_TYPE__PAL__ENV__POWER_SUPPLY:\r\ncase EL_TYPE__PAL__ENV__LAN:\r\ncase EL_TYPE__PAL__ENV__HOT_PLUG:\r\nlf_subpackets->env[ev7_lf_env_index(subpacket->type)] =\r\n(struct ev7_pal_environmental_subpacket *)\r\nsubpacket->by_type.raw.data_start;\r\nbreak;\r\ndefault:\r\nreturn NULL;\r\n}\r\n}\r\nreturn lf_subpackets;\r\n}\r\nvoid\r\nev7_machine_check(unsigned long vector, unsigned long la_ptr)\r\n{\r\nstruct el_subpacket *el_ptr = (struct el_subpacket *)la_ptr;\r\nchar *saved_err_prefix = err_print_prefix;\r\nmb();\r\ndraina();\r\nerr_print_prefix = KERN_CRIT;\r\nprintk("%s*CPU %s Error (Vector 0x%x) reported on CPU %d\n",\r\nerr_print_prefix,\r\n(vector == SCB_Q_PROCERR) ? "Correctable" : "Uncorrectable",\r\n(unsigned int)vector, (int)smp_processor_id());\r\nel_process_subpacket(el_ptr);\r\nerr_print_prefix = saved_err_prefix;\r\nwrmces(0x7);\r\nmb();\r\n}\r\nstatic struct el_subpacket *\r\nev7_process_pal_subpacket(struct el_subpacket *header)\r\n{\r\nstruct ev7_pal_subpacket *packet;\r\nif (header->class != EL_CLASS__PAL) {\r\nprintk("%s ** Unexpected header CLASS %d TYPE %d, aborting\n",\r\nerr_print_prefix,\r\nheader->class, header->type);\r\nreturn NULL;\r\n}\r\npacket = (struct ev7_pal_subpacket *)header->by_type.raw.data_start;\r\nswitch(header->type) {\r\ncase EL_TYPE__PAL__LOGOUT_FRAME:\r\nprintk("%s*** MCHK occurred on LPID %lld (RBOX %llx)\n",\r\nerr_print_prefix,\r\npacket->by_type.logout.whami,\r\npacket->by_type.logout.rbox_whami);\r\nel_print_timestamp(&packet->by_type.logout.timestamp);\r\nprintk("%s EXC_ADDR: %016llx\n"\r\n" HALT_CODE: %llx\n",\r\nerr_print_prefix,\r\npacket->by_type.logout.exc_addr,\r\npacket->by_type.logout.halt_code);\r\nel_process_subpackets(header,\r\npacket->by_type.logout.subpacket_count);\r\nbreak;\r\ndefault:\r\nprintk("%s ** PAL TYPE %d SUBPACKET\n",\r\nerr_print_prefix,\r\nheader->type);\r\nel_annotate_subpacket(header);\r\nbreak;\r\n}\r\nreturn (struct el_subpacket *)((unsigned long)header + header->length);\r\n}\r\nvoid __init\r\nev7_register_error_handlers(void)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(el_ev7_pal_annotations); i++)\r\ncdl_register_subpacket_annotation(&el_ev7_pal_annotations[i]);\r\ncdl_register_subpacket_handler(&ev7_pal_subpacket_handler);\r\n}

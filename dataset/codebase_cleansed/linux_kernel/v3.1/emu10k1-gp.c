static int __devinit emu_probe(struct pci_dev *pdev, const struct pci_device_id *ent)\r\n{\r\nstruct emu *emu;\r\nstruct gameport *port;\r\nint error;\r\nemu = kzalloc(sizeof(struct emu), GFP_KERNEL);\r\nport = gameport_allocate_port();\r\nif (!emu || !port) {\r\nprintk(KERN_ERR "emu10k1-gp: Memory allocation failed\n");\r\nerror = -ENOMEM;\r\ngoto err_out_free;\r\n}\r\nerror = pci_enable_device(pdev);\r\nif (error)\r\ngoto err_out_free;\r\nemu->io = pci_resource_start(pdev, 0);\r\nemu->size = pci_resource_len(pdev, 0);\r\nemu->dev = pdev;\r\nemu->gameport = port;\r\ngameport_set_name(port, "EMU10K1");\r\ngameport_set_phys(port, "pci%s/gameport0", pci_name(pdev));\r\nport->dev.parent = &pdev->dev;\r\nport->io = emu->io;\r\nif (!request_region(emu->io, emu->size, "emu10k1-gp")) {\r\nprintk(KERN_ERR "emu10k1-gp: unable to grab region 0x%x-0x%x\n",\r\nemu->io, emu->io + emu->size - 1);\r\nerror = -EBUSY;\r\ngoto err_out_disable_dev;\r\n}\r\npci_set_drvdata(pdev, emu);\r\ngameport_register_port(port);\r\nreturn 0;\r\nerr_out_disable_dev:\r\npci_disable_device(pdev);\r\nerr_out_free:\r\ngameport_free_port(port);\r\nkfree(emu);\r\nreturn error;\r\n}\r\nstatic void __devexit emu_remove(struct pci_dev *pdev)\r\n{\r\nstruct emu *emu = pci_get_drvdata(pdev);\r\ngameport_unregister_port(emu->gameport);\r\nrelease_region(emu->io, emu->size);\r\nkfree(emu);\r\npci_disable_device(pdev);\r\n}\r\nstatic int __init emu_init(void)\r\n{\r\nreturn pci_register_driver(&emu_driver);\r\n}\r\nstatic void __exit emu_exit(void)\r\n{\r\npci_unregister_driver(&emu_driver);\r\n}

static int pager_command_config(const char *var, const char *value, void *data)\r\n{\r\nstruct pager_config *c = data;\r\nif (!prefixcmp(var, "pager.") && !strcmp(var + 6, c->cmd))\r\nc->val = perf_config_bool(var, value);\r\nreturn 0;\r\n}\r\nint check_pager_config(const char *cmd)\r\n{\r\nstruct pager_config c;\r\nc.cmd = cmd;\r\nc.val = -1;\r\nperf_config(pager_command_config, &c);\r\nreturn c.val;\r\n}\r\nstatic int tui_command_config(const char *var, const char *value, void *data)\r\n{\r\nstruct pager_config *c = data;\r\nif (!prefixcmp(var, "tui.") && !strcmp(var + 4, c->cmd))\r\nc->val = perf_config_bool(var, value);\r\nreturn 0;\r\n}\r\nstatic int check_tui_config(const char *cmd)\r\n{\r\nstruct pager_config c;\r\nc.cmd = cmd;\r\nc.val = -1;\r\nperf_config(tui_command_config, &c);\r\nreturn c.val;\r\n}\r\nstatic void commit_pager_choice(void)\r\n{\r\nswitch (use_pager) {\r\ncase 0:\r\nsetenv("PERF_PAGER", "cat", 1);\r\nbreak;\r\ncase 1:\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic void set_debugfs_path(void)\r\n{\r\nchar *path;\r\npath = getenv(PERF_DEBUGFS_ENVIRONMENT);\r\nsnprintf(debugfs_path, MAXPATHLEN, "%s/%s", path ?: debugfs_mntpt,\r\n"tracing/events");\r\n}\r\nstatic int handle_options(const char ***argv, int *argc, int *envchanged)\r\n{\r\nint handled = 0;\r\nwhile (*argc > 0) {\r\nconst char *cmd = (*argv)[0];\r\nif (cmd[0] != '-')\r\nbreak;\r\nif (!strcmp(cmd, "--help") || !strcmp(cmd, "--version"))\r\nbreak;\r\nif (!prefixcmp(cmd, CMD_EXEC_PATH)) {\r\ncmd += strlen(CMD_EXEC_PATH);\r\nif (*cmd == '=')\r\nperf_set_argv_exec_path(cmd + 1);\r\nelse {\r\nputs(perf_exec_path());\r\nexit(0);\r\n}\r\n} else if (!strcmp(cmd, "--html-path")) {\r\nputs(system_path(PERF_HTML_PATH));\r\nexit(0);\r\n} else if (!strcmp(cmd, "-p") || !strcmp(cmd, "--paginate")) {\r\nuse_pager = 1;\r\n} else if (!strcmp(cmd, "--no-pager")) {\r\nuse_pager = 0;\r\nif (envchanged)\r\n*envchanged = 1;\r\n} else if (!strcmp(cmd, "--perf-dir")) {\r\nif (*argc < 2) {\r\nfprintf(stderr, "No directory given for --perf-dir.\n");\r\nusage(perf_usage_string);\r\n}\r\nsetenv(PERF_DIR_ENVIRONMENT, (*argv)[1], 1);\r\nif (envchanged)\r\n*envchanged = 1;\r\n(*argv)++;\r\n(*argc)--;\r\nhandled++;\r\n} else if (!prefixcmp(cmd, CMD_PERF_DIR)) {\r\nsetenv(PERF_DIR_ENVIRONMENT, cmd + strlen(CMD_PERF_DIR), 1);\r\nif (envchanged)\r\n*envchanged = 1;\r\n} else if (!strcmp(cmd, "--work-tree")) {\r\nif (*argc < 2) {\r\nfprintf(stderr, "No directory given for --work-tree.\n");\r\nusage(perf_usage_string);\r\n}\r\nsetenv(PERF_WORK_TREE_ENVIRONMENT, (*argv)[1], 1);\r\nif (envchanged)\r\n*envchanged = 1;\r\n(*argv)++;\r\n(*argc)--;\r\n} else if (!prefixcmp(cmd, CMD_WORK_TREE)) {\r\nsetenv(PERF_WORK_TREE_ENVIRONMENT, cmd + strlen(CMD_WORK_TREE), 1);\r\nif (envchanged)\r\n*envchanged = 1;\r\n} else if (!strcmp(cmd, "--debugfs-dir")) {\r\nif (*argc < 2) {\r\nfprintf(stderr, "No directory given for --debugfs-dir.\n");\r\nusage(perf_usage_string);\r\n}\r\nstrncpy(debugfs_mntpt, (*argv)[1], MAXPATHLEN);\r\ndebugfs_mntpt[MAXPATHLEN - 1] = '\0';\r\nif (envchanged)\r\n*envchanged = 1;\r\n(*argv)++;\r\n(*argc)--;\r\n} else if (!prefixcmp(cmd, CMD_DEBUGFS_DIR)) {\r\nstrncpy(debugfs_mntpt, cmd + strlen(CMD_DEBUGFS_DIR), MAXPATHLEN);\r\ndebugfs_mntpt[MAXPATHLEN - 1] = '\0';\r\nif (envchanged)\r\n*envchanged = 1;\r\n} else {\r\nfprintf(stderr, "Unknown option: %s\n", cmd);\r\nusage(perf_usage_string);\r\n}\r\n(*argv)++;\r\n(*argc)--;\r\nhandled++;\r\n}\r\nreturn handled;\r\n}\r\nstatic int handle_alias(int *argcp, const char ***argv)\r\n{\r\nint envchanged = 0, ret = 0, saved_errno = errno;\r\nint count, option_count;\r\nconst char **new_argv;\r\nconst char *alias_command;\r\nchar *alias_string;\r\nalias_command = (*argv)[0];\r\nalias_string = alias_lookup(alias_command);\r\nif (alias_string) {\r\nif (alias_string[0] == '!') {\r\nif (*argcp > 1) {\r\nstruct strbuf buf;\r\nstrbuf_init(&buf, PATH_MAX);\r\nstrbuf_addstr(&buf, alias_string);\r\nsq_quote_argv(&buf, (*argv) + 1, PATH_MAX);\r\nfree(alias_string);\r\nalias_string = buf.buf;\r\n}\r\nret = system(alias_string + 1);\r\nif (ret >= 0 && WIFEXITED(ret) &&\r\nWEXITSTATUS(ret) != 127)\r\nexit(WEXITSTATUS(ret));\r\ndie("Failed to run '%s' when expanding alias '%s'",\r\nalias_string + 1, alias_command);\r\n}\r\ncount = split_cmdline(alias_string, &new_argv);\r\nif (count < 0)\r\ndie("Bad alias.%s string", alias_command);\r\noption_count = handle_options(&new_argv, &count, &envchanged);\r\nif (envchanged)\r\ndie("alias '%s' changes environment variables\n"\r\n"You can use '!perf' in the alias to do this.",\r\nalias_command);\r\nmemmove(new_argv - option_count, new_argv,\r\ncount * sizeof(char *));\r\nnew_argv -= option_count;\r\nif (count < 1)\r\ndie("empty alias for %s", alias_command);\r\nif (!strcmp(alias_command, new_argv[0]))\r\ndie("recursive alias: %s", alias_command);\r\nnew_argv = realloc(new_argv, sizeof(char *) *\r\n(count + *argcp + 1));\r\nmemcpy(new_argv + count, *argv + 1, sizeof(char *) * *argcp);\r\nnew_argv[count + *argcp] = NULL;\r\n*argv = new_argv;\r\n*argcp += count - 1;\r\nret = 1;\r\n}\r\nerrno = saved_errno;\r\nreturn ret;\r\n}\r\nstatic int run_builtin(struct cmd_struct *p, int argc, const char **argv)\r\n{\r\nint status;\r\nstruct stat st;\r\nconst char *prefix;\r\nprefix = NULL;\r\nif (p->option & RUN_SETUP)\r\nprefix = NULL;\r\nif (use_browser == -1)\r\nuse_browser = check_tui_config(p->cmd);\r\nif (use_pager == -1 && p->option & RUN_SETUP)\r\nuse_pager = check_pager_config(p->cmd);\r\nif (use_pager == -1 && p->option & USE_PAGER)\r\nuse_pager = 1;\r\ncommit_pager_choice();\r\nset_debugfs_path();\r\nstatus = p->fn(argc, argv, prefix);\r\nexit_browser(status);\r\nif (status)\r\nreturn status & 0xff;\r\nif (fstat(fileno(stdout), &st))\r\nreturn 0;\r\nif (S_ISFIFO(st.st_mode) || S_ISSOCK(st.st_mode))\r\nreturn 0;\r\nif (fflush(stdout))\r\ndie("write failure on standard output: %s", strerror(errno));\r\nif (ferror(stdout))\r\ndie("unknown write failure on standard output");\r\nif (fclose(stdout))\r\ndie("close failed on standard output: %s", strerror(errno));\r\nreturn 0;\r\n}\r\nstatic void handle_internal_command(int argc, const char **argv)\r\n{\r\nconst char *cmd = argv[0];\r\nstatic struct cmd_struct commands[] = {\r\n{ "buildid-cache", cmd_buildid_cache, 0 },\r\n{ "buildid-list", cmd_buildid_list, 0 },\r\n{ "diff", cmd_diff, 0 },\r\n{ "evlist", cmd_evlist, 0 },\r\n{ "help", cmd_help, 0 },\r\n{ "list", cmd_list, 0 },\r\n{ "record", cmd_record, 0 },\r\n{ "report", cmd_report, 0 },\r\n{ "bench", cmd_bench, 0 },\r\n{ "stat", cmd_stat, 0 },\r\n{ "timechart", cmd_timechart, 0 },\r\n{ "top", cmd_top, 0 },\r\n{ "annotate", cmd_annotate, 0 },\r\n{ "version", cmd_version, 0 },\r\n{ "script", cmd_script, 0 },\r\n{ "sched", cmd_sched, 0 },\r\n{ "probe", cmd_probe, 0 },\r\n{ "kmem", cmd_kmem, 0 },\r\n{ "lock", cmd_lock, 0 },\r\n{ "kvm", cmd_kvm, 0 },\r\n{ "test", cmd_test, 0 },\r\n{ "inject", cmd_inject, 0 },\r\n};\r\nunsigned int i;\r\nstatic const char ext[] = STRIP_EXTENSION;\r\nif (sizeof(ext) > 1) {\r\ni = strlen(argv[0]) - strlen(ext);\r\nif (i > 0 && !strcmp(argv[0] + i, ext)) {\r\nchar *argv0 = strdup(argv[0]);\r\nargv[0] = cmd = argv0;\r\nargv0[i] = '\0';\r\n}\r\n}\r\nif (argc > 1 && !strcmp(argv[1], "--help")) {\r\nargv[1] = argv[0];\r\nargv[0] = cmd = "help";\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(commands); i++) {\r\nstruct cmd_struct *p = commands+i;\r\nif (strcmp(p->cmd, cmd))\r\ncontinue;\r\nexit(run_builtin(p, argc, argv));\r\n}\r\n}\r\nstatic void execv_dashed_external(const char **argv)\r\n{\r\nstruct strbuf cmd = STRBUF_INIT;\r\nconst char *tmp;\r\nint status;\r\nstrbuf_addf(&cmd, "perf-%s", argv[0]);\r\ntmp = argv[0];\r\nargv[0] = cmd.buf;\r\nstatus = run_command_v_opt(argv, 0);\r\nif (status != -ERR_RUN_COMMAND_EXEC) {\r\nif (IS_RUN_COMMAND_ERR(status))\r\ndie("unable to run '%s'", argv[0]);\r\nexit(-status);\r\n}\r\nerrno = ENOENT;\r\nargv[0] = tmp;\r\nstrbuf_release(&cmd);\r\n}\r\nstatic int run_argv(int *argcp, const char ***argv)\r\n{\r\nint done_alias = 0;\r\nwhile (1) {\r\nhandle_internal_command(*argcp, *argv);\r\nexecv_dashed_external(*argv);\r\nif (done_alias || !handle_alias(argcp, argv))\r\nbreak;\r\ndone_alias = 1;\r\n}\r\nreturn done_alias;\r\n}\r\nstatic void get_debugfs_mntpt(void)\r\n{\r\nconst char *path = debugfs_mount(NULL);\r\nif (path)\r\nstrncpy(debugfs_mntpt, path, sizeof(debugfs_mntpt));\r\nelse\r\ndebugfs_mntpt[0] = '\0';\r\n}\r\nint main(int argc, const char **argv)\r\n{\r\nconst char *cmd;\r\ncmd = perf_extract_argv0_path(argv[0]);\r\nif (!cmd)\r\ncmd = "perf-help";\r\nget_debugfs_mntpt();\r\nif (!prefixcmp(cmd, "perf-")) {\r\ncmd += 5;\r\nargv[0] = cmd;\r\nhandle_internal_command(argc, argv);\r\ndie("cannot handle %s internally", cmd);\r\n}\r\nargv++;\r\nargc--;\r\nhandle_options(&argv, &argc, NULL);\r\ncommit_pager_choice();\r\nset_debugfs_path();\r\nset_buildid_dir();\r\nif (argc > 0) {\r\nif (!prefixcmp(argv[0], "--"))\r\nargv[0] += 2;\r\n} else {\r\nprintf("\n usage: %s\n\n", perf_usage_string);\r\nlist_common_cmds_help();\r\nprintf("\n %s\n\n", perf_more_info_string);\r\nexit(1);\r\n}\r\ncmd = argv[0];\r\nsetup_path();\r\nwhile (1) {\r\nstatic int done_help;\r\nstatic int was_alias;\r\nwas_alias = run_argv(&argc, &argv);\r\nif (errno != ENOENT)\r\nbreak;\r\nif (was_alias) {\r\nfprintf(stderr, "Expansion of alias '%s' failed; "\r\n"'%s' is not a perf-command\n",\r\ncmd, argv[0]);\r\nexit(1);\r\n}\r\nif (!done_help) {\r\ncmd = argv[0] = help_unknown_cmd(cmd);\r\ndone_help = 1;\r\n} else\r\nbreak;\r\n}\r\nfprintf(stderr, "Failed to run command '%s': %s\n",\r\ncmd, strerror(errno));\r\nreturn 1;\r\n}

static unsigned long clk_sspll_recalc(struct clk *clk)\r\n{\r\nint pll;\r\nunsigned long mult = 0, prediv = 1, postdiv = 1;\r\nunsigned long ref = OSC_FREQ_ONCHIP, ret;\r\nu32 tmp;\r\nif (WARN_ON(!clk->pll_data))\r\nreturn clk->rate;\r\nif (!clk_ctrl_regs) {\r\nvoid __iomem *tmp;\r\ntmp = ioremap(TNETV107X_CLOCK_CONTROL_BASE, SZ_4K);\r\nif (WARN(!tmp, "failed ioremap for clock control regs\n"))\r\nreturn clk->parent ? clk->parent->rate : 0;\r\nfor (pll = 0; pll < N_PLLS; pll++)\r\nsspll_regs[pll] = tmp + sspll_regs_base[pll];\r\nclk_ctrl_regs = tmp;\r\n}\r\npll = clk->pll_data->num;\r\ntmp = __raw_readl(&clk_ctrl_regs->pll_bypass);\r\nif (!(tmp & bypass_mask[pll])) {\r\nmult = __raw_readl(&sspll_regs[pll]->mult_factor);\r\nprediv = __raw_readl(&sspll_regs[pll]->pre_div) + 1;\r\npostdiv = __raw_readl(&sspll_regs[pll]->post_div) + 1;\r\n}\r\ntmp = __raw_readl(clk->pll_data->base + PLLCTL);\r\nif (tmp & PLLCTL_CLKMODE)\r\nref = pll_ext_freq[pll];\r\nclk->pll_data->input_rate = ref;\r\ntmp = __raw_readl(clk->pll_data->base + PLLCTL);\r\nif (!(tmp & PLLCTL_PLLEN))\r\nreturn ref;\r\nret = ref;\r\nif (mult)\r\nret += ((unsigned long long)ref * mult) / 256;\r\nret /= (prediv * postdiv);\r\nreturn ret;\r\n}\r\nstatic void tnetv107x_watchdog_reset(struct platform_device *pdev)\r\n{\r\nstruct wdt_regs __iomem *regs;\r\nregs = ioremap(pdev->resource[0].start, SZ_4K);\r\n__raw_writel(0x7777, &regs->disable_lock);\r\n__raw_writel(0xcccc, &regs->disable_lock);\r\n__raw_writel(0xdddd, &regs->disable_lock);\r\n__raw_writel(0, &regs->disable);\r\n__raw_writel(0x5a5a, &regs->prescale_lock);\r\n__raw_writel(0xa5a5, &regs->prescale_lock);\r\n__raw_writel(0, &regs->prescale);\r\n__raw_writel(0x6666, &regs->change_lock);\r\n__raw_writel(0xbbbb, &regs->change_lock);\r\n__raw_writel(1, &regs->change);\r\n__raw_writel(0x7777, &regs->disable_lock);\r\n__raw_writel(0xcccc, &regs->disable_lock);\r\n__raw_writel(0xdddd, &regs->disable_lock);\r\n__raw_writel(1, &regs->disable);\r\n__raw_writel(0x5555, &regs->kick_lock);\r\n__raw_writel(0xaaaa, &regs->kick_lock);\r\n__raw_writel(1, &regs->kick);\r\n}\r\nvoid __init tnetv107x_init(void)\r\n{\r\ndavinci_common_init(&tnetv107x_soc_info);\r\n}

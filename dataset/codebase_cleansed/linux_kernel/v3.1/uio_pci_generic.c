static inline struct uio_pci_generic_dev *\r\nto_uio_pci_generic_dev(struct uio_info *info)\r\n{\r\nreturn container_of(info, struct uio_pci_generic_dev, info);\r\n}\r\nstatic irqreturn_t irqhandler(int irq, struct uio_info *info)\r\n{\r\nstruct uio_pci_generic_dev *gdev = to_uio_pci_generic_dev(info);\r\nstruct pci_dev *pdev = gdev->pdev;\r\nirqreturn_t ret = IRQ_NONE;\r\nu32 cmd_status_dword;\r\nu16 origcmd, newcmd, status;\r\nBUILD_BUG_ON(PCI_COMMAND % 4);\r\nBUILD_BUG_ON(PCI_COMMAND + 2 != PCI_STATUS);\r\nspin_lock_irq(&gdev->lock);\r\npci_block_user_cfg_access(pdev);\r\npci_read_config_dword(pdev, PCI_COMMAND, &cmd_status_dword);\r\norigcmd = cmd_status_dword;\r\nstatus = cmd_status_dword >> 16;\r\nif (!(status & PCI_STATUS_INTERRUPT))\r\ngoto done;\r\nnewcmd = origcmd | PCI_COMMAND_INTX_DISABLE;\r\nif (newcmd != origcmd)\r\npci_write_config_word(pdev, PCI_COMMAND, newcmd);\r\nret = IRQ_HANDLED;\r\ndone:\r\npci_unblock_user_cfg_access(pdev);\r\nspin_unlock_irq(&gdev->lock);\r\nreturn ret;\r\n}\r\nstatic int __devinit verify_pci_2_3(struct pci_dev *pdev)\r\n{\r\nu16 orig, new;\r\nint err = 0;\r\npci_block_user_cfg_access(pdev);\r\npci_read_config_word(pdev, PCI_COMMAND, &orig);\r\npci_write_config_word(pdev, PCI_COMMAND,\r\norig ^ PCI_COMMAND_INTX_DISABLE);\r\npci_read_config_word(pdev, PCI_COMMAND, &new);\r\nif ((new ^ orig) & ~PCI_COMMAND_INTX_DISABLE) {\r\nerr = -EBUSY;\r\ndev_err(&pdev->dev, "Command changed from 0x%x to 0x%x: "\r\n"driver or HW bug?\n", orig, new);\r\ngoto err;\r\n}\r\nif (!((new ^ orig) & PCI_COMMAND_INTX_DISABLE)) {\r\ndev_warn(&pdev->dev, "Device does not support "\r\n"disabling interrupts: unable to bind.\n");\r\nerr = -ENODEV;\r\ngoto err;\r\n}\r\npci_write_config_word(pdev, PCI_COMMAND, orig);\r\nerr:\r\npci_unblock_user_cfg_access(pdev);\r\nreturn err;\r\n}\r\nstatic int __devinit probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *id)\r\n{\r\nstruct uio_pci_generic_dev *gdev;\r\nint err;\r\nerr = pci_enable_device(pdev);\r\nif (err) {\r\ndev_err(&pdev->dev, "%s: pci_enable_device failed: %d\n",\r\n__func__, err);\r\nreturn err;\r\n}\r\nif (!pdev->irq) {\r\ndev_warn(&pdev->dev, "No IRQ assigned to device: "\r\n"no support for interrupts?\n");\r\npci_disable_device(pdev);\r\nreturn -ENODEV;\r\n}\r\nerr = verify_pci_2_3(pdev);\r\nif (err)\r\ngoto err_verify;\r\ngdev = kzalloc(sizeof(struct uio_pci_generic_dev), GFP_KERNEL);\r\nif (!gdev) {\r\nerr = -ENOMEM;\r\ngoto err_alloc;\r\n}\r\ngdev->info.name = "uio_pci_generic";\r\ngdev->info.version = DRIVER_VERSION;\r\ngdev->info.irq = pdev->irq;\r\ngdev->info.irq_flags = IRQF_SHARED;\r\ngdev->info.handler = irqhandler;\r\ngdev->pdev = pdev;\r\nspin_lock_init(&gdev->lock);\r\nif (uio_register_device(&pdev->dev, &gdev->info))\r\ngoto err_register;\r\npci_set_drvdata(pdev, gdev);\r\nreturn 0;\r\nerr_register:\r\nkfree(gdev);\r\nerr_alloc:\r\nerr_verify:\r\npci_disable_device(pdev);\r\nreturn err;\r\n}\r\nstatic void remove(struct pci_dev *pdev)\r\n{\r\nstruct uio_pci_generic_dev *gdev = pci_get_drvdata(pdev);\r\nuio_unregister_device(&gdev->info);\r\npci_disable_device(pdev);\r\nkfree(gdev);\r\n}\r\nstatic int __init init(void)\r\n{\r\npr_info(DRIVER_DESC " version: " DRIVER_VERSION "\n");\r\nreturn pci_register_driver(&driver);\r\n}\r\nstatic void __exit cleanup(void)\r\n{\r\npci_unregister_driver(&driver);\r\n}

void mpic_msi_reserve_hwirq(struct mpic *mpic, irq_hw_number_t hwirq)\r\n{\r\nif (!mpic->msi_bitmap.bitmap)\r\nreturn;\r\nmsi_bitmap_reserve_hwirq(&mpic->msi_bitmap, hwirq);\r\n}\r\nstatic int mpic_msi_reserve_u3_hwirqs(struct mpic *mpic)\r\n{\r\nirq_hw_number_t hwirq;\r\nstruct irq_host_ops *ops = mpic->irqhost->ops;\r\nstruct device_node *np;\r\nint flags, index, i;\r\nstruct of_irq oirq;\r\npr_debug("mpic: found U3, guessing msi allocator setup\n");\r\nfor (i = 0; i < 8; i++)\r\nmsi_bitmap_reserve_hwirq(&mpic->msi_bitmap, i);\r\nfor (i = 42; i < 46; i++)\r\nmsi_bitmap_reserve_hwirq(&mpic->msi_bitmap, i);\r\nfor (i = 100; i < 105; i++)\r\nmsi_bitmap_reserve_hwirq(&mpic->msi_bitmap, i);\r\nfor (i = 124; i < mpic->irq_count; i++)\r\nmsi_bitmap_reserve_hwirq(&mpic->msi_bitmap, i);\r\nnp = NULL;\r\nwhile ((np = of_find_all_nodes(np))) {\r\npr_debug("mpic: mapping hwirqs for %s\n", np->full_name);\r\nindex = 0;\r\nwhile (of_irq_map_one(np, index++, &oirq) == 0) {\r\nops->xlate(mpic->irqhost, NULL, oirq.specifier,\r\noirq.size, &hwirq, &flags);\r\nmsi_bitmap_reserve_hwirq(&mpic->msi_bitmap, hwirq);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int mpic_msi_reserve_u3_hwirqs(struct mpic *mpic)\r\n{\r\nreturn -1;\r\n}\r\nint mpic_msi_init_allocator(struct mpic *mpic)\r\n{\r\nint rc;\r\nrc = msi_bitmap_alloc(&mpic->msi_bitmap, mpic->irq_count,\r\nmpic->irqhost->of_node);\r\nif (rc)\r\nreturn rc;\r\nrc = msi_bitmap_reserve_dt_hwirqs(&mpic->msi_bitmap);\r\nif (rc > 0) {\r\nif (mpic->flags & MPIC_U3_HT_IRQS)\r\nrc = mpic_msi_reserve_u3_hwirqs(mpic);\r\nif (rc) {\r\nmsi_bitmap_free(&mpic->msi_bitmap);\r\nreturn rc;\r\n}\r\n}\r\nreturn 0;\r\n}

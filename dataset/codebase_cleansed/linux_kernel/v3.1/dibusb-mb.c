static int dib3000mb_i2c_gate_ctrl(struct dvb_frontend* fe, int enable)\r\n{\r\nstruct dvb_usb_adapter *adap = fe->dvb->priv;\r\nstruct dibusb_state *st = adap->priv;\r\nreturn st->ops.tuner_pass_ctrl(fe, enable, st->tuner_addr);\r\n}\r\nstatic int dibusb_dib3000mb_frontend_attach(struct dvb_usb_adapter *adap)\r\n{\r\nstruct dib3000_config demod_cfg;\r\nstruct dibusb_state *st = adap->priv;\r\ndemod_cfg.demod_address = 0x8;\r\nif ((adap->fe = dvb_attach(dib3000mb_attach, &demod_cfg,\r\n&adap->dev->i2c_adap, &st->ops)) == NULL)\r\nreturn -ENODEV;\r\nadap->fe->ops.i2c_gate_ctrl = dib3000mb_i2c_gate_ctrl;\r\nreturn 0;\r\n}\r\nstatic int dibusb_thomson_tuner_attach(struct dvb_usb_adapter *adap)\r\n{\r\nstruct dibusb_state *st = adap->priv;\r\nst->tuner_addr = 0x61;\r\ndvb_attach(dvb_pll_attach, adap->fe, 0x61, &adap->dev->i2c_adap,\r\nDVB_PLL_TUA6010XS);\r\nreturn 0;\r\n}\r\nstatic int dibusb_panasonic_tuner_attach(struct dvb_usb_adapter *adap)\r\n{\r\nstruct dibusb_state *st = adap->priv;\r\nst->tuner_addr = 0x60;\r\ndvb_attach(dvb_pll_attach, adap->fe, 0x60, &adap->dev->i2c_adap,\r\nDVB_PLL_TDA665X);\r\nreturn 0;\r\n}\r\nstatic int dibusb_tuner_probe_and_attach(struct dvb_usb_adapter *adap)\r\n{\r\nu8 b[2] = { 0,0 }, b2[1];\r\nint ret = 0;\r\nstruct i2c_msg msg[2] = {\r\n{ .flags = 0, .buf = b, .len = 2 },\r\n{ .flags = I2C_M_RD, .buf = b2, .len = 1 },\r\n};\r\nstruct dibusb_state *st = adap->priv;\r\nmsg[0].addr = msg[1].addr = st->tuner_addr = 0x60;\r\nif (adap->fe->ops.i2c_gate_ctrl)\r\nadap->fe->ops.i2c_gate_ctrl(adap->fe,1);\r\nif (i2c_transfer(&adap->dev->i2c_adap, msg, 2) != 2) {\r\nerr("tuner i2c write failed.");\r\nret = -EREMOTEIO;\r\n}\r\nif (adap->fe->ops.i2c_gate_ctrl)\r\nadap->fe->ops.i2c_gate_ctrl(adap->fe,0);\r\nif (b2[0] == 0xfe) {\r\ninfo("This device has the Thomson Cable onboard. Which is default.");\r\nret = dibusb_thomson_tuner_attach(adap);\r\n} else {\r\ninfo("This device has the Panasonic ENV77H11D5 onboard.");\r\nret = dibusb_panasonic_tuner_attach(adap);\r\n}\r\nreturn ret;\r\n}\r\nstatic int dibusb_probe(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nif (0 == dvb_usb_device_init(intf, &dibusb1_1_properties,\r\nTHIS_MODULE, NULL, adapter_nr) ||\r\n0 == dvb_usb_device_init(intf, &dibusb1_1_an2235_properties,\r\nTHIS_MODULE, NULL, adapter_nr) ||\r\n0 == dvb_usb_device_init(intf, &dibusb2_0b_properties,\r\nTHIS_MODULE, NULL, adapter_nr) ||\r\n0 == dvb_usb_device_init(intf, &artec_t1_usb2_properties,\r\nTHIS_MODULE, NULL, adapter_nr))\r\nreturn 0;\r\nreturn -EINVAL;\r\n}\r\nstatic int __init dibusb_module_init(void)\r\n{\r\nint result;\r\nif ((result = usb_register(&dibusb_driver))) {\r\nerr("usb_register failed. Error number %d",result);\r\nreturn result;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit dibusb_module_exit(void)\r\n{\r\nusb_deregister(&dibusb_driver);\r\n}

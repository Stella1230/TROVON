int llc_build_and_send_pkt(struct sock *sk, struct sk_buff *skb)\r\n{\r\nstruct llc_conn_state_ev *ev;\r\nint rc = -ECONNABORTED;\r\nstruct llc_sock *llc = llc_sk(sk);\r\nif (unlikely(llc->state == LLC_CONN_STATE_ADM))\r\ngoto out;\r\nrc = -EBUSY;\r\nif (unlikely(llc_data_accept_state(llc->state) ||\r\nllc->p_flag)) {\r\nllc->failed_data_req = 1;\r\ngoto out;\r\n}\r\nev = llc_conn_ev(skb);\r\nev->type = LLC_CONN_EV_TYPE_PRIM;\r\nev->prim = LLC_DATA_PRIM;\r\nev->prim_type = LLC_PRIM_TYPE_REQ;\r\nskb->dev = llc->dev;\r\nrc = llc_conn_state_process(sk, skb);\r\nout:\r\nreturn rc;\r\n}\r\nint llc_establish_connection(struct sock *sk, u8 *lmac, u8 *dmac, u8 dsap)\r\n{\r\nint rc = -EISCONN;\r\nstruct llc_addr laddr, daddr;\r\nstruct sk_buff *skb;\r\nstruct llc_sock *llc = llc_sk(sk);\r\nstruct sock *existing;\r\nladdr.lsap = llc->sap->laddr.lsap;\r\ndaddr.lsap = dsap;\r\nmemcpy(daddr.mac, dmac, sizeof(daddr.mac));\r\nmemcpy(laddr.mac, lmac, sizeof(laddr.mac));\r\nexisting = llc_lookup_established(llc->sap, &daddr, &laddr);\r\nif (existing) {\r\nif (existing->sk_state == TCP_ESTABLISHED) {\r\nsk = existing;\r\ngoto out_put;\r\n} else\r\nsock_put(existing);\r\n}\r\nsock_hold(sk);\r\nrc = -ENOMEM;\r\nskb = alloc_skb(0, GFP_ATOMIC);\r\nif (skb) {\r\nstruct llc_conn_state_ev *ev = llc_conn_ev(skb);\r\nev->type = LLC_CONN_EV_TYPE_PRIM;\r\nev->prim = LLC_CONN_PRIM;\r\nev->prim_type = LLC_PRIM_TYPE_REQ;\r\nskb_set_owner_w(skb, sk);\r\nrc = llc_conn_state_process(sk, skb);\r\n}\r\nout_put:\r\nsock_put(sk);\r\nreturn rc;\r\n}\r\nint llc_send_disc(struct sock *sk)\r\n{\r\nu16 rc = 1;\r\nstruct llc_conn_state_ev *ev;\r\nstruct sk_buff *skb;\r\nsock_hold(sk);\r\nif (sk->sk_type != SOCK_STREAM || sk->sk_state != TCP_ESTABLISHED ||\r\nllc_sk(sk)->state == LLC_CONN_STATE_ADM ||\r\nllc_sk(sk)->state == LLC_CONN_OUT_OF_SVC)\r\ngoto out;\r\nskb = alloc_skb(0, GFP_ATOMIC);\r\nif (!skb)\r\ngoto out;\r\nskb_set_owner_w(skb, sk);\r\nsk->sk_state = TCP_CLOSING;\r\nev = llc_conn_ev(skb);\r\nev->type = LLC_CONN_EV_TYPE_PRIM;\r\nev->prim = LLC_DISC_PRIM;\r\nev->prim_type = LLC_PRIM_TYPE_REQ;\r\nrc = llc_conn_state_process(sk, skb);\r\nout:\r\nsock_put(sk);\r\nreturn rc;\r\n}

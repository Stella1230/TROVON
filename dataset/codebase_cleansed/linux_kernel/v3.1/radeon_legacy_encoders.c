static void radeon_legacy_encoder_disable(struct drm_encoder *encoder)\r\n{\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct drm_encoder_helper_funcs *encoder_funcs;\r\nencoder_funcs = encoder->helper_private;\r\nencoder_funcs->dpms(encoder, DRM_MODE_DPMS_OFF);\r\nradeon_encoder->active_device = 0;\r\n}\r\nstatic void radeon_legacy_lvds_update(struct drm_encoder *encoder, int mode)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nuint32_t lvds_gen_cntl, lvds_pll_cntl, pixclks_cntl, disp_pwr_man;\r\nint panel_pwr_delay = 2000;\r\nbool is_mac = false;\r\nuint8_t backlight_level;\r\nDRM_DEBUG_KMS("\n");\r\nlvds_gen_cntl = RREG32(RADEON_LVDS_GEN_CNTL);\r\nbacklight_level = (lvds_gen_cntl >> RADEON_LVDS_BL_MOD_LEVEL_SHIFT) & 0xff;\r\nif (radeon_encoder->enc_priv) {\r\nif (rdev->is_atom_bios) {\r\nstruct radeon_encoder_atom_dig *lvds = radeon_encoder->enc_priv;\r\npanel_pwr_delay = lvds->panel_pwr_delay;\r\nif (lvds->bl_dev)\r\nbacklight_level = lvds->backlight_level;\r\n} else {\r\nstruct radeon_encoder_lvds *lvds = radeon_encoder->enc_priv;\r\npanel_pwr_delay = lvds->panel_pwr_delay;\r\nif (lvds->bl_dev)\r\nbacklight_level = lvds->backlight_level;\r\n}\r\n}\r\nif ((rdev->mode_info.connector_table == CT_IBOOK) ||\r\n(rdev->mode_info.connector_table == CT_POWERBOOK_EXTERNAL) ||\r\n(rdev->mode_info.connector_table == CT_POWERBOOK_INTERNAL) ||\r\n(rdev->mode_info.connector_table == CT_POWERBOOK_VGA))\r\nis_mac = true;\r\nswitch (mode) {\r\ncase DRM_MODE_DPMS_ON:\r\ndisp_pwr_man = RREG32(RADEON_DISP_PWR_MAN);\r\ndisp_pwr_man |= RADEON_AUTO_PWRUP_EN;\r\nWREG32(RADEON_DISP_PWR_MAN, disp_pwr_man);\r\nlvds_pll_cntl = RREG32(RADEON_LVDS_PLL_CNTL);\r\nlvds_pll_cntl |= RADEON_LVDS_PLL_EN;\r\nWREG32(RADEON_LVDS_PLL_CNTL, lvds_pll_cntl);\r\nudelay(1000);\r\nlvds_pll_cntl = RREG32(RADEON_LVDS_PLL_CNTL);\r\nlvds_pll_cntl &= ~RADEON_LVDS_PLL_RESET;\r\nWREG32(RADEON_LVDS_PLL_CNTL, lvds_pll_cntl);\r\nlvds_gen_cntl &= ~(RADEON_LVDS_DISPLAY_DIS |\r\nRADEON_LVDS_BL_MOD_LEVEL_MASK);\r\nlvds_gen_cntl |= (RADEON_LVDS_ON | RADEON_LVDS_EN |\r\nRADEON_LVDS_DIGON | RADEON_LVDS_BLON |\r\n(backlight_level << RADEON_LVDS_BL_MOD_LEVEL_SHIFT));\r\nif (is_mac)\r\nlvds_gen_cntl |= RADEON_LVDS_BL_MOD_EN;\r\nudelay(panel_pwr_delay * 1000);\r\nWREG32(RADEON_LVDS_GEN_CNTL, lvds_gen_cntl);\r\nbreak;\r\ncase DRM_MODE_DPMS_STANDBY:\r\ncase DRM_MODE_DPMS_SUSPEND:\r\ncase DRM_MODE_DPMS_OFF:\r\npixclks_cntl = RREG32_PLL(RADEON_PIXCLKS_CNTL);\r\nWREG32_PLL_P(RADEON_PIXCLKS_CNTL, 0, ~RADEON_PIXCLK_LVDS_ALWAYS_ONb);\r\nlvds_gen_cntl |= RADEON_LVDS_DISPLAY_DIS;\r\nif (is_mac) {\r\nlvds_gen_cntl &= ~RADEON_LVDS_BL_MOD_EN;\r\nWREG32(RADEON_LVDS_GEN_CNTL, lvds_gen_cntl);\r\nlvds_gen_cntl &= ~(RADEON_LVDS_ON | RADEON_LVDS_EN);\r\n} else {\r\nWREG32(RADEON_LVDS_GEN_CNTL, lvds_gen_cntl);\r\nlvds_gen_cntl &= ~(RADEON_LVDS_ON | RADEON_LVDS_BLON | RADEON_LVDS_EN | RADEON_LVDS_DIGON);\r\n}\r\nudelay(panel_pwr_delay * 1000);\r\nWREG32(RADEON_LVDS_GEN_CNTL, lvds_gen_cntl);\r\nWREG32_PLL(RADEON_PIXCLKS_CNTL, pixclks_cntl);\r\nudelay(panel_pwr_delay * 1000);\r\nbreak;\r\n}\r\nif (rdev->is_atom_bios)\r\nradeon_atombios_encoder_dpms_scratch_regs(encoder, (mode == DRM_MODE_DPMS_ON) ? true : false);\r\nelse\r\nradeon_combios_encoder_dpms_scratch_regs(encoder, (mode == DRM_MODE_DPMS_ON) ? true : false);\r\n}\r\nstatic void radeon_legacy_lvds_dpms(struct drm_encoder *encoder, int mode)\r\n{\r\nstruct radeon_device *rdev = encoder->dev->dev_private;\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nDRM_DEBUG("\n");\r\nif (radeon_encoder->enc_priv) {\r\nif (rdev->is_atom_bios) {\r\nstruct radeon_encoder_atom_dig *lvds = radeon_encoder->enc_priv;\r\nlvds->dpms_mode = mode;\r\n} else {\r\nstruct radeon_encoder_lvds *lvds = radeon_encoder->enc_priv;\r\nlvds->dpms_mode = mode;\r\n}\r\n}\r\nradeon_legacy_lvds_update(encoder, mode);\r\n}\r\nstatic void radeon_legacy_lvds_prepare(struct drm_encoder *encoder)\r\n{\r\nstruct radeon_device *rdev = encoder->dev->dev_private;\r\nif (rdev->is_atom_bios)\r\nradeon_atom_output_lock(encoder, true);\r\nelse\r\nradeon_combios_output_lock(encoder, true);\r\nradeon_legacy_lvds_dpms(encoder, DRM_MODE_DPMS_OFF);\r\n}\r\nstatic void radeon_legacy_lvds_commit(struct drm_encoder *encoder)\r\n{\r\nstruct radeon_device *rdev = encoder->dev->dev_private;\r\nradeon_legacy_lvds_dpms(encoder, DRM_MODE_DPMS_ON);\r\nif (rdev->is_atom_bios)\r\nradeon_atom_output_lock(encoder, false);\r\nelse\r\nradeon_combios_output_lock(encoder, false);\r\n}\r\nstatic void radeon_legacy_lvds_mode_set(struct drm_encoder *encoder,\r\nstruct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct radeon_crtc *radeon_crtc = to_radeon_crtc(encoder->crtc);\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nuint32_t lvds_pll_cntl, lvds_gen_cntl, lvds_ss_gen_cntl;\r\nDRM_DEBUG_KMS("\n");\r\nlvds_pll_cntl = RREG32(RADEON_LVDS_PLL_CNTL);\r\nlvds_pll_cntl &= ~RADEON_LVDS_PLL_EN;\r\nlvds_ss_gen_cntl = RREG32(RADEON_LVDS_SS_GEN_CNTL);\r\nif (rdev->is_atom_bios) {\r\nradeon_encoder->pixel_clock = adjusted_mode->clock;\r\natombios_digital_setup(encoder, PANEL_ENCODER_ACTION_ENABLE);\r\nlvds_gen_cntl = RREG32(RADEON_LVDS_GEN_CNTL);\r\n} else {\r\nstruct radeon_encoder_lvds *lvds = (struct radeon_encoder_lvds *)radeon_encoder->enc_priv;\r\nif (lvds) {\r\nDRM_DEBUG_KMS("bios LVDS_GEN_CNTL: 0x%x\n", lvds->lvds_gen_cntl);\r\nlvds_gen_cntl = lvds->lvds_gen_cntl;\r\nlvds_ss_gen_cntl &= ~((0xf << RADEON_LVDS_PWRSEQ_DELAY1_SHIFT) |\r\n(0xf << RADEON_LVDS_PWRSEQ_DELAY2_SHIFT));\r\nlvds_ss_gen_cntl |= ((lvds->panel_digon_delay << RADEON_LVDS_PWRSEQ_DELAY1_SHIFT) |\r\n(lvds->panel_blon_delay << RADEON_LVDS_PWRSEQ_DELAY2_SHIFT));\r\n} else\r\nlvds_gen_cntl = RREG32(RADEON_LVDS_GEN_CNTL);\r\n}\r\nlvds_gen_cntl |= RADEON_LVDS_DISPLAY_DIS;\r\nlvds_gen_cntl &= ~(RADEON_LVDS_ON |\r\nRADEON_LVDS_BLON |\r\nRADEON_LVDS_EN |\r\nRADEON_LVDS_RST_FM);\r\nif (ASIC_IS_R300(rdev))\r\nlvds_pll_cntl &= ~(R300_LVDS_SRC_SEL_MASK);\r\nif (radeon_crtc->crtc_id == 0) {\r\nif (ASIC_IS_R300(rdev)) {\r\nif (radeon_encoder->rmx_type != RMX_OFF)\r\nlvds_pll_cntl |= R300_LVDS_SRC_SEL_RMX;\r\n} else\r\nlvds_gen_cntl &= ~RADEON_LVDS_SEL_CRTC2;\r\n} else {\r\nif (ASIC_IS_R300(rdev))\r\nlvds_pll_cntl |= R300_LVDS_SRC_SEL_CRTC2;\r\nelse\r\nlvds_gen_cntl |= RADEON_LVDS_SEL_CRTC2;\r\n}\r\nWREG32(RADEON_LVDS_GEN_CNTL, lvds_gen_cntl);\r\nWREG32(RADEON_LVDS_PLL_CNTL, lvds_pll_cntl);\r\nWREG32(RADEON_LVDS_SS_GEN_CNTL, lvds_ss_gen_cntl);\r\nif (rdev->family == CHIP_RV410)\r\nWREG32(RADEON_CLOCK_CNTL_INDEX, 0);\r\nif (rdev->is_atom_bios)\r\nradeon_atombios_encoder_crtc_scratch_regs(encoder, radeon_crtc->crtc_id);\r\nelse\r\nradeon_combios_encoder_crtc_scratch_regs(encoder, radeon_crtc->crtc_id);\r\n}\r\nstatic bool radeon_legacy_mode_fixup(struct drm_encoder *encoder,\r\nstruct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nradeon_encoder_set_active_device(encoder);\r\ndrm_mode_set_crtcinfo(adjusted_mode, 0);\r\nif (radeon_encoder->active_device & (ATOM_DEVICE_LCD_SUPPORT))\r\nradeon_panel_mode_fixup(encoder, adjusted_mode);\r\nreturn true;\r\n}\r\nstatic uint8_t radeon_legacy_lvds_level(struct backlight_device *bd)\r\n{\r\nstruct radeon_backlight_privdata *pdata = bl_get_data(bd);\r\nuint8_t level;\r\nif (bd->props.brightness < 0)\r\nlevel = 0;\r\nelse if (bd->props.brightness > MAX_RADEON_LEVEL)\r\nlevel = MAX_RADEON_LEVEL;\r\nelse\r\nlevel = bd->props.brightness;\r\nif (pdata->negative)\r\nlevel = MAX_RADEON_LEVEL - level;\r\nreturn level;\r\n}\r\nstatic int radeon_legacy_backlight_update_status(struct backlight_device *bd)\r\n{\r\nstruct radeon_backlight_privdata *pdata = bl_get_data(bd);\r\nstruct radeon_encoder *radeon_encoder = pdata->encoder;\r\nstruct drm_device *dev = radeon_encoder->base.dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nint dpms_mode = DRM_MODE_DPMS_ON;\r\nif (radeon_encoder->enc_priv) {\r\nif (rdev->is_atom_bios) {\r\nstruct radeon_encoder_atom_dig *lvds = radeon_encoder->enc_priv;\r\ndpms_mode = lvds->dpms_mode;\r\nlvds->backlight_level = radeon_legacy_lvds_level(bd);\r\n} else {\r\nstruct radeon_encoder_lvds *lvds = radeon_encoder->enc_priv;\r\ndpms_mode = lvds->dpms_mode;\r\nlvds->backlight_level = radeon_legacy_lvds_level(bd);\r\n}\r\n}\r\nif (bd->props.brightness > 0)\r\nradeon_legacy_lvds_update(&radeon_encoder->base, dpms_mode);\r\nelse\r\nradeon_legacy_lvds_update(&radeon_encoder->base, DRM_MODE_DPMS_OFF);\r\nreturn 0;\r\n}\r\nstatic int radeon_legacy_backlight_get_brightness(struct backlight_device *bd)\r\n{\r\nstruct radeon_backlight_privdata *pdata = bl_get_data(bd);\r\nstruct radeon_encoder *radeon_encoder = pdata->encoder;\r\nstruct drm_device *dev = radeon_encoder->base.dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nuint8_t backlight_level;\r\nbacklight_level = (RREG32(RADEON_LVDS_GEN_CNTL) >>\r\nRADEON_LVDS_BL_MOD_LEVEL_SHIFT) & 0xff;\r\nreturn pdata->negative ? MAX_RADEON_LEVEL - backlight_level : backlight_level;\r\n}\r\nvoid radeon_legacy_backlight_init(struct radeon_encoder *radeon_encoder,\r\nstruct drm_connector *drm_connector)\r\n{\r\nstruct drm_device *dev = radeon_encoder->base.dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct backlight_device *bd;\r\nstruct backlight_properties props;\r\nstruct radeon_backlight_privdata *pdata;\r\nuint8_t backlight_level;\r\nif (!radeon_encoder->enc_priv)\r\nreturn;\r\n#ifdef CONFIG_PMAC_BACKLIGHT\r\nif (!pmac_has_backlight_type("ati") &&\r\n!pmac_has_backlight_type("mnca"))\r\nreturn;\r\n#endif\r\npdata = kmalloc(sizeof(struct radeon_backlight_privdata), GFP_KERNEL);\r\nif (!pdata) {\r\nDRM_ERROR("Memory allocation failed\n");\r\ngoto error;\r\n}\r\nprops.max_brightness = MAX_RADEON_LEVEL;\r\nprops.type = BACKLIGHT_RAW;\r\nbd = backlight_device_register("radeon_bl", &drm_connector->kdev,\r\npdata, &radeon_backlight_ops, &props);\r\nif (IS_ERR(bd)) {\r\nDRM_ERROR("Backlight registration failed\n");\r\ngoto error;\r\n}\r\npdata->encoder = radeon_encoder;\r\nbacklight_level = (RREG32(RADEON_LVDS_GEN_CNTL) >>\r\nRADEON_LVDS_BL_MOD_LEVEL_SHIFT) & 0xff;\r\nif (backlight_level == 0)\r\npdata->negative = true;\r\nelse if (backlight_level == 0xff)\r\npdata->negative = false;\r\nelse {\r\npdata->negative = (rdev->family != CHIP_RV200 &&\r\nrdev->family != CHIP_RV250 &&\r\nrdev->family != CHIP_RV280 &&\r\nrdev->family != CHIP_RV350);\r\n#ifdef CONFIG_PMAC_BACKLIGHT\r\npdata->negative = (pdata->negative ||\r\nof_machine_is_compatible("PowerBook4,3") ||\r\nof_machine_is_compatible("PowerBook6,3") ||\r\nof_machine_is_compatible("PowerBook6,5"));\r\n#endif\r\n}\r\nif (rdev->is_atom_bios) {\r\nstruct radeon_encoder_atom_dig *lvds = radeon_encoder->enc_priv;\r\nlvds->bl_dev = bd;\r\n} else {\r\nstruct radeon_encoder_lvds *lvds = radeon_encoder->enc_priv;\r\nlvds->bl_dev = bd;\r\n}\r\nbd->props.brightness = radeon_legacy_backlight_get_brightness(bd);\r\nbd->props.power = FB_BLANK_UNBLANK;\r\nbacklight_update_status(bd);\r\nDRM_INFO("radeon legacy LVDS backlight initialized\n");\r\nreturn;\r\nerror:\r\nkfree(pdata);\r\nreturn;\r\n}\r\nstatic void radeon_legacy_backlight_exit(struct radeon_encoder *radeon_encoder)\r\n{\r\nstruct drm_device *dev = radeon_encoder->base.dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct backlight_device *bd = NULL;\r\nif (!radeon_encoder->enc_priv)\r\nreturn;\r\nif (rdev->is_atom_bios) {\r\nstruct radeon_encoder_atom_dig *lvds = radeon_encoder->enc_priv;\r\nbd = lvds->bl_dev;\r\nlvds->bl_dev = NULL;\r\n} else {\r\nstruct radeon_encoder_lvds *lvds = radeon_encoder->enc_priv;\r\nbd = lvds->bl_dev;\r\nlvds->bl_dev = NULL;\r\n}\r\nif (bd) {\r\nstruct radeon_legacy_backlight_privdata *pdata;\r\npdata = bl_get_data(bd);\r\nbacklight_device_unregister(bd);\r\nkfree(pdata);\r\nDRM_INFO("radeon legacy LVDS backlight unloaded\n");\r\n}\r\n}\r\nvoid radeon_legacy_backlight_init(struct radeon_encoder *encoder)\r\n{\r\n}\r\nstatic void radeon_legacy_backlight_exit(struct radeon_encoder *encoder)\r\n{\r\n}\r\nstatic void radeon_lvds_enc_destroy(struct drm_encoder *encoder)\r\n{\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nif (radeon_encoder->enc_priv) {\r\nradeon_legacy_backlight_exit(radeon_encoder);\r\nkfree(radeon_encoder->enc_priv);\r\n}\r\ndrm_encoder_cleanup(encoder);\r\nkfree(radeon_encoder);\r\n}\r\nstatic void radeon_legacy_primary_dac_dpms(struct drm_encoder *encoder, int mode)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nuint32_t crtc_ext_cntl = RREG32(RADEON_CRTC_EXT_CNTL);\r\nuint32_t dac_cntl = RREG32(RADEON_DAC_CNTL);\r\nuint32_t dac_macro_cntl = RREG32(RADEON_DAC_MACRO_CNTL);\r\nDRM_DEBUG_KMS("\n");\r\nswitch (mode) {\r\ncase DRM_MODE_DPMS_ON:\r\ncrtc_ext_cntl |= RADEON_CRTC_CRT_ON;\r\ndac_cntl &= ~RADEON_DAC_PDWN;\r\ndac_macro_cntl &= ~(RADEON_DAC_PDWN_R |\r\nRADEON_DAC_PDWN_G |\r\nRADEON_DAC_PDWN_B);\r\nbreak;\r\ncase DRM_MODE_DPMS_STANDBY:\r\ncase DRM_MODE_DPMS_SUSPEND:\r\ncase DRM_MODE_DPMS_OFF:\r\ncrtc_ext_cntl &= ~RADEON_CRTC_CRT_ON;\r\ndac_cntl |= RADEON_DAC_PDWN;\r\ndac_macro_cntl |= (RADEON_DAC_PDWN_R |\r\nRADEON_DAC_PDWN_G |\r\nRADEON_DAC_PDWN_B);\r\nbreak;\r\n}\r\nWREG32(RADEON_CRTC_EXT_CNTL, crtc_ext_cntl);\r\nWREG32(RADEON_DAC_CNTL, dac_cntl);\r\nWREG32(RADEON_DAC_MACRO_CNTL, dac_macro_cntl);\r\nif (rdev->is_atom_bios)\r\nradeon_atombios_encoder_dpms_scratch_regs(encoder, (mode == DRM_MODE_DPMS_ON) ? true : false);\r\nelse\r\nradeon_combios_encoder_dpms_scratch_regs(encoder, (mode == DRM_MODE_DPMS_ON) ? true : false);\r\n}\r\nstatic void radeon_legacy_primary_dac_prepare(struct drm_encoder *encoder)\r\n{\r\nstruct radeon_device *rdev = encoder->dev->dev_private;\r\nif (rdev->is_atom_bios)\r\nradeon_atom_output_lock(encoder, true);\r\nelse\r\nradeon_combios_output_lock(encoder, true);\r\nradeon_legacy_primary_dac_dpms(encoder, DRM_MODE_DPMS_OFF);\r\n}\r\nstatic void radeon_legacy_primary_dac_commit(struct drm_encoder *encoder)\r\n{\r\nstruct radeon_device *rdev = encoder->dev->dev_private;\r\nradeon_legacy_primary_dac_dpms(encoder, DRM_MODE_DPMS_ON);\r\nif (rdev->is_atom_bios)\r\nradeon_atom_output_lock(encoder, false);\r\nelse\r\nradeon_combios_output_lock(encoder, false);\r\n}\r\nstatic void radeon_legacy_primary_dac_mode_set(struct drm_encoder *encoder,\r\nstruct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct radeon_crtc *radeon_crtc = to_radeon_crtc(encoder->crtc);\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nuint32_t disp_output_cntl, dac_cntl, dac2_cntl, dac_macro_cntl;\r\nDRM_DEBUG_KMS("\n");\r\nif (radeon_crtc->crtc_id == 0) {\r\nif (rdev->family == CHIP_R200 || ASIC_IS_R300(rdev)) {\r\ndisp_output_cntl = RREG32(RADEON_DISP_OUTPUT_CNTL) &\r\n~(RADEON_DISP_DAC_SOURCE_MASK);\r\nWREG32(RADEON_DISP_OUTPUT_CNTL, disp_output_cntl);\r\n} else {\r\ndac2_cntl = RREG32(RADEON_DAC_CNTL2) & ~(RADEON_DAC2_DAC_CLK_SEL);\r\nWREG32(RADEON_DAC_CNTL2, dac2_cntl);\r\n}\r\n} else {\r\nif (rdev->family == CHIP_R200 || ASIC_IS_R300(rdev)) {\r\ndisp_output_cntl = RREG32(RADEON_DISP_OUTPUT_CNTL) &\r\n~(RADEON_DISP_DAC_SOURCE_MASK);\r\ndisp_output_cntl |= RADEON_DISP_DAC_SOURCE_CRTC2;\r\nWREG32(RADEON_DISP_OUTPUT_CNTL, disp_output_cntl);\r\n} else {\r\ndac2_cntl = RREG32(RADEON_DAC_CNTL2) | RADEON_DAC2_DAC_CLK_SEL;\r\nWREG32(RADEON_DAC_CNTL2, dac2_cntl);\r\n}\r\n}\r\ndac_cntl = (RADEON_DAC_MASK_ALL |\r\nRADEON_DAC_VGA_ADR_EN |\r\nRADEON_DAC_8BIT_EN);\r\nWREG32_P(RADEON_DAC_CNTL,\r\ndac_cntl,\r\nRADEON_DAC_RANGE_CNTL |\r\nRADEON_DAC_BLANKING);\r\nif (radeon_encoder->enc_priv) {\r\nstruct radeon_encoder_primary_dac *p_dac = (struct radeon_encoder_primary_dac *)radeon_encoder->enc_priv;\r\ndac_macro_cntl = p_dac->ps2_pdac_adj;\r\n} else\r\ndac_macro_cntl = RREG32(RADEON_DAC_MACRO_CNTL);\r\ndac_macro_cntl |= RADEON_DAC_PDWN_R | RADEON_DAC_PDWN_G | RADEON_DAC_PDWN_B;\r\nWREG32(RADEON_DAC_MACRO_CNTL, dac_macro_cntl);\r\nif (rdev->is_atom_bios)\r\nradeon_atombios_encoder_crtc_scratch_regs(encoder, radeon_crtc->crtc_id);\r\nelse\r\nradeon_combios_encoder_crtc_scratch_regs(encoder, radeon_crtc->crtc_id);\r\n}\r\nstatic enum drm_connector_status radeon_legacy_primary_dac_detect(struct drm_encoder *encoder,\r\nstruct drm_connector *connector)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nuint32_t vclk_ecp_cntl, crtc_ext_cntl;\r\nuint32_t dac_ext_cntl, dac_cntl, dac_macro_cntl, tmp;\r\nenum drm_connector_status found = connector_status_disconnected;\r\nbool color = true;\r\nvclk_ecp_cntl = RREG32_PLL(RADEON_VCLK_ECP_CNTL);\r\ncrtc_ext_cntl = RREG32(RADEON_CRTC_EXT_CNTL);\r\ndac_ext_cntl = RREG32(RADEON_DAC_EXT_CNTL);\r\ndac_cntl = RREG32(RADEON_DAC_CNTL);\r\ndac_macro_cntl = RREG32(RADEON_DAC_MACRO_CNTL);\r\ntmp = vclk_ecp_cntl &\r\n~(RADEON_PIXCLK_ALWAYS_ONb | RADEON_PIXCLK_DAC_ALWAYS_ONb);\r\nWREG32_PLL(RADEON_VCLK_ECP_CNTL, tmp);\r\ntmp = crtc_ext_cntl | RADEON_CRTC_CRT_ON;\r\nWREG32(RADEON_CRTC_EXT_CNTL, tmp);\r\ntmp = RADEON_DAC_FORCE_BLANK_OFF_EN |\r\nRADEON_DAC_FORCE_DATA_EN;\r\nif (color)\r\ntmp |= RADEON_DAC_FORCE_DATA_SEL_RGB;\r\nelse\r\ntmp |= RADEON_DAC_FORCE_DATA_SEL_G;\r\nif (ASIC_IS_R300(rdev))\r\ntmp |= (0x1b6 << RADEON_DAC_FORCE_DATA_SHIFT);\r\nelse\r\ntmp |= (0x180 << RADEON_DAC_FORCE_DATA_SHIFT);\r\nWREG32(RADEON_DAC_EXT_CNTL, tmp);\r\ntmp = dac_cntl & ~(RADEON_DAC_RANGE_CNTL_MASK | RADEON_DAC_PDWN);\r\ntmp |= RADEON_DAC_RANGE_CNTL_PS2 | RADEON_DAC_CMP_EN;\r\nWREG32(RADEON_DAC_CNTL, tmp);\r\ntmp &= ~(RADEON_DAC_PDWN_R |\r\nRADEON_DAC_PDWN_G |\r\nRADEON_DAC_PDWN_B);\r\nWREG32(RADEON_DAC_MACRO_CNTL, tmp);\r\nudelay(2000);\r\nif (RREG32(RADEON_DAC_CNTL) & RADEON_DAC_CMP_OUTPUT)\r\nfound = connector_status_connected;\r\nWREG32(RADEON_DAC_CNTL, dac_cntl);\r\nWREG32(RADEON_DAC_MACRO_CNTL, dac_macro_cntl);\r\nWREG32(RADEON_DAC_EXT_CNTL, dac_ext_cntl);\r\nWREG32(RADEON_CRTC_EXT_CNTL, crtc_ext_cntl);\r\nWREG32_PLL(RADEON_VCLK_ECP_CNTL, vclk_ecp_cntl);\r\nreturn found;\r\n}\r\nstatic void radeon_legacy_tmds_int_dpms(struct drm_encoder *encoder, int mode)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nuint32_t fp_gen_cntl = RREG32(RADEON_FP_GEN_CNTL);\r\nDRM_DEBUG_KMS("\n");\r\nswitch (mode) {\r\ncase DRM_MODE_DPMS_ON:\r\nfp_gen_cntl |= (RADEON_FP_FPON | RADEON_FP_TMDS_EN);\r\nbreak;\r\ncase DRM_MODE_DPMS_STANDBY:\r\ncase DRM_MODE_DPMS_SUSPEND:\r\ncase DRM_MODE_DPMS_OFF:\r\nfp_gen_cntl &= ~(RADEON_FP_FPON | RADEON_FP_TMDS_EN);\r\nbreak;\r\n}\r\nWREG32(RADEON_FP_GEN_CNTL, fp_gen_cntl);\r\nif (rdev->is_atom_bios)\r\nradeon_atombios_encoder_dpms_scratch_regs(encoder, (mode == DRM_MODE_DPMS_ON) ? true : false);\r\nelse\r\nradeon_combios_encoder_dpms_scratch_regs(encoder, (mode == DRM_MODE_DPMS_ON) ? true : false);\r\n}\r\nstatic void radeon_legacy_tmds_int_prepare(struct drm_encoder *encoder)\r\n{\r\nstruct radeon_device *rdev = encoder->dev->dev_private;\r\nif (rdev->is_atom_bios)\r\nradeon_atom_output_lock(encoder, true);\r\nelse\r\nradeon_combios_output_lock(encoder, true);\r\nradeon_legacy_tmds_int_dpms(encoder, DRM_MODE_DPMS_OFF);\r\n}\r\nstatic void radeon_legacy_tmds_int_commit(struct drm_encoder *encoder)\r\n{\r\nstruct radeon_device *rdev = encoder->dev->dev_private;\r\nradeon_legacy_tmds_int_dpms(encoder, DRM_MODE_DPMS_ON);\r\nif (rdev->is_atom_bios)\r\nradeon_atom_output_lock(encoder, true);\r\nelse\r\nradeon_combios_output_lock(encoder, true);\r\n}\r\nstatic void radeon_legacy_tmds_int_mode_set(struct drm_encoder *encoder,\r\nstruct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct radeon_crtc *radeon_crtc = to_radeon_crtc(encoder->crtc);\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nuint32_t tmp, tmds_pll_cntl, tmds_transmitter_cntl, fp_gen_cntl;\r\nint i;\r\nDRM_DEBUG_KMS("\n");\r\ntmp = tmds_pll_cntl = RREG32(RADEON_TMDS_PLL_CNTL);\r\ntmp &= 0xfffff;\r\nif (rdev->family == CHIP_RV280) {\r\ntmp ^= (1 << 22);\r\ntmds_pll_cntl ^= (1 << 22);\r\n}\r\nif (radeon_encoder->enc_priv) {\r\nstruct radeon_encoder_int_tmds *tmds = (struct radeon_encoder_int_tmds *)radeon_encoder->enc_priv;\r\nfor (i = 0; i < 4; i++) {\r\nif (tmds->tmds_pll[i].freq == 0)\r\nbreak;\r\nif ((uint32_t)(mode->clock / 10) < tmds->tmds_pll[i].freq) {\r\ntmp = tmds->tmds_pll[i].value ;\r\nbreak;\r\n}\r\n}\r\n}\r\nif (ASIC_IS_R300(rdev) || (rdev->family == CHIP_RV280)) {\r\nif (tmp & 0xfff00000)\r\ntmds_pll_cntl = tmp;\r\nelse {\r\ntmds_pll_cntl &= 0xfff00000;\r\ntmds_pll_cntl |= tmp;\r\n}\r\n} else\r\ntmds_pll_cntl = tmp;\r\ntmds_transmitter_cntl = RREG32(RADEON_TMDS_TRANSMITTER_CNTL) &\r\n~(RADEON_TMDS_TRANSMITTER_PLLRST);\r\nif (rdev->family == CHIP_R200 ||\r\nrdev->family == CHIP_R100 ||\r\nASIC_IS_R300(rdev))\r\ntmds_transmitter_cntl &= ~(RADEON_TMDS_TRANSMITTER_PLLEN);\r\nelse\r\ntmds_transmitter_cntl |= RADEON_TMDS_TRANSMITTER_PLLEN;\r\nfp_gen_cntl = (RREG32(RADEON_FP_GEN_CNTL) |\r\n(RADEON_FP_CRTC_DONT_SHADOW_VPAR |\r\nRADEON_FP_CRTC_DONT_SHADOW_HEND));\r\nfp_gen_cntl &= ~(RADEON_FP_FPON | RADEON_FP_TMDS_EN);\r\nfp_gen_cntl &= ~(RADEON_FP_RMX_HVSYNC_CONTROL_EN |\r\nRADEON_FP_DFP_SYNC_SEL |\r\nRADEON_FP_CRT_SYNC_SEL |\r\nRADEON_FP_CRTC_LOCK_8DOT |\r\nRADEON_FP_USE_SHADOW_EN |\r\nRADEON_FP_CRTC_USE_SHADOW_VEND |\r\nRADEON_FP_CRT_SYNC_ALT);\r\nif (1)\r\nfp_gen_cntl |= RADEON_FP_PANEL_FORMAT;\r\nelse\r\nfp_gen_cntl &= ~RADEON_FP_PANEL_FORMAT;\r\nif (radeon_crtc->crtc_id == 0) {\r\nif (ASIC_IS_R300(rdev) || rdev->family == CHIP_R200) {\r\nfp_gen_cntl &= ~R200_FP_SOURCE_SEL_MASK;\r\nif (radeon_encoder->rmx_type != RMX_OFF)\r\nfp_gen_cntl |= R200_FP_SOURCE_SEL_RMX;\r\nelse\r\nfp_gen_cntl |= R200_FP_SOURCE_SEL_CRTC1;\r\n} else\r\nfp_gen_cntl &= ~RADEON_FP_SEL_CRTC2;\r\n} else {\r\nif (ASIC_IS_R300(rdev) || rdev->family == CHIP_R200) {\r\nfp_gen_cntl &= ~R200_FP_SOURCE_SEL_MASK;\r\nfp_gen_cntl |= R200_FP_SOURCE_SEL_CRTC2;\r\n} else\r\nfp_gen_cntl |= RADEON_FP_SEL_CRTC2;\r\n}\r\nWREG32(RADEON_TMDS_PLL_CNTL, tmds_pll_cntl);\r\nWREG32(RADEON_TMDS_TRANSMITTER_CNTL, tmds_transmitter_cntl);\r\nWREG32(RADEON_FP_GEN_CNTL, fp_gen_cntl);\r\nif (rdev->is_atom_bios)\r\nradeon_atombios_encoder_crtc_scratch_regs(encoder, radeon_crtc->crtc_id);\r\nelse\r\nradeon_combios_encoder_crtc_scratch_regs(encoder, radeon_crtc->crtc_id);\r\n}\r\nstatic void radeon_legacy_tmds_ext_dpms(struct drm_encoder *encoder, int mode)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nuint32_t fp2_gen_cntl = RREG32(RADEON_FP2_GEN_CNTL);\r\nDRM_DEBUG_KMS("\n");\r\nswitch (mode) {\r\ncase DRM_MODE_DPMS_ON:\r\nfp2_gen_cntl &= ~RADEON_FP2_BLANK_EN;\r\nfp2_gen_cntl |= (RADEON_FP2_ON | RADEON_FP2_DVO_EN);\r\nbreak;\r\ncase DRM_MODE_DPMS_STANDBY:\r\ncase DRM_MODE_DPMS_SUSPEND:\r\ncase DRM_MODE_DPMS_OFF:\r\nfp2_gen_cntl |= RADEON_FP2_BLANK_EN;\r\nfp2_gen_cntl &= ~(RADEON_FP2_ON | RADEON_FP2_DVO_EN);\r\nbreak;\r\n}\r\nWREG32(RADEON_FP2_GEN_CNTL, fp2_gen_cntl);\r\nif (rdev->is_atom_bios)\r\nradeon_atombios_encoder_dpms_scratch_regs(encoder, (mode == DRM_MODE_DPMS_ON) ? true : false);\r\nelse\r\nradeon_combios_encoder_dpms_scratch_regs(encoder, (mode == DRM_MODE_DPMS_ON) ? true : false);\r\n}\r\nstatic void radeon_legacy_tmds_ext_prepare(struct drm_encoder *encoder)\r\n{\r\nstruct radeon_device *rdev = encoder->dev->dev_private;\r\nif (rdev->is_atom_bios)\r\nradeon_atom_output_lock(encoder, true);\r\nelse\r\nradeon_combios_output_lock(encoder, true);\r\nradeon_legacy_tmds_ext_dpms(encoder, DRM_MODE_DPMS_OFF);\r\n}\r\nstatic void radeon_legacy_tmds_ext_commit(struct drm_encoder *encoder)\r\n{\r\nstruct radeon_device *rdev = encoder->dev->dev_private;\r\nradeon_legacy_tmds_ext_dpms(encoder, DRM_MODE_DPMS_ON);\r\nif (rdev->is_atom_bios)\r\nradeon_atom_output_lock(encoder, false);\r\nelse\r\nradeon_combios_output_lock(encoder, false);\r\n}\r\nstatic void radeon_legacy_tmds_ext_mode_set(struct drm_encoder *encoder,\r\nstruct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct radeon_crtc *radeon_crtc = to_radeon_crtc(encoder->crtc);\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nuint32_t fp2_gen_cntl;\r\nDRM_DEBUG_KMS("\n");\r\nif (rdev->is_atom_bios) {\r\nradeon_encoder->pixel_clock = adjusted_mode->clock;\r\natombios_dvo_setup(encoder, ATOM_ENABLE);\r\nfp2_gen_cntl = RREG32(RADEON_FP2_GEN_CNTL);\r\n} else {\r\nfp2_gen_cntl = RREG32(RADEON_FP2_GEN_CNTL);\r\nif (1)\r\nfp2_gen_cntl |= RADEON_FP2_PANEL_FORMAT;\r\nelse\r\nfp2_gen_cntl &= ~RADEON_FP2_PANEL_FORMAT;\r\nfp2_gen_cntl &= ~(RADEON_FP2_ON |\r\nRADEON_FP2_DVO_EN |\r\nRADEON_FP2_DVO_RATE_SEL_SDR);\r\nif (ASIC_IS_R300(rdev)) {\r\nif ((dev->pdev->device == 0x4850) &&\r\n(dev->pdev->subsystem_vendor == 0x1028) &&\r\n(dev->pdev->subsystem_device == 0x2001))\r\nfp2_gen_cntl |= R300_FP2_DVO_CLOCK_MODE_SINGLE;\r\nelse\r\nfp2_gen_cntl |= RADEON_FP2_PAD_FLOP_EN | R300_FP2_DVO_CLOCK_MODE_SINGLE;\r\n}\r\nif (!radeon_combios_external_tmds_setup(encoder))\r\nradeon_external_tmds_setup(encoder);\r\n}\r\nif (radeon_crtc->crtc_id == 0) {\r\nif ((rdev->family == CHIP_R200) || ASIC_IS_R300(rdev)) {\r\nfp2_gen_cntl &= ~R200_FP2_SOURCE_SEL_MASK;\r\nif (radeon_encoder->rmx_type != RMX_OFF)\r\nfp2_gen_cntl |= R200_FP2_SOURCE_SEL_RMX;\r\nelse\r\nfp2_gen_cntl |= R200_FP2_SOURCE_SEL_CRTC1;\r\n} else\r\nfp2_gen_cntl &= ~RADEON_FP2_SRC_SEL_CRTC2;\r\n} else {\r\nif ((rdev->family == CHIP_R200) || ASIC_IS_R300(rdev)) {\r\nfp2_gen_cntl &= ~R200_FP2_SOURCE_SEL_MASK;\r\nfp2_gen_cntl |= R200_FP2_SOURCE_SEL_CRTC2;\r\n} else\r\nfp2_gen_cntl |= RADEON_FP2_SRC_SEL_CRTC2;\r\n}\r\nWREG32(RADEON_FP2_GEN_CNTL, fp2_gen_cntl);\r\nif (rdev->is_atom_bios)\r\nradeon_atombios_encoder_crtc_scratch_regs(encoder, radeon_crtc->crtc_id);\r\nelse\r\nradeon_combios_encoder_crtc_scratch_regs(encoder, radeon_crtc->crtc_id);\r\n}\r\nstatic void radeon_ext_tmds_enc_destroy(struct drm_encoder *encoder)\r\n{\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct radeon_encoder_ext_tmds *tmds = radeon_encoder->enc_priv;\r\nif (tmds) {\r\nif (tmds->i2c_bus)\r\nradeon_i2c_destroy(tmds->i2c_bus);\r\n}\r\nkfree(radeon_encoder->enc_priv);\r\ndrm_encoder_cleanup(encoder);\r\nkfree(radeon_encoder);\r\n}\r\nstatic void radeon_legacy_tv_dac_dpms(struct drm_encoder *encoder, int mode)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nuint32_t fp2_gen_cntl = 0, crtc2_gen_cntl = 0, tv_dac_cntl = 0;\r\nuint32_t tv_master_cntl = 0;\r\nbool is_tv;\r\nDRM_DEBUG_KMS("\n");\r\nis_tv = radeon_encoder->active_device & ATOM_DEVICE_TV_SUPPORT ? true : false;\r\nif (rdev->family == CHIP_R200)\r\nfp2_gen_cntl = RREG32(RADEON_FP2_GEN_CNTL);\r\nelse {\r\nif (is_tv)\r\ntv_master_cntl = RREG32(RADEON_TV_MASTER_CNTL);\r\nelse\r\ncrtc2_gen_cntl = RREG32(RADEON_CRTC2_GEN_CNTL);\r\ntv_dac_cntl = RREG32(RADEON_TV_DAC_CNTL);\r\n}\r\nswitch (mode) {\r\ncase DRM_MODE_DPMS_ON:\r\nif (rdev->family == CHIP_R200) {\r\nfp2_gen_cntl |= (RADEON_FP2_ON | RADEON_FP2_DVO_EN);\r\n} else {\r\nif (is_tv)\r\ntv_master_cntl |= RADEON_TV_ON;\r\nelse\r\ncrtc2_gen_cntl |= RADEON_CRTC2_CRT2_ON;\r\nif (rdev->family == CHIP_R420 ||\r\nrdev->family == CHIP_R423 ||\r\nrdev->family == CHIP_RV410)\r\ntv_dac_cntl &= ~(R420_TV_DAC_RDACPD |\r\nR420_TV_DAC_GDACPD |\r\nR420_TV_DAC_BDACPD |\r\nRADEON_TV_DAC_BGSLEEP);\r\nelse\r\ntv_dac_cntl &= ~(RADEON_TV_DAC_RDACPD |\r\nRADEON_TV_DAC_GDACPD |\r\nRADEON_TV_DAC_BDACPD |\r\nRADEON_TV_DAC_BGSLEEP);\r\n}\r\nbreak;\r\ncase DRM_MODE_DPMS_STANDBY:\r\ncase DRM_MODE_DPMS_SUSPEND:\r\ncase DRM_MODE_DPMS_OFF:\r\nif (rdev->family == CHIP_R200)\r\nfp2_gen_cntl &= ~(RADEON_FP2_ON | RADEON_FP2_DVO_EN);\r\nelse {\r\nif (is_tv)\r\ntv_master_cntl &= ~RADEON_TV_ON;\r\nelse\r\ncrtc2_gen_cntl &= ~RADEON_CRTC2_CRT2_ON;\r\nif (rdev->family == CHIP_R420 ||\r\nrdev->family == CHIP_R423 ||\r\nrdev->family == CHIP_RV410)\r\ntv_dac_cntl |= (R420_TV_DAC_RDACPD |\r\nR420_TV_DAC_GDACPD |\r\nR420_TV_DAC_BDACPD |\r\nRADEON_TV_DAC_BGSLEEP);\r\nelse\r\ntv_dac_cntl |= (RADEON_TV_DAC_RDACPD |\r\nRADEON_TV_DAC_GDACPD |\r\nRADEON_TV_DAC_BDACPD |\r\nRADEON_TV_DAC_BGSLEEP);\r\n}\r\nbreak;\r\n}\r\nif (rdev->family == CHIP_R200) {\r\nWREG32(RADEON_FP2_GEN_CNTL, fp2_gen_cntl);\r\n} else {\r\nif (is_tv)\r\nWREG32(RADEON_TV_MASTER_CNTL, tv_master_cntl);\r\nelse\r\nWREG32(RADEON_CRTC2_GEN_CNTL, crtc2_gen_cntl);\r\nWREG32(RADEON_TV_DAC_CNTL, tv_dac_cntl);\r\n}\r\nif (rdev->is_atom_bios)\r\nradeon_atombios_encoder_dpms_scratch_regs(encoder, (mode == DRM_MODE_DPMS_ON) ? true : false);\r\nelse\r\nradeon_combios_encoder_dpms_scratch_regs(encoder, (mode == DRM_MODE_DPMS_ON) ? true : false);\r\n}\r\nstatic void radeon_legacy_tv_dac_prepare(struct drm_encoder *encoder)\r\n{\r\nstruct radeon_device *rdev = encoder->dev->dev_private;\r\nif (rdev->is_atom_bios)\r\nradeon_atom_output_lock(encoder, true);\r\nelse\r\nradeon_combios_output_lock(encoder, true);\r\nradeon_legacy_tv_dac_dpms(encoder, DRM_MODE_DPMS_OFF);\r\n}\r\nstatic void radeon_legacy_tv_dac_commit(struct drm_encoder *encoder)\r\n{\r\nstruct radeon_device *rdev = encoder->dev->dev_private;\r\nradeon_legacy_tv_dac_dpms(encoder, DRM_MODE_DPMS_ON);\r\nif (rdev->is_atom_bios)\r\nradeon_atom_output_lock(encoder, true);\r\nelse\r\nradeon_combios_output_lock(encoder, true);\r\n}\r\nstatic void radeon_legacy_tv_dac_mode_set(struct drm_encoder *encoder,\r\nstruct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct radeon_crtc *radeon_crtc = to_radeon_crtc(encoder->crtc);\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct radeon_encoder_tv_dac *tv_dac = radeon_encoder->enc_priv;\r\nuint32_t tv_dac_cntl, gpiopad_a = 0, dac2_cntl, disp_output_cntl = 0;\r\nuint32_t disp_hw_debug = 0, fp2_gen_cntl = 0, disp_tv_out_cntl = 0;\r\nbool is_tv = false;\r\nDRM_DEBUG_KMS("\n");\r\nis_tv = radeon_encoder->active_device & ATOM_DEVICE_TV_SUPPORT ? true : false;\r\nif (rdev->family != CHIP_R200) {\r\ntv_dac_cntl = RREG32(RADEON_TV_DAC_CNTL);\r\nif (rdev->family == CHIP_R420 ||\r\nrdev->family == CHIP_R423 ||\r\nrdev->family == CHIP_RV410) {\r\ntv_dac_cntl &= ~(RADEON_TV_DAC_STD_MASK |\r\nRADEON_TV_DAC_BGADJ_MASK |\r\nR420_TV_DAC_DACADJ_MASK |\r\nR420_TV_DAC_RDACPD |\r\nR420_TV_DAC_GDACPD |\r\nR420_TV_DAC_BDACPD |\r\nR420_TV_DAC_TVENABLE);\r\n} else {\r\ntv_dac_cntl &= ~(RADEON_TV_DAC_STD_MASK |\r\nRADEON_TV_DAC_BGADJ_MASK |\r\nRADEON_TV_DAC_DACADJ_MASK |\r\nRADEON_TV_DAC_RDACPD |\r\nRADEON_TV_DAC_GDACPD |\r\nRADEON_TV_DAC_BDACPD);\r\n}\r\ntv_dac_cntl |= RADEON_TV_DAC_NBLANK | RADEON_TV_DAC_NHOLD;\r\nif (is_tv) {\r\nif (tv_dac->tv_std == TV_STD_NTSC ||\r\ntv_dac->tv_std == TV_STD_NTSC_J ||\r\ntv_dac->tv_std == TV_STD_PAL_M ||\r\ntv_dac->tv_std == TV_STD_PAL_60)\r\ntv_dac_cntl |= tv_dac->ntsc_tvdac_adj;\r\nelse\r\ntv_dac_cntl |= tv_dac->pal_tvdac_adj;\r\nif (tv_dac->tv_std == TV_STD_NTSC ||\r\ntv_dac->tv_std == TV_STD_NTSC_J)\r\ntv_dac_cntl |= RADEON_TV_DAC_STD_NTSC;\r\nelse\r\ntv_dac_cntl |= RADEON_TV_DAC_STD_PAL;\r\n} else\r\ntv_dac_cntl |= (RADEON_TV_DAC_STD_PS2 |\r\ntv_dac->ps2_tvdac_adj);\r\nWREG32(RADEON_TV_DAC_CNTL, tv_dac_cntl);\r\n}\r\nif (ASIC_IS_R300(rdev)) {\r\ngpiopad_a = RREG32(RADEON_GPIOPAD_A) | 1;\r\ndisp_output_cntl = RREG32(RADEON_DISP_OUTPUT_CNTL);\r\n} else if (rdev->family != CHIP_R200)\r\ndisp_hw_debug = RREG32(RADEON_DISP_HW_DEBUG);\r\nelse if (rdev->family == CHIP_R200)\r\nfp2_gen_cntl = RREG32(RADEON_FP2_GEN_CNTL);\r\nif (rdev->family >= CHIP_R200)\r\ndisp_tv_out_cntl = RREG32(RADEON_DISP_TV_OUT_CNTL);\r\nif (is_tv) {\r\nuint32_t dac_cntl;\r\ndac_cntl = RREG32(RADEON_DAC_CNTL);\r\ndac_cntl &= ~RADEON_DAC_TVO_EN;\r\nWREG32(RADEON_DAC_CNTL, dac_cntl);\r\nif (ASIC_IS_R300(rdev))\r\ngpiopad_a = RREG32(RADEON_GPIOPAD_A) & ~1;\r\ndac2_cntl = RREG32(RADEON_DAC_CNTL2) & ~RADEON_DAC2_DAC2_CLK_SEL;\r\nif (radeon_crtc->crtc_id == 0) {\r\nif (ASIC_IS_R300(rdev)) {\r\ndisp_output_cntl &= ~RADEON_DISP_TVDAC_SOURCE_MASK;\r\ndisp_output_cntl |= (RADEON_DISP_TVDAC_SOURCE_CRTC |\r\nRADEON_DISP_TV_SOURCE_CRTC);\r\n}\r\nif (rdev->family >= CHIP_R200) {\r\ndisp_tv_out_cntl &= ~RADEON_DISP_TV_PATH_SRC_CRTC2;\r\n} else {\r\ndisp_hw_debug |= RADEON_CRT2_DISP1_SEL;\r\n}\r\n} else {\r\nif (ASIC_IS_R300(rdev)) {\r\ndisp_output_cntl &= ~RADEON_DISP_TVDAC_SOURCE_MASK;\r\ndisp_output_cntl |= RADEON_DISP_TV_SOURCE_CRTC;\r\n}\r\nif (rdev->family >= CHIP_R200) {\r\ndisp_tv_out_cntl |= RADEON_DISP_TV_PATH_SRC_CRTC2;\r\n} else {\r\ndisp_hw_debug &= ~RADEON_CRT2_DISP1_SEL;\r\n}\r\n}\r\nWREG32(RADEON_DAC_CNTL2, dac2_cntl);\r\n} else {\r\ndac2_cntl = RREG32(RADEON_DAC_CNTL2) | RADEON_DAC2_DAC2_CLK_SEL;\r\nif (radeon_crtc->crtc_id == 0) {\r\nif (ASIC_IS_R300(rdev)) {\r\ndisp_output_cntl &= ~RADEON_DISP_TVDAC_SOURCE_MASK;\r\ndisp_output_cntl |= RADEON_DISP_TVDAC_SOURCE_CRTC;\r\n} else if (rdev->family == CHIP_R200) {\r\nfp2_gen_cntl &= ~(R200_FP2_SOURCE_SEL_MASK |\r\nRADEON_FP2_DVO_RATE_SEL_SDR);\r\n} else\r\ndisp_hw_debug |= RADEON_CRT2_DISP1_SEL;\r\n} else {\r\nif (ASIC_IS_R300(rdev)) {\r\ndisp_output_cntl &= ~RADEON_DISP_TVDAC_SOURCE_MASK;\r\ndisp_output_cntl |= RADEON_DISP_TVDAC_SOURCE_CRTC2;\r\n} else if (rdev->family == CHIP_R200) {\r\nfp2_gen_cntl &= ~(R200_FP2_SOURCE_SEL_MASK |\r\nRADEON_FP2_DVO_RATE_SEL_SDR);\r\nfp2_gen_cntl |= R200_FP2_SOURCE_SEL_CRTC2;\r\n} else\r\ndisp_hw_debug &= ~RADEON_CRT2_DISP1_SEL;\r\n}\r\nWREG32(RADEON_DAC_CNTL2, dac2_cntl);\r\n}\r\nif (ASIC_IS_R300(rdev)) {\r\nWREG32_P(RADEON_GPIOPAD_A, gpiopad_a, ~1);\r\nWREG32(RADEON_DISP_OUTPUT_CNTL, disp_output_cntl);\r\n} else if (rdev->family != CHIP_R200)\r\nWREG32(RADEON_DISP_HW_DEBUG, disp_hw_debug);\r\nelse if (rdev->family == CHIP_R200)\r\nWREG32(RADEON_FP2_GEN_CNTL, fp2_gen_cntl);\r\nif (rdev->family >= CHIP_R200)\r\nWREG32(RADEON_DISP_TV_OUT_CNTL, disp_tv_out_cntl);\r\nif (is_tv)\r\nradeon_legacy_tv_mode_set(encoder, mode, adjusted_mode);\r\nif (rdev->is_atom_bios)\r\nradeon_atombios_encoder_crtc_scratch_regs(encoder, radeon_crtc->crtc_id);\r\nelse\r\nradeon_combios_encoder_crtc_scratch_regs(encoder, radeon_crtc->crtc_id);\r\n}\r\nstatic bool r300_legacy_tv_detect(struct drm_encoder *encoder,\r\nstruct drm_connector *connector)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nuint32_t crtc2_gen_cntl, tv_dac_cntl, dac_cntl2, dac_ext_cntl;\r\nuint32_t disp_output_cntl, gpiopad_a, tmp;\r\nbool found = false;\r\ngpiopad_a = RREG32(RADEON_GPIOPAD_A);\r\ndac_cntl2 = RREG32(RADEON_DAC_CNTL2);\r\ncrtc2_gen_cntl = RREG32(RADEON_CRTC2_GEN_CNTL);\r\ndac_ext_cntl = RREG32(RADEON_DAC_EXT_CNTL);\r\ntv_dac_cntl = RREG32(RADEON_TV_DAC_CNTL);\r\ndisp_output_cntl = RREG32(RADEON_DISP_OUTPUT_CNTL);\r\nWREG32_P(RADEON_GPIOPAD_A, 0, ~1);\r\nWREG32(RADEON_DAC_CNTL2, RADEON_DAC2_DAC2_CLK_SEL);\r\nWREG32(RADEON_CRTC2_GEN_CNTL,\r\nRADEON_CRTC2_CRT2_ON | RADEON_CRTC2_VSYNC_TRISTAT);\r\ntmp = disp_output_cntl & ~RADEON_DISP_TVDAC_SOURCE_MASK;\r\ntmp |= RADEON_DISP_TVDAC_SOURCE_CRTC2;\r\nWREG32(RADEON_DISP_OUTPUT_CNTL, tmp);\r\nWREG32(RADEON_DAC_EXT_CNTL,\r\nRADEON_DAC2_FORCE_BLANK_OFF_EN |\r\nRADEON_DAC2_FORCE_DATA_EN |\r\nRADEON_DAC_FORCE_DATA_SEL_RGB |\r\n(0xec << RADEON_DAC_FORCE_DATA_SHIFT));\r\nWREG32(RADEON_TV_DAC_CNTL,\r\nRADEON_TV_DAC_STD_NTSC |\r\n(8 << RADEON_TV_DAC_BGADJ_SHIFT) |\r\n(6 << RADEON_TV_DAC_DACADJ_SHIFT));\r\nRREG32(RADEON_TV_DAC_CNTL);\r\nmdelay(4);\r\nWREG32(RADEON_TV_DAC_CNTL,\r\nRADEON_TV_DAC_NBLANK |\r\nRADEON_TV_DAC_NHOLD |\r\nRADEON_TV_MONITOR_DETECT_EN |\r\nRADEON_TV_DAC_STD_NTSC |\r\n(8 << RADEON_TV_DAC_BGADJ_SHIFT) |\r\n(6 << RADEON_TV_DAC_DACADJ_SHIFT));\r\nRREG32(RADEON_TV_DAC_CNTL);\r\nmdelay(6);\r\ntmp = RREG32(RADEON_TV_DAC_CNTL);\r\nif ((tmp & RADEON_TV_DAC_GDACDET) != 0) {\r\nfound = true;\r\nDRM_DEBUG_KMS("S-video TV connection detected\n");\r\n} else if ((tmp & RADEON_TV_DAC_BDACDET) != 0) {\r\nfound = true;\r\nDRM_DEBUG_KMS("Composite TV connection detected\n");\r\n}\r\nWREG32(RADEON_TV_DAC_CNTL, tv_dac_cntl);\r\nWREG32(RADEON_DAC_EXT_CNTL, dac_ext_cntl);\r\nWREG32(RADEON_CRTC2_GEN_CNTL, crtc2_gen_cntl);\r\nWREG32(RADEON_DISP_OUTPUT_CNTL, disp_output_cntl);\r\nWREG32(RADEON_DAC_CNTL2, dac_cntl2);\r\nWREG32_P(RADEON_GPIOPAD_A, gpiopad_a, ~1);\r\nreturn found;\r\n}\r\nstatic bool radeon_legacy_tv_detect(struct drm_encoder *encoder,\r\nstruct drm_connector *connector)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nuint32_t tv_dac_cntl, dac_cntl2;\r\nuint32_t config_cntl, tv_pre_dac_mux_cntl, tv_master_cntl, tmp;\r\nbool found = false;\r\nif (ASIC_IS_R300(rdev))\r\nreturn r300_legacy_tv_detect(encoder, connector);\r\ndac_cntl2 = RREG32(RADEON_DAC_CNTL2);\r\ntv_master_cntl = RREG32(RADEON_TV_MASTER_CNTL);\r\ntv_dac_cntl = RREG32(RADEON_TV_DAC_CNTL);\r\nconfig_cntl = RREG32(RADEON_CONFIG_CNTL);\r\ntv_pre_dac_mux_cntl = RREG32(RADEON_TV_PRE_DAC_MUX_CNTL);\r\ntmp = dac_cntl2 & ~RADEON_DAC2_DAC2_CLK_SEL;\r\nWREG32(RADEON_DAC_CNTL2, tmp);\r\ntmp = tv_master_cntl | RADEON_TV_ON;\r\ntmp &= ~(RADEON_TV_ASYNC_RST |\r\nRADEON_RESTART_PHASE_FIX |\r\nRADEON_CRT_FIFO_CE_EN |\r\nRADEON_TV_FIFO_CE_EN |\r\nRADEON_RE_SYNC_NOW_SEL_MASK);\r\ntmp |= RADEON_TV_FIFO_ASYNC_RST | RADEON_CRT_ASYNC_RST;\r\nWREG32(RADEON_TV_MASTER_CNTL, tmp);\r\ntmp = RADEON_TV_DAC_NBLANK | RADEON_TV_DAC_NHOLD |\r\nRADEON_TV_MONITOR_DETECT_EN | RADEON_TV_DAC_STD_NTSC |\r\n(8 << RADEON_TV_DAC_BGADJ_SHIFT);\r\nif (config_cntl & RADEON_CFG_ATI_REV_ID_MASK)\r\ntmp |= (4 << RADEON_TV_DAC_DACADJ_SHIFT);\r\nelse\r\ntmp |= (8 << RADEON_TV_DAC_DACADJ_SHIFT);\r\nWREG32(RADEON_TV_DAC_CNTL, tmp);\r\ntmp = RADEON_C_GRN_EN | RADEON_CMP_BLU_EN |\r\nRADEON_RED_MX_FORCE_DAC_DATA |\r\nRADEON_GRN_MX_FORCE_DAC_DATA |\r\nRADEON_BLU_MX_FORCE_DAC_DATA |\r\n(0x109 << RADEON_TV_FORCE_DAC_DATA_SHIFT);\r\nWREG32(RADEON_TV_PRE_DAC_MUX_CNTL, tmp);\r\nmdelay(3);\r\ntmp = RREG32(RADEON_TV_DAC_CNTL);\r\nif (tmp & RADEON_TV_DAC_GDACDET) {\r\nfound = true;\r\nDRM_DEBUG_KMS("S-video TV connection detected\n");\r\n} else if ((tmp & RADEON_TV_DAC_BDACDET) != 0) {\r\nfound = true;\r\nDRM_DEBUG_KMS("Composite TV connection detected\n");\r\n}\r\nWREG32(RADEON_TV_PRE_DAC_MUX_CNTL, tv_pre_dac_mux_cntl);\r\nWREG32(RADEON_TV_DAC_CNTL, tv_dac_cntl);\r\nWREG32(RADEON_TV_MASTER_CNTL, tv_master_cntl);\r\nWREG32(RADEON_DAC_CNTL2, dac_cntl2);\r\nreturn found;\r\n}\r\nstatic enum drm_connector_status radeon_legacy_tv_dac_detect(struct drm_encoder *encoder,\r\nstruct drm_connector *connector)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nuint32_t crtc2_gen_cntl, tv_dac_cntl, dac_cntl2, dac_ext_cntl;\r\nuint32_t disp_hw_debug, disp_output_cntl, gpiopad_a, pixclks_cntl, tmp;\r\nenum drm_connector_status found = connector_status_disconnected;\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct radeon_encoder_tv_dac *tv_dac = radeon_encoder->enc_priv;\r\nbool color = true;\r\nstruct drm_crtc *crtc;\r\nlist_for_each_entry(crtc, &dev->mode_config.crtc_list, head) {\r\nstruct radeon_crtc *radeon_crtc = to_radeon_crtc(crtc);\r\nif ((radeon_crtc->crtc_id == 1) && crtc->enabled) {\r\nif (encoder->crtc != crtc) {\r\nreturn connector_status_disconnected;\r\n}\r\n}\r\n}\r\nif (connector->connector_type == DRM_MODE_CONNECTOR_SVIDEO ||\r\nconnector->connector_type == DRM_MODE_CONNECTOR_Composite ||\r\nconnector->connector_type == DRM_MODE_CONNECTOR_9PinDIN) {\r\nbool tv_detect;\r\nif (radeon_encoder->active_device && !(radeon_encoder->active_device & ATOM_DEVICE_TV_SUPPORT))\r\nreturn connector_status_disconnected;\r\ntv_detect = radeon_legacy_tv_detect(encoder, connector);\r\nif (tv_detect && tv_dac)\r\nfound = connector_status_connected;\r\nreturn found;\r\n}\r\nif (radeon_encoder->active_device && !(radeon_encoder->active_device & ATOM_DEVICE_CRT_SUPPORT)) {\r\nDRM_INFO("not detecting due to %08x\n", radeon_encoder->active_device);\r\nreturn connector_status_disconnected;\r\n}\r\npixclks_cntl = RREG32_PLL(RADEON_PIXCLKS_CNTL);\r\ngpiopad_a = ASIC_IS_R300(rdev) ? RREG32(RADEON_GPIOPAD_A) : 0;\r\ndisp_output_cntl = ASIC_IS_R300(rdev) ? RREG32(RADEON_DISP_OUTPUT_CNTL) : 0;\r\ndisp_hw_debug = ASIC_IS_R300(rdev) ? 0 : RREG32(RADEON_DISP_HW_DEBUG);\r\ncrtc2_gen_cntl = RREG32(RADEON_CRTC2_GEN_CNTL);\r\ntv_dac_cntl = RREG32(RADEON_TV_DAC_CNTL);\r\ndac_ext_cntl = RREG32(RADEON_DAC_EXT_CNTL);\r\ndac_cntl2 = RREG32(RADEON_DAC_CNTL2);\r\ntmp = pixclks_cntl & ~(RADEON_PIX2CLK_ALWAYS_ONb\r\n| RADEON_PIX2CLK_DAC_ALWAYS_ONb);\r\nWREG32_PLL(RADEON_PIXCLKS_CNTL, tmp);\r\nif (ASIC_IS_R300(rdev))\r\nWREG32_P(RADEON_GPIOPAD_A, 1, ~1);\r\ntmp = crtc2_gen_cntl & ~RADEON_CRTC2_PIX_WIDTH_MASK;\r\ntmp |= RADEON_CRTC2_CRT2_ON |\r\n(2 << RADEON_CRTC2_PIX_WIDTH_SHIFT);\r\nWREG32(RADEON_CRTC2_GEN_CNTL, tmp);\r\nif (ASIC_IS_R300(rdev)) {\r\ntmp = disp_output_cntl & ~RADEON_DISP_TVDAC_SOURCE_MASK;\r\ntmp |= RADEON_DISP_TVDAC_SOURCE_CRTC2;\r\nWREG32(RADEON_DISP_OUTPUT_CNTL, tmp);\r\n} else {\r\ntmp = disp_hw_debug & ~RADEON_CRT2_DISP1_SEL;\r\nWREG32(RADEON_DISP_HW_DEBUG, tmp);\r\n}\r\ntmp = RADEON_TV_DAC_NBLANK |\r\nRADEON_TV_DAC_NHOLD |\r\nRADEON_TV_MONITOR_DETECT_EN |\r\nRADEON_TV_DAC_STD_PS2;\r\nWREG32(RADEON_TV_DAC_CNTL, tmp);\r\ntmp = RADEON_DAC2_FORCE_BLANK_OFF_EN |\r\nRADEON_DAC2_FORCE_DATA_EN;\r\nif (color)\r\ntmp |= RADEON_DAC_FORCE_DATA_SEL_RGB;\r\nelse\r\ntmp |= RADEON_DAC_FORCE_DATA_SEL_G;\r\nif (ASIC_IS_R300(rdev))\r\ntmp |= (0x1b6 << RADEON_DAC_FORCE_DATA_SHIFT);\r\nelse\r\ntmp |= (0x180 << RADEON_DAC_FORCE_DATA_SHIFT);\r\nWREG32(RADEON_DAC_EXT_CNTL, tmp);\r\ntmp = dac_cntl2 | RADEON_DAC2_DAC2_CLK_SEL | RADEON_DAC2_CMP_EN;\r\nWREG32(RADEON_DAC_CNTL2, tmp);\r\nudelay(10000);\r\nif (ASIC_IS_R300(rdev)) {\r\nif (RREG32(RADEON_DAC_CNTL2) & RADEON_DAC2_CMP_OUT_B)\r\nfound = connector_status_connected;\r\n} else {\r\nif (RREG32(RADEON_DAC_CNTL2) & RADEON_DAC2_CMP_OUTPUT)\r\nfound = connector_status_connected;\r\n}\r\nWREG32(RADEON_DAC_CNTL2, dac_cntl2);\r\nWREG32(RADEON_DAC_EXT_CNTL, dac_ext_cntl);\r\nWREG32(RADEON_TV_DAC_CNTL, tv_dac_cntl);\r\nWREG32(RADEON_CRTC2_GEN_CNTL, crtc2_gen_cntl);\r\nif (ASIC_IS_R300(rdev)) {\r\nWREG32(RADEON_DISP_OUTPUT_CNTL, disp_output_cntl);\r\nWREG32_P(RADEON_GPIOPAD_A, gpiopad_a, ~1);\r\n} else {\r\nWREG32(RADEON_DISP_HW_DEBUG, disp_hw_debug);\r\n}\r\nWREG32_PLL(RADEON_PIXCLKS_CNTL, pixclks_cntl);\r\nreturn found;\r\n}\r\nstatic struct radeon_encoder_int_tmds *radeon_legacy_get_tmds_info(struct radeon_encoder *encoder)\r\n{\r\nstruct drm_device *dev = encoder->base.dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct radeon_encoder_int_tmds *tmds = NULL;\r\nbool ret;\r\ntmds = kzalloc(sizeof(struct radeon_encoder_int_tmds), GFP_KERNEL);\r\nif (!tmds)\r\nreturn NULL;\r\nif (rdev->is_atom_bios)\r\nret = radeon_atombios_get_tmds_info(encoder, tmds);\r\nelse\r\nret = radeon_legacy_get_tmds_info_from_combios(encoder, tmds);\r\nif (ret == false)\r\nradeon_legacy_get_tmds_info_from_table(encoder, tmds);\r\nreturn tmds;\r\n}\r\nstatic struct radeon_encoder_ext_tmds *radeon_legacy_get_ext_tmds_info(struct radeon_encoder *encoder)\r\n{\r\nstruct drm_device *dev = encoder->base.dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct radeon_encoder_ext_tmds *tmds = NULL;\r\nbool ret;\r\nif (rdev->is_atom_bios)\r\nreturn NULL;\r\ntmds = kzalloc(sizeof(struct radeon_encoder_ext_tmds), GFP_KERNEL);\r\nif (!tmds)\r\nreturn NULL;\r\nret = radeon_legacy_get_ext_tmds_info_from_combios(encoder, tmds);\r\nif (ret == false)\r\nradeon_legacy_get_ext_tmds_info_from_table(encoder, tmds);\r\nreturn tmds;\r\n}\r\nvoid\r\nradeon_add_legacy_encoder(struct drm_device *dev, uint32_t encoder_enum, uint32_t supported_device)\r\n{\r\nstruct radeon_device *rdev = dev->dev_private;\r\nstruct drm_encoder *encoder;\r\nstruct radeon_encoder *radeon_encoder;\r\nlist_for_each_entry(encoder, &dev->mode_config.encoder_list, head) {\r\nradeon_encoder = to_radeon_encoder(encoder);\r\nif (radeon_encoder->encoder_enum == encoder_enum) {\r\nradeon_encoder->devices |= supported_device;\r\nreturn;\r\n}\r\n}\r\nradeon_encoder = kzalloc(sizeof(struct radeon_encoder), GFP_KERNEL);\r\nif (!radeon_encoder)\r\nreturn;\r\nencoder = &radeon_encoder->base;\r\nif (rdev->flags & RADEON_SINGLE_CRTC)\r\nencoder->possible_crtcs = 0x1;\r\nelse\r\nencoder->possible_crtcs = 0x3;\r\nradeon_encoder->enc_priv = NULL;\r\nradeon_encoder->encoder_enum = encoder_enum;\r\nradeon_encoder->encoder_id = (encoder_enum & OBJECT_ID_MASK) >> OBJECT_ID_SHIFT;\r\nradeon_encoder->devices = supported_device;\r\nradeon_encoder->rmx_type = RMX_OFF;\r\nswitch (radeon_encoder->encoder_id) {\r\ncase ENCODER_OBJECT_ID_INTERNAL_LVDS:\r\nencoder->possible_crtcs = 0x1;\r\ndrm_encoder_init(dev, encoder, &radeon_legacy_lvds_enc_funcs, DRM_MODE_ENCODER_LVDS);\r\ndrm_encoder_helper_add(encoder, &radeon_legacy_lvds_helper_funcs);\r\nif (rdev->is_atom_bios)\r\nradeon_encoder->enc_priv = radeon_atombios_get_lvds_info(radeon_encoder);\r\nelse\r\nradeon_encoder->enc_priv = radeon_combios_get_lvds_info(radeon_encoder);\r\nradeon_encoder->rmx_type = RMX_FULL;\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_TMDS1:\r\ndrm_encoder_init(dev, encoder, &radeon_legacy_tmds_int_enc_funcs, DRM_MODE_ENCODER_TMDS);\r\ndrm_encoder_helper_add(encoder, &radeon_legacy_tmds_int_helper_funcs);\r\nradeon_encoder->enc_priv = radeon_legacy_get_tmds_info(radeon_encoder);\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_DAC1:\r\ndrm_encoder_init(dev, encoder, &radeon_legacy_primary_dac_enc_funcs, DRM_MODE_ENCODER_DAC);\r\ndrm_encoder_helper_add(encoder, &radeon_legacy_primary_dac_helper_funcs);\r\nif (rdev->is_atom_bios)\r\nradeon_encoder->enc_priv = radeon_atombios_get_primary_dac_info(radeon_encoder);\r\nelse\r\nradeon_encoder->enc_priv = radeon_combios_get_primary_dac_info(radeon_encoder);\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_DAC2:\r\ndrm_encoder_init(dev, encoder, &radeon_legacy_tv_dac_enc_funcs, DRM_MODE_ENCODER_TVDAC);\r\ndrm_encoder_helper_add(encoder, &radeon_legacy_tv_dac_helper_funcs);\r\nif (rdev->is_atom_bios)\r\nradeon_encoder->enc_priv = radeon_atombios_get_tv_dac_info(radeon_encoder);\r\nelse\r\nradeon_encoder->enc_priv = radeon_combios_get_tv_dac_info(radeon_encoder);\r\nbreak;\r\ncase ENCODER_OBJECT_ID_INTERNAL_DVO1:\r\ndrm_encoder_init(dev, encoder, &radeon_legacy_tmds_ext_enc_funcs, DRM_MODE_ENCODER_TMDS);\r\ndrm_encoder_helper_add(encoder, &radeon_legacy_tmds_ext_helper_funcs);\r\nif (!rdev->is_atom_bios)\r\nradeon_encoder->enc_priv = radeon_legacy_get_ext_tmds_info(radeon_encoder);\r\nbreak;\r\n}\r\n}

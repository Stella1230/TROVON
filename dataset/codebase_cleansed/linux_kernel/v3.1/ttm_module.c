static void ttm_drm_class_device_release(struct device *dev)\r\n{\r\natomic_set(&device_released, 1);\r\nwake_up_all(&exit_q);\r\n}\r\nstruct kobject *ttm_get_kobj(void)\r\n{\r\nstruct kobject *kobj = &ttm_drm_class_device.kobj;\r\nBUG_ON(kobj == NULL);\r\nreturn kobj;\r\n}\r\nstatic int __init ttm_init(void)\r\n{\r\nint ret;\r\nret = dev_set_name(&ttm_drm_class_device, "ttm");\r\nif (unlikely(ret != 0))\r\nreturn ret;\r\natomic_set(&device_released, 0);\r\nret = drm_class_device_register(&ttm_drm_class_device);\r\nif (unlikely(ret != 0))\r\ngoto out_no_dev_reg;\r\nreturn 0;\r\nout_no_dev_reg:\r\natomic_set(&device_released, 1);\r\nwake_up_all(&exit_q);\r\nreturn ret;\r\n}\r\nstatic void __exit ttm_exit(void)\r\n{\r\ndrm_class_device_unregister(&ttm_drm_class_device);\r\nwait_event(exit_q, atomic_read(&device_released) == 1);\r\n}

static int assabet_pcmcia_hw_init(struct soc_pcmcia_socket *skt)\r\n{\r\nskt->socket.pci_irq = ASSABET_IRQ_GPIO_CF_IRQ;\r\nreturn soc_pcmcia_request_irqs(skt, irqs, ARRAY_SIZE(irqs));\r\n}\r\nstatic void assabet_pcmcia_hw_shutdown(struct soc_pcmcia_socket *skt)\r\n{\r\nsoc_pcmcia_free_irqs(skt, irqs, ARRAY_SIZE(irqs));\r\n}\r\nstatic void\r\nassabet_pcmcia_socket_state(struct soc_pcmcia_socket *skt, struct pcmcia_state *state)\r\n{\r\nunsigned long levels = GPLR;\r\nstate->detect = (levels & ASSABET_GPIO_CF_CD) ? 0 : 1;\r\nstate->ready = (levels & ASSABET_GPIO_CF_IRQ) ? 1 : 0;\r\nstate->bvd1 = (levels & ASSABET_GPIO_CF_BVD1) ? 1 : 0;\r\nstate->bvd2 = (levels & ASSABET_GPIO_CF_BVD2) ? 1 : 0;\r\nstate->wrprot = 0;\r\nstate->vs_3v = 1;\r\nstate->vs_Xv = 0;\r\n}\r\nstatic int\r\nassabet_pcmcia_configure_socket(struct soc_pcmcia_socket *skt, const socket_state_t *state)\r\n{\r\nunsigned int mask;\r\nswitch (state->Vcc) {\r\ncase 0:\r\nmask = 0;\r\nbreak;\r\ncase 50:\r\nprintk(KERN_WARNING "%s(): CS asked for 5V, applying 3.3V...\n",\r\n__func__);\r\ncase 33:\r\nmask = ASSABET_BCR_CF_PWR;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "%s(): unrecognized Vcc %u\n", __func__,\r\nstate->Vcc);\r\nreturn -1;\r\n}\r\nif (state->flags & SS_RESET)\r\nmask |= ASSABET_BCR_CF_RST;\r\nASSABET_BCR_frob(ASSABET_BCR_CF_RST | ASSABET_BCR_CF_PWR, mask);\r\nreturn 0;\r\n}\r\nstatic void assabet_pcmcia_socket_init(struct soc_pcmcia_socket *skt)\r\n{\r\nASSABET_BCR_clear(ASSABET_BCR_CF_BUS_OFF);\r\nsoc_pcmcia_enable_irqs(skt, irqs, ARRAY_SIZE(irqs));\r\n}\r\nstatic void assabet_pcmcia_socket_suspend(struct soc_pcmcia_socket *skt)\r\n{\r\nsoc_pcmcia_disable_irqs(skt, irqs, ARRAY_SIZE(irqs));\r\nASSABET_BCR_set(ASSABET_BCR_CF_BUS_OFF | ASSABET_BCR_CF_RST);\r\n}\r\nint __devinit pcmcia_assabet_init(struct device *dev)\r\n{\r\nint ret = -ENODEV;\r\nif (machine_is_assabet() && !machine_has_neponset())\r\nret = sa11xx_drv_pcmcia_probe(dev, &assabet_pcmcia_ops, 1, 1);\r\nreturn ret;\r\n}

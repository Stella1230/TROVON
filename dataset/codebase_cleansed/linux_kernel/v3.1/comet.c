static int\r\nlbo_tbl_lkup (int t1, int lbo)\r\n{\r\nif ((lbo < CFG_LBO_LH0) || (lbo > CFG_LBO_E120))\r\n{\r\nif (t1)\r\nlbo = CFG_LBO_LH0;\r\nelse\r\nlbo = CFG_LBO_E120;\r\n}\r\nreturn (lbo - 1);\r\n}\r\nvoid\r\ninit_comet (void *ci, comet_t * comet, u_int32_t port_mode, int clockmaster,\r\nu_int8_t moreParams)\r\n{\r\nu_int8_t isT1mode;\r\nu_int8_t tix = CFG_LBO_LH0;\r\nisT1mode = IS_FRAME_ANY_T1 (port_mode);\r\nif (isT1mode)\r\n{\r\npci_write_32 ((u_int32_t *) &comet->gbl_cfg, 0xa0);\r\ntix = lbo_tbl_lkup (isT1mode, CFG_LBO_LH0);\r\n} else\r\n{\r\npci_write_32 ((u_int32_t *) &comet->gbl_cfg, 0x81);\r\ntix = lbo_tbl_lkup (isT1mode, CFG_LBO_E120);\r\n}\r\nif (moreParams & CFG_LBO_MASK)\r\ntix = lbo_tbl_lkup (isT1mode, moreParams & CFG_LBO_MASK);\r\npci_write_32 ((u_int32_t *) &comet->tx_line_cfg, 0x00);\r\npci_write_32 ((u_int32_t *) &comet->mtest, 0x00);\r\npci_write_32 ((u_int32_t *) &comet->rjat_cfg, 0x10);\r\nif (isT1mode)\r\n{\r\npci_write_32 ((u_int32_t *) &comet->rjat_n1clk, 0x2F);\r\npci_write_32 ((u_int32_t *) &comet->rjat_n2clk, 0x2F);\r\n} else\r\n{\r\npci_write_32 ((u_int32_t *) &comet->rjat_n1clk, 0xFF);\r\npci_write_32 ((u_int32_t *) &comet->rjat_n2clk, 0xFF);\r\n}\r\npci_write_32 ((u_int32_t *) &comet->tjat_cfg, 0x10);\r\npci_write_32 ((u_int32_t *) &comet->rx_opt, 0x00);\r\nif (isT1mode)\r\n{\r\npci_write_32 ((u_int32_t *) &comet->tjat_n1clk, 0x2F);\r\npci_write_32 ((u_int32_t *) &comet->tjat_n2clk, 0x2F);\r\n} else\r\n{\r\npci_write_32 ((u_int32_t *) &comet->tjat_n1clk, 0xFF);\r\npci_write_32 ((u_int32_t *) &comet->tjat_n2clk, 0xFF);\r\n}\r\nif (isT1mode)\r\n{\r\npci_write_32 ((u_int32_t *) &comet->rx_elst_cfg, 0x00);\r\npci_write_32 ((u_int32_t *) &comet->tx_elst_cfg, 0x00);\r\n} else\r\n{\r\npci_write_32 ((u_int32_t *) &comet->rx_elst_cfg, 0x03);\r\npci_write_32 ((u_int32_t *) &comet->tx_elst_cfg, 0x03);\r\npci_write_32 ((u_int32_t *) &comet->rxce1_ctl, 0x00);\r\npci_write_32 ((u_int32_t *) &comet->txci1_ctl, 0x00);\r\n}\r\npci_write_32 ((u_int32_t *) &comet->t1_rboc_ena, 0x00);\r\nif (isT1mode)\r\n{\r\npci_write_32 ((u_int32_t *) &comet->ibcd_cfg, 0x04);\r\npci_write_32 ((u_int32_t *) &comet->ibcd_act, 0x08);\r\npci_write_32 ((u_int32_t *) &comet->ibcd_deact, 0x24);\r\n}\r\nswitch (port_mode)\r\n{\r\ncase CFG_FRAME_SF:\r\npci_write_32 ((u_int32_t *) &comet->cdrc_cfg, 0);\r\npci_write_32 ((u_int32_t *) &comet->t1_frmr_cfg, 0);\r\npci_write_32 ((u_int32_t *) &comet->sigx_cfg, 0);\r\npci_write_32 ((u_int32_t *) &comet->t1_xbas_cfg, 0x20);\r\npci_write_32 ((u_int32_t *) &comet->t1_almi_cfg, 0);\r\nbreak;\r\ncase CFG_FRAME_ESF:\r\npci_write_32 ((u_int32_t *) &comet->cdrc_cfg, 0);\r\npci_write_32 ((u_int32_t *) &comet->rxce1_ctl, 0x20);\r\npci_write_32 ((u_int32_t *) &comet->txci1_ctl, 0x20);\r\npci_write_32 ((u_int32_t *) &comet->t1_frmr_cfg, 0x30);\r\npci_write_32 ((u_int32_t *) &comet->sigx_cfg, 0x04);\r\npci_write_32 ((u_int32_t *) &comet->t1_xbas_cfg, 0x30);\r\npci_write_32 ((u_int32_t *) &comet->t1_almi_cfg, 0x10);\r\nbreak;\r\ncase CFG_FRAME_E1PLAIN:\r\npci_write_32 ((u_int32_t *) &comet->cdrc_cfg, 0);\r\npci_write_32 ((u_int32_t *) &comet->sigx_cfg, 0);\r\npci_write_32 ((u_int32_t *) &comet->e1_tran_cfg, 0);\r\npci_write_32 ((u_int32_t *) &comet->e1_frmr_aopts, 0x40);\r\nbreak;\r\ncase CFG_FRAME_E1CAS:\r\npci_write_32 ((u_int32_t *) &comet->cdrc_cfg, 0);\r\npci_write_32 ((u_int32_t *) &comet->sigx_cfg, 0);\r\npci_write_32 ((u_int32_t *) &comet->e1_tran_cfg, 0x60);\r\npci_write_32 ((u_int32_t *) &comet->e1_frmr_aopts, 0);\r\nbreak;\r\ncase CFG_FRAME_E1CRC:\r\npci_write_32 ((u_int32_t *) &comet->cdrc_cfg, 0);\r\npci_write_32 ((u_int32_t *) &comet->sigx_cfg, 0);\r\npci_write_32 ((u_int32_t *) &comet->e1_tran_cfg, 0x10);\r\npci_write_32 ((u_int32_t *) &comet->e1_frmr_aopts, 0xc2);\r\nbreak;\r\ncase CFG_FRAME_E1CRC_CAS:\r\npci_write_32 ((u_int32_t *) &comet->cdrc_cfg, 0);\r\npci_write_32 ((u_int32_t *) &comet->sigx_cfg, 0);\r\npci_write_32 ((u_int32_t *) &comet->e1_tran_cfg, 0x70);\r\npci_write_32 ((u_int32_t *) &comet->e1_frmr_aopts, 0x82);\r\nbreak;\r\ncase CFG_FRAME_SF_AMI:\r\npci_write_32 ((u_int32_t *) &comet->cdrc_cfg, 0x80);\r\npci_write_32 ((u_int32_t *) &comet->t1_frmr_cfg, 0);\r\npci_write_32 ((u_int32_t *) &comet->t1_xbas_cfg, 0);\r\npci_write_32 ((u_int32_t *) &comet->t1_almi_cfg, 0);\r\npci_write_32 ((u_int32_t *) &comet->sigx_cfg, 0);\r\nbreak;\r\ncase CFG_FRAME_ESF_AMI:\r\npci_write_32 ((u_int32_t *) &comet->cdrc_cfg, 0x80);\r\npci_write_32 ((u_int32_t *) &comet->rxce1_ctl, 0x20);\r\npci_write_32 ((u_int32_t *) &comet->txci1_ctl, 0x20);\r\npci_write_32 ((u_int32_t *) &comet->t1_frmr_cfg, 0x30);\r\npci_write_32 ((u_int32_t *) &comet->sigx_cfg, 0x04);\r\npci_write_32 ((u_int32_t *) &comet->t1_xbas_cfg, 0x10);\r\npci_write_32 ((u_int32_t *) &comet->t1_almi_cfg, 0x10);\r\nbreak;\r\ncase CFG_FRAME_E1PLAIN_AMI:\r\npci_write_32 ((u_int32_t *) &comet->cdrc_cfg, 0x80);\r\npci_write_32 ((u_int32_t *) &comet->sigx_cfg, 0);\r\npci_write_32 ((u_int32_t *) &comet->e1_tran_cfg, 0x80);\r\npci_write_32 ((u_int32_t *) &comet->e1_frmr_aopts, 0x40);\r\nbreak;\r\ncase CFG_FRAME_E1CAS_AMI:\r\npci_write_32 ((u_int32_t *) &comet->cdrc_cfg, 0x80);\r\npci_write_32 ((u_int32_t *) &comet->sigx_cfg, 0);\r\npci_write_32 ((u_int32_t *) &comet->e1_tran_cfg, 0xe0);\r\npci_write_32 ((u_int32_t *) &comet->e1_frmr_aopts, 0);\r\nbreak;\r\ncase CFG_FRAME_E1CRC_AMI:\r\npci_write_32 ((u_int32_t *) &comet->cdrc_cfg, 0x80);\r\npci_write_32 ((u_int32_t *) &comet->sigx_cfg, 0);\r\npci_write_32 ((u_int32_t *) &comet->e1_tran_cfg, 0x90);\r\npci_write_32 ((u_int32_t *) &comet->e1_frmr_aopts, 0xc2);\r\nbreak;\r\ncase CFG_FRAME_E1CRC_CAS_AMI:\r\npci_write_32 ((u_int32_t *) &comet->cdrc_cfg, 0x80);\r\npci_write_32 ((u_int32_t *) &comet->sigx_cfg, 0);\r\npci_write_32 ((u_int32_t *) &comet->e1_tran_cfg, 0xf0);\r\npci_write_32 ((u_int32_t *) &comet->e1_frmr_aopts, 0x82);\r\nbreak;\r\n}\r\nif (clockmaster)\r\n{\r\nif (isT1mode)\r\npci_write_32 ((u_int32_t *) &comet->brif_cfg, 0x00);\r\nelse\r\npci_write_32 ((u_int32_t *) &comet->brif_cfg, 0x01);\r\npci_write_32 ((u_int32_t *) &comet->brif_fpcfg, 0x00);\r\nif ((moreParams & CFG_CLK_PORT_MASK) == CFG_CLK_PORT_INTERNAL)\r\n{\r\nif (cxt1e1_log_level >= LOG_SBEBUG12)\r\npr_info(">> %s: clockmaster internal clock\n", __func__);\r\npci_write_32 ((u_int32_t *) &comet->tx_time, 0x0d);\r\n} else\r\n{\r\nif (cxt1e1_log_level >= LOG_SBEBUG12)\r\npr_info(">> %s: clockmaster external clock\n", __func__);\r\npci_write_32 ((u_int32_t *) &comet->tx_time, 0x09);\r\n}\r\n} else\r\n{\r\nif (isT1mode)\r\npci_write_32 ((u_int32_t *) &comet->brif_cfg, 0x20);\r\nelse\r\npci_write_32 ((u_int32_t *) &comet->brif_cfg, 0x21);\r\npci_write_32 ((u_int32_t *) &comet->brif_fpcfg, 0x20);\r\nif (cxt1e1_log_level >= LOG_SBEBUG12)\r\npr_info(">> %s: clockslave internal clock\n", __func__);\r\npci_write_32 ((u_int32_t *) &comet->tx_time, 0x0d);\r\n}\r\npci_write_32 ((u_int32_t *) &comet->brif_pfcfg, 0x01);\r\nif (isT1mode)\r\npci_write_32 ((u_int32_t *) &comet->rlps_eqvr, 0x2c);\r\nelse\r\npci_write_32 ((u_int32_t *) &comet->rlps_eqvr, 0x34);\r\npci_write_32 ((u_int32_t *) &comet->rlps_cfgsts, 0x11);\r\nif (isT1mode)\r\npci_write_32 ((u_int32_t *) &comet->rlps_alos_thresh, 0x55);\r\nelse\r\npci_write_32 ((u_int32_t *) &comet->rlps_alos_thresh, 0x22);\r\nif (isT1mode)\r\npci_write_32 ((u_int32_t *) &comet->btif_cfg, 0x38);\r\nelse\r\npci_write_32 ((u_int32_t *) &comet->btif_cfg, 0x39);\r\npci_write_32 ((u_int32_t *) &comet->btif_fpcfg, 0x01);\r\npci_write_32 ((u_int32_t *) &comet->mdiag, 0x00);\r\nWrtXmtWaveformTbl (ci, comet, TWV_table[tix]);\r\nif (isT1mode)\r\nWrtRcvEqualizerTbl ((ci_t *) ci, comet, &T1_Equalizer[0]);\r\nelse\r\nWrtRcvEqualizerTbl ((ci_t *) ci, comet, &E1_Equalizer[0]);\r\nSetPwrLevel (comet);\r\n}\r\nSTATIC void\r\nWrtXmtWaveform (ci_t * ci, comet_t * comet, u_int32_t sample, u_int32_t unit, u_int8_t data)\r\n{\r\nu_int8_t WaveformAddr;\r\nWaveformAddr = (sample << 3) + (unit & 7);\r\npci_write_32 ((u_int32_t *) &comet->xlpg_pwave_addr, WaveformAddr);\r\npci_flush_write (ci);\r\npci_write_32 ((u_int32_t *) &comet->xlpg_pwave_data, 0x7F & data);\r\n}\r\nSTATIC void\r\nWrtXmtWaveformTbl (ci_t * ci, comet_t * comet,\r\nu_int8_t table[COMET_NUM_SAMPLES][COMET_NUM_UNITS])\r\n{\r\nu_int32_t sample, unit;\r\nfor (sample = 0; sample < COMET_NUM_SAMPLES; sample++)\r\n{\r\nfor (unit = 0; unit < COMET_NUM_UNITS; unit++)\r\nWrtXmtWaveform (ci, comet, sample, unit, table[sample][unit]);\r\n}\r\npci_write_32 ((u_int32_t *) &comet->xlpg_cfg, table[COMET_NUM_SAMPLES][0]);\r\n}\r\nSTATIC void\r\nWrtRcvEqualizerTbl (ci_t * ci, comet_t * comet, u_int32_t *table)\r\n{\r\nu_int32_t ramaddr;\r\nvolatile u_int32_t value;\r\nfor (ramaddr = 0; ramaddr < 256; ramaddr++)\r\n{\r\n{\r\npci_write_32 ((u_int32_t *) &comet->rlps_eq_rwsel, 0x80);\r\npci_flush_write (ci);\r\npci_write_32 ((u_int32_t *) &comet->rlps_eq_iaddr, (u_int8_t) ramaddr);\r\npci_flush_write (ci);\r\nOS_uwait (4, "wret");\r\n}\r\nvalue = *table++;\r\npci_write_32 ((u_int32_t *) &comet->rlps_idata3, (u_int8_t) (value >> 24));\r\npci_write_32 ((u_int32_t *) &comet->rlps_idata2, (u_int8_t) (value >> 16));\r\npci_write_32 ((u_int32_t *) &comet->rlps_idata1, (u_int8_t) (value >> 8));\r\npci_write_32 ((u_int32_t *) &comet->rlps_idata0, (u_int8_t) value);\r\npci_flush_write (ci);\r\npci_write_32 ((u_int32_t *) &comet->rlps_eq_rwsel, 0);\r\npci_flush_write (ci);\r\npci_write_32 ((u_int32_t *) &comet->rlps_eq_iaddr, (u_int8_t) ramaddr);\r\npci_flush_write (ci);\r\nOS_uwait (4, "wret");\r\n}\r\npci_write_32 ((u_int32_t *) &comet->rlps_eq_cfg, 0xCB);\r\n}\r\nSTATIC void\r\nSetPwrLevel (comet_t * comet)\r\n{\r\nvolatile u_int32_t temp;\r\npci_write_32 ((u_int32_t *) &comet->xlpg_fdata_sel, 0x00);\r\npci_write_32 ((u_int32_t *) &comet->xlpg_atest_pctl, 0x01);\r\npci_write_32 ((u_int32_t *) &comet->xlpg_atest_pctl, 0x01);\r\ntemp = pci_read_32 ((u_int32_t *) &comet->xlpg_atest_pctl) & 0xfe;\r\npci_write_32 ((u_int32_t *) &comet->xlpg_atest_pctl, temp);\r\npci_write_32 ((u_int32_t *) &comet->xlpg_atest_nctl, 0x01);\r\npci_write_32 ((u_int32_t *) &comet->xlpg_atest_nctl, 0x01);\r\ntemp = pci_read_32 ((u_int32_t *) &comet->xlpg_atest_nctl) & 0xfe;\r\npci_write_32 ((u_int32_t *) &comet->xlpg_atest_nctl, temp);\r\npci_write_32 ((u_int32_t *) &comet->xlpg_fdata_sel, 0x01);\r\n}

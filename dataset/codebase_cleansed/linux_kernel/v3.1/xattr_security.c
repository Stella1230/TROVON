static size_t\r\next4_xattr_security_list(struct dentry *dentry, char *list, size_t list_size,\r\nconst char *name, size_t name_len, int type)\r\n{\r\nconst size_t prefix_len = sizeof(XATTR_SECURITY_PREFIX)-1;\r\nconst size_t total_len = prefix_len + name_len + 1;\r\nif (list && total_len <= list_size) {\r\nmemcpy(list, XATTR_SECURITY_PREFIX, prefix_len);\r\nmemcpy(list+prefix_len, name, name_len);\r\nlist[prefix_len + name_len] = '\0';\r\n}\r\nreturn total_len;\r\n}\r\nstatic int\r\next4_xattr_security_get(struct dentry *dentry, const char *name,\r\nvoid *buffer, size_t size, int type)\r\n{\r\nif (strcmp(name, "") == 0)\r\nreturn -EINVAL;\r\nreturn ext4_xattr_get(dentry->d_inode, EXT4_XATTR_INDEX_SECURITY,\r\nname, buffer, size);\r\n}\r\nstatic int\r\next4_xattr_security_set(struct dentry *dentry, const char *name,\r\nconst void *value, size_t size, int flags, int type)\r\n{\r\nif (strcmp(name, "") == 0)\r\nreturn -EINVAL;\r\nreturn ext4_xattr_set(dentry->d_inode, EXT4_XATTR_INDEX_SECURITY,\r\nname, value, size, flags);\r\n}\r\nint\r\next4_init_security(handle_t *handle, struct inode *inode, struct inode *dir,\r\nconst struct qstr *qstr)\r\n{\r\nint err;\r\nsize_t len;\r\nvoid *value;\r\nchar *name;\r\nerr = security_inode_init_security(inode, dir, qstr, &name, &value, &len);\r\nif (err) {\r\nif (err == -EOPNOTSUPP)\r\nreturn 0;\r\nreturn err;\r\n}\r\nerr = ext4_xattr_set_handle(handle, inode, EXT4_XATTR_INDEX_SECURITY,\r\nname, value, len, 0);\r\nkfree(name);\r\nkfree(value);\r\nreturn err;\r\n}

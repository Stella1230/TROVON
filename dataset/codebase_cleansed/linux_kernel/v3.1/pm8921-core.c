static int pm8921_readb(const struct device *dev, u16 addr, u8 *val)\r\n{\r\nconst struct pm8xxx_drvdata *pm8921_drvdata = dev_get_drvdata(dev);\r\nconst struct pm8921 *pmic = pm8921_drvdata->pm_chip_data;\r\nreturn msm_ssbi_read(pmic->dev->parent, addr, val, 1);\r\n}\r\nstatic int pm8921_writeb(const struct device *dev, u16 addr, u8 val)\r\n{\r\nconst struct pm8xxx_drvdata *pm8921_drvdata = dev_get_drvdata(dev);\r\nconst struct pm8921 *pmic = pm8921_drvdata->pm_chip_data;\r\nreturn msm_ssbi_write(pmic->dev->parent, addr, &val, 1);\r\n}\r\nstatic int pm8921_read_buf(const struct device *dev, u16 addr, u8 *buf,\r\nint cnt)\r\n{\r\nconst struct pm8xxx_drvdata *pm8921_drvdata = dev_get_drvdata(dev);\r\nconst struct pm8921 *pmic = pm8921_drvdata->pm_chip_data;\r\nreturn msm_ssbi_read(pmic->dev->parent, addr, buf, cnt);\r\n}\r\nstatic int pm8921_write_buf(const struct device *dev, u16 addr, u8 *buf,\r\nint cnt)\r\n{\r\nconst struct pm8xxx_drvdata *pm8921_drvdata = dev_get_drvdata(dev);\r\nconst struct pm8921 *pmic = pm8921_drvdata->pm_chip_data;\r\nreturn msm_ssbi_write(pmic->dev->parent, addr, buf, cnt);\r\n}\r\nstatic int pm8921_read_irq_stat(const struct device *dev, int irq)\r\n{\r\nconst struct pm8xxx_drvdata *pm8921_drvdata = dev_get_drvdata(dev);\r\nconst struct pm8921 *pmic = pm8921_drvdata->pm_chip_data;\r\nreturn pm8xxx_get_irq_stat(pmic->irq_chip, irq);\r\n}\r\nstatic int __devinit pm8921_add_subdevices(const struct pm8921_platform_data\r\n*pdata,\r\nstruct pm8921 *pmic,\r\nu32 rev)\r\n{\r\nint ret = 0, irq_base = 0;\r\nstruct pm_irq_chip *irq_chip;\r\nif (pdata->irq_pdata) {\r\npdata->irq_pdata->irq_cdata.nirqs = PM8921_NR_IRQS;\r\npdata->irq_pdata->irq_cdata.rev = rev;\r\nirq_base = pdata->irq_pdata->irq_base;\r\nirq_chip = pm8xxx_irq_init(pmic->dev, pdata->irq_pdata);\r\nif (IS_ERR(irq_chip)) {\r\npr_err("Failed to init interrupts ret=%ld\n",\r\nPTR_ERR(irq_chip));\r\nreturn PTR_ERR(irq_chip);\r\n}\r\npmic->irq_chip = irq_chip;\r\n}\r\nreturn ret;\r\n}\r\nstatic int __devinit pm8921_probe(struct platform_device *pdev)\r\n{\r\nconst struct pm8921_platform_data *pdata = pdev->dev.platform_data;\r\nstruct pm8921 *pmic;\r\nint rc;\r\nu8 val;\r\nu32 rev;\r\nif (!pdata) {\r\npr_err("missing platform data\n");\r\nreturn -EINVAL;\r\n}\r\npmic = kzalloc(sizeof(struct pm8921), GFP_KERNEL);\r\nif (!pmic) {\r\npr_err("Cannot alloc pm8921 struct\n");\r\nreturn -ENOMEM;\r\n}\r\nrc = msm_ssbi_read(pdev->dev.parent, REG_HWREV, &val, sizeof(val));\r\nif (rc) {\r\npr_err("Failed to read hw rev reg %d:rc=%d\n", REG_HWREV, rc);\r\ngoto err_read_rev;\r\n}\r\npr_info("PMIC revision 1: %02X\n", val);\r\nrev = val;\r\nrc = msm_ssbi_read(pdev->dev.parent, REG_HWREV_2, &val, sizeof(val));\r\nif (rc) {\r\npr_err("Failed to read hw rev 2 reg %d:rc=%d\n",\r\nREG_HWREV_2, rc);\r\ngoto err_read_rev;\r\n}\r\npr_info("PMIC revision 2: %02X\n", val);\r\nrev |= val << BITS_PER_BYTE;\r\npmic->dev = &pdev->dev;\r\npm8921_drvdata.pm_chip_data = pmic;\r\nplatform_set_drvdata(pdev, &pm8921_drvdata);\r\nrc = pm8921_add_subdevices(pdata, pmic, rev);\r\nif (rc) {\r\npr_err("Cannot add subdevices rc=%d\n", rc);\r\ngoto err;\r\n}\r\nWARN_ON(pmic->irq_chip == NULL);\r\nreturn 0;\r\nerr:\r\nmfd_remove_devices(pmic->dev);\r\nplatform_set_drvdata(pdev, NULL);\r\nerr_read_rev:\r\nkfree(pmic);\r\nreturn rc;\r\n}\r\nstatic int __devexit pm8921_remove(struct platform_device *pdev)\r\n{\r\nstruct pm8xxx_drvdata *drvdata;\r\nstruct pm8921 *pmic = NULL;\r\ndrvdata = platform_get_drvdata(pdev);\r\nif (drvdata)\r\npmic = drvdata->pm_chip_data;\r\nif (pmic)\r\nmfd_remove_devices(pmic->dev);\r\nif (pmic->irq_chip) {\r\npm8xxx_irq_exit(pmic->irq_chip);\r\npmic->irq_chip = NULL;\r\n}\r\nplatform_set_drvdata(pdev, NULL);\r\nkfree(pmic);\r\nreturn 0;\r\n}\r\nstatic int __init pm8921_init(void)\r\n{\r\nreturn platform_driver_register(&pm8921_driver);\r\n}\r\nstatic void __exit pm8921_exit(void)\r\n{\r\nplatform_driver_unregister(&pm8921_driver);\r\n}

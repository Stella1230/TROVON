static struct max63xx_timeout *\r\nmax63xx_select_timeout(struct max63xx_timeout *table, int value)\r\n{\r\nwhile (table->twd) {\r\nif (value <= table->twd) {\r\nif (nodelay && table->tdelay == 0)\r\nreturn table;\r\nif (!nodelay)\r\nreturn table;\r\n}\r\ntable++;\r\n}\r\nreturn NULL;\r\n}\r\nstatic void max63xx_wdt_ping(void)\r\n{\r\nu8 val;\r\nspin_lock(&io_lock);\r\nval = __raw_readb(wdt_base);\r\n__raw_writeb(val | MAX6369_WDI, wdt_base);\r\n__raw_writeb(val & ~MAX6369_WDI, wdt_base);\r\nspin_unlock(&io_lock);\r\n}\r\nstatic void max63xx_wdt_enable(struct max63xx_timeout *entry)\r\n{\r\nu8 val;\r\nif (test_and_set_bit(WDT_RUNNING, &wdt_status))\r\nreturn;\r\nspin_lock(&io_lock);\r\nval = __raw_readb(wdt_base);\r\nval &= ~MAX6369_WDSET;\r\nval |= entry->wdset;\r\n__raw_writeb(val, wdt_base);\r\nspin_unlock(&io_lock);\r\nif (entry->tdelay == 0)\r\nmax63xx_wdt_ping();\r\n}\r\nstatic void max63xx_wdt_disable(void)\r\n{\r\nu8 val;\r\nspin_lock(&io_lock);\r\nval = __raw_readb(wdt_base);\r\nval &= ~MAX6369_WDSET;\r\nval |= 3;\r\n__raw_writeb(val, wdt_base);\r\nspin_unlock(&io_lock);\r\nclear_bit(WDT_RUNNING, &wdt_status);\r\n}\r\nstatic int max63xx_wdt_open(struct inode *inode, struct file *file)\r\n{\r\nif (test_and_set_bit(WDT_IN_USE, &wdt_status))\r\nreturn -EBUSY;\r\nmax63xx_wdt_enable(current_timeout);\r\nclear_bit(WDT_OK_TO_CLOSE, &wdt_status);\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic ssize_t max63xx_wdt_write(struct file *file, const char *data,\r\nsize_t len, loff_t *ppos)\r\n{\r\nif (len) {\r\nif (!nowayout) {\r\nsize_t i;\r\nclear_bit(WDT_OK_TO_CLOSE, &wdt_status);\r\nfor (i = 0; i != len; i++) {\r\nchar c;\r\nif (get_user(c, data + i))\r\nreturn -EFAULT;\r\nif (c == 'V')\r\nset_bit(WDT_OK_TO_CLOSE, &wdt_status);\r\n}\r\n}\r\nmax63xx_wdt_ping();\r\n}\r\nreturn len;\r\n}\r\nstatic long max63xx_wdt_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nint ret = -ENOTTY;\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nret = copy_to_user((struct watchdog_info *)arg, &ident,\r\nsizeof(ident)) ? -EFAULT : 0;\r\nbreak;\r\ncase WDIOC_GETSTATUS:\r\ncase WDIOC_GETBOOTSTATUS:\r\nret = put_user(0, (int *)arg);\r\nbreak;\r\ncase WDIOC_KEEPALIVE:\r\nmax63xx_wdt_ping();\r\nret = 0;\r\nbreak;\r\ncase WDIOC_GETTIMEOUT:\r\nret = put_user(heartbeat, (int *)arg);\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int max63xx_wdt_release(struct inode *inode, struct file *file)\r\n{\r\nif (test_bit(WDT_OK_TO_CLOSE, &wdt_status))\r\nmax63xx_wdt_disable();\r\nelse\r\ndev_crit(&max63xx_pdev->dev,\r\n"device closed unexpectedly - timer will not stop\n");\r\nclear_bit(WDT_IN_USE, &wdt_status);\r\nclear_bit(WDT_OK_TO_CLOSE, &wdt_status);\r\nreturn 0;\r\n}\r\nstatic int __devinit max63xx_wdt_probe(struct platform_device *pdev)\r\n{\r\nint ret = 0;\r\nint size;\r\nstruct device *dev = &pdev->dev;\r\nstruct max63xx_timeout *table;\r\ntable = (struct max63xx_timeout *)pdev->id_entry->driver_data;\r\nif (heartbeat < 1 || heartbeat > MAX_HEARTBEAT)\r\nheartbeat = DEFAULT_HEARTBEAT;\r\ndev_info(dev, "requesting %ds heartbeat\n", heartbeat);\r\ncurrent_timeout = max63xx_select_timeout(table, heartbeat);\r\nif (!current_timeout) {\r\ndev_err(dev, "unable to satisfy heartbeat request\n");\r\nreturn -EINVAL;\r\n}\r\ndev_info(dev, "using %ds heartbeat with %ds initial delay\n",\r\ncurrent_timeout->twd, current_timeout->tdelay);\r\nheartbeat = current_timeout->twd;\r\nmax63xx_pdev = pdev;\r\nwdt_mem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (wdt_mem == NULL) {\r\ndev_err(dev, "failed to get memory region resource\n");\r\nreturn -ENOENT;\r\n}\r\nsize = resource_size(wdt_mem);\r\nif (!request_mem_region(wdt_mem->start, size, pdev->name)) {\r\ndev_err(dev, "failed to get memory region\n");\r\nreturn -ENOENT;\r\n}\r\nwdt_base = ioremap(wdt_mem->start, size);\r\nif (!wdt_base) {\r\ndev_err(dev, "failed to map memory region\n");\r\nret = -ENOMEM;\r\ngoto out_request;\r\n}\r\nret = misc_register(&max63xx_wdt_miscdev);\r\nif (ret < 0) {\r\ndev_err(dev, "cannot register misc device\n");\r\ngoto out_unmap;\r\n}\r\nreturn 0;\r\nout_unmap:\r\niounmap(wdt_base);\r\nout_request:\r\nrelease_mem_region(wdt_mem->start, size);\r\nwdt_mem = NULL;\r\nreturn ret;\r\n}\r\nstatic int __devexit max63xx_wdt_remove(struct platform_device *pdev)\r\n{\r\nmisc_deregister(&max63xx_wdt_miscdev);\r\nif (wdt_mem) {\r\nrelease_mem_region(wdt_mem->start, resource_size(wdt_mem));\r\nwdt_mem = NULL;\r\n}\r\nif (wdt_base)\r\niounmap(wdt_base);\r\nreturn 0;\r\n}\r\nstatic int __init max63xx_wdt_init(void)\r\n{\r\nreturn platform_driver_register(&max63xx_wdt_driver);\r\n}\r\nstatic void __exit max63xx_wdt_exit(void)\r\n{\r\nplatform_driver_unregister(&max63xx_wdt_driver);\r\n}

static void au1xxx_start_ehc(void)\r\n{\r\nau_writel(au_readl(USB_HOST_CONFIG) | USBH_ENABLE_CE, USB_HOST_CONFIG);\r\nau_sync();\r\nudelay(1000);\r\nau_writel(au_readl(USB_HOST_CONFIG) | USBH_ENABLE_INIT, USB_HOST_CONFIG);\r\nau_sync();\r\nudelay(1000);\r\n}\r\nstatic void au1xxx_stop_ehc(void)\r\n{\r\nunsigned long c;\r\nau_writel(au_readl(USB_HOST_CONFIG) & ~USBH_DISABLE, USB_HOST_CONFIG);\r\nau_sync();\r\nudelay(1000);\r\nc = au_readl(USB_HOST_CONFIG) & ~USB_MCFG_EHCCLKEN;\r\nif (!(c & USB_MCFG_UCECLKEN))\r\nc &= ~USB_MCFG_PHYPLLEN;\r\nau_writel(c, USB_HOST_CONFIG);\r\nau_sync();\r\n}\r\nstatic int au1xxx_ehci_setup(struct usb_hcd *hcd)\r\n{\r\nstruct ehci_hcd *ehci = hcd_to_ehci(hcd);\r\nint ret = ehci_init(hcd);\r\nehci->need_io_watchdog = 0;\r\nreturn ret;\r\n}\r\nstatic int ehci_hcd_au1xxx_drv_probe(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd;\r\nstruct ehci_hcd *ehci;\r\nstruct resource *res;\r\nint ret;\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\n#if defined(CONFIG_SOC_AU1200) && defined(CONFIG_DMA_COHERENT)\r\nif (!(read_c0_prid() & 0xff)) {\r\nprintk(KERN_INFO "%s: this is chip revision AB!\n", pdev->name);\r\nprintk(KERN_INFO "%s: update your board or re-configure"\r\n" the kernel\n", pdev->name);\r\nreturn -ENODEV;\r\n}\r\n#endif\r\nif (pdev->resource[1].flags != IORESOURCE_IRQ) {\r\npr_debug("resource[1] is not IORESOURCE_IRQ");\r\nreturn -ENOMEM;\r\n}\r\nhcd = usb_create_hcd(&ehci_au1xxx_hc_driver, &pdev->dev, "Au1xxx");\r\nif (!hcd)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nhcd->rsrc_start = res->start;\r\nhcd->rsrc_len = resource_size(res);\r\nif (!request_mem_region(hcd->rsrc_start, hcd->rsrc_len, hcd_name)) {\r\npr_debug("request_mem_region failed");\r\nret = -EBUSY;\r\ngoto err1;\r\n}\r\nhcd->regs = ioremap(hcd->rsrc_start, hcd->rsrc_len);\r\nif (!hcd->regs) {\r\npr_debug("ioremap failed");\r\nret = -ENOMEM;\r\ngoto err2;\r\n}\r\nau1xxx_start_ehc();\r\nehci = hcd_to_ehci(hcd);\r\nehci->caps = hcd->regs;\r\nehci->regs = hcd->regs +\r\nHC_LENGTH(ehci, readl(&ehci->caps->hc_capbase));\r\nehci->hcs_params = readl(&ehci->caps->hcs_params);\r\nret = usb_add_hcd(hcd, pdev->resource[1].start,\r\nIRQF_DISABLED | IRQF_SHARED);\r\nif (ret == 0) {\r\nplatform_set_drvdata(pdev, hcd);\r\nreturn ret;\r\n}\r\nau1xxx_stop_ehc();\r\niounmap(hcd->regs);\r\nerr2:\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nerr1:\r\nusb_put_hcd(hcd);\r\nreturn ret;\r\n}\r\nstatic int ehci_hcd_au1xxx_drv_remove(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nusb_remove_hcd(hcd);\r\niounmap(hcd->regs);\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nusb_put_hcd(hcd);\r\nau1xxx_stop_ehc();\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn 0;\r\n}\r\nstatic int ehci_hcd_au1xxx_drv_suspend(struct device *dev)\r\n{\r\nstruct usb_hcd *hcd = dev_get_drvdata(dev);\r\nstruct ehci_hcd *ehci = hcd_to_ehci(hcd);\r\nunsigned long flags;\r\nint rc = 0;\r\nif (time_before(jiffies, ehci->next_statechange))\r\nmsleep(10);\r\nehci_prepare_ports_for_controller_suspend(ehci, device_may_wakeup(dev));\r\nspin_lock_irqsave(&ehci->lock, flags);\r\nehci_writel(ehci, 0, &ehci->regs->intr_enable);\r\n(void)ehci_readl(ehci, &ehci->regs->intr_enable);\r\nclear_bit(HCD_FLAG_HW_ACCESSIBLE, &hcd->flags);\r\nspin_unlock_irqrestore(&ehci->lock, flags);\r\nau1xxx_stop_ehc();\r\nreturn rc;\r\n}\r\nstatic int ehci_hcd_au1xxx_drv_resume(struct device *dev)\r\n{\r\nstruct usb_hcd *hcd = dev_get_drvdata(dev);\r\nstruct ehci_hcd *ehci = hcd_to_ehci(hcd);\r\nau1xxx_start_ehc();\r\nif (time_before(jiffies, ehci->next_statechange))\r\nmsleep(100);\r\nset_bit(HCD_FLAG_HW_ACCESSIBLE, &hcd->flags);\r\nif (ehci_readl(ehci, &ehci->regs->configured_flag) == FLAG_CF) {\r\nint mask = INTR_MASK;\r\nehci_prepare_ports_for_controller_resume(ehci);\r\nif (!hcd->self.root_hub->do_remote_wakeup)\r\nmask &= ~STS_PCD;\r\nehci_writel(ehci, mask, &ehci->regs->intr_enable);\r\nehci_readl(ehci, &ehci->regs->intr_enable);\r\nreturn 0;\r\n}\r\nehci_dbg(ehci, "lost power, restarting\n");\r\nusb_root_hub_lost_power(hcd->self.root_hub);\r\n(void) ehci_halt(ehci);\r\n(void) ehci_reset(ehci);\r\nspin_lock_irq(&ehci->lock);\r\nif (ehci->reclaim)\r\nend_unlink_async(ehci);\r\nehci_work(ehci);\r\nspin_unlock_irq(&ehci->lock);\r\nehci_writel(ehci, ehci->command, &ehci->regs->command);\r\nehci_writel(ehci, FLAG_CF, &ehci->regs->configured_flag);\r\nehci_readl(ehci, &ehci->regs->command);\r\nehci_port_power(ehci, 1);\r\nhcd->state = HC_STATE_SUSPENDED;\r\nreturn 0;\r\n}

int i_APCI1710_InsnConfigInitTorCounter(struct comedi_device *dev,\r\nstruct comedi_subdevice *s, struct comedi_insn *insn, unsigned int *data)\r\n{\r\nint i_ReturnValue = 0;\r\nunsigned int ul_TimerValue = 0;\r\nunsigned int dw_Command;\r\ndouble d_RealTimingInterval = 0;\r\nunsigned char b_ModulNbr;\r\nunsigned char b_TorCounter;\r\nunsigned char b_PCIInputClock;\r\nunsigned char b_TimingUnit;\r\nunsigned int ul_TimingInterval;\r\nunsigned int ul_RealTimingInterval = 0;\r\ni_ReturnValue = insn->n;\r\nb_ModulNbr = (unsigned char) CR_AREF(insn->chanspec);\r\nb_TorCounter = (unsigned char) data[0];\r\nb_PCIInputClock = (unsigned char) data[1];\r\nb_TimingUnit = (unsigned char) data[2];\r\nul_TimingInterval = (unsigned int) data[3];\r\nprintk("INPUT clock %d\n", b_PCIInputClock);\r\nif (b_ModulNbr < 4) {\r\nif ((devpriv->s_BoardInfos.\r\ndw_MolduleConfiguration[b_ModulNbr] &\r\n0xFFFF0000UL) == APCI1710_TOR_COUNTER) {\r\nif (b_TorCounter <= 1) {\r\nif ((b_PCIInputClock == APCI1710_30MHZ) ||\r\n(b_PCIInputClock == APCI1710_33MHZ) ||\r\n(b_PCIInputClock == APCI1710_40MHZ) ||\r\n(b_PCIInputClock ==\r\nAPCI1710_GATE_INPUT)) {\r\nif ((b_TimingUnit <= 4)\r\n|| (b_PCIInputClock ==\r\nAPCI1710_GATE_INPUT)) {\r\nif (((b_PCIInputClock == APCI1710_30MHZ) && (b_TimingUnit == 0) && (ul_TimingInterval >= 133) && (ul_TimingInterval <= 0xFFFFFFFFUL)) || ((b_PCIInputClock == APCI1710_30MHZ) && (b_TimingUnit == 1) && (ul_TimingInterval >= 1) && (ul_TimingInterval <= 571230650UL)) || ((b_PCIInputClock == APCI1710_30MHZ) && (b_TimingUnit == 2) && (ul_TimingInterval >= 1) && (ul_TimingInterval <= 571230UL)) || ((b_PCIInputClock == APCI1710_30MHZ) && (b_TimingUnit == 3) && (ul_TimingInterval >= 1) && (ul_TimingInterval <= 571UL)) || ((b_PCIInputClock == APCI1710_30MHZ) && (b_TimingUnit == 4) && (ul_TimingInterval >= 1) && (ul_TimingInterval <= 9UL)) || ((b_PCIInputClock == APCI1710_33MHZ) && (b_TimingUnit == 0) && (ul_TimingInterval >= 121) && (ul_TimingInterval <= 0xFFFFFFFFUL)) || ((b_PCIInputClock == APCI1710_33MHZ) && (b_TimingUnit == 1) && (ul_TimingInterval >= 1) && (ul_TimingInterval <= 519691043UL)) || ((b_PCIInputClock == APCI1710_33MHZ) && (b_TimingUnit == 2) && (ul_TimingInterval >= 1) && (ul_TimingInterval <= 519691UL)) || ((b_PCIInputClock == APCI1710_33MHZ) && (b_TimingUnit == 3) && (ul_TimingInterval >= 1) && (ul_TimingInterval <= 520UL)) || ((b_PCIInputClock == APCI1710_33MHZ) && (b_TimingUnit == 4) && (ul_TimingInterval >= 1) && (ul_TimingInterval <= 8UL)) || ((b_PCIInputClock == APCI1710_40MHZ) && (b_TimingUnit == 0) && (ul_TimingInterval >= 100) && (ul_TimingInterval <= 0xFFFFFFFFUL)) || ((b_PCIInputClock == APCI1710_40MHZ) && (b_TimingUnit == 1) && (ul_TimingInterval >= 1) && (ul_TimingInterval <= 429496729UL)) || ((b_PCIInputClock == APCI1710_40MHZ) && (b_TimingUnit == 2) && (ul_TimingInterval >= 1) && (ul_TimingInterval <= 429496UL)) || ((b_PCIInputClock == APCI1710_40MHZ) && (b_TimingUnit == 3) && (ul_TimingInterval >= 1) && (ul_TimingInterval <= 429UL)) || ((b_PCIInputClock == APCI1710_40MHZ) && (b_TimingUnit == 4) && (ul_TimingInterval >= 1) && (ul_TimingInterval <= 7UL)) || ((b_PCIInputClock == APCI1710_GATE_INPUT) && (ul_TimingInterval >= 2))) {\r\nif (((b_PCIInputClock == APCI1710_40MHZ) && (devpriv->s_BoardInfos.b_BoardVersion > 0)) || (b_PCIInputClock != APCI1710_40MHZ)) {\r\nif (((b_PCIInputClock == APCI1710_40MHZ) && ((devpriv->s_BoardInfos.dw_MolduleConfiguration[b_ModulNbr] & 0xFFFF) >= 0x3131)) || ((b_PCIInputClock == APCI1710_GATE_INPUT) && ((devpriv->s_BoardInfos.dw_MolduleConfiguration[b_ModulNbr] & 0xFFFF) >= 0x3132)) || (b_PCIInputClock == APCI1710_30MHZ) || (b_PCIInputClock == APCI1710_33MHZ)) {\r\nif (b_PCIInputClock != APCI1710_GATE_INPUT) {\r\nfpu_begin\r\n();\r\nswitch (b_TimingUnit) {\r\ncase 0:\r\nul_TimerValue\r\n=\r\n(unsigned int)\r\n(ul_TimingInterval\r\n*\r\n(0.00025 * b_PCIInputClock));\r\nif ((double)((double)ul_TimingInterval * (0.00025 * (double)b_PCIInputClock)) >= ((double)((double)ul_TimerValue + 0.5))) {\r\nul_TimerValue\r\n=\r\nul_TimerValue\r\n+\r\n1;\r\n}\r\nul_RealTimingInterval\r\n=\r\n(unsigned int)\r\n(ul_TimerValue\r\n/\r\n(0.00025 * (double)b_PCIInputClock));\r\nd_RealTimingInterval\r\n=\r\n(double)\r\nul_TimerValue\r\n/\r\n(0.00025\r\n*\r\n(double)\r\nb_PCIInputClock);\r\nif ((double)((double)ul_TimerValue / (0.00025 * (double)b_PCIInputClock)) >= (double)((double)ul_RealTimingInterval + 0.5)) {\r\nul_RealTimingInterval\r\n=\r\nul_RealTimingInterval\r\n+\r\n1;\r\n}\r\nul_TimingInterval\r\n=\r\nul_TimingInterval\r\n-\r\n1;\r\nul_TimerValue\r\n=\r\nul_TimerValue\r\n-\r\n2;\r\nif (b_PCIInputClock != APCI1710_40MHZ) {\r\nul_TimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(double)\r\n(ul_TimerValue)\r\n*\r\n1.007752288);\r\n}\r\nbreak;\r\ncase 1:\r\nul_TimerValue\r\n=\r\n(unsigned int)\r\n(ul_TimingInterval\r\n*\r\n(0.25 * b_PCIInputClock));\r\nif ((double)((double)ul_TimingInterval * (0.25 * (double)b_PCIInputClock)) >= ((double)((double)ul_TimerValue + 0.5))) {\r\nul_TimerValue\r\n=\r\nul_TimerValue\r\n+\r\n1;\r\n}\r\nul_RealTimingInterval\r\n=\r\n(unsigned int)\r\n(ul_TimerValue\r\n/\r\n(0.25 * (double)b_PCIInputClock));\r\nd_RealTimingInterval\r\n=\r\n(double)\r\nul_TimerValue\r\n/\r\n(\r\n(double)\r\n0.25\r\n*\r\n(double)\r\nb_PCIInputClock);\r\nif ((double)((double)ul_TimerValue / (0.25 * (double)b_PCIInputClock)) >= (double)((double)ul_RealTimingInterval + 0.5)) {\r\nul_RealTimingInterval\r\n=\r\nul_RealTimingInterval\r\n+\r\n1;\r\n}\r\nul_TimingInterval\r\n=\r\nul_TimingInterval\r\n-\r\n1;\r\nul_TimerValue\r\n=\r\nul_TimerValue\r\n-\r\n2;\r\nif (b_PCIInputClock != APCI1710_40MHZ) {\r\nul_TimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(double)\r\n(ul_TimerValue)\r\n*\r\n1.007752288);\r\n}\r\nbreak;\r\ncase 2:\r\nul_TimerValue\r\n=\r\nul_TimingInterval\r\n*\r\n(250.0\r\n*\r\nb_PCIInputClock);\r\nif ((double)((double)ul_TimingInterval * (250.0 * (double)b_PCIInputClock)) >= ((double)((double)ul_TimerValue + 0.5))) {\r\nul_TimerValue\r\n=\r\nul_TimerValue\r\n+\r\n1;\r\n}\r\nul_RealTimingInterval\r\n=\r\n(unsigned int)\r\n(ul_TimerValue\r\n/\r\n(250.0 * (double)b_PCIInputClock));\r\nd_RealTimingInterval\r\n=\r\n(double)\r\nul_TimerValue\r\n/\r\n(250.0\r\n*\r\n(double)\r\nb_PCIInputClock);\r\nif ((double)((double)ul_TimerValue / (250.0 * (double)b_PCIInputClock)) >= (double)((double)ul_RealTimingInterval + 0.5)) {\r\nul_RealTimingInterval\r\n=\r\nul_RealTimingInterval\r\n+\r\n1;\r\n}\r\nul_TimingInterval\r\n=\r\nul_TimingInterval\r\n-\r\n1;\r\nul_TimerValue\r\n=\r\nul_TimerValue\r\n-\r\n2;\r\nif (b_PCIInputClock != APCI1710_40MHZ) {\r\nul_TimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(double)\r\n(ul_TimerValue)\r\n*\r\n1.007752288);\r\n}\r\nbreak;\r\ncase 3:\r\nul_TimerValue\r\n=\r\n(unsigned int)\r\n(ul_TimingInterval\r\n*\r\n(250000.0\r\n*\r\nb_PCIInputClock));\r\nif ((double)((double)ul_TimingInterval * (250000.0 * (double)b_PCIInputClock)) >= ((double)((double)ul_TimerValue + 0.5))) {\r\nul_TimerValue\r\n=\r\nul_TimerValue\r\n+\r\n1;\r\n}\r\nul_RealTimingInterval\r\n=\r\n(unsigned int)\r\n(ul_TimerValue\r\n/\r\n(250000.0\r\n*\r\n(double)\r\nb_PCIInputClock));\r\nd_RealTimingInterval\r\n=\r\n(double)\r\nul_TimerValue\r\n/\r\n(250000.0\r\n*\r\n(double)\r\nb_PCIInputClock);\r\nif ((double)((double)ul_TimerValue / (250000.0 * (double)b_PCIInputClock)) >= (double)((double)ul_RealTimingInterval + 0.5)) {\r\nul_RealTimingInterval\r\n=\r\nul_RealTimingInterval\r\n+\r\n1;\r\n}\r\nul_TimingInterval\r\n=\r\nul_TimingInterval\r\n-\r\n1;\r\nul_TimerValue\r\n=\r\nul_TimerValue\r\n-\r\n2;\r\nif (b_PCIInputClock != APCI1710_40MHZ) {\r\nul_TimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(double)\r\n(ul_TimerValue)\r\n*\r\n1.007752288);\r\n}\r\nbreak;\r\ncase 4:\r\nul_TimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(ul_TimingInterval\r\n*\r\n60)\r\n*\r\n(250000.0\r\n*\r\nb_PCIInputClock));\r\nif ((double)((double)(ul_TimingInterval * 60.0) * (250000.0 * (double)b_PCIInputClock)) >= ((double)((double)ul_TimerValue + 0.5))) {\r\nul_TimerValue\r\n=\r\nul_TimerValue\r\n+\r\n1;\r\n}\r\nul_RealTimingInterval\r\n=\r\n(unsigned int)\r\n(ul_TimerValue\r\n/\r\n(250000.0\r\n*\r\n(double)\r\nb_PCIInputClock))\r\n/\r\n60;\r\nd_RealTimingInterval\r\n=\r\n(\r\n(double)\r\nul_TimerValue\r\n/\r\n(250000.0\r\n*\r\n(double)\r\nb_PCIInputClock))\r\n/\r\n60.0;\r\nif ((double)(((double)ul_TimerValue / (250000.0 * (double)b_PCIInputClock)) / 60.0) >= (double)((double)ul_RealTimingInterval + 0.5)) {\r\nul_RealTimingInterval\r\n=\r\nul_RealTimingInterval\r\n+\r\n1;\r\n}\r\nul_TimingInterval\r\n=\r\nul_TimingInterval\r\n-\r\n1;\r\nul_TimerValue\r\n=\r\nul_TimerValue\r\n-\r\n2;\r\nif (b_PCIInputClock != APCI1710_40MHZ) {\r\nul_TimerValue\r\n=\r\n(unsigned int)\r\n(\r\n(double)\r\n(ul_TimerValue)\r\n*\r\n1.007752288);\r\n}\r\nbreak;\r\n}\r\nfpu_end();\r\n}\r\nelse {\r\nul_TimerValue\r\n=\r\nul_TimingInterval\r\n-\r\n2;\r\n}\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_TorCounterModuleInfo.\r\nb_PCIInputClock\r\n=\r\nb_PCIInputClock;\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_TorCounterModuleInfo.\r\ns_TorCounterInfo\r\n[b_TorCounter].\r\nb_TimingUnit\r\n=\r\nb_TimingUnit;\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_TorCounterModuleInfo.\r\ns_TorCounterInfo\r\n[b_TorCounter].\r\nd_TimingInterval\r\n=\r\nd_RealTimingInterval;\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_TorCounterModuleInfo.\r\ns_TorCounterInfo\r\n[b_TorCounter].\r\nul_RealTimingInterval\r\n=\r\nul_RealTimingInterval;\r\ndw_Command\r\n=\r\ninl\r\n(devpriv->\r\ns_BoardInfos.\r\nui_Address\r\n+\r\n4\r\n+\r\n(16 * b_TorCounter) + (64 * b_ModulNbr));\r\ndw_Command\r\n=\r\n(dw_Command\r\n>>\r\n4)\r\n&\r\n0xF;\r\nif (b_PCIInputClock == APCI1710_40MHZ) {\r\ndw_Command\r\n=\r\ndw_Command\r\n|\r\n0x10;\r\n}\r\nif (b_PCIInputClock == APCI1710_GATE_INPUT) {\r\ndw_Command\r\n=\r\ndw_Command\r\n|\r\n0x20;\r\n}\r\noutl(dw_Command, devpriv->s_BoardInfos.ui_Address + 4 + (16 * b_TorCounter) + (64 * b_ModulNbr));\r\noutl(0, devpriv->s_BoardInfos.ui_Address + 8 + (16 * b_TorCounter) + (64 * b_ModulNbr));\r\noutl(ul_TimerValue, devpriv->s_BoardInfos.ui_Address + 0 + (16 * b_TorCounter) + (64 * b_ModulNbr));\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_TorCounterModuleInfo.\r\ns_TorCounterInfo\r\n[b_TorCounter].\r\nb_TorCounterInit\r\n=\r\n1;\r\n} else {\r\nDPRINTK("TOR version error for 40MHz clock selection\n");\r\ni_ReturnValue\r\n=\r\n-9;\r\n}\r\n} else {\r\nDPRINTK("You can not used the 40MHz clock selection wich this board\n");\r\ni_ReturnValue =\r\n-8;\r\n}\r\n} else {\r\nDPRINTK("Base timing selection is wrong\n");\r\ni_ReturnValue = -7;\r\n}\r\n}\r\nelse {\r\nDPRINTK("Timing unit selection is wrong\n");\r\ni_ReturnValue = -6;\r\n}\r\n}\r\nelse {\r\nDPRINTK("The selected PCI input clock is wrong\n");\r\ni_ReturnValue = -5;\r\n}\r\n}\r\nelse {\r\nDPRINTK("Tor Counter selection is wrong\n");\r\ni_ReturnValue = -4;\r\n}\r\n} else {\r\nDPRINTK("The module is not a tor counter module\n");\r\ni_ReturnValue = -3;\r\n}\r\n} else {\r\nDPRINTK("Module number error\n");\r\ni_ReturnValue = -2;\r\n}\r\ndata[0] = (unsigned int) ul_RealTimingInterval;\r\nreturn i_ReturnValue;\r\n}\r\nint i_APCI1710_InsnWriteEnableDisableTorCounter(struct comedi_device *dev,\r\nstruct comedi_subdevice *s, struct comedi_insn *insn, unsigned int *data)\r\n{\r\nint i_ReturnValue = 0;\r\nunsigned int dw_Status;\r\nunsigned int dw_DummyRead;\r\nunsigned int dw_ConfigReg;\r\nunsigned char b_ModulNbr, b_Action;\r\nunsigned char b_TorCounter;\r\nunsigned char b_InputMode;\r\nunsigned char b_ExternGate;\r\nunsigned char b_CycleMode;\r\nunsigned char b_InterruptEnable;\r\nb_ModulNbr = (unsigned char) CR_AREF(insn->chanspec);\r\nb_Action = (unsigned char) data[0];\r\nb_TorCounter = (unsigned char) data[1];\r\nb_InputMode = (unsigned char) data[2];\r\nb_ExternGate = (unsigned char) data[3];\r\nb_CycleMode = (unsigned char) data[4];\r\nb_InterruptEnable = (unsigned char) data[5];\r\ni_ReturnValue = insn->n;\r\ndevpriv->tsk_Current = current;\r\nif (b_ModulNbr < 4) {\r\nif ((devpriv->s_BoardInfos.\r\ndw_MolduleConfiguration[b_ModulNbr] &\r\n0xFFFF0000UL) == APCI1710_TOR_COUNTER) {\r\nif (b_TorCounter <= 1) {\r\nswitch (b_Action)\r\n{\r\ncase APCI1710_ENABLE:\r\ndw_Status =\r\ninl(devpriv->s_BoardInfos.\r\nui_Address + 8 +\r\n(16 * b_TorCounter) +\r\n(64 * b_ModulNbr));\r\nif (dw_Status & 0x10) {\r\nif (b_InputMode == 0 ||\r\nb_InputMode == 1 ||\r\nb_InputMode ==\r\nAPCI1710_TOR_SIMPLE_MODE\r\n|| b_InputMode ==\r\nAPCI1710_TOR_DOUBLE_MODE\r\n|| b_InputMode ==\r\nAPCI1710_TOR_QUADRUPLE_MODE)\r\n{\r\nif (b_ExternGate == 0\r\n|| b_ExternGate\r\n== 1\r\n|| b_InputMode >\r\n1) {\r\nif ((b_CycleMode == APCI1710_SINGLE) || (b_CycleMode == APCI1710_CONTINUOUS)) {\r\nif ((b_InterruptEnable == APCI1710_ENABLE) || (b_InterruptEnable == APCI1710_DISABLE)) {\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_TorCounterModuleInfo.\r\ns_TorCounterInfo\r\n[b_TorCounter].\r\nb_InterruptEnable\r\n=\r\nb_InterruptEnable;\r\ndw_ConfigReg\r\n=\r\ninl\r\n(devpriv->\r\ns_BoardInfos.\r\nui_Address\r\n+\r\n4\r\n+\r\n(16 * b_TorCounter) + (64 * b_ModulNbr));\r\ndw_ConfigReg\r\n=\r\n(dw_ConfigReg\r\n>>\r\n4)\r\n&\r\n0x30;\r\nif (b_InputMode > 1) {\r\nb_ExternGate\r\n=\r\n0;\r\ndw_ConfigReg\r\n=\r\ndw_ConfigReg\r\n|\r\n0x40;\r\nif (b_InputMode == APCI1710_TOR_SIMPLE_MODE) {\r\ndw_ConfigReg\r\n=\r\ndw_ConfigReg\r\n|\r\n0x780;\r\n}\r\nif (b_InputMode == APCI1710_TOR_DOUBLE_MODE) {\r\ndw_ConfigReg\r\n=\r\ndw_ConfigReg\r\n|\r\n0x180;\r\n}\r\nb_InputMode\r\n=\r\n0;\r\n}\r\ndw_ConfigReg\r\n=\r\ndw_ConfigReg\r\n|\r\nb_CycleMode\r\n|\r\n(b_InterruptEnable\r\n*\r\n2)\r\n|\r\n(b_InputMode\r\n*\r\n4)\r\n|\r\n(b_ExternGate\r\n*\r\n8);\r\ndw_DummyRead\r\n=\r\ninl\r\n(devpriv->\r\ns_BoardInfos.\r\nui_Address\r\n+\r\n0\r\n+\r\n(16 * b_TorCounter) + (64 * b_ModulNbr));\r\ndw_DummyRead\r\n=\r\ninl\r\n(devpriv->\r\ns_BoardInfos.\r\nui_Address\r\n+\r\n12\r\n+\r\n(16 * b_TorCounter) + (64 * b_ModulNbr));\r\noutl(dw_ConfigReg, devpriv->s_BoardInfos.ui_Address + 4 + (16 * b_TorCounter) + (64 * b_ModulNbr));\r\noutl(1, devpriv->s_BoardInfos.ui_Address + 8 + (16 * b_TorCounter) + (64 * b_ModulNbr));\r\n}\r\nelse {\r\nDPRINTK("Interrupt parameter is wrong\n");\r\ni_ReturnValue\r\n=\r\n-9;\r\n}\r\n}\r\nelse {\r\nDPRINTK("Tor counter acquisition mode cycle is wrong\n");\r\ni_ReturnValue\r\n=\r\n-8;\r\n}\r\n}\r\nelse {\r\nDPRINTK("Extern gate input mode is wrong\n");\r\ni_ReturnValue =\r\n-7;\r\n}\r\n}\r\nelse {\r\nDPRINTK("Tor input signal selection is wrong\n");\r\ni_ReturnValue = -6;\r\n}\r\n} else {\r\nDPRINTK("Tor counter not initialised\n");\r\ni_ReturnValue = -5;\r\n}\r\nbreak;\r\ncase APCI1710_DISABLE:\r\ndw_Status = inl(devpriv->s_BoardInfos.\r\nui_Address + 8 +\r\n(16 * b_TorCounter) +\r\n(64 * b_ModulNbr));\r\nif (dw_Status & 0x10) {\r\nif (dw_Status & 0x1) {\r\ndevpriv->\r\ns_ModuleInfo\r\n[b_ModulNbr].\r\ns_TorCounterModuleInfo.\r\ns_TorCounterInfo\r\n[b_TorCounter].\r\nb_InterruptEnable\r\n=\r\nAPCI1710_DISABLE;\r\noutl(0, devpriv->\r\ns_BoardInfos.\r\nui_Address + 8 +\r\n(16 * b_TorCounter) + (64 * b_ModulNbr));\r\n}\r\nelse {\r\nDPRINTK("Tor counter not enabled \n");\r\ni_ReturnValue = -6;\r\n}\r\n}\r\nelse {\r\nDPRINTK("Tor counter not initialised\n");\r\ni_ReturnValue = -5;\r\n}\r\n}\r\n}\r\nelse {\r\nDPRINTK("Tor counter selection is wrong\n");\r\ni_ReturnValue = -4;\r\n}\r\n} else {\r\nDPRINTK("The module is not a tor counter module \n");\r\ni_ReturnValue = -3;\r\n}\r\n} else {\r\nDPRINTK("Module number error \n");\r\ni_ReturnValue = -2;\r\n}\r\nreturn i_ReturnValue;\r\n}\r\nint i_APCI1710_InsnReadGetTorCounterInitialisation(struct comedi_device *dev,\r\nstruct comedi_subdevice *s, struct comedi_insn *insn, unsigned int *data)\r\n{\r\nint i_ReturnValue = 0;\r\nunsigned int dw_Status;\r\nunsigned char b_ModulNbr;\r\nunsigned char b_TorCounter;\r\nunsigned char *pb_TimingUnit;\r\nunsigned int *pul_TimingInterval;\r\nunsigned char *pb_InputMode;\r\nunsigned char *pb_ExternGate;\r\nunsigned char *pb_CycleMode;\r\nunsigned char *pb_Enable;\r\nunsigned char *pb_InterruptEnable;\r\ni_ReturnValue = insn->n;\r\nb_ModulNbr = CR_AREF(insn->chanspec);\r\nb_TorCounter = CR_CHAN(insn->chanspec);\r\npb_TimingUnit = (unsigned char *) &data[0];\r\npul_TimingInterval = (unsigned int *) &data[1];\r\npb_InputMode = (unsigned char *) &data[2];\r\npb_ExternGate = (unsigned char *) &data[3];\r\npb_CycleMode = (unsigned char *) &data[4];\r\npb_Enable = (unsigned char *) &data[5];\r\npb_InterruptEnable = (unsigned char *) &data[6];\r\nif (b_ModulNbr < 4) {\r\nif ((devpriv->s_BoardInfos.\r\ndw_MolduleConfiguration[b_ModulNbr] &\r\n0xFFFF0000UL) == APCI1710_TOR_COUNTER) {\r\nif (b_TorCounter <= 1) {\r\ndw_Status = inl(devpriv->s_BoardInfos.\r\nui_Address + 8 + (16 * b_TorCounter) +\r\n(64 * b_ModulNbr));\r\nif (dw_Status & 0x10) {\r\n*pb_Enable = dw_Status & 1;\r\ndw_Status = inl(devpriv->s_BoardInfos.\r\nui_Address + 4 +\r\n(16 * b_TorCounter) +\r\n(64 * b_ModulNbr));\r\n*pb_CycleMode =\r\n(unsigned char) ((dw_Status >> 4) & 1);\r\n*pb_InterruptEnable =\r\n(unsigned char) ((dw_Status >> 5) & 1);\r\nif (dw_Status & 0x600) {\r\nif (dw_Status & 0x400) {\r\nif ((dw_Status & 0x7800)\r\n== 0x7800) {\r\n*pb_InputMode =\r\nAPCI1710_TOR_SIMPLE_MODE;\r\n}\r\nif ((dw_Status & 0x7800)\r\n== 0x1800) {\r\n*pb_InputMode =\r\nAPCI1710_TOR_DOUBLE_MODE;\r\n}\r\nif ((dw_Status & 0x7800)\r\n== 0x0000) {\r\n*pb_InputMode =\r\nAPCI1710_TOR_QUADRUPLE_MODE;\r\n}\r\n}\r\nelse {\r\n*pb_InputMode = 1;\r\n}\r\n*pb_ExternGate = 0;\r\n}\r\nelse {\r\n*pb_InputMode =\r\n(unsigned char) ((dw_Status >> 6)\r\n& 1);\r\n*pb_ExternGate =\r\n(unsigned char) ((dw_Status >> 7)\r\n& 1);\r\n}\r\n*pb_TimingUnit =\r\ndevpriv->\r\ns_ModuleInfo[b_ModulNbr].\r\ns_TorCounterModuleInfo.\r\ns_TorCounterInfo[b_TorCounter].\r\nb_TimingUnit;\r\n*pul_TimingInterval =\r\ndevpriv->\r\ns_ModuleInfo[b_ModulNbr].\r\ns_TorCounterModuleInfo.\r\ns_TorCounterInfo[b_TorCounter].\r\nul_RealTimingInterval;\r\n} else {\r\nDPRINTK("Tor counter not initialised\n");\r\ni_ReturnValue = -5;\r\n}\r\n}\r\nelse {\r\nDPRINTK("Tor counter selection is wrong \n");\r\ni_ReturnValue = -4;\r\n}\r\n} else {\r\nDPRINTK("The module is not a tor counter module\n");\r\ni_ReturnValue = -3;\r\n}\r\n} else {\r\nDPRINTK("Module number error\n");\r\ni_ReturnValue = -2;\r\n}\r\nreturn i_ReturnValue;\r\n}\r\nint i_APCI1710_InsnBitsGetTorCounterProgressStatusAndValue(struct comedi_device *dev,\r\nstruct comedi_subdevice *s, struct comedi_insn *insn, unsigned int *data)\r\n{\r\nint i_ReturnValue = 0;\r\nunsigned int dw_Status;\r\nunsigned int dw_TimeOut = 0;\r\nunsigned char b_ModulNbr;\r\nunsigned char b_TorCounter;\r\nunsigned char b_ReadType;\r\nunsigned int ui_TimeOut;\r\nunsigned char *pb_TorCounterStatus;\r\nunsigned int *pul_TorCounterValue;\r\ni_ReturnValue = insn->n;\r\nb_ModulNbr = CR_AREF(insn->chanspec);\r\nb_ReadType = (unsigned char) data[0];\r\nb_TorCounter = (unsigned char) data[1];\r\nui_TimeOut = (unsigned int) data[2];\r\npb_TorCounterStatus = (unsigned char *) &data[0];\r\npul_TorCounterValue = (unsigned int *) &data[1];\r\nif (b_ReadType == APCI1710_TOR_READINTERRUPT) {\r\ndata[0] = devpriv->s_InterruptParameters.\r\ns_FIFOInterruptParameters[devpriv->\r\ns_InterruptParameters.ui_Read].b_OldModuleMask;\r\ndata[1] = devpriv->s_InterruptParameters.\r\ns_FIFOInterruptParameters[devpriv->\r\ns_InterruptParameters.ui_Read].ul_OldInterruptMask;\r\ndata[2] = devpriv->s_InterruptParameters.\r\ns_FIFOInterruptParameters[devpriv->\r\ns_InterruptParameters.ui_Read].ul_OldCounterLatchValue;\r\ndevpriv->\r\ns_InterruptParameters.\r\nui_Read = (devpriv->\r\ns_InterruptParameters.\r\nui_Read + 1) % APCI1710_SAVE_INTERRUPT;\r\nreturn insn->n;\r\n}\r\nif (b_ModulNbr < 4) {\r\nif ((devpriv->s_BoardInfos.\r\ndw_MolduleConfiguration[b_ModulNbr] &\r\n0xFFFF0000UL) == APCI1710_TOR_COUNTER) {\r\nif (b_TorCounter <= 1) {\r\ndw_Status = inl(devpriv->s_BoardInfos.\r\nui_Address + 8 + (16 * b_TorCounter) +\r\n(64 * b_ModulNbr));\r\nif (dw_Status & 0x10) {\r\nif (dw_Status & 0x1) {\r\nswitch (b_ReadType) {\r\ncase APCI1710_TOR_GETPROGRESSSTATUS:\r\ndw_Status =\r\ninl(devpriv->\r\ns_BoardInfos.\r\nui_Address + 4 +\r\n(16 * b_TorCounter) + (64 * b_ModulNbr));\r\ndw_Status =\r\ndw_Status & 0xF;\r\nif (dw_Status & 1) {\r\nif (dw_Status &\r\n2) {\r\nif (dw_Status & 4) {\r\n*pb_TorCounterStatus\r\n=\r\n3;\r\n} else {\r\n*pb_TorCounterStatus\r\n=\r\n2;\r\n}\r\n} else {\r\n*pb_TorCounterStatus\r\n=\r\n1;\r\n}\r\n} else {\r\n*pb_TorCounterStatus\r\n= 0;\r\n}\r\nbreak;\r\ncase APCI1710_TOR_GETCOUNTERVALUE:\r\nif ((ui_TimeOut >= 0)\r\n&& (ui_TimeOut\r\n<=\r\n65535UL))\r\n{\r\nfor (;;) {\r\ndw_Status\r\n=\r\ninl\r\n(devpriv->\r\ns_BoardInfos.\r\nui_Address\r\n+\r\n4\r\n+\r\n(16 * b_TorCounter) + (64 * b_ModulNbr));\r\nif ((dw_Status & 4) == 4) {\r\n*pb_TorCounterStatus\r\n=\r\n3;\r\n*pul_TorCounterValue\r\n=\r\ninl\r\n(devpriv->\r\ns_BoardInfos.\r\nui_Address\r\n+\r\n0\r\n+\r\n(16 * b_TorCounter) + (64 * b_ModulNbr));\r\nbreak;\r\n}\r\nelse {\r\nif ((dw_Status & 2) == 2) {\r\n*pb_TorCounterStatus\r\n=\r\n2;\r\n*pul_TorCounterValue\r\n=\r\ninl\r\n(devpriv->\r\ns_BoardInfos.\r\nui_Address\r\n+\r\n0\r\n+\r\n(16 * b_TorCounter) + (64 * b_ModulNbr));\r\nbreak;\r\n}\r\nelse {\r\nif ((dw_Status & 1) == 1) {\r\n*pb_TorCounterStatus\r\n=\r\n1;\r\n}\r\nelse {\r\n*pb_TorCounterStatus\r\n=\r\n0;\r\n}\r\n}\r\n}\r\nif (dw_TimeOut == ui_TimeOut) {\r\nbreak;\r\n} else {\r\ndw_TimeOut\r\n=\r\ndw_TimeOut\r\n+\r\n1;\r\nmdelay(1000);\r\n}\r\n}\r\nif ((*pb_TorCounterStatus != 3) && (dw_TimeOut == ui_TimeOut) && (ui_TimeOut != 0)) {\r\n*pb_TorCounterStatus\r\n=\r\n4;\r\n}\r\n} else {\r\nDPRINTK("Timeout parameter is wrong\n");\r\ni_ReturnValue =\r\n-7;\r\n}\r\nbreak;\r\ndefault:\r\nprintk("Inputs wrong\n");\r\n}\r\n}\r\nelse {\r\nDPRINTK("Tor counter not enabled\n");\r\ni_ReturnValue = -6;\r\n}\r\n} else {\r\nDPRINTK("Tor counter not initialised\n");\r\ni_ReturnValue = -5;\r\n}\r\n}\r\nelse {\r\nDPRINTK("Tor counter selection is wrong\n");\r\ni_ReturnValue = -4;\r\n}\r\n} else {\r\nDPRINTK("The module is not a tor counter module\n");\r\ni_ReturnValue = -3;\r\n}\r\n} else {\r\nDPRINTK("Module number error\n");\r\ni_ReturnValue = -2;\r\n}\r\nreturn i_ReturnValue;\r\n}

static void pci_free_resources(struct pci_dev *dev)\r\n{\r\nint i;\r\nmsi_remove_pci_irq_vectors(dev);\r\npci_cleanup_rom(dev);\r\nfor (i = 0; i < PCI_NUM_RESOURCES; i++) {\r\nstruct resource *res = dev->resource + i;\r\nif (res->parent)\r\nrelease_resource(res);\r\n}\r\n}\r\nstatic void pci_stop_dev(struct pci_dev *dev)\r\n{\r\nif (dev->is_added) {\r\npci_proc_detach_device(dev);\r\npci_remove_sysfs_dev_files(dev);\r\ndevice_unregister(&dev->dev);\r\ndev->is_added = 0;\r\n}\r\nif (dev->bus->self)\r\npcie_aspm_exit_link_state(dev);\r\n}\r\nstatic void pci_destroy_dev(struct pci_dev *dev)\r\n{\r\ndown_write(&pci_bus_sem);\r\nlist_del(&dev->bus_list);\r\ndev->bus_list.next = dev->bus_list.prev = NULL;\r\nup_write(&pci_bus_sem);\r\npci_free_resources(dev);\r\npci_dev_put(dev);\r\n}\r\nvoid pci_remove_bus(struct pci_bus *pci_bus)\r\n{\r\npci_proc_detach_bus(pci_bus);\r\ndown_write(&pci_bus_sem);\r\nlist_del(&pci_bus->node);\r\nup_write(&pci_bus_sem);\r\nif (!pci_bus->is_added)\r\nreturn;\r\npci_remove_legacy_files(pci_bus);\r\ndevice_unregister(&pci_bus->dev);\r\n}\r\nvoid pci_remove_bus_device(struct pci_dev *dev)\r\n{\r\npci_stop_bus_device(dev);\r\nif (dev->subordinate) {\r\nstruct pci_bus *b = dev->subordinate;\r\npci_remove_behind_bridge(dev);\r\npci_remove_bus(b);\r\ndev->subordinate = NULL;\r\n}\r\npci_destroy_dev(dev);\r\n}\r\nvoid pci_remove_behind_bridge(struct pci_dev *dev)\r\n{\r\nstruct list_head *l, *n;\r\nif (dev->subordinate)\r\nlist_for_each_safe(l, n, &dev->subordinate->devices)\r\npci_remove_bus_device(pci_dev_b(l));\r\n}\r\nstatic void pci_stop_bus_devices(struct pci_bus *bus)\r\n{\r\nstruct list_head *l, *n;\r\nlist_for_each_safe(l, n, &bus->devices) {\r\nstruct pci_dev *dev = pci_dev_b(l);\r\npci_stop_bus_device(dev);\r\n}\r\n}\r\nvoid pci_stop_bus_device(struct pci_dev *dev)\r\n{\r\nif (dev->subordinate)\r\npci_stop_bus_devices(dev->subordinate);\r\npci_stop_dev(dev);\r\n}

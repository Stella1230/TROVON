int\r\nhysdn_sched_rx(hysdn_card *card, unsigned char *buf, unsigned short len,\r\nunsigned short chan)\r\n{\r\nswitch (chan) {\r\ncase CHAN_NDIS_DATA:\r\nif (hynet_enable & (1 << card->myid)) {\r\nhysdn_rx_netpkt(card, buf, len);\r\n}\r\nbreak;\r\ncase CHAN_ERRLOG:\r\nhysdn_card_errlog(card, (tErrLogEntry *) buf, len);\r\nif (card->err_log_state == ERRLOG_STATE_ON)\r\ncard->err_log_state = ERRLOG_STATE_START;\r\nbreak;\r\n#ifdef CONFIG_HYSDN_CAPI\r\ncase CHAN_CAPI:\r\nif (hycapi_enable & (1 << card->myid)) {\r\nhycapi_rx_capipkt(card, buf, len);\r\n}\r\nbreak;\r\n#endif\r\ndefault:\r\nprintk(KERN_INFO "irq message channel %d len %d unhandled \n", chan, len);\r\nbreak;\r\n}\r\nreturn (1);\r\n}\r\nint\r\nhysdn_sched_tx(hysdn_card *card, unsigned char *buf,\r\nunsigned short volatile *len, unsigned short volatile *chan,\r\nunsigned short maxlen)\r\n{\r\nstruct sk_buff *skb;\r\nif (card->net_tx_busy) {\r\ncard->net_tx_busy = 0;\r\nhysdn_tx_netack(card);\r\n}\r\nif (card->async_busy) {\r\nif (card->async_len <= maxlen) {\r\nmemcpy(buf, card->async_data, card->async_len);\r\n*len = card->async_len;\r\n*chan = card->async_channel;\r\ncard->async_busy = 0;\r\nreturn (1);\r\n}\r\ncard->async_busy = 0;\r\n}\r\nif ((card->err_log_state == ERRLOG_STATE_START) &&\r\n(maxlen >= ERRLOG_CMD_REQ_SIZE)) {\r\nstrcpy(buf, ERRLOG_CMD_REQ);\r\n*len = ERRLOG_CMD_REQ_SIZE;\r\n*chan = CHAN_ERRLOG;\r\ncard->err_log_state = ERRLOG_STATE_ON;\r\nreturn (1);\r\n}\r\nif ((card->err_log_state == ERRLOG_STATE_STOP) &&\r\n(maxlen >= ERRLOG_CMD_STOP_SIZE)) {\r\nstrcpy(buf, ERRLOG_CMD_STOP);\r\n*len = ERRLOG_CMD_STOP_SIZE;\r\n*chan = CHAN_ERRLOG;\r\ncard->err_log_state = ERRLOG_STATE_OFF;\r\nreturn (1);\r\n}\r\nif ((hynet_enable & (1 << card->myid)) &&\r\n(skb = hysdn_tx_netget(card)) != NULL)\r\n{\r\nif (skb->len <= maxlen) {\r\nskb_copy_from_linear_data(skb, buf, skb->len);\r\n*len = skb->len;\r\n*chan = CHAN_NDIS_DATA;\r\ncard->net_tx_busy = 1;\r\nreturn (1);\r\n} else\r\nhysdn_tx_netack(card);\r\n}\r\n#ifdef CONFIG_HYSDN_CAPI\r\nif( ((hycapi_enable & (1 << card->myid))) &&\r\n((skb = hycapi_tx_capiget(card)) != NULL) )\r\n{\r\nif (skb->len <= maxlen) {\r\nskb_copy_from_linear_data(skb, buf, skb->len);\r\n*len = skb->len;\r\n*chan = CHAN_CAPI;\r\nhycapi_tx_capiack(card);\r\nreturn (1);\r\n}\r\n}\r\n#endif\r\nreturn (0);\r\n}\r\nint\r\nhysdn_tx_cfgline(hysdn_card *card, unsigned char *line, unsigned short chan)\r\n{\r\nint cnt = 50;\r\nunsigned long flags;\r\nif (card->debug_flags & LOG_SCHED_ASYN)\r\nhysdn_addlog(card, "async tx-cfg chan=%d len=%d", chan, strlen(line) + 1);\r\nwhile (card->async_busy) {\r\nif (card->debug_flags & LOG_SCHED_ASYN)\r\nhysdn_addlog(card, "async tx-cfg delayed");\r\nmsleep_interruptible(20);\r\nif (!--cnt)\r\nreturn (-ERR_ASYNC_TIME);\r\n}\r\nspin_lock_irqsave(&card->hysdn_lock, flags);\r\nstrcpy(card->async_data, line);\r\ncard->async_len = strlen(line) + 1;\r\ncard->async_channel = chan;\r\ncard->async_busy = 1;\r\nschedule_work(&card->irq_queue);\r\nspin_unlock_irqrestore(&card->hysdn_lock, flags);\r\nif (card->debug_flags & LOG_SCHED_ASYN)\r\nhysdn_addlog(card, "async tx-cfg data queued");\r\ncnt++;\r\nwhile (card->async_busy) {\r\nif (card->debug_flags & LOG_SCHED_ASYN)\r\nhysdn_addlog(card, "async tx-cfg waiting for tx-ready");\r\nmsleep_interruptible(20);\r\nif (!--cnt)\r\nreturn (-ERR_ASYNC_TIME);\r\n}\r\nif (card->debug_flags & LOG_SCHED_ASYN)\r\nhysdn_addlog(card, "async tx-cfg data send");\r\nreturn (0);\r\n}

int pohmelfs_construct_path_string(struct pohmelfs_inode *pi, void *data, int len)\r\n{\r\nstruct path path;\r\nstruct dentry *d;\r\nchar *ptr;\r\nint err = 0, strlen, reduce = 0;\r\nd = d_find_alias(&pi->vfs_inode);\r\nif (!d) {\r\nprintk("%s: no alias, list_empty: %d.\n", __func__, list_empty(&pi->vfs_inode.i_dentry));\r\nreturn -ENOENT;\r\n}\r\nspin_lock(&current->fs->lock);\r\npath.mnt = mntget(current->fs->root.mnt);\r\nspin_unlock(&current->fs->lock);\r\npath.dentry = d;\r\nif (!IS_ROOT(d) && d_unhashed(d))\r\nreduce = 1;\r\nptr = d_path(&path, data, len);\r\nif (IS_ERR(ptr)) {\r\nerr = PTR_ERR(ptr);\r\ngoto out;\r\n}\r\nif (reduce && len >= UNHASHED_OBSCURE_STRING_SIZE) {\r\nchar *end = data + len - UNHASHED_OBSCURE_STRING_SIZE;\r\n*end = '\0';\r\n}\r\nstrlen = len - (ptr - (char *)data);\r\nmemmove(data, ptr, strlen);\r\nptr = data;\r\nerr = strlen;\r\ndprintk("%s: dname: '%s', len: %u, maxlen: %u, name: '%s', strlen: %d.\n",\r\n__func__, d->d_name.name, d->d_name.len, len, ptr, strlen);\r\nout:\r\ndput(d);\r\nmntput(path.mnt);\r\nreturn err;\r\n}\r\nint pohmelfs_path_length(struct pohmelfs_inode *pi)\r\n{\r\nstruct dentry *d, *root, *first;\r\nint len;\r\nunsigned seq;\r\nfirst = d_find_alias(&pi->vfs_inode);\r\nif (!first) {\r\ndprintk("%s: ino: %llu, mode: %o.\n", __func__, pi->ino, pi->vfs_inode.i_mode);\r\nreturn -ENOENT;\r\n}\r\nspin_lock(&current->fs->lock);\r\nroot = dget(current->fs->root.dentry);\r\nspin_unlock(&current->fs->lock);\r\nrename_retry:\r\nlen = 1;\r\nd = first;\r\nseq = read_seqbegin(&rename_lock);\r\nrcu_read_lock();\r\nif (!IS_ROOT(d) && d_unhashed(d))\r\nlen += UNHASHED_OBSCURE_STRING_SIZE;\r\nwhile (d && d != root && !IS_ROOT(d)) {\r\nlen += d->d_name.len + 1;\r\nd = d->d_parent;\r\n}\r\nrcu_read_unlock();\r\nif (read_seqretry(&rename_lock, seq))\r\ngoto rename_retry;\r\ndput(root);\r\ndput(first);\r\nreturn len + 1;\r\n}

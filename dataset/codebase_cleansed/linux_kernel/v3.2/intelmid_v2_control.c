static void nc_set_amp_power(int power)\r\n{\r\nif (snd_pmic_ops_nc.gpio_amp)\r\ngpio_set_value(snd_pmic_ops_nc.gpio_amp, power);\r\n}\r\nstatic int nc_init_card(void)\r\n{\r\nstruct sc_reg_access sc_access[] = {\r\n{VAUDIOCNT, 0x25, 0},\r\n{VOICEPORT1, 0x00, 0},\r\n{VOICEPORT2, 0x00, 0},\r\n{AUDIOPORT1, 0x98, 0},\r\n{AUDIOPORT2, 0x09, 0},\r\n{AUDIOLVOL, 0x00, 0},\r\n{AUDIORVOL, 0x00, 0},\r\n{LMUTE, 0x03, 0},\r\n{RMUTE, 0x03, 0},\r\n{POWERCTRL1, 0x00, 0},\r\n{POWERCTRL2, 0x00, 0},\r\n{DRVPOWERCTRL, 0x00, 0},\r\n{VREFPLL, 0x10, 0},\r\n{HPLMIXSEL, 0xee, 0},\r\n{HPRMIXSEL, 0xf6, 0},\r\n{PCMBUFCTRL, 0x0, 0},\r\n{VOICEVOL, 0x0e, 0},\r\n{HPLVOL, 0x06, 0},\r\n{HPRVOL, 0x06, 0},\r\n{MICCTRL, 0x51, 0x00},\r\n{ADCSAMPLERATE, 0x8B, 0x00},\r\n{MICSELVOL, 0x5B, 0x00},\r\n{LILSEL, 0x06, 0},\r\n{LIRSEL, 0x46, 0},\r\n{LOANTIPOP, 0x00, 0},\r\n{DMICCTRL1, 0x40, 0},\r\n{AUXDBNC, 0xff, 0},\r\n};\r\nsnd_pmic_ops_nc.card_status = SND_CARD_INIT_DONE;\r\nsnd_pmic_ops_nc.master_mute = UNMUTE;\r\nsnd_pmic_ops_nc.mute_status = UNMUTE;\r\nsst_sc_reg_access(sc_access, PMIC_WRITE, 27);\r\nmutex_init(&snd_pmic_ops_nc.lock);\r\npr_debug("init complete!!\n");\r\nreturn 0;\r\n}\r\nstatic int nc_enable_audiodac(int value)\r\n{\r\nstruct sc_reg_access sc_access[3];\r\nint mute_val = 0;\r\nif (snd_pmic_ops_nc.mute_status == MUTE)\r\nreturn 0;\r\nif (((snd_pmic_ops_nc.output_dev_id == MONO_EARPIECE) ||\r\n(snd_pmic_ops_nc.output_dev_id == INTERNAL_SPKR)) &&\r\n(value == UNMUTE))\r\nreturn 0;\r\nif (value == UNMUTE) {\r\nmute_val = 0x00;\r\n} else {\r\nmute_val = 0x04;\r\n}\r\nsc_access[0].reg_addr = LMUTE;\r\nsc_access[1].reg_addr = RMUTE;\r\nsc_access[0].mask = sc_access[1].mask = MASK2;\r\nsc_access[0].value = sc_access[1].value = mute_val;\r\nif (snd_pmic_ops_nc.num_channel == 1)\r\nsc_access[1].value = 0x04;\r\nreturn sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 2);\r\n}\r\nstatic int nc_power_up_pb(unsigned int port)\r\n{\r\nstruct sc_reg_access sc_access[7];\r\nint retval = 0;\r\nif (snd_pmic_ops_nc.card_status == SND_CARD_UN_INIT)\r\nretval = nc_init_card();\r\nif (retval)\r\nreturn retval;\r\nif (port == 0xFF)\r\nreturn 0;\r\nmutex_lock(&snd_pmic_ops_nc.lock);\r\nnc_enable_audiodac(MUTE);\r\nmsleep(30);\r\npr_debug("powering up pb....\n");\r\nsc_access[0].reg_addr = VAUDIOCNT;\r\nsc_access[0].value = 0x27;\r\nsc_access[0].mask = 0x27;\r\nsc_access[1].reg_addr = VREFPLL;\r\nif (port == 0) {\r\nsc_access[1].value = 0x3A;\r\nsc_access[1].mask = 0x3A;\r\n} else if (port == 1) {\r\nsc_access[1].value = 0x35;\r\nsc_access[1].mask = 0x35;\r\n}\r\nretval = sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 2);\r\nsc_access[0].reg_addr = POWERCTRL1;\r\nif (port == 0) {\r\nsc_access[0].value = 0x40;\r\nsc_access[0].mask = 0x40;\r\n} else if (port == 1) {\r\nsc_access[0].value = 0x01;\r\nsc_access[0].mask = 0x01;\r\n}\r\nsc_access[1].reg_addr = POWERCTRL2;\r\nsc_access[1].value = 0x0C;\r\nsc_access[1].mask = 0x0C;\r\nsc_access[2].reg_addr = DRVPOWERCTRL;\r\nsc_access[2].value = 0x86;\r\nsc_access[2].mask = 0x86;\r\nsst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 3);\r\nmsleep(30);\r\nsnd_pmic_ops_nc.pb_on = 1;\r\nif (snd_pmic_ops_nc.output_dev_id == MONO_EARPIECE ||\r\nsnd_pmic_ops_nc.output_dev_id == INTERNAL_SPKR)\r\nnc_set_amp_power(1);\r\nnc_enable_audiodac(UNMUTE);\r\nmutex_unlock(&snd_pmic_ops_nc.lock);\r\nreturn 0;\r\n}\r\nstatic int nc_power_up_cp(unsigned int port)\r\n{\r\nstruct sc_reg_access sc_access[5];\r\nint retval = 0;\r\nif (snd_pmic_ops_nc.card_status == SND_CARD_UN_INIT)\r\nretval = nc_init_card();\r\nif (retval)\r\nreturn retval;\r\npr_debug("powering up cp....\n");\r\nif (port == 0xFF)\r\nreturn 0;\r\nsc_access[0].reg_addr = VAUDIOCNT;\r\nsc_access[0].value = 0x27;\r\nsc_access[0].mask = 0x27;\r\nsc_access[1].reg_addr = VREFPLL;\r\nif (port == 0) {\r\nsc_access[1].value = 0x3E;\r\nsc_access[1].mask = 0x3E;\r\n} else if (port == 1) {\r\nsc_access[1].value = 0x35;\r\nsc_access[1].mask = 0x35;\r\n}\r\nretval = sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 2);\r\nsc_access[0].reg_addr = POWERCTRL1;\r\nif (port == 0) {\r\nsc_access[0].value = 0xB4;\r\nsc_access[0].mask = 0xB4;\r\n} else if (port == 1) {\r\nsc_access[0].value = 0xBF;\r\nsc_access[0].mask = 0xBF;\r\n}\r\nsc_access[1].reg_addr = POWERCTRL2;\r\nif (port == 0) {\r\nsc_access[1].value = 0x0C;\r\nsc_access[1].mask = 0x0C;\r\n} else if (port == 1) {\r\nsc_access[1].value = 0x02;\r\nsc_access[1].mask = 0x02;\r\n}\r\nreturn sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 2);\r\n}\r\nstatic int nc_power_down(void)\r\n{\r\nint retval = 0;\r\nstruct sc_reg_access sc_access[5];\r\nif (snd_pmic_ops_nc.card_status == SND_CARD_UN_INIT)\r\nretval = nc_init_card();\r\nif (retval)\r\nreturn retval;\r\nnc_enable_audiodac(MUTE);\r\npr_debug("powering dn nc_power_down ....\n");\r\nif (snd_pmic_ops_nc.output_dev_id == MONO_EARPIECE ||\r\nsnd_pmic_ops_nc.output_dev_id == INTERNAL_SPKR)\r\nnc_set_amp_power(0);\r\nmsleep(30);\r\nsc_access[0].reg_addr = DRVPOWERCTRL;\r\nsc_access[0].value = 0x00;\r\nsc_access[0].mask = 0x00;\r\nsst_sc_reg_access(sc_access, PMIC_WRITE, 1);\r\nsc_access[0].reg_addr = POWERCTRL1;\r\nsc_access[0].value = 0x00;\r\nsc_access[0].mask = 0x00;\r\nsc_access[1].reg_addr = POWERCTRL2;\r\nsc_access[1].value = 0x00;\r\nsc_access[1].mask = 0x00;\r\nsst_sc_reg_access(sc_access, PMIC_WRITE, 2);\r\nmsleep(30);\r\nsc_access[0].reg_addr = VREFPLL;\r\nsc_access[0].value = 0x10;\r\nsc_access[0].mask = 0x10;\r\nsc_access[1].reg_addr = VAUDIOCNT;\r\nsc_access[1].value = 0x25;\r\nsc_access[1].mask = 0x25;\r\nretval = sst_sc_reg_access(sc_access, PMIC_WRITE, 2);\r\nmsleep(30);\r\nreturn nc_enable_audiodac(UNMUTE);\r\n}\r\nstatic int nc_power_down_pb(unsigned int device)\r\n{\r\nint retval = 0;\r\nstruct sc_reg_access sc_access[5];\r\nif (snd_pmic_ops_nc.card_status == SND_CARD_UN_INIT)\r\nretval = nc_init_card();\r\nif (retval)\r\nreturn retval;\r\npr_debug("powering dn pb....\n");\r\nmutex_lock(&snd_pmic_ops_nc.lock);\r\nnc_enable_audiodac(MUTE);\r\nmsleep(30);\r\nsc_access[0].reg_addr = DRVPOWERCTRL;\r\nsc_access[0].value = 0x00;\r\nsc_access[0].mask = 0x00;\r\nsst_sc_reg_access(sc_access, PMIC_WRITE, 1);\r\nmsleep(30);\r\nsc_access[0].reg_addr = POWERCTRL1;\r\nsc_access[0].value = 0x00;\r\nsc_access[0].mask = 0x41;\r\nsc_access[1].reg_addr = POWERCTRL2;\r\nsc_access[1].value = 0x00;\r\nsc_access[1].mask = 0x0C;\r\nsst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 2);\r\nmsleep(30);\r\nsnd_pmic_ops_nc.pb_on = 0;\r\nnc_enable_audiodac(UNMUTE);\r\nmutex_unlock(&snd_pmic_ops_nc.lock);\r\nreturn 0;\r\n}\r\nstatic int nc_power_down_cp(unsigned int device)\r\n{\r\nstruct sc_reg_access sc_access[] = {\r\n{POWERCTRL1, 0x00, 0xBE},\r\n{POWERCTRL2, 0x00, 0x02},\r\n};\r\nint retval = 0;\r\nif (snd_pmic_ops_nc.card_status == SND_CARD_UN_INIT)\r\nretval = nc_init_card();\r\nif (retval)\r\nreturn retval;\r\npr_debug("powering dn cp....\n");\r\nreturn sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 1);\r\n}\r\nstatic int nc_set_pcm_voice_params(void)\r\n{\r\nstruct sc_reg_access sc_access[] = {\r\n{0x100, 0xD5, 0},\r\n{0x101, 0x08, 0},\r\n{0x104, 0x03, 0},\r\n{0x107, 0x10, 0},\r\n{0x10B, 0x0E, 0},\r\n{0x10E, 0x03, 0},\r\n{0x10F, 0x03, 0},\r\n{0x114, 0x13, 0},\r\n{0x115, 0x00, 0},\r\n{0x128, 0xFE, 0},\r\n{0x129, 0xFE, 0},\r\n{0x12A, 0xFE, 0},\r\n{0x12B, 0xDE, 0},\r\n{0x12C, 0xDE, 0},\r\n};\r\nint retval = 0;\r\nif (snd_pmic_ops_nc.card_status == SND_CARD_UN_INIT)\r\nretval = nc_init_card();\r\nif (retval)\r\nreturn retval;\r\nsst_sc_reg_access(sc_access, PMIC_WRITE, 14);\r\npr_debug("Voice parameters set successfully!!\n");\r\nreturn 0;\r\n}\r\nstatic int nc_set_pcm_audio_params(int sfreq, int word_size, int num_channel)\r\n{\r\nint config2 = 0;\r\nstruct sc_reg_access sc_access;\r\nint retval = 0;\r\nif (snd_pmic_ops_nc.card_status == SND_CARD_UN_INIT)\r\nretval = nc_init_card();\r\nif (retval)\r\nreturn retval;\r\nswitch (sfreq) {\r\ncase 8000:\r\nconfig2 = 0x00;\r\nbreak;\r\ncase 11025:\r\nconfig2 = 0x01;\r\nbreak;\r\ncase 12000:\r\nconfig2 = 0x02;\r\nbreak;\r\ncase 16000:\r\nconfig2 = 0x03;\r\nbreak;\r\ncase 22050:\r\nconfig2 = 0x04;\r\nbreak;\r\ncase 24000:\r\nconfig2 = 0x05;\r\nbreak;\r\ncase 32000:\r\nconfig2 = 0x07;\r\nbreak;\r\ncase 44100:\r\nconfig2 = 0x08;\r\nbreak;\r\ncase 48000:\r\nconfig2 = 0x09;\r\nbreak;\r\n}\r\nsnd_pmic_ops_nc.num_channel = num_channel;\r\nif (snd_pmic_ops_nc.num_channel == 1) {\r\nsc_access.value = 0x07;\r\nsc_access.reg_addr = RMUTE;\r\npr_debug("RIGHT_HP_MUTE value%d\n", sc_access.value);\r\nsc_access.mask = MASK2;\r\nsst_sc_reg_access(&sc_access, PMIC_READ_MODIFY, 1);\r\n} else {\r\nsc_access.value = 0x00;\r\nsc_access.reg_addr = RMUTE;\r\npr_debug("RIGHT_HP_MUTE value %d\n", sc_access.value);\r\nsc_access.mask = MASK2;\r\nsst_sc_reg_access(&sc_access, PMIC_READ_MODIFY, 1);\r\n}\r\npr_debug("word_size = %d\n", word_size);\r\nif (word_size == 24) {\r\nsc_access.reg_addr = AUDIOPORT2;\r\nsc_access.value = config2 | 0x10;\r\nsc_access.mask = 0x1F;\r\n} else {\r\nsc_access.value = config2;\r\nsc_access.mask = 0x1F;\r\nsc_access.reg_addr = AUDIOPORT2;\r\n}\r\nsst_sc_reg_access(&sc_access, PMIC_READ_MODIFY, 1);\r\npr_debug("word_size = %d\n", word_size);\r\nsc_access.reg_addr = AUDIOPORT1;\r\nsc_access.mask = MASK5|MASK4|MASK1|MASK0;\r\nif (word_size == 16)\r\nsc_access.value = 0x98;\r\nelse if (word_size == 24)\r\nsc_access.value = 0xAB;\r\nreturn sst_sc_reg_access(&sc_access, PMIC_READ_MODIFY, 1);\r\n}\r\nstatic int nc_set_selected_output_dev(u8 value)\r\n{\r\nstruct sc_reg_access sc_access_HP[] = {\r\n{LMUTE, 0x02, 0x06},\r\n{RMUTE, 0x02, 0x06},\r\n{DRVPOWERCTRL, 0x06, 0x06},\r\n};\r\nstruct sc_reg_access sc_access_IS[] = {\r\n{LMUTE, 0x04, 0x06},\r\n{RMUTE, 0x04, 0x06},\r\n{DRVPOWERCTRL, 0x00, 0x06},\r\n};\r\nint retval = 0;\r\nsnd_pmic_ops_nc.output_dev_id = value;\r\nif (snd_pmic_ops_nc.card_status == SND_CARD_UN_INIT)\r\nretval = nc_init_card();\r\nif (retval)\r\nreturn retval;\r\npr_debug("nc set selected output:%d\n", value);\r\nmutex_lock(&snd_pmic_ops_nc.lock);\r\nswitch (value) {\r\ncase STEREO_HEADPHONE:\r\nif (snd_pmic_ops_nc.pb_on)\r\nsst_sc_reg_access(sc_access_HP+2, PMIC_WRITE, 1);\r\nretval = sst_sc_reg_access(sc_access_HP, PMIC_WRITE, 2);\r\nnc_set_amp_power(0);\r\nbreak;\r\ncase MONO_EARPIECE:\r\ncase INTERNAL_SPKR:\r\nretval = sst_sc_reg_access(sc_access_IS, PMIC_WRITE, 3);\r\nif (snd_pmic_ops_nc.pb_on)\r\nnc_set_amp_power(1);\r\nbreak;\r\ndefault:\r\npr_err("rcvd illegal request: %d\n", value);\r\nmutex_unlock(&snd_pmic_ops_nc.lock);\r\nreturn -EINVAL;\r\n}\r\nmutex_unlock(&snd_pmic_ops_nc.lock);\r\nreturn retval;\r\n}\r\nstatic int nc_audio_init(void)\r\n{\r\nstruct sc_reg_access sc_acces, sc_access[] = {\r\n{0x100, 0x00, 0},\r\n{0x101, 0x00, 0},\r\n{0x104, 0x8B, 0},\r\n{0x107, 0x11, 0},\r\n{0x10B, 0x0E, 0},\r\n{0x114, 0x00, 0},\r\n{0x115, 0x00, 0},\r\n{0x128, 0x00, 0},\r\n{0x129, 0x00, 0},\r\n{0x12A, 0x00, 0},\r\n{0x12B, 0xee, 0},\r\n{0x12C, 0xf6, 0},\r\n};\r\nsst_sc_reg_access(sc_access, PMIC_WRITE, 12);\r\npr_debug("Audio Init successfully!!\n");\r\nnc_set_selected_output_dev(snd_pmic_ops_nc.output_dev_id);\r\nif (snd_pmic_ops_nc.num_channel == 1) {\r\nsc_acces.value = 0x07;\r\nsc_acces.reg_addr = RMUTE;\r\npr_debug("RIGHT_HP_MUTE value%d\n", sc_acces.value);\r\nsc_acces.mask = MASK2;\r\nsst_sc_reg_access(&sc_acces, PMIC_READ_MODIFY, 1);\r\n} else {\r\nsc_acces.value = 0x00;\r\nsc_acces.reg_addr = RMUTE;\r\npr_debug("RIGHT_HP_MUTE value%d\n", sc_acces.value);\r\nsc_acces.mask = MASK2;\r\nsst_sc_reg_access(&sc_acces, PMIC_READ_MODIFY, 1);\r\n}\r\nreturn 0;\r\n}\r\nstatic int nc_set_audio_port(int status)\r\n{\r\nstruct sc_reg_access sc_access[2] = {{0,},};\r\nint retval = 0;\r\nif (snd_pmic_ops_nc.card_status == SND_CARD_UN_INIT)\r\nretval = nc_init_card();\r\nif (retval)\r\nreturn retval;\r\nif (status == DEACTIVATE) {\r\nsc_access[0].value = 0x00;\r\nsc_access[0].mask = MASK4|MASK5;\r\nsc_access[0].reg_addr = AUDIOPORT1;\r\nreturn sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 1);\r\n} else if (status == ACTIVATE) {\r\nnc_audio_init();\r\nsc_access[0].value = 0x10;\r\nsc_access[0].mask = MASK4|MASK5 ;\r\nsc_access[0].reg_addr = AUDIOPORT1;\r\nreturn sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 1);\r\n} else\r\nreturn -EINVAL;\r\n}\r\nstatic int nc_set_voice_port(int status)\r\n{\r\nstruct sc_reg_access sc_access[2] = {{0,},};\r\nint retval = 0;\r\nif (snd_pmic_ops_nc.card_status == SND_CARD_UN_INIT)\r\nretval = nc_init_card();\r\nif (retval)\r\nreturn retval;\r\nif (status == DEACTIVATE) {\r\nsc_access[0].value = 0x00;\r\nsc_access[0].mask = MASK4;\r\nsc_access[0].reg_addr = VOICEPORT1;\r\nreturn sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 1);\r\n} else if (status == ACTIVATE) {\r\nnc_set_pcm_voice_params();\r\nsc_access[0].value = 0x10;\r\nsc_access[0].mask = MASK4;\r\nsc_access[0].reg_addr = VOICEPORT1;\r\nreturn sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 1);\r\n} else\r\nreturn -EINVAL;\r\n}\r\nstatic int nc_set_mute(int dev_id, u8 value)\r\n{\r\nstruct sc_reg_access sc_access[3];\r\nu8 mute_val, cap_mute;\r\nint retval = 0;\r\nif (snd_pmic_ops_nc.card_status == SND_CARD_UN_INIT)\r\nretval = nc_init_card();\r\nif (retval)\r\nreturn retval;\r\npr_debug("set device id::%d, value %d\n", dev_id, value);\r\nswitch (dev_id) {\r\ncase PMIC_SND_MUTE_ALL:\r\npr_debug("PMIC_SND_MUTE_ALL value %d\n", value);\r\nsnd_pmic_ops_nc.mute_status = value;\r\nsnd_pmic_ops_nc.master_mute = value;\r\nif (value == UNMUTE) {\r\nmute_val = cap_mute = 0x00;\r\n} else {\r\nmute_val = 0x80;\r\ncap_mute = 0x40;\r\n}\r\nsc_access[0].reg_addr = AUDIOLVOL;\r\nsc_access[1].reg_addr = AUDIORVOL;\r\nsc_access[0].mask = sc_access[1].mask = MASK7;\r\nsc_access[0].value = sc_access[1].value = mute_val;\r\nif (snd_pmic_ops_nc.num_channel == 1)\r\nsc_access[1].value = 0x80;\r\nif (!sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 2)) {\r\nsc_access[0].reg_addr = 0x109;\r\nsc_access[1].reg_addr = 0x10a;\r\nsc_access[2].reg_addr = 0x105;\r\nsc_access[0].mask = sc_access[1].mask =\r\nsc_access[2].mask = MASK6;\r\nsc_access[0].value = sc_access[1].value =\r\nsc_access[2].value = cap_mute;\r\nif ((snd_pmic_ops_nc.input_dev_id == AMIC) ||\r\n(snd_pmic_ops_nc.input_dev_id == DMIC))\r\nsc_access[1].value = 0x40;\r\nif (snd_pmic_ops_nc.input_dev_id == HS_MIC)\r\nsc_access[0].value = 0x40;\r\nretval = sst_sc_reg_access(sc_access,\r\nPMIC_READ_MODIFY, 3);\r\n}\r\nbreak;\r\ncase PMIC_SND_HP_MIC_MUTE:\r\npr_debug("PMIC_SND_HPMIC_MUTE value %d\n", value);\r\nif (value == UNMUTE) {\r\nsc_access[0].value = 0x00;\r\n} else {\r\nsc_access[0].value = 0x40;\r\n}\r\nsc_access[0].reg_addr = LIRSEL;\r\nsc_access[0].mask = MASK6;\r\nretval = sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 1);\r\nbreak;\r\ncase PMIC_SND_AMIC_MUTE:\r\npr_debug("PMIC_SND_AMIC_MUTE value %d\n", value);\r\nif (value == UNMUTE) {\r\nsc_access[0].value = 0x00;\r\n} else {\r\nsc_access[0].value = 0x40;\r\n}\r\nsc_access[0].reg_addr = LILSEL;\r\nsc_access[0].mask = MASK6;\r\nretval = sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 1);\r\nbreak;\r\ncase PMIC_SND_DMIC_MUTE:\r\npr_debug("INPUT_MUTE_DMIC value%d\n", value);\r\nif (value == UNMUTE) {\r\nsc_access[1].value = 0x00;\r\nsc_access[0].value = 0x00;\r\n} else {\r\nsc_access[1].value = 0x40;\r\nsc_access[0].value = 0x40;\r\n}\r\nsc_access[0].reg_addr = DMICCTRL1;\r\nsc_access[0].mask = MASK6;\r\nsc_access[1].reg_addr = LILSEL;\r\nsc_access[1].mask = MASK6;\r\nretval = sst_sc_reg_access(sc_access,\r\nPMIC_READ_MODIFY, 2);\r\nbreak;\r\ncase PMIC_SND_LEFT_HP_MUTE:\r\ncase PMIC_SND_RIGHT_HP_MUTE:\r\nsnd_pmic_ops_nc.mute_status = value;\r\nif (value == UNMUTE)\r\nsc_access[0].value = 0x0;\r\nelse\r\nsc_access[0].value = 0x04;\r\nif (dev_id == PMIC_SND_LEFT_HP_MUTE) {\r\nsc_access[0].reg_addr = LMUTE;\r\npr_debug("LEFT_HP_MUTE value %d\n",\r\nsc_access[0].value);\r\n} else {\r\nif (snd_pmic_ops_nc.num_channel == 1)\r\nsc_access[0].value = 0x04;\r\nsc_access[0].reg_addr = RMUTE;\r\npr_debug("RIGHT_HP_MUTE value %d\n",\r\nsc_access[0].value);\r\n}\r\nsc_access[0].mask = MASK2;\r\nretval = sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 1);\r\nbreak;\r\ncase PMIC_SND_LEFT_SPEAKER_MUTE:\r\ncase PMIC_SND_RIGHT_SPEAKER_MUTE:\r\nif (value == UNMUTE)\r\nsc_access[0].value = 0x00;\r\nelse\r\nsc_access[0].value = 0x03;\r\nsc_access[0].reg_addr = LMUTE;\r\npr_debug("SPEAKER_MUTE %d\n", sc_access[0].value);\r\nsc_access[0].mask = MASK1;\r\nretval = sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, 1);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn retval ;\r\n}\r\nstatic int nc_set_vol(int dev_id, int value)\r\n{\r\nstruct sc_reg_access sc_access[3];\r\nint retval = 0, entries = 0;\r\nif (snd_pmic_ops_nc.card_status == SND_CARD_UN_INIT)\r\nretval = nc_init_card();\r\nif (retval)\r\nreturn retval;\r\npr_debug("set volume:%d\n", dev_id);\r\nswitch (dev_id) {\r\ncase PMIC_SND_CAPTURE_VOL:\r\npr_debug("PMIC_SND_CAPTURE_VOL:value::%d\n", value);\r\nsc_access[0].value = sc_access[1].value =\r\nsc_access[2].value = -value;\r\nsc_access[0].mask = sc_access[1].mask = sc_access[2].mask =\r\n(MASK0|MASK1|MASK2|MASK3|MASK4|MASK5);\r\nsc_access[0].reg_addr = 0x10a;\r\nsc_access[1].reg_addr = 0x109;\r\nsc_access[2].reg_addr = 0x105;\r\nentries = 3;\r\nbreak;\r\ncase PMIC_SND_LEFT_PB_VOL:\r\npr_debug("PMIC_SND_LEFT_HP_VOL %d\n", value);\r\nsc_access[0].value = -value;\r\nsc_access[0].reg_addr = HPLVOL;\r\nsc_access[0].mask = (MASK0|MASK1|MASK2|MASK3|MASK4);\r\nentries = 1;\r\nbreak;\r\ncase PMIC_SND_RIGHT_PB_VOL:\r\npr_debug("PMIC_SND_RIGHT_HP_VOL value %d\n", value);\r\nif (snd_pmic_ops_nc.num_channel == 1) {\r\nsc_access[0].value = 0x04;\r\nsc_access[0].reg_addr = RMUTE;\r\nsc_access[0].mask = MASK2;\r\n} else {\r\nsc_access[0].value = -value;\r\nsc_access[0].reg_addr = HPRVOL;\r\nsc_access[0].mask = (MASK0|MASK1|MASK2|MASK3|MASK4);\r\n}\r\nentries = 1;\r\nbreak;\r\ncase PMIC_SND_LEFT_MASTER_VOL:\r\npr_debug("PMIC_SND_LEFT_MASTER_VOL value %d\n", value);\r\nsc_access[0].value = -value;\r\nsc_access[0].reg_addr = AUDIOLVOL;\r\nsc_access[0].mask =\r\n(MASK0|MASK1|MASK2|MASK3|MASK4|MASK5|MASK6);\r\nentries = 1;\r\nbreak;\r\ncase PMIC_SND_RIGHT_MASTER_VOL:\r\npr_debug("PMIC_SND_RIGHT_MASTER_VOL value %d\n", value);\r\nsc_access[0].value = -value;\r\nsc_access[0].reg_addr = AUDIORVOL;\r\nsc_access[0].mask =\r\n(MASK0|MASK1|MASK2|MASK3|MASK4|MASK5|MASK6);\r\nentries = 1;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, entries);\r\n}\r\nstatic int nc_set_selected_input_dev(u8 value)\r\n{\r\nstruct sc_reg_access sc_access[6];\r\nu8 num_val;\r\nint retval = 0;\r\nif (snd_pmic_ops_nc.card_status == SND_CARD_UN_INIT)\r\nretval = nc_init_card();\r\nif (retval)\r\nreturn retval;\r\nsnd_pmic_ops_nc.input_dev_id = value;\r\npr_debug("nc set selected input:%d\n", value);\r\nswitch (value) {\r\ncase AMIC:\r\npr_debug("Selecting AMIC\n");\r\nsc_access[0].reg_addr = 0x107;\r\nsc_access[0].value = 0x40;\r\nsc_access[0].mask = MASK6|MASK3|MASK1|MASK0;\r\nsc_access[1].reg_addr = 0x10a;\r\nsc_access[1].value = 0x40;\r\nsc_access[1].mask = MASK6;\r\nsc_access[2].reg_addr = 0x109;\r\nsc_access[2].value = 0x00;\r\nsc_access[2].mask = MASK6;\r\nsc_access[3].reg_addr = 0x105;\r\nsc_access[3].value = 0x40;\r\nsc_access[3].mask = MASK6;\r\nnum_val = 4;\r\nbreak;\r\ncase HS_MIC:\r\npr_debug("Selecting HS_MIC\n");\r\nsc_access[0].reg_addr = MICCTRL;\r\nsc_access[0].mask = MASK6|MASK3|MASK1|MASK0;\r\nsc_access[0].value = 0x00;\r\nsc_access[1].reg_addr = 0x109;\r\nsc_access[1].mask = MASK6;\r\nsc_access[1].value = 0x40;\r\nsc_access[2].reg_addr = 0x10a;\r\nsc_access[2].mask = MASK6;\r\nsc_access[2].value = 0x00;\r\nsc_access[3].reg_addr = 0x105;\r\nsc_access[3].value = 0x40;\r\nsc_access[3].mask = MASK6;\r\nsc_access[4].reg_addr = ADCSAMPLERATE;\r\nsc_access[4].mask = MASK7|MASK6|MASK5|MASK4|MASK3;\r\nsc_access[4].value = 0xc8;\r\nnum_val = 5;\r\nbreak;\r\ncase DMIC:\r\npr_debug("DMIC\n");\r\nsc_access[0].reg_addr = MICCTRL;\r\nsc_access[0].mask = MASK6|MASK3|MASK1|MASK0;\r\nsc_access[0].value = 0x0B;\r\nsc_access[1].reg_addr = 0x105;\r\nsc_access[1].value = 0x80;\r\nsc_access[1].mask = MASK7|MASK6;\r\nsc_access[2].reg_addr = 0x10a;\r\nsc_access[2].value = 0x40;\r\nsc_access[2].mask = MASK6;\r\nsc_access[3].reg_addr = LILSEL;\r\nsc_access[3].mask = MASK6;\r\nsc_access[3].value = 0x00;\r\nsc_access[4].reg_addr = ADCSAMPLERATE;\r\nsc_access[4].mask = MASK7|MASK6|MASK5|MASK4|MASK3;\r\nsc_access[4].value = 0x33;\r\nnum_val = 5;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn sst_sc_reg_access(sc_access, PMIC_READ_MODIFY, num_val);\r\n}\r\nstatic int nc_get_mute(int dev_id, u8 *value)\r\n{\r\nint retval = 0, mask = 0;\r\nstruct sc_reg_access sc_access = {0,};\r\nif (snd_pmic_ops_nc.card_status == SND_CARD_UN_INIT)\r\nretval = nc_init_card();\r\nif (retval)\r\nreturn retval;\r\npr_debug("get mute::%d\n", dev_id);\r\nswitch (dev_id) {\r\ncase PMIC_SND_AMIC_MUTE:\r\npr_debug("PMIC_SND_INPUT_MUTE_MIC1\n");\r\nsc_access.reg_addr = LILSEL;\r\nmask = MASK6;\r\nbreak;\r\ncase PMIC_SND_HP_MIC_MUTE:\r\npr_debug("PMIC_SND_INPUT_MUTE_MIC2\n");\r\nsc_access.reg_addr = LIRSEL;\r\nmask = MASK6;\r\nbreak;\r\ncase PMIC_SND_LEFT_HP_MUTE:\r\ncase PMIC_SND_RIGHT_HP_MUTE:\r\nmask = MASK2;\r\npr_debug("PMIC_SN_LEFT/RIGHT_HP_MUTE\n");\r\nif (dev_id == PMIC_SND_RIGHT_HP_MUTE)\r\nsc_access.reg_addr = RMUTE;\r\nelse\r\nsc_access.reg_addr = LMUTE;\r\nbreak;\r\ncase PMIC_SND_LEFT_SPEAKER_MUTE:\r\npr_debug("PMIC_MONO_EARPIECE_MUTE\n");\r\nsc_access.reg_addr = RMUTE;\r\nmask = MASK1;\r\nbreak;\r\ncase PMIC_SND_DMIC_MUTE:\r\npr_debug("PMIC_SND_INPUT_MUTE_DMIC\n");\r\nsc_access.reg_addr = 0x105;\r\nmask = MASK6;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nretval = sst_sc_reg_access(&sc_access, PMIC_READ, 1);\r\npr_debug("reg value = %d\n", sc_access.value);\r\nif (retval)\r\nreturn retval;\r\n*value = (sc_access.value) & mask;\r\npr_debug("masked value = %d\n", *value);\r\nif (*value)\r\n*value = 0;\r\nelse\r\n*value = 1;\r\npr_debug("value returned = 0x%x\n", *value);\r\nreturn retval;\r\n}\r\nstatic int nc_get_vol(int dev_id, int *value)\r\n{\r\nint retval = 0, mask = 0;\r\nstruct sc_reg_access sc_access = {0,};\r\nif (snd_pmic_ops_nc.card_status == SND_CARD_UN_INIT)\r\nretval = nc_init_card();\r\nif (retval)\r\nreturn retval;\r\nswitch (dev_id) {\r\ncase PMIC_SND_CAPTURE_VOL:\r\npr_debug("PMIC_SND_INPUT_CAPTURE_VOL\n");\r\nsc_access.reg_addr = LILSEL;\r\nmask = (MASK0|MASK1|MASK2|MASK3|MASK4|MASK5);\r\nbreak;\r\ncase PMIC_SND_LEFT_MASTER_VOL:\r\npr_debug("GET_VOLUME_PMIC_LEFT_MASTER_VOL\n");\r\nsc_access.reg_addr = AUDIOLVOL;\r\nmask = (MASK0|MASK1|MASK2|MASK3|MASK4|MASK5|MASK6);\r\nbreak;\r\ncase PMIC_SND_RIGHT_MASTER_VOL:\r\npr_debug("GET_VOLUME_PMIC_RIGHT_MASTER_VOL\n");\r\nsc_access.reg_addr = AUDIORVOL;\r\nmask = (MASK0|MASK1|MASK2|MASK3|MASK4|MASK5|MASK6);\r\nbreak;\r\ncase PMIC_SND_RIGHT_PB_VOL:\r\npr_debug("GET_VOLUME_PMIC_RIGHT_HP_VOL\n");\r\nsc_access.reg_addr = HPRVOL;\r\nmask = (MASK0|MASK1|MASK2|MASK3|MASK4);\r\nbreak;\r\ncase PMIC_SND_LEFT_PB_VOL:\r\npr_debug("GET_VOLUME_PMIC_LEFT_HP_VOL\n");\r\nsc_access.reg_addr = HPLVOL;\r\nmask = (MASK0|MASK1|MASK2|MASK3|MASK4);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nretval = sst_sc_reg_access(&sc_access, PMIC_READ, 1);\r\npr_debug("value read = 0x%x\n", sc_access.value);\r\n*value = -((sc_access.value) & mask);\r\npr_debug("get vol value returned = %d\n", *value);\r\nreturn retval;\r\n}\r\nstatic void hp_automute(enum snd_jack_types type, int present)\r\n{\r\nu8 in = DMIC;\r\nu8 out = INTERNAL_SPKR;\r\nif (present) {\r\nif (type == SND_JACK_HEADSET)\r\nin = HS_MIC;\r\nout = STEREO_HEADPHONE;\r\n}\r\nnc_set_selected_input_dev(in);\r\nnc_set_selected_output_dev(out);\r\n}\r\nstatic void nc_pmic_irq_cb(void *cb_data, u8 intsts)\r\n{\r\nu8 value = 0;\r\nstruct mad_jack *mjack = NULL;\r\nunsigned int present = 0, jack_event_flag = 0, buttonpressflag = 0;\r\nstruct snd_intelmad *intelmaddata = cb_data;\r\nstruct sc_reg_access sc_access_read = {0,};\r\nsc_access_read.reg_addr = 0x132;\r\nsst_sc_reg_access(&sc_access_read, PMIC_READ, 1);\r\nvalue = (sc_access_read.value);\r\npr_debug("value returned = 0x%x\n", value);\r\nmjack = &intelmaddata->jack[0];\r\nif (intsts & 0x1) {\r\npr_debug("SST DBG:MAD headset detected\n");\r\npresent = (value == 0x1) ? 3 : 0;\r\njack_event_flag = 1;\r\nmjack->jack.type = SND_JACK_HEADSET;\r\nhp_automute(SND_JACK_HEADSET, present);\r\n}\r\nif (intsts & 0x2) {\r\npr_debug(":MAD headphone detected\n");\r\npresent = (value == 0x2) ? 1 : 0;\r\njack_event_flag = 1;\r\nmjack->jack.type = SND_JACK_HEADPHONE;\r\nhp_automute(SND_JACK_HEADPHONE, present);\r\n}\r\nif (intsts & 0x4) {\r\npr_debug("MAD short push detected\n");\r\npresent = 1;\r\njack_event_flag = 1;\r\nbuttonpressflag = 1;\r\nmjack->jack.type = MID_JACK_HS_SHORT_PRESS;\r\n}\r\nif (intsts & 0x8) {\r\npr_debug(":MAD long push detected\n");\r\npresent = 1;\r\njack_event_flag = 1;\r\nbuttonpressflag = 1;\r\nmjack->jack.type = MID_JACK_HS_LONG_PRESS;\r\n}\r\nif (jack_event_flag)\r\nsst_mad_send_jack_report(&mjack->jack,\r\nbuttonpressflag, present);\r\n}\r\nstatic int nc_jack_enable(void)\r\n{\r\nreturn 0;\r\n}

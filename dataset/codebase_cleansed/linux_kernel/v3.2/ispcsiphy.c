static void csiphy_lanes_config(struct isp_csiphy *phy)\r\n{\r\nunsigned int i;\r\nu32 reg;\r\nreg = isp_reg_readl(phy->isp, phy->cfg_regs, ISPCSI2_PHY_CFG);\r\nfor (i = 0; i < phy->num_data_lanes; i++) {\r\nreg &= ~(ISPCSI2_PHY_CFG_DATA_POL_MASK(i + 1) |\r\nISPCSI2_PHY_CFG_DATA_POSITION_MASK(i + 1));\r\nreg |= (phy->lanes.data[i].pol <<\r\nISPCSI2_PHY_CFG_DATA_POL_SHIFT(i + 1));\r\nreg |= (phy->lanes.data[i].pos <<\r\nISPCSI2_PHY_CFG_DATA_POSITION_SHIFT(i + 1));\r\n}\r\nreg &= ~(ISPCSI2_PHY_CFG_CLOCK_POL_MASK |\r\nISPCSI2_PHY_CFG_CLOCK_POSITION_MASK);\r\nreg |= phy->lanes.clk.pol << ISPCSI2_PHY_CFG_CLOCK_POL_SHIFT;\r\nreg |= phy->lanes.clk.pos << ISPCSI2_PHY_CFG_CLOCK_POSITION_SHIFT;\r\nisp_reg_writel(phy->isp, reg, phy->cfg_regs, ISPCSI2_PHY_CFG);\r\n}\r\nstatic void csiphy_power_autoswitch_enable(struct isp_csiphy *phy, bool enable)\r\n{\r\nisp_reg_clr_set(phy->isp, phy->cfg_regs, ISPCSI2_PHY_CFG,\r\nISPCSI2_PHY_CFG_PWR_AUTO,\r\nenable ? ISPCSI2_PHY_CFG_PWR_AUTO : 0);\r\n}\r\nstatic int csiphy_set_power(struct isp_csiphy *phy, u32 power)\r\n{\r\nu32 reg;\r\nu8 retry_count;\r\nisp_reg_clr_set(phy->isp, phy->cfg_regs, ISPCSI2_PHY_CFG,\r\nISPCSI2_PHY_CFG_PWR_CMD_MASK, power);\r\nretry_count = 0;\r\ndo {\r\nudelay(50);\r\nreg = isp_reg_readl(phy->isp, phy->cfg_regs, ISPCSI2_PHY_CFG) &\r\nISPCSI2_PHY_CFG_PWR_STATUS_MASK;\r\nif (reg != power >> 2)\r\nretry_count++;\r\n} while ((reg != power >> 2) && (retry_count < 100));\r\nif (retry_count == 100) {\r\nprintk(KERN_ERR "CSI2 CIO set power failed!\n");\r\nreturn -EBUSY;\r\n}\r\nreturn 0;\r\n}\r\nstatic void csiphy_dphy_config(struct isp_csiphy *phy)\r\n{\r\nu32 reg;\r\nreg = isp_reg_readl(phy->isp, phy->phy_regs, ISPCSIPHY_REG0);\r\nreg &= ~(ISPCSIPHY_REG0_THS_TERM_MASK |\r\nISPCSIPHY_REG0_THS_SETTLE_MASK);\r\nreg |= phy->dphy.ths_term << ISPCSIPHY_REG0_THS_TERM_SHIFT;\r\nreg |= phy->dphy.ths_settle << ISPCSIPHY_REG0_THS_SETTLE_SHIFT;\r\nisp_reg_writel(phy->isp, reg, phy->phy_regs, ISPCSIPHY_REG0);\r\nreg = isp_reg_readl(phy->isp, phy->phy_regs, ISPCSIPHY_REG1);\r\nreg &= ~(ISPCSIPHY_REG1_TCLK_TERM_MASK |\r\nISPCSIPHY_REG1_TCLK_MISS_MASK |\r\nISPCSIPHY_REG1_TCLK_SETTLE_MASK);\r\nreg |= phy->dphy.tclk_term << ISPCSIPHY_REG1_TCLK_TERM_SHIFT;\r\nreg |= phy->dphy.tclk_miss << ISPCSIPHY_REG1_TCLK_MISS_SHIFT;\r\nreg |= phy->dphy.tclk_settle << ISPCSIPHY_REG1_TCLK_SETTLE_SHIFT;\r\nisp_reg_writel(phy->isp, reg, phy->phy_regs, ISPCSIPHY_REG1);\r\n}\r\nstatic int csiphy_config(struct isp_csiphy *phy,\r\nstruct isp_csiphy_dphy_cfg *dphy,\r\nstruct isp_csiphy_lanes_cfg *lanes)\r\n{\r\nunsigned int used_lanes = 0;\r\nunsigned int i;\r\nfor (i = 0; i < phy->num_data_lanes; i++) {\r\nif (lanes->data[i].pol > 1 || lanes->data[i].pos > 3)\r\nreturn -EINVAL;\r\nif (used_lanes & (1 << lanes->data[i].pos))\r\nreturn -EINVAL;\r\nused_lanes |= 1 << lanes->data[i].pos;\r\n}\r\nif (lanes->clk.pol > 1 || lanes->clk.pos > 3)\r\nreturn -EINVAL;\r\nif (lanes->clk.pos == 0 || used_lanes & (1 << lanes->clk.pos))\r\nreturn -EINVAL;\r\nmutex_lock(&phy->mutex);\r\nphy->dphy = *dphy;\r\nphy->lanes = *lanes;\r\nmutex_unlock(&phy->mutex);\r\nreturn 0;\r\n}\r\nint omap3isp_csiphy_acquire(struct isp_csiphy *phy)\r\n{\r\nint rval;\r\nif (phy->vdd == NULL) {\r\ndev_err(phy->isp->dev, "Power regulator for CSI PHY not "\r\n"available\n");\r\nreturn -ENODEV;\r\n}\r\nmutex_lock(&phy->mutex);\r\nrval = regulator_enable(phy->vdd);\r\nif (rval < 0)\r\ngoto done;\r\nomap3isp_csi2_reset(phy->csi2);\r\ncsiphy_dphy_config(phy);\r\ncsiphy_lanes_config(phy);\r\nrval = csiphy_set_power(phy, ISPCSI2_PHY_CFG_PWR_CMD_ON);\r\nif (rval) {\r\nregulator_disable(phy->vdd);\r\ngoto done;\r\n}\r\ncsiphy_power_autoswitch_enable(phy, true);\r\nphy->phy_in_use = 1;\r\ndone:\r\nmutex_unlock(&phy->mutex);\r\nreturn rval;\r\n}\r\nvoid omap3isp_csiphy_release(struct isp_csiphy *phy)\r\n{\r\nmutex_lock(&phy->mutex);\r\nif (phy->phy_in_use) {\r\ncsiphy_power_autoswitch_enable(phy, false);\r\ncsiphy_set_power(phy, ISPCSI2_PHY_CFG_PWR_CMD_OFF);\r\nregulator_disable(phy->vdd);\r\nphy->phy_in_use = 0;\r\n}\r\nmutex_unlock(&phy->mutex);\r\n}\r\nint omap3isp_csiphy_init(struct isp_device *isp)\r\n{\r\nstruct isp_csiphy *phy1 = &isp->isp_csiphy1;\r\nstruct isp_csiphy *phy2 = &isp->isp_csiphy2;\r\nisp->platform_cb.csiphy_config = csiphy_config;\r\nphy2->isp = isp;\r\nphy2->csi2 = &isp->isp_csi2a;\r\nphy2->num_data_lanes = ISP_CSIPHY2_NUM_DATA_LANES;\r\nphy2->cfg_regs = OMAP3_ISP_IOMEM_CSI2A_REGS1;\r\nphy2->phy_regs = OMAP3_ISP_IOMEM_CSIPHY2;\r\nmutex_init(&phy2->mutex);\r\nif (isp->revision == ISP_REVISION_15_0) {\r\nphy1->isp = isp;\r\nphy1->csi2 = &isp->isp_csi2c;\r\nphy1->num_data_lanes = ISP_CSIPHY1_NUM_DATA_LANES;\r\nphy1->cfg_regs = OMAP3_ISP_IOMEM_CSI2C_REGS1;\r\nphy1->phy_regs = OMAP3_ISP_IOMEM_CSIPHY1;\r\nmutex_init(&phy1->mutex);\r\n}\r\nreturn 0;\r\n}

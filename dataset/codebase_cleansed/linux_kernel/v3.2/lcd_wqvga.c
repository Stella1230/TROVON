static unsigned long read_reg(void *sohandle,\r\nstruct sh_mobile_lcdc_sys_bus_ops *so)\r\n{\r\nreturn so->read_data(sohandle);\r\n}\r\nstatic void write_reg(void *sohandle,\r\nstruct sh_mobile_lcdc_sys_bus_ops *so,\r\nint i, unsigned long v)\r\n{\r\nif (i)\r\nso->write_data(sohandle, v);\r\nelse\r\nso->write_index(sohandle, v);\r\n}\r\nstatic void write_data(void *sohandle,\r\nstruct sh_mobile_lcdc_sys_bus_ops *so,\r\nunsigned char const *data, int no_data)\r\n{\r\nint i;\r\nfor (i = 0; i < no_data; i++)\r\nwrite_reg(sohandle, so, 1, data[i]);\r\n}\r\nstatic unsigned long read_device_code(void *sohandle,\r\nstruct sh_mobile_lcdc_sys_bus_ops *so)\r\n{\r\nunsigned long device_code;\r\nwrite_reg(sohandle, so, 0, 0xb0);\r\nwrite_reg(sohandle, so, 1, 0x00);\r\nwrite_reg(sohandle, so, 0, 0xb1);\r\nwrite_reg(sohandle, so, 1, 0x00);\r\nwrite_reg(sohandle, so, 0, 0xbf);\r\nmdelay(50);\r\nread_reg(sohandle, so);\r\ndevice_code = ((read_reg(sohandle, so) & 0xff) << 24);\r\ndevice_code |= ((read_reg(sohandle, so) & 0xff) << 16);\r\ndevice_code |= ((read_reg(sohandle, so) & 0xff) << 8);\r\ndevice_code |= (read_reg(sohandle, so) & 0xff);\r\nreturn device_code;\r\n}\r\nstatic void write_memory_start(void *sohandle,\r\nstruct sh_mobile_lcdc_sys_bus_ops *so)\r\n{\r\nwrite_reg(sohandle, so, 0, 0x2c);\r\n}\r\nstatic void clear_memory(void *sohandle,\r\nstruct sh_mobile_lcdc_sys_bus_ops *so)\r\n{\r\nint i;\r\nwrite_memory_start(sohandle, so);\r\nfor (i = 0; i < (240 * 400); i++)\r\nwrite_reg(sohandle, so, 1, 0x00);\r\n}\r\nstatic void display_on(void *sohandle,\r\nstruct sh_mobile_lcdc_sys_bus_ops *so)\r\n{\r\nwrite_reg(sohandle, so, 0, 0xb0);\r\nwrite_reg(sohandle, so, 1, 0x00);\r\nwrite_reg(sohandle, so, 0, 0xb1);\r\nwrite_reg(sohandle, so, 1, 0x00);\r\nwrite_reg(sohandle, so, 0, 0xb3);\r\nwrite_data(sohandle, so, data_frame_if, ARRAY_SIZE(data_frame_if));\r\nwrite_reg(sohandle, so, 0, 0xb4);\r\nwrite_reg(sohandle, so, 1, 0x00);\r\nwrite_reg(sohandle, so, 0, 0xc0);\r\nwrite_data(sohandle, so, data_panel, ARRAY_SIZE(data_panel));\r\nwrite_reg(sohandle, so, 0, 0xc1);\r\nwrite_data(sohandle, so, data_timing, ARRAY_SIZE(data_timing));\r\nwrite_reg(sohandle, so, 0, 0xc2);\r\nwrite_data(sohandle, so, data_timing, ARRAY_SIZE(data_timing));\r\nwrite_reg(sohandle, so, 0, 0xc3);\r\nwrite_data(sohandle, so, data_timing, ARRAY_SIZE(data_timing));\r\nwrite_reg(sohandle, so, 0, 0xc4);\r\nwrite_data(sohandle, so, data_timing_src, ARRAY_SIZE(data_timing_src));\r\nwrite_reg(sohandle, so, 0, 0xc8);\r\nwrite_data(sohandle, so, data_gamma, ARRAY_SIZE(data_gamma));\r\nwrite_reg(sohandle, so, 0, 0xc9);\r\nwrite_data(sohandle, so, data_gamma, ARRAY_SIZE(data_gamma));\r\nwrite_reg(sohandle, so, 0, 0xca);\r\nwrite_data(sohandle, so, data_gamma, ARRAY_SIZE(data_gamma));\r\nwrite_reg(sohandle, so, 0, 0xd0);\r\nwrite_data(sohandle, so, data_power, ARRAY_SIZE(data_power));\r\nwrite_reg(sohandle, so, 0, 0xd1);\r\nwrite_reg(sohandle, so, 1, 0x00);\r\nwrite_reg(sohandle, so, 1, 0x0f);\r\nwrite_reg(sohandle, so, 1, 0x02);\r\nwrite_reg(sohandle, so, 0, 0xd2);\r\nwrite_reg(sohandle, so, 1, 0x63);\r\nwrite_reg(sohandle, so, 1, 0x24);\r\nwrite_reg(sohandle, so, 0, 0xd3);\r\nwrite_reg(sohandle, so, 1, 0x63);\r\nwrite_reg(sohandle, so, 1, 0x24);\r\nwrite_reg(sohandle, so, 0, 0xd4);\r\nwrite_reg(sohandle, so, 1, 0x63);\r\nwrite_reg(sohandle, so, 1, 0x24);\r\nwrite_reg(sohandle, so, 0, 0xd8);\r\nwrite_reg(sohandle, so, 1, 0x77);\r\nwrite_reg(sohandle, so, 1, 0x77);\r\nwrite_reg(sohandle, so, 0, 0x35);\r\nwrite_reg(sohandle, so, 1, 0x00);\r\nwrite_reg(sohandle, so, 0, 0x44);\r\nwrite_reg(sohandle, so, 1, 0x00);\r\nwrite_reg(sohandle, so, 1, 0x00);\r\nwrite_reg(sohandle, so, 0, 0x2a);\r\nwrite_reg(sohandle, so, 1, 0x00);\r\nwrite_reg(sohandle, so, 1, 0x00);\r\nwrite_reg(sohandle, so, 1, 0x00);\r\nwrite_reg(sohandle, so, 1, 0xef);\r\nwrite_reg(sohandle, so, 0, 0x2b);\r\nwrite_reg(sohandle, so, 1, 0x00);\r\nwrite_reg(sohandle, so, 1, 0x00);\r\nwrite_reg(sohandle, so, 1, 0x01);\r\nwrite_reg(sohandle, so, 1, 0x8f);\r\nwrite_reg(sohandle, so, 0, 0x11);\r\nmdelay(120);\r\nclear_memory(sohandle, so);\r\nwrite_reg(sohandle, so, 0, 0x29);\r\nmdelay(1);\r\nwrite_memory_start(sohandle, so);\r\n}\r\nint kfr2r09_lcd_setup(void *board_data, void *sohandle,\r\nstruct sh_mobile_lcdc_sys_bus_ops *so)\r\n{\r\ngpio_set_value(GPIO_PTF4, 0);\r\ngpio_set_value(GPIO_PTE4, 0);\r\ngpio_set_value(GPIO_PTF4, 1);\r\nudelay(1100);\r\ngpio_set_value(GPIO_PTE4, 1);\r\nudelay(10);\r\ngpio_set_value(GPIO_PTF4, 0);\r\nmdelay(20);\r\nif (read_device_code(sohandle, so) != 0x01221517)\r\nreturn -ENODEV;\r\npr_info("KFR2R09 WQVGA LCD Module detected.\n");\r\ndisplay_on(sohandle, so);\r\nreturn 0;\r\n}\r\nvoid kfr2r09_lcd_start(void *board_data, void *sohandle,\r\nstruct sh_mobile_lcdc_sys_bus_ops *so)\r\n{\r\nwrite_memory_start(sohandle, so);\r\n}\r\nstatic int kfr2r09_lcd_backlight(int on)\r\n{\r\nstruct i2c_adapter *a;\r\nstruct i2c_msg msg;\r\nunsigned char buf[2];\r\nint ret;\r\na = i2c_get_adapter(0);\r\nif (!a)\r\nreturn -ENODEV;\r\nbuf[0] = 0x00;\r\nif (on)\r\nbuf[1] = CTRL_CPSW | CTRL_C10 | CTRL_CKSW;\r\nelse\r\nbuf[1] = 0;\r\nmsg.addr = 0x75;\r\nmsg.buf = buf;\r\nmsg.len = 2;\r\nmsg.flags = 0;\r\nret = i2c_transfer(a, &msg, 1);\r\nif (ret != 1)\r\nreturn -ENODEV;\r\nbuf[0] = 0x01;\r\nif (on)\r\nbuf[1] = MAIN_MSW | MAIN_MLED4 | 0x0c;\r\nelse\r\nbuf[1] = 0;\r\nmsg.addr = 0x75;\r\nmsg.buf = buf;\r\nmsg.len = 2;\r\nmsg.flags = 0;\r\nret = i2c_transfer(a, &msg, 1);\r\nif (ret != 1)\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nvoid kfr2r09_lcd_on(void *board_data, struct fb_info *info)\r\n{\r\nkfr2r09_lcd_backlight(1);\r\n}\r\nvoid kfr2r09_lcd_off(void *board_data)\r\n{\r\nkfr2r09_lcd_backlight(0);\r\n}

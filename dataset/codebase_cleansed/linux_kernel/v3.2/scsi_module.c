static int __init init_this_scsi_driver(void)\r\n{\r\nstruct scsi_host_template *sht = &driver_template;\r\nstruct Scsi_Host *shost;\r\nstruct list_head *l;\r\nint error;\r\nif (!sht->release) {\r\nprintk(KERN_ERR\r\n"scsi HBA driver %s didn't set a release method.\n",\r\nsht->name);\r\nreturn -EINVAL;\r\n}\r\nsht->module = THIS_MODULE;\r\nINIT_LIST_HEAD(&sht->legacy_hosts);\r\nsht->detect(sht);\r\nif (list_empty(&sht->legacy_hosts))\r\nreturn -ENODEV;\r\nlist_for_each_entry(shost, &sht->legacy_hosts, sht_legacy_list) {\r\nerror = scsi_add_host(shost, NULL);\r\nif (error)\r\ngoto fail;\r\nscsi_scan_host(shost);\r\n}\r\nreturn 0;\r\nfail:\r\nl = &shost->sht_legacy_list;\r\nwhile ((l = l->prev) != &sht->legacy_hosts)\r\nscsi_remove_host(list_entry(l, struct Scsi_Host, sht_legacy_list));\r\nreturn error;\r\n}\r\nstatic void __exit exit_this_scsi_driver(void)\r\n{\r\nstruct scsi_host_template *sht = &driver_template;\r\nstruct Scsi_Host *shost, *s;\r\nlist_for_each_entry(shost, &sht->legacy_hosts, sht_legacy_list)\r\nscsi_remove_host(shost);\r\nlist_for_each_entry_safe(shost, s, &sht->legacy_hosts, sht_legacy_list)\r\nsht->release(shost);\r\nif (list_empty(&sht->legacy_hosts))\r\nreturn;\r\nprintk(KERN_WARNING "%s did not call scsi_unregister\n", sht->name);\r\ndump_stack();\r\nlist_for_each_entry_safe(shost, s, &sht->legacy_hosts, sht_legacy_list)\r\nscsi_unregister(shost);\r\n}

static void pdc202xx_set_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nu8 drive_pci = 0x60 + (drive->dn << 2);\r\nconst u8 speed = drive->dma_mode;\r\nu8 AP = 0, BP = 0, CP = 0;\r\nu8 TA = 0, TB = 0, TC = 0;\r\npci_read_config_byte(dev, drive_pci, &AP);\r\npci_read_config_byte(dev, drive_pci + 1, &BP);\r\npci_read_config_byte(dev, drive_pci + 2, &CP);\r\nswitch(speed) {\r\ncase XFER_UDMA_5:\r\ncase XFER_UDMA_4: TB = 0x20; TC = 0x01; break;\r\ncase XFER_UDMA_2: TB = 0x20; TC = 0x01; break;\r\ncase XFER_UDMA_3:\r\ncase XFER_UDMA_1: TB = 0x40; TC = 0x02; break;\r\ncase XFER_UDMA_0:\r\ncase XFER_MW_DMA_2: TB = 0x60; TC = 0x03; break;\r\ncase XFER_MW_DMA_1: TB = 0x60; TC = 0x04; break;\r\ncase XFER_MW_DMA_0: TB = 0xE0; TC = 0x0F; break;\r\ncase XFER_PIO_4: TA = 0x01; TB = 0x04; break;\r\ncase XFER_PIO_3: TA = 0x02; TB = 0x06; break;\r\ncase XFER_PIO_2: TA = 0x03; TB = 0x08; break;\r\ncase XFER_PIO_1: TA = 0x05; TB = 0x0C; break;\r\ncase XFER_PIO_0:\r\ndefault: TA = 0x09; TB = 0x13; break;\r\n}\r\nif (speed < XFER_SW_DMA_0) {\r\nAP &= ~0x3f;\r\nif (ide_pio_need_iordy(drive, speed - XFER_PIO_0))\r\nAP |= 0x20;\r\nif (drive->media == ide_disk)\r\nAP |= 0x10;\r\nBP &= ~0x1f;\r\npci_write_config_byte(dev, drive_pci, AP | TA);\r\npci_write_config_byte(dev, drive_pci + 1, BP | TB);\r\n} else {\r\nBP &= ~0xe0;\r\nCP &= ~0x0f;\r\npci_write_config_byte(dev, drive_pci + 1, BP | TB);\r\npci_write_config_byte(dev, drive_pci + 2, CP | TC);\r\n}\r\n}\r\nstatic void pdc202xx_set_pio_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\ndrive->dma_mode = drive->pio_mode;\r\npdc202xx_set_mode(hwif, drive);\r\n}\r\nstatic int pdc202xx_test_irq(ide_hwif_t *hwif)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nunsigned long high_16 = pci_resource_start(dev, 4);\r\nu8 sc1d = inb(high_16 + 0x1d);\r\nif (hwif->channel) {\r\nreturn (sc1d & 0x40) ? 1 : 0;\r\n} else {\r\nreturn (sc1d & 0x04) ? 1 : 0;\r\n}\r\n}\r\nstatic u8 pdc2026x_cable_detect(ide_hwif_t *hwif)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nu16 CIS, mask = hwif->channel ? (1 << 11) : (1 << 10);\r\npci_read_config_word(dev, 0x50, &CIS);\r\nreturn (CIS & mask) ? ATA_CBL_PATA40 : ATA_CBL_PATA80;\r\n}\r\nstatic void pdc_old_enable_66MHz_clock(ide_hwif_t *hwif)\r\n{\r\nunsigned long clock_reg = hwif->extra_base + 0x01;\r\nu8 clock = inb(clock_reg);\r\noutb(clock | (hwif->channel ? 0x08 : 0x02), clock_reg);\r\n}\r\nstatic void pdc_old_disable_66MHz_clock(ide_hwif_t *hwif)\r\n{\r\nunsigned long clock_reg = hwif->extra_base + 0x01;\r\nu8 clock = inb(clock_reg);\r\noutb(clock & ~(hwif->channel ? 0x08 : 0x02), clock_reg);\r\n}\r\nstatic void pdc2026x_init_hwif(ide_hwif_t *hwif)\r\n{\r\npdc_old_disable_66MHz_clock(hwif);\r\n}\r\nstatic void pdc202xx_dma_start(ide_drive_t *drive)\r\n{\r\nif (drive->current_speed > XFER_UDMA_2)\r\npdc_old_enable_66MHz_clock(drive->hwif);\r\nif (drive->media != ide_disk || (drive->dev_flags & IDE_DFLAG_LBA48)) {\r\nide_hwif_t *hwif = drive->hwif;\r\nstruct request *rq = hwif->rq;\r\nunsigned long high_16 = hwif->extra_base - 16;\r\nunsigned long atapi_reg = high_16 + (hwif->channel ? 0x24 : 0x20);\r\nu32 word_count = 0;\r\nu8 clock = inb(high_16 + 0x11);\r\noutb(clock | (hwif->channel ? 0x08 : 0x02), high_16 + 0x11);\r\nword_count = (blk_rq_sectors(rq) << 8);\r\nword_count = (rq_data_dir(rq) == READ) ?\r\nword_count | 0x05000000 :\r\nword_count | 0x06000000;\r\noutl(word_count, atapi_reg);\r\n}\r\nide_dma_start(drive);\r\n}\r\nstatic int pdc202xx_dma_end(ide_drive_t *drive)\r\n{\r\nif (drive->media != ide_disk || (drive->dev_flags & IDE_DFLAG_LBA48)) {\r\nide_hwif_t *hwif = drive->hwif;\r\nunsigned long high_16 = hwif->extra_base - 16;\r\nunsigned long atapi_reg = high_16 + (hwif->channel ? 0x24 : 0x20);\r\nu8 clock = 0;\r\noutl(0, atapi_reg);\r\nclock = inb(high_16 + 0x11);\r\noutb(clock & ~(hwif->channel ? 0x08:0x02), high_16 + 0x11);\r\n}\r\nif (drive->current_speed > XFER_UDMA_2)\r\npdc_old_disable_66MHz_clock(drive->hwif);\r\nreturn ide_dma_end(drive);\r\n}\r\nstatic int init_chipset_pdc202xx(struct pci_dev *dev)\r\n{\r\nunsigned long dmabase = pci_resource_start(dev, 4);\r\nu8 udma_speed_flag = 0, primary_mode = 0, secondary_mode = 0;\r\nif (dmabase == 0)\r\ngoto out;\r\nudma_speed_flag = inb(dmabase | 0x1f);\r\nprimary_mode = inb(dmabase | 0x1a);\r\nsecondary_mode = inb(dmabase | 0x1b);\r\nprintk(KERN_INFO "%s: (U)DMA Burst Bit %sABLED " \\r\n"Primary %s Mode " \\r\n"Secondary %s Mode.\n", pci_name(dev),\r\n(udma_speed_flag & 1) ? "EN" : "DIS",\r\n(primary_mode & 1) ? "MASTER" : "PCI",\r\n(secondary_mode & 1) ? "MASTER" : "PCI" );\r\nif (!(udma_speed_flag & 1)) {\r\nprintk(KERN_INFO "%s: FORCING BURST BIT 0x%02x->0x%02x ",\r\npci_name(dev), udma_speed_flag,\r\n(udma_speed_flag|1));\r\noutb(udma_speed_flag | 1, dmabase | 0x1f);\r\nprintk("%sACTIVE\n", (inb(dmabase | 0x1f) & 1) ? "" : "IN");\r\n}\r\nout:\r\nreturn 0;\r\n}\r\nstatic void __devinit pdc202ata4_fixup_irq(struct pci_dev *dev,\r\nconst char *name)\r\n{\r\nif ((dev->class >> 8) != PCI_CLASS_STORAGE_IDE) {\r\nu8 irq = 0, irq2 = 0;\r\npci_read_config_byte(dev, PCI_INTERRUPT_LINE, &irq);\r\npci_read_config_byte(dev, (PCI_INTERRUPT_LINE)|0x80, &irq2);\r\nif (irq != irq2) {\r\npci_write_config_byte(dev,\r\n(PCI_INTERRUPT_LINE)|0x80, irq);\r\nprintk(KERN_INFO "%s %s: PCI config space interrupt "\r\n"mirror fixed\n", name, pci_name(dev));\r\n}\r\n}\r\n}\r\nstatic int __devinit pdc202xx_init_one(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nconst struct ide_port_info *d;\r\nu8 idx = id->driver_data;\r\nd = &pdc202xx_chipsets[idx];\r\nif (idx < 2)\r\npdc202ata4_fixup_irq(dev, d->name);\r\nif (dev->vendor == PCI_DEVICE_ID_PROMISE_20265) {\r\nstruct pci_dev *bridge = dev->bus->self;\r\nif (bridge &&\r\nbridge->vendor == PCI_VENDOR_ID_INTEL &&\r\n(bridge->device == PCI_DEVICE_ID_INTEL_I960 ||\r\nbridge->device == PCI_DEVICE_ID_INTEL_I960RM)) {\r\nprintk(KERN_INFO DRV_NAME " %s: skipping Promise "\r\n"PDC20265 attached to I2O RAID controller\n",\r\npci_name(dev));\r\nreturn -ENODEV;\r\n}\r\n}\r\nreturn ide_pci_init_one(dev, d, NULL);\r\n}\r\nstatic int __init pdc202xx_ide_init(void)\r\n{\r\nreturn ide_pci_register_driver(&pdc202xx_pci_driver);\r\n}\r\nstatic void __exit pdc202xx_ide_exit(void)\r\n{\r\npci_unregister_driver(&pdc202xx_pci_driver);\r\n}

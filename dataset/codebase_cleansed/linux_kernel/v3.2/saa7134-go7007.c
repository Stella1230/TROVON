static int gpio_write(struct saa7134_dev *dev, u8 addr, u16 data)\r\n{\r\nsaa_writeb(SAA7134_GPIO_GPMODE0, 0xff);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS0, addr);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_ADDR);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_IDLE);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS0, data & 0xff);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_WRITE);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_IDLE);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS0, data >> 8);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_WRITE);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_IDLE);\r\nreturn 0;\r\n}\r\nstatic int gpio_read(struct saa7134_dev *dev, u8 addr, u16 *data)\r\n{\r\nsaa_writeb(SAA7134_GPIO_GPMODE0, 0xff);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS0, addr);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_ADDR);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_IDLE);\r\nsaa_writeb(SAA7134_GPIO_GPMODE0, 0x00);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_READ);\r\nsaa_clearb(SAA7134_GPIO_GPMODE3, SAA7134_GPIO_GPRESCAN);\r\nsaa_setb(SAA7134_GPIO_GPMODE3, SAA7134_GPIO_GPRESCAN);\r\n*data = saa_readb(SAA7134_GPIO_GPSTATUS0);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_IDLE);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_READ);\r\nsaa_clearb(SAA7134_GPIO_GPMODE3, SAA7134_GPIO_GPRESCAN);\r\nsaa_setb(SAA7134_GPIO_GPMODE3, SAA7134_GPIO_GPRESCAN);\r\n*data |= saa_readb(SAA7134_GPIO_GPSTATUS0) << 8;\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_IDLE);\r\nreturn 0;\r\n}\r\nstatic int saa7134_go7007_interface_reset(struct go7007 *go)\r\n{\r\nstruct saa7134_go7007 *saa = go->hpi_context;\r\nstruct saa7134_dev *dev = saa->dev;\r\nu32 status;\r\nu16 intr_val, intr_data;\r\nint count = 20;\r\nsaa_clearb(SAA7134_TS_PARALLEL, 0x80);\r\nsaa_writeb(SAA7134_GPIO_GPMODE2, 0xa4);\r\nsaa_writeb(SAA7134_GPIO_GPMODE0, 0xff);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_REQ1);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_RESET);\r\nmsleep(1);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_REQ1);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_REQ2);\r\nmsleep(10);\r\nsaa_clearb(SAA7134_GPIO_GPMODE3, SAA7134_GPIO_GPRESCAN);\r\nsaa_setb(SAA7134_GPIO_GPMODE3, SAA7134_GPIO_GPRESCAN);\r\nstatus = saa_readb(SAA7134_GPIO_GPSTATUS2);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_REQ1);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_REQ2);\r\ndo {\r\nsaa_clearb(SAA7134_GPIO_GPMODE3, SAA7134_GPIO_GPRESCAN);\r\nsaa_setb(SAA7134_GPIO_GPMODE3, SAA7134_GPIO_GPRESCAN);\r\nstatus = saa_readb(SAA7134_GPIO_GPSTATUS2);\r\n} while (--count > 0);\r\nif (go7007_read_interrupt(go, &intr_val, &intr_data) < 0 ||\r\n(intr_val & ~0x1) != 0x55aa) {\r\nprintk(KERN_ERR\r\n"saa7134-go7007: unable to reset the GO7007\n");\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int saa7134_go7007_write_interrupt(struct go7007 *go, int addr, int data)\r\n{\r\nstruct saa7134_go7007 *saa = go->hpi_context;\r\nstruct saa7134_dev *dev = saa->dev;\r\nint i;\r\nu16 status_reg;\r\n#ifdef GO7007_HPI_DEBUG\r\nprintk(KERN_DEBUG\r\n"saa7134-go7007: WriteInterrupt: %04x %04x\n", addr, data);\r\n#endif\r\nfor (i = 0; i < 100; ++i) {\r\ngpio_read(dev, HPI_ADDR_INTR_STATUS, &status_reg);\r\nif (!(status_reg & 0x0010))\r\nbreak;\r\nmsleep(10);\r\n}\r\nif (i == 100) {\r\nprintk(KERN_ERR\r\n"saa7134-go7007: device is hung, status reg = 0x%04x\n",\r\nstatus_reg);\r\nreturn -1;\r\n}\r\ngpio_write(dev, HPI_ADDR_INTR_WR_PARAM, data);\r\ngpio_write(dev, HPI_ADDR_INTR_WR_INDEX, addr);\r\nreturn 0;\r\n}\r\nstatic int saa7134_go7007_read_interrupt(struct go7007 *go)\r\n{\r\nstruct saa7134_go7007 *saa = go->hpi_context;\r\nstruct saa7134_dev *dev = saa->dev;\r\ngo->interrupt_available = 1;\r\ngpio_read(dev, HPI_ADDR_INTR_RET_VALUE, &go->interrupt_value);\r\ngpio_read(dev, HPI_ADDR_INTR_RET_DATA, &go->interrupt_data);\r\n#ifdef GO7007_HPI_DEBUG\r\nprintk(KERN_DEBUG "saa7134-go7007: ReadInterrupt: %04x %04x\n",\r\ngo->interrupt_value, go->interrupt_data);\r\n#endif\r\nreturn 0;\r\n}\r\nstatic void saa7134_go7007_irq_ts_done(struct saa7134_dev *dev,\r\nunsigned long status)\r\n{\r\nstruct go7007 *go = video_get_drvdata(dev->empress_dev);\r\nstruct saa7134_go7007 *saa = go->hpi_context;\r\nif (!go->streaming)\r\nreturn;\r\nif (0 != (status & 0x000f0000))\r\nprintk(KERN_DEBUG "saa7134-go7007: irq: lost %ld\n",\r\n(status >> 16) & 0x0f);\r\nif (status & 0x100000) {\r\ndma_sync_single_for_cpu(&dev->pci->dev,\r\nsaa->bottom_dma, PAGE_SIZE, DMA_FROM_DEVICE);\r\ngo7007_parse_video_stream(go, saa->bottom, PAGE_SIZE);\r\nsaa_writel(SAA7134_RS_BA2(5), cpu_to_le32(saa->bottom_dma));\r\n} else {\r\ndma_sync_single_for_cpu(&dev->pci->dev,\r\nsaa->top_dma, PAGE_SIZE, DMA_FROM_DEVICE);\r\ngo7007_parse_video_stream(go, saa->top, PAGE_SIZE);\r\nsaa_writel(SAA7134_RS_BA1(5), cpu_to_le32(saa->top_dma));\r\n}\r\n}\r\nstatic int saa7134_go7007_stream_start(struct go7007 *go)\r\n{\r\nstruct saa7134_go7007 *saa = go->hpi_context;\r\nstruct saa7134_dev *dev = saa->dev;\r\nsaa->top_dma = dma_map_page(&dev->pci->dev, virt_to_page(saa->top),\r\n0, PAGE_SIZE, DMA_FROM_DEVICE);\r\nif (!saa->top_dma)\r\nreturn -ENOMEM;\r\nsaa->bottom_dma = dma_map_page(&dev->pci->dev,\r\nvirt_to_page(saa->bottom),\r\n0, PAGE_SIZE, DMA_FROM_DEVICE);\r\nif (!saa->bottom_dma) {\r\ndma_unmap_page(&dev->pci->dev, saa->top_dma, PAGE_SIZE,\r\nDMA_FROM_DEVICE);\r\nreturn -ENOMEM;\r\n}\r\nsaa_writel(SAA7134_VIDEO_PORT_CTRL0 >> 2, 0xA300B000);\r\nsaa_writel(SAA7134_VIDEO_PORT_CTRL4 >> 2, 0x40000200);\r\nsaa_writeb(SAA7134_GPIO_GPMODE0, 0xff);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS0, HPI_ADDR_VIDEO_BUFFER);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_ADDR);\r\nsaa_writeb(SAA7134_GPIO_GPMODE0, 0x00);\r\nsaa_writeb(SAA7134_TS_PARALLEL, 0xe6);\r\nsaa_setb(SAA7134_TS_SERIAL1, 0x01);\r\nsaa_clearb(SAA7134_TS_SERIAL1, 0x01);\r\nsaa_writeb(SAA7134_TS_PARALLEL_SERIAL, 128 - 1);\r\nsaa_writeb(SAA7134_TS_DMA0, (PAGE_SIZE >> 7) - 1);\r\nsaa_writeb(SAA7134_TS_DMA1, 0);\r\nsaa_writeb(SAA7134_TS_DMA2, 0);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_VIDEO);\r\nsaa_writel(SAA7134_RS_BA1(5), cpu_to_le32(saa->top_dma));\r\nsaa_writel(SAA7134_RS_BA2(5), cpu_to_le32(saa->bottom_dma));\r\nsaa_writel(SAA7134_RS_PITCH(5), 128);\r\nsaa_writel(SAA7134_RS_CONTROL(5), SAA7134_RS_CONTROL_BURST_MAX);\r\nsaa_setl(SAA7134_MAIN_CTRL, SAA7134_MAIN_CTRL_TE5);\r\nsaa_setl(SAA7134_IRQ1,\r\nSAA7134_IRQ1_INTE_RA2_1 | SAA7134_IRQ1_INTE_RA2_0);\r\nreturn 0;\r\n}\r\nstatic int saa7134_go7007_stream_stop(struct go7007 *go)\r\n{\r\nstruct saa7134_go7007 *saa = go->hpi_context;\r\nstruct saa7134_dev *dev;\r\nif (!saa)\r\nreturn -EINVAL;\r\ndev = saa->dev;\r\nif (!dev)\r\nreturn -EINVAL;\r\nsaa_clearl(SAA7134_MAIN_CTRL, SAA7134_MAIN_CTRL_TE5);\r\nsaa_clearl(SAA7134_IRQ1,\r\nSAA7134_IRQ1_INTE_RA2_1 | SAA7134_IRQ1_INTE_RA2_0);\r\nsaa_clearb(SAA7134_TS_PARALLEL, 0x80);\r\ndma_unmap_page(&dev->pci->dev, saa->top_dma, PAGE_SIZE,\r\nDMA_FROM_DEVICE);\r\ndma_unmap_page(&dev->pci->dev, saa->bottom_dma, PAGE_SIZE,\r\nDMA_FROM_DEVICE);\r\nreturn 0;\r\n}\r\nstatic int saa7134_go7007_send_firmware(struct go7007 *go, u8 *data, int len)\r\n{\r\nstruct saa7134_go7007 *saa = go->hpi_context;\r\nstruct saa7134_dev *dev = saa->dev;\r\nu16 status_reg;\r\nint i;\r\n#ifdef GO7007_HPI_DEBUG\r\nprintk(KERN_DEBUG "saa7134-go7007: DownloadBuffer "\r\n"sending %d bytes\n", len);\r\n#endif\r\nwhile (len > 0) {\r\ni = len > 64 ? 64 : len;\r\nsaa_writeb(SAA7134_GPIO_GPMODE0, 0xff);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS0, HPI_ADDR_INIT_BUFFER);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_ADDR);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_IDLE);\r\nwhile (i-- > 0) {\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS0, *data);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_WRITE);\r\nsaa_writeb(SAA7134_GPIO_GPSTATUS2, GPIO_COMMAND_IDLE);\r\n++data;\r\n--len;\r\n}\r\nfor (i = 0; i < 100; ++i) {\r\ngpio_read(dev, HPI_ADDR_INTR_STATUS, &status_reg);\r\nif (!(status_reg & 0x0002))\r\nbreak;\r\n}\r\nif (i == 100) {\r\nprintk(KERN_ERR "saa7134-go7007: device is hung, "\r\n"status reg = 0x%04x\n", status_reg);\r\nreturn -1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int saa7134_go7007_send_command(struct go7007 *go, unsigned int cmd,\r\nvoid *arg)\r\n{\r\nstruct saa7134_go7007 *saa = go->hpi_context;\r\nstruct saa7134_dev *dev = saa->dev;\r\nswitch (cmd) {\r\ncase VIDIOC_S_STD:\r\n{\r\nv4l2_std_id *std = arg;\r\nreturn saa7134_s_std_internal(dev, NULL, std);\r\n}\r\ncase VIDIOC_G_STD:\r\n{\r\nv4l2_std_id *std = arg;\r\n*std = dev->tvnorm->id;\r\nreturn 0;\r\n}\r\ncase VIDIOC_QUERYCTRL:\r\n{\r\nstruct v4l2_queryctrl *ctrl = arg;\r\nif (V4L2_CTRL_ID2CLASS(ctrl->id) == V4L2_CTRL_CLASS_USER)\r\nreturn saa7134_queryctrl(NULL, NULL, ctrl);\r\n}\r\ncase VIDIOC_G_CTRL:\r\n{\r\nstruct v4l2_control *ctrl = arg;\r\nif (V4L2_CTRL_ID2CLASS(ctrl->id) == V4L2_CTRL_CLASS_USER)\r\nreturn saa7134_g_ctrl_internal(dev, NULL, ctrl);\r\n}\r\ncase VIDIOC_S_CTRL:\r\n{\r\nstruct v4l2_control *ctrl = arg;\r\nif (V4L2_CTRL_ID2CLASS(ctrl->id) == V4L2_CTRL_CLASS_USER)\r\nreturn saa7134_s_ctrl_internal(dev, NULL, ctrl);\r\n}\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int saa7134_go7007_init(struct saa7134_dev *dev)\r\n{\r\nstruct go7007 *go;\r\nstruct saa7134_go7007 *saa;\r\nprintk(KERN_DEBUG "saa7134-go7007: probing new SAA713X board\n");\r\nsaa = kzalloc(sizeof(struct saa7134_go7007), GFP_KERNEL);\r\nif (saa == NULL)\r\nreturn -ENOMEM;\r\nsaa->top = (u8 *)get_zeroed_page(GFP_KERNEL);\r\nif (!saa->top)\r\ngoto allocfail;\r\nsaa->bottom = (u8 *)get_zeroed_page(GFP_KERNEL);\r\nif (!saa->bottom)\r\ngoto allocfail;\r\ngo = go7007_alloc(&board_voyager, &dev->pci->dev);\r\nif (go == NULL)\r\ngoto allocfail;\r\ngo->board_id = GO7007_BOARDID_PCI_VOYAGER;\r\nstrncpy(go->name, saa7134_boards[dev->board].name, sizeof(go->name));\r\ngo->hpi_ops = &saa7134_go7007_hpi_ops;\r\ngo->hpi_context = saa;\r\nsaa->dev = dev;\r\nif (go7007_boot_encoder(go, go->board_info->flags &\r\nGO7007_BOARD_USE_ONBOARD_I2C) < 0)\r\ngoto initfail;\r\nif (go7007_register_encoder(go) < 0)\r\ngoto initfail;\r\ndev->empress_dev = go->video_dev;\r\nvideo_set_drvdata(dev->empress_dev, go);\r\ngo->status = STATUS_ONLINE;\r\nreturn 0;\r\ninitfail:\r\ngo->status = STATUS_SHUTDOWN;\r\nreturn 0;\r\nallocfail:\r\nif (saa->top)\r\nfree_page((unsigned long)saa->top);\r\nif (saa->bottom)\r\nfree_page((unsigned long)saa->bottom);\r\nkfree(saa);\r\nreturn -ENOMEM;\r\n}\r\nstatic int saa7134_go7007_fini(struct saa7134_dev *dev)\r\n{\r\nstruct go7007 *go;\r\nstruct saa7134_go7007 *saa;\r\nif (NULL == dev->empress_dev)\r\nreturn 0;\r\ngo = video_get_drvdata(dev->empress_dev);\r\nsaa = go->hpi_context;\r\ngo->status = STATUS_SHUTDOWN;\r\nfree_page((unsigned long)saa->top);\r\nfree_page((unsigned long)saa->bottom);\r\nkfree(saa);\r\ngo7007_remove(go);\r\ndev->empress_dev = NULL;\r\nreturn 0;\r\n}\r\nstatic int __init saa7134_go7007_mod_init(void)\r\n{\r\nreturn saa7134_ts_register(&saa7134_go7007_ops);\r\n}\r\nstatic void __exit saa7134_go7007_mod_cleanup(void)\r\n{\r\nsaa7134_ts_unregister(&saa7134_go7007_ops);\r\n}

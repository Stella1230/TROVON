void local_flush_tlb_all(void)\r\n{\r\nunsigned long flags;\r\nunsigned long old_ctx;\r\nint entry;\r\nlocal_irq_save(flags);\r\nold_ctx = read_c0_entryhi();\r\nwrite_c0_entrylo(0);\r\nfor (entry = 0; entry < TFP_TLB_SIZE; entry++) {\r\nwrite_c0_tlbset(entry >> TFP_TLB_SET_SHIFT);\r\nwrite_c0_vaddr(entry << PAGE_SHIFT);\r\nwrite_c0_entryhi(CKSEG0 + (entry << (PAGE_SHIFT + 1)));\r\nmtc0_tlbw_hazard();\r\ntlb_write();\r\n}\r\ntlbw_use_hazard();\r\nwrite_c0_entryhi(old_ctx);\r\nlocal_irq_restore(flags);\r\n}\r\nvoid local_flush_tlb_mm(struct mm_struct *mm)\r\n{\r\nint cpu = smp_processor_id();\r\nif (cpu_context(cpu, mm) != 0)\r\ndrop_mmu_context(mm, cpu);\r\n}\r\nvoid local_flush_tlb_range(struct vm_area_struct *vma, unsigned long start,\r\nunsigned long end)\r\n{\r\nstruct mm_struct *mm = vma->vm_mm;\r\nint cpu = smp_processor_id();\r\nunsigned long flags;\r\nint oldpid, newpid, size;\r\nif (!cpu_context(cpu, mm))\r\nreturn;\r\nsize = (end - start + (PAGE_SIZE - 1)) >> PAGE_SHIFT;\r\nsize = (size + 1) >> 1;\r\nlocal_irq_save(flags);\r\nif (size > TFP_TLB_SIZE / 2) {\r\ndrop_mmu_context(mm, cpu);\r\ngoto out_restore;\r\n}\r\noldpid = read_c0_entryhi();\r\nnewpid = cpu_asid(cpu, mm);\r\nwrite_c0_entrylo(0);\r\nstart &= PAGE_MASK;\r\nend += (PAGE_SIZE - 1);\r\nend &= PAGE_MASK;\r\nwhile (start < end) {\r\nsigned long idx;\r\nwrite_c0_vaddr(start);\r\nwrite_c0_entryhi(start);\r\nstart += PAGE_SIZE;\r\ntlb_probe();\r\nidx = read_c0_tlbset();\r\nif (idx < 0)\r\ncontinue;\r\nwrite_c0_entryhi(CKSEG0 + (idx << (PAGE_SHIFT + 1)));\r\ntlb_write();\r\n}\r\nwrite_c0_entryhi(oldpid);\r\nout_restore:\r\nlocal_irq_restore(flags);\r\n}\r\nvoid local_flush_tlb_kernel_range(unsigned long start, unsigned long end)\r\n{\r\nunsigned long size, flags;\r\nsize = (end - start + (PAGE_SIZE - 1)) >> PAGE_SHIFT;\r\nsize = (size + 1) >> 1;\r\nif (size > TFP_TLB_SIZE / 2) {\r\nlocal_flush_tlb_all();\r\nreturn;\r\n}\r\nlocal_irq_save(flags);\r\nwrite_c0_entrylo(0);\r\nstart &= PAGE_MASK;\r\nend += (PAGE_SIZE - 1);\r\nend &= PAGE_MASK;\r\nwhile (start < end) {\r\nsigned long idx;\r\nwrite_c0_vaddr(start);\r\nwrite_c0_entryhi(start);\r\nstart += PAGE_SIZE;\r\ntlb_probe();\r\nidx = read_c0_tlbset();\r\nif (idx < 0)\r\ncontinue;\r\nwrite_c0_entryhi(CKSEG0 + (idx << (PAGE_SHIFT + 1)));\r\ntlb_write();\r\n}\r\nlocal_irq_restore(flags);\r\n}\r\nvoid local_flush_tlb_page(struct vm_area_struct *vma, unsigned long page)\r\n{\r\nint cpu = smp_processor_id();\r\nunsigned long flags;\r\nint oldpid, newpid;\r\nsigned long idx;\r\nif (!cpu_context(cpu, vma->vm_mm))\r\nreturn;\r\nnewpid = cpu_asid(cpu, vma->vm_mm);\r\npage &= PAGE_MASK;\r\nlocal_irq_save(flags);\r\noldpid = read_c0_entryhi();\r\nwrite_c0_vaddr(page);\r\nwrite_c0_entryhi(newpid);\r\ntlb_probe();\r\nidx = read_c0_tlbset();\r\nif (idx < 0)\r\ngoto finish;\r\nwrite_c0_entrylo(0);\r\nwrite_c0_entryhi(CKSEG0 + (idx << (PAGE_SHIFT + 1)));\r\ntlb_write();\r\nfinish:\r\nwrite_c0_entryhi(oldpid);\r\nlocal_irq_restore(flags);\r\n}\r\nvoid __update_tlb(struct vm_area_struct * vma, unsigned long address, pte_t pte)\r\n{\r\nunsigned long flags;\r\npgd_t *pgdp;\r\npmd_t *pmdp;\r\npte_t *ptep;\r\nint pid;\r\nif (current->active_mm != vma->vm_mm)\r\nreturn;\r\npid = read_c0_entryhi() & ASID_MASK;\r\nlocal_irq_save(flags);\r\naddress &= PAGE_MASK;\r\nwrite_c0_vaddr(address);\r\nwrite_c0_entryhi(pid);\r\npgdp = pgd_offset(vma->vm_mm, address);\r\npmdp = pmd_offset(pgdp, address);\r\nptep = pte_offset_map(pmdp, address);\r\ntlb_probe();\r\nwrite_c0_entrylo(pte_val(*ptep++) >> 6);\r\ntlb_write();\r\nwrite_c0_entryhi(pid);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void __cpuinit probe_tlb(unsigned long config)\r\n{\r\nstruct cpuinfo_mips *c = &current_cpu_data;\r\nc->tlbsize = 3 * 128;\r\n}\r\nvoid __cpuinit tlb_init(void)\r\n{\r\nunsigned int config = read_c0_config();\r\nunsigned long status;\r\nprobe_tlb(config);\r\nstatus = read_c0_status();\r\nstatus &= ~(ST0_UPS | ST0_KPS);\r\n#ifdef CONFIG_PAGE_SIZE_4KB\r\nstatus |= (TFP_PAGESIZE_4K << 32) | (TFP_PAGESIZE_4K << 36);\r\n#elif defined(CONFIG_PAGE_SIZE_8KB)\r\nstatus |= (TFP_PAGESIZE_8K << 32) | (TFP_PAGESIZE_8K << 36);\r\n#elif defined(CONFIG_PAGE_SIZE_16KB)\r\nstatus |= (TFP_PAGESIZE_16K << 32) | (TFP_PAGESIZE_16K << 36);\r\n#elif defined(CONFIG_PAGE_SIZE_64KB)\r\nstatus |= (TFP_PAGESIZE_64K << 32) | (TFP_PAGESIZE_64K << 36);\r\n#endif\r\nwrite_c0_status(status);\r\nwrite_c0_wired(0);\r\nlocal_flush_tlb_all();\r\nbuild_tlb_refill_handler();\r\n}
